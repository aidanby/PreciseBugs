{"buggy_code": ["<?php\nApp::uses('AppController', 'Controller');\nApp::uses('Xml', 'Utility');\n\nclass ServersController extends AppController {\n\n\tpublic $components = array('Security' ,'RequestHandler');\t// XXX ACL component\n\n\tpublic $paginate = array(\n\t\t\t'limit' => 60,\n\t\t\t'recursive' => -1,\n\t\t\t'contain' => array(\n\t\t\t\t\t'User' => array(\n\t\t\t\t\t\t\t'fields' => array('User.id', 'User.org_id', 'User.email'),\n\t\t\t\t\t),\n\t\t\t\t\t'Organisation' => array(\n\t\t\t\t\t\t\t'fields' => array('Organisation.name', 'Organisation.id'),\n\t\t\t\t\t),\n\t\t\t\t\t'RemoteOrg' => array(\n\t\t\t\t\t\t\t'fields' => array('RemoteOrg.name', 'RemoteOrg.id'),\n\t\t\t\t\t),\n\t\t\t),\n\t\t\t'maxLimit' => 9999, // LATER we will bump here on a problem once we have more than 9999 events\n\t\t\t'order' => array(\n\t\t\t\t\t'Server.url' => 'ASC'\n\t\t\t),\n\t);\n\n\tpublic $uses = array('Server', 'Event');\n\n\tpublic function beforeFilter() {\n\t\tparent::beforeFilter();\n\n\t\t// permit reuse of CSRF tokens on some pages.\n\t\tswitch ($this->request->params['action']) {\n\t\t\tcase 'push':\n\t\t\tcase 'pull':\n\t\t\tcase 'getVersion':\n\t\t\tcase 'testConnection':\n\t\t\t\t$this->Security->csrfUseOnce = false;\n\t\t}\n\t}\n\n\tpublic function index() {\n\t\tif (!$this->_isSiteAdmin()) {\n\t\t\tif (!$this->userRole['perm_sync'] && !$this->userRole['perm_admin']) $this->redirect(array('controller' => 'events', 'action' => 'index'));\n\t\t\t$this->paginate['conditions'] = array('Server.org_id LIKE' => $this->Auth->user('org_id'));\n\t\t}\n\t\t$this->set('servers', $this->paginate());\n\t\t$collection = array();\n\t\t$collection['orgs'] = $this->Server->Organisation->find('list', array(\n\t\t\t\t'fields' => array('id', 'name'),\n\t\t));\n\t\t$this->loadModel('Tag');\n\t\t$collection['tags'] = $this->Tag->find('list', array(\n\t\t\t\t'fields' => array('id', 'name'),\n\t\t));\n\t\t$this->set('collection', $collection);\n\n\t}\n\n\tpublic function previewIndex($id) {\n\t\t$urlparams = '';\n\t\t$passedArgs = array();\n\t\tif (!$this->_isSiteAdmin()) {\n\t\t\tthrow new MethodNotAllowedException('You are not authorised to do that.');\n\t\t}\n\t\t$server = $this->Server->find('first', array('conditions' => array('Server.id' => $id), 'recursive' => -1, 'fields' => array('Server.id', 'Server.url', 'Server.name')));\n\t\tif (empty($server)) throw new NotFoundException('Invalid server ID.');\n\t\t$validFilters = $this->Server->validEventIndexFilters;\n\t\tforeach ($validFilters as $k => $filter) {\n\t\t\tif (isset($this->passedArgs[$filter])) {\n\t\t\t\t$passedArgs[$filter] = $this->passedArgs[$filter];\n\t\t\t\tif ($k != 0) $urlparams .= '/';\n\t\t\t\t$urlparams .= $filter . ':' . $this->passedArgs[$filter];\n\t\t\t}\n\t\t}\n\t\t$combinedArgs = array_merge($this->passedArgs, $passedArgs);\n\t\tif (!isset($combinedArgs['sort'])) {\n\t\t\t$combinedArgs['sort'] = 'timestamp';\n\t\t\t$combinedArgs['direction'] = 'desc';\n\t\t}\n\t\t$events = $this->Server->previewIndex($id, $this->Auth->user(), $combinedArgs);\n\t\t$this->loadModel('Event');\n\t\t$threat_levels = $this->Event->ThreatLevel->find('all');\n\t\t$this->set('threatLevels', Set::combine($threat_levels, '{n}.ThreatLevel.id', '{n}.ThreatLevel.name'));\n\t\tApp::uses('CustomPaginationTool', 'Tools');\n\t\t$customPagination = new CustomPaginationTool();\n\t\t$params = $customPagination->createPaginationRules($events, $this->passedArgs, $this->alias);\n\t\t$this->params->params['paging'] = array($this->modelClass => $params);\n\t\tif (is_array($events)) $customPagination->truncateByPagination($events, $params);\n\t\telse ($events = array());\n\t\t$this->set('events', $events);\n\t\t$this->set('eventDescriptions', $this->Event->fieldDescriptions);\n\t\t$this->set('analysisLevels', $this->Event->analysisLevels);\n\t\t$this->set('distributionLevels', $this->Event->distributionLevels);\n\n\t\t$shortDist = array(0 => 'Organisation', 1 => 'Community', 2 => 'Connected', 3 => 'All', 4 => ' sharing Group');\n\t\t$this->set('shortDist', $shortDist);\n\t\t$this->set('ajax', $this->request->is('ajax'));\n\t\t$this->set('id', $id);\n\t\t$this->set('urlparams', $urlparams);\n\t\t$this->set('passedArgs', json_encode($passedArgs));\n\t\t$this->set('passedArgsArray', $passedArgs);\n\t\t$this->set('server', $server);\n\t}\n\n\tpublic function previewEvent($serverId, $eventId, $all = false) {\n\t\tif (!$this->_isSiteAdmin()) {\n\t\t\tthrow new MethodNotAllowedException('You are not authorised to do that.');\n\t\t}\n\t\t$server = $this->Server->find('first', array('conditions' => array('Server.id' => $serverId), 'recursive' => -1, 'fields' => array('Server.id', 'Server.url', 'Server.name')));\n\t\tif (empty($server)) throw new NotFoundException('Invalid server ID.');\n\t\t$event = $this->Server->previewEvent($serverId, $eventId);\n\t\t// work on this in the future to improve the feedback\n\t\t// 2 = wrong error code\n\t\tif (is_numeric($event))throw new NotFoundException('Invalid event.');\n\t\t$this->loadModel('Event');\n\t\t$params = $this->Event->rearrangeEventForView($event, $this->passedArgs, $all);\n\t\t$this->params->params['paging'] = array('Server' => $params);\n\t\t$this->set('event', $event);\n\t\t$this->set('server', $server);\n\t\t$this->loadModel('Event');\n\t\t$dataForView = array(\n\t\t\t\t'Attribute' => array('attrDescriptions' => 'fieldDescriptions', 'distributionDescriptions' => 'distributionDescriptions', 'distributionLevels' => 'distributionLevels'),\n\t\t\t\t'Event' => array('eventDescriptions' => 'fieldDescriptions', 'analysisLevels' => 'analysisLevels'),\n\t\t\t\t'Object' => array()\n\t\t);\n\t\tforeach ($dataForView as $m => $variables) {\n\t\t\tif ($m === 'Event') $currentModel = $this->Event;\n\t\t\telse if ($m === 'Attribute') $currentModel = $this->Event->Attribute;\n\t\t\telse if ($m === 'Object') $currentModel = $this->Event->Object;\n\t\t\tforeach ($variables as $alias => $variable) {\n\t\t\t\t$this->set($alias, $currentModel->{$variable});\n\t\t\t}\n\t\t}\n\t\t$threat_levels = $this->Event->ThreatLevel->find('all');\n\t\t$this->set('threatLevels', Set::combine($threat_levels, '{n}.ThreatLevel.id', '{n}.ThreatLevel.name'));\n\t}\n\n\tpublic function filterEventIndex($id) {\n\t\tif (!$this->_isSiteAdmin()) {\n\t\t\tthrow new MethodNotAllowedException('You are not authorised to do that.');\n\t\t}\n\t\t$validFilters = $this->Server->validEventIndexFilters;\n\t\t$validatedFilterString = '';\n\t\tforeach ($this->passedArgs as $k => $v) {\n\t\t\tif (in_array('' . $k, $validFilters)) {\n\t\t\t\tif ($validatedFilterString != '') $validatedFilterString .= '/';\n\t\t\t\t$validatedFilterString .= $k . ':' . $v;\n\t\t\t}\n\t\t}\n\t\t$this->set('id', $id);\n\t\t$this->set('validFilters', $validFilters);\n\t\t$this->set('filter', $validatedFilterString);\n\t}\n\n\tpublic function add() {\n\t\tif (!$this->_isSiteAdmin()) $this->redirect(array('controller' => 'servers', 'action' => 'index'));\n\t\tif ($this->request->is('post')) {\n\t\t\tif($this->_isRest()) {\n\t\t\t\tif (!isset($this->request->data['Server'])) {\n\t\t\t\t\t$this->request->data = array('Server' => $this->request->data);\n\t\t\t\t}\n\t\t\t}\n\t\t\t$json = json_decode($this->request->data['Server']['json'], true);\n\n\t\t\t$fail = false;\n\t\t\tif (empty(Configure::read('MISP.host_org_id'))) $this->request->data['Server']['internal'] = 0;\n\t\t\t// test the filter fields\n\t\t\tif (!empty($this->request->data['Server']['pull_rules']) && !$this->Server->isJson($this->request->data['Server']['pull_rules'])) {\n\t\t\t\t$fail = true;\n\t\t\t\t$error_msg = __('The pull filter rules must be in valid JSON format.');\n\t\t\t\tif($this->_isRest()) {\n\t\t\t\t\treturn $this->RestResponse->saveFailResponse('Servers', 'add', false, array('pull_rules' => $error_msg), $this->response->type());\n\t\t\t\t} else {\n\t\t\t\t\t$this->Session->setFlash($error_msg);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (!$fail && !empty($this->request->data['Server']['push_rules']) && !$this->Server->isJson($this->request->data['Server']['push_rules'])) {\n\t\t\t\t$fail = true;\n\t\t\t\t$error_msg = __('The push filter rules must be in valid JSON format.');\n\t\t\t\tif($this->_isRest()) {\n\t\t\t\t\treturn $this->RestResponse->saveFailResponse('Servers', 'add', false, array('push_rules' => $error_msg), $this->response->type());\n\t\t\t\t} else {\n\t\t\t\t\t$this->Session->setFlash($error_msg);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (!$fail) {\n\t\t\t\t// force check userid and orgname to be from yourself\n\t\t\t\t$this->request->data['Server']['org_id'] = $this->Auth->user('org_id');\n\t\t\t\tif ($this->request->data['Server']['organisation_type'] < 2) $this->request->data['Server']['remote_org_id'] = $json['id'];\n\t\t\t\telse {\n\t\t\t\t\t$existingOrgs = $this->Server->Organisation->find('first', array(\n\t\t\t\t\t\t\t'conditions' => array('uuid' => $json['uuid']),\n\t\t\t\t\t\t\t'recursive' => -1,\n\t\t\t\t\t\t\t'fields' => array('id', 'uuid')\n\t\t\t\t\t));\n\t\t\t\t\tif (!empty($existingOrgs)) {\n\t\t\t\t\t\t$fail = true;\n\t\t\t\t\t\tif($this->_isRest()) {\n\t\t\t\t\t\t\treturn $this->RestResponse->saveFailResponse('Servers', 'add', false, array('Organisation' => 'Remote Organisation\\'s uuid already used'), $this->response->type());\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t$this->Session->setFlash(__('That organisation could not be created as the uuid is in use already.'));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!$fail) {\n\t\t\t\t\t\t$this->Server->Organisation->create();\n\t\t\t\t\t\t$orgSave = $this->Server->Organisation->save(array(\n\t\t\t\t\t\t\t\t'name' => $json['name'],\n\t\t\t\t\t\t\t\t'uuid' => $json['uuid'],\n\t\t\t\t\t\t\t\t'local' => 0,\n\t\t\t\t\t\t\t\t'created_by' => $this->Auth->user('id')\n\t\t\t\t\t\t));\n\n\t\t\t\t\t\tif (!$orgSave) {\n\t\t\t\t\t\t\tif($this->_isRest()) {\n\t\t\t\t\t\t\t\treturn $this->RestResponse->saveFailResponse('Servers', 'add', false, $this->Server->Organisation->validationError, $this->response->type());\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t$this->Session->setFlash(__('Couldn\\'t save the new organisation, are you sure that the uuid is in the correct format?.'));\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t$fail = true;\n\t\t\t\t\t\t\t$this->request->data['Server']['external_name'] = $json['name'];\n\t\t\t\t\t\t\t$this->request->data['Server']['external_uuid'] = $json['uuid'];\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t$this->request->data['Server']['remote_org_id'] = $this->Server->Organisation->id;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (Configure::read('MISP.host_org_id') == 0 || $this->request->data['Server']['remote_org_id'] != Configure::read('MISP.host_org_id')) {\n\t\t\t\t\t$this->request->data['Server']['internal'] = 0;\n\t\t\t\t}\n\t\t\t\tif (!$fail) {\n\t\t\t\t\t$this->request->data['Server']['org_id'] = $this->Auth->user('org_id');\n\t\t\t\t\tif ($this->Server->save($this->request->data)) {\n\t\t\t\t\t\tif (isset($this->request->data['Server']['submitted_cert']) && $this->request->data['Server']['submitted_cert']['size'] != 0) {\n\t\t\t\t\t\t\t$this->__saveCert($this->request->data, $this->Server->id, false);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (isset($this->request->data['Server']['submitted_client_cert']) && $this->request->data['Server']['submitted_client_cert']['size'] != 0) {\n\t\t\t\t\t\t\t$this->__saveCert($this->request->data, $this->Server->id, true);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif($this->_isRest()) {\n\t\t\t\t\t\t\t$server = $this->Server->find('first', array(\n\t\t\t\t\t\t\t\t\t'conditions' => array('Server.id' => $this->Server->id),\n\t\t\t\t\t\t\t\t\t'recursive' => -1\n\t\t\t\t\t\t\t));\n\t\t\t\t\t\t\treturn $this->RestResponse->viewData($server, $this->response->type());\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t$this->Session->setFlash(__('The server has been saved'));\n\t\t\t\t\t\t\t$this->redirect(array('action' => 'index'));\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif($this->_isRest()) {\n\t\t\t\t\t\t\treturn $this->RestResponse->saveFailResponse('Servers', 'add', false, $this->Server->validationError, $this->response->type());\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t$this->Session->setFlash(__('The server could not be saved. Please, try again.'));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif($this->_isRest()) {\n\t\t\treturn $this->RestResponse->describe('Servers', 'add', false, $this->response->type());\n\t\t} else {\n\t\t\t$organisationOptions = array(0 => 'Local organisation', 1 => 'External organisation', 2 => 'New external organisation');\n\t\t\t$temp = $this->Server->Organisation->find('all', array(\n\t\t\t\t\t'conditions' => array('local' => true),\n\t\t\t\t\t'fields' => array('id', 'name'),\n\t\t\t\t\t'order' => array('lower(Organisation.name) ASC')\n\t\t\t));\n\t\t\t$localOrganisations = array();\n\t\t\t$allOrgs = array();\n\t\t\tforeach ($temp as $o) {\n\t\t\t\t$localOrganisations[$o['Organisation']['id']] = $o['Organisation']['name'];\n\t\t\t\t$allOrgs[] = array('id' => $o['Organisation']['id'], 'name' => $o['Organisation']['name']);\n\t\t\t}\n\t\t\t$temp = $this->Server->Organisation->find('all', array(\n\t\t\t\t\t'conditions' => array('local' => false),\n\t\t\t\t\t'fields' => array('id', 'name'),\n\t\t\t\t\t'order' => array('lower(Organisation.name) ASC')\n\t\t\t));\n\t\t\t$externalOrganisations = array();\n\t\t\tforeach ($temp as $o) {\n\t\t\t\t$externalOrganisations[$o['Organisation']['id']] = $o['Organisation']['name'];\n\t\t\t\t$allOrgs[] = array('id' => $o['Organisation']['id'], 'name' => $o['Organisation']['name']);\n\t\t\t}\n\t\t\t$this->set('host_org_id', Configure::read('MISP.host_org_id'));\n\t\t\t$this->set('organisationOptions', $organisationOptions);\n\t\t\t$this->set('localOrganisations', $localOrganisations);\n\t\t\t$this->set('externalOrganisations', $externalOrganisations);\n\t\t\t$this->set('allOrganisations', $allOrgs);\n\n\t\t\t// list all tags for the rule picker\n\t\t\t$this->loadModel('Tag');\n\t\t\t$temp = $this->Tag->find('all', array('recursive' => -1));\n\t\t\t$allTags = array();\n\t\t\tforeach ($temp as $t) $allTags[] = array('id' => $t['Tag']['id'], 'name' => $t['Tag']['name']);\n\t\t\t$this->set('allTags', $allTags);\n\t\t\t$this->set('host_org_id', Configure::read('MISP.host_org_id'));\n\t\t}\n\t}\n\n\tpublic function edit($id = null) {\n\t\t$this->Server->id = $id;\n\t\tif (!$this->Server->exists()) {\n\t\t\tthrow new NotFoundException(__('Invalid server'));\n\t\t}\n\t\t$s = $this->Server->read(null, $id);\n\t\tif (!$this->_isSiteAdmin()) $this->redirect(array('controller' => 'servers', 'action' => 'index'));\n\t\tif ($this->request->is('post') || $this->request->is('put')) {\n\t\t\tif (empty(Configure::read('MISP.host_org_id'))) $this->request->data['Server']['internal'] = 0;\n\t\t\tif($this->_isRest()) {\n\t\t\t\tif (!isset($this->request->data['Server'])) {\n\t\t\t\t\t$this->request->data = array('Server' => $this->request->data);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif(isset($this->request->data['Server']['json'])) {\n\t\t\t\t$json = json_decode($this->request->data['Server']['json'], true);\n\t\t\t} else {\n\t\t\t\t$json = NULL;\n\t\t\t}\n\t\t\t$fail = false;\n\n\t\t\t// test the filter fields\n\t\t\tif (!empty($this->request->data['Server']['pull_rules']) && !$this->Server->isJson($this->request->data['Server']['pull_rules'])) {\n\t\t\t\t$fail = true;\n\t\t\t\t$error_msg = __('The pull filter rules must be in valid JSON format.');\n\t\t\t\tif($this->_isRest()) {\n\t\t\t\t\treturn $this->RestResponse->saveFailResponse('Servers', 'edit', false, array('pull_rules' => $error_msg), $this->response->type());\n\t\t\t\t} else {\n\t\t\t\t\t$this->Session->setFlash($error_msg);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (!$fail && !empty($this->request->data['Server']['push_rules']) && !$this->Server->isJson($this->request->data['Server']['push_rules'])) {\n\t\t\t\t$fail = true;\n\t\t\t\t$error_msg = __('The push filter rules must be in valid JSON format.');\n\t\t\t\tif($this->_isRest()) {\n\t\t\t\t\treturn $this->RestResponse->saveFailResponse('Servers', 'edit', false, array('push_rules' => $error_msg), $this->response->type());\n\t\t\t\t} else {\n\t\t\t\t\t$this->Session->setFlash($error_msg);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!$fail) {\n\t\t\t\t// say what fields are to be updated\n\t\t\t\t$fieldList = array('id', 'url', 'push', 'pull', 'unpublish_event', 'publish_without_email', 'remote_org_id', 'name' ,'self_signed', 'cert_file', 'client_cert_file', 'push_rules', 'pull_rules', 'internal');\n\t\t\t\t$this->request->data['Server']['id'] = $id;\n\t\t\t\tif (isset($this->request->data['Server']['authkey']) && \"\" != $this->request->data['Server']['authkey']) $fieldList[] = 'authkey';\n\t\t\t\tif(isset($this->request->data['Server']['organisation_type']) && isset($json)) {\n\t\t\t\t\t// adds 'remote_org_id' in the fields to update\n\t\t\t\t\t$fieldList[] = 'remote_org_id';\n\t\t\t\t\tif ($this->request->data['Server']['organisation_type'] < 2) $this->request->data['Server']['remote_org_id'] = $json['id'];\n\t\t\t\t\telse {\n\t\t\t\t\t\t$existingOrgs = $this->Server->Organisation->find('first', array(\n\t\t\t\t\t\t\t\t'conditions' => array('uuid' => $json['uuid']),\n\t\t\t\t\t\t\t\t'recursive' => -1,\n\t\t\t\t\t\t\t\t'fields' => array('id', 'uuid')\n\t\t\t\t\t\t));\n\t\t\t\t\t\tif (!empty($existingOrgs)) {\n\t\t\t\t\t\t\t$fail = true;\n\t\t\t\t\t\t\tif($this->_isRest()) {\n\t\t\t\t\t\t\t\treturn $this->RestResponse->saveFailResponse('Servers', 'edit', false, array('Organisation' => 'Remote Organisation\\'s uuid already used'), $this->response->type());\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t$this->Session->setFlash(__('That organisation could not be created as the uuid is in use already.'));\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (!$fail) {\n\t\t\t\t\t\t\t$this->Server->Organisation->create();\n\t\t\t\t\t\t\t$orgSave = $this->Server->Organisation->save(array(\n\t\t\t\t\t\t\t\t\t'name' => $json['name'],\n\t\t\t\t\t\t\t\t\t'uuid' => $json['uuid'],\n\t\t\t\t\t\t\t\t\t'local' => 0,\n\t\t\t\t\t\t\t\t\t'created_by' => $this->Auth->user('id')\n\t\t\t\t\t\t\t));\n\n\t\t\t\t\t\t\tif (!$orgSave) {\n\t\t\t\t\t\t\t\tif($this->_isRest()) {\n\t\t\t\t\t\t\t\t\treturn $this->RestResponse->saveFailResponse('Servers', 'edit', false, $this->Server->Organisation->validationError, $this->response->type());\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t$this->Session->setFlash(__('Couldn\\'t save the new organisation, are you sure that the uuid is in the correct format?.'));\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t$fail = true;\n\t\t\t\t\t\t\t\t$this->request->data['Server']['external_name'] = $json['name'];\n\t\t\t\t\t\t\t\t$this->request->data['Server']['external_uuid'] = $json['uuid'];\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t$this->request->data['Server']['remote_org_id'] = $this->Server->Organisation->id;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (empty(Configure::read('MISP.host_org_id')) || $this->request->data['Server']['remote_org_id'] != Configure::read('MISP.host_org_id')) {\n\t\t\t\t\t\t$this->request->data['Server']['internal'] = 0;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!$fail) {\n\t\t\t\t// Save the data\n\t\t\t\tif ($this->Server->save($this->request->data, true, $fieldList)) {\n\t\t\t\t\tif (isset($this->request->data['Server']['submitted_cert']) && $this->request->data['Server']['submitted_cert']['size'] != 0 && (!isset($this->request->data['Server']['delete_cert']) || !$this->request->data['Server']['delete_cert'])) {\n\t\t\t\t\t\t$this->__saveCert($this->request->data, $this->Server->id, false);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (isset($this->request->data['Server']['delete_cert']) && $this->request->data['Server']['delete_cert']) $this->__saveCert($this->request->data, $this->Server->id, false, true);\n\t\t\t\t\t}\n\t\t\t\t\tif (isset($this->request->data['Server']['submitted_client_cert']) && $this->request->data['Server']['submitted_client_cert']['size'] != 0 && (!isset($this->request->data['Server']['delete_client_cert']) || !$this->request->data['Server']['delete_client_cert'])) {\n\t\t\t\t\t\t$this->__saveCert($this->request->data, $this->Server->id, true);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (isset($this->request->data['Server']['delete_client_cert']) && $this->request->data['Server']['delete_client_cert']) $this->__saveCert($this->request->data, $this->Server->id, true, true);\n\t\t\t\t\t}\n\t\t\t\t\tif($this->_isRest()) {\n\t\t\t\t\t\t$server = $this->Server->find('first', array(\n\t\t\t\t\t\t\t\t'conditions' => array('Server.id' => $this->Server->id),\n\t\t\t\t\t\t\t\t'recursive' => -1\n\t\t\t\t\t\t));\n\t\t\t\t\t\treturn $this->RestResponse->viewData($server, $this->response->type());\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$this->Session->setFlash(__('The server has been saved'));\n\t\t\t\t\t\t$this->redirect(array('action' => 'index'));\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tif($this->_isRest()) {\n\t\t\t\t\t\treturn $this->RestResponse->saveFailResponse('Servers', 'edit', false, $this->Server->validationError, $this->response->type());\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$this->Session->setFlash(__('The server could not be saved. Please, try again.'));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\t$this->Server->read(null, $id);\n\t\t\t$this->Server->set('authkey', '');\n\t\t\t$this->request->data = $this->Server->data;\n\t\t}\n\t\tif($this->_isRest()) {\n\t\t\treturn $this->RestResponse->describe('Servers', 'edit', false, $this->response->type());\n\t\t} else {\n\t\t\t$organisationOptions = array(0 => 'Local organisation', 1 => 'External organisation', 2 => 'New external organisation');\n\t\t\t$temp = $this->Server->Organisation->find('all', array(\n\t\t\t\t\t'conditions' => array('local' => true),\n\t\t\t\t\t'fields' => array('id', 'name'),\n\t\t\t\t\t'order' => array('lower(Organisation.name) ASC')\n\t\t\t));\n\t\t\t$localOrganisations = array();\n\t\t\t$allOrgs = array();\n\t\t\tforeach ($temp as $o) {\n\t\t\t\t$localOrganisations[$o['Organisation']['id']] = $o['Organisation']['name'];\n\t\t\t\t$allOrgs[] = array('id' => $o['Organisation']['id'], 'name' => $o['Organisation']['name']);\n\t\t\t}\n\t\t\t$temp = $this->Server->Organisation->find('all', array(\n\t\t\t\t\t'conditions' => array('local' => false),\n\t\t\t\t\t'fields' => array('id', 'name'),\n\t\t\t\t\t'order' => array('lower(Organisation.name) ASC')\n\t\t\t));\n\t\t\t$externalOrganisations = array();\n\t\t\tforeach ($temp as $o) {\n\t\t\t\t$externalOrganisations[$o['Organisation']['id']] = $o['Organisation']['name'];\n\t\t\t\t$allOrgs[] = array('id' => $o['Organisation']['id'], 'name' => $o['Organisation']['name']);\n\t\t\t}\n\n\t\t\t$oldRemoteSetting = 0;\n\t\t\tif (!$this->Server->data['RemoteOrg']['local']) $oldRemoteSetting = 1;\n\t\t\t$this->set('host_org_id', Configure::read('MISP.host_org_id'));\n\t\t\t$this->set('oldRemoteSetting', $oldRemoteSetting);\n\t\t\t$this->set('oldRemoteOrg', $this->Server->data['RemoteOrg']['id']);\n\n\t\t\t$this->set('organisationOptions', $organisationOptions);\n\t\t\t$this->set('localOrganisations', $localOrganisations);\n\t\t\t$this->set('externalOrganisations', $externalOrganisations);\n\t\t\t$this->set('allOrganisations', $allOrgs);\n\n\t\t\t// list all tags for the rule picker\n\t\t\t$this->loadModel('Tag');\n\t\t\t$temp = $this->Tag->find('all', array('recursive' => -1));\n\t\t\t$allTags = array();\n\t\t\tforeach ($temp as $t) $allTags[] = array('id' => $t['Tag']['id'], 'name' => $t['Tag']['name']);\n\t\t\t$this->set('allTags', $allTags);\n\t\t\t$this->set('server', $s);\n\t\t\t$this->set('host_org_id', Configure::read('MISP.host_org_id'));\n\t\t}\n\t}\n\n\tpublic function delete($id = null) {\n\t\tif (!$this->request->is('post')) {\n\t\t\tthrow new MethodNotAllowedException();\n\t\t}\n\t\t$this->Server->id = $id;\n\t\tif (!$this->Server->exists()) {\n\t\t\tthrow new NotFoundException(__('Invalid server'));\n\t\t}\n\t\t$s = $this->Server->read(null, $id);\n\t\tif (!$this->_isSiteAdmin()) $this->redirect(array('controller' => 'servers', 'action' => 'index'));\n\t\tif ($this->Server->delete()) {\n\t\t\t$this->Session->setFlash(__('Server deleted'));\n\t\t\t$this->redirect(array('action' => 'index'));\n\t\t}\n\t\t$this->Session->setFlash(__('Server was not deleted'));\n\t\t$this->redirect(array('action' => 'index'));\n\t}\n\n\t/**\n\t * Pull one or more events with attributes from a remote instance.\n\t * Set $technique to\n\t *\t\tfull - download everything\n\t *\t\tincremental - only new events\n\t *\t\t<int>\t- specific id of the event to pull\n\t */\n\tpublic function pull($id = null, $technique=false) {\n\t\t$this->Server->id = $id;\n\t\tif (!$this->Server->exists()) {\n\t\t\tthrow new NotFoundException(__('Invalid server'));\n\t\t}\n\t\t$s = $this->Server->read(null, $id);\n\t\tif (!$this->_isSiteAdmin() && !($s['Server']['org_id'] == $this->Auth->user('org_id') && $this->_isAdmin())) $this->redirect(array('controller' => 'servers', 'action' => 'index'));\n\t\t$this->Server->id = $id;\n\t\tif (!$this->Server->exists()) {\n\t\t\tthrow new NotFoundException(__('Invalid server'));\n\t\t}\n\n\t\tif (false == $this->Server->data['Server']['pull'] && ($technique == 'full' || $technique == 'incremental')) {\n\t\t\t$this->Session->setFlash(__('Pull setting not enabled for this server.'));\n\t\t\t$this->redirect(array('action' => 'index'));\n\t\t}\n\t\tif (!Configure::read('MISP.background_jobs')) {\n\t\t\t$result = $this->Server->pull($this->Auth->user(), $id, $technique, $s);\n\t\t\t// error codes\n\t\t\tif (isset($result[0]) && is_numeric($result[0])) {\n\t\t\t\tswitch ($result[0]) {\n\t\t\t\t\tcase '1' :\n\t\t\t\t\t\t$this->Session->setFlash(__('Not authorised. This is either due to an invalid auth key, or due to the sync user not having authentication permissions enabled on the remote server. Another reason could be an incorrect sync server setting.'));\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase '2' :\n\t\t\t\t\t\t$this->Session->setFlash($result[1]);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase '3' :\n\t\t\t\t\t\tthrow new NotFoundException('Sorry, this is not yet implemented');\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase '4' :\n\t\t\t\t\t\t$this->redirect(array('action' => 'index'));\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\t$this->redirect($this->referer());\n\t\t\t} else {\n\t\t\t\t$this->set('successes', $result[0]);\n\t\t\t\t$this->set('fails', $result[1]);\n\t\t\t\t$this->set('pulledProposals', $result[2]);\n\t\t\t\t$this->set('lastpulledid', $result[3]);\n\t\t\t}\n\t\t} else {\n\t\t\t$this->loadModel('Job');\n\t\t\t$this->Job->create();\n\t\t\t$data = array(\n\t\t\t\t\t'worker' => 'default',\n\t\t\t\t\t'job_type' => 'pull',\n\t\t\t\t\t'job_input' => 'Server: ' . $id,\n\t\t\t\t\t'status' => 0,\n\t\t\t\t\t'retries' => 0,\n\t\t\t\t\t'org' => $this->Auth->user('Organisation')['name'],\n\t\t\t\t\t'message' => 'Pulling.',\n\t\t\t);\n\t\t\t$this->Job->save($data);\n\t\t\t$jobId = $this->Job->id;\n\t\t\t$process_id = CakeResque::enqueue(\n\t\t\t\t\t'default',\n\t\t\t\t\t'ServerShell',\n\t\t\t\t\tarray('pull', $this->Auth->user('id'), $id, $technique, $jobId)\n\t\t\t);\n\t\t\t$this->Job->saveField('process_id', $process_id);\n\t\t\t$this->Session->setFlash('Pull queued for background execution.');\n\t\t\t$this->redirect($this->referer());\n\t\t}\n\t}\n\n\tpublic function push($id = null, $technique=false) {\n\t\t$this->Server->id = $id;\n\t\tif (!$this->Server->exists()) {\n\t\t\tthrow new NotFoundException(__('Invalid server'));\n\t\t}\n\t\t$s = $this->Server->read(null, $id);\n\t\tif (!$this->_isSiteAdmin() && !($s['Server']['org_id'] == $this->Auth->user('org_id') && $this->_isAdmin())) $this->redirect(array('controller' => 'servers', 'action' => 'index'));\n\t\tif (!Configure::read('MISP.background_jobs')) {\n\t\t\t$server = $this->Server->read(null, $id);\n\t\t\tApp::uses('SyncTool', 'Tools');\n\t\t\t$syncTool = new SyncTool();\n\t\t\t$HttpSocket = $syncTool->setupHttpSocket($server);\n\t\t\t$result = $this->Server->push($id, $technique, false, $HttpSocket, $this->Auth->user());\n\t\t\tif ($result === false) {\n\t\t\t\t$this->Session->setFlash('The remote server is too outdated to initiate a push towards it. Please notify the hosting organisation of the remote instance.');\n\t\t\t\t$this->redirect(array('action' => 'index'));\n\t\t\t}\n\t\t\t$this->set('successes', $result[0]);\n\t\t\t$this->set('fails', $result[1]);\n\t\t} else {\n\t\t\t$this->loadModel('Job');\n\t\t\t$this->Job->create();\n\t\t\t$data = array(\n\t\t\t\t\t'worker' => 'default',\n\t\t\t\t\t'job_type' => 'push',\n\t\t\t\t\t'job_input' => 'Server: ' . $id,\n\t\t\t\t\t'status' => 0,\n\t\t\t\t\t'retries' => 0,\n\t\t\t\t\t'org' => $this->Auth->user('Organisation')['name'],\n\t\t\t\t\t'message' => 'Pushing.',\n\t\t\t);\n\t\t\t$this->Job->save($data);\n\t\t\t$jobId = $this->Job->id;\n\t\t\t$process_id = CakeResque::enqueue(\n\t\t\t\t\t'default',\n\t\t\t\t\t'ServerShell',\n\t\t\t\t\tarray('push', $id, $technique, $jobId, $this->Auth->user('id'))\n\t\t\t);\n\t\t\t$this->Job->saveField('process_id', $process_id);\n\t\t\t$this->Session->setFlash('Push queued for background execution.');\n\t\t\t$this->redirect(array('action' => 'index'));\n\t\t}\n\t}\n\n\tprivate function __saveCert($server, $id, $client = false, $delete = false) {\n\t\tif ($client) {\n\t\t\t$subm = 'submitted_client_cert';\n\t\t\t$attr = 'client_cert_file';\n\t\t\t$ins  = '_client';\n\t\t} else {\n\t\t\t$subm = 'submitted_cert';\n\t\t\t$attr = 'cert_file';\n\t\t\t$ins  = '';\n\t\t}\n\t\tif (!$delete) {\n\t\t\t$ext = '';\n\t\t\tApp::uses('File', 'Utility');\n\t\t\tApp::uses('Folder', 'Utility');\n\t\t\tApp::uses('FileAccessTool', 'Tools');\n\t\t\tif (!$this->Server->checkFilename($server['Server'][$subm]['name'])) {\n\t\t\t\tthrow new Exception ('Filename not allowed');\n\t\t\t}\n\t\t\t$file = new File($server['Server'][$subm]['name']);\n\t\t\t$ext = $file->ext();\n\t\t\tif (($ext != 'pem') || !$server['Server'][$subm]['size'] > 0) {\n\t\t\t\t$this->Session->setFlash('Incorrect extension or empty file.');\n\t\t\t\t$this->redirect(array('action' => 'index'));\n\t\t\t}\n\n\t\t\t// read pem file data\n\t\t\t$pemData = (new FileAccessTool())->readFromFile($server['Server'][$subm]['tmp_name'], $server['Server'][$subm]['size']);\n\n\t\t\t$destpath = APP . \"files\" . DS . \"certs\" . DS;\n\t\t\t$dir = new Folder(APP . \"files\" . DS . \"certs\", true);\n\t\t\t$pemfile = new File($destpath . $id . $ins . '.' . $ext);\n\t\t\t$result = $pemfile->write($pemData);\n\t\t\t$s = $this->Server->read(null, $id);\n\t\t\t$s['Server'][$attr] = $s['Server']['id'] . $ins . '.' . $ext;\n\t\t\tif ($result) $this->Server->save($s);\n\t\t} else {\n\t\t\t$s = $this->Server->read(null, $id);\n\t\t\t$s['Server'][$attr] = '';\n\t\t\t$this->Server->save($s);\n\t\t}\n\t}\n\n\tpublic function serverSettingsReloadSetting($setting, $id) {\n\t\tif (!$this->_isSiteAdmin()) throw new MethodNotAllowedException();\n\t\t$pathToSetting = explode('.', $setting);\n\t\tif (strpos($setting, 'Plugin.Enrichment') !== false || strpos($setting, 'Plugin.Import') !== false || strpos($setting, 'Plugin.Export') !== false || strpos($setting, 'Plugin.Cortex') !== false) {\n\t\t\t$settingObject = $this->Server->getCurrentServerSettings();\n\t\t}\n\t\telse $settingObject = $this->Server->serverSettings;\n\t\tforeach ($pathToSetting as $key) {\n\t\t\tif (!isset($settingObject[$key])) throw new MethodNotAllowedException();\n\t\t\t$settingObject = $settingObject[$key];\n\t\t}\n\t\t$result = $this->Server->serverSettingReadSingle($settingObject, $setting, $key);\n\t\t$this->set('setting', $result);\n\t\t$priorityErrorColours = array(0 => 'red', 1 => 'yellow', 2 => 'green');\n\t\t$this->set('priorityErrorColours', $priorityErrorColours);\n\t\t$priorities = array(0 => 'Critical', 1 => 'Recommended', 2 => 'Optional', 3 => 'Deprecated');\n\t\t$this->set('priorities', $priorities);\n\t\t$this->set('k', $id);\n\t\t$this->layout = false;\n\n\t\t$subGroup = 'general';\n\t\tif ($pathToSetting[0] === 'Plugin') {\n\t\t\t$subGroup = explode('_', $pathToSetting[1])[0];\n\t\t}\n\t\t$this->set('subGroup', $subGroup);\n\n\t\t$this->render('/Elements/healthElements/settings_row');\n\t}\n\n\tprivate function __loadLocalOrgs() {\n\t\t$this->loadModel('Organisation');\n\t\t$local_orgs = $this->Organisation->find('list', array(\n\t\t\t\t'conditions' => array('local' => 1),\n\t\t\t\t'recursive' => -1,\n\t\t\t\t'fields' => array('Organisation.id', 'Organisation.name')\n\t\t));\n\t\treturn array_replace(array(0 => 'No organisation selected.'), $local_orgs);\n\t}\n\n\tpublic function serverSettings($tab=false) {\n\t\tif (!$this->_isSiteAdmin()) throw new MethodNotAllowedException();\n\t\tif ($this->request->is('Get')) {\n\t\t\t$tabs = array(\n\t\t\t\t\t'MISP' => array('count' => 0, 'errors' => 0, 'severity' => 5),\n\t\t\t\t\t'Encryption' => array('count' => 0, 'errors' => 0, 'severity' => 5),\n\t\t\t\t\t'Proxy' => array('count' => 0, 'errors' => 0, 'severity' => 5),\n\t\t\t\t\t'Security' => array('count' => 0, 'errors' => 0, 'severity' => 5),\n\t\t\t\t\t'Plugin' => array('count' => 0, 'errors' => 0, 'severity' => 5)\n\t\t\t);\n\t\t\t$writeableErrors = array(0 => 'OK', 1 => 'not found', 2 => 'is not writeable');\n\t\t\t$readableErrors = array(0 => 'OK', 1 => 'not readable');\n\t\t\t$gpgErrors = array(0 => 'OK', 1 => 'FAIL: settings not set', 2 => 'FAIL: Failed to load GPG', 3 => 'FAIL: Issues with the key/passphrase', 4 => 'FAIL: encrypt failed');\n\t\t\t$proxyErrors = array(0 => 'OK', 1 => 'not configured (so not tested)', 2 => 'Getting URL via proxy failed');\n\t\t\t$zmqErrors = array(0 => 'OK', 1 => 'not enabled (so not tested)', 2 => 'Python ZeroMQ library not installed correctly.', 3 => 'ZeroMQ script not running.');\n\t\t\t$stixOperational = array(0 => 'STIX or CyBox or mixbox library not installed correctly', 1 => 'OK');\n\t\t\t$stixVersion = array(0 => 'Incorrect STIX version installed, found $current, expecting $expected', 1 => 'OK');\n\t\t\t$cyboxVersion = array(0 => 'Incorrect CyBox version installed, found $current, expecting $expected', 1 => 'OK');\n\t\t\t$mixboxVersion = array(0 => 'Incorrect mixbox version installed, found $current, expecting $expected', 1 => 'OK');\n\t\t\t$sessionErrors = array(0 => 'OK', 1 => 'High', 2 => 'Alternative setting used', 3 => 'Test failed');\n\t\t\t$moduleErrors = array(0 => 'OK', 1 => 'System not enabled', 2 => 'No modules found');\n\n\t\t\t$finalSettings = $this->Server->serverSettingsRead();\n\t\t\t$issues = array(\n\t\t\t\t'errors' => array(\n\t\t\t\t\t\t0 => array(\n\t\t\t\t\t\t\t\t'value' => 0,\n\t\t\t\t\t\t\t\t'description' => 'MISP will not operate correctly or will be unsecure until these issues are resolved.'\n\t\t\t\t\t\t),\n\t\t\t\t\t\t1 => array(\n\t\t\t\t\t\t\t\t'value' => 0,\n\t\t\t\t\t\t\t\t'description' => 'Some of the features of MISP cannot be utilised until these issues are resolved.'\n\t\t\t\t\t\t),\n\t\t\t\t\t\t2 => array(\n\t\t\t\t\t\t\t\t'value' => 0,\n\t\t\t\t\t\t\t\t'description' => 'There are some optional tweaks that could be done to improve the looks of your MISP instance.'\n\t\t\t\t\t\t),\n\t\t\t\t),\n\t\t\t\t'deprecated' => array(),\n\t\t\t\t'overallHealth' => 3,\n\t\t\t);\n\t\t\t$dumpResults = array();\n\t\t\t$tempArray = array();\n\t\t\tforeach ($finalSettings as $k => $result) {\n\t\t\t\tif ($result['level'] == 3) $issues['deprecated']++;\n\t\t\t\t$tabs[$result['tab']]['count']++;\n\t\t\t\tif (isset($result['error']) && $result['level'] < 3) {\n\t\t\t\t\t$issues['errors'][$result['level']]['value']++;\n\t\t\t\t\tif ($result['level'] < $issues['overallHealth']) $issues['overallHealth'] = $result['level'];\n\t\t\t\t\t$tabs[$result['tab']]['errors']++;\n\t\t\t\t\tif ($result['level'] < $tabs[$result['tab']]['severity']) $tabs[$result['tab']]['severity'] = $result['level'];\n\t\t\t\t}\n\t\t\t\tif (isset($result['optionsSource']) && !empty($result['optionsSource'])) {\n\t\t\t\t\t$result['options'] = $this->{'__load' . $result['optionsSource']}();\n\t\t\t\t}\n\t\t\t\t$dumpResults[] = $result;\n\t\t\t\tif ($result['tab'] == $tab) {\n\t\t\t\t\tif (isset($result['subGroup'])) $tempArray[$result['subGroup']][] = $result;\n\t\t\t\t\telse $tempArray['general'][] = $result;\n\t\t\t\t}\n\t\t\t}\n\t\t\t$finalSettings = $tempArray;\n\t\t\t// Diagnostics portion\n\t\t\t$diagnostic_errors = 0;\n\t\t\tApp::uses('File', 'Utility');\n\t\t\tApp::uses('Folder', 'Utility');\n\t\t\t$additionalViewVars = array();\n\t\t\tif ($tab == 'files') {\n\t\t\t\t$files = $this->__manageFiles();\n\t\t\t\t$this->set('files', $files);\n\t\t\t}\n\t\t\t// Only run this check on the diagnostics tab\n\t\t\tif ($tab == 'diagnostics' || $tab == 'download') {\n\t\t\t\t$php_ini = php_ini_loaded_file();\n\t\t\t\t$this->set('php_ini', $php_ini);\n\t\t\t\t$advanced_attachments = shell_exec('python ' . APP . 'files/scripts/generate_file_objects.py -c');\n\t\t\t\ttry {\n\t\t\t\t\t$advanced_attachments = json_decode($advanced_attachments, true);\n\t\t\t\t} catch (Exception $e) {\n\t\t\t\t\t$advanced_attachments = false;\n\t\t\t\t}\n\t\t\t\t$this->set('advanced_attachments', $advanced_attachments);\n\t\t\t\t// check if the current version of MISP is outdated or not\n\t\t\t\t$version = $this->__checkVersion();\n\t\t\t\t$this->set('version', $version);\n\t\t\t\t$gitStatus = $this->Server->getCurrentGitStatus();\n\t\t\t\t$this->set('branch', $gitStatus['branch']);\n\t\t\t\t$this->set('commit', $gitStatus['commit']);\n\t\t\t\t$this->set('latestCommit', $gitStatus['latestCommit']);\n\t\t\t\t$phpSettings = array(\n\t\t\t\t\t\t'max_execution_time' => array(\n\t\t\t\t\t\t\t'explanation' => 'The maximum duration that a script can run (does not affect the background workers). A too low number will break long running scripts like comprehensive API exports',\n\t\t\t\t\t\t\t'recommended' => 300,\n\t\t\t\t\t\t\t'unit' => false\n\t\t\t\t\t\t),\n\t\t\t\t\t\t'memory_limit' => array(\n\t\t\t\t\t\t\t'explanation' => 'The maximum memory that PHP can consume. It is recommended to raise this number since certain exports can generate a fair bit of memory usage',\n\t\t\t\t\t\t\t'recommended' => 512,\n\t\t\t\t\t\t\t'unit' => 'M'\n\t\t\t\t\t\t),\n\t\t\t\t\t\t'upload_max_filesize' => array(\n\t\t\t\t\t\t\t'explanation' => 'The maximum size that an uploaded file can be. It is recommended to raise this number to allow for the upload of larger samples',\n\t\t\t\t\t\t\t'recommended' => 50,\n\t\t\t\t\t\t\t'unit' => 'M'\n\t\t\t\t\t\t),\n\t\t\t\t\t\t'post_max_size' => array(\n\t\t\t\t\t\t\t'explanation' => 'The maximum size of a POSTed message, this has to be at least the same size as the upload_max_filesize setting',\n\t\t\t\t\t\t\t'recommended' => 50,\n\t\t\t\t\t\t\t'unit' => 'M'\n\t\t\t\t\t\t)\n\n\t\t\t\t);\n\n\t\t\t\tforeach ($phpSettings as $setting => $settingArray) {\n\t\t\t\t\t$phpSettings[$setting]['value'] = ini_get($setting);\n\t\t\t\t\tif ($settingArray['unit']) $phpSettings[$setting]['value'] = intval(rtrim($phpSettings[$setting]['value'], $phpSettings[$setting]['unit']));\n\t\t\t\t\telse $phpSettings[$setting]['value'] = intval($phpSettings[$setting]['value']);\n\t\t\t\t}\n\t\t\t\t$this->set('phpSettings', $phpSettings);\n\n\t\t\t\tif ($version && (!$version['upToDate'] || $version['upToDate'] == 'older')) $diagnostic_errors++;\n\n\t\t\t\t// check if the STIX and Cybox libraries are working and the correct version using the test script stixtest.py\n\t\t\t\t$stix = $this->Server->stixDiagnostics($diagnostic_errors, $stixVersion, $cyboxVersion, $mixboxVersion);\n\n\t\t\t\t// if GPG is set up in the settings, try to encrypt a test message\n\t\t\t\t$gpgStatus = $this->Server->gpgDiagnostics($diagnostic_errors);\n\n\t\t\t\t// if the message queue pub/sub is enabled, check whether the extension works\n\t\t\t\t$zmqStatus = $this->Server->zmqDiagnostics($diagnostic_errors);\n\n\t\t\t\t// if Proxy is set up in the settings, try to connect to a test URL\n\t\t\t\t$proxyStatus = $this->Server->proxyDiagnostics($diagnostic_errors);\n\n\t\t\t\t$moduleTypes = array('Enrichment', 'Import', 'Export', 'Cortex');\n\t\t\t\tforeach ($moduleTypes as $type) {\n\t\t\t\t\t$moduleStatus[$type] = $this->Server->moduleDiagnostics($diagnostic_errors, $type);\n\t\t\t\t}\n\n\t\t\t\t// check the size of the session table\n\t\t\t\t$sessionCount = 0;\n\t\t\t\t$sessionStatus = $this->Server->sessionDiagnostics($diagnostic_errors, $sessionCount);\n\t\t\t\t$this->set('sessionCount', $sessionCount);\n\n\t\t\t\t$additionalViewVars = array('gpgStatus', 'sessionErrors', 'proxyStatus', 'sessionStatus', 'zmqStatus', 'stixVersion', 'cyboxVersion', 'mixboxVersion', 'moduleStatus', 'gpgErrors', 'proxyErrors', 'zmqErrors', 'stixOperational', 'stix', 'moduleErrors', 'moduleTypes');\n\t\t\t}\n\t\t\t// check whether the files are writeable\n\t\t\t$writeableDirs = $this->Server->writeableDirsDiagnostics($diagnostic_errors);\n\t\t\t$writeableFiles = $this->Server->writeableFilesDiagnostics($diagnostic_errors);\n\t\t\t$readableFiles = $this->Server->readableFilesDiagnostics($diagnostic_errors);\n\t\t\t$extensions = $this->Server->extensionDiagnostics();\n\n\t\t\t// check if the encoding is not set to utf8\n\t\t\t$dbEncodingStatus = $this->Server->databaseEncodingDiagnostics($diagnostic_errors);\n\n\t\t\t$viewVars = array(\n\t\t\t\t\t'diagnostic_errors', 'tabs', 'tab', 'issues', 'finalSettings', 'writeableErrors', 'readableErrors', 'writeableDirs', 'writeableFiles', 'readableFiles', 'extensions', 'dbEncodingStatus'\n\t\t\t);\n\t\t\t$viewVars = array_merge($viewVars, $additionalViewVars);\n\t\t\tforeach ($viewVars as $viewVar) $this->set($viewVar, ${$viewVar});\n\n\t\t\t$workerIssueCount = 0;\n\t\t\tif (Configure::read('MISP.background_jobs')) {\n\t\t\t\t$this->set('worker_array', $this->Server->workerDiagnostics($workerIssueCount));\n\t\t\t} else {\n\t\t\t\t$workerIssueCount = 4;\n\t\t\t\t$this->set('worker_array', array());\n\t\t\t}\n\t\t\tif ($tab == 'download') {\n\t\t\t\tforeach ($dumpResults as $key => $dr) {\n\t\t\t\t\tunset($dumpResults[$key]['description']);\n\t\t\t\t}\n\t\t\t\t$dump = array(\n\t\t\t\t\t\t'version' => $version,\n\t\t\t\t\t\t'phpSettings' => $phpSettings,\n\t\t\t\t\t\t'gpgStatus' => $gpgErrors[$gpgStatus],\n\t\t\t\t\t\t'proxyStatus' => $proxyErrors[$proxyStatus],\n\t\t\t\t\t\t'zmqStatus' => $zmqStatus,\n\t\t\t\t\t\t'stix' => $stix,\n\t\t\t\t\t\t'moduleStatus' => $moduleStatus,\n\t\t\t\t\t\t'writeableDirs' => $writeableDirs,\n\t\t\t\t\t\t'writeableFiles' => $writeableFiles,\n\t\t\t\t\t\t'readableFiles' => $readableFiles,\n\t\t\t\t\t\t'finalSettings' => $dumpResults,\n\t\t\t\t\t\t'extensions' => $extensions\n\t\t\t\t);\n\t\t\t\tforeach ($dump['finalSettings'] as $k => $v) {\n\t\t\t\t\tif (!empty($v['redacted'])) {\n\t\t\t\t\t\t$dump['finalSettings'][$k]['value'] = '*****';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t$this->response->body(json_encode($dump, JSON_PRETTY_PRINT));\n\t\t\t\t$this->response->type('json');\n\t\t\t\t$this->response->download('MISP.report.json');\n\t\t\t\treturn $this->response;\n\t\t\t}\n\n\t\t\t$priorities = array(0 => 'Critical', 1 => 'Recommended', 2 => 'Optional', 3 => 'Deprecated');\n\t\t\t$this->set('priorities', $priorities);\n\t\t\t$this->set('workerIssueCount', $workerIssueCount);\n\t\t\t$priorityErrorColours = array(0 => 'red', 1 => 'yellow', 2 => 'green');\n\t\t\t$this->set('priorityErrorColours', $priorityErrorColours);\n\t\t\t$this->set('phpversion', phpversion());\n\t\t\t$this->set('phpmin', $this->phpmin);\n\t\t\t$this->set('phprec', $this->phprec);\n\t\t}\n\t}\n\n\tpublic function startWorker($type) {\n\t\tif (!$this->_isSiteAdmin() || !$this->request->is('post')) throw new MethodNotAllowedException();\n\t\t$validTypes = array('default', 'email', 'scheduler', 'cache', 'prio');\n\t\tif (!in_array($type, $validTypes)) throw new MethodNotAllowedException('Invalid worker type.');\n\t\t$prepend = '';\n\t\tif (Configure::read('MISP.rh_shell_fix')) $prepend = 'export PATH=$PATH:\"/opt/rh/rh-php56/root/usr/bin:/opt/rh/rh-php56/root/usr/sbin\"; ';\n\t\tif ($type != 'scheduler') shell_exec($prepend . APP . 'Console' . DS . 'cake CakeResque.CakeResque start --interval 5 --queue ' . $type .' > /dev/null 2>&1 &');\n\t\telse shell_exec($prepend . APP . 'Console' . DS . 'cake CakeResque.CakeResque startscheduler -i 5 > /dev/null 2>&1 &');\n\t\t$this->redirect('/servers/serverSettings/workers');\n\t}\n\n\tpublic function stopWorker($pid) {\n\t\tif (!$this->_isSiteAdmin() || !$this->request->is('post')) throw new MethodNotAllowedException();\n\t\t$this->Server->killWorker($pid, $this->Auth->user());\n\t\t$this->redirect('/servers/serverSettings/workers');\n\t}\n\n\tprivate function __checkVersion() {\n\t\tif (!$this->_isSiteAdmin()) throw new MethodNotAllowedException();\n\t\tApp::uses('SyncTool', 'Tools');\n\t\t$syncTool = new SyncTool();\n\t\ttry {\n\t\t\t$HttpSocket = $syncTool->setupHttpSocket();\n\t\t\t$response = $HttpSocket->get('https://api.github.com/repos/MISP/MISP/tags');\n\t\t\t$tags = $response->body;\n\t\t} catch (Exception $e) {\n\t\t\treturn false;\n\t\t}\n\t\tif ($response->isOK() && !empty($tags)) {\n\t\t\t$json_decoded_tags = json_decode($tags);\n\n\t\t\t// find the latest version tag in the v[major].[minor].[hotfix] format\n\t\t\tfor ($i = 0; $i < count($json_decoded_tags); $i++) {\n\t\t\t\tif (preg_match('/^v[0-9]+\\.[0-9]+\\.[0-9]+$/', $json_decoded_tags[$i]->name)) break;\n\t\t\t}\n\t\t\treturn $this->Server->checkVersion($json_decoded_tags[$i]->name);\n\t\t} else {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tpublic function serverSettingsEdit($setting, $id = false, $forceSave = false) {\n\t\t// invalidate config.php from php opcode cache\n\t\tif (function_exists('opcache_reset')) opcache_reset();\n\n\t\tif (!$this->_isSiteAdmin()) throw new MethodNotAllowedException();\n\t\tif (!isset($setting) || !isset($id)) throw new MethodNotAllowedException();\n\t\t$this->set('id', $id);\n\t\tif (strpos($setting, 'Plugin.Enrichment') !== false || strpos($setting, 'Plugin.Import') !== false || strpos($setting, 'Plugin.Export') !== false || strpos($setting, 'Plugin.Cortex') !== false) {\n\t\t\t$serverSettings = $this->Server->getCurrentServerSettings();\n\t\t}\n\t\telse $serverSettings = $this->Server->serverSettings;\n\t\t$relevantSettings = (array_intersect_key(Configure::read(), $serverSettings));\n\t\t$found = null;\n\t\tforeach ($serverSettings as $k => $s) {\n\t\t\tif (isset($s['branch'])) {\n\t\t\t\tforeach ($s as $ek => $es) {\n\t\t\t\t\tif ($ek != 'branch') {\n\t\t\t\t\t\tif ($setting == $k . '.' . $ek) {\n\t\t\t\t\t\t\t$found = $es;\n\t\t\t\t\t\t\tcontinue 2;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif ($setting == $k) {\n\t\t\t\t\t$found = $s;\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif ($this->request->is('get')) {\n\t\t\tif ($found != null) {\n\t\t\t\t$value = Configure::read($setting);\n\t\t\t\tif ($value) $found['value'] = $value;\n\t\t\t\t$found['setting'] = $setting;\n\t\t\t}\n\t\t\tif (isset($found['optionsSource']) && !empty($found['optionsSource'])) {\n\t\t\t\t$found['options'] = $this->{'__load' . $found['optionsSource']}();\n\t\t\t}\n\t\t\t$subGroup = 'general';\n\t\t\t$subGroup = explode('.', $setting);\n\t\t\tif ($subGroup[0] === 'Plugin') {\n\t\t\t\t$subGroup = explode('_', $subGroup[1])[0];\n\t\t\t} else {\n\t\t\t\t$subGroup = 'general';\n\t\t\t}\n\t\t\tif ($this->_isRest()) {\n\t\t\t\treturn $this->RestResponse->viewData(array($setting => $found['value']));\n\t\t\t} else {\n\t\t\t\t$this->set('subGroup', $subGroup);\n\t\t\t\t$this->set('setting', $found);\n\t\t\t\t$this->render('ajax/server_settings_edit');\n\t\t\t}\n\n\t\t}\n\t\tif ($this->request->is('post')) {\n\t\t\tif (!isset($this->request->data['Server'])) $this->request->data = array('Server' => $this->request->data);\n\t\t\tif (!isset($this->request->data['Server']['value'])) {\n\t\t\t\tif ($this->_isRest()) {\n\t\t\t\t\treturn $this->RestResponse->saveFailResponse('Servers', 'serverSettingsEdit', false, 'Invalid input. Expected: {\"value\": \"new_setting\"}', $this->response->type());\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (trim($this->request->data['Server']['value']) === '*****') {\n\t\t\t\tif ($this->_isRest()) {\n\t\t\t\t\treturn $this->RestResponse->saveFailResponse('Servers', 'serverSettingsEdit', false, 'No change.', $this->response->type());\n\t\t\t\t} else {\n\t\t\t\t\treturn new CakeResponse(array('body'=> json_encode(array('saved' => false, 'errors' => 'No change.')), 'status'=>200, 'type' => 'json'));\n\t\t\t\t}\n\t\t\t}\n\t\t\t$this->autoRender = false;\n\t\t\t$this->loadModel('Log');\n\t\t\tif (!is_writeable(APP . 'Config/config.php')) {\n\t\t\t\t$this->Log->create();\n\t\t\t\t$result = $this->Log->save(array(\n\t\t\t\t\t\t'org' => $this->Auth->user('Organisation')['name'],\n\t\t\t\t\t\t'model' => 'Server',\n\t\t\t\t\t\t'model_id' => 0,\n\t\t\t\t\t\t'email' => $this->Auth->user('email'),\n\t\t\t\t\t\t'action' => 'serverSettingsEdit',\n\t\t\t\t\t\t'user_id' => $this->Auth->user('id'),\n\t\t\t\t\t\t'title' => 'Server setting issue',\n\t\t\t\t\t\t'change' => 'There was an issue witch changing ' . $setting . ' to ' . $this->request->data['Server']['value']  . '. The error message returned is: app/Config.config.php is not writeable to the apache user. No changes were made.',\n\t\t\t\t));\n\t\t\t\tif ($this->_isRest()) {\n\t\t\t\t\treturn $this->RestResponse->saveFailResponse('Servers', 'serverSettingsEdit', false, 'app/Config.config.php is not writeable to the apache user.', $this->response->type());\n\t\t\t\t} else {\n\t\t\t\t\treturn new CakeResponse(array('body'=> json_encode(array('saved' => false, 'errors' => 'app/Config.config.php is not writeable to the apache user.')), 'status'=>200, 'type' => 'json'));\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (isset($found['beforeHook'])) {\n\t\t\t\t$beforeResult = call_user_func_array(array($this->Server, $found['beforeHook']), array($setting, $this->request->data['Server']['value']));\n\t\t\t\tif ($beforeResult !== true) {\n\t\t\t\t\t$this->Log->create();\n\t\t\t\t\t$result = $this->Log->save(array(\n\t\t\t\t\t\t\t'org' => $this->Auth->user('Organisation')['name'],\n\t\t\t\t\t\t\t'model' => 'Server',\n\t\t\t\t\t\t\t'model_id' => 0,\n\t\t\t\t\t\t\t'email' => $this->Auth->user('email'),\n\t\t\t\t\t\t\t'action' => 'serverSettingsEdit',\n\t\t\t\t\t\t\t'user_id' => $this->Auth->user('id'),\n\t\t\t\t\t\t\t'title' => 'Server setting issue',\n\t\t\t\t\t\t\t'change' => 'There was an issue witch changing ' . $setting . ' to ' . $this->request->data['Server']['value']  . '. The error message returned is: ' . $beforeResult . 'No changes were made.',\n\t\t\t\t\t));\n\t\t\t\t\tif ($this->_isRest) {\n\t\t\t\t\t\treturn $this->RestResponse->saveFailResponse('Servers', 'serverSettingsEdit', false, $beforeResult, $this->response->type());\n\t\t\t\t\t} else {\n\t\t\t\t\t\treturn new CakeResponse(array('body'=> json_encode(array('saved' => false, 'errors' => $beforeResult)), 'status'=>200, 'type' => 'json'));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\t$this->request->data['Server']['value'] = trim($this->request->data['Server']['value']);\n\t\t\tif ($found['type'] == 'boolean') {\n\t\t\t\t$this->request->data['Server']['value'] = ($this->request->data['Server']['value'] ? true : false);\n\t\t\t}\n\t\t\tif ($found['type'] == 'numeric') {\n\t\t\t\t$this->request->data['Server']['value'] = intval($this->request->data['Server']['value']);\n\t\t\t}\n\t\t\tif  (!empty($leafValue['test'])) {\n\t\t\t\t$testResult = $this->Server->{$found['test']}($this->request->data['Server']['value']);\n\t\t\t} else  {\n\t\t\t\t$testResult = true;  # No test defined for this setting: cannot fail\n\t\t\t}\n\t\t\tif (!$forceSave && $testResult !== true) {\n\t\t\t\tif ($testResult === false) $errorMessage = $found['errorMessage'];\n\t\t\t\telse $errorMessage = $testResult;\n\t\t\t\tif ($this->_isRest) {\n\t\t\t\t\treturn $this->RestResponse->saveFailResponse('Servers', 'serverSettingsEdit', false, $errorMessage, $this->response->type());\n\t\t\t\t} else {\n\t\t\t\t\treturn new CakeResponse(array('body'=> json_encode(array('saved' => false, 'errors' => $errorMessage)), 'status'=>200, 'type' => 'json'));\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t$oldValue = Configure::read($setting);\n\t\t\t\t$this->Server->serverSettingsSaveValue($setting, $this->request->data['Server']['value']);\n\t\t\t\t$this->Log->create();\n\t\t\t\t$result = $this->Log->save(array(\n\t\t\t\t\t\t'org' => $this->Auth->user('Organisation')['name'],\n\t\t\t\t\t\t'model' => 'Server',\n\t\t\t\t\t\t'model_id' => 0,\n\t\t\t\t\t\t'email' => $this->Auth->user('email'),\n\t\t\t\t\t\t'action' => 'serverSettingsEdit',\n\t\t\t\t\t\t'user_id' => $this->Auth->user('id'),\n\t\t\t\t\t\t'title' => 'Server setting changed',\n\t\t\t\t\t\t'change' => $setting . ' (' . $oldValue . ') => (' . $this->request->data['Server']['value'] . ')',\n\t\t\t\t));\n\t\t\t\t// execute after hook\n\t\t\t\tif (isset($found['afterHook'])) {\n\t\t\t\t\t$afterResult = call_user_func_array(array($this->Server, $found['afterHook']), array($setting, $this->request->data['Server']['value']));\n\t\t\t\t\tif ($afterResult !== true) {\n\t\t\t\t\t\t$this->Log->create();\n\t\t\t\t\t\t$result = $this->Log->save(array(\n\t\t\t\t\t\t\t\t'org' => $this->Auth->user('Organisation')['name'],\n\t\t\t\t\t\t\t\t'model' => 'Server',\n\t\t\t\t\t\t\t\t'model_id' => 0,\n\t\t\t\t\t\t\t\t'email' => $this->Auth->user('email'),\n\t\t\t\t\t\t\t\t'action' => 'serverSettingsEdit',\n\t\t\t\t\t\t\t\t'user_id' => $this->Auth->user('id'),\n\t\t\t\t\t\t\t\t'title' => 'Server setting issue',\n\t\t\t\t\t\t\t\t'change' => 'There was an issue after setting a new setting. The error message returned is: ' . $afterResult,\n\t\t\t\t\t\t));\n\t\t\t\t\t\tif ($this->_isRest) {\n\t\t\t\t\t\t\treturn $this->RestResponse->saveFailResponse('Servers', 'serverSettingsEdit', false, $afterResult, $this->response->type());\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\treturn new CakeResponse(array('body'=> json_encode(array('saved' => false, 'errors' => $afterResult)), 'status'=>200, 'type' => 'json'));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif ($this->_isRest) {\n\t\t\t\t\treturn $this->RestResponse->saveSuccessResponse('Servers', 'serverSettingsEdit', false, $this->response->type(), 'Field updated');\n\t\t\t\t} else {\n\t\t\t\t\treturn new CakeResponse(array('body'=> json_encode(array('saved' => true, 'success' => 'Field updated.')), 'status'=>200, 'type' => 'json'));\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic function restartWorkers() {\n\t\tif (!$this->_isSiteAdmin() || !$this->request->is('post')) throw new MethodNotAllowedException();\n\t\t$this->Server->workerRemoveDead($this->Auth->user());\n\t\t$prepend = '';\n\t\tif (Configure::read('MISP.rh_shell_fix')) {\n\t\t\t$prepend = 'export PATH=$PATH:\"/opt/rh/rh-php56/root/usr/bin:/opt/rh/rh-php56/root/usr/sbin\"; ';\n\t\t\tif (Configure::read('MISP.rh_shell_fix_path')) {\n\t\t\t\tif ($this->Server->testForPath(Configure::read('MISP.rh_shell_fix_path'))) $prepend = Configure::read('MISP.rh_shell_fix_path');\n\t\t\t}\n\t\t}\n\t\tshell_exec($prepend . APP . 'Console' . DS . 'worker' . DS . 'start.sh > /dev/null 2>&1 &');\n\t\t$this->redirect(array('controller' => 'servers', 'action' => 'serverSettings', 'workers'));\n\t}\n\n\tprivate function __manageFiles() {\n\t\tif (!$this->_isSiteAdmin()) throw new MethodNotAllowedException();\n\t\t$files = $this->Server->grabFiles();\n\t\treturn $files;\n\t}\n\n\tpublic function deleteFile($type, $filename) {\n\t\tif (!$this->_isSiteAdmin()) throw new MethodNotAllowedException();\n\t\tif ($this->request->is('post')) {\n\t\t\t$validItems = $this->Server->getFileRules();\n\t\t\tApp::uses('File', 'Utility');\n\t\t\t$existingFile = new File($validItems[$type]['path'] . DS . $filename);\n\t\t\tif (!$existingFile->exists()) {\n\t\t\t\t$this->Session->setFlash(__('File not found.', true), 'default', array(), 'error');\n\t\t\t\t$this->redirect(array('controller' => 'servers', 'action' => 'serverSettings', 'files'));\n\t\t\t}\n\t\t\tif ($existingFile->delete()) {\n\t\t\t\t$this->Session->setFlash('File deleted.');\n\t\t\t} else {\n\t\t\t\t$this->Session->setFlash(__('File could not be deleted.', true), 'default', array(), 'error');\n\t\t\t}\n\t\t\t$this->redirect(array('controller' => 'servers', 'action' => 'serverSettings', 'files'));\n\t\t} else {\n\t\t\tthrow new MethodNotAllowedException('This action expects a POST request.');\n\t\t}\n\t}\n\n\tpublic function uploadFile($type) {\n\t\tif (!$this->_isSiteAdmin() || !$this->request->is('post')) throw new MethodNotAllowedException();\n\t\t$validItems = $this->Server->getFileRules();\n\n\t\t// Check if there were problems with the file upload\n\t\t// only keep the last part of the filename, this should prevent directory attacks\n\t\t$filename = basename($this->request->data['Server']['file']['name']);\n\t\tif (!preg_match(\"/\" . $validItems[$type]['regex'] . \"/\", $filename)) {\n\t\t\t$this->Session->setFlash(__($validItems[$type]['regex_error'], true), 'default', array(), 'error');\n\t\t\t$this->redirect(array('controller' => 'servers', 'action' => 'serverSettings', 'files'));\n\t\t}\n\t\tif (empty($this->request->data['Server']['file']['tmp_name']) || !is_uploaded_file($this->request->data['Server']['file']['tmp_name'])) {\n\t\t\t$this->Session->setFlash(__('Upload failed.', true), 'default', array(), 'error');\n\t\t\t$this->redirect(array('controller' => 'servers', 'action' => 'serverSettings', 'files'));\n\t\t}\n\n\t\t// check if the file already exists\n\t\tApp::uses('File', 'Utility');\n\t\t$existingFile = new File($validItems[$type]['path'] . DS . $filename);\n\t\tif ($existingFile->exists()) {\n\t\t\t$this->Session->setFlash(__('File already exists. If you would like to replace it, remove the old one first.', true), 'default', array(), 'error');\n\t\t\t$this->redirect(array('controller' => 'servers', 'action' => 'serverSettings', 'files'));\n\t\t}\n\n\t\t$result = move_uploaded_file($this->request->data['Server']['file']['tmp_name'], $validItems[$type]['path'] . DS . $filename);\n\t\tif ($result) {\n\t\t\t$this->Session->setFlash('File uploaded.');\n\t\t} else {\n\t\t\t$this->Session->setFlash(__('Upload failed.', true), 'default', array(), 'error');\n\t\t}\n\t\t$this->redirect(array('controller' => 'servers', 'action' => 'serverSettings', 'files'));\n\t}\n\n\tpublic function fetchServersForSG($idList = '{}') {\n\t\t$id_exclusion_list = json_decode($idList, true);\n\t\t$temp = $this->Server->find('all', array(\n\t\t\t\t'conditions' => array(\n\t\t\t\t\t\t'id !=' => $id_exclusion_list,\n\t\t\t\t),\n\t\t\t\t'recursive' => -1,\n\t\t\t\t'fields' => array('id', 'name', 'url')\n\t\t));\n\t\t$servers = array();\n\t\tforeach ($temp as $server) {\n\t\t\t$servers[] = array('id' => $server['Server']['id'], 'name' => $server['Server']['name'], 'url' => $server['Server']['url']);\n\t\t}\n\t\t$this->layout = false;\n\t\t$this->autoRender = false;\n\t\t$this->set('servers', $servers);\n\t\t$this->render('ajax/fetch_servers_for_sg');\n\t}\n\n\tpublic function postTest() {\n\t\tif ($this->request->is('post')) {\n\t\t\t// Fix for PHP-FPM / Nginx / etc\n\t\t\t// Fix via https://www.popmartian.com/tipsntricks/2015/07/14/howto-use-php-getallheaders-under-fastcgi-php-fpm-nginx-etc/\n\t\t\tif (!function_exists('getallheaders')) {\n\t\t\t\t$headers = [];\n\t\t\t\tforeach ($_SERVER as $name => $value) {\n\t\t\t\t    if (substr($name, 0, 5) == 'HTTP_') {\n\t\t\t\t        $headers[str_replace(' ', '-', ucwords(strtolower(str_replace('_', ' ', substr($name, 5)))))] = $value;\n\t\t\t\t    }\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t$headers = getallheaders();\n\t\t\t}\n\t\t\t$result = array();\n\t\t\t$result['body'] = $this->request->data;\n\t\t\t$result['headers']['Content-type'] = isset($headers['Content-type']) ? $headers['Content-type'] : 0;\n\t\t\t$result['headers']['Accept'] = isset($headers['Accept']) ? $headers['Accept'] : 0;\n\t\t\t$result['headers']['Authorization'] = isset($headers['Authorization']) ? 'OK' : 0;\n\t\t\treturn new CakeResponse(array('body'=> json_encode($result), 'type' => 'json'));\n\t\t} else {\n\t\t\tthrow new MethodNotAllowedException('Invalid request, expecting a POST request.');\n\t\t}\n\t}\n\n\tpublic function testConnection($id = false) {\n\t\t\tif (!$this->Auth->user('Role')['perm_sync'] && !$this->Auth->user('Role')['perm_site_admin']) throw new MethodNotAllowedException('You don\\'t have permission to do that.');\n\t\t\t$this->Server->id = $id;\n\t\t\tif (!$this->Server->exists()) {\n\t\t\t\tthrow new NotFoundException(__('Invalid server'));\n\t\t\t}\n\t\t\t$result = $this->Server->runConnectionTest($id);\n\t\t\tif ($result['status'] == 1) {\n\t\t\t\t$version = json_decode($result['message'], true);\n\t\t\t\tif (isset($version['version']) && preg_match('/^[0-9]+\\.+[0-9]+\\.[0-9]+$/', $version['version'])) {\n\t\t\t\t\tApp::uses('Folder', 'Utility');\n\t\t\t\t\t$file = new File(ROOT . DS . 'VERSION.json', true);\n\t\t\t\t\t$local_version = json_decode($file->read(), true);\n\t\t\t\t\t$file->close();\n\t\t\t\t\t$version = explode('.', $version['version']);\n\t\t\t\t\t$mismatch = false;\n\t\t\t\t\t$newer = false;\n\t\t\t\t\t$parts = array('major', 'minor', 'hotfix');\n\t\t\t\t\tif ($version[0] == 2 && $version[1] == 4 && $version[2] > 68) {\n\t\t\t\t\t\t$post = $this->Server->runPOSTTest($id);\n\t\t\t\t\t}\n\t\t\t\t\t$testPost = false;\n\t\t\t\t\tforeach ($parts as $k => $v) {\n\t\t\t\t\t\tif (!$mismatch) {\n\t\t\t\t\t\t\tif ($version[$k] > $local_version[$v]) {\n\t\t\t\t\t\t\t\t$mismatch = $v;\n\t\t\t\t\t\t\t\t$newer = 'remote';\n\t\t\t\t\t\t\t} else if ($version[$k] < $local_version[$v]) {\n\t\t\t\t\t\t\t\t$mismatch = $v;\n\t\t\t\t\t\t\t\t$newer = 'local';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!isset($version['perm_sync'])) {\n\t\t\t\t\t\tif (!$this->Server->checkLegacyServerSyncPrivilege($id)) {\n\t\t\t\t\t\t\t$result['status'] = 7;\n\t\t\t\t\t\t\treturn new CakeResponse(array('body'=> json_encode($result), 'type' => 'json'));\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (!$version['perm_sync']) {\n\t\t\t\t\t\t\t$result['status'] = 7;\n\t\t\t\t\t\t\treturn new CakeResponse(array('body'=> json_encode($result), 'type' => 'json'));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\treturn new CakeResponse(\n\t\t\t\t\t\tarray(\n\t\t\t\t\t\t'body'=> json_encode(\n\t\t\t\t\t\t\tarray(\n\t\t\t\t\t\t\t\t'status' => 1,\n\t\t\t\t\t\t\t\t'local_version' => implode('.', $local_version),\n\t\t\t\t\t\t\t\t'version' => implode('.', $version),\n\t\t\t\t\t\t\t\t'mismatch' => $mismatch,\n\t\t\t\t\t\t\t\t'newer' => $newer,\n\t\t\t\t\t\t\t\t'post' => isset($post) ? $post : 'too old'\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t'type' => 'json'\n\t\t\t\t\t\t)\n\t\t\t\t\t);\n\t\t\t\t} else {\n\t\t\t\t\t$result['status'] = 3;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn new CakeResponse(array('body'=> json_encode($result), 'type' => 'json'));\n\t}\n\n\tpublic function startZeroMQServer() {\n\t\tif (!$this->_isSiteAdmin()) throw new MethodNotAllowedException();\n\t\t$pubSubTool = $this->Server->getPubSubTool();\n\t\t$result = $pubSubTool->restartServer();\n\t\tif ($result === true) return new CakeResponse(array('body'=> json_encode(array('saved' => true, 'success' => 'ZeroMQ server successfully started.')), 'status'=>200, 'type' => 'json'));\n\t\telse return new CakeResponse(array('body'=> json_encode(array('saved' => false, 'errors' => $result)), 'status'=>200, 'type' => 'json'));\n\t}\n\n\tpublic function stopZeroMQServer() {\n\t\tif (!$this->_isSiteAdmin()) throw new MethodNotAllowedException();\n\t\t$pubSubTool = $this->Server->getPubSubTool();\n\t\t$result = $pubSubTool->killService();\n\t\tif ($result === true) return new CakeResponse(array('body'=> json_encode(array('saved' => true, 'success' => 'ZeroMQ server successfully killed.')), 'status'=>200, 'type' => 'json'));\n\t\telse return new CakeResponse(array('body'=> json_encode(array('saved' => false, 'errors' => 'Could not kill the previous instance of the ZeroMQ script.')), 'status'=>200, 'type' => 'json'));\n\t}\n\n\tpublic function statusZeroMQServer() {\n\t\tif (!$this->_isSiteAdmin()) throw new MethodNotAllowedException();\n\t\t$pubSubTool = $this->Server->getPubSubTool();\n\t\t$result = $pubSubTool->statusCheck();\n\t\tif (!empty($result)) {\n\t\t\t$this->set('events', $result['publishCount']);\n\t\t\t$this->set('time', date('Y/m/d H:i:s', $result['timestamp']));\n\t\t\t$this->set('time2', date('Y/m/d H:i:s', $result['timestampSettings']));\n\t\t}\n\t\t$this->render('ajax/zeromqstatus');\n\t}\n\n\tpublic function purgeSessions() {\n\t\tif (!$this->_isSiteAdmin()) throw new MethodNotAllowedException();\n\t\tif ($this->Server->updateDatabase('cleanSessionTable') == false) {\n\t\t\t$this->Session->setFlash('Could not purge the session table.');\n\t\t}\n\t\t$this->redirect('/servers/serverSettings/diagnostics');\n\t}\n\n\tpublic function clearWorkerQueue($worker) {\n\t\tif (!$this->_isSiteAdmin() || !$this->request->is('Post') || $this->request->is('ajax')) throw new MethodNotAllowedException();\n\t\t$worker_array = array('cache', 'default', 'email', 'prio');\n\t\tif (!in_array($worker, $worker_array)) throw new MethodNotAllowedException('Invalid worker');\n\t\t$redis = Resque::redis();\n\t\t$redis->del('queue:' . $worker);\n\t\t$this->Session->setFlash('Queue cleared.');\n\t\t$this->redirect($this->referer());\n\t}\n\n\tpublic function getVersion() {\n\t\tif (!$this->userRole['perm_auth']) throw new MethodNotAllowedException('This action requires API access.');\n\t\t$versionArray = $this->Server->checkMISPVersion();\n\t\t$this->set('response', array('version' => $versionArray['major'] . '.' . $versionArray['minor'] . '.' . $versionArray['hotfix'], 'perm_sync' => $this->userRole['perm_sync']));\n\t\t$this->set('_serialize', 'response');\n\t}\n\n\tpublic function getPyMISPVersion() {\n\t\t$this->set('response', array('version' => $this->pyMispVersion));\n\t\t$this->set('_serialize', 'response');\n\t}\n\n\tpublic function getGit() {\n\t\t$status = $this->Server->getCurrentGitStatus();\n\t}\n\n\tpublic function checkout() {\n\t\t$result = $this->Server->checkoutMain();\n\t}\n\n\tpublic function update() {\n\t\tif ($this->request->is('post')) {\n\t\t\t$status = $this->Server->getCurrentGitStatus();\n\t\t\t$update = $this->Server->update($status);\n\t\t\treturn new CakeResponse(array('body'=> $update, 'type' => 'txt'));\n\t\t} else {\n\t\t\t$branch = $this->Server->getCurrentBranch();\n\t\t\t$this->set('branch', $branch);\n\t\t\t$this->render('ajax/update');\n\t\t}\n\t}\n\n\tpublic function getInstanceUUID() {\n\t\treturn $this->RestResponse->viewData(array('uuid' => Configure::read('MISP.uuid')), $this->response->type());\n\t}\n}\n", "<?php\nApp::uses('AppModel', 'Model');\n\nclass Server extends AppModel {\n\n\tpublic $name = 'Server';\n\n\tpublic $actsAs = array('SysLogLogable.SysLogLogable' => array(\t// TODO Audit, logable, check: 'userModel' and 'userKey' can be removed given default\n\t\t\t'userModel' => 'User',\n\t\t\t'userKey' => 'user_id',\n\t\t\t'change' => 'full'\n\t\t),\n\t\t'Trim',\n\t\t'Containable'\n\t);\n\n\tpublic $belongsTo = array(\n\t\t'Organisation' => array(\n\t\t\t'className' => 'Organisation',\n\t\t\t'foreignKey' => 'org_id',\n\t\t),\n\t\t'RemoteOrg' => array(\n\t\t\t'className' => 'Organisation',\n\t\t\t'foreignKey' => 'remote_org_id',\n\t\t)\n\t);\n\n\tpublic $hasMany = array(\n\t\t'SharingGroupServer' => array(\n\t\t\t'className' => 'SharingGroupServer',\n\t\t\t'foreignKey' => 'server_id',\n\t\t\t'dependent'=> true,\n\t\t),\n\t\t'User' => array(\n\t\t\t'className' => 'User',\n\t\t\t'foreignKey' => 'server_id',\n\t\t),\n\t);\n\n\tpublic $displayField = 'url';\n\n\tpublic $validate = array(\n\t\t'url' => array( // TODO add extra validation to refuse multiple time the same url from the same org\n\t\t\t'url' => array(\n\t\t\t\t'rule' => array('url'),\n\t\t\t\t'message' => 'Please enter a valid base-url.',\n\t\t\t\t//'allowEmpty' => false,\n\t\t\t\t//'required' => false,\n\t\t\t\t//'last' => false, // Stop validation after this rule\n\t\t\t\t//'on' => 'create', // Limit validation to 'create' or 'update' operations\n\t\t\t)\n\t\t),\n\t\t'authkey' => array(\n\t\t\t'minlength' => array(\n\t\t\t\t'rule' => array('minlength', 40),\n\t\t\t\t'message' => 'A authkey of a minimum length of 40 is required.',\n\t\t\t\t'required' => true,\n\t\t\t),\n\t\t\t'valueNotEmpty' => array(\n\t\t\t\t'rule' => array('valueNotEmpty'),\n\t\t\t),\n\t\t),\n\t\t'org_id' => array(\n\t\t\t'numeric' => array(\n\t\t\t\t'rule' => array('valueIsID'),\n\t\t\t\t'allowEmpty' => false,\n\t\t\t\t'required' => true,\n\t\t\t),\n\t\t),\n\t\t'push' => array(\n\t\t\t'boolean' => array(\n\t\t\t\t'rule' => array('boolean'),\n\t\t\t\t//'message' => 'Your custom message here',\n\t\t\t\t'allowEmpty' => true,\n\t\t\t\t'required' => false,\n\t\t\t\t//'last' => false, // Stop validation after this rule\n\t\t\t\t//'on' => 'create', // Limit validation to 'create' or 'update' operations\n\t\t\t),\n\t\t),\n\t\t'pull' => array(\n\t\t\t'boolean' => array(\n\t\t\t\t'rule' => array('boolean'),\n\t\t\t\t//'message' => 'Your custom message here',\n\t\t\t\t'allowEmpty' => true,\n\t\t\t\t//'required' => false,\n\t\t\t\t//'last' => false, // Stop validation after this rule\n\t\t\t\t//'on' => 'create', // Limit validation to 'create' or 'update' operations\n\t\t\t),\n\t\t),\n\t\t'lastpushedid' => array(\n\t\t\t'numeric' => array(\n\t\t\t\t'rule' => array('numeric'),\n\t\t\t\t//'message' => 'Your custom message here',\n\t\t\t\t'allowEmpty' => true,\n\t\t\t\t'required' => false,\n\t\t\t\t//'last' => false, // Stop validation after this rule\n\t\t\t\t//'on' => 'create', // Limit validation to 'create' or 'update' operations\n\t\t\t),\n\t\t),\n\t\t'lastpulledid' => array(\n\t\t\t'numeric' => array(\n\t\t\t\t'rule' => array('numeric'),\n\t\t\t\t//'message' => 'Your custom message here',\n\t\t\t\t'allowEmpty' => true,\n\t\t\t\t'required' => false,\n\t\t\t\t//'last' => false, // Stop validation after this rule\n\t\t\t\t//'on' => 'create', // Limit validation to 'create' or 'update' operations\n\t\t\t),\n\t\t),\n\t);\n\n\tpublic $serverSettings = array(\n\t\t\t'MISP' => array(\n\t\t\t\t\t'branch' => 1,\n\t\t\t\t\t'baseurl' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'The base url of the application (in the format https://www.mymispinstance.com). Several features depend on this setting being correctly set to function.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => 'The currenty set baseurl does not match the URL through which you have accessed the page. Disregard this if you are accessing the page via an alternate URL (for example via IP address).',\n\t\t\t\t\t\t\t'test' => 'testBaseURL',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'live' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'Unless set to true, the instance will only be accessible by site admins.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testLive',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t),\n\t\t\t\t\t'enable_advanced_correlations' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'Enable some performance heavy correlations (currently CIDR correlation)',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'max_correlations_per_event' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Sets the maximum number of correlations that can be fetched with a single event. For extreme edge cases this can prevent memory issues. The default value is 5k.',\n\t\t\t\t\t\t\t'value' => 5000,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForNumeric',\n\t\t\t\t\t\t\t'type' => 'numeric',\n\t\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'maintenance_message' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The message that users will see if the instance is not live.',\n\t\t\t\t\t\t\t'value' => 'Great things are happening! MISP is undergoing maintenance, but will return shortly. You can contact the administration at $email.',\n\t\t\t\t\t\t\t'errorMessage' => 'If this is not set the default value will be used.',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'name' => array(\n\t\t\t\t\t\t\t'level' => 3,\n\t\t\t\t\t\t\t'description' => 'This setting is deprecated and can be safely removed.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'version' => array(\n\t\t\t\t\t\t\t'level' => 3,\n\t\t\t\t\t\t\t'description' => 'This setting is deprecated and can be safely removed.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'disable_cached_exports' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Cached exports can take up a considerable amount of space and can be disabled instance wide using this setting. Disabling the cached exports is not recommended as it\\'s a valuable feature, however, if your server is having free space issues it might make sense to take this step.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'null' => true,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testDisableCache',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'afterHook' => 'disableCacheAfterHook',\n\t\t\t\t\t),\n\t\t\t\t\t'header' => array(\n\t\t\t\t\t\t\t'level' => 3,\n\t\t\t\t\t\t\t'description' => 'This setting is deprecated and can be safely removed.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'footermidleft' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Footer text prepending the \"Powered by MISP\" text.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'footermidright' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Footer text following the \"Powered by MISP\" text.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'footerpart1' => array(\n\t\t\t\t\t\t\t'level' => 3,\n\t\t\t\t\t\t\t'description' => 'This setting is deprecated and can be safely removed.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'footerpart2' => array(\n\t\t\t\t\t\t\t'level' => 3,\n\t\t\t\t\t\t\t'description' => 'This setting is deprecated and can be safely removed.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'footer' => array(\n\t\t\t\t\t\t\t'level' => 3,\n\t\t\t\t\t\t\t'description' => 'This setting is deprecated and can be safely removed.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'footerversion' => array(\n\t\t\t\t\t\t\t'level' => 3,\n\t\t\t\t\t\t\t'description' => 'This setting is deprecated and can be safely removed.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'footer_logo' => array(\n\t\t\t\t\t\t\t'level' => 2 ,\n\t\t\t\t\t\t\t'description' => 'If set, this setting allows you to display a logo on the right side of the footer. Upload it as a custom image in the file management tool.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForCustomImage',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'home_logo' => array(\n\t\t\t\t\t\t\t'level' => 2 ,\n\t\t\t\t\t\t\t'description' => 'If set, this setting allows you to display a logo as the home icon. Upload it as a custom image in the file management tool.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForCustomImage',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'main_logo' => array(\n\t\t\t\t\t\t\t'level' => 2 ,\n\t\t\t\t\t\t\t'description' => 'If set, the image specified here will replace the main MISP logo on the login screen. Upload it as a custom image in the file management tool.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForCustomImage',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'org' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'The organisation tag of the hosting organisation. This is used in the e-mail subjects.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'host_org_id' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'The hosting organisation of this instance. If this is not selected then replication instances cannot be added.',\n\t\t\t\t\t\t\t'value' => '0',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testLocalOrg',\n\t\t\t\t\t\t\t'type' => 'numeric',\n\t\t\t\t\t\t\t'optionsSource' => 'LocalOrgs',\n\t\t\t\t\t),\n\t\t\t\t\t'uuid' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'The MISP instance UUID. This UUID is used to identify this instance.',\n\t\t\t\t\t\t\t'value' => '0',\n\t\t\t\t\t\t\t'errorMessage' => 'No valid UUID set',\n\t\t\t\t\t\t\t'test' => 'testUuid',\n\t\t\t\t\t\t\t'type' => 'string'\n\t\t\t\t\t),\n\t\t\t\t\t'logo' => array(\n\t\t\t\t\t\t\t'level' => 3,\n\t\t\t\t\t\t\t'description' => 'This setting is deprecated and can be safely removed.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'showorg' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'Setting this setting to \\'false\\' will hide all organisation names / logos.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t),\n\t\t\t\t\t'threatlevel_in_email_subject' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Put the event threat level in the notification E-mail subject.',\n\t\t\t\t\t\t\t'value' => true,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t),\n\t\t\t\t\t'email_subject_TLP_string' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'This is the TLP string for e-mails when email_subject_tag is not found.',\n\t\t\t\t\t\t\t'value' => 'TLP Amber',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t),\n\t\t\t\t\t'email_subject_tag' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => \"If this tag is set on an event it's value will be sent in the E-mail subject. If the tag is not set the email_subject_TLP_string will be used.\",\n\t\t\t\t\t\t\t'value' => 'tlp',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t),\n\t\t\t\t\t'email_subject_include_tag_name' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Include in name of the email_subject_tag in the subject. When false only the tag value is used.',\n\t\t\t\t\t\t\t'value' => true,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t),\n\t\t\t\t\t'taxii_sync' => array(\n\t\t\t\t\t\t\t'level' => 3,\n\t\t\t\t\t\t\t'description' => 'This setting is deprecated and can be safely removed.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'taxii_client_path' => array(\n\t\t\t\t\t\t\t'level' => 3,\n\t\t\t\t\t\t\t'description' => 'This setting is deprecated and can be safely removed.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'background_jobs' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Enables the use of MISP\\'s background processing.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t),\n\t\t\t\t\t'attachments_dir' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Directory where attachments are stored. MISP will NOT migrate the existing data if you change this setting. The only safe way to change this setting is in config.php, when MISP is not running, and after having moved/copied the existing data to the new location. This directory must already exist and be writable and readable by the MISP application.',\n\t\t\t\t\t\t\t'value' =>  'app/files', # GUI display purpose only. Default value defined in func getDefaultAttachments_dir()\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'null' => false,\n\t\t\t\t\t\t\t'test' => 'testForWritableDir',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'cached_attachments' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Allow the XML caches to include the encoded attachments.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t),\n\t\t\t\t\t'email' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'The e-mail address that MISP should use for all notifications',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'disable_emailing' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'You can disable all e-mailing using this setting. When enabled, no outgoing e-mails will be sent by MISP.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'null' => true,\n\t\t\t\t\t\t\t'test' => 'testDisableEmail',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t),\n\t\t\t\t\t'contact' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'The e-mail address that MISP should include as a contact address for the instance\\'s support team.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'dns' => array(\n\t\t\t\t\t\t\t'level' => 3,\n\t\t\t\t\t\t\t'description' => 'This setting is deprecated and can be safely removed.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'cveurl' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Turn Vulnerability type attributes into links linking to the provided CVE lookup',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'disablerestalert' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'This setting controls whether notification e-mails will be sent when an event is created via the REST interface. It might be a good idea to disable this setting when first setting up a link to another instance to avoid spamming your users during the initial pull. Quick recap: True = Emails are NOT sent, False = Emails are sent on events published via sync / REST.',\n\t\t\t\t\t\t\t'value' => true,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t),\n\t\t\t\t\t'extended_alert_subject' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'enabling this flag will allow the event description to be transmitted in the alert e-mail\\'s subject. Be aware that this is not encrypted by PGP, so only enable it if you accept that part of the event description will be sent out in clear-text.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'default_event_distribution' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'The default distribution setting for events (0-3).',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'options' => array('0' => 'Your organisation only', '1' => 'This community only', '2' => 'Connected communities', '3' => 'All communities'),\n\t\t\t\t\t),\n\t\t\t\t\t'default_attribute_distribution' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'The default distribution setting for attributes, set it to \\'event\\' if you would like the attributes to default to the event distribution level. (0-3 or \"event\")',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'options' => array('0' => 'Your organisation only', '1' => 'This community only', '2' => 'Connected communities', '3' => 'All communities', 'event' => 'Inherit from event'),\n\t\t\t\t\t),\n\t\t\t\t\t'default_event_threat_level' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'The default threat level setting when creating events.',\n\t\t\t\t\t\t\t'value' => '4',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'options' => array('1' => 'High', '2' => 'Medium', '3' => 'Low', '4' => 'undefined'),\n\t\t\t\t\t),\n\t\t\t\t\t'tagging' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Enable the tagging feature of MISP. This is highly recommended.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t),\n\t\t\t\t\t'full_tags_on_event_index' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' =>'Show the full tag names on the event index.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'options' => array(0 => 'Minimal tags', 1 => 'Full tags', 2 => 'Shortened tags'),\n\t\t\t\t\t),\n\t\t\t\t\t'welcome_text_top' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Used on the login page, before the MISP logo',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'welcome_text_bottom' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Used on the login page, after the MISP logo',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'welcome_logo' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Used on the login page, to the left of the MISP logo, upload it as a custom image in the file management tool.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForCustomImage',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'welcome_logo2' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Used on the login page, to the right of the MISP logo, upload it as a custom image in the file management tool.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForCustomImage',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'title_text' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'Used in the page title, after the name of the page',\n\t\t\t\t\t\t'value' => 'MISP',\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'take_ownership_xml_import' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Allows users to take ownership of an event uploaded via the \"Add MISP XML\" button. This allows spoofing the creator of a manually imported event, also breaking possibly breaking the original intended releasability. Synchronising with an instance that has a different creator for the same event can lead to unwanted consequences.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t),\n\t\t\t\t\t'terms_download' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Choose whether the terms and conditions should be displayed inline (false) or offered as a download (true)',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'terms_file' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The filename of the terms and conditions file. Make sure that the file is located in your MISP/app/files/terms directory',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForTermsFile',\n\t\t\t\t\t\t\t'type' => 'string'\n\t\t\t\t\t),\n\t\t\t\t\t'showorgalternate' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'True enables the alternate org fields for the event index (source org and member org) instead of the traditional way of showing only an org field. This allows users to see if an event was uploaded by a member organisation on their MISP instance, or if it originated on an interconnected instance.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'unpublishedprivate' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'True will deny access to unpublished events to users outside the organization of the submitter except site admins.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'newUserText' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'bigField' => true,\n\t\t\t\t\t\t\t'description' => 'The message sent to the user after account creation (has to be sent manually from the administration interface). Use \\\\n for line-breaks. The following variables will be automatically replaced in the text: $password = a new temporary password that MISP generates, $username = the user\\'s e-mail address, $misp = the url of this instance, $org = the organisation that the instance belongs to, as set in MISP.org, $contact = the e-mail address used to contact the support team, as set in MISP.contact. For example, \"the password for $username is $password\" would appear to a user with the e-mail address user@misp.org as \"the password for user@misp.org is hNamJae81\".',\n\t\t\t\t\t\t\t'value' => 'Dear new MISP user,\\n\\nWe would hereby like to welcome you to the $org MISP community.\\n\\n Use the credentials below to log into MISP at $misp, where you will be prompted to manually change your password to something of your own choice.\\n\\nUsername: $username\\nPassword: $password\\n\\nIf you have any questions, don\\'t hesitate to contact us at: $contact.\\n\\nBest regards,\\nYour $org MISP support team',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testPasswordResetText',\n\t\t\t\t\t\t\t'type' => 'string'\n\t\t\t\t\t),\n\t\t\t\t\t'passwordResetText' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'bigField' => true,\n\t\t\t\t\t\t\t'description' => 'The message sent to the users when a password reset is triggered. Use \\\\n for line-breaks. The following variables will be automatically replaced in the text: $password = a new temporary password that MISP generates, $username = the user\\'s e-mail address, $misp = the url of this instance, $contact = the e-mail address used to contact the support team, as set in MISP.contact. For example, \"the password for $username is $password\" would appear to a user with the e-mail address user@misp.org as \"the password for user@misp.org is hNamJae81\".',\n\t\t\t\t\t\t\t'value' => 'Dear MISP user,\\n\\nA password reset has been triggered for your account. Use the below provided temporary password to log into MISP at $misp, where you will be prompted to manually change your password to something of your own choice.\\n\\nUsername: $username\\nYour temporary password: $password\\n\\nIf you have any questions, don\\'t hesitate to contact us at: $contact.\\n\\nBest regards,\\nYour $org MISP support team',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testPasswordResetText',\n\t\t\t\t\t\t\t'type' => 'string'\n\t\t\t\t\t),\n\t\t\t\t\t'enableEventBlacklisting' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Since version 2.3.107 you can start blacklisting event UUIDs to prevent them from being pushed to your instance. This functionality will also happen silently whenever an event is deleted, preventing a deleted event from being pushed back from another instance.',\n\t\t\t\t\t\t\t'value' => true,\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'test' => 'testBool'\n\t\t\t\t\t),\n\t\t\t\t\t'enableOrgBlacklisting' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Blacklisting organisation UUIDs to prevent the creation of any event created by the blacklisted organisation.',\n\t\t\t\t\t\t\t'value' => true,\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'test' => 'testBool'\n\t\t\t\t\t),\n\t\t\t\t\t'log_client_ip' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'If enabled, all log entries will include the IP address of the user.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'beforeHook' => 'ipLogBeforeHook'\n\t\t\t\t\t),\n\t\t\t\t\t'log_auth' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'If enabled, MISP will log all successful authentications using API keys. The requested URLs are also logged.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t),\n\t\t\t\t\t'delegation' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'This feature allows users to created org only events and ask another organisation to take owenership of the event. This allows organisations to remain anonymous by asking a partner to publish an event for them.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'showCorrelationsOnIndex' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'When enabled, the number of correlations visible to the currently logged in user will be visible on the event index UI. This comes at a performance cost but can be very useful to see correlating events at a glance.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'showProposalsCountOnIndex' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'When enabled, the number of proposals for the events are shown on the index.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'showSightingsCountOnIndex' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'When enabled, the aggregate number of attribute sightings within the event becomes visible to the currently logged in user on the event index UI.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'showDiscussionsCountOnIndex' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'When enabled, the aggregate number of discussion posts for the event becomes visible to the currently logged in user on the event index UI.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'disableUserSelfManagement' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'When enabled only Org and Site admins can edit a user\\'s profile.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => false,\n\n\t\t\t\t\t),\n\t\t\t\t\t'block_event_alert' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Enable this setting to start blocking alert e-mails for events with a certain tag. Define the tag in MISP.block_event_alert_tag.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => false,\n\t\t\t\t\t),\n\t\t\t\t\t'block_event_alert_tag' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'If the MISP.block_event_alert setting is set, alert e-mails for events tagged with the tag defined by this setting will be blocked.',\n\t\t\t\t\t\t\t'value' => 'no-alerts=\"true\"',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'null' => false,\n\t\t\t\t\t),\n\t\t\t\t\t'block_old_event_alert' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Enable this setting to start blocking alert e-mails for old events. The exact timing of what constitutes an old event is defined by MISP.block_old_event_alert_age.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => false,\n\t\t\t\t\t),\n\t\t\t\t\t'block_old_event_alert_age' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'If the MISP.block_old_event_alert setting is set, this setting will control how old an event can be for it to be alerted on. The \"Date\" field of the event is used. Expected format: integer, in days',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForNumeric',\n\t\t\t\t\t\t\t'type' => 'numeric',\n\t\t\t\t\t\t\t'null' => false,\n\t\t\t\t\t),\n\t\t\t\t\t'rh_shell_fix' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'If you are running CentOS or RHEL using SCL and are having issues with the Background workers not responding to start/stop/restarts via the worker interface, enable this setting. This will pre-pend the shell execution commands with the default path to rh-php56 (/opt/rh/rh-php56/root/usr/bin:/opt/rh/rh-php56/root/usr/sbin).',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => true,\n\t\t\t\t\t),\n\t\t\t\t\t'rh_shell_fix_path' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'If you have rh_shell_fix enabled, the default PATH for rh-php56 is added (/opt/rh/rh-php56/root/usr/bin:/opt/rh/rh-php56/root/usr/sbin). If you prefer to use a different path, you can set it here.',\n\t\t\t\t\t\t\t'value' => '/opt/rh/rh-php56/root/usr/bin:/opt/rh/rh-php56/root/usr/sbin',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForPath',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'null' => true,\n\t\t\t\t\t),\n\t\t\t\t\t'tmpdir' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Please indicate the temp directory you wish to use for certain functionalities in MISP. By default this is set to /tmp and will be used among others to store certain temporary files extracted from imports during the import process.',\n\t\t\t\t\t\t\t'value' => '/tmp',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForPath',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'null' => true,\n\t\t\t\t\t),\n\t\t\t\t\t'custom_css' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'If you would like to customise the css, simply drop a css file in the /var/www/MISP/webroot/css directory and enter the name here.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForStyleFile',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'null' => true,\n\t\t\t\t\t),\n\t\t\t\t\t'proposals_block_attributes' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'Enable this setting to allow blocking attributes from to_ids sensitive exports if a proposal has been made to it to remove the IDS flag or to remove the attribute altogether. This is a powerful tool to deal with false-positives efficiently.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => false,\n\t\t\t\t\t),\n\t\t\t\t\t'incoming_tags_disabled_by_default' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Enable this settings if new tags synced / added via incoming events from any source should not be selectable by users by default.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => false\n\t\t\t\t\t),\n\t\t\t\t\t'completely_disable_correlation' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => '*WARNING* This setting will completely disable the correlation on this instance and remove any existing saved correlations. Enabling this will trigger a full recorrelation of all data which is an extremely long and costly procedure. Only enable this if you know what you\\'re doing.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBoolFalse',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => true,\n\t\t\t\t\t\t\t'afterHook' => 'correlationAfterHook',\n\t\t\t\t\t),\n\t\t\t\t\t'allow_disabling_correlation' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => '*WARNING* This setting will give event creators the possibility to disable the correlation of individual events / attributes that they have created.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBoolFalse',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'redis_host' => array(\n\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t'description' => 'The host running the redis server to be used for generic MISP tasks such as caching. This is not to be confused by the redis server used by the background processing.',\n\t\t\t\t\t\t'value' => '127.0.0.1',\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t'type' => 'string'\n\t\t\t\t\t),\n\t\t\t\t\t'redis_port' => array(\n\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t'description' => 'The port used by the redis server to be used for generic MISP tasks such as caching. This is not to be confused by the redis server used by the background processing.',\n\t\t\t\t\t\t'value' => 6379,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testForNumeric',\n\t\t\t\t\t\t'type' => 'numeric'\n\t\t\t\t\t),\n\t\t\t\t\t'redis_database' => array(\n\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t'description' => 'The database on the redis server to be used for generic MISP tasks. If you run more than one MISP instance, please make sure to use a different database on each instance.',\n\t\t\t\t\t\t'value' => 13,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testForNumeric',\n\t\t\t\t\t\t'type' => 'numeric'\n\t\t\t\t\t),\n\t\t\t\t\t'redis_password' => array(\n\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t'description' => 'The password on the redis server (if any) to be used for generic MISP tasks.',\n\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => null,\n\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t'redacted' => true\n\t\t\t\t\t),\n\t\t\t\t\t'event_view_filter_fields' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'Specify which fields to filter on when you search on the event view. Default values are : \"id, uuid, value, comment, type, category, Tag.name\"',\n\t\t\t\t\t\t'value' => 'id, uuid, value, comment, type, category, Tag.name',\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => null,\n\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t)\n\t\t\t),\n\t\t\t'GnuPG' => array(\n\t\t\t\t\t'branch' => 1,\n\t\t\t\t\t'binary' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The location of the GPG executable. If you would like to use a different gpg executable than /usr/bin/gpg, you can set it here. If the default is fine, just keep the setting suggested by MISP.',\n\t\t\t\t\t\t\t'value' => '/usr/bin/gpg',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForGPGBinary',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'onlyencrypted' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'Allow (false) unencrypted e-mails to be sent to users that don\\'t have a PGP key.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t),\n\t\t\t\t\t'bodyonlyencrypted' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Allow (false) the body of unencrypted e-mails to contain details about the event.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n                    ),\n                    'sign' => array(\n                            'level' => 2,\n                            'description' => 'Enable the signing of GPG emails. By default, GPG emails are signed',\n                            'value' => 'true',\n                            'errorMessage' => '',\n                            'test' => 'testBool',\n                            'type' => 'boolean',\n                    ),\n\t\t\t\t\t'email' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'The e-mail address that the instance\\'s PGP key is tied to.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'password' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'The password (if it is set) of the PGP key of the instance.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'redacted' => true\n\t\t\t\t\t),\n\t\t\t\t\t'homedir' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'The location of the GPG homedir.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t)\n\t\t\t),\n\t\t\t'SMIME' => array(\n\t\t\t\t\t'branch' => 1,\n\t\t\t\t\t'enabled' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Enable SMIME encryption. The encryption posture of the GnuPG.onlyencrypted and GnuPG.bodyonlyencrypted settings are inherited if SMIME is enabled.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t),\n\t\t\t\t\t'email' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The e-mail address that the instance\\'s SMIME key is tied to.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'cert_public_sign' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The location of the public half of the signing certificate.',\n\t\t\t\t\t\t\t'value' => '/var/www/MISP/.smime/email@address.com.pem',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'key_sign' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The location of the private half of the signing certificate.',\n\t\t\t\t\t\t\t'value' => '/var/www/MISP/.smime/email@address.com.key',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'password' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The password (if it is set) of the SMIME key of the instance.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'redacted' => true\n\t\t\t\t\t),\n\t\t\t),\n\t\t\t'Proxy' => array(\n\t\t\t\t\t'branch' => 1,\n\t\t\t\t\t'host' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The hostname of an HTTP proxy for outgoing sync requests. Leave empty to not use a proxy.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'port' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The TCP port for the HTTP proxy.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForNumeric',\n\t\t\t\t\t\t\t'type' => 'numeric',\n\t\t\t\t\t),\n\t\t\t\t\t'method' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The authentication method for the HTTP proxy. Currently supported are Basic or Digest. Leave empty for no proxy authentication.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'user' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The authentication username for the HTTP proxy.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'password' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The authentication password for the HTTP proxy.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t),\n\t\t\t'Security' => array(\n\t\t\t\t\t'branch' => 1,\n\t\t\t\t\t'salt' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'The salt used for the hashed passwords. You cannot reset this from the GUI, only manually from the settings.php file. Keep in mind, this will invalidate all passwords in the database.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testSalt',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'editable' => false,\n\t\t\t\t\t),\n\t\t\t\t\t'syslog' => array(\n\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t'description' => 'Enable this setting to pass all audit log entries directly to syslog. Keep in mind, this is verbose and will include user, organisation, event data.',\n\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'password_policy_length' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Password length requirement. If it is not set or it is set to 0, then the default value is assumed (12).',\n\t\t\t\t\t\t\t'value' => '12',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testPasswordLength',\n\t\t\t\t\t\t\t'type' => 'numeric',\n\t\t\t\t\t),\n\t\t\t\t\t'password_policy_complexity' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Password complexity requirement. Leave it empty for the default setting (3 out of 4, with either a digit or a special char) or enter your own regex. Keep in mind that the length is checked in another key. Default (simple 3 out of 4 or minimum 16 characters): /^((?=.*\\d)|(?=.*\\W+))(?![\\n])(?=.*[A-Z])(?=.*[a-z]).*$|.{16,}/',\n\t\t\t\t\t\t\t'value' => '/^((?=.*\\d)|(?=.*\\W+))(?![\\n])(?=.*[A-Z])(?=.*[a-z]).*$|.{16,}/',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testPasswordRegex',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'require_password_confirmation' => array(\n\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t'description' => 'Enabling this setting will require users to submit their current password on any edits to their profile (including a triggered password change). For administrators, the confirmation will be required when changing the profile of any user. Could potentially mitigate an attacker trying to change a compromised user\\'s password in order to establish persistance, however, enabling this feature will be highly annoying to users.',\n\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'sanitise_attribute_on_delete' => array(\n\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t'description' => 'Enabling this setting will sanitise the contents of an attribute on a soft delete',\n\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'hide_organisation_index_from_users' => array(\n\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t'description' => 'Enabling this setting will block the organisation index from being visible to anyone besides site administrators on the current instance. Keep in mind that users can still see organisations that produce data via events, proposals, event history log entries, etc.',\n\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t'null' => true\n\t\t\t\t\t)\n\t\t\t),\n\t\t\t'SecureAuth' => array(\n\t\t\t\t\t'branch' => 1,\n\t\t\t\t\t'amount' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'The number of tries a user can try to login and fail before the bruteforce protection kicks in.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForNumeric',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'expire' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'The duration (in seconds) of how long the user will be locked out when the allowed number of login attempts are exhausted.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForNumeric',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t),\n\t\t\t'Session' => array(\n\t\t\t\t\t'branch' => 1,\n\t\t\t\t\t'autoRegenerate' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Set to true to automatically regenerate sessions on activity. (Recommended)',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t),\n\t\t\t\t\t'defaults' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'The session type used by MISP. The default setting is php, which will use the session settings configured in php.ini for the session data (supported options: php, database). The recommended option is php and setting your PHP up to use redis sessions via your php.ini. Just add \\'session.save_handler = redis\\' and \"session.save_path = \\'tcp://localhost:6379\\'\" (replace the latter with your redis connection) to ',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForSessionDefaults',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'options' => array('php' => 'php', 'database' => 'database', 'cake' => 'cake', 'cache' => 'cache'),\n\t\t\t\t\t),\n\t\t\t\t\t'timeout' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'The timeout duration of sessions (in MINUTES). Keep in mind that autoregenerate can be used to extend the session on user activity.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForNumeric',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t)\n\t\t\t),\n\t\t\t'Plugin' => array(\n\t\t\t\t\t'branch' => 1,\n\t\t\t\t\t'RPZ_policy' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'The default policy action for the values added to the RPZ.',\n\t\t\t\t\t\t'value' => 0,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testForRPZBehaviour',\n\t\t\t\t\t\t'type' => 'numeric',\n\t\t\t\t\t\t'options' => array(0 => 'DROP', 1 => 'NXDOMAIN', 2 => 'NODATA', 3 => 'walled-garden'),\n\t\t\t\t\t),\n\t\t\t\t\t'RPZ_walled_garden' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'The default walled garden used by the RPZ export if the walled garden setting is picked for the export.',\n\t\t\t\t\t\t'value' => '127.0.0.1',\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'RPZ_serial' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The serial in the SOA portion of the zone file. (numeric, best practice is yyyymmddrr where rr is the two digit sub-revision of the file. $date will automatically get converted to the current yyyymmdd, so $date00 is a valid setting).',\n\t\t\t\t\t\t\t'value' => '$date00',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForRPZSerial',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'RPZ_refresh' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The refresh specified in the SOA portion of the zone file. (in seconds, or shorthand duration such as 15m)',\n\t\t\t\t\t\t\t'value' => '2h',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForRPZDuration',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'RPZ_retry' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The retry specified in the SOA portion of the zone file. (in seconds, or shorthand duration such as 15m)',\n\t\t\t\t\t\t\t'value' => '30m',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForRPZDuration',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'RPZ_expiry' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The expiry specified in the SOA portion of the zone file. (in seconds, or shorthand duration such as 15m)',\n\t\t\t\t\t\t\t'value' => '30d',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForRPZDuration',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'RPZ_minimum_ttl' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The minimum TTL specified in the SOA portion of the zone file. (in seconds, or shorthand duration such as 15m)',\n\t\t\t\t\t\t\t'value' => '1h',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForRPZDuration',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'RPZ_ttl' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The TTL of the zone file. (in seconds, or shorthand duration such as 15m)',\n\t\t\t\t\t\t\t'value' => '1w',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForRPZDuration',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'RPZ_ns' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => '',\n\t\t\t\t\t\t\t'value' => 'localhost.',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'RPZ_ns_alt' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'Alternate nameserver',\n\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t),\n\t\t\t\t\t'RPZ_email' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'The e-mail address specified in the SOA portion of the zone file.',\n\t\t\t\t\t\t'value' => 'root.localhost',\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'ZeroMQ_enable' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'Enables or disables the pub/sub feature of MISP. Make sure that you install the requirements for the plugin to work. Refer to the installation instructions for more information.',\n\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t'afterHook' => 'zmqAfterHook',\n\t\t\t\t\t),\n\t\t\t\t\t'ZeroMQ_port' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'The port that the pub/sub feature will use.',\n\t\t\t\t\t\t'value' => 50000,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testForZMQPortNumber',\n\t\t\t\t\t\t'type' => 'numeric',\n\t\t\t\t\t\t'afterHook' => 'zmqAfterHook',\n\t\t\t\t\t),\n\t\t\t\t\t'ZeroMQ_redis_host' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'Location of the Redis db used by MISP and the Python PUB script to queue data to be published.',\n\t\t\t\t\t\t'value' => 'localhost',\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t'afterHook' => 'zmqAfterHook',\n\t\t\t\t\t),\n\t\t\t\t\t'ZeroMQ_redis_port' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'The port that Redis is listening on.',\n\t\t\t\t\t\t'value' => 6379,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testForPortNumber',\n\t\t\t\t\t\t'type' => 'numeric',\n\t\t\t\t\t\t'afterHook' => 'zmqAfterHook',\n\t\t\t\t\t),\n\t\t\t\t\t'ZeroMQ_redis_password' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'The password, if set for Redis.',\n\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t'afterHook' => 'zmqAfterHook',\n\t\t\t\t\t),\n\t\t\t\t\t'ZeroMQ_redis_database' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'The database to be used for queuing messages for the pub/sub functionality.',\n\t\t\t\t\t\t'value' => '1',\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t'afterHook' => 'zmqAfterHook',\n\t\t\t\t\t),\n\t\t\t\t\t'ZeroMQ_redis_namespace' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'The namespace to be used for queuing messages for the pub/sub functionality.',\n\t\t\t\t\t\t'value' => 'mispq',\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t'afterHook' => 'zmqAfterHook',\n\t\t\t\t\t),\n\t\t\t\t\t'ZeroMQ_event_notifications_enable' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'Enables or disables the publishing of any event creations/edits/deletions.',\n\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'ZeroMQ_object_notifications_enable' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'Enables or disables the publishing of any object creations/edits/deletions.',\n\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'ZeroMQ_object_reference_notifications_enable' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'Enables or disables the publishing of any object reference creations/deletions.',\n\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'ZeroMQ_attribute_notifications_enable' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'Enables or disables the publishing of any attribute creations/edits/soft deletions.',\n\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'ZeroMQ_tag_notifications_enable' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'Enables or disables the publishing of any tag creations/edits/deletions as well as tags being attached to / detached from various MISP elements.',\n\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'ZeroMQ_sighting_notifications_enable' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'Enables or disables the publishing of new sightings to the ZMQ pubsub feed.',\n\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'ZeroMQ_user_notifications_enable' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'Enables or disables the publishing of new/modified users to the ZMQ pubsub feed.',\n\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'ZeroMQ_organisation_notifications_enable' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'Enables or disables the publishing of new/modified organisations to the ZMQ pubsub feed.',\n\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'ZeroMQ_audit_notifications_enable' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'Enables or disables the publishing of log entries to the ZMQ pubsub feed. Keep in mind, this can get pretty verbose depending on your logging settings.',\n\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'Sightings_policy' => array(\n\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t'description' => 'This setting defines who will have access to seeing the reported sightings. The default setting is the event owner alone (in addition to everyone seeing their own contribution) with the other options being Sighting reporters (meaning the event owner and anyone that provided sighting data about the event) and Everyone (meaning anyone that has access to seeing the event / attribute).',\n\t\t\t\t\t\t'value' => 0,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testForSightingVisibility',\n\t\t\t\t\t\t'type' => 'numeric',\n\t\t\t\t\t\t'options' => array(0 => 'Event Owner', 1 => 'Sighting reporters', 2 => 'Everyone'),\n\t\t\t\t\t),\n\t\t\t\t\t'Sightings_anonymise' => array(\n\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t'description' => 'Enabling the anonymisation of sightings will simply aggregate all sightings instead of showing the organisations that have reported a sighting. Users will be able to tell the number of sightings their organisation has submitted and the number of sightings for other organisations',\n\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t),\n\t\t\t\t\t'Sightings_range' => array(\n\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t'description' => 'Set the range in which sightings will be taken into account when generating graphs. For example a sighting with a sighted_date of 7 years ago might not be relevant anymore. Setting given in number of days, default is 365 days',\n\t\t\t\t\t\t'value' => 365,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testForNumeric',\n\t\t\t\t\t\t'type' => 'numeric'\n\t\t\t\t\t),\n\t\t\t\t\t'CustomAuth_enable' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Enable this functionality if you would like to handle the authentication via an external tool and authenticate with MISP using a custom header.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => true,\n\t\t\t\t\t\t\t'beforeHook' => 'customAuthBeforeHook'\n\t\t\t\t\t),\n\t\t\t\t\t'CustomAuth_header' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Set the header that MISP should look for here. If left empty it will default to the Authorization header.',\n\t\t\t\t\t\t\t'value' => 'Authorization',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'CustomAuth_use_header_namespace' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Use a header namespace for the auth header - default setting is enabled',\n\t\t\t\t\t\t\t'value' => true,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'CustomAuth_header_namespace' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The default header namespace for the auth header - default setting is HTTP_',\n\t\t\t\t\t\t\t'value' => 'HTTP_',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'CustomAuth_required' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'If this setting is enabled then the only way to authenticate will be using the custom header. Altnertatively you can run in mixed mode that will log users in via the header if found, otherwise users will be redirected to the normal login page.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'CustomAuth_only_allow_source' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'If you are using an external tool to authenticate with MISP and would like to only allow the tool\\'s url as a valid point of entry then set this field. ',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'CustomAuth_name' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The name of the authentication method, this is cosmetic only and will be shown on the user creation page and logs.',\n\t\t\t\t\t\t\t'value' => 'External authentication',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'CustomAuth_disable_logout' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Disable the logout button for users authenticate with the external auth mechanism.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'Enrichment_services_enable' => array(\n\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t'description' => 'Enable/disable the enrichment services',\n\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'Enrichment_timeout' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Set a timeout for the enrichment services',\n\t\t\t\t\t\t\t'value' => 10,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'numeric'\n\t\t\t\t\t),\n\t\t\t\t\t'Import_services_enable' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'Enable/disable the import services',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'Import_timeout' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Set a timeout for the import services',\n\t\t\t\t\t\t\t'value' => 10,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'numeric'\n\t\t\t\t\t),\n\t\t\t\t\t'Import_services_url' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'The url used to access the import services. By default, it is accessible at http://127.0.0.1:6666',\n\t\t\t\t\t\t\t'value' => 'http://127.0.0.1',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string'\n\t\t\t\t\t),\n\t\t\t\t\t'Import_services_port' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'The port used to access the import services. By default, it is accessible at 127.0.0.1:6666',\n\t\t\t\t\t\t\t'value' => '6666',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForPortNumber',\n\t\t\t\t\t\t\t'type' => 'numeric'\n\t\t\t\t\t),\n\t\t\t\t\t'Export_services_url' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'The url used to access the export services. By default, it is accessible at http://127.0.0.1:6666',\n\t\t\t\t\t\t\t'value' => 'http://127.0.0.1',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string'\n\t\t\t\t\t),\n\t\t\t\t\t'Export_services_port' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'The port used to access the export services. By default, it is accessible at 127.0.0.1:6666',\n\t\t\t\t\t\t\t'value' => '6666',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForPortNumber',\n\t\t\t\t\t\t\t'type' => 'numeric'\n\t\t\t\t\t),\n\t\t\t\t\t'Export_services_enable' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'Enable/disable the export services',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'Export_timeout' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Set a timeout for the export services',\n\t\t\t\t\t\t\t'value' => 10,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'numeric'\n\t\t\t\t\t),\n\t\t\t\t\t'Enrichment_hover_enable' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'Enable/disable the hover over information retrieved from the enrichment modules',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'Enrichment_hover_timeout' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Set a timeout for the hover services',\n\t\t\t\t\t\t\t'value' => 5,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'numeric'\n\t\t\t\t\t),\n\t\t\t\t\t'Enrichment_services_url' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'The url used to access the enrichment services. By default, it is accessible at http://127.0.0.1:6666',\n\t\t\t\t\t\t\t'value' => 'http://127.0.0.1',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string'\n\t\t\t\t\t),\n\t\t\t\t\t'Enrichment_services_port' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'The port used to access the enrichment services. By default, it is accessible at 127.0.0.1:6666',\n\t\t\t\t\t\t\t'value' => '6666',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForPortNumber',\n\t\t\t\t\t\t\t'type' => 'numeric'\n\t\t\t\t\t),\n\t\t\t\t\t'Cortex_services_url' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'The url used to access Cortex. By default, it is accessible at http://cortex-url',\n\t\t\t\t\t\t\t'value' => 'http://127.0.0.1',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string'\n\t\t\t\t\t),\n\t\t\t\t\t'Cortex_services_port' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'The port used to access Cortex. By default, this is port 9000',\n\t\t\t\t\t\t\t'value' => '9000',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForPortNumber',\n\t\t\t\t\t\t\t'type' => 'numeric'\n\t\t\t\t\t),\n\t\t\t\t\t'Cortex_services_enable' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'Enable/disable the import services',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'Cortex_timeout' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Set a timeout for the import services',\n\t\t\t\t\t\t\t'value' => 120,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'numeric'\n\t\t\t\t\t),\n\t\t\t\t\t'CustomAuth_custom_password_reset' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Provide your custom authentication users with an external URL to the authentication system to reset their passwords.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'CustomAuth_custom_logout' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Provide a custom logout URL for your users that will log them out using the authentication system you use.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'null' => true\n\t\t\t\t\t)\n\t\t\t),\n\t\t\t'debug' => array(\n\t\t\t\t\t'level' => 0,\n\t\t\t\t\t'description' => 'The debug level of the instance, always use 0 for production instances.',\n\t\t\t\t\t'value' => '',\n\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t'test' => 'testDebug',\n\t\t\t\t\t'type' => 'numeric',\n\t\t\t\t\t'options' => array(0 => 'Debug off', 1 => 'Debug on', 2 => 'Debug + SQL dump'),\n\t\t\t),\n\t\t\t'site_admin_debug' => array(\n\t\t\t\t\t'level' => 0,\n\t\t\t\t\t'description' => 'The debug level of the instance for site admins. This feature allows site admins to run debug mode on a live instance without exposing it to other users. The most verbose option of debug and site_admin_debug is used for site admins.',\n\t\t\t\t\t'value' => '',\n\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t'test' => 'testDebugAdmin',\n\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t'null' => true\n\t\t\t),\n\t);\n\n\tprivate $__settingTabMergeRules = array(\n\t\t\t'GnuPG' => 'Encryption',\n\t\t\t'SMIME' => 'Encryption',\n\t\t\t'misc' => 'Security',\n\t\t\t'Security' => 'Security',\n\t\t\t'Session' => 'Security'\n\t);\n\n\tpublic $validEventIndexFilters = array('searchall', 'searchpublished', 'searchorg', 'searchtag', 'searcheventid', 'searchdate', 'searcheventinfo', 'searchthreatlevel', 'searchdistribution', 'searchanalysis', 'searchattribute');\n\n\tpublic function isOwnedByOrg($serverid, $org) {\n\t\treturn $this->field('id', array('id' => $serverid, 'org' => $org)) === $serverid;\n\t}\n\n\tpublic function beforeSave($options = array()) {\n\t\t$this->data['Server']['url'] = rtrim($this->data['Server']['url'], '/');\n\t\treturn true;\n\t}\n\n\tpublic function pull($user, $id = null, $technique=false, $server, $jobId = false, $percent = 100, $current = 0) {\n\t\tif ($jobId) {\n\t\t\t$job = ClassRegistry::init('Job');\n\t\t\t$job->read(null, $jobId);\n\t\t\t$email = \"Scheduled job\";\n\t\t} else {\n\t\t\t$email = $user['email'];\n\t\t}\n\t\t$eventModel = ClassRegistry::init('Event');\n\t\tApp::uses('HttpSocket', 'Network/Http');\n\t\t$eventIds = array();\n\t\t$conditions = array();\n\t\tif (\"full\" === $technique) {\n\t\t\t// get a list of the event_ids on the server\n\t\t\t$eventIds = $this->getEventIdsFromServer($server);\n\t\t\t// FIXME this is not clean at all ! needs to be refactored with try catch error handling/communication\n\t\t\tif ($eventIds === 403) {\n\t\t\t\treturn array (1, null);\n\t\t\t} else if (is_string($eventIds)) {\n\t\t\t\treturn array(2, $eventIds);\n\t\t\t}\n\n\t\t\t// reverse array of events, to first get the old ones, and then the new ones\n\t\t\tif (!empty($eventIds)) {\n\t\t\t\t$eventIds = array_reverse($eventIds);\n\t\t\t}\n\t\t} else if (\"update\" === $technique) {\n\t\t\t$eventIds = $this->getEventIdsFromServer($server, false, null, true, true);\n\t\t\tif ($eventIds === 403) {\n\t\t\t\treturn array (1, null);\n\t\t\t} else if (is_string($eventIds)) {\n\t\t\t\treturn array(2, $eventIds);\n\t\t\t}\n\t\t\t$local_event_ids = $eventModel->find('list', array(\n\t\t\t\t\t'fields' => array('uuid'),\n\t\t\t\t\t'recursive' => -1,\n\t\t\t));\n\t\t\t$eventIds = array_intersect($eventIds, $local_event_ids);\n\t\t} else if (\"incremental\" === $technique) {\n\t\t\t// TODO incremental pull\n\t\t\treturn array (3, null);\n\t\t} else if (is_numeric($technique)) {\n\t\t\t$eventIds[] = intval($technique);\n\t\t\t// if we are downloading a single event, don't fetch all proposals\n\t\t\t$conditions = array('Event.id' => $technique);\n\t\t} else {\n\t\t\treturn array (4, null);\n\t\t}\n\t\t$successes = array();\n\t\t$fails = array();\n\t\t$pulledProposals = array();\n\t\t// now process the $eventIds to pull each of the events sequentially\n\t\tif (!empty($eventIds)) {\n\t\t\t// download each event\n\t\t\tif (null != $eventIds) {\n\t\t\t\tApp::uses('SyncTool', 'Tools');\n\t\t\t\t$syncTool = new SyncTool();\n\t\t\t\t$HttpSocket = $syncTool->setupHttpSocket($server);\n\t\t\t\tforeach ($eventIds as $k => $eventId) {\n\t\t\t\t\t$event = $eventModel->downloadEventFromServer(\n\t\t\t\t\t\t\t$eventId,\n\t\t\t\t\t\t\t$server);\n\t\t\t\t\tif (null != $event) {\n\t\t\t\t\t\t$blocked = false;\n\t\t\t\t\t\tif (Configure::read('MISP.enableEventBlacklisting') !== false) {\n\t\t\t\t\t\t\t$this->EventBlacklist = ClassRegistry::init('EventBlacklist');\n\t\t\t\t\t\t\t$r = $this->EventBlacklist->find('first', array('conditions' => array('event_uuid' => $event['Event']['uuid'])));\n\t\t\t\t\t\t\tif (!empty($r))\t{\n\t\t\t\t\t\t\t\t$blocked = true;\n\t\t\t\t\t\t\t\t$fails[$eventId] = 'Event blocked by local blocklist.';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!$blocked) {\n\t\t\t\t\t\t\t// we have an Event array\n\t\t\t\t\t\t\t// The event came from a pull, so it should be locked.\n\t\t\t\t\t\t\t$event['Event']['locked'] = true;\n\t\t\t\t\t\t\tif (!isset($event['Event']['distribution'])) { // version 1\n\t\t\t\t\t\t\t\t$event['Event']['distribution'] = '1';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t// Distribution\n\t\t\t\t\t\t\tif (empty(Configure::read('MISP.host_org_id')) || !$server['Server']['internal'] ||  Configure::read('MISP.host_org_id') != $server['Server']['org_id']) {\n\t\t\t\t\t\t\t\tswitch ($event['Event']['distribution']) {\n\t\t\t\t\t\t\t\t\tcase 1:\n\t\t\t\t\t\t\t\t\t\t// if community only, downgrade to org only after pull\n\t\t\t\t\t\t\t\t\t\t$event['Event']['distribution'] = '0';\n\t\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t\tcase 2:\n\t\t\t\t\t\t\t\t\t\t// if connected communities downgrade to community only\n\t\t\t\t\t\t\t\t\t\t$event['Event']['distribution'] = '1';\n\t\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif (isset($event['Event']['Attribute']) && !empty($event['Event']['Attribute'])) {\n\t\t\t\t\t\t\t\t\tforeach ($event['Event']['Attribute'] as $key => $a) {\n\t\t\t\t\t\t\t\t\t\tswitch ($a['distribution']) {\n\t\t\t\t\t\t\t\t\t\t\tcase '1':\n\t\t\t\t\t\t\t\t\t\t\t\t$event['Event']['Attribute'][$key]['distribution'] = '0';\n\t\t\t\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t\t\t\tcase '2':\n\t\t\t\t\t\t\t\t\t\t\t\t$event['Event']['Attribute'][$key]['distribution'] = '1';\n\t\t\t\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t$fails[$eventId] = 'Event blocked by blacklist.';\n\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// Distribution, set reporter of the event, being the admin that initiated the pull\n\t\t\t\t\t\t$event['Event']['user_id'] = $user['id'];\n\t\t\t\t\t\t// check if the event already exist (using the uuid)\n\t\t\t\t\t\t$existingEvent = null;\n\t\t\t\t\t\t$existingEvent = $eventModel->find('first', array('conditions' => array('Event.uuid' => $event['Event']['uuid'])));\n\t\t\t\t\t\tif (!$existingEvent) {\n\t\t\t\t\t\t\t// add data for newly imported events\n\t\t\t\t\t\t\t$passAlong = $server['Server']['id'];\n\t\t\t\t\t\t\t$result = $eventModel->_add($event, true, $user, $server['Server']['org_id'], $passAlong, true, $jobId);\n\t\t\t\t\t\t\tif ($result) $successes[] = $eventId;\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t$fails[$eventId] = 'Failed (partially?) because of validation errors: '. print_r($eventModel->validationErrors, true);\n\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t$tempUser = $user;\n\t\t\t\t\t\t\t$tempUser['Role']['perm_site_admin'] = 0;\n\t\t\t\t\t\t\t$result = $eventModel->_edit($event, $tempUser, $existingEvent['Event']['id'], $jobId);\n\t\t\t\t\t\t\tif ($result === true) $successes[] = $eventId;\n\t\t\t\t\t\t\telse if (isset($result['error'])) $fails[$eventId] = $result['error'];\n\t\t\t\t\t\t\telse $fails[$eventId] = json_encode($result);\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// error\n\t\t\t\t\t\t$fails[$eventId] = 'failed downloading the event';\n\t\t\t\t\t}\n\t\t\t\t\tif ($jobId) {\n\t\t\t\t\t\tif ($k % 10 == 0) {\n\t\t\t\t\t\t\t$job->id = $jobId;\n\t\t\t\t\t\t\t$job->saveField('progress', 50 * (($k + 1) / count($eventIds)));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (count($fails) > 0) {\n\t\t\t\t\t// there are fails, take the lowest fail\n\t\t\t\t\t$lastpulledid = min(array_keys($fails));\n\t\t\t\t} else {\n\t\t\t\t\t// no fails, take the highest success\n\t\t\t\t\t$lastpulledid = count($successes) > 0 ? max($successes) : 0;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif ($jobId) {\n\t\t\t$job->saveField('message', 'Pulling proposals.');\n\t\t}\n\t\t$events = $eventModel->find('list', array(\n\t\t\t\t'fields' => array('uuid'),\n\t\t\t\t'recursive' => -1,\n\t\t\t\t'conditions' => $conditions\n\t\t));\n\t\t$shadowAttribute = ClassRegistry::init('ShadowAttribute');\n\t\t$shadowAttribute->recursive = -1;\n\t\tif (!empty($events)) {\n\t\t\t$proposals = $eventModel->downloadProposalsFromServer($events, $server);\n\t\t\tif (!empty($proposals)) {\n\t\t\t\t$uuidEvents = array_flip($events);\n\t\t\t\tforeach ($proposals as $k => &$proposal) {\n\t\t\t\t\t$proposal = $proposal['ShadowAttribute'];\n\t\t\t\t\t$oldsa = $shadowAttribute->findOldProposal($proposal);\n\t\t\t\t\t$proposal['event_id'] = $uuidEvents[$proposal['event_uuid']];\n\t\t\t\t\tif (!$oldsa || $oldsa['timestamp'] < $proposal['timestamp']) {\n\t\t\t\t\t\tif ($oldsa) $shadowAttribute->delete($oldsa['id']);\n\t\t\t\t\t\tif (!isset($pulledProposals[$proposal['event_id']])) $pulledProposals[$proposal['event_id']] = 0;\n\t\t\t\t\t\t$pulledProposals[$proposal['event_id']]++;\n\t\t\t\t\t\tif (isset($proposal['old_id'])) {\n\t\t\t\t\t\t\t$oldAttribute = $eventModel->Attribute->find('first', array('recursive' => -1, 'conditions' => array('uuid' => $proposal['uuid'])));\n\t\t\t\t\t\t\tif ($oldAttribute) $proposal['old_id'] = $oldAttribute['Attribute']['id'];\n\t\t\t\t\t\t\telse $proposal['old_id'] = 0;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// check if this is a proposal from an old MISP instance\n\t\t\t\t\t\tif (!isset($proposal['Org']) && isset($proposal['org']) && !empty($proposal['org'])) {\n\t\t\t\t\t\t\t$proposal['Org'] = $proposal['org'];\n\t\t\t\t\t\t\t$proposal['EventOrg'] = $proposal['event_org'];\n\t\t\t\t\t\t} else if (!isset($proposal['Org']) && !isset($proposal['EventOrg'])) {\n\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$proposal['org_id'] = $this->Organisation->captureOrg($proposal['Org'], $user);\n\t\t\t\t\t\t$proposal['event_org_id'] = $this->Organisation->captureOrg($proposal['EventOrg'], $user);\n\t\t\t\t\t\tunset($proposal['Org']);\n\t\t\t\t\t\tunset($proposal['EventOrg']);\n\t\t\t\t\t\t$shadowAttribute->create();\n\t\t\t\t\t\tif (!isset($proposal['deleted']) || !$proposal['deleted']) {\n\t\t\t\t\t\t\tif ($shadowAttribute->save($proposal)) $shadowAttribute->sendProposalAlertEmail($proposal['event_id']);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif ($jobId) {\n\t\t\t\t\t\tif ($k % 50 == 0) {\n\t\t\t\t\t\t\t$job->id = $jobId;\n\t\t\t\t\t\t\t$job->saveField('progress', 50 * (($k + 1) / count($proposals)));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif ($jobId) {\n\t\t\t$job->saveField('progress', 100);\n\t\t\t$job->saveField('message', 'Pull completed.');\n\t\t\t$job->saveField('status', 4);\n\t\t}\n\t\t$this->Log = ClassRegistry::init('Log');\n\t\t$this->Log->create();\n\t\t$this->Log->save(array(\n\t\t\t'org' => $user['Organisation']['name'],\n\t\t\t'model' => 'Server',\n\t\t\t'model_id' => $id,\n\t\t\t'email' => $user['email'],\n\t\t\t'action' => 'pull',\n\t\t\t'user_id' => $user['id'],\n\t\t\t'title' => 'Pull from ' . $server['Server']['url'] . ' initiated by ' . $email,\n\t\t\t'change' => count($successes) . ' events and ' . count($pulledProposals) . ' proposals pulled or updated. ' . count($fails) . ' events failed or didn\\'t need an update.'\n\t\t));\n\t\tif (!isset($lastpulledid)) $lastpulledid = 0;\n\t\treturn array($successes, $fails, $pulledProposals, $lastpulledid);\n\t}\n\n\tpublic function filterRuleToParameter($filter_rules) {\n\t\t$final = array();\n\t\tif (empty($filter_rules)) return $final;\n\t\t$filter_rules = json_decode($filter_rules, true);\n\t\tforeach ($filter_rules as $field => $rules) {\n\t\t\t$temp = array();\n\t\t\tforeach ($rules as $operator => $elements) {\n\t\t\t\tforeach ($elements as $k => $element) {\n\t\t\t\t\tif ($operator === 'NOT') $element = '!' . $element;\n\t\t\t\t\tif (!empty($element)) $temp[] = $element;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!empty($temp)) {\n\t\t\t\t$temp = implode('|', $temp);\n\t\t\t\t$final[substr($field, 0, strlen($field) -1)] = $temp;\n\t\t\t}\n\t\t}\n\t\treturn $final;\n\t}\n\n\n\t// Get an array of event_ids that are present on the remote server\n\tpublic function getEventIdsFromServer($server, $all = false, $HttpSocket=null, $force_uuid=false, $ignoreFilterRules = false) {\n\t\t$url = $server['Server']['url'];\n\t\t$authkey = $server['Server']['authkey'];\n\t\tif ($ignoreFilterRules) $filter_rules = array();\n\t\telse $filter_rules = $this->filterRuleToParameter($server['Server']['pull_rules']);\n\t\tif (null == $HttpSocket) {\n\t\t\tApp::uses('SyncTool', 'Tools');\n\t\t\t$syncTool = new SyncTool();\n\t\t\t$HttpSocket = $syncTool->setupHttpSocket($server);\n\t\t}\n\t\t$request = array(\n\t\t\t\t'header' => array(\n\t\t\t\t\t\t'Authorization' => $authkey,\n\t\t\t\t\t\t'Accept' => 'application/json',\n\t\t\t\t\t\t'Content-Type' => 'application/json',\n\t\t\t\t\t\t//'Connection' => 'keep-alive' // LATER followup cakephp issue about this problem: https://github.com/cakephp/cakephp/issues/1961\n\t\t\t\t)\n\t\t);\n\t\t$uri = $url . '/events/index';\n\t\t$filter_rules['minimal'] = 1;\n\t\ttry {\n\t\t\t$response = $HttpSocket->post($uri, json_encode($filter_rules), $request);\n\t\t\tif ($response->isOk()) {\n\t\t\t\t$eventArray = json_decode($response->body, true);\n\t\t\t\t// correct $eventArray if just one event\n\t\t\t\tif (is_array($eventArray) && isset($eventArray['id'])) {\n\t\t\t\t\t$tmp = $eventArray;\n\t\t\t\t\tunset($eventArray);\n\t\t\t\t\t$eventArray[0] = $tmp;\n\t\t\t\t\tunset($tmp);\n\t\t\t\t}\n\t\t\t\t$eventIds = array();\n\t\t\t\tif ($all) {\n\t\t\t\t\tif (!empty($eventArray)) foreach ($eventArray as $event) {\n\t\t\t\t\t\t$eventIds[] = $event['uuid'];\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t// multiple events, iterate over the array\n\t\t\t\t\t$this->Event = ClassRegistry::init('Event');\n\t\t\t\t\tforeach ($eventArray as $k => $event) {\n\t\t\t\t\t\tif (1 != $event['published']) {\n\t\t\t\t\t\t\tunset($eventArray[$k]); // do not keep non-published events\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$this->Event->removeOlder($eventArray);\n\t\t\t\t\tif (!empty($eventArray)) {\n\t\t\t\t\t\tforeach ($eventArray as $event) {\n\t\t\t\t\t\t\tif ($force_uuid) $eventIds[] = $event['uuid'];\n\t\t\t\t\t\t\telse $eventIds[] = $event['id'];\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn $eventIds;\n\t\t\t}\n\t\t\tif ($response->code == '403') {\n\t\t\t\treturn 403;\n\t\t\t}\n\t\t} catch (SocketException $e) {\n\t\t\t// FIXME refactor this with clean try catch over all http functions\n\t\t\treturn $e->getMessage();\n\t\t}\n\t\t// error, so return error message, since that is handled and everything is expecting an array\n\t\treturn \"Error: got response code \" . $response->code;\n\t}\n\n\tpublic function push($id = null, $technique=false, $jobId = false, $HttpSocket, $user) {\n\t\tif ($jobId) {\n\t\t\t$job = ClassRegistry::init('Job');\n\t\t\t$job->read(null, $jobId);\n\t\t}\n\t\t$this->Event = ClassRegistry::init('Event');\n\t\t$this->read(null, $id);\n\t\t$url = $this->data['Server']['url'];\n\t\t$push = $this->checkVersionCompatibility($id, $user)['canPush'];\n\t\tif (!isset($push) || !$push) {\n\t\t\tif ($jobId) {\n\t\t\t\t$job->id = $jobId;\n\t\t\t\t$job->saveField('progress', 100);\n\t\t\t\t$job->saveField('message', 'Push to server ' . $id . ' failed. Remote instance is outdated.');\n\t\t\t\t$job->saveField('status', 4);\n\t\t\t}\n\t\t\treturn false;\n\t\t}\n\t\tif (\"full\" == $technique) {\n\t\t\t$eventid_conditions_key = 'Event.id >';\n\t\t\t$eventid_conditions_value = 0;\n\t\t} else if (\"incremental\" == $technique) {\n\t\t\t$eventid_conditions_key = 'Event.id >';\n\t\t\t$eventid_conditions_value = $this->data['Server']['lastpushedid'];\n\t\t} else if (true == $technique) {\n\t\t\t$eventid_conditions_key = 'Event.id';\n\t\t\t$eventid_conditions_value = intval($technique);\n\t\t} else {\n\t\t\t$this->redirect(array('action' => 'index'));\n\t\t}\n\t\t$sgs = $this->Event->SharingGroup->find('all', array(\n\t\t\t'recursive' => -1,\n\t\t\t'contain' => array('Organisation', 'SharingGroupOrg', 'SharingGroupServer')\n\t\t));\n\t\t$sgIds = array();\n\t\tforeach ($sgs as $k => $sg) {\n\t\t\tif (!$this->Event->SharingGroup->checkIfServerInSG($sg, $this->data)) {\n\t\t\t\tunset($sgs[$k]);\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\t$sgIds[] = $sg['SharingGroup']['id'];\n\t\t}\n\t\tif (!isset($sgIds) || empty($sgIds)) {\n\t\t\t$sgIds = array(-1);\n\t\t}\n\t\t$findParams = array(\n\t\t\t\t'conditions' => array(\n\t\t\t\t\t\t$eventid_conditions_key => $eventid_conditions_value,\n\t\t\t\t\t\t'Event.published' => 1,\n\t\t\t\t\t\t'Event.attribute_count >' => 0,\n\t\t\t\t\t\t'OR' => array(\n\t\t\t\t\t\t\tarray(\n\t\t\t\t\t\t\t\t'AND' => array(\n\t\t\t\t\t\t\t\t\tarray('Event.distribution >' => 0),\n\t\t\t\t\t\t\t\t\tarray('Event.distribution <' => 4),\n\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\tarray(\n\t\t\t\t\t\t\t\t'AND' => array(\n\t\t\t\t\t\t\t\t\t'Event.distribution' => 4,\n\t\t\t\t\t\t\t\t\t'Event.sharing_group_id' => $sgIds\n\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t)\n\t\t\t\t), // array of conditions\n\t\t\t\t'recursive' => -1, //int\n\t\t\t\t'contain' => array('EventTag' => array('fields' => array('EventTag.tag_id'))),\n\t\t\t\t'fields' => array('Event.id', 'Event.timestamp', 'Event.uuid', 'Event.orgc_id'), // array of field names\n\t\t);\n\t\t$eventIds = $this->Event->find('all', $findParams);\n\t\t$eventUUIDsFiltered = $this->getEventIdsForPush($id, $HttpSocket, $eventIds, $user);\n\t\tif ($eventUUIDsFiltered === false || empty($eventUUIDsFiltered)) $pushFailed = true;\n\t\tif (!empty($eventUUIDsFiltered)) {\n\t\t\t$eventCount = count($eventUUIDsFiltered);\n\t\t\t// now process the $eventIds to pull each of the events sequentially\n\t\t\tif (!empty($eventUUIDsFiltered)) {\n\t\t\t\t$successes = array();\n\t\t\t\t$fails = array();\n\t\t\t\t$lowestfailedid = null;\n\t\t\t\tforeach ($eventUUIDsFiltered as $k => $eventUuid) {\n\t\t\t\t\t$event = $this->Event->fetchEvent($user, array(\n\t\t\t\t\t\t'event_uuid' => $eventUuid,\n\t\t\t\t\t\t'includeAttachments' => true,\n\t\t\t\t\t\t'includeAllTags' => true\n\t\t\t\t\t));\n\t\t\t\t\t$event = $event[0];\n\t\t\t\t\t$event['Event']['locked'] = true;\n\t\t\t\t\t$result = $this->Event->uploadEventToServer(\n\t\t\t\t\t\t\t$event,\n\t\t\t\t\t\t\t$this->data,\n\t\t\t\t\t\t\t$HttpSocket);\n\t\t\t\t\tif ('Success' === $result) {\n\t\t\t\t\t\t$successes[] = $event['Event']['id'];\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$fails[$event['Event']['id']] = $result;\n\t\t\t\t\t}\n\t\t\t\t\tif ($jobId && $k%10 == 0) {\n\t\t\t\t\t\t$job->saveField('progress', 100 * $k / $eventCount);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (count($fails) > 0) {\n\t\t\t\t\t// there are fails, take the lowest fail\n\t\t\t\t\t$lastpushedid = min(array_keys($fails));\n\t\t\t\t} else {\n\t\t\t\t\t// no fails, take the highest success\n\t\t\t\t\t$lastpushedid = max($successes);\n\t\t\t\t}\n\t\t\t\t// increment lastid based on the highest ID seen\n\t\t\t\t// Save the entire Server data instead of just a single field, so that the logger can be fed with the extra fields.\n\t\t\t\t$this->data['Server']['lastpushedid'] = $lastpushedid;\n\t\t\t\t$this->save($this->data);\n\t\t\t}\n\t\t}\n\n\t\t$this->syncProposals($HttpSocket, $this->data, null, null, $this->Event);\n\n\t\tif (!isset($successes)) $successes = null;\n\t\tif (!isset($fails)) $fails = null;\n\t\t$this->Log = ClassRegistry::init('Log');\n\t\t$this->Log->create();\n\t\t$this->Log->save(array(\n\t\t\t\t'org' => $user['Organisation']['name'],\n\t\t\t\t'model' => 'Server',\n\t\t\t\t'model_id' => $id,\n\t\t\t\t'email' => $user['email'],\n\t\t\t\t'action' => 'push',\n\t\t\t\t'user_id' => $user['id'],\n\t\t\t\t'title' => 'Push to ' . $url . ' initiated by ' . $user['email'],\n\t\t\t\t'change' => count($successes) . ' events pushed or updated. ' . count($fails) . ' events failed or didn\\'t need an update.'\n\t\t));\n\t\tif ($jobId) {\n\t\t\t$job->id = $jobId;\n\t\t\t$job->saveField('progress', 100);\n\t\t\t$job->saveField('message', 'Push to server ' . $id . ' complete.');\n\t\t\t$job->saveField('status', 4);\n\t\t} else {\n\t\t\treturn array($successes, $fails);\n\t\t}\n\t}\n\n\tpublic function getEventIdsForPush($id, $HttpSocket, $eventIds, $user) {\n\t\t$server = $this->read(null, $id);\n\t\t$this->Event = ClassRegistry::init('Event');\n\n\t\tforeach ($eventIds as $k => $event) {\n\t\t\tif (empty($this->eventFilterPushableServers($event, array($server)))) {\n\t\t\t\tunset($eventIds[$k]);\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tunset($eventIds[$k]['Event']['id']);\n\t\t}\n\t\tif (null == $HttpSocket) {\n\t\t\tApp::uses('SyncTool', 'Tools');\n\t\t\t$syncTool = new SyncTool();\n\t\t\t$HttpSocket = $syncTool->setupHttpSocket($server);\n\t\t}\n\t\t$data = json_encode($eventIds);\n\t\t$request = array(\n\t\t\t\t'header' => array(\n\t\t\t\t\t\t'Authorization' => $server['Server']['authkey'],\n\t\t\t\t\t\t'Accept' => 'application/json',\n\t\t\t\t\t\t'Content-Type' => 'application/json',\n\t\t\t\t)\n\t\t);\n\t\t$uri = $server['Server']['url'] . '/events/filterEventIdsForPush';\n\t\t$response = $HttpSocket->post($uri, $data, $request);\n\t\tif ($response->code == '200') {\n\t\t\t$uuidList = json_decode($response->body());\n\t\t} else {\n\t\t\treturn false;\n\t\t}\n\t\treturn $uuidList;\n\t}\n\n\tpublic function syncProposals($HttpSocket, $server, $sa_id = null, $event_id = null, $eventModel) {\n\t\t$saModel = ClassRegistry::init('ShadowAttribute');\n\t\tif (null == $HttpSocket) {\n\t\t\tApp::uses('SyncTool', 'Tools');\n\t\t\t$syncTool = new SyncTool();\n\t\t\t$HttpSocket = $syncTool->setupHttpSocket($server);\n\t\t}\n\t\tif ($sa_id == null) {\n\t\t\tif ($event_id == null) {\n\t\t\t\t// event_id is null when we are doing a push\n\t\t\t\t$ids = $this->getEventIdsFromServer($server, true, $HttpSocket, false, true);\n\t\t\t\t// error return strings or ints or throw exceptions\n\t\t\t\tif (!is_array($ids)) return false;\n\t\t\t\t$conditions = array('uuid' => $ids);\n\t\t\t} else {\n\t\t\t\t$conditions = array('id' => $event_id);\n\t\t\t\t// event_id is not null when we are doing a publish\n\t\t\t}\n\t\t\t$events = $eventModel->find('all', array(\n\t\t\t\t\t'conditions' => $conditions,\n\t\t\t\t\t'recursive' => 1,\n\t\t\t\t\t'contain' => 'ShadowAttribute',\n\t\t\t\t\t'fields' => array('Event.uuid')\n\t\t\t));\n\n\t\t\t$fails = 0;\n\t\t\t$success = 0;\n\t\t\t$error_message = \"\";\n\t\t\tforeach ($events as $k => &$event) {\n\t\t\t\tif (!empty($event['ShadowAttribute'])) {\n\t\t\t\t\tforeach ($event['ShadowAttribute'] as &$sa) {\n\t\t\t\t\t\t$sa['data'] = $saModel->base64EncodeAttachment($sa);\n\t\t\t\t\t\tunset($sa['id']);\n\t\t\t\t\t\tunset($sa['value1']);\n\t\t\t\t\t\tunset($sa['value2']);\n\t\t\t\t\t}\n\n\t\t\t\t\t$data = json_encode($event['ShadowAttribute']);\n\t\t\t\t\t$request = array(\n\t\t\t\t\t\t\t'header' => array(\n\t\t\t\t\t\t\t\t\t'Authorization' => $server['Server']['authkey'],\n\t\t\t\t\t\t\t\t\t'Accept' => 'application/json',\n\t\t\t\t\t\t\t\t\t'Content-Type' => 'application/json',\n\t\t\t\t\t\t\t)\n\t\t\t\t\t);\n\t\t\t\t\t$uri = $server['Server']['url'] . '/events/pushProposals/' . $event['Event']['uuid'];\n\t\t\t\t\t$response = $HttpSocket->post($uri, $data, $request);\n\t\t\t\t\tif ($response->code == '200') {\n\t\t\t\t\t\t$result = json_decode($response->body(), true);\n\t\t\t\t\t\tif ($result['success']) {\n\t\t\t\t\t\t\t$success += intval($result['counter']);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t$fails++;\n\t\t\t\t\t\t\tif ($error_message == \"\") $result['message'];\n\t\t\t\t\t\t\telse $error_message .= \" --- \" . $result['message'];\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$fails++;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\t// connect to checkuuid($uuid)\n\t\t\t$request = array(\n\t\t\t\t\t'header' => array(\n\t\t\t\t\t\t\t'Authorization' => $server['Server']['authkey'],\n\t\t\t\t\t\t\t'Accept' => 'application/json',\n\t\t\t\t\t\t\t'Content-Type' => 'application/json',\n\t\t\t\t\t)\n\t\t\t);\n\t\t\t$uri = $server['Server']['url'] . '/events/checkuuid/' . $sa_id;\n\t\t\t$response = $HttpSocket->get($uri, '', $request);\n\t\t\tif ($response->code != '200') {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n\n\tpublic function getCurrentServerSettings() {\n\t\t$this->Module = ClassRegistry::init('Module');\n\t\t$serverSettings = $this->serverSettings;\n\t\t$moduleTypes = array('Enrichment', 'Import', 'Export', 'Cortex');\n\t\t$orgs = $this->Organisation->find('list', array(\n\t\t\t'conditions' => array(\n\t\t\t\t'Organisation.local' => 1\n\t\t\t),\n\t\t\t'fields' => array(\n\t\t\t\t'Organisation.id', 'Organisation.name'\n\t\t\t)\n\t\t));\n\t\t$orgs = array_merge(array('Unrestricted'), $orgs);\n\t\tforeach ($moduleTypes as $moduleType) {\n\t\t\tif (Configure::read('Plugin.' . $moduleType . '_services_enable')) {\n\t\t\t\t$results = $this->Module->getModuleSettings($moduleType);\n\t\t\t\tforeach ($results as $module => $data) {\n\t\t\t\t\tforeach ($data as $result) {\n\t\t\t\t\t\t$setting = array('level' => 1, 'errorMessage' => '');\n\t\t\t\t\t\tif ($result['type'] == 'boolean') {\n\t\t\t\t\t\t\t$setting['test'] = 'testBool';\n\t\t\t\t\t\t\t$setting['type'] = 'boolean';\n\t\t\t\t\t\t\t$setting['description'] = 'Enable or disable the ' . $module . ' module.';\n\t\t\t\t\t\t\t$setting['value'] = false;\n\t\t\t\t\t\t} else if ($result['type'] == 'orgs') {\n\t\t\t\t\t\t\t$setting['description'] = 'Restrict the ' . $module . ' module to the given organisation.';\n\t\t\t\t\t\t\t$setting['value'] = 0;\n\t\t\t\t\t\t\t$setting['test'] = 'testLocalOrg';\n\t\t\t\t\t\t\t$setting['type'] = 'numeric';\n\t\t\t\t\t\t\t$setting['optionsSource'] = 'LocalOrgs';\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t$setting['test'] = 'testForEmpty';\n\t\t\t\t\t\t\t$setting['type'] = 'string';\n\t\t\t\t\t\t\t$setting['description'] = 'Set this required module specific setting.';\n\t\t\t\t\t\t\t$setting['value'] = '';\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$serverSettings['Plugin'][$moduleType . '_' . $module . '_' .  $result['name']] = $setting;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn $serverSettings;\n\t}\n\n\tpublic function serverSettingsRead($unsorted = false) {\n\t\t$this->Module = ClassRegistry::init('Module');\n\t\t$serverSettings = $this->getCurrentServerSettings();\n\t\t$currentSettings = Configure::read();\n\t\tif (Configure::read('Plugin.Enrichment_services_enable')) {\n\t\t\t$results = $this->Module->getModuleSettings();\n\t\t\tforeach ($results as $module => $data) {\n\t\t\t\tforeach ($data as $result) {\n\t\t\t\t\t$setting = array('level' => 1, 'errorMessage' => '');\n\t\t\t\t\tif ($result['type'] == 'boolean') {\n\t\t\t\t\t\t$setting['test'] = 'testBool';\n\t\t\t\t\t\t$setting['type'] = 'boolean';\n\t\t\t\t\t\t$setting['description'] = 'Enable or disable the ' . $module . ' module.';\n\t\t\t\t\t\t$setting['value'] = false;\n\t\t\t\t\t} else if ($result['type'] == 'orgs') {\n\t\t\t\t\t\t$setting['description'] = 'Restrict the ' . $module . ' module to the given organisation.';\n\t\t\t\t\t\t$setting['value'] = 0;\n\t\t\t\t\t\t$setting['test'] = 'testLocalOrg';\n\t\t\t\t\t\t$setting['type'] = 'numeric';\n\t\t\t\t\t\t$setting['optionsSource'] = 'LocalOrgs';\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$setting['test'] = 'testForEmpty';\n\t\t\t\t\t\t$setting['type'] = 'string';\n\t\t\t\t\t\t$setting['description'] = 'Set this required module specific setting.';\n\t\t\t\t\t\t$setting['value'] = '';\n\t\t\t\t\t}\n\t\t\t\t\t$serverSettings['Plugin']['Enrichment_' . $module . '_' .  $result['name']] = $setting;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t$finalSettingsUnsorted = array();\n\t\tforeach ($serverSettings as $branchKey => &$branchValue) {\n\t\t\tif (isset($branchValue['branch'])) {\n\t\t\t\tforeach ($branchValue as $leafKey => &$leafValue) {\n\t\t\t\t\tif ($leafValue['level'] == 3 && !(isset($currentSettings[$branchKey][$leafKey]))) continue;\n\t\t\t\t\t$setting = null;\n\t\t\t\t\tif (isset($currentSettings[$branchKey][$leafKey])) $setting = $currentSettings[$branchKey][$leafKey];\n\t\t\t\t\t$leafValue = $this->__evaluateLeaf($leafValue, $leafKey, $setting);\n\t\t\t\t\tif ($leafKey != 'branch') {\n\t\t\t\t\t\tif ($branchKey == 'Plugin') {\n\t\t\t\t\t\t\t$pluginData = explode('_', $leafKey);\n\t\t\t\t\t\t\t$leafValue['subGroup'] = $pluginData[0];\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (strpos($branchKey, 'Secur') === 0) $leafValue['tab'] = 'Security';\n\t\t\t\t\t\telse $leafValue['tab'] = $branchKey;\n\t\t\t\t\t\t$finalSettingsUnsorted[$branchKey . '.' . $leafKey] = $leafValue;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t\t$setting = null;\n\t\t\t\t\tif (isset($currentSettings[$branchKey])) $setting = $currentSettings[$branchKey];\n\t\t\t\t\t$branchValue = $this->__evaluateLeaf($branchValue, $branchKey, $setting);\n\t\t\t\t\t$branchValue['tab'] = 'misc';\n\t\t\t\t\t$finalSettingsUnsorted[$branchKey] = $branchValue;\n\t\t\t}\n\t\t}\n\t\tforeach ($finalSettingsUnsorted as $key => $temp) if (in_array($temp['tab'], array_keys($this->__settingTabMergeRules))) {\n\t\t\t$finalSettingsUnsorted[$key]['tab'] = $this->__settingTabMergeRules[$temp['tab']];\n\t\t}\n\t\tif ($unsorted) return $finalSettingsUnsorted;\n\t\t$finalSettings = array();\n\t\tfor ($i = 0; $i < 4; $i++) {\n\t\t\tforeach ($finalSettingsUnsorted as $k => $s) {\n\t\t\t\t$s['setting'] = $k;\n\t\t\t\tif ($s['level'] == $i) $finalSettings[] = $s;\n\t\t\t}\n\t\t}\n\t\treturn $finalSettings;\n\t}\n\n\tpublic function serverSettingReadSingle($settingObject, $settingName, $leafKey) {\n\t\t// invalidate config.php from php opcode cache\n\t\tif (function_exists('opcache_reset')) opcache_reset();\n\n\t\t$setting = Configure::read($settingName);\n\t\t$result = $this->__evaluateLeaf($settingObject, $leafKey, $setting);\n\t\t$result['setting'] = $settingName;\n\t\treturn $result;\n\t}\n\n\tprivate function __evaluateLeaf($leafValue, $leafKey, $setting) {\n\t\tif (isset($setting)) {\n\t\t\tif (!empty($leafValue['test'])) {\n\t\t\t\t$result = $this->{$leafValue['test']}($setting);\n\t\t\t\tif ($result !== true) {\n\t\t\t\t\t$leafValue['error'] = 1;\n\t\t\t\t\tif ($result !== false) $leafValue['errorMessage'] = $result;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif ($setting !== '') $leafValue['value'] = $setting;\n\t\t} else {\n\t\t\tif ($leafKey != 'branch' && (!isset($leafValue['null']) || !$leafValue['null'])) {\n\t\t\t\t$leafValue['error'] = 1;\n\t\t\t\t$leafValue['errorMessage'] = 'Value not set.';\n\t\t\t}\n\t\t}\n\t\treturn $leafValue;\n\t}\n\n\tpublic function testForNumeric($value) {\n\t\tif (!is_numeric($value)) return 'This setting has to be a number.';\n\t\treturn true;\n\t}\n\n\tpublic function testUuid($value) {\n\t\tif (empty($value) || !preg_match('/^\\{?[a-z0-9]{8}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12}\\}?$/', $value)) {\n\t\t\treturn 'Invalid UUID.';\n\t\t}\n\t\treturn true;\n\t}\n\n\tpublic function testForSessionDefaults($value) {\n\t\tif (empty($value) || !in_array($value, array('php', 'database', 'cake', 'cache'))) {\n\t\t\treturn 'Please choose a valid session handler. Recommended values: php or database. Alternate options are cake (cakephp file based sessions) and cache.';\n\t\t} else {\n\t\t\treturn true;\n\t\t}\n\t}\n\n\tpublic function testLocalOrg($value) {\n\t\t$this->Organisation = ClassRegistry::init('Organisation');\n\t\tif ($value == 0) return 'No organisation selected';\n\t\t$local_orgs = $this->Organisation->find('list', array(\n\t\t\t'conditions' => array('local' => 1),\n\t\t\t'recursive' => -1,\n\t\t\t'fields' => array('Organisation.id', 'Organisation.name')\n\t\t));\n\t\tif (in_array($value, array_keys($local_orgs))) return true;\n\t\treturn 'Invalid organisation';\n\t}\n\n\tpublic function testForEmpty($value) {\n\t\t$value = trim($value);\n\t\tif ($value === '') return 'Value not set.';\n\t\treturn true;\n\t}\n\n\tpublic function testForPath($value) {\n\t\tif ($value === '') return true;\n\t\tif (preg_match('@^\\/?(([a-z0-9_.]+[a-z0-9_.\\-.\\:]*[a-z0-9_.\\-.\\:]|[a-z0-9_.])+\\/?)+$@i', $value)) return true;\n\t\treturn 'Invalid characters in the path.';\n\t}\n\n\tpublic function testForWritableDir($value) {\n\t\tif (!is_dir($value)) return 'Not a valid directory.';\n\t\tif (!is_writeable($value)) return 'Not a writable directory.';\n\t\treturn true;\n\t}\n\n\tpublic function testDebug($value) {\n\t\tif ($this->testForEmpty($value) !== true) return $this->testForEmpty($value);\n\t\tif ($this->testForNumeric($value) !== true) return 'This setting has to be a number between 0 and 2, with 0 disabling debug mode.';\n\t\tif ($value === 0) return true;\n\t\treturn 'This setting has to be set to 0 on production systems. Ignore this warning if this is not the case.';\n\t}\n\n\tpublic function testDebugAdmin($value) {\n\t\tif ($this->testBool($value) !== true) return 'This setting has to be either true or false.';\n\t\tif (!$value) return true;\n\t\treturn 'Enabling debug is not recommended. Turn this on temporarily if you need to see a stack trace to debug an issue, but make sure this is not left on.';\n\t}\n\n\tpublic function testDate($date) {\n\t\tif ($this->testForEmpty($date) !== true) return $this->testForEmpty($date);\n\t\tif (!strtotime($date)) return 'The date that you have entered is invalid. Expected: yyyy-mm-dd';\n\t\treturn true;\n\t}\n\n\n\tpublic function getHost() {\n\t\tif (function_exists('apache_request_headers')){\n\t\t\t\t $headers = apache_request_headers();\n\t\t} else {\n\t\t\t\t $headers = $_SERVER;\n\t\t}\n\n\t\tif ( array_key_exists( 'X-Forwarded-Host', $headers ) ) {\n\t\t\t\t $host = $headers['X-Forwarded-Host'];\n\t\t} else {\n\t\t\t\t $host = $_SERVER['HTTP_HOST'];\n\t\t}\n\t\treturn $host;\n\t}\n\n\tpublic function getProto() {\n\t\tif (function_exists('apache_request_headers')){\n\t\t\t\t $headers = apache_request_headers();\n\t\t} else {\n\t\t\t\t $headers = $_SERVER;\n\t\t}\n\n\t\tif (array_key_exists('X-Forwarded-Proto',$headers)){\n\t\t\t\t $proto = $headers['X-Forwarded-Proto'];\n\t\t} else {\n\t\t\t\t $proto = ((!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off') || $_SERVER['SERVER_PORT'] == 443) === true ? 'HTTPS' : 'HTTP';\n\t\t}\n\t\treturn $proto;\n\t}\n\n\tpublic function testBaseURL($value) {\n\t\tif ($this->testForEmpty($value) !== true) return $this->testForEmpty($value);\n\t\tif ($value != strtolower($this->getProto()) . '://' . $this->getHost()) return false;\n\t\treturn true;\n\t}\n\n\tpublic function testDisableEmail($value) {\n\t\tif (isset($value) && $value) return 'E-mailing is blocked.';\n\t\treturn true;\n\t}\n\n\tpublic function testDisableCache($value) {\n\t\tif (isset($value) && $value) return 'Export caches are disabled.';\n\t\treturn true;\n\t}\n\n\tpublic function testLive($value) {\n\t\tif ($this->testBool($value) !== true) return $this->testBool($value);\n\t\tif (!$value) return 'MISP disabled.';\n\t\treturn true;\n\t}\n\n\tpublic function testBool($value) {\n\t\tif ($value !== true && $value !== false) return 'Value is not a boolean, make sure that you convert \\'true\\' to true for example.';\n\t\treturn true;\n\t}\n\n\tpublic function testBoolFalse($value) {\n\t\tif (!$this->testBool($value)) {\n\t\t\treturn $this->testBool($value);\n\t\t}\n\t\tif ($value !== false) {\n\t\t\treturn 'It is highly recommended that this setting is disabled. Make sure you understand the impact of having this setting turned on.';\n\t\t} else {\n\t\t\treturn true;\n\t\t}\n\t}\n\n\tpublic function testSalt($value) {\n\t\tif ($this->testForEmpty($value) !== true) return $this->testForEmpty($value);\n\t\tif (strlen($value) < 32) return 'The salt has to be an at least 32 byte long string.';\n\t\tif ($value == \"Rooraenietu8Eeyo<Qu2eeNfterd-dd+\") return 'This is the default salt shipped with the application and is therefore unsecure.';\n\t\treturn true;\n\t}\n\n\tpublic function testForTermsFile($value) {\n\t\treturn $this->__testForFile($value, APP . 'files' . DS . 'terms');\n\t}\n\n\tpublic function testForStyleFile($value) {\n\t\tif (empty($value)) return true;\n\t\treturn $this->__testForFile($value, APP . 'webroot' . DS . 'css');\n\t}\n\n\tpublic function testForCustomImage($value) {\n\t\treturn $this->__testForFile($value, APP . 'webroot' . DS . 'img' . DS . 'custom');\n\t}\n\n\tpublic function testPasswordLength($value) {\n\t\t$numeric = $this->testForNumeric($value);\n\t\tif ($numeric !== true) return $numeric;\n\t\tif ($value < 0) return 'Length cannot be negative, set a positive integer or 0 (to choose the default option).';\n\t\treturn true;\n\t}\n\n\tpublic function testForPortNumber($value) {\n\t\t$numeric = $this->testForNumeric($value);\n\t\tif ($numeric !== true) return $numeric;\n\t\tif ($value < 21 || $value > 65535) return 'Make sure that you pick a valid port number.';\n\t\treturn true;\n\t}\n\n\tpublic function testForZMQPortNumber($value) {\n\t\t$numeric = $this->testForNumeric($value);\n\t\tif ($numeric !== true) return $numeric;\n\t\tif ($value < 49152 || $value > 65535) return 'It is recommended that you pick a port number in the dynamic range (49152-65535). However, if you have a valid reason to use a different port, ignore this message.';\n\t\treturn true;\n\t}\n\n\tpublic function testPasswordRegex($value) {\n\t\tif (!empty($value) && @preg_match($value, 'test') === false) return 'Invalid regex.';\n\t\treturn true;\n\t}\n\n\tpublic function testPasswordResetText($value) {\n\t\tif (strpos($value, '$password') === false || strpos($value, '$username') === false || strpos($value, '$misp') === false) return 'The text served to the users must include the following replacement strings: \"$username\", \"$password\", \"$misp\"';\n\t\treturn true;\n\t}\n\n\tpublic function testForGPGBinary($value) {\n\t\tif (empty($value)) $value = $this->serverSettings['GnuPG']['binary']['value'];\n\t\tif (file_exists($value)) return true;\n\t\treturn 'Could not find the gnupg executable at the defined location.';\n\t}\n\n\tpublic function testForRPZDuration($value) {\n\t\tif (($this->testForNumeric($value) !== true && preg_match('/^[0-9]*[mhdw]$/i', $value)) || $value >= 0) {\n\t\t\treturn true;\n\t\t} else {\n\t\t\treturn 'Negative seconds found. The following formats are accepted: seconds (positive integer), or duration (positive integer) followed by a letter denoting scale (such as m, h, d, w for minutes, hours, days, weeks)';\n\t\t}\n\t}\n\n\tpublic function testForRPZBehaviour($value) {\n\t\t$numeric = $this->testForNumeric($value);\n\t\tif ($numeric !== true) return $numeric;\n\t\tif ($value < 0 || $value > 3) return 'Invalid setting, valid range is 0-3 (0 = DROP, 1 = NXDOMAIN, 2 = NODATA, 3 = walled garden.';\n\t\treturn true;\n\t}\n\n\tpublic function testForSightingVisibility($value) {\n\t\t$numeric = $this->testForNumeric($value);\n\t\tif ($numeric !== true) return $numeric;\n\t\tif ($value < 0 || $value > 2) return 'Invalid setting, valid range is 0-2 (0 = Event owner, 1 = Sighting reporters, 2 = Everyone.';\n\t\treturn true;\n\t}\n\n\tpublic function sightingsBeforeHook($setting, $value) {\n\t\tif ($value == true) {\n\t\t\t$this->updateDatabase('addSightings');\n\t\t}\n\t\treturn true;\n\t}\n\n\tpublic function testForRPZSerial($value) {\n\t\tif ($this->testForEmpty($value) !== true) return $this->testForEmpty($value);\n\t\tif (!preg_match('/^((\\$date(\\d*)|\\d*))$/', $value)) return 'Invalid format.';\n\t\treturn true;\n\t}\n\n\tpublic function testForRPZNS($value) {\n\t\tif ($this->testForEmpty($value) !== true) return $this->testForEmpty($value);\n\t\tif (!preg_match('/^\\w+(\\.\\w+)*(\\.?) \\w+(\\.\\w+)*$/', $value)) return 'Invalid format.';\n\t\treturn true;\n\t}\n\n\tpublic function zmqAfterHook($setting, $value) {\n\t\t$pubSubTool = $this->getPubSubTool();\n\t\t// If we are trying to change the enable setting to false, we don't need to test anything, just kill the server and return true.\n\t\tif ($setting == 'Plugin.ZeroMQ_enable') {\n\t\t\tif ($value == false || $value == 0) {\n\t\t\t\t$pubSubTool->killService();\n\t\t\t\treturn true;\n\t\t\t}\n\t\t} else if (!Configure::read('Plugin.ZeroMQ_enable')) {\n\t\t\t// If we are changing any other ZeroMQ settings but the feature is disabled, don't reload the service\n\t\t\treturn true;\n\t\t}\n\t\t$pubSubTool->reloadServer();\n\t\treturn true;\n\t}\n\n\tpublic function disableCacheAfterHook($setting, $value) {\n\t\tif ($value) {\n\t\t\t$this->Event = ClassRegistry::init('Event');\n\t\t\tApp::uses('Folder', 'Utility');\n\t\t\tApp::uses('File', 'Utility');\n\t\t\t// delete all cache files\n\t\t\tforeach ($this->Event->export_types as $type => $settings) {\n\t\t\t\t$dir = new Folder(APP . 'tmp/cached_exports/' . $type);\n\t\t\t\t// No caches created for this type of export, move on\n\t\t\t\tif ($dir == null) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\t$files = $dir->find('.*' . $settings['extension']);\n\t\t\t\tforeach ($files as $file) {\n\t\t\t\t\t$file = new File($dir->pwd() . DS . $file);\n\t\t\t\t\t$file->delete();\n\t\t\t\t\t$file->close();\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n\n\tpublic function correlationAfterHook($setting, $value) {\n\t\tif (!Configure::read('MISP.background_jobs')) {\n\t\t\t$this->Attribute = ClassRegistry::init('Attribute');\n\t\t\tif ($value) {\n\t\t\t\t$k = $this->Attribute->purgeCorrelations();\n\t\t\t} else {\n\t\t\t\t$k = $this->Attribute->generateCorrelation();\n\t\t\t}\n\t\t} else {\n\t\t\t$job = ClassRegistry::init('Job');\n\t\t\t$job->create();\n\t\t\tif ($value == true) {\n\t\t\t\t$jobType = 'jobPurgeCorrelation';\n\t\t\t\t$jobTypeText = 'purge correlations';\n\t\t\t} else {\n\t\t\t\t$jobType = 'jobGenerateCorrelation';\n\t\t\t\t$jobTypeText = 'generate correlation';\n\t\t\t}\n\t\t\t$data = array(\n\t\t\t\t\t'worker' => 'default',\n\t\t\t\t\t'job_type' => $jobTypeText,\n\t\t\t\t\t'job_input' => 'All attributes',\n\t\t\t\t\t'status' => 0,\n\t\t\t\t\t'retries' => 0,\n\t\t\t\t\t'org' => 'ADMIN',\n\t\t\t\t\t'message' => 'Job created.',\n\t\t\t);\n\t\t\t$job->save($data);\n\t\t\t$jobId = $job->id;\n\t\t\t$process_id = CakeResque::enqueue(\n\t\t\t\t\t'default',\n\t\t\t\t\t'AdminShell',\n\t\t\t\t\tarray($jobType, $jobId),\n\t\t\t\t\ttrue\n\t\t\t);\n\t\t\t$job->saveField('process_id', $process_id);\n\t\t}\n\t}\n\n\tpublic function ipLogBeforeHook($setting, $value) {\n\t\tif ($setting == 'MISP.log_client_ip') {\n\t\t\tif ($value == true) {\n\t\t\t\t$this->updateDatabase('addIPLogging');\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n\n\tpublic function customAuthBeforeHook($setting, $value) {\n\t\tif ($value) $this->updateDatabase('addCustomAuth');\n\t\t$this->cleanCacheFiles();\n\t\treturn true;\n\t}\n\n\t// never come here directly, always go through a secondary check like testForTermsFile in order to also pass along the expected file path\n\tprivate function __testForFile($value, $path) {\n\t\tif ($this->testForEmpty($value) !== true) return $this->testForEmpty($value);\n\t\tif (!$this->checkFilename($value)) return 'Invalid filename.';\n\t\t$file = $path . DS . $value;\n\t\tif (!file_exists($file)) return 'Could not find the specified file. Make sure that it is uploaded into the following directory: ' . $path;\n\t\treturn true;\n\t}\n\n\tpublic function serverSettingsSaveValue($setting, $value) {\n\t\tConfigure::write($setting, $value);\n\t\t$arrayFix = array(\n\t\t\t'Security.auth',\n\t\t\t'ApacheSecureAuth.ldapFilter'\n\t\t);\n\t\tforeach ($arrayFix as $settingFix) {\n\t\t\tif (Configure::read($settingFix) && is_array(Configure::read($settingFix)) && !empty(Configure::read($settingFix))) {\n\t\t\t\t$arrayElements = array();\n\t\t\t\tforeach (Configure::read($settingFix) as $array) {\n\t\t\t\t\tif (!in_array($array, $arrayElements)) $arrayElements[] = $array;\n\t\t\t\t}\n\t\t\t\tConfigure::write($settingFix, $arrayElements);\n\t\t\t}\n\t\t}\n\t\t$settingsToSave = array('debug', 'MISP', 'GnuPG', 'SMIME', 'Proxy', 'SecureAuth', 'Security', 'Session.defaults', 'Session.timeout', 'Session.autoRegenerate', 'site_admin_debug', 'Plugin', 'CertAuth', 'ApacheShibbAuth', 'ApacheSecureAuth');\n\t\t$settingsArray = array();\n\t\tforeach ($settingsToSave as $setting) {\n\t\t\t$settingsArray[$setting] = Configure::read($setting);\n\t\t}\n\t\t$settingsString = var_export($settingsArray, true);\n\t\t$settingsString = '<?php' . \"\\n\" . '$config = ' . $settingsString . ';';\n\t\tif (function_exists('opcache_reset')) opcache_reset();\n\t\tfile_put_contents(APP . 'Config' . DS . 'config.php', $settingsString);\n\t}\n\n\tpublic function checkVersion($newest) {\n\t\t$version_array = $this->checkMISPVersion();\n\t\t$current = 'v' . $version_array['major'] . '.' . $version_array['minor'] . '.' . $version_array['hotfix'];\n\t\t$newest_array = $this->__dissectVersion($newest);\n\t\t$upToDate = $this->__compareVersions(array($version_array['major'], $version_array['minor'], $version_array['hotfix']), $newest_array, 0);\n\t\treturn array ('current' => $current, 'newest' => $newest, 'upToDate' => $upToDate);\n\t}\n\n\tprivate function __dissectVersion($version) {\n\t\t$version = substr($version, 1);\n\t\treturn explode('.', $version);\n\t}\n\n\tprivate function __compareVersions($current, $newest, $i) {\n\t\tif ($current[$i] == $newest[$i]) {\n\t\t\tif ($i < 2) {\n\t\t\t\treturn $this->__compareVersions($current, $newest, $i+1);\n\t\t\t} else {\n\t\t\t\treturn 'same';\n\t\t\t}\n\t\t} else if ($current[$i] < $newest[$i]) {\n\t\t\treturn 'older';\n\t\t} else {\n\t\t\treturn 'newer';\n\t\t}\n\t}\n\n\tpublic function getFileRules() {\n\t\t$validItems = array(\n\t\t\t\t'orgs' => array(\n\t\t\t\t\t\t'name' => 'Organisation logos',\n\t\t\t\t\t\t'description' => 'The logo used by an organisation on the event index, event view, discussions, proposals, etc. Make sure that the filename is in the org.png format, where org is the case-sensitive organisation name.',\n\t\t\t\t\t\t'expected' => array(),\n\t\t\t\t\t\t'valid_format' => '48x48 pixel .png files',\n\t\t\t\t\t\t'path' => APP . 'webroot' . DS . 'img' . DS . 'orgs',\n\t\t\t\t\t\t'regex' => '.*\\.(png|PNG)$',\n\t\t\t\t\t\t'regex_error' => 'Filename must be in the following format: *.png',\n\t\t\t\t\t\t'files' => array(),\n\t\t\t\t),\n\t\t\t\t'img' => array(\n\t\t\t\t\t\t'name' => 'Additional image files',\n\t\t\t\t\t\t'description' => 'Image files uploaded into this directory can be used for various purposes, such as for the login page logos',\n\t\t\t\t\t\t'expected' => array(\n\t\t\t\t\t\t\t\t'MISP.footer_logo' => Configure::read('MISP.footer_logo'),\n\t\t\t\t\t\t\t\t'MISP.home_logo' => Configure::read('MISP.home_logo'),\n\t\t\t\t\t\t\t\t'MISP.welcome_logo' => Configure::read('MISP.welcome_logo'),\n\t\t\t\t\t\t\t\t'MISP.welcome_logo2' => Configure::read('MISP.welcome_logo2'),\n\t\t\t\t\t\t),\n\t\t\t\t\t\t'valid_format' => 'text/html if served inline, anything that conveys the terms of use if served as download',\n\t\t\t\t\t\t'path' => APP . 'webroot' . DS . 'img' . DS . 'custom',\n\t\t\t\t\t\t'regex' => '.*\\.(png|PNG)$',\n\t\t\t\t\t\t'regex_error' => 'Filename must be in the following format: *.png',\n\t\t\t\t\t\t'files' => array(),\n\t\t\t\t),\n\t\t);\n\t\treturn $validItems;\n\t}\n\n\tpublic function grabFiles() {\n\t\t$validItems = $this->getFileRules();\n\t\tApp::uses('Folder', 'Utility');\n\t\tApp::uses('File', 'Utility');\n\t\tforeach ($validItems as $k => $item) {\n\t\t\t$dir = new Folder($item['path']);\n\t\t\t$files = $dir->find($item['regex'], true);\n\t\t\tforeach ($files as $file) {\n\t\t\t\t$f = new File($item['path'] . DS . $file);\n\t\t\t\t$validItems[$k]['files'][] = array('filename' => $file, 'filesize' => $f->size(), 'read' => $f->readable(), 'write' => $f->writable(), 'execute' => $f->executable());\n\t\t\t}\n\t\t}\n\t\treturn $validItems;\n\t}\n\n\tpublic function runConnectionTest($id) {\n\t\t$server = $this->find('first', array('conditions' => array('Server.id' => $id)));\n\t\tApp::uses('SyncTool', 'Tools');\n\t\t$syncTool = new SyncTool();\n\t\t$HttpSocket = $syncTool->setupHttpSocket($server);\n\t\t$request = array(\n\t\t\t'header' => array(\n\t\t\t\t'Authorization' => $server['Server']['authkey'],\n\t\t\t\t'Accept' => 'application/json',\n\t\t\t\t'Content-Type' => 'application/json',\n\t\t\t)\n\t\t);\n\t\t$uri = $server['Server']['url'] . '/servers/getVersion';\n\t\ttry {\n\t\t\t$response = $HttpSocket->get($uri, false, $request);\n\t\t} catch (Exception $e) {\n\t\t\t$this->Log = ClassRegistry::init('Log');\n\t\t\t$this->Log->create();\n\t\t\t$this->Log->save(array(\n\t\t\t\t\t'org' => 'SYSTEM',\n\t\t\t\t\t'model' => 'Server',\n\t\t\t\t\t'model_id' => $id,\n\t\t\t\t\t'email' => 'SYSTEM',\n\t\t\t\t\t'action' => 'error',\n\t\t\t\t\t'user_id' => 0,\n\t\t\t\t\t'title' => 'Error: Connection test failed. Reason: ' . json_encode($e->getMessage()),\n\t\t\t));\n\t\t\treturn array('status' => 2);\n\t\t}\n\t\tif ($response->isOk()) {\n\t\t\treturn array('status' => 1, 'message' => $response->body());\n\t\t} else {\n\t\t\tif ($response->code == '403') return array('status' => 4);\n\t\t\tif ($response->code == '405') {\n\t\t\t\ttry {\n\t\t\t\t\t$responseText = json_decode($response->body, true)['message'];\n\t\t\t\t} catch (Exception $e) {\n\t\t\t\t\treturn array('status' => 3);\n\t\t\t\t}\n\t\t\t\tif ($responseText === 'Your user account is expecting a password change, please log in via the web interface and change it before proceeding.') return array('status' => 5);\n\t\t\t\telse if ($responseText === 'You have not accepted the terms of use yet, please log in via the web interface and accept them.') return array('status' => 6);\n\t\t\t}\n\t\t\treturn array('status' => 3);\n\t\t}\n\t}\n\n\tpublic function runPOSTtest($id) {\n\t\t$server = $this->find('first', array('conditions' => array('Server.id' => $id)));\n\t\tApp::uses('SyncTool', 'Tools');\n\t\t$syncTool = new SyncTool();\n\t\t$HttpSocket = $syncTool->setupHttpSocket($server);\n\t\t$request = array(\n\t\t\t'header' => array(\n\t\t\t\t'Authorization' => $server['Server']['authkey'],\n\t\t\t\t'Accept' => 'application/json',\n\t\t\t\t'Content-Type' => 'application/json',\n\t\t\t)\n\t\t);\n\t\t$testFile = file_get_contents(APP . 'files/scripts/test_payload.txt');\n\t\t$uri = $server['Server']['url'] . '/servers/postTest';\n\t\t$this->Log = ClassRegistry::init('Log');\n\t\ttry {\n\t\t\t$response = $HttpSocket->post($uri, json_encode(array('testString' => $testFile)), $request);\n\t\t\t$response = json_decode($response, true);\n\t\t} catch (Exception $e) {\n\t\t\t$this->Log->create();\n\t\t\t$this->Log->save(array(\n\t\t\t\t\t'org' => 'SYSTEM',\n\t\t\t\t\t'model' => 'Server',\n\t\t\t\t\t'model_id' => $id,\n\t\t\t\t\t'email' => 'SYSTEM',\n\t\t\t\t\t'action' => 'error',\n\t\t\t\t\t'user_id' => 0,\n\t\t\t\t\t'title' => 'Error: POST connection test failed. Reason: ' . json_encode($e->getMessage()),\n\t\t\t));\n\t\t\treturn 8;\n\t\t}\n\t\tif (!isset($response['body']['testString']) || $response['body']['testString'] !== $testFile) {\n\t\t\t$responseString = isset($response['body']['testString']) ? $response['body']['testString'] : 'Response was empty.';\n\t\t\t$this->Log->create();\n\t\t\t$this->Log->save(array(\n\t\t\t\t\t'org' => 'SYSTEM',\n\t\t\t\t\t'model' => 'Server',\n\t\t\t\t\t'model_id' => $id,\n\t\t\t\t\t'email' => 'SYSTEM',\n\t\t\t\t\t'action' => 'error',\n\t\t\t\t\t'user_id' => 0,\n\t\t\t\t\t'title' => 'Error: POST connection test failed due to the message body not containing the expected data. Response: ' . PHP_EOL . PHP_EOL . $responseString,\n\t\t\t));\n\t\t\treturn 9;\n\t\t}\n\t\t$headers = array('Accept', 'Content-type');\n\t\tforeach ($headers as $header) {\n\t\t\tif (!isset($response['headers'][$header]) || $response['headers'][$header] != 'application/json') {\n\t\t\t\t$responseHeader = isset($response['headers'][$header]) ? $response['headers'][$header] : 'Header was not set.';\n\t\t\t\t$this->Log->create();\n\t\t\t\t$this->Log->save(array(\n\t\t\t\t\t\t'org' => 'SYSTEM',\n\t\t\t\t\t\t'model' => 'Server',\n\t\t\t\t\t\t'model_id' => $id,\n\t\t\t\t\t\t'email' => 'SYSTEM',\n\t\t\t\t\t\t'action' => 'error',\n\t\t\t\t\t\t'user_id' => 0,\n\t\t\t\t\t\t'title' => 'Error: POST connection test failed due to a header not matching the expected value. Expected: \"application/json\", received \"' . $responseHeader,\n\t\t\t\t));\n\t\t\t\treturn 10;\n\t\t\t}\n\t\t}\n\t\treturn 1;\n\t}\n\n\tpublic function checkVersionCompatibility($id, $user = array(), $HttpSocket = false) {\n\t\t// for event publishing when we don't have a user.\n\t\tif (empty($user)) $user = array('Organisation' => array('name' => 'SYSTEM'), 'email' => 'SYSTEM', 'id' => 0);\n\t\tApp::uses('Folder', 'Utility');\n\t\t$file = new File(ROOT . DS . 'VERSION.json', true);\n\t\t$localVersion = json_decode($file->read(), true);\n\t\t$file->close();\n\t\t$server = $this->find('first', array('conditions' => array('Server.id' => $id)));\n\t\tif (!$HttpSocket) {\n\t\t\tApp::uses('SyncTool', 'Tools');\n\t\t\t$syncTool = new SyncTool();\n\t\t\t$HttpSocket = $syncTool->setupHttpSocket($server);\n\t\t}\n\t\t$uri = $server['Server']['url'] . '/servers/getVersion';\n\t\t$request = array(\n\t\t\t\t'header' => array(\n\t\t\t\t\t\t'Authorization' => $server['Server']['authkey'],\n\t\t\t\t\t\t'Accept' => 'application/json',\n\t\t\t\t\t\t'Content-Type' => 'application/json',\n\t\t\t\t)\n\t\t);\n\t\ttry {\n\t\t\t$response = $HttpSocket->get($uri, '', $request);\n\t\t} catch (Exception $e) {\n\t\t\tif (!isset($response) || $response->code != '200') {\n\t\t\t\t$this->Log = ClassRegistry::init('Log');\n\t\t\t\t$this->Log->create();\n\t\t\t\tif (isset($response->code)) {\n\t\t\t\t\t$title = 'Error: Connection to the server has failed.' . isset($response->code) ? ' Returned response code: ' . $response->code : '';\n\t\t\t\t} else {\n\t\t\t\t\t$title = 'Error: Connection to the server has failed. The returned exception\\'s error message was: ' . $e->getMessage();\n\t\t\t\t}\n\t\t\t\t$this->Log->save(array(\n\t\t\t\t\t\t'org' => $user['Organisation']['name'],\n\t\t\t\t\t\t'model' => 'Server',\n\t\t\t\t\t\t'model_id' => $id,\n\t\t\t\t\t\t'email' => $user['email'],\n\t\t\t\t\t\t'action' => 'error',\n\t\t\t\t\t\t'user_id' => $user['id'],\n\t\t\t\t\t\t'title' => $title,\n\t\t\t\t));\n\t\t\t}\n\t\t}\n\t\tif (!isset($response) || $response->code != '200') {\n\t\t\treturn 1;\n\t\t}\n\t\t$remoteVersion = json_decode($response->body, true);\n\t\t$canPush = isset($remoteVersion['perm_sync']) ? $remoteVersion['perm_sync'] : false;\n\t\t$remoteVersion = explode('.', $remoteVersion['version']);\n\t\tif (!isset($remoteVersion[0])) {\n\t\t\t$this->Log = ClassRegistry::init('Log');\n\t\t\t$this->Log->create();\n\t\t\t$this->Log->save(array(\n\t\t\t\t\t'org' => $user['Organisation']['name'],\n\t\t\t\t\t'model' => 'Server',\n\t\t\t\t\t'model_id' => $id,\n\t\t\t\t\t'email' => $user['email'],\n\t\t\t\t\t'action' => 'error',\n\t\t\t\t\t'user_id' => $user['id'],\n\t\t\t\t\t'title' => 'Error: Server didn\\'t send the expected response. This may be because the remote server version is outdated.',\n\t\t\t));\n\t\t\treturn 2;\n\t\t}\n\t\t$response = false;\n\t\t$success = false;\n\t\t$issueLevel = \"warning\";\n\t\tif ($localVersion['major'] > $remoteVersion[0]) $response = \"Sync to Server ('\" . $id . \"') aborted. The remote instance's MISP version is behind by a major version.\";\n\t\tif ($response === false && $localVersion['major'] < $remoteVersion[0]) {\n\t\t\t$response = \"Sync to Server ('\" . $id . \"') aborted. The remote instance is at least a full major version ahead - make sure you update your MISP instance!\";\n\t\t}\n\t\tif ($response === false && $localVersion['minor'] > $remoteVersion[1]) $response = \"Sync to Server ('\" . $id . \"') aborted. The remote instance's MISP version is behind by a minor version.\";\n\t\tif ($response === false && $localVersion['minor'] < $remoteVersion[1]) {\n\t\t\t$response = \"Sync to Server ('\" . $id . \"') aborted. The remote instance is at least a full minor version ahead - make sure you update your MISP instance!\";\n\t\t}\n\n\t\t// if we haven't set a message yet, we're good to go. We are only behind by a hotfix version\n\t\tif ($response === false) {\n\t\t\t$success = true;\n\t\t}\n\t\telse $issueLevel = \"error\";\n\t\tif ($response === false && $localVersion['hotfix'] > $remoteVersion[2]) $response = \"Sync to Server ('\" . $id . \"') initiated, but the remote instance is a few hotfixes behind.\";\n\t\tif ($response === false && $localVersion['hotfix'] < $remoteVersion[2]) $response = \"Sync to Server ('\" . $id . \"') initiated, but the remote instance is a few hotfixes ahead. Make sure you keep your instance up to date!\";\n\n\t\tif ($response !== false) {\n\t\t\t$this->Log = ClassRegistry::init('Log');\n\t\t\t$this->Log->create();\n\t\t\t$this->Log->save(array(\n\t\t\t\t\t'org' => $user['Organisation']['name'],\n\t\t\t\t\t'model' => 'Server',\n\t\t\t\t\t'model_id' => $id,\n\t\t\t\t\t'email' => $user['email'],\n\t\t\t\t\t'action' => $issueLevel,\n\t\t\t\t\t'user_id' => $user['id'],\n\t\t\t\t\t'title' => ucfirst($issueLevel) . ': ' . $response,\n\t\t\t));\n\t\t}\n\t\treturn array('success' => $success, 'response' => $response, 'canPush' => $canPush, 'version' => $remoteVersion);\n\t}\n\n\t/* This is a fallback for legacy remote instances that don't report back the current user's sync permission.\n\t *\n\t * The idea is simple: If we have no way of determining the perm_sync flag from the remote instance, request\n\t * /servers/testConnection from the remote. This API is used to check the remote connectivity and expects an ID to be passed\n\t * In this case however we are not passing an ID so ideally it will return 404, meaning that the instance is invalid.\n\t * We are abusing the fact that only sync users can use this functionality, if we don't have sync permission we'll get a 403\n\t * instead of the 404. It's hacky but it works fine and serves the purpose.\n\t */\n\tpublic function checkLegacyServerSyncPrivilege($id, $HttpSocket = false) {\n\t\t$server = $this->find('first', array('conditions' => array('Server.id' => $id)));\n\t\tif (!$HttpSocket) {\n\t\t\tApp::uses('SyncTool', 'Tools');\n\t\t\t$syncTool = new SyncTool();\n\t\t\t$HttpSocket = $syncTool->setupHttpSocket($server);\n\t\t}\n\t\t$uri = $server['Server']['url'] . '/servers/testConnection';\n\t\t$request = array(\n\t\t\t\t'header' => array(\n\t\t\t\t\t\t'Authorization' => $server['Server']['authkey'],\n\t\t\t\t\t\t'Accept' => 'application/json',\n\t\t\t\t\t\t'Content-Type' => 'application/json',\n\t\t\t\t)\n\t\t);\n\t\ttry {\n\t\t\t$response = $HttpSocket->get($uri, '', $request);\n\t\t} catch (Exception $e) {\n\t\t\treturn false;\n\t\t}\n\t\tif ($response->code == '404') {\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\tpublic function isJson($string) {\n\t\treturn (json_last_error() == JSON_ERROR_NONE);\n\t}\n\n\tpublic function captureServer($server, $user) {\n\t\tif (isset($server[0])) $server = $server[0];\n\t\tif ($server['url'] == Configure::read('MISP.baseurl')) return 0;\n\t\t$existingServer = $this->find('first', array(\n\t\t\t\t'recursive' => -1,\n\t\t\t\t'conditions' => array('url' => $server['url'])\n\t\t));\n\t\t// unlike with other capture methods, if we find a server that we don't know\n\t\t// we don't want to save it.\n\t\tif (empty($existingServer)) {\n\t\t\treturn false;\n\t\t}\n\t\treturn $existingServer[$this->alias]['id'];\n\t}\n\n\tpublic function writeableDirsDiagnostics(&$diagnostic_errors) {\n\t\tApp::uses('File', 'Utility');\n\t\tApp::uses('Folder', 'Utility');\n\t\t// check writeable directories\n\t\t$writeableDirs = array(\n\t\t\t\t'/tmp' => 0,\n\t\t\t\tAPP . 'tmp' => 0,\n\t\t\t\tAPP . 'files' => 0,\n\t\t\t\tAPP . 'files' . DS . 'scripts' . DS . 'tmp' => 0,\n\t\t\t\tAPP . 'tmp' . DS . 'csv_all' => 0,\n\t\t\t\tAPP . 'tmp' . DS . 'csv_sig' => 0,\n\t\t\t\tAPP . 'tmp' . DS . 'md5' => 0,\n\t\t\t\tAPP . 'tmp' . DS . 'sha1' => 0,\n\t\t\t\tAPP . 'tmp' . DS . 'snort' => 0,\n\t\t\t\tAPP . 'tmp' . DS . 'suricata' => 0,\n\t\t\t\tAPP . 'tmp' . DS . 'text' => 0,\n\t\t\t\tAPP . 'tmp' . DS . 'xml' => 0,\n\t\t\t\tAPP . 'tmp' . DS . 'files' => 0,\n\t\t\t\tAPP . 'tmp' . DS . 'logs' => 0,\n\t\t\t\tAPP . 'tmp' . DS . 'bro' => 0,\n\t\t);\n\t\tforeach ($writeableDirs as $path => &$error) {\n\t\t\t$dir = new Folder($path);\n\t\t\tif (is_null($dir->path)) $error = 1;\n\t\t\t$file = new File($path . DS . 'test.txt', true);\n\t\t\tif ($error == 0 && !$file->write('test')) $error = 2;\n\t\t\tif ($error != 0) $diagnostic_errors++;\n\t\t\t$file->delete();\n\t\t\t$file->close();\n\t\t}\n\t\treturn $writeableDirs;\n\t}\n\n\tpublic function writeableFilesDiagnostics(&$diagnostic_errors) {\n\t\t$writeableFiles = array(\n\t\t\t\tAPP . 'Config' . DS . 'config.php' => 0,\n\t\t);\n\t\tforeach ($writeableFiles as $path => &$error) {\n\t\t\tif (!file_exists($path)) {\n\t\t\t\t$error = 1;\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (!is_writeable($path)) {\n\t\t\t\t$error = 2;\n\t\t\t\t$diagnostic_errors++;\n\t\t\t}\n\t\t}\n\t\treturn $writeableFiles;\n\t}\n\n\tpublic function readableFilesDiagnostics(&$diagnostic_errors) {\n\t\t$readableFiles = array(\n\t\t\t\tAPP . 'files' . DS . 'scripts' . DS . 'stixtest.py' => 0\n\t\t);\n\t\tforeach ($readableFiles as $path => &$error) {\n\t\t\tif (!is_readable($path)) {\n\t\t\t\t$error = 1;\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t}\n\t\treturn $readableFiles;\n\t}\n\n\tpublic function stixDiagnostics(&$diagnostic_errors, &$stixVersion, &$cyboxVersion, &$mixboxVersion) {\n\t\t$result = array();\n\t\t$expected = array('stix' => '1.1.1.4', 'cybox' => '2.1.0.12', 'mixbox' => '1.0.2');\n\t\t// check if the STIX and Cybox libraries are working using the test script stixtest.py\n\t\t$scriptResult = shell_exec('python ' . APP . 'files' . DS . 'scripts' . DS . 'stixtest.py');\n\t\t$scriptResult = json_decode($scriptResult, true);\n\t\tif ($scriptResult !== null) {\n\t\t\t$scriptResult['operational'] = $scriptResult['success'];\n\t\t\tif ($scriptResult['operational'] == 0) {\n\t\t\t\t$diagnostic_errors++;\n\t\t\t\treturn array('operational' => 0, 'stix' => array('expected' => $expected['stix']), 'cybox' => array('expected' => $expected['cybox']), 'mixbox' => array('expected' => $expected['mixbox']));\n\t\t\t}\n\t\t} else {\n\t\t\treturn array('operational' => 0, 'stix' => array('expected' => $expected['stix']), 'cybox' => array('expected' => $expected['cybox']), 'mixbox' => array('expected' => $expected['mixbox']));\n\t\t}\n\t\t$result['operational'] = $scriptResult['operational'];\n\t\tforeach ($expected as $package => $version) {\n\t\t\t$result[$package]['version'] = $scriptResult[$package];\n\t\t\t$result[$package]['expected'] = $expected[$package];\n\t\t\t$result[$package]['status'] = $result[$package]['version'] == $result[$package]['expected'] ? 1 : 0;\n\t\t\tif ($result[$package]['status'] == 0) $diagnostic_errors++;\n\t\t\t${$package . 'Version'}[0] = str_replace('$current', $result[$package]['version'], ${$package . 'Version'}[0]);\n\t\t\t${$package . 'Version'}[0] = str_replace('$expected', $result[$package]['expected'], ${$package . 'Version'}[0]);\n\t\t}\n\t\treturn $result;\n\t}\n\n\tpublic function gpgDiagnostics(&$diagnostic_errors) {\n\t\t$gpgStatus = 0;\n\t\tif (Configure::read('GnuPG.email') && Configure::read('GnuPG.homedir')) {\n\t\t\t$continue = true;\n\t\t\ttry {\n\t\t\t\trequire_once 'Crypt/GPG.php';\n\t\t\t\t$gpg = new Crypt_GPG(array('homedir' => Configure::read('GnuPG.homedir'), 'binary' => (Configure::read('GnuPG.binary') ? Configure::read('GnuPG.binary') : '/usr/bin/gpg')));\n\t\t\t} catch (Exception $e) {\n\t\t\t\t$gpgStatus = 2;\n\t\t\t\t$continue = false;\n\t\t\t}\n\t\t\tif ($continue) {\n\t\t\t\ttry {\n\t\t\t\t\t$key = $gpg->addSignKey(Configure::read('GnuPG.email'), Configure::read('GnuPG.password'));\n\t\t\t\t} catch (Exception $e) {\n\t\t\t\t\t$gpgStatus = 3;\n\t\t\t\t\t$continue = false;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif ($continue) {\n\t\t\t\ttry {\n\t\t\t\t\t$gpgStatus = 0;\n\t\t\t\t\t$signed = $gpg->sign('test', Crypt_GPG::SIGN_MODE_CLEAR);\n\t\t\t\t} catch (Exception $e) {\n\t\t\t\t\t$gpgStatus = 4;\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\t$gpgStatus = 1;\n\t\t}\n\t\tif ($gpgStatus != 0) $diagnostic_errors++;\n\t\treturn $gpgStatus;\n\t}\n\n\tpublic function zmqDiagnostics(&$diagnostic_errors) {\n\t\tif (!Configure::read('Plugin.ZeroMQ_enable')) return 1;\n\t\t$pubSubTool = $this->getPubSubTool();\n\t\tif (!$pubSubTool->checkIfPythonLibInstalled()) {\n\t\t\t$diagnostic_errors++;\n\t\t\treturn 2;\n\t\t}\n\t\tif ($pubSubTool->checkIfRunning()) return 0;\n\t\t$diagnostic_errors++;\n\t\treturn 3;\n\t}\n\n\tpublic function moduleDiagnostics(&$diagnostic_errors, $type = 'Enrichment') {\n\t\t$this->Module = ClassRegistry::init('Module');\n\t\t$types = array('Enrichment', 'Import', 'Export', 'Cortex');\n\t\t$diagnostic_errors++;\n\t\tif (Configure::read('Plugin.' . $type . '_services_enable')) {\n\t\t\t$exception = false;\n\t\t\t$result = $this->Module->getModules(false, $type, $exception);\n\t\t\tif ($exception) return $exception;\n\t\t\tif (empty($result)) return 2;\n\t\t\t$diagnostic_errors--;\n\t\t\treturn 0;\n\t\t}\n\t\treturn 1;\n\t}\n\n\tpublic function proxyDiagnostics(&$diagnostic_errors) {\n\t\t$proxyStatus = 0;\n\t\t$proxy = Configure::read('Proxy');\n\t\tif (!empty($proxy['host'])) {\n\t\t\tApp::uses('SyncTool', 'Tools');\n\t\t\t$syncTool = new SyncTool();\n\t\t\ttry {\n\t\t\t\t$HttpSocket = $syncTool->setupHttpSocket();\n\t\t\t\t$proxyResponse = $HttpSocket->get('http://www.example.com/');\n\t\t\t} catch (Exception $e) {\n\t\t\t\t$proxyStatus = 2;\n\t\t\t}\n\t\t\tif (empty($proxyResponse) || $proxyResponse->code > 399) {\n\t\t\t\t$proxyStatus = 2;\n\t\t\t}\n\t\t} else {\n\t\t\t$proxyStatus = 1;\n\t\t}\n\t\tif ($proxyStatus > 1) $diagnostic_errors++;\n\t\treturn $proxyStatus;\n\t}\n\n\tpublic function sessionDiagnostics(&$diagnostic_errors = 0, &$sessionCount = '') {\n\t\tif (Configure::read('Session.defaults') !== 'database') {\n\t\t\t$sessionCount = 'N/A';\n\t\t\treturn 2;\n\t\t}\n\t\t$sql = 'SELECT COUNT(id) AS session_count FROM cake_sessions WHERE expires < ' . time() . ';';\n\t\t$sqlResult = $this->query($sql);\n\t\tif (isset($sqlResult[0][0])) $sessionCount = $sqlResult[0][0]['session_count'];\n\t\telse {\n\t\t\t$sessionCount = 'Error';\n\t\t\treturn 3;\n\t\t}\n\t\tif ($sessionCount > 1000) {\n\t\t\t$diagnostic_errors++;\n\t\t\treturn 1;\n\t\t}\n\t\treturn 0;\n\t}\n\n\tpublic function workerDiagnostics(&$workerIssueCount) {\n\t\ttry {\n\t\t\t$this->ResqueStatus = new ResqueStatus\\ResqueStatus(Resque::redis());\n\t\t} catch (Exception $e) {\n\t\t\t// redis connection failed\n\t\t\treturn array(\n\t\t\t\t\t'cache' => array('ok' => false),\n\t\t\t\t\t'default' => array('ok' => false),\n\t\t\t\t\t'email' => array('ok' => false),\n\t\t\t\t\t'prio' => array('ok' => false),\n\t\t\t\t\t'scheduler' => array('ok' => false)\n\t\t\t);\n\t\t}\n\t\t$workers = $this->ResqueStatus->getWorkers();\n\t\tif (function_exists('posix_getpwuid')) {\n\t\t\t$currentUser = posix_getpwuid(posix_geteuid());\n\t\t\t$currentUser = $currentUser['name'];\n\t\t} else {\n\t\t\t$currentUser = trim(shell_exec('whoami'));\n\t\t}\n\t\t$worker_array = array(\n\t\t\t\t'cache' => array('ok' => true),\n\t\t\t\t'default' => array('ok' => true),\n\t\t\t\t'email' => array('ok' => true),\n\t\t\t\t'prio' => array('ok' => true),\n\t\t\t\t'scheduler' => array('ok' => true)\n\t\t);\n\t\t$procAccessible = file_exists('/proc');\n\t\tforeach ($workers as $pid => $worker) {\n\t\t\t$entry = ($worker['type'] == 'regular') ? $worker['queue'] : $worker['type'];\n\t\t\t$correct_user = ($currentUser === $worker['user']);\n\t\t\tif (!is_numeric($pid)) throw new MethodNotAllowedException('Non numeric PID found.');\n\t\t\tif ($procAccessible) {\n\t\t\t\t$alive = $correct_user ? (file_exists('/proc/' . addslashes($pid))) : false;\n\t\t\t} else {\n\t\t\t\t$alive = 'N/A';\n\t\t\t}\n\t\t\t$ok = true;\n\t\t\tif (!$alive || !$correct_user) {\n\t\t\t\t$ok = false;\n\t\t\t\t$workerIssueCount++;\n\t\t\t\t$worker_array[$entry]['ok'] = false;\n\t\t\t}\n\t\t\t$worker_array[$entry]['workers'][] = array('pid' => $pid, 'user' => $worker['user'], 'alive' => $alive, 'correct_user' => $correct_user, 'ok' => $ok);\n\t\t}\n\t\tforeach ($worker_array as $k => $queue) {\n\t\t\tif ($k != 'scheduler') $worker_array[$k]['jobCount'] = CakeResque::getQueueSize($k);\n\t\t\tif (!isset($queue['workers'])) {\n\t\t\t\t$workerIssueCount++;\n\t\t\t\t$worker_array[$k]['ok'] = false;\n\t\t\t}\n\t\t}\n\t\t$worker_array['proc_accessible'] = $procAccessible;\n\t\treturn $worker_array;\n\t}\n\n\tpublic function retrieveCurrentSettings($branch, $subString) {\n\t\t$settings = array();\n\t\tforeach ($this->serverSettings[$branch] as $settingName => $setting) {\n\t\t\tif (strpos($settingName, $subString) !== false) {\n\t\t\t\t$settings[$settingName] = $setting['value'];\n\t\t\t\tif (Configure::read('Plugin.' . $settingName)) $settings[$settingName] = Configure::read('Plugin.' . $settingName);\n\t\t\t\tif (isset($setting['options'])) $settings[$settingName] = $setting['options'][$settings[$settingName]];\n\t\t\t}\n\t\t}\n\t\treturn $settings;\n\t}\n\n\tpublic function killWorker($pid, $user) {\n\t\tif (!is_numeric($pid)) throw new MethodNotAllowedException('Non numeric PID found!');\n\t\t$this->ResqueStatus = new ResqueStatus\\ResqueStatus(Resque::redis());\n\t\t$workers = $this->ResqueStatus->getWorkers();\n\t\t$this->Log = ClassRegistry::init('Log');\n\t\tif (isset($workers[$pid])) {\n\t\t\t$worker = $workers[$pid];\n\t\t\tif (substr_count(trim(shell_exec('ps -p ' . $pid)), PHP_EOL) > 0 ? true : false) {\n\t\t\t\tshell_exec('kill ' . $pid . ' > /dev/null 2>&1 &');\n\t\t\t\t$this->Log->create();\n\t\t\t\t$this->Log->save(array(\n\t\t\t\t\t\t'org' => $user['Organisation']['name'],\n\t\t\t\t\t\t'model' => 'User',\n\t\t\t\t\t\t'model_id' => $user['id'],\n\t\t\t\t\t\t'email' => $user['email'],\n\t\t\t\t\t\t'action' => 'stop_worker',\n\t\t\t\t\t\t'user_id' => $user['id'],\n\t\t\t\t\t\t'title' => 'Stopping a worker.',\n\t\t\t\t\t\t'change' => 'Stopping a worker. Worker was of type ' . $worker['queue'] . ' with pid ' . $pid\n\t\t\t\t));\n\t\t\t} else {\n\t\t\t\t$this->ResqueStatus->removeWorker($pid);\n\t\t\t\t$this->Log->create();\n\t\t\t\t$this->Log->save(array(\n\t\t\t\t\t\t'org' => $user['Organisation']['name'],\n\t\t\t\t\t\t'model' => 'User',\n\t\t\t\t\t\t'model_id' => $user['id'],\n\t\t\t\t\t\t'email' => $user['email'],\n\t\t\t\t\t\t'action' => 'remove_dead_workers',\n\t\t\t\t\t\t'user_id' => $user['id'],\n\t\t\t\t\t\t'title' => 'Removing a dead worker.',\n\t\t\t\t\t\t'change' => 'Removing dead worker data. Worker was of type ' . $worker['queue'] . ' with pid ' . $pid\n\t\t\t\t));\n\t\t\t}\n\t\t\t$this->ResqueStatus->removeWorker($pid);\n\t\t}\n\t}\n\n\tpublic function workerRemoveDead($user) {\n\t\t$this->ResqueStatus = new ResqueStatus\\ResqueStatus(Resque::redis());\n\t\t$workers = $this->ResqueStatus->getWorkers();\n\t\t$this->Log = ClassRegistry::init('Log');\n\t\tif (function_exists('posix_getpwuid')) {\n\t\t\t$currentUser = posix_getpwuid(posix_geteuid());\n\t\t\t$currentUser = $currentUser['name'];\n\t\t} else $currentUser = trim(shell_exec('whoami'));\n\t\tforeach ($workers as $pid => $worker) {\n\t\t\tif (!is_numeric($pid)) throw new MethodNotAllowedException('Non numeric PID found!');\n\t\t\t$pidTest = substr_count(trim(shell_exec('ps -p ' . $pid)), PHP_EOL) > 0 ? true : false;\n\t\t\tif ($worker['user'] == $currentUser && !$pidTest) {\n\t\t\t\t$this->ResqueStatus->removeWorker($pid);\n\t\t\t\t$this->Log->create();\n\t\t\t\t$this->Log->save(array(\n\t\t\t\t\t\t'org' => $user['Organisation']['name'],\n\t\t\t\t\t\t'model' => 'User',\n\t\t\t\t\t\t'model_id' => $user['id'],\n\t\t\t\t\t\t'email' => $user['email'],\n\t\t\t\t\t\t'action' => 'remove_dead_workers',\n\t\t\t\t\t\t'user_id' => $user['id'],\n\t\t\t\t\t\t'title' => 'Removing a dead worker.',\n\t\t\t\t\t\t'change' => 'Removing dead worker data. Worker was of type ' . $worker['queue'] . ' with pid ' . $pid\n\t\t\t\t));\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic function upgrade2324($user_id, $jobId = false) {\n\t\t$this->cleanCacheFiles();\n\t\tif (Configure::read('MISP.background_jobs') && $jobId) {\n\t\t\t$this->Job = ClassRegistry::init('Job');\n\t\t\t$this->Job->id = $jobId;\n\t\t}\n\t\t$this->Log = ClassRegistry::init('Log');\n\t\t$this->Organisation = ClassRegistry::init('Organisation');\n\t\t$this->Attribute = ClassRegistry::init('Attribute');\n\t\t$this->Log->create();\n\t\t$this->Log->save(array(\n\t\t\t\t'org' => 'SYSTEM',\n\t\t\t\t'model' => 'Server',\n\t\t\t\t'model_id' => 0,\n\t\t\t\t'email' => 'SYSTEM',\n\t\t\t\t'action' => 'upgrade_24',\n\t\t\t\t'user_id' => 0,\n\t\t\t\t'title' => 'Upgrade initiated',\n\t\t\t\t'change' => 'Starting the migration of the database to 2.4',\n\t\t));\n\t\tif (Configure::read('MISP.background_jobs') && $jobId) {\n\t\t\t$this->Job->saveField('progress', 10);\n\t\t\t$this->Job->saveField('message', 'Starting the migration of the database to 2.4');\n\t\t}\n\t\t$this->query('UPDATE roles SET perm_template = 1 WHERE perm_site_admin = 1 OR perm_admin = 1');\n\t\t$this->query('UPDATE roles SET perm_sharing_group = 1 WHERE perm_site_admin = 1 OR perm_sync = 1');\n\t\t$orgs = array('local' => array(), 'external' => array());\n\t\t$captureRules = array(\n\t\t\t\t'events_org' => array('table' => 'events', 'old' => 'org', 'new' => 'org_id'),\n\t\t\t\t'events_orgc' => array('table' => 'events', 'old' => 'orgc', 'new' => 'orgc_id'),\n\t\t\t\t'jobs_org' => array('table' => 'jobs', 'old' => 'org', 'new' => 'org_id'),\n\t\t\t\t'servers_org' => array('table' => 'servers', 'old' => 'org', 'new' => 'org_id'),\n\t\t\t\t'servers_organization' => array('table' => 'servers', 'old' => 'organization', 'new' => 'remote_org_id'),\n\t\t\t\t'shadow_attributes_org' => array('table' => 'shadow_attributes', 'old' => 'org', 'new' => 'org_id'),\n\t\t\t\t'shadow_attributes_event_org' => array('table' => 'shadow_attributes', 'old' => 'event_org', 'new' => 'event_org_id'),\n\t\t\t\t'threads_org' => array('table' => 'threads', 'old' => 'org', 'new' => 'org_id'),\n\t\t\t\t'users_org' => array('table' => 'users', 'old' => 'org', 'new' => 'org_id'),\n\t\t);\n\t\t$rules = array(\n\t\t\t\t'local' => array(\n\t\t\t\t\t\t$captureRules['users_org'],\n\t\t\t\t),\n\t\t\t\t'external' => array(\n\t\t\t\t\t\t$captureRules['events_org'],\n\t\t\t\t\t\t$captureRules['events_orgc'],\n\t\t\t\t\t\t$captureRules['shadow_attributes_event_org'],\n\t\t\t\t\t\t$captureRules['shadow_attributes_org'],\n\t\t\t\t\t\t$captureRules['servers_organization'],\n\t\t\t\t\t\t$captureRules['threads_org'],\n\t\t\t\t\t\t$captureRules['jobs_org'],\n\t\t\t\t\t\t$captureRules['servers_org'],\n\t\t\t\t)\n\t\t);\n\t\tforeach ($rules as $k => $type) {\n\t\t\tforeach ($type as $rule) {\n\t\t\t\t$temp = ($this->query('SELECT DISTINCT(`' . $rule['old'] . '`) from `' . $rule['table'] . '` WHERE ' . $rule['new'] . '= \"\";'));\n\t\t\t\tforeach ($temp as $t) {\n\t\t\t\t\t// in case we have something in the db with a missing org, let's hop over that\n\t\t\t\t\tif ($t[$rule['table']][$rule['old']] !== '') {\n\t\t\t\t\t\tif ($k == 'local' && !in_array($t[$rule['table']][$rule['old']], $orgs[$k])) $orgs[$k][] = $t[$rule['table']][$rule['old']];\n\t\t\t\t\t\telse if ($k == 'external' && !in_array($t[$rule['table']][$rule['old']], $orgs['local']) && !in_array($t[$rule['table']][$rule['old']], $orgs[$k])) $orgs[$k][] = $t[$rule['table']][$rule['old']];\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$this->Log->create();\n\t\t\t\t\t\t$this->Log->save(array(\n\t\t\t\t\t\t\t\t'org' => 'SYSTEM',\n\t\t\t\t\t\t\t\t'model' => 'Server',\n\t\t\t\t\t\t\t\t'model_id' => 0,\n\t\t\t\t\t\t\t\t'email' => 'SYSTEM',\n\t\t\t\t\t\t\t\t'action' => 'upgrade_24',\n\t\t\t\t\t\t\t\t'user_id' => 0,\n\t\t\t\t\t\t\t\t'title' => '[ERROR] - Detected empty string organisation identifier during the upgrade',\n\t\t\t\t\t\t\t\t'change' => 'Detected entries in table `' . $rule['table'] . '` where `' . $rule['old'] . '` was blank. This has to be resolved manually!',\n\t\t\t\t\t\t));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t$this->Log->create();\n\t\t$this->Log->save(array(\n\t\t\t\t'org' => 'SYSTEM',\n\t\t\t\t'model' => 'Server',\n\t\t\t\t'model_id' => 0,\n\t\t\t\t'email' => 'SYSTEM',\n\t\t\t\t'action' => 'upgrade_24',\n\t\t\t\t'user_id' => 0,\n\t\t\t\t'title' => 'Organisation creation',\n\t\t\t\t'change' => 'Detected ' . count($orgs['local']) . ' local organisations and ' . count($orgs['external']) . ' external organisations. Starting organisation creation.',\n\t\t));\n\t\tif (Configure::read('MISP.background_jobs') && $jobId) {\n\t\t\t$this->Job->saveField('progress', 20);\n\t\t\t$this->Job->saveField('message', 'Starting organisation creation');\n\t\t}\n\t\t$orgMapping = array();\n\t\tforeach ($orgs as $k => $orgArray) {\n\t\t\tforeach ($orgArray as $org) {\n\t\t\t\t$orgMapping[$org] = $this->Organisation->createOrgFromName($org, $user_id, $k == 'local' ? true : false);\n\t\t\t}\n\t\t}\n\t\t$this->Log->create();\n\t\t$this->Log->save(array(\n\t\t\t\t'org' => 'SYSTEM',\n\t\t\t\t'model' => 'Server',\n\t\t\t\t'model_id' => 0,\n\t\t\t\t'email' => 'SYSTEM',\n\t\t\t\t'action' => 'upgrade_24',\n\t\t\t\t'user_id' => 0,\n\t\t\t\t'title' => 'Organisations created and / or mapped',\n\t\t\t\t'change' => 'Captured all missing organisations and created a mapping between the old organisation tag and the organisation IDs. ',\n\t\t));\n\t\tif (Configure::read('MISP.background_jobs') && $jobId) {\n\t\t\t$this->Job->saveField('progress', 30);\n\t\t\t$this->Job->saveField('message', 'Updating all current entries');\n\t\t}\n\t\tforeach ($orgMapping as $old => $new) {\n\t\t\tforeach ($captureRules as $rule) {\n\t\t\t\t$this->query('UPDATE `' . $rule['table'] . '` SET `' . $rule['new'] . '`=\"' . $new . '\" WHERE (`' . $rule['old'] . '`=\"' . $old . '\" AND `' . $rule['new'] . '`=\"\");');\n\t\t\t}\n\t\t}\n\t\tif (Configure::read('MISP.background_jobs') && $jobId) {\n\t\t\t$this->Job->saveField('progress', 40);\n\t\t\t$this->Job->saveField('message', 'Rebuilding all correlations.');\n\t\t}\n\t\t//$this->Attribute->generateCorrelation($jobId, 40);\n\t\t// upgrade correlations. No need to recorrelate, we can be a bit trickier here\n\t\t// Private = 0 attributes become distribution 1 for both the event and attribute.\n\t\t// For all intents and purposes, this oversimplification works fine when upgrading from 2.3\n\t\t// Even though the distribution values stored in the correlation won't be correct, they will provide the exact same realeasability\n\t\t// Event1 = distribution 0 and Attribute1 distribution 3 would lead to private = 1, so setting distribution = 0 and a_distribution = 0\n\t\t// will result in the same visibility, etc. Once events / attributes get put into a sharing group this will get recorrelated anyway\n\t\t// Also by unsetting the org field after the move the changes we ensure that these correlations won't get hit again by the script if we rerun it\n\t\t// and that we don't accidentally \"upgrade\" a 2.4 correlation\n\t\t$this->query('UPDATE correlations SET distribution = 1, a_distribution = 1 WHERE org != \"\" AND private = 0');\n\t\tforeach ($orgMapping as $old => $new) {\n\t\t\t$this->query('UPDATE correlations SET org_id = \"' . $new . '\", org = \"\" WHERE org = \"' . $old . '\";');\n\t\t}\n\t\tif (Configure::read('MISP.background_jobs') && $jobId) {\n\t\t\t$this->Job->saveField('progress', 60);\n\t\t\t$this->Job->saveField('message', 'Correlations rebuilt. Indexing all tables.');\n\t\t}\n\t\t$this->updateDatabase('indexTables');\n\t\tif (Configure::read('MISP.background_jobs') && $jobId) {\n\t\t\t$this->Job->saveField('progress', 100);\n\t\t\t$this->Job->saveField('message', 'Upgrade complete.');\n\t\t}\n\t}\n\n\t/* returns the version string of a connected instance\n\t * error codes:\n\t * 1: received non json response\n\t * 2: no route to host\n\t * 3: empty result set\n\t */\n\tpublic function getRemoteVersion($id) {\n\t\t$server = $this->find('first', array(\n\t\t\t\t'conditions' => array('Server.id' => $id),\n\t\t));\n\t\tif (empty($server)) {\n\t\t\treturn 2;\n\t\t}\n\t\tApp::uses('SyncTool', 'Tools');\n\t\t$syncTool = new SyncTool();\n\t\t$HttpSocket = $syncTool->setupHttpSocket($server);\n\t\t$response = $HttpSocket->get($server['Server']['url'] . '/servers/getVersion', $data = '', $request);\n\t\tif ($response->code == 200) {\n\t\t\ttry {\n\t\t\t\t$data = json_decode($response->body, true);\n\t\t\t} catch (Exception $e) {\n\t\t\t\treturn 1;\n\t\t\t}\n\t\t\tif (isset($data['version']) && !empty($data['version'])) {\n\t\t\t\treturn $data['version'];\n\t\t\t} else return 3;\n\t\t} return 2;\n\t}\n\n\n\t/* returns an array with the events\n\t * error codes:\n\t * 1: received non json response\n\t * 2: no route to host\n\t * 3: empty result set\n\t */\n\tpublic function previewIndex($id, $user, $passedArgs) {\n\t\t$server = $this->find('first', array(\n\t\t\t'conditions' => array('Server.id' => $id),\n\t\t));\n\t\tif (empty($server)) {\n\t\t\treturn 2;\n\t\t}\n\t\tApp::uses('SyncTool', 'Tools');\n\t\t$syncTool = new SyncTool();\n\t\t$HttpSocket = $syncTool->setupHttpSocket($server);\n\t\t$request = array(\n\t\t\t\t'header' => array(\n\t\t\t\t\t\t'Authorization' => $server['Server']['authkey'],\n\t\t\t\t\t\t'Accept' => 'application/json',\n\t\t\t\t\t\t'Content-Type' => 'application/json',\n\t\t\t\t\t\t//'Connection' => 'keep-alive' // // LATER followup cakephp issue about this problem: https://github.com/cakephp/cakephp/issues/1961\n\t\t\t\t)\n\t\t);\n\t\t$validArgs = array_merge(array('sort', 'direction'), $this->validEventIndexFilters);\n\t\t$urlParams = '';\n\t\tforeach ($validArgs as $v) {\n\t\t\tif (isset($passedArgs[$v])) $urlParams .= '/' . $v . ':' . $passedArgs[$v];\n\t\t}\n\t\t$uri = $server['Server']['url'] . '/events/index' . $urlParams;\n\t\t$response = $HttpSocket->get($uri, $data = '', $request);\n\t\tif ($response->code == 200) {\n\t\t\ttry {\n\t\t\t\t$events = json_decode($response->body, true);\n\t\t\t} catch (Exception $e) {\n\t\t\t\treturn 1;\n\t\t\t}\n\t\t\tif (!empty($events)) foreach ($events as $k => $event) {\n\t\t\t\tif (!isset($event['Orgc'])) $event['Orgc']['name'] = $event['orgc'];\n\t\t\t\tif (!isset($event['Org'])) $event['Org']['name'] = $event['org'];\n\t\t\t\tif (!isset($event['EventTag'])) $event['EventTag'] = array();\n\t\t\t\t$events[$k] = array('Event' => $event);\n\t\t\t} else return 3;\n\t\t\treturn $events;\n\t\t}\n\t\treturn 2;\n\t}\n\n\t/* returns an array with the events\n\t * error codes:\n\t * 1: received non-json response\n\t * 2: no route to host\n\t */\n\tpublic function previewEvent($serverId, $eventId) {\n\t\t$server = $this->find('first', array(\n\t\t\t\t'conditions' => array('Server.id' => $serverId),\n\t\t));\n\t\tif (empty($server)) {\n\t\t\treturn 2;\n\t\t}\n\t\tApp::uses('SyncTool', 'Tools');\n\t\t$syncTool = new SyncTool();\n\t\t$HttpSocket = $syncTool->setupHttpSocket($server);\n\t\t$request = array(\n\t\t\t\t'header' => array(\n\t\t\t\t\t\t'Authorization' => $server['Server']['authkey'],\n\t\t\t\t\t\t'Accept' => 'application/json',\n\t\t\t\t\t\t'Content-Type' => 'application/json',\n\t\t\t\t\t\t//'Connection' => 'keep-alive' // // LATER followup cakephp issue about this problem: https://github.com/cakephp/cakephp/issues/1961\n\t\t\t\t)\n\t\t);\n\t\t$uri = $server['Server']['url'] . '/events/' . $eventId;\n\t\t$response = $HttpSocket->get($uri, $data = '', $request);\n\t\tif ($response->code == 200) {\n\t\t\ttry {\n\t\t\t\t$event = json_decode($response->body, true);\n\t\t\t} catch (Exception $e) {\n\t\t\t\treturn 1;\n\t\t\t}\n\t\t\tif (!isset($event['Event']['Orgc'])) $event['Event']['Orgc']['name'] = $event['Event']['orgc'];\n\t\t\tif (isset($event['Event']['Orgc'][0])) $event['Event']['Orgc'] = $event['Event']['Orgc'][0];\n\t\t\tif (!isset($event['Event']['Org'])) $event['Event']['Org']['name'] = $event['Event']['org'];\n\t\t\tif (isset($event['Event']['Org'][0])) $event['Event']['Org'] = $event['Event']['Org'][0];\n\t\t\tif (!isset($event['Event']['EventTag'])) $event['Event']['EventTag'] = array();\n\t\t\treturn $event;\n\t\t}\n\t\treturn 2;\n\t}\n\n\t// Loops through all servers and checks which servers' push rules don't conflict with the given event.\n\t// returns the server objects that would allow the event to be pushed\n\tpublic function eventFilterPushableServers($event, $servers) {\n\t\t$eventTags = array();\n\t\t$validServers = array();\n\t\tforeach ($event['EventTag'] as $tag) $eventTags[] = $tag['tag_id'];\n\t\tforeach ($servers as $server) {\n\t\t\t$push_rules = json_decode($server['Server']['push_rules'], true);\n\t\t\tif (!empty($push_rules['tags']['OR'])) {\n\t\t\t\t$intersection = array_intersect($push_rules['tags']['OR'], $eventTags);\n\t\t\t\tif (empty($intersection)) continue;\n\t\t\t}\n\t\t\tif (!empty($push_rules['tags']['NOT'])) {\n\t\t\t\t$intersection = array_intersect($push_rules['tags']['NOT'], $eventTags);\n\t\t\t\tif (!empty($intersection)) continue;\n\t\t\t}\n\t\t\tif (!empty($push_rules['orgs']['OR'])) {\n\t\t\t\tif (!in_array($event['Event']['orgc_id'], $push_rules['orgs']['OR'])) continue;\n\t\t\t}\n\t\t\tif (!empty($push_rules['orgs']['NOT'])) {\n\t\t\t\tif (in_array($event['Event']['orgc_id'], $push_rules['orgs']['NOT'])) continue;\n\t\t\t}\n\t\t\t$validServers[] = $server;\n\t\t}\n\n\t\treturn $validServers;\n\t}\n\n\tpublic function extensionDiagnostics() {\n\t\t$results = array();\n\t\t$extensions = array('redis');\n\t\tforeach ($extensions as $extension) {\n\t\t\t$results['web']['extensions'][$extension] = extension_loaded($extension);\n\t\t}\n\t\tif (!is_readable(APP . '/files/scripts/selftest.php')) {\n\t\t\t$results['cli'] = false;\n\t\t} else {\n\t\t\t$results['cli'] = exec('php ' . APP . '/files/scripts/selftest.php');\n\t\t\t$results['cli'] = json_decode($results['cli'], true);\n\t\t}\n\t\treturn $results;\n\t}\n\n\tpublic function databaseEncodingDiagnostics(&$diagnostic_errors) {\n\t\tif (!isset($this->getDataSource()->config['encoding']) || strtolower($this->getDataSource()->config['encoding']) != 'utf8') {\n\t\t\t$diagnostic_errors++;\n\t\t\treturn false;\n\t\t}\n\t\treturn true;\n\t}\n\n\tpublic function getLatestGitRemote() {\n\t\treturn exec('timeout 3 git ls-remote https://github.com/MISP/MISP | head -1 | sed \"s/HEAD//\"');\n\t}\n\n\tpublic function getCurrentGitStatus() {\n\t\t$status = array();\n\t\t$status['commit'] = exec('git rev-parse HEAD');\n\t\t$status['branch'] = $this->getCurrentBranch();\n\t\t$status['latestCommit'] = $this->getLatestGitremote();\n\t\treturn $status;\n\t}\n\n\tpublic function getCurrentBranch() {\n\t\treturn exec(\"git symbolic-ref HEAD | sed 's!refs\\/heads\\/!!'\");\n\t}\n\n\tpublic function checkoutMain() {\n\t\t$mainBranch = '2.4';\n\t\treturn exec('git checkout ' . $mainBranch);\n\t}\n\n\tpublic function update($status) {\n\t\t$final = '';\n\t\t$command1 = 'git pull origin ' . $status['branch'] . ' 2>&1';\n\t\t$command2 = 'git submodule init && git submodule update 2>&1';\n\t\t$final = $command1 . \"\\n\\n\";\n\t\texec($command1, $output);\n\t\t$final .= implode(\"\\n\", $output) . \"\\n\\n=================================\\n\\n\";\n\t\t$output = array();\n\t\t$final .= $command2 . \"\\n\\n\";\n\t\texec($command2, $output);\n\t\t$final .= implode(\"\\n\", $output);\n\t\treturn $final;\n\t}\n\n\tpublic function getDefaultAttachments_dir() {\n\t\treturn APP . 'files';\n\t}\n\n\tpublic function fetchServer($id) {\n\t\t\tif (empty($id)) return false;\n\t\t\t$conditions = array('Server.id' => $id);\n\t\t\tif (!is_numeric($id)) {\n\t\t\t\t$conditions = array('OR' => array(\n\t\t\t\t\t'LOWER(Server.name)' => strtolower($id),\n\t\t\t\t\t'LOWER(Server.url)' => strtolower($id)\n\t\t\t\t));\n\t\t\t}\n\t\t\t$server = $this->find('first', array(\n\t\t\t\t'conditions' => $conditions,\n\t\t\t\t'recursive' => -1\n\t\t\t));\n\t\t\treturn (empty($server)) ? false : $server;\n\t\t}\n}\n"], "fixing_code": ["<?php\nApp::uses('AppController', 'Controller');\nApp::uses('Xml', 'Utility');\n\nclass ServersController extends AppController {\n\n\tpublic $components = array('Security' ,'RequestHandler');\t// XXX ACL component\n\n\tpublic $paginate = array(\n\t\t\t'limit' => 60,\n\t\t\t'recursive' => -1,\n\t\t\t'contain' => array(\n\t\t\t\t\t'User' => array(\n\t\t\t\t\t\t\t'fields' => array('User.id', 'User.org_id', 'User.email'),\n\t\t\t\t\t),\n\t\t\t\t\t'Organisation' => array(\n\t\t\t\t\t\t\t'fields' => array('Organisation.name', 'Organisation.id'),\n\t\t\t\t\t),\n\t\t\t\t\t'RemoteOrg' => array(\n\t\t\t\t\t\t\t'fields' => array('RemoteOrg.name', 'RemoteOrg.id'),\n\t\t\t\t\t),\n\t\t\t),\n\t\t\t'maxLimit' => 9999, // LATER we will bump here on a problem once we have more than 9999 events\n\t\t\t'order' => array(\n\t\t\t\t\t'Server.url' => 'ASC'\n\t\t\t),\n\t);\n\n\tpublic $uses = array('Server', 'Event');\n\n\tpublic function beforeFilter() {\n\t\tparent::beforeFilter();\n\n\t\t// permit reuse of CSRF tokens on some pages.\n\t\tswitch ($this->request->params['action']) {\n\t\t\tcase 'push':\n\t\t\tcase 'pull':\n\t\t\tcase 'getVersion':\n\t\t\tcase 'testConnection':\n\t\t\t\t$this->Security->csrfUseOnce = false;\n\t\t}\n\t}\n\n\tpublic function index() {\n\t\tif (!$this->_isSiteAdmin()) {\n\t\t\tif (!$this->userRole['perm_sync'] && !$this->userRole['perm_admin']) $this->redirect(array('controller' => 'events', 'action' => 'index'));\n\t\t\t$this->paginate['conditions'] = array('Server.org_id LIKE' => $this->Auth->user('org_id'));\n\t\t}\n\t\t$this->set('servers', $this->paginate());\n\t\t$collection = array();\n\t\t$collection['orgs'] = $this->Server->Organisation->find('list', array(\n\t\t\t\t'fields' => array('id', 'name'),\n\t\t));\n\t\t$this->loadModel('Tag');\n\t\t$collection['tags'] = $this->Tag->find('list', array(\n\t\t\t\t'fields' => array('id', 'name'),\n\t\t));\n\t\t$this->set('collection', $collection);\n\n\t}\n\n\tpublic function previewIndex($id) {\n\t\t$urlparams = '';\n\t\t$passedArgs = array();\n\t\tif (!$this->_isSiteAdmin()) {\n\t\t\tthrow new MethodNotAllowedException('You are not authorised to do that.');\n\t\t}\n\t\t$server = $this->Server->find('first', array('conditions' => array('Server.id' => $id), 'recursive' => -1, 'fields' => array('Server.id', 'Server.url', 'Server.name')));\n\t\tif (empty($server)) throw new NotFoundException('Invalid server ID.');\n\t\t$validFilters = $this->Server->validEventIndexFilters;\n\t\tforeach ($validFilters as $k => $filter) {\n\t\t\tif (isset($this->passedArgs[$filter])) {\n\t\t\t\t$passedArgs[$filter] = $this->passedArgs[$filter];\n\t\t\t\tif ($k != 0) $urlparams .= '/';\n\t\t\t\t$urlparams .= $filter . ':' . $this->passedArgs[$filter];\n\t\t\t}\n\t\t}\n\t\t$combinedArgs = array_merge($this->passedArgs, $passedArgs);\n\t\tif (!isset($combinedArgs['sort'])) {\n\t\t\t$combinedArgs['sort'] = 'timestamp';\n\t\t\t$combinedArgs['direction'] = 'desc';\n\t\t}\n\t\t$events = $this->Server->previewIndex($id, $this->Auth->user(), $combinedArgs);\n\t\t$this->loadModel('Event');\n\t\t$threat_levels = $this->Event->ThreatLevel->find('all');\n\t\t$this->set('threatLevels', Set::combine($threat_levels, '{n}.ThreatLevel.id', '{n}.ThreatLevel.name'));\n\t\tApp::uses('CustomPaginationTool', 'Tools');\n\t\t$customPagination = new CustomPaginationTool();\n\t\t$params = $customPagination->createPaginationRules($events, $this->passedArgs, $this->alias);\n\t\t$this->params->params['paging'] = array($this->modelClass => $params);\n\t\tif (is_array($events)) $customPagination->truncateByPagination($events, $params);\n\t\telse ($events = array());\n\t\t$this->set('events', $events);\n\t\t$this->set('eventDescriptions', $this->Event->fieldDescriptions);\n\t\t$this->set('analysisLevels', $this->Event->analysisLevels);\n\t\t$this->set('distributionLevels', $this->Event->distributionLevels);\n\n\t\t$shortDist = array(0 => 'Organisation', 1 => 'Community', 2 => 'Connected', 3 => 'All', 4 => ' sharing Group');\n\t\t$this->set('shortDist', $shortDist);\n\t\t$this->set('ajax', $this->request->is('ajax'));\n\t\t$this->set('id', $id);\n\t\t$this->set('urlparams', $urlparams);\n\t\t$this->set('passedArgs', json_encode($passedArgs));\n\t\t$this->set('passedArgsArray', $passedArgs);\n\t\t$this->set('server', $server);\n\t}\n\n\tpublic function previewEvent($serverId, $eventId, $all = false) {\n\t\tif (!$this->_isSiteAdmin()) {\n\t\t\tthrow new MethodNotAllowedException('You are not authorised to do that.');\n\t\t}\n\t\t$server = $this->Server->find('first', array('conditions' => array('Server.id' => $serverId), 'recursive' => -1, 'fields' => array('Server.id', 'Server.url', 'Server.name')));\n\t\tif (empty($server)) throw new NotFoundException('Invalid server ID.');\n\t\t$event = $this->Server->previewEvent($serverId, $eventId);\n\t\t// work on this in the future to improve the feedback\n\t\t// 2 = wrong error code\n\t\tif (is_numeric($event))throw new NotFoundException('Invalid event.');\n\t\t$this->loadModel('Event');\n\t\t$params = $this->Event->rearrangeEventForView($event, $this->passedArgs, $all);\n\t\t$this->params->params['paging'] = array('Server' => $params);\n\t\t$this->set('event', $event);\n\t\t$this->set('server', $server);\n\t\t$this->loadModel('Event');\n\t\t$dataForView = array(\n\t\t\t\t'Attribute' => array('attrDescriptions' => 'fieldDescriptions', 'distributionDescriptions' => 'distributionDescriptions', 'distributionLevels' => 'distributionLevels'),\n\t\t\t\t'Event' => array('eventDescriptions' => 'fieldDescriptions', 'analysisLevels' => 'analysisLevels'),\n\t\t\t\t'Object' => array()\n\t\t);\n\t\tforeach ($dataForView as $m => $variables) {\n\t\t\tif ($m === 'Event') $currentModel = $this->Event;\n\t\t\telse if ($m === 'Attribute') $currentModel = $this->Event->Attribute;\n\t\t\telse if ($m === 'Object') $currentModel = $this->Event->Object;\n\t\t\tforeach ($variables as $alias => $variable) {\n\t\t\t\t$this->set($alias, $currentModel->{$variable});\n\t\t\t}\n\t\t}\n\t\t$threat_levels = $this->Event->ThreatLevel->find('all');\n\t\t$this->set('threatLevels', Set::combine($threat_levels, '{n}.ThreatLevel.id', '{n}.ThreatLevel.name'));\n\t}\n\n\tpublic function filterEventIndex($id) {\n\t\tif (!$this->_isSiteAdmin()) {\n\t\t\tthrow new MethodNotAllowedException('You are not authorised to do that.');\n\t\t}\n\t\t$validFilters = $this->Server->validEventIndexFilters;\n\t\t$validatedFilterString = '';\n\t\tforeach ($this->passedArgs as $k => $v) {\n\t\t\tif (in_array('' . $k, $validFilters)) {\n\t\t\t\tif ($validatedFilterString != '') $validatedFilterString .= '/';\n\t\t\t\t$validatedFilterString .= $k . ':' . $v;\n\t\t\t}\n\t\t}\n\t\t$this->set('id', $id);\n\t\t$this->set('validFilters', $validFilters);\n\t\t$this->set('filter', $validatedFilterString);\n\t}\n\n\tpublic function add() {\n\t\tif (!$this->_isSiteAdmin()) $this->redirect(array('controller' => 'servers', 'action' => 'index'));\n\t\tif ($this->request->is('post')) {\n\t\t\tif($this->_isRest()) {\n\t\t\t\tif (!isset($this->request->data['Server'])) {\n\t\t\t\t\t$this->request->data = array('Server' => $this->request->data);\n\t\t\t\t}\n\t\t\t}\n\t\t\t$json = json_decode($this->request->data['Server']['json'], true);\n\n\t\t\t$fail = false;\n\t\t\tif (empty(Configure::read('MISP.host_org_id'))) $this->request->data['Server']['internal'] = 0;\n\t\t\t// test the filter fields\n\t\t\tif (!empty($this->request->data['Server']['pull_rules']) && !$this->Server->isJson($this->request->data['Server']['pull_rules'])) {\n\t\t\t\t$fail = true;\n\t\t\t\t$error_msg = __('The pull filter rules must be in valid JSON format.');\n\t\t\t\tif($this->_isRest()) {\n\t\t\t\t\treturn $this->RestResponse->saveFailResponse('Servers', 'add', false, array('pull_rules' => $error_msg), $this->response->type());\n\t\t\t\t} else {\n\t\t\t\t\t$this->Session->setFlash($error_msg);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (!$fail && !empty($this->request->data['Server']['push_rules']) && !$this->Server->isJson($this->request->data['Server']['push_rules'])) {\n\t\t\t\t$fail = true;\n\t\t\t\t$error_msg = __('The push filter rules must be in valid JSON format.');\n\t\t\t\tif($this->_isRest()) {\n\t\t\t\t\treturn $this->RestResponse->saveFailResponse('Servers', 'add', false, array('push_rules' => $error_msg), $this->response->type());\n\t\t\t\t} else {\n\t\t\t\t\t$this->Session->setFlash($error_msg);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (!$fail) {\n\t\t\t\t// force check userid and orgname to be from yourself\n\t\t\t\t$this->request->data['Server']['org_id'] = $this->Auth->user('org_id');\n\t\t\t\tif ($this->request->data['Server']['organisation_type'] < 2) $this->request->data['Server']['remote_org_id'] = $json['id'];\n\t\t\t\telse {\n\t\t\t\t\t$existingOrgs = $this->Server->Organisation->find('first', array(\n\t\t\t\t\t\t\t'conditions' => array('uuid' => $json['uuid']),\n\t\t\t\t\t\t\t'recursive' => -1,\n\t\t\t\t\t\t\t'fields' => array('id', 'uuid')\n\t\t\t\t\t));\n\t\t\t\t\tif (!empty($existingOrgs)) {\n\t\t\t\t\t\t$fail = true;\n\t\t\t\t\t\tif($this->_isRest()) {\n\t\t\t\t\t\t\treturn $this->RestResponse->saveFailResponse('Servers', 'add', false, array('Organisation' => 'Remote Organisation\\'s uuid already used'), $this->response->type());\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t$this->Session->setFlash(__('That organisation could not be created as the uuid is in use already.'));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!$fail) {\n\t\t\t\t\t\t$this->Server->Organisation->create();\n\t\t\t\t\t\t$orgSave = $this->Server->Organisation->save(array(\n\t\t\t\t\t\t\t\t'name' => $json['name'],\n\t\t\t\t\t\t\t\t'uuid' => $json['uuid'],\n\t\t\t\t\t\t\t\t'local' => 0,\n\t\t\t\t\t\t\t\t'created_by' => $this->Auth->user('id')\n\t\t\t\t\t\t));\n\n\t\t\t\t\t\tif (!$orgSave) {\n\t\t\t\t\t\t\tif($this->_isRest()) {\n\t\t\t\t\t\t\t\treturn $this->RestResponse->saveFailResponse('Servers', 'add', false, $this->Server->Organisation->validationError, $this->response->type());\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t$this->Session->setFlash(__('Couldn\\'t save the new organisation, are you sure that the uuid is in the correct format?.'));\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t$fail = true;\n\t\t\t\t\t\t\t$this->request->data['Server']['external_name'] = $json['name'];\n\t\t\t\t\t\t\t$this->request->data['Server']['external_uuid'] = $json['uuid'];\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t$this->request->data['Server']['remote_org_id'] = $this->Server->Organisation->id;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (Configure::read('MISP.host_org_id') == 0 || $this->request->data['Server']['remote_org_id'] != Configure::read('MISP.host_org_id')) {\n\t\t\t\t\t$this->request->data['Server']['internal'] = 0;\n\t\t\t\t}\n\t\t\t\tif (!$fail) {\n\t\t\t\t\t$this->request->data['Server']['org_id'] = $this->Auth->user('org_id');\n\t\t\t\t\tif ($this->Server->save($this->request->data)) {\n\t\t\t\t\t\tif (isset($this->request->data['Server']['submitted_cert']) && $this->request->data['Server']['submitted_cert']['size'] != 0) {\n\t\t\t\t\t\t\t$this->__saveCert($this->request->data, $this->Server->id, false);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (isset($this->request->data['Server']['submitted_client_cert']) && $this->request->data['Server']['submitted_client_cert']['size'] != 0) {\n\t\t\t\t\t\t\t$this->__saveCert($this->request->data, $this->Server->id, true);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif($this->_isRest()) {\n\t\t\t\t\t\t\t$server = $this->Server->find('first', array(\n\t\t\t\t\t\t\t\t\t'conditions' => array('Server.id' => $this->Server->id),\n\t\t\t\t\t\t\t\t\t'recursive' => -1\n\t\t\t\t\t\t\t));\n\t\t\t\t\t\t\treturn $this->RestResponse->viewData($server, $this->response->type());\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t$this->Session->setFlash(__('The server has been saved'));\n\t\t\t\t\t\t\t$this->redirect(array('action' => 'index'));\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif($this->_isRest()) {\n\t\t\t\t\t\t\treturn $this->RestResponse->saveFailResponse('Servers', 'add', false, $this->Server->validationError, $this->response->type());\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t$this->Session->setFlash(__('The server could not be saved. Please, try again.'));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif($this->_isRest()) {\n\t\t\treturn $this->RestResponse->describe('Servers', 'add', false, $this->response->type());\n\t\t} else {\n\t\t\t$organisationOptions = array(0 => 'Local organisation', 1 => 'External organisation', 2 => 'New external organisation');\n\t\t\t$temp = $this->Server->Organisation->find('all', array(\n\t\t\t\t\t'conditions' => array('local' => true),\n\t\t\t\t\t'fields' => array('id', 'name'),\n\t\t\t\t\t'order' => array('lower(Organisation.name) ASC')\n\t\t\t));\n\t\t\t$localOrganisations = array();\n\t\t\t$allOrgs = array();\n\t\t\tforeach ($temp as $o) {\n\t\t\t\t$localOrganisations[$o['Organisation']['id']] = $o['Organisation']['name'];\n\t\t\t\t$allOrgs[] = array('id' => $o['Organisation']['id'], 'name' => $o['Organisation']['name']);\n\t\t\t}\n\t\t\t$temp = $this->Server->Organisation->find('all', array(\n\t\t\t\t\t'conditions' => array('local' => false),\n\t\t\t\t\t'fields' => array('id', 'name'),\n\t\t\t\t\t'order' => array('lower(Organisation.name) ASC')\n\t\t\t));\n\t\t\t$externalOrganisations = array();\n\t\t\tforeach ($temp as $o) {\n\t\t\t\t$externalOrganisations[$o['Organisation']['id']] = $o['Organisation']['name'];\n\t\t\t\t$allOrgs[] = array('id' => $o['Organisation']['id'], 'name' => $o['Organisation']['name']);\n\t\t\t}\n\t\t\t$this->set('host_org_id', Configure::read('MISP.host_org_id'));\n\t\t\t$this->set('organisationOptions', $organisationOptions);\n\t\t\t$this->set('localOrganisations', $localOrganisations);\n\t\t\t$this->set('externalOrganisations', $externalOrganisations);\n\t\t\t$this->set('allOrganisations', $allOrgs);\n\n\t\t\t// list all tags for the rule picker\n\t\t\t$this->loadModel('Tag');\n\t\t\t$temp = $this->Tag->find('all', array('recursive' => -1));\n\t\t\t$allTags = array();\n\t\t\tforeach ($temp as $t) $allTags[] = array('id' => $t['Tag']['id'], 'name' => $t['Tag']['name']);\n\t\t\t$this->set('allTags', $allTags);\n\t\t\t$this->set('host_org_id', Configure::read('MISP.host_org_id'));\n\t\t}\n\t}\n\n\tpublic function edit($id = null) {\n\t\t$this->Server->id = $id;\n\t\tif (!$this->Server->exists()) {\n\t\t\tthrow new NotFoundException(__('Invalid server'));\n\t\t}\n\t\t$s = $this->Server->read(null, $id);\n\t\tif (!$this->_isSiteAdmin()) $this->redirect(array('controller' => 'servers', 'action' => 'index'));\n\t\tif ($this->request->is('post') || $this->request->is('put')) {\n\t\t\tif (empty(Configure::read('MISP.host_org_id'))) $this->request->data['Server']['internal'] = 0;\n\t\t\tif($this->_isRest()) {\n\t\t\t\tif (!isset($this->request->data['Server'])) {\n\t\t\t\t\t$this->request->data = array('Server' => $this->request->data);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif(isset($this->request->data['Server']['json'])) {\n\t\t\t\t$json = json_decode($this->request->data['Server']['json'], true);\n\t\t\t} else {\n\t\t\t\t$json = NULL;\n\t\t\t}\n\t\t\t$fail = false;\n\n\t\t\t// test the filter fields\n\t\t\tif (!empty($this->request->data['Server']['pull_rules']) && !$this->Server->isJson($this->request->data['Server']['pull_rules'])) {\n\t\t\t\t$fail = true;\n\t\t\t\t$error_msg = __('The pull filter rules must be in valid JSON format.');\n\t\t\t\tif($this->_isRest()) {\n\t\t\t\t\treturn $this->RestResponse->saveFailResponse('Servers', 'edit', false, array('pull_rules' => $error_msg), $this->response->type());\n\t\t\t\t} else {\n\t\t\t\t\t$this->Session->setFlash($error_msg);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (!$fail && !empty($this->request->data['Server']['push_rules']) && !$this->Server->isJson($this->request->data['Server']['push_rules'])) {\n\t\t\t\t$fail = true;\n\t\t\t\t$error_msg = __('The push filter rules must be in valid JSON format.');\n\t\t\t\tif($this->_isRest()) {\n\t\t\t\t\treturn $this->RestResponse->saveFailResponse('Servers', 'edit', false, array('push_rules' => $error_msg), $this->response->type());\n\t\t\t\t} else {\n\t\t\t\t\t$this->Session->setFlash($error_msg);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!$fail) {\n\t\t\t\t// say what fields are to be updated\n\t\t\t\t$fieldList = array('id', 'url', 'push', 'pull', 'unpublish_event', 'publish_without_email', 'remote_org_id', 'name' ,'self_signed', 'cert_file', 'client_cert_file', 'push_rules', 'pull_rules', 'internal');\n\t\t\t\t$this->request->data['Server']['id'] = $id;\n\t\t\t\tif (isset($this->request->data['Server']['authkey']) && \"\" != $this->request->data['Server']['authkey']) $fieldList[] = 'authkey';\n\t\t\t\tif(isset($this->request->data['Server']['organisation_type']) && isset($json)) {\n\t\t\t\t\t// adds 'remote_org_id' in the fields to update\n\t\t\t\t\t$fieldList[] = 'remote_org_id';\n\t\t\t\t\tif ($this->request->data['Server']['organisation_type'] < 2) $this->request->data['Server']['remote_org_id'] = $json['id'];\n\t\t\t\t\telse {\n\t\t\t\t\t\t$existingOrgs = $this->Server->Organisation->find('first', array(\n\t\t\t\t\t\t\t\t'conditions' => array('uuid' => $json['uuid']),\n\t\t\t\t\t\t\t\t'recursive' => -1,\n\t\t\t\t\t\t\t\t'fields' => array('id', 'uuid')\n\t\t\t\t\t\t));\n\t\t\t\t\t\tif (!empty($existingOrgs)) {\n\t\t\t\t\t\t\t$fail = true;\n\t\t\t\t\t\t\tif($this->_isRest()) {\n\t\t\t\t\t\t\t\treturn $this->RestResponse->saveFailResponse('Servers', 'edit', false, array('Organisation' => 'Remote Organisation\\'s uuid already used'), $this->response->type());\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t$this->Session->setFlash(__('That organisation could not be created as the uuid is in use already.'));\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (!$fail) {\n\t\t\t\t\t\t\t$this->Server->Organisation->create();\n\t\t\t\t\t\t\t$orgSave = $this->Server->Organisation->save(array(\n\t\t\t\t\t\t\t\t\t'name' => $json['name'],\n\t\t\t\t\t\t\t\t\t'uuid' => $json['uuid'],\n\t\t\t\t\t\t\t\t\t'local' => 0,\n\t\t\t\t\t\t\t\t\t'created_by' => $this->Auth->user('id')\n\t\t\t\t\t\t\t));\n\n\t\t\t\t\t\t\tif (!$orgSave) {\n\t\t\t\t\t\t\t\tif($this->_isRest()) {\n\t\t\t\t\t\t\t\t\treturn $this->RestResponse->saveFailResponse('Servers', 'edit', false, $this->Server->Organisation->validationError, $this->response->type());\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t$this->Session->setFlash(__('Couldn\\'t save the new organisation, are you sure that the uuid is in the correct format?.'));\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t$fail = true;\n\t\t\t\t\t\t\t\t$this->request->data['Server']['external_name'] = $json['name'];\n\t\t\t\t\t\t\t\t$this->request->data['Server']['external_uuid'] = $json['uuid'];\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t$this->request->data['Server']['remote_org_id'] = $this->Server->Organisation->id;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (empty(Configure::read('MISP.host_org_id')) || $this->request->data['Server']['remote_org_id'] != Configure::read('MISP.host_org_id')) {\n\t\t\t\t\t\t$this->request->data['Server']['internal'] = 0;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!$fail) {\n\t\t\t\t// Save the data\n\t\t\t\tif ($this->Server->save($this->request->data, true, $fieldList)) {\n\t\t\t\t\tif (isset($this->request->data['Server']['submitted_cert']) && $this->request->data['Server']['submitted_cert']['size'] != 0 && (!isset($this->request->data['Server']['delete_cert']) || !$this->request->data['Server']['delete_cert'])) {\n\t\t\t\t\t\t$this->__saveCert($this->request->data, $this->Server->id, false);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (isset($this->request->data['Server']['delete_cert']) && $this->request->data['Server']['delete_cert']) $this->__saveCert($this->request->data, $this->Server->id, false, true);\n\t\t\t\t\t}\n\t\t\t\t\tif (isset($this->request->data['Server']['submitted_client_cert']) && $this->request->data['Server']['submitted_client_cert']['size'] != 0 && (!isset($this->request->data['Server']['delete_client_cert']) || !$this->request->data['Server']['delete_client_cert'])) {\n\t\t\t\t\t\t$this->__saveCert($this->request->data, $this->Server->id, true);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (isset($this->request->data['Server']['delete_client_cert']) && $this->request->data['Server']['delete_client_cert']) $this->__saveCert($this->request->data, $this->Server->id, true, true);\n\t\t\t\t\t}\n\t\t\t\t\tif($this->_isRest()) {\n\t\t\t\t\t\t$server = $this->Server->find('first', array(\n\t\t\t\t\t\t\t\t'conditions' => array('Server.id' => $this->Server->id),\n\t\t\t\t\t\t\t\t'recursive' => -1\n\t\t\t\t\t\t));\n\t\t\t\t\t\treturn $this->RestResponse->viewData($server, $this->response->type());\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$this->Session->setFlash(__('The server has been saved'));\n\t\t\t\t\t\t$this->redirect(array('action' => 'index'));\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tif($this->_isRest()) {\n\t\t\t\t\t\treturn $this->RestResponse->saveFailResponse('Servers', 'edit', false, $this->Server->validationError, $this->response->type());\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$this->Session->setFlash(__('The server could not be saved. Please, try again.'));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\t$this->Server->read(null, $id);\n\t\t\t$this->Server->set('authkey', '');\n\t\t\t$this->request->data = $this->Server->data;\n\t\t}\n\t\tif($this->_isRest()) {\n\t\t\treturn $this->RestResponse->describe('Servers', 'edit', false, $this->response->type());\n\t\t} else {\n\t\t\t$organisationOptions = array(0 => 'Local organisation', 1 => 'External organisation', 2 => 'New external organisation');\n\t\t\t$temp = $this->Server->Organisation->find('all', array(\n\t\t\t\t\t'conditions' => array('local' => true),\n\t\t\t\t\t'fields' => array('id', 'name'),\n\t\t\t\t\t'order' => array('lower(Organisation.name) ASC')\n\t\t\t));\n\t\t\t$localOrganisations = array();\n\t\t\t$allOrgs = array();\n\t\t\tforeach ($temp as $o) {\n\t\t\t\t$localOrganisations[$o['Organisation']['id']] = $o['Organisation']['name'];\n\t\t\t\t$allOrgs[] = array('id' => $o['Organisation']['id'], 'name' => $o['Organisation']['name']);\n\t\t\t}\n\t\t\t$temp = $this->Server->Organisation->find('all', array(\n\t\t\t\t\t'conditions' => array('local' => false),\n\t\t\t\t\t'fields' => array('id', 'name'),\n\t\t\t\t\t'order' => array('lower(Organisation.name) ASC')\n\t\t\t));\n\t\t\t$externalOrganisations = array();\n\t\t\tforeach ($temp as $o) {\n\t\t\t\t$externalOrganisations[$o['Organisation']['id']] = $o['Organisation']['name'];\n\t\t\t\t$allOrgs[] = array('id' => $o['Organisation']['id'], 'name' => $o['Organisation']['name']);\n\t\t\t}\n\n\t\t\t$oldRemoteSetting = 0;\n\t\t\tif (!$this->Server->data['RemoteOrg']['local']) $oldRemoteSetting = 1;\n\t\t\t$this->set('host_org_id', Configure::read('MISP.host_org_id'));\n\t\t\t$this->set('oldRemoteSetting', $oldRemoteSetting);\n\t\t\t$this->set('oldRemoteOrg', $this->Server->data['RemoteOrg']['id']);\n\n\t\t\t$this->set('organisationOptions', $organisationOptions);\n\t\t\t$this->set('localOrganisations', $localOrganisations);\n\t\t\t$this->set('externalOrganisations', $externalOrganisations);\n\t\t\t$this->set('allOrganisations', $allOrgs);\n\n\t\t\t// list all tags for the rule picker\n\t\t\t$this->loadModel('Tag');\n\t\t\t$temp = $this->Tag->find('all', array('recursive' => -1));\n\t\t\t$allTags = array();\n\t\t\tforeach ($temp as $t) $allTags[] = array('id' => $t['Tag']['id'], 'name' => $t['Tag']['name']);\n\t\t\t$this->set('allTags', $allTags);\n\t\t\t$this->set('server', $s);\n\t\t\t$this->set('host_org_id', Configure::read('MISP.host_org_id'));\n\t\t}\n\t}\n\n\tpublic function delete($id = null) {\n\t\tif (!$this->request->is('post')) {\n\t\t\tthrow new MethodNotAllowedException();\n\t\t}\n\t\t$this->Server->id = $id;\n\t\tif (!$this->Server->exists()) {\n\t\t\tthrow new NotFoundException(__('Invalid server'));\n\t\t}\n\t\t$s = $this->Server->read(null, $id);\n\t\tif (!$this->_isSiteAdmin()) $this->redirect(array('controller' => 'servers', 'action' => 'index'));\n\t\tif ($this->Server->delete()) {\n\t\t\t$this->Session->setFlash(__('Server deleted'));\n\t\t\t$this->redirect(array('action' => 'index'));\n\t\t}\n\t\t$this->Session->setFlash(__('Server was not deleted'));\n\t\t$this->redirect(array('action' => 'index'));\n\t}\n\n\t/**\n\t * Pull one or more events with attributes from a remote instance.\n\t * Set $technique to\n\t *\t\tfull - download everything\n\t *\t\tincremental - only new events\n\t *\t\t<int>\t- specific id of the event to pull\n\t */\n\tpublic function pull($id = null, $technique=false) {\n\t\t$this->Server->id = $id;\n\t\tif (!$this->Server->exists()) {\n\t\t\tthrow new NotFoundException(__('Invalid server'));\n\t\t}\n\t\t$s = $this->Server->read(null, $id);\n\t\tif (!$this->_isSiteAdmin() && !($s['Server']['org_id'] == $this->Auth->user('org_id') && $this->_isAdmin())) $this->redirect(array('controller' => 'servers', 'action' => 'index'));\n\t\t$this->Server->id = $id;\n\t\tif (!$this->Server->exists()) {\n\t\t\tthrow new NotFoundException(__('Invalid server'));\n\t\t}\n\n\t\tif (false == $this->Server->data['Server']['pull'] && ($technique == 'full' || $technique == 'incremental')) {\n\t\t\t$this->Session->setFlash(__('Pull setting not enabled for this server.'));\n\t\t\t$this->redirect(array('action' => 'index'));\n\t\t}\n\t\tif (!Configure::read('MISP.background_jobs')) {\n\t\t\t$result = $this->Server->pull($this->Auth->user(), $id, $technique, $s);\n\t\t\t// error codes\n\t\t\tif (isset($result[0]) && is_numeric($result[0])) {\n\t\t\t\tswitch ($result[0]) {\n\t\t\t\t\tcase '1' :\n\t\t\t\t\t\t$this->Session->setFlash(__('Not authorised. This is either due to an invalid auth key, or due to the sync user not having authentication permissions enabled on the remote server. Another reason could be an incorrect sync server setting.'));\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase '2' :\n\t\t\t\t\t\t$this->Session->setFlash($result[1]);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase '3' :\n\t\t\t\t\t\tthrow new NotFoundException('Sorry, this is not yet implemented');\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase '4' :\n\t\t\t\t\t\t$this->redirect(array('action' => 'index'));\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\t$this->redirect($this->referer());\n\t\t\t} else {\n\t\t\t\t$this->set('successes', $result[0]);\n\t\t\t\t$this->set('fails', $result[1]);\n\t\t\t\t$this->set('pulledProposals', $result[2]);\n\t\t\t\t$this->set('lastpulledid', $result[3]);\n\t\t\t}\n\t\t} else {\n\t\t\t$this->loadModel('Job');\n\t\t\t$this->Job->create();\n\t\t\t$data = array(\n\t\t\t\t\t'worker' => 'default',\n\t\t\t\t\t'job_type' => 'pull',\n\t\t\t\t\t'job_input' => 'Server: ' . $id,\n\t\t\t\t\t'status' => 0,\n\t\t\t\t\t'retries' => 0,\n\t\t\t\t\t'org' => $this->Auth->user('Organisation')['name'],\n\t\t\t\t\t'message' => 'Pulling.',\n\t\t\t);\n\t\t\t$this->Job->save($data);\n\t\t\t$jobId = $this->Job->id;\n\t\t\t$process_id = CakeResque::enqueue(\n\t\t\t\t\t'default',\n\t\t\t\t\t'ServerShell',\n\t\t\t\t\tarray('pull', $this->Auth->user('id'), $id, $technique, $jobId)\n\t\t\t);\n\t\t\t$this->Job->saveField('process_id', $process_id);\n\t\t\t$this->Session->setFlash('Pull queued for background execution.');\n\t\t\t$this->redirect($this->referer());\n\t\t}\n\t}\n\n\tpublic function push($id = null, $technique=false) {\n\t\t$this->Server->id = $id;\n\t\tif (!$this->Server->exists()) {\n\t\t\tthrow new NotFoundException(__('Invalid server'));\n\t\t}\n\t\t$s = $this->Server->read(null, $id);\n\t\tif (!$this->_isSiteAdmin() && !($s['Server']['org_id'] == $this->Auth->user('org_id') && $this->_isAdmin())) $this->redirect(array('controller' => 'servers', 'action' => 'index'));\n\t\tif (!Configure::read('MISP.background_jobs')) {\n\t\t\t$server = $this->Server->read(null, $id);\n\t\t\tApp::uses('SyncTool', 'Tools');\n\t\t\t$syncTool = new SyncTool();\n\t\t\t$HttpSocket = $syncTool->setupHttpSocket($server);\n\t\t\t$result = $this->Server->push($id, $technique, false, $HttpSocket, $this->Auth->user());\n\t\t\tif ($result === false) {\n\t\t\t\t$this->Session->setFlash('The remote server is too outdated to initiate a push towards it. Please notify the hosting organisation of the remote instance.');\n\t\t\t\t$this->redirect(array('action' => 'index'));\n\t\t\t}\n\t\t\t$this->set('successes', $result[0]);\n\t\t\t$this->set('fails', $result[1]);\n\t\t} else {\n\t\t\t$this->loadModel('Job');\n\t\t\t$this->Job->create();\n\t\t\t$data = array(\n\t\t\t\t\t'worker' => 'default',\n\t\t\t\t\t'job_type' => 'push',\n\t\t\t\t\t'job_input' => 'Server: ' . $id,\n\t\t\t\t\t'status' => 0,\n\t\t\t\t\t'retries' => 0,\n\t\t\t\t\t'org' => $this->Auth->user('Organisation')['name'],\n\t\t\t\t\t'message' => 'Pushing.',\n\t\t\t);\n\t\t\t$this->Job->save($data);\n\t\t\t$jobId = $this->Job->id;\n\t\t\t$process_id = CakeResque::enqueue(\n\t\t\t\t\t'default',\n\t\t\t\t\t'ServerShell',\n\t\t\t\t\tarray('push', $id, $technique, $jobId, $this->Auth->user('id'))\n\t\t\t);\n\t\t\t$this->Job->saveField('process_id', $process_id);\n\t\t\t$this->Session->setFlash('Push queued for background execution.');\n\t\t\t$this->redirect(array('action' => 'index'));\n\t\t}\n\t}\n\n\tprivate function __saveCert($server, $id, $client = false, $delete = false) {\n\t\tif ($client) {\n\t\t\t$subm = 'submitted_client_cert';\n\t\t\t$attr = 'client_cert_file';\n\t\t\t$ins  = '_client';\n\t\t} else {\n\t\t\t$subm = 'submitted_cert';\n\t\t\t$attr = 'cert_file';\n\t\t\t$ins  = '';\n\t\t}\n\t\tif (!$delete) {\n\t\t\t$ext = '';\n\t\t\tApp::uses('File', 'Utility');\n\t\t\tApp::uses('Folder', 'Utility');\n\t\t\tApp::uses('FileAccessTool', 'Tools');\n\t\t\tif (!$this->Server->checkFilename($server['Server'][$subm]['name'])) {\n\t\t\t\tthrow new Exception ('Filename not allowed');\n\t\t\t}\n\t\t\t$file = new File($server['Server'][$subm]['name']);\n\t\t\t$ext = $file->ext();\n\t\t\tif (($ext != 'pem') || !$server['Server'][$subm]['size'] > 0) {\n\t\t\t\t$this->Session->setFlash('Incorrect extension or empty file.');\n\t\t\t\t$this->redirect(array('action' => 'index'));\n\t\t\t}\n\n\t\t\t// read pem file data\n\t\t\t$pemData = (new FileAccessTool())->readFromFile($server['Server'][$subm]['tmp_name'], $server['Server'][$subm]['size']);\n\n\t\t\t$destpath = APP . \"files\" . DS . \"certs\" . DS;\n\t\t\t$dir = new Folder(APP . \"files\" . DS . \"certs\", true);\n\t\t\t$pemfile = new File($destpath . $id . $ins . '.' . $ext);\n\t\t\t$result = $pemfile->write($pemData);\n\t\t\t$s = $this->Server->read(null, $id);\n\t\t\t$s['Server'][$attr] = $s['Server']['id'] . $ins . '.' . $ext;\n\t\t\tif ($result) $this->Server->save($s);\n\t\t} else {\n\t\t\t$s = $this->Server->read(null, $id);\n\t\t\t$s['Server'][$attr] = '';\n\t\t\t$this->Server->save($s);\n\t\t}\n\t}\n\n\tpublic function serverSettingsReloadSetting($setting, $id) {\n\t\tif (!$this->_isSiteAdmin()) throw new MethodNotAllowedException();\n\t\t$pathToSetting = explode('.', $setting);\n\t\tif (strpos($setting, 'Plugin.Enrichment') !== false || strpos($setting, 'Plugin.Import') !== false || strpos($setting, 'Plugin.Export') !== false || strpos($setting, 'Plugin.Cortex') !== false) {\n\t\t\t$settingObject = $this->Server->getCurrentServerSettings();\n\t\t}\n\t\telse $settingObject = $this->Server->serverSettings;\n\t\tforeach ($pathToSetting as $key) {\n\t\t\tif (!isset($settingObject[$key])) throw new MethodNotAllowedException();\n\t\t\t$settingObject = $settingObject[$key];\n\t\t}\n\t\t$result = $this->Server->serverSettingReadSingle($settingObject, $setting, $key);\n\t\t$this->set('setting', $result);\n\t\t$priorityErrorColours = array(0 => 'red', 1 => 'yellow', 2 => 'green');\n\t\t$this->set('priorityErrorColours', $priorityErrorColours);\n\t\t$priorities = array(0 => 'Critical', 1 => 'Recommended', 2 => 'Optional', 3 => 'Deprecated');\n\t\t$this->set('priorities', $priorities);\n\t\t$this->set('k', $id);\n\t\t$this->layout = false;\n\n\t\t$subGroup = 'general';\n\t\tif ($pathToSetting[0] === 'Plugin') {\n\t\t\t$subGroup = explode('_', $pathToSetting[1])[0];\n\t\t}\n\t\t$this->set('subGroup', $subGroup);\n\n\t\t$this->render('/Elements/healthElements/settings_row');\n\t}\n\n\tprivate function __loadLocalOrgs() {\n\t\t$this->loadModel('Organisation');\n\t\t$local_orgs = $this->Organisation->find('list', array(\n\t\t\t\t'conditions' => array('local' => 1),\n\t\t\t\t'recursive' => -1,\n\t\t\t\t'fields' => array('Organisation.id', 'Organisation.name')\n\t\t));\n\t\treturn array_replace(array(0 => 'No organisation selected.'), $local_orgs);\n\t}\n\n\tpublic function serverSettings($tab=false) {\n\t\tif (!$this->_isSiteAdmin()) throw new MethodNotAllowedException();\n\t\tif ($this->request->is('Get')) {\n\t\t\t$tabs = array(\n\t\t\t\t\t'MISP' => array('count' => 0, 'errors' => 0, 'severity' => 5),\n\t\t\t\t\t'Encryption' => array('count' => 0, 'errors' => 0, 'severity' => 5),\n\t\t\t\t\t'Proxy' => array('count' => 0, 'errors' => 0, 'severity' => 5),\n\t\t\t\t\t'Security' => array('count' => 0, 'errors' => 0, 'severity' => 5),\n\t\t\t\t\t'Plugin' => array('count' => 0, 'errors' => 0, 'severity' => 5)\n\t\t\t);\n\t\t\t$writeableErrors = array(0 => 'OK', 1 => 'not found', 2 => 'is not writeable');\n\t\t\t$readableErrors = array(0 => 'OK', 1 => 'not readable');\n\t\t\t$gpgErrors = array(0 => 'OK', 1 => 'FAIL: settings not set', 2 => 'FAIL: Failed to load GPG', 3 => 'FAIL: Issues with the key/passphrase', 4 => 'FAIL: encrypt failed');\n\t\t\t$proxyErrors = array(0 => 'OK', 1 => 'not configured (so not tested)', 2 => 'Getting URL via proxy failed');\n\t\t\t$zmqErrors = array(0 => 'OK', 1 => 'not enabled (so not tested)', 2 => 'Python ZeroMQ library not installed correctly.', 3 => 'ZeroMQ script not running.');\n\t\t\t$stixOperational = array(0 => 'STIX or CyBox or mixbox library not installed correctly', 1 => 'OK');\n\t\t\t$stixVersion = array(0 => 'Incorrect STIX version installed, found $current, expecting $expected', 1 => 'OK');\n\t\t\t$cyboxVersion = array(0 => 'Incorrect CyBox version installed, found $current, expecting $expected', 1 => 'OK');\n\t\t\t$mixboxVersion = array(0 => 'Incorrect mixbox version installed, found $current, expecting $expected', 1 => 'OK');\n\t\t\t$sessionErrors = array(0 => 'OK', 1 => 'High', 2 => 'Alternative setting used', 3 => 'Test failed');\n\t\t\t$moduleErrors = array(0 => 'OK', 1 => 'System not enabled', 2 => 'No modules found');\n\n\t\t\t$finalSettings = $this->Server->serverSettingsRead();\n\t\t\t$issues = array(\n\t\t\t\t'errors' => array(\n\t\t\t\t\t\t0 => array(\n\t\t\t\t\t\t\t\t'value' => 0,\n\t\t\t\t\t\t\t\t'description' => 'MISP will not operate correctly or will be unsecure until these issues are resolved.'\n\t\t\t\t\t\t),\n\t\t\t\t\t\t1 => array(\n\t\t\t\t\t\t\t\t'value' => 0,\n\t\t\t\t\t\t\t\t'description' => 'Some of the features of MISP cannot be utilised until these issues are resolved.'\n\t\t\t\t\t\t),\n\t\t\t\t\t\t2 => array(\n\t\t\t\t\t\t\t\t'value' => 0,\n\t\t\t\t\t\t\t\t'description' => 'There are some optional tweaks that could be done to improve the looks of your MISP instance.'\n\t\t\t\t\t\t),\n\t\t\t\t),\n\t\t\t\t'deprecated' => array(),\n\t\t\t\t'overallHealth' => 3,\n\t\t\t);\n\t\t\t$dumpResults = array();\n\t\t\t$tempArray = array();\n\t\t\tforeach ($finalSettings as $k => $result) {\n\t\t\t\tif ($result['level'] == 3) $issues['deprecated']++;\n\t\t\t\t$tabs[$result['tab']]['count']++;\n\t\t\t\tif (isset($result['error']) && $result['level'] < 3) {\n\t\t\t\t\t$issues['errors'][$result['level']]['value']++;\n\t\t\t\t\tif ($result['level'] < $issues['overallHealth']) $issues['overallHealth'] = $result['level'];\n\t\t\t\t\t$tabs[$result['tab']]['errors']++;\n\t\t\t\t\tif ($result['level'] < $tabs[$result['tab']]['severity']) $tabs[$result['tab']]['severity'] = $result['level'];\n\t\t\t\t}\n\t\t\t\tif (isset($result['optionsSource']) && !empty($result['optionsSource'])) {\n\t\t\t\t\t$result['options'] = $this->{'__load' . $result['optionsSource']}();\n\t\t\t\t}\n\t\t\t\t$dumpResults[] = $result;\n\t\t\t\tif ($result['tab'] == $tab) {\n\t\t\t\t\tif (isset($result['subGroup'])) $tempArray[$result['subGroup']][] = $result;\n\t\t\t\t\telse $tempArray['general'][] = $result;\n\t\t\t\t}\n\t\t\t}\n\t\t\t$finalSettings = $tempArray;\n\t\t\t// Diagnostics portion\n\t\t\t$diagnostic_errors = 0;\n\t\t\tApp::uses('File', 'Utility');\n\t\t\tApp::uses('Folder', 'Utility');\n\t\t\t$additionalViewVars = array();\n\t\t\tif ($tab == 'files') {\n\t\t\t\t$files = $this->__manageFiles();\n\t\t\t\t$this->set('files', $files);\n\t\t\t}\n\t\t\t// Only run this check on the diagnostics tab\n\t\t\tif ($tab == 'diagnostics' || $tab == 'download') {\n\t\t\t\t$php_ini = php_ini_loaded_file();\n\t\t\t\t$this->set('php_ini', $php_ini);\n\t\t\t\t$advanced_attachments = shell_exec('python ' . APP . 'files/scripts/generate_file_objects.py -c');\n\t\t\t\ttry {\n\t\t\t\t\t$advanced_attachments = json_decode($advanced_attachments, true);\n\t\t\t\t} catch (Exception $e) {\n\t\t\t\t\t$advanced_attachments = false;\n\t\t\t\t}\n\t\t\t\t$this->set('advanced_attachments', $advanced_attachments);\n\t\t\t\t// check if the current version of MISP is outdated or not\n\t\t\t\t$version = $this->__checkVersion();\n\t\t\t\t$this->set('version', $version);\n\t\t\t\t$gitStatus = $this->Server->getCurrentGitStatus();\n\t\t\t\t$this->set('branch', $gitStatus['branch']);\n\t\t\t\t$this->set('commit', $gitStatus['commit']);\n\t\t\t\t$this->set('latestCommit', $gitStatus['latestCommit']);\n\t\t\t\t$phpSettings = array(\n\t\t\t\t\t\t'max_execution_time' => array(\n\t\t\t\t\t\t\t'explanation' => 'The maximum duration that a script can run (does not affect the background workers). A too low number will break long running scripts like comprehensive API exports',\n\t\t\t\t\t\t\t'recommended' => 300,\n\t\t\t\t\t\t\t'unit' => false\n\t\t\t\t\t\t),\n\t\t\t\t\t\t'memory_limit' => array(\n\t\t\t\t\t\t\t'explanation' => 'The maximum memory that PHP can consume. It is recommended to raise this number since certain exports can generate a fair bit of memory usage',\n\t\t\t\t\t\t\t'recommended' => 512,\n\t\t\t\t\t\t\t'unit' => 'M'\n\t\t\t\t\t\t),\n\t\t\t\t\t\t'upload_max_filesize' => array(\n\t\t\t\t\t\t\t'explanation' => 'The maximum size that an uploaded file can be. It is recommended to raise this number to allow for the upload of larger samples',\n\t\t\t\t\t\t\t'recommended' => 50,\n\t\t\t\t\t\t\t'unit' => 'M'\n\t\t\t\t\t\t),\n\t\t\t\t\t\t'post_max_size' => array(\n\t\t\t\t\t\t\t'explanation' => 'The maximum size of a POSTed message, this has to be at least the same size as the upload_max_filesize setting',\n\t\t\t\t\t\t\t'recommended' => 50,\n\t\t\t\t\t\t\t'unit' => 'M'\n\t\t\t\t\t\t)\n\n\t\t\t\t);\n\n\t\t\t\tforeach ($phpSettings as $setting => $settingArray) {\n\t\t\t\t\t$phpSettings[$setting]['value'] = ini_get($setting);\n\t\t\t\t\tif ($settingArray['unit']) $phpSettings[$setting]['value'] = intval(rtrim($phpSettings[$setting]['value'], $phpSettings[$setting]['unit']));\n\t\t\t\t\telse $phpSettings[$setting]['value'] = intval($phpSettings[$setting]['value']);\n\t\t\t\t}\n\t\t\t\t$this->set('phpSettings', $phpSettings);\n\n\t\t\t\tif ($version && (!$version['upToDate'] || $version['upToDate'] == 'older')) $diagnostic_errors++;\n\n\t\t\t\t// check if the STIX and Cybox libraries are working and the correct version using the test script stixtest.py\n\t\t\t\t$stix = $this->Server->stixDiagnostics($diagnostic_errors, $stixVersion, $cyboxVersion, $mixboxVersion);\n\n\t\t\t\t// if GPG is set up in the settings, try to encrypt a test message\n\t\t\t\t$gpgStatus = $this->Server->gpgDiagnostics($diagnostic_errors);\n\n\t\t\t\t// if the message queue pub/sub is enabled, check whether the extension works\n\t\t\t\t$zmqStatus = $this->Server->zmqDiagnostics($diagnostic_errors);\n\n\t\t\t\t// if Proxy is set up in the settings, try to connect to a test URL\n\t\t\t\t$proxyStatus = $this->Server->proxyDiagnostics($diagnostic_errors);\n\n\t\t\t\t$moduleTypes = array('Enrichment', 'Import', 'Export', 'Cortex');\n\t\t\t\tforeach ($moduleTypes as $type) {\n\t\t\t\t\t$moduleStatus[$type] = $this->Server->moduleDiagnostics($diagnostic_errors, $type);\n\t\t\t\t}\n\n\t\t\t\t// check the size of the session table\n\t\t\t\t$sessionCount = 0;\n\t\t\t\t$sessionStatus = $this->Server->sessionDiagnostics($diagnostic_errors, $sessionCount);\n\t\t\t\t$this->set('sessionCount', $sessionCount);\n\n\t\t\t\t$additionalViewVars = array('gpgStatus', 'sessionErrors', 'proxyStatus', 'sessionStatus', 'zmqStatus', 'stixVersion', 'cyboxVersion', 'mixboxVersion', 'moduleStatus', 'gpgErrors', 'proxyErrors', 'zmqErrors', 'stixOperational', 'stix', 'moduleErrors', 'moduleTypes');\n\t\t\t}\n\t\t\t// check whether the files are writeable\n\t\t\t$writeableDirs = $this->Server->writeableDirsDiagnostics($diagnostic_errors);\n\t\t\t$writeableFiles = $this->Server->writeableFilesDiagnostics($diagnostic_errors);\n\t\t\t$readableFiles = $this->Server->readableFilesDiagnostics($diagnostic_errors);\n\t\t\t$extensions = $this->Server->extensionDiagnostics();\n\n\t\t\t// check if the encoding is not set to utf8\n\t\t\t$dbEncodingStatus = $this->Server->databaseEncodingDiagnostics($diagnostic_errors);\n\n\t\t\t$viewVars = array(\n\t\t\t\t\t'diagnostic_errors', 'tabs', 'tab', 'issues', 'finalSettings', 'writeableErrors', 'readableErrors', 'writeableDirs', 'writeableFiles', 'readableFiles', 'extensions', 'dbEncodingStatus'\n\t\t\t);\n\t\t\t$viewVars = array_merge($viewVars, $additionalViewVars);\n\t\t\tforeach ($viewVars as $viewVar) $this->set($viewVar, ${$viewVar});\n\n\t\t\t$workerIssueCount = 0;\n\t\t\tif (Configure::read('MISP.background_jobs')) {\n\t\t\t\t$this->set('worker_array', $this->Server->workerDiagnostics($workerIssueCount));\n\t\t\t} else {\n\t\t\t\t$workerIssueCount = 4;\n\t\t\t\t$this->set('worker_array', array());\n\t\t\t}\n\t\t\tif ($tab == 'download') {\n\t\t\t\tforeach ($dumpResults as $key => $dr) {\n\t\t\t\t\tunset($dumpResults[$key]['description']);\n\t\t\t\t}\n\t\t\t\t$dump = array(\n\t\t\t\t\t\t'version' => $version,\n\t\t\t\t\t\t'phpSettings' => $phpSettings,\n\t\t\t\t\t\t'gpgStatus' => $gpgErrors[$gpgStatus],\n\t\t\t\t\t\t'proxyStatus' => $proxyErrors[$proxyStatus],\n\t\t\t\t\t\t'zmqStatus' => $zmqStatus,\n\t\t\t\t\t\t'stix' => $stix,\n\t\t\t\t\t\t'moduleStatus' => $moduleStatus,\n\t\t\t\t\t\t'writeableDirs' => $writeableDirs,\n\t\t\t\t\t\t'writeableFiles' => $writeableFiles,\n\t\t\t\t\t\t'readableFiles' => $readableFiles,\n\t\t\t\t\t\t'finalSettings' => $dumpResults,\n\t\t\t\t\t\t'extensions' => $extensions\n\t\t\t\t);\n\t\t\t\tforeach ($dump['finalSettings'] as $k => $v) {\n\t\t\t\t\tif (!empty($v['redacted'])) {\n\t\t\t\t\t\t$dump['finalSettings'][$k]['value'] = '*****';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t$this->response->body(json_encode($dump, JSON_PRETTY_PRINT));\n\t\t\t\t$this->response->type('json');\n\t\t\t\t$this->response->download('MISP.report.json');\n\t\t\t\treturn $this->response;\n\t\t\t}\n\n\t\t\t$priorities = array(0 => 'Critical', 1 => 'Recommended', 2 => 'Optional', 3 => 'Deprecated');\n\t\t\t$this->set('priorities', $priorities);\n\t\t\t$this->set('workerIssueCount', $workerIssueCount);\n\t\t\t$priorityErrorColours = array(0 => 'red', 1 => 'yellow', 2 => 'green');\n\t\t\t$this->set('priorityErrorColours', $priorityErrorColours);\n\t\t\t$this->set('phpversion', phpversion());\n\t\t\t$this->set('phpmin', $this->phpmin);\n\t\t\t$this->set('phprec', $this->phprec);\n\t\t}\n\t}\n\n\tpublic function startWorker($type) {\n\t\tif (!$this->_isSiteAdmin() || !$this->request->is('post')) throw new MethodNotAllowedException();\n\t\t$validTypes = array('default', 'email', 'scheduler', 'cache', 'prio');\n\t\tif (!in_array($type, $validTypes)) throw new MethodNotAllowedException('Invalid worker type.');\n\t\t$prepend = '';\n\t\tif ($type != 'scheduler') shell_exec($prepend . APP . 'Console' . DS . 'cake CakeResque.CakeResque start --interval 5 --queue ' . $type .' > /dev/null 2>&1 &');\n\t\telse shell_exec($prepend . APP . 'Console' . DS . 'cake CakeResque.CakeResque startscheduler -i 5 > /dev/null 2>&1 &');\n\t\t$this->redirect('/servers/serverSettings/workers');\n\t}\n\n\tpublic function stopWorker($pid) {\n\t\tif (!$this->_isSiteAdmin() || !$this->request->is('post')) throw new MethodNotAllowedException();\n\t\t$this->Server->killWorker($pid, $this->Auth->user());\n\t\t$this->redirect('/servers/serverSettings/workers');\n\t}\n\n\tprivate function __checkVersion() {\n\t\tif (!$this->_isSiteAdmin()) throw new MethodNotAllowedException();\n\t\tApp::uses('SyncTool', 'Tools');\n\t\t$syncTool = new SyncTool();\n\t\ttry {\n\t\t\t$HttpSocket = $syncTool->setupHttpSocket();\n\t\t\t$response = $HttpSocket->get('https://api.github.com/repos/MISP/MISP/tags');\n\t\t\t$tags = $response->body;\n\t\t} catch (Exception $e) {\n\t\t\treturn false;\n\t\t}\n\t\tif ($response->isOK() && !empty($tags)) {\n\t\t\t$json_decoded_tags = json_decode($tags);\n\n\t\t\t// find the latest version tag in the v[major].[minor].[hotfix] format\n\t\t\tfor ($i = 0; $i < count($json_decoded_tags); $i++) {\n\t\t\t\tif (preg_match('/^v[0-9]+\\.[0-9]+\\.[0-9]+$/', $json_decoded_tags[$i]->name)) break;\n\t\t\t}\n\t\t\treturn $this->Server->checkVersion($json_decoded_tags[$i]->name);\n\t\t} else {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tpublic function serverSettingsEdit($setting, $id = false, $forceSave = false) {\n\t\t// invalidate config.php from php opcode cache\n\t\tif (function_exists('opcache_reset')) opcache_reset();\n\n\t\tif (!$this->_isSiteAdmin()) throw new MethodNotAllowedException();\n\t\tif (!isset($setting) || !isset($id)) throw new MethodNotAllowedException();\n\t\t$this->set('id', $id);\n\t\tif (strpos($setting, 'Plugin.Enrichment') !== false || strpos($setting, 'Plugin.Import') !== false || strpos($setting, 'Plugin.Export') !== false || strpos($setting, 'Plugin.Cortex') !== false) {\n\t\t\t$serverSettings = $this->Server->getCurrentServerSettings();\n\t\t}\n\t\telse $serverSettings = $this->Server->serverSettings;\n\t\t$relevantSettings = (array_intersect_key(Configure::read(), $serverSettings));\n\t\t$found = null;\n\t\tforeach ($serverSettings as $k => $s) {\n\t\t\tif (isset($s['branch'])) {\n\t\t\t\tforeach ($s as $ek => $es) {\n\t\t\t\t\tif ($ek != 'branch') {\n\t\t\t\t\t\tif ($setting == $k . '.' . $ek) {\n\t\t\t\t\t\t\t$found = $es;\n\t\t\t\t\t\t\tcontinue 2;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif ($setting == $k) {\n\t\t\t\t\t$found = $s;\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif ($this->request->is('get')) {\n\t\t\tif ($found != null) {\n\t\t\t\t$value = Configure::read($setting);\n\t\t\t\tif ($value) $found['value'] = $value;\n\t\t\t\t$found['setting'] = $setting;\n\t\t\t}\n\t\t\tif (isset($found['optionsSource']) && !empty($found['optionsSource'])) {\n\t\t\t\t$found['options'] = $this->{'__load' . $found['optionsSource']}();\n\t\t\t}\n\t\t\t$subGroup = 'general';\n\t\t\t$subGroup = explode('.', $setting);\n\t\t\tif ($subGroup[0] === 'Plugin') {\n\t\t\t\t$subGroup = explode('_', $subGroup[1])[0];\n\t\t\t} else {\n\t\t\t\t$subGroup = 'general';\n\t\t\t}\n\t\t\tif ($this->_isRest()) {\n\t\t\t\treturn $this->RestResponse->viewData(array($setting => $found['value']));\n\t\t\t} else {\n\t\t\t\t$this->set('subGroup', $subGroup);\n\t\t\t\t$this->set('setting', $found);\n\t\t\t\t$this->render('ajax/server_settings_edit');\n\t\t\t}\n\n\t\t}\n\t\tif ($this->request->is('post')) {\n\t\t\tif (!isset($this->request->data['Server'])) $this->request->data = array('Server' => $this->request->data);\n\t\t\tif (!isset($this->request->data['Server']['value'])) {\n\t\t\t\tif ($this->_isRest()) {\n\t\t\t\t\treturn $this->RestResponse->saveFailResponse('Servers', 'serverSettingsEdit', false, 'Invalid input. Expected: {\"value\": \"new_setting\"}', $this->response->type());\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (trim($this->request->data['Server']['value']) === '*****') {\n\t\t\t\tif ($this->_isRest()) {\n\t\t\t\t\treturn $this->RestResponse->saveFailResponse('Servers', 'serverSettingsEdit', false, 'No change.', $this->response->type());\n\t\t\t\t} else {\n\t\t\t\t\treturn new CakeResponse(array('body'=> json_encode(array('saved' => false, 'errors' => 'No change.')), 'status'=>200, 'type' => 'json'));\n\t\t\t\t}\n\t\t\t}\n\t\t\t$this->autoRender = false;\n\t\t\t$this->loadModel('Log');\n\t\t\tif (!is_writeable(APP . 'Config/config.php')) {\n\t\t\t\t$this->Log->create();\n\t\t\t\t$result = $this->Log->save(array(\n\t\t\t\t\t\t'org' => $this->Auth->user('Organisation')['name'],\n\t\t\t\t\t\t'model' => 'Server',\n\t\t\t\t\t\t'model_id' => 0,\n\t\t\t\t\t\t'email' => $this->Auth->user('email'),\n\t\t\t\t\t\t'action' => 'serverSettingsEdit',\n\t\t\t\t\t\t'user_id' => $this->Auth->user('id'),\n\t\t\t\t\t\t'title' => 'Server setting issue',\n\t\t\t\t\t\t'change' => 'There was an issue witch changing ' . $setting . ' to ' . $this->request->data['Server']['value']  . '. The error message returned is: app/Config.config.php is not writeable to the apache user. No changes were made.',\n\t\t\t\t));\n\t\t\t\tif ($this->_isRest()) {\n\t\t\t\t\treturn $this->RestResponse->saveFailResponse('Servers', 'serverSettingsEdit', false, 'app/Config.config.php is not writeable to the apache user.', $this->response->type());\n\t\t\t\t} else {\n\t\t\t\t\treturn new CakeResponse(array('body'=> json_encode(array('saved' => false, 'errors' => 'app/Config.config.php is not writeable to the apache user.')), 'status'=>200, 'type' => 'json'));\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (isset($found['beforeHook'])) {\n\t\t\t\t$beforeResult = call_user_func_array(array($this->Server, $found['beforeHook']), array($setting, $this->request->data['Server']['value']));\n\t\t\t\tif ($beforeResult !== true) {\n\t\t\t\t\t$this->Log->create();\n\t\t\t\t\t$result = $this->Log->save(array(\n\t\t\t\t\t\t\t'org' => $this->Auth->user('Organisation')['name'],\n\t\t\t\t\t\t\t'model' => 'Server',\n\t\t\t\t\t\t\t'model_id' => 0,\n\t\t\t\t\t\t\t'email' => $this->Auth->user('email'),\n\t\t\t\t\t\t\t'action' => 'serverSettingsEdit',\n\t\t\t\t\t\t\t'user_id' => $this->Auth->user('id'),\n\t\t\t\t\t\t\t'title' => 'Server setting issue',\n\t\t\t\t\t\t\t'change' => 'There was an issue witch changing ' . $setting . ' to ' . $this->request->data['Server']['value']  . '. The error message returned is: ' . $beforeResult . 'No changes were made.',\n\t\t\t\t\t));\n\t\t\t\t\tif ($this->_isRest) {\n\t\t\t\t\t\treturn $this->RestResponse->saveFailResponse('Servers', 'serverSettingsEdit', false, $beforeResult, $this->response->type());\n\t\t\t\t\t} else {\n\t\t\t\t\t\treturn new CakeResponse(array('body'=> json_encode(array('saved' => false, 'errors' => $beforeResult)), 'status'=>200, 'type' => 'json'));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\t$this->request->data['Server']['value'] = trim($this->request->data['Server']['value']);\n\t\t\tif ($found['type'] == 'boolean') {\n\t\t\t\t$this->request->data['Server']['value'] = ($this->request->data['Server']['value'] ? true : false);\n\t\t\t}\n\t\t\tif ($found['type'] == 'numeric') {\n\t\t\t\t$this->request->data['Server']['value'] = intval($this->request->data['Server']['value']);\n\t\t\t}\n\t\t\tif  (!empty($leafValue['test'])) {\n\t\t\t\t$testResult = $this->Server->{$found['test']}($this->request->data['Server']['value']);\n\t\t\t} else  {\n\t\t\t\t$testResult = true;  # No test defined for this setting: cannot fail\n\t\t\t}\n\t\t\tif (!$forceSave && $testResult !== true) {\n\t\t\t\tif ($testResult === false) $errorMessage = $found['errorMessage'];\n\t\t\t\telse $errorMessage = $testResult;\n\t\t\t\tif ($this->_isRest) {\n\t\t\t\t\treturn $this->RestResponse->saveFailResponse('Servers', 'serverSettingsEdit', false, $errorMessage, $this->response->type());\n\t\t\t\t} else {\n\t\t\t\t\treturn new CakeResponse(array('body'=> json_encode(array('saved' => false, 'errors' => $errorMessage)), 'status'=>200, 'type' => 'json'));\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t$oldValue = Configure::read($setting);\n\t\t\t\t$this->Server->serverSettingsSaveValue($setting, $this->request->data['Server']['value']);\n\t\t\t\t$this->Log->create();\n\t\t\t\t$result = $this->Log->save(array(\n\t\t\t\t\t\t'org' => $this->Auth->user('Organisation')['name'],\n\t\t\t\t\t\t'model' => 'Server',\n\t\t\t\t\t\t'model_id' => 0,\n\t\t\t\t\t\t'email' => $this->Auth->user('email'),\n\t\t\t\t\t\t'action' => 'serverSettingsEdit',\n\t\t\t\t\t\t'user_id' => $this->Auth->user('id'),\n\t\t\t\t\t\t'title' => 'Server setting changed',\n\t\t\t\t\t\t'change' => $setting . ' (' . $oldValue . ') => (' . $this->request->data['Server']['value'] . ')',\n\t\t\t\t));\n\t\t\t\t// execute after hook\n\t\t\t\tif (isset($found['afterHook'])) {\n\t\t\t\t\t$afterResult = call_user_func_array(array($this->Server, $found['afterHook']), array($setting, $this->request->data['Server']['value']));\n\t\t\t\t\tif ($afterResult !== true) {\n\t\t\t\t\t\t$this->Log->create();\n\t\t\t\t\t\t$result = $this->Log->save(array(\n\t\t\t\t\t\t\t\t'org' => $this->Auth->user('Organisation')['name'],\n\t\t\t\t\t\t\t\t'model' => 'Server',\n\t\t\t\t\t\t\t\t'model_id' => 0,\n\t\t\t\t\t\t\t\t'email' => $this->Auth->user('email'),\n\t\t\t\t\t\t\t\t'action' => 'serverSettingsEdit',\n\t\t\t\t\t\t\t\t'user_id' => $this->Auth->user('id'),\n\t\t\t\t\t\t\t\t'title' => 'Server setting issue',\n\t\t\t\t\t\t\t\t'change' => 'There was an issue after setting a new setting. The error message returned is: ' . $afterResult,\n\t\t\t\t\t\t));\n\t\t\t\t\t\tif ($this->_isRest) {\n\t\t\t\t\t\t\treturn $this->RestResponse->saveFailResponse('Servers', 'serverSettingsEdit', false, $afterResult, $this->response->type());\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\treturn new CakeResponse(array('body'=> json_encode(array('saved' => false, 'errors' => $afterResult)), 'status'=>200, 'type' => 'json'));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif ($this->_isRest) {\n\t\t\t\t\treturn $this->RestResponse->saveSuccessResponse('Servers', 'serverSettingsEdit', false, $this->response->type(), 'Field updated');\n\t\t\t\t} else {\n\t\t\t\t\treturn new CakeResponse(array('body'=> json_encode(array('saved' => true, 'success' => 'Field updated.')), 'status'=>200, 'type' => 'json'));\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic function restartWorkers() {\n\t\tif (!$this->_isSiteAdmin() || !$this->request->is('post')) throw new MethodNotAllowedException();\n\t\t$this->Server->workerRemoveDead($this->Auth->user());\n\t\t$prepend = '';\n\t\tshell_exec($prepend . APP . 'Console' . DS . 'worker' . DS . 'start.sh > /dev/null 2>&1 &');\n\t\t$this->redirect(array('controller' => 'servers', 'action' => 'serverSettings', 'workers'));\n\t}\n\n\tprivate function __manageFiles() {\n\t\tif (!$this->_isSiteAdmin()) throw new MethodNotAllowedException();\n\t\t$files = $this->Server->grabFiles();\n\t\treturn $files;\n\t}\n\n\tpublic function deleteFile($type, $filename) {\n\t\tif (!$this->_isSiteAdmin()) throw new MethodNotAllowedException();\n\t\tif ($this->request->is('post')) {\n\t\t\t$validItems = $this->Server->getFileRules();\n\t\t\tApp::uses('File', 'Utility');\n\t\t\t$existingFile = new File($validItems[$type]['path'] . DS . $filename);\n\t\t\tif (!$existingFile->exists()) {\n\t\t\t\t$this->Session->setFlash(__('File not found.', true), 'default', array(), 'error');\n\t\t\t\t$this->redirect(array('controller' => 'servers', 'action' => 'serverSettings', 'files'));\n\t\t\t}\n\t\t\tif ($existingFile->delete()) {\n\t\t\t\t$this->Session->setFlash('File deleted.');\n\t\t\t} else {\n\t\t\t\t$this->Session->setFlash(__('File could not be deleted.', true), 'default', array(), 'error');\n\t\t\t}\n\t\t\t$this->redirect(array('controller' => 'servers', 'action' => 'serverSettings', 'files'));\n\t\t} else {\n\t\t\tthrow new MethodNotAllowedException('This action expects a POST request.');\n\t\t}\n\t}\n\n\tpublic function uploadFile($type) {\n\t\tif (!$this->_isSiteAdmin() || !$this->request->is('post')) throw new MethodNotAllowedException();\n\t\t$validItems = $this->Server->getFileRules();\n\n\t\t// Check if there were problems with the file upload\n\t\t// only keep the last part of the filename, this should prevent directory attacks\n\t\t$filename = basename($this->request->data['Server']['file']['name']);\n\t\tif (!preg_match(\"/\" . $validItems[$type]['regex'] . \"/\", $filename)) {\n\t\t\t$this->Session->setFlash(__($validItems[$type]['regex_error'], true), 'default', array(), 'error');\n\t\t\t$this->redirect(array('controller' => 'servers', 'action' => 'serverSettings', 'files'));\n\t\t}\n\t\tif (empty($this->request->data['Server']['file']['tmp_name']) || !is_uploaded_file($this->request->data['Server']['file']['tmp_name'])) {\n\t\t\t$this->Session->setFlash(__('Upload failed.', true), 'default', array(), 'error');\n\t\t\t$this->redirect(array('controller' => 'servers', 'action' => 'serverSettings', 'files'));\n\t\t}\n\n\t\t// check if the file already exists\n\t\tApp::uses('File', 'Utility');\n\t\t$existingFile = new File($validItems[$type]['path'] . DS . $filename);\n\t\tif ($existingFile->exists()) {\n\t\t\t$this->Session->setFlash(__('File already exists. If you would like to replace it, remove the old one first.', true), 'default', array(), 'error');\n\t\t\t$this->redirect(array('controller' => 'servers', 'action' => 'serverSettings', 'files'));\n\t\t}\n\n\t\t$result = move_uploaded_file($this->request->data['Server']['file']['tmp_name'], $validItems[$type]['path'] . DS . $filename);\n\t\tif ($result) {\n\t\t\t$this->Session->setFlash('File uploaded.');\n\t\t} else {\n\t\t\t$this->Session->setFlash(__('Upload failed.', true), 'default', array(), 'error');\n\t\t}\n\t\t$this->redirect(array('controller' => 'servers', 'action' => 'serverSettings', 'files'));\n\t}\n\n\tpublic function fetchServersForSG($idList = '{}') {\n\t\t$id_exclusion_list = json_decode($idList, true);\n\t\t$temp = $this->Server->find('all', array(\n\t\t\t\t'conditions' => array(\n\t\t\t\t\t\t'id !=' => $id_exclusion_list,\n\t\t\t\t),\n\t\t\t\t'recursive' => -1,\n\t\t\t\t'fields' => array('id', 'name', 'url')\n\t\t));\n\t\t$servers = array();\n\t\tforeach ($temp as $server) {\n\t\t\t$servers[] = array('id' => $server['Server']['id'], 'name' => $server['Server']['name'], 'url' => $server['Server']['url']);\n\t\t}\n\t\t$this->layout = false;\n\t\t$this->autoRender = false;\n\t\t$this->set('servers', $servers);\n\t\t$this->render('ajax/fetch_servers_for_sg');\n\t}\n\n\tpublic function postTest() {\n\t\tif ($this->request->is('post')) {\n\t\t\t// Fix for PHP-FPM / Nginx / etc\n\t\t\t// Fix via https://www.popmartian.com/tipsntricks/2015/07/14/howto-use-php-getallheaders-under-fastcgi-php-fpm-nginx-etc/\n\t\t\tif (!function_exists('getallheaders')) {\n\t\t\t\t$headers = [];\n\t\t\t\tforeach ($_SERVER as $name => $value) {\n\t\t\t\t    if (substr($name, 0, 5) == 'HTTP_') {\n\t\t\t\t        $headers[str_replace(' ', '-', ucwords(strtolower(str_replace('_', ' ', substr($name, 5)))))] = $value;\n\t\t\t\t    }\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t$headers = getallheaders();\n\t\t\t}\n\t\t\t$result = array();\n\t\t\t$result['body'] = $this->request->data;\n\t\t\t$result['headers']['Content-type'] = isset($headers['Content-type']) ? $headers['Content-type'] : 0;\n\t\t\t$result['headers']['Accept'] = isset($headers['Accept']) ? $headers['Accept'] : 0;\n\t\t\t$result['headers']['Authorization'] = isset($headers['Authorization']) ? 'OK' : 0;\n\t\t\treturn new CakeResponse(array('body'=> json_encode($result), 'type' => 'json'));\n\t\t} else {\n\t\t\tthrow new MethodNotAllowedException('Invalid request, expecting a POST request.');\n\t\t}\n\t}\n\n\tpublic function testConnection($id = false) {\n\t\t\tif (!$this->Auth->user('Role')['perm_sync'] && !$this->Auth->user('Role')['perm_site_admin']) throw new MethodNotAllowedException('You don\\'t have permission to do that.');\n\t\t\t$this->Server->id = $id;\n\t\t\tif (!$this->Server->exists()) {\n\t\t\t\tthrow new NotFoundException(__('Invalid server'));\n\t\t\t}\n\t\t\t$result = $this->Server->runConnectionTest($id);\n\t\t\tif ($result['status'] == 1) {\n\t\t\t\t$version = json_decode($result['message'], true);\n\t\t\t\tif (isset($version['version']) && preg_match('/^[0-9]+\\.+[0-9]+\\.[0-9]+$/', $version['version'])) {\n\t\t\t\t\tApp::uses('Folder', 'Utility');\n\t\t\t\t\t$file = new File(ROOT . DS . 'VERSION.json', true);\n\t\t\t\t\t$local_version = json_decode($file->read(), true);\n\t\t\t\t\t$file->close();\n\t\t\t\t\t$version = explode('.', $version['version']);\n\t\t\t\t\t$mismatch = false;\n\t\t\t\t\t$newer = false;\n\t\t\t\t\t$parts = array('major', 'minor', 'hotfix');\n\t\t\t\t\tif ($version[0] == 2 && $version[1] == 4 && $version[2] > 68) {\n\t\t\t\t\t\t$post = $this->Server->runPOSTTest($id);\n\t\t\t\t\t}\n\t\t\t\t\t$testPost = false;\n\t\t\t\t\tforeach ($parts as $k => $v) {\n\t\t\t\t\t\tif (!$mismatch) {\n\t\t\t\t\t\t\tif ($version[$k] > $local_version[$v]) {\n\t\t\t\t\t\t\t\t$mismatch = $v;\n\t\t\t\t\t\t\t\t$newer = 'remote';\n\t\t\t\t\t\t\t} else if ($version[$k] < $local_version[$v]) {\n\t\t\t\t\t\t\t\t$mismatch = $v;\n\t\t\t\t\t\t\t\t$newer = 'local';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!isset($version['perm_sync'])) {\n\t\t\t\t\t\tif (!$this->Server->checkLegacyServerSyncPrivilege($id)) {\n\t\t\t\t\t\t\t$result['status'] = 7;\n\t\t\t\t\t\t\treturn new CakeResponse(array('body'=> json_encode($result), 'type' => 'json'));\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (!$version['perm_sync']) {\n\t\t\t\t\t\t\t$result['status'] = 7;\n\t\t\t\t\t\t\treturn new CakeResponse(array('body'=> json_encode($result), 'type' => 'json'));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\treturn new CakeResponse(\n\t\t\t\t\t\tarray(\n\t\t\t\t\t\t'body'=> json_encode(\n\t\t\t\t\t\t\tarray(\n\t\t\t\t\t\t\t\t'status' => 1,\n\t\t\t\t\t\t\t\t'local_version' => implode('.', $local_version),\n\t\t\t\t\t\t\t\t'version' => implode('.', $version),\n\t\t\t\t\t\t\t\t'mismatch' => $mismatch,\n\t\t\t\t\t\t\t\t'newer' => $newer,\n\t\t\t\t\t\t\t\t'post' => isset($post) ? $post : 'too old'\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t'type' => 'json'\n\t\t\t\t\t\t)\n\t\t\t\t\t);\n\t\t\t\t} else {\n\t\t\t\t\t$result['status'] = 3;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn new CakeResponse(array('body'=> json_encode($result), 'type' => 'json'));\n\t}\n\n\tpublic function startZeroMQServer() {\n\t\tif (!$this->_isSiteAdmin()) throw new MethodNotAllowedException();\n\t\t$pubSubTool = $this->Server->getPubSubTool();\n\t\t$result = $pubSubTool->restartServer();\n\t\tif ($result === true) return new CakeResponse(array('body'=> json_encode(array('saved' => true, 'success' => 'ZeroMQ server successfully started.')), 'status'=>200, 'type' => 'json'));\n\t\telse return new CakeResponse(array('body'=> json_encode(array('saved' => false, 'errors' => $result)), 'status'=>200, 'type' => 'json'));\n\t}\n\n\tpublic function stopZeroMQServer() {\n\t\tif (!$this->_isSiteAdmin()) throw new MethodNotAllowedException();\n\t\t$pubSubTool = $this->Server->getPubSubTool();\n\t\t$result = $pubSubTool->killService();\n\t\tif ($result === true) return new CakeResponse(array('body'=> json_encode(array('saved' => true, 'success' => 'ZeroMQ server successfully killed.')), 'status'=>200, 'type' => 'json'));\n\t\telse return new CakeResponse(array('body'=> json_encode(array('saved' => false, 'errors' => 'Could not kill the previous instance of the ZeroMQ script.')), 'status'=>200, 'type' => 'json'));\n\t}\n\n\tpublic function statusZeroMQServer() {\n\t\tif (!$this->_isSiteAdmin()) throw new MethodNotAllowedException();\n\t\t$pubSubTool = $this->Server->getPubSubTool();\n\t\t$result = $pubSubTool->statusCheck();\n\t\tif (!empty($result)) {\n\t\t\t$this->set('events', $result['publishCount']);\n\t\t\t$this->set('time', date('Y/m/d H:i:s', $result['timestamp']));\n\t\t\t$this->set('time2', date('Y/m/d H:i:s', $result['timestampSettings']));\n\t\t}\n\t\t$this->render('ajax/zeromqstatus');\n\t}\n\n\tpublic function purgeSessions() {\n\t\tif (!$this->_isSiteAdmin()) throw new MethodNotAllowedException();\n\t\tif ($this->Server->updateDatabase('cleanSessionTable') == false) {\n\t\t\t$this->Session->setFlash('Could not purge the session table.');\n\t\t}\n\t\t$this->redirect('/servers/serverSettings/diagnostics');\n\t}\n\n\tpublic function clearWorkerQueue($worker) {\n\t\tif (!$this->_isSiteAdmin() || !$this->request->is('Post') || $this->request->is('ajax')) throw new MethodNotAllowedException();\n\t\t$worker_array = array('cache', 'default', 'email', 'prio');\n\t\tif (!in_array($worker, $worker_array)) throw new MethodNotAllowedException('Invalid worker');\n\t\t$redis = Resque::redis();\n\t\t$redis->del('queue:' . $worker);\n\t\t$this->Session->setFlash('Queue cleared.');\n\t\t$this->redirect($this->referer());\n\t}\n\n\tpublic function getVersion() {\n\t\tif (!$this->userRole['perm_auth']) throw new MethodNotAllowedException('This action requires API access.');\n\t\t$versionArray = $this->Server->checkMISPVersion();\n\t\t$this->set('response', array('version' => $versionArray['major'] . '.' . $versionArray['minor'] . '.' . $versionArray['hotfix'], 'perm_sync' => $this->userRole['perm_sync']));\n\t\t$this->set('_serialize', 'response');\n\t}\n\n\tpublic function getPyMISPVersion() {\n\t\t$this->set('response', array('version' => $this->pyMispVersion));\n\t\t$this->set('_serialize', 'response');\n\t}\n\n\tpublic function getGit() {\n\t\t$status = $this->Server->getCurrentGitStatus();\n\t}\n\n\tpublic function checkout() {\n\t\t$result = $this->Server->checkoutMain();\n\t}\n\n\tpublic function update() {\n\t\tif ($this->request->is('post')) {\n\t\t\t$status = $this->Server->getCurrentGitStatus();\n\t\t\t$update = $this->Server->update($status);\n\t\t\treturn new CakeResponse(array('body'=> $update, 'type' => 'txt'));\n\t\t} else {\n\t\t\t$branch = $this->Server->getCurrentBranch();\n\t\t\t$this->set('branch', $branch);\n\t\t\t$this->render('ajax/update');\n\t\t}\n\t}\n\n\tpublic function getInstanceUUID() {\n\t\treturn $this->RestResponse->viewData(array('uuid' => Configure::read('MISP.uuid')), $this->response->type());\n\t}\n}\n", "<?php\nApp::uses('AppModel', 'Model');\n\nclass Server extends AppModel {\n\n\tpublic $name = 'Server';\n\n\tpublic $actsAs = array('SysLogLogable.SysLogLogable' => array(\t// TODO Audit, logable, check: 'userModel' and 'userKey' can be removed given default\n\t\t\t'userModel' => 'User',\n\t\t\t'userKey' => 'user_id',\n\t\t\t'change' => 'full'\n\t\t),\n\t\t'Trim',\n\t\t'Containable'\n\t);\n\n\tpublic $belongsTo = array(\n\t\t'Organisation' => array(\n\t\t\t'className' => 'Organisation',\n\t\t\t'foreignKey' => 'org_id',\n\t\t),\n\t\t'RemoteOrg' => array(\n\t\t\t'className' => 'Organisation',\n\t\t\t'foreignKey' => 'remote_org_id',\n\t\t)\n\t);\n\n\tpublic $hasMany = array(\n\t\t'SharingGroupServer' => array(\n\t\t\t'className' => 'SharingGroupServer',\n\t\t\t'foreignKey' => 'server_id',\n\t\t\t'dependent'=> true,\n\t\t),\n\t\t'User' => array(\n\t\t\t'className' => 'User',\n\t\t\t'foreignKey' => 'server_id',\n\t\t),\n\t);\n\n\tpublic $displayField = 'url';\n\n\tpublic $validate = array(\n\t\t'url' => array( // TODO add extra validation to refuse multiple time the same url from the same org\n\t\t\t'url' => array(\n\t\t\t\t'rule' => array('url'),\n\t\t\t\t'message' => 'Please enter a valid base-url.',\n\t\t\t\t//'allowEmpty' => false,\n\t\t\t\t//'required' => false,\n\t\t\t\t//'last' => false, // Stop validation after this rule\n\t\t\t\t//'on' => 'create', // Limit validation to 'create' or 'update' operations\n\t\t\t)\n\t\t),\n\t\t'authkey' => array(\n\t\t\t'minlength' => array(\n\t\t\t\t'rule' => array('minlength', 40),\n\t\t\t\t'message' => 'A authkey of a minimum length of 40 is required.',\n\t\t\t\t'required' => true,\n\t\t\t),\n\t\t\t'valueNotEmpty' => array(\n\t\t\t\t'rule' => array('valueNotEmpty'),\n\t\t\t),\n\t\t),\n\t\t'org_id' => array(\n\t\t\t'numeric' => array(\n\t\t\t\t'rule' => array('valueIsID'),\n\t\t\t\t'allowEmpty' => false,\n\t\t\t\t'required' => true,\n\t\t\t),\n\t\t),\n\t\t'push' => array(\n\t\t\t'boolean' => array(\n\t\t\t\t'rule' => array('boolean'),\n\t\t\t\t//'message' => 'Your custom message here',\n\t\t\t\t'allowEmpty' => true,\n\t\t\t\t'required' => false,\n\t\t\t\t//'last' => false, // Stop validation after this rule\n\t\t\t\t//'on' => 'create', // Limit validation to 'create' or 'update' operations\n\t\t\t),\n\t\t),\n\t\t'pull' => array(\n\t\t\t'boolean' => array(\n\t\t\t\t'rule' => array('boolean'),\n\t\t\t\t//'message' => 'Your custom message here',\n\t\t\t\t'allowEmpty' => true,\n\t\t\t\t//'required' => false,\n\t\t\t\t//'last' => false, // Stop validation after this rule\n\t\t\t\t//'on' => 'create', // Limit validation to 'create' or 'update' operations\n\t\t\t),\n\t\t),\n\t\t'lastpushedid' => array(\n\t\t\t'numeric' => array(\n\t\t\t\t'rule' => array('numeric'),\n\t\t\t\t//'message' => 'Your custom message here',\n\t\t\t\t'allowEmpty' => true,\n\t\t\t\t'required' => false,\n\t\t\t\t//'last' => false, // Stop validation after this rule\n\t\t\t\t//'on' => 'create', // Limit validation to 'create' or 'update' operations\n\t\t\t),\n\t\t),\n\t\t'lastpulledid' => array(\n\t\t\t'numeric' => array(\n\t\t\t\t'rule' => array('numeric'),\n\t\t\t\t//'message' => 'Your custom message here',\n\t\t\t\t'allowEmpty' => true,\n\t\t\t\t'required' => false,\n\t\t\t\t//'last' => false, // Stop validation after this rule\n\t\t\t\t//'on' => 'create', // Limit validation to 'create' or 'update' operations\n\t\t\t),\n\t\t),\n\t);\n\n\tpublic $serverSettings = array(\n\t\t\t'MISP' => array(\n\t\t\t\t\t'branch' => 1,\n\t\t\t\t\t'baseurl' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'The base url of the application (in the format https://www.mymispinstance.com). Several features depend on this setting being correctly set to function.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => 'The currenty set baseurl does not match the URL through which you have accessed the page. Disregard this if you are accessing the page via an alternate URL (for example via IP address).',\n\t\t\t\t\t\t\t'test' => 'testBaseURL',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'live' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'Unless set to true, the instance will only be accessible by site admins.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testLive',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t),\n\t\t\t\t\t'enable_advanced_correlations' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'Enable some performance heavy correlations (currently CIDR correlation)',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'max_correlations_per_event' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Sets the maximum number of correlations that can be fetched with a single event. For extreme edge cases this can prevent memory issues. The default value is 5k.',\n\t\t\t\t\t\t\t'value' => 5000,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForNumeric',\n\t\t\t\t\t\t\t'type' => 'numeric',\n\t\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'maintenance_message' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The message that users will see if the instance is not live.',\n\t\t\t\t\t\t\t'value' => 'Great things are happening! MISP is undergoing maintenance, but will return shortly. You can contact the administration at $email.',\n\t\t\t\t\t\t\t'errorMessage' => 'If this is not set the default value will be used.',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'name' => array(\n\t\t\t\t\t\t\t'level' => 3,\n\t\t\t\t\t\t\t'description' => 'This setting is deprecated and can be safely removed.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'version' => array(\n\t\t\t\t\t\t\t'level' => 3,\n\t\t\t\t\t\t\t'description' => 'This setting is deprecated and can be safely removed.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'disable_cached_exports' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Cached exports can take up a considerable amount of space and can be disabled instance wide using this setting. Disabling the cached exports is not recommended as it\\'s a valuable feature, however, if your server is having free space issues it might make sense to take this step.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'null' => true,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testDisableCache',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'afterHook' => 'disableCacheAfterHook',\n\t\t\t\t\t),\n\t\t\t\t\t'header' => array(\n\t\t\t\t\t\t\t'level' => 3,\n\t\t\t\t\t\t\t'description' => 'This setting is deprecated and can be safely removed.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'footermidleft' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Footer text prepending the \"Powered by MISP\" text.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'footermidright' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Footer text following the \"Powered by MISP\" text.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'footerpart1' => array(\n\t\t\t\t\t\t\t'level' => 3,\n\t\t\t\t\t\t\t'description' => 'This setting is deprecated and can be safely removed.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'footerpart2' => array(\n\t\t\t\t\t\t\t'level' => 3,\n\t\t\t\t\t\t\t'description' => 'This setting is deprecated and can be safely removed.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'footer' => array(\n\t\t\t\t\t\t\t'level' => 3,\n\t\t\t\t\t\t\t'description' => 'This setting is deprecated and can be safely removed.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'footerversion' => array(\n\t\t\t\t\t\t\t'level' => 3,\n\t\t\t\t\t\t\t'description' => 'This setting is deprecated and can be safely removed.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'footer_logo' => array(\n\t\t\t\t\t\t\t'level' => 2 ,\n\t\t\t\t\t\t\t'description' => 'If set, this setting allows you to display a logo on the right side of the footer. Upload it as a custom image in the file management tool.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForCustomImage',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'home_logo' => array(\n\t\t\t\t\t\t\t'level' => 2 ,\n\t\t\t\t\t\t\t'description' => 'If set, this setting allows you to display a logo as the home icon. Upload it as a custom image in the file management tool.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForCustomImage',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'main_logo' => array(\n\t\t\t\t\t\t\t'level' => 2 ,\n\t\t\t\t\t\t\t'description' => 'If set, the image specified here will replace the main MISP logo on the login screen. Upload it as a custom image in the file management tool.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForCustomImage',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'org' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'The organisation tag of the hosting organisation. This is used in the e-mail subjects.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'host_org_id' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'The hosting organisation of this instance. If this is not selected then replication instances cannot be added.',\n\t\t\t\t\t\t\t'value' => '0',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testLocalOrg',\n\t\t\t\t\t\t\t'type' => 'numeric',\n\t\t\t\t\t\t\t'optionsSource' => 'LocalOrgs',\n\t\t\t\t\t),\n\t\t\t\t\t'uuid' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'The MISP instance UUID. This UUID is used to identify this instance.',\n\t\t\t\t\t\t\t'value' => '0',\n\t\t\t\t\t\t\t'errorMessage' => 'No valid UUID set',\n\t\t\t\t\t\t\t'test' => 'testUuid',\n\t\t\t\t\t\t\t'type' => 'string'\n\t\t\t\t\t),\n\t\t\t\t\t'logo' => array(\n\t\t\t\t\t\t\t'level' => 3,\n\t\t\t\t\t\t\t'description' => 'This setting is deprecated and can be safely removed.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'showorg' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'Setting this setting to \\'false\\' will hide all organisation names / logos.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t),\n\t\t\t\t\t'threatlevel_in_email_subject' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Put the event threat level in the notification E-mail subject.',\n\t\t\t\t\t\t\t'value' => true,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t),\n\t\t\t\t\t'email_subject_TLP_string' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'This is the TLP string for e-mails when email_subject_tag is not found.',\n\t\t\t\t\t\t\t'value' => 'TLP Amber',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t),\n\t\t\t\t\t'email_subject_tag' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => \"If this tag is set on an event it's value will be sent in the E-mail subject. If the tag is not set the email_subject_TLP_string will be used.\",\n\t\t\t\t\t\t\t'value' => 'tlp',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t),\n\t\t\t\t\t'email_subject_include_tag_name' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Include in name of the email_subject_tag in the subject. When false only the tag value is used.',\n\t\t\t\t\t\t\t'value' => true,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t),\n\t\t\t\t\t'taxii_sync' => array(\n\t\t\t\t\t\t\t'level' => 3,\n\t\t\t\t\t\t\t'description' => 'This setting is deprecated and can be safely removed.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'taxii_client_path' => array(\n\t\t\t\t\t\t\t'level' => 3,\n\t\t\t\t\t\t\t'description' => 'This setting is deprecated and can be safely removed.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'background_jobs' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Enables the use of MISP\\'s background processing.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t),\n\t\t\t\t\t'attachments_dir' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Directory where attachments are stored. MISP will NOT migrate the existing data if you change this setting. The only safe way to change this setting is in config.php, when MISP is not running, and after having moved/copied the existing data to the new location. This directory must already exist and be writable and readable by the MISP application.',\n\t\t\t\t\t\t\t'value' =>  'app/files', # GUI display purpose only. Default value defined in func getDefaultAttachments_dir()\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'null' => false,\n\t\t\t\t\t\t\t'test' => 'testForWritableDir',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'cached_attachments' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Allow the XML caches to include the encoded attachments.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t),\n\t\t\t\t\t'email' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'The e-mail address that MISP should use for all notifications',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'disable_emailing' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'You can disable all e-mailing using this setting. When enabled, no outgoing e-mails will be sent by MISP.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'null' => true,\n\t\t\t\t\t\t\t'test' => 'testDisableEmail',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t),\n\t\t\t\t\t'contact' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'The e-mail address that MISP should include as a contact address for the instance\\'s support team.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'dns' => array(\n\t\t\t\t\t\t\t'level' => 3,\n\t\t\t\t\t\t\t'description' => 'This setting is deprecated and can be safely removed.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'cveurl' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Turn Vulnerability type attributes into links linking to the provided CVE lookup',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'disablerestalert' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'This setting controls whether notification e-mails will be sent when an event is created via the REST interface. It might be a good idea to disable this setting when first setting up a link to another instance to avoid spamming your users during the initial pull. Quick recap: True = Emails are NOT sent, False = Emails are sent on events published via sync / REST.',\n\t\t\t\t\t\t\t'value' => true,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t),\n\t\t\t\t\t'extended_alert_subject' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'enabling this flag will allow the event description to be transmitted in the alert e-mail\\'s subject. Be aware that this is not encrypted by PGP, so only enable it if you accept that part of the event description will be sent out in clear-text.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'default_event_distribution' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'The default distribution setting for events (0-3).',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'options' => array('0' => 'Your organisation only', '1' => 'This community only', '2' => 'Connected communities', '3' => 'All communities'),\n\t\t\t\t\t),\n\t\t\t\t\t'default_attribute_distribution' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'The default distribution setting for attributes, set it to \\'event\\' if you would like the attributes to default to the event distribution level. (0-3 or \"event\")',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'options' => array('0' => 'Your organisation only', '1' => 'This community only', '2' => 'Connected communities', '3' => 'All communities', 'event' => 'Inherit from event'),\n\t\t\t\t\t),\n\t\t\t\t\t'default_event_threat_level' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'The default threat level setting when creating events.',\n\t\t\t\t\t\t\t'value' => '4',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'options' => array('1' => 'High', '2' => 'Medium', '3' => 'Low', '4' => 'undefined'),\n\t\t\t\t\t),\n\t\t\t\t\t'tagging' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Enable the tagging feature of MISP. This is highly recommended.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t),\n\t\t\t\t\t'full_tags_on_event_index' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' =>'Show the full tag names on the event index.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'options' => array(0 => 'Minimal tags', 1 => 'Full tags', 2 => 'Shortened tags'),\n\t\t\t\t\t),\n\t\t\t\t\t'welcome_text_top' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Used on the login page, before the MISP logo',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'welcome_text_bottom' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Used on the login page, after the MISP logo',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'welcome_logo' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Used on the login page, to the left of the MISP logo, upload it as a custom image in the file management tool.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForCustomImage',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'welcome_logo2' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Used on the login page, to the right of the MISP logo, upload it as a custom image in the file management tool.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForCustomImage',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'title_text' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'Used in the page title, after the name of the page',\n\t\t\t\t\t\t'value' => 'MISP',\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'take_ownership_xml_import' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Allows users to take ownership of an event uploaded via the \"Add MISP XML\" button. This allows spoofing the creator of a manually imported event, also breaking possibly breaking the original intended releasability. Synchronising with an instance that has a different creator for the same event can lead to unwanted consequences.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t),\n\t\t\t\t\t'terms_download' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Choose whether the terms and conditions should be displayed inline (false) or offered as a download (true)',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'terms_file' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The filename of the terms and conditions file. Make sure that the file is located in your MISP/app/files/terms directory',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForTermsFile',\n\t\t\t\t\t\t\t'type' => 'string'\n\t\t\t\t\t),\n\t\t\t\t\t'showorgalternate' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'True enables the alternate org fields for the event index (source org and member org) instead of the traditional way of showing only an org field. This allows users to see if an event was uploaded by a member organisation on their MISP instance, or if it originated on an interconnected instance.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'unpublishedprivate' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'True will deny access to unpublished events to users outside the organization of the submitter except site admins.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'newUserText' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'bigField' => true,\n\t\t\t\t\t\t\t'description' => 'The message sent to the user after account creation (has to be sent manually from the administration interface). Use \\\\n for line-breaks. The following variables will be automatically replaced in the text: $password = a new temporary password that MISP generates, $username = the user\\'s e-mail address, $misp = the url of this instance, $org = the organisation that the instance belongs to, as set in MISP.org, $contact = the e-mail address used to contact the support team, as set in MISP.contact. For example, \"the password for $username is $password\" would appear to a user with the e-mail address user@misp.org as \"the password for user@misp.org is hNamJae81\".',\n\t\t\t\t\t\t\t'value' => 'Dear new MISP user,\\n\\nWe would hereby like to welcome you to the $org MISP community.\\n\\n Use the credentials below to log into MISP at $misp, where you will be prompted to manually change your password to something of your own choice.\\n\\nUsername: $username\\nPassword: $password\\n\\nIf you have any questions, don\\'t hesitate to contact us at: $contact.\\n\\nBest regards,\\nYour $org MISP support team',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testPasswordResetText',\n\t\t\t\t\t\t\t'type' => 'string'\n\t\t\t\t\t),\n\t\t\t\t\t'passwordResetText' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'bigField' => true,\n\t\t\t\t\t\t\t'description' => 'The message sent to the users when a password reset is triggered. Use \\\\n for line-breaks. The following variables will be automatically replaced in the text: $password = a new temporary password that MISP generates, $username = the user\\'s e-mail address, $misp = the url of this instance, $contact = the e-mail address used to contact the support team, as set in MISP.contact. For example, \"the password for $username is $password\" would appear to a user with the e-mail address user@misp.org as \"the password for user@misp.org is hNamJae81\".',\n\t\t\t\t\t\t\t'value' => 'Dear MISP user,\\n\\nA password reset has been triggered for your account. Use the below provided temporary password to log into MISP at $misp, where you will be prompted to manually change your password to something of your own choice.\\n\\nUsername: $username\\nYour temporary password: $password\\n\\nIf you have any questions, don\\'t hesitate to contact us at: $contact.\\n\\nBest regards,\\nYour $org MISP support team',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testPasswordResetText',\n\t\t\t\t\t\t\t'type' => 'string'\n\t\t\t\t\t),\n\t\t\t\t\t'enableEventBlacklisting' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Since version 2.3.107 you can start blacklisting event UUIDs to prevent them from being pushed to your instance. This functionality will also happen silently whenever an event is deleted, preventing a deleted event from being pushed back from another instance.',\n\t\t\t\t\t\t\t'value' => true,\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'test' => 'testBool'\n\t\t\t\t\t),\n\t\t\t\t\t'enableOrgBlacklisting' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Blacklisting organisation UUIDs to prevent the creation of any event created by the blacklisted organisation.',\n\t\t\t\t\t\t\t'value' => true,\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'test' => 'testBool'\n\t\t\t\t\t),\n\t\t\t\t\t'log_client_ip' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'If enabled, all log entries will include the IP address of the user.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'beforeHook' => 'ipLogBeforeHook'\n\t\t\t\t\t),\n\t\t\t\t\t'log_auth' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'If enabled, MISP will log all successful authentications using API keys. The requested URLs are also logged.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t),\n\t\t\t\t\t'delegation' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'This feature allows users to created org only events and ask another organisation to take owenership of the event. This allows organisations to remain anonymous by asking a partner to publish an event for them.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'showCorrelationsOnIndex' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'When enabled, the number of correlations visible to the currently logged in user will be visible on the event index UI. This comes at a performance cost but can be very useful to see correlating events at a glance.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'showProposalsCountOnIndex' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'When enabled, the number of proposals for the events are shown on the index.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'showSightingsCountOnIndex' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'When enabled, the aggregate number of attribute sightings within the event becomes visible to the currently logged in user on the event index UI.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'showDiscussionsCountOnIndex' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'When enabled, the aggregate number of discussion posts for the event becomes visible to the currently logged in user on the event index UI.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'disableUserSelfManagement' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'When enabled only Org and Site admins can edit a user\\'s profile.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => false,\n\n\t\t\t\t\t),\n\t\t\t\t\t'block_event_alert' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Enable this setting to start blocking alert e-mails for events with a certain tag. Define the tag in MISP.block_event_alert_tag.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => false,\n\t\t\t\t\t),\n\t\t\t\t\t'block_event_alert_tag' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'If the MISP.block_event_alert setting is set, alert e-mails for events tagged with the tag defined by this setting will be blocked.',\n\t\t\t\t\t\t\t'value' => 'no-alerts=\"true\"',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'null' => false,\n\t\t\t\t\t),\n\t\t\t\t\t'block_old_event_alert' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Enable this setting to start blocking alert e-mails for old events. The exact timing of what constitutes an old event is defined by MISP.block_old_event_alert_age.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => false,\n\t\t\t\t\t),\n\t\t\t\t\t'block_old_event_alert_age' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'If the MISP.block_old_event_alert setting is set, this setting will control how old an event can be for it to be alerted on. The \"Date\" field of the event is used. Expected format: integer, in days',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForNumeric',\n\t\t\t\t\t\t\t'type' => 'numeric',\n\t\t\t\t\t\t\t'null' => false,\n\t\t\t\t\t),\n\t\t\t\t\t'tmpdir' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Please indicate the temp directory you wish to use for certain functionalities in MISP. By default this is set to /tmp and will be used among others to store certain temporary files extracted from imports during the import process.',\n\t\t\t\t\t\t\t'value' => '/tmp',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForPath',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'null' => true,\n\t\t\t\t\t),\n\t\t\t\t\t'custom_css' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'If you would like to customise the css, simply drop a css file in the /var/www/MISP/webroot/css directory and enter the name here.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForStyleFile',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'null' => true,\n\t\t\t\t\t),\n\t\t\t\t\t'proposals_block_attributes' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'Enable this setting to allow blocking attributes from to_ids sensitive exports if a proposal has been made to it to remove the IDS flag or to remove the attribute altogether. This is a powerful tool to deal with false-positives efficiently.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => false,\n\t\t\t\t\t),\n\t\t\t\t\t'incoming_tags_disabled_by_default' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Enable this settings if new tags synced / added via incoming events from any source should not be selectable by users by default.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => false\n\t\t\t\t\t),\n\t\t\t\t\t'completely_disable_correlation' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => '*WARNING* This setting will completely disable the correlation on this instance and remove any existing saved correlations. Enabling this will trigger a full recorrelation of all data which is an extremely long and costly procedure. Only enable this if you know what you\\'re doing.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBoolFalse',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => true,\n\t\t\t\t\t\t\t'afterHook' => 'correlationAfterHook',\n\t\t\t\t\t),\n\t\t\t\t\t'allow_disabling_correlation' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => '*WARNING* This setting will give event creators the possibility to disable the correlation of individual events / attributes that they have created.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBoolFalse',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'redis_host' => array(\n\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t'description' => 'The host running the redis server to be used for generic MISP tasks such as caching. This is not to be confused by the redis server used by the background processing.',\n\t\t\t\t\t\t'value' => '127.0.0.1',\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t'type' => 'string'\n\t\t\t\t\t),\n\t\t\t\t\t'redis_port' => array(\n\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t'description' => 'The port used by the redis server to be used for generic MISP tasks such as caching. This is not to be confused by the redis server used by the background processing.',\n\t\t\t\t\t\t'value' => 6379,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testForNumeric',\n\t\t\t\t\t\t'type' => 'numeric'\n\t\t\t\t\t),\n\t\t\t\t\t'redis_database' => array(\n\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t'description' => 'The database on the redis server to be used for generic MISP tasks. If you run more than one MISP instance, please make sure to use a different database on each instance.',\n\t\t\t\t\t\t'value' => 13,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testForNumeric',\n\t\t\t\t\t\t'type' => 'numeric'\n\t\t\t\t\t),\n\t\t\t\t\t'redis_password' => array(\n\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t'description' => 'The password on the redis server (if any) to be used for generic MISP tasks.',\n\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => null,\n\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t'redacted' => true\n\t\t\t\t\t),\n\t\t\t\t\t'event_view_filter_fields' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'Specify which fields to filter on when you search on the event view. Default values are : \"id, uuid, value, comment, type, category, Tag.name\"',\n\t\t\t\t\t\t'value' => 'id, uuid, value, comment, type, category, Tag.name',\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => null,\n\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t)\n\t\t\t),\n\t\t\t'GnuPG' => array(\n\t\t\t\t\t'branch' => 1,\n\t\t\t\t\t'binary' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The location of the GPG executable. If you would like to use a different gpg executable than /usr/bin/gpg, you can set it here. If the default is fine, just keep the setting suggested by MISP.',\n\t\t\t\t\t\t\t'value' => '/usr/bin/gpg',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForGPGBinary',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'onlyencrypted' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'Allow (false) unencrypted e-mails to be sent to users that don\\'t have a PGP key.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t),\n\t\t\t\t\t'bodyonlyencrypted' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Allow (false) the body of unencrypted e-mails to contain details about the event.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n                    ),\n                    'sign' => array(\n                            'level' => 2,\n                            'description' => 'Enable the signing of GPG emails. By default, GPG emails are signed',\n                            'value' => 'true',\n                            'errorMessage' => '',\n                            'test' => 'testBool',\n                            'type' => 'boolean',\n                    ),\n\t\t\t\t\t'email' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'The e-mail address that the instance\\'s PGP key is tied to.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'password' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'The password (if it is set) of the PGP key of the instance.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'redacted' => true\n\t\t\t\t\t),\n\t\t\t\t\t'homedir' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'The location of the GPG homedir.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t)\n\t\t\t),\n\t\t\t'SMIME' => array(\n\t\t\t\t\t'branch' => 1,\n\t\t\t\t\t'enabled' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Enable SMIME encryption. The encryption posture of the GnuPG.onlyencrypted and GnuPG.bodyonlyencrypted settings are inherited if SMIME is enabled.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t),\n\t\t\t\t\t'email' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The e-mail address that the instance\\'s SMIME key is tied to.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'cert_public_sign' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The location of the public half of the signing certificate.',\n\t\t\t\t\t\t\t'value' => '/var/www/MISP/.smime/email@address.com.pem',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'key_sign' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The location of the private half of the signing certificate.',\n\t\t\t\t\t\t\t'value' => '/var/www/MISP/.smime/email@address.com.key',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'password' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The password (if it is set) of the SMIME key of the instance.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'redacted' => true\n\t\t\t\t\t),\n\t\t\t),\n\t\t\t'Proxy' => array(\n\t\t\t\t\t'branch' => 1,\n\t\t\t\t\t'host' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The hostname of an HTTP proxy for outgoing sync requests. Leave empty to not use a proxy.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'port' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The TCP port for the HTTP proxy.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForNumeric',\n\t\t\t\t\t\t\t'type' => 'numeric',\n\t\t\t\t\t),\n\t\t\t\t\t'method' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The authentication method for the HTTP proxy. Currently supported are Basic or Digest. Leave empty for no proxy authentication.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'user' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The authentication username for the HTTP proxy.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'password' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The authentication password for the HTTP proxy.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t),\n\t\t\t'Security' => array(\n\t\t\t\t\t'branch' => 1,\n\t\t\t\t\t'salt' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'The salt used for the hashed passwords. You cannot reset this from the GUI, only manually from the settings.php file. Keep in mind, this will invalidate all passwords in the database.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testSalt',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'editable' => false,\n\t\t\t\t\t),\n\t\t\t\t\t'syslog' => array(\n\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t'description' => 'Enable this setting to pass all audit log entries directly to syslog. Keep in mind, this is verbose and will include user, organisation, event data.',\n\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'password_policy_length' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Password length requirement. If it is not set or it is set to 0, then the default value is assumed (12).',\n\t\t\t\t\t\t\t'value' => '12',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testPasswordLength',\n\t\t\t\t\t\t\t'type' => 'numeric',\n\t\t\t\t\t),\n\t\t\t\t\t'password_policy_complexity' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Password complexity requirement. Leave it empty for the default setting (3 out of 4, with either a digit or a special char) or enter your own regex. Keep in mind that the length is checked in another key. Default (simple 3 out of 4 or minimum 16 characters): /^((?=.*\\d)|(?=.*\\W+))(?![\\n])(?=.*[A-Z])(?=.*[a-z]).*$|.{16,}/',\n\t\t\t\t\t\t\t'value' => '/^((?=.*\\d)|(?=.*\\W+))(?![\\n])(?=.*[A-Z])(?=.*[a-z]).*$|.{16,}/',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testPasswordRegex',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'require_password_confirmation' => array(\n\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t'description' => 'Enabling this setting will require users to submit their current password on any edits to their profile (including a triggered password change). For administrators, the confirmation will be required when changing the profile of any user. Could potentially mitigate an attacker trying to change a compromised user\\'s password in order to establish persistance, however, enabling this feature will be highly annoying to users.',\n\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'sanitise_attribute_on_delete' => array(\n\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t'description' => 'Enabling this setting will sanitise the contents of an attribute on a soft delete',\n\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'hide_organisation_index_from_users' => array(\n\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t'description' => 'Enabling this setting will block the organisation index from being visible to anyone besides site administrators on the current instance. Keep in mind that users can still see organisations that produce data via events, proposals, event history log entries, etc.',\n\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t'null' => true\n\t\t\t\t\t)\n\t\t\t),\n\t\t\t'SecureAuth' => array(\n\t\t\t\t\t'branch' => 1,\n\t\t\t\t\t'amount' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'The number of tries a user can try to login and fail before the bruteforce protection kicks in.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForNumeric',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'expire' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'The duration (in seconds) of how long the user will be locked out when the allowed number of login attempts are exhausted.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForNumeric',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t),\n\t\t\t'Session' => array(\n\t\t\t\t\t'branch' => 1,\n\t\t\t\t\t'autoRegenerate' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Set to true to automatically regenerate sessions on activity. (Recommended)',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t),\n\t\t\t\t\t'defaults' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'The session type used by MISP. The default setting is php, which will use the session settings configured in php.ini for the session data (supported options: php, database). The recommended option is php and setting your PHP up to use redis sessions via your php.ini. Just add \\'session.save_handler = redis\\' and \"session.save_path = \\'tcp://localhost:6379\\'\" (replace the latter with your redis connection) to ',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForSessionDefaults',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'options' => array('php' => 'php', 'database' => 'database', 'cake' => 'cake', 'cache' => 'cache'),\n\t\t\t\t\t),\n\t\t\t\t\t'timeout' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'The timeout duration of sessions (in MINUTES). Keep in mind that autoregenerate can be used to extend the session on user activity.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForNumeric',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t)\n\t\t\t),\n\t\t\t'Plugin' => array(\n\t\t\t\t\t'branch' => 1,\n\t\t\t\t\t'RPZ_policy' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'The default policy action for the values added to the RPZ.',\n\t\t\t\t\t\t'value' => 0,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testForRPZBehaviour',\n\t\t\t\t\t\t'type' => 'numeric',\n\t\t\t\t\t\t'options' => array(0 => 'DROP', 1 => 'NXDOMAIN', 2 => 'NODATA', 3 => 'walled-garden'),\n\t\t\t\t\t),\n\t\t\t\t\t'RPZ_walled_garden' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'The default walled garden used by the RPZ export if the walled garden setting is picked for the export.',\n\t\t\t\t\t\t'value' => '127.0.0.1',\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'RPZ_serial' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The serial in the SOA portion of the zone file. (numeric, best practice is yyyymmddrr where rr is the two digit sub-revision of the file. $date will automatically get converted to the current yyyymmdd, so $date00 is a valid setting).',\n\t\t\t\t\t\t\t'value' => '$date00',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForRPZSerial',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'RPZ_refresh' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The refresh specified in the SOA portion of the zone file. (in seconds, or shorthand duration such as 15m)',\n\t\t\t\t\t\t\t'value' => '2h',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForRPZDuration',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'RPZ_retry' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The retry specified in the SOA portion of the zone file. (in seconds, or shorthand duration such as 15m)',\n\t\t\t\t\t\t\t'value' => '30m',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForRPZDuration',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'RPZ_expiry' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The expiry specified in the SOA portion of the zone file. (in seconds, or shorthand duration such as 15m)',\n\t\t\t\t\t\t\t'value' => '30d',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForRPZDuration',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'RPZ_minimum_ttl' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The minimum TTL specified in the SOA portion of the zone file. (in seconds, or shorthand duration such as 15m)',\n\t\t\t\t\t\t\t'value' => '1h',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForRPZDuration',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'RPZ_ttl' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The TTL of the zone file. (in seconds, or shorthand duration such as 15m)',\n\t\t\t\t\t\t\t'value' => '1w',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForRPZDuration',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'RPZ_ns' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => '',\n\t\t\t\t\t\t\t'value' => 'localhost.',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'RPZ_ns_alt' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'Alternate nameserver',\n\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t),\n\t\t\t\t\t'RPZ_email' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'The e-mail address specified in the SOA portion of the zone file.',\n\t\t\t\t\t\t'value' => 'root.localhost',\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t),\n\t\t\t\t\t'ZeroMQ_enable' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'Enables or disables the pub/sub feature of MISP. Make sure that you install the requirements for the plugin to work. Refer to the installation instructions for more information.',\n\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t'afterHook' => 'zmqAfterHook',\n\t\t\t\t\t),\n\t\t\t\t\t'ZeroMQ_port' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'The port that the pub/sub feature will use.',\n\t\t\t\t\t\t'value' => 50000,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testForZMQPortNumber',\n\t\t\t\t\t\t'type' => 'numeric',\n\t\t\t\t\t\t'afterHook' => 'zmqAfterHook',\n\t\t\t\t\t),\n\t\t\t\t\t'ZeroMQ_redis_host' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'Location of the Redis db used by MISP and the Python PUB script to queue data to be published.',\n\t\t\t\t\t\t'value' => 'localhost',\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t'afterHook' => 'zmqAfterHook',\n\t\t\t\t\t),\n\t\t\t\t\t'ZeroMQ_redis_port' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'The port that Redis is listening on.',\n\t\t\t\t\t\t'value' => 6379,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testForPortNumber',\n\t\t\t\t\t\t'type' => 'numeric',\n\t\t\t\t\t\t'afterHook' => 'zmqAfterHook',\n\t\t\t\t\t),\n\t\t\t\t\t'ZeroMQ_redis_password' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'The password, if set for Redis.',\n\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t'afterHook' => 'zmqAfterHook',\n\t\t\t\t\t),\n\t\t\t\t\t'ZeroMQ_redis_database' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'The database to be used for queuing messages for the pub/sub functionality.',\n\t\t\t\t\t\t'value' => '1',\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t'afterHook' => 'zmqAfterHook',\n\t\t\t\t\t),\n\t\t\t\t\t'ZeroMQ_redis_namespace' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'The namespace to be used for queuing messages for the pub/sub functionality.',\n\t\t\t\t\t\t'value' => 'mispq',\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t'afterHook' => 'zmqAfterHook',\n\t\t\t\t\t),\n\t\t\t\t\t'ZeroMQ_event_notifications_enable' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'Enables or disables the publishing of any event creations/edits/deletions.',\n\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'ZeroMQ_object_notifications_enable' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'Enables or disables the publishing of any object creations/edits/deletions.',\n\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'ZeroMQ_object_reference_notifications_enable' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'Enables or disables the publishing of any object reference creations/deletions.',\n\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'ZeroMQ_attribute_notifications_enable' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'Enables or disables the publishing of any attribute creations/edits/soft deletions.',\n\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'ZeroMQ_tag_notifications_enable' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'Enables or disables the publishing of any tag creations/edits/deletions as well as tags being attached to / detached from various MISP elements.',\n\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'ZeroMQ_sighting_notifications_enable' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'Enables or disables the publishing of new sightings to the ZMQ pubsub feed.',\n\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'ZeroMQ_user_notifications_enable' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'Enables or disables the publishing of new/modified users to the ZMQ pubsub feed.',\n\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'ZeroMQ_organisation_notifications_enable' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'Enables or disables the publishing of new/modified organisations to the ZMQ pubsub feed.',\n\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'ZeroMQ_audit_notifications_enable' => array(\n\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t'description' => 'Enables or disables the publishing of log entries to the ZMQ pubsub feed. Keep in mind, this can get pretty verbose depending on your logging settings.',\n\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'Sightings_policy' => array(\n\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t'description' => 'This setting defines who will have access to seeing the reported sightings. The default setting is the event owner alone (in addition to everyone seeing their own contribution) with the other options being Sighting reporters (meaning the event owner and anyone that provided sighting data about the event) and Everyone (meaning anyone that has access to seeing the event / attribute).',\n\t\t\t\t\t\t'value' => 0,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testForSightingVisibility',\n\t\t\t\t\t\t'type' => 'numeric',\n\t\t\t\t\t\t'options' => array(0 => 'Event Owner', 1 => 'Sighting reporters', 2 => 'Everyone'),\n\t\t\t\t\t),\n\t\t\t\t\t'Sightings_anonymise' => array(\n\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t'description' => 'Enabling the anonymisation of sightings will simply aggregate all sightings instead of showing the organisations that have reported a sighting. Users will be able to tell the number of sightings their organisation has submitted and the number of sightings for other organisations',\n\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t),\n\t\t\t\t\t'Sightings_range' => array(\n\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t'description' => 'Set the range in which sightings will be taken into account when generating graphs. For example a sighting with a sighted_date of 7 years ago might not be relevant anymore. Setting given in number of days, default is 365 days',\n\t\t\t\t\t\t'value' => 365,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testForNumeric',\n\t\t\t\t\t\t'type' => 'numeric'\n\t\t\t\t\t),\n\t\t\t\t\t'CustomAuth_enable' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Enable this functionality if you would like to handle the authentication via an external tool and authenticate with MISP using a custom header.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => true,\n\t\t\t\t\t\t\t'beforeHook' => 'customAuthBeforeHook'\n\t\t\t\t\t),\n\t\t\t\t\t'CustomAuth_header' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Set the header that MISP should look for here. If left empty it will default to the Authorization header.',\n\t\t\t\t\t\t\t'value' => 'Authorization',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'CustomAuth_use_header_namespace' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Use a header namespace for the auth header - default setting is enabled',\n\t\t\t\t\t\t\t'value' => true,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'CustomAuth_header_namespace' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The default header namespace for the auth header - default setting is HTTP_',\n\t\t\t\t\t\t\t'value' => 'HTTP_',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'CustomAuth_required' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'If this setting is enabled then the only way to authenticate will be using the custom header. Altnertatively you can run in mixed mode that will log users in via the header if found, otherwise users will be redirected to the normal login page.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'CustomAuth_only_allow_source' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'If you are using an external tool to authenticate with MISP and would like to only allow the tool\\'s url as a valid point of entry then set this field. ',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'CustomAuth_name' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'The name of the authentication method, this is cosmetic only and will be shown on the user creation page and logs.',\n\t\t\t\t\t\t\t'value' => 'External authentication',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'CustomAuth_disable_logout' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Disable the logout button for users authenticate with the external auth mechanism.',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'Enrichment_services_enable' => array(\n\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t'description' => 'Enable/disable the enrichment services',\n\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'Enrichment_timeout' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Set a timeout for the enrichment services',\n\t\t\t\t\t\t\t'value' => 10,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'numeric'\n\t\t\t\t\t),\n\t\t\t\t\t'Import_services_enable' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'Enable/disable the import services',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'Import_timeout' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Set a timeout for the import services',\n\t\t\t\t\t\t\t'value' => 10,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'numeric'\n\t\t\t\t\t),\n\t\t\t\t\t'Import_services_url' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'The url used to access the import services. By default, it is accessible at http://127.0.0.1:6666',\n\t\t\t\t\t\t\t'value' => 'http://127.0.0.1',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string'\n\t\t\t\t\t),\n\t\t\t\t\t'Import_services_port' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'The port used to access the import services. By default, it is accessible at 127.0.0.1:6666',\n\t\t\t\t\t\t\t'value' => '6666',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForPortNumber',\n\t\t\t\t\t\t\t'type' => 'numeric'\n\t\t\t\t\t),\n\t\t\t\t\t'Export_services_url' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'The url used to access the export services. By default, it is accessible at http://127.0.0.1:6666',\n\t\t\t\t\t\t\t'value' => 'http://127.0.0.1',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string'\n\t\t\t\t\t),\n\t\t\t\t\t'Export_services_port' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'The port used to access the export services. By default, it is accessible at 127.0.0.1:6666',\n\t\t\t\t\t\t\t'value' => '6666',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForPortNumber',\n\t\t\t\t\t\t\t'type' => 'numeric'\n\t\t\t\t\t),\n\t\t\t\t\t'Export_services_enable' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'Enable/disable the export services',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'Export_timeout' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Set a timeout for the export services',\n\t\t\t\t\t\t\t'value' => 10,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'numeric'\n\t\t\t\t\t),\n\t\t\t\t\t'Enrichment_hover_enable' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'Enable/disable the hover over information retrieved from the enrichment modules',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'Enrichment_hover_timeout' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Set a timeout for the hover services',\n\t\t\t\t\t\t\t'value' => 5,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'numeric'\n\t\t\t\t\t),\n\t\t\t\t\t'Enrichment_services_url' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'The url used to access the enrichment services. By default, it is accessible at http://127.0.0.1:6666',\n\t\t\t\t\t\t\t'value' => 'http://127.0.0.1',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string'\n\t\t\t\t\t),\n\t\t\t\t\t'Enrichment_services_port' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'The port used to access the enrichment services. By default, it is accessible at 127.0.0.1:6666',\n\t\t\t\t\t\t\t'value' => '6666',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForPortNumber',\n\t\t\t\t\t\t\t'type' => 'numeric'\n\t\t\t\t\t),\n\t\t\t\t\t'Cortex_services_url' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'The url used to access Cortex. By default, it is accessible at http://cortex-url',\n\t\t\t\t\t\t\t'value' => 'http://127.0.0.1',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string'\n\t\t\t\t\t),\n\t\t\t\t\t'Cortex_services_port' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'The port used to access Cortex. By default, this is port 9000',\n\t\t\t\t\t\t\t'value' => '9000',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForPortNumber',\n\t\t\t\t\t\t\t'type' => 'numeric'\n\t\t\t\t\t),\n\t\t\t\t\t'Cortex_services_enable' => array(\n\t\t\t\t\t\t\t'level' => 0,\n\t\t\t\t\t\t\t'description' => 'Enable/disable the import services',\n\t\t\t\t\t\t\t'value' => false,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testBool',\n\t\t\t\t\t\t\t'type' => 'boolean'\n\t\t\t\t\t),\n\t\t\t\t\t'Cortex_timeout' => array(\n\t\t\t\t\t\t\t'level' => 1,\n\t\t\t\t\t\t\t'description' => 'Set a timeout for the import services',\n\t\t\t\t\t\t\t'value' => 120,\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'numeric'\n\t\t\t\t\t),\n\t\t\t\t\t'CustomAuth_custom_password_reset' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Provide your custom authentication users with an external URL to the authentication system to reset their passwords.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'null' => true\n\t\t\t\t\t),\n\t\t\t\t\t'CustomAuth_custom_logout' => array(\n\t\t\t\t\t\t\t'level' => 2,\n\t\t\t\t\t\t\t'description' => 'Provide a custom logout URL for your users that will log them out using the authentication system you use.',\n\t\t\t\t\t\t\t'value' => '',\n\t\t\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t\t\t'test' => 'testForEmpty',\n\t\t\t\t\t\t\t'type' => 'string',\n\t\t\t\t\t\t\t'null' => true\n\t\t\t\t\t)\n\t\t\t),\n\t\t\t'debug' => array(\n\t\t\t\t\t'level' => 0,\n\t\t\t\t\t'description' => 'The debug level of the instance, always use 0 for production instances.',\n\t\t\t\t\t'value' => '',\n\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t'test' => 'testDebug',\n\t\t\t\t\t'type' => 'numeric',\n\t\t\t\t\t'options' => array(0 => 'Debug off', 1 => 'Debug on', 2 => 'Debug + SQL dump'),\n\t\t\t),\n\t\t\t'site_admin_debug' => array(\n\t\t\t\t\t'level' => 0,\n\t\t\t\t\t'description' => 'The debug level of the instance for site admins. This feature allows site admins to run debug mode on a live instance without exposing it to other users. The most verbose option of debug and site_admin_debug is used for site admins.',\n\t\t\t\t\t'value' => '',\n\t\t\t\t\t'errorMessage' => '',\n\t\t\t\t\t'test' => 'testDebugAdmin',\n\t\t\t\t\t'type' => 'boolean',\n\t\t\t\t\t'null' => true\n\t\t\t),\n\t);\n\n\tprivate $__settingTabMergeRules = array(\n\t\t\t'GnuPG' => 'Encryption',\n\t\t\t'SMIME' => 'Encryption',\n\t\t\t'misc' => 'Security',\n\t\t\t'Security' => 'Security',\n\t\t\t'Session' => 'Security'\n\t);\n\n\tpublic $validEventIndexFilters = array('searchall', 'searchpublished', 'searchorg', 'searchtag', 'searcheventid', 'searchdate', 'searcheventinfo', 'searchthreatlevel', 'searchdistribution', 'searchanalysis', 'searchattribute');\n\n\tpublic function isOwnedByOrg($serverid, $org) {\n\t\treturn $this->field('id', array('id' => $serverid, 'org' => $org)) === $serverid;\n\t}\n\n\tpublic function beforeSave($options = array()) {\n\t\t$this->data['Server']['url'] = rtrim($this->data['Server']['url'], '/');\n\t\treturn true;\n\t}\n\n\tpublic function pull($user, $id = null, $technique=false, $server, $jobId = false, $percent = 100, $current = 0) {\n\t\tif ($jobId) {\n\t\t\t$job = ClassRegistry::init('Job');\n\t\t\t$job->read(null, $jobId);\n\t\t\t$email = \"Scheduled job\";\n\t\t} else {\n\t\t\t$email = $user['email'];\n\t\t}\n\t\t$eventModel = ClassRegistry::init('Event');\n\t\tApp::uses('HttpSocket', 'Network/Http');\n\t\t$eventIds = array();\n\t\t$conditions = array();\n\t\tif (\"full\" === $technique) {\n\t\t\t// get a list of the event_ids on the server\n\t\t\t$eventIds = $this->getEventIdsFromServer($server);\n\t\t\t// FIXME this is not clean at all ! needs to be refactored with try catch error handling/communication\n\t\t\tif ($eventIds === 403) {\n\t\t\t\treturn array (1, null);\n\t\t\t} else if (is_string($eventIds)) {\n\t\t\t\treturn array(2, $eventIds);\n\t\t\t}\n\n\t\t\t// reverse array of events, to first get the old ones, and then the new ones\n\t\t\tif (!empty($eventIds)) {\n\t\t\t\t$eventIds = array_reverse($eventIds);\n\t\t\t}\n\t\t} else if (\"update\" === $technique) {\n\t\t\t$eventIds = $this->getEventIdsFromServer($server, false, null, true, true);\n\t\t\tif ($eventIds === 403) {\n\t\t\t\treturn array (1, null);\n\t\t\t} else if (is_string($eventIds)) {\n\t\t\t\treturn array(2, $eventIds);\n\t\t\t}\n\t\t\t$local_event_ids = $eventModel->find('list', array(\n\t\t\t\t\t'fields' => array('uuid'),\n\t\t\t\t\t'recursive' => -1,\n\t\t\t));\n\t\t\t$eventIds = array_intersect($eventIds, $local_event_ids);\n\t\t} else if (\"incremental\" === $technique) {\n\t\t\t// TODO incremental pull\n\t\t\treturn array (3, null);\n\t\t} else if (is_numeric($technique)) {\n\t\t\t$eventIds[] = intval($technique);\n\t\t\t// if we are downloading a single event, don't fetch all proposals\n\t\t\t$conditions = array('Event.id' => $technique);\n\t\t} else {\n\t\t\treturn array (4, null);\n\t\t}\n\t\t$successes = array();\n\t\t$fails = array();\n\t\t$pulledProposals = array();\n\t\t// now process the $eventIds to pull each of the events sequentially\n\t\tif (!empty($eventIds)) {\n\t\t\t// download each event\n\t\t\tif (null != $eventIds) {\n\t\t\t\tApp::uses('SyncTool', 'Tools');\n\t\t\t\t$syncTool = new SyncTool();\n\t\t\t\t$HttpSocket = $syncTool->setupHttpSocket($server);\n\t\t\t\tforeach ($eventIds as $k => $eventId) {\n\t\t\t\t\t$event = $eventModel->downloadEventFromServer(\n\t\t\t\t\t\t\t$eventId,\n\t\t\t\t\t\t\t$server);\n\t\t\t\t\tif (null != $event) {\n\t\t\t\t\t\t$blocked = false;\n\t\t\t\t\t\tif (Configure::read('MISP.enableEventBlacklisting') !== false) {\n\t\t\t\t\t\t\t$this->EventBlacklist = ClassRegistry::init('EventBlacklist');\n\t\t\t\t\t\t\t$r = $this->EventBlacklist->find('first', array('conditions' => array('event_uuid' => $event['Event']['uuid'])));\n\t\t\t\t\t\t\tif (!empty($r))\t{\n\t\t\t\t\t\t\t\t$blocked = true;\n\t\t\t\t\t\t\t\t$fails[$eventId] = 'Event blocked by local blocklist.';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!$blocked) {\n\t\t\t\t\t\t\t// we have an Event array\n\t\t\t\t\t\t\t// The event came from a pull, so it should be locked.\n\t\t\t\t\t\t\t$event['Event']['locked'] = true;\n\t\t\t\t\t\t\tif (!isset($event['Event']['distribution'])) { // version 1\n\t\t\t\t\t\t\t\t$event['Event']['distribution'] = '1';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t// Distribution\n\t\t\t\t\t\t\tif (empty(Configure::read('MISP.host_org_id')) || !$server['Server']['internal'] ||  Configure::read('MISP.host_org_id') != $server['Server']['org_id']) {\n\t\t\t\t\t\t\t\tswitch ($event['Event']['distribution']) {\n\t\t\t\t\t\t\t\t\tcase 1:\n\t\t\t\t\t\t\t\t\t\t// if community only, downgrade to org only after pull\n\t\t\t\t\t\t\t\t\t\t$event['Event']['distribution'] = '0';\n\t\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t\tcase 2:\n\t\t\t\t\t\t\t\t\t\t// if connected communities downgrade to community only\n\t\t\t\t\t\t\t\t\t\t$event['Event']['distribution'] = '1';\n\t\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif (isset($event['Event']['Attribute']) && !empty($event['Event']['Attribute'])) {\n\t\t\t\t\t\t\t\t\tforeach ($event['Event']['Attribute'] as $key => $a) {\n\t\t\t\t\t\t\t\t\t\tswitch ($a['distribution']) {\n\t\t\t\t\t\t\t\t\t\t\tcase '1':\n\t\t\t\t\t\t\t\t\t\t\t\t$event['Event']['Attribute'][$key]['distribution'] = '0';\n\t\t\t\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t\t\t\tcase '2':\n\t\t\t\t\t\t\t\t\t\t\t\t$event['Event']['Attribute'][$key]['distribution'] = '1';\n\t\t\t\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t$fails[$eventId] = 'Event blocked by blacklist.';\n\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// Distribution, set reporter of the event, being the admin that initiated the pull\n\t\t\t\t\t\t$event['Event']['user_id'] = $user['id'];\n\t\t\t\t\t\t// check if the event already exist (using the uuid)\n\t\t\t\t\t\t$existingEvent = null;\n\t\t\t\t\t\t$existingEvent = $eventModel->find('first', array('conditions' => array('Event.uuid' => $event['Event']['uuid'])));\n\t\t\t\t\t\tif (!$existingEvent) {\n\t\t\t\t\t\t\t// add data for newly imported events\n\t\t\t\t\t\t\t$passAlong = $server['Server']['id'];\n\t\t\t\t\t\t\t$result = $eventModel->_add($event, true, $user, $server['Server']['org_id'], $passAlong, true, $jobId);\n\t\t\t\t\t\t\tif ($result) $successes[] = $eventId;\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t$fails[$eventId] = 'Failed (partially?) because of validation errors: '. print_r($eventModel->validationErrors, true);\n\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t$tempUser = $user;\n\t\t\t\t\t\t\t$tempUser['Role']['perm_site_admin'] = 0;\n\t\t\t\t\t\t\t$result = $eventModel->_edit($event, $tempUser, $existingEvent['Event']['id'], $jobId);\n\t\t\t\t\t\t\tif ($result === true) $successes[] = $eventId;\n\t\t\t\t\t\t\telse if (isset($result['error'])) $fails[$eventId] = $result['error'];\n\t\t\t\t\t\t\telse $fails[$eventId] = json_encode($result);\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// error\n\t\t\t\t\t\t$fails[$eventId] = 'failed downloading the event';\n\t\t\t\t\t}\n\t\t\t\t\tif ($jobId) {\n\t\t\t\t\t\tif ($k % 10 == 0) {\n\t\t\t\t\t\t\t$job->id = $jobId;\n\t\t\t\t\t\t\t$job->saveField('progress', 50 * (($k + 1) / count($eventIds)));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (count($fails) > 0) {\n\t\t\t\t\t// there are fails, take the lowest fail\n\t\t\t\t\t$lastpulledid = min(array_keys($fails));\n\t\t\t\t} else {\n\t\t\t\t\t// no fails, take the highest success\n\t\t\t\t\t$lastpulledid = count($successes) > 0 ? max($successes) : 0;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif ($jobId) {\n\t\t\t$job->saveField('message', 'Pulling proposals.');\n\t\t}\n\t\t$events = $eventModel->find('list', array(\n\t\t\t\t'fields' => array('uuid'),\n\t\t\t\t'recursive' => -1,\n\t\t\t\t'conditions' => $conditions\n\t\t));\n\t\t$shadowAttribute = ClassRegistry::init('ShadowAttribute');\n\t\t$shadowAttribute->recursive = -1;\n\t\tif (!empty($events)) {\n\t\t\t$proposals = $eventModel->downloadProposalsFromServer($events, $server);\n\t\t\tif (!empty($proposals)) {\n\t\t\t\t$uuidEvents = array_flip($events);\n\t\t\t\tforeach ($proposals as $k => &$proposal) {\n\t\t\t\t\t$proposal = $proposal['ShadowAttribute'];\n\t\t\t\t\t$oldsa = $shadowAttribute->findOldProposal($proposal);\n\t\t\t\t\t$proposal['event_id'] = $uuidEvents[$proposal['event_uuid']];\n\t\t\t\t\tif (!$oldsa || $oldsa['timestamp'] < $proposal['timestamp']) {\n\t\t\t\t\t\tif ($oldsa) $shadowAttribute->delete($oldsa['id']);\n\t\t\t\t\t\tif (!isset($pulledProposals[$proposal['event_id']])) $pulledProposals[$proposal['event_id']] = 0;\n\t\t\t\t\t\t$pulledProposals[$proposal['event_id']]++;\n\t\t\t\t\t\tif (isset($proposal['old_id'])) {\n\t\t\t\t\t\t\t$oldAttribute = $eventModel->Attribute->find('first', array('recursive' => -1, 'conditions' => array('uuid' => $proposal['uuid'])));\n\t\t\t\t\t\t\tif ($oldAttribute) $proposal['old_id'] = $oldAttribute['Attribute']['id'];\n\t\t\t\t\t\t\telse $proposal['old_id'] = 0;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// check if this is a proposal from an old MISP instance\n\t\t\t\t\t\tif (!isset($proposal['Org']) && isset($proposal['org']) && !empty($proposal['org'])) {\n\t\t\t\t\t\t\t$proposal['Org'] = $proposal['org'];\n\t\t\t\t\t\t\t$proposal['EventOrg'] = $proposal['event_org'];\n\t\t\t\t\t\t} else if (!isset($proposal['Org']) && !isset($proposal['EventOrg'])) {\n\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$proposal['org_id'] = $this->Organisation->captureOrg($proposal['Org'], $user);\n\t\t\t\t\t\t$proposal['event_org_id'] = $this->Organisation->captureOrg($proposal['EventOrg'], $user);\n\t\t\t\t\t\tunset($proposal['Org']);\n\t\t\t\t\t\tunset($proposal['EventOrg']);\n\t\t\t\t\t\t$shadowAttribute->create();\n\t\t\t\t\t\tif (!isset($proposal['deleted']) || !$proposal['deleted']) {\n\t\t\t\t\t\t\tif ($shadowAttribute->save($proposal)) $shadowAttribute->sendProposalAlertEmail($proposal['event_id']);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif ($jobId) {\n\t\t\t\t\t\tif ($k % 50 == 0) {\n\t\t\t\t\t\t\t$job->id = $jobId;\n\t\t\t\t\t\t\t$job->saveField('progress', 50 * (($k + 1) / count($proposals)));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif ($jobId) {\n\t\t\t$job->saveField('progress', 100);\n\t\t\t$job->saveField('message', 'Pull completed.');\n\t\t\t$job->saveField('status', 4);\n\t\t}\n\t\t$this->Log = ClassRegistry::init('Log');\n\t\t$this->Log->create();\n\t\t$this->Log->save(array(\n\t\t\t'org' => $user['Organisation']['name'],\n\t\t\t'model' => 'Server',\n\t\t\t'model_id' => $id,\n\t\t\t'email' => $user['email'],\n\t\t\t'action' => 'pull',\n\t\t\t'user_id' => $user['id'],\n\t\t\t'title' => 'Pull from ' . $server['Server']['url'] . ' initiated by ' . $email,\n\t\t\t'change' => count($successes) . ' events and ' . count($pulledProposals) . ' proposals pulled or updated. ' . count($fails) . ' events failed or didn\\'t need an update.'\n\t\t));\n\t\tif (!isset($lastpulledid)) $lastpulledid = 0;\n\t\treturn array($successes, $fails, $pulledProposals, $lastpulledid);\n\t}\n\n\tpublic function filterRuleToParameter($filter_rules) {\n\t\t$final = array();\n\t\tif (empty($filter_rules)) return $final;\n\t\t$filter_rules = json_decode($filter_rules, true);\n\t\tforeach ($filter_rules as $field => $rules) {\n\t\t\t$temp = array();\n\t\t\tforeach ($rules as $operator => $elements) {\n\t\t\t\tforeach ($elements as $k => $element) {\n\t\t\t\t\tif ($operator === 'NOT') $element = '!' . $element;\n\t\t\t\t\tif (!empty($element)) $temp[] = $element;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!empty($temp)) {\n\t\t\t\t$temp = implode('|', $temp);\n\t\t\t\t$final[substr($field, 0, strlen($field) -1)] = $temp;\n\t\t\t}\n\t\t}\n\t\treturn $final;\n\t}\n\n\n\t// Get an array of event_ids that are present on the remote server\n\tpublic function getEventIdsFromServer($server, $all = false, $HttpSocket=null, $force_uuid=false, $ignoreFilterRules = false) {\n\t\t$url = $server['Server']['url'];\n\t\t$authkey = $server['Server']['authkey'];\n\t\tif ($ignoreFilterRules) $filter_rules = array();\n\t\telse $filter_rules = $this->filterRuleToParameter($server['Server']['pull_rules']);\n\t\tif (null == $HttpSocket) {\n\t\t\tApp::uses('SyncTool', 'Tools');\n\t\t\t$syncTool = new SyncTool();\n\t\t\t$HttpSocket = $syncTool->setupHttpSocket($server);\n\t\t}\n\t\t$request = array(\n\t\t\t\t'header' => array(\n\t\t\t\t\t\t'Authorization' => $authkey,\n\t\t\t\t\t\t'Accept' => 'application/json',\n\t\t\t\t\t\t'Content-Type' => 'application/json',\n\t\t\t\t\t\t//'Connection' => 'keep-alive' // LATER followup cakephp issue about this problem: https://github.com/cakephp/cakephp/issues/1961\n\t\t\t\t)\n\t\t);\n\t\t$uri = $url . '/events/index';\n\t\t$filter_rules['minimal'] = 1;\n\t\ttry {\n\t\t\t$response = $HttpSocket->post($uri, json_encode($filter_rules), $request);\n\t\t\tif ($response->isOk()) {\n\t\t\t\t$eventArray = json_decode($response->body, true);\n\t\t\t\t// correct $eventArray if just one event\n\t\t\t\tif (is_array($eventArray) && isset($eventArray['id'])) {\n\t\t\t\t\t$tmp = $eventArray;\n\t\t\t\t\tunset($eventArray);\n\t\t\t\t\t$eventArray[0] = $tmp;\n\t\t\t\t\tunset($tmp);\n\t\t\t\t}\n\t\t\t\t$eventIds = array();\n\t\t\t\tif ($all) {\n\t\t\t\t\tif (!empty($eventArray)) foreach ($eventArray as $event) {\n\t\t\t\t\t\t$eventIds[] = $event['uuid'];\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t// multiple events, iterate over the array\n\t\t\t\t\t$this->Event = ClassRegistry::init('Event');\n\t\t\t\t\tforeach ($eventArray as $k => $event) {\n\t\t\t\t\t\tif (1 != $event['published']) {\n\t\t\t\t\t\t\tunset($eventArray[$k]); // do not keep non-published events\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$this->Event->removeOlder($eventArray);\n\t\t\t\t\tif (!empty($eventArray)) {\n\t\t\t\t\t\tforeach ($eventArray as $event) {\n\t\t\t\t\t\t\tif ($force_uuid) $eventIds[] = $event['uuid'];\n\t\t\t\t\t\t\telse $eventIds[] = $event['id'];\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn $eventIds;\n\t\t\t}\n\t\t\tif ($response->code == '403') {\n\t\t\t\treturn 403;\n\t\t\t}\n\t\t} catch (SocketException $e) {\n\t\t\t// FIXME refactor this with clean try catch over all http functions\n\t\t\treturn $e->getMessage();\n\t\t}\n\t\t// error, so return error message, since that is handled and everything is expecting an array\n\t\treturn \"Error: got response code \" . $response->code;\n\t}\n\n\tpublic function push($id = null, $technique=false, $jobId = false, $HttpSocket, $user) {\n\t\tif ($jobId) {\n\t\t\t$job = ClassRegistry::init('Job');\n\t\t\t$job->read(null, $jobId);\n\t\t}\n\t\t$this->Event = ClassRegistry::init('Event');\n\t\t$this->read(null, $id);\n\t\t$url = $this->data['Server']['url'];\n\t\t$push = $this->checkVersionCompatibility($id, $user)['canPush'];\n\t\tif (!isset($push) || !$push) {\n\t\t\tif ($jobId) {\n\t\t\t\t$job->id = $jobId;\n\t\t\t\t$job->saveField('progress', 100);\n\t\t\t\t$job->saveField('message', 'Push to server ' . $id . ' failed. Remote instance is outdated.');\n\t\t\t\t$job->saveField('status', 4);\n\t\t\t}\n\t\t\treturn false;\n\t\t}\n\t\tif (\"full\" == $technique) {\n\t\t\t$eventid_conditions_key = 'Event.id >';\n\t\t\t$eventid_conditions_value = 0;\n\t\t} else if (\"incremental\" == $technique) {\n\t\t\t$eventid_conditions_key = 'Event.id >';\n\t\t\t$eventid_conditions_value = $this->data['Server']['lastpushedid'];\n\t\t} else if (true == $technique) {\n\t\t\t$eventid_conditions_key = 'Event.id';\n\t\t\t$eventid_conditions_value = intval($technique);\n\t\t} else {\n\t\t\t$this->redirect(array('action' => 'index'));\n\t\t}\n\t\t$sgs = $this->Event->SharingGroup->find('all', array(\n\t\t\t'recursive' => -1,\n\t\t\t'contain' => array('Organisation', 'SharingGroupOrg', 'SharingGroupServer')\n\t\t));\n\t\t$sgIds = array();\n\t\tforeach ($sgs as $k => $sg) {\n\t\t\tif (!$this->Event->SharingGroup->checkIfServerInSG($sg, $this->data)) {\n\t\t\t\tunset($sgs[$k]);\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\t$sgIds[] = $sg['SharingGroup']['id'];\n\t\t}\n\t\tif (!isset($sgIds) || empty($sgIds)) {\n\t\t\t$sgIds = array(-1);\n\t\t}\n\t\t$findParams = array(\n\t\t\t\t'conditions' => array(\n\t\t\t\t\t\t$eventid_conditions_key => $eventid_conditions_value,\n\t\t\t\t\t\t'Event.published' => 1,\n\t\t\t\t\t\t'Event.attribute_count >' => 0,\n\t\t\t\t\t\t'OR' => array(\n\t\t\t\t\t\t\tarray(\n\t\t\t\t\t\t\t\t'AND' => array(\n\t\t\t\t\t\t\t\t\tarray('Event.distribution >' => 0),\n\t\t\t\t\t\t\t\t\tarray('Event.distribution <' => 4),\n\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\tarray(\n\t\t\t\t\t\t\t\t'AND' => array(\n\t\t\t\t\t\t\t\t\t'Event.distribution' => 4,\n\t\t\t\t\t\t\t\t\t'Event.sharing_group_id' => $sgIds\n\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t)\n\t\t\t\t), // array of conditions\n\t\t\t\t'recursive' => -1, //int\n\t\t\t\t'contain' => array('EventTag' => array('fields' => array('EventTag.tag_id'))),\n\t\t\t\t'fields' => array('Event.id', 'Event.timestamp', 'Event.uuid', 'Event.orgc_id'), // array of field names\n\t\t);\n\t\t$eventIds = $this->Event->find('all', $findParams);\n\t\t$eventUUIDsFiltered = $this->getEventIdsForPush($id, $HttpSocket, $eventIds, $user);\n\t\tif ($eventUUIDsFiltered === false || empty($eventUUIDsFiltered)) $pushFailed = true;\n\t\tif (!empty($eventUUIDsFiltered)) {\n\t\t\t$eventCount = count($eventUUIDsFiltered);\n\t\t\t// now process the $eventIds to pull each of the events sequentially\n\t\t\tif (!empty($eventUUIDsFiltered)) {\n\t\t\t\t$successes = array();\n\t\t\t\t$fails = array();\n\t\t\t\t$lowestfailedid = null;\n\t\t\t\tforeach ($eventUUIDsFiltered as $k => $eventUuid) {\n\t\t\t\t\t$event = $this->Event->fetchEvent($user, array(\n\t\t\t\t\t\t'event_uuid' => $eventUuid,\n\t\t\t\t\t\t'includeAttachments' => true,\n\t\t\t\t\t\t'includeAllTags' => true\n\t\t\t\t\t));\n\t\t\t\t\t$event = $event[0];\n\t\t\t\t\t$event['Event']['locked'] = true;\n\t\t\t\t\t$result = $this->Event->uploadEventToServer(\n\t\t\t\t\t\t\t$event,\n\t\t\t\t\t\t\t$this->data,\n\t\t\t\t\t\t\t$HttpSocket);\n\t\t\t\t\tif ('Success' === $result) {\n\t\t\t\t\t\t$successes[] = $event['Event']['id'];\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$fails[$event['Event']['id']] = $result;\n\t\t\t\t\t}\n\t\t\t\t\tif ($jobId && $k%10 == 0) {\n\t\t\t\t\t\t$job->saveField('progress', 100 * $k / $eventCount);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (count($fails) > 0) {\n\t\t\t\t\t// there are fails, take the lowest fail\n\t\t\t\t\t$lastpushedid = min(array_keys($fails));\n\t\t\t\t} else {\n\t\t\t\t\t// no fails, take the highest success\n\t\t\t\t\t$lastpushedid = max($successes);\n\t\t\t\t}\n\t\t\t\t// increment lastid based on the highest ID seen\n\t\t\t\t// Save the entire Server data instead of just a single field, so that the logger can be fed with the extra fields.\n\t\t\t\t$this->data['Server']['lastpushedid'] = $lastpushedid;\n\t\t\t\t$this->save($this->data);\n\t\t\t}\n\t\t}\n\n\t\t$this->syncProposals($HttpSocket, $this->data, null, null, $this->Event);\n\n\t\tif (!isset($successes)) $successes = null;\n\t\tif (!isset($fails)) $fails = null;\n\t\t$this->Log = ClassRegistry::init('Log');\n\t\t$this->Log->create();\n\t\t$this->Log->save(array(\n\t\t\t\t'org' => $user['Organisation']['name'],\n\t\t\t\t'model' => 'Server',\n\t\t\t\t'model_id' => $id,\n\t\t\t\t'email' => $user['email'],\n\t\t\t\t'action' => 'push',\n\t\t\t\t'user_id' => $user['id'],\n\t\t\t\t'title' => 'Push to ' . $url . ' initiated by ' . $user['email'],\n\t\t\t\t'change' => count($successes) . ' events pushed or updated. ' . count($fails) . ' events failed or didn\\'t need an update.'\n\t\t));\n\t\tif ($jobId) {\n\t\t\t$job->id = $jobId;\n\t\t\t$job->saveField('progress', 100);\n\t\t\t$job->saveField('message', 'Push to server ' . $id . ' complete.');\n\t\t\t$job->saveField('status', 4);\n\t\t} else {\n\t\t\treturn array($successes, $fails);\n\t\t}\n\t}\n\n\tpublic function getEventIdsForPush($id, $HttpSocket, $eventIds, $user) {\n\t\t$server = $this->read(null, $id);\n\t\t$this->Event = ClassRegistry::init('Event');\n\n\t\tforeach ($eventIds as $k => $event) {\n\t\t\tif (empty($this->eventFilterPushableServers($event, array($server)))) {\n\t\t\t\tunset($eventIds[$k]);\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tunset($eventIds[$k]['Event']['id']);\n\t\t}\n\t\tif (null == $HttpSocket) {\n\t\t\tApp::uses('SyncTool', 'Tools');\n\t\t\t$syncTool = new SyncTool();\n\t\t\t$HttpSocket = $syncTool->setupHttpSocket($server);\n\t\t}\n\t\t$data = json_encode($eventIds);\n\t\t$request = array(\n\t\t\t\t'header' => array(\n\t\t\t\t\t\t'Authorization' => $server['Server']['authkey'],\n\t\t\t\t\t\t'Accept' => 'application/json',\n\t\t\t\t\t\t'Content-Type' => 'application/json',\n\t\t\t\t)\n\t\t);\n\t\t$uri = $server['Server']['url'] . '/events/filterEventIdsForPush';\n\t\t$response = $HttpSocket->post($uri, $data, $request);\n\t\tif ($response->code == '200') {\n\t\t\t$uuidList = json_decode($response->body());\n\t\t} else {\n\t\t\treturn false;\n\t\t}\n\t\treturn $uuidList;\n\t}\n\n\tpublic function syncProposals($HttpSocket, $server, $sa_id = null, $event_id = null, $eventModel) {\n\t\t$saModel = ClassRegistry::init('ShadowAttribute');\n\t\tif (null == $HttpSocket) {\n\t\t\tApp::uses('SyncTool', 'Tools');\n\t\t\t$syncTool = new SyncTool();\n\t\t\t$HttpSocket = $syncTool->setupHttpSocket($server);\n\t\t}\n\t\tif ($sa_id == null) {\n\t\t\tif ($event_id == null) {\n\t\t\t\t// event_id is null when we are doing a push\n\t\t\t\t$ids = $this->getEventIdsFromServer($server, true, $HttpSocket, false, true);\n\t\t\t\t// error return strings or ints or throw exceptions\n\t\t\t\tif (!is_array($ids)) return false;\n\t\t\t\t$conditions = array('uuid' => $ids);\n\t\t\t} else {\n\t\t\t\t$conditions = array('id' => $event_id);\n\t\t\t\t// event_id is not null when we are doing a publish\n\t\t\t}\n\t\t\t$events = $eventModel->find('all', array(\n\t\t\t\t\t'conditions' => $conditions,\n\t\t\t\t\t'recursive' => 1,\n\t\t\t\t\t'contain' => 'ShadowAttribute',\n\t\t\t\t\t'fields' => array('Event.uuid')\n\t\t\t));\n\n\t\t\t$fails = 0;\n\t\t\t$success = 0;\n\t\t\t$error_message = \"\";\n\t\t\tforeach ($events as $k => &$event) {\n\t\t\t\tif (!empty($event['ShadowAttribute'])) {\n\t\t\t\t\tforeach ($event['ShadowAttribute'] as &$sa) {\n\t\t\t\t\t\t$sa['data'] = $saModel->base64EncodeAttachment($sa);\n\t\t\t\t\t\tunset($sa['id']);\n\t\t\t\t\t\tunset($sa['value1']);\n\t\t\t\t\t\tunset($sa['value2']);\n\t\t\t\t\t}\n\n\t\t\t\t\t$data = json_encode($event['ShadowAttribute']);\n\t\t\t\t\t$request = array(\n\t\t\t\t\t\t\t'header' => array(\n\t\t\t\t\t\t\t\t\t'Authorization' => $server['Server']['authkey'],\n\t\t\t\t\t\t\t\t\t'Accept' => 'application/json',\n\t\t\t\t\t\t\t\t\t'Content-Type' => 'application/json',\n\t\t\t\t\t\t\t)\n\t\t\t\t\t);\n\t\t\t\t\t$uri = $server['Server']['url'] . '/events/pushProposals/' . $event['Event']['uuid'];\n\t\t\t\t\t$response = $HttpSocket->post($uri, $data, $request);\n\t\t\t\t\tif ($response->code == '200') {\n\t\t\t\t\t\t$result = json_decode($response->body(), true);\n\t\t\t\t\t\tif ($result['success']) {\n\t\t\t\t\t\t\t$success += intval($result['counter']);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t$fails++;\n\t\t\t\t\t\t\tif ($error_message == \"\") $result['message'];\n\t\t\t\t\t\t\telse $error_message .= \" --- \" . $result['message'];\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$fails++;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\t// connect to checkuuid($uuid)\n\t\t\t$request = array(\n\t\t\t\t\t'header' => array(\n\t\t\t\t\t\t\t'Authorization' => $server['Server']['authkey'],\n\t\t\t\t\t\t\t'Accept' => 'application/json',\n\t\t\t\t\t\t\t'Content-Type' => 'application/json',\n\t\t\t\t\t)\n\t\t\t);\n\t\t\t$uri = $server['Server']['url'] . '/events/checkuuid/' . $sa_id;\n\t\t\t$response = $HttpSocket->get($uri, '', $request);\n\t\t\tif ($response->code != '200') {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n\n\tpublic function getCurrentServerSettings() {\n\t\t$this->Module = ClassRegistry::init('Module');\n\t\t$serverSettings = $this->serverSettings;\n\t\t$moduleTypes = array('Enrichment', 'Import', 'Export', 'Cortex');\n\t\t$orgs = $this->Organisation->find('list', array(\n\t\t\t'conditions' => array(\n\t\t\t\t'Organisation.local' => 1\n\t\t\t),\n\t\t\t'fields' => array(\n\t\t\t\t'Organisation.id', 'Organisation.name'\n\t\t\t)\n\t\t));\n\t\t$orgs = array_merge(array('Unrestricted'), $orgs);\n\t\tforeach ($moduleTypes as $moduleType) {\n\t\t\tif (Configure::read('Plugin.' . $moduleType . '_services_enable')) {\n\t\t\t\t$results = $this->Module->getModuleSettings($moduleType);\n\t\t\t\tforeach ($results as $module => $data) {\n\t\t\t\t\tforeach ($data as $result) {\n\t\t\t\t\t\t$setting = array('level' => 1, 'errorMessage' => '');\n\t\t\t\t\t\tif ($result['type'] == 'boolean') {\n\t\t\t\t\t\t\t$setting['test'] = 'testBool';\n\t\t\t\t\t\t\t$setting['type'] = 'boolean';\n\t\t\t\t\t\t\t$setting['description'] = 'Enable or disable the ' . $module . ' module.';\n\t\t\t\t\t\t\t$setting['value'] = false;\n\t\t\t\t\t\t} else if ($result['type'] == 'orgs') {\n\t\t\t\t\t\t\t$setting['description'] = 'Restrict the ' . $module . ' module to the given organisation.';\n\t\t\t\t\t\t\t$setting['value'] = 0;\n\t\t\t\t\t\t\t$setting['test'] = 'testLocalOrg';\n\t\t\t\t\t\t\t$setting['type'] = 'numeric';\n\t\t\t\t\t\t\t$setting['optionsSource'] = 'LocalOrgs';\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t$setting['test'] = 'testForEmpty';\n\t\t\t\t\t\t\t$setting['type'] = 'string';\n\t\t\t\t\t\t\t$setting['description'] = 'Set this required module specific setting.';\n\t\t\t\t\t\t\t$setting['value'] = '';\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$serverSettings['Plugin'][$moduleType . '_' . $module . '_' .  $result['name']] = $setting;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn $serverSettings;\n\t}\n\n\tpublic function serverSettingsRead($unsorted = false) {\n\t\t$this->Module = ClassRegistry::init('Module');\n\t\t$serverSettings = $this->getCurrentServerSettings();\n\t\t$currentSettings = Configure::read();\n\t\tif (Configure::read('Plugin.Enrichment_services_enable')) {\n\t\t\t$results = $this->Module->getModuleSettings();\n\t\t\tforeach ($results as $module => $data) {\n\t\t\t\tforeach ($data as $result) {\n\t\t\t\t\t$setting = array('level' => 1, 'errorMessage' => '');\n\t\t\t\t\tif ($result['type'] == 'boolean') {\n\t\t\t\t\t\t$setting['test'] = 'testBool';\n\t\t\t\t\t\t$setting['type'] = 'boolean';\n\t\t\t\t\t\t$setting['description'] = 'Enable or disable the ' . $module . ' module.';\n\t\t\t\t\t\t$setting['value'] = false;\n\t\t\t\t\t} else if ($result['type'] == 'orgs') {\n\t\t\t\t\t\t$setting['description'] = 'Restrict the ' . $module . ' module to the given organisation.';\n\t\t\t\t\t\t$setting['value'] = 0;\n\t\t\t\t\t\t$setting['test'] = 'testLocalOrg';\n\t\t\t\t\t\t$setting['type'] = 'numeric';\n\t\t\t\t\t\t$setting['optionsSource'] = 'LocalOrgs';\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$setting['test'] = 'testForEmpty';\n\t\t\t\t\t\t$setting['type'] = 'string';\n\t\t\t\t\t\t$setting['description'] = 'Set this required module specific setting.';\n\t\t\t\t\t\t$setting['value'] = '';\n\t\t\t\t\t}\n\t\t\t\t\t$serverSettings['Plugin']['Enrichment_' . $module . '_' .  $result['name']] = $setting;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t$finalSettingsUnsorted = array();\n\t\tforeach ($serverSettings as $branchKey => &$branchValue) {\n\t\t\tif (isset($branchValue['branch'])) {\n\t\t\t\tforeach ($branchValue as $leafKey => &$leafValue) {\n\t\t\t\t\tif ($leafValue['level'] == 3 && !(isset($currentSettings[$branchKey][$leafKey]))) continue;\n\t\t\t\t\t$setting = null;\n\t\t\t\t\tif (isset($currentSettings[$branchKey][$leafKey])) $setting = $currentSettings[$branchKey][$leafKey];\n\t\t\t\t\t$leafValue = $this->__evaluateLeaf($leafValue, $leafKey, $setting);\n\t\t\t\t\tif ($leafKey != 'branch') {\n\t\t\t\t\t\tif ($branchKey == 'Plugin') {\n\t\t\t\t\t\t\t$pluginData = explode('_', $leafKey);\n\t\t\t\t\t\t\t$leafValue['subGroup'] = $pluginData[0];\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (strpos($branchKey, 'Secur') === 0) $leafValue['tab'] = 'Security';\n\t\t\t\t\t\telse $leafValue['tab'] = $branchKey;\n\t\t\t\t\t\t$finalSettingsUnsorted[$branchKey . '.' . $leafKey] = $leafValue;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t\t$setting = null;\n\t\t\t\t\tif (isset($currentSettings[$branchKey])) $setting = $currentSettings[$branchKey];\n\t\t\t\t\t$branchValue = $this->__evaluateLeaf($branchValue, $branchKey, $setting);\n\t\t\t\t\t$branchValue['tab'] = 'misc';\n\t\t\t\t\t$finalSettingsUnsorted[$branchKey] = $branchValue;\n\t\t\t}\n\t\t}\n\t\tforeach ($finalSettingsUnsorted as $key => $temp) if (in_array($temp['tab'], array_keys($this->__settingTabMergeRules))) {\n\t\t\t$finalSettingsUnsorted[$key]['tab'] = $this->__settingTabMergeRules[$temp['tab']];\n\t\t}\n\t\tif ($unsorted) return $finalSettingsUnsorted;\n\t\t$finalSettings = array();\n\t\tfor ($i = 0; $i < 4; $i++) {\n\t\t\tforeach ($finalSettingsUnsorted as $k => $s) {\n\t\t\t\t$s['setting'] = $k;\n\t\t\t\tif ($s['level'] == $i) $finalSettings[] = $s;\n\t\t\t}\n\t\t}\n\t\treturn $finalSettings;\n\t}\n\n\tpublic function serverSettingReadSingle($settingObject, $settingName, $leafKey) {\n\t\t// invalidate config.php from php opcode cache\n\t\tif (function_exists('opcache_reset')) opcache_reset();\n\n\t\t$setting = Configure::read($settingName);\n\t\t$result = $this->__evaluateLeaf($settingObject, $leafKey, $setting);\n\t\t$result['setting'] = $settingName;\n\t\treturn $result;\n\t}\n\n\tprivate function __evaluateLeaf($leafValue, $leafKey, $setting) {\n\t\tif (isset($setting)) {\n\t\t\tif (!empty($leafValue['test'])) {\n\t\t\t\t$result = $this->{$leafValue['test']}($setting);\n\t\t\t\tif ($result !== true) {\n\t\t\t\t\t$leafValue['error'] = 1;\n\t\t\t\t\tif ($result !== false) $leafValue['errorMessage'] = $result;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif ($setting !== '') $leafValue['value'] = $setting;\n\t\t} else {\n\t\t\tif ($leafKey != 'branch' && (!isset($leafValue['null']) || !$leafValue['null'])) {\n\t\t\t\t$leafValue['error'] = 1;\n\t\t\t\t$leafValue['errorMessage'] = 'Value not set.';\n\t\t\t}\n\t\t}\n\t\treturn $leafValue;\n\t}\n\n\tpublic function testForNumeric($value) {\n\t\tif (!is_numeric($value)) return 'This setting has to be a number.';\n\t\treturn true;\n\t}\n\n\tpublic function testUuid($value) {\n\t\tif (empty($value) || !preg_match('/^\\{?[a-z0-9]{8}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12}\\}?$/', $value)) {\n\t\t\treturn 'Invalid UUID.';\n\t\t}\n\t\treturn true;\n\t}\n\n\tpublic function testForSessionDefaults($value) {\n\t\tif (empty($value) || !in_array($value, array('php', 'database', 'cake', 'cache'))) {\n\t\t\treturn 'Please choose a valid session handler. Recommended values: php or database. Alternate options are cake (cakephp file based sessions) and cache.';\n\t\t} else {\n\t\t\treturn true;\n\t\t}\n\t}\n\n\tpublic function testLocalOrg($value) {\n\t\t$this->Organisation = ClassRegistry::init('Organisation');\n\t\tif ($value == 0) return 'No organisation selected';\n\t\t$local_orgs = $this->Organisation->find('list', array(\n\t\t\t'conditions' => array('local' => 1),\n\t\t\t'recursive' => -1,\n\t\t\t'fields' => array('Organisation.id', 'Organisation.name')\n\t\t));\n\t\tif (in_array($value, array_keys($local_orgs))) return true;\n\t\treturn 'Invalid organisation';\n\t}\n\n\tpublic function testForEmpty($value) {\n\t\t$value = trim($value);\n\t\tif ($value === '') return 'Value not set.';\n\t\treturn true;\n\t}\n\n\tpublic function testForPath($value) {\n\t\tif ($value === '') return true;\n\t\tif (preg_match('@^\\/?(([a-z0-9_.]+[a-z0-9_.\\-.\\:]*[a-z0-9_.\\-.\\:]|[a-z0-9_.])+\\/?)+$@i', $value)) return true;\n\t\treturn 'Invalid characters in the path.';\n\t}\n\n\tpublic function testForWritableDir($value) {\n\t\tif (!is_dir($value)) return 'Not a valid directory.';\n\t\tif (!is_writeable($value)) return 'Not a writable directory.';\n\t\treturn true;\n\t}\n\n\tpublic function testDebug($value) {\n\t\tif ($this->testForEmpty($value) !== true) return $this->testForEmpty($value);\n\t\tif ($this->testForNumeric($value) !== true) return 'This setting has to be a number between 0 and 2, with 0 disabling debug mode.';\n\t\tif ($value === 0) return true;\n\t\treturn 'This setting has to be set to 0 on production systems. Ignore this warning if this is not the case.';\n\t}\n\n\tpublic function testDebugAdmin($value) {\n\t\tif ($this->testBool($value) !== true) return 'This setting has to be either true or false.';\n\t\tif (!$value) return true;\n\t\treturn 'Enabling debug is not recommended. Turn this on temporarily if you need to see a stack trace to debug an issue, but make sure this is not left on.';\n\t}\n\n\tpublic function testDate($date) {\n\t\tif ($this->testForEmpty($date) !== true) return $this->testForEmpty($date);\n\t\tif (!strtotime($date)) return 'The date that you have entered is invalid. Expected: yyyy-mm-dd';\n\t\treturn true;\n\t}\n\n\n\tpublic function getHost() {\n\t\tif (function_exists('apache_request_headers')){\n\t\t\t\t $headers = apache_request_headers();\n\t\t} else {\n\t\t\t\t $headers = $_SERVER;\n\t\t}\n\n\t\tif ( array_key_exists( 'X-Forwarded-Host', $headers ) ) {\n\t\t\t\t $host = $headers['X-Forwarded-Host'];\n\t\t} else {\n\t\t\t\t $host = $_SERVER['HTTP_HOST'];\n\t\t}\n\t\treturn $host;\n\t}\n\n\tpublic function getProto() {\n\t\tif (function_exists('apache_request_headers')){\n\t\t\t\t $headers = apache_request_headers();\n\t\t} else {\n\t\t\t\t $headers = $_SERVER;\n\t\t}\n\n\t\tif (array_key_exists('X-Forwarded-Proto',$headers)){\n\t\t\t\t $proto = $headers['X-Forwarded-Proto'];\n\t\t} else {\n\t\t\t\t $proto = ((!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off') || $_SERVER['SERVER_PORT'] == 443) === true ? 'HTTPS' : 'HTTP';\n\t\t}\n\t\treturn $proto;\n\t}\n\n\tpublic function testBaseURL($value) {\n\t\tif ($this->testForEmpty($value) !== true) return $this->testForEmpty($value);\n\t\tif ($value != strtolower($this->getProto()) . '://' . $this->getHost()) return false;\n\t\treturn true;\n\t}\n\n\tpublic function testDisableEmail($value) {\n\t\tif (isset($value) && $value) return 'E-mailing is blocked.';\n\t\treturn true;\n\t}\n\n\tpublic function testDisableCache($value) {\n\t\tif (isset($value) && $value) return 'Export caches are disabled.';\n\t\treturn true;\n\t}\n\n\tpublic function testLive($value) {\n\t\tif ($this->testBool($value) !== true) return $this->testBool($value);\n\t\tif (!$value) return 'MISP disabled.';\n\t\treturn true;\n\t}\n\n\tpublic function testBool($value) {\n\t\tif ($value !== true && $value !== false) return 'Value is not a boolean, make sure that you convert \\'true\\' to true for example.';\n\t\treturn true;\n\t}\n\n\tpublic function testBoolFalse($value) {\n\t\tif (!$this->testBool($value)) {\n\t\t\treturn $this->testBool($value);\n\t\t}\n\t\tif ($value !== false) {\n\t\t\treturn 'It is highly recommended that this setting is disabled. Make sure you understand the impact of having this setting turned on.';\n\t\t} else {\n\t\t\treturn true;\n\t\t}\n\t}\n\n\tpublic function testSalt($value) {\n\t\tif ($this->testForEmpty($value) !== true) return $this->testForEmpty($value);\n\t\tif (strlen($value) < 32) return 'The salt has to be an at least 32 byte long string.';\n\t\tif ($value == \"Rooraenietu8Eeyo<Qu2eeNfterd-dd+\") return 'This is the default salt shipped with the application and is therefore unsecure.';\n\t\treturn true;\n\t}\n\n\tpublic function testForTermsFile($value) {\n\t\treturn $this->__testForFile($value, APP . 'files' . DS . 'terms');\n\t}\n\n\tpublic function testForStyleFile($value) {\n\t\tif (empty($value)) return true;\n\t\treturn $this->__testForFile($value, APP . 'webroot' . DS . 'css');\n\t}\n\n\tpublic function testForCustomImage($value) {\n\t\treturn $this->__testForFile($value, APP . 'webroot' . DS . 'img' . DS . 'custom');\n\t}\n\n\tpublic function testPasswordLength($value) {\n\t\t$numeric = $this->testForNumeric($value);\n\t\tif ($numeric !== true) return $numeric;\n\t\tif ($value < 0) return 'Length cannot be negative, set a positive integer or 0 (to choose the default option).';\n\t\treturn true;\n\t}\n\n\tpublic function testForPortNumber($value) {\n\t\t$numeric = $this->testForNumeric($value);\n\t\tif ($numeric !== true) return $numeric;\n\t\tif ($value < 21 || $value > 65535) return 'Make sure that you pick a valid port number.';\n\t\treturn true;\n\t}\n\n\tpublic function testForZMQPortNumber($value) {\n\t\t$numeric = $this->testForNumeric($value);\n\t\tif ($numeric !== true) return $numeric;\n\t\tif ($value < 49152 || $value > 65535) return 'It is recommended that you pick a port number in the dynamic range (49152-65535). However, if you have a valid reason to use a different port, ignore this message.';\n\t\treturn true;\n\t}\n\n\tpublic function testPasswordRegex($value) {\n\t\tif (!empty($value) && @preg_match($value, 'test') === false) return 'Invalid regex.';\n\t\treturn true;\n\t}\n\n\tpublic function testPasswordResetText($value) {\n\t\tif (strpos($value, '$password') === false || strpos($value, '$username') === false || strpos($value, '$misp') === false) return 'The text served to the users must include the following replacement strings: \"$username\", \"$password\", \"$misp\"';\n\t\treturn true;\n\t}\n\n\tpublic function testForGPGBinary($value) {\n\t\tif (empty($value)) $value = $this->serverSettings['GnuPG']['binary']['value'];\n\t\tif (file_exists($value)) return true;\n\t\treturn 'Could not find the gnupg executable at the defined location.';\n\t}\n\n\tpublic function testForRPZDuration($value) {\n\t\tif (($this->testForNumeric($value) !== true && preg_match('/^[0-9]*[mhdw]$/i', $value)) || $value >= 0) {\n\t\t\treturn true;\n\t\t} else {\n\t\t\treturn 'Negative seconds found. The following formats are accepted: seconds (positive integer), or duration (positive integer) followed by a letter denoting scale (such as m, h, d, w for minutes, hours, days, weeks)';\n\t\t}\n\t}\n\n\tpublic function testForRPZBehaviour($value) {\n\t\t$numeric = $this->testForNumeric($value);\n\t\tif ($numeric !== true) return $numeric;\n\t\tif ($value < 0 || $value > 3) return 'Invalid setting, valid range is 0-3 (0 = DROP, 1 = NXDOMAIN, 2 = NODATA, 3 = walled garden.';\n\t\treturn true;\n\t}\n\n\tpublic function testForSightingVisibility($value) {\n\t\t$numeric = $this->testForNumeric($value);\n\t\tif ($numeric !== true) return $numeric;\n\t\tif ($value < 0 || $value > 2) return 'Invalid setting, valid range is 0-2 (0 = Event owner, 1 = Sighting reporters, 2 = Everyone.';\n\t\treturn true;\n\t}\n\n\tpublic function sightingsBeforeHook($setting, $value) {\n\t\tif ($value == true) {\n\t\t\t$this->updateDatabase('addSightings');\n\t\t}\n\t\treturn true;\n\t}\n\n\tpublic function testForRPZSerial($value) {\n\t\tif ($this->testForEmpty($value) !== true) return $this->testForEmpty($value);\n\t\tif (!preg_match('/^((\\$date(\\d*)|\\d*))$/', $value)) return 'Invalid format.';\n\t\treturn true;\n\t}\n\n\tpublic function testForRPZNS($value) {\n\t\tif ($this->testForEmpty($value) !== true) return $this->testForEmpty($value);\n\t\tif (!preg_match('/^\\w+(\\.\\w+)*(\\.?) \\w+(\\.\\w+)*$/', $value)) return 'Invalid format.';\n\t\treturn true;\n\t}\n\n\tpublic function zmqAfterHook($setting, $value) {\n\t\t$pubSubTool = $this->getPubSubTool();\n\t\t// If we are trying to change the enable setting to false, we don't need to test anything, just kill the server and return true.\n\t\tif ($setting == 'Plugin.ZeroMQ_enable') {\n\t\t\tif ($value == false || $value == 0) {\n\t\t\t\t$pubSubTool->killService();\n\t\t\t\treturn true;\n\t\t\t}\n\t\t} else if (!Configure::read('Plugin.ZeroMQ_enable')) {\n\t\t\t// If we are changing any other ZeroMQ settings but the feature is disabled, don't reload the service\n\t\t\treturn true;\n\t\t}\n\t\t$pubSubTool->reloadServer();\n\t\treturn true;\n\t}\n\n\tpublic function disableCacheAfterHook($setting, $value) {\n\t\tif ($value) {\n\t\t\t$this->Event = ClassRegistry::init('Event');\n\t\t\tApp::uses('Folder', 'Utility');\n\t\t\tApp::uses('File', 'Utility');\n\t\t\t// delete all cache files\n\t\t\tforeach ($this->Event->export_types as $type => $settings) {\n\t\t\t\t$dir = new Folder(APP . 'tmp/cached_exports/' . $type);\n\t\t\t\t// No caches created for this type of export, move on\n\t\t\t\tif ($dir == null) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\t$files = $dir->find('.*' . $settings['extension']);\n\t\t\t\tforeach ($files as $file) {\n\t\t\t\t\t$file = new File($dir->pwd() . DS . $file);\n\t\t\t\t\t$file->delete();\n\t\t\t\t\t$file->close();\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n\n\tpublic function correlationAfterHook($setting, $value) {\n\t\tif (!Configure::read('MISP.background_jobs')) {\n\t\t\t$this->Attribute = ClassRegistry::init('Attribute');\n\t\t\tif ($value) {\n\t\t\t\t$k = $this->Attribute->purgeCorrelations();\n\t\t\t} else {\n\t\t\t\t$k = $this->Attribute->generateCorrelation();\n\t\t\t}\n\t\t} else {\n\t\t\t$job = ClassRegistry::init('Job');\n\t\t\t$job->create();\n\t\t\tif ($value == true) {\n\t\t\t\t$jobType = 'jobPurgeCorrelation';\n\t\t\t\t$jobTypeText = 'purge correlations';\n\t\t\t} else {\n\t\t\t\t$jobType = 'jobGenerateCorrelation';\n\t\t\t\t$jobTypeText = 'generate correlation';\n\t\t\t}\n\t\t\t$data = array(\n\t\t\t\t\t'worker' => 'default',\n\t\t\t\t\t'job_type' => $jobTypeText,\n\t\t\t\t\t'job_input' => 'All attributes',\n\t\t\t\t\t'status' => 0,\n\t\t\t\t\t'retries' => 0,\n\t\t\t\t\t'org' => 'ADMIN',\n\t\t\t\t\t'message' => 'Job created.',\n\t\t\t);\n\t\t\t$job->save($data);\n\t\t\t$jobId = $job->id;\n\t\t\t$process_id = CakeResque::enqueue(\n\t\t\t\t\t'default',\n\t\t\t\t\t'AdminShell',\n\t\t\t\t\tarray($jobType, $jobId),\n\t\t\t\t\ttrue\n\t\t\t);\n\t\t\t$job->saveField('process_id', $process_id);\n\t\t}\n\t}\n\n\tpublic function ipLogBeforeHook($setting, $value) {\n\t\tif ($setting == 'MISP.log_client_ip') {\n\t\t\tif ($value == true) {\n\t\t\t\t$this->updateDatabase('addIPLogging');\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n\n\tpublic function customAuthBeforeHook($setting, $value) {\n\t\tif ($value) $this->updateDatabase('addCustomAuth');\n\t\t$this->cleanCacheFiles();\n\t\treturn true;\n\t}\n\n\t// never come here directly, always go through a secondary check like testForTermsFile in order to also pass along the expected file path\n\tprivate function __testForFile($value, $path) {\n\t\tif ($this->testForEmpty($value) !== true) return $this->testForEmpty($value);\n\t\tif (!$this->checkFilename($value)) return 'Invalid filename.';\n\t\t$file = $path . DS . $value;\n\t\tif (!file_exists($file)) return 'Could not find the specified file. Make sure that it is uploaded into the following directory: ' . $path;\n\t\treturn true;\n\t}\n\n\tpublic function serverSettingsSaveValue($setting, $value) {\n\t\tConfigure::write($setting, $value);\n\t\t$arrayFix = array(\n\t\t\t'Security.auth',\n\t\t\t'ApacheSecureAuth.ldapFilter'\n\t\t);\n\t\tforeach ($arrayFix as $settingFix) {\n\t\t\tif (Configure::read($settingFix) && is_array(Configure::read($settingFix)) && !empty(Configure::read($settingFix))) {\n\t\t\t\t$arrayElements = array();\n\t\t\t\tforeach (Configure::read($settingFix) as $array) {\n\t\t\t\t\tif (!in_array($array, $arrayElements)) $arrayElements[] = $array;\n\t\t\t\t}\n\t\t\t\tConfigure::write($settingFix, $arrayElements);\n\t\t\t}\n\t\t}\n\t\t$settingsToSave = array('debug', 'MISP', 'GnuPG', 'SMIME', 'Proxy', 'SecureAuth', 'Security', 'Session.defaults', 'Session.timeout', 'Session.autoRegenerate', 'site_admin_debug', 'Plugin', 'CertAuth', 'ApacheShibbAuth', 'ApacheSecureAuth');\n\t\t$settingsArray = array();\n\t\tforeach ($settingsToSave as $setting) {\n\t\t\t$settingsArray[$setting] = Configure::read($setting);\n\t\t}\n\t\t$settingsString = var_export($settingsArray, true);\n\t\t$settingsString = '<?php' . \"\\n\" . '$config = ' . $settingsString . ';';\n\t\tif (function_exists('opcache_reset')) opcache_reset();\n\t\tfile_put_contents(APP . 'Config' . DS . 'config.php', $settingsString);\n\t}\n\n\tpublic function checkVersion($newest) {\n\t\t$version_array = $this->checkMISPVersion();\n\t\t$current = 'v' . $version_array['major'] . '.' . $version_array['minor'] . '.' . $version_array['hotfix'];\n\t\t$newest_array = $this->__dissectVersion($newest);\n\t\t$upToDate = $this->__compareVersions(array($version_array['major'], $version_array['minor'], $version_array['hotfix']), $newest_array, 0);\n\t\treturn array ('current' => $current, 'newest' => $newest, 'upToDate' => $upToDate);\n\t}\n\n\tprivate function __dissectVersion($version) {\n\t\t$version = substr($version, 1);\n\t\treturn explode('.', $version);\n\t}\n\n\tprivate function __compareVersions($current, $newest, $i) {\n\t\tif ($current[$i] == $newest[$i]) {\n\t\t\tif ($i < 2) {\n\t\t\t\treturn $this->__compareVersions($current, $newest, $i+1);\n\t\t\t} else {\n\t\t\t\treturn 'same';\n\t\t\t}\n\t\t} else if ($current[$i] < $newest[$i]) {\n\t\t\treturn 'older';\n\t\t} else {\n\t\t\treturn 'newer';\n\t\t}\n\t}\n\n\tpublic function getFileRules() {\n\t\t$validItems = array(\n\t\t\t\t'orgs' => array(\n\t\t\t\t\t\t'name' => 'Organisation logos',\n\t\t\t\t\t\t'description' => 'The logo used by an organisation on the event index, event view, discussions, proposals, etc. Make sure that the filename is in the org.png format, where org is the case-sensitive organisation name.',\n\t\t\t\t\t\t'expected' => array(),\n\t\t\t\t\t\t'valid_format' => '48x48 pixel .png files',\n\t\t\t\t\t\t'path' => APP . 'webroot' . DS . 'img' . DS . 'orgs',\n\t\t\t\t\t\t'regex' => '.*\\.(png|PNG)$',\n\t\t\t\t\t\t'regex_error' => 'Filename must be in the following format: *.png',\n\t\t\t\t\t\t'files' => array(),\n\t\t\t\t),\n\t\t\t\t'img' => array(\n\t\t\t\t\t\t'name' => 'Additional image files',\n\t\t\t\t\t\t'description' => 'Image files uploaded into this directory can be used for various purposes, such as for the login page logos',\n\t\t\t\t\t\t'expected' => array(\n\t\t\t\t\t\t\t\t'MISP.footer_logo' => Configure::read('MISP.footer_logo'),\n\t\t\t\t\t\t\t\t'MISP.home_logo' => Configure::read('MISP.home_logo'),\n\t\t\t\t\t\t\t\t'MISP.welcome_logo' => Configure::read('MISP.welcome_logo'),\n\t\t\t\t\t\t\t\t'MISP.welcome_logo2' => Configure::read('MISP.welcome_logo2'),\n\t\t\t\t\t\t),\n\t\t\t\t\t\t'valid_format' => 'text/html if served inline, anything that conveys the terms of use if served as download',\n\t\t\t\t\t\t'path' => APP . 'webroot' . DS . 'img' . DS . 'custom',\n\t\t\t\t\t\t'regex' => '.*\\.(png|PNG)$',\n\t\t\t\t\t\t'regex_error' => 'Filename must be in the following format: *.png',\n\t\t\t\t\t\t'files' => array(),\n\t\t\t\t),\n\t\t);\n\t\treturn $validItems;\n\t}\n\n\tpublic function grabFiles() {\n\t\t$validItems = $this->getFileRules();\n\t\tApp::uses('Folder', 'Utility');\n\t\tApp::uses('File', 'Utility');\n\t\tforeach ($validItems as $k => $item) {\n\t\t\t$dir = new Folder($item['path']);\n\t\t\t$files = $dir->find($item['regex'], true);\n\t\t\tforeach ($files as $file) {\n\t\t\t\t$f = new File($item['path'] . DS . $file);\n\t\t\t\t$validItems[$k]['files'][] = array('filename' => $file, 'filesize' => $f->size(), 'read' => $f->readable(), 'write' => $f->writable(), 'execute' => $f->executable());\n\t\t\t}\n\t\t}\n\t\treturn $validItems;\n\t}\n\n\tpublic function runConnectionTest($id) {\n\t\t$server = $this->find('first', array('conditions' => array('Server.id' => $id)));\n\t\tApp::uses('SyncTool', 'Tools');\n\t\t$syncTool = new SyncTool();\n\t\t$HttpSocket = $syncTool->setupHttpSocket($server);\n\t\t$request = array(\n\t\t\t'header' => array(\n\t\t\t\t'Authorization' => $server['Server']['authkey'],\n\t\t\t\t'Accept' => 'application/json',\n\t\t\t\t'Content-Type' => 'application/json',\n\t\t\t)\n\t\t);\n\t\t$uri = $server['Server']['url'] . '/servers/getVersion';\n\t\ttry {\n\t\t\t$response = $HttpSocket->get($uri, false, $request);\n\t\t} catch (Exception $e) {\n\t\t\t$this->Log = ClassRegistry::init('Log');\n\t\t\t$this->Log->create();\n\t\t\t$this->Log->save(array(\n\t\t\t\t\t'org' => 'SYSTEM',\n\t\t\t\t\t'model' => 'Server',\n\t\t\t\t\t'model_id' => $id,\n\t\t\t\t\t'email' => 'SYSTEM',\n\t\t\t\t\t'action' => 'error',\n\t\t\t\t\t'user_id' => 0,\n\t\t\t\t\t'title' => 'Error: Connection test failed. Reason: ' . json_encode($e->getMessage()),\n\t\t\t));\n\t\t\treturn array('status' => 2);\n\t\t}\n\t\tif ($response->isOk()) {\n\t\t\treturn array('status' => 1, 'message' => $response->body());\n\t\t} else {\n\t\t\tif ($response->code == '403') return array('status' => 4);\n\t\t\tif ($response->code == '405') {\n\t\t\t\ttry {\n\t\t\t\t\t$responseText = json_decode($response->body, true)['message'];\n\t\t\t\t} catch (Exception $e) {\n\t\t\t\t\treturn array('status' => 3);\n\t\t\t\t}\n\t\t\t\tif ($responseText === 'Your user account is expecting a password change, please log in via the web interface and change it before proceeding.') return array('status' => 5);\n\t\t\t\telse if ($responseText === 'You have not accepted the terms of use yet, please log in via the web interface and accept them.') return array('status' => 6);\n\t\t\t}\n\t\t\treturn array('status' => 3);\n\t\t}\n\t}\n\n\tpublic function runPOSTtest($id) {\n\t\t$server = $this->find('first', array('conditions' => array('Server.id' => $id)));\n\t\tApp::uses('SyncTool', 'Tools');\n\t\t$syncTool = new SyncTool();\n\t\t$HttpSocket = $syncTool->setupHttpSocket($server);\n\t\t$request = array(\n\t\t\t'header' => array(\n\t\t\t\t'Authorization' => $server['Server']['authkey'],\n\t\t\t\t'Accept' => 'application/json',\n\t\t\t\t'Content-Type' => 'application/json',\n\t\t\t)\n\t\t);\n\t\t$testFile = file_get_contents(APP . 'files/scripts/test_payload.txt');\n\t\t$uri = $server['Server']['url'] . '/servers/postTest';\n\t\t$this->Log = ClassRegistry::init('Log');\n\t\ttry {\n\t\t\t$response = $HttpSocket->post($uri, json_encode(array('testString' => $testFile)), $request);\n\t\t\t$response = json_decode($response, true);\n\t\t} catch (Exception $e) {\n\t\t\t$this->Log->create();\n\t\t\t$this->Log->save(array(\n\t\t\t\t\t'org' => 'SYSTEM',\n\t\t\t\t\t'model' => 'Server',\n\t\t\t\t\t'model_id' => $id,\n\t\t\t\t\t'email' => 'SYSTEM',\n\t\t\t\t\t'action' => 'error',\n\t\t\t\t\t'user_id' => 0,\n\t\t\t\t\t'title' => 'Error: POST connection test failed. Reason: ' . json_encode($e->getMessage()),\n\t\t\t));\n\t\t\treturn 8;\n\t\t}\n\t\tif (!isset($response['body']['testString']) || $response['body']['testString'] !== $testFile) {\n\t\t\t$responseString = isset($response['body']['testString']) ? $response['body']['testString'] : 'Response was empty.';\n\t\t\t$this->Log->create();\n\t\t\t$this->Log->save(array(\n\t\t\t\t\t'org' => 'SYSTEM',\n\t\t\t\t\t'model' => 'Server',\n\t\t\t\t\t'model_id' => $id,\n\t\t\t\t\t'email' => 'SYSTEM',\n\t\t\t\t\t'action' => 'error',\n\t\t\t\t\t'user_id' => 0,\n\t\t\t\t\t'title' => 'Error: POST connection test failed due to the message body not containing the expected data. Response: ' . PHP_EOL . PHP_EOL . $responseString,\n\t\t\t));\n\t\t\treturn 9;\n\t\t}\n\t\t$headers = array('Accept', 'Content-type');\n\t\tforeach ($headers as $header) {\n\t\t\tif (!isset($response['headers'][$header]) || $response['headers'][$header] != 'application/json') {\n\t\t\t\t$responseHeader = isset($response['headers'][$header]) ? $response['headers'][$header] : 'Header was not set.';\n\t\t\t\t$this->Log->create();\n\t\t\t\t$this->Log->save(array(\n\t\t\t\t\t\t'org' => 'SYSTEM',\n\t\t\t\t\t\t'model' => 'Server',\n\t\t\t\t\t\t'model_id' => $id,\n\t\t\t\t\t\t'email' => 'SYSTEM',\n\t\t\t\t\t\t'action' => 'error',\n\t\t\t\t\t\t'user_id' => 0,\n\t\t\t\t\t\t'title' => 'Error: POST connection test failed due to a header not matching the expected value. Expected: \"application/json\", received \"' . $responseHeader,\n\t\t\t\t));\n\t\t\t\treturn 10;\n\t\t\t}\n\t\t}\n\t\treturn 1;\n\t}\n\n\tpublic function checkVersionCompatibility($id, $user = array(), $HttpSocket = false) {\n\t\t// for event publishing when we don't have a user.\n\t\tif (empty($user)) $user = array('Organisation' => array('name' => 'SYSTEM'), 'email' => 'SYSTEM', 'id' => 0);\n\t\tApp::uses('Folder', 'Utility');\n\t\t$file = new File(ROOT . DS . 'VERSION.json', true);\n\t\t$localVersion = json_decode($file->read(), true);\n\t\t$file->close();\n\t\t$server = $this->find('first', array('conditions' => array('Server.id' => $id)));\n\t\tif (!$HttpSocket) {\n\t\t\tApp::uses('SyncTool', 'Tools');\n\t\t\t$syncTool = new SyncTool();\n\t\t\t$HttpSocket = $syncTool->setupHttpSocket($server);\n\t\t}\n\t\t$uri = $server['Server']['url'] . '/servers/getVersion';\n\t\t$request = array(\n\t\t\t\t'header' => array(\n\t\t\t\t\t\t'Authorization' => $server['Server']['authkey'],\n\t\t\t\t\t\t'Accept' => 'application/json',\n\t\t\t\t\t\t'Content-Type' => 'application/json',\n\t\t\t\t)\n\t\t);\n\t\ttry {\n\t\t\t$response = $HttpSocket->get($uri, '', $request);\n\t\t} catch (Exception $e) {\n\t\t\tif (!isset($response) || $response->code != '200') {\n\t\t\t\t$this->Log = ClassRegistry::init('Log');\n\t\t\t\t$this->Log->create();\n\t\t\t\tif (isset($response->code)) {\n\t\t\t\t\t$title = 'Error: Connection to the server has failed.' . isset($response->code) ? ' Returned response code: ' . $response->code : '';\n\t\t\t\t} else {\n\t\t\t\t\t$title = 'Error: Connection to the server has failed. The returned exception\\'s error message was: ' . $e->getMessage();\n\t\t\t\t}\n\t\t\t\t$this->Log->save(array(\n\t\t\t\t\t\t'org' => $user['Organisation']['name'],\n\t\t\t\t\t\t'model' => 'Server',\n\t\t\t\t\t\t'model_id' => $id,\n\t\t\t\t\t\t'email' => $user['email'],\n\t\t\t\t\t\t'action' => 'error',\n\t\t\t\t\t\t'user_id' => $user['id'],\n\t\t\t\t\t\t'title' => $title,\n\t\t\t\t));\n\t\t\t}\n\t\t}\n\t\tif (!isset($response) || $response->code != '200') {\n\t\t\treturn 1;\n\t\t}\n\t\t$remoteVersion = json_decode($response->body, true);\n\t\t$canPush = isset($remoteVersion['perm_sync']) ? $remoteVersion['perm_sync'] : false;\n\t\t$remoteVersion = explode('.', $remoteVersion['version']);\n\t\tif (!isset($remoteVersion[0])) {\n\t\t\t$this->Log = ClassRegistry::init('Log');\n\t\t\t$this->Log->create();\n\t\t\t$this->Log->save(array(\n\t\t\t\t\t'org' => $user['Organisation']['name'],\n\t\t\t\t\t'model' => 'Server',\n\t\t\t\t\t'model_id' => $id,\n\t\t\t\t\t'email' => $user['email'],\n\t\t\t\t\t'action' => 'error',\n\t\t\t\t\t'user_id' => $user['id'],\n\t\t\t\t\t'title' => 'Error: Server didn\\'t send the expected response. This may be because the remote server version is outdated.',\n\t\t\t));\n\t\t\treturn 2;\n\t\t}\n\t\t$response = false;\n\t\t$success = false;\n\t\t$issueLevel = \"warning\";\n\t\tif ($localVersion['major'] > $remoteVersion[0]) $response = \"Sync to Server ('\" . $id . \"') aborted. The remote instance's MISP version is behind by a major version.\";\n\t\tif ($response === false && $localVersion['major'] < $remoteVersion[0]) {\n\t\t\t$response = \"Sync to Server ('\" . $id . \"') aborted. The remote instance is at least a full major version ahead - make sure you update your MISP instance!\";\n\t\t}\n\t\tif ($response === false && $localVersion['minor'] > $remoteVersion[1]) $response = \"Sync to Server ('\" . $id . \"') aborted. The remote instance's MISP version is behind by a minor version.\";\n\t\tif ($response === false && $localVersion['minor'] < $remoteVersion[1]) {\n\t\t\t$response = \"Sync to Server ('\" . $id . \"') aborted. The remote instance is at least a full minor version ahead - make sure you update your MISP instance!\";\n\t\t}\n\n\t\t// if we haven't set a message yet, we're good to go. We are only behind by a hotfix version\n\t\tif ($response === false) {\n\t\t\t$success = true;\n\t\t}\n\t\telse $issueLevel = \"error\";\n\t\tif ($response === false && $localVersion['hotfix'] > $remoteVersion[2]) $response = \"Sync to Server ('\" . $id . \"') initiated, but the remote instance is a few hotfixes behind.\";\n\t\tif ($response === false && $localVersion['hotfix'] < $remoteVersion[2]) $response = \"Sync to Server ('\" . $id . \"') initiated, but the remote instance is a few hotfixes ahead. Make sure you keep your instance up to date!\";\n\n\t\tif ($response !== false) {\n\t\t\t$this->Log = ClassRegistry::init('Log');\n\t\t\t$this->Log->create();\n\t\t\t$this->Log->save(array(\n\t\t\t\t\t'org' => $user['Organisation']['name'],\n\t\t\t\t\t'model' => 'Server',\n\t\t\t\t\t'model_id' => $id,\n\t\t\t\t\t'email' => $user['email'],\n\t\t\t\t\t'action' => $issueLevel,\n\t\t\t\t\t'user_id' => $user['id'],\n\t\t\t\t\t'title' => ucfirst($issueLevel) . ': ' . $response,\n\t\t\t));\n\t\t}\n\t\treturn array('success' => $success, 'response' => $response, 'canPush' => $canPush, 'version' => $remoteVersion);\n\t}\n\n\t/* This is a fallback for legacy remote instances that don't report back the current user's sync permission.\n\t *\n\t * The idea is simple: If we have no way of determining the perm_sync flag from the remote instance, request\n\t * /servers/testConnection from the remote. This API is used to check the remote connectivity and expects an ID to be passed\n\t * In this case however we are not passing an ID so ideally it will return 404, meaning that the instance is invalid.\n\t * We are abusing the fact that only sync users can use this functionality, if we don't have sync permission we'll get a 403\n\t * instead of the 404. It's hacky but it works fine and serves the purpose.\n\t */\n\tpublic function checkLegacyServerSyncPrivilege($id, $HttpSocket = false) {\n\t\t$server = $this->find('first', array('conditions' => array('Server.id' => $id)));\n\t\tif (!$HttpSocket) {\n\t\t\tApp::uses('SyncTool', 'Tools');\n\t\t\t$syncTool = new SyncTool();\n\t\t\t$HttpSocket = $syncTool->setupHttpSocket($server);\n\t\t}\n\t\t$uri = $server['Server']['url'] . '/servers/testConnection';\n\t\t$request = array(\n\t\t\t\t'header' => array(\n\t\t\t\t\t\t'Authorization' => $server['Server']['authkey'],\n\t\t\t\t\t\t'Accept' => 'application/json',\n\t\t\t\t\t\t'Content-Type' => 'application/json',\n\t\t\t\t)\n\t\t);\n\t\ttry {\n\t\t\t$response = $HttpSocket->get($uri, '', $request);\n\t\t} catch (Exception $e) {\n\t\t\treturn false;\n\t\t}\n\t\tif ($response->code == '404') {\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\tpublic function isJson($string) {\n\t\treturn (json_last_error() == JSON_ERROR_NONE);\n\t}\n\n\tpublic function captureServer($server, $user) {\n\t\tif (isset($server[0])) $server = $server[0];\n\t\tif ($server['url'] == Configure::read('MISP.baseurl')) return 0;\n\t\t$existingServer = $this->find('first', array(\n\t\t\t\t'recursive' => -1,\n\t\t\t\t'conditions' => array('url' => $server['url'])\n\t\t));\n\t\t// unlike with other capture methods, if we find a server that we don't know\n\t\t// we don't want to save it.\n\t\tif (empty($existingServer)) {\n\t\t\treturn false;\n\t\t}\n\t\treturn $existingServer[$this->alias]['id'];\n\t}\n\n\tpublic function writeableDirsDiagnostics(&$diagnostic_errors) {\n\t\tApp::uses('File', 'Utility');\n\t\tApp::uses('Folder', 'Utility');\n\t\t// check writeable directories\n\t\t$writeableDirs = array(\n\t\t\t\t'/tmp' => 0,\n\t\t\t\tAPP . 'tmp' => 0,\n\t\t\t\tAPP . 'files' => 0,\n\t\t\t\tAPP . 'files' . DS . 'scripts' . DS . 'tmp' => 0,\n\t\t\t\tAPP . 'tmp' . DS . 'csv_all' => 0,\n\t\t\t\tAPP . 'tmp' . DS . 'csv_sig' => 0,\n\t\t\t\tAPP . 'tmp' . DS . 'md5' => 0,\n\t\t\t\tAPP . 'tmp' . DS . 'sha1' => 0,\n\t\t\t\tAPP . 'tmp' . DS . 'snort' => 0,\n\t\t\t\tAPP . 'tmp' . DS . 'suricata' => 0,\n\t\t\t\tAPP . 'tmp' . DS . 'text' => 0,\n\t\t\t\tAPP . 'tmp' . DS . 'xml' => 0,\n\t\t\t\tAPP . 'tmp' . DS . 'files' => 0,\n\t\t\t\tAPP . 'tmp' . DS . 'logs' => 0,\n\t\t\t\tAPP . 'tmp' . DS . 'bro' => 0,\n\t\t);\n\t\tforeach ($writeableDirs as $path => &$error) {\n\t\t\t$dir = new Folder($path);\n\t\t\tif (is_null($dir->path)) $error = 1;\n\t\t\t$file = new File($path . DS . 'test.txt', true);\n\t\t\tif ($error == 0 && !$file->write('test')) $error = 2;\n\t\t\tif ($error != 0) $diagnostic_errors++;\n\t\t\t$file->delete();\n\t\t\t$file->close();\n\t\t}\n\t\treturn $writeableDirs;\n\t}\n\n\tpublic function writeableFilesDiagnostics(&$diagnostic_errors) {\n\t\t$writeableFiles = array(\n\t\t\t\tAPP . 'Config' . DS . 'config.php' => 0,\n\t\t);\n\t\tforeach ($writeableFiles as $path => &$error) {\n\t\t\tif (!file_exists($path)) {\n\t\t\t\t$error = 1;\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (!is_writeable($path)) {\n\t\t\t\t$error = 2;\n\t\t\t\t$diagnostic_errors++;\n\t\t\t}\n\t\t}\n\t\treturn $writeableFiles;\n\t}\n\n\tpublic function readableFilesDiagnostics(&$diagnostic_errors) {\n\t\t$readableFiles = array(\n\t\t\t\tAPP . 'files' . DS . 'scripts' . DS . 'stixtest.py' => 0\n\t\t);\n\t\tforeach ($readableFiles as $path => &$error) {\n\t\t\tif (!is_readable($path)) {\n\t\t\t\t$error = 1;\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t}\n\t\treturn $readableFiles;\n\t}\n\n\tpublic function stixDiagnostics(&$diagnostic_errors, &$stixVersion, &$cyboxVersion, &$mixboxVersion) {\n\t\t$result = array();\n\t\t$expected = array('stix' => '1.1.1.4', 'cybox' => '2.1.0.12', 'mixbox' => '1.0.2');\n\t\t// check if the STIX and Cybox libraries are working using the test script stixtest.py\n\t\t$scriptResult = shell_exec('python ' . APP . 'files' . DS . 'scripts' . DS . 'stixtest.py');\n\t\t$scriptResult = json_decode($scriptResult, true);\n\t\tif ($scriptResult !== null) {\n\t\t\t$scriptResult['operational'] = $scriptResult['success'];\n\t\t\tif ($scriptResult['operational'] == 0) {\n\t\t\t\t$diagnostic_errors++;\n\t\t\t\treturn array('operational' => 0, 'stix' => array('expected' => $expected['stix']), 'cybox' => array('expected' => $expected['cybox']), 'mixbox' => array('expected' => $expected['mixbox']));\n\t\t\t}\n\t\t} else {\n\t\t\treturn array('operational' => 0, 'stix' => array('expected' => $expected['stix']), 'cybox' => array('expected' => $expected['cybox']), 'mixbox' => array('expected' => $expected['mixbox']));\n\t\t}\n\t\t$result['operational'] = $scriptResult['operational'];\n\t\tforeach ($expected as $package => $version) {\n\t\t\t$result[$package]['version'] = $scriptResult[$package];\n\t\t\t$result[$package]['expected'] = $expected[$package];\n\t\t\t$result[$package]['status'] = $result[$package]['version'] == $result[$package]['expected'] ? 1 : 0;\n\t\t\tif ($result[$package]['status'] == 0) $diagnostic_errors++;\n\t\t\t${$package . 'Version'}[0] = str_replace('$current', $result[$package]['version'], ${$package . 'Version'}[0]);\n\t\t\t${$package . 'Version'}[0] = str_replace('$expected', $result[$package]['expected'], ${$package . 'Version'}[0]);\n\t\t}\n\t\treturn $result;\n\t}\n\n\tpublic function gpgDiagnostics(&$diagnostic_errors) {\n\t\t$gpgStatus = 0;\n\t\tif (Configure::read('GnuPG.email') && Configure::read('GnuPG.homedir')) {\n\t\t\t$continue = true;\n\t\t\ttry {\n\t\t\t\trequire_once 'Crypt/GPG.php';\n\t\t\t\t$gpg = new Crypt_GPG(array('homedir' => Configure::read('GnuPG.homedir'), 'binary' => (Configure::read('GnuPG.binary') ? Configure::read('GnuPG.binary') : '/usr/bin/gpg')));\n\t\t\t} catch (Exception $e) {\n\t\t\t\t$gpgStatus = 2;\n\t\t\t\t$continue = false;\n\t\t\t}\n\t\t\tif ($continue) {\n\t\t\t\ttry {\n\t\t\t\t\t$key = $gpg->addSignKey(Configure::read('GnuPG.email'), Configure::read('GnuPG.password'));\n\t\t\t\t} catch (Exception $e) {\n\t\t\t\t\t$gpgStatus = 3;\n\t\t\t\t\t$continue = false;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif ($continue) {\n\t\t\t\ttry {\n\t\t\t\t\t$gpgStatus = 0;\n\t\t\t\t\t$signed = $gpg->sign('test', Crypt_GPG::SIGN_MODE_CLEAR);\n\t\t\t\t} catch (Exception $e) {\n\t\t\t\t\t$gpgStatus = 4;\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\t$gpgStatus = 1;\n\t\t}\n\t\tif ($gpgStatus != 0) $diagnostic_errors++;\n\t\treturn $gpgStatus;\n\t}\n\n\tpublic function zmqDiagnostics(&$diagnostic_errors) {\n\t\tif (!Configure::read('Plugin.ZeroMQ_enable')) return 1;\n\t\t$pubSubTool = $this->getPubSubTool();\n\t\tif (!$pubSubTool->checkIfPythonLibInstalled()) {\n\t\t\t$diagnostic_errors++;\n\t\t\treturn 2;\n\t\t}\n\t\tif ($pubSubTool->checkIfRunning()) return 0;\n\t\t$diagnostic_errors++;\n\t\treturn 3;\n\t}\n\n\tpublic function moduleDiagnostics(&$diagnostic_errors, $type = 'Enrichment') {\n\t\t$this->Module = ClassRegistry::init('Module');\n\t\t$types = array('Enrichment', 'Import', 'Export', 'Cortex');\n\t\t$diagnostic_errors++;\n\t\tif (Configure::read('Plugin.' . $type . '_services_enable')) {\n\t\t\t$exception = false;\n\t\t\t$result = $this->Module->getModules(false, $type, $exception);\n\t\t\tif ($exception) return $exception;\n\t\t\tif (empty($result)) return 2;\n\t\t\t$diagnostic_errors--;\n\t\t\treturn 0;\n\t\t}\n\t\treturn 1;\n\t}\n\n\tpublic function proxyDiagnostics(&$diagnostic_errors) {\n\t\t$proxyStatus = 0;\n\t\t$proxy = Configure::read('Proxy');\n\t\tif (!empty($proxy['host'])) {\n\t\t\tApp::uses('SyncTool', 'Tools');\n\t\t\t$syncTool = new SyncTool();\n\t\t\ttry {\n\t\t\t\t$HttpSocket = $syncTool->setupHttpSocket();\n\t\t\t\t$proxyResponse = $HttpSocket->get('http://www.example.com/');\n\t\t\t} catch (Exception $e) {\n\t\t\t\t$proxyStatus = 2;\n\t\t\t}\n\t\t\tif (empty($proxyResponse) || $proxyResponse->code > 399) {\n\t\t\t\t$proxyStatus = 2;\n\t\t\t}\n\t\t} else {\n\t\t\t$proxyStatus = 1;\n\t\t}\n\t\tif ($proxyStatus > 1) $diagnostic_errors++;\n\t\treturn $proxyStatus;\n\t}\n\n\tpublic function sessionDiagnostics(&$diagnostic_errors = 0, &$sessionCount = '') {\n\t\tif (Configure::read('Session.defaults') !== 'database') {\n\t\t\t$sessionCount = 'N/A';\n\t\t\treturn 2;\n\t\t}\n\t\t$sql = 'SELECT COUNT(id) AS session_count FROM cake_sessions WHERE expires < ' . time() . ';';\n\t\t$sqlResult = $this->query($sql);\n\t\tif (isset($sqlResult[0][0])) $sessionCount = $sqlResult[0][0]['session_count'];\n\t\telse {\n\t\t\t$sessionCount = 'Error';\n\t\t\treturn 3;\n\t\t}\n\t\tif ($sessionCount > 1000) {\n\t\t\t$diagnostic_errors++;\n\t\t\treturn 1;\n\t\t}\n\t\treturn 0;\n\t}\n\n\tpublic function workerDiagnostics(&$workerIssueCount) {\n\t\ttry {\n\t\t\t$this->ResqueStatus = new ResqueStatus\\ResqueStatus(Resque::redis());\n\t\t} catch (Exception $e) {\n\t\t\t// redis connection failed\n\t\t\treturn array(\n\t\t\t\t\t'cache' => array('ok' => false),\n\t\t\t\t\t'default' => array('ok' => false),\n\t\t\t\t\t'email' => array('ok' => false),\n\t\t\t\t\t'prio' => array('ok' => false),\n\t\t\t\t\t'scheduler' => array('ok' => false)\n\t\t\t);\n\t\t}\n\t\t$workers = $this->ResqueStatus->getWorkers();\n\t\tif (function_exists('posix_getpwuid')) {\n\t\t\t$currentUser = posix_getpwuid(posix_geteuid());\n\t\t\t$currentUser = $currentUser['name'];\n\t\t} else {\n\t\t\t$currentUser = trim(shell_exec('whoami'));\n\t\t}\n\t\t$worker_array = array(\n\t\t\t\t'cache' => array('ok' => true),\n\t\t\t\t'default' => array('ok' => true),\n\t\t\t\t'email' => array('ok' => true),\n\t\t\t\t'prio' => array('ok' => true),\n\t\t\t\t'scheduler' => array('ok' => true)\n\t\t);\n\t\t$procAccessible = file_exists('/proc');\n\t\tforeach ($workers as $pid => $worker) {\n\t\t\t$entry = ($worker['type'] == 'regular') ? $worker['queue'] : $worker['type'];\n\t\t\t$correct_user = ($currentUser === $worker['user']);\n\t\t\tif (!is_numeric($pid)) throw new MethodNotAllowedException('Non numeric PID found.');\n\t\t\tif ($procAccessible) {\n\t\t\t\t$alive = $correct_user ? (file_exists('/proc/' . addslashes($pid))) : false;\n\t\t\t} else {\n\t\t\t\t$alive = 'N/A';\n\t\t\t}\n\t\t\t$ok = true;\n\t\t\tif (!$alive || !$correct_user) {\n\t\t\t\t$ok = false;\n\t\t\t\t$workerIssueCount++;\n\t\t\t\t$worker_array[$entry]['ok'] = false;\n\t\t\t}\n\t\t\t$worker_array[$entry]['workers'][] = array('pid' => $pid, 'user' => $worker['user'], 'alive' => $alive, 'correct_user' => $correct_user, 'ok' => $ok);\n\t\t}\n\t\tforeach ($worker_array as $k => $queue) {\n\t\t\tif ($k != 'scheduler') $worker_array[$k]['jobCount'] = CakeResque::getQueueSize($k);\n\t\t\tif (!isset($queue['workers'])) {\n\t\t\t\t$workerIssueCount++;\n\t\t\t\t$worker_array[$k]['ok'] = false;\n\t\t\t}\n\t\t}\n\t\t$worker_array['proc_accessible'] = $procAccessible;\n\t\treturn $worker_array;\n\t}\n\n\tpublic function retrieveCurrentSettings($branch, $subString) {\n\t\t$settings = array();\n\t\tforeach ($this->serverSettings[$branch] as $settingName => $setting) {\n\t\t\tif (strpos($settingName, $subString) !== false) {\n\t\t\t\t$settings[$settingName] = $setting['value'];\n\t\t\t\tif (Configure::read('Plugin.' . $settingName)) $settings[$settingName] = Configure::read('Plugin.' . $settingName);\n\t\t\t\tif (isset($setting['options'])) $settings[$settingName] = $setting['options'][$settings[$settingName]];\n\t\t\t}\n\t\t}\n\t\treturn $settings;\n\t}\n\n\tpublic function killWorker($pid, $user) {\n\t\tif (!is_numeric($pid)) throw new MethodNotAllowedException('Non numeric PID found!');\n\t\t$this->ResqueStatus = new ResqueStatus\\ResqueStatus(Resque::redis());\n\t\t$workers = $this->ResqueStatus->getWorkers();\n\t\t$this->Log = ClassRegistry::init('Log');\n\t\tif (isset($workers[$pid])) {\n\t\t\t$worker = $workers[$pid];\n\t\t\tif (substr_count(trim(shell_exec('ps -p ' . $pid)), PHP_EOL) > 0 ? true : false) {\n\t\t\t\tshell_exec('kill ' . $pid . ' > /dev/null 2>&1 &');\n\t\t\t\t$this->Log->create();\n\t\t\t\t$this->Log->save(array(\n\t\t\t\t\t\t'org' => $user['Organisation']['name'],\n\t\t\t\t\t\t'model' => 'User',\n\t\t\t\t\t\t'model_id' => $user['id'],\n\t\t\t\t\t\t'email' => $user['email'],\n\t\t\t\t\t\t'action' => 'stop_worker',\n\t\t\t\t\t\t'user_id' => $user['id'],\n\t\t\t\t\t\t'title' => 'Stopping a worker.',\n\t\t\t\t\t\t'change' => 'Stopping a worker. Worker was of type ' . $worker['queue'] . ' with pid ' . $pid\n\t\t\t\t));\n\t\t\t} else {\n\t\t\t\t$this->ResqueStatus->removeWorker($pid);\n\t\t\t\t$this->Log->create();\n\t\t\t\t$this->Log->save(array(\n\t\t\t\t\t\t'org' => $user['Organisation']['name'],\n\t\t\t\t\t\t'model' => 'User',\n\t\t\t\t\t\t'model_id' => $user['id'],\n\t\t\t\t\t\t'email' => $user['email'],\n\t\t\t\t\t\t'action' => 'remove_dead_workers',\n\t\t\t\t\t\t'user_id' => $user['id'],\n\t\t\t\t\t\t'title' => 'Removing a dead worker.',\n\t\t\t\t\t\t'change' => 'Removing dead worker data. Worker was of type ' . $worker['queue'] . ' with pid ' . $pid\n\t\t\t\t));\n\t\t\t}\n\t\t\t$this->ResqueStatus->removeWorker($pid);\n\t\t}\n\t}\n\n\tpublic function workerRemoveDead($user) {\n\t\t$this->ResqueStatus = new ResqueStatus\\ResqueStatus(Resque::redis());\n\t\t$workers = $this->ResqueStatus->getWorkers();\n\t\t$this->Log = ClassRegistry::init('Log');\n\t\tif (function_exists('posix_getpwuid')) {\n\t\t\t$currentUser = posix_getpwuid(posix_geteuid());\n\t\t\t$currentUser = $currentUser['name'];\n\t\t} else $currentUser = trim(shell_exec('whoami'));\n\t\tforeach ($workers as $pid => $worker) {\n\t\t\tif (!is_numeric($pid)) throw new MethodNotAllowedException('Non numeric PID found!');\n\t\t\t$pidTest = substr_count(trim(shell_exec('ps -p ' . $pid)), PHP_EOL) > 0 ? true : false;\n\t\t\tif ($worker['user'] == $currentUser && !$pidTest) {\n\t\t\t\t$this->ResqueStatus->removeWorker($pid);\n\t\t\t\t$this->Log->create();\n\t\t\t\t$this->Log->save(array(\n\t\t\t\t\t\t'org' => $user['Organisation']['name'],\n\t\t\t\t\t\t'model' => 'User',\n\t\t\t\t\t\t'model_id' => $user['id'],\n\t\t\t\t\t\t'email' => $user['email'],\n\t\t\t\t\t\t'action' => 'remove_dead_workers',\n\t\t\t\t\t\t'user_id' => $user['id'],\n\t\t\t\t\t\t'title' => 'Removing a dead worker.',\n\t\t\t\t\t\t'change' => 'Removing dead worker data. Worker was of type ' . $worker['queue'] . ' with pid ' . $pid\n\t\t\t\t));\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic function upgrade2324($user_id, $jobId = false) {\n\t\t$this->cleanCacheFiles();\n\t\tif (Configure::read('MISP.background_jobs') && $jobId) {\n\t\t\t$this->Job = ClassRegistry::init('Job');\n\t\t\t$this->Job->id = $jobId;\n\t\t}\n\t\t$this->Log = ClassRegistry::init('Log');\n\t\t$this->Organisation = ClassRegistry::init('Organisation');\n\t\t$this->Attribute = ClassRegistry::init('Attribute');\n\t\t$this->Log->create();\n\t\t$this->Log->save(array(\n\t\t\t\t'org' => 'SYSTEM',\n\t\t\t\t'model' => 'Server',\n\t\t\t\t'model_id' => 0,\n\t\t\t\t'email' => 'SYSTEM',\n\t\t\t\t'action' => 'upgrade_24',\n\t\t\t\t'user_id' => 0,\n\t\t\t\t'title' => 'Upgrade initiated',\n\t\t\t\t'change' => 'Starting the migration of the database to 2.4',\n\t\t));\n\t\tif (Configure::read('MISP.background_jobs') && $jobId) {\n\t\t\t$this->Job->saveField('progress', 10);\n\t\t\t$this->Job->saveField('message', 'Starting the migration of the database to 2.4');\n\t\t}\n\t\t$this->query('UPDATE roles SET perm_template = 1 WHERE perm_site_admin = 1 OR perm_admin = 1');\n\t\t$this->query('UPDATE roles SET perm_sharing_group = 1 WHERE perm_site_admin = 1 OR perm_sync = 1');\n\t\t$orgs = array('local' => array(), 'external' => array());\n\t\t$captureRules = array(\n\t\t\t\t'events_org' => array('table' => 'events', 'old' => 'org', 'new' => 'org_id'),\n\t\t\t\t'events_orgc' => array('table' => 'events', 'old' => 'orgc', 'new' => 'orgc_id'),\n\t\t\t\t'jobs_org' => array('table' => 'jobs', 'old' => 'org', 'new' => 'org_id'),\n\t\t\t\t'servers_org' => array('table' => 'servers', 'old' => 'org', 'new' => 'org_id'),\n\t\t\t\t'servers_organization' => array('table' => 'servers', 'old' => 'organization', 'new' => 'remote_org_id'),\n\t\t\t\t'shadow_attributes_org' => array('table' => 'shadow_attributes', 'old' => 'org', 'new' => 'org_id'),\n\t\t\t\t'shadow_attributes_event_org' => array('table' => 'shadow_attributes', 'old' => 'event_org', 'new' => 'event_org_id'),\n\t\t\t\t'threads_org' => array('table' => 'threads', 'old' => 'org', 'new' => 'org_id'),\n\t\t\t\t'users_org' => array('table' => 'users', 'old' => 'org', 'new' => 'org_id'),\n\t\t);\n\t\t$rules = array(\n\t\t\t\t'local' => array(\n\t\t\t\t\t\t$captureRules['users_org'],\n\t\t\t\t),\n\t\t\t\t'external' => array(\n\t\t\t\t\t\t$captureRules['events_org'],\n\t\t\t\t\t\t$captureRules['events_orgc'],\n\t\t\t\t\t\t$captureRules['shadow_attributes_event_org'],\n\t\t\t\t\t\t$captureRules['shadow_attributes_org'],\n\t\t\t\t\t\t$captureRules['servers_organization'],\n\t\t\t\t\t\t$captureRules['threads_org'],\n\t\t\t\t\t\t$captureRules['jobs_org'],\n\t\t\t\t\t\t$captureRules['servers_org'],\n\t\t\t\t)\n\t\t);\n\t\tforeach ($rules as $k => $type) {\n\t\t\tforeach ($type as $rule) {\n\t\t\t\t$temp = ($this->query('SELECT DISTINCT(`' . $rule['old'] . '`) from `' . $rule['table'] . '` WHERE ' . $rule['new'] . '= \"\";'));\n\t\t\t\tforeach ($temp as $t) {\n\t\t\t\t\t// in case we have something in the db with a missing org, let's hop over that\n\t\t\t\t\tif ($t[$rule['table']][$rule['old']] !== '') {\n\t\t\t\t\t\tif ($k == 'local' && !in_array($t[$rule['table']][$rule['old']], $orgs[$k])) $orgs[$k][] = $t[$rule['table']][$rule['old']];\n\t\t\t\t\t\telse if ($k == 'external' && !in_array($t[$rule['table']][$rule['old']], $orgs['local']) && !in_array($t[$rule['table']][$rule['old']], $orgs[$k])) $orgs[$k][] = $t[$rule['table']][$rule['old']];\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$this->Log->create();\n\t\t\t\t\t\t$this->Log->save(array(\n\t\t\t\t\t\t\t\t'org' => 'SYSTEM',\n\t\t\t\t\t\t\t\t'model' => 'Server',\n\t\t\t\t\t\t\t\t'model_id' => 0,\n\t\t\t\t\t\t\t\t'email' => 'SYSTEM',\n\t\t\t\t\t\t\t\t'action' => 'upgrade_24',\n\t\t\t\t\t\t\t\t'user_id' => 0,\n\t\t\t\t\t\t\t\t'title' => '[ERROR] - Detected empty string organisation identifier during the upgrade',\n\t\t\t\t\t\t\t\t'change' => 'Detected entries in table `' . $rule['table'] . '` where `' . $rule['old'] . '` was blank. This has to be resolved manually!',\n\t\t\t\t\t\t));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t$this->Log->create();\n\t\t$this->Log->save(array(\n\t\t\t\t'org' => 'SYSTEM',\n\t\t\t\t'model' => 'Server',\n\t\t\t\t'model_id' => 0,\n\t\t\t\t'email' => 'SYSTEM',\n\t\t\t\t'action' => 'upgrade_24',\n\t\t\t\t'user_id' => 0,\n\t\t\t\t'title' => 'Organisation creation',\n\t\t\t\t'change' => 'Detected ' . count($orgs['local']) . ' local organisations and ' . count($orgs['external']) . ' external organisations. Starting organisation creation.',\n\t\t));\n\t\tif (Configure::read('MISP.background_jobs') && $jobId) {\n\t\t\t$this->Job->saveField('progress', 20);\n\t\t\t$this->Job->saveField('message', 'Starting organisation creation');\n\t\t}\n\t\t$orgMapping = array();\n\t\tforeach ($orgs as $k => $orgArray) {\n\t\t\tforeach ($orgArray as $org) {\n\t\t\t\t$orgMapping[$org] = $this->Organisation->createOrgFromName($org, $user_id, $k == 'local' ? true : false);\n\t\t\t}\n\t\t}\n\t\t$this->Log->create();\n\t\t$this->Log->save(array(\n\t\t\t\t'org' => 'SYSTEM',\n\t\t\t\t'model' => 'Server',\n\t\t\t\t'model_id' => 0,\n\t\t\t\t'email' => 'SYSTEM',\n\t\t\t\t'action' => 'upgrade_24',\n\t\t\t\t'user_id' => 0,\n\t\t\t\t'title' => 'Organisations created and / or mapped',\n\t\t\t\t'change' => 'Captured all missing organisations and created a mapping between the old organisation tag and the organisation IDs. ',\n\t\t));\n\t\tif (Configure::read('MISP.background_jobs') && $jobId) {\n\t\t\t$this->Job->saveField('progress', 30);\n\t\t\t$this->Job->saveField('message', 'Updating all current entries');\n\t\t}\n\t\tforeach ($orgMapping as $old => $new) {\n\t\t\tforeach ($captureRules as $rule) {\n\t\t\t\t$this->query('UPDATE `' . $rule['table'] . '` SET `' . $rule['new'] . '`=\"' . $new . '\" WHERE (`' . $rule['old'] . '`=\"' . $old . '\" AND `' . $rule['new'] . '`=\"\");');\n\t\t\t}\n\t\t}\n\t\tif (Configure::read('MISP.background_jobs') && $jobId) {\n\t\t\t$this->Job->saveField('progress', 40);\n\t\t\t$this->Job->saveField('message', 'Rebuilding all correlations.');\n\t\t}\n\t\t//$this->Attribute->generateCorrelation($jobId, 40);\n\t\t// upgrade correlations. No need to recorrelate, we can be a bit trickier here\n\t\t// Private = 0 attributes become distribution 1 for both the event and attribute.\n\t\t// For all intents and purposes, this oversimplification works fine when upgrading from 2.3\n\t\t// Even though the distribution values stored in the correlation won't be correct, they will provide the exact same realeasability\n\t\t// Event1 = distribution 0 and Attribute1 distribution 3 would lead to private = 1, so setting distribution = 0 and a_distribution = 0\n\t\t// will result in the same visibility, etc. Once events / attributes get put into a sharing group this will get recorrelated anyway\n\t\t// Also by unsetting the org field after the move the changes we ensure that these correlations won't get hit again by the script if we rerun it\n\t\t// and that we don't accidentally \"upgrade\" a 2.4 correlation\n\t\t$this->query('UPDATE correlations SET distribution = 1, a_distribution = 1 WHERE org != \"\" AND private = 0');\n\t\tforeach ($orgMapping as $old => $new) {\n\t\t\t$this->query('UPDATE correlations SET org_id = \"' . $new . '\", org = \"\" WHERE org = \"' . $old . '\";');\n\t\t}\n\t\tif (Configure::read('MISP.background_jobs') && $jobId) {\n\t\t\t$this->Job->saveField('progress', 60);\n\t\t\t$this->Job->saveField('message', 'Correlations rebuilt. Indexing all tables.');\n\t\t}\n\t\t$this->updateDatabase('indexTables');\n\t\tif (Configure::read('MISP.background_jobs') && $jobId) {\n\t\t\t$this->Job->saveField('progress', 100);\n\t\t\t$this->Job->saveField('message', 'Upgrade complete.');\n\t\t}\n\t}\n\n\t/* returns the version string of a connected instance\n\t * error codes:\n\t * 1: received non json response\n\t * 2: no route to host\n\t * 3: empty result set\n\t */\n\tpublic function getRemoteVersion($id) {\n\t\t$server = $this->find('first', array(\n\t\t\t\t'conditions' => array('Server.id' => $id),\n\t\t));\n\t\tif (empty($server)) {\n\t\t\treturn 2;\n\t\t}\n\t\tApp::uses('SyncTool', 'Tools');\n\t\t$syncTool = new SyncTool();\n\t\t$HttpSocket = $syncTool->setupHttpSocket($server);\n\t\t$response = $HttpSocket->get($server['Server']['url'] . '/servers/getVersion', $data = '', $request);\n\t\tif ($response->code == 200) {\n\t\t\ttry {\n\t\t\t\t$data = json_decode($response->body, true);\n\t\t\t} catch (Exception $e) {\n\t\t\t\treturn 1;\n\t\t\t}\n\t\t\tif (isset($data['version']) && !empty($data['version'])) {\n\t\t\t\treturn $data['version'];\n\t\t\t} else return 3;\n\t\t} return 2;\n\t}\n\n\n\t/* returns an array with the events\n\t * error codes:\n\t * 1: received non json response\n\t * 2: no route to host\n\t * 3: empty result set\n\t */\n\tpublic function previewIndex($id, $user, $passedArgs) {\n\t\t$server = $this->find('first', array(\n\t\t\t'conditions' => array('Server.id' => $id),\n\t\t));\n\t\tif (empty($server)) {\n\t\t\treturn 2;\n\t\t}\n\t\tApp::uses('SyncTool', 'Tools');\n\t\t$syncTool = new SyncTool();\n\t\t$HttpSocket = $syncTool->setupHttpSocket($server);\n\t\t$request = array(\n\t\t\t\t'header' => array(\n\t\t\t\t\t\t'Authorization' => $server['Server']['authkey'],\n\t\t\t\t\t\t'Accept' => 'application/json',\n\t\t\t\t\t\t'Content-Type' => 'application/json',\n\t\t\t\t\t\t//'Connection' => 'keep-alive' // // LATER followup cakephp issue about this problem: https://github.com/cakephp/cakephp/issues/1961\n\t\t\t\t)\n\t\t);\n\t\t$validArgs = array_merge(array('sort', 'direction'), $this->validEventIndexFilters);\n\t\t$urlParams = '';\n\t\tforeach ($validArgs as $v) {\n\t\t\tif (isset($passedArgs[$v])) $urlParams .= '/' . $v . ':' . $passedArgs[$v];\n\t\t}\n\t\t$uri = $server['Server']['url'] . '/events/index' . $urlParams;\n\t\t$response = $HttpSocket->get($uri, $data = '', $request);\n\t\tif ($response->code == 200) {\n\t\t\ttry {\n\t\t\t\t$events = json_decode($response->body, true);\n\t\t\t} catch (Exception $e) {\n\t\t\t\treturn 1;\n\t\t\t}\n\t\t\tif (!empty($events)) foreach ($events as $k => $event) {\n\t\t\t\tif (!isset($event['Orgc'])) $event['Orgc']['name'] = $event['orgc'];\n\t\t\t\tif (!isset($event['Org'])) $event['Org']['name'] = $event['org'];\n\t\t\t\tif (!isset($event['EventTag'])) $event['EventTag'] = array();\n\t\t\t\t$events[$k] = array('Event' => $event);\n\t\t\t} else return 3;\n\t\t\treturn $events;\n\t\t}\n\t\treturn 2;\n\t}\n\n\t/* returns an array with the events\n\t * error codes:\n\t * 1: received non-json response\n\t * 2: no route to host\n\t */\n\tpublic function previewEvent($serverId, $eventId) {\n\t\t$server = $this->find('first', array(\n\t\t\t\t'conditions' => array('Server.id' => $serverId),\n\t\t));\n\t\tif (empty($server)) {\n\t\t\treturn 2;\n\t\t}\n\t\tApp::uses('SyncTool', 'Tools');\n\t\t$syncTool = new SyncTool();\n\t\t$HttpSocket = $syncTool->setupHttpSocket($server);\n\t\t$request = array(\n\t\t\t\t'header' => array(\n\t\t\t\t\t\t'Authorization' => $server['Server']['authkey'],\n\t\t\t\t\t\t'Accept' => 'application/json',\n\t\t\t\t\t\t'Content-Type' => 'application/json',\n\t\t\t\t\t\t//'Connection' => 'keep-alive' // // LATER followup cakephp issue about this problem: https://github.com/cakephp/cakephp/issues/1961\n\t\t\t\t)\n\t\t);\n\t\t$uri = $server['Server']['url'] . '/events/' . $eventId;\n\t\t$response = $HttpSocket->get($uri, $data = '', $request);\n\t\tif ($response->code == 200) {\n\t\t\ttry {\n\t\t\t\t$event = json_decode($response->body, true);\n\t\t\t} catch (Exception $e) {\n\t\t\t\treturn 1;\n\t\t\t}\n\t\t\tif (!isset($event['Event']['Orgc'])) $event['Event']['Orgc']['name'] = $event['Event']['orgc'];\n\t\t\tif (isset($event['Event']['Orgc'][0])) $event['Event']['Orgc'] = $event['Event']['Orgc'][0];\n\t\t\tif (!isset($event['Event']['Org'])) $event['Event']['Org']['name'] = $event['Event']['org'];\n\t\t\tif (isset($event['Event']['Org'][0])) $event['Event']['Org'] = $event['Event']['Org'][0];\n\t\t\tif (!isset($event['Event']['EventTag'])) $event['Event']['EventTag'] = array();\n\t\t\treturn $event;\n\t\t}\n\t\treturn 2;\n\t}\n\n\t// Loops through all servers and checks which servers' push rules don't conflict with the given event.\n\t// returns the server objects that would allow the event to be pushed\n\tpublic function eventFilterPushableServers($event, $servers) {\n\t\t$eventTags = array();\n\t\t$validServers = array();\n\t\tforeach ($event['EventTag'] as $tag) $eventTags[] = $tag['tag_id'];\n\t\tforeach ($servers as $server) {\n\t\t\t$push_rules = json_decode($server['Server']['push_rules'], true);\n\t\t\tif (!empty($push_rules['tags']['OR'])) {\n\t\t\t\t$intersection = array_intersect($push_rules['tags']['OR'], $eventTags);\n\t\t\t\tif (empty($intersection)) continue;\n\t\t\t}\n\t\t\tif (!empty($push_rules['tags']['NOT'])) {\n\t\t\t\t$intersection = array_intersect($push_rules['tags']['NOT'], $eventTags);\n\t\t\t\tif (!empty($intersection)) continue;\n\t\t\t}\n\t\t\tif (!empty($push_rules['orgs']['OR'])) {\n\t\t\t\tif (!in_array($event['Event']['orgc_id'], $push_rules['orgs']['OR'])) continue;\n\t\t\t}\n\t\t\tif (!empty($push_rules['orgs']['NOT'])) {\n\t\t\t\tif (in_array($event['Event']['orgc_id'], $push_rules['orgs']['NOT'])) continue;\n\t\t\t}\n\t\t\t$validServers[] = $server;\n\t\t}\n\n\t\treturn $validServers;\n\t}\n\n\tpublic function extensionDiagnostics() {\n\t\t$results = array();\n\t\t$extensions = array('redis');\n\t\tforeach ($extensions as $extension) {\n\t\t\t$results['web']['extensions'][$extension] = extension_loaded($extension);\n\t\t}\n\t\tif (!is_readable(APP . '/files/scripts/selftest.php')) {\n\t\t\t$results['cli'] = false;\n\t\t} else {\n\t\t\t$results['cli'] = exec('php ' . APP . '/files/scripts/selftest.php');\n\t\t\t$results['cli'] = json_decode($results['cli'], true);\n\t\t}\n\t\treturn $results;\n\t}\n\n\tpublic function databaseEncodingDiagnostics(&$diagnostic_errors) {\n\t\tif (!isset($this->getDataSource()->config['encoding']) || strtolower($this->getDataSource()->config['encoding']) != 'utf8') {\n\t\t\t$diagnostic_errors++;\n\t\t\treturn false;\n\t\t}\n\t\treturn true;\n\t}\n\n\tpublic function getLatestGitRemote() {\n\t\treturn exec('timeout 3 git ls-remote https://github.com/MISP/MISP | head -1 | sed \"s/HEAD//\"');\n\t}\n\n\tpublic function getCurrentGitStatus() {\n\t\t$status = array();\n\t\t$status['commit'] = exec('git rev-parse HEAD');\n\t\t$status['branch'] = $this->getCurrentBranch();\n\t\t$status['latestCommit'] = $this->getLatestGitremote();\n\t\treturn $status;\n\t}\n\n\tpublic function getCurrentBranch() {\n\t\treturn exec(\"git symbolic-ref HEAD | sed 's!refs\\/heads\\/!!'\");\n\t}\n\n\tpublic function checkoutMain() {\n\t\t$mainBranch = '2.4';\n\t\treturn exec('git checkout ' . $mainBranch);\n\t}\n\n\tpublic function update($status) {\n\t\t$final = '';\n\t\t$command1 = 'git pull origin ' . $status['branch'] . ' 2>&1';\n\t\t$command2 = 'git submodule init && git submodule update 2>&1';\n\t\t$final = $command1 . \"\\n\\n\";\n\t\texec($command1, $output);\n\t\t$final .= implode(\"\\n\", $output) . \"\\n\\n=================================\\n\\n\";\n\t\t$output = array();\n\t\t$final .= $command2 . \"\\n\\n\";\n\t\texec($command2, $output);\n\t\t$final .= implode(\"\\n\", $output);\n\t\treturn $final;\n\t}\n\n\tpublic function getDefaultAttachments_dir() {\n\t\treturn APP . 'files';\n\t}\n\n\tpublic function fetchServer($id) {\n\t\t\tif (empty($id)) return false;\n\t\t\t$conditions = array('Server.id' => $id);\n\t\t\tif (!is_numeric($id)) {\n\t\t\t\t$conditions = array('OR' => array(\n\t\t\t\t\t'LOWER(Server.name)' => strtolower($id),\n\t\t\t\t\t'LOWER(Server.url)' => strtolower($id)\n\t\t\t\t));\n\t\t\t}\n\t\t\t$server = $this->find('first', array(\n\t\t\t\t'conditions' => $conditions,\n\t\t\t\t'recursive' => -1\n\t\t\t));\n\t\t\treturn (empty($server)) ? false : $server;\n\t\t}\n}\n"], "filenames": ["app/Controller/ServersController.php", "app/Model/Server.php"], "buggy_code_start_loc": [912, 697], "buggy_code_end_loc": [1134, 715], "fixing_code_start_loc": [911, 696], "fixing_code_end_loc": [1126, 696], "type": "CWE-78", "message": "In app/Controller/ServersController.php in MISP 2.4.87, a server setting permitted the override of a path variable on certain Red Hed Enterprise Linux and CentOS systems (where rh_shell_fix was enabled), and consequently allowed site admins to inject arbitrary OS commands. The impact is limited by the setting being only accessible to the site administrator.", "other": {"cve": {"id": "CVE-2018-6926", "sourceIdentifier": "cve@mitre.org", "published": "2018-02-12T17:29:00.323", "lastModified": "2018-03-16T14:32:09.787", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "In app/Controller/ServersController.php in MISP 2.4.87, a server setting permitted the override of a path variable on certain Red Hed Enterprise Linux and CentOS systems (where rh_shell_fix was enabled), and consequently allowed site admins to inject arbitrary OS commands. The impact is limited by the setting being only accessible to the site administrator."}, {"lang": "es", "value": "En app/Controller/ServersController.php en MISP 2.4.87, una opci\u00f3n del servidor permit\u00eda el reemplazo de una variable de ruta en ciertos sistemas Red Hed Enterprise Linux y CentOS (donde rh_shell_fix estaba habilitado) y, en consecuencia, permit\u00eda que los administradores del sitio inyectasen comandos arbitrarios del sistema operativo. El impacto es limitado debido a que la opci\u00f3n solo est\u00e1 disponible para el administrador del sitio."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "HIGH", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 7.2, "baseSeverity": "HIGH"}, "exploitabilityScore": 1.2, "impactScore": 5.9}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:S/C:C/I:C/A:C", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "SINGLE", "confidentialityImpact": "COMPLETE", "integrityImpact": "COMPLETE", "availabilityImpact": "COMPLETE", "baseScore": 9.0}, "baseSeverity": "HIGH", "exploitabilityScore": 8.0, "impactScore": 10.0, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-78"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:misp:misp:2.4.87:*:*:*:*:*:*:*", "matchCriteriaId": "9B8F46E1-52D8-4E92-B803-C2D436FAB430"}]}]}], "references": [{"url": "https://github.com/MISP/MISP/commit/0a2aa9d52492d960b9a161160acedbe9caaa4126", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/MISP/MISP/commit/0a2aa9d52492d960b9a161160acedbe9caaa4126"}}