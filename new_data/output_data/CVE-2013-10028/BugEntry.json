{"buggy_code": ["<?php\r\n/*\r\nPlugin Name: EELV Newsletter\r\nPlugin URI: http://ecolosites.eelv.fr\r\nDescription:  Add a registration form on frontOffice, a newsletter manager on BackOffice\r\nVersion: 3.3.1\r\nAuthor: bastho, ecolosites // EELV\r\nAuthor URI: http://ecolosites.eelv.fr\r\nLicense: CC BY-NC v3.0\r\nText Domain: eelv_lettreinfo\r\nDomain Path: /languages/\r\n*/\r\n\r\nload_plugin_textdomain( 'eelv_lettreinfo', false, 'eelv-newsletter/languages' );\r\n    \r\n\t\r\n  // ID for DB version\r\n  $eelv_newsletter_version = '2.6.5';\r\n  $newsletter_tb_name = 'eelv_'.$wpdb->blogid. '_newsletter_adr';\r\n  global $wpdb, $eelv_nl_default_themes, $eelv_nl_content_themes, $lettreinfo_plugin_path, $newsletter_plugin_url;\r\n  $newsletter_plugin_url = plugins_url();\r\n  $lettreinfo_plugin_path=WP_PLUGIN_DIR.'/'.str_replace( basename( __FILE__), \"\", plugin_basename(__FILE__) );\r\n  $eelv_nl_content_themes=array();\r\n  $eelv_nl_default_themes=array();\r\n  $newsletter_sql = \"CREATE TABLE \" . $newsletter_tb_name . \" (\r\n    `id` mediumint(9) NOT NULL AUTO_INCREMENT,\r\n    `parent` mediumint(9) DEFAULT 0 NOT NULL,\r\n    `nom` VARCHAR(255) DEFAULT '' NOT NULL,\r\n    `email` VARCHAR(255) DEFAULT '' NOT NULL,\r\n    PRIMARY KEY  (`id`)\r\n    );\";\r\n  \r\n  function eelv_nl_infos(){\r\n\t\t__('Add a registration form on frontOffice, a newsletter manager on BackOffice','eelv_lettreinfo');\r\n\t\t__('EELV Newsletter','eelv_lettreinfo');\r\n   }\r\n  /* INSTALLATION DES TABLES  */\r\n  function eelvnewsletter_install() {\r\n    global $eelv_newsletter_version,$newsletter_tb_name,$newsletter_sql;\r\n    require_once(ABSPATH . 'wp-admin/includes/upgrade.php');\r\n    dbDelta($newsletter_sql);\r\n    add_option('eelv_newsletter_version', $eelv_newsletter_version);\r\n  }\r\n  // UPDATE PLUGIN\r\n  $installed_ver = get_option( \"eelv_newsletter_version\" );\r\n  if( $installed_ver != $eelv_newsletter_version ) {\r\n    require_once(ABSPATH . 'wp-admin/includes/upgrade.php');\r\n    dbDelta($newsletter_sql);\r\n    update_option( 'eelv_newsletter_version', $eelv_newsletter_version );\r\n  }\r\n  // WP 3.1 patch upgrade\r\n  function eelvnewsletter_update_db_check() {\r\n    global $eelv_newsletter_version;\r\n    if (get_option('eelv_newsletter_version') != $eelv_newsletter_version) {\r\n      update_option( 'eelv_newsletter_version', $eelv_newsletter_version );\r\n      eelvnewsletter_install();\r\n    }\r\n  }\r\n  if(false===$wpdb->query('SELECT `id` FROM '.$newsletter_tb_name.' LIMIT 0,1') ){\r\n    eelvnewsletter_install();\r\n  }\r\n  // FONCTIONS\r\n  add_action( 'admin_enqueue_scripts', 'eelv_nl_my_admin_enqueue_scripts' );\r\n  function eelv_nl_my_admin_enqueue_scripts() {\r\n    if ( 'newsletter_archive' == get_post_type() )\r\n      wp_dequeue_script( 'autosave' );\r\n  }\r\n  function newsletter_BO(){\r\n    global $eelv_nl_content_themes,$eelv_nl_default_themes, $newsletter_plugin_url,$lettreinfo_plugin_path;\r\n    \r\n    register_post_type('newsletter', array(  'label' => 'Newsletter','description' => '','public' => true,'show_ui' => true,'show_in_menu' => true,'capability_type' => 'post','hierarchical' => false,'rewrite' => array('slug' => ''),'query_var' => true,'has_archive' => true,'supports' => array('title','editor','author'),'menu_icon'=>plugin_dir_url( __FILE__ ).'img/mail.png','labels' => array (\r\n      'name' => __(\"Newsletter\",'eelv_lettreinfo'),\r\n      'singular_name' => __(\"Newsletter\",'eelv_lettreinfo'),\r\n      'menu_name' => __(\"Newsletter\",'eelv_lettreinfo'),\r\n      'add_new' => __('add','eelv_lettreinfo'),\r\n      'add_new_item' => __('Add','eelv_lettreinfo'),\r\n      'edit' => __('Edit','eelv_lettreinfo'),\r\n      'edit_item' => __('Edit','eelv_lettreinfo'),\r\n      'new_item' => __('New','eelv_lettreinfo'),\r\n      'view' => __('View','eelv_lettreinfo'),\r\n      'view_item' => __('View newsletter','eelv_lettreinfo'),\r\n      'search_items' => __('Search','eelv_lettreinfo'),\r\n      'not_found' => __('No newsletter Found','eelv_lettreinfo'),\r\n      'not_found_in_trash' => __('No newsletter Found in Trash','eelv_lettreinfo'),\r\n      'parent' => __('Parent newsletter','eelv_lettreinfo'),\r\n    ),) );\r\n    register_post_type(\r\n      'newsletter_template', array(  'label' => 'Mod&egrave;les','description' => '','public' => true,'show_ui' => true,'show_in_menu' => false,'capability_type' => 'post','hierarchical' => false,'rewrite' => array('slug' => ''),'query_var' => true,'has_archive' => true,'supports' => array('title','editor','revisions'),'show_in_menu' => 'edit.php?post_type=newsletter','labels' => array (\r\n        'name' => __('Skin','eelv_lettreinfo'),\r\n        'singular_name' => __('Skin','eelv_lettreinfo'),\r\n        'menu_name' => __('Skins','eelv_lettreinfo'),\r\n        'add_new_item' => __('Add','eelv_lettreinfo'),\r\n        'edit' => __('Edit','eelv_lettreinfo'),\r\n        'edit_item' => __('Edit','eelv_lettreinfo'),\r\n        'new_item' => __('New','eelv_lettreinfo'),\r\n        'view' => __('View','eelv_lettreinfo'),\r\n        'view_item' => __('View','eelv_lettreinfo'),\r\n        'search_items' => __('Search','eelv_lettreinfo'),\r\n        'not_found' => __('No template Found','eelv_lettreinfo'),\r\n        'not_found_in_trash' => __('No template Found in Trash','eelv_lettreinfo'),\r\n        'parent' => __('Parent template','eelv_lettreinfo'),\r\n      ),) );\r\n    register_post_type('newsletter_archive', array(  'label' => 'Archives','description' => '','public' => true,'show_ui' => true,'show_in_menu' => false,'capability_type' => 'post','hierarchical' => false,'rewrite' => array('slug' => ''),'query_var' => true,'has_archive' => true,'supports' => array('title','editor'),'show_in_menu' => 'edit.php?post_type=newsletter','labels' => array (\r\n      'name' => __('Archives','eelv_lettreinfo'),\r\n      'singular_name' => __('Archive','eelv_lettreinfo'),\r\n      'menu_name' => __('Archives','eelv_lettreinfo'),\r\n      'add_new_item' => __('Add','eelv_lettreinfo'),\r\n      'edit' => __('Edit','eelv_lettreinfo'),\r\n      'edit_item' => __('Edit archive','eelv_lettreinfo'),\r\n      'new_item' => __('New archive','eelv_lettreinfo'),\r\n      'view' => __('View','eelv_lettreinfo'),\r\n      'view_item' => __('Preview archive','eelv_lettreinfo'),\r\n      'search_items' => __('Search an archive','eelv_lettreinfo'),\r\n      'not_found' => __('No entry has been made','eelv_lettreinfo'),\r\n      'not_found_in_trash' => __('No archive Found in Trash','eelv_lettreinfo'),\r\n      'parent' => __('Parent archive','eelv_lettreinfo'),\r\n    ),) );\r\n    require_once($lettreinfo_plugin_path.'/templates.php');\r\n  }\r\n  // ADD NEW COLUMN  \r\n  function lettreinfo_columns_head($defaults) {  \r\n    $defaults['envoyer'] = __('Send','eelv_lettreinfo');  \r\n    return $defaults;  \r\n  }  \r\n  // COLUMN CONTENT  \r\n  function lettreinfo_columns_content($column_name, $post_ID) {  \r\n    if ($column_name == 'envoyer') {  \r\n      $my_temp=get_post(get_post_meta(get_the_ID(), 'nl_template',true));\r\n      if(get_the_ID()!=0 && get_the_title()!='' && get_the_content()!=''  && $my_temp){\r\n        echo $my_temp->post_title;\r\n        echo '<br/><a href=\"edit.php?post_type=newsletter&page=news_envoi&post='.get_the_ID().'\">'.__('Preview and send','eelv_lettreinfo').'</a>';\r\n      }\r\n      else{\r\n        echo __('Not ready yet...','eelv_lettreinfo');\r\n      }  \r\n    }  \r\n  }\r\n  // ADD NEW COLUMN (ARCHIVES) \r\n  function lettreinfo_archives_columns_head($defaults) {  \r\n    $defaults['queue'] = __('Queue','eelv_lettreinfo'); \r\n    $defaults['sent'] = __('Sent','eelv_lettreinfo');  \r\n    $defaults['read'] = __('Readen','eelv_lettreinfo');  \r\n    return $defaults;  \r\n  }  \r\n  // COLUMN CONTENT  (ARCHIVES) \r\n  function lettreinfo_archives_columns_content($column_name, $post_ID) {  \r\n    if ($column_name == 'queue') {  \r\n      $dest = get_post_meta($post_ID, 'destinataires',true);\r\n      echo abs(substr_count($dest,',')); \r\n    }\r\n    if ($column_name == 'sent') {  \r\n      $sent = get_post_meta($post_ID, 'sentmails',true);\r\n      echo abs(substr_count($sent,',')); \r\n    }  \r\n    if ($column_name == 'read') {  \r\n      $spy = get_post_meta($post_ID, 'nl_spy',true);\r\n\t  if($spy==1){\r\n\t\t  $sent = get_post_meta($post_ID, 'sentmails',true);\r\n\t\t  $lus = abs(substr_count($sent,':3'));\r\n\t\t  $tot = abs(substr_count($sent,','));\r\n\t\t  echo $lus.' ('.round($lus/$tot*100).'%)'; \r\n\t  }\r\n\t  else{\r\n\t\t _e('deactivated','eelv_lettreinfo'); \r\n\t  }\r\n    }  \r\n  }\r\n  /* Adds a box to the main column on the Post and Page edit screens */\r\n  function newsletter_add_custom_box() {\r\n    add_meta_box( \r\n      'news-carnet-adresse',\r\n      __( \"Edit tools\", 'eelv_lettreinfo' ),\r\n      'newsletter_admin',\r\n      'newsletter' \r\n    );\r\n    add_meta_box( \r\n      'news-envoi-edit',\r\n      __( \"Send\", 'eelv_lettreinfo' ),\r\n      'newsletter_admin_prev',\r\n      'newsletter',\r\n      'side' \r\n    );\r\n    add_meta_box( \r\n      'news-convert-post',\r\n      __( \"Send as newsletter\", 'eelv_lettreinfo' ),\r\n      'news_transform',\r\n      'post',\r\n      'side' \r\n    ); \r\n    add_meta_box( \r\n      'news-archive_viewer',\r\n      __( \"Preview\", 'eelv_lettreinfo' ),\r\n      'newsletter_archive_admin',\r\n      'newsletter_archive' \r\n    );\r\n    add_meta_box( \r\n      'news-archive_viewerdest',\r\n      __( \"Recipients\", 'eelv_lettreinfo' ),\r\n      'newsletter_archive_admin_dest',\r\n      'newsletter_archive' \r\n    );\r\n    add_meta_box( \r\n      'news-archive_viewerqueue',\r\n      __( \"Queue\", 'eelv_lettreinfo' ),\r\n      'newsletter_archive_admin_queue',\r\n      'newsletter_archive' \r\n    ); \r\n  }\r\n  // Ajout du menu et sous menu\r\n  function eelv_news_ajout_menu() {\r\n  \tadd_submenu_page('edit.php?post_type=newsletter', __('Adress book', 'eelv_lettreinfo' ), __('Adress book', 'eelv_lettreinfo' ), 'manage_options', 'news_carnet_adresse', 'news_carnet_adresse');\r\n    add_submenu_page('edit.php?post_type=newsletter', __('Send', 'eelv_lettreinfo' ), __('Send', 'eelv_lettreinfo' ), 'manage_options', 'news_envoi', 'news_envoi');\r\n    add_submenu_page('edit.php?post_type=newsletter', __('Configuration/help', 'eelv_lettreinfo' ), __('Configuration/help', 'eelv_lettreinfo' ), 'manage_options', 'newsletter_page_configuration', 'newsletter_page_configuration');\r\n    add_submenu_page('edit.php?post_type=newsletter', __('Reload parameters', 'eelv_lettreinfo' ), __('Reload parameters', 'eelv_lettreinfo' ), 'manage_options', 'newsletter_checkdb', 'newsletter_checkdb');\r\n  }\r\n  // Ajout du menu d'option sur le r&eacute;seau\r\n  function eelv_news_ajout_network_menu() {\r\n    add_submenu_page('settings.php', __('Newsletter', 'eelv_lettreinfo' ), __('Newsletter', 'eelv_lettreinfo' ), 'Super Admin', 'newsletter_network_configuration', 'newsletter_network_configuration');\r\n    //add_submenu_page('tpe', 'Historique', 'Historique', 'Super Admin', 'eelv_tpe_liste', 'tpe_supercommandes_liste');    \r\n  }\r\n  function get_news_meta($id){\r\n    global $wpdb,$newsletter_tb_name ;\r\n    $ret =  $wpdb->get_results(\"SELECT * FROM `$newsletter_tb_name` WHERE `id`='$id'\");\r\n    if(is_array($ret) && sizeof($ret)>0){\r\n      return $ret[0];  \r\n    }\r\n    return false;\r\n  }\r\n  \r\n  add_shortcode( 'nl_date' , 'nl_short_date' );\r\n  function nl_short_date(){\r\n  \treturn date_i18n(get_option('date_format'));\r\n  }\r\n  \r\n  add_shortcode( 'desinsc_url' , 'nl_short_desinsc' );  \r\n  function nl_short_desinsc(){\r\n    $desinsc_url = get_option( 'newsletter_desinsc_url' );\r\n  \treturn '<a href=\"'.$desinsc_url.'\" target=\"_blank\" class=\"nl_a\">'.$desinsc_url.'</a>';\r\n  }\r\n  function nl_content($post_id,$type='newsletter'){\r\n    $nl =  get_post($post_id); \r\n    $content=$nl->post_content;\r\n    $template =  get_post(get_post_meta($post_id,'nl_template',true)); \r\n    if($template){\r\n      $content= str_replace('[newsletter]',$content,$template->post_content);\r\n    }\r\n     \r\n    $return  = apply_filters('the_content',$content);\r\n\tif($return=='' && $content!=''){\r\n\t\t$return=$content;\r\n\t\t$desinsc_url = get_option( 'newsletter_desinsc_url' );\r\n\t\t$return= str_replace('[nl_date]',date_i18n(get_option('date_format')),$return);\r\n    \t$return=str_replace('[desinsc_url]',\"<a href='\".$desinsc_url.\"' target='_blank' class='nl_a'>\".$desinsc_url.\"</a>\",$return);\r\n\t} \r\n    return $return;\r\n  }\r\n  function eelv_newsletter_sharelinks($title,$link){\r\n\t\treturn \"<div style='width:550px; margin:0px;text-align:left; clear:both;font-size:9px; '><span style='display:block;float:left;padding:2px;padding-left:10px;padding-right:10px;background:#888;color:#FFF;'>\".__('Share on : ', 'eelv_lettreinfo' ).\"</span><a href='http://www.facebook.com/sharer.php?u=\".urlencode($link).\"&t=\".$title.\"' target='_blank' style='display:block;float:left;padding:2px;padding-left:10px;padding-right:10px;background:#3B5998;color:#FFF;'>Facebook</a><a href='https://twitter.com/intent/tweet?text=\".$title.\"%20\".urlencode($link).\"' target='_blank' style='display:block;float:left;padding:2px;padding-left:10px;padding-right:10px;background:#2BB7EA;color:#FFF;'>Twitter</a><a href='https://plus.google.com/share?url=\".urlencode($link).\"' target='_blank' style='display:block;float:left;padding:2px;padding-left:10px;padding-right:10px;background:#DB4B39;color:#FFF;'>Google+</a><a href='http://www.linkedin.com/shareArticle?mini=true&url=\".urlencode($link).\"&title=\".$title.\"' target='_blank' style='display:block;float:left;padding:2px;padding-left:10px;padding-right:10px;background:#0073B2;color:#FFF;'>Linked in</a></div>&nbsp;\\n\";\t\r\n }\r\n  /////////////////////////////////////////////FEUILLE DE STYLE + VALIDATION FORMULAIRE\r\n  function style_newsletter(){\r\n    global $wpdb,$newsletter_tb_name,$newsletter_plugin_url,$news_reg_return;\r\n    ?>\r\n<link rel=\"stylesheet\" type=\"text/css\" media=\"all\" href=\"<?=plugins_url( 'newsletter.css' , __FILE__ )?>\" />\r\n<?php\r\n    $query='';\r\n    if(isset($_POST['news_email'])){\r\n      $email = stripslashes($_POST['news_email']);\r\n      if (filter_var($email, FILTER_VALIDATE_EMAIL)) {\r\n      \t\r\n\t\t\r\n\t  $msg = get_option( 'newsletter_msg' ,array(\r\n\t\t'sender'=>'' ,\r\n\t\t'suscribe_title'=>'' ,\r\n\t\t'suscribe'=>'' ,\r\n\t\t'unsuscribe_title'=>'' ,\r\n\t\t'unsuscribe'=>'' \r\n\t\t));\t  \r\n\t  $sender = $msg['sender'];\r\n\t  $suscribe_title = $msg['suscribe_title'];\r\n\t  $suscribe = $msg['suscribe'];\r\n\t  $unsuscribe_title = $msg['unsuscribe_title'];\r\n\t  $unsuscribe = $msg['unsuscribe'];\r\n\t  \r\n        switch($_POST['news_action']){\r\n          case '1':\r\n            $ret =  $wpdb->get_results(\"SELECT * FROM `$newsletter_tb_name` WHERE `email`='\".str_replace(\"'\",\"''\",$email).\"'\");\r\n            if(is_array($ret) && sizeof($ret)>0){\r\n              $ret = $ret[0];\r\n              if($ret->parent==2){\r\n                $query=\"UPDATE $newsletter_tb_name SET `parent`='1' WHERE `email`='\".str_replace(\"'\",\"''\",$email).\"'\";\r\n                if($query!='' && false===$wpdb->query($query)){\r\n                  $news_reg_return.=__(\"An error occured !\", 'eelv_lettreinfo') ;\r\n                }\r\n                elseif($query!=''){\r\n                  $news_reg_return=__(\"You have been successfully re-registered\", 'eelv_lettreinfo');  \r\n\t\t\t\t  if(!empty($sender) && !empty($suscribe_title) && !empty($suscribe)){\r\n\t\t\t\t  \tmail($email,$suscribe_title,$suscribe,'From:'.$sender);\r\n\t\t\t\t  }              \r\n                }                \r\n              }\r\n              else{\r\n                $news_reg_return.=__(\"Your email is already registered in our mailing-list.\", 'eelv_lettreinfo') ;\r\n              }\r\n            }\r\n            else{\r\n              $query=\"INSERT INTO $newsletter_tb_name (`parent`,`nom`,`email`) \r\n                VALUES (1,'\".str_replace(\"'\",\"''\",substr($email,0,strpos($email,'@'))).\"','\".str_replace(\"'\",\"''\",$email).\"')\";\r\n              if($query!='' && false==$wpdb->query($query)){\r\n                $news_reg_return.=__(\"An error occured !\", 'eelv_lettreinfo');\r\n              }\r\n              elseif($query!=''){\r\n                $news_reg_return.=__(\"Thank you for your suscription\", 'eelv_lettreinfo');   \r\n\t\t\t\tif(!empty($sender) && !empty($suscribe_title) && !empty($suscribe)){\r\n\t\t\t\t  \tmail($email,$suscribe_title,$suscribe,'From:'.$sender);\r\n\t\t\t\t  }             \r\n              }\r\n            }\r\n            break;\r\n          case '0':\r\n            $ret =  $wpdb->get_results(\"SELECT * FROM `$newsletter_tb_name` WHERE `email`='\".str_replace(\"'\",\"''\",$email).\"'\");\r\n            if(is_array($ret) && sizeof($ret)>0){\r\n              $query=\"UPDATE $newsletter_tb_name SET `parent`='2' WHERE `email`='\".str_replace(\"'\",\"''\",$email).\"'\";\r\n              if($query!='' && false===$wpdb->query($query)){\r\n                $news_reg_return.=__(\"An error occured !\", 'eelv_lettreinfo');\r\n              }\r\n              elseif($query!=''){\r\n                $news_reg_return.=__(\"Thank you, your email have been deleted from our mailing-list\", 'eelv_lettreinfo'); \r\n\t\t\t\t  if(!empty($sender) && !empty($unsuscribe_title) && !empty($unsuscribe)){\r\n\t\t\t\t  \tmail($email,$unsuscribe_title,$unsuscribe,'From:'.$sender);\r\n\t\t\t\t  }                \r\n              }  \r\n            }\r\n            else{\r\n              $news_reg_return.=__(\"Your email does'nt appear in our mailing list. No unsuscribe needed\", 'eelv_lettreinfo');\r\n            }\r\n            break;\r\n         }\r\n      }\r\n      else{\r\n        $news_reg_return.= strip_tags($email).' : '.__('invalid address', 'eelv_lettreinfo');\r\n      }\r\n    }\r\n  }\r\n  ////////////////////////////////////////////////////////////////////////////////////////////////////// FRONT OFFICE\r\n  function get_news_form($id=''){\r\n    global $wpdb,$newsletter_tb_name,$newsletter_plugin_url,$news_reg_return;\r\n\t$eelv_li_xs_archives = get_option('eelv_li_xs_archives',0);\r\n    ?>\r\n<form action=\"#\" method=\"post\" id=\"newsform<?=$id?>\" class=\"newsform\" onsubmit=\"if(this.news_email.value=='' || this.news_email.value=='newsletter : votre email'){ return false; }\">\r\n  <div>\r\n    <label class=\"screen-reader-text\" for=\"news_email<?=$id?>\"><?=__('Suscribe our newsletter', 'eelv_lettreinfo')?></label>\r\n    <input type=\"text\" name=\"news_email\" id=\"news_email<?=$id?>\" value=\"\" placeholder=\"newsletter : votre email\" onfocus=\"document.getElementById('news_hidden_option<?=$id?>').style.display='block';\"/>\r\n    <input type=\"submit\" value=\"ok\"/>        \r\n    <div id='news_hidden_option<?=$id?>' class='news_hidden_option'>\r\n      <label for='news_option_1<?=$id?>'><input type=\"radio\" name='news_action' value='1' id='news_option_1<?=$id?>' checked=\"checked\"/><?=__(\"Suscribe\", 'eelv_lettreinfo')?></label>\r\n      <label for='news_option_2<?=$id?>'><input type=\"radio\" name='news_action' value='0'  id='news_option_2<?=$id?>'/> <?=__(\"Unsuscribe\", 'eelv_lettreinfo')?></label>\r\n      <?php if($eelv_li_xs_archives==0){ ?>\r\n      <p><a href=\"/newsletter_archive/\"><?=__(\"Last newsletters\", 'eelv_lettreinfo')?></a></p>\r\n      <?php } ?>\r\n    </div>\r\n    <?php if($news_reg_return!=''){?>\r\n    <div class='news_return' id='news_return<?=$id?>' onclick=\"document.getElementById('news_return<?=$id?>').style.display='none';\">\r\n      <?=$news_reg_return?>\r\n    </div>            \r\n    <?php }  ?>\r\n  </div>\r\n</form>\r\n<?php\r\n  }\r\n\r\n/** Reply form **/\r\n/*\r\nadd_shortcode( 'eelv_news_answer' , 'eelv_get_news_answer_form' );\r\nfunction eelv_get_news_answer_form(){\r\n\tglobal $wpdb,$newsletter_tb_name,$newsletter_plugin_url,$news_reg_return;\r\n\tif(isset($_GET['v'])){\r\n\t\t$vien = $_GET['v'];\r\n\t\t$mail = $_GET['m'];\r\n\t\t$da = date(\"d/m/Y H:i\");\r\n\t\t$news = urldecode($_GET['n']);\r\n\t\tif($object==''){\r\n\t\t\t$object=\"Invitation inconnue\";\r\n\t\t}\r\n\t\techo'<h1>'.$object.'</h1>';\r\n\t\tif(ereg(\"@\",$mail) && $mail!=\"\" ){\r\n\t\t\t$fp = fopen('../results/hvsl.csv','a+');\r\n\t\t\tif(fwrite($fp,$object.';'.$mail.';'.$da.';'.$vien.';')){\r\n\t\t\t\techo'\r\n\t\t\t\t<h2>Votre r&eacute;ponse a bien &eacute;t&eacute; enregistr&eacute;e</h2>\r\n\t\t\t\t<p>'.$mail.' : '.$vien.'</p>';\r\n\t\t\t}\r\n\t\t\tfclose($fp);\r\n\t\t}\r\n\t\telse{\r\n\t\t\t\techo\"<form action='./' method='get'>\r\n\t\t\t\t<FONT color='#FF0066' size='3'>\r\n\t\t\t\t<input type='hidden' name='vien' value='$vien'><input type='hidden' name='object' value='$object'>\r\n\t\t\t\tS'il vous plait, renseignez votre adresse mail : <input type='text' name='mail' value=''>\r\n\t\t\t\t<input type='submit' value='ok'>\r\n\t\t\t\t</form><br><br><br>\r\n\t\t\t\t\";\r\n\t\t\t}\r\n\t}\r\n\telse{\r\n\t\techo\"$mail<br>D&eacute;sol&eacute; nous n'avons pas compris votre requete...\";\r\n\t}\r\n}\r\n*/\r\n\r\n/** Inscription form **/\r\nadd_shortcode( 'eelv_news_form' , 'get_news_large_form' );\r\n  function get_news_large_form(){\r\n    global $wpdb,$newsletter_tb_name,$newsletter_plugin_url,$news_reg_return;\r\n    $ret='\r\n      <form action=\"#\" method=\"post\" id=\"newslform\" onsubmit=\"if(this.news_email.value==\"\" || this.news_email.value==\"newsletter : votre email\"){ return false; }\">\r\n      <div>\r\n      <p>\r\n      <label for=\"news_l_email\">'.__('Your email:', 'eelv_lettreinfo').'</label>\r\n      <input type=\"text\" name=\"news_email\" id=\"news_l_email\" value=\"\" />\r\n      </p>        \r\n      <p>\r\n      <label for=\"news_l_option_1\">\r\n      <input type=\"radio\" name=\"news_action\" value=\"1\" id=\"news_l_option_1\" checked=\"checked\"/> '.__(\"Suscribe\", 'eelv_lettreinfo').'\r\n      </label>\r\n      </p>\r\n      <p>        \r\n      <label for=\"news_l_option_2\">\r\n      <input type=\"radio\" name=\"news_action\" value=\"0\"  id=\"news_l_option_2\"/> '.__('Unsuscribe', 'eelv_lettreinfo').'\r\n      </label>\r\n      </p>\r\n      <p><input type=\"submit\" value=\"'.__('ok', 'eelv_lettreinfo').'\"/></p>';\r\n    if($news_reg_return!=''){\r\n      $ret.='<div class=\"news_retour\">'.$news_reg_return.'</div>';            \r\n    }\r\n    $ret.='\r\n      <p><a href=\"/newsletter_archive/\">'.__(\"Last newsletters\", 'eelv_lettreinfo').'</a></p>\r\n      </div>\r\n      </form>';\r\n    return $ret;\r\n  }\r\n  ////////////////////////////////////////////////////////////////////////////////////////////////////// BACK OFFICE\r\n  function news_liste_groupes(){\r\n    global $newsletter_tb_name,$wpdb;\r\n    //newsletter_checkdb();\r\n    $querystr = \"SELECT `id`,`nom` FROM `$newsletter_tb_name` WHERE `parent`='0' ORDER BY `nom`\";\r\n    return $wpdb->get_results($querystr);  \r\n  }\r\n  function news_liste_contacts($groupe,$fields='`id`,`nom`,`email`'){\r\n    global $newsletter_tb_name,$wpdb;\r\n    if(is_array($groupe)){\r\n      $groupe = implode(\"' OR `parent`='\",$groupe);\r\n    }\r\n    $querystr = \"SELECT $fields FROM `$newsletter_tb_name` WHERE `parent`='$groupe' GROUP BY `email`ORDER BY `nom`\";\r\n    return $wpdb->get_results($querystr);    \r\n  }\r\n  /*****************************************************************************************************************************************\r\n  A D R E S S E S                                                           \r\n  *****************************************************************************************************************************************/\r\n  function news_carnet_adresse(){\r\n    global $newsletter_tb_name,$wpdb,$newsletter_plugin_url;\r\n    style_newsletter();\r\n    //newsletter_checkdb();\r\n    ?>\r\n<div class=\"wrap\">\r\n  <div id=\"icon-edit\" class=\"icon32 icon32-posts-newsletter\"><br/></div>\r\n  <h2><?=__(\"Newsletter\",'eelv_lettreinfo')?></h2>\r\n  <script>\r\n    function changegrp(form,url,grpname){\r\n      is_confirmed = confirm(\"<?php _e('Do you really want to move selected contacts to :', 'eelv_lettreinfo' ) ?> \"+grpname+\" ?\");\r\n      if (is_confirmed) {\r\n        form.action=url;\r\n        form.submit();\r\n      }  \r\n    }\r\n    function confsup(url,action){\r\n      is_confirmed = confirm(\"<?php _e('Do you really want to remove selected contacts ?', 'eelv_lettreinfo' ) ?>\");\r\n      if (is_confirmed) {\r\n        if(action==1){\r\n          document.location=url;\r\n        }\r\n        if(action==2){\r\n          url.submit();\r\n        }\r\n      }\r\n    }\r\n    function tout(ou,ki){\r\n      chs = ou.getElementsByTagName('input');\r\n      chi = ki.checked;\r\n      for(i=0 ; i<chs.length ; i++){\r\n        if(chs[i].type=='checkbox'){\r\n          chs[i].checked=chi;\r\n        }\r\n      }\r\n    }\r\n  </script>\r\n  <table class=\"widefat\" style=\"margin-top: 1em;\">\r\n    <thead>\r\n      <tr>\r\n        <th scope=\"col\" colspan=\"2\"><?php _e('Adress book', 'eelv_lettreinfo' ) ?></th>\r\n      </tr>\r\n    </thead>\r\n    <tbody>\r\n      <tr>\r\n        <td>\r\n          <?php\r\n  $for='liste';\r\n    $for2='liste';\r\n    $grp_id='';\r\n    $con_id='';\r\n    // Suppression de groupe\r\n    if(isset($_GET['delgroupe'])){\r\n      $for='liste';\r\n      $grp_id = $_GET['delgroupe'];\r\n      $query=\"DELETE FROM $newsletter_tb_name WHERE `id`='$grp_id' OR `parent`='$grp_id'\";\r\n      if(false===$wpdb->query($query)){\r\n        ?><div class=\"updated\"><p><strong><?php _e('An error occured, no group has been deleted !', 'eelv_lettreinfo' ) ?></strong></p></div><?php\r\n  }\r\n  else{\r\n  ?><div class=\"updated\"><p><strong><?php _e('Successful deletion !', 'eelv_lettreinfo' ) ?></strong></p></div><?php\r\n  }\r\n  $grp_id='';\r\n      }\r\n      // Supression de contacts\r\n      if(isset($_GET['delcontacts']) && isset($_GET['liste'])){\r\n        $grp_id = $_GET['liste'];\r\n        $MBRS = news_liste_contacts($grp_id);    \r\n        if(sizeof($MBRS)>0){\r\n          $ac = '`id`=0';\r\n          $nb=0;\r\n          foreach($MBRS as $contact){ \r\n            if(isset($_POST['contact_'.$contact->id])){\r\n              $ac.=' OR `id`='.$contact->id;\r\n              $nb++;\r\n            }\r\n          }\r\n          $query=\"DELETE FROM $newsletter_tb_name WHERE $ac\";\r\n          if(false===$wpdb->query($query)){\r\n            ?><div class=\"updated\"><p><strong><?php _e('An error occured, no contact has been deleted !', 'eelv_lettreinfo' ) ?></strong></p></div><?php\r\n  }\r\n  else{\r\n  ?><div class=\"updated\"><p><strong><?php printf(__('%s contacts deleted !', 'eelv_lettreinfo' ),$nb) ?></strong></p></div><?php\r\n  }\r\n  }\r\n  }\r\n  // deplacement de contacts\r\n  if(isset($_GET['ngrp']) && isset($_GET['liste'])){\r\n  $grp_id = $_GET['liste'];\r\n            $MBRS = news_liste_contacts($grp_id);    \r\n            if(sizeof($MBRS)>0){\r\n              $ac = '`id`=0';\r\n              $nb=0;\r\n              foreach($MBRS as $contact){ \r\n                if(isset($_POST['contact_'.$contact->id])){\r\n                  $ac.=' OR `id`='.$contact->id;\r\n                  $nb++;\r\n                }\r\n              }\r\n              $query=\"UPDATE $newsletter_tb_name SET `parent`='\".str_replace(\"'\",\"''\",$_GET['ngrp']).\"' WHERE $ac\";\r\n              if(false===$wpdb->query($query)){\r\n                ?><div class=\"updated\"><p><strong><?php _e('An error occured, no contact has been moved !', 'eelv_lettreinfo' ) ?></strong></p></div><?php\r\n  }\r\n  else{\r\n  ?><div class=\"updated\"><p><strong><?php printf(__('%s contacts succesfully moved !', 'eelv_lettreinfo' ),$nb) ?></strong></p></div><?php\r\n  }\r\n  }\r\n  }\r\n  if(isset($_GET['groupe'])){\r\n  $for='groupe';  \r\n                $grp_id = $_GET['groupe'];\r\n              }\r\n              if(isset($_GET['liste'])){\r\n                $for='liste';  \r\n                $grp_id = $_GET['liste'];\r\n              }  \r\n              if(isset($_GET['contact'])){\r\n                $for2='contact';  \r\n                $con_id = $_GET['contact'];\r\n              }\r\n              if(isset($_POST['grp_nom']) ){\r\n                $grp_nom = stripslashes($_POST['grp_nom']);\r\n                if(is_numeric($grp_id)){\r\n                  $query=\"UPDATE $newsletter_tb_name SET `nom`='\".str_replace(\"'\",\"''\",$grp_nom).\"' WHERE `id`='$grp_id'\";\r\n                }\r\n                else{\r\n                  $query=\"INSERT INTO $newsletter_tb_name (`nom`) VALUES ('\".str_replace(\"'\",\"''\",$grp_nom).\"')\";\r\n                }\r\n                if(false===$wpdb->query($query)){\r\n                  ?><div class=\"updated\"><p><strong><?php _e('An error occured...', 'eelv_lettreinfo' ) ?></strong></p></div><?php\r\n  }\r\n  else{\r\n  $for='liste';\r\n                  ?><div class=\"updated\"><p><strong><?php _e('Record saved', 'eelv_lettreinfo' ); ?></strong></p></div><?php      \r\n                }    \r\n              }\r\n              if(isset($_POST['con_nom']) && is_numeric($grp_id)  ){\r\n                $con_nom = stripslashes($_POST['con_nom']);\r\n                $con_email = stripslashes($_POST['con_email']);\r\n                if(is_numeric($con_id)){\r\n                  $query=\"UPDATE $newsletter_tb_name SET `nom`='\".str_replace(\"'\",\"''\",$con_nom).\"',`email`='\".str_replace(\"'\",\"''\",$con_email).\"' WHERE `id`='$con_id'\";\r\n                }\r\n                else{\r\n                  switch($_POST['import_type']){\r\n                    case 'unite':\r\n                      $query=\"INSERT INTO \".$newsletter_tb_name.\" (`parent`,`nom`,`email`) \r\n                        VALUES ('$grp_id','\".str_replace(\"'\",\"''\",$con_nom).\"','\".str_replace(\"'\",\"''\",$con_email).\"')\";\r\n                      break;\r\n                    case 'masse':\r\n                      $imp = preg_split('/[,;\\n\\t]/',stripslashes($_POST['con_mul'].','));\r\n                      $query='INSERT INTO '.$newsletter_tb_name.' (`parent`,`nom`,`email`) VALUES ';\r\n                      foreach($imp as $entry){\r\n                        $entry=trim($entry);\r\n                        if (filter_var($entry, FILTER_VALIDATE_EMAIL)) {\r\n                          $query.=\"              \r\n                            ('$grp_id','\".str_replace(\"'\",\"''\",substr($entry,0,strpos($entry,'@'))).\"','\".str_replace(\"'\",\"''\",$entry).\"'),\";\r\n                        }\r\n                        elseif($entry!=''){\r\n                          echo\"<p>$entry : adresse non valide</p>\";  \r\n                        }\r\n                      }\r\n                      $query = substr($query,0,-1);\r\n                      $query.=\"\";\r\n                      break;\r\n                    case 'file':\r\n                      ?><div class=\"updated\"><p><strong><?php _e('Functionality under development', 'eelv_lettreinfo' ) ?></strong></p></div><?php\r\n  break;\r\n                                              }\r\n                }\r\n                if($query!='' && false===$wpdb->query($query)){\r\n                  ?><div class=\"updated\"><p><strong><?php _e('An error occured !', 'eelv_lettreinfo' ) ?></strong></p></div><?php\r\n  }\r\n  elseif($query!=''){\r\n  ?><div class=\"updated\"><p><strong><?php _e('Record saved', 'eelv_lettreinfo' ); ?></strong></p></div><?php\r\n                }    \r\n                $for2='liste';\r\n                $for ='liste';  \r\n              }\r\n              // Edition de groupe\r\n              if($for=='groupe'){\r\n                $grp_nom = 'Nouveau groupe';\r\n                $action=\"edit.php?post_type=newsletter&page=news_carnet_adresse&groupe=new\";\r\n                if(is_numeric($grp_id)){\r\n                  $news_info = get_news_meta($grp_id);\r\n                  $grp_nom = $news_info->nom;\r\n                  $action=\"edit.php?post_type=newsletter&page=news_carnet_adresse&groupe=$grp_id\";\r\n                }\r\n                ?>\r\n          <?php _e('Edit group', 'eelv_lettreinfo' ) ?>\r\n          <form action='<?=$action;?>' method=\"post\">\r\n            <div id=\"titlediv\">\r\n              <div id=\"titlewrap\">               \r\n                <input type=\"text\" name=\"grp_nom\" size=\"30\" tabindex=\"1\" value=\"<?=$grp_nom;?>\" id=\"title\" autocomplete=\"off\"/>                \r\n              </div>\r\n              <input type='submit' value='<?php _e('Save options', 'eelv_lettreinfo' ) ?>' class=\"button-primary\"/>\r\n            </div>\r\n          </form>\r\n          <p>    <a href=\"edit.php?post_type=newsletter&page=news_carnet_adresse\" class=\"button add-new-h2\"><?php _e('cancel', 'eelv_lettreinfo' ) ?></a></p>\r\n          <?php\r\n  }\r\n  if($for=='liste'){\r\n  ////////////////////////////////////////////////////////////Listes\r\n  if(!is_numeric($grp_id)){ // groupes\r\n  $GRPS = news_liste_groupes();    \r\n                $nb_groups = sizeof($GRPS);\r\n                ?><h3 class=\"sectiontitle title3\"><?php _e('Groups', 'eelv_lettreinfo' ) ?></h3>  <a href=\"edit.php?post_type=newsletter&page=news_carnet_adresse&groupe=new\" class=\"button add-new-h2\"><?php _e('New group', 'eelv_lettreinfo' ) ?></a>    <?php\r\n  if($nb_groups>0){?>  \r\n          <table class='eelv_news_groups'>   \r\n            <?php\r\n  $coup=false;\r\n                foreach($GRPS as $groupe){ \r\n                  $nbinsc = sizeof(news_liste_contacts($groupe->id));                \r\n                  ?>      \r\n            <tr>\r\n              <td><a href='edit.php?post_type=newsletter&page=news_carnet_adresse&liste=<?=$groupe->id?>'><b><?=$groupe->nom?></b></a></td>\r\n              <td><b><?=$nbinsc?></b></td>\r\n              <td><a href='edit.php?post_type=newsletter&page=news_carnet_adresse&liste=<?=$groupe->id?>' class=\"button\"><?php _e('List', 'eelv_lettreinfo' ) ?></a></td>\r\n              <td><a href='edit.php?post_type=newsletter&page=news_carnet_adresse&groupe=<?=$groupe->id?>' class=\"button\"><?php _e('Rename', 'eelv_lettreinfo' ) ?></a></td>\r\n              <td><a onclick=\"confsup('edit.php?post_type=newsletter&page=news_carnet_adresse&delgroupe=<?=$groupe->id?>',1)\" class=\"button\"><?php _e('Delete', 'eelv_lettreinfo' ) ?></a></td>\r\n            </tr>      \r\n            <?php }  ?>\r\n          </table>\r\n          <?php\r\n  }\r\n  ?><p>&nbsp;</p><?php\r\n  }\r\n  else{ // contacts\r\n  $news_info = get_news_meta($grp_id);\r\n                  $grp_nom = $news_info->nom;\r\n                  $MBRS = news_liste_contacts($grp_id);    \r\n                  $nb_contacts = sizeof($MBRS);\r\n                  ?>\r\n          <h3 class=\"sectiontitle title3\"><a href='edit.php?post_type=newsletter&page=news_carnet_adresse'><?php _e('Groups', 'eelv_lettreinfo' ) ?></a> > <?=$grp_nom?></h3>  \r\n          <?php  \r\n  if($for2=='liste'){ // liste contact\r\n  ?>\r\n          <table class='eelv_news_groups'><tr><td>\r\n            <input type=\"checkbox\" onclick=\"tout(document.getElementById('liste_mel'),this)\"/>\r\n            <select onchange=\"eval(this.value)\">\r\n              <option value=\"\"><?php _e('Bulk actions', 'eelv_lettreinfo' ) ?></option>\r\n              <?php\r\n  $GRPS = news_liste_groupes();    \r\n                  $nb_groups = sizeof($GRPS);\r\n                  if($nb_groups>0){\r\n                    foreach($GRPS as $groupe){ \r\n                      if($groupe->id !=$grp_id){\r\n                        $nbinsc = sizeof(news_liste_contacts($groupe->id));                \r\n                        ?>      \r\n              <option value=\"changegrp(document.getElementById('liste_mel'),'edit.php?post_type=newsletter&page=news_carnet_adresse&liste=<?=$grp_id?>&ngrp=<?=$groupe->id?>','<?=$groupe->nom?>')\"><?php _e('Move to : ', 'eelv_lettreinfo' ) ?> <?=$groupe->nom?></option>\r\n              <?php } } }  ?>\r\n              <option value=\"confsup(document.getElementById('liste_mel'),2)\"><?php _e('Delete', 'eelv_lettreinfo' ) ?></option>\r\n            </select>\r\n            <a href='edit.php?post_type=newsletter&page=news_carnet_adresse' class=\"button\"><?php _e('Back', 'eelv_lettreinfo' ) ?></a>\r\n            <a href='edit.php?post_type=newsletter&page=news_carnet_adresse&liste=<?=$grp_id?>&contact=new' class=\"button-primary\"><?php _e('New recipient', 'eelv_lettreinfo' ) ?></a>\r\n            </td></tr></table>\r\n          <?php\r\n  if($nb_contacts>0){?>                \r\n          <form id='liste_mel' action=\"edit.php?post_type=newsletter&page=news_carnet_adresse&liste=<?=$grp_id?>&delcontacts\" method=\"post\">\r\n            <table class='eelv_news_groups'> \r\n              <?php\r\n  $coup=false;\r\n                        foreach($MBRS as $contact){ ?>      \r\n              <tr>\r\n                <td><input type=\"checkbox\" name=\"contact_<?=$contact->id?>\" value=\"1\" /></td>\r\n                <td><a href='edit.php?post_type=newsletter&page=news_carnet_adresse&liste=<?=$grp_id?>&contact=<?=$contact->id?>'><b><?=$contact->nom?></b></a></td>                         <td><a href='edit.php?post_type=newsletter&page=news_carnet_adresse&liste=<?=$grp_id?>&contact=<?=$contact->id?>'><b><?=$contact->email?></b></a></td>                       \r\n              </tr>      \r\n              <?php }  ?>\r\n            </table>\r\n          </form>\r\n          <?php\r\n                      }\r\n                      else{\r\n                         _e('No recipient have been selected', 'eelv_lettreinfo' ); \r\n                      }\r\n                      ?>\r\n          <?php\r\n                    }\r\n                    else{ // edit contact\r\n                      $con_nom = '';\r\n                      $action=\"edit.php?post_type=newsletter&page=news_carnet_adresse&liste=$grp_id&contact=new\";\r\n                      if(is_numeric($con_id)){\r\n                        $news_info = get_news_meta($con_id);\r\n                        $con_nom = $news_info->nom;\r\n                        $con_email = $news_info->email;\r\n                        $action=\"edit.php?post_type=newsletter&page=news_carnet_adresse&groupe=$grp_id&contact=$con_id\";\r\n                      }\r\n                      ?>  \r\n          <form action='<?=$action;?>' method=\"post\" enctype=\"multipart/form-data\">              \r\n            <ul>\r\n              <li>\r\n                <label for=\"imp_unite\">\r\n                  <h3><input type=\"radio\" name=\"import_type\" value='unite' id='imp_unite' checked=\"checked\" /> <?php _e('Edit contact', 'eelv_lettreinfo' ) ?></h3>\r\n                  <?php _e('Name', 'eelv_lettreinfo' ) ?>            \r\n                  <input type=\"text\" name=\"con_nom\" size=\"30\" value=\"<?=$con_nom;?>\" id=\"con_nom\" autocomplete=\"off\" onfocus=\"import_type[0].checked=true\"/>  \r\n                  <?php _e('E-mail', 'eelv_lettreinfo' ) ?>               \r\n                  <input type=\"email\" name=\"con_email\" size=\"30\" value=\"<?=$con_email;?>\" id=\"con_email\" autocomplete=\"off\" onfocus=\"import_type[0].checked=true\"/>\r\n                </label>\r\n              </li>\r\n              <?php if(!is_numeric($con_id)){ ?>\r\n              <li>\r\n                <label for=\"imp_masse\">\r\n                  <h3><input type=\"radio\" name=\"import_type\" value='masse' id='imp_masse' /> <?php _e('Mass copy', 'eelv_lettreinfo' ) ?></h3>\r\n                  <p><?php _e('Return separated email address', 'eelv_lettreinfo' ) ?></p>                       \r\n                  <textarea cols=\"50\" rows=\"10\" name=\"con_mul\" id=\"con_mul\" onfocus=\"import_type[1].checked=true\"></textarea>\r\n                </label> \r\n              </li>\r\n              <!--li>\r\n              <label for=\"imp_file\">\r\n              <h3><input type=\"radio\" name=\"import_type\" value='file' id='imp_file' /> Importer fichier csv</h3>\r\n              <p>Export depuis votre carnet d'adresse habituel... </p>\r\n              <input type='file'  accept=\"text/csv,text/plain\" name=\"con_file\" id=\"con_file\" onfocus=\"import_type[2].checked=true\"/>\r\n            </label>\r\n            </li-->                \r\n              <?php } ?>\r\n            </ul>\r\n            <a href='edit.php?post_type=newsletter&page=news_carnet_adresse&liste=<?=$grp_id?>' class=\"button\">Retour</a>\r\n            <input type=\"submit\" value='Enregistrer' class=\"button-primary\" />\r\n          </form>\r\n          <?php\r\n  }\r\n  }\r\n  }\r\n  ?>\r\n        </td></tr></tbody></table>\r\n</div>\r\n<?php\r\n  }\r\n  /*****************************************************************************************************************************************\r\n  E N V O I                                                                  \r\n  *****************************************************************************************************************************************/\r\n  function news_envoi(){\r\n  style_newsletter();\r\n                      //newsletter_checkdb();\r\n                      global $newsletter_tb_name,$wpdb,$newsletter_plugin_url;\r\n                      $default_exp = get_option( 'newsletter_default_exp' );\r\n                      $default_mel = get_option( 'newsletter_default_mel' );\r\n                      $desinsc_url = get_option( 'newsletter_desinsc_url' );\r\n                      ?>\r\n<div class=\"wrap\">\r\n  <div id=\"icon-edit\" class=\"icon32 icon32-posts-newsletter\"><br/></div>\r\n  <h2><?php _e('Newsletter', 'eelv_lettreinfo' ) ?></h2>\r\n  <table class=\"widefat\" style=\"margin-top: 1em;\">\r\n    <thead>\r\n      <tr>\r\n        <th scope=\"col\" colspan=\"2\">Envoi</th>\r\n      </tr>\r\n    </thead>\r\n    <tbody>\r\n      <tr>\r\n        <td>    \r\n          <?php\r\n  if(!isset($_GET['post']) || !is_numeric($_GET['post'])){\r\n  /////////////////////////////////// CHOIX DE LA LETTRE\r\n  $querystr = \"SELECT `ID`,`post_title` FROM `$wpdb->posts` WHERE `post_status` = 'publish' AND `post_type` = 'newsletter' ORDER BY `post_name`\";\r\n                      $res = $wpdb->get_results($querystr,ARRAY_N);\r\n                      if(sizeof($res)>0){\r\n                        ?><ul><?php\r\n                        foreach($res as $item){\r\n                          ?><li><a href=\"edit.php?post_type=newsletter&page=news_envoi&post=<?=$item[0]?>\"><?=$item[1]?></a></li><?php\r\n                        }\r\n                        ?></ul><?php    \r\n                      }\r\n                      else{\r\n                        ?>\r\n          <?php _e('No letter is in progress. to create one', 'eelv_lettreinfo' ) ?> <a href=\"post-new.php?post_type=newsletter\" class=\"button\"><?php _e('click here', 'eelv_lettreinfo' ) ?></a>\r\n          <?php    \r\n  }\r\n  }\r\n  else{\r\n  \t\t\t\t\t\t\t$post_id = $_GET['post'];\r\n                        $post = get_post( $post_id );\r\n                        if(isset($_GET['convert']) && is_numeric($_GET['convert'])){\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t$content=$post->post_content;\r\n\t\t\t\t\t\t\tif(isset($_GET['add_title'])){\r\n\t\t\t\t\t\t\t\t$content='<h1>'.$post->post_title.'</h1>'.$content;\t\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tif(isset($_GET['add_sharelinks'])){\r\n\t\t\t\t\t\t\t\t$content.=eelv_newsletter_sharelinks($post->post_title,$post->guid);\t\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\r\n                          if(0!== $new_post = wp_insert_post( array('post_type'=>'newsletter','post_title' => $post->post_title,  'post_content' => $content,  'post_status' => 'publish'))){\r\n                            add_post_meta($new_post, 'nl_template', $_GET['convert']);\r\n                            $post_id=$new_post;        \r\n                            $post = get_post( $new_post);\r\n                            echo\"Une lettre d'info a &eacute;t&eacute; cr&eacute;&eacute;e\";\r\n                          }\r\n                          else{\r\n                            echo \"Erreur de converstion...\";  \r\n                          }\r\n                        }\r\n                        if(isset($_GET['settemplate']) && is_numeric($_GET['settemplate'])){\r\n\t\t\t\t\t\t\tupdate_post_meta($post->ID,'nl_template',$_GET['settemplate']);\r\n\t\t\t\t\t\t}\r\n                        $content=nl_content($post_id); \r\n\t\t\t\t\t\t\r\n\r\n                        $template_id = get_post_meta($post->ID,'nl_template',true);\r\n                        /*$post = get_post( $post_id);\r\n                        $template =  get_post(get_post_meta($post_id,'nl_template',true));\r\n                        $content=str_replace('[newsletter]',(trim($post->post_content)),$template->post_content);\r\n                        $content=str_replace('[desinsc_url]',\"<a href='$desinsc_url' target='_blank' class='nl_a'>$desinsc_url</a>\",$content);\r\n                        */  \r\n                        if(!isset($_POST['send']) ){\r\n                          $user_info = get_userdata(get_current_user_id());\r\n                          /////////////////////////////////// CHOIX DES DESTINATAIRES\r\n                          ?>\r\n          <h3 class=\"sectiontitle title3\"><?php _e('Preview', 'eelv_lettreinfo' ) ?></h3>\r\n          <div class='eelv_news_frame' id=\"nl_preview\">\r\n            <?php\r\n  echo $content;\r\n                          ?></div>\r\n          <a href=\"post.php?post=<?=$post_id?>&action=edit\" class=\"button\"><?php _e('Edit', 'eelv_lettreinfo' ) ?></a> \r\n          <?php _e('Skin', 'eelv_lettreinfo' ) ?>: \r\n          <select name=\"newslettertemplate\" onchange=\"document.location='edit.php?post_type=newsletter&page=news_envoi&post=<?=$post_id?>&settemplate='+this.value+'#nl_preview';\">\r\n          \t<?php\r\n  $querystr = \"SELECT `ID` FROM $wpdb->posts WHERE post_status = 'publish' AND post_type = 'newsletter_template' ORDER BY `post_title`\";\r\n                      $IDS = $wpdb->get_col($querystr);  \r\n                      $templates_nb = sizeof($IDS);\r\n\r\n                      if($templates_nb>0){\r\n                        $my_temp=get_post_meta(get_the_ID(), 'nl_template',true);\r\n                        foreach($IDS as $item_id){ \r\n                          if($my_temp==NULL){\r\n                            add_post_meta(get_the_ID(), 'nl_template', $item_id);\r\n                            $my_temp=$item_id;\r\n                          }\r\n                          ?>\r\n    <option value=\"<?=$item_id;?>\" <?php if($item_id==$template_id){ echo' selected ';} ?>/> <?=get_the_title($item_id);?></option> \r\n      <?php }\r\n                      }\r\n                      ?>\r\n          </select>             \r\n          <form action=\"edit.php?post_type=newsletter&page=news_envoi&post=<?=$post_id?>#nl_preview\" method=\"post\" class='eelv_news'>\r\n            <input type=\"hidden\" name=\"send\" value=\"1\" />\r\n            <table><tr>\r\n              <td>\r\n                <h3 class=\"sectiontitle title3\"><?php _e('Headers', 'eelv_lettreinfo' ) ?></h3>\r\n                <p><label for=\"sujet\"><?php _e('Subject', 'eelv_lettreinfo' ) ?>               \r\n                  <input type=\"text\" name=\"eelv_news_sujet\" size=\"30\" tabindex=\"1\" value=\"<?=$post->post_title?>\" id=\"sujet\" autocomplete=\"off\" required/></label> </p>\r\n                <p><label for=\"exp\"><?php _e('Sender name', 'eelv_lettreinfo' ) ?>              \r\n                  <input type=\"text\" name=\"eelv_news_exp\" size=\"30\" tabindex=\"1\" value=\"<?=$default_exp?>\" id=\"exp\" autocomplete=\"off\" required/></label> </p>\r\n                <p><label for=\"mel\"><?php _e('Reply email', 'eelv_lettreinfo' ) ?>         \r\n                  <input type=\"email\" name=\"eelv_news_mel\" size=\"30\" tabindex=\"1\" value=\"<?=$default_mel?>\" id=\"mel\" autocomplete=\"off\" required/></label></p>\r\n                <p><label for=\"stat\"><?php _e('Archive stat', 'eelv_lettreinfo' ) ?>            \r\n                  <select name=\"eelv_news_stat\" id=\"stat\" required>\r\n                    <option value='publish'><?php _e('Published', 'eelv_lettreinfo' ) ?></option>\r\n                    <option value='private'><?php _e('private', 'eelv_lettreinfo' ) ?></option>\r\n                  </select>\r\n                  </label> </p>\r\n                 <p><label for=\"spy\"><?php _e('Reading tracking', 'eelv_lettreinfo' ) ?>            \r\n                  <select name=\"eelv_news_spy\" id=\"spy\" required>\r\n                    <option value='1'><?php _e('try to know if emails is readen', 'eelv_lettreinfo' ) ?></option>\r\n                    <option value='0'><?php _e('deactivated', 'eelv_lettreinfo' ) ?></option>\r\n                  </select>\r\n                  </label> </p>\r\n              </td>\r\n              <td>\r\n                <h3 class=\"sectiontitle title3\"><?php _e('Recipients', 'eelv_lettreinfo' ) ?></h3>\r\n                <table><tr>\r\n                  <td>\r\n                    <h4><?php _e('Groups', 'eelv_lettreinfo' ) ?></h4>                  \r\n                    <ul class='eelv_news_groups'>   \r\n                      <?php      \r\n  $GRPS = news_liste_groupes();\r\n                          foreach($GRPS as $groupe){ \r\n                            $nbinsc = sizeof(news_liste_contacts($groupe->id));        \r\n                            ?>      \r\n                      <li>\r\n                        <label  for='grp_<?=$groupe->id?>'>\r\n                          <input type=\"checkbox\" name='grp_<?=$groupe->id?>' id='grp_<?=$groupe->id?>' value='1'/>\r\n                          <b><?=$groupe->nom?></b>\r\n                          <i>(<?=$nbinsc?>)</i>\r\n                        </label>\r\n                      </li>      \r\n                      <?php }  ?>\r\n                    </ul>\r\n                  </td>\r\n                  <td>\r\n                    <h4><?php _e('blog users', 'eelv_lettreinfo' ) ?></h4>\r\n                    <ul class='eelv_news_groups'> \r\n                      <?php  \r\n  $result = count_users();\r\n                          foreach($result['avail_roles'] as $role => $count){        \r\n                            ?>      \r\n                      <li>\r\n                        <label  for='rol_<?=$role?>'>\r\n                          <input type=\"checkbox\" name='rol_<?=$role?>' id='rol_<?=$role?>' value='1'/>\r\n                          <b><?=__($role)?></b>\r\n                          <i>(<?=$count?>)</i>\r\n                        </label>\r\n                      </li>      \r\n                      <?php }  ?>\r\n                    </ul>\r\n                  </td>\r\n                  <td>\r\n                    <h4><?php _e('Additional recipients', 'eelv_lettreinfo' ) ?></h4>                  \r\n                    <textarea name=\"dests\" cols=\"30\" rows=\"5\"><?php echo $user_info->user_email; ?></textarea> \r\n\t\t\t\t\t<legend><?php _e('Return separated email address', 'eelv_lettreinfo' ) ?></legend>\r\n                  </td>\r\n                  </tr></table>\r\n              </td></tr></table>\r\n            <input type='submit' value='<?php _e( \"Send\", 'eelv_lettreinfo' ) ?>' class=\"button-primary\"/>\r\n          </form>\r\n          <?php\r\n  }\r\n  else{\r\n  /////////////////////////////////// ENVOI\r\n  $contacts='';\r\n                          // CUSTOM GROUPES\r\n                          $dest = array();\r\n                          $GRPS = news_liste_groupes();\r\n                          foreach($GRPS as $groupe){ \r\n                            if(isset($_POST['grp_'.$groupe->id])){\r\n                              array_push($dest,$groupe->id);\r\n                            }\r\n                          }\r\n                          $temp = news_liste_contacts($dest,'email');        \r\n                          foreach($temp as $contact){\r\n                            $contacts.=$contact->email.',';  \r\n                          }\r\n                          // USERS\r\n                          $result = count_users();\r\n                          foreach($result['avail_roles'] as $role => $count){\r\n                            if(isset($_POST['rol_'.$role])){\r\n                              $blogusers = get_users('blog_id='.$wpdb->blogid.'&orderby=nicename&role=$role');\r\n                              foreach ($blogusers as $user) {\r\n                                $contacts.=$user->user_email.',';\r\n                              }\r\n                            }\r\n                          }\r\n                          // UNITE\r\n                          $temp = preg_split('/[;,\\n\\t]/',$_POST['dests']);\r\n                          foreach($temp as $contact){\r\n                            if(trim($contact)!=''){\r\n                              $contacts.=trim($contact).',';  \r\n                            }\r\n                          }\r\n                          $contacts=implode(',',array_unique(explode(',',$contacts)));\r\n                          if(0=== $archive = wp_insert_post( array('post_type'=>'newsletter_archive','post_title' => $post->post_title,  'post_content' => $post->post_content,  'post_status' => $_POST['eelv_news_stat']))){\r\n                            echo __(\"An error occured !\",'eelv_lettreinfo');\r\n                          }\r\n                          else{\r\n                            add_post_meta($archive, 'sujet', $_POST['eelv_news_sujet']);\r\n                            add_post_meta($archive, 'nl_template', $template_id);\r\n                            add_post_meta($archive, 'expediteur', $_POST['eelv_news_exp']);\r\n                            add_post_meta($archive, 'reponse', $_POST['eelv_news_mel']);\r\n                            add_post_meta($archive, 'destinataires', $contacts);\r\n                            add_post_meta($archive, 'sentmails', '');\r\n                            add_post_meta($archive, 'lastsend', date('Y-m-d H:i:s'));\r\n                            add_post_meta($archive, 'nl_spy', $_POST['eelv_news_spy']);\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t  \r\n                            /* $my_postu = array(\r\n                            'post_title' => $post->post_title,\r\n                            'post_content' => $post->post_content,\r\n                            'post_type' => 'newsletter'\r\n                            );\r\n                            // Update the post into the database\r\n                            wp_update_post( $my_postu );*/\r\n                            echo __('Sending...','eelv_lettreinfo').\"\r\n                              <script>\r\n                              document.location='edit.php?post_type=newsletter_archive';\r\n                              </script>\r\n                              \".__(\"To view the delivery status, please go to\",'eelv_lettreinfo').\"\r\n                              <a href='edit.php?post_type=newsletter_archive'>\".__('archives','eelv_lettreinfo').\"</a>\r\n                              \";\r\n                          }\r\n                        }\r\n                      }\r\n                      ?>\r\n        </td></tr></tbody></table>\r\n</div>\r\n<?php  \r\n                    }\r\n                    function newsletter_save_postdata( $post_id ) {\r\n                      if ( defined( 'DOING_AUTOSAVE' ) && DOING_AUTOSAVE )      return;\r\n                      if ( isset($_REQUEST['newslettertemplate']) && $_REQUEST['newslettertemplate']!=''){\r\n                        update_post_meta($post_id, 'nl_template', $_REQUEST['newslettertemplate']);\r\n                      }\r\n                    } \r\n                    function newsletter_admin_prev() {\r\n                      $my_temp=get_post(get_post_meta(get_the_ID(), 'nl_template',true));\r\n                      $env=true;\r\n                      if(get_the_ID()==0){\r\n                        $env=false;\r\n                        echo\"<p>\".__(\"Your newsletter has'nt been saved yet\",'eelv_lettreinfo').\"</p>\";\r\n                      }\r\n                      if(get_the_title()==''){\r\n                        $env=false;\r\n                        echo\"<p>\".__(\"Your newsletter has no title\",'eelv_lettreinfo').\"</p>\";\r\n                      }\r\n                      if(!$my_temp){\r\n                        $env=false;\r\n                        echo\"<p>\".__(\"No skin applied\",'eelv_lettreinfo').\"</p>\";\r\n                      }\r\n                      if($env==true){\r\n                        echo'<p><a href=\"edit.php?post_type=newsletter&page=news_envoi&post='.get_the_ID().'#nl_preview\" class=\"button-primary\">'.__('Preview and send','eelv_lettreinfo').'</a></p>';\r\n                      }\r\n                    }\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n                    function newsletter_admin() {\r\n                      global $wpdb, $eelv_nl_content_themes;\r\n                      //newsletter_checkdb();\r\n                      //print_r($eelv_nl_content_themes);\r\n                      ?>\r\n<table><tr>\r\n  <td valign=\"top\">\r\n    <h4><?php _e('Skin', 'eelv_lettreinfo' ) ?></h4>\r\n    <?php\r\n  $querystr = \"SELECT `ID` FROM $wpdb->posts WHERE post_status = 'publish' AND post_type = 'newsletter_template' ORDER BY `post_title`\";\r\n                      $IDS = $wpdb->get_col($querystr);  \r\n                      $templates_nb = sizeof($IDS);\r\n\r\n                      if($templates_nb>0){\r\n                        $my_temp=get_post_meta(get_the_ID(), 'nl_template',true);\r\n                        foreach($IDS as $item_id){ \r\n                          if($my_temp==NULL){\r\n                            add_post_meta(get_the_ID(), 'nl_template', $item_id);\r\n                            $my_temp=$item_id;\r\n                          }\r\n                          ?>\r\n    <p><label for='nt_<?=$item_id;?>' onclick=\"set_default_content('dc_<?=$item_id;?>')\"><input type='radio' name='newslettertemplate' id='nt_<?=$item_id;?>' value='<?=$item_id;?>' <?php if($item_id==$my_temp){ echo' checked=checked ';} ?>/> <?=get_the_title($item_id);?></label><textarea id=\"dc_<?=$item_id;?>\" style=\"display:none;\"><?=$eelv_nl_content_themes[get_the_title($item_id)]?></textarea></p> \r\n      <?php }\r\n                      }\r\n                      ?>\r\n      </td><td valign=\"top\" style='padding-left:20px'>\r\n      <h4><?php _e('Insert some content', 'eelv_lettreinfo' ) ?></h4>\r\n      <script>\r\n        var IEbof=false;\r\n      </script>\r\n      <!--[if lt IE 9]>\r\n      <script>IEbof=true;</script>\r\n      <![endif]-->\r\n      <script>\r\n        function incontent(str){\r\n          if(IEbof){\r\n            switchEditors.go('content', 'html');\r\n            document.post.content.value+=str;\r\n            switchEditors.go('content', 'tinymce');\r\n          }\r\n          else{\r\n            document.post.content.value+=str;\r\n            if (document.all) {\r\n              value = str;\r\n              document.getElementById('content_ifr').name='content_ifr';\r\n              var ec_sel = document.getElementById('content_ifr').document.selection;\r\n              if(tinyMCE.activeEditor.selection){\r\n                tinyMCE.activeEditor.selection.setContent(str);\r\n              }\r\n              else if(tinyMCE.activeEditor){\r\n                tinyMCE.activeEditor.execCommand(\"mceInsertRawHTML\", false, str);\r\n              }\r\n              else if (ec_sel) {\r\n                var ec_rng = ec_sel.createRange();\r\n                ec_rng.pasteHTML(value);\r\n              }\r\n              else{\r\n              }\r\n            }\r\n            else{\r\n              document.getElementById('content_ifr').name='content_ifr';\r\n              if(document.content_ifr){\r\n                document.content_ifr.document.execCommand('insertHTML', false, str);\r\n              }\r\n              else if(document.getElementById('content_ifr').contentDocument){\r\n                document.getElementById('content_ifr').contentDocument.execCommand('insertHTML', false, str);\r\n              }\r\n              else if(tinyMCE.activeEditor.selection){\r\n                tinyMCE.activeEditor.selection.setContent(str);\r\n              }\r\n              else{\r\n                tinyMCE.activeEditor.execCommand(\"mceInsertRawHTML\", false, str);\r\n              }\r\n            }  \r\n          }\r\n        }\r\n        function set_default_content(ki){\r\n          ki = document.getElementById(ki);\r\n          if(ki.value && ki.value!=''){\r\n            if(confirm(\"<?php __('Do you want to load this skin\\'s default content ?\\n\\nWarning!\\n\\nYou will loose the current content.', 'eelv_lettreinfo' ) ?>\")){\r\n              str=ki.value;\r\n              switchEditors.go('content', 'html');\r\n              document.post.content.value=str;\r\n              switchEditors.go('content', 'tinymce');  \r\n            }\r\n          }\r\n        }\r\n      </script>\r\n      <?php\r\n  $querystr = \"\";\r\n                      $optis='<option value=\"\">'.__('Posts', 'eelv_lettreinfo' ).'</option>';\r\n                      wp_reset_query();\r\n                      query_posts(array('status'=>'publish','post_type'=>'post','posts_per_page'=>'-1'));\r\n                      if(have_posts()){  \r\n                        while(have_posts()){\r\n                          the_post();  \r\n                          ?>\r\n      <textarea id=\"nl_post_<?php the_ID();?>\" style=\"display:none\"><?php echo\"<div style='width:550px; margin:5px 0px;text-align:left;  clear:both; border-top:#CCC 1px dotted; padding-top:1em; margin-top:1em;'>\r\n  <a href='\".get_post_permalink().\"' style='text-decoration:none;color:#666666;'>\".get_the_post_thumbnail(get_the_ID(),array(550,100),array('style'=>'float:left; margin-right:10px;')).\"</a> <h3 style='margin:0px !important;'><a href='\".get_post_permalink().\"' style='text-decoration:none;color:#000000;'>\".get_the_title().\"</a></h3>\r\n  <a href='\".get_post_permalink().\"' style='text-decoration:none;color:#666666;'>\".substr(strip_tags(get_the_content()),0,300).\"...</a>\r\n  </div>&nbsp;\r\n  \"; ?></textarea>\r\n      <textarea id=\"nl_share_<?php the_ID();?>\" style=\"display:none\"><?php echo eelv_newsletter_sharelinks(get_the_title(),get_post_permalink()); ?></textarea>\r\n      <?php \r\n                          $optis.='<option value=\"'.get_the_ID().'\">'.substr(get_the_title(),0,70).'</option>';\r\n                        } ?> \r\n      <p><select name=\"nl_insert_post\" onchange=\"var nl_p_content=getElementById('nl_post_'+this.value).value; if(document.getElementById('nl_with_share').checked==true){nl_p_content+=getElementById('nl_share_'+this.value).value}incontent(nl_p_content);this.value=''\">\r\n        <?=$optis?>\r\n        </select>\r\n      </p>\r\n      <?php  }\r\n                      \r\n                      $optis='<option value=\"\">'.__('Pages', 'eelv_lettreinfo' ).'</option>';\r\n                      wp_reset_query();\r\n                      query_posts(array('status'=>'publish','post_type'=>'page','posts_per_page'=>'-1'));\r\n                      if(have_posts()){  \r\n                        while(have_posts()){\r\n                          the_post();  \r\n                          ?>\r\n      <textarea id=\"nl_page_<?php the_ID();?>\" style=\"display:none\"><?php echo\"<div style='width:550px; margin:5px 0px;text-align:left;  clear:both; border-top:#CCC 1px dotted; padding-top:1em; margin-top:1em;'>\r\n  <a href='\".get_post_permalink().\"' style='text-decoration:none;color:#666666;'>\".get_the_post_thumbnail(get_the_ID(),array(550,100),array('style'=>'float:left; margin-right:10px;')).\"</a> <h3 style='margin:0px !important;'><a href='\".get_post_permalink().\"' style='text-decoration:none;color:#000000;'>\".get_the_title().\"</a></h3>\r\n  <a href='\".get_post_permalink().\"' style='text-decoration:none;color:#666666;'>\".substr(strip_tags(get_the_content()),0,300).\"...</a>\r\n  </div>&nbsp;\r\n  \"; ?></textarea>\r\n      \r\n      <?php \r\n                          $optis.='<option value=\"'.get_the_ID().'\">'.substr(get_the_title(),0,70).'</option>';\r\n                        } ?> \r\n      <p><select name=\"nl_insert_page\" onchange=\"incontent(getElementById('nl_page_'+this.value).value);this.value=''\">\r\n        <?=$optis?>\r\n        </select></p>\r\n      <?php  }\r\n                      ?>\r\n      <label for=\"\">\r\n        <input type=\"checkbox\" id=\"nl_with_share\" checked=\"checked\"/><?=__('Add share links', 'eelv_lettreinfo' )?>\r\n      </label>\r\n      </td></tr></table>\r\n      <?php\r\n                    }\r\n                    function newsletter_archive_admin() {\r\n                      global $wpdb,$newsletter_plugin_url;\r\n                      $post_id = get_the_ID(); //$_GET['id'];\r\n                      $my_temp=get_post_meta($post_id, 'nl_template',true);\r\n                      $sujet = get_post_meta($post_id, 'sujet', true);\r\n                      $expediteur = get_post_meta($post_id, 'expediteur', true);\r\n                      $reponse = get_post_meta($post_id, 'reponse' ,true);\r\n                      $lastsend = get_post_meta($post_id, 'lastsend',true);  \r\n                      // $post = get_post( $post_id);\r\n                      $template =  get_post(get_post_meta($post_id,'nl_template',true));\r\n                      $content=nl_content($post_id );   ?>\r\n      <h2><?=$sujet?></h2>\r\n      <?php if(!$template){ ?>\r\n      <?php _e('The skin has gone away ! Do you want to apply another one ?', 'eelv_lettreinfo' ) ?>\r\n      <select name=\"newslettertemplate\">\r\n        <option></option>\r\n        <?php\r\n  $querystr = \"SELECT `ID` FROM $wpdb->posts WHERE post_status = 'publish' AND post_type = 'newsletter_template' ORDER BY `post_title`\";\r\n$IDS = $wpdb->get_col($querystr);  \r\n$templates_nb = sizeof($IDS);\r\nif($templates_nb>0){\r\n  $my_temp=get_post_meta(get_the_ID(), 'nl_template',true);\r\n  foreach($IDS as $item_id){ \r\n    if($my_temp==NULL){\r\n      add_post_meta(get_the_ID(), 'nl_template', $item_id);\r\n      $my_temp=$item_id;\r\n    }\r\n    ?>\r\n        <option value='<?=$item_id;?>'><?=get_the_title($item_id);?></option> \r\n        <?php }\r\n}\r\n?></select>\r\n      <?php } ?>\r\n      <p><?php _e('Sent by','eelv_lettreinfo') ?> : <?=$expediteur?> (<?=$reponse?>)</p>\r\n      <p><?php _e('Last sent','eelv_lettreinfo') ?> : <?=$lastsend?></p>\r\n      <div><?=$content?></div>\r\n      <?php \r\n                    }\r\n                    function newsletter_archive_admin_dest() {\r\n                      global $wpdb,$newsletter_plugin_url;\r\n                      $post_id = get_the_ID(); //$_GET['id'];\r\n                      $sent = get_post_meta($post_id, 'sentmails',true);\r\n\t\t\t\t\t  $nl_spy=get_post_meta($post_id, 'nl_spy',true);\r\n\t\t\t\t\t  $lus = abs(substr_count($sent,':3'));\r\n\t\t  \t\t\t $tot = abs(substr_count($sent,','));\r\n                      ?>    \r\n                    <p><?php  printf(__('%s opened','eelv_lettreinfo'),round($lus/$tot*100).'%'); ?></p>\r\n      <p><ul id=\"eelv_nl_sentlist\"><?php \r\n                      echo '<li data-email=\"'.str_replace(\r\n                        array(\r\n\t\t\t\t\t\t  ',',\t\r\n                          ':',\r\n                        ),\r\n                        array(\r\n\t\t\t\t\t\t  '\"></li><li data-email=\"',\r\n                          '\" class=\"eelv_nl_sent eelv_nl_status_',\r\n                        ),\r\n                        $sent).'\">&nbsp;</li>';\r\n                      \r\n                      ?></ul>\r\n                      <?php if($nl_spy==0) _e('No reading-tracking','eelv_lettreinfo'); ?>\r\n                      </p>\r\n\t\t\t\t\t  <style>\r\n\t\t\t\t\t  #eelv_nl_sentlist li.eelv_nl_sent{\r\n\t\t\t\t\t\tdisplay:inline-block;\r\n\t\t\t\t\t\twidth:26%;\r\n\t\t\t\t\t\tpadding:7px 1px 7px 40px;\r\n\t\t\t\t\t\tmargin:2px;\r\n\t\t\t\t\t\tbackground-position: 6px 6px;\r\n\t\t\t\t\t\tbackground-repeat:no-repeat;\r\n\t\t\t\t\t\tbackground-color:#FFF;\r\n\t\t\t\t\t\tborder:#CCC 1px outset;\r\n\t\t\t\t\t\tborder-radius:5px;\r\n\t\t\t\t\t\tbox-shadow:rgba(0,0,0,0.2) 0px 2px 3px; \r\n\t\t\t\t\t  }\r\n\t\t\t\t\t  #eelv_nl_sentlist li.eelv_nl_status_-1{\r\n\t\t\t\t\t\tbackground-image:url(<?=$newsletter_plugin_url?>/eelv-newsletter/img/-1.jpg);\r\n\t\t\t\t\t\tcolor:#900;\r\n\t\t\t\t\t  }\r\n\t\t\t\t\t  #eelv_nl_sentlist li.eelv_nl_status_0{\r\n\t\t\t\t\t\tbackground-image:url(<?=$newsletter_plugin_url?>/eelv-newsletter/img/0.jpg);\r\n\t\t\t\t\t\tcolor:#900;\r\n\t\t\t\t\t  }\r\n\t\t\t\t\t  #eelv_nl_sentlist li.eelv_nl_status_1{\r\n\t\t\t\t\t\tbackground-image:url(<?=$newsletter_plugin_url?>/eelv-newsletter/img/1.jpg);\r\n\t\t\t\t\t\tcolor:#030;\r\n\t\t\t\t\t  }\r\n\t\t\t\t\t  #eelv_nl_sentlist li.eelv_nl_status_2{\r\n\t\t\t\t\t\tbackground-image:url(<?=$newsletter_plugin_url?>/eelv-newsletter/img/2.jpg);\r\n\t\t\t\t\t\tcolor:#900;\r\n\t\t\t\t\t  }\r\n\t\t\t\t\t  #eelv_nl_sentlist li.eelv_nl_status_3{\r\n\t\t\t\t\t\tbackground-image:url(<?=$newsletter_plugin_url?>/eelv-newsletter/img/3.jpg);\r\n\t\t\t\t\t\tborder:#0F0 1px outset;\r\n\t\t\t\t\t\tcolor:#0C0;\r\n\t\t\t\t\t  }\r\n\t\t\t\t\t  \r\n\t\t\t\t\t  </style>\r\n                      <script>\r\n\t\t\t\t\t  jQuery(document).ready(function(e) {\r\n                        jQuery('#eelv_nl_sentlist').children('li').each(function(index, element) {\r\n\t\t\t\t\t\t\tif(jQuery(this).data('email')!=''){\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t  \t\t\tjQuery(this).html(jQuery(this).data('email')).click(function(){\r\n\t\t\t\t\t\t\t\t\t<?php if($nl_spy==1): ?>\r\n\t\t\t\t\t\t\t\t\tjQuery.ajax({\r\n\t\t\t\t\t\t\t\t\t\ttype: 'POST',\r\n\t\t\t\t\t\t\t\t\t\turl:'<?=$newsletter_plugin_url?>/eelv-newsletter/reading/check.php?i=<?=$post_id?>&m='+jQuery(this).data('email'),\r\n\t\t\t\t\t\t\t\t\t\tdataType: 'json',\r\n\t\t\t\t\t\t\t\t\t\tasync: false,\r\n\t\t\t\t\t\t\t\t\t\tsuccess: function (k) {\r\n\t\t\t\t\t\t\t\t\t\t\tvar txt='';\r\n\t\t\t\t\t\t\t\t\t\t\tfor(var i=0 ; i<k.length ; i++){\r\n\t\t\t\t\t\t\t\t\t\t\t  txt+='<?=str_replace('\\'','\\\\\\'',__('Read on :','eelv_lettreinfo'))?> '+k[i]['date']+'\\n';\t\t\t\t\t\t\t\t\t\t\t  \r\n\t\t\t\t\t\t\t\t\t\t\t  txt+='<?=str_replace('\\'','\\\\\\'',__('On :','eelv_lettreinfo'))?> '+k[i]['user_agent']+'\\n';\r\n\t\t\t\t\t\t\t\t\t\t\t  txt+='<?=str_replace('\\'','\\\\\\'',__('From IP address :','eelv_lettreinfo'))?> '+k[i]['ip']+'\\n';\r\n\t\t\t\t\t\t\t\t\t\t\t  txt+='\\n\\n'; \r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\tif(txt==''){\r\n\t\t\t\t\t\t\t\t\t\t\t\ttxt='<?=str_replace('\\'','\\\\\\'',__('Unread','eelv_lettreinfo'))?> ';\t\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\talert(txt);\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t});\t\r\n\t\t\t\t\t\t\t\t\t<?php endif; ?>\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t}\r\n                    \t});\r\n                    });\r\n\t\t\t\t\t  \r\n\t\t\t\t\t  </script>\r\n      <?php \r\n                    }\r\n                    function newsletter_archive_admin_queue() {\r\n                      global $wpdb,$newsletter_plugin_url;\r\n                      $post_id = get_the_ID(); //$_GET['id'];\r\n                      $dest = get_post_meta($post_id, 'destinataires',true);\r\n                      ?>    \r\n      <p><?=$dest?></p>\r\n      <?php if($dest!=''){ ?>\r\n      <a href='edit.php?post=<?=$post_id?>&action=edit&ref=<?=time()?>'><?=__('Automatically sending a new burst','eelv_lettreinfo')?></a>\r\n      <script>\r\n        document.location='edit.php?post=<?=$post_id?>&action=edit&ref=<?=time()?>';\r\n      </script>\r\n      <?php }\r\n                    }\r\n                    ///////////////////////////////////// CHECK DB\r\n                    function newsletter_checkdb(){\r\n                      ?>\r\n      <div class=\"wrap\">\r\n        <div id=\"icon-edit\" class=\"icon32 icon32-posts-newsletter\"><br/></div>\r\n        <h2><?php _e('Newsletter', 'eelv_lettreinfo' ) ?></h2>\r\n        <table class=\"widefat\" style=\"margin-top: 1em;\">\r\n          <thead>\r\n            <tr>\r\n              <th scope=\"col\" colspan=\"2\"><?php _e('Reload parameters', 'eelv_lettreinfo' ) ?></th>\r\n            </tr>\r\n          </thead>\r\n          <tbody>\r\n            <tr>\r\n              <td>\r\n                <?php\r\n  global $newsletter_tb_name,$wpdb,$newsletter_plugin_url,$eelv_nl_default_themes;\r\n                      // GROUPE NON CLASSE\r\n                      $ret =  $wpdb->get_results(\"SELECT * FROM `$newsletter_tb_name` WHERE `id`='1'\");?>\r\n                     <h3><?php _e('Address book','eelv_lettreinfo'); ?></h3>\r\n                      <p><?php _e('Uncategorized group :','eelv_lettreinfo'); ?>\r\n                     <?php if(is_array($ret) && sizeof($ret)>0){\r\n                        $query=\"UPDATE $newsletter_tb_name SET `nom`='Non class&eacute;s',`email`='',`parent`='0' WHERE `id`='1'\";\r\n                        _e('ok','eelv_lettreinfo');\r\n                      }\r\n                      else{\r\n                        $query=\"INSERT INTO $newsletter_tb_name (`id`,`nom`) VALUES ('1','Non class&eacute;s')\";\r\n                        _e('Created','eelv_lettreinfo');\r\n                      }\r\n\t\t\t\t\t\t?>\r\n\t\t\t\t\t\t</p>\r\n\t\t\t\t\t\t<?php\r\n                     \r\n                      $wpdb->query($query);\r\n                      // GROUPE RED LIST\r\n                      echo'<p>'.__('Red list group :','eelv_lettreinfo').' ';\r\n                      $ret =  $wpdb->get_results(\"SELECT * FROM `$newsletter_tb_name` WHERE `id`='2'\");\r\n                      if(is_array($ret) && sizeof($ret)>0){\r\n                        $query=\"UPDATE $newsletter_tb_name SET `nom`='Liste rouge',`email`='',`parent`='0' WHERE `id`='2'\";\r\n                        _e('ok','eelv_lettreinfo');\r\n                      }\r\n                      else{\r\n                        $query=\"INSERT INTO $newsletter_tb_name (`id`,`nom`) VALUES ('2','Liste rouge')\";\r\n                        _e('Created','eelv_lettreinfo');\r\n                      }\r\n                      echo'  </p>';\r\n                      $wpdb->query($query);\r\n                      // THEMES PAR DEFAUT\r\n                      echo'<h3>'.__('Default skins','eelv_lettreinfo').'</h3>';\r\n                      foreach($eelv_nl_default_themes as $check_theme=>$check_content){\r\n                        echo'<p><b>'.$check_theme.'</b> : ';\r\n                        $req=\"SELECT * FROM $wpdb->posts WHERE post_type = 'newsletter_template' AND `post_status`='publish' AND `post_title`='$check_theme'\";\r\n                        $ret =  $wpdb->get_results($req);\r\n                        if(is_array($ret) && sizeof($ret)>0){\r\n                          if(sizeof($ret)>1){      \r\n                            $wpdb->query(\"DELETE FROM `$wpdb->posts` WHERE `post_type`='newsletter_template' AND `post_status`='publish'  AND `post_title`='$check_theme'\");\r\n                          }\r\n                          $my_postb = array(\r\n                            'ID' => $ret[0]->ID,\r\n                            'post_content' => $check_content\r\n                          );\r\n                          wp_update_post( $my_postb );\r\n                          echo'mise \u00e0 jour ok';\r\n                        }\r\n                        else{\r\n                          $my_posta = array(\r\n                            'post_type' => 'newsletter_template',\r\n                            'post_title' => $check_theme,\r\n                            'post_content' => $check_content,\r\n                            'post_status' => 'publish'\r\n                          );\r\n                          wp_insert_post( $my_posta );\r\n                          echo'ajout ok';\r\n                        }\r\n                        echo'</p>';\r\n                      } ?>\r\n              </td></tr></tbody></table></div>\r\n      <?php\r\n                    }\r\n                    ///////////////////////////////////// SEMI CRON AUTO SEND\r\n                    function newsletter_autosend(){\r\n                      global $newsletter_tb_name,$wpdb,$newsletter_plugin_url,$eelv_nl_default_themes;\r\n                      $querystr = \"SELECT $wpdb->posts.`ID` FROM $wpdb->posts,$wpdb->postmeta WHERE (post_status = 'publish' OR post_status = 'private') AND post_type = 'newsletter_archive'  AND $wpdb->postmeta.`post_id`=$wpdb->posts.`ID` AND $wpdb->postmeta.`meta_key`='destinataires' AND $wpdb->postmeta.`meta_value`!=''\";\r\n                      $IDS = $wpdb->get_col($querystr);  \r\n                      $send_nb = sizeof($IDS);\r\n                      if($send_nb>0){\r\n                        $desinsc_url = get_option( 'newsletter_desinsc_url' );\r\n                        $env=0;\r\n                        foreach($IDS as $post_id){ \r\n                          $my_temp=get_post_meta($post_id, 'nl_template',true);\r\n                          $sujet = get_post_meta($post_id, 'sujet', true);\r\n                          $expediteur = get_post_meta($post_id, 'expediteur', true);\r\n                          $reponse = get_post_meta($post_id, 'reponse' ,true);\r\n                          $dests = get_post_meta($post_id, 'destinataires',true);\r\n                          $nl_spy = get_post_meta($post_id, 'nl_spy',true);\r\n                          if(substr($dests,0,1)==',') $dests=substr($dests,1);\r\n                          $dests = explode(',',$dests);\r\n                          $sent = get_post_meta($post_id, 'sentmails',true);  \r\n                          $template=get_post($my_temp);\r\n                          if($template){\r\n                            $content = \"<center><a href='\".home_url().\"/?post_type=newsletter_archive&p=\".$post_id.\"' target='_blank'><font size='1'>\".__('Click here if you cannot read this e-mail','eelv_lettreinfo').\"</font></a></center>\".nl_content($post_id);\r\n                            $prov = getenv(\"SERVER_NAME\");\r\n                            $eol=\"\\n\";\r\n                            $now = time();\r\n                            $headers = \"From: $expediteur <$reponse>\".$eol;\r\n                            $headers .= \"Reply-To: $expediteur <$reponse>\".$eol;\r\n                            $headers .= \"Return-Path: $expediteur <$reponse>\".$eol;    \r\n                            $headers .= \"Message-ID: <\".$post_id.\"@\".$prov.\">\".$eol;\r\n                            $headers .= \"X-Mailer: PHP v\".phpversion().$eol;         \r\n                            $mime_boundary=\"----=_NextPart_\".md5(time());\r\n                            $headers .= 'MIME-Version: 1.0'.$eol;\r\n                            $headers .= \"Content-Type: text/html; charset=\\\"utf-8\\\"; Content-Transfer-Encoding: quoted-printable; boundary=\\\"\".$mime_boundary.\"\\\"\".$eol;\r\n                            //print_r($dests);    \r\n                            $newsletter_admin_surveillance = get_site_option( 'newsletter_admin_surveillance' );\r\n                            if($newsletter_admin_surveillance!=''){\r\n                              mail($newsletter_admin_surveillance,'[EELV-newsletter:'.__('Sending','eelv_lettreinfo').'] '.$sujet,$content,$headers);\r\n                            }\r\n                            while($dest = array_shift($dests)){\r\n                              $dest=trim($dest);\r\n                              if (filter_var($dest, FILTER_VALIDATE_EMAIL)) {\r\n                                $ret = $wpdb->get_results(\"SELECT * FROM `$newsletter_tb_name` WHERE `email`='\".str_replace(\"'\",\"''\",$dest).\"' AND `parent`='2' LIMIT 0,1\");\r\n                                if(is_array($ret) && sizeof($ret)==0){             // White liste OK            \r\n                                  if( update_post_meta($post_id, 'destinataires',implode(',',$dests)) ){\r\n\t\t\t\t\t\t\t\t\t$the_content=$content;\r\n\t\t\t\t\t\t\t\t\tif($nl_spy==1){\r\n\t\t\t\t\t\t\t\t\t\t  $the_content.='<a href=\"'.get_bloginfo('url').'\"><img src=\"'.$newsletter_plugin_url.'/eelv-newsletter/reading/'.base64_encode($dest.'!'.$post_id).'/logo.png\" border=\"none\" alt=\"'.get_bloginfo('url').'\"/></a>';\r\n\t\t\t\t\t\t\t\t\t  }\r\n                                    if(mail($dest,$sujet,$the_content,$headers)){  // Envoi OK\r\n                                      $sent = $dest.':1,'.$sent;\r\n                                    }\r\n                                    else{                    // Envoi KO\r\n                                      $sent = $dest.':0,'.$sent;\r\n                                    }\r\n                                    update_post_meta($post_id, 'sentmails',$sent);\r\n                                    $env++;\r\n                                  }\r\n                                }\r\n                                elseif(is_array($ret) && sizeof($ret)==1){           // Black list\r\n                                  $sent = $dest.':2,'.$sent;\r\n                                  update_post_meta($post_id, 'destinataires',implode(',',$dests));\r\n                                  update_post_meta($post_id, 'sentmails',$sent);\r\n                                }\r\n                                else{                         // Envoi OK\r\n                                  $sent = $dest.':0+,'.$sent;\r\n                                  update_post_meta($post_id, 'destinataires',implode(',',$dests));\r\n                                  update_post_meta($post_id, 'sentmails',$sent);\r\n                                }\r\n                              }\r\n                              else{            // Mail invalide\r\n                                $sent = $dest.':-1,'.$sent;\r\n                                update_post_meta($post_id, 'destinataires',implode(',',$dests));\r\n                                update_post_meta($post_id, 'sentmails',$sent);\r\n                              }\r\n                              if($env>100){\r\n                                break 2;\r\n                              }\r\n                            }\r\n                          }\r\n                        }\r\n                      }\r\n                    }\r\n                    /*****************************************************************************************************************************************\r\n                    C O N F I G U R A T I O N                                            *****************************************************************************************************************************************/\r\nfunction newsletter_network_configuration(){\r\n  if( $_REQUEST[ 'type' ] == 'update' ) {    \r\n\tupdate_site_option( 'newsletter_admin_surveillance', $_REQUEST['newsletter_admin_surveillance'] );      \r\n\t?>\r\n<div class=\"updated\"><p><strong><?php _e('Options saved', 'eelv_lettreinfo' ); ?></strong></p></div>\r\n<?php \r\n  }\r\n  $newsletter_admin_surveillance = get_site_option( 'newsletter_admin_surveillance' );\r\n  ?>  \r\n      <div class=\"wrap\">\r\n        <div id=\"icon-edit\" class=\"icon32 icon32-posts-newsletter\"><br/></div>\r\n        <h2><?=_e('Newsletter', 'eelv_lettreinfo' )?></h2>\r\n        <form name=\"typeSite\" method=\"post\" action=\"<?php echo str_replace( '%7E', '~', $_SERVER['REQUEST_URI']); ?>\">  \r\n          <input type=\"hidden\" name=\"type\" value=\"update\">\r\n          <table class=\"widefat\" style=\"margin-top: 1em;\">\r\n            <thead>\r\n              <tr>\r\n                <th scope=\"col\" colspan=\"2\"><?= __( 'Configuration ', 'menu-config' ) ?></th>\r\n              </tr>\r\n            </thead>\r\n            <tbody>\r\n              <tr>\r\n                <td width=\"30%\">\r\n                  <label for=\"newsletter_default_exp\"><?=_e('Send a copy of each burst of shipments to:', 'eelv_lettreinfo' )?> :</label>\r\n                </td><td>\r\n                <input  type=\"text\" name=\"newsletter_admin_surveillance\"  size=\"60\"  id=\"newsletter_admin_surveillance\"  value=\"<?=$newsletter_admin_surveillance?>\" class=\"wide\">\r\n                </td>\r\n              </tr>\r\n              <tr>\r\n                <td colspan=\"2\">\r\n                  <p class=\"submit\">\r\n                    <input type=\"submit\" name=\"Submit\" value=\"<?php _e('Save', 'eelv_lettreinfo' ) ?>\" />\r\n                  </p>                    \r\n                </td>\r\n              </tr>\r\n            </tbody>\r\n          </table>\r\n        </form>\r\n      </div>\r\n      <?php\r\n}\r\n// mt_toplevel_page() displays the page content for the custom Test Toplevel menu\r\nfunction newsletter_page_configuration() {\r\n  global $newsletter_plugin_url,$wpdb;\r\n  if( $_REQUEST[ 'type' ] == 'update' ) {    \r\n\tupdate_option( 'newsletter_default_exp', $_REQUEST['newsletter_default_exp'] );\r\n\tupdate_option( 'newsletter_default_mel', $_REQUEST['newsletter_default_mel'] );\r\n\tupdate_option( 'newsletter_desinsc_url', $_REQUEST['newsletter_desinsc_url'] );\r\n\tupdate_option( 'newsletter_reply_url', $_REQUEST['newsletter_reply_url'] );\r\n\t\r\n\tupdate_option( 'newsletter_msg', array(\r\n\t\t'sender'=>$_REQUEST['newsletter_msg_sender'] ,\r\n\t\t'suscribe_title'=>$_REQUEST['newsletter_msg_suscribe_title'] ,\r\n\t\t'suscribe'=>$_REQUEST['newsletter_msg_suscribe'] ,\r\n\t\t'unsuscribe_title'=>$_REQUEST['newsletter_msg_unsuscribe_title'] ,\r\n\t\t'unsuscribe'=>$_REQUEST['newsletter_msg_unsuscribe'] \r\n\t));\r\n\tupdate_option( 'affichage_NL_hp', $_REQUEST['affichage_NL_hp'] );\r\n\t?>\r\n<div class=\"updated\"><p><strong><?php _e('Options saved', 'eelv_lettreinfo' ); ?></strong></p></div>\r\n<?php \r\n  }  \r\n  $default_exp = get_option( 'newsletter_default_exp' );\r\n  $default_mel = get_option( 'newsletter_default_mel' );\r\n  $desinsc_url = get_option( 'newsletter_desinsc_url' );\r\n  $reply_url = get_option( 'newsletter_reply_url' );\r\n  $affichage_NL_hp = get_option( 'affichage_NL_hp' );\r\n  \r\n  $newsletter_msg = get_option( 'newsletter_msg' );\r\n\t  $msg_sender = $newsletter_msg['sender'];\r\n\t  $msg_suscribe_title = $newsletter_msg['suscribe_title'];\r\n\t  $msg_suscribe = $newsletter_msg['suscribe'];\r\n\t  $msg_unsuscribe_title = $newsletter_msg['unsuscribe_title'];\r\n\t  $msg_unsuscribe = $newsletter_msg['unsuscribe'];\r\n  ?>  \r\n      <div class=\"wrap\">\r\n        <div id=\"icon-edit\" class=\"icon32 icon32-posts-newsletter\"><br/></div>\r\n        <h2><?=_e('Newsletter', 'eelv_lettreinfo' )?></h2>\r\n        <form name=\"typeSite\" method=\"post\" action=\"<?php echo str_replace( '%7E', '~', $_SERVER['REQUEST_URI']); ?>\">  \r\n          <input type=\"hidden\" name=\"type\" value=\"update\">\r\n          <table class=\"widefat\" style=\"margin-top: 1em;\">\r\n            <thead>\r\n              <tr>\r\n                <th scope=\"col\" colspan=\"2\"><?php _e( 'Configuration ', 'menu-config' ) ?></th>\r\n              </tr>\r\n            </thead>\r\n            <tbody>\r\n              <tr>\r\n                <td width=\"30%\">\r\n                  <label for=\"newsletter_default_exp\"><?php _e('Default sender name:', 'eelv_lettreinfo' ) ?></label>\r\n                </td><td>\r\n                <input  type=\"text\" name=\"newsletter_default_exp\"  size=\"60\"  id=\"newsletter_default_exp\"  value=\"<?=$default_exp?>\" class=\"wide\">\r\n                </td>\r\n              </tr>\r\n              <tr>\r\n                <td width=\"30%\">\r\n                  <label for=\"newsletter_default_mel\"><?php _e('Default reply address:', 'eelv_lettreinfo' ) ?></label>\r\n                </td><td>\r\n                <input  type=\"text\" name=\"newsletter_default_mel\"  size=\"60\"  id=\"newsletter_default_mel\"  value=\"<?=$default_mel?>\" class=\"wide\">\r\n                </td>\r\n              </tr>\r\n              <tr>\r\n                <td width=\"30%\">\r\n                  <label for=\"newsletter_desinsc_url\"><?php _e('Unsuscribe page', 'eelv_lettreinfo' ) ?> :</label>\r\n                   \r\n                </td><td>\r\n                <select  name=\"newsletter_desinsc_url\"   id=\"newsletter_desinsc_url\">\r\n                  <option></option>\r\n                  <?php\r\n  $querystr = \"\";\r\n                      $ret =  $wpdb->get_results(\"SELECT * FROM $wpdb->posts WHERE post_status = 'publish' AND post_type = 'page' ORDER BY `post_title`\");\r\n                      if(is_array($ret) && sizeof($ret)>0){            \r\n                        foreach($ret as $item){ \r\n                          $permalink = get_permalink( $item->ID );\r\n                          ?>\r\n                  <option value=\"<?=$permalink;?>\" <? if($desinsc_url==$permalink) echo\"selected\"; ?>><?=$item->post_title;?></option> \r\n                  <?php } \r\n                      }\r\n                      ?>\r\n                </select><br/>\r\n\t\t\t\t<legend><?php echo ( !empty($desinsc_url) ? '<a href=\"'.$desinsc_url.'\" target=\"_blank\">'.$desinsc_url.'</a>' : ''); ?></legend>              \r\n                </td>\r\n              </tr>\r\n              <!--tr>\r\n                <td width=\"30%\">\r\n                  <label for=\"newsletter_reply_url\"><?php _e('Reply page', 'eelv_lettreinfo' ) ?> :</label>\r\n                  <legend><?php echo ( !empty($reply_url) ? '<a href=\"'.$reply_url.'\">'.$reply_url.'</a>' : ''); ?></legend>\r\n                </td><td>\r\n                <select  name=\"newsletter_reply_url\" id=\"newsletter_reply_url\">\r\n                  <option></option>\r\n                  <?php\r\n  $querystr = \"\";\r\n                      if(is_array($ret) && sizeof($ret)>0){            \r\n                        foreach($ret as $item){ \r\n                          $permalink = get_permalink( $item->ID );\r\n                          ?>\r\n                  <option value=\"<?=$permalink;?>\" <? if($reply_url==$permalink) echo\"selected\"; ?>><?=$item->post_title;?></option> \r\n                  <?php } \r\n                      }\r\n                      ?>\r\n                </select>\r\n                </td>\r\n              </tr-->\r\n              \r\n              </tbody>\r\n              <thead>\r\n              <tr><th colspan=\"2\"><?php _e( 'Confirmation e-mails ', 'menu-config' ) ?></th></tr>\r\n              </thead>\r\n              \r\n              <tbody>\r\n              <tr>\r\n                <td width=\"30%\">\r\n                  <label for=\"newsletter_msg_sender\"><?php _e('Sender email:', 'eelv_lettreinfo' ) ?></label>\r\n                </td><td>\r\n                <input  type=\"text\" name=\"newsletter_msg_sender\"  size=\"60\"  id=\"newsletter_msg_sender\"  value=\"<?=$msg_sender?>\" class=\"wide\">\r\n                </td>\r\n              </tr>\r\n              <tr>\r\n                <td width=\"30%\">\r\n                  <label for=\"newsletter_msg_suscribe_title\"><?php _e('Suscribe subject:', 'eelv_lettreinfo' ) ?></label>\r\n                </td><td>\r\n                <input  type=\"text\" name=\"newsletter_msg_suscribe_title\"  size=\"60\"  id=\"newsletter_msg_suscribe_title\"  value=\"<?=$msg_suscribe_title?>\" class=\"wide\">\r\n                </td>\r\n              </tr>\r\n              <tr>\r\n                <td width=\"30%\">\r\n                  <label for=\"newsletter_msg_suscribe\"><?php _e('Suscribe Message:', 'eelv_lettreinfo' ) ?></label>\r\n                </td><td>\r\n                <textarea  name=\"newsletter_msg_suscribe\" id=\"newsletter_msg_suscribe\"><?=$msg_suscribe;?></textarea>\r\n                </td>\r\n              </tr>\r\n              <tr>\r\n                <td width=\"30%\">\r\n                  <label for=\"newsletter_msg_unsuscribe_title\"><?php _e('Unuscribe subject:', 'eelv_lettreinfo' ) ?></label>\r\n                </td><td>\r\n                <input  type=\"text\" name=\"newsletter_msg_unsuscribe_title\"  size=\"60\"  id=\"newsletter_msg_unsuscribe_title\"  value=\"<?=$msg_unsuscribe_title?>\" class=\"wide\">\r\n                </td>\r\n              </tr>\r\n              <tr>\r\n                <td width=\"30%\">\r\n                  <label for=\"newsletter_msg_unsuscribe\"><?php _e('Unsuscribe message:', 'eelv_lettreinfo' ) ?></label>\r\n                </td><td>\r\n                <textarea  name=\"newsletter_msg_unsuscribe\" id=\"newsletter_msg_unsuscribe\"><?=$msg_unsuscribe;?></textarea>\r\n                </td>\r\n              </tr>\r\n              \r\n               <tr>\r\n                <td colspan=\"2\">\r\n                  <input type='submit' value='<?php _e('Save options', 'eelv_lettreinfo' ) ?>' class=\"button-primary\"/>\r\n                </td>\r\n              </tr>\r\n            </tbody>\r\n          </table>\r\n          <table class=\"widefat\" style=\"margin-top: 1em;\">\r\n            <thead>\r\n              <tr>\r\n                <th scope=\"col\"><?php _e('Help', 'eelv_lettreinfo' ) ?></th>\r\n              </tr>\r\n            </thead>\r\n            <tbody>\r\n              <tr>\r\n                <td>\r\n                  <?php _e('Shortcods used:', 'eelv_lettreinfo' ) ?>\r\n                  <ul>\r\n                    <li><?php _e('Insert suscribe form in a page :', 'eelv_lettreinfo' ) ?><strong>[eelv_news_form]</strong></li>\r\n                  \t<!--li><?php _e('Insert answer form in a page :','eelv_lettreinfo')?> <strong>[eelv_news_answer]</strong></li-->\r\n                  </ul>\r\n                  <?php _e('Skins shortcodes', 'eelv_lettreinfo' ) ?>        \r\n                  <ul>\r\n                    <li><?php _e('Insert newsletter content in a skin :', 'eelv_lettreinfo' ) ?><strong>[newsletter]</strong></li>\r\n                    <li><?php _e('Insert newsletter content in a skin :', 'eelv_lettreinfo' ) ?><strong>[desinsc_url]</strong></li>\r\n                  </ul>\r\n                  <?php _e('Legend of sending symbols:', 'eelv_lettreinfo' ) ?><ul>\r\n                  <li><img src=\"<?=$newsletter_plugin_url?>/eelv-newsletter/img/-1.jpg\"/> <?php _e('Invalid email', 'eelv_lettreinfo' ) ?></li>\r\n                  <li><img src=\"<?=$newsletter_plugin_url?>/eelv-newsletter/img/0.jpg\"/> <?php _e('Sending failed', 'eelv_lettreinfo' ) ?></li>\r\n                  <li><img src=\"<?=$newsletter_plugin_url?>/eelv-newsletter/img/1.jpg\"/> <?php _e('Newsletter successfully sent', 'eelv_lettreinfo' ) ?></li>\r\n                  <li><img src=\"<?=$newsletter_plugin_url?>/eelv-newsletter/img/2.jpg\"/> <?php _e('Address on the list of unsubscribed:', 'eelv_lettreinfo' ) ?></li>\r\n                  <li><img src=\"<?=$newsletter_plugin_url?>/eelv-newsletter/img/3.jpg\"/> <?php _e('Email has been readen', 'eelv_lettreinfo' ) ?></li>\r\n                  </ul>\r\n                </td></tr></tbody></table>\r\n        </form>\r\n      </div>\r\n      <?php\r\n  }  \r\nfunction eelv_lettrinfo_locate_plugin_template($template_names, $load = false, $require_once = true ){\r\n  if ( !is_array($template_names) )\r\n  return '';     \r\n  $located = '';     \r\n  $this_plugin_dir = WP_PLUGIN_DIR.'/'.str_replace( basename( __FILE__), \"\", plugin_basename(__FILE__) );     \r\n  foreach ( $template_names as $template_name ) {\r\n\tif ( !$template_name )\r\n\t  continue;\r\n\tif ( file_exists(STYLESHEETPATH . '/' . $template_name)) {\r\n\t  $located = STYLESHEETPATH . '/' . $template_name;\r\n\t  break;\r\n\t} else if ( file_exists(TEMPLATEPATH . '/' . $template_name) ) {\r\n\t  $located = TEMPLATEPATH . '/' . $template_name;\r\n\t  break;\r\n\t} else if ( file_exists( $this_plugin_dir .  $template_name) ) {\r\n\t  $located =  $this_plugin_dir . $template_name;\r\n\t  break;\r\n\t}\r\n  }     \r\n  if ( $load && '' != $located )\r\n\tload_template( $located, $require_once );     \r\n  return $located;\r\n}\r\nfunction eelv_lettrinfo_get_custom_archive_template($template){\r\n  global $wp_query;\r\n  if($wp_query->get_queried_object()->query_var=='newsletter_archive') {  \r\n\t  $templates = array('archive-newsletter_archive.php', 'archive.php');\r\n\t  $template = eelv_lettrinfo_locate_plugin_template($templates);\r\n  }\r\n  return $template;\r\n}\r\nfunction eelv_lettrinfo_get_custom_single_template($template){\r\n  global $wp_query;\r\n  $object = $wp_query->get_queried_object();\r\n  if ( 'newsletter_archive' == $object->post_type ) {\r\n\t$templates = array('single-' . $object->post_type . '.php', 'single.php');\r\n\t$template = eelv_lettrinfo_locate_plugin_template($templates);\r\n  }\r\n  return $template;\r\n}\r\n////////////////////////////////////////////////////////////////////////////////////////////////////// WIDGET\r\nwp_register_sidebar_widget(\r\n  'widget_eelv_lettreinfo_insc',        // your unique widget id\r\n  __('Suscribe newsletter','eelv_lettreinfo'),          // widget name\r\n  'widget_eelv_lettreinfo_side',  // callback function\r\n  array(                  // options\r\n\t'description' => __('Form / unsubscribe and archives NewsLetter','eelv_lettreinfo')\r\n  )\r\n);\r\nfunction widget_eelv_lettreinfo_side($params) {\r\n  $eelv_li_xs_title= get_option('eelv_li_xs_title')?>\r\n      <?php echo $params['before_widget']; ?>\r\n      <?php echo $params['before_title'];?>\r\n      <?php echo  $eelv_li_xs_title; ?>\r\n      <?php echo $params['after_title'];?>\r\n      <?php get_news_form('widget'); ?>\r\n      <?php echo $params['after_widget'];?>\r\n      <?php\r\n                    }\r\n                    \r\n wp_register_widget_control('widget_eelv_lettreinfo_insc', __('Suscribe newsletter','eelv_lettreinfo'),'widget_eelv_lettreinfo_insc_control');\r\n function widget_eelv_lettreinfo_insc_control(){\r\n   if( isset($_POST['eelv_li_xs_title']) ){\r\n\t    update_option('eelv_li_xs_title', stripslashes($_POST['eelv_li_xs_title']));\r\n\t    update_option('eelv_li_xs_archives', $_POST['eelv_li_xs_archives']);\r\n\t    echo 'Options sauvegard&eacute;es<br/>';\r\n   }\r\n                      $eelv_li_xs_title= get_option('eelv_li_xs_title');\r\n                      $eelv_li_xs_archives = get_option('eelv_li_xs_archives',0);\r\n                      ?>\r\n      <p><label for='eelv_li_xs_title'><?php _e('Title', 'eelv_lettreinfo' ) ?><br/>\r\n        <input type='text' name='eelv_li_xs_title' id='eelv_li_xs_title' value=\"<?=$eelv_li_xs_title?>\"/></label>\r\n      </p>\r\n      <p><label for='eelv_li_xs_archives'><?php _e('Hide archives link', 'eelv_lettreinfo' ) ?><br/>\r\n        <select name='eelv_li_xs_archives' id='eelv_li_xs_archives'>\r\n            <option value=\"0\" <?php if($eelv_li_xs_archives==0){ echo'selected'; } ?>><?php _e('No', 'eelv_lettreinfo' ) ?></option>\r\n            <option value=\"1\" <?php if($eelv_li_xs_archives==1){ echo'selected'; } ?>><?php _e('Yes', 'eelv_lettreinfo' ) ?></option>\r\n        </select>\r\n        </label>\r\n      </p>\r\n      <?php\r\n  }\r\n  function news_transform(){\r\n  global $wpdb;\r\n  $querystr = \"SELECT `ID` FROM $wpdb->posts WHERE post_status = 'publish' AND post_type = 'newsletter_template' ORDER BY `post_title`\";\r\n  $IDS = $wpdb->get_col($querystr);  \r\n  $templates_nb = sizeof($IDS);\r\n  if($templates_nb>0){ ?>\r\n  \r\n  <input type=\"hidden\" id=\"eelv_nl_convert_link\" value=\"edit.php?post_type=newsletter&page=news_envoi&post=<?=get_the_ID()?>\"/>\r\n  \t<select name=\"eelv_nl_convert_id\" id=\"eelv_nl_convert_id\">\r\n\t<?php foreach($IDS as $item_id){ ?>\r\n\t\t<option value=\"<?=$item_id?>\"><?=get_the_title($item_id);?></option> \r\n\t<?php } ?>\r\n\t</select>\r\n\t<hr/>\r\n    <p><label for=\"eelv_nl_convert_title\"><input type=\"checkbox\" id=\"eelv_nl_convert_title\"  value=\"1\"/> <?php _e(\"Add title to content\",'eelv_lettreinfo'); ?></label></p>\r\n    <p><label for=\"eelv_nl_convert_share\"><input type=\"checkbox\" id=\"eelv_nl_convert_share\"  value=\"1\"/> <?php _e(\"Add share links\",'eelv_lettreinfo'); ?></label></p>\r\n    \r\n    \r\n    <p><a id=\"eelv_nl_convert_a\" class=\"button\"> <?php _e(\"Preview and send\",'eelv_lettreinfo'); ?></a></p>\r\n    <script>\r\n\tjQuery(document).ready(function(e) {\r\n\t\tjQuery('#eelv_nl_convert_id').width(jQuery('#eelv_nl_convert_id').parent().width()-10);\r\n\t\tjQuery('#eelv_nl_convert_a').click(function(){\r\n\t\t\tvar lien=jQuery('#eelv_nl_convert_link').attr('value');\r\n\t\t\tlien+='&convert=';\r\n\t\t\tlien+=jQuery('#eelv_nl_convert_id').val();\r\n\t\t\tif(jQuery('#eelv_nl_convert_title').is(':checked')==true){\r\n\t\t\t\tlien+='&add_title=1';\r\n\t\t\t}\r\n\t\t\tif(jQuery('#eelv_nl_convert_share').is(':checked')==true){\r\n\t\t\t\tlien+='&add_sharelinks=1';\r\n\t\t\t}\r\n\t\t\t//console.log(lien);\r\n\t\t\tdocument.location=lien;\r\n\t\t\treturn false;\r\n\t\t});\r\n\t});\r\n\t</script>\r\n<?php\r\n  }else{\r\n\t_e(\"No skin available\",'eelv_lettreinfo');  \r\n  }  \r\n}\r\n///////////////////////////////////////////////////////////////////////// INSERTION DANS WORDPRESS\r\nregister_activation_hook(__FILE__,'eelvnewsletter_install');\r\nadd_action( 'save_post', 'newsletter_save_postdata' );\r\nadd_action('plugins_loaded', 'eelvnewsletter_update_db_check');\r\nadd_action( 'add_meta_boxes', 'newsletter_add_custom_box' );\r\nadd_action( 'init', 'newsletter_BO' );\r\nadd_action('admin_menu', 'eelv_news_ajout_menu');\r\nadd_action( 'network_admin_menu', 'eelv_news_ajout_network_menu'); \r\nadd_action('wp_head', 'style_newsletter');\r\n\r\nadd_action( 'admin_init', 'newsletter_autosend' );\r\nadd_filter( 'archive_template', 'eelv_lettrinfo_get_custom_archive_template' );\r\nadd_filter( 'single_template', 'eelv_lettrinfo_get_custom_single_template' );\r\nadd_filter('manage_newsletter_posts_columns', 'lettreinfo_columns_head');  \r\nadd_action('manage_newsletter_posts_custom_column', 'lettreinfo_columns_content', 10, 2); \r\nadd_filter('manage_newsletter_archive_posts_columns', 'lettreinfo_archives_columns_head');  \r\nadd_action('manage_newsletter_archive_posts_custom_column', 'lettreinfo_archives_columns_content', 10, 2); "], "fixing_code": ["<?php\r\n/*\r\nPlugin Name: EELV Newsletter\r\nPlugin URI: http://ecolosites.eelv.fr\r\nDescription:  Add a registration form on frontOffice, a newsletter manager on BackOffice\r\nVersion: 3.3.1\r\nAuthor: bastho, ecolosites // EELV\r\nAuthor URI: http://ecolosites.eelv.fr\r\nLicense: CC BY-NC v3.0\r\nText Domain: eelv_lettreinfo\r\nDomain Path: /languages/\r\n*/\r\n\r\nload_plugin_textdomain( 'eelv_lettreinfo', false, 'eelv-newsletter/languages' );\r\n    \r\n\t\r\n  // ID for DB version\r\n  $eelv_newsletter_version = '2.6.5';\r\n  $newsletter_tb_name = 'eelv_'.$wpdb->blogid. '_newsletter_adr';\r\n  global $wpdb, $eelv_nl_default_themes, $eelv_nl_content_themes, $lettreinfo_plugin_path, $newsletter_plugin_url;\r\n  $newsletter_plugin_url = plugins_url();\r\n  $lettreinfo_plugin_path=WP_PLUGIN_DIR.'/'.str_replace( basename( __FILE__), \"\", plugin_basename(__FILE__) );\r\n  $eelv_nl_content_themes=array();\r\n  $eelv_nl_default_themes=array();\r\n  $newsletter_sql = \"CREATE TABLE \" . $newsletter_tb_name . \" (\r\n    `id` mediumint(9) NOT NULL AUTO_INCREMENT,\r\n    `parent` mediumint(9) DEFAULT 0 NOT NULL,\r\n    `nom` VARCHAR(255) DEFAULT '' NOT NULL,\r\n    `email` VARCHAR(255) DEFAULT '' NOT NULL,\r\n    PRIMARY KEY  (`id`)\r\n    );\";\r\n  \r\n  function eelv_nl_infos(){\r\n\t\t__('Add a registration form on frontOffice, a newsletter manager on BackOffice','eelv_lettreinfo');\r\n\t\t__('EELV Newsletter','eelv_lettreinfo');\r\n   }\r\n  /* INSTALLATION DES TABLES  */\r\n  function eelvnewsletter_install() {\r\n    global $eelv_newsletter_version,$newsletter_tb_name,$newsletter_sql;\r\n    require_once(ABSPATH . 'wp-admin/includes/upgrade.php');\r\n    dbDelta($newsletter_sql);\r\n    add_option('eelv_newsletter_version', $eelv_newsletter_version);\r\n  }\r\n  // UPDATE PLUGIN\r\n  $installed_ver = get_option( \"eelv_newsletter_version\" );\r\n  if( $installed_ver != $eelv_newsletter_version ) {\r\n    require_once(ABSPATH . 'wp-admin/includes/upgrade.php');\r\n    dbDelta($newsletter_sql);\r\n    update_option( 'eelv_newsletter_version', $eelv_newsletter_version );\r\n  }\r\n  // WP 3.1 patch upgrade\r\n  function eelvnewsletter_update_db_check() {\r\n    global $eelv_newsletter_version;\r\n    if (get_option('eelv_newsletter_version') != $eelv_newsletter_version) {\r\n      update_option( 'eelv_newsletter_version', $eelv_newsletter_version );\r\n      eelvnewsletter_install();\r\n    }\r\n  }\r\n  if(false===$wpdb->query('SELECT `id` FROM '.$newsletter_tb_name.' LIMIT 0,1') ){\r\n    eelvnewsletter_install();\r\n  }\r\n  // FONCTIONS\r\n  add_action( 'admin_enqueue_scripts', 'eelv_nl_my_admin_enqueue_scripts' );\r\n  function eelv_nl_my_admin_enqueue_scripts() {\r\n    if ( 'newsletter_archive' == get_post_type() )\r\n      wp_dequeue_script( 'autosave' );\r\n  }\r\n  function newsletter_BO(){\r\n    global $eelv_nl_content_themes,$eelv_nl_default_themes, $newsletter_plugin_url,$lettreinfo_plugin_path;\r\n    \r\n    register_post_type('newsletter', array(  'label' => 'Newsletter','description' => '','public' => true,'show_ui' => true,'show_in_menu' => true,'capability_type' => 'post','hierarchical' => false,'rewrite' => array('slug' => ''),'query_var' => true,'has_archive' => true,'supports' => array('title','editor','author'),'menu_icon'=>plugin_dir_url( __FILE__ ).'img/mail.png','labels' => array (\r\n      'name' => __(\"Newsletter\",'eelv_lettreinfo'),\r\n      'singular_name' => __(\"Newsletter\",'eelv_lettreinfo'),\r\n      'menu_name' => __(\"Newsletter\",'eelv_lettreinfo'),\r\n      'add_new' => __('add','eelv_lettreinfo'),\r\n      'add_new_item' => __('Add','eelv_lettreinfo'),\r\n      'edit' => __('Edit','eelv_lettreinfo'),\r\n      'edit_item' => __('Edit','eelv_lettreinfo'),\r\n      'new_item' => __('New','eelv_lettreinfo'),\r\n      'view' => __('View','eelv_lettreinfo'),\r\n      'view_item' => __('View newsletter','eelv_lettreinfo'),\r\n      'search_items' => __('Search','eelv_lettreinfo'),\r\n      'not_found' => __('No newsletter Found','eelv_lettreinfo'),\r\n      'not_found_in_trash' => __('No newsletter Found in Trash','eelv_lettreinfo'),\r\n      'parent' => __('Parent newsletter','eelv_lettreinfo'),\r\n    ),) );\r\n    register_post_type(\r\n      'newsletter_template', array(  'label' => 'Mod&egrave;les','description' => '','public' => true,'show_ui' => true,'show_in_menu' => false,'capability_type' => 'post','hierarchical' => false,'rewrite' => array('slug' => ''),'query_var' => true,'has_archive' => true,'supports' => array('title','editor','revisions'),'show_in_menu' => 'edit.php?post_type=newsletter','labels' => array (\r\n        'name' => __('Skin','eelv_lettreinfo'),\r\n        'singular_name' => __('Skin','eelv_lettreinfo'),\r\n        'menu_name' => __('Skins','eelv_lettreinfo'),\r\n        'add_new_item' => __('Add','eelv_lettreinfo'),\r\n        'edit' => __('Edit','eelv_lettreinfo'),\r\n        'edit_item' => __('Edit','eelv_lettreinfo'),\r\n        'new_item' => __('New','eelv_lettreinfo'),\r\n        'view' => __('View','eelv_lettreinfo'),\r\n        'view_item' => __('View','eelv_lettreinfo'),\r\n        'search_items' => __('Search','eelv_lettreinfo'),\r\n        'not_found' => __('No template Found','eelv_lettreinfo'),\r\n        'not_found_in_trash' => __('No template Found in Trash','eelv_lettreinfo'),\r\n        'parent' => __('Parent template','eelv_lettreinfo'),\r\n      ),) );\r\n    register_post_type('newsletter_archive', array(  'label' => 'Archives','description' => '','public' => true,'show_ui' => true,'show_in_menu' => false,'capability_type' => 'post','hierarchical' => false,'rewrite' => array('slug' => ''),'query_var' => true,'has_archive' => true,'supports' => array('title','editor'),'show_in_menu' => 'edit.php?post_type=newsletter','labels' => array (\r\n      'name' => __('Archives','eelv_lettreinfo'),\r\n      'singular_name' => __('Archive','eelv_lettreinfo'),\r\n      'menu_name' => __('Archives','eelv_lettreinfo'),\r\n      'add_new_item' => __('Add','eelv_lettreinfo'),\r\n      'edit' => __('Edit','eelv_lettreinfo'),\r\n      'edit_item' => __('Edit archive','eelv_lettreinfo'),\r\n      'new_item' => __('New archive','eelv_lettreinfo'),\r\n      'view' => __('View','eelv_lettreinfo'),\r\n      'view_item' => __('Preview archive','eelv_lettreinfo'),\r\n      'search_items' => __('Search an archive','eelv_lettreinfo'),\r\n      'not_found' => __('No entry has been made','eelv_lettreinfo'),\r\n      'not_found_in_trash' => __('No archive Found in Trash','eelv_lettreinfo'),\r\n      'parent' => __('Parent archive','eelv_lettreinfo'),\r\n    ),) );\r\n    require_once($lettreinfo_plugin_path.'/templates.php');\r\n  }\r\n  // ADD NEW COLUMN  \r\n  function lettreinfo_columns_head($defaults) {  \r\n    $defaults['envoyer'] = __('Send','eelv_lettreinfo');  \r\n    return $defaults;  \r\n  }  \r\n  // COLUMN CONTENT  \r\n  function lettreinfo_columns_content($column_name, $post_ID) {  \r\n    if ($column_name == 'envoyer') {  \r\n      $my_temp=get_post(get_post_meta(get_the_ID(), 'nl_template',true));\r\n      if(get_the_ID()!=0 && get_the_title()!='' && get_the_content()!=''  && $my_temp){\r\n        echo $my_temp->post_title;\r\n        echo '<br/><a href=\"edit.php?post_type=newsletter&page=news_envoi&post='.get_the_ID().'\">'.__('Preview and send','eelv_lettreinfo').'</a>';\r\n      }\r\n      else{\r\n        echo __('Not ready yet...','eelv_lettreinfo');\r\n      }  \r\n    }  \r\n  }\r\n  // ADD NEW COLUMN (ARCHIVES) \r\n  function lettreinfo_archives_columns_head($defaults) {  \r\n    $defaults['queue'] = __('Queue','eelv_lettreinfo'); \r\n    $defaults['sent'] = __('Sent','eelv_lettreinfo');  \r\n    $defaults['read'] = __('Readen','eelv_lettreinfo');  \r\n    return $defaults;  \r\n  }  \r\n  // COLUMN CONTENT  (ARCHIVES) \r\n  function lettreinfo_archives_columns_content($column_name, $post_ID) {  \r\n    if ($column_name == 'queue') {  \r\n      $dest = get_post_meta($post_ID, 'destinataires',true);\r\n      echo abs(substr_count($dest,',')); \r\n    }\r\n    if ($column_name == 'sent') {  \r\n      $sent = get_post_meta($post_ID, 'sentmails',true);\r\n      echo abs(substr_count($sent,',')); \r\n    }  \r\n    if ($column_name == 'read') {  \r\n      $spy = get_post_meta($post_ID, 'nl_spy',true);\r\n\t  if($spy==1){\r\n\t\t  $sent = get_post_meta($post_ID, 'sentmails',true);\r\n\t\t  $lus = abs(substr_count($sent,':3'));\r\n\t\t  $tot = abs(substr_count($sent,','));\r\n\t\t  echo $lus.' ('.round($lus/$tot*100).'%)'; \r\n\t  }\r\n\t  else{\r\n\t\t _e('deactivated','eelv_lettreinfo'); \r\n\t  }\r\n    }  \r\n  }\r\n  /* Adds a box to the main column on the Post and Page edit screens */\r\n  function newsletter_add_custom_box() {\r\n    add_meta_box( \r\n      'news-carnet-adresse',\r\n      __( \"Edit tools\", 'eelv_lettreinfo' ),\r\n      'newsletter_admin',\r\n      'newsletter' \r\n    );\r\n    add_meta_box( \r\n      'news-envoi-edit',\r\n      __( \"Send\", 'eelv_lettreinfo' ),\r\n      'newsletter_admin_prev',\r\n      'newsletter',\r\n      'side' \r\n    );\r\n    add_meta_box( \r\n      'news-convert-post',\r\n      __( \"Send as newsletter\", 'eelv_lettreinfo' ),\r\n      'news_transform',\r\n      'post',\r\n      'side' \r\n    ); \r\n    add_meta_box( \r\n      'news-archive_viewer',\r\n      __( \"Preview\", 'eelv_lettreinfo' ),\r\n      'newsletter_archive_admin',\r\n      'newsletter_archive' \r\n    );\r\n    add_meta_box( \r\n      'news-archive_viewerdest',\r\n      __( \"Recipients\", 'eelv_lettreinfo' ),\r\n      'newsletter_archive_admin_dest',\r\n      'newsletter_archive' \r\n    );\r\n    add_meta_box( \r\n      'news-archive_viewerqueue',\r\n      __( \"Queue\", 'eelv_lettreinfo' ),\r\n      'newsletter_archive_admin_queue',\r\n      'newsletter_archive' \r\n    ); \r\n  }\r\n  // Ajout du menu et sous menu\r\n  function eelv_news_ajout_menu() {\r\n  \tadd_submenu_page('edit.php?post_type=newsletter', __('Adress book', 'eelv_lettreinfo' ), __('Adress book', 'eelv_lettreinfo' ), 'manage_options', 'news_carnet_adresse', 'news_carnet_adresse');\r\n    add_submenu_page('edit.php?post_type=newsletter', __('Send', 'eelv_lettreinfo' ), __('Send', 'eelv_lettreinfo' ), 'manage_options', 'news_envoi', 'news_envoi');\r\n    add_submenu_page('edit.php?post_type=newsletter', __('Configuration/help', 'eelv_lettreinfo' ), __('Configuration/help', 'eelv_lettreinfo' ), 'manage_options', 'newsletter_page_configuration', 'newsletter_page_configuration');\r\n    add_submenu_page('edit.php?post_type=newsletter', __('Reload parameters', 'eelv_lettreinfo' ), __('Reload parameters', 'eelv_lettreinfo' ), 'manage_options', 'newsletter_checkdb', 'newsletter_checkdb');\r\n  }\r\n  // Ajout du menu d'option sur le r&eacute;seau\r\n  function eelv_news_ajout_network_menu() {\r\n    add_submenu_page('settings.php', __('Newsletter', 'eelv_lettreinfo' ), __('Newsletter', 'eelv_lettreinfo' ), 'Super Admin', 'newsletter_network_configuration', 'newsletter_network_configuration');\r\n    //add_submenu_page('tpe', 'Historique', 'Historique', 'Super Admin', 'eelv_tpe_liste', 'tpe_supercommandes_liste');    \r\n  }\r\n  function get_news_meta($id){\r\n    global $wpdb,$newsletter_tb_name ;\r\n    $ret =  $wpdb->get_results(\"SELECT * FROM `$newsletter_tb_name` WHERE `id`='$id'\");\r\n    if(is_array($ret) && sizeof($ret)>0){\r\n      return $ret[0];  \r\n    }\r\n    return false;\r\n  }\r\n  \r\n  add_shortcode( 'nl_date' , 'nl_short_date' );\r\n  function nl_short_date(){\r\n  \treturn date_i18n(get_option('date_format'));\r\n  }\r\n  \r\n  add_shortcode( 'desinsc_url' , 'nl_short_desinsc' );  \r\n  function nl_short_desinsc(){\r\n    $desinsc_url = get_option( 'newsletter_desinsc_url' );\r\n  \treturn '<a href=\"'.$desinsc_url.'\" target=\"_blank\" class=\"nl_a\">'.$desinsc_url.'</a>';\r\n  }\r\n  function nl_content($post_id,$type='newsletter'){\r\n    $nl =  get_post($post_id); \r\n    $content=$nl->post_content;\r\n    $template =  get_post(get_post_meta($post_id,'nl_template',true)); \r\n    if($template){\r\n      $content= str_replace('[newsletter]',$content,$template->post_content);\r\n    }\r\n     \r\n    $return  = apply_filters('the_content',$content);\r\n\tif($return=='' && $content!=''){\r\n\t\t$return=$content;\r\n\t\t$desinsc_url = get_option( 'newsletter_desinsc_url' );\r\n\t\t$return= str_replace('[nl_date]',date_i18n(get_option('date_format')),$return);\r\n    \t$return=str_replace('[desinsc_url]',\"<a href='\".$desinsc_url.\"' target='_blank' class='nl_a'>\".$desinsc_url.\"</a>\",$return);\r\n\t} \r\n    return $return;\r\n  }\r\n  function eelv_newsletter_sharelinks($title,$link){\r\n\t\treturn \"<div style='width:550px; margin:0px;text-align:left; clear:both;font-size:9px; '><span style='display:block;float:left;padding:2px;padding-left:10px;padding-right:10px;background:#888;color:#FFF;'>\".__('Share on : ', 'eelv_lettreinfo' ).\"</span><a href='http://www.facebook.com/sharer.php?u=\".urlencode($link).\"&t=\".$title.\"' target='_blank' style='display:block;float:left;padding:2px;padding-left:10px;padding-right:10px;background:#3B5998;color:#FFF;'>Facebook</a><a href='https://twitter.com/intent/tweet?text=\".$title.\"%20\".urlencode($link).\"' target='_blank' style='display:block;float:left;padding:2px;padding-left:10px;padding-right:10px;background:#2BB7EA;color:#FFF;'>Twitter</a><a href='https://plus.google.com/share?url=\".urlencode($link).\"' target='_blank' style='display:block;float:left;padding:2px;padding-left:10px;padding-right:10px;background:#DB4B39;color:#FFF;'>Google+</a><a href='http://www.linkedin.com/shareArticle?mini=true&url=\".urlencode($link).\"&title=\".$title.\"' target='_blank' style='display:block;float:left;padding:2px;padding-left:10px;padding-right:10px;background:#0073B2;color:#FFF;'>Linked in</a></div>&nbsp;\\n\";\t\r\n }\r\n  /////////////////////////////////////////////FEUILLE DE STYLE + VALIDATION FORMULAIRE\r\n  function style_newsletter(){\r\n    global $wpdb,$newsletter_tb_name,$newsletter_plugin_url,$news_reg_return;\r\n    ?>\r\n<link rel=\"stylesheet\" type=\"text/css\" media=\"all\" href=\"<?=plugins_url( 'newsletter.css' , __FILE__ )?>\" />\r\n<?php\r\n    $query='';\r\n    if(isset($_POST['news_email'])){\r\n      $email = stripslashes($_POST['news_email']);\r\n      if (filter_var($email, FILTER_VALIDATE_EMAIL)) {\r\n      \t\r\n\t\t\r\n\t  $msg = get_option( 'newsletter_msg' ,array(\r\n\t\t'sender'=>'' ,\r\n\t\t'suscribe_title'=>'' ,\r\n\t\t'suscribe'=>'' ,\r\n\t\t'unsuscribe_title'=>'' ,\r\n\t\t'unsuscribe'=>'' \r\n\t\t));\t  \r\n\t  $sender = $msg['sender'];\r\n\t  $suscribe_title = $msg['suscribe_title'];\r\n\t  $suscribe = $msg['suscribe'];\r\n\t  $unsuscribe_title = $msg['unsuscribe_title'];\r\n\t  $unsuscribe = $msg['unsuscribe'];\r\n\t  \r\n        switch($_POST['news_action']){\r\n          case '1':\r\n            $ret =  $wpdb->get_results(\"SELECT * FROM `$newsletter_tb_name` WHERE `email`='\".str_replace(\"'\",\"''\",$email).\"'\");\r\n            if(is_array($ret) && sizeof($ret)>0){\r\n              $ret = $ret[0];\r\n              if($ret->parent==2){\r\n                $query=\"UPDATE $newsletter_tb_name SET `parent`='1' WHERE `email`='\".str_replace(\"'\",\"''\",$email).\"'\";\r\n                if($query!='' && false===$wpdb->query($query)){\r\n                  $news_reg_return.=__(\"An error occured !\", 'eelv_lettreinfo') ;\r\n                }\r\n                elseif($query!=''){\r\n                  $news_reg_return=__(\"You have been successfully re-registered\", 'eelv_lettreinfo');  \r\n\t\t\t\t  if(!empty($sender) && !empty($suscribe_title) && !empty($suscribe)){\r\n\t\t\t\t  \tmail($email,$suscribe_title,$suscribe,'From:'.$sender);\r\n\t\t\t\t  }              \r\n                }                \r\n              }\r\n              else{\r\n                $news_reg_return.=__(\"Your email is already registered in our mailing-list.\", 'eelv_lettreinfo') ;\r\n              }\r\n            }\r\n            else{\r\n              $query=\"INSERT INTO $newsletter_tb_name (`parent`,`nom`,`email`) \r\n                VALUES (1,'\".str_replace(\"'\",\"''\",substr($email,0,strpos($email,'@'))).\"','\".str_replace(\"'\",\"''\",$email).\"')\";\r\n              if($query!='' && false==$wpdb->query($query)){\r\n                $news_reg_return.=__(\"An error occured !\", 'eelv_lettreinfo');\r\n              }\r\n              elseif($query!=''){\r\n                $news_reg_return.=__(\"Thank you for your suscription\", 'eelv_lettreinfo');   \r\n\t\t\t\tif(!empty($sender) && !empty($suscribe_title) && !empty($suscribe)){\r\n\t\t\t\t  \tmail($email,$suscribe_title,$suscribe,'From:'.$sender);\r\n\t\t\t\t  }             \r\n              }\r\n            }\r\n            break;\r\n          case '0':\r\n            $ret =  $wpdb->get_results(\"SELECT * FROM `$newsletter_tb_name` WHERE `email`='\".str_replace(\"'\",\"''\",$email).\"'\");\r\n            if(is_array($ret) && sizeof($ret)>0){\r\n              $query=\"UPDATE $newsletter_tb_name SET `parent`='2' WHERE `email`='\".str_replace(\"'\",\"''\",$email).\"'\";\r\n              if($query!='' && false===$wpdb->query($query)){\r\n                $news_reg_return.=__(\"An error occured !\", 'eelv_lettreinfo');\r\n              }\r\n              elseif($query!=''){\r\n                $news_reg_return.=__(\"Thank you, your email have been deleted from our mailing-list\", 'eelv_lettreinfo'); \r\n\t\t\t\t  if(!empty($sender) && !empty($unsuscribe_title) && !empty($unsuscribe)){\r\n\t\t\t\t  \tmail($email,$unsuscribe_title,$unsuscribe,'From:'.$sender);\r\n\t\t\t\t  }                \r\n              }  \r\n            }\r\n            else{\r\n              $news_reg_return.=__(\"Your email does'nt appear in our mailing list. No unsuscribe needed\", 'eelv_lettreinfo');\r\n            }\r\n            break;\r\n         }\r\n      }\r\n      else{\r\n        $news_reg_return.= '<b>'.htmlspecialchars(strip_tags($email)).'</b> : '.__('invalid address', 'eelv_lettreinfo');\r\n      }\r\n    }\r\n  }\r\n  ////////////////////////////////////////////////////////////////////////////////////////////////////// FRONT OFFICE\r\n  function get_news_form($id=''){\r\n    global $wpdb,$newsletter_tb_name,$newsletter_plugin_url,$news_reg_return;\r\n\t$eelv_li_xs_archives = get_option('eelv_li_xs_archives',0);\r\n    ?>\r\n<form action=\"#\" method=\"post\" id=\"newsform<?=$id?>\" class=\"newsform\" onsubmit=\"if(this.news_email.value=='' || this.news_email.value=='newsletter : votre email'){ return false; }\">\r\n  <div>\r\n    <label class=\"screen-reader-text\" for=\"news_email<?=$id?>\"><?=__('Suscribe our newsletter', 'eelv_lettreinfo')?></label>\r\n    <input type=\"text\" name=\"news_email\" id=\"news_email<?=$id?>\" value=\"\" placeholder=\"newsletter : votre email\" onfocus=\"document.getElementById('news_hidden_option<?=$id?>').style.display='block';\"/>\r\n    <input type=\"submit\" value=\"ok\"/>        \r\n    <div id='news_hidden_option<?=$id?>' class='news_hidden_option'>\r\n      <label for='news_option_1<?=$id?>'><input type=\"radio\" name='news_action' value='1' id='news_option_1<?=$id?>' checked=\"checked\"/><?=__(\"Suscribe\", 'eelv_lettreinfo')?></label>\r\n      <label for='news_option_2<?=$id?>'><input type=\"radio\" name='news_action' value='0'  id='news_option_2<?=$id?>'/> <?=__(\"Unsuscribe\", 'eelv_lettreinfo')?></label>\r\n      <?php if($eelv_li_xs_archives==0){ ?>\r\n      <p><a href=\"/newsletter_archive/\"><?=__(\"Last newsletters\", 'eelv_lettreinfo')?></a></p>\r\n      <?php } ?>\r\n    </div>\r\n    <?php if($news_reg_return!=''){?>\r\n    <div class='news_return' id='news_return<?=$id?>' onclick=\"document.getElementById('news_return<?=$id?>').style.display='none';\">\r\n      <?=$news_reg_return?>\r\n    </div>            \r\n    <?php }  ?>\r\n  </div>\r\n</form>\r\n<?php\r\n  }\r\n\r\n/** Reply form **/\r\n/*\r\nadd_shortcode( 'eelv_news_answer' , 'eelv_get_news_answer_form' );\r\nfunction eelv_get_news_answer_form(){\r\n\tglobal $wpdb,$newsletter_tb_name,$newsletter_plugin_url,$news_reg_return;\r\n\tif(isset($_GET['v'])){\r\n\t\t$vien = $_GET['v'];\r\n\t\t$mail = $_GET['m'];\r\n\t\t$da = date(\"d/m/Y H:i\");\r\n\t\t$news = urldecode($_GET['n']);\r\n\t\tif($object==''){\r\n\t\t\t$object=\"Invitation inconnue\";\r\n\t\t}\r\n\t\techo'<h1>'.$object.'</h1>';\r\n\t\tif(ereg(\"@\",$mail) && $mail!=\"\" ){\r\n\t\t\t$fp = fopen('../results/hvsl.csv','a+');\r\n\t\t\tif(fwrite($fp,$object.';'.$mail.';'.$da.';'.$vien.';')){\r\n\t\t\t\techo'\r\n\t\t\t\t<h2>Votre r&eacute;ponse a bien &eacute;t&eacute; enregistr&eacute;e</h2>\r\n\t\t\t\t<p>'.$mail.' : '.$vien.'</p>';\r\n\t\t\t}\r\n\t\t\tfclose($fp);\r\n\t\t}\r\n\t\telse{\r\n\t\t\t\techo\"<form action='./' method='get'>\r\n\t\t\t\t<FONT color='#FF0066' size='3'>\r\n\t\t\t\t<input type='hidden' name='vien' value='$vien'><input type='hidden' name='object' value='$object'>\r\n\t\t\t\tS'il vous plait, renseignez votre adresse mail : <input type='text' name='mail' value=''>\r\n\t\t\t\t<input type='submit' value='ok'>\r\n\t\t\t\t</form><br><br><br>\r\n\t\t\t\t\";\r\n\t\t\t}\r\n\t}\r\n\telse{\r\n\t\techo\"$mail<br>D&eacute;sol&eacute; nous n'avons pas compris votre requete...\";\r\n\t}\r\n}\r\n*/\r\n\r\n/** Inscription form **/\r\nadd_shortcode( 'eelv_news_form' , 'get_news_large_form' );\r\n  function get_news_large_form(){\r\n    global $wpdb,$newsletter_tb_name,$newsletter_plugin_url,$news_reg_return;\r\n    $ret='\r\n      <form action=\"#\" method=\"post\" id=\"newslform\" onsubmit=\"if(this.news_email.value==\"\" || this.news_email.value==\"newsletter : votre email\"){ return false; }\">\r\n      <div>\r\n      <p>\r\n      <label for=\"news_l_email\">'.__('Your email:', 'eelv_lettreinfo').'</label>\r\n      <input type=\"text\" name=\"news_email\" id=\"news_l_email\" value=\"\" />\r\n      </p>        \r\n      <p>\r\n      <label for=\"news_l_option_1\">\r\n      <input type=\"radio\" name=\"news_action\" value=\"1\" id=\"news_l_option_1\" checked=\"checked\"/> '.__(\"Suscribe\", 'eelv_lettreinfo').'\r\n      </label>\r\n      </p>\r\n      <p>        \r\n      <label for=\"news_l_option_2\">\r\n      <input type=\"radio\" name=\"news_action\" value=\"0\"  id=\"news_l_option_2\"/> '.__('Unsuscribe', 'eelv_lettreinfo').'\r\n      </label>\r\n      </p>\r\n      <p><input type=\"submit\" value=\"'.__('ok', 'eelv_lettreinfo').'\"/></p>';\r\n    if($news_reg_return!=''){\r\n      $ret.='<div class=\"news_retour\">'.$news_reg_return.'</div>';            \r\n    }\r\n    $ret.='\r\n      <p><a href=\"/newsletter_archive/\">'.__(\"Last newsletters\", 'eelv_lettreinfo').'</a></p>\r\n      </div>\r\n      </form>';\r\n    return $ret;\r\n  }\r\n  ////////////////////////////////////////////////////////////////////////////////////////////////////// BACK OFFICE\r\n  function news_liste_groupes(){\r\n    global $newsletter_tb_name,$wpdb;\r\n    //newsletter_checkdb();\r\n    $querystr = \"SELECT `id`,`nom` FROM `$newsletter_tb_name` WHERE `parent`='0' ORDER BY `nom`\";\r\n    return $wpdb->get_results($querystr);  \r\n  }\r\n  function news_liste_contacts($groupe,$fields='`id`,`nom`,`email`'){\r\n    global $newsletter_tb_name,$wpdb;\r\n    if(is_array($groupe)){\r\n      $groupe = implode(\"' OR `parent`='\",$groupe);\r\n    }\r\n    $querystr = \"SELECT $fields FROM `$newsletter_tb_name` WHERE `parent`='$groupe' GROUP BY `email`ORDER BY `nom`\";\r\n    return $wpdb->get_results($querystr);    \r\n  }\r\n  /*****************************************************************************************************************************************\r\n  A D R E S S E S                                                           \r\n  *****************************************************************************************************************************************/\r\n  function news_carnet_adresse(){\r\n    global $newsletter_tb_name,$wpdb,$newsletter_plugin_url;\r\n    style_newsletter();\r\n    //newsletter_checkdb();\r\n    ?>\r\n<div class=\"wrap\">\r\n  <div id=\"icon-edit\" class=\"icon32 icon32-posts-newsletter\"><br/></div>\r\n  <h2><?=__(\"Newsletter\",'eelv_lettreinfo')?></h2>\r\n  <script>\r\n    function changegrp(form,url,grpname){\r\n      is_confirmed = confirm(\"<?php _e('Do you really want to move selected contacts to :', 'eelv_lettreinfo' ) ?> \"+grpname+\" ?\");\r\n      if (is_confirmed) {\r\n        form.action=url;\r\n        form.submit();\r\n      }  \r\n    }\r\n    function confsup(url,action){\r\n      is_confirmed = confirm(\"<?php _e('Do you really want to remove selected contacts ?', 'eelv_lettreinfo' ) ?>\");\r\n      if (is_confirmed) {\r\n        if(action==1){\r\n          document.location=url;\r\n        }\r\n        if(action==2){\r\n          url.submit();\r\n        }\r\n      }\r\n    }\r\n    function tout(ou,ki){\r\n      chs = ou.getElementsByTagName('input');\r\n      chi = ki.checked;\r\n      for(i=0 ; i<chs.length ; i++){\r\n        if(chs[i].type=='checkbox'){\r\n          chs[i].checked=chi;\r\n        }\r\n      }\r\n    }\r\n  </script>\r\n  <table class=\"widefat\" style=\"margin-top: 1em;\">\r\n    <thead>\r\n      <tr>\r\n        <th scope=\"col\" colspan=\"2\"><?php _e('Adress book', 'eelv_lettreinfo' ) ?></th>\r\n      </tr>\r\n    </thead>\r\n    <tbody>\r\n      <tr>\r\n        <td>\r\n          <?php\r\n  $for='liste';\r\n    $for2='liste';\r\n    $grp_id='';\r\n    $con_id='';\r\n    // Suppression de groupe\r\n    if(isset($_GET['delgroupe'])){\r\n      $for='liste';\r\n      $grp_id = $_GET['delgroupe'];\r\n      $query=\"DELETE FROM $newsletter_tb_name WHERE `id`='$grp_id' OR `parent`='$grp_id'\";\r\n      if(false===$wpdb->query($query)){\r\n        ?><div class=\"updated\"><p><strong><?php _e('An error occured, no group has been deleted !', 'eelv_lettreinfo' ) ?></strong></p></div><?php\r\n  }\r\n  else{\r\n  ?><div class=\"updated\"><p><strong><?php _e('Successful deletion !', 'eelv_lettreinfo' ) ?></strong></p></div><?php\r\n  }\r\n  $grp_id='';\r\n      }\r\n      // Supression de contacts\r\n      if(isset($_GET['delcontacts']) && isset($_GET['liste'])){\r\n        $grp_id = $_GET['liste'];\r\n        $MBRS = news_liste_contacts($grp_id);    \r\n        if(sizeof($MBRS)>0){\r\n          $ac = '`id`=0';\r\n          $nb=0;\r\n          foreach($MBRS as $contact){ \r\n            if(isset($_POST['contact_'.$contact->id])){\r\n              $ac.=' OR `id`='.$contact->id;\r\n              $nb++;\r\n            }\r\n          }\r\n          $query=\"DELETE FROM $newsletter_tb_name WHERE $ac\";\r\n          if(false===$wpdb->query($query)){\r\n            ?><div class=\"updated\"><p><strong><?php _e('An error occured, no contact has been deleted !', 'eelv_lettreinfo' ) ?></strong></p></div><?php\r\n  }\r\n  else{\r\n  ?><div class=\"updated\"><p><strong><?php printf(__('%s contacts deleted !', 'eelv_lettreinfo' ),$nb) ?></strong></p></div><?php\r\n  }\r\n  }\r\n  }\r\n  // deplacement de contacts\r\n  if(isset($_GET['ngrp']) && isset($_GET['liste'])){\r\n  $grp_id = $_GET['liste'];\r\n            $MBRS = news_liste_contacts($grp_id);    \r\n            if(sizeof($MBRS)>0){\r\n              $ac = '`id`=0';\r\n              $nb=0;\r\n              foreach($MBRS as $contact){ \r\n                if(isset($_POST['contact_'.$contact->id])){\r\n                  $ac.=' OR `id`='.$contact->id;\r\n                  $nb++;\r\n                }\r\n              }\r\n              $query=\"UPDATE $newsletter_tb_name SET `parent`='\".str_replace(\"'\",\"''\",$_GET['ngrp']).\"' WHERE $ac\";\r\n              if(false===$wpdb->query($query)){\r\n                ?><div class=\"updated\"><p><strong><?php _e('An error occured, no contact has been moved !', 'eelv_lettreinfo' ) ?></strong></p></div><?php\r\n  }\r\n  else{\r\n  ?><div class=\"updated\"><p><strong><?php printf(__('%s contacts succesfully moved !', 'eelv_lettreinfo' ),$nb) ?></strong></p></div><?php\r\n  }\r\n  }\r\n  }\r\n  if(isset($_GET['groupe'])){\r\n  $for='groupe';  \r\n                $grp_id = $_GET['groupe'];\r\n              }\r\n              if(isset($_GET['liste'])){\r\n                $for='liste';  \r\n                $grp_id = $_GET['liste'];\r\n              }  \r\n              if(isset($_GET['contact'])){\r\n                $for2='contact';  \r\n                $con_id = $_GET['contact'];\r\n              }\r\n              if(isset($_POST['grp_nom']) ){\r\n                $grp_nom = stripslashes($_POST['grp_nom']);\r\n                if(is_numeric($grp_id)){\r\n                  $query=\"UPDATE $newsletter_tb_name SET `nom`='\".str_replace(\"'\",\"''\",$grp_nom).\"' WHERE `id`='$grp_id'\";\r\n                }\r\n                else{\r\n                  $query=\"INSERT INTO $newsletter_tb_name (`nom`) VALUES ('\".str_replace(\"'\",\"''\",$grp_nom).\"')\";\r\n                }\r\n                if(false===$wpdb->query($query)){\r\n                  ?><div class=\"updated\"><p><strong><?php _e('An error occured...', 'eelv_lettreinfo' ) ?></strong></p></div><?php\r\n  }\r\n  else{\r\n  $for='liste';\r\n                  ?><div class=\"updated\"><p><strong><?php _e('Record saved', 'eelv_lettreinfo' ); ?></strong></p></div><?php      \r\n                }    \r\n              }\r\n              if(isset($_POST['con_nom']) && is_numeric($grp_id)  ){\r\n                $con_nom = stripslashes($_POST['con_nom']);\r\n                $con_email = stripslashes($_POST['con_email']);\r\n                if(is_numeric($con_id)){\r\n                  $query=\"UPDATE $newsletter_tb_name SET `nom`='\".str_replace(\"'\",\"''\",$con_nom).\"',`email`='\".str_replace(\"'\",\"''\",$con_email).\"' WHERE `id`='$con_id'\";\r\n                }\r\n                else{\r\n                  switch($_POST['import_type']){\r\n                    case 'unite':\r\n                      $query=\"INSERT INTO \".$newsletter_tb_name.\" (`parent`,`nom`,`email`) \r\n                        VALUES ('$grp_id','\".str_replace(\"'\",\"''\",$con_nom).\"','\".str_replace(\"'\",\"''\",$con_email).\"')\";\r\n                      break;\r\n                    case 'masse':\r\n                      $imp = preg_split('/[,;\\n\\t]/',stripslashes($_POST['con_mul'].','));\r\n                      $query='INSERT INTO '.$newsletter_tb_name.' (`parent`,`nom`,`email`) VALUES ';\r\n                      foreach($imp as $entry){\r\n                        $entry=trim($entry);\r\n                        if (filter_var($entry, FILTER_VALIDATE_EMAIL)) {\r\n                          $query.=\"              \r\n                            ('$grp_id','\".str_replace(\"'\",\"''\",substr($entry,0,strpos($entry,'@'))).\"','\".str_replace(\"'\",\"''\",$entry).\"'),\";\r\n                        }\r\n                        elseif($entry!=''){\r\n                          echo\"<p>$entry : adresse non valide</p>\";  \r\n                        }\r\n                      }\r\n                      $query = substr($query,0,-1);\r\n                      $query.=\"\";\r\n                      break;\r\n                    case 'file':\r\n                      ?><div class=\"updated\"><p><strong><?php _e('Functionality under development', 'eelv_lettreinfo' ) ?></strong></p></div><?php\r\n  break;\r\n                                              }\r\n                }\r\n                if($query!='' && false===$wpdb->query($query)){\r\n                  ?><div class=\"updated\"><p><strong><?php _e('An error occured !', 'eelv_lettreinfo' ) ?></strong></p></div><?php\r\n  }\r\n  elseif($query!=''){\r\n  ?><div class=\"updated\"><p><strong><?php _e('Record saved', 'eelv_lettreinfo' ); ?></strong></p></div><?php\r\n                }    \r\n                $for2='liste';\r\n                $for ='liste';  \r\n              }\r\n              // Edition de groupe\r\n              if($for=='groupe'){\r\n                $grp_nom = 'Nouveau groupe';\r\n                $action=\"edit.php?post_type=newsletter&page=news_carnet_adresse&groupe=new\";\r\n                if(is_numeric($grp_id)){\r\n                  $news_info = get_news_meta($grp_id);\r\n                  $grp_nom = $news_info->nom;\r\n                  $action=\"edit.php?post_type=newsletter&page=news_carnet_adresse&groupe=$grp_id\";\r\n                }\r\n                ?>\r\n          <?php _e('Edit group', 'eelv_lettreinfo' ) ?>\r\n          <form action='<?=$action;?>' method=\"post\">\r\n            <div id=\"titlediv\">\r\n              <div id=\"titlewrap\">               \r\n                <input type=\"text\" name=\"grp_nom\" size=\"30\" tabindex=\"1\" value=\"<?=$grp_nom;?>\" id=\"title\" autocomplete=\"off\"/>                \r\n              </div>\r\n              <input type='submit' value='<?php _e('Save options', 'eelv_lettreinfo' ) ?>' class=\"button-primary\"/>\r\n            </div>\r\n          </form>\r\n          <p>    <a href=\"edit.php?post_type=newsletter&page=news_carnet_adresse\" class=\"button add-new-h2\"><?php _e('cancel', 'eelv_lettreinfo' ) ?></a></p>\r\n          <?php\r\n  }\r\n  if($for=='liste'){\r\n  ////////////////////////////////////////////////////////////Listes\r\n  if(!is_numeric($grp_id)){ // groupes\r\n  $GRPS = news_liste_groupes();    \r\n                $nb_groups = sizeof($GRPS);\r\n                ?><h3 class=\"sectiontitle title3\"><?php _e('Groups', 'eelv_lettreinfo' ) ?></h3>  <a href=\"edit.php?post_type=newsletter&page=news_carnet_adresse&groupe=new\" class=\"button add-new-h2\"><?php _e('New group', 'eelv_lettreinfo' ) ?></a>    <?php\r\n  if($nb_groups>0){?>  \r\n          <table class='eelv_news_groups'>   \r\n            <?php\r\n  $coup=false;\r\n                foreach($GRPS as $groupe){ \r\n                  $nbinsc = sizeof(news_liste_contacts($groupe->id));                \r\n                  ?>      \r\n            <tr>\r\n              <td><a href='edit.php?post_type=newsletter&page=news_carnet_adresse&liste=<?=$groupe->id?>'><b><?=$groupe->nom?></b></a></td>\r\n              <td><b><?=$nbinsc?></b></td>\r\n              <td><a href='edit.php?post_type=newsletter&page=news_carnet_adresse&liste=<?=$groupe->id?>' class=\"button\"><?php _e('List', 'eelv_lettreinfo' ) ?></a></td>\r\n              <td><a href='edit.php?post_type=newsletter&page=news_carnet_adresse&groupe=<?=$groupe->id?>' class=\"button\"><?php _e('Rename', 'eelv_lettreinfo' ) ?></a></td>\r\n              <td><a onclick=\"confsup('edit.php?post_type=newsletter&page=news_carnet_adresse&delgroupe=<?=$groupe->id?>',1)\" class=\"button\"><?php _e('Delete', 'eelv_lettreinfo' ) ?></a></td>\r\n            </tr>      \r\n            <?php }  ?>\r\n          </table>\r\n          <?php\r\n  }\r\n  ?><p>&nbsp;</p><?php\r\n  }\r\n  else{ // contacts\r\n  $news_info = get_news_meta($grp_id);\r\n                  $grp_nom = $news_info->nom;\r\n                  $MBRS = news_liste_contacts($grp_id);    \r\n                  $nb_contacts = sizeof($MBRS);\r\n                  ?>\r\n          <h3 class=\"sectiontitle title3\"><a href='edit.php?post_type=newsletter&page=news_carnet_adresse'><?php _e('Groups', 'eelv_lettreinfo' ) ?></a> > <?=$grp_nom?></h3>  \r\n          <?php  \r\n  if($for2=='liste'){ // liste contact\r\n  ?>\r\n          <table class='eelv_news_groups'><tr><td>\r\n            <input type=\"checkbox\" onclick=\"tout(document.getElementById('liste_mel'),this)\"/>\r\n            <select onchange=\"eval(this.value)\">\r\n              <option value=\"\"><?php _e('Bulk actions', 'eelv_lettreinfo' ) ?></option>\r\n              <?php\r\n  $GRPS = news_liste_groupes();    \r\n                  $nb_groups = sizeof($GRPS);\r\n                  if($nb_groups>0){\r\n                    foreach($GRPS as $groupe){ \r\n                      if($groupe->id !=$grp_id){\r\n                        $nbinsc = sizeof(news_liste_contacts($groupe->id));                \r\n                        ?>      \r\n              <option value=\"changegrp(document.getElementById('liste_mel'),'edit.php?post_type=newsletter&page=news_carnet_adresse&liste=<?=$grp_id?>&ngrp=<?=$groupe->id?>','<?=$groupe->nom?>')\"><?php _e('Move to : ', 'eelv_lettreinfo' ) ?> <?=$groupe->nom?></option>\r\n              <?php } } }  ?>\r\n              <option value=\"confsup(document.getElementById('liste_mel'),2)\"><?php _e('Delete', 'eelv_lettreinfo' ) ?></option>\r\n            </select>\r\n            <a href='edit.php?post_type=newsletter&page=news_carnet_adresse' class=\"button\"><?php _e('Back', 'eelv_lettreinfo' ) ?></a>\r\n            <a href='edit.php?post_type=newsletter&page=news_carnet_adresse&liste=<?=$grp_id?>&contact=new' class=\"button-primary\"><?php _e('New recipient', 'eelv_lettreinfo' ) ?></a>\r\n            </td></tr></table>\r\n          <?php\r\n  if($nb_contacts>0){?>                \r\n          <form id='liste_mel' action=\"edit.php?post_type=newsletter&page=news_carnet_adresse&liste=<?=$grp_id?>&delcontacts\" method=\"post\">\r\n            <table class='eelv_news_groups'> \r\n              <?php\r\n  $coup=false;\r\n                        foreach($MBRS as $contact){ ?>      \r\n              <tr>\r\n                <td><input type=\"checkbox\" name=\"contact_<?=$contact->id?>\" value=\"1\" /></td>\r\n                <td><a href='edit.php?post_type=newsletter&page=news_carnet_adresse&liste=<?=$grp_id?>&contact=<?=$contact->id?>'><b><?=$contact->nom?></b></a></td>                         <td><a href='edit.php?post_type=newsletter&page=news_carnet_adresse&liste=<?=$grp_id?>&contact=<?=$contact->id?>'><b><?=$contact->email?></b></a></td>                       \r\n              </tr>      \r\n              <?php }  ?>\r\n            </table>\r\n          </form>\r\n          <?php\r\n                      }\r\n                      else{\r\n                         _e('No recipient have been selected', 'eelv_lettreinfo' ); \r\n                      }\r\n                      ?>\r\n          <?php\r\n                    }\r\n                    else{ // edit contact\r\n                      $con_nom = '';\r\n                      $action=\"edit.php?post_type=newsletter&page=news_carnet_adresse&liste=$grp_id&contact=new\";\r\n                      if(is_numeric($con_id)){\r\n                        $news_info = get_news_meta($con_id);\r\n                        $con_nom = $news_info->nom;\r\n                        $con_email = $news_info->email;\r\n                        $action=\"edit.php?post_type=newsletter&page=news_carnet_adresse&groupe=$grp_id&contact=$con_id\";\r\n                      }\r\n                      ?>  \r\n          <form action='<?=$action;?>' method=\"post\" enctype=\"multipart/form-data\">              \r\n            <ul>\r\n              <li>\r\n                <label for=\"imp_unite\">\r\n                  <h3><input type=\"radio\" name=\"import_type\" value='unite' id='imp_unite' checked=\"checked\" /> <?php _e('Edit contact', 'eelv_lettreinfo' ) ?></h3>\r\n                  <?php _e('Name', 'eelv_lettreinfo' ) ?>            \r\n                  <input type=\"text\" name=\"con_nom\" size=\"30\" value=\"<?=$con_nom;?>\" id=\"con_nom\" autocomplete=\"off\" onfocus=\"import_type[0].checked=true\"/>  \r\n                  <?php _e('E-mail', 'eelv_lettreinfo' ) ?>               \r\n                  <input type=\"email\" name=\"con_email\" size=\"30\" value=\"<?=$con_email;?>\" id=\"con_email\" autocomplete=\"off\" onfocus=\"import_type[0].checked=true\"/>\r\n                </label>\r\n              </li>\r\n              <?php if(!is_numeric($con_id)){ ?>\r\n              <li>\r\n                <label for=\"imp_masse\">\r\n                  <h3><input type=\"radio\" name=\"import_type\" value='masse' id='imp_masse' /> <?php _e('Mass copy', 'eelv_lettreinfo' ) ?></h3>\r\n                  <p><?php _e('Return separated email address', 'eelv_lettreinfo' ) ?></p>                       \r\n                  <textarea cols=\"50\" rows=\"10\" name=\"con_mul\" id=\"con_mul\" onfocus=\"import_type[1].checked=true\"></textarea>\r\n                </label> \r\n              </li>\r\n              <!--li>\r\n              <label for=\"imp_file\">\r\n              <h3><input type=\"radio\" name=\"import_type\" value='file' id='imp_file' /> Importer fichier csv</h3>\r\n              <p>Export depuis votre carnet d'adresse habituel... </p>\r\n              <input type='file'  accept=\"text/csv,text/plain\" name=\"con_file\" id=\"con_file\" onfocus=\"import_type[2].checked=true\"/>\r\n            </label>\r\n            </li-->                \r\n              <?php } ?>\r\n            </ul>\r\n            <a href='edit.php?post_type=newsletter&page=news_carnet_adresse&liste=<?=$grp_id?>' class=\"button\">Retour</a>\r\n            <input type=\"submit\" value='Enregistrer' class=\"button-primary\" />\r\n          </form>\r\n          <?php\r\n  }\r\n  }\r\n  }\r\n  ?>\r\n        </td></tr></tbody></table>\r\n</div>\r\n<?php\r\n  }\r\n  /*****************************************************************************************************************************************\r\n  E N V O I                                                                  \r\n  *****************************************************************************************************************************************/\r\n  function news_envoi(){\r\n  style_newsletter();\r\n                      //newsletter_checkdb();\r\n                      global $newsletter_tb_name,$wpdb,$newsletter_plugin_url;\r\n                      $default_exp = get_option( 'newsletter_default_exp' );\r\n                      $default_mel = get_option( 'newsletter_default_mel' );\r\n                      $desinsc_url = get_option( 'newsletter_desinsc_url' );\r\n                      ?>\r\n<div class=\"wrap\">\r\n  <div id=\"icon-edit\" class=\"icon32 icon32-posts-newsletter\"><br/></div>\r\n  <h2><?php _e('Newsletter', 'eelv_lettreinfo' ) ?></h2>\r\n  <table class=\"widefat\" style=\"margin-top: 1em;\">\r\n    <thead>\r\n      <tr>\r\n        <th scope=\"col\" colspan=\"2\">Envoi</th>\r\n      </tr>\r\n    </thead>\r\n    <tbody>\r\n      <tr>\r\n        <td>    \r\n          <?php\r\n  if(!isset($_GET['post']) || !is_numeric($_GET['post'])){\r\n  /////////////////////////////////// CHOIX DE LA LETTRE\r\n  $querystr = \"SELECT `ID`,`post_title` FROM `$wpdb->posts` WHERE `post_status` = 'publish' AND `post_type` = 'newsletter' ORDER BY `post_name`\";\r\n                      $res = $wpdb->get_results($querystr,ARRAY_N);\r\n                      if(sizeof($res)>0){\r\n                        ?><ul><?php\r\n                        foreach($res as $item){\r\n                          ?><li><a href=\"edit.php?post_type=newsletter&page=news_envoi&post=<?=$item[0]?>\"><?=$item[1]?></a></li><?php\r\n                        }\r\n                        ?></ul><?php    \r\n                      }\r\n                      else{\r\n                        ?>\r\n          <?php _e('No letter is in progress. to create one', 'eelv_lettreinfo' ) ?> <a href=\"post-new.php?post_type=newsletter\" class=\"button\"><?php _e('click here', 'eelv_lettreinfo' ) ?></a>\r\n          <?php    \r\n  }\r\n  }\r\n  else{\r\n  \t\t\t\t\t\t\t$post_id = $_GET['post'];\r\n                        $post = get_post( $post_id );\r\n                        if(isset($_GET['convert']) && is_numeric($_GET['convert'])){\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t$content=$post->post_content;\r\n\t\t\t\t\t\t\tif(isset($_GET['add_title'])){\r\n\t\t\t\t\t\t\t\t$content='<h1>'.$post->post_title.'</h1>'.$content;\t\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tif(isset($_GET['add_sharelinks'])){\r\n\t\t\t\t\t\t\t\t$content.=eelv_newsletter_sharelinks($post->post_title,$post->guid);\t\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\r\n                          if(0!== $new_post = wp_insert_post( array('post_type'=>'newsletter','post_title' => $post->post_title,  'post_content' => $content,  'post_status' => 'publish'))){\r\n                            add_post_meta($new_post, 'nl_template', $_GET['convert']);\r\n                            $post_id=$new_post;        \r\n                            $post = get_post( $new_post);\r\n                            echo\"Une lettre d'info a &eacute;t&eacute; cr&eacute;&eacute;e\";\r\n                          }\r\n                          else{\r\n                            echo \"Erreur de converstion...\";  \r\n                          }\r\n                        }\r\n                        if(isset($_GET['settemplate']) && is_numeric($_GET['settemplate'])){\r\n\t\t\t\t\t\t\tupdate_post_meta($post->ID,'nl_template',$_GET['settemplate']);\r\n\t\t\t\t\t\t}\r\n                        $content=nl_content($post_id); \r\n\t\t\t\t\t\t\r\n\r\n                        $template_id = get_post_meta($post->ID,'nl_template',true);\r\n                        /*$post = get_post( $post_id);\r\n                        $template =  get_post(get_post_meta($post_id,'nl_template',true));\r\n                        $content=str_replace('[newsletter]',(trim($post->post_content)),$template->post_content);\r\n                        $content=str_replace('[desinsc_url]',\"<a href='$desinsc_url' target='_blank' class='nl_a'>$desinsc_url</a>\",$content);\r\n                        */  \r\n                        if(!isset($_POST['send']) ){\r\n                          $user_info = get_userdata(get_current_user_id());\r\n                          /////////////////////////////////// CHOIX DES DESTINATAIRES\r\n                          ?>\r\n          <h3 class=\"sectiontitle title3\"><?php _e('Preview', 'eelv_lettreinfo' ) ?></h3>\r\n          <div class='eelv_news_frame' id=\"nl_preview\">\r\n            <?php\r\n  echo $content;\r\n                          ?></div>\r\n          <a href=\"post.php?post=<?=$post_id?>&action=edit\" class=\"button\"><?php _e('Edit', 'eelv_lettreinfo' ) ?></a> \r\n          <?php _e('Skin', 'eelv_lettreinfo' ) ?>: \r\n          <select name=\"newslettertemplate\" onchange=\"document.location='edit.php?post_type=newsletter&page=news_envoi&post=<?=$post_id?>&settemplate='+this.value+'#nl_preview';\">\r\n          \t<?php\r\n  $querystr = \"SELECT `ID` FROM $wpdb->posts WHERE post_status = 'publish' AND post_type = 'newsletter_template' ORDER BY `post_title`\";\r\n                      $IDS = $wpdb->get_col($querystr);  \r\n                      $templates_nb = sizeof($IDS);\r\n\r\n                      if($templates_nb>0){\r\n                        $my_temp=get_post_meta(get_the_ID(), 'nl_template',true);\r\n                        foreach($IDS as $item_id){ \r\n                          if($my_temp==NULL){\r\n                            add_post_meta(get_the_ID(), 'nl_template', $item_id);\r\n                            $my_temp=$item_id;\r\n                          }\r\n                          ?>\r\n    <option value=\"<?=$item_id;?>\" <?php if($item_id==$template_id){ echo' selected ';} ?>/> <?=get_the_title($item_id);?></option> \r\n      <?php }\r\n                      }\r\n                      ?>\r\n          </select>             \r\n          <form action=\"edit.php?post_type=newsletter&page=news_envoi&post=<?=$post_id?>#nl_preview\" method=\"post\" class='eelv_news'>\r\n            <input type=\"hidden\" name=\"send\" value=\"1\" />\r\n            <table><tr>\r\n              <td>\r\n                <h3 class=\"sectiontitle title3\"><?php _e('Headers', 'eelv_lettreinfo' ) ?></h3>\r\n                <p><label for=\"sujet\"><?php _e('Subject', 'eelv_lettreinfo' ) ?>               \r\n                  <input type=\"text\" name=\"eelv_news_sujet\" size=\"30\" tabindex=\"1\" value=\"<?=$post->post_title?>\" id=\"sujet\" autocomplete=\"off\" required/></label> </p>\r\n                <p><label for=\"exp\"><?php _e('Sender name', 'eelv_lettreinfo' ) ?>              \r\n                  <input type=\"text\" name=\"eelv_news_exp\" size=\"30\" tabindex=\"1\" value=\"<?=$default_exp?>\" id=\"exp\" autocomplete=\"off\" required/></label> </p>\r\n                <p><label for=\"mel\"><?php _e('Reply email', 'eelv_lettreinfo' ) ?>         \r\n                  <input type=\"email\" name=\"eelv_news_mel\" size=\"30\" tabindex=\"1\" value=\"<?=$default_mel?>\" id=\"mel\" autocomplete=\"off\" required/></label></p>\r\n                <p><label for=\"stat\"><?php _e('Archive stat', 'eelv_lettreinfo' ) ?>            \r\n                  <select name=\"eelv_news_stat\" id=\"stat\" required>\r\n                    <option value='publish'><?php _e('Published', 'eelv_lettreinfo' ) ?></option>\r\n                    <option value='private'><?php _e('private', 'eelv_lettreinfo' ) ?></option>\r\n                  </select>\r\n                  </label> </p>\r\n                 <p><label for=\"spy\"><?php _e('Reading tracking', 'eelv_lettreinfo' ) ?>            \r\n                  <select name=\"eelv_news_spy\" id=\"spy\" required>\r\n                    <option value='1'><?php _e('try to know if emails is readen', 'eelv_lettreinfo' ) ?></option>\r\n                    <option value='0'><?php _e('deactivated', 'eelv_lettreinfo' ) ?></option>\r\n                  </select>\r\n                  </label> </p>\r\n              </td>\r\n              <td>\r\n                <h3 class=\"sectiontitle title3\"><?php _e('Recipients', 'eelv_lettreinfo' ) ?></h3>\r\n                <table><tr>\r\n                  <td>\r\n                    <h4><?php _e('Groups', 'eelv_lettreinfo' ) ?></h4>                  \r\n                    <ul class='eelv_news_groups'>   \r\n                      <?php      \r\n  $GRPS = news_liste_groupes();\r\n                          foreach($GRPS as $groupe){ \r\n                            $nbinsc = sizeof(news_liste_contacts($groupe->id));        \r\n                            ?>      \r\n                      <li>\r\n                        <label  for='grp_<?=$groupe->id?>'>\r\n                          <input type=\"checkbox\" name='grp_<?=$groupe->id?>' id='grp_<?=$groupe->id?>' value='1'/>\r\n                          <b><?=$groupe->nom?></b>\r\n                          <i>(<?=$nbinsc?>)</i>\r\n                        </label>\r\n                      </li>      \r\n                      <?php }  ?>\r\n                    </ul>\r\n                  </td>\r\n                  <td>\r\n                    <h4><?php _e('blog users', 'eelv_lettreinfo' ) ?></h4>\r\n                    <ul class='eelv_news_groups'> \r\n                      <?php  \r\n  $result = count_users();\r\n                          foreach($result['avail_roles'] as $role => $count){        \r\n                            ?>      \r\n                      <li>\r\n                        <label  for='rol_<?=$role?>'>\r\n                          <input type=\"checkbox\" name='rol_<?=$role?>' id='rol_<?=$role?>' value='1'/>\r\n                          <b><?=__($role)?></b>\r\n                          <i>(<?=$count?>)</i>\r\n                        </label>\r\n                      </li>      \r\n                      <?php }  ?>\r\n                    </ul>\r\n                  </td>\r\n                  <td>\r\n                    <h4><?php _e('Additional recipients', 'eelv_lettreinfo' ) ?></h4>                  \r\n                    <textarea name=\"dests\" cols=\"30\" rows=\"5\"><?php echo $user_info->user_email; ?></textarea> \r\n\t\t\t\t\t<legend><?php _e('Return separated email address', 'eelv_lettreinfo' ) ?></legend>\r\n                  </td>\r\n                  </tr></table>\r\n              </td></tr></table>\r\n            <input type='submit' value='<?php _e( \"Send\", 'eelv_lettreinfo' ) ?>' class=\"button-primary\"/>\r\n          </form>\r\n          <?php\r\n  }\r\n  else{\r\n  /////////////////////////////////// ENVOI\r\n  $contacts='';\r\n                          // CUSTOM GROUPES\r\n                          $dest = array();\r\n                          $GRPS = news_liste_groupes();\r\n                          foreach($GRPS as $groupe){ \r\n                            if(isset($_POST['grp_'.$groupe->id])){\r\n                              array_push($dest,$groupe->id);\r\n                            }\r\n                          }\r\n                          $temp = news_liste_contacts($dest,'email');        \r\n                          foreach($temp as $contact){\r\n                            $contacts.=$contact->email.',';  \r\n                          }\r\n                          // USERS\r\n                          $result = count_users();\r\n                          foreach($result['avail_roles'] as $role => $count){\r\n                            if(isset($_POST['rol_'.$role])){\r\n                              $blogusers = get_users('blog_id='.$wpdb->blogid.'&orderby=nicename&role=$role');\r\n                              foreach ($blogusers as $user) {\r\n                                $contacts.=$user->user_email.',';\r\n                              }\r\n                            }\r\n                          }\r\n                          // UNITE\r\n                          $temp = preg_split('/[;,\\n\\t]/',$_POST['dests']);\r\n                          foreach($temp as $contact){\r\n                            if(trim($contact)!=''){\r\n                              $contacts.=trim($contact).',';  \r\n                            }\r\n                          }\r\n                          $contacts=implode(',',array_unique(explode(',',$contacts)));\r\n                          if(0=== $archive = wp_insert_post( array('post_type'=>'newsletter_archive','post_title' => $post->post_title,  'post_content' => $post->post_content,  'post_status' => $_POST['eelv_news_stat']))){\r\n                            echo __(\"An error occured !\",'eelv_lettreinfo');\r\n                          }\r\n                          else{\r\n                            add_post_meta($archive, 'sujet', $_POST['eelv_news_sujet']);\r\n                            add_post_meta($archive, 'nl_template', $template_id);\r\n                            add_post_meta($archive, 'expediteur', $_POST['eelv_news_exp']);\r\n                            add_post_meta($archive, 'reponse', $_POST['eelv_news_mel']);\r\n                            add_post_meta($archive, 'destinataires', $contacts);\r\n                            add_post_meta($archive, 'sentmails', '');\r\n                            add_post_meta($archive, 'lastsend', date('Y-m-d H:i:s'));\r\n                            add_post_meta($archive, 'nl_spy', $_POST['eelv_news_spy']);\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t  \r\n                            /* $my_postu = array(\r\n                            'post_title' => $post->post_title,\r\n                            'post_content' => $post->post_content,\r\n                            'post_type' => 'newsletter'\r\n                            );\r\n                            // Update the post into the database\r\n                            wp_update_post( $my_postu );*/\r\n                            echo __('Sending...','eelv_lettreinfo').\"\r\n                              <script>\r\n                              document.location='edit.php?post_type=newsletter_archive';\r\n                              </script>\r\n                              \".__(\"To view the delivery status, please go to\",'eelv_lettreinfo').\"\r\n                              <a href='edit.php?post_type=newsletter_archive'>\".__('archives','eelv_lettreinfo').\"</a>\r\n                              \";\r\n                          }\r\n                        }\r\n                      }\r\n                      ?>\r\n        </td></tr></tbody></table>\r\n</div>\r\n<?php  \r\n                    }\r\n                    function newsletter_save_postdata( $post_id ) {\r\n                      if ( defined( 'DOING_AUTOSAVE' ) && DOING_AUTOSAVE )      return;\r\n                      if ( isset($_REQUEST['newslettertemplate']) && $_REQUEST['newslettertemplate']!=''){\r\n                        update_post_meta($post_id, 'nl_template', $_REQUEST['newslettertemplate']);\r\n                      }\r\n                    } \r\n                    function newsletter_admin_prev() {\r\n                      $my_temp=get_post(get_post_meta(get_the_ID(), 'nl_template',true));\r\n                      $env=true;\r\n                      if(get_the_ID()==0){\r\n                        $env=false;\r\n                        echo\"<p>\".__(\"Your newsletter has'nt been saved yet\",'eelv_lettreinfo').\"</p>\";\r\n                      }\r\n                      if(get_the_title()==''){\r\n                        $env=false;\r\n                        echo\"<p>\".__(\"Your newsletter has no title\",'eelv_lettreinfo').\"</p>\";\r\n                      }\r\n                      if(!$my_temp){\r\n                        $env=false;\r\n                        echo\"<p>\".__(\"No skin applied\",'eelv_lettreinfo').\"</p>\";\r\n                      }\r\n                      if($env==true){\r\n                        echo'<p><a href=\"edit.php?post_type=newsletter&page=news_envoi&post='.get_the_ID().'#nl_preview\" class=\"button-primary\">'.__('Preview and send','eelv_lettreinfo').'</a></p>';\r\n                      }\r\n                    }\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n                    function newsletter_admin() {\r\n                      global $wpdb, $eelv_nl_content_themes;\r\n                      //newsletter_checkdb();\r\n                      //print_r($eelv_nl_content_themes);\r\n                      ?>\r\n<table><tr>\r\n  <td valign=\"top\">\r\n    <h4><?php _e('Skin', 'eelv_lettreinfo' ) ?></h4>\r\n    <?php\r\n  $querystr = \"SELECT `ID` FROM $wpdb->posts WHERE post_status = 'publish' AND post_type = 'newsletter_template' ORDER BY `post_title`\";\r\n                      $IDS = $wpdb->get_col($querystr);  \r\n                      $templates_nb = sizeof($IDS);\r\n\r\n                      if($templates_nb>0){\r\n                        $my_temp=get_post_meta(get_the_ID(), 'nl_template',true);\r\n                        foreach($IDS as $item_id){ \r\n                          if($my_temp==NULL){\r\n                            add_post_meta(get_the_ID(), 'nl_template', $item_id);\r\n                            $my_temp=$item_id;\r\n                          }\r\n                          ?>\r\n    <p><label for='nt_<?=$item_id;?>' onclick=\"set_default_content('dc_<?=$item_id;?>')\"><input type='radio' name='newslettertemplate' id='nt_<?=$item_id;?>' value='<?=$item_id;?>' <?php if($item_id==$my_temp){ echo' checked=checked ';} ?>/> <?=get_the_title($item_id);?></label><textarea id=\"dc_<?=$item_id;?>\" style=\"display:none;\"><?=$eelv_nl_content_themes[get_the_title($item_id)]?></textarea></p> \r\n      <?php }\r\n                      }\r\n                      ?>\r\n      </td><td valign=\"top\" style='padding-left:20px'>\r\n      <h4><?php _e('Insert some content', 'eelv_lettreinfo' ) ?></h4>\r\n      <script>\r\n        var IEbof=false;\r\n      </script>\r\n      <!--[if lt IE 9]>\r\n      <script>IEbof=true;</script>\r\n      <![endif]-->\r\n      <script>\r\n        function incontent(str){\r\n          if(IEbof){\r\n            switchEditors.go('content', 'html');\r\n            document.post.content.value+=str;\r\n            switchEditors.go('content', 'tinymce');\r\n          }\r\n          else{\r\n            document.post.content.value+=str;\r\n            if (document.all) {\r\n              value = str;\r\n              document.getElementById('content_ifr').name='content_ifr';\r\n              var ec_sel = document.getElementById('content_ifr').document.selection;\r\n              if(tinyMCE.activeEditor.selection){\r\n                tinyMCE.activeEditor.selection.setContent(str);\r\n              }\r\n              else if(tinyMCE.activeEditor){\r\n                tinyMCE.activeEditor.execCommand(\"mceInsertRawHTML\", false, str);\r\n              }\r\n              else if (ec_sel) {\r\n                var ec_rng = ec_sel.createRange();\r\n                ec_rng.pasteHTML(value);\r\n              }\r\n              else{\r\n              }\r\n            }\r\n            else{\r\n              document.getElementById('content_ifr').name='content_ifr';\r\n              if(document.content_ifr){\r\n                document.content_ifr.document.execCommand('insertHTML', false, str);\r\n              }\r\n              else if(document.getElementById('content_ifr').contentDocument){\r\n                document.getElementById('content_ifr').contentDocument.execCommand('insertHTML', false, str);\r\n              }\r\n              else if(tinyMCE.activeEditor.selection){\r\n                tinyMCE.activeEditor.selection.setContent(str);\r\n              }\r\n              else{\r\n                tinyMCE.activeEditor.execCommand(\"mceInsertRawHTML\", false, str);\r\n              }\r\n            }  \r\n          }\r\n        }\r\n        function set_default_content(ki){\r\n          ki = document.getElementById(ki);\r\n          if(ki.value && ki.value!=''){\r\n            if(confirm(\"<?php __('Do you want to load this skin\\'s default content ?\\n\\nWarning!\\n\\nYou will loose the current content.', 'eelv_lettreinfo' ) ?>\")){\r\n              str=ki.value;\r\n              switchEditors.go('content', 'html');\r\n              document.post.content.value=str;\r\n              switchEditors.go('content', 'tinymce');  \r\n            }\r\n          }\r\n        }\r\n      </script>\r\n      <?php\r\n  $querystr = \"\";\r\n                      $optis='<option value=\"\">'.__('Posts', 'eelv_lettreinfo' ).'</option>';\r\n                      wp_reset_query();\r\n                      query_posts(array('status'=>'publish','post_type'=>'post','posts_per_page'=>'-1'));\r\n                      if(have_posts()){  \r\n                        while(have_posts()){\r\n                          the_post();  \r\n                          ?>\r\n      <textarea id=\"nl_post_<?php the_ID();?>\" style=\"display:none\"><?php echo\"<div style='width:550px; margin:5px 0px;text-align:left;  clear:both; border-top:#CCC 1px dotted; padding-top:1em; margin-top:1em;'>\r\n  <a href='\".get_post_permalink().\"' style='text-decoration:none;color:#666666;'>\".get_the_post_thumbnail(get_the_ID(),array(550,100),array('style'=>'float:left; margin-right:10px;')).\"</a> <h3 style='margin:0px !important;'><a href='\".get_post_permalink().\"' style='text-decoration:none;color:#000000;'>\".get_the_title().\"</a></h3>\r\n  <a href='\".get_post_permalink().\"' style='text-decoration:none;color:#666666;'>\".substr(strip_tags(get_the_content()),0,300).\"...</a>\r\n  </div>&nbsp;\r\n  \"; ?></textarea>\r\n      <textarea id=\"nl_share_<?php the_ID();?>\" style=\"display:none\"><?php echo eelv_newsletter_sharelinks(get_the_title(),get_post_permalink()); ?></textarea>\r\n      <?php \r\n                          $optis.='<option value=\"'.get_the_ID().'\">'.substr(get_the_title(),0,70).'</option>';\r\n                        } ?> \r\n      <p><select name=\"nl_insert_post\" onchange=\"var nl_p_content=getElementById('nl_post_'+this.value).value; if(document.getElementById('nl_with_share').checked==true){nl_p_content+=getElementById('nl_share_'+this.value).value}incontent(nl_p_content);this.value=''\">\r\n        <?=$optis?>\r\n        </select>\r\n      </p>\r\n      <?php  }\r\n                      \r\n                      $optis='<option value=\"\">'.__('Pages', 'eelv_lettreinfo' ).'</option>';\r\n                      wp_reset_query();\r\n                      query_posts(array('status'=>'publish','post_type'=>'page','posts_per_page'=>'-1'));\r\n                      if(have_posts()){  \r\n                        while(have_posts()){\r\n                          the_post();  \r\n                          ?>\r\n      <textarea id=\"nl_page_<?php the_ID();?>\" style=\"display:none\"><?php echo\"<div style='width:550px; margin:5px 0px;text-align:left;  clear:both; border-top:#CCC 1px dotted; padding-top:1em; margin-top:1em;'>\r\n  <a href='\".get_post_permalink().\"' style='text-decoration:none;color:#666666;'>\".get_the_post_thumbnail(get_the_ID(),array(550,100),array('style'=>'float:left; margin-right:10px;')).\"</a> <h3 style='margin:0px !important;'><a href='\".get_post_permalink().\"' style='text-decoration:none;color:#000000;'>\".get_the_title().\"</a></h3>\r\n  <a href='\".get_post_permalink().\"' style='text-decoration:none;color:#666666;'>\".substr(strip_tags(get_the_content()),0,300).\"...</a>\r\n  </div>&nbsp;\r\n  \"; ?></textarea>\r\n      \r\n      <?php \r\n                          $optis.='<option value=\"'.get_the_ID().'\">'.substr(get_the_title(),0,70).'</option>';\r\n                        } ?> \r\n      <p><select name=\"nl_insert_page\" onchange=\"incontent(getElementById('nl_page_'+this.value).value);this.value=''\">\r\n        <?=$optis?>\r\n        </select></p>\r\n      <?php  }\r\n                      ?>\r\n      <label for=\"\">\r\n        <input type=\"checkbox\" id=\"nl_with_share\" checked=\"checked\"/><?=__('Add share links', 'eelv_lettreinfo' )?>\r\n      </label>\r\n      </td></tr></table>\r\n      <?php\r\n                    }\r\n                    function newsletter_archive_admin() {\r\n                      global $wpdb,$newsletter_plugin_url;\r\n                      $post_id = get_the_ID(); //$_GET['id'];\r\n                      $my_temp=get_post_meta($post_id, 'nl_template',true);\r\n                      $sujet = get_post_meta($post_id, 'sujet', true);\r\n                      $expediteur = get_post_meta($post_id, 'expediteur', true);\r\n                      $reponse = get_post_meta($post_id, 'reponse' ,true);\r\n                      $lastsend = get_post_meta($post_id, 'lastsend',true);  \r\n                      // $post = get_post( $post_id);\r\n                      $template =  get_post(get_post_meta($post_id,'nl_template',true));\r\n                      $content=nl_content($post_id );   ?>\r\n      <h2><?=$sujet?></h2>\r\n      <?php if(!$template){ ?>\r\n      <?php _e('The skin has gone away ! Do you want to apply another one ?', 'eelv_lettreinfo' ) ?>\r\n      <select name=\"newslettertemplate\">\r\n        <option></option>\r\n        <?php\r\n  $querystr = \"SELECT `ID` FROM $wpdb->posts WHERE post_status = 'publish' AND post_type = 'newsletter_template' ORDER BY `post_title`\";\r\n$IDS = $wpdb->get_col($querystr);  \r\n$templates_nb = sizeof($IDS);\r\nif($templates_nb>0){\r\n  $my_temp=get_post_meta(get_the_ID(), 'nl_template',true);\r\n  foreach($IDS as $item_id){ \r\n    if($my_temp==NULL){\r\n      add_post_meta(get_the_ID(), 'nl_template', $item_id);\r\n      $my_temp=$item_id;\r\n    }\r\n    ?>\r\n        <option value='<?=$item_id;?>'><?=get_the_title($item_id);?></option> \r\n        <?php }\r\n}\r\n?></select>\r\n      <?php } ?>\r\n      <p><?php _e('Sent by','eelv_lettreinfo') ?> : <?=$expediteur?> (<?=$reponse?>)</p>\r\n      <p><?php _e('Last sent','eelv_lettreinfo') ?> : <?=$lastsend?></p>\r\n      <div><?=$content?></div>\r\n      <?php \r\n                    }\r\n                    function newsletter_archive_admin_dest() {\r\n                      global $wpdb,$newsletter_plugin_url;\r\n                      $post_id = get_the_ID(); //$_GET['id'];\r\n                      $sent = get_post_meta($post_id, 'sentmails',true);\r\n\t\t\t\t\t  $nl_spy=get_post_meta($post_id, 'nl_spy',true);\r\n\t\t\t\t\t  $lus = abs(substr_count($sent,':3'));\r\n\t\t  \t\t\t $tot = abs(substr_count($sent,','));\r\n                      ?>    \r\n                    <p><?php  printf(__('%s opened','eelv_lettreinfo'),round($lus/$tot*100).'%'); ?></p>\r\n      <p><ul id=\"eelv_nl_sentlist\"><?php \r\n                      echo '<li data-email=\"'.str_replace(\r\n                        array(\r\n\t\t\t\t\t\t  ',',\t\r\n                          ':',\r\n                        ),\r\n                        array(\r\n\t\t\t\t\t\t  '\"></li><li data-email=\"',\r\n                          '\" class=\"eelv_nl_sent eelv_nl_status_',\r\n                        ),\r\n                        $sent).'\">&nbsp;</li>';\r\n                      \r\n                      ?></ul>\r\n                      <?php if($nl_spy==0) _e('No reading-tracking','eelv_lettreinfo'); ?>\r\n                      </p>\r\n\t\t\t\t\t  <style>\r\n\t\t\t\t\t  #eelv_nl_sentlist li.eelv_nl_sent{\r\n\t\t\t\t\t\tdisplay:inline-block;\r\n\t\t\t\t\t\twidth:26%;\r\n\t\t\t\t\t\tpadding:7px 1px 7px 40px;\r\n\t\t\t\t\t\tmargin:2px;\r\n\t\t\t\t\t\tbackground-position: 6px 6px;\r\n\t\t\t\t\t\tbackground-repeat:no-repeat;\r\n\t\t\t\t\t\tbackground-color:#FFF;\r\n\t\t\t\t\t\tborder:#CCC 1px outset;\r\n\t\t\t\t\t\tborder-radius:5px;\r\n\t\t\t\t\t\tbox-shadow:rgba(0,0,0,0.2) 0px 2px 3px; \r\n\t\t\t\t\t  }\r\n\t\t\t\t\t  #eelv_nl_sentlist li.eelv_nl_status_-1{\r\n\t\t\t\t\t\tbackground-image:url(<?=$newsletter_plugin_url?>/eelv-newsletter/img/-1.jpg);\r\n\t\t\t\t\t\tcolor:#900;\r\n\t\t\t\t\t  }\r\n\t\t\t\t\t  #eelv_nl_sentlist li.eelv_nl_status_0{\r\n\t\t\t\t\t\tbackground-image:url(<?=$newsletter_plugin_url?>/eelv-newsletter/img/0.jpg);\r\n\t\t\t\t\t\tcolor:#900;\r\n\t\t\t\t\t  }\r\n\t\t\t\t\t  #eelv_nl_sentlist li.eelv_nl_status_1{\r\n\t\t\t\t\t\tbackground-image:url(<?=$newsletter_plugin_url?>/eelv-newsletter/img/1.jpg);\r\n\t\t\t\t\t\tcolor:#030;\r\n\t\t\t\t\t  }\r\n\t\t\t\t\t  #eelv_nl_sentlist li.eelv_nl_status_2{\r\n\t\t\t\t\t\tbackground-image:url(<?=$newsletter_plugin_url?>/eelv-newsletter/img/2.jpg);\r\n\t\t\t\t\t\tcolor:#900;\r\n\t\t\t\t\t  }\r\n\t\t\t\t\t  #eelv_nl_sentlist li.eelv_nl_status_3{\r\n\t\t\t\t\t\tbackground-image:url(<?=$newsletter_plugin_url?>/eelv-newsletter/img/3.jpg);\r\n\t\t\t\t\t\tborder:#0F0 1px outset;\r\n\t\t\t\t\t\tcolor:#0C0;\r\n\t\t\t\t\t  }\r\n\t\t\t\t\t  \r\n\t\t\t\t\t  </style>\r\n                      <script>\r\n\t\t\t\t\t  jQuery(document).ready(function(e) {\r\n                        jQuery('#eelv_nl_sentlist').children('li').each(function(index, element) {\r\n\t\t\t\t\t\t\tif(jQuery(this).data('email')!=''){\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t  \t\t\tjQuery(this).html(jQuery(this).data('email')).click(function(){\r\n\t\t\t\t\t\t\t\t\t<?php if($nl_spy==1): ?>\r\n\t\t\t\t\t\t\t\t\tjQuery.ajax({\r\n\t\t\t\t\t\t\t\t\t\ttype: 'POST',\r\n\t\t\t\t\t\t\t\t\t\turl:'<?=$newsletter_plugin_url?>/eelv-newsletter/reading/check.php?i=<?=$post_id?>&m='+jQuery(this).data('email'),\r\n\t\t\t\t\t\t\t\t\t\tdataType: 'json',\r\n\t\t\t\t\t\t\t\t\t\tasync: false,\r\n\t\t\t\t\t\t\t\t\t\tsuccess: function (k) {\r\n\t\t\t\t\t\t\t\t\t\t\tvar txt='';\r\n\t\t\t\t\t\t\t\t\t\t\tfor(var i=0 ; i<k.length ; i++){\r\n\t\t\t\t\t\t\t\t\t\t\t  txt+='<?=str_replace('\\'','\\\\\\'',__('Read on :','eelv_lettreinfo'))?> '+k[i]['date']+'\\n';\t\t\t\t\t\t\t\t\t\t\t  \r\n\t\t\t\t\t\t\t\t\t\t\t  txt+='<?=str_replace('\\'','\\\\\\'',__('On :','eelv_lettreinfo'))?> '+k[i]['user_agent']+'\\n';\r\n\t\t\t\t\t\t\t\t\t\t\t  txt+='<?=str_replace('\\'','\\\\\\'',__('From IP address :','eelv_lettreinfo'))?> '+k[i]['ip']+'\\n';\r\n\t\t\t\t\t\t\t\t\t\t\t  txt+='\\n\\n'; \r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\tif(txt==''){\r\n\t\t\t\t\t\t\t\t\t\t\t\ttxt='<?=str_replace('\\'','\\\\\\'',__('Unread','eelv_lettreinfo'))?> ';\t\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\talert(txt);\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t});\t\r\n\t\t\t\t\t\t\t\t\t<?php endif; ?>\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t}\r\n                    \t});\r\n                    });\r\n\t\t\t\t\t  \r\n\t\t\t\t\t  </script>\r\n      <?php \r\n                    }\r\n                    function newsletter_archive_admin_queue() {\r\n                      global $wpdb,$newsletter_plugin_url;\r\n                      $post_id = get_the_ID(); //$_GET['id'];\r\n                      $dest = get_post_meta($post_id, 'destinataires',true);\r\n                      ?>    \r\n      <p><?=$dest?></p>\r\n      <?php if($dest!=''){ ?>\r\n      <a href='edit.php?post=<?=$post_id?>&action=edit&ref=<?=time()?>'><?=__('Automatically sending a new burst','eelv_lettreinfo')?></a>\r\n      <script>\r\n        document.location='edit.php?post=<?=$post_id?>&action=edit&ref=<?=time()?>';\r\n      </script>\r\n      <?php }\r\n                    }\r\n                    ///////////////////////////////////// CHECK DB\r\n                    function newsletter_checkdb(){\r\n                      ?>\r\n      <div class=\"wrap\">\r\n        <div id=\"icon-edit\" class=\"icon32 icon32-posts-newsletter\"><br/></div>\r\n        <h2><?php _e('Newsletter', 'eelv_lettreinfo' ) ?></h2>\r\n        <table class=\"widefat\" style=\"margin-top: 1em;\">\r\n          <thead>\r\n            <tr>\r\n              <th scope=\"col\" colspan=\"2\"><?php _e('Reload parameters', 'eelv_lettreinfo' ) ?></th>\r\n            </tr>\r\n          </thead>\r\n          <tbody>\r\n            <tr>\r\n              <td>\r\n                <?php\r\n  global $newsletter_tb_name,$wpdb,$newsletter_plugin_url,$eelv_nl_default_themes;\r\n                      // GROUPE NON CLASSE\r\n                      $ret =  $wpdb->get_results(\"SELECT * FROM `$newsletter_tb_name` WHERE `id`='1'\");?>\r\n                     <h3><?php _e('Address book','eelv_lettreinfo'); ?></h3>\r\n                      <p><?php _e('Uncategorized group :','eelv_lettreinfo'); ?>\r\n                     <?php if(is_array($ret) && sizeof($ret)>0){\r\n                        $query=\"UPDATE $newsletter_tb_name SET `nom`='Non class&eacute;s',`email`='',`parent`='0' WHERE `id`='1'\";\r\n                        _e('ok','eelv_lettreinfo');\r\n                      }\r\n                      else{\r\n                        $query=\"INSERT INTO $newsletter_tb_name (`id`,`nom`) VALUES ('1','Non class&eacute;s')\";\r\n                        _e('Created','eelv_lettreinfo');\r\n                      }\r\n\t\t\t\t\t\t?>\r\n\t\t\t\t\t\t</p>\r\n\t\t\t\t\t\t<?php\r\n                     \r\n                      $wpdb->query($query);\r\n                      // GROUPE RED LIST\r\n                      echo'<p>'.__('Red list group :','eelv_lettreinfo').' ';\r\n                      $ret =  $wpdb->get_results(\"SELECT * FROM `$newsletter_tb_name` WHERE `id`='2'\");\r\n                      if(is_array($ret) && sizeof($ret)>0){\r\n                        $query=\"UPDATE $newsletter_tb_name SET `nom`='Liste rouge',`email`='',`parent`='0' WHERE `id`='2'\";\r\n                        _e('ok','eelv_lettreinfo');\r\n                      }\r\n                      else{\r\n                        $query=\"INSERT INTO $newsletter_tb_name (`id`,`nom`) VALUES ('2','Liste rouge')\";\r\n                        _e('Created','eelv_lettreinfo');\r\n                      }\r\n                      echo'  </p>';\r\n                      $wpdb->query($query);\r\n                      // THEMES PAR DEFAUT\r\n                      echo'<h3>'.__('Default skins','eelv_lettreinfo').'</h3>';\r\n                      foreach($eelv_nl_default_themes as $check_theme=>$check_content){\r\n                        echo'<p><b>'.$check_theme.'</b> : ';\r\n                        $req=\"SELECT * FROM $wpdb->posts WHERE post_type = 'newsletter_template' AND `post_status`='publish' AND `post_title`='$check_theme'\";\r\n                        $ret =  $wpdb->get_results($req);\r\n                        if(is_array($ret) && sizeof($ret)>0){\r\n                          if(sizeof($ret)>1){      \r\n                            $wpdb->query(\"DELETE FROM `$wpdb->posts` WHERE `post_type`='newsletter_template' AND `post_status`='publish'  AND `post_title`='$check_theme'\");\r\n                          }\r\n                          $my_postb = array(\r\n                            'ID' => $ret[0]->ID,\r\n                            'post_content' => $check_content\r\n                          );\r\n                          wp_update_post( $my_postb );\r\n                          echo'mise \u00e0 jour ok';\r\n                        }\r\n                        else{\r\n                          $my_posta = array(\r\n                            'post_type' => 'newsletter_template',\r\n                            'post_title' => $check_theme,\r\n                            'post_content' => $check_content,\r\n                            'post_status' => 'publish'\r\n                          );\r\n                          wp_insert_post( $my_posta );\r\n                          echo'ajout ok';\r\n                        }\r\n                        echo'</p>';\r\n                      } ?>\r\n              </td></tr></tbody></table></div>\r\n      <?php\r\n                    }\r\n                    ///////////////////////////////////// SEMI CRON AUTO SEND\r\n                    function newsletter_autosend(){\r\n                      global $newsletter_tb_name,$wpdb,$newsletter_plugin_url,$eelv_nl_default_themes;\r\n                      $querystr = \"SELECT $wpdb->posts.`ID` FROM $wpdb->posts,$wpdb->postmeta WHERE (post_status = 'publish' OR post_status = 'private') AND post_type = 'newsletter_archive'  AND $wpdb->postmeta.`post_id`=$wpdb->posts.`ID` AND $wpdb->postmeta.`meta_key`='destinataires' AND $wpdb->postmeta.`meta_value`!=''\";\r\n                      $IDS = $wpdb->get_col($querystr);  \r\n                      $send_nb = sizeof($IDS);\r\n                      if($send_nb>0){\r\n                        $desinsc_url = get_option( 'newsletter_desinsc_url' );\r\n                        $env=0;\r\n                        foreach($IDS as $post_id){ \r\n                          $my_temp=get_post_meta($post_id, 'nl_template',true);\r\n                          $sujet = get_post_meta($post_id, 'sujet', true);\r\n                          $expediteur = get_post_meta($post_id, 'expediteur', true);\r\n                          $reponse = get_post_meta($post_id, 'reponse' ,true);\r\n                          $dests = get_post_meta($post_id, 'destinataires',true);\r\n                          $nl_spy = get_post_meta($post_id, 'nl_spy',true);\r\n                          if(substr($dests,0,1)==',') $dests=substr($dests,1);\r\n                          $dests = explode(',',$dests);\r\n                          $sent = get_post_meta($post_id, 'sentmails',true);  \r\n                          $template=get_post($my_temp);\r\n                          if($template){\r\n                            $content = \"<center><a href='\".home_url().\"/?post_type=newsletter_archive&p=\".$post_id.\"' target='_blank'><font size='1'>\".__('Click here if you cannot read this e-mail','eelv_lettreinfo').\"</font></a></center>\".nl_content($post_id);\r\n                            $prov = getenv(\"SERVER_NAME\");\r\n                            $eol=\"\\n\";\r\n                            $now = time();\r\n                            $headers = \"From: $expediteur <$reponse>\".$eol;\r\n                            $headers .= \"Reply-To: $expediteur <$reponse>\".$eol;\r\n                            $headers .= \"Return-Path: $expediteur <$reponse>\".$eol;    \r\n                            $headers .= \"Message-ID: <\".$post_id.\"@\".$prov.\">\".$eol;\r\n                            $headers .= \"X-Mailer: PHP v\".phpversion().$eol;         \r\n                            $mime_boundary=\"----=_NextPart_\".md5(time());\r\n                            $headers .= 'MIME-Version: 1.0'.$eol;\r\n                            $headers .= \"Content-Type: text/html; charset=\\\"utf-8\\\"; Content-Transfer-Encoding: quoted-printable; boundary=\\\"\".$mime_boundary.\"\\\"\".$eol;\r\n                            //print_r($dests);    \r\n                            $newsletter_admin_surveillance = get_site_option( 'newsletter_admin_surveillance' );\r\n                            if($newsletter_admin_surveillance!=''){\r\n                              mail($newsletter_admin_surveillance,'[EELV-newsletter:'.__('Sending','eelv_lettreinfo').'] '.$sujet,$content,$headers);\r\n                            }\r\n                            while($dest = array_shift($dests)){\r\n                              $dest=trim($dest);\r\n                              if (filter_var($dest, FILTER_VALIDATE_EMAIL)) {\r\n                                $ret = $wpdb->get_results(\"SELECT * FROM `$newsletter_tb_name` WHERE `email`='\".str_replace(\"'\",\"''\",$dest).\"' AND `parent`='2' LIMIT 0,1\");\r\n                                if(is_array($ret) && sizeof($ret)==0){             // White liste OK            \r\n                                  if( update_post_meta($post_id, 'destinataires',implode(',',$dests)) ){\r\n\t\t\t\t\t\t\t\t\t$the_content=$content;\r\n\t\t\t\t\t\t\t\t\tif($nl_spy==1){\r\n\t\t\t\t\t\t\t\t\t\t  $the_content.='<a href=\"'.get_bloginfo('url').'\"><img src=\"'.$newsletter_plugin_url.'/eelv-newsletter/reading/'.base64_encode($dest.'!'.$post_id).'/logo.png\" border=\"none\" alt=\"'.get_bloginfo('url').'\"/></a>';\r\n\t\t\t\t\t\t\t\t\t  }\r\n                                    if(mail($dest,$sujet,$the_content,$headers)){  // Envoi OK\r\n                                      $sent = $dest.':1,'.$sent;\r\n                                    }\r\n                                    else{                    // Envoi KO\r\n                                      $sent = $dest.':0,'.$sent;\r\n                                    }\r\n                                    update_post_meta($post_id, 'sentmails',$sent);\r\n                                    $env++;\r\n                                  }\r\n                                }\r\n                                elseif(is_array($ret) && sizeof($ret)==1){           // Black list\r\n                                  $sent = $dest.':2,'.$sent;\r\n                                  update_post_meta($post_id, 'destinataires',implode(',',$dests));\r\n                                  update_post_meta($post_id, 'sentmails',$sent);\r\n                                }\r\n                                else{                         // Envoi OK\r\n                                  $sent = $dest.':0+,'.$sent;\r\n                                  update_post_meta($post_id, 'destinataires',implode(',',$dests));\r\n                                  update_post_meta($post_id, 'sentmails',$sent);\r\n                                }\r\n                              }\r\n                              else{            // Mail invalide\r\n                                $sent = $dest.':-1,'.$sent;\r\n                                update_post_meta($post_id, 'destinataires',implode(',',$dests));\r\n                                update_post_meta($post_id, 'sentmails',$sent);\r\n                              }\r\n                              if($env>100){\r\n                                break 2;\r\n                              }\r\n                            }\r\n                          }\r\n                        }\r\n                      }\r\n                    }\r\n                    /*****************************************************************************************************************************************\r\n                    C O N F I G U R A T I O N                                            *****************************************************************************************************************************************/\r\nfunction newsletter_network_configuration(){\r\n  if( $_REQUEST[ 'type' ] == 'update' ) {    \r\n\tupdate_site_option( 'newsletter_admin_surveillance', $_REQUEST['newsletter_admin_surveillance'] );      \r\n\t?>\r\n<div class=\"updated\"><p><strong><?php _e('Options saved', 'eelv_lettreinfo' ); ?></strong></p></div>\r\n<?php \r\n  }\r\n  $newsletter_admin_surveillance = get_site_option( 'newsletter_admin_surveillance' );\r\n  ?>  \r\n      <div class=\"wrap\">\r\n        <div id=\"icon-edit\" class=\"icon32 icon32-posts-newsletter\"><br/></div>\r\n        <h2><?=_e('Newsletter', 'eelv_lettreinfo' )?></h2>\r\n        <form name=\"typeSite\" method=\"post\" action=\"<?php echo str_replace( '%7E', '~', $_SERVER['REQUEST_URI']); ?>\">  \r\n          <input type=\"hidden\" name=\"type\" value=\"update\">\r\n          <table class=\"widefat\" style=\"margin-top: 1em;\">\r\n            <thead>\r\n              <tr>\r\n                <th scope=\"col\" colspan=\"2\"><?= __( 'Configuration ', 'menu-config' ) ?></th>\r\n              </tr>\r\n            </thead>\r\n            <tbody>\r\n              <tr>\r\n                <td width=\"30%\">\r\n                  <label for=\"newsletter_default_exp\"><?=_e('Send a copy of each burst of shipments to:', 'eelv_lettreinfo' )?> :</label>\r\n                </td><td>\r\n                <input  type=\"text\" name=\"newsletter_admin_surveillance\"  size=\"60\"  id=\"newsletter_admin_surveillance\"  value=\"<?=$newsletter_admin_surveillance?>\" class=\"wide\">\r\n                </td>\r\n              </tr>\r\n              <tr>\r\n                <td colspan=\"2\">\r\n                  <p class=\"submit\">\r\n                    <input type=\"submit\" name=\"Submit\" value=\"<?php _e('Save', 'eelv_lettreinfo' ) ?>\" />\r\n                  </p>                    \r\n                </td>\r\n              </tr>\r\n            </tbody>\r\n          </table>\r\n        </form>\r\n      </div>\r\n      <?php\r\n}\r\n// mt_toplevel_page() displays the page content for the custom Test Toplevel menu\r\nfunction newsletter_page_configuration() {\r\n  global $newsletter_plugin_url,$wpdb;\r\n  if( $_REQUEST[ 'type' ] == 'update' ) {    \r\n\tupdate_option( 'newsletter_default_exp', $_REQUEST['newsletter_default_exp'] );\r\n\tupdate_option( 'newsletter_default_mel', $_REQUEST['newsletter_default_mel'] );\r\n\tupdate_option( 'newsletter_desinsc_url', $_REQUEST['newsletter_desinsc_url'] );\r\n\tupdate_option( 'newsletter_reply_url', $_REQUEST['newsletter_reply_url'] );\r\n\t\r\n\tupdate_option( 'newsletter_msg', array(\r\n\t\t'sender'=>$_REQUEST['newsletter_msg_sender'] ,\r\n\t\t'suscribe_title'=>$_REQUEST['newsletter_msg_suscribe_title'] ,\r\n\t\t'suscribe'=>$_REQUEST['newsletter_msg_suscribe'] ,\r\n\t\t'unsuscribe_title'=>$_REQUEST['newsletter_msg_unsuscribe_title'] ,\r\n\t\t'unsuscribe'=>$_REQUEST['newsletter_msg_unsuscribe'] \r\n\t));\r\n\tupdate_option( 'affichage_NL_hp', $_REQUEST['affichage_NL_hp'] );\r\n\t?>\r\n<div class=\"updated\"><p><strong><?php _e('Options saved', 'eelv_lettreinfo' ); ?></strong></p></div>\r\n<?php \r\n  }  \r\n  $default_exp = get_option( 'newsletter_default_exp' );\r\n  $default_mel = get_option( 'newsletter_default_mel' );\r\n  $desinsc_url = get_option( 'newsletter_desinsc_url' );\r\n  $reply_url = get_option( 'newsletter_reply_url' );\r\n  $affichage_NL_hp = get_option( 'affichage_NL_hp' );\r\n  \r\n  $newsletter_msg = get_option( 'newsletter_msg' );\r\n\t  $msg_sender = $newsletter_msg['sender'];\r\n\t  $msg_suscribe_title = $newsletter_msg['suscribe_title'];\r\n\t  $msg_suscribe = $newsletter_msg['suscribe'];\r\n\t  $msg_unsuscribe_title = $newsletter_msg['unsuscribe_title'];\r\n\t  $msg_unsuscribe = $newsletter_msg['unsuscribe'];\r\n  ?>  \r\n      <div class=\"wrap\">\r\n        <div id=\"icon-edit\" class=\"icon32 icon32-posts-newsletter\"><br/></div>\r\n        <h2><?=_e('Newsletter', 'eelv_lettreinfo' )?></h2>\r\n        <form name=\"typeSite\" method=\"post\" action=\"<?php echo str_replace( '%7E', '~', $_SERVER['REQUEST_URI']); ?>\">  \r\n          <input type=\"hidden\" name=\"type\" value=\"update\">\r\n          <table class=\"widefat\" style=\"margin-top: 1em;\">\r\n            <thead>\r\n              <tr>\r\n                <th scope=\"col\" colspan=\"2\"><?php _e( 'Configuration ', 'menu-config' ) ?></th>\r\n              </tr>\r\n            </thead>\r\n            <tbody>\r\n              <tr>\r\n                <td width=\"30%\">\r\n                  <label for=\"newsletter_default_exp\"><?php _e('Default sender name:', 'eelv_lettreinfo' ) ?></label>\r\n                </td><td>\r\n                <input  type=\"text\" name=\"newsletter_default_exp\"  size=\"60\"  id=\"newsletter_default_exp\"  value=\"<?=$default_exp?>\" class=\"wide\">\r\n                </td>\r\n              </tr>\r\n              <tr>\r\n                <td width=\"30%\">\r\n                  <label for=\"newsletter_default_mel\"><?php _e('Default reply address:', 'eelv_lettreinfo' ) ?></label>\r\n                </td><td>\r\n                <input  type=\"text\" name=\"newsletter_default_mel\"  size=\"60\"  id=\"newsletter_default_mel\"  value=\"<?=$default_mel?>\" class=\"wide\">\r\n                </td>\r\n              </tr>\r\n              <tr>\r\n                <td width=\"30%\">\r\n                  <label for=\"newsletter_desinsc_url\"><?php _e('Unsuscribe page', 'eelv_lettreinfo' ) ?> :</label>\r\n                   \r\n                </td><td>\r\n                <select  name=\"newsletter_desinsc_url\"   id=\"newsletter_desinsc_url\">\r\n                  <option></option>\r\n                  <?php\r\n  $querystr = \"\";\r\n                      $ret =  $wpdb->get_results(\"SELECT * FROM $wpdb->posts WHERE post_status = 'publish' AND post_type = 'page' ORDER BY `post_title`\");\r\n                      if(is_array($ret) && sizeof($ret)>0){            \r\n                        foreach($ret as $item){ \r\n                          $permalink = get_permalink( $item->ID );\r\n                          ?>\r\n                  <option value=\"<?=$permalink;?>\" <? if($desinsc_url==$permalink) echo\"selected\"; ?>><?=$item->post_title;?></option> \r\n                  <?php } \r\n                      }\r\n                      ?>\r\n                </select><br/>\r\n\t\t\t\t<legend><?php echo ( !empty($desinsc_url) ? '<a href=\"'.$desinsc_url.'\" target=\"_blank\">'.$desinsc_url.'</a>' : ''); ?></legend>              \r\n                </td>\r\n              </tr>\r\n              <!--tr>\r\n                <td width=\"30%\">\r\n                  <label for=\"newsletter_reply_url\"><?php _e('Reply page', 'eelv_lettreinfo' ) ?> :</label>\r\n                  <legend><?php echo ( !empty($reply_url) ? '<a href=\"'.$reply_url.'\">'.$reply_url.'</a>' : ''); ?></legend>\r\n                </td><td>\r\n                <select  name=\"newsletter_reply_url\" id=\"newsletter_reply_url\">\r\n                  <option></option>\r\n                  <?php\r\n  $querystr = \"\";\r\n                      if(is_array($ret) && sizeof($ret)>0){            \r\n                        foreach($ret as $item){ \r\n                          $permalink = get_permalink( $item->ID );\r\n                          ?>\r\n                  <option value=\"<?=$permalink;?>\" <? if($reply_url==$permalink) echo\"selected\"; ?>><?=$item->post_title;?></option> \r\n                  <?php } \r\n                      }\r\n                      ?>\r\n                </select>\r\n                </td>\r\n              </tr-->\r\n              \r\n              </tbody>\r\n              <thead>\r\n              <tr><th colspan=\"2\"><?php _e( 'Confirmation e-mails ', 'menu-config' ) ?></th></tr>\r\n              </thead>\r\n              \r\n              <tbody>\r\n              <tr>\r\n                <td width=\"30%\">\r\n                  <label for=\"newsletter_msg_sender\"><?php _e('Sender email:', 'eelv_lettreinfo' ) ?></label>\r\n                </td><td>\r\n                <input  type=\"text\" name=\"newsletter_msg_sender\"  size=\"60\"  id=\"newsletter_msg_sender\"  value=\"<?=$msg_sender?>\" class=\"wide\">\r\n                </td>\r\n              </tr>\r\n              <tr>\r\n                <td width=\"30%\">\r\n                  <label for=\"newsletter_msg_suscribe_title\"><?php _e('Suscribe subject:', 'eelv_lettreinfo' ) ?></label>\r\n                </td><td>\r\n                <input  type=\"text\" name=\"newsletter_msg_suscribe_title\"  size=\"60\"  id=\"newsletter_msg_suscribe_title\"  value=\"<?=$msg_suscribe_title?>\" class=\"wide\">\r\n                </td>\r\n              </tr>\r\n              <tr>\r\n                <td width=\"30%\">\r\n                  <label for=\"newsletter_msg_suscribe\"><?php _e('Suscribe Message:', 'eelv_lettreinfo' ) ?></label>\r\n                </td><td>\r\n                <textarea  name=\"newsletter_msg_suscribe\" id=\"newsletter_msg_suscribe\"><?=$msg_suscribe;?></textarea>\r\n                </td>\r\n              </tr>\r\n              <tr>\r\n                <td width=\"30%\">\r\n                  <label for=\"newsletter_msg_unsuscribe_title\"><?php _e('Unuscribe subject:', 'eelv_lettreinfo' ) ?></label>\r\n                </td><td>\r\n                <input  type=\"text\" name=\"newsletter_msg_unsuscribe_title\"  size=\"60\"  id=\"newsletter_msg_unsuscribe_title\"  value=\"<?=$msg_unsuscribe_title?>\" class=\"wide\">\r\n                </td>\r\n              </tr>\r\n              <tr>\r\n                <td width=\"30%\">\r\n                  <label for=\"newsletter_msg_unsuscribe\"><?php _e('Unsuscribe message:', 'eelv_lettreinfo' ) ?></label>\r\n                </td><td>\r\n                <textarea  name=\"newsletter_msg_unsuscribe\" id=\"newsletter_msg_unsuscribe\"><?=$msg_unsuscribe;?></textarea>\r\n                </td>\r\n              </tr>\r\n              \r\n               <tr>\r\n                <td colspan=\"2\">\r\n                  <input type='submit' value='<?php _e('Save options', 'eelv_lettreinfo' ) ?>' class=\"button-primary\"/>\r\n                </td>\r\n              </tr>\r\n            </tbody>\r\n          </table>\r\n          <table class=\"widefat\" style=\"margin-top: 1em;\">\r\n            <thead>\r\n              <tr>\r\n                <th scope=\"col\"><?php _e('Help', 'eelv_lettreinfo' ) ?></th>\r\n              </tr>\r\n            </thead>\r\n            <tbody>\r\n              <tr>\r\n                <td>\r\n                  <?php _e('Shortcods used:', 'eelv_lettreinfo' ) ?>\r\n                  <ul>\r\n                    <li><?php _e('Insert suscribe form in a page :', 'eelv_lettreinfo' ) ?><strong>[eelv_news_form]</strong></li>\r\n                  \t<!--li><?php _e('Insert answer form in a page :','eelv_lettreinfo')?> <strong>[eelv_news_answer]</strong></li-->\r\n                  </ul>\r\n                  <?php _e('Skins shortcodes', 'eelv_lettreinfo' ) ?>        \r\n                  <ul>\r\n                    <li><?php _e('Insert newsletter content in a skin :', 'eelv_lettreinfo' ) ?><strong>[newsletter]</strong></li>\r\n                    <li><?php _e('Insert newsletter content in a skin :', 'eelv_lettreinfo' ) ?><strong>[desinsc_url]</strong></li>\r\n                  </ul>\r\n                  <?php _e('Legend of sending symbols:', 'eelv_lettreinfo' ) ?><ul>\r\n                  <li><img src=\"<?=$newsletter_plugin_url?>/eelv-newsletter/img/-1.jpg\"/> <?php _e('Invalid email', 'eelv_lettreinfo' ) ?></li>\r\n                  <li><img src=\"<?=$newsletter_plugin_url?>/eelv-newsletter/img/0.jpg\"/> <?php _e('Sending failed', 'eelv_lettreinfo' ) ?></li>\r\n                  <li><img src=\"<?=$newsletter_plugin_url?>/eelv-newsletter/img/1.jpg\"/> <?php _e('Newsletter successfully sent', 'eelv_lettreinfo' ) ?></li>\r\n                  <li><img src=\"<?=$newsletter_plugin_url?>/eelv-newsletter/img/2.jpg\"/> <?php _e('Address on the list of unsubscribed:', 'eelv_lettreinfo' ) ?></li>\r\n                  <li><img src=\"<?=$newsletter_plugin_url?>/eelv-newsletter/img/3.jpg\"/> <?php _e('Email has been readen', 'eelv_lettreinfo' ) ?></li>\r\n                  </ul>\r\n                </td></tr></tbody></table>\r\n        </form>\r\n      </div>\r\n      <?php\r\n  }  \r\nfunction eelv_lettrinfo_locate_plugin_template($template_names, $load = false, $require_once = true ){\r\n  if ( !is_array($template_names) )\r\n  return '';     \r\n  $located = '';     \r\n  $this_plugin_dir = WP_PLUGIN_DIR.'/'.str_replace( basename( __FILE__), \"\", plugin_basename(__FILE__) );     \r\n  foreach ( $template_names as $template_name ) {\r\n\tif ( !$template_name )\r\n\t  continue;\r\n\tif ( file_exists(STYLESHEETPATH . '/' . $template_name)) {\r\n\t  $located = STYLESHEETPATH . '/' . $template_name;\r\n\t  break;\r\n\t} else if ( file_exists(TEMPLATEPATH . '/' . $template_name) ) {\r\n\t  $located = TEMPLATEPATH . '/' . $template_name;\r\n\t  break;\r\n\t} else if ( file_exists( $this_plugin_dir .  $template_name) ) {\r\n\t  $located =  $this_plugin_dir . $template_name;\r\n\t  break;\r\n\t}\r\n  }     \r\n  if ( $load && '' != $located )\r\n\tload_template( $located, $require_once );     \r\n  return $located;\r\n}\r\nfunction eelv_lettrinfo_get_custom_archive_template($template){\r\n  global $wp_query;\r\n  if($wp_query->get_queried_object()->query_var=='newsletter_archive') {  \r\n\t  $templates = array('archive-newsletter_archive.php', 'archive.php');\r\n\t  $template = eelv_lettrinfo_locate_plugin_template($templates);\r\n  }\r\n  return $template;\r\n}\r\nfunction eelv_lettrinfo_get_custom_single_template($template){\r\n  global $wp_query;\r\n  $object = $wp_query->get_queried_object();\r\n  if ( 'newsletter_archive' == $object->post_type ) {\r\n\t$templates = array('single-' . $object->post_type . '.php', 'single.php');\r\n\t$template = eelv_lettrinfo_locate_plugin_template($templates);\r\n  }\r\n  return $template;\r\n}\r\n////////////////////////////////////////////////////////////////////////////////////////////////////// WIDGET\r\nwp_register_sidebar_widget(\r\n  'widget_eelv_lettreinfo_insc',        // your unique widget id\r\n  __('Suscribe newsletter','eelv_lettreinfo'),          // widget name\r\n  'widget_eelv_lettreinfo_side',  // callback function\r\n  array(                  // options\r\n\t'description' => __('Form / unsubscribe and archives NewsLetter','eelv_lettreinfo')\r\n  )\r\n);\r\nfunction widget_eelv_lettreinfo_side($params) {\r\n  $eelv_li_xs_title= get_option('eelv_li_xs_title')?>\r\n      <?php echo $params['before_widget']; ?>\r\n      <?php echo $params['before_title'];?>\r\n      <?php echo  $eelv_li_xs_title; ?>\r\n      <?php echo $params['after_title'];?>\r\n      <?php get_news_form('widget'); ?>\r\n      <?php echo $params['after_widget'];?>\r\n      <?php\r\n                    }\r\n                    \r\n wp_register_widget_control('widget_eelv_lettreinfo_insc', __('Suscribe newsletter','eelv_lettreinfo'),'widget_eelv_lettreinfo_insc_control');\r\n function widget_eelv_lettreinfo_insc_control(){\r\n   if( isset($_POST['eelv_li_xs_title']) ){\r\n\t    update_option('eelv_li_xs_title', stripslashes($_POST['eelv_li_xs_title']));\r\n\t    update_option('eelv_li_xs_archives', $_POST['eelv_li_xs_archives']);\r\n\t    echo 'Options sauvegard&eacute;es<br/>';\r\n   }\r\n                      $eelv_li_xs_title= get_option('eelv_li_xs_title');\r\n                      $eelv_li_xs_archives = get_option('eelv_li_xs_archives',0);\r\n                      ?>\r\n      <p><label for='eelv_li_xs_title'><?php _e('Title', 'eelv_lettreinfo' ) ?><br/>\r\n        <input type='text' name='eelv_li_xs_title' id='eelv_li_xs_title' value=\"<?=$eelv_li_xs_title?>\"/></label>\r\n      </p>\r\n      <p><label for='eelv_li_xs_archives'><?php _e('Hide archives link', 'eelv_lettreinfo' ) ?><br/>\r\n        <select name='eelv_li_xs_archives' id='eelv_li_xs_archives'>\r\n            <option value=\"0\" <?php if($eelv_li_xs_archives==0){ echo'selected'; } ?>><?php _e('No', 'eelv_lettreinfo' ) ?></option>\r\n            <option value=\"1\" <?php if($eelv_li_xs_archives==1){ echo'selected'; } ?>><?php _e('Yes', 'eelv_lettreinfo' ) ?></option>\r\n        </select>\r\n        </label>\r\n      </p>\r\n      <?php\r\n  }\r\n  function news_transform(){\r\n  global $wpdb;\r\n  $querystr = \"SELECT `ID` FROM $wpdb->posts WHERE post_status = 'publish' AND post_type = 'newsletter_template' ORDER BY `post_title`\";\r\n  $IDS = $wpdb->get_col($querystr);  \r\n  $templates_nb = sizeof($IDS);\r\n  if($templates_nb>0){ ?>\r\n  \r\n  <input type=\"hidden\" id=\"eelv_nl_convert_link\" value=\"edit.php?post_type=newsletter&page=news_envoi&post=<?=get_the_ID()?>\"/>\r\n  \t<select name=\"eelv_nl_convert_id\" id=\"eelv_nl_convert_id\">\r\n\t<?php foreach($IDS as $item_id){ ?>\r\n\t\t<option value=\"<?=$item_id?>\"><?=get_the_title($item_id);?></option> \r\n\t<?php } ?>\r\n\t</select>\r\n\t<hr/>\r\n    <p><label for=\"eelv_nl_convert_title\"><input type=\"checkbox\" id=\"eelv_nl_convert_title\"  value=\"1\"/> <?php _e(\"Add title to content\",'eelv_lettreinfo'); ?></label></p>\r\n    <p><label for=\"eelv_nl_convert_share\"><input type=\"checkbox\" id=\"eelv_nl_convert_share\"  value=\"1\"/> <?php _e(\"Add share links\",'eelv_lettreinfo'); ?></label></p>\r\n    \r\n    \r\n    <p><a id=\"eelv_nl_convert_a\" class=\"button\"> <?php _e(\"Preview and send\",'eelv_lettreinfo'); ?></a></p>\r\n    <script>\r\n\tjQuery(document).ready(function(e) {\r\n\t\tjQuery('#eelv_nl_convert_id').width(jQuery('#eelv_nl_convert_id').parent().width()-10);\r\n\t\tjQuery('#eelv_nl_convert_a').click(function(){\r\n\t\t\tvar lien=jQuery('#eelv_nl_convert_link').attr('value');\r\n\t\t\tlien+='&convert=';\r\n\t\t\tlien+=jQuery('#eelv_nl_convert_id').val();\r\n\t\t\tif(jQuery('#eelv_nl_convert_title').is(':checked')==true){\r\n\t\t\t\tlien+='&add_title=1';\r\n\t\t\t}\r\n\t\t\tif(jQuery('#eelv_nl_convert_share').is(':checked')==true){\r\n\t\t\t\tlien+='&add_sharelinks=1';\r\n\t\t\t}\r\n\t\t\t//console.log(lien);\r\n\t\t\tdocument.location=lien;\r\n\t\t\treturn false;\r\n\t\t});\r\n\t});\r\n\t</script>\r\n<?php\r\n  }else{\r\n\t_e(\"No skin available\",'eelv_lettreinfo');  \r\n  }  \r\n}\r\n///////////////////////////////////////////////////////////////////////// INSERTION DANS WORDPRESS\r\nregister_activation_hook(__FILE__,'eelvnewsletter_install');\r\nadd_action( 'save_post', 'newsletter_save_postdata' );\r\nadd_action('plugins_loaded', 'eelvnewsletter_update_db_check');\r\nadd_action( 'add_meta_boxes', 'newsletter_add_custom_box' );\r\nadd_action( 'init', 'newsletter_BO' );\r\nadd_action('admin_menu', 'eelv_news_ajout_menu');\r\nadd_action( 'network_admin_menu', 'eelv_news_ajout_network_menu'); \r\nadd_action('wp_head', 'style_newsletter');\r\n\r\nadd_action( 'admin_init', 'newsletter_autosend' );\r\nadd_filter( 'archive_template', 'eelv_lettrinfo_get_custom_archive_template' );\r\nadd_filter( 'single_template', 'eelv_lettrinfo_get_custom_single_template' );\r\nadd_filter('manage_newsletter_posts_columns', 'lettreinfo_columns_head');  \r\nadd_action('manage_newsletter_posts_custom_column', 'lettreinfo_columns_content', 10, 2); \r\nadd_filter('manage_newsletter_archive_posts_columns', 'lettreinfo_archives_columns_head');  \r\nadd_action('manage_newsletter_archive_posts_custom_column', 'lettreinfo_archives_columns_content', 10, 2); "], "filenames": ["lettreinfo.php"], "buggy_code_start_loc": [341], "buggy_code_end_loc": [342], "fixing_code_start_loc": [341], "fixing_code_end_loc": [342], "type": "CWE-79", "message": "A vulnerability was found in EELV Newsletter Plugin 2.x on WordPress. It has been rated as problematic. Affected by this issue is the function style_newsletter of the file lettreinfo.php. The manipulation of the argument email leads to cross site scripting. The attack may be launched remotely. The name of the patch is 3339b42316c5edf73e56eb209b6a3bb3e868d6ed. It is recommended to upgrade the affected component. The identifier of this vulnerability is VDB-230660.", "other": {"cve": {"id": "CVE-2013-10028", "sourceIdentifier": "cna@vuldb.com", "published": "2023-06-04T19:15:09.620", "lastModified": "2023-06-09T18:49:07.187", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "A vulnerability was found in EELV Newsletter Plugin 2.x on WordPress. It has been rated as problematic. Affected by this issue is the function style_newsletter of the file lettreinfo.php. The manipulation of the argument email leads to cross site scripting. The attack may be launched remotely. The name of the patch is 3339b42316c5edf73e56eb209b6a3bb3e868d6ed. It is recommended to upgrade the affected component. The identifier of this vulnerability is VDB-230660."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}], "cvssMetricV30": [{"source": "cna@vuldb.com", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:L/UI:R/S:U/C:N/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "UNCHANGED", "confidentialityImpact": "NONE", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 3.5, "baseSeverity": "LOW"}, "exploitabilityScore": 2.1, "impactScore": 1.4}], "cvssMetricV2": [{"source": "cna@vuldb.com", "type": "Secondary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:S/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "SINGLE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.0}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.0, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "cna@vuldb.com", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:eelv_newsletter_project:eelv_newsletter:*:*:*:*:*:wordpress:*:*", "versionStartIncluding": "2.6", "versionEndIncluding": "2.9.0", "matchCriteriaId": "06B272DB-EDEC-48D9-B78A-0C8EE72665BA"}]}]}], "references": [{"url": "https://github.com/wp-plugins/eelv-newsletter/commit/3339b42316c5edf73e56eb209b6a3bb3e868d6ed", "source": "cna@vuldb.com", "tags": ["Patch"]}, {"url": "https://vuldb.com/?ctiid.230660", "source": "cna@vuldb.com", "tags": ["Permissions Required", "Third Party Advisory"]}, {"url": "https://vuldb.com/?id.230660", "source": "cna@vuldb.com", "tags": ["Permissions Required", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/wp-plugins/eelv-newsletter/commit/3339b42316c5edf73e56eb209b6a3bb3e868d6ed"}}