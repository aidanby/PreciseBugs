{"buggy_code": ["# Check that your Apache virtualhost have this settings:\n\n#<Directory \"/var/www/chamilo-classic\">\n#  AllowOverride All\n#  Order allow,deny\n#  Allow from all\n#</Directory>\n\nRewriteEngine on\n\n# Prevent execution of PHP from directories used for different types of uploads\nRedirectMatch 403 ^/app/(?!courses/proxy)(cache|courses|home|logs|upload|Resources/public/css)/.*\\.ph(p[3457]?|t|tml|ar)$\nRedirectMatch 403 ^/main/default_course_document/images/.*\\.ph(p[3457]?|t|tml|ar)$\nRedirectMatch 403 ^/main/lang/.*\\.ph(p[3457]?|t|tml|ar)$\nRedirectMatch 403 ^/web/css/.*\\.ph(p[3457]?|t|tml|ar)$\n\n# http://my.chamilo.net/certificates/?id=123 to http://my.chamilo.net/certificates/index.php?id=123\nRewriteCond %{QUERY_STRING} ^id=(.*)$\nRewriteRule ^certificates/$ certificates/index.php?id=%1 [L]\n\n# Course redirection\nRewriteRule ^courses/([^/]+)/?$ main/course_home/course_home.php?cDir=$1 [QSA,L]\nRewriteRule ^courses/([^/]+)/index.php$ main/course_home/course_home.php?cDir=$1 [QSA,L]\n\n# Rewrite everything in the scorm folder of a course to the download script\n# except JS, CSS and some image files, which can be served directly\nRewriteRule ^courses/([^/]+)/scorm/(.*([\\.js|\\.css|\\.png|\\.jpg|\\.jpeg|\\.gif]))$ app/courses/$1/scorm/$2 [QSA,L]\nRewriteRule ^courses/([^/]+)/scorm/(.*)$ main/document/download_scorm.php?doc_url=/$2&cDir=$1 [QSA,L]\n\n# Rewrite everything in the document folder of a course to the download script\n# Except certificate resources, which might need to be accessible publicly to all\nRewriteRule ^courses/([^/]+)/document/certificates/(.*)$ app/courses/$1/document/certificates/$2 [QSA,L]\nRewriteRule ^courses/([^/]+)/document/(.*)$ main/document/download.php?doc_url=/$2&cDir=$1 [QSA,L]\n\n# Optimize load of custom per-course icons in courses (avoid download_uploaded_files.php)\nRewriteRule ^courses/([^/]+)/upload/course_home_icons/(.*([\\.js|\\.css|\\.png|\\.jpg|\\.jpeg|\\.gif]))$ app/courses/$1/upload/course_home_icons/$2 [QSA,L]\n# Course upload files\nRewriteRule ^courses/([^/]+)/upload/([^/]+)/(.*)$ main/document/download_uploaded_files.php?code=$1&type=$2&file=$3 [QSA,L]\n\n# Rewrite everything in the work folder\nRewriteRule ^courses/([^/]+)/work/(.*)$ main/work/download.php?file=work/$2&cDir=$1 [QSA,L]\n\nRewriteRule ^courses/([^/]+)/course-pic85x85.png$ main/inc/ajax/course.ajax.php?a=get_course_image&code=$1&image=course_image_source [QSA,L]\nRewriteRule ^courses/([^/]+)/course-pic.png$ main/inc/ajax/course.ajax.php?a=get_course_image&code=$1&image=course_image_large_source [QSA,L]\n\n# Redirect all courses/ to app/courses/\nRewriteRule ^courses/([^/]+)/(.*)$ app/courses/$1/$2 [QSA,L]\n\n# About session\nRewriteRule ^session/(\\d{1,})/about/?$ main/session/about.php?session_id=$1 [QSA,L]\n\n# About course\nRewriteRule ^course/(\\d{1,})/about/?$ main/course_info/about.php?course_id=$1 [QSA,L]\n\n# Issued individual badge friendly URL\nRewriteRule ^badge/(\\d{1,})/?$ main/badge/issued.php?issue=$1 [QSA,L]\n\n# Issued badges friendly URL\nRewriteRule ^skill/(\\d{1,})/user/(\\d{1,})/?$ main/badge/issued_all.php?skill=$1&user=$2 [L]\n# Support deprecated URL (avoid 404)\nRewriteRule ^badge/(\\d{1,})/user/(\\d{1,})/?$ main/badge/issued_all.php?skill=$1&user=$2 [L]\n\n# Support old URLs using the exercice (with a c) folder rather than exercise\nRewriteRule ^main/exercice/(.*)$ main/exercise/$1 [QSA,L]\n# Support old URLs using the newscorm folder rather than lp\nRewriteRule ^main/newscorm/(.*)$ main/lp/$1 [QSA,L]\n\n# service Information\nRewriteRule ^service/(\\d{1,})$ plugin/buycourses/src/service_information.php?service_id=$1 [L]\n\n# LTI outcome service\nRewriteRule ^lti/os$ plugin/ims_lti/outcome_service.php [L]\n\n# This rule is very generic and should always remain at the bottom of .htaccess\n# http://my.chamilo.net/jdoe to http://my.chamilo.net/user.php?jdoe\nRewriteRule ^([^/.]+)/?$ user.php?$1 [L]\n\n# Deny direct access to user my files\nRewriteRule ^app/upload/users/([^/]+)/([^/]+)/my_files/(.*)$ main/social/download_my_files.php?user_id=$2&file=$3 [QSA,L]\n\n# Deny access\nRewriteRule ^(tests|.git) - [F,L,NC]\n\n# Add caching of woff font files to avoid loading 2*15KB each time with Chamilo\n# default OpenSans font\nAddType application/font-woff .woff .woff2\n<IfModule mod_expires.c>\n  ExpiresActive On\n  ExpiresByType application/font-woff \"access plus 1 month\"\n</IfModule>\n\n"], "fixing_code": ["# Check that your Apache virtualhost have this settings:\n\n#<Directory \"/var/www/chamilo-classic\">\n#  AllowOverride All\n#  Order allow,deny\n#  Allow from all\n#</Directory>\n\nRewriteEngine on\n\n# Prevent execution of PHP from directories used for different types of uploads\nRedirectMatch 403 ^/app/(?!courses/proxy)(cache|courses|home|logs|upload|Resources/public/css)/.*\\.ph(p[3457]?|t|tml|ar)$\nRedirectMatch 403 ^/main/default_course_document/images/.*\\.ph(p[3457]?|t|tml|ar)$\nRedirectMatch 403 ^/main/lang/.*\\.ph(p[3457]?|t|tml|ar)$\nRedirectMatch 403 ^/web/.*\\.ph(p[3457]?|t|tml|ar)$\n\n# http://my.chamilo.net/certificates/?id=123 to http://my.chamilo.net/certificates/index.php?id=123\nRewriteCond %{QUERY_STRING} ^id=(.*)$\nRewriteRule ^certificates/$ certificates/index.php?id=%1 [L]\n\n# Course redirection\nRewriteRule ^courses/([^/]+)/?$ main/course_home/course_home.php?cDir=$1 [QSA,L]\nRewriteRule ^courses/([^/]+)/index.php$ main/course_home/course_home.php?cDir=$1 [QSA,L]\n\n# Rewrite everything in the scorm folder of a course to the download script\n# except JS, CSS and some image files, which can be served directly\nRewriteRule ^courses/([^/]+)/scorm/(.*([\\.js|\\.css|\\.png|\\.jpg|\\.jpeg|\\.gif]))$ app/courses/$1/scorm/$2 [QSA,L]\nRewriteRule ^courses/([^/]+)/scorm/(.*)$ main/document/download_scorm.php?doc_url=/$2&cDir=$1 [QSA,L]\n\n# Rewrite everything in the document folder of a course to the download script\n# Except certificate resources, which might need to be accessible publicly to all\nRewriteRule ^courses/([^/]+)/document/certificates/(.*)$ app/courses/$1/document/certificates/$2 [QSA,L]\nRewriteRule ^courses/([^/]+)/document/(.*)$ main/document/download.php?doc_url=/$2&cDir=$1 [QSA,L]\n\n# Optimize load of custom per-course icons in courses (avoid download_uploaded_files.php)\nRewriteRule ^courses/([^/]+)/upload/course_home_icons/(.*([\\.js|\\.css|\\.png|\\.jpg|\\.jpeg|\\.gif]))$ app/courses/$1/upload/course_home_icons/$2 [QSA,L]\n# Course upload files\nRewriteRule ^courses/([^/]+)/upload/([^/]+)/(.*)$ main/document/download_uploaded_files.php?code=$1&type=$2&file=$3 [QSA,L]\n\n# Rewrite everything in the work folder\nRewriteRule ^courses/([^/]+)/work/(.*)$ main/work/download.php?file=work/$2&cDir=$1 [QSA,L]\n\nRewriteRule ^courses/([^/]+)/course-pic85x85.png$ main/inc/ajax/course.ajax.php?a=get_course_image&code=$1&image=course_image_source [QSA,L]\nRewriteRule ^courses/([^/]+)/course-pic.png$ main/inc/ajax/course.ajax.php?a=get_course_image&code=$1&image=course_image_large_source [QSA,L]\n\n# Redirect all courses/ to app/courses/\nRewriteRule ^courses/([^/]+)/(.*)$ app/courses/$1/$2 [QSA,L]\n\n# About session\nRewriteRule ^session/(\\d{1,})/about/?$ main/session/about.php?session_id=$1 [QSA,L]\n\n# About course\nRewriteRule ^course/(\\d{1,})/about/?$ main/course_info/about.php?course_id=$1 [QSA,L]\n\n# Issued individual badge friendly URL\nRewriteRule ^badge/(\\d{1,})/?$ main/badge/issued.php?issue=$1 [QSA,L]\n\n# Issued badges friendly URL\nRewriteRule ^skill/(\\d{1,})/user/(\\d{1,})/?$ main/badge/issued_all.php?skill=$1&user=$2 [L]\n# Support deprecated URL (avoid 404)\nRewriteRule ^badge/(\\d{1,})/user/(\\d{1,})/?$ main/badge/issued_all.php?skill=$1&user=$2 [L]\n\n# Support old URLs using the exercice (with a c) folder rather than exercise\nRewriteRule ^main/exercice/(.*)$ main/exercise/$1 [QSA,L]\n# Support old URLs using the newscorm folder rather than lp\nRewriteRule ^main/newscorm/(.*)$ main/lp/$1 [QSA,L]\n\n# service Information\nRewriteRule ^service/(\\d{1,})$ plugin/buycourses/src/service_information.php?service_id=$1 [L]\n\n# LTI outcome service\nRewriteRule ^lti/os$ plugin/ims_lti/outcome_service.php [L]\n\n# This rule is very generic and should always remain at the bottom of .htaccess\n# http://my.chamilo.net/jdoe to http://my.chamilo.net/user.php?jdoe\nRewriteRule ^([^/.]+)/?$ user.php?$1 [L]\n\n# Deny direct access to user my files\nRewriteRule ^app/upload/users/([^/]+)/([^/]+)/my_files/(.*)$ main/social/download_my_files.php?user_id=$2&file=$3 [QSA,L]\n\n# Deny access\nRewriteRule ^(tests|.git) - [F,L,NC]\n\n# Add caching of woff font files to avoid loading 2*15KB each time with Chamilo\n# default OpenSans font\nAddType application/font-woff .woff .woff2\n<IfModule mod_expires.c>\n  ExpiresActive On\n  ExpiresByType application/font-woff \"access plus 1 month\"\n</IfModule>\n\n"], "filenames": [".htaccess"], "buggy_code_start_loc": [15], "buggy_code_end_loc": [16], "fixing_code_start_loc": [15], "fixing_code_end_loc": [16], "type": "CWE-706", "message": "A remote code execution vulnerability exists in Chamilo through 1.11.14 due to improper input sanitization of a parameter used for file uploads, and improper file-extension filtering for certain filenames (e.g., .phar or .pht). A remote authenticated administrator is able to upload a file containing arbitrary PHP code into specific directories via main/inc/lib/fileUpload.lib.php directory traversal to achieve PHP code execution.", "other": {"cve": {"id": "CVE-2021-31933", "sourceIdentifier": "cve@mitre.org", "published": "2021-04-30T21:15:09.000", "lastModified": "2022-06-28T14:11:45.273", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "A remote code execution vulnerability exists in Chamilo through 1.11.14 due to improper input sanitization of a parameter used for file uploads, and improper file-extension filtering for certain filenames (e.g., .phar or .pht). A remote authenticated administrator is able to upload a file containing arbitrary PHP code into specific directories via main/inc/lib/fileUpload.lib.php directory traversal to achieve PHP code execution."}, {"lang": "es", "value": "Se presenta una vulnerabilidad de ejecuci\u00f3n de c\u00f3digo remota en Chamilo versiones hasta 1.11.14, debido a un saneamiento de la entrada inapropiado de un par\u00e1metro utilizado para la carga de archivos y al filtrado inapropiado de extensiones de archivo para determinados nombres de archivo (por ejemplo, .phar o .pht).&#xa0;Un administrador autenticado remoto puede cargar un archivo que contiene c\u00f3digo PHP arbitrario en directorios espec\u00edficos por medio del salto del directorio en el archivo main/inc/lib/fileUpload.lib.php para alcanzar una ejecuci\u00f3n de c\u00f3digo PHP."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "HIGH", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 7.2, "baseSeverity": "HIGH"}, "exploitabilityScore": 1.2, "impactScore": 5.9}, {"source": "cve@mitre.org", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "HIGH", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 7.2, "baseSeverity": "HIGH"}, "exploitabilityScore": 1.2, "impactScore": 5.9}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:S/C:P/I:P/A:P", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "SINGLE", "confidentialityImpact": "PARTIAL", "integrityImpact": "PARTIAL", "availabilityImpact": "PARTIAL", "baseScore": 6.5}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.0, "impactScore": 6.4, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-706"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:chamilo:chamilo:*:*:*:*:*:*:*:*", "versionEndIncluding": "1.11.14", "matchCriteriaId": "3F377513-C59E-4FD6-97E5-47B4474F5FA9"}]}]}], "references": [{"url": "http://packetstormsecurity.com/files/162572/Chamilo-LMS-1.11.14-Remote-Code-Execution.html", "source": "cve@mitre.org", "tags": ["Exploit", "Third Party Advisory", "VDB Entry"]}, {"url": "https://github.com/chamilo/chamilo-lms/commit/229302139e8d23bf6862183cf219b967f6e2fbc1", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/chamilo/chamilo-lms/commit/f65d065061a77bb2e84f73217079ce3998cf3453", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://support.chamilo.org/projects/1/wiki/Security_issues#Issue-48-2021-04-17-Critical-impact-high-risk-Remote-Code-Execution", "source": "cve@mitre.org", "tags": ["Patch", "Vendor Advisory"]}]}, "github_commit_url": "https://github.com/chamilo/chamilo-lms/commit/229302139e8d23bf6862183cf219b967f6e2fbc1"}}