{"buggy_code": ["<?php\n/*\n\tFusionPBX\n\tVersion: MPL 1.1\n\n\tThe contents of this file are subject to the Mozilla Public License Version\n\t1.1 (the \"License\"); you may not use this file except in compliance with\n\tthe License. You may obtain a copy of the License at\n\thttp://www.mozilla.org/MPL/\n\n\tSoftware distributed under the License is distributed on an \"AS IS\" basis,\n\tWITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n\tfor the specific language governing rights and limitations under the\n\tLicense.\n\n\tThe Original Code is FusionPBX\n\n\tThe Initial Developer of the Original Code is\n\tMark J Crane <markjcrane@fusionpbx.com>\n\tPortions created by the Initial Developer are Copyright (C) 2016-2018\n\tthe Initial Developer. All Rights Reserved.\n\n\tContributor(s):\n\tMark J Crane <markjcrane@fusionpbx.com>\n*/\n\n//includes\n\trequire_once \"root.php\";\n\trequire_once \"resources/require.php\";\n\trequire_once \"resources/check_auth.php\";\n\n//check permissions\n\tif (!permission_exists('message_view')) {\n\t\techo \"access denied\";\n\t\texit;\n\t}\n\n//add multi-lingual support\n\t$language = new text;\n\t$text = $language->get();\n\n//get number of messages to load\n\t$number = preg_replace('{[\\D]}', '', $_GET['number']);\n\t$contact_uuid = $_GET['contact_uuid'];\n\n//set refresh flag\n\t$refresh = $_GET['refresh'] == 'true' ? true : false;\n\n//get messages\n\tif (isset($_SESSION['message']['display_last']['text']) && $_SESSION['message']['display_last']['text'] != '') {\n\t\t$array = explode(' ',$_SESSION['message']['display_last']['text']);\n\t\tif (is_array($array) && is_numeric($array[0]) && $array[0] > 0) {\n\t\t\tif ($array[1] == 'messages') {\n\t\t\t\t$limit = limit_offset($array[0], 0);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t$since = \"and message_date >= :message_date \";\n\t\t\t\t$parameters['message_date'] = date(\"Y-m-d H:i:s\", strtotime('-'.$_SESSION['message']['display_last']['text']));\n\t\t\t}\n\t\t}\n\t}\n\tif ($limit == '' && $since == '') { $limit = limit_offset(25, 0); } //default (message count)\n\t$sql = \"select \";\n\t$sql .= \"message_uuid, \";\n\t$sql .= \"domain_uuid, \";\n\t$sql .= \"user_uuid, \";\n\t$sql .= \"contact_uuid, \";\n\t$sql .= \"message_type, \";\n\t$sql .= \"message_direction, \";\n\t$sql .= \"message_date at time zone :time_zone as message_date, \";\n\t$sql .= \"message_from, \";\n\t$sql .= \"message_to, \";\n\t$sql .= \"message_text \";\n\t$sql .= \"from v_messages \";\n\t$sql .= \"where user_uuid = :user_uuid \";\n\t$sql .= \"and (domain_uuid = :domain_uuid or domain_uuid is null) \";\n\t$sql .= $since;\n\t$sql .= \"and (message_from like :message_number or message_to like :message_number) \";\n\t$sql .= \"order by message_date desc \";\n\t$sql .= $limit;\n\t$parameters['time_zone'] = $_SESSION['domain']['time_zone']['name'];\n\t$parameters['user_uuid'] = $_SESSION['user_uuid'];\n\t$parameters['domain_uuid'] = $domain_uuid;\n\t$parameters['message_number'] = '%'.$number;\n\t$database = new database;\n\t$messages = $database->select($sql, $parameters, 'all');\n\t$messages = array_reverse($messages);\n\tunset($sql, $parameters);\n\n//get media (if any)\n\t$sql = \"select \";\n\t$sql .= \"message_uuid, \";\n\t$sql .= \"message_media_uuid, \";\n\t$sql .= \"message_media_type, \";\n\t$sql .= \"length(decode(message_media_content,'base64')) as message_media_size \";\n\t$sql .= \"from v_message_media \";\n\t$sql .= \"where user_uuid = :user_uuid \";\n\t$sql .= \"and (domain_uuid = :domain_uuid or domain_uuid is null) \";\n\t$sql .= \"and ( \";\n\tforeach ($messages as $index => $message) {\n\t\t$message_uuids[] = \"message_uuid = :message_uuid_\".$index;\n\t\t$parameters['message_uuid_'.$index] = $message['message_uuid'];\n\t}\n\t$sql .= implode(' or ', $message_uuids);\n\t$sql .= \") \";\n\t$sql .= \"and message_media_type <> 'txt' \";\n\t$parameters['user_uuid'] = $_SESSION['user_uuid'];\n\t$parameters['domain_uuid'] = $domain_uuid;\n\t$database = new database;\n\t$rows = $database->select($sql, $parameters, 'all');\n\tunset($sql, $parameters, $index);\n\n//prep media array\n\tif (is_array($rows) && @sizeof($rows) != 0) {\n\t\tforeach ($rows as $index => $row) {\n\t\t\t$message_media[$row['message_uuid']][$index]['uuid'] = $row['message_media_uuid'];\n\t\t\t$message_media[$row['message_uuid']][$index]['type'] = $row['message_media_type'];\n\t\t\t$message_media[$row['message_uuid']][$index]['size'] = $row['message_media_size'];\n\t\t}\n\t}\n\n//css styles\n\techo \"<style>\\n\";\n\techo \"\t.message-bubble {\\n\";\n\techo \"\t\tdisplay: table;\\n\";\n\techo \"\t\tpadding: 10px;\\n\";\n\techo \"\t\tborder: 1px solid;\\n\";\n\techo \"\t\tmargin-bottom: 10px;\\n\";\n\techo \"\t\t}\\n\";\n\n\techo \"\t.message-bubble-em {\\n\";\n\techo \"\t\tmargin-right: 30%;\\n\";\n\techo \"\t\tborder-radius: 0 20px 20px 20px;\\n\";\n\techo \"\t\tborder-color: #cffec7;\\n\";\n\techo \"\t\tbackground-color: #ecffe9;\\n\";\n\techo \"\t\tclear: both;\\n\";\n\techo \"\t\t}\\n\";\n\n\techo \"\t.message-bubble-me {\\n\";\n\techo \"\t\tfloat: right;\\n\";\n\techo \"\t\tmargin-left: 30%;\\n\";\n\techo \"\t\tborder-radius: 20px 20px 0 20px;\\n\";\n\techo \"\t\tborder-color: #cbf0ff;\\n\";\n\techo \"\t\tbackground-color: #e5f7ff;\\n\";\n\techo \"\t\tclear: both;\\n\";\n\techo \"\t\t}\\n\";\n\n\techo \"\timg.message-bubble-image-em {\\n\";\n\techo \"\t\twidth: 100px;\\n\";\n\techo \"\t\theight: auto;\\n\";\n\techo \"\t\tborder-radius: 0 11px 11px 11px;\\n\";\n\techo \"\t\tborder: 1px solid #cffec7;\\n\";\n\techo \"\t\t}\\n\";\n\n\techo \"\timg.message-bubble-image-me {\\n\";\n\techo \"\t\twidth: 100px;\\n\";\n\techo \"\t\theight: auto;\\n\";\n\techo \"\t\tborder-radius: 11px 11px 0 11px;\\n\";\n\techo \"\t\tborder: 1px solid #cbf0ff;\\n\";\n\techo \"\t\t}\\n\";\n\n\techo \"\tdiv.message-bubble-image-em {\\n\";\n\techo \"\t\tfloat: left;\\n\";\n\techo \"\t\tmargin-right: 15px;\\n\";\n\techo \"\t\ttext-align: left;\\n\";\n\techo \"\t\t}\\n\";\n\n\techo \"\tdiv.message-bubble-image-me {\\n\";\n\techo \"\t\tfloat: right;\\n\";\n\techo \"\t\tmargin-left: 15px;\\n\";\n\techo \"\t\ttext-align: right;\\n\";\n\techo \"\t\t}\\n\";\n\n\techo \"\t.message-text {\\n\";\n\techo \"\t\tpadding-bottom: 5px;\\n\";\n\techo \"\t\tfont-size: 90%;\\n\";\n\techo \"\t\t}\\n\";\n\n\techo \"\t.message-bubble-when {\\n\";\n\techo \"\t\tfont-size: 71%;\\n\";\n\techo \"\t\tfont-style: italic;\\n\";\n\techo \"\t\t}\\n\";\n\n\techo \"\t.message-media-link-em {\\n\";\n\techo \"\t\tdisplay: inline-block;\\n\";\n\techo \"\t\tmargin: 5px 10px 5px 0;\\n\";\n\techo \"\t\tpadding: 8px;\\n\";\n\techo \"\t\tbackground: #cffec7;\\n\";\n\techo \"\t\tborder-radius: 7px;\\n\";\n\techo \"\t\ttext-align: center;\\n\";\n\techo \"\t\t}\\n\";\n\n\techo \"\t.message-media-link-me {\\n\";\n\techo \"\t\tdisplay: inline-block;\\n\";\n\techo \"\t\tmargin: 5px 10px 5px 0;\\n\";\n\techo \"\t\tpadding: 8px;\\n\";\n\techo \"\t\tbackground: #cbf0ff;\\n\";\n\techo \"\t\tborder-radius: 7px;\\n\";\n\techo \"\t\ttext-align: center;\\n\";\n\techo \"\t\t}\\n\";\n\n\techo \"</style>\\n\";\n\n\tif (!$refresh) {\n\t\techo \"<div id='thread_messages' style='min-height: 300px; overflow: auto; padding-right: 15px;'>\\n\";\n\t}\n\n\t//output messages\n\t\tif (is_array($messages) && @sizeof($messages) != 0) {\n\t\t\tforeach ($messages as $message) {\n\t\t\t\t//parse from message\n\t\t\t\tif ($message['message_direction'] == 'inbound') {\n\t\t\t\t\t$message_from = $message['message_to'];\n\t\t\t\t\t$media_source = format_phone($message['message_from']);\n\t\t\t\t}\n\t\t\t\tif ($message['message_direction'] == 'outbound') {\n\t\t\t\t\t$media_source = format_phone($message['message_to']);\n\t\t\t\t}\n\n\t\t\t\t//message bubble\n\t\t\t\t\techo \"<span class='message-bubble message-bubble-\".($message['message_direction'] == 'inbound' ? 'em' : 'me').\"'>\";\n\t\t\t\t\t\t//contact image em\n\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t$message['message_direction'] == 'inbound' &&\n\t\t\t\t\t\t\t\tis_array($_SESSION['tmp']['messages']['contact_em'][$contact_uuid]) &&\n\t\t\t\t\t\t\t\t@sizeof($_SESSION['tmp']['messages']['contact_em'][$contact_uuid]) != 0\n\t\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\techo \"<div class='message-bubble-image-em'>\\n\";\n\t\t\t\t\t\t\t\techo \"\t<img class='message-bubble-image-em'><br />\\n\";\n\t\t\t\t\t\t\t\techo \"</div>\\n\";\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t//contact image me\n\t\t\t\t\t\t\telse if (\n\t\t\t\t\t\t\t\tis_array($_SESSION['tmp']['messages']['contact_me']) &&\n\t\t\t\t\t\t\t\t@sizeof($_SESSION['tmp']['messages']['contact_me']) != 0\n\t\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\techo \"<div class='message-bubble-image-me'>\\n\";\n\t\t\t\t\t\t\t\techo \"\t<img class='message-bubble-image-me'><br />\\n\";\n\t\t\t\t\t\t\t\techo \"</div>\\n\";\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\techo \"<div style='display: table;'>\\n\";\n\t\t\t\t\t\t//message\n\t\t\t\t\t\t\tif ($message['message_text'] != '') {\n\t\t\t\t\t\t\t\techo \"<div class='message-text'>\".str_replace(\"\\n\",'<br />',escape($message['message_text'])).\"</div>\\n\";\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t//attachments\n\t\t\t\t\t\t\tif (is_array($message_media[$message['message_uuid']]) && @sizeof($message_media[$message['message_uuid']]) != 0) {\n\n\t\t\t\t\t\t\t\tforeach ($message_media[$message['message_uuid']] as $media) {\n\t\t\t\t\t\t\t\t\tif ($media['type'] != 'txt') {\n\t\t\t\t\t\t\t\t\t\tif ($media['type'] == 'jpg' || $media['type'] == 'jpeg' || $media['type'] == 'gif' || $media['type'] == 'png') {\n\t\t\t\t\t\t\t\t\t\t\techo \"<a href='#' onclick=\\\"display_media('\".$media['uuid'].\"','\".$media_source.\"');\\\" class='message-media-link-\".($message['message_direction'] == 'inbound' ? 'em' : 'me').\"'>\";\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\t\t\techo \"<a href='message_media.php?id=\".$media['uuid'].\"&src=\".$media_source.\"&action=download' class='message-media-link-\".($message['message_direction'] == 'inbound' ? 'em' : 'me').\"'>\";\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\techo \"<img src='resources/images/attachment.png' style='width: 16px; height: 16px; border: none; margin-right: 10px;'>\";\n\t\t\t\t\t\t\t\t\t\techo \"<span style='font-size: 85%; white-space: nowrap;'>\".strtoupper($media['type']).' &middot; '.strtoupper(byte_convert($media['size'])).\"</span>\";\n\t\t\t\t\t\t\t\t\t\techo \"</a>\\n\";\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\techo \"<br />\\n\";\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t//message when\n\t\t\t\t\t\t\techo \"<span class='message-bubble-when'>\".(date('m-d-Y') != format_when_local($message['message_date'],'d') ? format_when_local($message['message_date']) : format_when_local($message['message_date'],'t')).\"</span>\\n\";\n\t\t\t\t\t\techo \"</div>\\n\";\n\t\t\t\t\techo \"</span>\\n\";\n\t\t\t}\n\t\t\techo \"<span id='thread_bottom'></span>\\n\";\n\t\t}\n\n\t\techo \"<script>\\n\";\n\t\t//set current contact\n\t\t\techo \"\t$('#contact_current_number').val('\".$number.\"');\\n\";\n\t\t//set bubble contact images from src images\n\t\t\techo \"\t$('img.message-bubble-image-em').attr('src', $('img#src_message-bubble-image-em_\".$contact_uuid.\"').attr('src'));\\n\";\n\t\t\techo \"\t$('img.message-bubble-image-me').attr('src', $('img#src_message-bubble-image-me').attr('src'));\\n\";\n\t\techo \"</script>\\n\";\n\n\tif (!$refresh) {\n\t\techo \"</div>\\n\";\n\n\t\tif (permission_exists('message_add')) {\n\t\t\t//output input form\n\t\t\techo \"<form id='message_compose' method='post' enctype='multipart/form-data' action='message_send.php'>\\n\";\n\t\t\techo \"<input type='hidden' name='message_from' value='\".$message_from.\"'>\\n\";\n\t\t\techo \"<input type='hidden' name='message_to' value='\".$number.\"'>\\n\";\n\t\t\techo \"<textarea class='formfld' id='message_text' name='message_text' style='width: 100%; max-width: 100%; min-height: 55px; border: 1px solid #cbcbcb; resize: vertical; padding: 5px 8px; margin-top: 10px; margin-bottom: 5px;' placeholder=\\\"\".$text['description-enter_response'].\"\\\"></textarea>\";\n\t\t\techo \"<table cellpadding='0' cellspacing='0' border='0' width='100%' style='margin-top: 5px;'>\\n\";\n\t\t\techo \"\t<tr>\\n\";\n\t\t\techo \"\t\t<td><img src='resources/images/attachment.png' style='min-width: 20px; height: 20px; border: none; padding-right: 5px;'></td>\\n\";\n\t\t\techo \"\t\t<td width='100%'><input type='file' class='formfld' multiple='multiple' name='message_media[]' id='message_new_media'></td>\\n\";\n\t\t\techo \"\t</td>\\n\";\n\t\t\techo \"</table>\\n\";\n\t\t\techo \"<table cellpadding='0' cellspacing='0' border='0' width='100%' style='margin-top: 15px;'>\\n\";\n\t\t\techo \"\t<tr>\\n\";\n\t\t\techo \"\t\t<td align='left' width='50%'><input type='reset' class='btn' value='\".$text['button-clear'].\"' onclick=\\\"$('#message_text').trigger('focus');\\\"></td>\\n\";\n\t\t\techo \"\t\t<td align='center'><span id='thread_refresh_state'><img src='resources/images/refresh_active.gif' style='width: 16px; height: 16px; border: none; cursor: pointer;' onclick=\\\"refresh_thread_stop('\".$number.\"','\".$contact_uuid.\"');\\\" alt=\\\"\".$text['label-refresh_pause'].\"\\\" title=\\\"\".$text['label-refresh_pause'].\"\\\"></span></td>\\n\";\n\t\t\techo \"\t\t<td align='right' width='50%'><input type='submit' class='btn' value='\".$text['button-send'].\"' title=\\\"\".$text['label-ctrl_enter'].\"\\\"></td>\\n\";\n\t\t\techo \"\t</td>\\n\";\n\t\t\techo \"</table>\\n\";\n\t\t\techo \"</form>\\n\";\n\n\t\t//js to load messages for clicked number\n\t\t\techo \"<script>\\n\";\n\t\t\t//define form submit function\n\t\t\techo \"\t$('#message_compose').submit(function(event) {\\n\";\n\t\t\techo \"\t\tevent.preventDefault();\\n\";\n\t\t\techo \"\t\t$.ajax({\\n\";\n\t\t\techo \"\t\t\turl: $(this).attr('action'),\\n\";\n\t\t\techo \"\t\t\ttype: $(this).attr('method'),\\n\";\n\t\t\techo \"\t\t\tdata: new FormData(this),\\n\";\n\t\t\techo \"\t\t\tprocessData: false,\\n\";\n\t\t\techo \"\t\t\tcontentType: false,\\n\";\n\t\t\techo \"\t\t\tcache: false,\\n\";\n\t\t\techo \"\t\t\tsuccess: function(){\\n\";\n\t\t\techo \"\t\t\t\t\tdocument.getElementById('message_compose').reset();\\n\";\n\t\t\tif (!http_user_agent('mobile')) {\n\t\t\t\techo \"\t\t\t\tif ($('#message_new_layer').is(':hidden')) {\\n\";\n\t\t\t\techo \"\t\t\t\t\t$('#message_text').trigger('focus');\\n\";\n\t\t\t\techo \"\t\t\t\t}\\n\";\n\t\t\t}\n\t\t\techo \"\t\t\t\t\trefresh_thread('\".$number.\"', '\".$contact_uuid.\"', 'true');\\n\";\n\t\t\techo \"\t\t\t\t}\\n\";\n\t\t\techo \"\t\t});\\n\";\n\t\t\techo \"\t});\\n\";\n\t\t\t//enable ctrl+enter to send\n\t\t\techo \"\t$('#message_text').keydown(function (event) {\\n\";\n\t\t\techo \"\t\tif ((event.keyCode == 10 || event.keyCode == 13) && event.ctrlKey) {\\n\";\n\t\t\techo \"\t\t\t$('#message_compose').submit();\\n\";\n\t\t\techo \"\t\t}\\n\";\n\t\t\techo \"\t});\\n\";\n\n\t\t\techo \"</script>\\n\";\n\t\t}\n\t}\n\n?>"], "fixing_code": ["<?php\n/*\n\tFusionPBX\n\tVersion: MPL 1.1\n\n\tThe contents of this file are subject to the Mozilla Public License Version\n\t1.1 (the \"License\"); you may not use this file except in compliance with\n\tthe License. You may obtain a copy of the License at\n\thttp://www.mozilla.org/MPL/\n\n\tSoftware distributed under the License is distributed on an \"AS IS\" basis,\n\tWITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n\tfor the specific language governing rights and limitations under the\n\tLicense.\n\n\tThe Original Code is FusionPBX\n\n\tThe Initial Developer of the Original Code is\n\tMark J Crane <markjcrane@fusionpbx.com>\n\tPortions created by the Initial Developer are Copyright (C) 2016-2018\n\tthe Initial Developer. All Rights Reserved.\n\n\tContributor(s):\n\tMark J Crane <markjcrane@fusionpbx.com>\n*/\n\n//includes\n\trequire_once \"root.php\";\n\trequire_once \"resources/require.php\";\n\trequire_once \"resources/check_auth.php\";\n\n//check permissions\n\tif (!permission_exists('message_view')) {\n\t\techo \"access denied\";\n\t\texit;\n\t}\n\n//add multi-lingual support\n\t$language = new text;\n\t$text = $language->get();\n\n//get number of messages to load\n\t$number = preg_replace('{[\\D]}', '', $_GET['number']);\n\t$contact_uuid = (is_uuid($_GET['contact_uuid'])) ? $_GET['contact_uuid'] : null;\n\n//set refresh flag\n\t$refresh = $_GET['refresh'] == 'true' ? true : false;\n\n//get messages\n\tif (isset($_SESSION['message']['display_last']['text']) && $_SESSION['message']['display_last']['text'] != '') {\n\t\t$array = explode(' ',$_SESSION['message']['display_last']['text']);\n\t\tif (is_array($array) && is_numeric($array[0]) && $array[0] > 0) {\n\t\t\tif ($array[1] == 'messages') {\n\t\t\t\t$limit = limit_offset($array[0], 0);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t$since = \"and message_date >= :message_date \";\n\t\t\t\t$parameters['message_date'] = date(\"Y-m-d H:i:s\", strtotime('-'.$_SESSION['message']['display_last']['text']));\n\t\t\t}\n\t\t}\n\t}\n\tif ($limit == '' && $since == '') { $limit = limit_offset(25, 0); } //default (message count)\n\t$sql = \"select \";\n\t$sql .= \"message_uuid, \";\n\t$sql .= \"domain_uuid, \";\n\t$sql .= \"user_uuid, \";\n\t$sql .= \"contact_uuid, \";\n\t$sql .= \"message_type, \";\n\t$sql .= \"message_direction, \";\n\t$sql .= \"message_date at time zone :time_zone as message_date, \";\n\t$sql .= \"message_from, \";\n\t$sql .= \"message_to, \";\n\t$sql .= \"message_text \";\n\t$sql .= \"from v_messages \";\n\t$sql .= \"where user_uuid = :user_uuid \";\n\t$sql .= \"and (domain_uuid = :domain_uuid or domain_uuid is null) \";\n\t$sql .= $since;\n\t$sql .= \"and (message_from like :message_number or message_to like :message_number) \";\n\t$sql .= \"order by message_date desc \";\n\t$sql .= $limit;\n\t$parameters['time_zone'] = $_SESSION['domain']['time_zone']['name'];\n\t$parameters['user_uuid'] = $_SESSION['user_uuid'];\n\t$parameters['domain_uuid'] = $domain_uuid;\n\t$parameters['message_number'] = '%'.$number;\n\t$database = new database;\n\t$messages = $database->select($sql, $parameters, 'all');\n\t$messages = array_reverse($messages);\n\tunset($sql, $parameters);\n\n//get media (if any)\n\t$sql = \"select \";\n\t$sql .= \"message_uuid, \";\n\t$sql .= \"message_media_uuid, \";\n\t$sql .= \"message_media_type, \";\n\t$sql .= \"length(decode(message_media_content,'base64')) as message_media_size \";\n\t$sql .= \"from v_message_media \";\n\t$sql .= \"where user_uuid = :user_uuid \";\n\t$sql .= \"and (domain_uuid = :domain_uuid or domain_uuid is null) \";\n\t$sql .= \"and ( \";\n\tforeach ($messages as $index => $message) {\n\t\t$message_uuids[] = \"message_uuid = :message_uuid_\".$index;\n\t\t$parameters['message_uuid_'.$index] = $message['message_uuid'];\n\t}\n\t$sql .= implode(' or ', $message_uuids);\n\t$sql .= \") \";\n\t$sql .= \"and message_media_type <> 'txt' \";\n\t$parameters['user_uuid'] = $_SESSION['user_uuid'];\n\t$parameters['domain_uuid'] = $domain_uuid;\n\t$database = new database;\n\t$rows = $database->select($sql, $parameters, 'all');\n\tunset($sql, $parameters, $index);\n\n//prep media array\n\tif (is_array($rows) && @sizeof($rows) != 0) {\n\t\tforeach ($rows as $index => $row) {\n\t\t\t$message_media[$row['message_uuid']][$index]['uuid'] = $row['message_media_uuid'];\n\t\t\t$message_media[$row['message_uuid']][$index]['type'] = $row['message_media_type'];\n\t\t\t$message_media[$row['message_uuid']][$index]['size'] = $row['message_media_size'];\n\t\t}\n\t}\n\n//css styles\n\techo \"<style>\\n\";\n\techo \"\t.message-bubble {\\n\";\n\techo \"\t\tdisplay: table;\\n\";\n\techo \"\t\tpadding: 10px;\\n\";\n\techo \"\t\tborder: 1px solid;\\n\";\n\techo \"\t\tmargin-bottom: 10px;\\n\";\n\techo \"\t\t}\\n\";\n\n\techo \"\t.message-bubble-em {\\n\";\n\techo \"\t\tmargin-right: 30%;\\n\";\n\techo \"\t\tborder-radius: 0 20px 20px 20px;\\n\";\n\techo \"\t\tborder-color: #cffec7;\\n\";\n\techo \"\t\tbackground-color: #ecffe9;\\n\";\n\techo \"\t\tclear: both;\\n\";\n\techo \"\t\t}\\n\";\n\n\techo \"\t.message-bubble-me {\\n\";\n\techo \"\t\tfloat: right;\\n\";\n\techo \"\t\tmargin-left: 30%;\\n\";\n\techo \"\t\tborder-radius: 20px 20px 0 20px;\\n\";\n\techo \"\t\tborder-color: #cbf0ff;\\n\";\n\techo \"\t\tbackground-color: #e5f7ff;\\n\";\n\techo \"\t\tclear: both;\\n\";\n\techo \"\t\t}\\n\";\n\n\techo \"\timg.message-bubble-image-em {\\n\";\n\techo \"\t\twidth: 100px;\\n\";\n\techo \"\t\theight: auto;\\n\";\n\techo \"\t\tborder-radius: 0 11px 11px 11px;\\n\";\n\techo \"\t\tborder: 1px solid #cffec7;\\n\";\n\techo \"\t\t}\\n\";\n\n\techo \"\timg.message-bubble-image-me {\\n\";\n\techo \"\t\twidth: 100px;\\n\";\n\techo \"\t\theight: auto;\\n\";\n\techo \"\t\tborder-radius: 11px 11px 0 11px;\\n\";\n\techo \"\t\tborder: 1px solid #cbf0ff;\\n\";\n\techo \"\t\t}\\n\";\n\n\techo \"\tdiv.message-bubble-image-em {\\n\";\n\techo \"\t\tfloat: left;\\n\";\n\techo \"\t\tmargin-right: 15px;\\n\";\n\techo \"\t\ttext-align: left;\\n\";\n\techo \"\t\t}\\n\";\n\n\techo \"\tdiv.message-bubble-image-me {\\n\";\n\techo \"\t\tfloat: right;\\n\";\n\techo \"\t\tmargin-left: 15px;\\n\";\n\techo \"\t\ttext-align: right;\\n\";\n\techo \"\t\t}\\n\";\n\n\techo \"\t.message-text {\\n\";\n\techo \"\t\tpadding-bottom: 5px;\\n\";\n\techo \"\t\tfont-size: 90%;\\n\";\n\techo \"\t\t}\\n\";\n\n\techo \"\t.message-bubble-when {\\n\";\n\techo \"\t\tfont-size: 71%;\\n\";\n\techo \"\t\tfont-style: italic;\\n\";\n\techo \"\t\t}\\n\";\n\n\techo \"\t.message-media-link-em {\\n\";\n\techo \"\t\tdisplay: inline-block;\\n\";\n\techo \"\t\tmargin: 5px 10px 5px 0;\\n\";\n\techo \"\t\tpadding: 8px;\\n\";\n\techo \"\t\tbackground: #cffec7;\\n\";\n\techo \"\t\tborder-radius: 7px;\\n\";\n\techo \"\t\ttext-align: center;\\n\";\n\techo \"\t\t}\\n\";\n\n\techo \"\t.message-media-link-me {\\n\";\n\techo \"\t\tdisplay: inline-block;\\n\";\n\techo \"\t\tmargin: 5px 10px 5px 0;\\n\";\n\techo \"\t\tpadding: 8px;\\n\";\n\techo \"\t\tbackground: #cbf0ff;\\n\";\n\techo \"\t\tborder-radius: 7px;\\n\";\n\techo \"\t\ttext-align: center;\\n\";\n\techo \"\t\t}\\n\";\n\n\techo \"</style>\\n\";\n\n\tif (!$refresh) {\n\t\techo \"<div id='thread_messages' style='min-height: 300px; overflow: auto; padding-right: 15px;'>\\n\";\n\t}\n\n\t//output messages\n\t\tif (is_array($messages) && @sizeof($messages) != 0) {\n\t\t\tforeach ($messages as $message) {\n\t\t\t\t//parse from message\n\t\t\t\tif ($message['message_direction'] == 'inbound') {\n\t\t\t\t\t$message_from = $message['message_to'];\n\t\t\t\t\t$media_source = format_phone($message['message_from']);\n\t\t\t\t}\n\t\t\t\tif ($message['message_direction'] == 'outbound') {\n\t\t\t\t\t$media_source = format_phone($message['message_to']);\n\t\t\t\t}\n\n\t\t\t\t//message bubble\n\t\t\t\t\techo \"<span class='message-bubble message-bubble-\".($message['message_direction'] == 'inbound' ? 'em' : 'me').\"'>\";\n\t\t\t\t\t\t//contact image em\n\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t$message['message_direction'] == 'inbound' &&\n\t\t\t\t\t\t\t\tis_array($_SESSION['tmp']['messages']['contact_em'][$contact_uuid]) &&\n\t\t\t\t\t\t\t\t@sizeof($_SESSION['tmp']['messages']['contact_em'][$contact_uuid]) != 0\n\t\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\techo \"<div class='message-bubble-image-em'>\\n\";\n\t\t\t\t\t\t\t\techo \"\t<img class='message-bubble-image-em'><br />\\n\";\n\t\t\t\t\t\t\t\techo \"</div>\\n\";\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t//contact image me\n\t\t\t\t\t\t\telse if (\n\t\t\t\t\t\t\t\tis_array($_SESSION['tmp']['messages']['contact_me']) &&\n\t\t\t\t\t\t\t\t@sizeof($_SESSION['tmp']['messages']['contact_me']) != 0\n\t\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\techo \"<div class='message-bubble-image-me'>\\n\";\n\t\t\t\t\t\t\t\techo \"\t<img class='message-bubble-image-me'><br />\\n\";\n\t\t\t\t\t\t\t\techo \"</div>\\n\";\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\techo \"<div style='display: table;'>\\n\";\n\t\t\t\t\t\t//message\n\t\t\t\t\t\t\tif ($message['message_text'] != '') {\n\t\t\t\t\t\t\t\techo \"<div class='message-text'>\".str_replace(\"\\n\",'<br />',escape($message['message_text'])).\"</div>\\n\";\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t//attachments\n\t\t\t\t\t\t\tif (is_array($message_media[$message['message_uuid']]) && @sizeof($message_media[$message['message_uuid']]) != 0) {\n\n\t\t\t\t\t\t\t\tforeach ($message_media[$message['message_uuid']] as $media) {\n\t\t\t\t\t\t\t\t\tif ($media['type'] != 'txt') {\n\t\t\t\t\t\t\t\t\t\tif ($media['type'] == 'jpg' || $media['type'] == 'jpeg' || $media['type'] == 'gif' || $media['type'] == 'png') {\n\t\t\t\t\t\t\t\t\t\t\techo \"<a href='#' onclick=\\\"display_media('\".$media['uuid'].\"','\".$media_source.\"');\\\" class='message-media-link-\".($message['message_direction'] == 'inbound' ? 'em' : 'me').\"'>\";\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\t\t\techo \"<a href='message_media.php?id=\".$media['uuid'].\"&src=\".$media_source.\"&action=download' class='message-media-link-\".($message['message_direction'] == 'inbound' ? 'em' : 'me').\"'>\";\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\techo \"<img src='resources/images/attachment.png' style='width: 16px; height: 16px; border: none; margin-right: 10px;'>\";\n\t\t\t\t\t\t\t\t\t\techo \"<span style='font-size: 85%; white-space: nowrap;'>\".strtoupper($media['type']).' &middot; '.strtoupper(byte_convert($media['size'])).\"</span>\";\n\t\t\t\t\t\t\t\t\t\techo \"</a>\\n\";\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\techo \"<br />\\n\";\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t//message when\n\t\t\t\t\t\t\techo \"<span class='message-bubble-when'>\".(date('m-d-Y') != format_when_local($message['message_date'],'d') ? format_when_local($message['message_date']) : format_when_local($message['message_date'],'t')).\"</span>\\n\";\n\t\t\t\t\t\techo \"</div>\\n\";\n\t\t\t\t\techo \"</span>\\n\";\n\t\t\t}\n\t\t\techo \"<span id='thread_bottom'></span>\\n\";\n\t\t}\n\n\t\techo \"<script>\\n\";\n\t\t//set current contact\n\t\t\techo \"\t$('#contact_current_number').val('\".$number.\"');\\n\";\n\t\t//set bubble contact images from src images\n\t\t\techo \"\t$('img.message-bubble-image-em').attr('src', $('img#src_message-bubble-image-em_\".$contact_uuid.\"').attr('src'));\\n\";\n\t\t\techo \"\t$('img.message-bubble-image-me').attr('src', $('img#src_message-bubble-image-me').attr('src'));\\n\";\n\t\techo \"</script>\\n\";\n\n\tif (!$refresh) {\n\t\techo \"</div>\\n\";\n\n\t\tif (permission_exists('message_add')) {\n\t\t\t//output input form\n\t\t\techo \"<form id='message_compose' method='post' enctype='multipart/form-data' action='message_send.php'>\\n\";\n\t\t\techo \"<input type='hidden' name='message_from' value='\".$message_from.\"'>\\n\";\n\t\t\techo \"<input type='hidden' name='message_to' value='\".$number.\"'>\\n\";\n\t\t\techo \"<textarea class='formfld' id='message_text' name='message_text' style='width: 100%; max-width: 100%; min-height: 55px; border: 1px solid #cbcbcb; resize: vertical; padding: 5px 8px; margin-top: 10px; margin-bottom: 5px;' placeholder=\\\"\".$text['description-enter_response'].\"\\\"></textarea>\";\n\t\t\techo \"<table cellpadding='0' cellspacing='0' border='0' width='100%' style='margin-top: 5px;'>\\n\";\n\t\t\techo \"\t<tr>\\n\";\n\t\t\techo \"\t\t<td><img src='resources/images/attachment.png' style='min-width: 20px; height: 20px; border: none; padding-right: 5px;'></td>\\n\";\n\t\t\techo \"\t\t<td width='100%'><input type='file' class='formfld' multiple='multiple' name='message_media[]' id='message_new_media'></td>\\n\";\n\t\t\techo \"\t</td>\\n\";\n\t\t\techo \"</table>\\n\";\n\t\t\techo \"<table cellpadding='0' cellspacing='0' border='0' width='100%' style='margin-top: 15px;'>\\n\";\n\t\t\techo \"\t<tr>\\n\";\n\t\t\techo \"\t\t<td align='left' width='50%'><input type='reset' class='btn' value='\".$text['button-clear'].\"' onclick=\\\"$('#message_text').trigger('focus');\\\"></td>\\n\";\n\t\t\techo \"\t\t<td align='center'><span id='thread_refresh_state'><img src='resources/images/refresh_active.gif' style='width: 16px; height: 16px; border: none; cursor: pointer;' onclick=\\\"refresh_thread_stop('\".$number.\"','\".$contact_uuid.\"');\\\" alt=\\\"\".$text['label-refresh_pause'].\"\\\" title=\\\"\".$text['label-refresh_pause'].\"\\\"></span></td>\\n\";\n\t\t\techo \"\t\t<td align='right' width='50%'><input type='submit' class='btn' value='\".$text['button-send'].\"' title=\\\"\".$text['label-ctrl_enter'].\"\\\"></td>\\n\";\n\t\t\techo \"\t</td>\\n\";\n\t\t\techo \"</table>\\n\";\n\t\t\techo \"</form>\\n\";\n\n\t\t//js to load messages for clicked number\n\t\t\techo \"<script>\\n\";\n\t\t\t//define form submit function\n\t\t\techo \"\t$('#message_compose').submit(function(event) {\\n\";\n\t\t\techo \"\t\tevent.preventDefault();\\n\";\n\t\t\techo \"\t\t$.ajax({\\n\";\n\t\t\techo \"\t\t\turl: $(this).attr('action'),\\n\";\n\t\t\techo \"\t\t\ttype: $(this).attr('method'),\\n\";\n\t\t\techo \"\t\t\tdata: new FormData(this),\\n\";\n\t\t\techo \"\t\t\tprocessData: false,\\n\";\n\t\t\techo \"\t\t\tcontentType: false,\\n\";\n\t\t\techo \"\t\t\tcache: false,\\n\";\n\t\t\techo \"\t\t\tsuccess: function(){\\n\";\n\t\t\techo \"\t\t\t\t\tdocument.getElementById('message_compose').reset();\\n\";\n\t\t\tif (!http_user_agent('mobile')) {\n\t\t\t\techo \"\t\t\t\tif ($('#message_new_layer').is(':hidden')) {\\n\";\n\t\t\t\techo \"\t\t\t\t\t$('#message_text').trigger('focus');\\n\";\n\t\t\t\techo \"\t\t\t\t}\\n\";\n\t\t\t}\n\t\t\techo \"\t\t\t\t\trefresh_thread('\".$number.\"', '\".$contact_uuid.\"', 'true');\\n\";\n\t\t\techo \"\t\t\t\t}\\n\";\n\t\t\techo \"\t\t});\\n\";\n\t\t\techo \"\t});\\n\";\n\t\t\t//enable ctrl+enter to send\n\t\t\techo \"\t$('#message_text').keydown(function (event) {\\n\";\n\t\t\techo \"\t\tif ((event.keyCode == 10 || event.keyCode == 13) && event.ctrlKey) {\\n\";\n\t\t\techo \"\t\t\t$('#message_compose').submit();\\n\";\n\t\t\techo \"\t\t}\\n\";\n\t\t\techo \"\t});\\n\";\n\n\t\t\techo \"</script>\\n\";\n\t\t}\n\t}\n\n?>\n"], "filenames": ["app/messages/messages_thread.php"], "buggy_code_start_loc": [44], "buggy_code_end_loc": [339], "fixing_code_start_loc": [44], "fixing_code_end_loc": [339], "type": "CWE-79", "message": "In FusionPBX up to 4.5.7, the file app\\messages\\messages_thread.php uses an unsanitized \"contact_uuid\" variable coming from the URL, which is reflected on 3 occasions in HTML, leading to XSS.", "other": {"cve": {"id": "CVE-2019-16971", "sourceIdentifier": "cve@mitre.org", "published": "2019-10-22T22:15:10.463", "lastModified": "2023-02-03T21:51:18.717", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "In FusionPBX up to 4.5.7, the file app\\messages\\messages_thread.php uses an unsanitized \"contact_uuid\" variable coming from the URL, which is reflected on 3 occasions in HTML, leading to XSS."}, {"lang": "es", "value": "En FusionPBX versiones hasta 4.5.7, el archivo app\\messages\\messages_thread.php utiliza una variable \"contact_uuid\" no saneada proveniente de la URL, que es reflejada en 3 ocasiones en HTML, conllevando a una vulnerabilidad de tipo XSS."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:fusionpbx:fusionpbx:*:*:*:*:*:*:*:*", "versionEndIncluding": "4.5.7", "matchCriteriaId": "A5A0C1F9-8032-46C6-8DD4-DB91FACF7330"}]}]}], "references": [{"url": "https://github.com/fusionpbx/fusionpbx/commit/c48a160af53352ad1a43518b7d0faab16b8dfbcc", "source": "cve@mitre.org", "tags": ["Patch"]}, {"url": "https://resp3ctblog.wordpress.com/2019/10/19/fusionpbx-xss-4/", "source": "cve@mitre.org", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/fusionpbx/fusionpbx/commit/c48a160af53352ad1a43518b7d0faab16b8dfbcc"}}