{"buggy_code": ["<?php\n\nnamespace Oro\\Bundle\\EmailBundle\\Provider;\n\nuse Doctrine\\Inflector\\Inflector;\nuse Oro\\Bundle\\EmailBundle\\Model\\EmailTemplateInterface;\nuse Oro\\Bundle\\EntityBundle\\Twig\\Sandbox\\TemplateRenderer;\nuse Oro\\Bundle\\EntityBundle\\Twig\\Sandbox\\TemplateRendererConfigProviderInterface;\nuse Oro\\Bundle\\EntityBundle\\Twig\\Sandbox\\VariableProcessorRegistry;\nuse Symfony\\Contracts\\Translation\\TranslatorInterface;\nuse Twig\\Environment;\n\n/**\n * Renders email template as TWIG template in a sandboxed environment.\n */\nclass EmailRenderer extends TemplateRenderer\n{\n    private const VARIABLE_NOT_FOUND = 'oro.email.variable.not.found';\n\n    /** @var TranslatorInterface */\n    private $translator;\n\n    public function __construct(\n        Environment $environment,\n        TemplateRendererConfigProviderInterface $configProvider,\n        VariableProcessorRegistry $variableProcessors,\n        TranslatorInterface $translator,\n        Inflector $inflector\n    ) {\n        parent::__construct($environment, $configProvider, $variableProcessors, $inflector);\n        $this->translator = $translator;\n    }\n\n    /**\n     * Compiles the given email template.\n     *\n     * @param EmailTemplateInterface $template\n     * @param array $templateParams\n     *\n     * @return array [email subject, email body]\n     *\n     * @throws \\Twig\\Error\\Error if the given template cannot be compiled\n     */\n    public function compileMessage(EmailTemplateInterface $template, array $templateParams = []): array\n    {\n        $subjectTemplate = $template->getSubject();\n        $contentTemplate = $template->getContent();\n\n        $subject = $subjectTemplate ? $this->renderTemplate($subjectTemplate, $templateParams) : '';\n        $content = $contentTemplate ? $this->renderTemplate($contentTemplate, $templateParams) : '';\n\n        return [$subject, $content];\n    }\n\n    /**\n     * Compiles the given email template for the preview purposes.\n     *\n     * @throws \\Twig\\Error\\Error if the given template cannot be compiled\n     */\n    public function compilePreview(EmailTemplateInterface $template): string\n    {\n        $this->ensureSandboxConfigured();\n\n        return $this->environment\n            ->createTemplate('{% verbatim %}' . $template->getContent() . '{% endverbatim %}')\n            ->render();\n    }\n\n    /**\n     * {@inheritdoc}\n     */\n    protected function getVariableNotFoundMessage(): string\n    {\n        return $this->translator->trans(self::VARIABLE_NOT_FOUND);\n    }\n}\n", "services:\n    oro_email.swiftmailer.mailer.abstract:\n        parent: swiftmailer.mailer.abstract\n        decorates: swiftmailer.mailer.abstract\n        class: Oro\\Bundle\\EmailBundle\\Util\\MailerWrapper\n\n    oro_email.entity.cache.warmer:\n        class: Oro\\Bundle\\EmailBundle\\Cache\\EntityCacheWarmer\n        arguments:\n            - '@oro_email.email.owner.provider.storage'\n            - '%oro_email.entity.cache_dir%'\n            - '%oro_email.entity.cache_namespace%'\n            - '%oro_email.entity.proxy_name_template%'\n            - '@kernel'\n        tags:\n            - { name: kernel.cache_warmer, priority: 30 }\n            - { name: oro_entity_extend.warmer }\n\n    oro_email.email.cache.manager:\n        class: Oro\\Bundle\\EmailBundle\\Cache\\EmailCacheManager\n        public: true\n        arguments:\n            - '@doctrine.orm.entity_manager'\n            - '@event_dispatcher'\n            - '@oro_email.email_body_synchronizer'\n\n    Oro\\Bundle\\EmailBundle\\Cache\\EmailCacheManager:\n        alias: 'oro_email.email.cache.manager'\n\n    oro_email.email_holder_helper:\n        class: Oro\\Bundle\\EmailBundle\\Tools\\EmailHolderHelper\n        arguments:\n            - '@oro_entity_config.provider.extend'\n\n    oro_email.email.address.helper:\n        class: Oro\\Bundle\\EmailBundle\\Tools\\EmailAddressHelper\n        public: true\n\n    oro_email.email_body_loader_selector:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\EmailBodyLoaderSelector\n        arguments:\n            - !tagged_iterator oro_email.email_body_loader\n\n    oro_email.email_flag_manager_loader_selector:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\EmailFlagManagerLoaderSelector\n        arguments:\n            - !tagged_iterator oro_email.email_flag_manager_loader\n\n    oro_email.email_address.entity_manager:\n        parent: oro_entity.abstract_entity_manager\n        arguments:\n            - 'OroEmailBundle:EmailAddress'\n\n    oro_email.link.email_address.entity_manager:\n        tags:\n            - { name: oro_service_link,  service: oro_email.email_address.entity_manager }\n\n    oro_email.email.address.manager:\n        class: Oro\\Bundle\\EmailBundle\\Entity\\Manager\\EmailAddressManager\n        arguments:\n            - '%oro_email.entity.cache_namespace%'\n            - '%oro_email.entity.proxy_name_template%'\n        calls:\n            - [setEntityManagerLink, ['@oro_email.link.email_address.entity_manager']]\n\n    oro_email.email.owner.provider.storage:\n        class: Oro\\Bundle\\EmailBundle\\Entity\\Provider\\EmailOwnerProviderStorage\n\n    oro_email.email.owner.provider:\n        class: Oro\\Bundle\\EmailBundle\\Entity\\Provider\\EmailOwnerProvider\n        arguments:\n            - '@oro_email.email.owner.provider.storage'\n\n    oro_email.email.owner.manager:\n        class: Oro\\Bundle\\EmailBundle\\Entity\\Manager\\EmailOwnerManager\n        arguments:\n            - '@oro_email.email.owner.provider.storage'\n            - '@oro_email.email.address.manager'\n\n    oro_email.email.address.association_metadata_listener:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\EmailAddressAssociationMetadataListener\n        arguments:\n            - '@oro_email.email.address.manager'\n        tags:\n            - { name: doctrine.event_listener, event: loadClassMetadata }\n\n    oro_email.email.model.builder.helper:\n        class: Oro\\Bundle\\EmailBundle\\Builder\\Helper\\EmailModelBuilderHelper\n        arguments:\n            - '@oro_entity.routing_helper'\n            - '@oro_email.email.address.helper'\n            - '@oro_entity.entity_name_resolver'\n            - '@oro_security.token_accessor'\n            - '@oro_email.email.address.manager'\n            - '@doctrine.orm.entity_manager'\n            - '@oro_email.email.cache.manager'\n            - '@templating'\n            - '@oro_email.mailbox.manager'\n\n    oro_email.email.entity.builder:\n        class: Oro\\Bundle\\EmailBundle\\Builder\\EmailEntityBuilder\n        shared: false\n        arguments:\n            - '@oro_email.email.entity.batch_processor'\n            - '@oro_email.email.address.manager'\n            - '@oro_email.email.address.helper'\n            - '@doctrine'\n            - '@logger'\n\n    oro_email.email.model.builder:\n        class: Oro\\Bundle\\EmailBundle\\Builder\\EmailModelBuilder\n        public: true\n        arguments:\n            - '@oro_email.email.model.builder.helper'\n            - '@doctrine.orm.entity_manager'\n            - '@oro_config.user'\n            - '@oro_email.activity_list.provider'\n            - '@oro_email.provider.email_attachment_provider'\n            - '@oro_email.form.factory'\n            - '@request_stack'\n            - '@oro_ui.html_tag_helper'\n            - '@oro_attachment.provider.file_constraints'\n\n    Oro\\Bundle\\EmailBundle\\Builder\\EmailModelBuilder:\n        alias: 'oro_email.email.model.builder'\n\n    oro_email.email_websocket.processor:\n        class: Oro\\Bundle\\EmailBundle\\Model\\WebSocket\\WebSocketSendProcessor\n        arguments:\n            - '@oro_sync.websocket_client'\n            - '@oro_sync.client.connection_checker'\n\n    oro_email.event_listener.email_user_listener:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\EmailUserListener\n        arguments:\n            - '@oro_email.email_websocket.processor'\n        tags:\n            - { name: doctrine.event_listener, event: onFlush, priority: 1 }\n            - { name: doctrine.event_listener, event: postFlush, priority: 1 }\n\n    oro_email.email.entity.batch_processor:\n        class: Oro\\Bundle\\EmailBundle\\Builder\\EmailEntityBatchProcessor\n        shared: false\n        arguments:\n            - '@oro_email.email.address.manager'\n            - '@oro_email.email.owner.provider'\n            - '@event_dispatcher'\n\n    oro_email.listener.entity_listener:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\EntityListener\n        arguments:\n            - '@oro_message_queue.client.message_producer'\n            - '@Psr\\Container\\ContainerInterface'\n        tags:\n            - { name: doctrine.event_listener, event: onFlush }\n            - { name: doctrine.event_listener, event: postFlush }\n            - { name: doctrine.event_listener, event: postRemove }\n            - { name: container.service_subscriber, id: oro_email.email.owner.manager }\n            - { name: container.service_subscriber, id: oro_email.email.thread.manager }\n            - { name: container.service_subscriber, id: oro_email.email.activity.manager }\n            - { name: container.service_subscriber, id: oro_email.model.email_activity_updates }\n            - { name: container.service_subscriber, id: oro_email.email.address.manager }\n\n    oro_email.listener.auto_response_listener:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\AutoResponseListener\n        arguments:\n            - '@Psr\\Container\\ContainerInterface'\n        tags:\n            - { name: doctrine.event_listener, event: onFlush }\n            - { name: doctrine.event_listener, event: postFlush }\n            - { name: oro_featuretogle.feature, feature: email }\n            - { name: container.service_subscriber }\n            - { name: container.service_subscriber, id: oro_email.autoresponserule_manager }\n\n    oro_email.async.auto_response:\n        class: 'Oro\\Bundle\\EmailBundle\\Async\\AutoResponseMessageProcessor'\n        arguments:\n            - '@doctrine'\n            - '@oro_email.autoresponserule_manager'\n            - '@oro_message_queue.job.runner'\n            - '@logger'\n        tags:\n            - { name: 'oro_message_queue.client.message_processor' }\n\n    oro_email.async.auto_responses:\n        class: 'Oro\\Bundle\\EmailBundle\\Async\\AutoResponsesMessageProcessor'\n        arguments:\n            - '@oro_message_queue.client.message_producer'\n            - '@oro_message_queue.job.runner'\n            - '@logger'\n        tags:\n            - { name: 'oro_message_queue.client.message_processor' }\n\n    oro_email.async.add_email_associations:\n        class: 'Oro\\Bundle\\EmailBundle\\Async\\AddEmailAssociationsMessageProcessor'\n        arguments:\n            - '@oro_message_queue.client.message_producer'\n            - '@oro_message_queue.job.runner'\n            - '@logger'\n        tags:\n            - { name: 'oro_message_queue.client.message_processor' }\n\n    oro_email.async.add_email_association:\n        class: 'Oro\\Bundle\\EmailBundle\\Async\\AddEmailAssociationMessageProcessor'\n        arguments:\n            - '@oro_email.async.manager.association_manager'\n            - '@oro_message_queue.job.runner'\n            - '@logger'\n        tags:\n            - { name: 'oro_message_queue.client.message_processor' }\n\n    oro_email.async.update_email_associations:\n        class: 'Oro\\Bundle\\EmailBundle\\Async\\UpdateEmailAssociationsMessageProcessor'\n        arguments:\n            - '@oro_email.async.manager.association_manager'\n            - '@oro_message_queue.job.runner'\n            - '@logger'\n        tags:\n            - { name: 'oro_message_queue.client.message_processor' }\n\n    oro_email.async.update_email_owner_association:\n        class: 'Oro\\Bundle\\EmailBundle\\Async\\UpdateEmailOwnerAssociationMessageProcessor'\n        arguments:\n            - '@oro_email.async.manager.association_manager'\n            - '@oro_message_queue.job.runner'\n            - '@logger'\n        tags:\n            - { name: 'oro_message_queue.client.message_processor' }\n\n    oro_email.async.update_email_owner_associations:\n        class: 'Oro\\Bundle\\EmailBundle\\Async\\UpdateEmailOwnerAssociationsMessageProcessor'\n        arguments:\n            - '@oro_message_queue.client.message_producer'\n            - '@oro_message_queue.job.runner'\n            - '@logger'\n        tags:\n            - { name: 'oro_message_queue.client.message_processor' }\n\n    oro_email.async.sync_email_seen_flag:\n        class: 'Oro\\Bundle\\EmailBundle\\Async\\SyncEmailSeenFlagMessageProcessor'\n        arguments:\n            - '@doctrine'\n            - '@oro_email.email.flag.manager'\n            - '@logger'\n        tags:\n            - { name: 'oro_message_queue.client.message_processor' }\n\n    oro_email.async.purge_email_attachments:\n        class: 'Oro\\Bundle\\EmailBundle\\Async\\PurgeEmailAttachmentsMessageProcessor'\n        arguments:\n            - '@doctrine'\n            - '@oro_message_queue.client.message_producer'\n            - '@oro_message_queue.job.runner'\n            - '@oro_config.global'\n        tags:\n            - { name: 'oro_message_queue.client.message_processor' }\n\n    oro_email.async.purge_email_attachments_by_ids:\n        class: 'Oro\\Bundle\\EmailBundle\\Async\\PurgeEmailAttachmentsByIdsMessageProcessor'\n        arguments:\n            - '@doctrine'\n            - '@oro_message_queue.job.runner'\n            - '@logger'\n        tags:\n            - { name: 'oro_message_queue.client.message_processor' }\n\n    oro_email.manager.autoresponserule.api:\n        class: Oro\\Bundle\\SoapBundle\\Entity\\Manager\\ApiEntityManager\n        public: true\n        parent: oro_soap.manager.entity_manager.abstract\n        arguments:\n            - 'Oro\\Bundle\\EmailBundle\\Entity\\AutoResponseRule'\n            - '@doctrine.orm.entity_manager'\n\n    oro_email.autoresponserule_manager:\n        class: Oro\\Bundle\\EmailBundle\\Manager\\AutoResponseManager\n        arguments:\n            - '@doctrine'\n            - '@oro_email.email.model.builder'\n            - '@oro_email.mailer.processor'\n            - '@oro_email.email_renderer'\n            - '@logger'\n            - '@translator'\n            - '%oro_locale.language%'\n\n    oro_email.manager.email.api:\n        class: Oro\\Bundle\\EmailBundle\\Entity\\Manager\\EmailApiEntityManager\n        public: true\n        parent: oro_soap.manager.entity_manager.abstract\n        arguments:\n            - 'Oro\\Bundle\\EmailBundle\\Entity\\Email'\n            - '@doctrine.orm.entity_manager'\n            - '@oro_email.datagrid_query_factory'\n\n    oro_email.manager.email_origin.api:\n        class: Oro\\Bundle\\EmailBundle\\Entity\\Manager\\EmailOriginApiEntityManager\n        public: true\n        parent: oro_soap.manager.entity_manager.abstract\n        arguments:\n            - 'Oro\\Bundle\\EmailBundle\\Entity\\EmailOrigin'\n            - '@doctrine.orm.entity_manager'\n\n    oro_email.direct_mailer:\n        class: Oro\\Bundle\\EmailBundle\\Mailer\\DirectMailer\n        public: true\n        arguments:\n            - '@mailer'\n            - '@service_container'\n\n    oro_email.manager.emailtemplate.api:\n        class: Oro\\Bundle\\SoapBundle\\Entity\\Manager\\ApiEntityManager\n        public: true\n        parent: oro_soap.manager.entity_manager.abstract\n        arguments:\n            - 'Oro\\Bundle\\EmailBundle\\Entity\\EmailTemplate'\n            - '@doctrine.orm.entity_manager'\n\n    oro_email.cache:\n          parent: oro.cache.abstract\n          calls:\n              - [setNamespace, [ 'oro_email' ] ]\n\n    oro_email.listener.config_listener:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\EntityConfigListener\n        arguments:\n            - '@oro_email.email_renderer_configuration'\n        tags:\n            - { name: kernel.event_listener, event: oro.entity_config.pre_flush, method: preFlush }\n\n    oro_email.email_renderer:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\EmailRenderer\n        public: true\n        arguments:\n            - '@oro_email.twig.email_environment'\n            - '@oro_email.email_renderer_configuration'\n            - '@oro_email.emailtemplate.variable_processor'\n            - '@translator'\n            - '@Doctrine\\Inflector\\Inflector'\n        calls:\n            - [addSystemVariableDefaultFilter, ['userSignature', 'oro_html_sanitize']]\n        lazy: true\n\n    oro_email.email_renderer_configuration:\n        class: Oro\\Bundle\\EntityBundle\\Twig\\Sandbox\\TemplateRendererConfigProvider\n        arguments:\n            - '@oro_email.emailtemplate.variable_provider'\n            - '@oro_email.cache'\n            - 'oro_email.available_in_template_fields'\n\n    oro_email.twig.email_security_policy:\n        class: Twig\\Sandbox\\SecurityPolicy\n        arguments:\n            # tags\n            - [ 'app', 'for', 'if', 'spaceless' ]\n            # filters\n            - [ 'default', 'date', 'escape', 'format', 'length', 'lower', 'nl2br', 'number_format', 'title', 'trim', 'upper', 'oro_html_sanitize', 'slice' ]\n            # methods\n            - []\n            # properties\n            - []\n            # functions\n            - [ '_entity_var', 'date' ]\n\n    oro_email.twig.email_sandbox:\n        class: Twig\\Extension\\SandboxExtension\n        arguments:\n            - '@oro_email.twig.email_security_policy'\n            - true # use sandbox globally in instance\n\n    oro_email.twig.string_loader:\n        class: Twig\\Loader\\ArrayLoader\n\n    oro_email.twig.email_environment:\n        class: Twig\\Environment\n        arguments:\n            - '@oro_email.twig.string_loader'\n            - { strict_variables: true }\n        calls:\n            - [addExtension, ['@oro_email.twig.email_sandbox']]\n\n    oro_email.emailtemplate.variable_provider:\n        class: Oro\\Bundle\\EntityBundle\\Twig\\Sandbox\\VariablesProvider\n        public: true\n        arguments:\n            # All arguments are set by Oro\\Bundle\\EmailBundle\\DependencyInjection\\Compiler\\EmailTemplateVariablesPass\n            - ~ # providers\n            - [] # names of system variables providers\n            - [] # names of entity variables providers\n\n    oro_email.emailtemplate.variable_provider.entity:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\EntityVariablesProvider\n        arguments:\n            - '@translator'\n            - '@oro_entity_config.config_manager'\n            - '@doctrine'\n            - '@oro_ui.formatter'\n            - '@Doctrine\\Inflector\\Inflector'\n        tags:\n            - { name: oro_email.emailtemplate.variable_provider, scope: entity }\n\n    oro_email.emailtemplate.variable_provider.entity_routes:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\EntityRouteVariablesProvider\n        arguments:\n            - '@translator'\n            - '@oro_entity_config.config_manager'\n            - '@oro_config.user'\n        tags:\n            - { name: oro_email.emailtemplate.variable_provider, scope: entity }\n\n    oro_email.emailtemplate.variable_provider.system:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\SystemVariablesProvider\n        arguments:\n            - '@translator'\n            - '@oro_config.user'\n            - '@oro_locale.formatter.date_time'\n        tags:\n            - { name: oro_email.emailtemplate.variable_provider, scope: system }\n\n    oro_email.emailtemplate.variable_provider.user:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\LoggedUserVariablesProvider\n        arguments:\n            - '@translator'\n            - '@oro_security.token_accessor'\n            - '@oro_entity.entity_name_resolver'\n            - '@oro_config.user'\n            - '@oro_ui.html_tag_helper'\n        tags:\n            - { name: oro_email.emailtemplate.variable_provider, scope: system }\n\n    oro_email.validator.email_template_syntax:\n        class: Oro\\Bundle\\EmailBundle\\Validator\\EmailTemplateSyntaxValidator\n        arguments:\n            - '@oro_email.email_renderer'\n            - '@oro_locale.manager.localization'\n            - '@oro_entity_config.provider.entity'\n            - '@translator'\n        tags:\n            - { name: validator.constraint_validator, alias: oro_email.email_template_syntax_validator }\n\n    oro_email.validator.email_address_validator:\n        class: Oro\\Bundle\\EmailBundle\\Validator\\EmailAddressValidator\n        arguments:\n            - '@oro_email.email.address.helper'\n        tags:\n            - { name: validator.constraint_validator, alias: oro_email.email_address_validator }\n\n    oro_email.validator.email_recipients:\n        class: Oro\\Bundle\\EmailBundle\\Validator\\EmailRecipientsValidator\n        tags:\n            - { name: validator.constraint_validator, alias: oro_email.email_recipients_validator }\n\n    oro_email.validator.mailbox_origin:\n        class: Oro\\Bundle\\EmailBundle\\Validator\\MailboxOriginValidator\n        arguments:\n            - '@translator'\n        tags:\n            - { name: validator.constraint_validator, alias: oro_email.validator.mailbox_origin }\n\n    oro_email.validator.not_empty_email_template_translation_subject:\n        class: Oro\\Bundle\\EmailBundle\\Validator\\NotEmptyEmailTemplateTranslationSubjectValidator\n        tags:\n            - { name: validator.constraint_validator, alias: oro_email.not_empty_email_template_translation_subject }\n\n    oro_email.datagrid_query_factory:\n        class: Oro\\Bundle\\EmailBundle\\Datagrid\\EmailQueryFactory\n        arguments:\n            - '@oro_email.email.owner.provider.storage'\n            - '@oro_entity.entity_name_resolver'\n            - '@oro_email.mailbox.manager'\n            - '@oro_security.token_accessor'\n            - '@form.factory'\n            - '@oro_filter.filter_utility'\n\n    oro_email.emailtemplate.datagrid_view_list:\n        class: Oro\\Bundle\\EmailBundle\\Datagrid\\EmailTemplatesViewList\n        public: true\n        arguments:\n            - '@translator'\n\n    oro_email.emailfolder.datagrid_view_list:\n        class: Oro\\Bundle\\EmailBundle\\Datagrid\\EmailFolderViewList\n        public: true\n        arguments:\n            - '@translator'\n            - '@oro_email.mailbox_choice_list'\n\n    oro_email.emailseen.datagrid_view_list:\n        class: Oro\\Bundle\\EmailBundle\\Datagrid\\EmailSeenViewList\n        public: true\n        arguments:\n            - '@translator'\n            - '@oro_email.mailbox_choice_list'\n\n    oro_email.emailtemplate.datagrid_helper:\n        class: Oro\\Bundle\\EmailBundle\\Datagrid\\EmailTemplateGridHelper\n        public: true\n        arguments:\n            - '@oro_entity.entity_provider'\n            - '@translator'\n\n    oro_email_filter.filter_origin_folder:\n        class: Oro\\Bundle\\EmailBundle\\Filter\\ChoiceOriginFolderFilter\n        arguments:\n            - '@form.factory'\n            - '@oro_filter.filter_utility'\n        tags:\n            - { name: oro_filter.extension.orm_filter.filter, type: multiselect-originfolder }\n\n    oro_email_filter.filter_massage_type:\n        class: Oro\\Bundle\\EmailBundle\\Filter\\ChoiceMessageTypeFilter\n        arguments:\n            - '@form.factory'\n            - '@oro_filter.filter_utility'\n            - '@oro_email.email.owner.provider.storage'\n        tags:\n            - { name: oro_filter.extension.orm_filter.filter, type: multiselect-messagetype }\n\n    oro_email_filter.filter_email_string:\n        class: Oro\\Bundle\\EmailBundle\\Filter\\EmailStringFilter\n        arguments:\n            - '@form.factory'\n            - '@oro_filter.filter_utility'\n            - '@oro_email.email.owner.provider.storage'\n        tags:\n            - { name: oro_filter.extension.orm_filter.filter, type: email-string }\n\n    oro_email.mailer.processor:\n        class: Oro\\Bundle\\EmailBundle\\Mailer\\Processor\n        arguments:\n            - '@oro_entity.doctrine_helper'\n            - '@oro_email.direct_mailer'\n            - '@oro_email.email.address.helper'\n            - '@oro_email.email.entity.builder'\n            - '@oro_email.email.activity.manager'\n            - '@event_dispatcher'\n            - '@oro_security.encoder.default'\n            - '@oro_email.tools.email_origin_helper'\n\n    oro_email.workflow.action.send_email:\n        class: Oro\\Bundle\\EmailBundle\\Workflow\\Action\\SendEmail\n        arguments:\n            - '@oro_action.expression.context_accessor'\n            - '@oro_email.mailer.processor'\n            - '@oro_email.email.address.helper'\n            - '@oro_entity.entity_name_resolver'\n            - '@oro_email.tools.email_origin_helper'\n        calls:\n            - [setLogger, ['@logger']]\n        tags:\n            - { name: oro_action.action, alias: send_email }\n\n    oro_email.workflow.action.send_email_template:\n        class: Oro\\Bundle\\EmailBundle\\Workflow\\Action\\SendEmailTemplate\n        arguments:\n            - '@oro_action.expression.context_accessor'\n            - '@oro_email.mailer.processor'\n            - '@oro_email.email.address.helper'\n            - '@oro_entity.entity_name_resolver'\n            - '@validator'\n            - '@oro_email.sender.aggregated_email_templates'\n        calls:\n            - [setLogger, ['@logger']]\n        tags:\n            - { name: oro_action.action, alias: send_email_template }\n\n    oro_email.workflow.action.schedule_send_email_template:\n        parent: oro_email.workflow.action.send_email_template\n        class: Oro\\Bundle\\EmailBundle\\Workflow\\Action\\ScheduleSendEmailTemplate\n        arguments:\n            - '@oro_entity.doctrine_helper'\n            - '@oro_message_queue.client.message_producer'\n        calls:\n            - [setLogger, ['@logger']]\n        tags:\n            - { name: oro_action.action, alias: schedule_send_email_template }\n\n    oro_email.helper.datagrid.emails:\n        class: Oro\\Bundle\\EmailBundle\\Datagrid\\EmailGridHelper\n        public: true\n        arguments:\n            - '@oro_entity.doctrine_helper'\n            - '@oro_email.email_synchronization_manager'\n            - '@oro_activity.manager'\n            - 'Oro\\Bundle\\UserBundle\\Entity\\User'\n\n    Oro\\Bundle\\EmailBundle\\Datagrid\\EmailGridHelper:\n        alias: 'oro_email.helper.datagrid.emails'\n\n    oro_email.email_grid_result_helper:\n        class: Oro\\Bundle\\EmailBundle\\Datagrid\\EmailGridResultHelper\n        arguments:\n            - '@doctrine'\n            - '@oro_email.email.owner.provider.storage'\n            - '@oro_email.email_grid_mailbox_name_helper'\n            - '@oro_email.email.address.manager'\n\n    oro_email.email_grid_mailbox_name_helper:\n        class: Oro\\Bundle\\EmailBundle\\Datagrid\\MailboxNameHelper\n        arguments:\n            - '@translator'\n\n    oro_email.listener.datagrid.email:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\Datagrid\\EmailGridListener\n        arguments:\n            - '@oro_email.datagrid_query_factory'\n            - '@oro_filter.provider.state.filters'\n            - '@oro_config.manager'\n            - '@oro_email.email_grid_result_helper'\n        tags:\n            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.after.base-email-grid, method: onBuildAfter }\n            - { name: kernel.event_listener, event: oro_datagrid.orm_datasource.result.before_query.base-email-grid, method: onResultBeforeQuery, priority: -255 }\n            - { name: kernel.event_listener, event: oro_datagrid.orm_datasource.result.after.base-email-grid, method: onResultAfter }\n\n    oro_email.listener.datagrid.activity:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\Datagrid\\ActivityGridListener\n        arguments:\n            - '@oro_email.helper.datagrid.emails'\n            - '@oro_entity.routing_helper'\n        tags:\n            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.after.activity-email-grid, method: onBuildAfter }\n\n    oro_email.listener.datagrid.recent_emails:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\Datagrid\\RecentEmailGridListener\n        arguments:\n            - '@oro_email.helper.datagrid.emails'\n            - '@oro_email.datagrid_query_factory'\n        tags:\n            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.after.dashboard-recent-emails-grid, method: onBuildAfter }\n\n    oro_email.listener.datagrid.recent_emails.incoming:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\Datagrid\\IncomingEmailGridListener\n        arguments:\n            - '@oro_email.datagrid_query_factory'\n        tags:\n            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.after.dashboard-recent-emails-inbox-grid, method: onBuildAfter }\n            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.after.dashboard-recent-emails-new-grid, method: onBuildAfter }\n\n    oro_email.listener.datagrid.recent_emails.outgoing:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\Datagrid\\OutgoingEmailGridListener\n        arguments:\n            - '@oro_email.email_grid_result_helper'\n        tags:\n            - { name: kernel.event_listener, event: oro_datagrid.orm_datasource.result.after.dashboard-recent-emails-sent-grid, method: onResultAfter }\n\n    oro_email.email_synchronization_manager:\n        class: Oro\\Bundle\\EmailBundle\\Sync\\EmailSynchronizationManager\n        public: true\n        arguments:\n            - '@service_container'\n\n    Oro\\Bundle\\EmailBundle\\Sync\\EmailSynchronizationManager:\n        alias: 'oro_email.email_synchronization_manager'\n\n    oro_email.known_email_address_checker_factory:\n        class: Oro\\Bundle\\EmailBundle\\Sync\\KnownEmailAddressCheckerFactory\n        shared: false\n        arguments:\n            - '@doctrine'\n            - '@oro_email.email.address.manager'\n            - '@oro_email.email.address.helper'\n            - '@oro_email.email.owner.provider.storage'\n            - '%oro_email.email_sync_exclusions%'\n\n    oro_email.email.activity.manager:\n        class: Oro\\Bundle\\EmailBundle\\Entity\\Manager\\EmailActivityManager\n        arguments:\n            - '@oro_activity.manager'\n            - '@oro_email.activity_list.provider'\n            - '@oro_email.email.thread.provider'\n            - '@security.token_storage'\n            - '@oro_security.owner.entity_owner_accessor.link'\n            - \"@=service('doctrine').getManagerForClass('OroEmailBundle:Email')\"\n\n    oro_email.email.thread.provider:\n        class: Oro\\Bundle\\EmailBundle\\Entity\\Provider\\EmailThreadProvider\n        public: true\n\n    Oro\\Bundle\\EmailBundle\\Entity\\Provider\\EmailThreadProvider:\n        alias: 'oro_email.email.thread.provider'\n\n    oro_email.email.thread.manager:\n        class: Oro\\Bundle\\EmailBundle\\Entity\\Manager\\EmailThreadManager\n        arguments:\n            - '@oro_email.email.thread.provider'\n            - \"@=service('doctrine').getManagerForClass('OroEmailBundle:EmailThread')\"\n\n    oro_email.email.manager:\n        class: Oro\\Bundle\\EmailBundle\\Entity\\Manager\\EmailManager\n        public: true\n        arguments:\n            - '@doctrine.orm.entity_manager'\n            - '@oro_email.email.thread.manager'\n            - '@oro_email.email.thread.provider'\n            - '@oro_security.token_accessor'\n            - '@oro_email.mailbox.manager'\n\n    Oro\\Bundle\\EmailBundle\\Entity\\Manager\\EmailManager:\n        alias: 'oro_email.email.manager'\n\n    oro_email.twig.extension.email:\n        class: Oro\\Bundle\\EmailBundle\\Twig\\EmailExtension\n        arguments:\n            - '@oro_platform.twig.service_locator'\n        tags:\n            - { name: twig.extension }\n\n    oro_email.listener.search_listener:\n          class: Oro\\Bundle\\EmailBundle\\EventListener\\SearchListener\n          tags:\n              - { name: kernel.event_listener, event: oro_search.prepare_entity_map, method: prepareEntityMapEvent, priority: 10 }\n\n    oro_email.activity_list.provider:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\EmailActivityListProvider\n        arguments:\n           - '@oro_entity.doctrine_helper'\n           - '@oro_entity.entity_name_resolver'\n           - '@router'\n           - '@oro_entity_config.config_manager'\n           - '@oro_email.email.thread.provider'\n           - '@oro_ui.html_tag_helper'\n           - '@security.authorization_checker'\n           - '@oro_security.token_accessor'\n           - '@oro_email.mailbox.process_storage'\n           - '@oro_activity.association_helper'\n           - '@oro_comment.association_helper'\n        tags:\n           - { name: oro_activity_list.provider, class: Oro\\Bundle\\EmailBundle\\Entity\\Email, acl_class: Oro\\Bundle\\EmailBundle\\Entity\\EmailUser, priority: 30 }\n           - { name: oro_featuretogle.feature, feature: email }\n\n    oro_email.related_emails.provider:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\RelatedEmailsProvider\n        arguments:\n            - '@security.authorization_checker'\n            - '@oro_security.token_accessor'\n            - '@oro_email.provider.email_recipients.helper'\n            - '@oro_entity.entity_field_provider'\n            - '@oro_email.email_attribute.provider'\n\n    oro_email.email_attribute.provider:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\EmailAttributeProvider\n        arguments:\n            - '@doctrine'\n            - '@oro_entity_config.config_manager'\n            - '@oro_locale.formatter.name'\n            - '@oro_email.email.address.helper'\n\n    oro_email.email_recipients.provider:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\EmailRecipientsProvider\n        public: true\n        arguments:\n            - '@translator'\n            - '@oro_email.provider.email_recipients.helper'\n\n    Oro\\Bundle\\EmailBundle\\Provider\\EmailRecipientsProvider:\n        alias: 'oro_email.email_recipients.provider'\n\n    oro_email.recent_email_recipients.provider:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\RecentEmailRecipientsProvider\n        arguments:\n            - '@oro_security.token_accessor'\n            - '@oro_email.related_emails.provider'\n            - '@oro_security.acl_helper'\n            - '@doctrine'\n            - '@oro_email.email.owner.provider'\n            - '@oro_email.provider.email_recipients.helper'\n        tags:\n            - { name: oro_email.recipients_provider }\n\n    oro_email.context_email_recipients.provider:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\ContextEmailRecipientsProvider\n        arguments:\n            - '@oro_email.related_emails.provider'\n        tags:\n            - { name: oro_email.recipients_provider, priority: 10 }\n\n    oro_email.provider.emailowners.provider:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\EmailOwnersProvider\n        arguments:\n            - '@oro_activity_list.provider.chain'\n            - '@oro_email.email.owner.provider.storage'\n            - '@doctrine'\n\n    oro_email.provider.email_recipients.helper:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\EmailRecipientsHelper\n        public: true\n        arguments:\n            - '@oro_security.acl_helper'\n            - '@oro_locale.dql.formatter.name'\n            - '@oro_locale.formatter.name'\n            - '@oro_entity_config.config_manager'\n            - '@translator'\n            - '@oro_email.email.owner.provider'\n            - '@doctrine'\n            - '@oro_email.email.address.helper'\n            - '@oro_search.index'\n\n    Oro\\Bundle\\EmailBundle\\Provider\\EmailRecipientsHelper:\n        alias: 'oro_email.provider.email_recipients.helper'\n\n    oro_email.manager.email_attachment_manager:\n        class: Oro\\Bundle\\EmailBundle\\Manager\\EmailAttachmentManager\n        public: true\n        arguments:\n            - '@oro_attachment.file_manager'\n            - '@doctrine'\n            - '@router'\n            - '@oro_attachment.validator.file_config_validator'\n            - '@oro_attachment.association_helper'\n\n    Oro\\Bundle\\EmailBundle\\Manager\\EmailAttachmentManager:\n        alias: 'oro_email.manager.email_attachment_manager'\n\n    oro_email.listener.email_body_add_listener:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\EmailBodyAddListener\n        arguments:\n            - '@oro_email.manager.email_attachment_manager'\n            - '@oro_entity_config.provider.attachment'\n            - '@oro_email.activity_list.provider'\n            - '@security.authorization_checker'\n            - '@security.token_storage'\n            - '@oro_activity_list.provider.chain'\n            - '@doctrine.orm.entity_manager'\n        tags:\n            - { name: kernel.event_listener, event: oro_email.email_body_added, method: linkToScope, priority: 10 }\n            - { name: kernel.event_listener, event: oro_email.email_body_added, method: updateActivityDescription, priority: 20 }\n\n    oro_email.listener.replace_embedded_attachments_listener:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\ReplaceEmbeddedAttachmentsListener\n        tags:\n            - { name: kernel.event_listener, event: oro_email.email_body_loaded, method: replace }\n\n    oro_email.provider.email_attachment_provider:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\EmailAttachmentProvider\n        arguments:\n            - '@oro_email.email.thread.provider'\n            - '@doctrine'\n            - '@oro_attachment.provider.attachment'\n            - '@oro_email.email_attachment_transformer'\n\n    oro_email.email_attachment_transformer:\n        class: Oro\\Bundle\\EmailBundle\\Tools\\EmailAttachmentTransformer\n        arguments:\n            - '@oro_email.form.factory'\n            - '@oro_attachment.file_manager'\n            - '@oro_attachment.manager'\n            - '@oro_email.manager.email_attachment_manager'\n\n    oro_email.email_importance_transformer:\n        class: Oro\\Bundle\\EmailBundle\\Form\\DataTransformer\\EmailImportanceApiTransformer\n        public: true\n\n    oro_email.email_body_type_transformer:\n        class: Oro\\Bundle\\EmailBundle\\Form\\DataTransformer\\EmailBodyTypeApiTransformer\n        public: true\n\n    oro_email.acl.voter.email_voter:\n        class: Oro\\Bundle\\EmailBundle\\Acl\\Voter\\EmailVoter\n        arguments:\n            - '@security.authorization_checker'\n            - '@oro_email.mailbox.manager'\n        tags:\n            - { name: security.voter }\n\n    oro_email.entity_alias_provider:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\EmailEntityAliasProvider\n        arguments:\n            - '@oro_email.email.address.manager'\n        tags:\n            - { name: oro_entity.alias_provider }\n\n    oro_email.manager.email_activity.api:\n        class: Oro\\Bundle\\EmailBundle\\Entity\\Manager\\EmailActivityApiEntityManager\n        public: true\n        parent: oro_soap.manager.entity_manager.abstract\n        arguments:\n            - 'Oro\\Bundle\\EmailBundle\\Entity\\Email'\n            - '@doctrine.orm.entity_manager'\n            - '@oro_activity.manager'\n            - '@security.token_storage'\n\n    oro_email.manager.email_activity_entity.api:\n        class: Oro\\Bundle\\EmailBundle\\Entity\\Manager\\EmailActivityEntityApiEntityManager\n        public: true\n        parent: oro_soap.manager.entity_manager.abstract\n        arguments:\n            - 'Oro\\Bundle\\EmailBundle\\Entity\\Email'\n            - '@doctrine.orm.entity_manager'\n            - '@oro_activity.manager'\n            - '@security.token_storage'\n\n    oro_email.manager.email_activity_search.api:\n        class: Oro\\Bundle\\EmailBundle\\Entity\\Manager\\EmailActivitySearchApiEntityManager\n        public: true\n        parent: oro_soap.manager.entity_manager.abstract\n        arguments:\n            - 'Oro\\Bundle\\EmailBundle\\Entity\\Email'\n            - '@doctrine.orm.entity_manager'\n            - '@oro_activity.manager'\n            - '@oro_search.index'\n            - '@oro_entity.entity_name_resolver'\n\n    oro_email.manager.email_activity_suggestion.api:\n        class: Oro\\Bundle\\EmailBundle\\Entity\\Manager\\EmailActivitySuggestionApiEntityManager\n        public: true\n        parent: oro_soap.manager.entity_manager.abstract\n        arguments:\n            - 'Oro\\Bundle\\EmailBundle\\Entity\\Email'\n            - '@doctrine.orm.entity_manager'\n            - '@oro_activity.manager'\n            - '@oro_search.index'\n            - '@oro_entity.entity_name_resolver'\n        calls:\n            - [setTokenStorage, ['@security.token_storage']]\n\n    oro_email.email.flag.manager:\n        class: Oro\\Bundle\\EmailBundle\\Manager\\EmailFlagManager\n        arguments:\n            - '@oro_email.email_flag_manager_loader_selector'\n            - '@doctrine.orm.entity_manager'\n        calls:\n            - [setLogger, ['@logger']]\n\n    oro_email.internal_email.flag_manager_loader:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\InternalEmailFlagManagerLoader\n        tags:\n            - { name: oro_email.email_flag_manager_loader }\n\n    oro_email.manager.notification:\n        class: Oro\\Bundle\\EmailBundle\\Manager\\EmailNotificationManager\n        public: true\n        arguments:\n            - '@doctrine.orm.entity_manager'\n            - '@oro_ui.html_tag_helper'\n            - '@router'\n            - '@oro_entity_config.config_manager'\n\n    Oro\\Bundle\\EmailBundle\\Manager\\EmailNotificationManager:\n        alias: 'oro_email.manager.notification'\n        public: true\n\n    oro_email.datagrid.origin_folder.provider:\n        class: Oro\\Bundle\\EmailBundle\\Datagrid\\OriginFolderFilterProvider\n        public: true\n        arguments:\n            - '@doctrine'\n            - '@oro_security.token_accessor'\n            - '@oro_email.email_grid_mailbox_name_helper'\n\n    oro_email.mailbox.process_storage:\n        class: Oro\\Bundle\\EmailBundle\\Mailbox\\MailboxProcessStorage\n        arguments:\n            - '@oro_featuretoggle.checker.feature_checker'\n\n    oro_email.mailbox_email_owner_provider:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\MailboxEmailOwnerProvider\n        tags:\n            - { name: oro_email.owner.provider, order: 2 }\n\n    oro_email.mailbox_choice_list:\n        class: Oro\\Bundle\\EmailBundle\\Datagrid\\MailboxChoiceList\n        public: true\n        arguments:\n            - '@oro_security.token_accessor'\n            - '@oro_email.mailbox.manager'\n            - '@oro_email.email_grid_mailbox_name_helper'\n\n    oro_email.mailbox.manager.api:\n        class: Oro\\Bundle\\SoapBundle\\Entity\\Manager\\ApiEntityManager\n        parent: oro_soap.manager.entity_manager.abstract\n        arguments:\n            - 'Oro\\Bundle\\EmailBundle\\Entity\\Mailbox'\n            - '@doctrine.orm.entity_manager'\n\n    oro_email.mailbox.entity_name_provider:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\MailboxEntityNameProvider\n        arguments:\n            - '@translator.default'\n        tags:\n            - { name: oro_entity.name_provider, priority: 0}\n\n    oro_email.email_user.provider.email_user_entity_name_provider:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\EmailUserEntityNameProvider\n        tags:\n            - { name: oro_entity.name_provider, priority: 0 }\n\n    oro_email.email_body_entity_name_provider:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\EmailBodyEntityNameProvider\n        tags:\n            - { name: oro_entity.name_provider, priority: 0 }\n\n    oro_email.listener.mailbox_process_trigger_listener:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\MailboxProcessTriggerListener\n        arguments:\n            - '@Psr\\Container\\ContainerInterface'\n        tags:\n            - { name: doctrine.event_listener, event: onFlush }\n            - { name: doctrine.event_listener, event: postFlush }\n            - { name: oro_featuretogle.feature, feature: email }\n            - { name: container.service_subscriber }\n            - { name: container.service_subscriber, id: oro_email.mailbox.process_storage }\n            - { name: container.service_subscriber, id: oro_workflow.process.process_handler }\n\n    oro_email.autocomplete.mailbox_user_search_handler:\n        class: Oro\\Bundle\\EmailBundle\\Autocomplete\\MailboxUserSearchHandler\n        public: true\n        parent: oro_user.autocomplete.user.organization_search_handler\n\n    oro_email.listener.mailbox.authorization:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\MailboxAuthorizationListener\n        arguments:\n            - '@doctrine'\n            - '@security.authorization_checker'\n            - '@oro_security.token_accessor'\n        tags:\n            - { name: kernel.event_listener, event: kernel.controller, method: onKernelController }\n\n    oro_email.listener.datagrid.mailbox_grid:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\Datagrid\\MailboxGridListener\n        arguments:\n            - '@doctrine'\n            - '@oro_security.acl_helper'\n        tags:\n            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.pre.base-mailboxes-grid, method: onPreBuild }\n            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.after.base-mailboxes-grid, method: onBuildAfter }\n            - { name: oro_featuretogle.feature, feature: email }\n\n    oro_email.mailbox.manager:\n        class: Oro\\Bundle\\EmailBundle\\Entity\\Manager\\MailboxManager\n        public: true\n        arguments:\n            - '@doctrine'\n\n    Oro\\Bundle\\EmailBundle\\Entity\\Manager\\MailboxManager:\n        alias: 'oro_email.mailbox.manager'\n\n    oro_email.workflow.condition.instanceof:\n        class: Oro\\Bundle\\EmailBundle\\Model\\Condition\\IsInstanceOf\n        tags:\n            - { name: oro_action.condition, alias: instanceof }\n\n    oro_email.workflow.condition.has_count:\n        class: Oro\\Bundle\\EmailBundle\\Model\\Condition\\HasCount\n        tags:\n            - { name: oro_action.condition, alias: has_count }\n\n    oro_email.workflow.action.parse_first_name:\n        class: Oro\\Bundle\\EmailBundle\\Model\\Action\\ParseFirstNameFromEmailAddress\n        arguments:\n            - '@oro_action.expression.context_accessor'\n            - '@oro_email.email.address.helper'\n        tags:\n            - { name: oro_action.action, alias: parse_first_name_from_email_address }\n\n    oro_email.workflow.action.parse_last_name:\n        class: Oro\\Bundle\\EmailBundle\\Model\\Action\\ParseLastNameFromEmailAddress\n        arguments:\n            - '@oro_action.expression.context_accessor'\n            - '@oro_email.email.address.helper'\n        tags:\n            - { name: oro_action.action, alias: parse_last_name_from_email_address }\n\n    oro_email.workflow.action.request_mailboxes:\n        class: Oro\\Bundle\\EmailBundle\\Model\\Action\\RequestMailboxes\n        arguments:\n            - '@oro_action.expression.context_accessor'\n            - '@doctrine'\n            - '@oro_email.mailbox.process_storage'\n        tags:\n            - { name: oro_action.action, alias: request_mailboxes|find_mailboxes }\n\n    oro_email.workflow.action.strip_html_tags:\n        class: Oro\\Bundle\\EmailBundle\\Model\\Action\\StripHtmlTags\n        arguments:\n            - '@oro_action.expression.context_accessor'\n            - '@oro_ui.html_tag_helper'\n        tags:\n            - { name: oro_action.action, alias: strip_html_tags }\n\n    oro_email.workflow.action.add_activity_target:\n        class: Oro\\Bundle\\EmailBundle\\Model\\Action\\AddActivityTarget\n        arguments:\n            - '@oro_action.expression.context_accessor'\n            - '@oro_email.email.activity.manager'\n            - '@oro_activity_list.provider.chain'\n            - '@doctrine.orm.entity_manager'\n        tags:\n            - { name: oro_action.action, alias: add_email_activity_target }\n\n    oro_email.placeholder.send_email.filter:\n        class: Oro\\Bundle\\EmailBundle\\Placeholder\\SendEmailPlaceholderFilter\n        public: true\n        arguments:\n            - '@oro_activity.manager'\n\n    oro_email.tools.email_origin_helper:\n        class: Oro\\Bundle\\EmailBundle\\Tools\\EmailOriginHelper\n        arguments:\n            - '@oro_entity.doctrine_helper'\n            - '@oro_security.token_accessor'\n            - '@oro_email.email.owner.provider'\n            - '@oro_email.email.address.helper'\n\n    oro_email.listener.search_aliases_listener:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\SearchAliasesListener\n        tags:\n            - { name: kernel.event_listener, event: oro_activity.search_aliases, method: addEmailAliasEvent }\n\n    oro_email.listener.prepare_result_item_listener:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\PrepareResultItemListener\n        arguments:\n            - '@router'\n            - '@oro_entity.doctrine_helper'\n        tags:\n            - { name: kernel.event_listener, event: oro_search.prepare_result_item, method: prepareEmailItemDataEvent }\n\n    oro_email.listener.prepare_context_title_listener:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\PrepareContextTitleListener\n        arguments:\n            - '@router'\n            - '@oro_entity.doctrine_helper'\n        tags:\n            - { name: kernel.event_listener, event: oro_activity.context_title, method: prepareEmailContextTitleEvent }\n\n    oro_email.listener.activity_list_pre_query_build_listener:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\ActivityListPreQueryBuildListener\n        arguments:\n            - '@oro_entity.doctrine_helper'\n        tags:\n            - { name: kernel.event_listener, event: oro_activity_list.activity_list_pre_query_build, method: prepareIdsForEmailThreadEvent }\n            - { name: oro_featuretogle.feature, feature: email }\n\n    oro_email.email_body_synchronizer:\n        class: Oro\\Bundle\\EmailBundle\\Sync\\EmailBodySynchronizer\n        arguments:\n            - '@oro_email.email_body_loader_selector'\n            - '@doctrine'\n            - '@event_dispatcher'\n        calls:\n            - [setLogger, ['@logger']]\n\n    oro_email.model.email_activity_updates:\n        class: Oro\\Bundle\\EmailBundle\\Model\\EmailActivityUpdates\n        arguments:\n            - '@oro_email.provider.emailowners.provider'\n\n    oro_email.async.manager.association_manager:\n        class: Oro\\Bundle\\EmailBundle\\Async\\Manager\\AssociationManager\n        arguments:\n            - '@oro_entity.doctrine_helper'\n            - '@oro_email.email.activity.manager'\n            - '@oro_email.provider.emailowners.provider'\n            - '@oro_email.email.manager'\n            - '@oro_message_queue.client.message_producer'\n\n    oro_email.async.upgrade_email_body_processor:\n        class: Oro\\Bundle\\EmailBundle\\Migrations\\Schema\\v1_29\\UpgradeEmailBodyMessageProcessor\n        arguments:\n            - '@oro_message_queue.message_producer'\n            - '@oro_entity.orm.native_query_executor_helper'\n            - '@logger'\n        tags:\n            - { name: 'oro_message_queue.client.message_processor', topicName: 'oro_email.migrate_email_body' }\n\n    oro_email.logger.link:\n        tags:\n            - { name: oro_service_link, service: logger }\n\n    oro_email.provider.smtp_settings:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\SmtpSettingsProvider\n        public: true\n        arguments:\n            - '@oro_config.manager'\n            - '@oro_config.scope.global'\n            - '@oro_security.encoder.default'\n\n    Oro\\Bundle\\EmailBundle\\Provider\\SmtpSettingsProvider:\n        alias: oro_email.provider.smtp_settings\n\n    oro_email.mailer.checker.smtp_settings:\n        class: Oro\\Bundle\\EmailBundle\\Mailer\\Checker\\SmtpSettingsChecker\n        public: true\n        arguments:\n            - '@oro_email.direct_mailer'\n\n    Oro\\Bundle\\EmailBundle\\Mailer\\Checker\\SmtpSettingsChecker:\n        alias: 'oro_email.mailer.checker.smtp_settings'\n\n    oro_email.listener.datagrid.user_email_grid_listener:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\Datagrid\\UserEmailGridListener\n        arguments:\n            - '@oro_email.datagrid_query_factory'\n        tags:\n          - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.after.user-email-grid, method: onBuildAfter }\n          - { name: oro_featuretogle.feature, feature: email }\n\n    oro_email.emailtemplate.variable_processor:\n        class: Oro\\Bundle\\EntityBundle\\Twig\\Sandbox\\VariableProcessorRegistry\n        arguments:\n            - ~ # service locator\n\n    oro_email.emailtemplate.variable_processor.entity_routes:\n        class: Oro\\Bundle\\EmailBundle\\Processor\\EntityRouteVariableProcessor\n        arguments:\n            - '@oro_entity.doctrine_helper'\n            - '@oro_email.provider.url_provider'\n            - '@logger'\n        tags:\n            - { name: oro_email.emailtemplate.variable_processor, alias: entity_routes }\n\n    oro_email.migration.demo_data_fixtures_listener.email_associations:\n        parent: oro_platform.event_listener.demo_data_fixtures_listener.abstract\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\EmailAssociationsDemoDataFixturesListener\n        arguments:\n            - '@oro_email.async.manager.association_manager'\n        calls:\n            # this listener is disabled to prevent a lot of UpdateEmailAssociations messages\n            - [disableListener, ['oro_email.listener.entity_listener']]\n        tags:\n            - { name: kernel.event_listener, event: oro_migration.data_fixtures.pre_load, method: onPreLoad }\n            - { name: kernel.event_listener, event: oro_migration.data_fixtures.post_load, method: onPostLoad }\n\n    oro_email.topic.event:\n        class: Oro\\Bundle\\SyncBundle\\Topic\\SecuredTopic\n        arguments:\n            - 'oro_email.event'\n            - '@gos_web_socket.client.manipulator'\n        tags:\n            - { name: gos_web_socket.topic }\n\n    oro_email.acl.voter.email_template_voter:\n        class: Oro\\Bundle\\EmailBundle\\Acl\\Voter\\EmailTemplateVoter\n        arguments:\n            - '@oro_entity.doctrine_helper'\n        calls:\n            - [setClassName, ['Oro\\Bundle\\EmailBundle\\Entity\\EmailTemplate']]\n        tags:\n            - { name: security.voter }\n\n    oro_email.manager.template_email:\n        class: Oro\\Bundle\\EmailBundle\\Manager\\EmailTemplateManager\n        public: true\n        arguments:\n            - '@oro_email.direct_mailer'\n            - '@oro_email.mailer.processor'\n            - '@oro_email.provider.localized_template'\n\n    oro_email.async.template_email_message_sender:\n        class: 'Oro\\Bundle\\EmailBundle\\Async\\TemplateEmailMessageSender'\n        arguments:\n            - '@oro_email.manager.template_email'\n            - '@oro_entity.doctrine_helper'\n\n    oro_email.entity_name_provider:\n        class: 'Oro\\Bundle\\EmailBundle\\Provider\\EmailEntityNameProvider'\n        arguments:\n            - '@property_accessor'\n        tags:\n            - { name: oro_entity.name_provider, priority: -80 }\n\n    oro_email.provider.localized_template:\n        class: 'Oro\\Bundle\\EmailBundle\\Provider\\LocalizedTemplateProvider'\n        arguments:\n            - '@oro_locale.provider.preferred_localization_provider'\n            - '@oro_email.provider.email_template_content_provider'\n\n    oro_email.provider.email_template_content_provider:\n        class: 'Oro\\Bundle\\EmailBundle\\Provider\\EmailTemplateContentProvider'\n        public: true\n        arguments:\n            - '@doctrine'\n            - '@oro_email.email_renderer'\n            - '@property_accessor'\n            - '@logger'\n\n    oro_email.provider.url_provider:\n        class: 'Oro\\Bundle\\EmailBundle\\Provider\\UrlProvider'\n        arguments:\n            - '@oro_config.manager'\n            - '@router'\n    oro_email.form.handler.user_email_config:\n         class: 'Oro\\Bundle\\EmailBundle\\Form\\Handler\\UserEmailConfigHandler'\n         public: true\n         arguments:\n             - '@doctrine.orm.entity_manager'\n\n    oro_email.validator.connection_configuration.smtp:\n        class: 'Oro\\Bundle\\EmailBundle\\Validator\\SmtpConnectionConfigurationValidator'\n        arguments:\n            - '@oro_email.mailer.checker.smtp_settings'\n            - '@oro_email.smtp_settings_factory'\n        tags:\n            - { name: validator.constraint_validator }\n\n    oro_email.smtp_settings_factory:\n        class: 'Oro\\Bundle\\EmailBundle\\Form\\Model\\SmtpSettingsFactory'\n        arguments:\n            - '@oro_security.encoder.default'\n\n    oro_email.sender.aggregated_email_templates:\n        class: 'Oro\\Bundle\\EmailBundle\\Tools\\AggregatedEmailTemplatesSender'\n        arguments:\n            - '@oro_entity.doctrine_helper'\n            - '@oro_email.provider.localized_template'\n            - '@oro_email.tools.email_origin_helper'\n            - '@oro_email.mailer.processor'\n        calls:\n            - [setLogger, ['@logger']]\n\n    oro_email.async.send_email_template:\n        class: 'Oro\\Bundle\\EmailBundle\\Async\\SendEmailTemplateProcessor'\n        arguments:\n            - '@validator'\n            - '@oro_entity.doctrine_helper'\n            - '@oro_email.sender.aggregated_email_templates'\n        calls:\n            - [setLogger, ['@logger']]\n        tags:\n            - { name: 'oro_message_queue.client.message_processor' }\n", "<?php\n\nnamespace Oro\\Bundle\\EmailBundle\\Tests\\Unit\\Provider;\n\nuse Doctrine\\Inflector\\Rules\\English\\InflectorFactory;\nuse Oro\\Bundle\\EmailBundle\\Entity\\EmailTemplate as EmailTemplateEntity;\nuse Oro\\Bundle\\EmailBundle\\Model\\EmailTemplate as EmailTemplateModel;\nuse Oro\\Bundle\\EmailBundle\\Model\\EmailTemplateInterface;\nuse Oro\\Bundle\\EmailBundle\\Provider\\EmailRenderer;\nuse Oro\\Bundle\\EmailBundle\\Tests\\Unit\\Fixtures\\Entity\\TestEntityForVariableProvider;\nuse Oro\\Bundle\\EntityBundle\\Twig\\Sandbox\\TemplateRendererConfigProviderInterface;\nuse Oro\\Bundle\\EntityBundle\\Twig\\Sandbox\\VariableProcessorRegistry;\nuse Oro\\Bundle\\UIBundle\\Tools\\HtmlTagHelper;\nuse Oro\\Bundle\\UIBundle\\Twig\\HtmlTagExtension;\nuse Symfony\\Bridge\\Twig\\Extension\\HttpKernelExtension;\nuse Symfony\\Component\\DependencyInjection\\ContainerInterface;\nuse Symfony\\Contracts\\Translation\\TranslatorInterface;\nuse Twig\\Environment;\nuse Twig\\Extension\\SandboxExtension;\nuse Twig\\Loader\\ArrayLoader;\nuse Twig\\Sandbox\\SecurityPolicy;\n\nclass EmailRendererTest extends \\PHPUnit\\Framework\\TestCase\n{\n    private const ENTITY_VARIABLE_TEMPLATE =\n        '{% if %val% is defined %}'\n        . '{{ _entity_var(\"%name%\", %val%, %parent%) }}'\n        . '{% else %}'\n        . '{{ \"oro.email.variable.not.found\" }}'\n        . '{% endif %}';\n\n    /** @var TemplateRendererConfigProviderInterface|\\PHPUnit\\Framework\\MockObject\\MockObject */\n    private $configProvider;\n\n    /** @var VariableProcessorRegistry|\\PHPUnit\\Framework\\MockObject\\MockObject */\n    private $variablesProcessorRegistry;\n\n    /** @var TranslatorInterface|\\PHPUnit\\Framework\\MockObject\\MockObject */\n    private $translation;\n\n    /** @var ContainerInterface|\\PHPUnit\\Framework\\MockObject\\MockObject */\n    private $container;\n\n    /** @var EmailRenderer */\n    private $renderer;\n\n    protected function setUp(): void\n    {\n        $environment = new Environment(new ArrayLoader(), ['strict_variables' => true]);\n        $this->configProvider = $this->createMock(TemplateRendererConfigProviderInterface::class);\n        $this->variablesProcessorRegistry = $this->createMock(VariableProcessorRegistry::class);\n        $this->translation = $this->createMock(TranslatorInterface::class);\n        $this->container = $this->createMock(ContainerInterface::class);\n\n        $this->translation->expects($this->any())\n            ->method('trans')\n            ->willReturnArgument(0);\n\n        $environment->addExtension(new SandboxExtension(new SecurityPolicy()));\n        $environment->addExtension(new HttpKernelExtension());\n        $environment->addExtension(new HtmlTagExtension($this->container));\n\n        $this->renderer = new EmailRenderer(\n            $environment,\n            $this->configProvider,\n            $this->variablesProcessorRegistry,\n            $this->translation,\n            (new InflectorFactory())->build()\n        );\n    }\n\n    private function getEmailTemplate(string $content, string $subject = ''): EmailTemplateInterface\n    {\n        $emailTemplate = new EmailTemplateModel();\n        $emailTemplate->setContent($content);\n        $emailTemplate->setSubject($subject);\n\n        return $emailTemplate;\n    }\n\n    private function getEntityVariableTemplate(string $propertyName, string $path, string $parentPath): string\n    {\n        return strtr(\n            self::ENTITY_VARIABLE_TEMPLATE,\n            [\n                '%name%' => $propertyName,\n                '%val%' => $path,\n                '%parent%' => $parentPath,\n            ]\n        );\n    }\n\n    private function expectVariables(array $entityVariableProcessors = [], array $systemVariableValues = []): void\n    {\n        $entityVariableProcessorsMap = [];\n        foreach ($entityVariableProcessors as $entityClass => $processors) {\n            $entityVariableProcessorsMap[] = [$entityClass, $processors];\n        }\n        $this->configProvider->expects($this->any())\n            ->method('getEntityVariableProcessors')\n            ->willReturnMap($entityVariableProcessorsMap);\n        $this->configProvider->expects($this->any())\n            ->method('getSystemVariableValues')\n            ->willReturn($systemVariableValues);\n    }\n\n    public function testCompilePreview()\n    {\n        $entity = new TestEntityForVariableProvider();\n\n        $this->configProvider->expects($this->any())\n            ->method('getConfiguration')\n            ->willReturn([\n                'properties' => [],\n                'methods' => [get_class($entity) => ['getField1']],\n                'accessors' => [get_class($entity) => ['field1' => 'getField1']],\n                'default_formatters' => [],\n            ]);\n\n        $template = 'test <a href=\"http://example.com\">test</a> {{ system.testVar }}';\n\n        $emailTemplate = new EmailTemplateEntity();\n        $emailTemplate->setContent($template);\n        $emailTemplate->setSubject('');\n\n        $this->assertSame($template, $this->renderer->compilePreview($emailTemplate));\n    }\n\n    public function testCompileMessage()\n    {\n        $entity = new TestEntityForVariableProvider();\n        $entity->setField1('Test');\n        $entityClass = get_class($entity);\n        $systemVars = ['testVar' => 'test_system'];\n        $entityVariableProcessors = [$entityClass => []];\n        $defaultFormatters = [$entityClass => ['field1' => 'formatter1']];\n\n        $subject = 'subject';\n        $content = 'test '\n            . '<a href=\"http://example.com\">test</a>'\n            . ' {{ entity.getField1()|oro_html_sanitize }}'\n            . ' {{ entity.field2|trim|raw }}'\n            . ' {{ max(0, 2) }}'\n            . ' {{ system.testVar }}'\n            . ' N/A';\n\n        $this->configProvider->expects($this->any())\n            ->method('getConfiguration')\n            ->willReturn([\n                'properties' => [],\n                'methods' => [$entityClass => ['getField1']],\n                'accessors' => [$entityClass => ['field1' => 'getField1']],\n                'default_formatters' => $defaultFormatters,\n            ]);\n        $this->expectVariables($entityVariableProcessors, $systemVars);\n\n        $htmlTagHelper = $this->createMock(HtmlTagHelper::class);\n        $this->container->expects($this->once())\n            ->method('get')\n            ->with('oro_ui.html_tag_helper')\n            ->willReturn($htmlTagHelper);\n\n        $emailTemplate = $this->getEmailTemplate($content, $subject);\n        $templateParams = [\n            'entity' => $entity,\n            'system' => $systemVars,\n        ];\n\n        $result = $this->renderer->compileMessage($emailTemplate, $templateParams);\n        $expectedContent = 'test <a href=\"http://example.com\">test</a>   2 test_system N/A';\n\n        $this->assertIsArray($result);\n        $this->assertCount(2, $result);\n        $this->assertSame($subject, $result[0]);\n        $this->assertSame($expectedContent, $result[1]);\n    }\n\n    public function testRenderTemplate()\n    {\n        $template = 'test '\n            . \"\\n\"\n            . '{{ entity.field1 }}'\n            . \"\\n\"\n            . '{{ system.currentDate }}';\n\n        $entity = new TestEntityForVariableProvider();\n        $this->configProvider->expects($this->any())\n            ->method('getConfiguration')\n            ->willReturn([\n                'properties' => [],\n                'methods' => [get_class($entity) => ['getField1']],\n                'accessors' => [get_class($entity) => ['field1' => 'getField1']],\n                'default_formatters' => [],\n            ]);\n        $this->expectVariables([\n            get_class($entity) => [],\n        ], ['currentDate' => '10-12-2019']);\n\n        $htmlTagHelper = $this->createMock(HtmlTagHelper::class);\n        $this->container->expects($this->once())\n            ->method('get')\n            ->with('oro_ui.html_tag_helper')\n            ->willReturn($htmlTagHelper);\n\n        $result = $this->renderer->renderTemplate($template, ['entity' => $entity]);\n\n        $expectedRenderedResult =\n            'test '\n            . \"\\n\"\n            . '10-12-2019';\n        $this->assertSame($expectedRenderedResult, $result);\n    }\n}\n"], "fixing_code": ["<?php\n\nnamespace Oro\\Bundle\\EmailBundle\\Provider;\n\nuse Doctrine\\Inflector\\Inflector;\nuse Oro\\Bundle\\EmailBundle\\Model\\EmailTemplateInterface;\nuse Oro\\Bundle\\EntityBundle\\Twig\\Sandbox\\TemplateRenderer;\nuse Oro\\Bundle\\EntityBundle\\Twig\\Sandbox\\TemplateRendererConfigProviderInterface;\nuse Oro\\Bundle\\EntityBundle\\Twig\\Sandbox\\VariableProcessorRegistry;\nuse Oro\\Bundle\\UIBundle\\Tools\\HtmlTagHelper;\nuse Symfony\\Contracts\\Translation\\TranslatorInterface;\nuse Twig\\Environment;\n\n/**\n * Renders email template as TWIG template in a sandboxed environment.\n */\nclass EmailRenderer extends TemplateRenderer\n{\n    private const VARIABLE_NOT_FOUND = 'oro.email.variable.not.found';\n\n    /** @var TranslatorInterface */\n    private $translator;\n\n    /** @var HtmlTagHelper|null */\n    private $htmlTagHelper;\n\n    public function __construct(\n        Environment $environment,\n        TemplateRendererConfigProviderInterface $configProvider,\n        VariableProcessorRegistry $variableProcessors,\n        TranslatorInterface $translator,\n        Inflector $inflector\n    ) {\n        parent::__construct($environment, $configProvider, $variableProcessors, $inflector);\n        $this->translator = $translator;\n    }\n\n    public function setHtmlTagHelper(HtmlTagHelper $htmlTagHelper): void\n    {\n        $this->htmlTagHelper = $htmlTagHelper;\n    }\n\n    /**\n     * Compiles the given email template.\n     *\n     * @param EmailTemplateInterface $template\n     * @param array $templateParams\n     *\n     * @return array [email subject, email body]\n     *\n     * @throws \\Twig\\Error\\Error if the given template cannot be compiled\n     */\n    public function compileMessage(EmailTemplateInterface $template, array $templateParams = []): array\n    {\n        $subjectTemplate = $template->getSubject();\n        $contentTemplate = $template->getContent();\n\n        $subject = $subjectTemplate ? $this->renderTemplate($subjectTemplate, $templateParams) : '';\n        $content = $contentTemplate ? $this->renderTemplate($contentTemplate, $templateParams) : '';\n\n        return [$subject, $content];\n    }\n\n    /**\n     * Compiles the given email template for the preview purposes.\n     *\n     * @throws \\Twig\\Error\\Error if the given template cannot be compiled\n     */\n    public function compilePreview(EmailTemplateInterface $template): string\n    {\n        $this->ensureSandboxConfigured();\n\n        if ($this->htmlTagHelper) {\n            $content = $this->htmlTagHelper->sanitize($template->getContent(), 'default', false);\n        } else {\n            $content = $template->getContent();\n        }\n\n        return $this->environment\n            ->createTemplate('{% verbatim %}' . $content . '{% endverbatim %}')\n            ->render();\n    }\n\n    /**\n     * {@inheritdoc}\n     */\n    protected function getVariableNotFoundMessage(): string\n    {\n        return $this->translator->trans(self::VARIABLE_NOT_FOUND);\n    }\n}\n", "services:\n    oro_email.swiftmailer.mailer.abstract:\n        parent: swiftmailer.mailer.abstract\n        decorates: swiftmailer.mailer.abstract\n        class: Oro\\Bundle\\EmailBundle\\Util\\MailerWrapper\n\n    oro_email.entity.cache.warmer:\n        class: Oro\\Bundle\\EmailBundle\\Cache\\EntityCacheWarmer\n        arguments:\n            - '@oro_email.email.owner.provider.storage'\n            - '%oro_email.entity.cache_dir%'\n            - '%oro_email.entity.cache_namespace%'\n            - '%oro_email.entity.proxy_name_template%'\n            - '@kernel'\n        tags:\n            - { name: kernel.cache_warmer, priority: 30 }\n            - { name: oro_entity_extend.warmer }\n\n    oro_email.email.cache.manager:\n        class: Oro\\Bundle\\EmailBundle\\Cache\\EmailCacheManager\n        public: true\n        arguments:\n            - '@doctrine.orm.entity_manager'\n            - '@event_dispatcher'\n            - '@oro_email.email_body_synchronizer'\n\n    Oro\\Bundle\\EmailBundle\\Cache\\EmailCacheManager:\n        alias: 'oro_email.email.cache.manager'\n\n    oro_email.email_holder_helper:\n        class: Oro\\Bundle\\EmailBundle\\Tools\\EmailHolderHelper\n        arguments:\n            - '@oro_entity_config.provider.extend'\n\n    oro_email.email.address.helper:\n        class: Oro\\Bundle\\EmailBundle\\Tools\\EmailAddressHelper\n        public: true\n\n    oro_email.email_body_loader_selector:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\EmailBodyLoaderSelector\n        arguments:\n            - !tagged_iterator oro_email.email_body_loader\n\n    oro_email.email_flag_manager_loader_selector:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\EmailFlagManagerLoaderSelector\n        arguments:\n            - !tagged_iterator oro_email.email_flag_manager_loader\n\n    oro_email.email_address.entity_manager:\n        parent: oro_entity.abstract_entity_manager\n        arguments:\n            - 'OroEmailBundle:EmailAddress'\n\n    oro_email.link.email_address.entity_manager:\n        tags:\n            - { name: oro_service_link,  service: oro_email.email_address.entity_manager }\n\n    oro_email.email.address.manager:\n        class: Oro\\Bundle\\EmailBundle\\Entity\\Manager\\EmailAddressManager\n        arguments:\n            - '%oro_email.entity.cache_namespace%'\n            - '%oro_email.entity.proxy_name_template%'\n        calls:\n            - [setEntityManagerLink, ['@oro_email.link.email_address.entity_manager']]\n\n    oro_email.email.owner.provider.storage:\n        class: Oro\\Bundle\\EmailBundle\\Entity\\Provider\\EmailOwnerProviderStorage\n\n    oro_email.email.owner.provider:\n        class: Oro\\Bundle\\EmailBundle\\Entity\\Provider\\EmailOwnerProvider\n        arguments:\n            - '@oro_email.email.owner.provider.storage'\n\n    oro_email.email.owner.manager:\n        class: Oro\\Bundle\\EmailBundle\\Entity\\Manager\\EmailOwnerManager\n        arguments:\n            - '@oro_email.email.owner.provider.storage'\n            - '@oro_email.email.address.manager'\n\n    oro_email.email.address.association_metadata_listener:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\EmailAddressAssociationMetadataListener\n        arguments:\n            - '@oro_email.email.address.manager'\n        tags:\n            - { name: doctrine.event_listener, event: loadClassMetadata }\n\n    oro_email.email.model.builder.helper:\n        class: Oro\\Bundle\\EmailBundle\\Builder\\Helper\\EmailModelBuilderHelper\n        arguments:\n            - '@oro_entity.routing_helper'\n            - '@oro_email.email.address.helper'\n            - '@oro_entity.entity_name_resolver'\n            - '@oro_security.token_accessor'\n            - '@oro_email.email.address.manager'\n            - '@doctrine.orm.entity_manager'\n            - '@oro_email.email.cache.manager'\n            - '@templating'\n            - '@oro_email.mailbox.manager'\n\n    oro_email.email.entity.builder:\n        class: Oro\\Bundle\\EmailBundle\\Builder\\EmailEntityBuilder\n        shared: false\n        arguments:\n            - '@oro_email.email.entity.batch_processor'\n            - '@oro_email.email.address.manager'\n            - '@oro_email.email.address.helper'\n            - '@doctrine'\n            - '@logger'\n\n    oro_email.email.model.builder:\n        class: Oro\\Bundle\\EmailBundle\\Builder\\EmailModelBuilder\n        public: true\n        arguments:\n            - '@oro_email.email.model.builder.helper'\n            - '@doctrine.orm.entity_manager'\n            - '@oro_config.user'\n            - '@oro_email.activity_list.provider'\n            - '@oro_email.provider.email_attachment_provider'\n            - '@oro_email.form.factory'\n            - '@request_stack'\n            - '@oro_ui.html_tag_helper'\n            - '@oro_attachment.provider.file_constraints'\n\n    Oro\\Bundle\\EmailBundle\\Builder\\EmailModelBuilder:\n        alias: 'oro_email.email.model.builder'\n\n    oro_email.email_websocket.processor:\n        class: Oro\\Bundle\\EmailBundle\\Model\\WebSocket\\WebSocketSendProcessor\n        arguments:\n            - '@oro_sync.websocket_client'\n            - '@oro_sync.client.connection_checker'\n\n    oro_email.event_listener.email_user_listener:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\EmailUserListener\n        arguments:\n            - '@oro_email.email_websocket.processor'\n        tags:\n            - { name: doctrine.event_listener, event: onFlush, priority: 1 }\n            - { name: doctrine.event_listener, event: postFlush, priority: 1 }\n\n    oro_email.email.entity.batch_processor:\n        class: Oro\\Bundle\\EmailBundle\\Builder\\EmailEntityBatchProcessor\n        shared: false\n        arguments:\n            - '@oro_email.email.address.manager'\n            - '@oro_email.email.owner.provider'\n            - '@event_dispatcher'\n\n    oro_email.listener.entity_listener:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\EntityListener\n        arguments:\n            - '@oro_message_queue.client.message_producer'\n            - '@Psr\\Container\\ContainerInterface'\n        tags:\n            - { name: doctrine.event_listener, event: onFlush }\n            - { name: doctrine.event_listener, event: postFlush }\n            - { name: doctrine.event_listener, event: postRemove }\n            - { name: container.service_subscriber, id: oro_email.email.owner.manager }\n            - { name: container.service_subscriber, id: oro_email.email.thread.manager }\n            - { name: container.service_subscriber, id: oro_email.email.activity.manager }\n            - { name: container.service_subscriber, id: oro_email.model.email_activity_updates }\n            - { name: container.service_subscriber, id: oro_email.email.address.manager }\n\n    oro_email.listener.auto_response_listener:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\AutoResponseListener\n        arguments:\n            - '@Psr\\Container\\ContainerInterface'\n        tags:\n            - { name: doctrine.event_listener, event: onFlush }\n            - { name: doctrine.event_listener, event: postFlush }\n            - { name: oro_featuretogle.feature, feature: email }\n            - { name: container.service_subscriber }\n            - { name: container.service_subscriber, id: oro_email.autoresponserule_manager }\n\n    oro_email.async.auto_response:\n        class: 'Oro\\Bundle\\EmailBundle\\Async\\AutoResponseMessageProcessor'\n        arguments:\n            - '@doctrine'\n            - '@oro_email.autoresponserule_manager'\n            - '@oro_message_queue.job.runner'\n            - '@logger'\n        tags:\n            - { name: 'oro_message_queue.client.message_processor' }\n\n    oro_email.async.auto_responses:\n        class: 'Oro\\Bundle\\EmailBundle\\Async\\AutoResponsesMessageProcessor'\n        arguments:\n            - '@oro_message_queue.client.message_producer'\n            - '@oro_message_queue.job.runner'\n            - '@logger'\n        tags:\n            - { name: 'oro_message_queue.client.message_processor' }\n\n    oro_email.async.add_email_associations:\n        class: 'Oro\\Bundle\\EmailBundle\\Async\\AddEmailAssociationsMessageProcessor'\n        arguments:\n            - '@oro_message_queue.client.message_producer'\n            - '@oro_message_queue.job.runner'\n            - '@logger'\n        tags:\n            - { name: 'oro_message_queue.client.message_processor' }\n\n    oro_email.async.add_email_association:\n        class: 'Oro\\Bundle\\EmailBundle\\Async\\AddEmailAssociationMessageProcessor'\n        arguments:\n            - '@oro_email.async.manager.association_manager'\n            - '@oro_message_queue.job.runner'\n            - '@logger'\n        tags:\n            - { name: 'oro_message_queue.client.message_processor' }\n\n    oro_email.async.update_email_associations:\n        class: 'Oro\\Bundle\\EmailBundle\\Async\\UpdateEmailAssociationsMessageProcessor'\n        arguments:\n            - '@oro_email.async.manager.association_manager'\n            - '@oro_message_queue.job.runner'\n            - '@logger'\n        tags:\n            - { name: 'oro_message_queue.client.message_processor' }\n\n    oro_email.async.update_email_owner_association:\n        class: 'Oro\\Bundle\\EmailBundle\\Async\\UpdateEmailOwnerAssociationMessageProcessor'\n        arguments:\n            - '@oro_email.async.manager.association_manager'\n            - '@oro_message_queue.job.runner'\n            - '@logger'\n        tags:\n            - { name: 'oro_message_queue.client.message_processor' }\n\n    oro_email.async.update_email_owner_associations:\n        class: 'Oro\\Bundle\\EmailBundle\\Async\\UpdateEmailOwnerAssociationsMessageProcessor'\n        arguments:\n            - '@oro_message_queue.client.message_producer'\n            - '@oro_message_queue.job.runner'\n            - '@logger'\n        tags:\n            - { name: 'oro_message_queue.client.message_processor' }\n\n    oro_email.async.sync_email_seen_flag:\n        class: 'Oro\\Bundle\\EmailBundle\\Async\\SyncEmailSeenFlagMessageProcessor'\n        arguments:\n            - '@doctrine'\n            - '@oro_email.email.flag.manager'\n            - '@logger'\n        tags:\n            - { name: 'oro_message_queue.client.message_processor' }\n\n    oro_email.async.purge_email_attachments:\n        class: 'Oro\\Bundle\\EmailBundle\\Async\\PurgeEmailAttachmentsMessageProcessor'\n        arguments:\n            - '@doctrine'\n            - '@oro_message_queue.client.message_producer'\n            - '@oro_message_queue.job.runner'\n            - '@oro_config.global'\n        tags:\n            - { name: 'oro_message_queue.client.message_processor' }\n\n    oro_email.async.purge_email_attachments_by_ids:\n        class: 'Oro\\Bundle\\EmailBundle\\Async\\PurgeEmailAttachmentsByIdsMessageProcessor'\n        arguments:\n            - '@doctrine'\n            - '@oro_message_queue.job.runner'\n            - '@logger'\n        tags:\n            - { name: 'oro_message_queue.client.message_processor' }\n\n    oro_email.manager.autoresponserule.api:\n        class: Oro\\Bundle\\SoapBundle\\Entity\\Manager\\ApiEntityManager\n        public: true\n        parent: oro_soap.manager.entity_manager.abstract\n        arguments:\n            - 'Oro\\Bundle\\EmailBundle\\Entity\\AutoResponseRule'\n            - '@doctrine.orm.entity_manager'\n\n    oro_email.autoresponserule_manager:\n        class: Oro\\Bundle\\EmailBundle\\Manager\\AutoResponseManager\n        arguments:\n            - '@doctrine'\n            - '@oro_email.email.model.builder'\n            - '@oro_email.mailer.processor'\n            - '@oro_email.email_renderer'\n            - '@logger'\n            - '@translator'\n            - '%oro_locale.language%'\n\n    oro_email.manager.email.api:\n        class: Oro\\Bundle\\EmailBundle\\Entity\\Manager\\EmailApiEntityManager\n        public: true\n        parent: oro_soap.manager.entity_manager.abstract\n        arguments:\n            - 'Oro\\Bundle\\EmailBundle\\Entity\\Email'\n            - '@doctrine.orm.entity_manager'\n            - '@oro_email.datagrid_query_factory'\n\n    oro_email.manager.email_origin.api:\n        class: Oro\\Bundle\\EmailBundle\\Entity\\Manager\\EmailOriginApiEntityManager\n        public: true\n        parent: oro_soap.manager.entity_manager.abstract\n        arguments:\n            - 'Oro\\Bundle\\EmailBundle\\Entity\\EmailOrigin'\n            - '@doctrine.orm.entity_manager'\n\n    oro_email.direct_mailer:\n        class: Oro\\Bundle\\EmailBundle\\Mailer\\DirectMailer\n        public: true\n        arguments:\n            - '@mailer'\n            - '@service_container'\n\n    oro_email.manager.emailtemplate.api:\n        class: Oro\\Bundle\\SoapBundle\\Entity\\Manager\\ApiEntityManager\n        public: true\n        parent: oro_soap.manager.entity_manager.abstract\n        arguments:\n            - 'Oro\\Bundle\\EmailBundle\\Entity\\EmailTemplate'\n            - '@doctrine.orm.entity_manager'\n\n    oro_email.cache:\n          parent: oro.cache.abstract\n          calls:\n              - [setNamespace, [ 'oro_email' ] ]\n\n    oro_email.listener.config_listener:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\EntityConfigListener\n        arguments:\n            - '@oro_email.email_renderer_configuration'\n        tags:\n            - { name: kernel.event_listener, event: oro.entity_config.pre_flush, method: preFlush }\n\n    oro_email.email_renderer:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\EmailRenderer\n        public: true\n        arguments:\n            - '@oro_email.twig.email_environment'\n            - '@oro_email.email_renderer_configuration'\n            - '@oro_email.emailtemplate.variable_processor'\n            - '@translator'\n            - '@Doctrine\\Inflector\\Inflector'\n        calls:\n            - [addSystemVariableDefaultFilter, ['userSignature', 'oro_html_sanitize']]\n            - [setHtmlTagHelper, ['@oro_ui.html_tag_helper']]\n        lazy: true\n\n    oro_email.email_renderer_configuration:\n        class: Oro\\Bundle\\EntityBundle\\Twig\\Sandbox\\TemplateRendererConfigProvider\n        arguments:\n            - '@oro_email.emailtemplate.variable_provider'\n            - '@oro_email.cache'\n            - 'oro_email.available_in_template_fields'\n\n    oro_email.twig.email_security_policy:\n        class: Twig\\Sandbox\\SecurityPolicy\n        arguments:\n            # tags\n            - [ 'app', 'for', 'if', 'spaceless' ]\n            # filters\n            - [ 'default', 'date', 'escape', 'format', 'length', 'lower', 'nl2br', 'number_format', 'title', 'trim', 'upper', 'oro_html_sanitize', 'slice' ]\n            # methods\n            - []\n            # properties\n            - []\n            # functions\n            - [ '_entity_var', 'date' ]\n\n    oro_email.twig.email_sandbox:\n        class: Twig\\Extension\\SandboxExtension\n        arguments:\n            - '@oro_email.twig.email_security_policy'\n            - true # use sandbox globally in instance\n\n    oro_email.twig.string_loader:\n        class: Twig\\Loader\\ArrayLoader\n\n    oro_email.twig.email_environment:\n        class: Twig\\Environment\n        arguments:\n            - '@oro_email.twig.string_loader'\n            - { strict_variables: true }\n        calls:\n            - [addExtension, ['@oro_email.twig.email_sandbox']]\n\n    oro_email.emailtemplate.variable_provider:\n        class: Oro\\Bundle\\EntityBundle\\Twig\\Sandbox\\VariablesProvider\n        public: true\n        arguments:\n            # All arguments are set by Oro\\Bundle\\EmailBundle\\DependencyInjection\\Compiler\\EmailTemplateVariablesPass\n            - ~ # providers\n            - [] # names of system variables providers\n            - [] # names of entity variables providers\n\n    oro_email.emailtemplate.variable_provider.entity:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\EntityVariablesProvider\n        arguments:\n            - '@translator'\n            - '@oro_entity_config.config_manager'\n            - '@doctrine'\n            - '@oro_ui.formatter'\n            - '@Doctrine\\Inflector\\Inflector'\n        tags:\n            - { name: oro_email.emailtemplate.variable_provider, scope: entity }\n\n    oro_email.emailtemplate.variable_provider.entity_routes:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\EntityRouteVariablesProvider\n        arguments:\n            - '@translator'\n            - '@oro_entity_config.config_manager'\n            - '@oro_config.user'\n        tags:\n            - { name: oro_email.emailtemplate.variable_provider, scope: entity }\n\n    oro_email.emailtemplate.variable_provider.system:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\SystemVariablesProvider\n        arguments:\n            - '@translator'\n            - '@oro_config.user'\n            - '@oro_locale.formatter.date_time'\n        tags:\n            - { name: oro_email.emailtemplate.variable_provider, scope: system }\n\n    oro_email.emailtemplate.variable_provider.user:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\LoggedUserVariablesProvider\n        arguments:\n            - '@translator'\n            - '@oro_security.token_accessor'\n            - '@oro_entity.entity_name_resolver'\n            - '@oro_config.user'\n            - '@oro_ui.html_tag_helper'\n        tags:\n            - { name: oro_email.emailtemplate.variable_provider, scope: system }\n\n    oro_email.validator.email_template_syntax:\n        class: Oro\\Bundle\\EmailBundle\\Validator\\EmailTemplateSyntaxValidator\n        arguments:\n            - '@oro_email.email_renderer'\n            - '@oro_locale.manager.localization'\n            - '@oro_entity_config.provider.entity'\n            - '@translator'\n        tags:\n            - { name: validator.constraint_validator, alias: oro_email.email_template_syntax_validator }\n\n    oro_email.validator.email_address_validator:\n        class: Oro\\Bundle\\EmailBundle\\Validator\\EmailAddressValidator\n        arguments:\n            - '@oro_email.email.address.helper'\n        tags:\n            - { name: validator.constraint_validator, alias: oro_email.email_address_validator }\n\n    oro_email.validator.email_recipients:\n        class: Oro\\Bundle\\EmailBundle\\Validator\\EmailRecipientsValidator\n        tags:\n            - { name: validator.constraint_validator, alias: oro_email.email_recipients_validator }\n\n    oro_email.validator.mailbox_origin:\n        class: Oro\\Bundle\\EmailBundle\\Validator\\MailboxOriginValidator\n        arguments:\n            - '@translator'\n        tags:\n            - { name: validator.constraint_validator, alias: oro_email.validator.mailbox_origin }\n\n    oro_email.validator.not_empty_email_template_translation_subject:\n        class: Oro\\Bundle\\EmailBundle\\Validator\\NotEmptyEmailTemplateTranslationSubjectValidator\n        tags:\n            - { name: validator.constraint_validator, alias: oro_email.not_empty_email_template_translation_subject }\n\n    oro_email.datagrid_query_factory:\n        class: Oro\\Bundle\\EmailBundle\\Datagrid\\EmailQueryFactory\n        arguments:\n            - '@oro_email.email.owner.provider.storage'\n            - '@oro_entity.entity_name_resolver'\n            - '@oro_email.mailbox.manager'\n            - '@oro_security.token_accessor'\n            - '@form.factory'\n            - '@oro_filter.filter_utility'\n\n    oro_email.emailtemplate.datagrid_view_list:\n        class: Oro\\Bundle\\EmailBundle\\Datagrid\\EmailTemplatesViewList\n        public: true\n        arguments:\n            - '@translator'\n\n    oro_email.emailfolder.datagrid_view_list:\n        class: Oro\\Bundle\\EmailBundle\\Datagrid\\EmailFolderViewList\n        public: true\n        arguments:\n            - '@translator'\n            - '@oro_email.mailbox_choice_list'\n\n    oro_email.emailseen.datagrid_view_list:\n        class: Oro\\Bundle\\EmailBundle\\Datagrid\\EmailSeenViewList\n        public: true\n        arguments:\n            - '@translator'\n            - '@oro_email.mailbox_choice_list'\n\n    oro_email.emailtemplate.datagrid_helper:\n        class: Oro\\Bundle\\EmailBundle\\Datagrid\\EmailTemplateGridHelper\n        public: true\n        arguments:\n            - '@oro_entity.entity_provider'\n            - '@translator'\n\n    oro_email_filter.filter_origin_folder:\n        class: Oro\\Bundle\\EmailBundle\\Filter\\ChoiceOriginFolderFilter\n        arguments:\n            - '@form.factory'\n            - '@oro_filter.filter_utility'\n        tags:\n            - { name: oro_filter.extension.orm_filter.filter, type: multiselect-originfolder }\n\n    oro_email_filter.filter_massage_type:\n        class: Oro\\Bundle\\EmailBundle\\Filter\\ChoiceMessageTypeFilter\n        arguments:\n            - '@form.factory'\n            - '@oro_filter.filter_utility'\n            - '@oro_email.email.owner.provider.storage'\n        tags:\n            - { name: oro_filter.extension.orm_filter.filter, type: multiselect-messagetype }\n\n    oro_email_filter.filter_email_string:\n        class: Oro\\Bundle\\EmailBundle\\Filter\\EmailStringFilter\n        arguments:\n            - '@form.factory'\n            - '@oro_filter.filter_utility'\n            - '@oro_email.email.owner.provider.storage'\n        tags:\n            - { name: oro_filter.extension.orm_filter.filter, type: email-string }\n\n    oro_email.mailer.processor:\n        class: Oro\\Bundle\\EmailBundle\\Mailer\\Processor\n        arguments:\n            - '@oro_entity.doctrine_helper'\n            - '@oro_email.direct_mailer'\n            - '@oro_email.email.address.helper'\n            - '@oro_email.email.entity.builder'\n            - '@oro_email.email.activity.manager'\n            - '@event_dispatcher'\n            - '@oro_security.encoder.default'\n            - '@oro_email.tools.email_origin_helper'\n\n    oro_email.workflow.action.send_email:\n        class: Oro\\Bundle\\EmailBundle\\Workflow\\Action\\SendEmail\n        arguments:\n            - '@oro_action.expression.context_accessor'\n            - '@oro_email.mailer.processor'\n            - '@oro_email.email.address.helper'\n            - '@oro_entity.entity_name_resolver'\n            - '@oro_email.tools.email_origin_helper'\n        calls:\n            - [setLogger, ['@logger']]\n        tags:\n            - { name: oro_action.action, alias: send_email }\n\n    oro_email.workflow.action.send_email_template:\n        class: Oro\\Bundle\\EmailBundle\\Workflow\\Action\\SendEmailTemplate\n        arguments:\n            - '@oro_action.expression.context_accessor'\n            - '@oro_email.mailer.processor'\n            - '@oro_email.email.address.helper'\n            - '@oro_entity.entity_name_resolver'\n            - '@validator'\n            - '@oro_email.sender.aggregated_email_templates'\n        calls:\n            - [setLogger, ['@logger']]\n        tags:\n            - { name: oro_action.action, alias: send_email_template }\n\n    oro_email.workflow.action.schedule_send_email_template:\n        parent: oro_email.workflow.action.send_email_template\n        class: Oro\\Bundle\\EmailBundle\\Workflow\\Action\\ScheduleSendEmailTemplate\n        arguments:\n            - '@oro_entity.doctrine_helper'\n            - '@oro_message_queue.client.message_producer'\n        calls:\n            - [setLogger, ['@logger']]\n        tags:\n            - { name: oro_action.action, alias: schedule_send_email_template }\n\n    oro_email.helper.datagrid.emails:\n        class: Oro\\Bundle\\EmailBundle\\Datagrid\\EmailGridHelper\n        public: true\n        arguments:\n            - '@oro_entity.doctrine_helper'\n            - '@oro_email.email_synchronization_manager'\n            - '@oro_activity.manager'\n            - 'Oro\\Bundle\\UserBundle\\Entity\\User'\n\n    Oro\\Bundle\\EmailBundle\\Datagrid\\EmailGridHelper:\n        alias: 'oro_email.helper.datagrid.emails'\n\n    oro_email.email_grid_result_helper:\n        class: Oro\\Bundle\\EmailBundle\\Datagrid\\EmailGridResultHelper\n        arguments:\n            - '@doctrine'\n            - '@oro_email.email.owner.provider.storage'\n            - '@oro_email.email_grid_mailbox_name_helper'\n            - '@oro_email.email.address.manager'\n\n    oro_email.email_grid_mailbox_name_helper:\n        class: Oro\\Bundle\\EmailBundle\\Datagrid\\MailboxNameHelper\n        arguments:\n            - '@translator'\n\n    oro_email.listener.datagrid.email:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\Datagrid\\EmailGridListener\n        arguments:\n            - '@oro_email.datagrid_query_factory'\n            - '@oro_filter.provider.state.filters'\n            - '@oro_config.manager'\n            - '@oro_email.email_grid_result_helper'\n        tags:\n            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.after.base-email-grid, method: onBuildAfter }\n            - { name: kernel.event_listener, event: oro_datagrid.orm_datasource.result.before_query.base-email-grid, method: onResultBeforeQuery, priority: -255 }\n            - { name: kernel.event_listener, event: oro_datagrid.orm_datasource.result.after.base-email-grid, method: onResultAfter }\n\n    oro_email.listener.datagrid.activity:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\Datagrid\\ActivityGridListener\n        arguments:\n            - '@oro_email.helper.datagrid.emails'\n            - '@oro_entity.routing_helper'\n        tags:\n            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.after.activity-email-grid, method: onBuildAfter }\n\n    oro_email.listener.datagrid.recent_emails:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\Datagrid\\RecentEmailGridListener\n        arguments:\n            - '@oro_email.helper.datagrid.emails'\n            - '@oro_email.datagrid_query_factory'\n        tags:\n            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.after.dashboard-recent-emails-grid, method: onBuildAfter }\n\n    oro_email.listener.datagrid.recent_emails.incoming:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\Datagrid\\IncomingEmailGridListener\n        arguments:\n            - '@oro_email.datagrid_query_factory'\n        tags:\n            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.after.dashboard-recent-emails-inbox-grid, method: onBuildAfter }\n            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.after.dashboard-recent-emails-new-grid, method: onBuildAfter }\n\n    oro_email.listener.datagrid.recent_emails.outgoing:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\Datagrid\\OutgoingEmailGridListener\n        arguments:\n            - '@oro_email.email_grid_result_helper'\n        tags:\n            - { name: kernel.event_listener, event: oro_datagrid.orm_datasource.result.after.dashboard-recent-emails-sent-grid, method: onResultAfter }\n\n    oro_email.email_synchronization_manager:\n        class: Oro\\Bundle\\EmailBundle\\Sync\\EmailSynchronizationManager\n        public: true\n        arguments:\n            - '@service_container'\n\n    Oro\\Bundle\\EmailBundle\\Sync\\EmailSynchronizationManager:\n        alias: 'oro_email.email_synchronization_manager'\n\n    oro_email.known_email_address_checker_factory:\n        class: Oro\\Bundle\\EmailBundle\\Sync\\KnownEmailAddressCheckerFactory\n        shared: false\n        arguments:\n            - '@doctrine'\n            - '@oro_email.email.address.manager'\n            - '@oro_email.email.address.helper'\n            - '@oro_email.email.owner.provider.storage'\n            - '%oro_email.email_sync_exclusions%'\n\n    oro_email.email.activity.manager:\n        class: Oro\\Bundle\\EmailBundle\\Entity\\Manager\\EmailActivityManager\n        arguments:\n            - '@oro_activity.manager'\n            - '@oro_email.activity_list.provider'\n            - '@oro_email.email.thread.provider'\n            - '@security.token_storage'\n            - '@oro_security.owner.entity_owner_accessor.link'\n            - \"@=service('doctrine').getManagerForClass('OroEmailBundle:Email')\"\n\n    oro_email.email.thread.provider:\n        class: Oro\\Bundle\\EmailBundle\\Entity\\Provider\\EmailThreadProvider\n        public: true\n\n    Oro\\Bundle\\EmailBundle\\Entity\\Provider\\EmailThreadProvider:\n        alias: 'oro_email.email.thread.provider'\n\n    oro_email.email.thread.manager:\n        class: Oro\\Bundle\\EmailBundle\\Entity\\Manager\\EmailThreadManager\n        arguments:\n            - '@oro_email.email.thread.provider'\n            - \"@=service('doctrine').getManagerForClass('OroEmailBundle:EmailThread')\"\n\n    oro_email.email.manager:\n        class: Oro\\Bundle\\EmailBundle\\Entity\\Manager\\EmailManager\n        public: true\n        arguments:\n            - '@doctrine.orm.entity_manager'\n            - '@oro_email.email.thread.manager'\n            - '@oro_email.email.thread.provider'\n            - '@oro_security.token_accessor'\n            - '@oro_email.mailbox.manager'\n\n    Oro\\Bundle\\EmailBundle\\Entity\\Manager\\EmailManager:\n        alias: 'oro_email.email.manager'\n\n    oro_email.twig.extension.email:\n        class: Oro\\Bundle\\EmailBundle\\Twig\\EmailExtension\n        arguments:\n            - '@oro_platform.twig.service_locator'\n        tags:\n            - { name: twig.extension }\n\n    oro_email.listener.search_listener:\n          class: Oro\\Bundle\\EmailBundle\\EventListener\\SearchListener\n          tags:\n              - { name: kernel.event_listener, event: oro_search.prepare_entity_map, method: prepareEntityMapEvent, priority: 10 }\n\n    oro_email.activity_list.provider:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\EmailActivityListProvider\n        arguments:\n           - '@oro_entity.doctrine_helper'\n           - '@oro_entity.entity_name_resolver'\n           - '@router'\n           - '@oro_entity_config.config_manager'\n           - '@oro_email.email.thread.provider'\n           - '@oro_ui.html_tag_helper'\n           - '@security.authorization_checker'\n           - '@oro_security.token_accessor'\n           - '@oro_email.mailbox.process_storage'\n           - '@oro_activity.association_helper'\n           - '@oro_comment.association_helper'\n        tags:\n           - { name: oro_activity_list.provider, class: Oro\\Bundle\\EmailBundle\\Entity\\Email, acl_class: Oro\\Bundle\\EmailBundle\\Entity\\EmailUser, priority: 30 }\n           - { name: oro_featuretogle.feature, feature: email }\n\n    oro_email.related_emails.provider:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\RelatedEmailsProvider\n        arguments:\n            - '@security.authorization_checker'\n            - '@oro_security.token_accessor'\n            - '@oro_email.provider.email_recipients.helper'\n            - '@oro_entity.entity_field_provider'\n            - '@oro_email.email_attribute.provider'\n\n    oro_email.email_attribute.provider:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\EmailAttributeProvider\n        arguments:\n            - '@doctrine'\n            - '@oro_entity_config.config_manager'\n            - '@oro_locale.formatter.name'\n            - '@oro_email.email.address.helper'\n\n    oro_email.email_recipients.provider:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\EmailRecipientsProvider\n        public: true\n        arguments:\n            - '@translator'\n            - '@oro_email.provider.email_recipients.helper'\n\n    Oro\\Bundle\\EmailBundle\\Provider\\EmailRecipientsProvider:\n        alias: 'oro_email.email_recipients.provider'\n\n    oro_email.recent_email_recipients.provider:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\RecentEmailRecipientsProvider\n        arguments:\n            - '@oro_security.token_accessor'\n            - '@oro_email.related_emails.provider'\n            - '@oro_security.acl_helper'\n            - '@doctrine'\n            - '@oro_email.email.owner.provider'\n            - '@oro_email.provider.email_recipients.helper'\n        tags:\n            - { name: oro_email.recipients_provider }\n\n    oro_email.context_email_recipients.provider:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\ContextEmailRecipientsProvider\n        arguments:\n            - '@oro_email.related_emails.provider'\n        tags:\n            - { name: oro_email.recipients_provider, priority: 10 }\n\n    oro_email.provider.emailowners.provider:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\EmailOwnersProvider\n        arguments:\n            - '@oro_activity_list.provider.chain'\n            - '@oro_email.email.owner.provider.storage'\n            - '@doctrine'\n\n    oro_email.provider.email_recipients.helper:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\EmailRecipientsHelper\n        public: true\n        arguments:\n            - '@oro_security.acl_helper'\n            - '@oro_locale.dql.formatter.name'\n            - '@oro_locale.formatter.name'\n            - '@oro_entity_config.config_manager'\n            - '@translator'\n            - '@oro_email.email.owner.provider'\n            - '@doctrine'\n            - '@oro_email.email.address.helper'\n            - '@oro_search.index'\n\n    Oro\\Bundle\\EmailBundle\\Provider\\EmailRecipientsHelper:\n        alias: 'oro_email.provider.email_recipients.helper'\n\n    oro_email.manager.email_attachment_manager:\n        class: Oro\\Bundle\\EmailBundle\\Manager\\EmailAttachmentManager\n        public: true\n        arguments:\n            - '@oro_attachment.file_manager'\n            - '@doctrine'\n            - '@router'\n            - '@oro_attachment.validator.file_config_validator'\n            - '@oro_attachment.association_helper'\n\n    Oro\\Bundle\\EmailBundle\\Manager\\EmailAttachmentManager:\n        alias: 'oro_email.manager.email_attachment_manager'\n\n    oro_email.listener.email_body_add_listener:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\EmailBodyAddListener\n        arguments:\n            - '@oro_email.manager.email_attachment_manager'\n            - '@oro_entity_config.provider.attachment'\n            - '@oro_email.activity_list.provider'\n            - '@security.authorization_checker'\n            - '@security.token_storage'\n            - '@oro_activity_list.provider.chain'\n            - '@doctrine.orm.entity_manager'\n        tags:\n            - { name: kernel.event_listener, event: oro_email.email_body_added, method: linkToScope, priority: 10 }\n            - { name: kernel.event_listener, event: oro_email.email_body_added, method: updateActivityDescription, priority: 20 }\n\n    oro_email.listener.replace_embedded_attachments_listener:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\ReplaceEmbeddedAttachmentsListener\n        tags:\n            - { name: kernel.event_listener, event: oro_email.email_body_loaded, method: replace }\n\n    oro_email.provider.email_attachment_provider:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\EmailAttachmentProvider\n        arguments:\n            - '@oro_email.email.thread.provider'\n            - '@doctrine'\n            - '@oro_attachment.provider.attachment'\n            - '@oro_email.email_attachment_transformer'\n\n    oro_email.email_attachment_transformer:\n        class: Oro\\Bundle\\EmailBundle\\Tools\\EmailAttachmentTransformer\n        arguments:\n            - '@oro_email.form.factory'\n            - '@oro_attachment.file_manager'\n            - '@oro_attachment.manager'\n            - '@oro_email.manager.email_attachment_manager'\n\n    oro_email.email_importance_transformer:\n        class: Oro\\Bundle\\EmailBundle\\Form\\DataTransformer\\EmailImportanceApiTransformer\n        public: true\n\n    oro_email.email_body_type_transformer:\n        class: Oro\\Bundle\\EmailBundle\\Form\\DataTransformer\\EmailBodyTypeApiTransformer\n        public: true\n\n    oro_email.acl.voter.email_voter:\n        class: Oro\\Bundle\\EmailBundle\\Acl\\Voter\\EmailVoter\n        arguments:\n            - '@security.authorization_checker'\n            - '@oro_email.mailbox.manager'\n        tags:\n            - { name: security.voter }\n\n    oro_email.entity_alias_provider:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\EmailEntityAliasProvider\n        arguments:\n            - '@oro_email.email.address.manager'\n        tags:\n            - { name: oro_entity.alias_provider }\n\n    oro_email.manager.email_activity.api:\n        class: Oro\\Bundle\\EmailBundle\\Entity\\Manager\\EmailActivityApiEntityManager\n        public: true\n        parent: oro_soap.manager.entity_manager.abstract\n        arguments:\n            - 'Oro\\Bundle\\EmailBundle\\Entity\\Email'\n            - '@doctrine.orm.entity_manager'\n            - '@oro_activity.manager'\n            - '@security.token_storage'\n\n    oro_email.manager.email_activity_entity.api:\n        class: Oro\\Bundle\\EmailBundle\\Entity\\Manager\\EmailActivityEntityApiEntityManager\n        public: true\n        parent: oro_soap.manager.entity_manager.abstract\n        arguments:\n            - 'Oro\\Bundle\\EmailBundle\\Entity\\Email'\n            - '@doctrine.orm.entity_manager'\n            - '@oro_activity.manager'\n            - '@security.token_storage'\n\n    oro_email.manager.email_activity_search.api:\n        class: Oro\\Bundle\\EmailBundle\\Entity\\Manager\\EmailActivitySearchApiEntityManager\n        public: true\n        parent: oro_soap.manager.entity_manager.abstract\n        arguments:\n            - 'Oro\\Bundle\\EmailBundle\\Entity\\Email'\n            - '@doctrine.orm.entity_manager'\n            - '@oro_activity.manager'\n            - '@oro_search.index'\n            - '@oro_entity.entity_name_resolver'\n\n    oro_email.manager.email_activity_suggestion.api:\n        class: Oro\\Bundle\\EmailBundle\\Entity\\Manager\\EmailActivitySuggestionApiEntityManager\n        public: true\n        parent: oro_soap.manager.entity_manager.abstract\n        arguments:\n            - 'Oro\\Bundle\\EmailBundle\\Entity\\Email'\n            - '@doctrine.orm.entity_manager'\n            - '@oro_activity.manager'\n            - '@oro_search.index'\n            - '@oro_entity.entity_name_resolver'\n        calls:\n            - [setTokenStorage, ['@security.token_storage']]\n\n    oro_email.email.flag.manager:\n        class: Oro\\Bundle\\EmailBundle\\Manager\\EmailFlagManager\n        arguments:\n            - '@oro_email.email_flag_manager_loader_selector'\n            - '@doctrine.orm.entity_manager'\n        calls:\n            - [setLogger, ['@logger']]\n\n    oro_email.internal_email.flag_manager_loader:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\InternalEmailFlagManagerLoader\n        tags:\n            - { name: oro_email.email_flag_manager_loader }\n\n    oro_email.manager.notification:\n        class: Oro\\Bundle\\EmailBundle\\Manager\\EmailNotificationManager\n        public: true\n        arguments:\n            - '@doctrine.orm.entity_manager'\n            - '@oro_ui.html_tag_helper'\n            - '@router'\n            - '@oro_entity_config.config_manager'\n\n    Oro\\Bundle\\EmailBundle\\Manager\\EmailNotificationManager:\n        alias: 'oro_email.manager.notification'\n        public: true\n\n    oro_email.datagrid.origin_folder.provider:\n        class: Oro\\Bundle\\EmailBundle\\Datagrid\\OriginFolderFilterProvider\n        public: true\n        arguments:\n            - '@doctrine'\n            - '@oro_security.token_accessor'\n            - '@oro_email.email_grid_mailbox_name_helper'\n\n    oro_email.mailbox.process_storage:\n        class: Oro\\Bundle\\EmailBundle\\Mailbox\\MailboxProcessStorage\n        arguments:\n            - '@oro_featuretoggle.checker.feature_checker'\n\n    oro_email.mailbox_email_owner_provider:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\MailboxEmailOwnerProvider\n        tags:\n            - { name: oro_email.owner.provider, order: 2 }\n\n    oro_email.mailbox_choice_list:\n        class: Oro\\Bundle\\EmailBundle\\Datagrid\\MailboxChoiceList\n        public: true\n        arguments:\n            - '@oro_security.token_accessor'\n            - '@oro_email.mailbox.manager'\n            - '@oro_email.email_grid_mailbox_name_helper'\n\n    oro_email.mailbox.manager.api:\n        class: Oro\\Bundle\\SoapBundle\\Entity\\Manager\\ApiEntityManager\n        parent: oro_soap.manager.entity_manager.abstract\n        arguments:\n            - 'Oro\\Bundle\\EmailBundle\\Entity\\Mailbox'\n            - '@doctrine.orm.entity_manager'\n\n    oro_email.mailbox.entity_name_provider:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\MailboxEntityNameProvider\n        arguments:\n            - '@translator.default'\n        tags:\n            - { name: oro_entity.name_provider, priority: 0}\n\n    oro_email.email_user.provider.email_user_entity_name_provider:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\EmailUserEntityNameProvider\n        tags:\n            - { name: oro_entity.name_provider, priority: 0 }\n\n    oro_email.email_body_entity_name_provider:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\EmailBodyEntityNameProvider\n        tags:\n            - { name: oro_entity.name_provider, priority: 0 }\n\n    oro_email.listener.mailbox_process_trigger_listener:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\MailboxProcessTriggerListener\n        arguments:\n            - '@Psr\\Container\\ContainerInterface'\n        tags:\n            - { name: doctrine.event_listener, event: onFlush }\n            - { name: doctrine.event_listener, event: postFlush }\n            - { name: oro_featuretogle.feature, feature: email }\n            - { name: container.service_subscriber }\n            - { name: container.service_subscriber, id: oro_email.mailbox.process_storage }\n            - { name: container.service_subscriber, id: oro_workflow.process.process_handler }\n\n    oro_email.autocomplete.mailbox_user_search_handler:\n        class: Oro\\Bundle\\EmailBundle\\Autocomplete\\MailboxUserSearchHandler\n        public: true\n        parent: oro_user.autocomplete.user.organization_search_handler\n\n    oro_email.listener.mailbox.authorization:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\MailboxAuthorizationListener\n        arguments:\n            - '@doctrine'\n            - '@security.authorization_checker'\n            - '@oro_security.token_accessor'\n        tags:\n            - { name: kernel.event_listener, event: kernel.controller, method: onKernelController }\n\n    oro_email.listener.datagrid.mailbox_grid:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\Datagrid\\MailboxGridListener\n        arguments:\n            - '@doctrine'\n            - '@oro_security.acl_helper'\n        tags:\n            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.pre.base-mailboxes-grid, method: onPreBuild }\n            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.after.base-mailboxes-grid, method: onBuildAfter }\n            - { name: oro_featuretogle.feature, feature: email }\n\n    oro_email.mailbox.manager:\n        class: Oro\\Bundle\\EmailBundle\\Entity\\Manager\\MailboxManager\n        public: true\n        arguments:\n            - '@doctrine'\n\n    Oro\\Bundle\\EmailBundle\\Entity\\Manager\\MailboxManager:\n        alias: 'oro_email.mailbox.manager'\n\n    oro_email.workflow.condition.instanceof:\n        class: Oro\\Bundle\\EmailBundle\\Model\\Condition\\IsInstanceOf\n        tags:\n            - { name: oro_action.condition, alias: instanceof }\n\n    oro_email.workflow.condition.has_count:\n        class: Oro\\Bundle\\EmailBundle\\Model\\Condition\\HasCount\n        tags:\n            - { name: oro_action.condition, alias: has_count }\n\n    oro_email.workflow.action.parse_first_name:\n        class: Oro\\Bundle\\EmailBundle\\Model\\Action\\ParseFirstNameFromEmailAddress\n        arguments:\n            - '@oro_action.expression.context_accessor'\n            - '@oro_email.email.address.helper'\n        tags:\n            - { name: oro_action.action, alias: parse_first_name_from_email_address }\n\n    oro_email.workflow.action.parse_last_name:\n        class: Oro\\Bundle\\EmailBundle\\Model\\Action\\ParseLastNameFromEmailAddress\n        arguments:\n            - '@oro_action.expression.context_accessor'\n            - '@oro_email.email.address.helper'\n        tags:\n            - { name: oro_action.action, alias: parse_last_name_from_email_address }\n\n    oro_email.workflow.action.request_mailboxes:\n        class: Oro\\Bundle\\EmailBundle\\Model\\Action\\RequestMailboxes\n        arguments:\n            - '@oro_action.expression.context_accessor'\n            - '@doctrine'\n            - '@oro_email.mailbox.process_storage'\n        tags:\n            - { name: oro_action.action, alias: request_mailboxes|find_mailboxes }\n\n    oro_email.workflow.action.strip_html_tags:\n        class: Oro\\Bundle\\EmailBundle\\Model\\Action\\StripHtmlTags\n        arguments:\n            - '@oro_action.expression.context_accessor'\n            - '@oro_ui.html_tag_helper'\n        tags:\n            - { name: oro_action.action, alias: strip_html_tags }\n\n    oro_email.workflow.action.add_activity_target:\n        class: Oro\\Bundle\\EmailBundle\\Model\\Action\\AddActivityTarget\n        arguments:\n            - '@oro_action.expression.context_accessor'\n            - '@oro_email.email.activity.manager'\n            - '@oro_activity_list.provider.chain'\n            - '@doctrine.orm.entity_manager'\n        tags:\n            - { name: oro_action.action, alias: add_email_activity_target }\n\n    oro_email.placeholder.send_email.filter:\n        class: Oro\\Bundle\\EmailBundle\\Placeholder\\SendEmailPlaceholderFilter\n        public: true\n        arguments:\n            - '@oro_activity.manager'\n\n    oro_email.tools.email_origin_helper:\n        class: Oro\\Bundle\\EmailBundle\\Tools\\EmailOriginHelper\n        arguments:\n            - '@oro_entity.doctrine_helper'\n            - '@oro_security.token_accessor'\n            - '@oro_email.email.owner.provider'\n            - '@oro_email.email.address.helper'\n\n    oro_email.listener.search_aliases_listener:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\SearchAliasesListener\n        tags:\n            - { name: kernel.event_listener, event: oro_activity.search_aliases, method: addEmailAliasEvent }\n\n    oro_email.listener.prepare_result_item_listener:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\PrepareResultItemListener\n        arguments:\n            - '@router'\n            - '@oro_entity.doctrine_helper'\n        tags:\n            - { name: kernel.event_listener, event: oro_search.prepare_result_item, method: prepareEmailItemDataEvent }\n\n    oro_email.listener.prepare_context_title_listener:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\PrepareContextTitleListener\n        arguments:\n            - '@router'\n            - '@oro_entity.doctrine_helper'\n        tags:\n            - { name: kernel.event_listener, event: oro_activity.context_title, method: prepareEmailContextTitleEvent }\n\n    oro_email.listener.activity_list_pre_query_build_listener:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\ActivityListPreQueryBuildListener\n        arguments:\n            - '@oro_entity.doctrine_helper'\n        tags:\n            - { name: kernel.event_listener, event: oro_activity_list.activity_list_pre_query_build, method: prepareIdsForEmailThreadEvent }\n            - { name: oro_featuretogle.feature, feature: email }\n\n    oro_email.email_body_synchronizer:\n        class: Oro\\Bundle\\EmailBundle\\Sync\\EmailBodySynchronizer\n        arguments:\n            - '@oro_email.email_body_loader_selector'\n            - '@doctrine'\n            - '@event_dispatcher'\n        calls:\n            - [setLogger, ['@logger']]\n\n    oro_email.model.email_activity_updates:\n        class: Oro\\Bundle\\EmailBundle\\Model\\EmailActivityUpdates\n        arguments:\n            - '@oro_email.provider.emailowners.provider'\n\n    oro_email.async.manager.association_manager:\n        class: Oro\\Bundle\\EmailBundle\\Async\\Manager\\AssociationManager\n        arguments:\n            - '@oro_entity.doctrine_helper'\n            - '@oro_email.email.activity.manager'\n            - '@oro_email.provider.emailowners.provider'\n            - '@oro_email.email.manager'\n            - '@oro_message_queue.client.message_producer'\n\n    oro_email.async.upgrade_email_body_processor:\n        class: Oro\\Bundle\\EmailBundle\\Migrations\\Schema\\v1_29\\UpgradeEmailBodyMessageProcessor\n        arguments:\n            - '@oro_message_queue.message_producer'\n            - '@oro_entity.orm.native_query_executor_helper'\n            - '@logger'\n        tags:\n            - { name: 'oro_message_queue.client.message_processor', topicName: 'oro_email.migrate_email_body' }\n\n    oro_email.logger.link:\n        tags:\n            - { name: oro_service_link, service: logger }\n\n    oro_email.provider.smtp_settings:\n        class: Oro\\Bundle\\EmailBundle\\Provider\\SmtpSettingsProvider\n        public: true\n        arguments:\n            - '@oro_config.manager'\n            - '@oro_config.scope.global'\n            - '@oro_security.encoder.default'\n\n    Oro\\Bundle\\EmailBundle\\Provider\\SmtpSettingsProvider:\n        alias: oro_email.provider.smtp_settings\n\n    oro_email.mailer.checker.smtp_settings:\n        class: Oro\\Bundle\\EmailBundle\\Mailer\\Checker\\SmtpSettingsChecker\n        public: true\n        arguments:\n            - '@oro_email.direct_mailer'\n\n    Oro\\Bundle\\EmailBundle\\Mailer\\Checker\\SmtpSettingsChecker:\n        alias: 'oro_email.mailer.checker.smtp_settings'\n\n    oro_email.listener.datagrid.user_email_grid_listener:\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\Datagrid\\UserEmailGridListener\n        arguments:\n            - '@oro_email.datagrid_query_factory'\n        tags:\n          - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.after.user-email-grid, method: onBuildAfter }\n          - { name: oro_featuretogle.feature, feature: email }\n\n    oro_email.emailtemplate.variable_processor:\n        class: Oro\\Bundle\\EntityBundle\\Twig\\Sandbox\\VariableProcessorRegistry\n        arguments:\n            - ~ # service locator\n\n    oro_email.emailtemplate.variable_processor.entity_routes:\n        class: Oro\\Bundle\\EmailBundle\\Processor\\EntityRouteVariableProcessor\n        arguments:\n            - '@oro_entity.doctrine_helper'\n            - '@oro_email.provider.url_provider'\n            - '@logger'\n        tags:\n            - { name: oro_email.emailtemplate.variable_processor, alias: entity_routes }\n\n    oro_email.migration.demo_data_fixtures_listener.email_associations:\n        parent: oro_platform.event_listener.demo_data_fixtures_listener.abstract\n        class: Oro\\Bundle\\EmailBundle\\EventListener\\EmailAssociationsDemoDataFixturesListener\n        arguments:\n            - '@oro_email.async.manager.association_manager'\n        calls:\n            # this listener is disabled to prevent a lot of UpdateEmailAssociations messages\n            - [disableListener, ['oro_email.listener.entity_listener']]\n        tags:\n            - { name: kernel.event_listener, event: oro_migration.data_fixtures.pre_load, method: onPreLoad }\n            - { name: kernel.event_listener, event: oro_migration.data_fixtures.post_load, method: onPostLoad }\n\n    oro_email.topic.event:\n        class: Oro\\Bundle\\SyncBundle\\Topic\\SecuredTopic\n        arguments:\n            - 'oro_email.event'\n            - '@gos_web_socket.client.manipulator'\n        tags:\n            - { name: gos_web_socket.topic }\n\n    oro_email.acl.voter.email_template_voter:\n        class: Oro\\Bundle\\EmailBundle\\Acl\\Voter\\EmailTemplateVoter\n        arguments:\n            - '@oro_entity.doctrine_helper'\n        calls:\n            - [setClassName, ['Oro\\Bundle\\EmailBundle\\Entity\\EmailTemplate']]\n        tags:\n            - { name: security.voter }\n\n    oro_email.manager.template_email:\n        class: Oro\\Bundle\\EmailBundle\\Manager\\EmailTemplateManager\n        public: true\n        arguments:\n            - '@oro_email.direct_mailer'\n            - '@oro_email.mailer.processor'\n            - '@oro_email.provider.localized_template'\n\n    oro_email.async.template_email_message_sender:\n        class: 'Oro\\Bundle\\EmailBundle\\Async\\TemplateEmailMessageSender'\n        arguments:\n            - '@oro_email.manager.template_email'\n            - '@oro_entity.doctrine_helper'\n\n    oro_email.entity_name_provider:\n        class: 'Oro\\Bundle\\EmailBundle\\Provider\\EmailEntityNameProvider'\n        arguments:\n            - '@property_accessor'\n        tags:\n            - { name: oro_entity.name_provider, priority: -80 }\n\n    oro_email.provider.localized_template:\n        class: 'Oro\\Bundle\\EmailBundle\\Provider\\LocalizedTemplateProvider'\n        arguments:\n            - '@oro_locale.provider.preferred_localization_provider'\n            - '@oro_email.provider.email_template_content_provider'\n\n    oro_email.provider.email_template_content_provider:\n        class: 'Oro\\Bundle\\EmailBundle\\Provider\\EmailTemplateContentProvider'\n        public: true\n        arguments:\n            - '@doctrine'\n            - '@oro_email.email_renderer'\n            - '@property_accessor'\n            - '@logger'\n\n    oro_email.provider.url_provider:\n        class: 'Oro\\Bundle\\EmailBundle\\Provider\\UrlProvider'\n        arguments:\n            - '@oro_config.manager'\n            - '@router'\n    oro_email.form.handler.user_email_config:\n         class: 'Oro\\Bundle\\EmailBundle\\Form\\Handler\\UserEmailConfigHandler'\n         public: true\n         arguments:\n             - '@doctrine.orm.entity_manager'\n\n    oro_email.validator.connection_configuration.smtp:\n        class: 'Oro\\Bundle\\EmailBundle\\Validator\\SmtpConnectionConfigurationValidator'\n        arguments:\n            - '@oro_email.mailer.checker.smtp_settings'\n            - '@oro_email.smtp_settings_factory'\n        tags:\n            - { name: validator.constraint_validator }\n\n    oro_email.smtp_settings_factory:\n        class: 'Oro\\Bundle\\EmailBundle\\Form\\Model\\SmtpSettingsFactory'\n        arguments:\n            - '@oro_security.encoder.default'\n\n    oro_email.sender.aggregated_email_templates:\n        class: 'Oro\\Bundle\\EmailBundle\\Tools\\AggregatedEmailTemplatesSender'\n        arguments:\n            - '@oro_entity.doctrine_helper'\n            - '@oro_email.provider.localized_template'\n            - '@oro_email.tools.email_origin_helper'\n            - '@oro_email.mailer.processor'\n        calls:\n            - [setLogger, ['@logger']]\n\n    oro_email.async.send_email_template:\n        class: 'Oro\\Bundle\\EmailBundle\\Async\\SendEmailTemplateProcessor'\n        arguments:\n            - '@validator'\n            - '@oro_entity.doctrine_helper'\n            - '@oro_email.sender.aggregated_email_templates'\n        calls:\n            - [setLogger, ['@logger']]\n        tags:\n            - { name: 'oro_message_queue.client.message_processor' }\n", "<?php\n\nnamespace Oro\\Bundle\\EmailBundle\\Tests\\Unit\\Provider;\n\nuse Doctrine\\Inflector\\Rules\\English\\InflectorFactory;\nuse Oro\\Bundle\\EmailBundle\\Entity\\EmailTemplate as EmailTemplateEntity;\nuse Oro\\Bundle\\EmailBundle\\Model\\EmailTemplate as EmailTemplateModel;\nuse Oro\\Bundle\\EmailBundle\\Model\\EmailTemplateInterface;\nuse Oro\\Bundle\\EmailBundle\\Provider\\EmailRenderer;\nuse Oro\\Bundle\\EmailBundle\\Tests\\Unit\\Fixtures\\Entity\\TestEntityForVariableProvider;\nuse Oro\\Bundle\\EntityBundle\\Twig\\Sandbox\\TemplateRendererConfigProviderInterface;\nuse Oro\\Bundle\\EntityBundle\\Twig\\Sandbox\\VariableProcessorRegistry;\nuse Oro\\Bundle\\UIBundle\\Tools\\HtmlTagHelper;\nuse Oro\\Bundle\\UIBundle\\Twig\\HtmlTagExtension;\nuse Symfony\\Bridge\\Twig\\Extension\\HttpKernelExtension;\nuse Symfony\\Component\\DependencyInjection\\ContainerInterface;\nuse Symfony\\Contracts\\Translation\\TranslatorInterface;\nuse Twig\\Environment;\nuse Twig\\Extension\\SandboxExtension;\nuse Twig\\Loader\\ArrayLoader;\nuse Twig\\Sandbox\\SecurityPolicy;\n\nclass EmailRendererTest extends \\PHPUnit\\Framework\\TestCase\n{\n    /** @var TemplateRendererConfigProviderInterface|\\PHPUnit\\Framework\\MockObject\\MockObject */\n    private $configProvider;\n\n    /** @var ContainerInterface|\\PHPUnit\\Framework\\MockObject\\MockObject */\n    private $container;\n\n    /** @var EmailRenderer */\n    private $renderer;\n\n    protected function setUp(): void\n    {\n        $this->configProvider = $this->createMock(TemplateRendererConfigProviderInterface::class);\n        $this->container = $this->createMock(ContainerInterface::class);\n\n        $variablesProcessorRegistry = $this->createMock(VariableProcessorRegistry::class);\n\n        $htmlTagHelper = $this->createMock(HtmlTagHelper::class);\n        $htmlTagHelper->expects(self::any())\n            ->method('sanitize')\n            ->with(self::isType(\\PHPUnit\\Framework\\Constraint\\IsType::TYPE_STRING), 'default', false)\n            ->willReturnCallback(static function (string $content) {\n                return $content . '(sanitized)';\n            });\n\n        $translation = $this->createMock(TranslatorInterface::class);\n        $translation->expects(self::any())\n            ->method('trans')\n            ->willReturnArgument(0);\n\n        $environment = new Environment(new ArrayLoader(), ['strict_variables' => true]);\n        $environment->addExtension(new SandboxExtension(new SecurityPolicy()));\n        $environment->addExtension(new HttpKernelExtension());\n        $environment->addExtension(new HtmlTagExtension($this->container));\n\n        $this->renderer = new EmailRenderer(\n            $environment,\n            $this->configProvider,\n            $variablesProcessorRegistry,\n            $translation,\n            (new InflectorFactory())->build()\n        );\n\n        $this->renderer->setHtmlTagHelper($htmlTagHelper);\n    }\n\n    private function getEmailTemplate(string $content, string $subject = ''): EmailTemplateInterface\n    {\n        $emailTemplate = new EmailTemplateModel();\n        $emailTemplate->setContent($content);\n        $emailTemplate->setSubject($subject);\n\n        return $emailTemplate;\n    }\n\n    private function expectVariables(array $entityVariableProcessors = [], array $systemVariableValues = []): void\n    {\n        $entityVariableProcessorsMap = [];\n        foreach ($entityVariableProcessors as $entityClass => $processors) {\n            $entityVariableProcessorsMap[] = [$entityClass, $processors];\n        }\n        $this->configProvider->expects(self::any())\n            ->method('getEntityVariableProcessors')\n            ->willReturnMap($entityVariableProcessorsMap);\n        $this->configProvider->expects(self::any())\n            ->method('getSystemVariableValues')\n            ->willReturn($systemVariableValues);\n    }\n\n    public function testCompilePreview(): void\n    {\n        $entity = new TestEntityForVariableProvider();\n\n        $this->configProvider->expects(self::any())\n            ->method('getConfiguration')\n            ->willReturn([\n                'properties' => [],\n                'methods' => [get_class($entity) => ['getField1']],\n                'accessors' => [get_class($entity) => ['field1' => 'getField1']],\n                'default_formatters' => [],\n            ]);\n\n        $template = 'test <a href=\"http://example.com\">test</a> {{ system.testVar }}';\n\n        $emailTemplate = new EmailTemplateEntity();\n        $emailTemplate->setContent($template);\n        $emailTemplate->setSubject('');\n\n        self::assertSame($template.'(sanitized)', $this->renderer->compilePreview($emailTemplate));\n    }\n\n    public function testCompileMessage(): void\n    {\n        $entity = new TestEntityForVariableProvider();\n        $entity->setField1('Test');\n        $entityClass = get_class($entity);\n        $systemVars = ['testVar' => 'test_system'];\n        $entityVariableProcessors = [$entityClass => []];\n        $defaultFormatters = [$entityClass => ['field1' => 'formatter1']];\n\n        $subject = 'subject';\n        $content = 'test '\n            . '<a href=\"http://example.com\">test</a>'\n            . ' {{ entity.getField1()|oro_html_sanitize }}'\n            . ' {{ entity.field2|trim|raw }}'\n            . ' {{ max(0, 2) }}'\n            . ' {{ system.testVar }}'\n            . ' N/A';\n\n        $this->configProvider->expects(self::any())\n            ->method('getConfiguration')\n            ->willReturn([\n                'properties' => [],\n                'methods' => [$entityClass => ['getField1']],\n                'accessors' => [$entityClass => ['field1' => 'getField1']],\n                'default_formatters' => $defaultFormatters,\n            ]);\n        $this->expectVariables($entityVariableProcessors, $systemVars);\n\n        $htmlTagHelper = $this->createMock(HtmlTagHelper::class);\n        $this->container->expects(self::once())\n            ->method('get')\n            ->with('oro_ui.html_tag_helper')\n            ->willReturn($htmlTagHelper);\n\n        $emailTemplate = $this->getEmailTemplate($content, $subject);\n        $templateParams = [\n            'entity' => $entity,\n            'system' => $systemVars,\n        ];\n\n        $result = $this->renderer->compileMessage($emailTemplate, $templateParams);\n        $expectedContent = 'test <a href=\"http://example.com\">test</a>   2 test_system N/A';\n\n        self::assertIsArray($result);\n        self::assertCount(2, $result);\n        self::assertSame($subject, $result[0]);\n        self::assertSame($expectedContent, $result[1]);\n    }\n\n    public function testRenderTemplate(): void\n    {\n        $template = 'test '\n            . \"\\n\"\n            . '{{ entity.field1 }}'\n            . \"\\n\"\n            . '{{ system.currentDate }}';\n\n        $entity = new TestEntityForVariableProvider();\n        $this->configProvider->expects(self::any())\n            ->method('getConfiguration')\n            ->willReturn([\n                'properties' => [],\n                'methods' => [get_class($entity) => ['getField1']],\n                'accessors' => [get_class($entity) => ['field1' => 'getField1']],\n                'default_formatters' => [],\n            ]);\n        $this->expectVariables([\n            get_class($entity) => [],\n        ], ['currentDate' => '10-12-2019']);\n\n        $htmlTagHelper = $this->createMock(HtmlTagHelper::class);\n        $this->container->expects(self::once())\n            ->method('get')\n            ->with('oro_ui.html_tag_helper')\n            ->willReturn($htmlTagHelper);\n\n        $result = $this->renderer->renderTemplate($template, ['entity' => $entity]);\n\n        $expectedRenderedResult =\n            'test '\n            . \"\\n\"\n            . '10-12-2019';\n        self::assertSame($expectedRenderedResult, $result);\n    }\n}\n"], "filenames": ["src/Oro/Bundle/EmailBundle/Provider/EmailRenderer.php", "src/Oro/Bundle/EmailBundle/Resources/config/services.yml", "src/Oro/Bundle/EmailBundle/Tests/Unit/Provider/EmailRendererTest.php"], "buggy_code_start_loc": [9, 340, 25], "buggy_code_end_loc": [66, 340, 212], "fixing_code_start_loc": [10, 341, 24], "fixing_code_end_loc": [81, 342, 198], "type": "CWE-79", "message": "OroPlatform is a PHP Business Application Platform. In affected versions the email template preview is vulnerable to XSS payload added to email template content. An attacker must have permission to create or edit an email template. For successful payload, execution the attacked user must preview a vulnerable email template. There are no workarounds that address this vulnerability. Users are advised to upgrade as soon as is possible.", "other": {"cve": {"id": "CVE-2021-41236", "sourceIdentifier": "security-advisories@github.com", "published": "2022-01-04T19:15:14.763", "lastModified": "2022-01-08T02:45:28.930", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "OroPlatform is a PHP Business Application Platform. In affected versions the email template preview is vulnerable to XSS payload added to email template content. An attacker must have permission to create or edit an email template. For successful payload, execution the attacked user must preview a vulnerable email template. There are no workarounds that address this vulnerability. Users are advised to upgrade as soon as is possible."}, {"lang": "es", "value": "OroPlatform es una plataforma de aplicaciones empresariales en PHP. En las versiones afectadas, la vista previa de la plantilla de correo electr\u00f3nico es vulnerable a una carga \u00fatil de tipo XSS a\u00f1adida al contenido de la plantilla de correo electr\u00f3nico. Un atacante debe tener permiso para crear o editar una plantilla de correo electr\u00f3nico. Para que la carga \u00fatil sea ejecutada con \u00e9xito, el usuario atacado debe previsualizar una plantilla de correo electr\u00f3nico vulnerable. No se presentan medidas de mitigaci\u00f3n que aborden esta vulnerabilidad. Se aconseja a usuarios que actualicen lo antes posible"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:H/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "HIGH", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 4.8, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 1.7, "impactScore": 2.7}, {"source": "security-advisories@github.com", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:H/UI:R/S:C/C:H/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "HIGH", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.9, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 1.7, "impactScore": 4.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:S/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "SINGLE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 3.5}, "baseSeverity": "LOW", "exploitabilityScore": 6.8, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}, {"source": "security-advisories@github.com", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:oroinc:oroplatform:*:*:*:*:*:*:*:*", "versionStartIncluding": "3.1.0", "versionEndExcluding": "3.1.21", "matchCriteriaId": "A7CF754D-C446-40C5-87FF-E484463CB6CF"}, {"vulnerable": true, "criteria": "cpe:2.3:a:oroinc:oroplatform:*:*:*:*:*:*:*:*", "versionStartIncluding": "4.1.0", "versionEndExcluding": "4.1.14", "matchCriteriaId": "87F8B0EB-6235-4EA7-9D34-F2FDF469C1C1"}, {"vulnerable": true, "criteria": "cpe:2.3:a:oroinc:oroplatform:*:*:*:*:*:*:*:*", "versionStartIncluding": "4.2.0", "versionEndExcluding": "4.2.8", "matchCriteriaId": "2BB63725-D5A6-4440-BC10-A003B18ADF5B"}]}]}], "references": [{"url": "https://github.com/oroinc/platform/commit/2a089c971fc70bc63baf8770d29ee515ce5a415a", "source": "security-advisories@github.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/oroinc/platform/security/advisories/GHSA-qv7g-j98v-8pp7", "source": "security-advisories@github.com", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/oroinc/platform/commit/2a089c971fc70bc63baf8770d29ee515ce5a415a"}}