{"buggy_code": ["<?php\n/* For licensing terms, see /license.txt */\n/**\n * @package chamilo.social\n *\n * @author Julio Montoya <gugli100@gmail.com>\n */\n$cidReset = true;\nrequire_once __DIR__.'/../inc/global.inc.php';\n\napi_block_anonymous_users();\n\nif (api_get_setting('allow_social_tool') !== 'true') {\n    api_not_allowed();\n}\n\n$this_section = SECTION_SOCIAL;\n\n// prepare anchor for message group topic\n$anchor = '';\nif (isset($_GET['anchor_topic'])) {\n    $anchor = Security::remove_XSS($_GET['anchor_topic']);\n} else {\n    $match = 0;\n    $param_names = array_keys($_GET);\n    foreach ($param_names as $param) {\n        if (preg_match('/^items_(\\d)_page_nr$/', $param, $match)) {\n            break;\n        }\n    }\n    if (isset($match[1])) {\n        $anchor = 'topic_'.$match[1];\n    }\n}\n$htmlHeadXtra[] = '<script>\n\nvar counter_image = 1;\nfunction remove_image_form(id_elem1) {\n\tvar elem1 = document.getElementById(id_elem1);\n\telem1.parentNode.removeChild(elem1);\n\tcounter_image--;\n\tvar filepaths = document.getElementById(\"filepaths\");\n\tif (filepaths.childNodes.length < 3) {\n\t\tvar link_attach = document.getElementById(\"link-more-attach\");\n\t\tif (link_attach) {\n\t\t\tlink_attach.innerHTML=\\'<a href=\"javascript://\" class=\"btn btn-default\" onclick=\"return add_image_form()\">'.get_lang('AddOneMoreFile').'</a>\\';\n\t\t}\n\t}\n}\n\nfunction add_image_form() {\n\t// Multiple filepaths for image form\n\tvar filepaths = document.getElementById(\"filepaths\");\n\tif (document.getElementById(\"filepath_\"+counter_image)) {\n\t\tcounter_image = counter_image + 1;\n\t}  else {\n\t\tcounter_image = counter_image;\n\t}\n\tvar elem1 = document.createElement(\"div\");\n\telem1.setAttribute(\"id\",\"filepath_\"+counter_image);\n\tfilepaths.appendChild(elem1);\n\tid_elem1 = \"filepath_\"+counter_image;\n\tid_elem1 = \"\\'\"+id_elem1+\"\\'\";\n\tdocument.getElementById(\"filepath_\"+counter_image).innerHTML = \"\\n\\\n        <input type=\\\"file\\\" name=\\\"attach_\"+counter_image+\"\\\"  size=\\\"20\\\" />\\n\\\n        <a href=\\\"javascript:remove_image_form(\"+id_elem1+\")\\\">\\n\\\n            <img src=\\\"'.Display::returnIconPath('delete.gif').'\\\">\\n\\\n        </a>\\n\\\n    \";\n\n\tif (filepaths.childNodes.length == 3) {\n\t\tvar link_attach = document.getElementById(\"link-more-attach\");\n\t\tif (link_attach) {\n\t\t\tlink_attach.innerHTML=\"\";\n\t\t}\n\t}\n}\n\n</script>';\n\n$allowed_views = ['mygroups', 'newest', 'pop'];\n$content = null;\n\nif (isset($_GET['view']) && in_array($_GET['view'], $allowed_views)) {\n    if ($_GET['view'] == 'mygroups') {\n        $interbreadcrumb[] = ['url' => 'groups.php', 'name' => get_lang('Groups')];\n        $interbreadcrumb[] = ['url' => '#', 'name' => get_lang('MyGroups')];\n    } elseif ($_GET['view'] == 'newest') {\n        $interbreadcrumb[] = ['url' => 'groups.php', 'name' => get_lang('Groups')];\n        $interbreadcrumb[] = ['url' => '#', 'name' => get_lang('Newest')];\n    } else {\n        $interbreadcrumb[] = ['url' => 'groups.php', 'name' => get_lang('Groups')];\n        $interbreadcrumb[] = ['url' => '#', 'name' => get_lang('Popular')];\n    }\n} else {\n    $interbreadcrumb[] = ['url' => 'groups.php', 'name' => get_lang('Groups')];\n    if (!isset($_GET['id'])) {\n        $interbreadcrumb[] = ['url' => '#', 'name' => get_lang('GroupList')];\n    } else {\n        //$interbreadcrumb[]= array ('url' =>'#','name' => get_lang('Group'));\n    }\n}\n\n// getting group information\n$group_id = isset($_GET['id']) ? intval($_GET['id']) : null;\n$relation_group_title = '';\n$role = 0;\n\n$usergroup = new UserGroup();\n\nif ($group_id != 0) {\n    $group_info = $usergroup->get($group_id);\n\n    $interbreadcrumb[] = ['url' => '#', 'name' => $group_info['name']];\n\n    if (isset($_GET['action']) && $_GET['action'] == 'leave') {\n        $user_leaved = intval($_GET['u']);\n        // I can \"leave me myself\"\n        if (api_get_user_id() == $user_leaved) {\n            if (UserGroup::canLeave($group_info)) {\n                $usergroup->delete_user_rel_group($user_leaved, $group_id);\n                Display::addFlash(\n                    Display::return_message(get_lang('UserIsNotSubscribedToThisGroup'), 'confirmation', false)\n                );\n            }\n        }\n    }\n\n    // add a user to a group if its open\n    if (isset($_GET['action']) && $_GET['action'] == 'join') {\n        // we add a user only if is a open group\n        $user_join = intval($_GET['u']);\n        if (api_get_user_id() == $user_join && !empty($group_id)) {\n            if ($group_info['visibility'] == GROUP_PERMISSION_OPEN) {\n                $usergroup->add_user_to_group($user_join, $group_id);\n                Display::addFlash(\n                    Display::return_message(get_lang('UserIsSubscribedToThisGroup'), 'confirmation', false)\n                );\n            } else {\n                $usergroup->add_user_to_group(\n                    $user_join,\n                    $group_id,\n                    GROUP_USER_PERMISSION_PENDING_INVITATION_SENT_BY_USER\n                );\n                Display::addFlash(\n                    Display::return_message(get_lang('InvitationSent'), 'confirmation', false)\n                );\n            }\n        }\n    }\n}\n$create_thread_link = '';\n$social_right_content = null;\n$socialForum = '';\n\n$group_info = $usergroup->get($group_id);\n\n//Loading group information\nif (isset($_GET['status']) && $_GET['status'] == 'sent') {\n    $social_right_content .= Display::return_message(get_lang('MessageHasBeenSent'), 'confirmation', false);\n}\n\n$is_group_member = $usergroup->is_group_member($group_id);\n$role = $usergroup->get_user_group_role(api_get_user_id(), $group_id);\n\nif (!$is_group_member && $group_info['visibility'] == GROUP_PERMISSION_CLOSED) {\n    if ($role == GROUP_USER_PERMISSION_PENDING_INVITATION_SENT_BY_USER) {\n        $social_right_content .= Display::return_message(get_lang('YouAlreadySentAnInvitation'));\n    }\n}\n\nif ($is_group_member || $group_info['visibility'] == GROUP_PERMISSION_OPEN) {\n    if (!$is_group_member) {\n        if (!in_array(\n            $role,\n            [GROUP_USER_PERMISSION_PENDING_INVITATION_SENT_BY_USER, GROUP_USER_PERMISSION_PENDING_INVITATION]\n        )) {\n            $social_right_content .= '<div class=\"group-tool\">';\n            $social_right_content .= '<div class=\"pull-right\">';\n            $social_right_content .= '<a class=\"btn btn-default btn-sm\" href=\"group_view.php?id='.$group_id.'&action=join&u='.api_get_user_id().'\">'.\n                get_lang('JoinGroup').'</a>';\n            $social_right_content .= '</div>';\n            $social_right_content .= '</div>';\n        } elseif ($role == GROUP_USER_PERMISSION_PENDING_INVITATION) {\n            $social_right_content .= '<div class=\"group-tool\">';\n            $social_right_content .= '<div class=\"pull-right\">';\n            $social_right_content .= '<a class=\"btn btn-default btn-sm\" href=\"group_view.php?id='.$group_id.'&action=join&u='.api_get_user_id().'\">'.\n                    Display::returnFontAwesomeIcon('envelope').' '.\n                get_lang('YouHaveBeenInvitedJoinNow').'</a>';\n        }\n        $social_right_content .= '</div>';\n        $social_right_content .= '</div>';\n    }\n    $content = MessageManager::display_messages_for_group($group_id);\n    if ($is_group_member) {\n        if (empty($content)) {\n            $createThreadUrl = api_get_path(WEB_CODE_PATH)\n                .'social/message_for_group_form.inc.php?'\n                .http_build_query([\n                    'view_panel' => 1,\n                    'user_friend' => api_get_user_id(),\n                    'group_id' => $group_id,\n                    'action' => 'add_message_group',\n                ]);\n            $create_thread_link = Display::url(\n                Display::returnFontAwesomeIcon('commenting').' '.\n                get_lang('YouShouldCreateATopic'),\n                $createThreadUrl,\n                [\n                    'class' => 'ajax btn btn-primary',\n                    'title' => get_lang('ComposeMessage'),\n                    'data-title' => get_lang('ComposeMessage'),\n                    'data-size' => 'lg',\n                ]\n            );\n        } else {\n            $createThreadUrl = api_get_path(WEB_CODE_PATH)\n                .'social/message_for_group_form.inc.php?'\n                .http_build_query([\n                    'view_panel' => 1,\n                    'user_friend' => api_get_user_id(),\n                    'group_id' => $group_id,\n                    'action' => 'add_message_group',\n                ]);\n            $create_thread_link = Display::url(\n                Display::returnFontAwesomeIcon('commenting').' '.\n                get_lang('NewTopic'),\n                $createThreadUrl,\n                [\n                    'class' => 'ajax btn btn-default',\n                    'title' => get_lang('ComposeMessage'),\n                    'data-title' => get_lang('ComposeMessage'),\n                    'data-size' => 'lg',\n                ]\n            );\n        }\n    }\n    $members = $usergroup->get_users_by_group($group_id, true);\n    $member_content = '';\n\n    // My friends\n    $friend_html = SocialManager::listMyFriendsBlock(\n        $user_id,\n        '',\n        ''\n    );\n\n    // Members\n    if (count($members) > 0) {\n        if ($role == GROUP_USER_PERMISSION_ADMIN) {\n            $member_content .= '<div class=\"group-tool\">';\n            $member_content .= '<div class=\"pull-right\">';\n            $member_content .= Display::url(\n                Display::returnFontAwesomeIcon('pencil').' '.get_lang('EditMembersList'),\n                'group_members.php?id='.$group_id,\n                ['class' => 'btn btn-default btn-sm', 'title' => get_lang('EditMembersList')]\n            );\n            $member_content .= '</div>';\n            $member_content .= '</div>';\n        }\n        $member_content .= '<div class=\"user-list\">';\n        $member_content .= '<div class=\"row\">';\n        foreach ($members as $member) {\n            // if is a member\n            if (in_array(\n                $member['relation_type'],\n                [GROUP_USER_PERMISSION_ADMIN, GROUP_USER_PERMISSION_READER, GROUP_USER_PERMISSION_MODERATOR]\n            )) {\n                //add icons\n                if ($member['relation_type'] == GROUP_USER_PERMISSION_ADMIN) {\n                    $icon = Display::return_icon('social_group_admin.png', get_lang('Admin'));\n                } elseif ($member['relation_type'] == GROUP_USER_PERMISSION_MODERATOR) {\n                    $icon = Display::return_icon('social_group_moderator.png', get_lang('Moderator'));\n                } else {\n                    $icon = '';\n                }\n\n                $userPicture = UserManager::getUserPicture($member['id']);\n                $member_content .= '<div class=\"col-md-3\">';\n                $member_content .= '<div class=\"items-user\">';\n                $member_name = Display::url(\n                    api_get_person_name(\n                        cut($member['user_info']['firstname'], 15),\n                        cut($member['user_info']['lastname'], 15)\n                    ).'&nbsp;'.$icon,\n                    $member['user_info']['profile_url']\n                );\n                $member_content .= Display::div('<img class=\"img-circle\" src=\"'.$userPicture.'\"/>', ['class' => 'avatar']);\n                $member_content .= Display::div($member_name, ['class' => 'name']);\n                $member_content .= '</div>';\n                $member_content .= '</div>';\n            }\n        }\n        $member_content .= '</div>';\n        $member_content .= '</div>';\n    }\n\n    if (!empty($create_thread_link)) {\n        $create_thread_link = Display::div($create_thread_link, ['class' => 'pull-right']);\n    }\n    $headers = [get_lang('Discussions'), get_lang('Members')];\n    $socialForum = Display::tabs($headers, [$content, $member_content], 'tabs');\n} else {\n    // if I already sent an invitation message\n    if (!in_array(\n        $role,\n        [\n            GROUP_USER_PERMISSION_PENDING_INVITATION_SENT_BY_USER,\n            GROUP_USER_PERMISSION_PENDING_INVITATION,\n        ]\n    )) {\n        $social_right_content .= '<a class=\"btn\" href=\"group_view.php?id='.$group_id.'&action=join&u='.api_get_user_id().'\">'.get_lang('JoinGroup').'</a>';\n    } elseif ($role == GROUP_USER_PERMISSION_PENDING_INVITATION) {\n        $social_right_content .= '<a class=\"btn\" href=\"group_view.php?id='.$group_id.'&action=join&u='.api_get_user_id().'\">'.get_lang('YouHaveBeenInvitedJoinNow').'</a>';\n    }\n}\n\n$tpl = new Template(null);\n\n// Block Social Avatar\nSocialManager::setSocialUserBlock($tpl, api_get_user_id(), 'groups', $group_id);\n//Block Social Menu\n$social_menu_block = SocialManager::show_social_menu('groups', $group_id);\n$tpl->setHelp('Groups');\n$tpl->assign('create_link', $create_thread_link);\n$tpl->assign('is_group_member', $is_group_member);\n$tpl->assign('group_info', $group_info);\n$tpl->assign('social_friend_block', $friend_html);\n$tpl->assign('social_menu_block', $social_menu_block);\n$tpl->assign('social_forum', $socialForum);\n$tpl->assign('social_right_content', $social_right_content);\n$social_layout = $tpl->get_template('social/group_view.tpl');\n$tpl->display($social_layout);\n"], "fixing_code": ["<?php\n/* For licensing terms, see /license.txt */\n/**\n * @package chamilo.social\n *\n * @author Julio Montoya <gugli100@gmail.com>\n */\n$cidReset = true;\nrequire_once __DIR__.'/../inc/global.inc.php';\n\napi_block_anonymous_users();\n\nif (api_get_setting('allow_social_tool') !== 'true') {\n    api_not_allowed();\n}\n\n$this_section = SECTION_SOCIAL;\n\n// prepare anchor for message group topic\n$anchor = '';\nif (isset($_GET['anchor_topic'])) {\n    $anchor = Security::remove_XSS($_GET['anchor_topic']);\n} else {\n    $match = 0;\n    $param_names = array_keys($_GET);\n    foreach ($param_names as $param) {\n        if (preg_match('/^items_(\\d)_page_nr$/', $param, $match)) {\n            break;\n        }\n    }\n    if (isset($match[1])) {\n        $anchor = 'topic_'.$match[1];\n    }\n}\n$htmlHeadXtra[] = '<script>\n\nvar counter_image = 1;\nfunction remove_image_form(id_elem1) {\n\tvar elem1 = document.getElementById(id_elem1);\n\telem1.parentNode.removeChild(elem1);\n\tcounter_image--;\n\tvar filepaths = document.getElementById(\"filepaths\");\n\tif (filepaths.childNodes.length < 3) {\n\t\tvar link_attach = document.getElementById(\"link-more-attach\");\n\t\tif (link_attach) {\n\t\t\tlink_attach.innerHTML=\\'<a href=\"javascript://\" class=\"btn btn-default\" onclick=\"return add_image_form()\">'.get_lang('AddOneMoreFile').'</a>\\';\n\t\t}\n\t}\n}\n\nfunction add_image_form() {\n\t// Multiple filepaths for image form\n\tvar filepaths = document.getElementById(\"filepaths\");\n\tif (document.getElementById(\"filepath_\"+counter_image)) {\n\t\tcounter_image = counter_image + 1;\n\t}  else {\n\t\tcounter_image = counter_image;\n\t}\n\tvar elem1 = document.createElement(\"div\");\n\telem1.setAttribute(\"id\",\"filepath_\"+counter_image);\n\tfilepaths.appendChild(elem1);\n\tid_elem1 = \"filepath_\"+counter_image;\n\tid_elem1 = \"\\'\"+id_elem1+\"\\'\";\n\tdocument.getElementById(\"filepath_\"+counter_image).innerHTML = \"\\n\\\n        <input type=\\\"file\\\" name=\\\"attach_\"+counter_image+\"\\\"  size=\\\"20\\\" />\\n\\\n        <a href=\\\"javascript:remove_image_form(\"+id_elem1+\")\\\">\\n\\\n            <img src=\\\"'.Display::returnIconPath('delete.gif').'\\\">\\n\\\n        </a>\\n\\\n    \";\n\n\tif (filepaths.childNodes.length == 3) {\n\t\tvar link_attach = document.getElementById(\"link-more-attach\");\n\t\tif (link_attach) {\n\t\t\tlink_attach.innerHTML=\"\";\n\t\t}\n\t}\n}\n\n</script>';\n\n$allowed_views = ['mygroups', 'newest', 'pop'];\n$content = null;\n\nif (isset($_GET['view']) && in_array($_GET['view'], $allowed_views)) {\n    if ($_GET['view'] == 'mygroups') {\n        $interbreadcrumb[] = ['url' => 'groups.php', 'name' => get_lang('Groups')];\n        $interbreadcrumb[] = ['url' => '#', 'name' => get_lang('MyGroups')];\n    } elseif ($_GET['view'] == 'newest') {\n        $interbreadcrumb[] = ['url' => 'groups.php', 'name' => get_lang('Groups')];\n        $interbreadcrumb[] = ['url' => '#', 'name' => get_lang('Newest')];\n    } else {\n        $interbreadcrumb[] = ['url' => 'groups.php', 'name' => get_lang('Groups')];\n        $interbreadcrumb[] = ['url' => '#', 'name' => get_lang('Popular')];\n    }\n} else {\n    $interbreadcrumb[] = ['url' => 'groups.php', 'name' => get_lang('Groups')];\n    if (!isset($_GET['id'])) {\n        $interbreadcrumb[] = ['url' => '#', 'name' => get_lang('GroupList')];\n    } else {\n        //$interbreadcrumb[]= array ('url' =>'#','name' => get_lang('Group'));\n    }\n}\n\n// getting group information\n$group_id = isset($_GET['id']) ? intval($_GET['id']) : null;\n$relation_group_title = '';\n$role = 0;\n\n$usergroup = new UserGroup();\n\nif ($group_id != 0) {\n    $group_info = $usergroup->get($group_id);\n    $group_info['name'] = Security::remove_XSS($group_info['name']);\n    $group_info['description'] = Security::remove_XSS($group_info['description']);\n\n    $interbreadcrumb[] = ['url' => '#', 'name' => $group_info['name']];\n\n    if (isset($_GET['action']) && $_GET['action'] == 'leave') {\n        $user_leaved = intval($_GET['u']);\n        // I can \"leave me myself\"\n        if (api_get_user_id() == $user_leaved) {\n            if (UserGroup::canLeave($group_info)) {\n                $usergroup->delete_user_rel_group($user_leaved, $group_id);\n                Display::addFlash(\n                    Display::return_message(get_lang('UserIsNotSubscribedToThisGroup'), 'confirmation', false)\n                );\n            }\n        }\n    }\n\n    // add a user to a group if its open\n    if (isset($_GET['action']) && $_GET['action'] == 'join') {\n        // we add a user only if is a open group\n        $user_join = intval($_GET['u']);\n        if (api_get_user_id() == $user_join && !empty($group_id)) {\n            if ($group_info['visibility'] == GROUP_PERMISSION_OPEN) {\n                $usergroup->add_user_to_group($user_join, $group_id);\n                Display::addFlash(\n                    Display::return_message(get_lang('UserIsSubscribedToThisGroup'), 'confirmation', false)\n                );\n            } else {\n                $usergroup->add_user_to_group(\n                    $user_join,\n                    $group_id,\n                    GROUP_USER_PERMISSION_PENDING_INVITATION_SENT_BY_USER\n                );\n                Display::addFlash(\n                    Display::return_message(get_lang('InvitationSent'), 'confirmation', false)\n                );\n            }\n        }\n    }\n}\n$create_thread_link = '';\n$social_right_content = null;\n$socialForum = '';\n\n$group_info = $usergroup->get($group_id);\n$group_info['name'] = Security::remove_XSS($group_info['name']);\n$group_info['description'] = Security::remove_XSS($group_info['description']);\n\n//Loading group information\nif (isset($_GET['status']) && $_GET['status'] == 'sent') {\n    $social_right_content .= Display::return_message(get_lang('MessageHasBeenSent'), 'confirmation', false);\n}\n\n$is_group_member = $usergroup->is_group_member($group_id);\n$role = $usergroup->get_user_group_role(api_get_user_id(), $group_id);\n\nif (!$is_group_member && $group_info['visibility'] == GROUP_PERMISSION_CLOSED) {\n    if ($role == GROUP_USER_PERMISSION_PENDING_INVITATION_SENT_BY_USER) {\n        $social_right_content .= Display::return_message(get_lang('YouAlreadySentAnInvitation'));\n    }\n}\n\nif ($is_group_member || $group_info['visibility'] == GROUP_PERMISSION_OPEN) {\n    if (!$is_group_member) {\n        if (!in_array(\n            $role,\n            [GROUP_USER_PERMISSION_PENDING_INVITATION_SENT_BY_USER, GROUP_USER_PERMISSION_PENDING_INVITATION]\n        )) {\n            $social_right_content .= '<div class=\"group-tool\">';\n            $social_right_content .= '<div class=\"pull-right\">';\n            $social_right_content .= '<a class=\"btn btn-default btn-sm\" href=\"group_view.php?id='.$group_id.'&action=join&u='.api_get_user_id().'\">'.\n                get_lang('JoinGroup').'</a>';\n            $social_right_content .= '</div>';\n            $social_right_content .= '</div>';\n        } elseif ($role == GROUP_USER_PERMISSION_PENDING_INVITATION) {\n            $social_right_content .= '<div class=\"group-tool\">';\n            $social_right_content .= '<div class=\"pull-right\">';\n            $social_right_content .= '<a class=\"btn btn-default btn-sm\" href=\"group_view.php?id='.$group_id.'&action=join&u='.api_get_user_id().'\">'.\n                    Display::returnFontAwesomeIcon('envelope').' '.\n                get_lang('YouHaveBeenInvitedJoinNow').'</a>';\n        }\n        $social_right_content .= '</div>';\n        $social_right_content .= '</div>';\n    }\n    $content = MessageManager::display_messages_for_group($group_id);\n    if ($is_group_member) {\n        if (empty($content)) {\n            $createThreadUrl = api_get_path(WEB_CODE_PATH)\n                .'social/message_for_group_form.inc.php?'\n                .http_build_query([\n                    'view_panel' => 1,\n                    'user_friend' => api_get_user_id(),\n                    'group_id' => $group_id,\n                    'action' => 'add_message_group',\n                ]);\n            $create_thread_link = Display::url(\n                Display::returnFontAwesomeIcon('commenting').' '.\n                get_lang('YouShouldCreateATopic'),\n                $createThreadUrl,\n                [\n                    'class' => 'ajax btn btn-primary',\n                    'title' => get_lang('ComposeMessage'),\n                    'data-title' => get_lang('ComposeMessage'),\n                    'data-size' => 'lg',\n                ]\n            );\n        } else {\n            $createThreadUrl = api_get_path(WEB_CODE_PATH)\n                .'social/message_for_group_form.inc.php?'\n                .http_build_query([\n                    'view_panel' => 1,\n                    'user_friend' => api_get_user_id(),\n                    'group_id' => $group_id,\n                    'action' => 'add_message_group',\n                ]);\n            $create_thread_link = Display::url(\n                Display::returnFontAwesomeIcon('commenting').' '.\n                get_lang('NewTopic'),\n                $createThreadUrl,\n                [\n                    'class' => 'ajax btn btn-default',\n                    'title' => get_lang('ComposeMessage'),\n                    'data-title' => get_lang('ComposeMessage'),\n                    'data-size' => 'lg',\n                ]\n            );\n        }\n    }\n    $members = $usergroup->get_users_by_group($group_id, true);\n    $member_content = '';\n\n    // My friends\n    $friend_html = SocialManager::listMyFriendsBlock(\n        $user_id,\n        '',\n        ''\n    );\n\n    // Members\n    if (count($members) > 0) {\n        if ($role == GROUP_USER_PERMISSION_ADMIN) {\n            $member_content .= '<div class=\"group-tool\">';\n            $member_content .= '<div class=\"pull-right\">';\n            $member_content .= Display::url(\n                Display::returnFontAwesomeIcon('pencil').' '.get_lang('EditMembersList'),\n                'group_members.php?id='.$group_id,\n                ['class' => 'btn btn-default btn-sm', 'title' => get_lang('EditMembersList')]\n            );\n            $member_content .= '</div>';\n            $member_content .= '</div>';\n        }\n        $member_content .= '<div class=\"user-list\">';\n        $member_content .= '<div class=\"row\">';\n        foreach ($members as $member) {\n            // if is a member\n            if (in_array(\n                $member['relation_type'],\n                [GROUP_USER_PERMISSION_ADMIN, GROUP_USER_PERMISSION_READER, GROUP_USER_PERMISSION_MODERATOR]\n            )) {\n                //add icons\n                if ($member['relation_type'] == GROUP_USER_PERMISSION_ADMIN) {\n                    $icon = Display::return_icon('social_group_admin.png', get_lang('Admin'));\n                } elseif ($member['relation_type'] == GROUP_USER_PERMISSION_MODERATOR) {\n                    $icon = Display::return_icon('social_group_moderator.png', get_lang('Moderator'));\n                } else {\n                    $icon = '';\n                }\n\n                $userPicture = UserManager::getUserPicture($member['id']);\n                $member_content .= '<div class=\"col-md-3\">';\n                $member_content .= '<div class=\"items-user\">';\n                $member_name = Display::url(\n                    api_get_person_name(\n                        cut($member['user_info']['firstname'], 15),\n                        cut($member['user_info']['lastname'], 15)\n                    ).'&nbsp;'.$icon,\n                    $member['user_info']['profile_url']\n                );\n                $member_content .= Display::div('<img class=\"img-circle\" src=\"'.$userPicture.'\"/>', ['class' => 'avatar']);\n                $member_content .= Display::div($member_name, ['class' => 'name']);\n                $member_content .= '</div>';\n                $member_content .= '</div>';\n            }\n        }\n        $member_content .= '</div>';\n        $member_content .= '</div>';\n    }\n\n    if (!empty($create_thread_link)) {\n        $create_thread_link = Display::div($create_thread_link, ['class' => 'pull-right']);\n    }\n    $headers = [get_lang('Discussions'), get_lang('Members')];\n    $socialForum = Display::tabs($headers, [$content, $member_content], 'tabs');\n} else {\n    // if I already sent an invitation message\n    if (!in_array(\n        $role,\n        [\n            GROUP_USER_PERMISSION_PENDING_INVITATION_SENT_BY_USER,\n            GROUP_USER_PERMISSION_PENDING_INVITATION,\n        ]\n    )) {\n        $social_right_content .= '<a class=\"btn\" href=\"group_view.php?id='.$group_id.'&action=join&u='.api_get_user_id().'\">'.get_lang('JoinGroup').'</a>';\n    } elseif ($role == GROUP_USER_PERMISSION_PENDING_INVITATION) {\n        $social_right_content .= '<a class=\"btn\" href=\"group_view.php?id='.$group_id.'&action=join&u='.api_get_user_id().'\">'.get_lang('YouHaveBeenInvitedJoinNow').'</a>';\n    }\n}\n\n$tpl = new Template(null);\n\n// Block Social Avatar\nSocialManager::setSocialUserBlock($tpl, api_get_user_id(), 'groups', $group_id);\n//Block Social Menu\n$social_menu_block = SocialManager::show_social_menu('groups', $group_id);\n$tpl->setHelp('Groups');\n$tpl->assign('create_link', $create_thread_link);\n$tpl->assign('is_group_member', $is_group_member);\n$tpl->assign('group_info', $group_info);\n$tpl->assign('social_friend_block', $friend_html);\n$tpl->assign('social_menu_block', $social_menu_block);\n$tpl->assign('social_forum', $socialForum);\n$tpl->assign('social_right_content', $social_right_content);\n$social_layout = $tpl->get_template('social/group_view.tpl');\n$tpl->display($social_layout);\n"], "filenames": ["main/social/group_view.php"], "buggy_code_start_loc": [112], "buggy_code_end_loc": [156], "fixing_code_start_loc": [113], "fixing_code_end_loc": [161], "type": "CWE-79", "message": "Chamilo LMS version 1.11.8 contains XSS in main/social/group_view.php in the social groups tool, allowing authenticated users to affect other users, under specific conditions of permissions granted by administrators. This is considered \"low risk\" due to the nature of the feature it exploits.", "other": {"cve": {"id": "CVE-2018-20328", "sourceIdentifier": "cve@mitre.org", "published": "2018-12-21T06:29:00.533", "lastModified": "2019-01-07T13:37:16.473", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Chamilo LMS version 1.11.8 contains XSS in main/social/group_view.php in the social groups tool, allowing authenticated users to affect other users, under specific conditions of permissions granted by administrators. This is considered \"low risk\" due to the nature of the feature it exploits."}, {"lang": "es", "value": "Chamilo LMS 1.11.8 contiene Cross-Site Scripting (XSS) en main/social/group_view.php en la herramienta de grupos sociales, lo que permite que usuarios autenticados afecten a otros usuarios en condiciones espec\u00edficas de permisos otorgados por los administradores. Se considera que esto tiene un \"riesgo bajo\" debido a la naturaleza de la caracter\u00edstica que explota."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 5.4, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.3, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:S/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "SINGLE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 3.5}, "baseSeverity": "LOW", "exploitabilityScore": 6.8, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:chamilo:chamilo_lms:1.11.8:*:*:*:*:*:*:*", "matchCriteriaId": "4F7D15FF-5009-4F3B-B583-DD75E5F9B82D"}]}]}], "references": [{"url": "https://github.com/chamilo/chamilo-lms/commit/5e61c2b0fcc938ca687b8d4e593b1500aa52a034", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://support.chamilo.org/projects/1/wiki/Security_issues#Issue-32-2018-11-28-Low-risk-More-XSS-and-path-disclosure-issues", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/chamilo/chamilo-lms/commit/5e61c2b0fcc938ca687b8d4e593b1500aa52a034"}}