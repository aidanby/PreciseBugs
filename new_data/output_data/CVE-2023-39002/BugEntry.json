{"buggy_code": ["<?php\n\n/*\n * Copyright (C) 2014-2015 Deciso B.V.\n * Copyright (C) 2008 Shrew Soft Inc. <mgrooms@shrew.net>\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without\n * modification, are permitted provided that the following conditions are met:\n *\n * 1. Redistributions of source code must retain the above copyright notice,\n *    this list of conditions and the following disclaimer.\n *\n * 2. Redistributions in binary form must reproduce the above copyright\n *    notice, this list of conditions and the following disclaimer in the\n *    documentation and/or other materials provided with the distribution.\n *\n * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES,\n * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY\n * AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE\n * AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY,\n * OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF\n * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS\n * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN\n * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n * POSSIBILITY OF SUCH DAMAGE.\n */\n\nrequire_once(\"guiconfig.inc\");\nrequire_once(\"system.inc\");\n\nfunction ca_import(& $ca, $str, $key=\"\", $serial=0)\n{\n    global $config;\n\n    $ca['crt'] = base64_encode($str);\n    if (!empty($key)) {\n        $ca['prv'] = base64_encode($key);\n    }\n    if (!empty($serial)) {\n        $ca['serial'] = $serial;\n    }\n    $subject = cert_get_subject($str, false);\n    $issuer = cert_get_issuer($str, false);\n\n    // Find my issuer unless self-signed\n    if ($issuer != $subject) {\n        $issuer_crt =& lookup_ca_by_subject($issuer);\n        if ($issuer_crt) {\n            $ca['caref'] = $issuer_crt['refid'];\n        }\n    }\n\n    /* Correct if child certificate was loaded first */\n    if (is_array($config['ca'])) {\n        foreach ($config['ca'] as & $oca) {\n            $issuer = cert_get_issuer($oca['crt']);\n            if ($ca['refid'] != $oca['refid'] && $issuer == $subject) {\n                $oca['caref'] = $ca['refid'];\n            }\n        }\n    }\n    if (is_array($config['cert'])) {\n        foreach ($config['cert'] as & $cert) {\n            $issuer = cert_get_issuer($cert['crt']);\n            if ($issuer == $subject) {\n                $cert['caref'] = $ca['refid'];\n            }\n        }\n    }\n    return true;\n}\n\nfunction ca_inter_create(&$ca, $keylen_curve, $lifetime, $dn, $caref, $digest_alg = 'sha256')\n{\n    // Create Intermediate Certificate Authority\n    $signing_ca = &lookup_ca($caref);\n    if (!$signing_ca) {\n        return false;\n    }\n\n    $signing_ca_res_crt = openssl_x509_read(base64_decode($signing_ca['crt']));\n    $signing_ca_res_key = openssl_pkey_get_private(array(0 => base64_decode($signing_ca['prv']) , 1 => \"\"));\n    if (!$signing_ca_res_crt || !$signing_ca_res_key) {\n        return false;\n    }\n    $signing_ca_serial = ++$signing_ca['serial'];\n\n    $args = array(\n        'config' => '/usr/local/etc/ssl/opnsense.cnf',\n        'x509_extensions' => 'v3_ca',\n        'digest_alg' => $digest_alg,\n        'encrypt_key' => false\n    );\n    if (is_numeric($keylen_curve)) {\n        $args['private_key_type'] = OPENSSL_KEYTYPE_RSA;\n        $args['private_key_bits'] = (int)$keylen_curve;\n    } else {\n        $args['private_key_type'] = OPENSSL_KEYTYPE_EC;\n        $args['curve_name'] = $keylen_curve;\n    }\n\n    // generate a new key pair\n    $res_key = openssl_pkey_new($args);\n    if (!$res_key) {\n        return false;\n    }\n\n    // generate a certificate signing request\n    $res_csr = openssl_csr_new($dn, $res_key, $args);\n    if (!$res_csr) {\n        return false;\n    }\n\n    // Sign the certificate\n    $res_crt = openssl_csr_sign($res_csr, $signing_ca_res_crt, $signing_ca_res_key, $lifetime, $args, $signing_ca_serial);\n    if (!$res_crt) {\n        return false;\n    }\n\n    // export our certificate data\n    if (!openssl_pkey_export($res_key, $str_key) ||\n        !openssl_x509_export($res_crt, $str_crt)) {\n        return false;\n    }\n\n    // return our ca information\n    $ca['crt'] = base64_encode($str_crt);\n    $ca['caref'] = $caref;\n    $ca['prv'] = base64_encode($str_key);\n    $ca['serial'] = 0;\n\n    return true;\n}\n\n$ca_keylens = array( \"512\", \"1024\", \"2048\", \"3072\", \"4096\", \"8192\");\n$ca_curves = array( \"prime256v1\", \"secp384r1\", \"secp521r1\");\n$openssl_digest_algs = array(\"sha1\", \"sha224\", \"sha256\", \"sha384\", \"sha512\");\n$a_ca = &config_read_array('ca');\n$a_cert = &config_read_array('cert');\n$a_crl = &config_read_array('crl');\n\nif ($_SERVER['REQUEST_METHOD'] === 'GET') {\n    if (isset($a_ca[$_GET['id']])) {\n        $id = $_GET['id'];\n    }\n\n    if (isset($_GET['act'])) {\n        $act = $_GET['act'];\n    } else {\n        $act = null;\n    }\n\n    // set defaults\n    $pconfig = array();\n    $pconfig['camethod'] = null ;\n    $pconfig['descr'] = null;\n    $pconfig['serial'] = null;\n    $pconfig['lifetime'] = null;\n    $pconfig['dn_country'] = null;\n    $pconfig['dn_state'] = null;\n    $pconfig['dn_city'] = null;\n    $pconfig['dn_organization'] = null;\n    $pconfig['dn_email'] = null;\n    $pconfig['dn_commonname'] = null;\n\n    if ($act == \"edit\") {\n        if (!isset($id)) {\n            header(url_safe('Location: /system_camanager.php'));\n            exit;\n        }\n        $pconfig['descr'] = $a_ca[$id]['descr'];\n        $pconfig['refid'] = $a_ca[$id]['refid'];\n        $pconfig['cert'] = base64_decode($a_ca[$id]['crt']);\n        $pconfig['serial'] = $a_ca[$id]['serial'] + 1;\n        if (!empty($a_ca[$id]['prv'])) {\n            $pconfig['key'] = base64_decode($a_ca[$id]['prv']);\n        }\n    } elseif ($act == \"new\") {\n        if (isset($_GET['method'])) {\n            $pconfig['camethod'] = $_GET['method'];\n        }\n        $pconfig['refid'] = null;\n        $pconfig['keytype'] = \"RSA\";\n        $pconfig['keylen'] = \"2048\";\n        $pconfig['digest_alg'] = \"sha256\";\n        $pconfig['lifetime'] = \"825\";\n        $pconfig['dn_commonname'] = \"internal-ca\";\n    } elseif ($act == \"exp\") {\n        if (!isset($id)) {\n            header(url_safe('Location: /system_camanager.php'));\n            exit;\n        }\n\n        $exp_name = urlencode(\"{$a_ca[$id]['descr']}.crt\");\n        $exp_data = base64_decode($a_ca[$id]['crt']);\n        $exp_size = strlen($exp_data);\n\n        header(\"Content-Type: application/octet-stream\");\n        header(\"Content-Disposition: attachment; filename={$exp_name}\");\n        header(\"Content-Length: $exp_size\");\n        echo $exp_data;\n        exit;\n    } elseif ($act == \"expkey\") {\n        if (!isset($id)) {\n            header(url_safe('Location: /system_camanager.php'));\n            exit;\n        }\n\n        $exp_name = urlencode(\"{$a_ca[$id]['descr']}.key\");\n        $exp_data = base64_decode($a_ca[$id]['prv']);\n        $exp_size = strlen($exp_data);\n\n        header(\"Content-Type: application/octet-stream\");\n        header(\"Content-Disposition: attachment; filename={$exp_name}\");\n        header(\"Content-Length: $exp_size\");\n        echo $exp_data;\n        exit;\n    }\n} elseif ($_SERVER['REQUEST_METHOD'] === 'POST') {\n    if (isset($a_ca[$_POST['id']])) {\n        $id = $_POST['id'];\n    }\n    if (isset($_POST['act'])) {\n        $act = $_POST['act'];\n    } else {\n        $act = null;\n    }\n\n    if ($act == \"del\") {\n        if (!isset($id)) {\n            header(url_safe('Location: /system_camanager.php'));\n            exit;\n        }\n        $index = count($a_cert) - 1;\n        for (; $index >=0; $index--) {\n            if (isset($a_cert[$index]['caref']) && isset($a_ca[$id]['refid']) && $a_cert[$index]['caref'] == $a_ca[$id]['refid']) {\n                unset($a_cert[$index]);\n            }\n        }\n\n        $index = count($a_crl) - 1;\n        for (; $index >=0; $index--) {\n            if ($a_crl[$index]['caref'] == $a_ca[$id]['refid']) {\n                unset($a_crl[$index]);\n            }\n        }\n\n        unset($a_ca[$id]);\n        write_config();\n        system_trust_configure();\n        header(url_safe('Location: /system_camanager.php'));\n        exit;\n    } else {\n        $input_errors = array();\n        $pconfig = $_POST;\n\n        /* input validation */\n        if ($pconfig['camethod'] == \"existing\") {\n            $reqdfields = explode(\" \", \"descr cert\");\n            $reqdfieldsn = array(\n                    gettext(\"Descriptive name\"),\n                    gettext(\"Certificate data\"));\n            if (!empty($pconfig['cert']) && (!strstr($pconfig['cert'], \"BEGIN CERTIFICATE\") || !strstr($pconfig['cert'], \"END CERTIFICATE\"))) {\n                $input_errors[] = gettext(\"This certificate does not appear to be valid.\");\n            }\n            if (!empty($pconfig['key']) && strstr($pconfig['key'], \"ENCRYPTED\")) {\n                $input_errors[] = gettext(\"Encrypted private keys are not yet supported.\");\n            }\n        } elseif ($pconfig['camethod'] == \"internal\") {\n            $reqdfields = explode(\n                \" \",\n                \"descr keytype keylen curve digest_alg lifetime dn_country dn_state dn_city \".\n                \"dn_organization dn_email dn_commonname\"\n            );\n            $reqdfieldsn = array(\n                    gettext(\"Descriptive name\"),\n                    gettext(\"Key type\"),\n                    gettext(\"Key length\"),\n                    gettext(\"Curve\"),\n                    gettext(\"Digest algorithm\"),\n                    gettext(\"Lifetime\"),\n                    gettext(\"Distinguished name Country Code\"),\n                    gettext(\"Distinguished name State or Province\"),\n                    gettext(\"Distinguished name City\"),\n                    gettext(\"Distinguished name Organization\"),\n                    gettext(\"Distinguished name Email Address\"),\n                    gettext(\"Distinguished name Common Name\"));\n        } elseif ($pconfig['camethod'] == \"intermediate\") {\n            $reqdfields = explode(\n                \" \",\n                \"descr caref keytype keylen curve digest_alg lifetime dn_country dn_state dn_city \".\n                \"dn_organization dn_email dn_commonname\"\n            );\n            $reqdfieldsn = array(\n                    gettext(\"Descriptive name\"),\n                    gettext(\"Signing Certificate Authority\"),\n                    gettext(\"Key type\"),\n                    gettext(\"Key length\"),\n                    gettext(\"Curve\"),\n                    gettext(\"Digest algorithm\"),\n                    gettext(\"Lifetime\"),\n                    gettext(\"Distinguished name Country Code\"),\n                    gettext(\"Distinguished name State or Province\"),\n                    gettext(\"Distinguished name City\"),\n                    gettext(\"Distinguished name Organization\"),\n                    gettext(\"Distinguished name Email Address\"),\n                    gettext(\"Distinguished name Common Name\"));\n        }\n\n        do_input_validation($pconfig, $reqdfields, $reqdfieldsn, $input_errors);\n        if ($pconfig['camethod'] != \"existing\") {\n            /* Make sure we do not have invalid characters in the fields for the certificate */\n            for ($i = 0; $i < count($reqdfields); $i++) {\n                if ($reqdfields[$i] == 'dn_email') {\n                    if (preg_match(\"/[\\!\\#\\$\\%\\^\\(\\)\\~\\?\\>\\<\\&\\/\\\\\\,\\\"\\']/\", $pconfig[\"dn_email\"])) {\n                        $input_errors[] = gettext(\"The field 'Distinguished name Email Address' contains invalid characters.\");\n                    }\n                } elseif ($reqdfields[$i] == 'dn_commonname') {\n                    if (preg_match(\"/[\\!\\@\\#\\$\\%\\^\\(\\)\\~\\?\\>\\<\\&\\/\\\\\\,\\\"\\']/\", $pconfig[\"dn_commonname\"])) {\n                        $input_errors[] = gettext(\"The field 'Distinguished name Common Name' contains invalid characters.\");\n                    }\n                } elseif ($reqdfields[$i] == \"dn_organization\") {\n                    if (preg_match(\"/[\\!\\#\\$\\%\\^\\(\\)\\~\\?\\>\\<\\&\\/\\\\\\\"\\']/\", $pconfig[\"dn_organization\"])) {\n                        $input_errors[] = sprintf(gettext(\"The field '%s' contains invalid characters.\"), $reqdfieldsn[$i]);\n                    }\n                } elseif ($reqdfields[$i] != \"descr\" && preg_match(\"/[\\!\\@\\#\\$\\%\\^\\(\\)\\~\\?\\>\\<\\&\\/\\\\\\,\\\"\\']/\", $pconfig[\"$reqdfields[$i]\"])) {\n                    $input_errors[] = sprintf(gettext(\"The field '%s' contains invalid characters.\"), $reqdfieldsn[$i]);\n                }\n            }\n            if (!in_array($pconfig[\"keytype\"], array(\"RSA\", \"Elliptic Curve\"))) {\n                $input_errors[] = gettext(\"Please select a valid Key Type.\");\n            }\n            if (!in_array($pconfig['keylen'], $ca_keylens) && $pconfig[\"keytype\"] == \"RSA\") {\n                $input_errors[] = gettext(\"Please select a valid Key Length.\");\n            }\n            if (!in_array($pconfig['curve'], $ca_curves) && $pconfig[\"keytype\"] == \"Elliptic Curve\") {\n                $input_errors[] = gettext(\"Please select a valid Curve.\");\n            }\n            if (!in_array($pconfig[\"digest_alg\"], $openssl_digest_algs)) {\n                $input_errors[] = gettext(\"Please select a valid Digest Algorithm.\");\n            }\n        }\n\n        if (isset($pconfig['serial']) && $pconfig['serial'] !== '' &&\n            ((string)((int)$pconfig['serial']) != $pconfig['serial'] || $pconfig['serial'] < 1)) {\n            $input_errors[] = gettext('The serial number must be a number greater than zero or left blank.');\n        }\n\n        /* save modifications */\n        if (count($input_errors) == 0) {\n            $ca = array();\n\n            if (isset($id)) {\n                $ca = $a_ca[$id];\n            } else {\n                $ca['refid'] = uniqid();\n            }\n\n            if (isset($pconfig['descr'])) {\n                $ca['descr'] = $pconfig['descr'];\n            } else {\n                $ca['descr'] = null;\n            }\n\n            if (!empty($pconfig['serial'])) {\n                $ca['serial'] = $pconfig['serial'] - 1;\n            }\n\n            if (isset($id)) {\n                // edit existing\n                $ca['crt'] = base64_encode($pconfig['cert']);\n                if (!empty($pconfig['key'])) {\n                    $ca['prv'] = base64_encode($pconfig['key']);\n                }\n            } else {\n                $old_err_level = error_reporting(0); /* otherwise openssl_ functions throw warnings directly to a page screwing menu tab */\n                if ($pconfig['keytype'] == \"Elliptic Curve\") {\n                    $pconfig['keylen_curve'] = $pconfig['curve'];\n                } else {\n                    $pconfig['keylen_curve'] = $pconfig['keylen'];\n                }\n                if ($pconfig['camethod'] == \"existing\") {\n                    ca_import($ca, $pconfig['cert'], $pconfig['key'], $pconfig['serial']);\n                } elseif ($pconfig['camethod'] == \"internal\") {\n                    $dn = array(\n                        'countryName' => $pconfig['dn_country'],\n                        'stateOrProvinceName' => $pconfig['dn_state'],\n                        'localityName' => $pconfig['dn_city'],\n                        'organizationName' => $pconfig['dn_organization'],\n                        'emailAddress' => $pconfig['dn_email'],\n                        'commonName' => $pconfig['dn_commonname']);\n                    if (!ca_create($ca, $pconfig['keylen_curve'], $pconfig['lifetime'], $dn, $pconfig['digest_alg'])) {\n                        $input_errors = array();\n                        while ($ssl_err = openssl_error_string()) {\n                            $input_errors[] = gettext(\"openssl library returns:\") . \" \" . $ssl_err;\n                        }\n                    }\n                } elseif ($pconfig['camethod'] == \"intermediate\") {\n                    $dn = array(\n                        'countryName' => $pconfig['dn_country'],\n                        'stateOrProvinceName' => $pconfig['dn_state'],\n                        'localityName' => $pconfig['dn_city'],\n                        'organizationName' => $pconfig['dn_organization'],\n                        'emailAddress' => $pconfig['dn_email'],\n                        'commonName' => $pconfig['dn_commonname']);\n                    if (!ca_inter_create($ca, $pconfig['keylen_curve'], $pconfig['lifetime'], $dn, $pconfig['caref'], $pconfig['digest_alg'])) {\n                        $input_errors = array();\n                        while ($ssl_err = openssl_error_string()) {\n                            $input_errors[] = gettext(\"openssl library returns:\") . \" \" . $ssl_err;\n                        }\n                    }\n                }\n                error_reporting($old_err_level);\n            }\n\n            if (isset($id) && $a_ca[$id]) {\n                $a_ca[$id] = $ca;\n            } else {\n                $a_ca[] = $ca;\n            }\n\n            if (count($input_errors) == 0) {\n                write_config();\n                system_trust_configure();\n                header(url_safe('Location: /system_camanager.php'));\n                exit;\n            }\n        }\n    }\n}\n\nlegacy_html_escape_form_data($pconfig);\n\ninclude(\"head.inc\");\n\n?>\n<body>\n  <script>\n  $( document ).ready(function() {\n    // delete entry\n    $(\".act_delete\").click(function(event){\n      event.preventDefault();\n      var id = $(this).data('id');\n      BootstrapDialog.show({\n        type:BootstrapDialog.TYPE_DANGER,\n        title: \"<?= gettext(\"Authorities\");?>\",\n        message: \"<?=gettext(\"Do you really want to delete this Certificate Authority and its CRLs, and unreference any associated certificates?\");?>\",\n        buttons: [{\n                  label: \"<?=gettext(\"No\");?>\",\n                  action: function(dialogRef) {\n                      dialogRef.close();\n                  }}, {\n                  label: \"<?=gettext(\"Yes\");?>\",\n                  action: function(dialogRef) {\n                    $(\"#id\").val(id);\n                    $(\"#action\").val(\"del\");\n                    $(\"#iform\").submit()\n                }\n              }]\n      });\n    });\n\n    $(\"#camethod\").change(function(){\n        $(\"#existing\").addClass(\"hidden\");\n        $(\"#internal\").addClass(\"hidden\");\n        $(\"#intermediate\").addClass(\"hidden\");\n        if ($(this).val() == \"existing\") {\n            $(\"#existing\").removeClass(\"hidden\");\n        } else if ($(this).val() == \"internal\") {\n            $(\"#internal\").removeClass(\"hidden\");\n        } else {\n            $(\"#internal\").removeClass(\"hidden\");\n            $(\"#intermediate\").removeClass(\"hidden\");\n        }\n    });\n\n    $(\"#camethod\").change();\n\n    $(\"#keytype\").change(function(){\n        $(\"#EC\").addClass(\"hidden\");\n        $(\"#RSA\").addClass(\"hidden\");\n        $(\"#blank\").addClass(\"hidden\");\n        if ($(this).val() == \"Elliptic Curve\") {\n            $(\"#EC\").removeClass(\"hidden\");\n        } else {\n            $(\"#RSA\").removeClass(\"hidden\");\n        }\n    });\n\n    $(\"#keytype\").change();\n  });\n  </script>\n\n<?php include(\"fbegin.inc\"); ?>\n\n<section class=\"page-content-main\">\n  <div class=\"container-fluid\">\n    <div class=\"row\">\n<?php\n    if (isset($input_errors) && count($input_errors) > 0) {\n        print_input_errors($input_errors);\n    }\n    if (isset($savemsg)) {\n        print_info_box($savemsg);\n    }\n?>\n    <section class=\"col-xs-12\">\n      <div class=\"content-box tab-content table-responsive\">\n\n        <?php if ($act == \"new\" || $act == \"edit\") :\n?>\n\n        <form method=\"post\" name=\"iform\" id=\"iform\">\n          <input type=\"hidden\" name=\"id\" id=\"id\" value=\"<?=isset($id) ? $id :\"\";?>\"/>\n          <input type=\"hidden\" name=\"act\" id=\"action\" value=\"<?=$act;?>\"/>\n          <table class=\"table table-striped opnsense_standard_table_form\">\n            <tr>\n              <td style=\"width:22%\"></td>\n              <td style=\"width:78%; text-align:right\">\n                <small><?=gettext(\"full help\"); ?> </small>\n                <i class=\"fa fa-toggle-off text-danger\"  style=\"cursor: pointer;\" id=\"show_all_help_page\"></i>\n              </td>\n            </tr>\n            <tr>\n              <td><?=gettext(\"Descriptive name\");?></td>\n              <td>\n                <input name=\"descr\" type=\"text\" id=\"descr\" size=\"20\" value=\"<?=$pconfig['descr'];?>\"/>\n              </td>\n            </tr>\n            <tr class=\"<?=isset($id) ? \"hidden\" : \"\";?>\">\n              <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Method\");?></td>\n              <td>\n                <select name='camethod' id='camethod' class=\"selectpicker\" data-style=\"btn-default\">\n                  <option value=\"existing\" <?=$pconfig['camethod'] == \"existing\" ? \"selected=\\\"selected\\\"\" : \"\";?>>\n                    <?=gettext(\"Import an existing Certificate Authority\");?>\n                  </option>\n                  <option value=\"internal\" <?=$pconfig['camethod'] == \"internal\" ? \"selected=\\\"selected\\\"\" : \"\";?>>\n                    <?=gettext(\"Create an internal Certificate Authority\");?>\n                  </option>\n                  <option value=\"intermediate\" <?=$pconfig['camethod'] == \"intermediate\" ? \"selected=\\\"selected\\\"\" : \"\";?>>\n                    <?=gettext(\"Create an intermediate Certificate Authority\");?>\n                  </option>\n                </select>\n              </td>\n            </tr>\n          </table>\n          <!-- existing ca -->\n          <table id=\"existing\" class=\"table table-striped opnsense_standard_table_form\">\n            <thead>\n              <tr>\n                <th colspan=\"2\"><?=gettext(\"Existing Certificate Authority\");?></th>\n              </tr>\n            </thead>\n            <tbody>\n              <tr>\n                <td style=\"width:22%\"><a id=\"help_for_cert\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Certificate data\");?></td>\n                <td style=\"width:78%\">\n                  <textarea name=\"cert\" cols=\"65\" rows=\"7\" id=\"cert\"><?=isset($pconfig['cert']) ? $pconfig['cert'] : \"\";?></textarea>\n                  <div class=\"hidden\" data-for=\"help_for_cert\">\n                    <?=gettext(\"Paste a certificate in X.509 PEM format here.\");?>\n                  </div>\n                </td>\n              </tr>\n              <tr>\n                <td>\n                  <a id=\"help_for_key\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Certificate Private Key\");?><br />\n                  <?=gettext(\"(optional)\");?>\n                </td>\n                <td style=\"width:78%\">\n                  <textarea name=\"key\" id=\"key\" cols=\"65\" rows=\"7\"><?= isset($pconfig['key']) ? $pconfig['key'] : \"\";?></textarea>\n                  <div class=\"hidden\" data-for=\"help_for_key\">\n                    <?=gettext(\"Paste the private key for the above certificate here. This is optional in most cases, but required if you need to generate a Certificate Revocation List (CRL).\");?>\n                  </div>\n                </td>\n              </tr>\n              <tr>\n                <td><a id=\"help_for_serial\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Serial for next certificate\");?></td>\n                <td>\n                  <input name=\"serial\" type=\"text\" id=\"serial\" size=\"20\" value=\"<?=$pconfig['serial'];?>\"/>\n                  <div class=\"hidden\" data-for=\"help_for_serial\">\n                    <?=gettext(\"Enter a decimal number to be used as the serial number for the next certificate to be created using this CA.\");?>\n                  </div>\n                </td>\n              </tr>\n              </tbody>\n            </table>\n            <!-- internal ca -->\n            <table  id=\"internal\" class=\"table table-striped opnsense_standard_table_form\">\n              <thead>\n                <tr>\n                  <th colspan=\"2\"><?=gettext(\"Internal Certificate Authority\");?></th>\n                </tr>\n              </thead>\n              <tbody>\n                <tr id='intermediate'>\n                  <td style=\"width:22%\"> <i class=\"fa fa-info-circle text-muted\"></i>  <?=gettext(\"Signing Certificate Authority\");?></td>\n                  <td style=\"width:78%\">\n                    <select name='caref' id='caref' class=\"selectpicker\" onchange='internalca_change()'>\n<?php\n                    foreach ($a_ca as $ca) :\n                        if (!$ca['prv']) {\n                            continue;\n                        }?>\n                      <option value=\"<?=$ca['refid'];?>\"<?=isset($pconfig['caref']) && isset($ca['refid']) && $pconfig['caref'] == $ca['refid'] ? \" selected=\\\"selected\\\"\" :\"\" ;?>><?=htmlspecialchars($ca['descr']);?></option>\n<?php\n                    endforeach; ?>\n                    </select>\n                  </td>\n                </tr>\n                <tr>\n                  <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Key Type\");?></td>\n                  <td style=\"width:78%\">\n                    <select name='keytype' id='keytype' class=\"selectpicker\">\n                  <option value=\"RSA\" <?=$pconfig['keytype'] == \"RSA\" ? \"selected=\\\"selected\\\"\" : \"\";?>>\n                    <?=gettext(\"RSA\");?>\n                  </option>\n                  <option value=\"Elliptic Curve\" <?=$pconfig['keytype'] == \"Elliptic Curve\" ? \"selected=\\\"selected\\\"\" : \"\";?>>\n                    <?=gettext(\"Elliptic Curve\");?>\n                  </option>\n                    </select>\n                  </td>\n                </tr>\n                <tr id='RSA'>\n                  <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Key length\");?> (<?=gettext(\"bits\");?>)</td>\n                  <td style=\"width:78%\">\n                    <select name='keylen' id='keylen' class=\"selectpicker\">\n<?php\n                        foreach ($ca_keylens as $len) :?>\n                      <option value=\"<?=$len;?>\" <?=isset($pconfig['keylen']) && $pconfig['keylen'] == $len ? \"selected=\\\"selected\\\"\" : \"\";?>><?=$len;?></option>\n<?php\n                    endforeach; ?>\n                    </select>\n                  </td>\n                </tr>\n                <tr id='blank'><td></td></tr>\n                <tr id='EC'>\n                  <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Curve\");?></td>\n                  <td style=\"width:78%\">\n                    <select name='curve' id='curve' class=\"selectpicker\">\n<?php\n                    foreach ($ca_curves as $curve) :?>\n                      <option value=\"<?=$curve;?>\" <?=isset($pconfig['curve']) && $pconfig['curve'] == $curve ? \"selected=\\\"selected\\\"\" : \"\";?>><?=$curve;?></option>\n<?php\n                    endforeach; ?>\n                    </select>\n                  </td>\n                </tr>\n                <tr>\n                  <td><a id=\"help_for_digest_alg\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Digest Algorithm\");?></td>\n                  <td>\n                    <select name='digest_alg' id='digest_alg' class=\"selectpicker\">\n<?php\n                    foreach ($openssl_digest_algs as $digest_alg) :?>\n                      <option value=\"<?=$digest_alg;?>\" <?=isset($pconfig['digest_alg']) && $pconfig['digest_alg'] == $digest_alg ? \"selected=\\\"selected\\\"\" : \"\";?>><?=strtoupper($digest_alg);?></option>\n<?php\n                    endforeach; ?>\n                    </select>\n                    <div class=\"hidden\" data-for=\"help_for_digest_alg\">\n                      <?= gettext(\"NOTE: It is recommended to use an algorithm stronger than SHA1 when possible.\") ?>\n                    </div>\n                  </td>\n                </tr>\n                <tr>\n                  <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Lifetime\");?> (<?=gettext(\"days\");?>)</td>\n                  <td>\n                    <input name=\"lifetime\" type=\"text\" id=\"lifetime\"  value=\"<?=$pconfig['lifetime'];?>\"/>\n                  </td>\n                </tr>\n                <tr>\n                  <th colspan=\"2\"><?=gettext(\"Distinguished name\");?></th>\n                </tr>\n                <tr>\n                  <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Country Code\");?> : &nbsp;</td>\n                  <td>\n                      <select name=\"dn_country\" class=\"selectpicker\">\n<?php\n                      foreach (get_country_codes() as $cc => $cn):?>\n                        <option value=\"<?=$cc;?>\" <?=$pconfig['dn_country'] == $cc ? \"selected=\\\"selected\\\"\" : \"\";?>>\n                          <?=$cc;?> (<?=$cn;?>)\n                        </option>\n<?php\n                      endforeach;?>\n                      </select>\n                  </td>\n                </tr>\n                <tr>\n                  <td><a id=\"help_for_digest_dn_state\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"State or Province\");?> : &nbsp;</td>\n                  <td>\n                    <input name=\"dn_state\" type=\"text\" size=\"40\" value=\"<?=$pconfig['dn_state'];?>\"/>\n                    <div class=\"hidden\" data-for=\"help_for_digest_dn_state\">\n                      <em><?=gettext(\"ex:\");?></em>\n                      &nbsp;\n                      <?=gettext(\"Sachsen\");?>\n                    </div>\n                  </td>\n                </tr>\n                <tr>\n                  <td><a id=\"help_for_digest_dn_city\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"City\");?> : &nbsp;</td>\n                  <td>\n                    <input name=\"dn_city\" type=\"text\" size=\"40\" value=\"<?=$pconfig['dn_city'];?>\"/>\n                    <div class=\"hidden\" data-for=\"help_for_digest_dn_city\">\n                      <em><?=gettext(\"ex:\");?></em>\n                      &nbsp;\n                      <?=gettext(\"Leipzig\");?>\n                    </div>\n                  </td>\n                </tr>\n                <tr>\n                  <td><a id=\"help_for_digest_dn_organization\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Organization\");?> : &nbsp;</td>\n                  <td>\n                    <input name=\"dn_organization\" type=\"text\" size=\"40\" value=\"<?=$pconfig['dn_organization'];?>\"/>\n                    <div class=\"hidden\" data-for=\"help_for_digest_dn_organization\">\n                      <em><?=gettext(\"ex:\");?></em>\n                      &nbsp;\n                      <?=gettext(\"My Company Inc\");?>\n                    </div>\n                  </td>\n                </tr>\n                <tr>\n                  <td><a id=\"help_for_digest_dn_email\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Email Address\");?> : &nbsp;</td>\n                  <td>\n                    <input name=\"dn_email\" type=\"text\" size=\"25\" value=\"<?=$pconfig['dn_email'];?>\"/>\n                    <div class=\"hidden\" data-for=\"help_for_digest_dn_email\">\n                      <em><?=gettext(\"ex:\");?></em>\n                      &nbsp;\n                      <?=gettext(\"admin@mycompany.com\");?>\n                    </div>\n                  </td>\n                </tr>\n                <tr>\n                  <td><a id=\"help_for_digest_dn_commonname\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Common Name\");?> : &nbsp;</td>\n                  <td>\n                    <input name=\"dn_commonname\" type=\"text\" size=\"25\" value=\"<?=$pconfig['dn_commonname'];?>\"/>\n                    <div class=\"hidden\" data-for=\"help_for_digest_dn_commonname\">\n                      <em><?=gettext(\"ex:\");?></em>\n                      &nbsp;\n                      <?=gettext(\"internal-ca\");?>\n                    </div>\n                  </td>\n                </tr>\n              </tbody>\n            </table>\n\n            <table class=\"table opnsense_standard_table_form\">\n            <tr>\n              <td style=\"width:22%\">&nbsp;</td>\n              <td style=\"width:78%\">\n                <input id=\"submit\" name=\"save\" type=\"submit\" class=\"btn btn-primary\" value=\"<?=html_safe(gettext('Save')); ?>\" />\n              </td>\n            </tr>\n          </table>\n        </form>\n\n<?php\n        else :?>\n        <form method=\"post\" name=\"iform\" id=\"iform\">\n          <input type=\"hidden\" name=\"id\" id=\"id\" value=\"<?=isset($id) ? $id :\"\";?>\"/>\n          <input type=\"hidden\" name=\"act\" id=\"action\" value=\"<?=$act;?>\"/>\n        </form>\n        <table style=\"width:100%; border:0;\" class=\"table table-striped\">\n          <thead>\n            <tr>\n              <th><?=gettext(\"Name\");?></th>\n              <th><?=gettext(\"Internal\");?></th>\n              <th><?=gettext(\"Issuer\");?></th>\n              <th><?=gettext(\"Certificates\");?></th>\n              <th><?=gettext(\"Distinguished Name\");?></th>\n              <th class=\"text-nowrap\">\n                <a href=\"system_camanager.php?act=new\" class=\"btn btn-primary btn-xs\" data-toggle=\"tooltip\" title=\"<?= html_safe(gettext('Add')) ?>\">\n                  <i class=\"fa fa-plus fa-fw\"></i>\n                </a>\n              </th>\n            </tr>\n          </thead>\n          <tbody>\n<?php\n          $i = 0;\n          foreach ($a_ca as $ca) :\n              $issuer = htmlspecialchars(cert_get_issuer($ca['crt']));\n              $subj = htmlspecialchars(cert_get_subject($ca['crt']));\n              list($startdate, $enddate) = cert_get_dates($ca['crt']);\n              if ($subj == $issuer) {\n                  $issuer_name = \"<em>\" . gettext(\"self-signed\") . \"</em>\";\n              } else {\n                  $issuer_name = \"<em>\" . gettext(\"external\") . \"</em>\";\n              }\n\n              if (isset($ca['caref'])) {\n                  $issuer_ca = lookup_ca($ca['caref']);\n                  if ($issuer_ca) {\n                      $issuer_name = $issuer_ca['descr'];\n                  }\n              }\n\n              $certcount = 0;\n\n              foreach ($a_cert as $cert) {\n                  if ($cert['caref'] == $ca['refid']) {\n                      $certcount++;\n                  }\n              }\n\n              foreach ($a_ca as $cert) {\n                  if (isset($cert['caref'])) {\n                      if ($cert['caref'] == $ca['refid']) {\n                          $certcount++;\n                      }\n                  }\n              }\n?>\n            <tr>\n              <td><?=htmlspecialchars($ca['descr']);?></td>\n              <td><?=!empty($ca['prv']) ? gettext(\"YES\") : gettext(\"NO\");?>&nbsp;</td>\n              <td><?=$issuer_name;?>&nbsp;</td>\n              <td><?=$certcount;?>&nbsp;</td>\n              <td><?=$subj;?><br />\n                  <table style=\"width:100%; font-size: 9px\">\n                    <tr>\n                      <td>&nbsp;</td>\n                      <td style=\"width:20%\"><?=gettext(\"Valid From\")?>:</td>\n                      <td style=\"width:70%\"><?= $startdate ?></td>\n                    </tr>\n                    <tr>\n                      <td>&nbsp;</td>\n                      <td><?=gettext(\"Valid Until\")?>:</td>\n                      <td><?= $enddate ?></td>\n                    </tr>\n                  </table>\n                </td>\n                <td class=\"text-nowrap\">\n                  <a href=\"system_camanager.php?act=edit&amp;id=<?=$i;?>\" data-toggle=\"tooltip\" title=\"<?=gettext(\"edit CA\");?>\" class=\"btn btn-default btn-xs\">\n                    <i class=\"fa fa-pencil fa-fw\"></i>\n                  </a>\n                  <a href=\"system_camanager.php?act=exp&amp;id=<?=$i;?>\" data-toggle=\"tooltip\" title=\"<?=gettext(\"export CA cert\");?>\" class=\"btn btn-default btn-xs\">\n                    <i class=\"fa fa-download fa-fw\"></i>\n                  </a>\n<?php\n                  if ($ca['prv']) :?>\n                  <a href=\"system_camanager.php?act=expkey&amp;id=<?=$i;?>\" data-toggle=\"tooltip\" title=\"<?=gettext(\"export CA private key\");?>\" class=\"btn btn-default btn-xs\">\n                    <i class=\"fa fa-download fa-fw\"></i>\n                  </a>\n<?php\n                  endif; ?>\n                  <a id=\"del_<?=$i;?>\" data-id=\"<?=$i;?>\" title=\"<?=gettext(\"delete ca\"); ?>\" data-toggle=\"tooltip\"  class=\"act_delete btn btn-default btn-xs\">\n                    <i class=\"fa fa-trash fa-fw\"></i>\n                  </a>\n                </td>\n              </tr>\n<?php\n              $i++;\n              endforeach;?>\n            </tbody>\n          </table>\n<?php\n          endif; ?>\n        </div>\n      </section>\n    </div>\n  </div>\n</section>\n<?php include(\"foot.inc\");\n", "<?php\n\n/*\n * Copyright (C) 2014-2015 Deciso B.V.\n * Copyright (C) 2008 Shrew Soft Inc. <mgrooms@shrew.net>\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without\n * modification, are permitted provided that the following conditions are met:\n *\n * 1. Redistributions of source code must retain the above copyright notice,\n *    this list of conditions and the following disclaimer.\n *\n * 2. Redistributions in binary form must reproduce the above copyright\n *    notice, this list of conditions and the following disclaimer in the\n *    documentation and/or other materials provided with the distribution.\n *\n * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES,\n * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY\n * AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE\n * AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY,\n * OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF\n * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS\n * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN\n * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n * POSSIBILITY OF SUCH DAMAGE.\n */\n\nrequire_once('guiconfig.inc');\nrequire_once('system.inc');\n\nphpseclib_autoload('ParagonIE\\ConstantTime', '/usr/local/share/phpseclib/paragonie');\nphpseclib_autoload('phpseclib3', '/usr/local/share/phpseclib');\n\nuse phpseclib3\\File\\ASN1;\nuse phpseclib3\\File\\X509;\n\nfunction csr_generate(&$cert, $keylen_curve, $dn, $digest_alg, $extns)\n{\n    $configFilename = create_temp_openssl_config($extns);\n    $args = [\n        'config' => $configFilename,\n        'req_extensions' => 'v3_req',\n        'digest_alg' => $digest_alg,\n        'encrypt_key' => false\n    ];\n\n    if (is_numeric($keylen_curve)) {\n        $args['private_key_type'] = OPENSSL_KEYTYPE_RSA;\n        $args['private_key_bits'] = (int)$keylen_curve;\n    } else {\n        $args['private_key_type'] = OPENSSL_KEYTYPE_EC;\n        $args['curve_name'] = $keylen_curve;\n    }\n\n    // generate a new key pair\n    $res_key = openssl_pkey_new($args);\n    if (!$res_key) {\n        return false;\n    }\n\n    // generate a certificate signing request\n    $res_csr = openssl_csr_new($dn, $res_key, $args);\n    if (!$res_csr) {\n        return false;\n    }\n\n    // export our request data\n    if (!openssl_pkey_export($res_key, $str_key) ||\n        !openssl_csr_export($res_csr, $str_csr)) {\n        return false;\n    }\n\n    // return our request information\n    $cert['csr'] = base64_encode($str_csr);\n    $cert['prv'] = base64_encode($str_key);\n\n    unlink($configFilename);\n\n    return true;\n}\n\nfunction csr_complete(& $cert, $str_crt)\n{\n    // return our request information\n    $cert['crt'] = base64_encode($str_crt);\n    unset($cert['csr']);\n\n    return true;\n}\n\nfunction csr_get_modulus($str_crt, $decode = true)\n{\n    return cert_get_modulus($str_crt, $decode, 'csr');\n}\n\nfunction parse_csr($csr_str)\n{\n    $ret = array();\n    $ret['parse_success'] = true;\n    $ret['subject'] = openssl_csr_get_subject($csr_str);\n    if ($ret['subject'] === false) {\n        return array('parse_success' => false);\n    }\n\n    $x509_lib = new X509();\n    $csr = $x509_lib->loadCSR($csr_str);\n    if ($csr === false) {\n        return array('parse_success' => false);\n    }\n\n    foreach ($csr['certificationRequestInfo']['attributes'] as $attr) {\n        switch ($attr['type'] ) {\n            case 'pkcs-9-at-extensionRequest':\n                foreach ($attr['value'] as $value) {\n                    foreach ($value as $column) {\n                        switch ($column['extnId']) {\n                            case 'id-ce-basicConstraints':\n                                $ret['basicConstraints'] = array();\n                                $ret['basicConstraints']['CA'] = $column['extnValue']['cA'];\n                                if (isset($column['extnValue']['pathLenConstraint'])) {\n                                    $ret['basicConstraints']['pathlen'] = (int)($column['extnValue']['pathLenConstraint']->toString());\n                                }\n\n                                break;\n\n                            case 'id-ce-keyUsage':\n                                $ret['keyUsage'] = $column['extnValue'];\n                                break;\n\n                            case 'id-ce-extKeyUsage':\n                                $ret['extendedKeyUsage'] = array();\n                                foreach ($column['extnValue'] as $usage) {\n                                    array_push($ret['extendedKeyUsage'], strpos($usage, 'id-kp-') === 0 ? ASN1::getOID($usage) : $usage);\n                                }\n                                break;\n\n                            case 'id-ce-subjectAltName':\n                                $ret['subjectAltName'] = array();\n                                foreach ($column['extnValue'] as $item) {\n                                    if (isset($item['dNSName'])) {\n                                        array_push($ret['subjectAltName'], array('type'=> 'DNS', 'value'=> $item['dNSName']));\n                                    }\n                                    if (isset($item['iPAddress'])) {\n                                        array_push($ret['subjectAltName'], array('type'=> 'IP', 'value'=> $item['iPAddress']));\n                                    }\n                                    if (isset($item['rfc822Name'])) {\n                                        array_push($ret['subjectAltName'], array('type'=> 'email', 'value'=> $item['rfc822Name']));\n                                    }\n                                    if (isset($item['uniformResourceIdentifier'])) {\n                                        array_push($ret['subjectAltName'], array('type'=> 'URI', 'value'=> $item['uniformResourceIdentifier']));\n                                    }\n                                }\n                                break;\n\n                        }\n                    }\n                }\n                break; // case 'pkcs-9-at-extensionRequest'\n        }\n    }\n\n    return $ret;\n}\n\n// altname expects a type like the following:\n// array (\n//    'type'   => (string),\n//    'value': => (string)\n// )\n//\n// errors are added to $input_errors\n// returns true:  on success\n//         false: on error, with adding something to $input_errors.\nfunction is_valid_alt_value($altname, &$input_errors) {\n    switch ($altname['type']) {\n        case \"DNS\":\n            $dns_regex = '/^(?:(?:[a-z0-9_\\*]|[a-z0-9_][a-z0-9_\\-]*[a-z0-9_])\\.)*(?:[a-z0-9_]|[a-z0-9_][a-z0-9_\\-]*[a-z0-9_])$/i';\n            if (!preg_match($dns_regex, $altname['value'])) {\n                $input_errors[] = gettext(\"DNS subjectAltName values must be valid hostnames or FQDNs\");\n                return false;\n            }\n            return true;\n        case \"IP\":\n            if (!is_ipaddr($altname['value'])) {\n                $input_errors[] = gettext(\"IP subjectAltName values must be valid IP Addresses\");\n                return false;\n            }\n            return true;\n        case \"email\":\n            if (empty($altname['value'])) {\n                $input_errors[] = gettext(\"You must provide an email address for this type of subjectAltName\");\n                return false;\n            }\n            if (preg_match(\"/[\\!\\#\\$\\%\\^\\(\\)\\~\\?\\>\\<\\&\\/\\\\\\,\\\"\\']/\", $altname['value'])) {\n                $input_errors[] = gettext(\"The email provided in a subjectAltName contains invalid characters.\");\n                return false;\n            }\n            return true;\n        case \"URI\":\n            if (!is_URL($altname['value'])) {\n                $input_errors[] = gettext(\"URI subjectAltName types must be a valid URI\");\n                return false;\n            }\n            return true;\n        default:\n            $input_errors[] = gettext(\"Unrecognized subjectAltName type.\");\n            return false;\n    }\n\n}\n// types\n$cert_methods = array(\n    \"import\" => gettext(\"Import an existing Certificate\"),\n    \"internal\" => gettext(\"Create an internal Certificate\"),\n    \"external\" => gettext(\"Create a Certificate Signing Request\"),\n    \"sign_cert_csr\" => gettext(\"Sign a Certificate Signing Request\"),\n);\n$cert_keylens = array( \"512\", \"1024\", \"2048\", \"3072\", \"4096\", \"8192\");\n$cert_curves = array( \"prime256v1\", \"secp384r1\", \"secp521r1\");\n$openssl_digest_algs = array(\"sha1\", \"sha224\", \"sha256\", \"sha384\", \"sha512\");\n$cert_types = array('usr_cert', 'server_cert', 'combined_server_client', 'v3_ca');\n$key_usages = array(\n    // defined in RFC 5280 section 4.2.1.3\n    'digitalSignature' => gettext('digitalSignature'),\n    'nonRepudiation'   => gettext('nonRepudiation'),\n    'keyEncipherment'  => gettext('keyEncipherment'),\n    'dataEncipherment' => gettext('dataEncipherment'),\n    'keyAgreement'     => gettext('keyAgreement'),\n    'keyCertSign'      => gettext('keyCertSign'),\n    'cRLSign'          => gettext('cRLSign'),\n    'encipherOnly'     => gettext('encipherOnly'),\n    'decipherOnly'     => gettext('decipherOnly'),\n);\n$extended_key_usages = array(\n    // defined in RFC 5280 section 4.2.1.12\n    '1.3.6.1.5.5.7.3.1'  => gettext('serverAuth'),\n    '1.3.6.1.5.5.7.3.2'  => gettext('clientAuth'),\n    '1.3.6.1.5.5.7.3.3'  => gettext('codeSigning'),\n    '1.3.6.1.5.5.7.3.4'  => gettext('emailProtection'),\n    '1.3.6.1.5.5.7.3.8'  => gettext('timeStamping'),\n    '1.3.6.1.5.5.7.3.9'  => gettext('OCSPSigning'),\n\n    // added to support default options\n    '1.3.6.1.5.5.8.2.2'  => gettext('iKEIntermediate'),\n);\n\n// config reference pointers\n$a_user = &config_read_array('system', 'user');\n$a_ca = &config_read_array('ca');\n$a_cert = &config_read_array('cert');\n\n\n// handle user GET/POST data\nif ($_SERVER['REQUEST_METHOD'] === 'GET') {\n    if (isset($a_user[$_GET['userid']])) {\n        $userid = $_GET['userid'];\n        $cert_methods[\"existing\"] = gettext(\"Choose an existing certificate\");\n    }\n    if (isset($a_cert[$_GET['id']])) {\n        $id = $_GET['id'];\n    }\n\n    $act = isset($_GET['act']) ? $_GET['act'] : null;\n\n    $pconfig = array();\n    if ($act == \"new\") {\n        if (isset($_GET['method'])) {\n            $pconfig['certmethod'] = $_GET['method'];\n        } else {\n            $pconfig['certmethod'] = null;\n        }\n        if (isset($_GET['caref'])) {\n            $pconfig['caref'] = $_GET['caref'];\n        }\n        $pconfig['keytype'] = \"RSA\";\n        $pconfig['keylen'] = \"2048\";\n        $pconfig['digest_alg'] = \"sha256\";\n        $pconfig['digest_alg_sign_csr'] = \"sha256\";\n        $pconfig['csr_keytype'] = \"RSA\";\n        $pconfig['csr_keylen'] = \"2048\";\n        $pconfig['csr_digest_alg'] = \"sha256\";\n        $pconfig['lifetime'] = \"397\";\n        $pconfig['lifetime_sign_csr'] = \"397\";\n        $pconfig['cert_type'] = \"usr_cert\";\n        $pconfig['cert'] = null;\n        $pconfig['key'] = null;\n        $pconfig['dn_country'] = null;\n        $pconfig['dn_state'] = null;\n        $pconfig['dn_city'] = null;\n        $pconfig['dn_organization'] = null;\n        $pconfig['dn_email'] = null;\n\n        if (isset($userid)) {\n            $pconfig['descr'] = $a_user[$userid]['name'];\n            $pconfig['dn_commonname'] = $a_user[$userid]['name'];\n        } else {\n            $pconfig['descr'] = null;\n            $pconfig['dn_commonname'] = null;\n        }\n\n    } elseif ($act == \"exp\") {\n        // export cert\n        if (isset($id)) {\n            $exp_name = urlencode(\"{$a_cert[$id]['descr']}.crt\");\n            $exp_data = base64_decode($a_cert[$id]['crt']);\n            $exp_size = strlen($exp_data);\n\n            header(\"Content-Type: application/octet-stream\");\n            header(\"Content-Disposition: attachment; filename={$exp_name}\");\n            header(\"Content-Length: $exp_size\");\n            echo $exp_data;\n        }\n        exit;\n    } elseif ($act == \"key\") {\n        // export key\n        if (isset($id)) {\n            $exp_name = urlencode(\"{$a_cert[$id]['descr']}.key\");\n            $exp_data = base64_decode($a_cert[$id]['prv']);\n            $exp_size = strlen($exp_data);\n\n            header(\"Content-Type: application/octet-stream\");\n            header(\"Content-Disposition: attachment; filename={$exp_name}\");\n            header(\"Content-Length: $exp_size\");\n            echo $exp_data;\n        }\n        exit;\n    } elseif ($act == \"csr\") {\n        if (!isset($id)) {\n            header(url_safe('Location: /system_certmanager.php'));\n            exit;\n        }\n        $pconfig['descr'] = $a_cert[$id]['descr'];\n        $pconfig['csr'] = base64_decode($a_cert[$id]['csr']);\n        $pconfig['cert'] = null;\n    } elseif ($act == \"info\") {\n      if (isset($id)) {\n          header(\"Content-Type: text/plain;charset=UTF-8\");\n          // use openssl to dump cert in readable format\n          $process = proc_open('/usr/local/bin/openssl x509 -fingerprint -sha256 -text', array(array(\"pipe\", \"r\"), array(\"pipe\", \"w\")), $pipes);\n          if (is_resource($process)) {\n             fwrite($pipes[0], base64_decode($a_cert[$id]['crt']));\n             fclose($pipes[0]);\n\n             $result = stream_get_contents($pipes[1]);\n             fclose($pipes[1]);\n             proc_close($process);\n             echo $result;\n          }\n      }\n      exit;\n    }\n\n} elseif ($_SERVER['REQUEST_METHOD'] === 'POST') {\n    $pconfig = $_POST;\n    if (isset($a_cert[$_POST['id']])) {\n        $id = $_POST['id'];\n    }\n    if (isset($a_user[$_POST['userid']])) {\n        $userid = $_POST['userid'];\n    }\n    $act = isset($_POST['act']) ? $_POST['act'] : null;\n\n    if ($act == \"del\") {\n        if (isset($id)) {\n            unset($a_cert[$id]);\n            write_config();\n        }\n        header(url_safe('Location: /system_certmanager.php'));\n        exit;\n    } elseif ($act == 'csr_info') {\n      if (!isset($pconfig['csr'])) {\n        http_response_code(400);\n        header(\"Content-Type: text/plain;charset=UTF-8\");\n        echo gettext('Invalid request');\n        exit;\n      }\n\n      header(\"Content-Type: text/plain;charset=UTF-8\");\n      // use openssl to dump csr in readable format\n      $process = proc_open('/usr/local/bin/openssl req -text -noout', array(array(\"pipe\", \"r\"), array(\"pipe\", \"w\"), array(\"pipe\", \"w\")), $pipes);\n      if (is_resource($process)) {\n        fwrite($pipes[0], $pconfig['csr']);\n        fclose($pipes[0]);\n\n        $result_stdout = stream_get_contents($pipes[1]);\n        fclose($pipes[1]);\n\n        $result_stderr = stream_get_contents($pipes[2]);\n        fclose($pipes[2]);\n\n        proc_close($process);\n\n        echo $result_stdout;\n        echo $result_stderr;\n      }\n      exit;\n    } elseif ($act == 'csr_info_json') {\n      header(\"Content-Type: application/json;charset=UTF-8\");\n\n      if (!isset($pconfig['csr'])) {\n        http_response_code(400);\n        echo json_encode(array(\n          'error' => gettext('Invalid Request'),\n          'error_detail' => gettext('No csr parameter in query')\n        ));\n        exit;\n      }\n\n      $parsed_result = parse_csr($pconfig['csr']);\n\n      if ($parsed_result['parse_success'] !== true) {\n        http_response_code(400);\n        echo json_encode(array(\n          'error' => gettext('CSR file is invalid'),\n          'error_detail' => gettext('Could not parse CSR file.')\n        ));\n        exit;\n      }\n\n      echo json_encode($parsed_result);\n      exit;\n    } elseif ($act == \"p12\") {\n        // export cert+key in p12 format\n        if (isset($id)) {\n            $exp_name = urlencode(\"{$a_cert[$id]['descr']}.p12\");\n            $args = array();\n            $args['friendly_name'] = $a_cert[$id]['descr'];\n\n            $ca = lookup_ca($a_cert[$id]['caref']);\n            if ($ca) {\n                $args['extracerts'] = openssl_x509_read(base64_decode($ca['crt']));\n            }\n            set_error_handler (\n                function () {\n                    return;\n                }\n            );\n\n            $exp_data = '';\n            $res_crt = openssl_x509_read(base64_decode($a_cert[$id]['crt']));\n            $res_key = openssl_pkey_get_private(array(0 => base64_decode($a_cert[$id]['prv']) , 1 => ''));\n            $res_pw = !empty($pconfig['password']) ? $pconfig['password'] : null;\n            openssl_pkcs12_export($res_crt, $exp_data, $res_key, $res_pw, $args);\n            restore_error_handler();\n\n            $output = json_encode(array(\n              'filename' => $exp_name,\n              'content' => base64_encode($exp_data)\n            ));\n            header(\"Content-Type: application/json;charset=UTF-8\");\n            // header(\"Content-Length: \". strlen($output));\n            echo $output;\n        }\n        exit;\n    } elseif ($act == \"csr\") {\n        $input_errors = array();\n        $pconfig = $_POST;\n        if (!isset($id)) {\n            header(url_safe('Location: /system_certmanager.php'));\n            exit;\n        }\n\n        /* input validation */\n        $reqdfields = explode(\" \", \"descr cert\");\n        $reqdfieldsn = array(\n            gettext(\"Descriptive name\"),\n            gettext(\"Final Certificate data\"));\n\n        do_input_validation($_POST, $reqdfields, $reqdfieldsn, $input_errors);\n        $mod_csr  =  csr_get_modulus($pconfig['csr'], false);\n        $mod_cert = cert_get_modulus($pconfig['cert'], false);\n\n        if (strcmp($mod_csr, $mod_cert)) {\n            // simply: if the moduli don't match, then the private key and public key won't match\n            $input_errors[] = gettext(\"The certificate modulus does not match the signing request modulus.\");\n            $subject_mismatch = true;\n        }\n\n        /* save modifications */\n        if (count($input_errors) == 0) {\n            $cert = $a_cert[$id];\n            csr_complete($cert, $pconfig['cert']);\n\n            $a_cert[$id] = $cert;\n\n            write_config();\n\n            header(url_safe('Location: /system_certmanager.php'));\n            exit;\n        }\n    } elseif (!empty($_POST['save'])) {\n        $input_errors = array();\n        $act = isset($_GET['act']) ? $_GET['act'] : null;\n\n        /* input validation */\n        if ($pconfig['certmethod'] == \"import\") {\n            $reqdfields = explode(\" \", \"descr cert key\");\n            $reqdfieldsn = array(\n                    gettext(\"Descriptive name\"),\n                    gettext(\"Certificate data\"),\n                    gettext(\"Key data\"));\n            if (!empty($pconfig['cert']) && (!strstr($pconfig['cert'], \"BEGIN CERTIFICATE\") || !strstr($pconfig['cert'], \"END CERTIFICATE\"))) {\n                $input_errors[] = gettext(\"This certificate does not appear to be valid.\");\n            }\n        } elseif ($pconfig['certmethod'] == \"internal\") {\n            $reqdfields = explode(\" \", \"descr caref keytype keylen curve digest_alg lifetime dn_country dn_state dn_city \".\n                \"dn_organization dn_email dn_commonname\"\n            );\n            $reqdfieldsn = array(\n                    gettext(\"Descriptive name\"),\n                    gettext(\"Certificate authority\"),\n                    gettext(\"Key type\"),\n                    gettext(\"Key length\"),\n                    gettext(\"Curve\"),\n                    gettext(\"Digest algorithm\"),\n                    gettext(\"Lifetime\"),\n                    gettext(\"Distinguished name Country Code\"),\n                    gettext(\"Distinguished name State or Province\"),\n                    gettext(\"Distinguished name City\"),\n                    gettext(\"Distinguished name Organization\"),\n                    gettext(\"Distinguished name Email Address\"),\n                    gettext(\"Distinguished name Common Name\"));\n        } elseif ($pconfig['certmethod'] == \"external\") {\n            $reqdfields = explode(\" \", \"descr csr_keytype csr_keylen csr_curve csr_digest_alg csr_dn_country csr_dn_state csr_dn_city \".\n                \"csr_dn_organization csr_dn_email csr_dn_commonname\"\n            );\n            $reqdfieldsn = array(\n                    gettext(\"Descriptive name\"),\n                    gettext(\"Key type\"),\n                    gettext(\"Key length\"),\n                    gettext(\"Curve\"),\n                    gettext(\"Digest algorithm\"),\n                    gettext(\"Distinguished name Country Code\"),\n                    gettext(\"Distinguished name State or Province\"),\n                    gettext(\"Distinguished name City\"),\n                    gettext(\"Distinguished name Organization\"),\n                    gettext(\"Distinguished name Email Address\"),\n                    gettext(\"Distinguished name Common Name\"));\n        } elseif ($pconfig['certmethod'] == \"existing\") {\n            $reqdfields = array(\"certref\");\n            $reqdfieldsn = array(gettext(\"Existing Certificate Choice\"));\n        } elseif ($pconfig['certmethod'] == 'sign_cert_csr') {\n            $reqdfields = array('caref_sign_csr', 'csr', 'lifetime_sign_csr', 'digest_alg_sign_csr');\n            $reqdfieldsn = array(gettext(\"Certificate authority\"), gettext(\"CSR file\"), gettext(\"Lifetime\"), gettext(\"Digest Algorithm\"));\n        }\n\n        $altnames = array();\n        do_input_validation($pconfig, $reqdfields, $reqdfieldsn, $input_errors);\n        if (isset($pconfig['altname_value']) && $pconfig['certmethod'] != \"import\" && $pconfig['certmethod'] != \"existing\" && $pconfig['certmethod'] != 'sign_cert_csr') {\n            /* subjectAltNames */\n            foreach ($pconfig['altname_type'] as $altname_seq => $altname_type) {\n                if (!empty($pconfig['altname_value'][$altname_seq])) {\n                    $altnames[] = array(\"type\" => $altname_type, \"value\" => $pconfig['altname_value'][$altname_seq]);\n                }\n            }\n\n            /* Input validation for subjectAltNames */\n            foreach ($altnames as $altname) {\n                if (! is_valid_alt_value($altname, $input_errors)) {\n                    break;\n                }\n            }\n\n            /* Make sure we do not have invalid characters in the fields for the certificate */\n            for ($i = 0; $i < count($reqdfields); $i++) {\n                if (preg_match('/email/', $reqdfields[$i])) {\n                    /* dn_email or csr_dn_name */\n                    if (preg_match(\"/[\\!\\#\\$\\%\\^\\(\\)\\~\\?\\>\\<\\&\\/\\\\\\,\\\"\\']/\", $pconfig[$reqdfields[$i]])) {\n                        $input_errors[] = gettext(\"The field 'Distinguished name Email Address' contains invalid characters.\");\n                    }\n                } elseif (preg_match('/commonname/', $reqdfields[$i])) {\n                    /* dn_commonname or csr_dn_commonname */\n                    if (preg_match(\"/[\\!\\@\\#\\$\\%\\^\\(\\)\\~\\?\\>\\<\\&\\/\\\\\\,\\\"\\']/\", $pconfig[$reqdfields[$i]])) {\n                        $input_errors[] = gettext(\"The field 'Distinguished name Common Name' contains invalid characters.\");\n                    }\n                } elseif ($reqdfields[$i] == \"csr_dn_organization\" || $reqdfields[$i] == \"dn_organization\") {\n                    if (preg_match(\"/[\\!\\#\\$\\%\\^\\(\\)\\~\\?\\>\\<\\&\\/\\\\\\\"\\']/\", $pconfig[$reqdfields[$i]])) {\n                        $input_errors[] = sprintf(gettext(\"The field '%s' contains invalid characters.\"), $reqdfieldsn[$i]);\n                    }\n                } elseif ($reqdfields[$i] != \"descr\" && $reqdfields[$i] != \"csr\" && preg_match(\"/[\\!\\@\\#\\$\\%\\^\\(\\)\\~\\?\\>\\<\\&\\/\\\\\\,\\\"\\']/\", $pconfig[$reqdfields[$i]])) {\n                    $input_errors[] = sprintf(gettext(\"The field '%s' contains invalid characters.\"), $reqdfieldsn[$i]);\n                }\n            }\n\n            if ($pconfig['certmethod'] != \"external\" && !in_array($pconfig[\"keytype\"], array(\"RSA\", \"Elliptic Curve\"))) {\n                $input_errors[] = gettext(\"Please select a valid Key Type.\");\n            }\n            if ($pconfig['certmethod'] == \"internal\" && !in_array($pconfig[\"cert_type\"], $cert_types)) {\n                $input_errors[] = gettext(\"Please select a valid Type.\");\n            }\n            if ($pconfig['certmethod'] != \"external\" && isset($pconfig[\"keylen\"]) && $pconfig[\"keytype\"] == \"RSA\" && !in_array($pconfig[\"keylen\"], $cert_keylens)) {\n                $input_errors[] = gettext(\"Please select a valid Key Length.\");\n            }\n            if ($pconfig['certmethod'] != \"external\" && isset($pconfig[\"curve\"]) && $pconfig[\"keytype\"] == \"Elliptic Curve\" && !in_array($pconfig[\"curve\"], $cert_curves)) {\n                $input_errors[] = gettext(\"Please select a valid Curve.\");\n            }\n            if ($pconfig['certmethod'] != \"external\" && !in_array($pconfig[\"digest_alg\"], $openssl_digest_algs)) {\n                $input_errors[] = gettext(\"Please select a valid Digest Algorithm.\");\n            }\n            if ($pconfig['certmethod'] == \"external\" && !in_array($pconfig[\"keytype\"], array(\"RSA\", \"Elliptic Curve\"))) {\n                $input_errors[] = gettext(\"Please select a valid Key Type.\");\n            }\n            if ($pconfig['certmethod'] == \"external\" && isset($pconfig[\"csr_keylen\"]) && $pconfig[\"keytype\"] == \"RSA\" && !in_array($pconfig[\"csr_keylen\"], $cert_keylens)) {\n                $input_errors[] = gettext(\"Please select a valid Key Length.\");\n            }\n            if ($pconfig['certmethod'] == \"external\" && isset($pconfig[\"csr_curve\"]) && $pconfig[\"keytype\"] == \"Elliptic Curve\" && !in_array($pconfig[\"csr_curve\"], $cert_curves)) {\n                $input_errors[] = gettext(\"Please select a valid Curve.\");\n            }\n            if ($pconfig['certmethod'] == \"external\" && !in_array($pconfig[\"csr_digest_alg\"], $openssl_digest_algs)) {\n                $input_errors[] = gettext(\"Please select a valid Digest Algorithm.\");\n            }\n            if ($pconfig['certmethod'] == \"sign_cert_csr\" && !in_array($pconfig[\"digest_alg_sign_csr\"], $openssl_digest_algs)) {\n                $input_errors[] = gettext(\"Please select a valid Digest Algorithm.\");\n            }\n        }\n\n        // validation and at the same time create $dn for sign_cert_csr\n        if ($pconfig['certmethod'] === 'sign_cert_csr') {\n            // XXX: we should separate validation and data gathering\n            $extns = array();\n            if (isset($pconfig['key_usage_sign_csr'])) {\n                $san_str = '';\n                if (!empty($pconfig['altname_type_sign_csr'])) {\n                    for ($i = 0; $i < count($pconfig['altname_type_sign_csr']); ++$i) {\n                        if ($pconfig['altname_value_sign_csr'][$i] === '') {\n                            continue;\n                        }\n                        if (! is_valid_alt_value(array(\n                            'type' => $pconfig['altname_type_sign_csr'][$i],\n                            'value' => $pconfig['altname_value_sign_csr'][$i]), $input_errors\n                        )) {\n                            break;\n                        }\n                        if ($san_str !== '') {\n                            $san_str .= ', ';\n                        }\n                        $san_str .= $pconfig['altname_type_sign_csr'][$i] . ':' . $pconfig['altname_value_sign_csr'][$i];\n                    }\n                }\n                if ($san_str !== '') {\n                    $extns['subjectAltName'] = $san_str;\n                }\n                if (is_array($pconfig['key_usage_sign_csr']) && count($pconfig['key_usage_sign_csr']) > 0) {\n                    $resstr = '';\n                    foreach ($pconfig['key_usage_sign_csr'] as $item) {\n                        if (array_key_exists($item, $key_usages)) {\n                            if ($resstr !== '') {\n                                $resstr .= ', ';\n                            }\n                            $resstr .= $item;\n                        } else {\n                            $input_errors[] = gettext(\"Please select a valid keyUsage.\");\n                            break;\n                        }\n                    }\n                    $extns['keyUsage'] = $resstr;\n                }\n                if (is_array($pconfig['extended_key_usage_sign_csr']) && count($pconfig['extended_key_usage_sign_csr']) > 0) {\n                    $resstr = '';\n                    foreach ($pconfig['extended_key_usage_sign_csr'] as $item) {\n                        if (array_key_exists($item, $extended_key_usages)) {\n                            if ($resstr !== '') {\n                                $resstr .= ', ';\n                            }\n                            $resstr .= $item;\n                        } else {\n                            $input_errors[] = gettext(\"Please select a valid extendedKeyUsage.\");\n                            break;\n                        }\n                    }\n                    $extns['extendedKeyUsage'] = $resstr;\n                }\n                if ($pconfig['basic_constraints_is_ca_sign_csr'] === 'true') {\n                    $extns['basicConstraints'] = 'CA:' . ((isset($pconfig['basic_constraints_is_ca_sign_csr']) && $pconfig['basic_constraints_is_ca_sign_csr'] === 'true') ? 'TRUE' : 'false');\n                    if (isset($pconfig['basic_constraints_path_len_sign_csr']) && $pconfig['basic_constraints_path_len_sign_csr'] != '') {\n                        $extns['basicConstraints'] .= ', pathlen:' . ((int) $pconfig['basic_constraints_path_len_sign_csr']);\n                    }\n                }\n            }\n        }\n\n        /* save modifications */\n        if (count($input_errors) == 0) {\n            if ($pconfig['certmethod'] == \"existing\") {\n                $cert = lookup_cert($pconfig['certref']);\n                if ($cert && !empty($userid)) {\n                    $a_user[$userid]['cert'][] = $cert['refid'];\n                }\n            } else {\n                $cert = array();\n                $cert['refid'] = uniqid();\n                if (isset($id) && $a_cert[$id]) {\n                    $cert = $a_cert[$id];\n                }\n\n                $cert['descr'] = $pconfig['descr'];\n\n                $old_err_level = error_reporting(0); /* otherwise openssl_ functions throw warnings directly to a page screwing menu tab */\n                if ($pconfig['keytype'] == \"Elliptic Curve\") {\n                    $pconfig['keylen_curve'] = $pconfig['curve'];\n                } else {\n                    $pconfig['keylen_curve'] = $pconfig['keylen'];\n                }\n                if ($pconfig['csr_keytype'] == \"Elliptic Curve\") {\n                    $pconfig['csr_keylen_curve'] = $pconfig['csr_curve'];\n                } else {\n                    $pconfig['csr_keylen_curve'] = $pconfig['csr_keylen'];\n                }\n                if ($pconfig['certmethod'] == \"import\") {\n                    cert_import($cert, $pconfig['cert'], $pconfig['key']);\n                } elseif ($pconfig['certmethod'] == \"internal\") {\n                    $dn = array(\n                        'countryName' => $pconfig['dn_country'],\n                        'stateOrProvinceName' => $pconfig['dn_state'],\n                        'localityName' => $pconfig['dn_city'],\n                        'organizationName' => $pconfig['dn_organization'],\n                        'emailAddress' => $pconfig['dn_email'],\n                        'commonName' => $pconfig['dn_commonname']);\n                    $extns = array();\n                    if (count($altnames)) {\n                        $altnames_tmp = array();\n                        foreach ($altnames as $altname) {\n                            $altnames_tmp[] = \"{$altname['type']}:{$altname['value']}\";\n                        }\n                        $extns['subjectAltName'] = implode(\",\", $altnames_tmp);\n                    }\n\n                    if (!cert_create(\n                        $cert,\n                        $pconfig['caref'],\n                        $pconfig['keylen_curve'],\n                        $pconfig['lifetime'],\n                        $dn,\n                        $pconfig['digest_alg'],\n                        $pconfig['cert_type'],\n                        $extns\n                    )) {\n                        $input_errors = array();\n                        while ($ssl_err = openssl_error_string()) {\n                            $input_errors[] = gettext(\"openssl library returns:\") . \" \" . $ssl_err;\n                        }\n                    }\n                    if ($pconfig['private_key_location'] === 'local') {\n                        // unset private key before safe\n                        $act = 'download_private_key';\n                        $pconfig['private_key'] = base64_decode($cert['prv']);\n                        unset($cert['prv']);\n                    }\n                } elseif ($pconfig['certmethod'] === 'sign_cert_csr') {\n                    if (!sign_cert_csr($cert, $pconfig['caref_sign_csr'], $pconfig['csr'], (int) $pconfig['lifetime_sign_csr'],\n                                       $pconfig['digest_alg_sign_csr'], $extns)) {\n                        $input_errors = array();\n                        while ($ssl_err = openssl_error_string()) {\n                            $input_errors[] = gettext(\"openssl library returns:\") . \" \" . $ssl_err;\n                        }\n                    }\n                } elseif ($pconfig['certmethod'] == \"external\") {\n                    $dn = array(\n                        'countryName' => $pconfig['csr_dn_country'],\n                        'stateOrProvinceName' => $pconfig['csr_dn_state'],\n                        'localityName' => $pconfig['csr_dn_city'],\n                        'organizationName' => $pconfig['csr_dn_organization'],\n                        'emailAddress' => $pconfig['csr_dn_email'],\n                        'commonName' => $pconfig['csr_dn_commonname']);\n                    $extns = array();\n                    if (!empty($pconfig['csr_dn_organizationalunit'])) {\n                        $dn['organizationalUnitName'] = $pconfig['csr_dn_organizationalunit'];\n                    }\n                    if (count($altnames)) {\n                        $altnames_tmp = array();\n                        foreach ($altnames as $altname) {\n                            $altnames_tmp[] = \"{$altname['type']}:{$altname['value']}\";\n                        }\n                        $extns['subjectAltName'] = implode(\",\", $altnames_tmp);\n                    }\n                    if (!csr_generate($cert, $pconfig['csr_keylen_curve'], $dn, $pconfig['csr_digest_alg'], $extns)) {\n                        $input_errors = array();\n                        while ($ssl_err = openssl_error_string()) {\n                            $input_errors[] = gettext(\"openssl library returns:\") . \" \" . $ssl_err;\n                        }\n                    }\n                }\n                error_reporting($old_err_level);\n\n                if (isset($id)) {\n                    $a_cert[$id] = $cert;\n                } else {\n                    $a_cert[] = $cert;\n                }\n                if (isset($a_user) && isset($userid)) {\n                    $a_user[$userid]['cert'][] = $cert['refid'];\n                }\n            }\n            if (count($input_errors) == 0) {\n                write_config();\n                if ($act !== 'download_private_key') {\n                    if (isset($userid)) {\n                        header(url_safe('Location: /system_usermanager.php?act=edit&userid=%d', array($userid)));\n                    } else {\n                        header(url_safe('Location: /system_certmanager.php'));\n                    }\n                    exit;\n                }\n            }\n\n        }\n    }\n}\n\nlegacy_html_escape_form_data($pconfig);\nlegacy_html_escape_form_data($a_ca);\nlegacy_html_escape_form_data($a_cert);\n\ninclude(\"head.inc\");\n\n?>\n<body>\n  <style>\n    .monospace-dialog {\n      font-family: monospace;\n      white-space: pre;\n    }\n\n    .monospace-dialog > .modal-dialog {\n      width:70% !important;\n    }\n\n    .modal-body {\n      max-height: calc(100vh - 210px);\n      overflow-y: auto;\n    }\n  </style>\n  <script>\n  $( document ).ready(function() {\n    // delete entry\n    $(\".act_delete\").click(function(event){\n      event.preventDefault();\n      var id = $(this).data('id');\n      BootstrapDialog.show({\n        type:BootstrapDialog.TYPE_DANGER,\n        title: \"<?= gettext(\"Certificates\");?>\",\n        message: \"<?=gettext(\"Do you really want to delete this Certificate?\");?>\",\n        buttons: [{\n                  label: \"<?=gettext(\"No\");?>\",\n                  action: function(dialogRef) {\n                      dialogRef.close();\n                  }}, {\n                  label: \"<?=gettext(\"Yes\");?>\",\n                  action: function(dialogRef) {\n                    $(\"#id\").val(id);\n                    $(\"#action\").val(\"del\");\n                    $(\"#iform\").submit()\n                }\n              }]\n      });\n    });\n\n    $('.p12btn').on('click', function(event) {\n        event.preventDefault();\n        var id = $(this).data('id');\n\n        let password_input = $('<input type=\"password\" autocomplete=\"new-password\" class=\"form-control password_field\" placeholder=\"<?=html_safe(gettext(\"Password\"));?>\">');\n        let confirm_input = $('<input type=\"password\" autocomplete=\"new-password\" class=\"form-control password_field\" placeholder=\"<?=html_safe(gettext(\"Confirm\"));?>\">');\n        let dialog_items = $('<div class = \"form-group\">');\n        dialog_items.append(\n          $(\"<span>\").text(\"<?=html_safe(gettext('Optionally use a password to protect your export'));?>\"),\n          $('<table class=\"table table-condensed\"/>').append(\n            $(\"<tbody/>\").append(\n              $(\"<tr/>\").append($(\"<td/>\").append(password_input)),\n              $(\"<tr/>\").append($(\"<td/>\").append(confirm_input))\n            )\n          )\n        );\n\n        // highlight password/confirm when not equal\n        let keyup_pass = function() {\n            if (confirm_input.val() !== password_input.val()) {\n                $(\".password_field\").addClass(\"has-warning\");\n                $(\".password_field\").closest('div').addClass('has-warning');\n            } else {\n                $(\".password_field\").removeClass(\"has-warning\");\n                $(\".password_field\").closest('div').removeClass('has-warning');\n            }\n        };\n        confirm_input.on('keyup', keyup_pass);\n        password_input.on('keyup', keyup_pass);\n\n\n        BootstrapDialog.show({\n            type:BootstrapDialog.TYPE_INFO,\n            title: \"<?= gettext(\"Certificates\");?>\",\n            message: dialog_items,\n            buttons: [\n                {\n                    label: \"<?=html_safe(gettext(\"Close\"));?>\",\n                    action: function(dialogRef) {\n                        dialogRef.close();\n                    }\n                }, {\n                    label: '<i class=\"fa fa-download fa-fw\"></i> <?=html_safe(gettext(\"Download\"));?>',\n                    action: function(dialogRef) {\n                        if (confirm_input.val() === password_input.val()) {\n                            $.post('system_certmanager.php', {'id': id, 'act': 'p12', 'password': password_input.val()}, function (data) {\n                                var link = $('<a></a>')\n                                    .attr('href','data:application/octet-stream;base64,' + data.content)\n                                    .attr('download', data.filename)\n                                    .appendTo('body');\n                                link.ready(function() {\n                                    link.get(0).click();\n                                    link.empty();\n                                });\n                            });\n                            dialogRef.close();\n                        }\n                    }\n                }\n            ]\n        });\n    });\n\n    $(\".act_info\").click(function(event){\n        event.preventDefault();\n        var id = $(this).data('id');\n        $.ajax({\n                url:\"system_certmanager.php\",\n                type: 'get',\n                data: {'act' : 'info', 'id' :id},\n                success: function(data){\n                  BootstrapDialog.show({\n                              title: '<?=gettext(\"Certificate\");?>',\n                              type:BootstrapDialog.TYPE_INFO,\n                              message: $(\"<div/>\").text(data).html(),\n                              cssClass: 'monospace-dialog',\n                          });\n                }\n        });\n\n    });\n\n    $(\".csr_info_for_sign_csr\").click(function(event){\n        event.preventDefault();\n        var csr_payload = $('#csr').val();\n        $.ajax({\n                url:\"system_certmanager.php\",\n                type: 'post',\n                data: {'act' : 'csr_info', 'csr' : csr_payload},\n                success: function(data){\n                  BootstrapDialog.show({\n                      title: '<?=gettext(\"Certificate Request\");?>',\n                      type:BootstrapDialog.TYPE_INFO,\n                      message: $(\"<div/>\").text(data).html(),\n                      cssClass: 'monospace-dialog',\n                  });\n                }\n        });\n    });\n\n    $(\".x509_extension_step_sign_csr\").click(function(event){\n        event.preventDefault();\n        var csr_payload = $('#csr').val();\n        $.ajax({\n                url:\"system_certmanager.php\",\n                type: 'post',\n                data: {'act' : 'csr_info_json', 'csr' : csr_payload},\n                success: function(data){\n                        subject_text = '';\n                        Object.keys(data.subject).forEach(function(item) {\n                                if (subject_text != '') {\n                                        subject_text += ', ';\n                                }\n                                subject_text += item + '=' + data.subject[item];\n                        });\n\n                        $('#next_button_for_x509_extension_step_sign_csr').addClass('hidden');\n                        $('#csr').prop('readonly', true);\n                        $('#x509_extension_step_sign_cert_csr').removeClass('hidden');\n                        $('#subject_sign_csr').text(subject_text);\n                        $('#subject_alt_name_sign_csr_table > tbody > tr:gt(0)').remove();\n                        if ('subjectAltName' in data) {\n                              data.subjectAltName.forEach(function(item) {\n                                      addRowAltSignCSR(item.type, item.value);\n                              });\n                        }\n                        if ('basicConstraints' in data) {\n                                $('#basic_constraints_is_ca_sign_csr').prop('checked', data.basicConstraints.CA);\n                                $('#basic_constraints_path_len_sign_csr').val(\n                                      ('pathlen' in data.basicConstraints) ? data.basicConstraints.pathlen : ''\n                                );\n                        } else {\n                                $('#basic_constraints_is_ca_sign_csr').prop('checked', false);\n                                $('#basic_constraints_path_len_sign_csr').val('');\n                        }\n                        $(\"#basic_constraints_is_ca_sign_csr\").change();\n\n                        $('#key_usage_sign_csr option').prop('selected', false);\n                        if ('keyUsage' in data) {\n                                data.keyUsage.forEach(function(item) {\n                                        $('#key_usage_sign_csr_' + item).prop('selected', true);\n                                });\n\n                        }\n                        $(\"#key_usage_sign_csr\").selectpicker('refresh');\n\n                        $('#extended_key_usage_sign_csr option').prop('selected', false);\n                        if ('extendedKeyUsage' in data) {\n                                data.extendedKeyUsage.forEach(function(item) {\n                                        $('#extended_key_usage_sign_csr_' + (item.replace(/\\./g, '_'))).prop('selected', true);\n                                });\n\n                        }\n                        $(\"#extended_key_usage_sign_csr\").selectpicker('refresh');\n\n                        $('#submit').removeClass('hidden');\n                },\n                error: function(jqXHR, textStatus, errorThrown) {\n                        if (jqXHR.status == 400) {\n                                BootstrapDialog.show({\n                                        type:BootstrapDialog.TYPE_DANGER,\n                                        title: jqXHR.responseJSON.error,\n                                        message: jqXHR.responseJSON.error_detail,\n                                        buttons: [\n                                            {\n                                                label: \"<?=gettext(\"OK\");?>\",\n                                                action: function(dialogRef) { dialogRef.close(); }\n                                            }\n                                       ]\n                                });\n                                return;\n                        }\n                        BootstrapDialog.show({\n                                type:BootstrapDialog.TYPE_DANGER,\n                                title: \"<?= gettext(\"Unknown Error\");?>\",\n                                message: \"<?= gettext(\"Unknown error occurred. Try again.\");?>\",\n                                buttons: [\n                                    {\n                                        label: \"<?=gettext(\"OK\");?>\",\n                                        action: function(dialogRef) { dialogRef.close(); }\n                                    }\n                               ]\n                        });\n                },\n        });\n    });\n\n    // parameter 'type' must not include non-alphabet characters\n    function addRowAltSignCSR(type, value) {\n        let $tr = $(\"#subject_alt_name_sign_csr_table > tbody > tr:eq(0)\").clone();\n        $tr.find(\"select\").prop(\"name\", \"altname_type_sign_csr[]\").val(type);\n        $tr.find(\"input\").prop(\"name\", \"altname_value_sign_csr[]\").val(value);\n        $tr.removeClass(\"hidden\");\n        $(\"#subject_alt_name_sign_csr_table > tbody\").append($tr);\n        $(\".act-removerow-altnm-sign-csr\").unbind('click').on('click', function(){\n            $(this).parent().parent().remove();\n        });\n    }\n\n    $(\"#addNewAltNmSignCSR\").click(function(){\n        addRowAltSignCSR('', '');\n    });\n\n    $(\"#basic_constraints_is_ca_sign_csr\").change(function(){\n        $('#basic_constraints_path_len_sign_csr').prop(\n          'disabled', !$('#basic_constraints_is_ca_sign_csr').prop('checked')\n        )\n    });\n\n\n    /**\n     * remove row from altNametable\n     */\n    function removeRowAltNm() {\n        if ( $('#altNametable > tbody > tr').length == 1 ) {\n            $('#altNametable > tbody > tr:last > td > input').each(function(){\n              $(this).val('');\n            });\n        } else {\n            $(this).parent().parent().remove();\n        }\n    }\n    // javascript only for edit forms\n    if ($('#certmethod').length) {\n        // no ca's found, display message\n        if ($(\"#caref option\").length == 0) {\n            $(\"#no_caref\").removeClass(\"hidden\");\n            $(\"#caref\").addClass(\"hidden\");\n        }\n        // add new detail record\n        $(\"#addNewAltNm\").click(function(){\n            // copy last row and reset values\n            $('#altNametable > tbody').append('<tr>'+$('#altNametable > tbody > tr:last').html()+'</tr>');\n            $('#altNametable > tbody > tr:last > td > input').each(function(){\n              $(this).val('');\n            });\n            $(\".act-removerow-altnm\").click(removeRowAltNm);\n        });\n        $(\".act-removerow-altnm\").click(removeRowAltNm);\n\n\n        $(\"#certmethod\").change(function(){\n            $(\"#submit\").addClass(\"hidden\");\n            $(\"#import\").addClass(\"hidden\");\n            $(\"#internal\").addClass(\"hidden\");\n            $(\"#external\").addClass(\"hidden\");\n            $(\"#existing\").addClass(\"hidden\");\n            $(\"#sign_cert_csr\").addClass(\"hidden\");\n            $(\"#x509_extension_sign_cert_csr\").addClass(\"hidden\");\n            $('#x509_extension_step_sign_cert_csr').addClass('hidden');\n            if ($(this).val() == \"import\") {\n                $(\"#import\").removeClass(\"hidden\");\n                $(\"#submit\").removeClass(\"hidden\");\n            } else if ($(this).val() == \"internal\") {\n                $(\"#internal\").removeClass(\"hidden\");\n                $(\"#altNameTr\").detach().appendTo(\"#internal > tbody:first\");\n                $(\"#submit\").removeClass(\"hidden\");\n            } else if ($(this).val() == \"external\") {\n                $(\"#external\").removeClass(\"hidden\");\n                $(\"#altNameTr\").detach().appendTo(\"#external > tbody:first\");\n                $(\"#submit\").removeClass(\"hidden\");\n            } else if ($(this).val() == \"sign_cert_csr\") {\n                $(\"#sign_cert_csr\").removeClass(\"hidden\");\n                $('#next_button_for_x509_extension_step_sign_csr').removeClass('hidden');\n                $('#csr').prop('readonly', false);\n            } else {\n                $(\"#existing\").removeClass(\"hidden\");\n                $(\"#submit\").removeClass(\"hidden\");\n            }\n        });\n\n        $(\"#certmethod\").change();\n    }\n\n\n    if (document.createElement('a').download !== undefined) {\n        $(\".text_download_btn\").click(function(event){\n            event.preventDefault();\n            if ($(this).attr('for')) {\n                let target = $(\"#\"+$(this).attr('for'));\n                var link = $('<a></a>')\n                    .attr('href', URL.createObjectURL(new Blob([target.val()])))\n                    .attr('download', target.data('filename'))\n                    .appendTo('body');\n\n                link.ready(function() {\n                    link.get(0).click();\n                    link.empty();\n                });\n\n            }\n        });\n    } else {\n        $(\".text_download_btn\").remove();\n    }\n\n$(\"#keytype\").change(function(){\n        $(\"#EC\").addClass(\"hidden\");\n        $(\"#RSA\").addClass(\"hidden\");\n        $(\"#blank\").addClass(\"hidden\");\n        if ($(this).val() == \"Elliptic Curve\") {\n            $(\"#EC\").removeClass(\"hidden\");\n        } else {\n            $(\"#RSA\").removeClass(\"hidden\");\n        }\n});\n\n$(\"#keytype\").change();\n\n$(\"#csr_keytype\").change(function(){\n        $(\"#csr_EC\").addClass(\"hidden\");\n        $(\"#csr_RSA\").addClass(\"hidden\");\n        $(\"#csr_blank\").addClass(\"hidden\");\n        if ($(this).val() == \"Elliptic Curve\") {\n            $(\"#csr_EC\").removeClass(\"hidden\");\n        } else {\n            $(\"#csr_RSA\").removeClass(\"hidden\");\n        }\n});\n\n$(\"#csr_keytype\").change();\n\n  });\n\n  </script>\n\n<?php include(\"fbegin.inc\"); ?>\n<script>\n$( document ).ready(function() {\n//<![CDATA[\n  function internalca_change() {\n\n    let index = document.iform.caref.selectedIndex;\n    let caref = document.iform.caref[index].value;\n\n    switch (caref) {\n  <?php\n  foreach ($a_ca as $ca) :\n      if (!$ca['prv']) {\n          continue;\n      }\n      $subject = cert_get_subject_array($ca['crt']);\n      legacy_html_escape_form_data($subject);\n      $subject_items = array('C'=>'', 'ST' => '', 'L' => '', 'O' => '', 'emailAddress' => '', 'CN' => '');\n      foreach ($subject as $subject_item) {\n          $subject_items[$subject_item['a']] = $subject_item['v'];\n      }\n  ?>\n      case \"<?=$ca['refid'];?>\":\n          $(\"#dn_state\").val(\"<?=$subject_items['ST'];?>\");\n          $(\"#dn_city\").val(\"<?=$subject_items['L'];?>\");\n          $(\"#dn_organization\").val(\"<?=$subject_items['O'];?>\");\n          $(\"#dn_email\").val(\"<?=$subject_items['emailAddress'];?>\");\n          $('#dn_country option').prop('selected', false);\n          $('#dn_country option').filter('[value=\"<?=$subject_items['C'];?>\"]').prop('selected', true);\n          $(\"#dn_country\").selectpicker('refresh');\n          break;\n  <?php\n  endforeach; ?>\n    }\n  }\n\n  // only trigger change event when in edit mode.\n  if ($('#certmethod').length) {\n    $(\"#caref\").change(internalca_change);\n    $(\"#caref\").change();\n  }\n});\n\n//]]>\n</script>\n\n<!-- row -->\n<section class=\"page-content-main\">\n  <div class=\"container-fluid\">\n    <div class=\"row\">\n<?php\n    if (isset($input_errors) && count($input_errors) > 0) {\n        print_input_errors($input_errors);\n    }\n    if (isset($savemsg)) {\n        print_info_box($savemsg);\n    }\n?>\n      <section class=\"col-xs-12\">\n        <div class=\"content-box tab-content table-responsive\">\n\n        <!--- New --->\n<?php\n        if ($act == \"new\") :?>\n          <form method=\"post\" name=\"iform\" id=\"iform\" >\n            <input type=\"hidden\" name=\"act\" value=\"<?=$act;?>\"/>\n<?php\n            if (isset($userid)) :?>\n            <input name=\"userid\" type=\"hidden\" value=\"<?=htmlspecialchars($userid);?>\" />\n<?php\n            endif;?>\n<?php\n            if (isset($id)) :?>\n            <input name=\"id\" type=\"hidden\" value=\"<?=$id;?>\" />\n<?php\n            endif;?>\n            <table class=\"table table-striped opnsense_standard_table_form\">\n              <tr>\n                <td style=\"width:22%\"></td>\n                <td  style=\"width:78%; text-align:right\">\n                  <small><?=gettext(\"full help\"); ?> </small>\n                  <i class=\"fa fa-toggle-off text-danger\"  style=\"cursor: pointer;\" id=\"show_all_help_page\"></i>\n                </td>\n              </tr>\n              <tr>\n                <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Method\");?></td>\n                <td>\n                  <select name=\"certmethod\" id=\"certmethod\">\n<?php\n                  foreach ($cert_methods as $method => $desc) :?>\n                    <option value=\"<?=$method;?>\" <?=$pconfig['certmethod'] == $method ? 'selected=\"selected\"' : ''; ?>>\n                      <?=$desc;?>\n                    </option>\n<?php\n                  endforeach; ?>\n                  </select>\n                </td>\n              </tr>\n              <tr>\n                <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Descriptive name\");?></td>\n                <td>\n                  <input name=\"descr\" type=\"text\" id=\"descr\" size=\"20\" value=\"<?=$pconfig['descr'];?>\"/>\n                </td>\n              </tr>\n            </table>\n            <!-- existing cert -->\n            <table id=\"import\" class=\"table table-striped opnsense_standard_table_form\">\n              <thead>\n                <tr>\n                  <th colspan=\"2\"><?=gettext(\"Import Certificate\");?></th>\n                </tr>\n              </thead>\n              <tbody>\n                <tr>\n                  <td style=\"width:22%\"><a id=\"help_for_cert\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Certificate data\");?></td>\n                  <td style=\"width:78%\">\n                    <textarea name=\"cert\" id=\"cert\" cols=\"65\" rows=\"7\"><?=$pconfig['cert'];?></textarea>\n                    <div class=\"hidden\" data-for=\"help_for_cert\">\n                      <?=gettext(\"Paste a certificate in X.509 PEM format here.\");?>\n                    </div>\n                  </td>\n                </tr>\n                <tr>\n                  <td><a id=\"help_for_key\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Private key data\");?></td>\n                  <td>\n                    <textarea name=\"key\" id=\"key\" cols=\"65\" rows=\"7\"><?=$pconfig['key'];?></textarea>\n                    <div class=\"hidden\" data-for=\"help_for_key\">\n                      <?=gettext(\"Paste a private key in X.509 PEM format here.\");?>\n                    </div>\n                  </td>\n                </tr>\n              </tbody>\n            </table>\n            <!-- sign_cert_csr -->\n            <table id=\"sign_cert_csr\" class=\"table table-striped opnsense_standard_table_form\">\n              <thead>\n                <tr>\n                  <th colspan=\"2\"><?=gettext(\"Sign CSR\");?></th>\n                </tr>\n              </thead>\n              <tbody>\n                <tr>\n                  <td style=\"width:22%\"><?=gettext(\"Certificate authority\");?></td>\n                  <td style=\"width:78%\">\n                    <select name='caref_sign_csr' id='caref_sign_csr'>\n  <?php\n                    foreach ($a_ca as $ca) :\n                        if (empty($ca['prv'])) {\n                            continue;\n                        }?>\n                      <option value=\"<?=$ca['refid'];?>\" <?=isset($pconfig['caref_sign_csr']) && isset($ca['refid']) && $pconfig['caref_sign_csr'] == $ca['refid'] ? 'selected=\"selected\"' : '';?>><?=html_safe($ca['descr']);?></option>\n  <?php\n                    endforeach; ?>\n                    </select>\n                    <div class=\"hidden\" id=\"no_caref_sign_csr\">\n                      <?=sprintf(gettext(\"No internal Certificate Authorities have been defined. You must %sadd%s an internal CA before creating an internal certificate.\"),'<a href=\"system_camanager.php?act=new&amp;method=internal\">','</a>');?>\n                    </div>\n                  </td>\n                </tr>\n                <tr>\n                  <td><a id=\"help_for_digest_alg_sign_csr\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Digest Algorithm\");?></td>\n                  <td>\n                    <select name='digest_alg_sign_csr' id='digest_alg_sign_csr'>\n  <?php\n                    foreach ($openssl_digest_algs as $digest_alg) :?>\n                      <option value=\"<?=$digest_alg;?>\" <?=$pconfig['digest_alg_sign_csr'] == $digest_alg ? 'selected=\"selected\"' : '';?>>\n                        <?=strtoupper($digest_alg);?>\n                      </option>\n  <?php\n                    endforeach; ?>\n                    </select>\n                    <div class=\"hidden\" data-for=\"help_for_digest_alg_sign_csr\">\n                      <?= gettext(\"NOTE: It is recommended to use an algorithm stronger than SHA1 when possible.\") ?>\n                    </div>\n                  </td>\n                </tr>\n                <tr>\n                  <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Lifetime\");?> (<?=gettext(\"days\");?>)</td>\n                  <td>\n                    <input name=\"lifetime_sign_csr\" type=\"text\" id=\"lifetime_sign_csr\" size=\"5\" value=\"<?=$pconfig['lifetime_sign_csr'];?>\"/>\n                  </td>\n                </tr>\n                <tr>\n                  <td><a id=\"help_for_csr_sign_csr\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"CSR file\");?></td>\n                  <td>\n                    <textarea name=\"csr\" id=\"csr\" cols=\"65\" rows=\"7\"><?=$pconfig['csr'];?></textarea><br/>\n                    <a href=\"#\" class=\"csr_info_for_sign_csr btn btn-secondary\"><?=gettext(\"Show Detail\");?></a><br/>\n                    <div class=\"hidden\" data-for=\"help_for_csr_sign_csr\">\n                      <?=gettext(\"Paste the CSR file here.\");?>\n                    </div>\n                  </td>\n                </tr>\n                <tr id=\"next_button_for_x509_extension_step_sign_csr\">\n                  <td>&nbsp;</td>\n                  <td>\n                    <a href=\"#\" class=\"x509_extension_step_sign_csr btn btn-primary\"><?=gettext(\"Next\");?></a>\n                  </td>\n                </tr>\n              </tbody>\n            </table>\n            <div id=\"x509_extension_step_sign_cert_csr\" class=\"hidden\">\n              <table class=\"table table-striped opnsense_standard_table_form\">\n                <thead>\n                  <tr>\n                    <th colspan=\"2\"><?=gettext(\"Subject of the certificate\");?></th>\n                  </tr>\n                </thead>\n                <tbody>\n                  <tr>\n                    <td style=\"width:22%\"><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext('Subject');?></td>\n                    <td id=\"subject_sign_csr\" style=\"width:78%\"></td>\n                  </tr>\n                  <tr>\n                    <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext('subjectAltName');?></td>\n                    <td>\n                      <table class=\"table table-condensed\" id=\"subject_alt_name_sign_csr_table\">\n                        <thead>\n                            <tr>\n                              <th><?=gettext(\"Type\");?></th>\n                              <th><?=gettext(\"Value\");?></th>\n                              <th></th>\n                            </tr>\n                        </thead>\n                        <tbody>\n                            <tr class=\"hidden\">\n                                <td>\n                                  <select>\n                                      <option value=\"DNS\"><?=gettext(\"DNS\");?></option>\n                                      <option value=\"IP\"><?=gettext(\"IP\");?></option>\n                                      <option value=\"email\"><?=gettext(\"email\");?></option>\n                                      <option value=\"URI\"><?=gettext(\"URI\");?></option>\n                                  </select>\n                                </td>\n                                <td>\n                                  <input type=\"text\" size=\"20\" value=\"\">\n                                </td>\n                                <td>\n                                  <div style=\"cursor:pointer;\" class=\"act-removerow-altnm-sign-csr btn btn-default btn-xs\"><i class=\"fa fa-minus fa-fw\"></i></div>\n                                </td>\n                            </tr>\n                        </tbody>\n                        <tfoot>\n                          <tr>\n                            <td colspan=\"2\"></td>\n                            <td>\n                              <div id=\"addNewAltNmSignCSR\" style=\"cursor:pointer;\" class=\"btn btn-default btn-xs\"><i class=\"fa fa-plus fa-fw\"></i></div>\n                            </td>\n                          </tr>\n                        </tfoot>\n                      </table>\n                    </td>\n                  </tr>\n                  <tr>\n                    <td><a id=\"help_for_basic_extensions_sign_csr\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext('basicConstraints');?></td>\n                    <td>\n                      <input type=\"checkbox\" name=\"basic_constraints_is_ca_sign_csr\" id=\"basic_constraints_is_ca_sign_csr\" value=\"true\" /> <?= gettext('is CA'); ?><br />\n                      <?= gettext('Maximum Path Length'); ?>: <input type=\"text\" name=\"basic_constraints_path_len_sign_csr\" id=\"basic_constraints_path_len_sign_csr\" size=\"5\" value=\"<?=$pconfig['basic_constraints_sign_csr'];?>\"/>\n                      <div class=\"hidden\" data-for=\"help_for_basic_extensions_sign_csr\">\n                        <strong><?= gettext('Maximum Path Length'); ?></strong>: <?= gettext('Define the maximum number of non-self-issued intermediate certificates that may follow this certificate in a valid certification path.'); ?>\n                      </div>\n                    </td>\n                  </tr>\n                  <tr>\n                    <td><a id=\"help_for_key_usage_sign_csr\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext('keyUsage');?></td>\n                    <td>\n                      <select name=\"key_usage_sign_csr[]\" title=\"<?= html_safe(gettext('Select keyUsage')) ?>\" multiple=\"multiple\" id=\"key_usage_sign_csr\" class=\"selectpicker\" data-live-search=\"true\" data-size=\"5\" tabindex=\"2\" <?=!empty($pconfig['associated-rule-id']) ? \"disabled\" : \"\";?>>\n<?php\n                      foreach ($key_usages as $key => $human_readable): ?>\n                        <option value=\"<?=$key;?>\" id=\"key_usage_sign_csr_<?=$key;?>\">\n                          <?= $human_readable; ?>\n                        </option>\n<?php\n                      endforeach; ?>\n                      </select>\n                      <div class=\"hidden\" data-for=\"help_for_key_usage_sign_csr\">\n                        <?=gettext(\"Practical examples:\");?>\n                        <ul>\n                          <li><strong><?= gettext('Client Certificate'); ?></strong>: <?= $key_usages['nonRepudiation']; ?>, <?= $key_usages['digitalSignature']; ?>, <?= $key_usages['keyEncipherment']; ?></li>\n                          <li><strong><?= gettext('Server Certificate'); ?></strong>: <?= $key_usages['digitalSignature']; ?>, <?= $key_usages['keyEncipherment']; ?></li>\n                          <li><strong><?= gettext('Combined Client/Server Certificate'); ?></strong>: <?= $key_usages['nonRepudiation']; ?>, <?= $key_usages['digitalSignature']; ?>, <?= $key_usages['keyEncipherment'];?></li>\n                          <li><strong><?= gettext('Certificate Authority'); ?></strong>: <i><?= gettext('None. Just add CA option in basicConstraints.'); ?></i></li>\n                        </ul>\n                      </div>\n                    </td>\n                  </tr>\n                  <tr>\n                    <td><a id=\"help_for_extended_key_usage_sign_csr\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext('extendedKeyUsage');?></td>\n                    <td>\n                      <select name=\"extended_key_usage_sign_csr[]\" title=\"<?= html_safe(gettext('Select extendedKeyUsage')) ?>\" multiple=\"multiple\" id=\"extended_key_usage_sign_csr\" class=\"selectpicker\" data-live-search=\"true\" data-size=\"5\" tabindex=\"2\" <?=!empty($pconfig['associated-rule-id']) ? \"disabled\" : \"\";?>>\n<?php\n                      foreach ($extended_key_usages as $key => $human_readable): ?>\n                        <option value=\"<?=$key;?>\" id=\"extended_key_usage_sign_csr_<?= str_replace('.', '_', $key);?>\">\n                          <?= $human_readable; ?>\n                        </option>\n<?php\n                      endforeach; ?>\n                      </select>\n                    <div class=\"hidden\" data-for=\"help_for_extended_key_usage_sign_csr\">\n                      <?=gettext(\"Practical examples:\");?>\n                      <ul>\n                        <li><strong><?= gettext('Client Certificate'); ?></strong>: <?= $extended_key_usages['1.3.6.1.5.5.7.3.2']; ?></li>\n                        <li><strong><?= gettext('Server Certificate'); ?></strong>: <?= $extended_key_usages['1.3.6.1.5.5.7.3.1'] ?>, <?= $extended_key_usages['1.3.6.1.5.5.8.2.2']; ?></li>\n                        <li><strong><?= gettext('Combined Client/Server Certificate'); ?></strong>: <?= $extended_key_usages['1.3.6.1.5.5.7.3.2']; ?>, <?= $extended_key_usages['1.3.6.1.5.5.7.3.1'] ?>, <?= $extended_key_usages['1.3.6.1.5.5.8.2.2']; ?></li>\n                        <li><strong><?= gettext('Certificate Authority'); ?></strong>: <i><?= gettext('None. Just add CA option in basicConstraints.'); ?></i></li>\n                      </ul>\n                    </div>\n                    </td>\n                  </tr>\n                </tbody>\n              </table>\n            </div>\n            <!-- internal cert -->\n            <table id=\"internal\" class=\"table table-striped opnsense_standard_table_form\">\n              <thead>\n                <tr>\n                  <th colspan=\"2\"><?=gettext(\"Internal Certificate\");?></th>\n                </tr>\n              </thead>\n              <tbody>\n              <tr>\n                <td style=\"width:22%\"><?=gettext(\"Certificate authority\");?></td>\n                <td style=\"width:78%\">\n                  <select name='caref' id='caref'>\n<?php\n                  foreach ($a_ca as $ca) :\n                      if (!$ca['prv']) {\n                          continue;\n                      }?>\n                    <option value=\"<?=$ca['refid'];?>\" <?=isset($pconfig['caref']) && isset($ca['refid']) && $pconfig['caref'] == $ca['refid'] ? 'selected=\"selected\"' : '';?>><?=$ca['descr'];?></option>\n<?php\n                  endforeach; ?>\n                  </select>\n                  <div class=\"hidden\" id=\"no_caref\">\n                    <?=sprintf(gettext(\"No internal Certificate Authorities have been defined. You must %sadd%s an internal CA before creating an internal certificate.\"),'<a href=\"system_camanager.php?act=new&amp;method=internal\">','</a>');?>\n                  </div>\n                </td>\n              </tr>\n              <tr>\n                <td><a id=\"help_for_digest_cert_type\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Type\");?> </td>\n                <td>\n                    <select name=\"cert_type\">\n                        <option value=\"usr_cert\" <?=$pconfig['cert_type'] == 'usr_cert' ? 'selected=\"selected\"' : '';?>> <?=gettext(\"Client Certificate\");?> </option>\n                        <option value=\"server_cert\" <?=$pconfig['cert_type'] == 'server_cert' ? 'selected=\"selected\"' : '';?>> <?=gettext(\"Server Certificate\");?> </option>\n                        <option value=\"combined_server_client\" <?=$pconfig['cert_type'] == 'combined_server_client' ? 'selected=\"selected\"' : '';?>> <?=gettext(\"Combined Client/Server Certificate\");?> </option>\n                        <option value=\"v3_ca\" <?=$pconfig['cert_type'] == 'v3_ca' ? 'selected=\"selected\"' : '';?>> <?=gettext(\"Certificate Authority\");?> </option>\n                    </select>\n                    <div class=\"hidden\" data-for=\"help_for_digest_cert_type\">\n                      <?=gettext(\"Choose the type of certificate to generate here, the type defines it's constraints\");?>\n                    </div>\n                </td>\n              </tr>\n              <tr>\n                  <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Key Type\");?></td>\n                  <td style=\"width:78%\">\n                    <select name='keytype' id='keytype' class=\"selectpicker\">\n                  <option value=\"RSA\" <?=$pconfig['keytype'] == \"RSA\" ? \"selected=\\\"selected\\\"\" : \"\";?>>\n                    <?=gettext(\"RSA\");?>\n                  </option>\n                  <option value=\"Elliptic Curve\" <?=$pconfig['keytype'] == \"Elliptic Curve\" ? \"selected=\\\"selected\\\"\" : \"\";?>>\n                    <?=gettext(\"Elliptic Curve\");?>\n                  </option>\n                    </select>\n                  </td>\n                </tr>\n              <tr id='RSA'>\n                <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Key length\");?> (<?=gettext(\"bits\");?>)</td>\n                <td>\n                  <select name='keylen'>\n<?php\n                  foreach ($cert_keylens as $len) :?>\n                    <option value=\"<?=$len;?>\" <?=isset($pconfig['keylen']) && $pconfig['keylen'] == $len ? \"selected=\\\"selected\\\"\" : \"\";?>><?=$len;?></option>\n<?php\n                    endforeach; ?>\n                  </select>\n                </td>\n              </tr>\n              <tr id='blank'><td></td></tr>\n              <tr id='EC'>\n                  <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Curve\");?></td>\n                  <td style=\"width:78%\">\n                    <select name='curve' id='curve' class=\"selectpicker\">\n<?php\n                    foreach ($cert_curves as $curve) :?>\n                      <option value=\"<?=$curve;?>\" <?=isset($pconfig['curve']) && $pconfig['curve'] == $curve ? \"selected=\\\"selected\\\"\" : \"\";?>><?=$curve;?></option>\n<?php\n                    endforeach; ?>\n                    </select>\n                  </td>\n                </tr>\n              <tr>\n                <td><a id=\"help_for_digest_alg\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Digest Algorithm\");?></td>\n                <td>\n                  <select name='digest_alg' id='digest_alg'>\n<?php\n                  foreach ($openssl_digest_algs as $digest_alg) :?>\n                    <option value=\"<?=$digest_alg;?>\" <?=$pconfig['digest_alg'] == $digest_alg ? 'selected=\"selected\"' : '';?>>\n                      <?=strtoupper($digest_alg);?>\n                    </option>\n<?php\n                  endforeach; ?>\n                  </select>\n                  <div class=\"hidden\" data-for=\"help_for_digest_alg\">\n                    <?= gettext(\"NOTE: It is recommended to use an algorithm stronger than SHA1 when possible.\") ?>\n                  </div>\n                </td>\n              </tr>\n              <tr>\n                <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Lifetime\");?> (<?=gettext(\"days\");?>)</td>\n                <td>\n                  <input name=\"lifetime\" type=\"text\" id=\"lifetime\" size=\"5\" value=\"<?=$pconfig['lifetime'];?>\"/>\n                </td>\n              </tr>\n              <tr>\n                <td><a id=\"help_for_private_key_location\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Private key location\");?></td>\n                <td>\n                  <select name=\"private_key_location\" id=\"private_key_location\">\n                    <option value=\"firewall\" <?= $pconfig['private_key_location'] === 'firewall' ? 'selected=\"selected\"' : ''; ?>><?= gettext('Save on this firewall'); ?></option>\n                    <option value=\"local\"    <?= $pconfig['private_key_location'] === 'local'    ? 'selected=\"selected\"' : ''; ?>><?= gettext('Download and do not save'); ?></option>\n                  </select>\n                  <div class=\"hidden\" data-for=\"help_for_private_key_location\">\n                    <strong><?= gettext('Save on this firewall'); ?></strong>: <?= gettext(\"Normally choose this.\"); ?><br/>\n                    <strong><?= gettext('Download and do not save'); ?></strong>: <?= gettext(\"If the certificate is for use by a device other than this firewall, and you can download private key soon after Saving, choose this. By this option you can download the private key, which is not saved onto this firewall.\"); ?><br/>\n                  </div>\n                </td>\n              </tr>\n              <tr>\n                <th colspan=\"2\"><?=gettext(\"Distinguished name\");?> </th>\n              </tr>\n              <tr>\n                <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Country Code\");?> : &nbsp;</td>\n                <td>\n                  <select name=\"dn_country\" id=\"dn_country\" class=\"selectpicker\">\n<?php\n                  foreach (get_country_codes() as $cc => $cn):?>\n                    <option value=\"<?=$cc;?>\" <?=$pconfig['dn_country'] == $cc ? 'selected=\"selected\"' : '';?>>\n                      <?=$cc;?> (<?=$cn;?>)\n                    </option>\n<?php\n                  endforeach;?>\n                  </select>\n                </td>\n              </tr>\n              <tr>\n                <td><a id=\"help_for_digest_dn_state\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"State or Province\");?> : &nbsp;</td>\n                <td>\n                  <input name=\"dn_state\" id=\"dn_state\" type=\"text\" size=\"40\" value=\"<?=$pconfig['dn_state'];?>\"/>\n                  <div class=\"hidden\" data-for=\"help_for_digest_dn_state\">\n                    <em><?=gettext(\"ex:\");?></em>\n                    &nbsp;\n                    <?=gettext(\"Sachsen\");?>\n                  </div>\n                </td>\n              </tr>\n              <tr>\n                <td><a id=\"help_for_digest_dn_city\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"City\");?> : &nbsp;</td>\n                <td>\n                  <input name=\"dn_city\" id=\"dn_city\" type=\"text\" size=\"40\" value=\"<?=$pconfig['dn_city'];?>\"/>\n                  <div class=\"hidden\" data-for=\"help_for_digest_dn_city\">\n                    <em><?=gettext(\"ex:\");?></em>\n                    &nbsp;\n                    <?=gettext(\"Leipzig\");?>\n                  </div>\n                </td>\n              </tr>\n              <tr>\n                <td><a id=\"help_for_digest_dn_organization\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Organization\");?> : &nbsp;</td>\n                <td>\n                  <input name=\"dn_organization\" id=\"dn_organization\" type=\"text\" size=\"40\" value=\"<?=$pconfig['dn_organization'];?>\"/>\n                  <div class=\"hidden\" data-for=\"help_for_digest_dn_organization\">\n                    <em><?=gettext(\"ex:\");?></em>\n                    &nbsp;\n                    <?=gettext(\"My Company Inc\");?>\n                  </div>\n                </td>\n              </tr>\n              <tr>\n                <td><a id=\"help_for_digest_dn_email\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Email Address\");?> : &nbsp;</td>\n                <td>\n                  <input name=\"dn_email\" id=\"dn_email\" type=\"text\" size=\"25\" value=\"<?=$pconfig['dn_email'];?>\"/>\n                  <div class=\"hidden\" data-for=\"help_for_digest_dn_email\">\n                    <em><?=gettext(\"ex:\");?></em>\n                    &nbsp;\n                    <?=gettext(\"admin@mycompany.com\");?>\n                  </div>\n                </td>\n              </tr>\n              <tr>\n                <td><a id=\"help_for_digest_dn_commonname\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Common Name\");?> : &nbsp;</td>\n                <td>\n                  <input name=\"dn_commonname\" id=\"dn_commonname\" type=\"text\" size=\"25\" value=\"<?=$pconfig['dn_commonname'];?>\"/>\n                  <div class=\"hidden\" data-for=\"help_for_digest_dn_commonname\">\n                    <em><?=gettext(\"ex:\");?></em>\n                    &nbsp;\n                    <?=gettext(\"internal-ca\");?>\n                  </div>\n                </td>\n              </tr>\n              <tr id=\"altNameTr\">\n                <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Alternative Names\");?></td>\n                <td>\n                  <table class=\"table table-condensed\" id=\"altNametable\">\n                    <thead>\n                        <tr>\n                          <th><?=gettext(\"Type\");?></th>\n                          <th><?=gettext(\"Value\");?></th>\n                          <th></th>\n                        </tr>\n                    </thead>\n                    <tbody>\n<?php\n                      if (!isset($pconfig['altname_value']) || count($pconfig['altname_value']) ==0) :?>\n                      <tr>\n                        <td>\n                          <select name=\"altname_type[]\" id=\"altname_type\">\n                            <option value=\"DNS\"><?=gettext(\"DNS\");?></option>\n                            <option value=\"IP\"><?=gettext(\"IP\");?></option>\n                            <option value=\"email\"><?=gettext(\"email\");?></option>\n                            <option value=\"URI\"><?=gettext(\"URI\");?></option>\n                          </select>\n                        </td>\n                        <td>\n                          <input name=\"altname_value[]\" type=\"text\" size=\"20\" value=\"\" />\n                        </td>\n                        <td>\n                          <div style=\"cursor:pointer;\" class=\"act-removerow-altnm btn btn-default btn-xs\"><i class=\"fa fa-minus fa-fw\"></i></div>\n                        </td>\n                      </tr>\n<?php\n                      else:\n                        foreach ($pconfig['altname_value'] as $itemid => $item) :\n                          $altname_type = isset($pconfig['altname_type'][$itemid]) ? $pconfig['altname_type'][$itemid] : null; ?>\n                        <tr>\n                          <td>\n                            <select name=\"altname_type[]\" id=\"altname_type\">\n                              <option value=\"DNS\" <?=$altname_type == 'DNS' ? 'selected=\"selected\"' : '';?>><?=gettext('DNS');?></option>\n                              <option value=\"IP\" <?=$altname_type == 'IP' ? 'selected=\"selected\"' : '';?>><?=gettext('IP');?></option>\n                              <option value=\"email\" <?=$altname_type == 'email' ? 'selected=\"selected\"' : '';?>><?=gettext('email');?></option>\n                              <option value=\"URI\" <?=$altname_type == 'URI' ? 'selected=\"selected\"' : '';?>><?=gettext('URI');?></option>\n                            </select>\n                          </td>\n                          <td>\n                            <input name=\"altname_value[]\" type=\"text\" size=\"20\" value=\"<?=$item;?>\" />\n                          </td>\n                          <td>\n                            <div style=\"cursor:pointer;\" class=\"act-removerow-altnm btn btn-default btn-xs\"><i class=\"fa fa-minus fa-fw\"></i></div>\n                          </td>\n                        </tr>\n\n<?php\n                        endforeach;\n                      endif;?>\n                    </tbody>\n                    <tfoot>\n                      <tr>\n                        <td colspan=\"2\"></td>\n                        <td>\n                          <div id=\"addNewAltNm\" style=\"cursor:pointer;\" class=\"btn btn-default btn-xs\"><i class=\"fa fa-plus fa-fw\"></i></div>\n                        </td>\n                      </tr>\n                    </tfoot>\n                  </table>\n                </td>\n              </tr>\n              </tbody>\n            </table>\n            <!-- external cert -->\n            <table id=\"external\" class=\"table table-striped opnsense_standard_table_form\">\n              <thead>\n                <tr>\n                  <td colspan=\"2\"><?=gettext(\"External Signing Request\");?></td>\n                </tr>\n              </thead>\n              <tbody>\n                <tr>\n                  <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Key Type\");?></td>\n                  <td style=\"width:78%\">\n                    <select name='csr_keytype' id='csr_keytype' class=\"selectpicker\">\n                  <option value=\"RSA\" <?=$pconfig['csr_keytype'] == \"RSA\" ? \"selected=\\\"selected\\\"\" : \"\";?>>\n                    <?=gettext(\"RSA\");?>\n                  </option>\n                  <option value=\"Elliptic Curve\" <?=$pconfig['csr_keytype'] == \"Elliptic Curve\" ? \"selected=\\\"selected\\\"\" : \"\";?>>\n                    <?=gettext(\"Elliptic Curve\");?>\n                  </option>\n                    </select>\n                  </td>\n                </tr>\n                <tr id='csr_RSA'>\n                  <td style=\"width:22%\"><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Key length\");?> (<?=gettext(\"bits\");?>)</td>\n                  <td style=\"width:78%\">\n                    <select name='csr_keylen' class=\"selectpicker\">\n<?php\n                    foreach ($cert_keylens as $len) :?>\n                      <option value=\"<?=$len;?>\" <?=isset($pconfig['csr_keylen']) && $pconfig['csr_keylen'] == $len ? \"selected=\\\"selected\\\"\" : \"\";?>><?=$len;?></option>\n<?php\n                    endforeach; ?>\n                    </select>\n                </td>\n              </tr>\n              <tr id='csr_blank'><td></td></tr>\n              <tr id='csr_EC'>\n                  <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Curve\");?></td>\n                  <td style=\"width:78%\">\n                    <select name='csr_curve' id='csr_curve' class=\"selectpicker\">\n<?php\n                    foreach ($cert_curves as $curve) :?>\n                      <option value=\"<?=$curve;?>\" <?=isset($pconfig['csr_curve']) && $pconfig['csr_curve'] == $curve ? \"selected=\\\"selected\\\"\" : \"\";?>><?=$curve;?></option>\n<?php\n                    endforeach; ?>\n                    </select>\n                  </td>\n                </tr>\n              <tr>\n                <td><a id=\"help_for_csr_digest_alg\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Digest Algorithm\");?></td>\n                <td>\n                  <select name='csr_digest_alg'>\n<?php\n                  foreach ($openssl_digest_algs as $csr_digest_alg) :?>\n                    <option value=\"<?=$csr_digest_alg;?>\" <?=$pconfig['csr_digest_alg'] == $csr_digest_alg ? \"selected=\\\"selected\\\"\" : \"\";?>>\n                      <?=strtoupper($csr_digest_alg);?>\n                    </option>\n<?php\n                  endforeach; ?>\n                  </select>\n                  <div class=\"hidden\" data-for=\"help_for_csr_digest_alg\">\n                    <?= gettext(\"NOTE: It is recommended to use an algorithm stronger than SHA1 when possible.\") ?>\n                  </div>\n                </td>\n              </tr>\n              <tr>\n                <th colspan=\"2\"><?=gettext(\"Distinguished name\");?> </th>\n              </tr>\n              <tr>\n                <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Country Code\");?> : &nbsp;</td>\n                <td>\n                  <select name=\"csr_dn_country\" id=\"csr_dn_country\" class=\"selectpicker\">\n<?php\n                  foreach (get_country_codes() as $cc => $cn):?>\n                    <option value=\"<?=$cc;?>\" <?=$pconfig['csr_dn_country'] == $cc ? \"selected=\\\"selected\\\"\" : \"\";?>>\n                      <?=$cc;?> (<?=$cn;?>)\n                    </option>\n<?php\n                  endforeach;?>\n                  </select>\n                </td>\n              </tr>\n              <tr>\n                <td><a id=\"help_for_digest_csr_dn_state\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"State or Province\");?> : &nbsp;</td>\n                <td>\n                  <input name=\"csr_dn_state\" type=\"text\" size=\"40\" value=\"<?=$pconfig['csr_dn_state'];?>\"/>\n                  <div class=\"hidden\" data-for=\"help_for_digest_csr_dn_state\">\n                    <em><?=gettext(\"ex:\");?></em>\n                    &nbsp;\n                    <?=gettext(\"Sachsen\");?>\n                  </div>\n                </td>\n              </tr>\n              <tr>\n                <td><a id=\"help_for_digest_csr_dn_city\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"City\");?> : &nbsp;</td>\n                <td>\n                  <input name=\"csr_dn_city\" type=\"text\" size=\"40\" value=\"<?=$pconfig['csr_dn_city'];?>\"/>\n                  <div class=\"hidden\" data-for=\"help_for_digest_csr_dn_city\">\n                    <em><?=gettext(\"ex:\");?></em>\n                    &nbsp;\n                    <?=gettext(\"Leipzig\");?>\n                  </div>\n                </td>\n              </tr>\n              <tr>\n                <td><a id=\"help_for_digest_csr_dn_organization\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Organization\");?> : &nbsp;</td>\n                <td>\n                  <input name=\"csr_dn_organization\" type=\"text\" size=\"40\" value=\"<?=$pconfig['csr_dn_organization'];?>\"/>\n                  <div class=\"hidden\" data-for=\"help_for_digest_csr_dn_organization\">\n                    <em><?=gettext(\"ex:\");?></em>\n                    &nbsp;\n                    <?=gettext(\"My Company Inc\");?>\n                  </div>\n                </td>\n              </tr>\n              <tr>\n                <td><a id=\"help_for_digest_csr_dn_organizationalunit\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Organizational Unit\");?> : &nbsp;</td>\n                <td>\n                  <input name=\"csr_dn_organizationalunit\" type=\"text\" size=\"40\" value=\"<?=$pconfig['csr_dn_organizationalunit'];?>\"/>\n                  <div class=\"hidden\" data-for=\"help_for_digest_csr_dn_organizationalunit\">\n                    <em><?=gettext(\"ex:\");?></em>\n                    &nbsp;\n                    <?=gettext(\"IT department\");?>\n                  </div>\n                </td>\n              </tr>\n              <tr>\n                <td><a id=\"help_for_digest_csr_dn_email\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Email Address\");?> : &nbsp;</td>\n                <td>\n                  <input name=\"csr_dn_email\" type=\"text\" size=\"25\" value=\"<?=$pconfig['csr_dn_email'];?>\"/>\n                  <div class=\"hidden\" data-for=\"help_for_digest_csr_dn_email\">\n                    <em><?=gettext(\"ex:\");?></em>\n                    &nbsp;\n                    <?=gettext(\"admin@mycompany.com\");?>\n                  </div>\n                </td>\n              </tr>\n              <tr>\n                <td><a id=\"help_for_digest_csr_dn_commonname\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Common Name\");?> : &nbsp;</td>\n                <td>\n                  <input name=\"csr_dn_commonname\" type=\"text\" size=\"25\" value=\"<?=$pconfig['csr_dn_commonname'];?>\"/>\n                  <div class=\"hidden\" data-for=\"help_for_digest_csr_dn_commonname\">\n                    <em><?=gettext(\"ex:\");?></em>\n                    &nbsp;\n                    <?=gettext(\"internal-ca\");?>\n                  </div>\n                </td>\n              </tr>\n            </tbody>\n          </table>\n          <!-- choose existing cert -->\n          <table id=\"existing\" class=\"table table-striped\">\n            <thead>\n              <tr>\n                <th colspan=\"2\"><?=gettext(\"Choose an Existing Certificate\");?></th>\n              </tr>\n            </thead>\n              <tbody>\n              <tr>\n                <td style=\"width:22%\"><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Existing Certificates\");?></td>\n                <td style=\"width:78%\">\n                  <select name='certref'>\n<?php\n                  foreach ($config['cert'] as $cert) :\n                      $caname = \"\";\n                      $usercert = isset($config['system']['user'][$userid]['cert']) ? $config['system']['user'][$userid]['cert'] : array();\n                      if (isset($userid) && in_array($cert['refid'], $usercert)) {\n                          continue;\n                      }\n                      if (isset($cert['caref'])) {\n                          $ca = lookup_ca($cert['caref']);\n                          if ($ca) {\n                              $caname = \" (CA: {$ca['descr']})\";\n                          }\n                      }?>\n                    <option value=\"<?=$cert['refid'];?>\" <?=isset($pconfig['certref']) && isset($cert['refid']) && $pconfig['certref'] == $cert['refid'] ? \"selected=\\\"selected\\\"\" : \"\";?>>\n                      <?=$cert['descr'];?> <?=$caname;?>\n                      <?=isset($cert['refid']) && cert_in_use($cert['refid']) ? gettext(\"*In Use\") : \"\";?>\n                      <?=is_cert_revoked($cert) ? gettext(\"*Revoked\") :\"\";?>\n                    </option>\n<?php\n                  endforeach; ?>\n                  </select>\n                </td>\n              </tr>\n              </tbody>\n            </table>\n            <!-- submit -->\n            <table class=\"table\">\n              <tr>\n                <td style=\"width:22%\">&nbsp;</td>\n                <td style=\"width:78%\">\n                  <input id=\"submit\" name=\"save\" type=\"submit\" class=\"btn btn-primary\" value=\"<?=html_safe(gettext('Save'));?>\" />\n                </td>\n              </tr>\n            </table>\n          </form>\n          <!--- CSR --->\n<?php\n          elseif ($act == \"csr\") :\n?>\n\n          <form method=\"post\" name=\"iform\" id=\"iform\">\n            <input name=\"act\" type=\"hidden\" value=\"csr\" />\n<?php\n            if (isset($id)) :?>\n            <input name=\"id\" type=\"hidden\" value=\"<?=htmlspecialchars($id);?>\" />\n<?php\n            endif;?>\n            <table class=\"table table-striped\">\n              <tr>\n                <td style=\"width:22%\"><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Descriptive name\");?></td>\n                <td style=\"width:78%\">\n                  <input name=\"descr\" type=\"text\" id=\"descr\" readonly=\"readonly\" value=\"<?=$pconfig['descr'];?>\"/>\n                </td>\n              </tr>\n              <tr>\n                <td colspan=\"2\" class=\"list\" height=\"12\"></td>\n              </tr>\n              <tr>\n                <td colspan=\"2\"><?=gettext(\"Complete Signing Request\");?></td>\n              </tr>\n              <tr>\n                <td><?=gettext(\"Signing request data\");?></td>\n                <td>\n                  <textarea name=\"csr\" id=\"csr\" cols=\"65\" rows=\"7\" readonly=\"readonly\"><?=$pconfig['csr'];?></textarea>\n                  <br />\n                  <?=gettext(\"Copy the certificate signing data from here and forward it to your certificate authority for signing.\");?>\n                </td>\n              </tr>\n              <tr>\n                <td><?=gettext(\"Final certificate data\");?></td>\n                <td>\n                  <textarea name=\"cert\" id=\"cert\" cols=\"65\" rows=\"7\"><?=$pconfig['cert'];?></textarea>\n                  <br />\n                  <?=gettext(\"Paste the certificate received from your certificate authority here.\");?>\n                </td>\n              </tr>\n              <tr>\n                <td>&nbsp;</td>\n                <td>\n                  <input id=\"submit\" name=\"update\" type=\"submit\" class=\"btn btn-primary\" value=\"<?= html_safe(gettext('Update')) ?>\" />\n                </td>\n              </tr>\n            </table>\n          </form>\n          <!--- Download Private key -->\n<?php\n          elseif ($act == \"download_private_key\"):?>\n\n          <table class=\"table table-striped opnsense_standard_table_form\">\n            <thead>\n              <tr>\n                <th colspan=\"2\"><?= gettext('Certificate has been issued.'); ?></th>\n              </tr>\n            </thead>\n            <tbody>\n                <tr>\n                  <td><?= gettext('Private key'); ?></td>\n                  <td>\n                    <textarea id=\"secret_key_for_cert\" cols=\"65\" rows=\"7\" data-filename=\"privatekey.pem\"><?= $pconfig['private_key']; ?></textarea>\n                    <small><?= gettext('The private key is not saved and no longer downloadable after closing this window.'); ?><br/></small>\n                    <a href=\"#\" for=\"secret_key_for_cert\" id=\"download_private_key_link\" class=\"btn btn-primary text_download_btn\">\n                      <?= gettext('Download Private Key'); ?>\n                    </a>\n                  </td>\n                </tr>\n                <tr>\n                  <td><?= gettext('Certificate'); ?></td>\n                  <td>\n                    <textarea id=\"cert_just_created\" cols=\"65\" rows=\"7\" data-filename=\"certificate.pem\"><?= html_safe(base64_decode($cert['crt'])); ?></textarea>\n                    <small><?= gettext('You can download, revise, or add to CRL later.'); ?><br/></small>\n                    <a href=\"#\" for=\"cert_just_created\" id=\"download_cert_link\" class=\"btn btn-primary text_download_btn\"><?= gettext('Download Certificate'); ?></a>\n                  </td>\n                </tr>\n                <tr>\n                    <td></td>\n                    <td>\n                      <a href=\"/system_certmanager.php\" class=\"btn btn-primary\"><?= gettext('Go back'); ?></a>\n                    </td>\n                </tr>\n            </tbody>\n          </table>\n\n<?php\n          else :?>\n          <form method=\"post\" name=\"iform\" id=\"iform\">\n            <input type=\"hidden\" name=\"id\" id=\"id\" value=\"<?=isset($id) ? $id :\"\";?>\"/>\n            <input type=\"hidden\" name=\"act\" id=\"action\" value=\"<?=$act;?>\"/>\n          </form>\n          <table class=\"table table-striped\">\n            <thead>\n              <tr>\n                <th><?=gettext(\"Name\");?></th>\n                <th><?=gettext(\"Issuer\");?></th>\n                <th><?=gettext(\"Distinguished Name\");?></th>\n                <th class=\"text-nowrap\">\n                  <a href=\"system_certmanager.php?act=new\" class=\"btn btn-primary btn-xs\" data-toggle=\"tooltip\" title=\"<?= html_safe(gettext('Add')) ?>\">\n                    <i class=\"fa fa-plus fa-fw\"></i>\n                  </a>\n                </th>\n              </tr>\n            </thead>\n            <tbody>\n<?php\n            $i = 0;\n            foreach ($a_cert as $cert) :\n                $name = $cert['descr'];\n                $purpose = null;\n\n                if (!empty($cert['crt'])) {\n                    $subj = cert_get_subject($cert['crt']);\n                    $issuer = cert_get_issuer($cert['crt']);\n                    $purpose = cert_get_purpose($cert['crt']);\n                    list($startdate, $enddate) = cert_get_dates($cert['crt']);\n                    if ($subj==$issuer) {\n                        $caname = \"<em>\" . gettext(\"self-signed\") . \"</em>\";\n                    } else {\n                        $caname = \"<em>\" . gettext(\"external\"). \"</em>\";\n                    }\n                    $subj = htmlspecialchars($subj);\n                }\n                if (isset($cert['csr'])) {\n                    $subj = htmlspecialchars(csr_get_subject($cert['csr']));\n                    $caname = \"<em>\" . gettext(\"external - signature pending\") . \"</em>\";\n                }\n                if (isset($cert['caref'])) {\n                    $ca = lookup_ca($cert['caref']);\n                    if ($ca) {\n                        $caname = $ca['descr'];\n                    }\n                }?>\n              <tr>\n                <td>\n                  <i class=\"fa fa-certificate\"></i>\n                  <?=$name;?>\n<?php\n                  if (is_array($purpose)) :?>\n                  <br/><br/>\n                  <?=gettext('CA:') ?> <?=$purpose['ca']; ?>,\n                  <?=gettext('Server:') ?> <?=$purpose['server']; ?>\n<?php\n                  endif; ?>\n                </td>\n                <td><?=$caname;?>&nbsp;</td>\n                <td><?=$subj;?>&nbsp;<br />\n                  <table>\n                      <tr>\n                          <td style=\"width:10%\">&nbsp;</td>\n                          <td style=\"width:20%\"><?=gettext(\"Valid From\")?>:</td>\n                          <td style=\"width:70%\"><?= $startdate ?></td>\n                      </tr>\n                      <tr>\n                          <td>&nbsp;</td>\n                          <td><?=gettext(\"Valid Until\")?>:</td>\n                          <td><?= $enddate ?></td>\n                      </tr>\n                  </table>\n                </td>\n                <td class=\"text-nowrap\">\n<?php\n                if (is_cert_revoked($cert)) :?>\n                  <b><?=gettext('Revoked') ?></b><br />\n<?php\n                endif;\n                if (!isset($cert['prv'])) :?>\n                  <b><?=gettext('No private key here') ?></b><br />\n<?php\n                endif;\n                if (is_webgui_cert($cert['refid'])) :?>\n                  <?=gettext('Web GUI') ?><br />\n<?php\n                endif;\n                if (is_user_cert($cert['refid'])) :?>\n                  <?=gettext('User Cert') ?><br />\n<?php\n                endif;\n                if (is_openvpn_server_cert($cert['refid'])) :?>\n                  <?=gettext('OpenVPN Server') ?><br />\n<?php\n                endif;\n                if (is_openvpn_client_cert($cert['refid'])) :?>\n                  <?=gettext('OpenVPN Client') ?><br />\n<?php\n                endif;\n                if (is_ipsec_cert($cert['refid'])) :?>\n                  <?=gettext('IPsec Tunnel') ?><br />\n<?php\n                endif; ?>\n\n<?php if (isset($cert['crt'])): ?>\n                  <a href=\"#\" class=\"btn btn-default btn-xs act_info\" data-id=\"<?=$i;?>\" data-toggle=\"tooltip\" title=\"<?=gettext(\"show certificate info\");?>\">\n                    <i class=\"fa fa-info-circle fa-fw\"></i>\n                  </a>\n<?php endif ?>\n                  <a href=\"system_certmanager.php?act=exp&amp;id=<?=$i;?>\" class=\"btn btn-default btn-xs\" data-toggle=\"tooltip\" title=\"<?=gettext(\"export user cert\");?>\">\n                      <i class=\"fa fa-download fa-fw\"></i>\n                  </a>\n<?php if (isset($cert['prv'])): ?>\n                  <a href=\"system_certmanager.php?act=key&amp;id=<?=$i;?>\" class=\"btn btn-default btn-xs\" data-toggle=\"tooltip\" title=\"<?=gettext(\"export user key\");?>\">\n                    <i class=\"fa fa-download fa-fw\"></i>\n                  </a>\n                  <a data-id=\"<?=$i;?>\"  class=\"btn btn-default btn-xs p12btn\" data-toggle=\"tooltip\" title=\"<?=gettext(\"export ca+user cert+user key in .p12 format\");?>\">\n                      <i class=\"fa fa-download fa-fw\"></i>\n                  </a>\n<?php endif ?>\n<?php if (!cert_in_use($cert['refid'])): ?>\n                  <a id=\"del_<?=$i;?>\" data-id=\"<?=$i;?>\" title=\"<?=gettext(\"delete cert\"); ?>\" data-toggle=\"tooltip\"  class=\"act_delete btn btn-default btn-xs\">\n                    <i class=\"fa fa-trash fa-fw\"></i>\n                  </a>\n<?php endif ?>\n<?php if (isset($cert['csr'])): ?>\n                  <a href=\"system_certmanager.php?act=csr&amp;id=<?=$i;?>\" class=\"btn btn-default btn-xs\" data-toggle=\"tooltip\" title=\"<?=gettext(\"update csr\");?>\">\n                    <i class=\"fa fa-pencil fa-fw\"></i>\n                  </a>\n<?php endif ?>\n                </td>\n              </tr>\n<?php\n              $i++;\n              endforeach; ?>\n\n            </tbody>\n          </table>\n<?php\n          endif; ?>\n        </div>\n      </section>\n    </div>\n  </div>\n</section>\n<?php include(\"foot.inc\");\n"], "fixing_code": ["<?php\n\n/*\n * Copyright (C) 2014-2015 Deciso B.V.\n * Copyright (C) 2008 Shrew Soft Inc. <mgrooms@shrew.net>\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without\n * modification, are permitted provided that the following conditions are met:\n *\n * 1. Redistributions of source code must retain the above copyright notice,\n *    this list of conditions and the following disclaimer.\n *\n * 2. Redistributions in binary form must reproduce the above copyright\n *    notice, this list of conditions and the following disclaimer in the\n *    documentation and/or other materials provided with the distribution.\n *\n * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES,\n * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY\n * AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE\n * AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY,\n * OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF\n * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS\n * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN\n * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n * POSSIBILITY OF SUCH DAMAGE.\n */\n\nrequire_once(\"guiconfig.inc\");\nrequire_once(\"system.inc\");\n\nfunction ca_import(& $ca, $str, $key=\"\", $serial=0)\n{\n    global $config;\n\n    $ca['crt'] = base64_encode($str);\n    if (!empty($key)) {\n        $ca['prv'] = base64_encode($key);\n    }\n    if (!empty($serial)) {\n        $ca['serial'] = $serial;\n    }\n    $subject = cert_get_subject($str, false);\n    $issuer = cert_get_issuer($str, false);\n\n    // Find my issuer unless self-signed\n    if ($issuer != $subject) {\n        $issuer_crt =& lookup_ca_by_subject($issuer);\n        if ($issuer_crt) {\n            $ca['caref'] = $issuer_crt['refid'];\n        }\n    }\n\n    /* Correct if child certificate was loaded first */\n    if (is_array($config['ca'])) {\n        foreach ($config['ca'] as & $oca) {\n            $issuer = cert_get_issuer($oca['crt']);\n            if ($ca['refid'] != $oca['refid'] && $issuer == $subject) {\n                $oca['caref'] = $ca['refid'];\n            }\n        }\n    }\n    if (is_array($config['cert'])) {\n        foreach ($config['cert'] as & $cert) {\n            $issuer = cert_get_issuer($cert['crt']);\n            if ($issuer == $subject) {\n                $cert['caref'] = $ca['refid'];\n            }\n        }\n    }\n    return true;\n}\n\nfunction ca_inter_create(&$ca, $keylen_curve, $lifetime, $dn, $caref, $digest_alg = 'sha256')\n{\n    // Create Intermediate Certificate Authority\n    $signing_ca = &lookup_ca($caref);\n    if (!$signing_ca) {\n        return false;\n    }\n\n    $signing_ca_res_crt = openssl_x509_read(base64_decode($signing_ca['crt']));\n    $signing_ca_res_key = openssl_pkey_get_private(array(0 => base64_decode($signing_ca['prv']) , 1 => \"\"));\n    if (!$signing_ca_res_crt || !$signing_ca_res_key) {\n        return false;\n    }\n    $signing_ca_serial = ++$signing_ca['serial'];\n\n    $args = array(\n        'config' => '/usr/local/etc/ssl/opnsense.cnf',\n        'x509_extensions' => 'v3_ca',\n        'digest_alg' => $digest_alg,\n        'encrypt_key' => false\n    );\n    if (is_numeric($keylen_curve)) {\n        $args['private_key_type'] = OPENSSL_KEYTYPE_RSA;\n        $args['private_key_bits'] = (int)$keylen_curve;\n    } else {\n        $args['private_key_type'] = OPENSSL_KEYTYPE_EC;\n        $args['curve_name'] = $keylen_curve;\n    }\n\n    // generate a new key pair\n    $res_key = openssl_pkey_new($args);\n    if (!$res_key) {\n        return false;\n    }\n\n    // generate a certificate signing request\n    $res_csr = openssl_csr_new($dn, $res_key, $args);\n    if (!$res_csr) {\n        return false;\n    }\n\n    // Sign the certificate\n    $res_crt = openssl_csr_sign($res_csr, $signing_ca_res_crt, $signing_ca_res_key, $lifetime, $args, $signing_ca_serial);\n    if (!$res_crt) {\n        return false;\n    }\n\n    // export our certificate data\n    if (!openssl_pkey_export($res_key, $str_key) ||\n        !openssl_x509_export($res_crt, $str_crt)) {\n        return false;\n    }\n\n    // return our ca information\n    $ca['crt'] = base64_encode($str_crt);\n    $ca['caref'] = $caref;\n    $ca['prv'] = base64_encode($str_key);\n    $ca['serial'] = 0;\n\n    return true;\n}\n\n$ca_keylens = array( \"512\", \"1024\", \"2048\", \"3072\", \"4096\", \"8192\");\n$ca_curves = array( \"prime256v1\", \"secp384r1\", \"secp521r1\");\n$openssl_digest_algs = array(\"sha1\", \"sha224\", \"sha256\", \"sha384\", \"sha512\");\n$a_ca = &config_read_array('ca');\n$a_cert = &config_read_array('cert');\n$a_crl = &config_read_array('crl');\n\nif ($_SERVER['REQUEST_METHOD'] === 'GET') {\n    if (isset($a_ca[$_GET['id']])) {\n        $id = $_GET['id'];\n    }\n\n    if (isset($_GET['act'])) {\n        $act = $_GET['act'];\n    } else {\n        $act = null;\n    }\n\n    // set defaults\n    $pconfig = array();\n    $pconfig['camethod'] = null ;\n    $pconfig['descr'] = null;\n    $pconfig['serial'] = null;\n    $pconfig['lifetime'] = null;\n    $pconfig['dn_country'] = null;\n    $pconfig['dn_state'] = null;\n    $pconfig['dn_city'] = null;\n    $pconfig['dn_organization'] = null;\n    $pconfig['dn_email'] = null;\n    $pconfig['dn_commonname'] = null;\n\n    if ($act == \"edit\") {\n        if (!isset($id)) {\n            header(url_safe('Location: /system_camanager.php'));\n            exit;\n        }\n        $pconfig['descr'] = $a_ca[$id]['descr'];\n        $pconfig['refid'] = $a_ca[$id]['refid'];\n        $pconfig['cert'] = base64_decode($a_ca[$id]['crt']);\n        $pconfig['serial'] = $a_ca[$id]['serial'] + 1;\n        if (!empty($a_ca[$id]['prv'])) {\n            $pconfig['key'] = base64_decode($a_ca[$id]['prv']);\n        }\n    } elseif ($act == \"new\") {\n        if (isset($_GET['method'])) {\n            $pconfig['camethod'] = $_GET['method'];\n        }\n        $pconfig['refid'] = null;\n        $pconfig['keytype'] = \"RSA\";\n        $pconfig['keylen'] = \"2048\";\n        $pconfig['digest_alg'] = \"sha256\";\n        $pconfig['lifetime'] = \"825\";\n        $pconfig['dn_commonname'] = \"internal-ca\";\n    } elseif ($act == \"exp\") {\n        if (!isset($id)) {\n            header(url_safe('Location: /system_camanager.php'));\n            exit;\n        }\n\n        $exp_name = urlencode(\"{$a_ca[$id]['descr']}.crt\");\n        $exp_data = base64_decode($a_ca[$id]['crt']);\n        $exp_size = strlen($exp_data);\n\n        header(\"Content-Type: application/octet-stream\");\n        header(\"Content-Disposition: attachment; filename={$exp_name}\");\n        header(\"Content-Length: $exp_size\");\n        echo $exp_data;\n        exit;\n    } elseif ($act == \"expkey\") {\n        if (!isset($id)) {\n            header(url_safe('Location: /system_camanager.php'));\n            exit;\n        }\n\n        $exp_name = urlencode(\"{$a_ca[$id]['descr']}.key\");\n        $exp_data = base64_decode($a_ca[$id]['prv']);\n        $exp_size = strlen($exp_data);\n\n        header(\"Content-Type: application/octet-stream\");\n        header(\"Content-Disposition: attachment; filename={$exp_name}\");\n        header(\"Content-Length: $exp_size\");\n        echo $exp_data;\n        exit;\n    }\n} elseif ($_SERVER['REQUEST_METHOD'] === 'POST') {\n    if (isset($a_ca[$_POST['id']])) {\n        $id = $_POST['id'];\n    }\n    if (isset($_POST['act'])) {\n        $act = $_POST['act'];\n    } else {\n        $act = null;\n    }\n\n    if ($act == \"del\") {\n        if (!isset($id)) {\n            header(url_safe('Location: /system_camanager.php'));\n            exit;\n        }\n        $index = count($a_cert) - 1;\n        for (; $index >=0; $index--) {\n            if (isset($a_cert[$index]['caref']) && isset($a_ca[$id]['refid']) && $a_cert[$index]['caref'] == $a_ca[$id]['refid']) {\n                unset($a_cert[$index]);\n            }\n        }\n\n        $index = count($a_crl) - 1;\n        for (; $index >=0; $index--) {\n            if ($a_crl[$index]['caref'] == $a_ca[$id]['refid']) {\n                unset($a_crl[$index]);\n            }\n        }\n\n        unset($a_ca[$id]);\n        write_config();\n        system_trust_configure();\n        header(url_safe('Location: /system_camanager.php'));\n        exit;\n    } else {\n        $input_errors = array();\n        $pconfig = $_POST;\n\n        /* input validation */\n        if ($pconfig['camethod'] == \"existing\") {\n            $reqdfields = explode(\" \", \"descr cert\");\n            $reqdfieldsn = array(\n                    gettext(\"Descriptive name\"),\n                    gettext(\"Certificate data\"));\n            if (!empty($pconfig['cert']) && (!strstr($pconfig['cert'], \"BEGIN CERTIFICATE\") || !strstr($pconfig['cert'], \"END CERTIFICATE\"))) {\n                $input_errors[] = gettext(\"This certificate does not appear to be valid.\");\n            }\n            if (!empty($pconfig['key']) && strstr($pconfig['key'], \"ENCRYPTED\")) {\n                $input_errors[] = gettext(\"Encrypted private keys are not yet supported.\");\n            }\n        } elseif ($pconfig['camethod'] == \"internal\") {\n            $reqdfields = explode(\n                \" \",\n                \"descr keytype keylen curve digest_alg lifetime dn_country dn_state dn_city \".\n                \"dn_organization dn_email dn_commonname\"\n            );\n            $reqdfieldsn = array(\n                    gettext(\"Descriptive name\"),\n                    gettext(\"Key type\"),\n                    gettext(\"Key length\"),\n                    gettext(\"Curve\"),\n                    gettext(\"Digest algorithm\"),\n                    gettext(\"Lifetime\"),\n                    gettext(\"Distinguished name Country Code\"),\n                    gettext(\"Distinguished name State or Province\"),\n                    gettext(\"Distinguished name City\"),\n                    gettext(\"Distinguished name Organization\"),\n                    gettext(\"Distinguished name Email Address\"),\n                    gettext(\"Distinguished name Common Name\"));\n        } elseif ($pconfig['camethod'] == \"intermediate\") {\n            $reqdfields = explode(\n                \" \",\n                \"descr caref keytype keylen curve digest_alg lifetime dn_country dn_state dn_city \".\n                \"dn_organization dn_email dn_commonname\"\n            );\n            $reqdfieldsn = array(\n                    gettext(\"Descriptive name\"),\n                    gettext(\"Signing Certificate Authority\"),\n                    gettext(\"Key type\"),\n                    gettext(\"Key length\"),\n                    gettext(\"Curve\"),\n                    gettext(\"Digest algorithm\"),\n                    gettext(\"Lifetime\"),\n                    gettext(\"Distinguished name Country Code\"),\n                    gettext(\"Distinguished name State or Province\"),\n                    gettext(\"Distinguished name City\"),\n                    gettext(\"Distinguished name Organization\"),\n                    gettext(\"Distinguished name Email Address\"),\n                    gettext(\"Distinguished name Common Name\"));\n        }\n\n        do_input_validation($pconfig, $reqdfields, $reqdfieldsn, $input_errors);\n        if ($pconfig['camethod'] != \"existing\") {\n            /* Make sure we do not have invalid characters in the fields for the certificate */\n            for ($i = 0; $i < count($reqdfields); $i++) {\n                if ($reqdfields[$i] == 'dn_email') {\n                    if (preg_match(\"/[\\!\\#\\$\\%\\^\\(\\)\\~\\?\\>\\<\\&\\/\\\\\\,\\\"\\']/\", $pconfig[\"dn_email\"])) {\n                        $input_errors[] = gettext(\"The field 'Distinguished name Email Address' contains invalid characters.\");\n                    }\n                } elseif ($reqdfields[$i] == 'dn_commonname') {\n                    if (preg_match(\"/[\\!\\@\\#\\$\\%\\^\\(\\)\\~\\?\\>\\<\\&\\/\\\\\\,\\\"\\']/\", $pconfig[\"dn_commonname\"])) {\n                        $input_errors[] = gettext(\"The field 'Distinguished name Common Name' contains invalid characters.\");\n                    }\n                } elseif ($reqdfields[$i] == \"dn_organization\") {\n                    if (preg_match(\"/[\\!\\#\\$\\%\\^\\(\\)\\~\\?\\>\\<\\&\\/\\\\\\\"\\']/\", $pconfig[\"dn_organization\"])) {\n                        $input_errors[] = sprintf(gettext(\"The field '%s' contains invalid characters.\"), $reqdfieldsn[$i]);\n                    }\n                } elseif ($reqdfields[$i] != \"descr\" && preg_match(\"/[\\!\\@\\#\\$\\%\\^\\(\\)\\~\\?\\>\\<\\&\\/\\\\\\,\\\"\\']/\", $pconfig[\"$reqdfields[$i]\"])) {\n                    $input_errors[] = sprintf(gettext(\"The field '%s' contains invalid characters.\"), $reqdfieldsn[$i]);\n                }\n            }\n            if (!in_array($pconfig[\"keytype\"], array(\"RSA\", \"Elliptic Curve\"))) {\n                $input_errors[] = gettext(\"Please select a valid Key Type.\");\n            }\n            if (!in_array($pconfig['keylen'], $ca_keylens) && $pconfig[\"keytype\"] == \"RSA\") {\n                $input_errors[] = gettext(\"Please select a valid Key Length.\");\n            }\n            if (!in_array($pconfig['curve'], $ca_curves) && $pconfig[\"keytype\"] == \"Elliptic Curve\") {\n                $input_errors[] = gettext(\"Please select a valid Curve.\");\n            }\n            if (!in_array($pconfig[\"digest_alg\"], $openssl_digest_algs)) {\n                $input_errors[] = gettext(\"Please select a valid Digest Algorithm.\");\n            }\n        }\n\n        if (isset($pconfig['serial']) && $pconfig['serial'] !== '' &&\n            ((string)((int)$pconfig['serial']) != $pconfig['serial'] || $pconfig['serial'] < 1)) {\n            $input_errors[] = gettext('The serial number must be a number greater than zero or left blank.');\n        }\n\n        /* save modifications */\n        if (count($input_errors) == 0) {\n            $ca = array();\n\n            if (isset($id)) {\n                $ca = $a_ca[$id];\n            } else {\n                $ca['refid'] = uniqid();\n            }\n\n            if (isset($pconfig['descr'])) {\n                $ca['descr'] = $pconfig['descr'];\n            } else {\n                $ca['descr'] = null;\n            }\n\n            if (!empty($pconfig['serial'])) {\n                $ca['serial'] = $pconfig['serial'] - 1;\n            }\n\n            if (isset($id)) {\n                // edit existing\n                $ca['crt'] = base64_encode($pconfig['cert']);\n                if (!empty($pconfig['key'])) {\n                    $ca['prv'] = base64_encode($pconfig['key']);\n                }\n            } else {\n                $old_err_level = error_reporting(0); /* otherwise openssl_ functions throw warnings directly to a page screwing menu tab */\n                if ($pconfig['keytype'] == \"Elliptic Curve\") {\n                    $pconfig['keylen_curve'] = $pconfig['curve'];\n                } else {\n                    $pconfig['keylen_curve'] = $pconfig['keylen'];\n                }\n                if ($pconfig['camethod'] == \"existing\") {\n                    ca_import($ca, $pconfig['cert'], $pconfig['key'], $pconfig['serial']);\n                } elseif ($pconfig['camethod'] == \"internal\") {\n                    $dn = array(\n                        'countryName' => $pconfig['dn_country'],\n                        'stateOrProvinceName' => $pconfig['dn_state'],\n                        'localityName' => $pconfig['dn_city'],\n                        'organizationName' => $pconfig['dn_organization'],\n                        'emailAddress' => $pconfig['dn_email'],\n                        'commonName' => $pconfig['dn_commonname']);\n                    if (!ca_create($ca, $pconfig['keylen_curve'], $pconfig['lifetime'], $dn, $pconfig['digest_alg'])) {\n                        $input_errors = array();\n                        while ($ssl_err = openssl_error_string()) {\n                            $input_errors[] = gettext(\"openssl library returns:\") . \" \" . $ssl_err;\n                        }\n                    }\n                } elseif ($pconfig['camethod'] == \"intermediate\") {\n                    $dn = array(\n                        'countryName' => $pconfig['dn_country'],\n                        'stateOrProvinceName' => $pconfig['dn_state'],\n                        'localityName' => $pconfig['dn_city'],\n                        'organizationName' => $pconfig['dn_organization'],\n                        'emailAddress' => $pconfig['dn_email'],\n                        'commonName' => $pconfig['dn_commonname']);\n                    if (!ca_inter_create($ca, $pconfig['keylen_curve'], $pconfig['lifetime'], $dn, $pconfig['caref'], $pconfig['digest_alg'])) {\n                        $input_errors = array();\n                        while ($ssl_err = openssl_error_string()) {\n                            $input_errors[] = gettext(\"openssl library returns:\") . \" \" . $ssl_err;\n                        }\n                    }\n                }\n                error_reporting($old_err_level);\n            }\n\n            if (isset($id) && $a_ca[$id]) {\n                $a_ca[$id] = $ca;\n            } else {\n                $a_ca[] = $ca;\n            }\n\n            if (count($input_errors) == 0) {\n                write_config();\n                system_trust_configure();\n                header(url_safe('Location: /system_camanager.php'));\n                exit;\n            }\n        }\n    }\n}\n\nlegacy_html_escape_form_data($pconfig);\n$act = htmlspecialchars($act,  ENT_QUOTES | ENT_HTML401);\n\ninclude(\"head.inc\");\n\n?>\n<body>\n  <script>\n  $( document ).ready(function() {\n    // delete entry\n    $(\".act_delete\").click(function(event){\n      event.preventDefault();\n      var id = $(this).data('id');\n      BootstrapDialog.show({\n        type:BootstrapDialog.TYPE_DANGER,\n        title: \"<?= gettext(\"Authorities\");?>\",\n        message: \"<?=gettext(\"Do you really want to delete this Certificate Authority and its CRLs, and unreference any associated certificates?\");?>\",\n        buttons: [{\n                  label: \"<?=gettext(\"No\");?>\",\n                  action: function(dialogRef) {\n                      dialogRef.close();\n                  }}, {\n                  label: \"<?=gettext(\"Yes\");?>\",\n                  action: function(dialogRef) {\n                    $(\"#id\").val(id);\n                    $(\"#action\").val(\"del\");\n                    $(\"#iform\").submit()\n                }\n              }]\n      });\n    });\n\n    $(\"#camethod\").change(function(){\n        $(\"#existing\").addClass(\"hidden\");\n        $(\"#internal\").addClass(\"hidden\");\n        $(\"#intermediate\").addClass(\"hidden\");\n        if ($(this).val() == \"existing\") {\n            $(\"#existing\").removeClass(\"hidden\");\n        } else if ($(this).val() == \"internal\") {\n            $(\"#internal\").removeClass(\"hidden\");\n        } else {\n            $(\"#internal\").removeClass(\"hidden\");\n            $(\"#intermediate\").removeClass(\"hidden\");\n        }\n    });\n\n    $(\"#camethod\").change();\n\n    $(\"#keytype\").change(function(){\n        $(\"#EC\").addClass(\"hidden\");\n        $(\"#RSA\").addClass(\"hidden\");\n        $(\"#blank\").addClass(\"hidden\");\n        if ($(this).val() == \"Elliptic Curve\") {\n            $(\"#EC\").removeClass(\"hidden\");\n        } else {\n            $(\"#RSA\").removeClass(\"hidden\");\n        }\n    });\n\n    $(\"#keytype\").change();\n  });\n  </script>\n\n<?php include(\"fbegin.inc\"); ?>\n\n<section class=\"page-content-main\">\n  <div class=\"container-fluid\">\n    <div class=\"row\">\n<?php\n    if (isset($input_errors) && count($input_errors) > 0) {\n        print_input_errors($input_errors);\n    }\n    if (isset($savemsg)) {\n        print_info_box($savemsg);\n    }\n?>\n    <section class=\"col-xs-12\">\n      <div class=\"content-box tab-content table-responsive\">\n\n        <?php if ($act == \"new\" || $act == \"edit\") :\n?>\n\n        <form method=\"post\" name=\"iform\" id=\"iform\">\n          <input type=\"hidden\" name=\"id\" id=\"id\" value=\"<?=isset($id) ? $id :\"\";?>\"/>\n          <input type=\"hidden\" name=\"act\" id=\"action\" value=\"<?=$act;?>\"/>\n          <table class=\"table table-striped opnsense_standard_table_form\">\n            <tr>\n              <td style=\"width:22%\"></td>\n              <td style=\"width:78%; text-align:right\">\n                <small><?=gettext(\"full help\"); ?> </small>\n                <i class=\"fa fa-toggle-off text-danger\"  style=\"cursor: pointer;\" id=\"show_all_help_page\"></i>\n              </td>\n            </tr>\n            <tr>\n              <td><?=gettext(\"Descriptive name\");?></td>\n              <td>\n                <input name=\"descr\" type=\"text\" id=\"descr\" size=\"20\" value=\"<?=$pconfig['descr'];?>\"/>\n              </td>\n            </tr>\n            <tr class=\"<?=isset($id) ? \"hidden\" : \"\";?>\">\n              <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Method\");?></td>\n              <td>\n                <select name='camethod' id='camethod' class=\"selectpicker\" data-style=\"btn-default\">\n                  <option value=\"existing\" <?=$pconfig['camethod'] == \"existing\" ? \"selected=\\\"selected\\\"\" : \"\";?>>\n                    <?=gettext(\"Import an existing Certificate Authority\");?>\n                  </option>\n                  <option value=\"internal\" <?=$pconfig['camethod'] == \"internal\" ? \"selected=\\\"selected\\\"\" : \"\";?>>\n                    <?=gettext(\"Create an internal Certificate Authority\");?>\n                  </option>\n                  <option value=\"intermediate\" <?=$pconfig['camethod'] == \"intermediate\" ? \"selected=\\\"selected\\\"\" : \"\";?>>\n                    <?=gettext(\"Create an intermediate Certificate Authority\");?>\n                  </option>\n                </select>\n              </td>\n            </tr>\n          </table>\n          <!-- existing ca -->\n          <table id=\"existing\" class=\"table table-striped opnsense_standard_table_form\">\n            <thead>\n              <tr>\n                <th colspan=\"2\"><?=gettext(\"Existing Certificate Authority\");?></th>\n              </tr>\n            </thead>\n            <tbody>\n              <tr>\n                <td style=\"width:22%\"><a id=\"help_for_cert\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Certificate data\");?></td>\n                <td style=\"width:78%\">\n                  <textarea name=\"cert\" cols=\"65\" rows=\"7\" id=\"cert\"><?=isset($pconfig['cert']) ? $pconfig['cert'] : \"\";?></textarea>\n                  <div class=\"hidden\" data-for=\"help_for_cert\">\n                    <?=gettext(\"Paste a certificate in X.509 PEM format here.\");?>\n                  </div>\n                </td>\n              </tr>\n              <tr>\n                <td>\n                  <a id=\"help_for_key\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Certificate Private Key\");?><br />\n                  <?=gettext(\"(optional)\");?>\n                </td>\n                <td style=\"width:78%\">\n                  <textarea name=\"key\" id=\"key\" cols=\"65\" rows=\"7\"><?= isset($pconfig['key']) ? $pconfig['key'] : \"\";?></textarea>\n                  <div class=\"hidden\" data-for=\"help_for_key\">\n                    <?=gettext(\"Paste the private key for the above certificate here. This is optional in most cases, but required if you need to generate a Certificate Revocation List (CRL).\");?>\n                  </div>\n                </td>\n              </tr>\n              <tr>\n                <td><a id=\"help_for_serial\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Serial for next certificate\");?></td>\n                <td>\n                  <input name=\"serial\" type=\"text\" id=\"serial\" size=\"20\" value=\"<?=$pconfig['serial'];?>\"/>\n                  <div class=\"hidden\" data-for=\"help_for_serial\">\n                    <?=gettext(\"Enter a decimal number to be used as the serial number for the next certificate to be created using this CA.\");?>\n                  </div>\n                </td>\n              </tr>\n              </tbody>\n            </table>\n            <!-- internal ca -->\n            <table  id=\"internal\" class=\"table table-striped opnsense_standard_table_form\">\n              <thead>\n                <tr>\n                  <th colspan=\"2\"><?=gettext(\"Internal Certificate Authority\");?></th>\n                </tr>\n              </thead>\n              <tbody>\n                <tr id='intermediate'>\n                  <td style=\"width:22%\"> <i class=\"fa fa-info-circle text-muted\"></i>  <?=gettext(\"Signing Certificate Authority\");?></td>\n                  <td style=\"width:78%\">\n                    <select name='caref' id='caref' class=\"selectpicker\" onchange='internalca_change()'>\n<?php\n                    foreach ($a_ca as $ca) :\n                        if (!$ca['prv']) {\n                            continue;\n                        }?>\n                      <option value=\"<?=$ca['refid'];?>\"<?=isset($pconfig['caref']) && isset($ca['refid']) && $pconfig['caref'] == $ca['refid'] ? \" selected=\\\"selected\\\"\" :\"\" ;?>><?=htmlspecialchars($ca['descr']);?></option>\n<?php\n                    endforeach; ?>\n                    </select>\n                  </td>\n                </tr>\n                <tr>\n                  <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Key Type\");?></td>\n                  <td style=\"width:78%\">\n                    <select name='keytype' id='keytype' class=\"selectpicker\">\n                  <option value=\"RSA\" <?=$pconfig['keytype'] == \"RSA\" ? \"selected=\\\"selected\\\"\" : \"\";?>>\n                    <?=gettext(\"RSA\");?>\n                  </option>\n                  <option value=\"Elliptic Curve\" <?=$pconfig['keytype'] == \"Elliptic Curve\" ? \"selected=\\\"selected\\\"\" : \"\";?>>\n                    <?=gettext(\"Elliptic Curve\");?>\n                  </option>\n                    </select>\n                  </td>\n                </tr>\n                <tr id='RSA'>\n                  <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Key length\");?> (<?=gettext(\"bits\");?>)</td>\n                  <td style=\"width:78%\">\n                    <select name='keylen' id='keylen' class=\"selectpicker\">\n<?php\n                        foreach ($ca_keylens as $len) :?>\n                      <option value=\"<?=$len;?>\" <?=isset($pconfig['keylen']) && $pconfig['keylen'] == $len ? \"selected=\\\"selected\\\"\" : \"\";?>><?=$len;?></option>\n<?php\n                    endforeach; ?>\n                    </select>\n                  </td>\n                </tr>\n                <tr id='blank'><td></td></tr>\n                <tr id='EC'>\n                  <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Curve\");?></td>\n                  <td style=\"width:78%\">\n                    <select name='curve' id='curve' class=\"selectpicker\">\n<?php\n                    foreach ($ca_curves as $curve) :?>\n                      <option value=\"<?=$curve;?>\" <?=isset($pconfig['curve']) && $pconfig['curve'] == $curve ? \"selected=\\\"selected\\\"\" : \"\";?>><?=$curve;?></option>\n<?php\n                    endforeach; ?>\n                    </select>\n                  </td>\n                </tr>\n                <tr>\n                  <td><a id=\"help_for_digest_alg\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Digest Algorithm\");?></td>\n                  <td>\n                    <select name='digest_alg' id='digest_alg' class=\"selectpicker\">\n<?php\n                    foreach ($openssl_digest_algs as $digest_alg) :?>\n                      <option value=\"<?=$digest_alg;?>\" <?=isset($pconfig['digest_alg']) && $pconfig['digest_alg'] == $digest_alg ? \"selected=\\\"selected\\\"\" : \"\";?>><?=strtoupper($digest_alg);?></option>\n<?php\n                    endforeach; ?>\n                    </select>\n                    <div class=\"hidden\" data-for=\"help_for_digest_alg\">\n                      <?= gettext(\"NOTE: It is recommended to use an algorithm stronger than SHA1 when possible.\") ?>\n                    </div>\n                  </td>\n                </tr>\n                <tr>\n                  <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Lifetime\");?> (<?=gettext(\"days\");?>)</td>\n                  <td>\n                    <input name=\"lifetime\" type=\"text\" id=\"lifetime\"  value=\"<?=$pconfig['lifetime'];?>\"/>\n                  </td>\n                </tr>\n                <tr>\n                  <th colspan=\"2\"><?=gettext(\"Distinguished name\");?></th>\n                </tr>\n                <tr>\n                  <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Country Code\");?> : &nbsp;</td>\n                  <td>\n                      <select name=\"dn_country\" class=\"selectpicker\">\n<?php\n                      foreach (get_country_codes() as $cc => $cn):?>\n                        <option value=\"<?=$cc;?>\" <?=$pconfig['dn_country'] == $cc ? \"selected=\\\"selected\\\"\" : \"\";?>>\n                          <?=$cc;?> (<?=$cn;?>)\n                        </option>\n<?php\n                      endforeach;?>\n                      </select>\n                  </td>\n                </tr>\n                <tr>\n                  <td><a id=\"help_for_digest_dn_state\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"State or Province\");?> : &nbsp;</td>\n                  <td>\n                    <input name=\"dn_state\" type=\"text\" size=\"40\" value=\"<?=$pconfig['dn_state'];?>\"/>\n                    <div class=\"hidden\" data-for=\"help_for_digest_dn_state\">\n                      <em><?=gettext(\"ex:\");?></em>\n                      &nbsp;\n                      <?=gettext(\"Sachsen\");?>\n                    </div>\n                  </td>\n                </tr>\n                <tr>\n                  <td><a id=\"help_for_digest_dn_city\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"City\");?> : &nbsp;</td>\n                  <td>\n                    <input name=\"dn_city\" type=\"text\" size=\"40\" value=\"<?=$pconfig['dn_city'];?>\"/>\n                    <div class=\"hidden\" data-for=\"help_for_digest_dn_city\">\n                      <em><?=gettext(\"ex:\");?></em>\n                      &nbsp;\n                      <?=gettext(\"Leipzig\");?>\n                    </div>\n                  </td>\n                </tr>\n                <tr>\n                  <td><a id=\"help_for_digest_dn_organization\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Organization\");?> : &nbsp;</td>\n                  <td>\n                    <input name=\"dn_organization\" type=\"text\" size=\"40\" value=\"<?=$pconfig['dn_organization'];?>\"/>\n                    <div class=\"hidden\" data-for=\"help_for_digest_dn_organization\">\n                      <em><?=gettext(\"ex:\");?></em>\n                      &nbsp;\n                      <?=gettext(\"My Company Inc\");?>\n                    </div>\n                  </td>\n                </tr>\n                <tr>\n                  <td><a id=\"help_for_digest_dn_email\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Email Address\");?> : &nbsp;</td>\n                  <td>\n                    <input name=\"dn_email\" type=\"text\" size=\"25\" value=\"<?=$pconfig['dn_email'];?>\"/>\n                    <div class=\"hidden\" data-for=\"help_for_digest_dn_email\">\n                      <em><?=gettext(\"ex:\");?></em>\n                      &nbsp;\n                      <?=gettext(\"admin@mycompany.com\");?>\n                    </div>\n                  </td>\n                </tr>\n                <tr>\n                  <td><a id=\"help_for_digest_dn_commonname\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Common Name\");?> : &nbsp;</td>\n                  <td>\n                    <input name=\"dn_commonname\" type=\"text\" size=\"25\" value=\"<?=$pconfig['dn_commonname'];?>\"/>\n                    <div class=\"hidden\" data-for=\"help_for_digest_dn_commonname\">\n                      <em><?=gettext(\"ex:\");?></em>\n                      &nbsp;\n                      <?=gettext(\"internal-ca\");?>\n                    </div>\n                  </td>\n                </tr>\n              </tbody>\n            </table>\n\n            <table class=\"table opnsense_standard_table_form\">\n            <tr>\n              <td style=\"width:22%\">&nbsp;</td>\n              <td style=\"width:78%\">\n                <input id=\"submit\" name=\"save\" type=\"submit\" class=\"btn btn-primary\" value=\"<?=html_safe(gettext('Save')); ?>\" />\n              </td>\n            </tr>\n          </table>\n        </form>\n\n<?php\n        else :?>\n        <form method=\"post\" name=\"iform\" id=\"iform\">\n          <input type=\"hidden\" name=\"id\" id=\"id\" value=\"<?=isset($id) ? $id :\"\";?>\"/>\n          <input type=\"hidden\" name=\"act\" id=\"action\" value=\"<?=$act;?>\"/>\n        </form>\n        <table style=\"width:100%; border:0;\" class=\"table table-striped\">\n          <thead>\n            <tr>\n              <th><?=gettext(\"Name\");?></th>\n              <th><?=gettext(\"Internal\");?></th>\n              <th><?=gettext(\"Issuer\");?></th>\n              <th><?=gettext(\"Certificates\");?></th>\n              <th><?=gettext(\"Distinguished Name\");?></th>\n              <th class=\"text-nowrap\">\n                <a href=\"system_camanager.php?act=new\" class=\"btn btn-primary btn-xs\" data-toggle=\"tooltip\" title=\"<?= html_safe(gettext('Add')) ?>\">\n                  <i class=\"fa fa-plus fa-fw\"></i>\n                </a>\n              </th>\n            </tr>\n          </thead>\n          <tbody>\n<?php\n          $i = 0;\n          foreach ($a_ca as $ca) :\n              $issuer = htmlspecialchars(cert_get_issuer($ca['crt']));\n              $subj = htmlspecialchars(cert_get_subject($ca['crt']));\n              list($startdate, $enddate) = cert_get_dates($ca['crt']);\n              if ($subj == $issuer) {\n                  $issuer_name = \"<em>\" . gettext(\"self-signed\") . \"</em>\";\n              } else {\n                  $issuer_name = \"<em>\" . gettext(\"external\") . \"</em>\";\n              }\n\n              if (isset($ca['caref'])) {\n                  $issuer_ca = lookup_ca($ca['caref']);\n                  if ($issuer_ca) {\n                      $issuer_name = $issuer_ca['descr'];\n                  }\n              }\n\n              $certcount = 0;\n\n              foreach ($a_cert as $cert) {\n                  if ($cert['caref'] == $ca['refid']) {\n                      $certcount++;\n                  }\n              }\n\n              foreach ($a_ca as $cert) {\n                  if (isset($cert['caref'])) {\n                      if ($cert['caref'] == $ca['refid']) {\n                          $certcount++;\n                      }\n                  }\n              }\n?>\n            <tr>\n              <td><?=htmlspecialchars($ca['descr']);?></td>\n              <td><?=!empty($ca['prv']) ? gettext(\"YES\") : gettext(\"NO\");?>&nbsp;</td>\n              <td><?=$issuer_name;?>&nbsp;</td>\n              <td><?=$certcount;?>&nbsp;</td>\n              <td><?=$subj;?><br />\n                  <table style=\"width:100%; font-size: 9px\">\n                    <tr>\n                      <td>&nbsp;</td>\n                      <td style=\"width:20%\"><?=gettext(\"Valid From\")?>:</td>\n                      <td style=\"width:70%\"><?= $startdate ?></td>\n                    </tr>\n                    <tr>\n                      <td>&nbsp;</td>\n                      <td><?=gettext(\"Valid Until\")?>:</td>\n                      <td><?= $enddate ?></td>\n                    </tr>\n                  </table>\n                </td>\n                <td class=\"text-nowrap\">\n                  <a href=\"system_camanager.php?act=edit&amp;id=<?=$i;?>\" data-toggle=\"tooltip\" title=\"<?=gettext(\"edit CA\");?>\" class=\"btn btn-default btn-xs\">\n                    <i class=\"fa fa-pencil fa-fw\"></i>\n                  </a>\n                  <a href=\"system_camanager.php?act=exp&amp;id=<?=$i;?>\" data-toggle=\"tooltip\" title=\"<?=gettext(\"export CA cert\");?>\" class=\"btn btn-default btn-xs\">\n                    <i class=\"fa fa-download fa-fw\"></i>\n                  </a>\n<?php\n                  if ($ca['prv']) :?>\n                  <a href=\"system_camanager.php?act=expkey&amp;id=<?=$i;?>\" data-toggle=\"tooltip\" title=\"<?=gettext(\"export CA private key\");?>\" class=\"btn btn-default btn-xs\">\n                    <i class=\"fa fa-download fa-fw\"></i>\n                  </a>\n<?php\n                  endif; ?>\n                  <a id=\"del_<?=$i;?>\" data-id=\"<?=$i;?>\" title=\"<?=gettext(\"delete ca\"); ?>\" data-toggle=\"tooltip\"  class=\"act_delete btn btn-default btn-xs\">\n                    <i class=\"fa fa-trash fa-fw\"></i>\n                  </a>\n                </td>\n              </tr>\n<?php\n              $i++;\n              endforeach;?>\n            </tbody>\n          </table>\n<?php\n          endif; ?>\n        </div>\n      </section>\n    </div>\n  </div>\n</section>\n<?php include(\"foot.inc\");\n", "<?php\n\n/*\n * Copyright (C) 2014-2015 Deciso B.V.\n * Copyright (C) 2008 Shrew Soft Inc. <mgrooms@shrew.net>\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without\n * modification, are permitted provided that the following conditions are met:\n *\n * 1. Redistributions of source code must retain the above copyright notice,\n *    this list of conditions and the following disclaimer.\n *\n * 2. Redistributions in binary form must reproduce the above copyright\n *    notice, this list of conditions and the following disclaimer in the\n *    documentation and/or other materials provided with the distribution.\n *\n * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES,\n * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY\n * AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE\n * AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY,\n * OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF\n * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS\n * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN\n * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n * POSSIBILITY OF SUCH DAMAGE.\n */\n\nrequire_once('guiconfig.inc');\nrequire_once('system.inc');\n\nphpseclib_autoload('ParagonIE\\ConstantTime', '/usr/local/share/phpseclib/paragonie');\nphpseclib_autoload('phpseclib3', '/usr/local/share/phpseclib');\n\nuse phpseclib3\\File\\ASN1;\nuse phpseclib3\\File\\X509;\n\nfunction csr_generate(&$cert, $keylen_curve, $dn, $digest_alg, $extns)\n{\n    $configFilename = create_temp_openssl_config($extns);\n    $args = [\n        'config' => $configFilename,\n        'req_extensions' => 'v3_req',\n        'digest_alg' => $digest_alg,\n        'encrypt_key' => false\n    ];\n\n    if (is_numeric($keylen_curve)) {\n        $args['private_key_type'] = OPENSSL_KEYTYPE_RSA;\n        $args['private_key_bits'] = (int)$keylen_curve;\n    } else {\n        $args['private_key_type'] = OPENSSL_KEYTYPE_EC;\n        $args['curve_name'] = $keylen_curve;\n    }\n\n    // generate a new key pair\n    $res_key = openssl_pkey_new($args);\n    if (!$res_key) {\n        return false;\n    }\n\n    // generate a certificate signing request\n    $res_csr = openssl_csr_new($dn, $res_key, $args);\n    if (!$res_csr) {\n        return false;\n    }\n\n    // export our request data\n    if (!openssl_pkey_export($res_key, $str_key) ||\n        !openssl_csr_export($res_csr, $str_csr)) {\n        return false;\n    }\n\n    // return our request information\n    $cert['csr'] = base64_encode($str_csr);\n    $cert['prv'] = base64_encode($str_key);\n\n    unlink($configFilename);\n\n    return true;\n}\n\nfunction csr_complete(& $cert, $str_crt)\n{\n    // return our request information\n    $cert['crt'] = base64_encode($str_crt);\n    unset($cert['csr']);\n\n    return true;\n}\n\nfunction csr_get_modulus($str_crt, $decode = true)\n{\n    return cert_get_modulus($str_crt, $decode, 'csr');\n}\n\nfunction parse_csr($csr_str)\n{\n    $ret = array();\n    $ret['parse_success'] = true;\n    $ret['subject'] = openssl_csr_get_subject($csr_str);\n    if ($ret['subject'] === false) {\n        return array('parse_success' => false);\n    }\n\n    $x509_lib = new X509();\n    $csr = $x509_lib->loadCSR($csr_str);\n    if ($csr === false) {\n        return array('parse_success' => false);\n    }\n\n    foreach ($csr['certificationRequestInfo']['attributes'] as $attr) {\n        switch ($attr['type'] ) {\n            case 'pkcs-9-at-extensionRequest':\n                foreach ($attr['value'] as $value) {\n                    foreach ($value as $column) {\n                        switch ($column['extnId']) {\n                            case 'id-ce-basicConstraints':\n                                $ret['basicConstraints'] = array();\n                                $ret['basicConstraints']['CA'] = $column['extnValue']['cA'];\n                                if (isset($column['extnValue']['pathLenConstraint'])) {\n                                    $ret['basicConstraints']['pathlen'] = (int)($column['extnValue']['pathLenConstraint']->toString());\n                                }\n\n                                break;\n\n                            case 'id-ce-keyUsage':\n                                $ret['keyUsage'] = $column['extnValue'];\n                                break;\n\n                            case 'id-ce-extKeyUsage':\n                                $ret['extendedKeyUsage'] = array();\n                                foreach ($column['extnValue'] as $usage) {\n                                    array_push($ret['extendedKeyUsage'], strpos($usage, 'id-kp-') === 0 ? ASN1::getOID($usage) : $usage);\n                                }\n                                break;\n\n                            case 'id-ce-subjectAltName':\n                                $ret['subjectAltName'] = array();\n                                foreach ($column['extnValue'] as $item) {\n                                    if (isset($item['dNSName'])) {\n                                        array_push($ret['subjectAltName'], array('type'=> 'DNS', 'value'=> $item['dNSName']));\n                                    }\n                                    if (isset($item['iPAddress'])) {\n                                        array_push($ret['subjectAltName'], array('type'=> 'IP', 'value'=> $item['iPAddress']));\n                                    }\n                                    if (isset($item['rfc822Name'])) {\n                                        array_push($ret['subjectAltName'], array('type'=> 'email', 'value'=> $item['rfc822Name']));\n                                    }\n                                    if (isset($item['uniformResourceIdentifier'])) {\n                                        array_push($ret['subjectAltName'], array('type'=> 'URI', 'value'=> $item['uniformResourceIdentifier']));\n                                    }\n                                }\n                                break;\n\n                        }\n                    }\n                }\n                break; // case 'pkcs-9-at-extensionRequest'\n        }\n    }\n\n    return $ret;\n}\n\n// altname expects a type like the following:\n// array (\n//    'type'   => (string),\n//    'value': => (string)\n// )\n//\n// errors are added to $input_errors\n// returns true:  on success\n//         false: on error, with adding something to $input_errors.\nfunction is_valid_alt_value($altname, &$input_errors) {\n    switch ($altname['type']) {\n        case \"DNS\":\n            $dns_regex = '/^(?:(?:[a-z0-9_\\*]|[a-z0-9_][a-z0-9_\\-]*[a-z0-9_])\\.)*(?:[a-z0-9_]|[a-z0-9_][a-z0-9_\\-]*[a-z0-9_])$/i';\n            if (!preg_match($dns_regex, $altname['value'])) {\n                $input_errors[] = gettext(\"DNS subjectAltName values must be valid hostnames or FQDNs\");\n                return false;\n            }\n            return true;\n        case \"IP\":\n            if (!is_ipaddr($altname['value'])) {\n                $input_errors[] = gettext(\"IP subjectAltName values must be valid IP Addresses\");\n                return false;\n            }\n            return true;\n        case \"email\":\n            if (empty($altname['value'])) {\n                $input_errors[] = gettext(\"You must provide an email address for this type of subjectAltName\");\n                return false;\n            }\n            if (preg_match(\"/[\\!\\#\\$\\%\\^\\(\\)\\~\\?\\>\\<\\&\\/\\\\\\,\\\"\\']/\", $altname['value'])) {\n                $input_errors[] = gettext(\"The email provided in a subjectAltName contains invalid characters.\");\n                return false;\n            }\n            return true;\n        case \"URI\":\n            if (!is_URL($altname['value'])) {\n                $input_errors[] = gettext(\"URI subjectAltName types must be a valid URI\");\n                return false;\n            }\n            return true;\n        default:\n            $input_errors[] = gettext(\"Unrecognized subjectAltName type.\");\n            return false;\n    }\n\n}\n// types\n$cert_methods = array(\n    \"import\" => gettext(\"Import an existing Certificate\"),\n    \"internal\" => gettext(\"Create an internal Certificate\"),\n    \"external\" => gettext(\"Create a Certificate Signing Request\"),\n    \"sign_cert_csr\" => gettext(\"Sign a Certificate Signing Request\"),\n);\n$cert_keylens = array( \"512\", \"1024\", \"2048\", \"3072\", \"4096\", \"8192\");\n$cert_curves = array( \"prime256v1\", \"secp384r1\", \"secp521r1\");\n$openssl_digest_algs = array(\"sha1\", \"sha224\", \"sha256\", \"sha384\", \"sha512\");\n$cert_types = array('usr_cert', 'server_cert', 'combined_server_client', 'v3_ca');\n$key_usages = array(\n    // defined in RFC 5280 section 4.2.1.3\n    'digitalSignature' => gettext('digitalSignature'),\n    'nonRepudiation'   => gettext('nonRepudiation'),\n    'keyEncipherment'  => gettext('keyEncipherment'),\n    'dataEncipherment' => gettext('dataEncipherment'),\n    'keyAgreement'     => gettext('keyAgreement'),\n    'keyCertSign'      => gettext('keyCertSign'),\n    'cRLSign'          => gettext('cRLSign'),\n    'encipherOnly'     => gettext('encipherOnly'),\n    'decipherOnly'     => gettext('decipherOnly'),\n);\n$extended_key_usages = array(\n    // defined in RFC 5280 section 4.2.1.12\n    '1.3.6.1.5.5.7.3.1'  => gettext('serverAuth'),\n    '1.3.6.1.5.5.7.3.2'  => gettext('clientAuth'),\n    '1.3.6.1.5.5.7.3.3'  => gettext('codeSigning'),\n    '1.3.6.1.5.5.7.3.4'  => gettext('emailProtection'),\n    '1.3.6.1.5.5.7.3.8'  => gettext('timeStamping'),\n    '1.3.6.1.5.5.7.3.9'  => gettext('OCSPSigning'),\n\n    // added to support default options\n    '1.3.6.1.5.5.8.2.2'  => gettext('iKEIntermediate'),\n);\n\n// config reference pointers\n$a_user = &config_read_array('system', 'user');\n$a_ca = &config_read_array('ca');\n$a_cert = &config_read_array('cert');\n\n\n// handle user GET/POST data\nif ($_SERVER['REQUEST_METHOD'] === 'GET') {\n    if (isset($a_user[$_GET['userid']])) {\n        $userid = $_GET['userid'];\n        $cert_methods[\"existing\"] = gettext(\"Choose an existing certificate\");\n    }\n    if (isset($a_cert[$_GET['id']])) {\n        $id = $_GET['id'];\n    }\n\n    $act = isset($_GET['act']) ? $_GET['act'] : null;\n\n    $pconfig = array();\n    if ($act == \"new\") {\n        if (isset($_GET['method'])) {\n            $pconfig['certmethod'] = $_GET['method'];\n        } else {\n            $pconfig['certmethod'] = null;\n        }\n        if (isset($_GET['caref'])) {\n            $pconfig['caref'] = $_GET['caref'];\n        }\n        $pconfig['keytype'] = \"RSA\";\n        $pconfig['keylen'] = \"2048\";\n        $pconfig['digest_alg'] = \"sha256\";\n        $pconfig['digest_alg_sign_csr'] = \"sha256\";\n        $pconfig['csr_keytype'] = \"RSA\";\n        $pconfig['csr_keylen'] = \"2048\";\n        $pconfig['csr_digest_alg'] = \"sha256\";\n        $pconfig['lifetime'] = \"397\";\n        $pconfig['lifetime_sign_csr'] = \"397\";\n        $pconfig['cert_type'] = \"usr_cert\";\n        $pconfig['cert'] = null;\n        $pconfig['key'] = null;\n        $pconfig['dn_country'] = null;\n        $pconfig['dn_state'] = null;\n        $pconfig['dn_city'] = null;\n        $pconfig['dn_organization'] = null;\n        $pconfig['dn_email'] = null;\n\n        if (isset($userid)) {\n            $pconfig['descr'] = $a_user[$userid]['name'];\n            $pconfig['dn_commonname'] = $a_user[$userid]['name'];\n        } else {\n            $pconfig['descr'] = null;\n            $pconfig['dn_commonname'] = null;\n        }\n\n    } elseif ($act == \"exp\") {\n        // export cert\n        if (isset($id)) {\n            $exp_name = urlencode(\"{$a_cert[$id]['descr']}.crt\");\n            $exp_data = base64_decode($a_cert[$id]['crt']);\n            $exp_size = strlen($exp_data);\n\n            header(\"Content-Type: application/octet-stream\");\n            header(\"Content-Disposition: attachment; filename={$exp_name}\");\n            header(\"Content-Length: $exp_size\");\n            echo $exp_data;\n        }\n        exit;\n    } elseif ($act == \"key\") {\n        // export key\n        if (isset($id)) {\n            $exp_name = urlencode(\"{$a_cert[$id]['descr']}.key\");\n            $exp_data = base64_decode($a_cert[$id]['prv']);\n            $exp_size = strlen($exp_data);\n\n            header(\"Content-Type: application/octet-stream\");\n            header(\"Content-Disposition: attachment; filename={$exp_name}\");\n            header(\"Content-Length: $exp_size\");\n            echo $exp_data;\n        }\n        exit;\n    } elseif ($act == \"csr\") {\n        if (!isset($id)) {\n            header(url_safe('Location: /system_certmanager.php'));\n            exit;\n        }\n        $pconfig['descr'] = $a_cert[$id]['descr'];\n        $pconfig['csr'] = base64_decode($a_cert[$id]['csr']);\n        $pconfig['cert'] = null;\n    } elseif ($act == \"info\") {\n      if (isset($id)) {\n          header(\"Content-Type: text/plain;charset=UTF-8\");\n          // use openssl to dump cert in readable format\n          $process = proc_open('/usr/local/bin/openssl x509 -fingerprint -sha256 -text', array(array(\"pipe\", \"r\"), array(\"pipe\", \"w\")), $pipes);\n          if (is_resource($process)) {\n             fwrite($pipes[0], base64_decode($a_cert[$id]['crt']));\n             fclose($pipes[0]);\n\n             $result = stream_get_contents($pipes[1]);\n             fclose($pipes[1]);\n             proc_close($process);\n             echo $result;\n          }\n      }\n      exit;\n    }\n\n} elseif ($_SERVER['REQUEST_METHOD'] === 'POST') {\n    $pconfig = $_POST;\n    if (isset($a_cert[$_POST['id']])) {\n        $id = $_POST['id'];\n    }\n    if (isset($a_user[$_POST['userid']])) {\n        $userid = $_POST['userid'];\n    }\n    $act = isset($_POST['act']) ? $_POST['act'] : null;\n\n    if ($act == \"del\") {\n        if (isset($id)) {\n            unset($a_cert[$id]);\n            write_config();\n        }\n        header(url_safe('Location: /system_certmanager.php'));\n        exit;\n    } elseif ($act == 'csr_info') {\n      if (!isset($pconfig['csr'])) {\n        http_response_code(400);\n        header(\"Content-Type: text/plain;charset=UTF-8\");\n        echo gettext('Invalid request');\n        exit;\n      }\n\n      header(\"Content-Type: text/plain;charset=UTF-8\");\n      // use openssl to dump csr in readable format\n      $process = proc_open('/usr/local/bin/openssl req -text -noout', array(array(\"pipe\", \"r\"), array(\"pipe\", \"w\"), array(\"pipe\", \"w\")), $pipes);\n      if (is_resource($process)) {\n        fwrite($pipes[0], $pconfig['csr']);\n        fclose($pipes[0]);\n\n        $result_stdout = stream_get_contents($pipes[1]);\n        fclose($pipes[1]);\n\n        $result_stderr = stream_get_contents($pipes[2]);\n        fclose($pipes[2]);\n\n        proc_close($process);\n\n        echo $result_stdout;\n        echo $result_stderr;\n      }\n      exit;\n    } elseif ($act == 'csr_info_json') {\n      header(\"Content-Type: application/json;charset=UTF-8\");\n\n      if (!isset($pconfig['csr'])) {\n        http_response_code(400);\n        echo json_encode(array(\n          'error' => gettext('Invalid Request'),\n          'error_detail' => gettext('No csr parameter in query')\n        ));\n        exit;\n      }\n\n      $parsed_result = parse_csr($pconfig['csr']);\n\n      if ($parsed_result['parse_success'] !== true) {\n        http_response_code(400);\n        echo json_encode(array(\n          'error' => gettext('CSR file is invalid'),\n          'error_detail' => gettext('Could not parse CSR file.')\n        ));\n        exit;\n      }\n\n      echo json_encode($parsed_result);\n      exit;\n    } elseif ($act == \"p12\") {\n        // export cert+key in p12 format\n        if (isset($id)) {\n            $exp_name = urlencode(\"{$a_cert[$id]['descr']}.p12\");\n            $args = array();\n            $args['friendly_name'] = $a_cert[$id]['descr'];\n\n            $ca = lookup_ca($a_cert[$id]['caref']);\n            if ($ca) {\n                $args['extracerts'] = openssl_x509_read(base64_decode($ca['crt']));\n            }\n            set_error_handler (\n                function () {\n                    return;\n                }\n            );\n\n            $exp_data = '';\n            $res_crt = openssl_x509_read(base64_decode($a_cert[$id]['crt']));\n            $res_key = openssl_pkey_get_private(array(0 => base64_decode($a_cert[$id]['prv']) , 1 => ''));\n            $res_pw = !empty($pconfig['password']) ? $pconfig['password'] : null;\n            openssl_pkcs12_export($res_crt, $exp_data, $res_key, $res_pw, $args);\n            restore_error_handler();\n\n            $output = json_encode(array(\n              'filename' => $exp_name,\n              'content' => base64_encode($exp_data)\n            ));\n            header(\"Content-Type: application/json;charset=UTF-8\");\n            // header(\"Content-Length: \". strlen($output));\n            echo $output;\n        }\n        exit;\n    } elseif ($act == \"csr\") {\n        $input_errors = array();\n        $pconfig = $_POST;\n        if (!isset($id)) {\n            header(url_safe('Location: /system_certmanager.php'));\n            exit;\n        }\n\n        /* input validation */\n        $reqdfields = explode(\" \", \"descr cert\");\n        $reqdfieldsn = array(\n            gettext(\"Descriptive name\"),\n            gettext(\"Final Certificate data\"));\n\n        do_input_validation($_POST, $reqdfields, $reqdfieldsn, $input_errors);\n        $mod_csr  =  csr_get_modulus($pconfig['csr'], false);\n        $mod_cert = cert_get_modulus($pconfig['cert'], false);\n\n        if (strcmp($mod_csr, $mod_cert)) {\n            // simply: if the moduli don't match, then the private key and public key won't match\n            $input_errors[] = gettext(\"The certificate modulus does not match the signing request modulus.\");\n            $subject_mismatch = true;\n        }\n\n        /* save modifications */\n        if (count($input_errors) == 0) {\n            $cert = $a_cert[$id];\n            csr_complete($cert, $pconfig['cert']);\n\n            $a_cert[$id] = $cert;\n\n            write_config();\n\n            header(url_safe('Location: /system_certmanager.php'));\n            exit;\n        }\n    } elseif (!empty($_POST['save'])) {\n        $input_errors = array();\n        $act = isset($_GET['act']) ? $_GET['act'] : null;\n\n        /* input validation */\n        if ($pconfig['certmethod'] == \"import\") {\n            $reqdfields = explode(\" \", \"descr cert key\");\n            $reqdfieldsn = array(\n                    gettext(\"Descriptive name\"),\n                    gettext(\"Certificate data\"),\n                    gettext(\"Key data\"));\n            if (!empty($pconfig['cert']) && (!strstr($pconfig['cert'], \"BEGIN CERTIFICATE\") || !strstr($pconfig['cert'], \"END CERTIFICATE\"))) {\n                $input_errors[] = gettext(\"This certificate does not appear to be valid.\");\n            }\n        } elseif ($pconfig['certmethod'] == \"internal\") {\n            $reqdfields = explode(\" \", \"descr caref keytype keylen curve digest_alg lifetime dn_country dn_state dn_city \".\n                \"dn_organization dn_email dn_commonname\"\n            );\n            $reqdfieldsn = array(\n                    gettext(\"Descriptive name\"),\n                    gettext(\"Certificate authority\"),\n                    gettext(\"Key type\"),\n                    gettext(\"Key length\"),\n                    gettext(\"Curve\"),\n                    gettext(\"Digest algorithm\"),\n                    gettext(\"Lifetime\"),\n                    gettext(\"Distinguished name Country Code\"),\n                    gettext(\"Distinguished name State or Province\"),\n                    gettext(\"Distinguished name City\"),\n                    gettext(\"Distinguished name Organization\"),\n                    gettext(\"Distinguished name Email Address\"),\n                    gettext(\"Distinguished name Common Name\"));\n        } elseif ($pconfig['certmethod'] == \"external\") {\n            $reqdfields = explode(\" \", \"descr csr_keytype csr_keylen csr_curve csr_digest_alg csr_dn_country csr_dn_state csr_dn_city \".\n                \"csr_dn_organization csr_dn_email csr_dn_commonname\"\n            );\n            $reqdfieldsn = array(\n                    gettext(\"Descriptive name\"),\n                    gettext(\"Key type\"),\n                    gettext(\"Key length\"),\n                    gettext(\"Curve\"),\n                    gettext(\"Digest algorithm\"),\n                    gettext(\"Distinguished name Country Code\"),\n                    gettext(\"Distinguished name State or Province\"),\n                    gettext(\"Distinguished name City\"),\n                    gettext(\"Distinguished name Organization\"),\n                    gettext(\"Distinguished name Email Address\"),\n                    gettext(\"Distinguished name Common Name\"));\n        } elseif ($pconfig['certmethod'] == \"existing\") {\n            $reqdfields = array(\"certref\");\n            $reqdfieldsn = array(gettext(\"Existing Certificate Choice\"));\n        } elseif ($pconfig['certmethod'] == 'sign_cert_csr') {\n            $reqdfields = array('caref_sign_csr', 'csr', 'lifetime_sign_csr', 'digest_alg_sign_csr');\n            $reqdfieldsn = array(gettext(\"Certificate authority\"), gettext(\"CSR file\"), gettext(\"Lifetime\"), gettext(\"Digest Algorithm\"));\n        }\n\n        $altnames = array();\n        do_input_validation($pconfig, $reqdfields, $reqdfieldsn, $input_errors);\n        if (isset($pconfig['altname_value']) && $pconfig['certmethod'] != \"import\" && $pconfig['certmethod'] != \"existing\" && $pconfig['certmethod'] != 'sign_cert_csr') {\n            /* subjectAltNames */\n            foreach ($pconfig['altname_type'] as $altname_seq => $altname_type) {\n                if (!empty($pconfig['altname_value'][$altname_seq])) {\n                    $altnames[] = array(\"type\" => $altname_type, \"value\" => $pconfig['altname_value'][$altname_seq]);\n                }\n            }\n\n            /* Input validation for subjectAltNames */\n            foreach ($altnames as $altname) {\n                if (! is_valid_alt_value($altname, $input_errors)) {\n                    break;\n                }\n            }\n\n            /* Make sure we do not have invalid characters in the fields for the certificate */\n            for ($i = 0; $i < count($reqdfields); $i++) {\n                if (preg_match('/email/', $reqdfields[$i])) {\n                    /* dn_email or csr_dn_name */\n                    if (preg_match(\"/[\\!\\#\\$\\%\\^\\(\\)\\~\\?\\>\\<\\&\\/\\\\\\,\\\"\\']/\", $pconfig[$reqdfields[$i]])) {\n                        $input_errors[] = gettext(\"The field 'Distinguished name Email Address' contains invalid characters.\");\n                    }\n                } elseif (preg_match('/commonname/', $reqdfields[$i])) {\n                    /* dn_commonname or csr_dn_commonname */\n                    if (preg_match(\"/[\\!\\@\\#\\$\\%\\^\\(\\)\\~\\?\\>\\<\\&\\/\\\\\\,\\\"\\']/\", $pconfig[$reqdfields[$i]])) {\n                        $input_errors[] = gettext(\"The field 'Distinguished name Common Name' contains invalid characters.\");\n                    }\n                } elseif ($reqdfields[$i] == \"csr_dn_organization\" || $reqdfields[$i] == \"dn_organization\") {\n                    if (preg_match(\"/[\\!\\#\\$\\%\\^\\(\\)\\~\\?\\>\\<\\&\\/\\\\\\\"\\']/\", $pconfig[$reqdfields[$i]])) {\n                        $input_errors[] = sprintf(gettext(\"The field '%s' contains invalid characters.\"), $reqdfieldsn[$i]);\n                    }\n                } elseif ($reqdfields[$i] != \"descr\" && $reqdfields[$i] != \"csr\" && preg_match(\"/[\\!\\@\\#\\$\\%\\^\\(\\)\\~\\?\\>\\<\\&\\/\\\\\\,\\\"\\']/\", $pconfig[$reqdfields[$i]])) {\n                    $input_errors[] = sprintf(gettext(\"The field '%s' contains invalid characters.\"), $reqdfieldsn[$i]);\n                }\n            }\n\n            if ($pconfig['certmethod'] != \"external\" && !in_array($pconfig[\"keytype\"], array(\"RSA\", \"Elliptic Curve\"))) {\n                $input_errors[] = gettext(\"Please select a valid Key Type.\");\n            }\n            if ($pconfig['certmethod'] == \"internal\" && !in_array($pconfig[\"cert_type\"], $cert_types)) {\n                $input_errors[] = gettext(\"Please select a valid Type.\");\n            }\n            if ($pconfig['certmethod'] != \"external\" && isset($pconfig[\"keylen\"]) && $pconfig[\"keytype\"] == \"RSA\" && !in_array($pconfig[\"keylen\"], $cert_keylens)) {\n                $input_errors[] = gettext(\"Please select a valid Key Length.\");\n            }\n            if ($pconfig['certmethod'] != \"external\" && isset($pconfig[\"curve\"]) && $pconfig[\"keytype\"] == \"Elliptic Curve\" && !in_array($pconfig[\"curve\"], $cert_curves)) {\n                $input_errors[] = gettext(\"Please select a valid Curve.\");\n            }\n            if ($pconfig['certmethod'] != \"external\" && !in_array($pconfig[\"digest_alg\"], $openssl_digest_algs)) {\n                $input_errors[] = gettext(\"Please select a valid Digest Algorithm.\");\n            }\n            if ($pconfig['certmethod'] == \"external\" && !in_array($pconfig[\"keytype\"], array(\"RSA\", \"Elliptic Curve\"))) {\n                $input_errors[] = gettext(\"Please select a valid Key Type.\");\n            }\n            if ($pconfig['certmethod'] == \"external\" && isset($pconfig[\"csr_keylen\"]) && $pconfig[\"keytype\"] == \"RSA\" && !in_array($pconfig[\"csr_keylen\"], $cert_keylens)) {\n                $input_errors[] = gettext(\"Please select a valid Key Length.\");\n            }\n            if ($pconfig['certmethod'] == \"external\" && isset($pconfig[\"csr_curve\"]) && $pconfig[\"keytype\"] == \"Elliptic Curve\" && !in_array($pconfig[\"csr_curve\"], $cert_curves)) {\n                $input_errors[] = gettext(\"Please select a valid Curve.\");\n            }\n            if ($pconfig['certmethod'] == \"external\" && !in_array($pconfig[\"csr_digest_alg\"], $openssl_digest_algs)) {\n                $input_errors[] = gettext(\"Please select a valid Digest Algorithm.\");\n            }\n            if ($pconfig['certmethod'] == \"sign_cert_csr\" && !in_array($pconfig[\"digest_alg_sign_csr\"], $openssl_digest_algs)) {\n                $input_errors[] = gettext(\"Please select a valid Digest Algorithm.\");\n            }\n        }\n\n        // validation and at the same time create $dn for sign_cert_csr\n        if ($pconfig['certmethod'] === 'sign_cert_csr') {\n            // XXX: we should separate validation and data gathering\n            $extns = array();\n            if (isset($pconfig['key_usage_sign_csr'])) {\n                $san_str = '';\n                if (!empty($pconfig['altname_type_sign_csr'])) {\n                    for ($i = 0; $i < count($pconfig['altname_type_sign_csr']); ++$i) {\n                        if ($pconfig['altname_value_sign_csr'][$i] === '') {\n                            continue;\n                        }\n                        if (! is_valid_alt_value(array(\n                            'type' => $pconfig['altname_type_sign_csr'][$i],\n                            'value' => $pconfig['altname_value_sign_csr'][$i]), $input_errors\n                        )) {\n                            break;\n                        }\n                        if ($san_str !== '') {\n                            $san_str .= ', ';\n                        }\n                        $san_str .= $pconfig['altname_type_sign_csr'][$i] . ':' . $pconfig['altname_value_sign_csr'][$i];\n                    }\n                }\n                if ($san_str !== '') {\n                    $extns['subjectAltName'] = $san_str;\n                }\n                if (is_array($pconfig['key_usage_sign_csr']) && count($pconfig['key_usage_sign_csr']) > 0) {\n                    $resstr = '';\n                    foreach ($pconfig['key_usage_sign_csr'] as $item) {\n                        if (array_key_exists($item, $key_usages)) {\n                            if ($resstr !== '') {\n                                $resstr .= ', ';\n                            }\n                            $resstr .= $item;\n                        } else {\n                            $input_errors[] = gettext(\"Please select a valid keyUsage.\");\n                            break;\n                        }\n                    }\n                    $extns['keyUsage'] = $resstr;\n                }\n                if (is_array($pconfig['extended_key_usage_sign_csr']) && count($pconfig['extended_key_usage_sign_csr']) > 0) {\n                    $resstr = '';\n                    foreach ($pconfig['extended_key_usage_sign_csr'] as $item) {\n                        if (array_key_exists($item, $extended_key_usages)) {\n                            if ($resstr !== '') {\n                                $resstr .= ', ';\n                            }\n                            $resstr .= $item;\n                        } else {\n                            $input_errors[] = gettext(\"Please select a valid extendedKeyUsage.\");\n                            break;\n                        }\n                    }\n                    $extns['extendedKeyUsage'] = $resstr;\n                }\n                if ($pconfig['basic_constraints_is_ca_sign_csr'] === 'true') {\n                    $extns['basicConstraints'] = 'CA:' . ((isset($pconfig['basic_constraints_is_ca_sign_csr']) && $pconfig['basic_constraints_is_ca_sign_csr'] === 'true') ? 'TRUE' : 'false');\n                    if (isset($pconfig['basic_constraints_path_len_sign_csr']) && $pconfig['basic_constraints_path_len_sign_csr'] != '') {\n                        $extns['basicConstraints'] .= ', pathlen:' . ((int) $pconfig['basic_constraints_path_len_sign_csr']);\n                    }\n                }\n            }\n        }\n\n        /* save modifications */\n        if (count($input_errors) == 0) {\n            if ($pconfig['certmethod'] == \"existing\") {\n                $cert = lookup_cert($pconfig['certref']);\n                if ($cert && !empty($userid)) {\n                    $a_user[$userid]['cert'][] = $cert['refid'];\n                }\n            } else {\n                $cert = array();\n                $cert['refid'] = uniqid();\n                if (isset($id) && $a_cert[$id]) {\n                    $cert = $a_cert[$id];\n                }\n\n                $cert['descr'] = $pconfig['descr'];\n\n                $old_err_level = error_reporting(0); /* otherwise openssl_ functions throw warnings directly to a page screwing menu tab */\n                if ($pconfig['keytype'] == \"Elliptic Curve\") {\n                    $pconfig['keylen_curve'] = $pconfig['curve'];\n                } else {\n                    $pconfig['keylen_curve'] = $pconfig['keylen'];\n                }\n                if ($pconfig['csr_keytype'] == \"Elliptic Curve\") {\n                    $pconfig['csr_keylen_curve'] = $pconfig['csr_curve'];\n                } else {\n                    $pconfig['csr_keylen_curve'] = $pconfig['csr_keylen'];\n                }\n                if ($pconfig['certmethod'] == \"import\") {\n                    cert_import($cert, $pconfig['cert'], $pconfig['key']);\n                } elseif ($pconfig['certmethod'] == \"internal\") {\n                    $dn = array(\n                        'countryName' => $pconfig['dn_country'],\n                        'stateOrProvinceName' => $pconfig['dn_state'],\n                        'localityName' => $pconfig['dn_city'],\n                        'organizationName' => $pconfig['dn_organization'],\n                        'emailAddress' => $pconfig['dn_email'],\n                        'commonName' => $pconfig['dn_commonname']);\n                    $extns = array();\n                    if (count($altnames)) {\n                        $altnames_tmp = array();\n                        foreach ($altnames as $altname) {\n                            $altnames_tmp[] = \"{$altname['type']}:{$altname['value']}\";\n                        }\n                        $extns['subjectAltName'] = implode(\",\", $altnames_tmp);\n                    }\n\n                    if (!cert_create(\n                        $cert,\n                        $pconfig['caref'],\n                        $pconfig['keylen_curve'],\n                        $pconfig['lifetime'],\n                        $dn,\n                        $pconfig['digest_alg'],\n                        $pconfig['cert_type'],\n                        $extns\n                    )) {\n                        $input_errors = array();\n                        while ($ssl_err = openssl_error_string()) {\n                            $input_errors[] = gettext(\"openssl library returns:\") . \" \" . $ssl_err;\n                        }\n                    }\n                    if ($pconfig['private_key_location'] === 'local') {\n                        // unset private key before safe\n                        $act = 'download_private_key';\n                        $pconfig['private_key'] = base64_decode($cert['prv']);\n                        unset($cert['prv']);\n                    }\n                } elseif ($pconfig['certmethod'] === 'sign_cert_csr') {\n                    if (!sign_cert_csr($cert, $pconfig['caref_sign_csr'], $pconfig['csr'], (int) $pconfig['lifetime_sign_csr'],\n                                       $pconfig['digest_alg_sign_csr'], $extns)) {\n                        $input_errors = array();\n                        while ($ssl_err = openssl_error_string()) {\n                            $input_errors[] = gettext(\"openssl library returns:\") . \" \" . $ssl_err;\n                        }\n                    }\n                } elseif ($pconfig['certmethod'] == \"external\") {\n                    $dn = array(\n                        'countryName' => $pconfig['csr_dn_country'],\n                        'stateOrProvinceName' => $pconfig['csr_dn_state'],\n                        'localityName' => $pconfig['csr_dn_city'],\n                        'organizationName' => $pconfig['csr_dn_organization'],\n                        'emailAddress' => $pconfig['csr_dn_email'],\n                        'commonName' => $pconfig['csr_dn_commonname']);\n                    $extns = array();\n                    if (!empty($pconfig['csr_dn_organizationalunit'])) {\n                        $dn['organizationalUnitName'] = $pconfig['csr_dn_organizationalunit'];\n                    }\n                    if (count($altnames)) {\n                        $altnames_tmp = array();\n                        foreach ($altnames as $altname) {\n                            $altnames_tmp[] = \"{$altname['type']}:{$altname['value']}\";\n                        }\n                        $extns['subjectAltName'] = implode(\",\", $altnames_tmp);\n                    }\n                    if (!csr_generate($cert, $pconfig['csr_keylen_curve'], $dn, $pconfig['csr_digest_alg'], $extns)) {\n                        $input_errors = array();\n                        while ($ssl_err = openssl_error_string()) {\n                            $input_errors[] = gettext(\"openssl library returns:\") . \" \" . $ssl_err;\n                        }\n                    }\n                }\n                error_reporting($old_err_level);\n\n                if (isset($id)) {\n                    $a_cert[$id] = $cert;\n                } else {\n                    $a_cert[] = $cert;\n                }\n                if (isset($a_user) && isset($userid)) {\n                    $a_user[$userid]['cert'][] = $cert['refid'];\n                }\n            }\n            if (count($input_errors) == 0) {\n                write_config();\n                if ($act !== 'download_private_key') {\n                    if (isset($userid)) {\n                        header(url_safe('Location: /system_usermanager.php?act=edit&userid=%d', array($userid)));\n                    } else {\n                        header(url_safe('Location: /system_certmanager.php'));\n                    }\n                    exit;\n                }\n            }\n\n        }\n    }\n}\n\nlegacy_html_escape_form_data($pconfig);\nlegacy_html_escape_form_data($a_ca);\nlegacy_html_escape_form_data($a_cert);\n$act = htmlspecialchars($act,  ENT_QUOTES | ENT_HTML401);\n\ninclude(\"head.inc\");\n\n?>\n<body>\n  <style>\n    .monospace-dialog {\n      font-family: monospace;\n      white-space: pre;\n    }\n\n    .monospace-dialog > .modal-dialog {\n      width:70% !important;\n    }\n\n    .modal-body {\n      max-height: calc(100vh - 210px);\n      overflow-y: auto;\n    }\n  </style>\n  <script>\n  $( document ).ready(function() {\n    // delete entry\n    $(\".act_delete\").click(function(event){\n      event.preventDefault();\n      var id = $(this).data('id');\n      BootstrapDialog.show({\n        type:BootstrapDialog.TYPE_DANGER,\n        title: \"<?= gettext(\"Certificates\");?>\",\n        message: \"<?=gettext(\"Do you really want to delete this Certificate?\");?>\",\n        buttons: [{\n                  label: \"<?=gettext(\"No\");?>\",\n                  action: function(dialogRef) {\n                      dialogRef.close();\n                  }}, {\n                  label: \"<?=gettext(\"Yes\");?>\",\n                  action: function(dialogRef) {\n                    $(\"#id\").val(id);\n                    $(\"#action\").val(\"del\");\n                    $(\"#iform\").submit()\n                }\n              }]\n      });\n    });\n\n    $('.p12btn').on('click', function(event) {\n        event.preventDefault();\n        var id = $(this).data('id');\n\n        let password_input = $('<input type=\"password\" autocomplete=\"new-password\" class=\"form-control password_field\" placeholder=\"<?=html_safe(gettext(\"Password\"));?>\">');\n        let confirm_input = $('<input type=\"password\" autocomplete=\"new-password\" class=\"form-control password_field\" placeholder=\"<?=html_safe(gettext(\"Confirm\"));?>\">');\n        let dialog_items = $('<div class = \"form-group\">');\n        dialog_items.append(\n          $(\"<span>\").text(\"<?=html_safe(gettext('Optionally use a password to protect your export'));?>\"),\n          $('<table class=\"table table-condensed\"/>').append(\n            $(\"<tbody/>\").append(\n              $(\"<tr/>\").append($(\"<td/>\").append(password_input)),\n              $(\"<tr/>\").append($(\"<td/>\").append(confirm_input))\n            )\n          )\n        );\n\n        // highlight password/confirm when not equal\n        let keyup_pass = function() {\n            if (confirm_input.val() !== password_input.val()) {\n                $(\".password_field\").addClass(\"has-warning\");\n                $(\".password_field\").closest('div').addClass('has-warning');\n            } else {\n                $(\".password_field\").removeClass(\"has-warning\");\n                $(\".password_field\").closest('div').removeClass('has-warning');\n            }\n        };\n        confirm_input.on('keyup', keyup_pass);\n        password_input.on('keyup', keyup_pass);\n\n\n        BootstrapDialog.show({\n            type:BootstrapDialog.TYPE_INFO,\n            title: \"<?= gettext(\"Certificates\");?>\",\n            message: dialog_items,\n            buttons: [\n                {\n                    label: \"<?=html_safe(gettext(\"Close\"));?>\",\n                    action: function(dialogRef) {\n                        dialogRef.close();\n                    }\n                }, {\n                    label: '<i class=\"fa fa-download fa-fw\"></i> <?=html_safe(gettext(\"Download\"));?>',\n                    action: function(dialogRef) {\n                        if (confirm_input.val() === password_input.val()) {\n                            $.post('system_certmanager.php', {'id': id, 'act': 'p12', 'password': password_input.val()}, function (data) {\n                                var link = $('<a></a>')\n                                    .attr('href','data:application/octet-stream;base64,' + data.content)\n                                    .attr('download', data.filename)\n                                    .appendTo('body');\n                                link.ready(function() {\n                                    link.get(0).click();\n                                    link.empty();\n                                });\n                            });\n                            dialogRef.close();\n                        }\n                    }\n                }\n            ]\n        });\n    });\n\n    $(\".act_info\").click(function(event){\n        event.preventDefault();\n        var id = $(this).data('id');\n        $.ajax({\n                url:\"system_certmanager.php\",\n                type: 'get',\n                data: {'act' : 'info', 'id' :id},\n                success: function(data){\n                  BootstrapDialog.show({\n                              title: '<?=gettext(\"Certificate\");?>',\n                              type:BootstrapDialog.TYPE_INFO,\n                              message: $(\"<div/>\").text(data).html(),\n                              cssClass: 'monospace-dialog',\n                          });\n                }\n        });\n\n    });\n\n    $(\".csr_info_for_sign_csr\").click(function(event){\n        event.preventDefault();\n        var csr_payload = $('#csr').val();\n        $.ajax({\n                url:\"system_certmanager.php\",\n                type: 'post',\n                data: {'act' : 'csr_info', 'csr' : csr_payload},\n                success: function(data){\n                  BootstrapDialog.show({\n                      title: '<?=gettext(\"Certificate Request\");?>',\n                      type:BootstrapDialog.TYPE_INFO,\n                      message: $(\"<div/>\").text(data).html(),\n                      cssClass: 'monospace-dialog',\n                  });\n                }\n        });\n    });\n\n    $(\".x509_extension_step_sign_csr\").click(function(event){\n        event.preventDefault();\n        var csr_payload = $('#csr').val();\n        $.ajax({\n                url:\"system_certmanager.php\",\n                type: 'post',\n                data: {'act' : 'csr_info_json', 'csr' : csr_payload},\n                success: function(data){\n                        subject_text = '';\n                        Object.keys(data.subject).forEach(function(item) {\n                                if (subject_text != '') {\n                                        subject_text += ', ';\n                                }\n                                subject_text += item + '=' + data.subject[item];\n                        });\n\n                        $('#next_button_for_x509_extension_step_sign_csr').addClass('hidden');\n                        $('#csr').prop('readonly', true);\n                        $('#x509_extension_step_sign_cert_csr').removeClass('hidden');\n                        $('#subject_sign_csr').text(subject_text);\n                        $('#subject_alt_name_sign_csr_table > tbody > tr:gt(0)').remove();\n                        if ('subjectAltName' in data) {\n                              data.subjectAltName.forEach(function(item) {\n                                      addRowAltSignCSR(item.type, item.value);\n                              });\n                        }\n                        if ('basicConstraints' in data) {\n                                $('#basic_constraints_is_ca_sign_csr').prop('checked', data.basicConstraints.CA);\n                                $('#basic_constraints_path_len_sign_csr').val(\n                                      ('pathlen' in data.basicConstraints) ? data.basicConstraints.pathlen : ''\n                                );\n                        } else {\n                                $('#basic_constraints_is_ca_sign_csr').prop('checked', false);\n                                $('#basic_constraints_path_len_sign_csr').val('');\n                        }\n                        $(\"#basic_constraints_is_ca_sign_csr\").change();\n\n                        $('#key_usage_sign_csr option').prop('selected', false);\n                        if ('keyUsage' in data) {\n                                data.keyUsage.forEach(function(item) {\n                                        $('#key_usage_sign_csr_' + item).prop('selected', true);\n                                });\n\n                        }\n                        $(\"#key_usage_sign_csr\").selectpicker('refresh');\n\n                        $('#extended_key_usage_sign_csr option').prop('selected', false);\n                        if ('extendedKeyUsage' in data) {\n                                data.extendedKeyUsage.forEach(function(item) {\n                                        $('#extended_key_usage_sign_csr_' + (item.replace(/\\./g, '_'))).prop('selected', true);\n                                });\n\n                        }\n                        $(\"#extended_key_usage_sign_csr\").selectpicker('refresh');\n\n                        $('#submit').removeClass('hidden');\n                },\n                error: function(jqXHR, textStatus, errorThrown) {\n                        if (jqXHR.status == 400) {\n                                BootstrapDialog.show({\n                                        type:BootstrapDialog.TYPE_DANGER,\n                                        title: jqXHR.responseJSON.error,\n                                        message: jqXHR.responseJSON.error_detail,\n                                        buttons: [\n                                            {\n                                                label: \"<?=gettext(\"OK\");?>\",\n                                                action: function(dialogRef) { dialogRef.close(); }\n                                            }\n                                       ]\n                                });\n                                return;\n                        }\n                        BootstrapDialog.show({\n                                type:BootstrapDialog.TYPE_DANGER,\n                                title: \"<?= gettext(\"Unknown Error\");?>\",\n                                message: \"<?= gettext(\"Unknown error occurred. Try again.\");?>\",\n                                buttons: [\n                                    {\n                                        label: \"<?=gettext(\"OK\");?>\",\n                                        action: function(dialogRef) { dialogRef.close(); }\n                                    }\n                               ]\n                        });\n                },\n        });\n    });\n\n    // parameter 'type' must not include non-alphabet characters\n    function addRowAltSignCSR(type, value) {\n        let $tr = $(\"#subject_alt_name_sign_csr_table > tbody > tr:eq(0)\").clone();\n        $tr.find(\"select\").prop(\"name\", \"altname_type_sign_csr[]\").val(type);\n        $tr.find(\"input\").prop(\"name\", \"altname_value_sign_csr[]\").val(value);\n        $tr.removeClass(\"hidden\");\n        $(\"#subject_alt_name_sign_csr_table > tbody\").append($tr);\n        $(\".act-removerow-altnm-sign-csr\").unbind('click').on('click', function(){\n            $(this).parent().parent().remove();\n        });\n    }\n\n    $(\"#addNewAltNmSignCSR\").click(function(){\n        addRowAltSignCSR('', '');\n    });\n\n    $(\"#basic_constraints_is_ca_sign_csr\").change(function(){\n        $('#basic_constraints_path_len_sign_csr').prop(\n          'disabled', !$('#basic_constraints_is_ca_sign_csr').prop('checked')\n        )\n    });\n\n\n    /**\n     * remove row from altNametable\n     */\n    function removeRowAltNm() {\n        if ( $('#altNametable > tbody > tr').length == 1 ) {\n            $('#altNametable > tbody > tr:last > td > input').each(function(){\n              $(this).val('');\n            });\n        } else {\n            $(this).parent().parent().remove();\n        }\n    }\n    // javascript only for edit forms\n    if ($('#certmethod').length) {\n        // no ca's found, display message\n        if ($(\"#caref option\").length == 0) {\n            $(\"#no_caref\").removeClass(\"hidden\");\n            $(\"#caref\").addClass(\"hidden\");\n        }\n        // add new detail record\n        $(\"#addNewAltNm\").click(function(){\n            // copy last row and reset values\n            $('#altNametable > tbody').append('<tr>'+$('#altNametable > tbody > tr:last').html()+'</tr>');\n            $('#altNametable > tbody > tr:last > td > input').each(function(){\n              $(this).val('');\n            });\n            $(\".act-removerow-altnm\").click(removeRowAltNm);\n        });\n        $(\".act-removerow-altnm\").click(removeRowAltNm);\n\n\n        $(\"#certmethod\").change(function(){\n            $(\"#submit\").addClass(\"hidden\");\n            $(\"#import\").addClass(\"hidden\");\n            $(\"#internal\").addClass(\"hidden\");\n            $(\"#external\").addClass(\"hidden\");\n            $(\"#existing\").addClass(\"hidden\");\n            $(\"#sign_cert_csr\").addClass(\"hidden\");\n            $(\"#x509_extension_sign_cert_csr\").addClass(\"hidden\");\n            $('#x509_extension_step_sign_cert_csr').addClass('hidden');\n            if ($(this).val() == \"import\") {\n                $(\"#import\").removeClass(\"hidden\");\n                $(\"#submit\").removeClass(\"hidden\");\n            } else if ($(this).val() == \"internal\") {\n                $(\"#internal\").removeClass(\"hidden\");\n                $(\"#altNameTr\").detach().appendTo(\"#internal > tbody:first\");\n                $(\"#submit\").removeClass(\"hidden\");\n            } else if ($(this).val() == \"external\") {\n                $(\"#external\").removeClass(\"hidden\");\n                $(\"#altNameTr\").detach().appendTo(\"#external > tbody:first\");\n                $(\"#submit\").removeClass(\"hidden\");\n            } else if ($(this).val() == \"sign_cert_csr\") {\n                $(\"#sign_cert_csr\").removeClass(\"hidden\");\n                $('#next_button_for_x509_extension_step_sign_csr').removeClass('hidden');\n                $('#csr').prop('readonly', false);\n            } else {\n                $(\"#existing\").removeClass(\"hidden\");\n                $(\"#submit\").removeClass(\"hidden\");\n            }\n        });\n\n        $(\"#certmethod\").change();\n    }\n\n\n    if (document.createElement('a').download !== undefined) {\n        $(\".text_download_btn\").click(function(event){\n            event.preventDefault();\n            if ($(this).attr('for')) {\n                let target = $(\"#\"+$(this).attr('for'));\n                var link = $('<a></a>')\n                    .attr('href', URL.createObjectURL(new Blob([target.val()])))\n                    .attr('download', target.data('filename'))\n                    .appendTo('body');\n\n                link.ready(function() {\n                    link.get(0).click();\n                    link.empty();\n                });\n\n            }\n        });\n    } else {\n        $(\".text_download_btn\").remove();\n    }\n\n$(\"#keytype\").change(function(){\n        $(\"#EC\").addClass(\"hidden\");\n        $(\"#RSA\").addClass(\"hidden\");\n        $(\"#blank\").addClass(\"hidden\");\n        if ($(this).val() == \"Elliptic Curve\") {\n            $(\"#EC\").removeClass(\"hidden\");\n        } else {\n            $(\"#RSA\").removeClass(\"hidden\");\n        }\n});\n\n$(\"#keytype\").change();\n\n$(\"#csr_keytype\").change(function(){\n        $(\"#csr_EC\").addClass(\"hidden\");\n        $(\"#csr_RSA\").addClass(\"hidden\");\n        $(\"#csr_blank\").addClass(\"hidden\");\n        if ($(this).val() == \"Elliptic Curve\") {\n            $(\"#csr_EC\").removeClass(\"hidden\");\n        } else {\n            $(\"#csr_RSA\").removeClass(\"hidden\");\n        }\n});\n\n$(\"#csr_keytype\").change();\n\n  });\n\n  </script>\n\n<?php include(\"fbegin.inc\"); ?>\n<script>\n$( document ).ready(function() {\n//<![CDATA[\n  function internalca_change() {\n\n    let index = document.iform.caref.selectedIndex;\n    let caref = document.iform.caref[index].value;\n\n    switch (caref) {\n  <?php\n  foreach ($a_ca as $ca) :\n      if (!$ca['prv']) {\n          continue;\n      }\n      $subject = cert_get_subject_array($ca['crt']);\n      legacy_html_escape_form_data($subject);\n      $subject_items = array('C'=>'', 'ST' => '', 'L' => '', 'O' => '', 'emailAddress' => '', 'CN' => '');\n      foreach ($subject as $subject_item) {\n          $subject_items[$subject_item['a']] = $subject_item['v'];\n      }\n  ?>\n      case \"<?=$ca['refid'];?>\":\n          $(\"#dn_state\").val(\"<?=$subject_items['ST'];?>\");\n          $(\"#dn_city\").val(\"<?=$subject_items['L'];?>\");\n          $(\"#dn_organization\").val(\"<?=$subject_items['O'];?>\");\n          $(\"#dn_email\").val(\"<?=$subject_items['emailAddress'];?>\");\n          $('#dn_country option').prop('selected', false);\n          $('#dn_country option').filter('[value=\"<?=$subject_items['C'];?>\"]').prop('selected', true);\n          $(\"#dn_country\").selectpicker('refresh');\n          break;\n  <?php\n  endforeach; ?>\n    }\n  }\n\n  // only trigger change event when in edit mode.\n  if ($('#certmethod').length) {\n    $(\"#caref\").change(internalca_change);\n    $(\"#caref\").change();\n  }\n});\n\n//]]>\n</script>\n\n<!-- row -->\n<section class=\"page-content-main\">\n  <div class=\"container-fluid\">\n    <div class=\"row\">\n<?php\n    if (isset($input_errors) && count($input_errors) > 0) {\n        print_input_errors($input_errors);\n    }\n    if (isset($savemsg)) {\n        print_info_box($savemsg);\n    }\n?>\n      <section class=\"col-xs-12\">\n        <div class=\"content-box tab-content table-responsive\">\n\n        <!--- New --->\n<?php\n        if ($act == \"new\") :?>\n          <form method=\"post\" name=\"iform\" id=\"iform\" >\n            <input type=\"hidden\" name=\"act\" value=\"<?=$act;?>\"/>\n<?php\n            if (isset($userid)) :?>\n            <input name=\"userid\" type=\"hidden\" value=\"<?=htmlspecialchars($userid);?>\" />\n<?php\n            endif;?>\n<?php\n            if (isset($id)) :?>\n            <input name=\"id\" type=\"hidden\" value=\"<?=$id;?>\" />\n<?php\n            endif;?>\n            <table class=\"table table-striped opnsense_standard_table_form\">\n              <tr>\n                <td style=\"width:22%\"></td>\n                <td  style=\"width:78%; text-align:right\">\n                  <small><?=gettext(\"full help\"); ?> </small>\n                  <i class=\"fa fa-toggle-off text-danger\"  style=\"cursor: pointer;\" id=\"show_all_help_page\"></i>\n                </td>\n              </tr>\n              <tr>\n                <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Method\");?></td>\n                <td>\n                  <select name=\"certmethod\" id=\"certmethod\">\n<?php\n                  foreach ($cert_methods as $method => $desc) :?>\n                    <option value=\"<?=$method;?>\" <?=$pconfig['certmethod'] == $method ? 'selected=\"selected\"' : ''; ?>>\n                      <?=$desc;?>\n                    </option>\n<?php\n                  endforeach; ?>\n                  </select>\n                </td>\n              </tr>\n              <tr>\n                <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Descriptive name\");?></td>\n                <td>\n                  <input name=\"descr\" type=\"text\" id=\"descr\" size=\"20\" value=\"<?=$pconfig['descr'];?>\"/>\n                </td>\n              </tr>\n            </table>\n            <!-- existing cert -->\n            <table id=\"import\" class=\"table table-striped opnsense_standard_table_form\">\n              <thead>\n                <tr>\n                  <th colspan=\"2\"><?=gettext(\"Import Certificate\");?></th>\n                </tr>\n              </thead>\n              <tbody>\n                <tr>\n                  <td style=\"width:22%\"><a id=\"help_for_cert\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Certificate data\");?></td>\n                  <td style=\"width:78%\">\n                    <textarea name=\"cert\" id=\"cert\" cols=\"65\" rows=\"7\"><?=$pconfig['cert'];?></textarea>\n                    <div class=\"hidden\" data-for=\"help_for_cert\">\n                      <?=gettext(\"Paste a certificate in X.509 PEM format here.\");?>\n                    </div>\n                  </td>\n                </tr>\n                <tr>\n                  <td><a id=\"help_for_key\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Private key data\");?></td>\n                  <td>\n                    <textarea name=\"key\" id=\"key\" cols=\"65\" rows=\"7\"><?=$pconfig['key'];?></textarea>\n                    <div class=\"hidden\" data-for=\"help_for_key\">\n                      <?=gettext(\"Paste a private key in X.509 PEM format here.\");?>\n                    </div>\n                  </td>\n                </tr>\n              </tbody>\n            </table>\n            <!-- sign_cert_csr -->\n            <table id=\"sign_cert_csr\" class=\"table table-striped opnsense_standard_table_form\">\n              <thead>\n                <tr>\n                  <th colspan=\"2\"><?=gettext(\"Sign CSR\");?></th>\n                </tr>\n              </thead>\n              <tbody>\n                <tr>\n                  <td style=\"width:22%\"><?=gettext(\"Certificate authority\");?></td>\n                  <td style=\"width:78%\">\n                    <select name='caref_sign_csr' id='caref_sign_csr'>\n  <?php\n                    foreach ($a_ca as $ca) :\n                        if (empty($ca['prv'])) {\n                            continue;\n                        }?>\n                      <option value=\"<?=$ca['refid'];?>\" <?=isset($pconfig['caref_sign_csr']) && isset($ca['refid']) && $pconfig['caref_sign_csr'] == $ca['refid'] ? 'selected=\"selected\"' : '';?>><?=html_safe($ca['descr']);?></option>\n  <?php\n                    endforeach; ?>\n                    </select>\n                    <div class=\"hidden\" id=\"no_caref_sign_csr\">\n                      <?=sprintf(gettext(\"No internal Certificate Authorities have been defined. You must %sadd%s an internal CA before creating an internal certificate.\"),'<a href=\"system_camanager.php?act=new&amp;method=internal\">','</a>');?>\n                    </div>\n                  </td>\n                </tr>\n                <tr>\n                  <td><a id=\"help_for_digest_alg_sign_csr\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Digest Algorithm\");?></td>\n                  <td>\n                    <select name='digest_alg_sign_csr' id='digest_alg_sign_csr'>\n  <?php\n                    foreach ($openssl_digest_algs as $digest_alg) :?>\n                      <option value=\"<?=$digest_alg;?>\" <?=$pconfig['digest_alg_sign_csr'] == $digest_alg ? 'selected=\"selected\"' : '';?>>\n                        <?=strtoupper($digest_alg);?>\n                      </option>\n  <?php\n                    endforeach; ?>\n                    </select>\n                    <div class=\"hidden\" data-for=\"help_for_digest_alg_sign_csr\">\n                      <?= gettext(\"NOTE: It is recommended to use an algorithm stronger than SHA1 when possible.\") ?>\n                    </div>\n                  </td>\n                </tr>\n                <tr>\n                  <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Lifetime\");?> (<?=gettext(\"days\");?>)</td>\n                  <td>\n                    <input name=\"lifetime_sign_csr\" type=\"text\" id=\"lifetime_sign_csr\" size=\"5\" value=\"<?=$pconfig['lifetime_sign_csr'];?>\"/>\n                  </td>\n                </tr>\n                <tr>\n                  <td><a id=\"help_for_csr_sign_csr\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"CSR file\");?></td>\n                  <td>\n                    <textarea name=\"csr\" id=\"csr\" cols=\"65\" rows=\"7\"><?=$pconfig['csr'];?></textarea><br/>\n                    <a href=\"#\" class=\"csr_info_for_sign_csr btn btn-secondary\"><?=gettext(\"Show Detail\");?></a><br/>\n                    <div class=\"hidden\" data-for=\"help_for_csr_sign_csr\">\n                      <?=gettext(\"Paste the CSR file here.\");?>\n                    </div>\n                  </td>\n                </tr>\n                <tr id=\"next_button_for_x509_extension_step_sign_csr\">\n                  <td>&nbsp;</td>\n                  <td>\n                    <a href=\"#\" class=\"x509_extension_step_sign_csr btn btn-primary\"><?=gettext(\"Next\");?></a>\n                  </td>\n                </tr>\n              </tbody>\n            </table>\n            <div id=\"x509_extension_step_sign_cert_csr\" class=\"hidden\">\n              <table class=\"table table-striped opnsense_standard_table_form\">\n                <thead>\n                  <tr>\n                    <th colspan=\"2\"><?=gettext(\"Subject of the certificate\");?></th>\n                  </tr>\n                </thead>\n                <tbody>\n                  <tr>\n                    <td style=\"width:22%\"><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext('Subject');?></td>\n                    <td id=\"subject_sign_csr\" style=\"width:78%\"></td>\n                  </tr>\n                  <tr>\n                    <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext('subjectAltName');?></td>\n                    <td>\n                      <table class=\"table table-condensed\" id=\"subject_alt_name_sign_csr_table\">\n                        <thead>\n                            <tr>\n                              <th><?=gettext(\"Type\");?></th>\n                              <th><?=gettext(\"Value\");?></th>\n                              <th></th>\n                            </tr>\n                        </thead>\n                        <tbody>\n                            <tr class=\"hidden\">\n                                <td>\n                                  <select>\n                                      <option value=\"DNS\"><?=gettext(\"DNS\");?></option>\n                                      <option value=\"IP\"><?=gettext(\"IP\");?></option>\n                                      <option value=\"email\"><?=gettext(\"email\");?></option>\n                                      <option value=\"URI\"><?=gettext(\"URI\");?></option>\n                                  </select>\n                                </td>\n                                <td>\n                                  <input type=\"text\" size=\"20\" value=\"\">\n                                </td>\n                                <td>\n                                  <div style=\"cursor:pointer;\" class=\"act-removerow-altnm-sign-csr btn btn-default btn-xs\"><i class=\"fa fa-minus fa-fw\"></i></div>\n                                </td>\n                            </tr>\n                        </tbody>\n                        <tfoot>\n                          <tr>\n                            <td colspan=\"2\"></td>\n                            <td>\n                              <div id=\"addNewAltNmSignCSR\" style=\"cursor:pointer;\" class=\"btn btn-default btn-xs\"><i class=\"fa fa-plus fa-fw\"></i></div>\n                            </td>\n                          </tr>\n                        </tfoot>\n                      </table>\n                    </td>\n                  </tr>\n                  <tr>\n                    <td><a id=\"help_for_basic_extensions_sign_csr\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext('basicConstraints');?></td>\n                    <td>\n                      <input type=\"checkbox\" name=\"basic_constraints_is_ca_sign_csr\" id=\"basic_constraints_is_ca_sign_csr\" value=\"true\" /> <?= gettext('is CA'); ?><br />\n                      <?= gettext('Maximum Path Length'); ?>: <input type=\"text\" name=\"basic_constraints_path_len_sign_csr\" id=\"basic_constraints_path_len_sign_csr\" size=\"5\" value=\"<?=$pconfig['basic_constraints_sign_csr'];?>\"/>\n                      <div class=\"hidden\" data-for=\"help_for_basic_extensions_sign_csr\">\n                        <strong><?= gettext('Maximum Path Length'); ?></strong>: <?= gettext('Define the maximum number of non-self-issued intermediate certificates that may follow this certificate in a valid certification path.'); ?>\n                      </div>\n                    </td>\n                  </tr>\n                  <tr>\n                    <td><a id=\"help_for_key_usage_sign_csr\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext('keyUsage');?></td>\n                    <td>\n                      <select name=\"key_usage_sign_csr[]\" title=\"<?= html_safe(gettext('Select keyUsage')) ?>\" multiple=\"multiple\" id=\"key_usage_sign_csr\" class=\"selectpicker\" data-live-search=\"true\" data-size=\"5\" tabindex=\"2\" <?=!empty($pconfig['associated-rule-id']) ? \"disabled\" : \"\";?>>\n<?php\n                      foreach ($key_usages as $key => $human_readable): ?>\n                        <option value=\"<?=$key;?>\" id=\"key_usage_sign_csr_<?=$key;?>\">\n                          <?= $human_readable; ?>\n                        </option>\n<?php\n                      endforeach; ?>\n                      </select>\n                      <div class=\"hidden\" data-for=\"help_for_key_usage_sign_csr\">\n                        <?=gettext(\"Practical examples:\");?>\n                        <ul>\n                          <li><strong><?= gettext('Client Certificate'); ?></strong>: <?= $key_usages['nonRepudiation']; ?>, <?= $key_usages['digitalSignature']; ?>, <?= $key_usages['keyEncipherment']; ?></li>\n                          <li><strong><?= gettext('Server Certificate'); ?></strong>: <?= $key_usages['digitalSignature']; ?>, <?= $key_usages['keyEncipherment']; ?></li>\n                          <li><strong><?= gettext('Combined Client/Server Certificate'); ?></strong>: <?= $key_usages['nonRepudiation']; ?>, <?= $key_usages['digitalSignature']; ?>, <?= $key_usages['keyEncipherment'];?></li>\n                          <li><strong><?= gettext('Certificate Authority'); ?></strong>: <i><?= gettext('None. Just add CA option in basicConstraints.'); ?></i></li>\n                        </ul>\n                      </div>\n                    </td>\n                  </tr>\n                  <tr>\n                    <td><a id=\"help_for_extended_key_usage_sign_csr\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext('extendedKeyUsage');?></td>\n                    <td>\n                      <select name=\"extended_key_usage_sign_csr[]\" title=\"<?= html_safe(gettext('Select extendedKeyUsage')) ?>\" multiple=\"multiple\" id=\"extended_key_usage_sign_csr\" class=\"selectpicker\" data-live-search=\"true\" data-size=\"5\" tabindex=\"2\" <?=!empty($pconfig['associated-rule-id']) ? \"disabled\" : \"\";?>>\n<?php\n                      foreach ($extended_key_usages as $key => $human_readable): ?>\n                        <option value=\"<?=$key;?>\" id=\"extended_key_usage_sign_csr_<?= str_replace('.', '_', $key);?>\">\n                          <?= $human_readable; ?>\n                        </option>\n<?php\n                      endforeach; ?>\n                      </select>\n                    <div class=\"hidden\" data-for=\"help_for_extended_key_usage_sign_csr\">\n                      <?=gettext(\"Practical examples:\");?>\n                      <ul>\n                        <li><strong><?= gettext('Client Certificate'); ?></strong>: <?= $extended_key_usages['1.3.6.1.5.5.7.3.2']; ?></li>\n                        <li><strong><?= gettext('Server Certificate'); ?></strong>: <?= $extended_key_usages['1.3.6.1.5.5.7.3.1'] ?>, <?= $extended_key_usages['1.3.6.1.5.5.8.2.2']; ?></li>\n                        <li><strong><?= gettext('Combined Client/Server Certificate'); ?></strong>: <?= $extended_key_usages['1.3.6.1.5.5.7.3.2']; ?>, <?= $extended_key_usages['1.3.6.1.5.5.7.3.1'] ?>, <?= $extended_key_usages['1.3.6.1.5.5.8.2.2']; ?></li>\n                        <li><strong><?= gettext('Certificate Authority'); ?></strong>: <i><?= gettext('None. Just add CA option in basicConstraints.'); ?></i></li>\n                      </ul>\n                    </div>\n                    </td>\n                  </tr>\n                </tbody>\n              </table>\n            </div>\n            <!-- internal cert -->\n            <table id=\"internal\" class=\"table table-striped opnsense_standard_table_form\">\n              <thead>\n                <tr>\n                  <th colspan=\"2\"><?=gettext(\"Internal Certificate\");?></th>\n                </tr>\n              </thead>\n              <tbody>\n              <tr>\n                <td style=\"width:22%\"><?=gettext(\"Certificate authority\");?></td>\n                <td style=\"width:78%\">\n                  <select name='caref' id='caref'>\n<?php\n                  foreach ($a_ca as $ca) :\n                      if (!$ca['prv']) {\n                          continue;\n                      }?>\n                    <option value=\"<?=$ca['refid'];?>\" <?=isset($pconfig['caref']) && isset($ca['refid']) && $pconfig['caref'] == $ca['refid'] ? 'selected=\"selected\"' : '';?>><?=$ca['descr'];?></option>\n<?php\n                  endforeach; ?>\n                  </select>\n                  <div class=\"hidden\" id=\"no_caref\">\n                    <?=sprintf(gettext(\"No internal Certificate Authorities have been defined. You must %sadd%s an internal CA before creating an internal certificate.\"),'<a href=\"system_camanager.php?act=new&amp;method=internal\">','</a>');?>\n                  </div>\n                </td>\n              </tr>\n              <tr>\n                <td><a id=\"help_for_digest_cert_type\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Type\");?> </td>\n                <td>\n                    <select name=\"cert_type\">\n                        <option value=\"usr_cert\" <?=$pconfig['cert_type'] == 'usr_cert' ? 'selected=\"selected\"' : '';?>> <?=gettext(\"Client Certificate\");?> </option>\n                        <option value=\"server_cert\" <?=$pconfig['cert_type'] == 'server_cert' ? 'selected=\"selected\"' : '';?>> <?=gettext(\"Server Certificate\");?> </option>\n                        <option value=\"combined_server_client\" <?=$pconfig['cert_type'] == 'combined_server_client' ? 'selected=\"selected\"' : '';?>> <?=gettext(\"Combined Client/Server Certificate\");?> </option>\n                        <option value=\"v3_ca\" <?=$pconfig['cert_type'] == 'v3_ca' ? 'selected=\"selected\"' : '';?>> <?=gettext(\"Certificate Authority\");?> </option>\n                    </select>\n                    <div class=\"hidden\" data-for=\"help_for_digest_cert_type\">\n                      <?=gettext(\"Choose the type of certificate to generate here, the type defines it's constraints\");?>\n                    </div>\n                </td>\n              </tr>\n              <tr>\n                  <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Key Type\");?></td>\n                  <td style=\"width:78%\">\n                    <select name='keytype' id='keytype' class=\"selectpicker\">\n                  <option value=\"RSA\" <?=$pconfig['keytype'] == \"RSA\" ? \"selected=\\\"selected\\\"\" : \"\";?>>\n                    <?=gettext(\"RSA\");?>\n                  </option>\n                  <option value=\"Elliptic Curve\" <?=$pconfig['keytype'] == \"Elliptic Curve\" ? \"selected=\\\"selected\\\"\" : \"\";?>>\n                    <?=gettext(\"Elliptic Curve\");?>\n                  </option>\n                    </select>\n                  </td>\n                </tr>\n              <tr id='RSA'>\n                <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Key length\");?> (<?=gettext(\"bits\");?>)</td>\n                <td>\n                  <select name='keylen'>\n<?php\n                  foreach ($cert_keylens as $len) :?>\n                    <option value=\"<?=$len;?>\" <?=isset($pconfig['keylen']) && $pconfig['keylen'] == $len ? \"selected=\\\"selected\\\"\" : \"\";?>><?=$len;?></option>\n<?php\n                    endforeach; ?>\n                  </select>\n                </td>\n              </tr>\n              <tr id='blank'><td></td></tr>\n              <tr id='EC'>\n                  <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Curve\");?></td>\n                  <td style=\"width:78%\">\n                    <select name='curve' id='curve' class=\"selectpicker\">\n<?php\n                    foreach ($cert_curves as $curve) :?>\n                      <option value=\"<?=$curve;?>\" <?=isset($pconfig['curve']) && $pconfig['curve'] == $curve ? \"selected=\\\"selected\\\"\" : \"\";?>><?=$curve;?></option>\n<?php\n                    endforeach; ?>\n                    </select>\n                  </td>\n                </tr>\n              <tr>\n                <td><a id=\"help_for_digest_alg\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Digest Algorithm\");?></td>\n                <td>\n                  <select name='digest_alg' id='digest_alg'>\n<?php\n                  foreach ($openssl_digest_algs as $digest_alg) :?>\n                    <option value=\"<?=$digest_alg;?>\" <?=$pconfig['digest_alg'] == $digest_alg ? 'selected=\"selected\"' : '';?>>\n                      <?=strtoupper($digest_alg);?>\n                    </option>\n<?php\n                  endforeach; ?>\n                  </select>\n                  <div class=\"hidden\" data-for=\"help_for_digest_alg\">\n                    <?= gettext(\"NOTE: It is recommended to use an algorithm stronger than SHA1 when possible.\") ?>\n                  </div>\n                </td>\n              </tr>\n              <tr>\n                <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Lifetime\");?> (<?=gettext(\"days\");?>)</td>\n                <td>\n                  <input name=\"lifetime\" type=\"text\" id=\"lifetime\" size=\"5\" value=\"<?=$pconfig['lifetime'];?>\"/>\n                </td>\n              </tr>\n              <tr>\n                <td><a id=\"help_for_private_key_location\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Private key location\");?></td>\n                <td>\n                  <select name=\"private_key_location\" id=\"private_key_location\">\n                    <option value=\"firewall\" <?= $pconfig['private_key_location'] === 'firewall' ? 'selected=\"selected\"' : ''; ?>><?= gettext('Save on this firewall'); ?></option>\n                    <option value=\"local\"    <?= $pconfig['private_key_location'] === 'local'    ? 'selected=\"selected\"' : ''; ?>><?= gettext('Download and do not save'); ?></option>\n                  </select>\n                  <div class=\"hidden\" data-for=\"help_for_private_key_location\">\n                    <strong><?= gettext('Save on this firewall'); ?></strong>: <?= gettext(\"Normally choose this.\"); ?><br/>\n                    <strong><?= gettext('Download and do not save'); ?></strong>: <?= gettext(\"If the certificate is for use by a device other than this firewall, and you can download private key soon after Saving, choose this. By this option you can download the private key, which is not saved onto this firewall.\"); ?><br/>\n                  </div>\n                </td>\n              </tr>\n              <tr>\n                <th colspan=\"2\"><?=gettext(\"Distinguished name\");?> </th>\n              </tr>\n              <tr>\n                <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Country Code\");?> : &nbsp;</td>\n                <td>\n                  <select name=\"dn_country\" id=\"dn_country\" class=\"selectpicker\">\n<?php\n                  foreach (get_country_codes() as $cc => $cn):?>\n                    <option value=\"<?=$cc;?>\" <?=$pconfig['dn_country'] == $cc ? 'selected=\"selected\"' : '';?>>\n                      <?=$cc;?> (<?=$cn;?>)\n                    </option>\n<?php\n                  endforeach;?>\n                  </select>\n                </td>\n              </tr>\n              <tr>\n                <td><a id=\"help_for_digest_dn_state\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"State or Province\");?> : &nbsp;</td>\n                <td>\n                  <input name=\"dn_state\" id=\"dn_state\" type=\"text\" size=\"40\" value=\"<?=$pconfig['dn_state'];?>\"/>\n                  <div class=\"hidden\" data-for=\"help_for_digest_dn_state\">\n                    <em><?=gettext(\"ex:\");?></em>\n                    &nbsp;\n                    <?=gettext(\"Sachsen\");?>\n                  </div>\n                </td>\n              </tr>\n              <tr>\n                <td><a id=\"help_for_digest_dn_city\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"City\");?> : &nbsp;</td>\n                <td>\n                  <input name=\"dn_city\" id=\"dn_city\" type=\"text\" size=\"40\" value=\"<?=$pconfig['dn_city'];?>\"/>\n                  <div class=\"hidden\" data-for=\"help_for_digest_dn_city\">\n                    <em><?=gettext(\"ex:\");?></em>\n                    &nbsp;\n                    <?=gettext(\"Leipzig\");?>\n                  </div>\n                </td>\n              </tr>\n              <tr>\n                <td><a id=\"help_for_digest_dn_organization\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Organization\");?> : &nbsp;</td>\n                <td>\n                  <input name=\"dn_organization\" id=\"dn_organization\" type=\"text\" size=\"40\" value=\"<?=$pconfig['dn_organization'];?>\"/>\n                  <div class=\"hidden\" data-for=\"help_for_digest_dn_organization\">\n                    <em><?=gettext(\"ex:\");?></em>\n                    &nbsp;\n                    <?=gettext(\"My Company Inc\");?>\n                  </div>\n                </td>\n              </tr>\n              <tr>\n                <td><a id=\"help_for_digest_dn_email\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Email Address\");?> : &nbsp;</td>\n                <td>\n                  <input name=\"dn_email\" id=\"dn_email\" type=\"text\" size=\"25\" value=\"<?=$pconfig['dn_email'];?>\"/>\n                  <div class=\"hidden\" data-for=\"help_for_digest_dn_email\">\n                    <em><?=gettext(\"ex:\");?></em>\n                    &nbsp;\n                    <?=gettext(\"admin@mycompany.com\");?>\n                  </div>\n                </td>\n              </tr>\n              <tr>\n                <td><a id=\"help_for_digest_dn_commonname\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Common Name\");?> : &nbsp;</td>\n                <td>\n                  <input name=\"dn_commonname\" id=\"dn_commonname\" type=\"text\" size=\"25\" value=\"<?=$pconfig['dn_commonname'];?>\"/>\n                  <div class=\"hidden\" data-for=\"help_for_digest_dn_commonname\">\n                    <em><?=gettext(\"ex:\");?></em>\n                    &nbsp;\n                    <?=gettext(\"internal-ca\");?>\n                  </div>\n                </td>\n              </tr>\n              <tr id=\"altNameTr\">\n                <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Alternative Names\");?></td>\n                <td>\n                  <table class=\"table table-condensed\" id=\"altNametable\">\n                    <thead>\n                        <tr>\n                          <th><?=gettext(\"Type\");?></th>\n                          <th><?=gettext(\"Value\");?></th>\n                          <th></th>\n                        </tr>\n                    </thead>\n                    <tbody>\n<?php\n                      if (!isset($pconfig['altname_value']) || count($pconfig['altname_value']) ==0) :?>\n                      <tr>\n                        <td>\n                          <select name=\"altname_type[]\" id=\"altname_type\">\n                            <option value=\"DNS\"><?=gettext(\"DNS\");?></option>\n                            <option value=\"IP\"><?=gettext(\"IP\");?></option>\n                            <option value=\"email\"><?=gettext(\"email\");?></option>\n                            <option value=\"URI\"><?=gettext(\"URI\");?></option>\n                          </select>\n                        </td>\n                        <td>\n                          <input name=\"altname_value[]\" type=\"text\" size=\"20\" value=\"\" />\n                        </td>\n                        <td>\n                          <div style=\"cursor:pointer;\" class=\"act-removerow-altnm btn btn-default btn-xs\"><i class=\"fa fa-minus fa-fw\"></i></div>\n                        </td>\n                      </tr>\n<?php\n                      else:\n                        foreach ($pconfig['altname_value'] as $itemid => $item) :\n                          $altname_type = isset($pconfig['altname_type'][$itemid]) ? $pconfig['altname_type'][$itemid] : null; ?>\n                        <tr>\n                          <td>\n                            <select name=\"altname_type[]\" id=\"altname_type\">\n                              <option value=\"DNS\" <?=$altname_type == 'DNS' ? 'selected=\"selected\"' : '';?>><?=gettext('DNS');?></option>\n                              <option value=\"IP\" <?=$altname_type == 'IP' ? 'selected=\"selected\"' : '';?>><?=gettext('IP');?></option>\n                              <option value=\"email\" <?=$altname_type == 'email' ? 'selected=\"selected\"' : '';?>><?=gettext('email');?></option>\n                              <option value=\"URI\" <?=$altname_type == 'URI' ? 'selected=\"selected\"' : '';?>><?=gettext('URI');?></option>\n                            </select>\n                          </td>\n                          <td>\n                            <input name=\"altname_value[]\" type=\"text\" size=\"20\" value=\"<?=$item;?>\" />\n                          </td>\n                          <td>\n                            <div style=\"cursor:pointer;\" class=\"act-removerow-altnm btn btn-default btn-xs\"><i class=\"fa fa-minus fa-fw\"></i></div>\n                          </td>\n                        </tr>\n\n<?php\n                        endforeach;\n                      endif;?>\n                    </tbody>\n                    <tfoot>\n                      <tr>\n                        <td colspan=\"2\"></td>\n                        <td>\n                          <div id=\"addNewAltNm\" style=\"cursor:pointer;\" class=\"btn btn-default btn-xs\"><i class=\"fa fa-plus fa-fw\"></i></div>\n                        </td>\n                      </tr>\n                    </tfoot>\n                  </table>\n                </td>\n              </tr>\n              </tbody>\n            </table>\n            <!-- external cert -->\n            <table id=\"external\" class=\"table table-striped opnsense_standard_table_form\">\n              <thead>\n                <tr>\n                  <td colspan=\"2\"><?=gettext(\"External Signing Request\");?></td>\n                </tr>\n              </thead>\n              <tbody>\n                <tr>\n                  <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Key Type\");?></td>\n                  <td style=\"width:78%\">\n                    <select name='csr_keytype' id='csr_keytype' class=\"selectpicker\">\n                  <option value=\"RSA\" <?=$pconfig['csr_keytype'] == \"RSA\" ? \"selected=\\\"selected\\\"\" : \"\";?>>\n                    <?=gettext(\"RSA\");?>\n                  </option>\n                  <option value=\"Elliptic Curve\" <?=$pconfig['csr_keytype'] == \"Elliptic Curve\" ? \"selected=\\\"selected\\\"\" : \"\";?>>\n                    <?=gettext(\"Elliptic Curve\");?>\n                  </option>\n                    </select>\n                  </td>\n                </tr>\n                <tr id='csr_RSA'>\n                  <td style=\"width:22%\"><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Key length\");?> (<?=gettext(\"bits\");?>)</td>\n                  <td style=\"width:78%\">\n                    <select name='csr_keylen' class=\"selectpicker\">\n<?php\n                    foreach ($cert_keylens as $len) :?>\n                      <option value=\"<?=$len;?>\" <?=isset($pconfig['csr_keylen']) && $pconfig['csr_keylen'] == $len ? \"selected=\\\"selected\\\"\" : \"\";?>><?=$len;?></option>\n<?php\n                    endforeach; ?>\n                    </select>\n                </td>\n              </tr>\n              <tr id='csr_blank'><td></td></tr>\n              <tr id='csr_EC'>\n                  <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Curve\");?></td>\n                  <td style=\"width:78%\">\n                    <select name='csr_curve' id='csr_curve' class=\"selectpicker\">\n<?php\n                    foreach ($cert_curves as $curve) :?>\n                      <option value=\"<?=$curve;?>\" <?=isset($pconfig['csr_curve']) && $pconfig['csr_curve'] == $curve ? \"selected=\\\"selected\\\"\" : \"\";?>><?=$curve;?></option>\n<?php\n                    endforeach; ?>\n                    </select>\n                  </td>\n                </tr>\n              <tr>\n                <td><a id=\"help_for_csr_digest_alg\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Digest Algorithm\");?></td>\n                <td>\n                  <select name='csr_digest_alg'>\n<?php\n                  foreach ($openssl_digest_algs as $csr_digest_alg) :?>\n                    <option value=\"<?=$csr_digest_alg;?>\" <?=$pconfig['csr_digest_alg'] == $csr_digest_alg ? \"selected=\\\"selected\\\"\" : \"\";?>>\n                      <?=strtoupper($csr_digest_alg);?>\n                    </option>\n<?php\n                  endforeach; ?>\n                  </select>\n                  <div class=\"hidden\" data-for=\"help_for_csr_digest_alg\">\n                    <?= gettext(\"NOTE: It is recommended to use an algorithm stronger than SHA1 when possible.\") ?>\n                  </div>\n                </td>\n              </tr>\n              <tr>\n                <th colspan=\"2\"><?=gettext(\"Distinguished name\");?> </th>\n              </tr>\n              <tr>\n                <td><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Country Code\");?> : &nbsp;</td>\n                <td>\n                  <select name=\"csr_dn_country\" id=\"csr_dn_country\" class=\"selectpicker\">\n<?php\n                  foreach (get_country_codes() as $cc => $cn):?>\n                    <option value=\"<?=$cc;?>\" <?=$pconfig['csr_dn_country'] == $cc ? \"selected=\\\"selected\\\"\" : \"\";?>>\n                      <?=$cc;?> (<?=$cn;?>)\n                    </option>\n<?php\n                  endforeach;?>\n                  </select>\n                </td>\n              </tr>\n              <tr>\n                <td><a id=\"help_for_digest_csr_dn_state\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"State or Province\");?> : &nbsp;</td>\n                <td>\n                  <input name=\"csr_dn_state\" type=\"text\" size=\"40\" value=\"<?=$pconfig['csr_dn_state'];?>\"/>\n                  <div class=\"hidden\" data-for=\"help_for_digest_csr_dn_state\">\n                    <em><?=gettext(\"ex:\");?></em>\n                    &nbsp;\n                    <?=gettext(\"Sachsen\");?>\n                  </div>\n                </td>\n              </tr>\n              <tr>\n                <td><a id=\"help_for_digest_csr_dn_city\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"City\");?> : &nbsp;</td>\n                <td>\n                  <input name=\"csr_dn_city\" type=\"text\" size=\"40\" value=\"<?=$pconfig['csr_dn_city'];?>\"/>\n                  <div class=\"hidden\" data-for=\"help_for_digest_csr_dn_city\">\n                    <em><?=gettext(\"ex:\");?></em>\n                    &nbsp;\n                    <?=gettext(\"Leipzig\");?>\n                  </div>\n                </td>\n              </tr>\n              <tr>\n                <td><a id=\"help_for_digest_csr_dn_organization\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Organization\");?> : &nbsp;</td>\n                <td>\n                  <input name=\"csr_dn_organization\" type=\"text\" size=\"40\" value=\"<?=$pconfig['csr_dn_organization'];?>\"/>\n                  <div class=\"hidden\" data-for=\"help_for_digest_csr_dn_organization\">\n                    <em><?=gettext(\"ex:\");?></em>\n                    &nbsp;\n                    <?=gettext(\"My Company Inc\");?>\n                  </div>\n                </td>\n              </tr>\n              <tr>\n                <td><a id=\"help_for_digest_csr_dn_organizationalunit\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Organizational Unit\");?> : &nbsp;</td>\n                <td>\n                  <input name=\"csr_dn_organizationalunit\" type=\"text\" size=\"40\" value=\"<?=$pconfig['csr_dn_organizationalunit'];?>\"/>\n                  <div class=\"hidden\" data-for=\"help_for_digest_csr_dn_organizationalunit\">\n                    <em><?=gettext(\"ex:\");?></em>\n                    &nbsp;\n                    <?=gettext(\"IT department\");?>\n                  </div>\n                </td>\n              </tr>\n              <tr>\n                <td><a id=\"help_for_digest_csr_dn_email\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Email Address\");?> : &nbsp;</td>\n                <td>\n                  <input name=\"csr_dn_email\" type=\"text\" size=\"25\" value=\"<?=$pconfig['csr_dn_email'];?>\"/>\n                  <div class=\"hidden\" data-for=\"help_for_digest_csr_dn_email\">\n                    <em><?=gettext(\"ex:\");?></em>\n                    &nbsp;\n                    <?=gettext(\"admin@mycompany.com\");?>\n                  </div>\n                </td>\n              </tr>\n              <tr>\n                <td><a id=\"help_for_digest_csr_dn_commonname\" href=\"#\" class=\"showhelp\"><i class=\"fa fa-info-circle\"></i></a> <?=gettext(\"Common Name\");?> : &nbsp;</td>\n                <td>\n                  <input name=\"csr_dn_commonname\" type=\"text\" size=\"25\" value=\"<?=$pconfig['csr_dn_commonname'];?>\"/>\n                  <div class=\"hidden\" data-for=\"help_for_digest_csr_dn_commonname\">\n                    <em><?=gettext(\"ex:\");?></em>\n                    &nbsp;\n                    <?=gettext(\"internal-ca\");?>\n                  </div>\n                </td>\n              </tr>\n            </tbody>\n          </table>\n          <!-- choose existing cert -->\n          <table id=\"existing\" class=\"table table-striped\">\n            <thead>\n              <tr>\n                <th colspan=\"2\"><?=gettext(\"Choose an Existing Certificate\");?></th>\n              </tr>\n            </thead>\n              <tbody>\n              <tr>\n                <td style=\"width:22%\"><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Existing Certificates\");?></td>\n                <td style=\"width:78%\">\n                  <select name='certref'>\n<?php\n                  foreach ($config['cert'] as $cert) :\n                      $caname = \"\";\n                      $usercert = isset($config['system']['user'][$userid]['cert']) ? $config['system']['user'][$userid]['cert'] : array();\n                      if (isset($userid) && in_array($cert['refid'], $usercert)) {\n                          continue;\n                      }\n                      if (isset($cert['caref'])) {\n                          $ca = lookup_ca($cert['caref']);\n                          if ($ca) {\n                              $caname = \" (CA: {$ca['descr']})\";\n                          }\n                      }?>\n                    <option value=\"<?=$cert['refid'];?>\" <?=isset($pconfig['certref']) && isset($cert['refid']) && $pconfig['certref'] == $cert['refid'] ? \"selected=\\\"selected\\\"\" : \"\";?>>\n                      <?=$cert['descr'];?> <?=$caname;?>\n                      <?=isset($cert['refid']) && cert_in_use($cert['refid']) ? gettext(\"*In Use\") : \"\";?>\n                      <?=is_cert_revoked($cert) ? gettext(\"*Revoked\") :\"\";?>\n                    </option>\n<?php\n                  endforeach; ?>\n                  </select>\n                </td>\n              </tr>\n              </tbody>\n            </table>\n            <!-- submit -->\n            <table class=\"table\">\n              <tr>\n                <td style=\"width:22%\">&nbsp;</td>\n                <td style=\"width:78%\">\n                  <input id=\"submit\" name=\"save\" type=\"submit\" class=\"btn btn-primary\" value=\"<?=html_safe(gettext('Save'));?>\" />\n                </td>\n              </tr>\n            </table>\n          </form>\n          <!--- CSR --->\n<?php\n          elseif ($act == \"csr\") :\n?>\n\n          <form method=\"post\" name=\"iform\" id=\"iform\">\n            <input name=\"act\" type=\"hidden\" value=\"csr\" />\n<?php\n            if (isset($id)) :?>\n            <input name=\"id\" type=\"hidden\" value=\"<?=htmlspecialchars($id);?>\" />\n<?php\n            endif;?>\n            <table class=\"table table-striped\">\n              <tr>\n                <td style=\"width:22%\"><i class=\"fa fa-info-circle text-muted\"></i> <?=gettext(\"Descriptive name\");?></td>\n                <td style=\"width:78%\">\n                  <input name=\"descr\" type=\"text\" id=\"descr\" readonly=\"readonly\" value=\"<?=$pconfig['descr'];?>\"/>\n                </td>\n              </tr>\n              <tr>\n                <td colspan=\"2\" class=\"list\" height=\"12\"></td>\n              </tr>\n              <tr>\n                <td colspan=\"2\"><?=gettext(\"Complete Signing Request\");?></td>\n              </tr>\n              <tr>\n                <td><?=gettext(\"Signing request data\");?></td>\n                <td>\n                  <textarea name=\"csr\" id=\"csr\" cols=\"65\" rows=\"7\" readonly=\"readonly\"><?=$pconfig['csr'];?></textarea>\n                  <br />\n                  <?=gettext(\"Copy the certificate signing data from here and forward it to your certificate authority for signing.\");?>\n                </td>\n              </tr>\n              <tr>\n                <td><?=gettext(\"Final certificate data\");?></td>\n                <td>\n                  <textarea name=\"cert\" id=\"cert\" cols=\"65\" rows=\"7\"><?=$pconfig['cert'];?></textarea>\n                  <br />\n                  <?=gettext(\"Paste the certificate received from your certificate authority here.\");?>\n                </td>\n              </tr>\n              <tr>\n                <td>&nbsp;</td>\n                <td>\n                  <input id=\"submit\" name=\"update\" type=\"submit\" class=\"btn btn-primary\" value=\"<?= html_safe(gettext('Update')) ?>\" />\n                </td>\n              </tr>\n            </table>\n          </form>\n          <!--- Download Private key -->\n<?php\n          elseif ($act == \"download_private_key\"):?>\n\n          <table class=\"table table-striped opnsense_standard_table_form\">\n            <thead>\n              <tr>\n                <th colspan=\"2\"><?= gettext('Certificate has been issued.'); ?></th>\n              </tr>\n            </thead>\n            <tbody>\n                <tr>\n                  <td><?= gettext('Private key'); ?></td>\n                  <td>\n                    <textarea id=\"secret_key_for_cert\" cols=\"65\" rows=\"7\" data-filename=\"privatekey.pem\"><?= $pconfig['private_key']; ?></textarea>\n                    <small><?= gettext('The private key is not saved and no longer downloadable after closing this window.'); ?><br/></small>\n                    <a href=\"#\" for=\"secret_key_for_cert\" id=\"download_private_key_link\" class=\"btn btn-primary text_download_btn\">\n                      <?= gettext('Download Private Key'); ?>\n                    </a>\n                  </td>\n                </tr>\n                <tr>\n                  <td><?= gettext('Certificate'); ?></td>\n                  <td>\n                    <textarea id=\"cert_just_created\" cols=\"65\" rows=\"7\" data-filename=\"certificate.pem\"><?= html_safe(base64_decode($cert['crt'])); ?></textarea>\n                    <small><?= gettext('You can download, revise, or add to CRL later.'); ?><br/></small>\n                    <a href=\"#\" for=\"cert_just_created\" id=\"download_cert_link\" class=\"btn btn-primary text_download_btn\"><?= gettext('Download Certificate'); ?></a>\n                  </td>\n                </tr>\n                <tr>\n                    <td></td>\n                    <td>\n                      <a href=\"/system_certmanager.php\" class=\"btn btn-primary\"><?= gettext('Go back'); ?></a>\n                    </td>\n                </tr>\n            </tbody>\n          </table>\n\n<?php\n          else :?>\n          <form method=\"post\" name=\"iform\" id=\"iform\">\n            <input type=\"hidden\" name=\"id\" id=\"id\" value=\"<?=isset($id) ? $id :\"\";?>\"/>\n            <input type=\"hidden\" name=\"act\" id=\"action\" value=\"<?=$act;?>\"/>\n          </form>\n          <table class=\"table table-striped\">\n            <thead>\n              <tr>\n                <th><?=gettext(\"Name\");?></th>\n                <th><?=gettext(\"Issuer\");?></th>\n                <th><?=gettext(\"Distinguished Name\");?></th>\n                <th class=\"text-nowrap\">\n                  <a href=\"system_certmanager.php?act=new\" class=\"btn btn-primary btn-xs\" data-toggle=\"tooltip\" title=\"<?= html_safe(gettext('Add')) ?>\">\n                    <i class=\"fa fa-plus fa-fw\"></i>\n                  </a>\n                </th>\n              </tr>\n            </thead>\n            <tbody>\n<?php\n            $i = 0;\n            foreach ($a_cert as $cert) :\n                $name = $cert['descr'];\n                $purpose = null;\n\n                if (!empty($cert['crt'])) {\n                    $subj = cert_get_subject($cert['crt']);\n                    $issuer = cert_get_issuer($cert['crt']);\n                    $purpose = cert_get_purpose($cert['crt']);\n                    list($startdate, $enddate) = cert_get_dates($cert['crt']);\n                    if ($subj==$issuer) {\n                        $caname = \"<em>\" . gettext(\"self-signed\") . \"</em>\";\n                    } else {\n                        $caname = \"<em>\" . gettext(\"external\"). \"</em>\";\n                    }\n                    $subj = htmlspecialchars($subj);\n                }\n                if (isset($cert['csr'])) {\n                    $subj = htmlspecialchars(csr_get_subject($cert['csr']));\n                    $caname = \"<em>\" . gettext(\"external - signature pending\") . \"</em>\";\n                }\n                if (isset($cert['caref'])) {\n                    $ca = lookup_ca($cert['caref']);\n                    if ($ca) {\n                        $caname = $ca['descr'];\n                    }\n                }?>\n              <tr>\n                <td>\n                  <i class=\"fa fa-certificate\"></i>\n                  <?=$name;?>\n<?php\n                  if (is_array($purpose)) :?>\n                  <br/><br/>\n                  <?=gettext('CA:') ?> <?=$purpose['ca']; ?>,\n                  <?=gettext('Server:') ?> <?=$purpose['server']; ?>\n<?php\n                  endif; ?>\n                </td>\n                <td><?=$caname;?>&nbsp;</td>\n                <td><?=$subj;?>&nbsp;<br />\n                  <table>\n                      <tr>\n                          <td style=\"width:10%\">&nbsp;</td>\n                          <td style=\"width:20%\"><?=gettext(\"Valid From\")?>:</td>\n                          <td style=\"width:70%\"><?= $startdate ?></td>\n                      </tr>\n                      <tr>\n                          <td>&nbsp;</td>\n                          <td><?=gettext(\"Valid Until\")?>:</td>\n                          <td><?= $enddate ?></td>\n                      </tr>\n                  </table>\n                </td>\n                <td class=\"text-nowrap\">\n<?php\n                if (is_cert_revoked($cert)) :?>\n                  <b><?=gettext('Revoked') ?></b><br />\n<?php\n                endif;\n                if (!isset($cert['prv'])) :?>\n                  <b><?=gettext('No private key here') ?></b><br />\n<?php\n                endif;\n                if (is_webgui_cert($cert['refid'])) :?>\n                  <?=gettext('Web GUI') ?><br />\n<?php\n                endif;\n                if (is_user_cert($cert['refid'])) :?>\n                  <?=gettext('User Cert') ?><br />\n<?php\n                endif;\n                if (is_openvpn_server_cert($cert['refid'])) :?>\n                  <?=gettext('OpenVPN Server') ?><br />\n<?php\n                endif;\n                if (is_openvpn_client_cert($cert['refid'])) :?>\n                  <?=gettext('OpenVPN Client') ?><br />\n<?php\n                endif;\n                if (is_ipsec_cert($cert['refid'])) :?>\n                  <?=gettext('IPsec Tunnel') ?><br />\n<?php\n                endif; ?>\n\n<?php if (isset($cert['crt'])): ?>\n                  <a href=\"#\" class=\"btn btn-default btn-xs act_info\" data-id=\"<?=$i;?>\" data-toggle=\"tooltip\" title=\"<?=gettext(\"show certificate info\");?>\">\n                    <i class=\"fa fa-info-circle fa-fw\"></i>\n                  </a>\n<?php endif ?>\n                  <a href=\"system_certmanager.php?act=exp&amp;id=<?=$i;?>\" class=\"btn btn-default btn-xs\" data-toggle=\"tooltip\" title=\"<?=gettext(\"export user cert\");?>\">\n                      <i class=\"fa fa-download fa-fw\"></i>\n                  </a>\n<?php if (isset($cert['prv'])): ?>\n                  <a href=\"system_certmanager.php?act=key&amp;id=<?=$i;?>\" class=\"btn btn-default btn-xs\" data-toggle=\"tooltip\" title=\"<?=gettext(\"export user key\");?>\">\n                    <i class=\"fa fa-download fa-fw\"></i>\n                  </a>\n                  <a data-id=\"<?=$i;?>\"  class=\"btn btn-default btn-xs p12btn\" data-toggle=\"tooltip\" title=\"<?=gettext(\"export ca+user cert+user key in .p12 format\");?>\">\n                      <i class=\"fa fa-download fa-fw\"></i>\n                  </a>\n<?php endif ?>\n<?php if (!cert_in_use($cert['refid'])): ?>\n                  <a id=\"del_<?=$i;?>\" data-id=\"<?=$i;?>\" title=\"<?=gettext(\"delete cert\"); ?>\" data-toggle=\"tooltip\"  class=\"act_delete btn btn-default btn-xs\">\n                    <i class=\"fa fa-trash fa-fw\"></i>\n                  </a>\n<?php endif ?>\n<?php if (isset($cert['csr'])): ?>\n                  <a href=\"system_certmanager.php?act=csr&amp;id=<?=$i;?>\" class=\"btn btn-default btn-xs\" data-toggle=\"tooltip\" title=\"<?=gettext(\"update csr\");?>\">\n                    <i class=\"fa fa-pencil fa-fw\"></i>\n                  </a>\n<?php endif ?>\n                </td>\n              </tr>\n<?php\n              $i++;\n              endforeach; ?>\n\n            </tbody>\n          </table>\n<?php\n          endif; ?>\n        </div>\n      </section>\n    </div>\n  </div>\n</section>\n<?php include(\"foot.inc\");\n"], "filenames": ["src/www/system_camanager.php", "src/www/system_certmanager.php"], "buggy_code_start_loc": [434, 814], "buggy_code_end_loc": [434, 814], "fixing_code_start_loc": [435, 815], "fixing_code_end_loc": [436, 816], "type": "CWE-79", "message": "A cross-site scripting (XSS) vulnerability in the act parameter of system_certmanager.php in OPNsense Community Edition before 23.7 and Business Edition before 23.4.2 allows attackers to execute arbitrary web scripts or HTML via a crafted payload.", "other": {"cve": {"id": "CVE-2023-39002", "sourceIdentifier": "cve@mitre.org", "published": "2023-08-09T19:15:14.900", "lastModified": "2023-10-10T23:15:10.367", "vulnStatus": "Modified", "descriptions": [{"lang": "en", "value": "A cross-site scripting (XSS) vulnerability in the act parameter of system_certmanager.php in OPNsense Community Edition before 23.7 and Business Edition before 23.4.2 allows attackers to execute arbitrary web scripts or HTML via a crafted payload."}, {"lang": "es", "value": "Una vulnerabilidad de Cross-Site Scripting (XSS) en el par\u00e1metro act de system_certmanager.php en OPNsense Community Edition antes de 23.7 y Business Edition antes de 23.4.2 permite a los atacantes ejecutar secuencias de comandos web o HTML arbitrarias a trav\u00e9s de una carga \u00fatil manipulada."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:opnsense:opnsense:*:*:*:*:*:*:*:*", "versionEndExcluding": "23.7", "matchCriteriaId": "E4C1BDFF-B6E1-4F82-9957-1FFA069E2EDC"}]}]}], "references": [{"url": "https://github.com/opnsense/core/commit/a4f6a8f8d604271f81984cfcbba0471af58e34dc", "source": "cve@mitre.org", "tags": ["Patch"]}, {"url": "https://logicaltrust.net/blog/2023/08/opnsense.html", "source": "cve@mitre.org", "tags": ["Exploit", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/opnsense/core/commit/a4f6a8f8d604271f81984cfcbba0471af58e34dc"}}