{"buggy_code": ["auth:    $sql = \"SELECT Handle, Name, Profile_Text, Avatar, Email_Addr, Activated FROM Users WHERE ID='$UID'\";\nevaluate_cookie:  $sql = \"SELECT SessionKey, UserID, IP FROM Session WHERE SessionKey='$e_key'\";\nevaluate_password:  $sql = \"SELECT Handle, Email_Addr, Password_Hash FROM Users WHERE Handle='$e_uname' || Email_Addr='$e_uname'\";\nevaluate_signup:    $sql = \"SELECT Email_Addr FROM Users WHERE Email_Addr='$e_email'\";\nevaluate_signup:    $sql = \"SELECT Handle FROM Users WHERE Handle='$e_uname'\";\nklattr_retrieve_queries:  $sql = \"SELECT ID, Subscribed_To FROM Users WHERE Handle='$profileID'\";\nklattr_retrieve_queries:  $sql = \"SELECT ID, Handle, Name, Profile_Text FROM Users WHERE Handle REGEXP '\" . $sub_regexp . \"' \" . $oldest_text . \"AND Activated = '1' ORDER BY ID DESC LIMIT 0, 10\";\nklattr_retrieve_queries:  $sql = \"SELECT Povs.Recipient, Povs.Num_Replies, Povs.ID, Povs.Title, Povs.Tags, Povs.Data, Povs.Private, Povs.Time_Posted, Povs.Waveform, Users.Handle FROM Users INNER JOIN Povs ON Povs.Poster=Users.ID WHERE Povs.Parent_ID='$parentId' AND Povs.Private='0' AND Users.Activated = '1' ORDER BY ID DESC LIMIT 0, 10\";\nklattr_retrieve_queries:  $sql = \"SELECT ID, Handle, Name, Profile_Text FROM Users WHERE (Handle REGEXP '$searchTerm' OR Name REGEXP '$searchTerm')\" . $oldest_text . \" AND Activated = '1' ORDER BY ID DESC LIMIT 0, \" . $search_limit;\nklattr_retrieve_queries:  $sql = \"SELECT Povs.Recipient, Povs.Num_Replies, Povs.ID, Povs.Title, Povs.Tags, Povs.Data, Povs.Private, Povs.Time_Posted, Povs.Waveform, Users.Handle FROM Users INNER JOIN Povs ON Povs.Poster=Users.ID WHERE Povs.Poster='$profileID' AND Povs.Private='0' \" . $oldest_text . \" AND Users.Activated = '1' ORDER BY ID DESC LIMIT 0, 10\";\nklattr_retrieve_queries:  $sql = \"SELECT Subscribed_To FROM Users WHERE ID='$UID'\";\nklattr_retrieve_queries:  $sql = \"SELECT Povs.Recipient, Povs.Num_Replies, Povs.ID, Povs.Title, Povs.Tags, Povs.Data, Povs.Private, Povs.Time_Posted, Povs.Waveform, Users.Handle FROM Users INNER JOIN Povs ON Povs.Poster=Users.ID WHERE (\" . $sub_regexp . \"INSTR(Povs.Recipient, '$uname_plus_space') > 0 OR Povs.Poster='$UID') AND Povs.Private='0' \" . $oldest_text . \" AND Users.Activated = '1'ORDER BY ID DESC LIMIT 0, 10\";\nklattr_retrieve_queries:  $sql = \"SELECT Povs.Recipient, Povs.Num_Replies, Povs.ID, Povs.Title, Povs.Tags, Povs.Data, Povs.Private, Povs.Time_Posted, Povs.Waveform, Users.Handle FROM Users INNER JOIN Povs ON Povs.Poster=Users.ID WHERE (Povs.Tags REGEXP '$searchTerm' OR Povs.Title REGEXP '$searchTerm') AND Povs.Private='0' \" . $oldest_text . \" AND Users.Activated = '1'ORDER BY ID DESC LIMIT 0, 10\";\nklattr_retrieve_queries:  $sql = \"SELECT Povs.Recipient, Povs.Num_Replies, Povs.ID, Povs.Title, Povs.Tags, Povs.Data, Povs.Private, Povs.Time_Posted, Povs.Waveform, Users.Handle FROM Users INNER JOIN Povs ON Povs.Poster=Users.ID WHERE (INSTR(Povs.Recipient, '$uname_plus_space') > 0) AND Povs.Private='0' \" . $oldest_text . \" AND Users.Activated = '1'ORDER BY ID DESC LIMIT 0, 10\";\nuser_page:  $sql = \"SELECT Handle, Name, Profile_Text, Website_Addr, Avatar, ID FROM Users WHERE Handle='$profileUname' AND BINARY(Handle) = BINARY('$profileUname') AND Activated = '1'\";\nuser_panel:$sql = \"SELECT ID, Subscribed_To FROM Users WHERE Handle='$panelName'\";\nuser_panel:$sql = \"SELECT COUNT(*) AS Count from Povs WHERE Poster='$panelUID'\";\nuser_panel:$sql = \"SELECT COUNT(*) AS Count from Users WHERE INSTR(Subscribed_To, '$handle_plus_space') > 0\";\nuser_panel:$sql = \"SELECT Handle FROM Users WHERE INSTR(Subscribed_To, '$handle_plus_space') > 0\";\nuser_panel:  $sql = \"SELECT Handle FROM Users WHERE Handle='$uname' AND INSTR(Subscribed_To, '$handle_plus_space') > 0\";\nuser_panel:      $sql = \"SELECT Activated FROM Users WHERE Handle='$sub'\";\n", "<?php\nif (isset($_COOKIE['session_auth'])) {\n  include \"/data/klattr.com/www/includes/open_db\";\n  include \"/data/klattr.com/www/includes/evaluate_cookie\";\n  $ip = $_SERVER['HTTP_X_REAL_IP'];\n  if ($ip == \"\") {\n    $ip = $_SERVER['REMOTE_ADDR'];\n  }\n  $cookie_key = $_COOKIE['session_auth'];\n  $UID = evaluate_cookie($cookie_key, $ip);\n  if ($UID !== 0) {\n    $profileText = $_POST[\"profileText\"];\n    $profileURL = $_POST[\"webAddress\"];\n    $senduname = $_POST[\"senduname\"];\n    $profileText = htmlspecialchars($profileText);\n    $profileText = addslashes($profileText);\n    if(strpos($profileURL, 'http') !== 0) {\n      $profileURL = \"http://\" . $profileURL;\n    }\n    if(!filter_var($profileURL, FILTER_VALIDATE_URL, FILTER_FLAG_HOST_REQUIRED)) {\n      $profileURL = \"\";\n    }\n    $sql = \"UPDATE Users SET Website_Addr='$profileURL', Profile_Text='$profileText' WHERE ID='$UID'\";\n    mysqli_query($con,$sql);\n    header( \"Location: https://klattr.com/$senduname\" );\n  }\n} else {\n  header( 'Location: https://klattr.com' );\n}\n?>\n", "<?php\n\n$accountLimit = 250;\n\nif (isset($_COOKIE['session_auth'])) {\n  header( 'Location: https://klattr.com' );\n} else {\n\n\n  include \"/data/klattr.com/www/includes/open_db\";\n  $sql = \"SELECT COUNT(*) AS Num FROM Users\";\n  $sql_result = mysqli_query($con,$sql);\n  $row = mysqli_fetch_array($sql_result);\n  if ($row['Num'] > $accountLimit) {\n?>\n\n<!DOCTYPE html>\n<?php include \"/data/klattr.com/www/includes/head\"; ?>\n  <body>\n    <?php include \"/data/klattr.com/www/includes/header\"; ?>\n\n<div id=\"body\">\n  <div class=\"body_center\">\n    <div class=\"welcome\" style=\"padding:10px; top:-70px;height:120px\">\n      <h1> Sorry. This beta is limited to <?php echo $accountLimit; ?> accounts. Please try later.</h1>\n    </div>\n  </div>\n</div>\n\n\n    <?php include \"/data/klattr.com/www/includes/footer\"; ?>\n  </body>\n</html>\n<?php\n  } else {\n\n\n\n \n    if (isset($_POST[\"name\"]) && isset($_POST[\"email\"]) && isset($_POST[\"password\"]) && isset($_POST[\"username\"])) {\n\n      $name = $_POST[\"name\"];\n      $email = $_POST[\"email\"];\n      $password = $_POST[\"password\"];\n      $username = $_POST[\"username\"];\n      $sticky = $_POST[\"stay_signed_in\"];\n      $expire_time = 0;\n      if ($sticky == \"yes\") {\n        $expire_time = time()+2592000;\n      }\n\n      include \"/data/klattr.com/www/includes/evaluate_signup\";\n\n      $e_n = evaluate_name($name);\n      $e_e = evaluate_email($email);\n      $e_p = evaluate_pass($password);\n      $e_u = evaluate_uname($username);\n\n      if ($e_n != 0 || $e_e != 0 || $e_p != 0 || $e_u != 0) {\n        $exists = $e_e + $e_u;\n        include \"/data/klattr.com/www/includes/signup_page\";\n      } else {\n        $enc_password = urlencode($password);\n        $password_hash = crypt($enc_password);\n#      $randkey = substr(str_shuffle(md5(time())),0,128);\n#      $randkey = substr(sha1(rand()), 0, 128);\n        $randomData = file_get_contents('/dev/urandom', false, null, 0, 128) . uniqid(mt_rand(), true);\n        $randkey = substr(str_replace(array('/','=','+'),'', base64_encode($randomData)),0,128);\n\n        $ip = $_SERVER['REMOTE_ADDR'];\n        $sql = \"INSERT INTO Users (Name, Email_Addr, Password_hash, Handle) VALUES ('$name','$email','$password_hash','$username')\";\n        mysqli_query($con,$sql);\n        $sql = \"SELECT ID FROM Users WHERE Handle='$username'\";\n        $sql_result = mysqli_query($con,$sql);\n        $row = mysqli_fetch_array($sql_result);\n        $UID = $row['ID'];\n        $session_date = date(\"Y-m-d h:i:s\");\n        $sql = \"INSERT INTO Session (SessionKey, UserID, IP, Date) VALUES ('$randkey','$UID','$ip','$session_date')\";\n        mysqli_query($con,$sql);\n        setcookie (\"session_auth\", $randkey, $expire_time, \"/\", \".klattr.com\");\n        $uname = $username;\n        $rname = $name;\n        $uEmailAddr = $email;\n        $first_mail = 1;\n        include \"/data/klattr.com/www/ht_docs/send_email.php\";\n        header( 'Location: https://klattr.com' );\n//      include \"/data/klattr.com/www/includes/signed_up\";\n      }\n    } else {\n\n  $name = $_POST[\"name\"];\n  $email = $_POST[\"email\"];\n  $password = $_POST[\"password\"];\n  $username = $_POST[\"username\"];\n\n  include \"/data/klattr.com/www/includes/signup_page\";\n    }\n  }\n}\n?>\n", "<?php \nif (isset($_COOKIE['session_auth'])) {\n  include \"/data/klattr.com/www/includes/open_db\";\n  include \"/data/klattr.com/www/includes/evaluate_cookie\";\n  $ip = $_SERVER['HTTP_X_REAL_IP'];\n  if ($ip == \"\") {\n    $ip = $_SERVER['REMOTE_ADDR'];\n  }\n  $cookie_key = $_COOKIE['session_auth'];\n  $UID = evaluate_cookie($cookie_key, $ip);\n  if ($UID !== 0) {\n    /*  $UID is now an SQL injection attack\n        if UID is just Numeric - then so if(!ctype_digit($UID)) { return false; }\n    */\n    $sql = \"SELECT Handle, Name, Profile_Text, Avatar, Email_Addr, Activated FROM Users WHERE ID='$UID'\";\n    $sql_result = mysqli_query($con,$sql);\n    $row = mysqli_fetch_array($sql_result);\n    $uname = $row['Handle'];\n    $rname = $row['Name'];\n    $uEmailAddr = $row['Email_Addr'];\n    $profile = $row['Profile_Text'];\n    if (empty($row['Avatar'])) {\n      $userPic = \"/gfx/default_user.png\";\n    } else {\n      $userPic = $uname . \".jpeg\";\n    }\n    if ($row['Activated'] == 1 || $activatePage == 1) {\n      $auth = 1;\n    } else {\n      header( 'Location: https://klattr.com/activate.php' );\n    }\n    \n\n\n  } else {\n    $auth = 0;\n  }\n} else {\n  $auth = 0;\n}\n", "<?php\nfunction evaluate_cookie ($e_key, $e_ip) {\n  global $con;\n  \n  /*\n    what is $e_key ? - should check it - SQL injection.  \n  */\n  \n  $sql = \"SELECT SessionKey, UserID, IP FROM Session WHERE SessionKey='$e_key'\";\n  $sql_result = mysqli_query($con,$sql);\n  $row = mysqli_fetch_array($sql_result);\n  if ($row['IP'] == $e_ip) {\n    $result = $row['UserID'];\n  } else {\n    $result = 0;\n  } \n  return $result;\n}\n?>\n", "<?php\n\nfunction evaluate_password ($e_uname, $e_password) {\n  global $con;\n  $sql = \"SELECT Handle, Email_Addr, Password_Hash FROM Users WHERE Handle='$e_uname' || Email_Addr='$e_uname'\";\n  $sql_result = mysqli_query($con,$sql);\n  $row = mysqli_fetch_array($sql_result);\n//echo $row['Handle'];\n  $enc_password = urlencode($e_password);\n  $password_hash = crypt($enc_password);\n\n    $result = $row['Handle'];\n\n  if ($e_password !== null && $e_password !== \"\") {\n    if ($row['Password_Hash'] == crypt($enc_password, $row['Password_Hash'])) {\n      //$result = 0;\n    } else {\n      $result = 1;\n    }  \n  } else {\n    $result = 1;\n  }\n  return $result;\n}\n?>\n", "<?php\n\nfunction evaluate_name ($e_name) {\n  if (preg_match(\"/^[a-zA-Z]+[a-zA-Z ]+$/\",$e_name)) {\n    $result = 0;\n  } else {\n    $result = 1;\n  }\n\n  return $result;\n}\n\n\nfunction evaluate_email ($e_email) {\n  global $con;\n  $email_regx = \"/^(([^<>()[\\]\\\\.,;:\\s@\\\"]+(\\.[^<>()[\\]\\\\.,;:\\s@\\\"]+)*)|(\\\".+\\\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\])|(([a-zA-Z\\-0-9]+\\.)+[a-zA-Z]{2,}))$/\";\n  if (preg_match($email_regx,$e_email)) {\n    $sql = \"SELECT Email_Addr FROM Users WHERE Email_Addr='$e_email'\";\n    $sql_result = mysqli_query($con,$sql);\n    $row = mysqli_fetch_array($sql_result);\n    if (strcmp($e_email,$row['Email_Addr'])==0) {\n      $result = 20;\n    } else {\n      $result = 0;\n    }\n  } else {\n    $result = 1;\n  }\n\n  return $result;\n}\n\nfunction evaluate_pass ($e_pass) {\n  if (strlen($e_pass) > 6) {\n    $result = 0;\n  } else {\n    $result = 1;\n  }\n\n  return $result;\n}\n\nfunction evaluate_uname ($e_uname) {\n  global $con;\n  if (preg_match(\"/^[a-zA-Z0-9_]+$/\",$e_uname)) {\n    $sql = \"SELECT Handle FROM Users WHERE Handle='$e_uname'\";\n    $sql_result = mysqli_query($con,$sql);\n    $row = mysqli_fetch_array($sql_result);\n    if (strcmp($e_uname,$row['Handle'])==0) {\n      $result = 2;\n   } else {\n      $result = 0;\n   }\n  } else {\n    $result = 1;\n  }\n\n  return $result;\n}\n\n?>\n"], "fixing_code": ["klattr_retrieve_queries:  $sql = \"SELECT ID, Subscribed_To FROM Users WHERE Handle='$profileID'\";\nklattr_retrieve_queries:  $sql = \"SELECT ID, Handle, Name, Profile_Text FROM Users WHERE Handle REGEXP '\" . $sub_regexp . \"' \" . $oldest_text . \"AND Activated = '1' ORDER BY ID DESC LIMIT 0, 10\";\nklattr_retrieve_queries:  $sql = \"SELECT Povs.Recipient, Povs.Num_Replies, Povs.ID, Povs.Title, Povs.Tags, Povs.Data, Povs.Private, Povs.Time_Posted, Povs.Waveform, Users.Handle FROM Users INNER JOIN Povs ON Povs.Poster=Users.ID WHERE Povs.Parent_ID='$parentId' AND Povs.Private='0' AND Users.Activated = '1' ORDER BY ID DESC LIMIT 0, 10\";\nklattr_retrieve_queries:  $sql = \"SELECT ID, Handle, Name, Profile_Text FROM Users WHERE (Handle REGEXP '$searchTerm' OR Name REGEXP '$searchTerm')\" . $oldest_text . \" AND Activated = '1' ORDER BY ID DESC LIMIT 0, \" . $search_limit;\nklattr_retrieve_queries:  $sql = \"SELECT Povs.Recipient, Povs.Num_Replies, Povs.ID, Povs.Title, Povs.Tags, Povs.Data, Povs.Private, Povs.Time_Posted, Povs.Waveform, Users.Handle FROM Users INNER JOIN Povs ON Povs.Poster=Users.ID WHERE Povs.Poster='$profileID' AND Povs.Private='0' \" . $oldest_text . \" AND Users.Activated = '1' ORDER BY ID DESC LIMIT 0, 10\";\nklattr_retrieve_queries:  $sql = \"SELECT Subscribed_To FROM Users WHERE ID='$UID'\";\nklattr_retrieve_queries:  $sql = \"SELECT Povs.Recipient, Povs.Num_Replies, Povs.ID, Povs.Title, Povs.Tags, Povs.Data, Povs.Private, Povs.Time_Posted, Povs.Waveform, Users.Handle FROM Users INNER JOIN Povs ON Povs.Poster=Users.ID WHERE (\" . $sub_regexp . \"INSTR(Povs.Recipient, '$uname_plus_space') > 0 OR Povs.Poster='$UID') AND Povs.Private='0' \" . $oldest_text . \" AND Users.Activated = '1'ORDER BY ID DESC LIMIT 0, 10\";\nklattr_retrieve_queries:  $sql = \"SELECT Povs.Recipient, Povs.Num_Replies, Povs.ID, Povs.Title, Povs.Tags, Povs.Data, Povs.Private, Povs.Time_Posted, Povs.Waveform, Users.Handle FROM Users INNER JOIN Povs ON Povs.Poster=Users.ID WHERE (Povs.Tags REGEXP '$searchTerm' OR Povs.Title REGEXP '$searchTerm') AND Povs.Private='0' \" . $oldest_text . \" AND Users.Activated = '1'ORDER BY ID DESC LIMIT 0, 10\";\nklattr_retrieve_queries:  $sql = \"SELECT Povs.Recipient, Povs.Num_Replies, Povs.ID, Povs.Title, Povs.Tags, Povs.Data, Povs.Private, Povs.Time_Posted, Povs.Waveform, Users.Handle FROM Users INNER JOIN Povs ON Povs.Poster=Users.ID WHERE (INSTR(Povs.Recipient, '$uname_plus_space') > 0) AND Povs.Private='0' \" . $oldest_text . \" AND Users.Activated = '1'ORDER BY ID DESC LIMIT 0, 10\";\nuser_page:  $sql = \"SELECT Handle, Name, Profile_Text, Website_Addr, Avatar, ID FROM Users WHERE Handle='$profileUname' AND BINARY(Handle) = BINARY('$profileUname') AND Activated = '1'\";\nuser_panel:$sql = \"SELECT ID, Subscribed_To FROM Users WHERE Handle='$panelName'\";\nuser_panel:$sql = \"SELECT COUNT(*) AS Count from Povs WHERE Poster='$panelUID'\";\nuser_panel:$sql = \"SELECT COUNT(*) AS Count from Users WHERE INSTR(Subscribed_To, '$handle_plus_space') > 0\";\nuser_panel:$sql = \"SELECT Handle FROM Users WHERE INSTR(Subscribed_To, '$handle_plus_space') > 0\";\nuser_panel:  $sql = \"SELECT Handle FROM Users WHERE Handle='$uname' AND INSTR(Subscribed_To, '$handle_plus_space') > 0\";\nuser_panel:      $sql = \"SELECT Activated FROM Users WHERE Handle='$sub'\";\n", "<?php\ninclude \"/data/klattr.com/www/includes/auth\";\nif ($auth == 1) {\n  $profileText = $_POST[\"profileText\"];\n  $profileURL = $_POST[\"webAddress\"];\n  $senduname = $_POST[\"senduname\"];\n  if(strpos($profileURL, 'http') !== 0) {\n    $profileURL = \"http://\" . $profileURL;\n  }\n  if(!filter_var($profileURL, FILTER_VALIDATE_URL, FILTER_FLAG_HOST_REQUIRED)) {\n    $profileURL = \"\";\n  }\n/*Sanitize the vars that are going into the database*/\n  $profileText = htmlspecialchars($profileText);\n  $profileText = addslashes($profileText);\n  $profileURL = htmlspecialchars($profileURL);\n  $profileURL = addslashes($profileURL);\n\n\n  $sql = \"UPDATE Users SET Website_Addr='$profileURL', Profile_Text='$profileText' WHERE ID='$UID'\";\n  mysqli_query($con,$sql);\n  header( \"Location: https://klattr.com/$senduname\" );\n  } else {\n  header( 'Location: https://klattr.com' );\n}\n?>\n", "<?php\n\n$accountLimit = 250;\n\nif (isset($_COOKIE['session_auth'])) {\n  header( 'Location: https://klattr.com' );\n} else {\n\n\n  include \"/data/klattr.com/www/includes/open_db\";\n  $sql = \"SELECT COUNT(*) AS Num FROM Users\";\n  $sql_result = mysqli_query($con,$sql);\n  $row = mysqli_fetch_array($sql_result);\n  if ($row['Num'] > $accountLimit) {\n?>\n\n<!DOCTYPE html>\n<?php include \"/data/klattr.com/www/includes/head\"; ?>\n  <body>\n    <?php include \"/data/klattr.com/www/includes/header\"; ?>\n\n<div id=\"body\">\n  <div class=\"body_center\">\n    <div class=\"welcome\" style=\"padding:10px; top:-70px;height:120px\">\n      <h1> Sorry. This beta is limited to <?php echo $accountLimit; ?> accounts. Please try later.</h1>\n    </div>\n  </div>\n</div>\n\n\n    <?php include \"/data/klattr.com/www/includes/footer\"; ?>\n  </body>\n</html>\n<?php\n  } else {\n\n\n\n \n    if (isset($_POST[\"name\"]) && isset($_POST[\"email\"]) && isset($_POST[\"password\"]) && isset($_POST[\"username\"])) {\n\n      $name = $_POST[\"name\"];\n      $email = $_POST[\"email\"];\n      $password = $_POST[\"password\"];\n      $username = $_POST[\"username\"];\n      $sticky = $_POST[\"stay_signed_in\"];\n      $expire_time = 0;\n      if ($sticky == \"yes\") {\n        $expire_time = time()+2592000;\n      }\n\n      include \"/data/klattr.com/www/includes/evaluate_signup\";\n\n      $e_n = evaluate_name($name);\n      $e_e = evaluate_email($email);\n      $e_p = evaluate_pass($password);\n      $e_u = evaluate_uname($username);\n\n      if ($e_n != 0 || $e_e != 0 || $e_p != 0 || $e_u != 0) {\n        $exists = $e_e + $e_u;\n        include \"/data/klattr.com/www/includes/signup_page\";\n      } else {\n        $enc_password = urlencode($password);\n        $password_hash = crypt($enc_password);\n#      $randkey = substr(str_shuffle(md5(time())),0,128);\n#      $randkey = substr(sha1(rand()), 0, 128);\n        $randomData = file_get_contents('/dev/urandom', false, null, 0, 128) . uniqid(mt_rand(), true);\n        $randkey = substr(str_replace(array('/','=','+'),'', base64_encode($randomData)),0,128);\n\n        $ip = $_SERVER['REMOTE_ADDR'];\n        $sql = \"INSERT INTO Users (Name, Email_Addr, Password_hash, Handle) VALUES ('$name','$email','$password_hash','$username')\";\n        mysqli_query($con,$sql);\n        $sql = \"SELECT ID FROM Users WHERE Handle='$username'\";\n        $sql_result = mysqli_query($con,$sql);\n        $row = mysqli_fetch_array($sql_result);\n        $UID = $row['ID'];\n        $session_date = date(\"Y-m-d h:i:s\");\n        setcookie (\"session_auth\", $randkey, $expire_time, \"/\", \".klattr.com\");\n/*make sure the cookie in the database matches sanitized cookie from user*/\n        $randkey = htmlspecialchars($randkey);\n        $randkey = addslashes($randkey);\n\n        $sql = \"INSERT INTO Session (SessionKey, UserID, IP, Date) VALUES ('$randkey','$UID','$ip','$session_date')\";\n        mysqli_query($con,$sql);\n        $uname = $username;\n        $rname = $name;\n        $uEmailAddr = $email;\n        $first_mail = 1;\n        include \"/data/klattr.com/www/ht_docs/send_email.php\";\n        header( 'Location: https://klattr.com' );\n//      include \"/data/klattr.com/www/includes/signed_up\";\n      }\n    } else {\n\n  $name = $_POST[\"name\"];\n  $email = $_POST[\"email\"];\n  $password = $_POST[\"password\"];\n  $username = $_POST[\"username\"];\n\n  include \"/data/klattr.com/www/includes/signup_page\";\n    }\n  }\n}\n?>\n", "<?php \nif (isset($_COOKIE['session_auth'])) {\n  include \"/data/klattr.com/www/includes/open_db\";\n  include \"/data/klattr.com/www/includes/evaluate_cookie\";\n  $ip = $_SERVER['HTTP_X_REAL_IP'];\n  if ($ip == \"\") {\n    $ip = $_SERVER['REMOTE_ADDR'];\n  }\n  $cookie_key = $_COOKIE['session_auth'];\n/* Sanitize $cookie_key */\n  $cookie_key = htmlspecialchars($cookie_key);\n  $cookie_key = addslashes($cookie_key);\n\n  $UID = evaluate_cookie($cookie_key, $ip);\n  if ($UID !== 0) {\n    /*  $UID is now an SQL injection attack\n        if UID is just Numeric - then so if(!ctype_digit($UID)) { return false; }\n    */\n    $sql = \"SELECT Handle, Name, Profile_Text, Avatar, Email_Addr, Activated FROM Users WHERE ID='$UID'\";\n    $sql_result = mysqli_query($con,$sql);\n    $row = mysqli_fetch_array($sql_result);\n    $uname = $row['Handle'];\n    $rname = $row['Name'];\n    $uEmailAddr = $row['Email_Addr'];\n    $profile = $row['Profile_Text'];\n    if (empty($row['Avatar'])) {\n      $userPic = \"/gfx/default_user.png\";\n    } else {\n      $userPic = $uname . \".jpeg\";\n    }\n    if ($row['Activated'] == 1 || $activatePage == 1) {\n      $auth = 1;\n    } else {\n      header( 'Location: https://klattr.com/activate.php' );\n    }\n    \n\n\n  } else {\n    $auth = 0;\n  }\n} else {\n  $auth = 0;\n}\n", "<?php\nfunction evaluate_cookie ($e_key, $e_ip) {\n  global $con;\n  \n  /*\n    what is $e_key ? - should check it - SQL injection.  \n    -It is the key from the cookie, it is sanitized before this function call.\n  */\n  \n  $sql = \"SELECT SessionKey, UserID, IP FROM Session WHERE SessionKey='$e_key'\";\n  $sql_result = mysqli_query($con,$sql);\n  $row = mysqli_fetch_array($sql_result);\n  if ($row['IP'] == $e_ip) {\n    $result = $row['UserID'];\n  } else {\n    $result = 0;\n  } \n  return $result;\n}\n?>\n", "<?php\n\nfunction evaluate_password ($e_uname, $e_password) {\n  global $con;\n\n/*sanitize variables before sql injection*/\n\n  $e_uname = htmlspecialchars($e_uname);\n  $e_uname = addslashes($e_uname);\n  $e_password = htmlspecialchars($e_password);\n  $e_password = addslashes($e_password);\n\n  $sql = \"SELECT Handle, Email_Addr, Password_Hash FROM Users WHERE Handle='$e_uname' || Email_Addr='$e_uname'\";\n  $sql_result = mysqli_query($con,$sql);\n  $row = mysqli_fetch_array($sql_result);\n//echo $row['Handle'];\n  $enc_password = urlencode($e_password);\n  $password_hash = crypt($enc_password);\n\n    $result = $row['Handle'];\n\n  if ($e_password !== null && $e_password !== \"\") {\n    if ($row['Password_Hash'] == crypt($enc_password, $row['Password_Hash'])) {\n      //$result = 0;\n    } else {\n      $result = 1;\n    }  \n  } else {\n    $result = 1;\n  }\n  return $result;\n}\n?>\n", "<?php\n\nfunction evaluate_name ($e_name) {\n  if (preg_match(\"/^[a-zA-Z]+[a-zA-Z ]+$/\",$e_name)) {\n    $result = 0;\n  } else {\n    $result = 1;\n  }\n\n  return $result;\n}\n\n\nfunction evaluate_email ($e_email) {\n  global $con;\n  $email_regx = \"/^(([^<>()[\\]\\\\.,;:\\s@\\\"]+(\\.[^<>()[\\]\\\\.,;:\\s@\\\"]+)*)|(\\\".+\\\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\])|(([a-zA-Z\\-0-9]+\\.)+[a-zA-Z]{2,}))$/\";\n  if (preg_match($email_regx,$e_email)) {\n    $sql = \"SELECT Email_Addr FROM Users WHERE Email_Addr='$e_email'\";\n    $sql_result = mysqli_query($con,$sql);\n    $row = mysqli_fetch_array($sql_result);\n    if (strcmp($e_email,$row['Email_Addr'])==0) {\n      $result = 20;\n    } else {\n      $result = 0;\n    }\n  } else {\n    $result = 1;\n  }\n\n  return $result;\n}\n\nfunction evaluate_pass ($e_pass) {\n  if (strlen($e_pass) > 6) {\n    $result = 0;\n  } else {\n    $result = 1;\n  }\n\n  return $result;\n}\n\nfunction evaluate_uname ($e_uname) {\n\n// sanitize before injection\n  $e_uname = htmlspecialchars($e_uname);\n  $e_uname = addslashes($e_uname);\n\n  global $con;\n  if (preg_match(\"/^[a-zA-Z0-9_]+$/\",$e_uname)) {\n    $sql = \"SELECT Handle FROM Users WHERE Handle='$e_uname'\";\n    $sql_result = mysqli_query($con,$sql);\n    $row = mysqli_fetch_array($sql_result);\n    if (strcmp($e_uname,$row['Handle'])==0) {\n      $result = 2;\n   } else {\n      $result = 0;\n   }\n  } else {\n    $result = 1;\n  }\n\n  return $result;\n}\n\n?>\n"], "filenames": ["ToCheck.txt", "www/ht_docs/do_profile_text_edit.php", "www/ht_docs/do_signup.php", "www/includes/auth", "www/includes/evaluate_cookie", "www/includes/evaluate_password", "www/includes/evaluate_signup"], "buggy_code_start_loc": [1, 2, 77, 9, 6, 4, 43], "buggy_code_end_loc": [6, 28, 81, 9, 6, 4, 43], "fixing_code_start_loc": [0, 2, 78, 10, 7, 5, 44], "fixing_code_end_loc": [0, 24, 84, 14, 8, 13, 49], "type": "CWE-89", "message": "A vulnerability classified as critical has been found in CherishSin klattr. This affects an unknown part. The manipulation leads to sql injection. The name of the patch is f8e4ecfbb83aef577011b0b4aebe96fb6ec557f1. It is recommended to apply a patch to fix this issue. The associated identifier of this vulnerability is VDB-217719.", "other": {"cve": {"id": "CVE-2014-125072", "sourceIdentifier": "cna@vuldb.com", "published": "2023-01-09T22:15:09.873", "lastModified": "2023-01-13T06:48:47.090", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "A vulnerability classified as critical has been found in CherishSin klattr. This affects an unknown part. The manipulation leads to sql injection. The name of the patch is f8e4ecfbb83aef577011b0b4aebe96fb6ec557f1. It is recommended to apply a patch to fix this issue. The associated identifier of this vulnerability is VDB-217719."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H", "attackVector": "LOCAL", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 7.8, "baseSeverity": "HIGH"}, "exploitabilityScore": 1.8, "impactScore": 5.9}], "cvssMetricV30": [{"source": "cna@vuldb.com", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:A/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L", "attackVector": "ADJACENT_NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "LOW", "baseScore": 5.5, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.1, "impactScore": 3.4}], "cvssMetricV2": [{"source": "cna@vuldb.com", "type": "Secondary", "cvssData": {"version": "2.0", "vectorString": "AV:A/AC:L/Au:S/C:P/I:P/A:P", "accessVector": "ADJACENT_NETWORK", "accessComplexity": "LOW", "authentication": "SINGLE", "confidentialityImpact": "PARTIAL", "integrityImpact": "PARTIAL", "availabilityImpact": "PARTIAL", "baseScore": 5.2}, "baseSeverity": "MEDIUM", "exploitabilityScore": 5.1, "impactScore": 6.4, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "cna@vuldb.com", "type": "Primary", "description": [{"lang": "en", "value": "CWE-89"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:klattr_project:klattr:*:*:*:*:*:*:*:*", "versionEndExcluding": "2014-09-04", "matchCriteriaId": "B57BD7CD-F568-4B20-B42D-3C9231A598B6"}]}]}], "references": [{"url": "https://github.com/CherishSin/klattr/commit/f8e4ecfbb83aef577011b0b4aebe96fb6ec557f1", "source": "cna@vuldb.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://vuldb.com/?ctiid.217719", "source": "cna@vuldb.com", "tags": ["Third Party Advisory"]}, {"url": "https://vuldb.com/?id.217719", "source": "cna@vuldb.com", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/CherishSin/klattr/commit/f8e4ecfbb83aef577011b0b4aebe96fb6ec557f1"}}