{"buggy_code": ["<?php\n\n/**\n *\n * Multi Site Administration script.\n *\n * @package OpenEMR\n * @link    https://www.open-emr.org\n * @author Rod Roark <rod@sunsetsystems.com>\n * @author Ranganath Pathak <pathak@scrs1.org>\n * @copyright Copyright (C) 2010 Rod Roark <rod@sunsetsystems.com>\n * @copyright Copyright (c) 2019 Ranganath Pathak <pathak@scrs1.org>\n * @license https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\n// Checks if the server's PHP version is compatible with OpenEMR:\nrequire_once(dirname(__FILE__) . \"/src/Common/Compatibility/Checker.php\");\n$response = OpenEMR\\Common\\Compatibility\\Checker::checkPhpVersion();\nif ($response !== true) {\n    die(htmlspecialchars($response));\n}\n\nrequire_once \"version.php\";\n\n$webserver_root = dirname(__FILE__);\nif (stripos(PHP_OS, 'WIN') === 0) {\n    $webserver_root = str_replace(\"\\\\\", \"/\", $webserver_root);\n}\n\n$OE_SITES_BASE = \"$webserver_root/sites\";\n\nfunction sqlQuery($statement, $link)\n{\n    $row = mysqli_fetch_array(mysqli_query($link, $statement), MYSQLI_ASSOC);\n    return $row;\n}\n?>\n<html>\n<head>\n    <title>OpenEMR Site Administration</title>\n    <link rel=\"stylesheet\" href=\"public/assets/bootstrap/dist/css/bootstrap.min.css\">\n    <script src=\"public/assets/jquery/dist/jquery.min.js\"></script>\n    <script src=\"public/assets/bootstrap/dist/js/bootstrap.bundle.min.js\"></script>\n    <link rel=\"stylesheet\" href=\"public/assets/@fortawesome/fontawesome-free/css/all.min.css\">\n    <link rel=\"shortcut icon\" href=\"public/images/favicon.ico\" />\n</head>\n<body>\n    <div class='container mt-3'>\n        <div class=\"row\">\n            <div class=\"col-12\">\n                <div class=\"d-flex justify-content-between align-items-center\">\n                    <h2>OpenEMR Multi Site Administration</h2>\n                    <a class=\"text-secondary\" data-target=\"#myModal\" data-toggle=\"modal\" href=\"#\" id=\"help-href\" name=\"help-href\">\n                        <i class=\"fa fa-question-circle fa-lg\" aria-hidden=\"true\" data-toggle=\"tooltip\" data-placement=\"top\" title=\"Click to view Help\"></i>\n                    </a>\n                </div>\n            </div>\n        </div>\n\n        <div class=\"row\">\n            <div class=\"col-sm-12\">\n                <div class=\"table-responsive\">\n                    <table class='table table-striped text-center'>\n                        <tr>\n                            <th>Site ID</th>\n                            <th>DB Name</th>\n                            <th>Site Name</th>\n                            <th>Version</th>\n                            <th>Is Current</th>\n                            <th>Log In</th>\n                            <th>Patient Portal</th>\n                        </tr>\n                        <?php\n                        $dh = opendir($OE_SITES_BASE);\n                        if (!$dh) {\n                            die(\"Cannot read directory '$OE_SITES_BASE'.\");\n                        }\n\n                        $siteslist = array();\n\n                        while (false !== ($sfname = readdir($dh))) {\n                            if (substr($sfname, 0, 1) == '.') {\n                                continue;\n                            }\n\n                            if ($sfname == 'CVS') {\n                                continue;\n                            }\n\n                            $sitedir = \"$OE_SITES_BASE/$sfname\";\n                            if (!is_dir($sitedir)) {\n                                continue;\n                            }\n\n                            if (!is_file(\"$sitedir/sqlconf.php\")) {\n                                continue;\n                            }\n\n                            $siteslist[$sfname] = $sfname;\n                        }\n\n                        closedir($dh);\n                        ksort($siteslist);\n\n                        $encount = 0;\n                        foreach ($siteslist as $sfname) {\n                            $sitedir = \"$OE_SITES_BASE/$sfname\";\n                            $errmsg = '';\n                            ++$encount;\n\n                            echo \" <tr>\\n\";\n\n                        // Access the site's database.\n                            include \"$sitedir/sqlconf.php\";\n\n                            if ($config) {\n                                $dbh = mysqli_connect(\"$host\", \"$login\", \"$pass\", $dbase, $port);\n                                if (!$dbh) {\n                                    $errmsg = \"MySQL connect failed\";\n                                }\n                            }\n\n                            echo \"  <td>$sfname</td>\\n\";\n                            echo \"  <td>$dbase</td>\\n\";\n\n                            if (!$config) {\n                                echo \"  <td colspan='3'><a href='setup.php?site=$sfname' class='text-decoration-none'>Needs setup, click here to run it</a></td>\\n\";\n                            } elseif ($errmsg) {\n                                echo \"  <td colspan='3' class='text-danger'>$errmsg</td>\\n\";\n                            } else {\n                                // Get site name for display.\n                                $row = sqlQuery(\"SELECT gl_value FROM globals WHERE gl_name = 'openemr_name' LIMIT 1\", $dbh);\n                                $openemr_name = $row ? $row['gl_value'] : '';\n\n                                // Get version indicators from the database.\n                                $row = sqlQuery(\"SHOW TABLES LIKE 'version'\", $dbh);\n                                if (empty($row)) {\n                                    $openemr_version = 'Unknown';\n                                    $database_version = 0;\n                                } else {\n                                    $row = sqlQuery(\"SELECT * FROM version LIMIT 1\", $dbh);\n                                    $database_patch_txt = \"\";\n                                    if (!(empty($row['v_realpatch'])) && $row['v_realpatch'] != 0) {\n                                        $database_patch_txt = \" (\" . $row['v_realpatch'] . \")\";\n                                    }\n\n                                    $openemr_version = $row['v_major'] . \".\" . $row['v_minor'] . \".\" .\n                                    $row['v_patch'] . $row['v_tag'] . $database_patch_txt;\n                                    $database_version = 0 + $row['v_database'];\n                                    $database_acl = 0 + $row['v_acl'];\n                                    $database_patch = 0 + $row['v_realpatch'];\n                                }\n\n                                // Display relevant columns.\n                                echo \"  <td>$openemr_name</td>\\n\";\n                                echo \"  <td>$openemr_version</td>\\n\";\n                                if ($v_database != $database_version) {\n                                    echo \"  <td><a href='sql_upgrade.php?site=$sfname' class='text-decoration-none'>Upgrade Database</a></td>\\n\";\n                                } elseif (($v_acl > $database_acl)) {\n                                    echo \"  <td><a href='acl_upgrade.php?site=$sfname' class='text-decoration-none'>Upgrade Access Controls</a></td>\\n\";\n                                } elseif (($v_realpatch != $database_patch)) {\n                                    echo \"  <td><a href='sql_patch.php?site=$sfname' class='text-decoration-none'>Patch Database</a></td>\\n\";\n                                } else {\n                                    echo \"  <td><i class='fa fa-check fa-lg text-success' aria-hidden='true' ></i></a></td>\\n\";\n                                }\n                                if (($v_database == $database_version) && ($v_acl <= $database_acl) && ($v_realpatch == $database_patch)) {\n                                    echo \"  <td><a href='interface/login/login.php?site=$sfname' class='text-decoration-none'><i class='fa fa-sign-in-alt fa-lg' aria-hidden='true' data-toggle='tooltip' data-placement='top' title ='Login to site $sfname'></i></a></td>\\n\";\n                                    echo \"  <td><a href='portal/index.php?site=$sfname' class='text-decoration-none'><i class='fa fa-sign-in-alt fa-lg' aria-hidden='true' data-toggle='tooltip' data-placement='top' title ='Login to site $sfname'></i></a></td>\\n\";\n                                } else {\n                                    echo \"  <td><i class='fa fa-ban fa-lg text-secondary' aria-hidden='true'></i></td>\\n\";\n                                    echo \"  <td><i class='fa fa-ban fa-lg text-secondary' aria-hidden='true'></i></td>\\n\";\n                                }\n                            }\n\n                            echo \" </tr>\\n\";\n\n                            if ($config && $dbh !== false) {\n                                mysqli_close($dbh);\n                            }\n                        }\n                        ?>\n                    </table>\n                </div>\n                <form method='post' action='setup.php'>\n                    <button type='submit' class='btn btn-primary font-weight-bold' name='form_submit' value='Add New Site'>Add New Site</button>\n                </form>\n            </div>\n        </div>\n    </div><!--end of container div-->\n\n    <div class=\"row\">\n        <div class=\"modal fade\" id=\"myModal\" tabindex=\"-1\" role=\"dialog\" aria-labelledby=\"myModalLabel\" aria-hidden=\"true\">\n            <div class=\"modal-dialog modal-lg\">\n                <div class=\"modal-content\" style=\"height:700px\">\n                    <div class=\"modal-header clearfix\">\n                        <button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-label=\"Close\">\n                            <span aria-hidden=\"true\" style=\"color:var(--black); font-size:1.5em;\">\u00d7</span>\n                        </button>\n                    </div>\n                        <div class=\"modal-body\" style=\"height:80%;\">\n                            <iframe src=\"\" id=\"targetiframe\" class=\"h-100 w-100\" style=\"overflow-x: hidden; border:none\"\n                                allowtransparency=\"true\"></iframe>\n                        </div>\n                    <div class=\"modal-footer mt-0\">\n                        <button class=\"btn btn-secondary\" data-dismiss=\"modal\" type=\"button\">Close</button>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n    <script>\n        $(function () {\n            $('#help-href').click (function() {\n                document.getElementById('targetiframe').src = \"Documentation/help_files/openemr_multisite_admin_help.php\";\n            });\n        });\n        $(function () {\n            $('#print-help-href').click (function(){\n                $(\"#targetiframe\").get(0).contentWindow.print();\n            });\n        });\n        $(function () {\n            $('[data-toggle=\"tooltip\"]').tooltip();\n        });\n        // Jquery draggable\n        $(\".modal-dialog\").addClass('drag-action');\n        $(\".modal-content\").addClass('resize-action');\n    </script>\n</body>\n</html>\n"], "fixing_code": ["<?php\n\n/**\n *\n * Multi Site Administration script.\n *\n * @package OpenEMR\n * @link    https://www.open-emr.org\n * @author Rod Roark <rod@sunsetsystems.com>\n * @author Ranganath Pathak <pathak@scrs1.org>\n * @copyright Copyright (C) 2010 Rod Roark <rod@sunsetsystems.com>\n * @copyright Copyright (c) 2019 Ranganath Pathak <pathak@scrs1.org>\n * @license https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\n// Checks if the server's PHP version is compatible with OpenEMR:\nrequire_once(dirname(__FILE__) . \"/src/Common/Compatibility/Checker.php\");\n$response = OpenEMR\\Common\\Compatibility\\Checker::checkPhpVersion();\nif ($response !== true) {\n    die(htmlspecialchars($response));\n}\n\nrequire_once \"version.php\";\n\n$webserver_root = dirname(__FILE__);\nif (stripos(PHP_OS, 'WIN') === 0) {\n    $webserver_root = str_replace(\"\\\\\", \"/\", $webserver_root);\n}\n\n$OE_SITES_BASE = \"$webserver_root/sites\";\n\nfunction sqlQuery($statement, $link)\n{\n    $row = mysqli_fetch_array(mysqli_query($link, $statement), MYSQLI_ASSOC);\n    return $row;\n}\n?>\n<html>\n<head>\n    <title>OpenEMR Site Administration</title>\n    <link rel=\"stylesheet\" href=\"public/assets/bootstrap/dist/css/bootstrap.min.css\">\n    <script src=\"public/assets/jquery/dist/jquery.min.js\"></script>\n    <script src=\"public/assets/bootstrap/dist/js/bootstrap.bundle.min.js\"></script>\n    <link rel=\"stylesheet\" href=\"public/assets/@fortawesome/fontawesome-free/css/all.min.css\">\n    <link rel=\"shortcut icon\" href=\"public/images/favicon.ico\" />\n</head>\n<body>\n    <div class='container mt-3'>\n        <div class=\"row\">\n            <div class=\"col-12\">\n                <div class=\"d-flex justify-content-between align-items-center\">\n                    <h2>OpenEMR Multi Site Administration</h2>\n                    <a class=\"text-secondary\" data-target=\"#myModal\" data-toggle=\"modal\" href=\"#\" id=\"help-href\" name=\"help-href\">\n                        <i class=\"fa fa-question-circle fa-lg\" aria-hidden=\"true\" data-toggle=\"tooltip\" data-placement=\"top\" title=\"Click to view Help\"></i>\n                    </a>\n                </div>\n            </div>\n        </div>\n\n        <div class=\"row\">\n            <div class=\"col-sm-12\">\n                <div class=\"table-responsive\">\n                    <table class='table table-striped text-center'>\n                        <tr>\n                            <th>Site ID</th>\n                            <th>DB Name</th>\n                            <th>Site Name</th>\n                            <th>Version</th>\n                            <th>Is Current</th>\n                            <th>Log In</th>\n                            <th>Patient Portal</th>\n                        </tr>\n                        <?php\n                        $dh = opendir($OE_SITES_BASE);\n                        if (!$dh) {\n                            die(\"Cannot read directory '$OE_SITES_BASE'.\");\n                        }\n\n                        $siteslist = array();\n\n                        while (false !== ($sfname = readdir($dh))) {\n                            if (substr($sfname, 0, 1) == '.') {\n                                continue;\n                            }\n\n                            if ($sfname == 'CVS') {\n                                continue;\n                            }\n\n                            $sitedir = \"$OE_SITES_BASE/$sfname\";\n                            if (!is_dir($sitedir)) {\n                                continue;\n                            }\n\n                            if (!is_file(\"$sitedir/sqlconf.php\")) {\n                                continue;\n                            }\n\n                            $siteslist[$sfname] = $sfname;\n                        }\n\n                        closedir($dh);\n                        ksort($siteslist);\n\n                        $encount = 0;\n                        foreach ($siteslist as $sfname) {\n                            $sitedir = \"$OE_SITES_BASE/$sfname\";\n                            $errmsg = '';\n                            ++$encount;\n\n                            echo \" <tr>\\n\";\n\n                        // Access the site's database.\n                            include \"$sitedir/sqlconf.php\";\n\n                            if ($config) {\n                                $dbh = mysqli_connect(\"$host\", \"$login\", \"$pass\", $dbase, $port);\n                                if (!$dbh) {\n                                    $errmsg = \"MySQL connect failed\";\n                                }\n                            }\n\n                            echo \"  <td>\" . htmlspecialchars($sfname, ENT_NOQUOTES) . \"</td>\\n\";\n                            echo \"  <td>\" . htmlspecialchars($dbase, ENT_NOQUOTES) . \"</td>\\n\";\n\n                            if (!$config) {\n                                echo \"  <td colspan='3'><a href='setup.php?site=\" . htmlspecialchars(urlencode($sfname), ENT_QUOTES) . \"' class='text-decoration-none'>Needs setup, click here to run it</a></td>\\n\";\n                            } elseif ($errmsg) {\n                                echo \"  <td colspan='3' class='text-danger'>\" . htmlspecialchars($errmsg, ENT_NOQUOTES) . \"</td>\\n\";\n                            } else {\n                                // Get site name for display.\n                                $row = sqlQuery(\"SELECT gl_value FROM globals WHERE gl_name = 'openemr_name' LIMIT 1\", $dbh);\n                                $openemr_name = $row ? $row['gl_value'] : '';\n\n                                // Get version indicators from the database.\n                                $row = sqlQuery(\"SHOW TABLES LIKE 'version'\", $dbh);\n                                if (empty($row)) {\n                                    $openemr_version = 'Unknown';\n                                    $database_version = 0;\n                                } else {\n                                    $row = sqlQuery(\"SELECT * FROM version LIMIT 1\", $dbh);\n                                    $database_patch_txt = \"\";\n                                    if (!(empty($row['v_realpatch'])) && $row['v_realpatch'] != 0) {\n                                        $database_patch_txt = \" (\" . $row['v_realpatch'] . \")\";\n                                    }\n\n                                    $openemr_version = $row['v_major'] . \".\" . $row['v_minor'] . \".\" .\n                                    $row['v_patch'] . $row['v_tag'] . $database_patch_txt;\n                                    $database_version = 0 + $row['v_database'];\n                                    $database_acl = 0 + $row['v_acl'];\n                                    $database_patch = 0 + $row['v_realpatch'];\n                                }\n\n                                // Display relevant columns.\n                                echo \"  <td>\" . htmlspecialchars($openemr_name, ENT_NOQUOTES) . \"</td>\\n\";\n                                echo \"  <td>\" . htmlspecialchars($openemr_version, ENT_NOQUOTES) . \"</td>\\n\";\n                                if ($v_database != $database_version) {\n                                    echo \"  <td><a href='sql_upgrade.php?site=\" . htmlspecialchars(urlencode($sfname), ENT_QUOTES) . \"' class='text-decoration-none'>Upgrade Database</a></td>\\n\";\n                                } elseif (($v_acl > $database_acl)) {\n                                    echo \"  <td><a href='acl_upgrade.php?site=\" . htmlspecialchars(urlencode($sfname), ENT_QUOTES) . \"' class='text-decoration-none'>Upgrade Access Controls</a></td>\\n\";\n                                } elseif (($v_realpatch != $database_patch)) {\n                                    echo \"  <td><a href='sql_patch.php?site=\" . htmlspecialchars(urlencode($sfname), ENT_QUOTES) . \"' class='text-decoration-none'>Patch Database</a></td>\\n\";\n                                } else {\n                                    echo \"  <td><i class='fa fa-check fa-lg text-success' aria-hidden='true' ></i></a></td>\\n\";\n                                }\n                                if (($v_database == $database_version) && ($v_acl <= $database_acl) && ($v_realpatch == $database_patch)) {\n                                    echo \"  <td><a href='interface/login/login.php?site=\" . htmlspecialchars(urlencode($sfname), ENT_QUOTES) . \"' class='text-decoration-none'><i class='fa fa-sign-in-alt fa-lg' aria-hidden='true' data-toggle='tooltip' data-placement='top' title ='Login to site \" . htmlspecialchars($sfname, ENT_QUOTES) . \"'></i></a></td>\\n\";\n                                    echo \"  <td><a href='portal/index.php?site=\" . htmlspecialchars(urlencode($sfname), ENT_QUOTES) . \"' class='text-decoration-none'><i class='fa fa-sign-in-alt fa-lg' aria-hidden='true' data-toggle='tooltip' data-placement='top' title ='Login to site \" . htmlspecialchars($sfname, ENT_QUOTES) . \"'></i></a></td>\\n\";\n                                } else {\n                                    echo \"  <td><i class='fa fa-ban fa-lg text-secondary' aria-hidden='true'></i></td>\\n\";\n                                    echo \"  <td><i class='fa fa-ban fa-lg text-secondary' aria-hidden='true'></i></td>\\n\";\n                                }\n                            }\n\n                            echo \" </tr>\\n\";\n\n                            if ($config && $dbh !== false) {\n                                mysqli_close($dbh);\n                            }\n                        }\n                        ?>\n                    </table>\n                </div>\n                <form method='post' action='setup.php'>\n                    <button type='submit' class='btn btn-primary font-weight-bold' name='form_submit' value='Add New Site'>Add New Site</button>\n                </form>\n            </div>\n        </div>\n    </div><!--end of container div-->\n\n    <div class=\"row\">\n        <div class=\"modal fade\" id=\"myModal\" tabindex=\"-1\" role=\"dialog\" aria-labelledby=\"myModalLabel\" aria-hidden=\"true\">\n            <div class=\"modal-dialog modal-lg\">\n                <div class=\"modal-content\" style=\"height:700px\">\n                    <div class=\"modal-header clearfix\">\n                        <button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-label=\"Close\">\n                            <span aria-hidden=\"true\" style=\"color:var(--black); font-size:1.5em;\">\u00d7</span>\n                        </button>\n                    </div>\n                        <div class=\"modal-body\" style=\"height:80%;\">\n                            <iframe src=\"\" id=\"targetiframe\" class=\"h-100 w-100\" style=\"overflow-x: hidden; border:none\"\n                                allowtransparency=\"true\"></iframe>\n                        </div>\n                    <div class=\"modal-footer mt-0\">\n                        <button class=\"btn btn-secondary\" data-dismiss=\"modal\" type=\"button\">Close</button>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n    <script>\n        $(function () {\n            $('#help-href').click (function() {\n                document.getElementById('targetiframe').src = \"Documentation/help_files/openemr_multisite_admin_help.php\";\n            });\n        });\n        $(function () {\n            $('#print-help-href').click (function(){\n                $(\"#targetiframe\").get(0).contentWindow.print();\n            });\n        });\n        $(function () {\n            $('[data-toggle=\"tooltip\"]').tooltip();\n        });\n        // Jquery draggable\n        $(\".modal-dialog\").addClass('drag-action');\n        $(\".modal-content\").addClass('resize-action');\n    </script>\n</body>\n</html>\n"], "filenames": ["admin.php"], "buggy_code_start_loc": [123], "buggy_code_end_loc": [169], "fixing_code_start_loc": [123], "fixing_code_end_loc": [169], "type": "CWE-79", "message": "Cross-site Scripting (XSS) - Stored in GitHub repository openemr/openemr prior to 7.0.1.", "other": {"cve": {"id": "CVE-2023-2947", "sourceIdentifier": "security@huntr.dev", "published": "2023-05-27T23:15:09.283", "lastModified": "2023-06-01T03:47:19.823", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Cross-site Scripting (XSS) - Stored in GitHub repository openemr/openemr prior to 7.0.1."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:H/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "HIGH", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 4.8, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 1.7, "impactScore": 2.7}], "cvssMetricV30": [{"source": "security@huntr.dev", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:H/UI:N/S:U/C:L/I:L/A:L", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "HIGH", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "LOW", "baseScore": 4.7, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 1.2, "impactScore": 3.4}]}, "weaknesses": [{"source": "security@huntr.dev", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:open-emr:openemr:*:*:*:*:*:*:*:*", "versionEndExcluding": "7.0.1", "matchCriteriaId": "30B2EE3F-FA55-46FB-BC32-B041753826A4"}]}]}], "references": [{"url": "https://github.com/openemr/openemr/commit/8d2d601ac40aca75bcd2c3cf193f59c8e56d8425", "source": "security@huntr.dev", "tags": ["Patch"]}, {"url": "https://huntr.dev/bounties/52534def-acab-4200-a79a-89ef4ce6a0b0", "source": "security@huntr.dev", "tags": ["Exploit", "Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/openemr/openemr/commit/8d2d601ac40aca75bcd2c3cf193f59c8e56d8425"}}