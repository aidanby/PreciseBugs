{"buggy_code": ["<?php\n\n/*\n\tPhoronix Test Suite\n\tURLs: http://www.phoronix.com, http://www.phoronix-test-suite.com/\n\tCopyright (C) 2013 - 2022, Phoronix Media\n\tCopyright (C) 2013 - 2022, Michael Larabel\n\n\tThis program is free software; you can redistribute it and/or modify\n\tit under the terms of the GNU General Public License as published by\n\tthe Free Software Foundation; either version 3 of the License, or\n\t(at your option) any later version.\n\n\tThis program is distributed in the hope that it will be useful,\n\tbut WITHOUT ANY WARRANTY; without even the implied warranty of\n\tMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n\tGNU General Public License for more details.\n\n\tYou should have received a copy of the GNU General Public License\n\talong with this program. If not, see <http://www.gnu.org/licenses/>.\n*/\n\ndefine('PHOROMATIC_SERVER_WEB_INTERFACE', true);\ndefine('PAGE_LOAD_START_TIME', microtime(true));\n\nfunction phoromatic_quit_if_invalid_input_found($input_keys = null)\n{\n\tif(empty($input_keys))\n\t{\n\t\t// Check them all if not being selective about what keys to check\n\t\t$input_keys = array_keys($_REQUEST);\n\t}\n\t// backup as to sanitization and stripping elsewhere, safeguard namely check for things like < for fields that shouldn't have it\n\t// plus a few simple backups as safeguards for words that really have no legit relevance within Phoromatic...\n\n\tforeach(pts_strings::safety_strings_to_reject() as $invalid_string)\n\t{\n\t\tforeach($input_keys as $key)\n\t\t{\n\t\t\tif(isset($_REQUEST[$key]) && !empty($_REQUEST[$key]))\n\t\t\t{\n\t\t\t\tforeach(pts_arrays::to_array($_REQUEST[$key]) as $val_to_check)\n\t\t\t\t{\n\t\t\t\t\tif(stripos($val_to_check, $invalid_string) !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\techo '<strong>Exited due to invalid input ( ' . $invalid_string . ') attempted:</strong> ' . htmlspecialchars($val_to_check);\n\t\t\t\t\t\texit;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\nfunction phoromatic_init_web_page_setup()\n{\n\tif(session_save_path() == null || !is_writable(session_save_path()))\n\t{\n\t\t// This is needed since on at least EL6 by default there is no session_save_path set\n\t\tif(is_writable('/var/lib/php') && is_dir('/var/lib/php'))\n\t\t{\n\t\t\tsession_save_path('/var/lib/php');\n\t\t}\n\t\telse if(is_writable('/var/lib/php5') && is_dir('/var/lib/php5'))\n\t\t{\n\t\t\tsession_save_path('/var/lib/php5');\n\t\t}\n\t\telse if(is_writable('/tmp'))\n\t\t{\n\t\t\tsession_save_path('/tmp');\n\t\t}\n\t\telse if(is_writable('.'))\n\t\t{\n\t\t\tsession_save_path('.');\n\t\t}\n\t}\n\n\tdefine('PHOROMATIC_SERVER', true);\n\tif(defined('PTS_IS_DEV_BUILD') && PTS_IS_DEV_BUILD)\n\t{\n\t\terror_reporting(E_ALL);\n\t}\n\tsession_start();\n\n\tdefine('PTS_MODE', 'WEB_CLIENT');\n\tdefine('PTS_AUTO_LOAD_OBJECTS', true);\n\tdefine('PHOROMATIC_USER_IS_VIEWER', !isset($_SESSION['AdminLevel']) || $_SESSION['AdminLevel'] >= 10 || $_SESSION['AdminLevel'] < 1 ? true : false);\n\n\tinclude('../../pts-core.php');\n\tpts_core::init();\n\n\tif(isset($_SERVER['REQUEST_URI']) && !empty($_SERVER['REQUEST_URI']))\n\t{\n\t\tpts_strings::exit_if_contains_unsafe_data($_SERVER['REQUEST_URI']);\n\t}\n}\nfunction phoromatic_webui_header($left_items, $right = null)\n{\n\t$ret = PHP_EOL . '<div id=\"pts_phoromatic_top_header\">\n\t<ul>\n\t<li><a href=\"?\"><img style=\"vertical-align: middle;\" class=\"img_logo_pg\" src=\"images/phoromatic_logo.svg\" /></a>';\n\n\tif(isset($_SESSION['AdminLevel']) &&$_SESSION['AdminLevel'] > 0 && isset($_SESSION['AccountID']) && !empty($_SESSION['AccountID']))\n\t{\n\t\t$ret .= '<ul id=\"pts_phoromatic_info\">';\n\t\t$ret .= '<li><a class=\"ph_date\" href=\"#\">' . date('H:i T - j F') . '</a></li>';\n\t\t$group_name = phoromatic_server::account_id_to_group_name($_SESSION['AccountID']);\n\t\tif($group_name != null)\n\t\t{\n\t\t\t$ret .= '<li><a href=\"#\">' . $group_name . '</a></li>';\n\t\t}\n\t\t$ret .= '</ul>';\n\t}\n\t$ret .= '</li>';\n\n\t//$ret .= '<ul>';\n\tforeach($left_items as $i => $item)\n\t{\n\t\tif(is_array($item))\n\t\t{\n\t\t\t$ret .= '<li>' . $i;\n\n\t\t\tif(!empty($item))\n\t\t\t{\n\t\t\t\t$ret .= '<ul>';\n\t\t\t\tforeach($item as $sub_item)\n\t\t\t\t{\n\t\t\t\t\t$ret .= '<li>' . $sub_item . '</li>';\n\t\t\t\t}\n\t\t\t\t$ret .= '</ul>';\n\t\t\t}\n\t\t\t$ret .= '</li>' . PHP_EOL;\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$ret .= '<li>' . $item . '</li>' . PHP_EOL;\n\t\t}\n\t}\n\t$ret .= '<li><div id=\"phoromatic_result_selected_info_box\"></div> <a href=\"#\" onclick=\"javascript:phoromatic_generate_comparison(\\'?result/\\');\"><div id=\"phoromatic_result_compare_info_box\">Compare</div></a> <a href=\"#\" onclick=\"javascript:phoromatic_delete_results(\\'?results/delete/\\'); return false;\"><div id=\"phoromatic_result_delete_box\">Delete</div></a></li>';\n\t$ret .= '</ul>';\n\n\tif($right != null)\n\t{\n\t\t$ret .= '<div id=\"pts_phoromatic_top_header_right\">' . $right .'</div>';\n\t}\n\n\t$ret .=' </div>';\n\n\treturn $ret;\n}\nfunction phoromatic_get_posted_var($name, $default_value = null)\n{\n\tif(isset($_POST[$name]))\n\t{\n\t\tphoromatic_quit_if_invalid_input_found(array($name));\n\t}\n\n\treturn isset($_POST[$name]) ? $_POST[$name] : null;\n}\nfunction phoromatic_webui_main($main, $right = null)\n{\n\treturn '<div id=\"pts_phoromatic_main\">' . ($right != null ? '<div id=\"pts_phoromatic_menu_right\">' . $right . '</div>' : null) . '<div id=\"pts_phoromatic_main_area\">' . $main . '</div><div style=\"clear: both;\"></div></div>';\n}\nfunction phoromatic_webui_box(&$box)\n{\n\treturn '<div id=\"pts_phoromatic_main_box\"><div id=\"pts_phoromatic_main_box_inside\">' . $box . '</div></div>';\n}\nfunction phoromatic_results_for_schedule($schedule_id, $limit_results = false)\n{\n\tswitch($limit_results)\n\t{\n\t\tcase 'TODAY':\n\t\t\t$stmt = phoromatic_server::$db->prepare('SELECT COUNT(UploadID) As UploadCount FROM phoromatic_results WHERE AccountID = :account_id AND ScheduleID = :schedule_id AND UploadTime LIKE :today_date');\n\t\t\t$stmt->bindValue(':today_date', date('Y-m-d') . '%');\n\t\t\tbreak;\n\t\tdefault:\n\t\t\t$stmt = phoromatic_server::$db->prepare('SELECT COUNT(UploadID) As UploadCount FROM phoromatic_results WHERE AccountID = :account_id AND ScheduleID = :schedule_id');\n\t\t\tbreak;\n\t}\n\n\t$stmt->bindValue(':account_id', $_SESSION['AccountID']);\n\t$stmt->bindValue(':schedule_id', $schedule_id);\n\t$test_result_result = $stmt->execute();\n\t$row = $test_result_result->fetchArray();\n\n\treturn empty($row) ? 0 : $row['UploadCount'];\n}\nfunction phoromatic_schedule_activeon_string($active_on, $active_at = null)\n{\n\tif(!empty($active_on))\n\t{\n\t\t$active_days = explode(',', $active_on);\n\t\t$week = array('M', 'T', 'W', 'TH', 'F', 'S', 'SU');\n\t\tforeach($active_days as $i => &$day)\n\t\t{\n\t\t\tif(!isset($week[$day]))\n\t\t\t{\n\t\t\t\tunset($active_days[$i]);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$day = $week[$day];\n\t\t\t}\n\t\t}\n\t\treturn implode(' ', $active_days) . (!empty($active_at) ? ' @ ' . str_replace('.', ':', $active_at) : null );\n\t}\n}\nfunction phoromatic_webui_footer()\n{\n\treturn '<div id=\"pts_phoromatic_bottom_footer\">\n\t<div style=\"float: left; padding: 5px;\"><svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" version=\"1.1\" viewbox=\"0 0 76 41\" width=\"76\" height=\"41\" preserveAspectRatio=\"xMinYMin meet\">\n  <path d=\"m74 22v9m-5-16v16m-5-28v28m-23-2h12.5c2.485281 0 4.5-2.014719 4.5-4.5s-2.014719-4.5-4.5-4.5h-8c-2.485281 0-4.5-2.014719-4.5-4.5s2.014719-4.5 4.5-4.5h12.5m-21 5h-11m11 13h-2c-4.970563 0-9-4.029437-9-9v-20m-24 40v-20c0-4.970563 4.0294373-9 9-9 4.970563 0 9 4.029437 9 9s-4.029437 9-9 9h-9\" stroke=\"#696969\" stroke-width=\"4\" fill=\"none\" />\n</svg> &nbsp;</div>\n<p style=\"margin: 6px 15px;\"><strong>' . date('H:i T - j F Y') . '</strong>' . (PTS_IS_DEV_BUILD ? ' &nbsp; [' . round(microtime(true) - PAGE_LOAD_START_TIME, 2) . 's Page Load Time]' : null) . '<br />Copyright &copy; 2008 - ' . date('Y') . ' by <a href=\"http://www.phoronix-media.com/\">Phoronix Media</a>. All rights reserved.<br />\nAll trademarks used are properties of their respective owners.<br />' . pts_core::program_title() . ' (PHP ' . PHP_VERSION . ')</p></div> <script type=\"text/javascript\"> phoromatic_checkbox_toggle_result_comparison(\\'\\'); </script>';\n}\nfunction phoromatic_add_activity_stream_event($activity_event, $activity_event_id, $activity_event_type)\n{\n\t$stmt = phoromatic_server::$db->prepare('INSERT INTO phoromatic_activity_stream (AccountID, ActivityTime, ActivityCreator, ActivityCreatorType, ActivityEvent, ActivityEventID, ActivityEventType) VALUES (:account_id, :activity_time, :activity_creator, :activity_creator_type, :activity_event, :activity_event_id, :activity_event_type)');\n\t$stmt->bindValue(':account_id', $_SESSION['AccountID']);\n\t$stmt->bindValue(':activity_time', phoromatic_server::current_time());\n\t$stmt->bindValue(':activity_creator', $_SESSION['UserName']);\n\t$stmt->bindValue(':activity_creator_type', 'USER');\n\t$stmt->bindValue(':activity_event', $activity_event);\n\t$stmt->bindValue(':activity_event_id', $activity_event_id);\n\t$stmt->bindValue(':activity_event_type', $activity_event_type);\n\treturn $stmt->execute();\n}\nfunction phoromatic_tracker_page_relevant()\n{\n\t$stmt = phoromatic_server::$db->prepare('SELECT RunTargetSystems, RunTargetGroups, (SELECT COUNT(*) FROM phoromatic_results WHERE ScheduleID = phoromatic_schedules.ScheduleID) AS UploadedResultCount FROM phoromatic_schedules WHERE AccountID = :account_id AND State >= 1 ORDER BY Title ASC');\n\t$stmt->bindValue(':account_id', $_SESSION['AccountID']);\n\t$result = $stmt->execute();\n\t$row = $result->fetchArray();\n\n\tif($row)\n\t{\n\t\tdo\n\t\t{\n\t\t\tif(is_numeric($row['RunTargetSystems']) && $row['UploadedResultCount'] > (($row['RunTargetSystems'] + $row['RunTargetGroups'] + 1) * 7))\n\t\t\t{\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\twhile($row = $result->fetchArray());\n\t}\n\n\treturn false;\n}\nfunction phoromatic_webui_header_logged_in()\n{\n\t$html_links = array();\n\tif($_SESSION['AdminLevel'] == -40)\n\t{\n\t\t$pages = array('Admin', 'Admin_Config', 'Admin_Data', 'Logout');\n\t}\n\telse if($_SESSION['AdminLevel'] > 0)\n\t{\n\t\t$sub_main_menu = array();\n\t\t$sub_tests_menu = array();\n\t\t$sub_systems_menu = array();\n\t\t$sub_testing_menu = array();\n\t\t$sub_results_menu = array();\n\n\t\tif(phoromatic_account_system_count() > 0)\n\t\t{\n\t\t\t$sub_systems_menu[] = 'Dashboard';\n\t\t\t$sub_systems_menu[] = 'Maintenance Table';\n\t\t\t$sub_systems_menu[] = 'Component Table';\n\t\t}\n\n\t\t//$sub_main_menu[] = '<a href=\"?tests\">Test Profiles</a>';\n\t\tif(isset($_SESSION['AdminLevel']) && $_SESSION['AdminLevel'] < 4)\n\t\t{\n\t\t\t$sub_main_menu[] = 'Users';\n\t\t}\n\n\t\tarray_push($sub_main_menu, 'Settings', '<a href=\"?account_activity\">Account Activity</a>', 'Logout');\n\t\t$sub_testing_menu[] = '<a href=\"?schedules\">Test Schedules</a>';\n\n\t\tif(!PHOROMATIC_USER_IS_VIEWER)\n\t\t{\n\t\t\tif(phoromatic_server::read_setting('allow_test_profile_creation') == 1)\n\t\t\t{\n\t\t\t\tarray_push($sub_tests_menu, '<a href=\"?create_test\">Create New Test Profile</a>');\n\t\t\t}\n\t\t\tarray_push($sub_tests_menu, '<a href=\"?build_suite\">Build Test Suite</a>');\n\t\t\tarray_push($sub_testing_menu, '<a href=\"?sched\">Create A Schedule</a>', '<a href=\"?benchmark\">Run A Benchmark</a>');\n\t\t}\n\n\t\tif(phoromatic_tracker_page_relevant())\n\t\t{\n\t\t\t$sub_results_menu[] = 'Tracker';\n\t\t}\n\t\t$sub_results_menu[] = '<a href=\"/rss.php?user=' . $_SESSION['UserID'] . '&amp;v=' . sha1($_SESSION['CreatedOn']) . '\">Results Feed <img src=\"images/rss.svg\" width=\"16\" height=\"16\" /></a>';\n\n\t\t$pages = array('Main' => $sub_main_menu, 'Systems' => $sub_systems_menu, 'Tests' => $sub_tests_menu, '<a href=\"/?testing\">Testing</a>' => $sub_testing_menu, 'Results' => $sub_results_menu, '<form action=\"/?search\" method=\"post\" id=\"search\"><input type=\"search\" name=\"search\" id=\"seach_input\" size=\"16\" /> <input type=\"submit\" name=\"sa\" value=\"Search\" /><div class=\"search_expander\"></div></form>');\n\t}\n\n\tforeach($pages as $title => $page)\n\t{\n\t\tif(is_array($page) || empty($page))\n\t\t{\n\t\t\t$menu_row = array();\n\t\t\tforeach($page as $sub_page)\n\t\t\t{\n\t\t\t\t$menu_row[] = menu_item_to_html($sub_page);\n\t\t\t}\n\t\t\t$html_links[menu_item_to_html($title)] = $menu_row;\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$html_links[] = menu_item_to_html($page);\n\t\t}\n\t}\n\n\treturn phoromatic_webui_header($html_links, null);\n}\nfunction menu_item_to_html($page)\n{\n\tif(strpos($page, '</') !== false)\n\t\treturn $page;\n\n\t$page_link = strtolower($page);\n\tif(($x = strpos($page_link, '<br />')) !== false)\n\t{\n\t\t$page_link = trim(substr($page_link, $x + 6));\n\t}\n\t$page_link = str_replace(' ', '_', $page_link);\n\n\tif(strtolower($page) == PAGE_REQUEST)\n\t{\n\t\treturn '<a href=\"?' . $page_link . '\"><u>' . str_replace('_', ' ', $page) . '</u></a>';\n\t}\n\telse\n\t{\n\t\treturn '<a href=\"?' . $page_link . '\">' . str_replace('_', ' ', $page) . '</a>';\n\t}\n}\nfunction phoromatic_webui_right_panel_logged_in($add = null)\n{\n\t$right = null;\n\tif($_SESSION['AdminLevel'] == -40)\n\t{\n\t\t$right .= '<h3>Phoromatic Server</h3><hr /><p><strong>' . date('H:i T - j F Y') . '</p>';\n\t}\n\telse if($_SESSION['AdminLevel'] > 0)\n\t{\n\t\t//$right .= '<a href=\"#\" onclick=\"javascript:phoromatic_generate_comparison(\\'?result/\\');\"><div id=\"phoromatic_result_compare_info_box\"></div></a> <a href=\"#\" onclick=\"javascript:phoromatic_delete_results(\\'?results/delete/\\'); return false;\"><div id=\"phoromatic_result_delete_box\">Delete Selected Results</div></a>';\n\t\tif(($bad_systems = phoromatic_server::systems_appearing_down()) != false)\n\t\t{\n\t\t\t$right .= '<ul><li><span class=\"alert\">Systems Needing Attention</span></li>';\n\t\t\tforeach($bad_systems as $system)\n\t\t\t{\n\t\t\t\t$right .= '<li><a href=\"?systems/' . $system . '\">' . phoromatic_server::system_id_to_name($system) . '</a></li>';\n\t\t\t}\n\t\t\t$right .= '</ul><hr />';\n\t\t}\n\n\t\t$right .= $add;\n\n\t\tif($add == null)\n\t\t{\n\t\t\t$recently_active_systems = phoromatic_server::recently_active_systems($_SESSION['AccountID']);\n\t\t\tif(!empty($recently_active_systems))\n\t\t\t{\n\t\t\t\t$right .= '<ul><li>Recently Active Systems</li>';\n\n\t\t\t\tforeach($recently_active_systems as &$row)\n\t\t\t\t{\n\t\t\t\t\t$right .= '<li><a href=\"?systems/' . $row['SystemID'] . '\">' . $row['Title'] . '</a></li>';\n\t\t\t\t}\n\n\t\t\t\t$right .= '</ul><hr />';\n\t\t\t}\n\n\t\t\t$right .= '\n\t\t\t\t<ul>\n\t\t\t\t\t<li>Today\\'s Scheduled Events</li>';\n\n\t\t\t\t$stmt = phoromatic_server::$db->prepare('SELECT Title, ScheduleID, RunAt FROM phoromatic_schedules WHERE AccountID = :account_id AND State >= 1  AND ActiveOn LIKE :active_on ORDER BY RunAt,Title ASC');\n\t\t\t\t$stmt->bindValue(':account_id', $_SESSION['AccountID']);\n\t\t\t\t$stmt->bindValue(':active_on', '%' . (date('N') - 1) . '%');\n\t\t\t\t$result = $stmt->execute();\n\t\t\t\t$row = $result->fetchArray();\n\n\t\t\t\tif($row == false)\n\t\t\t\t{\n\t\t\t\t\t$right .= '</ul><p style=\"text-align: left; margin: 6px 10px;\">No Events Found</p>';\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tdo\n\t\t\t\t\t{\n\t\t\t\t\t\t$right .= '<li>' . $row['RunAt'] . ' <a href=\"?schedules/' . $row['ScheduleID'] . '\">' . $row['Title'] . '</a></li>';\n\t\t\t\t\t}\n\t\t\t\t\twhile($row = $result->fetchArray());\n\t\t\t\t\t$right .= '</ul>';\n\t\t\t\t}\n\t\t}\n\n\t\t$system_count = phoromatic_account_system_count();\n\t\t$schedule_count = phoromatic_account_schedule_count();\n\t\t$stmt = phoromatic_server::$db->prepare('SELECT COUNT(UploadID) AS ResultCount FROM phoromatic_results WHERE AccountID = :account_id');\n\t\t$stmt->bindValue(':account_id', $_SESSION['AccountID']);\n\t\t$result = $stmt->execute();\n\t\t$row = $result->fetchArray();\n\t\t$result_count = $row['ResultCount'];\n\t\t$stmt = phoromatic_server::$db->prepare('SELECT COUNT(ActivityTime) AS ActivityCount FROM phoromatic_activity_stream WHERE AccountID = :account_id AND ActivityTime LIKE :today_date');\n\t\t$stmt->bindValue(':account_id', $_SESSION['AccountID']);\n\t\t$stmt->bindValue(':today_date', date('Y-m-d') . '%');\n\t\t$result = $stmt->execute();\n\t\t$row = $result->fetchArray();\n\t\t$activity_count = $row['ActivityCount'];\n\n\t\t$group_name = phoromatic_server::account_id_to_group_name($_SESSION['AccountID']);\n\t\tif($group_name != null)\n\t\t{\n\t\t\t$group_name = '<strong>' . $group_name . '</strong><br />';\n\t\t}\n\n\t\t$right .= '<hr /><p><strong>' . date('H:i T - j F Y') . '</strong><br />' . $group_name . '<a href=\"?systems\">' . $system_count . ' System' . ($system_count == 1 ? '' : 's') . '</a><br /><a href=\"?schedules\">' . $schedule_count . ' Schedule' . ($schedule_count == 1 ? '' : 's') . '</a><br /><a href=\"?results\">' . $result_count . ' Result' . ($result_count == 1 ? '' : 's') . '</a>';\n\t\t$right .= ' <a href=\"/rss.php?user=' . $_SESSION['UserID'] . '&amp;v=' . sha1($_SESSION['CreatedOn']) . '\"><img src=\"images/rss.svg\" width=\"16\" height=\"16\" /></a>';\n\t\t$right .= '<br /><a href=\"?account_activity\">' . $activity_count . ' Activity Events Today</a></p>';\n\t}\n\n\treturn $right;\n}\nfunction phoromatic_account_schedule_count()\n{\n\tstatic $schedule_count = 0;\n\n\tif($schedule_count == 0)\n\t{\n\t\t$stmt = phoromatic_server::$db->prepare('SELECT COUNT(Title) AS ScheduleCount FROM phoromatic_schedules WHERE AccountID = :account_id AND State >= 1');\n\t\t$stmt->bindValue(':account_id', $_SESSION['AccountID']);\n\t\t$result = $stmt->execute();\n\t\t$row = $result->fetchArray();\n\t\t$schedule_count = $row['ScheduleCount'];\n\t}\n\treturn $schedule_count;\n}\nfunction phoromatic_account_system_count()\n{\n\tstatic $sys_count = 0;\n\n\tif($sys_count == 0)\n\t{\n\t\t$stmt = phoromatic_server::$db->prepare('SELECT COUNT(Title) AS SystemCount FROM phoromatic_systems WHERE AccountID = :account_id AND State >= 0');\n\t\t$stmt->bindValue(':account_id', $_SESSION['AccountID']);\n\t\t$result = $stmt->execute();\n\t\t$row = $result->fetchArray();\n\t\t$sys_count = $row['SystemCount'];\n\t}\n\treturn $sys_count;\n}\nfunction phoromatic_web_socket_server_ip()\n{\n\t$server_ip = $_SERVER['HTTP_HOST'];\n\tif(($x = strpos($server_ip, ':')) !== false)\n\t{\n\t\t$server_ip = substr($server_ip, 0, $x);\n\t}\n\n\tif($server_ip == 'localhost' || $server_ip == '0.0.0.0')\n\t{\n\t\t$local_ip = phodevi::read_property('network', 'ip');\n\t\tif($local_ip)\n\t\t{\n\t\t\t$server_ip = $local_ip;\n\t\t}\n\t}\n\t// getenv('PTS_WEBSOCKET_PORT')\n\treturn $server_ip . ':' . $_SERVER['SERVER_PORT'];\n}\nfunction phoromatic_web_socket_server_addr()\n{\n\t// getenv('PTS_WEBSOCKET_PORT')\n\treturn phoromatic_web_socket_server_ip() . '/' . $_SESSION['AccountID'];\n}\nfunction phoromatic_error_page($title, $description)\n{\n\techo phoromatic_webui_header(array(''), '');\n\t$box = '<h1>' . $title . '</h1>\n\t\t<h2>' . $description . '</h2>';\n\techo phoromatic_webui_box($box);\n\techo phoromatic_webui_footer();\n}\nfunction phoromatic_systems_needing_attention()\n{\n\t$main = null;\n\t$stmt = phoromatic_server::$db->prepare('SELECT Title, SystemID, State, LastIP, LocalIP, LastCommunication FROM phoromatic_systems WHERE AccountID = :account_id AND State = 0 ORDER BY LastCommunication DESC');\n\t$stmt->bindValue(':account_id', $_SESSION['AccountID']);\n\t$result = $stmt->execute();\n\tif($row = $result->fetchArray())\n\t{\n\t\t$main .= '<div class=\"pts_phoromatic_info_box_area\"><div style=\"float: left; width: 100%;\"><ul><li><h1>Systems Needing Attention</h1></li><li class=\"light\" style=\"font-weight: normal;\">The following systems have attempted to sync with this Phoromatic account but have not been validated. When clicking on them you are able to approve or disable them from your account along with editing the system information.</li>';\n\n\t\tdo\n\t\t{\n\t\t\t$ip = $row['LocalIP'];\n\t\t\tif($row['LastIP'] != $row['LocalIP'])\n\t\t\t{\n\t\t\t\t$ip .= ' / ' . $row['LastIP'];\n\t\t\t}\n\n\t\t\t$main .= '<a href=\"?systems/' . $row['SystemID'] . '/edit\"><li>' . $row['Title'] . '<br /><em><strong>IP:</strong> ' . $ip . ' <strong>Last Communication:</strong> ' . $row['LastCommunication'] . '</em></li></a>';\n\t\t}\n\t\twhile($row = $result->fetchArray());\n\n\t\t$main .= '</ul></div></div>';\n\t}\n\n\treturn $main;\n}\nfunction phoromatic_oldest_result_for_schedule($schedule_id)\n{\n\tstatic $old_time;\n\n\tif(!isset($old_time[$schedule_id]))\n\t{\n\t\t$stmt = phoromatic_server::$db->prepare('SELECT UploadTime FROM phoromatic_results WHERE AccountID = :account_id AND ScheduleID = :schedule_id ORDER BY UploadTime ASC LIMIT 1');\n\t\t$stmt->bindValue(':account_id', $_SESSION['AccountID']);\n\t\t$stmt->bindValue(':schedule_id', $schedule_id);\n\t\t$result = $stmt->execute();\n\t\t$row = $result->fetchArray();\n\t\t$old_time[$schedule_id] = $row['UploadTime'];\n\t}\n\n\treturn $old_time[$schedule_id];\n}\nfunction write_token_in_form()\n{\n\treturn '<input type=\"hidden\" name=\"token_submit\" value=\"' . $_SESSION['Token'] . '\" />';\n}\nfunction append_token_to_url($prefix = '/')\n{\n\treturn $prefix . '&token_submit=' . $_SESSION['Token'];\n}\nfunction verify_submission_token()\n{\n\treturn isset($_REQUEST['token_submit']) && $_REQUEST['token_submit'] == $_SESSION['Token'];\n}\nfunction create_new_phoromatic_account($register_username, $register_password, $register_password_confirm, $register_email, $seed_accountid = null)\n{\n\t// REGISTER NEW USER\n\tif(strlen($register_username) < 4 || strpos($register_username, ' ') !== false)\n\t{\n\t\tphoromatic_error_page('Oops!', 'Please go back and ensure the supplied username is at least four characters long and contains no spaces.');\n\t\treturn false;\n\t}\n\tif(in_array(strtolower($register_username), array('admin', 'administrator', 'rootadmin')))\n\t{\n\t\tphoromatic_error_page('Oops!', $register_username . ' is a reserved and common username that may be used for other purposes, please make a different selection.');\n\t\treturn false;\n\t}\n\tif(strlen($register_password) < 6)\n\t{\n\t\tphoromatic_error_page('Oops!', 'Please go back and ensure the supplied password is at least six characters long.');\n\t\treturn false;\n\t}\n\tif($register_password != $register_password_confirm)\n\t{\n\t\tphoromatic_error_page('Oops!', 'Please go back and ensure the supplied password matches the password confirmation.');\n\t\treturn false;\n\t}\n\tif($register_email == null || filter_var($register_email, FILTER_VALIDATE_EMAIL) == false)\n\t{\n\t\tphoromatic_error_page('Oops!', 'Please enter a valid email address.');\n\t\treturn false;\n\t}\n\n\t$valid_user_name_chars = '1234567890-_.abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';\n\tfor($i = 0; $i < strlen($register_username); $i++)\n\t{\n\t\tif(strpos($valid_user_name_chars, substr($register_username, $i, 1)) === false)\n\t\t{\n\t\t\tphoromatic_error_page('Oops!', 'Please go back and ensure a valid user-name. The character <em>' . substr($register_username, $i, 1) . '</em> is not allowed.');\n\t\t\treturn false;\n\t\t}\n\t}\n\n\t$matching_users = phoromatic_server::$db->querySingle('SELECT UserName FROM phoromatic_users WHERE UserName = \\'' . SQLite3::escapeString($register_username) . '\\'');\n\tif(!empty($matching_users))\n\t{\n\t\tphoromatic_error_page('Oops!', 'The user-name is already taken.');\n\t\treturn false;\n\t}\n\n\tif(phoromatic_server::read_setting('add_new_users_to_account') != null)\n\t{\n\t\t$account_id = phoromatic_server::read_setting('add_new_users_to_account');\n\t\t$is_new_account = false;\n\t}\n\telse\n\t{\n\t\t$id_tries = 0;\n\t\tdo\n\t\t{\n\t\t\tif($id_tries == 0 && $seed_accountid != null && isset($seed_accountid[5]))\n\t\t\t{\n\t\t\t\t$account_id = strtoupper(substr($seed_accountid, 0, 6));\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$account_id = pts_strings::random_characters(6, true);\n\t\t\t}\n\t\t\t$matching_accounts = phoromatic_server::$db->querySingle('SELECT AccountID FROM phoromatic_accounts WHERE AccountID = \\'' . $account_id . '\\'');\n\t\t\t$id_tries++;\n\t\t}\n\t\twhile(!empty($matching_accounts));\n\t\t$is_new_account = true;\n\t}\n\n\t$user_id = pts_strings::random_characters(4, true);\n\n\tif($is_new_account)\n\t{\n\t\tpts_logger::add_to_log($_SERVER['REMOTE_ADDR'] . ' created a new account: ' . $user_id . ' - ' . $account_id);\n\t\t$account_salt = pts_strings::random_characters(12, true);\n\t\t$stmt = phoromatic_server::$db->prepare('INSERT INTO phoromatic_accounts (AccountID, ValidateID, CreatedOn, Salt) VALUES (:account_id, :validate_id, :current_time, :salt)');\n\t\t$stmt->bindValue(':account_id', $account_id);\n\t\t$stmt->bindValue(':validate_id', pts_strings::random_characters(4, true));\n\t\t$stmt->bindValue(':salt', $account_salt);\n\t\t$stmt->bindValue(':current_time', phoromatic_server::current_time());\n\t\t$result = $stmt->execute();\n\n\t\t$stmt = phoromatic_server::$db->prepare('INSERT INTO phoromatic_account_settings (AccountID) VALUES (:account_id)');\n\t\t$stmt->bindValue(':account_id', $account_id);\n\t\t$result = $stmt->execute();\n\n\t\t$stmt = phoromatic_server::$db->prepare('INSERT INTO phoromatic_user_settings (UserID, AccountID) VALUES (:user_id, :account_id)');\n\t\t$stmt->bindValue(':user_id', $user_id);\n\t\t$stmt->bindValue(':account_id', $account_id);\n\t\t$result = $stmt->execute();\n\t}\n\telse\n\t{\n\t\tpts_logger::add_to_log($_SERVER['REMOTE_ADDR'] . ' being added to an account: ' . $user_id . ' - ' . $account_id);\n\t\t$account_salt = phoromatic_server::$db->querySingle('SELECT Salt FROM phoromatic_accounts WHERE AccountID = \\'' . $account_id . '\\'');\n\t}\n\n\t$salted_password = hash('sha256', $account_salt . $register_password);\n\t$stmt = phoromatic_server::$db->prepare('INSERT INTO phoromatic_users (UserID, AccountID, UserName, Email, Password, CreatedOn, LastIP, AdminLevel) VALUES (:user_id, :account_id, :user_name, :email, :password, :current_time, :last_ip, :admin_level)');\n\t$stmt->bindValue(':user_id', $user_id);\n\t$stmt->bindValue(':account_id', $account_id);\n\t$stmt->bindValue(':user_name', $register_username);\n\t$stmt->bindValue(':email', $register_email);\n\t$stmt->bindValue(':password', $salted_password);\n\t$stmt->bindValue(':last_ip', $_SERVER['REMOTE_ADDR']);\n\t$stmt->bindValue(':current_time', phoromatic_server::current_time());\n\t$stmt->bindValue(':admin_level', ($is_new_account ? 1 : 10));\n\t$result = $stmt->execute();\n\n\tpts_file_io::mkdir(phoromatic_server::phoromatic_account_path($account_id));\n\tphoromatic_server::send_email($register_email, 'Phoromatic Account Registration', (($e = phoromatic_server::read_setting('admin_support_email')) != null ? $e : 'no-reply@phoromatic.com'), '<p><strong>' . $register_username . '</strong>:</p><p>Your Phoromatic account has been created and is now active.</p>');\n\treturn true;\n}\n\n?>\n"], "fixing_code": ["<?php\n\n/*\n\tPhoronix Test Suite\n\tURLs: http://www.phoronix.com, http://www.phoronix-test-suite.com/\n\tCopyright (C) 2013 - 2022, Phoronix Media\n\tCopyright (C) 2013 - 2022, Michael Larabel\n\n\tThis program is free software; you can redistribute it and/or modify\n\tit under the terms of the GNU General Public License as published by\n\tthe Free Software Foundation; either version 3 of the License, or\n\t(at your option) any later version.\n\n\tThis program is distributed in the hope that it will be useful,\n\tbut WITHOUT ANY WARRANTY; without even the implied warranty of\n\tMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n\tGNU General Public License for more details.\n\n\tYou should have received a copy of the GNU General Public License\n\talong with this program. If not, see <http://www.gnu.org/licenses/>.\n*/\n\ndefine('PHOROMATIC_SERVER_WEB_INTERFACE', true);\ndefine('PAGE_LOAD_START_TIME', microtime(true));\n\nfunction phoromatic_quit_if_invalid_input_found($input_keys = null)\n{\n\tif(empty($input_keys))\n\t{\n\t\t// Check them all if not being selective about what keys to check\n\t\t$input_keys = array_keys($_REQUEST);\n\t}\n\t// backup as to sanitization and stripping elsewhere, safeguard namely check for things like < for fields that shouldn't have it\n\t// plus a few simple backups as safeguards for words that really have no legit relevance within Phoromatic...\n\n\tforeach(pts_strings::safety_strings_to_reject() as $invalid_string)\n\t{\n\t\tforeach($input_keys as $key)\n\t\t{\n\t\t\tif(isset($_GET[$key]) && !empty($_GET[$key]))\n\t\t\t{\n\t\t\t\tforeach(pts_arrays::to_array($_GET[$key]) as $val_to_check)\n\t\t\t\t{\n\t\t\t\t\tif(stripos($val_to_check, $invalid_string) !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\techo '<strong>Exited due to invalid input ( ' . $invalid_string . ') attempted:</strong> ' . htmlspecialchars($val_to_check);\n\t\t\t\t\t\texit;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif(isset($_POST[$key]) && !empty($_POST[$key]))\n\t\t\t{\n\t\t\t\tforeach(pts_arrays::to_array($_POST[$key]) as $val_to_check)\n\t\t\t\t{\n\t\t\t\t\tif(stripos($val_to_check, $invalid_string) !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\techo '<strong>Exited due to invalid input ( ' . $invalid_string . ') attempted:</strong> ' . htmlspecialchars($val_to_check);\n\t\t\t\t\t\texit;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\nfunction phoromatic_init_web_page_setup()\n{\n\tif(session_save_path() == null || !is_writable(session_save_path()))\n\t{\n\t\t// This is needed since on at least EL6 by default there is no session_save_path set\n\t\tif(is_writable('/var/lib/php') && is_dir('/var/lib/php'))\n\t\t{\n\t\t\tsession_save_path('/var/lib/php');\n\t\t}\n\t\telse if(is_writable('/var/lib/php5') && is_dir('/var/lib/php5'))\n\t\t{\n\t\t\tsession_save_path('/var/lib/php5');\n\t\t}\n\t\telse if(is_writable('/tmp'))\n\t\t{\n\t\t\tsession_save_path('/tmp');\n\t\t}\n\t\telse if(is_writable('.'))\n\t\t{\n\t\t\tsession_save_path('.');\n\t\t}\n\t}\n\n\tdefine('PHOROMATIC_SERVER', true);\n\tif(defined('PTS_IS_DEV_BUILD') && PTS_IS_DEV_BUILD)\n\t{\n\t\terror_reporting(E_ALL);\n\t}\n\tsession_start();\n\n\tdefine('PTS_MODE', 'WEB_CLIENT');\n\tdefine('PTS_AUTO_LOAD_OBJECTS', true);\n\tdefine('PHOROMATIC_USER_IS_VIEWER', !isset($_SESSION['AdminLevel']) || $_SESSION['AdminLevel'] >= 10 || $_SESSION['AdminLevel'] < 1 ? true : false);\n\n\tinclude('../../pts-core.php');\n\tpts_core::init();\n\n\tif(isset($_SERVER['REQUEST_URI']) && !empty($_SERVER['REQUEST_URI']))\n\t{\n\t\tpts_strings::exit_if_contains_unsafe_data($_SERVER['REQUEST_URI']);\n\t}\n}\nfunction phoromatic_webui_header($left_items, $right = null)\n{\n\t$ret = PHP_EOL . '<div id=\"pts_phoromatic_top_header\">\n\t<ul>\n\t<li><a href=\"?\"><img style=\"vertical-align: middle;\" class=\"img_logo_pg\" src=\"images/phoromatic_logo.svg\" /></a>';\n\n\tif(isset($_SESSION['AdminLevel']) &&$_SESSION['AdminLevel'] > 0 && isset($_SESSION['AccountID']) && !empty($_SESSION['AccountID']))\n\t{\n\t\t$ret .= '<ul id=\"pts_phoromatic_info\">';\n\t\t$ret .= '<li><a class=\"ph_date\" href=\"#\">' . date('H:i T - j F') . '</a></li>';\n\t\t$group_name = phoromatic_server::account_id_to_group_name($_SESSION['AccountID']);\n\t\tif($group_name != null)\n\t\t{\n\t\t\t$ret .= '<li><a href=\"#\">' . $group_name . '</a></li>';\n\t\t}\n\t\t$ret .= '</ul>';\n\t}\n\t$ret .= '</li>';\n\n\t//$ret .= '<ul>';\n\tforeach($left_items as $i => $item)\n\t{\n\t\tif(is_array($item))\n\t\t{\n\t\t\t$ret .= '<li>' . $i;\n\n\t\t\tif(!empty($item))\n\t\t\t{\n\t\t\t\t$ret .= '<ul>';\n\t\t\t\tforeach($item as $sub_item)\n\t\t\t\t{\n\t\t\t\t\t$ret .= '<li>' . $sub_item . '</li>';\n\t\t\t\t}\n\t\t\t\t$ret .= '</ul>';\n\t\t\t}\n\t\t\t$ret .= '</li>' . PHP_EOL;\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$ret .= '<li>' . $item . '</li>' . PHP_EOL;\n\t\t}\n\t}\n\t$ret .= '<li><div id=\"phoromatic_result_selected_info_box\"></div> <a href=\"#\" onclick=\"javascript:phoromatic_generate_comparison(\\'?result/\\');\"><div id=\"phoromatic_result_compare_info_box\">Compare</div></a> <a href=\"#\" onclick=\"javascript:phoromatic_delete_results(\\'?results/delete/\\'); return false;\"><div id=\"phoromatic_result_delete_box\">Delete</div></a></li>';\n\t$ret .= '</ul>';\n\n\tif($right != null)\n\t{\n\t\t$ret .= '<div id=\"pts_phoromatic_top_header_right\">' . $right .'</div>';\n\t}\n\n\t$ret .=' </div>';\n\n\treturn $ret;\n}\nfunction phoromatic_get_posted_var($name, $default_value = null)\n{\n\tif(isset($_POST[$name]))\n\t{\n\t\tphoromatic_quit_if_invalid_input_found(array($name));\n\t}\n\n\treturn isset($_POST[$name]) ? $_POST[$name] : null;\n}\nfunction phoromatic_webui_main($main, $right = null)\n{\n\treturn '<div id=\"pts_phoromatic_main\">' . ($right != null ? '<div id=\"pts_phoromatic_menu_right\">' . $right . '</div>' : null) . '<div id=\"pts_phoromatic_main_area\">' . $main . '</div><div style=\"clear: both;\"></div></div>';\n}\nfunction phoromatic_webui_box(&$box)\n{\n\treturn '<div id=\"pts_phoromatic_main_box\"><div id=\"pts_phoromatic_main_box_inside\">' . $box . '</div></div>';\n}\nfunction phoromatic_results_for_schedule($schedule_id, $limit_results = false)\n{\n\tswitch($limit_results)\n\t{\n\t\tcase 'TODAY':\n\t\t\t$stmt = phoromatic_server::$db->prepare('SELECT COUNT(UploadID) As UploadCount FROM phoromatic_results WHERE AccountID = :account_id AND ScheduleID = :schedule_id AND UploadTime LIKE :today_date');\n\t\t\t$stmt->bindValue(':today_date', date('Y-m-d') . '%');\n\t\t\tbreak;\n\t\tdefault:\n\t\t\t$stmt = phoromatic_server::$db->prepare('SELECT COUNT(UploadID) As UploadCount FROM phoromatic_results WHERE AccountID = :account_id AND ScheduleID = :schedule_id');\n\t\t\tbreak;\n\t}\n\n\t$stmt->bindValue(':account_id', $_SESSION['AccountID']);\n\t$stmt->bindValue(':schedule_id', $schedule_id);\n\t$test_result_result = $stmt->execute();\n\t$row = $test_result_result->fetchArray();\n\n\treturn empty($row) ? 0 : $row['UploadCount'];\n}\nfunction phoromatic_schedule_activeon_string($active_on, $active_at = null)\n{\n\tif(!empty($active_on))\n\t{\n\t\t$active_days = explode(',', $active_on);\n\t\t$week = array('M', 'T', 'W', 'TH', 'F', 'S', 'SU');\n\t\tforeach($active_days as $i => &$day)\n\t\t{\n\t\t\tif(!isset($week[$day]))\n\t\t\t{\n\t\t\t\tunset($active_days[$i]);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$day = $week[$day];\n\t\t\t}\n\t\t}\n\t\treturn implode(' ', $active_days) . (!empty($active_at) ? ' @ ' . str_replace('.', ':', $active_at) : null );\n\t}\n}\nfunction phoromatic_webui_footer()\n{\n\treturn '<div id=\"pts_phoromatic_bottom_footer\">\n\t<div style=\"float: left; padding: 5px;\"><svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" version=\"1.1\" viewbox=\"0 0 76 41\" width=\"76\" height=\"41\" preserveAspectRatio=\"xMinYMin meet\">\n  <path d=\"m74 22v9m-5-16v16m-5-28v28m-23-2h12.5c2.485281 0 4.5-2.014719 4.5-4.5s-2.014719-4.5-4.5-4.5h-8c-2.485281 0-4.5-2.014719-4.5-4.5s2.014719-4.5 4.5-4.5h12.5m-21 5h-11m11 13h-2c-4.970563 0-9-4.029437-9-9v-20m-24 40v-20c0-4.970563 4.0294373-9 9-9 4.970563 0 9 4.029437 9 9s-4.029437 9-9 9h-9\" stroke=\"#696969\" stroke-width=\"4\" fill=\"none\" />\n</svg> &nbsp;</div>\n<p style=\"margin: 6px 15px;\"><strong>' . date('H:i T - j F Y') . '</strong>' . (PTS_IS_DEV_BUILD ? ' &nbsp; [' . round(microtime(true) - PAGE_LOAD_START_TIME, 2) . 's Page Load Time]' : null) . '<br />Copyright &copy; 2008 - ' . date('Y') . ' by <a href=\"http://www.phoronix-media.com/\">Phoronix Media</a>. All rights reserved.<br />\nAll trademarks used are properties of their respective owners.<br />' . pts_core::program_title() . ' (PHP ' . PHP_VERSION . ')</p></div> <script type=\"text/javascript\"> phoromatic_checkbox_toggle_result_comparison(\\'\\'); </script>';\n}\nfunction phoromatic_add_activity_stream_event($activity_event, $activity_event_id, $activity_event_type)\n{\n\t$stmt = phoromatic_server::$db->prepare('INSERT INTO phoromatic_activity_stream (AccountID, ActivityTime, ActivityCreator, ActivityCreatorType, ActivityEvent, ActivityEventID, ActivityEventType) VALUES (:account_id, :activity_time, :activity_creator, :activity_creator_type, :activity_event, :activity_event_id, :activity_event_type)');\n\t$stmt->bindValue(':account_id', $_SESSION['AccountID']);\n\t$stmt->bindValue(':activity_time', phoromatic_server::current_time());\n\t$stmt->bindValue(':activity_creator', $_SESSION['UserName']);\n\t$stmt->bindValue(':activity_creator_type', 'USER');\n\t$stmt->bindValue(':activity_event', $activity_event);\n\t$stmt->bindValue(':activity_event_id', $activity_event_id);\n\t$stmt->bindValue(':activity_event_type', $activity_event_type);\n\treturn $stmt->execute();\n}\nfunction phoromatic_tracker_page_relevant()\n{\n\t$stmt = phoromatic_server::$db->prepare('SELECT RunTargetSystems, RunTargetGroups, (SELECT COUNT(*) FROM phoromatic_results WHERE ScheduleID = phoromatic_schedules.ScheduleID) AS UploadedResultCount FROM phoromatic_schedules WHERE AccountID = :account_id AND State >= 1 ORDER BY Title ASC');\n\t$stmt->bindValue(':account_id', $_SESSION['AccountID']);\n\t$result = $stmt->execute();\n\t$row = $result->fetchArray();\n\n\tif($row)\n\t{\n\t\tdo\n\t\t{\n\t\t\tif(is_numeric($row['RunTargetSystems']) && $row['UploadedResultCount'] > (($row['RunTargetSystems'] + $row['RunTargetGroups'] + 1) * 7))\n\t\t\t{\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\twhile($row = $result->fetchArray());\n\t}\n\n\treturn false;\n}\nfunction phoromatic_webui_header_logged_in()\n{\n\t$html_links = array();\n\tif($_SESSION['AdminLevel'] == -40)\n\t{\n\t\t$pages = array('Admin', 'Admin_Config', 'Admin_Data', 'Logout');\n\t}\n\telse if($_SESSION['AdminLevel'] > 0)\n\t{\n\t\t$sub_main_menu = array();\n\t\t$sub_tests_menu = array();\n\t\t$sub_systems_menu = array();\n\t\t$sub_testing_menu = array();\n\t\t$sub_results_menu = array();\n\n\t\tif(phoromatic_account_system_count() > 0)\n\t\t{\n\t\t\t$sub_systems_menu[] = 'Dashboard';\n\t\t\t$sub_systems_menu[] = 'Maintenance Table';\n\t\t\t$sub_systems_menu[] = 'Component Table';\n\t\t}\n\n\t\t//$sub_main_menu[] = '<a href=\"?tests\">Test Profiles</a>';\n\t\tif(isset($_SESSION['AdminLevel']) && $_SESSION['AdminLevel'] < 4)\n\t\t{\n\t\t\t$sub_main_menu[] = 'Users';\n\t\t}\n\n\t\tarray_push($sub_main_menu, 'Settings', '<a href=\"?account_activity\">Account Activity</a>', 'Logout');\n\t\t$sub_testing_menu[] = '<a href=\"?schedules\">Test Schedules</a>';\n\n\t\tif(!PHOROMATIC_USER_IS_VIEWER)\n\t\t{\n\t\t\tif(phoromatic_server::read_setting('allow_test_profile_creation') == 1)\n\t\t\t{\n\t\t\t\tarray_push($sub_tests_menu, '<a href=\"?create_test\">Create New Test Profile</a>');\n\t\t\t}\n\t\t\tarray_push($sub_tests_menu, '<a href=\"?build_suite\">Build Test Suite</a>');\n\t\t\tarray_push($sub_testing_menu, '<a href=\"?sched\">Create A Schedule</a>', '<a href=\"?benchmark\">Run A Benchmark</a>');\n\t\t}\n\n\t\tif(phoromatic_tracker_page_relevant())\n\t\t{\n\t\t\t$sub_results_menu[] = 'Tracker';\n\t\t}\n\t\t$sub_results_menu[] = '<a href=\"/rss.php?user=' . $_SESSION['UserID'] . '&amp;v=' . sha1($_SESSION['CreatedOn']) . '\">Results Feed <img src=\"images/rss.svg\" width=\"16\" height=\"16\" /></a>';\n\n\t\t$pages = array('Main' => $sub_main_menu, 'Systems' => $sub_systems_menu, 'Tests' => $sub_tests_menu, '<a href=\"/?testing\">Testing</a>' => $sub_testing_menu, 'Results' => $sub_results_menu, '<form action=\"/?search\" method=\"post\" id=\"search\"><input type=\"search\" name=\"search\" id=\"seach_input\" size=\"16\" /> <input type=\"submit\" name=\"sa\" value=\"Search\" /><div class=\"search_expander\"></div></form>');\n\t}\n\n\tforeach($pages as $title => $page)\n\t{\n\t\tif(is_array($page) || empty($page))\n\t\t{\n\t\t\t$menu_row = array();\n\t\t\tforeach($page as $sub_page)\n\t\t\t{\n\t\t\t\t$menu_row[] = menu_item_to_html($sub_page);\n\t\t\t}\n\t\t\t$html_links[menu_item_to_html($title)] = $menu_row;\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$html_links[] = menu_item_to_html($page);\n\t\t}\n\t}\n\n\treturn phoromatic_webui_header($html_links, null);\n}\nfunction menu_item_to_html($page)\n{\n\tif(strpos($page, '</') !== false)\n\t\treturn $page;\n\n\t$page_link = strtolower($page);\n\tif(($x = strpos($page_link, '<br />')) !== false)\n\t{\n\t\t$page_link = trim(substr($page_link, $x + 6));\n\t}\n\t$page_link = str_replace(' ', '_', $page_link);\n\n\tif(strtolower($page) == PAGE_REQUEST)\n\t{\n\t\treturn '<a href=\"?' . $page_link . '\"><u>' . str_replace('_', ' ', $page) . '</u></a>';\n\t}\n\telse\n\t{\n\t\treturn '<a href=\"?' . $page_link . '\">' . str_replace('_', ' ', $page) . '</a>';\n\t}\n}\nfunction phoromatic_webui_right_panel_logged_in($add = null)\n{\n\t$right = null;\n\tif($_SESSION['AdminLevel'] == -40)\n\t{\n\t\t$right .= '<h3>Phoromatic Server</h3><hr /><p><strong>' . date('H:i T - j F Y') . '</p>';\n\t}\n\telse if($_SESSION['AdminLevel'] > 0)\n\t{\n\t\t//$right .= '<a href=\"#\" onclick=\"javascript:phoromatic_generate_comparison(\\'?result/\\');\"><div id=\"phoromatic_result_compare_info_box\"></div></a> <a href=\"#\" onclick=\"javascript:phoromatic_delete_results(\\'?results/delete/\\'); return false;\"><div id=\"phoromatic_result_delete_box\">Delete Selected Results</div></a>';\n\t\tif(($bad_systems = phoromatic_server::systems_appearing_down()) != false)\n\t\t{\n\t\t\t$right .= '<ul><li><span class=\"alert\">Systems Needing Attention</span></li>';\n\t\t\tforeach($bad_systems as $system)\n\t\t\t{\n\t\t\t\t$right .= '<li><a href=\"?systems/' . $system . '\">' . phoromatic_server::system_id_to_name($system) . '</a></li>';\n\t\t\t}\n\t\t\t$right .= '</ul><hr />';\n\t\t}\n\n\t\t$right .= $add;\n\n\t\tif($add == null)\n\t\t{\n\t\t\t$recently_active_systems = phoromatic_server::recently_active_systems($_SESSION['AccountID']);\n\t\t\tif(!empty($recently_active_systems))\n\t\t\t{\n\t\t\t\t$right .= '<ul><li>Recently Active Systems</li>';\n\n\t\t\t\tforeach($recently_active_systems as &$row)\n\t\t\t\t{\n\t\t\t\t\t$right .= '<li><a href=\"?systems/' . $row['SystemID'] . '\">' . $row['Title'] . '</a></li>';\n\t\t\t\t}\n\n\t\t\t\t$right .= '</ul><hr />';\n\t\t\t}\n\n\t\t\t$right .= '\n\t\t\t\t<ul>\n\t\t\t\t\t<li>Today\\'s Scheduled Events</li>';\n\n\t\t\t\t$stmt = phoromatic_server::$db->prepare('SELECT Title, ScheduleID, RunAt FROM phoromatic_schedules WHERE AccountID = :account_id AND State >= 1  AND ActiveOn LIKE :active_on ORDER BY RunAt,Title ASC');\n\t\t\t\t$stmt->bindValue(':account_id', $_SESSION['AccountID']);\n\t\t\t\t$stmt->bindValue(':active_on', '%' . (date('N') - 1) . '%');\n\t\t\t\t$result = $stmt->execute();\n\t\t\t\t$row = $result->fetchArray();\n\n\t\t\t\tif($row == false)\n\t\t\t\t{\n\t\t\t\t\t$right .= '</ul><p style=\"text-align: left; margin: 6px 10px;\">No Events Found</p>';\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tdo\n\t\t\t\t\t{\n\t\t\t\t\t\t$right .= '<li>' . $row['RunAt'] . ' <a href=\"?schedules/' . $row['ScheduleID'] . '\">' . $row['Title'] . '</a></li>';\n\t\t\t\t\t}\n\t\t\t\t\twhile($row = $result->fetchArray());\n\t\t\t\t\t$right .= '</ul>';\n\t\t\t\t}\n\t\t}\n\n\t\t$system_count = phoromatic_account_system_count();\n\t\t$schedule_count = phoromatic_account_schedule_count();\n\t\t$stmt = phoromatic_server::$db->prepare('SELECT COUNT(UploadID) AS ResultCount FROM phoromatic_results WHERE AccountID = :account_id');\n\t\t$stmt->bindValue(':account_id', $_SESSION['AccountID']);\n\t\t$result = $stmt->execute();\n\t\t$row = $result->fetchArray();\n\t\t$result_count = $row['ResultCount'];\n\t\t$stmt = phoromatic_server::$db->prepare('SELECT COUNT(ActivityTime) AS ActivityCount FROM phoromatic_activity_stream WHERE AccountID = :account_id AND ActivityTime LIKE :today_date');\n\t\t$stmt->bindValue(':account_id', $_SESSION['AccountID']);\n\t\t$stmt->bindValue(':today_date', date('Y-m-d') . '%');\n\t\t$result = $stmt->execute();\n\t\t$row = $result->fetchArray();\n\t\t$activity_count = $row['ActivityCount'];\n\n\t\t$group_name = phoromatic_server::account_id_to_group_name($_SESSION['AccountID']);\n\t\tif($group_name != null)\n\t\t{\n\t\t\t$group_name = '<strong>' . $group_name . '</strong><br />';\n\t\t}\n\n\t\t$right .= '<hr /><p><strong>' . date('H:i T - j F Y') . '</strong><br />' . $group_name . '<a href=\"?systems\">' . $system_count . ' System' . ($system_count == 1 ? '' : 's') . '</a><br /><a href=\"?schedules\">' . $schedule_count . ' Schedule' . ($schedule_count == 1 ? '' : 's') . '</a><br /><a href=\"?results\">' . $result_count . ' Result' . ($result_count == 1 ? '' : 's') . '</a>';\n\t\t$right .= ' <a href=\"/rss.php?user=' . $_SESSION['UserID'] . '&amp;v=' . sha1($_SESSION['CreatedOn']) . '\"><img src=\"images/rss.svg\" width=\"16\" height=\"16\" /></a>';\n\t\t$right .= '<br /><a href=\"?account_activity\">' . $activity_count . ' Activity Events Today</a></p>';\n\t}\n\n\treturn $right;\n}\nfunction phoromatic_account_schedule_count()\n{\n\tstatic $schedule_count = 0;\n\n\tif($schedule_count == 0)\n\t{\n\t\t$stmt = phoromatic_server::$db->prepare('SELECT COUNT(Title) AS ScheduleCount FROM phoromatic_schedules WHERE AccountID = :account_id AND State >= 1');\n\t\t$stmt->bindValue(':account_id', $_SESSION['AccountID']);\n\t\t$result = $stmt->execute();\n\t\t$row = $result->fetchArray();\n\t\t$schedule_count = $row['ScheduleCount'];\n\t}\n\treturn $schedule_count;\n}\nfunction phoromatic_account_system_count()\n{\n\tstatic $sys_count = 0;\n\n\tif($sys_count == 0)\n\t{\n\t\t$stmt = phoromatic_server::$db->prepare('SELECT COUNT(Title) AS SystemCount FROM phoromatic_systems WHERE AccountID = :account_id AND State >= 0');\n\t\t$stmt->bindValue(':account_id', $_SESSION['AccountID']);\n\t\t$result = $stmt->execute();\n\t\t$row = $result->fetchArray();\n\t\t$sys_count = $row['SystemCount'];\n\t}\n\treturn $sys_count;\n}\nfunction phoromatic_web_socket_server_ip()\n{\n\t$server_ip = $_SERVER['HTTP_HOST'];\n\tif(($x = strpos($server_ip, ':')) !== false)\n\t{\n\t\t$server_ip = substr($server_ip, 0, $x);\n\t}\n\n\tif($server_ip == 'localhost' || $server_ip == '0.0.0.0')\n\t{\n\t\t$local_ip = phodevi::read_property('network', 'ip');\n\t\tif($local_ip)\n\t\t{\n\t\t\t$server_ip = $local_ip;\n\t\t}\n\t}\n\t// getenv('PTS_WEBSOCKET_PORT')\n\treturn $server_ip . ':' . $_SERVER['SERVER_PORT'];\n}\nfunction phoromatic_web_socket_server_addr()\n{\n\t// getenv('PTS_WEBSOCKET_PORT')\n\treturn phoromatic_web_socket_server_ip() . '/' . $_SESSION['AccountID'];\n}\nfunction phoromatic_error_page($title, $description)\n{\n\techo phoromatic_webui_header(array(''), '');\n\t$box = '<h1>' . $title . '</h1>\n\t\t<h2>' . $description . '</h2>';\n\techo phoromatic_webui_box($box);\n\techo phoromatic_webui_footer();\n}\nfunction phoromatic_systems_needing_attention()\n{\n\t$main = null;\n\t$stmt = phoromatic_server::$db->prepare('SELECT Title, SystemID, State, LastIP, LocalIP, LastCommunication FROM phoromatic_systems WHERE AccountID = :account_id AND State = 0 ORDER BY LastCommunication DESC');\n\t$stmt->bindValue(':account_id', $_SESSION['AccountID']);\n\t$result = $stmt->execute();\n\tif($row = $result->fetchArray())\n\t{\n\t\t$main .= '<div class=\"pts_phoromatic_info_box_area\"><div style=\"float: left; width: 100%;\"><ul><li><h1>Systems Needing Attention</h1></li><li class=\"light\" style=\"font-weight: normal;\">The following systems have attempted to sync with this Phoromatic account but have not been validated. When clicking on them you are able to approve or disable them from your account along with editing the system information.</li>';\n\n\t\tdo\n\t\t{\n\t\t\t$ip = $row['LocalIP'];\n\t\t\tif($row['LastIP'] != $row['LocalIP'])\n\t\t\t{\n\t\t\t\t$ip .= ' / ' . $row['LastIP'];\n\t\t\t}\n\n\t\t\t$main .= '<a href=\"?systems/' . $row['SystemID'] . '/edit\"><li>' . $row['Title'] . '<br /><em><strong>IP:</strong> ' . $ip . ' <strong>Last Communication:</strong> ' . $row['LastCommunication'] . '</em></li></a>';\n\t\t}\n\t\twhile($row = $result->fetchArray());\n\n\t\t$main .= '</ul></div></div>';\n\t}\n\n\treturn $main;\n}\nfunction phoromatic_oldest_result_for_schedule($schedule_id)\n{\n\tstatic $old_time;\n\n\tif(!isset($old_time[$schedule_id]))\n\t{\n\t\t$stmt = phoromatic_server::$db->prepare('SELECT UploadTime FROM phoromatic_results WHERE AccountID = :account_id AND ScheduleID = :schedule_id ORDER BY UploadTime ASC LIMIT 1');\n\t\t$stmt->bindValue(':account_id', $_SESSION['AccountID']);\n\t\t$stmt->bindValue(':schedule_id', $schedule_id);\n\t\t$result = $stmt->execute();\n\t\t$row = $result->fetchArray();\n\t\t$old_time[$schedule_id] = $row['UploadTime'];\n\t}\n\n\treturn $old_time[$schedule_id];\n}\nfunction write_token_in_form()\n{\n\treturn '<input type=\"hidden\" name=\"token_submit\" value=\"' . $_SESSION['Token'] . '\" />';\n}\nfunction append_token_to_url($prefix = '/')\n{\n\treturn $prefix . '&token_submit=' . $_SESSION['Token'];\n}\nfunction verify_submission_token()\n{\n\treturn isset($_REQUEST['token_submit']) && $_REQUEST['token_submit'] == $_SESSION['Token'];\n}\nfunction create_new_phoromatic_account($register_username, $register_password, $register_password_confirm, $register_email, $seed_accountid = null)\n{\n\t// REGISTER NEW USER\n\tif(strlen($register_username) < 4 || strpos($register_username, ' ') !== false)\n\t{\n\t\tphoromatic_error_page('Oops!', 'Please go back and ensure the supplied username is at least four characters long and contains no spaces.');\n\t\treturn false;\n\t}\n\tif(in_array(strtolower($register_username), array('admin', 'administrator', 'rootadmin')))\n\t{\n\t\tphoromatic_error_page('Oops!', $register_username . ' is a reserved and common username that may be used for other purposes, please make a different selection.');\n\t\treturn false;\n\t}\n\tif(strlen($register_password) < 6)\n\t{\n\t\tphoromatic_error_page('Oops!', 'Please go back and ensure the supplied password is at least six characters long.');\n\t\treturn false;\n\t}\n\tif($register_password != $register_password_confirm)\n\t{\n\t\tphoromatic_error_page('Oops!', 'Please go back and ensure the supplied password matches the password confirmation.');\n\t\treturn false;\n\t}\n\tif($register_email == null || filter_var($register_email, FILTER_VALIDATE_EMAIL) == false)\n\t{\n\t\tphoromatic_error_page('Oops!', 'Please enter a valid email address.');\n\t\treturn false;\n\t}\n\n\t$valid_user_name_chars = '1234567890-_.abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';\n\tfor($i = 0; $i < strlen($register_username); $i++)\n\t{\n\t\tif(strpos($valid_user_name_chars, substr($register_username, $i, 1)) === false)\n\t\t{\n\t\t\tphoromatic_error_page('Oops!', 'Please go back and ensure a valid user-name. The character <em>' . substr($register_username, $i, 1) . '</em> is not allowed.');\n\t\t\treturn false;\n\t\t}\n\t}\n\n\t$matching_users = phoromatic_server::$db->querySingle('SELECT UserName FROM phoromatic_users WHERE UserName = \\'' . SQLite3::escapeString($register_username) . '\\'');\n\tif(!empty($matching_users))\n\t{\n\t\tphoromatic_error_page('Oops!', 'The user-name is already taken.');\n\t\treturn false;\n\t}\n\n\tif(phoromatic_server::read_setting('add_new_users_to_account') != null)\n\t{\n\t\t$account_id = phoromatic_server::read_setting('add_new_users_to_account');\n\t\t$is_new_account = false;\n\t}\n\telse\n\t{\n\t\t$id_tries = 0;\n\t\tdo\n\t\t{\n\t\t\tif($id_tries == 0 && $seed_accountid != null && isset($seed_accountid[5]))\n\t\t\t{\n\t\t\t\t$account_id = strtoupper(substr($seed_accountid, 0, 6));\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$account_id = pts_strings::random_characters(6, true);\n\t\t\t}\n\t\t\t$matching_accounts = phoromatic_server::$db->querySingle('SELECT AccountID FROM phoromatic_accounts WHERE AccountID = \\'' . $account_id . '\\'');\n\t\t\t$id_tries++;\n\t\t}\n\t\twhile(!empty($matching_accounts));\n\t\t$is_new_account = true;\n\t}\n\n\t$user_id = pts_strings::random_characters(4, true);\n\n\tif($is_new_account)\n\t{\n\t\tpts_logger::add_to_log($_SERVER['REMOTE_ADDR'] . ' created a new account: ' . $user_id . ' - ' . $account_id);\n\t\t$account_salt = pts_strings::random_characters(12, true);\n\t\t$stmt = phoromatic_server::$db->prepare('INSERT INTO phoromatic_accounts (AccountID, ValidateID, CreatedOn, Salt) VALUES (:account_id, :validate_id, :current_time, :salt)');\n\t\t$stmt->bindValue(':account_id', $account_id);\n\t\t$stmt->bindValue(':validate_id', pts_strings::random_characters(4, true));\n\t\t$stmt->bindValue(':salt', $account_salt);\n\t\t$stmt->bindValue(':current_time', phoromatic_server::current_time());\n\t\t$result = $stmt->execute();\n\n\t\t$stmt = phoromatic_server::$db->prepare('INSERT INTO phoromatic_account_settings (AccountID) VALUES (:account_id)');\n\t\t$stmt->bindValue(':account_id', $account_id);\n\t\t$result = $stmt->execute();\n\n\t\t$stmt = phoromatic_server::$db->prepare('INSERT INTO phoromatic_user_settings (UserID, AccountID) VALUES (:user_id, :account_id)');\n\t\t$stmt->bindValue(':user_id', $user_id);\n\t\t$stmt->bindValue(':account_id', $account_id);\n\t\t$result = $stmt->execute();\n\t}\n\telse\n\t{\n\t\tpts_logger::add_to_log($_SERVER['REMOTE_ADDR'] . ' being added to an account: ' . $user_id . ' - ' . $account_id);\n\t\t$account_salt = phoromatic_server::$db->querySingle('SELECT Salt FROM phoromatic_accounts WHERE AccountID = \\'' . $account_id . '\\'');\n\t}\n\n\t$salted_password = hash('sha256', $account_salt . $register_password);\n\t$stmt = phoromatic_server::$db->prepare('INSERT INTO phoromatic_users (UserID, AccountID, UserName, Email, Password, CreatedOn, LastIP, AdminLevel) VALUES (:user_id, :account_id, :user_name, :email, :password, :current_time, :last_ip, :admin_level)');\n\t$stmt->bindValue(':user_id', $user_id);\n\t$stmt->bindValue(':account_id', $account_id);\n\t$stmt->bindValue(':user_name', $register_username);\n\t$stmt->bindValue(':email', $register_email);\n\t$stmt->bindValue(':password', $salted_password);\n\t$stmt->bindValue(':last_ip', $_SERVER['REMOTE_ADDR']);\n\t$stmt->bindValue(':current_time', phoromatic_server::current_time());\n\t$stmt->bindValue(':admin_level', ($is_new_account ? 1 : 10));\n\t$result = $stmt->execute();\n\n\tpts_file_io::mkdir(phoromatic_server::phoromatic_account_path($account_id));\n\tphoromatic_server::send_email($register_email, 'Phoromatic Account Registration', (($e = phoromatic_server::read_setting('admin_support_email')) != null ? $e : 'no-reply@phoromatic.com'), '<p><strong>' . $register_username . '</strong>:</p><p>Your Phoromatic account has been created and is now active.</p>');\n\treturn true;\n}\n\n?>\n"], "filenames": ["pts-core/phoromatic/phoromatic_functions.php"], "buggy_code_start_loc": [40], "buggy_code_end_loc": [43], "fixing_code_start_loc": [40], "fixing_code_end_loc": [54], "type": "CWE-79", "message": "A XSS vulnerability was found in phoromatic_r_add_test_details.php in phoronix-test-suite.", "other": {"cve": {"id": "CVE-2022-40704", "sourceIdentifier": "secalert@redhat.com", "published": "2023-01-17T19:15:11.530", "lastModified": "2023-01-24T19:46:41.243", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "A XSS vulnerability was found in phoromatic_r_add_test_details.php in phoronix-test-suite."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}]}, "weaknesses": [{"source": "secalert@redhat.com", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:phoronix-media:phoronix_test_suite:*:*:*:*:*:*:*:*", "versionEndExcluding": "2022-07-23", "matchCriteriaId": "A8D55ADF-EAC6-498D-86CD-FEAA55D140E4"}]}]}], "references": [{"url": "https://github.com/phoronix-test-suite/phoronix-test-suite/commit/d3880d9d3ba795138444da83f1153c3c3ac27640", "source": "secalert@redhat.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/phoronix-test-suite/phoronix-test-suite/issues/650", "source": "secalert@redhat.com", "tags": ["Exploit", "Issue Tracking", "Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/phoronix-test-suite/phoronix-test-suite/commit/d3880d9d3ba795138444da83f1153c3c3ac27640"}}