{"buggy_code": ["<?php\n/**\n * MyBB 1.8\n * Copyright 2014 MyBB Group, All Rights Reserved\n *\n * Website: http://www.mybb.com\n * License: http://www.mybb.com/about/license\n *\n */\n\n// Disallow direct access to this file for security reasons\nif(!defined(\"IN_MYBB\"))\n{\n\tdie(\"Direct initialization of this file is not allowed.<br /><br />Please make sure IN_MYBB is defined.\");\n}\n\n$page->add_breadcrumb_item($lang->board_settings, \"index.php?module=config-settings\");\n\n$plugins->run_hooks(\"admin_config_settings_begin\");\n\n// Creating a new setting group\nif($mybb->input['action'] == \"addgroup\")\n{\n\t$plugins->run_hooks(\"admin_config_settings_addgroup\");\n\n\tif($mybb->request_method == \"post\")\n\t{\n\t\t// Validate title\n\t\tif(!trim($mybb->input['title']))\n\t\t{\n\t\t\t$errors[] = $lang->error_missing_group_title;\n\t\t}\n\n\t\t// Validate identifier\n\t\tif(!trim($mybb->input['name']))\n\t\t{\n\t\t\t$errors[] = $lang->error_missing_group_name;\n\t\t}\n\t\t$query = $db->simple_select(\"settinggroups\", \"title\", \"name='\".$db->escape_string($mybb->input['name']).\"'\");\n\t\tif($db->num_rows($query) > 0)\n\t\t{\n\t\t\t$dup_group_title = $db->fetch_field($query, 'title');\n\t\t\t$errors[] = $lang->sprintf($lang->error_duplicate_group_name, $dup_group_title);\n\t\t}\n\n\t\tif(!$errors)\n\t\t{\n\t\t\t$new_setting_group = array(\n\t\t\t\t\"name\" => $db->escape_string($mybb->input['name']),\n\t\t\t\t\"title\" => $db->escape_string($mybb->input['title']),\n\t\t\t\t\"description\" => $db->escape_string($mybb->input['description']),\n\t\t\t\t\"disporder\" => $mybb->get_input('disporder', MyBB::INPUT_INT),\n\t\t\t\t\"isdefault\" => 0\n\t\t\t);\n\t\t\t$gid = $db->insert_query(\"settinggroups\", $new_setting_group);\n\n\t\t\t$plugins->run_hooks(\"admin_config_settings_addgroup_commit\");\n\n\t\t\t// Log admin action\n\t\t\tlog_admin_action($gid, $mybb->input['name']);\n\n\t\t\tflash_message($lang->success_setting_group_added, 'success');\n\t\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t\t}\n\t}\n\n\t$page->add_breadcrumb_item($lang->add_new_setting_group);\n\t$page->output_header($lang->board_settings.\" - \".$lang->add_new_setting_group);\n\n\t$sub_tabs['change_settings'] = array(\n\t\t'title' => $lang->change_settings,\n\t\t'link' => \"index.php?module=config-settings\"\n\t);\n\n\t$sub_tabs['add_setting'] = array(\n\t\t'title' => $lang->add_new_setting,\n\t\t'link' => \"index.php?module=config-settings&amp;action=add\"\n\t);\n\n\t$sub_tabs['add_setting_group'] = array(\n\t\t'title' => $lang->add_new_setting_group,\n\t\t'link' => \"index.php?module=config-settings&amp;action=addgroup\",\n\t\t'description' => $lang->add_new_setting_group_desc\n\t);\n\n\t$sub_tabs['modify_setting'] = array(\n\t\t'title' => $lang->modify_existing_settings,\n\t\t'link' => \"index.php?module=config-settings&amp;action=manage\"\n\t);\n\n\t$page->output_nav_tabs($sub_tabs, 'add_setting_group');\n\n\t$form = new Form(\"index.php?module=config-settings&amp;action=addgroup\", \"post\", \"add\");\n\n\tif($errors)\n\t{\n\t\t$page->output_inline_error($errors);\n\t}\n\n\t$form_container = new FormContainer($lang->add_new_setting_group);\n\t$form_container->output_row($lang->title.\" <em>*</em>\", \"\", $form->generate_text_box('title', $mybb->get_input('title'), array('id' => 'title')), 'title');\n\t$form_container->output_row($lang->description, \"\", $form->generate_text_area('description', $mybb->get_input('description'), array('id' => 'description')), 'description');\n\t$form_container->output_row($lang->display_order, \"\", $form->generate_numeric_field('disporder', $mybb->get_input('disporder'), array('id' => 'disporder', 'min' => 0)), 'disporder');\n\t$form_container->output_row($lang->name.\" <em>*</em>\", $lang->group_name_desc, $form->generate_text_box('name', $mybb->get_input('name'), array('id' => 'name')), 'name');\n\t$form_container->end();\n\n\t$buttons[] = $form->generate_submit_button($lang->insert_new_setting_group);\n\t$form->output_submit_wrapper($buttons);\n\t$form->end();\n\n\t$page->output_footer();\n}\n\n// Edit setting group\nif($mybb->input['action'] == \"editgroup\")\n{\n\t$query = $db->simple_select(\"settinggroups\", \"*\", \"gid='\".$mybb->get_input('gid', MyBB::INPUT_INT).\"'\");\n\t$group = $db->fetch_array($query);\n\n\t// Does the setting not exist?\n\tif(!$group['gid'])\n\t{\n\t\tflash_message($lang->error_invalid_gid2, 'error');\n\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t}\n\t// Prevent editing of default\n\tif($group['isdefault'] == 1)\n\t{\n\t\tflash_message($lang->error_cannot_edit_default, 'error');\n\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t}\n\n\t$plugins->run_hooks(\"admin_config_settings_editgroup\");\n\n\t// Do edit?\n\tif($mybb->request_method == \"post\")\n\t{\n\t\t// Validate title\n\t\tif(!trim($mybb->input['title']))\n\t\t{\n\t\t\t$errors[] = $lang->error_missing_group_title;\n\t\t}\n\n\t\t// Validate identifier\n\t\tif(!trim($mybb->input['name']))\n\t\t{\n\t\t\t$errors[] = $lang->error_missing_group_name;\n\t\t}\n\t\t$query = $db->simple_select(\"settinggroups\", \"title\", \"name='\".$db->escape_string($mybb->input['name']).\"' AND gid != '{$group['gid']}'\");\n\t\tif($db->num_rows($query) > 0)\n\t\t{\n\t\t\t$dup_group_title = $db->fetch_field($query, 'title');\n\t\t\t$errors[] = $lang->sprintf($lang->error_duplicate_group_name, $dup_group_title);\n\t\t}\n\n\t\tif(!$errors)\n\t\t{\n\t\t\t$update_setting_group = array(\n\t\t\t\t\"name\" => $db->escape_string($mybb->input['name']),\n\t\t\t\t\"title\" => $db->escape_string($mybb->input['title']),\n\t\t\t\t\"description\" => $db->escape_string($mybb->input['description']),\n\t\t\t\t\"disporder\" => $mybb->get_input('disporder', MyBB::INPUT_INT),\n\t\t\t);\n\n\t\t\t$plugins->run_hooks(\"admin_config_settings_editgroup_commit\");\n\n\t\t\t$db->update_query(\"settinggroups\", $update_setting_group, \"gid='{$group['gid']}'\");\n\n\t\t\t// Log admin action\n\t\t\tlog_admin_action($group['gid'], $mybb->input['name']);\n\n\t\t\tflash_message($lang->success_setting_group_updated, 'success');\n\t\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t\t}\n\t}\n\n\t$page->add_breadcrumb_item($lang->edit_setting_group);\n\t$page->output_header($lang->board_settings.\" - \".$lang->edit_setting_group);\n\n\t$sub_tabs['edit_setting_group'] = array(\n\t\t'title' => $lang->edit_setting_group,\n\t\t'link' => \"index.php?module=config-settings&amp;action=editgroup&amp;gid={$group['gid']}\",\n\t\t'description' => $lang->edit_setting_group_desc\n\t);\n\n\t$page->output_nav_tabs($sub_tabs, 'edit_setting_group');\n\n\t$form = new Form(\"index.php?module=config-settings&amp;action=editgroup\", \"post\", \"editgroup\");\n\n\techo $form->generate_hidden_field(\"gid\", $group['gid']);\n\n\tif($errors)\n\t{\n\t\t$group_data = $mybb->input;\n\t\t$page->output_inline_error($errors);\n\t}\n\telse\n\t{\n\t\t$group_data = $group;\n\t}\n\n\t$form_container = new FormContainer($lang->edit_setting_group);\n\t$form_container->output_row($lang->title.\" <em>*</em>\", \"\", $form->generate_text_box('title', $group_data['title'], array('id' => 'title')), 'title');\n\t$form_container->output_row($lang->description, \"\", $form->generate_text_area('description', $group_data['description'], array('id' => 'description')), 'description');\n\t$form_container->output_row($lang->display_order, \"\", $form->generate_numeric_field('disporder', $group_data['disporder'], array('id' => 'disporder', 'min' => 0)), 'disporder');\n\t$form_container->output_row($lang->name.\" <em>*</em>\", $lang->group_name_desc, $form->generate_text_box('name', $group_data['name'], array('id' => 'name')), 'name');\n\t$form_container->end();\n\n\t$buttons[] = $form->generate_submit_button($lang->update_setting_group);\n\t$form->output_submit_wrapper($buttons);\n\t$form->end();\n\n\t$page->output_footer();\n}\n\n// Delete Setting Group\nif($mybb->input['action'] == \"deletegroup\")\n{\n\t$query = $db->simple_select(\"settinggroups\", \"*\", \"gid='\".$mybb->get_input('gid', MyBB::INPUT_INT).\"'\");\n\t$group = $db->fetch_array($query);\n\n\t// Does the setting group not exist?\n\tif(!$group['gid'])\n\t{\n\t\tflash_message($lang->error_invalid_gid2, 'error');\n\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t}\n\t// Prevent deletion of default\n\tif($group['isdefault'] == 1)\n\t{\n\t\tflash_message($lang->error_cannot_edit_default, 'error');\n\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t}\n\n\t// User clicked no\n\tif($mybb->get_input('no'))\n\t{\n\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t}\n\n\t$plugins->run_hooks(\"admin_config_settings_deletegroup\");\n\n\tif($mybb->request_method == \"post\")\n\t{\n\t\t// Delete the setting group and its settings\n\t\t$db->delete_query(\"settinggroups\", \"gid='{$group['gid']}'\");\n\t\t$db->delete_query(\"settings\", \"gid='{$group['gid']}'\");\n\n\t\trebuild_settings();\n\n\t\t$plugins->run_hooks(\"admin_config_settings_deletegroup_commit\");\n\n\t\t// Log admin action\n\t\tlog_admin_action($group['gid'], $group['name']);\n\n\t\tflash_message($lang->success_setting_group_deleted, 'success');\n\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t}\n\telse\n\t{\n\t\t$page->output_confirm_action(\"index.php?module=config-settings&amp;action=deletegroup&amp;gid={$group['gid']}\", $lang->confirm_setting_group_deletion);\n\t}\n}\n\n// Creating a new setting\nif($mybb->input['action'] == \"add\")\n{\n\t$plugins->run_hooks(\"admin_config_settings_add\");\n\n\tif($mybb->request_method == \"post\")\n\t{\n\t\tif(!trim($mybb->input['title']))\n\t\t{\n\t\t\t$errors[] = $lang->error_missing_title;\n\t\t}\n\n\t\t$query = $db->simple_select(\"settinggroups\", \"gid\", \"gid='\".$mybb->get_input('gid', MyBB::INPUT_INT).\"'\");\n\t\t$gid = $db->fetch_field($query, 'gid');\n\t\tif(!$gid)\n\t\t{\n\t\t\t$errors[] = $lang->error_invalid_gid;\n\t\t}\n\n\t\tif(!trim($mybb->input['name']))\n\t\t{\n\t\t\t$errors[] = $lang->error_missing_name;\n\t\t}\n\t\t$query = $db->simple_select(\"settings\", \"title\", \"name='\".$db->escape_string($mybb->input['name']).\"'\");\n\t\tif($db->num_rows($query) > 0)\n\t\t{\n\t\t\t$dup_setting_title = $db->fetch_field($query, 'title');\n\t\t\t$errors[] = $lang->sprintf($lang->error_duplicate_name, $dup_setting_title);\n\t\t}\n\n\t\t// do some type filtering\n\t\t$mybb->input['type'] = str_replace(\"\\n\", \"\", $mybb->input['type']);\n\t\tif(strtolower(substr($mybb->input['type'], 0, 3)) == \"php\")\n\t\t{\n\t\t\t$mybb->input['type'] = \"\";\n\t\t}\n\n\t\tif(!$mybb->input['type'])\n\t\t{\n\t\t\t$errors[] = $lang->error_invalid_type;\n\t\t}\n\n\t\tif(!$errors)\n\t\t{\n\t\t\tif($mybb->input['extra'])\n\t\t\t{\n\t\t\t\t$options_code = \"{$mybb->input['type']}\\n{$mybb->input['extra']}\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$options_code = $mybb->input['type'];\n\t\t\t}\n\n\t\t\t$mybb->input['name'] = str_replace(\"\\\\\", '', $mybb->input['name']);\n\t\t\t$mybb->input['name'] = str_replace('$', '', $mybb->input['name']);\n\t\t\t$mybb->input['name'] = str_replace(\"'\", '', $mybb->input['name']);\n\n\t\t\tif($options_code == \"numeric\")\n\t\t\t{\n\t\t\t\t$value = $mybb->get_input('value', MyBB::INPUT_INT);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$value = $db->escape_string($mybb->input['value']);\n\t\t\t}\n\n\t\t\t$new_setting = array(\n\t\t\t\t\"name\" => $db->escape_string($mybb->input['name']),\n\t\t\t\t\"title\" => $db->escape_string($mybb->input['title']),\n\t\t\t\t\"description\" => $db->escape_string($mybb->input['description']),\n\t\t\t\t\"optionscode\" => $db->escape_string($options_code),\n\t\t\t\t\"value\" => $value,\n\t\t\t\t\"disporder\" => $mybb->get_input('disporder', MyBB::INPUT_INT),\n\t\t\t\t\"gid\" => $mybb->get_input('gid', MyBB::INPUT_INT)\n\t\t\t);\n\n\t\t\t$sid = $db->insert_query(\"settings\", $new_setting);\n\t\t\trebuild_settings();\n\n\t\t\t$plugins->run_hooks(\"admin_config_settings_add_commit\");\n\n\t\t\t// Log admin action\n\t\t\tlog_admin_action($sid, $mybb->input['title']);\n\n\t\t\tflash_message($lang->success_setting_added, 'success');\n\t\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t\t}\n\t}\n\n\t$page->add_breadcrumb_item($lang->add_new_setting);\n\t$page->output_header($lang->board_settings.\" - \".$lang->add_new_setting);\n\n\t$sub_tabs['change_settings'] = array(\n\t\t'title' => $lang->change_settings,\n\t\t'link' => \"index.php?module=config-settings\"\n\t);\n\n\t$sub_tabs['add_setting'] = array(\n\t\t'title' => $lang->add_new_setting,\n\t\t'link' => \"index.php?module=config-settings&amp;action=add\",\n\t\t'description' => $lang->add_new_setting_desc\n\t);\n\n\t$sub_tabs['add_setting_group'] = array(\n\t\t'title' => $lang->add_new_setting_group,\n\t\t'link' => \"index.php?module=config-settings&amp;action=addgroup\"\n\t);\n\n\t$sub_tabs['modify_setting'] = array(\n\t\t'title' => $lang->modify_existing_settings,\n\t\t'link' => \"index.php?module=config-settings&amp;action=manage\"\n\t);\n\n\t$page->output_nav_tabs($sub_tabs, 'add_setting');\n\n\t$form = new Form(\"index.php?module=config-settings&amp;action=add\", \"post\", \"add\");\n\n\tif($errors)\n\t{\n\t\t$page->output_inline_error($errors);\n\t}\n\n\t$form_container = new FormContainer($lang->add_new_setting);\n\t$form_container->output_row($lang->title.\" <em>*</em>\", \"\", $form->generate_text_box('title', $mybb->get_input('title'), array('id' => 'title')), 'title');\n\t$form_container->output_row($lang->description, \"\", $form->generate_text_area('description', $mybb->get_input('description'), array('id' => 'description')), 'description');\n\n\t$query = $db->simple_select(\"settinggroups\", \"*\", \"\", array('order_by' => 'disporder'));\n\twhile($group = $db->fetch_array($query))\n\t{\n\t\t$group_lang_var = \"setting_group_{$group['name']}\";\n\t\tif(!empty($lang->$group_lang_var))\n\t\t{\n\t\t\t$options[$group['gid']] = htmlspecialchars_uni($lang->$group_lang_var);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$options[$group['gid']] = htmlspecialchars_uni($group['title']);\n\t\t}\n\t}\n\t$form_container->output_row($lang->group.\" <em>*</em>\", \"\", $form->generate_select_box(\"gid\", $options, $mybb->get_input('gid'), array('id' => 'gid')), 'gid');\n\t$form_container->output_row($lang->display_order, \"\", $form->generate_numeric_field('disporder', $mybb->get_input('disporder'), array('id' => 'disporder', 'min' => 0)), 'disporder');\n\n\t$form_container->output_row($lang->name.\" <em>*</em>\", $lang->name_desc, $form->generate_text_box('name', $mybb->get_input('name'), array('id' => 'name')), 'name');\n\n\t$setting_types = array(\n\t\t\"text\" => $lang->text,\n\t\t\"numeric\" => $lang->numeric_text,\n\t\t\"textarea\" => $lang->textarea,\n\t\t\"yesno\" => $lang->yesno,\n\t\t\"onoff\" => $lang->onoff,\n\t\t\"select\" => $lang->select,\n\t\t\"forumselect\" => $lang->forum_selection_box,\n\t\t\"forumselectsingle\" => $lang->forum_selection_single,\n\t\t\"groupselect\" => $lang->group_selection_box,\n\t\t\"groupselectsingle\" => $lang->group_selection_single,\n\t\t\"radio\" => $lang->radio,\n\t\t\"checkbox\" => $lang->checkbox,\n\t\t\"language\" => $lang->language_selection_box,\n\t\t\"adminlanguage\" => $lang->adminlanguage,\n\t\t\"cpstyle\" => $lang->cpstyle,\n\t\t\"prefixselect\" => $lang->prefix_selection_box\n\t\t//\"php\" => $lang->php // Internal Use Only\n\t);\n\n\t$form_container->output_row($lang->type.\" <em>*</em>\", \"\", $form->generate_select_box(\"type\", $setting_types, $mybb->get_input('type'), array('id' => 'type')), 'type');\n\t$form_container->output_row($lang->extra, $lang->extra_desc, $form->generate_text_area('extra', $mybb->get_input('extra'), array('id' => 'extra')), 'extra', array(), array('id' => 'row_extra'));\n\t$form_container->output_row($lang->value, \"\", $form->generate_text_area('value', $mybb->get_input('value'), array('id' => 'value')), 'value');\n\t$form_container->end();\n\n\t$buttons[] = $form->generate_submit_button($lang->insert_new_setting);\n\t$form->output_submit_wrapper($buttons);\n\t$form->end();\n\n\techo '<script type=\"text/javascript\" src=\"./jscripts/peeker.js?ver=1821\"></script>\n\t<script type=\"text/javascript\">\n\t\t$(function() {\n\t\t\tnew Peeker($(\"#type\"), $(\"#row_extra\"), /^(select|radio|checkbox|php)$/, false);\n\t\t});\n\t\t// Add a star to the extra row since the \"extra\" is required if the box is shown\n\t\tadd_star(\"row_extra\");\n\t</script>';\n\n\t$page->output_footer();\n}\n\n// Editing a particular setting\nif($mybb->input['action'] == \"edit\")\n{\n\t$query = $db->simple_select(\"settings\", \"*\", \"sid='\".$mybb->get_input('sid', MyBB::INPUT_INT).\"'\");\n\t$setting = $db->fetch_array($query);\n\n\t// Does the setting not exist?\n\tif(!$setting['sid'])\n\t{\n\t\tflash_message($lang->error_invalid_sid, 'error');\n\t\tadmin_redirect(\"index.php?module=config-settings\");\n\t}\n\n\t// Prevent editing of default\n\tif($setting['isdefault'] == 1)\n\t{\n\t\tflash_message($lang->error_cannot_edit_default, 'error');\n\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t}\n\n\t$plugins->run_hooks(\"admin_config_settings_edit\");\n\n\t$type = explode(\"\\n\", $setting['optionscode'], 2);\n\t$type = trim($type[0]);\n\tif($type == \"php\")\n\t{\n\t\tflash_message($lang->error_cannot_edit_php, 'error');\n\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t}\n\n\tif($mybb->request_method == \"post\")\n\t{\n\t\tif(!trim($mybb->input['title']))\n\t\t{\n\t\t\t$errors[] = $lang->error_missing_title;\n\t\t}\n\n\t\tif(!trim($mybb->input['name']))\n\t\t{\n\t\t\t$errors[] = $lang->error_missing_name;\n\t\t}\n\t\t$query = $db->simple_select(\"settings\", \"title\", \"name='\".$db->escape_string($mybb->input['name']).\"' AND sid != '{$setting['sid']}'\");\n\t\tif($db->num_rows($query) > 0)\n\t\t{\n\t\t\t$dup_setting_title = $db->fetch_field($query, 'title');\n\t\t\t$errors[] = $lang->sprintf($lang->error_duplicate_name, $dup_setting_title);\n\t\t}\n\n\t\t// do some type filtering\n\t\t$mybb->input['type'] = str_replace(\"\\n\", \"\", $mybb->input['type']);\n\t\tif(strtolower(substr($mybb->input['type'], 0, 3)) == \"php\")\n\t\t{\n\t\t\t$mybb->input['type'] = \"\";\n\t\t}\n\n\t\tif(!$mybb->input['type'])\n\t\t{\n\t\t\t$errors[] = $lang->error_invalid_type;\n\t\t}\n\n\t\tif(!$errors)\n\t\t{\n\t\t\tif($mybb->input['extra'])\n\t\t\t{\n\t\t\t\t$options_code = \"{$mybb->input['type']}\\n{$mybb->input['extra']}\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$options_code = $mybb->input['type'];\n\t\t\t}\n\n\t\t\t$mybb->input['name'] = str_replace(\"\\\\\", '', $mybb->input['name']);\n\t\t\t$mybb->input['name'] = str_replace('$', '', $mybb->input['name']);\n\t\t\t$mybb->input['name'] = str_replace(\"'\", '', $mybb->input['name']);\n\n\t\t\tif($options_code == \"numeric\")\n\t\t\t{\n\t\t\t\t$value = $mybb->get_input('value', MyBB::INPUT_INT);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$value = $db->escape_string($mybb->input['value']);\n\t\t\t}\n\n\t\t\t$updated_setting = array(\n\t\t\t\t\"name\" => $db->escape_string($mybb->input['name']),\n\t\t\t\t\"title\" => $db->escape_string($mybb->input['title']),\n\t\t\t\t\"description\" => $db->escape_string($mybb->input['description']),\n\t\t\t\t\"optionscode\" => $db->escape_string($options_code),\n\t\t\t\t\"value\" => $value,\n\t\t\t\t\"disporder\" => $mybb->get_input('disporder', MyBB::INPUT_INT),\n\t\t\t\t\"gid\" => $mybb->get_input('gid', MyBB::INPUT_INT)\n\t\t\t);\n\n\t\t\t$plugins->run_hooks(\"admin_config_settings_edit_commit\");\n\n\t\t\t$db->update_query(\"settings\", $updated_setting, \"sid='{$setting['sid']}'\");\n\t\t\trebuild_settings();\n\n\t\t\t// Log admin action\n\t\t\tlog_admin_action($setting['sid'], $mybb->input['title']);\n\n\t\t\tflash_message($lang->success_setting_updated, 'success');\n\t\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t\t}\n\t}\n\n\t$page->add_breadcrumb_item($lang->edit_setting);\n\t$page->output_header($lang->board_settings.\" - \".$lang->edit_setting);\n\n\t$sub_tabs['change_settings'] = array(\n\t\t'title' => $lang->change_settings,\n\t\t'link' => \"index.php?module=config-settings\",\n\t);\n\n\t$sub_tabs['add_setting'] = array(\n\t\t'title' => $lang->add_new_setting,\n\t\t'link' => \"index.php?module=config-settings&amp;action=add\"\n\t);\n\n\t$sub_tabs['add_setting_group'] = array(\n\t\t'title' => $lang->add_new_setting_group,\n\t\t'link' => \"index.php?module=config-settings&amp;action=addgroup\"\n\t);\n\n\t$sub_tabs['modify_setting'] = array(\n\t\t'title' => $lang->modify_existing_settings,\n\t\t'link' => \"index.php?module=config-settings&amp;action=manage\",\n\t\t'description' => $lang->modify_existing_settings_desc\n\t);\n\n\t$page->output_nav_tabs($sub_tabs, 'modify_setting');\n\n\t$form = new Form(\"index.php?module=config-settings&amp;action=edit\", \"post\", \"edit\");\n\n\techo $form->generate_hidden_field(\"sid\", $setting['sid']);\n\n\tif($errors)\n\t{\n\t\t$setting_data = $mybb->input;\n\t\t$page->output_inline_error($errors);\n\t}\n\telse\n\t{\n\t\t$setting_data = $setting;\n\t\t$type = explode(\"\\n\", $setting['optionscode'], 2);\n\t\t$setting_data['type'] = trim($type[0]);\n\n\t\tif(isset($type[1]))\n\t\t{\n\t\t\t$setting_data['extra'] = trim($type[1]);\n\t\t}\n\t}\n\n\t$form_container = new FormContainer($lang->modify_setting);\n\t$form_container->output_row($lang->title.\" <em>*</em>\", \"\", $form->generate_text_box('title', $setting_data['title'], array('id' => 'title')), 'title');\n\t$form_container->output_row($lang->description, \"\", $form->generate_text_area('description', $setting_data['description'], array('id' => 'description')), 'description');\n\n\t$query = $db->simple_select(\"settinggroups\", \"*\", \"\", array('order_by' => 'disporder'));\n\twhile($group = $db->fetch_array($query))\n\t{\n\t\t$group_lang_var = \"setting_group_{$group['name']}\";\n\t\tif(!empty($lang->$group_lang_var))\n\t\t{\n\t\t\t$options[$group['gid']] = htmlspecialchars_uni($lang->$group_lang_var);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$options[$group['gid']] = htmlspecialchars_uni($group['title']);\n\t\t}\n\t}\n\t$form_container->output_row($lang->group.\" <em>*</em>\", \"\", $form->generate_select_box(\"gid\", $options, $setting_data['gid'], array('id' => 'gid')), 'gid');\n\t$form_container->output_row($lang->display_order, \"\", $form->generate_numeric_field('disporder', $setting_data['disporder'], array('id' => 'disporder', 'min' => 0)), 'disporder');\n\t$form_container->end();\n\n\t$form_container = new FormContainer($lang->setting_configuration, 1);\n\t$form_container->output_row($lang->name.\" <em>*</em>\", $lang->name_desc, $form->generate_text_box('name', $setting_data['name'], array('id' => 'name')), 'name');\n\n\t$setting_types = array(\n\t\t\"text\" => $lang->text,\n\t\t\"numeric\" => $lang->numeric_text,\n\t\t\"textarea\" => $lang->textarea,\n\t\t\"yesno\" => $lang->yesno,\n\t\t\"onoff\" => $lang->onoff,\n\t\t\"select\" => $lang->select,\n\t\t\"forumselect\" => $lang->forum_selection_box,\n\t\t\"forumselectsingle\" => $lang->forum_selection_single,\n\t\t\"groupselect\" => $lang->group_selection_box,\n\t\t\"groupselectsingle\" => $lang->group_selection_single,\n\t\t\"radio\" => $lang->radio,\n\t\t\"checkbox\" => $lang->checkbox,\n\t\t\"language\" => $lang->language_selection_box,\n\t\t\"adminlanguage\" => $lang->adminlanguage,\n\t\t\"cpstyle\" => $lang->cpstyle,\n\t\t\"prefixselect\" => $lang->prefix_selection_box\n\t\t//\"php\" => $lang->php // Internal Use Only\n\t);\n\n\t$form_container->output_row($lang->type.\" <em>*</em>\", \"\", $form->generate_select_box(\"type\", $setting_types, $setting_data['type'], array('id' => 'type')), 'type');\n\t$form_container->output_row($lang->extra, $lang->extra_desc, $form->generate_text_area('extra', !empty($setting_data['extra']) ? $setting_data['extra'] : null, array('id' => 'extra')), 'extra', array(), array('id' => 'row_extra'));\n\t$form_container->output_row($lang->value, '', $form->generate_text_area('value', $setting_data['value'], array('id' => 'value')), 'value');\n\t$form_container->end();\n\n\t$buttons[] = $form->generate_submit_button($lang->update_setting);\n\t$form->output_submit_wrapper($buttons);\n\t$form->end();\n\n\techo '<script type=\"text/javascript\" src=\"./jscripts/peeker.js?ver=1821\"></script>\n\t<script type=\"text/javascript\">\n\t\t$(function() {\n\t\t\tnew Peeker($(\"#type\"), $(\"#row_extra\"), /^(select|radio|checkbox|php)$/, false);\n\t\t});\n\t\t// Add a star to the extra row since the \"extra\" is required if the box is shown\n\t\tadd_star(\"row_extra\");\n\t</script>';\n\n\t$page->output_footer();\n}\n\n// Delete Setting\nif($mybb->input['action'] == \"delete\")\n{\n\t$query = $db->simple_select(\"settings\", \"*\", \"sid='\".$mybb->get_input('sid', MyBB::INPUT_INT).\"'\");\n\t$setting = $db->fetch_array($query);\n\n\t// Does the setting not exist?\n\tif(empty($setting['sid']))\n\t{\n\t\tflash_message($lang->error_invalid_sid, 'error');\n\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t}\n\n\t// Prevent editing of default\n\tif($setting['isdefault'] == 1)\n\t{\n\t\tflash_message($lang->error_cannot_edit_default, 'error');\n\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t}\n\n\t// User clicked no\n\tif($mybb->get_input('no'))\n\t{\n\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t}\n\n\t$plugins->run_hooks(\"admin_config_settings_delete\");\n\n\tif($mybb->request_method == \"post\")\n\t{\n\t\t// Delete the setting\n\t\t$db->delete_query(\"settings\", \"sid='{$setting['sid']}'\");\n\n\t\trebuild_settings();\n\n\t\t$plugins->run_hooks(\"admin_config_settings_delete_commit\");\n\n\t\t// Log admin action\n\t\tlog_admin_action($setting['sid'], $setting['title']);\n\n\t\tflash_message($lang->success_setting_deleted, 'success');\n\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t}\n\telse\n\t{\n\t\t$page->output_confirm_action(\"index.php?module=config-settings&amp;action=delete&amp;sid={$setting['sid']}\", $lang->confirm_setting_deletion);\n\t}\n}\n\n// Modify Existing Settings\nif($mybb->input['action'] == \"manage\")\n{\n\t$plugins->run_hooks(\"admin_config_settings_manage\");\n\n\t// Update orders\n\tif($mybb->request_method == \"post\")\n\t{\n\t\tif(is_array($mybb->input['group_disporder']))\n\t\t{\n\t\t\tforeach($mybb->input['group_disporder'] as $gid => $new_order)\n\t\t\t{\n\t\t\t\t$gid = (int)$gid;\n\t\t\t\t$update_group = array('disporder' => (int)$new_order);\n\t\t\t\t$db->update_query(\"settinggroups\", $update_group, \"gid={$gid}\");\n\t\t\t}\n\t\t}\n\n\t\tif(is_array($mybb->input['setting_disporder']))\n\t\t{\n\t\t\tforeach($mybb->input['setting_disporder'] as $sid => $new_order)\n\t\t\t{\n\t\t\t\t$sid = (int)$sid;\n\t\t\t\t$update_setting = array('disporder' => (int)$new_order);\n\t\t\t\t$db->update_query(\"settings\", $update_setting, \"sid={$sid}\");\n\t\t\t}\n\t\t}\n\n\t\t$plugins->run_hooks(\"admin_config_settings_manage_commit\");\n\n\t\t// Log admin action\n\t\tlog_admin_action();\n\n\t\tflash_message($lang->success_display_orders_updated, 'success');\n\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t}\n\n\t$page->add_breadcrumb_item($lang->modify_existing_settings);\n\t$page->output_header($lang->board_settings.\" - \".$lang->modify_existing_settings);\n\n\t$sub_tabs['change_settings'] = array(\n\t\t'title' => $lang->change_settings,\n\t\t'link' => \"index.php?module=config-settings\",\n\t);\n\n\t$sub_tabs['add_setting'] = array(\n\t\t'title' => $lang->add_new_setting,\n\t\t'link' => \"index.php?module=config-settings&amp;action=add\"\n\t);\n\n\t$sub_tabs['add_setting_group'] = array(\n\t\t'title' => $lang->add_new_setting_group,\n\t\t'link' => \"index.php?module=config-settings&amp;action=addgroup\"\n\t);\n\n\t$sub_tabs['modify_setting'] = array(\n\t\t'title' => $lang->modify_existing_settings,\n\t\t'link' => \"index.php?module=config-settings&amp;action=manage\",\n\t\t'description' => $lang->modify_existing_settings_desc\n\t);\n\n\t$page->output_nav_tabs($sub_tabs, 'modify_setting');\n\n\t// Cache settings\n\t$settings_cache = array();\n\t$query = $db->simple_select(\"settings\", \"sid, name, title, disporder, gid, isdefault\", \"\", array('order_by' => 'disporder', 'order_dir' => 'asc'));\n\twhile($setting = $db->fetch_array($query))\n\t{\n\t\t$settings_cache[$setting['gid']][] = $setting;\n\t}\n\n\t$form = new Form(\"index.php?module=config-settings&amp;action=manage\", \"post\", \"edit\");\n\n\t$table = new Table;\n\n\t$table->construct_header($lang->setting_group_setting);\n\t$table->construct_header($lang->order, array('class' => 'align_center', 'style' => 'width: 5%'));\n\t$table->construct_header($lang->controls, array('class' => 'align_center', 'style' => 'width: 200px'));\n\n\t// Generate table\n\t$query = $db->simple_select(\"settinggroups\", \"*\", \"\", array('order_by' => 'disporder', 'order_dir' => 'asc'));\n\twhile($group = $db->fetch_array($query))\n\t{\n\t\t// Make setting group row\n\t\t// Translated?\n\t\t$group_lang_var = \"setting_group_{$group['name']}\";\n\t\tif(!empty($lang->$group_lang_var))\n\t\t{\n\t\t\t$group_title = htmlspecialchars_uni($lang->$group_lang_var);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$group_title = htmlspecialchars_uni($group['title']);\n\t\t}\n\t\t$table->construct_cell(\"<strong>{$group_title}</strong>\", array('id' => \"group{$group['gid']}\"));\n\t\t$table->construct_cell($form->generate_numeric_field(\"group_disporder[{$group['gid']}]\", $group['disporder'], array('style' => 'width: 80%; font-weight: bold', 'class' => 'align_center', 'min' => 0)));\n\t\t// Only show options if not a default setting group\n\t\tif($group['isdefault'] != 1)\n\t\t{\n\t\t\t$popup = new PopupMenu(\"group_{$group['gid']}\", $lang->options);\n\t\t\t$popup->add_item($lang->edit_setting_group, \"index.php?module=config-settings&amp;action=editgroup&amp;gid={$group['gid']}\");\n\t\t\t$popup->add_item($lang->delete_setting_group, \"index.php?module=config-settings&amp;action=deletegroup&amp;gid={$group['gid']}&amp;my_post_key={$mybb->post_code}\", \"return AdminCP.deleteConfirmation(this, '{$lang->confirm_setting_group_deletion}')\");\n\t\t\t$table->construct_cell($popup->fetch(), array('class' => 'align_center'));\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$table->construct_cell('');\n\t\t}\n\t\t$table->construct_row(array('class' => 'alt_row', 'no_alt_row' => 1));\n\n\t\t// Make rows for each setting in the group\n\t\tif(isset($settings_cache[$group['gid']]) && is_array($settings_cache[$group['gid']]))\n\t\t{\n\t\t\tforeach($settings_cache[$group['gid']] as $setting)\n\t\t\t{\n\t\t\t\t$setting_lang_var = \"setting_{$setting['name']}\";\n\t\t\t\tif(!empty($lang->$setting_lang_var))\n\t\t\t\t{\n\t\t\t\t\t$setting_title = htmlspecialchars_uni($lang->$setting_lang_var);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$setting_title = htmlspecialchars_uni($setting['title']);\n\t\t\t\t}\n\t\t\t\t$table->construct_cell($setting_title, array('style' => 'padding-left: 40px;'));\n\t\t\t\t$table->construct_cell($form->generate_numeric_field(\"setting_disporder[{$setting['sid']}]\", $setting['disporder'], array('style' => 'width: 80%', 'class' => 'align_center', 'min' => 0)));\n\t\t\t\t// Only show options if not a default setting group or is a custom setting\n\t\t\t\tif($group['isdefault'] != 1 || $setting['isdefault'] != 1)\n\t\t\t\t{\n\t\t\t\t\t$popup = new PopupMenu(\"setting_{$setting['sid']}\", $lang->options);\n\t\t\t\t\t$popup->add_item($lang->edit_setting, \"index.php?module=config-settings&amp;action=edit&amp;sid={$setting['sid']}\");\n\t\t\t\t\t$popup->add_item($lang->delete_setting, \"index.php?module=config-settings&amp;action=delete&amp;sid={$setting['sid']}&amp;my_post_key={$mybb->post_code}\", \"return AdminCP.deleteConfirmation(this, '{$lang->confirm_setting_deletion}')\");\n\t\t\t\t\t$table->construct_cell($popup->fetch(), array('class' => 'align_center'));\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$table->construct_cell('');\n\t\t\t\t}\n\t\t\t\t$table->construct_row(array('no_alt_row' => 1, 'class' => \"group{$group['gid']}\"));\n\t\t\t}\n\t\t}\n\t}\n\n\t$table->output($lang->modify_existing_settings);\n\n\t$buttons[] = $form->generate_submit_button($lang->save_display_orders);\n\t$form->output_submit_wrapper($buttons);\n\t$form->end();\n\n\t$page->output_footer();\n}\n\n// Change settings for a specified group.\nif($mybb->input['action'] == \"change\")\n{\n\t$plugins->run_hooks(\"admin_config_settings_change\");\n\n\tif($mybb->request_method == \"post\")\n\t{\n\t\tif(!is_writable(MYBB_ROOT.'inc/settings.php'))\n\t\t{\n\t\t\tflash_message($lang->error_chmod_settings_file, 'error');\n\t\t\tadmin_redirect(\"index.php?module=config-settings\");\n\t\t}\n\n\t\t// Not allowed to be hidden captcha fields\n\t\t$disallowed_fields = array(\n\t\t\t'username',\n\t\t\t'password',\n\t\t\t'password2',\n\t\t\t'email',\n\t\t\t'email2',\n\t\t\t'imagestring',\n\t\t\t'imagehash',\n\t\t\t'answer',\n\t\t\t'question_id',\n\t\t\t'allownotices',\n\t\t\t'hideemail',\n\t\t\t'receivepms',\n\t\t\t'pmnotice',\n\t\t\t'emailpmnotify',\n\t\t\t'invisible',\n\t\t\t'subscriptionmethod',\n\t\t\t'timezoneoffset',\n\t\t\t'dstcorrection',\n\t\t\t'language',\n\t\t\t'step',\n\t\t\t'action',\n\t\t\t'agree',\n\t\t\t'regtime',\n\t\t\t'regcheck1',\n\t\t\t'regcheck2',\n\t\t\t'regsubmit'\n\t\t);\n\n\t\t$is_current_hiddencaptcha_wrong = in_array($mybb->settings['hiddencaptchaimagefield'], $disallowed_fields);\n\t\tif(\n\t\t\t(isset($mybb->input['upsetting']['hiddencaptchaimagefield']) && in_array($mybb->input['upsetting']['hiddencaptchaimagefield'], $disallowed_fields)) ||\n\t\t\t$is_current_hiddencaptcha_wrong\n\t\t)\n\t\t{\n\t\t\tif(isset($mybb->input['upsetting']['hiddencaptchaimagefield']) && $mybb->input['upsetting']['hiddencaptchaimagefield'] != $mybb->settings['hiddencaptchaimagefield'] && !$is_current_hiddencaptcha_wrong)\n\t\t\t{\n\t\t\t\t$wrong_value = $mybb->input['upsetting']['hiddencaptchaimagefield'];\n\t\t\t\t$mybb->input['upsetting']['hiddencaptchaimagefield'] = $mybb->settings['hiddencaptchaimagefield'];\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$wrong_value = $mybb->settings['hiddencaptchaimagefield'];\n\t\t\t\t$mybb->input['upsetting']['hiddencaptchaimagefield'] = 'email3';\n\t\t\t}\n\n\t\t\t$lang->success_settings_updated .= $lang->sprintf($lang->success_settings_updated_hiddencaptchaimage, htmlspecialchars_uni($mybb->input['upsetting']['hiddencaptchaimagefield']), htmlspecialchars_uni($wrong_value));\n\t\t}\n\n\t\t// Validate avatar dimension inputs\n\t\t$gid = (int)$mybb->input['gid'];\n\t\t$dimfields = array(\n\t\t\t8 => array('postmaxavatarsize'),\n\t\t\t10 => array('useravatardims', 'maxavatardims'),\n\t\t\t13 => array('memberlistmaxavatarsize')\n\t\t);\n\t\tif(in_array($gid, array_keys($dimfields)))\n\t\t{\n\t\t\tforeach($dimfields[$gid] as $field)\n\t\t\t{\n\t\t\t\tif(isset($mybb->input['upsetting'][$field]))\n\t\t\t\t{\n\t\t\t\t\tif(preg_match(\"/\\b\\d+[|x]{1}\\d+\\b/i\", $mybb->input['upsetting'][$field]) || ($field == 'maxavatardims' && trim($mybb->input['upsetting'][$field]) == \"\"))\n\t\t\t\t\t{\n\t\t\t\t\t\t// If pipe (|) is used normalize to 'x'\n\t\t\t\t\t\t$mybb->input['upsetting'][$field] = str_replace('|', 'x', my_strtolower($mybb->input['upsetting'][$field]));\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tflash_message($lang->sprintf($lang->error_format_dimension, $lang->{'error_field_'.$field}), 'error');\n\t\t\t\t\t\tadmin_redirect(\"index.php?module=config-settings&action=change&gid=\".$gid);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Validate minnamelength, maxnamelength, minpasswordlength (complex and regular) and maxpasswordlength\n\t\tif ($gid == 9)\n\t\t{\n\t\t\tif (\n\t\t\t\tisset($mybb->input['upsetting']['minnamelength'], $mybb->input['upsetting']['maxnamelength']) &&\n\t\t\t\t$mybb->input['upsetting']['minnamelength'] > 0 && $mybb->input['upsetting']['maxnamelength'] > 0 &&\n\t\t\t\t$mybb->input['upsetting']['minnamelength'] > $mybb->input['upsetting']['maxnamelength'])\n\t\t\t{\n\t\t\t\tflash_message($lang->error_field_minnamelength, 'error');\n\t\t\t\tadmin_redirect(\"index.php?module=config-settings&action=change&gid=\".$gid);\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\tisset($mybb->input['upsetting']['minpasswordlength'], $mybb->input['upsetting']['maxpasswordlength']) &&\n\t\t\t\t$mybb->input['upsetting']['minpasswordlength'] > 0 && $mybb->input['upsetting']['maxpasswordlength'] > 0 &&\n\t\t\t\t$mybb->input['upsetting']['minpasswordlength'] > $mybb->input['upsetting']['maxpasswordlength']\n\t\t\t)\n\t\t\t{\n\t\t\t\tflash_message($lang->error_field_minpasswordlength, 'error');\n\t\t\t\tadmin_redirect(\"index.php?module=config-settings&action=change&gid=\".$gid);\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\tisset($mybb->input['upsetting']['minpasswordlength'], $mybb->input['upsetting']['requirecomplexpasswords']) &&\n\t\t\t\t$mybb->input['upsetting']['requirecomplexpasswords'] && $mybb->input['upsetting']['minpasswordlength'] < 3\n\t\t\t)\n\t\t\t{\n\t\t\t\tflash_message($lang->error_field_minpasswordlength_complex, 'error');\n\t\t\t\tadmin_redirect(\"index.php?module=config-settings&action=change&gid=\".$gid);\n\t\t\t}\n\t\t}\n\t\t\n\t\trequire_once MYBB_ROOT.'inc/class_captcha.php';\n\t\t\n\t\t// Have we opted for a reCAPTCHA or hCaptcha and not set a public/private key in input?\n\t\t$set_captcha_image = false;\n\t\tif(isset(\n\t\t\t$mybb->input['upsetting']['captchaimage'],\n\t\t\t$mybb->input['upsetting']['recaptchaprivatekey'],\n\t\t\t$mybb->input['upsetting']['recaptchapublickey'],\n\t\t\t$mybb->input['upsetting']['recaptchascore'],\n\t\t\t$mybb->input['upsetting']['hcaptchaprivatekey'],\n\t\t\t$mybb->input['upsetting']['hcaptchapublickey']\n\t\t))\n\t\t{\n\t\t\t$captchaimage = $mybb->input['upsetting']['captchaimage'];\n\t\t\t$recaptchaprivatekey = $mybb->input['upsetting']['recaptchaprivatekey'];\n\t\t\t$recaptchapublickey = $mybb->input['upsetting']['recaptchapublickey'];\n\t\t\t$recaptchascore = $mybb->input['upsetting']['recaptchascore'];\n\t\t\t$hcaptchaprivatekey = $mybb->input['upsetting']['hcaptchaprivatekey'];\n\t\t\t$hcaptchapublickey = $mybb->input['upsetting']['hcaptchapublickey'];\n\n\t\t\tif(in_array($captchaimage, array(captcha::NOCAPTCHA_RECAPTCHA, captcha::RECAPTCHA_INVISIBLE)) && (!$recaptchaprivatekey || !$recaptchapublickey))\n\t\t\t{\n\t\t\t\t$set_captcha_image = true;\n\t\t\t}\n\t\t\telse if(in_array($captchaimage, array(captcha::RECAPTCHA_V3)) && (!$recaptchaprivatekey || !$recaptchapublickey || !$recaptchascore))\n\t\t\t{\n\t\t\t\t$set_captcha_image = true;\n\t\t\t}\n\t\t\telse if(in_array($captchaimage, array(captcha::HCAPTCHA, captcha::HCAPTCHA_INVISIBLE)) && (!$hcaptchaprivatekey || !$hcaptchapublickey))\n\t\t\t{\n\t\t\t\t$set_captcha_image = true;\n\t\t\t}\n\t\t}\n\n\t\t//Checking settings for reCAPTCHA or hCaptcha and public/private key not set?\n\t\t$captchaimage = $mybb->settings['captchaimage'];\n\t\t$recaptchaprivatekey = $mybb->settings['recaptchaprivatekey'];\n\t\t$recaptchapublickey = $mybb->settings['recaptchapublickey'];\n\t\t$recaptchascore = $mybb->settings['recaptchascore'];\n\t\t$hcaptchaprivatekey = $mybb->settings['hcaptchaprivatekey'];\n\t\t$hcaptchapublickey = $mybb->settings['hcaptchapublickey'];\n\n\t\tif(in_array($captchaimage, array(captcha::NOCAPTCHA_RECAPTCHA, captcha::RECAPTCHA_INVISIBLE)) && (!$recaptchaprivatekey || !$recaptchapublickey))\n\t\t{\n\t\t\t$set_captcha_image = true;\n\t\t}\n\t\telse if(in_array($captchaimage, array(captcha::RECAPTCHA_V3)) && (!$recaptchaprivatekey || !$recaptchapublickey || !$recaptchascore))\n\t\t{\n\t\t\t$set_captcha_image = true;\n\t\t}\n\t\telse if(in_array($captchaimage, array(captcha::HCAPTCHA, captcha::HCAPTCHA_INVISIBLE)) && (!$hcaptchaprivatekey || !$hcaptchapublickey))\n\t\t{\n\t\t\t$set_captcha_image = true;\n\t\t}\n\t\tif($set_captcha_image){\n\t\t\t$mybb->input['upsetting']['captchaimage'] = captcha::DEFAULT_CAPTCHA;\n\t\t\t$lang->success_settings_updated .= $lang->success_settings_updated_captchaimage;\n\t\t}\n\n\t\t// If using fulltext then enforce minimum word length given by database\n\t\tif(isset($mybb->input['upsetting']['minsearchword']) && $mybb->input['upsetting']['minsearchword'] > 0 && $mybb->input['upsetting']['searchtype'] == \"fulltext\" && $db->supports_fulltext_boolean(\"posts\") && $db->supports_fulltext(\"threads\"))\n\t\t{\n\t\t\t// Attempt to determine minimum word length from MySQL for fulltext searches\n\t\t\t$query = $db->query(\"SHOW VARIABLES LIKE 'ft_min_word_len';\");\n\t\t\t$min_length = $db->fetch_field($query, 'Value');\n\t\t\tif(is_numeric($min_length) && $mybb->input['upsetting']['minsearchword'] < $min_length)\n\t\t\t{\n\t\t\t\t$mybb->input['upsetting']['minsearchword'] = $min_length;\n\t\t\t\t$lang->success_settings_updated .= $lang->success_settings_updated_minsearchword;\n\t\t\t}\n\t\t}\n\n\t\t// Get settings which optionscode is a forum/group select, checkbox or numeric\n\t\t// We cannot rely on user input to decide this\n\t\t$checkbox_settings = $forum_group_select = $prefix_select = array();\n\t\t$query = $db->simple_select('settings', 'name, optionscode', \"optionscode IN('forumselect', 'groupselect', 'prefixselect') OR optionscode LIKE 'checkbox%' OR optionscode LIKE 'numeric%'\");\n\n\t\twhile($multisetting = $db->fetch_array($query))\n\t\t{\n\t\t\t$options = array();\n\n\t\t\tif(substr($multisetting['optionscode'], 0, 8) == 'checkbox')\n\t\t\t{\n\t\t\t\t$checkbox_settings[] = $multisetting['name'];\n\n\t\t\t\t// All checkboxes deselected = no $mybb->input['upsetting'] for them, we need to initialize it manually then, but only on pages where the setting is shown\n\t\t\t\tif(empty($mybb->input['upsetting'][$multisetting['name']]) && isset($mybb->input[\"isvisible_{$multisetting['name']}\"]))\n\t\t\t\t{\n\t\t\t\t\t$mybb->input['upsetting'][$multisetting['name']] = array();\n\t\t\t\t}\n\t\t\t}\n\t\t\telseif(substr($multisetting['optionscode'], 0, 7) == 'numeric')\n\t\t\t{\n\t\t\t\tif(isset($mybb->input['upsetting'][$multisetting['name']]))\n\t\t\t\t{\n\t\t\t\t\t$type = explode(\"\\n\", $multisetting['optionscode']);\n\t\t\t\t\tfor($i=1; $i < count($type); $i++)\n\t\t\t\t\t{\n\t\t\t\t\t\t$optionsexp = explode(\"=\", $type[$i]);\n\t\t\t\t\t\t$opt = array_map('trim', $optionsexp);\n\t\t\t\t\t\tif(in_array($opt[0], array('min', 'max', 'step')))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif($opt[0] != 'step' || $opt[1] != 'any')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$opt[1] = (float)$opt[1];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t$options[$opt[0]] = $opt[1];\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t$value = (float)$mybb->input['upsetting'][$multisetting['name']];\n\n\t\t\t\t\tif(isset($options['min']))\n\t\t\t\t\t{\n\t\t\t\t\t\t$value = max($value, $options['min']);\n\t\t\t\t\t}\n\n\t\t\t\t\tif(isset($options['max']))\n\t\t\t\t\t{\n\t\t\t\t\t\t$value = min($value, $options['max']);\n\t\t\t\t\t}\n\n\t\t\t\t\t$mybb->input['upsetting'][$multisetting['name']] = $value;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$forum_group_select[] = $multisetting['name'];\n\t\t\t}\n\t\t}\n\n\t\t// Verify for admin email that can't be empty\n\t\tif(isset($mybb->input['upsetting']['adminemail']) && !validate_email_format($mybb->input['upsetting']['adminemail']))\n\t\t{\n\t\t\tunset($mybb->input['upsetting']['adminemail']);\n\t\t\t$lang->success_settings_updated .= $lang->error_admin_email_settings_empty;\n\t\t}\n\n\t\t// Administrator is changing the login method.\n\t\tif(isset($mybb->input['upsetting']['username_method']) && (int)$mybb->input['upsetting']['username_method'] > 0)\n\t\t{\n\t\t\tif((int)$mybb->settings['allowmultipleemails'] == 1)\n\t\t\t{\n\t\t\t\t$mybb->input['upsetting']['username_method'] = 0;\n\t\t\t\t$lang->success_settings_updated .= $lang->success_settings_updated_username_method_conflict;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$query = $db->simple_select('users', 'email', \"email != ''\", array('group_by' => 'email HAVING COUNT(email)>1'));\n\t\t\t\tif($db->num_rows($query))\n\t\t\t\t{\n\t\t\t\t\t$mybb->input['upsetting']['username_method'] = 0;\n\t\t\t\t\t$lang->success_settings_updated .= $lang->success_settings_updated_username_method;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif(isset($mybb->input['upsetting']['username_method'], $mybb->input['upsetting']['allowmultipleemails']))\n\t\t{\n\t\t\t// Administrator is changing registration email allowance\n\t\t\tif((int)$mybb->settings['username_method'] > 0 && (int)$mybb->input['upsetting']['allowmultipleemails'] !== 0)\n\t\t\t{\n\t\t\t\t$mybb->input['upsetting']['allowmultipleemails'] = 0;\n\t\t\t\t$lang->success_settings_updated .= $lang->success_settings_updated_allowmultipleemails;\n\t\t\t}\n\n\t\t\t// Reset conflict silently, if by chance\n\t\t\tif((int)$mybb->settings['username_method'] > 0 && (int)$mybb->settings['allowmultipleemails'] == 1)\n\t\t\t{\n\t\t\t\t$mybb->input['upsetting']['allowmultipleemails'] = 0;\n\t\t\t}\n\t\t}\n\n\t\t// reject dangerous/unsupported upload paths\n\t\t$fields = array(\n\t\t\t'uploadspath',\n\t\t\t'cdnpath',\n\t\t\t'avataruploadpath',\n\t\t);\n\n\t\t$dynamic_include_directories = array(\n\t\t\tMYBB_ROOT.'cache/',\n\t\t\tMYBB_ROOT.'inc/plugins/',\n\t\t\tMYBB_ROOT.'inc/languages/',\n\t\t\tMYBB_ROOT.'inc/tasks/',\n\t\t);\n\t\t$dynamic_include_directories_realpath = array_map('realpath', $dynamic_include_directories);\n\n\t\tforeach($fields as $field)\n\t\t{\n\t\t\tif(isset($mybb->input['upsetting'][$field]))\n\t\t\t{\n\t\t\t\tif(\n\t\t\t\t\tis_string($mybb->input['upsetting'][$field]) &&\n\t\t\t\t\tstrpos($mybb->input['upsetting'][$field], '://') !== false)\n\t\t\t\t{\n\t\t\t\t\tunset($mybb->input['upsetting'][$field]);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\t$realpath = realpath(mk_path_abs($mybb->input['upsetting'][$field]));\n\n\t\t\t\tif ($realpath === false)\n\t\t\t\t{\n\t\t\t\t\tunset($mybb->input['upsetting'][$field]);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tforeach ($dynamic_include_directories_realpath as $forbidden_realpath)\n\t\t\t\t{\n\t\t\t\t\tif ($realpath === $forbidden_realpath || strpos($realpath, $forbidden_realpath.DIRECTORY_SEPARATOR) === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tunset($mybb->input['upsetting'][$field]);\n\t\t\t\t\t\tcontinue 2;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\n\t\tif(is_array($mybb->input['upsetting']))\n\t\t{\n\t\t\tforeach($mybb->input['upsetting'] as $name => $value)\n\t\t\t{\n\t\t\t\tif($forum_group_select && in_array($name, $forum_group_select))\n\t\t\t\t{\n\t\t\t\t\tif($value == 'all')\n\t\t\t\t\t{\n\t\t\t\t\t\t$value = -1;\n\t\t\t\t\t}\n\t\t\t\t\telseif($value == 'custom')\n\t\t\t\t\t{\n\t\t\t\t\t\tif(isset($mybb->input['select'][$name]) && is_array($mybb->input['select'][$name]))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tforeach($mybb->input['select'][$name] as &$val)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$val = (int)$val;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tunset($val);\n\n\t\t\t\t\t\t\t$value = implode(',', $mybb->input['select'][$name]);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$value = '';\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t$value = '';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telseif($checkbox_settings && in_array($name, $checkbox_settings))\n\t\t\t\t{\n\t\t\t\t\t$value = '';\n\n\t\t\t\t\tif(is_array($mybb->input['upsetting'][$name]))\n\t\t\t\t\t{\n\t\t\t\t\t\t$value = implode(',', $mybb->input['upsetting'][$name]);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t$db->update_query(\"settings\", array('value' => $db->escape_string($value)), \"name='\".$db->escape_string($name).\"'\");\n\t\t\t}\n\t\t}\n\n\t\t// Check if we need to create our fulltext index after changing the search mode\n\t\tif(\n\t\t\tisset($mybb->input['upsetting']['searchtype']) &&\n\t\t\t$mybb->settings['searchtype'] != $mybb->input['upsetting']['searchtype'] &&\n\t\t\t$mybb->input['upsetting']['searchtype'] == \"fulltext\"\n\t\t)\n\t\t{\n\t\t\tif(!$db->is_fulltext(\"posts\") && $db->supports_fulltext_boolean(\"posts\"))\n\t\t\t{\n\t\t\t\t$db->create_fulltext_index(\"posts\", \"message\");\n\t\t\t}\n\t\t\tif(!$db->is_fulltext(\"threads\") && $db->supports_fulltext(\"threads\"))\n\t\t\t{\n\t\t\t\t$db->create_fulltext_index(\"threads\", \"subject\");\n\t\t\t}\n\t\t}\n\n\t\t// If the delayedthreadviews setting was changed, enable or disable the tasks for it.\n\t\tif(isset($mybb->input['upsetting']['delayedthreadviews']) && $mybb->settings['delayedthreadviews'] != $mybb->input['upsetting']['delayedthreadviews'])\n\t\t{\n\t\t\t$db->update_query(\"tasks\", array('enabled' => (int)$mybb->input['upsetting']['delayedthreadviews']), \"file='threadviews'\");\n\t\t}\n\n\t\t// Have we changed our cookie prefix? If so, update our adminsid so we're not logged out\n\t\tif(isset($mybb->input['upsetting']['cookieprefix']) && $mybb->input['upsetting']['cookieprefix'] != $mybb->settings['cookieprefix'])\n\t\t{\n\t\t\tmy_unsetcookie(\"adminsid\");\n\t\t\t$mybb->settings['cookieprefix'] = $mybb->input['upsetting']['cookieprefix'];\n\t\t\tmy_setcookie(\"adminsid\", $admin_session['sid'], '', true, \"lax\");\n\t\t}\n\n\t\tif(isset($mybb->input['upsetting']['statstopreferrer']) && $mybb->input['upsetting']['statstopreferrer'] != $mybb->settings['statstopreferrer'])\n\t\t{\n\t\t\t$cache->update_statistics();\n\t\t}\n\n\t\t$statslimit = $mybb->settings['statslimit'];\n\n\t\trebuild_settings();\n\n\t\tif(isset($mybb->input['upsetting']['statslimit']) && $mybb->input['upsetting']['statslimit'] != $statslimit)\n\t\t{\n\t\t\t$cache->update_most_replied_threads();\n\t\t\t$cache->update_most_viewed_threads();\n\t\t}\n\n\t\t$plugins->run_hooks(\"admin_config_settings_change_commit\");\n\n\t\t// Log admin action\n\t\tlog_admin_action();\n\n\t\tflash_message($lang->success_settings_updated, 'success');\n\t\tadmin_redirect(\"index.php?module=config-settings\");\n\t}\n\n\t// What type of page\n\t$cache_groups = $cache_settings = array();\n\tif(isset($mybb->input['search']))\n\t{\n\t\t// Search\n\n\t\t// Search for settings\n\t\t$search = trim($mybb->input['search']);\n\t\tif(!empty($search))\n\t\t{\n\t\t\t$query = $db->query(\"\n\t\t\t\tSELECT s.* , g.name as gname, g.title as gtitle, g.description as gdescription\n\t\t\t\tFROM \".TABLE_PREFIX.\"settings s\n\t\t\t\tLEFT JOIN \".TABLE_PREFIX.\"settinggroups g ON(s.gid=g.gid)\n\t\t\t\tORDER BY s.disporder\n\t\t\t\");\n\t\t\twhile($setting = $db->fetch_array($query))\n\t\t\t{\n\t\t\t\t$search_in = $setting['name'] . ' ' . $setting['title'] . ' ' . $setting['description'] . ' ' . $setting['gname'] . ' ' . $setting['gtitle'] . ' ' . $setting['gdescription'];\n\t\t\t\tforeach(array(\"setting_{$setting['name']}\", \"setting_{$setting['name']}_desc\", \"setting_group_{$setting['gname']}\", \"setting_group_{$setting['gname']}_desc\") as $search_in_lang_key)\n\t\t\t\t{\n\t\t\t\t\tif(!empty($lang->$search_in_lang_key))\n\t\t\t\t\t{\n\t\t\t\t\t\t$search_in .= ' ' . $lang->$search_in_lang_key;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif(my_stripos($search_in, $search) !== false)\n\t\t\t\t{\n\t\t\t\t\t$cache_settings[$setting['gid']][$setting['sid']] = $setting;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif(!count($cache_settings))\n\t\t{\n\t\t\tif(isset($mybb->input['ajax_search']))\n\t\t\t{\n\t\t\t\techo json_encode(array(\"errors\" => array($lang->error_no_settings_found)));\n\t\t\t\texit;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tflash_message($lang->error_no_settings_found, 'error');\n\t\t\t\tadmin_redirect(\"index.php?module=config-settings\");\n\t\t\t}\n\t\t}\n\n\t\t// Cache groups\n\t\t$groups = array_keys($cache_settings);\n\t\t$groups = implode(',', $groups);\n\t\t$query = $db->simple_select(\"settinggroups\", \"*\", \"gid IN ({$groups})\", array('order_by' => 'disporder'));\n\t\twhile($group = $db->fetch_array($query))\n\t\t{\n\t\t\t$cache_groups[$group['gid']] = $group;\n\t\t}\n\n\t\t// Page header only if not AJAX\n\t\tif(!isset($mybb->input['ajax_search']))\n\t\t{\n\t\t\t$page->add_breadcrumb_item($lang->settings_search);\n\t\t\t$page->output_header($lang->board_settings.\" - {$lang->settings_search}\");\n\t\t}\n\t}\n\telseif(($mybb->get_input('gid')))\n\t{\n\t\t// Group listing\n\t\t// Cache groups\n\t\t$query = $db->simple_select(\"settinggroups\", \"*\", \"gid = '\".$mybb->get_input('gid', MyBB::INPUT_INT).\"'\");\n\t\t$groupinfo = $db->fetch_array($query);\n\t\t$cache_groups[$groupinfo['gid']] = $groupinfo;\n\n\t\tif(!$db->num_rows($query))\n\t\t{\n\t\t\t$page->output_error($lang->error_invalid_gid2);\n\t\t}\n\n\t\t// Cache settings\n\t\t$query = $db->simple_select(\"settings\", \"*\", \"gid='\".$mybb->get_input('gid', MyBB::INPUT_INT).\"'\", array('order_by' => 'disporder'));\n\t\twhile($setting = $db->fetch_array($query))\n\t\t{\n\t\t\t$cache_settings[$setting['gid']][$setting['sid']] = $setting;\n\t\t}\n\n\t\tif(!$db->num_rows($query))\n\t\t{\n\t\t\tflash_message($lang->error_no_settings_found, 'error');\n\t\t\tadmin_redirect(\"index.php?module=config-settings\");\n\t\t}\n\n\t\t$group_lang_var = \"setting_group_{$groupinfo['name']}\";\n\t\tif(isset($lang->$group_lang_var))\n\t\t{\n\t\t\t$groupinfo['title'] = $lang->$group_lang_var;\n\t\t}\n\n\t\t// Page header\n\t\t$page->add_breadcrumb_item($groupinfo['title']);\n\t\t$page->output_header($lang->board_settings.\" - {$groupinfo['title']}\");\n\t}\n\telse\n\t{\n\t\t// All settings list\n\t\t// Cache groups\n\t\t$query = $db->simple_select(\"settinggroups\", \"*\", \"\", array('order_by' => 'disporder'));\n\t\twhile($group = $db->fetch_array($query))\n\t\t{\n\t\t\t$cache_groups[$group['gid']] = $group;\n\t\t}\n\n\t\tif(!$db->num_rows($query))\n\t\t{\n\t\t\t$page->output_error($lang->error_invalid_gid2);\n\t\t}\n\n\t\t// Cache settings\n\t\t$query = $db->simple_select(\"settings\", \"*\", \"\", array('order_by' => 'disporder'));\n\t\twhile($setting = $db->fetch_array($query))\n\t\t{\n\t\t\t$cache_settings[$setting['gid']][$setting['sid']] = $setting;\n\t\t}\n\n\t\t// Page header\n\t\t$page->add_breadcrumb_item($lang->show_all_settings);\n\t\t$page->output_header($lang->board_settings.\" - {$lang->show_all_settings}\");\n\t}\n\n\t// Build individual forms as per settings group\n\tforeach($cache_groups as $groupinfo)\n\t{\n\t\t$form = new Form(\"index.php?module=config-settings&amp;action=change\", \"post\", \"change\");\n\t\techo $form->generate_hidden_field(\"gid\", $groupinfo['gid']);\n\t\t$buttons = array($form->generate_submit_button($lang->save_settings));\n\t\t$group_lang_var = \"setting_group_{$groupinfo['name']}\";\n\t\tif(isset($lang->$group_lang_var))\n\t\t{\n\t\t\t$groupinfo['title'] = $lang->$group_lang_var;\n\t\t}\n\n\t\t$form_container = new FormContainer($groupinfo['title']);\n\n\t\tif(empty($cache_settings[$groupinfo['gid']]))\n\t\t{\n\t\t\t$form_container->output_cell($lang->error_no_settings_found);\n\t\t\t$form_container->construct_row();\n\n\t\t\t$form_container->end();\n\t\t\techo '<br />';\n\n\t\t\tcontinue;\n\t\t}\n\n\t\tforeach($cache_settings[$groupinfo['gid']] as $setting)\n\t\t{\n\t\t\t$options = \"\";\n\t\t\t$type = explode(\"\\n\", $setting['optionscode']);\n\t\t\t$type[0] = trim($type[0]);\n\t\t\t$element_name = \"upsetting[{$setting['name']}]\";\n\t\t\t$element_id = \"setting_{$setting['name']}\";\n\t\t\tif($type[0] == \"text\" || $type[0] == \"\")\n\t\t\t{\n\t\t\t\t$setting_code = $form->generate_text_box($element_name, $setting['value'], array('id' => $element_id));\n\t\t\t}\n\t\t\telse if($type[0] == \"numeric\")\n\t\t\t{\n\t\t\t\t$field_options = array('id' => $element_id);\n\t\t\t\tif(count($type) > 1)\n\t\t\t\t{\n\t\t\t\t\tfor($i=1; $i < count($type); $i++)\n\t\t\t\t\t{\n\t\t\t\t\t\t$optionsexp = explode(\"=\", $type[$i]);\n\t\t\t\t\t\t$opt = array_map('trim', $optionsexp);\n\t\t\t\t\t\tif(in_array($opt[0], array('min', 'max', 'step')))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif($opt[0] != 'step' || $opt[1] != 'any')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$opt[1] = (float)$opt[1];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t$field_options[$opt[0]] = $opt[1];\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t$setting_code = $form->generate_numeric_field($element_name, $setting['value'], $field_options);\n\t\t\t}\n\t\t\telse if($type[0] == \"textarea\")\n\t\t\t{\n\t\t\t\t$setting_code = $form->generate_text_area($element_name, $setting['value'], array('id' => $element_id));\n\t\t\t}\n\t\t\telse if($type[0] == \"yesno\")\n\t\t\t{\n\t\t\t\t$setting_code = $form->generate_yes_no_radio($element_name, $setting['value'], true, array('id' => $element_id.'_yes', 'class' => $element_id), array('id' => $element_id.'_no', 'class' => $element_id));\n\t\t\t}\n\t\t\telse if($type[0] == \"onoff\")\n\t\t\t{\n\t\t\t\t$setting_code = $form->generate_on_off_radio($element_name, $setting['value'], true, array('id' => $element_id.'_on', 'class' => $element_id), array('id' => $element_id.'_off', 'class' => $element_id));\n\t\t\t}\n\t\t\telse if($type[0] == \"cpstyle\")\n\t\t\t{\n\t\t\t\t$dir = @opendir(MYBB_ROOT.$config['admin_dir'].\"/styles\");\n\n\t\t\t\t$folders = array();\n\t\t\t\twhile($folder = readdir($dir))\n\t\t\t\t{\n\t\t\t\t\tif($folder != \".\" && $folder != \"..\" && @file_exists(MYBB_ROOT.$config['admin_dir'].\"/styles/$folder/main.css\"))\n\t\t\t\t\t{\n\t\t\t\t\t\t$folders[$folder] = ucfirst($folder);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tclosedir($dir);\n\t\t\t\tksort($folders);\n\t\t\t\t$setting_code = $form->generate_select_box($element_name, $folders, $setting['value'], array('id' => $element_id));\n\t\t\t}\n\t\t\telse if($type[0] == \"language\")\n\t\t\t{\n\t\t\t\t$languages = $lang->get_languages();\n\t\t\t\t$setting_code = $form->generate_select_box($element_name, $languages, $setting['value'], array('id' => $element_id));\n\t\t\t}\n\t\t\telse if($type[0] == \"adminlanguage\")\n\t\t\t{\n\t\t\t\t$languages = $lang->get_languages(1);\n\t\t\t\t$setting_code = $form->generate_select_box($element_name, $languages, $setting['value'], array('id' => $element_id));\n\t\t\t}\n\t\t\telse if($type[0] == \"passwordbox\")\n\t\t\t{\n\t\t\t\t$setting_code = $form->generate_password_box($element_name, $setting['value'], array('id' => $element_id));\n\t\t\t}\n\t\t\telse if($type[0] == \"php\")\n\t\t\t{\n\t\t\t\t$setting['optionscode'] = substr($setting['optionscode'], 3);\n\t\t\t\teval(\"\\$setting_code = \\\"\".$setting['optionscode'].\"\\\";\");\n\t\t\t}\n\t\t\telse if($type[0] == \"forumselect\")\n\t\t\t{\n\t\t\t\t$selected_values = '';\n\t\t\t\tif($setting['value'] != '' && $setting['value'] != -1)\n\t\t\t\t{\n\t\t\t\t\t$selected_values = explode(',', (string)$setting['value']);\n\n\t\t\t\t\tforeach($selected_values as &$value)\n\t\t\t\t\t{\n\t\t\t\t\t\t$value = (int)$value;\n\t\t\t\t\t}\n\t\t\t\t\tunset($value);\n\t\t\t\t}\n\n\t\t\t\t$forum_checked = array('all' => '', 'custom' => '', 'none' => '');\n\t\t\t\tif($setting['value'] == -1)\n\t\t\t\t{\n\t\t\t\t\t$forum_checked['all'] = 'checked=\"checked\"';\n\t\t\t\t}\n\t\t\t\telseif($setting['value'] != '')\n\t\t\t\t{\n\t\t\t\t\t$forum_checked['custom'] = 'checked=\"checked\"';\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$forum_checked['none'] = 'checked=\"checked\"';\n\t\t\t\t}\n\n\t\t\t\tprint_selection_javascript();\n\n\t\t\t\t$setting_code = \"\n\t\t\t\t<dl style=\\\"margin-top: 0; margin-bottom: 0; width: 100%\\\">\n\t\t\t\t\t<dt><label style=\\\"display: block;\\\"><input type=\\\"radio\\\" name=\\\"{$element_name}\\\" value=\\\"all\\\" {$forum_checked['all']} class=\\\"{$element_id}_forums_groups_check\\\" onclick=\\\"checkAction('{$element_id}');\\\" style=\\\"vertical-align: middle;\\\" /> <strong>{$lang->all_forums}</strong></label></dt>\n\t\t\t\t\t<dt><label style=\\\"display: block;\\\"><input type=\\\"radio\\\" name=\\\"{$element_name}\\\" value=\\\"custom\\\" {$forum_checked['custom']} class=\\\"{$element_id}_forums_groups_check\\\" onclick=\\\"checkAction('{$element_id}');\\\" style=\\\"vertical-align: middle;\\\" /> <strong>{$lang->select_forums}</strong></label></dt>\n\t\t\t\t\t<dd style=\\\"margin-top: 4px;\\\" id=\\\"{$element_id}_forums_groups_custom\\\" class=\\\"{$element_id}_forums_groups\\\">\n\t\t\t\t\t\t<table cellpadding=\\\"4\\\">\n\t\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t\t<td valign=\\\"top\\\"><small>{$lang->forums_colon}</small></td>\n\t\t\t\t\t\t\t\t<td>\".$form->generate_forum_select('select['.$setting['name'].'][]', $selected_values, array('id' => $element_id, 'multiple' => true, 'size' => 5)).\"</td>\n\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t</table>\n\t\t\t\t\t</dd>\n\t\t\t\t\t<dt><label style=\\\"display: block;\\\"><input type=\\\"radio\\\" name=\\\"{$element_name}\\\" value=\\\"none\\\" {$forum_checked['none']} class=\\\"{$element_id}_forums_groups_check\\\" onclick=\\\"checkAction('{$element_id}');\\\" style=\\\"vertical-align: middle;\\\" /> <strong>{$lang->none}</strong></label></dt>\n\t\t\t\t</dl>\n\t\t\t\t<script type=\\\"text/javascript\\\">\n\t\t\t\t\tcheckAction('{$element_id}');\n\t\t\t\t</script>\";\n\t\t\t}\n\t\t\telse if($type[0] == \"forumselectsingle\")\n\t\t\t{\n\t\t\t\t$selected_value = (int)$setting['value']; // No need to check if empty, int will give 0\n\t\t\t\t$setting_code = $form->generate_forum_select($element_name, $selected_value, array('id' => $element_id, 'main_option' => $lang->none));\n\t\t\t}\n\t\t\telse if($type[0] == \"groupselect\")\n\t\t\t{\n\t\t\t\t$selected_values = '';\n\t\t\t\tif($setting['value'] != '' && $setting['value'] != -1)\n\t\t\t\t{\n\t\t\t\t\t$selected_values = explode(',', (string)$setting['value']);\n\n\t\t\t\t\tforeach($selected_values as &$value)\n\t\t\t\t\t{\n\t\t\t\t\t\t$value = (int)$value;\n\t\t\t\t\t}\n\t\t\t\t\tunset($value);\n\t\t\t\t}\n\n\t\t\t\t$group_checked = array('all' => '', 'custom' => '', 'none' => '');\n\t\t\t\tif($setting['value'] == -1)\n\t\t\t\t{\n\t\t\t\t\t$group_checked['all'] = 'checked=\"checked\"';\n\t\t\t\t}\n\t\t\t\telseif($setting['value'] != '')\n\t\t\t\t{\n\t\t\t\t\t$group_checked['custom'] = 'checked=\"checked\"';\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$group_checked['none'] = 'checked=\"checked\"';\n\t\t\t\t}\n\n\t\t\t\tprint_selection_javascript();\n\n\t\t\t\t$setting_code = \"\n\t\t\t\t<dl style=\\\"margin-top: 0; margin-bottom: 0; width: 100%\\\">\n\t\t\t\t\t<dt><label style=\\\"display: block;\\\"><input type=\\\"radio\\\" name=\\\"{$element_name}\\\" value=\\\"all\\\" {$group_checked['all']} class=\\\"{$element_id}_forums_groups_check\\\" onclick=\\\"checkAction('{$element_id}');\\\" style=\\\"vertical-align: middle;\\\" /> <strong>{$lang->all_groups}</strong></label></dt>\n\t\t\t\t\t<dt><label style=\\\"display: block;\\\"><input type=\\\"radio\\\" name=\\\"{$element_name}\\\" value=\\\"custom\\\" {$group_checked['custom']} class=\\\"{$element_id}_forums_groups_check\\\" onclick=\\\"checkAction('{$element_id}');\\\" style=\\\"vertical-align: middle;\\\" /> <strong>{$lang->select_groups}</strong></label></dt>\n\t\t\t\t\t<dd style=\\\"margin-top: 4px;\\\" id=\\\"{$element_id}_forums_groups_custom\\\" class=\\\"{$element_id}_forums_groups\\\">\n\t\t\t\t\t\t<table cellpadding=\\\"4\\\">\n\t\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t\t<td valign=\\\"top\\\"><small>{$lang->groups_colon}</small></td>\n\t\t\t\t\t\t\t\t<td>\".$form->generate_group_select('select['.$setting['name'].'][]', $selected_values, array('id' => $element_id, 'multiple' => true, 'size' => 5)).\"</td>\n\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t</table>\n\t\t\t\t\t</dd>\n\t\t\t\t\t<dt><label style=\\\"display: block;\\\"><input type=\\\"radio\\\" name=\\\"{$element_name}\\\" value=\\\"none\\\" {$group_checked['none']} class=\\\"{$element_id}_forums_groups_check\\\" onclick=\\\"checkAction('{$element_id}');\\\" style=\\\"vertical-align: middle;\\\" /> <strong>{$lang->none}</strong></label></dt>\n\t\t\t\t</dl>\n\t\t\t\t<script type=\\\"text/javascript\\\">\n\t\t\t\t\tcheckAction('{$element_id}');\n\t\t\t\t</script>\";\n\t\t\t}\n\t\t\telse if($type[0] == \"groupselectsingle\")\n\t\t\t{\n\t\t\t\t$selected_value = (int)$setting['value']; // No need to check if empty, int will give 0\n\t\t\t\t$setting_code = $form->generate_group_select($element_name, $selected_value, array('id' => $element_id, 'main_option' => $lang->none));\n\t\t\t}\n\t\t\telse if($type[0] == \"prefixselect\")\n\t\t\t{\n\t\t\t\t$selected_values = '';\n\t\t\t\tif($setting['value'] != '' && $setting['value'] != -1)\n\t\t\t\t{\n\t\t\t\t\t$selected_values = explode(',', (string)$setting['value']);\n\t\t\t\t\tforeach($selected_values as &$value)\n\t\t\t\t\t{\n\t\t\t\t\t\t$value = (int)$value;\n\t\t\t\t\t}\n\t\t\t\t\tunset($value);\n\t\t\t\t}\n\t\t\t\t$prefix_checked = array('all' => '', 'custom' => '', 'none' => '');\n\t\t\t\tif($setting['value'] == -1)\n\t\t\t\t{\n\t\t\t\t\t$prefix_checked['all'] = 'checked=\"checked\"';\n\t\t\t\t}\n\t\t\t\telseif($setting['value'] != '')\n\t\t\t\t{\n\t\t\t\t\t$prefix_checked['custom'] = 'checked=\"checked\"';\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$prefix_checked['none'] = 'checked=\"checked\"';\n\t\t\t\t}\n\t\t\t\tprint_selection_javascript();\n\t\t\t\t$setting_code = \"\n\t\t\t\t<dl style=\\\"margin-top: 0; margin-bottom: 0; width: 100%\\\">\n\t\t\t\t\t<dt><label style=\\\"display: block;\\\"><input type=\\\"radio\\\" name=\\\"{$element_name}\\\" value=\\\"all\\\" {$prefix_checked['all']} class=\\\"{$element_id}_forums_groups_check\\\" onclick=\\\"checkAction('{$element_id}');\\\" style=\\\"vertical-align: middle;\\\" /> <strong>{$lang->all_prefix}</strong></label></dt>\n\t\t\t\t\t<dt><label style=\\\"display: block;\\\"><input type=\\\"radio\\\" name=\\\"{$element_name}\\\" value=\\\"custom\\\" {$prefix_checked['custom']} class=\\\"{$element_id}_forums_groups_check\\\" onclick=\\\"checkAction('{$element_id}');\\\" style=\\\"vertical-align: middle;\\\" /> <strong>{$lang->select_prefix}</strong></label></dt>\n\t\t\t\t\t<dd style=\\\"margin-top: 4px;\\\" id=\\\"{$element_id}_forums_groups_custom\\\" class=\\\"{$element_id}_forums_groups\\\">\n\t\t\t\t\t\t<table cellpadding=\\\"4\\\">\n\t\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t\t<td valign=\\\"top\\\"><small>{$lang->prefix_colon}</small></td>\n\t\t\t\t\t\t\t\t<td>\".$form->generate_prefix_select('select['.$setting['name'].'][]', $selected_values, array('id' => $element_id, 'multiple' => true, 'size' => 5)).\"</td>\n\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t</table>\n\t\t\t\t\t</dd>\n\t\t\t\t\t<dt><label style=\\\"display: block;\\\"><input type=\\\"radio\\\" name=\\\"{$element_name}\\\" value=\\\"none\\\" {$prefix_checked['none']} class=\\\"{$element_id}_forums_groups_check\\\" onclick=\\\"checkAction('{$element_id}');\\\" style=\\\"vertical-align: middle;\\\" /> <strong>{$lang->none}</strong></label></dt>\n\t\t\t\t</dl>\n\t\t\t\t<script type=\\\"text/javascript\\\">\n\t\t\t\t\tcheckAction('{$element_id}');\n\t\t\t\t</script>\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$typecount = count($type);\n\n\t\t\t\tif($type[0] == 'checkbox')\n\t\t\t\t{\n\t\t\t\t\t$multivalue = explode(',', $setting['value']);\n\t\t\t\t}\n\n\t\t\t\tfor($i = 0; $i < $typecount; $i++)\n\t\t\t\t{\n\t\t\t\t\t$optionsexp = explode(\"=\", $type[$i]);\n\t\t\t\t\tif(!isset($optionsexp[1]))\n\t\t\t\t\t{\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t\t$title_lang = \"setting_{$setting['name']}_{$optionsexp[0]}\";\n\t\t\t\t\tif(isset($lang->$title_lang))\n\t\t\t\t\t{\n\t\t\t\t\t\t$optionsexp[1] = $lang->$title_lang;\n\t\t\t\t\t}\n\n\t\t\t\t\tif($type[0] == \"select\")\n\t\t\t\t\t{\n\t\t\t\t\t\t$option_list[$optionsexp[0]] = htmlspecialchars_uni($optionsexp[1]);\n\t\t\t\t\t}\n\t\t\t\t\telse if($type[0] == \"radio\")\n\t\t\t\t\t{\n\t\t\t\t\t\tif($setting['value'] == $optionsexp[0])\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$option_list[$i] = $form->generate_radio_button($element_name, $optionsexp[0], htmlspecialchars_uni($optionsexp[1]), array('id' => $element_id.'_'.$i, \"checked\" => 1, 'class' => $element_id));\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$option_list[$i] = $form->generate_radio_button($element_name, $optionsexp[0], htmlspecialchars_uni($optionsexp[1]), array('id' => $element_id.'_'.$i, 'class' => $element_id));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse if($type[0] == \"checkbox\")\n\t\t\t\t\t{\n\t\t\t\t\t\tif(in_array($optionsexp[0], $multivalue))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$option_list[$i] = $form->generate_check_box(\"{$element_name}[]\", $optionsexp[0], htmlspecialchars_uni($optionsexp[1]), array('id' => $element_id.'_'.$i, \"checked\" => 1, 'class' => $element_id));\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$option_list[$i] = $form->generate_check_box(\"{$element_name}[]\", $optionsexp[0], htmlspecialchars_uni($optionsexp[1]), array('id' => $element_id.'_'.$i, 'class' => $element_id));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif($type[0] == \"select\")\n\t\t\t\t{\n\t\t\t\t\t$setting_code = $form->generate_select_box($element_name, $option_list, $setting['value'], array('id' => $element_id));\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$setting_code = implode(\"<br />\", $option_list);\n\n\t\t\t\t\tif($type[0] == 'checkbox')\n\t\t\t\t\t{\n\t\t\t\t\t\t$setting_code .= $form->generate_hidden_field(\"isvisible_{$setting['name']}\", 1);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t$option_list = array();\n\t\t\t}\n\n\t\t\t// Do we have a custom language variable for this title or description?\n\t\t\t$title_lang = \"setting_\".$setting['name'];\n\t\t\t$desc_lang = $title_lang.\"_desc\";\n\t\t\tif(isset($lang->$title_lang))\n\t\t\t{\n\t\t\t\t$setting['title'] = $lang->$title_lang;\n\t\t\t}\n\t\t\tif(isset($lang->$desc_lang))\n\t\t\t{\n\t\t\t\t$setting['description'] = $lang->$desc_lang;\n\t\t\t}\n\t\t\t$form_container->output_row(htmlspecialchars_uni($setting['title']), $setting['description'], $setting_code, '', array(), array('id' => 'row_'.$element_id));\n\t\t}\n\t\t$form_container->end();\n\n\t\t$form->output_submit_wrapper($buttons);\n\t\t$form->end();\n\t\techo '<br />';\n\t}\n\n\tprint_setting_peekers();\n\n\tif(!isset($mybb->input['ajax_search']))\n\t{\n\t\t$page->output_footer();\n\t}\n}\n\nif(!$mybb->input['action'])\n{\n\t$plugins->run_hooks(\"admin_config_settings_start\");\n\n\t$page->extra_header .= <<<EOF\n\t<script type=\"text/javascript\">\n\t<!--\n\tlang.searching = \"{$lang->searching}\";\n\tlang.search_error = \"{$lang->search_error}\";\n\tlang.search_done = \"{$lang->search_done}\";\n\t// -->\n\t</script>\nEOF;\n\n\t$page->output_header($lang->board_settings);\n\tif(isset($message))\n\t{\n\t\t$page->output_inline_message($message);\n\t}\n\n\t$sub_tabs['change_settings'] = array(\n\t\t'title' => $lang->change_settings,\n\t\t'link' => \"index.php?module=config-settings\",\n\t\t'description' => $lang->change_settings_desc\n\t);\n\n\t$sub_tabs['add_setting'] = array(\n\t\t'title' => $lang->add_new_setting,\n\t\t'link' => \"index.php?module=config-settings&amp;action=add\"\n\t);\n\n\t$sub_tabs['add_setting_group'] = array(\n\t\t'title' => $lang->add_new_setting_group,\n\t\t'link' => \"index.php?module=config-settings&amp;action=addgroup\"\n\t);\n\n\t$sub_tabs['modify_setting'] = array(\n\t\t'title' => $lang->modify_existing_settings,\n\t\t'link' => \"index.php?module=config-settings&amp;action=manage\",\n\t);\n\n\t$page->output_nav_tabs($sub_tabs, 'change_settings');\n\n\t// Search form\n\techo \"<div style=\\\"text-align: right; margin-bottom: 3px;\\\">\";\n\t$search = new Form(\"index.php\", 'get', 'settings_search', 0, 'settings_search');\n\techo $search->generate_hidden_field('module', 'config/settings');\n\techo $search->generate_hidden_field('action', 'change');\n\techo $search->generate_text_box('search', $lang->settings_search, array('id' => 'search', 'class' => 'search_default field150 field_small'));\n\techo \"<input type=\\\"submit\\\" class=\\\"search_button\\\" value=\\\"{$lang->search}\\\" />\";\n\t$search->end();\n\techo \"</div>\\n\";\n\n\techo '<div id=\"search_results\">&nbsp;</div><div id=\"group_list\">';\n\t$table = new Table;\n\t$table->construct_header($lang->setting_groups);\n\n\tswitch($db->type)\n\t{\n\t\tcase \"pgsql\":\n\t\t$query = $db->query(\"\n\t\t\tSELECT g.*, COUNT(s.sid) AS settingcount\n\t\t\tFROM \".TABLE_PREFIX.\"settinggroups g\n\t\t\tLEFT JOIN \".TABLE_PREFIX.\"settings s ON (s.gid=g.gid)\n\t\t\tWHERE g.isdefault = 1\n\t\t\tGROUP BY \".$db->build_fields_string(\"settinggroups\", \"g.\").\"\n\t\t\tORDER BY g.disporder\n\t\t\");\n\t\tbreak;\n\t\tdefault:\n\t\t$query = $db->query(\"\n\t\t\tSELECT g.*, COUNT(s.sid) AS settingcount\n\t\t\tFROM \".TABLE_PREFIX.\"settinggroups g\n\t\t\tLEFT JOIN \".TABLE_PREFIX.\"settings s ON (s.gid=g.gid)\n\t\t\tWHERE g.isdefault = 1\n\t\t\tGROUP BY g.gid\n\t\t\tORDER BY g.disporder\n\t\t\");\n\t}\n\twhile($group = $db->fetch_array($query))\n\t{\n\t\t$group_lang_var = \"setting_group_{$group['name']}\";\n\t\tif(isset($lang->$group_lang_var))\n\t\t{\n\t\t\t$group_title = htmlspecialchars_uni($lang->$group_lang_var);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$group_title = htmlspecialchars_uni($group['title']);\n\t\t}\n\n\t\t$group_desc_lang_var = \"setting_group_{$group['name']}_desc\";\n\t\tif(isset($lang->$group_desc_lang_var))\n\t\t{\n\t\t\t$group_desc = htmlspecialchars_uni($lang->$group_desc_lang_var);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$group_desc = htmlspecialchars_uni($group['description']);\n\t\t}\n\n\t\t$table->construct_cell(\"<strong><a href=\\\"index.php?module=config-settings&amp;action=change&amp;gid={$group['gid']}\\\">{$group_title}</a></strong> ({$group['settingcount']} {$lang->bbsettings})<br /><small>{$group_desc}</small>\");\n\t\t$table->construct_row();\n\t}\n\n\t$table->output(\"<span style=\\\"float: right;\\\"><small><a href=\\\"index.php?module=config-settings&amp;action=change\\\">{$lang->show_all_settings}</a></small></span>{$lang->board_settings}\");\n\n\t// Plugin Settings\n\tswitch($db->type)\n\t{\n\t\tcase \"pgsql\":\n\t\t$query = $db->query(\"\n\t\t\tSELECT g.*, COUNT(s.sid) AS settingcount\n\t\t\tFROM \".TABLE_PREFIX.\"settinggroups g\n\t\t\tLEFT JOIN \".TABLE_PREFIX.\"settings s ON (s.gid=g.gid)\n\t\t\tWHERE g.isdefault <> 1\n\t\t\tGROUP BY \".$db->build_fields_string(\"settinggroups\", \"g.\").\"\n\t\t\tORDER BY g.disporder\n\t\t\");\n\t\tbreak;\n\t\tdefault:\n\t\t$query = $db->query(\"\n\t\t\tSELECT g.*, COUNT(s.sid) AS settingcount\n\t\t\tFROM \".TABLE_PREFIX.\"settinggroups g\n\t\t\tLEFT JOIN \".TABLE_PREFIX.\"settings s ON (s.gid=g.gid)\n\t\t\tWHERE g.isdefault <> 1\n\t\t\tGROUP BY g.gid\n\t\t\tORDER BY g.disporder\n\t\t\");\n\t}\n\n\tif($db->num_rows($query))\n\t{\n\t\t$table = new Table;\n\t\t$table->construct_header($lang->setting_groups);\n\n\t\twhile($group = $db->fetch_array($query))\n\t\t{\n\t\t\t$group_lang_var = \"setting_group_{$group['name']}\";\n\t\t\tif(isset($lang->$group_lang_var))\n\t\t\t{\n\t\t\t\t$group_title = htmlspecialchars_uni($lang->$group_lang_var);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$group_title = htmlspecialchars_uni($group['title']);\n\t\t\t}\n\n\t\t\t$group_desc_lang_var = \"setting_group_{$group['name']}_desc\";\n\t\t\tif(isset($lang->$group_desc_lang_var))\n\t\t\t{\n\t\t\t\t$group_desc = htmlspecialchars_uni($lang->$group_desc_lang_var);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$group_desc = htmlspecialchars_uni($group['description']);\n\t\t\t}\n\n\t\t\t$table->construct_cell(\"<strong><a href=\\\"index.php?module=config-settings&amp;action=change&amp;gid={$group['gid']}\\\">{$group_title}</a></strong> ({$group['settingcount']} {$lang->bbsettings})<br /><small>{$group_desc}</small>\");\n\t\t\t$table->construct_row();\n\t\t}\n\n\t\t$table->output($lang->plugin_settings);\n\t}\n\n\techo '</div>';\n\n\techo '\n<script type=\"text/javascript\" src=\"./jscripts/search.js?ver=1821\"></script>\n<script type=\"text/javascript\">\n//<!--\n$(function(){\n\tSettingSearch.init(\"'.$lang->settings_search.'\",\"'.$lang->error_ajax_unknown.'\");\n});\n//-->\n</script>';\n\n\tprint_setting_peekers();\n\t$page->output_footer();\n}\n\n/**\n * Print all the peekers for all of the default settings\n */\nfunction print_setting_peekers()\n{\n\tglobal $plugins;\n\n\t$peekers = array(\n\t\t'new Peeker($(\".setting_boardclosed\"), $(\"#row_setting_boardclosed_reason\"), 1, true)',\n\t\t'new Peeker($(\".setting_gzipoutput\"), $(\"#row_setting_gziplevel\"), 1, true)',\n\t\t'new Peeker($(\".setting_useerrorhandling\"), $(\"#row_setting_errorlogmedium, #row_setting_errorloglocation\"), 1, true)',\n\t\t'new Peeker($(\"#setting_subforumsindex\"), $(\"#row_setting_subforumsstatusicons\"), /[^0+|]/, false)',\n\t\t'new Peeker($(\".setting_showsimilarthreads\"), $(\"#row_setting_similarityrating, #row_setting_similarlimit\"), 1, true)',\n\t\t'new Peeker($(\".setting_disableregs\"), $(\"#row_setting_regtype, #row_setting_securityquestion, #row_setting_regtime, #row_setting_allowmultipleemails, #row_setting_hiddencaptchaimage, #row_setting_betweenregstime\"), 0, true)',\n\t\t'new Peeker($(\".setting_hiddencaptchaimage\"), $(\"#row_setting_hiddencaptchaimagefield\"), 1, true)',\n\t\t'new Peeker($(\"#setting_failedlogincount\"), $(\"#row_setting_failedlogintime, #row_setting_failedlogintext\"), /[^0+|]/, false)',\n\t\t'new Peeker($(\".setting_postfloodcheck\"), $(\"#row_setting_postfloodsecs\"), 1, true)',\n\t\t'new Peeker($(\"#setting_postmergemins\"), $(\"#row_setting_postmergefignore, #row_setting_postmergeuignore, #row_setting_postmergesep\"), /[^0+|]/, false)',\n\t\t'new Peeker($(\".setting_enablememberlist\"), $(\"#row_setting_membersperpage, #row_setting_default_memberlist_sortby, #row_setting_default_memberlist_order, #row_setting_memberlistmaxavatarsize\"), 1, true)',\n\t\t'new Peeker($(\".setting_enablereputation\"), $(\"#row_setting_repsperpage, #row_setting_posrep, #row_setting_neurep, #row_setting_negrep, #row_setting_postrep, #row_setting_multirep, #row_setting_maxreplength, #row_setting_minreplength\"), 1, true)',\n\t\t'new Peeker($(\".setting_enablewarningsystem\"), $(\"#row_setting_allowcustomwarnings, #row_setting_canviewownwarning, #row_setting_maxwarningpoints, #row_setting_allowanonwarningpms\"), 1, true)',\n\t\t'new Peeker($(\".setting_enablepms\"), $(\"#row_setting_pmsallowhtml, #row_setting_pmsallowmycode, #row_setting_pmsallowsmilies, #row_setting_pmsallowimgcode, #row_setting_pmsallowvideocode, #row_setting_pmquickreply, #row_setting_pmfloodsecs, #row_setting_showpmip, #row_setting_maxpmquotedepth\"), 1, true)',\n\t\t'new Peeker($(\".setting_smilieinserter\"), $(\"#row_setting_smilieinsertertot, #row_setting_smilieinsertercols\"), 1, true)',\n\t\t'new Peeker($(\"#setting_mail_handler\"), $(\"#row_setting_smtp_host, #row_setting_smtp_port, #row_setting_smtp_user, #row_setting_smtp_pass, #row_setting_secure_smtp\"), \"smtp\", false)',\n\t\t'new Peeker($(\"#setting_mail_handler\"), $(\"#row_setting_mail_parameters\"), \"mail\", false)',\n\t\t'new Peeker($(\"#setting_captchaimage\"), $(\"#row_setting_recaptchapublickey, #row_setting_recaptchaprivatekey\"), /(4|5|8)/, false)',\n\t\t'new Peeker($(\"#setting_captchaimage\"), $(\"#row_setting_recaptchascore\"), /(8)/, false)',\n\t\t'new Peeker($(\"#setting_captchaimage\"), $(\"#row_setting_hcaptchapublickey, #row_setting_hcaptchaprivatekey\"), /(6|7)/, false)',\n\t\t'new Peeker($(\"#setting_captchaimage\"), $(\"#row_setting_hcaptchaprivatekey, #row_setting_hcaptchaprivatekey\"), /(6|7)/, false)',\n\t\t'new Peeker($(\"#setting_captchaimage\"), $(\"#row_setting_hcaptchatheme\"), 6, false)',\n\t\t'new Peeker($(\"#setting_captchaimage\"), $(\"#row_setting_hcaptchasize\"), 6, false)',\n\t\t'new Peeker($(\".setting_contact\"), $(\"#row_setting_contact_guests, #row_setting_contact_badwords, #row_setting_contact_maxsubjectlength, #row_setting_contact_minmessagelength, #row_setting_contact_maxmessagelength\"), 1, true)',\n\t\t'new Peeker($(\".setting_enablepruning\"), $(\"#row_setting_enableprunebyposts, #row_setting_pruneunactived, #row_setting_prunethreads\"), 1, true)',\n\t\t'new Peeker($(\".setting_enableprunebyposts\"), $(\"#row_setting_prunepostcount, #row_setting_dayspruneregistered, #row_setting_prunepostcountall\"), 1, true)',\n\t\t'new Peeker($(\".setting_pruneunactived\"), $(\"#row_setting_dayspruneunactivated\"), 1, true)',\n\t\t'new Peeker($(\".setting_statsenabled\"), $(\"#row_setting_statscachetime, #row_setting_statslimit, #row_setting_statstopreferrer\"), 1, true)',\n\t\t'new Peeker($(\".setting_purgespammergroups_forums_groups_check\"), $(\"#row_setting_purgespammerpostlimit, #row_setting_purgespammerbandelete, #row_setting_purgespammerapikey\"), /^(?!none)/, true)',\n\t\t'new Peeker($(\".setting_purgespammerbandelete\"),$(\"#row_setting_purgespammerbangroup, #row_setting_purgespammerbanreason\"), \"ban\", true)',\n\t\t'new Peeker($(\"#setting_maxloginattempts\"), $(\"#row_setting_loginattemptstimeout\"), /[^0+|]/, false)',\n\t\t'new Peeker($(\".setting_bbcodeinserter\"), $(\"#row_setting_partialmode, #row_setting_smilieinserter\"), 1, true)',\n\t\t'new Peeker($(\".setting_portal\"), $(\"#row_setting_portal_announcementsfid, #row_setting_portal_showwelcome, #row_setting_portal_showpms, #row_setting_portal_showstats, #row_setting_portal_showwol, #row_setting_portal_showsearch, #row_setting_portal_showdiscussions\"), 1, true)',\n\t\t'new Peeker($(\".setting_portal_announcementsfid_forums_groups_check\"), $(\"#row_setting_portal_numannouncements\"), /^(?!none)/, true)',\n\t\t'new Peeker($(\".setting_portal_showdiscussions\"), $(\"#row_setting_portal_showdiscussionsnum, #row_setting_portal_excludediscussion\"), 1, true)',\n\t\t'new Peeker($(\".setting_enableattachments\"), $(\"#row_setting_maxattachments, #row_setting_attachthumbnails\"), 1, true)',\n\t\t'new Peeker($(\".setting_attachthumbnails\"), $(\"#row_setting_attachthumbh, #row_setting_attachthumbw\"), \"yes\", true)',\n\t\t'new Peeker($(\".setting_showbirthdays\"), $(\"#row_setting_showbirthdayspostlimit\"), 1, true)',\n\t\t'new Peeker($(\"#setting_betweenregstime\"), $(\"#row_setting_maxregsbetweentime\"), /[^0+|]/, false)',\n\t\t'new Peeker($(\".setting_usecdn\"), $(\"#row_setting_cdnurl, #row_setting_cdnpath\"), 1, true)',\n\t\t'new Peeker($(\"#setting_errorlogmedium\"), $(\"#row_setting_errorloglocation\"), /^(log|both)/, false)',\n\t\t'new Peeker($(\".setting_sigmycode\"), $(\"#row_setting_sigcountmycode, #row_setting_sigimgcode\"), 1, true)',\n\t\t'new Peeker($(\".setting_pmsallowmycode\"), $(\"#row_setting_pmsallowimgcode, #row_setting_pmsallowvideocode\"), 1, true)',\n\t\t'new Peeker($(\".setting_enableshowteam\"), $(\"#row_setting_showaddlgroups, #row_setting_showgroupleaders\"), 1, true)',\n\t\t'new Peeker($(\".setting_usereferrals\"), $(\"#row_setting_referralsperpage\"), 1, true)',\n\t);\n\n\t$peekers = $plugins->run_hooks(\"admin_settings_print_peekers\", $peekers);\n\n\t$setting_peekers = implode(\"\\n\t\t\t\", $peekers);\n\n\techo '<script type=\"text/javascript\" src=\"./jscripts/peeker.js?ver=1821\"></script>\n\t<script type=\"text/javascript\">\n\t\t$(function() {\n\t\t\t' . $setting_peekers . '\n\t\t});\n\t</script>';\n}\n"], "fixing_code": ["<?php\n/**\n * MyBB 1.8\n * Copyright 2014 MyBB Group, All Rights Reserved\n *\n * Website: http://www.mybb.com\n * License: http://www.mybb.com/about/license\n *\n */\n\n// Disallow direct access to this file for security reasons\nif(!defined(\"IN_MYBB\"))\n{\n\tdie(\"Direct initialization of this file is not allowed.<br /><br />Please make sure IN_MYBB is defined.\");\n}\n\n$page->add_breadcrumb_item($lang->board_settings, \"index.php?module=config-settings\");\n\n$plugins->run_hooks(\"admin_config_settings_begin\");\n\n// Creating a new setting group\nif($mybb->input['action'] == \"addgroup\")\n{\n\t$plugins->run_hooks(\"admin_config_settings_addgroup\");\n\n\tif($mybb->request_method == \"post\")\n\t{\n\t\t// Validate title\n\t\tif(!trim($mybb->input['title']))\n\t\t{\n\t\t\t$errors[] = $lang->error_missing_group_title;\n\t\t}\n\n\t\t// Validate identifier\n\t\tif(!trim($mybb->input['name']))\n\t\t{\n\t\t\t$errors[] = $lang->error_missing_group_name;\n\t\t}\n\t\t$query = $db->simple_select(\"settinggroups\", \"title\", \"name='\".$db->escape_string($mybb->input['name']).\"'\");\n\t\tif($db->num_rows($query) > 0)\n\t\t{\n\t\t\t$dup_group_title = $db->fetch_field($query, 'title');\n\t\t\t$errors[] = $lang->sprintf($lang->error_duplicate_group_name, $dup_group_title);\n\t\t}\n\n\t\tif(!$errors)\n\t\t{\n\t\t\t$new_setting_group = array(\n\t\t\t\t\"name\" => $db->escape_string($mybb->input['name']),\n\t\t\t\t\"title\" => $db->escape_string($mybb->input['title']),\n\t\t\t\t\"description\" => $db->escape_string($mybb->input['description']),\n\t\t\t\t\"disporder\" => $mybb->get_input('disporder', MyBB::INPUT_INT),\n\t\t\t\t\"isdefault\" => 0\n\t\t\t);\n\t\t\t$gid = $db->insert_query(\"settinggroups\", $new_setting_group);\n\n\t\t\t$plugins->run_hooks(\"admin_config_settings_addgroup_commit\");\n\n\t\t\t// Log admin action\n\t\t\tlog_admin_action($gid, $mybb->input['name']);\n\n\t\t\tflash_message($lang->success_setting_group_added, 'success');\n\t\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t\t}\n\t}\n\n\t$page->add_breadcrumb_item($lang->add_new_setting_group);\n\t$page->output_header($lang->board_settings.\" - \".$lang->add_new_setting_group);\n\n\t$sub_tabs['change_settings'] = array(\n\t\t'title' => $lang->change_settings,\n\t\t'link' => \"index.php?module=config-settings\"\n\t);\n\n\t$sub_tabs['add_setting'] = array(\n\t\t'title' => $lang->add_new_setting,\n\t\t'link' => \"index.php?module=config-settings&amp;action=add\"\n\t);\n\n\t$sub_tabs['add_setting_group'] = array(\n\t\t'title' => $lang->add_new_setting_group,\n\t\t'link' => \"index.php?module=config-settings&amp;action=addgroup\",\n\t\t'description' => $lang->add_new_setting_group_desc\n\t);\n\n\t$sub_tabs['modify_setting'] = array(\n\t\t'title' => $lang->modify_existing_settings,\n\t\t'link' => \"index.php?module=config-settings&amp;action=manage\"\n\t);\n\n\t$page->output_nav_tabs($sub_tabs, 'add_setting_group');\n\n\t$form = new Form(\"index.php?module=config-settings&amp;action=addgroup\", \"post\", \"add\");\n\n\tif($errors)\n\t{\n\t\t$page->output_inline_error($errors);\n\t}\n\n\t$form_container = new FormContainer($lang->add_new_setting_group);\n\t$form_container->output_row($lang->title.\" <em>*</em>\", \"\", $form->generate_text_box('title', $mybb->get_input('title'), array('id' => 'title')), 'title');\n\t$form_container->output_row($lang->description, \"\", $form->generate_text_area('description', $mybb->get_input('description'), array('id' => 'description')), 'description');\n\t$form_container->output_row($lang->display_order, \"\", $form->generate_numeric_field('disporder', $mybb->get_input('disporder'), array('id' => 'disporder', 'min' => 0)), 'disporder');\n\t$form_container->output_row($lang->name.\" <em>*</em>\", $lang->group_name_desc, $form->generate_text_box('name', $mybb->get_input('name'), array('id' => 'name')), 'name');\n\t$form_container->end();\n\n\t$buttons[] = $form->generate_submit_button($lang->insert_new_setting_group);\n\t$form->output_submit_wrapper($buttons);\n\t$form->end();\n\n\t$page->output_footer();\n}\n\n// Edit setting group\nif($mybb->input['action'] == \"editgroup\")\n{\n\t$query = $db->simple_select(\"settinggroups\", \"*\", \"gid='\".$mybb->get_input('gid', MyBB::INPUT_INT).\"'\");\n\t$group = $db->fetch_array($query);\n\n\t// Does the setting not exist?\n\tif(!$group['gid'])\n\t{\n\t\tflash_message($lang->error_invalid_gid2, 'error');\n\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t}\n\t// Prevent editing of default\n\tif($group['isdefault'] == 1)\n\t{\n\t\tflash_message($lang->error_cannot_edit_default, 'error');\n\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t}\n\n\t$plugins->run_hooks(\"admin_config_settings_editgroup\");\n\n\t// Do edit?\n\tif($mybb->request_method == \"post\")\n\t{\n\t\t// Validate title\n\t\tif(!trim($mybb->input['title']))\n\t\t{\n\t\t\t$errors[] = $lang->error_missing_group_title;\n\t\t}\n\n\t\t// Validate identifier\n\t\tif(!trim($mybb->input['name']))\n\t\t{\n\t\t\t$errors[] = $lang->error_missing_group_name;\n\t\t}\n\t\t$query = $db->simple_select(\"settinggroups\", \"title\", \"name='\".$db->escape_string($mybb->input['name']).\"' AND gid != '{$group['gid']}'\");\n\t\tif($db->num_rows($query) > 0)\n\t\t{\n\t\t\t$dup_group_title = $db->fetch_field($query, 'title');\n\t\t\t$errors[] = $lang->sprintf($lang->error_duplicate_group_name, $dup_group_title);\n\t\t}\n\n\t\tif(!$errors)\n\t\t{\n\t\t\t$update_setting_group = array(\n\t\t\t\t\"name\" => $db->escape_string($mybb->input['name']),\n\t\t\t\t\"title\" => $db->escape_string($mybb->input['title']),\n\t\t\t\t\"description\" => $db->escape_string($mybb->input['description']),\n\t\t\t\t\"disporder\" => $mybb->get_input('disporder', MyBB::INPUT_INT),\n\t\t\t);\n\n\t\t\t$plugins->run_hooks(\"admin_config_settings_editgroup_commit\");\n\n\t\t\t$db->update_query(\"settinggroups\", $update_setting_group, \"gid='{$group['gid']}'\");\n\n\t\t\t// Log admin action\n\t\t\tlog_admin_action($group['gid'], $mybb->input['name']);\n\n\t\t\tflash_message($lang->success_setting_group_updated, 'success');\n\t\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t\t}\n\t}\n\n\t$page->add_breadcrumb_item($lang->edit_setting_group);\n\t$page->output_header($lang->board_settings.\" - \".$lang->edit_setting_group);\n\n\t$sub_tabs['edit_setting_group'] = array(\n\t\t'title' => $lang->edit_setting_group,\n\t\t'link' => \"index.php?module=config-settings&amp;action=editgroup&amp;gid={$group['gid']}\",\n\t\t'description' => $lang->edit_setting_group_desc\n\t);\n\n\t$page->output_nav_tabs($sub_tabs, 'edit_setting_group');\n\n\t$form = new Form(\"index.php?module=config-settings&amp;action=editgroup\", \"post\", \"editgroup\");\n\n\techo $form->generate_hidden_field(\"gid\", $group['gid']);\n\n\tif($errors)\n\t{\n\t\t$group_data = $mybb->input;\n\t\t$page->output_inline_error($errors);\n\t}\n\telse\n\t{\n\t\t$group_data = $group;\n\t}\n\n\t$form_container = new FormContainer($lang->edit_setting_group);\n\t$form_container->output_row($lang->title.\" <em>*</em>\", \"\", $form->generate_text_box('title', $group_data['title'], array('id' => 'title')), 'title');\n\t$form_container->output_row($lang->description, \"\", $form->generate_text_area('description', $group_data['description'], array('id' => 'description')), 'description');\n\t$form_container->output_row($lang->display_order, \"\", $form->generate_numeric_field('disporder', $group_data['disporder'], array('id' => 'disporder', 'min' => 0)), 'disporder');\n\t$form_container->output_row($lang->name.\" <em>*</em>\", $lang->group_name_desc, $form->generate_text_box('name', $group_data['name'], array('id' => 'name')), 'name');\n\t$form_container->end();\n\n\t$buttons[] = $form->generate_submit_button($lang->update_setting_group);\n\t$form->output_submit_wrapper($buttons);\n\t$form->end();\n\n\t$page->output_footer();\n}\n\n// Delete Setting Group\nif($mybb->input['action'] == \"deletegroup\")\n{\n\t$query = $db->simple_select(\"settinggroups\", \"*\", \"gid='\".$mybb->get_input('gid', MyBB::INPUT_INT).\"'\");\n\t$group = $db->fetch_array($query);\n\n\t// Does the setting group not exist?\n\tif(!$group['gid'])\n\t{\n\t\tflash_message($lang->error_invalid_gid2, 'error');\n\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t}\n\t// Prevent deletion of default\n\tif($group['isdefault'] == 1)\n\t{\n\t\tflash_message($lang->error_cannot_edit_default, 'error');\n\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t}\n\n\t// User clicked no\n\tif($mybb->get_input('no'))\n\t{\n\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t}\n\n\t$plugins->run_hooks(\"admin_config_settings_deletegroup\");\n\n\tif($mybb->request_method == \"post\")\n\t{\n\t\t// Delete the setting group and its settings\n\t\t$db->delete_query(\"settinggroups\", \"gid='{$group['gid']}'\");\n\t\t$db->delete_query(\"settings\", \"gid='{$group['gid']}'\");\n\n\t\trebuild_settings();\n\n\t\t$plugins->run_hooks(\"admin_config_settings_deletegroup_commit\");\n\n\t\t// Log admin action\n\t\tlog_admin_action($group['gid'], $group['name']);\n\n\t\tflash_message($lang->success_setting_group_deleted, 'success');\n\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t}\n\telse\n\t{\n\t\t$page->output_confirm_action(\"index.php?module=config-settings&amp;action=deletegroup&amp;gid={$group['gid']}\", $lang->confirm_setting_group_deletion);\n\t}\n}\n\n// Creating a new setting\nif($mybb->input['action'] == \"add\")\n{\n\t$plugins->run_hooks(\"admin_config_settings_add\");\n\n\tif($mybb->request_method == \"post\")\n\t{\n\t\tif(!trim($mybb->input['title']))\n\t\t{\n\t\t\t$errors[] = $lang->error_missing_title;\n\t\t}\n\n\t\t$query = $db->simple_select(\"settinggroups\", \"gid\", \"gid='\".$mybb->get_input('gid', MyBB::INPUT_INT).\"'\");\n\t\t$gid = $db->fetch_field($query, 'gid');\n\t\tif(!$gid)\n\t\t{\n\t\t\t$errors[] = $lang->error_invalid_gid;\n\t\t}\n\n\t\tif(!trim($mybb->input['name']))\n\t\t{\n\t\t\t$errors[] = $lang->error_missing_name;\n\t\t}\n\t\t$query = $db->simple_select(\"settings\", \"title\", \"name='\".$db->escape_string($mybb->input['name']).\"'\");\n\t\tif($db->num_rows($query) > 0)\n\t\t{\n\t\t\t$dup_setting_title = $db->fetch_field($query, 'title');\n\t\t\t$errors[] = $lang->sprintf($lang->error_duplicate_name, $dup_setting_title);\n\t\t}\n\n\t\t// do some type filtering\n\t\t$mybb->input['type'] = $mybb->get_input('type');\n\t\tif(!ctype_alnum($mybb->input['type']) || strtolower($mybb->input['type']) == \"php\")\n\t\t{\n\t\t\t$mybb->input['type'] = \"\";\n\t\t}\n\n\t\tif(!$mybb->input['type'])\n\t\t{\n\t\t\t$errors[] = $lang->error_invalid_type;\n\t\t}\n\n\t\tif(!$errors)\n\t\t{\n\t\t\tif($mybb->input['extra'])\n\t\t\t{\n\t\t\t\t$options_code = \"{$mybb->input['type']}\\n{$mybb->input['extra']}\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$options_code = $mybb->input['type'];\n\t\t\t}\n\n\t\t\t$mybb->input['name'] = str_replace(\"\\\\\", '', $mybb->input['name']);\n\t\t\t$mybb->input['name'] = str_replace('$', '', $mybb->input['name']);\n\t\t\t$mybb->input['name'] = str_replace(\"'\", '', $mybb->input['name']);\n\n\t\t\tif($options_code == \"numeric\")\n\t\t\t{\n\t\t\t\t$value = $mybb->get_input('value', MyBB::INPUT_INT);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$value = $db->escape_string($mybb->input['value']);\n\t\t\t}\n\n\t\t\t$new_setting = array(\n\t\t\t\t\"name\" => $db->escape_string($mybb->input['name']),\n\t\t\t\t\"title\" => $db->escape_string($mybb->input['title']),\n\t\t\t\t\"description\" => $db->escape_string($mybb->input['description']),\n\t\t\t\t\"optionscode\" => $db->escape_string($options_code),\n\t\t\t\t\"value\" => $value,\n\t\t\t\t\"disporder\" => $mybb->get_input('disporder', MyBB::INPUT_INT),\n\t\t\t\t\"gid\" => $mybb->get_input('gid', MyBB::INPUT_INT)\n\t\t\t);\n\n\t\t\t$sid = $db->insert_query(\"settings\", $new_setting);\n\t\t\trebuild_settings();\n\n\t\t\t$plugins->run_hooks(\"admin_config_settings_add_commit\");\n\n\t\t\t// Log admin action\n\t\t\tlog_admin_action($sid, $mybb->input['title']);\n\n\t\t\tflash_message($lang->success_setting_added, 'success');\n\t\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t\t}\n\t}\n\n\t$page->add_breadcrumb_item($lang->add_new_setting);\n\t$page->output_header($lang->board_settings.\" - \".$lang->add_new_setting);\n\n\t$sub_tabs['change_settings'] = array(\n\t\t'title' => $lang->change_settings,\n\t\t'link' => \"index.php?module=config-settings\"\n\t);\n\n\t$sub_tabs['add_setting'] = array(\n\t\t'title' => $lang->add_new_setting,\n\t\t'link' => \"index.php?module=config-settings&amp;action=add\",\n\t\t'description' => $lang->add_new_setting_desc\n\t);\n\n\t$sub_tabs['add_setting_group'] = array(\n\t\t'title' => $lang->add_new_setting_group,\n\t\t'link' => \"index.php?module=config-settings&amp;action=addgroup\"\n\t);\n\n\t$sub_tabs['modify_setting'] = array(\n\t\t'title' => $lang->modify_existing_settings,\n\t\t'link' => \"index.php?module=config-settings&amp;action=manage\"\n\t);\n\n\t$page->output_nav_tabs($sub_tabs, 'add_setting');\n\n\t$form = new Form(\"index.php?module=config-settings&amp;action=add\", \"post\", \"add\");\n\n\tif($errors)\n\t{\n\t\t$page->output_inline_error($errors);\n\t}\n\n\t$form_container = new FormContainer($lang->add_new_setting);\n\t$form_container->output_row($lang->title.\" <em>*</em>\", \"\", $form->generate_text_box('title', $mybb->get_input('title'), array('id' => 'title')), 'title');\n\t$form_container->output_row($lang->description, \"\", $form->generate_text_area('description', $mybb->get_input('description'), array('id' => 'description')), 'description');\n\n\t$query = $db->simple_select(\"settinggroups\", \"*\", \"\", array('order_by' => 'disporder'));\n\twhile($group = $db->fetch_array($query))\n\t{\n\t\t$group_lang_var = \"setting_group_{$group['name']}\";\n\t\tif(!empty($lang->$group_lang_var))\n\t\t{\n\t\t\t$options[$group['gid']] = htmlspecialchars_uni($lang->$group_lang_var);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$options[$group['gid']] = htmlspecialchars_uni($group['title']);\n\t\t}\n\t}\n\t$form_container->output_row($lang->group.\" <em>*</em>\", \"\", $form->generate_select_box(\"gid\", $options, $mybb->get_input('gid'), array('id' => 'gid')), 'gid');\n\t$form_container->output_row($lang->display_order, \"\", $form->generate_numeric_field('disporder', $mybb->get_input('disporder'), array('id' => 'disporder', 'min' => 0)), 'disporder');\n\n\t$form_container->output_row($lang->name.\" <em>*</em>\", $lang->name_desc, $form->generate_text_box('name', $mybb->get_input('name'), array('id' => 'name')), 'name');\n\n\t$setting_types = array(\n\t\t\"text\" => $lang->text,\n\t\t\"numeric\" => $lang->numeric_text,\n\t\t\"textarea\" => $lang->textarea,\n\t\t\"yesno\" => $lang->yesno,\n\t\t\"onoff\" => $lang->onoff,\n\t\t\"select\" => $lang->select,\n\t\t\"forumselect\" => $lang->forum_selection_box,\n\t\t\"forumselectsingle\" => $lang->forum_selection_single,\n\t\t\"groupselect\" => $lang->group_selection_box,\n\t\t\"groupselectsingle\" => $lang->group_selection_single,\n\t\t\"radio\" => $lang->radio,\n\t\t\"checkbox\" => $lang->checkbox,\n\t\t\"language\" => $lang->language_selection_box,\n\t\t\"adminlanguage\" => $lang->adminlanguage,\n\t\t\"cpstyle\" => $lang->cpstyle,\n\t\t\"prefixselect\" => $lang->prefix_selection_box\n\t\t//\"php\" => $lang->php // Internal Use Only\n\t);\n\n\t$form_container->output_row($lang->type.\" <em>*</em>\", \"\", $form->generate_select_box(\"type\", $setting_types, $mybb->get_input('type'), array('id' => 'type')), 'type');\n\t$form_container->output_row($lang->extra, $lang->extra_desc, $form->generate_text_area('extra', $mybb->get_input('extra'), array('id' => 'extra')), 'extra', array(), array('id' => 'row_extra'));\n\t$form_container->output_row($lang->value, \"\", $form->generate_text_area('value', $mybb->get_input('value'), array('id' => 'value')), 'value');\n\t$form_container->end();\n\n\t$buttons[] = $form->generate_submit_button($lang->insert_new_setting);\n\t$form->output_submit_wrapper($buttons);\n\t$form->end();\n\n\techo '<script type=\"text/javascript\" src=\"./jscripts/peeker.js?ver=1821\"></script>\n\t<script type=\"text/javascript\">\n\t\t$(function() {\n\t\t\tnew Peeker($(\"#type\"), $(\"#row_extra\"), /^(select|radio|checkbox|php)$/, false);\n\t\t});\n\t\t// Add a star to the extra row since the \"extra\" is required if the box is shown\n\t\tadd_star(\"row_extra\");\n\t</script>';\n\n\t$page->output_footer();\n}\n\n// Editing a particular setting\nif($mybb->input['action'] == \"edit\")\n{\n\t$query = $db->simple_select(\"settings\", \"*\", \"sid='\".$mybb->get_input('sid', MyBB::INPUT_INT).\"'\");\n\t$setting = $db->fetch_array($query);\n\n\t// Does the setting not exist?\n\tif(!$setting['sid'])\n\t{\n\t\tflash_message($lang->error_invalid_sid, 'error');\n\t\tadmin_redirect(\"index.php?module=config-settings\");\n\t}\n\n\t// Prevent editing of default\n\tif($setting['isdefault'] == 1)\n\t{\n\t\tflash_message($lang->error_cannot_edit_default, 'error');\n\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t}\n\n\t$plugins->run_hooks(\"admin_config_settings_edit\");\n\n\t$type = explode(\"\\n\", $setting['optionscode'], 2);\n\t$type = trim($type[0]);\n\tif($type == \"php\")\n\t{\n\t\tflash_message($lang->error_cannot_edit_php, 'error');\n\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t}\n\n\tif($mybb->request_method == \"post\")\n\t{\n\t\tif(!trim($mybb->input['title']))\n\t\t{\n\t\t\t$errors[] = $lang->error_missing_title;\n\t\t}\n\n\t\tif(!trim($mybb->input['name']))\n\t\t{\n\t\t\t$errors[] = $lang->error_missing_name;\n\t\t}\n\t\t$query = $db->simple_select(\"settings\", \"title\", \"name='\".$db->escape_string($mybb->input['name']).\"' AND sid != '{$setting['sid']}'\");\n\t\tif($db->num_rows($query) > 0)\n\t\t{\n\t\t\t$dup_setting_title = $db->fetch_field($query, 'title');\n\t\t\t$errors[] = $lang->sprintf($lang->error_duplicate_name, $dup_setting_title);\n\t\t}\n\n\t\t// do some type filtering\n\t\t$mybb->input['type'] = $mybb->get_input('type');\n\t\tif(!ctype_alnum($mybb->input['type']) || strtolower($mybb->input['type']) == \"php\")\n\t\t{\n\t\t\t$mybb->input['type'] = \"\";\n\t\t}\n\n\t\tif(!$mybb->input['type'])\n\t\t{\n\t\t\t$errors[] = $lang->error_invalid_type;\n\t\t}\n\n\t\tif(!$errors)\n\t\t{\n\t\t\tif($mybb->input['extra'])\n\t\t\t{\n\t\t\t\t$options_code = \"{$mybb->input['type']}\\n{$mybb->input['extra']}\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$options_code = $mybb->input['type'];\n\t\t\t}\n\n\t\t\t$mybb->input['name'] = str_replace(\"\\\\\", '', $mybb->input['name']);\n\t\t\t$mybb->input['name'] = str_replace('$', '', $mybb->input['name']);\n\t\t\t$mybb->input['name'] = str_replace(\"'\", '', $mybb->input['name']);\n\n\t\t\tif($options_code == \"numeric\")\n\t\t\t{\n\t\t\t\t$value = $mybb->get_input('value', MyBB::INPUT_INT);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$value = $db->escape_string($mybb->input['value']);\n\t\t\t}\n\n\t\t\t$updated_setting = array(\n\t\t\t\t\"name\" => $db->escape_string($mybb->input['name']),\n\t\t\t\t\"title\" => $db->escape_string($mybb->input['title']),\n\t\t\t\t\"description\" => $db->escape_string($mybb->input['description']),\n\t\t\t\t\"optionscode\" => $db->escape_string($options_code),\n\t\t\t\t\"value\" => $value,\n\t\t\t\t\"disporder\" => $mybb->get_input('disporder', MyBB::INPUT_INT),\n\t\t\t\t\"gid\" => $mybb->get_input('gid', MyBB::INPUT_INT)\n\t\t\t);\n\n\t\t\t$plugins->run_hooks(\"admin_config_settings_edit_commit\");\n\n\t\t\t$db->update_query(\"settings\", $updated_setting, \"sid='{$setting['sid']}'\");\n\t\t\trebuild_settings();\n\n\t\t\t// Log admin action\n\t\t\tlog_admin_action($setting['sid'], $mybb->input['title']);\n\n\t\t\tflash_message($lang->success_setting_updated, 'success');\n\t\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t\t}\n\t}\n\n\t$page->add_breadcrumb_item($lang->edit_setting);\n\t$page->output_header($lang->board_settings.\" - \".$lang->edit_setting);\n\n\t$sub_tabs['change_settings'] = array(\n\t\t'title' => $lang->change_settings,\n\t\t'link' => \"index.php?module=config-settings\",\n\t);\n\n\t$sub_tabs['add_setting'] = array(\n\t\t'title' => $lang->add_new_setting,\n\t\t'link' => \"index.php?module=config-settings&amp;action=add\"\n\t);\n\n\t$sub_tabs['add_setting_group'] = array(\n\t\t'title' => $lang->add_new_setting_group,\n\t\t'link' => \"index.php?module=config-settings&amp;action=addgroup\"\n\t);\n\n\t$sub_tabs['modify_setting'] = array(\n\t\t'title' => $lang->modify_existing_settings,\n\t\t'link' => \"index.php?module=config-settings&amp;action=manage\",\n\t\t'description' => $lang->modify_existing_settings_desc\n\t);\n\n\t$page->output_nav_tabs($sub_tabs, 'modify_setting');\n\n\t$form = new Form(\"index.php?module=config-settings&amp;action=edit\", \"post\", \"edit\");\n\n\techo $form->generate_hidden_field(\"sid\", $setting['sid']);\n\n\tif($errors)\n\t{\n\t\t$setting_data = $mybb->input;\n\t\t$page->output_inline_error($errors);\n\t}\n\telse\n\t{\n\t\t$setting_data = $setting;\n\t\t$type = explode(\"\\n\", $setting['optionscode'], 2);\n\t\t$setting_data['type'] = trim($type[0]);\n\n\t\tif(isset($type[1]))\n\t\t{\n\t\t\t$setting_data['extra'] = trim($type[1]);\n\t\t}\n\t}\n\n\t$form_container = new FormContainer($lang->modify_setting);\n\t$form_container->output_row($lang->title.\" <em>*</em>\", \"\", $form->generate_text_box('title', $setting_data['title'], array('id' => 'title')), 'title');\n\t$form_container->output_row($lang->description, \"\", $form->generate_text_area('description', $setting_data['description'], array('id' => 'description')), 'description');\n\n\t$query = $db->simple_select(\"settinggroups\", \"*\", \"\", array('order_by' => 'disporder'));\n\twhile($group = $db->fetch_array($query))\n\t{\n\t\t$group_lang_var = \"setting_group_{$group['name']}\";\n\t\tif(!empty($lang->$group_lang_var))\n\t\t{\n\t\t\t$options[$group['gid']] = htmlspecialchars_uni($lang->$group_lang_var);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$options[$group['gid']] = htmlspecialchars_uni($group['title']);\n\t\t}\n\t}\n\t$form_container->output_row($lang->group.\" <em>*</em>\", \"\", $form->generate_select_box(\"gid\", $options, $setting_data['gid'], array('id' => 'gid')), 'gid');\n\t$form_container->output_row($lang->display_order, \"\", $form->generate_numeric_field('disporder', $setting_data['disporder'], array('id' => 'disporder', 'min' => 0)), 'disporder');\n\t$form_container->end();\n\n\t$form_container = new FormContainer($lang->setting_configuration, 1);\n\t$form_container->output_row($lang->name.\" <em>*</em>\", $lang->name_desc, $form->generate_text_box('name', $setting_data['name'], array('id' => 'name')), 'name');\n\n\t$setting_types = array(\n\t\t\"text\" => $lang->text,\n\t\t\"numeric\" => $lang->numeric_text,\n\t\t\"textarea\" => $lang->textarea,\n\t\t\"yesno\" => $lang->yesno,\n\t\t\"onoff\" => $lang->onoff,\n\t\t\"select\" => $lang->select,\n\t\t\"forumselect\" => $lang->forum_selection_box,\n\t\t\"forumselectsingle\" => $lang->forum_selection_single,\n\t\t\"groupselect\" => $lang->group_selection_box,\n\t\t\"groupselectsingle\" => $lang->group_selection_single,\n\t\t\"radio\" => $lang->radio,\n\t\t\"checkbox\" => $lang->checkbox,\n\t\t\"language\" => $lang->language_selection_box,\n\t\t\"adminlanguage\" => $lang->adminlanguage,\n\t\t\"cpstyle\" => $lang->cpstyle,\n\t\t\"prefixselect\" => $lang->prefix_selection_box\n\t\t//\"php\" => $lang->php // Internal Use Only\n\t);\n\n\t$form_container->output_row($lang->type.\" <em>*</em>\", \"\", $form->generate_select_box(\"type\", $setting_types, $setting_data['type'], array('id' => 'type')), 'type');\n\t$form_container->output_row($lang->extra, $lang->extra_desc, $form->generate_text_area('extra', !empty($setting_data['extra']) ? $setting_data['extra'] : null, array('id' => 'extra')), 'extra', array(), array('id' => 'row_extra'));\n\t$form_container->output_row($lang->value, '', $form->generate_text_area('value', $setting_data['value'], array('id' => 'value')), 'value');\n\t$form_container->end();\n\n\t$buttons[] = $form->generate_submit_button($lang->update_setting);\n\t$form->output_submit_wrapper($buttons);\n\t$form->end();\n\n\techo '<script type=\"text/javascript\" src=\"./jscripts/peeker.js?ver=1821\"></script>\n\t<script type=\"text/javascript\">\n\t\t$(function() {\n\t\t\tnew Peeker($(\"#type\"), $(\"#row_extra\"), /^(select|radio|checkbox|php)$/, false);\n\t\t});\n\t\t// Add a star to the extra row since the \"extra\" is required if the box is shown\n\t\tadd_star(\"row_extra\");\n\t</script>';\n\n\t$page->output_footer();\n}\n\n// Delete Setting\nif($mybb->input['action'] == \"delete\")\n{\n\t$query = $db->simple_select(\"settings\", \"*\", \"sid='\".$mybb->get_input('sid', MyBB::INPUT_INT).\"'\");\n\t$setting = $db->fetch_array($query);\n\n\t// Does the setting not exist?\n\tif(empty($setting['sid']))\n\t{\n\t\tflash_message($lang->error_invalid_sid, 'error');\n\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t}\n\n\t// Prevent editing of default\n\tif($setting['isdefault'] == 1)\n\t{\n\t\tflash_message($lang->error_cannot_edit_default, 'error');\n\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t}\n\n\t// User clicked no\n\tif($mybb->get_input('no'))\n\t{\n\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t}\n\n\t$plugins->run_hooks(\"admin_config_settings_delete\");\n\n\tif($mybb->request_method == \"post\")\n\t{\n\t\t// Delete the setting\n\t\t$db->delete_query(\"settings\", \"sid='{$setting['sid']}'\");\n\n\t\trebuild_settings();\n\n\t\t$plugins->run_hooks(\"admin_config_settings_delete_commit\");\n\n\t\t// Log admin action\n\t\tlog_admin_action($setting['sid'], $setting['title']);\n\n\t\tflash_message($lang->success_setting_deleted, 'success');\n\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t}\n\telse\n\t{\n\t\t$page->output_confirm_action(\"index.php?module=config-settings&amp;action=delete&amp;sid={$setting['sid']}\", $lang->confirm_setting_deletion);\n\t}\n}\n\n// Modify Existing Settings\nif($mybb->input['action'] == \"manage\")\n{\n\t$plugins->run_hooks(\"admin_config_settings_manage\");\n\n\t// Update orders\n\tif($mybb->request_method == \"post\")\n\t{\n\t\tif(is_array($mybb->input['group_disporder']))\n\t\t{\n\t\t\tforeach($mybb->input['group_disporder'] as $gid => $new_order)\n\t\t\t{\n\t\t\t\t$gid = (int)$gid;\n\t\t\t\t$update_group = array('disporder' => (int)$new_order);\n\t\t\t\t$db->update_query(\"settinggroups\", $update_group, \"gid={$gid}\");\n\t\t\t}\n\t\t}\n\n\t\tif(is_array($mybb->input['setting_disporder']))\n\t\t{\n\t\t\tforeach($mybb->input['setting_disporder'] as $sid => $new_order)\n\t\t\t{\n\t\t\t\t$sid = (int)$sid;\n\t\t\t\t$update_setting = array('disporder' => (int)$new_order);\n\t\t\t\t$db->update_query(\"settings\", $update_setting, \"sid={$sid}\");\n\t\t\t}\n\t\t}\n\n\t\t$plugins->run_hooks(\"admin_config_settings_manage_commit\");\n\n\t\t// Log admin action\n\t\tlog_admin_action();\n\n\t\tflash_message($lang->success_display_orders_updated, 'success');\n\t\tadmin_redirect(\"index.php?module=config-settings&action=manage\");\n\t}\n\n\t$page->add_breadcrumb_item($lang->modify_existing_settings);\n\t$page->output_header($lang->board_settings.\" - \".$lang->modify_existing_settings);\n\n\t$sub_tabs['change_settings'] = array(\n\t\t'title' => $lang->change_settings,\n\t\t'link' => \"index.php?module=config-settings\",\n\t);\n\n\t$sub_tabs['add_setting'] = array(\n\t\t'title' => $lang->add_new_setting,\n\t\t'link' => \"index.php?module=config-settings&amp;action=add\"\n\t);\n\n\t$sub_tabs['add_setting_group'] = array(\n\t\t'title' => $lang->add_new_setting_group,\n\t\t'link' => \"index.php?module=config-settings&amp;action=addgroup\"\n\t);\n\n\t$sub_tabs['modify_setting'] = array(\n\t\t'title' => $lang->modify_existing_settings,\n\t\t'link' => \"index.php?module=config-settings&amp;action=manage\",\n\t\t'description' => $lang->modify_existing_settings_desc\n\t);\n\n\t$page->output_nav_tabs($sub_tabs, 'modify_setting');\n\n\t// Cache settings\n\t$settings_cache = array();\n\t$query = $db->simple_select(\"settings\", \"sid, name, title, disporder, gid, isdefault\", \"\", array('order_by' => 'disporder', 'order_dir' => 'asc'));\n\twhile($setting = $db->fetch_array($query))\n\t{\n\t\t$settings_cache[$setting['gid']][] = $setting;\n\t}\n\n\t$form = new Form(\"index.php?module=config-settings&amp;action=manage\", \"post\", \"edit\");\n\n\t$table = new Table;\n\n\t$table->construct_header($lang->setting_group_setting);\n\t$table->construct_header($lang->order, array('class' => 'align_center', 'style' => 'width: 5%'));\n\t$table->construct_header($lang->controls, array('class' => 'align_center', 'style' => 'width: 200px'));\n\n\t// Generate table\n\t$query = $db->simple_select(\"settinggroups\", \"*\", \"\", array('order_by' => 'disporder', 'order_dir' => 'asc'));\n\twhile($group = $db->fetch_array($query))\n\t{\n\t\t// Make setting group row\n\t\t// Translated?\n\t\t$group_lang_var = \"setting_group_{$group['name']}\";\n\t\tif(!empty($lang->$group_lang_var))\n\t\t{\n\t\t\t$group_title = htmlspecialchars_uni($lang->$group_lang_var);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$group_title = htmlspecialchars_uni($group['title']);\n\t\t}\n\t\t$table->construct_cell(\"<strong>{$group_title}</strong>\", array('id' => \"group{$group['gid']}\"));\n\t\t$table->construct_cell($form->generate_numeric_field(\"group_disporder[{$group['gid']}]\", $group['disporder'], array('style' => 'width: 80%; font-weight: bold', 'class' => 'align_center', 'min' => 0)));\n\t\t// Only show options if not a default setting group\n\t\tif($group['isdefault'] != 1)\n\t\t{\n\t\t\t$popup = new PopupMenu(\"group_{$group['gid']}\", $lang->options);\n\t\t\t$popup->add_item($lang->edit_setting_group, \"index.php?module=config-settings&amp;action=editgroup&amp;gid={$group['gid']}\");\n\t\t\t$popup->add_item($lang->delete_setting_group, \"index.php?module=config-settings&amp;action=deletegroup&amp;gid={$group['gid']}&amp;my_post_key={$mybb->post_code}\", \"return AdminCP.deleteConfirmation(this, '{$lang->confirm_setting_group_deletion}')\");\n\t\t\t$table->construct_cell($popup->fetch(), array('class' => 'align_center'));\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$table->construct_cell('');\n\t\t}\n\t\t$table->construct_row(array('class' => 'alt_row', 'no_alt_row' => 1));\n\n\t\t// Make rows for each setting in the group\n\t\tif(isset($settings_cache[$group['gid']]) && is_array($settings_cache[$group['gid']]))\n\t\t{\n\t\t\tforeach($settings_cache[$group['gid']] as $setting)\n\t\t\t{\n\t\t\t\t$setting_lang_var = \"setting_{$setting['name']}\";\n\t\t\t\tif(!empty($lang->$setting_lang_var))\n\t\t\t\t{\n\t\t\t\t\t$setting_title = htmlspecialchars_uni($lang->$setting_lang_var);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$setting_title = htmlspecialchars_uni($setting['title']);\n\t\t\t\t}\n\t\t\t\t$table->construct_cell($setting_title, array('style' => 'padding-left: 40px;'));\n\t\t\t\t$table->construct_cell($form->generate_numeric_field(\"setting_disporder[{$setting['sid']}]\", $setting['disporder'], array('style' => 'width: 80%', 'class' => 'align_center', 'min' => 0)));\n\t\t\t\t// Only show options if not a default setting group or is a custom setting\n\t\t\t\tif($group['isdefault'] != 1 || $setting['isdefault'] != 1)\n\t\t\t\t{\n\t\t\t\t\t$popup = new PopupMenu(\"setting_{$setting['sid']}\", $lang->options);\n\t\t\t\t\t$popup->add_item($lang->edit_setting, \"index.php?module=config-settings&amp;action=edit&amp;sid={$setting['sid']}\");\n\t\t\t\t\t$popup->add_item($lang->delete_setting, \"index.php?module=config-settings&amp;action=delete&amp;sid={$setting['sid']}&amp;my_post_key={$mybb->post_code}\", \"return AdminCP.deleteConfirmation(this, '{$lang->confirm_setting_deletion}')\");\n\t\t\t\t\t$table->construct_cell($popup->fetch(), array('class' => 'align_center'));\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$table->construct_cell('');\n\t\t\t\t}\n\t\t\t\t$table->construct_row(array('no_alt_row' => 1, 'class' => \"group{$group['gid']}\"));\n\t\t\t}\n\t\t}\n\t}\n\n\t$table->output($lang->modify_existing_settings);\n\n\t$buttons[] = $form->generate_submit_button($lang->save_display_orders);\n\t$form->output_submit_wrapper($buttons);\n\t$form->end();\n\n\t$page->output_footer();\n}\n\n// Change settings for a specified group.\nif($mybb->input['action'] == \"change\")\n{\n\t$plugins->run_hooks(\"admin_config_settings_change\");\n\n\tif($mybb->request_method == \"post\")\n\t{\n\t\tif(!is_writable(MYBB_ROOT.'inc/settings.php'))\n\t\t{\n\t\t\tflash_message($lang->error_chmod_settings_file, 'error');\n\t\t\tadmin_redirect(\"index.php?module=config-settings\");\n\t\t}\n\n\t\t// Not allowed to be hidden captcha fields\n\t\t$disallowed_fields = array(\n\t\t\t'username',\n\t\t\t'password',\n\t\t\t'password2',\n\t\t\t'email',\n\t\t\t'email2',\n\t\t\t'imagestring',\n\t\t\t'imagehash',\n\t\t\t'answer',\n\t\t\t'question_id',\n\t\t\t'allownotices',\n\t\t\t'hideemail',\n\t\t\t'receivepms',\n\t\t\t'pmnotice',\n\t\t\t'emailpmnotify',\n\t\t\t'invisible',\n\t\t\t'subscriptionmethod',\n\t\t\t'timezoneoffset',\n\t\t\t'dstcorrection',\n\t\t\t'language',\n\t\t\t'step',\n\t\t\t'action',\n\t\t\t'agree',\n\t\t\t'regtime',\n\t\t\t'regcheck1',\n\t\t\t'regcheck2',\n\t\t\t'regsubmit'\n\t\t);\n\n\t\t$is_current_hiddencaptcha_wrong = in_array($mybb->settings['hiddencaptchaimagefield'], $disallowed_fields);\n\t\tif(\n\t\t\t(isset($mybb->input['upsetting']['hiddencaptchaimagefield']) && in_array($mybb->input['upsetting']['hiddencaptchaimagefield'], $disallowed_fields)) ||\n\t\t\t$is_current_hiddencaptcha_wrong\n\t\t)\n\t\t{\n\t\t\tif(isset($mybb->input['upsetting']['hiddencaptchaimagefield']) && $mybb->input['upsetting']['hiddencaptchaimagefield'] != $mybb->settings['hiddencaptchaimagefield'] && !$is_current_hiddencaptcha_wrong)\n\t\t\t{\n\t\t\t\t$wrong_value = $mybb->input['upsetting']['hiddencaptchaimagefield'];\n\t\t\t\t$mybb->input['upsetting']['hiddencaptchaimagefield'] = $mybb->settings['hiddencaptchaimagefield'];\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$wrong_value = $mybb->settings['hiddencaptchaimagefield'];\n\t\t\t\t$mybb->input['upsetting']['hiddencaptchaimagefield'] = 'email3';\n\t\t\t}\n\n\t\t\t$lang->success_settings_updated .= $lang->sprintf($lang->success_settings_updated_hiddencaptchaimage, htmlspecialchars_uni($mybb->input['upsetting']['hiddencaptchaimagefield']), htmlspecialchars_uni($wrong_value));\n\t\t}\n\n\t\t// Validate avatar dimension inputs\n\t\t$gid = (int)$mybb->input['gid'];\n\t\t$dimfields = array(\n\t\t\t8 => array('postmaxavatarsize'),\n\t\t\t10 => array('useravatardims', 'maxavatardims'),\n\t\t\t13 => array('memberlistmaxavatarsize')\n\t\t);\n\t\tif(in_array($gid, array_keys($dimfields)))\n\t\t{\n\t\t\tforeach($dimfields[$gid] as $field)\n\t\t\t{\n\t\t\t\tif(isset($mybb->input['upsetting'][$field]))\n\t\t\t\t{\n\t\t\t\t\tif(preg_match(\"/\\b\\d+[|x]{1}\\d+\\b/i\", $mybb->input['upsetting'][$field]) || ($field == 'maxavatardims' && trim($mybb->input['upsetting'][$field]) == \"\"))\n\t\t\t\t\t{\n\t\t\t\t\t\t// If pipe (|) is used normalize to 'x'\n\t\t\t\t\t\t$mybb->input['upsetting'][$field] = str_replace('|', 'x', my_strtolower($mybb->input['upsetting'][$field]));\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tflash_message($lang->sprintf($lang->error_format_dimension, $lang->{'error_field_'.$field}), 'error');\n\t\t\t\t\t\tadmin_redirect(\"index.php?module=config-settings&action=change&gid=\".$gid);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Validate minnamelength, maxnamelength, minpasswordlength (complex and regular) and maxpasswordlength\n\t\tif ($gid == 9)\n\t\t{\n\t\t\tif (\n\t\t\t\tisset($mybb->input['upsetting']['minnamelength'], $mybb->input['upsetting']['maxnamelength']) &&\n\t\t\t\t$mybb->input['upsetting']['minnamelength'] > 0 && $mybb->input['upsetting']['maxnamelength'] > 0 &&\n\t\t\t\t$mybb->input['upsetting']['minnamelength'] > $mybb->input['upsetting']['maxnamelength'])\n\t\t\t{\n\t\t\t\tflash_message($lang->error_field_minnamelength, 'error');\n\t\t\t\tadmin_redirect(\"index.php?module=config-settings&action=change&gid=\".$gid);\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\tisset($mybb->input['upsetting']['minpasswordlength'], $mybb->input['upsetting']['maxpasswordlength']) &&\n\t\t\t\t$mybb->input['upsetting']['minpasswordlength'] > 0 && $mybb->input['upsetting']['maxpasswordlength'] > 0 &&\n\t\t\t\t$mybb->input['upsetting']['minpasswordlength'] > $mybb->input['upsetting']['maxpasswordlength']\n\t\t\t)\n\t\t\t{\n\t\t\t\tflash_message($lang->error_field_minpasswordlength, 'error');\n\t\t\t\tadmin_redirect(\"index.php?module=config-settings&action=change&gid=\".$gid);\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\tisset($mybb->input['upsetting']['minpasswordlength'], $mybb->input['upsetting']['requirecomplexpasswords']) &&\n\t\t\t\t$mybb->input['upsetting']['requirecomplexpasswords'] && $mybb->input['upsetting']['minpasswordlength'] < 3\n\t\t\t)\n\t\t\t{\n\t\t\t\tflash_message($lang->error_field_minpasswordlength_complex, 'error');\n\t\t\t\tadmin_redirect(\"index.php?module=config-settings&action=change&gid=\".$gid);\n\t\t\t}\n\t\t}\n\t\t\n\t\trequire_once MYBB_ROOT.'inc/class_captcha.php';\n\t\t\n\t\t// Have we opted for a reCAPTCHA or hCaptcha and not set a public/private key in input?\n\t\t$set_captcha_image = false;\n\t\tif(isset(\n\t\t\t$mybb->input['upsetting']['captchaimage'],\n\t\t\t$mybb->input['upsetting']['recaptchaprivatekey'],\n\t\t\t$mybb->input['upsetting']['recaptchapublickey'],\n\t\t\t$mybb->input['upsetting']['recaptchascore'],\n\t\t\t$mybb->input['upsetting']['hcaptchaprivatekey'],\n\t\t\t$mybb->input['upsetting']['hcaptchapublickey']\n\t\t))\n\t\t{\n\t\t\t$captchaimage = $mybb->input['upsetting']['captchaimage'];\n\t\t\t$recaptchaprivatekey = $mybb->input['upsetting']['recaptchaprivatekey'];\n\t\t\t$recaptchapublickey = $mybb->input['upsetting']['recaptchapublickey'];\n\t\t\t$recaptchascore = $mybb->input['upsetting']['recaptchascore'];\n\t\t\t$hcaptchaprivatekey = $mybb->input['upsetting']['hcaptchaprivatekey'];\n\t\t\t$hcaptchapublickey = $mybb->input['upsetting']['hcaptchapublickey'];\n\n\t\t\tif(in_array($captchaimage, array(captcha::NOCAPTCHA_RECAPTCHA, captcha::RECAPTCHA_INVISIBLE)) && (!$recaptchaprivatekey || !$recaptchapublickey))\n\t\t\t{\n\t\t\t\t$set_captcha_image = true;\n\t\t\t}\n\t\t\telse if(in_array($captchaimage, array(captcha::RECAPTCHA_V3)) && (!$recaptchaprivatekey || !$recaptchapublickey || !$recaptchascore))\n\t\t\t{\n\t\t\t\t$set_captcha_image = true;\n\t\t\t}\n\t\t\telse if(in_array($captchaimage, array(captcha::HCAPTCHA, captcha::HCAPTCHA_INVISIBLE)) && (!$hcaptchaprivatekey || !$hcaptchapublickey))\n\t\t\t{\n\t\t\t\t$set_captcha_image = true;\n\t\t\t}\n\t\t}\n\n\t\t//Checking settings for reCAPTCHA or hCaptcha and public/private key not set?\n\t\t$captchaimage = $mybb->settings['captchaimage'];\n\t\t$recaptchaprivatekey = $mybb->settings['recaptchaprivatekey'];\n\t\t$recaptchapublickey = $mybb->settings['recaptchapublickey'];\n\t\t$recaptchascore = $mybb->settings['recaptchascore'];\n\t\t$hcaptchaprivatekey = $mybb->settings['hcaptchaprivatekey'];\n\t\t$hcaptchapublickey = $mybb->settings['hcaptchapublickey'];\n\n\t\tif(in_array($captchaimage, array(captcha::NOCAPTCHA_RECAPTCHA, captcha::RECAPTCHA_INVISIBLE)) && (!$recaptchaprivatekey || !$recaptchapublickey))\n\t\t{\n\t\t\t$set_captcha_image = true;\n\t\t}\n\t\telse if(in_array($captchaimage, array(captcha::RECAPTCHA_V3)) && (!$recaptchaprivatekey || !$recaptchapublickey || !$recaptchascore))\n\t\t{\n\t\t\t$set_captcha_image = true;\n\t\t}\n\t\telse if(in_array($captchaimage, array(captcha::HCAPTCHA, captcha::HCAPTCHA_INVISIBLE)) && (!$hcaptchaprivatekey || !$hcaptchapublickey))\n\t\t{\n\t\t\t$set_captcha_image = true;\n\t\t}\n\t\tif($set_captcha_image){\n\t\t\t$mybb->input['upsetting']['captchaimage'] = captcha::DEFAULT_CAPTCHA;\n\t\t\t$lang->success_settings_updated .= $lang->success_settings_updated_captchaimage;\n\t\t}\n\n\t\t// If using fulltext then enforce minimum word length given by database\n\t\tif(isset($mybb->input['upsetting']['minsearchword']) && $mybb->input['upsetting']['minsearchword'] > 0 && $mybb->input['upsetting']['searchtype'] == \"fulltext\" && $db->supports_fulltext_boolean(\"posts\") && $db->supports_fulltext(\"threads\"))\n\t\t{\n\t\t\t// Attempt to determine minimum word length from MySQL for fulltext searches\n\t\t\t$query = $db->query(\"SHOW VARIABLES LIKE 'ft_min_word_len';\");\n\t\t\t$min_length = $db->fetch_field($query, 'Value');\n\t\t\tif(is_numeric($min_length) && $mybb->input['upsetting']['minsearchword'] < $min_length)\n\t\t\t{\n\t\t\t\t$mybb->input['upsetting']['minsearchword'] = $min_length;\n\t\t\t\t$lang->success_settings_updated .= $lang->success_settings_updated_minsearchword;\n\t\t\t}\n\t\t}\n\n\t\t// Get settings which optionscode is a forum/group select, checkbox or numeric\n\t\t// We cannot rely on user input to decide this\n\t\t$checkbox_settings = $forum_group_select = $prefix_select = array();\n\t\t$query = $db->simple_select('settings', 'name, optionscode', \"optionscode IN('forumselect', 'groupselect', 'prefixselect') OR optionscode LIKE 'checkbox%' OR optionscode LIKE 'numeric%'\");\n\n\t\twhile($multisetting = $db->fetch_array($query))\n\t\t{\n\t\t\t$options = array();\n\n\t\t\tif(substr($multisetting['optionscode'], 0, 8) == 'checkbox')\n\t\t\t{\n\t\t\t\t$checkbox_settings[] = $multisetting['name'];\n\n\t\t\t\t// All checkboxes deselected = no $mybb->input['upsetting'] for them, we need to initialize it manually then, but only on pages where the setting is shown\n\t\t\t\tif(empty($mybb->input['upsetting'][$multisetting['name']]) && isset($mybb->input[\"isvisible_{$multisetting['name']}\"]))\n\t\t\t\t{\n\t\t\t\t\t$mybb->input['upsetting'][$multisetting['name']] = array();\n\t\t\t\t}\n\t\t\t}\n\t\t\telseif(substr($multisetting['optionscode'], 0, 7) == 'numeric')\n\t\t\t{\n\t\t\t\tif(isset($mybb->input['upsetting'][$multisetting['name']]))\n\t\t\t\t{\n\t\t\t\t\t$type = explode(\"\\n\", $multisetting['optionscode']);\n\t\t\t\t\tfor($i=1; $i < count($type); $i++)\n\t\t\t\t\t{\n\t\t\t\t\t\t$optionsexp = explode(\"=\", $type[$i]);\n\t\t\t\t\t\t$opt = array_map('trim', $optionsexp);\n\t\t\t\t\t\tif(in_array($opt[0], array('min', 'max', 'step')))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif($opt[0] != 'step' || $opt[1] != 'any')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$opt[1] = (float)$opt[1];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t$options[$opt[0]] = $opt[1];\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t$value = (float)$mybb->input['upsetting'][$multisetting['name']];\n\n\t\t\t\t\tif(isset($options['min']))\n\t\t\t\t\t{\n\t\t\t\t\t\t$value = max($value, $options['min']);\n\t\t\t\t\t}\n\n\t\t\t\t\tif(isset($options['max']))\n\t\t\t\t\t{\n\t\t\t\t\t\t$value = min($value, $options['max']);\n\t\t\t\t\t}\n\n\t\t\t\t\t$mybb->input['upsetting'][$multisetting['name']] = $value;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$forum_group_select[] = $multisetting['name'];\n\t\t\t}\n\t\t}\n\n\t\t// Verify for admin email that can't be empty\n\t\tif(isset($mybb->input['upsetting']['adminemail']) && !validate_email_format($mybb->input['upsetting']['adminemail']))\n\t\t{\n\t\t\tunset($mybb->input['upsetting']['adminemail']);\n\t\t\t$lang->success_settings_updated .= $lang->error_admin_email_settings_empty;\n\t\t}\n\n\t\t// Administrator is changing the login method.\n\t\tif(isset($mybb->input['upsetting']['username_method']) && (int)$mybb->input['upsetting']['username_method'] > 0)\n\t\t{\n\t\t\tif((int)$mybb->settings['allowmultipleemails'] == 1)\n\t\t\t{\n\t\t\t\t$mybb->input['upsetting']['username_method'] = 0;\n\t\t\t\t$lang->success_settings_updated .= $lang->success_settings_updated_username_method_conflict;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$query = $db->simple_select('users', 'email', \"email != ''\", array('group_by' => 'email HAVING COUNT(email)>1'));\n\t\t\t\tif($db->num_rows($query))\n\t\t\t\t{\n\t\t\t\t\t$mybb->input['upsetting']['username_method'] = 0;\n\t\t\t\t\t$lang->success_settings_updated .= $lang->success_settings_updated_username_method;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif(isset($mybb->input['upsetting']['username_method'], $mybb->input['upsetting']['allowmultipleemails']))\n\t\t{\n\t\t\t// Administrator is changing registration email allowance\n\t\t\tif((int)$mybb->settings['username_method'] > 0 && (int)$mybb->input['upsetting']['allowmultipleemails'] !== 0)\n\t\t\t{\n\t\t\t\t$mybb->input['upsetting']['allowmultipleemails'] = 0;\n\t\t\t\t$lang->success_settings_updated .= $lang->success_settings_updated_allowmultipleemails;\n\t\t\t}\n\n\t\t\t// Reset conflict silently, if by chance\n\t\t\tif((int)$mybb->settings['username_method'] > 0 && (int)$mybb->settings['allowmultipleemails'] == 1)\n\t\t\t{\n\t\t\t\t$mybb->input['upsetting']['allowmultipleemails'] = 0;\n\t\t\t}\n\t\t}\n\n\t\t// reject dangerous/unsupported upload paths\n\t\t$fields = array(\n\t\t\t'uploadspath',\n\t\t\t'cdnpath',\n\t\t\t'avataruploadpath',\n\t\t);\n\n\t\t$dynamic_include_directories = array(\n\t\t\tMYBB_ROOT.'cache/',\n\t\t\tMYBB_ROOT.'inc/plugins/',\n\t\t\tMYBB_ROOT.'inc/languages/',\n\t\t\tMYBB_ROOT.'inc/tasks/',\n\t\t);\n\t\t$dynamic_include_directories_realpath = array_map('realpath', $dynamic_include_directories);\n\n\t\tforeach($fields as $field)\n\t\t{\n\t\t\tif(isset($mybb->input['upsetting'][$field]))\n\t\t\t{\n\t\t\t\tif(\n\t\t\t\t\tis_string($mybb->input['upsetting'][$field]) &&\n\t\t\t\t\tstrpos($mybb->input['upsetting'][$field], '://') !== false)\n\t\t\t\t{\n\t\t\t\t\tunset($mybb->input['upsetting'][$field]);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\t$realpath = realpath(mk_path_abs($mybb->input['upsetting'][$field]));\n\n\t\t\t\tif ($realpath === false)\n\t\t\t\t{\n\t\t\t\t\tunset($mybb->input['upsetting'][$field]);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tforeach ($dynamic_include_directories_realpath as $forbidden_realpath)\n\t\t\t\t{\n\t\t\t\t\tif ($realpath === $forbidden_realpath || strpos($realpath, $forbidden_realpath.DIRECTORY_SEPARATOR) === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tunset($mybb->input['upsetting'][$field]);\n\t\t\t\t\t\tcontinue 2;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\n\t\tif(is_array($mybb->input['upsetting']))\n\t\t{\n\t\t\tforeach($mybb->input['upsetting'] as $name => $value)\n\t\t\t{\n\t\t\t\tif($forum_group_select && in_array($name, $forum_group_select))\n\t\t\t\t{\n\t\t\t\t\tif($value == 'all')\n\t\t\t\t\t{\n\t\t\t\t\t\t$value = -1;\n\t\t\t\t\t}\n\t\t\t\t\telseif($value == 'custom')\n\t\t\t\t\t{\n\t\t\t\t\t\tif(isset($mybb->input['select'][$name]) && is_array($mybb->input['select'][$name]))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tforeach($mybb->input['select'][$name] as &$val)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$val = (int)$val;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tunset($val);\n\n\t\t\t\t\t\t\t$value = implode(',', $mybb->input['select'][$name]);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$value = '';\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t$value = '';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telseif($checkbox_settings && in_array($name, $checkbox_settings))\n\t\t\t\t{\n\t\t\t\t\t$value = '';\n\n\t\t\t\t\tif(is_array($mybb->input['upsetting'][$name]))\n\t\t\t\t\t{\n\t\t\t\t\t\t$value = implode(',', $mybb->input['upsetting'][$name]);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t$db->update_query(\"settings\", array('value' => $db->escape_string($value)), \"name='\".$db->escape_string($name).\"'\");\n\t\t\t}\n\t\t}\n\n\t\t// Check if we need to create our fulltext index after changing the search mode\n\t\tif(\n\t\t\tisset($mybb->input['upsetting']['searchtype']) &&\n\t\t\t$mybb->settings['searchtype'] != $mybb->input['upsetting']['searchtype'] &&\n\t\t\t$mybb->input['upsetting']['searchtype'] == \"fulltext\"\n\t\t)\n\t\t{\n\t\t\tif(!$db->is_fulltext(\"posts\") && $db->supports_fulltext_boolean(\"posts\"))\n\t\t\t{\n\t\t\t\t$db->create_fulltext_index(\"posts\", \"message\");\n\t\t\t}\n\t\t\tif(!$db->is_fulltext(\"threads\") && $db->supports_fulltext(\"threads\"))\n\t\t\t{\n\t\t\t\t$db->create_fulltext_index(\"threads\", \"subject\");\n\t\t\t}\n\t\t}\n\n\t\t// If the delayedthreadviews setting was changed, enable or disable the tasks for it.\n\t\tif(isset($mybb->input['upsetting']['delayedthreadviews']) && $mybb->settings['delayedthreadviews'] != $mybb->input['upsetting']['delayedthreadviews'])\n\t\t{\n\t\t\t$db->update_query(\"tasks\", array('enabled' => (int)$mybb->input['upsetting']['delayedthreadviews']), \"file='threadviews'\");\n\t\t}\n\n\t\t// Have we changed our cookie prefix? If so, update our adminsid so we're not logged out\n\t\tif(isset($mybb->input['upsetting']['cookieprefix']) && $mybb->input['upsetting']['cookieprefix'] != $mybb->settings['cookieprefix'])\n\t\t{\n\t\t\tmy_unsetcookie(\"adminsid\");\n\t\t\t$mybb->settings['cookieprefix'] = $mybb->input['upsetting']['cookieprefix'];\n\t\t\tmy_setcookie(\"adminsid\", $admin_session['sid'], '', true, \"lax\");\n\t\t}\n\n\t\tif(isset($mybb->input['upsetting']['statstopreferrer']) && $mybb->input['upsetting']['statstopreferrer'] != $mybb->settings['statstopreferrer'])\n\t\t{\n\t\t\t$cache->update_statistics();\n\t\t}\n\n\t\t$statslimit = $mybb->settings['statslimit'];\n\n\t\trebuild_settings();\n\n\t\tif(isset($mybb->input['upsetting']['statslimit']) && $mybb->input['upsetting']['statslimit'] != $statslimit)\n\t\t{\n\t\t\t$cache->update_most_replied_threads();\n\t\t\t$cache->update_most_viewed_threads();\n\t\t}\n\n\t\t$plugins->run_hooks(\"admin_config_settings_change_commit\");\n\n\t\t// Log admin action\n\t\tlog_admin_action();\n\n\t\tflash_message($lang->success_settings_updated, 'success');\n\t\tadmin_redirect(\"index.php?module=config-settings\");\n\t}\n\n\t// What type of page\n\t$cache_groups = $cache_settings = array();\n\tif(isset($mybb->input['search']))\n\t{\n\t\t// Search\n\n\t\t// Search for settings\n\t\t$search = trim($mybb->input['search']);\n\t\tif(!empty($search))\n\t\t{\n\t\t\t$query = $db->query(\"\n\t\t\t\tSELECT s.* , g.name as gname, g.title as gtitle, g.description as gdescription\n\t\t\t\tFROM \".TABLE_PREFIX.\"settings s\n\t\t\t\tLEFT JOIN \".TABLE_PREFIX.\"settinggroups g ON(s.gid=g.gid)\n\t\t\t\tORDER BY s.disporder\n\t\t\t\");\n\t\t\twhile($setting = $db->fetch_array($query))\n\t\t\t{\n\t\t\t\t$search_in = $setting['name'] . ' ' . $setting['title'] . ' ' . $setting['description'] . ' ' . $setting['gname'] . ' ' . $setting['gtitle'] . ' ' . $setting['gdescription'];\n\t\t\t\tforeach(array(\"setting_{$setting['name']}\", \"setting_{$setting['name']}_desc\", \"setting_group_{$setting['gname']}\", \"setting_group_{$setting['gname']}_desc\") as $search_in_lang_key)\n\t\t\t\t{\n\t\t\t\t\tif(!empty($lang->$search_in_lang_key))\n\t\t\t\t\t{\n\t\t\t\t\t\t$search_in .= ' ' . $lang->$search_in_lang_key;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif(my_stripos($search_in, $search) !== false)\n\t\t\t\t{\n\t\t\t\t\t$cache_settings[$setting['gid']][$setting['sid']] = $setting;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif(!count($cache_settings))\n\t\t{\n\t\t\tif(isset($mybb->input['ajax_search']))\n\t\t\t{\n\t\t\t\techo json_encode(array(\"errors\" => array($lang->error_no_settings_found)));\n\t\t\t\texit;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tflash_message($lang->error_no_settings_found, 'error');\n\t\t\t\tadmin_redirect(\"index.php?module=config-settings\");\n\t\t\t}\n\t\t}\n\n\t\t// Cache groups\n\t\t$groups = array_keys($cache_settings);\n\t\t$groups = implode(',', $groups);\n\t\t$query = $db->simple_select(\"settinggroups\", \"*\", \"gid IN ({$groups})\", array('order_by' => 'disporder'));\n\t\twhile($group = $db->fetch_array($query))\n\t\t{\n\t\t\t$cache_groups[$group['gid']] = $group;\n\t\t}\n\n\t\t// Page header only if not AJAX\n\t\tif(!isset($mybb->input['ajax_search']))\n\t\t{\n\t\t\t$page->add_breadcrumb_item($lang->settings_search);\n\t\t\t$page->output_header($lang->board_settings.\" - {$lang->settings_search}\");\n\t\t}\n\t}\n\telseif(($mybb->get_input('gid')))\n\t{\n\t\t// Group listing\n\t\t// Cache groups\n\t\t$query = $db->simple_select(\"settinggroups\", \"*\", \"gid = '\".$mybb->get_input('gid', MyBB::INPUT_INT).\"'\");\n\t\t$groupinfo = $db->fetch_array($query);\n\t\t$cache_groups[$groupinfo['gid']] = $groupinfo;\n\n\t\tif(!$db->num_rows($query))\n\t\t{\n\t\t\t$page->output_error($lang->error_invalid_gid2);\n\t\t}\n\n\t\t// Cache settings\n\t\t$query = $db->simple_select(\"settings\", \"*\", \"gid='\".$mybb->get_input('gid', MyBB::INPUT_INT).\"'\", array('order_by' => 'disporder'));\n\t\twhile($setting = $db->fetch_array($query))\n\t\t{\n\t\t\t$cache_settings[$setting['gid']][$setting['sid']] = $setting;\n\t\t}\n\n\t\tif(!$db->num_rows($query))\n\t\t{\n\t\t\tflash_message($lang->error_no_settings_found, 'error');\n\t\t\tadmin_redirect(\"index.php?module=config-settings\");\n\t\t}\n\n\t\t$group_lang_var = \"setting_group_{$groupinfo['name']}\";\n\t\tif(isset($lang->$group_lang_var))\n\t\t{\n\t\t\t$groupinfo['title'] = $lang->$group_lang_var;\n\t\t}\n\n\t\t// Page header\n\t\t$page->add_breadcrumb_item($groupinfo['title']);\n\t\t$page->output_header($lang->board_settings.\" - {$groupinfo['title']}\");\n\t}\n\telse\n\t{\n\t\t// All settings list\n\t\t// Cache groups\n\t\t$query = $db->simple_select(\"settinggroups\", \"*\", \"\", array('order_by' => 'disporder'));\n\t\twhile($group = $db->fetch_array($query))\n\t\t{\n\t\t\t$cache_groups[$group['gid']] = $group;\n\t\t}\n\n\t\tif(!$db->num_rows($query))\n\t\t{\n\t\t\t$page->output_error($lang->error_invalid_gid2);\n\t\t}\n\n\t\t// Cache settings\n\t\t$query = $db->simple_select(\"settings\", \"*\", \"\", array('order_by' => 'disporder'));\n\t\twhile($setting = $db->fetch_array($query))\n\t\t{\n\t\t\t$cache_settings[$setting['gid']][$setting['sid']] = $setting;\n\t\t}\n\n\t\t// Page header\n\t\t$page->add_breadcrumb_item($lang->show_all_settings);\n\t\t$page->output_header($lang->board_settings.\" - {$lang->show_all_settings}\");\n\t}\n\n\t// Build individual forms as per settings group\n\tforeach($cache_groups as $groupinfo)\n\t{\n\t\t$form = new Form(\"index.php?module=config-settings&amp;action=change\", \"post\", \"change\");\n\t\techo $form->generate_hidden_field(\"gid\", $groupinfo['gid']);\n\t\t$buttons = array($form->generate_submit_button($lang->save_settings));\n\t\t$group_lang_var = \"setting_group_{$groupinfo['name']}\";\n\t\tif(isset($lang->$group_lang_var))\n\t\t{\n\t\t\t$groupinfo['title'] = $lang->$group_lang_var;\n\t\t}\n\n\t\t$form_container = new FormContainer($groupinfo['title']);\n\n\t\tif(empty($cache_settings[$groupinfo['gid']]))\n\t\t{\n\t\t\t$form_container->output_cell($lang->error_no_settings_found);\n\t\t\t$form_container->construct_row();\n\n\t\t\t$form_container->end();\n\t\t\techo '<br />';\n\n\t\t\tcontinue;\n\t\t}\n\n\t\tforeach($cache_settings[$groupinfo['gid']] as $setting)\n\t\t{\n\t\t\t$options = \"\";\n\t\t\t$type = explode(\"\\n\", $setting['optionscode']);\n\t\t\t$type[0] = trim($type[0]);\n\t\t\t$element_name = \"upsetting[{$setting['name']}]\";\n\t\t\t$element_id = \"setting_{$setting['name']}\";\n\t\t\tif($type[0] == \"text\" || $type[0] == \"\")\n\t\t\t{\n\t\t\t\t$setting_code = $form->generate_text_box($element_name, $setting['value'], array('id' => $element_id));\n\t\t\t}\n\t\t\telse if($type[0] == \"numeric\")\n\t\t\t{\n\t\t\t\t$field_options = array('id' => $element_id);\n\t\t\t\tif(count($type) > 1)\n\t\t\t\t{\n\t\t\t\t\tfor($i=1; $i < count($type); $i++)\n\t\t\t\t\t{\n\t\t\t\t\t\t$optionsexp = explode(\"=\", $type[$i]);\n\t\t\t\t\t\t$opt = array_map('trim', $optionsexp);\n\t\t\t\t\t\tif(in_array($opt[0], array('min', 'max', 'step')))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif($opt[0] != 'step' || $opt[1] != 'any')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$opt[1] = (float)$opt[1];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t$field_options[$opt[0]] = $opt[1];\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t$setting_code = $form->generate_numeric_field($element_name, $setting['value'], $field_options);\n\t\t\t}\n\t\t\telse if($type[0] == \"textarea\")\n\t\t\t{\n\t\t\t\t$setting_code = $form->generate_text_area($element_name, $setting['value'], array('id' => $element_id));\n\t\t\t}\n\t\t\telse if($type[0] == \"yesno\")\n\t\t\t{\n\t\t\t\t$setting_code = $form->generate_yes_no_radio($element_name, $setting['value'], true, array('id' => $element_id.'_yes', 'class' => $element_id), array('id' => $element_id.'_no', 'class' => $element_id));\n\t\t\t}\n\t\t\telse if($type[0] == \"onoff\")\n\t\t\t{\n\t\t\t\t$setting_code = $form->generate_on_off_radio($element_name, $setting['value'], true, array('id' => $element_id.'_on', 'class' => $element_id), array('id' => $element_id.'_off', 'class' => $element_id));\n\t\t\t}\n\t\t\telse if($type[0] == \"cpstyle\")\n\t\t\t{\n\t\t\t\t$dir = @opendir(MYBB_ROOT.$config['admin_dir'].\"/styles\");\n\n\t\t\t\t$folders = array();\n\t\t\t\twhile($folder = readdir($dir))\n\t\t\t\t{\n\t\t\t\t\tif($folder != \".\" && $folder != \"..\" && @file_exists(MYBB_ROOT.$config['admin_dir'].\"/styles/$folder/main.css\"))\n\t\t\t\t\t{\n\t\t\t\t\t\t$folders[$folder] = ucfirst($folder);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tclosedir($dir);\n\t\t\t\tksort($folders);\n\t\t\t\t$setting_code = $form->generate_select_box($element_name, $folders, $setting['value'], array('id' => $element_id));\n\t\t\t}\n\t\t\telse if($type[0] == \"language\")\n\t\t\t{\n\t\t\t\t$languages = $lang->get_languages();\n\t\t\t\t$setting_code = $form->generate_select_box($element_name, $languages, $setting['value'], array('id' => $element_id));\n\t\t\t}\n\t\t\telse if($type[0] == \"adminlanguage\")\n\t\t\t{\n\t\t\t\t$languages = $lang->get_languages(1);\n\t\t\t\t$setting_code = $form->generate_select_box($element_name, $languages, $setting['value'], array('id' => $element_id));\n\t\t\t}\n\t\t\telse if($type[0] == \"passwordbox\")\n\t\t\t{\n\t\t\t\t$setting_code = $form->generate_password_box($element_name, $setting['value'], array('id' => $element_id));\n\t\t\t}\n\t\t\telse if($type[0] == \"php\")\n\t\t\t{\n\t\t\t\t$setting['optionscode'] = substr($setting['optionscode'], 3);\n\t\t\t\teval(\"\\$setting_code = \\\"\".$setting['optionscode'].\"\\\";\");\n\t\t\t}\n\t\t\telse if($type[0] == \"forumselect\")\n\t\t\t{\n\t\t\t\t$selected_values = '';\n\t\t\t\tif($setting['value'] != '' && $setting['value'] != -1)\n\t\t\t\t{\n\t\t\t\t\t$selected_values = explode(',', (string)$setting['value']);\n\n\t\t\t\t\tforeach($selected_values as &$value)\n\t\t\t\t\t{\n\t\t\t\t\t\t$value = (int)$value;\n\t\t\t\t\t}\n\t\t\t\t\tunset($value);\n\t\t\t\t}\n\n\t\t\t\t$forum_checked = array('all' => '', 'custom' => '', 'none' => '');\n\t\t\t\tif($setting['value'] == -1)\n\t\t\t\t{\n\t\t\t\t\t$forum_checked['all'] = 'checked=\"checked\"';\n\t\t\t\t}\n\t\t\t\telseif($setting['value'] != '')\n\t\t\t\t{\n\t\t\t\t\t$forum_checked['custom'] = 'checked=\"checked\"';\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$forum_checked['none'] = 'checked=\"checked\"';\n\t\t\t\t}\n\n\t\t\t\tprint_selection_javascript();\n\n\t\t\t\t$setting_code = \"\n\t\t\t\t<dl style=\\\"margin-top: 0; margin-bottom: 0; width: 100%\\\">\n\t\t\t\t\t<dt><label style=\\\"display: block;\\\"><input type=\\\"radio\\\" name=\\\"{$element_name}\\\" value=\\\"all\\\" {$forum_checked['all']} class=\\\"{$element_id}_forums_groups_check\\\" onclick=\\\"checkAction('{$element_id}');\\\" style=\\\"vertical-align: middle;\\\" /> <strong>{$lang->all_forums}</strong></label></dt>\n\t\t\t\t\t<dt><label style=\\\"display: block;\\\"><input type=\\\"radio\\\" name=\\\"{$element_name}\\\" value=\\\"custom\\\" {$forum_checked['custom']} class=\\\"{$element_id}_forums_groups_check\\\" onclick=\\\"checkAction('{$element_id}');\\\" style=\\\"vertical-align: middle;\\\" /> <strong>{$lang->select_forums}</strong></label></dt>\n\t\t\t\t\t<dd style=\\\"margin-top: 4px;\\\" id=\\\"{$element_id}_forums_groups_custom\\\" class=\\\"{$element_id}_forums_groups\\\">\n\t\t\t\t\t\t<table cellpadding=\\\"4\\\">\n\t\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t\t<td valign=\\\"top\\\"><small>{$lang->forums_colon}</small></td>\n\t\t\t\t\t\t\t\t<td>\".$form->generate_forum_select('select['.$setting['name'].'][]', $selected_values, array('id' => $element_id, 'multiple' => true, 'size' => 5)).\"</td>\n\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t</table>\n\t\t\t\t\t</dd>\n\t\t\t\t\t<dt><label style=\\\"display: block;\\\"><input type=\\\"radio\\\" name=\\\"{$element_name}\\\" value=\\\"none\\\" {$forum_checked['none']} class=\\\"{$element_id}_forums_groups_check\\\" onclick=\\\"checkAction('{$element_id}');\\\" style=\\\"vertical-align: middle;\\\" /> <strong>{$lang->none}</strong></label></dt>\n\t\t\t\t</dl>\n\t\t\t\t<script type=\\\"text/javascript\\\">\n\t\t\t\t\tcheckAction('{$element_id}');\n\t\t\t\t</script>\";\n\t\t\t}\n\t\t\telse if($type[0] == \"forumselectsingle\")\n\t\t\t{\n\t\t\t\t$selected_value = (int)$setting['value']; // No need to check if empty, int will give 0\n\t\t\t\t$setting_code = $form->generate_forum_select($element_name, $selected_value, array('id' => $element_id, 'main_option' => $lang->none));\n\t\t\t}\n\t\t\telse if($type[0] == \"groupselect\")\n\t\t\t{\n\t\t\t\t$selected_values = '';\n\t\t\t\tif($setting['value'] != '' && $setting['value'] != -1)\n\t\t\t\t{\n\t\t\t\t\t$selected_values = explode(',', (string)$setting['value']);\n\n\t\t\t\t\tforeach($selected_values as &$value)\n\t\t\t\t\t{\n\t\t\t\t\t\t$value = (int)$value;\n\t\t\t\t\t}\n\t\t\t\t\tunset($value);\n\t\t\t\t}\n\n\t\t\t\t$group_checked = array('all' => '', 'custom' => '', 'none' => '');\n\t\t\t\tif($setting['value'] == -1)\n\t\t\t\t{\n\t\t\t\t\t$group_checked['all'] = 'checked=\"checked\"';\n\t\t\t\t}\n\t\t\t\telseif($setting['value'] != '')\n\t\t\t\t{\n\t\t\t\t\t$group_checked['custom'] = 'checked=\"checked\"';\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$group_checked['none'] = 'checked=\"checked\"';\n\t\t\t\t}\n\n\t\t\t\tprint_selection_javascript();\n\n\t\t\t\t$setting_code = \"\n\t\t\t\t<dl style=\\\"margin-top: 0; margin-bottom: 0; width: 100%\\\">\n\t\t\t\t\t<dt><label style=\\\"display: block;\\\"><input type=\\\"radio\\\" name=\\\"{$element_name}\\\" value=\\\"all\\\" {$group_checked['all']} class=\\\"{$element_id}_forums_groups_check\\\" onclick=\\\"checkAction('{$element_id}');\\\" style=\\\"vertical-align: middle;\\\" /> <strong>{$lang->all_groups}</strong></label></dt>\n\t\t\t\t\t<dt><label style=\\\"display: block;\\\"><input type=\\\"radio\\\" name=\\\"{$element_name}\\\" value=\\\"custom\\\" {$group_checked['custom']} class=\\\"{$element_id}_forums_groups_check\\\" onclick=\\\"checkAction('{$element_id}');\\\" style=\\\"vertical-align: middle;\\\" /> <strong>{$lang->select_groups}</strong></label></dt>\n\t\t\t\t\t<dd style=\\\"margin-top: 4px;\\\" id=\\\"{$element_id}_forums_groups_custom\\\" class=\\\"{$element_id}_forums_groups\\\">\n\t\t\t\t\t\t<table cellpadding=\\\"4\\\">\n\t\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t\t<td valign=\\\"top\\\"><small>{$lang->groups_colon}</small></td>\n\t\t\t\t\t\t\t\t<td>\".$form->generate_group_select('select['.$setting['name'].'][]', $selected_values, array('id' => $element_id, 'multiple' => true, 'size' => 5)).\"</td>\n\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t</table>\n\t\t\t\t\t</dd>\n\t\t\t\t\t<dt><label style=\\\"display: block;\\\"><input type=\\\"radio\\\" name=\\\"{$element_name}\\\" value=\\\"none\\\" {$group_checked['none']} class=\\\"{$element_id}_forums_groups_check\\\" onclick=\\\"checkAction('{$element_id}');\\\" style=\\\"vertical-align: middle;\\\" /> <strong>{$lang->none}</strong></label></dt>\n\t\t\t\t</dl>\n\t\t\t\t<script type=\\\"text/javascript\\\">\n\t\t\t\t\tcheckAction('{$element_id}');\n\t\t\t\t</script>\";\n\t\t\t}\n\t\t\telse if($type[0] == \"groupselectsingle\")\n\t\t\t{\n\t\t\t\t$selected_value = (int)$setting['value']; // No need to check if empty, int will give 0\n\t\t\t\t$setting_code = $form->generate_group_select($element_name, $selected_value, array('id' => $element_id, 'main_option' => $lang->none));\n\t\t\t}\n\t\t\telse if($type[0] == \"prefixselect\")\n\t\t\t{\n\t\t\t\t$selected_values = '';\n\t\t\t\tif($setting['value'] != '' && $setting['value'] != -1)\n\t\t\t\t{\n\t\t\t\t\t$selected_values = explode(',', (string)$setting['value']);\n\t\t\t\t\tforeach($selected_values as &$value)\n\t\t\t\t\t{\n\t\t\t\t\t\t$value = (int)$value;\n\t\t\t\t\t}\n\t\t\t\t\tunset($value);\n\t\t\t\t}\n\t\t\t\t$prefix_checked = array('all' => '', 'custom' => '', 'none' => '');\n\t\t\t\tif($setting['value'] == -1)\n\t\t\t\t{\n\t\t\t\t\t$prefix_checked['all'] = 'checked=\"checked\"';\n\t\t\t\t}\n\t\t\t\telseif($setting['value'] != '')\n\t\t\t\t{\n\t\t\t\t\t$prefix_checked['custom'] = 'checked=\"checked\"';\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$prefix_checked['none'] = 'checked=\"checked\"';\n\t\t\t\t}\n\t\t\t\tprint_selection_javascript();\n\t\t\t\t$setting_code = \"\n\t\t\t\t<dl style=\\\"margin-top: 0; margin-bottom: 0; width: 100%\\\">\n\t\t\t\t\t<dt><label style=\\\"display: block;\\\"><input type=\\\"radio\\\" name=\\\"{$element_name}\\\" value=\\\"all\\\" {$prefix_checked['all']} class=\\\"{$element_id}_forums_groups_check\\\" onclick=\\\"checkAction('{$element_id}');\\\" style=\\\"vertical-align: middle;\\\" /> <strong>{$lang->all_prefix}</strong></label></dt>\n\t\t\t\t\t<dt><label style=\\\"display: block;\\\"><input type=\\\"radio\\\" name=\\\"{$element_name}\\\" value=\\\"custom\\\" {$prefix_checked['custom']} class=\\\"{$element_id}_forums_groups_check\\\" onclick=\\\"checkAction('{$element_id}');\\\" style=\\\"vertical-align: middle;\\\" /> <strong>{$lang->select_prefix}</strong></label></dt>\n\t\t\t\t\t<dd style=\\\"margin-top: 4px;\\\" id=\\\"{$element_id}_forums_groups_custom\\\" class=\\\"{$element_id}_forums_groups\\\">\n\t\t\t\t\t\t<table cellpadding=\\\"4\\\">\n\t\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t\t<td valign=\\\"top\\\"><small>{$lang->prefix_colon}</small></td>\n\t\t\t\t\t\t\t\t<td>\".$form->generate_prefix_select('select['.$setting['name'].'][]', $selected_values, array('id' => $element_id, 'multiple' => true, 'size' => 5)).\"</td>\n\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t</table>\n\t\t\t\t\t</dd>\n\t\t\t\t\t<dt><label style=\\\"display: block;\\\"><input type=\\\"radio\\\" name=\\\"{$element_name}\\\" value=\\\"none\\\" {$prefix_checked['none']} class=\\\"{$element_id}_forums_groups_check\\\" onclick=\\\"checkAction('{$element_id}');\\\" style=\\\"vertical-align: middle;\\\" /> <strong>{$lang->none}</strong></label></dt>\n\t\t\t\t</dl>\n\t\t\t\t<script type=\\\"text/javascript\\\">\n\t\t\t\t\tcheckAction('{$element_id}');\n\t\t\t\t</script>\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$typecount = count($type);\n\n\t\t\t\tif($type[0] == 'checkbox')\n\t\t\t\t{\n\t\t\t\t\t$multivalue = explode(',', $setting['value']);\n\t\t\t\t}\n\n\t\t\t\tfor($i = 0; $i < $typecount; $i++)\n\t\t\t\t{\n\t\t\t\t\t$optionsexp = explode(\"=\", $type[$i]);\n\t\t\t\t\tif(!isset($optionsexp[1]))\n\t\t\t\t\t{\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t\t$title_lang = \"setting_{$setting['name']}_{$optionsexp[0]}\";\n\t\t\t\t\tif(isset($lang->$title_lang))\n\t\t\t\t\t{\n\t\t\t\t\t\t$optionsexp[1] = $lang->$title_lang;\n\t\t\t\t\t}\n\n\t\t\t\t\tif($type[0] == \"select\")\n\t\t\t\t\t{\n\t\t\t\t\t\t$option_list[$optionsexp[0]] = htmlspecialchars_uni($optionsexp[1]);\n\t\t\t\t\t}\n\t\t\t\t\telse if($type[0] == \"radio\")\n\t\t\t\t\t{\n\t\t\t\t\t\tif($setting['value'] == $optionsexp[0])\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$option_list[$i] = $form->generate_radio_button($element_name, $optionsexp[0], htmlspecialchars_uni($optionsexp[1]), array('id' => $element_id.'_'.$i, \"checked\" => 1, 'class' => $element_id));\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$option_list[$i] = $form->generate_radio_button($element_name, $optionsexp[0], htmlspecialchars_uni($optionsexp[1]), array('id' => $element_id.'_'.$i, 'class' => $element_id));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse if($type[0] == \"checkbox\")\n\t\t\t\t\t{\n\t\t\t\t\t\tif(in_array($optionsexp[0], $multivalue))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$option_list[$i] = $form->generate_check_box(\"{$element_name}[]\", $optionsexp[0], htmlspecialchars_uni($optionsexp[1]), array('id' => $element_id.'_'.$i, \"checked\" => 1, 'class' => $element_id));\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$option_list[$i] = $form->generate_check_box(\"{$element_name}[]\", $optionsexp[0], htmlspecialchars_uni($optionsexp[1]), array('id' => $element_id.'_'.$i, 'class' => $element_id));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif($type[0] == \"select\")\n\t\t\t\t{\n\t\t\t\t\t$setting_code = $form->generate_select_box($element_name, $option_list, $setting['value'], array('id' => $element_id));\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$setting_code = implode(\"<br />\", $option_list);\n\n\t\t\t\t\tif($type[0] == 'checkbox')\n\t\t\t\t\t{\n\t\t\t\t\t\t$setting_code .= $form->generate_hidden_field(\"isvisible_{$setting['name']}\", 1);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t$option_list = array();\n\t\t\t}\n\n\t\t\t// Do we have a custom language variable for this title or description?\n\t\t\t$title_lang = \"setting_\".$setting['name'];\n\t\t\t$desc_lang = $title_lang.\"_desc\";\n\t\t\tif(isset($lang->$title_lang))\n\t\t\t{\n\t\t\t\t$setting['title'] = $lang->$title_lang;\n\t\t\t}\n\t\t\tif(isset($lang->$desc_lang))\n\t\t\t{\n\t\t\t\t$setting['description'] = $lang->$desc_lang;\n\t\t\t}\n\t\t\t$form_container->output_row(htmlspecialchars_uni($setting['title']), $setting['description'], $setting_code, '', array(), array('id' => 'row_'.$element_id));\n\t\t}\n\t\t$form_container->end();\n\n\t\t$form->output_submit_wrapper($buttons);\n\t\t$form->end();\n\t\techo '<br />';\n\t}\n\n\tprint_setting_peekers();\n\n\tif(!isset($mybb->input['ajax_search']))\n\t{\n\t\t$page->output_footer();\n\t}\n}\n\nif(!$mybb->input['action'])\n{\n\t$plugins->run_hooks(\"admin_config_settings_start\");\n\n\t$page->extra_header .= <<<EOF\n\t<script type=\"text/javascript\">\n\t<!--\n\tlang.searching = \"{$lang->searching}\";\n\tlang.search_error = \"{$lang->search_error}\";\n\tlang.search_done = \"{$lang->search_done}\";\n\t// -->\n\t</script>\nEOF;\n\n\t$page->output_header($lang->board_settings);\n\tif(isset($message))\n\t{\n\t\t$page->output_inline_message($message);\n\t}\n\n\t$sub_tabs['change_settings'] = array(\n\t\t'title' => $lang->change_settings,\n\t\t'link' => \"index.php?module=config-settings\",\n\t\t'description' => $lang->change_settings_desc\n\t);\n\n\t$sub_tabs['add_setting'] = array(\n\t\t'title' => $lang->add_new_setting,\n\t\t'link' => \"index.php?module=config-settings&amp;action=add\"\n\t);\n\n\t$sub_tabs['add_setting_group'] = array(\n\t\t'title' => $lang->add_new_setting_group,\n\t\t'link' => \"index.php?module=config-settings&amp;action=addgroup\"\n\t);\n\n\t$sub_tabs['modify_setting'] = array(\n\t\t'title' => $lang->modify_existing_settings,\n\t\t'link' => \"index.php?module=config-settings&amp;action=manage\",\n\t);\n\n\t$page->output_nav_tabs($sub_tabs, 'change_settings');\n\n\t// Search form\n\techo \"<div style=\\\"text-align: right; margin-bottom: 3px;\\\">\";\n\t$search = new Form(\"index.php\", 'get', 'settings_search', 0, 'settings_search');\n\techo $search->generate_hidden_field('module', 'config/settings');\n\techo $search->generate_hidden_field('action', 'change');\n\techo $search->generate_text_box('search', $lang->settings_search, array('id' => 'search', 'class' => 'search_default field150 field_small'));\n\techo \"<input type=\\\"submit\\\" class=\\\"search_button\\\" value=\\\"{$lang->search}\\\" />\";\n\t$search->end();\n\techo \"</div>\\n\";\n\n\techo '<div id=\"search_results\">&nbsp;</div><div id=\"group_list\">';\n\t$table = new Table;\n\t$table->construct_header($lang->setting_groups);\n\n\tswitch($db->type)\n\t{\n\t\tcase \"pgsql\":\n\t\t$query = $db->query(\"\n\t\t\tSELECT g.*, COUNT(s.sid) AS settingcount\n\t\t\tFROM \".TABLE_PREFIX.\"settinggroups g\n\t\t\tLEFT JOIN \".TABLE_PREFIX.\"settings s ON (s.gid=g.gid)\n\t\t\tWHERE g.isdefault = 1\n\t\t\tGROUP BY \".$db->build_fields_string(\"settinggroups\", \"g.\").\"\n\t\t\tORDER BY g.disporder\n\t\t\");\n\t\tbreak;\n\t\tdefault:\n\t\t$query = $db->query(\"\n\t\t\tSELECT g.*, COUNT(s.sid) AS settingcount\n\t\t\tFROM \".TABLE_PREFIX.\"settinggroups g\n\t\t\tLEFT JOIN \".TABLE_PREFIX.\"settings s ON (s.gid=g.gid)\n\t\t\tWHERE g.isdefault = 1\n\t\t\tGROUP BY g.gid\n\t\t\tORDER BY g.disporder\n\t\t\");\n\t}\n\twhile($group = $db->fetch_array($query))\n\t{\n\t\t$group_lang_var = \"setting_group_{$group['name']}\";\n\t\tif(isset($lang->$group_lang_var))\n\t\t{\n\t\t\t$group_title = htmlspecialchars_uni($lang->$group_lang_var);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$group_title = htmlspecialchars_uni($group['title']);\n\t\t}\n\n\t\t$group_desc_lang_var = \"setting_group_{$group['name']}_desc\";\n\t\tif(isset($lang->$group_desc_lang_var))\n\t\t{\n\t\t\t$group_desc = htmlspecialchars_uni($lang->$group_desc_lang_var);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$group_desc = htmlspecialchars_uni($group['description']);\n\t\t}\n\n\t\t$table->construct_cell(\"<strong><a href=\\\"index.php?module=config-settings&amp;action=change&amp;gid={$group['gid']}\\\">{$group_title}</a></strong> ({$group['settingcount']} {$lang->bbsettings})<br /><small>{$group_desc}</small>\");\n\t\t$table->construct_row();\n\t}\n\n\t$table->output(\"<span style=\\\"float: right;\\\"><small><a href=\\\"index.php?module=config-settings&amp;action=change\\\">{$lang->show_all_settings}</a></small></span>{$lang->board_settings}\");\n\n\t// Plugin Settings\n\tswitch($db->type)\n\t{\n\t\tcase \"pgsql\":\n\t\t$query = $db->query(\"\n\t\t\tSELECT g.*, COUNT(s.sid) AS settingcount\n\t\t\tFROM \".TABLE_PREFIX.\"settinggroups g\n\t\t\tLEFT JOIN \".TABLE_PREFIX.\"settings s ON (s.gid=g.gid)\n\t\t\tWHERE g.isdefault <> 1\n\t\t\tGROUP BY \".$db->build_fields_string(\"settinggroups\", \"g.\").\"\n\t\t\tORDER BY g.disporder\n\t\t\");\n\t\tbreak;\n\t\tdefault:\n\t\t$query = $db->query(\"\n\t\t\tSELECT g.*, COUNT(s.sid) AS settingcount\n\t\t\tFROM \".TABLE_PREFIX.\"settinggroups g\n\t\t\tLEFT JOIN \".TABLE_PREFIX.\"settings s ON (s.gid=g.gid)\n\t\t\tWHERE g.isdefault <> 1\n\t\t\tGROUP BY g.gid\n\t\t\tORDER BY g.disporder\n\t\t\");\n\t}\n\n\tif($db->num_rows($query))\n\t{\n\t\t$table = new Table;\n\t\t$table->construct_header($lang->setting_groups);\n\n\t\twhile($group = $db->fetch_array($query))\n\t\t{\n\t\t\t$group_lang_var = \"setting_group_{$group['name']}\";\n\t\t\tif(isset($lang->$group_lang_var))\n\t\t\t{\n\t\t\t\t$group_title = htmlspecialchars_uni($lang->$group_lang_var);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$group_title = htmlspecialchars_uni($group['title']);\n\t\t\t}\n\n\t\t\t$group_desc_lang_var = \"setting_group_{$group['name']}_desc\";\n\t\t\tif(isset($lang->$group_desc_lang_var))\n\t\t\t{\n\t\t\t\t$group_desc = htmlspecialchars_uni($lang->$group_desc_lang_var);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$group_desc = htmlspecialchars_uni($group['description']);\n\t\t\t}\n\n\t\t\t$table->construct_cell(\"<strong><a href=\\\"index.php?module=config-settings&amp;action=change&amp;gid={$group['gid']}\\\">{$group_title}</a></strong> ({$group['settingcount']} {$lang->bbsettings})<br /><small>{$group_desc}</small>\");\n\t\t\t$table->construct_row();\n\t\t}\n\n\t\t$table->output($lang->plugin_settings);\n\t}\n\n\techo '</div>';\n\n\techo '\n<script type=\"text/javascript\" src=\"./jscripts/search.js?ver=1821\"></script>\n<script type=\"text/javascript\">\n//<!--\n$(function(){\n\tSettingSearch.init(\"'.$lang->settings_search.'\",\"'.$lang->error_ajax_unknown.'\");\n});\n//-->\n</script>';\n\n\tprint_setting_peekers();\n\t$page->output_footer();\n}\n\n/**\n * Print all the peekers for all of the default settings\n */\nfunction print_setting_peekers()\n{\n\tglobal $plugins;\n\n\t$peekers = array(\n\t\t'new Peeker($(\".setting_boardclosed\"), $(\"#row_setting_boardclosed_reason\"), 1, true)',\n\t\t'new Peeker($(\".setting_gzipoutput\"), $(\"#row_setting_gziplevel\"), 1, true)',\n\t\t'new Peeker($(\".setting_useerrorhandling\"), $(\"#row_setting_errorlogmedium, #row_setting_errorloglocation\"), 1, true)',\n\t\t'new Peeker($(\"#setting_subforumsindex\"), $(\"#row_setting_subforumsstatusicons\"), /[^0+|]/, false)',\n\t\t'new Peeker($(\".setting_showsimilarthreads\"), $(\"#row_setting_similarityrating, #row_setting_similarlimit\"), 1, true)',\n\t\t'new Peeker($(\".setting_disableregs\"), $(\"#row_setting_regtype, #row_setting_securityquestion, #row_setting_regtime, #row_setting_allowmultipleemails, #row_setting_hiddencaptchaimage, #row_setting_betweenregstime\"), 0, true)',\n\t\t'new Peeker($(\".setting_hiddencaptchaimage\"), $(\"#row_setting_hiddencaptchaimagefield\"), 1, true)',\n\t\t'new Peeker($(\"#setting_failedlogincount\"), $(\"#row_setting_failedlogintime, #row_setting_failedlogintext\"), /[^0+|]/, false)',\n\t\t'new Peeker($(\".setting_postfloodcheck\"), $(\"#row_setting_postfloodsecs\"), 1, true)',\n\t\t'new Peeker($(\"#setting_postmergemins\"), $(\"#row_setting_postmergefignore, #row_setting_postmergeuignore, #row_setting_postmergesep\"), /[^0+|]/, false)',\n\t\t'new Peeker($(\".setting_enablememberlist\"), $(\"#row_setting_membersperpage, #row_setting_default_memberlist_sortby, #row_setting_default_memberlist_order, #row_setting_memberlistmaxavatarsize\"), 1, true)',\n\t\t'new Peeker($(\".setting_enablereputation\"), $(\"#row_setting_repsperpage, #row_setting_posrep, #row_setting_neurep, #row_setting_negrep, #row_setting_postrep, #row_setting_multirep, #row_setting_maxreplength, #row_setting_minreplength\"), 1, true)',\n\t\t'new Peeker($(\".setting_enablewarningsystem\"), $(\"#row_setting_allowcustomwarnings, #row_setting_canviewownwarning, #row_setting_maxwarningpoints, #row_setting_allowanonwarningpms\"), 1, true)',\n\t\t'new Peeker($(\".setting_enablepms\"), $(\"#row_setting_pmsallowhtml, #row_setting_pmsallowmycode, #row_setting_pmsallowsmilies, #row_setting_pmsallowimgcode, #row_setting_pmsallowvideocode, #row_setting_pmquickreply, #row_setting_pmfloodsecs, #row_setting_showpmip, #row_setting_maxpmquotedepth\"), 1, true)',\n\t\t'new Peeker($(\".setting_smilieinserter\"), $(\"#row_setting_smilieinsertertot, #row_setting_smilieinsertercols\"), 1, true)',\n\t\t'new Peeker($(\"#setting_mail_handler\"), $(\"#row_setting_smtp_host, #row_setting_smtp_port, #row_setting_smtp_user, #row_setting_smtp_pass, #row_setting_secure_smtp\"), \"smtp\", false)',\n\t\t'new Peeker($(\"#setting_mail_handler\"), $(\"#row_setting_mail_parameters\"), \"mail\", false)',\n\t\t'new Peeker($(\"#setting_captchaimage\"), $(\"#row_setting_recaptchapublickey, #row_setting_recaptchaprivatekey\"), /(4|5|8)/, false)',\n\t\t'new Peeker($(\"#setting_captchaimage\"), $(\"#row_setting_recaptchascore\"), /(8)/, false)',\n\t\t'new Peeker($(\"#setting_captchaimage\"), $(\"#row_setting_hcaptchapublickey, #row_setting_hcaptchaprivatekey\"), /(6|7)/, false)',\n\t\t'new Peeker($(\"#setting_captchaimage\"), $(\"#row_setting_hcaptchaprivatekey, #row_setting_hcaptchaprivatekey\"), /(6|7)/, false)',\n\t\t'new Peeker($(\"#setting_captchaimage\"), $(\"#row_setting_hcaptchatheme\"), 6, false)',\n\t\t'new Peeker($(\"#setting_captchaimage\"), $(\"#row_setting_hcaptchasize\"), 6, false)',\n\t\t'new Peeker($(\".setting_contact\"), $(\"#row_setting_contact_guests, #row_setting_contact_badwords, #row_setting_contact_maxsubjectlength, #row_setting_contact_minmessagelength, #row_setting_contact_maxmessagelength\"), 1, true)',\n\t\t'new Peeker($(\".setting_enablepruning\"), $(\"#row_setting_enableprunebyposts, #row_setting_pruneunactived, #row_setting_prunethreads\"), 1, true)',\n\t\t'new Peeker($(\".setting_enableprunebyposts\"), $(\"#row_setting_prunepostcount, #row_setting_dayspruneregistered, #row_setting_prunepostcountall\"), 1, true)',\n\t\t'new Peeker($(\".setting_pruneunactived\"), $(\"#row_setting_dayspruneunactivated\"), 1, true)',\n\t\t'new Peeker($(\".setting_statsenabled\"), $(\"#row_setting_statscachetime, #row_setting_statslimit, #row_setting_statstopreferrer\"), 1, true)',\n\t\t'new Peeker($(\".setting_purgespammergroups_forums_groups_check\"), $(\"#row_setting_purgespammerpostlimit, #row_setting_purgespammerbandelete, #row_setting_purgespammerapikey\"), /^(?!none)/, true)',\n\t\t'new Peeker($(\".setting_purgespammerbandelete\"),$(\"#row_setting_purgespammerbangroup, #row_setting_purgespammerbanreason\"), \"ban\", true)',\n\t\t'new Peeker($(\"#setting_maxloginattempts\"), $(\"#row_setting_loginattemptstimeout\"), /[^0+|]/, false)',\n\t\t'new Peeker($(\".setting_bbcodeinserter\"), $(\"#row_setting_partialmode, #row_setting_smilieinserter\"), 1, true)',\n\t\t'new Peeker($(\".setting_portal\"), $(\"#row_setting_portal_announcementsfid, #row_setting_portal_showwelcome, #row_setting_portal_showpms, #row_setting_portal_showstats, #row_setting_portal_showwol, #row_setting_portal_showsearch, #row_setting_portal_showdiscussions\"), 1, true)',\n\t\t'new Peeker($(\".setting_portal_announcementsfid_forums_groups_check\"), $(\"#row_setting_portal_numannouncements\"), /^(?!none)/, true)',\n\t\t'new Peeker($(\".setting_portal_showdiscussions\"), $(\"#row_setting_portal_showdiscussionsnum, #row_setting_portal_excludediscussion\"), 1, true)',\n\t\t'new Peeker($(\".setting_enableattachments\"), $(\"#row_setting_maxattachments, #row_setting_attachthumbnails\"), 1, true)',\n\t\t'new Peeker($(\".setting_attachthumbnails\"), $(\"#row_setting_attachthumbh, #row_setting_attachthumbw\"), \"yes\", true)',\n\t\t'new Peeker($(\".setting_showbirthdays\"), $(\"#row_setting_showbirthdayspostlimit\"), 1, true)',\n\t\t'new Peeker($(\"#setting_betweenregstime\"), $(\"#row_setting_maxregsbetweentime\"), /[^0+|]/, false)',\n\t\t'new Peeker($(\".setting_usecdn\"), $(\"#row_setting_cdnurl, #row_setting_cdnpath\"), 1, true)',\n\t\t'new Peeker($(\"#setting_errorlogmedium\"), $(\"#row_setting_errorloglocation\"), /^(log|both)/, false)',\n\t\t'new Peeker($(\".setting_sigmycode\"), $(\"#row_setting_sigcountmycode, #row_setting_sigimgcode\"), 1, true)',\n\t\t'new Peeker($(\".setting_pmsallowmycode\"), $(\"#row_setting_pmsallowimgcode, #row_setting_pmsallowvideocode\"), 1, true)',\n\t\t'new Peeker($(\".setting_enableshowteam\"), $(\"#row_setting_showaddlgroups, #row_setting_showgroupleaders\"), 1, true)',\n\t\t'new Peeker($(\".setting_usereferrals\"), $(\"#row_setting_referralsperpage\"), 1, true)',\n\t);\n\n\t$peekers = $plugins->run_hooks(\"admin_settings_print_peekers\", $peekers);\n\n\t$setting_peekers = implode(\"\\n\t\t\t\", $peekers);\n\n\techo '<script type=\"text/javascript\" src=\"./jscripts/peeker.js?ver=1821\"></script>\n\t<script type=\"text/javascript\">\n\t\t$(function() {\n\t\t\t' . $setting_peekers . '\n\t\t});\n\t</script>';\n}\n"], "filenames": ["admin/modules/config/settings.php"], "buggy_code_start_loc": [296], "buggy_code_end_loc": [501], "fixing_code_start_loc": [296], "fixing_code_end_loc": [501], "type": "CWE-94", "message": "MyBB is a free and open source forum software. In affected versions the Admin CP's Settings management module does not validate setting types correctly on insertion and update, making it possible to add settings of supported type `php` with PHP code, executed on on _Change Settings_ pages. This results in a Remote Code Execution (RCE) vulnerability. The vulnerable module requires Admin CP access with the `Can manage settings?` permission. MyBB's Settings module, which allows administrators to add, edit, and delete non-default settings, stores setting data in an options code string ($options_code; mybb_settings.optionscode database column) that identifies the setting type and its options, separated by a new line character (\\n). In MyBB 1.2.0, support for setting type php was added, for which the remaining part of the options code is PHP code executed on Change Settings pages (reserved for plugins and internal use). MyBB 1.8.30 resolves this issue. There are no known workarounds.", "other": {"cve": {"id": "CVE-2022-24734", "sourceIdentifier": "security-advisories@github.com", "published": "2022-03-09T22:15:09.363", "lastModified": "2022-09-30T13:22:56.523", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "MyBB is a free and open source forum software. In affected versions the Admin CP's Settings management module does not validate setting types correctly on insertion and update, making it possible to add settings of supported type `php` with PHP code, executed on on _Change Settings_ pages. This results in a Remote Code Execution (RCE) vulnerability. The vulnerable module requires Admin CP access with the `Can manage settings?` permission. MyBB's Settings module, which allows administrators to add, edit, and delete non-default settings, stores setting data in an options code string ($options_code; mybb_settings.optionscode database column) that identifies the setting type and its options, separated by a new line character (\\n). In MyBB 1.2.0, support for setting type php was added, for which the remaining part of the options code is PHP code executed on Change Settings pages (reserved for plugins and internal use). MyBB 1.8.30 resolves this issue. There are no known workarounds."}, {"lang": "es", "value": "MyBB es un software de foros gratuito y de c\u00f3digo abierto. En las versiones afectadas, el m\u00f3dulo de gesti\u00f3n de configuraciones del CP de administraci\u00f3n no valida correctamente los tipos de configuraciones en la inserci\u00f3n y actualizaci\u00f3n, lo que hace posible a\u00f1adir configuraciones de tipo soportado `php` con c\u00f3digo PHP, ejecutado en las p\u00e1ginas de _Cambio de Configuraciones_. Esto resulta en una vulnerabilidad de Ejecuci\u00f3n Remota de C\u00f3digo (RCE). El m\u00f3dulo vulnerable requiere el acceso al CP de administrador con el permiso `Can manage settings?`. El m\u00f3dulo de configuraci\u00f3n de MyBB, que permite a los administradores a\u00f1adir, editar y eliminar configuraciones no predeterminadas, almacena los datos de configuraci\u00f3n en una cadena de c\u00f3digo de opciones ($options_code; columna de la base de datos mybb_settings.optionscode) que identifica el tipo de configuraci\u00f3n y sus opciones, separadas por un car\u00e1cter de nueva l\u00ednea (\\n). En MyBB 1.2.0, se a\u00f1adi\u00f3 soporte para el tipo de configuraci\u00f3n php, para el cual la parte restante del c\u00f3digo de opciones es c\u00f3digo PHP ejecutado en las p\u00e1ginas de cambio de configuraci\u00f3n (reservado para plugins y uso interno). MyBB 1.8.30 resuelve este problema. No se presentan medidas de mitigaci\u00f3n conocidas"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "HIGH", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 7.2, "baseSeverity": "HIGH"}, "exploitabilityScore": 1.2, "impactScore": 5.9}, {"source": "security-advisories@github.com", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "HIGH", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 7.2, "baseSeverity": "HIGH"}, "exploitabilityScore": 1.2, "impactScore": 5.9}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:S/C:P/I:P/A:P", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "SINGLE", "confidentialityImpact": "PARTIAL", "integrityImpact": "PARTIAL", "availabilityImpact": "PARTIAL", "baseScore": 6.5}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.0, "impactScore": 6.4, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "security-advisories@github.com", "type": "Primary", "description": [{"lang": "en", "value": "CWE-94"}]}, {"source": "nvd@nist.gov", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-94"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:mybb:mybb:*:*:*:*:*:*:*:*", "versionStartIncluding": "1.2.0", "versionEndExcluding": "1.8.30", "matchCriteriaId": "362CD6E4-2CC7-42AF-AAAA-5C3A6D47929E"}]}]}], "references": [{"url": "http://packetstormsecurity.com/files/167082/MyBB-1.8.29-Remote-Code-Execution.html", "source": "security-advisories@github.com", "tags": ["Exploit", "Third Party Advisory", "VDB Entry"]}, {"url": "http://packetstormsecurity.com/files/167333/MyBB-Admin-Control-Remote-Code-Execution.html", "source": "security-advisories@github.com", "tags": ["Exploit", "Third Party Advisory"]}, {"url": "https://github.com/mybb/mybb/commit/92012b9831b330714b9f9b4646a98784113489c1", "source": "security-advisories@github.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/mybb/mybb/security/advisories/GHSA-876v-gwgh-w57f", "source": "security-advisories@github.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://mybb.com/versions/1.8.30/", "source": "security-advisories@github.com", "tags": ["Release Notes", "Vendor Advisory"]}, {"url": "https://www.zerodayinitiative.com/advisories/ZDI-22-503/", "source": "security-advisories@github.com", "tags": ["Third Party Advisory", "VDB Entry", "Vendor Advisory"]}]}, "github_commit_url": "https://github.com/mybb/mybb/commit/92012b9831b330714b9f9b4646a98784113489c1"}}