{"buggy_code": ["using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Mvc;\nusing Nop.Core;\nusing Nop.Core.Caching;\nusing Nop.Core.Infrastructure;\nusing Nop.Data;\nusing Nop.Services.Common;\nusing Nop.Services.Customers;\nusing Nop.Services.Helpers;\nusing Nop.Services.Localization;\nusing Nop.Services.Messages;\nusing Nop.Services.Orders;\nusing Nop.Services.Security;\nusing Nop.Services.Seo;\nusing Nop.Web.Areas.Admin.Factories;\nusing Nop.Web.Areas.Admin.Models.Common;\nusing Nop.Web.Framework;\nusing Nop.Web.Framework.Controllers;\n\nnamespace Nop.Web.Areas.Admin.Controllers\n{\n    public partial class CommonController : BaseAdminController\n    {\n        #region Const\n\n        private const string EXPORT_IMPORT_PATH = @\"files\\exportimport\";\n\n        #endregion\n\n        #region Fields\n\n        private readonly ICommonModelFactory _commonModelFactory;\n        private readonly ICustomerService _customerService;\n        private readonly INopDataProvider _dataProvider;\n        private readonly IDateTimeHelper _dateTimeHelper;\n        private readonly ILanguageService _languageService;\n        private readonly ILocalizationService _localizationService;\n        private readonly IMaintenanceService _maintenanceService;\n        private readonly INopFileProvider _fileProvider;\n        private readonly INotificationService _notificationService;\n        private readonly IPermissionService _permissionService;\n        private readonly IQueuedEmailService _queuedEmailService;\n        private readonly IShoppingCartService _shoppingCartService;\n        private readonly IStaticCacheManager _staticCacheManager;\n        private readonly IUrlRecordService _urlRecordService;\n        private readonly IWebHelper _webHelper;\n        private readonly IWorkContext _workContext;\n\n        #endregion\n\n        #region Ctor\n\n        public CommonController(ICommonModelFactory commonModelFactory,\n            ICustomerService customerService,\n            INopDataProvider dataProvider,\n            IDateTimeHelper dateTimeHelper,\n            ILanguageService languageService,\n            ILocalizationService localizationService,\n            IMaintenanceService maintenanceService,\n            INopFileProvider fileProvider,\n            INotificationService notificationService,\n            IPermissionService permissionService,\n            IQueuedEmailService queuedEmailService,\n            IShoppingCartService shoppingCartService,\n            IStaticCacheManager staticCacheManager,\n            IUrlRecordService urlRecordService,\n            IWebHelper webHelper,\n            IWorkContext workContext)\n        {\n            _commonModelFactory = commonModelFactory;\n            _customerService = customerService;\n            _dataProvider = dataProvider;\n            _dateTimeHelper = dateTimeHelper;\n            _languageService = languageService;\n            _localizationService = localizationService;\n            _maintenanceService = maintenanceService;\n            _fileProvider = fileProvider;\n            _notificationService = notificationService;\n            _permissionService = permissionService;\n            _queuedEmailService = queuedEmailService;\n            _shoppingCartService = shoppingCartService;\n            _staticCacheManager = staticCacheManager;\n            _urlRecordService = urlRecordService;\n            _webHelper = webHelper;\n            _workContext = workContext;\n        }\n\n        #endregion\n\n        #region Methods\n\n        public virtual async Task<IActionResult> SystemInfo()\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance))\n                return AccessDeniedView();\n\n            //prepare model\n            var model = await _commonModelFactory.PrepareSystemInfoModelAsync(new SystemInfoModel());\n\n            return View(model);\n        }\n\n        public virtual async Task<IActionResult> Warnings()\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance))\n                return AccessDeniedView();\n\n            //prepare model\n            var model = await _commonModelFactory.PrepareSystemWarningModelsAsync();\n\n            return View(model);\n        }\n\n        public virtual async Task<IActionResult> Maintenance()\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance))\n                return AccessDeniedView();\n\n            //prepare model\n            var model = await _commonModelFactory.PrepareMaintenanceModelAsync(new MaintenanceModel());\n\n            return View(model);\n        }\n\n        [HttpPost, ActionName(\"Maintenance\")]\n        [FormValueRequired(\"delete-guests\")]\n        public virtual async Task<IActionResult> MaintenanceDeleteGuests(MaintenanceModel model)\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance))\n                return AccessDeniedView();\n\n            var startDateValue = model.DeleteGuests.StartDate == null ? null\n                            : (DateTime?)_dateTimeHelper.ConvertToUtcTime(model.DeleteGuests.StartDate.Value, await _dateTimeHelper.GetCurrentTimeZoneAsync());\n\n            var endDateValue = model.DeleteGuests.EndDate == null ? null\n                            : (DateTime?)_dateTimeHelper.ConvertToUtcTime(model.DeleteGuests.EndDate.Value, await _dateTimeHelper.GetCurrentTimeZoneAsync()).AddDays(1);\n\n            model.DeleteGuests.NumberOfDeletedCustomers = await _customerService.DeleteGuestCustomersAsync(startDateValue, endDateValue, model.DeleteGuests.OnlyWithoutShoppingCart);\n\n            return View(model);\n        }\n\n        [HttpPost, ActionName(\"Maintenance\")]\n        [FormValueRequired(\"delete-abondoned-carts\")]\n        public virtual async Task<IActionResult> MaintenanceDeleteAbandonedCarts(MaintenanceModel model)\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance))\n                return AccessDeniedView();\n\n            var olderThanDateValue = _dateTimeHelper.ConvertToUtcTime(model.DeleteAbandonedCarts.OlderThan, await _dateTimeHelper.GetCurrentTimeZoneAsync());\n\n            model.DeleteAbandonedCarts.NumberOfDeletedItems = await _shoppingCartService.DeleteExpiredShoppingCartItemsAsync(olderThanDateValue);\n            return View(model);\n        }\n\n        [HttpPost, ActionName(\"Maintenance\")]\n        [FormValueRequired(\"delete-exported-files\")]\n        public virtual async Task<IActionResult> MaintenanceDeleteFiles(MaintenanceModel model)\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance))\n                return AccessDeniedView();\n\n            var startDateValue = model.DeleteExportedFiles.StartDate == null ? null\n                            : (DateTime?)_dateTimeHelper.ConvertToUtcTime(model.DeleteExportedFiles.StartDate.Value, await _dateTimeHelper.GetCurrentTimeZoneAsync());\n\n            var endDateValue = model.DeleteExportedFiles.EndDate == null ? null\n                            : (DateTime?)_dateTimeHelper.ConvertToUtcTime(model.DeleteExportedFiles.EndDate.Value, await _dateTimeHelper.GetCurrentTimeZoneAsync()).AddDays(1);\n\n            model.DeleteExportedFiles.NumberOfDeletedFiles = 0;\n\n            foreach (var fullPath in _fileProvider.GetFiles(_fileProvider.GetAbsolutePath(EXPORT_IMPORT_PATH)))\n            {\n                try\n                {\n                    var fileName = _fileProvider.GetFileName(fullPath);\n                    if (fileName.Equals(\"index.htm\", StringComparison.InvariantCultureIgnoreCase))\n                        continue;\n\n                    var info = _fileProvider.GetFileInfo(fullPath);\n                    var lastModifiedTimeUtc = info.LastModified.UtcDateTime;\n                    if ((!startDateValue.HasValue || startDateValue.Value < lastModifiedTimeUtc) &&\n                        (!endDateValue.HasValue || lastModifiedTimeUtc < endDateValue.Value))\n                    {\n                        _fileProvider.DeleteFile(fullPath);\n                        model.DeleteExportedFiles.NumberOfDeletedFiles++;\n                    }\n                }\n                catch (Exception exc)\n                {\n                    await _notificationService.ErrorNotificationAsync(exc);\n                }\n            }\n\n            return View(model);\n        }\n\n        [HttpPost]\n        public virtual async Task<IActionResult> BackupFiles(BackupFileSearchModel searchModel)\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance))\n                return await AccessDeniedDataTablesJson();\n\n            //prepare model\n            var model = await _commonModelFactory.PrepareBackupFileListModelAsync(searchModel);\n\n            return Json(model);\n        }\n\n        [HttpPost, ActionName(\"Maintenance\")]\n        [FormValueRequired(\"backup-database\")]\n        public virtual async Task<IActionResult> BackupDatabase(MaintenanceModel model)\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance))\n                return AccessDeniedView();\n\n            try\n            {\n                await _dataProvider.BackupDatabaseAsync(_maintenanceService.CreateNewBackupFilePath());\n                _notificationService.SuccessNotification(await _localizationService.GetResourceAsync(\"Admin.System.Maintenance.BackupDatabase.BackupCreated\"));\n            }\n            catch (Exception exc)\n            {\n                await _notificationService.ErrorNotificationAsync(exc);\n            }\n\n            //prepare model\n            model = await _commonModelFactory.PrepareMaintenanceModelAsync(new MaintenanceModel());\n\n            return View(model);\n        }\n\n        [HttpPost, ActionName(\"Maintenance\")]\n        [FormValueRequired(\"re-index\")]\n        public virtual async Task<IActionResult> ReIndexTables(MaintenanceModel model)\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance))\n                return AccessDeniedView();\n\n            try\n            {\n                await _dataProvider.ReIndexTablesAsync();\n                _notificationService.SuccessNotification(await _localizationService.GetResourceAsync(\"Admin.System.Maintenance.ReIndexTables.Complete\"));\n            }\n            catch (Exception exc)\n            {\n                await _notificationService.ErrorNotificationAsync(exc);\n            }\n\n            return View(model);\n        }\n\n        [HttpPost, ActionName(\"Maintenance\")]\n        [FormValueRequired(\"backupFileName\", \"action\")]\n        public virtual async Task<IActionResult> BackupAction(MaintenanceModel model)\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance))\n                return AccessDeniedView();\n\n            var action = Request.Form[\"action\"];\n\n            var fileName = Request.Form[\"backupFileName\"];\n            var backupPath = _maintenanceService.GetBackupPath(fileName);\n\n            try\n            {\n                switch (action)\n                {\n                    case \"delete-backup\":\n                        {\n                            _fileProvider.DeleteFile(backupPath);\n                            _notificationService.SuccessNotification(string.Format(await _localizationService.GetResourceAsync(\"Admin.System.Maintenance.BackupDatabase.BackupDeleted\"), fileName));\n                        }\n                        break;\n                    case \"restore-backup\":\n                        {\n                            await _dataProvider.RestoreDatabaseAsync(backupPath);\n                            _notificationService.SuccessNotification(await _localizationService.GetResourceAsync(\"Admin.System.Maintenance.BackupDatabase.DatabaseRestored\"));\n                        }\n                        break;\n                }\n            }\n            catch (Exception exc)\n            {\n                await _notificationService.ErrorNotificationAsync(exc);\n            }\n\n            //prepare model\n            model = await _commonModelFactory.PrepareMaintenanceModelAsync(model);\n\n            return View(model);\n        }\n\n        [HttpPost, ActionName(\"Maintenance\")]\n        [FormValueRequired(\"delete-already-sent-queued-emails\")]\n        public virtual async Task<IActionResult> MaintenanceDeleteAlreadySentQueuedEmails(MaintenanceModel model)\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance))\n                return AccessDeniedView();\n\n            var startDateValue = model.DeleteAlreadySentQueuedEmails.StartDate == null ? null\n                            : (DateTime?)_dateTimeHelper.ConvertToUtcTime(model.DeleteAlreadySentQueuedEmails.StartDate.Value, await _dateTimeHelper.GetCurrentTimeZoneAsync());\n\n            var endDateValue = model.DeleteAlreadySentQueuedEmails.EndDate == null ? null\n                            : (DateTime?)_dateTimeHelper.ConvertToUtcTime(model.DeleteAlreadySentQueuedEmails.EndDate.Value, await _dateTimeHelper.GetCurrentTimeZoneAsync()).AddDays(1);\n\n            model.DeleteAlreadySentQueuedEmails.NumberOfDeletedEmails = await _queuedEmailService.DeleteAlreadySentEmailsAsync(startDateValue, endDateValue);\n\n            return View(model);\n        }\n\n        public virtual async Task<IActionResult> SetLanguage(int langid, string returnUrl = \"\")\n        {\n            var language = await _languageService.GetLanguageByIdAsync(langid);\n            if (language != null)\n                await _workContext.SetWorkingLanguageAsync(language);\n\n            //home page\n            if (string.IsNullOrEmpty(returnUrl))\n                returnUrl = Url.Action(\"Index\", \"Home\", new { area = AreaNames.Admin });\n\n            //prevent open redirection attack\n            if (!Url.IsLocalUrl(returnUrl))\n                return RedirectToAction(\"Index\", \"Home\", new { area = AreaNames.Admin });\n\n            return Redirect(returnUrl);\n        }\n\n        [HttpPost]\n        public virtual async Task<IActionResult> ClearCache(string returnUrl = \"\")\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance))\n                return AccessDeniedView();\n\n            await _staticCacheManager.ClearAsync();\n\n            //home page\n            if (string.IsNullOrEmpty(returnUrl))\n                return RedirectToAction(\"Index\", \"Home\", new { area = AreaNames.Admin });\n\n            //prevent open redirection attack\n            if (!Url.IsLocalUrl(returnUrl))\n                return RedirectToAction(\"Index\", \"Home\", new { area = AreaNames.Admin });\n\n            return Redirect(returnUrl);\n        }\n\n        [HttpPost]\n        public virtual async Task<IActionResult> RestartApplication(string returnUrl = \"\")\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance))\n                return AccessDeniedView();\n\n            //home page\n            if (string.IsNullOrEmpty(returnUrl))\n                returnUrl = Url.Action(\"Index\", \"Home\", new { area = AreaNames.Admin });\n\n            //prevent open redirection attack\n            if (!Url.IsLocalUrl(returnUrl))\n                returnUrl = Url.Action(\"Index\", \"Home\", new { area = AreaNames.Admin });\n\n            return View(\"RestartApplication\", returnUrl);\n        }\n\n        public virtual async Task<IActionResult> RestartApplication()\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance) &&\n                !await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManagePlugins) &&\n                !await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageSettings))\n            {\n                return AccessDeniedView();\n            }\n\n            //restart application\n            _webHelper.RestartAppDomain();\n\n            return new EmptyResult();\n        }\n\n        public virtual async Task<IActionResult> SeNames()\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance))\n                return AccessDeniedView();\n\n            //prepare model\n            var model = await _commonModelFactory.PrepareUrlRecordSearchModelAsync(new UrlRecordSearchModel());\n\n            return View(model);\n        }\n\n        [HttpPost]\n        public virtual async Task<IActionResult> SeNames(UrlRecordSearchModel searchModel)\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance))\n                return await AccessDeniedDataTablesJson();\n\n            //prepare model\n            var model = await _commonModelFactory.PrepareUrlRecordListModelAsync(searchModel);\n\n            return Json(model);\n        }\n\n        [HttpPost]\n        public virtual async Task<IActionResult> DeleteSelectedSeNames(ICollection<int> selectedIds)\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance))\n                return AccessDeniedView();\n\n            if (selectedIds == null || selectedIds.Count == 0)\n                return NoContent();\n\n            await _urlRecordService.DeleteUrlRecordsAsync(await _urlRecordService.GetUrlRecordsByIdsAsync(selectedIds.ToArray()));\n\n            return Json(new { Result = true });\n        }\n\n        [HttpPost]\n        public virtual async Task<IActionResult> PopularSearchTermsReport(PopularSearchTermSearchModel searchModel)\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageProducts))\n                return await AccessDeniedDataTablesJson();\n\n            //prepare model\n            var model = await _commonModelFactory.PreparePopularSearchTermListModelAsync(searchModel);\n\n            return Json(model);\n        }\n\n        //action displaying notification (warning) to a store owner that entered SE URL already exists\n        public virtual async Task<IActionResult> UrlReservedWarning(string entityId, string entityName, string seName)\n        {\n            if (string.IsNullOrEmpty(seName))\n                return Json(new { Result = string.Empty });\n\n            _ = int.TryParse(entityId, out var parsedEntityId);\n            var validatedSeName = await _urlRecordService.ValidateSeNameAsync(parsedEntityId, entityName, seName, null, false);\n\n            if (seName.Equals(validatedSeName, StringComparison.InvariantCultureIgnoreCase))\n                return Json(new { Result = string.Empty });\n\n            return Json(new { Result = string.Format(await _localizationService.GetResourceAsync(\"Admin.System.Warnings.URL.Reserved\"), validatedSeName) });\n        }\n\n        #endregion\n    }\n}"], "fixing_code": ["using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Mvc;\nusing Nop.Core;\nusing Nop.Core.Caching;\nusing Nop.Core.Infrastructure;\nusing Nop.Data;\nusing Nop.Services.Common;\nusing Nop.Services.Customers;\nusing Nop.Services.Helpers;\nusing Nop.Services.Localization;\nusing Nop.Services.Messages;\nusing Nop.Services.Orders;\nusing Nop.Services.Security;\nusing Nop.Services.Seo;\nusing Nop.Web.Areas.Admin.Factories;\nusing Nop.Web.Areas.Admin.Models.Common;\nusing Nop.Web.Framework;\nusing Nop.Web.Framework.Controllers;\n\nnamespace Nop.Web.Areas.Admin.Controllers\n{\n    public partial class CommonController : BaseAdminController\n    {\n        #region Const\n\n        private const string EXPORT_IMPORT_PATH = @\"files\\exportimport\";\n\n        #endregion\n\n        #region Fields\n\n        private readonly ICommonModelFactory _commonModelFactory;\n        private readonly ICustomerService _customerService;\n        private readonly INopDataProvider _dataProvider;\n        private readonly IDateTimeHelper _dateTimeHelper;\n        private readonly ILanguageService _languageService;\n        private readonly ILocalizationService _localizationService;\n        private readonly IMaintenanceService _maintenanceService;\n        private readonly INopFileProvider _fileProvider;\n        private readonly INotificationService _notificationService;\n        private readonly IPermissionService _permissionService;\n        private readonly IQueuedEmailService _queuedEmailService;\n        private readonly IShoppingCartService _shoppingCartService;\n        private readonly IStaticCacheManager _staticCacheManager;\n        private readonly IUrlRecordService _urlRecordService;\n        private readonly IWebHelper _webHelper;\n        private readonly IWorkContext _workContext;\n\n        #endregion\n\n        #region Ctor\n\n        public CommonController(ICommonModelFactory commonModelFactory,\n            ICustomerService customerService,\n            INopDataProvider dataProvider,\n            IDateTimeHelper dateTimeHelper,\n            ILanguageService languageService,\n            ILocalizationService localizationService,\n            IMaintenanceService maintenanceService,\n            INopFileProvider fileProvider,\n            INotificationService notificationService,\n            IPermissionService permissionService,\n            IQueuedEmailService queuedEmailService,\n            IShoppingCartService shoppingCartService,\n            IStaticCacheManager staticCacheManager,\n            IUrlRecordService urlRecordService,\n            IWebHelper webHelper,\n            IWorkContext workContext)\n        {\n            _commonModelFactory = commonModelFactory;\n            _customerService = customerService;\n            _dataProvider = dataProvider;\n            _dateTimeHelper = dateTimeHelper;\n            _languageService = languageService;\n            _localizationService = localizationService;\n            _maintenanceService = maintenanceService;\n            _fileProvider = fileProvider;\n            _notificationService = notificationService;\n            _permissionService = permissionService;\n            _queuedEmailService = queuedEmailService;\n            _shoppingCartService = shoppingCartService;\n            _staticCacheManager = staticCacheManager;\n            _urlRecordService = urlRecordService;\n            _webHelper = webHelper;\n            _workContext = workContext;\n        }\n\n        #endregion\n\n        #region Methods\n\n        public virtual async Task<IActionResult> SystemInfo()\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance))\n                return AccessDeniedView();\n\n            //prepare model\n            var model = await _commonModelFactory.PrepareSystemInfoModelAsync(new SystemInfoModel());\n\n            return View(model);\n        }\n\n        public virtual async Task<IActionResult> Warnings()\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance))\n                return AccessDeniedView();\n\n            //prepare model\n            var model = await _commonModelFactory.PrepareSystemWarningModelsAsync();\n\n            return View(model);\n        }\n\n        public virtual async Task<IActionResult> Maintenance()\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance))\n                return AccessDeniedView();\n\n            //prepare model\n            var model = await _commonModelFactory.PrepareMaintenanceModelAsync(new MaintenanceModel());\n\n            return View(model);\n        }\n\n        [HttpPost, ActionName(\"Maintenance\")]\n        [FormValueRequired(\"delete-guests\")]\n        public virtual async Task<IActionResult> MaintenanceDeleteGuests(MaintenanceModel model)\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance))\n                return AccessDeniedView();\n\n            var startDateValue = model.DeleteGuests.StartDate == null ? null\n                            : (DateTime?)_dateTimeHelper.ConvertToUtcTime(model.DeleteGuests.StartDate.Value, await _dateTimeHelper.GetCurrentTimeZoneAsync());\n\n            var endDateValue = model.DeleteGuests.EndDate == null ? null\n                            : (DateTime?)_dateTimeHelper.ConvertToUtcTime(model.DeleteGuests.EndDate.Value, await _dateTimeHelper.GetCurrentTimeZoneAsync()).AddDays(1);\n\n            model.DeleteGuests.NumberOfDeletedCustomers = await _customerService.DeleteGuestCustomersAsync(startDateValue, endDateValue, model.DeleteGuests.OnlyWithoutShoppingCart);\n\n            return View(model);\n        }\n\n        [HttpPost, ActionName(\"Maintenance\")]\n        [FormValueRequired(\"delete-abondoned-carts\")]\n        public virtual async Task<IActionResult> MaintenanceDeleteAbandonedCarts(MaintenanceModel model)\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance))\n                return AccessDeniedView();\n\n            var olderThanDateValue = _dateTimeHelper.ConvertToUtcTime(model.DeleteAbandonedCarts.OlderThan, await _dateTimeHelper.GetCurrentTimeZoneAsync());\n\n            model.DeleteAbandonedCarts.NumberOfDeletedItems = await _shoppingCartService.DeleteExpiredShoppingCartItemsAsync(olderThanDateValue);\n            return View(model);\n        }\n\n        [HttpPost, ActionName(\"Maintenance\")]\n        [FormValueRequired(\"delete-exported-files\")]\n        public virtual async Task<IActionResult> MaintenanceDeleteFiles(MaintenanceModel model)\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance))\n                return AccessDeniedView();\n\n            var startDateValue = model.DeleteExportedFiles.StartDate == null ? null\n                            : (DateTime?)_dateTimeHelper.ConvertToUtcTime(model.DeleteExportedFiles.StartDate.Value, await _dateTimeHelper.GetCurrentTimeZoneAsync());\n\n            var endDateValue = model.DeleteExportedFiles.EndDate == null ? null\n                            : (DateTime?)_dateTimeHelper.ConvertToUtcTime(model.DeleteExportedFiles.EndDate.Value, await _dateTimeHelper.GetCurrentTimeZoneAsync()).AddDays(1);\n\n            model.DeleteExportedFiles.NumberOfDeletedFiles = 0;\n\n            foreach (var fullPath in _fileProvider.GetFiles(_fileProvider.GetAbsolutePath(EXPORT_IMPORT_PATH)))\n            {\n                try\n                {\n                    var fileName = _fileProvider.GetFileName(fullPath);\n                    if (fileName.Equals(\"index.htm\", StringComparison.InvariantCultureIgnoreCase))\n                        continue;\n\n                    var info = _fileProvider.GetFileInfo(fullPath);\n                    var lastModifiedTimeUtc = info.LastModified.UtcDateTime;\n                    if ((!startDateValue.HasValue || startDateValue.Value < lastModifiedTimeUtc) &&\n                        (!endDateValue.HasValue || lastModifiedTimeUtc < endDateValue.Value))\n                    {\n                        _fileProvider.DeleteFile(fullPath);\n                        model.DeleteExportedFiles.NumberOfDeletedFiles++;\n                    }\n                }\n                catch (Exception exc)\n                {\n                    await _notificationService.ErrorNotificationAsync(exc);\n                }\n            }\n\n            return View(model);\n        }\n\n        [HttpPost]\n        public virtual async Task<IActionResult> BackupFiles(BackupFileSearchModel searchModel)\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance))\n                return await AccessDeniedDataTablesJson();\n\n            //prepare model\n            var model = await _commonModelFactory.PrepareBackupFileListModelAsync(searchModel);\n\n            return Json(model);\n        }\n\n        [HttpPost, ActionName(\"Maintenance\")]\n        [FormValueRequired(\"backup-database\")]\n        public virtual async Task<IActionResult> BackupDatabase(MaintenanceModel model)\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance))\n                return AccessDeniedView();\n\n            try\n            {\n                await _dataProvider.BackupDatabaseAsync(_maintenanceService.CreateNewBackupFilePath());\n                _notificationService.SuccessNotification(await _localizationService.GetResourceAsync(\"Admin.System.Maintenance.BackupDatabase.BackupCreated\"));\n            }\n            catch (Exception exc)\n            {\n                await _notificationService.ErrorNotificationAsync(exc);\n            }\n\n            //prepare model\n            model = await _commonModelFactory.PrepareMaintenanceModelAsync(new MaintenanceModel());\n\n            return View(model);\n        }\n\n        [HttpPost, ActionName(\"Maintenance\")]\n        [FormValueRequired(\"re-index\")]\n        public virtual async Task<IActionResult> ReIndexTables(MaintenanceModel model)\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance))\n                return AccessDeniedView();\n\n            try\n            {\n                await _dataProvider.ReIndexTablesAsync();\n                _notificationService.SuccessNotification(await _localizationService.GetResourceAsync(\"Admin.System.Maintenance.ReIndexTables.Complete\"));\n            }\n            catch (Exception exc)\n            {\n                await _notificationService.ErrorNotificationAsync(exc);\n            }\n\n            return View(model);\n        }\n\n        [HttpPost, ActionName(\"Maintenance\")]\n        [FormValueRequired(\"backupFileName\", \"action\")]\n        public virtual async Task<IActionResult> BackupAction(MaintenanceModel model)\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance))\n                return AccessDeniedView();\n\n            var action = Request.Form[\"action\"];\n\n            var fileName = Request.Form[\"backupFileName\"];\n            fileName = _fileProvider.GetFileName(_fileProvider.GetAbsolutePath(fileName));\n\n            var backupPath = _maintenanceService.GetBackupPath(fileName);\n\n            try\n            {\n                switch (action)\n                {\n                    case \"delete-backup\":\n                        {\n                            _fileProvider.DeleteFile(backupPath);\n                            _notificationService.SuccessNotification(string.Format(await _localizationService.GetResourceAsync(\"Admin.System.Maintenance.BackupDatabase.BackupDeleted\"), fileName));\n                        }\n                        break;\n                    case \"restore-backup\":\n                        {\n                            await _dataProvider.RestoreDatabaseAsync(backupPath);\n                            _notificationService.SuccessNotification(await _localizationService.GetResourceAsync(\"Admin.System.Maintenance.BackupDatabase.DatabaseRestored\"));\n                        }\n                        break;\n                }\n            }\n            catch (Exception exc)\n            {\n                await _notificationService.ErrorNotificationAsync(exc);\n            }\n\n            //prepare model\n            model = await _commonModelFactory.PrepareMaintenanceModelAsync(model);\n\n            return View(model);\n        }\n\n        [HttpPost, ActionName(\"Maintenance\")]\n        [FormValueRequired(\"delete-already-sent-queued-emails\")]\n        public virtual async Task<IActionResult> MaintenanceDeleteAlreadySentQueuedEmails(MaintenanceModel model)\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance))\n                return AccessDeniedView();\n\n            var startDateValue = model.DeleteAlreadySentQueuedEmails.StartDate == null ? null\n                            : (DateTime?)_dateTimeHelper.ConvertToUtcTime(model.DeleteAlreadySentQueuedEmails.StartDate.Value, await _dateTimeHelper.GetCurrentTimeZoneAsync());\n\n            var endDateValue = model.DeleteAlreadySentQueuedEmails.EndDate == null ? null\n                            : (DateTime?)_dateTimeHelper.ConvertToUtcTime(model.DeleteAlreadySentQueuedEmails.EndDate.Value, await _dateTimeHelper.GetCurrentTimeZoneAsync()).AddDays(1);\n\n            model.DeleteAlreadySentQueuedEmails.NumberOfDeletedEmails = await _queuedEmailService.DeleteAlreadySentEmailsAsync(startDateValue, endDateValue);\n\n            return View(model);\n        }\n\n        public virtual async Task<IActionResult> SetLanguage(int langid, string returnUrl = \"\")\n        {\n            var language = await _languageService.GetLanguageByIdAsync(langid);\n            if (language != null)\n                await _workContext.SetWorkingLanguageAsync(language);\n\n            //home page\n            if (string.IsNullOrEmpty(returnUrl))\n                returnUrl = Url.Action(\"Index\", \"Home\", new { area = AreaNames.Admin });\n\n            //prevent open redirection attack\n            if (!Url.IsLocalUrl(returnUrl))\n                return RedirectToAction(\"Index\", \"Home\", new { area = AreaNames.Admin });\n\n            return Redirect(returnUrl);\n        }\n\n        [HttpPost]\n        public virtual async Task<IActionResult> ClearCache(string returnUrl = \"\")\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance))\n                return AccessDeniedView();\n\n            await _staticCacheManager.ClearAsync();\n\n            //home page\n            if (string.IsNullOrEmpty(returnUrl))\n                return RedirectToAction(\"Index\", \"Home\", new { area = AreaNames.Admin });\n\n            //prevent open redirection attack\n            if (!Url.IsLocalUrl(returnUrl))\n                return RedirectToAction(\"Index\", \"Home\", new { area = AreaNames.Admin });\n\n            return Redirect(returnUrl);\n        }\n\n        [HttpPost]\n        public virtual async Task<IActionResult> RestartApplication(string returnUrl = \"\")\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance))\n                return AccessDeniedView();\n\n            //home page\n            if (string.IsNullOrEmpty(returnUrl))\n                returnUrl = Url.Action(\"Index\", \"Home\", new { area = AreaNames.Admin });\n\n            //prevent open redirection attack\n            if (!Url.IsLocalUrl(returnUrl))\n                returnUrl = Url.Action(\"Index\", \"Home\", new { area = AreaNames.Admin });\n\n            return View(\"RestartApplication\", returnUrl);\n        }\n\n        public virtual async Task<IActionResult> RestartApplication()\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance) &&\n                !await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManagePlugins) &&\n                !await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageSettings))\n            {\n                return AccessDeniedView();\n            }\n\n            //restart application\n            _webHelper.RestartAppDomain();\n\n            return new EmptyResult();\n        }\n\n        public virtual async Task<IActionResult> SeNames()\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance))\n                return AccessDeniedView();\n\n            //prepare model\n            var model = await _commonModelFactory.PrepareUrlRecordSearchModelAsync(new UrlRecordSearchModel());\n\n            return View(model);\n        }\n\n        [HttpPost]\n        public virtual async Task<IActionResult> SeNames(UrlRecordSearchModel searchModel)\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance))\n                return await AccessDeniedDataTablesJson();\n\n            //prepare model\n            var model = await _commonModelFactory.PrepareUrlRecordListModelAsync(searchModel);\n\n            return Json(model);\n        }\n\n        [HttpPost]\n        public virtual async Task<IActionResult> DeleteSelectedSeNames(ICollection<int> selectedIds)\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageMaintenance))\n                return AccessDeniedView();\n\n            if (selectedIds == null || selectedIds.Count == 0)\n                return NoContent();\n\n            await _urlRecordService.DeleteUrlRecordsAsync(await _urlRecordService.GetUrlRecordsByIdsAsync(selectedIds.ToArray()));\n\n            return Json(new { Result = true });\n        }\n\n        [HttpPost]\n        public virtual async Task<IActionResult> PopularSearchTermsReport(PopularSearchTermSearchModel searchModel)\n        {\n            if (!await _permissionService.AuthorizeAsync(StandardPermissionProvider.ManageProducts))\n                return await AccessDeniedDataTablesJson();\n\n            //prepare model\n            var model = await _commonModelFactory.PreparePopularSearchTermListModelAsync(searchModel);\n\n            return Json(model);\n        }\n\n        //action displaying notification (warning) to a store owner that entered SE URL already exists\n        public virtual async Task<IActionResult> UrlReservedWarning(string entityId, string entityName, string seName)\n        {\n            if (string.IsNullOrEmpty(seName))\n                return Json(new { Result = string.Empty });\n\n            _ = int.TryParse(entityId, out var parsedEntityId);\n            var validatedSeName = await _urlRecordService.ValidateSeNameAsync(parsedEntityId, entityName, seName, null, false);\n\n            if (seName.Equals(validatedSeName, StringComparison.InvariantCultureIgnoreCase))\n                return Json(new { Result = string.Empty });\n\n            return Json(new { Result = string.Format(await _localizationService.GetResourceAsync(\"Admin.System.Warnings.URL.Reserved\"), validatedSeName) });\n        }\n\n        #endregion\n    }\n}"], "filenames": ["src/Presentation/Nop.Web/Areas/Admin/Controllers/CommonController.cs"], "buggy_code_start_loc": [264], "buggy_code_end_loc": [264], "fixing_code_start_loc": [265], "fixing_code_end_loc": [267], "type": "CWE-22", "message": "nopCommerce 4.50.1 is vulnerable to Directory Traversal via the backup file in the Maintenance feature.", "other": {"cve": {"id": "CVE-2022-28451", "sourceIdentifier": "cve@mitre.org", "published": "2022-05-02T00:15:08.197", "lastModified": "2022-05-10T16:12:02.250", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "nopCommerce 4.50.1 is vulnerable to Directory Traversal via the backup file in the Maintenance feature."}, {"lang": "es", "value": "nopCommerce versi\u00f3n 4.50.1, es vulnerable a un Salto de Directorio por medio del archivo de copia de seguridad en la funcionalidad Maintenance"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "NONE", "availabilityImpact": "NONE", "baseScore": 7.5, "baseSeverity": "HIGH"}, "exploitabilityScore": 3.9, "impactScore": 3.6}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:N/C:P/I:N/A:N", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "NONE", "confidentialityImpact": "PARTIAL", "integrityImpact": "NONE", "availabilityImpact": "NONE", "baseScore": 5.0}, "baseSeverity": "MEDIUM", "exploitabilityScore": 10.0, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-22"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:nopcommerce:nopcommerce:4.50.1:*:*:*:*:*:*:*", "matchCriteriaId": "DE1F8366-57AA-4EB3-AF01-0260B561A966"}]}]}], "references": [{"url": "https://github.com/nopSolutions/nopCommerce/commit/47ff9a241243db9359f10216bcf401baaa36d0b4", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/nopSolutions/nopCommerce/issues/6203", "source": "cve@mitre.org", "tags": ["Issue Tracking", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/nopSolutions/nopCommerce/commit/47ff9a241243db9359f10216bcf401baaa36d0b4"}}