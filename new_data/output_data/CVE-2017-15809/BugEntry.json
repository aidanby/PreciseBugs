{"buggy_code": ["<?php\n\n/**\n * AJAX: Search for tags.\n *\n * PHP Version 5.5\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @category  phpMyFAQ\n * @author    Matteo Scaramuccia <matteo@scaramuccia.com>\n * @copyright 2005-2017 phpMyFAQ Team\n * @license   http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n * @link      http://www.phpmyfaq.de\n * @since     2005-12-15\n */\n\nif (!defined('IS_VALID_PHPMYFAQ')) {\n    $protocol = 'http';\n    if (isset($_SERVER['HTTPS']) && strtoupper($_SERVER['HTTPS']) === 'ON') {\n        $protocol = 'https';\n    }\n    header('Location: '.$protocol.'://'.$_SERVER['HTTP_HOST'].dirname($_SERVER['SCRIPT_NAME']));\n    exit();\n}\n\n// Send headers\n$http = new PMF_Helper_Http();\n$http->setContentType('application/json');\n$http->addHeader();\n\n$ajaxAction = PMF_Filter::filterInput(INPUT_GET, 'ajaxaction', FILTER_SANITIZE_STRING);\n\n$oTag = new PMF_Tags($faqConfig);\n\nswitch ($ajaxAction) {\n\n    case 'list':\n        $autoCompleteValue = PMF_Filter::filterInput(INPUT_GET, 'q', FILTER_SANITIZE_STRIPPED);\n\n        if (!is_null($autoCompleteValue)) {\n            if (strpos($autoCompleteValue, ',')) {\n                $arrayOfValues = explode(',', $autoCompleteValue);\n                $autoCompleteValue = end($arrayOfValues);\n            }\n            $tags = $oTag->getAllTags(strtolower(trim($autoCompleteValue)), PMF_TAGS_CLOUD_RESULT_SET_SIZE, true);\n        } else {\n            $tags = $oTag->getAllTags();\n        }\n\n        if ($user->perm->checkRight($user->getUserId(), 'editbt')) {\n            $i = 0;\n            $tagNames = [];\n            foreach ($tags as $tagName) {\n                ++$i;\n                if ($i <= PMF_TAGS_AUTOCOMPLETE_RESULT_SET_SIZE) {\n                    $currentTag = new stdClass();\n                    $currentTag->tagName = $tagName;\n                    $tagNames['results'][] = $currentTag;\n                }\n            }\n\n            echo json_encode($tagNames);\n        }\n        break;\n\n    case 'update':\n\n        $id = PMF_Filter::filterInput(INPUT_POST, 'id', FILTER_VALIDATE_INT);\n        $tag = PMF_Filter::filterInput(INPUT_POST, 'tag', FILTER_SANITIZE_STRING);\n\n        $entity = new PMF_Entity_Tags();\n        $entity->setId($id);\n        $entity->setName($tag);\n\n        if ($oTag->updateTag($entity)) {\n            echo json_encode($PMF_LANG['ad_entryins_suc']);\n        } else {\n            echo json_encode($PMF_LANG['ad_entryins_fail']);\n        }\n        break;\n}\n", "/**\n * JavaScript functions for all tag administration stuff\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @category  phpMyFAQ\n * @package   Administration\n * @author    Thorsten Rinne <thorsten@phpmyfaq.de>\n * @copyright 2014-2017 phpMyFAQ Team\n * @license   http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n * @link      http://www.phpmyfaq.de\n * @since     2014-08-16\n */\n\n/*global $:false */\n\n$(document).ready(function () {\n    'use strict';\n\n    $('.btn-edit').on('click', function () {\n        var id = $(this).data('btn-id');\n        var span = $('span[data-tag-id=\"' + id + '\"]');\n\n        if (span.length > 0) {\n            span.replaceWith(\n                '<input name=\"tag\" class=\"form-control\" data-tag-id=\"' + id + '\" value=\"' + span.html() + '\">'\n            );\n        } else {\n            var input = $('input[data-tag-id=\"' + id + '\"]');\n            input.replaceWith('<span data-tag-id=\"' + id + '\">' + input.val() + '</span>');\n        }\n    });\n\n    $('.tag-form').bind('submit', function (event) {\n\n        event.preventDefault();\n\n        var input = $('input[data-tag-id]:focus');\n        var id = input.data('tag-id');\n        var tag = input.val();\n\n        $.ajax({\n            url: 'index.php?action=ajax&ajax=tags&ajaxaction=update',\n            type: 'POST',\n            data: 'id=' + id + '&tag=' + tag,\n            dataType: 'json',\n            beforeSend: function () {\n                $('#saving_data_indicator').html(\n                    '<i aria-hidden=\"true\" class=\"fa fa-spinner fa-spin\"></i> Saving ...'\n                );\n            },\n            success: function (message) {\n                input.replaceWith('<span data-tag-id=\"' + id + '\">' + input.val() + '</span>');\n                $('span[data-tag-id=\"' + id + '\"]').append(' \u2713');\n                $('#saving_data_indicator').html('\u2713 ' + message);\n            }\n        });\n\n        return false;\n    });\n});\n", "<?php\n/**\n * Frontend for Backup and Restore.\n *\n * PHP Version 5.5\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @category  phpMyFAQ\n *\n * @author    Thorsten Rinne <thorsten@phpmyfaq.de>\n * @copyright 2003-2017 phpMyFAQ Team\n * @license   http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n *\n * @link      http://www.phpmyfaq.de\n * @since     2003-02-24\n */\nif (!defined('IS_VALID_PHPMYFAQ')) {\n    $protocol = 'http';\n    if (isset($_SERVER['HTTPS']) && strtoupper($_SERVER['HTTPS']) === 'ON') {\n        $protocol = 'https';\n    }\n    header('Location: '.$protocol.'://'.$_SERVER['HTTP_HOST'].dirname($_SERVER['SCRIPT_NAME']));\n    exit();\n}\n\n?>\n    <header class=\"row\">\n        <div class=\"col-lg-12\">\n            <h2 class=\"page-header\">\n                <i aria-hidden=\"true\" class=\"fa fa-tags\"></i> <?php echo $PMF_LANG['ad_entry_tags'] ?>\n            </h2>\n        </div>\n    </header>\n\n    <div class=\"row\">\n        <div class=\"col-lg-12\">\n            <form action=\"\" method=\"post\" class=\"tag-form\">\n\n<?php\nif ($user->perm->checkRight($user->getUserId(), 'editbt')) {\n    $tags = new PMF_Tags($faqConfig);\n\n    if ('deletetag' == $action) {\n        $id = PMF_Filter::filterInput(INPUT_GET, 'id', FILTER_VALIDATE_INT);\n        if ($tags->deleteTag($id)) {\n            echo '<p class=\"alert alert-success\"><a href=\"#\" class=\"close\" data-dismiss=\"alert\">\u00d7</a>';\n            echo $PMF_LANG['ad_tag_delete_success'].'</p>';\n        } else {\n            echo '<p class=\"alert alert-danger\"><a href=\"#\" class=\"close\" data-dismiss=\"alert\">\u00d7</a>';\n            echo $PMF_LANG['ad_tag_delete_error'];\n            echo '<br />'.$PMF_LANG['ad_adus_dberr'].'<br />';\n            echo $faqConfig->getDb()->error().'</p>';\n        }\n    }\n\n    $tagData = $tags->getAllTags();\n\n    echo '<table class=\"table table-striped\">';\n    echo '<tbody>';\n\n    foreach ($tagData as $key => $tag) {\n        echo '<tr>';\n        echo '<td><span data-tag-id=\"'.$key.'\">'.$tag.'</span></td>';\n        printf(\n            '<td><a class=\"btn btn-primary btn-edit\" data-btn-id=\"%d\" title=\"%s\"><i aria-hidden=\"true\" class=\"fa fa-edit\"></i></a></td>',\n            $key,\n            $PMF_LANG['ad_user_edit']\n        );\n\n        printf(\n            '<td><a class=\"btn btn-danger\" onclick=\"return confirm(\\'%s\\'); return false;\" href=\"%s%d\">',\n            $PMF_LANG['ad_user_del_3'],\n            '?action=deletetag&amp;id=',\n            $key\n        );\n        printf(\n            '<span title=\"%s\"><i aria-hidden=\"true\" class=\"fa fa-trash-o\"></i></span></a></td>',\n            $PMF_LANG['ad_entry_delete']\n        );\n\n        echo '<tr>';\n    }\n\n    echo '</tbody>';\n    echo '</table>';\n} else {\n    echo $PMF_LANG['err_NotAuth'];\n}\n?>\n            </form>\n            <script src=\"assets/js/tags.js\"></script>\n        </div>\n    </div>"], "fixing_code": ["<?php\n\n/**\n * AJAX: Search for tags.\n *\n * PHP Version 5.5\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @category  phpMyFAQ\n * @author    Matteo Scaramuccia <matteo@scaramuccia.com>\n * @copyright 2005-2017 phpMyFAQ Team\n * @license   http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n * @link      http://www.phpmyfaq.de\n * @since     2005-12-15\n */\n\nif (!defined('IS_VALID_PHPMYFAQ')) {\n    $protocol = 'http';\n    if (isset($_SERVER['HTTPS']) && strtoupper($_SERVER['HTTPS']) === 'ON') {\n        $protocol = 'https';\n    }\n    header('Location: '.$protocol.'://'.$_SERVER['HTTP_HOST'].dirname($_SERVER['SCRIPT_NAME']));\n    exit();\n}\n\n// Send headers\n$http = new PMF_Helper_Http();\n$http->setContentType('application/json');\n$http->addHeader();\n\n$ajaxAction = PMF_Filter::filterInput(INPUT_GET, 'ajaxaction', FILTER_SANITIZE_STRING);\n\n$oTag = new PMF_Tags($faqConfig);\n\nswitch ($ajaxAction) {\n\n    case 'list':\n        $autoCompleteValue = PMF_Filter::filterInput(INPUT_GET, 'q', FILTER_SANITIZE_STRIPPED);\n\n        if (!is_null($autoCompleteValue)) {\n            if (strpos($autoCompleteValue, ',')) {\n                $arrayOfValues = explode(',', $autoCompleteValue);\n                $autoCompleteValue = end($arrayOfValues);\n            }\n            $tags = $oTag->getAllTags(strtolower(trim($autoCompleteValue)), PMF_TAGS_CLOUD_RESULT_SET_SIZE, true);\n        } else {\n            $tags = $oTag->getAllTags();\n        }\n\n        if ($user->perm->checkRight($user->getUserId(), 'editbt')) {\n            $i = 0;\n            $tagNames = [];\n            foreach ($tags as $tagName) {\n                ++$i;\n                if ($i <= PMF_TAGS_AUTOCOMPLETE_RESULT_SET_SIZE) {\n                    $currentTag = new stdClass();\n                    $currentTag->tagName = $tagName;\n                    $tagNames['results'][] = $currentTag;\n                }\n            }\n\n            echo json_encode($tagNames);\n        }\n        break;\n\n    case 'update':\n\n        $id = PMF_Filter::filterInput(INPUT_POST, 'id', FILTER_VALIDATE_INT);\n        $tag = PMF_Filter::filterInput(INPUT_POST, 'tag', FILTER_SANITIZE_STRING);\n        $csrfToken = PMF_Filter::filterInput(INPUT_POST, 'csrf', FILTER_SANITIZE_STRING);\n\n        if (!isset($_SESSION['phpmyfaq_csrf_token']) || $_SESSION['phpmyfaq_csrf_token'] !== $csrfToken) {\n            echo json_encode($PMF_LANG['err_NotAuth']);\n            exit(1);\n        }\n\n        $entity = new PMF_Entity_Tags();\n        $entity->setId($id);\n        $entity->setName($tag);\n\n        if ($oTag->updateTag($entity)) {\n            echo json_encode($PMF_LANG['ad_entryins_suc']);\n        } else {\n            echo json_encode($PMF_LANG['ad_entryins_fail']);\n        }\n        break;\n}\n", "/**\n * JavaScript functions for all tag administration stuff\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @category  phpMyFAQ\n * @package   Administration\n * @author    Thorsten Rinne <thorsten@phpmyfaq.de>\n * @copyright 2014-2017 phpMyFAQ Team\n * @license   http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n * @link      http://www.phpmyfaq.de\n * @since     2014-08-16\n */\n\n/*global $:false */\n\n$(document).ready(function () {\n    'use strict';\n\n    $('.btn-edit').on('click', function () {\n        var id = $(this).data('btn-id');\n        var span = $('span[data-tag-id=\"' + id + '\"]');\n\n        if (span.length > 0) {\n            span.replaceWith(\n                '<input name=\"tag\" class=\"form-control\" data-tag-id=\"' + id + '\" value=\"' + span.html() + '\">'\n            );\n        } else {\n            var input = $('input[data-tag-id=\"' + id + '\"]');\n            input.replaceWith('<span data-tag-id=\"' + id + '\">' + input.val().replace(/\\//g, '&#x2F;') + '</span>');\n        }\n    });\n\n    $('.tag-form').bind('submit', function (event) {\n\n        event.preventDefault();\n\n        var input = $('input[data-tag-id]:focus');\n        var id = input.data('tag-id');\n        var tag = input.val();\n        var csrf = $('input[name=csrf]').val();\n\n        $.ajax({\n            url: 'index.php?action=ajax&ajax=tags&ajaxaction=update',\n            type: 'POST',\n            data: 'id=' + id + '&tag=' + tag + '&csrf=' + csrf,\n            dataType: 'json',\n            beforeSend: function () {\n                $('#saving_data_indicator').html(\n                    '<i aria-hidden=\"true\" class=\"fa fa-spinner fa-spin\"></i> Saving ...'\n                );\n            },\n            success: function (message) {\n                input.replaceWith('<span data-tag-id=\"' + id + '\">' + input.val().replace(/\\//g, '&#x2F;') + '</span>');\n                $('span[data-tag-id=\"' + id + '\"]');\n                $('#saving_data_indicator').html(message);\n            }\n        });\n\n        return false;\n    });\n});\n", "<?php\n/**\n * Frontend for Backup and Restore.\n *\n * PHP Version 5.5\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @category  phpMyFAQ\n *\n * @author    Thorsten Rinne <thorsten@phpmyfaq.de>\n * @copyright 2003-2017 phpMyFAQ Team\n * @license   http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n *\n * @link      http://www.phpmyfaq.de\n * @since     2003-02-24\n */\nif (!defined('IS_VALID_PHPMYFAQ')) {\n    $protocol = 'http';\n    if (isset($_SERVER['HTTPS']) && strtoupper($_SERVER['HTTPS']) === 'ON') {\n        $protocol = 'https';\n    }\n    header('Location: '.$protocol.'://'.$_SERVER['HTTP_HOST'].dirname($_SERVER['SCRIPT_NAME']));\n    exit();\n}\n\n?>\n    <header class=\"row\">\n        <div class=\"col-lg-12\">\n            <h2 class=\"page-header\">\n                <i aria-hidden=\"true\" class=\"fa fa-tags\"></i> <?php echo $PMF_LANG['ad_entry_tags'] ?>\n            </h2>\n        </div>\n    </header>\n\n    <div class=\"row\">\n        <div class=\"col-lg-12\">\n            <form action=\"\" method=\"post\" class=\"tag-form\">\n                <input type=\"hidden\" name=\"csrf\" value=\"<?php echo $user->getCsrfTokenFromSession() ?>\">\n<?php\nif ($user->perm->checkRight($user->getUserId(), 'editbt')) {\n    $tags = new PMF_Tags($faqConfig);\n\n    if ('deletetag' == $action) {\n        $id = PMF_Filter::filterInput(INPUT_GET, 'id', FILTER_VALIDATE_INT);\n        if ($tags->deleteTag($id)) {\n            echo '<p class=\"alert alert-success\"><a href=\"#\" class=\"close\" data-dismiss=\"alert\">\u00d7</a>';\n            echo $PMF_LANG['ad_tag_delete_success'].'</p>';\n        } else {\n            echo '<p class=\"alert alert-danger\"><a href=\"#\" class=\"close\" data-dismiss=\"alert\">\u00d7</a>';\n            echo $PMF_LANG['ad_tag_delete_error'];\n            echo '<br />'.$PMF_LANG['ad_adus_dberr'].'<br />';\n            echo $faqConfig->getDb()->error().'</p>';\n        }\n    }\n\n    $tagData = $tags->getAllTags();\n\n    echo '<table class=\"table table-striped\">';\n    echo '<tbody>';\n\n    foreach ($tagData as $key => $tag) {\n        echo '<tr>';\n        echo '<td><span data-tag-id=\"'.$key.'\">'.PMF_String::htmlspecialchars($tag).'</span></td>';\n        printf(\n            '<td><a class=\"btn btn-primary btn-edit\" data-btn-id=\"%d\" title=\"%s\"><i aria-hidden=\"true\" class=\"fa fa-edit\"></i></a></td>',\n            $key,\n            $PMF_LANG['ad_user_edit']\n        );\n\n        printf(\n            '<td><a class=\"btn btn-danger\" onclick=\"return confirm(\\'%s\\'); return false;\" href=\"%s%d\">',\n            $PMF_LANG['ad_user_del_3'],\n            '?action=deletetag&amp;id=',\n            $key\n        );\n        printf(\n            '<span title=\"%s\"><i aria-hidden=\"true\" class=\"fa fa-trash-o\"></i></span></a></td>',\n            $PMF_LANG['ad_entry_delete']\n        );\n\n        echo '<tr>';\n    }\n\n    echo '</tbody>';\n    echo '</table>';\n} else {\n    echo $PMF_LANG['err_NotAuth'];\n}\n?>\n            </form>\n            <script src=\"assets/js/tags.js\"></script>\n        </div>\n    </div>"], "filenames": ["phpmyfaq/admin/ajax.tags.php", "phpmyfaq/admin/assets/js/tags.js", "phpmyfaq/admin/tags.main.php"], "buggy_code_start_loc": [72, 32, 41], "buggy_code_end_loc": [72, 58, 67], "fixing_code_start_loc": [73, 32, 41], "fixing_code_end_loc": [79, 59, 67], "type": "CWE-79", "message": "In phpMyFaq before 2.9.9, there is XSS in admin/tags.main.php via a crafted tag.", "other": {"cve": {"id": "CVE-2017-15809", "sourceIdentifier": "cve@mitre.org", "published": "2017-10-23T17:29:00.613", "lastModified": "2017-10-25T08:24:29.057", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "In phpMyFaq before 2.9.9, there is XSS in admin/tags.main.php via a crafted tag."}, {"lang": "es", "value": "En phpMyFaq en versiones anteriores a la 2.9.9, existe Cross-Site Scripting (XSS) en admin/tags.main.php mediante una etiqueta manipulada."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:phpmyfaq:phpmyfaq:*:*:*:*:*:*:*:*", "versionEndIncluding": "2.9.8", "matchCriteriaId": "1D0B1C07-83F7-4DB0-976C-51483D7DF516"}]}]}], "references": [{"url": "https://github.com/thorsten/phpMyFAQ/commit/cb648f0d5690b81647dd5c9efe942ebf6cce7da9", "source": "cve@mitre.org", "tags": ["Issue Tracking", "Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/thorsten/phpMyFAQ/commit/cb648f0d5690b81647dd5c9efe942ebf6cce7da9"}}