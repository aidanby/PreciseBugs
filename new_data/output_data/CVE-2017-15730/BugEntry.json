{"buggy_code": ["<?php\n/**\n * The page with the ratings of the votings.\n *\n * PHP Version 5.5\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @category  phpMyFAQ\n *\n * @author    Thorsten Rinne <thorsten@phpmyfaq.de>\n * @copyright 2003-2017 phpMyFAQ Team\n * @license   http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n *\n * @link      http://www.phpmyfaq.de\n * @since     2003-02-24\n */\nif (!defined('IS_VALID_PHPMYFAQ')) {\n    $protocol = 'http';\n    if (isset($_SERVER['HTTPS']) && strtoupper($_SERVER['HTTPS']) === 'ON') {\n        $protocol = 'https';\n    }\n    header('Location: '.$protocol.'://'.$_SERVER['HTTP_HOST'].dirname($_SERVER['SCRIPT_NAME']));\n    exit();\n}\n\nif ($user->perm->checkRight($user->getUserId(), 'viewlog')) {\n    $category = new PMF_Category($faqConfig, [], false);\n    $category->setUser($currentAdminUser);\n    $category->setGroups($currentAdminGroups);\n    $ratings = new PMF_Rating($faqConfig);\n    $ratingdata = $ratings->getAllRatings();\n    $numratings = count($ratingdata);\n    $oldcategory = 0;\n    ?>\n        <header class=\"row\">\n            <div class=\"col-lg-12\">\n                <h2 class=\"page-header\">\n                    <i aria-hidden=\"true\" class=\"fa fa-tasks\"></i> <?php echo $PMF_LANG['ad_rs'] ?>\n\n                    <div class=\"pull-right\">\n                        <a class=\"btn btn-danger\" href=\"?action=clear-statistics\">\n                            <i aria-hidden=\"true\" class=\"fa fa-trash\"></i> <?php echo $PMF_LANG['ad_delete_all_votings'] ?>\n                        </a>\n                    </div>\n                </h2>\n            </div>\n        </header>\n\n<?php\n    if ('clear-statistics' === $action) {\n        if ($ratings->deleteAll()) {\n            echo '<p class=\"alert alert-success\">Statistics successfully deleted.</p>';\n        } else {\n            echo '<p class=\"alert alert-danger\">Statistics not deleted.</p>';\n        }\n    }\n    ?>\n\n        <div class=\"row\">\n            <div class=\"col-lg-12\">\n                <table class=\"table table-striped\">\n                    <tbody>\n<?php\n    foreach ($ratingdata as $data) {\n        if ($data['category_id'] != $oldcategory) {\n            ?>\n                    <tr>\n                        <th colspan=\"6\" style=\"text-align: left;\">\n                            <h4><?php echo $category->categoryName[$data['category_id']]['name'];\n            ?></h4>\n                        </th>\n                    </tr>\n<?php\n\n        }\n\n        $question = PMF_String::htmlspecialchars(trim($data['question']));\n        $url = sprintf(\n            '../index.php?action=artikel&amp;cat=%d&amp;id=%d&amp;artlang=%s',\n            $data['category_id'],\n            $data['id'],\n            $data['lang']\n        );\n        ?>\n                    <tr>\n                        <td><?php echo $data['id'];\n        ?></td>\n                        <td><?php echo $data['lang'];\n        ?></td>\n                        <td>\n                            <a href=\"<?php echo $url ?>\" title=\"<?php echo $question;\n        ?>\">\n                                <?php echo PMF_Utils::makeShorterText($question, 14);\n        ?>\n                            </a>\n                        </td>\n                        <td><?php echo $data['usr'];\n        ?></td>\n                        <td>\n                            <?php\n                            if (round($data['num'] * 20) > 75) {\n                                $progressBar = 'success';\n                            } elseif (round($data['num'] * 20) < 25) {\n                                $progressBar = 'danger';\n                            } else {\n                                $progressBar = 'info';\n                            }\n        ?>\n                            <meter value=\"<?php echo round($data['num'] * 20);\n        ?>\" max=\"100\" min=\"0\" low=\"25\" optimum=\"75\"></meter>\n                        </td>\n                        <td><?php echo round($data['num'] * 20);\n        ?>%</td>\n                    </tr>\n<?php\n        $oldcategory = $data['category_id'];\n    }\n    ?>\n                    </tbody>\n<?php if ($numratings > 0) {\n    ?>\n                    <tfoot>\n                        <tr>\n                            <td colspan=\"6\">\n                                <small>\n                                <span style=\"color: green; font-weight: bold;\">\n                                    <?php echo $PMF_LANG['ad_rs_green'] ?>\n                                </span>\n                                <?php echo $PMF_LANG['ad_rs_ahtf'] ?>,\n                                <span style=\"color: red; font-weight: bold;\">\n                                    <?php echo $PMF_LANG['ad_rs_red'] ?>\n                                </span>\n                                <?php echo $PMF_LANG['ad_rs_altt'] ?>\n                                </small>\n                            </td>\n                        </tr>\n                    </tfoot>\n<?php \n} else {\n    ?>\n                    <tfoot>\n                        <tr>\n                            <td colspan=\"6\"><?php echo $PMF_LANG['ad_rs_no'] ?></td>\n                        </tr>\n                    </tfoot>\n<?php \n}\n    ?>\n                </table>\n            </div>\n        </div>\n<?php\n\n} else {\n    echo $PMF_LANG['err_NotAuth'];\n}\n"], "fixing_code": ["<?php\n/**\n * The page with the ratings of the votings.\n *\n * PHP Version 5.5\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @category  phpMyFAQ\n *\n * @author    Thorsten Rinne <thorsten@phpmyfaq.de>\n * @copyright 2003-2017 phpMyFAQ Team\n * @license   http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n *\n * @link      http://www.phpmyfaq.de\n * @since     2003-02-24\n */\nif (!defined('IS_VALID_PHPMYFAQ')) {\n    $protocol = 'http';\n    if (isset($_SERVER['HTTPS']) && strtoupper($_SERVER['HTTPS']) === 'ON') {\n        $protocol = 'https';\n    }\n    header('Location: '.$protocol.'://'.$_SERVER['HTTP_HOST'].dirname($_SERVER['SCRIPT_NAME']));\n    exit();\n}\n\nif ($user->perm->checkRight($user->getUserId(), 'viewlog')) {\n    $category = new PMF_Category($faqConfig, [], false);\n    $category->setUser($currentAdminUser);\n    $category->setGroups($currentAdminGroups);\n    $ratings = new PMF_Rating($faqConfig);\n    $ratingdata = $ratings->getAllRatings();\n    $numratings = count($ratingdata);\n    $oldcategory = 0;\n    ?>\n        <header class=\"row\">\n            <div class=\"col-lg-12\">\n                <h2 class=\"page-header\">\n                    <i aria-hidden=\"true\" class=\"fa fa-tasks\"></i> <?php echo $PMF_LANG['ad_rs'] ?>\n\n                    <div class=\"pull-right\">\n                        <a class=\"btn btn-danger\" \n                           href=\"?action=clear-statistics&csrf=<?php echo $user->getCsrfTokenFromSession() ?>\">\n                            <i aria-hidden=\"true\" class=\"fa fa-trash\"></i> <?php echo $PMF_LANG['ad_delete_all_votings'] ?>\n                        </a>\n                    </div>\n                </h2>\n            </div>\n        </header>\n\n<?php\n    $csrfToken = PMF_Filter::filterInput(INPUT_GET, 'csrf', FILTER_SANITIZE_STRING);\n\n    if (!isset($_SESSION['phpmyfaq_csrf_token']) || $_SESSION['phpmyfaq_csrf_token'] !== $csrfToken) {\n        $clearStatistics = false;\n    } else {\n        $clearStatistics = true;\n    }\n\n    if ('clear-statistics' === $action && $clearStatistics) {\n        if ($ratings->deleteAll()) {\n            echo '<p class=\"alert alert-success\">Statistics successfully deleted.</p>';\n        } else {\n            echo '<p class=\"alert alert-danger\">Statistics not deleted.</p>';\n        }\n    }\n    ?>\n\n        <div class=\"row\">\n            <div class=\"col-lg-12\">\n                <table class=\"table table-striped\">\n                    <tbody>\n<?php\n    foreach ($ratingdata as $data) {\n        if ($data['category_id'] != $oldcategory) {\n            ?>\n                    <tr>\n                        <th colspan=\"6\" style=\"text-align: left;\">\n                            <h4><?php echo $category->categoryName[$data['category_id']]['name'];\n            ?></h4>\n                        </th>\n                    </tr>\n<?php\n\n        }\n\n        $question = PMF_String::htmlspecialchars(trim($data['question']));\n        $url = sprintf(\n            '../index.php?action=artikel&amp;cat=%d&amp;id=%d&amp;artlang=%s',\n            $data['category_id'],\n            $data['id'],\n            $data['lang']\n        );\n        ?>\n                    <tr>\n                        <td><?php echo $data['id'];\n        ?></td>\n                        <td><?php echo $data['lang'];\n        ?></td>\n                        <td>\n                            <a href=\"<?php echo $url ?>\" title=\"<?php echo $question;\n        ?>\">\n                                <?php echo PMF_Utils::makeShorterText($question, 14);\n        ?>\n                            </a>\n                        </td>\n                        <td><?php echo $data['usr'];\n        ?></td>\n                        <td>\n                            <?php\n                            if (round($data['num'] * 20) > 75) {\n                                $progressBar = 'success';\n                            } elseif (round($data['num'] * 20) < 25) {\n                                $progressBar = 'danger';\n                            } else {\n                                $progressBar = 'info';\n                            }\n        ?>\n                            <meter value=\"<?php echo round($data['num'] * 20);\n        ?>\" max=\"100\" min=\"0\" low=\"25\" optimum=\"75\"></meter>\n                        </td>\n                        <td><?php echo round($data['num'] * 20);\n        ?>%</td>\n                    </tr>\n<?php\n        $oldcategory = $data['category_id'];\n    }\n    ?>\n                    </tbody>\n<?php if ($numratings > 0) {\n    ?>\n                    <tfoot>\n                        <tr>\n                            <td colspan=\"6\">\n                                <small>\n                                <span style=\"color: green; font-weight: bold;\">\n                                    <?php echo $PMF_LANG['ad_rs_green'] ?>\n                                </span>\n                                <?php echo $PMF_LANG['ad_rs_ahtf'] ?>,\n                                <span style=\"color: red; font-weight: bold;\">\n                                    <?php echo $PMF_LANG['ad_rs_red'] ?>\n                                </span>\n                                <?php echo $PMF_LANG['ad_rs_altt'] ?>\n                                </small>\n                            </td>\n                        </tr>\n                    </tfoot>\n<?php \n} else {\n    ?>\n                    <tfoot>\n                        <tr>\n                            <td colspan=\"6\"><?php echo $PMF_LANG['ad_rs_no'] ?></td>\n                        </tr>\n                    </tfoot>\n<?php \n}\n    ?>\n                </table>\n            </div>\n        </div>\n<?php\n\n} else {\n    echo $PMF_LANG['err_NotAuth'];\n}\n"], "filenames": ["phpmyfaq/admin/stat.ratings.php"], "buggy_code_start_loc": [44], "buggy_code_end_loc": [54], "fixing_code_start_loc": [44], "fixing_code_end_loc": [63], "type": "CWE-352", "message": "In phpMyFAQ before 2.9.9, there is Cross-Site Request Forgery (CSRF) in admin/stat.ratings.php.", "other": {"cve": {"id": "CVE-2017-15730", "sourceIdentifier": "cve@mitre.org", "published": "2017-10-22T18:29:00.417", "lastModified": "2019-03-14T14:06:54.787", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "In phpMyFAQ before 2.9.9, there is Cross-Site Request Forgery (CSRF) in admin/stat.ratings.php."}, {"lang": "es", "value": "En phpMyFAQ en versiones anteriores a la 2.9.9 hay Cross-Site Request Forgery (CSRF) en admin/stat.ratings.php."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 8.8, "baseSeverity": "HIGH"}, "exploitabilityScore": 2.8, "impactScore": 5.9}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:P/I:P/A:P", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "PARTIAL", "integrityImpact": "PARTIAL", "availabilityImpact": "PARTIAL", "baseScore": 6.8}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 6.4, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-352"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:phpmyfaq:phpmyfaq:*:*:*:*:*:*:*:*", "versionEndIncluding": "2.9.8", "matchCriteriaId": "1D0B1C07-83F7-4DB0-976C-51483D7DF516"}]}]}], "references": [{"url": "https://github.com/thorsten/phpMyFAQ/commit/cce47f94375bb0102ab4f210672231dbb854dd0d", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://www.exploit-db.com/exploits/43064/", "source": "cve@mitre.org", "tags": ["Exploit", "Third Party Advisory", "VDB Entry"]}]}, "github_commit_url": "https://github.com/thorsten/phpMyFAQ/commit/cce47f94375bb0102ab4f210672231dbb854dd0d"}}