{"buggy_code": ["<?php\nsession_start();\ndefine('NO_AUTH_REQUIRED',true);\n$TAB = 'RESET PASSWORD';\n\nif (isset($_SESSION['user'])) {\n    header(\"Location: /list/user\");\n}\n\n// Main include\ninclude($_SERVER['DOCUMENT_ROOT'].\"/inc/main.php\");\n\nif ((!empty($_POST['user'])) && (empty($_POST['code']))) {\n    $v_user = escapeshellarg($_POST['user']);\n    $user = $_POST['user'];\n    $cmd=\"/usr/bin/sudo /usr/local/vesta/bin/v-list-user\";\n    exec ($cmd.\" \".$v_user.\" json\", $output, $return_var);\n    if ( $return_var == 0 ) {\n        $data = json_decode(implode('', $output), true);\n        $rkey = $data[$user]['RKEY'];\n        $fname = $data[$user]['FNAME'];\n        $lname = $data[$user]['LNAME'];\n        $contact = $data[$user]['CONTACT'];\n        $to = $data[$user]['CONTACT'];\n        $subject = __('MAIL_RESET_SUBJECT',date(\"Y-m-d H:i:s\"));\n        $hostname = exec('hostname');\n        $from = __('MAIL_FROM',$hostname);\n        if (!empty($fname)) {\n            $mailtext = __('GREETINGS_GORDON_FREEMAN',$fname,$lname);\n        } else {\n            $mailtext = __('GREETINGS');\n        }\n        $mailtext .= __('PASSWORD_RESET_REQUEST',$_SERVER['HTTP_HOST'],$user,$rkey,$_SERVER['HTTP_HOST'],$user,$rkey);\n        if (!empty($rkey)) send_email($to, $subject, $mailtext, $from);\n        unset($output);\n    }\n\n    header(\"Location: /reset/?action=code&user=\".$_POST['user']);\n    exit;\n}\n\nif ((!empty($_POST['user'])) && (!empty($_POST['code'])) && (!empty($_POST['password'])) ) {\n    if ( $_POST['password'] == $_POST['password_confirm'] ) {\n        $v_user = escapeshellarg($_POST['user']);\n        $user = $_POST['user'];\n        $cmd=\"/usr/bin/sudo /usr/local/vesta/bin/v-list-user\";\n        exec ($cmd.\" \".$v_user.\" json\", $output, $return_var);\n        if ( $return_var == 0 ) {\n            $data = json_decode(implode('', $output), true);\n            $rkey = $data[$user]['RKEY'];\n            if (hash_equals($rkey, $_POST['code'])) {\n                $v_password = tempnam(\"/tmp\",\"vst\");\n                $fp = fopen($v_password, \"w\");\n                fwrite($fp, $_POST['password'].\"\\n\");\n                fclose($fp);\n                $cmd=\"/usr/bin/sudo /usr/local/vesta/bin/v-change-user-password\";\n                exec ($cmd.\" \".$v_user.\" \".$v_password, $output, $return_var);\n                unlink($v_password);\n                if ( $return_var > 0 ) {\n                    $ERROR = \"<a class=\\\"error\\\">\".__('An internal error occurred').\"</a>\";\n                } else {\n                    $_SESSION['user'] = $_POST['user'];\n                    header(\"Location: /\");\n                    exit;\n                }\n            } else {\n                $ERROR = \"<a class=\\\"error\\\">\".__('Invalid username or code').\"</a>\";\n            }\n        } else {\n            $ERROR = \"<a class=\\\"error\\\">\".__('Invalid username or code').\"</a>\";\n        }\n    } else {\n        $ERROR = \"<a class=\\\"error\\\">\".__('Passwords not match').\"</a>\";\n    }\n}\n\n// Detect language\nif (empty($_SESSION['language'])) $_SESSION['language'] = detect_user_language();\n\nif (empty($_GET['action'])) {\n    require_once '../templates/header.html';\n    require_once '../templates/reset_1.html';\n} else {\n    require_once '../templates/header.html';\n    if ($_GET['action'] == 'code' ) {\n        require_once '../templates/reset_2.html';\n    }\n    if (($_GET['action'] == 'confirm' ) && (!empty($_GET['code']))) {\n        require_once '../templates/reset_3.html';\n    }\n}\n\n?>\n"], "fixing_code": ["<?php\nsession_start();\ndefine('NO_AUTH_REQUIRED',true);\n$TAB = 'RESET PASSWORD';\n\nif (isset($_SESSION['user'])) {\n    header(\"Location: /list/user\");\n}\n\n// Main include\ninclude($_SERVER['DOCUMENT_ROOT'].\"/inc/main.php\");\n\nif ((!empty($_POST['user'])) && (empty($_POST['code']))) {\n    $v_user = escapeshellarg($_POST['user']);\n    $user = $_POST['user'];\n    $cmd=\"/usr/bin/sudo /usr/local/vesta/bin/v-list-user\";\n    exec ($cmd.\" \".$v_user.\" json\", $output, $return_var);\n    if ( $return_var == 0 ) {\n        $data = json_decode(implode('', $output), true);\n        $rkey = $data[$user]['RKEY'];\n        $fname = $data[$user]['FNAME'];\n        $lname = $data[$user]['LNAME'];\n        $contact = $data[$user]['CONTACT'];\n        $to = $data[$user]['CONTACT'];\n        $subject = __('MAIL_RESET_SUBJECT',date(\"Y-m-d H:i:s\"));\n        $hostname = exec('hostname');\n        $from = __('MAIL_FROM',$hostname);\n        if (!empty($fname)) {\n            $mailtext = __('GREETINGS_GORDON_FREEMAN',$fname,$lname);\n        } else {\n            $mailtext = __('GREETINGS');\n        }\n        $mailtext .= __('PASSWORD_RESET_REQUEST',$hostname,$user,$rkey,$hostname,$user,$rkey);\n        if (!empty($rkey)) send_email($to, $subject, $mailtext, $from);\n        unset($output);\n    }\n\n    header(\"Location: /reset/?action=code&user=\".$_POST['user']);\n    exit;\n}\n\nif ((!empty($_POST['user'])) && (!empty($_POST['code'])) && (!empty($_POST['password'])) ) {\n    if ( $_POST['password'] == $_POST['password_confirm'] ) {\n        $v_user = escapeshellarg($_POST['user']);\n        $user = $_POST['user'];\n        $cmd=\"/usr/bin/sudo /usr/local/vesta/bin/v-list-user\";\n        exec ($cmd.\" \".$v_user.\" json\", $output, $return_var);\n        if ( $return_var == 0 ) {\n            $data = json_decode(implode('', $output), true);\n            $rkey = $data[$user]['RKEY'];\n            if (hash_equals($rkey, $_POST['code'])) {\n                $v_password = tempnam(\"/tmp\",\"vst\");\n                $fp = fopen($v_password, \"w\");\n                fwrite($fp, $_POST['password'].\"\\n\");\n                fclose($fp);\n                $cmd=\"/usr/bin/sudo /usr/local/vesta/bin/v-change-user-password\";\n                exec ($cmd.\" \".$v_user.\" \".$v_password, $output, $return_var);\n                unlink($v_password);\n                if ( $return_var > 0 ) {\n                    $ERROR = \"<a class=\\\"error\\\">\".__('An internal error occurred').\"</a>\";\n                } else {\n                    $_SESSION['user'] = $_POST['user'];\n                    header(\"Location: /\");\n                    exit;\n                }\n            } else {\n                $ERROR = \"<a class=\\\"error\\\">\".__('Invalid username or code').\"</a>\";\n            }\n        } else {\n            $ERROR = \"<a class=\\\"error\\\">\".__('Invalid username or code').\"</a>\";\n        }\n    } else {\n        $ERROR = \"<a class=\\\"error\\\">\".__('Passwords not match').\"</a>\";\n    }\n}\n\n// Detect language\nif (empty($_SESSION['language'])) $_SESSION['language'] = detect_user_language();\n\nif (empty($_GET['action'])) {\n    require_once '../templates/header.html';\n    require_once '../templates/reset_1.html';\n} else {\n    require_once '../templates/header.html';\n    if ($_GET['action'] == 'code' ) {\n        require_once '../templates/reset_2.html';\n    }\n    if (($_GET['action'] == 'confirm' ) && (!empty($_GET['code']))) {\n        require_once '../templates/reset_3.html';\n    }\n}\n\n?>\n"], "filenames": ["web/reset/index.php"], "buggy_code_start_loc": [33], "buggy_code_end_loc": [34], "fixing_code_start_loc": [33], "fixing_code_end_loc": [34], "type": "NVD-CWE-Other", "message": "In the Password Reset Module in VESTA Control Panel through 0.9.8-25 and Hestia Control Panel before 1.1.1, Host header manipulation leads to account takeover because the victim receives a reset URL containing an attacker-controlled server name.", "other": {"cve": {"id": "CVE-2020-10966", "sourceIdentifier": "cve@mitre.org", "published": "2020-03-25T23:15:16.217", "lastModified": "2022-07-12T17:42:04.277", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "In the Password Reset Module in VESTA Control Panel through 0.9.8-25 and Hestia Control Panel before 1.1.1, Host header manipulation leads to account takeover because the victim receives a reset URL containing an attacker-controlled server name."}, {"lang": "es", "value": "En el Password Reset Module en VESTA Control Panel versiones hasta 0.9.8-25 y Hestia Control Panel versiones hasta 1.1.0, la manipulaci\u00f3n del encabezado Host conlleva a la toma de control de la cuenta porque la v\u00edctima recibe un URL de restablecimiento que contiene un nombre de servidor controlado por el atacante."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:N/I:H/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "UNCHANGED", "confidentialityImpact": "NONE", "integrityImpact": "HIGH", "availabilityImpact": "NONE", "baseScore": 6.5, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 3.6}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "NVD-CWE-Other"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:hestiacp:control_panel:*:*:*:*:*:*:*:*", "versionEndExcluding": "1.1.1", "matchCriteriaId": "73066D92-0ECA-47E0-93B6-33A0A3A7582F"}, {"vulnerable": true, "criteria": "cpe:2.3:a:vestacp:control_panel:*:*:*:*:*:*:*:*", "versionEndIncluding": "0.9.8-25", "matchCriteriaId": "AA062E69-DEAB-4E77-9F13-636F8F153D02"}]}]}], "references": [{"url": "https://github.com/hestiacp/hestiacp/issues/748", "source": "cve@mitre.org", "tags": ["Exploit", "Third Party Advisory"]}, {"url": "https://github.com/hestiacp/hestiacp/releases/tag/1.1.1", "source": "cve@mitre.org", "tags": ["Third Party Advisory"]}, {"url": "https://github.com/serghey-rodin/vesta/commit/c3c4de43d6701560f604ca7996f717b08e3d7d1d", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/serghey-rodin/vesta/commit/c3c4de43d6701560f604ca7996f717b08e3d7d1d"}}