{"buggy_code": ["# Release Notes for Craft CMS 3.x\n\n## Unreleased\n\n### Added\n- Added `craft\\web\\Request::getNormalizedContentType()`.\n\n### Changed\n- Eliminated a `SHOW TABLES` SQL query that was getting executed on every request.\n- Craft no longer routes requests based on `action` params in the request body, if the request\u2019s content type is `application/json`.\n- Updated Twig to 2.12.\n\n### Fixed\n- Fixed a SQL error that could occur when deleting an entry or category with three or more nested levels of elements. ([#3456](https://github.com/craftcms/cms/issues/3456))\n- Fixed a bug where deleting an entry or category with nested elements could leave the structure in a jumbled state.\n- Fixed a PHP error occurred when viewing the PHP Info utility if `register_argc_argv` was set to `On` in `php.ini`. ([#4878](https://github.com/craftcms/cms/issues/4878))\n- Fixed a bug where the `resave/matrix-blocks` command would wittingly resave Matrix blocks even if they hadn\u2019t been loaded with their content, resulting in lost content. ([#5030](https://github.com/craftcms/cms/issues/5030))\n\n## 3.3.7 - 2019-10-03\n\n### Changed\n- When saving a user, email validation errors are now copied over to the `email` attribute from the `unverifiedEmail` attribute. ([#5019](https://github.com/craftcms/cms/issues/5019))\n- `craft\\web\\View::renderString()` and `renderObjectTemplate()` now have `$templateMode` arguments. ([#5020](https://github.com/craftcms/cms/issues/5020))\n\n### Fixed\n- Fixed a bug where the Edit User page would list a \u201cCopy activation URL\u201d action for publicly-registered users who already had a password set.\n- Fixed a bug where the list and structure icons were missing on element index pages for RTL languages. ([#5018](https://github.com/craftcms/cms/issues/5018))\n- Fixed a bug where the `prevSiblingOf` and `nextSiblingOf` element query params weren\u2019t working reliably. ([#4997](https://github.com/craftcms/cms/issues/4997))\n- Fixed a bug where the `descendantOf` element query param wasn\u2019t working when previewing a draft or revision. ([#5021](https://github.com/craftcms/cms/issues/5021))\n- Fixed a PHP error that occurred when saving a Dropdown or Multi-select field with optgroups. ([#5014](https://github.com/craftcms/cms/issues/5014))\n- Fixed a bug where relational fields that were managing relations on a per-site basis would forget other sites\u2019 relations when duplicated. ([#5038](https://github.com/craftcms/cms/issues/5038))\n\n## 3.3.6 - 2019-09-27\n\n### Added\n- Added `craft\\base\\ElementInterface::getIsHomepage()`. ([#4993](https://github.com/craftcms/cms/issues/4993))\n- Added `craft\\base\\Element::HOMEPAGE_URI`.\n\n### Changed\n- Updated Garnish to 0.1.31.\n\n### Fixed\n- Fixed a bug where some HTML in the Control Panel was getting improperly encoded. ([#5002](https://github.com/craftcms/cms/issues/5002))\n- Fixed a bug where `craft\\helper\\UrlHelper` wasn\u2019t encoding `+` and `&` characters in query param values.\n- Fixed an error where GraphQL would sometimes not return a proper error message. ([#4999](https://github.com/craftcms/cms/issues/4999))\n- Fixed a bug where HUDs could be positioned incorrectly when first opened. ([#5004](https://github.com/craftcms/cms/issues/5004))\n- Fixed a bug where HUD tip images could be pointing the wrong way for RTL languages.\n\n## 3.3.5 - 2019-09-25\n\n### Added\n- The Control Panel is now translated into Persian. ([#4969](https://github.com/craftcms/cms/pull/4969))\n- Added `craft\\test\\fixtures\\elements\\ElementFixture::$unload`.\n\n### Changed\n- All users with permission to register users can now choose to not have an activation email sent immediately, when registering a new user. ([#4981](https://github.com/craftcms/cms/pull/4981))\n- Craft now shows validation errors when attempting to save a Dropdown, Radio Buttons, Checkboxes, or Multi-select field with duplicate option labels or values. ([#4983](https://github.com/craftcms/cms/issues/4983))\n- Live Preview requests now have an `x-craft-live-preview` query string param, rather than `x-craft-preview`. ([#4950](https://github.com/craftcms/cms/issues/4950))\n- The `_includes/pagination.html` template can now be passed `itemLabel` and `itemsLabel` variables.\n- Any migrations applied during testing are now recorded as content migrations.\n- Added the option to automatically apply all content migrations when setting up the test environment. ([#4904](https://github.com/craftcms/cms/issues/4904))\n- `craft\\helpers\\Html::parseTagAttributes()` now has a `$decode` argument.\n- `craft\\test\\fixtures\\elements\\GlobalSetFixture` now has the option to load the active record instance. ([#4947](https://github.com/craftcms/cms/pull/4947))\n\n### Fixed\n- Fixed a bug where checkbox inputs were positioned incorrectly for RTL languages.\n- Fixed a bug where the updater and `project.yaml` sync pages weren\u2019t always handling error responses correctly. ([#4988](https://github.com/craftcms/cms/issues/4988))\n- Fixed an error that could occur when syncing the project config, if a volume was being deleted that didn\u2019t exist in the database to begin with. ([#4990](https://github.com/craftcms/cms/pull/4990))\n- Fixed an error that could occur if a project config value changed from scalar to an array. ([#4932](https://github.com/craftcms/cms/issues/4932))\n- Fixed a bug where Craft would not recognize certain block types when using the GraphQL API. ([#4961](https://github.com/craftcms/cms/issues/4961))\n- Fixed a bug where `craft\\helpers\\Html::renderTagAttributes()` was double-encoding preexisting attributes. ([#4984](https://github.com/craftcms/cms/issues/4984))\n\n## 3.3.4.1 - 2019-09-17\n\n### Fixed\n- Fixed a bug where elements with enabled Lightswitch fields weren\u2019t getting returned in element queries. ([#4951](https://github.com/craftcms/cms/issues/4951))\n\n## 3.3.4 - 2019-09-17\n\n### Changed\n- It\u2019s now possible to run the `migrate/create install` command for uninstalled plugins.\n- Improved the button labels in the confirmation dialog that can appear after running the Asset Indexes utility. ([#4943](https://github.com/craftcms/cms/issues/4943))\n\n### Fixed\n- Fixed a bug where asset queries\u2019 `withTransforms` param wasn\u2019t working for eager-loaded assets. ([#4931](https://github.com/craftcms/cms/issues/4931))\n- Fixed a bug where the \u201cEdit Image\u201d asset action could be missing even if the user had the required permissions. ([#3349](https://github.com/craftcms/cms/issues/3349))\n- Fixed a bug where querying for elements by their Lightswitch field value could only return elements that had been saved since the Lightswitch field was added. ([#4939](https://github.com/craftcms/cms/issues/4939))\n- Fixed a bug where the Updates utility wasn\u2019t showing the \u201cUpdate all\u201d button when multiple updates were available. ([#4938](https://github.com/craftcms/cms/issues/4938))\n- Fixed a bug where the \u201cUpdating search indexes\u201d job could fail when updating search indexes for a Matrix block that contained a relational field.\n- Fixed a bug where category groups\u2019 site settings weren\u2019t being added to the project config when a new site was created.\n- Fixed a bug where the Translation Method setting wasn\u2019t immediately shown for Matrix sub-fields, if the field type was changed from one that didn\u2019t have multiple translation methods to one that does. ([#4949](https://github.com/craftcms/cms/issues/4949))\n- Fixed a bug where it wasn\u2019t possible to query for entries by author ID using the GraphQL API.\n- Fixed a bug where it wasn\u2019t possible to query for Matrix blocks directly using the GraphQL API.\n\n## 3.3.3 - 2019-09-12\n\n### Changed\n- The GraphQL API now prebuilds the schema for all introspection queries, regardless of whether Dev Mode is enabled.\n\n### Fixed\n- Fixed a bug where Craft was ignoring the `invalidUserTokenPath` request when it was set to an empty string. ([#1998](https://github.com/craftcms/cms/issues/1998))\n- Fixed a bug where the `invalidUserTokenPath` was affecting Control Panel requests.\n- Fixed a bug where revisions weren\u2019t being sorted correctly in Structure sections.\n- Fixed a bug where Edit Entry pages weren\u2019t working with certain versions of PHP if the user\u2019s preferred language was set to French. ([#4930](https://github.com/craftcms/cms/issues/4930))\n\n## 3.3.2 - 2019-09-11\n\n### Added\n- Added the `graphql/dump-schema` and `graphql/print-schema` commands. ([#4834](https://github.com/craftcms/cms/pull/4834))\n- It\u2019s now possible to access a `parent` field on entries and categories when querying the GraphQL API. ([#4880](https://github.com/craftcms/cms/issues/4880))\n- It\u2019s now possible to apply transforms to assets via `url` field arguments when querying the GraphQL API.\n\n### Changed\n- Craft now resets the `dateCreated` attribute when duplicating elements. ([#4906](https://github.com/craftcms/cms/issues/4906))\n- It\u2019s no longer possible to access the `author` field for entries when querying the GraphQL API, if the schema doesn\u2019t include user data.\n- It\u2019s no longer possible to access the `photo` field for users when querying the GraphQL API, if the schema doesn\u2019t include the user photo volume.\n\n### Fixed\n- Fixed a bug where Lightswitch fields weren\u2019t returning a boolean value for the GraphQL API.\n- Fixed a bug where `craft\\web\\View::renderString()` and `renderObjectTemplate()` could leave Craft set to the `site` template mode if an error occurred when preparing or rendering the template. ([#4912](https://github.com/craftcms/cms/issues/4912))\n- Fixed a bug where the Plugin Store wasn\u2019t applying edition upgrade pricing for plugins if the higher edition was already installed as a trial.\n\n## 3.3.1.2 - 2019-09-08\n\n### Fixed\n- Fixed an error that occurred after saving an element with a validation error. ([#4898](https://github.com/craftcms/cms/issues/4898))\n\n## 3.3.1.1 - 2019-09-06\n\n### Changed\n- `graphql/api` preflight responses now explicitly allow `Authorization` headers. ([#4830](https://github.com/craftcms/cms/issues/4830))\n- Updated Garnish to 0.1.30.\n\n### Fixed\n- Fixed a bug where selecting Matrix blocks would cause the content container to scroll. ([#3762](https://github.com/craftcms/cms/issues/3762))\n- Fixed an error that occurred if Stringy 5.2 was installed.\n\n## 3.3.1 - 2019-09-06\n\n### Added\n- Added support for setting `offset` and `limit` params to individual paths\u2019 criteria when eager-loading elements.\n- Added the `enableGql` config setting. ([#4836](https://github.com/craftcms/cms/issues/4836))\n- Added the `children` field to the `EntryInterface` and `CategoryInterface` GraphQL types. ([#4843](https://github.com/craftcms/cms/issues/4843))\n- Added the `markdown` GraphQL directive. ([#4832](https://github.com/craftcms/cms/issues/4832))\n\n### Changed\n- Preview target URIs can now be set to environment variables (e.g. `$NEWS_INDEX`) or URLs that begin with an alias (e.g. `@rootUrl/news` or `@rootUrl/news/{slug}`).\n- Templates passed to `craft\\web\\View::renderString()` and `renderObjectTemplate()` can now include front-end templates.\n- Element queries with the `revisions` param set will now return revisions ordered by `num DESC` by default. ([#4825](https://github.com/craftcms/cms/issues/4825))\n- `graphql/api` responses now set the `Access-Control-Allow-Headers: Content-Type` header for preflight requests.\n- Craft no longer forces preview target URLs to use `https` if the current request is over SSL. ([#4867](https://github.com/craftcms/cms/issues/4867))\n\n### Removed\n- Removed `craft\\elements\\MatrixBlock::getField()`. ([#4882](https://github.com/craftcms/cms/issues/4882))\n\n### Fixed\n- Fixed a bug where Number fields weren\u2019t showing validation errors when non-numeric values were entered. ([#4849](https://github.com/craftcms/cms/issues/4849))\n- Fixed an error that occurred when accessing the GraphQL section in the Control Panel if the `allowAdminChanges` config setting was disabled. ([#4884](https://github.com/craftcms/cms/issues/4884))\n- Fixed an error that could occur when executing a GraphQL query if a Matrix field had been converted to a different field type. ([#4848](https://github.com/craftcms/cms/issues/4848))\n- Fixed a deprecation warning when running tests in PhpStorm. ([#4772](https://github.com/craftcms/cms/pull/4772))\n- Fixed an SQL error that occurred when eager-loading children for an element that wasn\u2019t in a structure.\n- Fixed a bug that could cause queue jobs to fail when they were run automatically by Craft, if the `enableCsrfProtection` config setting was disabled. ([#4854](https://github.com/craftcms/cms/issues/4854))\n- Fixed an error that could occur if the `select` clause had been completely overridden on an element query, but the `asArray` param wasn\u2019t enabled. ([#4886](https://github.com/craftcms/cms/issues/4886))\n- Fixed a bug where Craft wasn\u2019t always respecting the site-specific status when saving new entries. ([#4892](https://github.com/craftcms/cms/issues/4892))\n\n## 3.3.0.1 - 2019-08-27\n\n### Changed\n- `graphql/api` responses now send CORS headers to allow crossdomain requests. ([#4830](https://github.com/craftcms/cms/issues/4830))\n\n### Fixed\n- Fixed a PHP error that could occur when editing an existing GraphQL schema. ([#4827](https://github.com/craftcms/cms/issues/4827))\n- Fixed a PHP error that could occur when using PostgreSQL. ([#4828](https://github.com/craftcms/cms/issues/4828))\n\n## 3.3.0 - 2019-08-27\n\n### Added\n- Added a built-in, autogenerated GraphQL API for content (Craft Pro only). ([#4540](https://github.com/craftcms/cms/pull/4540)) \n- Added \u201cHeadless Mode\u201d, which optimizes the system and Control Panel for headless CMS implementations.\n- It\u2019s now possible to create Single sections without URLs. ([#3883](https://github.com/craftcms/cms/issues/3883))\n- Added the `hiddenInput()` Twig function, which generates a hidden input tag.\n- Added the `input()` Twig function, which generates an input tag.\n- Added the `tag()` Twig function, which generates an HTML tag.\n- Added the `|attr` Twig filter, which modifies the attributes on an HTML tag. ([#4660](https://github.com/craftcms/cms/issues/4660))\n- Added the `|append` and `|prepend` Twig filters, which add new HTML elements as children of an HTML tag. ([#3937](https://github.com/craftcms/cms/issues/3937))\n- Added the `headlessMode` config setting.\n- Added the `purgeStaleUserSessionDuration` config setting.\n- Admin users can now opt into getting the full stack trace view when an uncaught exception occurs when Dev Mode isn\u2019t enabled. ([#4765](https://github.com/craftcms/cms/issues/4765))\n- Admin users can now opt into having Twig templates profiled when Dev Mode isn\u2019t enabled.\n- Added the `graphql/api` controller action.\n- Added `craft\\base\\ApplicationTrait::getGql()`.\n- Added `craft\\base\\EagerLoadingFieldInterface::getEagerLoadingGqlConditions()`.\n- Added `craft\\base\\ElementInterface::getGqlTypeName()`.\n- Added `craft\\base\\ElementInterface::gqlScopesByContext()`.\n- Added `craft\\base\\ElementInterface::gqlTypeNameByContext()`.\n- Added `craft\\base\\Field::getEagerLoadingGqlConditions()`.\n- Added `craft\\base\\FieldInterface::getContentGqlType()`.\n- Added `craft\\base\\GqlInlineFragmentFieldInterface`.\n- Added `craft\\base\\GqlInlineFragmentInterface`.\n- Added `craft\\controllers\\GraphqlController`.\n- Added `craft\\errors\\GqlException`.\n- Added `craft\\events\\RegisterGqlDirectivesEvent`.\n- Added `craft\\events\\RegisterGqlQueriesEvent`.\n- Added `craft\\events\\RegisterGqlTypesEvent`.\n- Added `craft\\gql\\arguments\\elements\\Asset`.\n- Added `craft\\gql\\arguments\\elements\\Category`.\n- Added `craft\\gql\\arguments\\elements\\Entry`.\n- Added `craft\\gql\\arguments\\elements\\GlobalSet`.\n- Added `craft\\gql\\arguments\\elements\\MatrixBlock`.\n- Added `craft\\gql\\arguments\\elements\\Tag`.\n- Added `craft\\gql\\arguments\\elements\\User`.\n- Added `craft\\gql\\base\\Arguments`.\n- Added `craft\\gql\\base\\Directive`.\n- Added `craft\\gql\\base\\ElementArguments`.\n- Added `craft\\gql\\base\\ElementResolver`.\n- Added `craft\\gql\\base\\GeneratorInterface`.\n- Added `craft\\gql\\base\\GqlTypeTrait`.\n- Added `craft\\gql\\base\\InterfaceType`.\n- Added `craft\\gql\\base\\ObjectType`.\n- Added `craft\\gql\\base\\Query`.\n- Added `craft\\gql\\base\\Resolver`.\n- Added `craft\\gql\\base\\StructureElementArguments`.\n- Added `craft\\gql\\directives\\FormatDateTime`.\n- Added `craft\\gql\\directives\\Transform`.\n- Added `craft\\gql\\GqlEntityRegistry`.\n- Added `craft\\gql\\interfaces\\Element`.\n- Added `craft\\gql\\interfaces\\elements\\Asset`.\n- Added `craft\\gql\\interfaces\\elements\\Category`.\n- Added `craft\\gql\\interfaces\\elements\\Entry`.\n- Added `craft\\gql\\interfaces\\elements\\GlobalSet`.\n- Added `craft\\gql\\interfaces\\elements\\MatrixBlock`.\n- Added `craft\\gql\\interfaces\\elements\\Tag`.\n- Added `craft\\gql\\interfaces\\elements\\User`.\n- Added `craft\\gql\\interfaces\\Structure`.\n- Added `craft\\gql\\queries\\Asset`.\n- Added `craft\\gql\\queries\\Category`.\n- Added `craft\\gql\\queries\\Entry`.\n- Added `craft\\gql\\queries\\GlobalSet`.\n- Added `craft\\gql\\queries\\Ping`.\n- Added `craft\\gql\\queries\\Tag`.\n- Added `craft\\gql\\queries\\User`.\n- Added `craft\\gql\\resolvers\\elements\\Asset`.\n- Added `craft\\gql\\resolvers\\elements\\Category`.\n- Added `craft\\gql\\resolvers\\elements\\Entry`.\n- Added `craft\\gql\\resolvers\\elements\\GlobalSet`.\n- Added `craft\\gql\\resolvers\\elements\\MatrixBlock`.\n- Added `craft\\gql\\resolvers\\elements\\Tag`.\n- Added `craft\\gql\\resolvers\\elements\\User`.\n- Added `craft\\gql\\TypeLoader`.\n- Added `craft\\gql\\types\\DateTime`.\n- Added `craft\\gql\\types\\elements\\Asset`.\n- Added `craft\\gql\\types\\elements\\Category`.\n- Added `craft\\gql\\types\\elements\\Element`.\n- Added `craft\\gql\\types\\elements\\Entry`.\n- Added `craft\\gql\\types\\elements\\GlobalSet`.\n- Added `craft\\gql\\types\\elements\\MatrixBlock`.\n- Added `craft\\gql\\types\\elements\\Tag`.\n- Added `craft\\gql\\types\\elements\\User`.\n- Added `craft\\gql\\types\\generators\\AssetType`.\n- Added `craft\\gql\\types\\generators\\CategoryType`.\n- Added `craft\\gql\\types\\generators\\ElementType`.\n- Added `craft\\gql\\types\\generators\\EntryType`.\n- Added `craft\\gql\\types\\generators\\GlobalSetType`.\n- Added `craft\\gql\\types\\generators\\MatrixBlockType`.\n- Added `craft\\gql\\types\\generators\\TableRowType`.\n- Added `craft\\gql\\types\\generators\\TagType`.\n- Added `craft\\gql\\types\\generators\\UserType`.\n- Added `craft\\gql\\types\\Query`.\n- Added `craft\\gql\\types\\TableRow`.\n- Added `craft\\helpers\\App::webResponseConfig()`.\n- Added `craft\\helpers\\ArrayHelper::whereMultiple()`.\n- Added `craft\\helpers\\ElementHelper::sourceElement()`.\n- Added `craft\\helpers\\Gql`.\n- Added `craft\\helpers\\Html::a()`.\n- Added `craft\\helpers\\Html::actionInput()`.\n- Added `craft\\helpers\\Html::appendToTag()`.\n- Added `craft\\helpers\\Html::csrfInput()`.\n- Added `craft\\helpers\\Html::modifyTagAttributes()`.\n- Added `craft\\helpers\\Html::normalizeTagAttributes()`.\n- Added `craft\\helpers\\Html::parseTag()`.\n- Added `craft\\helpers\\Html::parseTagAttributes()`.\n- Added `craft\\helpers\\Html::prependToTag()`.\n- Added `craft\\helpers\\Html::redirectInput()`.\n- Added `craft\\helpers\\StringHelper::afterFirst()`.\n- Added `craft\\helpers\\StringHelper::afterLast()`.\n- Added `craft\\helpers\\StringHelper::append()`.\n- Added `craft\\helpers\\StringHelper::appendRandomString()`.\n- Added `craft\\helpers\\StringHelper::appendUniqueIdentifier()`.\n- Added `craft\\helpers\\StringHelper::at()`.\n- Added `craft\\helpers\\StringHelper::beforeFirst()`.\n- Added `craft\\helpers\\StringHelper::beforeLast()`.\n- Added `craft\\helpers\\StringHelper::capitalizePersonalName()`.\n- Added `craft\\helpers\\StringHelper::count()`.\n- Added `craft\\helpers\\StringHelper::dasherize()`.\n- Added `craft\\helpers\\StringHelper::endsWithAny()`.\n- Added `craft\\helpers\\StringHelper::escape()`.\n- Added `craft\\helpers\\StringHelper::extractText()`.\n- Added `craft\\helpers\\StringHelper::htmlDecode()`.\n- Added `craft\\helpers\\StringHelper::htmlEncode()`.\n- Added `craft\\helpers\\StringHelper::humanize()`.\n- Added `craft\\helpers\\StringHelper::is()`.\n- Added `craft\\helpers\\StringHelper::isBase64()`.\n- Added `craft\\helpers\\StringHelper::isBlank()`.\n- Added `craft\\helpers\\StringHelper::isHexadecimal()`.\n- Added `craft\\helpers\\StringHelper::isHtml()`.\n- Added `craft\\helpers\\StringHelper::isJson()`.\n- Added `craft\\helpers\\StringHelper::isSerialized()`.\n- Added `craft\\helpers\\StringHelper::isUtf8()`.\n- Added `craft\\helpers\\StringHelper::isWhitespace()`.\n- Added `craft\\helpers\\StringHelper::lastSubstringOf()`.\n- Added `craft\\helpers\\StringHelper::lineWrapAfterWord()`.\n- Added `craft\\helpers\\StringHelper::pad()`.\n- Added `craft\\helpers\\StringHelper::padBoth()`.\n- Added `craft\\helpers\\StringHelper::padLeft()`.\n- Added `craft\\helpers\\StringHelper::padRight()`.\n- Added `craft\\helpers\\StringHelper::removeHtml()`.\n- Added `craft\\helpers\\StringHelper::removeHtmlBreak()`.\n- Added `craft\\helpers\\StringHelper::repeat()`.\n- Added `craft\\helpers\\StringHelper::replaceAll()`.\n- Added `craft\\helpers\\StringHelper::replaceBeginning()`.\n- Added `craft\\helpers\\StringHelper::replaceEnding()`.\n- Added `craft\\helpers\\StringHelper::replaceFirst()`.\n- Added `craft\\helpers\\StringHelper::replaceLast()`.\n- Added `craft\\helpers\\StringHelper::safeTruncate()`.\n- Added `craft\\helpers\\StringHelper::shortenAfterWord()`.\n- Added `craft\\helpers\\StringHelper::shuffle()`.\n- Added `craft\\helpers\\StringHelper::slice()`.\n- Added `craft\\helpers\\StringHelper::slugify()`.\n- Added `craft\\helpers\\StringHelper::split()`.\n- Added `craft\\helpers\\StringHelper::startsWithAny()`.\n- Added `craft\\helpers\\StringHelper::stripCssMediaQueries()`.\n- Added `craft\\helpers\\StringHelper::stripEmptyHtmlTags()`.\n- Added `craft\\helpers\\StringHelper::stripHtml()`.\n- Added `craft\\helpers\\StringHelper::stripWhitespace()`.\n- Added `craft\\helpers\\StringHelper::substringOf()`.\n- Added `craft\\helpers\\StringHelper::surround()`.\n- Added `craft\\helpers\\StringHelper::tidy()`.\n- Added `craft\\helpers\\StringHelper::titleizeForHumans()`.\n- Added `craft\\helpers\\StringHelper::toBoolean()`.\n- Added `craft\\helpers\\StringHelper::toSpaces()`.\n- Added `craft\\helpers\\StringHelper::toTabs()`.\n- Added `craft\\helpers\\StringHelper::toTransliterate()`.\n- Added `craft\\helpers\\StringHelper::trimLeft()`.\n- Added `craft\\helpers\\StringHelper::trimRight()`.\n- Added `craft\\helpers\\StringHelper::upperCamelize()`.\n- Added `craft\\helpers\\StringHelper::upperCaseFirst()`.\n- Added `craft\\helpers\\Template::beginProfile()`.\n- Added `craft\\helpers\\Template::endProfile()`.\n- Added `craft\\helpers\\UrlHelper::buildQuery()`.\n- Added `craft\\model\\MatrixBlockType::getField()`.\n- Added `craft\\models\\GqlSchema`.\n- Added `craft\\records\\GqlSchema`.\n- Added `craft\\services\\Fields::getGroupByUid()`.\n- Added `craft\\services\\Gql`.\n- Added `craft\\services\\Matrix::getAllBlockTypes()`.\n- Added `craft\\services\\Sections::getAllEntryTypes()`.\n- Added `craft\\web\\assets\\graphiql\\GraphiqlAsset`.\n- Added `craft\\web\\assets\\graphiql\\VendorAsset`.\n- Added `craft\\web\\twig\\nodes\\ProfileNode`.\n- Added `craft\\web\\twig\\nodevisitors\\Profiler`.\n\n### Changed\n- Relational fields without a specific target site will now only return related elements from the same site as the source element by default, as they did before Craft 3.2. ([#4751](https://github.com/craftcms/cms/issues/4751))\n- Element arrays no longer include `hasDescendants` or `totalDescendants` keys by default. ([#4820](https://github.com/craftcms/cms/issues/4820))\n- Matrix block queries no longer include blocks owned by drafts or revisions by default. ([#4790](https://github.com/craftcms/cms/issues/4790))\n- Entries\u2019 drafts and revisions are now soft-deleted and restored along with their source elements. ([#4797](https://github.com/craftcms/cms/issues/4797))\n- Global set reference tags can now refer to the global set by its handle. ([#4645](https://github.com/craftcms/cms/issues/4645))\n- Improved Twig template profiling to include blocks and macros.\n- Twig template profiling no longer occurs when Dev Mode isn\u2019t enabled, unless an admin user is logged in and has opted into it.\n- The `actionInput()`, `csrfInput()`, and `redirectInput()` Twig functions now support an `options` argument for customizing the HTML tag attributes.\n- The `_layouts/forms/field.html` template now supports `label`, `instructions`, `tip`, `warning`, and `input` blocks that can be overridden when including the template with an `{% embed %}` tag.\n- Editable tables now support a `fullWidth` setting, which can be set to `false` to prevent the table from spanning the full width of the page.\n- Editable tables now support `thin` column settings.\n- Editable tables now support `headingHtml` column settings.\n- Craft no longer overrides the base Twig template class, unless the now-deprecated `suppressTemplateErrors` config setting is enabled. ([#4755](https://github.com/craftcms/cms/issues/4755))\n- Edit Entry pages now get updated preview target URLs after saving a draft, in case the URLs have changed.\n- The confirmation dialog that can appear after running the Asset Indexes utility no longer will close by pressing the <kbd>Esc</kbd> key or clicking outside of the modal. ([#4795](https://github.com/craftcms/cms/issues/4795))\n- Section and Matrix \u201cPropagation Method\u201d settings now display warnings about the potential for data loss when appropriate.\n- Site group settings now display a warning about the potential for data loss.\n- Control Panel subnav items can now have badge counts. ([#4756](https://github.com/craftcms/cms/issues/4756))\n- Improved the performance of element duplication on multi-site installs.\n- Improved the performance of `craft\\web\\View::renderString()` for templates that don\u2019t contain any Twig code.\n- `craft\\behaviors\\DraftBehavior::getCreator()` can now return `null`.\n- `craft\\helpers\\Db::parseParam()` now has an optional `$columnType` argument. ([#4807](https://github.com/craftcms/cms/pull/4807))\n- `craft\\test\\TestSetup::setupCraftDb()` no longer accepts a second argument. Ensure that `craft\\test\\Craft::$testConfig` is set before calling this function. ([#4804](https://github.com/craftcms/cms/pull/4804))\n- `craft\\web\\Request::post()` and `getBodyParam()` will now work with posted JSON data, if the request\u2019s content type is set to `application/json`.\n- Switched from the `stringy/stringy` library to `voku/stringy`. ([#4753](https://github.com/craftcms/cms/issues/4753))\n\n### Deprecated\n- Deprecated the `suppressTemplateErrors` config setting.\n- Deprecated `craft\\services\\Sections::isSectionTemplateValid()`.\n- Deprecated `craft\\web\\twig\\Template`.\n\n### Removed\n- Removed `craft\\base\\ElementInterface::getSource()`. ([#4754](https://github.com/craftcms/cms/issues/4754))\n- Removed `craft\\web\\twig\\Extension::actionInputFunction()`.\n- Removed `craft\\web\\twig\\Extension::csrfInputFunction()`.\n- Removed `craft\\web\\twig\\Extension::redirectInputFunction()`.\n\n### Fixed\n- Fixed an error that could occur if garbage collection was run while Craft 3.2 migrations were pending. ([#4720](https://github.com/craftcms/cms/issues/4720))\n- Fixed a validation error that occurred when duplicating an entry, if the URI format was based on a custom field value. ([#4759](https://github.com/craftcms/cms/issues/4759))\n- Fixed a bug where the \u201cPublish live changes for other authors\u2019 entries\u201d permission was being enforced when saving another author\u2019s entry as a new entry. ([#4758](https://github.com/craftcms/cms/issues/4758))\n- Fixed a bug where `craft\\helpers\\UrlHelper` methods would strip out array params in the query string. ([#4778](https://github.com/craftcms/cms/issues/4778))\n- Fixed a SQL error that occurred when a `{% cache %}` tag was used on a page with a 4-byte character in the URI. ([#4780](https://github.com/craftcms/cms/issues/4780))\n- Fixed a bug where Craft could show a nondescript error when navigating away from a Control Panel page if an Ajax request was currently in progress. ([#4796](https://github.com/craftcms/cms/issues/4796))\n- Fixed an error that occurred when editing an entry with a draft that was created by a soft-deleted user. ([#4800](https://github.com/craftcms/cms/issues/4800))\n- Fixed a bug where entry revisions and drafts would be deleted when the user that created them was hard-deleted.\n- Fixed a SQL error that could occur when executing an element query that had custom `JOIN` and `WHERE` clauses if the `search` param was also set. ([#4788](https://github.com/craftcms/cms/issues/4788))\n- Fixed a bug where default field values weren\u2019t being applied to Matrix blocks that were autocreated per the Min Blocks setting. ([#4806](https://github.com/craftcms/cms/issues/4806))\n- Fixed Plugin Store dropdowns which were not working properly with Windows Edge browsers.\n- Fixed a SQL error that could occur when `:empty:` or `not :empty:` was passed to a date param on an element query when running MySQL 8. ([#4808](https://github.com/craftcms/cms/issues/4808))\n- Fixed a bug where Dropdown and Multi-select fields\u2019 Dropdown Options settings weren\u2019t autofocussing on the first input when adding a new row with the keyboard. ([#4823](https://github.com/craftcms/cms/issues/4823))\n\n## 3.2.10 - 2019-08-13\n\n### Added\n- Added `craft\\fields\\BaseRelationField::settingsTemplateVariables()`. ([#4732](https://github.com/craftcms/cms/issues/4732))\n- Added `craft\\services\\Search::deleteOrphanedIndexes()`.\n- Added `craft\\validators\\UriFormatValidator::$disallowTriggers`.\n- Added the `Craft.startsWith()` JavaScript method.\n\n### Changed\n- Improved garbage collection performance when hard-deleting hundreds of thousands of elements. ([#4735](https://github.com/craftcms/cms/issues/4735))\n- Element queries\u2019 `title` param will now accept a value of `'0'`.\n- `craft\\services\\Elements::deleteElementById()` now has a `$hardDelete` argument. ([#4747](https://github.com/craftcms/cms/pull/4747))\n- It\u2019s no longer possible to save routes or URI formats that begin with the `actionTrigger` or `cpTrigger` config settings. ([#4154](https://github.com/craftcms/cms/issues/4154))\n- Categories fields\u2019 selection modals now show the site menu. ([#4749](https://github.com/craftcms/cms/issues/4749))\n\n### Removed\n- Removed `craft\\records\\Route`.\n\n### Fixed\n- Fixed a bug where Entry fixtures wouldn\u2019t get unloaded. ([#4663](https://github.com/craftcms/cms/issues/4663))\n- Fixed a bug where entry content wouldn\u2019t get propagated to other sites if an entry was created and then saved before Craft had finished autosaving the draft. ([#4423](https://github.com/craftcms/cms/issues/4423))\n- Fixed a bug where entry forms could miss the fact that a Matrix block had been deleted. ([#4727](https://github.com/craftcms/cms/issues/4727))\n- Fixed a PHP error that could occur on environments where the Intl PHP extension was installed but the `IDNA_NONTRANSITIONAL_TO_ASCII` or `INTL_IDNA_VARIANT_UTS46` constants weren\u2019t defined. ([#4722](https://github.com/craftcms/cms/issues/4722))\n- Fixed a PHP error that could occur if a plugin was configured with settings even though it didn\u2019t support settings. ([#4706](https://github.com/craftcms/cms/issues/4706))\n- Fixed an error that occurred when a validation error occurred on an entry while it was being created or updated from a draft. ([#4733](https://github.com/craftcms/cms/issues/4733))\n- Fixed an infinite recursion bug that could occur when validating circular relations. ([#4482](https://github.com/craftcms/cms/issues/4482))\n- Fixed a bug where elements with a title of \u201c0\u201d would show their ID instead of their title in element indexes and relational fields. ([#4745](https://github.com/craftcms/cms/issues/4745))\n- Fixed a bug where Craft was redirecting to the Dashboard when attempting to export elements, if the `tokenParam` config setting was set to something besides `token`. ([#4737](https://github.com/craftcms/cms/issues/4737))\n\n## 3.2.9 - 2019-08-06\n\n### Added\n- Added the `ignorePlaceholders` element query param.\n- Added the `cp.entries.edit.meta` and `cp.entries.edit.settings` template hooks to the Edit Entry page.\n- Added `craft\\base\\ElementInterface::getSource()`.\n- Added `craft\\base\\ElementTrait::$newSiteIds`.\n- Added `craft\\models\\Site::$dateCreated` and `$dateUpdated`. ([#4703](https://github.com/craftcms/cms/issues/4703))\n\n### Changed\n- Improved the Control Panel header styling for mobile and on pages with long titles. ([#4548](https://github.com/craftcms/cms/issues/4548))\n- Element references in the Control Panel now reveal the site the element was fetched from in their tooltips, on multi-site installs. ([#4690](https://github.com/craftcms/cms/issues/4690))\n- Element editor HUDs now always show a header with the element\u2019s site name on multi-site installs, even if the element is only editable in one site. ([#4690](https://github.com/craftcms/cms/issues/4690))\n- Entry preview tokens now respect the `defaultTokenDuration` config setting, rather than always expiring after 24 hours. ([#4683](https://github.com/craftcms/cms/pull/4683))\n- Improved disabled select field styling. ([#4709](https://github.com/craftcms/cms/pull/4709))\n\n### Deprecated\n- Deprecated `craft\\behaviors\\DraftBehavior::getSource()`.\n- Deprecated `craft\\behaviors\\RevisionBehavior::getSource()`.\n\n### Fixed\n- Fixed a bug where elements listed in a Structure view could be missing their descendant toggles even if all of their descendants were disabled. ([#4685](https://github.com/craftcms/cms/issues/4685))\n- Fixed a bug where element CSV exports were limited to 50 elements if no limit was set. ([#4692](https://github.com/craftcms/cms/issues/4692))\n- Fixed a 400 error that occurred when submitting an entry form that didn\u2019t have an `entryId` param. ([#4693](https://github.com/craftcms/cms/issues/4693))\n- Fixed a bug where `craft\\base\\Element::getDescendants()` and other structure methods could return the wrong results when called on a draft. ([#4694](https://github.com/craftcms/cms/issues/4694))\n- Fixed a bug where Matrix blocks weren\u2019t getting duplicated to newly-enabled sites for elements if the field\u2019s Propagation Method setting wasn\u2019t set to \u201cSave blocks to all sites the owner element is saved in\u201d. ([#4698](https://github.com/craftcms/cms/issues/4698))\n- Fixed a bug where the Database Backup could result in a 404 error on load-balanced environments. ([#4699](https://github.com/craftcms/cms/issues/4699))\n- Fixed a bug where the \u201cCurrent\u201d entry revision link wouldn\u2019t always work. ([#4705](https://github.com/craftcms/cms/issues/4705))\n- Fixed a bug where the `craft\\services\\Search::EVENT_AFTER_SEARCH` event wasn\u2019t always firing. ([#4710](https://github.com/craftcms/cms/issues/4710))\n- Fixed a bug where `craft\\services\\Users::purgeExpiredPendingUsers()` was attempting to delete already-trashed users.\n\n### Security\n- Fixed an XSS vulnerability.\n\n## 3.2.8 - 2019-07-30\n\n### Added\n- Element indexes with unsaved drafts now show a \u201cDrafts\u201d option in the status menu.\n- Added the `utils/fix-element-uids` command, which ensures all elements have unique UIDs. ([#4653](https://github.com/craftcms/cms/issues/4653))\n\n### Fixed\n- Fixed a bug where it wasn\u2019t possible to create a homepage Single section if a prior entry revisions\u2019 URI had been set to `__home__`. ([#4657](https://github.com/craftcms/cms/issues/4657))\n- Fixed a bug where the user deletion confirmation dialog was including revisions and drafts when counting entries for the content summary.\n- Fixed an error that occurred when deleting a user, if another user had been chosen to inherit their content. ([#4670](https://github.com/craftcms/cms/issues/4670))\n- Fixed a bug where users could be warned about losing unsaved changes when updating an entry from a draft, while the draft was being autosaved. ([#4614](https://github.com/craftcms/cms/issues/4614))\n- Fixed a bug where Categories fields weren\u2019t always getting updated when a category they were related to got moved under another category. ([#4672](https://github.com/craftcms/cms/issues/4672))\n- Fixed an error that occurred on the Settings \u2192 Routes page, if one of the routes didn\u2019t have a URI pattern. ([#4676](https://github.com/craftcms/cms/issues/4676))\n- Fixed some styling and behavior issues on the Settings \u2192 Routes page.\n\n## 3.2.7 - 2019-07-25\n\n### Fixed\n- Fixed an error where it wasn\u2019t possible to scale SVGs using only height. ([#4643](https://github.com/craftcms/cms/pull/4643))\n- Fixed a bug where the content area of some Control Panel pages weren\u2019t getting any bottom padding. ([#4644](https://github.com/craftcms/cms/issues/4644))\n- Fixed a bug where installing a plugin immediately after installing Craft from the console could corrupt the project config if `useProjectConfigFile` was enabled. ([#3870](https://github.com/craftcms/cms/issues/3870))\n- Fixed a bug where entry forms could overlook changes made to Categories fields. ([#4648](https://github.com/craftcms/cms/issues/4648))\n- Fixed a bug where element search indexes weren\u2019t being updated right away after an element was created or updated from an element editor HUD.\n- Fixed a bug where back-end slug validation wasn\u2019t working correctly for slugs with some Unicode characters. ([#1535](https://github.com/craftcms/cms/issues/1535))\n- Fixed a bug where Craft was attempting to delete template caches even when saving a draft or revision.\n\n## 3.2.6 - 2019-07-23\n\n### Changed\n- When enabling a new site for a Single section, Craft now uses the primary site\u2019s content as the starting point for the new site\u2019s content, if the section was already enabled for it.\n- Swapped the position of the \u201cSave as a Draft\u201d and \u201cSave Entry\u201d buttons. ([#4622](https://github.com/craftcms/cms/issues/4622))\n- `craft\\helpers\\DateTimeHelper::toDateTime()` now supports arrays created from `DateTime` objects. ([#4627](https://github.com/craftcms/cms/issues/4627))\n- Plugin license key inputs are no longer limited to 29 characters, to make room for long environment variable names. ([#4393](https://github.com/craftcms/cms/issues/4393))\n- Updated Imagine to 1.2.2.1.\n\n### Fixed\n- Fixed a bug where Craft could load the same JavaScript and CSS files multiple times when opening element editor HUDs. ([#4620](https://github.com/craftcms/cms/issues/4620))\n- Fixed a bug where each animated GIF frame would still be parsed when generating a thumbnail, even if the `transformGifs` setting was set to `false`. ([#4588](https://github.com/craftcms/cms/issues/4588))\n- Fixed a bug where back-end slug validation wasn\u2019t working correctly for slugs with Unicode characters. ([#4628](https://github.com/craftcms/cms/issues/4628))\n- Fixed a bug where it wasn\u2019t possible to create new entries if the section handle matched the `pageTrigger` config setting, and the `pageTrigger` config setting had a trailing slash. ([#4631](https://github.com/craftcms/cms/issues/4631))\n- Fixed a bug where the `sections.previewTargets` database column was getting created as a `varchar` instead of `text` column for new Craft installs. ([#4638](https://github.com/craftcms/cms/issues/4638))\n\n### Security\n- Fixed a bug where the `preserveExifData` config setting wasn\u2019t being respected on image upload.\n\n## 3.2.5.1 - 2019-07-19\n\n### Fixed\n- Fixed an error that occurred if a plugin license key was set to an environment variable, which was set to an invalid key. ([#4604](https://github.com/craftcms/cms/issues/4604))\n- Fixed an error that prevented image thumbnails from generating in the Control Panel when using ImageMagick. ([#4609](https://github.com/craftcms/cms/issues/4609))\n\n## 3.2.5 - 2019-07-19\n\n### Added\n- Added `craft\\services\\Elements::getPlaceholderElements()`.\n\n### Changed\n- If an invalid entry draft or revision edit URL is accessed, but the source entry does exist, Craft now redirects the browser to the source entry\u2019s edit page. ([#4574](https://github.com/craftcms/cms/issues/4574))\n- Preview requests now include the previewed entry in element queries even if the `status`, `drafts`, or `revisions` parameters are set to exclude it. ([#4581](https://github.com/craftcms/cms/issues/4581))\n- Back-end slug generation now follows the same rules as JavaScript. ([#4607](https://github.com/craftcms/cms/issues/4607))\n- Unsaved entry drafts now get assigned a new ID when they are fully saved, so they are treated as new elements. ([#4589](https://github.com/craftcms/cms/issues/4589))\n\n### Fixed\n- Fixed some bugs with the \u201cSave Entry\u201d menu options, when editing an unsaved draft. ([#4614](https://github.com/craftcms/cms/issues/4614))\n- Fixed a bug where Craft could forget which site was being edited when updating an entry from a draft. ([#4615](https://github.com/craftcms/cms/issues/4615))\n\n## 3.2.4.1 - 2019-07-17\n\n### Fixed\n- Fixed an error that occurred when attempting to share a disabled entry. ([#4596](https://github.com/craftcms/cms/issues/4596))\n- Fixed a bug where new Email and URL cells in Table fields weren\u2019t getting the correct input type. ([#4595](https://github.com/craftcms/cms/issues/4595))\n\n## 3.2.4 - 2019-07-17\n\n### Changed\n- Brought back the \u201cPreview\u201d button for the Current revision of entries, which now creates a draft before activating the entry preview. ([#4584](https://github.com/craftcms/cms/issues/4584))\n- The \u201cSave as a Draft\u201d button now creates the draft over Ajax, when it\u2019s not the primary submit button for the page.\n- When Craft isn\u2019t able to sync incoming `project.yaml` changes due to schema version conflicts, Craft now lists which packages are conflicting.. ([#4568](https://github.com/craftcms/cms/issues/4568))\n\n### Fixed\n- Fixed a JavaScript error that could occur after uploading a file directly onto an Assets field when editing the Current revision of an entry.\n- Fixed a bug where draft forms could become unresponsive if the user attempted to navigate away from the page or submit the form in the middle of an autosave. ([#4578](https://github.com/craftcms/cms/issues/4578))\n- Fixed a SQL error that could occur when passing `:empty:` or `:notempty:` to a relational field\u2019s element query param. ([#4529](https://github.com/craftcms/cms/issues/4529))\n- Fixed a bug where Number fields weren\u2019t getting set to their default values for new entries. ([#4586](https://github.com/craftcms/cms/issues/4586))\n- Fixed a bug query string parameters were getting URL-encoded when applied to generated pagination URLs.\n- Fixed a bug where Single entries had the option to be duplicated or deleted. ([#4590](https://github.com/craftcms/cms/issues/4590))\n\n## 3.2.3 - 2019-07-16\n\n### Added\n- Added `craft\\controllers\\EntriesController::actionDuplicateEntry()`.\n- Added `craft\\web\\UrlManager::setMatchedElement()`.\n\n### Changed\n- Craft no longer creates drafts automatically when editing entries. The user must click a \u201cSave as a Draft\u201d button to create one. ([#4549](https://github.com/craftcms/cms/issues/4549))\n- Entries are now immediately savable, whether or not any changes were made. ([#4535](https://github.com/craftcms/cms/issues/4535))\n- The \u201cSave Entry\u201d button now redirects the user to the Entries index page. ([#4575](https://github.com/craftcms/cms/issues/4575))\n- Brought back the \u201cSave and continue editing\u201d and \u201cSave and add another\u201d options for entries.\n- It\u2019s no longer possible to preview entries\u2019 Current revision. A draft must be created first.\n\n### Fixed\n- Fixed a bug where it wasn\u2019t possible to delete Matrix blocks if Min Blocks and Max Blocks were set to the same value, and an element already had more than that many blocks. ([#4562](https://github.com/craftcms/cms/issues/4562))\n- Fixed a bug where `craft\\web\\UrlManager::getMatchedElement()` could return the incorrect result on preview requests. ([#4542](https://github.com/craftcms/cms/issues/4542))\n- Fixed an error that occurred on the Settings \u2192 Email page if email settings were missing from the project config. ([#4552](https://github.com/craftcms/cms/issues/4552))\n- Fixed a bug where it wasn\u2019t possible to toggle site-specific entry statuses when editing drafts. ([#4577](https://github.com/craftcms/cms/issues/4577))\n\n## 3.2.2 - 2019-07-14\n\n### Added\n- Added `craft\\helpers\\ElementHelper::isTempSlug()`.\n- Added `craft\\helpers\\ElementHelper::tempSlug()`.\n- Added `craft\\helpers\\UrlHelper::removeParam()`.\n\n### Changed\n- Craft no longer ensures a recent revision exists before creating a draft for an element.\n- Element exports are limited to CSV files now, to avoid the GD requirement imposed by the PHPSpreadsheet library. ([#4553](https://github.com/craftcms/cms/issues/4553))\n\n### Fixed\n- Fixed a bug where multi-site element queries with the `unique` and `offset` params set weren\u2019t returning any results. ([#4560](https://github.com/craftcms/cms/issues/4560))\n- Fixed an error that could occur when creating a draft. ([#4515](https://github.com/craftcms/cms/issues/4515))\n- Fixed a bug where Craft wasn\u2019t generating a new slug for entries that were saved with a blank Slug field. ([#4518](https://github.com/craftcms/cms/issues/4518))\n- Fixed a bug where disabled select options could lose their disabled text styling in Firefox. ([#4526](https://github.com/craftcms/cms/issues/4526))\n- Fixed a bug where entry forms could miss the fact that a file had been uploaded to an Assets field. ([#4534](https://github.com/craftcms/cms/issues/4534))\n- Fixed a bug where selecting \u201cCreate a new child entry\u201d in a Structure section on a multi-site install would result in a 404 error. ([#4541](https://github.com/craftcms/cms/issues/4541))\n- Fixed a bug where it wasn\u2019t possible to set test-specific config settings. ([#4539](https://github.com/craftcms/cms/pull/4539))\n- Fixed an error that occurred when exporting elements if Limit was set to `0`. ([#4547](https://github.com/craftcms/cms/issues/4547))\n- Fixed a bug where the `{% paginate %}` tag wouldn\u2019t generate links to the first page correctly when using query string pagination. ([#4550](https://github.com/craftcms/cms/issues/4550))\n- Fixed an error that occurred when indexing assets from a console request, if no volumes were defined yet. ([#2798](https://github.com/craftcms/cms/issues/2798))\n- Fixed a bug where the \u201cDelete\u201d link could show up in the draft meta HUD for unsaved drafts. ([#4557](https://github.com/craftcms/cms/issues/4557))\n\n## 3.2.1 - 2019-07-11\n\n### Added\n- Added `craft\\console\\Request::getIsPreview()`.\n- Added `craft\\web\\Request::getIsPreview()`.\n\n### Changed\n- If a draft can\u2019t be saved, an alert icon is now shown in the Control Panel header, which can be clicked on to reveal more information.\n- Element revisions no longer store snapshot data.\n\n### Fixed\n- Fixed a bug where Feed widget items weren\u2019t getting hyperlinked.\n- Fixed a bug where the `app/migrate` controller wasn\u2019t applying new `project.yaml` changes if there were no pending migrations.\n- Fixed a SQL error that could occur when saving an entry or entry draft. ([#4508](https://github.com/craftcms/cms/issues/4508))\n- Fixed a bug where Assets fields set to restrict uploads to a single folder could have empty selector modals. ([#4522](https://github.com/craftcms/cms/issues/4522))\n- Fixed an error that could occur if a template was accessing the deprecated `locale` property of an element query, but `siteId` wasn\u2019t set to an integer. ([#4531](https://github.com/craftcms/cms/issues/4531))\n- Fixed a bug where users without the \u201cPublish live changes\u201d permission for a section weren\u2019t able to create new entries. ([#4528](https://github.com/craftcms/cms/issues/4529))\n- Fixed a PHP error that could occur when uploading files to Assets fields on the front-end. ([#4382](https://github.com/craftcms/cms/issues/4382))\n- Fixed a bug where elements listed in a Structure view could show descendant toggles even if they had no descendants. ([#4504](https://github.com/craftcms/cms/issues/4504))\n- Fixed a backwards compatibility issue. ([#4523](https://github.com/craftcms/cms/issues/4523))\n\n## 3.2.0 - 2019-07-09\n\n> {warning} If you\u2019ve ever run the `project-config/rebuild` command, it\u2019s highly recommended that you run it again with Craft 3.1.34.2, before updating to Craft 3.2.\n\n> {warning} Custom login controllers must now explicitly set their `$allowAnonymous` values to include `self::ALLOW_ANONYMOUS_OFFLINE` if they wish to be available when the system is offline.\n\n> {tip} If you have Super Table or Neo installed, you should update those **at the same time** as Craft, to avoid unnecessary search index jobs from being added to the queue.\n\n### Added\n- All element types now have the option to support drafts and revisions.\n- Drafts are now autocreated when content is modified, and autosaved whenever the content changes. ([#1034](https://github.com/craftcms/cms/issues/1034))\n- Drafts and revisions now store content across all sites supported by the element. ([#2669](https://github.com/craftcms/cms/issues/2669))\n- Content previewing is now draft-based, and drafts are stored as specialized elements, so it\u2019s no longer necessary to add special cases in templates for preview requests. ([#1787](https://github.com/craftcms/cms/issues/1787), [#2801](https://github.com/craftcms/cms/issues/2801))\n- Sections now have a \u201cPreview Targets\u201d setting when running Craft Pro, which can be used to configure additional locations that entries can be previewed from. ([#1489](https://github.com/craftcms/cms/issues/1489))\n- Sections now have a \u201cPropagation Method\u201d setting, enabling entries to only be propagated to other sites in the same site group, or with the same language. ([#3554](https://github.com/craftcms/cms/issues/3554))\n- Matrix fields now have a \u201cPropagation Method\u201d setting, enabling blocks to only be propagated to other sites in the same site group, or with the same language. ([#3554](https://github.com/craftcms/cms/issues/3554))\n- Single entries now have editable slugs. ([#3368](https://github.com/craftcms/cms/issues/3368))\n- Headless content previewing is now possible by forwarding request tokens off to content API requests. ([#1231](https://github.com/craftcms/cms/issues/1231))\n- Preview iframes are now created with a `src` attribute already in place, improving SPA support. ([#2120](https://github.com/craftcms/cms/issues/2120))\n- Entry \u201cShare\u201d buttons are now visible on mobile. ([#4408](https://github.com/craftcms/cms/issues/4408))\n- Added the \u201cTemp Uploads Location\u201d system setting (available from Settings \u2192 Assets \u2192 Settings), which makes it possible to choose the volume and path that temporary asset uploads should be stored. ([#4010](https://github.com/craftcms/cms/issues/4010))\n- Added the `maxRevisions` config setting. ([#926](https://github.com/craftcms/cms/issues/926))\n- Added the `purgeUnsavedDraftsDuration` config setting, which determines how long unsaved drafts should be allowed to exist before getting deleted via garbage collection.\n- Added the \u201cEdit images\u201d permission. ([#3349](https://github.com/craftcms/cms/issues/3349))\n- Added the \u201cImpersonate users\u201d permission. ([#3501](https://github.com/craftcms/cms/issues/3501))\n- Added the `drafts`, `draftId`, `draftOf`, `draftCreator`, `revisions`, `revisionId`, `revisionOf`, and `revisionCreator` element query params.\n- The `site` element query params now support passing multiple site handles, or `'*'`, to query elements across multiple sites at once. ([#2854](https://github.com/craftcms/cms/issues/2854))\n- Relational fields now have a \u201cValidate related elements\u201d setting, which ensures that the related elements pass validation before the source element can be saved with them selected. ([#4095](https://github.com/craftcms/cms/issues/4095))\n- Table fields can now have Dropdown, Email, and URL columns. ([#811](https://github.com/craftcms/cms/issues/811), [#4180](https://github.com/craftcms/cms/pull/4180))\n- Dropdown and Multi-select fields can now have optgroups. ([#4236](https://github.com/craftcms/cms/issues/4236))\n- Date/Time, Dropdown, Lightswitch, Number, and Radio Buttons fields are now listed as sort options in element indexes. ([#2818](https://github.com/craftcms/cms/issues/2818))\n- Asset, category, entry, and user indexes can now have \u201cUID\u201d columns. ([#4433](https://github.com/craftcms/cms/issues/4433))\n- Added the `unique` element query param, which can be used to prevent duplicate elements when querying elements across multiple sites.\n- Added the `preferSites` element query param, which can be used to set the preferred sites that should be used for multi-site element queries, when the `unique` param is also enabled.\n- Element index pages are now paginated for non-Structure views. ([#818](https://github.com/craftcms/cms/issues/818))\n- Element index pages now have an \u201cExport\u2026\u201d button that will export all of the elements in the current view (across all pages) or up to a custom limit, in either CSV, XLS, XLSX, or ODS format. ([#994](https://github.com/craftcms/cms/issues/994))\n- Added the `{% dd %}` Twig tag. ([#4399](https://github.com/craftcms/cms/issues/4399))\n- Added the `attr()` Twig function, which can generate a list of HTML/XML attributes. ([#4237](https://github.com/craftcms/cms/pull/4237))\n- Added the `|withoutKey` Twig filter.\n- Added the `resave/matrix-blocks` console command.\n- The `index-assets/*` commands now support a `--create-missing-assets=0` option, which prevents Craft from creating asset records when they don\u2019t exist yet, and offers an opportunity to fix the location of any asset records that are missing their associated files, when the filename matches one of the files missing an index.\n- Added the `mailer/test` command. ([#4020](https://github.com/craftcms/cms/issues/4020))\n- Added the `tests/setup` command, which generates a test suite for the current Craft project.\n- Jobs can now set progress labels, which will be shown below their description and progress bar in the queue HUD. ([#1931](https://github.com/craftcms/cms/pull/1931))\n- Added the `_layouts/element` template, which can be extended by element edit pages that wish to support drafts, revisions, and content previewing.\n- Added the `_special/sitepicker` template.\n- It\u2019s now possible for plugins and modules to define custom actions on console controllers.\n- Added a testing framework for Craft and plugins, powered by Codeception. ([#3382](https://github.com/craftcms/cms/pull/3382), [#1485](https://github.com/craftcms/cms/issues/1485), [#944](https://github.com/craftcms/cms/issues/944))\n- Added `craft\\base\\ApplicationTrait::getInstalledSchemaVersion()`.\n- Added `craft\\base\\BlockElementInterface`.\n- Added `craft\\base\\Element::EVENT_AFTER_PROPAGATE`.\n- Added `craft\\base\\Element::EVENT_REGISTER_PREVIEW_TARGETS`.\n- Added `craft\\base\\Element::previewTargets()`.\n- Added `craft\\base\\ElementInterface::afterPropagate()`.\n- Added `craft\\base\\ElementInterface::getCurrentRevision()`.\n- Added `craft\\base\\ElementInterface::getIsDraft()`.\n- Added `craft\\base\\ElementInterface::getIsRevision()`.\n- Added `craft\\base\\ElementInterface::getIsUnsavedDraft()`.\n- Added `craft\\base\\ElementInterface::getPreviewTargets()`.\n- Added `craft\\base\\ElementInterface::getSourceId()`.\n- Added `craft\\base\\ElementInterface::getSourceUid()`.\n- Added `craft\\base\\ElementInterface::getUiLabel()`, which is now used to define what an element will be called in the Control Panel. ([#4211](https://github.com/craftcms/cms/pull/4211))\n- Added `craft\\base\\ElementInterface::pluralDisplayName()`, which element type classes can use to define the plural of their display name.\n- Added `craft\\base\\ElementInterface::setRevisionCreatorId()`.\n- Added `craft\\base\\ElementInterface::setRevisionNotes()`.\n- Added `craft\\base\\ElementTrait::$dateDeleted`. ([#4493](https://github.com/craftcms/cms/issues/4493))\n- Added `craft\\base\\ElementTrait::$draftId`.\n- Added `craft\\base\\ElementTrait::$hardDelete`.\n- Added `craft\\base\\ElementTrait::$previewing`.\n- Added `craft\\base\\ElementTrait::$propagateAll`.\n- Added `craft\\base\\ElementTrait::$revisionId`.\n- Added `craft\\base\\Field::EVENT_AFTER_ELEMENT_PROPAGATE`.\n- Added `craft\\base\\Field::getSortOption()`.\n- Added `craft\\base\\FieldInterface::afterElementPropagate()`.\n- Added `craft\\base\\FieldInterface::valueType()`. ([#3894](https://github.com/craftcms/cms/issues/3894))\n- Added `craft\\base\\SortableFieldInterface`, which can be implemented by field classes that should be sortable in element indexes.\n- Added `craft\\behaviors\\DraftBehavior`.\n- Added `craft\\behaviors\\RevisionBehavior`.\n- Added `craft\\console\\CallableAction`.\n- Added `craft\\console\\Controller`.\n- Added `craft\\console\\controllers\\ResaveController::saveElements()`.\n- Added `craft\\console\\ControllerTrait`.\n- Added `craft\\console\\Request::getToken()`.\n- Added `craft\\controllers\\PreviewController`.\n- Added `craft\\errors\\MissingAssetException`.\n- Added `craft\\events\\BatchElementActionEvent`.\n- Added `craft\\events\\DefineConsoleActionsEvent`.\n- Added `craft\\events\\ElementQueryEvent`.\n- Added `craft\\events\\RegisterPreviewTargetsEvent`.\n- Added `craft\\events\\RevisionEvent`.\n- Added `craft\\helpers\\Component::validateComponentClass()`.\n- Added `craft\\helpers\\ElementHelper::isDraftOrRevision()`.\n- Added `craft\\helpers\\ElementHelper::rootElement()`.\n- Added `craft\\models\\Section::$propagationMethod`.\n- Added `craft\\queue\\jobs\\UpdateSearchIndex`.\n- Added `craft\\services\\Drafts`, accessible via `Craft::$app->drafts`.\n- Added `craft\\services\\Elements::propagateElements()` along with `EVENT_BEFORE_PROPAGATE_ELEMENTS`, `EVENT_AFTER_PROPAGATE_ELEMENTS`, `EVENT_BEFORE_PROPAGATE_ELEMENT`, and `EVENT_AFTER_PROPAGATE_ELEMENT` events. ([#4139](https://github.com/craftcms/cms/issues/4139))\n- Added `craft\\services\\Elements::resaveElements()` along with `EVENT_BEFORE_RESAVE_ELEMENTS`, `EVENT_AFTER_RESAVE_ELEMENTS`, `EVENT_BEFORE_RESAVE_ELEMENT`, and `EVENT_AFTER_RESAVE_ELEMENT` events. ([#3482](https://github.com/craftcms/cms/issues/3482))\n- Added `craft\\services\\Matrix::duplicateBlocks()`.\n- Added `craft\\services\\Matrix::getSupportedSiteIdsForField()`.\n- Added `craft\\services\\Revisions`, accessible via `Craft::$app->revisions`.\n- Added `craft\\services\\Users::canImpersonate()`.\n- Added `craft\\web\\Request::getIsLoginRequest()` and `craft\\console\\Request::getIsLoginRequest()`.\n- Added `craft\\web\\UrlManager::$checkToken`.\n- Added the `Craft.isSameHost()` JavaScript method.\n- Added the `Craft.parseUrl()` JavaScript method.\n- Added the `Craft.randomString()` JavaScript method.\n- Added the `Craft.DraftEditor` JavaScript class.\n- Added the `Craft.Preview` JavaScript class.\n\n### Changed\n- Relational fields are now capable of selecting elements from multiple sites, if they haven\u2019t been locked down to only related elements from a single site. ([#3584](https://github.com/craftcms/cms/issues/3584))\n- Element selector modals now always show source headings, and list sources in the configured order. ([#4494](https://github.com/craftcms/cms/issues/4494))\n- Reference tags can now specify the site to load the element from. ([#2956](https://github.com/craftcms/cms/issues/2956))\n- Improved the button layout of Edit Entry pages. ([#2325](https://github.com/craftcms/cms/issues/2325))\n- Improved the performance of saving elements.\n- The Control Panel now shows the sidebar on screens that are at least 1,000 pixels wide. ([#4079](https://github.com/craftcms/cms/issues/4079))\n- The `_layouts/cp` template now supports a `showHeader` variable that can be set to `false` to remove the header.\n- The `_layouts/cp` Control Panel template now supports a `footer` block, which will be output below the main content area.\n- Renamed `craft\\helpers\\ArrayHelper::filterByValue()` to `where()`.\n- Anonymous/offline/Control Panel access validation now takes place from `craft\\web\\Controller::beforeAction()` rather than `craft\\web\\Application::handleRequest()`, giving controllers a chance to do things like set CORS headers before a `ForbiddenHttpException` or `ServiceUnavailableHttpException` is thrown. ([#4008](https://github.com/craftcms/cms/issues/4008))\n- Controllers can now set `$allowAnonymous` to a combination of bitwise integers `self::ALLOW_ANONYMOUS_LIVE` and `self::ALLOW_ANONYMOUS_OFFLINE`, or an array of action ID/bitwise integer pairs, to define whether their actions should be accessible anonymously even when the system is offline.\n- Improved the error message when Project Config reaches the maximum deferred event count.\n- Craft now deletes expired template caches as part of its garbage collection routine.\n- Craft no longer warns about losing unsaved changes when leaving the page while previewing entries, if the changes were autosaved. ([#4439](https://github.com/craftcms/cms/issues/4439))\n- `fieldValues` is a now reserved field handle. ([#4453](https://github.com/craftcms/cms/issues/4453))\n- Improved the reliability of `craft\\helpers\\UrlHelper::rootRelativeUrl()` and `cpUrl()`.\n- `craft\\base\\ElementInterface::eagerLoadingMap()` and `craft\\base\\EagerLoadingFieldInterface::getEagerLoadingMap()` can now return `null` to opt out of eager-loading. ([#4220](https://github.com/craftcms/cms/pull/4220))\n- `craft\\db\\ActiveRecord` no longer sets the `uid`, `dateCreated`, or `dateUpdated` values for new records if they were already explicitly set.\n- `craft\\db\\ActiveRecord` no longer updates the `dateUpdated` value for existing records if nothing else changed or if `dateUpdated` had already been explicitly changed.\n- `craft\\helpers\\UrlHelper::siteUrl()` and `url()` will now include the current request\u2019s token in the generated URL\u2019s query string, for site URLs.\n- `craft\\events\\MoveElementEvent` now extends `craft\\events\\ElementEvent`. ([#4315](https://github.com/craftcms/cms/pull/4315))\n- `craft\\queue\\BaseJob::setProgress()` now has a `$label` argument.\n- `craft\\queue\\jobs\\PropagateElements` no longer needs to be configured with a `siteId`, and no longer propagates elements to sites if they were updated in the target site more recently than the source site.\n- `craft\\queue\\QueueInterface::setProgress()` now has a `$label` argument.\n- `craft\\services\\Assets::getUserTemporaryUploadFolder()` now returns the current user\u2019s temporary upload folder by default if no user is provided.\n- `craft\\services\\Elements::deleteElement()` now has a `$hardDelete` argument.\n- `craft\\services\\Elements::deleteElement()` now has a `$hardDelete` argument. ([#3392](https://github.com/craftcms/cms/issues/3392))\n- `craft\\services\\Elements::getElementById()` now has a `$criteria` argument.\n- `craft\\services\\Elements::propagateElement()` now has a `$siteElement` argument.\n- `craft\\services\\Elements::saveElement()` now preserves existing elements\u2019 current `dateUpdated` value when propagating or auto-resaving elements.\n- `craft\\services\\Elements::saveElement()` now preserves the `uid`, `dateCreated`, and `dateUpdated` values on new elements if they were explicitly set. ([#2909](https://github.com/craftcms/cms/issues/2909))\n- `craft\\services\\Elements::setPlaceholderElement()` now throws an exception if the element that was passed in doesn\u2019t have an ID.\n- `craft\\services\\Matrix::saveField()` is no longer is responsible for duplicating blocks from other elements.\n- `craft\\web\\twig\\variables\\CraftVariable` no longer triggers the `defineComponents` event. ([#4416](https://github.com/craftcms/cms/issues/4416))\n- `craft\\web\\UrlManager::setRouteParams()` now has a `$merge` argument, which can be set to `false` to completely override the route params.\n- It\u2019s now possible to pass a `behaviors` key to the `$newAttributes` argument of `craft\\services\\Elements::duplicateElement()`, to preattach behaviors to the cloned element before it\u2019s saved.\n\n### Removed\n- Removed the Search Indexes utility. ([#3698](https://github.com/craftcms/cms/issues/3698))\n- Removed the `--batch-size` option from `resave/*` actions.\n- Removed the `craft.entryRevisions` Twig component.\n- Removed `craft\\controllers\\EntriesController::actionPreviewEntry()`.\n- Removed `craft\\controllers\\EntriesController::actionShareEntry()`.\n- Removed `craft\\controllers\\EntriesController::actionViewSharedEntry()`.\n- Removed `craft\\events\\VersionEvent`.\n- Removed `craft\\records\\Entry::getVersions()`.\n- Removed `craft\\records\\EntryDraft`.\n- Removed `craft\\records\\EntryVersion`.\n- Removed `craft\\services\\EntryRevisions::saveDraft()`.\n- Removed `craft\\services\\EntryRevisions::publishDraft()`.\n- Removed `craft\\services\\EntryRevisions::deleteDraft()`.\n- Removed `craft\\services\\EntryRevisions::saveVersion()`.\n- Removed `craft\\services\\EntryRevisions::revertEntryToVersion()`.\n- Removed the `Craft.EntryDraftEditor` JavaScript class.\n\n### Deprecated\n- Deprecated the `ownerSite` and `ownerSiteId` Matrix block query params.\n- Deprecated `craft\\controllers\\EntriesController::EVENT_PREVIEW_ENTRY`.\n- Deprecated `craft\\controllers\\LivePreviewController`.\n- Deprecated `craft\\elements\\MatrixBlock::$ownerSiteId`.\n- Deprecated `craft\\events\\DefineComponentsEvent`.\n- Deprecated `craft\\helpers\\ArrayHelper::filterByValue()`. Use `where()` instead.\n- Deprecated `craft\\models\\BaseEntryRevisionModel`.\n- Deprecated `craft\\models\\EntryDraft`.\n- Deprecated `craft\\models\\EntryVersion`.\n- Deprecated `craft\\models\\Section::$propagateEntries`. Use `$propagationMethod` instead.\n- Deprecated `craft\\services\\Assets::getCurrentUserTemporaryUploadFolder()`.\n- Deprecated `craft\\services\\EntryRevisions`.\n- Deprecated `craft\\web\\Request::getIsLivePreview()`.\n- Deprecated `craft\\web\\Request::getIsSingleActionRequest()` and `craft\\console\\Request::getIsSingleActionRequest()`.\n- Deprecated the `Craft.LivePreview` JavaScript class.\n\n### Fixed\n- Fixed a bug where `craft\\helpers\\UrlHelper` methods could add duplicate query params on generated URLs.\n- Fixed a bug where Matrix blocks weren\u2019t getting duplicated for other sites when creating a new element. ([#4449](https://github.com/craftcms/cms/issues/4449))\n\n## 3.1.34.3 - 2019-08-21\n\n### Fixed\n- Fixed a bug where the `project-config/rebuild` command wasn\u2019t discarding unused user groups or user field layouts in the project config. ([#4781](https://github.com/craftcms/cms/pull/4781))\n\n## 3.1.34.2 - 2019-07-23\n\n### Fixed\n- Fixed a bug where the `project-config/rebuild` command was discarding email and user settings.\n\n## 3.1.34.1 - 2019-07-22\n\n### Fixed\n- Fixed a bug where the `project-config/rebuild` command was ignoring entry types that didn\u2019t have a field layout. ([#4600](https://github.com/craftcms/cms/issues/4600))\n\n## 3.1.34 - 2019-07-09\n\n### Changed\n- The `project-config/rebuild` command now rebuilds the existing project config wherever possible, instead of merging database data with the existing project config.\n\n## 3.1.33 - 2019-07-02\n\n### Added\n- Added `craft\\base\\ApplicationTrait::saveInfoAfterRequest()`.\n\n### Changed\n- Craft no longer strips some punctuation symbols from slugs.\n- Improved the performance of saving project config updates. ([#4459](https://github.com/craftcms/cms/issues/4459))\n- Improved the performance of saving fields. ([#4459](https://github.com/craftcms/cms/issues/4459))\n- The `craft update` command no longer updates Craft or plugins if not specified.\n\n### Removed\n- Removed `craft\\services\\ProjectConfig::saveDataAfterRequest()`.\n- Removed `craft\\services\\ProjectConfig::preventSavingDataAfterRequest()`.\n\n### Fixed\n- Fixed a PHP error that occurred when deleting an asset transform. ([#4473](https://github.com/craftcms/cms/issues/4473))\n\n### Security\n- Fixed an XSS vulnerability.\n- Fixed a path disclosure vulnerability. ([#4468](https://github.com/craftcms/cms/issues/4468))\n- Added the `sameSiteCookieValue` config setting. ([#4462](https://github.com/craftcms/cms/issues/4462))\n\n## 3.1.32.1 - 2019-06-25\n\n### Fixed\n- Fixed a couple Windows compatibility issues.\n\n## 3.1.32 - 2019-06-25\n\n### Changed\n- Project Config now sorts arrays when all of the keys are UIDs. ([#4425](https://github.com/craftcms/cms/issues/4425))\n\n### Fixed\n- Fixed a bug where Craft might not match a domain to the proper site if it had a non-ASCII character in the host name.\n- Fixed an error that could occur when using the `|filter` Twig filter. ([#4437](https://github.com/craftcms/cms/issues/4437))\n- Fixed a bug where pagination URL could get repeated page params added to the query string if using query string-based pagination.\n\n## 3.1.31 - 2019-06-18\n\n### Added\n- It\u2019s now possible to set plugin license keys to environment variables using the `$VARIABLE_NAME` syntax. ([#4393](https://github.com/craftcms/cms/issues/4393))\n- Added `craft\\services\\Elements::mergeElements()`. ([#4404](https://github.com/craftcms/cms/pull/4404))\n\n### Changed\n- Pagination URLs now include any query string parameters set on the current request.\n- The default email template no longer sets text or background colors, so emails look better in dark mode. ([#4396](https://github.com/craftcms/cms/pull/4396))\n- Improved the error message that gets logged when Craft isn\u2019t able to finish processing project config changes, due to unresolved dependencies.\n- Craft will no longer log errors and warnings arising from `yii\\i18n\\PhpMessageSource`. ([#4109](https://github.com/craftcms/cms/issues/4109))\n- Improved the performance and reliability of user queries when the `group` param is set to a user group with a large number of users.\n- Updated Yii to 2.0.21.\n\n### Fixed\n- Fixed a bug where `Craft::dd()` wouldn\u2019t work properly if output buffering was enabled. ([#4399](https://github.com/craftcms/cms/issues/4399))\n- Fixed a bug where `Craft::alias()` wasn\u2019t working on Windows servers. ([#4405](https://github.com/craftcms/cms/issues/4405))\n- Fixed a bug where Craft wasn\u2019t parsing the `dsn` DB connection setting properly if it was supplied.\n\n### Security\n- Fixed an XSS vulnerability.\n\n## 3.1.30 - 2019-06-11\n\n### Changed\n- Improved query performance. ([yiisoft/yii2#17344](https://github.com/yiisoft/yii2/pull/17344), [yiisoft/yii2#17345](https://github.com/yiisoft/yii2/pull/17345), [yiisoft/yii2#17348](https://github.com/yiisoft/yii2/pull/17348))\n- `craft\\services\\Elements::saveElement()` now always propagates elements regardless of the `$propagate` argument value, when saving new elements. ([#4370](https://github.com/craftcms/cms/issues/4370))\n\n### Fixed\n- Fixed a bug where new elements weren\u2019t assigned a UID in time if their URI format contained a `{uid}` token. ([#4364](https://github.com/craftcms/cms/issues/4364))\n- Fixed a bug where Craft was modifying custom log target configs before executing queue jobs. ([#3766](https://github.com/craftcms/cms/issues/3766))\n- Fixed a bug where `craft\\helpers\\ChartHelper::getRunChartDataFromQuery()` assumed that the value would be integers. ([craftcms/commerce#849](https://github.com/craftcms/commerce/issues/849))\n- Fixed a bug where `craft\\services\\Security::validateData()` was returning an empty string instead of `false` when the data didn\u2019t validate. ([#4387](https://github.com/craftcms/cms/issues/4387))\n- Fixed a bug where Craft could inject unexpected JavaScript into front-end requests. ([#4390](https://github.com/craftcms/cms/issues/4390))\n\n## 3.1.29 - 2019-06-04\n\n### Added\n- Added the `restore` command, which restores a database backup.\n- Added the `Craft.escapeRegex()` JavaScript method.\n\n### Changed\n- Asset indexes now sort assets by Date Uploaded in descending order by default. ([#1153](https://github.com/craftcms/cms/issues/1153))\n- `craft\\db\\Paginator` no longer assumes that the application\u2019s database connection should be used.\n- Updated Twig to 2.11. ([#4342](https://github.com/craftcms/cms/issues/4342))\n\n### Fixed\n- Fixed a bug where the Status menu wasn\u2019t visible for the \u201cAll users\u201d source on user indexes. ([#4306](https://github.com/craftcms/cms/pull/4306))\n- Fixed a bug where pressing the <kbd>Esc</kbd> key in the setup wizard would close the modal window. ([#4307](https://github.com/craftcms/cms/issues/4307))\n- Fixed a bug where `craft\\validators\\ArrayValidator::validate()` didn\u2019t work. ([#4309](https://github.com/craftcms/cms/pull/4309))\n- Fixed an error that could occur when rendering templates with a `loop.parent.loop` reference in a nested for-loop. ([#4271](https://github.com/craftcms/cms/issues/4271))\n- Fixed a bug where publishing a Single entry\u2019s draft, or reverting a Single entry to a prior version, would overwrite its title to the section name. ([#4323](https://github.com/craftcms/cms/pull/4323))\n- Fixed a bug where Craft wasn\u2019t invalidating existing asset transforms when changing the dimensions of a named transform.\n- Fixed a bug where `craft\\services\\Fields::getFieldsByElementType()` would return duplicate results if a field was used in more than one field layout for the element type. ([#4336](https://github.com/craftcms/cms/issues/4336))\n- Fixed a bug where Craft wasn\u2019t respecting the `allowUppercaseInSlug` config setting when generating slugs in the Control Panel. ([#4330](https://github.com/craftcms/cms/issues/4330))\n- Fixed a bug where Control Panel Ajax requests weren\u2019t working if a custom `pathParam` config setting value was set. ([#4334](https://github.com/craftcms/cms/issues/4334))\n- Fixed a JavaScript error that could occur when saving a new entry, if the selected entry type didn\u2019t have a Title field. ([#4353](https://github.com/craftcms/cms/issues/4353))\n\n## 3.1.28 - 2019-05-21\n\n### Added\n- Added the \u201cCustomize element sources\u201d user permission. ([#4282](https://github.com/craftcms/cms/pull/4282))\n- Matrix sub-fields now have a \u201cUse this field\u2019s values as search keywords?\u201d setting. ([#4291](https://github.com/craftcms/cms/issues/4291))\n- Added `craft\\web\\twig\\variables::setBasePath()`. ([#4286](https://github.com/craftcms/cms/issues/4286))\n\n### Changed\n- Craft now requires Yii 2.0.19.\n\n### Fixed\n- Fixed a bug where slugs could get double-hyphenated. ([#4266](https://github.com/craftcms/cms/issues/4266))\n- Fixed an error that would occur when installing Craft if the `allowAdminChanges` config setting was disabled. ([#4267](https://github.com/craftcms/cms/issues/4267))\n- Fixed a bug where Matrix fields would return the wrong set of Matrix blocks on new or duplicated elements, immediately after they were saved.\n- Fixed a bug where users could not assign additional user groups to their own account if their permission to do so was granted by another user group they belonged to.\n- Fixed a bug where Number fields would attempt to save non-numeric values. ([craftcms/feed-me#527](https://github.com/craftcms/feed-me/issues/527))\n- Fixed a bug where it was possible to assign a Structure entry or category to a new parent, even if that would cause its descendants to violate the Max Levels setting. ([#4279](https://github.com/craftcms/cms/issues/4279))\n- Fixed an error that could occur when rendering a template from a console request, if the template contained any non-global `{% cache %}` tags. ([#4284](https://github.com/craftcms/cms/pull/4284))\n\n## 3.1.27 - 2019-05-14\n\n### Added\n- Added `craft\\fields\\Matrix::EVENT_SET_FIELD_BLOCK_TYPES`. ([#4252](https://github.com/craftcms/cms/issues/4252))\n\n### Changed\n- Pressing <kbd>Shift</kbd> + <kbd>Return</kbd> (or <kbd>Shift</kbd> + <kbd>Ctrl</kbd>/<kbd>Command</kbd> + <kbd>Return</kbd>) when a textual cell is focused in an editable table will now change the focus to the same cell in the previous row (after creating a new row if necessary.) ([#4259](https://github.com/craftcms/cms/issues/4259))\n- Craft no longer shows the status menu for element sources that define a status. ([#4249](https://github.com/craftcms/cms/issues/4249))\n- Element URI formats can now conditionally output an empty string, opting the element out of getting its own system URI. ([#4254](https://github.com/craftcms/cms/issues/4254))\n- Table fields now get validation errors if any column handles are entered in the format of \u201ccolX\u201d.\n- Craft no longer clear out users\u2019 verification codes after login. ([#4257](https://github.com/craftcms/cms/issues/4257))\n- The `users/upload-user-photo` and `users/delete-user-photo` actions are now available to front-end requests. ([#3932](https://github.com/craftcms/cms/issues/3932))\n\n### Fixed\n- Fixed a bug where rebuilding the project config could set an incorrect value for the user field layout.\n- Fixed a bug Craft wouldn\u2019t allow users to edit their own photos if they didn\u2019t have upload/remove asset permissions.\n- Fixed a bug where Craft wasn\u2019t removing newline characters when pasting text into some single-line Table column types.\n- Fixed a bug where project config syncing could have inconsistent results on load-balanced environments. ([#4136](https://github.com/craftcms/cms/issues/4136))\n- Fixed a bug where the Plugin Store was not able to load developer details. ([#4241](https://github.com/craftcms/cms/issues/4241))\n- Fixed a bug that could occur when Craft generated URLs with multi-byte characters in the query string.\n- Fixed a bug where you could get some character encoding issues in some environments when using PHP 7.3.\n- Fixed a bug where Craft wasn\u2019t attempting to set a unique URI on duplicated elements. ([#4253](https://github.com/craftcms/cms/issues/4253))\n- Fixed a bug where Table fields could copy cell values to other cells if a column had a handle in the format of \u201ccolX\u201d. ([#4200](https://github.com/craftcms/cms/issues/4200))\n- Fixed an error that could occur on the Login page if a custom Login Page Logo was selected. ([#4261](https://github.com/craftcms/cms/issues/4261))\n\n## 3.1.26 - 2019-05-08\n\n### Changed\n- The \u201cUpdate all\u201d button on the Updates utility is now shown even if the page contains some uninstallable updates. ([#4230](https://github.com/craftcms/cms/issues/4230))\n- Craft now stores the Default User Group\u2019s UID in the project config, in case the group\u2019s ID is different across environments.\n- `craft\\services\\Assets::EVENT_BEFORE_REPLACE_ASSET` event handlers can now change the filename of the replaced asset before it is saved.\n- Improved the performance of background jobs. ([#4219](https://github.com/craftcms/cms/pull/4219))\n- Improved the Plugin Store\u2019s screenshots with arrows for navigation and pinch-to-zoom capability for touch devices.\n\n### Fixed\n- Fixed an error that could occur when saving a Single section if one of its sites had been disabled.\n- Fixed an error that could occur when deleting a site.\n- Fixed a PHP compile error that could occur when paginating a query. ([#4208](https://github.com/craftcms/cms/pull/4208))\n- Fixed an error that could occur on the Settings \u2192 Users \u2192 Settings page if the project config was missing its `users` key. ([#4206](https://github.com/craftcms/cms/issues/4206))\n- Fixed a bug where Craft wasn\u2019t requiring email verification for new user accounts if the project config was missing its `users` key.\n- Fixed a bug where Craft wasn\u2019t eager-loading elements in the same site as the source element, if that was different than the currently requested site. ([#3954](https://github.com/craftcms/cms/issues/3954))\n\n## 3.1.25 - 2019-04-30\n\n### Added\n- Added the `|ascii` Twig filter. ([#4193](https://github.com/craftcms/cms/issues/4193))\n\n### Changed\n- Craft now registers its project config event handlers before loading plugins. ([#3943](https://github.com/craftcms/cms/issues/3943))\n- The Control Panel now uses jQuery 3.4.0. ([#4183](https://github.com/craftcms/cms/issues/4183))\n- `behavior` and `behaviors` are now reserved field handles. ([#4184](https://github.com/craftcms/cms/issues/4184))\n- The Updates utility no longer shows notices for expired plugins if no updates are actually available. ([#4186](https://github.com/craftcms/cms/issues/4186))\n\n### Fixed\n- Fixed an error where rebuilding the project config would not typecast the `propagateEntries` and `enableVersioning` section settings correctly. ([#3695](https://github.com/craftcms/cms/issues/3695))\n- Fixed a bug where the Edit Draft HUD would include the current site name in the default Draft Name value for multi-site entries. ([#4171](https://github.com/craftcms/cms/issues/4171))\n- Fixed a bug where resource requests could send a 500 response if the resource didn\u2019t exist. ([#4197](https://github.com/craftcms/cms/pull/4197))\n\n## 3.1.24 - 2019-04-23\n\n### Added\n- Added `craft\\services\\Fields::getFieldIdsByLayoutId()`.\n\n### Changed\n- Craft now correctly typecasts all core boolean and integer values saved to the project config. ([#3695](https://github.com/craftcms/cms/issues/3695))\n- Craft now saves new entry versions every time an entry is saved, unless it\u2019s being propagated or resaved.\n- `users/save-user` and `users/start-elevated-session` requests now check for a `currentPassword` body param in addition to `password`, when looking for the user\u2019s current password. ([#4169](https://github.com/craftcms/cms/issues/4169))\n- `craft\\services\\Path::getStoragePath()` now has a `$create` argument.\n- Updated Twig to 2.8.\n\n### Fixed\n- Fixed an error where re-saving a site would reset its sorting order. ([#4147](https://github.com/craftcms/cms/issues/4147))\n- Fixed a SQL error that could occur when updating to Craft 3.1. ([#3663](https://github.com/craftcms/cms/issues/3663))\n- Fixed an error that occurred when an SVG with `/` characters in its `id` attributes was passed to the `svg()` Twig function. ([#4155](https://github.com/craftcms/cms/issues/4155))\n- Fixed a bug where passing `:empty:` or `:notempty:` to a Matrix field param on an element query could return incorrect results for fields that had soft-deleted blocks. ([#4161](https://github.com/craftcms/cms/issues/4161))\n- Fixed a bug where Craft wasn\u2019t returning a `1` exit code for console requests if the server was running under PHP 7. ([#4153](https://github.com/craftcms/cms/issues/4153))\n- Fixed a \u201cWorld-writable config file 'my.cnf' is ignored\u201d warning that could occur when creating a database backup. ([#4163](https://github.com/craftcms/cms/pull/4163))\n- Fixed a bug where `craft\\services\\Elements::duplicateElements()` would only ignore non-safe attributes passed to the `$newAttributes` argument.\n- Fixed a bug where `craft\\elements\\db\\ElementQuery::exists()` and `offsetExists()` were ignoring cached query results.\n\n## 3.1.23 - 2019-04-16\n\n### Added\n- The `project-config/sync` command now has a `--force` option, which forces the project config to treat all preexisting config values as new. ([#4126](https://github.com/craftcms/cms/issues/4126))\n- Added `craft\\base\\LogTargetTrait`, which can be used by custom `log` components, to gain security and privacy features provided by Craft\u2019s built-in file target. ([#4127](https://github.com/craftcms/cms/pull/4127))\n\n### Changed\n- When creating a new site, global sets are now propagated to it before other element types. ([#3446](https://github.com/craftcms/cms/issues/3446))\n- Locked Twig down to 2.7, to avoid a bug in 2.8.0. ([twigphp/Twig#2942](https://github.com/twigphp/Twig/issues/2942))\n\n### Fixed\n- Fixed an error that occurred when installing a missing plugin from the Settings \u2192 Plugins page. ([#4140](https://github.com/craftcms/cms/issues/4140))\n- Fixed PHP type errors that could occur when calling some deprecated `craft.request` methods in templates. ([#4124](https://github.com/craftcms/cms/issues/4124))\n- Fixed performance issues that could occur where uploading GIFs in the Control Panel. ([#4131](https://github.com/craftcms/cms/pull/4131))\n- Fixed a bug where it wasn\u2019t possible to create a new global set with the same name or handle as a soft-deleted one. ([#4091](https://github.com/craftcms/cms/issues/4091))\n- Fixed a bug where pending users\u2019 verification codes were getting deleted if they were impersonated by an admin. ([#4130](https://github.com/craftcms/cms/issues/4130))\n\n## 3.1.22 - 2019-04-10\n\n### Added\n- Added `craft\\base\\ElementTrait::$resaving`, which indicates whether the element is currently being resaved via a `ResaveElements` job or a `resave` command. ([#3482](https://github.com/craftcms/cms/issues/3482))\n- Added `craft\\db\\Paginator::setPageResults()`. ([#4120](https://github.com/craftcms/cms/issues/4120))\n\n### Changed\n- Changed the way Craft updates search indexes, to reduce the likelihood of a deadlock. ([#3197](https://github.com/craftcms/cms/issues/3197))\n- Improved styles and behavior of the Plugin Store.\n- The Settings \u2192 Plugins page now notes which plugins are expired, with links to renew them on [id.craftcms.com](https://id.craftcms.com).\n- Improved the styling of info HUDs that contain long text or tables. ([#4107](https://github.com/craftcms/cms/pull/4107))\n\n### Fixed\n- Fixed a PHP error that could occur during asset indexing in some cases.\n- Fixed a bug where entry drafts weren\u2019t showing previous changes to Matrix fields on the draft. ([#4105](https://github.com/craftcms/cms/issues/4105))\n- Fixed a bug where `project.yaml` changes weren\u2019t always getting picked up. ([#4028](https://github.com/craftcms/cms/issues/4028))\n- Fixed a bug where the `project-config/rebuild` command would restore soft-deleted components. ([#4100](https://github.com/craftcms/cms/issues/4100))\n- Fixed a bug where the `project-config/sync` command was not performing schema checks.\n- Fixed an error that occurred when backing up the database if the database password contained a `$` character. ([#4115](https://github.com/craftcms/cms/issues/4115))\n\n## 3.1.21.1 - 2019-04-04\n\n### Fixed\n- Fixed a bug where underscores were getting stripped from element slugs. ([#4096](https://github.com/craftcms/cms/issues/4096))\n\n## 3.1.21 - 2019-04-03\n\n### Added\n- Added the `backup` command, which creates a new database backup. ([#4075](https://github.com/craftcms/cms/issues/4075))\n- Added the `queue/retry` command, which can be passed a failed job ID, or `all` to retry all failed jobs. ([#4072](https://github.com/craftcms/cms/issues/4072))\n- Added `craft\\queue\\Queue::retryAll()`.\n- Added `craft\\services\\sections::$autoResaveEntries`, which can be set to `false` from `config/app.php` to prevent Craft from auto-resaving entries after sections and entry types are updated. ([#3482](https://github.com/craftcms/cms/issues/3482))\n\n### Changed\n- It\u2019s now possible to double-click on asset sources to expand/collapse their subfolders. ([#4070](https://github.com/craftcms/cms/issues/4070))\n- Craft no longer auto-resaves entries after saving a section or entry type if nothing changed of any significance to entries. ([#3482](https://github.com/craftcms/cms/issues/3482))\n- Craft now formats filesizes using metric units (e.g. MB instead of MiB).\n- The updater is now capable of handling package name changes.\n- Craft now requires Yii 2.0.17.\n\n### Fixed\n- Fixed a bug where the Asset Indexes utility wasn\u2019t logging exceptions.\n- Fixed a SQL error that could occur when using the Asset Indexes utility, if any filenames contained 4+ byte characters.\n- Fixed a bug where entry queries could return duplicate results for any entries that belong to a section that has soft-deleted structures associated with it. ([#4066](https://github.com/craftcms/cms/issues/4066))\n- Fixed a bug where rebuilding project config would not work with Matrix fields with no block types. ([#4074](https://github.com/craftcms/cms/issues/4074)\n- Fixed an error that occurred when sending emails if the `testToEmailAddress` config setting was set. ([#4076](https://github.com/craftcms/cms/issues/4076))\n- Fixed a bug where it wasn\u2019t possible to pass the `--element-id` option on `resave/*` commands.\n- Fixed a bug where Matrix fields were including disabled blocks if any changes had been made to the Matrix block query params.\n- Fixed SQL errors that could occur if the table prefix had ever changed.\n\n## 3.1.20.1 - 2019-03-27\n\n### Fixed\n- Fixed an error that occurred when regenerating the project config, if there were any fields without settings. ([#4062](https://github.com/craftcms/cms/issues/4062))\n- Fixed an error that occurred when loading the `_includes/forms/date` template without passing a `value` variable. ([#4063](https://github.com/craftcms/cms/issues/4063))\n\n## 3.1.20 - 2019-03-27\n\n### Added\n- Added the `project-config/rebuild` console command.\n- Added the `verifyEmailSuccessPath` config setting.\n- Added the \u201cPrefix\u201d and \u201cSuffix\u201d settings for Number fields. ([#4055](https://github.com/craftcms/cms/issues/4055))\n- Added the \u201cMax Length\u201d setting for URL fields. ([#4019](https://github.com/craftcms/cms/issues/4019))\n- Added the `devMode` global Twig variable. ([#4038](https://github.com/craftcms/cms/issues/4038))\n- Added `craft\\config\\GeneralConfig::getVerifyEmailSuccessPath()`.\n- Added `craft\\events\\RebuildConfigEvent`.\n- Added `craft\\services\\ProjectConfig::rebuild()`.\n- Added `craft\\services\\Sections::pruneDeletedField()`.\n\n### Changed\n- Textareas within the Control Panel can now be manually vertically resized. ([#4030](https://github.com/craftcms/cms/issues/4030))\n- The Craft Support widget now includes a \u201cMore Resources\u201d section. ([#4058](https://github.com/craftcms/cms/issues/4058))\n- The `_includes/forms/text` Control Panel template now supports `step`, `min`, and `max` attributes.\n- Users without access to the Control Panel are now redirected according to the `verifyEmailSuccessPath` config setting after verifying a new email address. ([#1998](https://github.com/craftcms/cms/issues/1998))\n- The `_includes/forms/text` Control Panel template now supports passing `autocorrect: false` and `autocapitalize: false`, to disable autocorrect and auto-capitalization on iOS devices.\n- iOS autocorrect and auto-capitalization has been disabled for all core \u201cHandle\u201d and \u201cSlug\u201d fields in the Control Panel. ([#4009](https://github.com/craftcms/cms/issues/4009))\n- Number fields now format their values for element index tables. ([#4059](https://github.com/craftcms/cms/issues/4059))\n- When installing Craft using a `project.yaml`, Craft now backups the existing config to the config backup folder if there are errors. ([#4017](https://github.com/craftcms/cms/issues/4017))\n- Craft now prunes entry type layouts when deleting a field.\n- Craft no longer modifies the DSN string if set explicitly with the `dsn` database config setting.\n- Craft no longer throws an `InvalidConfigException` when the `dsn` database config setting is set and contains an unexpected parameter.\n\n### Fixed\n- Fixed a bug where Craft wasn\u2019t removing hyphens and other symbols from auto-generated asset titles. ([#4011](https://github.com/craftcms/cms/issues/4011))\n- Fixed a PHP error that occurred when calling `craft\\services\\EntryRevisions::getDraftById()` or `getVersionById()` for a draft/version that belonged to a soft-deleted entry. ([#4013](https://github.com/craftcms/cms/issues/4013))\n- Fixed a bug where Craft wasn\u2019t respecting the site selection for routes defined in Settings \u2192 Routes. ([#4021](https://github.com/craftcms/cms/issues/4021))\n- Fixed a bug where the `project-config/sync` command wasn\u2019t logging exceptions. ([#4015](https://github.com/craftcms/cms/issues/4015))\n- Fixed an error that occurred when attempting to use Live Preview with a pending user account. ([#4025](https://github.com/craftcms/cms/issues/4025))\n- Fixed an error when displaying a date input in the Control Panel if the value passed wasn\u2019t a `DateTime` object. ([#4041](https://github.com/craftcms/cms/issues/4041))\n- Fixed a PHP error that occurred when passing an array of `craft\\elements\\User` objects to `craft\\mail\\Message::setTo()`. ([#4048](https://github.com/craftcms/cms/issues/4048))\n- Fixed a bug where Craft was applying the `offset` param to both ends of the result set when paginating queries. ([#4052](https://github.com/craftcms/cms/issues/4052))\n- Fixed a PHP error that occurred if `true` or `false` was passed to the third argument of `craft\\db\\Command::upsert()`. ([#4054](https://github.com/craftcms/cms/pull/4054))\n- Fixed a bug where deleting fields via `project.yaml` could prevent other changes from being applied.\n- Fixed a bug where field UIDs could be overwritten in some cases.\n\n## 3.1.19 - 2019-03-19\n\n### Added\n- Added the `_includes/pagination` Control Panel template.\n- Added `craft\\db\\Paginator`.\n- Added `craft\\web\\twig\\variables\\Paginate::create()`.\n\n### Changed\n- The `{% paginate %}` tag now accepts any query object, not just element queries.\n- The `_includes/forms/autosuggest` template now has `data` and `methods` blocks that can be overridden by sub-templates to customize the autosuggest behavior.\n\n### Fixed\n- Fixed a bug where sidebar badge counts in the Control Panel were getting formatted with two decimals if the Intl extension wasn\u2019t loaded. ([#4002](https://github.com/craftcms/cms/issues/4002))\n- Fixed a bug where entry drafts would forget that certain field values had been cleared out, and continue using the live revision\u2019s content instead. ([#3981](https://github.com/craftcms/cms/issues/3981))\n- Fixed an error that occurred if a Table field was created with a Date or Time column and no rows in the Default Values setting. ([#4005](https://github.com/craftcms/cms/issues/4005))\n- Fixed a bug where Table fields would forget that they had been saved without any rows in the Default Values setting.\n- Fixed a SQL error that could occur when saving non-UTF-8 characters to the project config. ([#4007](https://github.com/craftcms/cms/issues/4007))\n\n## 3.1.18 - 2019-03-14\n\n### Added\n- Added `craft\\services\\Deprecator::$throwExceptions`. ([#3972](https://github.com/craftcms/cms/pull/3972))\n\n### Changed\n- `Craft::parseEnv()` will now boolean values for environment variables set to `true` or `false`. ([#3975](https://github.com/craftcms/cms/issues/3975))\n- Nested project config keys are no longer sorted alphabetically.\n- Craft now requires Twig 2.7+.\n\n### Fixed\n- Fixed a SQL error that occurred when using a token with a usage limit, if using PostgreSQL. ([#3969](https://github.com/craftcms/cms/issues/3969))\n- Fixed a bug where the Edit User page would forget user group selection changes if there was a validation error. ([#3971](https://github.com/craftcms/cms/issues/3971))\n- Fixed a bug where the updater would get an unexpected response when updating from 3.1.14 - 3.1.16 to 3.1.17+.\n- Fixed a bug where it wasn\u2019t possible to switch plugin editions when the `allowUpdates` config setting was disabled. ([#3987](https://github.com/craftcms/cms/issues/3987))\n- Fixed a bug where multiple consecutive newlines in field instructions would result in multiple `<br>` tags rather than new paragraphs.\n- Fixed a bug where Table fields weren\u2019t always remembering the sort order for their Default Values settings. ([#3947](https://github.com/craftcms/cms/issues/3947))\n- Fixed a bug where Table fields weren\u2019t always remembering the sort order for their Table Columns settings. ([#3997](https://github.com/craftcms/cms/issues/3997))\n\n## 3.1.17.2 - 2019-03-12\n\n### Changed\n- Craft now requires Twig 2.6.\n\n## 3.1.17.1 - 2019-03-08\n\n### Added\n- Added `craft\\helpers\\ArrayHelper::ensureNonAssociative()`.\n\n### Fixed\n- Fixed a bug where commercial plugin editions weren\u2019t showing up in the Plugin Store.\n- Fixed a bug where installing a plugin from the Plugin Store would not respect the selected edition.\n- Fixed a bug where plugins with free and commercial editions weren\u2019t getting license key inputs on the Setting \u2192 Plugins page.\n- Fixed a bug where the Setting \u2192 Plugins page wasn\u2019t linking plugins\u2019 edition badge to their page in the Plugin Store for plugins with free and commercial editions, if the free edition was currently active.\n\n## 3.1.17 - 2019-03-08\n\n### Changed\n- When installing Craft using a `project.yaml`, Craft now processes all sites before installing any plugins. ([craftcms/commerce#752](https://github.com/craftcms/commerce/issues/752))\n- The Plugin Store now shows \u201cReport an issue\u201d links on plugin screens.\n- The Plugin Store now includes a \u201cPackage Name\u201d section on plugin screens. ([#2757](https://github.com/craftcms/cms/issues/2757))\n- The Plugin Store now shows discounted upgrade prices for plugins when a lower edition is already licensed.\n- Craft now requires Yii 2.0.16.1.\n\n### Fixed\n- Fixed a bug where the `positionedBefore` element query param was not including direct ancestors in the results.\n- Fixed a bug where HTML in plugin-supplied field instructions was getting encoded. ([#3928](https://github.com/craftcms/cms/issues/3928))\n- Fixed a bug where Craft would prompt for a user\u2019s current password when registering a new user, even if they weren\u2019t assigning any groups or permissions to that user\n- Fixed a bug where asset indexing could yield inconsistent results in some cases. ([#3450](https://github.com/craftcms/cms/issues/3450))\n- Fixed a bug where the Plugin Store was showing info icons in the feature matrix of multi-edition plugins, even for features that didn\u2019t have an extended description.\n- Fixed a bug where entries weren\u2019t getting new versions when edited from element editor HUDs. ([#3959](https://github.com/craftcms/cms/issues/3959))\n\n## 3.1.16 - 2019-03-05\n\n### Added\n- The Plugin Store now shows Repository links on plugin screens.\n- Added the `create()` Twig function. ([#3921](https://github.com/craftcms/cms/pull/3921))\n- Added the `--type` option to the `resave/entries` command. ([#3939](https://github.com/craftcms/cms/issues/3939))\n- Added `craft\\helers\\Assets::getAllowedFileKinds()`.\n\n### Changed\n- Line breaks in field instructions now get converted to `<br>` tags. ([#3928](https://github.com/craftcms/cms/issues/3928))\n- Assets field settings no longer list file kinds that aren\u2019t allowed to be uploaded, per the `allowedFileExtensions` and `extraAllowedFileExtensions` config settings. ([#3917](https://github.com/craftcms/cms/issues/3917))\n- The `{% exit %}` tag now throws a more specific exception depending on the status code passed to it (e.g. `yii\\web\\NotFoundHttpException` for 404s). ([#3915](https://github.com/craftcms/cms/issues/3915))\n- `craft\\helpers\\MigrationHelper::dropAllIndexesOnTable()` is no longer deprecated.\n- The `--id` option on `resave/*` console commands is now named `--element-id`. ([#3940](https://github.com/craftcms/cms/issues/3940))\n- The `_includes/forms/autosuggest.html` template now supports passing `disabled: true`. ([#3925](https://github.com/craftcms/cms/issues/3925))\n\n### Fixed\n- Fixed a bug where Control Panel content areas weren\u2019t getting their bottom padding applied in Firefox. ([#3874](https://github.com/craftcms/cms/issues/3874))\n- Fixed a PHP error that occurred on the front-end if two routes defined in Settings \u2192 Routes had the same URI pattern. ([#3922](https://github.com/craftcms/cms/issues/3922))\n- Fixed a bug where Craft wasn\u2019t always preselecting the correct tab on Control Panel pages if the tab name contained non-ASCII characters. ([#3923](https://github.com/craftcms/cms/issues/3923))\n- Fixed a bug where the `--uid` option on `resave/*` console commands wasn\u2019t working. ([#3941](https://github.com/craftcms/cms/issues/3941))\n- Fixed a SQL error that could occur when running `resave/*` console commands.\n- Fixed a PHP error that occurred when calling the deprecated `getError()` method on a model that had no errors. ([#3934](https://github.com/craftcms/cms/issues/3934))\n- Fixed a bug where Craft wasn\u2019t sanitizing new asset subfolder names. ([#3689](https://github.com/craftcms/cms/issues/3689))\n- Fixed a bug where Table fields weren\u2019t remembering the sort order for their Default Values settings. ([#3947](https://github.com/craftcms/cms/issues/3947))\n\n## 3.1.15 - 2019-02-26\n\n### Added\n- Added the `resave/assets`, `resave/categories`, `resave/entries`, `resave/tags`, and `resave/users` console commands.\n\n### Changed\n- Craft now sends system messages authored for the same root language as the requested language, if an exact language match can\u2019t be found. ([#3888](https://github.com/craftcms/cms/issues/3888))\n- Element source definitions can now include a `badgeCount` key.\n- Login requests no longer enforce CSRF validation if someone is already logged in.\n- Craft now throws an `InvalidConfigException` when updating the project config if any unexpected data types are encountered.\n- The `testToEmailAddress` config setting can now be set to `false`. ([#3910](https://github.com/craftcms/cms/pull/3910))\n\n### Fixed\n- Fixed a bug where the System Messages utility wouldn\u2019t update message previews after editing a message for the primary site\u2019s language, if the user had a different preferred language selected.\n- Fixed a bug where structures weren\u2019t getting deleted and unassigned from their sections properly after converting a Structure section to a Channel or Single. ([#3895](https://github.com/craftcms/cms/issues/3895))\n- Really fixed a bug where Craft could update the `dateModified` value in the project config even when nothing had changed. ([#3792](https://github.com/craftcms/cms/issues/3792))\n- Fixed a bug where the Settings \u2192 Routes page wasn\u2019t listing routes in the user-defined order. ([#3892](https://github.com/craftcms/cms/issues/3892))\n- Fixed an error that occurred when viewing trashed entries, if the \u201cEntry Type\u201d column was shown and one of the trashed entries\u2019 entry types had been deleted. ([#3899](https://github.com/craftcms/cms/issues/3899))\n\n## 3.1.14 - 2019-02-21\n\n### Added\n- Added `craft\\helpers\\ProjectConfig::cleanupConfig()`.\n- Added `craft\\web\\Request::$maxPageNum`, which determines the maximum page number Craft should accept (100,000 by default). ([#3880](https://github.com/craftcms/cms/issues/3880))\n\n### Deprecated\n- Deprecated `craft\\mutex\\FileMutex`.\n\n### Fixed\n- Fixed a bug where Craft could update the `dateModified` value in the project config even when nothing had changed. ([#3792](https://github.com/craftcms/cms/issues/3792))\n- Fixed a SQL error that occurred when running the \u201cLocalizing relations\u201d task if using PostgreSQL. ([#3877](https://github.com/craftcms/cms/issues/3877))\n- Fixed a bug where file locking wasn\u2019t working on Windows. ([#3879](https://github.com/craftcms/cms/issues/3879))\n\n### Security\n- Fixed a bug where sensitive environment variable values weren\u2019t getting redacted correctly.\n\n## 3.1.13 - 2019-02-20\n\n### Added\n- Added `craft\\helpers\\StringHelper::replaceMb4()`.\n- Added `craft\\services\\ProjectConfig::defer()`.\n\n### Changed\n- The `users/login` and `users/logout` actions now include a `csrfTokenValue` key in JSON responses. ([#3858](https://github.com/craftcms/cms/issues/3858))\n- Craft no longer deletes search indexes when soft-deleting an element, until the element gets hard-deleted. ([#3863](https://github.com/craftcms/cms/issues/3863))\n- Updated Yii to 2.0.16.\n\n### Fixed\n- Fixed a bug where Craft could auto-place the `{{ beginBody() }}` and `{{ endBody() }}` tags in the wrong places.\n- Fixed a bug where Craft wasn\u2019t storing custom volume sort orders. ([#3764](https://github.com/craftcms/cms/issues/3764))\n- Fixed a SQL error that would occur when uploading a file with emojis in its name, if using MySQL. ([#3852](https://github.com/craftcms/cms/issues/3852))\n- Fixed a bug where Assets fields weren\u2019t respecting their View Mode setting when files were drag-uploaded to them. ([#3578](https://github.com/craftcms/cms/issues/3578))\n- Fixed a bug where asset queries\u2019 `kind` param wasn\u2019t working for custom file kinds defined by the `extraFileKinds` config setting, for file extensions that were already associated with another file kind. ([#3869](https://github.com/craftcms/cms/issues/3869))\n- Fixed a bug where `craft\\helpers\\FileHelper::sanitizeFilename()` could return inconsistent results.\n- Fixed an error that could occur when syncing `project.yaml` if it introduced a new Super Table field with a nested Matrix field.\n\n## 3.1.12 - 2019-02-15\n\n### Fixed\n- Fixed a bug where the `relatedTo` element query param could include results for elements that were related via soft-deleted Matrix blocks. ([#3846](https://github.com/craftcms/cms/issues/3846))\n- Fixed a bug where some search queries were not returning results when they should, if using MySQL.\n- Fixed an error that could occur when syncing `project.yaml` changes if the `allowAdminChanges` config setting was disabled. ([#3823](https://github.com/craftcms/cms/issues/3823))\n- Fixed an `InvalidConfigException` that was thrown if a user\u2019s photo was soft-deleted. ([#3849](https://github.com/craftcms/cms/issues/3849))\n\n## 3.1.11 - 2019-02-14\n\n### Added\n- Added `craft\\helpers\\UrlHelper::rootRelativeUrl()`.\n\n### Fixed\n- Fixed a bug where the Plugin Store wouldn\u2019t load if the `baseCpUrl` config setting was set to a URL with a different scheme than Craft believed the request had.\n- Fixed a validation error that would occur on non-required Checkboxes and Multi-select fields if no options were selected. ([#3844](https://github.com/craftcms/cms/issues/3844))\n- Fixed a validation error that would occur on Dropdown and Radio Buttons fields if the selected option\u2019s value was `0`. ([#3842](https://github.com/craftcms/cms/issues/3842))\n- Fixed a bug where the Value column for Checkboxes, Dropdown, Multi-select, and Radio Buttons fields\u2019 Options settings weren\u2019t auto-populating if the Option Label column was set to a number.\n- Fixed an error on the Settings \u2192 Users page if `users.photoVolumeUid` was not defined in the project config. ([#3303](https://github.com/craftcms/cms/issues/3303))\n\n## 3.1.10 - 2019-02-13\n\n### Changed\n- `craft\\helpers\\FileHelper::writeToFile()` now invalidates the OPcache for the file. ([#3838](https://github.com/craftcms/cms/pull/3838))\n- The `serve` command now uses `@webroot` as the default `docroot` option value. ([#3770](https://github.com/craftcms/cms/pull/3770))\n\n###\u00a0Fixed\n- Fixed a bug where the `users/save-user` action wasn\u2019t deleting user photos properly.\n- Fixed a bug where changes to Matrix block type fields\u2019 settings weren\u2019t always saving. ([#3832](https://github.com/craftcms/cms/issues/3832))\n- Fixed a bug where non-searchable fields were still getting search keywords stored when using the Search Indexes utility. ([#3837](https://github.com/craftcms/cms/issues/3837))\n\n## 3.1.9.1 - 2019-02-12\n\n### Fixed\n- Fixed a bug where `Craft::alias()` wasn\u2019t beginning the response string with an `@` character if no `@` was passed into `Craft::setAlias()` to begin with.\n- Fixed an error that could occur if there were any HTML entities in the project config.\n\n## 3.1.9 - 2019-02-12\n\n### Added\n- Added the `disabledPlugins` config setting. ([craftcms/webhooks#4](https://github.com/craftcms/webhooks/issues/4))\n- Added the `$language` argument to `craft\\helpers\\StringHelper::toAscii()`.\n- Added `craft\\validators\\SlugValidator::$language`.\n- Added `craft\\web\\twig\\variables\\Cp::getAsciiCharMap()`.\n\n### Changed\n- The operating system name & version are now shown in the System Report utility. ([#3784](https://github.com/craftcms/cms/issues/3784))\n- Craft\u2019s installer no longer applies the current `project.yaml` file if the installed schema version doesn\u2019t match the one in the file. ([#3783](https://github.com/craftcms/cms/issues/3783))\n- Control Panel settings no longer warn about using the `@web` alias, if it was defined by the `aliases` config setting. ([#3798](https://github.com/craftcms/cms/pull/3798))\n- The `clear-caches` console command now clears CP resource files if the `@webroot` alias was defined by the `aliases` config setting. ([#3787](https://github.com/craftcms/cms/issues/3787))\n- `craft\\models\\VolumeFolder::getVolume()` now throws an `InvalidConfigException` if its `$volumeId` property is set to an invalid volume ID, rather than returning `null`.\n- Craft now checks if all files in project config mapping are valid and regenerates the map if they are not.\n- Craft now auto-generates slugs using an ASCII char map based on the language of the current entry/category, rather than the logged-in user. ([#3820](https://github.com/craftcms/cms/issues/3820))\n\n### Fixed\n- Fixed a SQL error that could occur when deleting an asset. ([#3786](https://github.com/craftcms/cms/issues/3786))\n- Fixed an error that occurred when customizing element indexes if the `allowAdminChanges` config setting was disabled. ([#3788](https://github.com/craftcms/cms/issues/3788))\n- Fixed a bug where Checkboxes, Dropdown, Multi-select, and Radio Buttons fields wouldn\u2019t pass validation if the selected option value was `true` or `false`.\n- Fixed an error that occurred on the Settings \u2192 Plugins page, if there were any plugins in the database that weren\u2019t Composer-installed.\n- Fixed an error that could occur if an Assets field was configured to upload to a deleted volume. ([#3799](https://github.com/craftcms/cms/issues/3799))\n- Fixed a bug where sections\u2019 Default Status settings weren\u2019t always being respected. ([#3791](https://github.com/craftcms/cms/issues/3791))\n- Fixed a bug where only users with the \u201cEdit users\u201d user permission were allowed to upload a new user photo. ([#3735](https://github.com/craftcms/cms/issues/3735))\n- Fixed a bug where renaming a Matrix block type\u2019s handle would result in new content columns being created in the database, and existing Matrix blocks losing their content. ([#3809](https://github.com/craftcms/cms/issues/3809))\n- Fixed a SQL error that could occur when updating to Craft 3.1 if any system messages contained emoji characters.\n- Fixed an error that could occur when working with elements, if a site had been created earlier in the same request. ([#3824](https://github.com/craftcms/cms/issues/3824))\n\n## 3.1.8 - 2019-02-05\n\n### Changed\n- Craft now automatically logs users in after resetting their password, if the `autoLoginAfterAccountActivation` config setting is enabled.\n\n### Fixed\n- Fixed a bug where pressing the <kbd>Return</kbd> key on editable tables with a static number of rows would add a new row. ([#3765](https://github.com/craftcms/cms/issues/3765))\n- Fixed a bug where pressing the <kbd>Return</kbd> key on editable tables would select the next row\u2019s cell even if the cell was disabled.\n- Fixed a bug where pressing the <kbd>Return</kbd> key on an editable table wouldn\u2019t move the focus to the next row\u2019s sell if it had an `<input>` instead of a `<textarea>`.\n- Fixed an error that could occur in the Control Panel if any environment variable values began with an `@` character. ([#3769](https://github.com/craftcms/cms/issues/3769))\n- Fixed a bug where `craft\\helpers\\DateTimeHelper::toDateTime()` was mistaking year-only values for Unix timestamps. ([#3772](https://github.com/craftcms/cms/issues/3772))\n- Fixed an error that occurred when a non-admin user attempted to edit a system message, or when the `allowAdminChanges` config setting was disabled. ([#3775](https://github.com/craftcms/cms/issues/3775))\n- Fixed a bug where it was hard to see error notifications on pages with a licensing alert. ([#3776](https://github.com/craftcms/cms/issues/3776))\n- Fixed a JavaScript error that occurred when adding a new row to a custom editable table that contained a `time` column, if no rows existed on page load. ([#3780](https://github.com/craftcms/cms/issues/3780))\n\n## 3.1.7 - 2019-01-31\n\n### Added\n- Added all the things that came in [Craft 3.0.40](https://github.com/craftcms/cms/blob/master/CHANGELOG-v3.md#3040---2019-01-31).\n- Added `craft\\helpers\\FileHelper::canTrustMimeType()`.\n- Added `craft\\web\\UploadedFile::getMimeType()`.\n\n### Changed\n- The \u201cPort\u201d SMTP mail transport setting can now be set to an environment variable. ([#3740](https://github.com/craftcms/cms/issues/3740))\n- `craft\\web\\Controller::requireAdmin()` now has a `$requireAdminChanges` argument, which dictates whether the `allowAdminChanges` config setting must also be enabled (`true` by default).\n- The `project-config/sync` console command now creates a `project.yaml` file, if it\u2019s missing. ([#3736](https://github.com/craftcms/cms/issues/3736))\n- Querying for active users no longer excludes locked users.\n- `craft\\helpers\\FileHelper::getMimeType()` now returns `application/x-yaml` for `.yaml` and `.yml` files.\n- Updated Craft UI to 0.2.0.\n\n### Fixed\n- Fixed an error that occurred when updating to Craft 3.1 if a plugin or module was calling `craft\\records\\User::find()`.\n- Fixed a bug where cross-domain Live Preview requests could fail due to CORS restrictions.\n- Fixed a 403 error that would occur when an admin attempted to log in as another user on an environment where the `allowAdminChanges` config setting was disabled. ([#3749](https://github.com/craftcms/cms/issues/3749))\n- Fixed a bug where asset index toolbar items would be misaligned when searching in a volume or folder with subfolders.\n- Fixed a bug where asset indexes could show multiple view mode toggles if a different volume or subfolder was selected while at least one asset was checked. ([#3702](https://github.com/craftcms/cms/issues/3702))\n- Fixed a bug where Plugin Store screenshots were not showing properly. ([#3709](https://github.com/craftcms/cms/issues/3709))\n- Fixed a bug where zoomed Plugin Store screenshots would not close when hitting the browser\u2019s Back button. ([#3754](https://github.com/craftcms/cms/issues/3754))\n- Fixed a bug where the Plugin Store was not working properly when Dev Mode was enabled.\n\n### Security\n- User accounts are now locked after multiple failed password attempts in current-password modals, per the `maxInvalidLogins` config setting.\n- Users are no longer signed out of active sessions when their account becomes locked.\n- Database backup/restore exception messages now redact the database password when using PostgreSQL.\n\n## 3.1.6.1 - 2019-01-29\n\n### Fixed\n- Fixed an error that occurred when creating a Table field with a Date column. ([#3748](https://github.com/craftcms/cms/issues/3748))\n\n## 3.1.6 - 2019-01-29\n\n### Added\n- It\u2019s now possible to update disabled plugins.\n\n### Changed\n- `craft\\web\\Controller::requireAdmin()` now sends a 403 (Forbidden) response if the `allowAdminChanges` config setting has been set to `false`. ([#3728](https://github.com/craftcms/cms/issues/3728))\n- `craft\\helpers\\DateTimeHelper::toDateTime()` now supports passing an array with a `date` key set to the `YYYY-MM-DD` format, in addition to the current locale\u2019s short date format.\n- `craft\\helpers\\DateTimeHelper::toDateTime()` now supports passing an array with a `time` key set to the `HH:MM` format, in addition to the current locale\u2019s short time format.\n- `craft\\helpers\\DateTimeHelper::toDateTime()` now supports passing an array with a `datetime` key, which will be handled the same way strings passed to the method are handled (except that the `datetime` key can be paired with a `timezone` key).\n\n### Fixed\n- Fixed an error that occurred when using the `json_decode` filter. ([#3722](https://github.com/craftcms/cms/pull/3722))\n- Fixed a bug a bug where plugin screenshots in the Plugin Store were not rendering correctly. ([#3709](https://github.com/craftcms/cms/issues/3709))\n- Fixed an error where the `index-assets/one` and `index-assets/all` console commands were creating `.` folders in each volume.\n- Fixed a bug where the Settings \u2192 Plugins page was showing extra \u201cMissing\u201d rows for any unlicensed plugins that were Composer-installed but not Craft-installed. ([#3726](https://github.com/craftcms/cms/issues/3726))\n- Fixed an error that could occur when viewing trashed elements.\n- Fixed a bug where many system message translations were missing line breaks. ([#3737](https://github.com/craftcms/cms/issues/3737))\n- Fixed a bug where unparsed markdown code was present in the Control Panel error message displayed when the system was offline. ([#3746](https://github.com/craftcms/cms/issues/3746))\n\n## 3.1.5 - 2019-01-25\n\n### Changed\n- Control Panel settings that can be set to environment variables now show a tip about that if the value is not already set to an environment variable or alias.\n- Control Panel form fields can now be configured with a `tip` property, which will be displayed below the field.\n- Control Panel templates can now pass `suggestEnvVars: true` and `suggestAliases: true` to autosuggest fields, rather that supplying the `suggestions` array.\n\n### Fixed\n- Fixed a bug where the \u201cDuplicate\u201d action wasn\u2019t available on the Entries index page for non-admin users. ([#3705](https://github.com/craftcms/cms/issues/3705))\n- Fixed a bug where it wasn\u2019t possible to rename an asset\u2019s filename from the Assets index page. ([#3707](https://github.com/craftcms/cms/issues/3707))\n- Fixed an error that occurred when saving a user that had a first or last name set.\n- Fixed a bug where it wasn\u2019t possible to apply project config changes. ([#3713](https://github.com/craftcms/cms/issues/3713))\n- Fixed a bug where the Password field on SMTP and Gmail mail transport settings could be set to an encoded and encrypted password. ([#3699](https://github.com/craftcms/cms/issues/3699))\n- Fixed a bug where it was possible to remove the Primary Site status from the primary site, without offering a new primary site. ([#3720](https://github.com/craftcms/cms/issues/3720))\n- Fixed an error that could occur if PHP\u2019s `memory_limit` was set to a higher size (in bytes) than `PHP_INT_MAX`. ([#3717](https://github.com/craftcms/cms/issues/3717))\n\n### Security\n- Control Panel settings that can be set to an alias now show a warning if the current value begins with the `@web` alias.\n\n## 3.1.4 - 2019-01-24\n\n### Added\n- Added all the things that came in [Craft 3.0.38](https://github.com/craftcms/cms/blob/master/CHANGELOG-v3.md#3038---2019-01-24).\n- The System Name setting can now be set to an environment variable. ([#3529](https://github.com/craftcms/cms/issues/3529))\n- Added the `index-assets/one` console command, which can now be used to index a single subfolder.\n- Added `craft\\base\\ApplicationTrait::getSystemName()`.\n\n### Changed\n- Craft now ensures that installed schema versions match the schema versions in `project.yaml` before syncing project config changes.\n- The `project-config/sync` console command now bails if there are pending Craft or plugin migrations.\n\n### Fixed\n- Fixed a bug where `site` translations were falling back to English if the translated message was identical to the source message. ([#3692](https://github.com/craftcms/cms/issues/3692))\n- Fixed a bug where syncing Matrix field changes to the project config would result in new changes to the project config. ([#3695](https://github.com/craftcms/cms/issues/3695))\n- Fixed an error that occurred when indexing assets in an empty volume.\n- Fixed a bug where soft-deleted assets would show up as missing after indexing.\n- Fixed a JavaScript error that could occur on the Settings \u2192 Plugins page.\n- Fixed a bug where `Craft::parseEnv()` was throwing an `InvalidConfigException` if the given string began with `@` but was not an alias. ([#3700](https://github.com/craftcms/cms/issues/3700))\n\n### Security\n- URLs are no longer allowed in users\u2019 first or last names.\n\n## 3.1.3 - 2019-01-21\n\n### Added\n- Added the `|json_decode` Twig filter.  ([#3678](https://github.com/craftcms/cms/pull/3678))\n\n### Fixed\n- Fixed an error that occurred when updating to Craft 3.1 if a plugin or module was calling any soft-deletable records\u2019 `find()` methods.\n- Fixed an error that occurred when updating from Craft 2 to Craft 3.1 if there were any RichText fields. ([#3677](https://github.com/craftcms/cms/issues/3677))\n- Fixed a bug where it was possible to create duplicate tags by searching for and selecting the same tag name twice in the same Tags field. ([#3676](https://github.com/craftcms/cms/issues/3676))\n- Fixed a bug where system messages were getting sent with the message keys (e.g. \u201cforgot_password_subject\u201d and \u201cforgot_password_body\u201d) if Craft didn\u2019t provide a default message translation for the site language, and the message hadn\u2019t been translated for the user\u2019s preferred language. ([#3673](https://github.com/craftcms/cms/issues/3673))\n- Fixed a bug where `craft\\web\\Request::getIsLivePreview()` was returning `false` on Live Preview requests when called from an `yii\\base\\Controller::EVENT_BEFORE_ACTION` event handler. ([#3680](https://github.com/craftcms/cms/issues/3680))\n\n## 3.1.2.2 - 2019-01-19\n\n### Fixed\n- Fixed an error that occurred when updating to Craft 3.1 if a plugin or module was calling any `craft\\services\\Sections` methods.\n\n## 3.1.2.1 - 2019-01-19\n\n### Fixed\n- Fixed an error that occurred when updating to Craft 3.1 if there were any Matrix sub-fields that had their type set to a non-existing class. ([#3662](https://github.com/craftcms/cms/issues/3662))\n- Fixed a bug where the project config could be in an unexpected state if a `project.yaml` file existed already when initially updating to Craft 3.1.\n\n## 3.1.2 - 2019-01-18\n\n### Added\n- Added the `index-assets <volume>` and `index-assets/all` console commands. ([#3595](https://github.com/craftcms/cms/pull/3595))\n- Added `craft\\base\\FieldTrait::$oldSettings`.\n- Added `craft\\helpers\\Install`.\n- Added `craft\\services\\Fields::prepFieldForSave()`.\n- Added `craft\\services\\Path::getProjectConfigFilePath()`.\n- Added `craft\\services\\ProjectConfig::$muteEvents`.\n\n### Changed\n- The installer now checks `project.yaml` when determining the default site name, handle, base URL, and language values. ([#3661](https://github.com/craftcms/cms/issues/3661))\n- The Base URL field in the web-based installer now autouggests environment variable names and aliases.\n- Craft now creates a `.gitignore` file in the `storage/config-backups/` folder, preventing any other files within it from getting tracked by Git.\n- Craft no longer prevents changes in `project.yaml` from being synced if a plugins\u2019 schema version in `project.yaml` doesn\u2019t match up with its installed schema version, if one of them is blank.\n\n### Deprecated\n- Deprecated `craft\\services\\Fields::$ignoreProjectConfigChanges`.\n- Deprecated `craft\\services\\Matrix::$ignoreProjectConfigChanges`.\n\n### Fixed\n- Fixed a PHP notice that occurred when updating to Craft 3.1 if there were any plugins installed without settings.\n- Fixed a SQL error that occurred when updating to Craft 3.1 if a plugin or module was calling any `craft\\services\\Fields` methods. ([#3663](https://github.com/craftcms/cms/issues/3663))\n- Fixed a bug where element indexes would forget their source settings after updating to Craft 3.1. ([#3659](https://github.com/craftcms/cms/issues/3659))\n- Fixed a bug where commercial plugins weren\u2019t installable from the Plugin Store.\n- Fixed a bug where Matrix block type fields\u2019 `beforeSave()` methods weren\u2019t getting called.\n- Fixed a bug where Matrix fields could forget their content table name if they were created with a non-global context.\n- Fixed a bug where links to the Plugin Store from Settings \u2192 Plugins were 404ing. ([#3664](https://github.com/craftcms/cms/issues/3664))\n- Fixed a bug where soft-deleted sections and entry types were still showing up in the Control Panel. ([#3648](https://github.com/craftcms/cms/issues/3648))\n- Fixed a bug where an update to Craft 3.1 would fail with a database error in some scenarios.\n- Fixed a bug where Plugin Store\u2019s Try buttons would appear as disabled when they should be enabled. ([#3619](https://github.com/craftcms/cms/issues/3619))\n- Fixed an error that occurred when updating to Craft 3.1 if there were any relational fields that were missing some expected settings. ([#3641](https://github.com/craftcms/cms/issues/3641))\n\n### Security\n- Fixed two XSS vulnerabilities.\n\n## 3.1.1 - 2019-01-16\n\n### Added\n- Added support for the `CRAFT_LOG_PHP_ERRORS` PHP constant. ([#3619](https://github.com/craftcms/cms/issues/3619))\n- Added `craft\\web\\User::generateToken()`.\n\n### Changed\n- System error message templates no longer parse exception messages as Markdown.\n\n### Fixed\n- Fixed a bug where `craft\\services\\Volumes::getVolumeByHandle()` wasn\u2019t working. ([#3633](https://github.com/craftcms/cms/pull/3633))\n- Fixed a bug where the `clear-caches/cp-resources` command could clear out the wrong directory if the `resourceBasePath` config setting began with `@webroot`. ([#3637](https://github.com/craftcms/cms/issues/3637))\n- Fixed a bug where eager-loading Matrix blocks would come up empty. ([#3644](https://github.com/craftcms/cms/issues/3644))\n- Fixed an error that occurred when updating to Craft 3.1 if there were any Matrix blocks without any sub-fields. ([#3635](https://github.com/craftcms/cms/pull/3635))\n- Fixed an error that occurred when updating to Craft 3.1 if there were any Matrix block types left over from a Matrix field that had been converted to something else.\n- Fixed an error that occurred when updating to Craft 3.1 if there were any Assets fields that were missing some expected field settings. ([#3641](https://github.com/craftcms/cms/issues/3641))\n- Fixed an error that occurred when updating to Craft 3.1 if anything was calling `craft\\services\\Fields::getLayoutById()` or `getLayoutByType()` before the update was applied.\n- Fixed an error that could occur when logging deprecation errors on PostgreSQL. ([#3638](https://github.com/craftcms/cms/issues/3638))\n- Fixed a bug where users would get logged out while updating to Craft 3.1, causing a \u201cUser is not permitted to perform this action\u201d error.\n- Fixed a bug where \u201cJavaScript must be enabled\u201d and \u201cCookies must be enabled\u201d messages weren\u2019t getting positioned correctly. ([#3639](https://github.com/craftcms/cms/issues/3639))\n- Fixed a \u201cVariable \"message\" does not exist.\u201d error that could occur in the Control Panel.\n- Fixed a bug where free plugins weren\u2019t installable from the Plugin Store. ([#3642](https://github.com/craftcms/cms/issues/3642))\n\n### Security\n- The Request panel in the Debug Toolbar now redacts any sensitive information. ([#3619](https://github.com/craftcms/cms/issues/3619))\n- Fixed two XSS vulnerabilities.\n\n## 3.1.0 - 2019-01-15\n\n> {warning} This is a more complex update than usual, and failed update attempts are not uncommon. Please ensure you have a recent database backup, and we recommend you test the update on a local/staging environment before updating your production server.\n\n### Added\n- Added the Project Config, a portable and centralized configuration for system settings. ([#1429](https://github.com/craftcms/cms/issues/1429)) \n- Category groups, elements, entry types, field layouts, global sets, sections, sites, site groups, structures, tag groups, and volumes are now soft-deleted. ([#867](https://github.com/craftcms/cms/issues/867))\n- Entries, categories, and users can now be restored within the Control Panel by selecting \u201cTrashed\u201d from the status menu on element index pages, and clicking the \u201cRestore\u201d button.\n- Added the System Messages utility for editing system messages, replacing the Settings \u2192 Email \u2192 System Messages page. ([#3421](https://github.com/craftcms/cms/issues/3421))\n- Some Site settings (Base URL), volume settings (Base URL and File System Path), and email settings (System Email Address, Sender Name, HTML Email Template, Username, Password, and Host Name) can now be set to environment variables using a `$VARIABLE_NAME` syntax. ([#3219](https://github.com/craftcms/cms/issues/3219))\n- The installer now checks whether a `project.yaml` file exists and applies any changes in it. ([#3291](https://github.com/craftcms/cms/issues/3291))\n- Control Panel settings that support environment variables now autosuggest environment variable names (and aliases when applicable) while typing.\n- Control Panel settings that define a template path now autosuggest existing template files.\n- Added cross-domain support for Live Preview. ([#1521](https://github.com/craftcms/cms/issues/1521))\n- Plugins can now have multiple editions.\n- Custom fields can now opt out of being included in elements\u2019 search keywords. ([#2600](https://github.com/craftcms/cms/issues/2600))\n- Added the `allowAdminChanges` config setting.\n- Added the `softDeleteDuration` config setting.\n- Added the `storeUserIps` config setting. ([#3311](https://github.com/craftcms/cms/issues/3311))\n- Added the `useProjectConfigFile` config setting.\n- Added the `gc` console command, which can be used to run garbage collection tasks.\n- Added the `project-config/sync` console command. ([#3510](https://github.com/craftcms/cms/issues/3510))\n- Added the `trashed` element query param, which can be used to query for elements that have been soft-deleted.\n- Added the `expression()` Twig function, for creating new `yii\\db\\Expression` objects in templates. ([#3289](https://github.com/craftcms/cms/pull/3289))\n- Added the `parseEnv()` Twig function.\n- Added the `plugin()` Twig function.\n- Added the `_includes/forms/autosuggest.html` include template for the Control Panel. \n- Added `Craft::parseEnv()`.\n- Added `craft\\base\\ApplicationTrait::getIsLive()`.\n- Added `craft\\base\\Element::EVENT_AFTER_RESTORE`.\n- Added `craft\\base\\Element::EVENT_BEFORE_RESTORE`.\n- Added `craft\\base\\Element::EVENT_DEFINE_EAGER_LOADING_MAP`.\n- Added `craft\\base\\ElementInterface::afterRestore()`.\n- Added `craft\\base\\ElementInterface::beforeRestore()`.\n- Added `craft\\base\\Field::EVENT_AFTER_ELEMENT_RESTORE`.\n- Added `craft\\base\\Field::EVENT_BEFORE_ELEMENT_RESTORE`.\n- Added `craft\\base\\FieldInterface::afterElementRestore()`.\n- Added `craft\\base\\FieldInterface::beforeElementRestore()`.\n- Added `craft\\base\\Model::EVENT_DEFINE_RULES`.\n- Added `craft\\base\\Plugin::editions()`.\n- Added `craft\\base\\Plugin::is()`.\n- Added `craft\\base\\SavableComponentInterface::beforeApplyDelete()`.\n- Added `craft\\behaviors\\EnvAttributeParserBehavior`.\n- Added `craft\\controllers\\LivePreviewController`.\n- Added `craft\\db\\ActiveRecord::prepareForDb()`.\n- Added `craft\\db\\Command::restore()`.\n- Added `craft\\db\\Command::softDelete()`.\n- Added `craft\\db\\Migration::restore()`.\n- Added `craft\\db\\Migration::softDelete()`.\n- Added `craft\\db\\SoftDeleteTrait`, which can be used by Active Record classes that wish to support soft deletes.\n- Added `craft\\db\\Table`.\n- Added `craft\\elements\\actions\\Restore`, which can be included in elements\u2019 `defineActions()` methods to opt into element restoration.\n- Added `craft\\events\\ConfigEvent`.\n- Added `craft\\events\\DeleteElementEvent`, which provides a `$hardDelete` property that can be set to `true` to force an element to be immediately hard-deleted. ([#3403](https://github.com/craftcms/cms/pull/3403))\n- Added `craft\\helpers\\App::editionHandle()`.\n- Added `craft\\helpers\\App::editionIdByHandle()`.\n- Added `craft\\helpers\\App::mailSettings()`.\n- Added `craft\\helpers\\ArrayHelper::firstWhere()`.\n- Added `craft\\helpers\\Db::idByUid()`.\n- Added `craft\\helpers\\Db::idsByUids()`.\n- Added `craft\\helpers\\Db::uidById()`.\n- Added `craft\\helpers\\Db::uidsByIds()`.\n- Added `craft\\helpers\\ProjectConfig`.\n- Added `craft\\helpers\\StringHelper::toWords()`.\n- Added `craft\\models\\FieldLayout::createFromConfig()`.\n- Added `craft\\models\\FieldLayout::getConfig()`.\n- Added `craft\\models\\Section::setEntryTypes()`.\n- Added `craft\\models\\Site::getBaseUrl()`.\n- Added `craft\\services\\AssetTransforms::getTransformByUid()`.\n- Added `craft\\services\\AssetTransforms::EVENT_BEFORE_APPLY_TRANSFORM_DELETE`.\n- Added `craft\\services\\Categories::getGroupByUid()`.\n- Added `craft\\services\\Categories::EVENT_BEFORE_APPLY_GROUP_DELETE`.\n- Added `craft\\services\\Elements::restoreElement()`.\n- Added `craft\\services\\Elements::EVENT_AFTER_RESTORE_ELEMENT`.\n- Added `craft\\services\\Elements::EVENT_BEFORE_RESTORE_ELEMENT`.\n- Added `craft\\services\\Fields::applyFieldDelete()`.\n- Added `craft\\services\\Fields::applyFieldSave()`.\n- Added `craft\\services\\Fields::createFieldConfig()`.\n- Added `craft\\services\\Fields::deleteFieldInternal()`.\n- Added `craft\\services\\Fields::restoreLayoutById()`.\n- Added `craft\\services\\Fields::saveFieldInternal()`.\n- Added `craft\\services\\Fields::EVENT_BEFORE_APPLY_FIELD_DELETE`.\n- Added `craft\\services\\Fields::EVENT_BEFORE_APPLY_GROUP_DELETE`.\n- Added `craft\\services\\Gc` for handling garbage collection tasks.\n- Added `craft\\services\\Path::getConfigBackupPath()`.\n- Added `craft\\services\\ProjectConfig`.\n- Added `craft\\services\\Routes::deleteRouteByUid()`\n- Added `craft\\services\\Sections::getSectionByUid()`.\n- Added `craft\\services\\Sections::EVENT_BEFORE_APPLY_ENTRY_TYPE_DELETE`.\n- Added `craft\\services\\Sections::EVENT_BEFORE_APPLY_SECTION_DELETE`.\n- Added `craft\\services\\Sites::restoreSiteById()`.\n- Added `craft\\services\\Sites::EVENT_BEFORE_APPLY_GROUP_DELETE`.\n- Added `craft\\services\\Sites::EVENT_BEFORE_APPLY_SITE_DELETE`.\n- Added `craft\\services\\Tags::EVENT_BEFORE_APPLY_GROUP_DELETE`.\n- Added `craft\\services\\UserGroups::EVENT_BEFORE_APPLY_GROUP_DELETE`.\n- Added `craft\\services\\Volumes::EVENT_BEFORE_APPLY_VOLUME_DELETE`.\n- Added `craft\\validators\\TemplateValidator`.\n- Added `craft\\web\\Controller::requireCpRequest()`.\n- Added `craft\\web\\Controller::requireSiteRequest()`.\n- Added `craft\\web\\twig\\variables\\Cp::EVENT_REGISTER_CP_SETTINGS`. ([#3314](https://github.com/craftcms/cms/issues/3314))\n- Added `craft\\web\\twig\\variables\\Cp::getEnvSuggestions()`.\n- Added `craft\\web\\twig\\variables\\Cp::getTemplateSuggestions()`.\n- Added the ActiveRecord Soft Delete Extension for Yii2.\n- Added the Symfony Yaml Component.\n- The bundled Vue asset bundle now includes Vue-autosuggest.\n\n### Changed\n- The `defaultWeekStartDay` config setting is now set to `1` (Monday) by default, to conform with the ISO 8601 standard.\n- Renamed the `isSystemOn` config setting to `isSystemLive`.\n- The `app/migrate` web action now applies pending `project.yaml` changes, if the `useProjectConfigFile` config setting is enabled.\n- The `svg()` function now strips `<title>`, `<desc>`, and comments from the SVG document as part of its sanitization process.\n- The `svg()` function now supports a `class` argument, which will add a class name to the root `<svg>` node. ([#3174](https://github.com/craftcms/cms/issues/3174))\n- The `{% redirect %}` tag now supports `with notice` and `with error` params for setting flash messages. ([#3625](https://github.com/craftcms/cms/pull/3625))\n- `info` buttons can now also have a `warning` class.\n- User permission definitions can now include `info` and/or `warning` keys.\n- The old \u201cAdministrate users\u201d permission has been renamed to \u201cModerate users\u201d.\n- The old \u201cChange users\u2019 emails\u201d permission has been renamed to \u201cAdministrate users\u201d, and now comes with the ability to activate user accounts and reset their passwords. ([#942](https://github.com/craftcms/cms/issues/942))  \n- All users now have the ability to delete their own user accounts. ([#3013](https://github.com/craftcms/cms/issues/3013))\n- System user permissions now reference things by their UIDs rather than IDs (e.g. `editEntries:<UID>` rather than `editEntries:<ID>`).\n- Animated GIF thumbnails are no longer animated. ([#3110](https://github.com/craftcms/cms/issues/3110))\n- Craft Tokens can now be sent either as a query string param (named after the `tokenParam` config setting) or an `X-Craft-Token` header.\n- Element types that support Live Preview must now hash the `previewAction` value for `Craft.LivePreview`.\n- Live Preview now loads each new preview into its own `<iframe>` element. ([#3366](https://github.com/craftcms/cms/issues/3366))\n- Assets\u2019 default titles now only capitalize the first word extracted from the filename, rather than all the words. ([#2339](https://github.com/craftcms/cms/issues/2339))\n- All console commands besides `setup/*` and `install/craft` now output a warning if Craft isn\u2019t installed yet. ([#3620](https://github.com/craftcms/cms/issues/3620))\n- All classes that extend `craft\\base\\Model` now have `EVENT_INIT` and `EVENT_DEFINE_BEHAVIORS` events; not just classes that extend `craft\\base\\Component`.\n- `craft\\db\\mysql\\Schema::findIndexes()` and `craft\\db\\pgsql\\Schema::findIndexes()` now return arrays with `columns` and `unique` keys.\n- `craft\\helpers\\ArrayHelper::filterByValue()` now defaults its `$value` argument to `true`.\n- `craft\\helpers\\MigrationHelper::doesIndexExist()` no longer has a `$foreignKey` argument, and now has an optional `$db` argument.\n- `craft\\mail\\Mailer::send()` now swallows any exceptions that are thrown when attempting to render the email HTML body, and sends the email as plain text only. ([#3443](https://github.com/craftcms/cms/issues/3443))\n- `craft\\mail\\Mailer::send()` now fires an `afterSend` event with `yii\\mail\\MailEvent::$isSuccessful` set to `false` if any exceptions were thrown when sending the email, and returns `false`. ([#3443](https://github.com/craftcms/cms/issues/3443))\n- `craft\\services\\Routes::saveRoute()` now expects site and route UIDs instead of IDs.\n- `craft\\services\\Routes::updateRouteOrder()` now expects route UIDs instead of IDs.\n- The `craft\\helpers\\Assets::EVENT_SET_FILENAME` event is now fired after sanitizing the filename.\n\n### Removed\n- Removed `craft\\elements\\User::authData()`.\n- Removed `craft\\fields\\Matrix::getOldContentTable()`.\n- Removed `craft\\services\\Routes::deleteRouteById()`\n\n### Deprecated\n- Deprecated `craft\\base\\ApplicationTrait::getIsSystemOn()`. `getIsLive()` should be used instead.\n- Deprecated `craft\\helpers\\MigrationHelper::dropAllIndexesOnTable()`.\n- Deprecated `craft\\helpers\\MigrationHelper::dropAllUniqueIndexesOnTable()`.\n- Deprecated `craft\\helpers\\MigrationHelper::dropIndex()`.\n- Deprecated `craft\\helpers\\MigrationHelper::restoreForeignKey()`.\n- Deprecated `craft\\helpers\\MigrationHelper::restoreIndex()`.\n- Deprecated `craft\\models\\Info::getEdition()`. `Craft::$app->getEdition()` should be used instead.\n- Deprecated `craft\\models\\Info::getName()`. `Craft::$app->projectConfig->get('system.name')` should be used instead.\n- Deprecated `craft\\models\\Info::getOn()`. `Craft::$app->getIsLive()` should be used instead.\n- Deprecated `craft\\models\\Info::getTimezone()`. `Craft::$app->getTimeZone()` should be used instead.\n- Deprecated `craft\\services\\Routes::getDbRoutes()`. `craft\\services\\Routes::getProjectConfigRoutes()` should be used instead.\n- Deprecated `craft\\services\\SystemSettings`. `craft\\services\\ProjectConfig` should be used instead.\n- Deprecated `craft\\validators\\UrlValidator::$allowAlias`. `craft\\behaviors\\EnvAttributeParserBehavior` should be used instead.\n\n### Fixed\n- Fixed a bug where the Dashboard could rapidly switch between two column sizes at certain browser sizes. ([#2438](https://github.com/craftcms/cms/issues/2438))\n- Fixed a bug where ordered and unordered lists in field instructions didn\u2019t have numbers or bullets.\n- Fixed a bug where switching an entry\u2019s type could initially show the wrong field layout tab. ([#3600](https://github.com/craftcms/cms/issues/3600))\n- Fixed an error that occurred when updating to Craft 3 if there were any Rich Text fields without any stored settings.\n- Fixed a bug where Craft wasn\u2019t saving Dashboard widget sizes properly on PostgreSQL. ([#3609](https://github.com/craftcms/cms/issues/3609))\n- Fixed a PHP error that could occur if the primary site didn\u2019t have a base URL. ([#3624](https://github.com/craftcms/cms/issues/3624))\n- Fixed a bug where `craft\\helpers\\MigrationHelper::dropIndexIfExists()` wasn\u2019t working if the index had an unexpected name.\n- Fixed an error that could occur if a plugin attempted to register the same Twig extension twice in the same request.\n\n### Security\n- The web and CLI installers no longer suggest `@web` for the site URL, and now attempt to save the entered site URL as a `DEFAULT_SITE_URL` environment variable in `.env`. ([#3559](https://github.com/craftcms/cms/issues/3559))\n- Craft now destroys all other sessions associated with a user account when a user changes their password.\n- It\u2019s no longer possible to spoof Live Preview requests.\n\n## 3.0.41.1 - 2019-03-12\n\n### Changed\n- Craft now requires Twig 2.6.\n\n## 3.0.41 - 2019-02-22\n\n### Changed\n- System error message templates no longer parse exception messages as Markdown.\n\n### Security\n- Database backup/restore exception messages now redact the database password when using PostgreSQL.\n- URLs are no longer allowed in users\u2019 first or last names.\n- The Request panel in the Debug Toolbar now redacts any sensitive information. ([#3619](https://github.com/craftcms/cms/issues/3619))\n- Fixed XSS vulnerabilities.\n\n## 3.0.40.1 - 2019-02-21\n\n### Fixed\n- Fixed a bug where Craft wasn\u2019t always aware of plugin licensing issues. ([#3876](https://github.com/craftcms/cms/issues/3876))\n\n## 3.0.40 - 2019-01-31\n\n### Added\n- Added `craft\\helpers\\App::testIniSet()`.\n\n### Changed\n- Craft now warns if `ini_set()` is disabled and [memory_limit](http://php.net/manual/en/ini.core.php#ini.memory-limit) is less than `256M` or [max_execution_time](http://php.net/manual/en/info.configuration.php#ini.max-execution-time) is less than `120` before performing Composer operations.\n- `craft\\helpers\\App::maxPowerCaptain()` now attempts to set the `memory_limit` to `1536M` rather than `-1`.\n\n## 3.0.39 - 2019-01-29\n\n### Changed\n- It\u2019s now possible to update disabled plugins.\n\n### Fixed\n- Fixed an error that could occur if PHP\u2019s `memory_limit` was set to a higher size (in bytes) than `PHP_INT_MAX`. ([#3717](https://github.com/craftcms/cms/issues/3717))\n\n## 3.0.38 - 2019-01-24\n\n### Added\n- Added the `update` command, which can be used to [update Craft from the terminal](https://docs.craftcms.com/v3/updating.html#updating-from-the-terminal).\n- Craft now warns if PHP is running in Safe Mode with a [max_execution_time](http://php.net/manual/en/info.configuration.php#ini.max-execution-time) of less than 120 seconds, before performing Composer operations.\n- Craft now stores backups of `composer.json` and `composer.lock` files in `storage/composer-backups/` before running Composer operations.\n- Added `craft\\db\\Connection::getBackupFilePath()`.\n- Added `craft\\helpers\\App::phpConfigValueInBytes()`.\n- Added `craft\\helpers\\Console::isColorEnabled()`.\n- Added `craft\\helpers\\Console::outputCommand()`.\n- Added `craft\\helpers\\Console::outputWarning()`.\n- Added `craft\\helpers\\FileHelper::cycle()`.\n- Added `craft\\services\\Composer::$maxBackups`.\n- Added `craft\\services\\Path::getComposerBackupsPath()`.\n\n### Changed\n- The `migrate/all` console command now supports a `--no-content` argument that can be passed to ignore pending content migrations.\n- Craft now attempts to disable PHP\u2019s memory and time limits before running Composer operations.\n- Craft no longer respects the `phpMaxMemoryLimit` config setting if PHP\u2019s `memory_limit` setting is already set to `-1` (no limit).\n- Craft now respects Composer\u2019s [classmap-authoritative](https://getcomposer.org/doc/06-config.md#classmap-authoritative) config setting.\n- Craft now links to the [Troubleshooting Failed Updates](https://craftcms.com/guides/failed-updates) guide when an update fails.\n- `craft\\services\\Composer::install()` can now behave like the `composer install` command, if `$requirements` is `null`.\n- `craft\\services\\Composer::install()` now has a `$whitelist` argument, which can be set to an array of packages to whitelist, or `false` to disable the whitelist.\n\n## 3.0.37 - 2019-01-08\n\n### Added\n- Routes defined in the Control Panel can now have a `uid` token, and URL rules defined in `config/routes.php` can now have a `{uid}` token. ([#3583](https://github.com/craftcms/cms/pull/3583))\n- Added the `extraFileKinds` config setting. ([#1584](https://github.com/craftcms/cms/issues/1584))\n- Added the `clear-caches` console command. ([#3588](https://github.com/craftcms/cms/pull/3588))\n- Added `craft\\feeds\\Feeds::getFeed()`.\n- Added `craft\\helpers\\StringHelper::UUID_PATTERN`.\n\n### Changed\n- Pressing the <kbd>Return</kbd> key (or <kbd>Ctrl</kbd>/<kbd>Command</kbd> + <kbd>Return</kbd>) when a textual cell is focused in an editable table will now change the focus to the same cell in the next row (after creating a new row if necessary.) ([#3576](https://github.com/craftcms/cms/issues/3576))\n- The Password input in the web-based Craft setup wizard now has a \u201cShow\u201d button like other password inputs.\n- The Feed widget now sets the items\u2019 text direction based on the feed\u2019s language.\n- Matrix blocks that contain validation errors now have red titles and alert icons, to help them stand out when collapsed. ([#3599](https://github.com/craftcms/cms/issues/3599))\n\n### Fixed\n- Fixed a bug where the \u201cEdit\u201d button on asset editor HUDs didn\u2019t launch the Image Editor if the asset was being edited on another element type\u2019s index page. ([#3575](https://github.com/craftcms/cms/issues/3575))\n- Fixed an exception that would be thrown when saving a user from a front-end form with a non-empty `email` or `newPassword` param, if the `password` param was missing or empty. ([#3585](https://github.com/craftcms/cms/issues/3585))\n- Fixed a bug where global set, Matrix block, tag, and user queries weren\u2019t respecting `fixedOrder` params.\n- Fixed a bug where `craft\\helpers\\MigrationHelper::renameColumn()` was only restoring the last foreign key for each table that had multiple foreign keys referencing the table with the renamed column.\n- Fixed a bug where Date/Time fields could output the wrong date in Live Preview requests. ([#3594](https://github.com/craftcms/cms/issues/3594))\n- Fixed a few RTL language styling issues.\n- Fixed a bug where drap-and-drop uploading would not work for custom asset selector inputs. ([#3590](https://github.com/craftcms/cms/pull/3590))\n- Fixed a bug where Number fields weren\u2019t enforcing thein Min Value and Max Value settings if set to 0. ([#3598](https://github.com/craftcms/cms/issues/3598))\n- Fixed a SQL error that occurred when uploading assets with filenames that contained emoji characters, if using MySQL. ([#3601](https://github.com/craftcms/cms/issues/3601))\n\n### Security\n- Fixed a directory traversal vulnerability.\n- Fixed a remote code execution vulnerability.\n\n## 3.0.36 - 2018-12-18\n\n### Added\n- Added the `{{ actionInput() }}` global Twig function. ([#3566](https://github.com/craftcms/cms/issues/3566))\n\n### Changed\n- Suspended users are no longer shown when viewing pending or locked users. ([#3556](https://github.com/craftcms/cms/issues/3556))\n- The Control Panel\u2019s Composer installer now prevents scripts defined in `composer.json` from running. ([#3574](https://github.com/craftcms/cms/issues/3574))\n\n### Fixed\n- Fixed a bug where elements that belonged to more than one structure would be returned twice in element queries.\n\n### Security\n- Fixed a self-XSS vulnerability in the Recent Entries widget.\n- Fixed a self-XSS vulnerability in the Feed widget.\n\n## 3.0.35 - 2018-12-11\n\n### Added\n- Added `craft\\models\\Section::getHasMultiSiteEntries()`.\n\n### Changed\n- Field types that extend `craft\\fields\\BaseRelationField` now pass their `$sortable` property value to the `BaseElementSelectInput` JavaScript class by default. ([#3542](https://github.com/craftcms/cms/pull/3542))\n\n### Fixed\n- Fixed a bug where the \u201cDisabled for Site\u201d entry status option was visible for sections where site propagation was disabled. ([#3519](https://github.com/craftcms/cms/issues/3519))\n- Fixed a bug where saving an entry that was disabled for a site would retain its site status even if site propagation had been disabled for the section.\n- Fixed a SQL error that occurred when saving a field layout with 4-byte characters (like emojis) in a tab name. ([#3532](https://github.com/craftcms/cms/issues/3532))\n- Fixed a bug where autogenerated Post Date values could be a few hours off when saving new entries with validation errors. ([#3528](https://github.com/craftcms/cms/issues/3528))\n- Fixed a bug where plugins\u2019 minimum version requirements could be enforced even if a development version of a plugin had been installed previously.\n\n## 3.0.34 - 2018-12-04\n\n### Fixed\n- Fixed a bug where new Matrix blocks wouldn\u2019t remember that they were supposed to be collapsed if \u201cSave and continue editing\u201d was clicked. ([#3499](https://github.com/craftcms/cms/issues/3499))\n- Fixed an error that occurred on the System Report utility if any non-bootstrapped modules were configured with an array or callable rather than a string. ([#3507](https://github.com/craftcms/cms/issues/3507))\n- Fixed an error that occurred on pages with date or time inputs, if the user\u2019s preferred language was set to Arabic. ([#3509](https://github.com/craftcms/cms/issues/3509))\n- Fixed a bug where new entries within sections where site propagation was disabled would show both \u201cEnabled Globally\u201d and \u201cEnabled for [Site Name]\u201d settings. ([#3519](https://github.com/craftcms/cms/issues/3519))\n- Fixed a bug where Craft wasn\u2019t reducing the size of elements\u2019 slugs if the resulting URI was over 255 characters. ([#3514](https://github.com/craftcms/cms/issues/3514))\n\n## 3.0.33 - 2018-11-27\n\n### Changed\n- Table fields with a fixed number of rows no longer show Delete buttons or the \u201cAdd a row\u201d button. ([#3488](https://github.com/craftcms/cms/issues/3488))\n- Table fields that are fixed to a single row no longer show the Reorder button. ([#3488](https://github.com/craftcms/cms/issues/3488))\n- Setting `components.security.sensitiveKeywords` in `config/app.php` will now append keywords to the default array `craft\\services\\Security::$sensitiveKeywords` array, rather than completely overriding it.\n- When performing an action that requires an elevated session while impersonating another user, admin must now enter their own password instead of the impersonated user\u2019s. ([#3487](https://github.com/craftcms/cms/issues/3487))\n- The System Report utility now lists any custom modules that are installed. ([#3490](https://github.com/craftcms/cms/issues/3490))\n- Control Panel charts now give preference to `ar-SA` for Arabic locales, `de-DE` for German locales, `en-US` for English locales, `es-ES` for Spanish locales, or `fr-FR` for French locales, if data for the exact application locale doesn\u2019t exist. ([#3492](https://github.com/craftcms/cms/pull/3492))\n- \u201cCreate a new child entry\u201d and \u201cCreate a new child category\u201d element actions now open an edit page for the same site that was selected on the index page. ([#3496](https://github.com/craftcms/cms/issues/3496))\n- The default `allowedFileExtensions` config setting value now includes `webp`.\n- The Craft Support widget now sends `composer.json` and `composer.lock` files when contacting Craft Support.\n- It\u2019s now possible to create element select inputs that include a site selection menu by passing `showSiteMenu: true` when including the `_includes/forms/elementSelect.html` Control Panel include template. ([#3494](https://github.com/craftcms/cms/pull/3494))\n\n### Fixed\n- Fixed a bug where a Matrix fields\u2019 block types and content table could be deleted even if something set `$isValid` to `false` on the `beforeDelete` event.\n- Fixed a bug where a global sets\u2019 field layout could be deleted even if something set `$isValid` to `false` on the `beforeDelete` event.\n- Fixed a bug where after impersonating another user, the Login page would show the impersonated user\u2019s username rather than the admin\u2019s.\n- Fixed a bug where `craft\\services\\Sections::getAllSections()` could return stale results if a new section had been added recently. ([#3484](https://github.com/craftcms/cms/issues/3484))\n- Fixed a bug where \u201cView entry\u201d and \u201cView category\u201d element actions weren\u2019t available when viewing a specific section or category group.\n- Fixed a bug where Craft would attempt to index image transforms.\n- Fixed a bug where the Asset Indexes utility could report that asset files were missing even though they weren\u2019t. ([#3450](https://github.com/craftcms/cms/issues/3450))\n\n### Security\n- Updated jQuery File Upload to 9.28.0.\n\n## 3.0.32 - 2018-11-20\n\n### Added\n- The `seq()` Twig function now has a `next` argument, which can be set to `false` to have it return the current number in the sequence without incrementing it. ([#3466](https://github.com/craftcms/cms/issues/3466))\n- Added `craft\\db\\MigrationManager::truncateHistory()`.\n- Added `craft\\helpers\\Sequence::current()`.\n\n### Changed\n- Edit Entry pages now show the entry\u2019s site in the revision menu label so long as the section is enabled for multiple sites, even if \u201cPropagate entries across all enabled sites?\u201d isn\u2019t checked. ([#3471](https://github.com/craftcms/cms/issues/3471))\n- Exact-match search terms (using `::`) now disable `subLeft` and `subRight` attributes by default, regardless of the `defaultSearchTermOptions` config setting says. ([#3474](https://github.com/craftcms/cms/issues/3474))\n\n### Deprecated\n- Deprecated `craft\\validators\\StringValidator::$trim`. Yii\u2019s `'trim'` validator should be used instead.\n\n### Fixed\n- Fixed an error that occurred when querying for Matrix blocks if both the `with` and `indexBy` parameters were set.\n- Fixed an error that occurred when running the `migrate/fresh` console command. ([#3472](https://github.com/craftcms/cms/issues/3472))\n\n## 3.0.31 - 2018-11-13\n\n### Added\n- Added the `seq()` Twig function, for outputting sequential numbers.\n- Added `craft\\helpers\\Sequence`.\n\n### Changed\n- Control Panel templates can now customize `#main-form` HTML attributes by overriding the `mainFormAttributes` block. ([#1665](https://github.com/craftcms/cms/issues/1665))\n- The default PostgreSQL backup command no longer includes database owner, privilege or ACL information in the backup.\n- Craft now attempts to reset OPcache after installing/uninstalling things with Composer. ([#3460](https://github.com/craftcms/cms/issues/3460))\n- Gmail and SMTP mail transport types now trim whitespace off of their Username, Password, and Host Name settings. ([#3459](https://github.com/craftcms/cms/issues/3459))\n\n### Fixed\n- Fixed an error that could occur when duplicating an element with a Matrix field with \u201cManage blocks on a per-site basis\u201d disabled.\n- Fixed a bug where Matrix blocks wouldn\u2019t retain their content translations when an entry was duplicated from the Edit Entry page.\n- Fixed a bug where system message modals could have the wrong language selected by default. ([#3440](https://github.com/craftcms/cms/issues/3440))\n- Fixed a bug where an Internal Server Error would occur if a `users/login` request was missing the `loginName` or `password` parameters. ([#3458](https://github.com/craftcms/cms/issues/3458))\n- Fixed a bug where `craft\\validators\\StringValidator` was trimming whitespace off of strings _after_ performing string length validation.\n- Fixed an infinite recursion bug that could occur if `config/general.php` had any deprecated config settings, and the database connection settings were invalid.\n- Fixed an error that occurred when saving a new entry or category, if its URI format referenced the `level` attribute. ([#3465](https://github.com/craftcms/cms/issues/3465))\n\n## 3.0.30.2 - 2018-11-08\n\n### Fixed\n- Fixed an error that could occur on servers running PHP 7.0.32. ([#3453](https://github.com/craftcms/cms/issues/3453))\n\n## 3.0.30.1 - 2018-11-07\n\n### Fixed\n- Fixed an error that occurred when saving an element with a new Matrix block, if the Matrix field was set to manage blocks on a per-site basis. ([#3445](https://github.com/craftcms/cms/issues/3445))\n\n## 3.0.30 - 2018-11-06\n\n### Added\n- Added \u201cDuplicate\u201d and \u201cDuplicate (with children)\u201d actions to the Entries and Categories index pages. ([#1291](https://github.com/craftcms/cms/issues/1291))\n- Added `craft\\base\\ElementAction::$elementType`, which element action classes can use to reference their associated element type.\n- Added `craft\\elements\\actions\\DeepDuplicate`.\n- Added `craft\\elements\\actions\\Duplicate`.\n- Added `craft\\elements\\actions\\SetStatus::$allowDisabledForSite`, which can be used by localizable element types to enable a \u201cDisabled for Site\u201d status option.\n\n### Changed\n- Entries\u2019 \u201cEnabled\u201d setting is now labeled \u201cEnabled Globally\u201d on multi-site installs. ([#2899](https://github.com/craftcms/cms/issues/2899))\n- Entries\u2019 \u201cEnabled for site\u201d setting now includes the site name in its label, and only shows up if the \u201cEnabled Globally\u201d setting is checked. ([#2899](https://github.com/craftcms/cms/issues/2899))\n- The Set Status action on the Entries index page now includes a \u201cDisabled for Site\u201d option. ([#2899](https://github.com/craftcms/cms/issues/2899))\n- Edit Category pages now have `edit-category` and `site--<SiteHandle>` classes on the `<body>`. ([#3439](https://github.com/craftcms/cms/issues/3439))\n- Edit Entry pages now have `edit-entry` and `site--<SiteHandle>` classes on the `<body>`. ([#3439](https://github.com/craftcms/cms/issues/3439))\n- Edit Global Set pages now have `edit-global-set` and `site--<SiteHandle>` classes on the `<body>`. ([#3439](https://github.com/craftcms/cms/issues/3439))\n- Edit User pages now have an `edit-user` class on the `<body>`. ([#3439](https://github.com/craftcms/cms/issues/3439))\n\n### Fixed\n- Fixed a bug where the Edit User page could forget which permissions were selected when saving a user with validation errors, if the Username, First Name, and Last name fields were all blank. ([#3412](https://github.com/craftcms/cms/issues/3412))\n- Fixed a bug where the Edit User Group page could forget which permissions were selected when saving a user group with validation errors, if the Name field was blank.\n- Fixed a bug where the `{% paginate %}` tag wasn\u2019t factoring the `offset` element query param into its total page calculation. ([#3420](https://github.com/craftcms/cms/issues/3420))\n\n### Security\n- Fixed a bug where sensitive info could be displayed in the Craft log files if there was a problem connecting to the email server.\n\n## 3.0.29 - 2018-10-30\n\n### Added\n- Email and URL fields now have \u201cPlaceholder Text\u201d settings. ([#3397](https://github.com/craftcms/cms/issues/3397))\n\n### Changed\n- The default HTML Purifier configuration now allows `download` attributes in `<a>` tags. ([craftcms/redactor#86](https://github.com/craftcms/redactor/issues/86))\n\n### Fixed\n- Fixed a bug where the `ContentBehaviour` and `ElementQueryBehavior` classes could be missing some field properties. ([#3400](https://github.com/craftcms/cms/issues/3400))\n- Fixed a bug where some fields within Matrix fields could lose their values after enabling the \u201cManage blocks on a per-site basis\u201d setting. ([verbb/super-table#203](https://github.com/verbb/super-table/issues/203))\n- Fixed a bug where HTML Purifier wasn\u2019t being initialized with HTML 5 element support.\n- Fixed a bug where it was possible to save Assets fields with the \u201cRestrict allowed file types?\u201d setting enabled, but no specific file types selected. ([#3410](https://github.com/craftcms/cms/issues/3410))\n\n## 3.0.28 - 2018-10-23\n\n### Added\n- Structure sections now have the ability to disable entry propagation, like Channel sections. ([#2386](https://github.com/craftcms/cms/issues/2386))\n\n### Changed\n- `craft\\base\\Field::supportedTranslationMethods()` now defaults to only returning `none` if the field type doesn\u2019t have a content column. ([#3385](https://github.com/craftcms/cms/issues/3385))\n- Craft.EntryTypeSwitcher now fires a `beforeTypeChange` event before swapping the Edit Entry form tabs. ([#3375](https://github.com/craftcms/cms/pull/3375))\n- Craft.MatrixInput now fires an `afterInit` event after initialization. ([#3375](https://github.com/craftcms/cms/pull/3375))\n- Craft.MatrixInput now fires an `blockAdded` event after adding a new block. ([#3375](https://github.com/craftcms/cms/pull/3375))\n- System messages sent from front-end requests are now sent using the current site\u2019s language. ([#3388](https://github.com/craftcms/cms/issues/3388))\n\n### Fixed\n- Fixed an error that could occur when acquiring a lock for a file path, if the `mutex` component was swapped out with `yii\\mutex\\MysqlMutex`.\n\n## 3.0.27.1 - 2018-10-12\n\n### Fixed\n- Fixed an error that occurred when deleting an entry from the Edit Entry page. ([#3372](https://github.com/craftcms/cms/issues/3372))\n- Fixed an error that could occur when changing a Channel section to Structure. ([#3373](https://github.com/craftcms/cms/issues/3373))\n- Fixed an error that occurred when saving Matrix content from console requests.\n\n## 3.0.27 - 2018-10-11\n\n### Added\n- Added `craft\\helpers\\MigrationHelper::findForeignKey()`.\n- Added the `cp.globals.edit` and `cp.globals.edit.content` template hooks to the Edit Global Set page. ([#3356](https://github.com/craftcms/cms/pull/3356))\n\n### Changed\n- It\u2019s now possible to load a Create Entry page with a specific user preselected in the Author field, using a new `authorId` query string param. ([#3326](https://github.com/craftcms/cms/pull/3326))\n- Matrix fields that are set to manage blocks on a per-site basis will now duplicate Matrix blocks across all of the owner element\u2019s supported sites when the element is first created. ([#3082](https://github.com/craftcms/cms/issues/3082))\n- Disabled Matrix blocks are no longer visible when sharing an entry draft or version. ([#3338](https://github.com/craftcms/cms/issues/3338))\n- Control Panel tabs that have errors now have alert icons.\n- The Debug Toolbar is no longer shown in Live Preview iframes.\n- The Plugin Store now requires browsers with ES6 support.\n- Updated jQuery Touch Events to 2.0.0.\n- Updated Garnish to 0.1.29.\n\n### Fixed\n- Fixed a bug where enabling the \u201cPropagate entries across all enabled sites?\u201d setting for an existing Channel section (or converting the section to a Structure) wouldn\u2019t update entries that had been created for the non-primary site.\n- Fixed a bug where Craft wasn\u2019t detecting and retrying queue jobs that had timed out.\n- Fixed a bug where `Craft::$app->locale` could return the wrong locale during Live Preview requests. ([#3336](https://github.com/craftcms/cms/issues/3336))\n- Fixed a SQL error that could occur when upgrading to Craft 3, if a foreign key had an unexpected name.\n- Fixed a bug where page titles in the Control Panel could be blank when showing validation errors for things that were missing their name or title. ([#3344](https://github.com/craftcms/cms/issues/3344))\n- Fixed an error that could occur if a component\u2019s settings were stored as `null`. ([#3342](https://github.com/craftcms/cms/pull/3342))\n- Fixed a bug where details panes weren\u2019t visible on browser windows sized between 999 and 1,223 pixels wide.\n- Fixed an error that occurred if a Quick Post widget contained a Matrix field that had Min Blocks set and only had one block type.\n- Fixed a bug where disabled Matrix blocks were getting validated as live. ([#3354](https://github.com/craftcms/cms/issues/3354))\n- Fixed a bug where the `EVENT_AFTER_ACTIVATE_USER` event wasn\u2019t getting triggered on user registration when email verification isn\u2019t required. ([craftcms/commerce-digital-products#18](https://github.com/craftcms/commerce-digital-products/issues/18))\n- Added garbage collection for offline storage of remote assets. ([#3335](https://github.com/craftcms/cms/pull/3335))\n- Fixed a bug where Twig could end up in a strange state if an error occurred when preparing to render an object template. ([#3364](https://github.com/craftcms/cms/issues/3364))\n\n### Security\n- The `svg()` Twig function no longer sanitizes SVGs or namespaces their IDs or class names by default when a file path (or alias) was passed in. ([#3337](https://github.com/craftcms/cms/issues/3337))\n\n## 3.0.26.1 - 2018-09-29\n\n### Changed\n- Changed the `yiisoft/yii2-queue` version requirement to `2.1.0`. ([#3332](https://github.com/craftcms/cms/issues/3332))\n\n## 3.0.26 - 2018-09-29\n\n### Changed\n- `ancestors`, `descendants`, `nextSibling`, `parent`, and `prevSibling` are now reserved field handles.\n- The `svg()` Twig function namespaces class names in addition to IDs now.\n- Changed the `yiisoft/yii2-queue` version requirement to `2.0.1`. ([#3332](https://github.com/craftcms/cms/issues/3332))\n\n### Fixed\n- Fixed a validation error that could occur when saving an entry as a new entry if the URI format didn\u2019t contain a `{slug}` tag. ([#3320](https://github.com/craftcms/cms/issues/3320))\n- Fixed a SQL error that could occur if a deprecation error occurred when attempting to upgrade a Craft 2 project. ([#3324](https://github.com/craftcms/cms/issues/3324))\n\n## 3.0.25 - 2018-09-18\n\n### Added\n- Added `craft\\log\\FileTarget::$includeUserIp` which determines whether users\u2019 IP addresses should be included in the logs (`false` by default). ([#3310](https://github.com/craftcms/cms/pull/3310))\n\n### Fixed\n- Fixed an error that could occur when installing or updating something within the Control Panel if `composer.json` required the `roave/security-advisories` package.\n- Fixed a SQL error that could occur when searching elements on PostgreSQL installs.\n- Fixed a bug where Craft would ignore the last segment of template paths that ended in `/0`. ([#3304](https://github.com/craftcms/cms/issues/3304))\n- Fixed a Twig Template Loading Error that would occur when testing email settings, if a custom email template was used and an error occurred when rendering it. ([#3309](https://github.com/craftcms/cms/issues/3309))\n\n## 3.0.24 - 2018-09-11\n\n### Added\n- Added the `extraAppLocales` config setting.\n\n### Changed\n- The `defaultCpLanguage` config setting no longer needs to be a language that Craft is translated into, as long as it is a valid locale ID.\n- Resave Elements jobs that are queued up after saving an entry type now include the section name in the job description. ([#3290](https://github.com/craftcms/cms/issues/3290))\n- Updated Garnish to 0.1.28.\n\n### Fixed\n- Fixed a SQL error that could occur when an element query\u2019s `orderBy` parameter was set to `dateCreated` or `dateUpdated`.\n- Fixed an error that could occur when updating to v3.0.23+ if multiple Matrix fields existed with the same handle, but they had no content tables, somehow.\n- Fixed a bug where links in activation and forgot-password emails weren\u2019t hyperlinked, leaving it up to the mail client to hopefully be smart about it. ([#3288](https://github.com/craftcms/cms/issues/3288))\n\n## 3.0.23.1 - 2018-09-04\n\n### Fixed\n- Fixed a bug where Matrix fields would get new content tables each time they were saved.\n\n## 3.0.23 - 2018-09-04\n\n### Changed\n- Browser-based form validation is now disabled for page forms. ([#3247](https://github.com/craftcms/cms/issues/3247))\n- `craft\\base\\Model::hasErrors()` now supports passing an attribute name with a `.*` suffix, which will return whether any errors exist for the given attribute or any nested model attributes.\n- Added `json` to the default `allowedFileExtensions` config setting value. ([#3254](https://github.com/craftcms/cms/issues/3254))\n- Exception call stacks now collapse internal Twig methods by default.\n- Twig exception call stacks now show all of the steps leading up to the error.\n- Live Preview now reloads the preview pane automatically after an asset is saved from the Image Editor. ([#3265](https://github.com/craftcms/cms/issues/3265))\n\n### Deprecated\n- Deprecated `craft\\services\\Matrix::getContentTableName()`. `craft\\fields\\Matrix::$contentTable` should be used instead.\n\n### Removed\n- Removed `craft\\services\\Matrix::getParentMatrixField()`.\n\n### Fixed\n- Fixed a bug where element selection modals could be initialized without a default source selected, if some of the sources were hidden for not being available on the currently-selected site. ([#3227](https://github.com/craftcms/cms/issues/3227))\n- Fixed a bug where edit pages for categories, entries, global sets, and users weren\u2019t revealing which tab(s) had errors on it, if the errors occurred within a Matrix field. ([#3248](https://github.com/craftcms/cms/issues/3248))\n- Fixed a SQL error that occurred when saving a Matrix field with new sub-fields on PostgreSQL. ([#3252](https://github.com/craftcms/cms/issues/3252))\n- Fixed a bug where custom user fields weren\u2019t showing up on the My Account page when running Craft Solo edition. ([#3228](https://github.com/craftcms/cms/issues/3228))\n- Fixed a bug where multiple Matrix fields could share the same content table. ([#3249]())\n- Fixed a \u201ccache is corrupted\u201d Twig error that could occur when editing or saving an element if it had an Assets field with an unresolvable subfolder path template. ([#3257](https://github.com/craftcms/cms/issues/3257))\n- Fixed a bug where the Dev Mode indicator strip wasn\u2019t visible on Chrome/Windows when using a scaled display. ([#3259](https://github.com/craftcms/cms/issues/3259))\n- Fixed a SQL error that could occur when validating an attribute using `craft\\validators\\UniqueValidator`, if the target record\u2019s `find()` method joined in another table.\n\n## 3.0.22 - 2018-08-28\n\n### Changed\n- The \u201cDeleting stale template caches\u201d job now ensures all expired template caches have been deleted before it begins processing the caches.\n- Text inputs\u2019 `autocomplete` attributes now get set to `off` by default, and they will only not be added if explicitly set to `null`.\n- Improved the error response when Composer is unable to perform an update due to a dependency conflict.\n- Email fields in the Control Panel now have `type=\"email\"`.\n- `craft\\helpers\\Db::parseParam()` now has a `$caseInnensitive` argument, which can be set to `true` to force case-insensitive conditions on PostgreSQL installs.\n- `craft\\validators\\UniqueValidator` now has a `$caseInsensitive` property, which can be set to `true` to cause the unique validation to be case-insensitive on PostgreSQL installs.\n- The CLI setup wizard now detects common database connection errors that occur with MAMP, and automatically retests with adjusted settings.\n- The CLI setup wizard now detects common database authentication errors, and lets the user retry the username and password settings, skipping the others.\n- Updated Garnish to 0.1.27.\n\n### Fixed\n- Fixed a bug where Craft wasn\u2019t reverting `composer.json` to its original state if something went wrong when running a Composer update.\n- Fixed a bug where string casing functions in `craft\\helpers\\StringHelper` were adding extra hyphens to strings that came in as `Upper-Kebab-Case`.\n- Fixed a bug where unique validation for element URIs, usernames, and user email address was not case-insensitive on PostgreSQL installs.\n- Fixed a bug where element queries\u2019 `uri` params, and user queries\u2019 `firstName`, `lastName`, `username`, and `email` params, were not case-insensitive on PostgreSQL installs.\n- Fixed a bug where the CLI setup wizard was allowing empty database names.\n- Fixed a bug where it wasn\u2019t possible to clear template caches if template caching was disabled by the `enableTemplateCaching` config setting. ([#3229](https://github.com/craftcms/cms/issues/3229))\n- Fixed a bug where element index toolbars weren\u2019t staying fixed to the top of the content area when scrolling down the page. ([#3233](https://github.com/craftcms/cms/issues/3233))\n- Fixed an error that could occur when updating Craft if the system was reliant on the SSL certificate provided by the`composer/ca-bundle` package.\n\n## 3.0.21 - 2018-08-21\n\n### Added\n- Most element query parameters can now be set to `['not', 'X', 'Y']`, as a shortcut for `['and', 'not X', 'not Y']`.\n\n### Changed\n- The \u201cNew Password\u201d input on the My Account page now has a \u201cShow\u201d button, like other password inputs in the Control Panel.\n- Plugin settings pages now redirect to the Settings index page after save. ([#3216](https://github.com/craftcms/cms/issues/3216))\n- It\u2019s now possible to set [autofill detail tokens](https://html.spec.whatwg.org/multipage/form-control-infrastructure.html#autofill-detail-tokens) on the `autocomplete` variable when including the `_includes/forms/text.html` template (e.g. `'name'`).\n- Username and password inputs now have the correct `autocomplete` values, increasing the likelihood that tools like 1Password will handle the form correctly. ([#3207](https://github.com/craftcms/cms/issues/3207))\n\n### Fixed\n- Fixed a SQL error that occurred when saving a user if a `craft\\elements\\User::EVENT_BEFORE_SAVE` event listener was setting `$event->isValid = false`. ([#3206](https://github.com/craftcms/cms/issues/3206))\n- Fixed a bug where password inputs\u2019 jQuery data was getting erased when the \u201cShow\u201d button was clicked.\n- Fixed an error that could occur when upgrading to Craft 3. ([#3208](https://github.com/craftcms/cms/pull/3208))\n- Fixed a bug where non-image assets\u2019 file extension icons could bleed out of the preview area within asset editor HUDs. ([#3209](https://github.com/craftcms/cms/issues/3209))\n- Fixed a bug where Craft wasn\u2019t saving a new entry version when reverting an entry to a previous version. ([#3210](https://github.com/craftcms/cms/issues/3210))\n- Fixed an error that could occur when a Matrix block was saved by a queue job. ([#3217](https://github.com/craftcms/cms/pull/3217))\n\n### Security\n- External links in the Control Panel now set `rel=\"noopener\"`. ([#3201](https://github.com/craftcms/cms/issues/3201))\n\n## 3.0.20 - 2018-08-14\n\n### Added\n- Added `craft\\services\\Fields::refreshFields()`.\n\n### Fixed\n- Fixed a bug where `DateTime` model attributes were getting converted to ISO-8601 date strings for `craft\\web\\View::renderObjectTemplate()`. ([#3185](https://github.com/craftcms/cms/issues/3185))\n- Fixed a bug where timepicker menus had a higher z-index than session expiration modal shades. ([#3186](https://github.com/craftcms/cms/issues/3186))\n- Fixed a bug where users could not log in after upgrading to Craft 3, if there was a custom field named `owner`.\n- Fixed a bug where it was not possible to set non-integer values on asset queries\u2019 `width`, `height`, or `size` params. ([#3195](https://github.com/craftcms/cms/issues/3195))\n- Fixed a bug where all Asset folders were being initiated at once, resulting in performance issues.\n\n## 3.0.19 - 2018-08-07\n\n### Added\n- Added the `craft.query()` template function, for creating new database queries.\n- Added `craft\\services\\Structures::mutexTimeout`. ([#3148](https://github.com/craftcms/cms/issues/3148))\n- Added `craft\\services\\Api::getComposerWhitelist()`.\n\n### Removed\n- Removed `craft\\services\\Api::getOptimizedComposerRequirements()`.\n\n### Fixed\n- Craft\u2019s console commands now return the correct exit codes. ([#3175](https://github.com/craftcms/cms/issues/3175))\n- Fixed the appearance of checkboxes in IE11 on element index pages. ([#3177](https://github.com/craftcms/cms/issues/3177))\n- Fixed a bug where `composer.json` could end up with a bunch of extra dependencies in the `require` object after a failed update or plugin installation.\n- Fixed an error that could occur when viewing an entry revision, if it had a Matrix field and one of the sub-fields within the Matrix field had been deleted. ([#3183](https://github.com/craftcms/cms/issues/3183))\n- Fixed a bug where thumbnails weren\u2019t loading in relational fields when viewing an entry version.\n\n## 3.0.18 - 2018-07-31\n\n### Added\n- Added `craft\\helpers\\App::assetManagerConfig()`.\n- Added `craft\\helpers\\App::cacheConfig()`.\n- Added `craft\\helpers\\App::dbConfig()`.\n- Added `craft\\helpers\\App::mailerConfig()`.\n- Added `craft\\helpers\\App::mutexConfig()`.\n- Added `craft\\helpers\\App::logConfig()`.\n- Added `craft\\helpers\\App::sessionConfig()`.\n- Added `craft\\helpers\\App::userConfig()`.\n- Added `craft\\helpers\\App::viewConfig()`.\n- Added `craft\\helpers\\App::webRequestConfig()`.\n- Added `craft\\validators\\StringValidator::$trim`, which will cause leading/trailing whitespace to be stripped from model attributes.\n\n### Changed\n- User verification and password-reset emails now link them back to the same site they were on when the email was sent, if it was sent from a front-end request. ([#3029](https://github.com/craftcms/cms/issues/3029))\n- Dynamic app component configs are now defined by methods on `craft\\helpers\\App`, making it easier to modify them from `config/app.php`. ([#3152](https://github.com/craftcms/cms/issues/3152))\n- Structure operations now ensure that no other operations are being performed on the same structure, reducing the risk of corrupting the structure. ([#3148](https://github.com/craftcms/cms/issues/3148))\n- The `{% js %}` tag now supports the following position params: `at POS_HEAD`, `at POS_BEGIN`, `at POS_END`, `on POS_READY`, and `on POS_LOAD` (e.g. `{% js at POS_END %}`).\n- Craft once again checks for `X-Forwarded-For` headers when determining the user\u2019s IP. ([#3036](https://github.com/craftcms/cms/issues/3036))\n- Leading/trailing whitespace characters are now stripped from element titles on save. ([#3020](https://github.com/craftcms/cms/issues/3020))\n- Updated svg-sanitize to 0.9.\n\n### Deprecated\n- Deprecated `craft\\db\\Connection::createFromConfig()`. `craft\\helpers\\App::dbConfig()` should be used instead.\n- Deprecated `craft\\helpers\\MailerHelper::createMailer()`. `craft\\helpers\\App::mailerConfig()` should be used instead.\n\n### Fixed\n- Fixed a bug where collapsing structure elements would only hide up to 50 of their descendants.\n- Fixed a bug where Date/Time fields could lose their value if they were used in an entry type\u2019s Title Format, and the entry\u2019s site\u2019s language was different than the user\u2019s preferred language. ([#3151](https://github.com/craftcms/cms/issues/3151))\n- Fixed a bug where Dropdown fields could show an incorrect selected value in limited circumstances.\n- Fixed a bug where Dropdown fields on an element index view could show an incorrect selected value in limited circumstances.\n\n## 3.0.17.1 - 2018-07-24\n\n### Fixed\n- Really fixed a PHP error that could occur if the PHP\u2019s `set_time_limit()` was added to the php.ini `disable_functions` list.\n\n## 3.0.17 - 2018-07-24\n\n### Added\n- The Control Panel is now translated for Norwegian Nynorsk. ([#3135](https://github.com/craftcms/cms/pull/3135))\n- Added `craft\\elements\\db\\ElementQuery::anyStatus()`, which can be called when the default `status` and `enabledForSite` filters aren\u2019t desired. ([#3117](https://github.com/craftcms/cms/issues/3117))\n\n### Changed\n- The `addTrailingSlashesToUrls` config setting no longer applies to URLs that end with a segment that has a dot (`.`). ([#3123](https://github.com/craftcms/cms/issues/3123))\n- Craft now redirects install requests back to the Dashboard if it\u2019s already installed. ([#3143](https://github.com/craftcms/cms/issues/3143))\n\n### Fixed\n- Fixed a bug where the Settings \u2192 Email \u2192 System Messages page would show messages in the current application language rather than the primary site\u2019s language.\n- Fixed a bug where system message modals on the Settings \u2192 Email \u2192 System Messages page would initially show messages in the current application language rather than the primary site\u2019s language, even if the application language wasn\u2019t in use by any sites. ([#3115](https://github.com/craftcms/cms/issues/3115))\n- Fixed an error that could occur if `craft\\web\\View::registerAssetFlashes()` was called on a console request. ([#3124](https://github.com/craftcms/cms/issues/3124))\n- Fixed a PHP error that could occur if the PHP\u2019s `set_time_limit()` was added to the php.ini `disable_functions` list.\n- Fixed a bug where expanding a disabled element within a structure index view in the Control Panel wouldn\u2019t reveal any descendants. ([#3126](https://github.com/craftcms/cms/issues/3126))\n- Fixed a bug thumbnails weren\u2019t loading for element index rows that were revealed after expanding a parent element.\n- Fixed an error that occurred if an element\u2019s `getRoute()` method returned a string. ([#3128](https://github.com/craftcms/cms/issues/3128))\n- Fixed a bug where the `|without` filter wasn\u2019t working if an object was passed in. ([#3137](https://github.com/craftcms/cms/issues/3137))\n- Fixed a bug where users\u2019 Language preference would default to Deutsch if the current application language wasn\u2019t one of the available language options. ([#3142](https://github.com/craftcms/cms/issues/3142))\n\n## 3.0.16.1 - 2018-07-18\n\n### Fixed\n- Fixed a bug where the `orderBy` element query param wasn\u2019t being respected when used in conjunction with a `with` param to eager-load elements in a specific order. ([#3109](https://github.com/craftcms/cms/issues/3109))\n- Fixed a bug where underscores were getting removed from slugs. ([#3111](https://github.com/craftcms/cms/issues/3111))\n\n## 3.0.16 - 2018-07-17\n\n### Added\n- The progress bar on the Asset Indexes utility now shows how many files have been indexed, and how many there are in total. ([#2934](https://github.com/craftcms/cms/issues/2934))\n- Added `craft\\base\\PluginInterface::beforeSaveSettings()`.\n- Added `craft\\base\\PluginInterface::afterSaveSettings()`.\n- Added `craft\\base\\Plugin::EVENT_AFTER_SAVE_SETTINGS`.\n- Added `craft\\base\\Plugin::EVENT_BEFORE_SAVE_SETTINGS`.\n\n### Changed\n- Craft no longer relies on ImageMagick or GD to define the image formats that should be considered manipulatable. ([#2408](https://github.com/craftcms/cms/issues/2408))\n- Removed the `showBetaUpdates` config setting as it\u2019s no longer being used.\n- When uploading a file to an Assets field, Craft will automatically sort the file list to show the latest uploads first. ([#2812](https://github.com/craftcms/cms/issues/2812))\n- `dateCreated`, `dateUpdated`, `postDate`, `expiryDate`, `after`, and  `before` element query params can new be set to `DateTime` objects.\n- Matrix fields now auto-focus the first text input within newly-created Matrix blocks. ([#3104](https://github.com/craftcms/cms/issues/3104))\n- Updated Twig to 2.5.0.\n- Updated Garnish to 0.1.26.\n- Updated Selectize to 0.12.6.\n\n### Fixed\n- Fixed an error that could occur when sending emails to international domains if the Intl extension wasn\u2019t enabled.\n- Fixed an exception that was thrown if the `securityKey` config setting was changed and Craft was set to use either the SMTP or Gmail mailer transport type. ([#3083](https://github.com/craftcms/cms/issues/3083))\n- Fixed a bug where Asset view was not being refreshed in some cases after using Image Editor. ([#3035](https://github.com/craftcms/cms/issues/3035))\n- Fixed a bug where Craft wouldn\u2019t warn before leaving an edit page with unsaved changes, if Live Preview was active. ([#3092](https://github.com/craftcms/cms/issues/3092))\n- Fixed a bug where entries, categories, and global sets\u2019 `getCpEditUrl()` methods could omit the site handle on multi-site installs. ([#3089](https://github.com/craftcms/cms/issues/3089))\n- Fixed a JavaScript error that occurred when closing Live Preview. ([#3098](https://github.com/craftcms/cms/issues/3098))\n- Fixed a bug where Dashboard widgets could be spaced incorrectly if there was only one grid column. ([#3100](https://github.com/craftcms/cms/issues/3100))\n- Fixed a bug where modal windows with Field Layout Designers could cause the browser to crash. ([#3096](https://github.com/craftcms/cms/pull/3096))\n- Fixed a bug where `craft\\services\\Fields::getAllGroups()` and `getGroupById()` could return incorrect results. ([#3102](https://github.com/craftcms/cms/issues/3102))\n\n## 3.0.15 - 2018-07-09\n\n### Changed\n- It\u2019s now possible to fetch only non-admin users by setting `craft\\elements\\db\\UserQuery::$admin` to `false`.\n- `Craft.EntryTypeSwitcher` now triggers a `typeChange` event after switching the entry type. ([#3067](https://github.com/craftcms/cms/pull/3067))\n- Reduced the left and right padding in the Control Panel for screens less than 768 pixels wide. ([#3073](https://github.com/craftcms/cms/issues/3073))\n- Removed the `useXSendFile` config setting as it\u2019s no longer being used.\n- `craft\\helpers\\StringHelper::toKebabCase()`, `toCamelCase()`, `toPascalCase()`, and `toSnakeCase()` now treat camelCase\u2019d and PascalCale\u2019d strings as multiple words. ([#3090](https://github.com/craftcms/cms/issues/3090))\n\n### Fixed\n- Fixed a bug where\u00a0`craft\\i18n\\I18N::getPrimarySiteLocale()` and `getPrimarySiteLocaleId()` were returning locale info for the _first_ site, rather than the primary one. ([#3063](https://github.com/craftcms/cms/issues/3063))\n- Fixed a bug where element index pages were loading all elements in the view, rather than waiting for the user to scroll to the bottom of the page before loading the next batch. ([#3068](https://github.com/craftcms/cms/issues/3068))\n- Fixed a bug where sites listed in the Control Panel weren\u2019t always in the correct sort order. ([#3065](https://github.com/craftcms/cms/issues/3065))\n- Fixed an error that occurred when users attempted to create new entries within entry selector modals, for a section they didn\u2019t have permission to publish peer entries in. ([#3069](https://github.com/craftcms/cms/issues/3069))\n- Fixed a bug where the \u201cSave as a new asset\u201d button label wasn\u2019t getting translated in the Image Editor. ([#3070](https://github.com/craftcms/cms/pull/3070))\n- Fixed a bug where it was impossible to set the filename of assets when uploading them as data strings. ([#2973](https://github.com/craftcms/cms/issues/2973))\n- Fixed a bug where the Field Type menu\u2019s options within new Matrix block type settings weren\u2019t getting sorted alphabetically. ([#3072](https://github.com/craftcms/cms/issues/3072))\n- Fixed an exception that was thrown when testing email settings if the Template setting was invalid. ([#3074](https://github.com/craftcms/cms/issues/3074))\n- Fixed a bug where Dropdown fields\u2019 bottom margin could jump up a bit when an empty option was selected. ([#3075](https://github.com/craftcms/cms/issues/3075))\n- Fixed a bug where main content containers in the Control Panel could become too wide in Firefox. ([#3071](https://github.com/craftcms/cms/issues/3071))\n\n## 3.0.14 - 2018-07-03\n\n### Changed\n- `craft\\events\\SiteEvent` now has a `$oldPrimarySiteId` property, which will be set to the previous primary site ID (which may stil be the current site ID, if it didn\u2019t just change).\n- `craft\\helpers\\Search::normalizeKeywords()` now has a `$language` argument, which can be set if the character mappings should be pulled from a different language than the current app language.\n- `craft\\services\\Sites::getEditableSiteIds()` and `getEditableSites()` now return the same things as `getAllSiteIds()` and `getAllSites()` when there\u2019s only one site. ([#3049](https://github.com/craftcms/cms/issues/3049))\n\n### Fixed\n- Fixed a bug where user verification links could get mangled when emails were parsed as Markdown, if the verification code contained two or more underscores.\n- Fixed a bug where Craft was misinterpreting `X-Forwarded-For` headers as the user\u2019s IP instead of the server\u2019s IP. ([#3036](https://github.com/craftcms/cms/issues/3036))\n- Fixed a bug where Craft wasn\u2019t auto-scrolling the content container when dragging items near a window edge. ([#3048](https://github.com/craftcms/cms/issues/3048))\n- Fixed a PHP error that occurred when loading a Debug Toolbar panel on a page that contained serialized Checkboxes or Multi-Select field data. ([#3034](https://github.com/craftcms/cms/issues/3034))\n- Fixed a bug where elements\u2019 normalized search keywords weren\u2019t always using the correct language-specific character mappings. ([#3046](https://github.com/craftcms/cms/issues/3046))\n- Fixed a bug where the `<html lang>` attribute was hard-set to `en-US` rather than the current application language. ([#3053](https://github.com/craftcms/cms/pull/3053))\n- Fixed a PHP error that occurred when entering an invalid number into a Number field that was set to have decimal digits. ([#3059](https://github.com/craftcms/cms/issues/3059))\n\n### Security\n- Craft no longer shows the installer when it can\u2019t establish a database connection if Dev Mode isn\u2019t enabled.\n\n## 3.0.13.2 - 2018-06-27\n\n### Fixed\n- Fixed an error that occurred when deleting users from the Users index page.\n\n## 3.0.13.1 - 2018-06-26\n\n### Fixed\n- Fixed a bug where Delete User modals weren\u2019t showing the total number of entries that will be transferred/deleted.\n\n## 3.0.13 - 2018-06-26\n\n### Added\n- Craft now includes a summary of the content that will be transferred/deleted in Delete User modals. ([#875](https://github.com/craftcms/cms/issues/875))\n- `|date`, `|time`, and `|datetime` filters now support a `locale` argument, for specifying which locale\u2019s formatter should be doing the date/time formatting. ([#3006](https://github.com/craftcms/cms/issues/3006))\n- Added `craft\\base\\ApplicationTrait::getIsInitialized()`.\n- Added `craft\\base\\ClonefixTrait`.\n- Added `craft\\controllers\\AssetsController::actionThumb()`.\n- Added `craft\\controllers\\UsersController::actionUserContentSummary()`.\n- Added `craft\\controllers\\UsersController::EVENT_DEFINE_CONTENT_SUMMARY`.\n- Added `craft\\helpers\\App::backtrace()`.\n- Added `craft\\queue\\jobs\\PropagateElements`.\n- Added `craft\\services\\Elements::propagateElement()`.\n\n### Changed\n- Editable tables now submit an empty string when they have no rows.\n- Reduced the overhead when adding a new site by only resaving existing assets, categories, global sets, and tags once for the newly-created site, rather than for all sites.\n- Web-based queue workers now call `craft\\helpers\\App::maxPowerCaptain()` before running the queue. ([#3011](https://github.com/craftcms/cms/issues/3011))\n- The PHP Info utility no longer displays the original values for settings and only the current environment value. ([#2990](https://github.com/craftcms/cms/issues/2990))\n- Loosened up most of Craft\u2019s Composer dependency constraints.\n- Craft no longer publishes asset thumbnails to the `cpresources/` folder.\n- `attributes`, `error`, `errors`, and `scenario` are now reserved field handles. ([#3032](https://github.com/craftcms/cms/issues/3032))\n- Improved the look of Control Panel tabs.\n- `craft\\web\\UrlManager::createUrl()`, `createAbsoluteUrl()`, and `getMatchedElement()` now log warnings if they\u2019re called before Craft has been fully initialized. ([#3028](https://github.com/craftcms/cms/issues/3028))\n\n### Deprecated\n- Deprecated `craft\\controllers\\AssetsController::actionGenerateThumb()`.\n\n### Fixed\n- Fixed a bug where sidebar meta info on Edit User pages was bleeding over the edge of the page\u2019s content area.\n- Fixed a bug where Table fields wouldn\u2019t remember if they had no rows in their Default Values setting. ([#2979](https://github.com/craftcms/cms/issues/2979))\n- Fixed a bug where passing `timezone=false` to the `|date`, `|time`, and `|datetime` filters would not preserve the given date\u2019s time zone.\n- Fixed a bug where AM/PM strings in formatted dates weren\u2019t respecting the casing specified by the `A`/`a` character in the date format. ([#3007](https://github.com/craftcms/cms/issues/3007))\n- Fixed a bug you could get an invalid license warning in cases where web API calls returned a 500 response code.\n- Fixed a bug where cloning models and queries would lose any associated behaviors. ([#2857](https://github.com/craftcms/cms/issues/2857))\n- Fixed a bug where custom field params were getting forgotten when calling `getNext()` and `getPrev()`, if an element query object was passed in. ([#3019](https://github.com/craftcms/cms/issues/3019))\n- Fixed a bug where datepickers were getting scrollbars.\n- Fixed a bug where volumes\u2019 field layouts weren\u2019t getting deleted when volumes were deleted. ([#3022](https://github.com/craftcms/cms/pull/3022))\n- Fixed a bug where deleting a section or an entry type wouldn\u2019t delete any associated entries that didn\u2019t exist in the primary site. ([#3023](https://github.com/craftcms/cms/issues/3023))\n- Fixed a bug where the `svg()` Twig function could convert `id` attributes within the SVG contents to invalid IDs. ([#3025](https://github.com/craftcms/cms/issues/3025))\n- Fixed a bug where asset thumbnails wouldn\u2019t load reliably in the Control Panel on load-balanced environments. ([#3026](https://github.com/craftcms/cms/issues/3026))\n- Fixed a PHP error that could occur when validating Assets fields if a file was uploaded but no longer exists at the temp location. ([#3033](https://github.com/craftcms/cms/pull/3033))\n\n## 3.0.12 - 2018-06-18\n\n### Added\n- Added a `leaves` element query param that limits the selected elements to just the leaves in the structure (elements without children).\n- Added `craft\\helpers\\Db::deleteIfExists()`.\n- Added `craft\\services\\Categories::deleteGroup()`. ([#3000](https://github.com/craftcms/cms/pull/3000))\n- Added `craft\\services\\Tags::deleteTagGroup()`. ([#3000](https://github.com/craftcms/cms/pull/3000))\n- Added `craft\\services\\UserGroups::deleteGroup()`. ([#3000](https://github.com/craftcms/cms/pull/3000))\n\n### Changed\n- Improved Control Panel styling. ([#2883](https://github.com/craftcms/cms/issues/2883))\n\n### Removed\n- Removed `craft\\services\\Fields::updateFieldVersionAfterRequest()`.\n\n### Fixed\n- Fixed a caching bug where the Fields service could still think a field existed after it had been deleted. ([#2985](https://github.com/craftcms/cms/issues/2985))\n- Fixed a bug where Craft would not invalidate the dynamically-generated `craft\\behaviors\\ContentBehavior` and `craft\\behaviors\\ElementQueryBehavior` after saving/deleting a custom field, if the request didn\u2019t end normally. ([#2999](https://github.com/craftcms/cms/issues/2999))\n- Fixed a PHP error that could occur when saving entries with a URI format that contained certain Twig filters. ([#2995](https://github.com/craftcms/cms/issues/2995))\n- Fixed a bug where `{shorthand}` variables in templates rendered by `craft\\web\\View::renderObjectTemplate()` could end up referencing global variables, if the variable wasn\u2019t a property of the object. ([#3002](https://github.com/craftcms/cms/issues/3002))\n- Fixed a bug where the Find and Replace utility wasn\u2019t updating element titles. ([#2996](https://github.com/craftcms/cms/issues/2996))\n- Fixed some wonky behavior if one of the custom user profile tabs was called \u201cAccount\u201d. ([#2998](https://github.com/craftcms/cms/issues/2998))\n- Fixed a bug where dragging a folder on the Assets index page could have unexpected results. ([#2873](https://github.com/craftcms/cms/issues/2873))\n- Reduced the likelihood of SQL deadlock errors when saving elements. ([#3003](https://github.com/craftcms/cms/issues/3003))\n\n## 3.0.11 - 2018-06-12\n\n### Changed\n- Sort options defined by element types\u2019 `sortOptions()` / `defineSortOptions()` methods can now be specified as sub-arrays with `label`, `orderBy`, and `attribute` keys.\n- Entries and categories can now be sorted by their slugs.\n- The \u201cCache remote images?\u201d option in the Asset Indexes utility is now enabled by default. ([#2977](https://github.com/craftcms/cms/issues/2977))\n\n### Fixed\n- Fixed a bug where it was not possible to order search results by search score, if the element type didn\u2019t specify any sort options.\n- Fixed a bug where clicking on \u201cDate Created\u201d and \u201cDate Updated\u201d column headers on element indexes wouldn\u2019t update the sort order. ([#2975](https://github.com/craftcms/cms/issues/2975))\n- Fixed a bug where Edit Entry pages were listing more than the 10 most recent versions. ([#2976](https://github.com/craftcms/cms/issues/2976))\n- Fixed a SQL error that occurred when upgrading from Craft 2 to 3 via the terminal. ([#1347](https://github.com/craftcms/cms/issues/1347))\n- Fixed the alignment of expand/collapse toggles in asset index sidebars. ([#2981](https://github.com/craftcms/cms/issues/2981))\n\n## 3.0.10.3 - 2018-06-07\n\n### Fixed\n- Fixed a bug where the \u201cNew Entry\u201d menu on the Entries index page would not contain any options on single-site installs, running MySQL. ([#2961](https://github.com/craftcms/cms/issues/2961))\n- Fixed a bug where the `siteName` config setting wasn\u2019t working as expected when set to an array. ([#2968](https://github.com/craftcms/cms/issues/2968))\n\n## 3.0.10.2 - 2018-06-07\n\n### Changed\n- Improved the output of `craft\\helpers\\DateTimeHelper::humanDurationFromInterval()`.\n- Updated Garnish to 0.1.24.\n\n### Fixed\n- Fixed JavaScript errors that could occur in the Control Panel on pages with Ajax requests. ([#2966](https://github.com/craftcms/cms/issues/2966))\n- Fixed a bug where the \u201cNew Entry\u201d menu on the Entries index page would not contain any options on single-site installs. ([#2961](https://github.com/craftcms/cms/issues/2961))\n- Fixed a bug where JavaScript files registered with `craft\\web\\View::registerJsFile()` would be ignored if the `depends` option was set. ([#2965](https://github.com/craftcms/cms/issues/2965))\n\n## 3.0.10.1 - 2018-06-06\n\n### Fixed\n- Fixed a bug where Craft wasn\u2019t converting empty strings to `null` when saving data to non-textual columns.\n- Fixed a bug where Craft would show a Database Connection Error on Install requests, if it couldn\u2019t connect to the database.\n- Fixed a bug where Craft wasn\u2019t keeping track of element queries that were executed within `{% cache %}` tags. ([#2959](https://github.com/craftcms/cms/issues/2959))\n\n## 3.0.10 - 2018-06-05\n\n### Added\n- Added support for a `CRAFT_LICENSE_KEY` PHP constant, which can be set to the project\u2019s license key, taking precedence over the `license.key` file.\n- Added `craft\\helpers\\Stringy::getLangSpecificCharsArray()`.\n- Added `craft\\web\\View::setRegisteredAssetBundles()`.\n- Added `craft\\web\\View::setRegisteredJsFiles()`.\n\n### Changed\n- Generated site URLs now always include full host info, even if the base site URL is root/protocol-relative. ([#2919](https://github.com/craftcms/cms/issues/2919))\n- Variables passed into `craft\\web\\View::renderObjectTemplate()` can now be referenced using the shorthand syntax (e.g. `{foo}`).\n- `craft\\helpers\\StringHelper::asciiCharMap()` now has `$flat` and `$language` arguments.\n- Craft no longer saves new versions of entries when absolutely nothing changed about them in the save request. ([#2923](https://github.com/craftcms/cms/issues/2923))\n- Craft no longer enforces plugins\u2019 `minVersionRequired` settings if the currently-installed version begins with `\n- \n- dev-`.\n- Improved the performance of element queries when a lot of values were passed into a param, such as `id`, by using `IN()` and `NOT IN()` conditions when possible. ([#2937](https://github.com/craftcms/cms/pull/2937))\n- The Asset Indexes utility no longer skips files with leading underscores. ([#2943](https://github.com/craftcms/cms/issues/2943))\n- Updated Garnish to 0.1.23.\n\n### Deprecated\n- Deprecated the `customAsciiCharMappings` config setting. (Any corrections to ASCII char mappings should be submitted to [Stringy](https://github.com/danielstjules/Stringy).)\n\n### Fixed\n- Fixed a PHP error that could occur when `craft\\fields\\Number::normalizeValue()` was called without passing an `$element` argument. ([#2913](https://github.com/craftcms/cms/issues/2913))\n- Fixed a bug where it was not possible to fetch Matrix blocks with the `relatedTo` param if a specific custom field was specified.\n- Fixed a bug where `craft\\helpers\\UrlHelper::url()` and `siteUrl()` were not respecting the `$scheme` argument for site URLs.\n- Fixed a bug where `{id}` tags within element URI formats weren\u2019t getting parsed correctly on first save. ([#2922](https://github.com/craftcms/cms/issues/2922))\n- Fixed a bug where `craft\\helpers\\MigrationHelper::dropAllForeignKeysToTable()` wasn\u2019t working correctly. ([#2897](https://github.com/craftcms/cms/issues/2897))\n- Fixed a \u201cCraft is not defined\u201d JavaScript error that could occur on the Forgot Password page in the Control Panel and Dev Toolbar requests.\n- Fixed a bug where rotating the screen on iOS would change how the page was zoomed.\n- Fixed a bug where `craft\\helpers\\StringHelper::toAscii()` and the `Craft.asciiString()` JS method weren\u2019t using language-specific character replacements, or any custom replacements defined by the `customAsciiCharMappings` config setting.\n- Fixed a bug where the number `0` would not save in a Plain Text field.\n- Fixed a bug where Craft could pick the wrong current site if the primary site had a root-relative or protocol-relative URL, and another site didn\u2019t, but was otherwise an equal match.\n- Fixed a bug where Control Panel Ajax requests could cause some asset bundles and JavaScript files to be double-registered in the browser.\n- Fixed a bug where the \u201cNew entry\u201d menu on the Entries index page was including sections that weren\u2019t available in the selected site, and they weren\u2019t linking to Edit Entry pages for the selected site. ([#2925](https://github.com/craftcms/cms/issues/2925))\n- Fixed a bug where the `|date`, `|time`, and `|datetime` filters weren\u2019t respecting their `$timezone` arguments. ([#2926](https://github.com/craftcms/cms/issues/2926))\n- Fixed a bug where element queries weren\u2019t respecting the `asArray` param when calling `one()`. ([#2940](https://github.com/craftcms/cms/issues/2940))\n- Fixed a bug where the Asset Indexes utility wouldn\u2019t work as expected if all of a volume\u2019s assets had been deleted from the file system. ([#2955](https://github.com/craftcms/cms/issues/2955))\n- Fixed a SQL error that could occur when a `{% cache %}` tag had no body. ([#2953](https://github.com/craftcms/cms/issues/2953))\n\n## 3.0.9 - 2018-05-22\n\n### Added\n- Added a default plugin icon to plugins without an icon in the Plugin Store.\n- Added `craft\\helpers\\ArrayHelper::without()` and `withoutValue()`.\n- Added `craft\\base\\FieldInterface::modifyElementIndexQuery()`.\n- Added `craft\\elements\\db\\ElementQueryInterface::andWith()`.\n\n### Changed\n- Fixed a bug where Craft was checking the file system when determining if an asset was a GIF, when it should have just been checking the file extension.\n- `craft\\base\\Plugin` now sets the default `$controllerNamespace` value to the plugin class\u2019 namespace + `\\controllers` or `\\console\\controllers`, depending on whether it\u2019s a web or console request.\n- Improved the contrast of success and error notices in the Control Panel to meet WCAG AA requirements. ([#2885](https://github.com/craftcms/cms/issues/2885))\n- `fieldValue` is now a protected field handle. ([#2893](https://github.com/craftcms/cms/issues/2893))\n- Craft will no longer discard any preloaded elements when setting the `with` param on an element query, fixing a bug where disabled Matrix blocks could show up in Live Preview if any nested fields were getting eager-loaded. ([#1576](https://github.com/craftcms/cms/issues/1576))\n- Improved memory usage when using the `{% cache %}` tag. ([#2903](https://github.com/craftcms/cms/issues/2903))\n\n### Fixed\n- Fixed a bug where the Plugin Store was listing featured plugins (e.g. \u201cRecently Added\u201d) in alphabetical order rather than the API-defined order. ([pixelandtonic/craftnet#83](https://github.com/pixelandtonic/craftnet/issues/83))\n- Fixed a SQL error that occurred when programmatically saving a field layout, if the field\u2019s `required` property wasn\u2019t set.\n- Fixed a JavaScript error that could occur when multiple Assets fields were present on the same page.\n- Fixed an error that could occur when running the `setup` command on some environments.\n- Fixed a PHP error that could occur when calling `craft\\elements\\db\\ElementQuery::addOrderBy()` if `$columns` normalized to an empty array. ([#2896](https://github.com/craftcms/cms/issues/2896))\n- Fixed a bug where it wasn\u2019t possible to access custom field values on Matrix blocks via `matrixblock` reference tags.\n- Fixed a bug where relational fields with only disabled elements selected would get empty table cells on element indexes. ([#2910](https://github.com/craftcms/cms/issues/2910))\n\n## 3.0.8 - 2018-05-15\n\n### Added\n- Number fields now have a \u201cDefault Value\u201d setting. ([#927](https://github.com/craftcms/cms/issues/927))\n- Added the `preserveCmykColorspace` config setting, which can be set to `true` to prevent images\u2019 color spaces from getting converted to sRGB on environments running ImageMagick.\n\n### Changed\n- Error text is now orange instead of red. ([#2885](https://github.com/craftcms/cms/issues/2885))\n- Detail panes now have a lighter, more saturated background color.\n\n### Fixed\n- Fixed a bug where Craft\u2019s default MySQL backup command would not respect the `unixSocket` database config setting. ([#2794](https://github.com/craftcms/cms/issues/2794))\n- Fixed a bug where some SVG files were not recognized as SVG files.\n- Fixed a bug where Table fields could add the wrong number of default rows if the Min Rows setting was set, and the Default Values setting had something other than one row. ([#2864](https://github.com/craftcms/cms/issues/2864))\n- Fixed an error that could occur when parsing asset reference tags. ([craftcms/redactor#47](https://github.com/craftcms/redactor/issues/47))\n- Fixed a bug where \u201cTry\u201d and \u201cBuy\u201d buttons in the Plugin Store were visible when the `allowUpdates` config setting was disabled. ([#2781](https://github.com/craftcms/cms/issues/2781))\n- Fixed a bug where Number fields would forget their Min/Max Value settings if they were set to 0.\n- Fixed a bug where entry versions could be displayed in the wrong order if multiple versions had the same creation date. ([#2889](https://github.com/craftcms/cms/issues/2889))\n- Fixed an error that occurred when installing Craft on a domain with an active user session.\n- Fixed a bug where email verification links weren\u2019t working for publicly-registered users if the registration form contained a Password field and the default user group granted permission to access the Control Panel.\n\n### Security\n- Login errors for locked users now factor in whether the `preventUserEnumeration` config setting is enabled.\n\n## 3.0.7 - 2018-05-10\n\n### Added\n- Added the `transformGifs` config setting, which can be set to `false` to prevent GIFs from getting transformed or cleansed. ([#2845](https://github.com/craftcms/cms/issues/2845))\n- Added `craft\\helpers\\FileHelper::isGif()`.\n\n### Changed\n- Craft no longer logs warnings about missing translation files when Dev Mode isn\u2019t enabled. ([#1531](https://github.com/craftcms/cms/issues/1531))\n- Added `craft\\services\\Deprecator::$logTarget`. ([#2870](https://github.com/craftcms/cms/issues/2870))\n- `craft\\services\\Deprecator::log()` no longer returns anything.\n\n### Fixed\n- Fixed a bug where it was impossible to upload new assets to Assets fields using base64-encoded strings. ([#2855](https://github.com/craftcms/cms/issues/2855))\n- Fixed a bug where Assets fields would ignore all submitted asset IDs if any new assets were uploaded as well.\n- Fixed a bug where SVG files that were using single quotes instead of double quotes would not be recognized as SVGs.\n- Fixed a bug where translated versions of the \u201cIt looks like someone is currently performing a system update.\u201d message contained an HTML-encoded `<br/>` tag.\n- Fixed a bug where changing an entry\u2019s type could skip adding the new entry type\u2019s tabs, if the previous entry type didn\u2019t have any tabs. ([#2859](https://github.com/craftcms/cms/issues/2859))\n- Fixed warnings about missing SVG files that were logged by Control Panel requests.\n- Fixed a bug where the `|date` filter would ignore date formatting characters that don\u2019t have ICU counterparts. ([#2867](https://github.com/craftcms/cms/issues/2867))\n- Fixed a bug where the global `currentUser` Twig variable could be set to `null` and global sets and could be missing some custom field values when a user was logged-in, if a plugin was loading Twig during or immediately after plugin instantiation. ([#2866](https://github.com/craftcms/cms/issues/2866))\n\n## 3.0.6 - 2018-05-08\n\n### Added\n- Error messages about missing plugin-supplied field and volume types now show an Install button when possible.\n- Added `craft\\base\\MissingComponentTrait::getPlaceholderHtml()`.\n- Added `craft\\db\\Migration::EVENT_AFTER_UP` and `EVENT_AFTER_DOWN` events.\n- Added `craft\\elements\\Asset::getContents()`.\n\n### Changed\n- Edit User pages will now warn editors when leaving the page with unsaved changes. ([#2832](https://github.com/craftcms/cms/issues/2832))\n- Modules are once again loaded before plugins, so they have a chance to register Twig initialization events before a plugin initializes Twig. ([#2831](https://github.com/craftcms/cms/issues/2831))\n- `craft\\helpers\\FileHelper::isSvg()` now returns `true` for files with an `image/svg` MIME type (missing the `+xml`). ([#2837](https://github.com/craftcms/cms/pull/2837))\n- The `svg()` Twig function now accepts assets to be passed directly into it. ([#2838](https://github.com/craftcms/cms/pull/2838))\n- The \u201cSave and add another\u201d save menu option on Edit Entry and Edit Categories pages now maintain the currently-selected site. ([#2844](https://github.com/craftcms/cms/issues/2844))\n- PHP date patterns that are *only* a month name or week day name character will now format the date using the stand-alone month/week day name value. (For example, `'F'` will format a date as \u201cMaggio\u201d instead of \u201cmaggio\u201d.)\n- Servers without the Intl extension will now use location-agnostic locale data as a fallback if locale data for the specific locale isn\u2019t available.\n- The `|date` Twig filter always goes through `craft\\i18n\\Formatter::asDate()` now, unless formatting a `DateInterval` object.\n- The Settings \u2192 Plugins page now shows \u201cBuy now\u201d buttons for any commercial plugins that don\u2019t have a license key yet.\n\n### Deprecated\n- Deprecated `craft\\helpers\\DateTimeHelper::translateDate()`. `craft\\i18n\\Formatter::asDate()` should be used instead.\n\n### Removed\n- Removed the `translate` argument from the `|date`, `|time`, and `|datetime` Twig filters; the resulting formatted dates will always be translated now. (Use `myDate.format()` to avoid translations.)\n\n### Fixed\n- Fixed an error that could occur in the Plugin Store.\n- Fixed a bug where `myDate|date('F')` was returning the short \u201cMay\u201d translation rather than the full-length one. ([#2848](https://github.com/craftcms/cms/issues/2848))\n\n## 3.0.5 - 2018-05-01\n\n### Changed\n- Fields\u2019 translation icons now reveal the chosen Translation Method in their tooltip. ([#2808](https://github.com/craftcms/cms/issues/2808))\n- Improved the error messages displayed when an Assets field has an invalid Upload Location setting. ([#2803](https://github.com/craftcms/cms/issues/2803))\n- Craft now logs errors that occur when saving and replacing assets. ([#2814](https://github.com/craftcms/cms/issues/2814))\n- Single sections\u2019 entry types\u2019 handles are now updated to match their section\u2019s handle whenever the section is saved. ([#2824](https://github.com/craftcms/cms/issues/2824))\n- The Control Panel background color was lightened up a bit.\n\n### Fixed\n- Fixed an error that would occur on servers without the Phar PHP extension enabled.\n- Fixed an error that could occur if a Matrix block was deleted by a queue job. ([#2813](https://github.com/craftcms/cms/issues/2813))\n- Fixed a bug where Twig could be configured to output times in UTC rather than the system timezone, if a bootstrapped module was loading Twig. ([#2761](https://github.com/craftcms/cms/issues/2761))\n- Fixed a SQL error that could occur when upgrading from Craft 2 to Craft 3 with an active user session.\n- Fixed various SQL errors that could occur when upgrading from Craft 2 to Craft 3, if there were any lingering Craft 3 database tables from a previous upgrade attempt.\n- Fixed a bug where the Clear Caches tool was deleting the `.gitignore` file inside `web/cpresources/`. ([#2823](https://github.com/craftcms/cms/issues/2823))\n- Fixed the vertical positioning of checkboxes in the Control Panel. ([#2825](https://github.com/craftcms/cms/issues/2825))\n- Fixed a JavaScript error that could occur if an element type\u2019s class name contained `\\u`. ([#2826](https://github.com/craftcms/cms/issues/2826))\n\n## 3.0.4 - 2018-04-24\n\n### Added\n- Added the `craft.globalSets()` template function. ([#2790](https://github.com/craftcms/cms/issues/2790))\n- Added the `hasDescendants` element query param. ([#2786](https://github.com/craftcms/cms/issues/2786))\n- Added `craft\\elements\\User::hasDashboard`.\n\n### Changed\n- Sections and category groups now ignore posted Template settings for sites that don\u2019t have URI Formats.\n- Control Panel resources are once again eager-published. ([#2763](https://github.com/craftcms/cms/issues/2763))\n- `entries/save-entries` and `categories/save-category` actions now include the `slug` for responses that accept JSON. ([#2792](https://github.com/craftcms/cms/issues/2792))\n- Most `craft\\services\\Path` methods now have a `$create` argument, which can be set to `false` to prevent the directory from being created if it doesn\u2019t exist yet.\n- Craft no longer creates directories when it just needed to clear it. ([#2771](https://github.com/craftcms/cms/issues/2771))\n- `craft\\services\\Config::setDotEnvVar()` now sets the environment variable for the current request, in addition to updating the `.env` file.\n- Removed `craft\\controllers\\AssetsController::actionDownloadTempAsset()`.\n- User now must be logged in to use the Asset Preview File functionality.\n\n### Fixed\n- Fixed a bug where users would regain all default Dashboard widgets if all widgets were removed. ([#2769](https://github.com/craftcms/cms/issues/2769))\n- Fixed a bug where you would get a \u201cnot a valid language\u201d error message when creating a new site using certain languages.\n- Fixed a bug where database connection settings that were set by the `setup` command weren\u2019t always taking effect in time for the CLI installer. ([#2774](https://github.com/craftcms/cms/issues/2774))\n- Fixed a bug where empty Plain Text fields were getting empty string values rather than `null`.\n- Fixed a bug where elements within relational fields could have two thumbnails. ([#2785](https://github.com/craftcms/cms/issues/2785))\n- Fixed a bug where it was not possible to pass a `--table-prefix` argument to the `setup/db-creds` command. ([#2791](https://github.com/craftcms/cms/pull/2791))\n- Fixed an error that occurred for users without permission to perform updates, if available update info wasn\u2019t cached.\n- Fixed an error that occurred when `craft\\elements\\Asset::sources()` was called in a console request. ([#2798](https://github.com/craftcms/cms/issues/2798))\n- Fixed JavaScript errors that could occur on the front-end after deleting Matrix blocks. ([#2799](https://github.com/craftcms/cms/pull/2799))\n\n## 3.0.3.1 - 2018-04-18\n\n### Fixed\n- Fixed an error that occurred when editing an entry if any of the entry\u2019s revisions were created with an entry type that no longer exists.\n- Fixed an error that could occur when saving an asset. ([#2764](https://github.com/craftcms/cms/issues/2764))\n- Fixed a bug where Craft assumed an asset was missing if there was an error when indexing it. ([#2763](https://github.com/craftcms/cms/issues/2763))\n\n## 3.0.3 - 2018-04-17\n\n### Added\n- Added `craft\\elements\\Entry::updateTitle()`.\n- Added `Yii::alias()`.\n\n### Changed\n- New sites\u2019 Base URLs now default to `@web/`.\n- Textual custom fields now ensure that they don\u2019t contain 4+ byte characters. ([#2725](https://github.com/craftcms/cms/issues/2725))\n- It is no longer expected that all of the `defaultSearchTermOptions` config setting options will be set if any of the default option values need to be overridden. ([#2737](https://github.com/craftcms/cms/issues/2737))\n- Control Panel panes now have at least 48 pixels of bottom padding. ([#2744](https://github.com/craftcms/cms/issues/2744))\n- Craft now intercepts 404-ing resource requests, and publishes the resources on the fly.\n- The Clear Caches utility now has a \u201cControl Panel resources\u201d option.\n- The Clear Caches utility now sorts the cache options alphabetically.\n- When enabling new sites for a section, the new sites\u2019 content is now based on the primary site\u2019s content, if the section was and still is enabled for the primary site. ([#2748](https://github.com/craftcms/cms/issues/2748))\n- Improved the responsiveness of element indexes.\n- `Craft.BaseElementIndexView` now has a `loadMoreElementsAction` setting. ([#2762](https://github.com/craftcms/cms/pull/2762))\n\n### Fixed\n- Fixed a bug where the Clear Caches utility was not deleting template caches. ([#2720](https://github.com/craftcms/cms/issues/2720))\n- Fixed a bug where the Plugin Store was not displaying payment errors on checkout.\n- Fixed a bug where Control Panel-defined routes that contained special regular expression characters weren\u2019t working. ([#2721](https://github.com/craftcms/cms/issues/2721))\n- Fixed a bug where it was not possible to save system messages in some cases.\n- Fixed a bug where static translations within dynamic entry title formats were getting translated using the current site\u2019s language, rather than the entry\u2019s language. ([#2722](https://github.com/craftcms/cms/issues/2722))\n- Fixed a bug where deprecation errors for some date formatting methods were not escaping backslashes.\n- Fixed a bug where plugins\u2019 \u201cLast update\u201d timestamps in the Plugin Store weren\u2019t getting formatted correctly in Safari. ([#2733](https://github.com/craftcms/cms/issues/2733))\n- Fixed references to a nonexistent `Craft.eot` file in the Control Panel CSS. ([#2740](https://github.com/craftcms/cms/issues/2740))\n- Fixed a bug where the default PostgreSQL database restore command wasn\u2019t setting the `PGPASSWORD` environment variable. ([#2741](https://github.com/craftcms/cms/pull/2741))\n- Fixed an error that could occur if the system time zone was not supported by the ICU library, on environments with the Intl extension loaded.\n- Fixed a bug where several administrative fields had translatable icons. ([#2742](https://github.com/craftcms/cms/issues/2742))\n- Fixed a bug where `craft\\controllers\\PluginStoreController::actionSavePluginLicenseKeys()` was trying to set a plugin license key for plugins which were not installed.\n\n### Security\n- Fixed a bug assets were not getting cleansed on upload. ([#2709](https://github.com/craftcms/cms/issues/2709))\n\n## 3.0.2 - 2018-04-10\n\n### Added\n- Added the `EVENT_BEFORE_DELETE_CACHES` and `EVENT_AFTER_DELETE_CACHES` events to `craft\\services\\TemplateCaches`.\n- Added `craft\\events\\DeleteTemplateCachesEvent`.\n\n### Changed\n- Craft now deletes all compiled templates whenever Craft or a plugin is updated. ([#2686](https://github.com/craftcms/cms/issues/2686))\n- The Plugin Store now displays commercial plugins\u2019 renewal prices. ([#2690](https://github.com/craftcms/cms/issues/2690))\n- The Plugin Store no longer shows the \u201cUpgrade Craft CMS\u201d link if Craft is already running (and licensed to run) the Pro edition. ([#2713](https://github.com/craftcms/cms/issues/2713))\n- Matrix fields now set `$propagating` to `true` when saving Matrix blocks, if the owner element is propagating.\n- `craft\\helpers\\ArrayHelper::toArray()` no longer throws a deprecation error when a string without commas is passed to it. ([#2711](https://github.com/craftcms/cms/issues/2711))\n- Editable tables now support an `html` column type, which will output cell values directly without encoding HTML entities. ([#2716](https://github.com/craftcms/cms/pull/2716))\n- `Craft.EditableTable` instances are now accessible via `.data('editable-table')` on their `<table>` element. ([#2694](https://github.com/craftcms/cms/issues/2694))\n- Updated Composer to 1.6.3. ([#2707](https://github.com/craftcms/cms/issues/2707))\n- Updated Garnish to 0.1.22. ([#2689](https://github.com/craftcms/cms/issues/2689))\n\n### Fixed\n- Fixed an error that could occur in the Control Panel if any plugins with licensing issues were installed. ([#2691](https://github.com/craftcms/cms/pull/2691))\n- Fixed a bug on the Plugin Store\u2019s Payment screen where the \u201cUse a new credit card\u201d radio option would not get selected automatically even if it was the only one available.\n- Fixed a bug where `craft\\web\\assets\\vue\\VueAsset` didn\u2019t respect the `useCompressedJs` config setting.\n- Fixed an error that occurred when saving a Single entry over Ajax. ([#2687](https://github.com/craftcms/cms/issues/2687))\n- Fixed an error that could occur when disabling a site on a Single section. ([#2695](https://github.com/craftcms/cms/issues/2695))\n- Fixed an error that could occur on requests without a content type on the response. ([#2704](https://github.com/craftcms/cms/issues/2704))\n- Fixed a bug where the `includeSubfolders` asset query param wasn\u2019t including results in the parent folder. ([#2706](https://github.com/craftcms/cms/issues/2706))\n- Fixed an error that could occur when querying for users eager-loaded with their photos, if any of the resulting users didn\u2019t have a photo. ([#2708](https://github.com/craftcms/cms/issues/2708))\n- Fixed a bug where relational fields within Matrix fields wouldn\u2019t save relations to elements that didn\u2019t exist on all of the sites the owner element existed on. ([#2683](https://github.com/craftcms/cms/issues/2683))\n- Fixed a bug where relational fields were ignoring disabled related elements in various functions, including required field validation and value serialization.\n- Fixed an error that would occur if a new custom field was created and added to an element\u2019s field layout, and its value was accessed, all in the same request. ([#2705](https://github.com/craftcms/cms/issues/2705))\n- Fixed a bug where the `id` param was ignored when used on an eager-loaded elements\u2019 criteria. ([#2717](https://github.com/craftcms/cms/issues/2717))\n- Fixed a bug where the default restore command for MySQL wouldn\u2019t actually restore the database. ([#2714](https://github.com/craftcms/cms/issues/2714))\n\n## 3.0.1 - 2018-04-04\n\n### Deprecated\n- Brought back and deprecated the `Craft::Personal` and `Craft::Client` constants.\n\n### Fixed\n- Fixed a bug where elements\u2019 `getNext()` and `getPrev()` methods were modifying the element query passed into them. ([#2160](https://github.com/craftcms/cms/issues/2160))\n- Fixed a bug where Table fields could be pre-populated with one too many rows. ([#2680](https://github.com/craftcms/cms/pull/2680))\n\n### Security\n- Craft no longer sends exception messages to error templates, unless the exception is an instance of `yii\\base\\UserException`.\n\n## 3.0.0.2 - 2018-04-04\n\n### Fixed\n- Fixed a bug where Craft Pro installs were getting identified as Craft Solo in the Control Panel.\n\n## 3.0.0 - 2018-04-04\n\n### Added\n- The codebase has been completely rewritten and refactored to improve performance, maintainability, and extensibility.\n- Craft can now be [installed](https://docs.craftcms.com/v3/installation.html) via Composer in addition to a zip file. ([#895](https://github.com/craftcms/cms/issues/895))\n- Craft\u2019s setup wizard is now available as a CLI tool in addition to the web-based one.\n- [Plugins](https://docs.craftcms.com/v3/plugin-intro.html) are now loaded as Composer dependencies, and implemented as extensions of [Yii modules](http://www.yiiframework.com/doc-2.0/guide-structure-modules.html).\n- Added [multi-site](https://docs.craftcms.com/v3/sites.html) support.\n- Added the Plugin Store, where plugins can be discovered, trialled, and purchased. ([#808](https://github.com/craftcms/cms/issues/808))\n- Plugins can now be updated and removed from within the Control Panel.\n- Asset sources are now called \u201cvolumes\u201d, and plugins can supply their own volume types.\n- Added the Image Editor, which can be used to rotate, crop, and flip images, as well as set focal points on them.\n- Added asset previews, which can be triggered via a \u201cPreview file\u201d action on the Assets index, or with a `shift` + `spacebar` keyboard shortcut throughout the Control Panel.\n- Asset editor HUDs now show image previews. ([#837](https://github.com/craftcms/cms/issues/837))\n- Added the \u201cUtilities\u201d section to the Control Panel, replacing the Tools area of the Settings page.\n- Added the Debug Toolbar, powered by the [Debug Extension for Yii 2](http://www.yiiframework.com/doc-2.0/guide-tool-debugger.html).\n- Added support for [Content Migrations](https://docs.craftcms.com/v3/content-migrations.html).\n- Added support for PostgreSQL.\n\n### Changed\n- The Control Panel has been redesigned for better usability, readability and responsiveness.\n- Renamed all \u201cURL Format\u201d things to \u201cURI Format\u201d, in the Control Panel UI and in the code.\n- Added the \u201cPropagate entries across all enabled sites?\u201d section setting. If disabled, entries will only be associated with the site they were created on. ([#2330](https://github.com/craftcms/cms/issues/2330))\n- Structure sections and category groups no longer have Nested URL Format settings. (It\u2019s still possible to achieve the same result with a single URI Format setting.)\n- When an entry type is updated, Craft now re-saves all entries of that type.\n- When a category is deleted, its nested categories are no longer deleted with it.\n- Craft no longer re-saves *all* localizable elements after a new site is created; entries and Matrix blocks are skipped, and plugins that supply custom element types must now re-save their elements manually as well.\n- The \u201cNew entry\u201d and \u201cNew category\u201d buttons on Entries and Categories index pages now load the Edit page for the currently-selected site. ([#2236](https://github.com/craftcms/cms/issues/2236))\n- Elements now validate that custom field values will fit within their database columns, for fields with textual or numeric column types.\n- User photos are now assets. ([#933](https://github.com/craftcms/cms/issues/933))\n- Assets now have a \u201cLink\u201d table attribute option.\n- Volumes\u2019 \u201cBase URL\u201d settings can now begin with `@web`, which is an alias for the root URL that Craft is running from.\n- Local volumes\u2019 \u201cFile System Path\u201d settings can now begin with `@webroot`, which is an alias for the path to the directory that `index.php` lives in.\n- Global Sets\u2019 field layouts can now have custom tabs.\n- Color inputs can now be left blank.\n- Color values within Table fields are now represented by `craft\\fields\\data\\ColorData` objects.\n- Element titles now get a validation error if they contain any 4+ byte characters (like emoji), on servers running MySQL. ([#2513](https://github.com/craftcms/cms/issues/2513))\n- Lightswitch fields that don\u2019t have a value yet will now be assigned the default field value, even for existing elements. ([#2404](https://github.com/craftcms/cms/issues/2404))\n- The system installer now sets the initial admin account\u2019s preferred language to the site language selected in the installation wizard. ([#2480](https://github.com/craftcms/cms/issues/2480))\n- Table fields now have \u201cMin Rows\u201d, \u201cMax Rows\u201d, and \u201cAdd Row Label\u201d settings. ([#2372](https://github.com/craftcms/cms/issues/2372))\n- Table fields now have \u201cDate\u201d, \u201cTime\u201d, \u201cLightswitch\u201d, and \u201cColor\u201d column type options.\n- Color fields now return a `craft\\fields\\data\\ColorData` object, with `hex`, `rgb`, `red`, `green`, `blue`, `r`, `g`, `b`, and `luma` properties.\n- Matrix fields now have \u201cManage blocks on a per-site basis\u201d, \u201cMin Blocks\u201d, and \u201cMax Blocks\u201d settings.\n- Matrix fields with only one block type, and equal values for the Min Blocks and Max Blocks settings, now hide the UI for adding and deleting blocks.\n- Matrix fields with only one block type will now auto-create the minimum number of blocks required by the field, per the Min Blocks setting, for new elements. ([#850](https://github.com/craftcms/cms/issues/850))\n- The `migrate/up` console command will now update the appropriate schema version in the database after successfully completing all migrations. ([#1907](https://github.com/craftcms/cms/issues/1907))\n- Users can now set their preferred language to any supported application language. ([#847](https://github.com/craftcms/cms/issues/847))\n- Users are no longer logged out when verifying a new email address on their own account. ([#1421](https://github.com/craftcms/cms/issues/1421))\n- Users no longer get an exception or error message if they click on an invalid/expired email verification link and are already logged in. Instead they\u2019ll be redirected to wherever they would normally be taken immediately after logging in. ([#1422](https://github.com/craftcms/cms/issues/1422))\n- If anything prevents a user from being deleted, any changes that were made in preparation for deleting the user are now rolled back.\n- Added `webp` as a web-safe image format.\n- Craft now checks if the current installation can manipulate an image instead of checking against a predefined list. ([#1648](https://github.com/craftcms/cms/issues/1648), [#1545](https://github.com/craftcms/cms/issues/1545))\n- The `getCsrfInput()` global function has been renamed to `csrfInput()`. (getCsrfInput() still works but produces a deprecation error.)\n- The `{% cache %}` tag no longer includes the query string when storing the cache URL.\n- Added the `|timestamp` Twig filter, for formatting a date as a user-friendly timestamp.\n- Added the `|datetime` Twig filter, for formatting a date with a localized date+time format.\n- Added the `|time` Twig filter, for formatting a date with a localized time format.\n- Added the `|multisort` Twig filter, which duplicates an array and sorts it with [craft\\helpers\\ArrayHelper::multisort()](http://www.yiiframework.com/doc-2.0/yii-helpers-basearrayhelper.html#multisort()-detail).\n- Added the `|atom` and `|rss` Twig filters, for formatting dates in Atom and RSS date formats, respectively.\n- Added the `|column` Twig filter, for capturing the key/property values of a series of arrays/objects.\n- Added the `|index` Twig filter, for indexing an array of arrays/objects by one of their keys/values.\n- Added the `|filterByValue` Twig filter.\n- Added the `|duration` Twig filter, which converts a `DateInterval` object into a human-readable duration.\n- The `t` filter now always defaults to translating the given string using the `site` category unless it is otherwise specified (e.g. `myString|t('pluginhandle')`).\n- The `|date` filter can be passed `'short'`, `'medium'`, `'long'`, and `'full'`, which will format the date with a localized date format.\n- It is now possibly to customize the SQL of [element queries](https://docs.craftcms.com/v3/element-queries.html), and there are more choices on how the data should be returned.\n- Element queries are no longer limited to 100 results by default.\n- The \u201cFailed\u201d message in the queue HUD in the Control Panel now shows the full error message as alt text. ([#855](https://github.com/craftcms/cms/issues/855))\n- Added the `convertFilenamesToAscii` config setting.\n- Added the `preserveExifData` config setting, `false` by default and requires Imagick. ([#2034](https://github.com/craftcms/cms/issues/2034))\n- Added the `aliases` config setting, providing an easy way to define custom [aliases](http://www.yiiframework.com/doc-2.0/guide-concept-aliases.html).\n- Removed support for automatically determining the values for the `omitScriptNameInUrls` and `usePathInfo` config settings.\n- It\u2019s now possible to override Craft\u2019s application config via `config/app.php`.\n- It\u2019s now possible to override volume settings via `config/volumes.php`.\n- It\u2019s now possible to override all plugins\u2019 settings via `config/<plugin-handle>.php`.\n- Renamed the `runTasksAutomatically` config setting to `runQueueAutomatically`.\n- The `translationDebugOutput` config setting will now wrap strings with `@` characters if the category is `app`, `$` if the category is `site`, and `%` for anything else.\n- All user-defined strings in the Control Panel (e.g. section names) are now translated using the `site` category, to prevent translation conflicts with Craft\u2019s own Control Panel translations.\n- Routes can now be stored on a per-site basis, rather than per-locale.\n- Web requests are now logged to `storage/logs/web.log`.\n- Web requests that result in 404 errors are now logged to `storage/logs/web-404s.log`.\n- Console requests are now logged to `storage/logs/console.log`.\n- Queue requests are now logged to `storage/logs/queue.log`.\n- Craft 3 now requires PHP 7.0.0 or later.\n- Craft 3 now requires MySQL 5.5+ or PostgreSQL 9.5+.\n- Craft now takes advantage of the [PHP Intl extension](http://php.net/manual/en/book.intl.php) when available.\n- Craft now uses Stringy for better string processing support.\n- Craft now uses Flysystem for better asset volume support.\n- Craft now uses Swiftmailer for better email sending support.\n- Craft now uses the [Yii 2 Queue Extension](https://github.com/yiisoft/yii2-queue) for managing background tasks.\n- Craft now uses the Zend Feed library for better RSS and Atom processing support.\n- Updated Yii to 2.0.15.1.\n- Updated Twig to 2.4.\n- Updated Guzzle to 6.3.\n\n### Deprecated\n- Many things have been deprecated. See [Changes in Craft 3](https://docs.craftcms.com/v3/changes-in-craft-3.html) for a complete list.\n\n### Fixed\n- Fixed a bug where a PHP session would be started on every template rendering request whether it was needed or not. ([#1765](https://github.com/craftcms/cms/issues/1765))\n\n### Security\n- Craft uses OpenSSL for encryption rather than mcrypt, which is far more secure and well-maintained.\n", "/*!   - 2019-09-25 */\n(function($){\n\n/** global: Craft */\n/** global: Garnish */\n// Set all the standard Craft.* stuff\n$.extend(Craft,\n    {\n        navHeight: 48,\n\n        /**\n         * Get a translated message.\n         *\n         * @param {string} category\n         * @param {string} message\n         * @param {object} params\n         * @return string\n         */\n        t: function(category, message, params) {\n            if (\n                typeof Craft.translations[category] !== 'undefined' &&\n                typeof Craft.translations[category][message] !== 'undefined'\n            ) {\n                message = Craft.translations[category][message];\n            }\n\n            if (params) {\n                for (var key in params) {\n                    if (!params.hasOwnProperty(key)) {\n                        continue;\n                    }\n\n                    message = message.replace('{' + key + '}', params[key]);\n                }\n            }\n\n            return message;\n        },\n\n        formatDate: function(date) {\n            if (typeof date !== 'object') {\n                date = new Date(date);\n            }\n\n            return $.datepicker.formatDate(Craft.datepickerOptions.dateFormat, date);\n        },\n\n        /**\n         * Formats a number.\n         *\n         * @param {string} number\n         * @return string D3 format\n         */\n        formatNumber: function(number, format) {\n            if(typeof format == 'undefined') {\n                format = ',.0f';\n            }\n\n            var formatter = d3.formatLocale(d3FormatLocaleDefinition).format(format);\n\n            return formatter(number);\n        },\n\n        /**\n         * Escapes some HTML.\n         *\n         * @param {string} str\n         * @return string\n         */\n        escapeHtml: function(str) {\n            return $('<div/>').text(str).html();\n        },\n\n        /**\n         * Escapes special regular expression characters.\n         *\n         * @param {string} str\n         * @return string\n         */\n        escapeRegex: function(str) {\n            // h/t https://stackoverflow.com/a/9310752\n            return str.replace(/[-[\\]{}()*+?.,\\\\^$|#\\s]/g, '\\\\$&');\n        },\n\n        /**\n         * Returns the text in a string that might contain HTML tags.\n         *\n         * @param {string} str\n         * @return string\n         */\n        getText: function(str) {\n            return $('<div/>').html(str).text();\n        },\n\n        /**\n         * Encodes a URI copmonent. Mirrors PHP's rawurlencode().\n         *\n         * @param {string} str\n         * @return string\n         * @see http://stackoverflow.com/questions/1734250/what-is-the-equivalent-of-javascripts-encodeuricomponent-in-php\n         */\n        encodeUriComponent: function(str) {\n            str = encodeURIComponent(str);\n\n            var differences = {\n                '!': '%21',\n                '*': '%2A',\n                \"'\": '%27',\n                '(': '%28',\n                ')': '%29'\n            };\n\n            for (var chr in differences) {\n                var re = new RegExp('\\\\' + chr, 'g');\n                str = str.replace(re, differences[chr]);\n            }\n\n            return str;\n        },\n\n        /**\n         * Selects the full value of a given text input.\n         *\n         * @param input\n         */\n        selectFullValue: function(input) {\n            var $input = $(input);\n            var val = $input.val();\n\n            // Does the browser support setSelectionRange()?\n            if (typeof $input[0].setSelectionRange !== 'undefined') {\n                // Select the whole value\n                var length = val.length * 2;\n                $input[0].setSelectionRange(0, length);\n            }\n            else {\n                // Refresh the value to get the cursor positioned at the end\n                $input.val(val);\n            }\n        },\n\n        /**\n         * Formats an ID out of an input name.\n         *\n         * @param {string} inputName\n         * @return string\n         */\n        formatInputId: function(inputName) {\n            return this.rtrim(inputName.replace(/[\\[\\]\\\\]+/g, '-'), '-');\n        },\n\n        /**\n         * @return string\n         * @param path\n         * @param params\n         * @param baseUrl\n         */\n        getUrl: function(path, params, baseUrl) {\n            if (typeof path !== 'string') {\n                path = '';\n            }\n\n            // Normalize the params\n            var anchor = '';\n\n            if ($.isPlainObject(params)) {\n                var aParams = [];\n\n                for (var name in params) {\n                    if (!params.hasOwnProperty(name)) {\n                        continue;\n                    }\n\n                    var value = params[name];\n\n                    if (name === '#') {\n                        anchor = value;\n                    }\n                    else if (value !== null && value !== '') {\n                        aParams.push(name + '=' + value);\n                    }\n                }\n\n                params = aParams;\n            }\n\n            if (Garnish.isArray(params)) {\n                params = params.join('&');\n            }\n            else {\n                params = Craft.trim(params, '&?');\n            }\n\n            // Were there already any query string params in the path?\n            var qpos = path.indexOf('?');\n            if (qpos !== -1) {\n                params = path.substr(qpos + 1) + (params ? '&' + params : '');\n                path = path.substr(0, qpos);\n            }\n\n            // Return path if it appears to be an absolute URL.\n            if (path.search('://') !== -1 || path[0] === '/') {\n                return path + (params ? '?' + params : '');\n            }\n\n            path = Craft.trim(path, '/');\n\n            // Put it all together\n            var url;\n\n            if (baseUrl) {\n                url = baseUrl;\n\n                if (path) {\n                    // Does baseUrl already contain a path?\n                    var pathMatch = url.match(new RegExp('[&\\?]' + Craft.escapeRegex(Craft.pathParam) + '=[^&]+'));\n                    if (pathMatch) {\n                        url = url.replace(pathMatch[0], Craft.rtrim(pathMatch[0], '/') + '/' + path);\n                        path = '';\n                    }\n                }\n            }\n            else {\n                url = Craft.baseUrl;\n            }\n\n            // Does the base URL already have a query string?\n            qpos = url.indexOf('?');\n            if (qpos !== -1) {\n                params = url.substr(qpos + 1) + (params ? '&' + params : '');\n                url = url.substr(0, qpos);\n            }\n\n            if (!Craft.omitScriptNameInUrls && path) {\n                if (Craft.usePathInfo) {\n                    // Make sure that the script name is in the URL\n                    if (url.search(Craft.scriptName) === -1) {\n                        url = Craft.rtrim(url, '/') + '/' + Craft.scriptName;\n                    }\n                }\n                else {\n                    // Move the path into the query string params\n\n                    // Is the path param already set?\n                    if (params && params.substr(0, Craft.pathParam.length + 1) === Craft.pathParam + '=') {\n                        var basePath,\n                            endPath = params.indexOf('&');\n\n                        if (endPath !== -1) {\n                            basePath = params.substring(2, endPath);\n                            params = params.substr(endPath + 1);\n                        }\n                        else {\n                            basePath = params.substr(2);\n                            params = null;\n                        }\n\n                        // Just in case\n                        basePath = Craft.rtrim(basePath);\n\n                        path = basePath + (path ? '/' + path : '');\n                    }\n\n                    // Now move the path into the params\n                    params = Craft.pathParam + '=' + path + (params ? '&' + params : '');\n                    path = null;\n                }\n            }\n\n            if (path) {\n                url = Craft.rtrim(url, '/') + '/' + path;\n            }\n\n            if (params) {\n                url += '?' + params;\n            }\n\n            if (anchor) {\n                url += '#' + anchor;\n            }\n\n            return url;\n        },\n\n        /**\n         * @return string\n         * @param path\n         * @param params\n         */\n        getCpUrl: function(path, params) {\n            return this.getUrl(path, params, Craft.baseCpUrl);\n        },\n\n        /**\n         * @return string\n         * @param path\n         * @param params\n         */\n        getSiteUrl: function(path, params) {\n            return this.getUrl(path, params, Craft.baseSiteUrl);\n        },\n\n        /**\n         * Returns an action URL.\n         *\n         * @param {string} path\n         * @param {object|string|undefined} params\n         * @return string\n         */\n        getActionUrl: function(path, params) {\n            return Craft.getUrl(path, params, Craft.actionUrl);\n        },\n\n        /**\n         * Redirects the window to a given URL.\n         *\n         * @param {string} url\n         */\n        redirectTo: function(url) {\n            document.location.href = this.getUrl(url);\n        },\n\n        /**\n         * Returns a hidden CSRF token input, if CSRF protection is enabled.\n         *\n         * @return string\n         */\n        getCsrfInput: function() {\n            if (Craft.csrfTokenName) {\n                return '<input type=\"hidden\" name=\"' + Craft.csrfTokenName + '\" value=\"' + Craft.csrfTokenValue + '\"/>';\n            }\n            else {\n                return '';\n            }\n        },\n\n        /**\n         * Posts an action request to the server.\n         *\n         * @param {string} action\n         * @param {object|undefined} data\n         * @param {function|undefined} callback\n         * @param {object|undefined} options\n         * @return jqXHR\n         */\n        postActionRequest: function(action, data, callback, options) {\n            // Make 'data' optional\n            if (typeof data === 'function') {\n                options = callback;\n                callback = data;\n                data = {};\n            }\n\n            var headers = {\n                'X-Registered-Asset-Bundles': Object.keys(Craft.registeredAssetBundles).join(','),\n                'X-Registered-Js-Files': Object.keys(Craft.registeredJsFiles).join(',')\n            };\n\n            if (Craft.csrfTokenValue && Craft.csrfTokenName) {\n                headers['X-CSRF-Token'] = Craft.csrfTokenValue;\n            }\n\n            var jqXHR = $.ajax($.extend({\n                url: Craft.getActionUrl(action),\n                type: 'POST',\n                dataType: 'json',\n                headers: headers,\n                data: data,\n                success: callback,\n                error: function(jqXHR, textStatus, errorThrown) {\n                    // Ignore incomplete requests, likely due to navigating away from the page\n                    // h/t https://stackoverflow.com/a/22107079/1688568\n                    if (jqXHR.readyState !== 4) {\n                        return;\n                    }\n\n                    if (typeof Craft.cp !== 'undefined') {\n                        Craft.cp.displayError();\n                    } else {\n                        alert(Craft.t('app', 'An unknown error occurred.'));\n                    }\n\n                    if (callback) {\n                        callback(null, textStatus, jqXHR);\n                    }\n                }\n            }, options));\n\n            // Call the 'send' callback\n            if (options && typeof options.send === 'function') {\n                options.send(jqXHR);\n            }\n\n            return jqXHR;\n        },\n\n        _waitingOnAjax: false,\n        _ajaxQueue: [],\n\n        /**\n         * Queues up an action request to be posted to the server.\n         */\n        queueActionRequest: function(action, data, callback, options) {\n            // Make 'data' optional\n            if (typeof data === 'function') {\n                options = callback;\n                callback = data;\n                data = undefined;\n            }\n\n            Craft._ajaxQueue.push([action, data, callback, options]);\n\n            if (!Craft._waitingOnAjax) {\n                Craft._postNextActionRequestInQueue();\n            }\n        },\n\n        _postNextActionRequestInQueue: function() {\n            Craft._waitingOnAjax = true;\n\n            var args = Craft._ajaxQueue.shift();\n\n            Craft.postActionRequest(args[0], args[1], function(data, textStatus, jqXHR) {\n                if (args[2] && typeof args[2] === 'function') {\n                    args[2](data, textStatus, jqXHR);\n                }\n\n                if (Craft._ajaxQueue.length) {\n                    Craft._postNextActionRequestInQueue();\n                }\n                else {\n                    Craft._waitingOnAjax = false;\n                }\n            }, args[3]);\n        },\n\n        /**\n         * Converts a comma-delimited string into an array.\n         *\n         * @param {string} str\n         * @return array\n         */\n        stringToArray: function(str) {\n            if (typeof str !== 'string') {\n                return str;\n            }\n\n            var arr = str.split(',');\n            for (var i = 0; i < arr.length; i++) {\n                arr[i] = $.trim(arr[i]);\n            }\n            return arr;\n        },\n\n        /**\n         * Expands an array of POST array-style strings into an actual array.\n         *\n         * @param {object} arr\n         * @return array\n         */\n        expandPostArray: function(arr) {\n            var expanded = {};\n            var i;\n\n            for (var key in arr) {\n                if (!arr.hasOwnProperty(key)) {\n                    continue;\n                }\n\n                var value = arr[key],\n                    m = key.match(/^(\\w+)(\\[.*)?/),\n                    keys;\n\n                if (m[2]) {\n                    // Get all of the nested keys\n                    keys = m[2].match(/\\[[^\\[\\]]*\\]/g);\n\n                    // Chop off the brackets\n                    for (i = 0; i < keys.length; i++) {\n                        keys[i] = keys[i].substring(1, keys[i].length - 1);\n                    }\n                }\n                else {\n                    keys = [];\n                }\n\n                keys.unshift(m[1]);\n\n                var parentElem = expanded;\n\n                for (i = 0; i < keys.length; i++) {\n                    if (i < keys.length - 1) {\n                        if (typeof parentElem[keys[i]] !== 'object') {\n                            // Figure out what this will be by looking at the next key\n                            if (!keys[i + 1] || parseInt(keys[i + 1]) == keys[i + 1]) {\n                                parentElem[keys[i]] = [];\n                            }\n                            else {\n                                parentElem[keys[i]] = {};\n                            }\n                        }\n\n                        parentElem = parentElem[keys[i]];\n                    }\n                    else {\n                        // Last one. Set the value\n                        if (!keys[i]) {\n                            keys[i] = parentElem.length;\n                        }\n\n                        parentElem[keys[i]] = value;\n                    }\n                }\n            }\n\n            return expanded;\n        },\n\n        /**\n         * Compares two variables and returns whether they are equal in value.\n         * Recursively compares array and object values.\n         *\n         * @param obj1\n         * @param obj2\n         * @param sortObjectKeys Whether object keys should be sorted before being compared. Default is true.\n         * @return boolean\n         */\n        compare: function(obj1, obj2, sortObjectKeys) {\n            // Compare the types\n            if (typeof obj1 !== typeof obj2) {\n                return false;\n            }\n\n            if (typeof obj1 === 'object') {\n                // Compare the lengths\n                if (obj1.length !== obj2.length) {\n                    return false;\n                }\n\n                // Is one of them an array but the other is not?\n                if ((obj1 instanceof Array) !== (obj2 instanceof Array)) {\n                    return false;\n                }\n\n                // If they're actual objects (not arrays), compare the keys\n                if (!(obj1 instanceof Array)) {\n                    if (typeof sortObjectKeys === 'undefined' || sortObjectKeys === true) {\n                        if (!Craft.compare(Craft.getObjectKeys(obj1).sort(), Craft.getObjectKeys(obj2).sort())) {\n                            return false;\n                        }\n                    }\n                    else {\n                        if (!Craft.compare(Craft.getObjectKeys(obj1), Craft.getObjectKeys(obj2))) {\n                            return false;\n                        }\n                    }\n                }\n\n                // Compare each value\n                for (var i in obj1) {\n                    if (!obj1.hasOwnProperty(i)) {\n                        continue;\n                    }\n\n                    if (!Craft.compare(obj1[i], obj2[i])) {\n                        return false;\n                    }\n                }\n\n                // All clear\n                return true;\n            }\n            else {\n                return (obj1 === obj2);\n            }\n        },\n\n        /**\n         * Returns an array of an object's keys.\n         *\n         * @param {object} obj\n         * @return string\n         */\n        getObjectKeys: function(obj) {\n            var keys = [];\n\n            for (var key in obj) {\n                if (!obj.hasOwnProperty(key)) {\n                    continue;\n                }\n\n                keys.push(key);\n            }\n\n            return keys;\n        },\n\n        /**\n         * Takes an array or string of chars, and places a backslash before each one, returning the combined string.\n         *\n         * Userd by ltrim() and rtrim()\n         *\n         * @param {string|object} chars\n         * @return string\n         */\n        escapeChars: function(chars) {\n            if (!Garnish.isArray(chars)) {\n                chars = chars.split();\n            }\n\n            var escaped = '';\n\n            for (var i = 0; i < chars.length; i++) {\n                escaped += \"\\\\\" + chars[i];\n            }\n\n            return escaped;\n        },\n\n        /**\n         * Trim characters off of the beginning of a string.\n         *\n         * @param {string} str\n         * @param {string|object|undefined} chars The characters to trim off. Defaults to a space if left blank.\n         * @return string\n         */\n        ltrim: function(str, chars) {\n            if (!str) {\n                return str;\n            }\n            if (typeof chars === 'undefined') {\n                chars = ' \\t\\n\\r\\0\\x0B';\n            }\n            var re = new RegExp('^[' + Craft.escapeChars(chars) + ']+');\n            return str.replace(re, '');\n        },\n\n        /**\n         * Trim characters off of the end of a string.\n         *\n         * @param {string} str\n         * @param {string|object|undefined} chars The characters to trim off. Defaults to a space if left blank.\n         * @return string\n         */\n        rtrim: function(str, chars) {\n            if (!str) {\n                return str;\n            }\n            if (typeof chars === 'undefined') {\n                chars = ' \\t\\n\\r\\0\\x0B';\n            }\n            var re = new RegExp('[' + Craft.escapeChars(chars) + ']+$');\n            return str.replace(re, '');\n        },\n\n        /**\n         * Trim characters off of the beginning and end of a string.\n         *\n         * @param {string} str\n         * @param {string|object|undefined} chars The characters to trim off. Defaults to a space if left blank.\n         * @return string\n         */\n        trim: function(str, chars) {\n            str = Craft.ltrim(str, chars);\n            str = Craft.rtrim(str, chars);\n            return str;\n        },\n\n        /**\n         * Returns whether a string starts with another string.\n         *\n         * @param {string} str\n         * @param {string} substr\n         * @return boolean\n         */\n        startsWith: function(str, substr) {\n            return str.substr(0, substr.length) === substr;\n        },\n\n        /**\n         * Filters an array.\n         *\n         * @param {object} arr\n         * @param {function} callback A user-defined callback function. If null, we'll just remove any elements that equate to false.\n         * @return array\n         */\n        filterArray: function(arr, callback) {\n            var filtered = [];\n\n            for (var i = 0; i < arr.length; i++) {\n                var include;\n\n                if (typeof callback === 'function') {\n                    include = callback(arr[i], i);\n                }\n                else {\n                    include = arr[i];\n                }\n\n                if (include) {\n                    filtered.push(arr[i]);\n                }\n            }\n\n            return filtered;\n        },\n\n        /**\n         * Returns whether an element is in an array (unlike jQuery.inArray(), which returns the element's index, or -1).\n         *\n         * @param elem\n         * @param arr\n         * @return boolean\n         */\n        inArray: function(elem, arr) {\n            return ($.inArray(elem, arr) !== -1);\n        },\n\n        /**\n         * Removes an element from an array.\n         *\n         * @param elem\n         * @param {object} arr\n         * @return boolean Whether the element could be found or not.\n         */\n        removeFromArray: function(elem, arr) {\n            var index = $.inArray(elem, arr);\n            if (index !== -1) {\n                arr.splice(index, 1);\n                return true;\n            }\n            else {\n                return false;\n            }\n        },\n\n        /**\n         * Returns the last element in an array.\n         *\n         * @param {object} arr\n         * @return mixed\n         */\n        getLast: function(arr) {\n            if (!arr.length) {\n                return null;\n            } else {\n                return arr[arr.length - 1];\n            }\n        },\n\n        /**\n         * Makes the first character of a string uppercase.\n         *\n         * @param {string} str\n         * @return string\n         */\n        uppercaseFirst: function(str) {\n            return str.charAt(0).toUpperCase() + str.slice(1);\n        },\n\n        /**\n         * Makes the first character of a string lowercase.\n         *\n         * @param {string} str\n         * @return string\n         */\n        lowercaseFirst: function(str) {\n            return str.charAt(0).toLowerCase() + str.slice(1);\n        },\n\n        parseUrl: function(url) {\n            var m = url.match(/^(?:(https?):\\/\\/|\\/\\/)([^\\/\\:]*)(?:\\:(\\d+))?(\\/[^\\?]*)?(?:\\?([^#]*))?(#.*)?/);\n            if (!m) {\n                return {};\n            }\n            return {\n                scheme: m[1],\n                host: m[2] + (m[3] ? ':' + m[3] : ''),\n                hostname: m[2],\n                port: m[3] || null,\n                path: m[4] || '/',\n                query: m[5] || null,\n                hash: m[6] || null,\n            };\n        },\n\n        isSameHost: function(url) {\n            var requestUrlInfo = this.parseUrl(document.location.href);\n            if (!requestUrlInfo) {\n                return false;\n            }\n            var urlInfo = this.parseUrl(url);\n            if (!urlInfo) {\n                return false;\n            }\n            return requestUrlInfo.host === urlInfo.host;\n        },\n\n        /**\n         * Converts a number of seconds into a human-facing time duration.\n         */\n        secondsToHumanTimeDuration: function(seconds, showSeconds) {\n            if (typeof showSeconds === 'undefined') {\n                showSeconds = true;\n            }\n\n            var secondsInWeek = 604800,\n                secondsInDay = 86400,\n                secondsInHour = 3600,\n                secondsInMinute = 60;\n\n            var weeks = Math.floor(seconds / secondsInWeek);\n            seconds = seconds % secondsInWeek;\n\n            var days = Math.floor(seconds / secondsInDay);\n            seconds = seconds % secondsInDay;\n\n            var hours = Math.floor(seconds / secondsInHour);\n            seconds = seconds % secondsInHour;\n\n            var minutes;\n\n            if (showSeconds) {\n                minutes = Math.floor(seconds / secondsInMinute);\n                seconds = seconds % secondsInMinute;\n            }\n            else {\n                minutes = Math.round(seconds / secondsInMinute);\n                seconds = 0;\n            }\n\n            var timeComponents = [];\n\n            if (weeks) {\n                timeComponents.push(weeks + ' ' + (weeks === 1 ? Craft.t('app', 'week') : Craft.t('app', 'weeks')));\n            }\n\n            if (days) {\n                timeComponents.push(days + ' ' + (days === 1 ? Craft.t('app', 'day') : Craft.t('app', 'days')));\n            }\n\n            if (hours) {\n                timeComponents.push(hours + ' ' + (hours === 1 ? Craft.t('app', 'hour') : Craft.t('app', 'hours')));\n            }\n\n            if (minutes || (!showSeconds && !weeks && !days && !hours)) {\n                timeComponents.push(minutes + ' ' + (minutes === 1 ? Craft.t('app', 'minute') : Craft.t('app', 'minutes')));\n            }\n\n            if (seconds || (showSeconds && !weeks && !days && !hours && !minutes)) {\n                timeComponents.push(seconds + ' ' + (seconds === 1 ? Craft.t('app', 'second') : Craft.t('app', 'seconds')));\n            }\n\n            return timeComponents.join(', ');\n        },\n\n        /**\n         * Converts extended ASCII characters to ASCII.\n         *\n         * @param {string} str\n         * @param {object|undefined} charMap\n         * @return string\n         */\n        asciiString: function(str, charMap) {\n            var asciiStr = '';\n            var char;\n\n            for (var i = 0; i < str.length; i++) {\n                char = str.charAt(i);\n                asciiStr += (charMap || Craft.asciiCharMap)[char] || char;\n            }\n\n            return asciiStr;\n        },\n\n        randomString: function(length) {\n            // h/t https://stackoverflow.com/a/1349426/1688568\n            var result = '';\n            var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\n            for (var i = 0; i < length; i++) {\n                result += characters.charAt(Math.floor(Math.random() * 62));\n            }\n            return result;\n        },\n\n        /**\n         * Prevents the outline when an element is focused by the mouse.\n         *\n         * @param elem Either an actual element or a jQuery collection.\n         */\n        preventOutlineOnMouseFocus: function(elem) {\n            var $elem = $(elem),\n                namespace = '.preventOutlineOnMouseFocus';\n\n            $elem.on('mousedown' + namespace, function() {\n                    $elem.addClass('no-outline');\n                    $elem.trigger('focus');\n                })\n                .on('keydown' + namespace + ' blur' + namespace, function(event) {\n                    if (event.keyCode !== Garnish.SHIFT_KEY && event.keyCode !== Garnish.CTRL_KEY && event.keyCode !== Garnish.CMD_KEY) {\n                        $elem.removeClass('no-outline');\n                    }\n                });\n        },\n\n        /**\n         * Creates a validation error list.\n         *\n         * @param {object} errors\n         * @return jQuery\n         */\n        createErrorList: function(errors) {\n            var $ul = $(document.createElement('ul')).addClass('errors');\n\n            for (var i = 0; i < errors.length; i++) {\n                var $li = $(document.createElement('li'));\n                $li.appendTo($ul);\n                $li.html(errors[i]);\n            }\n\n            return $ul;\n        },\n\n        appendHeadHtml: function(html) {\n            if (!html) {\n                return;\n            }\n\n            // Prune out any link tags that are already included\n            var $existingCss = $('link[href]');\n\n            if ($existingCss.length) {\n                var existingCss = [];\n                var href;\n\n                for (var i = 0; i < $existingCss.length; i++) {\n                    href = $existingCss.eq(i).attr('href').replace(/&/g, '&amp;');\n                    existingCss.push(Craft.escapeRegex(href));\n                }\n\n                var regexp = new RegExp('<link\\\\s[^>]*href=\"(?:' + existingCss.join('|') + ')\".*?></script>', 'g');\n\n                html = html.replace(regexp, '');\n            }\n\n            $('head').append(html);\n        },\n\n        appendFootHtml: function(html) {\n            if (!html) {\n                return;\n            }\n\n            // Prune out any script tags that are already included\n            var $existingJs = $('script[src]');\n\n            if ($existingJs.length) {\n                var existingJs = [];\n                var src;\n\n                for (var i = 0; i < $existingJs.length; i++) {\n                    src = $existingJs.eq(i).attr('src').replace(/&/g, '&amp;');\n                    existingJs.push(Craft.escapeRegex(src));\n                }\n\n                var regexp = new RegExp('<script\\\\s[^>]*src=\"(?:' + existingJs.join('|') + ')\".*?></script>', 'g');\n\n                html = html.replace(regexp, '');\n            }\n\n            Garnish.$bod.append(html);\n        },\n\n        /**\n         * Initializes any common UI elements in a given container.\n         *\n         * @param {object} $container\n         */\n        initUiElements: function($container) {\n            $('.grid', $container).grid();\n            $('.info', $container).infoicon();\n            $('.checkbox-select', $container).checkboxselect();\n            $('.fieldtoggle', $container).fieldtoggle();\n            $('.lightswitch', $container).lightswitch();\n            $('.nicetext', $container).nicetext();\n            $('.pill', $container).pill();\n            $('.formsubmit', $container).formsubmit();\n            $('.menubtn', $container).menubtn();\n        },\n\n        _elementIndexClasses: {},\n        _elementSelectorModalClasses: {},\n        _elementEditorClasses: {},\n\n        /**\n         * Registers an element index class for a given element type.\n         *\n         * @param {string} elementType\n         * @param {function} func\n         */\n        registerElementIndexClass: function(elementType, func) {\n            if (typeof this._elementIndexClasses[elementType] !== 'undefined') {\n                throw 'An element index class has already been registered for the element type \u201c' + elementType + '\u201d.';\n            }\n\n            this._elementIndexClasses[elementType] = func;\n        },\n\n        /**\n         * Registers an element selector modal class for a given element type.\n         *\n         * @param {string} elementType\n         * @param {function} func\n         */\n        registerElementSelectorModalClass: function(elementType, func) {\n            if (typeof this._elementSelectorModalClasses[elementType] !== 'undefined') {\n                throw 'An element selector modal class has already been registered for the element type \u201c' + elementType + '\u201d.';\n            }\n\n            this._elementSelectorModalClasses[elementType] = func;\n        },\n\n        /**\n         * Registers an element editor class for a given element type.\n         *\n         * @param {string} elementType\n         * @param {function} func\n         */\n        registerElementEditorClass: function(elementType, func) {\n            if (typeof this._elementEditorClasses[elementType] !== 'undefined') {\n                throw 'An element editor class has already been registered for the element type \u201c' + elementType + '\u201d.';\n            }\n\n            this._elementEditorClasses[elementType] = func;\n        },\n\n        /**\n         * Creates a new element index for a given element type.\n         *\n         * @param {string} elementType\n         * @param $container\n         * @param {object} settings\n         * @return BaseElementIndex\n         */\n        createElementIndex: function(elementType, $container, settings) {\n            var func;\n\n            if (typeof this._elementIndexClasses[elementType] !== 'undefined') {\n                func = this._elementIndexClasses[elementType];\n            }\n            else {\n                func = Craft.BaseElementIndex;\n            }\n\n            return new func(elementType, $container, settings);\n        },\n\n        /**\n         * Creates a new element selector modal for a given element type.\n         *\n         * @param {string} elementType\n         * @param {object} settings\n         */\n        createElementSelectorModal: function(elementType, settings) {\n            var func;\n\n            if (typeof this._elementSelectorModalClasses[elementType] !== 'undefined') {\n                func = this._elementSelectorModalClasses[elementType];\n            }\n            else {\n                func = Craft.BaseElementSelectorModal;\n            }\n\n            return new func(elementType, settings);\n        },\n\n        /**\n         * Creates a new element editor HUD for a given element type.\n         *\n         * @param {string} elementType\n         * @param element $element\n         * @param {object} settings\n         */\n        createElementEditor: function(elementType, element, settings) {\n            var func;\n\n            if (typeof this._elementEditorClasses[elementType] !== 'undefined') {\n                func = this._elementEditorClasses[elementType];\n            }\n            else {\n                func = Craft.BaseElementEditor;\n            }\n\n            return new func(element, settings);\n        },\n\n        /**\n         * Retrieves a value from localStorage if it exists.\n         *\n         * @param {string} key\n         * @param defaultValue\n         */\n        getLocalStorage: function(key, defaultValue) {\n            key = 'Craft-' + Craft.systemUid + '.' + key;\n\n            if (typeof localStorage !== 'undefined' && typeof localStorage[key] !== 'undefined') {\n                return JSON.parse(localStorage[key]);\n            }\n            else {\n                return defaultValue;\n            }\n        },\n\n        /**\n         * Saves a value to localStorage.\n         *\n         * @param {string} key\n         * @param value\n         */\n        setLocalStorage: function(key, value) {\n            if (typeof localStorage !== 'undefined') {\n                key = 'Craft-' + Craft.systemUid + '.' + key;\n\n                // localStorage might be filled all the way up.\n                // Especially likely if this is a private window in Safari 8+, where localStorage technically exists,\n                // but has a max size of 0 bytes.\n                try {\n                    localStorage[key] = JSON.stringify(value);\n                }\n                catch (e) {\n                }\n            }\n        },\n\n        /**\n         * Returns element information from it's HTML.\n         *\n         * @param element\n         * @returns object\n         */\n        getElementInfo: function(element) {\n            var $element = $(element);\n\n            if (!$element.hasClass('element')) {\n                $element = $element.find('.element:first');\n            }\n\n            return {\n                id: $element.data('id'),\n                siteId: $element.data('site-id'),\n                label: $element.data('label'),\n                status: $element.data('status'),\n                url: $element.data('url'),\n                hasThumb: $element.hasClass('hasthumb'),\n                $element: $element\n            };\n        },\n\n        /**\n         * Changes an element to the requested size.\n         *\n         * @param element\n         * @param size\n         */\n        setElementSize: function(element, size) {\n            var $element = $(element);\n\n            if (size !== 'small' && size !== 'large') {\n                size = 'small';\n            }\n\n            if ($element.hasClass(size)) {\n                return;\n            }\n\n            var otherSize = (size === 'small' ? 'large' : 'small');\n\n            $element\n                .addClass(size)\n                .removeClass(otherSize);\n\n            if ($element.hasClass('hasthumb')) {\n                var $oldImg = $element.find('> .elementthumb > img'),\n                    imgSize = (size === 'small' ? '30' : '100'),\n                    $newImg = $('<img/>', {\n                        sizes: imgSize + 'px',\n                        srcset: $oldImg.attr('srcset') || $oldImg.attr('data-pfsrcset')\n                    });\n\n                $oldImg.replaceWith($newImg);\n\n                picturefill({\n                    elements: [$newImg[0]]\n                });\n            }\n        }\n    });\n\n\n// -------------------------------------------\n//  Custom jQuery plugins\n// -------------------------------------------\n\n$.extend($.fn,\n    {\n        animateLeft: function(pos, duration, easing, complete) {\n            if (Craft.orientation === 'ltr') {\n                return this.velocity({left: pos}, duration, easing, complete);\n            }\n            else {\n                return this.velocity({right: pos}, duration, easing, complete);\n            }\n        },\n\n        animateRight: function(pos, duration, easing, complete) {\n            if (Craft.orientation === 'ltr') {\n                return this.velocity({right: pos}, duration, easing, complete);\n            }\n            else {\n                return this.velocity({left: pos}, duration, easing, complete);\n            }\n        },\n\n        /**\n         * Disables elements by adding a .disabled class and preventing them from receiving focus.\n         */\n        disable: function() {\n            return this.each(function() {\n                var $elem = $(this);\n                $elem.addClass('disabled');\n\n                if ($elem.data('activatable')) {\n                    $elem.removeAttr('tabindex');\n                }\n            });\n        },\n\n        /**\n         * Enables elements by removing their .disabled class and allowing them to receive focus.\n         */\n        enable: function() {\n            return this.each(function() {\n                var $elem = $(this);\n                $elem.removeClass('disabled');\n\n                if ($elem.data('activatable')) {\n                    $elem.attr('tabindex', '0');\n                }\n            });\n        },\n\n        /**\n         * Sets the element as the container of a grid.\n         */\n        grid: function() {\n            return this.each(function() {\n                var $container = $(this),\n                    settings = {};\n\n                if ($container.data('item-selector')) {\n                    settings.itemSelector = $container.data('item-selector');\n                }\n                if ($container.data('cols')) {\n                    settings.cols = parseInt($container.data('cols'));\n                }\n                if ($container.data('max-cols')) {\n                    settings.maxCols = parseInt($container.data('max-cols'));\n                }\n                if ($container.data('min-col-width')) {\n                    settings.minColWidth = parseInt($container.data('min-col-width'));\n                }\n                if ($container.data('mode')) {\n                    settings.mode = $container.data('mode');\n                }\n                if ($container.data('fill-mode')) {\n                    settings.fillMode = $container.data('fill-mode');\n                }\n                if ($container.data('col-class')) {\n                    settings.colClass = $container.data('col-class');\n                }\n                if ($container.data('snap-to-grid')) {\n                    settings.snapToGrid = !!$container.data('snap-to-grid');\n                }\n\n                new Craft.Grid(this, settings);\n            });\n        },\n\n        infoicon: function() {\n            return this.each(function() {\n                new Craft.InfoIcon(this);\n            });\n        },\n\n        /**\n         * Sets the element as a container for a checkbox select.\n         */\n        checkboxselect: function() {\n            return this.each(function() {\n                if (!$.data(this, 'checkboxselect')) {\n                    new Garnish.CheckboxSelect(this);\n                }\n            });\n        },\n\n        /**\n         * Sets the element as a field toggle trigger.\n         */\n        fieldtoggle: function() {\n            return this.each(function() {\n                if (!$.data(this, 'fieldtoggle')) {\n                    new Craft.FieldToggle(this);\n                }\n            });\n        },\n\n        lightswitch: function(settings, settingName, settingValue) {\n            // param mapping\n            if (settings === 'settings') {\n                if (typeof settingName === 'string') {\n                    settings = {};\n                    settings[settingName] = settingValue;\n                }\n                else {\n                    settings = settingName;\n                }\n\n                return this.each(function() {\n                    var obj = $.data(this, 'lightswitch');\n                    if (obj) {\n                        obj.setSettings(settings);\n                    }\n                });\n            }\n            else {\n                if (!$.isPlainObject(settings)) {\n                    settings = {};\n                }\n\n                return this.each(function() {\n                    var thisSettings = $.extend({}, settings);\n\n                    if (Garnish.hasAttr(this, 'data-value')) {\n                        thisSettings.value = $(this).attr('data-value');\n                    }\n\n                    if (!$.data(this, 'lightswitch')) {\n                        new Craft.LightSwitch(this, thisSettings);\n                    }\n                });\n            }\n        },\n\n        nicetext: function() {\n            return this.each(function() {\n                if (!$.data(this, 'nicetext')) {\n                    new Garnish.NiceText(this);\n                }\n            });\n        },\n\n        pill: function() {\n            return this.each(function() {\n                if (!$.data(this, 'pill')) {\n                    new Garnish.Pill(this);\n                }\n            });\n        },\n\n        formsubmit: function() {\n            // Secondary form submit buttons\n            this.on('click', function(ev) {\n                var $btn = $(ev.currentTarget);\n\n                if ($btn.attr('data-confirm')) {\n                    if (!confirm($btn.attr('data-confirm'))) {\n                        return;\n                    }\n                }\n\n                var $anchor = $btn.data('menu') ? $btn.data('menu').$anchor : $btn;\n                var $form = $anchor.attr('data-form') ? $('#'+$anchor.attr('data-form')) : $anchor.closest('form');\n\n                if ($btn.data('action')) {\n                    $('<input type=\"hidden\" name=\"action\"/>')\n                        .val($btn.data('action'))\n                        .appendTo($form);\n                }\n\n                if ($btn.data('redirect')) {\n                    $('<input type=\"hidden\" name=\"redirect\"/>')\n                        .val($btn.data('redirect'))\n                        .appendTo($form);\n                }\n\n                if ($btn.data('param')) {\n                    $('<input type=\"hidden\"/>')\n                        .attr({\n                            name: $btn.data('param'),\n                            value: $btn.data('value')\n                        })\n                        .appendTo($form);\n                }\n\n                $form.trigger({\n                    type: 'submit',\n                    customTrigger: $btn,\n                });\n            });\n        },\n\n        menubtn: function() {\n            return this.each(function() {\n                var $btn = $(this);\n\n                if (!$btn.data('menubtn') && $btn.next().hasClass('menu')) {\n                    var settings = {};\n\n                    if ($btn.data('menu-anchor')) {\n                        settings.menuAnchor = $btn.data('menu-anchor');\n                    }\n\n                    new Garnish.MenuBtn($btn, settings);\n                }\n            });\n        }\n    });\n\n\nGarnish.$doc.ready(function() {\n    Craft.initUiElements();\n});\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Element editor\n */\nCraft.BaseElementEditor = Garnish.Base.extend(\n    {\n        $element: null,\n        elementId: null,\n        siteId: null,\n\n        $form: null,\n        $fieldsContainer: null,\n        $cancelBtn: null,\n        $saveBtn: null,\n        $spinner: null,\n\n        $siteSelect: null,\n        $siteSpinner: null,\n\n        hud: null,\n\n        init: function(element, settings) {\n            // Param mapping\n            if (typeof settings === 'undefined' && $.isPlainObject(element)) {\n                // (settings)\n                settings = element;\n                element = null;\n            }\n\n            this.$element = $(element);\n            this.setSettings(settings, Craft.BaseElementEditor.defaults);\n\n            this.loadHud();\n        },\n\n        setElementAttribute: function(name, value) {\n            if (!this.settings.attributes) {\n                this.settings.attributes = {};\n            }\n\n            if (value === null) {\n                delete this.settings.attributes[name];\n            }\n            else {\n                this.settings.attributes[name] = value;\n            }\n        },\n\n        getBaseData: function() {\n            var data = $.extend({}, this.settings.params);\n\n            if (this.settings.siteId) {\n                data.siteId = this.settings.siteId;\n            }\n            else if (this.$element && this.$element.data('site-id')) {\n                data.siteId = this.$element.data('site-id');\n            }\n\n            if (this.settings.elementId) {\n                data.elementId = this.settings.elementId;\n            }\n            else if (this.$element && this.$element.data('id')) {\n                data.elementId = this.$element.data('id');\n            }\n\n            if (this.settings.elementType) {\n                data.elementType = this.settings.elementType;\n            }\n\n            if (this.settings.attributes) {\n                data.attributes = this.settings.attributes;\n            }\n\n            if (this.settings.prevalidate) {\n                data.prevalidate = 1;\n            }\n\n            return data;\n        },\n\n        loadHud: function() {\n            this.onBeginLoading();\n            var data = this.getBaseData();\n            data.includeSites = Craft.isMultiSite && this.settings.showSiteSwitcher;\n            Craft.postActionRequest('elements/get-editor-html', data, $.proxy(this, 'showHud'));\n        },\n\n        showHud: function(response, textStatus) {\n            this.onEndLoading();\n\n            if (textStatus === 'success') {\n                var $hudContents = $();\n\n                if (response.sites) {\n                    var $header = $('<div class=\"hud-header\"/>');\n\n                    if (response.sites.length === 1) {\n                        $('<h5/>', {text: response.sites[0].name}).appendTo($header);;\n                    } else {\n                        var $siteSelectContainer = $('<div class=\"select\"/>').appendTo($header);\n\n                        this.$siteSelect = $('<select/>').appendTo($siteSelectContainer);\n                        this.$siteSpinner = $('<div class=\"spinner hidden\"/>').appendTo($header);\n\n                        for (var i = 0; i < response.sites.length; i++) {\n                            var siteInfo = response.sites[i];\n                            $('<option value=\"' + siteInfo.id + '\"' + (siteInfo.id == response.siteId ? ' selected=\"selected\"' : '') + '>' + siteInfo.name + '</option>').appendTo(this.$siteSelect);\n                        }\n\n                        this.addListener(this.$siteSelect, 'change', 'switchSite');\n                    }\n\n                    $hudContents = $hudContents.add($header);\n                }\n\n                this.$form = $('<div/>');\n                this.$fieldsContainer = $('<div class=\"fields\"/>').appendTo(this.$form);\n\n                this.updateForm(response);\n\n                this.onCreateForm(this.$form);\n\n                var $footer = $('<div class=\"hud-footer\"/>').appendTo(this.$form),\n                    $buttonsContainer = $('<div class=\"buttons right\"/>').appendTo($footer);\n                this.$cancelBtn = $('<div class=\"btn\">' + Craft.t('app', 'Cancel') + '</div>').appendTo($buttonsContainer);\n                this.$saveBtn = $('<input class=\"btn submit\" type=\"submit\" value=\"' + Craft.t('app', 'Save') + '\"/>').appendTo($buttonsContainer);\n                this.$spinner = $('<div class=\"spinner hidden\"/>').appendTo($buttonsContainer);\n\n                $hudContents = $hudContents.add(this.$form);\n\n                if (!this.hud) {\n                    var hudTrigger = (this.settings.hudTrigger || this.$element);\n\n                    this.hud = new Garnish.HUD(hudTrigger, $hudContents, {\n                        bodyClass: 'body elementeditor',\n                        closeOtherHUDs: false,\n                        onShow: $.proxy(this, 'onShowHud'),\n                        onHide: $.proxy(this, 'onHideHud'),\n                        onSubmit: $.proxy(this, 'saveElement')\n                    });\n\n                    this.hud.$hud.data('elementEditor', this);\n\n                    this.hud.on('hide', $.proxy(function() {\n                        delete this.hud;\n                    }, this));\n                }\n                else {\n                    this.hud.updateBody($hudContents);\n                    this.hud.updateSizeAndPosition();\n                }\n\n                // Focus on the first text input\n                $hudContents.find('.text:first').trigger('focus');\n\n                this.addListener(this.$cancelBtn, 'click', function() {\n                    this.hud.hide();\n                });\n            }\n        },\n\n        switchSite: function() {\n            var newSiteId = this.$siteSelect.val();\n\n            if (newSiteId == this.siteId) {\n                return;\n            }\n\n            this.$siteSpinner.removeClass('hidden');\n\n            this.reloadForm({ siteId: newSiteId }, $.proxy(function(textStatus) {\n                this.$siteSpinner.addClass('hidden');\n                if (textStatus !== 'success') {\n                    // Reset the site select\n                    this.$siteSelect.val(this.siteId);\n                }\n            }, this));\n        },\n\n        reloadForm: function(data, callback) {\n            data = $.extend(this.getBaseData(), data);\n\n            Craft.postActionRequest('elements/get-editor-html', data, $.proxy(function(response, textStatus) {\n                if (textStatus === 'success') {\n                    this.updateForm(response);\n                }\n\n                if (callback) {\n                    callback(textStatus);\n                }\n            }, this));\n        },\n\n        updateForm: function(response) {\n            this.siteId = response.siteId;\n\n            this.$fieldsContainer.html(response.html);\n\n            // Swap any instruction text with info icons\n            var $instructions = this.$fieldsContainer.find('> .meta > .field > .heading > .instructions');\n\n            for (var i = 0; i < $instructions.length; i++) {\n\n                $instructions.eq(i)\n                    .replaceWith($('<span/>', {\n                        'class': 'info',\n                        'html': $instructions.eq(i).children().html()\n                    }))\n                    .infoicon();\n            }\n\n            Garnish.requestAnimationFrame($.proxy(function() {\n                Craft.appendHeadHtml(response.headHtml);\n                Craft.appendFootHtml(response.footHtml);\n                Craft.initUiElements(this.$fieldsContainer);\n            }, this));\n        },\n\n        saveElement: function() {\n            var validators = this.settings.validators;\n\n            if ($.isArray(validators)) {\n                for (var i = 0; i < validators.length; i++) {\n                    if ($.isFunction(validators[i]) && !validators[i].call()) {\n                        return false;\n                    }\n                }\n            }\n\n            this.$spinner.removeClass('hidden');\n\n            var data = $.param(this.getBaseData()) + '&' + this.hud.$body.serialize();\n            Craft.postActionRequest('elements/save-element', data, $.proxy(function(response, textStatus) {\n                this.$spinner.addClass('hidden');\n\n                if (textStatus === 'success') {\n                    if (response.success) {\n                        if (this.$element && this.siteId == this.$element.data('site-id')) {\n                            // Update the label\n                            var $title = this.$element.find('.title'),\n                                $a = $title.find('a');\n\n                            if ($a.length && response.cpEditUrl) {\n                                $a.attr('href', response.cpEditUrl);\n                                $a.text(response.newTitle);\n                            }\n                            else {\n                                $title.text(response.newTitle);\n                            }\n                        }\n\n                        this.closeHud();\n                        this.onSaveElement(response);\n                    }\n                    else {\n                        this.updateForm(response);\n                        Garnish.shake(this.hud.$hud);\n                    }\n                }\n            }, this));\n        },\n\n        closeHud: function() {\n            this.hud.hide();\n            delete this.hud;\n        },\n\n        // Events\n        // -------------------------------------------------------------------------\n\n        onShowHud: function() {\n            this.settings.onShowHud();\n            this.trigger('showHud');\n        },\n\n        onHideHud: function() {\n            this.settings.onHideHud();\n            this.trigger('hideHud');\n        },\n\n        onBeginLoading: function() {\n            if (this.$element) {\n                this.$element.addClass('loading');\n            }\n\n            this.settings.onBeginLoading();\n            this.trigger('beginLoading');\n        },\n\n        onEndLoading: function() {\n            if (this.$element) {\n                this.$element.removeClass('loading');\n            }\n\n            this.settings.onEndLoading();\n            this.trigger('endLoading');\n        },\n\n        onSaveElement: function(response) {\n            this.settings.onSaveElement(response);\n            this.trigger('saveElement', {\n                response: response\n            });\n\n            // There may be a new background job that needs to be run\n            Craft.cp.runQueue();\n        },\n\n        onCreateForm: function($form) {\n            this.settings.onCreateForm($form);\n        }\n    },\n    {\n        defaults: {\n            hudTrigger: null,\n            showSiteSwitcher: true,\n            elementId: null,\n            elementType: null,\n            siteId: null,\n            attributes: null,\n            params: null,\n            prevalidate: false,\n            elementIndex: null,\n\n            onShowHud: $.noop,\n            onHideHud: $.noop,\n            onBeginLoading: $.noop,\n            onEndLoading: $.noop,\n            onCreateForm: $.noop,\n            onSaveElement: $.noop,\n\n            validators: []\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Element index class\n */\nCraft.BaseElementIndex = Garnish.Base.extend(\n    {\n        // Properties\n        // =========================================================================\n\n        initialized: false,\n        elementType: null,\n\n        instanceState: null,\n        sourceStates: null,\n        sourceStatesStorageKey: null,\n\n        searchTimeout: null,\n        sourceSelect: null,\n\n        $container: null,\n        $main: null,\n        $mainSpinner: null,\n        isIndexBusy: false,\n\n        $sidebar: null,\n        showingSidebar: null,\n        sourceKey: null,\n        sourceViewModes: null,\n        $source: null,\n        sourcesByKey: null,\n        $visibleSources: null,\n\n        $customizeSourcesBtn: null,\n        customizeSourcesModal: null,\n\n        $toolbar: null,\n        $toolbarFlexContainer: null,\n        toolbarOffset: null,\n\n        $search: null,\n        searching: false,\n        searchText: null,\n        trashed: false,\n        drafts: false,\n        $clearSearchBtn: null,\n\n        $statusMenuBtn: null,\n        $statusMenuContainer: null,\n        statusMenu: null,\n        status: null,\n\n        $siteMenuBtn: null,\n        siteMenu: null,\n        siteId: null,\n\n        $sortMenuBtn: null,\n        sortMenu: null,\n        $sortAttributesList: null,\n        $sortDirectionsList: null,\n        $scoreSortAttribute: null,\n        $structureSortAttribute: null,\n\n        $elements: null,\n        $viewModeBtnContainer: null,\n        viewModeBtns: null,\n        viewMode: null,\n        view: null,\n        _autoSelectElements: null,\n        $countContainer: null,\n        page: 1,\n        $exportBtn: null,\n\n        actions: null,\n        actionsHeadHtml: null,\n        actionsFootHtml: null,\n        $selectAllContainer: null,\n        $selectAllCheckbox: null,\n        showingActionTriggers: false,\n        _$detachedToolbarItems: null,\n        _$triggers: null,\n\n        // Public methods\n        // =========================================================================\n\n        /**\n         * Constructor\n         */\n        init: function(elementType, $container, settings) {\n            this.elementType = elementType;\n            this.$container = $container;\n            this.setSettings(settings, Craft.BaseElementIndex.defaults);\n\n            // Set the state objects\n            // ---------------------------------------------------------------------\n\n            this.instanceState = this.getDefaultInstanceState();\n\n            this.sourceStates = {};\n\n            // Instance states (selected source) are stored by a custom storage key defined in the settings\n            if (this.settings.storageKey) {\n                $.extend(this.instanceState, Craft.getLocalStorage(this.settings.storageKey), {});\n            }\n\n            // Source states (view mode, etc.) are stored by the element type and context\n            this.sourceStatesStorageKey = 'BaseElementIndex.' + this.elementType + '.' + this.settings.context;\n            $.extend(this.sourceStates, Craft.getLocalStorage(this.sourceStatesStorageKey, {}));\n\n            // Find the DOM elements\n            // ---------------------------------------------------------------------\n\n            this.$main = this.$container.find('.main');\n            this.$toolbar = this.$container.find('.toolbar:first');\n            this.$toolbarFlexContainer = this.$toolbar.children('.flex');\n            this.$statusMenuBtn = this.$toolbarFlexContainer.find('.statusmenubtn:first');\n            this.$statusMenuContainer = this.$statusMenuBtn.parent();\n            this.$siteMenuBtn = this.$container.find('.sitemenubtn:first');\n            this.$sortMenuBtn = this.$toolbarFlexContainer.find('.sortmenubtn:first');\n            this.$search = this.$toolbarFlexContainer.find('.search:first input:first');\n            this.$clearSearchBtn = this.$toolbarFlexContainer.find('.search:first > .clear');\n            this.$mainSpinner = this.$toolbarFlexContainer.find('.spinner:first');\n            this.$sidebar = this.$container.find('.sidebar:first');\n            this.$customizeSourcesBtn = this.$sidebar.find('.customize-sources');\n            this.$elements = this.$container.find('.elements:first');\n            this.$countContainer = this.$container.find('#count-container');\n            this.$exportBtn = this.$container.find('#export-btn');\n\n            // Hide sidebar if needed\n            if (this.settings.hideSidebar) {\n                this.$sidebar.hide();\n                $('.body, .content', this.$container).removeClass('has-sidebar');\n            }\n\n            // Keep the toolbar at the top of the window\n            if (\n                (this.settings.toolbarFixed || (this.settings.toolbarFixed === null && this.settings.context === 'index')) &&\n                !Garnish.isMobileBrowser(true)\n            ) {\n                this.addListener(Garnish.$win, 'resize', 'updateFixedToolbar');\n                this.addListener(Garnish.$scrollContainer, 'scroll', 'updateFixedToolbar');\n            }\n\n            // Initialize the sources\n            // ---------------------------------------------------------------------\n\n            if (!this.initSources()) {\n                return;\n            }\n\n            // Customize button\n            if (this.$customizeSourcesBtn.length) {\n                this.addListener(this.$customizeSourcesBtn, 'click', 'createCustomizeSourcesModal');\n            }\n\n            // Initialize the status menu\n            // ---------------------------------------------------------------------\n\n            if (this.$statusMenuBtn.length) {\n                this.statusMenu = this.$statusMenuBtn.menubtn().data('menubtn').menu;\n                this.statusMenu.on('optionselect', $.proxy(this, '_handleStatusChange'));\n            }\n\n            // Initialize the site menu\n            // ---------------------------------------------------------------------\n\n            // Is there a site menu?\n            if (this.$siteMenuBtn.length) {\n                this.siteMenu = this.$siteMenuBtn.menubtn().data('menubtn').menu;\n\n                // Figure out the initial site\n                var $option = this.siteMenu.$options.filter('.sel:first');\n\n                if (!$option.length) {\n                    $option = this.siteMenu.$options.first();\n                }\n\n                if ($option.length) {\n                    this._setSite($option.data('site-id'));\n                } else {\n                    // No site options -- they must not have any site permissions\n                    this.settings.criteria = {id: '0'};\n                }\n\n                this.siteMenu.on('optionselect', $.proxy(this, '_handleSiteChange'));\n\n                if (this.siteId) {\n                    // Do we have a different site stored in localStorage?\n                    var storedSiteId = Craft.getLocalStorage('BaseElementIndex.siteId');\n\n                    if (storedSiteId && storedSiteId != this.siteId) {\n                        // Is that one available here?\n                        var $storedSiteOption = this.siteMenu.$options.filter('[data-site-id=\"' + storedSiteId + '\"]:first');\n\n                        if ($storedSiteOption.length) {\n                            // Todo: switch this to siteMenu.selectOption($storedSiteOption) once Menu is updated to support that\n                            $storedSiteOption.trigger('click');\n                        }\n                    }\n                }\n            } else if (this.settings.criteria && this.settings.criteria.siteId) {\n                this._setSite(this.settings.criteria.siteId);\n            } else {\n                this._setSite(Craft.siteId);\n            }\n\n            // Initialize the search input\n            // ---------------------------------------------------------------------\n\n            // Automatically update the elements after new search text has been sitting for a 1/2 second\n            this.addListener(this.$search, 'textchange', $.proxy(function() {\n                if (!this.searching && this.$search.val()) {\n                    this.startSearching();\n                } else if (this.searching && !this.$search.val()) {\n                    this.stopSearching();\n                }\n\n                if (this.searchTimeout) {\n                    clearTimeout(this.searchTimeout);\n                }\n\n                this.searchTimeout = setTimeout($.proxy(this, 'updateElementsIfSearchTextChanged'), 500);\n            }, this));\n\n            // Update the elements when the Return key is pressed\n            this.addListener(this.$search, 'keypress', $.proxy(function(ev) {\n                if (ev.keyCode === Garnish.RETURN_KEY) {\n                    ev.preventDefault();\n\n                    if (this.searchTimeout) {\n                        clearTimeout(this.searchTimeout);\n                    }\n\n                    this.updateElementsIfSearchTextChanged();\n                }\n            }, this));\n\n            // Clear the search when the X button is clicked\n            this.addListener(this.$clearSearchBtn, 'click', $.proxy(function() {\n                this.$search.val('');\n\n                if (this.searchTimeout) {\n                    clearTimeout(this.searchTimeout);\n                }\n\n                if (!Garnish.isMobileBrowser(true)) {\n                    this.$search.trigger('focus');\n                }\n\n                this.stopSearching();\n\n                this.updateElementsIfSearchTextChanged();\n\n            }, this));\n\n            // Auto-focus the Search box\n            if (!Garnish.isMobileBrowser(true)) {\n                this.$search.trigger('focus');\n            }\n\n            // Initialize the sort menu\n            // ---------------------------------------------------------------------\n\n            // Is there a sort menu?\n            if (this.$sortMenuBtn.length) {\n                this.sortMenu = this.$sortMenuBtn.menubtn().data('menubtn').menu;\n                this.$sortAttributesList = this.sortMenu.$container.children('.sort-attributes');\n                this.$sortDirectionsList = this.sortMenu.$container.children('.sort-directions');\n\n                this.sortMenu.on('optionselect', $.proxy(this, '_handleSortChange'));\n            }\n\n            // Initialize the Export button\n            // ---------------------------------------------------------------------\n\n            this.addListener(this.$exportBtn, 'click', '_showExportHud');\n\n            // Let everyone know that the UI is initialized\n            // ---------------------------------------------------------------------\n\n            this.initialized = true;\n            this.afterInit();\n\n            // Select the initial source\n            // ---------------------------------------------------------------------\n\n            this.selectDefaultSource();\n\n            // Load the first batch of elements!\n            // ---------------------------------------------------------------------\n\n            // Default to whatever page is in the URL\n            if (this.settings.context === 'index') {\n                this.setPage(Craft.pageNum);\n            }\n\n            this.updateElements(true);\n        },\n\n        afterInit: function() {\n            this.onAfterInit();\n        },\n\n        getSourceContainer: function() {\n            return this.$sidebar.find('nav>ul');\n        },\n\n        get $sources() {\n            if (!this.sourceSelect) {\n                return undefined;\n            }\n\n            return this.sourceSelect.$items;\n        },\n\n        initSources: function() {\n            var $sources = this._getSourcesInList(this.getSourceContainer());\n\n            // No source, no party.\n            if ($sources.length === 0) {\n                return false;\n            }\n\n            // The source selector\n            if (!this.sourceSelect) {\n                this.sourceSelect = new Garnish.Select(this.$sidebar.find('nav'), {\n                    multi: false,\n                    allowEmpty: false,\n                    vertical: true,\n                    onSelectionChange: $.proxy(this, '_handleSourceSelectionChange')\n                });\n            }\n\n            this.sourcesByKey = {};\n            this._initSources($sources);\n\n            return true;\n        },\n\n        selectDefaultSource: function() {\n            var sourceKey = this.getDefaultSourceKey(),\n                $source;\n\n            if (sourceKey) {\n                $source = this.getSourceByKey(sourceKey);\n\n                // Make sure it's visible\n                if (this.$visibleSources.index($source) === -1) {\n                    $source = null;\n                }\n            }\n\n            if (!sourceKey || !$source) {\n                // Select the first source by default\n                $source = this.$visibleSources.first();\n            }\n\n            if ($source.length) {\n                this.selectSource($source);\n            }\n        },\n\n        refreshSources: function() {\n            this.sourceSelect.removeAllItems();\n\n            var params = {\n                context: this.settings.context,\n                elementType: this.elementType\n            };\n\n            this.setIndexBusy();\n\n            Craft.postActionRequest(this.settings.refreshSourcesAction, params, $.proxy(function(response, textStatus) {\n                this.setIndexAvailable();\n\n                if (textStatus === 'success') {\n                    this.getSourceContainer().replaceWith(response.html);\n                    this.initSources();\n                    this.selectDefaultSource();\n                } else {\n                    Craft.cp.displayError(Craft.t('app', 'An unknown error occurred.'));\n                }\n\n            }, this));\n        },\n\n        updateFixedToolbar: function(e) {\n            this.updateFixedToolbar._scrollTop = Garnish.$scrollContainer.scrollTop();\n\n            if (Garnish.$win.width() > 992 && this.updateFixedToolbar._scrollTop >= 17) {\n                if (this.updateFixedToolbar._makingFixed = !this.$toolbar.hasClass('fixed')) {\n                    this.$elements.css('padding-top', (this.$toolbar.outerHeight() + 21));\n                    this.$toolbar.addClass('fixed');\n                }\n\n                if (this.updateFixedToolbar._makingFixed || e.type === 'resize') {\n                    this.$toolbar.css({\n                        top: Garnish.$scrollContainer.offset().top,\n                        width: this.$main.width()\n                    });\n                }\n            } else {\n                if (this.$toolbar.hasClass('fixed')) {\n                    this.$toolbar.removeClass('fixed');\n                    this.$toolbar.css('width', '');\n                    this.$elements.css('padding-top', '');\n                    this.$toolbar.css('top', '0');\n                }\n            }\n        },\n\n        initSource: function($source) {\n            this.sourceSelect.addItems($source);\n            this.initSourceToggle($source);\n            this.sourcesByKey[$source.data('key')] = $source;\n\n            if ($source.data('hasNestedSources') && this.instanceState.expandedSources.indexOf($source.data('key')) !== -1) {\n                this._expandSource($source);\n            }\n        },\n\n        initSourceToggle: function($source) {\n            // Remove handlers for the same thing. Just in case.\n            this.deinitSourceToggle($source);\n\n            var $toggle = this._getSourceToggle($source);\n\n            if ($toggle.length) {\n                this.addListener($source, 'dblclick', '_handleSourceDblClick');\n                this.addListener($toggle, 'click', '_handleSourceToggleClick');\n                $source.data('hasNestedSources', true);\n            } else {\n                $source.data('hasNestedSources', false);\n            }\n        },\n\n        deinitSource: function($source) {\n            this.sourceSelect.removeItems($source);\n            this.deinitSourceToggle($source);\n            delete this.sourcesByKey[$source.data('key')];\n        },\n\n        deinitSourceToggle: function($source) {\n            if ($source.data('hasNestedSources')) {\n                this.removeListener($source, 'dblclick');\n                this.removeListener(this._getSourceToggle($source), 'click');\n            }\n\n            $source.removeData('hasNestedSources');\n        },\n\n        getDefaultInstanceState: function() {\n            return {\n                selectedSource: null,\n                expandedSources: []\n            };\n        },\n\n        getDefaultSourceKey: function() {\n            return this.instanceState.selectedSource;\n        },\n\n        getDefaultExpandedSources: function() {\n            return this.instanceState.expandedSources;\n        },\n\n        startSearching: function() {\n            // Show the clear button and add/select the Score sort option\n            this.$clearSearchBtn.removeClass('hidden');\n\n            if (!this.$scoreSortAttribute) {\n                this.$scoreSortAttribute = $('<li><a data-attr=\"score\">' + Craft.t('app', 'Score') + '</a></li>');\n                this.sortMenu.addOptions(this.$scoreSortAttribute.children());\n            }\n\n            this.$scoreSortAttribute.prependTo(this.$sortAttributesList);\n\n            this.searching = true;\n\n            this._updateStructureSortOption();\n            this.setSortAttribute('score');\n        },\n\n        stopSearching: function() {\n            // Hide the clear button and Score sort option\n            this.$clearSearchBtn.addClass('hidden');\n\n            this.$scoreSortAttribute.detach();\n\n            this.searching = false;\n\n            this._updateStructureSortOption();\n        },\n\n        setInstanceState: function(key, value) {\n            if (typeof key === 'object') {\n                $.extend(this.instanceState, key);\n            } else {\n                this.instanceState[key] = value;\n            }\n\n            this.storeInstanceState();\n        },\n\n        storeInstanceState: function() {\n            if (this.settings.storageKey) {\n                Craft.setLocalStorage(this.settings.storageKey, this.instanceState);\n            }\n        },\n\n        getSourceState: function(source, key, defaultValue) {\n            if (typeof this.sourceStates[source] === 'undefined') {\n                // Set it now so any modifications to it by whoever's calling this will be stored.\n                this.sourceStates[source] = {};\n            }\n\n            if (typeof key === 'undefined') {\n                return this.sourceStates[source];\n            } else if (typeof this.sourceStates[source][key] !== 'undefined') {\n                return this.sourceStates[source][key];\n            } else {\n                return (typeof defaultValue !== 'undefined' ? defaultValue : null);\n            }\n        },\n\n        getSelectedSourceState: function(key, defaultValue) {\n            return this.getSourceState(this.instanceState.selectedSource, key, defaultValue);\n        },\n\n        setSelecetedSourceState: function(key, value) {\n            var viewState = this.getSelectedSourceState();\n\n            if (typeof key === 'object') {\n                $.extend(viewState, key);\n            } else {\n                viewState[key] = value;\n            }\n\n            this.sourceStates[this.instanceState.selectedSource] = viewState;\n\n            // Store it in localStorage too\n            Craft.setLocalStorage(this.sourceStatesStorageKey, this.sourceStates);\n        },\n\n        storeSortAttributeAndDirection: function() {\n            var attr = this.getSelectedSortAttribute();\n\n            if (attr !== 'score') {\n                this.setSelecetedSourceState({\n                    order: attr,\n                    sort: this.getSelectedSortDirection()\n                });\n            }\n        },\n\n        /**\n         * Sets the page number.\n         */\n        setPage: function(page) {\n            page = Math.max(page, 1);\n            this.page = page;\n\n            // Update the URL\n            var url = document.location.href\n                .replace(/\\?.*$/, '')\n                .replace(new RegExp('/' + Craft.pageTrigger.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&') + '\\\\d+$'), '')\n                .replace(/\\/+$/, '');\n\n            if (this.page !== 1) {\n                if (Craft.pageTrigger[0] !== '?') {\n                    url += '/';\n                }\n                url += Craft.pageTrigger + this.page;\n            }\n\n            history.replaceState({}, '', url);\n        },\n\n        /**\n         * Returns the data that should be passed to the elementIndex/getElements controller action\n         * when loading elements.\n         */\n        getViewParams: function() {\n            var criteria = {\n                siteId: this.siteId,\n                search: this.searchText,\n                offset: this.settings.batchSize * (this.page - 1),\n                limit: this.settings.batchSize,\n                trashed: this.trashed ? 1 : 0,\n                drafts: this.drafts ? 1 : 0,\n            };\n\n            if (!Garnish.hasAttr(this.$source, 'data-override-status')) {\n                criteria.status = this.status;\n            }\n\n            $.extend(criteria, this.settings.criteria);\n\n            var params = {\n                context: this.settings.context,\n                elementType: this.elementType,\n                source: this.instanceState.selectedSource,\n                criteria: criteria,\n                disabledElementIds: this.settings.disabledElementIds,\n                viewState: $.extend({}, this.getSelectedSourceState()),\n                paginated: this._isViewPaginated() ? 1 : 0,\n            };\n\n            // Possible that the order/sort isn't entirely accurate if we're sorting by Score\n            params.viewState.order = this.getSelectedSortAttribute();\n            params.viewState.sort = this.getSelectedSortDirection();\n\n            if (this.getSelectedSortAttribute() === 'structure') {\n                if (typeof this.instanceState.collapsedElementIds === 'undefined') {\n                    this.instanceState.collapsedElementIds = [];\n                }\n                params.collapsedElementIds = this.instanceState.collapsedElementIds;\n            }\n\n            return params;\n        },\n\n        updateElements: function(preservePagination) {\n            // Ignore if we're not fully initialized yet\n            if (!this.initialized) {\n                return;\n            }\n\n            this.setIndexBusy();\n\n            // Kill the old view class\n            if (this.view) {\n                this.view.destroy();\n                delete this.view;\n            }\n\n            this.$elements.html('');\n\n            if (preservePagination !== true) {\n                this.$countContainer.html('&nbsp;');\n                this.setPage(1);\n            }\n\n            var params = this.getViewParams();\n\n            Craft.postActionRequest(this.settings.updateElementsAction, params, $.proxy(function(response, textStatus) {\n                this.setIndexAvailable();\n\n                if (textStatus === 'success') {\n                    // Have we gone too far?\n                    var totalPages = Math.max(Math.ceil(response.count / this.settings.batchSize), 1);\n                    if (this.page > totalPages) {\n                        this.setPage(totalPages);\n                        this.updateElements(true);\n                        return;\n                    }\n\n                    this._updateView(params, response);\n                } else {\n                    Craft.cp.displayError(Craft.t('app', 'An unknown error occurred.'));\n                }\n\n            }, this));\n        },\n\n        updateElementsIfSearchTextChanged: function() {\n            if (this.searchText !== (this.searchText = this.searching ? this.$search.val() : null)) {\n                this.updateElements();\n            }\n        },\n\n        showActionTriggers: function() {\n            // Ignore if they're already shown\n            if (this.showingActionTriggers) {\n                return;\n            }\n\n            // Hard-code the min toolbar height in case it was taller than the actions toolbar\n            // (prevents the elements from jumping if this ends up being a double-click)\n            this.$toolbar.css('min-height', this.$toolbar.height());\n\n            // Hide any toolbar inputs\n            this._$detachedToolbarItems = this.$toolbarFlexContainer.children().not(this.$selectAllContainer).not(this.$mainSpinner);\n            this._$detachedToolbarItems.detach();\n\n            if (!this._$triggers) {\n                this._createTriggers();\n            } else {\n                this._$triggers.insertAfter(this.$selectAllContainer);\n            }\n\n            this.showingActionTriggers = true;\n        },\n\n        submitAction: function(actionClass, actionParams) {\n            // Make sure something's selected\n            var selectedElementIds = this.view.getSelectedElementIds(),\n                totalSelected = selectedElementIds.length;\n\n            if (totalSelected === 0) {\n                return;\n            }\n\n            // Find the action\n            var action;\n\n            for (var i = 0; i < this.actions.length; i++) {\n                if (this.actions[i].type === actionClass) {\n                    action = this.actions[i];\n                    break;\n                }\n            }\n\n            if (!action || (action.confirm && !confirm(action.confirm))) {\n                return;\n            }\n\n            // Get ready to submit\n            var viewParams = this.getViewParams();\n\n            var params = $.extend(viewParams, actionParams, {\n                elementAction: actionClass,\n                elementIds: selectedElementIds\n            });\n\n            // Do it\n            this.setIndexBusy();\n            this._autoSelectElements = selectedElementIds;\n\n            Craft.postActionRequest(this.settings.submitActionsAction, params, $.proxy(function(response, textStatus) {\n                this.setIndexAvailable();\n\n                if (textStatus === 'success') {\n                    if (response.success) {\n                        this._updateView(viewParams, response);\n\n                        if (response.message) {\n                            Craft.cp.displayNotice(response.message);\n                        }\n\n                        this.afterAction(action, params);\n                    } else {\n                        Craft.cp.displayError(response.message);\n                    }\n                }\n            }, this));\n        },\n\n        afterAction: function(action, params) {\n\n            // There may be a new background job that needs to be run\n            Craft.cp.runQueue();\n\n            this.onAfterAction(action, params);\n        },\n\n        hideActionTriggers: function() {\n            // Ignore if there aren't any\n            if (!this.showingActionTriggers) {\n                return;\n            }\n\n            this._$detachedToolbarItems.insertBefore(this.$mainSpinner);\n            this._$triggers.detach();\n\n            this.$toolbarFlexContainer.children().not(this.$selectAllContainer).removeClass('hidden');\n\n            // Unset the min toolbar height\n            this.$toolbar.css('min-height', '');\n\n            this.showingActionTriggers = false;\n        },\n\n        updateActionTriggers: function() {\n            // Do we have an action UI to update?\n            if (this.actions) {\n                var totalSelected = this.view.getSelectedElements().length;\n\n                if (totalSelected !== 0) {\n                    if (totalSelected === this.view.getEnabledElements().length) {\n                        this.$selectAllCheckbox.removeClass('indeterminate');\n                        this.$selectAllCheckbox.addClass('checked');\n                        this.$selectAllBtn.attr('aria-checked', 'true');\n                    } else {\n                        this.$selectAllCheckbox.addClass('indeterminate');\n                        this.$selectAllCheckbox.removeClass('checked');\n                        this.$selectAllBtn.attr('aria-checked', 'mixed');\n                    }\n\n                    this.showActionTriggers();\n                } else {\n                    this.$selectAllCheckbox.removeClass('indeterminate checked');\n                    this.$selectAllBtn.attr('aria-checked', 'false');\n                    this.hideActionTriggers();\n                }\n            }\n        },\n\n        getSelectedElements: function() {\n            return this.view ? this.view.getSelectedElements() : $();\n        },\n\n        getSelectedElementIds: function() {\n            return this.view ? this.view.getSelectedElementIds() : [];\n        },\n\n        getSortAttributeOption: function(attr) {\n            return this.$sortAttributesList.find('a[data-attr=\"' + attr + '\"]:first');\n        },\n\n        getSelectedSortAttribute: function() {\n            return this.$sortAttributesList.find('a.sel:first').data('attr');\n        },\n\n        setSortAttribute: function(attr) {\n            // Find the option (and make sure it actually exists)\n            var $option = this.getSortAttributeOption(attr);\n\n            if ($option.length) {\n                this.$sortAttributesList.find('a.sel').removeClass('sel');\n                $option.addClass('sel');\n\n                var label = $option.text();\n                this.$sortMenuBtn.attr('title', Craft.t('app', 'Sort by {attribute}', {attribute: label}));\n                this.$sortMenuBtn.text(label);\n\n                this.setSortDirection(attr === 'score' ? 'desc' : 'asc');\n\n                if (attr === 'structure') {\n                    this.$sortDirectionsList.find('a').addClass('disabled');\n                } else {\n                    this.$sortDirectionsList.find('a').removeClass('disabled');\n                }\n            }\n        },\n\n        getSortDirectionOption: function(dir) {\n            return this.$sortDirectionsList.find('a[data-dir=' + dir + ']:first');\n        },\n\n        getSelectedSortDirection: function() {\n            return this.$sortDirectionsList.find('a.sel:first').data('dir');\n        },\n\n        getSelectedViewMode: function() {\n            return this.getSelectedSourceState('mode');\n        },\n\n        setSortDirection: function(dir) {\n            if (dir !== 'desc') {\n                dir = 'asc';\n            }\n\n            this.$sortMenuBtn.attr('data-icon', dir);\n            this.$sortDirectionsList.find('a.sel').removeClass('sel');\n            this.getSortDirectionOption(dir).addClass('sel');\n        },\n\n        getSourceByKey: function(key) {\n            if (typeof this.sourcesByKey[key] === 'undefined') {\n                return null;\n            }\n\n            return this.sourcesByKey[key];\n        },\n\n        selectSource: function($source) {\n            if (!$source || !$source.length) {\n                return false;\n            }\n\n            if (this.$source && this.$source[0] && this.$source[0] === $source[0] && $source.data('key') === this.sourceKey) {\n                return false;\n            }\n\n            // Hide action triggers if they're currently being shown\n            this.hideActionTriggers();\n\n            this.$source = $source;\n            this.sourceKey = $source.data('key');\n            this.setInstanceState('selectedSource', this.sourceKey);\n            this.sourceSelect.selectItem($source);\n\n            Craft.cp.updateSidebarMenuLabel();\n\n            if (this.searching) {\n                // Clear the search value without causing it to update elements\n                this.searchText = null;\n                this.$search.val('');\n                this.stopSearching();\n            }\n\n            // Sort menu\n            // ----------------------------------------------------------------------\n\n            // Does this source have a structure?\n            if (Garnish.hasAttr(this.$source, 'data-has-structure')) {\n                if (!this.$structureSortAttribute) {\n                    this.$structureSortAttribute = $('<li><a data-attr=\"structure\">' + Craft.t('app', 'Structure') + '</a></li>');\n                    this.sortMenu.addOptions(this.$structureSortAttribute.children());\n                }\n\n                this.$structureSortAttribute.prependTo(this.$sortAttributesList);\n            } else if (this.$structureSortAttribute) {\n                this.$structureSortAttribute.removeClass('sel').detach();\n            }\n\n            this.setStoredSortOptionsForSource();\n\n            // Status menu\n            // ----------------------------------------------------------------------\n\n            if (this.$statusMenuBtn.length) {\n                if (Garnish.hasAttr(this.$source, 'data-override-status')) {\n                    this.$statusMenuContainer.addClass('hidden');\n                } else {\n                    this.$statusMenuContainer.removeClass('hidden');\n                }\n            }\n\n            // View mode buttons\n            // ----------------------------------------------------------------------\n\n            // Clear out any previous view mode data\n            if (this.$viewModeBtnContainer) {\n                this.$viewModeBtnContainer.remove();\n            }\n\n            this.viewModeBtns = {};\n            this.viewMode = null;\n\n            // Get the new list of view modes\n            this.sourceViewModes = this.getViewModesForSource();\n\n            // Create the buttons if there's more than one mode available to this source\n            if (this.sourceViewModes.length > 1) {\n                this.$viewModeBtnContainer = $('<div class=\"btngroup\"/>').insertBefore(this.$mainSpinner);\n\n                for (var i = 0; i < this.sourceViewModes.length; i++) {\n                    var sourceViewMode = this.sourceViewModes[i];\n\n                    var $viewModeBtn = $('<div data-view=\"' + sourceViewMode.mode + '\" role=\"button\"' +\n                        ' class=\"btn' + (typeof sourceViewMode.className !== 'undefined' ? ' ' + sourceViewMode.className : '') + '\"' +\n                        ' title=\"' + sourceViewMode.title + '\"' +\n                        (typeof sourceViewMode.icon !== 'undefined' ? ' data-icon=\"' + sourceViewMode.icon + '\"' : '') +\n                        '/>'\n                    ).appendTo(this.$viewModeBtnContainer);\n\n                    this.viewModeBtns[sourceViewMode.mode] = $viewModeBtn;\n\n                    this.addListener($viewModeBtn, 'click', {mode: sourceViewMode.mode}, function(ev) {\n                        this.selectViewMode(ev.data.mode);\n                        this.updateElements();\n                    });\n                }\n            }\n\n            // Figure out which mode we should start with\n            var viewMode = this.getSelectedViewMode();\n\n            if (!viewMode || !this.doesSourceHaveViewMode(viewMode)) {\n                // Try to keep using the current view mode\n                if (this.viewMode && this.doesSourceHaveViewMode(this.viewMode)) {\n                    viewMode = this.viewMode;\n                }\n                // Just use the first one\n                else {\n                    viewMode = this.sourceViewModes[0].mode;\n                }\n            }\n\n            this.selectViewMode(viewMode);\n\n            this.onSelectSource();\n\n            return true;\n        },\n\n        selectSourceByKey: function(key) {\n            var $source = this.getSourceByKey(key);\n\n            if ($source) {\n                return this.selectSource($source);\n            } else {\n                return false;\n            }\n        },\n\n        setStoredSortOptionsForSource: function() {\n            var sortAttr = this.getSelectedSourceState('order'),\n                sortDir = this.getSelectedSourceState('sort');\n\n            if (!sortAttr || !sortDir) {\n                // Get the default\n                sortAttr = this.getDefaultSort();\n\n                if (Garnish.isArray(sortAttr)) {\n                    sortDir = sortAttr[1];\n                    sortAttr = sortAttr[0];\n                }\n            }\n\n            if (sortDir !== 'asc' && sortDir !== 'desc') {\n                sortDir = 'asc';\n            }\n\n            this.setSortAttribute(sortAttr);\n            this.setSortDirection(sortDir);\n        },\n\n        getDefaultSort: function() {\n            // Does the source specify what to do?\n            if (this.$source && Garnish.hasAttr(this.$source, 'data-default-sort')) {\n                return this.$source.attr('data-default-sort').split(':');\n            } else {\n                // Default to whatever's first\n                return [this.$sortAttributesList.find('a:first').data('attr'), 'asc'];\n            }\n        },\n\n        getViewModesForSource: function() {\n            var viewModes = [\n                {mode: 'table', title: Craft.t('app', 'Display in a table'), icon: 'list'}\n            ];\n\n            if (this.$source && Garnish.hasAttr(this.$source, 'data-has-thumbs')) {\n                viewModes.push({mode: 'thumbs', title: Craft.t('app', 'Display as thumbnails'), icon: 'grid'});\n            }\n\n            return viewModes;\n        },\n\n        doesSourceHaveViewMode: function(viewMode) {\n            for (var i = 0; i < this.sourceViewModes.length; i++) {\n                if (this.sourceViewModes[i].mode === viewMode) {\n                    return true;\n                }\n            }\n\n            return false;\n        },\n\n        selectViewMode: function(viewMode, force) {\n            // Make sure that the current source supports it\n            if (!force && !this.doesSourceHaveViewMode(viewMode)) {\n                viewMode = this.sourceViewModes[0].mode;\n            }\n\n            // Has anything changed?\n            if (viewMode === this.viewMode) {\n                return;\n            }\n\n            // Deselect the previous view mode\n            if (this.viewMode && typeof this.viewModeBtns[this.viewMode] !== 'undefined') {\n                this.viewModeBtns[this.viewMode].removeClass('active');\n            }\n\n            this.viewMode = viewMode;\n            this.setSelecetedSourceState('mode', this.viewMode);\n\n            if (typeof this.viewModeBtns[this.viewMode] !== 'undefined') {\n                this.viewModeBtns[this.viewMode].addClass('active');\n            }\n        },\n\n        createView: function(mode, settings) {\n            var viewClass = this.getViewClass(mode);\n            return new viewClass(this, this.$elements, settings);\n        },\n\n        getViewClass: function(mode) {\n            switch (mode) {\n                case 'table':\n                    return Craft.TableElementIndexView;\n                case 'thumbs':\n                    return Craft.ThumbsElementIndexView;\n                default:\n                    throw 'View mode\u00a0\"' + mode + '\" not supported.';\n            }\n        },\n\n        rememberDisabledElementId: function(id) {\n            var index = $.inArray(id, this.settings.disabledElementIds);\n\n            if (index === -1) {\n                this.settings.disabledElementIds.push(id);\n            }\n        },\n\n        forgetDisabledElementId: function(id) {\n            var index = $.inArray(id, this.settings.disabledElementIds);\n\n            if (index !== -1) {\n                this.settings.disabledElementIds.splice(index, 1);\n            }\n        },\n\n        enableElements: function($elements) {\n            $elements.removeClass('disabled').parents('.disabled').removeClass('disabled');\n\n            for (var i = 0; i < $elements.length; i++) {\n                var id = $($elements[i]).data('id');\n                this.forgetDisabledElementId(id);\n            }\n\n            this.onEnableElements($elements);\n        },\n\n        disableElements: function($elements) {\n            $elements.removeClass('sel').addClass('disabled');\n\n            for (var i = 0; i < $elements.length; i++) {\n                var id = $($elements[i]).data('id');\n                this.rememberDisabledElementId(id);\n            }\n\n            this.onDisableElements($elements);\n        },\n\n        getElementById: function(id) {\n            return this.view.getElementById(id);\n        },\n\n        enableElementsById: function(ids) {\n            ids = $.makeArray(ids);\n\n            for (var i = 0; i < ids.length; i++) {\n                var id = ids[i],\n                    $element = this.getElementById(id);\n\n                if ($element && $element.length) {\n                    this.enableElements($element);\n                } else {\n                    this.forgetDisabledElementId(id);\n                }\n            }\n        },\n\n        disableElementsById: function(ids) {\n            ids = $.makeArray(ids);\n\n            for (var i = 0; i < ids.length; i++) {\n                var id = ids[i],\n                    $element = this.getElementById(id);\n\n                if ($element && $element.length) {\n                    this.disableElements($element);\n                } else {\n                    this.rememberDisabledElementId(id);\n                }\n            }\n        },\n\n        selectElementAfterUpdate: function(id) {\n            if (this._autoSelectElements === null) {\n                this._autoSelectElements = [];\n            }\n\n            this._autoSelectElements.push(id);\n        },\n\n        addButton: function($button) {\n            this.getButtonContainer().append($button);\n        },\n\n        isShowingSidebar: function() {\n            if (this.showingSidebar === null) {\n                this.showingSidebar = (this.$sidebar.length && !this.$sidebar.hasClass('hidden'));\n            }\n\n            return this.showingSidebar;\n        },\n\n        getButtonContainer: function() {\n            // Is there a predesignated place where buttons should go?\n            if (this.settings.buttonContainer) {\n                return $(this.settings.buttonContainer);\n            } else {\n                var $container = $('#button-container');\n\n                if (!$container.length) {\n                    $container = $('<div id=\"button-container\"/>').appendTo(Craft.cp.$header);\n                }\n\n                return $container;\n            }\n        },\n\n        setIndexBusy: function() {\n            this.$mainSpinner.removeClass('invisible');\n            this.isIndexBusy = true;\n        },\n\n        setIndexAvailable: function() {\n            this.$mainSpinner.addClass('invisible');\n            this.isIndexBusy = false;\n        },\n\n        createCustomizeSourcesModal: function() {\n            // Recreate it each time\n            var modal = new Craft.CustomizeSourcesModal(this, {\n                onHide: function() {\n                    modal.destroy();\n                }\n            });\n\n            return modal;\n        },\n\n        disable: function() {\n            if (this.sourceSelect) {\n                this.sourceSelect.disable();\n            }\n\n            if (this.view) {\n                this.view.disable();\n            }\n\n            this.base();\n        },\n\n        enable: function() {\n            if (this.sourceSelect) {\n                this.sourceSelect.enable();\n            }\n\n            if (this.view) {\n                this.view.enable();\n            }\n\n            this.base();\n        },\n\n        // Events\n        // =========================================================================\n\n        onAfterInit: function() {\n            this.settings.onAfterInit();\n            this.trigger('afterInit');\n        },\n\n        onSelectSource: function() {\n            this.settings.onSelectSource(this.sourceKey);\n            this.trigger('selectSource', {sourceKey: this.sourceKey});\n        },\n\n        onSelectSite: function() {\n            this.settings.onSelectSite(this.siteId);\n            this.trigger('selectSite', {siteId: this.siteId});\n        },\n\n        onUpdateElements: function() {\n            this.settings.onUpdateElements();\n            this.trigger('updateElements');\n        },\n\n        onSelectionChange: function() {\n            this.settings.onSelectionChange();\n            this.trigger('selectionChange');\n        },\n\n        onEnableElements: function($elements) {\n            this.settings.onEnableElements($elements);\n            this.trigger('enableElements', {elements: $elements});\n        },\n\n        onDisableElements: function($elements) {\n            this.settings.onDisableElements($elements);\n            this.trigger('disableElements', {elements: $elements});\n        },\n\n        onAfterAction: function(action, params) {\n            this.settings.onAfterAction(action, params);\n            this.trigger('afterAction', {action: action, params: params});\n        },\n\n        // Private methods\n        // =========================================================================\n\n        // UI state handlers\n        // -------------------------------------------------------------------------\n\n        _handleSourceSelectionChange: function() {\n            // If the selected source was just removed (maybe because its parent was collapsed),\n            // there won't be a selected source\n            if (!this.sourceSelect.totalSelected) {\n                this.sourceSelect.selectItem(this.$visibleSources.first());\n                return;\n            }\n\n            if (this.selectSource(this.sourceSelect.$selectedItems)) {\n                this.updateElements();\n            }\n        },\n\n        _handleActionTriggerSubmit: function(ev) {\n            ev.preventDefault();\n\n            var $form = $(ev.currentTarget);\n\n            // Make sure Craft.ElementActionTrigger isn't overriding this\n            if ($form.hasClass('disabled') || $form.data('custom-handler')) {\n                return;\n            }\n\n            var actionClass = $form.data('action'),\n                params = Garnish.getPostData($form);\n\n            this.submitAction(actionClass, params);\n        },\n\n        _handleMenuActionTriggerSubmit: function(ev) {\n            var $option = $(ev.option);\n\n            // Make sure Craft.ElementActionTrigger isn't overriding this\n            if ($option.hasClass('disabled') || $option.data('custom-handler')) {\n                return;\n            }\n\n            var actionClass = $option.data('action');\n            this.submitAction(actionClass);\n        },\n\n        _handleStatusChange: function(ev) {\n            this.statusMenu.$options.removeClass('sel');\n            var $option = $(ev.selectedOption).addClass('sel');\n            this.$statusMenuBtn.html($option.html());\n\n            this.trashed = false;\n            this.drafts = false;\n            this.status = null;\n\n            if (Garnish.hasAttr($option, 'data-trashed')) {\n                this.trashed = true;\n            } else if (Garnish.hasAttr($option, 'data-drafts')) {\n                this.drafts = true;\n            } else {\n                this.status = $option.data('status');\n            }\n\n            this._updateStructureSortOption();\n            this.updateElements();\n        },\n\n        _handleSiteChange: function(ev) {\n            this.siteMenu.$options.removeClass('sel');\n            var $option = $(ev.selectedOption).addClass('sel');\n            this.$siteMenuBtn.html($option.html());\n            this._setSite($option.data('site-id'));\n            this.onSelectSite();\n        },\n\n        _setSite: function(siteId) {\n            this.siteId = siteId;\n            this.$visibleSources = $();\n\n            // Hide any sources that aren't available for this site\n            var $firstVisibleSource;\n            var $source;\n            var selectNewSource = false;\n\n            for (var i = 0; i < this.$sources.length; i++) {\n                $source = this.$sources.eq(i);\n                if (typeof $source.data('sites') === 'undefined' || $source.data('sites').toString().split(',').indexOf(siteId.toString()) !== -1) {\n                    $source.parent().removeClass('hidden');\n                    this.$visibleSources = this.$visibleSources.add($source);\n                    if (!$firstVisibleSource) {\n                        $firstVisibleSource = $source;\n                    }\n                } else {\n                    $source.parent().addClass('hidden');\n\n                    // Is this the currently selected source?\n                    if (this.$source && this.$source.get(0) == $source.get(0)) {\n                        selectNewSource = true;\n                    }\n                }\n            }\n\n            if (selectNewSource) {\n                this.selectSource($firstVisibleSource);\n            }\n\n            // Hide any empty-nester headings\n            var $headings = this.getSourceContainer().children('.heading');\n            var $heading;\n\n            for (i = 0; i < $headings.length; i++) {\n                $heading = $headings.eq(i);\n                if ($heading.nextUntil('.heading', ':not(.hidden)').length !== 0) {\n                    $heading.removeClass('hidden');\n                } else {\n                    $heading.addClass('hidden');\n                }\n            }\n\n            if (this.initialized) {\n                // Remember this site for later\n                Craft.setLocalStorage('BaseElementIndex.siteId', siteId);\n\n                // Update the elements\n                this.updateElements();\n            }\n        },\n\n        _handleSortChange: function(ev) {\n            var $option = $(ev.selectedOption);\n\n            if ($option.hasClass('disabled') || $option.hasClass('sel')) {\n                return;\n            }\n\n            // Is this an attribute or a direction?\n            if ($option.parent().parent().is(this.$sortAttributesList)) {\n                this.setSortAttribute($option.data('attr'));\n            } else {\n                this.setSortDirection($option.data('dir'));\n            }\n\n            this.storeSortAttributeAndDirection();\n            this.updateElements();\n        },\n\n        _handleSelectionChange: function() {\n            this.updateActionTriggers();\n            this.onSelectionChange();\n        },\n\n        _handleSourceDblClick: function(ev) {\n            this._toggleSource($(ev.currentTarget));\n            ev.stopPropagation();\n        },\n\n        _handleSourceToggleClick: function(ev) {\n            this._toggleSource($(ev.currentTarget).prev('a'));\n            ev.stopPropagation();\n        },\n\n        _updateStructureSortOption: function() {\n            var $option = this.getSortAttributeOption('structure');\n\n            if (!$option.length) {\n                return;\n            }\n\n            if (this.trashed || this.drafts || this.searching) {\n                $option.addClass('disabled');\n                if (this.getSelectedSortAttribute() === 'structure') {\n                    // Temporarily set the sort to the first option\n                    var $firstOption = this.$sortAttributesList.find('a:not(.disabled):first')\n                    this.setSortAttribute($firstOption.data('attr'));\n                    this.setSortDirection('asc');\n                }\n            } else {\n                $option.removeClass('disabled');\n                this.setStoredSortOptionsForSource();\n            }\n        },\n\n        // Source managemnet\n        // -------------------------------------------------------------------------\n\n        _getSourcesInList: function($list) {\n            return $list.children('li').children('a');\n        },\n\n        _getChildSources: function($source) {\n            var $list = $source.siblings('ul');\n            return this._getSourcesInList($list);\n        },\n\n        _getSourceToggle: function($source) {\n            return $source.siblings('.toggle');\n        },\n\n        _initSources: function($sources) {\n            for (var i = 0; i < $sources.length; i++) {\n                this.initSource($($sources[i]));\n            }\n        },\n\n        _deinitSources: function($sources) {\n            for (var i = 0; i < $sources.length; i++) {\n                this.deinitSource($($sources[i]));\n            }\n        },\n\n        _toggleSource: function($source) {\n            if ($source.parent('li').hasClass('expanded')) {\n                this._collapseSource($source);\n            } else {\n                this._expandSource($source);\n            }\n        },\n\n        _expandSource: function($source) {\n            $source.parent('li').addClass('expanded');\n\n            var $childSources = this._getChildSources($source);\n            this._initSources($childSources);\n\n            var key = $source.data('key');\n            if (this.instanceState.expandedSources.indexOf(key) === -1) {\n                this.instanceState.expandedSources.push(key);\n                this.storeInstanceState();\n            }\n        },\n\n        _collapseSource: function($source) {\n            $source.parent('li').removeClass('expanded');\n\n            var $childSources = this._getChildSources($source);\n            this._deinitSources($childSources);\n\n            var i = this.instanceState.expandedSources.indexOf($source.data('key'));\n            if (i !== -1) {\n                this.instanceState.expandedSources.splice(i, 1);\n                this.storeInstanceState();\n            }\n        },\n\n        // View\n        // -------------------------------------------------------------------------\n\n        _isViewPaginated: function() {\n            return this.settings.context === 'index' && this.getSelectedSortAttribute() !== 'structure';\n        },\n\n        _updateView: function(params, response) {\n            // Cleanup\n            // -------------------------------------------------------------\n\n            // Get rid of the old action triggers regardless of whether the new batch has actions or not\n            if (this.actions) {\n                this.hideActionTriggers();\n                this.actions = this.actionsHeadHtml = this.actionsFootHtml = this._$triggers = null;\n            }\n\n            if (this.$selectAllContainer) {\n                // Git rid of the old select all button\n                this.$selectAllContainer.detach();\n            }\n\n            // Update the count text\n            // -------------------------------------------------------------\n\n            this.$countContainer.html('');\n\n            if (!this._isViewPaginated() || response.count <= this.settings.batchSize) {\n                this.$countContainer.text(response.countLabel);\n            } else {\n                var $paginationContainer = $('<div class=\"flex pagination\"/>').appendTo(this.$countContainer);\n                var totalPages = Math.max(Math.ceil(response.count / this.settings.batchSize), 1);\n\n                var $prevBtn = $('<div/>', {\n                    'class': 'page-link' + (this.page > 1 ? '' : ' disabled'),\n                    'data-icon': 'leftangle',\n                    title: Craft.t('app', 'Previous Page')\n                }).appendTo($paginationContainer);\n                var $nextBtn = $('<div/>', {\n                    'class': 'page-link' + (this.page < totalPages ? '' : ' disabled'),\n                    'data-icon': 'rightangle',\n                    title: Craft.t('app', 'Next Page')\n                }).appendTo($paginationContainer);\n\n                $('<div/>', {\n                    'class': 'page-info',\n                    text: response.countLabel\n                }).appendTo($paginationContainer);\n\n                if (this.page > 1) {\n                    this.addListener($prevBtn, 'click', function() {\n                        this.removeListener($prevBtn, 'click');\n                        this.removeListener($nextBtn, 'click');\n                        this.setPage(this.page - 1);\n                        this.updateElements(true);\n                    });\n                }\n\n                if (this.page < totalPages) {\n                    this.addListener($nextBtn, 'click', function() {\n                        this.removeListener($prevBtn, 'click');\n                        this.removeListener($nextBtn, 'click');\n                        this.setPage(this.page + 1);\n                        this.updateElements(true);\n                    });\n                }\n            }\n\n            // Batch actions setup\n            // -------------------------------------------------------------\n\n            if (response.actions && response.actions.length) {\n                this.actions = response.actions;\n                this.actionsHeadHtml = response.actionsHeadHtml;\n                this.actionsFootHtml = response.actionsFootHtml;\n\n                // First time?\n                if (!this.$selectAllContainer) {\n                    // Create the select all button\n                    this.$selectAllContainer = $('<div class=\"selectallcontainer\"/>');\n                    this.$selectAllBtn = $('<div class=\"btn\"/>').appendTo(this.$selectAllContainer);\n                    this.$selectAllCheckbox = $('<div class=\"checkbox\"/>').appendTo(this.$selectAllBtn);\n\n                    this.$selectAllBtn.attr({\n                        'role': 'checkbox',\n                        'tabindex': '0',\n                        'aria-checked': 'false'\n                    });\n\n                    this.addListener(this.$selectAllBtn, 'click', function() {\n                        if (this.view.getSelectedElements().length === 0) {\n                            this.view.selectAllElements();\n                        } else {\n                            this.view.deselectAllElements();\n                        }\n                    });\n\n                    this.addListener(this.$selectAllBtn, 'keydown', function(ev) {\n                        if (ev.keyCode === Garnish.SPACE_KEY) {\n                            ev.preventDefault();\n\n                            $(ev.currentTarget).trigger('click');\n                        }\n                    });\n                } else {\n                    // Reset the select all button\n                    this.$selectAllCheckbox.removeClass('indeterminate checked');\n\n                    this.$selectAllBtn.attr('aria-checked', 'false');\n                }\n\n                // Place the select all button at the beginning of the toolbar\n                this.$selectAllContainer.prependTo(this.$toolbarFlexContainer);\n            }\n\n            // Update the view with the new container + elements HTML\n            // -------------------------------------------------------------\n\n            this.$elements.html(response.html);\n            Craft.appendHeadHtml(response.headHtml);\n            Craft.appendFootHtml(response.footHtml);\n\n            // Create the view\n            // -------------------------------------------------------------\n\n            // Should we make the view selectable?\n            var selectable = (this.actions || this.settings.selectable);\n\n            this.view = this.createView(this.getSelectedViewMode(), {\n                context: this.settings.context,\n                batchSize: this.settings.context !== 'index' || this.getSelectedSortAttribute() === 'structure' ? this.settings.batchSize : null,\n                params: params,\n                selectable: selectable,\n                multiSelect: (this.actions || this.settings.multiSelect),\n                checkboxMode: !!this.actions,\n                onSelectionChange: $.proxy(this, '_handleSelectionChange')\n            });\n\n            // Auto-select elements\n            // -------------------------------------------------------------\n\n            if (this._autoSelectElements) {\n                if (selectable) {\n                    for (var i = 0; i < this._autoSelectElements.length; i++) {\n                        this.view.selectElementById(this._autoSelectElements[i]);\n                    }\n                }\n\n                this._autoSelectElements = null;\n            }\n\n            // Trigger the event\n            // -------------------------------------------------------------\n\n            this.onUpdateElements();\n        },\n\n        _createTriggers: function() {\n            var triggers = [],\n                safeMenuActions = [],\n                destructiveMenuActions = [];\n\n            var i;\n\n            for (i = 0; i < this.actions.length; i++) {\n                var action = this.actions[i];\n\n                if (action.trigger) {\n                    var $form = $('<form id=\"' + Craft.formatInputId(action.type) + '-actiontrigger\"/>')\n                        .data('action', action.type)\n                        .append(action.trigger);\n\n                    this.addListener($form, 'submit', '_handleActionTriggerSubmit');\n                    triggers.push($form);\n                } else {\n                    if (!action.destructive) {\n                        safeMenuActions.push(action);\n                    } else {\n                        destructiveMenuActions.push(action);\n                    }\n                }\n            }\n\n            var $btn;\n\n            if (safeMenuActions.length || destructiveMenuActions.length) {\n                var $menuTrigger = $('<form/>');\n\n                $btn = $('<div class=\"btn menubtn\" data-icon=\"settings\" title=\"' + Craft.t('app', 'Actions') + '\"/>').appendTo($menuTrigger);\n\n                var $menu = $('<ul class=\"menu\"/>').appendTo($menuTrigger),\n                    $safeList = this._createMenuTriggerList(safeMenuActions, false),\n                    $destructiveList = this._createMenuTriggerList(destructiveMenuActions, true);\n\n                if ($safeList) {\n                    $safeList.appendTo($menu);\n                }\n\n                if ($safeList && $destructiveList) {\n                    $('<hr/>').appendTo($menu);\n                }\n\n                if ($destructiveList) {\n                    $destructiveList.appendTo($menu);\n                }\n\n                triggers.push($menuTrigger);\n            }\n\n            this._$triggers = $();\n\n            for (i = 0; i < triggers.length; i++) {\n                var $div = $('<div/>').append(triggers[i]);\n                this._$triggers = this._$triggers.add($div);\n            }\n\n            this._$triggers.insertAfter(this.$selectAllContainer);\n            Craft.appendHeadHtml(this.actionsHeadHtml);\n            Craft.appendFootHtml(this.actionsFootHtml);\n\n            Craft.initUiElements(this._$triggers);\n\n            if ($btn) {\n                $btn.data('menubtn').on('optionSelect', $.proxy(this, '_handleMenuActionTriggerSubmit'));\n            }\n        },\n\n        _showExportHud: function() {\n            this.$exportBtn.addClass('active');\n\n            var $form = $('<form/>', {\n                'class': 'export-form'\n            });\n\n            var $limitField = Craft.ui.createTextField({\n                label: Craft.t('app', 'Limit'),\n                placeholder: Craft.t('app', 'No limit'),\n                type: 'number',\n                min: 1\n            }).appendTo($form);\n\n            $('<input/>', {\n                type: 'submit',\n                'class': 'btn submit fullwidth',\n                value: Craft.t('app', 'Export')\n            }).appendTo($form)\n\n            var $spinner = $('<div/>', {\n                'class': 'spinner hidden'\n            }).appendTo($form);\n\n            var hud = new Garnish.HUD(this.$exportBtn, $form);\n\n            hud.on('hide', $.proxy(function() {\n                this.$exportBtn.removeClass('active');\n            }, this));\n\n            var submitting = false;\n\n            this.addListener($form, 'submit', function(ev) {\n                ev.preventDefault();\n                if (submitting) {\n                    return;\n                }\n\n                submitting = true;\n                $spinner.removeClass('hidden');\n\n                var params = this.getViewParams();\n                delete params.criteria.limit;\n\n                var limit = parseInt($limitField.find('input').val());\n                if (limit && !isNaN(limit)) {\n                    params.criteria.limit = limit;\n                }\n\n                Craft.postActionRequest('element-indexes/create-export-token', params, $.proxy(function(response, textStatus) {\n                    submitting = false;\n                    $spinner.addClass('hidden');\n\n                    if (textStatus === 'success') {\n                        var params = {};\n                        params[Craft.tokenParam] = response.token;\n                        var url = Craft.getCpUrl('', params);\n                        document.location.href = url;\n                    } else {\n                        Craft.cp.displayError(Craft.t('app', 'An unknown error occurred.'));\n                    }\n\n                }, this));\n            });\n        },\n\n        _createMenuTriggerList: function(actions, destructive) {\n            if (actions && actions.length) {\n                var $ul = $('<ul/>');\n\n                for (var i = 0; i < actions.length; i++) {\n                    var actionClass = actions[i].type;\n                    $('<li/>').append($('<a/>', {\n                        id: Craft.formatInputId(actionClass) + '-actiontrigger',\n                        'class': (destructive ? 'error' : null),\n                        'data-action': actionClass,\n                        text: actions[i].name\n                    })).appendTo($ul);\n                }\n\n                return $ul;\n            }\n        }\n    },\n\n// Static Properties\n// =============================================================================\n\n    {\n        defaults: {\n            context: 'index',\n            modal: null,\n            storageKey: null,\n            criteria: null,\n            batchSize: 50,\n            disabledElementIds: [],\n            selectable: false,\n            multiSelect: false,\n            buttonContainer: null,\n            hideSidebar: false,\n            refreshSourcesAction: 'element-indexes/get-source-tree-html',\n            updateElementsAction: 'element-indexes/get-elements',\n            submitActionsAction: 'element-indexes/perform-action',\n            toolbarFixed: null,\n\n            onAfterInit: $.noop,\n            onSelectSource: $.noop,\n            onSelectSite: $.noop,\n            onUpdateElements: $.noop,\n            onSelectionChange: $.noop,\n            onEnableElements: $.noop,\n            onDisableElements: $.noop,\n            onAfterAction: $.noop\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Base Element Index View\n */\nCraft.BaseElementIndexView = Garnish.Base.extend(\n    {\n        $container: null,\n        $loadingMoreSpinner: null,\n        $elementContainer: null,\n        $scroller: null,\n\n        elementIndex: null,\n        thumbLoader: null,\n        elementSelect: null,\n\n        loadingMore: false,\n\n        _totalVisible: null,\n        _morePending: null,\n        _handleEnableElements: null,\n        _handleDisableElements: null,\n\n        init: function(elementIndex, container, settings) {\n            this.elementIndex = elementIndex;\n            this.$container = $(container);\n            this.setSettings(settings, Craft.BaseElementIndexView.defaults);\n\n            // Create a \"loading-more\" spinner\n            this.$loadingMoreSpinner = $(\n                '<div class=\"centeralign hidden\">' +\n                '<div class=\"spinner loadingmore\"></div>' +\n                '</div>'\n            ).insertAfter(this.$container);\n\n            // Get the actual elements container and its child elements\n            this.$elementContainer = this.getElementContainer();\n            var $elements = this.$elementContainer.children();\n\n            this.setTotalVisible($elements.length);\n            this.setMorePending(this.settings.batchSize && $elements.length == this.settings.batchSize);\n\n            // Instantiate the thumb loader\n            this.thumbLoader = new Craft.ElementThumbLoader();\n            this.thumbLoader.load($elements);\n\n            if (this.settings.selectable) {\n                this.elementSelect = new Garnish.Select(\n                    this.$elementContainer,\n                    $elements.filter(':not(.disabled)'),\n                    {\n                        multi: this.settings.multiSelect,\n                        vertical: this.isVerticalList(),\n                        handle: (this.settings.context === 'index' ? '.checkbox, .element:first' : null),\n                        filter: ':not(a):not(.toggle)',\n                        checkboxMode: this.settings.checkboxMode,\n                        onSelectionChange: $.proxy(this, 'onSelectionChange')\n                    }\n                );\n\n                this._handleEnableElements = $.proxy(function(ev) {\n                    this.elementSelect.addItems(ev.elements);\n                }, this);\n\n                this._handleDisableElements = $.proxy(function(ev) {\n                    this.elementSelect.removeItems(ev.elements);\n                }, this);\n\n                this.elementIndex.on('enableElements', this._handleEnableElements);\n                this.elementIndex.on('disableElements', this._handleDisableElements);\n            }\n\n            // Enable inline element editing if this is an index page\n            if (this.settings.context === 'index') {\n                this._handleElementEditing = $.proxy(function(ev) {\n                    var $target = $(ev.target);\n\n                    if ($target.prop('nodeName') === 'A') {\n                        // Let the link do its thing\n                        return;\n                    }\n\n                    var $element;\n\n                    if ($target.hasClass('element')) {\n                        $element = $target;\n                    }\n                    else {\n                        $element = $target.closest('.element');\n\n                        if (!$element.length) {\n                            return;\n                        }\n                    }\n\n                    if (Garnish.hasAttr($element, 'data-editable')) {\n                        this.createElementEditor($element);\n                    }\n                }, this);\n\n                if (!this.elementIndex.trashed) {\n                    this.addListener(this.$elementContainer, 'dblclick', this._handleElementEditing);\n                    if ($.isTouchCapable()) {\n                        this.addListener(this.$elementContainer, 'taphold', this._handleElementEditing);\n                    }\n                }\n            }\n\n            // Give sub-classes a chance to do post-initialization stuff here\n            this.afterInit();\n\n            // Set up lazy-loading\n            if (this.settings.batchSize) {\n                if (this.settings.context === 'index') {\n                    this.$scroller = Garnish.$scrollContainer;\n                }\n                else {\n                    this.$scroller = this.elementIndex.$main;\n                }\n\n                this.$scroller.scrollTop(0);\n                this.addListener(this.$scroller, 'scroll', 'maybeLoadMore');\n                this.maybeLoadMore();\n            }\n        },\n\n        getElementContainer: function() {\n            throw 'Classes that extend Craft.BaseElementIndexView must supply a getElementContainer() method.';\n        },\n\n        afterInit: function() {\n        },\n\n        getAllElements: function() {\n            return this.$elementContainer.children();\n        },\n\n        getEnabledElements: function() {\n            return this.$elementContainer.children(':not(.disabled)');\n        },\n\n        getElementById: function(id) {\n            var $element = this.$elementContainer.children('[data-id=\"' + id + '\"]:first');\n\n            if ($element.length) {\n                return $element;\n            }\n            else {\n                return null;\n            }\n        },\n\n        getSelectedElements: function() {\n            if (!this.elementSelect) {\n                throw 'This view is not selectable.';\n            }\n\n            return this.elementSelect.$selectedItems;\n        },\n\n        getSelectedElementIds: function() {\n            var $selectedElements = this.getSelectedElements(),\n                ids = [];\n\n            if ($selectedElements) {\n                for (var i = 0; i < $selectedElements.length; i++) {\n                    ids.push($selectedElements.eq(i).data('id'));\n                }\n            }\n\n            return ids;\n        },\n\n        selectElement: function($element) {\n            if (!this.elementSelect) {\n                throw 'This view is not selectable.';\n            }\n\n            this.elementSelect.selectItem($element, true);\n            return true;\n        },\n\n        selectElementById: function(id) {\n            if (!this.elementSelect) {\n                throw 'This view is not selectable.';\n            }\n\n            var $element = this.getElementById(id);\n\n            if ($element) {\n                this.elementSelect.selectItem($element, true);\n                return true;\n            }\n            else {\n                return false;\n            }\n        },\n\n        selectAllElements: function() {\n            this.elementSelect.selectAll();\n        },\n\n        deselectAllElements: function() {\n            this.elementSelect.deselectAll();\n        },\n\n        isVerticalList: function() {\n            return false;\n        },\n\n        getTotalVisible: function() {\n            return this._totalVisible;\n        },\n\n        setTotalVisible: function(totalVisible) {\n            this._totalVisible = totalVisible;\n        },\n\n        getMorePending: function() {\n            return this._morePending;\n        },\n\n        setMorePending: function(morePending) {\n            this._morePending = morePending;\n        },\n\n        /**\n         * Checks if the user has reached the bottom of the scroll area, and if so, loads the next batch of elemets.\n         */\n        maybeLoadMore: function() {\n            if (this.canLoadMore()) {\n                this.loadMore();\n            }\n        },\n\n        /**\n         * Returns whether the user has reached the bottom of the scroll area.\n         */\n        canLoadMore: function() {\n            if (!this.getMorePending() || !this.settings.batchSize) {\n                return false;\n            }\n\n            // Check if the user has reached the bottom of the scroll area\n            var containerHeight;\n\n            if (this.$scroller[0] === Garnish.$win[0]) {\n                var winHeight = Garnish.$win.innerHeight(),\n                    winScrollTop = Garnish.$win.scrollTop(),\n                    containerOffset = this.$container.offset().top;\n                containerHeight = this.$container.height();\n\n                return (winHeight + winScrollTop >= containerOffset + containerHeight);\n            }\n            else {\n                var containerScrollHeight = this.$scroller.prop('scrollHeight'),\n                    containerScrollTop = this.$scroller.scrollTop();\n                containerHeight = this.$scroller.outerHeight();\n\n                return (containerScrollHeight - containerScrollTop <= containerHeight + 15);\n            }\n        },\n\n        /**\n         * Loads the next batch of elements.\n         */\n        loadMore: function() {\n            if (!this.getMorePending() || this.loadingMore || !this.settings.batchSize) {\n                return;\n            }\n\n            this.loadingMore = true;\n            this.$loadingMoreSpinner.removeClass('hidden');\n            this.removeListener(this.$scroller, 'scroll');\n\n            var data = this.getLoadMoreParams();\n\n            Craft.postActionRequest(this.settings.loadMoreElementsAction, data, $.proxy(function(response, textStatus) {\n                this.loadingMore = false;\n                this.$loadingMoreSpinner.addClass('hidden');\n\n                if (textStatus === 'success') {\n                    var $newElements = $(response.html);\n\n                    this.appendElements($newElements);\n                    Craft.appendHeadHtml(response.headHtml);\n                    Craft.appendFootHtml(response.footHtml);\n\n                    if (this.elementSelect) {\n                        this.elementSelect.addItems($newElements.filter(':not(.disabled)'));\n                        this.elementIndex.updateActionTriggers();\n                    }\n\n                    this.setTotalVisible(this.getTotalVisible() + $newElements.length);\n                    this.setMorePending($newElements.length == this.settings.batchSize);\n\n                    // Is there room to load more right now?\n                    this.addListener(this.$scroller, 'scroll', 'maybeLoadMore');\n                    this.maybeLoadMore();\n                }\n\n            }, this));\n        },\n\n        getLoadMoreParams: function() {\n            // Use the same params that were passed when initializing this view\n            var params = $.extend(true, {}, this.settings.params);\n            params.criteria.offset = this.getTotalVisible();\n            return params;\n        },\n\n        appendElements: function($newElements) {\n            $newElements.appendTo(this.$elementContainer);\n            this.thumbLoader.load($newElements);\n            this.onAppendElements($newElements);\n        },\n\n        onAppendElements: function($newElements) {\n            this.settings.onAppendElements($newElements);\n            this.trigger('appendElements', {\n                newElements: $newElements\n            });\n        },\n\n        onSelectionChange: function() {\n            this.settings.onSelectionChange();\n            this.trigger('selectionChange');\n        },\n\n        createElementEditor: function($element) {\n            Craft.createElementEditor($element.data('type'), $element, {\n                elementIndex: this.elementIndex\n            });\n        },\n\n        disable: function() {\n            if (this.elementSelect) {\n                this.elementSelect.disable();\n            }\n        },\n\n        enable: function() {\n            if (this.elementSelect) {\n                this.elementSelect.enable();\n            }\n        },\n\n        destroy: function() {\n            // Remove the \"loading-more\" spinner, since we added that outside of the view container\n            this.$loadingMoreSpinner.remove();\n\n            // Kill the thumb loader\n            this.thumbLoader.destroy();\n            delete this.thumbLoader;\n\n            // Delete the element select\n            if (this.elementSelect) {\n                this.elementIndex.off('enableElements', this._handleEnableElements);\n                this.elementIndex.off('disableElements', this._handleDisableElements);\n\n                this.elementSelect.destroy();\n                delete this.elementSelect;\n            }\n\n            this.base();\n        }\n    },\n    {\n        defaults: {\n            context: 'index',\n            batchSize: null,\n            params: null,\n            selectable: false,\n            multiSelect: false,\n            checkboxMode: false,\n            loadMoreElementsAction: 'element-indexes/get-more-elements',\n            onAppendElements: $.noop,\n            onSelectionChange: $.noop\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Element Select input\n */\nCraft.BaseElementSelectInput = Garnish.Base.extend(\n    {\n        thumbLoader: null,\n        elementSelect: null,\n        elementSort: null,\n        modal: null,\n        elementEditor: null,\n\n        $container: null,\n        $elementsContainer: null,\n        $elements: null,\n        $addElementBtn: null,\n\n        _initialized: false,\n\n        init: function(settings) {\n            // Normalize the settings and set them\n            // ---------------------------------------------------------------------\n\n            // Are they still passing in a bunch of arguments?\n            if (!$.isPlainObject(settings)) {\n                // Loop through all of the old arguments and apply them to the settings\n                var normalizedSettings = {},\n                    args = ['id', 'name', 'elementType', 'sources', 'criteria', 'sourceElementId', 'limit', 'modalStorageKey', 'fieldId'];\n\n                for (var i = 0; i < args.length; i++) {\n                    if (typeof arguments[i] !== 'undefined') {\n                        normalizedSettings[args[i]] = arguments[i];\n                    }\n                    else {\n                        break;\n                    }\n                }\n\n                settings = normalizedSettings;\n            }\n\n            this.setSettings(settings, Craft.BaseElementSelectInput.defaults);\n\n            // Apply the storage key prefix\n            if (this.settings.modalStorageKey) {\n                this.modalStorageKey = 'BaseElementSelectInput.' + this.settings.modalStorageKey;\n            }\n\n            // No reason for this to be sortable if we're only allowing 1 selection\n            if (this.settings.limit == 1) {\n                this.settings.sortable = false;\n            }\n\n            this.$container = this.getContainer();\n\n            // Store a reference to this class\n            this.$container.data('elementSelect', this);\n\n            this.$elementsContainer = this.getElementsContainer();\n            this.$addElementBtn = this.getAddElementsBtn();\n\n            if (this.$addElementBtn && this.settings.limit == 1) {\n                this.$addElementBtn\n                    .css('position', 'absolute')\n                    .css('top', 0)\n                    .css(Craft.left, 0);\n            }\n\n            this.thumbLoader = new Craft.ElementThumbLoader();\n\n            this.initElementSelect();\n            this.initElementSort();\n            this.resetElements();\n\n            if (this.$addElementBtn) {\n                this.addListener(this.$addElementBtn, 'activate', 'showModal');\n            }\n\n            this._initialized = true;\n        },\n\n        get totalSelected() {\n            return this.$elements.length;\n        },\n\n        getContainer: function() {\n            return $('#' + this.settings.id);\n        },\n\n        getElementsContainer: function() {\n            return this.$container.children('.elements');\n        },\n\n        getElements: function() {\n            return this.$elementsContainer.children();\n        },\n\n        getAddElementsBtn: function() {\n            return this.$container.children('.btn.add');\n        },\n\n        initElementSelect: function() {\n            if (this.settings.selectable) {\n                this.elementSelect = new Garnish.Select({\n                    multi: this.settings.sortable,\n                    filter: ':not(.delete)'\n                });\n            }\n        },\n\n        initElementSort: function() {\n            if (this.settings.sortable) {\n                this.elementSort = new Garnish.DragSort({\n                    container: this.$elementsContainer,\n                    filter: (this.settings.selectable ? $.proxy(function() {\n                            // Only return all the selected items if the target item is selected\n                            if (this.elementSort.$targetItem.hasClass('sel')) {\n                                return this.elementSelect.getSelectedItems();\n                            }\n                            else {\n                                return this.elementSort.$targetItem;\n                            }\n                        }, this) : null),\n                    ignoreHandleSelector: '.delete',\n                    axis: this.getElementSortAxis(),\n                    collapseDraggees: true,\n                    magnetStrength: 4,\n                    helperLagBase: 1.5,\n                    onSortChange: (this.settings.selectable ? $.proxy(function() {\n                            this.elementSelect.resetItemOrder();\n                        }, this) : null)\n                });\n            }\n        },\n\n        getElementSortAxis: function() {\n            return (this.settings.viewMode === 'list' ? 'y' : null);\n        },\n\n        canAddMoreElements: function() {\n            return (!this.settings.limit || this.$elements.length < this.settings.limit);\n        },\n\n        updateAddElementsBtn: function() {\n            if (this.canAddMoreElements()) {\n                this.enableAddElementsBtn();\n            }\n            else {\n                this.disableAddElementsBtn();\n            }\n        },\n\n        disableAddElementsBtn: function() {\n            if (this.$addElementBtn && !this.$addElementBtn.hasClass('disabled')) {\n                this.$addElementBtn.addClass('disabled');\n\n                if (this.settings.limit == 1) {\n                    if (this._initialized) {\n                        this.$addElementBtn.velocity('fadeOut', Craft.BaseElementSelectInput.ADD_FX_DURATION);\n                    }\n                    else {\n                        this.$addElementBtn.hide();\n                    }\n                }\n            }\n        },\n\n        enableAddElementsBtn: function() {\n            if (this.$addElementBtn && this.$addElementBtn.hasClass('disabled')) {\n                this.$addElementBtn.removeClass('disabled');\n\n                if (this.settings.limit == 1) {\n                    if (this._initialized) {\n                        this.$addElementBtn.velocity('fadeIn', Craft.BaseElementSelectInput.REMOVE_FX_DURATION);\n                    }\n                    else {\n                        this.$addElementBtn.show();\n                    }\n                }\n            }\n        },\n\n        resetElements: function() {\n            if (this.$elements !== null) {\n                this.removeElements(this.$elements);\n            } else {\n                this.$elements = $();\n            }\n\n            this.addElements(this.getElements());\n        },\n\n        addElements: function($elements) {\n            this.thumbLoader.load($elements);\n\n            if (this.settings.selectable) {\n                this.elementSelect.addItems($elements);\n            }\n\n            if (this.settings.sortable) {\n                this.elementSort.addItems($elements);\n            }\n\n            if (this.settings.editable) {\n                this._handleShowElementEditor = $.proxy(function(ev) {\n                    var $element = $(ev.currentTarget);\n                    if (Garnish.hasAttr($element, 'data-editable') && !$element.hasClass('disabled') && !$element.hasClass('loading')) {\n                        this.elementEditor = this.createElementEditor($element);\n                    }\n                }, this);\n\n                this.addListener($elements, 'dblclick', this._handleShowElementEditor);\n\n                if ($.isTouchCapable()) {\n                    this.addListener($elements, 'taphold', this._handleShowElementEditor);\n                }\n            }\n\n            $elements.find('.delete').on('click', $.proxy(function(ev) {\n                this.removeElement($(ev.currentTarget).closest('.element'));\n            }, this));\n\n            this.$elements = this.$elements.add($elements);\n            this.updateAddElementsBtn();\n        },\n\n        createElementEditor: function($element, settings) {\n            if (!settings) {\n                settings = {};\n            }\n            settings.prevalidate = this.settings.prevalidate;\n            return Craft.createElementEditor(this.settings.elementType, $element, settings);\n        },\n\n        removeElements: function($elements) {\n            if (this.settings.selectable) {\n                this.elementSelect.removeItems($elements);\n            }\n\n            if (this.modal) {\n                var ids = [];\n\n                for (var i = 0; i < $elements.length; i++) {\n                    var id = $elements.eq(i).data('id');\n\n                    if (id) {\n                        ids.push(id);\n                    }\n                }\n\n                if (ids.length) {\n                    this.modal.elementIndex.enableElementsById(ids);\n                }\n            }\n\n            // Disable the hidden input in case the form is submitted before this element gets removed from the DOM\n            $elements.children('input').prop('disabled', true);\n\n            this.$elements = this.$elements.not($elements);\n            this.updateAddElementsBtn();\n\n            this.onRemoveElements();\n        },\n\n        removeElement: function($element) {\n            this.removeElements($element);\n            this.animateElementAway($element, function() {\n                $element.remove();\n            });\n        },\n\n        animateElementAway: function($element, callback) {\n            $element.css('z-index', 0);\n\n            var animateCss = {\n                opacity: -1\n            };\n            animateCss['margin-' + Craft.left] = -($element.outerWidth() + parseInt($element.css('margin-' + Craft.right)));\n\n            if (this.settings.viewMode === 'list' || this.$elements.length === 0) {\n                animateCss['margin-bottom'] = -($element.outerHeight() + parseInt($element.css('margin-bottom')));\n            }\n\n            $element.velocity(animateCss, Craft.BaseElementSelectInput.REMOVE_FX_DURATION, callback);\n        },\n\n        showModal: function() {\n            // Make sure we haven't reached the limit\n            if (!this.canAddMoreElements()) {\n                return;\n            }\n\n            if (!this.modal) {\n                this.modal = this.createModal();\n            }\n            else {\n                this.modal.show();\n            }\n        },\n\n        createModal: function() {\n            return Craft.createElementSelectorModal(this.settings.elementType, this.getModalSettings());\n        },\n\n        getModalSettings: function() {\n            return $.extend({\n                closeOtherModals: false,\n                storageKey: this.modalStorageKey,\n                sources: this.settings.sources,\n                criteria: this.settings.criteria,\n                multiSelect: (this.settings.limit != 1),\n                showSiteMenu: this.settings.showSiteMenu,\n                disabledElementIds: this.getDisabledElementIds(),\n                onSelect: $.proxy(this, 'onModalSelect')\n            }, this.settings.modalSettings);\n        },\n\n        getSelectedElementIds: function() {\n            var ids = [];\n\n            for (var i = 0; i < this.$elements.length; i++) {\n                ids.push(this.$elements.eq(i).data('id'));\n            }\n\n            return ids;\n        },\n\n        getDisabledElementIds: function() {\n            var ids = this.getSelectedElementIds();\n\n            if (this.settings.sourceElementId) {\n                ids.push(this.settings.sourceElementId);\n            }\n\n            return ids;\n        },\n\n        onModalSelect: function(elements) {\n            if (this.settings.limit) {\n                // Cut off any excess elements\n                var slotsLeft = this.settings.limit - this.$elements.length;\n\n                if (elements.length > slotsLeft) {\n                    elements = elements.slice(0, slotsLeft);\n                }\n            }\n\n            this.selectElements(elements);\n            this.updateDisabledElementsInModal();\n        },\n\n        selectElements: function(elements) {\n            for (var i = 0; i < elements.length; i++) {\n                var elementInfo = elements[i],\n                    $element = this.createNewElement(elementInfo);\n\n                this.appendElement($element);\n                this.addElements($element);\n                this.animateElementIntoPlace(elementInfo.$element, $element);\n            }\n\n            this.onSelectElements(elements);\n        },\n\n        createNewElement: function(elementInfo) {\n            var $element = elementInfo.$element.clone();\n\n            // Make a couple tweaks\n            Craft.setElementSize($element, (this.settings.viewMode === 'large' ? 'large' : 'small'));\n            $element.addClass('removable');\n            $element.prepend('<input type=\"hidden\" name=\"' + this.settings.name + '[]\" value=\"' + elementInfo.id + '\">' +\n                '<a class=\"delete icon\" title=\"' + Craft.t('app', 'Remove') + '\"></a>');\n\n            return $element;\n        },\n\n        appendElement: function($element) {\n            $element.appendTo(this.$elementsContainer);\n        },\n\n        animateElementIntoPlace: function($modalElement, $inputElement) {\n            var origOffset = $modalElement.offset(),\n                destOffset = $inputElement.offset(),\n                $helper = $inputElement.clone().appendTo(Garnish.$bod);\n\n            $inputElement.css('visibility', 'hidden');\n\n            $helper.css({\n                position: 'absolute',\n                zIndex: 10000,\n                top: origOffset.top,\n                left: origOffset.left\n            });\n\n            var animateCss = {\n                top: destOffset.top,\n                left: destOffset.left\n            };\n\n            $helper.velocity(animateCss, Craft.BaseElementSelectInput.ADD_FX_DURATION, function() {\n                $helper.remove();\n                $inputElement.css('visibility', 'visible');\n            });\n        },\n\n        updateDisabledElementsInModal: function() {\n            if (this.modal.elementIndex) {\n                this.modal.elementIndex.disableElementsById(this.getDisabledElementIds());\n            }\n        },\n\n        getElementById: function(id) {\n            for (var i = 0; i < this.$elements.length; i++) {\n                var $element = this.$elements.eq(i);\n\n                if ($element.data('id') == id) {\n                    return $element;\n                }\n            }\n        },\n\n        onSelectElements: function(elements) {\n            this.trigger('selectElements', {elements: elements});\n            this.settings.onSelectElements(elements);\n\n            if (window.draftEditor) {\n                window.draftEditor.checkForm();\n            }\n        },\n\n        onRemoveElements: function() {\n            this.trigger('removeElements');\n            this.settings.onRemoveElements();\n        }\n    },\n    {\n        ADD_FX_DURATION: 200,\n        REMOVE_FX_DURATION: 200,\n\n        defaults: {\n            id: null,\n            name: null,\n            fieldId: null,\n            elementType: null,\n            sources: null,\n            criteria: {},\n            sourceElementId: null,\n            viewMode: 'list',\n            limit: null,\n            showSiteMenu: false,\n            modalStorageKey: null,\n            modalSettings: {},\n            onSelectElements: $.noop,\n            onRemoveElements: $.noop,\n            sortable: true,\n            selectable: true,\n            editable: true,\n            prevalidate: false,\n            editorSettings: {}\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Element selector modal class\n */\nCraft.BaseElementSelectorModal = Garnish.Modal.extend(\n    {\n        elementType: null,\n        elementIndex: null,\n\n        $body: null,\n        $selectBtn: null,\n        $sidebar: null,\n        $sources: null,\n        $sourceToggles: null,\n        $main: null,\n        $search: null,\n        $elements: null,\n        $tbody: null,\n        $primaryButtons: null,\n        $secondaryButtons: null,\n        $cancelBtn: null,\n        $footerSpinner: null,\n\n        init: function(elementType, settings) {\n            this.elementType = elementType;\n            this.setSettings(settings, Craft.BaseElementSelectorModal.defaults);\n\n            // Build the modal\n            var $container = $('<div class=\"modal elementselectormodal\"></div>').appendTo(Garnish.$bod),\n                $body = $('<div class=\"body\"><div class=\"spinner big\"></div></div>').appendTo($container),\n                $footer = $('<div class=\"footer\"/>').appendTo($container);\n\n            this.base($container, this.settings);\n\n            this.$footerSpinner = $('<div class=\"spinner hidden\"/>').appendTo($footer);\n            this.$primaryButtons = $('<div class=\"buttons right\"/>').appendTo($footer);\n            this.$secondaryButtons = $('<div class=\"buttons left secondary-buttons\"/>').appendTo($footer);\n            this.$cancelBtn = $('<div class=\"btn\">' + Craft.t('app', 'Cancel') + '</div>').appendTo(this.$primaryButtons);\n            this.$selectBtn = $('<div class=\"btn disabled submit\">' + Craft.t('app', 'Select') + '</div>').appendTo(this.$primaryButtons);\n\n            this.$body = $body;\n\n            this.addListener(this.$cancelBtn, 'activate', 'cancel');\n            this.addListener(this.$selectBtn, 'activate', 'selectElements');\n        },\n\n        onFadeIn: function() {\n            if (!this.elementIndex) {\n                this._createElementIndex();\n            }\n            else {\n                // Auto-focus the Search box\n                if (!Garnish.isMobileBrowser(true)) {\n                    this.elementIndex.$search.trigger('focus');\n                }\n            }\n\n            this.base();\n        },\n\n        onSelectionChange: function() {\n            this.updateSelectBtnState();\n        },\n\n        updateSelectBtnState: function() {\n            if (this.$selectBtn) {\n                if (this.elementIndex.getSelectedElements().length) {\n                    this.enableSelectBtn();\n                }\n                else {\n                    this.disableSelectBtn();\n                }\n            }\n        },\n\n        enableSelectBtn: function() {\n            this.$selectBtn.removeClass('disabled');\n        },\n\n        disableSelectBtn: function() {\n            this.$selectBtn.addClass('disabled');\n        },\n\n        enableCancelBtn: function() {\n            this.$cancelBtn.removeClass('disabled');\n        },\n\n        disableCancelBtn: function() {\n            this.$cancelBtn.addClass('disabled');\n        },\n\n        showFooterSpinner: function() {\n            this.$footerSpinner.removeClass('hidden');\n        },\n\n        hideFooterSpinner: function() {\n            this.$footerSpinner.addClass('hidden');\n        },\n\n        cancel: function() {\n            if (!this.$cancelBtn.hasClass('disabled')) {\n                this.hide();\n            }\n        },\n\n        selectElements: function() {\n            if (this.elementIndex && this.elementIndex.getSelectedElements().length) {\n                // TODO: This code shouldn't know about views' elementSelect objects\n                this.elementIndex.view.elementSelect.clearMouseUpTimeout();\n\n                var $selectedElements = this.elementIndex.getSelectedElements(),\n                    elementInfo = this.getElementInfo($selectedElements);\n\n                this.onSelect(elementInfo);\n\n                if (this.settings.disableElementsOnSelect) {\n                    this.elementIndex.disableElements(this.elementIndex.getSelectedElements());\n                }\n\n                if (this.settings.hideOnSelect) {\n                    this.hide();\n                }\n            }\n        },\n\n        getElementInfo: function($selectedElements) {\n            var info = [];\n\n            for (var i = 0; i < $selectedElements.length; i++) {\n                var $element = $($selectedElements[i]);\n                var elementInfo = Craft.getElementInfo($element);\n\n                info.push(elementInfo);\n            }\n\n            return info;\n        },\n\n        show: function() {\n            this.updateSelectBtnState();\n            this.base();\n        },\n\n        onSelect: function(elementInfo) {\n            this.settings.onSelect(elementInfo);\n        },\n\n        disable: function() {\n            if (this.elementIndex) {\n                this.elementIndex.disable();\n            }\n\n            this.base();\n        },\n\n        enable: function() {\n            if (this.elementIndex) {\n                this.elementIndex.enable();\n            }\n\n            this.base();\n        },\n\n        _createElementIndex: function() {\n            // Get the modal body HTML based on the settings\n            var data = {\n                context: 'modal',\n                elementType: this.elementType,\n                sources: this.settings.sources\n            };\n\n            if (this.settings.showSiteMenu !== null && this.settings.showSiteMenu !== 'auto') {\n                data.showSiteMenu = this.settings.showSiteMenu ? '1' : '0';\n            }\n\n            Craft.postActionRequest('elements/get-modal-body', data, $.proxy(function(response, textStatus) {\n                if (textStatus === 'success') {\n                    this.$body.html(response.html);\n\n                    if (this.$body.has('.sidebar:not(.hidden)').length) {\n                        this.$body.addClass('has-sidebar');\n                    }\n\n                    // Initialize the element index\n                    this.elementIndex = Craft.createElementIndex(this.elementType, this.$body, {\n                        context: 'modal',\n                        modal: this,\n                        storageKey: this.settings.storageKey,\n                        criteria: this.settings.criteria,\n                        disabledElementIds: this.settings.disabledElementIds,\n                        selectable: true,\n                        multiSelect: this.settings.multiSelect,\n                        buttonContainer: this.$secondaryButtons,\n                        onSelectionChange: $.proxy(this, 'onSelectionChange'),\n                        hideSidebar: this.settings.hideSidebar\n                    });\n\n                    // Double-clicking or double-tapping should select the elements\n                    this.addListener(this.elementIndex.$elements, 'doubletap', function(ev, touchData) {\n                        // Make sure the touch targets are the same\n                        // (they may be different if Command/Ctrl/Shift-clicking on multiple elements quickly)\n                        if (touchData.firstTap.target === touchData.secondTap.target) {\n                            this.selectElements();\n                        }\n                    });\n                }\n\n            }, this));\n        }\n    },\n    {\n        defaults: {\n            resizable: true,\n            storageKey: null,\n            sources: null,\n            criteria: null,\n            multiSelect: false,\n            showSiteMenu: null,\n            disabledElementIds: [],\n            disableElementsOnSelect: false,\n            hideOnSelect: true,\n            onCancel: $.noop,\n            onSelect: $.noop,\n            hideIndexSidebar: false\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Input Generator\n */\nCraft.BaseInputGenerator = Garnish.Base.extend(\n    {\n        $source: null,\n        $target: null,\n        $form: null,\n        settings: null,\n\n        listening: null,\n        timeout: null,\n\n        init: function(source, target, settings) {\n            this.$source = $(source);\n            this.$target = $(target);\n            this.$form = this.$source.closest('form');\n\n            this.setSettings(settings);\n\n            this.startListening();\n        },\n\n        setNewSource: function(source) {\n            var listening = this.listening;\n            this.stopListening();\n\n            this.$source = $(source);\n\n            if (listening) {\n                this.startListening();\n            }\n        },\n\n        startListening: function() {\n            if (this.listening) {\n                return;\n            }\n\n            this.listening = true;\n\n            this.addListener(this.$source, 'textchange', 'onSourceTextChange');\n            this.addListener(this.$target, 'textchange', 'onTargetTextChange');\n            this.addListener(this.$form, 'submit', 'onFormSubmit');\n        },\n\n        stopListening: function() {\n            if (!this.listening) {\n                return;\n            }\n\n            this.listening = false;\n\n            if (this.timeout) {\n                clearTimeout(this.timeout);\n            }\n\n            this.removeAllListeners(this.$source);\n            this.removeAllListeners(this.$target);\n            this.removeAllListeners(this.$form);\n        },\n\n        onSourceTextChange: function() {\n            if (this.timeout) {\n                clearTimeout(this.timeout);\n            }\n\n            this.timeout = setTimeout($.proxy(this, 'updateTarget'), 250);\n        },\n\n        onTargetTextChange: function() {\n            if (this.$target.get(0) === document.activeElement) {\n                this.stopListening();\n            }\n        },\n\n        onFormSubmit: function() {\n            if (this.timeout) {\n                clearTimeout(this.timeout);\n            }\n\n            this.updateTarget();\n        },\n\n        updateTarget: function() {\n            var sourceVal = this.$source.val();\n\n            if (typeof sourceVal === 'undefined') {\n                // The source input may not exist anymore\n                return;\n            }\n\n            var targetVal = this.generateTargetValue(sourceVal);\n\n            this.$target.val(targetVal);\n            this.$target.trigger('change');\n\n            // If the target already has focus, select its whole value to mimic\n            // the behavior if the value had already been generated and they just tabbed in\n            if (this.$target.is(':focus')) {\n                Craft.selectFullValue(this.$target);\n            }\n        },\n\n        generateTargetValue: function(sourceVal) {\n            return sourceVal;\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Admin table class\n */\nCraft.AdminTable = Garnish.Base.extend(\n    {\n        settings: null,\n        totalItems: null,\n        sorter: null,\n\n        $noItems: null,\n        $table: null,\n        $tbody: null,\n        $deleteBtns: null,\n\n        init: function(settings) {\n            this.setSettings(settings, Craft.AdminTable.defaults);\n\n            if (!this.settings.allowDeleteAll) {\n                this.settings.minItems = 1;\n            }\n\n            this.$noItems = $(this.settings.noItemsSelector);\n            this.$table = $(this.settings.tableSelector);\n            this.$tbody = this.$table.children('tbody');\n            this.totalItems = this.$tbody.children().length;\n\n            if (this.settings.sortable) {\n                this.sorter = new Craft.DataTableSorter(this.$table, {\n                    onSortChange: $.proxy(this, 'reorderItems')\n                });\n            }\n\n            this.$deleteBtns = this.$table.find('.delete:not(.disabled)');\n            this.addListener(this.$deleteBtns, 'click', 'handleDeleteBtnClick');\n\n            this.updateUI();\n        },\n\n        addRow: function(row) {\n            if (this.settings.maxItems && this.totalItems >= this.settings.maxItems) {\n                // Sorry pal.\n                return;\n            }\n\n            var $row = $(row).appendTo(this.$tbody),\n                $deleteBtn = $row.find('.delete');\n\n            if (this.settings.sortable) {\n                this.sorter.addItems($row);\n            }\n\n            this.$deleteBtns = this.$deleteBtns.add($deleteBtn);\n\n            this.addListener($deleteBtn, 'click', 'handleDeleteBtnClick');\n            this.totalItems++;\n\n            this.updateUI();\n        },\n\n        reorderItems: function() {\n            if (!this.settings.sortable) {\n                return;\n            }\n\n            // Get the new field order\n            var ids = [];\n\n            for (var i = 0; i < this.sorter.$items.length; i++) {\n                var id = $(this.sorter.$items[i]).attr(this.settings.idAttribute);\n                ids.push(id);\n            }\n\n            // Send it to the server\n            var data = {\n                ids: JSON.stringify(ids)\n            };\n\n            Craft.postActionRequest(this.settings.reorderAction, data, $.proxy(function(response, textStatus) {\n                if (textStatus === 'success') {\n                    if (response.success) {\n                        this.onReorderItems(ids);\n                        Craft.cp.displayNotice(Craft.t('app', this.settings.reorderSuccessMessage));\n                    }\n                    else {\n                        Craft.cp.displayError(Craft.t('app', this.settings.reorderFailMessage));\n                    }\n                }\n\n            }, this));\n        },\n\n        handleDeleteBtnClick: function(event) {\n            if (this.settings.minItems && this.totalItems <= this.settings.minItems) {\n                // Sorry pal.\n                return;\n            }\n\n            var $row = $(event.target).closest('tr');\n\n            if (this.confirmDeleteItem($row)) {\n                this.deleteItem($row);\n            }\n        },\n\n        confirmDeleteItem: function($row) {\n            var name = this.getItemName($row);\n            return confirm(Craft.t('app', this.settings.confirmDeleteMessage, {name: name}));\n        },\n\n        deleteItem: function($row) {\n            var data = {\n                id: this.getItemId($row)\n            };\n\n            Craft.postActionRequest(this.settings.deleteAction, data, $.proxy(function(response, textStatus) {\n                if (textStatus === 'success') {\n                    this.handleDeleteItemResponse(response, $row);\n                }\n            }, this));\n        },\n\n        handleDeleteItemResponse: function(response, $row) {\n            var id = this.getItemId($row),\n                name = this.getItemName($row);\n\n            if (response.success) {\n                if (this.sorter) {\n                    this.sorter.removeItems($row);\n                }\n\n                $row.remove();\n                this.totalItems--;\n                this.updateUI();\n                this.onDeleteItem(id);\n\n                Craft.cp.displayNotice(Craft.t('app', this.settings.deleteSuccessMessage, {name: Craft.escapeHtml(name)}));\n            }\n            else {\n                Craft.cp.displayError(Craft.t('app', this.settings.deleteFailMessage, {name: Craft.escapeHtml(name)}));\n            }\n        },\n\n        onReorderItems: function(ids) {\n            this.settings.onReorderItems(ids);\n        },\n\n        onDeleteItem: function(id) {\n            this.settings.onDeleteItem(id);\n        },\n\n        getItemId: function($row) {\n            return $row.attr(this.settings.idAttribute);\n        },\n\n        getItemName: function($row) {\n            return $row.attr(this.settings.nameAttribute);\n        },\n\n        updateUI: function() {\n            // Show the \"No Whatever Exists\" message if there aren't any\n            if (this.totalItems === 0) {\n                this.$table.hide();\n                this.$noItems.removeClass('hidden');\n            }\n            else {\n                this.$table.show();\n                this.$noItems.addClass('hidden');\n            }\n\n            // Disable the sort buttons if there's only one row\n            if (this.settings.sortable) {\n                var $moveButtons = this.$table.find('.move');\n\n                if (this.totalItems === 1) {\n                    $moveButtons.addClass('disabled');\n                }\n                else {\n                    $moveButtons.removeClass('disabled');\n                }\n            }\n\n            // Disable the delete buttons if we've reached the minimum items\n            if (this.settings.minItems && this.totalItems <= this.settings.minItems) {\n                this.$deleteBtns.addClass('disabled');\n            }\n            else {\n                this.$deleteBtns.removeClass('disabled');\n            }\n\n            // Hide the New Whatever button if we've reached the maximum items\n            if (this.settings.newItemBtnSelector) {\n                if (this.settings.maxItems && this.totalItems >= this.settings.maxItems) {\n                    $(this.settings.newItemBtnSelector).addClass('hidden');\n                }\n                else {\n                    $(this.settings.newItemBtnSelector).removeClass('hidden');\n                }\n            }\n        }\n    },\n    {\n        defaults: {\n            tableSelector: null,\n            noItemsSelector: null,\n            newItemBtnSelector: null,\n            idAttribute: 'data-id',\n            nameAttribute: 'data-name',\n            sortable: false,\n            allowDeleteAll: true,\n            minItems: 0,\n            maxItems: null,\n            reorderAction: null,\n            deleteAction: null,\n            reorderSuccessMessage: Craft.t('app', 'New order saved.'),\n            reorderFailMessage: Craft.t('app', 'Couldn\u2019t save new order.'),\n            confirmDeleteMessage: Craft.t('app', 'Are you sure you want to delete \u201c{name}\u201d?'),\n            deleteSuccessMessage: Craft.t('app', '\u201c{name}\u201d deleted.'),\n            deleteFailMessage: Craft.t('app', 'Couldn\u2019t delete \u201c{name}\u201d.'),\n            onReorderItems: $.noop,\n            onDeleteItem: $.noop\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Asset index class\n */\nCraft.AssetEditor = Craft.BaseElementEditor.extend(\n    {\n        reloadIndex: false,\n\n        updateForm: function(response) {\n            this.base(response);\n\n            if (this.$element.data('id')) {\n                var $imageEditorTrigger = this.$fieldsContainer.find('> .meta > .image-preview-container.editable');\n\n                if ($imageEditorTrigger.length) {\n                    this.addListener($imageEditorTrigger, 'click', 'showImageEditor');\n                }\n            }\n\n        },\n\n        showImageEditor: function()\n        {\n            new Craft.AssetImageEditor(this.$element.data('id'), {\n                onSave: function () {\n                    this.reloadIndex = true;\n                    this.reloadForm();\n                }.bind(this),\n                allowDegreeFractions: Craft.isImagick\n            });\n        },\n\n        onHideHud: function () {\n            if (this.reloadIndex && this.settings.elementIndex) {\n                this.settings.elementIndex.updateElements();\n            }\n\n            this.base();\n        }\n    });\n\n// Register it!\nCraft.registerElementEditorClass('craft\\\\elements\\\\Asset', Craft.AssetEditor);\n\n/** global: Craft */\n/** global: Garnish */\n\n/**\n * Asset image editor class\n */\n\nCraft.AssetImageEditor = Garnish.Modal.extend(\n    {\n        // jQuery objects\n        $body: null,\n        $footer: null,\n        $imageTools: null,\n        $buttons: null,\n        $cancelBtn: null,\n        $replaceBtn: null,\n        $saveBtn: null,\n        $editorContainer: null,\n        $straighten: null,\n        $croppingCanvas: null,\n        $spinnerCanvas: null,\n\n        // FabricJS objects\n        canvas: null,\n        image: null,\n        viewport: null,\n        focalPoint: null,\n        grid: null,\n        croppingCanvas: null,\n        clipper: null,\n        croppingRectangle: null,\n        cropperHandles: null,\n        cropperGrid: null,\n        croppingShade: null,\n\n        // Image state attributes\n        imageStraightenAngle: 0,\n        viewportRotation: 0,\n        originalWidth: 0,\n        originalHeight: 0,\n        imageVerticeCoords: null,\n        zoomRatio: 1,\n\n        // Editor state attributes\n        animationInProgress: false,\n        currentView: '',\n        assetId: null,\n        cacheBust: null,\n        draggingCropper: false,\n        scalingCropper: false,\n        draggingFocal: false,\n        previousMouseX: 0,\n        previousMouseY: 0,\n        shiftKeyHeld: false,\n        editorHeight: 0,\n        editorWidth: 0,\n        cropperState: false,\n        scaleFactor: 1,\n        flipData: {},\n        focalPointState: false,\n        croppingConstraint: false,\n        spinnerInterval: null,\n        maxImageSize: null,\n        lastLoadedDimensions: null,\n        imageIsLoading: false,\n\n        // Rendering proxy functions\n        renderImage: null,\n        renderCropper: null,\n\n        init: function(assetId, settings) {\n            this.cacheBust = Date.now();\n\n            this.setSettings(settings, Craft.AssetImageEditor.defaults);\n\n            this.assetId = assetId;\n            this.flipData = {x: 0, y: 0};\n\n            // Build the modal\n            this.$container = $('<form class=\"modal fitted imageeditor\"></form>').appendTo(Garnish.$bod);\n            this.$body = $('<div class=\"body\"></div>').appendTo(this.$container);\n            this.$footer = $('<div class=\"footer\"/>').appendTo(this.$container);\n\n            this.base(this.$container, this.settings);\n\n            this.$buttons = $('<div class=\"buttons right\"/>').appendTo(this.$footer);\n            this.$cancelBtn = $('<div class=\"btn cancel\">' + Craft.t('app', 'Cancel') + '</div>').appendTo(this.$buttons);\n            this.$replaceBtn = $('<div class=\"btn submit save replace\">' + Craft.t('app', 'Save') + '</div>').appendTo(this.$buttons);\n\n            if (this.settings.allowSavingAsNew) {\n                this.$saveBtn = $('<div class=\"btn submit save copy\">' + Craft.t('app', 'Save as a new asset') + '</div>').appendTo(this.$buttons);\n                this.addListener(this.$saveBtn, 'activate', this.saveImage.bind(this));\n            }\n\n            this.addListener(this.$replaceBtn, 'activate', this.saveImage.bind(this));\n            this.addListener(this.$cancelBtn, 'activate', $.proxy(this, 'hide'));\n            this.removeListener(this.$shade, 'click');\n\n            this.maxImageSize = this.getMaxImageSize();\n\n            Craft.postActionRequest('assets/image-editor', {assetId: assetId}, $.proxy(this, 'loadEditor'));\n        },\n\n        /**\n         * Get the max image size that is viewable in the editor currently\n         */\n        getMaxImageSize: function() {\n            var browserViewportWidth = Garnish.$doc.get(0).documentElement.clientWidth;\n            var browserViewportHeight = Garnish.$doc.get(0).documentElement.clientHeight;\n\n            return  Math.max(browserViewportHeight, browserViewportWidth) * (window.devicePixelRatio > 1 ? 2 : 1);\n        },\n\n        /**\n         * Load the editor markup and start loading components and the image.\n         *\n         * @param data\n         */\n        loadEditor: function(data) {\n\n            if (!data.html) {\n                alert(Craft.t('app', 'Could not load the image editor.'));\n            }\n\n            this.$body.html(data.html);\n            this.$tabs = $('.tabs li', this.$body);\n            this.$viewsContainer = $('.views', this.$body);\n            this.$views = $('> div', this.$viewsContainer);\n            this.$imageTools = $('.image-container .image-tools', this.$body);\n            this.$editorContainer = $('.image-container .image', this.$body);\n            this.editorHeight = this.$editorContainer.innerHeight();\n            this.editorWidth = this.$editorContainer.innerWidth();\n\n            this._showSpinner();\n\n            this.updateSizeAndPosition();\n\n            // Load the canvas on which we'll host our image and set up the proxy render function\n            this.canvas = new fabric.StaticCanvas('image-canvas');\n\n            // Set up the cropping canvas jquery element for tracking all the nice events\n            this.$croppingCanvas = $('#cropping-canvas', this.$editorContainer);\n            this.$croppingCanvas.width(this.editorWidth);\n            this.$croppingCanvas.height(this.editorHeight);\n\n            this.canvas.enableRetinaScaling = true;\n            this.renderImage = function() {\n                Garnish.requestAnimationFrame(this.canvas.renderAll.bind(this.canvas));\n            }.bind(this);\n\n            // Load the image from URL\n            var imageUrl = Craft.getActionUrl('assets/edit-image', {\n                assetId: this.assetId,\n                size: this.maxImageSize,\n                cacheBust: this.cacheBust\n            });\n\n            // Load image and set up the initial properties\n            fabric.Image.fromURL(imageUrl, $.proxy(function(imageObject) {\n\n                this.image = imageObject;\n                this.image.set({\n                    originX: 'center',\n                    originY: 'center',\n                    left: this.editorWidth / 2,\n                    top: this.editorHeight / 2\n                });\n                this.canvas.add(this.image);\n\n                this.originalHeight = this.image.getHeight();\n                this.originalWidth = this.image.getWidth();\n                this.zoomRatio = 1;\n\n                this.lastLoadedDimensions = this.getScaledImageDimensions();\n\n                // Set up the image bounding box, viewport and position everything\n                this._setFittedImageVerticeCoordinates();\n                this._repositionEditorElements();\n\n                // Set up the focal point\n                var focalState = {\n                    imageDimensions: this.getScaledImageDimensions(),\n                    offsetX: 0,\n                    offsetY: 0\n                };\n\n                var focal = false;\n                if (data.focalPoint) {\n                    // Transform the focal point coordinates from relative to absolute\n                    var focalData = data.focalPoint;\n\n                    // Resolve for the current image dimensions.\n                    var adjustedX = focalState.imageDimensions.width * focalData.x;\n                    var adjustedY = focalState.imageDimensions.height * focalData.y;\n\n                    focalState.offsetX = adjustedX - focalState.imageDimensions.width / 2;\n                    focalState.offsetY = adjustedY - focalState.imageDimensions.height / 2;\n\n                    focal = true;\n                }\n\n                this.storeFocalPointState(focalState);\n\n                if (focal) {\n                    this._createFocalPoint();\n                }\n\n                this._createViewport();\n                this.storeCropperState();\n\n                // Add listeners to buttons\n                this._addControlListeners();\n\n                // Add mouse event listeners\n                this.addListener(this.$croppingCanvas, 'mousemove', this._handleMouseMove.bind(this));\n                this.addListener(this.$croppingCanvas, 'mousedown', this._handleMouseDown.bind(this));\n                this.addListener(this.$croppingCanvas, 'mouseup', this._handleMouseUp.bind(this));\n                this.addListener(this.$croppingCanvas, 'mouseout', function(ev) {\n                    this._handleMouseUp(ev);\n                    this._handleMouseMove(ev);\n                }.bind(this));\n\n                this._hideSpinner();\n\n                // Render it, finally\n                this.renderImage();\n\n                // Make sure verything gets fired for the first tab\n                this.$tabs.first().trigger('click');\n            }, this));\n        },\n\n        /**\n         * Reload the image to better fit the current available image editor viewport.\n         */\n        _reloadImage: function () {\n\n            if (this.imageIsLoading) {\n                return;\n            }\n\n            this.imageIsLoading = true;\n            this.maxImageSize = this.getMaxImageSize();\n\n            // Load the image from URL\n            var imageUrl = Craft.getActionUrl('assets/edit-image', {\n                assetId: this.assetId,\n                size: this.maxImageSize,\n                cacheBust: this.cacheBust\n            });\n\n            this.image.setSrc(imageUrl, function(imageObject) {\n                this.originalHeight = imageObject.getHeight();\n                this.originalWidth = imageObject.getWidth();\n                this.lastLoadedDimensions = {width: this.originalHeight, height: this.originalWidth};\n                this.updateSizeAndPosition();\n                this.renderImage();\n                this.imageIsLoading = false;\n            }.bind(this));\n        },\n\n        /**\n         * Update the modal size and position on browser resize\n         */\n        updateSizeAndPosition: function() {\n            if (!this.$container) {\n                return;\n            }\n\n            // Fullscreen modal\n            var innerWidth = window.innerWidth;\n            var innerHeight = window.innerHeight;\n\n            this.$container.css({\n                'width': innerWidth,\n                'min-width': innerWidth,\n                'left': 0,\n\n                'height': innerHeight,\n                'min-height': innerHeight,\n                'top': 0\n            });\n\n            this.$body.css({\n                'height': innerHeight - 58\n            });\n\n            if (innerWidth < innerHeight) {\n                this.$container.addClass('vertical');\n            }\n            else {\n                this.$container.removeClass('vertical');\n            }\n\n            if (this.$spinnerCanvas) {\n                this.$spinnerCanvas.css({\n                    left: ((this.$spinnerCanvas.parent().width()/2)-(this.$spinnerCanvas.width()/2))+'px',\n                    top: ((this.$spinnerCanvas.parent().height()/2)-(this.$spinnerCanvas.height()/2))+'px'\n                });\n            }\n\n            // If image is already loaded, make sure it looks pretty.\n            if (this.$editorContainer && this.image) {\n                this._repositionEditorElements();\n            }\n        },\n\n        /**\n         * Reposition the editor elements to accurately reflect the editor state with current dimensions\n         */\n        _repositionEditorElements: function() {\n\n            // Remember what the dimensions were before the resize took place\n            var previousEditorDimensions = {\n                width: this.editorWidth,\n                height: this.editorHeight\n            };\n\n            this.editorHeight = this.$editorContainer.innerHeight();\n            this.editorWidth = this.$editorContainer.innerWidth();\n\n            this.canvas.setDimensions({\n                width: this.editorWidth,\n                height: this.editorHeight\n            });\n\n            var currentScaledDimensions = this.getScaledImageDimensions();\n\n            // If we're cropping now, we have to reposition the cropper correctly in case\n            // the area for image changes, forcing the image size to change as well.\n            if (this.currentView === 'crop') {\n                this.zoomRatio = this.getZoomToFitRatio(this.getScaledImageDimensions());\n                var previouslyOccupiedArea = this._getBoundingRectangle(this.imageVerticeCoords);\n                this._setFittedImageVerticeCoordinates();\n                this._repositionCropper(previouslyOccupiedArea);\n            } else {\n                // Otherwise just recalculate the image zoom ratio\n                this.zoomRatio = this.getZoomToCoverRatio(this.getScaledImageDimensions()) * this.scaleFactor;\n            }\n\n            // Reposition the image relatively to the previous editor dimensions.\n            this._repositionImage(previousEditorDimensions);\n            this._repositionViewport();\n            this._repositionFocalPoint(previousEditorDimensions);\n            this._zoomImage();\n\n            this.renderImage();\n\n            if (currentScaledDimensions.width / this.lastLoadedDimensions.width > 1.5 || currentScaledDimensions.height / this.lastLoadedDimensions.height > 1.5) {\n                this._reloadImage();\n            }\n        },\n\n        /**\n         * Reposition image based on how the editor dimensions have changed.\n         * This ensures keeping the image center offset, if there is any.\n         *\n         * @param previousEditorDimensions\n         */\n        _repositionImage: function(previousEditorDimensions) {\n            this.image.set({\n                left: this.image.left - (previousEditorDimensions.width - this.editorWidth) / 2,\n                top: this.image.top - (previousEditorDimensions.height - this.editorHeight) / 2\n            });\n        },\n\n        /**\n         * Create the viewport for image editor.\n         */\n        _createViewport: function() {\n            this.viewport = new fabric.Rect({\n                width: this.image.width,\n                height: this.image.height,\n                fill: 'rgba(127,0,0,1)',\n                originX: 'center',\n                originY: 'center',\n                globalCompositeOperation: 'destination-in', // This clips everything outside of the viewport\n                left: this.image.left,\n                top: this.image.top\n            });\n            this.canvas.add(this.viewport);\n            this.renderImage();\n        },\n\n        /**\n         * Create the focal point.\n         */\n        _createFocalPoint: function() {\n            var focalPointState = this.focalPointState;\n            var sizeFactor = this.getScaledImageDimensions().width / focalPointState.imageDimensions.width;\n\n            var focalX = focalPointState.offsetX * sizeFactor * this.zoomRatio * this.scaleFactor;\n            var focalY = focalPointState.offsetY * sizeFactor * this.zoomRatio * this.scaleFactor;\n\n            // Adjust by image margins\n            focalX += this.image.left;\n            focalY += this.image.top;\n\n            var deltaX = 0;\n            var deltaY = 0;\n\n            // When creating a fresh focal point, drop it dead in the center of the viewport, not the image.\n            if (this.viewport && focalPointState.offsetX === 0 && focalPointState.offsetY === 0) {\n                if (this.currentView !== 'crop') {\n                    deltaX = this.viewport.left - this.image.left;\n                    deltaY = this.viewport.top - this.image.top;\n\n                } else {\n                    // Unless we have a cropper showing, in which case drop it in the middle of the cropper\n                    deltaX = this.clipper.left - this.image.left;\n                    deltaY = this.clipper.top - this.image.top;\n                }\n\n                // Bump focal to middle of viewport\n                focalX += deltaX;\n                focalY += deltaY;\n\n                // Reflect changes in saved state\n                focalPointState.offsetX += deltaX / (sizeFactor * this.zoomRatio * this.scaleFactor);\n                focalPointState.offsetY += deltaY / (sizeFactor * this.zoomRatio * this.scaleFactor);\n            }\n\n            this.focalPoint = new fabric.Group([\n                new fabric.Circle({radius: 8, fill: 'rgba(0,0,0,0.5)', strokeWidth: 2, stroke: 'rgba(255,255,255,0.8)', left: 0, top: 0, originX: 'center', originY: 'center'}),\n                new fabric.Circle({radius: 1, fill: 'rgba(255,255,255,0)', strokeWidth: 2, stroke: 'rgba(255,255,255,0.8)', left: 0, top: 0, originX: 'center', originY: 'center'})\n            ], {\n                originX: 'center',\n                originY: 'center',\n                left: focalX,\n                top: focalY\n            });\n\n            this.storeFocalPointState(focalPointState);\n            this.canvas.add(this.focalPoint);\n        },\n\n        /**\n         * Toggle focal point\n         */\n        toggleFocalPoint: function() {\n            if (!this.focalPoint) {\n                this._createFocalPoint();\n            } else {\n                this.canvas.remove(this.focalPoint);\n                this.focalPoint = null;\n            }\n\n            this.renderImage();\n        },\n\n        /**\n         * Reposition the viewport to handle editor resizing.\n         */\n        _repositionViewport: function() {\n            if (this.viewport) {\n                var dimensions = {\n                    left: this.editorWidth / 2,\n                    top: this.editorHeight / 2\n                };\n\n                // If we're cropping, nothing exciting happens for the viewport\n                if (this.currentView === 'crop') {\n                    dimensions.width = this.editorWidth;\n                    dimensions.height = this.editorHeight;\n                } else {\n                    // If this is the first initial reposition, no cropper state yet\n                    if (this.cropperState) {\n\n                        // Recall the state\n                        var state = this.cropperState;\n\n                        var scaledImageDimensions = this.getScaledImageDimensions();\n                        // Make sure we have the correct current image size\n                        var sizeFactor = scaledImageDimensions.width / state.imageDimensions.width;\n\n                        // Set the viewport dimensions\n                        dimensions.width = state.width * sizeFactor * this.zoomRatio;\n                        dimensions.height = state.height * sizeFactor * this.zoomRatio;\n\n                        // Adjust the image position to show the correct part of the image in the viewport\n                        this.image.set({\n                            left: (this.editorWidth / 2) - (state.offsetX * sizeFactor),\n                            top: (this.editorHeight / 2) - (state.offsetY * sizeFactor)\n                        });\n                    } else {\n                        $.extend(dimensions, this.getScaledImageDimensions());\n                    }\n                }\n                this.viewport.set(dimensions);\n            }\n        },\n\n        _repositionFocalPoint: function(previousEditorDimensions) {\n            if (this.focalPoint) {\n                var offsetX = this.focalPoint.left - this.editorWidth / 2;\n                var offsetY = this.focalPoint.top - this.editorHeight / 2;\n\n                var currentWidth = this.image.width;\n                var newWidth = this.getScaledImageDimensions().width * this.zoomRatio;\n                var ratio = newWidth / currentWidth / this.scaleFactor;\n\n                offsetX -= (previousEditorDimensions.width - this.editorWidth) / 2;\n                offsetY -= (previousEditorDimensions.height - this.editorHeight) / 2;\n\n                offsetX *= ratio;\n                offsetY *= ratio;\n\n                this.focalPoint.set({\n                    left: this.editorWidth / 2 + offsetX,\n                    top: this.editorHeight / 2 + offsetY\n                });\n            }\n        },\n\n        /**\n         * Return true if the image orientation has changed\n         */\n        hasOrientationChanged: function() {\n            return this.viewportRotation % 180 !== 0;\n        },\n\n        /**\n         * Return the current image dimensions that would be used in the current image area with no straightening or rotation applied.\n         */\n        getScaledImageDimensions: function() {\n            var imageRatio = this.originalHeight / this.originalWidth;\n            var editorRatio = this.editorHeight / this.editorWidth;\n\n            var dimensions = {};\n            if (imageRatio > editorRatio) {\n                dimensions.height = Math.min(this.editorHeight, this.originalHeight);\n                dimensions.width = Math.round(this.originalWidth / (this.originalHeight / dimensions.height));\n            } else {\n                dimensions.width = Math.min(this.editorWidth, this.originalWidth);\n                dimensions.height = Math.round(this.originalHeight * (dimensions.width / this.originalWidth));\n            }\n\n            return dimensions;\n        },\n\n        /**\n         * Set the image dimensions to reflect the current zoom ratio.\n         */\n        _zoomImage: function() {\n            var imageDimensions = this.getScaledImageDimensions();\n            this.image.set({\n                width: imageDimensions.width * this.zoomRatio,\n                height: imageDimensions.height * this.zoomRatio\n            });\n        },\n\n        /**\n         * Set up listeners for the controls.\n         */\n        _addControlListeners: function() {\n\n            // Tabs\n            this.addListener(this.$tabs, 'click', '_handleTabClick');\n\n            // Focal point\n            this.addListener($('.focal-point'), 'click', function(ev) {\n                this.toggleFocalPoint(ev);\n            }.bind(this));\n\n            // Rotate controls\n            this.addListener($('.rotate-left'), 'click', function() {\n                this.rotateImage(-90);\n            }.bind(this));\n            this.addListener($('.rotate-right'), 'click', function() {\n                this.rotateImage(90);\n            }.bind(this));\n            this.addListener($('.flip-vertical'), 'click', function() {\n                this.flipImage('y');\n            }.bind(this));\n            this.addListener($('.flip-horizontal'), 'click', function() {\n                this.flipImage('x');\n            }.bind(this));\n\n            // Straighten slider\n            this.straighteningInput = new Craft.SlideRuleInput(\"slide-rule\", {\n                onStart: function() {\n                    this._showGrid();\n                }.bind(this),\n                onChange: function(slider) {\n                    this.straighten(slider);\n                }.bind(this),\n                onEnd: function() {\n                    this._hideGrid();\n                    this._cleanupFocalPointAfterStraighten();\n                }.bind(this)\n            });\n\n            // Cropper scale modifier key\n            this.addListener(Garnish.$doc, 'keydown', function(ev) {\n                if (ev.keyCode === Garnish.SHIFT_KEY) {\n                    this.shiftKeyHeld = true;\n                }\n            }.bind(this));\n            this.addListener(Garnish.$doc, 'keyup', function(ev) {\n                if (ev.keyCode === Garnish.SHIFT_KEY) {\n                    this.shiftKeyHeld = false;\n                }\n            }.bind(this));\n\n            // Cropper constraint menu\n            var constraintMenu = new Garnish.MenuBtn($('.crop .menubtn', this.$container), {\n                onOptionSelect: function (option) {\n                    $('.constraint', this.$container).html($(option).html());\n                    this.setCroppingConstraint($(option).data('constraint'));\n                    this.enforceCroppingConstraint();\n                }.bind(this)\n            });\n            constraintMenu.menu.$container.addClass('dark');\n        },\n\n        /**\n         * Handle tab click.\n         *\n         * @param ev\n         */\n        _handleTabClick: function(ev) {\n            if (!this.animationInProgress) {\n                var $tab = $(ev.currentTarget);\n                var view = $tab.data('view');\n                this.$tabs.removeClass('selected');\n                $tab.addClass('selected');\n                this.showView(view);\n            }\n        },\n\n        /**\n         * Show a view.\n         *\n         * @param view\n         */\n        showView: function(view) {\n            if (this.currentView === view) {\n                return;\n            }\n\n            this.$views.addClass('hidden');\n            var $view = this.$views.filter('[data-view=\"' + view + '\"]');\n            $view.removeClass('hidden');\n\n            if (view === 'rotate') {\n                this.enableSlider();\n            } else {\n                this.disableSlider();\n            }\n\n\n            // Now that most likely our editor dimensions have changed, time to reposition stuff\n            this.updateSizeAndPosition();\n\n            // See if we have to enable or disable crop mode as we transition between tabs\n            if (this.currentView === 'crop' && view !== 'crop') {\n                this.disableCropMode();\n            } else if (this.currentView !== 'crop' && view === 'crop') {\n                this.enableCropMode();\n            }\n\n            // Mark the current view\n            this.currentView = view;\n        },\n\n        /**\n         * Store the current cropper state.\n         *\n         * Cropper state is always assumed to be saved at a zoom ratio of 1 to be used\n         * as the basis for recalculating the cropper position and dimensions.\n         *\n         * @param [state]\n         */\n        storeCropperState: function(state) {\n            // If we're asked to store a specific state.\n            if (state) {\n                this.cropperState = state;\n            } else if (this.clipper) {\n                var zoomFactor = 1 / this.zoomRatio;\n\n                this.cropperState = {\n                    offsetX: (this.clipper.left - this.image.left) * zoomFactor,\n                    offsetY: (this.clipper.top - this.image.top) * zoomFactor,\n                    height: this.clipper.height * zoomFactor,\n                    width: this.clipper.width * zoomFactor,\n                    imageDimensions: this.getScaledImageDimensions()\n                };\n            } else {\n                var dimensions = this.getScaledImageDimensions();\n                this.cropperState = {\n                    offsetX: 0,\n                    offsetY: 0,\n                    height: dimensions.height,\n                    width: dimensions.width,\n                    imageDimensions: dimensions\n                };\n            }\n        },\n\n        /**\n         * Store focal point coordinates in a manner that is not tied to zoom ratio and rotation.\n         */\n        storeFocalPointState: function(state) {\n            // If we're asked to store a specific state.\n            if (state) {\n                this.focalPointState = state;\n            } else if (this.focalPoint) {\n                var zoomFactor = 1 / this.zoomRatio;\n                this.focalPointState = {\n                    offsetX: (this.focalPoint.left - this.image.left) * zoomFactor / this.scaleFactor,\n                    offsetY: (this.focalPoint.top - this.image.top) * zoomFactor / this.scaleFactor,\n                    imageDimensions: this.getScaledImageDimensions()\n                };\n            }\n        },\n\n        /**\n         * Rotate the image along with the viewport.\n         *\n         * @param degrees\n         */\n        rotateImage: function(degrees) {\n            if (!this.animationInProgress) {\n\n                // We're not that kind of an establishment, sir.\n                if (degrees !== 90 && degrees !== -90) {\n                    return false;\n                }\n\n                this.animationInProgress = true;\n                this.viewportRotation += degrees;\n\n                // Normalize the viewport rotation angle so it's between 0 and 359\n                this.viewportRotation = parseInt((this.viewportRotation + 360) % 360, 10);\n\n                var newAngle = this.image.angle + degrees;\n                var scaledImageDimensions = this.getScaledImageDimensions();\n                var imageZoomRatio;\n\n                if (this.hasOrientationChanged()) {\n                    imageZoomRatio = this.getZoomToCoverRatio({height: scaledImageDimensions.width, width: scaledImageDimensions.height});\n                } else {\n                    imageZoomRatio = this.getZoomToCoverRatio(scaledImageDimensions);\n                }\n\n                // In cases when for some reason we've already zoomed in on the image,\n                // use existing zoom.\n                if (this.zoomRatio > imageZoomRatio) {\n                    imageZoomRatio = this.zoomRatio;\n                }\n\n                var viewportProperties = {\n                    angle: degrees === 90 ? '+=90' : '-=90'\n                };\n\n                var imageProperties = {\n                    angle: newAngle,\n                    width: scaledImageDimensions.width * imageZoomRatio,\n                    height: scaledImageDimensions.height * imageZoomRatio\n                };\n\n                var scaleFactor = 1;\n                if (this.scaleFactor < 1) {\n                    scaleFactor = 1 / this.scaleFactor;\n                    this.scaleFactor = 1;\n                } else {\n                    if (this.viewport.width > this.editorHeight) {\n                        scaleFactor = this.editorHeight / this.viewport.width;\n                    } else if (this.viewport.height > this.editorWidth) {\n                        scaleFactor = this.editorWidth / this.viewport.height;\n                    }\n                    this.scaleFactor = scaleFactor;\n                }\n\n                if (scaleFactor < 1) {\n                    imageProperties.width *= scaleFactor;\n                    imageProperties.height *= scaleFactor;\n                }\n\n                var state = this.cropperState;\n\n                // Make sure we reposition the image as well to focus on the same image area\n                var deltaX = state.offsetX;\n                var deltaY = state.offsetY;\n                var angleInRadians = degrees * (Math.PI / 180);\n\n                // Calculate how the cropper would need to move in a circle to maintain\n                // the focus on the same region if the image was rotated with zoom intact.\n                var newDeltaX = deltaX * Math.cos(angleInRadians) - deltaY * Math.sin(angleInRadians);\n                var newDeltaY = deltaX * Math.sin(angleInRadians) + deltaY * Math.cos(angleInRadians);\n\n                var sizeFactor = scaledImageDimensions.width / state.imageDimensions.width;\n\n                var modifiedDeltaX = newDeltaX * sizeFactor * this.zoomRatio * this.scaleFactor;\n                var modifiedDeltaY = newDeltaY * sizeFactor * this.zoomRatio * this.scaleFactor;\n\n                imageProperties.left = this.editorWidth / 2 - modifiedDeltaX;\n                imageProperties.top = this.editorHeight / 2 - modifiedDeltaY;\n\n                state.offsetX = newDeltaX;\n                state.offsetY = newDeltaY;\n\n                var temp = state.width;\n                state.width = state.height;\n                state.height = temp;\n\n                this.storeCropperState(state);\n\n                if (this.focalPoint) {\n                    this.canvas.remove(this.focalPoint);\n                }\n\n                this.viewport.animate(viewportProperties, {\n                    duration: this.settings.animationDuration,\n                    onComplete: function() {\n                        // If we're zooming the image in or out, better do the same to viewport\n                        var temp = this.viewport.height * scaleFactor;\n                        this.viewport.height = this.viewport.width * scaleFactor;\n                        this.viewport.width = temp;\n                        this.viewport.set({angle: 0});\n                    }.bind(this)\n                });\n\n                // Animate the rotation and dimension change\n                this.image.animate(imageProperties, {\n                    onChange: this.canvas.renderAll.bind(this.canvas),\n                    duration: this.settings.animationDuration,\n                    onComplete: function() {\n                        var cleanAngle = parseFloat((this.image.angle + 360) % 360);\n                        this.image.set({angle: cleanAngle});\n                        this.animationInProgress = false;\n                        if (this.focalPoint) {\n                            this._adjustFocalPointByAngle(degrees);\n                            this.straighten(this.straighteningInput);\n                            this.canvas.add(this.focalPoint);\n                        } else {\n                            this._resetFocalPointPosition();\n                        }\n                    }.bind(this)\n                });\n            }\n        },\n\n        /**\n         * Flip an image along an axis.\n         *\n         * @param axis\n         */\n        flipImage: function(axis) {\n            if (!this.animationInProgress) {\n                this.animationInProgress = true;\n\n                if (this.hasOrientationChanged()) {\n                    axis = axis === 'y' ? 'x' : 'y';\n                }\n\n                if (this.focalPoint) {\n                    this.canvas.remove(this.focalPoint);\n                } else {\n                    this._resetFocalPointPosition();\n                }\n\n                var editorCenter = {x: this.editorWidth / 2, y: this.editorHeight / 2};\n                this.straighteningInput.setValue(-this.imageStraightenAngle);\n                this.imageStraightenAngle = -this.imageStraightenAngle;\n                var properties = {\n                    angle: this.viewportRotation + this.imageStraightenAngle\n                };\n\n                var deltaY, deltaX;\n                var cropperState = this.cropperState;\n                var focalPointState = this.focalPointState;\n\n                // Reposition the image, viewport, and stored cropper and focal point states.\n                if ((axis === 'y' && this.hasOrientationChanged()) || (axis !== 'y' && !this.hasOrientationChanged())) {\n                    cropperState.offsetX = -cropperState.offsetX;\n                    focalPointState.offsetX = -focalPointState.offsetX;\n                    deltaX = this.image.left - editorCenter.x;\n                    properties.left = editorCenter.x - deltaX;\n                } else {\n                    cropperState.offsetY = -cropperState.offsetY;\n                    focalPointState.offsetY = -focalPointState.offsetY;\n                    deltaY = this.image.top - editorCenter.y;\n                    properties.top = editorCenter.y - deltaY;\n                }\n\n                if (axis === 'y') {\n                    properties.scaleY = this.image.scaleY * -1;\n                    this.flipData.y = 1 - this.flipData.y;\n                } else {\n                    properties.scaleX = this.image.scaleX * -1;\n                    this.flipData.x = 1 - this.flipData.x;\n                }\n\n                this.storeCropperState(cropperState);\n                this.storeFocalPointState(focalPointState);\n\n                this.image.animate(properties, {\n                    onChange: this.canvas.renderAll.bind(this.canvas),\n                    duration: this.settings.animationDuration,\n                    onComplete: function() {\n                        this.animationInProgress = false;\n                        if (this.focalPoint) {\n                            // Well this is handy\n                            this._adjustFocalPointByAngle(0);\n                            this.canvas.add(this.focalPoint);\n                        }\n                    }.bind(this)\n                });\n            }\n        },\n\n        /**\n         * Perform the straightening with input slider.\n         *\n         * @param {Craft.SlideRuleInput} slider\n         */\n        straighten: function(slider) {\n            if (!this.animationInProgress) {\n                this.animationInProgress = true;\n\n                var previousAngle = this.image.angle;\n\n                this.imageStraightenAngle = (this.settings.allowDegreeFractions ? parseFloat(slider.value) : Math.round(parseFloat(slider.value))) % 360;\n\n                // Straighten the image\n                this.image.set({\n                    angle: this.viewportRotation + this.imageStraightenAngle\n                });\n\n                // Set the new zoom ratio\n                this.zoomRatio = this.getZoomToCoverRatio(this.getScaledImageDimensions()) * this.scaleFactor;\n                this._zoomImage();\n\n                if (this.cropperState) {\n                    this._adjustEditorElementsOnStraighten(previousAngle);\n                }\n\n                this.renderImage();\n\n                this.animationInProgress = false;\n            }\n        },\n\n        /**\n         * Adjust the cropped viewport when straightening the image to correct for\n         * bumping into edges, keeping focus on the cropped area center and to\n         * maintain the illusion that the image is being straightened relative to the viewport center.\n         *\n         * @param {integer} previousAngle integer the previous image angle before straightening\n         */\n        _adjustEditorElementsOnStraighten: function(previousAngle) {\n            var scaledImageDimensions = this.getScaledImageDimensions();\n            var angleDelta = this.image.angle - previousAngle;\n            var state = this.cropperState;\n\n            var currentZoomRatio = this.zoomRatio;\n            var adjustmentRatio = 1;\n\n            var deltaX, deltaY, newCenterX, newCenterY, sizeFactor;\n\n            do {\n                // Get the cropper center coordinates\n                var cropperCenterX = state.offsetX;\n                var cropperCenterY = state.offsetY;\n                var angleInRadians = angleDelta * (Math.PI / 180);\n\n                // Calculate how the cropper would need to move in a circle to maintain\n                // the focus on the same region if the image was rotated with zoom intact.\n                newCenterX = cropperCenterX * Math.cos(angleInRadians) - cropperCenterY * Math.sin(angleInRadians);\n                newCenterY = cropperCenterX * Math.sin(angleInRadians) + cropperCenterY * Math.cos(angleInRadians);\n\n                sizeFactor = scaledImageDimensions.width / state.imageDimensions.width;\n\n                // Figure out the final image offset to keep the viewport focused where we need it\n                deltaX = newCenterX * currentZoomRatio * sizeFactor;\n                deltaY = newCenterY * currentZoomRatio * sizeFactor;\n\n                // If the image would creep in the viewport, figure out how to math around it.\n                var imageVertices = this.getImageVerticeCoords(currentZoomRatio);\n                var rectangle = {\n                    width: this.viewport.width,\n                    height: this.viewport.height,\n                    left: this.editorWidth / 2 - this.viewport.width / 2 + deltaX,\n                    top: this.editorHeight / 2 - this.viewport.height / 2 + deltaY\n                };\n                adjustmentRatio = this._getZoomRatioToFitRectangle(rectangle, imageVertices);\n                currentZoomRatio = currentZoomRatio * adjustmentRatio;\n\n                // If we had to make adjustments, do the calculations again\n            } while (adjustmentRatio !== 1);\n\n            // Reposition the image correctly\n            this.image.set({\n                left: this.editorWidth / 2 - deltaX,\n                top: this.editorHeight / 2 - deltaY\n            });\n\n            // Finally, store the new cropper state to reflect the rotation change.\n            state.offsetX = newCenterX;\n            state.offsetY = newCenterY;\n            state.width = this.viewport.width / currentZoomRatio / sizeFactor;\n            state.height = this.viewport.height / currentZoomRatio / sizeFactor;\n\n            this.storeCropperState(state);\n\n            // Zoom the image in and we're done.\n            this.zoomRatio = currentZoomRatio;\n\n            if (this.focalPoint) {\n                this._adjustFocalPointByAngle(angleDelta);\n\n                if (!this._isCenterInside(this.focalPoint, this.viewport)) {\n                    this.focalPoint.set({opacity: 0});\n                } else {\n                    this.focalPoint.set({opacity: 1});\n                }\n            } else if (angleDelta !== 0) {\n                this._resetFocalPointPosition();\n            }\n\n            this._zoomImage();\n        },\n\n        /**\n         * If focal point is active and outside of viewport after straightening, reset it.\n         */\n        _cleanupFocalPointAfterStraighten: function() {\n            if (this.focalPoint && !this._isCenterInside(this.focalPoint, this.viewport)) {\n                this.focalPoint.set({opacity: 1});\n                var state = this.focalPointState;\n                state.offsetX = 0;\n                state.offsetY = 0;\n                this.storeFocalPointState(state);\n                this.toggleFocalPoint();\n            }\n        },\n\n        /**\n         * Reset focal point to the middle of image.\n         */\n        _resetFocalPointPosition: function () {\n            var state = this.focalPointState;\n            state.offsetX = 0;\n            state.offsetY = 0;\n            this.storeFocalPointState(state);\n        },\n\n        /**\n         * Returns true if a center of an object is inside another rectangle shaped object that is not rotated.\n         *\n         * @param object\n         * @param containingObject\n         *\n         * @returns {boolean}\n         */\n        _isCenterInside: function(object, containingObject) {\n            return (object.left > containingObject.left - containingObject.width / 2\n                && object.top > containingObject.top - containingObject.height / 2\n                && object.left < containingObject.left + containingObject.width / 2\n                && object.top < containingObject.top + containingObject.height / 2\n            );\n        },\n\n        /**\n         * Adjust the focal point by an angle in degrees.\n         * @param angle\n         */\n        _adjustFocalPointByAngle: function(angle) {\n            var angleInRadians = angle * (Math.PI / 180);\n            var state = this.focalPointState;\n\n            var focalX = state.offsetX;\n            var focalY = state.offsetY;\n\n            // Calculate how the focal point would need to move in a circle to keep on the same spot\n            // on the image if it was rotated with zoom intact.\n            var newFocalX = focalX * Math.cos(angleInRadians) - focalY * Math.sin(angleInRadians);\n            var newFocalY = focalX * Math.sin(angleInRadians) + focalY * Math.cos(angleInRadians);\n            var sizeFactor = this.getScaledImageDimensions().width / state.imageDimensions.width;\n\n            var adjustedFocalX = newFocalX * sizeFactor * this.zoomRatio;\n            var adjustedFocalY = newFocalY * sizeFactor * this.zoomRatio;\n\n            this.focalPoint.left = this.image.left + adjustedFocalX;\n            this.focalPoint.top = this.image.top + adjustedFocalY;\n\n            state.offsetX = newFocalX;\n            state.offsetY = newFocalY;\n            this.storeFocalPointState(state);\n        },\n\n        /**\n         * Get the zoom ratio required to fit a rectangle within another rectangle, that is defined by vertices.\n         * If the rectangle fits, 1 will be returned.\n         *\n         * @param rectangle\n         * @param containingVertices\n         */\n        _getZoomRatioToFitRectangle: function(rectangle, containingVertices) {\n            var rectangleVertices = this._getRectangleVertices(rectangle);\n            var vertex;\n\n            // Check if any of the viewport vertices end up out of bounds\n            for (var verticeIndex = 0; verticeIndex < rectangleVertices.length; verticeIndex++) {\n                vertex = rectangleVertices[verticeIndex];\n\n                if (!this.arePointsInsideRectangle([vertex], containingVertices)) {\n                    break;\n                }\n\n                vertex = false;\n            }\n\n            // If there's no vertex set after loop, it means that all of them are inside the image rectangle\n            var adjustmentRatio;\n\n            if (!vertex) {\n                adjustmentRatio = 1;\n            } else {\n                // Find out which edge got crossed by the vertex\n                var edge = this._getEdgeCrossed(containingVertices, vertex);\n\n                var rectangleCenter = {\n                    x: rectangle.left + rectangle.width / 2,\n                    y: rectangle.top + rectangle.height / 2\n                };\n\n                // Calculate how much further that edge needs to be.\n                // https://en.wikipedia.org/wiki/Distance_from_a_point_to_a_line#Line_defined_by_two_points\n                var distanceFromVertexToEdge = Math.abs((edge[1].y - edge[0].y) * vertex.x - (edge[1].x - edge[0].x) * vertex.y + edge[1].x * edge[0].y - edge[1].y * edge[0].x) / Math.sqrt(Math.pow(edge[1].y - edge[0].y, 2) + Math.pow(edge[1].x - edge[0].x, 2));\n                var distanceFromCenterToEdge = Math.abs((edge[1].y - edge[0].y) * rectangleCenter.x - (edge[1].x - edge[0].x) * rectangleCenter.y + edge[1].x * edge[0].y - edge[1].y * edge[0].x) / Math.sqrt(Math.pow(edge[1].y - edge[0].y, 2) + Math.pow(edge[1].x - edge[0].x, 2));\n\n                // Adjust the zoom ratio\n                adjustmentRatio = ((distanceFromVertexToEdge + distanceFromCenterToEdge) / distanceFromCenterToEdge);\n            }\n\n            return adjustmentRatio;\n        },\n\n        /**\n         * Save the image.\n         *\n         * @param ev\n         */\n        saveImage: function(ev) {\n            var $button = $(ev.currentTarget);\n            if ($button.hasClass('disabled')) {\n                return false;\n            }\n\n            $('.btn', this.$buttons).addClass('disabled');\n            this.$buttons.append('<div class=\"spinner\"></div>');\n\n            var postData = {\n                assetId: this.assetId,\n                viewportRotation: this.viewportRotation,\n                imageRotation: this.imageStraightenAngle,\n                replace: $button.hasClass('replace') ? 1 : 0\n            };\n\n            if (this.cropperState) {\n                var cropData = {};\n\n                cropData.height = this.cropperState.height;\n                cropData.width = this.cropperState.width;\n                cropData.offsetX = this.cropperState.offsetX;\n                cropData.offsetY = this.cropperState.offsetY;\n\n                postData.imageDimensions = this.cropperState.imageDimensions;\n\n                postData.cropData = cropData;\n            } else {\n                postData.imageDimensions = this.getScaledImageDimensions();\n            }\n\n            if (this.focalPoint) {\n                postData.focalPoint = this.focalPointState;\n            }\n\n            postData.flipData = this.flipData;\n            postData.zoom = this.zoomRatio;\n\n            Craft.postActionRequest('assets/save-image', postData, function(data) {\n                this.$buttons.find('.btn').removeClass('disabled').end().find('.spinner').remove();\n\n                if (data.error) {\n                    alert(data.error);\n                    return;\n                }\n\n                this.onSave();\n                this.hide();\n                Craft.cp.runQueue();\n            }.bind(this));\n        },\n\n        /**\n         * Return image zoom ratio depending on the straighten angle to cover a viewport by given dimensions.\n         *\n         * @param dimensions\n         */\n        getZoomToCoverRatio: function(dimensions) {\n            // Convert the angle to radians\n            var angleInRadians = Math.abs(this.imageStraightenAngle) * (Math.PI / 180);\n\n            // Calculate the dimensions of the scaled image using the magic of math\n            var scaledWidth = Math.sin(angleInRadians) * dimensions.height + Math.cos(angleInRadians) * dimensions.width;\n            var scaledHeight = Math.sin(angleInRadians) * dimensions.width + Math.cos(angleInRadians) * dimensions.height;\n\n            // Calculate the ratio\n            return Math.max(scaledWidth / dimensions.width, scaledHeight / dimensions.height);\n        },\n\n        /**\n         * Return image zoom ratio depending on the straighten angle to fit inside a viewport by given dimensions.\n         *\n         * @param dimensions\n         */\n        getZoomToFitRatio: function(dimensions) {\n\n            // Get the bounding box for a rotated image\n            var boundingBox = this._getImageBoundingBox(dimensions);\n\n            // Scale the bounding box to fit\n            var scale = 1;\n            if (boundingBox.height > this.editorHeight || boundingBox.width > this.editorWidth) {\n                var vertScale = this.editorHeight / boundingBox.height;\n                var horiScale = this.editorWidth / boundingBox.width;\n                scale = Math.min(horiScale, vertScale);\n            }\n\n            return scale;\n        },\n\n        /**\n         * Return the combined zoom ratio to fit a rectangle inside image that's been zoomed to fit.\n         */\n        getCombinedZoomRatio: function(dimensions) {\n            return this.getZoomToCoverRatio(dimensions) / this.getZoomToFitRatio(dimensions);\n        },\n\n        /**\n         * Draw the grid.\n         *\n         * @private\n         */\n        _showGrid: function() {\n            if (!this.grid) {\n                var strokeOptions = {\n                    strokeWidth: 1,\n                    stroke: 'rgba(255,255,255,0.5)'\n                };\n\n                var lineCount = 8;\n                var gridWidth = this.viewport.width;\n                var gridHeight = this.viewport.height;\n                var xStep = gridWidth / (lineCount + 1);\n                var yStep = gridHeight / (lineCount + 1);\n\n                var grid = [\n                    new fabric.Rect({\n                        strokeWidth: 2,\n                        stroke: 'rgba(255,255,255,1)',\n                        originX: 'center',\n                        originY: 'center',\n                        width: gridWidth,\n                        height: gridHeight,\n                        left: gridWidth / 2,\n                        top: gridHeight / 2,\n                        fill: 'rgba(255,255,255,0)'\n                    })\n                ];\n\n                var i;\n                for (i = 1; i <= lineCount; i++) {\n                    grid.push(new fabric.Line([i * xStep, 0, i * xStep, gridHeight], strokeOptions));\n                }\n                for (i = 1; i <= lineCount; i++) {\n                    grid.push(new fabric.Line([0, i * yStep, gridWidth, i * yStep], strokeOptions));\n                }\n\n                this.grid = new fabric.Group(grid, {\n                    left: this.editorWidth / 2,\n                    top: this.editorHeight / 2,\n                    originX: 'center',\n                    originY: 'center',\n                    angle: this.viewport.angle\n                });\n\n                this.canvas.add(this.grid);\n                this.renderImage();\n            }\n        },\n\n        /**\n         * Hide the grid\n         */\n        _hideGrid: function() {\n            this.canvas.remove(this.grid);\n            this.grid = null;\n            this.renderImage();\n        },\n\n        /**\n         * Remove all the events when hiding the editor.\n         */\n        onFadeOut: function() {\n            this.removeListener(this.$croppingCanvas, 'mousemove', this._handleMouseMove.bind(this));\n            this.removeListener(this.$croppingCanvas, 'mousedown', this._handleMouseDown.bind(this));\n            this.removeListener(this.$croppingCanvas, 'mouseup', this._handleMouseUp.bind(this));\n            this.removeListener(this.$croppingCanvas, 'mouseout', function(ev) {\n                this._handleMouseUp(ev);\n                this._handleMouseMove(ev);\n            }.bind(this));\n            this.destroy();\n        },\n\n        /**\n         * Make sure underlying content is not scrolled by accident.\n         */\n        show: function() {\n            this.base();\n\n            $('html').addClass('noscroll');\n        },\n\n        /**\n         * Allow the content to scroll.\n         */\n        hide: function() {\n            this.removeAllListeners();\n            this.straighteningInput.removeAllListeners();\n            $('html').removeClass('noscroll');\n            this.base();\n        },\n\n        /**\n         * onSave callback.\n         */\n        onSave: function() {\n            this.settings.onSave();\n            this.trigger('save');\n        },\n\n        /**\n         * Enable the rotation slider.\n         */\n        enableSlider: function() {\n            this.$imageTools.removeClass('hidden');\n        },\n\n        /**\n         * Disable the rotation slider.\n         */\n        disableSlider: function() {\n            this.$imageTools.addClass('hidden');\n        },\n\n        /**\n         * Switch to crop mode.\n         */\n        enableCropMode: function() {\n            var imageDimensions = this.getScaledImageDimensions();\n            this.zoomRatio = this.getZoomToFitRatio(imageDimensions);\n\n            var viewportProperties = {\n                width: this.editorWidth,\n                height: this.editorHeight\n            };\n\n            var imageProperties = {\n                width: imageDimensions.width * this.zoomRatio,\n                height: imageDimensions.height * this.zoomRatio,\n                left: this.editorWidth / 2,\n                top: this.editorHeight / 2\n            };\n\n            var callback = function() {\n                this._setFittedImageVerticeCoordinates();\n\n                // Restore cropper\n                var state = this.cropperState;\n                var scaledImageDimensions = this.getScaledImageDimensions();\n                var sizeFactor = scaledImageDimensions.width / state.imageDimensions.width;\n\n                // Restore based on the stored information\n                var cropperData = {\n                    left: this.image.left + (state.offsetX * sizeFactor * this.zoomRatio),\n                    top: this.image.top + (state.offsetY * sizeFactor * this.zoomRatio),\n                    width: state.width * sizeFactor * this.zoomRatio,\n                    height: state.height * sizeFactor * this.zoomRatio\n                };\n\n                this._showCropper(cropperData);\n\n                if (this.focalPoint) {\n                    sizeFactor = scaledImageDimensions.width / this.focalPointState.imageDimensions.width;\n                    this.focalPoint.left = this.image.left + (this.focalPointState.offsetX * sizeFactor * this.zoomRatio);\n                    this.focalPoint.top = this.image.top + (this.focalPointState.offsetY * sizeFactor * this.zoomRatio);\n                    this.canvas.add(this.focalPoint);\n                }\n            }.bind(this);\n\n            this._editorModeTransition(callback, imageProperties, viewportProperties);\n        },\n\n        /**\n         * Switch out of crop mode.\n         */\n        disableCropMode: function() {\n\n            var viewportProperties = {};\n\n            var imageProperties = {\n                left: this.editorWidth / 2,\n                top: this.editorHeight / 2\n            };\n\n            this._hideCropper();\n            var targetZoom = this.getZoomToCoverRatio(this.getScaledImageDimensions()) * this.scaleFactor;\n            var inverseZoomFactor = targetZoom / this.zoomRatio;\n            this.zoomRatio = targetZoom;\n\n            var offsetX = this.clipper.left - this.image.left;\n            var offsetY = this.clipper.top - this.image.top;\n\n            var imageOffsetX = offsetX * inverseZoomFactor;\n            var imageOffsetY = offsetY * inverseZoomFactor;\n            imageProperties.left = (this.editorWidth / 2) - imageOffsetX;\n            imageProperties.top = (this.editorHeight / 2) - imageOffsetY;\n\n            // Calculate the cropper dimensions after all the zooming\n            viewportProperties.height = this.clipper.height * inverseZoomFactor;\n            viewportProperties.width = this.clipper.width * inverseZoomFactor;\n\n            if (!this.focalPoint || (this.focalPoint && !this._isCenterInside(this.focalPoint, this.clipper))) {\n                if (this.focalPoint) {\n                    this.toggleFocalPoint();\n                }\n\n                this._resetFocalPointPosition();\n            }\n\n            var callback = function() {\n                // Reposition focal point correctly\n                if (this.focalPoint) {\n                    var sizeFactor = this.getScaledImageDimensions().width / this.focalPointState.imageDimensions.width;\n                    this.focalPoint.left = this.image.left + (this.focalPointState.offsetX * sizeFactor * this.zoomRatio);\n                    this.focalPoint.top = this.image.top + (this.focalPointState.offsetY * sizeFactor * this.zoomRatio);\n                    this.canvas.add(this.focalPoint);\n                }\n            }.bind(this);\n\n            this._editorModeTransition(callback, imageProperties, viewportProperties);\n        },\n\n        /**\n         * Transition between cropping end editor modes\n         *\n         * @param callback\n         * @param imageProperties\n         * @param viewportProperties\n         * @private\n         */\n        _editorModeTransition: function (callback, imageProperties, viewportProperties) {\n\n            if (!this.animationInProgress) {\n                this.animationInProgress = true;\n\n                // Without this it looks semi-broken during animation\n                if (this.focalPoint) {\n                    this.canvas.remove(this.focalPoint);\n                    this.renderImage();\n                }\n\n                this.image.animate(imageProperties, {\n                    onChange: this.canvas.renderAll.bind(this.canvas),\n                    duration: this.settings.animationDuration,\n                    onComplete: function() {\n                        callback();\n                        this.animationInProgress = false;\n                        this.renderImage();\n                    }.bind(this)\n                });\n\n                this.viewport.animate(viewportProperties, {\n                    duration: this.settings.animationDuration\n                });\n            }\n        },\n\n        _showSpinner: function() {\n            this.$spinnerCanvas = $('<canvas id=\"spinner-canvas\"></canvas>').appendTo($('.image', this.$container));\n            var canvas = document.getElementById('spinner-canvas');\n            var context = canvas.getContext('2d');\n            var start = new Date();\n            var lines = 16,\n                cW = context.canvas.width,\n                cH = context.canvas.height;\n\n            var draw = function() {\n                var rotation = parseInt(((new Date() - start) / 1000) * lines) / lines;\n                context.save();\n                context.clearRect(0, 0, cW, cH);\n                context.translate(cW / 2, cH / 2);\n                context.rotate(Math.PI * 2 * rotation);\n                for (var i = 0; i < lines; i++) {\n\n                    context.beginPath();\n                    context.rotate(Math.PI * 2 / lines);\n                    context.moveTo(cW / 10, 0);\n                    context.lineTo(cW / 4, 0);\n                    context.lineWidth = cW / 30;\n                    context.strokeStyle = \"rgba(255,255,255,\" + i / lines + \")\";\n                    context.stroke();\n                }\n                context.restore();\n            };\n            this.spinnerInterval = window.setInterval(draw, 1000 / 30);\n        },\n\n        _hideSpinner: function () {\n            window.clearInterval(this.spinnerInterval);\n            this.$spinnerCanvas.remove();\n            this.$spinnerCanvas = null;\n        },\n\n        /**\n         * Show the cropper.\n         *\n         * @param clipperData\n         */\n        _showCropper: function(clipperData) {\n            this._setupCropperLayer(clipperData);\n            this._redrawCropperElements();\n            this.renderCropper();\n        },\n\n        /**\n         * Hide the cropper.\n         */\n        _hideCropper: function() {\n            if (this.clipper) {\n                this.croppingCanvas.remove(this.clipper);\n                this.croppingCanvas.remove(this.croppingShade);\n                this.croppingCanvas.remove(this.cropperHandles);\n                this.croppingCanvas.remove(this.cropperGrid);\n                this.croppingCanvas.remove(this.croppingRectangle);\n\n                this.croppingCanvas = null;\n                this.renderCropper = null;\n            }\n        },\n\n        /**\n         * Draw the cropper.\n         *\n         * @param clipperData\n         */\n        _setupCropperLayer: function(clipperData) {\n            // Set up the canvas for cropper\n            this.croppingCanvas = new fabric.StaticCanvas('cropping-canvas', {\n                backgroundColor: 'rgba(0,0,0,0)',\n                hoverCursor: 'default',\n                selection: false\n            });\n\n            this.croppingCanvas.setDimensions({\n                width: this.editorWidth,\n                height: this.editorHeight\n            });\n\n            this.renderCropper = function() {\n                Garnish.requestAnimationFrame(this.croppingCanvas.renderAll.bind(this.croppingCanvas));\n            }.bind(this);\n\n\n            $('#cropping-canvas', this.$editorContainer).css({\n                position: 'absolute',\n                top: 0,\n                left: 0\n            });\n\n            this.croppingShade = new fabric.Rect({\n                left: this.editorWidth / 2,\n                top: this.editorHeight / 2,\n                originX: 'center',\n                originY: 'center',\n                width: this.editorWidth,\n                height: this.editorHeight,\n                fill: 'rgba(0,0,0,0.7)'\n            });\n\n            // Calculate the cropping rectangle size\n            var imageDimensions = this.getScaledImageDimensions();\n            var rectangleRatio = this.imageStraightenAngle === 0 ? 1 : this.getCombinedZoomRatio(imageDimensions) * 1.2;\n            var rectWidth = imageDimensions.width / rectangleRatio;\n            var rectHeight = imageDimensions.height / rectangleRatio;\n\n            if (this.hasOrientationChanged()) {\n                var temp = rectHeight;\n                rectHeight = rectWidth;\n                rectWidth = temp;\n            }\n\n            // Set up the cropping viewport rectangle\n            this.clipper = new fabric.Rect({\n                left: this.editorWidth / 2,\n                top: this.editorHeight / 2,\n                originX: 'center',\n                originY: 'center',\n                width: rectWidth,\n                height: rectHeight,\n                stroke: 'black',\n                fill: 'rgba(128,0,0,1)',\n                strokeWidth: 0\n            });\n\n            // Set from clipper data\n            if (clipperData) {\n                this.clipper.set(clipperData);\n            }\n\n            this.clipper.globalCompositeOperation = 'destination-out';\n            this.croppingCanvas.add(this.croppingShade);\n            this.croppingCanvas.add(this.clipper);\n        },\n\n        /**\n         * Redraw the cropper boundaries\n         */\n        _redrawCropperElements: function() {\n            if (this.cropperHandles) {\n                this.croppingCanvas.remove(this.cropperHandles);\n                this.croppingCanvas.remove(this.cropperGrid);\n                this.croppingCanvas.remove(this.croppingRectangle);\n            }\n            var lineOptions = {\n                strokeWidth: 4,\n                stroke: 'rgb(255,255,255)',\n                fill: false\n            };\n\n            var gridOptions = {\n                strokeWidth: 2,\n                stroke: 'rgba(255,255,255,0.5)'\n            };\n\n            // Draw the handles\n            var pathGroup = [\n                new fabric.Path('M 0,10 L 0,0 L 10,0', lineOptions),\n                new fabric.Path('M ' + (this.clipper.width - 8) + ',0 L ' + (this.clipper.width + 4) + ',0 L ' + (this.clipper.width + 4) + ',10', lineOptions),\n                new fabric.Path('M ' + (this.clipper.width + 4) + ',' + (this.clipper.height - 8) + ' L' + (this.clipper.width + 4) + ',' + (this.clipper.height + 4) + ' L ' + (this.clipper.width - 8) + ',' + (this.clipper.height + 4), lineOptions),\n                new fabric.Path('M 10,' + (this.clipper.height + 4) + ' L 0,' + (this.clipper.height + 4) + ' L 0,' + (this.clipper.height - 8), lineOptions)\n            ];\n\n            this.cropperHandles = new fabric.Group(pathGroup, {\n                left: this.clipper.left,\n                top: this.clipper.top,\n                originX: 'center',\n                originY: 'center'\n            });\n\n            // Don't forget the rectangle\n            this.croppingRectangle = new fabric.Rect({\n                left: this.clipper.left,\n                top: this.clipper.top,\n                width: this.clipper.width,\n                height: this.clipper.height,\n                fill: 'rgba(0,0,0,0)',\n                stroke: 'rgba(255,255,255,0.8)',\n                strokeWidth: 2,\n                originX: 'center',\n                originY: 'center'\n            });\n\n            this.cropperGrid = new fabric.Group(\n                [\n                    new fabric.Line([this.clipper.width * 0.33, 0, this.clipper.width * 0.33, this.clipper.height], gridOptions),\n                    new fabric.Line([this.clipper.width * 0.66, 0, this.clipper.width * 0.66, this.clipper.height], gridOptions),\n                    new fabric.Line([0, this.clipper.height * 0.33, this.clipper.width, this.clipper.height * 0.33], gridOptions),\n                    new fabric.Line([0, this.clipper.height * 0.66, this.clipper.width, this.clipper.height * 0.66], gridOptions)\n                ], {\n                    left: this.clipper.left,\n                    top: this.clipper.top,\n                    originX: 'center',\n                    originY: 'center'\n                }\n            );\n\n            this.croppingCanvas.add(this.cropperHandles);\n            this.croppingCanvas.add(this.cropperGrid);\n            this.croppingCanvas.add(this.croppingRectangle);\n        },\n\n        /**\n         * Reposition the cropper when the image editor dimensions change.\n         *\n         * @param previousImageArea\n         */\n        _repositionCropper: function(previousImageArea) {\n            if (!this.croppingCanvas) {\n                return;\n            }\n\n            // Get the current clipper offset relative to center\n            var currentOffset = {\n                x: this.clipper.left - this.croppingCanvas.width / 2,\n                y: this.clipper.top - this.croppingCanvas.height / 2\n            };\n\n            // Resize the cropping canvas\n            this.croppingCanvas.setDimensions({\n                width: this.editorWidth,\n                height: this.editorHeight\n            });\n\n            // Check by what factor will the new final bounding box be different\n            var currentArea = this._getBoundingRectangle(this.imageVerticeCoords);\n            var areaFactor = currentArea.width / previousImageArea.width;\n\n            // Adjust the cropper size to scale along with the bounding box\n            this.clipper.width = Math.round(this.clipper.width * areaFactor);\n            this.clipper.height = Math.round(this.clipper.height * areaFactor);\n\n            // Adjust the coordinates: re-position clipper in relation to the new center to adjust\n            // for editor size changes and then multiply by the size factor to adjust for image size changes\n            this.clipper.left = this.editorWidth / 2 + (currentOffset.x * areaFactor);\n            this.clipper.top = this.editorHeight / 2 + (currentOffset.y * areaFactor);\n\n            // Resize the cropping shade\n            this.croppingShade.set({\n                width: this.editorWidth,\n                height: this.editorHeight,\n                left: this.editorWidth / 2,\n                top: this.editorHeight / 2\n            });\n\n            this._redrawCropperElements();\n            this.renderCropper();\n        },\n\n        /**\n         * Get the dimensions of a bounding rectangle by a set of four coordinates.\n         *\n         * @param coordinateSet\n         */\n        _getBoundingRectangle: function(coordinateSet) {\n            return {\n                width: Math.max(coordinateSet.a.x, coordinateSet.b.x, coordinateSet.c.x, coordinateSet.d.x) - Math.min(coordinateSet.a.x, coordinateSet.b.x, coordinateSet.c.x, coordinateSet.d.x),\n                height: Math.max(coordinateSet.a.y, coordinateSet.b.y, coordinateSet.c.y, coordinateSet.d.y) - Math.min(coordinateSet.a.y, coordinateSet.b.y, coordinateSet.c.y, coordinateSet.d.y)\n            };\n        },\n\n        /**\n         * Handle the mouse being clicked.\n         *\n         * @param ev\n         */\n        _handleMouseDown: function(ev) {\n            // Focal before resize before dragging\n            var focal = this.focalPoint && this._isMouseOver(ev, this.focalPoint);\n            var move = this.croppingCanvas && this._isMouseOver(ev, this.clipper);\n            var handle = this.croppingCanvas && this._cropperHandleHitTest(ev);\n\n            if (handle || move || focal) {\n                this.previousMouseX = ev.pageX;\n                this.previousMouseY = ev.pageY;\n\n                if (focal) {\n                    this.draggingFocal = true;\n                } else if (handle) {\n                    this.scalingCropper = handle;\n                } else if (move) {\n                    this.draggingCropper = true;\n                }\n            }\n        },\n\n        /**\n         * Handle the mouse being moved.\n         *\n         * @param ev\n         */\n        _handleMouseMove: function(ev) {\n            if (this.focalPoint && this.draggingFocal) {\n                this._handleFocalDrag(ev);\n                this.storeFocalPointState();\n                this.renderImage();\n            } else if (this.draggingCropper || this.scalingCropper) {\n                if (this.draggingCropper) {\n                    this._handleCropperDrag(ev);\n                } else {\n                    this._handleCropperResize(ev);\n                }\n\n                this._redrawCropperElements();\n\n                this.storeCropperState();\n                this.renderCropper();\n            } else {\n                this._setMouseCursor(ev);\n            }\n\n            this.previousMouseX = ev.pageX;\n            this.previousMouseY = ev.pageY;\n        },\n\n        /**\n         * Handle mouse being released.\n         *\n         * @param ev\n         */\n        _handleMouseUp: function(ev) {\n            this.draggingCropper = false;\n            this.scalingCropper = false;\n            this.draggingFocal = false;\n        },\n\n        /**\n         * Handle cropper being dragged.\n         *\n         * @param ev\n         */\n        _handleCropperDrag: function(ev) {\n            var deltaX = ev.pageX - this.previousMouseX;\n            var deltaY = ev.pageY - this.previousMouseY;\n\n            if (deltaX === 0 && deltaY === 0) {\n                return;\n            }\n\n            var rectangle = {\n                left: this.clipper.left - this.clipper.width / 2,\n                top: this.clipper.top - this.clipper.height / 2,\n                width: this.clipper.width,\n                height: this.clipper.height\n            };\n\n            var vertices = this._getRectangleVertices(rectangle, deltaX, deltaY);\n\n            // Just make sure that the cropper stays inside the image\n            if (!this.arePointsInsideRectangle(vertices, this.imageVerticeCoords)) {\n                return;\n            }\n\n            this.clipper.set({\n                left: this.clipper.left + deltaX,\n                top: this.clipper.top + deltaY\n            });\n\n        },\n\n        /**\n         * Handle focal point being dragged.\n         *\n         * @param ev\n         */\n        _handleFocalDrag: function(ev) {\n            if (this.focalPoint) {\n                var deltaX = ev.pageX - this.previousMouseX;\n                var deltaY = ev.pageY - this.previousMouseY;\n\n                if (deltaX === 0 && deltaY === 0) {\n                    return;\n                }\n\n                var newX = this.focalPoint.left + deltaX;\n                var newY = this.focalPoint.top + deltaY;\n\n                // Just make sure that the focal point stays inside the image\n                if (this.currentView === 'crop') {\n                    if (!this.arePointsInsideRectangle([{x: newX, y: newY}], this.imageVerticeCoords)) {\n                        return;\n                    }\n                } else {\n                    if (!(this.viewport.left - this.viewport.width / 2 - newX < 0 && this.viewport.left + this.viewport.width / 2 - newX > 0\n                        && this.viewport.top - this.viewport.height / 2 - newY < 0 && this.viewport.top + this.viewport.height / 2 - newY > 0)) {\n                        return;\n                    }\n                }\n\n                this.focalPoint.set({\n                    left: this.focalPoint.left + deltaX,\n                    top: this.focalPoint.top + deltaY\n                });\n            }\n        },\n\n        /**\n         * Set the cropping constraint\n         * @param constraint\n         */\n        setCroppingConstraint: function(constraint) {\n\n            // In case this caused the sidebar width to change.\n            this.updateSizeAndPosition();\n\n            switch (constraint) {\n                case 'none':\n                    constraint = false;\n                    break;\n\n                case 'original':\n                    constraint = this.originalWidth / this.originalHeight;\n                    break;\n\n                case 'current':\n                    constraint = this.clipper.width / this.clipper.height;\n                    break;\n\n                default:\n                    constraint = parseFloat(constraint);\n                    break;\n            }\n\n            this.croppingConstraint = constraint;\n        },\n\n        /**\n         * Enforce the cropping constraint\n         */\n        enforceCroppingConstraint: function () {\n            if (this.animationInProgress || !this.croppingConstraint) {\n                return;\n            }\n\n            this.animationInProgress = true;\n\n            // Mock the clipping rectangle for collision tests\n            var rectangle = {\n                left: this.clipper.left - this.clipper.width / 2,\n                top: this.clipper.top - this.clipper.height / 2,\n                width: this.clipper.width,\n                height: this.clipper.height\n            };\n\n            // If wider than it should be\n            if (this.clipper.width > this.clipper.height * this.croppingConstraint)\n            {\n                var previousHeight = rectangle.height;\n\n                // Make it taller!\n                rectangle.height = this.clipper.width / this.croppingConstraint;\n\n                // Getting really awkward having to convert between 0;0 being center or top-left corner.\n                rectangle.top -= (rectangle.height - previousHeight) / 2;\n\n                // If the clipper would end up out of bounds, make it narrower instead.\n                if (!this.arePointsInsideRectangle(this._getRectangleVertices(rectangle), this.imageVerticeCoords)) {\n                    rectangle.width = this.clipper.height * this.croppingConstraint;\n                    rectangle.height = rectangle.width / this.croppingConstraint;\n                }\n            } else {\n                // Follow the same pattern, if taller than it should be.\n                var previousWidth = rectangle.width;\n                rectangle.width = this.clipper.height * this.croppingConstraint;\n                rectangle.left -= (rectangle.width - previousWidth) / 2;\n\n                if (!this.arePointsInsideRectangle(this._getRectangleVertices(rectangle), this.imageVerticeCoords)) {\n                    rectangle.height = this.clipper.width / this.croppingConstraint;\n                    rectangle.width = rectangle.height * this.croppingConstraint;\n                }\n            }\n\n            var properties = {\n                height: rectangle.height,\n                width: rectangle.width\n            };\n\n            // Make sure to redraw cropper handles and gridlines when resizing\n            this.clipper.animate(properties, {\n                onChange: function() {\n                    this._redrawCropperElements();\n                    this.croppingCanvas.renderAll();\n                }.bind(this),\n                duration: this.settings.animationDuration,\n                onComplete: function() {\n                    this._redrawCropperElements();\n                    this.animationInProgress = false;\n                    this.renderCropper();\n                }.bind(this)\n            });\n        },\n\n        /**\n         * Handle cropper being resized.\n         *\n         * @param ev\n         */\n        _handleCropperResize: function(ev) {\n            // Size deltas\n            var deltaX = ev.pageX - this.previousMouseX;\n            var deltaY = ev.pageY - this.previousMouseY;\n\n            // Center deltas\n            var topDelta = 0;\n            var leftDelta = 0;\n\n            if (this.scalingCropper === 'b' || this.scalingCropper === 't') {\n                deltaX = 0;\n            }\n\n            if (this.scalingCropper === 'l' || this.scalingCropper === 'r') {\n                deltaY = 0;\n            }\n\n            if (deltaX === 0 && deltaY === 0) {\n                return;\n            }\n\n            var rectangle = {\n                left: this.clipper.left - this.clipper.width / 2,\n                top: this.clipper.top - this.clipper.height / 2,\n                width: this.clipper.width,\n                height: this.clipper.height\n            };\n\n            // Lock the aspect ratio if needed\n            if (this.croppingConstraint) {\n                var change = 0;\n\n                // Take into account the mouse direction and figure out the \"real\" change in cropper size\n                switch (this.scalingCropper) {\n                    case 't':\n                        change = -deltaY;\n                        break;\n                    case 'b':\n                        change = deltaY;\n                        break;\n                    case 'r':\n                        change = deltaX;\n                        break;\n                    case 'l':\n                        change = -deltaX;\n                        break;\n                    case 'tr':\n                        change = -deltaY + deltaX;\n                        break;\n                    case 'tl':\n                        change = -deltaY - deltaX;\n                        break;\n                    case 'br':\n                        change = deltaY + deltaX;\n                        break;\n                    case 'bl':\n                        change = deltaY - deltaX;\n                        break;\n                }\n\n                if (this.croppingConstraint > 1) {\n                    deltaX = change;\n                    deltaY = deltaX / this.croppingConstraint;\n                } else {\n                    deltaY = change;\n                    deltaX = deltaY * this.croppingConstraint;\n                }\n\n                rectangle.height += deltaY;\n                rectangle.width += deltaX;\n\n                // Make the cropper compress/expand relative to the correct edge to make it feel \"right\"\n                if (this.scalingCropper.match(/t/)) {\n                    rectangle.top -= deltaY;\n                    rectangle.left -= deltaX / 2;\n                    topDelta = -deltaY/2;\n                }\n\n                if (this.scalingCropper.match(/b/)) {\n                    rectangle.left += -deltaX / 2;\n                    topDelta = deltaY/2;\n                }\n\n                if (this.scalingCropper.match(/r/)) {\n                    rectangle.top += -deltaY / 2;\n                    leftDelta = deltaX/2;\n                }\n\n                if (this.scalingCropper.match(/l/)) {\n                    rectangle.top -= deltaY / 2;\n                    rectangle.left -= deltaX;\n                    leftDelta = -deltaX/2;\n                }\n            } else {\n\n                // Lock the aspect ratio\n                if (this.shiftKeyHeld &&\n                    (this.scalingCropper === 'tl' || this.scalingCropper === 'tr' ||\n                    this.scalingCropper === 'bl' || this.scalingCropper === 'br')\n                ) {\n                    var ratio;\n                    if (Math.abs(deltaX) > Math.abs(deltaY)) {\n                        ratio = this.clipper.width / this.clipper.height;\n                        deltaY = deltaX / ratio;\n                        deltaY *= (this.scalingCropper === 'tr' || this.scalingCropper === 'bl') ? -1 : 1;\n                    } else {\n                        ratio = this.clipper.width / this.clipper.height;\n                        deltaX = deltaY * ratio;\n                        deltaX *= (this.scalingCropper === 'tr' || this.scalingCropper === 'bl') ? -1 : 1;\n                    }\n                }\n\n                if (this.scalingCropper.match(/t/)) {\n                    rectangle.top += deltaY;\n                    rectangle.height -= deltaY;\n                }\n                if (this.scalingCropper.match(/b/)) {\n                    rectangle.height += deltaY;\n                }\n                if (this.scalingCropper.match(/r/)) {\n                    rectangle.width += deltaX;\n                }\n                if (this.scalingCropper.match(/l/)) {\n                    rectangle.left += deltaX;\n                    rectangle.width -= deltaX;\n                }\n\n                topDelta = deltaY/2;\n                leftDelta = deltaX/2;\n            }\n\n            if (rectangle.height < 30 || rectangle.width < 30) {\n                return;\n            }\n\n            if (!this.arePointsInsideRectangle(this._getRectangleVertices(rectangle), this.imageVerticeCoords)) {\n                return;\n            }\n\n            this.clipper.set({\n                top: this.clipper.top + topDelta,\n                left: this.clipper.left + leftDelta,\n                width: rectangle.width,\n                height: rectangle.height\n            });\n\n            this._redrawCropperElements();\n        },\n\n        /**\n         * Set mouse cursor by it's position over cropper.\n         *\n         * @param ev\n         */\n        _setMouseCursor: function(ev) {\n            var cursor = 'default';\n            var handle = this.croppingCanvas && this._cropperHandleHitTest(ev);\n            if (this.focalPoint && this._isMouseOver(ev, this.focalPoint)) {\n                cursor = 'pointer';\n            } else if (handle) {\n                if (handle === 't' || handle === 'b') {\n                    cursor = 'ns-resize';\n                } else if (handle === 'l' || handle === 'r') {\n                    cursor = 'ew-resize';\n                } else if (handle === 'tl' || handle === 'br') {\n                    cursor = 'nwse-resize';\n                } else if (handle === 'bl' || handle === 'tr') {\n                    cursor = 'nesw-resize';\n                }\n            } else if (this.croppingCanvas && this._isMouseOver(ev, this.clipper)) {\n                cursor = 'move';\n            }\n\n            $('.body').css('cursor', cursor);\n        },\n\n        /**\n         * Test whether the mouse cursor is on any cropper handles.\n         *\n         * @param ev\n         */\n        _cropperHandleHitTest: function(ev) {\n            var parentOffset = this.$croppingCanvas.offset();\n            var mouseX = ev.pageX - parentOffset.left;\n            var mouseY = ev.pageY - parentOffset.top;\n\n            // Compensate for center origin coordinate-wise\n            var lb = this.clipper.left - this.clipper.width / 2;\n            var rb = lb + this.clipper.width;\n            var tb = this.clipper.top - this.clipper.height / 2;\n            var bb = tb + this.clipper.height;\n\n            // Left side top/bottom\n            if (mouseX < lb + 10 && mouseX > lb - 3) {\n                if (mouseY < tb + 10 && mouseY > tb - 3) {\n                    return 'tl';\n                } else if (mouseY < bb + 3 && mouseY > bb - 10) {\n                    return 'bl';\n                }\n            }\n            // Right side top/bottom\n            if (mouseX > rb - 13 && mouseX < rb + 3) {\n                if (mouseY < tb + 10 && mouseY > tb - 3) {\n                    return 'tr';\n                } else if (mouseY < bb + 2 && mouseY > bb - 10) {\n                    return 'br';\n                }\n            }\n\n            // Left or right\n            if (mouseX < lb + 3 && mouseX > lb - 3 && mouseY < bb - 10 && mouseY > tb + 10) {\n                return 'l';\n            }\n            if (mouseX < rb + 1 && mouseX > rb - 5 && mouseY < bb - 10 && mouseY > tb + 10) {\n                return 'r';\n            }\n\n            // Top or bottom\n            if (mouseY < tb + 4 && mouseY > tb - 2 && mouseX > lb + 10 && mouseX < rb - 10) {\n                return 't';\n            }\n            if (mouseY < bb + 2 && mouseY > bb - 4 && mouseX > lb + 10 && mouseX < rb - 10) {\n                return 'b';\n            }\n\n            return false;\n        },\n\n        /**\n         * Test whether the mouse cursor is on a fabricJS object.\n         *\n         * @param object\n         * @param event\n         *\n         * @return boolean\n         */\n\n        _isMouseOver: function(event, object) {\n            var parentOffset = this.$croppingCanvas.offset();\n            var mouseX = event.pageX - parentOffset.left;\n            var mouseY = event.pageY - parentOffset.top;\n\n            // Compensate for center origin coordinate-wise\n            var lb = object.left - object.width / 2;\n            var rb = lb + object.width;\n            var tb = object.top - object.height / 2;\n            var bb = tb + object.height;\n\n            return (mouseX >= lb && mouseX <= rb && mouseY >= tb && mouseY <= bb);\n        },\n\n        /**\n         * Get vertices of a rectangle defined by left,top,height and width properties.\n         * Optionally it's possible to provide offsetX and offsetY values.\n         * Left and top properties of rectangle reference the top-left corner.\n         *\n         * @param rectangle\n         * @param [offsetX]\n         * @param [offsetY]\n         */\n        _getRectangleVertices: function(rectangle, offsetX, offsetY) {\n            if (typeof offsetX === 'undefined') {\n                offsetX = 0;\n            }\n            if (typeof offsetY === 'undefined') {\n                offsetY = 0;\n            }\n\n            var topLeft = {\n                x: rectangle.left + offsetX,\n                y: rectangle.top + offsetY\n            };\n\n            var topRight = {x: topLeft.x + rectangle.width, y: topLeft.y};\n            var bottomRight = {x: topRight.x, y: topRight.y + rectangle.height};\n            var bottomLeft = {x: topLeft.x, y: bottomRight.y};\n\n            return [topLeft, topRight, bottomRight, bottomLeft];\n        },\n\n        /**\n         * Set image vertice coordinates for an image that's been zoomed to fit.\n         */\n        _setFittedImageVerticeCoordinates: function() {\n            this.imageVerticeCoords = this.getImageVerticeCoords('fit');\n        },\n\n        /**\n         * Get image vertice coords by a zoom mode and taking into account the straightening angle.\n         * The zoomMode can be either \"cover\", \"fit\" or a discrete float value.\n         *\n         * @param zoomMode\n         */\n        getImageVerticeCoords: function(zoomMode) {\n            var angleInRadians = -1 * ((this.hasOrientationChanged() ? 90 : 0) + this.imageStraightenAngle) * (Math.PI / 180);\n\n            var imageDimensions = this.getScaledImageDimensions();\n\n            var ratio;\n\n            if (typeof zoomMode === \"number\") {\n                ratio = zoomMode;\n            } else if (zoomMode === \"cover\") {\n                ratio = this.getZoomToCoverRatio(imageDimensions);\n            } else {\n                ratio = this.getZoomToFitRatio(imageDimensions);\n            }\n\n            // Get the dimensions of the scaled image\n            var scaledHeight = imageDimensions.height * ratio;\n            var scaledWidth = imageDimensions.width * ratio;\n\n            // Calculate the segments of the containing box for the image.\n            // When referring to top/bottom or right/left segments, these are on the\n            // right-side and bottom projection of the containing box for the zoomed out image.\n            var topVerticalSegment = Math.cos(angleInRadians) * scaledHeight;\n            var bottomVerticalSegment = Math.sin(angleInRadians) * scaledWidth;\n            var rightHorizontalSegment = Math.cos(angleInRadians) * scaledWidth;\n            var leftHorizontalSegment = Math.sin(angleInRadians) * scaledHeight;\n\n            // Calculate the offsets from editor box for the image-containing box\n            var verticalOffset = (this.editorHeight - (topVerticalSegment + bottomVerticalSegment)) / 2;\n            var horizontalOffset = (this.editorWidth - (leftHorizontalSegment + rightHorizontalSegment)) / 2;\n\n            // Finally, calculate the image vertice coordinates\n            return {\n                a: {\n                    x: horizontalOffset + rightHorizontalSegment,\n                    y: verticalOffset\n                },\n                b: {\n                    x: this.editorWidth - horizontalOffset,\n                    y: verticalOffset + topVerticalSegment\n                },\n                c: {\n                    x: horizontalOffset + leftHorizontalSegment,\n                    y: this.editorHeight - verticalOffset\n                },\n                d: {\n                    x: horizontalOffset,\n                    y: verticalOffset + bottomVerticalSegment\n                }\n            };\n        },\n\n        /**\n         * Debug stuff by continuously rendering a fabric object on canvas.\n         *\n         * @param fabricObj\n         */\n        _debug: function(fabricObj) {\n            this.canvas.remove(this.debugger);\n            this.debugger = fabricObj;\n            this.canvas.add(this.debugger);\n        },\n\n        /**\n         * Given an array of points in the form of {x: int, y:int} and a rectangle in the form of\n         * {a:{x:int, y:int}, b:{x:int, y:int}, c:{x:int, y:int}} (the fourth vertice is unnecessary)\n         * return true if the point is in the rectangle.\n         *\n         * Adapted from: http://stackoverflow.com/a/2763387/2040791\n         *\n         * @param points\n         * @param rectangle\n         */\n        arePointsInsideRectangle: function(points, rectangle) {\n\n            // Pre-calculate the vectors and scalar products for two rectangle edges\n            var ab = this._getVector(rectangle.a, rectangle.b);\n            var bc = this._getVector(rectangle.b, rectangle.c);\n            var scalarAbAb = this._getScalarProduct(ab, ab);\n            var scalarBcBc = this._getScalarProduct(bc, bc);\n\n            for (var i = 0; i < points.length; i++) {\n                var point = points[i];\n\n                // Calculate the vectors for two rectangle sides and for\n                // the vector from vertices a and b to the point P\n                var ap = this._getVector(rectangle.a, point);\n                var bp = this._getVector(rectangle.b, point);\n\n                // Calculate scalar or dot products for some vector combinations\n                var scalarAbAp = this._getScalarProduct(ab, ap);\n                var scalarBcBp = this._getScalarProduct(bc, bp);\n\n                var projectsOnAB = 0 <= scalarAbAp && scalarAbAp <= scalarAbAb;\n                var projectsOnBC = 0 <= scalarBcBp && scalarBcBp <= scalarBcBc;\n\n                if (!(projectsOnAB && projectsOnBC)) {\n                    return false;\n                }\n            }\n\n            return true;\n        },\n\n        /**\n         * Returns an object representing the vector between points a and b.\n         *\n         * @param a\n         * @param b\n         */\n        _getVector: function(a, b) {\n            return {x: b.x - a.x, y: b.y - a.y};\n        },\n\n        /**\n         * Returns the scalar product of two vectors\n         *\n         * @param a\n         * @param b\n         */\n        _getScalarProduct: function(a, b) {\n            return a.x * b.x + a.y * b.y;\n        },\n\n        /**\n         * Returns the magnitude of a vector.\n         *\n         * @param vector\n         */\n        _getVectorMagnitude: function(vector) {\n            return Math.sqrt(vector.x * vector.x + vector.y * vector.y);\n        },\n\n        /**\n         * Returns the angle between two vectors in degrees with two decimal points\n         *\n         * @param a\n         * @param b\n         */\n        _getAngleBetweenVectors: function(a, b) {\n            return Math.round(Math.acos(Math.min(1, this._getScalarProduct(a, b) / (this._getVectorMagnitude(a) * this._getVectorMagnitude(b)))) * 180 / Math.PI * 100) / 100;\n        },\n\n        /**\n         * Return the rectangle edge crossed by an imaginary line drawn from editor center to a vertex\n         *\n         * @param rectangle\n         * @param vertex\n         *\n         * @returns {*}\n         */\n        _getEdgeCrossed: function(rectangle, vertex) {\n            // Determine over which edge the vertex is\n            var edgePoints = [\n                [rectangle.a, rectangle.b],\n                [rectangle.b, rectangle.c],\n                [rectangle.c, rectangle.d],\n                [rectangle.d, rectangle.a]\n            ];\n\n            var centerPoint = {x: this.editorWidth / 2, y: this.editorHeight / 2};\n            var smallestDiff = 180;\n            var edgeCrossed = null;\n\n            // Test each edge\n            for (var edgeIndex = 0; edgeIndex < edgePoints.length; edgeIndex++) {\n                var edge = edgePoints[edgeIndex];\n                var toCenter = this._getVector(edge[0], centerPoint);\n                var edgeVector = this._getVector(edge[0], edge[1]);\n                var toVertex = this._getVector(edge[0], vertex);\n\n                // If the angle between toCenter/toVertex is the sum of\n                // angles between edgeVector/toCenter and edgeVector/toVertex, it means that\n                // the edgeVector is between the other two meaning that this is the offending vertex.\n                // To avoid the rounding errors, we'll take the closest match\n                var diff = Math.abs(this._getAngleBetweenVectors(toCenter, toVertex) - (this._getAngleBetweenVectors(toCenter, edgeVector) + this._getAngleBetweenVectors(edgeVector, toVertex)));\n\n                if (diff < smallestDiff) {\n                    smallestDiff = diff;\n                    edgeCrossed = edge;\n                }\n            }\n\n            return edgeCrossed;\n        },\n\n        /**\n         * Get the image bounding box by image scaled dimensions, taking ingo account the straightening angle.\n         *\n         * @param dimensions\n         */\n        _getImageBoundingBox: function(dimensions) {\n\n            var box = {};\n\n            var angleInRadians = Math.abs(this.imageStraightenAngle) * (Math.PI / 180);\n\n            var proportion = dimensions.height / dimensions.width;\n            box.height = dimensions.width * (Math.sin(angleInRadians) + Math.cos(angleInRadians) * proportion);\n            box.width = dimensions.width * (Math.cos(angleInRadians) + Math.sin(angleInRadians) * proportion);\n\n            if (this.hasOrientationChanged()) {\n                var temp = box.width;\n                box.width = box.height;\n                box.height = temp;\n            }\n\n            return box;\n        }\n    },\n    {\n        defaults: {\n            animationDuration: 100,\n            allowSavingAsNew: true,\n            onSave: $.noop,\n            allowDegreeFractions: true\n        }\n    }\n);\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Asset index class\n */\nCraft.AssetIndex = Craft.BaseElementIndex.extend(\n    {\n        $includeSubfoldersContainer: null,\n        $includeSubfoldersCheckbox: null,\n        showingIncludeSubfoldersCheckbox: false,\n\n        $uploadButton: null,\n        $uploadInput: null,\n        $progressBar: null,\n        $folders: null,\n\n        uploader: null,\n        promptHandler: null,\n        progressBar: null,\n\n        _uploadTotalFiles: 0,\n        _uploadFileProgress: {},\n        _uploadedAssetIds: [],\n        _currentUploaderSettings: {},\n\n        _assetDrag: null,\n        _folderDrag: null,\n        _expandDropTargetFolderTimeout: null,\n        _tempExpandedFolders: [],\n\n        _fileConflictTemplate: {\n            choices: [\n                {value: 'keepBoth', title: Craft.t('app', 'Keep both')},\n                {value: 'replace', title: Craft.t('app', 'Replace it')}\n            ]\n        },\n        _folderConflictTemplate: {\n            choices: [\n                {value: 'replace', title: Craft.t('app', 'Replace the folder (all existing files will be deleted)')},\n                {value: 'merge', title: Craft.t('app', 'Merge the folder (any conflicting files will be replaced)')}\n            ]\n        },\n\n        init: function(elementType, $container, settings) {\n            this.base(elementType, $container, settings);\n\n            if (this.settings.context === 'index') {\n                if (!this._folderDrag) {\n                    this._initIndexPageMode();\n                }\n\n                this.addListener(Garnish.$win, 'resize,scroll', '_positionProgressBar');\n            } else {\n                this.addListener(this.$main, 'scroll', '_positionProgressBar');\n\n                if (this.settings.modal) {\n                    this.settings.modal.on('updateSizeAndPosition', $.proxy(this, '_positionProgressBar'));\n                }\n            }\n        },\n\n        initSources: function() {\n            if (this.settings.context === 'index' && !this._folderDrag) {\n                this._initIndexPageMode();\n            }\n\n            return this.base();\n        },\n\n        initSource: function($source) {\n            this.base($source);\n\n            this._createFolderContextMenu($source);\n\n            if (this.settings.context === 'index') {\n                if (this._folderDrag && this._getSourceLevel($source) > 1) {\n                    if ($source.data('folder-id')) {\n                        this._folderDrag.addItems($source.parent());\n                    }\n                }\n\n                if (this._assetDrag) {\n                    this._assetDrag.updateDropTargets();\n                }\n            }\n        },\n\n        deinitSource: function($source) {\n            this.base($source);\n\n            // Does this source have a context menu?\n            var contextMenu = $source.data('contextmenu');\n\n            if (contextMenu) {\n                contextMenu.destroy();\n            }\n\n            if (this.settings.context === 'index') {\n                if (this._folderDrag && this._getSourceLevel($source) > 1) {\n                    this._folderDrag.removeItems($source.parent());\n                }\n\n                if (this._assetDrag) {\n                    this._assetDrag.updateDropTargets();\n                }\n            }\n        },\n\n        _getSourceLevel: function($source) {\n            return $source.parentsUntil('nav', 'ul').length;\n        },\n\n        /**\n         * Initialize the index page-specific features\n         */\n        _initIndexPageMode: function() {\n            if (this._folderDrag) {\n                return;\n            }\n\n            // Make the elements selectable\n            this.settings.selectable = true;\n            this.settings.multiSelect = true;\n\n            var onDragStartProxy = $.proxy(this, '_onDragStart'),\n                onDropTargetChangeProxy = $.proxy(this, '_onDropTargetChange');\n\n            // Asset dragging\n            // ---------------------------------------------------------------------\n\n            this._assetDrag = new Garnish.DragDrop({\n                activeDropTargetClass: 'sel',\n                helperOpacity: 0.75,\n\n                filter: $.proxy(function() {\n                    return this.view.getSelectedElements();\n                }, this),\n\n                helper: $.proxy(function($file) {\n                    return this._getFileDragHelper($file);\n                }, this),\n\n                dropTargets: $.proxy(function() {\n                    var targets = [];\n\n                    for (var i = 0; i < this.$sources.length; i++) {\n                        // Make sure it's a volume folder\n                        var $source = this.$sources.eq(i);\n                        if (!this._getFolderUidFromSourceKey($source.data('key'))) {\n                            continue;\n                        }\n                        targets.push($source);\n                    }\n\n                    return targets;\n                }, this),\n\n                onDragStart: onDragStartProxy,\n                onDropTargetChange: onDropTargetChangeProxy,\n                onDragStop: $.proxy(this, '_onFileDragStop')\n            });\n\n            // Folder dragging\n            // ---------------------------------------------------------------------\n\n            this._folderDrag = new Garnish.DragDrop(\n                {\n                    activeDropTargetClass: 'sel',\n                    helperOpacity: 0.75,\n\n                    filter: $.proxy(function() {\n                        // Return each of the selected <a>'s parent <li>s, except for top level drag attempts.\n                        var $selected = this.sourceSelect.getSelectedItems(),\n                            draggees = [];\n\n                        for (var i = 0; i < $selected.length; i++) {\n                            var $source = $selected.eq(i);\n\n                            if (!this._getFolderUidFromSourceKey($source.data('key'))) {\n                                continue;\n                            }\n\n                            if ($source.hasClass('sel') && this._getSourceLevel($source) > 1) {\n                                draggees.push($source.parent()[0]);\n                            }\n                        }\n\n                        return $(draggees);\n                    }, this),\n\n                    helper: $.proxy(function($draggeeHelper) {\n                        var $helperSidebar = $('<div class=\"sidebar\" style=\"padding-top: 0; padding-bottom: 0;\"/>'),\n                            $helperNav = $('<nav/>').appendTo($helperSidebar),\n                            $helperUl = $('<ul/>').appendTo($helperNav);\n\n                        $draggeeHelper.appendTo($helperUl).removeClass('expanded');\n                        $draggeeHelper.children('a').addClass('sel');\n\n                        // Match the style\n                        $draggeeHelper.css({\n                            'padding-top': this._folderDrag.$draggee.css('padding-top'),\n                            'padding-right': this._folderDrag.$draggee.css('padding-right'),\n                            'padding-bottom': this._folderDrag.$draggee.css('padding-bottom'),\n                            'padding-left': this._folderDrag.$draggee.css('padding-left')\n                        });\n\n                        return $helperSidebar;\n                    }, this),\n\n                    dropTargets: $.proxy(function() {\n                        var targets = [];\n\n                        // Tag the dragged folder and it's subfolders\n                        var draggedSourceIds = [];\n                        this._folderDrag.$draggee.find('a[data-key]').each(function() {\n                            draggedSourceIds.push($(this).data('key'));\n                        });\n\n                        for (var i = 0; i < this.$sources.length; i++) {\n                            // Make sure it's a volume folder and not one of the dragged folders\n                            var $source = this.$sources.eq(i),\n                                key = $source.data('key');\n\n                            if (!this._getFolderUidFromSourceKey(key)) {\n                                continue;\n                            }\n\n                            if (!Craft.inArray(key, draggedSourceIds)) {\n                                targets.push($source);\n                            }\n                        }\n\n                        return targets;\n                    }, this),\n\n                    onDragStart: onDragStartProxy,\n                    onDropTargetChange: onDropTargetChangeProxy,\n                    onDragStop: $.proxy(this, '_onFolderDragStop')\n                });\n        },\n\n        /**\n         * On file drag stop\n         */\n        _onFileDragStop: function() {\n            if (this._assetDrag.$activeDropTarget && this._assetDrag.$activeDropTarget[0] !== this.$source[0]) {\n                // Keep it selected\n                var originatingSource = this.$source;\n\n                var targetFolderId = this._assetDrag.$activeDropTarget.data('folder-id'),\n                    originalAssetIds = [];\n\n                // For each file, prepare array data.\n                for (var i = 0; i < this._assetDrag.$draggee.length; i++) {\n                    var originalAssetId = Craft.getElementInfo(this._assetDrag.$draggee[i]).id;\n\n                    originalAssetIds.push(originalAssetId);\n                }\n\n                // Are any files actually getting moved?\n                if (originalAssetIds.length) {\n                    this.setIndexBusy();\n\n                    this._positionProgressBar();\n                    this.progressBar.resetProgressBar();\n                    this.progressBar.setItemCount(originalAssetIds.length);\n                    this.progressBar.showProgressBar();\n\n\n                    // For each file to move a separate request\n                    var parameterArray = [];\n                    for (i = 0; i < originalAssetIds.length; i++) {\n                        parameterArray.push({\n                            action: 'assets/move-asset',\n                            params: {\n                                assetId: originalAssetIds[i],\n                                folderId: targetFolderId\n                            }\n                        });\n                    }\n\n                    // Define the callback for when all file moves are complete\n                    var onMoveFinish = $.proxy(function(responseArray) {\n                        this.promptHandler.resetPrompts();\n\n                        // Loop trough all the responses\n                        for (var i = 0; i < responseArray.length; i++) {\n                            var response = responseArray[i];\n\n                            // Push prompt into prompt array\n                            if (response.conflict) {\n                                this.promptHandler.addPrompt({\n                                    assetId: response.assetId,\n                                    suggestedFilename: response.suggestedFilename,\n                                    prompt: {message: response.conflict, choices: this._fileConflictTemplate.choices}\n                                });\n                            }\n\n                            if (response.error) {\n                                alert(response.error);\n                            }\n                        }\n\n                        this.setIndexAvailable();\n                        this.progressBar.hideProgressBar();\n                        var reloadIndex = false;\n\n                        var performAfterMoveActions = function() {\n                            // Select original source\n                            this.sourceSelect.selectItem(originatingSource);\n\n                            // Make sure we use the correct offset when fetching the next page\n                            this._totalVisible -= this._assetDrag.$draggee.length;\n\n                            // And remove the elements that have been moved away\n                            for (var i = 0; i < originalAssetIds.length; i++) {\n                                $('[data-id=' + originalAssetIds[i] + ']').remove();\n                            }\n\n                            this.view.deselectAllElements();\n                            this._collapseExtraExpandedFolders(targetFolderId);\n\n                            if (reloadIndex) {\n                                this.updateElements();\n                            }\n                        };\n\n                        if (this.promptHandler.getPromptCount()) {\n                            // Define callback for completing all prompts\n                            var promptCallback = $.proxy(function(returnData) {\n                                var newParameterArray = [];\n\n                                // Loop trough all returned data and prepare a new request array\n                                for (var i = 0; i < returnData.length; i++) {\n                                    if (returnData[i].choice === 'cancel') {\n                                        reloadIndex = true;\n                                        continue;\n                                    }\n\n                                    if (returnData[i].choice === 'keepBoth') {\n                                        newParameterArray.push({\n                                            action: 'assets/move-asset',\n                                            params: {\n                                                folderId: targetFolderId,\n                                                assetId: returnData[i].assetId,\n                                                filename: returnData[i].suggestedFilename\n                                            }\n                                        });\n                                    }\n\n                                    if (returnData[i].choice === 'replace') {\n                                        newParameterArray.push({\n                                            action: 'assets/move-asset',\n                                            params: {\n                                                folderId: targetFolderId,\n                                                assetId: returnData[i].assetId,\n                                                force: true\n                                            }\n                                        });\n                                    }\n                                }\n\n                                // Nothing to do, carry on\n                                if (newParameterArray.length === 0) {\n                                    performAfterMoveActions.apply(this);\n                                }\n                                else {\n                                    // Start working\n                                    this.setIndexBusy();\n                                    this.progressBar.resetProgressBar();\n                                    this.progressBar.setItemCount(this.promptHandler.getPromptCount());\n                                    this.progressBar.showProgressBar();\n\n                                    // Move conflicting files again with resolutions now\n                                    this._performBatchRequests(newParameterArray, onMoveFinish);\n                                }\n                            }, this);\n\n                            this._assetDrag.fadeOutHelpers();\n                            this.promptHandler.showBatchPrompts(promptCallback);\n                        }\n                        else {\n                            performAfterMoveActions.apply(this);\n                            this._assetDrag.fadeOutHelpers();\n                        }\n                    }, this);\n\n                    // Initiate the file move with the built array, index of 0 and callback to use when done\n                    this._performBatchRequests(parameterArray, onMoveFinish);\n\n                    // Skip returning dragees\n                    return;\n                }\n            }\n            else {\n                // Add the .sel class back on the selected source\n                this.$source.addClass('sel');\n\n                this._collapseExtraExpandedFolders();\n            }\n\n            this._assetDrag.returnHelpersToDraggees();\n        },\n\n        /**\n         * On folder drag stop\n         */\n        _onFolderDragStop: function() {\n            // Only move if we have a valid target and we're not trying to move into our direct parent\n            if (\n                this._folderDrag.$activeDropTarget &&\n                this._folderDrag.$activeDropTarget.siblings('ul').children('li').filter(this._folderDrag.$draggee).length === 0\n            ) {\n                var targetFolderId = this._folderDrag.$activeDropTarget.data('folder-id');\n\n                this._collapseExtraExpandedFolders(targetFolderId);\n\n                // Get the old folder IDs, and sort them so that we're moving the most-nested folders first\n                var folderIds = [];\n\n                for (var i = 0; i < this._folderDrag.$draggee.length; i++) {\n                    var $a = this._folderDrag.$draggee.eq(i).children('a'),\n                        folderId = $a.data('folder-id');\n\n                    // Make sure it's not already in the target folder and use this single folder Id.\n                    if (folderId != targetFolderId) {\n                        folderIds.push(folderId);\n                        break;\n                    }\n                }\n\n                if (folderIds.length) {\n                    folderIds.sort();\n                    folderIds.reverse();\n\n                    this.setIndexBusy();\n                    this._positionProgressBar();\n                    this.progressBar.resetProgressBar();\n                    this.progressBar.setItemCount(folderIds.length);\n                    this.progressBar.showProgressBar();\n\n                    var parameterArray = [];\n\n                    for (i = 0; i < folderIds.length; i++) {\n                        parameterArray.push({\n                            action: 'assets/move-folder',\n                            params: {\n                                folderId: folderIds[i],\n                                parentId: targetFolderId\n                            }\n                        });\n                    }\n\n                    // Increment, so to avoid displaying folder files that are being moved\n                    this.requestId++;\n\n                    /*\n                     Here's the rundown:\n                     1) Send all the folders being moved\n                     2) Get results:\n                     a) For all conflicting, receive prompts and resolve them to get:\n                     b) For all valid move operations: by now server has created the needed folders\n                     in target destination. Server returns an array of file move operations\n                     c) server also returns a list of all the folder id changes\n                     d) and the data-id of node to be removed, in case of conflict\n                     e) and a list of folders to delete after the move\n                     3) From data in 2) build a large file move operation array\n                     4) Create a request loop based on this, so we can display progress bar\n                     5) when done, delete all the folders and perform other maintenance\n                     6) Champagne\n                     */\n\n                    // This will hold the final list of files to move\n                    var fileMoveList = [];\n\n                    var newSourceKey = '';\n\n                    var onMoveFinish = function(responseArray) {\n                        this.promptHandler.resetPrompts();\n\n                        // Loop trough all the responses\n                        for (var i = 0; i < responseArray.length; i++) {\n                            var data = responseArray[i];\n\n                            // If successful and have data, then update\n                            if (data.success) {\n                                if (data.transferList) {\n                                    fileMoveList = data.transferList;\n                                }\n\n                                if (data.newFolderId) {\n                                    newSourceKey = this._folderDrag.$activeDropTarget.data('key') + '/folder:' + data.newFolderUid;\n                                }\n                            }\n\n                            // Push prompt into prompt array\n                            if (data.conflict) {\n                                data.prompt = {\n                                    message: data.conflict,\n                                    choices: this._folderConflictTemplate.choices\n                                };\n\n                                this.promptHandler.addPrompt(data);\n                            }\n\n                            if (data.error) {\n                                alert(data.error);\n                            }\n                        }\n\n                        if (this.promptHandler.getPromptCount()) {\n                            // Define callback for completing all prompts\n                            var promptCallback = $.proxy(function(returnData) {\n                                this.promptHandler.resetPrompts();\n\n                                var newParameterArray = [];\n\n                                var params = {};\n                                // Loop trough all returned data and prepare a new request array\n                                for (var i = 0; i < returnData.length; i++) {\n                                    if (returnData[i].choice === 'cancel') {\n                                        continue;\n                                    }\n\n                                    if (returnData[i].choice === 'replace') {\n                                        params.force = true;\n                                    }\n\n                                    if (returnData[i].choice === 'merge') {\n                                        params.merge = true;\n                                    }\n\n                                    params.folderId = data.folderId;\n                                    params.parentId = data.parentId;\n\n                                    newParameterArray.push({\n                                        action: 'assets/move-folder',\n                                        params: params\n                                    });\n                                }\n\n                                // Start working on them lists, baby\n                                if (newParameterArray.length === 0) {\n                                    $.proxy(this, '_performActualFolderMove', fileMoveList, folderIds, newSourceKey)();\n                                }\n                                else {\n                                    // Start working\n                                    this.setIndexBusy();\n                                    this.progressBar.resetProgressBar();\n                                    this.progressBar.setItemCount(this.promptHandler.getPromptCount());\n                                    this.progressBar.showProgressBar();\n\n                                    this._performBatchRequests(newParameterArray, onMoveFinish);\n                                }\n                            }, this);\n\n                            this.promptHandler.showBatchPrompts(promptCallback);\n\n                            this.setIndexAvailable();\n                            this.progressBar.hideProgressBar();\n                        }\n                        else {\n                            $.proxy(this, '_performActualFolderMove', fileMoveList, folderIds, newSourceKey)();\n                        }\n                    }.bind(this);\n\n                    // Initiate the folder move with the built array, index of 0 and callback to use when done\n                    this._performBatchRequests(parameterArray, onMoveFinish);\n\n                    // Skip returning dragees until we get the Ajax response\n                    return;\n                }\n            }\n            else {\n                // Add the .sel class back on the selected source\n                this.$source.addClass('sel');\n\n                this._collapseExtraExpandedFolders();\n            }\n\n            this._folderDrag.returnHelpersToDraggees();\n        },\n\n        /**\n         * Really move the folder. Like really. For real.\n         */\n        _performActualFolderMove: function(fileMoveList, folderDeleteList, newSourceKey) {\n            this.setIndexBusy();\n            this.progressBar.resetProgressBar();\n            this.progressBar.setItemCount(1);\n            this.progressBar.showProgressBar();\n\n            var moveCallback = function(folderDeleteList) {\n                // Delete the old folders\n                var counter = 0;\n                var limit = folderDeleteList.length;\n                for (var i = 0; i < folderDeleteList.length; i++) {\n                    // When all folders are deleted, reload the sources.\n                    Craft.postActionRequest('assets/delete-folder', {folderId: folderDeleteList[i]}, function() {\n                        if (++counter === limit) {\n                            this.setIndexAvailable();\n                            this.progressBar.hideProgressBar();\n                            this._folderDrag.returnHelpersToDraggees();\n                            this.setInstanceState('selectedSource', newSourceKey);\n                            this.refreshSources();\n                        }\n                    }.bind(this));\n                }\n            }.bind(this);\n\n\n            if (fileMoveList.length > 0) {\n                var parameterArray =[];\n\n                for (var i = 0; i < fileMoveList.length; i++) {\n                    parameterArray.push({\n                        action: 'assets/move-asset',\n                        params: fileMoveList[i]\n                    });\n\n                }\n                this._performBatchRequests(parameterArray, function() {\n                    moveCallback(folderDeleteList);\n                });\n            }\n            else {\n                moveCallback(folderDeleteList);\n            }\n        },\n\n        /**\n         * Get parent source for a source.\n         *\n         * @param $source\n         * @returns {*}\n         * @private\n         */\n        _getParentSource: function($source) {\n            if (this._getSourceLevel($source) > 1) {\n                return $source.parent().parent().siblings('a');\n            }\n        },\n\n        _selectSourceByFolderId: function(targetFolderId) {\n            var $targetSource = this._getSourceByKey(targetFolderId);\n\n            // Make sure that all the parent sources are expanded and this source is visible.\n            var $parentSources = $targetSource.parent().parents('li');\n\n            for (var i = 0; i < $parentSources.length; i++) {\n                var $parentSource = $($parentSources[i]);\n\n                if (!$parentSource.hasClass('expanded')) {\n                    $parentSource.children('.toggle').trigger('click');\n                }\n            }\n\n            this.selectSource($targetSource);\n            this.updateElements();\n        },\n\n        /**\n         * Initialize the uploader.\n         *\n         * @private\n         */\n        afterInit: function() {\n            if (!this.$uploadButton) {\n                this.$uploadButton = $('<div class=\"btn submit\" data-icon=\"upload\" style=\"position: relative; overflow: hidden;\" role=\"button\">' + Craft.t('app', 'Upload files') + '</div>');\n                this.addButton(this.$uploadButton);\n\n                this.$uploadInput = $('<input type=\"file\" multiple=\"multiple\" name=\"assets-upload\" />').hide().insertBefore(this.$uploadButton);\n            }\n\n            this.promptHandler = new Craft.PromptHandler();\n            this.progressBar = new Craft.ProgressBar(this.$main, true);\n\n            var options = {\n                url: Craft.getActionUrl('assets/save-asset'),\n                fileInput: this.$uploadInput,\n                dropZone: this.$container\n            };\n\n            options.events = {\n                fileuploadstart: $.proxy(this, '_onUploadStart'),\n                fileuploadprogressall: $.proxy(this, '_onUploadProgress'),\n                fileuploaddone: $.proxy(this, '_onUploadComplete')\n            };\n\n            if (this.settings.criteria && typeof this.settings.criteria.kind !== 'undefined') {\n                options.allowedKinds = this.settings.criteria.kind;\n            }\n\n            this._currentUploaderSettings = options;\n\n            this.uploader = new Craft.Uploader(this.$uploadButton, options);\n\n            this.$uploadButton.on('click', $.proxy(function() {\n                if (this.$uploadButton.hasClass('disabled')) {\n                    return;\n                }\n                if (!this.isIndexBusy) {\n                    this.$uploadButton.parent().find('input[name=assets-upload]').trigger('click');\n                }\n            }, this));\n\n            this.base();\n        },\n\n        onSelectSource: function() {\n            var $source = this._getSourceByKey(this.sourceKey);\n            var folderId = $source.data('folder-id');\n\n            if (folderId && this.$source.attr('data-upload')) {\n                this.uploader.setParams({\n                    folderId: this.$source.attr('data-folder-id')\n                });\n                this.$uploadButton.removeClass('disabled');\n            } else {\n                this.$uploadButton.addClass('disabled');\n            }\n\n            this.base();\n        },\n\n        _getFolderUidFromSourceKey: function(sourceKey) {\n            var m = sourceKey.match(/\\bfolder:([0-9a-f\\-]+)$/);\n\n            return m ? m[1] : null;\n        },\n\n        startSearching: function() {\n            // Does this source have subfolders?\n            if (this.$source.siblings('ul').length) {\n                if (this.$includeSubfoldersContainer === null) {\n                    var id = 'includeSubfolders-' + Math.floor(Math.random() * 1000000000);\n\n                    this.$includeSubfoldersContainer = $('<div style=\"margin-bottom: -23px; opacity: 0;\"/>').insertAfter(this.$search);\n                    var $subContainer = $('<div style=\"padding-top: 5px;\"/>').appendTo(this.$includeSubfoldersContainer);\n                    this.$includeSubfoldersCheckbox = $('<input type=\"checkbox\" id=\"' + id + '\" class=\"checkbox\"/>').appendTo($subContainer);\n                    $('<label class=\"light smalltext\" for=\"' + id + '\"/>').text(' ' + Craft.t('app', 'Search in subfolders')).appendTo($subContainer);\n\n                    this.addListener(this.$includeSubfoldersCheckbox, 'change', function() {\n                        this.setSelecetedSourceState('includeSubfolders', this.$includeSubfoldersCheckbox.prop('checked'));\n                        this.updateElements();\n                    });\n                }\n                else {\n                    this.$includeSubfoldersContainer.velocity('stop');\n                }\n\n                var checked = this.getSelectedSourceState('includeSubfolders', false);\n                this.$includeSubfoldersCheckbox.prop('checked', checked);\n\n                this.$includeSubfoldersContainer.velocity({\n                    marginBottom: 0,\n                    opacity: 1\n                }, 'fast');\n\n                this.showingIncludeSubfoldersCheckbox = true;\n            }\n\n            this.base();\n        },\n\n        stopSearching: function() {\n            if (this.showingIncludeSubfoldersCheckbox) {\n                this.$includeSubfoldersContainer.velocity('stop');\n\n                this.$includeSubfoldersContainer.velocity({\n                    marginBottom: -23,\n                    opacity: 0\n                }, 'fast');\n\n                this.showingIncludeSubfoldersCheckbox = false;\n            }\n\n            this.base();\n        },\n\n        getViewParams: function() {\n            var data = this.base();\n\n            if (this.showingIncludeSubfoldersCheckbox && this.$includeSubfoldersCheckbox.prop('checked')) {\n                data.criteria.includeSubfolders = true;\n            }\n\n            return data;\n        },\n\n        /**\n         * React on upload submit.\n         *\n         * @private\n         */\n        _onUploadStart: function() {\n            this.setIndexBusy();\n\n            // Initial values\n            this._positionProgressBar();\n            this.progressBar.resetProgressBar();\n            this.progressBar.showProgressBar();\n\n            this.promptHandler.resetPrompts();\n        },\n\n        /**\n         * Update uploaded byte count.\n         */\n        _onUploadProgress: function(event, data) {\n            var progress = parseInt(data.loaded / data.total * 100, 10);\n            this.progressBar.setProgressPercentage(progress);\n        },\n\n        /**\n         * On Upload Complete.\n         */\n        _onUploadComplete: function(event, data) {\n            var response = data.result;\n            var filename = data.files[0].name;\n\n            var doReload = true;\n\n            if (response.success || response.conflict) {\n                // Add the uploaded file to the selected ones, if appropriate\n                this._uploadedAssetIds.push(response.assetId);\n\n                // If there is a prompt, add it to the queue\n                if (response.conflict) {\n                    response.prompt =  {\n                        message: Craft.t('app', response.conflict, {file: response.filename}),\n                        choices: this._fileConflictTemplate.choices\n                    };\n\n                    this.promptHandler.addPrompt(response);\n                }\n\n                Craft.cp.runQueue();\n            }\n            else {\n                if (response.error) {\n                    alert(Craft.t('app', 'Upload failed. The error message was: \u201c{error}\u201d', {error: response.error}));\n                }\n                else {\n                    alert(Craft.t('app', 'Upload failed for {filename}.', {filename: filename}));\n                }\n\n                doReload = false;\n            }\n\n            // For the last file, display prompts, if any. If not - just update the element view.\n            if (this.uploader.isLastUpload()) {\n                this.setIndexAvailable();\n                this.progressBar.hideProgressBar();\n\n                if (this.promptHandler.getPromptCount()) {\n                    this.promptHandler.showBatchPrompts($.proxy(this, '_uploadFollowup'));\n                }\n                else {\n                    if (doReload) {\n                        this._updateAfterUpload();\n                    }\n                }\n            }\n        },\n\n        /**\n         * Update the elements after an upload, setting sort to dateModified descending, if not using index.\n         * \n         * @private\n         */\n        _updateAfterUpload: function () {\n            if (this.settings.context !== 'index') {\n                this.setSortAttribute('dateModified');\n                this.setSortDirection('desc');\n            }\n            this.updateElements();\n        },\n\n        /**\n         * Follow up to an upload that triggered at least one conflict resolution prompt.\n         *\n         * @param returnData\n         * @private\n         */\n        _uploadFollowup: function(returnData) {\n            this.setIndexBusy();\n            this.progressBar.resetProgressBar();\n\n            this.promptHandler.resetPrompts();\n\n            var finalCallback = function() {\n                this.setIndexAvailable();\n                this.progressBar.hideProgressBar();\n                this._updateAfterUpload();\n            }.bind(this);\n\n            this.progressBar.setItemCount(returnData.length);\n\n            var doFollowup = function(parameterArray, parameterIndex, callback) {\n                var postData = {};\n                var action = null;\n\n                var followupCallback = function (data, textStatus) {\n                    if (textStatus === 'success' && data.assetId) {\n                        this._uploadedAssetIds.push(data.assetId);\n                    } else if (data.error) {\n                        alert(data.error);\n                    }\n                    parameterIndex++;\n                    this.progressBar.incrementProcessedItemCount(1);\n                    this.progressBar.updateProgressBar();\n\n                    if (parameterIndex === parameterArray.length) {\n                        callback();\n                    }\n                    else {\n                        doFollowup(parameterArray, parameterIndex, callback);\n                    }\n\n                }.bind(this);\n\n                if (parameterArray[parameterIndex].choice === 'replace') {\n                    action = 'assets/replace-file';\n                    postData.sourceAssetId = parameterArray[parameterIndex].assetId;\n\n                    if (parameterArray[parameterIndex].conflictingAssetId) {\n                        postData.assetId = parameterArray[parameterIndex].conflictingAssetId;\n                    } else {\n                        postData.targetFilename = parameterArray[parameterIndex].filename;\n                    }\n                } else if (parameterArray[parameterIndex].choice === 'cancel') {\n                    action = 'assets/delete-asset';\n                    postData.assetId = parameterArray[parameterIndex].assetId;\n                }\n\n                if (!action) {\n                    // We don't really need to do another request, so let's pretend that already happened\n                    followupCallback({assetId: parameterArray[parameterIndex].assetId}, 'success');\n                } else {\n                    Craft.postActionRequest(action, postData, followupCallback);\n                }\n            }.bind(this);\n\n            this.progressBar.showProgressBar();\n            doFollowup(returnData, 0, finalCallback);\n        },\n\n        /**\n         * Perform actions after updating elements\n         * @private\n         */\n        onUpdateElements: function() {\n            this._onUpdateElements(false, this.view.getAllElements());\n            this.view.on('appendElements', $.proxy(function(ev) {\n                this._onUpdateElements(true, ev.newElements);\n            }, this));\n\n            this.base();\n        },\n\n        /**\n         * Do the after-update initializations\n         * @private\n         */\n        _onUpdateElements: function(append, $newElements) {\n            if (this.settings.context === 'index') {\n                if (!append) {\n                    this._assetDrag.removeAllItems();\n                }\n\n                this._assetDrag.addItems($newElements);\n            }\n\n            // See if we have freshly uploaded files to add to selection\n            if (this._uploadedAssetIds.length) {\n                if (this.view.settings.selectable) {\n                    for (var i = 0; i < this._uploadedAssetIds.length; i++) {\n                        this.view.selectElementById(this._uploadedAssetIds[i]);\n                    }\n                }\n\n                // Reset the list.\n                this._uploadedAssetIds = [];\n            }\n\n            this.base(append, $newElements);\n\n            this.removeListener(this.$elements, 'keydown');\n            this.addListener(this.$elements, 'keydown', this._onKeyDown.bind(this));\n            this.view.elementSelect.on('focusItem', this._onElementFocus.bind(this));\n        },\n\n        /**\n         * Handle a keypress\n         * @private\n         */\n        _onKeyDown: function(ev) {\n            if (ev.keyCode === Garnish.SPACE_KEY && ev.shiftKey) {\n                if (Craft.PreviewFileModal.openInstance) {\n                    Craft.PreviewFileModal.openInstance.selfDestruct();\n                } else {\n                    var $element = this.view.elementSelect.$focusedItem.find('.element');\n\n                    if ($element.length) {\n                        this._loadPreview($element);\n                    }\n                }\n\n                ev.stopPropagation();\n                return false;\n            }\n        },\n\n        /**\n         * Handle element being focused\n         * @private\n         */\n        _onElementFocus: function (ev) {\n            var $element = $(ev.item).find('.element');\n\n            if (Craft.PreviewFileModal.openInstance && $element.length) {\n                this._loadPreview($element);\n            }\n        },\n\n        /**\n         * Load the preview for an Asset element\n         * @private\n         */\n        _loadPreview: function($element) {\n            var settings = {};\n\n            if ($element.data('image-width')) {\n                settings.startingWidth = $element.data('image-width');\n                settings.startingHeight = $element.data('image-height');\n            }\n\n            new Craft.PreviewFileModal($element.data('id'), this.view.elementSelect, settings);\n        },\n\n        /**\n         * On Drag Start\n         */\n        _onDragStart: function() {\n            this._tempExpandedFolders = [];\n        },\n\n        /**\n         * Get File Drag Helper\n         */\n        _getFileDragHelper: function($element) {\n            var currentView = this.getSelectedSourceState('mode');\n            var $outerContainer;\n            var $innerContainer;\n\n            switch (currentView) {\n                case 'table': {\n                    $outerContainer = $('<div class=\"elements datatablesorthelper\"/>').appendTo(Garnish.$bod);\n                    $innerContainer = $('<div class=\"tableview\"/>').appendTo($outerContainer);\n                    var $table = $('<table class=\"data\"/>').appendTo($innerContainer);\n                    var $tbody = $('<tbody/>').appendTo($table);\n\n                    $element.appendTo($tbody);\n\n                    // Copy the column widths\n                    this._$firstRowCells = this.view.$table.children('tbody').children('tr:first').children();\n                    var $helperCells = $element.children();\n\n                    for (var i = 0; i < $helperCells.length; i++) {\n                        // Hard-set the cell widths\n                        var $helperCell = $($helperCells[i]);\n\n                        // Skip the checkbox cell\n                        if ($helperCell.hasClass('checkbox-cell')) {\n                            $helperCell.remove();\n                            $outerContainer.css('margin-' + Craft.left, 19); // 26 - 7\n                            continue;\n                        }\n\n                        var $firstRowCell = $(this._$firstRowCells[i]),\n                            width = $firstRowCell.width();\n\n                        $firstRowCell.width(width);\n                        $helperCell.width(width);\n                    }\n\n                    return $outerContainer;\n                }\n                case 'thumbs': {\n                    $outerContainer = $('<div class=\"elements thumbviewhelper\"/>').appendTo(Garnish.$bod);\n                    $innerContainer = $('<ul class=\"thumbsview\"/>').appendTo($outerContainer);\n\n                    $element.appendTo($innerContainer);\n\n                    return $outerContainer;\n                }\n            }\n\n            return $();\n        },\n\n        /**\n         * On Drop Target Change\n         */\n        _onDropTargetChange: function($dropTarget) {\n            clearTimeout(this._expandDropTargetFolderTimeout);\n\n            if ($dropTarget) {\n                var folderId = $dropTarget.data('folder-id');\n\n                if (folderId) {\n                    this.dropTargetFolder = this._getSourceByKey(folderId);\n\n                    if (this._hasSubfolders(this.dropTargetFolder) && !this._isExpanded(this.dropTargetFolder)) {\n                        this._expandDropTargetFolderTimeout = setTimeout($.proxy(this, '_expandFolder'), 500);\n                    }\n                }\n                else {\n                    this.dropTargetFolder = null;\n                }\n            }\n\n            if ($dropTarget && $dropTarget[0] !== this.$source[0]) {\n                // Temporarily remove the .sel class on the active source\n                this.$source.removeClass('sel');\n            }\n            else {\n                this.$source.addClass('sel');\n            }\n        },\n\n        /**\n         * Collapse Extra Expanded Folders\n         */\n        _collapseExtraExpandedFolders: function(dropTargetFolderId) {\n            clearTimeout(this._expandDropTargetFolderTimeout);\n\n            // If a source ID is passed in, exclude its parents\n            var $excludedSources;\n\n            if (dropTargetFolderId) {\n                $excludedSources = this._getSourceByKey(dropTargetFolderId).parents('li').children('a');\n            }\n\n            for (var i = this._tempExpandedFolders.length - 1; i >= 0; i--) {\n                var $source = this._tempExpandedFolders[i];\n\n                // Check the parent list, if a source id is passed in\n                if (typeof $excludedSources === 'undefined' || $excludedSources.filter('[data-key=\"' + $source.data('key') + '\"]').length === 0) {\n                    this._collapseFolder($source);\n                    this._tempExpandedFolders.splice(i, 1);\n                }\n            }\n        },\n\n        _getSourceByKey: function(key) {\n            return this.$sources.filter('[data-key$=\"' + key + '\"]');\n        },\n\n        _hasSubfolders: function($source) {\n            return $source.siblings('ul').find('li').length;\n        },\n\n        _isExpanded: function($source) {\n            return $source.parent('li').hasClass('expanded');\n        },\n\n        _expandFolder: function() {\n            // Collapse any temp-expanded drop targets that aren't parents of this one\n            this._collapseExtraExpandedFolders(this.dropTargetFolder.data('folder-id'));\n\n            this.dropTargetFolder.siblings('.toggle').trigger('click');\n\n            // Keep a record of that\n            this._tempExpandedFolders.push(this.dropTargetFolder);\n        },\n\n        _collapseFolder: function($source) {\n            if ($source.parent().hasClass('expanded')) {\n                $source.siblings('.toggle').trigger('click');\n            }\n        },\n\n        _createFolderContextMenu: function($source) {\n            // Make sure it's a volume folder\n            if (!this._getFolderUidFromSourceKey($source.data('key'))) {\n                return;\n            }\n\n            var menuOptions = [{label: Craft.t('app', 'New subfolder'), onClick: $.proxy(this, '_createSubfolder', $source)}];\n\n            // For all folders that are not top folders\n            if (this.settings.context === 'index' && this._getSourceLevel($source) > 1) {\n                menuOptions.push({label: Craft.t('app', 'Rename folder'), onClick: $.proxy(this, '_renameFolder', $source)});\n                menuOptions.push({label: Craft.t('app', 'Delete folder'), onClick: $.proxy(this, '_deleteFolder', $source)});\n            }\n\n            new Garnish.ContextMenu($source, menuOptions, {menuClass: 'menu'});\n        },\n\n        _createSubfolder: function($parentFolder) {\n            var subfolderName = prompt(Craft.t('app', 'Enter the name of the folder'));\n\n            if (subfolderName) {\n                var params = {\n                    parentId: $parentFolder.data('folder-id'),\n                    folderName: subfolderName\n                };\n\n                this.setIndexBusy();\n\n                Craft.postActionRequest('assets/create-folder', params, $.proxy(function(data, textStatus) {\n                    this.setIndexAvailable();\n\n                    if (textStatus === 'success' && data.success) {\n                        this._prepareParentForChildren($parentFolder);\n\n                        var $subfolder = $(\n                            '<li>' +\n                            '<a data-key=\"' + $parentFolder.data('key') + '/folder:' + data.folderUid + '\"' +\n                            (Garnish.hasAttr($parentFolder, 'data-has-thumbs') ? ' data-has-thumbs' : '') +\n                            ' data-upload=\"' + $parentFolder.attr('data-upload') + '\"' +\n                            ' data-folder-id=\"' + data.folderId + '\"' +\n                            '>' +\n                            data.folderName +\n                            '</a>' +\n                            '</li>'\n                        );\n\n                        var $a = $subfolder.children('a:first');\n                        this._appendSubfolder($parentFolder, $subfolder);\n                        this.initSource($a);\n                    }\n\n                    if (textStatus === 'success' && data.error) {\n                        alert(data.error);\n                    }\n                }, this));\n            }\n        },\n\n        _deleteFolder: function($targetFolder) {\n            if (confirm(Craft.t('app', 'Really delete folder \u201c{folder}\u201d?', {folder: $.trim($targetFolder.text())}))) {\n                var params = {\n                    folderId: $targetFolder.data('folder-id')\n                };\n\n                this.setIndexBusy();\n\n                Craft.postActionRequest('assets/delete-folder', params, $.proxy(function(data, textStatus) {\n                    this.setIndexAvailable();\n\n                    if (textStatus === 'success' && data.success) {\n                        var $parentFolder = this._getParentSource($targetFolder);\n\n                        // Remove folder and any trace from its parent, if needed\n                        this.deinitSource($targetFolder);\n\n                        $targetFolder.parent().remove();\n                        this._cleanUpTree($parentFolder);\n                    }\n\n                    if (textStatus === 'success' && data.error) {\n                        alert(data.error);\n                    }\n                }, this));\n            }\n        },\n\n        /**\n         * Rename\n         */\n        _renameFolder: function($targetFolder) {\n            var oldName = $.trim($targetFolder.text()),\n                newName = prompt(Craft.t('app', 'Rename folder'), oldName);\n\n            if (newName && newName !== oldName) {\n                var params = {\n                    folderId: $targetFolder.data('folder-id'),\n                    newName: newName\n                };\n\n                this.setIndexBusy();\n\n                Craft.postActionRequest('assets/rename-folder', params, $.proxy(function(data, textStatus) {\n                    this.setIndexAvailable();\n\n                    if (textStatus === 'success' && data.success) {\n                        $targetFolder.text(data.newName);\n\n                        // If the current folder was renamed.\n                        if (this._getFolderUidFromSourceKey(this.sourceSelect.$selectedItems.data('key')) === this._getFolderUidFromSourceKey($targetFolder.data('key'))) {\n                            this.updateElements();\n                        }\n                    }\n\n                    if (textStatus === 'success' && data.error) {\n                        alert(data.error);\n                    }\n\n                }, this), 'json');\n            }\n        },\n\n        /**\n         * Prepare a source folder for children folder.\n         *\n         * @param $parentFolder\n         * @private\n         */\n        _prepareParentForChildren: function($parentFolder) {\n            if (!this._hasSubfolders($parentFolder)) {\n                $parentFolder.parent().addClass('expanded').append('<div class=\"toggle\"></div><ul></ul>');\n                this.initSourceToggle($parentFolder);\n            }\n        },\n\n        /**\n         * Appends a subfolder to the parent folder at the correct spot.\n         *\n         * @param $parentFolder\n         * @param $subfolder\n         * @private\n         */\n        _appendSubfolder: function($parentFolder, $subfolder) {\n            var $subfolderList = $parentFolder.siblings('ul'),\n                $existingChildren = $subfolderList.children('li'),\n                subfolderLabel = $.trim($subfolder.children('a:first').text()),\n                folderInserted = false;\n\n            for (var i = 0; i < $existingChildren.length; i++) {\n                var $existingChild = $($existingChildren[i]);\n\n                if ($.trim($existingChild.children('a:first').text()) > subfolderLabel) {\n                    $existingChild.before($subfolder);\n                    folderInserted = true;\n                    break;\n                }\n            }\n\n            if (!folderInserted) {\n                $parentFolder.siblings('ul').append($subfolder);\n            }\n        },\n\n        _cleanUpTree: function($parentFolder) {\n            if ($parentFolder !== null && $parentFolder.siblings('ul').children('li').length === 0) {\n                this.deinitSourceToggle($parentFolder);\n                $parentFolder.siblings('ul').remove();\n                $parentFolder.siblings('.toggle').remove();\n                $parentFolder.parent().removeClass('expanded');\n            }\n        },\n\n        _positionProgressBar: function() {\n            if (!this.progressBar) {\n                this.progressBar = new Craft.ProgressBar(this.$main, true);\n            }\n\n            var $container = $(),\n                scrollTop = 0,\n                offset = 0;\n\n            if (this.settings.context === 'index') {\n                $container = this.progressBar.$progressBar.closest('#content');\n                scrollTop = Garnish.$win.scrollTop();\n            } else {\n                $container = this.progressBar.$progressBar.closest('.main');\n                scrollTop = this.$main.scrollTop();\n            }\n\n            var containerTop = $container.offset().top;\n            var diff = scrollTop - containerTop;\n            var windowHeight = Garnish.$win.height();\n\n            if ($container.height() > windowHeight) {\n                offset = (windowHeight / 2) - 6 + diff;\n            } else {\n                offset = ($container.height() / 2) - 6;\n            }\n\n            if (this.settings.context !== 'index') {\n                offset = scrollTop + (($container.height() / 2) - 6);\n            }\n\n            this.progressBar.$progressBar.css({\n                top: offset\n            });\n        },\n\n        _performBatchRequests: function(parameterArray, finalCallback) {\n\n            var responseArray = [];\n\n            var doRequest = function (parameters) {\n                Craft.postActionRequest(parameters.action, parameters.params, function (data, textStatus) {\n                    this.progressBar.incrementProcessedItemCount(1);\n                    this.progressBar.updateProgressBar();\n\n                    if (textStatus === 'success') {\n                        responseArray.push(data);\n\n                        // If assets were just merged we should get the reference tags updated right away\n                        Craft.cp.runQueue();\n                    }\n\n                    if (responseArray.length >= parameterArray.length) {\n                        finalCallback(responseArray);\n                    }\n                }.bind(this));\n            }.bind(this);\n\n            for (var i = 0; i < parameterArray.length; i++) {\n                doRequest(parameterArray[i]);\n            }\n        }\n\n    });\n\n// Register it!\nCraft.registerElementIndexClass('craft\\\\elements\\\\Asset', Craft.AssetIndex);\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Asset Select input\n */\nCraft.AssetSelectInput = Craft.BaseElementSelectInput.extend(\n    {\n        requestId: 0,\n        hud: null,\n        uploader: null,\n        progressBar: null,\n\n        originalFilename: '',\n        originalExtension: '',\n\n        init: function() {\n            if (arguments.length > 0 && typeof arguments[0] === 'object') {\n                arguments[0].editorSettings = {\n                    onShowHud: $.proxy(this.resetOriginalFilename, this),\n                    onCreateForm: $.proxy(this._renameHelper, this),\n                    validators: [$.proxy(this.validateElementForm, this)]\n                };\n            }\n\n            this.base.apply(this, arguments);\n            this._attachUploader();\n\n            this.addListener(this.$elementsContainer, 'keydown', this._onKeyDown.bind(this));\n            this.elementSelect.on('focusItem', this._onElementFocus.bind(this));\n        },\n\n        /**\n         * Handle a keypress\n         * @private\n         */\n        _onKeyDown: function(ev) {\n            if (ev.keyCode === Garnish.SPACE_KEY && ev.shiftKey) {\n                if (Craft.PreviewFileModal.openInstance) {\n                    Craft.PreviewFileModal.openInstance.selfDestruct();\n                } else {\n                    var $element = this.elementSelect.$focusedItem;\n\n                    if ($element.length) {\n                        this._loadPreview($element);\n                    }\n                }\n\n                ev.stopPropagation();\n\n                return false;\n            }\n        },\n\n        /**\n         * Handle element being focused\n         * @private\n         */\n        _onElementFocus: function(ev) {\n            var $element = $(ev.item);\n\n            if (Craft.PreviewFileModal.openInstance && $element.length) {\n                this._loadPreview($element);\n            }\n        },\n\n        /**\n         * Load the preview for an Asset element\n         * @private\n         */\n        _loadPreview: function($element) {\n            var settings = {};\n\n            if ($element.data('image-width')) {\n                settings.startingWidth = $element.data('image-width');\n                settings.startingHeight = $element.data('image-height');\n            }\n\n            new Craft.PreviewFileModal($element.data('id'), this.elementSelect, settings);\n        },\n\n        /**\n         * Create the element editor\n         */\n        createElementEditor: function($element) {\n            return this.base($element, {\n                params: {\n                    defaultFieldLayoutId: this.settings.defaultFieldLayoutId\n                }\n            });\n        },\n\n        /**\n         * Attach the uploader with drag event handler\n         */\n        _attachUploader: function() {\n            this.progressBar = new Craft.ProgressBar($('<div class=\"progress-shade\"></div>').appendTo(this.$container));\n\n            var options = {\n                url: Craft.getActionUrl('assets/save-asset'),\n                dropZone: this.$container,\n                formData: {\n                    fieldId: this.settings.fieldId,\n                    elementId: this.settings.sourceElementId\n                }\n            };\n\n            // If CSRF protection isn't enabled, these won't be defined.\n            if (typeof Craft.csrfTokenName !== 'undefined' && typeof Craft.csrfTokenValue !== 'undefined') {\n                // Add the CSRF token\n                options.formData[Craft.csrfTokenName] = Craft.csrfTokenValue;\n            }\n\n            if (typeof this.settings.criteria.kind !== 'undefined') {\n                options.allowedKinds = this.settings.criteria.kind;\n            }\n\n            options.canAddMoreFiles = $.proxy(this, 'canAddMoreFiles');\n\n            options.events = {};\n            options.events.fileuploadstart = $.proxy(this, '_onUploadStart');\n            options.events.fileuploadprogressall = $.proxy(this, '_onUploadProgress');\n            options.events.fileuploaddone = $.proxy(this, '_onUploadComplete');\n\n            this.uploader = new Craft.Uploader(this.$container, options);\n        },\n\n        /**\n         * Add the freshly uploaded file to the input field.\n         */\n        selectUploadedFile: function(element) {\n            // Check if we're able to add new elements\n            if (!this.canAddMoreElements()) {\n                return;\n            }\n\n            var $newElement = element.$element;\n\n            // Make a couple tweaks\n            $newElement.addClass('removable');\n            $newElement.prepend('<input type=\"hidden\" name=\"' + this.settings.name + '[]\" value=\"' + element.id + '\">' +\n                '<a class=\"delete icon\" title=\"' + Craft.t('app', 'Remove') + '\"></a>');\n\n            $newElement.appendTo(this.$elementsContainer);\n\n            var margin = -($newElement.outerWidth() + 10);\n\n            this.$addElementBtn.css('margin-' + Craft.left, margin + 'px');\n\n            var animateCss = {};\n            animateCss['margin-' + Craft.left] = 0;\n            this.$addElementBtn.velocity(animateCss, 'fast');\n\n            this.addElements($newElement);\n\n            delete this.modal;\n        },\n\n        /**\n         * On upload start.\n         */\n        _onUploadStart: function() {\n            this.progressBar.$progressBar.css({\n                top: Math.round(this.$container.outerHeight() / 2) - 6\n            });\n\n            this.$container.addClass('uploading');\n            this.progressBar.resetProgressBar();\n            this.progressBar.showProgressBar();\n        },\n\n        /**\n         * On upload progress.\n         */\n        _onUploadProgress: function(event, data) {\n            var progress = parseInt(data.loaded / data.total * 100, 10);\n            this.progressBar.setProgressPercentage(progress);\n        },\n\n        /**\n         * On a file being uploaded.\n         */\n        _onUploadComplete: function(event, data) {\n            if (data.result.error) {\n                alert(data.result.error);\n            } else {\n                var parameters = {\n                    elementId: data.result.assetId,\n                    siteId: this.settings.criteria.siteId,\n                    size: this.settings.viewMode\n                };\n\n                Craft.postActionRequest('elements/get-element-html', parameters, function(data) {\n                    if (data.error) {\n                        alert(data.error);\n                    } else {\n                        var html = $(data.html);\n                        Craft.appendHeadHtml(data.headHtml);\n                        this.selectUploadedFile(Craft.getElementInfo(html));\n                    }\n\n                    // Last file\n                    if (this.uploader.isLastUpload()) {\n                        this.progressBar.hideProgressBar();\n                        this.$container.removeClass('uploading');\n\n                        if (window.draftEditor) {\n                            window.draftEditor.checkForm();\n                        }\n                    }\n                }.bind(this));\n\n                Craft.cp.runQueue();\n            }\n        },\n\n        /**\n         * We have to take into account files about to be added as well\n         */\n        canAddMoreFiles: function(slotsTaken) {\n            return (!this.settings.limit || this.$elements.length + slotsTaken < this.settings.limit);\n        },\n\n        /**\n         * Parse the passed filename into the base filename and extension.\n         *\n         * @param filename\n         * @returns {{extension: string, baseFileName: string}}\n         */\n        _parseFilename: function(filename) {\n            var parts = filename.split('.'),\n                extension = '';\n\n            if (parts.length > 1) {\n                extension = parts.pop();\n            }\n            var baseFileName = parts.join('.');\n            return {extension: extension, baseFileName: baseFileName};\n        },\n\n        /**\n         * A helper function or the filename field.\n         * @private\n         */\n        _renameHelper: function($form) {\n            $('.renameHelper', $form).on('focus', $.proxy(function(e) {\n                var input = e.currentTarget,\n                    filename = this._parseFilename(input.value);\n\n                if (this.originalFilename === '' && this.originalExtension === '') {\n                    this.originalFilename = filename.baseFileName;\n                    this.originalExtension = filename.extension;\n                }\n\n                var startPos = 0,\n                    endPos = filename.baseFileName.length;\n\n                if (typeof input.selectionStart !== 'undefined') {\n                    input.selectionStart = startPos;\n                    input.selectionEnd = endPos;\n                } else if (document.selection && document.selection.createRange) {\n                    // IE branch\n                    input.select();\n                    var range = document.selection.createRange();\n                    range.collapse(true);\n                    range.moveEnd(\"character\", endPos);\n                    range.moveStart(\"character\", startPos);\n                    range.select();\n                }\n\n            }, this));\n        },\n\n        resetOriginalFilename: function() {\n            this.originalFilename = \"\";\n            this.originalExtension = \"\";\n        },\n\n        validateElementForm: function() {\n            var $filenameField = $('.renameHelper', this.elementEditor.hud.$hud.data('elementEditor').$form);\n            var filename = this._parseFilename($filenameField.val());\n\n            if (filename.extension !== this.originalExtension) {\n                // Blank extension\n                if (filename.extension === '') {\n                    // If filename changed as well, assume removal of extension a mistake\n                    if (this.originalFilename !== filename.baseFileName) {\n                        $filenameField.val(filename.baseFileName + '.' + this.originalExtension);\n                        return true;\n                    } else {\n                        // If filename hasn't changed, make sure they want to remove extension\n                        return confirm(Craft.t('app', \"Are you sure you want to remove the extension \u201c.{ext}\u201d?\", {ext: this.originalExtension}));\n                    }\n                } else {\n                    // If the extension has changed, make sure it s intentional\n                    return confirm(Craft.t('app', \"Are you sure you want to change the extension from \u201c.{oldExt}\u201d to \u201c.{newExt}\u201d?\",\n                        {\n                            oldExt: this.originalExtension,\n                            newExt: filename.extension\n                        }));\n                }\n            }\n            return true;\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Asset selector modal class\n */\nCraft.AssetSelectorModal = Craft.BaseElementSelectorModal.extend(\n    {\n        $selectTransformBtn: null,\n        _selectedTransform: null,\n\n        init: function(elementType, settings) {\n            settings = $.extend({}, Craft.AssetSelectorModal.defaults, settings);\n\n            this.base(elementType, settings);\n\n            if (settings.transforms.length) {\n                this.createSelectTransformButton(settings.transforms);\n            }\n        },\n\n        createSelectTransformButton: function(transforms) {\n            if (!transforms || !transforms.length) {\n                return;\n            }\n\n            var $btnGroup = $('<div class=\"btngroup\"/>').appendTo(this.$primaryButtons);\n            this.$selectBtn.appendTo($btnGroup);\n\n            this.$selectTransformBtn = $('<div class=\"btn menubtn disabled\">' + Craft.t('app', 'Select transform') + '</div>').appendTo($btnGroup);\n\n            var $menu = $('<div class=\"menu\" data-align=\"right\"></div>').insertAfter(this.$selectTransformBtn),\n                $menuList = $('<ul></ul>').appendTo($menu);\n\n            for (var i = 0; i < transforms.length; i++) {\n                $('<li><a data-transform=\"' + transforms[i].handle + '\">' + transforms[i].name + '</a></li>').appendTo($menuList);\n            }\n\n            var MenuButton = new Garnish.MenuBtn(this.$selectTransformBtn, {\n                onOptionSelect: $.proxy(this, 'onSelectTransform')\n            });\n            MenuButton.disable();\n\n            this.$selectTransformBtn.data('menuButton', MenuButton);\n        },\n\n        onSelectionChange: function(ev) {\n            var $selectedElements = this.elementIndex.getSelectedElements(),\n                allowTransforms = false;\n\n            if ($selectedElements.length && this.settings.transforms.length) {\n                allowTransforms = true;\n\n                for (var i = 0; i < $selectedElements.length; i++) {\n                    if (!$('.element.hasthumb:first', $selectedElements[i]).length) {\n                        break;\n                    }\n                }\n            }\n\n            var MenuBtn = null;\n\n            if (this.$selectTransformBtn) {\n                MenuBtn = this.$selectTransformBtn.data('menuButton');\n            }\n\n            if (allowTransforms) {\n                if (MenuBtn) {\n                    MenuBtn.enable();\n                }\n\n                this.$selectTransformBtn.removeClass('disabled');\n            }\n            else if (this.$selectTransformBtn) {\n                if (MenuBtn) {\n                    MenuBtn.disable();\n                }\n\n                this.$selectTransformBtn.addClass('disabled');\n            }\n\n            this.base();\n        },\n\n        onSelectTransform: function(option) {\n            var transform = $(option).data('transform');\n            this.selectImagesWithTransform(transform);\n        },\n\n        selectImagesWithTransform: function(transform) {\n            // First we must get any missing transform URLs\n            if (typeof Craft.AssetSelectorModal.transformUrls[transform] === 'undefined') {\n                Craft.AssetSelectorModal.transformUrls[transform] = {};\n            }\n\n            var $selectedElements = this.elementIndex.getSelectedElements(),\n                imageIdsWithMissingUrls = [];\n\n            for (var i = 0; i < $selectedElements.length; i++) {\n                var $item = $($selectedElements[i]),\n                    elementId = Craft.getElementInfo($item).id;\n\n                if (typeof Craft.AssetSelectorModal.transformUrls[transform][elementId] === 'undefined') {\n                    imageIdsWithMissingUrls.push(elementId);\n                }\n            }\n\n            if (imageIdsWithMissingUrls.length) {\n                this.showFooterSpinner();\n\n                this.fetchMissingTransformUrls(imageIdsWithMissingUrls, transform, $.proxy(function() {\n                    this.hideFooterSpinner();\n                    this.selectImagesWithTransform(transform);\n                }, this));\n            }\n            else {\n                this._selectedTransform = transform;\n                this.selectElements();\n                this._selectedTransform = null;\n            }\n        },\n\n        fetchMissingTransformUrls: function(imageIdsWithMissingUrls, transform, callback) {\n            var elementId = imageIdsWithMissingUrls.pop();\n\n            var data = {\n                assetId: elementId,\n                handle: transform\n            };\n\n            Craft.postActionRequest('assets/generate-transform', data, $.proxy(function(response, textStatus) {\n                Craft.AssetSelectorModal.transformUrls[transform][elementId] = false;\n\n                if (textStatus === 'success') {\n                    if (response.url) {\n                        Craft.AssetSelectorModal.transformUrls[transform][elementId] = response.url;\n                    }\n                }\n\n                // More to load?\n                if (imageIdsWithMissingUrls.length) {\n                    this.fetchMissingTransformUrls(imageIdsWithMissingUrls, transform, callback);\n                }\n                else {\n                    callback();\n                }\n            }, this));\n        },\n\n        getElementInfo: function($selectedElements) {\n            var info = this.base($selectedElements);\n\n            if (this._selectedTransform) {\n                for (var i = 0; i < info.length; i++) {\n                    var elementId = info[i].id;\n\n                    if (\n                        typeof Craft.AssetSelectorModal.transformUrls[this._selectedTransform][elementId] !== 'undefined' &&\n                        Craft.AssetSelectorModal.transformUrls[this._selectedTransform][elementId] !== false\n                    ) {\n                        info[i].url = Craft.AssetSelectorModal.transformUrls[this._selectedTransform][elementId];\n                    }\n                }\n            }\n\n            return info;\n        },\n\n        onSelect: function(elementInfo) {\n            this.settings.onSelect(elementInfo, this._selectedTransform);\n        }\n    },\n    {\n        defaults: {\n            canSelectImageTransforms: false,\n            transforms: []\n        },\n\n        transformUrls: {}\n    });\n\n// Register it!\nCraft.registerElementSelectorModalClass('craft\\\\elements\\\\Asset', Craft.AssetSelectorModal);\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * AuthManager class\n */\nCraft.AuthManager = Garnish.Base.extend(\n    {\n        remainingSessionTime: null,\n        checkRemainingSessionTimer: null,\n        showLoginModalTimer: null,\n        decrementLogoutWarningInterval: null,\n\n        showingLogoutWarningModal: false,\n        showingLoginModal: false,\n\n        logoutWarningModal: null,\n        loginModal: null,\n\n        $logoutWarningPara: null,\n        $passwordInput: null,\n        $passwordSpinner: null,\n        $loginBtn: null,\n        $loginErrorPara: null,\n\n        submitLoginIfLoggedOut: false,\n\n        /**\n         * Init\n         */\n        init: function() {\n            this.updateRemainingSessionTime(Craft.remainingSessionTime);\n        },\n\n        /**\n         * Sets a timer for the next time to check the auth timeout.\n         */\n        setCheckRemainingSessionTimer: function(seconds) {\n            if (this.checkRemainingSessionTimer) {\n                clearTimeout(this.checkRemainingSessionTimer);\n            }\n\n            this.checkRemainingSessionTimer = setTimeout($.proxy(this, 'checkRemainingSessionTime'), seconds * 1000);\n        },\n\n        /**\n         * Pings the server to see how many seconds are left on the current user session, and handles the response.\n         */\n        checkRemainingSessionTime: function(extendSession) {\n            $.ajax({\n                url: Craft.getActionUrl('users/get-remaining-session-time', (extendSession ? null : 'dontExtendSession=1')),\n                type: 'GET',\n                dataType: 'json',\n                complete: $.proxy(function(jqXHR, textStatus) {\n                    if (textStatus === 'success') {\n                        if (typeof jqXHR.responseJSON.csrfTokenValue !== 'undefined' && typeof Craft.csrfTokenValue !== 'undefined') {\n                            Craft.csrfTokenValue = jqXHR.responseJSON.csrfTokenValue;\n                        }\n\n                        this.updateRemainingSessionTime(jqXHR.responseJSON.timeout);\n                        this.submitLoginIfLoggedOut = false;\n                    }\n                    else {\n                        this.updateRemainingSessionTime(-1);\n                    }\n                }, this)\n            });\n        },\n\n        /**\n         * Updates our record of the auth timeout, and handles it.\n         */\n        updateRemainingSessionTime: function(remainingSessionTime) {\n            this.remainingSessionTime = parseInt(remainingSessionTime);\n\n            // Are we within the warning window?\n            if (this.remainingSessionTime !== -1 && this.remainingSessionTime < Craft.AuthManager.minSafeSessiotTime) {\n                // Is there still time to renew the session?\n                if (this.remainingSessionTime) {\n                    if (!this.showingLogoutWarningModal) {\n                        // Show the warning modal\n                        this.showLogoutWarningModal();\n                    }\n\n                    // Will the session expire before the next checkup?\n                    if (this.remainingSessionTime < Craft.AuthManager.checkInterval) {\n                        if (this.showLoginModalTimer) {\n                            clearTimeout(this.showLoginModalTimer);\n                        }\n\n                        this.showLoginModalTimer = setTimeout($.proxy(this, 'showLoginModal'), this.remainingSessionTime * 1000);\n                    }\n                }\n                else {\n                    if (this.showingLoginModal) {\n                        if (this.submitLoginIfLoggedOut) {\n                            this.submitLogin();\n                        }\n                    }\n                    else {\n                        // Show the login modal\n                        this.showLoginModal();\n                    }\n                }\n\n                this.setCheckRemainingSessionTimer(Craft.AuthManager.checkInterval);\n            }\n            else {\n                // Everything's good!\n                this.hideLogoutWarningModal();\n                this.hideLoginModal();\n\n                // Will be be within the minSafeSessiotTime before the next update?\n                if (this.remainingSessionTime !== -1 && this.remainingSessionTime < (Craft.AuthManager.minSafeSessiotTime + Craft.AuthManager.checkInterval)) {\n                    this.setCheckRemainingSessionTimer(this.remainingSessionTime - Craft.AuthManager.minSafeSessiotTime + 1);\n                }\n                else {\n                    this.setCheckRemainingSessionTimer(Craft.AuthManager.checkInterval);\n                }\n            }\n        },\n\n        /**\n         * Shows the logout warning modal.\n         */\n        showLogoutWarningModal: function() {\n            var quickShow;\n\n            if (this.showingLoginModal) {\n                this.hideLoginModal(true);\n                quickShow = true;\n            }\n            else {\n                quickShow = false;\n            }\n\n            this.showingLogoutWarningModal = true;\n\n            if (!this.logoutWarningModal) {\n                var $form = $('<form id=\"logoutwarningmodal\" class=\"modal alert fitted\"/>'),\n                    $body = $('<div class=\"body\"/>').appendTo($form),\n                    $buttons = $('<div class=\"buttons right\"/>').appendTo($body),\n                    $logoutBtn = $('<div class=\"btn\">' + Craft.t('app', 'Log out now') + '</div>').appendTo($buttons),\n                    $renewSessionBtn = $('<input type=\"submit\" class=\"btn submit\" value=\"' + Craft.t('app', 'Keep me logged in') + '\" />').appendTo($buttons);\n\n                this.$logoutWarningPara = $('<p/>').prependTo($body);\n\n                this.logoutWarningModal = new Garnish.Modal($form, {\n                    autoShow: false,\n                    closeOtherModals: false,\n                    hideOnEsc: false,\n                    hideOnShadeClick: false,\n                    shadeClass: 'modal-shade dark logoutwarningmodalshade',\n                    onFadeIn: function() {\n                        if (!Garnish.isMobileBrowser(true)) {\n                            // Auto-focus the renew button\n                            setTimeout(function() {\n                                $renewSessionBtn.trigger('focus');\n                            }, 100);\n                        }\n                    }\n                });\n\n                this.addListener($logoutBtn, 'activate', 'logout');\n                this.addListener($form, 'submit', 'renewSession');\n            }\n\n            if (quickShow) {\n                this.logoutWarningModal.quickShow();\n            }\n            else {\n                this.logoutWarningModal.show();\n            }\n\n            this.updateLogoutWarningMessage();\n\n            this.decrementLogoutWarningInterval = setInterval($.proxy(this, 'decrementLogoutWarning'), 1000);\n        },\n\n        /**\n         * Updates the logout warning message indicating that the session is about to expire.\n         */\n        updateLogoutWarningMessage: function() {\n            this.$logoutWarningPara.text(Craft.t('app', 'Your session will expire in {time}.', {\n                time: Craft.secondsToHumanTimeDuration(this.remainingSessionTime)\n            }));\n\n            this.logoutWarningModal.updateSizeAndPosition();\n        },\n\n        decrementLogoutWarning: function() {\n            if (this.remainingSessionTime > 0) {\n                this.remainingSessionTime--;\n                this.updateLogoutWarningMessage();\n            }\n\n            if (this.remainingSessionTime === 0) {\n                clearInterval(this.decrementLogoutWarningInterval);\n            }\n        },\n\n        /**\n         * Hides the logout warning modal.\n         */\n        hideLogoutWarningModal: function(quick) {\n            this.showingLogoutWarningModal = false;\n\n            if (this.logoutWarningModal) {\n                if (quick) {\n                    this.logoutWarningModal.quickHide();\n                }\n                else {\n                    this.logoutWarningModal.hide();\n                }\n\n                if (this.decrementLogoutWarningInterval) {\n                    clearInterval(this.decrementLogoutWarningInterval);\n                }\n            }\n        },\n\n        /**\n         * Shows the login modal.\n         */\n        showLoginModal: function() {\n            var quickShow;\n\n            if (this.showingLogoutWarningModal) {\n                this.hideLogoutWarningModal(true);\n                quickShow = true;\n            }\n            else {\n                quickShow = false;\n            }\n\n            this.showingLoginModal = true;\n\n            if (!this.loginModal) {\n                var $form = $('<form id=\"loginmodal\" class=\"modal alert fitted\"/>'),\n                    $body = $('<div class=\"body\"><h2>' + Craft.t('app', 'Your session has ended.') + '</h2><p>' + Craft.t('app', 'Enter your password to log back in.') + '</p></div>').appendTo($form),\n                    $inputContainer = $('<div class=\"inputcontainer\">').appendTo($body),\n                    $inputsFlexContainer = $('<div class=\"flex\"/>').appendTo($inputContainer),\n                    $passwordContainer = $('<div class=\"flex-grow\"/>').appendTo($inputsFlexContainer),\n                    $buttonContainer = $('<div/>').appendTo($inputsFlexContainer),\n                    $passwordWrapper = $('<div class=\"passwordwrapper\"/>').appendTo($passwordContainer);\n\n                this.$passwordInput = $('<input type=\"password\" class=\"text password fullwidth\" placeholder=\"' + Craft.t('app', 'Password') + '\"/>').appendTo($passwordWrapper);\n                this.$passwordSpinner = $('<div class=\"spinner hidden\"/>').appendTo($inputContainer);\n                this.$loginBtn = $('<input type=\"submit\" class=\"btn submit disabled\" value=\"' + Craft.t('app', 'Login') + '\" />').appendTo($buttonContainer);\n                this.$loginErrorPara = $('<p class=\"error\"/>').appendTo($body);\n\n                this.loginModal = new Garnish.Modal($form, {\n                    autoShow: false,\n                    closeOtherModals: false,\n                    hideOnEsc: false,\n                    hideOnShadeClick: false,\n                    shadeClass: 'modal-shade dark loginmodalshade',\n                    onFadeIn: $.proxy(function() {\n                        if (!Garnish.isMobileBrowser(true)) {\n                            // Auto-focus the password input\n                            setTimeout($.proxy(function() {\n                                this.$passwordInput.trigger('focus');\n                            }, this), 100);\n                        }\n                    }, this),\n                    onFadeOut: $.proxy(function() {\n                        this.$passwordInput.val('');\n                    }, this)\n                });\n\n                new Craft.PasswordInput(this.$passwordInput, {\n                    onToggleInput: $.proxy(function($newPasswordInput) {\n                        this.$passwordInput = $newPasswordInput;\n                    }, this)\n                });\n\n                this.addListener(this.$passwordInput, 'textchange', 'validatePassword');\n                this.addListener($form, 'submit', 'login');\n            }\n\n            if (quickShow) {\n                this.loginModal.quickShow();\n            }\n            else {\n                this.loginModal.show();\n            }\n        },\n\n        /**\n         * Hides the login modal.\n         */\n        hideLoginModal: function(quick) {\n            this.showingLoginModal = false;\n\n            if (this.loginModal) {\n                if (quick) {\n                    this.loginModal.quickHide();\n                }\n                else {\n                    this.loginModal.hide();\n                }\n            }\n        },\n\n        logout: function() {\n            $.get({\n                url: Craft.getActionUrl('users/logout'),\n                dataType: 'json',\n                success: $.proxy(function() {\n                    Craft.redirectTo('');\n                }, this)\n            });\n        },\n\n        renewSession: function(ev) {\n            if (ev) {\n                ev.preventDefault();\n            }\n\n            this.hideLogoutWarningModal();\n            this.checkRemainingSessionTime(true);\n        },\n\n        validatePassword: function() {\n            if (this.$passwordInput.val().length >= 6) {\n                this.$loginBtn.removeClass('disabled');\n                return true;\n            }\n            else {\n                this.$loginBtn.addClass('disabled');\n                return false;\n            }\n        },\n\n        login: function(ev) {\n            if (ev) {\n                ev.preventDefault();\n            }\n\n            if (this.validatePassword()) {\n                this.$passwordSpinner.removeClass('hidden');\n                this.clearLoginError();\n\n                if (typeof Craft.csrfTokenValue !== 'undefined') {\n                    // Check the auth status one last time before sending this off,\n                    // in case the user has already logged back in from another window/tab\n                    this.submitLoginIfLoggedOut = true;\n                    this.checkRemainingSessionTime();\n                }\n                else {\n                    this.submitLogin();\n                }\n            }\n        },\n\n        submitLogin: function() {\n            var data = {\n                loginName: Craft.username,\n                password: this.$passwordInput.val()\n            };\n\n            Craft.postActionRequest('users/login', data, $.proxy(function(response, textStatus) {\n                this.$passwordSpinner.addClass('hidden');\n\n                if (textStatus === 'success') {\n                    if (response.success) {\n                        this.hideLoginModal();\n                        this.checkRemainingSessionTime();\n                    }\n                    else {\n                        this.showLoginError(response.error);\n                        Garnish.shake(this.loginModal.$container);\n\n                        if (!Garnish.isMobileBrowser(true)) {\n                            this.$passwordInput.trigger('focus');\n                        }\n                    }\n                }\n                else {\n                    this.showLoginError();\n                }\n\n            }, this));\n        },\n\n        showLoginError: function(error) {\n            if (error === null || typeof error === 'undefined') {\n                error = Craft.t('app', 'An unknown error occurred.');\n            }\n\n            this.$loginErrorPara.text(error);\n            this.loginModal.updateSizeAndPosition();\n        },\n\n        clearLoginError: function() {\n            this.showLoginError('');\n        }\n    },\n    {\n        checkInterval: 60,\n        minSafeSessiotTime: 120\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Category index class\n */\nCraft.CategoryIndex = Craft.BaseElementIndex.extend(\n    {\n        editableGroups: null,\n        $newCategoryBtnGroup: null,\n        $newCategoryBtn: null,\n\n        init: function(elementType, $container, settings) {\n            this.on('selectSource', $.proxy(this, 'updateButton'));\n            this.on('selectSite', $.proxy(this, 'updateButton'));\n            this.base(elementType, $container, settings);\n        },\n\n        afterInit: function() {\n            // Find which of the visible groups the user has permission to create new categories in\n            this.editableGroups = [];\n\n            for (var i = 0; i < Craft.editableCategoryGroups.length; i++) {\n                var group = Craft.editableCategoryGroups[i];\n\n                if (this.getSourceByKey('group:' + group.uid)) {\n                    this.editableGroups.push(group);\n                }\n            }\n\n            this.base();\n        },\n\n        getDefaultSourceKey: function() {\n            // Did they request a specific category group in the URL?\n            if (this.settings.context === 'index' && typeof defaultGroupHandle !== 'undefined') {\n                for (var i = 0; i < this.$sources.length; i++) {\n                    var $source = $(this.$sources[i]);\n\n                    if ($source.data('handle') === defaultGroupHandle) {\n                        return $source.data('key');\n                    }\n                }\n            }\n\n            return this.base();\n        },\n\n        updateButton: function() {\n            if (!this.$source) {\n                return;\n            }\n\n            // Get the handle of the selected source\n            var selectedSourceHandle = this.$source.data('handle');\n\n            var i, href, label;\n\n            // Update the New Category button\n            // ---------------------------------------------------------------------\n\n            if (this.editableGroups.length) {\n                // Remove the old button, if there is one\n                if (this.$newCategoryBtnGroup) {\n                    this.$newCategoryBtnGroup.remove();\n                }\n\n                // Determine if they are viewing a group that they have permission to create categories in\n                var selectedGroup;\n\n                if (selectedSourceHandle) {\n                    for (i = 0; i < this.editableGroups.length; i++) {\n                        if (this.editableGroups[i].handle === selectedSourceHandle) {\n                            selectedGroup = this.editableGroups[i];\n                            break;\n                        }\n                    }\n                }\n\n                this.$newCategoryBtnGroup = $('<div class=\"btngroup submit\"/>');\n                var $menuBtn;\n\n                // If they are, show a primary \"New category\" button, and a dropdown of the other groups (if any).\n                // Otherwise only show a menu button\n                if (selectedGroup) {\n                    href = this._getGroupTriggerHref(selectedGroup);\n                    label = (this.settings.context === 'index' ? Craft.t('app', 'New category') : Craft.t('app', 'New {group} category', {group: selectedGroup.name}));\n                    this.$newCategoryBtn = $('<a class=\"btn submit add icon\" ' + href + '>' + Craft.escapeHtml(label) + '</a>').appendTo(this.$newCategoryBtnGroup);\n\n                    if (this.settings.context !== 'index') {\n                        this.addListener(this.$newCategoryBtn, 'click', function(ev) {\n                            this._openCreateCategoryModal(ev.currentTarget.getAttribute('data-id'));\n                        });\n                    }\n\n                    if (this.editableGroups.length > 1) {\n                        $menuBtn = $('<div class=\"btn submit menubtn\"></div>').appendTo(this.$newCategoryBtnGroup);\n                    }\n                }\n                else {\n                    this.$newCategoryBtn = $menuBtn = $('<div class=\"btn submit add icon menubtn\">' + Craft.t('app', 'New category') + '</div>').appendTo(this.$newCategoryBtnGroup);\n                }\n\n                if ($menuBtn) {\n                    var menuHtml = '<div class=\"menu\"><ul>';\n\n                    for (i = 0; i < this.editableGroups.length; i++) {\n                        var group = this.editableGroups[i];\n\n                        if (this.settings.context === 'index' || group !== selectedGroup) {\n                            href = this._getGroupTriggerHref(group);\n                            label = (this.settings.context === 'index' ? group.name : Craft.t('app', 'New {group} category', {group: group.name}));\n                            menuHtml += '<li><a ' + href + '\">' + Craft.escapeHtml(label) + '</a></li>';\n                        }\n                    }\n\n                    menuHtml += '</ul></div>';\n\n                    $(menuHtml).appendTo(this.$newCategoryBtnGroup);\n                    var menuBtn = new Garnish.MenuBtn($menuBtn);\n\n                    if (this.settings.context !== 'index') {\n                        menuBtn.on('optionSelect', $.proxy(function(ev) {\n                            this._openCreateCategoryModal(ev.option.getAttribute('data-id'));\n                        }, this));\n                    }\n                }\n\n                this.addButton(this.$newCategoryBtnGroup);\n            }\n\n            // Update the URL if we're on the Categories index\n            // ---------------------------------------------------------------------\n\n            if (this.settings.context === 'index' && typeof history !== 'undefined') {\n                var uri = 'categories';\n\n                if (selectedSourceHandle) {\n                    uri += '/' + selectedSourceHandle;\n                }\n\n                history.replaceState({}, '', Craft.getUrl(uri));\n            }\n        },\n\n        _getGroupTriggerHref: function(group) {\n            if (this.settings.context === 'index') {\n                var uri = 'categories/' + group.handle + '/new';\n                if (this.siteId && this.siteId != Craft.primarySiteId) {\n                    for (var i = 0; i < Craft.sites.length; i++) {\n                        if (Craft.sites[i].id == this.siteId) {\n                            uri += '/'+Craft.sites[i].handle;\n                        }\n                    }\n                }\n                return 'href=\"' + Craft.getUrl(uri) + '\"';\n            }\n            else {\n                return 'data-id=\"' + group.id + '\"';\n            }\n        },\n\n        _openCreateCategoryModal: function(groupId) {\n            if (this.$newCategoryBtn.hasClass('loading')) {\n                return;\n            }\n\n            // Find the group\n            var group;\n\n            for (var i = 0; i < this.editableGroups.length; i++) {\n                if (this.editableGroups[i].id == groupId) {\n                    group = this.editableGroups[i];\n                    break;\n                }\n            }\n\n            if (!group) {\n                return;\n            }\n\n            this.$newCategoryBtn.addClass('inactive');\n            var newCategoryBtnText = this.$newCategoryBtn.text();\n            this.$newCategoryBtn.text(Craft.t('app', 'New {group} category', {group: group.name}));\n\n            Craft.createElementEditor(this.elementType, {\n                hudTrigger: this.$newCategoryBtnGroup,\n                elementType: 'craft\\\\elements\\\\Category',\n                siteId: this.siteId,\n                attributes: {\n                    groupId: groupId\n                },\n                onBeginLoading: $.proxy(function() {\n                    this.$newCategoryBtn.addClass('loading');\n                }, this),\n                onEndLoading: $.proxy(function() {\n                    this.$newCategoryBtn.removeClass('loading');\n                }, this),\n                onHideHud: $.proxy(function() {\n                    this.$newCategoryBtn.removeClass('inactive').text(newCategoryBtnText);\n                }, this),\n                onSaveElement: $.proxy(function(response) {\n                    // Make sure the right group is selected\n                    var groupSourceKey = 'group:' + group.uid;\n\n                    if (this.sourceKey !== groupSourceKey) {\n                        this.selectSourceByKey(groupSourceKey);\n                    }\n\n                    this.selectElementAfterUpdate(response.id);\n                    this.updateElements();\n                }, this)\n            });\n        }\n    });\n\n// Register it!\nCraft.registerElementIndexClass('craft\\\\elements\\\\Category', Craft.CategoryIndex);\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Category Select input\n */\nCraft.CategorySelectInput = Craft.BaseElementSelectInput.extend(\n    {\n        setSettings: function() {\n            this.base.apply(this, arguments);\n            this.settings.sortable = false;\n        },\n\n        getModalSettings: function() {\n            var settings = this.base();\n            settings.hideOnSelect = false;\n            return settings;\n        },\n\n        getElements: function() {\n            return this.$elementsContainer.find('.element');\n        },\n\n        onModalSelect: function(elements) {\n            // Disable the modal\n            this.modal.disable();\n            this.modal.disableCancelBtn();\n            this.modal.disableSelectBtn();\n            this.modal.showFooterSpinner();\n\n            // Get the new category HTML\n            var selectedCategoryIds = this.getSelectedElementIds();\n\n            for (var i = 0; i < elements.length; i++) {\n                selectedCategoryIds.push(elements[i].id);\n            }\n\n            var data = {\n                categoryIds: selectedCategoryIds,\n                siteId: elements[0].siteId,\n                id: this.settings.id,\n                name: this.settings.name,\n                branchLimit: this.settings.branchLimit,\n                selectionLabel: this.settings.selectionLabel\n            };\n\n            Craft.postActionRequest('elements/get-categories-input-html', data, $.proxy(function(response, textStatus) {\n                this.modal.enable();\n                this.modal.enableCancelBtn();\n                this.modal.enableSelectBtn();\n                this.modal.hideFooterSpinner();\n\n                if (textStatus === 'success') {\n                    var $newInput = $(response.html),\n                        $newElementsContainer = $newInput.children('.elements');\n\n                    this.$elementsContainer.replaceWith($newElementsContainer);\n                    this.$elementsContainer = $newElementsContainer;\n                    this.resetElements();\n\n                    var filteredElements = [];\n\n                    for (var i = 0; i < elements.length; i++) {\n                        var element = elements[i],\n                            $element = this.getElementById(element.id);\n\n                        if ($element) {\n                            this.animateElementIntoPlace(element.$element, $element);\n                            filteredElements.push(element);\n                        }\n                    }\n\n                    this.updateDisabledElementsInModal();\n                    this.modal.hide();\n                    this.onSelectElements(filteredElements);\n                }\n            }, this));\n        },\n\n        removeElement: function($element) {\n            // Find any descendants this category might have\n            var $allCategories = $element.add($element.parent().siblings('ul').find('.element'));\n\n            // Remove our record of them all at once\n            this.removeElements($allCategories);\n\n            // Animate them away one at a time\n            for (var i = 0; i < $allCategories.length; i++) {\n                this._animateCategoryAway($allCategories, i);\n            }\n        },\n\n        _animateCategoryAway: function($allCategories, i) {\n            var callback;\n\n            // Is this the last one?\n            if (i === $allCategories.length - 1) {\n                callback = $.proxy(function() {\n                    var $li = $allCategories.first().parent().parent(),\n                        $ul = $li.parent();\n\n                    if ($ul[0] === this.$elementsContainer[0] || $li.siblings().length) {\n                        $li.remove();\n                    }\n                    else {\n                        $ul.remove();\n                    }\n                }, this);\n            }\n\n            var func = $.proxy(function() {\n                this.animateElementAway($allCategories.eq(i), callback);\n            }, this);\n\n            if (i === 0) {\n                func();\n            }\n            else {\n                setTimeout(func, 100 * i);\n            }\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Craft Charts\n */\n\nCraft.charts = {};\n\n// ---------------------------------------------------------------------\n\n/**\n * Class Craft.charts.DataTable\n */\nCraft.charts.DataTable = Garnish.Base.extend(\n    {\n        columns: null,\n        rows: null,\n\n        init: function(data) {\n            columns = data.columns;\n            rows = data.rows;\n\n            rows.forEach($.proxy(function(d) {\n                $.each(d, function(cellIndex) {\n                    var column = columns[cellIndex];\n\n                    var parseTime;\n\n                    switch (column.type) {\n                        case 'date':\n                            parseTime = d3.timeParse(\"%Y-%m-%d\");\n                            d[cellIndex] = parseTime(d[cellIndex]);\n                            break;\n\n                        case 'datetime':\n                            parseTime = d3.timeParse(\"%Y-%m-%d %H:00:00\");\n                            d[cellIndex] = parseTime(d[cellIndex]);\n                            break;\n\n                        case 'percent':\n                            d[cellIndex] = d[cellIndex] / 100;\n                            break;\n\n                        case 'number':\n                            d[cellIndex] = +d[cellIndex];\n                            break;\n\n                        default:\n                        // do nothing\n                    }\n                });\n\n            }, this));\n\n            this.columns = columns;\n            this.rows = rows;\n        }\n    });\n\n// ---------------------------------------------------------------------\n\n/**\n * Class Craft.charts.Tip\n */\n\nCraft.charts.Tip = Garnish.Base.extend(\n    {\n        $container: null,\n        $tip: null,\n\n        init: function($container) {\n            this.$container = $container;\n\n            this.$tip = $('<div class=\"tooltip\"></div>').appendTo(this.$container);\n\n            this.hide();\n        },\n\n        setContent: function(html) {\n            this.$tip.html(html);\n        },\n\n        setPosition: function(position) {\n            this.$tip.css(\"left\", position.left + \"px\");\n            this.$tip.css(\"top\", position.top + \"px\");\n        },\n\n        show: function() {\n            this.$tip.css(\"display\", 'block');\n        },\n\n        hide: function() {\n            this.$tip.css(\"display\", 'none');\n        }\n    });\n\n// ---------------------------------------------------------------------\n\n/**\n * Class Craft.charts.BaseChart\n */\nCraft.charts.BaseChart = Garnish.Base.extend(\n    {\n        $container: null,\n        $chart: null,\n\n        chartBaseClass: 'cp-chart',\n        dataTable: null,\n\n        formatLocale: null,\n        timeFormatLocale: null,\n        orientation: null,\n\n        svg: null,\n        width: null,\n        height: null,\n\n        init: function(container, settings) {\n            this.$container = container;\n\n            this.setSettings(Craft.charts.BaseChart.defaults);\n            this.setSettings(settings);\n\n            var globalSettings = {\n                formats: window.d3Formats,\n                formatLocaleDefinition: window.d3FormatLocaleDefinition,\n                timeFormatLocaleDefinition: window.d3TimeFormatLocaleDefinition\n            };\n\n            this.setSettings(globalSettings);\n\n            d3.select(window).on('resize', $.proxy(function() {\n                this.resize();\n            }, this));\n        },\n\n        setSettings: function(settings, defaults) {\n            var baseSettings = (typeof this.settings === 'undefined' ? {} : this.settings);\n            this.settings = $.extend(true, {}, baseSettings, defaults, settings);\n        },\n\n        draw: function(dataTable, settings) {\n            // Settings and chart attributes\n\n            this.setSettings(settings);\n\n            this.dataTable = dataTable;\n            this.formatLocale = d3.formatLocale(this.settings.formatLocaleDefinition);\n            this.timeFormatLocale = d3.timeFormatLocale(this.settings.timeFormatLocaleDefinition);\n            this.orientation = this.settings.orientation;\n\n\n            // Set (or reset) the chart element\n\n            if (this.$chart) {\n                this.$chart.remove();\n            }\n\n            var className = this.chartBaseClass;\n\n            if (this.settings.chartClass) {\n                className += ' ' + this.settings.chartClass;\n            }\n\n            this.$chart = $('<div class=\"' + className + '\" />').appendTo(this.$container);\n        },\n\n        resize: function() {\n            this.draw(this.dataTable, this.settings);\n        },\n\n        onAfterDrawTicks: function() {\n            // White border for ticks' text\n            $('.tick', this.$chart).each(function(tickKey, tick) {\n                var $tickText = $('text', tick);\n\n                var $clone = $tickText.clone();\n                $clone.appendTo(tick);\n\n                $tickText.attr('stroke', '#ffffff');\n                $tickText.attr('stroke-width', 3);\n            });\n        }\n    },\n    {\n        defaults: {\n            formatLocaleDefinition: null,\n            timeFormatLocaleDefinition: null,\n            formats: {\n                numberFormat: ',.2f',\n                percentFormat: ',.2%',\n                currencyFormat: '$,.2f',\n                shortDateFormats: {\n                    day: \"%-m/%-d\",\n                    month: \"%-m/%y\",\n                    year: \"%Y\"\n                }\n            },\n            margin: {top: 0, right: 0, bottom: 0, left: 0},\n            chartClass: null,\n            colors: [\"#0594D1\", \"#DE3800\", \"#FF9A00\", \"#009802\", \"#9B009B\"]\n        }\n    });\n\n// ---------------------------------------------------------------------\n\n/**\n * Class Craft.charts.Area\n */\nCraft.charts.Area = Craft.charts.BaseChart.extend(\n    {\n        tip: null,\n        drawingArea: null,\n\n        init: function(container, settings) {\n            this.base(container, Craft.charts.Area.defaults);\n\n            this.setSettings(settings);\n        },\n\n        draw: function(dataTable, settings) {\n\n            this.base(dataTable, settings);\n\n            if (this.tip) {\n                this.tip = null;\n            }\n\n            var margin = this.getChartMargin();\n\n            this.width = this.$chart.width() - margin.left - margin.right;\n            this.height = this.$chart.height() - margin.top - margin.bottom;\n\n\n            // Append SVG to chart element\n\n            var svg = {\n                width: this.width + (margin.left + margin.right),\n                height: this.height + (margin.top + margin.bottom),\n                translateX: (this.orientation !== 'rtl' ? (margin.left) : (margin.right)),\n                translateY: margin.top\n            };\n\n            this.svg = d3.select(this.$chart.get(0)).append(\"svg\")\n                .attr(\"width\", svg.width)\n                .attr(\"height\", svg.height);\n\n            this.drawingArea = this.svg.append(\"g\")\n                .attr(\"transform\", \"translate(\" + svg.translateX + \",\" + svg.translateY + \")\");\n\n\n            // Draw elements\n\n            this.drawTicks();\n            this.drawAxes();\n            this.drawChart();\n            this.drawTipTriggers();\n        },\n\n        drawTicks: function() {\n            // Draw X ticks\n\n            var x = this.getX(true);\n            var xTicks = 3;\n            var xAxis = d3.axisBottom(x)\n                .tickFormat(this.getXFormatter())\n                .ticks(xTicks);\n\n            this.drawingArea.append(\"g\")\n                .attr(\"class\", \"x ticks-axis\")\n                .attr(\"transform\", \"translate(0, \" + this.height + \")\")\n                .call(xAxis);\n\n\n            // Draw Y ticks\n\n            var y = this.getY();\n            var yTicks = 2;\n            var yAxis;\n\n            if (this.orientation !== 'rtl') {\n                yAxis = d3.axisLeft(y)\n                    .tickFormat(this.getYFormatter())\n                    .tickValues(this.getYTickValues())\n                    .ticks(yTicks);\n\n                this.drawingArea.append(\"g\")\n                    .attr(\"class\", \"y ticks-axis\")\n                    .call(yAxis);\n            } else {\n                yAxis = d3.axisRight(y)\n                    .tickFormat(this.getYFormatter())\n                    .tickValues(this.getYTickValues())\n                    .ticks(yTicks);\n\n                this.drawingArea.append(\"g\")\n                    .attr(\"class\", \"y ticks-axis\")\n                    .attr(\"transform\", \"translate(\" + this.width + \",0)\")\n                    .call(yAxis);\n            }\n\n\n            // On after draw ticks\n\n            this.onAfterDrawTicks();\n        },\n\n        drawAxes: function() {\n            if (this.settings.xAxis.showAxis) {\n                var x = this.getX();\n                var xAxis = d3.axisBottom(x).ticks(0).tickSizeOuter(0);\n                this.drawingArea.append(\"g\")\n                    .attr(\"class\", \"x axis\")\n                    .attr(\"transform\", \"translate(0, \" + this.height + \")\")\n                    .call(xAxis);\n            }\n\n            if (this.settings.yAxis.showAxis) {\n                var y = this.getY();\n                var chartPadding = 0;\n                var yAxis;\n\n                if (this.orientation === 'rtl') {\n                    yAxis = d3.axisLeft(y).ticks(0);\n                    this.drawingArea.append(\"g\")\n                        .attr(\"class\", \"y axis\")\n                        .attr(\"transform\", \"translate(\" + (this.width - chartPadding) + \", 0)\")\n                        .call(yAxis);\n                } else {\n                    yAxis = d3.axisRight(y).ticks(0);\n                    this.drawingArea.append(\"g\")\n                        .attr(\"class\", \"y axis\")\n                        .attr(\"transform\", \"translate(\" + chartPadding + \", 0)\")\n                        .call(yAxis);\n                }\n            }\n        },\n\n        drawChart: function() {\n            var x = this.getX(true);\n            var y = this.getY();\n\n\n            // X & Y grid lines\n\n            if (this.settings.xAxis.gridlines) {\n                var xLineAxis = d3.axisBottom(x);\n\n                this.drawingArea.append(\"g\")\n                    .attr(\"class\", \"x grid-line\")\n                    .attr(\"transform\", \"translate(0,\" + this.height + \")\")\n                    .call(xLineAxis\n                        .tickSize(-this.height, 0, 0)\n                        .tickFormat(\"\")\n                    );\n            }\n\n            var yTicks = 2;\n\n            if (this.settings.yAxis.gridlines) {\n                var yLineAxis = d3.axisLeft(y);\n\n                this.drawingArea.append(\"g\")\n                    .attr(\"class\", \"y grid-line\")\n                    .attr(\"transform\", \"translate(0 , 0)\")\n                    .call(yLineAxis\n                        .tickSize(-(this.width), 0)\n                        .tickFormat(\"\")\n                        .tickValues(this.getYTickValues())\n                        .ticks(yTicks)\n                    );\n            }\n\n            // Line\n\n            var line = d3.line()\n                .x(function(d) {\n                    return x(d[0]);\n                })\n                .y(function(d) {\n                    return y(d[1]);\n                });\n\n            this.drawingArea\n                .append(\"g\")\n                .attr(\"class\", \"chart-line\")\n                .append(\"path\")\n                .datum(this.dataTable.rows)\n                .style('fill', 'none')\n                .style('stroke', this.settings.colors[0])\n                .style('stroke-width', '3px')\n                .attr(\"d\", line);\n\n\n            // Area\n\n            var area = d3.area()\n                .x(function(d) {\n                    return x(d[0]);\n                })\n                .y0(this.height)\n                .y1(function(d) {\n                    return y(d[1]);\n                });\n\n            this.drawingArea\n                .append(\"g\")\n                .attr(\"class\", \"chart-area\")\n                .append(\"path\")\n                .datum(this.dataTable.rows)\n                .style('fill', this.settings.colors[0])\n                .style('fill-opacity', '0.3')\n                .attr(\"d\", area);\n\n\n            // Plots\n\n            if (this.settings.plots) {\n                this.drawingArea.append('g')\n                    .attr(\"class\", \"plots\")\n                    .selectAll(\"circle\")\n                    .data(this.dataTable.rows)\n                    .enter()\n                    .append(\"circle\")\n                    .style('fill', this.settings.colors[0])\n                    .attr(\"class\", $.proxy(function(d, index) {\n                        return 'plot plot-' + index;\n                    }, this))\n                    .attr(\"r\", 4)\n                    .attr(\"cx\", $.proxy(function(d) {\n                        return x(d[0]);\n                    }, this))\n                    .attr(\"cy\", $.proxy(function(d) {\n                        return y(d[1]);\n                    }, this));\n            }\n        },\n\n        drawTipTriggers: function() {\n            if (this.settings.tips) {\n                if (!this.tip) {\n                    this.tip = new Craft.charts.Tip(this.$chart);\n                }\n\n\n                // Define xAxisTickInterval\n\n                var chartMargin = this.getChartMargin();\n                var tickSizeOuter = 6;\n                var length = this.drawingArea.select('.x path.domain').node().getTotalLength() - chartMargin.left - chartMargin.right - tickSizeOuter * 2;\n                var xAxisTickInterval = length / (this.dataTable.rows.length - 1);\n\n\n                // Tip trigger width\n\n                var tipTriggerWidth = Math.max(0, xAxisTickInterval);\n\n\n                // Draw triggers\n\n                var x = this.getX(true);\n                var y = this.getY();\n\n                this.drawingArea.append('g')\n                    .attr(\"class\", \"tip-triggers\")\n                    .selectAll(\"rect\")\n                    .data(this.dataTable.rows)\n                    .enter().append(\"rect\")\n                    .attr(\"class\", \"tip-trigger\")\n                    .style('fill', 'transparent')\n                    .style('fill-opacity', '1')\n                    .attr(\"width\", tipTriggerWidth)\n                    .attr(\"height\", this.height)\n                    .attr(\"x\", $.proxy(function(d) {\n                        return x(d[0]) - tipTriggerWidth / 2;\n                    }, this))\n                    .on(\"mouseover\", $.proxy(function(d, index) {\n                        // Expand plot\n\n                        this.drawingArea.select('.plot-' + index).attr(\"r\", 5);\n\n\n                        // Set tip content\n\n                        var $content = $('<div />');\n                        var $xValue = $('<div class=\"x-value\" />').appendTo($content);\n                        var $yValue = $('<div class=\"y-value\" />').appendTo($content);\n\n                        $xValue.html(this.getXFormatter()(d[0]));\n                        $yValue.html(this.getYFormatter()(d[1]));\n\n                        var content = $content.get(0);\n\n                        this.tip.setContent(content);\n\n\n                        // Set tip position\n\n                        var margin = this.getChartMargin();\n\n                        var offset = 24;\n                        var top = (y(d[1]) + offset);\n                        var left;\n\n                        if (this.orientation !== 'rtl') {\n                            left = (x(d[0]) + margin.left + offset);\n\n                            var calcLeft = (this.$chart.offset().left + left + this.tip.$tip.width());\n                            var maxLeft = this.$chart.offset().left + this.$chart.width() - offset;\n\n                            if (calcLeft > maxLeft) {\n                                left = x(d[0]) - (this.tip.$tip.width() + offset);\n                            }\n                        } else {\n                            left = (x(d[0]) - (this.tip.$tip.width() + margin.left + offset));\n                        }\n\n                        if (left < 0) {\n                            left = (x(d[0]) + margin.left + offset);\n                        }\n\n                        var position = {\n                            top: top,\n                            left: left\n                        };\n\n                        this.tip.setPosition(position);\n\n\n                        // Show tip\n\n                        this.tip.show();\n\n                    }, this))\n                    .on(\"mouseout\", $.proxy(function(d, index) {\n                        // Unexpand Plot\n                        this.drawingArea.select('.plot-' + index).attr(\"r\", 4);\n\n                        // Hide tip\n                        this.tip.hide();\n                    }, this));\n            }\n        },\n\n        getChartMargin: function() {\n            var margin = this.settings.margin;\n\n\n            // Estimate the max width of y ticks and set it as the left margin\n\n            var values = this.getYTickValues();\n            var yTicksMaxWidth = 0;\n\n            $.each(values, $.proxy(function(key, value) {\n                var characterWidth = 8;\n\n                var formatter = this.getYFormatter();\n\n                var formattedValue = formatter(value);\n                var computedTickWidth = formattedValue.length * characterWidth;\n\n                if (computedTickWidth > yTicksMaxWidth) {\n                    yTicksMaxWidth = computedTickWidth;\n                }\n            }, this));\n\n            yTicksMaxWidth += 10;\n\n            margin.left = yTicksMaxWidth;\n\n            return margin;\n        },\n\n        getX: function(padded) {\n            var xDomainMin = d3.min(this.dataTable.rows, function(d) {\n                return d[0];\n            });\n\n            var xDomainMax = d3.max(this.dataTable.rows, function(d) {\n                return d[0];\n            });\n\n            var xDomain = [xDomainMin, xDomainMax];\n\n            if (this.orientation === 'rtl') {\n                xDomain = [xDomainMax, xDomainMin];\n            }\n\n            var left = 0;\n            var right = 0;\n\n            if (padded) {\n                left = 0;\n                right = 0;\n            }\n\n            var x = d3.scaleTime().range([left, (this.width - right)]);\n\n            x.domain(xDomain);\n\n            return x;\n        },\n\n        getY: function() {\n            var yDomain = [0, this.getYMaxValue()];\n\n            var y = d3.scaleLinear().range([this.height, 0]);\n\n            y.domain(yDomain);\n\n            return y;\n        },\n\n        getXFormatter: function() {\n            var formatter;\n\n            if (this.settings.xAxis.formatter !== $.noop) {\n                formatter = this.settings.xAxis.formatter(this);\n            } else {\n                formatter = Craft.charts.utils.getTimeFormatter(this.timeFormatLocale, this.settings);\n            }\n\n            return formatter;\n        },\n\n        getYFormatter: function() {\n            var formatter;\n\n            if (this.settings.yAxis.formatter !== $.noop) {\n                formatter = this.settings.yAxis.formatter(this);\n            } else {\n                formatter = Craft.charts.utils.getNumberFormatter(this.formatLocale, this.dataTable.columns[1].type, this.settings);\n            }\n\n            return formatter;\n        },\n\n        getYMaxValue: function() {\n            return d3.max(this.dataTable.rows, function(d) {\n                return d[1];\n            });\n        },\n\n        getYTickValues: function() {\n            var maxValue = this.getYMaxValue();\n\n            if (maxValue > 1) {\n                return [(maxValue / 2), maxValue];\n            } else {\n                return [0, maxValue];\n            }\n        }\n    },\n    {\n        defaults: {\n            chartClass: 'area',\n            margin: {top: 25, right: 5, bottom: 25, left: 0},\n            plots: true,\n            tips: true,\n            xAxis: {\n                gridlines: false,\n                showAxis: true,\n                formatter: $.noop\n            },\n            yAxis: {\n                gridlines: true,\n                showAxis: false,\n                formatter: $.noop\n            }\n        }\n    });\n\n// ---------------------------------------------------------------------\n\n/**\n * Class Craft.charts.Utils\n */\nCraft.charts.utils = {\n\n    getDuration: function(seconds) {\n        var secondsNum = parseInt(seconds, 10);\n\n        var duration = {\n            hours: (Math.floor(secondsNum / 3600)),\n            minutes: (Math.floor((secondsNum - (duration.hours * 3600)) / 60)),\n            seconds: (secondsNum - (duration.hours * 3600) - (duration.minutes * 60))\n        };\n\n        if (duration.hours < 10) {\n            duration.hours = \"0\" + duration.hours;\n        }\n\n        if (duration.minutes < 10) {\n            duration.minutes = \"0\" + duration.minutes;\n        }\n\n        if (duration.seconds < 10) {\n            duration.seconds = \"0\" + duration.seconds;\n        }\n\n        return duration.hours + ':' + duration.minutes + ':' + duration.seconds;\n    },\n\n    getTimeFormatter: function(timeFormatLocale, chartSettings) {\n        switch (chartSettings.dataScale) {\n            case 'year':\n                return timeFormatLocale.format('%Y');\n\n            case 'month':\n                return timeFormatLocale.format(chartSettings.formats.shortDateFormats.month);\n\n            case 'hour':\n                return timeFormatLocale.format(chartSettings.formats.shortDateFormats.day + \" %H:00:00\");\n\n            default:\n                return timeFormatLocale.format(chartSettings.formats.shortDateFormats.day);\n        }\n    },\n\n    getNumberFormatter: function(formatLocale, type, chartSettings) {\n        switch (type) {\n            case 'currency':\n                return formatLocale.format(chartSettings.formats.currencyFormat);\n\n            case 'percent':\n                return formatLocale.format(chartSettings.formats.percentFormat);\n\n            case 'time':\n                return Craft.charts.utils.getDuration;\n\n            case 'number':\n                return formatLocale.format(chartSettings.formats.numberFormat);\n        }\n    }\n};\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Color input\n */\nCraft.ColorInput = Garnish.Base.extend({\n    $container: null,\n    $input: null,\n    $colorContainer: null,\n    $colorPreview: null,\n    $colorInput: null,\n\n    init: function(container) {\n        this.$container = $(container);\n        this.$input = this.$container.children('.color-input');\n        this.$colorContainer = this.$container.children('.color');\n        this.$colorPreview = this.$colorContainer.children('.color-preview');\n\n        this.createColorInput();\n        this.handleTextChange();\n\n        this.addListener(this.$input, 'textchange', 'handleTextChange');\n    },\n\n    createColorInput: function() {\n        var input = document.createElement('input');\n        input.setAttribute('type', 'color');\n\n        if (input.type !== 'color') {\n            // The browser doesn't support input[type=color]\n            return;\n        }\n\n        this.$colorContainer.removeClass('static');\n        this.$colorInput = $(input)\n            .addClass('hidden')\n            .insertAfter(this.$input);\n\n        this.addListener(this.$colorContainer, 'click', function() {\n            this.$colorInput.trigger('click');\n        });\n\n        this.addListener(this.$colorInput, 'change', 'updateColor');\n    },\n\n    updateColor: function() {\n        this.$input.val(this.$colorInput.val());\n        this.$input.data('garnish-textchange-value', this.$colorInput.val());\n        this.handleTextChange();\n    },\n\n    handleTextChange: function() {\n        var val = this.$input.val();\n\n        // If empty, set the preview to transparent\n        if (!val.length || val === '#') {\n            this.$colorPreview.css('background-color', '');\n            return;\n        }\n\n        // Make sure the value starts with a #\n        if (val[0] !== '#') {\n            val = '#'+val;\n            this.$input.val(val);\n            this.$input.data('garnish-textchange-value', val);\n        }\n\n        this.$colorPreview.css('background-color', val);\n\n        if (this.$colorInput) {\n            this.$colorInput.val(val);\n        }\n    }\n}, {\n    _browserSupportsColorInputs: null,\n\n    doesBrowserSupportColorInputs: function()\n    {\n        if (Craft.ColorInput._browserSupportsColorInputs === null)\n        {\n\n        }\n\n        return Craft.ColorInput._browserSupportsColorInputs;\n    }\n});\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * CP class\n */\nCraft.CP = Garnish.Base.extend(\n    {\n        authManager: null,\n\n        $nav: null,\n        $mainContainer: null,\n        $alerts: null,\n        $crumbs: null,\n        $notificationContainer: null,\n        $main: null,\n        $primaryForm: null,\n        $header: null,\n        $mainContent: null,\n        $details: null,\n        $selectedTab: null,\n        $sidebar: null,\n        $contentContainer: null,\n        $edition: null,\n\n        $collapsibleTables: null,\n\n        fixedHeader: false,\n\n        enableQueue: true,\n        jobInfo: null,\n        displayedJobInfo: null,\n        displayedJobInfoUnchanged: 1,\n        trackJobProgressTimeout: null,\n        jobProgressIcon: null,\n\n        checkingForUpdates: false,\n        forcingRefreshOnUpdatesCheck: false,\n        checkForUpdatesCallbacks: null,\n\n        init: function() {\n            // Is this session going to expire?\n            if (Craft.remainingSessionTime !== 0) {\n                this.authManager = new Craft.AuthManager();\n            }\n\n            // Find all the key elements\n            this.$nav = $('#nav');\n            this.$mainContainer = $('#main-container');\n            this.$alerts = $('#alerts');\n            this.$crumbs = $('#crumbs');\n            this.$notificationContainer = $('#notifications');\n            this.$main = $('#main');\n            this.$primaryForm = $('#main-form');\n            this.$header = $('#header');\n            this.$mainContent = $('#main-content');\n            this.$details = $('#details');\n            this.$sidebar = $('#sidebar');\n            this.$contentContainer = $('#content-container');\n            this.$collapsibleTables = $('table.collapsible');\n            this.$edition = $('#edition');\n\n            this.updateSidebarMenuLabel();\n\n            this.addListener(Garnish.$win, 'scroll', 'updateFixedHeader');\n            this.updateFixedHeader();\n\n            Garnish.$doc.ready($.proxy(function() {\n                // Update responsive tables on window resize\n                this.addListener(Garnish.$win, 'resize', 'updateResponsiveTables');\n                this.updateResponsiveTables();\n\n                // Fade the notification out two seconds after page load\n                var $errorNotifications = this.$notificationContainer.children('.error'),\n                    $otherNotifications = this.$notificationContainer.children(':not(.error)');\n\n                $errorNotifications.delay(Craft.CP.notificationDuration * 2).velocity('fadeOut');\n                $otherNotifications.delay(Craft.CP.notificationDuration).velocity('fadeOut');\n\n                // Wait a frame before initializing any confirm-unload forms,\n                // so other JS that runs on ready() has a chance to initialize\n                Garnish.requestAnimationFrame($.proxy(this, 'initConfirmUnloadForms'));\n            }, this));\n\n            // Alerts\n            if (this.$alerts.length) {\n                this.initAlerts();\n            }\n\n            // Toggles\n            this.addListener($('#nav-toggle'), 'click', 'toggleNav');\n            this.addListener($('#sidebar-toggle'), 'click', 'toggleSidebar');\n\n            // Does this page have a primary form?\n            if (!this.$primaryForm.length) {\n                this.$primaryForm = $('form[data-saveshortcut]:first');\n            }\n\n            // Does the primary form support the save shortcut?\n            if (this.$primaryForm.length && Garnish.hasAttr(this.$primaryForm, 'data-saveshortcut')) {\n                this.addListener(Garnish.$doc, 'keydown', function(ev) {\n                    if (Garnish.isCtrlKeyPressed(ev) && ev.keyCode === Garnish.S_KEY) {\n                        ev.preventDefault();\n                        this.submitPrimaryForm();\n                    }\n\n                    return true;\n                });\n            }\n\n            this.initTabs();\n\n            if (this.$edition.hasClass('hot')) {\n                this.addListener(this.$edition, 'click', function() {\n                    document.location.href = Craft.getUrl('plugin-store/upgrade-craft');\n                });\n            }\n\n            if ($.isTouchCapable()) {\n                this.$mainContainer.on('focus', 'input, textarea, .focusable-input', $.proxy(this, '_handleInputFocus'));\n                this.$mainContainer.on('blur', 'input, textarea, .focusable-input', $.proxy(this, '_handleInputBlur'));\n            }\n\n            // Open outbound links in new windows\n            // hat tip: https://stackoverflow.com/a/2911045/1688568\n            $('a').each(function() {\n                if (this.hostname.length && this.hostname !== location.hostname && typeof $(this).attr('target') === 'undefined') {\n                    $(this).attr('rel', 'noopener').attr('target', '_blank')\n                }\n            });\n        },\n\n        initConfirmUnloadForms: function() {\n            // Look for forms that we should watch for changes on\n            this.$confirmUnloadForms = $('form[data-confirm-unload]');\n\n            if (!this.$confirmUnloadForms.length) {\n                return;\n            }\n\n            var $form, serialized;\n\n            for (var i = 0; i < this.$confirmUnloadForms.length; i++) {\n                $form = this.$confirmUnloadForms.eq(i);\n                if (!$form.data('initialSerializedValue')) {\n                    if (typeof $form.data('serializer') === 'function') {\n                        serialized = $form.data('serializer')();\n                    } else {\n                        serialized = $form.serialize();\n                    }\n                    $form.data('initialSerializedValue', serialized);\n                }\n                this.addListener($form, 'submit', function() {\n                    this.removeListener(Garnish.$win, 'beforeunload');\n                });\n            }\n\n            this.addListener(Garnish.$win, 'beforeunload', function(ev) {\n                var confirmUnload = false;\n                var $form, serialized;\n                if (typeof Craft.livePreview !== 'undefined' && Craft.livePreview.inPreviewMode) {\n                    confirmUnload = true;\n                } else {\n                    for (var i = 0; i < this.$confirmUnloadForms.length; i++) {\n                        $form = this.$confirmUnloadForms.eq(i);\n                        if (typeof $form.data('serializer') === 'function') {\n                            serialized = $form.data('serializer')();\n                        } else {\n                            serialized = $form.serialize();\n                        }\n                        if ($form.data('initialSerializedValue') !== serialized) {\n                            confirmUnload = true;\n                            break;\n                        }\n                    }\n                }\n\n                if (confirmUnload) {\n                    var message = Craft.t('app', 'Any changes will be lost if you leave this page.');\n\n                    if (ev) {\n                        ev.originalEvent.returnValue = message;\n                    }\n                    else {\n                        window.event.returnValue = message;\n                    }\n\n                    return message;\n                }\n            });\n        },\n\n        _handleInputFocus: function() {\n            this.updateFixedHeader();\n        },\n\n        _handleInputBlur: function() {\n            this.updateFixedHeader();\n        },\n\n        submitPrimaryForm: function() {\n            // Give other stuff on the page a chance to prepare\n            this.trigger('beforeSaveShortcut');\n\n            if (this.$primaryForm.data('saveshortcut-redirect')) {\n                $('<input type=\"hidden\" name=\"redirect\" value=\"' + this.$primaryForm.data('saveshortcut-redirect') + '\"/>').appendTo(this.$primaryForm);\n            }\n\n            this.$primaryForm.trigger({\n                type: 'submit',\n                saveShortcut: true,\n            });\n        },\n\n        updateSidebarMenuLabel: function() {\n            var $item = this.$sidebar.find('a.sel:first');\n            var $label = $item.children('.label');\n            $('#selected-sidebar-item-label').text($label.length ? $label.text() : $item.text());\n            Garnish.$bod.removeClass('showing-sidebar');\n        },\n\n        toggleNav: function() {\n            Garnish.$bod.toggleClass('showing-nav');\n        },\n\n        toggleSidebar: function() {\n            Garnish.$bod.toggleClass('showing-sidebar');\n        },\n\n        initTabs: function() {\n            this.$selectedTab = null;\n\n            var $tabs = $('#tabs').find('> ul > li');\n            var tabs = [];\n            var tabWidths = [];\n            var totalWidth = 0;\n            var i, a, href;\n\n            for (i = 0; i < $tabs.length; i++) {\n                tabs[i] = $($tabs[i]);\n                tabWidths[i] = tabs[i].width();\n                totalWidth += tabWidths[i];\n\n                // Does it link to an anchor?\n                a = tabs[i].children('a');\n                href = a.attr('href');\n                if (href && href.charAt(0) === '#') {\n                    this.addListener(a, 'click', function(ev) {\n                        ev.preventDefault();\n                        this.selectTab(ev.currentTarget);\n                    });\n\n                    if (encodeURIComponent(href.substr(1)) === document.location.hash.substr(1)) {\n                        this.selectTab(a);\n                    }\n                }\n\n                if (!this.$selectedTab && a.hasClass('sel')) {\n                    this.$selectedTab = a;\n                }\n            }\n\n            // Now set their max widths\n            for (i = 0; i < $tabs.length; i++) {\n                tabs[i].css('max-width', (100 * tabWidths[i] / totalWidth) + '%');\n            }\n        },\n\n        selectTab: function(tab) {\n            var $tab = $(tab);\n\n            if (this.$selectedTab) {\n                if (this.$selectedTab.get(0) === $tab.get(0)) {\n                    return;\n                }\n                this.deselectTab();\n            }\n\n            $tab.addClass('sel');\n            var href = $tab.attr('href')\n            $(href).removeClass('hidden');\n            if (typeof history !== 'undefined') {\n                history.replaceState(undefined, undefined, href);\n            }\n            Garnish.$win.trigger('resize');\n            // Fixes Redactor fixed toolbars on previously hidden panes\n            Garnish.$doc.trigger('scroll');\n            this.$selectedTab = $tab;\n        },\n\n        deselectTab: function() {\n            if (!this.$selectedTab) {\n                return;\n            }\n\n            this.$selectedTab.removeClass('sel');\n            if (this.$selectedTab.attr('href').charAt(0) === '#') {\n                $(this.$selectedTab.attr('href')).addClass('hidden');\n            }\n            this.$selectedTab = null;\n        },\n\n        updateResponsiveTables: function() {\n            for (this.updateResponsiveTables._i = 0; this.updateResponsiveTables._i < this.$collapsibleTables.length; this.updateResponsiveTables._i++) {\n                this.updateResponsiveTables._$table = this.$collapsibleTables.eq(this.updateResponsiveTables._i);\n                this.updateResponsiveTables._containerWidth = this.updateResponsiveTables._$table.parent().width();\n                this.updateResponsiveTables._check = false;\n\n                if (this.updateResponsiveTables._containerWidth > 0) {\n                    // Is this the first time we've checked this table?\n                    if (typeof this.updateResponsiveTables._$table.data('lastContainerWidth') === 'undefined') {\n                        this.updateResponsiveTables._check = true;\n                    }\n                    else {\n                        this.updateResponsiveTables._isCollapsed = this.updateResponsiveTables._$table.hasClass('collapsed');\n\n                        // Getting wider?\n                        if (this.updateResponsiveTables._containerWidth > this.updateResponsiveTables._$table.data('lastContainerWidth')) {\n                            if (this.updateResponsiveTables._isCollapsed) {\n                                this.updateResponsiveTables._$table.removeClass('collapsed');\n                                this.updateResponsiveTables._check = true;\n                            }\n                        }\n                        else if (!this.updateResponsiveTables._isCollapsed) {\n                            this.updateResponsiveTables._check = true;\n                        }\n                    }\n\n                    // Are we checking the table width?\n                    if (this.updateResponsiveTables._check) {\n                        if (this.updateResponsiveTables._$table.width() > this.updateResponsiveTables._containerWidth) {\n                            this.updateResponsiveTables._$table.addClass('collapsed');\n                        }\n                    }\n\n                    // Remember the container width for next time\n                    this.updateResponsiveTables._$table.data('lastContainerWidth', this.updateResponsiveTables._containerWidth);\n                }\n            }\n        },\n\n        updateFixedHeader: function() {\n            // Have we scrolled passed the top of #main?\n            if (this.$main.length && this.$main[0].getBoundingClientRect().top < 0) {\n                if (!this.fixedHeader) {\n                    var headerHeight = this.$header.outerHeight();\n                    var css = {\n                        top: headerHeight + 'px',\n                        'max-height': 'calc(100vh - ' + headerHeight + 'px)'\n                    };\n                    this.$sidebar.css(css);\n                    this.$details.css(css);\n\n                    this.$mainContent.css('margin-top', this.$header.outerHeight());\n                    Garnish.$bod.addClass('fixed-header');\n                    this.fixedheader = true;\n                }\n            }\n            else if (this.fixedheader) {\n                Garnish.$bod.removeClass('fixed-header');\n                this.$details.css({\n                    top: null,\n                    'max-height': null\n                });\n                this.$header.css('top', 0);\n                this.$mainContent.css('margin-top', 0);\n                this.fixedheader = false;\n            }\n        },\n\n        /**\n         * Dispays a notification.\n         *\n         * @param {string} type\n         * @param {string} message\n         */\n        displayNotification: function(type, message) {\n            var notificationDuration = Craft.CP.notificationDuration;\n\n            if (type === 'error') {\n                notificationDuration *= 2;\n            }\n\n            var $notification = $('<div class=\"notification ' + type + '\">' + message + '</div>')\n                .appendTo(this.$notificationContainer);\n\n            var fadedMargin = -($notification.outerWidth() / 2) + 'px';\n\n            $notification\n                .hide()\n                .css({opacity: 0, 'margin-left': fadedMargin, 'margin-right': fadedMargin})\n                .velocity({opacity: 1, 'margin-left': '2px', 'margin-right': '2px'}, {display: 'inline-block', duration: 'fast'})\n                .delay(notificationDuration)\n                .velocity({opacity: 0, 'margin-left': fadedMargin, 'margin-right': fadedMargin}, {\n                    complete: function() {\n                        $notification.remove();\n                    }\n                });\n\n            this.trigger('displayNotification', {\n                notificationType: type,\n                message: message\n            });\n        },\n\n        /**\n         * Displays a notice.\n         *\n         * @param {string} message\n         */\n        displayNotice: function(message) {\n            this.displayNotification('notice', message);\n        },\n\n        /**\n         * Displays an error.\n         *\n         * @param {string} message\n         */\n        displayError: function(message) {\n            if (!message) {\n                message = Craft.t('app', 'An unknown error occurred.');\n            }\n\n            this.displayNotification('error', message);\n        },\n\n        fetchAlerts: function() {\n            var data = {\n                path: Craft.path\n            };\n\n            Craft.queueActionRequest('app/get-cp-alerts', data, $.proxy(this, 'displayAlerts'));\n        },\n\n        displayAlerts: function(alerts) {\n            this.$alerts.remove();\n\n            if (Garnish.isArray(alerts) && alerts.length) {\n                this.$alerts = $('<ul id=\"alerts\"/>').prependTo(this.$mainContainer);\n\n                for (var i = 0; i < alerts.length; i++) {\n                    $('<li>' + alerts[i] + '</li>').appendTo(this.$alerts);\n                }\n\n                var height = this.$alerts.outerHeight();\n                this.$alerts.css('margin-top', -height).velocity({'margin-top': 0}, 'fast');\n\n                this.initAlerts();\n            }\n        },\n\n        initAlerts: function() {\n            // Are there any shunnable alerts?\n            var $shunnableAlerts = this.$alerts.find('a[class^=\"shun:\"]');\n\n            for (var i = 0; i < $shunnableAlerts.length; i++) {\n                this.addListener($shunnableAlerts[i], 'click', $.proxy(function(ev) {\n                    ev.preventDefault();\n\n                    var $link = $(ev.currentTarget);\n\n                    var data = {\n                        message: $link.prop('className').substr(5)\n                    };\n\n                    Craft.queueActionRequest('app/shun-cp-alert', data, $.proxy(function(response, textStatus) {\n                        if (textStatus === 'success') {\n                            if (response.success) {\n                                $link.parent().remove();\n                            }\n                            else {\n                                this.displayError(response.error);\n                            }\n                        }\n\n                    }, this));\n\n                }, this));\n            }\n        },\n\n        checkForUpdates: function(forceRefresh, callback) {\n            // If forceRefresh == true, we're currently checking for updates, and not currently forcing a refresh,\n            // then just set a new callback that re-checks for updates when the current one is done.\n            if (this.checkingForUpdates && forceRefresh === true && !this.forcingRefreshOnUpdatesCheck) {\n                var realCallback = callback;\n\n                callback = function() {\n                    Craft.cp.checkForUpdates(true, realCallback);\n                };\n            }\n\n            // Callback function?\n            if (typeof callback === 'function') {\n                if (!Garnish.isArray(this.checkForUpdatesCallbacks)) {\n                    this.checkForUpdatesCallbacks = [];\n                }\n\n                this.checkForUpdatesCallbacks.push(callback);\n            }\n\n            if (!this.checkingForUpdates) {\n                this.checkingForUpdates = true;\n                this.forcingRefreshOnUpdatesCheck = (forceRefresh === true);\n\n                var data = {\n                    forceRefresh: (forceRefresh === true)\n                };\n\n                Craft.queueActionRequest('app/check-for-updates', data, $.proxy(function(info) {\n                    this.updateUtilitiesBadge();\n                    this.checkingForUpdates = false;\n\n                    if (Garnish.isArray(this.checkForUpdatesCallbacks)) {\n                        var callbacks = this.checkForUpdatesCallbacks;\n                        this.checkForUpdatesCallbacks = null;\n\n                        for (var i = 0; i < callbacks.length; i++) {\n                            callbacks[i](info);\n                        }\n                    }\n\n                    this.trigger('checkForUpdates', {\n                        updateInfo: info\n                    });\n                }, this));\n            }\n        },\n\n        updateUtilitiesBadge: function() {\n            var $utilitiesLink = $('#nav-utilities').find('> a:not(.sel)');\n\n            // Ignore if there is no (non-selected) Utilities nav item\n            if (!$utilitiesLink.length) {\n                return;\n            }\n\n            Craft.queueActionRequest('app/get-utilities-badge-count', $.proxy(function(response) {\n                // Get the existing utility nav badge, if any\n                var $badge = $utilitiesLink.children('.badge');\n\n                if (response.badgeCount) {\n                    if (!$badge.length) {\n                        $badge = $('<span class=\"badge\"/>').appendTo($utilitiesLink);\n                    }\n                    $badge.text(response.badgeCount);\n                } else if ($badge.length) {\n                    $badge.remove();\n                }\n            }, this));\n        },\n\n        runQueue: function() {\n            if (!this.enableQueue) {\n                return;\n            }\n\n            if (Craft.runQueueAutomatically) {\n                Craft.queueActionRequest('queue/run', $.proxy(function(response, textStatus) {\n                    if (textStatus === 'success') {\n                        this.trackJobProgress(false, true);\n                    }\n                }, this));\n            }\n            else {\n                this.trackJobProgress(false, true);\n            }\n        },\n\n        trackJobProgress: function(delay, force) {\n            if (force && this.trackJobProgressTimeout) {\n                clearTimeout(this.trackJobProgressTimeout);\n                this.trackJobProgressTimeout = null;\n            }\n\n            // Ignore if we're already tracking jobs, or the queue is disabled\n            if (this.trackJobProgressTimeout || !this.enableQueue) {\n                return;\n            }\n\n            if (delay === true) {\n                // Determine the delay based on how long the displayed job info has remained unchanged\n                var timeout = Math.min(60000, this.displayedJobInfoUnchanged * 500);\n                this.trackJobProgressTimeout = setTimeout($.proxy(this, '_trackJobProgressInternal'), timeout);\n            } else {\n                this._trackJobProgressInternal();\n            }\n        },\n\n        _trackJobProgressInternal: function() {\n            Craft.queueActionRequest('queue/get-job-info?dontExtendSession=1', $.proxy(function(response, textStatus) {\n                if (textStatus === 'success') {\n                    this.trackJobProgressTimeout = null;\n                    this.setJobInfo(response, true);\n\n                    if (this.jobInfo.length) {\n                        // Check again after a delay\n                        this.trackJobProgress(true);\n                    }\n                }\n            }, this));\n        },\n\n        setJobInfo: function(jobInfo, animateIcon) {\n            if (!this.enableQueue) {\n                return;\n            }\n\n            this.jobInfo = jobInfo;\n\n            // Update the displayed job info\n            var oldInfo = this.displayedJobInfo;\n            this.displayedJobInfo = this.getDisplayedJobInfo();\n\n            // Same old same old?\n            if (\n                oldInfo &&\n                this.displayedJobInfo &&\n                oldInfo.id === this.displayedJobInfo.id &&\n                oldInfo.progress === this.displayedJobInfo.progress &&\n                oldInfo.progressLabel === this.displayedJobInfo.progressLabel &&\n                oldInfo.status === this.displayedJobInfo.status\n            ) {\n                this.displayedJobInfoUnchanged++;\n            } else {\n                // Reset the counter\n                this.displayedJobInfoUnchanged = 1;\n            }\n\n            this.updateJobIcon(animateIcon);\n\n            // Fire a setJobInfo event\n            this.trigger('setJobInfo');\n        },\n\n        /**\n         * Returns info for the job that should be displayed in the CP sidebar\n         */\n        getDisplayedJobInfo: function() {\n            if (!this.enableQueue) {\n                return null;\n            }\n\n            // Set the status preference order\n            var statuses = [\n                Craft.CP.JOB_STATUS_RESERVED,\n                Craft.CP.JOB_STATUS_FAILED,\n                Craft.CP.JOB_STATUS_WAITING\n            ];\n\n            for (var i = 0; i < statuses.length; i++) {\n                for (var j = 0; j < this.jobInfo.length; j++) {\n                    if (this.jobInfo[j].status === statuses[i]) {\n                        return this.jobInfo[j];\n                    }\n                }\n            }\n        },\n\n        updateJobIcon: function(animate) {\n            if (!this.enableQueue || !this.$nav.length) {\n                return;\n            }\n\n            if (this.displayedJobInfo) {\n                if (!this.jobProgressIcon) {\n                    this.jobProgressIcon = new JobProgressIcon();\n                }\n\n                if (this.displayedJobInfo.status === Craft.CP.JOB_STATUS_RESERVED || this.displayedJobInfo.status === Craft.CP.JOB_STATUS_WAITING) {\n                    this.jobProgressIcon.hideFailMode();\n                    this.jobProgressIcon.setDescription(this.displayedJobInfo.description);\n                    this.jobProgressIcon.setProgress(this.displayedJobInfo.progress, animate);\n                }\n                else if (this.displayedJobInfo.status === Craft.CP.JOB_STATUS_FAILED) {\n                    this.jobProgressIcon.showFailMode(Craft.t('app', 'Failed'));\n                }\n            }\n            else {\n                if (this.jobProgressIcon) {\n                    this.jobProgressIcon.hideFailMode();\n                    this.jobProgressIcon.complete();\n                    delete this.jobProgressIcon;\n                }\n            }\n        }\n    },\n    {\n        //maxWidth: 1051, //1024,\n        notificationDuration: 2000,\n\n        JOB_STATUS_WAITING: 1,\n        JOB_STATUS_RESERVED: 2,\n        JOB_STATUS_DONE: 3,\n        JOB_STATUS_FAILED: 4\n    });\n\nGarnish.$scrollContainer = $('#content');\nCraft.cp = new Craft.CP();\n\n\n/**\n * Job progress icon class\n */\nvar JobProgressIcon = Garnish.Base.extend(\n    {\n        $li: null,\n        $a: null,\n        $label: null,\n\n        hud: null,\n        failMode: false,\n\n        _canvasSupported: null,\n\n        _$bgCanvas: null,\n        _$staticCanvas: null,\n        _$hoverCanvas: null,\n        _$failCanvas: null,\n\n        _staticCtx: null,\n        _hoverCtx: null,\n        _canvasSize: null,\n        _arcPos: null,\n        _arcRadius: null,\n        _lineWidth: null,\n\n        _arcStartPos: 0,\n        _arcEndPos: 0,\n        _arcStartStepSize: null,\n        _arcEndStepSize: null,\n        _arcStep: null,\n        _arcStepTimeout: null,\n        _arcAnimateCallback: null,\n\n        _progressBar: null,\n\n        init: function() {\n            this.$li = $('<li/>').appendTo(Craft.cp.$nav.children('ul'));\n            this.$a = $('<a id=\"job-icon\"/>').appendTo(this.$li);\n            this.$canvasContainer = $('<span class=\"icon\"/>').appendTo(this.$a);\n            this.$label = $('<span class=\"label\"></span>').appendTo(this.$a);\n\n            this._canvasSupported = !!(document.createElement('canvas').getContext);\n\n            if (this._canvasSupported) {\n                var m = (window.devicePixelRatio > 1 ? 2 : 1);\n                this._canvasSize = 18 * m;\n                this._arcPos = this._canvasSize / 2;\n                this._arcRadius = 7 * m;\n                this._lineWidth = 3 * m;\n\n                this._$bgCanvas = this._createCanvas('bg', '#61666b');\n                this._$staticCanvas = this._createCanvas('static', '#d7d9db');\n                this._$hoverCanvas = this._createCanvas('hover', '#fff');\n                this._$failCanvas = this._createCanvas('fail', '#da5a47').hide();\n\n                this._staticCtx = this._$staticCanvas[0].getContext('2d');\n                this._hoverCtx = this._$hoverCanvas[0].getContext('2d');\n\n                this._drawArc(this._$bgCanvas[0].getContext('2d'), 0, 1);\n                this._drawArc(this._$failCanvas[0].getContext('2d'), 0, 1);\n            }\n            else {\n                this._progressBar = new Craft.ProgressBar(this.$canvasContainer);\n                this._progressBar.showProgressBar();\n            }\n\n            this.addListener(this.$a, 'click', 'toggleHud');\n        },\n\n        setDescription: function(description) {\n            this.$a.attr('title', description);\n            this.$label.text(description);\n        },\n\n        setProgress: function(progress, animate) {\n            if (this._canvasSupported) {\n                if (animate) {\n                    this._animateArc(0, progress / 100);\n                }\n                else {\n                    this._setArc(0, progress / 100);\n                }\n            }\n            else {\n                this._progressBar.setProgressPercentage(progress);\n            }\n        },\n\n        complete: function() {\n            if (this._canvasSupported) {\n                this._animateArc(0, 1, $.proxy(function() {\n                    this._$bgCanvas.velocity('fadeOut');\n\n                    this._animateArc(1, 1, $.proxy(function() {\n                        this.$a.remove();\n                        this.destroy();\n                    }, this));\n                }, this));\n            }\n            else {\n                this._progressBar.setProgressPercentage(100);\n                this.$a.velocity('fadeOut');\n            }\n        },\n\n        showFailMode: function(message) {\n            if (this.failMode) {\n                return;\n            }\n\n            this.failMode = true;\n\n            if (this._canvasSupported) {\n                this._$bgCanvas.hide();\n                this._$staticCanvas.hide();\n                this._$hoverCanvas.hide();\n                this._$failCanvas.show();\n            }\n            else {\n                this._progressBar.$progressBar.css('border-color', '#da5a47');\n                this._progressBar.$innerProgressBar.css('background-color', '#da5a47');\n                this._progressBar.setProgressPercentage(50);\n            }\n\n            this.setDescription(message);\n        },\n\n        hideFailMode: function() {\n            if (!this.failMode) {\n                return;\n            }\n\n            this.failMode = false;\n\n            if (this._canvasSupported) {\n                this._$bgCanvas.show();\n                this._$staticCanvas.show();\n                this._$hoverCanvas.show();\n                this._$failCanvas.hide();\n            }\n            else {\n                this._progressBar.$progressBar.css('border-color', '');\n                this._progressBar.$innerProgressBar.css('background-color', '');\n                this._progressBar.setProgressPercentage(50);\n            }\n        },\n\n        toggleHud: function() {\n            if (!this.hud) {\n                this.hud = new QueueHUD();\n            }\n            else {\n                this.hud.toggle();\n            }\n        },\n\n        _createCanvas: function(id, color) {\n            var $canvas = $('<canvas id=\"job-icon-' + id + '\" width=\"' + this._canvasSize + '\" height=\"' + this._canvasSize + '\"/>').appendTo(this.$canvasContainer),\n                ctx = $canvas[0].getContext('2d');\n\n            ctx.strokeStyle = color;\n            ctx.lineWidth = this._lineWidth;\n            ctx.lineCap = 'round';\n            return $canvas;\n        },\n\n        _setArc: function(startPos, endPos) {\n            this._arcStartPos = startPos;\n            this._arcEndPos = endPos;\n\n            this._drawArc(this._staticCtx, startPos, endPos);\n            this._drawArc(this._hoverCtx, startPos, endPos);\n        },\n\n        _drawArc: function(ctx, startPos, endPos) {\n            ctx.clearRect(0, 0, this._canvasSize, this._canvasSize);\n            ctx.beginPath();\n            ctx.arc(this._arcPos, this._arcPos, this._arcRadius, (1.5 + (startPos * 2)) * Math.PI, (1.5 + (endPos * 2)) * Math.PI);\n            ctx.stroke();\n            ctx.closePath();\n        },\n\n        _animateArc: function(targetStartPos, targetEndPos, callback) {\n            if (this._arcStepTimeout) {\n                clearTimeout(this._arcStepTimeout);\n            }\n\n            this._arcStep = 0;\n            this._arcStartStepSize = (targetStartPos - this._arcStartPos) / 10;\n            this._arcEndStepSize = (targetEndPos - this._arcEndPos) / 10;\n            this._arcAnimateCallback = callback;\n            this._takeNextArcStep();\n        },\n\n        _takeNextArcStep: function() {\n            this._setArc(this._arcStartPos + this._arcStartStepSize, this._arcEndPos + this._arcEndStepSize);\n\n            this._arcStep++;\n\n            if (this._arcStep < 10) {\n                this._arcStepTimeout = setTimeout($.proxy(this, '_takeNextArcStep'), 50);\n            }\n            else if (this._arcAnimateCallback) {\n                this._arcAnimateCallback();\n            }\n        }\n    });\n\nvar QueueHUD = Garnish.HUD.extend(\n    {\n        jobsById: null,\n        completedJobs: null,\n        updateViewProxy: null,\n\n        init: function() {\n            this.jobsById = {};\n            this.completedJobs = [];\n            this.updateViewProxy = $.proxy(this, 'updateView');\n\n            this.base(Craft.cp.jobProgressIcon.$a);\n\n            this.$main.attr('id', 'queue-hud');\n        },\n\n        onShow: function() {\n            Craft.cp.on('setJobInfo', this.updateViewProxy);\n            this.updateView();\n            this.base();\n        },\n\n        onHide: function() {\n            Craft.cp.off('setJobInfo', this.updateViewProxy);\n\n            // Clear out any completed jobs\n            if (this.completedJobs.length) {\n                for (var i = 0; i < this.completedJobs.length; i++) {\n                    this.completedJobs[i].destroy();\n                }\n\n                this.completedJobs = [];\n            }\n\n            this.base();\n        },\n\n        updateView: function() {\n            // First remove any jobs that have completed\n            var newJobIds = [];\n\n            var i;\n\n            if (Craft.cp.jobInfo) {\n                for (i = 0; i < Craft.cp.jobInfo.length; i++) {\n                    newJobIds.push(parseInt(Craft.cp.jobInfo[i].id));\n                }\n            }\n\n            for (var id in this.jobsById) {\n                if (!this.jobsById.hasOwnProperty(id)) {\n                    continue;\n                }\n                if (!Craft.inArray(parseInt(id), newJobIds)) {\n                    this.jobsById[id].complete();\n                    this.completedJobs.push(this.jobsById[id]);\n                    delete this.jobsById[id];\n                }\n            }\n\n            // Now display the jobs that are still around\n            if (Craft.cp.jobInfo && Craft.cp.jobInfo.length) {\n                for (i = 0; i < Craft.cp.jobInfo.length; i++) {\n                    var info = Craft.cp.jobInfo[i];\n\n                    if (this.jobsById[info.id]) {\n                        this.jobsById[info.id].updateStatus(info);\n                    }\n                    else {\n                        this.jobsById[info.id] = new QueueHUD.Job(this, info);\n\n                        // Place it before the next already known job\n                        var placed = false;\n                        for (var j = i + 1; j < Craft.cp.jobInfo.length; j++) {\n                            if (this.jobsById[Craft.cp.jobInfo[j].id]) {\n                                this.jobsById[info.id].$container.insertBefore(this.jobsById[Craft.cp.jobInfo[j].id].$container);\n                                placed = true;\n                                break;\n                            }\n                        }\n\n                        if (!placed) {\n                            // Place it before the resize <object> if there is one\n                            var $object = this.$main.children('object');\n                            if ($object.length) {\n                                this.jobsById[info.id].$container.insertBefore($object);\n                            }\n                            else {\n                                this.jobsById[info.id].$container.appendTo(this.$main);\n                            }\n                        }\n                    }\n                }\n            }\n            else {\n                this.hide();\n            }\n        }\n    });\n\nQueueHUD.Job = Garnish.Base.extend(\n    {\n        hud: null,\n        id: null,\n        description: null,\n\n        status: null,\n        progress: null,\n\n        $container: null,\n        $statusContainer: null,\n        $descriptionContainer: null,\n        $progressLabel: null,\n\n        _progressBar: null,\n\n        init: function(hud, info) {\n            this.hud = hud;\n\n            this.id = info.id;\n            this.description = info.description;\n\n            this.$container = $('<div/>', { 'class': 'job' });\n            var $flex = $('<div/>', { 'class': 'flex' }).appendTo(this.$container);\n            $('<div/>', { 'class': 'flex-grow' }).text(info.description).appendTo($flex);\n            this.$statusContainer = $('<div class=\"job-status\"/>').appendTo($flex);\n\n            this.$container.data('job', this);\n\n            this.updateStatus(info);\n        },\n\n        updateStatus: function(info) {\n            if (this.status !== (this.status = info.status)) {\n                this.$statusContainer.empty();\n\n                switch (this.status) {\n                    case Craft.CP.JOB_STATUS_WAITING: {\n                        this.$statusContainer.text(Craft.t('app', 'Pending'));\n                        break;\n                    }\n                    case Craft.CP.JOB_STATUS_RESERVED: {\n                        this._progressBar = new Craft.ProgressBar(this.$statusContainer);\n                        this._progressBar.showProgressBar();\n                        break;\n                    }\n                    case Craft.CP.JOB_STATUS_FAILED: {\n                        $('<span/>', {\n                            'class': 'error',\n                            text: Craft.t('app', 'Failed'),\n                            title: info.error\n                        }).appendTo(this.$statusContainer);\n\n                        var $actionBtn = $('<a class=\"menubtn error\" title=\"' + Craft.t('app', 'Options') + '\"/>').appendTo(this.$statusContainer);\n                        $(\n                            '<div class=\"menu\">' +\n                            '<ul>' +\n                            '<li><a data-action=\"retry\">' + Craft.t('app', 'Try again') + '</a></li>' +\n                            '<li><a data-action=\"release\">' + Craft.t('app', 'Cancel') + '</a></li>' +\n                            '</ul>' +\n                            '</div>'\n                        ).appendTo(this.$statusContainer);\n\n                        new Garnish.MenuBtn($actionBtn, {\n                            onOptionSelect: $.proxy(this, 'performErrorAction')\n                        });\n\n                        break;\n                    }\n                }\n            }\n\n            if (this.status === Craft.CP.JOB_STATUS_RESERVED) {\n                this._progressBar.setProgressPercentage(info.progress);\n\n                if (info.progressLabel) {\n                    if (!this.$progressLabel) {\n                        this.$progressLabel = $('<div class=\"light smalltext\"/>').appendTo(this.$container);\n                    }\n                    this.$progressLabel.text(info.progressLabel);\n                }\n            } else if (this.$progressLabel) {\n                this.$progressLabel.remove();\n                this.$progressLabel = null;\n            }\n        },\n\n        performErrorAction: function(option) {\n            // What option did they choose?\n            switch ($(option).data('action')) {\n                case 'retry': {\n                    // Update the icon\n                    Craft.cp.displayedJobInfo.status = Craft.CP.JOB_STATUS_WAITING;\n                    Craft.cp.displayedJobInfo.progress = 0;\n                    Craft.cp.updateJobIcon(false);\n\n                    Craft.postActionRequest('queue/retry', {id: this.id}, $.proxy(function(response, textStatus) {\n                        if (textStatus === 'success') {\n                            Craft.cp.trackJobProgress(false, true);\n                        }\n                    }, this));\n                    break;\n                }\n                case 'release': {\n                    Craft.postActionRequest('queue/release', {id: this.id}, $.proxy(function(response, textStatus) {\n                        if (textStatus === 'success') {\n                            Craft.cp.trackJobProgress(false, true);\n                        }\n                    }, this));\n                }\n            }\n        },\n\n        complete: function() {\n            this.$statusContainer.empty();\n            $('<div data-icon=\"check\"/>').appendTo(this.$statusContainer);\n        },\n\n        destroy: function() {\n            if (this.hud.jobsById[this.id]) {\n                delete this.hud.jobsById[this.id];\n            }\n\n            this.$container.remove();\n            this.base();\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Customize Sources modal\n */\nCraft.CustomizeSourcesModal = Garnish.Modal.extend(\n    {\n        elementIndex: null,\n        $elementIndexSourcesContainer: null,\n\n        $sidebar: null,\n        $sourcesContainer: null,\n        $sourceSettingsContainer: null,\n        $newHeadingBtn: null,\n        $footer: null,\n        $footerBtnContainer: null,\n        $saveBtn: null,\n        $cancelBtn: null,\n        $saveSpinner: null,\n        $loadingSpinner: null,\n\n        sourceSort: null,\n        sources: null,\n        selectedSource: null,\n        updateSourcesOnSave: false,\n\n        availableTableAttributes: null,\n\n        init: function(elementIndex, settings) {\n            this.base();\n\n            this.setSettings(settings, {\n                resizable: true\n            });\n\n            this.elementIndex = elementIndex;\n            this.$elementIndexSourcesContainer = this.elementIndex.$sidebar.children('nav').children('ul');\n\n            var $container = $('<form class=\"modal customize-sources-modal\"/>').appendTo(Garnish.$bod);\n\n            this.$sidebar = $('<div class=\"cs-sidebar block-types\"/>').appendTo($container);\n            this.$sourcesContainer = $('<div class=\"sources\">').appendTo(this.$sidebar);\n            this.$sourceSettingsContainer = $('<div class=\"source-settings\">').appendTo($container);\n\n            this.$footer = $('<div class=\"footer\"/>').appendTo($container);\n            this.$footerBtnContainer = $('<div class=\"buttons right\"/>').appendTo(this.$footer);\n            this.$cancelBtn = $('<div class=\"btn\" role=\"button\"/>').text(Craft.t('app', 'Cancel')).appendTo(this.$footerBtnContainer);\n            this.$saveBtn = $('<div class=\"btn submit disabled\" role=\"button\"/>').text(Craft.t('app', 'Save')).appendTo(this.$footerBtnContainer);\n            this.$saveSpinner = $('<div class=\"spinner hidden\"/>').appendTo(this.$footerBtnContainer);\n            this.$newHeadingBtn = $('<div class=\"btn submit add icon\"/>').text(Craft.t('app', 'New heading')).appendTo($('<div class=\"buttons left secondary-buttons\"/>').appendTo(this.$footer));\n\n            this.$loadingSpinner = $('<div class=\"spinner\"/>').appendTo($container);\n\n            this.setContainer($container);\n            this.show();\n\n            var data = {\n                elementType: this.elementIndex.elementType\n            };\n\n            Craft.postActionRequest('element-index-settings/get-customize-sources-modal-data', data, $.proxy(function(response, textStatus) {\n                this.$loadingSpinner.remove();\n\n                if (textStatus === 'success') {\n                    this.$saveBtn.removeClass('disabled');\n                    this.buildModal(response);\n                }\n\n            }, this));\n\n            this.addListener(this.$newHeadingBtn, 'click', 'handleNewHeadingBtnClick');\n            this.addListener(this.$cancelBtn, 'click', 'hide');\n            this.addListener(this.$saveBtn, 'click', 'save');\n            this.addListener(this.$container, 'submit', 'save');\n        },\n\n        buildModal: function(response) {\n            // Store the available table attribute options\n            this.availableTableAttributes = response.availableTableAttributes;\n\n            // Create the source item sorter\n            this.sourceSort = new Garnish.DragSort({\n                handle: '.move',\n                axis: 'y',\n                onSortChange: $.proxy(function() {\n                    this.updateSourcesOnSave = true;\n                }, this)\n            });\n\n            // Create the sources\n            this.sources = [];\n\n            for (var i = 0; i < response.sources.length; i++) {\n                var source = this.addSource(response.sources[i]);\n                this.sources.push(source);\n            }\n\n            if (!this.selectedSource && typeof this.sources[0] !== 'undefined') {\n                this.sources[0].select();\n            }\n        },\n\n        addSource: function(sourceData) {\n            var $item = $('<div class=\"customize-sources-item\"/>').appendTo(this.$sourcesContainer);\n            var $itemLabel = $('<div class=\"label\"/>').appendTo($item);\n            var $itemInput = $('<input type=\"hidden\"/>').appendTo($item);\n            $('<a class=\"move icon\" title=\"' + Craft.t('app', 'Reorder') + '\" role=\"button\"></a>').appendTo($item);\n\n            var source;\n\n            // Is this a heading?\n            if (typeof sourceData.heading !== 'undefined') {\n                $item.addClass('heading');\n                $itemInput.attr('name', 'sourceOrder[][heading]');\n                source = new Craft.CustomizeSourcesModal.Heading(this, $item, $itemLabel, $itemInput, sourceData);\n                source.updateItemLabel(sourceData.heading);\n            }\n            else {\n                $itemInput.attr('name', 'sourceOrder[][key]').val(sourceData.key);\n                source = new Craft.CustomizeSourcesModal.Source(this, $item, $itemLabel, $itemInput, sourceData);\n                source.updateItemLabel(sourceData.label);\n\n                // Select this by default?\n                if ((this.elementIndex.sourceKey+'/').substr(0, sourceData.key.length+1) === sourceData.key+'/') {\n                    source.select();\n                }\n            }\n\n            this.sourceSort.addItems($item);\n\n            return source;\n        },\n\n        handleNewHeadingBtnClick: function() {\n            var source = this.addSource({\n                heading: ''\n            });\n\n            Garnish.scrollContainerToElement(this.$sidebar, source.$item);\n\n            source.select();\n            this.updateSourcesOnSave = true;\n        },\n\n        save: function(ev) {\n            if (ev) {\n                ev.preventDefault();\n            }\n\n            if (this.$saveBtn.hasClass('disabled') || !this.$saveSpinner.hasClass('hidden')) {\n                return;\n            }\n\n            this.$saveSpinner.removeClass('hidden');\n            var data = this.$container.serialize() + '&elementType=' + this.elementIndex.elementType;\n\n            Craft.postActionRequest('element-index-settings/save-customize-sources-modal-settings', data, $.proxy(function(response, textStatus) {\n                this.$saveSpinner.addClass('hidden');\n\n                if (textStatus === 'success' && response.success) {\n                    // Have any changes been made to the source list?\n                    if (this.updateSourcesOnSave) {\n                        if (this.$elementIndexSourcesContainer.length) {\n                            var $lastSource = null,\n                                $pendingHeading;\n\n                            for (var i = 0; i < this.sourceSort.$items.length; i++) {\n                                var $item = this.sourceSort.$items.eq(i),\n                                    source = $item.data('source'),\n                                    $indexSource = source.getIndexSource();\n\n                                if (!$indexSource) {\n                                    continue;\n                                }\n\n                                if (source.isHeading()) {\n                                    $pendingHeading = $indexSource;\n                                }\n                                else {\n                                    if ($pendingHeading) {\n                                        this.appendSource($pendingHeading, $lastSource);\n                                        $lastSource = $pendingHeading;\n                                        $pendingHeading = null;\n                                    }\n\n                                    this.appendSource($indexSource, $lastSource);\n                                    $lastSource = $indexSource;\n                                }\n                            }\n\n                            // Remove any additional sources (most likely just old headings)\n                            if ($lastSource) {\n                                var $extraSources = $lastSource.nextAll();\n                                this.elementIndex.sourceSelect.removeItems($extraSources);\n                                $extraSources.remove();\n                            }\n                        }\n                    }\n\n                    // If a source is selected, have the element index select that one by default on the next request\n                    if (this.selectedSource && this.selectedSource.sourceData.key) {\n                        this.elementIndex.selectSourceByKey(this.selectedSource.sourceData.key);\n                        this.elementIndex.updateElements();\n                    }\n\n                    Craft.cp.displayNotice(Craft.t('app', 'Source settings saved'));\n                    this.hide();\n                }\n                else {\n                    var error = (textStatus === 'success' && response.error ? response.error : Craft.t('app', 'An unknown error occurred.'));\n                    Craft.cp.displayError(error);\n                }\n            }, this));\n        },\n\n        appendSource: function($source, $lastSource) {\n            if (!$lastSource) {\n                $source.prependTo(this.$elementIndexSourcesContainer);\n            }\n            else {\n                $source.insertAfter($lastSource);\n            }\n        },\n\n        destroy: function() {\n            for (var i = 0; i < this.sources.length; i++) {\n                this.sources[i].destroy();\n            }\n\n            delete this.sources;\n            this.base();\n        }\n    });\n\nCraft.CustomizeSourcesModal.BaseSource = Garnish.Base.extend(\n    {\n        modal: null,\n\n        $item: null,\n        $itemLabel: null,\n        $itemInput: null,\n        $settingsContainer: null,\n\n        sourceData: null,\n\n        init: function(modal, $item, $itemLabel, $itemInput, sourceData) {\n            this.modal = modal;\n            this.$item = $item;\n            this.$itemLabel = $itemLabel;\n            this.$itemInput = $itemInput;\n            this.sourceData = sourceData;\n\n            this.$item.data('source', this);\n\n            this.addListener(this.$item, 'click', 'select');\n        },\n\n        isHeading: function() {\n            return false;\n        },\n\n        isSelected: function() {\n            return (this.modal.selectedSource === this);\n        },\n\n        select: function() {\n            if (this.isSelected()) {\n                return;\n            }\n\n            if (this.modal.selectedSource) {\n                this.modal.selectedSource.deselect();\n            }\n\n            this.$item.addClass('sel');\n            this.modal.selectedSource = this;\n\n            if (!this.$settingsContainer) {\n                this.$settingsContainer = $('<div/>')\n                    .append(this.createSettings())\n                    .appendTo(this.modal.$sourceSettingsContainer);\n            }\n            else {\n                this.$settingsContainer.removeClass('hidden');\n            }\n\n            this.modal.$sourceSettingsContainer.scrollTop(0);\n        },\n\n        createSettings: function() {\n        },\n\n        getIndexSource: function() {\n        },\n\n        deselect: function() {\n            this.$item.removeClass('sel');\n            this.modal.selectedSource = null;\n            this.$settingsContainer.addClass('hidden');\n        },\n\n        updateItemLabel: function(val) {\n            this.$itemLabel.text(val);\n        },\n\n        destroy: function() {\n            this.$item.data('source', null);\n            this.base();\n        }\n    });\n\nCraft.CustomizeSourcesModal.Source = Craft.CustomizeSourcesModal.BaseSource.extend(\n    {\n        createSettings: function() {\n            if (this.sourceData.tableAttributes.length) {\n                // Create the title column option\n                var firstAttribute = this.sourceData.tableAttributes[0],\n                    firstKey = firstAttribute[0],\n                    firstLabel = firstAttribute[1],\n                    $titleColumnCheckbox = this.createTableColumnOption(firstKey, firstLabel, true, true);\n\n                // Create the rest of the options\n                var $columnCheckboxes = $('<div/>'),\n                    selectedAttributes = [firstKey];\n\n                $('<input type=\"hidden\" name=\"sources[' + this.sourceData.key + '][tableAttributes][]\" value=\"\"/>').appendTo($columnCheckboxes);\n\n                var i, attribute, key, label;\n\n                // Add the selected columns, in the selected order\n                for (i = 1; i < this.sourceData.tableAttributes.length; i++) {\n                    attribute = this.sourceData.tableAttributes[i];\n                    key = attribute[0];\n                    label = attribute[1];\n\n                    $columnCheckboxes.append(this.createTableColumnOption(key, label, false, true));\n                    selectedAttributes.push(key);\n                }\n\n                // Add the rest\n                for (i = 0; i < this.modal.availableTableAttributes.length; i++) {\n                    attribute = this.modal.availableTableAttributes[i];\n                    key = attribute[0];\n                    label = attribute[1];\n\n                    if (!Craft.inArray(key, selectedAttributes)) {\n                        $columnCheckboxes.append(this.createTableColumnOption(key, label, false, false));\n                    }\n                }\n\n                new Garnish.DragSort($columnCheckboxes.children(), {\n                    handle: '.move',\n                    axis: 'y'\n                });\n\n                return Craft.ui.createField($([$titleColumnCheckbox[0], $columnCheckboxes[0]]), {\n                    label: Craft.t('app', 'Table Columns'),\n                    instructions: Craft.t('app', 'Choose which table columns should be visible for this source, and in which order.')\n                });\n            }\n        },\n\n        createTableColumnOption: function(key, label, first, checked) {\n            var $option = $('<div class=\"customize-sources-table-column\"/>')\n                .append('<div class=\"icon move\"/>')\n                .append(\n                    Craft.ui.createCheckbox({\n                        label: label,\n                        name: 'sources[' + this.sourceData.key + '][tableAttributes][]',\n                        value: key,\n                        checked: checked,\n                        disabled: first\n                    })\n                );\n\n            if (first) {\n                $option.children('.move').addClass('disabled');\n            }\n\n            return $option;\n        },\n\n        getIndexSource: function() {\n            var $source = this.modal.elementIndex.getSourceByKey(this.sourceData.key);\n\n            if ($source) {\n                return $source.closest('li');\n            }\n        }\n    });\n\nCraft.CustomizeSourcesModal.Heading = Craft.CustomizeSourcesModal.BaseSource.extend(\n    {\n        $labelField: null,\n        $labelInput: null,\n        $deleteBtn: null,\n\n        isHeading: function() {\n            return true;\n        },\n\n        select: function() {\n            this.base();\n            this.$labelInput.trigger('focus');\n        },\n\n        createSettings: function() {\n            this.$labelField = Craft.ui.createTextField({\n                label: Craft.t('app', 'Heading'),\n                instructions: Craft.t('app', 'This can be left blank if you just want an unlabeled separator.'),\n                value: this.sourceData.heading\n            });\n\n            this.$labelInput = this.$labelField.find('.text');\n\n            this.$deleteBtn = $('<a class=\"error delete\"/>').text(Craft.t('app', 'Delete heading'));\n\n            this.addListener(this.$labelInput, 'textchange', 'handleLabelInputChange');\n            this.addListener(this.$deleteBtn, 'click', 'deleteHeading');\n\n            return $([\n                this.$labelField[0],\n                $('<hr/>')[0],\n                this.$deleteBtn[0]\n            ]);\n        },\n\n        handleLabelInputChange: function() {\n            this.updateItemLabel(this.$labelInput.val());\n            this.modal.updateSourcesOnSave = true;\n        },\n\n        updateItemLabel: function(val) {\n            this.$itemLabel.html((val ? Craft.escapeHtml(val) : '<em class=\"light\">' + Craft.t('app', '(blank)') + '</em>') + '&nbsp;');\n            this.$itemInput.val(val);\n        },\n\n        deleteHeading: function() {\n            this.modal.sourceSort.removeItems(this.$item);\n            this.modal.sources.splice($.inArray(this, this.modal.sources), 1);\n            this.modal.updateSourcesOnSave = true;\n\n            if (this.isSelected()) {\n                this.deselect();\n\n                if (this.modal.sources.length) {\n                    this.modal.sources[0].select();\n                }\n            }\n\n            this.$item.remove();\n            this.$settingsContainer.remove();\n            this.destroy();\n        },\n\n        getIndexSource: function() {\n            var label = (this.$labelInput ? this.$labelInput.val() : this.sourceData.heading);\n            return $('<li class=\"heading\"/>').append($('<span/>').text(label));\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * DataTableSorter\n */\nCraft.DataTableSorter = Garnish.DragSort.extend(\n    {\n        $table: null,\n\n        init: function(table, settings) {\n            this.$table = $(table);\n            var $rows = this.$table.children('tbody').children(':not(.filler)');\n\n            settings = $.extend({}, Craft.DataTableSorter.defaults, settings);\n\n            settings.container = this.$table.children('tbody');\n            settings.helper = $.proxy(this, 'getHelper');\n            settings.caboose = '<tr/>';\n            settings.axis = Garnish.Y_AXIS;\n            settings.magnetStrength = 4;\n            settings.helperLagBase = 1.5;\n\n            this.base($rows, settings);\n        },\n\n        getHelper: function($helperRow) {\n            var $helper = $('<div class=\"' + this.settings.helperClass + '\"/>').appendTo(Garnish.$bod),\n                $table = $('<table/>').appendTo($helper),\n                $tbody = $('<tbody/>').appendTo($table);\n\n            $helperRow.appendTo($tbody);\n\n            // Copy the table width and classes\n            $table.width(this.$table.width());\n            $table.prop('className', this.$table.prop('className'));\n\n            // Copy the column widths\n            var $firstRow = this.$table.find('tr:first'),\n                $cells = $firstRow.children(),\n                $helperCells = $helperRow.children();\n\n            for (var i = 0; i < $helperCells.length; i++) {\n                $($helperCells[i]).width($($cells[i]).width());\n            }\n\n            return $helper;\n        }\n\n    },\n    {\n        defaults: {\n            handle: '.move',\n            helperClass: 'datatablesorthelper'\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Delete User Modal\n */\nCraft.DeleteUserModal = Garnish.Modal.extend(\n    {\n        id: null,\n        userId: null,\n\n        $deleteActionRadios: null,\n        $deleteSpinner: null,\n\n        userSelect: null,\n        _deleting: false,\n\n        init: function(userId, settings) {\n            this.id = Math.floor(Math.random() * 1000000000);\n            this.userId = userId;\n            settings = $.extend(Craft.DeleteUserModal.defaults, settings);\n\n            var $form = $(\n                    '<form class=\"modal fitted deleteusermodal\" method=\"post\" accept-charset=\"UTF-8\">' +\n                    Craft.getCsrfInput() +\n                    '<input type=\"hidden\" name=\"action\" value=\"users/delete-user\"/>' +\n                    (!Garnish.isArray(this.userId) ? '<input type=\"hidden\" name=\"userId\" value=\"' + this.userId + '\"/>' : '') +\n                    (settings.redirect ? '<input type=\"hidden\" name=\"redirect\" value=\"' + settings.redirect + '\"/>' : '') +\n                    '</form>'\n                ).appendTo(Garnish.$bod),\n                $body = $(\n                    '<div class=\"body\">' +\n                    '<div class=\"content-summary\">' +\n                    '<p>' + Craft.t('app', 'What do you want to do with their content?') + '</p>' +\n                    '<ul class=\"bullets\"></ul>' +\n                    '</div>' +\n                    '<div class=\"options\">' +\n                    '<label><input type=\"radio\" name=\"contentAction\" value=\"transfer\"/> ' + Craft.t('app', 'Transfer it to:') + '</label>' +\n                    '<div id=\"transferselect' + this.id + '\" class=\"elementselect\">' +\n                    '<div class=\"elements\"></div>' +\n                    '<div class=\"btn add icon dashed\">' + Craft.t('app', 'Choose a user') + '</div>' +\n                    '</div>' +\n                    '</div>' +\n                    '<div>' +\n                    '<label class=\"error\"><input type=\"radio\" name=\"contentAction\" value=\"delete\"/> ' + Craft.t('app', 'Delete it') + '</label>' +\n                    '</div>' +\n                    '</div>'\n                ).appendTo($form),\n                $buttons = $('<div class=\"buttons right\"/>').appendTo($body),\n                $cancelBtn = $('<div class=\"btn\">' + Craft.t('app', 'Cancel') + '</div>').appendTo($buttons);\n\n            if (settings.contentSummary.length) {\n                for (var i = 0; i < settings.contentSummary.length; i++) {\n                    $body.find('ul').append($('<li/>', { text: settings.contentSummary[i] }));\n                }\n            } else {\n                $body.find('ul').remove();\n            }\n\n            this.$deleteActionRadios = $body.find('input[type=radio]');\n            this.$deleteSubmitBtn = $('<input type=\"submit\" class=\"btn submit disabled\" value=\"' + (Garnish.isArray(this.userId) ? Craft.t('app', 'Delete users') : Craft.t('app', 'Delete user')) + '\" />').appendTo($buttons);\n            this.$deleteSpinner = $('<div class=\"spinner hidden\"/>').appendTo($buttons);\n\n            var idParam;\n\n            if (Garnish.isArray(this.userId)) {\n                idParam = ['and'];\n\n                for (var i = 0; i < this.userId.length; i++) {\n                    idParam.push('not ' + this.userId[i]);\n                }\n            }\n            else {\n                idParam = 'not ' + this.userId;\n            }\n\n            this.userSelect = new Craft.BaseElementSelectInput({\n                id: 'transferselect' + this.id,\n                name: 'transferContentTo',\n                elementType: 'craft\\\\elements\\\\User',\n                criteria: {\n                    id: idParam\n                },\n                limit: 1,\n                modalSettings: {\n                    closeOtherModals: false\n                },\n                onSelectElements: $.proxy(function() {\n                    this.updateSizeAndPosition();\n\n                    if (!this.$deleteActionRadios.first().prop('checked')) {\n                        this.$deleteActionRadios.first().trigger('click');\n                    }\n                    else {\n                        this.validateDeleteInputs();\n                    }\n                }, this),\n                onRemoveElements: $.proxy(this, 'validateDeleteInputs'),\n                selectable: false,\n                editable: false\n            });\n\n            this.addListener($cancelBtn, 'click', 'hide');\n\n            this.addListener(this.$deleteActionRadios, 'change', 'validateDeleteInputs');\n            this.addListener($form, 'submit', 'handleSubmit');\n\n            this.base($form, settings);\n        },\n\n        validateDeleteInputs: function() {\n            var validates = false;\n\n            if (this.$deleteActionRadios.eq(0).prop('checked')) {\n                validates = !!this.userSelect.totalSelected;\n            }\n            else if (this.$deleteActionRadios.eq(1).prop('checked')) {\n                validates = true;\n            }\n\n            if (validates) {\n                this.$deleteSubmitBtn.removeClass('disabled');\n            }\n            else {\n                this.$deleteSubmitBtn.addClass('disabled');\n            }\n\n            return validates;\n        },\n\n        handleSubmit: function(ev) {\n            if (this._deleting || !this.validateDeleteInputs()) {\n                ev.preventDefault();\n                return;\n            }\n\n            this.$deleteSubmitBtn.addClass('active');\n            this.$deleteSpinner.removeClass('hidden');\n            this.disable();\n            this.userSelect.disable();\n            this._deleting = true;\n\n            // Let the onSubmit callback prevent the form from getting submitted\n            if (this.settings.onSubmit() === false) {\n                ev.preventDefault();\n            }\n        },\n\n        onFadeIn: function() {\n            // Auto-focus the first radio\n            if (!Garnish.isMobileBrowser(true)) {\n                this.$deleteActionRadios.first().trigger('focus');\n            }\n\n            this.base();\n        }\n    },\n    {\n        defaults: {\n            contentSummary: [],\n            onSubmit: $.noop,\n            redirect: null\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Element Monitor\n */\nCraft.DraftEditor = Garnish.Base.extend(\n    {\n        $revisionBtn: null,\n        $revisionLabel: null,\n        $spinner: null,\n        $statusIcon: null,\n\n        $editMetaBtn: null,\n        metaHud: null,\n        $nameTextInput: null,\n        $notesTextInput: null,\n        $saveMetaBtn: null,\n\n        lastSerializedValue: null,\n        timeout: null,\n        saving: false,\n        saveXhr: null,\n        checkFormAfterUpdate: false,\n        submittingForm: false,\n\n        duplicatedElements: null,\n        errors: null,\n\n        preview: null,\n        previewToken: null,\n\n        init: function(settings) {\n            this.setSettings(settings, Craft.DraftEditor.defaults);\n\n            this.duplicatedElements = {};\n\n            this.$revisionBtn = $('#revision-btn');\n            this.$revisionLabel = $('#revision-label');\n            this.$spinner = $('#revision-spinner');\n            this.$statusIcon = $('#revision-status');\n\n            if (this.settings.previewTargets.length) {\n                if (this.settings.enablePreview) {\n                    this.addListener($('#preview-btn'), 'click', 'openPreview');\n                }\n\n                var $shareBtn = $('#share-btn');\n\n                if (this.settings.previewTargets.length === 1) {\n                    this.addListener($shareBtn, 'click', function() {\n                        this.openShareLink(this.settings.previewTargets[0].url);\n                    });\n                } else {\n                    this.createShareMenu($shareBtn);\n                }\n            }\n\n            // If this is a revision, we're done here\n            if (this.settings.revisionId) {\n                return;\n            }\n\n            // Store the initial form value\n            this.lastSerializedValue = this.serializeForm(true);\n            Craft.cp.$primaryForm.data('initialSerializedValue', this.lastSerializedValue);\n\n            // Override the serializer to use our own\n            Craft.cp.$primaryForm.data('serializer', function() {\n                return this.serializeForm(true)\n            }.bind(this));\n\n            if (this.settings.draftId) {\n                this.initForDraft();\n            } else {\n                // If the \"Save as a Draft\" button is a secondary button, then add special handling for it\n                this.addListener($('#save-draft-btn'), 'click', function(ev) {\n                    ev.preventDefault();\n                    this.createDraft();\n                    this.removeListener(Craft.cp.$primaryForm, 'submit.saveShortcut');\n                }.bind(this));\n\n                // If they're not allowed to update the source element, override the save shortcut to create a draft too\n                if (!this.settings.canUpdateSource) {\n                    this.addListener(Craft.cp.$primaryForm, 'submit.saveShortcut', function(ev) {\n                        if (ev.saveShortcut) {\n                            ev.preventDefault();\n                            this.createDraft();\n                            this.removeListener(Craft.cp.$primaryForm, 'submit.saveShortcut');\n                        }\n                    }.bind(this));\n                }\n            }\n        },\n\n        initForDraft: function() {\n            // Create the edit draft button\n            this.createEditMetaBtn();\n\n            this.addListener(Garnish.$bod, 'keypress keyup change focus blur click mousedown mouseup', function(ev) {\n                if ($(ev.target).is(this.statusIcons())) {\n                    return;\n                }\n                clearTimeout(this.timeout);\n                // If they are typing, wait half a second before checking the form\n                if (Craft.inArray(ev.type, ['keypress', 'keyup', 'change'])) {\n                    this.timeout = setTimeout(this.checkForm.bind(this), 500);\n                } else {\n                    this.checkForm();\n                }\n            });\n\n            this.addListener(Craft.cp.$primaryForm, 'submit', 'handleFormSubmit');\n            this.addListener(this.$statusIcon, 'click', function() {\n                this.showStatusHud(this.$statusIcon);\n            }.bind(this));\n        },\n\n        showStatusHud: function(target) {\n            var bodyHtml;\n\n            if (this.errors === null) {\n                bodyHtml = '<p>' + Craft.t('app', 'The draft has been saved.') + '</p>';\n            } else {\n                var bodyHtml = '<p class=\"error\">' + Craft.t('app', 'The draft could not be saved.') + '</p>';\n\n                if (this.errors.length) {\n                    bodyHtml += '<ul class=\"errors\">';\n                    for (i = 0; i < this.errors.length; i++) {\n                        bodyHtml += '<li>' + Craft.escapeHtml(this.errors[i]) + '</li>';\n                    }\n                    bodyHtml += '</ul>';\n                }\n            }\n\n            var hud = new Garnish.HUD(target, bodyHtml, {\n                onHide: function() {\n                    hud.destroy();\n                    delete hud;\n                }\n            });\n        },\n\n        spinners: function() {\n            return this.preview\n                ? this.$spinner.add(this.preview.$spinner)\n                : this.$spinner;\n        },\n\n        statusIcons: function() {\n            return this.preview\n                ? this.$statusIcon.add(this.preview.$statusIcon)\n                : this.$statusIcon;\n        },\n\n        createEditMetaBtn: function() {\n            this.$editMetaBtn = $('<a/>', {\n                'class': 'btn edit icon',\n                title: Craft.t('app', 'Edit draft settings'),\n            }).appendTo($('#revision-btngroup'));\n            this.addListener(this.$editMetaBtn, 'click', 'showMetaHud');\n        },\n\n        createShareMenu: function($shareBtn) {\n            $shareBtn.addClass('menubtn');\n\n            var $menu = $('<div/>', {'class': 'menu'}).insertAfter($shareBtn);\n            var $ul = $('<ul/>').appendTo($menu);\n            var $li, $a;\n            var $a;\n\n            for (var i = 0; i < this.settings.previewTargets.length; i++) {\n                $li = $('<li/>').appendTo($ul);\n                $a = $('<a/>', {\n                    text: this.settings.previewTargets[i].label,\n                }).appendTo($li);\n                this.addListener($a, 'click', {\n                    target: i,\n                }, function(ev) {\n                    this.openShareLink(this.settings.previewTargets[ev.data.target].url);\n                }.bind(this));\n            }\n        },\n\n        getPreviewToken: function() {\n            return new Promise(function(resolve, reject) {\n                if (this.previewToken) {\n                    resolve(this.previewToken);\n                    return;\n                }\n\n                Craft.postActionRequest('preview/create-token', {\n                    elementType: this.settings.elementType,\n                    sourceId: this.settings.sourceId,\n                    siteId: this.settings.siteId,\n                    draftId: this.settings.draftId,\n                    revisionId: this.settings.revisionId,\n                }, function(response, textStatus) {\n                    if (textStatus === 'success') {\n                        this.previewToken = response.token;\n                        resolve(this.previewToken);\n                    } else {\n                        reject();\n                    }\n                }.bind(this));\n            }.bind(this));\n        },\n\n        getTokenizedPreviewUrl: function(url, randoParam) {\n            return new Promise(function(resolve, reject) {\n                var params = {};\n\n                if (randoParam || !this.settings.isLive) {\n                    // Randomize the URL so CDNs don't return cached pages\n                    params[randoParam || 'x-craft-preview'] = Craft.randomString(10);\n                }\n\n                // No need for a token if we're looking at a live element\n                if (this.settings.isLive) {\n                    resolve(Craft.getUrl(url, params));\n                    return;\n                }\n\n                this.getPreviewToken().then(function(token) {\n                    params[Craft.tokenParam] = token;\n                    resolve(Craft.getUrl(url, params));\n                }).catch(reject);\n            }.bind(this));\n        },\n\n        openShareLink: function(url) {\n            this.getTokenizedPreviewUrl(url).then(function(url) {\n                window.open(url);\n            });\n        },\n\n        getPreview: function() {\n            if (!this.preview) {\n                this.preview = new Craft.Preview(this);\n            }\n            return this.preview;\n        },\n\n        openPreview: function() {\n            return new Promise(function(resolve, reject) {\n                this.ensureIsDraftOrRevision()\n                    .then(function() {\n                        this.getPreview().open();\n                        resolve();\n                    }.bind(this))\n                    .catch(reject);\n            }.bind(this))\n        },\n\n        ensureIsDraftOrRevision: function() {\n            return new Promise(function(resolve, reject) {\n                if (!this.settings.draftId && !this.settings.revisionid) {\n                    this.createDraft()\n                        .then(resolve)\n                        .catch(reject);\n                } else {\n                    resolve();\n                }\n            }.bind(this));\n        },\n\n        serializeForm: function(removeActionParams) {\n            var data = Craft.cp.$primaryForm.serialize();\n\n            if (this.isPreviewActive()) {\n                // Replace the temp input with the preview form data\n                data = data.replace('__PREVIEW_FIELDS__=1', this.preview.$editor.serialize());\n            }\n\n            if (removeActionParams && !this.settings.isUnsavedDraft) {\n                // Remove action and redirect params\n                data = data.replace(/&action=[^&]*/, '');\n                data = data.replace(/&redirect=[^&]*/, '');\n            }\n\n            return data;\n        },\n\n        checkForm: function(force) {\n            // If this isn't a draft, then there's nothing to check\n            if (!this.settings.draftId) {\n                return;\n            }\n\n            clearTimeout(this.timeout);\n            this.timeout = null;\n\n            // Has anything changed?\n            var data = this.serializeForm(true);\n            if (force || (data !== this.lastSerializedValue)) {\n                this.saveDraft(data);\n            }\n        },\n\n        isPreviewActive: function() {\n            return this.preview && this.preview.isActive;\n        },\n\n        createDraft: function() {\n            return new Promise(function(resolve, reject) {\n                this.saveDraft(this.serializeForm(true))\n                    .then(resolve)\n                    .catch(reject);\n            }.bind(this));\n        },\n\n        saveDraft: function(data) {\n            return new Promise(function(resolve, reject) {\n                // Ignore if we're already submitting the main form\n                if (this.submittingForm) {\n                    reject();\n                    return;\n                }\n\n                this.lastSerializedValue = data;\n\n                if (this.saving) {\n                    this.checkFormAfterUpdate = true;\n                    return;\n                }\n\n                this.saving = true;\n                var $spinners = this.spinners().removeClass('hidden');\n                var $statusIcons = this.statusIcons().removeClass('invisible checkmark-icon alert-icon').addClass('hidden');\n                if (this.$saveMetaBtn) {\n                    this.$saveMetaBtn.addClass('active');\n                }\n                this.errors = null;\n\n                var url = Craft.getActionUrl(this.settings.saveDraftAction);\n                var i;\n\n                this.saveXhr = Craft.postActionRequest(url, this.prepareData(data), function(response, textStatus) {\n                    $spinners.addClass('hidden');\n                    if (this.$saveMetaBtn) {\n                        this.$saveMetaBtn.removeClass('active');\n                    }\n                    this.saving = false;\n\n                    if (textStatus === 'abort') {\n                        return;\n                    }\n\n                    if (textStatus !== 'success' || response.errors) {\n                        this.errors = (response ? response.errors : null) || [];\n                        $statusIcons\n                            .removeClass('hidden checkmark-icon')\n                            .addClass('alert-icon')\n                            .attr('title', Craft.t('app', 'The draft could not be saved.'));\n                        reject();\n                        return;\n                    }\n\n                    if (response.title) {\n                        $('#header h1').text(response.title);\n                    }\n\n                    if (response.docTitle) {\n                        document.title = response.docTitle;\n                    }\n\n                    this.$revisionLabel.text(response.draftName);\n\n                    this.settings.draftName = response.draftName;\n                    this.settings.draftNotes = response.draftNotes;\n\n                    var revisionMenu = this.$revisionBtn.data('menubtn') ? this.$revisionBtn.data('menubtn').menu : null;\n\n                    // Did we just create a draft?\n                    var draftCreated = !this.settings.draftId;\n                    if (draftCreated) {\n                        // Update the document location HREF\n                        var newHref;\n                        var anchorPos = document.location.href.search('#');\n                        if (anchorPos !== -1) {\n                            newHref = document.location.href.substr(0, anchorPos);\n                        } else {\n                            newHref = document.location.href;\n                        }\n                        newHref += (newHref.match(/\\?/) ? '&' : '?') + 'draftId=' + response.draftId;\n                        if (anchorPos !== -1) {\n                            newHref += document.location.href.substr(anchorPos);\n                        }\n                        history.replaceState({}, '', newHref);\n\n                        // Replace the Save button with an Update button, if there is one.\n                        // Otherwise, the user must not have permission to update the source element\n                        var $saveBtnContainer = $('#save-btn-container');\n                        if ($saveBtnContainer.length) {\n                            $saveBtnContainer.replaceWith($('<input/>', {\n                                type: 'submit',\n                                'class': 'btn submit',\n                                value: Craft.t('app', 'Update {type}', {type: this.settings.elementTypeDisplayName})\n                            }));\n                        }\n\n                        // Remove the \"Save as a Draft\" button\n                        var $saveDraftBtn = $('#save-draft-btn-container');\n                        $saveDraftBtn.add($saveDraftBtn.prev('.spacer')).remove();\n\n                        // Update the editor settings\n                        this.settings.draftId = response.draftId;\n                        this.settings.isLive = false;\n                        this.settings.canDeleteDraft = true;\n                        this.previewToken = null;\n                        this.initForDraft();\n\n                        // Add the draft to the revision menu\n                        if (revisionMenu) {\n                            revisionMenu.$options.filter(':not(.site-option)').removeClass('sel');\n                            var $draftsUl = revisionMenu.$container.find('.revision-group-drafts');\n                            if (!$draftsUl.length) {\n                                var $draftHeading = $('<h6/>', {\n                                    text: Craft.t('app', 'Drafts'),\n                                }).insertAfter(revisionMenu.$container.find('.revision-group-current'));\n                                $draftsUl = $('<ul/>', {\n                                    'class': 'padded revision-group-drafts',\n                                }).insertAfter($draftHeading);\n                            }\n                            var $draftLi = $('<li/>').appendTo($draftsUl);\n                            var $draftA = $('<a/>', {\n                                'class': 'sel',\n                                html: '<span class=\"draft-name\"></span> <span class=\"draft-creator light\"></span>',\n                            }).appendTo($draftLi);\n                            revisionMenu.addOptions($draftA);\n                            revisionMenu.selectOption($draftA);\n\n                            // Update the site URLs\n                            var $siteOptions = revisionMenu.$options.filter('.site-option[href]');\n                            for (var i = 0; i < $siteOptions.length; i++) {\n                                var $siteOption = $siteOptions.eq(i);\n                                $siteOption.attr('href', Craft.getUrl($siteOption.attr('href'), {draftId: response.draftId}));\n                            }\n                        }\n                    }\n\n                    if (revisionMenu) {\n                        revisionMenu.$options.filter('.sel').find('.draft-name').text(response.draftName);\n                        revisionMenu.$options.filter('.sel').find('.draft-creator').text(Craft.t('app', 'by {creator}', {\n                            creator: response.creator\n                        }));\n                    }\n\n                    // Did the controller send us updated preview targets?\n                    if (\n                        response.previewTargets &&\n                        JSON.stringify(response.previewTargets) !== JSON.stringify(this.settings.previewTargets)\n                    ) {\n                        this.updatePreviewTargets(response.previewTargets);\n                    }\n\n                    this.afterUpdate(data);\n\n                    if (draftCreated) {\n                        this.trigger('createDraft');\n                    }\n\n                    if (this.$nameTextInput) {\n                        this.checkMetaValues();\n                    }\n\n                    $.extend(this.duplicatedElements, response.duplicatedElements);\n\n                    resolve();\n                }.bind(this));\n            }.bind(this));\n        },\n\n        prepareData: function(data) {\n            // Swap out element IDs with their duplicated ones\n            for (var oldId in this.duplicatedElements) {\n                if (this.duplicatedElements.hasOwnProperty(oldId)) {\n                    data = data.replace(new RegExp(Craft.escapeRegex(encodeURIComponent('][' + oldId + ']')), 'g'),\n                        '][' + this.duplicatedElements[oldId] + ']');\n                }\n            }\n\n            // Add the draft info\n            if (this.settings.draftId) {\n                data += '&draftId=' + this.settings.draftId\n                    + '&draftName=' + encodeURIComponent(this.settings.draftName)\n                    + '&draftNotes=' + encodeURIComponent(this.settings.draftNotes || '');\n            }\n\n            return data;\n        },\n\n        updatePreviewTargets: function(previewTargets) {\n            // index the current preview targets by label\n            var currentTargets = {};\n            for (var i = 0; i < this.settings.previewTargets.length; i++) {\n                currentTargets[this.settings.previewTargets[i].label] = this.settings.previewTargets[i];\n            }\n            for (i = 0; i < previewTargets.length; i++) {\n                if (currentTargets[previewTargets[i].label]) {\n                    currentTargets[previewTargets[i].label].url = previewTargets[i].url;\n                }\n            }\n        },\n\n        afterUpdate: function(data) {\n            Craft.cp.$primaryForm.data('initialSerializedValue', data);\n            this.statusIcons()\n                .removeClass('hidden')\n                .addClass('checkmark-icon')\n                .attr('title', Craft.t('app', 'The draft has been saved.'));\n\n            this.trigger('update');\n\n            if (this.checkFormAfterUpdate) {\n                this.checkFormAfterUpdate = false;\n\n                // Only actually check the form if there's no active timeout for it\n                if (!this.timeout) {\n                    this.checkForm();\n                }\n            }\n        },\n\n        showMetaHud: function() {\n            if (!this.metaHud) {\n                this.createMetaHud();\n                this.onMetaHudShow();\n            } else {\n                this.metaHud.show();\n            }\n\n            if (!Garnish.isMobileBrowser(true)) {\n                this.$nameTextInput.trigger('focus');\n            }\n        },\n\n        createMetaHud: function() {\n            var $hudBody = $('<div/>');\n            var $field, $inputContainer;\n\n            // Add the Name field\n            $field = $('<div class=\"field\"><div class=\"heading\"><label for=\"draft-name\">' + Craft.t('app', 'Draft Name') + '</label></div></div>').appendTo($hudBody);\n            $inputContainer = $('<div class=\"input\"/>').appendTo($field);\n            this.$nameTextInput = $('<input type=\"text\" class=\"text fullwidth\" id=\"draft-name\"/>').appendTo($inputContainer).val(this.settings.draftName);\n\n            // Add the Notes field\n            $field = $('<div class=\"field\"><div class=\"heading\"><label for=\"draft-notes\">' + Craft.t('app', 'Notes') + '</label></div></div>').appendTo($hudBody);\n            $inputContainer = $('<div class=\"input\"/>').appendTo($field);\n            this.$notesTextInput = $('<textarea class=\"text fullwidth\" id=\"draft-notes\" rows=\"2\"/>').appendTo($inputContainer).val(this.settings.draftNotes);\n\n            // HUD footer\n            var $footer = $('<div class=\"hud-footer flex flex-center\"/>').appendTo($hudBody);\n\n            // Delete button\n            if (this.settings.canDeleteDraft) {\n                var $deleteLink = $('<a class=\"error\" role=\"button\">' + Craft.t('app', 'Delete') + '</a>').appendTo($footer);\n            }\n\n            $('<div class=\"flex-grow\"></div>').appendTo($footer);\n            this.$saveMetaBtn = $('<input type=\"submit\" class=\"btn submit disabled\" value=\"' + Craft.t('app', 'Save') + '\"/>').appendTo($footer);\n\n            this.metaHud = new Garnish.HUD(this.$editMetaBtn, $hudBody, {\n                onSubmit: this.saveMeta.bind(this)\n            });\n\n            new Garnish.NiceText(this.$notesTextInput);\n\n            this.addListener(this.$notesTextInput, 'keydown', 'onNotesKeydown');\n\n            this.addListener(this.$nameTextInput, 'textchange', 'checkMetaValues');\n            this.addListener(this.$notesTextInput, 'textchange', 'checkMetaValues');\n\n            this.metaHud.on('show', this.onMetaHudShow.bind(this));\n            this.metaHud.on('hide', this.onMetaHudHide.bind(this));\n            this.metaHud.on('escape', this.onMetaHudEscape.bind(this));\n\n            if ($deleteLink) {\n                this.addListener($deleteLink, 'click', 'deleteDraft');\n            }\n        },\n\n        onMetaHudShow: function() {\n            this.$editMetaBtn.addClass('active');\n        },\n\n        onMetaHudHide: function() {\n            this.$editMetaBtn.removeClass('active');\n        },\n\n        onMetaHudEscape: function() {\n            this.$nameTextInput.val(this.settings.draftName);\n            this.$notesTextInput.val(this.settings.draftNotes);\n        },\n\n        onNotesKeydown: function(ev) {\n            if (ev.keyCode === Garnish.RETURN_KEY) {\n                ev.preventDefault();\n                this.metaHud.submit();\n            }\n        },\n\n        checkMetaValues: function() {\n            if (\n                this.$nameTextInput.val() && (\n                    this.$nameTextInput.val() !== this.settings.draftName ||\n                    this.$notesTextInput.val() !== this.settings.draftNotes\n                )\n            ) {\n                this.$saveMetaBtn.removeClass('disabled');\n                return true;\n            }\n\n            this.$saveMetaBtn.addClass('disabled');\n            return false;\n        },\n\n        shakeMetaHud: function() {\n            Garnish.shake(this.metaHud.$hud);\n        },\n\n        saveMeta: function() {\n            if (!this.checkMetaValues()) {\n                this.shakeMetaHud();\n                return;\n            }\n\n            this.settings.draftName = this.$nameTextInput.val();\n            this.settings.draftNotes = this.$notesTextInput.val();\n\n            this.metaHud.hide();\n            this.checkForm(true);\n        },\n\n        deleteDraft: function() {\n            if (!confirm(Craft.t('app', 'Are you sure you want to delete this draft?'))) {\n                return;\n            }\n\n            Craft.postActionRequest(this.settings.deleteDraftAction, {draftId: this.settings.draftId}, function(response, textStatus) {\n                if (textStatus === 'success') {\n                    window.location.href = this.settings.cpEditUrl;\n                }\n            }.bind(this))\n        },\n\n        handleFormSubmit: function(ev) {\n            ev.preventDefault();\n\n            // Prevent double form submits\n            if (this.submittingForm) {\n                return;\n            }\n\n            // If we're editing a draft, this isn't a custom trigger, and the user isn't allowed to update the source,\n            // then ignore the submission\n            if (!ev.customTrigger && !this.settings.isUnsavedDraft && this.settings.draftId && !this.settings.canUpdateSource) {\n                return;\n            }\n\n            // Prevent the normal unload confirmation dialog\n            Craft.cp.$confirmUnloadForms = Craft.cp.$confirmUnloadForms.not(Craft.cp.$primaryForm);\n\n            // Abort the current save request if there is one\n            if (this.saving) {\n                this.saveXhr.abort();\n            }\n\n            // Duplicate the form with normalized data\n            var $form = $('<form/>', {\n                attr: {\n                    'accept-charset': Craft.cp.$primaryForm.attr('accept-charset'),\n                    'action': Craft.cp.$primaryForm.attr('action'),\n                    'enctype': Craft.cp.$primaryForm.attr('enctype'),\n                    'method': Craft.cp.$primaryForm.attr('method'),\n                    'target': Craft.cp.$primaryForm.attr('target'),\n                }\n            });\n            var data = this.prepareData(this.serializeForm(false));\n            var values = data.split('&');\n            var chunks;\n            for (var i = 0; i < values.length; i++) {\n                chunks = values[i].split('=', 2);\n                $('<input/>', {\n                    type: 'hidden',\n                    name: decodeURIComponent(chunks[0]),\n                    value: decodeURIComponent(chunks[1] || '')\n                }).appendTo($form);\n            }\n\n            if (!ev.customTrigger || !ev.customTrigger.data('action')) {\n                $('<input/>', {\n                    type: 'hidden',\n                    name: 'action',\n                    value: this.settings.applyDraftAction\n                }).appendTo($form);\n            }\n\n            if (\n                (!ev.saveShortcut || !Craft.cp.$primaryForm.data('saveshortcut-redirect')) &&\n                (!ev.customTrigger || !ev.customTrigger.data('redirect'))\n            ) {\n                $('<input/>', {\n                    type: 'hidden',\n                    name: 'redirect',\n                    value: this.settings.hashedRedirectUrl\n                }).appendTo($form);\n            }\n\n            $form.appendTo(Garnish.$bod);\n            $form.submit();\n            this.submittingForm = true;\n        },\n    },\n    {\n        defaults: {\n            elementType: null,\n            sourceId: null,\n            siteId: null,\n            isLive: false,\n            cpEditUrl: null,\n            draftId: null,\n            revisionId: null,\n            draftName: null,\n            draftNotes: null,\n            canDeleteDraft: false,\n            canUpdateSource: false,\n            saveDraftAction: null,\n            deleteDraftAction: null,\n            applyDraftAction: null,\n            enablePreview: false,\n            previewTargets: [],\n        }\n    }\n);\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Handle Generator\n */\nCraft.DynamicGenerator = Craft.BaseInputGenerator.extend(\n    {\n        callback: $.noop,\n\n        init: function(source, target, callback) {\n            this.callback = callback;\n            this.base(source, target);\n        },\n\n        generateTargetValue: function(sourceVal) {\n            return this.callback(sourceVal);\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Editable table class\n */\nCraft.EditableTable = Garnish.Base.extend(\n    {\n        initialized: false,\n\n        id: null,\n        baseName: null,\n        columns: null,\n        sorter: null,\n        biggestId: -1,\n\n        $table: null,\n        $tbody: null,\n        $addRowBtn: null,\n\n        rowCount: 0,\n        hasMaxRows: false,\n        hasMinRows: false,\n\n        radioCheckboxes: null,\n\n        init: function(id, baseName, columns, settings) {\n            this.id = id;\n            this.baseName = baseName;\n            this.columns = columns;\n            this.setSettings(settings, Craft.EditableTable.defaults);\n            this.radioCheckboxes = {};\n\n            this.$table = $('#' + id);\n            this.$tbody = this.$table.children('tbody');\n            this.rowCount = this.$tbody.find('tr').length;\n\n            // Is this already an editable table?\n            if (this.$table.data('editable-table')) {\n                Garnish.log('Double-instantiating an editable table on an element');\n                this.$table.data('editable-table').destroy();\n            }\n\n            this.$table.data('editable-table', this);\n\n            this.sorter = new Craft.DataTableSorter(this.$table, {\n                helperClass: 'editabletablesorthelper',\n                copyDraggeeInputValuesToHelper: true\n            });\n\n            if (this.isVisible()) {\n                this.initialize();\n            } else {\n                // Give everything a chance to initialize\n                setTimeout($.proxy(this, 'initializeIfVisible'), 500);\n            }\n\n            if (this.settings.minRows && this.rowCount < this.settings.minRows) {\n                for (var i = this.rowCount; i < this.settings.minRows; i++) {\n                    this.addRow()\n                }\n            }\n        },\n\n        isVisible: function() {\n            return (this.$table.height() > 0);\n        },\n\n        initialize: function() {\n            if (this.initialized) {\n                return false;\n            }\n\n            this.initialized = true;\n            this.removeListener(Garnish.$win, 'resize');\n\n            var $rows = this.$tbody.children();\n\n            for (var i = 0; i < $rows.length; i++) {\n                this.createRowObj($rows[i]);\n            }\n\n            this.$addRowBtn = this.$table.next('.add');\n            this.updateAddRowButton();\n            this.addListener(this.$addRowBtn, 'activate', 'addRow');\n            return true;\n        },\n        initializeIfVisible: function() {\n            this.removeListener(Garnish.$win, 'resize');\n\n            if (this.isVisible()) {\n                this.initialize();\n            } else {\n                this.addListener(Garnish.$win, 'resize', 'initializeIfVisible');\n            }\n        },\n        updateAddRowButton: function() {\n            if (!this.canAddRow()) {\n                this.$addRowBtn.css('opacity', '0.2');\n                this.$addRowBtn.css('pointer-events', 'none');\n            } else {\n                this.$addRowBtn.css('opacity', '1');\n                this.$addRowBtn.css('pointer-events', 'auto');\n            }\n        },\n        canDeleteRow: function() {\n            return (this.rowCount > this.settings.minRows);\n        },\n        deleteRow: function(row) {\n            if (!this.canDeleteRow()) {\n                return;\n            }\n\n            this.sorter.removeItems(row.$tr);\n            row.$tr.remove();\n\n            this.rowCount--;\n\n            this.updateAddRowButton();\n            // onDeleteRow callback\n            this.settings.onDeleteRow(row.$tr);\n\n            row.destroy();\n        },\n        canAddRow: function() {\n            if (this.settings.staticRows) {\n                return false;\n            }\n\n            if (this.settings.maxRows) {\n                return (this.rowCount < this.settings.maxRows);\n            }\n\n            return true;\n        },\n        addRow: function(focus, prepend) {\n            if (!this.canAddRow()) {\n                return;\n            }\n\n            var rowId = this.settings.rowIdPrefix + (this.biggestId + 1),\n                $tr = this.createRow(rowId, this.columns, this.baseName, $.extend({}, this.settings.defaultValues));\n\n            if (prepend) {\n                $tr.prependTo(this.$tbody);\n            } else {\n                $tr.appendTo(this.$tbody);\n            }\n\n            var row = this.createRowObj($tr);\n            this.sorter.addItems($tr);\n\n            // Focus the first input in the row\n            if (focus !== false) {\n                $tr.find('input:visible,textarea:visible,select:visible').first().trigger('focus');\n            }\n\n            this.rowCount++;\n            this.updateAddRowButton();\n\n            // onAddRow callback\n            this.settings.onAddRow($tr);\n\n            return row;\n        },\n\n        createRow: function(rowId, columns, baseName, values) {\n            return Craft.EditableTable.createRow(rowId, columns, baseName, values);\n        },\n\n        createRowObj: function($tr) {\n            return new Craft.EditableTable.Row(this, $tr);\n        },\n\n        focusOnPrevRow: function($tr, tdIndex, blurTd) {\n            var $prevTr = $tr.prev('tr');\n            var prevRow;\n\n            if ($prevTr.length) {\n                prevRow = $prevTr.data('editable-table-row');\n            } else {\n                prevRow = this.addRow(false, true);\n            }\n\n            // Focus on the same cell in the previous row\n            if (!prevRow) {\n                return;\n            }\n\n            if (!prevRow.$tds[tdIndex]) {\n                return;\n            }\n\n            if ($(prevRow.$tds[tdIndex]).hasClass('disabled')) {\n                if ($prevTr) {\n                    this.focusOnPrevRow($prevTr, tdIndex, blurTd);\n                }\n                return;\n            }\n\n            var $input = $('textarea,input.text', prevRow.$tds[tdIndex]);\n            if ($input.length) {\n                $(blurTd).trigger('blur');\n                $input.trigger('focus');\n            }\n        },\n\n        focusOnNextRow: function($tr, tdIndex, blurTd) {\n            var $nextTr = $tr.next('tr');\n            var nextRow;\n\n            if ($nextTr.length) {\n                nextRow = $nextTr.data('editable-table-row');\n            } else {\n                nextRow = this.addRow(false);\n            }\n\n            // Focus on the same cell in the next row\n            if (!nextRow) {\n                return;\n            }\n\n            if (!nextRow.$tds[tdIndex]) {\n                return;\n            }\n\n            if ($(nextRow.$tds[tdIndex]).hasClass('disabled')) {\n                if ($nextTr) {\n                    this.focusOnNextRow($nextTr, tdIndex, blurTd);\n                }\n                return;\n            }\n\n            var $input = $('textarea,input.text', nextRow.$tds[tdIndex]);\n            if ($input.length) {\n                $(blurTd).trigger('blur');\n                $input.trigger('focus');\n            }\n        },\n    },\n    {\n        textualColTypes: ['color', 'date', 'email', 'multiline', 'number', 'singleline', 'template', 'time', 'url'],\n        defaults: {\n            rowIdPrefix: '',\n            defaultValues: {},\n            staticRows: false,\n            minRows: null,\n            maxRows: null,\n            onAddRow: $.noop,\n            onDeleteRow: $.noop\n        },\n\n        createRow: function(rowId, columns, baseName, values) {\n            var $tr = $('<tr/>', {\n                'data-id': rowId\n            });\n\n            for (var colId in columns) {\n                if (!columns.hasOwnProperty(colId)) {\n                    continue;\n                }\n\n                var col = columns[colId],\n                    value = (typeof values[colId] !== 'undefined' ? values[colId] : ''),\n                    $cell;\n\n                if (col.type === 'heading') {\n                    $cell = $('<th/>', {\n                        'scope': 'row',\n                        'class': col['class'],\n                        'html': value\n                    });\n                } else {\n                    var name = baseName + '[' + rowId + '][' + colId + ']',\n                        textual = Craft.inArray(col.type, Craft.EditableTable.textualColTypes);\n\n                    $cell = $('<td/>', {\n                        'class': col['class'],\n                        'width': col.width\n                    });\n\n                    if (textual) {\n                        $cell.addClass('textual');\n                    }\n\n                    if (col.code) {\n                        $cell.addClass('code');\n                    }\n\n                    switch (col.type) {\n                        case 'checkbox':\n                            Craft.ui.createCheckbox({\n                                name: name,\n                                value: col.value || '1',\n                                checked: !!value\n                            }).appendTo($cell);\n                            break;\n\n                        case 'color':\n                            Craft.ui.createColorInput({\n                                name: name,\n                                value: value,\n                                small: true\n                            }).appendTo($cell);\n                            break;\n\n                        case 'date':\n                            Craft.ui.createDateInput({\n                                name: name,\n                                value: value\n                            }).appendTo($cell);\n                            break;\n\n                        case 'lightswitch':\n                            Craft.ui.createLightswitch({\n                                name: name,\n                                value: col.value || '1',\n                                on: !!value,\n                                small: true\n                            }).appendTo($cell);\n                            break;\n\n                        case 'select':\n                            Craft.ui.createSelect({\n                                name: name,\n                                options: col.options,\n                                value: value || (function() {\n                                    for (var key in col.options) {\n                                        if (col.options.hasOwnProperty(key) && col.options[key].default) {\n                                            return typeof col.options[key].value !== 'undefined' ? col.options[key].value : key;\n                                        }\n                                    }\n                                    return null;\n                                })(),\n                                'class': 'small'\n                            }).appendTo($cell);\n                            break;\n\n                        case 'time':\n                            Craft.ui.createTimeInput({\n                                name: name,\n                                value: value\n                            }).appendTo($cell);\n                            break;\n\n                        case 'email':\n                        case 'url':\n                            Craft.ui.createTextInput({\n                                name: name,\n                                value: value,\n                                type: col.type,\n                                placeholder: col.placeholder || null,\n                            }).appendTo($cell);\n                            break;\n\n                        default:\n                            $('<textarea/>', {\n                                'name': name,\n                                'rows': 1,\n                                'val': value,\n                                'placeholder': col.placeholder\n                            }).appendTo($cell);\n                    }\n                }\n\n                $cell.appendTo($tr);\n            }\n\n            $('<td/>', {\n                'class': 'thin action'\n            }).append(\n                $('<a/>', {\n                    'class': 'move icon',\n                    'title': Craft.t('app', 'Reorder')\n                })\n            ).appendTo($tr);\n\n            $('<td/>', {\n                'class': 'thin action'\n            }).append(\n                $('<a/>', {\n                    'class': 'delete icon',\n                    'title': Craft.t('app', 'Delete')\n                })\n            ).appendTo($tr);\n\n            return $tr;\n        }\n    });\n\n/**\n * Editable table row class\n */\nCraft.EditableTable.Row = Garnish.Base.extend(\n    {\n        table: null,\n        id: null,\n        niceTexts: null,\n\n        $tr: null,\n        $tds: null,\n        tds: null,\n        $textareas: null,\n        $deleteBtn: null,\n\n        init: function(table, tr) {\n            this.table = table;\n            this.$tr = $(tr);\n            this.$tds = this.$tr.children();\n            this.tds = [];\n            this.id = this.$tr.attr('data-id');\n\n            this.$tr.data('editable-table-row', this);\n\n            // Get the row ID, sans prefix\n            var id = parseInt(this.id.substr(this.table.settings.rowIdPrefix.length));\n\n            if (id > this.table.biggestId) {\n                this.table.biggestId = id;\n            }\n\n            this.$textareas = $();\n            this.niceTexts = [];\n            var textareasByColId = {};\n\n            var i = 0;\n            var colId, col, td, $textarea, $checkbox;\n\n            for (colId in this.table.columns) {\n                if (!this.table.columns.hasOwnProperty(colId)) {\n                    continue;\n                }\n\n                col = this.table.columns[colId];\n                td = this.tds[colId] = this.$tds[i];\n\n                if (Craft.inArray(col.type, Craft.EditableTable.textualColTypes)) {\n                    $textarea = $('textarea, input.text', td);\n                    this.$textareas = this.$textareas.add($textarea);\n\n                    this.addListener($textarea, 'focus', 'onTextareaFocus');\n                    this.addListener($textarea, 'mousedown', 'ignoreNextTextareaFocus');\n\n                    this.niceTexts.push(new Garnish.NiceText($textarea, {\n                        onHeightChange: $.proxy(this, 'onTextareaHeightChange')\n                    }));\n\n                    this.addListener($textarea, 'keypress', {tdIndex: i, type: col.type}, 'handleKeypress');\n                    this.addListener($textarea, 'textchange', {type: col.type}, 'validateValue');\n                    $textarea.trigger('textchange');\n\n                    textareasByColId[colId] = $textarea;\n                } else if (col.type === 'checkbox') {\n                    $checkbox = $('input[type=\"checkbox\"]', td);\n\n                    if (col.radioMode) {\n                        if (typeof this.table.radioCheckboxes[colId] === 'undefined') {\n                            this.table.radioCheckboxes[colId] = [];\n                        }\n                        this.table.radioCheckboxes[colId].push($checkbox[0]);\n                        this.addListener($checkbox, 'change', {colId: colId}, 'onRadioCheckboxChange');\n                    }\n\n                    if (col.toggle) {\n                        this.addListener($checkbox, 'change', {colId: colId}, function(ev) {\n                            this.applyToggleCheckbox(ev.data.colId);\n                        });\n                    }\n                }\n\n                i++;\n            }\n\n            // Now that all of the text cells have been nice-ified, let's normalize the heights\n            this.onTextareaHeightChange();\n\n            // See if we need to apply any checkbox toggles now that we've indexed all the TDs\n            for (colId in this.table.columns) {\n                if (!this.table.columns.hasOwnProperty(colId)) {\n                    continue;\n                }\n                col = this.table.columns[colId];\n                if (col.type === 'checkbox' && col.toggle) {\n                    this.applyToggleCheckbox(colId);\n                }\n            }\n\n            // Now look for any autopopulate columns\n            for (colId in this.table.columns) {\n                if (!this.table.columns.hasOwnProperty(colId)) {\n                    continue;\n                }\n\n                col = this.table.columns[colId];\n\n                if (col.autopopulate && typeof textareasByColId[col.autopopulate] !== 'undefined' && !textareasByColId[colId].val()) {\n                    new Craft.HandleGenerator(textareasByColId[colId], textareasByColId[col.autopopulate], {\n                        allowNonAlphaStart: true\n                    });\n                }\n            }\n\n            var $deleteBtn = this.$tr.children().last().find('.delete');\n            this.addListener($deleteBtn, 'click', 'deleteRow');\n        },\n\n        onTextareaFocus: function(ev) {\n            this.onTextareaHeightChange();\n\n            var $textarea = $(ev.currentTarget);\n\n            if ($textarea.data('ignoreNextFocus')) {\n                $textarea.data('ignoreNextFocus', false);\n                return;\n            }\n\n            setTimeout(function() {\n                Craft.selectFullValue($textarea);\n            }, 0);\n        },\n\n        onRadioCheckboxChange: function(ev) {\n            if (ev.currentTarget.checked) {\n                for (var i = 0; i < this.table.radioCheckboxes[ev.data.colId].length; i++) {\n                    var checkbox = this.table.radioCheckboxes[ev.data.colId][i];\n                    checkbox.checked = (checkbox === ev.currentTarget);\n                }\n            }\n        },\n\n        applyToggleCheckbox: function(checkboxColId) {\n            var checkboxCol = this.table.columns[checkboxColId];\n            var checked = $('input[type=\"checkbox\"]', this.tds[checkboxColId]).prop('checked');\n            var colId, colIndex, neg;\n            for (var i = 0; i < checkboxCol.toggle.length; i++) {\n                colId = checkboxCol.toggle[i];\n                colIndex = this.table.colum;\n                if (neg = colId[0] === '!') {\n                    colId = colId.substr(1);\n                }\n                if ((checked && !neg) || (!checked && neg))  {\n                    $(this.tds[colId])\n                        .removeClass('disabled')\n                        .find('textarea, input').prop('disabled', false);\n                } else {\n                    $(this.tds[colId])\n                        .addClass('disabled')\n                        .find('textarea, input').prop('disabled', true);\n                }\n            }\n        },\n\n        ignoreNextTextareaFocus: function(ev) {\n            $.data(ev.currentTarget, 'ignoreNextFocus', true);\n        },\n\n        handleKeypress: function(ev) {\n            var keyCode = ev.keyCode ? ev.keyCode : ev.charCode;\n            var ctrl = Garnish.isCtrlKeyPressed(ev);\n\n            // Going to the next/previous row?\n            if (keyCode === Garnish.RETURN_KEY && (ev.data.type !== 'multiline' || ctrl)) {\n                ev.preventDefault();\n                if (ev.shiftKey) {\n                    this.table.focusOnPrevRow(this.$tr, ev.data.tdIndex, ev.currentTarget);\n                } else {\n                    this.table.focusOnNextRow(this.$tr, ev.data.tdIndex, ev.currentTarget);\n                }\n                return;\n            }\n\n            // Was this an invalid number character?\n            if (ev.data.type === 'number' && !ctrl && !Craft.inArray(keyCode, Craft.EditableTable.Row.numericKeyCodes)) {\n                ev.preventDefault();\n            }\n        },\n\n        validateValue: function(ev) {\n            if (ev.data.type === 'multiline') {\n                return;\n            }\n\n            var safeValue;\n\n            if (ev.data.type === 'number') {\n                // Only grab the number at the beginning of the value (if any)\n                var match = ev.currentTarget.value.match(/^\\s*(-?[\\d\\\\.]*)/);\n\n                if (match !== null) {\n                    safeValue = match[1];\n                }\n                else {\n                    safeValue = '';\n                }\n            }\n            else {\n                // Just strip any newlines\n                safeValue = ev.currentTarget.value.replace(/[\\r\\n]/g, '');\n            }\n\n            if (safeValue !== ev.currentTarget.value) {\n                ev.currentTarget.value = safeValue;\n            }\n        },\n\n        onTextareaHeightChange: function() {\n            // Keep all the textareas' heights in sync\n            var tallestTextareaHeight = -1;\n\n            for (var i = 0; i < this.niceTexts.length; i++) {\n                if (this.niceTexts[i].height > tallestTextareaHeight) {\n                    tallestTextareaHeight = this.niceTexts[i].height;\n                }\n            }\n\n            this.$textareas.css('min-height', tallestTextareaHeight);\n\n            // If the <td> is still taller, go with that instead\n            var tdHeight = this.$textareas.filter(':visible').first().parent().height();\n\n            if (tdHeight > tallestTextareaHeight) {\n                this.$textareas.css('min-height', tdHeight);\n            }\n        },\n\n        deleteRow: function() {\n            this.table.deleteRow(this);\n        }\n    },\n    {\n        numericKeyCodes: [9 /* (tab) */, 8 /* (delete) */, 37, 38, 39, 40 /* (arrows) */, 45, 91 /* (minus) */, 46, 190 /* period */, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57 /* (0-9) */]\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Element Action Trigger\n */\nCraft.ElementActionTrigger = Garnish.Base.extend(\n    {\n        maxLevels: null,\n        newChildUrl: null,\n        $trigger: null,\n        $selectedItems: null,\n        triggerEnabled: true,\n\n        init: function(settings) {\n            this.setSettings(settings, Craft.ElementActionTrigger.defaults);\n\n            this.$trigger = $('#' + settings.type.replace(/[\\[\\]\\\\]+/g, '-') + '-actiontrigger');\n\n            // Do we have a custom handler?\n            if (this.settings.activate) {\n                // Prevent the element index's click handler\n                this.$trigger.data('custom-handler', true);\n\n                // Is this a custom trigger?\n                if (this.$trigger.prop('nodeName') === 'FORM') {\n                    this.addListener(this.$trigger, 'submit', 'handleTriggerActivation');\n                }\n                else {\n                    this.addListener(this.$trigger, 'click', 'handleTriggerActivation');\n                }\n            }\n\n            this.updateTrigger();\n            Craft.elementIndex.on('selectionChange', $.proxy(this, 'updateTrigger'));\n        },\n\n        updateTrigger: function() {\n            // Ignore if the last element was just unselected\n            if (Craft.elementIndex.getSelectedElements().length === 0) {\n                return;\n            }\n\n            if (this.validateSelection()) {\n                this.enableTrigger();\n            }\n            else {\n                this.disableTrigger();\n            }\n        },\n\n        /**\n         * Determines if this action can be performed on the currently selected elements.\n         *\n         * @return boolean\n         */\n        validateSelection: function() {\n            var valid = true;\n            this.$selectedItems = Craft.elementIndex.getSelectedElements();\n\n            if (!this.settings.batch && this.$selectedItems.length > 1) {\n                valid = false;\n            }\n            else if (typeof this.settings.validateSelection === 'function') {\n                valid = this.settings.validateSelection(this.$selectedItems);\n            }\n\n            return valid;\n        },\n\n        enableTrigger: function() {\n            if (this.triggerEnabled) {\n                return;\n            }\n\n            this.$trigger.removeClass('disabled');\n            this.triggerEnabled = true;\n        },\n\n        disableTrigger: function() {\n            if (!this.triggerEnabled) {\n                return;\n            }\n\n            this.$trigger.addClass('disabled');\n            this.triggerEnabled = false;\n        },\n\n        handleTriggerActivation: function(ev) {\n            ev.preventDefault();\n            ev.stopPropagation();\n\n            if (this.triggerEnabled) {\n                this.settings.activate(this.$selectedItems);\n            }\n        }\n    },\n    {\n        defaults: {\n            type: null,\n            batch: true,\n            validateSelection: null,\n            activate: null\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Base Element Index View\n */\nCraft.ElementThumbLoader = Garnish.Base.extend(\n    {\n        queue: null,\n        workers: [],\n\n        init: function() {\n            this.queue = [];\n\n            for (var i = 0; i < 3; i++) {\n                this.workers.push(new Craft.ElementThumbLoader.Worker(this));\n            }\n        },\n\n        load: function($elements) {\n            this.queue = this.queue.concat($elements.find('.elementthumb').toArray());\n\n            if (this.queue.length) {\n                // See if there are any inactive workers\n                for (var i = 0; i < this.workers.length; i++) {\n                    if (!this.workers[i].active) {\n                        this.workers[i].loadNext();\n                    }\n                }\n            }\n        },\n\n        destroy: function() {\n            for (var i = 0; i < this.workers.length; i++) {\n                this.workers[i].destroy();\n            }\n\n            this.base();\n        }\n    }\n);\n\nCraft.ElementThumbLoader.Worker = Garnish.Base.extend(\n    {\n        loader: null,\n        active: false,\n\n        init: function(loader) {\n            this.loader = loader;\n        },\n\n        loadNext: function() {\n            var container = this.loader.queue.shift();\n            if (typeof container === 'undefined') {\n                this.active = false;\n                return;\n            }\n\n            this.active = true;\n            var $container = $(container);\n            if ($container.find('img').length) {\n                this.loadNext();\n                return;\n            }\n            var $img = $('<img/>', {\n                sizes: $container.attr('data-sizes'),\n                srcset: $container.attr('data-srcset'),\n                alt: ''\n            });\n            this.addListener($img, 'load', 'loadNext');\n            $img.appendTo($container);\n            picturefill({\n                elements: [$img[0]]\n            });\n        }\n    }\n);\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Elevated Session Form\n */\nCraft.ElevatedSessionForm = Garnish.Base.extend(\n    {\n        $form: null,\n        inputs: null,\n\n        init: function(form, inputs) {\n            this.$form = $(form);\n\n            // Only check specific inputs?\n            if (typeof inputs !== 'undefined') {\n                this.inputs = [];\n                inputs = $.makeArray(inputs);\n\n                for (var i = 0; i < inputs.length; i++) {\n                    var $inputs = $(inputs[i]);\n\n                    for (var j = 0; j < $inputs.length; j++) {\n                        var $input = $inputs.eq(j);\n\n                        this.inputs.push({\n                            input: $input,\n                            val: Garnish.getInputPostVal($input)\n                        });\n                    }\n                }\n            }\n\n            this.addListener(this.$form, 'submit', 'handleFormSubmit');\n        },\n\n        handleFormSubmit: function(ev) {\n            // Ignore if we're in the middle of getting the elevated session timeout\n            if (Craft.elevatedSessionManager.fetchingTimeout) {\n                ev.preventDefault();\n                return;\n            }\n\n            // Are we only interested in certain inputs?\n            if (this.inputs) {\n                var inputsChanged = false;\n                var $input;\n\n                for (var i = 0; i < this.inputs.length; i++) {\n                    $input = this.inputs[i].input;\n                    // Is this a password input?\n                    if ($input.data('passwordInput')) {\n                        $input = $input.data('passwordInput').$currentInput;\n                    }\n\n                    // Has this input's value changed?\n                    if (Garnish.getInputPostVal($input) !== this.inputs[i].val) {\n                        inputsChanged = true;\n                        break;\n                    }\n                }\n\n                if (!inputsChanged) {\n                    // No need to interrupt the submit\n                    return;\n                }\n            }\n\n            // Prevent the form from submitting until the user has an elevated session\n            ev.preventDefault();\n            Craft.elevatedSessionManager.requireElevatedSession($.proxy(this, 'submitForm'));\n        },\n\n        submitForm: function() {\n            // Don't let handleFormSubmit() interrupt this time\n            this.disable();\n            this.$form.trigger('submit');\n            this.enable();\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Elevated Session Manager\n */\nCraft.ElevatedSessionManager = Garnish.Base.extend(\n    {\n        fetchingTimeout: false,\n\n        passwordModal: null,\n        $passwordInput: null,\n        $passwordSpinner: null,\n        $submitBtn: null,\n        $errorPara: null,\n\n        callback: null,\n\n        /**\n         * Requires that the user has an elevated session.\n         *\n         * @param {function} callback The callback function that should be called once the user has an elevated session\n         */\n        requireElevatedSession: function(callback) {\n            this.callback = callback;\n\n            // Check the time remaining on the user's elevated session (if any)\n            this.fetchingTimeout = true;\n\n            Craft.postActionRequest('users/get-elevated-session-timeout', $.proxy(function(response, textStatus) {\n                this.fetchingTimeout = false;\n\n                if (textStatus === 'success') {\n                    // Is there still enough time left or has it been disabled?\n                    if (response.timeout === false || response.timeout >= Craft.ElevatedSessionManager.minSafeElevatedSessionTimeout) {\n                        this.callback();\n                    }\n                    else {\n                        // Show the password modal\n                        this.showPasswordModal();\n                    }\n                }\n            }, this));\n        },\n\n        showPasswordModal: function() {\n            if (!this.passwordModal) {\n                var $passwordModal = $('<form id=\"elevatedsessionmodal\" class=\"modal secure fitted\"/>'),\n                    $body = $('<div class=\"body\"><p>' + Craft.t('app', 'Enter your password to continue.') + '</p></div>').appendTo($passwordModal),\n                    $inputContainer = $('<div class=\"inputcontainer\">').appendTo($body),\n                    $inputsFlexContainer = $('<div class=\"flex\"/>').appendTo($inputContainer),\n                    $passwordContainer = $('<div class=\"flex-grow\"/>').appendTo($inputsFlexContainer),\n                    $buttonContainer= $('<td/>').appendTo($inputsFlexContainer),\n                    $passwordWrapper = $('<div class=\"passwordwrapper\"/>').appendTo($passwordContainer);\n\n                this.$passwordInput = $('<input type=\"password\" class=\"text password fullwidth\" placeholder=\"' + Craft.t('app', 'Password') + '\" autocomplete=\"current-password\"/>').appendTo($passwordWrapper);\n                this.$passwordSpinner = $('<div class=\"spinner hidden\"/>').appendTo($inputContainer);\n                this.$submitBtn = $('<input type=\"submit\" class=\"btn submit disabled\" value=\"' + Craft.t('app', 'Submit') + '\" />').appendTo($buttonContainer);\n                this.$errorPara = $('<p class=\"error\"/>').appendTo($body);\n\n                this.passwordModal = new Garnish.Modal($passwordModal, {\n                    closeOtherModals: false,\n                    onFadeIn: $.proxy(function() {\n                        setTimeout($.proxy(this, 'focusPasswordInput'), 100);\n                    }, this),\n                    onFadeOut: $.proxy(function() {\n                        this.$passwordInput.val('');\n                    }, this)\n                });\n\n                new Craft.PasswordInput(this.$passwordInput, {\n                    onToggleInput: $.proxy(function($newPasswordInput) {\n                        this.$passwordInput = $newPasswordInput;\n                    }, this)\n                });\n\n                this.addListener(this.$passwordInput, 'textchange', 'validatePassword');\n                this.addListener($passwordModal, 'submit', 'submitPassword');\n            }\n            else {\n                this.passwordModal.show();\n            }\n        },\n\n        focusPasswordInput: function() {\n            if (!Garnish.isMobileBrowser(true)) {\n                this.$passwordInput.trigger('focus');\n            }\n        },\n\n        validatePassword: function() {\n            if (this.$passwordInput.val().length >= 6) {\n                this.$submitBtn.removeClass('disabled');\n                return true;\n            }\n            else {\n                this.$submitBtn.addClass('disabled');\n                return false;\n            }\n        },\n\n        submitPassword: function(ev) {\n            if (ev) {\n                ev.preventDefault();\n            }\n\n            if (!this.validatePassword()) {\n                return;\n            }\n\n            this.$passwordSpinner.removeClass('hidden');\n            this.clearLoginError();\n\n            var data = {\n                currentPassword: this.$passwordInput.val()\n            };\n\n            Craft.postActionRequest('users/start-elevated-session', data, $.proxy(function(response, textStatus) {\n                this.$passwordSpinner.addClass('hidden');\n\n                if (textStatus === 'success') {\n                    if (response.success) {\n                        this.passwordModal.hide();\n                        this.callback();\n                    }\n                    else {\n                        this.showPasswordError(response.message || Craft.t('app', 'Incorrect password.'));\n                        Garnish.shake(this.passwordModal.$container);\n                        this.focusPasswordInput();\n                    }\n                }\n                else {\n                    this.showPasswordError();\n                }\n\n            }, this));\n        },\n\n        showPasswordError: function(error) {\n            if (error === null || typeof error === 'undefined') {\n                error = Craft.t('app', 'An unknown error occurred.');\n            }\n\n            this.$errorPara.text(error);\n            this.passwordModal.updateSizeAndPosition();\n        },\n\n        clearLoginError: function() {\n            this.showPasswordError('');\n        }\n    },\n    {\n        minSafeElevatedSessionTimeout: 5\n    });\n\n// Instantiate it\nCraft.elevatedSessionManager = new Craft.ElevatedSessionManager();\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Entry index class\n */\nCraft.EntryIndex = Craft.BaseElementIndex.extend(\n    {\n        publishableSections: null,\n        $newEntryBtnGroup: null,\n        $newEntryBtn: null,\n\n        init: function(elementType, $container, settings) {\n            this.on('selectSource', $.proxy(this, 'updateButton'));\n            this.on('selectSite', $.proxy(this, 'updateButton'));\n            this.base(elementType, $container, settings);\n        },\n\n        afterInit: function() {\n            // Find which of the visible sections the user has permission to create new entries in\n            this.publishableSections = [];\n\n            for (var i = 0; i < Craft.publishableSections.length; i++) {\n                var section = Craft.publishableSections[i];\n\n                if (this.getSourceByKey('section:' + section.uid)) {\n                    this.publishableSections.push(section);\n                }\n            }\n\n            this.base();\n        },\n\n        getDefaultSourceKey: function() {\n            // Did they request a specific section in the URL?\n            if (this.settings.context === 'index' && typeof defaultSectionHandle !== 'undefined') {\n                if (defaultSectionHandle === 'singles') {\n                    return 'singles';\n                }\n                else {\n                    for (var i = 0; i < this.$sources.length; i++) {\n                        var $source = $(this.$sources[i]);\n\n                        if ($source.data('handle') === defaultSectionHandle) {\n                            return $source.data('key');\n                        }\n                    }\n                }\n            }\n\n            return this.base();\n        },\n\n        updateButton: function() {\n            if (!this.$source) {\n                return;\n            }\n\n            var handle;\n\n            // Get the handle of the selected source\n            if (this.$source.data('key') === 'singles') {\n                handle = 'singles';\n            }\n            else {\n                handle = this.$source.data('handle');\n            }\n\n            // Update the New Entry button\n            // ---------------------------------------------------------------------\n\n            var i, href, label;\n\n            if (this.publishableSections.length) {\n                // Remove the old button, if there is one\n                if (this.$newEntryBtnGroup) {\n                    this.$newEntryBtnGroup.remove();\n                }\n\n                // Determine if they are viewing a section that they have permission to create entries in\n                var selectedSection;\n\n                if (handle) {\n                    for (i = 0; i < this.publishableSections.length; i++) {\n                        if (this.publishableSections[i].handle === handle) {\n                            selectedSection = this.publishableSections[i];\n                            break;\n                        }\n                    }\n                }\n\n                this.$newEntryBtnGroup = $('<div class=\"btngroup submit\"/>');\n                var $menuBtn;\n\n                // If they are, show a primary \"New entry\" button, and a dropdown of the other sections (if any).\n                // Otherwise only show a menu button\n                if (selectedSection) {\n                    href = this._getSectionTriggerHref(selectedSection);\n                    label = (this.settings.context === 'index' ? Craft.t('app', 'New entry') : Craft.t('app', 'New {section} entry', {section: selectedSection.name}));\n                    this.$newEntryBtn = $('<a class=\"btn submit add icon\" ' + href + '>' + Craft.escapeHtml(label) + '</a>').appendTo(this.$newEntryBtnGroup);\n\n                    if (this.settings.context !== 'index') {\n                        this.addListener(this.$newEntryBtn, 'click', function(ev) {\n                            this._openCreateEntryModal(ev.currentTarget.getAttribute('data-id'));\n                        });\n                    }\n\n                    if (this.publishableSections.length > 1) {\n                        $menuBtn = $('<div class=\"btn submit menubtn\"></div>').appendTo(this.$newEntryBtnGroup);\n                    }\n                }\n                else {\n                    this.$newEntryBtn = $menuBtn = $('<div class=\"btn submit add icon menubtn\">' + Craft.t('app', 'New entry') + '</div>').appendTo(this.$newEntryBtnGroup);\n                }\n\n                if ($menuBtn) {\n                    var menuHtml = '<div class=\"menu\"><ul>';\n\n                    for (i = 0; i < this.publishableSections.length; i++) {\n                        var section = this.publishableSections[i];\n\n                        if (\n                            (this.settings.context === 'index' && $.inArray(this.siteId, section.sites) !== -1) ||\n                            (this.settings.context !== 'index' && section !== selectedSection)\n                        ) {\n                            href = this._getSectionTriggerHref(section);\n                            label = (this.settings.context === 'index' ? section.name : Craft.t('app', 'New {section} entry', {section: section.name}));\n                            menuHtml += '<li><a ' + href + '\">' + Craft.escapeHtml(label) + '</a></li>';\n                        }\n                    }\n\n                    menuHtml += '</ul></div>';\n\n                    $(menuHtml).appendTo(this.$newEntryBtnGroup);\n                    var menuBtn = new Garnish.MenuBtn($menuBtn);\n\n                    if (this.settings.context !== 'index') {\n                        menuBtn.on('optionSelect', $.proxy(function(ev) {\n                            this._openCreateEntryModal(ev.option.getAttribute('data-id'));\n                        }, this));\n                    }\n                }\n\n                this.addButton(this.$newEntryBtnGroup);\n            }\n\n            // Update the URL if we're on the Entries index\n            // ---------------------------------------------------------------------\n\n            if (this.settings.context === 'index' && typeof history !== 'undefined') {\n                var uri = 'entries';\n\n                if (handle) {\n                    uri += '/' + handle;\n                }\n\n                history.replaceState({}, '', Craft.getUrl(uri));\n            }\n        },\n\n        _getSectionTriggerHref: function(section) {\n            if (this.settings.context === 'index') {\n                var uri = 'entries/' + section.handle + '/new';\n                params = {};\n                if (this.siteId) {\n                    for (var i = 0; i < Craft.sites.length; i++) {\n                        if (Craft.sites[i].id == this.siteId) {\n                            params.site = Craft.sites[i].handle;\n                        }\n                    }\n                }\n                return 'href=\"' + Craft.getUrl(uri, params) + '\"';\n            } else {\n                return 'data-id=\"' + section.id + '\"';\n            }\n        },\n\n        _openCreateEntryModal: function(sectionId) {\n            if (this.$newEntryBtn.hasClass('loading')) {\n                return;\n            }\n\n            // Find the section\n            var section;\n\n            for (var i = 0; i < this.publishableSections.length; i++) {\n                if (this.publishableSections[i].id == sectionId) {\n                    section = this.publishableSections[i];\n                    break;\n                }\n            }\n\n            if (!section) {\n                return;\n            }\n\n            this.$newEntryBtn.addClass('inactive');\n            var newEntryBtnText = this.$newEntryBtn.text();\n            this.$newEntryBtn.text(Craft.t('app', 'New {section} entry', {section: section.name}));\n\n            Craft.createElementEditor(this.elementType, {\n                hudTrigger: this.$newEntryBtnGroup,\n                elementType: 'craft\\\\elements\\\\Entry',\n                siteId: this.siteId,\n                attributes: {\n                    sectionId: sectionId,\n                    typeId: section.entryTypes[0].id\n                },\n                onBeginLoading: $.proxy(function() {\n                    this.$newEntryBtn.addClass('loading');\n                }, this),\n                onEndLoading: $.proxy(function() {\n                    this.$newEntryBtn.removeClass('loading');\n                }, this),\n                onHideHud: $.proxy(function() {\n                    this.$newEntryBtn.removeClass('inactive').text(newEntryBtnText);\n                }, this),\n                onSaveElement: $.proxy(function(response) {\n                    // Make sure the right section is selected\n                    var sectionSourceKey = 'section:' + section.uid;\n\n                    if (this.sourceKey !== sectionSourceKey) {\n                        this.selectSourceByKey(sectionSourceKey);\n                    }\n\n                    this.selectElementAfterUpdate(response.id);\n                    this.updateElements();\n                }, this)\n            });\n        }\n    });\n\n// Register it!\nCraft.registerElementIndexClass('craft\\\\elements\\\\Entry', Craft.EntryIndex);\n\n/** global: Craft */\n/** global: Garnish */\nCraft.FieldLayoutDesigner = Garnish.Base.extend(\n    {\n        $container: null,\n        $tabContainer: null,\n        $unusedFieldContainer: null,\n        $newTabBtn: null,\n        $allFields: null,\n\n        tabGrid: null,\n        unusedFieldGrid: null,\n\n        tabDrag: null,\n        fieldDrag: null,\n\n        init: function(container, settings) {\n            this.$container = $(container);\n            this.setSettings(settings, Craft.FieldLayoutDesigner.defaults);\n\n            this.$tabContainer = this.$container.children('.fld-tabs');\n            this.$unusedFieldContainer = this.$container.children('.unusedfields');\n            this.$newTabBtn = this.$container.find('> .newtabbtn-container > .btn');\n            this.$allFields = this.$unusedFieldContainer.find('.fld-field');\n\n            // Set up the layout grids\n            this.tabGrid = new Craft.Grid(this.$tabContainer, Craft.FieldLayoutDesigner.gridSettings);\n            this.unusedFieldGrid = new Craft.Grid(this.$unusedFieldContainer, Craft.FieldLayoutDesigner.gridSettings);\n\n            var $tabs = this.$tabContainer.children();\n            for (var i = 0; i < $tabs.length; i++) {\n                this.initTab($($tabs[i]));\n            }\n\n            this.fieldDrag = new Craft.FieldLayoutDesigner.FieldDrag(this);\n\n            if (this.settings.customizableTabs) {\n                this.tabDrag = new Craft.FieldLayoutDesigner.TabDrag(this);\n\n                this.addListener(this.$newTabBtn, 'activate', 'addTab');\n            }\n        },\n\n        initTab: function($tab) {\n            if (this.settings.customizableTabs) {\n                var $editBtn = $tab.find('.tabs .settings'),\n                    $menu = $('<div class=\"menu\" data-align=\"center\"/>').insertAfter($editBtn),\n                    $ul = $('<ul/>').appendTo($menu);\n\n                $('<li><a data-action=\"rename\">' + Craft.t('app', 'Rename') + '</a></li>').appendTo($ul);\n                $('<li><a data-action=\"delete\">' + Craft.t('app', 'Delete') + '</a></li>').appendTo($ul);\n\n                new Garnish.MenuBtn($editBtn, {\n                    onOptionSelect: $.proxy(this, 'onTabOptionSelect')\n                });\n            }\n\n            // Don't forget the fields!\n            var $fields = $tab.children('.fld-tabcontent').children();\n\n            for (var i = 0; i < $fields.length; i++) {\n                this.initField($($fields[i]));\n            }\n        },\n\n        initField: function($field) {\n            var $editBtn = $field.find('.settings'),\n                $menu = $('<div class=\"menu\" data-align=\"center\"/>').insertAfter($editBtn),\n                $ul = $('<ul/>').appendTo($menu);\n\n            if ($field.hasClass('fld-required')) {\n                $('<li><a data-action=\"toggle-required\">' + Craft.t('app', 'Make not required') + '</a></li>').appendTo($ul);\n            }\n            else {\n                $('<li><a data-action=\"toggle-required\">' + Craft.t('app', 'Make required') + '</a></li>').appendTo($ul);\n            }\n\n            $('<li><a data-action=\"remove\">' + Craft.t('app', 'Remove') + '</a></li>').appendTo($ul);\n\n            new Garnish.MenuBtn($editBtn, {\n                onOptionSelect: $.proxy(this, 'onFieldOptionSelect')\n            });\n        },\n\n        onTabOptionSelect: function(option) {\n            if (!this.settings.customizableTabs) {\n                return;\n            }\n\n            var $option = $(option),\n                $tab = $option.data('menu').$anchor.parent().parent().parent(),\n                action = $option.data('action');\n\n            switch (action) {\n                case 'rename': {\n                    this.renameTab($tab);\n                    break;\n                }\n                case 'delete': {\n                    this.deleteTab($tab);\n                    break;\n                }\n            }\n        },\n\n        onFieldOptionSelect: function(option) {\n            var $option = $(option),\n                $field = $option.data('menu').$anchor.parent(),\n                action = $option.data('action');\n\n            switch (action) {\n                case 'toggle-required': {\n                    this.toggleRequiredField($field, $option);\n                    break;\n                }\n                case 'remove': {\n                    this.removeField($field);\n                    break;\n                }\n            }\n        },\n\n        renameTab: function($tab) {\n            if (!this.settings.customizableTabs) {\n                return;\n            }\n\n            var $labelSpan = $tab.find('.tabs .tab span'),\n                oldName = $labelSpan.text(),\n                newName = prompt(Craft.t('app', 'Give your tab a name.'), oldName);\n\n            if (newName && newName !== oldName) {\n                $labelSpan.text(newName);\n                $tab.find('.id-input').attr('name', this.getFieldInputName(newName));\n            }\n        },\n\n        deleteTab: function($tab) {\n            if (!this.settings.customizableTabs) {\n                return;\n            }\n\n            // Find all the fields in this tab\n            var $fields = $tab.find('.fld-field');\n\n            for (var i = 0; i < $fields.length; i++) {\n                var fieldId = $($fields[i]).attr('data-id');\n                this.removeFieldById(fieldId);\n            }\n\n            this.tabGrid.removeItems($tab);\n            this.tabDrag.removeItems($tab);\n\n            $tab.remove();\n        },\n\n        toggleRequiredField: function($field, $option) {\n            if ($field.hasClass('fld-required')) {\n                $field.removeClass('fld-required');\n                $field.find('.required-input').remove();\n\n                setTimeout(function() {\n                    $option.text(Craft.t('app', 'Make required'));\n                }, 500);\n            }\n            else {\n                $field.addClass('fld-required');\n                $('<input class=\"required-input\" type=\"hidden\" name=\"' + this.settings.requiredFieldInputName + '\" value=\"' + $field.data('id') + '\">').appendTo($field);\n\n                setTimeout(function() {\n                    $option.text(Craft.t('app', 'Make not required'));\n                }, 500);\n            }\n        },\n\n        removeField: function($field) {\n            var fieldId = $field.attr('data-id');\n\n            $field.remove();\n\n            this.removeFieldById(fieldId);\n            this.tabGrid.refreshCols(true);\n        },\n\n        removeFieldById: function(fieldId) {\n            var $field = this.$allFields.filter('[data-id=' + fieldId + ']:first'),\n                $group = $field.closest('.fld-tab');\n\n            $field.removeClass('hidden');\n\n            if ($group.hasClass('hidden')) {\n                $group.removeClass('hidden');\n                this.unusedFieldGrid.addItems($group);\n\n                if (this.settings.customizableTabs) {\n                    this.tabDrag.addItems($group);\n                }\n            }\n            else {\n                this.unusedFieldGrid.refreshCols(true);\n            }\n        },\n\n        addTab: function() {\n            if (!this.settings.customizableTabs) {\n                return;\n            }\n\n            var $tab = $('<div class=\"fld-tab\">' +\n                '<div class=\"tabs\">' +\n                '<div class=\"tab sel draggable\">' +\n                '<span>Tab ' + (this.tabGrid.$items.length + 1) + '</span>' +\n                '<a class=\"settings icon\" title=\"' + Craft.t('app', 'Rename') + '\"></a>' +\n                '</div>' +\n                '</div>' +\n                '<div class=\"fld-tabcontent\"></div>' +\n                '</div>').appendTo(this.$tabContainer);\n\n            this.tabGrid.addItems($tab);\n            this.tabDrag.addItems($tab);\n\n            this.initTab($tab);\n        },\n\n        getFieldInputName: function(tabName) {\n            return this.settings.fieldInputName.replace(/__TAB_NAME__/g, Craft.encodeUriComponent(tabName));\n        }\n    },\n    {\n        gridSettings: {\n            itemSelector: '.fld-tab:not(.hidden)',\n            minColWidth: 240,\n            fillMode: 'grid',\n            snapToGrid: 30\n        },\n        defaults: {\n            customizableTabs: true,\n            fieldInputName: 'fieldLayout[__TAB_NAME__][]',\n            requiredFieldInputName: 'requiredFields[]'\n        }\n    });\n\n\nCraft.FieldLayoutDesigner.BaseDrag = Garnish.Drag.extend(\n    {\n        designer: null,\n        $insertion: null,\n        showingInsertion: false,\n        $caboose: null,\n        draggingUnusedItem: false,\n        addToTabGrid: false,\n\n        /**\n         * Constructor\n         */\n        init: function(designer, settings) {\n            this.designer = designer;\n\n            // Find all the items from both containers\n            var $items = this.designer.$tabContainer.find(this.itemSelector)\n                .add(this.designer.$unusedFieldContainer.find(this.itemSelector));\n\n            this.base($items, settings);\n        },\n\n        /**\n         * On Drag Start\n         */\n        onDragStart: function() {\n            this.base();\n\n            // Are we dragging an unused item?\n            this.draggingUnusedItem = this.$draggee.hasClass('unused');\n\n            // Create the insertion\n            this.$insertion = this.getInsertion();\n\n            // Add the caboose\n            this.addCaboose();\n            this.$items = $().add(this.$items.add(this.$caboose));\n\n            if (this.addToTabGrid) {\n                this.designer.tabGrid.addItems(this.$caboose);\n            }\n\n            // Swap the draggee with the insertion if dragging a selected item\n            if (this.draggingUnusedItem) {\n                this.showingInsertion = false;\n            }\n            else {\n                // Actually replace the draggee with the insertion\n                this.$insertion.insertBefore(this.$draggee);\n                this.$draggee.detach();\n                this.$items = $().add(this.$items.not(this.$draggee).add(this.$insertion));\n                this.showingInsertion = true;\n\n                if (this.addToTabGrid) {\n                    this.designer.tabGrid.removeItems(this.$draggee);\n                    this.designer.tabGrid.addItems(this.$insertion);\n                }\n            }\n\n            this.setMidpoints();\n        },\n\n        /**\n         * Append the caboose\n         */\n        addCaboose: $.noop,\n\n        /**\n         * Returns the item's container\n         */\n        getItemContainer: $.noop,\n\n        /**\n         * Tests if an item is within the tab container.\n         */\n        isItemInTabContainer: function($item) {\n            return (this.getItemContainer($item)[0] === this.designer.$tabContainer[0]);\n        },\n\n        /**\n         * Sets the item midpoints up front so we don't have to keep checking on every mouse move\n         */\n        setMidpoints: function() {\n            for (var i = 0; i < this.$items.length; i++) {\n                var $item = $(this.$items[i]);\n\n                // Skip the unused tabs\n                if (!this.isItemInTabContainer($item)) {\n                    continue;\n                }\n\n                var offset = $item.offset();\n\n                $item.data('midpoint', {\n                    left: offset.left + $item.outerWidth() / 2,\n                    top: offset.top + $item.outerHeight() / 2\n                });\n            }\n        },\n\n        /**\n         * On Drag\n         */\n        onDrag: function() {\n            // Are we hovering over the tab container?\n            if (this.draggingUnusedItem && !Garnish.hitTest(this.mouseX, this.mouseY, this.designer.$tabContainer)) {\n                if (this.showingInsertion) {\n                    this.$insertion.remove();\n                    this.$items = $().add(this.$items.not(this.$insertion));\n                    this.showingInsertion = false;\n\n                    if (this.addToTabGrid) {\n                        this.designer.tabGrid.removeItems(this.$insertion);\n                    }\n                    else {\n                        this.designer.tabGrid.refreshCols(true);\n                    }\n\n                    this.setMidpoints();\n                }\n            }\n            else {\n                // Is there a new closest item?\n                this.onDrag._closestItem = this.getClosestItem();\n\n                if (this.onDrag._closestItem !== this.$insertion[0]) {\n                    if (this.showingInsertion &&\n                        ($.inArray(this.$insertion[0], this.$items) < $.inArray(this.onDrag._closestItem, this.$items)) &&\n                        ($.inArray(this.onDrag._closestItem, this.$caboose) === -1)\n                    ) {\n                        this.$insertion.insertAfter(this.onDrag._closestItem);\n                    }\n                    else {\n                        this.$insertion.insertBefore(this.onDrag._closestItem);\n                    }\n\n                    this.$items = $().add(this.$items.add(this.$insertion));\n                    this.showingInsertion = true;\n\n                    if (this.addToTabGrid) {\n                        this.designer.tabGrid.addItems(this.$insertion);\n                    }\n                    else {\n                        this.designer.tabGrid.refreshCols(true);\n                    }\n\n                    this.setMidpoints();\n                }\n            }\n\n            this.base();\n        },\n\n        /**\n         * Returns the closest item to the cursor.\n         */\n        getClosestItem: function() {\n            this.getClosestItem._closestItem = null;\n            this.getClosestItem._closestItemMouseDiff = null;\n\n            for (this.getClosestItem._i = 0; this.getClosestItem._i < this.$items.length; this.getClosestItem._i++) {\n                this.getClosestItem._$item = $(this.$items[this.getClosestItem._i]);\n\n                // Skip the unused tabs\n                if (!this.isItemInTabContainer(this.getClosestItem._$item)) {\n                    continue;\n                }\n\n                this.getClosestItem._midpoint = this.getClosestItem._$item.data('midpoint');\n                this.getClosestItem._mouseDiff = Garnish.getDist(this.getClosestItem._midpoint.left, this.getClosestItem._midpoint.top, this.mouseX, this.mouseY);\n\n                if (this.getClosestItem._closestItem === null || this.getClosestItem._mouseDiff < this.getClosestItem._closestItemMouseDiff) {\n                    this.getClosestItem._closestItem = this.getClosestItem._$item[0];\n                    this.getClosestItem._closestItemMouseDiff = this.getClosestItem._mouseDiff;\n                }\n            }\n\n            return this.getClosestItem._closestItem;\n        },\n\n        /**\n         * On Drag Stop\n         */\n        onDragStop: function() {\n            if (this.showingInsertion) {\n                this.$insertion.replaceWith(this.$draggee);\n                this.$items = $().add(this.$items.not(this.$insertion).add(this.$draggee));\n\n                if (this.addToTabGrid) {\n                    this.designer.tabGrid.removeItems(this.$insertion);\n                    this.designer.tabGrid.addItems(this.$draggee);\n                }\n            }\n\n            // Drop the caboose\n            this.$items = this.$items.not(this.$caboose);\n            this.$caboose.remove();\n\n            if (this.addToTabGrid) {\n                this.designer.tabGrid.removeItems(this.$caboose);\n            }\n\n            // \"show\" the drag items, but make them invisible\n            this.$draggee.css({\n                display: this.draggeeDisplay,\n                visibility: 'hidden'\n            });\n\n            this.designer.tabGrid.refreshCols(true);\n            this.designer.unusedFieldGrid.refreshCols(true);\n\n            // return the helpers to the draggees\n            this.returnHelpersToDraggees();\n\n            this.base();\n        }\n    });\n\n\nCraft.FieldLayoutDesigner.TabDrag = Craft.FieldLayoutDesigner.BaseDrag.extend(\n    {\n        itemSelector: '> div.fld-tab',\n        addToTabGrid: true,\n\n        /**\n         * Constructor\n         */\n        init: function(designer) {\n            var settings = {\n                handle: '.tab'\n            };\n\n            this.base(designer, settings);\n        },\n\n        /**\n         * Append the caboose\n         */\n        addCaboose: function() {\n            this.$caboose = $('<div class=\"fld-tab fld-tab-caboose\"/>').appendTo(this.designer.$tabContainer);\n        },\n\n        /**\n         * Returns the insertion\n         */\n        getInsertion: function() {\n            var $tab = this.$draggee.find('.tab');\n\n            return $('<div class=\"fld-tab fld-insertion\" style=\"height: ' + this.$draggee.height() + 'px;\">' +\n                '<div class=\"tabs\"><div class=\"tab sel draggable\" style=\"width: ' + $tab.width() + 'px; height: ' + $tab.height() + 'px;\"></div></div>' +\n                '<div class=\"fld-tabcontent\" style=\"height: ' + this.$draggee.find('.fld-tabcontent').height() + 'px;\"></div>' +\n                '</div>');\n        },\n\n        /**\n         * Returns the item's container\n         */\n        getItemContainer: function($item) {\n            return $item.parent();\n        },\n\n        /**\n         * On Drag Stop\n         */\n        onDragStop: function() {\n            if (this.draggingUnusedItem && this.showingInsertion) {\n                // Create a new tab based on that field group\n                var $tab = this.$draggee.clone().removeClass('unused'),\n                    tabName = $tab.find('.tab span').text();\n\n                $tab.find('.fld-field').removeClass('unused');\n\n                // Add the edit button\n                $tab.find('.tabs .tab').append('<a class=\"settings icon\" title=\"' + Craft.t('app', 'Edit') + '\"></a>');\n\n                // Remove any hidden fields\n                var $fields = $tab.find('.fld-field'),\n                    $hiddenFields = $fields.filter('.hidden').remove();\n\n                $fields = $fields.not($hiddenFields);\n                $fields.prepend('<a class=\"settings icon\" title=\"' + Craft.t('app', 'Edit') + '\"></a>');\n\n                for (var i = 0; i < $fields.length; i++) {\n                    var $field = $($fields[i]),\n                        inputName = this.designer.getFieldInputName(tabName);\n\n                    $field.append('<input class=\"id-input\" type=\"hidden\" name=\"' + inputName + '\" value=\"' + $field.data('id') + '\">');\n                }\n\n                this.designer.fieldDrag.addItems($fields);\n\n                this.designer.initTab($tab);\n\n                // Set the unused field group and its fields to hidden\n                this.$draggee.css({visibility: 'inherit', display: 'field'}).addClass('hidden');\n                this.$draggee.find('.fld-field').addClass('hidden');\n\n                // Set this.$draggee to the clone, as if we were dragging that all along\n                this.$draggee = $tab;\n\n                // Remember it for later\n                this.addItems($tab);\n\n                // Update the grids\n                this.designer.tabGrid.addItems($tab);\n                this.designer.unusedFieldGrid.removeItems(this.$draggee);\n            }\n\n            this.base();\n        }\n    });\n\n\nCraft.FieldLayoutDesigner.FieldDrag = Craft.FieldLayoutDesigner.BaseDrag.extend(\n    {\n        itemSelector: '> div.fld-tab .fld-field',\n\n        /**\n         * Append the caboose\n         */\n        addCaboose: function() {\n            this.$caboose = $();\n\n            var $fieldContainers = this.designer.$tabContainer.children().children('.fld-tabcontent');\n\n            for (var i = 0; i < $fieldContainers.length; i++) {\n                var $caboose = $('<div class=\"fld-tab fld-tab-caboose\"/>').appendTo($fieldContainers[i]);\n                this.$caboose = this.$caboose.add($caboose);\n            }\n        },\n\n        /**\n         * Returns the insertion\n         */\n        getInsertion: function() {\n            return $('<div class=\"fld-field fld-insertion\" style=\"height: ' + this.$draggee.height() + 'px;\"/>');\n        },\n\n        /**\n         * Returns the item's container\n         */\n        getItemContainer: function($item) {\n            return $item.parent().parent().parent();\n        },\n\n        /**\n         * On Drag Stop\n         */\n        onDragStop: function() {\n            if (this.draggingUnusedItem && this.showingInsertion) {\n                // Create a new field based on that one\n                var $field = this.$draggee.clone().removeClass('unused');\n                $field.prepend('<a class=\"settings icon\" title=\"' + Craft.t('app', 'Edit') + '\"></a>');\n                this.designer.initField($field);\n\n                // Hide the unused field\n                this.$draggee.css({visibility: 'inherit', display: 'field'}).addClass('hidden');\n\n                // Hide the group too?\n                if (this.$draggee.siblings(':not(.hidden)').length === 0) {\n                    var $group = this.$draggee.parent().parent();\n                    $group.addClass('hidden');\n                    this.designer.unusedFieldGrid.removeItems($group);\n                }\n\n                // Set this.$draggee to the clone, as if we were dragging that all along\n                this.$draggee = $field;\n\n                // Remember it for later\n                this.addItems($field);\n            }\n\n            if (this.showingInsertion) {\n                // Find the field's new tab name\n                var tabName = this.$insertion.parent().parent().find('.tab span').text(),\n                    inputName = this.designer.getFieldInputName(tabName);\n\n                if (this.draggingUnusedItem) {\n                    this.$draggee.append('<input class=\"id-input\" type=\"hidden\" name=\"' + inputName + '\" value=\"' + this.$draggee.data('id') + '\">');\n                }\n                else {\n                    this.$draggee.find('.id-input').attr('name', inputName);\n                }\n            }\n\n            this.base();\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * FieldToggle\n */\nCraft.FieldToggle = Garnish.Base.extend(\n    {\n        $toggle: null,\n        targetPrefix: null,\n        targetSelector: null,\n        reverseTargetSelector: null,\n\n        _$target: null,\n        _$reverseTarget: null,\n        type: null,\n\n        init: function(toggle) {\n            this.$toggle = $(toggle);\n\n            // Is this already a field toggle?\n            if (this.$toggle.data('fieldtoggle')) {\n                Garnish.log('Double-instantiating a field toggle on an element');\n                this.$toggle.data('fieldtoggle').destroy();\n            }\n\n            this.$toggle.data('fieldtoggle', this);\n\n            this.type = this.getType();\n\n            if (this.type === 'select') {\n                this.targetPrefix = (this.$toggle.attr('data-target-prefix') || '');\n            }\n            else {\n                this.targetSelector = this.normalizeTargetSelector(this.$toggle.data('target'));\n                this.reverseTargetSelector = this.normalizeTargetSelector(this.$toggle.data('reverse-target'));\n            }\n\n            this.findTargets();\n\n            if (this.type === 'link') {\n                this.addListener(this.$toggle, 'click', 'onToggleChange');\n            }\n            else {\n                this.addListener(this.$toggle, 'change', 'onToggleChange');\n            }\n        },\n\n        normalizeTargetSelector: function(selector) {\n            if (selector && !selector.match(/^[#\\.]/)) {\n                selector = '#' + selector;\n            }\n\n            return selector;\n        },\n\n        getType: function() {\n            if (this.$toggle.prop('nodeName') === 'INPUT' && this.$toggle.attr('type').toLowerCase() === 'checkbox') {\n                return 'checkbox';\n            }\n            else if (this.$toggle.prop('nodeName') === 'SELECT') {\n                return 'select';\n            }\n            else if (this.$toggle.prop('nodeName') === 'A') {\n                return 'link';\n            }\n            else if (this.$toggle.prop('nodeName') === 'DIV' && this.$toggle.hasClass('lightswitch')) {\n                return 'lightswitch';\n            }\n        },\n\n        findTargets: function() {\n            if (this.type === 'select') {\n                this._$target = $(this.normalizeTargetSelector(this.targetPrefix + this.getToggleVal()));\n            }\n            else {\n                if (this.targetSelector) {\n                    this._$target = $(this.targetSelector);\n                }\n\n                if (this.reverseTargetSelector) {\n                    this._$reverseTarget = $(this.reverseTargetSelector);\n                }\n            }\n        },\n\n        getToggleVal: function() {\n            if (this.type === 'lightswitch') {\n                return this.$toggle.children('input').val();\n            }\n            else {\n                var postVal = Garnish.getInputPostVal(this.$toggle);\n                return postVal === null ? null : postVal.replace(/[\\[\\]\\\\]+/g, '-');\n            }\n        },\n\n        onToggleChange: function() {\n            if (this.type === 'select') {\n                this.hideTarget(this._$target);\n                this.findTargets();\n                this.showTarget(this._$target);\n            }\n            else {\n                if (this.type === 'link') {\n                    this.onToggleChange._show = this.$toggle.hasClass('collapsed') || !this.$toggle.hasClass('expanded');\n                }\n                else {\n                    this.onToggleChange._show = !!this.getToggleVal();\n                }\n\n                if (this.onToggleChange._show) {\n                    this.showTarget(this._$target);\n                    this.hideTarget(this._$reverseTarget);\n                }\n                else {\n                    this.hideTarget(this._$target);\n                    this.showTarget(this._$reverseTarget);\n                }\n\n                delete this.onToggleChange._show;\n            }\n        },\n\n        showTarget: function($target) {\n            if ($target && $target.length) {\n                this.showTarget._currentHeight = $target.height();\n\n                $target.removeClass('hidden');\n\n                if (this.type !== 'select') {\n                    if (this.type === 'link') {\n                        this.$toggle.removeClass('collapsed');\n                        this.$toggle.addClass('expanded');\n                    }\n\n                    $target.height('auto');\n                    this.showTarget._targetHeight = $target.height();\n                    $target.css({\n                        height: this.showTarget._currentHeight,\n                        overflow: 'hidden'\n                    });\n\n                    $target.velocity('stop');\n\n                    $target.velocity({height: this.showTarget._targetHeight}, 'fast', function() {\n                        $target.css({\n                            height: '',\n                            overflow: ''\n                        });\n                    });\n\n                    delete this.showTarget._targetHeight;\n                }\n\n                delete this.showTarget._currentHeight;\n\n                // Trigger a resize event in case there are any grids in the target that need to initialize\n                Garnish.$win.trigger('resize');\n            }\n        },\n\n        hideTarget: function($target) {\n            if ($target && $target.length) {\n                if (this.type === 'select') {\n                    $target.addClass('hidden');\n                }\n                else {\n                    if (this.type === 'link') {\n                        this.$toggle.removeClass('expanded');\n                        this.$toggle.addClass('collapsed');\n                    }\n\n                    $target.css('overflow', 'hidden');\n                    $target.velocity('stop');\n                    $target.velocity({height: 0}, 'fast', function() {\n                        $target.addClass('hidden');\n                    });\n                }\n            }\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\nCraft.Grid = Garnish.Base.extend(\n    {\n        $container: null,\n\n        $items: null,\n        items: null,\n        totalCols: null,\n        colGutterDrop: null,\n        colPctWidth: null,\n\n        possibleItemColspans: null,\n        possibleItemPositionsByColspan: null,\n\n        itemPositions: null,\n        itemColspansByPosition: null,\n\n        layouts: null,\n        layout: null,\n        itemHeights: null,\n        leftPadding: null,\n\n        _refreshingCols: false,\n        _refreshColsAfterRefresh: false,\n        _forceRefreshColsAfterRefresh: false,\n\n        init: function(container, settings) {\n            this.$container = $(container);\n\n            // Is this already a grid?\n            if (this.$container.data('grid')) {\n                Garnish.log('Double-instantiating a grid on an element');\n                this.$container.data('grid').destroy();\n            }\n\n            this.$container.data('grid', this);\n\n            this.setSettings(settings, Craft.Grid.defaults);\n\n            // Set the refreshCols() proxy that container resizes will trigger\n            this.handleContainerHeightProxy = $.proxy(function() {\n                this.refreshCols(false, true);\n            }, this);\n\n            this.$items = this.$container.children(this.settings.itemSelector);\n            this.setItems();\n            this.refreshCols(true, false);\n\n            Garnish.$doc.ready($.proxy(function() {\n                this.refreshCols(false, false);\n            }, this));\n        },\n\n        addItems: function(items) {\n            this.$items = $().add(this.$items.add(items));\n            this.setItems();\n            this.refreshCols(true, true);\n        },\n\n        removeItems: function(items) {\n            this.$items = $().add(this.$items.not(items));\n            this.setItems();\n            this.refreshCols(true, true);\n        },\n\n        resetItemOrder: function() {\n            this.$items = $().add(this.$items);\n            this.setItems();\n            this.refreshCols(true, true);\n        },\n\n        setItems: function() {\n            this.setItems._ = {};\n\n            this.items = [];\n\n            for (this.setItems._.i = 0; this.setItems._.i < this.$items.length; this.setItems._.i++) {\n                this.items.push($(this.$items[this.setItems._.i]));\n            }\n\n            delete this.setItems._;\n        },\n\n        refreshCols: function(force) {\n            if (this._refreshingCols) {\n                this._refreshColsAfterRefresh = true;\n                if (force) {\n                    this._forceRefreshColsAfterRefresh = true;\n                }\n                return;\n            }\n\n            this._refreshingCols = true;\n\n            if (!this.items.length) {\n                this.completeRefreshCols();\n                return;\n            }\n\n            this.refreshCols._ = {};\n\n            // Check to see if the grid is actually visible\n            this.refreshCols._.oldHeight = this.$container[0].style.height;\n            this.$container[0].style.height = 1;\n            this.refreshCols._.scrollHeight = this.$container[0].scrollHeight;\n            this.$container[0].style.height = this.refreshCols._.oldHeight;\n\n            if (this.refreshCols._.scrollHeight === 0) {\n                this.completeRefreshCols();\n                return;\n            }\n\n            if (this.settings.cols) {\n                this.refreshCols._.totalCols = this.settings.cols;\n            }\n            else {\n                this.refreshCols._.totalCols = Math.floor(this.$container.width() / this.settings.minColWidth);\n\n                // If we're adding a new column, require an extra 20 pixels in case a scrollbar shows up\n                if (this.totalCols !== null && this.refreshCols._.totalCols > this.totalCols) {\n                    this.refreshCols._.totalCols = Math.floor((this.$container.width() - 20) / this.settings.minColWidth)\n                }\n\n                if (this.settings.maxCols && this.refreshCols._.totalCols > this.settings.maxCols) {\n                    this.refreshCols._.totalCols = this.settings.maxCols;\n                }\n            }\n\n            if (this.refreshCols._.totalCols === 0) {\n                this.refreshCols._.totalCols = 1;\n            }\n\n            // Same number of columns as before?\n            if (force !== true && this.totalCols === this.refreshCols._.totalCols) {\n                this.completeRefreshCols();\n                return;\n            }\n\n            this.totalCols = this.refreshCols._.totalCols;\n            this.colGutterDrop = this.settings.gutter * (this.totalCols - 1) / this.totalCols;\n\n            // Temporarily stop listening to container resizes\n            this.removeListener(this.$container, 'resize');\n\n            if (this.settings.fillMode === 'grid') {\n                this.refreshCols._.itemIndex = 0;\n\n                while (this.refreshCols._.itemIndex < this.items.length) {\n                    // Append the next X items and figure out which one is the tallest\n                    this.refreshCols._.tallestItemHeight = -1;\n                    this.refreshCols._.colIndex = 0;\n\n                    for (this.refreshCols._.i = this.refreshCols._.itemIndex; (this.refreshCols._.i < this.refreshCols._.itemIndex + this.totalCols && this.refreshCols._.i < this.items.length); this.refreshCols._.i++) {\n                        this.refreshCols._.itemHeight = this.items[this.refreshCols._.i].height('auto').height();\n\n                        if (this.refreshCols._.itemHeight > this.refreshCols._.tallestItemHeight) {\n                            this.refreshCols._.tallestItemHeight = this.refreshCols._.itemHeight;\n                        }\n\n                        this.refreshCols._.colIndex++;\n                    }\n\n                    if (this.settings.snapToGrid) {\n                        this.refreshCols._.remainder = this.refreshCols._.tallestItemHeight % this.settings.snapToGrid;\n\n                        if (this.refreshCols._.remainder) {\n                            this.refreshCols._.tallestItemHeight += this.settings.snapToGrid - this.refreshCols._.remainder;\n                        }\n                    }\n\n                    // Now set their heights to the tallest one\n                    for (this.refreshCols._.i = this.refreshCols._.itemIndex; (this.refreshCols._.i < this.refreshCols._.itemIndex + this.totalCols && this.refreshCols._.i < this.items.length); this.refreshCols._.i++) {\n                        this.items[this.refreshCols._.i].height(this.refreshCols._.tallestItemHeight);\n                    }\n\n                    // set the this.refreshCols._.itemIndex pointer to the next one up\n                    this.refreshCols._.itemIndex += this.totalCols;\n                }\n            }\n            else {\n                this.removeListener(this.$items, 'resize');\n\n                // If there's only one column, sneak out early\n                if (this.totalCols === 1) {\n                    this.$container.height('auto');\n                    this.$items\n                        .show()\n                        .css({\n                            position: 'relative',\n                            width: 'auto',\n                            top: 0\n                        })\n                        .css(Craft.left, 0);\n                }\n                else {\n                    this.$items.css('position', 'absolute');\n                    this.colPctWidth = (100 / this.totalCols);\n\n                    // The setup\n\n                    this.layouts = [];\n\n                    this.itemPositions = [];\n                    this.itemColspansByPosition = [];\n\n                    // Figure out all of the possible colspans for each item,\n                    // as well as all the possible positions for each item at each of its colspans\n\n                    this.possibleItemColspans = [];\n                    this.possibleItemPositionsByColspan = [];\n                    this.itemHeightsByColspan = [];\n\n                    for (this.refreshCols._.item = 0; this.refreshCols._.item < this.items.length; this.refreshCols._.item++) {\n                        this.possibleItemColspans[this.refreshCols._.item] = [];\n                        this.possibleItemPositionsByColspan[this.refreshCols._.item] = {};\n                        this.itemHeightsByColspan[this.refreshCols._.item] = {};\n\n                        this.refreshCols._.$item = this.items[this.refreshCols._.item].show();\n                        this.refreshCols._.positionRight = (this.refreshCols._.$item.data('position') === 'right');\n                        this.refreshCols._.positionLeft = (this.refreshCols._.$item.data('position') === 'left');\n                        this.refreshCols._.minColspan = (this.refreshCols._.$item.data('colspan') ? this.refreshCols._.$item.data('colspan') : (this.refreshCols._.$item.data('min-colspan') ? this.refreshCols._.$item.data('min-colspan') : 1));\n                        this.refreshCols._.maxColspan = (this.refreshCols._.$item.data('colspan') ? this.refreshCols._.$item.data('colspan') : (this.refreshCols._.$item.data('max-colspan') ? this.refreshCols._.$item.data('max-colspan') : this.totalCols));\n\n                        if (this.refreshCols._.minColspan > this.totalCols) {\n                            this.refreshCols._.minColspan = this.totalCols;\n                        }\n                        if (this.refreshCols._.maxColspan > this.totalCols) {\n                            this.refreshCols._.maxColspan = this.totalCols;\n                        }\n\n                        for (this.refreshCols._.colspan = this.refreshCols._.minColspan; this.refreshCols._.colspan <= this.refreshCols._.maxColspan; this.refreshCols._.colspan++) {\n                            // Get the height for this colspan\n                            this.refreshCols._.$item.css('width', this.getItemWidthCss(this.refreshCols._.colspan));\n                            this.itemHeightsByColspan[this.refreshCols._.item][this.refreshCols._.colspan] = this.refreshCols._.$item.outerHeight();\n\n                            this.possibleItemColspans[this.refreshCols._.item].push(this.refreshCols._.colspan);\n                            this.possibleItemPositionsByColspan[this.refreshCols._.item][this.refreshCols._.colspan] = [];\n\n                            if (this.refreshCols._.positionLeft) {\n                                this.refreshCols._.minPosition = 0;\n                                this.refreshCols._.maxPosition = 0;\n                            }\n                            else if (this.refreshCols._.positionRight) {\n                                this.refreshCols._.minPosition = this.totalCols - this.refreshCols._.colspan;\n                                this.refreshCols._.maxPosition = this.refreshCols._.minPosition;\n                            }\n                            else {\n                                this.refreshCols._.minPosition = 0;\n                                this.refreshCols._.maxPosition = this.totalCols - this.refreshCols._.colspan;\n                            }\n\n                            for (this.refreshCols._.position = this.refreshCols._.minPosition; this.refreshCols._.position <= this.refreshCols._.maxPosition; this.refreshCols._.position++) {\n                                this.possibleItemPositionsByColspan[this.refreshCols._.item][this.refreshCols._.colspan].push(this.refreshCols._.position);\n                            }\n                        }\n                    }\n\n                    // Find all the possible layouts\n\n                    this.refreshCols._.colHeights = [];\n\n                    for (this.refreshCols._.i = 0; this.refreshCols._.i < this.totalCols; this.refreshCols._.i++) {\n                        this.refreshCols._.colHeights.push(0);\n                    }\n\n                    this.createLayouts(0, [], [], this.refreshCols._.colHeights, 0);\n\n                    // Now find the layout that looks the best.\n\n                    // First find the layouts with the highest number of used columns\n                    this.refreshCols._.layoutTotalCols = [];\n\n                    for (this.refreshCols._.i = 0; this.refreshCols._.i < this.layouts.length; this.refreshCols._.i++) {\n                        this.refreshCols._.layoutTotalCols[this.refreshCols._.i] = 0;\n\n                        for (this.refreshCols._.j = 0; this.refreshCols._.j < this.totalCols; this.refreshCols._.j++) {\n                            if (this.layouts[this.refreshCols._.i].colHeights[this.refreshCols._.j]) {\n                                this.refreshCols._.layoutTotalCols[this.refreshCols._.i]++;\n                            }\n                        }\n                    }\n\n                    this.refreshCols._.highestTotalCols = Math.max.apply(null, this.refreshCols._.layoutTotalCols);\n\n                    // Filter out the ones that aren't using as many columns as they could be\n                    for (this.refreshCols._.i = this.layouts.length - 1; this.refreshCols._.i >= 0; this.refreshCols._.i--) {\n                        if (this.refreshCols._.layoutTotalCols[this.refreshCols._.i] !== this.refreshCols._.highestTotalCols) {\n                            this.layouts.splice(this.refreshCols._.i, 1);\n                        }\n                    }\n\n                    // Find the layout(s) with the least overall height\n                    this.refreshCols._.layoutHeights = [];\n\n                    for (this.refreshCols._.i = 0; this.refreshCols._.i < this.layouts.length; this.refreshCols._.i++) {\n                        this.refreshCols._.layoutHeights.push(Math.max.apply(null, this.layouts[this.refreshCols._.i].colHeights));\n                    }\n\n                    this.refreshCols._.shortestHeight = Math.min.apply(null, this.refreshCols._.layoutHeights);\n                    this.refreshCols._.shortestLayouts = [];\n                    this.refreshCols._.emptySpaces = [];\n\n                    for (this.refreshCols._.i = 0; this.refreshCols._.i < this.refreshCols._.layoutHeights.length; this.refreshCols._.i++) {\n                        if (this.refreshCols._.layoutHeights[this.refreshCols._.i] === this.refreshCols._.shortestHeight) {\n                            this.refreshCols._.shortestLayouts.push(this.layouts[this.refreshCols._.i]);\n\n                            // Now get its total empty space, including any trailing empty space\n                            this.refreshCols._.emptySpace = this.layouts[this.refreshCols._.i].emptySpace;\n\n                            for (this.refreshCols._.j = 0; this.refreshCols._.j < this.totalCols; this.refreshCols._.j++) {\n                                this.refreshCols._.emptySpace += (this.refreshCols._.shortestHeight - this.layouts[this.refreshCols._.i].colHeights[this.refreshCols._.j]);\n                            }\n\n                            this.refreshCols._.emptySpaces.push(this.refreshCols._.emptySpace);\n                        }\n                    }\n\n                    // And the layout with the least empty space is...\n                    this.layout = this.refreshCols._.shortestLayouts[$.inArray(Math.min.apply(null, this.refreshCols._.emptySpaces), this.refreshCols._.emptySpaces)];\n\n                    // Set the item widths and left positions\n                    for (this.refreshCols._.i = 0; this.refreshCols._.i < this.items.length; this.refreshCols._.i++) {\n                        this.refreshCols._.css = {\n                            width: this.getItemWidthCss(this.layout.colspans[this.refreshCols._.i])\n                        };\n                        this.refreshCols._.css[Craft.left] = this.getItemLeftPosCss(this.layout.positions[this.refreshCols._.i]);\n                        this.items[this.refreshCols._.i].css(this.refreshCols._.css);\n                    }\n\n                    // If every item is at position 0, then let them lay out au naturel\n                    if (this.isSimpleLayout()) {\n\n                        this.$container.height('auto');\n                        this.$items.css({\n                            position: 'relative',\n                            top: 0,\n                            'margin-bottom': this.settings.gutter+'px'\n                        });\n                    }\n                    else {\n                        this.$items.css('position', 'absolute');\n\n                        // Now position the items\n                        this.positionItems();\n\n                        // Update the positions as the items' heigthts change\n                        this.addListener(this.$items, 'resize', 'onItemResize');\n                    }\n                }\n            }\n\n            this.completeRefreshCols();\n\n            // Resume container resize listening\n            this.addListener(this.$container, 'resize', this.handleContainerHeightProxy);\n\n            this.onRefreshCols();\n        },\n\n        completeRefreshCols: function() {\n            // Delete the internal variable object\n            if (typeof this.refreshCols._ !== 'undefined') {\n                delete this.refreshCols._;\n            }\n\n            this._refreshingCols = false;\n\n            if (this._refreshColsAfterRefresh) {\n                var force = this._forceRefreshColsAfterRefresh;\n                this._refreshColsAfterRefresh = false;\n                this._forceRefreshColsAfterRefresh = false;\n\n                Garnish.requestAnimationFrame($.proxy(function() {\n                    this.refreshCols(force);\n                }, this));\n            }\n        },\n\n        getItemWidth: function(colspan) {\n            return (this.colPctWidth * colspan);\n        },\n\n        getItemWidthCss: function(colspan) {\n            return 'calc(' + this.getItemWidth(colspan) + '% - ' + this.colGutterDrop + 'px)';\n        },\n\n        getItemWidthInPx: function(colspan) {\n            return this.getItemWidth(colspan)/100 * this.$container.width() - this.colGutterDrop;\n        },\n\n        getItemLeftPosCss: function(position) {\n            return 'calc(' + '(' + this.getItemWidth(1) + '% + ' + (this.settings.gutter - this.colGutterDrop) + 'px) * ' + position + ')';\n        },\n\n        getItemLeftPosInPx: function(position) {\n            return (this.getItemWidth(1)/100 * this.$container.width() + (this.settings.gutter - this.colGutterDrop)) * position;\n        },\n\n        createLayouts: function(item, prevPositions, prevColspans, prevColHeights, prevEmptySpace) {\n            (new Craft.Grid.LayoutGenerator(this)).createLayouts(item, prevPositions, prevColspans, prevColHeights, prevEmptySpace);\n        },\n\n        isSimpleLayout: function() {\n            this.isSimpleLayout._ = {};\n\n            for (this.isSimpleLayout._.i = 0; this.isSimpleLayout._.i < this.layout.positions.length; this.isSimpleLayout._.i++) {\n                if (this.layout.positions[this.isSimpleLayout._.i] !== 0) {\n                    delete this.isSimpleLayout._;\n                    return false;\n                }\n            }\n\n            delete this.isSimpleLayout._;\n            return true;\n        },\n\n        positionItems: function() {\n            this.positionItems._ = {};\n\n            this.positionItems._.colHeights = [];\n\n            for (this.positionItems._.i = 0; this.positionItems._.i < this.totalCols; this.positionItems._.i++) {\n                this.positionItems._.colHeights.push(0);\n            }\n\n            for (this.positionItems._.i = 0; this.positionItems._.i < this.items.length; this.positionItems._.i++) {\n                this.positionItems._.endingCol = this.layout.positions[this.positionItems._.i] + this.layout.colspans[this.positionItems._.i] - 1;\n                this.positionItems._.affectedColHeights = [];\n\n                for (this.positionItems._.col = this.layout.positions[this.positionItems._.i]; this.positionItems._.col <= this.positionItems._.endingCol; this.positionItems._.col++) {\n                    this.positionItems._.affectedColHeights.push(this.positionItems._.colHeights[this.positionItems._.col]);\n                }\n\n                this.positionItems._.top = Math.max.apply(null, this.positionItems._.affectedColHeights);\n                if (this.positionItems._.top > 0) {\n                    this.positionItems._.top += this.settings.gutter;\n                }\n\n                this.items[this.positionItems._.i].css('top', this.positionItems._.top);\n\n                // Now add the new heights to those columns\n                for (this.positionItems._.col = this.layout.positions[this.positionItems._.i]; this.positionItems._.col <= this.positionItems._.endingCol; this.positionItems._.col++) {\n                    this.positionItems._.colHeights[this.positionItems._.col] = this.positionItems._.top + this.itemHeightsByColspan[this.positionItems._.i][this.layout.colspans[this.positionItems._.i]];\n                }\n            }\n\n            // Set the container height\n            this.$container.height(Math.max.apply(null, this.positionItems._.colHeights));\n\n            delete this.positionItems._;\n        },\n\n        onItemResize: function(ev) {\n            this.onItemResize._ = {};\n\n            // Prevent this from bubbling up to the container, which has its own resize listener\n            ev.stopPropagation();\n\n            this.onItemResize._.item = $.inArray(ev.currentTarget, this.$items);\n\n            if (this.onItemResize._.item !== -1) {\n                // Update the height and reposition the items\n                this.onItemResize._.newHeight = this.items[this.onItemResize._.item].outerHeight();\n\n                if (this.onItemResize._.newHeight !== this.itemHeightsByColspan[this.onItemResize._.item][this.layout.colspans[this.onItemResize._.item]]) {\n                    this.itemHeightsByColspan[this.onItemResize._.item][this.layout.colspans[this.onItemResize._.item]] = this.onItemResize._.newHeight;\n                    this.positionItems(false);\n                }\n            }\n\n            delete this.onItemResize._;\n        },\n\n        onRefreshCols: function() {\n            this.trigger('refreshCols');\n            this.settings.onRefreshCols();\n        }\n    },\n    {\n        defaults: {\n            itemSelector: '.item',\n            cols: null,\n            maxCols: null,\n            minColWidth: 320,\n            gutter: 14,\n            fillMode: 'top',\n            colClass: 'col',\n            snapToGrid: null,\n\n            onRefreshCols: $.noop\n        }\n    });\n\n\nCraft.Grid.LayoutGenerator = Garnish.Base.extend(\n    {\n        grid: null,\n        _: null,\n\n        init: function(grid) {\n            this.grid = grid;\n        },\n\n        createLayouts: function(item, prevPositions, prevColspans, prevColHeights, prevEmptySpace) {\n            this._ = {};\n\n            // Loop through all possible colspans\n            for (this._.c = 0; this._.c < this.grid.possibleItemColspans[item].length; this._.c++) {\n                this._.colspan = this.grid.possibleItemColspans[item][this._.c];\n\n                // Loop through all the possible positions for this colspan,\n                // and find the one that is closest to the top\n\n                this._.tallestColHeightsByPosition = [];\n\n                for (this._.p = 0; this._.p < this.grid.possibleItemPositionsByColspan[item][this._.colspan].length; this._.p++) {\n                    this._.position = this.grid.possibleItemPositionsByColspan[item][this._.colspan][this._.p];\n\n                    this._.colHeightsForPosition = [];\n                    this._.endingCol = this._.position + this._.colspan - 1;\n\n                    for (this._.col = this._.position; this._.col <= this._.endingCol; this._.col++) {\n                        this._.colHeightsForPosition.push(prevColHeights[this._.col]);\n                    }\n\n                    this._.tallestColHeightsByPosition[this._.p] = Math.max.apply(null, this._.colHeightsForPosition);\n                }\n\n                // And the shortest position for this colspan is...\n                this._.p = $.inArray(Math.min.apply(null, this._.tallestColHeightsByPosition), this._.tallestColHeightsByPosition);\n                this._.position = this.grid.possibleItemPositionsByColspan[item][this._.colspan][this._.p];\n\n                // Now log the colspan/position placement\n                this._.positions = prevPositions.slice(0);\n                this._.colspans = prevColspans.slice(0);\n                this._.colHeights = prevColHeights.slice(0);\n                this._.emptySpace = prevEmptySpace;\n\n                this._.positions.push(this._.position);\n                this._.colspans.push(this._.colspan);\n\n                // Add the new heights to those columns\n                this._.tallestColHeight = this._.tallestColHeightsByPosition[this._.p];\n                this._.endingCol = this._.position + this._.colspan - 1;\n\n                for (this._.col = this._.position; this._.col <= this._.endingCol; this._.col++) {\n                    this._.emptySpace += this._.tallestColHeight - this._.colHeights[this._.col];\n                    this._.colHeights[this._.col] = this._.tallestColHeight + this.grid.itemHeightsByColspan[item][this._.colspan];\n                }\n\n                // If this is the last item, create the layout\n                if (item === this.grid.items.length - 1) {\n                    this.grid.layouts.push({\n                        positions: this._.positions,\n                        colspans: this._.colspans,\n                        colHeights: this._.colHeights,\n                        emptySpace: this._.emptySpace\n                    });\n                }\n                else {\n                    // Dive deeper\n                    this.grid.createLayouts(item + 1, this._.positions, this._.colspans, this._.colHeights, this._.emptySpace);\n                }\n            }\n\n            delete this._;\n        }\n\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Handle Generator\n */\nCraft.HandleGenerator = Craft.BaseInputGenerator.extend(\n    {\n        generateTargetValue: function(sourceVal) {\n            // Remove HTML tags\n            var handle = sourceVal.replace(\"/<(.*?)>/g\", '');\n\n            // Remove inner-word punctuation\n            handle = handle.replace(/['\"\u2018\u2019\u201c\u201d\\[\\]\\(\\)\\{\\}:]/g, '');\n\n            // Make it lowercase\n            handle = handle.toLowerCase();\n\n            // Convert extended ASCII characters to basic ASCII\n            handle = Craft.asciiString(handle);\n\n            if (!this.settings.allowNonAlphaStart) {\n                // Handle must start with a letter\n                handle = handle.replace(/^[^a-z]+/, '');\n            }\n\n            // Get the \"words\"\n            var words = Craft.filterArray(handle.split(/[^a-z0-9]+/));\n            handle = '';\n\n            // Make it camelCase\n            for (var i = 0; i < words.length; i++) {\n                if (i === 0) {\n                    handle += words[i];\n                }\n                else {\n                    handle += words[i].charAt(0).toUpperCase() + words[i].substr(1);\n                }\n            }\n\n            return handle;\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n\n/**\n * Image upload class for user photos, site icon and logo.\n */\nCraft.ImageUpload = Garnish.Base.extend(\n    {\n        $container: null,\n        progressBar: null,\n        uploader: null,\n\n        init: function(settings) {\n            this.setSettings(settings, Craft.ImageUpload.defaults);\n            this.initImageUpload();\n        },\n\n        initImageUpload: function() {\n            this.$container = $(this.settings.containerSelector);\n            this.progressBar = new Craft.ProgressBar($('<div class=\"progress-shade\"></div>').appendTo(this.$container));\n\n            var options = {\n                url: Craft.getActionUrl(this.settings.uploadAction),\n                formData: this.settings.postParameters,\n                fileInput: this.$container.find(this.settings.fileInputSelector),\n                paramName: this.settings.uploadParamName\n            };\n\n            // If CSRF protection isn't enabled, these won't be defined.\n            if (typeof Craft.csrfTokenName !== 'undefined' && typeof Craft.csrfTokenValue !== 'undefined') {\n                // Add the CSRF token\n                options.formData[Craft.csrfTokenName] = Craft.csrfTokenValue;\n            }\n\n            options.events = {};\n            options.events.fileuploadstart = $.proxy(this, '_onUploadStart');\n            options.events.fileuploadprogressall = $.proxy(this, '_onUploadProgress');\n            options.events.fileuploaddone = $.proxy(this, '_onUploadComplete');\n            options.events.fileuploadfail = $.proxy(this, '_onUploadError');\n\n            this.uploader = new Craft.Uploader(this.$container, options);\n\n            this.initButtons();\n        },\n\n        initButtons: function() {\n            this.$container.find(this.settings.uploadButtonSelector).on('click', $.proxy(function(ev) {\n                this.$container.find(this.settings.fileInputSelector).trigger('click');\n            }, this));\n\n            this.$container.find(this.settings.deleteButtonSelector).on('click', $.proxy(function(ev) {\n                if (confirm(Craft.t('app', 'Are you sure you want to delete this image?'))) {\n                    $(ev.currentTarget).parent().append('<div class=\"blocking-modal\"></div>');\n                    Craft.postActionRequest(this.settings.deleteAction, this.settings.postParameters, $.proxy(function(response, textStatus) {\n                        if (textStatus === 'success') {\n                            this.refreshImage(response);\n                        }\n                    }, this));\n                }\n            }, this));\n\n        },\n\n        refreshImage: function(response) {\n            $(this.settings.containerSelector).replaceWith(response.html);\n            this.settings.onAfterRefreshImage(response);\n            this.initImageUpload();\n        },\n\n        /**\n         * On upload start.\n         */\n        _onUploadStart: function(event) {\n            this.progressBar.$progressBar.css({\n                top: Math.round(this.$container.outerHeight() / 2) - 6\n            });\n\n            this.$container.addClass('uploading');\n            this.progressBar.resetProgressBar();\n            this.progressBar.showProgressBar();\n        },\n\n        /**\n         * On upload progress.\n         */\n        _onUploadProgress: function(event, data) {\n            var progress = parseInt(data.loaded / data.total * 100, 10);\n            this.progressBar.setProgressPercentage(progress);\n        },\n\n        /**\n         * On a file being uploaded.\n         */\n        _onUploadComplete: function(event, data) {\n            if (data.result.error) {\n                alert(data.result.error);\n            } else {\n                var html = $(data.result.html);\n                this.refreshImage(data.result);\n            }\n\n            // Last file\n            if (this.uploader.isLastUpload()) {\n                this.progressBar.hideProgressBar();\n                this.$container.removeClass('uploading');\n            }\n        },\n\n        /**\n         * On a file being uploaded.\n         */\n        _onUploadError: function(event, data) {\n            if (data.jqXHR.responseJSON.error) {\n                alert(data.jqXHR.responseJSON.error);\n                this.$container.removeClass('uploading');\n                this.progressBar.hideProgressBar();\n                this.progressBar.resetProgressBar();\n            }\n        }\n    },\n    {\n        defaults: {\n            postParameters: {},\n            uploadAction: \"\",\n            deleteAction: \"\",\n            fileInputSelector: \"\",\n\n            onAfterRefreshImage: $.noop,\n            containerSelector: null,\n\n            uploadButtonSelector: null,\n            deleteButtonSelector: null,\n\n            uploadParamName: 'files'\n        }\n    }\n);\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Info icon class\n */\nCraft.InfoIcon = Garnish.Base.extend(\n    {\n        $icon: null,\n        hud: null,\n\n        init: function(icon) {\n            this.$icon = $(icon);\n\n            this.addListener(this.$icon, 'click', 'showHud');\n        },\n\n        showHud: function() {\n            if (!this.hud) {\n                this.hud = new Garnish.HUD(this.$icon, this.$icon.html(), {\n                    hudClass: 'hud info-hud',\n                    closeOtherHUDs: false\n                });\n            }\n            else {\n                this.hud.show();\n            }\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Light Switch\n */\nCraft.LightSwitch = Garnish.Base.extend(\n    {\n        settings: null,\n        $outerContainer: null,\n        $innerContainer: null,\n        $input: null,\n        small: false,\n        on: null,\n        dragger: null,\n\n        dragStartMargin: null,\n\n        init: function(outerContainer, settings) {\n            this.$outerContainer = $(outerContainer);\n\n            // Is this already a lightswitch?\n            if (this.$outerContainer.data('lightswitch')) {\n                Garnish.log('Double-instantiating a lightswitch on an element');\n                this.$outerContainer.data('lightswitch').destroy();\n            }\n\n            this.$outerContainer.data('lightswitch', this);\n\n            this.small = this.$outerContainer.hasClass('small');\n\n            this.setSettings(settings, Craft.LightSwitch.defaults);\n\n            this.$innerContainer = this.$outerContainer.find('.lightswitch-container:first');\n            this.$input = this.$outerContainer.find('input:first');\n\n            // If the input is disabled, go no further\n            if (this.$input.prop('disabled')) {\n                return;\n            }\n\n            this.on = this.$outerContainer.hasClass('on');\n\n            this.$outerContainer.attr({\n                'role': 'checkbox',\n                'aria-checked': (this.on ? 'true' : 'false')\n            });\n\n            this.addListener(this.$outerContainer, 'mousedown', '_onMouseDown');\n            this.addListener(this.$outerContainer, 'keydown', '_onKeyDown');\n\n            this.dragger = new Garnish.BaseDrag(this.$outerContainer, {\n                axis: Garnish.X_AXIS,\n                ignoreHandleSelector: null,\n                onDragStart: $.proxy(this, '_onDragStart'),\n                onDrag: $.proxy(this, '_onDrag'),\n                onDragStop: $.proxy(this, '_onDragStop')\n            });\n        },\n\n        turnOn: function() {\n            this.$outerContainer.addClass('dragging');\n\n            var animateCss = {};\n            animateCss['margin-' + Craft.left] = 0;\n            this.$innerContainer.velocity('stop').velocity(animateCss, Craft.LightSwitch.animationDuration, $.proxy(this, '_onSettle'));\n\n            this.$input.val(this.settings.value);\n            this.$outerContainer.addClass('on');\n            this.$outerContainer.attr('aria-checked', 'true');\n\n            if (this.on !== (this.on = true)) {\n                this.onChange();\n            }\n        },\n\n        turnOff: function() {\n            this.$outerContainer.addClass('dragging');\n\n            var animateCss = {};\n            animateCss['margin-' + Craft.left] = this._getOffMargin();\n            this.$innerContainer.velocity('stop').velocity(animateCss, Craft.LightSwitch.animationDuration, $.proxy(this, '_onSettle'));\n\n            this.$input.val('');\n            this.$outerContainer.removeClass('on');\n            this.$outerContainer.attr('aria-checked', 'false');\n\n            if (this.on !== (this.on = false)) {\n                this.onChange();\n            }\n        },\n\n        toggle: function(event) {\n            if (!this.on) {\n                this.turnOn();\n            }\n            else {\n                this.turnOff();\n            }\n        },\n\n        onChange: function() {\n            this.trigger('change');\n            this.settings.onChange();\n            this.$outerContainer.trigger('change');\n        },\n\n        _onMouseDown: function() {\n            this.addListener(Garnish.$doc, 'mouseup', '_onMouseUp');\n        },\n\n        _onMouseUp: function() {\n            this.removeListener(Garnish.$doc, 'mouseup');\n\n            // Was this a click?\n            if (!this.dragger.dragging) {\n                this.toggle();\n            }\n        },\n\n        _onKeyDown: function(event) {\n            switch (event.keyCode) {\n                case Garnish.SPACE_KEY: {\n                    this.toggle();\n                    event.preventDefault();\n                    break;\n                }\n                case Garnish.RIGHT_KEY: {\n                    if (Craft.orientation === 'ltr') {\n                        this.turnOn();\n                    }\n                    else {\n                        this.turnOff();\n                    }\n\n                    event.preventDefault();\n                    break;\n                }\n                case Garnish.LEFT_KEY: {\n                    if (Craft.orientation === 'ltr') {\n                        this.turnOff();\n                    }\n                    else {\n                        this.turnOn();\n                    }\n\n                    event.preventDefault();\n                    break;\n                }\n            }\n        },\n\n        _getMargin: function() {\n            return parseInt(this.$innerContainer.css('margin-' + Craft.left));\n        },\n\n        _onDragStart: function() {\n            this.$outerContainer.addClass('dragging');\n            this.dragStartMargin = this._getMargin();\n        },\n\n        _onDrag: function() {\n            var margin;\n\n            if (Craft.orientation === 'ltr') {\n                margin = this.dragStartMargin + this.dragger.mouseDistX;\n            }\n            else {\n                margin = this.dragStartMargin - this.dragger.mouseDistX;\n            }\n\n            if (margin < this._getOffMargin()) {\n                margin = this._getOffMargin();\n            }\n            else if (margin > 0) {\n                margin = 0;\n            }\n\n            this.$innerContainer.css('margin-' + Craft.left, margin);\n        },\n\n        _onDragStop: function() {\n            var margin = this._getMargin();\n\n            if (margin > (this._getOffMargin() / 2)) {\n                this.turnOn();\n            }\n            else {\n                this.turnOff();\n            }\n        },\n\n        _onSettle: function() {\n            this.$outerContainer.removeClass('dragging');\n        },\n\n        destroy: function() {\n            this.base();\n            this.dragger.destroy();\n        },\n\n        _getOffMargin: function() {\n            return (this.small ? -9 : -11);\n        }\n\n    }, {\n        animationDuration: 100,\n        defaults: {\n            value: '1',\n            onChange: $.noop\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Live Preview\n */\nCraft.LivePreview = Garnish.Base.extend(\n    {\n        $extraFields: null,\n        $trigger: null,\n        $shade: null,\n        $editorContainer: null,\n        $editor: null,\n        $dragHandle: null,\n        $iframeContainer: null,\n        $iframe: null,\n        $fieldPlaceholder: null,\n\n        previewUrl: null,\n        token: null,\n        basePostData: null,\n        inPreviewMode: false,\n        fields: null,\n        lastPostData: null,\n        updateIframeInterval: null,\n        loading: false,\n        checkAgain: false,\n\n        dragger: null,\n        dragStartEditorWidth: null,\n\n        _slideInOnIframeLoad: false,\n        _handleSuccessProxy: null,\n        _handleErrorProxy: null,\n        _forceUpdateIframeProxy: null,\n\n        _scrollX: null,\n        _scrollY: null,\n\n        _editorWidth: null,\n        _editorWidthInPx: null,\n\n        init: function(settings) {\n            this.setSettings(settings, Craft.LivePreview.defaults);\n\n            // Should preview requests use a specific URL?\n            // This won't affect how the request gets routed (the action param will override it),\n            // but it will allow the templates to change behavior based on the request URI.\n            if (this.settings.previewUrl) {\n                this.previewUrl = this.settings.previewUrl;\n            }\n            else {\n                this.previewUrl = Craft.baseSiteUrl.replace(/\\/+$/, '') + '/';\n            }\n\n            // Load the preview over SSL if the current request is\n            if (document.location.protocol === 'https:') {\n                this.previewUrl = this.previewUrl.replace(/^http:/, 'https:');\n            }\n\n            // Set the base post data\n            this.basePostData = $.extend({}, this.settings.previewParams);\n\n            this._handleSuccessProxy = $.proxy(this, 'handleSuccess');\n            this._handleErrorProxy = $.proxy(this, 'handleError');\n            this._forceUpdateIframeProxy = $.proxy(this, 'forceUpdateIframe');\n\n            // Find the DOM elements\n            this.$extraFields = $(this.settings.extraFields);\n            this.$trigger = $(this.settings.trigger);\n            this.$fieldPlaceholder = $('<div/>');\n\n            // Set the initial editor width\n            this.editorWidth = Craft.getLocalStorage('LivePreview.editorWidth', Craft.LivePreview.defaultEditorWidth);\n\n            // Event Listeners\n            this.addListener(this.$trigger, 'activate', 'toggle');\n\n            Craft.cp.on('beforeSaveShortcut', $.proxy(function() {\n                if (this.inPreviewMode) {\n                    this.moveFieldsBack();\n                }\n            }, this));\n        },\n\n        get editorWidth() {\n            return this._editorWidth;\n        },\n\n        get editorWidthInPx() {\n            return this._editorWidthInPx;\n        },\n\n        set editorWidth(width) {\n            var inPx;\n\n            // Is this getting set in pixels?\n            if (width >= 1) {\n                inPx = width;\n                width /= Garnish.$win.width();\n            }\n            else {\n                inPx = Math.round(width * Garnish.$win.width());\n            }\n\n            // Make sure it's no less than the minimum\n            if (inPx < Craft.LivePreview.minEditorWidthInPx) {\n                inPx = Craft.LivePreview.minEditorWidthInPx;\n                width = inPx / Garnish.$win.width();\n            }\n\n            this._editorWidth = width;\n            this._editorWidthInPx = inPx;\n        },\n\n        toggle: function() {\n            if (this.inPreviewMode) {\n                this.exit();\n            }\n            else {\n                this.enter();\n            }\n        },\n\n        enter: function() {\n            if (this.inPreviewMode) {\n                return;\n            }\n\n            if (!this.token) {\n                this.createToken();\n                return;\n            }\n\n            this.trigger('beforeEnter');\n\n            $(document.activeElement).trigger('blur');\n\n            if (!this.$editor) {\n                this.$shade = $('<div/>', {'class': 'modal-shade dark'}).appendTo(Garnish.$bod);\n                this.$editorContainer = $('<div/>', {'class': 'lp-editor-container'}).appendTo(Garnish.$bod);\n                this.$iframeContainer =$('<div/>', {'class': 'lp-preview-container'}).appendTo(Garnish.$bod);\n\n                var $editorHeader = $('<header/>', {'class': 'flex'}).appendTo(this.$editorContainer);\n                this.$editor = $('<form/>', {'class': 'lp-editor'}).appendTo(this.$editorContainer);\n                this.$dragHandle = $('<div/>', {'class': 'lp-draghandle'}).appendTo(this.$editorContainer);\n                var $closeBtn = $('<div/>', {'class': 'btn', text: Craft.t('app', 'Close Preview')}).appendTo($editorHeader);\n                $('<div/>', {'class': 'flex-grow'}).appendTo($editorHeader);\n                var $saveBtn = $('<div class=\"btn submit\">' + Craft.t('app', 'Save') + '</div>').appendTo($editorHeader);\n\n                this.dragger = new Garnish.BaseDrag(this.$dragHandle, {\n                    axis: Garnish.X_AXIS,\n                    onDragStart: $.proxy(this, '_onDragStart'),\n                    onDrag: $.proxy(this, '_onDrag'),\n                    onDragStop: $.proxy(this, '_onDragStop')\n                });\n\n                this.addListener($closeBtn, 'click', 'exit');\n                this.addListener($saveBtn, 'click', 'save');\n            }\n\n            // Set the sizes\n            this.handleWindowResize();\n            this.addListener(Garnish.$win, 'resize', 'handleWindowResize');\n\n            this.$editorContainer.css(Craft.left, -(this.editorWidthInPx + Craft.LivePreview.dragHandleWidth) + 'px');\n            this.$iframeContainer.css(Craft.right, -this.getIframeWidth());\n\n            // Move all the fields into the editor rather than copying them\n            // so any JS that's referencing the elements won't break.\n            this.fields = [];\n            var $fields = $(this.settings.fields);\n\n            for (var i = 0; i < $fields.length; i++) {\n                var $field = $($fields[i]),\n                    $clone = this._getClone($field);\n\n                // It's important that the actual field is added to the DOM *after* the clone,\n                // so any radio buttons in the field get deselected from the clone rather than the actual field.\n                this.$fieldPlaceholder.insertAfter($field);\n                $field.detach();\n                this.$fieldPlaceholder.replaceWith($clone);\n                $field.appendTo(this.$editor);\n\n                this.fields.push({\n                    $field: $field,\n                    $clone: $clone\n                });\n            }\n\n            if (this.updateIframe()) {\n                this._slideInOnIframeLoad = true;\n            } else {\n                this.slideIn();\n            }\n\n            Garnish.on(Craft.BaseElementEditor, 'saveElement', this._forceUpdateIframeProxy);\n            Garnish.on(Craft.AssetImageEditor, 'save', this._forceUpdateIframeProxy);\n\n            this.inPreviewMode = true;\n            this.trigger('enter');\n        },\n\n        createToken: function() {\n            Craft.postActionRequest('live-preview/create-token', {\n                previewAction: this.settings.previewAction\n            }, $.proxy(function(response, textStatus) {\n                if (textStatus === 'success') {\n                    this.token = response.token;\n                    this.enter();\n                }\n            }, this));\n        },\n\n        save: function() {\n            Craft.cp.submitPrimaryForm();\n        },\n\n        handleWindowResize: function() {\n            // Reset the width so the min width is enforced\n            this.editorWidth = this.editorWidth;\n\n            // Update the editor/iframe sizes\n            this.updateWidths();\n        },\n\n        slideIn: function() {\n            $('html').addClass('noscroll');\n            this.$shade.velocity('fadeIn');\n\n            this.$editorContainer.show().velocity('stop').animateLeft(0, 'slow', $.proxy(function() {\n                this.trigger('slideIn');\n                Garnish.$win.trigger('resize');\n            }, this));\n\n            this.$iframeContainer.show().velocity('stop').animateRight(0, 'slow', $.proxy(function() {\n                this.updateIframeInterval = setInterval($.proxy(this, 'updateIframe'), 1000);\n\n                this.addListener(Garnish.$bod, 'keyup', function(ev) {\n                    if (ev.keyCode === Garnish.ESC_KEY) {\n                        this.exit();\n                    }\n                });\n            }, this));\n        },\n\n        exit: function() {\n            if (!this.inPreviewMode) {\n                return;\n            }\n\n            this.trigger('beforeExit');\n\n            $('html').removeClass('noscroll');\n\n            this.removeListener(Garnish.$win, 'resize');\n            this.removeListener(Garnish.$bod, 'keyup');\n\n            if (this.updateIframeInterval) {\n                clearInterval(this.updateIframeInterval);\n            }\n\n            this.moveFieldsBack();\n\n            this.$shade.delay(200).velocity('fadeOut');\n\n            this.$editorContainer.velocity('stop').animateLeft(-(this.editorWidthInPx + Craft.LivePreview.dragHandleWidth), 'slow', $.proxy(function() {\n                for (var i = 0; i < this.fields.length; i++) {\n                    this.fields[i].$newClone.remove();\n                }\n                this.$editorContainer.hide();\n                this.trigger('slideOut');\n            }, this));\n\n            this.$iframeContainer.velocity('stop').animateRight(-this.getIframeWidth(), 'slow', $.proxy(function() {\n                this.$iframeContainer.hide();\n            }, this));\n\n            Garnish.off(Craft.BaseElementEditor, 'saveElement', this._forceUpdateIframeProxy);\n\n            this.inPreviewMode = false;\n            this.trigger('exit');\n        },\n\n        moveFieldsBack: function() {\n            for (var i = 0; i < this.fields.length; i++) {\n                var field = this.fields[i];\n                field.$newClone = this._getClone(field.$field);\n\n                // It's important that the actual field is added to the DOM *after* the clone,\n                // so any radio buttons in the field get deselected from the clone rather than the actual field.\n                this.$fieldPlaceholder.insertAfter(field.$field);\n                field.$field.detach();\n                this.$fieldPlaceholder.replaceWith(field.$newClone);\n                field.$clone.replaceWith(field.$field);\n            }\n\n            Garnish.$win.trigger('resize');\n        },\n\n        getIframeWidth: function() {\n            return Garnish.$win.width() - (this.editorWidthInPx + Craft.LivePreview.dragHandleWidth);\n        },\n\n        updateWidths: function() {\n            this.$editorContainer.css('width', this.editorWidthInPx + 'px');\n            this.$iframeContainer.width(this.getIframeWidth());\n        },\n\n        updateIframe: function(force) {\n            if (force) {\n                this.lastPostData = null;\n            }\n\n            if (!this.inPreviewMode) {\n                return false;\n            }\n\n            if (this.loading) {\n                this.checkAgain = true;\n                return false;\n            }\n\n            // Has the post data changed?\n            var postData = $.extend(Garnish.getPostData(this.$editor), Garnish.getPostData(this.$extraFields));\n\n            if (!this.lastPostData || !Craft.compare(postData, this.lastPostData, false)) {\n                this.lastPostData = postData;\n                this.loading = true;\n\n                var $doc = this.$iframe ? $(this.$iframe[0].contentWindow.document) : null;\n\n                this._scrollX = $doc ? $doc.scrollLeft() : 0;\n                this._scrollY = $doc ? $doc.scrollTop() : 0;\n\n                $.ajax({\n                    url: this.previewUrl + (this.previewUrl.indexOf('?') !== -1 ? '&' : '?') + Craft.tokenParam + '=' + this.token,\n                    method: 'POST',\n                    data: $.extend({}, postData, this.basePostData),\n                    headers: {\n                        'X-Craft-Token': this.token\n                    },\n                    xhrFields: {\n                        withCredentials: true\n                    },\n                    crossDomain: true,\n                    success: this._handleSuccessProxy,\n                    error: this._handleErrorProxy\n                });\n\n                return true;\n            }\n            else {\n                return false;\n            }\n        },\n\n        forceUpdateIframe: function() {\n            return this.updateIframe(true);\n        },\n\n        handleSuccess: function(data) {\n            var html = data +\n                '<script type=\"text/javascript\">window.scrollTo(' + this._scrollX + ', ' + this._scrollY + ');</script>';\n\n            // Create a new iframe\n            var $iframe = $('<iframe class=\"lp-preview\" frameborder=\"0\"/>');\n            if (this.$iframe) {\n                $iframe.insertBefore(this.$iframe);\n            } else {\n                $iframe.appendTo(this.$iframeContainer);\n            }\n\n            this.addListener($iframe, 'load', function() {\n                if (this.$iframe) {\n                    this.$iframe.remove();\n                }\n                this.$iframe = $iframe;\n\n                if (this._slideInOnIframeLoad) {\n                    this.slideIn();\n                    this._slideInOnIframeLoad = false;\n                }\n\n                this.removeListener($iframe, 'load');\n            });\n\n            Garnish.requestAnimationFrame($.proxy(function() {\n                $iframe[0].contentWindow.document.open();\n                $iframe[0].contentWindow.document.write(html);\n                $iframe[0].contentWindow.document.close();\n                this.onResponse();\n            }, this));\n        },\n\n        handleError: function() {\n            this.onResponse();\n        },\n\n        onResponse: function() {\n            this.loading = false;\n\n            if (this.checkAgain) {\n                this.checkAgain = false;\n                this.updateIframe();\n            }\n        },\n\n        _getClone: function($field) {\n            var $clone = $field.clone();\n\n            // clone() won't account for input values that have changed since the original HTML set them\n            Garnish.copyInputValues($field, $clone);\n\n            // Remove any id= attributes\n            $clone.attr('id', '');\n            $clone.find('[id]').attr('id', '');\n\n            return $clone;\n        },\n\n        _onDragStart: function() {\n            this.dragStartEditorWidth = this.editorWidthInPx;\n            this.$iframeContainer.addClass('dragging');\n        },\n\n        _onDrag: function() {\n            if (Craft.orientation === 'ltr') {\n                this.editorWidth = this.dragStartEditorWidth + this.dragger.mouseDistX;\n            }\n            else {\n                this.editorWidth = this.dragStartEditorWidth - this.dragger.mouseDistX;\n            }\n\n            this.updateWidths();\n        },\n\n        _onDragStop: function() {\n            this.$iframeContainer.removeClass('dragging');\n            Craft.setLocalStorage('LivePreview.editorWidth', this.editorWidth);\n        }\n    },\n    {\n        defaultEditorWidth: 0.33,\n        minEditorWidthInPx: 320,\n        dragHandleWidth: 4,\n\n        defaults: {\n            trigger: '.livepreviewbtn',\n            fields: null,\n            extraFields: null,\n            previewUrl: null,\n            previewAction: null,\n            previewParams: {}\n        }\n    });\n\nCraft.LivePreview.init = function(settings) {\n    Craft.livePreview = new Craft.LivePreview(settings);\n};\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Password Input\n */\nCraft.PasswordInput = Garnish.Base.extend(\n    {\n        $passwordInput: null,\n        $textInput: null,\n        $currentInput: null,\n\n        $showPasswordToggle: null,\n        showingPassword: null,\n\n        init: function(passwordInput, settings) {\n            this.$passwordInput = $(passwordInput);\n            this.settings = $.extend({}, Craft.PasswordInput.defaults, settings);\n\n            // Is this already a password input?\n            if (this.$passwordInput.data('passwordInput')) {\n                Garnish.log('Double-instantiating a password input on an element');\n                this.$passwordInput.data('passwordInput').destroy();\n            }\n\n            this.$passwordInput.data('passwordInput', this);\n\n            this.$showPasswordToggle = $('<a/>').hide();\n            this.$showPasswordToggle.addClass('password-toggle');\n            this.$showPasswordToggle.insertAfter(this.$passwordInput);\n            this.addListener(this.$showPasswordToggle, 'mousedown', 'onToggleMouseDown');\n            this.hidePassword();\n        },\n\n        setCurrentInput: function($input) {\n            if (this.$currentInput) {\n                // Swap the inputs, while preventing the focus animation\n                $input.addClass('focus');\n                $input.insertAfter(this.$currentInput);\n                this.$currentInput.detach();\n                $input.trigger('focus');\n                $input.removeClass('focus');\n\n                // Restore the input value\n                $input.val(this.$currentInput.val());\n            }\n\n            this.$currentInput = $input;\n\n            this.addListener(this.$currentInput, 'keypress,keyup,change,blur', 'onInputChange');\n        },\n\n        updateToggleLabel: function(label) {\n            this.$showPasswordToggle.text(label);\n        },\n\n        showPassword: function() {\n            if (this.showingPassword) {\n                return;\n            }\n\n            if (!this.$textInput) {\n                this.$textInput = this.$passwordInput.clone(true);\n                this.$textInput.attr('type', 'text');\n            }\n\n            this.setCurrentInput(this.$textInput);\n            this.updateToggleLabel(Craft.t('app', 'Hide'));\n            this.showingPassword = true;\n        },\n\n        hidePassword: function() {\n            // showingPassword could be null, which is acceptable\n            if (this.showingPassword === false) {\n                return;\n            }\n\n            this.setCurrentInput(this.$passwordInput);\n            this.updateToggleLabel(Craft.t('app', 'Show'));\n            this.showingPassword = false;\n\n            // Alt key temporarily shows the password\n            this.addListener(this.$passwordInput, 'keydown', 'onKeyDown');\n        },\n\n        togglePassword: function() {\n            if (this.showingPassword) {\n                this.hidePassword();\n            }\n            else {\n                this.showPassword();\n            }\n\n            this.settings.onToggleInput(this.$currentInput);\n        },\n\n        onKeyDown: function(ev) {\n            if (ev.keyCode === Garnish.ALT_KEY && this.$currentInput.val()) {\n                this.showPassword();\n                this.$showPasswordToggle.hide();\n                this.addListener(this.$textInput, 'keyup', 'onKeyUp');\n            }\n        },\n\n        onKeyUp: function(ev) {\n            ev.preventDefault();\n\n            if (ev.keyCode === Garnish.ALT_KEY) {\n                this.hidePassword();\n                this.$showPasswordToggle.show();\n            }\n        },\n\n        onInputChange: function() {\n            if (this.$currentInput.val()) {\n                this.$showPasswordToggle.show();\n            }\n            else {\n                this.$showPasswordToggle.hide();\n            }\n        },\n\n        onToggleMouseDown: function(ev) {\n            // Prevent focus change\n            ev.preventDefault();\n\n            if (this.$currentInput[0].setSelectionRange) {\n                var selectionStart = this.$currentInput[0].selectionStart,\n                    selectionEnd = this.$currentInput[0].selectionEnd;\n\n                this.togglePassword();\n                this.$currentInput[0].setSelectionRange(selectionStart, selectionEnd);\n            }\n            else {\n                this.togglePassword();\n            }\n        }\n    },\n    {\n        defaults: {\n            onToggleInput: $.noop\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Preview\n */\nCraft.Preview = Garnish.Base.extend(\n    {\n        draftEditor: null,\n\n        $shade: null,\n        $editorContainer: null,\n        $editor: null,\n        $spinner: null,\n        $statusIcon: null,\n        $dragHandle: null,\n        $previewContainer: null,\n        $targetBtn: null,\n        $targetMenu: null,\n        $iframe: null,\n        $tempInput: null,\n        $fieldPlaceholder: null,\n\n        isActive: false,\n        activeTarget: 0,\n        url: null,\n        fields: null,\n\n        scrollLeft: 0,\n        scrollTop: 0,\n\n        dragger: null,\n        dragStartEditorWidth: null,\n\n        _slideInOnIframeLoad: false,\n        _updateIframeProxy: null,\n\n        _editorWidth: null,\n        _editorWidthInPx: null,\n\n        init: function(draftEditor) {\n            this.draftEditor = draftEditor;\n\n            this._updateIframeProxy = $.proxy(this,'updateIframe');\n\n            this.$tempInput = $('<input/>', {type: 'hidden', name: '__PREVIEW_FIELDS__', value: '1'});\n            this.$fieldPlaceholder = $('<div/>');\n\n            // Set the initial editor width\n            this.editorWidth = Craft.getLocalStorage('LivePreview.editorWidth', Craft.Preview.defaultEditorWidth);\n        },\n\n        get editorWidth() {\n            return this._editorWidth;\n        },\n\n        get editorWidthInPx() {\n            return this._editorWidthInPx;\n        },\n\n        set editorWidth(width) {\n            var inPx;\n\n            // Is this getting set in pixels?\n            if (width >= 1) {\n                inPx = width;\n                width /= Garnish.$win.width();\n            } else {\n                inPx = Math.round(width * Garnish.$win.width());\n            }\n\n            // Make sure it's no less than the minimum\n            if (inPx < Craft.Preview.minEditorWidthInPx) {\n                inPx = Craft.Preview.minEditorWidthInPx;\n                width = inPx / Garnish.$win.width();\n            }\n\n            this._editorWidth = width;\n            this._editorWidthInPx = inPx;\n        },\n\n        open: function() {\n            if (this.isActive) {\n                return;\n            }\n\n            this.isActive = true;\n            this.trigger('beforeOpen');\n\n            $(document.activeElement).trigger('blur');\n\n            if (!this.$editor) {\n                this.$shade = $('<div/>', {'class': 'modal-shade dark'}).appendTo(Garnish.$bod);\n                this.$editorContainer = $('<div/>', {'class': 'lp-editor-container'}).appendTo(Garnish.$bod);\n                this.$previewContainer = $('<div/>', {'class': 'lp-preview-container'}).appendTo(Garnish.$bod);\n\n                var $editorHeader = $('<header/>', {'class': 'flex'}).appendTo(this.$editorContainer);\n                this.$editor = $('<form/>', {'class': 'lp-editor'}).appendTo(this.$editorContainer);\n                this.$dragHandle = $('<div/>', {'class': 'lp-draghandle'}).appendTo(this.$editorContainer);\n                var $closeBtn = $('<div/>', {'class': 'btn', text: Craft.t('app', 'Close Preview')}).appendTo($editorHeader);\n                $('<div/>', {'class': 'flex-grow'}).appendTo($editorHeader);\n                this.$spinner = $('<div/>', {'class': 'spinner hidden', title: Craft.t('app', 'Saving')}).appendTo($editorHeader);\n                this.$statusIcon = $('<div/>', {'class': 'invisible'}).appendTo($editorHeader);\n\n                if (this.draftEditor.settings.previewTargets.length > 1) {\n                    var $previewHeader = $('<header/>', {'class': 'flex'}).appendTo(this.$previewContainer);\n                    this.$targetBtn = $('<div/>', {\n                        'class': 'btn menubtn',\n                        text: this.draftEditor.settings.previewTargets[0].label,\n                        role: 'btn',\n                    }).appendTo($previewHeader);\n                    this.$targetMenu = $('<div/>', {'class': 'menu lp-target-menu'}).insertAfter(this.$targetBtn);\n                    var $ul = $('<ul/>', {'class': 'padded'}).appendTo(this.$targetMenu);\n                    var $li, $a;\n                    for (var i = 0; i < this.draftEditor.settings.previewTargets.length; i++) {\n                        $li = $('<li/>').appendTo($ul)\n                        $a = $('<a/>', {\n                            data: {target: i},\n                            text: this.draftEditor.settings.previewTargets[i].label,\n                            'class': i === 0 ? 'sel' : null,\n                        }).appendTo($li);\n                    }\n                    new Garnish.MenuBtn(this.$targetBtn, {\n                        onOptionSelect: $.proxy(function(option) {\n                            this.switchTarget($(option).data('target'));\n                        }, this)\n                    });\n                }\n\n                this.dragger = new Garnish.BaseDrag(this.$dragHandle, {\n                    axis: Garnish.X_AXIS,\n                    onDragStart: $.proxy(this, '_onDragStart'),\n                    onDrag: $.proxy(this, '_onDrag'),\n                    onDragStop: $.proxy(this, '_onDragStop')\n                });\n\n                this.addListener($closeBtn, 'click', 'close');\n                this.addListener(this.$statusIcon, 'click', function() {\n                    this.draftEditor.showStatusHud(this.$statusIcon);\n                }.bind(this));\n            }\n\n            // Set the sizes\n            this.handleWindowResize();\n            this.addListener(Garnish.$win, 'resize', 'handleWindowResize');\n\n            this.$editorContainer.css(Craft.left, -(this.editorWidthInPx + Craft.Preview.dragHandleWidth) + 'px');\n            this.$previewContainer.css(Craft.right, -this.getIframeWidth());\n\n            // Find the fields, excluding nested fields\n            this.fields = [];\n            var $fields = $('#content .field').not($('#content .field .field'));\n\n            if ($fields.length) {\n                // Insert our temporary input before the first field so we know where to swap in the serialized form values\n                this.$tempInput.insertBefore($fields.get(0));\n\n                // Move all the fields into the editor rather than copying them\n                // so any JS that's referencing the elements won't break.\n                for (var i = 0; i < $fields.length; i++) {\n                    var $field = $($fields[i]),\n                        $clone = this._getClone($field);\n\n                    // It's important that the actual field is added to the DOM *after* the clone,\n                    // so any radio buttons in the field get deselected from the clone rather than the actual field.\n                    this.$fieldPlaceholder.insertAfter($field);\n                    $field.detach();\n                    this.$fieldPlaceholder.replaceWith($clone);\n                    $field.appendTo(this.$editor);\n\n                    this.fields.push({\n                        $field: $field,\n                        $clone: $clone\n                    });\n                }\n\n            }\n\n            this._slideInOnIframeLoad = true;\n            this.updateIframe();\n\n            this.draftEditor.on('update', this._updateIframeProxy);\n            Garnish.on(Craft.BaseElementEditor, 'saveElement', this._updateIframeProxy);\n            Garnish.on(Craft.AssetImageEditor, 'save', this._updateIframeProxy);\n\n            this.trigger('open');\n        },\n\n        switchTarget: function(i) {\n            this.activeTarget = i;\n            this.$targetBtn.text(this.draftEditor.settings.previewTargets[i].label);\n            this.$targetMenu.find('a.sel').removeClass('sel');\n            this.$targetMenu.find('a').eq(i).addClass('sel');\n            this.updateIframe(true);\n        },\n\n        handleWindowResize: function() {\n            // Reset the width so the min width is enforced\n            this.editorWidth = this.editorWidth;\n\n            // Update the editor/iframe sizes\n            this.updateWidths();\n        },\n\n        slideIn: function() {\n            $('html').addClass('noscroll');\n            this.$shade.velocity('fadeIn');\n\n            this.$editorContainer.show().velocity('stop').animateLeft(0, 'slow', $.proxy(function() {\n                this.trigger('slideIn');\n                Garnish.$win.trigger('resize');\n            }, this));\n\n            this.$previewContainer.show().velocity('stop').animateRight(0, 'slow', $.proxy(function() {\n                this.addListener(Garnish.$bod, 'keyup', function(ev) {\n                    if (ev.keyCode === Garnish.ESC_KEY) {\n                        this.close();\n                    }\n                });\n            }, this));\n        },\n\n        close: function() {\n            if (!this.isActive) {\n                return;\n            }\n\n            this.trigger('beforeClose');\n\n            $('html').removeClass('noscroll');\n\n            this.removeListener(Garnish.$win, 'resize');\n            this.removeListener(Garnish.$bod, 'keyup');\n\n            // Remove our temporary input and move the preview fields back into place\n            this.$tempInput.detach();\n            this.moveFieldsBack();\n\n            this.$shade.delay(200).velocity('fadeOut');\n\n            this.$editorContainer.velocity('stop').animateLeft(-(this.editorWidthInPx + Craft.Preview.dragHandleWidth), 'slow', $.proxy(function() {\n                for (var i = 0; i < this.fields.length; i++) {\n                    this.fields[i].$newClone.remove();\n                }\n                this.$editorContainer.hide();\n                this.trigger('slideOut');\n            }, this));\n\n            this.$previewContainer.velocity('stop').animateRight(-this.getIframeWidth(), 'slow', $.proxy(function() {\n                this.$previewContainer.hide();\n            }, this));\n\n            this.draftEditor.off('update', this._updateIframeProxy);\n            Garnish.off(Craft.BaseElementEditor, 'saveElement', this._updateIframeProxy);\n            Garnish.off(Craft.AssetImageEditor, 'save', this._updateIframeProxy);\n\n            this.isActive = false;\n            this.trigger('close');\n        },\n\n        moveFieldsBack: function() {\n            for (var i = 0; i < this.fields.length; i++) {\n                var field = this.fields[i];\n                field.$newClone = this._getClone(field.$field);\n\n                // It's important that the actual field is added to the DOM *after* the clone,\n                // so any radio buttons in the field get deselected from the clone rather than the actual field.\n                this.$fieldPlaceholder.insertAfter(field.$field);\n                field.$field.detach();\n                this.$fieldPlaceholder.replaceWith(field.$newClone);\n                field.$clone.replaceWith(field.$field);\n            }\n\n            Garnish.$win.trigger('resize');\n        },\n\n        getIframeWidth: function() {\n            return Garnish.$win.width() - (this.editorWidthInPx + Craft.Preview.dragHandleWidth);\n        },\n\n        updateWidths: function() {\n            this.$editorContainer.css('width', this.editorWidthInPx + 'px');\n            this.$previewContainer.width(this.getIframeWidth());\n        },\n\n        updateIframe: function(resetScroll) {\n            if (!this.isActive) {\n                return false;\n            }\n\n            // Ignore non-boolean resetScroll values\n            resetScroll = resetScroll === true;\n\n            var url = this.draftEditor.settings.previewTargets[this.activeTarget].url;\n\n            this.draftEditor.getTokenizedPreviewUrl(url, 'x-craft-live-preview').then(function(url) {\n                // Capture the current scroll position?\n                var sameHost;\n                if (resetScroll) {\n                    this.scrollLeft = 0;\n                    this.scrolllTop = 0;\n                } else {\n                    sameHost = Craft.isSameHost(url);\n                    if (sameHost && this.$iframe && this.$iframe[0].contentWindow) {\n                        var $doc = $(this.$iframe[0].contentWindow.document);\n                        this.scrollLeft = $doc.scrollLeft();\n                        this.scrollTop = $doc.scrollTop();\n                    }\n                }\n\n                var $iframe = $('<iframe/>', {\n                    'class': 'lp-preview',\n                    frameborder: 0,\n                    src: url,\n                });\n\n                if (!resetScroll && sameHost) {\n                    $iframe.on('load', function() {\n                        var $doc = $($iframe[0].contentWindow.document);\n                        $doc.scrollLeft(this.scrollLeft);\n                        $doc.scrollTop(this.scrollTop);\n                    }.bind(this));\n                }\n\n                if (this.$iframe) {\n                    this.$iframe.replaceWith($iframe);\n                } else {\n                    $iframe.appendTo(this.$previewContainer);\n                }\n\n                this.url = url;\n                this.$iframe = $iframe;\n                this.afterUpdateIframe();\n            }.bind(this));\n        },\n\n        afterUpdateIframe: function() {\n            this.trigger('afterUpdateIframe');\n\n            if (this._slideInOnIframeLoad) {\n                this.slideIn();\n                this._slideInOnIframeLoad = false;\n            }\n        },\n\n        _getClone: function($field) {\n            var $clone = $field.clone();\n\n            // clone() won't account for input values that have changed since the original HTML set them\n            Garnish.copyInputValues($field, $clone);\n\n            // Remove any id= attributes\n            $clone.attr('id', '');\n            $clone.find('[id]').attr('id', '');\n\n            // Disable anything with a name attribute\n            $clone.find('[name]').prop('disabled', true);\n\n            return $clone;\n        },\n\n        _onDragStart: function() {\n            this.dragStartEditorWidth = this.editorWidthInPx;\n            this.$previewContainer.addClass('dragging');\n        },\n\n        _onDrag: function() {\n            if (Craft.orientation === 'ltr') {\n                this.editorWidth = this.dragStartEditorWidth + this.dragger.mouseDistX;\n            } else {\n                this.editorWidth = this.dragStartEditorWidth - this.dragger.mouseDistX;\n            }\n\n            this.updateWidths();\n        },\n\n        _onDragStop: function() {\n            this.$previewContainer.removeClass('dragging');\n            Craft.setLocalStorage('LivePreview.editorWidth', this.editorWidth);\n        }\n    },\n    {\n        defaultEditorWidth: 0.33,\n        minEditorWidthInPx: 320,\n        dragHandleWidth: 2,\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Preview File Modal\n */\nCraft.PreviewFileModal = Garnish.Modal.extend(\n    {\n        assetId: null,\n        $spinner: null,\n        elementSelect: null,\n        type: null,\n        loaded: null,\n        requestId: 0,\n\n        /**\n         * Initialize the preview file modal.\n         * @returns {*|void}\n         */\n        init: function(assetId, elementSelect, settings) {\n            settings = $.extend(this.defaultSettings, settings);\n\n            settings.onHide = this._onHide.bind(this);\n\n            if (Craft.PreviewFileModal.openInstance) {\n                var instance = Craft.PreviewFileModal.openInstance;\n\n                if (instance.assetId !== assetId) {\n                    instance.loadAsset(assetId, settings.startingWidth, settings.startingHeight);\n                    instance.elementSelect = elementSelect;\n                }\n\n                return this.destroy();\n            }\n\n            Craft.PreviewFileModal.openInstance = this;\n            this.elementSelect = elementSelect;\n\n            this.$container = $('<div id=\"previewmodal\" class=\"modal loading\"/>').appendTo(Garnish.$bod);\n\n            this.base(this.$container, $.extend({\n                resizable: true\n            }, settings));\n\n            // Cut the flicker, just show the nice person the preview.\n            if (this.$container) {\n                this.$container.velocity('stop');\n                this.$container.show().css('opacity', 1);\n\n                this.$shade.velocity('stop');\n                this.$shade.show().css('opacity', 1);\n            }\n\n            this.loadAsset(assetId, settings.startingWidth, settings.startingHeight);\n        },\n\n        /**\n         * When hiding, remove all traces and focus last focused element.\n         * @private\n         */\n        _onHide: function () {\n            Craft.PreviewFileModal.openInstance = null;\n            this.elementSelect.focusItem(this.elementSelect.$focusedItem);\n\n            this.$shade.remove();\n\n            return this.destroy();\n        },\n\n        /**\n         * Disappear immediately forever.\n         * @returns {boolean}\n         */\n        selfDestruct: function () {\n            var instance = Craft.PreviewFileModal.openInstance;\n\n            instance.hide();\n            instance.$shade.remove();\n            instance.destroy();\n\n            Craft.PreviewFileModal.openInstance = null;\n\n            return true;\n        },\n\n        /**\n         * Load an asset, using starting width and height, if applicable\n         * @param assetId\n         * @param startingWidth\n         * @param startingHeight\n         */\n        loadAsset: function (assetId, startingWidth, startingHeight) {\n            this.assetId = assetId;\n\n            this.$container.empty();\n            this.loaded = false;\n\n            this.desiredHeight = null;\n            this.desiredWidth = null;\n\n            var containerHeight = Garnish.$win.height() * 0.66;\n            var containerWidth = Math.min(containerHeight / 3 * 4, Garnish.$win.width() - this.settings.minGutter * 2);\n            containerHeight = containerWidth / 4 * 3;\n\n            if (startingWidth && startingHeight) {\n                var ratio = startingWidth / startingHeight;\n                containerWidth =  Math.min(startingWidth, Garnish.$win.width() - this.settings.minGutter * 2);\n                containerHeight = Math.min(containerWidth / ratio, Garnish.$win.height() - this.settings.minGutter * 2);\n                containerWidth = containerHeight * ratio;\n\n                // This might actually have put width over the viewport limits, so doublecheck\n                if (containerWidth > Math.min(startingWidth, Garnish.$win.width() - this.settings.minGutter * 2)) {\n                    containerWidth =  Math.min(startingWidth, Garnish.$win.width() - this.settings.minGutter * 2);\n                    containerHeight = containerWidth / ratio;\n                }\n            }\n\n            this._resizeContainer(containerWidth, containerHeight);\n\n            this.$spinner = $('<div class=\"spinner centeralign\"></div>').appendTo(this.$container);\n            var top = (this.$container.height() / 2 - this.$spinner.height() / 2) + 'px',\n                left = (this.$container.width() / 2 - this.$spinner.width() / 2) + 'px';\n\n            this.$spinner.css({left: left, top: top, position: 'absolute'});\n            this.requestId++;\n\n            Craft.postActionRequest('assets/preview-file', {assetId: assetId, requestId: this.requestId}, function(response, textStatus) {\n                if (textStatus === 'success') {\n                    if (response.success) {\n                        if (response.requestId != this.requestId) {\n                            return;\n                        }\n\n                        this.$container.removeClass('loading');\n                        this.$spinner.remove();\n\n                        this.loaded = true;\n                        this.$container.append(response.modalHtml);\n\n                        var $highlight = this.$container.find('.highlight');\n\n                        if ($highlight.length && $highlight.hasClass('json')) {\n                            var $target = $highlight.find('code');\n                            $target.html(JSON.stringify(JSON.parse($target.html()), undefined, 4));\n                        }\n\n                        if ($highlight.length) {\n                            Prism.highlightElement($highlight.find('code').get(0));\n                        } else {\n                            this.$container.find('img').css({\n                                width: containerWidth,\n                                height: containerHeight\n                            });\n                        }\n\n                        this.updateSizeAndPosition();\n                    } else {\n                        alert(response.error);\n\n                        this.hide();\n                    }\n                }\n            }.bind(this));\n        },\n\n        /**\n         * Override default logic with some extra shenanigans\n         */\n        updateSizeAndPosition: function() {\n            if (!this.loaded) {\n                return;\n            }\n\n            var $img = this.$container.find('img');\n\n            if (this.loaded && $img.length) {\n                // Make sure we maintain the ratio\n\n                var maxWidth = $img.data('maxwidth'),\n                    maxHeight = $img.data('maxheight'),\n                    imageRatio = maxWidth / maxHeight,\n                    desiredWidth = this.desiredWidth ? this.desiredWidth : this.$container.width(),\n                    desiredHeight = this.desiredHeight ? this.desiredHeight : this.$container.height(),\n                    width = Math.min(desiredWidth, maxWidth),\n                    height = Math.round(Math.min(maxHeight, width / imageRatio));\n\n                width = Math.round(height * imageRatio);\n\n                $img.css({'width': width, 'height': height});\n                this._resizeContainer(width, height);\n\n                this.desiredWidth = width;\n                this.desiredHeight = height;\n\n            }\n\n            this.base();\n\n            if (this.loaded && $img.length) {\n                // Correct anomalities\n                var containerWidth = Math.round(Math.min(Math.max($img.height() * imageRatio), Garnish.$win.width() - (this.settings.minGutter * 2))),\n                    containerHeight = Math.round(Math.min(Math.max(containerWidth / imageRatio), Garnish.$win.height() - (this.settings.minGutter * 2)));\n                    containerWidth = Math.round(containerHeight * imageRatio);\n\n                // This might actually have put width over the viewport limits, so doublecheck that\n                if (containerWidth > Math.min(containerWidth, Garnish.$win.width() - this.settings.minGutter * 2)) {\n                    containerWidth =  Math.min(containerWidth, Garnish.$win.width() - this.settings.minGutter * 2);\n                    containerHeight = containerWidth / imageRatio;\n                }\n\n                this._resizeContainer(containerWidth, containerHeight);\n\n                $img.css({'width': containerWidth, 'height': containerHeight});\n            } else if (this.loaded) {\n                this.$container.find('.highlight')\n                    .height(this.$container.height())\n                    .width(this.$container.width())\n                    .css({'overflow': 'auto'});\n            }\n        },\n\n        /**\n         * Resize the container to specified dimensions\n         * @param containerWidth\n         * @param containerHeight\n         * @private\n         */\n        _resizeContainer: function (containerWidth, containerHeight) {\n            this.$container.css({\n                'width': containerWidth,\n                'min-width': containerWidth,\n                'max-width': containerWidth,\n                'height': containerHeight,\n                'min-height': containerHeight,\n                'max-height': containerHeight,\n                'top': (Garnish.$win.height() - containerHeight) / 2,\n                'left': (Garnish.$win.width() - containerWidth) / 2\n            });\n        }\n    },\n    {\n        defaultSettings: {\n            startingWidth: null,\n            startingHeight: null\n        }\n    }\n);\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * File Manager.\n */\nCraft.ProgressBar = Garnish.Base.extend(\n    {\n        $progressBar: null,\n        $innerProgressBar: null,\n        $progressBarStatus: null,\n\n        _itemCount: 0,\n        _processedItemCount: 0,\n        _displaySteps: false,\n\n        init: function($element, displaySteps) {\n            if (displaySteps) {\n                this._displaySteps = true;\n            }\n\n            this.$progressBar = $('<div class=\"progressbar pending hidden\"/>').appendTo($element);\n            this.$innerProgressBar = $('<div class=\"progressbar-inner\"/>').appendTo(this.$progressBar);\n            this.$progressBarStatus = $('<div class=\"progressbar-status hidden\" />').insertAfter(this.$progressBar);\n\n            this.resetProgressBar();\n        },\n\n        /**\n         * Reset the progress bar\n         */\n        resetProgressBar: function() {\n            // Since setting the progress percentage implies that there is progress to be shown\n            // It removes the pending class - we must add it back.\n            this.setProgressPercentage(100);\n            this.$progressBar.addClass('pending');\n\n            // Reset all the counters\n            this.setItemCount(1);\n            this.setProcessedItemCount(0);\n            this.$progressBarStatus.html('');\n\n            if (this._displaySteps) {\n                this.$progressBar.addClass('has-status');\n            }\n        },\n\n        /**\n         * Fade to invisible, hide it using a class and reset opacity to visible\n         */\n        hideProgressBar: function() {\n            this.$progressBar.fadeTo('fast', 0.01, $.proxy(function() {\n                this.$progressBar.addClass('hidden').fadeTo(1, 1, $.noop);\n            }, this));\n        },\n\n        showProgressBar: function() {\n            this.$progressBar.removeClass('hidden');\n            this.$progressBarStatus.removeClass('hidden');\n        },\n\n        setItemCount: function(count) {\n            this._itemCount = count;\n        },\n\n        incrementItemCount: function(count) {\n            this._itemCount += count;\n        },\n\n        setProcessedItemCount: function(count) {\n            this._processedItemCount = count;\n        },\n\n        incrementProcessedItemCount: function(count) {\n            this._processedItemCount += count;\n        },\n\n        updateProgressBar: function() {\n            // Only fools would allow accidental division by zero.\n            this._itemCount = Math.max(this._itemCount, 1);\n\n            var width = Math.min(100, Math.round(100 * this._processedItemCount / this._itemCount));\n\n            this.setProgressPercentage(width);\n\n            if (this._displaySteps) {\n                this.$progressBarStatus.html(this._processedItemCount + ' / ' + this._itemCount);\n            }\n        },\n\n        setProgressPercentage: function(percentage, animate) {\n            if (percentage === 0) {\n                this.$progressBar.addClass('pending');\n            }\n            else {\n                this.$progressBar.removeClass('pending');\n\n                if (animate) {\n                    this.$innerProgressBar.velocity('stop').velocity({width: percentage + '%'}, 'fast');\n                }\n                else {\n                    this.$innerProgressBar.velocity('stop').width(percentage + '%');\n                }\n            }\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * File Manager.\n */\nCraft.PromptHandler = Garnish.Base.extend({\n\n    modal: null,\n    $modalContainerDiv: null,\n    $prompt: null,\n    $promptApplyToRemainingContainer: null,\n    $promptApplyToRemainingCheckbox: null,\n    $promptApplyToRemainingLabel: null,\n    $pomptChoices: null,\n\n\n    _prompts: [],\n    _promptBatchCallback: $.noop,\n    _promptBatchReturnData: [],\n    _promptBatchNum: 0,\n\n    resetPrompts: function() {\n        this._prompts = [];\n        this._promptBatchCallback = $.noop;\n        this._promptBatchReturnData = [];\n        this._promptBatchNum = 0;\n    },\n\n    addPrompt: function(prompt) {\n        this._prompts.push(prompt);\n    },\n\n    getPromptCount: function() {\n        return this._prompts.length;\n    },\n\n    showBatchPrompts: function(callback) {\n        this._promptBatchCallback = callback;\n        this._promptBatchReturnData = [];\n        this._promptBatchNum = 0;\n\n        this._showNextPromptInBatch();\n    },\n\n    _showNextPromptInBatch: function() {\n        var prompt = this._prompts[this._promptBatchNum].prompt,\n            remainingInBatch = this._prompts.length - (this._promptBatchNum + 1);\n\n        this._showPrompt(prompt.message, prompt.choices, $.proxy(this, '_handleBatchPromptSelection'), remainingInBatch);\n    },\n\n    /**\n     * Handles a prompt choice selection.\n     *\n     * @param choice\n     * @param applyToRemaining\n     * @private\n     */\n    _handleBatchPromptSelection: function(choice, applyToRemaining) {\n        var prompt = this._prompts[this._promptBatchNum],\n            remainingInBatch = this._prompts.length - (this._promptBatchNum + 1);\n\n        // Record this choice\n        var choiceData = $.extend(prompt, {choice: choice});\n        this._promptBatchReturnData.push(choiceData);\n\n        // Are there any remaining items in the batch?\n        if (remainingInBatch) {\n            // Get ready to deal with the next prompt\n            this._promptBatchNum++;\n\n            // Apply the same choice to the remaining items?\n            if (applyToRemaining) {\n                this._handleBatchPromptSelection(choice, true);\n            }\n            else {\n                // Show the next prompt\n                this._showNextPromptInBatch();\n            }\n        }\n        else {\n            // All done! Call the callback\n            if (typeof this._promptBatchCallback === 'function') {\n                this._promptBatchCallback(this._promptBatchReturnData);\n            }\n        }\n    },\n\n    /**\n     * Show the user prompt with a given message and choices, plus an optional \"Apply to remaining\" checkbox.\n     *\n     * @param {string} message\n     * @param {object} choices\n     * @param {function} callback\n     * @param {number} itemsToGo\n     */\n    _showPrompt: function(message, choices, callback, itemsToGo) {\n        this._promptCallback = callback;\n\n        if (this.modal === null) {\n            this.modal = new Garnish.Modal({closeOtherModals: false});\n        }\n\n        if (this.$modalContainerDiv === null) {\n            this.$modalContainerDiv = $('<div class=\"modal fitted prompt-modal\"></div>').addClass().appendTo(Garnish.$bod);\n        }\n\n        this.$prompt = $('<div class=\"body\"></div>').appendTo(this.$modalContainerDiv.empty());\n\n        this.$promptMessage = $('<p class=\"prompt-msg\"/>').appendTo(this.$prompt);\n\n        this.$promptChoices = $('<div class=\"options\"></div>').appendTo(this.$prompt);\n\n        this.$promptApplyToRemainingContainer = $('<label class=\"assets-applytoremaining\"/>').appendTo(this.$prompt).hide();\n        this.$promptApplyToRemainingCheckbox = $('<input type=\"checkbox\"/>').appendTo(this.$promptApplyToRemainingContainer);\n        this.$promptApplyToRemainingLabel = $('<span/>').appendTo(this.$promptApplyToRemainingContainer);\n\n        this.$promptButtons = $('<div class=\"buttons right\"/>').appendTo(this.$prompt);\n\n        this.modal.setContainer(this.$modalContainerDiv);\n\n        this.$promptMessage.html(message);\n\n        var $cancelButton = $('<div class=\"btn\">' + Craft.t('app', 'Cancel') + '</div>').appendTo(this.$promptButtons),\n            $submitBtn = $('<input type=\"submit\" class=\"btn submit disabled\" value=\"' + Craft.t('app', 'OK') + '\" />').appendTo(this.$promptButtons);\n\n        for (var i = 0; i < choices.length; i++) {\n            var $radioButtonHtml = $('<div><label><input type=\"radio\" name=\"promptAction\" value=\"' + choices[i].value + '\"/> ' + choices[i].title + '</label></div>').appendTo(this.$promptChoices),\n                $radioButton = $radioButtonHtml.find('input');\n\n            this.addListener($radioButton, 'click', function() {\n                $submitBtn.removeClass('disabled');\n            });\n        }\n\n        this.addListener($submitBtn, 'activate', function(ev) {\n            var choice = $(ev.currentTarget).parents('.modal').find('input[name=promptAction]:checked').val(),\n                applyToRemaining = this.$promptApplyToRemainingCheckbox.prop('checked');\n\n            this._selectPromptChoice(choice, applyToRemaining);\n        });\n\n        this.addListener($cancelButton, 'activate', function() {\n            var choice = 'cancel',\n                applyToRemaining = this.$promptApplyToRemainingCheckbox.prop('checked');\n\n            this._selectPromptChoice(choice, applyToRemaining);\n        });\n\n        if (itemsToGo) {\n            this.$promptApplyToRemainingContainer.show();\n            this.$promptApplyToRemainingLabel.html(' ' + Craft.t('app', 'Apply this to the {number} remaining conflicts?', {number: itemsToGo}));\n        }\n\n        this.modal.show();\n        this.modal.removeListener(Garnish.Modal.$shade, 'click');\n        this.addListener(Garnish.Modal.$shade, 'click', '_cancelPrompt');\n\n    },\n\n    /**\n     * Handles when a user selects one of the prompt choices.\n     *\n     * @param choice\n     * @param applyToRemaining\n     * @private\n     */\n    _selectPromptChoice: function(choice, applyToRemaining) {\n        this.$prompt.fadeOut('fast', $.proxy(function() {\n            this.modal.hide();\n            this._promptCallback(choice, applyToRemaining);\n        }, this));\n    },\n\n    /**\n     * Cancels the prompt.\n     */\n    _cancelPrompt: function() {\n        this._selectPromptChoice('cancel', true);\n    }\n});\n\n/** global: Garnish */\n\nCraft.SlideRuleInput = Garnish.Base.extend({\n\n    $container: null,\n    $options: null,\n    $selectedOption: null,\n    $input: null,\n    value: null,\n\n    startPositionX: null,\n\n    init: function(id, settings) {\n        this.setSettings(settings, Craft.SlideRuleInput.defaultSettings);\n\n        this.value = 0;\n        this.graduationsMin = -70;\n        this.graduationsMax = 70;\n        this.slideMin = -45;\n        this.slideMax = 45;\n\n        this.$container = $('#' + id);\n        this.$overlay = $('<div class=\"overlay\"></div>').appendTo(this.$container);\n        this.$cursor = $('<div class=\"cursor\"></div>').appendTo(this.$container);\n        this.$graduations = $('<div class=\"graduations\"></div>').appendTo(this.$container);\n        this.$graduationsUl = $('<ul></ul>').appendTo(this.$graduations);\n\n        for (var i = this.graduationsMin; i <= this.graduationsMax; i++) {\n            var $li = $('<li class=\"graduation\" data-graduation=\"' + i + '\"><div class=\"label\">' + i + '</div></li>').appendTo(this.$graduationsUl);\n\n            if ((i % 5) === 0) {\n                $li.addClass('main-graduation');\n            }\n\n            if (i === 0) {\n                $li.addClass('selected');\n            }\n        }\n\n        this.$options = this.$container.find('.graduation');\n\n        this.addListener(this.$container, 'resize', $.proxy(this, '_handleResize'));\n        this.addListener(this.$container, 'tapstart', $.proxy(this, '_handleTapStart'));\n        this.addListener(Garnish.$bod, 'tapmove', $.proxy(this, '_handleTapMove'));\n        this.addListener(Garnish.$bod, 'tapend', $.proxy(this, '_handleTapEnd'));\n\n        // Set to zero\n\n        // this.setValue(0);\n\n        setTimeout($.proxy(function() {\n            // (n -1) options because the border is placed on the left of the 10px box\n            this.graduationsCalculatedWidth = (this.$options.length - 1) * 10;\n            this.$graduationsUl.css('left', (-this.graduationsCalculatedWidth / 2) + this.$container.width() / 2);\n        }, this), 50);\n    },\n\n    _handleResize: function() {\n        var left = this.valueToPosition(this.value);\n        this.$graduationsUl.css('left', left);\n    },\n\n    _handleTapStart: function(ev, touch) {\n        ev.preventDefault();\n\n        this.startPositionX = touch.position.x;\n        this.startLeft = this.$graduationsUl.position().left;\n\n        this.dragging = true;\n        this.onStart();\n    },\n\n    _handleTapMove: function(ev, touch) {\n        if (this.dragging) {\n            ev.preventDefault();\n\n            var curX = this.startPositionX - touch.position.x;\n            var left = this.startLeft - curX;\n            var value = this.positionToValue(left);\n\n            this.setValue(value);\n\n            this.onChange();\n        }\n    },\n\n    setValue: function(value) {\n        var left = this.valueToPosition(value);\n        if (value < this.slideMin) {\n            value = this.slideMin;\n            left = this.valueToPosition(value);\n\n        }\n        else if (value > this.slideMax) {\n            value = this.slideMax;\n            left = this.valueToPosition(value);\n        }\n\n        this.$graduationsUl.css('left', left);\n\n        if (value >= this.slideMin && value <= this.slideMax) {\n            this.$options.removeClass('selected');\n\n            $.each(this.$options, function(key, option) {\n                if ($(option).data('graduation') > 0) {\n                    if ($(option).data('graduation') <= value) {\n                        $(option).addClass('selected');\n                    }\n                }\n                if ($(option).data('graduation') < 0) {\n                    if ($(option).data('graduation') >= value) {\n                        $(option).addClass('selected');\n                    }\n                }\n\n                if ($(option).data('graduation') == 0) {\n                    $(option).addClass('selected');\n                }\n            });\n        }\n\n        this.value = value;\n    },\n\n    _handleTapEnd: function(ev) {\n        if (this.dragging) {\n            ev.preventDefault();\n            this.dragging = false;\n            this.onEnd();\n        }\n    },\n\n    positionToValue: function(position) {\n        var scaleMin = (this.graduationsMin * -1);\n        var scaleMax = (this.graduationsMin - this.graduationsMax) * -1;\n\n        return (( ( this.$graduations.width() / 2 ) + (position * -1) ) / this.graduationsCalculatedWidth) * scaleMax - scaleMin;\n    },\n\n    valueToPosition: function(value) {\n        var scaleMin = (this.graduationsMin * -1);\n        var scaleMax = (this.graduationsMin - this.graduationsMax) * -1;\n\n        return -((value + scaleMin) * this.graduationsCalculatedWidth / scaleMax - this.$graduations.width() / 2);\n    },\n\n    onStart: function() {\n        if (typeof this.settings.onChange === 'function') {\n            this.settings.onStart(this);\n        }\n    },\n\n    onChange: function() {\n        if (typeof this.settings.onChange === 'function') {\n            this.settings.onChange(this);\n        }\n    },\n\n    onEnd: function() {\n        if (typeof this.settings.onChange === 'function') {\n            this.settings.onEnd(this);\n        }\n    },\n\n    defaultSettings: {\n        onStart: $.noop,\n        onChange: $.noop,\n        onEnd: $.noop\n    }\n});\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Slug Generator\n */\nCraft.SlugGenerator = Craft.BaseInputGenerator.extend(\n    {\n        generateTargetValue: function(sourceVal) {\n            // Remove HTML tags\n            sourceVal = sourceVal.replace(/<(.*?)>/g, '');\n\n            // Remove inner-word punctuation\n            sourceVal = sourceVal.replace(/['\"\u2018\u2019\u201c\u201d\\[\\]\\(\\)\\{\\}:]/g, '');\n\n            // Make it lowercase\n            if (!Craft.allowUppercaseInSlug) {\n                sourceVal = sourceVal.toLowerCase();\n            }\n\n            if (Craft.limitAutoSlugsToAscii) {\n                // Convert extended ASCII characters to basic ASCII\n                sourceVal = Craft.asciiString(sourceVal, this.settings.charMap);\n            }\n\n            // Get the \"words\". Split on anything that is not alphanumeric.\n            // Reference: http://www.regular-expressions.info/unicode.html\n            var words = Craft.filterArray(XRegExp.matchChain(sourceVal, [XRegExp('[\\\\p{L}\\\\p{N}\\\\p{M}]+')]));\n\n            if (words.length) {\n                return words.join(Craft.slugWordSeparator);\n            }\n            else {\n                return '';\n            }\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Structure class\n */\nCraft.Structure = Garnish.Base.extend(\n    {\n        id: null,\n\n        $container: null,\n        state: null,\n        structureDrag: null,\n\n        /**\n         * Init\n         */\n        init: function(id, container, settings) {\n            this.id = id;\n            this.$container = $(container);\n            this.setSettings(settings, Craft.Structure.defaults);\n\n            // Is this already a structure?\n            if (this.$container.data('structure')) {\n                Garnish.log('Double-instantiating a structure on an element');\n                this.$container.data('structure').destroy();\n            }\n\n            this.$container.data('structure', this);\n\n            this.state = {};\n\n            if (this.settings.storageKey) {\n                $.extend(this.state, Craft.getLocalStorage(this.settings.storageKey, {}));\n            }\n\n            if (typeof this.state.collapsedElementIds === 'undefined') {\n                this.state.collapsedElementIds = [];\n            }\n\n            var $parents = this.$container.find('ul').prev('.row');\n\n            for (var i = 0; i < $parents.length; i++) {\n                var $row = $($parents[i]),\n                    $li = $row.parent(),\n                    $toggle = $('<div class=\"toggle\" title=\"' + Craft.t('app', 'Show/hide children') + '\"/>').prependTo($row);\n\n                if ($.inArray($row.children('.element').data('id'), this.state.collapsedElementIds) !== -1) {\n                    $li.addClass('collapsed');\n                }\n\n                this.initToggle($toggle);\n            }\n\n            if (this.settings.sortable) {\n                this.structureDrag = new Craft.StructureDrag(this, this.settings.maxLevels);\n            }\n\n            if (this.settings.newChildUrl) {\n                this.initNewChildMenus(this.$container.find('.add'));\n            }\n        },\n\n        initToggle: function($toggle) {\n            $toggle.on('click', $.proxy(function(ev) {\n                var $li = $(ev.currentTarget).closest('li'),\n                    elementId = $li.children('.row').find('.element:first').data('id'),\n                    viewStateKey = $.inArray(elementId, this.state.collapsedElementIds);\n\n                if ($li.hasClass('collapsed')) {\n                    $li.removeClass('collapsed');\n\n                    if (viewStateKey !== -1) {\n                        this.state.collapsedElementIds.splice(viewStateKey, 1);\n                    }\n                }\n                else {\n                    $li.addClass('collapsed');\n\n                    if (viewStateKey === -1) {\n                        this.state.collapsedElementIds.push(elementId);\n                    }\n                }\n\n                if (this.settings.storageKey) {\n                    Craft.setLocalStorage(this.settings.storageKey, this.state);\n                }\n\n            }, this));\n        },\n\n        initNewChildMenus: function($addBtns) {\n            this.addListener($addBtns, 'click', 'onNewChildMenuClick');\n        },\n\n        onNewChildMenuClick: function(ev) {\n            var $btn = $(ev.currentTarget);\n\n            if (!$btn.data('menubtn')) {\n                var elementId = $btn.parent().children('.element').data('id'),\n                    newChildUrl = Craft.getUrl(this.settings.newChildUrl, 'parentId=' + elementId);\n\n                $('<div class=\"menu\"><ul><li><a href=\"' + newChildUrl + '\">' + Craft.t('app', 'New child') + '</a></li></ul></div>').insertAfter($btn);\n\n                var menuBtn = new Garnish.MenuBtn($btn);\n                menuBtn.showMenu();\n            }\n        },\n\n        getIndent: function(level) {\n            return Craft.Structure.baseIndent + (level - 1) * Craft.Structure.nestedIndent;\n        },\n\n        addElement: function($element) {\n            var $li = $('<li data-level=\"1\"/>').appendTo(this.$container),\n                $row = $('<div class=\"row\" style=\"margin-' + Craft.left + ': -' + Craft.Structure.baseIndent + 'px; padding-' + Craft.left + ': ' + Craft.Structure.baseIndent + 'px;\">').appendTo($li);\n\n            $row.append($element);\n\n            if (this.settings.sortable) {\n                $row.append('<a class=\"move icon\" title=\"' + Craft.t('app', 'Move') + '\"></a>');\n                this.structureDrag.addItems($li);\n            }\n\n            if (this.settings.newChildUrl) {\n                var $addBtn = $('<a class=\"add icon\" title=\"' + Craft.t('app', 'New child') + '\"></a>').appendTo($row);\n                this.initNewChildMenus($addBtn);\n            }\n\n            $row.css('margin-bottom', -30);\n            $row.velocity({'margin-bottom': 0}, 'fast');\n        },\n\n        removeElement: function($element) {\n            var $li = $element.parent().parent();\n\n            if (this.settings.sortable) {\n                this.structureDrag.removeItems($li);\n            }\n\n            var $parentUl;\n\n            if (!$li.siblings().length) {\n                $parentUl = $li.parent();\n            }\n\n            $li.css('visibility', 'hidden').velocity({marginBottom: -$li.height()}, 'fast', $.proxy(function() {\n                $li.remove();\n\n                if (typeof $parentUl !== 'undefined') {\n                    this._removeUl($parentUl);\n                }\n            }, this));\n        },\n\n        _removeUl: function($ul) {\n            $ul.siblings('.row').children('.toggle').remove();\n            $ul.remove();\n        }\n    },\n    {\n        baseIndent: 8,\n        nestedIndent: 35,\n\n        defaults: {\n            storageKey: null,\n            sortable: false,\n            newChildUrl: null,\n            maxLevels: null\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Structure drag class\n */\nCraft.StructureDrag = Garnish.Drag.extend(\n    {\n        structure: null,\n        maxLevels: null,\n        draggeeLevel: null,\n\n        $helperLi: null,\n        $targets: null,\n        draggeeHeight: null,\n\n        init: function(structure, maxLevels) {\n            this.structure = structure;\n            this.maxLevels = maxLevels;\n\n            this.$insertion = $('<li class=\"draginsertion\"/>');\n\n            var $items = this.structure.$container.find('li');\n\n            this.base($items, {\n                handle: '.element:first, .move:first',\n                helper: $.proxy(this, 'getHelper')\n            });\n        },\n\n        getHelper: function($helper) {\n            this.$helperLi = $helper;\n            var $ul = $('<ul class=\"structure draghelper\"/>').append($helper);\n            $helper.css('padding-' + Craft.left, this.$draggee.css('padding-' + Craft.left));\n            $helper.find('.move').removeAttr('title');\n            return $ul;\n        },\n\n        onDragStart: function() {\n            this.$targets = $();\n\n            // Recursively find each of the targets, in the order they appear to be in\n            this.findTargets(this.structure.$container);\n\n            // How deep does the rabbit hole go?\n            this.draggeeLevel = 0;\n            var $level = this.$draggee;\n            do {\n                this.draggeeLevel++;\n                $level = $level.find('> ul > li');\n            } while ($level.length);\n\n            // Collapse the draggee\n            this.draggeeHeight = this.$draggee.height();\n            this.$draggee.velocity({\n                height: 0\n            }, 'fast', $.proxy(function() {\n                this.$draggee.addClass('hidden');\n            }, this));\n            this.base();\n\n            this.addListener(Garnish.$doc, 'keydown', function(ev) {\n                if (ev.keyCode === Garnish.ESC_KEY) {\n                    this.cancelDrag();\n                }\n            });\n        },\n\n        findTargets: function($ul) {\n            var $lis = $ul.children().not(this.$draggee);\n\n            for (var i = 0; i < $lis.length; i++) {\n                var $li = $($lis[i]);\n                this.$targets = this.$targets.add($li.children('.row'));\n\n                if (!$li.hasClass('collapsed')) {\n                    this.findTargets($li.children('ul'));\n                }\n            }\n        },\n\n        onDrag: function() {\n            if (this._.$closestTarget) {\n                this._.$closestTarget.removeClass('draghover');\n                this.$insertion.remove();\n            }\n\n            // First let's find the closest target\n            this._.$closestTarget = null;\n            this._.closestTargetPos = null;\n            this._.closestTargetYDiff = null;\n            this._.closestTargetOffset = null;\n            this._.closestTargetHeight = null;\n\n            for (this._.i = 0; this._.i < this.$targets.length; this._.i++) {\n                this._.$target = $(this.$targets[this._.i]);\n                this._.targetOffset = this._.$target.offset();\n                this._.targetHeight = this._.$target.outerHeight();\n                this._.targetYMidpoint = this._.targetOffset.top + (this._.targetHeight / 2);\n                this._.targetYDiff = Math.abs(this.mouseY - this._.targetYMidpoint);\n\n                if (this._.i === 0 || (this.mouseY >= this._.targetOffset.top + 5 && this._.targetYDiff < this._.closestTargetYDiff)) {\n                    this._.$closestTarget = this._.$target;\n                    this._.closestTargetPos = this._.i;\n                    this._.closestTargetYDiff = this._.targetYDiff;\n                    this._.closestTargetOffset = this._.targetOffset;\n                    this._.closestTargetHeight = this._.targetHeight;\n                }\n                else {\n                    // Getting colder\n                    break;\n                }\n            }\n\n            if (!this._.$closestTarget) {\n                return;\n            }\n\n            // Are we hovering above the first row?\n            if (this._.closestTargetPos === 0 && this.mouseY < this._.closestTargetOffset.top + 5) {\n                this.$insertion.prependTo(this.structure.$container);\n            }\n            else {\n                this._.$closestTargetLi = this._.$closestTarget.parent();\n                this._.closestTargetLevel = this._.$closestTargetLi.data('level');\n\n                // Is there a next row?\n                if (this._.closestTargetPos < this.$targets.length - 1) {\n                    this._.$nextTargetLi = $(this.$targets[this._.closestTargetPos + 1]).parent();\n                    this._.nextTargetLevel = this._.$nextTargetLi.data('level');\n                }\n                else {\n                    this._.$nextTargetLi = null;\n                    this._.nextTargetLevel = null;\n                }\n\n                // Are we hovering between this row and the next one?\n                this._.hoveringBetweenRows = (this.mouseY >= this._.closestTargetOffset.top + this._.closestTargetHeight - 5);\n\n                /**\n                 * Scenario 1: Both rows have the same level.\n                 *\n                 *     * Row 1\n                 *     ----------------------\n                 *     * Row 2\n                 */\n\n                if (this._.$nextTargetLi && this._.nextTargetLevel == this._.closestTargetLevel) {\n                    if (this._.hoveringBetweenRows) {\n                        if (!this.maxLevels || this.maxLevels >= (this._.closestTargetLevel + this.draggeeLevel - 1)) {\n                            // Position the insertion after the closest target\n                            this.$insertion.insertAfter(this._.$closestTargetLi);\n                        }\n\n                    }\n                    else {\n                        if (!this.maxLevels || this.maxLevels >= (this._.closestTargetLevel + this.draggeeLevel)) {\n                            this._.$closestTarget.addClass('draghover');\n                        }\n                    }\n                }\n\n                /**\n                 * Scenario 2: Next row is a child of this one.\n                 *\n                 *     * Row 1\n                 *     ----------------------\n                 *         * Row 2\n                 */\n\n                else if (this._.$nextTargetLi && this._.nextTargetLevel > this._.closestTargetLevel) {\n                    if (!this.maxLevels || this.maxLevels >= (this._.nextTargetLevel + this.draggeeLevel - 1)) {\n                        if (this._.hoveringBetweenRows) {\n                            // Position the insertion as the first child of the closest target\n                            this.$insertion.insertBefore(this._.$nextTargetLi);\n                        }\n                        else {\n                            this._.$closestTarget.addClass('draghover');\n                            this.$insertion.appendTo(this._.$closestTargetLi.children('ul'));\n                        }\n                    }\n                }\n\n                /**\n                 * Scenario 3: Next row is a child of a parent node, or there is no next row.\n                 *\n                 *         * Row 1\n                 *     ----------------------\n                 *     * Row 2\n                 */\n\n                else {\n                    if (this._.hoveringBetweenRows) {\n                        // Determine which <li> to position the insertion after\n                        this._.draggeeX = this.mouseX - this.targetItemMouseDiffX;\n\n                        if (Craft.orientation === 'rtl') {\n                            this._.draggeeX += this.$helperLi.width();\n                        }\n\n                        this._.$parentLis = this._.$closestTarget.parentsUntil(this.structure.$container, 'li');\n                        this._.$closestParentLi = null;\n                        this._.closestParentLiXDiff = null;\n                        this._.closestParentLevel = null;\n\n                        for (this._.i = 0; this._.i < this._.$parentLis.length; this._.i++) {\n                            this._.$parentLi = $(this._.$parentLis[this._.i]);\n                            this._.parentLiX = this._.$parentLi.offset().left;\n\n                            if (Craft.orientation === 'rtl') {\n                                this._.parentLiX += this._.$parentLi.width();\n                            }\n\n                            this._.parentLiXDiff = Math.abs(this._.parentLiX - this._.draggeeX);\n                            this._.parentLevel = this._.$parentLi.data('level');\n\n                            if ((!this.maxLevels || this.maxLevels >= (this._.parentLevel + this.draggeeLevel - 1)) && (\n                                    !this._.$closestParentLi || (\n                                        this._.parentLiXDiff < this._.closestParentLiXDiff &&\n                                        (!this._.$nextTargetLi || this._.parentLevel >= this._.nextTargetLevel)\n                                    )\n                                )) {\n                                this._.$closestParentLi = this._.$parentLi;\n                                this._.closestParentLiXDiff = this._.parentLiXDiff;\n                                this._.closestParentLevel = this._.parentLevel;\n                            }\n                        }\n\n                        if (this._.$closestParentLi) {\n                            this.$insertion.insertAfter(this._.$closestParentLi);\n                        }\n                    }\n                    else {\n                        if (!this.maxLevels || this.maxLevels >= (this._.closestTargetLevel + this.draggeeLevel)) {\n                            this._.$closestTarget.addClass('draghover');\n                        }\n                    }\n                }\n            }\n        },\n\n        cancelDrag: function() {\n            this.$insertion.remove();\n\n            if (this._.$closestTarget) {\n                this._.$closestTarget.removeClass('draghover');\n            }\n\n            this.onMouseUp();\n        },\n\n        onDragStop: function() {\n            // Are we repositioning the draggee?\n            if (this._.$closestTarget && (this.$insertion.parent().length || this._.$closestTarget.hasClass('draghover'))) {\n                var $draggeeParent,\n                    moved;\n\n                // Are we about to leave the draggee's original parent childless?\n                if (!this.$draggee.siblings().length) {\n                    $draggeeParent = this.$draggee.parent();\n                }\n\n                if (this.$insertion.parent().length) {\n                    // Make sure the insertion isn't right next to the draggee\n                    var $closestSiblings = this.$insertion.next().add(this.$insertion.prev());\n\n                    if ($.inArray(this.$draggee[0], $closestSiblings) === -1) {\n                        this.$insertion.replaceWith(this.$draggee);\n                        moved = true;\n                    }\n                    else {\n                        this.$insertion.remove();\n                        moved = false;\n                    }\n                }\n                else {\n                    var $ul = this._.$closestTargetLi.children('ul');\n\n                    // Make sure this is a different parent than the draggee's\n                    if (!$draggeeParent || !$ul.length || $ul[0] !== $draggeeParent[0]) {\n                        if (!$ul.length) {\n                            var $toggle = $('<div class=\"toggle\" title=\"' + Craft.t('app', 'Show/hide children') + '\"/>').prependTo(this._.$closestTarget);\n                            this.structure.initToggle($toggle);\n\n                            $ul = $('<ul>').appendTo(this._.$closestTargetLi);\n                        }\n                        else if (this._.$closestTargetLi.hasClass('collapsed')) {\n                            this._.$closestTarget.children('.toggle').trigger('click');\n                        }\n\n                        this.$draggee.appendTo($ul);\n                        moved = true;\n                    }\n                    else {\n                        moved = false;\n                    }\n                }\n\n                // Remove the class either way\n                this._.$closestTarget.removeClass('draghover');\n\n                if (moved) {\n                    // Now deal with the now-childless parent\n                    if ($draggeeParent) {\n                        this.structure._removeUl($draggeeParent);\n                    }\n\n                    // Has the level changed?\n                    var newLevel = this.$draggee.parentsUntil(this.structure.$container, 'li').length + 1;\n\n                    var animateCss;\n\n                    if (newLevel != this.$draggee.data('level')) {\n                        // Correct the helper's padding if moving to/from level 1\n                        if (this.$draggee.data('level') == 1) {\n                            animateCss = {};\n                            animateCss['padding-' + Craft.left] = 38;\n                            this.$helperLi.velocity(animateCss, 'fast');\n                        }\n                        else if (newLevel == 1) {\n                            animateCss = {};\n                            animateCss['padding-' + Craft.left] = Craft.Structure.baseIndent;\n                            this.$helperLi.velocity(animateCss, 'fast');\n                        }\n\n                        this.setLevel(this.$draggee, newLevel);\n                    }\n\n                    // Make it real\n                    var $element = this.$draggee.children('.row').children('.element');\n\n                    var data = {\n                        structureId: this.structure.id,\n                        elementId: $element.data('id'),\n                        siteId: $element.data('site-id'),\n                        prevId: this.$draggee.prev().children('.row').children('.element').data('id'),\n                        parentId: this.$draggee.parent('ul').parent('li').children('.row').children('.element').data('id')\n                    };\n\n                    Craft.postActionRequest('structures/move-element', data, function(response, textStatus) {\n                        if (textStatus === 'success') {\n                            Craft.cp.displayNotice(Craft.t('app', 'New order saved.'));\n                        }\n\n                    });\n                }\n            }\n\n            // Animate things back into place\n            this.$draggee.velocity('stop').removeClass('hidden').velocity({\n                height: this.draggeeHeight\n            }, 'fast', $.proxy(function() {\n                this.$draggee.css('height', 'auto');\n            }, this));\n\n            this.returnHelpersToDraggees();\n\n            this.base();\n        },\n\n        setLevel: function($li, level) {\n            $li.data('level', level);\n\n            var indent = this.structure.getIndent(level);\n\n            var css = {};\n            css['margin-' + Craft.left] = '-' + indent + 'px';\n            css['padding-' + Craft.left] = indent + 'px';\n            this.$draggee.children('.row').css(css);\n\n            var $childLis = $li.children('ul').children();\n\n            for (var i = 0; i < $childLis.length; i++) {\n                this.setLevel($($childLis[i]), level + 1);\n            }\n        }\n\n    });\n\n/** global: Craft */\n/** global: Garnish */\nCraft.StructureTableSorter = Garnish.DragSort.extend({\n\n        // Properties\n        // =========================================================================\n\n        tableView: null,\n        structureId: null,\n        maxLevels: null,\n\n        _helperMargin: null,\n\n        _$firstRowCells: null,\n        _$titleHelperCell: null,\n\n        _titleHelperCellOuterWidth: null,\n\n        _ancestors: null,\n        _updateAncestorsFrame: null,\n        _updateAncestorsProxy: null,\n\n        _draggeeLevel: null,\n        _draggeeLevelDelta: null,\n        draggingLastElements: null,\n        _loadingDraggeeLevelDelta: false,\n\n        _targetLevel: null,\n        _targetLevelBounds: null,\n\n        _positionChanged: null,\n\n        // Public methods\n        // =========================================================================\n\n        /**\n         * Constructor\n         */\n        init: function(tableView, $elements, settings) {\n            this.tableView = tableView;\n            this.structureId = this.tableView.$table.data('structure-id');\n            this.maxLevels = parseInt(this.tableView.$table.attr('data-max-levels'));\n\n            settings = $.extend({}, Craft.StructureTableSorter.defaults, settings, {\n                handle: '.move',\n                collapseDraggees: true,\n                singleHelper: true,\n                helperSpacingY: 2,\n                magnetStrength: 4,\n                helper: $.proxy(this, 'getHelper'),\n                helperLagBase: 1.5,\n                axis: Garnish.Y_AXIS\n            });\n\n            this.base($elements, settings);\n        },\n\n        /**\n         * Start Dragging\n         */\n        startDragging: function() {\n            this._helperMargin = Craft.StructureTableSorter.HELPER_MARGIN + (this.tableView.elementIndex.actions ? 24 : 0);\n            this.base();\n        },\n\n        /**\n         * Returns the draggee rows (including any descendent rows).\n         */\n        findDraggee: function() {\n            this._draggeeLevel = this._targetLevel = this.$targetItem.data('level');\n            this._draggeeLevelDelta = 0;\n\n            var $draggee = $(this.$targetItem),\n                $nextRow = this.$targetItem.next();\n\n            while ($nextRow.length) {\n                // See if this row is a descendant of the draggee\n                var nextRowLevel = $nextRow.data('level');\n\n                if (nextRowLevel <= this._draggeeLevel) {\n                    break;\n                }\n\n                // Is this the deepest descendant we've seen so far?\n                var nextRowLevelDelta = nextRowLevel - this._draggeeLevel;\n\n                if (nextRowLevelDelta > this._draggeeLevelDelta) {\n                    this._draggeeLevelDelta = nextRowLevelDelta;\n                }\n\n                // Add it and prep the next row\n                $draggee = $draggee.add($nextRow);\n                $nextRow = $nextRow.next();\n            }\n\n            // Are we dragging the last elements on the page?\n            this.draggingLastElements = !$nextRow.length;\n\n            // Do we have a maxLevels to enforce,\n            // and does it look like this draggee has descendants we don't know about yet?\n            if (\n                this.maxLevels &&\n                this.draggingLastElements &&\n                this.tableView.getMorePending()\n            ) {\n                // Only way to know the true descendant level delta is to ask PHP\n                this._loadingDraggeeLevelDelta = true;\n\n                var data = this._getAjaxBaseData(this.$targetItem);\n\n                Craft.postActionRequest('structures/get-element-level-delta', data, $.proxy(function(response, textStatus) {\n                    if (textStatus === 'success') {\n                        this._loadingDraggeeLevelDelta = false;\n\n                        if (this.dragging) {\n                            this._draggeeLevelDelta = response.delta;\n                            this.drag(false);\n                        }\n                    }\n                }, this));\n            }\n\n            return $draggee;\n        },\n\n        /**\n         * Returns the drag helper.\n         */\n        getHelper: function($helperRow) {\n            var $outerContainer = $('<div class=\"elements datatablesorthelper\"/>').appendTo(Garnish.$bod),\n                $innerContainer = $('<div class=\"tableview\"/>').appendTo($outerContainer),\n                $table = $('<table class=\"data\"/>').appendTo($innerContainer),\n                $tbody = $('<tbody/>').appendTo($table);\n\n            $helperRow.appendTo($tbody);\n\n            // Copy the column widths\n            this._$firstRowCells = this.tableView.$elementContainer.children('tr:first').children();\n            var $helperCells = $helperRow.children();\n\n            for (var i = 0; i < $helperCells.length; i++) {\n                var $helperCell = $($helperCells[i]);\n\n                // Skip the checkbox cell\n                if ($helperCell.hasClass('checkbox-cell')) {\n                    $helperCell.remove();\n                    continue;\n                }\n\n                // Hard-set the cell widths\n                var $firstRowCell = $(this._$firstRowCells[i]),\n                    width = $firstRowCell.width();\n\n                $firstRowCell.width(width);\n                $helperCell.width(width);\n\n                // Is this the title cell?\n                if (Garnish.hasAttr($firstRowCell, 'data-titlecell')) {\n                    this._$titleHelperCell = $helperCell;\n\n                    var padding = parseInt($firstRowCell.css('padding-' + Craft.left));\n                    this._titleHelperCellOuterWidth = width + padding - (this.tableView.elementIndex.actions ? 12 : 0);\n\n                    $helperCell.css('padding-' + Craft.left, Craft.StructureTableSorter.BASE_PADDING);\n                }\n            }\n\n            return $outerContainer;\n        },\n\n        /**\n         * Returns whether the draggee can be inserted before a given item.\n         */\n        canInsertBefore: function($item) {\n            if (this._loadingDraggeeLevelDelta) {\n                return false;\n            }\n\n            return (this._getLevelBounds($item.prev(), $item) !== false);\n        },\n\n        /**\n         * Returns whether the draggee can be inserted after a given item.\n         */\n        canInsertAfter: function($item) {\n            if (this._loadingDraggeeLevelDelta) {\n                return false;\n            }\n\n            return (this._getLevelBounds($item, $item.next()) !== false);\n        },\n\n        // Events\n        // -------------------------------------------------------------------------\n\n        /**\n         * On Drag Start\n         */\n        onDragStart: function() {\n            // Get the initial set of ancestors, before the item gets moved\n            this._ancestors = this._getAncestors(this.$targetItem, this.$targetItem.data('level'));\n\n            // Set the initial target level bounds\n            this._setTargetLevelBounds();\n\n            // Check to see if we should load more elements now\n            this.tableView.maybeLoadMore();\n\n            this.base();\n        },\n\n        /**\n         * On Drag\n         */\n        onDrag: function() {\n            this.base();\n            this._updateIndent();\n        },\n\n        /**\n         * On Insertion Point Change\n         */\n        onInsertionPointChange: function() {\n            this._setTargetLevelBounds();\n            this._updateAncestorsBeforeRepaint();\n            this.base();\n        },\n\n        /**\n         * On Drag Stop\n         */\n        onDragStop: function() {\n            this._positionChanged = false;\n            this.base();\n\n            // Update the draggee's padding if the position just changed\n            // ---------------------------------------------------------------------\n\n            if (this._targetLevel != this._draggeeLevel) {\n                var levelDiff = this._targetLevel - this._draggeeLevel;\n\n                for (var i = 0; i < this.$draggee.length; i++) {\n                    var $draggee = $(this.$draggee[i]),\n                        oldLevel = $draggee.data('level'),\n                        newLevel = oldLevel + levelDiff,\n                        padding = Craft.StructureTableSorter.BASE_PADDING + (this.tableView.elementIndex.actions ? 7 : 0) + this._getLevelIndent(newLevel);\n\n                    $draggee.data('level', newLevel);\n                    $draggee.find('.element').data('level', newLevel);\n                    $draggee.children('[data-titlecell]:first').css('padding-' + Craft.left, padding);\n                }\n\n                this._positionChanged = true;\n            }\n\n            // Keep in mind this could have also been set by onSortChange()\n            if (this._positionChanged) {\n                // Tell the server about the new position\n                // -----------------------------------------------------------------\n\n                var data = this._getAjaxBaseData(this.$draggee);\n\n                // Find the previous sibling/parent, if there is one\n                var $prevRow = this.$draggee.first().prev();\n\n                while ($prevRow.length) {\n                    var prevRowLevel = $prevRow.data('level');\n\n                    if (prevRowLevel == this._targetLevel) {\n                        data.prevId = $prevRow.data('id');\n                        break;\n                    }\n\n                    if (prevRowLevel < this._targetLevel) {\n                        data.parentId = $prevRow.data('id');\n\n                        // Is this row collapsed?\n                        var $toggle = $prevRow.find('> td > .toggle');\n\n                        if (!$toggle.hasClass('expanded')) {\n                            // Make it look expanded\n                            $toggle.addClass('expanded');\n\n                            // Add a temporary row\n                            var $spinnerRow = this.tableView._createSpinnerRowAfter($prevRow);\n\n                            // Remove the target item\n                            if (this.tableView.elementSelect) {\n                                this.tableView.elementSelect.removeItems(this.$targetItem);\n                            }\n\n                            this.removeItems(this.$targetItem);\n                            this.$targetItem.remove();\n                            this.tableView._totalVisible--;\n                        }\n\n                        break;\n                    }\n\n                    $prevRow = $prevRow.prev();\n                }\n\n                Craft.postActionRequest('structures/move-element', data, $.proxy(function(response, textStatus) {\n                    if (textStatus === 'success') {\n                        if (!response.success) {\n                            Craft.cp.displayError(Craft.t('app', 'An unknown error occurred.'));\n                            this.tableView.elementIndex.updateElements();\n                            return;\n                        }\n                        Craft.cp.displayNotice(Craft.t('app', 'New position saved.'));\n                        this.onPositionChange();\n\n                        // Were we waiting on this to complete so we can expand the new parent?\n                        if ($spinnerRow && $spinnerRow.parent().length) {\n                            $spinnerRow.remove();\n                            this.tableView._expandElement($toggle, true);\n                        }\n\n                        // See if we should run any pending tasks\n                        Craft.cp.runQueue();\n                    }\n                }, this));\n            }\n        },\n\n        onSortChange: function() {\n            if (this.tableView.elementSelect) {\n                this.tableView.elementSelect.resetItemOrder();\n            }\n\n            this._positionChanged = true;\n            this.base();\n        },\n\n        onPositionChange: function() {\n            Garnish.requestAnimationFrame($.proxy(function() {\n                this.trigger('positionChange');\n                this.settings.onPositionChange();\n            }, this));\n        },\n\n        onReturnHelpersToDraggees: function() {\n            this._$firstRowCells.css('width', '');\n\n            // If we were dragging the last elements on the page and ended up loading any additional elements in,\n            // there could be a gap between the last draggee item and whatever now comes after it.\n            // So remove the post-draggee elements and possibly load up the next batch.\n            if (this.draggingLastElements && this.tableView.getMorePending()) {\n                // Update the element index's record of how many items are actually visible\n                this.tableView._totalVisible += (this.newDraggeeIndexes[0] - this.oldDraggeeIndexes[0]);\n\n                var $postDraggeeItems = this.$draggee.last().nextAll();\n\n                if ($postDraggeeItems.length) {\n                    this.removeItems($postDraggeeItems);\n                    $postDraggeeItems.remove();\n                    this.tableView.maybeLoadMore();\n                }\n            }\n\n            this.base();\n        },\n\n        // Private methods\n        // =========================================================================\n\n        /**\n         * Returns the min and max levels that the draggee could occupy between\n         * two given rows, or false if it\u2019s not going to work out.\n         */\n        _getLevelBounds: function($prevRow, $nextRow) {\n            // Can't go any lower than the next row, if there is one\n            if ($nextRow && $nextRow.length) {\n                this._getLevelBounds._minLevel = $nextRow.data('level');\n            }\n            else {\n                this._getLevelBounds._minLevel = 1;\n            }\n\n            // Can't go any higher than the previous row + 1\n            if ($prevRow && $prevRow.length) {\n                this._getLevelBounds._maxLevel = $prevRow.data('level') + 1;\n            }\n            else {\n                this._getLevelBounds._maxLevel = 1;\n            }\n\n            // Does this structure have a max level?\n            if (this.maxLevels) {\n                // Make sure it's going to fit at all here\n                if (\n                    this._getLevelBounds._minLevel != 1 &&\n                    this._getLevelBounds._minLevel + this._draggeeLevelDelta > this.maxLevels\n                ) {\n                    return false;\n                }\n\n                // Limit the max level if we have to\n                if (this._getLevelBounds._maxLevel + this._draggeeLevelDelta > this.maxLevels) {\n                    this._getLevelBounds._maxLevel = this.maxLevels - this._draggeeLevelDelta;\n\n                    if (this._getLevelBounds._maxLevel < this._getLevelBounds._minLevel) {\n                        this._getLevelBounds._maxLevel = this._getLevelBounds._minLevel;\n                    }\n                }\n            }\n\n            return {\n                min: this._getLevelBounds._minLevel,\n                max: this._getLevelBounds._maxLevel\n            };\n        },\n\n        /**\n         * Determines the min and max possible levels at the current draggee's position.\n         */\n        _setTargetLevelBounds: function() {\n            this._targetLevelBounds = this._getLevelBounds(\n                this.$draggee.first().prev(),\n                this.$draggee.last().next()\n            );\n        },\n\n        /**\n         * Determines the target level based on the current mouse position.\n         */\n        _updateIndent: function(forcePositionChange) {\n            // Figure out the target level\n            // ---------------------------------------------------------------------\n\n            // How far has the cursor moved?\n            this._updateIndent._mouseDist = this.realMouseX - this.mousedownX;\n\n            // Flip that if this is RTL\n            if (Craft.orientation === 'rtl') {\n                this._updateIndent._mouseDist *= -1;\n            }\n\n            // What is that in indentation levels?\n            this._updateIndent._indentationDist = Math.round(this._updateIndent._mouseDist / Craft.StructureTableSorter.LEVEL_INDENT);\n\n            // Combine with the original level to get the new target level\n            this._updateIndent._targetLevel = this._draggeeLevel + this._updateIndent._indentationDist;\n\n            // Contain it within our min/max levels\n            if (this._updateIndent._targetLevel < this._targetLevelBounds.min) {\n                this._updateIndent._indentationDist += (this._targetLevelBounds.min - this._updateIndent._targetLevel);\n                this._updateIndent._targetLevel = this._targetLevelBounds.min;\n            }\n            else if (this._updateIndent._targetLevel > this._targetLevelBounds.max) {\n                this._updateIndent._indentationDist -= (this._updateIndent._targetLevel - this._targetLevelBounds.max);\n                this._updateIndent._targetLevel = this._targetLevelBounds.max;\n            }\n\n            // Has the target level changed?\n            if (this._targetLevel !== (this._targetLevel = this._updateIndent._targetLevel)) {\n                // Target level is changing, so update the ancestors\n                this._updateAncestorsBeforeRepaint();\n            }\n\n            // Update the UI\n            // ---------------------------------------------------------------------\n\n            // How far away is the cursor from the exact target level distance?\n            this._updateIndent._targetLevelMouseDiff = this._updateIndent._mouseDist - (this._updateIndent._indentationDist * Craft.StructureTableSorter.LEVEL_INDENT);\n\n            // What's the magnet impact of that?\n            this._updateIndent._magnetImpact = Math.round(this._updateIndent._targetLevelMouseDiff / 15);\n\n            // Put it on a leash\n            if (Math.abs(this._updateIndent._magnetImpact) > Craft.StructureTableSorter.MAX_GIVE) {\n                this._updateIndent._magnetImpact = (this._updateIndent._magnetImpact > 0 ? 1 : -1) * Craft.StructureTableSorter.MAX_GIVE;\n            }\n\n            // Apply the new margin/width\n            this._updateIndent._closestLevelMagnetIndent = this._getLevelIndent(this._targetLevel) + this._updateIndent._magnetImpact;\n            this.helpers[0].css('margin-' + Craft.left, this._updateIndent._closestLevelMagnetIndent + this._helperMargin);\n            this._$titleHelperCell.width(this._titleHelperCellOuterWidth - (this._updateIndent._closestLevelMagnetIndent + Craft.StructureTableSorter.BASE_PADDING));\n        },\n\n        /**\n         * Returns the indent size for a given level\n         */\n        _getLevelIndent: function(level) {\n            return (level - 1) * Craft.StructureTableSorter.LEVEL_INDENT;\n        },\n\n        /**\n         * Returns the base data that should be sent with StructureController Ajax requests.\n         */\n        _getAjaxBaseData: function($row) {\n            return {\n                structureId: this.structureId,\n                elementId: $row.data('id'),\n                siteId: $row.find('.element:first').data('site-id')\n            };\n        },\n\n        /**\n         * Returns a row's ancestor rows\n         */\n        _getAncestors: function($row, targetLevel) {\n            this._getAncestors._ancestors = [];\n\n            if (targetLevel != 0) {\n                this._getAncestors._level = targetLevel;\n                this._getAncestors._$prevRow = $row.prev();\n\n                while (this._getAncestors._$prevRow.length) {\n                    if (this._getAncestors._$prevRow.data('level') < this._getAncestors._level) {\n                        this._getAncestors._ancestors.unshift(this._getAncestors._$prevRow);\n                        this._getAncestors._level = this._getAncestors._$prevRow.data('level');\n\n                        // Did we just reach the top?\n                        if (this._getAncestors._level == 0) {\n                            break;\n                        }\n                    }\n\n                    this._getAncestors._$prevRow = this._getAncestors._$prevRow.prev();\n                }\n            }\n\n            return this._getAncestors._ancestors;\n        },\n\n        /**\n         * Prepares to have the ancestors updated before the screen is repainted.\n         */\n        _updateAncestorsBeforeRepaint: function() {\n            if (this._updateAncestorsFrame) {\n                Garnish.cancelAnimationFrame(this._updateAncestorsFrame);\n            }\n\n            if (!this._updateAncestorsProxy) {\n                this._updateAncestorsProxy = $.proxy(this, '_updateAncestors');\n            }\n\n            this._updateAncestorsFrame = Garnish.requestAnimationFrame(this._updateAncestorsProxy);\n        },\n\n        _updateAncestors: function() {\n            this._updateAncestorsFrame = null;\n\n            // Update the old ancestors\n            // -----------------------------------------------------------------\n\n            for (this._updateAncestors._i = 0; this._updateAncestors._i < this._ancestors.length; this._updateAncestors._i++) {\n                this._updateAncestors._$ancestor = this._ancestors[this._updateAncestors._i];\n\n                // One less descendant now\n                this._updateAncestors._$ancestor.data('descendants', this._updateAncestors._$ancestor.data('descendants') - 1);\n\n                // Is it now childless?\n                if (this._updateAncestors._$ancestor.data('descendants') == 0) {\n                    // Remove its toggle\n                    this._updateAncestors._$ancestor.find('> td > .toggle:first').remove();\n                }\n            }\n\n            // Update the new ancestors\n            // -----------------------------------------------------------------\n\n            this._updateAncestors._newAncestors = this._getAncestors(this.$targetItem, this._targetLevel);\n\n            for (this._updateAncestors._i = 0; this._updateAncestors._i < this._updateAncestors._newAncestors.length; this._updateAncestors._i++) {\n                this._updateAncestors._$ancestor = this._updateAncestors._newAncestors[this._updateAncestors._i];\n\n                // One more descendant now\n                this._updateAncestors._$ancestor.data('descendants', this._updateAncestors._$ancestor.data('descendants') + 1);\n\n                // Is this its first child?\n                if (this._updateAncestors._$ancestor.data('descendants') == 1) {\n                    // Create its toggle\n                    $('<span class=\"toggle expanded\" title=\"' + Craft.t('app', 'Show/hide children') + '\"></span>')\n                        .insertAfter(this._updateAncestors._$ancestor.find('> td .move:first'));\n\n                }\n            }\n\n            this._ancestors = this._updateAncestors._newAncestors;\n\n            delete this._updateAncestors._i;\n            delete this._updateAncestors._$ancestor;\n            delete this._updateAncestors._newAncestors;\n        }\n    },\n\n// Static Properties\n// =============================================================================\n\n    {\n        BASE_PADDING: 36,\n        HELPER_MARGIN: -7,\n        LEVEL_INDENT: 44,\n        MAX_GIVE: 22,\n\n        defaults: {\n            onPositionChange: $.noop\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Table Element Index View\n */\nCraft.TableElementIndexView = Craft.BaseElementIndexView.extend(\n    {\n        $table: null,\n        $selectedSortHeader: null,\n\n        structureTableSort: null,\n\n        _totalVisiblePostStructureTableDraggee: null,\n        _morePendingPostStructureTableDraggee: false,\n\n        getElementContainer: function() {\n            // Save a reference to the table\n            this.$table = this.$container.find('table:first');\n            return this.$table.children('tbody:first');\n        },\n\n        afterInit: function() {\n            // Make the table collapsible for mobile devices\n            Craft.cp.$collapsibleTables = Craft.cp.$collapsibleTables.add(this.$table);\n            Craft.cp.updateResponsiveTables();\n\n            // Set the sort header\n            this.initTableHeaders();\n\n            // Create the Structure Table Sorter\n            if (\n                this.elementIndex.settings.context === 'index' &&\n                this.elementIndex.getSelectedSortAttribute() === 'structure' &&\n                Garnish.hasAttr(this.$table, 'data-structure-id')\n            ) {\n                this.structureTableSort = new Craft.StructureTableSorter(this, this.getAllElements(), {\n                    onSortChange: $.proxy(this, '_onStructureTableSortChange')\n                });\n            }\n            else {\n                this.structureTableSort = null;\n            }\n\n            // Handle expand/collapse toggles for Structures\n            if (this.elementIndex.getSelectedSortAttribute() === 'structure') {\n                this.addListener(this.$elementContainer, 'click', function(ev) {\n                    var $target = $(ev.target);\n\n                    if ($target.hasClass('toggle')) {\n                        if (this._collapseElement($target) === false) {\n                            this._expandElement($target);\n                        }\n                    }\n                });\n            }\n        },\n\n        initTableHeaders: function() {\n            var selectedSortAttr = this.elementIndex.getSelectedSortAttribute(),\n                $tableHeaders = this.$table.children('thead').children().children('[data-attribute]');\n\n            for (var i = 0; i < $tableHeaders.length; i++) {\n                var $header = $tableHeaders.eq(i),\n                    attr = $header.attr('data-attribute');\n\n                // Is this the selected sort attribute?\n                if (attr === selectedSortAttr) {\n                    this.$selectedSortHeader = $header;\n                    var selectedSortDir = this.elementIndex.getSelectedSortDirection();\n\n                    $header\n                        .addClass('ordered ' + selectedSortDir)\n                        .on('click', $.proxy(this, '_handleSelectedSortHeaderClick'));\n                }\n                else {\n                    // Is this attribute sortable?\n                    var $sortAttribute = this.elementIndex.getSortAttributeOption(attr);\n\n                    if ($sortAttribute.length) {\n                        $header\n                            .addClass('orderable')\n                            .on('click', $.proxy(this, '_handleUnselectedSortHeaderClick'));\n                    }\n                }\n            }\n        },\n\n        isVerticalList: function() {\n            return true;\n        },\n\n        getTotalVisible: function() {\n            if (this._isStructureTableDraggingLastElements()) {\n                return this._totalVisiblePostStructureTableDraggee;\n            }\n            else {\n                return this._totalVisible;\n            }\n        },\n\n        setTotalVisible: function(totalVisible) {\n            if (this._isStructureTableDraggingLastElements()) {\n                this._totalVisiblePostStructureTableDraggee = totalVisible;\n            }\n            else {\n                this._totalVisible = totalVisible;\n            }\n        },\n\n        getMorePending: function() {\n            if (this._isStructureTableDraggingLastElements()) {\n                return this._morePendingPostStructureTableDraggee;\n            }\n            else {\n                return this._morePending;\n            }\n        },\n\n        setMorePending: function(morePending) {\n            if (this._isStructureTableDraggingLastElements()) {\n                this._morePendingPostStructureTableDraggee = morePending;\n            }\n            else {\n                this._morePending = this._morePendingPostStructureTableDraggee = morePending;\n            }\n        },\n\n        getLoadMoreParams: function() {\n            var params = this.base();\n\n            // If we are dragging the last elements on the page,\n            // tell the controller to only load elements positioned after the draggee.\n            if (this._isStructureTableDraggingLastElements()) {\n                params.criteria.positionedAfter = this.structureTableSort.$targetItem.data('id');\n            }\n\n            return params;\n        },\n\n        appendElements: function($newElements) {\n            this.base($newElements);\n\n            if (this.structureTableSort) {\n                this.structureTableSort.addItems($newElements);\n            }\n\n            Craft.cp.updateResponsiveTables();\n        },\n\n        destroy: function() {\n            if (this.$table) {\n                // Remove the soon-to-be-wiped-out table from the list of collapsible tables\n                Craft.cp.$collapsibleTables = Craft.cp.$collapsibleTables.not(this.$table);\n            }\n\n            this.base();\n        },\n\n        createElementEditor: function($element) {\n            Craft.createElementEditor($element.data('type'), $element, {\n                params: {\n                    includeTableAttributesForSource: this.elementIndex.sourceKey\n                },\n                onSaveElement: $.proxy(function(response) {\n                    if (response.tableAttributes) {\n                        this._updateTableAttributes($element, response.tableAttributes);\n                    }\n                }, this),\n                elementIndex: this.elementIndex\n            });\n        },\n\n        _collapseElement: function($toggle, force) {\n            if (!force && !$toggle.hasClass('expanded')) {\n                return false;\n            }\n\n            $toggle.removeClass('expanded');\n\n            // Find and remove the descendant rows\n            var $row = $toggle.parent().parent(),\n                id = $row.data('id'),\n                level = $row.data('level'),\n                $nextRow = $row.next();\n\n            while ($nextRow.length) {\n                if (!Garnish.hasAttr($nextRow, 'data-spinnerrow')) {\n                    if ($nextRow.data('level') <= level) {\n                        break;\n                    }\n\n                    if (this.elementSelect) {\n                        this.elementSelect.removeItems($nextRow);\n                    }\n\n                    if (this.structureTableSort) {\n                        this.structureTableSort.removeItems($nextRow);\n                    }\n\n                    this._totalVisible--;\n                }\n\n                var $nextNextRow = $nextRow.next();\n                $nextRow.remove();\n                $nextRow = $nextNextRow;\n            }\n\n            // Remember that this row should be collapsed\n            if (!this.elementIndex.instanceState.collapsedElementIds) {\n                this.elementIndex.instanceState.collapsedElementIds = [];\n            }\n\n            this.elementIndex.instanceState.collapsedElementIds.push(id);\n            this.elementIndex.setInstanceState('collapsedElementIds', this.elementIndex.instanceState.collapsedElementIds);\n\n            // Bottom of the index might be viewable now\n            this.maybeLoadMore();\n        },\n\n        _expandElement: function($toggle, force) {\n            if (!force && $toggle.hasClass('expanded')) {\n                return false;\n            }\n\n            $toggle.addClass('expanded');\n\n            // Remove this element from our list of collapsed elements\n            if (this.elementIndex.instanceState.collapsedElementIds) {\n                var $row = $toggle.parent().parent(),\n                    id = $row.data('id'),\n                    index = $.inArray(id, this.elementIndex.instanceState.collapsedElementIds);\n\n                if (index !== -1) {\n                    this.elementIndex.instanceState.collapsedElementIds.splice(index, 1);\n                    this.elementIndex.setInstanceState('collapsedElementIds', this.elementIndex.instanceState.collapsedElementIds);\n\n                    // Add a temporary row\n                    var $spinnerRow = this._createSpinnerRowAfter($row);\n\n                    // Load the nested elements\n                    var params = $.extend(true, {}, this.settings.params);\n                    params.criteria.descendantOf = id;\n\n                    Craft.postActionRequest('element-indexes/get-more-elements', params, $.proxy(function(response, textStatus) {\n                        // Do we even care about this anymore?\n                        if (!$spinnerRow.parent().length) {\n                            return;\n                        }\n\n                        if (textStatus === 'success') {\n                            var $newElements = $(response.html);\n\n                            // Are there more descendants we didn't get in this batch?\n                            var totalVisible = (this._totalVisible + $newElements.length),\n                                morePending = (this.settings.batchSize && $newElements.length === this.settings.batchSize);\n\n                            if (morePending) {\n                                // Remove all the elements after it\n                                var $nextRows = $spinnerRow.nextAll();\n\n                                if (this.elementSelect) {\n                                    this.elementSelect.removeItems($nextRows);\n                                }\n\n                                if (this.structureTableSort) {\n                                    this.structureTableSort.removeItems($nextRows);\n                                }\n\n                                $nextRows.remove();\n                                totalVisible -= $nextRows.length;\n                            }\n                            else {\n                                // Maintain the current 'more' status\n                                morePending = this._morePending;\n                            }\n\n                            $spinnerRow.replaceWith($newElements);\n                            this.thumbLoader.load($newElements);\n\n                            if (this.elementIndex.actions || this.settings.selectable) {\n                                this.elementSelect.addItems($newElements.filter(':not(.disabled)'));\n                                this.elementIndex.updateActionTriggers();\n                            }\n\n                            if (this.structureTableSort) {\n                                this.structureTableSort.addItems($newElements);\n                            }\n\n                            Craft.appendHeadHtml(response.headHtml);\n                            Craft.appendFootHtml(response.footHtml);\n                            Craft.cp.updateResponsiveTables();\n\n                            this.setTotalVisible(totalVisible);\n                            this.setMorePending(morePending);\n\n                            // Is there room to load more right now?\n                            this.maybeLoadMore();\n                        }\n\n                    }, this));\n                }\n            }\n        },\n\n        _createSpinnerRowAfter: function($row) {\n            return $(\n                '<tr data-spinnerrow>' +\n                '<td class=\"centeralign\" colspan=\"' + $row.children().length + '\">' +\n                '<div class=\"spinner\"/>' +\n                '</td>' +\n                '</tr>'\n            ).insertAfter($row);\n        },\n\n        _isStructureTableDraggingLastElements: function() {\n            return (\n                this.structureTableSort &&\n                this.structureTableSort.dragging &&\n                this.structureTableSort.draggingLastElements\n            );\n        },\n\n        _handleSelectedSortHeaderClick: function(ev) {\n            var $header = $(ev.currentTarget);\n\n            if ($header.hasClass('loading')) {\n                return;\n            }\n\n            // Reverse the sort direction\n            var selectedSortDir = this.elementIndex.getSelectedSortDirection(),\n                newSortDir = (selectedSortDir === 'asc' ? 'desc' : 'asc');\n\n            this.elementIndex.setSortDirection(newSortDir);\n            this._handleSortHeaderClick(ev, $header);\n        },\n\n        _handleUnselectedSortHeaderClick: function(ev) {\n            var $header = $(ev.currentTarget);\n\n            if ($header.hasClass('loading')) {\n                return;\n            }\n\n            var attr = $header.attr('data-attribute');\n\n            this.elementIndex.setSortAttribute(attr);\n            this._handleSortHeaderClick(ev, $header);\n        },\n\n        _handleSortHeaderClick: function(ev, $header) {\n            if (this.$selectedSortHeader) {\n                this.$selectedSortHeader.removeClass('ordered asc desc');\n            }\n\n            $header.removeClass('orderable').addClass('ordered loading');\n            this.elementIndex.storeSortAttributeAndDirection();\n            this.elementIndex.updateElements();\n\n            // No need for two spinners\n            this.elementIndex.setIndexAvailable();\n        },\n\n        _updateTableAttributes: function($element, tableAttributes) {\n            var $tr = $element.closest('tr');\n\n            for (var attr in tableAttributes) {\n                if (!tableAttributes.hasOwnProperty(attr)) {\n                    continue;\n                }\n\n                $tr.children('td[data-attr=\"' + attr + '\"]:first').html(tableAttributes[attr]);\n            }\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Tag select input\n */\nCraft.TagSelectInput = Craft.BaseElementSelectInput.extend(\n    {\n        searchTimeout: null,\n        searchMenu: null,\n\n        $container: null,\n        $elementsContainer: null,\n        $elements: null,\n        $addTagInput: null,\n        $spinner: null,\n\n        _ignoreBlur: false,\n\n        init: function(settings) {\n            // Normalize the settings\n            // ---------------------------------------------------------------------\n\n            // Are they still passing in a bunch of arguments?\n            if (!$.isPlainObject(settings)) {\n                // Loop through all of the old arguments and apply them to the settings\n                var normalizedSettings = {},\n                    args = ['id', 'name', 'tagGroupId', 'sourceElementId'];\n\n                for (var i = 0; i < args.length; i++) {\n                    if (typeof arguments[i] !== 'undefined') {\n                        normalizedSettings[args[i]] = arguments[i];\n                    }\n                    else {\n                        break;\n                    }\n                }\n\n                settings = normalizedSettings;\n            }\n\n            this.base($.extend({}, Craft.TagSelectInput.defaults, settings));\n\n            this.$addTagInput = this.$container.children('.add').children('.text');\n            this.$spinner = this.$addTagInput.next();\n\n            this.addListener(this.$addTagInput, 'textchange', $.proxy(function() {\n                if (this.searchTimeout) {\n                    clearTimeout(this.searchTimeout);\n                }\n\n                this.searchTimeout = setTimeout($.proxy(this, 'searchForTags'), 500);\n            }, this));\n\n            this.addListener(this.$addTagInput, 'keypress', function(ev) {\n                if (ev.keyCode === Garnish.RETURN_KEY) {\n                    ev.preventDefault();\n\n                    if (this.searchMenu) {\n                        this.selectTag(this.searchMenu.$options[0]);\n                    }\n                }\n            });\n\n            this.addListener(this.$addTagInput, 'focus', function() {\n                if (this.searchMenu) {\n                    this.searchMenu.show();\n                }\n            });\n\n            this.addListener(this.$addTagInput, 'blur', function() {\n                if (this._ignoreBlur) {\n                    this._ignoreBlur = false;\n                    return;\n                }\n\n                setTimeout($.proxy(function() {\n                    if (this.searchMenu) {\n                        this.searchMenu.hide();\n                    }\n                }, this), 1);\n            });\n        },\n\n        // No \"add\" button\n        getAddElementsBtn: $.noop,\n\n        getElementSortAxis: function() {\n            return null;\n        },\n\n        searchForTags: function() {\n            if (this.searchMenu) {\n                this.killSearchMenu();\n            }\n\n            var val = this.$addTagInput.val();\n\n            if (val) {\n                this.$spinner.removeClass('hidden');\n\n                var excludeIds = [];\n\n                for (var i = 0; i < this.$elements.length; i++) {\n                    var id = $(this.$elements[i]).data('id');\n\n                    if (id) {\n                        excludeIds.push(id);\n                    }\n                }\n\n                if (this.settings.sourceElementId) {\n                    excludeIds.push(this.settings.sourceElementId);\n                }\n\n                var data = {\n                    search: this.$addTagInput.val(),\n                    tagGroupId: this.settings.tagGroupId,\n                    excludeIds: excludeIds\n                };\n\n                Craft.postActionRequest('tags/search-for-tags', data, $.proxy(function(response, textStatus) {\n                    // Just in case\n                    if (this.searchMenu) {\n                        this.killSearchMenu();\n                    }\n\n                    this.$spinner.addClass('hidden');\n\n                    if (textStatus === 'success') {\n                        var $menu = $('<div class=\"menu tagmenu\"/>').appendTo(Garnish.$bod),\n                            $ul = $('<ul/>').appendTo($menu);\n\n                        var $li;\n\n                        for (var i = 0; i < response.tags.length; i++) {\n                            $li = $('<li/>')\n                                .appendTo($ul);\n\n                            $('<a data-icon=\"tag\"/>')\n                                .appendTo($li)\n                                .text(response.tags[i].title)\n                                .data('id', response.tags[i].id)\n                                .addClass(response.tags[i].exclude ? 'disabled' : '');\n                        }\n\n                        if (!response.exactMatch) {\n                            $li = $('<li/>').appendTo($ul);\n                            $('<a data-icon=\"plus\"/>').appendTo($li).text(data.search);\n                        }\n\n                        $ul.find('a:not(.disabled):first').addClass('hover');\n\n                        this.searchMenu = new Garnish.Menu($menu, {\n                            attachToElement: this.$addTagInput,\n                            onOptionSelect: $.proxy(this, 'selectTag')\n                        });\n\n                        this.addListener($menu, 'mousedown', $.proxy(function() {\n                            this._ignoreBlur = true;\n                        }, this));\n\n                        this.searchMenu.show();\n                    }\n\n                }, this));\n            }\n            else {\n                this.$spinner.addClass('hidden');\n            }\n        },\n\n        selectTag: function(option) {\n            var $option = $(option);\n\n            if ($option.hasClass('disabled')) {\n                return;\n            }\n\n            var id = $option.data('id');\n            var title = $option.text();\n\n            var $element = $('<div/>', {\n                'class': 'element small removable',\n                'data-id': id,\n                'data-site-id': this.settings.targetSiteId,\n                'data-label': title,\n                'data-editable': '1'\n            }).appendTo(this.$elementsContainer);\n\n            var $input = $('<input/>', {\n                'type': 'hidden',\n                'name': this.settings.name + '[]',\n                'value': id\n            }).appendTo($element);\n\n            $('<a/>', {\n                'class': 'delete icon',\n                'title': Craft.t('app', 'Remove')\n            }).appendTo($element);\n\n            var $titleContainer = $('<div/>', {\n                'class': 'label'\n            }).appendTo($element);\n\n            $('<span/>', {\n                'class': 'title',\n                text: title\n            }).appendTo($titleContainer);\n\n            var margin = -($element.outerWidth() + 10);\n            this.$addTagInput.css('margin-' + Craft.left, margin + 'px');\n\n            var animateCss = {};\n            animateCss['margin-' + Craft.left] = 0;\n            this.$addTagInput.velocity(animateCss, 'fast');\n\n            this.$elements = this.$elements.add($element);\n\n            this.addElements($element);\n\n            this.killSearchMenu();\n            this.$addTagInput.val('');\n            this.$addTagInput.trigger('focus');\n\n            if (!id) {\n                // We need to create the tag first\n                $element.addClass('loading disabled');\n\n                var data = {\n                    groupId: this.settings.tagGroupId,\n                    title: title\n                };\n\n                Craft.postActionRequest('tags/create-tag', data, $.proxy(function(response, textStatus) {\n                    if (textStatus === 'success' && response.success) {\n                        $element.attr('data-id', response.id);\n                        $input.val(response.id);\n\n                        $element.removeClass('loading disabled');\n                    }\n                    else {\n                        this.removeElement($element);\n\n                        if (textStatus === 'success') {\n                            // Some sort of validation error that still resulted in  a 200 response. Shouldn't be possible though.\n                            Craft.cp.displayError(Craft.t('app', 'An unknown error occurred.'));\n                        }\n                    }\n                }, this));\n            }\n        },\n\n        killSearchMenu: function() {\n            this.searchMenu.hide();\n            this.searchMenu.destroy();\n            this.searchMenu = null;\n        }\n    },\n    {\n        defaults: {\n            tagGroupId: null\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Thumb Element Index View\n */\nCraft.ThumbsElementIndexView = Craft.BaseElementIndexView.extend(\n    {\n        getElementContainer: function() {\n            return this.$container.children('ul');\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\nCraft.ui =\n    {\n        createTextInput: function(config) {\n            var $input = $('<input/>', {\n                attr: {\n                    'class': 'text',\n                    type: (config.type || 'text'),\n                    id: config.id,\n                    size: config.size,\n                    name: config.name,\n                    value: config.value,\n                    maxlength: config.maxlength,\n                    autofocus: this.getAutofocusValue(config.autofocus),\n                    autocomplete: (typeof config.autocomplete === 'undefined' || !config.autocomplete ? 'off' : null),\n                    disabled: this.getDisabledValue(config.disabled),\n                    readonly: config.readonly,\n                    title: config.title,\n                    placeholder: config.placeholder,\n                    step: config.step,\n                    min: config.min,\n                    max: config.max\n                }\n            });\n\n            if (config.class) {\n                $input.addClass(config.class);\n            }\n            if (config.placeholder) {\n                $input.addClass('nicetext');\n            }\n            if (config.type === 'password') {\n                $input.addClass('password');\n            }\n            if (config.disabled) {\n                $input.addClass('disabled');\n            }\n            if (!config.size) {\n                $input.addClass('fullwidth');\n            }\n\n            if (config.showCharsLeft && config.maxlength) {\n                $input\n                    .attr('data-show-chars-left')\n                    .css('padding-' + (Craft.orientation === 'ltr' ? 'right' : 'left'), (7.2 * config.maxlength.toString().length + 14) + 'px');\n            }\n\n            if (config.placeholder || config.showCharsLeft) {\n                new Garnish.NiceText($input);\n            }\n\n            if (config.type === 'password') {\n                return $('<div class=\"passwordwrapper\"/>').append($input);\n            }\n            else {\n                return $input;\n            }\n        },\n\n        createTextField: function(config) {\n            return this.createField(this.createTextInput(config), config);\n        },\n\n        createTextarea: function(config) {\n            var $textarea = $('<textarea/>', {\n                'class': 'text',\n                'rows': config.rows || 2,\n                'cols': config.cols || 50,\n                'id': config.id,\n                'name': config.name,\n                'maxlength': config.maxlength,\n                'autofocus': config.autofocus && !Garnish.isMobileBrowser(true),\n                'disabled': !!config.disabled,\n                'placeholder': config.placeholder,\n                'html': config.value\n            });\n\n            if (config.showCharsLeft) {\n                $textarea.attr('data-show-chars-left', '');\n            }\n\n            if (config.class) {\n                $textarea.addClass(config.class);\n            }\n\n            if (!config.size) {\n                $textarea.addClass('fullwidth');\n            }\n\n            return $textarea;\n        },\n\n        createTextareaField: function(config) {\n            return this.createField(this.createTextarea(config), config);\n        },\n\n        createSelect: function(config) {\n            var $container = $('<div/>', {\n                'class': 'select'\n            });\n\n            if (config.class) {\n                $container.addClass(config.class);\n            }\n\n            var $select = $('<select/>', {\n                'id': config.id,\n                'name': config.name,\n                'autofocus': config.autofocus && Garnish.isMobileBrowser(true),\n                'disabled': config.disabled,\n                'data-target-prefix': config.targetPrefix\n            }).appendTo($container);\n\n            var $optgroup = null;\n\n            for (var key in config.options) {\n                if (!config.options.hasOwnProperty(key)) {\n                    continue;\n                }\n\n                var option = config.options[key];\n\n                // Starting a new <optgroup>?\n                if (typeof option.optgroup !== 'undefined') {\n                    $optgroup = $('<optgroup/>', {\n                        'label': option.label\n                    }).appendTo($select);\n                } else {\n                    var optionLabel = (typeof option.label !== 'undefined' ? option.label : option),\n                        optionValue = (typeof option.value !== 'undefined' ? option.value : key),\n                        optionDisabled = (typeof option.disabled !== 'undefined' ? option.disabled : false);\n\n                    $('<option/>', {\n                        'value': optionValue,\n                        'selected': (optionValue == config.value),\n                        'disabled': optionDisabled,\n                        'html': optionLabel\n                    }).appendTo($optgroup || $select);\n                }\n            }\n\n            if (config.toggle) {\n                $select.addClass('fieldtoggle');\n                new Craft.FieldToggle($select);\n            }\n\n            return $container;\n        },\n\n        createSelectField: function(config) {\n            return this.createField(this.createSelect(config), config);\n        },\n\n        createCheckbox: function(config) {\n            var id = (config.id || 'checkbox' + Math.floor(Math.random() * 1000000000));\n\n            var $input = $('<input/>', {\n                type: 'checkbox',\n                value: (typeof config.value !== 'undefined' ? config.value : '1'),\n                id: id,\n                'class': 'checkbox',\n                name: config.name,\n                checked: (config.checked ? 'checked' : null),\n                autofocus: this.getAutofocusValue(config.autofocus),\n                disabled: this.getDisabledValue(config.disabled),\n                'data-target': config.toggle,\n                'data-reverse-target': config.reverseToggle\n            });\n\n            if (config.class) {\n                $input.addClass(config.class);\n            }\n\n            if (config.toggle || config.reverseToggle) {\n                $input.addClass('fieldtoggle');\n                new Craft.FieldToggle($input);\n            }\n\n            var $label = $('<label/>', {\n                'for': id,\n                text: config.label\n            });\n\n            // Should we include a hidden input first?\n            if (config.name && (config.name.length < 3 || config.name.substr(-2) !== '[]')) {\n                return $([\n                    $('<input/>', {\n                        type: 'hidden',\n                        name: config.name,\n                        value: ''\n                    })[0],\n                    $input[0],\n                    $label[0]\n                ]);\n            }\n            else {\n                return $([\n                    $input[0],\n                    $label[0]\n                ]);\n            }\n        },\n\n        createCheckboxField: function(config) {\n            var $field = $('<div class=\"field checkboxfield\"/>', {\n                id: (config.id ? config.id + '-field' : null)\n            });\n\n            if (config.first) {\n                $field.addClass('first');\n            }\n            if (config.instructions) {\n                $field.addClass('has-instructions');\n            }\n\n            this.createCheckbox(config).appendTo($field);\n\n            if (config.instructions) {\n                $('<div class=\"instructions\"/>').text(config.instructions).appendTo($field);\n            }\n\n            return $field;\n        },\n\n        createCheckboxSelect: function(config) {\n            var $container = $('<div class=\"checkbox-select\"/>');\n\n            if (config.class) {\n                $container.addClass(config.class);\n            }\n\n            var allValue, allChecked;\n\n            if (config.showAllOption) {\n                allValue = (config.allValue || '*');\n                allChecked = (config.values == allValue);\n\n                // Create the \"All\" checkbox\n                $('<div/>').appendTo($container).append(\n                    this.createCheckbox({\n                        id: config.id,\n                        'class': 'all',\n                        label: '<b>' + (config.allLabel || Craft.t('app', 'All')) + '</b>',\n                        name: config.name,\n                        value: allValue,\n                        checked: allChecked,\n                        autofocus: config.autofocus\n                    })\n                );\n            } else {\n                allChecked = false;\n            }\n\n            // Create the actual options\n            for (var i = 0; i < config.options.length; i++) {\n                var option = config.options[i];\n\n                if (option.value == allValue) {\n                    continue;\n                }\n\n                $('<div/>').appendTo($container).append(\n                    this.createCheckbox({\n                        label: option.label,\n                        name: (config.name ? config.name + '[]' : null),\n                        value: option.value,\n                        checked: (allChecked || Craft.inArray(option.value, config.values)),\n                        disabled: allChecked\n                    })\n                );\n            }\n\n            new Garnish.CheckboxSelect($container);\n\n            return $container;\n        },\n\n        createCheckboxSelectField: function(config) {\n            return this.createField(this.createCheckboxSelect(config), config);\n        },\n\n        createLightswitch: function(config) {\n            var value = config.value || '1';\n\n            var $container = $('<div/>', {\n                'class': 'lightswitch',\n                tabindex: '0',\n                'data-value': value,\n                id: config.id,\n                'aria-labelledby': config.labelId,\n                'data-target': config.toggle,\n                'data-reverse-target': config.reverseToggle\n            });\n\n            if (config.on) {\n                $container.addClass('on');\n            }\n\n            if (config.small) {\n                $container.addClass('small');\n            }\n\n            if (config.disabled) {\n                $container.addClass('disabled');\n            }\n\n            $(\n                '<div class=\"lightswitch-container\">' +\n                '<div class=\"label on\"></div>' +\n                '<div class=\"handle\"></div>' +\n                '<div class=\"label off\"></div>' +\n                '</div>'\n            ).appendTo($container);\n\n            if (config.name) {\n                $('<input/>', {\n                    type: 'hidden',\n                    name: config.name,\n                    value: (config.on ? value : ''),\n                    disabled: config.disabled\n                }).appendTo($container);\n            }\n\n            if (config.toggle || config.reverseToggle) {\n                $container.addClass('fieldtoggle');\n                new Craft.FieldToggle($container);\n            }\n\n            return $container.lightswitch();\n        },\n\n        createLightswitchField: function(config) {\n            return this.createField(this.createLightswitch(config), config);\n        },\n\n        createColorInput: function(config) {\n            var id = (config.id || 'color' + Math.floor(Math.random() * 1000000000));\n            var containerId = config.containerId || id + '-container';\n            var name = config.name || null;\n            var value = config.value || null;\n            var small = config.small || false;\n            var autofocus = config.autofocus && Garnish.isMobileBrowser(true);\n            var disabled = config.disabled || false;\n\n            var $container = $('<div/>', {\n                id: containerId,\n                'class': 'flex color-container'\n            });\n\n            var $colorPreviewContainer = $('<div/>', {\n                'class': 'color static' + (small ? ' small' : '')\n            }).appendTo($container);\n\n            var $colorPreview = $('<div/>', {\n                'class': 'color-preview',\n                style: config.value ? {backgroundColor: config.value} : null\n            }).appendTo($colorPreviewContainer);\n\n            var $input = this.createTextInput({\n                id: id,\n                name: name,\n                value: value,\n                size: 10,\n                'class': 'color-input',\n                autofocus: autofocus,\n                disabled: disabled\n            }).appendTo($container);\n\n            new Craft.ColorInput($container);\n            return $container;\n        },\n\n        createColorField: function(config) {\n            return this.createField(this.createColorInput(config), config);\n        },\n\n        createDateInput: function(config) {\n            var id = (config.id || 'date' + Math.floor(Math.random() * 1000000000))+'-date';\n            var name = config.name || null;\n            var inputName = name ? name+'[date]' : null;\n            var value = config.value && typeof config.value.getMonth === 'function' ? config.value : null;\n            var formattedValue = value ? Craft.formatDate(value) : null;\n            var autofocus = config.autofocus && Garnish.isMobileBrowser(true);\n            var disabled = config.disabled || false;\n\n            var $container = $('<div/>', {\n                'class': 'datewrapper'\n            });\n\n            var $input = this.createTextInput({\n                id: id,\n                name: inputName,\n                value: formattedValue,\n                placeholder: ' ',\n                autocomplete: false,\n                autofocus: autofocus,\n                disabled: disabled\n            }).appendTo($container);\n\n            $('<div data-icon=\"date\"></div>').appendTo($container);\n\n            if (name) {\n                $('<input/>', {\n                    type: 'hidden',\n                    name: name+'[timezone]',\n                    val: Craft.timezone\n                }).appendTo($container);\n            }\n\n            $input.datepicker($.extend({\n                defaultDate: value || new Date()\n            }, Craft.datepickerOptions));\n\n            return $container;\n        },\n\n        createDateField: function(config) {\n            return this.createField(this.createDateInput(config), config);\n        },\n\n        createTimeInput: function(config) {\n            var id = (config.id || 'time' + Math.floor(Math.random() * 1000000000))+'-time';\n            var name = config.name || null;\n            var inputName = name ? name+'[time]' : null;\n            var value = config.value && typeof config.value.getMonth === 'function' ? config.value : null;\n            var autofocus = config.autofocus && Garnish.isMobileBrowser(true);\n            var disabled = config.disabled || false;\n\n            var $container = $('<div/>', {\n                'class': 'timewrapper'\n            });\n\n            var $input = this.createTextInput({\n                id: id,\n                name: inputName,\n                placeholder: ' ',\n                autocomplete: false,\n                autofocus: autofocus,\n                disabled: disabled\n            }).appendTo($container);\n\n            $('<div data-icon=\"time\"></div>').appendTo($container);\n\n            if (name) {\n                $('<input/>', {\n                    type: 'hidden',\n                    name: name+'[timezone]',\n                    val: Craft.timezone\n                }).appendTo($container);\n            }\n\n            $input.timepicker(Craft.timepickerOptions);\n            if (value) {\n                $input.timepicker('setTime', value.getHours()*3600 + value.getMinutes()*60 + value.getSeconds());\n            }\n\n            return $container;\n        },\n\n        createTimeField: function(config) {\n            return this.createField(this.createTimeInput(config), config);\n        },\n\n        createField: function(input, config) {\n            var label = (config.label && config.label !== '__blank__' ? config.label : null),\n                siteId = (Craft.isMultiSite && config.siteId ? config.siteId : null);\n\n            var $field = $('<div/>', {\n                'class': 'field',\n                'id': config.fieldId || (config.id ? config.id + '-field' : null)\n            });\n\n            if (config.first) {\n                $field.addClass('first');\n            }\n\n            if (label || config.instructions) {\n                var $heading = $('<div class=\"heading\"/>').appendTo($field);\n\n                if (label) {\n                    var $label = $('<label/>', {\n                        'id': config.labelId || (config.id ? config.id + '-label' : null),\n                        'class': (config.required ? 'required' : null),\n                        'for': config.id,\n                        text: label\n                    }).appendTo($heading);\n\n                    if (siteId) {\n                        for (var i = 0; i < Craft.sites.length; i++) {\n                            if (Craft.sites[i].id == siteId) {\n                                $('<span class=\"site\"/>').text(Craft.sites[i].name).appendTo($label);\n                                break;\n                            }\n                        }\n                    }\n                }\n\n                if (config.instructions) {\n                    $('<div class=\"instructions\"/>').text(config.instructions).appendTo($heading);\n                }\n            }\n\n            $('<div class=\"input\"/>').append(input).appendTo($field);\n\n            if (config.warning) {\n                $('<p class=\"warning\"/>').text(config.warning).appendTo($field);\n            }\n\n            if (config.errors) {\n                this.addErrorsToField($field, config.errors);\n            }\n\n            return $field;\n        },\n\n        createErrorList: function(errors) {\n            var $list = $('<ul class=\"errors\"/>');\n\n            if (errors) {\n                this.addErrorsToList($list, errors);\n            }\n\n            return $list;\n        },\n\n        addErrorsToList: function($list, errors) {\n            for (var i = 0; i < errors.length; i++) {\n                $('<li/>').text(errors[i]).appendTo($list);\n            }\n        },\n\n        addErrorsToField: function($field, errors) {\n            if (!errors) {\n                return;\n            }\n\n            $field.addClass('has-errors');\n            $field.children('.input').addClass('errors');\n\n            var $errors = $field.children('ul.errors');\n\n            if (!$errors.length) {\n                $errors = this.createErrorList().appendTo($field);\n            }\n\n            this.addErrorsToList($errors, errors);\n        },\n\n        clearErrorsFromField: function($field) {\n            $field.removeClass('has-errors');\n            $field.children('.input').removeClass('errors');\n            $field.children('ul.errors').remove();\n        },\n\n        getAutofocusValue: function(autofocus) {\n            return (autofocus && !Garnish.isMobileBrowser(true) ? 'autofocus' : null);\n        },\n\n        getDisabledValue: function(disabled) {\n            return (disabled ? 'disabled' : null);\n        }\n    };\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * File Manager.\n */\nCraft.Uploader = Garnish.Base.extend(\n    {\n        uploader: null,\n        allowedKinds: null,\n        $element: null,\n        settings: null,\n        _rejectedFiles: {},\n        _extensionList: null,\n        _totalFileCounter: 0,\n        _validFileCounter: 0,\n\n        init: function($element, settings) {\n            this._rejectedFiles = {\"size\": [], \"type\": [], \"limit\": []};\n            this.$element = $element;\n            this.allowedKinds = null;\n            this._extensionList = null;\n            this._totalFileCounter = 0;\n            this._validFileCounter = 0;\n\n            settings = $.extend({}, Craft.Uploader.defaults, settings);\n\n            var events = settings.events;\n            delete settings.events;\n\n            if (settings.allowedKinds && settings.allowedKinds.length) {\n                if (typeof settings.allowedKinds === 'string') {\n                    settings.allowedKinds = [settings.allowedKinds];\n                }\n\n                this.allowedKinds = settings.allowedKinds;\n                delete settings.allowedKinds;\n            }\n\n            settings.autoUpload = false;\n\n            this.uploader = this.$element.fileupload(settings);\n            for (var event in events) {\n                if (!events.hasOwnProperty(event)) {\n                    continue;\n                }\n\n                this.uploader.on(event, events[event]);\n            }\n\n            this.settings = settings;\n\n            this.uploader.on('fileuploadadd', $.proxy(this, 'onFileAdd'));\n        },\n\n        /**\n         * Set uploader parameters.\n         */\n        setParams: function(paramObject) {\n            // If CSRF protection isn't enabled, these won't be defined.\n            if (typeof Craft.csrfTokenName !== 'undefined' && typeof Craft.csrfTokenValue !== 'undefined') {\n                // Add the CSRF token\n                paramObject[Craft.csrfTokenName] = Craft.csrfTokenValue;\n            }\n\n            this.uploader.fileupload('option', {formData: paramObject});\n        },\n\n        /**\n         * Get the number of uploads in progress.\n         */\n        getInProgress: function() {\n            return this.uploader.fileupload('active');\n        },\n\n        /**\n         * Return true, if this is the last upload.\n         */\n        isLastUpload: function() {\n            // Processing the last file or not processing at all.\n            return this.getInProgress() < 2;\n        },\n\n        /**\n         * Called on file add.\n         */\n        onFileAdd: function(e, data) {\n            e.stopPropagation();\n\n            var validateExtension = false;\n\n            if (this.allowedKinds) {\n                if (!this._extensionList) {\n                    this._createExtensionList();\n                }\n\n                validateExtension = true;\n            }\n\n            // Make sure that file API is there before relying on it\n            data.process().done($.proxy(function() {\n                var file = data.files[0];\n                var pass = true;\n                if (validateExtension) {\n\n                    var matches = file.name.match(/\\.([a-z0-4_]+)$/i);\n                    var fileExtension = matches[1];\n                    if ($.inArray(fileExtension.toLowerCase(), this._extensionList) === -1) {\n                        pass = false;\n                        this._rejectedFiles.type.push('\u201c' + file.name + '\u201d');\n                    }\n                }\n\n                if (file.size > this.settings.maxFileSize) {\n                    this._rejectedFiles.size.push('\u201c' + file.name + '\u201d');\n                    pass = false;\n                }\n\n                // If the validation has passed for this file up to now, check if we're not hitting any limits\n                if (pass && typeof this.settings.canAddMoreFiles === 'function' && !this.settings.canAddMoreFiles(this._validFileCounter)) {\n                    this._rejectedFiles.limit.push('\u201c' + file.name + '\u201d');\n                    pass = false;\n                }\n\n                if (pass) {\n                    this._validFileCounter++;\n                    data.submit();\n                }\n\n                if (++this._totalFileCounter === data.originalFiles.length) {\n                    this._totalFileCounter = 0;\n                    this._validFileCounter = 0;\n                    this.processErrorMessages();\n                }\n\n            }, this));\n\n            return true;\n        },\n\n        /**\n         * Process error messages.\n         */\n        processErrorMessages: function() {\n            var str;\n\n            if (this._rejectedFiles.type.length) {\n                if (this._rejectedFiles.type.length === 1) {\n                    str = \"The file {files} could not be uploaded. The allowed file kinds are: {kinds}.\";\n                }\n                else {\n                    str = \"The files {files} could not be uploaded. The allowed file kinds are: {kinds}.\";\n                }\n\n                str = Craft.t('app', str, {files: this._rejectedFiles.type.join(\", \"), kinds: this.allowedKinds.join(\", \")});\n                this._rejectedFiles.type = [];\n                alert(str);\n            }\n\n            if (this._rejectedFiles.size.length) {\n                if (this._rejectedFiles.size.length === 1) {\n                    str = \"The file {files} could not be uploaded, because it exceeds the maximum upload size of {size}.\";\n                }\n                else {\n                    str = \"The files {files} could not be uploaded, because they exceeded the maximum upload size of {size}.\";\n                }\n\n                str = Craft.t('app', str, {files: this._rejectedFiles.size.join(\", \"), size: this.humanFileSize(Craft.maxUploadSize)});\n                this._rejectedFiles.size = [];\n                alert(str);\n            }\n\n            if (this._rejectedFiles.limit.length) {\n                if (this._rejectedFiles.limit.length === 1) {\n                    str = \"The file {files} could not be uploaded, because the field limit has been reached.\";\n                }\n                else {\n                    str = \"The files {files} could not be uploaded, because the field limit has been reached.\";\n                }\n\n                str = Craft.t('app', str, {files: this._rejectedFiles.limit.join(\", \")});\n                this._rejectedFiles.limit = [];\n                alert(str);\n            }\n        },\n\n        humanFileSize: function(bytes) {\n            var threshold = 1024;\n\n            if (bytes < threshold) {\n                return bytes + ' B';\n            }\n\n            var units = ['kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];\n\n            var u = -1;\n\n            do\n            {\n                bytes = bytes / threshold;\n                ++u;\n            }\n            while (bytes >= threshold);\n\n            return bytes.toFixed(1) + ' ' + units[u];\n        },\n\n        _createExtensionList: function() {\n            this._extensionList = [];\n\n            for (var i = 0; i < this.allowedKinds.length; i++) {\n                var allowedKind = this.allowedKinds[i];\n\n                if (typeof Craft.fileKinds[allowedKind] !== 'undefined') {\n                    for (var j = 0; j < Craft.fileKinds[allowedKind].extensions.length; j++) {\n                        var ext = Craft.fileKinds[allowedKind].extensions[j];\n                        this._extensionList.push(ext);\n                    }\n                }\n            }\n        },\n\n        destroy: function() {\n            this.$element.fileupload('destroy');\n            this.base();\n        }\n    },\n\n// Static Properties\n// =============================================================================\n\n    {\n        defaults: {\n            dropZone: null,\n            pasteZone: null,\n            fileInput: null,\n            sequentialUploads: true,\n            maxFileSize: Craft.maxUploadSize,\n            allowedKinds: null,\n            events: {},\n            canAddMoreFiles: null,\n            headers: {'Accept' : 'application/json;q=0.9,*/*;q=0.8'},\n            paramName: 'assets-upload'\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Handle Generator\n */\nCraft.UriFormatGenerator = Craft.BaseInputGenerator.extend(\n    {\n        generateTargetValue: function(sourceVal) {\n            // Remove HTML tags\n            sourceVal = sourceVal.replace(\"/<(.*?)>/g\", '');\n\n            // Make it lowercase\n            sourceVal = sourceVal.toLowerCase();\n\n            // Convert extended ASCII characters to basic ASCII\n            sourceVal = Craft.asciiString(sourceVal);\n\n            // Handle must start with a letter and end with a letter/number\n            sourceVal = sourceVal.replace(/^[^a-z]+/, '');\n            sourceVal = sourceVal.replace(/[^a-z0-9]+$/, '');\n\n            // Get the \"words\"\n            var words = Craft.filterArray(sourceVal.split(/[^a-z0-9]+/));\n\n            var uriFormat = words.join('-');\n\n            if (uriFormat && this.settings.suffix) {\n                uriFormat += this.settings.suffix;\n            }\n\n            return uriFormat;\n        }\n    });\n\n})(jQuery);\n", "!function($){$.extend(Craft,{navHeight:48,t:function(t,e,i){if(void 0!==Craft.translations[t]&&void 0!==Craft.translations[t][e]&&(e=Craft.translations[t][e]),i)for(var s in i)i.hasOwnProperty(s)&&(e=e.replace(\"{\"+s+\"}\",i[s]));return e},formatDate:function(t){return\"object\"!=typeof t&&(t=new Date(t)),$.datepicker.formatDate(Craft.datepickerOptions.dateFormat,t)},formatNumber:function(t,e){return void 0===e&&(e=\",.0f\"),d3.formatLocale(d3FormatLocaleDefinition).format(e)(t)},escapeHtml:function(t){return $(\"<div/>\").text(t).html()},escapeRegex:function(t){return t.replace(/[-[\\]{}()*+?.,\\\\^$|#\\s]/g,\"\\\\$&\")},getText:function(t){return $(\"<div/>\").html(t).text()},encodeUriComponent:function(t){t=encodeURIComponent(t);var e={\"!\":\"%21\",\"*\":\"%2A\",\"'\":\"%27\",\"(\":\"%28\",\")\":\"%29\"};for(var i in e){var s=new RegExp(\"\\\\\"+i,\"g\");t=t.replace(s,e[i])}return t},selectFullValue:function(t){var e=$(t),i=e.val();if(void 0!==e[0].setSelectionRange){var s=2*i.length;e[0].setSelectionRange(0,s)}else e.val(i)},formatInputId:function(t){return this.rtrim(t.replace(/[\\[\\]\\\\]+/g,\"-\"),\"-\")},getUrl:function(t,e,i){\"string\"!=typeof t&&(t=\"\");var s=\"\";if($.isPlainObject(e)){var n=[];for(var a in e)if(e.hasOwnProperty(a)){var r=e[a];\"#\"===a?s=r:null!==r&&\"\"!==r&&n.push(a+\"=\"+r)}e=n}e=Garnish.isArray(e)?e.join(\"&\"):Craft.trim(e,\"&?\");var o,l=t.indexOf(\"?\");if(-1!==l&&(e=t.substr(l+1)+(e?\"&\"+e:\"\"),t=t.substr(0,l)),-1!==t.search(\"://\")||\"/\"===t[0])return t+(e?\"?\"+e:\"\");if(t=Craft.trim(t,\"/\"),i){if(o=i,t){var h=o.match(new RegExp(\"[&?]\"+Craft.escapeRegex(Craft.pathParam)+\"=[^&]+\"));h&&(o=o.replace(h[0],Craft.rtrim(h[0],\"/\")+\"/\"+t),t=\"\")}}else o=Craft.baseUrl;if(-1!==(l=o.indexOf(\"?\"))&&(e=o.substr(l+1)+(e?\"&\"+e:\"\"),o=o.substr(0,l)),!Craft.omitScriptNameInUrls&&t)if(Craft.usePathInfo)-1===o.search(Craft.scriptName)&&(o=Craft.rtrim(o,\"/\")+\"/\"+Craft.scriptName);else{if(e&&e.substr(0,Craft.pathParam.length+1)===Craft.pathParam+\"=\"){var d,c=e.indexOf(\"&\");e=-1!==c?(d=e.substring(2,c),e.substr(c+1)):(d=e.substr(2),null),t=(d=Craft.rtrim(d))+(t?\"/\"+t:\"\")}e=Craft.pathParam+\"=\"+t+(e?\"&\"+e:\"\"),t=null}return t&&(o=Craft.rtrim(o,\"/\")+\"/\"+t),e&&(o+=\"?\"+e),s&&(o+=\"#\"+s),o},getCpUrl:function(t,e){return this.getUrl(t,e,Craft.baseCpUrl)},getSiteUrl:function(t,e){return this.getUrl(t,e,Craft.baseSiteUrl)},getActionUrl:function(t,e){return Craft.getUrl(t,e,Craft.actionUrl)},redirectTo:function(t){document.location.href=this.getUrl(t)},getCsrfInput:function(){return Craft.csrfTokenName?'<input type=\"hidden\" name=\"'+Craft.csrfTokenName+'\" value=\"'+Craft.csrfTokenValue+'\"/>':\"\"},postActionRequest:function(t,e,s,i){\"function\"==typeof e&&(i=s,s=e,e={});var n={\"X-Registered-Asset-Bundles\":Object.keys(Craft.registeredAssetBundles).join(\",\"),\"X-Registered-Js-Files\":Object.keys(Craft.registeredJsFiles).join(\",\")};Craft.csrfTokenValue&&Craft.csrfTokenName&&(n[\"X-CSRF-Token\"]=Craft.csrfTokenValue);var a=$.ajax($.extend({url:Craft.getActionUrl(t),type:\"POST\",dataType:\"json\",headers:n,data:e,success:s,error:function(t,e,i){4===t.readyState&&(void 0!==Craft.cp?Craft.cp.displayError():alert(Craft.t(\"app\",\"An unknown error occurred.\")),s&&s(null,e,t))}},i));return i&&\"function\"==typeof i.send&&i.send(a),a},_waitingOnAjax:!1,_ajaxQueue:[],queueActionRequest:function(t,e,i,s){\"function\"==typeof e&&(s=i,i=e,e=void 0),Craft._ajaxQueue.push([t,e,i,s]),Craft._waitingOnAjax||Craft._postNextActionRequestInQueue()},_postNextActionRequestInQueue:function(){Craft._waitingOnAjax=!0;var s=Craft._ajaxQueue.shift();Craft.postActionRequest(s[0],s[1],function(t,e,i){s[2]&&\"function\"==typeof s[2]&&s[2](t,e,i),Craft._ajaxQueue.length?Craft._postNextActionRequestInQueue():Craft._waitingOnAjax=!1},s[3])},stringToArray:function(t){if(\"string\"!=typeof t)return t;for(var e=t.split(\",\"),i=0;i<e.length;i++)e[i]=$.trim(e[i]);return e},expandPostArray:function(t){var e,i={};for(var s in t)if(t.hasOwnProperty(s)){var n,a=t[s],r=s.match(/^(\\w+)(\\[.*)?/);if(r[2])for(n=r[2].match(/\\[[^\\[\\]]*\\]/g),e=0;e<n.length;e++)n[e]=n[e].substring(1,n[e].length-1);else n=[];n.unshift(r[1]);var o=i;for(e=0;e<n.length;e++)e<n.length-1?(\"object\"!=typeof o[n[e]]&&(n[e+1]&&parseInt(n[e+1])!=n[e+1]?o[n[e]]={}:o[n[e]]=[]),o=o[n[e]]):(n[e]||(n[e]=o.length),o[n[e]]=a)}return i},compare:function(t,e,i){if(typeof t!=typeof e)return!1;if(\"object\"!=typeof t)return t===e;if(t.length!==e.length)return!1;if(t instanceof Array!=e instanceof Array)return!1;if(!(t instanceof Array))if(void 0===i||!0===i){if(!Craft.compare(Craft.getObjectKeys(t).sort(),Craft.getObjectKeys(e).sort()))return!1}else if(!Craft.compare(Craft.getObjectKeys(t),Craft.getObjectKeys(e)))return!1;for(var s in t)if(t.hasOwnProperty(s)&&!Craft.compare(t[s],e[s]))return!1;return!0},getObjectKeys:function(t){var e=[];for(var i in t)t.hasOwnProperty(i)&&e.push(i);return e},escapeChars:function(t){Garnish.isArray(t)||(t=t.split());for(var e=\"\",i=0;i<t.length;i++)e+=\"\\\\\"+t[i];return e},ltrim:function(t,e){if(!t)return t;void 0===e&&(e=\" \\t\\n\\r\\0\\v\");var i=new RegExp(\"^[\"+Craft.escapeChars(e)+\"]+\");return t.replace(i,\"\")},rtrim:function(t,e){if(!t)return t;void 0===e&&(e=\" \\t\\n\\r\\0\\v\");var i=new RegExp(\"[\"+Craft.escapeChars(e)+\"]+$\");return t.replace(i,\"\")},trim:function(t,e){return t=Craft.ltrim(t,e),t=Craft.rtrim(t,e)},startsWith:function(t,e){return t.substr(0,e.length)===e},filterArray:function(t,e){for(var i=[],s=0;s<t.length;s++){(\"function\"==typeof e?e(t[s],s):t[s])&&i.push(t[s])}return i},inArray:function(t,e){return-1!==$.inArray(t,e)},removeFromArray:function(t,e){var i=$.inArray(t,e);return-1!==i&&(e.splice(i,1),!0)},getLast:function(t){return t.length?t[t.length-1]:null},uppercaseFirst:function(t){return t.charAt(0).toUpperCase()+t.slice(1)},lowercaseFirst:function(t){return t.charAt(0).toLowerCase()+t.slice(1)},parseUrl:function(t){var e=t.match(/^(?:(https?):\\/\\/|\\/\\/)([^\\/\\:]*)(?:\\:(\\d+))?(\\/[^\\?]*)?(?:\\?([^#]*))?(#.*)?/);return e?{scheme:e[1],host:e[2]+(e[3]?\":\"+e[3]:\"\"),hostname:e[2],port:e[3]||null,path:e[4]||\"/\",query:e[5]||null,hash:e[6]||null}:{}},isSameHost:function(t){var e=this.parseUrl(document.location.href);if(!e)return!1;var i=this.parseUrl(t);return!!i&&e.host===i.host},secondsToHumanTimeDuration:function(t,e){void 0===e&&(e=!0);var i=Math.floor(t/604800);t%=604800;var s=Math.floor(t/86400);t%=86400;var n,a=Math.floor(t/3600);t%=3600,e?(n=Math.floor(t/60),t%=60):(n=Math.round(t/60),t=0);var r=[];return i&&r.push(i+\" \"+(1===i?Craft.t(\"app\",\"week\"):Craft.t(\"app\",\"weeks\"))),s&&r.push(s+\" \"+(1===s?Craft.t(\"app\",\"day\"):Craft.t(\"app\",\"days\"))),a&&r.push(a+\" \"+(1===a?Craft.t(\"app\",\"hour\"):Craft.t(\"app\",\"hours\"))),!n&&(e||i||s||a)||r.push(n+\" \"+(1===n?Craft.t(\"app\",\"minute\"):Craft.t(\"app\",\"minutes\"))),!t&&(!e||i||s||a||n)||r.push(t+\" \"+(1===t?Craft.t(\"app\",\"second\"):Craft.t(\"app\",\"seconds\"))),r.join(\", \")},asciiString:function(t,e){for(var i,s=\"\",n=0;n<t.length;n++)i=t.charAt(n),s+=(e||Craft.asciiCharMap)[i]||i;return s},randomString:function(t){for(var e=\"\",i=0;i<t;i++)e+=\"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789\".charAt(Math.floor(62*Math.random()));return e},preventOutlineOnMouseFocus:function(t){var e=$(t),i=\".preventOutlineOnMouseFocus\";e.on(\"mousedown\"+i,function(){e.addClass(\"no-outline\"),e.trigger(\"focus\")}).on(\"keydown\"+i+\" blur\"+i,function(t){t.keyCode!==Garnish.SHIFT_KEY&&t.keyCode!==Garnish.CTRL_KEY&&t.keyCode!==Garnish.CMD_KEY&&e.removeClass(\"no-outline\")})},createErrorList:function(t){for(var e=$(document.createElement(\"ul\")).addClass(\"errors\"),i=0;i<t.length;i++){var s=$(document.createElement(\"li\"));s.appendTo(e),s.html(t[i])}return e},appendHeadHtml:function(t){if(t){var e=$(\"link[href]\");if(e.length){for(var i,s=[],n=0;n<e.length;n++)i=e.eq(n).attr(\"href\").replace(/&/g,\"&amp;\"),s.push(Craft.escapeRegex(i));var a=new RegExp('<link\\\\s[^>]*href=\"(?:'+s.join(\"|\")+')\".*?><\\/script>',\"g\");t=t.replace(a,\"\")}$(\"head\").append(t)}},appendFootHtml:function(t){if(t){var e=$(\"script[src]\");if(e.length){for(var i,s=[],n=0;n<e.length;n++)i=e.eq(n).attr(\"src\").replace(/&/g,\"&amp;\"),s.push(Craft.escapeRegex(i));var a=new RegExp('<script\\\\s[^>]*src=\"(?:'+s.join(\"|\")+')\".*?><\\/script>',\"g\");t=t.replace(a,\"\")}Garnish.$bod.append(t)}},initUiElements:function(t){$(\".grid\",t).grid(),$(\".info\",t).infoicon(),$(\".checkbox-select\",t).checkboxselect(),$(\".fieldtoggle\",t).fieldtoggle(),$(\".lightswitch\",t).lightswitch(),$(\".nicetext\",t).nicetext(),$(\".pill\",t).pill(),$(\".formsubmit\",t).formsubmit(),$(\".menubtn\",t).menubtn()},_elementIndexClasses:{},_elementSelectorModalClasses:{},_elementEditorClasses:{},registerElementIndexClass:function(t,e){if(void 0!==this._elementIndexClasses[t])throw\"An element index class has already been registered for the element type \u201c\"+t+\"\u201d.\";this._elementIndexClasses[t]=e},registerElementSelectorModalClass:function(t,e){if(void 0!==this._elementSelectorModalClasses[t])throw\"An element selector modal class has already been registered for the element type \u201c\"+t+\"\u201d.\";this._elementSelectorModalClasses[t]=e},registerElementEditorClass:function(t,e){if(void 0!==this._elementEditorClasses[t])throw\"An element editor class has already been registered for the element type \u201c\"+t+\"\u201d.\";this._elementEditorClasses[t]=e},createElementIndex:function(t,e,i){return new(void 0!==this._elementIndexClasses[t]?this._elementIndexClasses[t]:Craft.BaseElementIndex)(t,e,i)},createElementSelectorModal:function(t,e){return new(void 0!==this._elementSelectorModalClasses[t]?this._elementSelectorModalClasses[t]:Craft.BaseElementSelectorModal)(t,e)},createElementEditor:function(t,e,i){return new(void 0!==this._elementEditorClasses[t]?this._elementEditorClasses[t]:Craft.BaseElementEditor)(e,i)},getLocalStorage:function(t,e){return t=\"Craft-\"+Craft.systemUid+\".\"+t,\"undefined\"!=typeof localStorage&&void 0!==localStorage[t]?JSON.parse(localStorage[t]):e},setLocalStorage:function(t,e){if(\"undefined\"!=typeof localStorage){t=\"Craft-\"+Craft.systemUid+\".\"+t;try{localStorage[t]=JSON.stringify(e)}catch(t){}}},getElementInfo:function(t){var e=$(t);return e.hasClass(\"element\")||(e=e.find(\".element:first\")),{id:e.data(\"id\"),siteId:e.data(\"site-id\"),label:e.data(\"label\"),status:e.data(\"status\"),url:e.data(\"url\"),hasThumb:e.hasClass(\"hasthumb\"),$element:e}},setElementSize:function(t,e){var i=$(t);if(\"small\"!==e&&\"large\"!==e&&(e=\"small\"),!i.hasClass(e)){var s=\"small\"===e?\"large\":\"small\";if(i.addClass(e).removeClass(s),i.hasClass(\"hasthumb\")){var n=i.find(\"> .elementthumb > img\"),a=$(\"<img/>\",{sizes:(\"small\"===e?\"30\":\"100\")+\"px\",srcset:n.attr(\"srcset\")||n.attr(\"data-pfsrcset\")});n.replaceWith(a),picturefill({elements:[a[0]]})}}}}),$.extend($.fn,{animateLeft:function(t,e,i,s){return\"ltr\"===Craft.orientation?this.velocity({left:t},e,i,s):this.velocity({right:t},e,i,s)},animateRight:function(t,e,i,s){return\"ltr\"===Craft.orientation?this.velocity({right:t},e,i,s):this.velocity({left:t},e,i,s)},disable:function(){return this.each(function(){var t=$(this);t.addClass(\"disabled\"),t.data(\"activatable\")&&t.removeAttr(\"tabindex\")})},enable:function(){return this.each(function(){var t=$(this);t.removeClass(\"disabled\"),t.data(\"activatable\")&&t.attr(\"tabindex\",\"0\")})},grid:function(){return this.each(function(){var t=$(this),e={};t.data(\"item-selector\")&&(e.itemSelector=t.data(\"item-selector\")),t.data(\"cols\")&&(e.cols=parseInt(t.data(\"cols\"))),t.data(\"max-cols\")&&(e.maxCols=parseInt(t.data(\"max-cols\"))),t.data(\"min-col-width\")&&(e.minColWidth=parseInt(t.data(\"min-col-width\"))),t.data(\"mode\")&&(e.mode=t.data(\"mode\")),t.data(\"fill-mode\")&&(e.fillMode=t.data(\"fill-mode\")),t.data(\"col-class\")&&(e.colClass=t.data(\"col-class\")),t.data(\"snap-to-grid\")&&(e.snapToGrid=!!t.data(\"snap-to-grid\")),new Craft.Grid(this,e)})},infoicon:function(){return this.each(function(){new Craft.InfoIcon(this)})},checkboxselect:function(){return this.each(function(){$.data(this,\"checkboxselect\")||new Garnish.CheckboxSelect(this)})},fieldtoggle:function(){return this.each(function(){$.data(this,\"fieldtoggle\")||new Craft.FieldToggle(this)})},lightswitch:function(e,t,i){return\"settings\"===e?(\"string\"==typeof t?(e={})[t]=i:e=t,this.each(function(){var t=$.data(this,\"lightswitch\");t&&t.setSettings(e)})):($.isPlainObject(e)||(e={}),this.each(function(){var t=$.extend({},e);Garnish.hasAttr(this,\"data-value\")&&(t.value=$(this).attr(\"data-value\")),$.data(this,\"lightswitch\")||new Craft.LightSwitch(this,t)}))},nicetext:function(){return this.each(function(){$.data(this,\"nicetext\")||new Garnish.NiceText(this)})},pill:function(){return this.each(function(){$.data(this,\"pill\")||new Garnish.Pill(this)})},formsubmit:function(){this.on(\"click\",function(t){var e=$(t.currentTarget);if(!e.attr(\"data-confirm\")||confirm(e.attr(\"data-confirm\"))){var i=e.data(\"menu\")?e.data(\"menu\").$anchor:e,s=i.attr(\"data-form\")?$(\"#\"+i.attr(\"data-form\")):i.closest(\"form\");e.data(\"action\")&&$('<input type=\"hidden\" name=\"action\"/>').val(e.data(\"action\")).appendTo(s),e.data(\"redirect\")&&$('<input type=\"hidden\" name=\"redirect\"/>').val(e.data(\"redirect\")).appendTo(s),e.data(\"param\")&&$('<input type=\"hidden\"/>').attr({name:e.data(\"param\"),value:e.data(\"value\")}).appendTo(s),s.trigger({type:\"submit\",customTrigger:e})}})},menubtn:function(){return this.each(function(){var t=$(this);if(!t.data(\"menubtn\")&&t.next().hasClass(\"menu\")){var e={};t.data(\"menu-anchor\")&&(e.menuAnchor=t.data(\"menu-anchor\")),new Garnish.MenuBtn(t,e)}})}}),Garnish.$doc.ready(function(){Craft.initUiElements()}),Craft.BaseElementEditor=Garnish.Base.extend({$element:null,elementId:null,siteId:null,$form:null,$fieldsContainer:null,$cancelBtn:null,$saveBtn:null,$spinner:null,$siteSelect:null,$siteSpinner:null,hud:null,init:function(t,e){void 0===e&&$.isPlainObject(t)&&(e=t,t=null),this.$element=$(t),this.setSettings(e,Craft.BaseElementEditor.defaults),this.loadHud()},setElementAttribute:function(t,e){this.settings.attributes||(this.settings.attributes={}),null===e?delete this.settings.attributes[t]:this.settings.attributes[t]=e},getBaseData:function(){var t=$.extend({},this.settings.params);return this.settings.siteId?t.siteId=this.settings.siteId:this.$element&&this.$element.data(\"site-id\")&&(t.siteId=this.$element.data(\"site-id\")),this.settings.elementId?t.elementId=this.settings.elementId:this.$element&&this.$element.data(\"id\")&&(t.elementId=this.$element.data(\"id\")),this.settings.elementType&&(t.elementType=this.settings.elementType),this.settings.attributes&&(t.attributes=this.settings.attributes),this.settings.prevalidate&&(t.prevalidate=1),t},loadHud:function(){this.onBeginLoading();var t=this.getBaseData();t.includeSites=Craft.isMultiSite&&this.settings.showSiteSwitcher,Craft.postActionRequest(\"elements/get-editor-html\",t,$.proxy(this,\"showHud\"))},showHud:function(t,e){if(this.onEndLoading(),\"success\"===e){var i=$();if(t.sites){var s=$('<div class=\"hud-header\"/>');if(1===t.sites.length)$(\"<h5/>\",{text:t.sites[0].name}).appendTo(s);else{var n=$('<div class=\"select\"/>').appendTo(s);this.$siteSelect=$(\"<select/>\").appendTo(n),this.$siteSpinner=$('<div class=\"spinner hidden\"/>').appendTo(s);for(var a=0;a<t.sites.length;a++){var r=t.sites[a];$('<option value=\"'+r.id+'\"'+(r.id==t.siteId?' selected=\"selected\"':\"\")+\">\"+r.name+\"</option>\").appendTo(this.$siteSelect)}this.addListener(this.$siteSelect,\"change\",\"switchSite\")}i=i.add(s)}this.$form=$(\"<div/>\"),this.$fieldsContainer=$('<div class=\"fields\"/>').appendTo(this.$form),this.updateForm(t),this.onCreateForm(this.$form);var o=$('<div class=\"hud-footer\"/>').appendTo(this.$form),l=$('<div class=\"buttons right\"/>').appendTo(o);if(this.$cancelBtn=$('<div class=\"btn\">'+Craft.t(\"app\",\"Cancel\")+\"</div>\").appendTo(l),this.$saveBtn=$('<input class=\"btn submit\" type=\"submit\" value=\"'+Craft.t(\"app\",\"Save\")+'\"/>').appendTo(l),this.$spinner=$('<div class=\"spinner hidden\"/>').appendTo(l),i=i.add(this.$form),this.hud)this.hud.updateBody(i),this.hud.updateSizeAndPosition();else{var h=this.settings.hudTrigger||this.$element;this.hud=new Garnish.HUD(h,i,{bodyClass:\"body elementeditor\",closeOtherHUDs:!1,onShow:$.proxy(this,\"onShowHud\"),onHide:$.proxy(this,\"onHideHud\"),onSubmit:$.proxy(this,\"saveElement\")}),this.hud.$hud.data(\"elementEditor\",this),this.hud.on(\"hide\",$.proxy(function(){delete this.hud},this))}i.find(\".text:first\").trigger(\"focus\"),this.addListener(this.$cancelBtn,\"click\",function(){this.hud.hide()})}},switchSite:function(){var t=this.$siteSelect.val();t!=this.siteId&&(this.$siteSpinner.removeClass(\"hidden\"),this.reloadForm({siteId:t},$.proxy(function(t){this.$siteSpinner.addClass(\"hidden\"),\"success\"!==t&&this.$siteSelect.val(this.siteId)},this)))},reloadForm:function(t,i){t=$.extend(this.getBaseData(),t),Craft.postActionRequest(\"elements/get-editor-html\",t,$.proxy(function(t,e){\"success\"===e&&this.updateForm(t),i&&i(e)},this))},updateForm:function(t){this.siteId=t.siteId,this.$fieldsContainer.html(t.html);for(var e=this.$fieldsContainer.find(\"> .meta > .field > .heading > .instructions\"),i=0;i<e.length;i++)e.eq(i).replaceWith($(\"<span/>\",{class:\"info\",html:e.eq(i).children().html()})).infoicon();Garnish.requestAnimationFrame($.proxy(function(){Craft.appendHeadHtml(t.headHtml),Craft.appendFootHtml(t.footHtml),Craft.initUiElements(this.$fieldsContainer)},this))},saveElement:function(){var t=this.settings.validators;if($.isArray(t))for(var e=0;e<t.length;e++)if($.isFunction(t[e])&&!t[e].call())return!1;this.$spinner.removeClass(\"hidden\");var i=$.param(this.getBaseData())+\"&\"+this.hud.$body.serialize();Craft.postActionRequest(\"elements/save-element\",i,$.proxy(function(t,e){if(this.$spinner.addClass(\"hidden\"),\"success\"===e)if(t.success){if(this.$element&&this.siteId==this.$element.data(\"site-id\")){var i=this.$element.find(\".title\"),s=i.find(\"a\");s.length&&t.cpEditUrl?(s.attr(\"href\",t.cpEditUrl),s.text(t.newTitle)):i.text(t.newTitle)}this.closeHud(),this.onSaveElement(t)}else this.updateForm(t),Garnish.shake(this.hud.$hud)},this))},closeHud:function(){this.hud.hide(),delete this.hud},onShowHud:function(){this.settings.onShowHud(),this.trigger(\"showHud\")},onHideHud:function(){this.settings.onHideHud(),this.trigger(\"hideHud\")},onBeginLoading:function(){this.$element&&this.$element.addClass(\"loading\"),this.settings.onBeginLoading(),this.trigger(\"beginLoading\")},onEndLoading:function(){this.$element&&this.$element.removeClass(\"loading\"),this.settings.onEndLoading(),this.trigger(\"endLoading\")},onSaveElement:function(t){this.settings.onSaveElement(t),this.trigger(\"saveElement\",{response:t}),Craft.cp.runQueue()},onCreateForm:function(t){this.settings.onCreateForm(t)}},{defaults:{hudTrigger:null,showSiteSwitcher:!0,elementId:null,elementType:null,siteId:null,attributes:null,params:null,prevalidate:!1,elementIndex:null,onShowHud:$.noop,onHideHud:$.noop,onBeginLoading:$.noop,onEndLoading:$.noop,onCreateForm:$.noop,onSaveElement:$.noop,validators:[]}}),Craft.BaseElementIndex=Garnish.Base.extend({initialized:!1,elementType:null,instanceState:null,sourceStates:null,sourceStatesStorageKey:null,searchTimeout:null,sourceSelect:null,$container:null,$main:null,$mainSpinner:null,isIndexBusy:!1,$sidebar:null,showingSidebar:null,sourceKey:null,sourceViewModes:null,$source:null,sourcesByKey:null,$visibleSources:null,$customizeSourcesBtn:null,customizeSourcesModal:null,$toolbar:null,$toolbarFlexContainer:null,toolbarOffset:null,$search:null,searching:!1,searchText:null,trashed:!1,drafts:!1,$clearSearchBtn:null,$statusMenuBtn:null,$statusMenuContainer:null,statusMenu:null,status:null,$siteMenuBtn:null,siteMenu:null,siteId:null,$sortMenuBtn:null,sortMenu:null,$sortAttributesList:null,$sortDirectionsList:null,$scoreSortAttribute:null,$structureSortAttribute:null,$elements:null,$viewModeBtnContainer:null,viewModeBtns:null,viewMode:null,view:null,_autoSelectElements:null,$countContainer:null,page:1,$exportBtn:null,actions:null,actionsHeadHtml:null,actionsFootHtml:null,$selectAllContainer:null,$selectAllCheckbox:null,showingActionTriggers:!1,_$detachedToolbarItems:null,_$triggers:null,init:function(t,e,i){if(this.elementType=t,this.$container=e,this.setSettings(i,Craft.BaseElementIndex.defaults),this.instanceState=this.getDefaultInstanceState(),this.sourceStates={},this.settings.storageKey&&$.extend(this.instanceState,Craft.getLocalStorage(this.settings.storageKey),{}),this.sourceStatesStorageKey=\"BaseElementIndex.\"+this.elementType+\".\"+this.settings.context,$.extend(this.sourceStates,Craft.getLocalStorage(this.sourceStatesStorageKey,{})),this.$main=this.$container.find(\".main\"),this.$toolbar=this.$container.find(\".toolbar:first\"),this.$toolbarFlexContainer=this.$toolbar.children(\".flex\"),this.$statusMenuBtn=this.$toolbarFlexContainer.find(\".statusmenubtn:first\"),this.$statusMenuContainer=this.$statusMenuBtn.parent(),this.$siteMenuBtn=this.$container.find(\".sitemenubtn:first\"),this.$sortMenuBtn=this.$toolbarFlexContainer.find(\".sortmenubtn:first\"),this.$search=this.$toolbarFlexContainer.find(\".search:first input:first\"),this.$clearSearchBtn=this.$toolbarFlexContainer.find(\".search:first > .clear\"),this.$mainSpinner=this.$toolbarFlexContainer.find(\".spinner:first\"),this.$sidebar=this.$container.find(\".sidebar:first\"),this.$customizeSourcesBtn=this.$sidebar.find(\".customize-sources\"),this.$elements=this.$container.find(\".elements:first\"),this.$countContainer=this.$container.find(\"#count-container\"),this.$exportBtn=this.$container.find(\"#export-btn\"),this.settings.hideSidebar&&(this.$sidebar.hide(),$(\".body, .content\",this.$container).removeClass(\"has-sidebar\")),(this.settings.toolbarFixed||null===this.settings.toolbarFixed&&\"index\"===this.settings.context)&&!Garnish.isMobileBrowser(!0)&&(this.addListener(Garnish.$win,\"resize\",\"updateFixedToolbar\"),this.addListener(Garnish.$scrollContainer,\"scroll\",\"updateFixedToolbar\")),this.initSources()){if(this.$customizeSourcesBtn.length&&this.addListener(this.$customizeSourcesBtn,\"click\",\"createCustomizeSourcesModal\"),this.$statusMenuBtn.length&&(this.statusMenu=this.$statusMenuBtn.menubtn().data(\"menubtn\").menu,this.statusMenu.on(\"optionselect\",$.proxy(this,\"_handleStatusChange\"))),this.$siteMenuBtn.length){this.siteMenu=this.$siteMenuBtn.menubtn().data(\"menubtn\").menu;var s=this.siteMenu.$options.filter(\".sel:first\");if(s.length||(s=this.siteMenu.$options.first()),s.length?this._setSite(s.data(\"site-id\")):this.settings.criteria={id:\"0\"},this.siteMenu.on(\"optionselect\",$.proxy(this,\"_handleSiteChange\")),this.siteId){var n=Craft.getLocalStorage(\"BaseElementIndex.siteId\");if(n&&n!=this.siteId){var a=this.siteMenu.$options.filter('[data-site-id=\"'+n+'\"]:first');a.length&&a.trigger(\"click\")}}}else this.settings.criteria&&this.settings.criteria.siteId?this._setSite(this.settings.criteria.siteId):this._setSite(Craft.siteId);this.addListener(this.$search,\"textchange\",$.proxy(function(){!this.searching&&this.$search.val()?this.startSearching():this.searching&&!this.$search.val()&&this.stopSearching(),this.searchTimeout&&clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout($.proxy(this,\"updateElementsIfSearchTextChanged\"),500)},this)),this.addListener(this.$search,\"keypress\",$.proxy(function(t){t.keyCode===Garnish.RETURN_KEY&&(t.preventDefault(),this.searchTimeout&&clearTimeout(this.searchTimeout),this.updateElementsIfSearchTextChanged())},this)),this.addListener(this.$clearSearchBtn,\"click\",$.proxy(function(){this.$search.val(\"\"),this.searchTimeout&&clearTimeout(this.searchTimeout),Garnish.isMobileBrowser(!0)||this.$search.trigger(\"focus\"),this.stopSearching(),this.updateElementsIfSearchTextChanged()},this)),Garnish.isMobileBrowser(!0)||this.$search.trigger(\"focus\"),this.$sortMenuBtn.length&&(this.sortMenu=this.$sortMenuBtn.menubtn().data(\"menubtn\").menu,this.$sortAttributesList=this.sortMenu.$container.children(\".sort-attributes\"),this.$sortDirectionsList=this.sortMenu.$container.children(\".sort-directions\"),this.sortMenu.on(\"optionselect\",$.proxy(this,\"_handleSortChange\"))),this.addListener(this.$exportBtn,\"click\",\"_showExportHud\"),this.initialized=!0,this.afterInit(),this.selectDefaultSource(),\"index\"===this.settings.context&&this.setPage(Craft.pageNum),this.updateElements(!0)}},afterInit:function(){this.onAfterInit()},getSourceContainer:function(){return this.$sidebar.find(\"nav>ul\")},get $sources(){if(this.sourceSelect)return this.sourceSelect.$items},initSources:function(){var t=this._getSourcesInList(this.getSourceContainer());return 0!==t.length&&(this.sourceSelect||(this.sourceSelect=new Garnish.Select(this.$sidebar.find(\"nav\"),{multi:!1,allowEmpty:!1,vertical:!0,onSelectionChange:$.proxy(this,\"_handleSourceSelectionChange\")})),this.sourcesByKey={},this._initSources(t),!0)},selectDefaultSource:function(){var t,e=this.getDefaultSourceKey();e&&(t=this.getSourceByKey(e),-1===this.$visibleSources.index(t)&&(t=null)),e&&t||(t=this.$visibleSources.first()),t.length&&this.selectSource(t)},refreshSources:function(){this.sourceSelect.removeAllItems();var t={context:this.settings.context,elementType:this.elementType};this.setIndexBusy(),Craft.postActionRequest(this.settings.refreshSourcesAction,t,$.proxy(function(t,e){this.setIndexAvailable(),\"success\"===e?(this.getSourceContainer().replaceWith(t.html),this.initSources(),this.selectDefaultSource()):Craft.cp.displayError(Craft.t(\"app\",\"An unknown error occurred.\"))},this))},updateFixedToolbar:function(t){this.updateFixedToolbar._scrollTop=Garnish.$scrollContainer.scrollTop(),992<Garnish.$win.width()&&17<=this.updateFixedToolbar._scrollTop?((this.updateFixedToolbar._makingFixed=!this.$toolbar.hasClass(\"fixed\"))&&(this.$elements.css(\"padding-top\",this.$toolbar.outerHeight()+21),this.$toolbar.addClass(\"fixed\")),!this.updateFixedToolbar._makingFixed&&\"resize\"!==t.type||this.$toolbar.css({top:Garnish.$scrollContainer.offset().top,width:this.$main.width()})):this.$toolbar.hasClass(\"fixed\")&&(this.$toolbar.removeClass(\"fixed\"),this.$toolbar.css(\"width\",\"\"),this.$elements.css(\"padding-top\",\"\"),this.$toolbar.css(\"top\",\"0\"))},initSource:function(t){this.sourceSelect.addItems(t),this.initSourceToggle(t),(this.sourcesByKey[t.data(\"key\")]=t).data(\"hasNestedSources\")&&-1!==this.instanceState.expandedSources.indexOf(t.data(\"key\"))&&this._expandSource(t)},initSourceToggle:function(t){this.deinitSourceToggle(t);var e=this._getSourceToggle(t);e.length?(this.addListener(t,\"dblclick\",\"_handleSourceDblClick\"),this.addListener(e,\"click\",\"_handleSourceToggleClick\"),t.data(\"hasNestedSources\",!0)):t.data(\"hasNestedSources\",!1)},deinitSource:function(t){this.sourceSelect.removeItems(t),this.deinitSourceToggle(t),delete this.sourcesByKey[t.data(\"key\")]},deinitSourceToggle:function(t){t.data(\"hasNestedSources\")&&(this.removeListener(t,\"dblclick\"),this.removeListener(this._getSourceToggle(t),\"click\")),t.removeData(\"hasNestedSources\")},getDefaultInstanceState:function(){return{selectedSource:null,expandedSources:[]}},getDefaultSourceKey:function(){return this.instanceState.selectedSource},getDefaultExpandedSources:function(){return this.instanceState.expandedSources},startSearching:function(){this.$clearSearchBtn.removeClass(\"hidden\"),this.$scoreSortAttribute||(this.$scoreSortAttribute=$('<li><a data-attr=\"score\">'+Craft.t(\"app\",\"Score\")+\"</a></li>\"),this.sortMenu.addOptions(this.$scoreSortAttribute.children())),this.$scoreSortAttribute.prependTo(this.$sortAttributesList),this.searching=!0,this._updateStructureSortOption(),this.setSortAttribute(\"score\")},stopSearching:function(){this.$clearSearchBtn.addClass(\"hidden\"),this.$scoreSortAttribute.detach(),this.searching=!1,this._updateStructureSortOption()},setInstanceState:function(t,e){\"object\"==typeof t?$.extend(this.instanceState,t):this.instanceState[t]=e,this.storeInstanceState()},storeInstanceState:function(){this.settings.storageKey&&Craft.setLocalStorage(this.settings.storageKey,this.instanceState)},getSourceState:function(t,e,i){return void 0===this.sourceStates[t]&&(this.sourceStates[t]={}),void 0===e?this.sourceStates[t]:void 0!==this.sourceStates[t][e]?this.sourceStates[t][e]:void 0!==i?i:null},getSelectedSourceState:function(t,e){return this.getSourceState(this.instanceState.selectedSource,t,e)},setSelecetedSourceState:function(t,e){var i=this.getSelectedSourceState();\"object\"==typeof t?$.extend(i,t):i[t]=e,this.sourceStates[this.instanceState.selectedSource]=i,Craft.setLocalStorage(this.sourceStatesStorageKey,this.sourceStates)},storeSortAttributeAndDirection:function(){var t=this.getSelectedSortAttribute();\"score\"!==t&&this.setSelecetedSourceState({order:t,sort:this.getSelectedSortDirection()})},setPage:function(t){t=Math.max(t,1),this.page=t;var e=document.location.href.replace(/\\?.*$/,\"\").replace(new RegExp(\"/\"+Craft.pageTrigger.replace(/[.*+?^${}()|[\\]\\\\]/g,\"\\\\$&\")+\"\\\\d+$\"),\"\").replace(/\\/+$/,\"\");1!==this.page&&(\"?\"!==Craft.pageTrigger[0]&&(e+=\"/\"),e+=Craft.pageTrigger+this.page),history.replaceState({},\"\",e)},getViewParams:function(){var t={siteId:this.siteId,search:this.searchText,offset:this.settings.batchSize*(this.page-1),limit:this.settings.batchSize,trashed:this.trashed?1:0,drafts:this.drafts?1:0};Garnish.hasAttr(this.$source,\"data-override-status\")||(t.status=this.status),$.extend(t,this.settings.criteria);var e={context:this.settings.context,elementType:this.elementType,source:this.instanceState.selectedSource,criteria:t,disabledElementIds:this.settings.disabledElementIds,viewState:$.extend({},this.getSelectedSourceState()),paginated:this._isViewPaginated()?1:0};return e.viewState.order=this.getSelectedSortAttribute(),e.viewState.sort=this.getSelectedSortDirection(),\"structure\"===this.getSelectedSortAttribute()&&(void 0===this.instanceState.collapsedElementIds&&(this.instanceState.collapsedElementIds=[]),e.collapsedElementIds=this.instanceState.collapsedElementIds),e},updateElements:function(t){if(this.initialized){this.setIndexBusy(),this.view&&(this.view.destroy(),delete this.view),this.$elements.html(\"\"),!0!==t&&(this.$countContainer.html(\"&nbsp;\"),this.setPage(1));var s=this.getViewParams();Craft.postActionRequest(this.settings.updateElementsAction,s,$.proxy(function(t,e){if(this.setIndexAvailable(),\"success\"===e){var i=Math.max(Math.ceil(t.count/this.settings.batchSize),1);if(this.page>i)return this.setPage(i),void this.updateElements(!0);this._updateView(s,t)}else Craft.cp.displayError(Craft.t(\"app\",\"An unknown error occurred.\"))},this))}},updateElementsIfSearchTextChanged:function(){this.searchText!==(this.searchText=this.searching?this.$search.val():null)&&this.updateElements()},showActionTriggers:function(){this.showingActionTriggers||(this.$toolbar.css(\"min-height\",this.$toolbar.height()),this._$detachedToolbarItems=this.$toolbarFlexContainer.children().not(this.$selectAllContainer).not(this.$mainSpinner),this._$detachedToolbarItems.detach(),this._$triggers?this._$triggers.insertAfter(this.$selectAllContainer):this._createTriggers(),this.showingActionTriggers=!0)},submitAction:function(t,e){var i=this.view.getSelectedElementIds();if(0!==i.length){for(var s,n=0;n<this.actions.length;n++)if(this.actions[n].type===t){s=this.actions[n];break}if(s&&(!s.confirm||confirm(s.confirm))){var a=this.getViewParams(),r=$.extend(a,e,{elementAction:t,elementIds:i});this.setIndexBusy(),this._autoSelectElements=i,Craft.postActionRequest(this.settings.submitActionsAction,r,$.proxy(function(t,e){this.setIndexAvailable(),\"success\"===e&&(t.success?(this._updateView(a,t),t.message&&Craft.cp.displayNotice(t.message),this.afterAction(s,r)):Craft.cp.displayError(t.message))},this))}}},afterAction:function(t,e){Craft.cp.runQueue(),this.onAfterAction(t,e)},hideActionTriggers:function(){this.showingActionTriggers&&(this._$detachedToolbarItems.insertBefore(this.$mainSpinner),this._$triggers.detach(),this.$toolbarFlexContainer.children().not(this.$selectAllContainer).removeClass(\"hidden\"),this.$toolbar.css(\"min-height\",\"\"),this.showingActionTriggers=!1)},updateActionTriggers:function(){if(this.actions){var t=this.view.getSelectedElements().length;0!==t?(t===this.view.getEnabledElements().length?(this.$selectAllCheckbox.removeClass(\"indeterminate\"),this.$selectAllCheckbox.addClass(\"checked\"),this.$selectAllBtn.attr(\"aria-checked\",\"true\")):(this.$selectAllCheckbox.addClass(\"indeterminate\"),this.$selectAllCheckbox.removeClass(\"checked\"),this.$selectAllBtn.attr(\"aria-checked\",\"mixed\")),this.showActionTriggers()):(this.$selectAllCheckbox.removeClass(\"indeterminate checked\"),this.$selectAllBtn.attr(\"aria-checked\",\"false\"),this.hideActionTriggers())}},getSelectedElements:function(){return this.view?this.view.getSelectedElements():$()},getSelectedElementIds:function(){return this.view?this.view.getSelectedElementIds():[]},getSortAttributeOption:function(t){return this.$sortAttributesList.find('a[data-attr=\"'+t+'\"]:first')},getSelectedSortAttribute:function(){return this.$sortAttributesList.find(\"a.sel:first\").data(\"attr\")},setSortAttribute:function(t){var e=this.getSortAttributeOption(t);if(e.length){this.$sortAttributesList.find(\"a.sel\").removeClass(\"sel\"),e.addClass(\"sel\");var i=e.text();this.$sortMenuBtn.attr(\"title\",Craft.t(\"app\",\"Sort by {attribute}\",{attribute:i})),this.$sortMenuBtn.text(i),this.setSortDirection(\"score\"===t?\"desc\":\"asc\"),\"structure\"===t?this.$sortDirectionsList.find(\"a\").addClass(\"disabled\"):this.$sortDirectionsList.find(\"a\").removeClass(\"disabled\")}},getSortDirectionOption:function(t){return this.$sortDirectionsList.find(\"a[data-dir=\"+t+\"]:first\")},getSelectedSortDirection:function(){return this.$sortDirectionsList.find(\"a.sel:first\").data(\"dir\")},getSelectedViewMode:function(){return this.getSelectedSourceState(\"mode\")},setSortDirection:function(t){\"desc\"!==t&&(t=\"asc\"),this.$sortMenuBtn.attr(\"data-icon\",t),this.$sortDirectionsList.find(\"a.sel\").removeClass(\"sel\"),this.getSortDirectionOption(t).addClass(\"sel\")},getSourceByKey:function(t){return void 0===this.sourcesByKey[t]?null:this.sourcesByKey[t]},selectSource:function(t){if(!t||!t.length)return!1;if(this.$source&&this.$source[0]&&this.$source[0]===t[0]&&t.data(\"key\")===this.sourceKey)return!1;if(this.hideActionTriggers(),this.$source=t,this.sourceKey=t.data(\"key\"),this.setInstanceState(\"selectedSource\",this.sourceKey),this.sourceSelect.selectItem(t),Craft.cp.updateSidebarMenuLabel(),this.searching&&(this.searchText=null,this.$search.val(\"\"),this.stopSearching()),Garnish.hasAttr(this.$source,\"data-has-structure\")?(this.$structureSortAttribute||(this.$structureSortAttribute=$('<li><a data-attr=\"structure\">'+Craft.t(\"app\",\"Structure\")+\"</a></li>\"),this.sortMenu.addOptions(this.$structureSortAttribute.children())),this.$structureSortAttribute.prependTo(this.$sortAttributesList)):this.$structureSortAttribute&&this.$structureSortAttribute.removeClass(\"sel\").detach(),this.setStoredSortOptionsForSource(),this.$statusMenuBtn.length&&(Garnish.hasAttr(this.$source,\"data-override-status\")?this.$statusMenuContainer.addClass(\"hidden\"):this.$statusMenuContainer.removeClass(\"hidden\")),this.$viewModeBtnContainer&&this.$viewModeBtnContainer.remove(),this.viewModeBtns={},this.viewMode=null,this.sourceViewModes=this.getViewModesForSource(),1<this.sourceViewModes.length){this.$viewModeBtnContainer=$('<div class=\"btngroup\"/>').insertBefore(this.$mainSpinner);for(var e=0;e<this.sourceViewModes.length;e++){var i=this.sourceViewModes[e],s=$('<div data-view=\"'+i.mode+'\" role=\"button\" class=\"btn'+(void 0!==i.className?\" \"+i.className:\"\")+'\" title=\"'+i.title+'\"'+(void 0!==i.icon?' data-icon=\"'+i.icon+'\"':\"\")+\"/>\").appendTo(this.$viewModeBtnContainer);this.viewModeBtns[i.mode]=s,this.addListener(s,\"click\",{mode:i.mode},function(t){this.selectViewMode(t.data.mode),this.updateElements()})}}var n=this.getSelectedViewMode();return n&&this.doesSourceHaveViewMode(n)||(n=this.viewMode&&this.doesSourceHaveViewMode(this.viewMode)?this.viewMode:this.sourceViewModes[0].mode),this.selectViewMode(n),this.onSelectSource(),!0},selectSourceByKey:function(t){var e=this.getSourceByKey(t);return!!e&&this.selectSource(e)},setStoredSortOptionsForSource:function(){var t=this.getSelectedSourceState(\"order\"),e=this.getSelectedSourceState(\"sort\");t&&e||(t=this.getDefaultSort(),Garnish.isArray(t)&&(e=t[1],t=t[0])),\"asc\"!==e&&\"desc\"!==e&&(e=\"asc\"),this.setSortAttribute(t),this.setSortDirection(e)},getDefaultSort:function(){return this.$source&&Garnish.hasAttr(this.$source,\"data-default-sort\")?this.$source.attr(\"data-default-sort\").split(\":\"):[this.$sortAttributesList.find(\"a:first\").data(\"attr\"),\"asc\"]},getViewModesForSource:function(){var t=[{mode:\"table\",title:Craft.t(\"app\",\"Display in a table\"),icon:\"list\"}];return this.$source&&Garnish.hasAttr(this.$source,\"data-has-thumbs\")&&t.push({mode:\"thumbs\",title:Craft.t(\"app\",\"Display as thumbnails\"),icon:\"grid\"}),t},doesSourceHaveViewMode:function(t){for(var e=0;e<this.sourceViewModes.length;e++)if(this.sourceViewModes[e].mode===t)return!0;return!1},selectViewMode:function(t,e){e||this.doesSourceHaveViewMode(t)||(t=this.sourceViewModes[0].mode),t!==this.viewMode&&(this.viewMode&&void 0!==this.viewModeBtns[this.viewMode]&&this.viewModeBtns[this.viewMode].removeClass(\"active\"),this.viewMode=t,this.setSelecetedSourceState(\"mode\",this.viewMode),void 0!==this.viewModeBtns[this.viewMode]&&this.viewModeBtns[this.viewMode].addClass(\"active\"))},createView:function(t,e){return new(this.getViewClass(t))(this,this.$elements,e)},getViewClass:function(t){switch(t){case\"table\":return Craft.TableElementIndexView;case\"thumbs\":return Craft.ThumbsElementIndexView;default:throw'View mode\u00a0\"'+t+'\" not supported.'}},rememberDisabledElementId:function(t){-1===$.inArray(t,this.settings.disabledElementIds)&&this.settings.disabledElementIds.push(t)},forgetDisabledElementId:function(t){var e=$.inArray(t,this.settings.disabledElementIds);-1!==e&&this.settings.disabledElementIds.splice(e,1)},enableElements:function(t){t.removeClass(\"disabled\").parents(\".disabled\").removeClass(\"disabled\");for(var e=0;e<t.length;e++){var i=$(t[e]).data(\"id\");this.forgetDisabledElementId(i)}this.onEnableElements(t)},disableElements:function(t){t.removeClass(\"sel\").addClass(\"disabled\");for(var e=0;e<t.length;e++){var i=$(t[e]).data(\"id\");this.rememberDisabledElementId(i)}this.onDisableElements(t)},getElementById:function(t){return this.view.getElementById(t)},enableElementsById:function(t){t=$.makeArray(t);for(var e=0;e<t.length;e++){var i=t[e],s=this.getElementById(i);s&&s.length?this.enableElements(s):this.forgetDisabledElementId(i)}},disableElementsById:function(t){t=$.makeArray(t);for(var e=0;e<t.length;e++){var i=t[e],s=this.getElementById(i);s&&s.length?this.disableElements(s):this.rememberDisabledElementId(i)}},selectElementAfterUpdate:function(t){null===this._autoSelectElements&&(this._autoSelectElements=[]),this._autoSelectElements.push(t)},addButton:function(t){this.getButtonContainer().append(t)},isShowingSidebar:function(){return null===this.showingSidebar&&(this.showingSidebar=this.$sidebar.length&&!this.$sidebar.hasClass(\"hidden\")),this.showingSidebar},getButtonContainer:function(){if(this.settings.buttonContainer)return $(this.settings.buttonContainer);var t=$(\"#button-container\");return t.length||(t=$('<div id=\"button-container\"/>').appendTo(Craft.cp.$header)),t},setIndexBusy:function(){this.$mainSpinner.removeClass(\"invisible\"),this.isIndexBusy=!0},setIndexAvailable:function(){this.$mainSpinner.addClass(\"invisible\"),this.isIndexBusy=!1},createCustomizeSourcesModal:function(){var t=new Craft.CustomizeSourcesModal(this,{onHide:function(){t.destroy()}});return t},disable:function(){this.sourceSelect&&this.sourceSelect.disable(),this.view&&this.view.disable(),this.base()},enable:function(){this.sourceSelect&&this.sourceSelect.enable(),this.view&&this.view.enable(),this.base()},onAfterInit:function(){this.settings.onAfterInit(),this.trigger(\"afterInit\")},onSelectSource:function(){this.settings.onSelectSource(this.sourceKey),this.trigger(\"selectSource\",{sourceKey:this.sourceKey})},onSelectSite:function(){this.settings.onSelectSite(this.siteId),this.trigger(\"selectSite\",{siteId:this.siteId})},onUpdateElements:function(){this.settings.onUpdateElements(),this.trigger(\"updateElements\")},onSelectionChange:function(){this.settings.onSelectionChange(),this.trigger(\"selectionChange\")},onEnableElements:function(t){this.settings.onEnableElements(t),this.trigger(\"enableElements\",{elements:t})},onDisableElements:function(t){this.settings.onDisableElements(t),this.trigger(\"disableElements\",{elements:t})},onAfterAction:function(t,e){this.settings.onAfterAction(t,e),this.trigger(\"afterAction\",{action:t,params:e})},_handleSourceSelectionChange:function(){this.sourceSelect.totalSelected?this.selectSource(this.sourceSelect.$selectedItems)&&this.updateElements():this.sourceSelect.selectItem(this.$visibleSources.first())},_handleActionTriggerSubmit:function(t){t.preventDefault();var e=$(t.currentTarget);if(!e.hasClass(\"disabled\")&&!e.data(\"custom-handler\")){var i=e.data(\"action\"),s=Garnish.getPostData(e);this.submitAction(i,s)}},_handleMenuActionTriggerSubmit:function(t){var e=$(t.option);if(!e.hasClass(\"disabled\")&&!e.data(\"custom-handler\")){var i=e.data(\"action\");this.submitAction(i)}},_handleStatusChange:function(t){this.statusMenu.$options.removeClass(\"sel\");var e=$(t.selectedOption).addClass(\"sel\");this.$statusMenuBtn.html(e.html()),this.trashed=!1,this.drafts=!1,this.status=null,Garnish.hasAttr(e,\"data-trashed\")?this.trashed=!0:Garnish.hasAttr(e,\"data-drafts\")?this.drafts=!0:this.status=e.data(\"status\"),this._updateStructureSortOption(),this.updateElements()},_handleSiteChange:function(t){this.siteMenu.$options.removeClass(\"sel\");var e=$(t.selectedOption).addClass(\"sel\");this.$siteMenuBtn.html(e.html()),this._setSite(e.data(\"site-id\")),this.onSelectSite()},_setSite:function(t){var e,i;this.siteId=t,this.$visibleSources=$();for(var s=!1,n=0;n<this.$sources.length;n++)void 0===(i=this.$sources.eq(n)).data(\"sites\")||-1!==i.data(\"sites\").toString().split(\",\").indexOf(t.toString())?(i.parent().removeClass(\"hidden\"),this.$visibleSources=this.$visibleSources.add(i),e||(e=i)):(i.parent().addClass(\"hidden\"),this.$source&&this.$source.get(0)==i.get(0)&&(s=!0));s&&this.selectSource(e);var a,r=this.getSourceContainer().children(\".heading\");for(n=0;n<r.length;n++)0!==(a=r.eq(n)).nextUntil(\".heading\",\":not(.hidden)\").length?a.removeClass(\"hidden\"):a.addClass(\"hidden\");this.initialized&&(Craft.setLocalStorage(\"BaseElementIndex.siteId\",t),this.updateElements())},_handleSortChange:function(t){var e=$(t.selectedOption);e.hasClass(\"disabled\")||e.hasClass(\"sel\")||(e.parent().parent().is(this.$sortAttributesList)?this.setSortAttribute(e.data(\"attr\")):this.setSortDirection(e.data(\"dir\")),this.storeSortAttributeAndDirection(),this.updateElements())},_handleSelectionChange:function(){this.updateActionTriggers(),this.onSelectionChange()},_handleSourceDblClick:function(t){this._toggleSource($(t.currentTarget)),t.stopPropagation()},_handleSourceToggleClick:function(t){this._toggleSource($(t.currentTarget).prev(\"a\")),t.stopPropagation()},_updateStructureSortOption:function(){var t=this.getSortAttributeOption(\"structure\");if(t.length)if(this.trashed||this.drafts||this.searching){if(t.addClass(\"disabled\"),\"structure\"===this.getSelectedSortAttribute()){var e=this.$sortAttributesList.find(\"a:not(.disabled):first\");this.setSortAttribute(e.data(\"attr\")),this.setSortDirection(\"asc\")}}else t.removeClass(\"disabled\"),this.setStoredSortOptionsForSource()},_getSourcesInList:function(t){return t.children(\"li\").children(\"a\")},_getChildSources:function(t){var e=t.siblings(\"ul\");return this._getSourcesInList(e)},_getSourceToggle:function(t){return t.siblings(\".toggle\")},_initSources:function(t){for(var e=0;e<t.length;e++)this.initSource($(t[e]))},_deinitSources:function(t){for(var e=0;e<t.length;e++)this.deinitSource($(t[e]))},_toggleSource:function(t){t.parent(\"li\").hasClass(\"expanded\")?this._collapseSource(t):this._expandSource(t)},_expandSource:function(t){t.parent(\"li\").addClass(\"expanded\");var e=this._getChildSources(t);this._initSources(e);var i=t.data(\"key\");-1===this.instanceState.expandedSources.indexOf(i)&&(this.instanceState.expandedSources.push(i),this.storeInstanceState())},_collapseSource:function(t){t.parent(\"li\").removeClass(\"expanded\");var e=this._getChildSources(t);this._deinitSources(e);var i=this.instanceState.expandedSources.indexOf(t.data(\"key\"));-1!==i&&(this.instanceState.expandedSources.splice(i,1),this.storeInstanceState())},_isViewPaginated:function(){return\"index\"===this.settings.context&&\"structure\"!==this.getSelectedSortAttribute()},_updateView:function(t,e){if(this.actions&&(this.hideActionTriggers(),this.actions=this.actionsHeadHtml=this.actionsFootHtml=this._$triggers=null),this.$selectAllContainer&&this.$selectAllContainer.detach(),this.$countContainer.html(\"\"),!this._isViewPaginated()||e.count<=this.settings.batchSize)this.$countContainer.text(e.countLabel);else{var i=$('<div class=\"flex pagination\"/>').appendTo(this.$countContainer),s=Math.max(Math.ceil(e.count/this.settings.batchSize),1),n=$(\"<div/>\",{class:\"page-link\"+(1<this.page?\"\":\" disabled\"),\"data-icon\":\"leftangle\",title:Craft.t(\"app\",\"Previous Page\")}).appendTo(i),a=$(\"<div/>\",{class:\"page-link\"+(this.page<s?\"\":\" disabled\"),\"data-icon\":\"rightangle\",title:Craft.t(\"app\",\"Next Page\")}).appendTo(i);$(\"<div/>\",{class:\"page-info\",text:e.countLabel}).appendTo(i),1<this.page&&this.addListener(n,\"click\",function(){this.removeListener(n,\"click\"),this.removeListener(a,\"click\"),this.setPage(this.page-1),this.updateElements(!0)}),this.page<s&&this.addListener(a,\"click\",function(){this.removeListener(n,\"click\"),this.removeListener(a,\"click\"),this.setPage(this.page+1),this.updateElements(!0)})}e.actions&&e.actions.length&&(this.actions=e.actions,this.actionsHeadHtml=e.actionsHeadHtml,this.actionsFootHtml=e.actionsFootHtml,this.$selectAllContainer?(this.$selectAllCheckbox.removeClass(\"indeterminate checked\"),this.$selectAllBtn.attr(\"aria-checked\",\"false\")):(this.$selectAllContainer=$('<div class=\"selectallcontainer\"/>'),this.$selectAllBtn=$('<div class=\"btn\"/>').appendTo(this.$selectAllContainer),this.$selectAllCheckbox=$('<div class=\"checkbox\"/>').appendTo(this.$selectAllBtn),this.$selectAllBtn.attr({role:\"checkbox\",tabindex:\"0\",\"aria-checked\":\"false\"}),this.addListener(this.$selectAllBtn,\"click\",function(){0===this.view.getSelectedElements().length?this.view.selectAllElements():this.view.deselectAllElements()}),this.addListener(this.$selectAllBtn,\"keydown\",function(t){t.keyCode===Garnish.SPACE_KEY&&(t.preventDefault(),$(t.currentTarget).trigger(\"click\"))})),this.$selectAllContainer.prependTo(this.$toolbarFlexContainer)),this.$elements.html(e.html),Craft.appendHeadHtml(e.headHtml),Craft.appendFootHtml(e.footHtml);var r=this.actions||this.settings.selectable;if(this.view=this.createView(this.getSelectedViewMode(),{context:this.settings.context,batchSize:\"index\"!==this.settings.context||\"structure\"===this.getSelectedSortAttribute()?this.settings.batchSize:null,params:t,selectable:r,multiSelect:this.actions||this.settings.multiSelect,checkboxMode:!!this.actions,onSelectionChange:$.proxy(this,\"_handleSelectionChange\")}),this._autoSelectElements){if(r)for(var o=0;o<this._autoSelectElements.length;o++)this.view.selectElementById(this._autoSelectElements[o]);this._autoSelectElements=null}this.onUpdateElements()},_createTriggers:function(){var t,e,i=[],s=[],n=[];for(t=0;t<this.actions.length;t++){var a=this.actions[t];if(a.trigger){var r=$('<form id=\"'+Craft.formatInputId(a.type)+'-actiontrigger\"/>').data(\"action\",a.type).append(a.trigger);this.addListener(r,\"submit\",\"_handleActionTriggerSubmit\"),i.push(r)}else a.destructive?n.push(a):s.push(a)}if(s.length||n.length){var o=$(\"<form/>\");e=$('<div class=\"btn menubtn\" data-icon=\"settings\" title=\"'+Craft.t(\"app\",\"Actions\")+'\"/>').appendTo(o);var l=$('<ul class=\"menu\"/>').appendTo(o),h=this._createMenuTriggerList(s,!1),d=this._createMenuTriggerList(n,!0);h&&h.appendTo(l),h&&d&&$(\"<hr/>\").appendTo(l),d&&d.appendTo(l),i.push(o)}for(this._$triggers=$(),t=0;t<i.length;t++){var c=$(\"<div/>\").append(i[t]);this._$triggers=this._$triggers.add(c)}this._$triggers.insertAfter(this.$selectAllContainer),Craft.appendHeadHtml(this.actionsHeadHtml),Craft.appendFootHtml(this.actionsFootHtml),Craft.initUiElements(this._$triggers),e&&e.data(\"menubtn\").on(\"optionSelect\",$.proxy(this,\"_handleMenuActionTriggerSubmit\"))},_showExportHud:function(){this.$exportBtn.addClass(\"active\");var t=$(\"<form/>\",{class:\"export-form\"}),s=Craft.ui.createTextField({label:Craft.t(\"app\",\"Limit\"),placeholder:Craft.t(\"app\",\"No limit\"),type:\"number\",min:1}).appendTo(t);$(\"<input/>\",{type:\"submit\",class:\"btn submit fullwidth\",value:Craft.t(\"app\",\"Export\")}).appendTo(t);var n=$(\"<div/>\",{class:\"spinner hidden\"}).appendTo(t);new Garnish.HUD(this.$exportBtn,t).on(\"hide\",$.proxy(function(){this.$exportBtn.removeClass(\"active\")},this));var a=!1;this.addListener(t,\"submit\",function(t){if(t.preventDefault(),!a){a=!0,n.removeClass(\"hidden\");var e=this.getViewParams();delete e.criteria.limit;var i=parseInt(s.find(\"input\").val());i&&!isNaN(i)&&(e.criteria.limit=i),Craft.postActionRequest(\"element-indexes/create-export-token\",e,$.proxy(function(t,e){if(a=!1,n.addClass(\"hidden\"),\"success\"===e){var i={};i[Craft.tokenParam]=t.token;var s=Craft.getCpUrl(\"\",i);document.location.href=s}else Craft.cp.displayError(Craft.t(\"app\",\"An unknown error occurred.\"))},this))}})},_createMenuTriggerList:function(t,e){if(t&&t.length){for(var i=$(\"<ul/>\"),s=0;s<t.length;s++){var n=t[s].type;$(\"<li/>\").append($(\"<a/>\",{id:Craft.formatInputId(n)+\"-actiontrigger\",class:e?\"error\":null,\"data-action\":n,text:t[s].name})).appendTo(i)}return i}}},{defaults:{context:\"index\",modal:null,storageKey:null,criteria:null,batchSize:50,disabledElementIds:[],selectable:!1,multiSelect:!1,buttonContainer:null,hideSidebar:!1,refreshSourcesAction:\"element-indexes/get-source-tree-html\",updateElementsAction:\"element-indexes/get-elements\",submitActionsAction:\"element-indexes/perform-action\",toolbarFixed:null,onAfterInit:$.noop,onSelectSource:$.noop,onSelectSite:$.noop,onUpdateElements:$.noop,onSelectionChange:$.noop,onEnableElements:$.noop,onDisableElements:$.noop,onAfterAction:$.noop}}),Craft.BaseElementIndexView=Garnish.Base.extend({$container:null,$loadingMoreSpinner:null,$elementContainer:null,$scroller:null,elementIndex:null,thumbLoader:null,elementSelect:null,loadingMore:!1,_totalVisible:null,_morePending:null,_handleEnableElements:null,_handleDisableElements:null,init:function(t,e,i){this.elementIndex=t,this.$container=$(e),this.setSettings(i,Craft.BaseElementIndexView.defaults),this.$loadingMoreSpinner=$('<div class=\"centeralign hidden\"><div class=\"spinner loadingmore\"></div></div>').insertAfter(this.$container),this.$elementContainer=this.getElementContainer();var s=this.$elementContainer.children();this.setTotalVisible(s.length),this.setMorePending(this.settings.batchSize&&s.length==this.settings.batchSize),this.thumbLoader=new Craft.ElementThumbLoader,this.thumbLoader.load(s),this.settings.selectable&&(this.elementSelect=new Garnish.Select(this.$elementContainer,s.filter(\":not(.disabled)\"),{multi:this.settings.multiSelect,vertical:this.isVerticalList(),handle:\"index\"===this.settings.context?\".checkbox, .element:first\":null,filter:\":not(a):not(.toggle)\",checkboxMode:this.settings.checkboxMode,onSelectionChange:$.proxy(this,\"onSelectionChange\")}),this._handleEnableElements=$.proxy(function(t){this.elementSelect.addItems(t.elements)},this),this._handleDisableElements=$.proxy(function(t){this.elementSelect.removeItems(t.elements)},this),this.elementIndex.on(\"enableElements\",this._handleEnableElements),this.elementIndex.on(\"disableElements\",this._handleDisableElements)),\"index\"===this.settings.context&&(this._handleElementEditing=$.proxy(function(t){var e=$(t.target);if(\"A\"!==e.prop(\"nodeName\")){var i;if(e.hasClass(\"element\"))i=e;else if(!(i=e.closest(\".element\")).length)return;Garnish.hasAttr(i,\"data-editable\")&&this.createElementEditor(i)}},this),this.elementIndex.trashed||(this.addListener(this.$elementContainer,\"dblclick\",this._handleElementEditing),$.isTouchCapable()&&this.addListener(this.$elementContainer,\"taphold\",this._handleElementEditing))),this.afterInit(),this.settings.batchSize&&(\"index\"===this.settings.context?this.$scroller=Garnish.$scrollContainer:this.$scroller=this.elementIndex.$main,this.$scroller.scrollTop(0),this.addListener(this.$scroller,\"scroll\",\"maybeLoadMore\"),this.maybeLoadMore())},getElementContainer:function(){throw\"Classes that extend Craft.BaseElementIndexView must supply a getElementContainer() method.\"},afterInit:function(){},getAllElements:function(){return this.$elementContainer.children()},getEnabledElements:function(){return this.$elementContainer.children(\":not(.disabled)\")},getElementById:function(t){var e=this.$elementContainer.children('[data-id=\"'+t+'\"]:first');return e.length?e:null},getSelectedElements:function(){if(!this.elementSelect)throw\"This view is not selectable.\";return this.elementSelect.$selectedItems},getSelectedElementIds:function(){var t=this.getSelectedElements(),e=[];if(t)for(var i=0;i<t.length;i++)e.push(t.eq(i).data(\"id\"));return e},selectElement:function(t){if(!this.elementSelect)throw\"This view is not selectable.\";return this.elementSelect.selectItem(t,!0),!0},selectElementById:function(t){if(!this.elementSelect)throw\"This view is not selectable.\";var e=this.getElementById(t);return!!e&&(this.elementSelect.selectItem(e,!0),!0)},selectAllElements:function(){this.elementSelect.selectAll()},deselectAllElements:function(){this.elementSelect.deselectAll()},isVerticalList:function(){return!1},getTotalVisible:function(){return this._totalVisible},setTotalVisible:function(t){this._totalVisible=t},getMorePending:function(){return this._morePending},setMorePending:function(t){this._morePending=t},maybeLoadMore:function(){this.canLoadMore()&&this.loadMore()},canLoadMore:function(){if(!this.getMorePending()||!this.settings.batchSize)return!1;if(this.$scroller[0]!==Garnish.$win[0])return this.$scroller.prop(\"scrollHeight\")-this.$scroller.scrollTop()<=this.$scroller.outerHeight()+15;var t=Garnish.$win.innerHeight(),e=Garnish.$win.scrollTop();return this.$container.offset().top+this.$container.height()<=t+e},loadMore:function(){if(this.getMorePending()&&!this.loadingMore&&this.settings.batchSize){this.loadingMore=!0,this.$loadingMoreSpinner.removeClass(\"hidden\"),this.removeListener(this.$scroller,\"scroll\");var t=this.getLoadMoreParams();Craft.postActionRequest(this.settings.loadMoreElementsAction,t,$.proxy(function(t,e){if(this.loadingMore=!1,this.$loadingMoreSpinner.addClass(\"hidden\"),\"success\"===e){var i=$(t.html);this.appendElements(i),Craft.appendHeadHtml(t.headHtml),Craft.appendFootHtml(t.footHtml),this.elementSelect&&(this.elementSelect.addItems(i.filter(\":not(.disabled)\")),this.elementIndex.updateActionTriggers()),this.setTotalVisible(this.getTotalVisible()+i.length),this.setMorePending(i.length==this.settings.batchSize),this.addListener(this.$scroller,\"scroll\",\"maybeLoadMore\"),this.maybeLoadMore()}},this))}},getLoadMoreParams:function(){var t=$.extend(!0,{},this.settings.params);return t.criteria.offset=this.getTotalVisible(),t},appendElements:function(t){t.appendTo(this.$elementContainer),this.thumbLoader.load(t),this.onAppendElements(t)},onAppendElements:function(t){this.settings.onAppendElements(t),this.trigger(\"appendElements\",{newElements:t})},onSelectionChange:function(){this.settings.onSelectionChange(),this.trigger(\"selectionChange\")},createElementEditor:function(t){Craft.createElementEditor(t.data(\"type\"),t,{elementIndex:this.elementIndex})},disable:function(){this.elementSelect&&this.elementSelect.disable()},enable:function(){this.elementSelect&&this.elementSelect.enable()},destroy:function(){this.$loadingMoreSpinner.remove(),this.thumbLoader.destroy(),delete this.thumbLoader,this.elementSelect&&(this.elementIndex.off(\"enableElements\",this._handleEnableElements),this.elementIndex.off(\"disableElements\",this._handleDisableElements),this.elementSelect.destroy(),delete this.elementSelect),this.base()}},{defaults:{context:\"index\",batchSize:null,params:null,selectable:!1,multiSelect:!1,checkboxMode:!1,loadMoreElementsAction:\"element-indexes/get-more-elements\",onAppendElements:$.noop,onSelectionChange:$.noop}}),Craft.BaseElementSelectInput=Garnish.Base.extend({thumbLoader:null,elementSelect:null,elementSort:null,modal:null,elementEditor:null,$container:null,$elementsContainer:null,$elements:null,$addElementBtn:null,_initialized:!1,init:function(t){if(!$.isPlainObject(t)){for(var e={},i=[\"id\",\"name\",\"elementType\",\"sources\",\"criteria\",\"sourceElementId\",\"limit\",\"modalStorageKey\",\"fieldId\"],s=0;s<i.length&&void 0!==arguments[s];s++)e[i[s]]=arguments[s];t=e}this.setSettings(t,Craft.BaseElementSelectInput.defaults),this.settings.modalStorageKey&&(this.modalStorageKey=\"BaseElementSelectInput.\"+this.settings.modalStorageKey),1==this.settings.limit&&(this.settings.sortable=!1),this.$container=this.getContainer(),this.$container.data(\"elementSelect\",this),this.$elementsContainer=this.getElementsContainer(),this.$addElementBtn=this.getAddElementsBtn(),this.$addElementBtn&&1==this.settings.limit&&this.$addElementBtn.css(\"position\",\"absolute\").css(\"top\",0).css(Craft.left,0),this.thumbLoader=new Craft.ElementThumbLoader,this.initElementSelect(),this.initElementSort(),this.resetElements(),this.$addElementBtn&&this.addListener(this.$addElementBtn,\"activate\",\"showModal\"),this._initialized=!0},get totalSelected(){return this.$elements.length},getContainer:function(){return $(\"#\"+this.settings.id)},getElementsContainer:function(){return this.$container.children(\".elements\")},getElements:function(){return this.$elementsContainer.children()},getAddElementsBtn:function(){return this.$container.children(\".btn.add\")},initElementSelect:function(){this.settings.selectable&&(this.elementSelect=new Garnish.Select({multi:this.settings.sortable,filter:\":not(.delete)\"}))},initElementSort:function(){this.settings.sortable&&(this.elementSort=new Garnish.DragSort({container:this.$elementsContainer,filter:this.settings.selectable?$.proxy(function(){return this.elementSort.$targetItem.hasClass(\"sel\")?this.elementSelect.getSelectedItems():this.elementSort.$targetItem},this):null,ignoreHandleSelector:\".delete\",axis:this.getElementSortAxis(),collapseDraggees:!0,magnetStrength:4,helperLagBase:1.5,onSortChange:this.settings.selectable?$.proxy(function(){this.elementSelect.resetItemOrder()},this):null}))},getElementSortAxis:function(){return\"list\"===this.settings.viewMode?\"y\":null},canAddMoreElements:function(){return!this.settings.limit||this.$elements.length<this.settings.limit},updateAddElementsBtn:function(){this.canAddMoreElements()?this.enableAddElementsBtn():this.disableAddElementsBtn()},disableAddElementsBtn:function(){this.$addElementBtn&&!this.$addElementBtn.hasClass(\"disabled\")&&(this.$addElementBtn.addClass(\"disabled\"),1==this.settings.limit&&(this._initialized?this.$addElementBtn.velocity(\"fadeOut\",Craft.BaseElementSelectInput.ADD_FX_DURATION):this.$addElementBtn.hide()))},enableAddElementsBtn:function(){this.$addElementBtn&&this.$addElementBtn.hasClass(\"disabled\")&&(this.$addElementBtn.removeClass(\"disabled\"),1==this.settings.limit&&(this._initialized?this.$addElementBtn.velocity(\"fadeIn\",Craft.BaseElementSelectInput.REMOVE_FX_DURATION):this.$addElementBtn.show()))},resetElements:function(){null!==this.$elements?this.removeElements(this.$elements):this.$elements=$(),this.addElements(this.getElements())},addElements:function(t){this.thumbLoader.load(t),this.settings.selectable&&this.elementSelect.addItems(t),this.settings.sortable&&this.elementSort.addItems(t),this.settings.editable&&(this._handleShowElementEditor=$.proxy(function(t){var e=$(t.currentTarget);!Garnish.hasAttr(e,\"data-editable\")||e.hasClass(\"disabled\")||e.hasClass(\"loading\")||(this.elementEditor=this.createElementEditor(e))},this),this.addListener(t,\"dblclick\",this._handleShowElementEditor),$.isTouchCapable()&&this.addListener(t,\"taphold\",this._handleShowElementEditor)),t.find(\".delete\").on(\"click\",$.proxy(function(t){this.removeElement($(t.currentTarget).closest(\".element\"))},this)),this.$elements=this.$elements.add(t),this.updateAddElementsBtn()},createElementEditor:function(t,e){return e||(e={}),e.prevalidate=this.settings.prevalidate,Craft.createElementEditor(this.settings.elementType,t,e)},removeElements:function(t){if(this.settings.selectable&&this.elementSelect.removeItems(t),this.modal){for(var e=[],i=0;i<t.length;i++){var s=t.eq(i).data(\"id\");s&&e.push(s)}e.length&&this.modal.elementIndex.enableElementsById(e)}t.children(\"input\").prop(\"disabled\",!0),this.$elements=this.$elements.not(t),this.updateAddElementsBtn(),this.onRemoveElements()},removeElement:function(t){this.removeElements(t),this.animateElementAway(t,function(){t.remove()})},animateElementAway:function(t,e){t.css(\"z-index\",0);var i={opacity:-1};i[\"margin-\"+Craft.left]=-(t.outerWidth()+parseInt(t.css(\"margin-\"+Craft.right))),\"list\"!==this.settings.viewMode&&0!==this.$elements.length||(i[\"margin-bottom\"]=-(t.outerHeight()+parseInt(t.css(\"margin-bottom\")))),t.velocity(i,Craft.BaseElementSelectInput.REMOVE_FX_DURATION,e)},showModal:function(){this.canAddMoreElements()&&(this.modal?this.modal.show():this.modal=this.createModal())},createModal:function(){return Craft.createElementSelectorModal(this.settings.elementType,this.getModalSettings())},getModalSettings:function(){return $.extend({closeOtherModals:!1,storageKey:this.modalStorageKey,sources:this.settings.sources,criteria:this.settings.criteria,multiSelect:1!=this.settings.limit,showSiteMenu:this.settings.showSiteMenu,disabledElementIds:this.getDisabledElementIds(),onSelect:$.proxy(this,\"onModalSelect\")},this.settings.modalSettings)},getSelectedElementIds:function(){for(var t=[],e=0;e<this.$elements.length;e++)t.push(this.$elements.eq(e).data(\"id\"));return t},getDisabledElementIds:function(){var t=this.getSelectedElementIds();return this.settings.sourceElementId&&t.push(this.settings.sourceElementId),t},onModalSelect:function(t){if(this.settings.limit){var e=this.settings.limit-this.$elements.length;t.length>e&&(t=t.slice(0,e))}this.selectElements(t),this.updateDisabledElementsInModal()},selectElements:function(t){for(var e=0;e<t.length;e++){var i=t[e],s=this.createNewElement(i);this.appendElement(s),this.addElements(s),this.animateElementIntoPlace(i.$element,s)}this.onSelectElements(t)},createNewElement:function(t){var e=t.$element.clone();return Craft.setElementSize(e,\"large\"===this.settings.viewMode?\"large\":\"small\"),e.addClass(\"removable\"),e.prepend('<input type=\"hidden\" name=\"'+this.settings.name+'[]\" value=\"'+t.id+'\"><a class=\"delete icon\" title=\"'+Craft.t(\"app\",\"Remove\")+'\"></a>'),e},appendElement:function(t){t.appendTo(this.$elementsContainer)},animateElementIntoPlace:function(t,e){var i=t.offset(),s=e.offset(),n=e.clone().appendTo(Garnish.$bod);e.css(\"visibility\",\"hidden\"),n.css({position:\"absolute\",zIndex:1e4,top:i.top,left:i.left});var a={top:s.top,left:s.left};n.velocity(a,Craft.BaseElementSelectInput.ADD_FX_DURATION,function(){n.remove(),e.css(\"visibility\",\"visible\")})},updateDisabledElementsInModal:function(){this.modal.elementIndex&&this.modal.elementIndex.disableElementsById(this.getDisabledElementIds())},getElementById:function(t){for(var e=0;e<this.$elements.length;e++){var i=this.$elements.eq(e);if(i.data(\"id\")==t)return i}},onSelectElements:function(t){this.trigger(\"selectElements\",{elements:t}),this.settings.onSelectElements(t),window.draftEditor&&window.draftEditor.checkForm()},onRemoveElements:function(){this.trigger(\"removeElements\"),this.settings.onRemoveElements()}},{ADD_FX_DURATION:200,REMOVE_FX_DURATION:200,defaults:{id:null,name:null,fieldId:null,elementType:null,sources:null,criteria:{},sourceElementId:null,viewMode:\"list\",limit:null,showSiteMenu:!1,modalStorageKey:null,modalSettings:{},onSelectElements:$.noop,onRemoveElements:$.noop,sortable:!0,selectable:!0,editable:!0,prevalidate:!1,editorSettings:{}}}),Craft.BaseElementSelectorModal=Garnish.Modal.extend({elementType:null,elementIndex:null,$body:null,$selectBtn:null,$sidebar:null,$sources:null,$sourceToggles:null,$main:null,$search:null,$elements:null,$tbody:null,$primaryButtons:null,$secondaryButtons:null,$cancelBtn:null,$footerSpinner:null,init:function(t,e){this.elementType=t,this.setSettings(e,Craft.BaseElementSelectorModal.defaults);var i=$('<div class=\"modal elementselectormodal\"></div>').appendTo(Garnish.$bod),s=$('<div class=\"body\"><div class=\"spinner big\"></div></div>').appendTo(i),n=$('<div class=\"footer\"/>').appendTo(i);this.base(i,this.settings),this.$footerSpinner=$('<div class=\"spinner hidden\"/>').appendTo(n),this.$primaryButtons=$('<div class=\"buttons right\"/>').appendTo(n),this.$secondaryButtons=$('<div class=\"buttons left secondary-buttons\"/>').appendTo(n),this.$cancelBtn=$('<div class=\"btn\">'+Craft.t(\"app\",\"Cancel\")+\"</div>\").appendTo(this.$primaryButtons),this.$selectBtn=$('<div class=\"btn disabled submit\">'+Craft.t(\"app\",\"Select\")+\"</div>\").appendTo(this.$primaryButtons),this.$body=s,this.addListener(this.$cancelBtn,\"activate\",\"cancel\"),this.addListener(this.$selectBtn,\"activate\",\"selectElements\")},onFadeIn:function(){this.elementIndex?Garnish.isMobileBrowser(!0)||this.elementIndex.$search.trigger(\"focus\"):this._createElementIndex(),this.base()},onSelectionChange:function(){this.updateSelectBtnState()},updateSelectBtnState:function(){this.$selectBtn&&(this.elementIndex.getSelectedElements().length?this.enableSelectBtn():this.disableSelectBtn())},enableSelectBtn:function(){this.$selectBtn.removeClass(\"disabled\")},disableSelectBtn:function(){this.$selectBtn.addClass(\"disabled\")},enableCancelBtn:function(){this.$cancelBtn.removeClass(\"disabled\")},disableCancelBtn:function(){this.$cancelBtn.addClass(\"disabled\")},showFooterSpinner:function(){this.$footerSpinner.removeClass(\"hidden\")},hideFooterSpinner:function(){this.$footerSpinner.addClass(\"hidden\")},cancel:function(){this.$cancelBtn.hasClass(\"disabled\")||this.hide()},selectElements:function(){if(this.elementIndex&&this.elementIndex.getSelectedElements().length){this.elementIndex.view.elementSelect.clearMouseUpTimeout();var t=this.elementIndex.getSelectedElements(),e=this.getElementInfo(t);this.onSelect(e),this.settings.disableElementsOnSelect&&this.elementIndex.disableElements(this.elementIndex.getSelectedElements()),this.settings.hideOnSelect&&this.hide()}},getElementInfo:function(t){for(var e=[],i=0;i<t.length;i++){var s=$(t[i]),n=Craft.getElementInfo(s);e.push(n)}return e},show:function(){this.updateSelectBtnState(),this.base()},onSelect:function(t){this.settings.onSelect(t)},disable:function(){this.elementIndex&&this.elementIndex.disable(),this.base()},enable:function(){this.elementIndex&&this.elementIndex.enable(),this.base()},_createElementIndex:function(){var t={context:\"modal\",elementType:this.elementType,sources:this.settings.sources};null!==this.settings.showSiteMenu&&\"auto\"!==this.settings.showSiteMenu&&(t.showSiteMenu=this.settings.showSiteMenu?\"1\":\"0\"),Craft.postActionRequest(\"elements/get-modal-body\",t,$.proxy(function(t,e){\"success\"===e&&(this.$body.html(t.html),this.$body.has(\".sidebar:not(.hidden)\").length&&this.$body.addClass(\"has-sidebar\"),this.elementIndex=Craft.createElementIndex(this.elementType,this.$body,{context:\"modal\",modal:this,storageKey:this.settings.storageKey,criteria:this.settings.criteria,disabledElementIds:this.settings.disabledElementIds,selectable:!0,multiSelect:this.settings.multiSelect,buttonContainer:this.$secondaryButtons,onSelectionChange:$.proxy(this,\"onSelectionChange\"),hideSidebar:this.settings.hideSidebar}),this.addListener(this.elementIndex.$elements,\"doubletap\",function(t,e){e.firstTap.target===e.secondTap.target&&this.selectElements()}))},this))}},{defaults:{resizable:!0,storageKey:null,sources:null,criteria:null,multiSelect:!1,showSiteMenu:null,disabledElementIds:[],disableElementsOnSelect:!1,hideOnSelect:!0,onCancel:$.noop,onSelect:$.noop,hideIndexSidebar:!1}}),Craft.BaseInputGenerator=Garnish.Base.extend({$source:null,$target:null,$form:null,settings:null,listening:null,timeout:null,init:function(t,e,i){this.$source=$(t),this.$target=$(e),this.$form=this.$source.closest(\"form\"),this.setSettings(i),this.startListening()},setNewSource:function(t){var e=this.listening;this.stopListening(),this.$source=$(t),e&&this.startListening()},startListening:function(){this.listening||(this.listening=!0,this.addListener(this.$source,\"textchange\",\"onSourceTextChange\"),this.addListener(this.$target,\"textchange\",\"onTargetTextChange\"),this.addListener(this.$form,\"submit\",\"onFormSubmit\"))},stopListening:function(){this.listening&&(this.listening=!1,this.timeout&&clearTimeout(this.timeout),this.removeAllListeners(this.$source),this.removeAllListeners(this.$target),this.removeAllListeners(this.$form))},onSourceTextChange:function(){this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout($.proxy(this,\"updateTarget\"),250)},onTargetTextChange:function(){this.$target.get(0)===document.activeElement&&this.stopListening()},onFormSubmit:function(){this.timeout&&clearTimeout(this.timeout),this.updateTarget()},updateTarget:function(){var t=this.$source.val();if(void 0!==t){var e=this.generateTargetValue(t);this.$target.val(e),this.$target.trigger(\"change\"),this.$target.is(\":focus\")&&Craft.selectFullValue(this.$target)}},generateTargetValue:function(t){return t}}),Craft.AdminTable=Garnish.Base.extend({settings:null,totalItems:null,sorter:null,$noItems:null,$table:null,$tbody:null,$deleteBtns:null,init:function(t){this.setSettings(t,Craft.AdminTable.defaults),this.settings.allowDeleteAll||(this.settings.minItems=1),this.$noItems=$(this.settings.noItemsSelector),this.$table=$(this.settings.tableSelector),this.$tbody=this.$table.children(\"tbody\"),this.totalItems=this.$tbody.children().length,this.settings.sortable&&(this.sorter=new Craft.DataTableSorter(this.$table,{onSortChange:$.proxy(this,\"reorderItems\")})),this.$deleteBtns=this.$table.find(\".delete:not(.disabled)\"),this.addListener(this.$deleteBtns,\"click\",\"handleDeleteBtnClick\"),this.updateUI()},addRow:function(t){if(!(this.settings.maxItems&&this.totalItems>=this.settings.maxItems)){var e=$(t).appendTo(this.$tbody),i=e.find(\".delete\");this.settings.sortable&&this.sorter.addItems(e),this.$deleteBtns=this.$deleteBtns.add(i),this.addListener(i,\"click\",\"handleDeleteBtnClick\"),this.totalItems++,this.updateUI()}},reorderItems:function(){if(this.settings.sortable){for(var i=[],t=0;t<this.sorter.$items.length;t++){var e=$(this.sorter.$items[t]).attr(this.settings.idAttribute);i.push(e)}var s={ids:JSON.stringify(i)};Craft.postActionRequest(this.settings.reorderAction,s,$.proxy(function(t,e){\"success\"===e&&(t.success?(this.onReorderItems(i),Craft.cp.displayNotice(Craft.t(\"app\",this.settings.reorderSuccessMessage))):Craft.cp.displayError(Craft.t(\"app\",this.settings.reorderFailMessage)))},this))}},handleDeleteBtnClick:function(t){if(!(this.settings.minItems&&this.totalItems<=this.settings.minItems)){var e=$(t.target).closest(\"tr\");this.confirmDeleteItem(e)&&this.deleteItem(e)}},confirmDeleteItem:function(t){var e=this.getItemName(t);return confirm(Craft.t(\"app\",this.settings.confirmDeleteMessage,{name:e}))},deleteItem:function(i){var t={id:this.getItemId(i)};Craft.postActionRequest(this.settings.deleteAction,t,$.proxy(function(t,e){\"success\"===e&&this.handleDeleteItemResponse(t,i)},this))},handleDeleteItemResponse:function(t,e){var i=this.getItemId(e),s=this.getItemName(e);t.success?(this.sorter&&this.sorter.removeItems(e),e.remove(),this.totalItems--,this.updateUI(),this.onDeleteItem(i),Craft.cp.displayNotice(Craft.t(\"app\",this.settings.deleteSuccessMessage,{name:Craft.escapeHtml(s)}))):Craft.cp.displayError(Craft.t(\"app\",this.settings.deleteFailMessage,{name:Craft.escapeHtml(s)}))},onReorderItems:function(t){this.settings.onReorderItems(t)},onDeleteItem:function(t){this.settings.onDeleteItem(t)},getItemId:function(t){return t.attr(this.settings.idAttribute)},getItemName:function(t){return t.attr(this.settings.nameAttribute)},updateUI:function(){if(0===this.totalItems?(this.$table.hide(),this.$noItems.removeClass(\"hidden\")):(this.$table.show(),this.$noItems.addClass(\"hidden\")),this.settings.sortable){var t=this.$table.find(\".move\");1===this.totalItems?t.addClass(\"disabled\"):t.removeClass(\"disabled\")}this.settings.minItems&&this.totalItems<=this.settings.minItems?this.$deleteBtns.addClass(\"disabled\"):this.$deleteBtns.removeClass(\"disabled\"),this.settings.newItemBtnSelector&&(this.settings.maxItems&&this.totalItems>=this.settings.maxItems?$(this.settings.newItemBtnSelector).addClass(\"hidden\"):$(this.settings.newItemBtnSelector).removeClass(\"hidden\"))}},{defaults:{tableSelector:null,noItemsSelector:null,newItemBtnSelector:null,idAttribute:\"data-id\",nameAttribute:\"data-name\",sortable:!1,allowDeleteAll:!0,minItems:0,maxItems:null,reorderAction:null,deleteAction:null,reorderSuccessMessage:Craft.t(\"app\",\"New order saved.\"),reorderFailMessage:Craft.t(\"app\",\"Couldn\u2019t save new order.\"),confirmDeleteMessage:Craft.t(\"app\",\"Are you sure you want to delete \u201c{name}\u201d?\"),deleteSuccessMessage:Craft.t(\"app\",\"\u201c{name}\u201d deleted.\"),deleteFailMessage:Craft.t(\"app\",\"Couldn\u2019t delete \u201c{name}\u201d.\"),onReorderItems:$.noop,onDeleteItem:$.noop}}),Craft.AssetEditor=Craft.BaseElementEditor.extend({reloadIndex:!1,updateForm:function(t){if(this.base(t),this.$element.data(\"id\")){var e=this.$fieldsContainer.find(\"> .meta > .image-preview-container.editable\");e.length&&this.addListener(e,\"click\",\"showImageEditor\")}},showImageEditor:function(){new Craft.AssetImageEditor(this.$element.data(\"id\"),{onSave:function(){this.reloadIndex=!0,this.reloadForm()}.bind(this),allowDegreeFractions:Craft.isImagick})},onHideHud:function(){this.reloadIndex&&this.settings.elementIndex&&this.settings.elementIndex.updateElements(),this.base()}}),Craft.registerElementEditorClass(\"craft\\\\elements\\\\Asset\",Craft.AssetEditor),Craft.AssetImageEditor=Garnish.Modal.extend({$body:null,$footer:null,$imageTools:null,$buttons:null,$cancelBtn:null,$replaceBtn:null,$saveBtn:null,$editorContainer:null,$straighten:null,$croppingCanvas:null,$spinnerCanvas:null,canvas:null,image:null,viewport:null,focalPoint:null,grid:null,croppingCanvas:null,clipper:null,croppingRectangle:null,cropperHandles:null,cropperGrid:null,croppingShade:null,imageStraightenAngle:0,viewportRotation:0,originalWidth:0,originalHeight:0,imageVerticeCoords:null,zoomRatio:1,animationInProgress:!1,currentView:\"\",assetId:null,cacheBust:null,draggingCropper:!1,scalingCropper:!1,draggingFocal:!1,previousMouseX:0,previousMouseY:0,shiftKeyHeld:!1,editorHeight:0,editorWidth:0,cropperState:!1,scaleFactor:1,flipData:{},focalPointState:!1,croppingConstraint:!1,spinnerInterval:null,maxImageSize:null,lastLoadedDimensions:null,imageIsLoading:!1,renderImage:null,renderCropper:null,init:function(t,e){this.cacheBust=Date.now(),this.setSettings(e,Craft.AssetImageEditor.defaults),this.assetId=t,this.flipData={x:0,y:0},this.$container=$('<form class=\"modal fitted imageeditor\"></form>').appendTo(Garnish.$bod),this.$body=$('<div class=\"body\"></div>').appendTo(this.$container),this.$footer=$('<div class=\"footer\"/>').appendTo(this.$container),this.base(this.$container,this.settings),this.$buttons=$('<div class=\"buttons right\"/>').appendTo(this.$footer),this.$cancelBtn=$('<div class=\"btn cancel\">'+Craft.t(\"app\",\"Cancel\")+\"</div>\").appendTo(this.$buttons),this.$replaceBtn=$('<div class=\"btn submit save replace\">'+Craft.t(\"app\",\"Save\")+\"</div>\").appendTo(this.$buttons),this.settings.allowSavingAsNew&&(this.$saveBtn=$('<div class=\"btn submit save copy\">'+Craft.t(\"app\",\"Save as a new asset\")+\"</div>\").appendTo(this.$buttons),this.addListener(this.$saveBtn,\"activate\",this.saveImage.bind(this))),this.addListener(this.$replaceBtn,\"activate\",this.saveImage.bind(this)),this.addListener(this.$cancelBtn,\"activate\",$.proxy(this,\"hide\")),this.removeListener(this.$shade,\"click\"),this.maxImageSize=this.getMaxImageSize(),Craft.postActionRequest(\"assets/image-editor\",{assetId:t},$.proxy(this,\"loadEditor\"))},getMaxImageSize:function(){var t=Garnish.$doc.get(0).documentElement.clientWidth,e=Garnish.$doc.get(0).documentElement.clientHeight;return Math.max(e,t)*(1<window.devicePixelRatio?2:1)},loadEditor:function(r){r.html||alert(Craft.t(\"app\",\"Could not load the image editor.\")),this.$body.html(r.html),this.$tabs=$(\".tabs li\",this.$body),this.$viewsContainer=$(\".views\",this.$body),this.$views=$(\"> div\",this.$viewsContainer),this.$imageTools=$(\".image-container .image-tools\",this.$body),this.$editorContainer=$(\".image-container .image\",this.$body),this.editorHeight=this.$editorContainer.innerHeight(),this.editorWidth=this.$editorContainer.innerWidth(),this._showSpinner(),this.updateSizeAndPosition(),this.canvas=new fabric.StaticCanvas(\"image-canvas\"),this.$croppingCanvas=$(\"#cropping-canvas\",this.$editorContainer),this.$croppingCanvas.width(this.editorWidth),this.$croppingCanvas.height(this.editorHeight),this.canvas.enableRetinaScaling=!0,this.renderImage=function(){Garnish.requestAnimationFrame(this.canvas.renderAll.bind(this.canvas))}.bind(this);var t=Craft.getActionUrl(\"assets/edit-image\",{assetId:this.assetId,size:this.maxImageSize,cacheBust:this.cacheBust});fabric.Image.fromURL(t,$.proxy(function(t){this.image=t,this.image.set({originX:\"center\",originY:\"center\",left:this.editorWidth/2,top:this.editorHeight/2}),this.canvas.add(this.image),this.originalHeight=this.image.getHeight(),this.originalWidth=this.image.getWidth(),this.zoomRatio=1,this.lastLoadedDimensions=this.getScaledImageDimensions(),this._setFittedImageVerticeCoordinates(),this._repositionEditorElements();var e={imageDimensions:this.getScaledImageDimensions(),offsetX:0,offsetY:0},i=!1;if(r.focalPoint){var s=r.focalPoint,n=e.imageDimensions.width*s.x,a=e.imageDimensions.height*s.y;e.offsetX=n-e.imageDimensions.width/2,e.offsetY=a-e.imageDimensions.height/2,i=!0}this.storeFocalPointState(e),i&&this._createFocalPoint(),this._createViewport(),this.storeCropperState(),this._addControlListeners(),this.addListener(this.$croppingCanvas,\"mousemove\",this._handleMouseMove.bind(this)),this.addListener(this.$croppingCanvas,\"mousedown\",this._handleMouseDown.bind(this)),this.addListener(this.$croppingCanvas,\"mouseup\",this._handleMouseUp.bind(this)),this.addListener(this.$croppingCanvas,\"mouseout\",function(t){this._handleMouseUp(t),this._handleMouseMove(t)}.bind(this)),this._hideSpinner(),this.renderImage(),this.$tabs.first().trigger(\"click\")},this))},_reloadImage:function(){if(!this.imageIsLoading){this.imageIsLoading=!0,this.maxImageSize=this.getMaxImageSize();var t=Craft.getActionUrl(\"assets/edit-image\",{assetId:this.assetId,size:this.maxImageSize,cacheBust:this.cacheBust});this.image.setSrc(t,function(t){this.originalHeight=t.getHeight(),this.originalWidth=t.getWidth(),this.lastLoadedDimensions={width:this.originalHeight,height:this.originalWidth},this.updateSizeAndPosition(),this.renderImage(),this.imageIsLoading=!1}.bind(this))}},updateSizeAndPosition:function(){if(this.$container){var t=window.innerWidth,e=window.innerHeight;this.$container.css({width:t,\"min-width\":t,left:0,height:e,\"min-height\":e,top:0}),this.$body.css({height:e-58}),t<e?this.$container.addClass(\"vertical\"):this.$container.removeClass(\"vertical\"),this.$spinnerCanvas&&this.$spinnerCanvas.css({left:this.$spinnerCanvas.parent().width()/2-this.$spinnerCanvas.width()/2+\"px\",top:this.$spinnerCanvas.parent().height()/2-this.$spinnerCanvas.height()/2+\"px\"}),this.$editorContainer&&this.image&&this._repositionEditorElements()}},_repositionEditorElements:function(){var t={width:this.editorWidth,height:this.editorHeight};this.editorHeight=this.$editorContainer.innerHeight(),this.editorWidth=this.$editorContainer.innerWidth(),this.canvas.setDimensions({width:this.editorWidth,height:this.editorHeight});var e=this.getScaledImageDimensions();if(\"crop\"===this.currentView){this.zoomRatio=this.getZoomToFitRatio(this.getScaledImageDimensions());var i=this._getBoundingRectangle(this.imageVerticeCoords);this._setFittedImageVerticeCoordinates(),this._repositionCropper(i)}else this.zoomRatio=this.getZoomToCoverRatio(this.getScaledImageDimensions())*this.scaleFactor;this._repositionImage(t),this._repositionViewport(),this._repositionFocalPoint(t),this._zoomImage(),this.renderImage(),(1.5<e.width/this.lastLoadedDimensions.width||1.5<e.height/this.lastLoadedDimensions.height)&&this._reloadImage()},_repositionImage:function(t){this.image.set({left:this.image.left-(t.width-this.editorWidth)/2,top:this.image.top-(t.height-this.editorHeight)/2})},_createViewport:function(){this.viewport=new fabric.Rect({width:this.image.width,height:this.image.height,fill:\"rgba(127,0,0,1)\",originX:\"center\",originY:\"center\",globalCompositeOperation:\"destination-in\",left:this.image.left,top:this.image.top}),this.canvas.add(this.viewport),this.renderImage()},_createFocalPoint:function(){var t=this.focalPointState,e=this.getScaledImageDimensions().width/t.imageDimensions.width,i=t.offsetX*e*this.zoomRatio*this.scaleFactor,s=t.offsetY*e*this.zoomRatio*this.scaleFactor;i+=this.image.left,s+=this.image.top;var n=0,a=0;this.viewport&&0===t.offsetX&&0===t.offsetY&&(a=\"crop\"!==this.currentView?(n=this.viewport.left-this.image.left,this.viewport.top-this.image.top):(n=this.clipper.left-this.image.left,this.clipper.top-this.image.top),i+=n,s+=a,t.offsetX+=n/(e*this.zoomRatio*this.scaleFactor),t.offsetY+=a/(e*this.zoomRatio*this.scaleFactor)),this.focalPoint=new fabric.Group([new fabric.Circle({radius:8,fill:\"rgba(0,0,0,0.5)\",strokeWidth:2,stroke:\"rgba(255,255,255,0.8)\",left:0,top:0,originX:\"center\",originY:\"center\"}),new fabric.Circle({radius:1,fill:\"rgba(255,255,255,0)\",strokeWidth:2,stroke:\"rgba(255,255,255,0.8)\",left:0,top:0,originX:\"center\",originY:\"center\"})],{originX:\"center\",originY:\"center\",left:i,top:s}),this.storeFocalPointState(t),this.canvas.add(this.focalPoint)},toggleFocalPoint:function(){this.focalPoint?(this.canvas.remove(this.focalPoint),this.focalPoint=null):this._createFocalPoint(),this.renderImage()},_repositionViewport:function(){if(this.viewport){var t={left:this.editorWidth/2,top:this.editorHeight/2};if(\"crop\"===this.currentView)t.width=this.editorWidth,t.height=this.editorHeight;else if(this.cropperState){var e=this.cropperState,i=this.getScaledImageDimensions().width/e.imageDimensions.width;t.width=e.width*i*this.zoomRatio,t.height=e.height*i*this.zoomRatio,this.image.set({left:this.editorWidth/2-e.offsetX*i,top:this.editorHeight/2-e.offsetY*i})}else $.extend(t,this.getScaledImageDimensions());this.viewport.set(t)}},_repositionFocalPoint:function(t){if(this.focalPoint){var e=this.focalPoint.left-this.editorWidth/2,i=this.focalPoint.top-this.editorHeight/2,s=this.image.width,n=this.getScaledImageDimensions().width*this.zoomRatio/s/this.scaleFactor;e-=(t.width-this.editorWidth)/2,i-=(t.height-this.editorHeight)/2,e*=n,i*=n,this.focalPoint.set({left:this.editorWidth/2+e,top:this.editorHeight/2+i})}},hasOrientationChanged:function(){return this.viewportRotation%180!=0},getScaledImageDimensions:function(){var t=this.originalHeight/this.originalWidth,e={};return this.editorHeight/this.editorWidth<t?(e.height=Math.min(this.editorHeight,this.originalHeight),e.width=Math.round(this.originalWidth/(this.originalHeight/e.height))):(e.width=Math.min(this.editorWidth,this.originalWidth),e.height=Math.round(this.originalHeight*(e.width/this.originalWidth))),e},_zoomImage:function(){var t=this.getScaledImageDimensions();this.image.set({width:t.width*this.zoomRatio,height:t.height*this.zoomRatio})},_addControlListeners:function(){this.addListener(this.$tabs,\"click\",\"_handleTabClick\"),this.addListener($(\".focal-point\"),\"click\",function(t){this.toggleFocalPoint(t)}.bind(this)),this.addListener($(\".rotate-left\"),\"click\",function(){this.rotateImage(-90)}.bind(this)),this.addListener($(\".rotate-right\"),\"click\",function(){this.rotateImage(90)}.bind(this)),this.addListener($(\".flip-vertical\"),\"click\",function(){this.flipImage(\"y\")}.bind(this)),this.addListener($(\".flip-horizontal\"),\"click\",function(){this.flipImage(\"x\")}.bind(this)),this.straighteningInput=new Craft.SlideRuleInput(\"slide-rule\",{onStart:function(){this._showGrid()}.bind(this),onChange:function(t){this.straighten(t)}.bind(this),onEnd:function(){this._hideGrid(),this._cleanupFocalPointAfterStraighten()}.bind(this)}),this.addListener(Garnish.$doc,\"keydown\",function(t){t.keyCode===Garnish.SHIFT_KEY&&(this.shiftKeyHeld=!0)}.bind(this)),this.addListener(Garnish.$doc,\"keyup\",function(t){t.keyCode===Garnish.SHIFT_KEY&&(this.shiftKeyHeld=!1)}.bind(this)),new Garnish.MenuBtn($(\".crop .menubtn\",this.$container),{onOptionSelect:function(t){$(\".constraint\",this.$container).html($(t).html()),this.setCroppingConstraint($(t).data(\"constraint\")),this.enforceCroppingConstraint()}.bind(this)}).menu.$container.addClass(\"dark\")},_handleTabClick:function(t){if(!this.animationInProgress){var e=$(t.currentTarget),i=e.data(\"view\");this.$tabs.removeClass(\"selected\"),e.addClass(\"selected\"),this.showView(i)}},showView:function(t){this.currentView!==t&&(this.$views.addClass(\"hidden\"),this.$views.filter('[data-view=\"'+t+'\"]').removeClass(\"hidden\"),\"rotate\"===t?this.enableSlider():this.disableSlider(),this.updateSizeAndPosition(),\"crop\"===this.currentView&&\"crop\"!==t?this.disableCropMode():\"crop\"!==this.currentView&&\"crop\"===t&&this.enableCropMode(),this.currentView=t)},storeCropperState:function(t){if(t)this.cropperState=t;else if(this.clipper){var e=1/this.zoomRatio;this.cropperState={offsetX:(this.clipper.left-this.image.left)*e,offsetY:(this.clipper.top-this.image.top)*e,height:this.clipper.height*e,width:this.clipper.width*e,imageDimensions:this.getScaledImageDimensions()}}else{var i=this.getScaledImageDimensions();this.cropperState={offsetX:0,offsetY:0,height:i.height,width:i.width,imageDimensions:i}}},storeFocalPointState:function(t){if(t)this.focalPointState=t;else if(this.focalPoint){var e=1/this.zoomRatio;this.focalPointState={offsetX:(this.focalPoint.left-this.image.left)*e/this.scaleFactor,offsetY:(this.focalPoint.top-this.image.top)*e/this.scaleFactor,imageDimensions:this.getScaledImageDimensions()}}},rotateImage:function(e){if(!this.animationInProgress){if(90!==e&&-90!==e)return!1;this.animationInProgress=!0,this.viewportRotation+=e,this.viewportRotation=parseInt((this.viewportRotation+360)%360,10);var t,i=this.image.angle+e,s=this.getScaledImageDimensions();t=this.hasOrientationChanged()?this.getZoomToCoverRatio({height:s.width,width:s.height}):this.getZoomToCoverRatio(s),this.zoomRatio>t&&(t=this.zoomRatio);var n={angle:90===e?\"+=90\":\"-=90\"},a={angle:i,width:s.width*t,height:s.height*t},r=1;this.scaleFactor<1?(r=1/this.scaleFactor,this.scaleFactor=1):(this.viewport.width>this.editorHeight?r=this.editorHeight/this.viewport.width:this.viewport.height>this.editorWidth&&(r=this.editorWidth/this.viewport.height),this.scaleFactor=r),r<1&&(a.width*=r,a.height*=r);var o=this.cropperState,l=o.offsetX,h=o.offsetY,d=e*(Math.PI/180),c=l*Math.cos(d)-h*Math.sin(d),u=l*Math.sin(d)+h*Math.cos(d),p=s.width/o.imageDimensions.width,g=c*p*this.zoomRatio*this.scaleFactor,f=u*p*this.zoomRatio*this.scaleFactor;a.left=this.editorWidth/2-g,a.top=this.editorHeight/2-f,o.offsetX=c,o.offsetY=u;var m=o.width;o.width=o.height,o.height=m,this.storeCropperState(o),this.focalPoint&&this.canvas.remove(this.focalPoint),this.viewport.animate(n,{duration:this.settings.animationDuration,onComplete:function(){var t=this.viewport.height*r;this.viewport.height=this.viewport.width*r,this.viewport.width=t,this.viewport.set({angle:0})}.bind(this)}),this.image.animate(a,{onChange:this.canvas.renderAll.bind(this.canvas),duration:this.settings.animationDuration,onComplete:function(){var t=parseFloat((this.image.angle+360)%360);this.image.set({angle:t}),this.animationInProgress=!1,this.focalPoint?(this._adjustFocalPointByAngle(e),this.straighten(this.straighteningInput),this.canvas.add(this.focalPoint)):this._resetFocalPointPosition()}.bind(this)})}},flipImage:function(t){if(!this.animationInProgress){this.animationInProgress=!0,this.hasOrientationChanged()&&(t=\"y\"===t?\"x\":\"y\"),this.focalPoint?this.canvas.remove(this.focalPoint):this._resetFocalPointPosition();var e=this.editorWidth/2,i=this.editorHeight/2;this.straighteningInput.setValue(-this.imageStraightenAngle),this.imageStraightenAngle=-this.imageStraightenAngle;var s,n,a={angle:this.viewportRotation+this.imageStraightenAngle},r=this.cropperState,o=this.focalPointState;\"y\"===t&&this.hasOrientationChanged()||\"y\"!==t&&!this.hasOrientationChanged()?(r.offsetX=-r.offsetX,o.offsetX=-o.offsetX,n=this.image.left-e,a.left=e-n):(r.offsetY=-r.offsetY,o.offsetY=-o.offsetY,s=this.image.top-i,a.top=i-s),\"y\"===t?(a.scaleY=-1*this.image.scaleY,this.flipData.y=1-this.flipData.y):(a.scaleX=-1*this.image.scaleX,this.flipData.x=1-this.flipData.x),this.storeCropperState(r),this.storeFocalPointState(o),this.image.animate(a,{onChange:this.canvas.renderAll.bind(this.canvas),duration:this.settings.animationDuration,onComplete:function(){this.animationInProgress=!1,this.focalPoint&&(this._adjustFocalPointByAngle(0),this.canvas.add(this.focalPoint))}.bind(this)})}},straighten:function(t){if(!this.animationInProgress){this.animationInProgress=!0;var e=this.image.angle;this.imageStraightenAngle=(this.settings.allowDegreeFractions?parseFloat(t.value):Math.round(parseFloat(t.value)))%360,this.image.set({angle:this.viewportRotation+this.imageStraightenAngle}),this.zoomRatio=this.getZoomToCoverRatio(this.getScaledImageDimensions())*this.scaleFactor,this._zoomImage(),this.cropperState&&this._adjustEditorElementsOnStraighten(e),this.renderImage(),this.animationInProgress=!1}},_adjustEditorElementsOnStraighten:function(t){var e,i,s,n,a,r=this.getScaledImageDimensions(),o=this.image.angle-t,l=this.cropperState,h=this.zoomRatio,d=1;do{var c=l.offsetX,u=l.offsetY,p=o*(Math.PI/180);s=c*Math.cos(p)-u*Math.sin(p),n=c*Math.sin(p)+u*Math.cos(p),e=s*h*(a=r.width/l.imageDimensions.width),i=n*h*a;var g=this.getImageVerticeCoords(h),f={width:this.viewport.width,height:this.viewport.height,left:this.editorWidth/2-this.viewport.width/2+e,top:this.editorHeight/2-this.viewport.height/2+i};h*=d=this._getZoomRatioToFitRectangle(f,g)}while(1!==d);this.image.set({left:this.editorWidth/2-e,top:this.editorHeight/2-i}),l.offsetX=s,l.offsetY=n,l.width=this.viewport.width/h/a,l.height=this.viewport.height/h/a,this.storeCropperState(l),this.zoomRatio=h,this.focalPoint?(this._adjustFocalPointByAngle(o),this._isCenterInside(this.focalPoint,this.viewport)?this.focalPoint.set({opacity:1}):this.focalPoint.set({opacity:0})):0!=o&&this._resetFocalPointPosition(),this._zoomImage()},_cleanupFocalPointAfterStraighten:function(){if(this.focalPoint&&!this._isCenterInside(this.focalPoint,this.viewport)){this.focalPoint.set({opacity:1});var t=this.focalPointState;t.offsetX=0,t.offsetY=0,this.storeFocalPointState(t),this.toggleFocalPoint()}},_resetFocalPointPosition:function(){var t=this.focalPointState;t.offsetX=0,t.offsetY=0,this.storeFocalPointState(t)},_isCenterInside:function(t,e){return t.left>e.left-e.width/2&&t.top>e.top-e.height/2&&t.left<e.left+e.width/2&&t.top<e.top+e.height/2},_adjustFocalPointByAngle:function(t){var e=t*(Math.PI/180),i=this.focalPointState,s=i.offsetX,n=i.offsetY,a=s*Math.cos(e)-n*Math.sin(e),r=s*Math.sin(e)+n*Math.cos(e),o=this.getScaledImageDimensions().width/i.imageDimensions.width,l=a*o*this.zoomRatio,h=r*o*this.zoomRatio;this.focalPoint.left=this.image.left+l,this.focalPoint.top=this.image.top+h,i.offsetX=a,i.offsetY=r,this.storeFocalPointState(i)},_getZoomRatioToFitRectangle:function(t,e){for(var i,s,n=this._getRectangleVertices(t),a=0;a<n.length&&(i=n[a],this.arePointsInsideRectangle([i],e));a++)i=!1;if(i){var r=this._getEdgeCrossed(e,i),o=t.left+t.width/2,l=t.top+t.height/2,h=Math.abs((r[1].y-r[0].y)*i.x-(r[1].x-r[0].x)*i.y+r[1].x*r[0].y-r[1].y*r[0].x)/Math.sqrt(Math.pow(r[1].y-r[0].y,2)+Math.pow(r[1].x-r[0].x,2)),d=Math.abs((r[1].y-r[0].y)*o-(r[1].x-r[0].x)*l+r[1].x*r[0].y-r[1].y*r[0].x)/Math.sqrt(Math.pow(r[1].y-r[0].y,2)+Math.pow(r[1].x-r[0].x,2));s=(h+d)/d}else s=1;return s},saveImage:function(t){var e=$(t.currentTarget);if(e.hasClass(\"disabled\"))return!1;$(\".btn\",this.$buttons).addClass(\"disabled\"),this.$buttons.append('<div class=\"spinner\"></div>');var i={assetId:this.assetId,viewportRotation:this.viewportRotation,imageRotation:this.imageStraightenAngle,replace:e.hasClass(\"replace\")?1:0};if(this.cropperState){var s={};s.height=this.cropperState.height,s.width=this.cropperState.width,s.offsetX=this.cropperState.offsetX,s.offsetY=this.cropperState.offsetY,i.imageDimensions=this.cropperState.imageDimensions,i.cropData=s}else i.imageDimensions=this.getScaledImageDimensions();this.focalPoint&&(i.focalPoint=this.focalPointState),i.flipData=this.flipData,i.zoom=this.zoomRatio,Craft.postActionRequest(\"assets/save-image\",i,function(t){this.$buttons.find(\".btn\").removeClass(\"disabled\").end().find(\".spinner\").remove(),t.error?alert(t.error):(this.onSave(),this.hide(),Craft.cp.runQueue())}.bind(this))},getZoomToCoverRatio:function(t){var e=Math.abs(this.imageStraightenAngle)*(Math.PI/180),i=Math.sin(e)*t.height+Math.cos(e)*t.width,s=Math.sin(e)*t.width+Math.cos(e)*t.height;return Math.max(i/t.width,s/t.height)},getZoomToFitRatio:function(t){var e=this._getImageBoundingBox(t),i=1;if(e.height>this.editorHeight||e.width>this.editorWidth){var s=this.editorHeight/e.height,n=this.editorWidth/e.width;i=Math.min(n,s)}return i},getCombinedZoomRatio:function(t){return this.getZoomToCoverRatio(t)/this.getZoomToFitRatio(t)},_showGrid:function(){if(!this.grid){var t,e={strokeWidth:1,stroke:\"rgba(255,255,255,0.5)\"},i=this.viewport.width,s=this.viewport.height,n=i/9,a=s/9,r=[new fabric.Rect({strokeWidth:2,stroke:\"rgba(255,255,255,1)\",originX:\"center\",originY:\"center\",width:i,height:s,left:i/2,top:s/2,fill:\"rgba(255,255,255,0)\"})];for(t=1;t<=8;t++)r.push(new fabric.Line([t*n,0,t*n,s],e));for(t=1;t<=8;t++)r.push(new fabric.Line([0,t*a,i,t*a],e));this.grid=new fabric.Group(r,{left:this.editorWidth/2,top:this.editorHeight/2,originX:\"center\",originY:\"center\",angle:this.viewport.angle}),this.canvas.add(this.grid),this.renderImage()}},_hideGrid:function(){this.canvas.remove(this.grid),this.grid=null,this.renderImage()},onFadeOut:function(){this.removeListener(this.$croppingCanvas,\"mousemove\",this._handleMouseMove.bind(this)),this.removeListener(this.$croppingCanvas,\"mousedown\",this._handleMouseDown.bind(this)),this.removeListener(this.$croppingCanvas,\"mouseup\",this._handleMouseUp.bind(this)),this.removeListener(this.$croppingCanvas,\"mouseout\",function(t){this._handleMouseUp(t),this._handleMouseMove(t)}.bind(this)),this.destroy()},show:function(){this.base(),$(\"html\").addClass(\"noscroll\")},hide:function(){this.removeAllListeners(),this.straighteningInput.removeAllListeners(),$(\"html\").removeClass(\"noscroll\"),this.base()},onSave:function(){this.settings.onSave(),this.trigger(\"save\")},enableSlider:function(){this.$imageTools.removeClass(\"hidden\")},disableSlider:function(){this.$imageTools.addClass(\"hidden\")},enableCropMode:function(){var t=this.getScaledImageDimensions();this.zoomRatio=this.getZoomToFitRatio(t);var e={width:this.editorWidth,height:this.editorHeight},i={width:t.width*this.zoomRatio,height:t.height*this.zoomRatio,left:this.editorWidth/2,top:this.editorHeight/2},s=function(){this._setFittedImageVerticeCoordinates();var t=this.cropperState,e=this.getScaledImageDimensions(),i=e.width/t.imageDimensions.width,s={left:this.image.left+t.offsetX*i*this.zoomRatio,top:this.image.top+t.offsetY*i*this.zoomRatio,width:t.width*i*this.zoomRatio,height:t.height*i*this.zoomRatio};this._showCropper(s),this.focalPoint&&(i=e.width/this.focalPointState.imageDimensions.width,this.focalPoint.left=this.image.left+this.focalPointState.offsetX*i*this.zoomRatio,this.focalPoint.top=this.image.top+this.focalPointState.offsetY*i*this.zoomRatio,this.canvas.add(this.focalPoint))}.bind(this);this._editorModeTransition(s,i,e)},disableCropMode:function(){var t={},e={left:this.editorWidth/2,top:this.editorHeight/2};this._hideCropper();var i=this.getZoomToCoverRatio(this.getScaledImageDimensions())*this.scaleFactor,s=i/this.zoomRatio;this.zoomRatio=i;var n=(this.clipper.left-this.image.left)*s,a=(this.clipper.top-this.image.top)*s;e.left=this.editorWidth/2-n,e.top=this.editorHeight/2-a,t.height=this.clipper.height*s,t.width=this.clipper.width*s,this.focalPoint&&(!this.focalPoint||this._isCenterInside(this.focalPoint,this.clipper))||(this.focalPoint&&this.toggleFocalPoint(),this._resetFocalPointPosition());var r=function(){if(this.focalPoint){var t=this.getScaledImageDimensions().width/this.focalPointState.imageDimensions.width;this.focalPoint.left=this.image.left+this.focalPointState.offsetX*t*this.zoomRatio,this.focalPoint.top=this.image.top+this.focalPointState.offsetY*t*this.zoomRatio,this.canvas.add(this.focalPoint)}}.bind(this);this._editorModeTransition(r,e,t)},_editorModeTransition:function(t,e,i){this.animationInProgress||(this.animationInProgress=!0,this.focalPoint&&(this.canvas.remove(this.focalPoint),this.renderImage()),this.image.animate(e,{onChange:this.canvas.renderAll.bind(this.canvas),duration:this.settings.animationDuration,onComplete:function(){t(),this.animationInProgress=!1,this.renderImage()}.bind(this)}),this.viewport.animate(i,{duration:this.settings.animationDuration}))},_showSpinner:function(){this.$spinnerCanvas=$('<canvas id=\"spinner-canvas\"></canvas>').appendTo($(\".image\",this.$container));var i=document.getElementById(\"spinner-canvas\").getContext(\"2d\"),s=new Date,n=i.canvas.width,a=i.canvas.height;this.spinnerInterval=window.setInterval(function(){var t=parseInt((new Date-s)/1e3*16)/16;i.save(),i.clearRect(0,0,n,a),i.translate(n/2,a/2),i.rotate(2*Math.PI*t);for(var e=0;e<16;e++)i.beginPath(),i.rotate(2*Math.PI/16),i.moveTo(n/10,0),i.lineTo(n/4,0),i.lineWidth=n/30,i.strokeStyle=\"rgba(255,255,255,\"+e/16+\")\",i.stroke();i.restore()},1e3/30)},_hideSpinner:function(){window.clearInterval(this.spinnerInterval),this.$spinnerCanvas.remove(),this.$spinnerCanvas=null},_showCropper:function(t){this._setupCropperLayer(t),this._redrawCropperElements(),this.renderCropper()},_hideCropper:function(){this.clipper&&(this.croppingCanvas.remove(this.clipper),this.croppingCanvas.remove(this.croppingShade),this.croppingCanvas.remove(this.cropperHandles),this.croppingCanvas.remove(this.cropperGrid),this.croppingCanvas.remove(this.croppingRectangle),this.croppingCanvas=null,this.renderCropper=null)},_setupCropperLayer:function(t){this.croppingCanvas=new fabric.StaticCanvas(\"cropping-canvas\",{backgroundColor:\"rgba(0,0,0,0)\",hoverCursor:\"default\",selection:!1}),this.croppingCanvas.setDimensions({width:this.editorWidth,height:this.editorHeight}),this.renderCropper=function(){Garnish.requestAnimationFrame(this.croppingCanvas.renderAll.bind(this.croppingCanvas))}.bind(this),$(\"#cropping-canvas\",this.$editorContainer).css({position:\"absolute\",top:0,left:0}),this.croppingShade=new fabric.Rect({left:this.editorWidth/2,top:this.editorHeight/2,originX:\"center\",originY:\"center\",width:this.editorWidth,height:this.editorHeight,fill:\"rgba(0,0,0,0.7)\"});var e=this.getScaledImageDimensions(),i=0===this.imageStraightenAngle?1:1.2*this.getCombinedZoomRatio(e),s=e.width/i,n=e.height/i;if(this.hasOrientationChanged()){var a=n;n=s,s=a}this.clipper=new fabric.Rect({left:this.editorWidth/2,top:this.editorHeight/2,originX:\"center\",originY:\"center\",width:s,height:n,stroke:\"black\",fill:\"rgba(128,0,0,1)\",strokeWidth:0}),t&&this.clipper.set(t),this.clipper.globalCompositeOperation=\"destination-out\",this.croppingCanvas.add(this.croppingShade),this.croppingCanvas.add(this.clipper)},_redrawCropperElements:function(){this.cropperHandles&&(this.croppingCanvas.remove(this.cropperHandles),this.croppingCanvas.remove(this.cropperGrid),this.croppingCanvas.remove(this.croppingRectangle));var t={strokeWidth:4,stroke:\"rgb(255,255,255)\",fill:!1},e={strokeWidth:2,stroke:\"rgba(255,255,255,0.5)\"},i=[new fabric.Path(\"M 0,10 L 0,0 L 10,0\",t),new fabric.Path(\"M \"+(this.clipper.width-8)+\",0 L \"+(this.clipper.width+4)+\",0 L \"+(this.clipper.width+4)+\",10\",t),new fabric.Path(\"M \"+(this.clipper.width+4)+\",\"+(this.clipper.height-8)+\" L\"+(this.clipper.width+4)+\",\"+(this.clipper.height+4)+\" L \"+(this.clipper.width-8)+\",\"+(this.clipper.height+4),t),new fabric.Path(\"M 10,\"+(this.clipper.height+4)+\" L 0,\"+(this.clipper.height+4)+\" L 0,\"+(this.clipper.height-8),t)];this.cropperHandles=new fabric.Group(i,{left:this.clipper.left,top:this.clipper.top,originX:\"center\",originY:\"center\"}),this.croppingRectangle=new fabric.Rect({left:this.clipper.left,top:this.clipper.top,width:this.clipper.width,height:this.clipper.height,fill:\"rgba(0,0,0,0)\",stroke:\"rgba(255,255,255,0.8)\",strokeWidth:2,originX:\"center\",originY:\"center\"}),this.cropperGrid=new fabric.Group([new fabric.Line([.33*this.clipper.width,0,.33*this.clipper.width,this.clipper.height],e),new fabric.Line([.66*this.clipper.width,0,.66*this.clipper.width,this.clipper.height],e),new fabric.Line([0,.33*this.clipper.height,this.clipper.width,.33*this.clipper.height],e),new fabric.Line([0,.66*this.clipper.height,this.clipper.width,.66*this.clipper.height],e)],{left:this.clipper.left,top:this.clipper.top,originX:\"center\",originY:\"center\"}),this.croppingCanvas.add(this.cropperHandles),this.croppingCanvas.add(this.cropperGrid),this.croppingCanvas.add(this.croppingRectangle)},_repositionCropper:function(t){if(this.croppingCanvas){var e=this.clipper.left-this.croppingCanvas.width/2,i=this.clipper.top-this.croppingCanvas.height/2;this.croppingCanvas.setDimensions({width:this.editorWidth,height:this.editorHeight});var s=this._getBoundingRectangle(this.imageVerticeCoords).width/t.width;this.clipper.width=Math.round(this.clipper.width*s),this.clipper.height=Math.round(this.clipper.height*s),this.clipper.left=this.editorWidth/2+e*s,this.clipper.top=this.editorHeight/2+i*s,this.croppingShade.set({width:this.editorWidth,height:this.editorHeight,left:this.editorWidth/2,top:this.editorHeight/2}),this._redrawCropperElements(),this.renderCropper()}},_getBoundingRectangle:function(t){return{width:Math.max(t.a.x,t.b.x,t.c.x,t.d.x)-Math.min(t.a.x,t.b.x,t.c.x,t.d.x),height:Math.max(t.a.y,t.b.y,t.c.y,t.d.y)-Math.min(t.a.y,t.b.y,t.c.y,t.d.y)}},_handleMouseDown:function(t){var e=this.focalPoint&&this._isMouseOver(t,this.focalPoint),i=this.croppingCanvas&&this._isMouseOver(t,this.clipper),s=this.croppingCanvas&&this._cropperHandleHitTest(t);(s||i||e)&&(this.previousMouseX=t.pageX,this.previousMouseY=t.pageY,e?this.draggingFocal=!0:s?this.scalingCropper=s:i&&(this.draggingCropper=!0))},_handleMouseMove:function(t){this.focalPoint&&this.draggingFocal?(this._handleFocalDrag(t),this.storeFocalPointState(),this.renderImage()):this.draggingCropper||this.scalingCropper?(this.draggingCropper?this._handleCropperDrag(t):this._handleCropperResize(t),this._redrawCropperElements(),this.storeCropperState(),this.renderCropper()):this._setMouseCursor(t),this.previousMouseX=t.pageX,this.previousMouseY=t.pageY},_handleMouseUp:function(t){this.draggingCropper=!1,this.scalingCropper=!1,this.draggingFocal=!1},_handleCropperDrag:function(t){var e=t.pageX-this.previousMouseX,i=t.pageY-this.previousMouseY;if(0!=e||0!=i){var s={left:this.clipper.left-this.clipper.width/2,top:this.clipper.top-this.clipper.height/2,width:this.clipper.width,height:this.clipper.height},n=this._getRectangleVertices(s,e,i);this.arePointsInsideRectangle(n,this.imageVerticeCoords)&&this.clipper.set({left:this.clipper.left+e,top:this.clipper.top+i})}},_handleFocalDrag:function(t){if(this.focalPoint){var e=t.pageX-this.previousMouseX,i=t.pageY-this.previousMouseY;if(0==e&&0==i)return;var s=this.focalPoint.left+e,n=this.focalPoint.top+i;if(\"crop\"===this.currentView){if(!this.arePointsInsideRectangle([{x:s,y:n}],this.imageVerticeCoords))return}else if(!(this.viewport.left-this.viewport.width/2-s<0&&0<this.viewport.left+this.viewport.width/2-s&&this.viewport.top-this.viewport.height/2-n<0&&0<this.viewport.top+this.viewport.height/2-n))return;this.focalPoint.set({left:this.focalPoint.left+e,top:this.focalPoint.top+i})}},setCroppingConstraint:function(t){switch(this.updateSizeAndPosition(),t){case\"none\":t=!1;break;case\"original\":t=this.originalWidth/this.originalHeight;break;case\"current\":t=this.clipper.width/this.clipper.height;break;default:t=parseFloat(t)}this.croppingConstraint=t},enforceCroppingConstraint:function(){if(!this.animationInProgress&&this.croppingConstraint){this.animationInProgress=!0;var t={left:this.clipper.left-this.clipper.width/2,top:this.clipper.top-this.clipper.height/2,width:this.clipper.width,height:this.clipper.height};if(this.clipper.width>this.clipper.height*this.croppingConstraint){var e=t.height;t.height=this.clipper.width/this.croppingConstraint,t.top-=(t.height-e)/2,this.arePointsInsideRectangle(this._getRectangleVertices(t),this.imageVerticeCoords)||(t.width=this.clipper.height*this.croppingConstraint,t.height=t.width/this.croppingConstraint)}else{var i=t.width;t.width=this.clipper.height*this.croppingConstraint,t.left-=(t.width-i)/2,this.arePointsInsideRectangle(this._getRectangleVertices(t),this.imageVerticeCoords)||(t.height=this.clipper.width/this.croppingConstraint,t.width=t.height*this.croppingConstraint)}var s={height:t.height,width:t.width};this.clipper.animate(s,{onChange:function(){this._redrawCropperElements(),this.croppingCanvas.renderAll()}.bind(this),duration:this.settings.animationDuration,onComplete:function(){this._redrawCropperElements(),this.animationInProgress=!1,this.renderCropper()}.bind(this)})}},_handleCropperResize:function(t){var e=t.pageX-this.previousMouseX,i=t.pageY-this.previousMouseY,s=0,n=0;if(\"b\"!==this.scalingCropper&&\"t\"!==this.scalingCropper||(e=0),\"l\"!==this.scalingCropper&&\"r\"!==this.scalingCropper||(i=0),0!==e||0!==i){var a={left:this.clipper.left-this.clipper.width/2,top:this.clipper.top-this.clipper.height/2,width:this.clipper.width,height:this.clipper.height};if(this.croppingConstraint){var r=0;switch(this.scalingCropper){case\"t\":r=-i;break;case\"b\":r=i;break;case\"r\":r=e;break;case\"l\":r=-e;break;case\"tr\":r=-i+e;break;case\"tl\":r=-i-e;break;case\"br\":r=i+e;break;case\"bl\":r=i-e}1<this.croppingConstraint?i=(e=r)/this.croppingConstraint:e=(i=r)*this.croppingConstraint,a.height+=i,a.width+=e,this.scalingCropper.match(/t/)&&(a.top-=i,a.left-=e/2,s=-i/2),this.scalingCropper.match(/b/)&&(a.left+=-e/2,s=i/2),this.scalingCropper.match(/r/)&&(a.top+=-i/2,n=e/2),this.scalingCropper.match(/l/)&&(a.top-=i/2,a.left-=e,n=-e/2)}else{if(this.shiftKeyHeld&&(\"tl\"===this.scalingCropper||\"tr\"===this.scalingCropper||\"bl\"===this.scalingCropper||\"br\"===this.scalingCropper))Math.abs(e)>Math.abs(i)?(i=e/(this.clipper.width/this.clipper.height),i*=\"tr\"===this.scalingCropper||\"bl\"===this.scalingCropper?-1:1):(e=i*(this.clipper.width/this.clipper.height),e*=\"tr\"===this.scalingCropper||\"bl\"===this.scalingCropper?-1:1);this.scalingCropper.match(/t/)&&(a.top+=i,a.height-=i),this.scalingCropper.match(/b/)&&(a.height+=i),this.scalingCropper.match(/r/)&&(a.width+=e),this.scalingCropper.match(/l/)&&(a.left+=e,a.width-=e),s=i/2,n=e/2}a.height<30||a.width<30||this.arePointsInsideRectangle(this._getRectangleVertices(a),this.imageVerticeCoords)&&(this.clipper.set({top:this.clipper.top+s,left:this.clipper.left+n,width:a.width,height:a.height}),this._redrawCropperElements())}},_setMouseCursor:function(t){var e=\"default\",i=this.croppingCanvas&&this._cropperHandleHitTest(t);this.focalPoint&&this._isMouseOver(t,this.focalPoint)?e=\"pointer\":i?\"t\"===i||\"b\"===i?e=\"ns-resize\":\"l\"===i||\"r\"===i?e=\"ew-resize\":\"tl\"===i||\"br\"===i?e=\"nwse-resize\":\"bl\"!==i&&\"tr\"!==i||(e=\"nesw-resize\"):this.croppingCanvas&&this._isMouseOver(t,this.clipper)&&(e=\"move\"),$(\".body\").css(\"cursor\",e)},_cropperHandleHitTest:function(t){var e=this.$croppingCanvas.offset(),i=t.pageX-e.left,s=t.pageY-e.top,n=this.clipper.left-this.clipper.width/2,a=n+this.clipper.width,r=this.clipper.top-this.clipper.height/2,o=r+this.clipper.height;if(i<10+n&&n-3<i){if(s<10+r&&r-3<s)return\"tl\";if(s<o+3&&o-10<s)return\"bl\"}if(a-13<i&&i<a+3){if(s<10+r&&r-3<s)return\"tr\";if(s<o+2&&o-10<s)return\"br\"}return i<3+n&&n-3<i&&s<o-10&&10+r<s?\"l\":i<a+1&&a-5<i&&s<o-10&&10+r<s?\"r\":s<4+r&&r-2<s&&10+n<i&&i<a-10?\"t\":s<o+2&&o-4<s&&10+n<i&&i<a-10&&\"b\"},_isMouseOver:function(t,e){var i=this.$croppingCanvas.offset(),s=t.pageX-i.left,n=t.pageY-i.top,a=e.left-e.width/2,r=a+e.width,o=e.top-e.height/2,l=o+e.height;return a<=s&&s<=r&&o<=n&&n<=l},_getRectangleVertices:function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=0);var s={x:t.left+e,y:t.top+i},n={x:s.x+t.width,y:s.y},a={x:n.x,y:n.y+t.height};return[s,n,a,{x:s.x,y:a.y}]},_setFittedImageVerticeCoordinates:function(){this.imageVerticeCoords=this.getImageVerticeCoords(\"fit\")},getImageVerticeCoords:function(t){var e,i=-1*((this.hasOrientationChanged()?90:0)+this.imageStraightenAngle)*(Math.PI/180),s=this.getScaledImageDimensions();e=\"number\"==typeof t?t:\"cover\"===t?this.getZoomToCoverRatio(s):this.getZoomToFitRatio(s);var n=s.height*e,a=s.width*e,r=Math.cos(i)*n,o=Math.sin(i)*a,l=Math.cos(i)*a,h=Math.sin(i)*n,d=(this.editorHeight-(r+o))/2,c=(this.editorWidth-(h+l))/2;return{a:{x:c+l,y:d},b:{x:this.editorWidth-c,y:d+r},c:{x:c+h,y:this.editorHeight-d},d:{x:c,y:d+o}}},_debug:function(t){this.canvas.remove(this.debugger),this.debugger=t,this.canvas.add(this.debugger)},arePointsInsideRectangle:function(t,e){for(var i=this._getVector(e.a,e.b),s=this._getVector(e.b,e.c),n=this._getScalarProduct(i,i),a=this._getScalarProduct(s,s),r=0;r<t.length;r++){var o=t[r],l=this._getVector(e.a,o),h=this._getVector(e.b,o),d=this._getScalarProduct(i,l),c=this._getScalarProduct(s,h);if(!(0<=d&&d<=n)||!(0<=c&&c<=a))return!1}return!0},_getVector:function(t,e){return{x:e.x-t.x,y:e.y-t.y}},_getScalarProduct:function(t,e){return t.x*e.x+t.y*e.y},_getVectorMagnitude:function(t){return Math.sqrt(t.x*t.x+t.y*t.y)},_getAngleBetweenVectors:function(t,e){return Math.round(180*Math.acos(Math.min(1,this._getScalarProduct(t,e)/(this._getVectorMagnitude(t)*this._getVectorMagnitude(e))))/Math.PI*100)/100},_getEdgeCrossed:function(t,e){for(var i=[[t.a,t.b],[t.b,t.c],[t.c,t.d],[t.d,t.a]],s={x:this.editorWidth/2,y:this.editorHeight/2},n=180,a=null,r=0;r<i.length;r++){var o=i[r],l=this._getVector(o[0],s),h=this._getVector(o[0],o[1]),d=this._getVector(o[0],e),c=Math.abs(this._getAngleBetweenVectors(l,d)-(this._getAngleBetweenVectors(l,h)+this._getAngleBetweenVectors(h,d)));c<n&&(n=c,a=o)}return a},_getImageBoundingBox:function(t){var e={},i=Math.abs(this.imageStraightenAngle)*(Math.PI/180),s=t.height/t.width;if(e.height=t.width*(Math.sin(i)+Math.cos(i)*s),e.width=t.width*(Math.cos(i)+Math.sin(i)*s),this.hasOrientationChanged()){var n=e.width;e.width=e.height,e.height=n}return e}},{defaults:{animationDuration:100,allowSavingAsNew:!0,onSave:$.noop,allowDegreeFractions:!0}}),Craft.AssetIndex=Craft.BaseElementIndex.extend({$includeSubfoldersContainer:null,$includeSubfoldersCheckbox:null,showingIncludeSubfoldersCheckbox:!1,$uploadButton:null,$uploadInput:null,$progressBar:null,$folders:null,uploader:null,promptHandler:null,progressBar:null,_uploadTotalFiles:0,_uploadFileProgress:{},_uploadedAssetIds:[],_currentUploaderSettings:{},_assetDrag:null,_folderDrag:null,_expandDropTargetFolderTimeout:null,_tempExpandedFolders:[],_fileConflictTemplate:{choices:[{value:\"keepBoth\",title:Craft.t(\"app\",\"Keep both\")},{value:\"replace\",title:Craft.t(\"app\",\"Replace it\")}]},_folderConflictTemplate:{choices:[{value:\"replace\",title:Craft.t(\"app\",\"Replace the folder (all existing files will be deleted)\")},{value:\"merge\",title:Craft.t(\"app\",\"Merge the folder (any conflicting files will be replaced)\")}]},init:function(t,e,i){this.base(t,e,i),\"index\"===this.settings.context?(this._folderDrag||this._initIndexPageMode(),this.addListener(Garnish.$win,\"resize,scroll\",\"_positionProgressBar\")):(this.addListener(this.$main,\"scroll\",\"_positionProgressBar\"),this.settings.modal&&this.settings.modal.on(\"updateSizeAndPosition\",$.proxy(this,\"_positionProgressBar\")))},initSources:function(){return\"index\"!==this.settings.context||this._folderDrag||this._initIndexPageMode(),this.base()},initSource:function(t){this.base(t),this._createFolderContextMenu(t),\"index\"===this.settings.context&&(this._folderDrag&&1<this._getSourceLevel(t)&&t.data(\"folder-id\")&&this._folderDrag.addItems(t.parent()),this._assetDrag&&this._assetDrag.updateDropTargets())},deinitSource:function(t){this.base(t);var e=t.data(\"contextmenu\");e&&e.destroy(),\"index\"===this.settings.context&&(this._folderDrag&&1<this._getSourceLevel(t)&&this._folderDrag.removeItems(t.parent()),this._assetDrag&&this._assetDrag.updateDropTargets())},_getSourceLevel:function(t){return t.parentsUntil(\"nav\",\"ul\").length},_initIndexPageMode:function(){if(!this._folderDrag){this.settings.selectable=!0,this.settings.multiSelect=!0;var t=$.proxy(this,\"_onDragStart\"),e=$.proxy(this,\"_onDropTargetChange\");this._assetDrag=new Garnish.DragDrop({activeDropTargetClass:\"sel\",helperOpacity:.75,filter:$.proxy(function(){return this.view.getSelectedElements()},this),helper:$.proxy(function(t){return this._getFileDragHelper(t)},this),dropTargets:$.proxy(function(){for(var t=[],e=0;e<this.$sources.length;e++){var i=this.$sources.eq(e);this._getFolderUidFromSourceKey(i.data(\"key\"))&&t.push(i)}return t},this),onDragStart:t,onDropTargetChange:e,onDragStop:$.proxy(this,\"_onFileDragStop\")}),this._folderDrag=new Garnish.DragDrop({activeDropTargetClass:\"sel\",helperOpacity:.75,filter:$.proxy(function(){for(var t=this.sourceSelect.getSelectedItems(),e=[],i=0;i<t.length;i++){var s=t.eq(i);!this._getFolderUidFromSourceKey(s.data(\"key\"))||s.hasClass(\"sel\")&&1<this._getSourceLevel(s)&&e.push(s.parent()[0])}return $(e)},this),helper:$.proxy(function(t){var e=$('<div class=\"sidebar\" style=\"padding-top: 0; padding-bottom: 0;\"/>'),i=$(\"<nav/>\").appendTo(e),s=$(\"<ul/>\").appendTo(i);return t.appendTo(s).removeClass(\"expanded\"),t.children(\"a\").addClass(\"sel\"),t.css({\"padding-top\":this._folderDrag.$draggee.css(\"padding-top\"),\"padding-right\":this._folderDrag.$draggee.css(\"padding-right\"),\"padding-bottom\":this._folderDrag.$draggee.css(\"padding-bottom\"),\"padding-left\":this._folderDrag.$draggee.css(\"padding-left\")}),e},this),dropTargets:$.proxy(function(){var t=[],e=[];this._folderDrag.$draggee.find(\"a[data-key]\").each(function(){e.push($(this).data(\"key\"))});for(var i=0;i<this.$sources.length;i++){var s=this.$sources.eq(i),n=s.data(\"key\");this._getFolderUidFromSourceKey(n)&&(Craft.inArray(n,e)||t.push(s))}return t},this),onDragStart:t,onDropTargetChange:e,onDragStop:$.proxy(this,\"_onFolderDragStop\")})}},_onFileDragStop:function(){if(this._assetDrag.$activeDropTarget&&this._assetDrag.$activeDropTarget[0]!==this.$source[0]){for(var r=this.$source,o=this._assetDrag.$activeDropTarget.data(\"folder-id\"),l=[],t=0;t<this._assetDrag.$draggee.length;t++){var e=Craft.getElementInfo(this._assetDrag.$draggee[t]).id;l.push(e)}if(l.length){this.setIndexBusy(),this._positionProgressBar(),this.progressBar.resetProgressBar(),this.progressBar.setItemCount(l.length),this.progressBar.showProgressBar();var i=[];for(t=0;t<l.length;t++)i.push({action:\"assets/move-asset\",params:{assetId:l[t],folderId:o}});var h=$.proxy(function(t){this.promptHandler.resetPrompts();for(var e=0;e<t.length;e++){var i=t[e];i.conflict&&this.promptHandler.addPrompt({assetId:i.assetId,suggestedFilename:i.suggestedFilename,prompt:{message:i.conflict,choices:this._fileConflictTemplate.choices}}),i.error&&alert(i.error)}this.setIndexAvailable(),this.progressBar.hideProgressBar();function s(){this.sourceSelect.selectItem(r),this._totalVisible-=this._assetDrag.$draggee.length;for(var t=0;t<l.length;t++)$(\"[data-id=\"+l[t]+\"]\").remove();this.view.deselectAllElements(),this._collapseExtraExpandedFolders(o),n&&this.updateElements()}var n=!1;if(this.promptHandler.getPromptCount()){var a=$.proxy(function(t){for(var e=[],i=0;i<t.length;i++)\"cancel\"!==t[i].choice?(\"keepBoth\"===t[i].choice&&e.push({action:\"assets/move-asset\",params:{folderId:o,assetId:t[i].assetId,filename:t[i].suggestedFilename}}),\"replace\"===t[i].choice&&e.push({action:\"assets/move-asset\",params:{folderId:o,assetId:t[i].assetId,force:!0}})):n=!0;0===e.length?s.apply(this):(this.setIndexBusy(),this.progressBar.resetProgressBar(),this.progressBar.setItemCount(this.promptHandler.getPromptCount()),this.progressBar.showProgressBar(),this._performBatchRequests(e,h))},this);this._assetDrag.fadeOutHelpers(),this.promptHandler.showBatchPrompts(a)}else s.apply(this),this._assetDrag.fadeOutHelpers()},this);return void this._performBatchRequests(i,h)}}else this.$source.addClass(\"sel\"),this._collapseExtraExpandedFolders();this._assetDrag.returnHelpersToDraggees()},_onFolderDragStop:function(){if(this._folderDrag.$activeDropTarget&&0===this._folderDrag.$activeDropTarget.siblings(\"ul\").children(\"li\").filter(this._folderDrag.$draggee).length){var t=this._folderDrag.$activeDropTarget.data(\"folder-id\");this._collapseExtraExpandedFolders(t);for(var a=[],e=0;e<this._folderDrag.$draggee.length;e++){var i=this._folderDrag.$draggee.eq(e).children(\"a\").data(\"folder-id\");if(i!=t){a.push(i);break}}if(a.length){a.sort(),a.reverse(),this.setIndexBusy(),this._positionProgressBar(),this.progressBar.resetProgressBar(),this.progressBar.setItemCount(a.length),this.progressBar.showProgressBar();var s=[];for(e=0;e<a.length;e++)s.push({action:\"assets/move-folder\",params:{folderId:a[e],parentId:t}});this.requestId++;var r=[],o=\"\",l=function(t){this.promptHandler.resetPrompts();for(var e=0;e<t.length;e++){var n=t[e];n.success&&(n.transferList&&(r=n.transferList),n.newFolderId&&(o=this._folderDrag.$activeDropTarget.data(\"key\")+\"/folder:\"+n.newFolderUid)),n.conflict&&(n.prompt={message:n.conflict,choices:this._folderConflictTemplate.choices},this.promptHandler.addPrompt(n)),n.error&&alert(n.error)}if(this.promptHandler.getPromptCount()){var i=$.proxy(function(t){this.promptHandler.resetPrompts();for(var e=[],i={},s=0;s<t.length;s++)\"cancel\"!==t[s].choice&&(\"replace\"===t[s].choice&&(i.force=!0),\"merge\"===t[s].choice&&(i.merge=!0),i.folderId=n.folderId,i.parentId=n.parentId,e.push({action:\"assets/move-folder\",params:i}));0===e.length?$.proxy(this,\"_performActualFolderMove\",r,a,o)():(this.setIndexBusy(),this.progressBar.resetProgressBar(),this.progressBar.setItemCount(this.promptHandler.getPromptCount()),this.progressBar.showProgressBar(),this._performBatchRequests(e,l))},this);this.promptHandler.showBatchPrompts(i),this.setIndexAvailable(),this.progressBar.hideProgressBar()}else $.proxy(this,\"_performActualFolderMove\",r,a,o)()}.bind(this);return void this._performBatchRequests(s,l)}}else this.$source.addClass(\"sel\"),this._collapseExtraExpandedFolders();this._folderDrag.returnHelpersToDraggees()},_performActualFolderMove:function(t,e,n){this.setIndexBusy(),this.progressBar.resetProgressBar(),this.progressBar.setItemCount(1),this.progressBar.showProgressBar();var i=function(t){for(var e=0,i=t.length,s=0;s<t.length;s++)Craft.postActionRequest(\"assets/delete-folder\",{folderId:t[s]},function(){++e===i&&(this.setIndexAvailable(),this.progressBar.hideProgressBar(),this._folderDrag.returnHelpersToDraggees(),this.setInstanceState(\"selectedSource\",n),this.refreshSources())}.bind(this))}.bind(this);if(0<t.length){for(var s=[],a=0;a<t.length;a++)s.push({action:\"assets/move-asset\",params:t[a]});this._performBatchRequests(s,function(){i(e)})}else i(e)},_getParentSource:function(t){if(1<this._getSourceLevel(t))return t.parent().parent().siblings(\"a\")},_selectSourceByFolderId:function(t){for(var e=this._getSourceByKey(t),i=e.parent().parents(\"li\"),s=0;s<i.length;s++){var n=$(i[s]);n.hasClass(\"expanded\")||n.children(\".toggle\").trigger(\"click\")}this.selectSource(e),this.updateElements()},afterInit:function(){this.$uploadButton||(this.$uploadButton=$('<div class=\"btn submit\" data-icon=\"upload\" style=\"position: relative; overflow: hidden;\" role=\"button\">'+Craft.t(\"app\",\"Upload files\")+\"</div>\"),this.addButton(this.$uploadButton),this.$uploadInput=$('<input type=\"file\" multiple=\"multiple\" name=\"assets-upload\" />').hide().insertBefore(this.$uploadButton)),this.promptHandler=new Craft.PromptHandler,this.progressBar=new Craft.ProgressBar(this.$main,!0);var t={url:Craft.getActionUrl(\"assets/save-asset\"),fileInput:this.$uploadInput,dropZone:this.$container};t.events={fileuploadstart:$.proxy(this,\"_onUploadStart\"),fileuploadprogressall:$.proxy(this,\"_onUploadProgress\"),fileuploaddone:$.proxy(this,\"_onUploadComplete\")},this.settings.criteria&&void 0!==this.settings.criteria.kind&&(t.allowedKinds=this.settings.criteria.kind),this._currentUploaderSettings=t,this.uploader=new Craft.Uploader(this.$uploadButton,t),this.$uploadButton.on(\"click\",$.proxy(function(){this.$uploadButton.hasClass(\"disabled\")||this.isIndexBusy||this.$uploadButton.parent().find(\"input[name=assets-upload]\").trigger(\"click\")},this)),this.base()},onSelectSource:function(){this._getSourceByKey(this.sourceKey).data(\"folder-id\")&&this.$source.attr(\"data-upload\")?(this.uploader.setParams({folderId:this.$source.attr(\"data-folder-id\")}),this.$uploadButton.removeClass(\"disabled\")):this.$uploadButton.addClass(\"disabled\"),this.base()},_getFolderUidFromSourceKey:function(t){var e=t.match(/\\bfolder:([0-9a-f\\-]+)$/);return e?e[1]:null},startSearching:function(){if(this.$source.siblings(\"ul\").length){if(null===this.$includeSubfoldersContainer){var t=\"includeSubfolders-\"+Math.floor(1e9*Math.random());this.$includeSubfoldersContainer=$('<div style=\"margin-bottom: -23px; opacity: 0;\"/>').insertAfter(this.$search);var e=$('<div style=\"padding-top: 5px;\"/>').appendTo(this.$includeSubfoldersContainer);this.$includeSubfoldersCheckbox=$('<input type=\"checkbox\" id=\"'+t+'\" class=\"checkbox\"/>').appendTo(e),$('<label class=\"light smalltext\" for=\"'+t+'\"/>').text(\" \"+Craft.t(\"app\",\"Search in subfolders\")).appendTo(e),this.addListener(this.$includeSubfoldersCheckbox,\"change\",function(){this.setSelecetedSourceState(\"includeSubfolders\",this.$includeSubfoldersCheckbox.prop(\"checked\")),this.updateElements()})}else this.$includeSubfoldersContainer.velocity(\"stop\");var i=this.getSelectedSourceState(\"includeSubfolders\",!1);this.$includeSubfoldersCheckbox.prop(\"checked\",i),this.$includeSubfoldersContainer.velocity({marginBottom:0,opacity:1},\"fast\"),this.showingIncludeSubfoldersCheckbox=!0}this.base()},stopSearching:function(){this.showingIncludeSubfoldersCheckbox&&(this.$includeSubfoldersContainer.velocity(\"stop\"),this.$includeSubfoldersContainer.velocity({marginBottom:-23,opacity:0},\"fast\"),this.showingIncludeSubfoldersCheckbox=!1),this.base()},getViewParams:function(){var t=this.base();return this.showingIncludeSubfoldersCheckbox&&this.$includeSubfoldersCheckbox.prop(\"checked\")&&(t.criteria.includeSubfolders=!0),t},_onUploadStart:function(){this.setIndexBusy(),this._positionProgressBar(),this.progressBar.resetProgressBar(),this.progressBar.showProgressBar(),this.promptHandler.resetPrompts()},_onUploadProgress:function(t,e){var i=parseInt(e.loaded/e.total*100,10);this.progressBar.setProgressPercentage(i)},_onUploadComplete:function(t,e){var i=e.result,s=e.files[0].name,n=!0;i.success||i.conflict?(this._uploadedAssetIds.push(i.assetId),i.conflict&&(i.prompt={message:Craft.t(\"app\",i.conflict,{file:i.filename}),choices:this._fileConflictTemplate.choices},this.promptHandler.addPrompt(i)),Craft.cp.runQueue()):(i.error?alert(Craft.t(\"app\",\"Upload failed. The error message was: \u201c{error}\u201d\",{error:i.error})):alert(Craft.t(\"app\",\"Upload failed for {filename}.\",{filename:s})),n=!1),this.uploader.isLastUpload()&&(this.setIndexAvailable(),this.progressBar.hideProgressBar(),this.promptHandler.getPromptCount()?this.promptHandler.showBatchPrompts($.proxy(this,\"_uploadFollowup\")):n&&this._updateAfterUpload())},_updateAfterUpload:function(){\"index\"!==this.settings.context&&(this.setSortAttribute(\"dateModified\"),this.setSortDirection(\"desc\")),this.updateElements()},_uploadFollowup:function(t){this.setIndexBusy(),this.progressBar.resetProgressBar(),this.promptHandler.resetPrompts();var e=function(){this.setIndexAvailable(),this.progressBar.hideProgressBar(),this._updateAfterUpload()}.bind(this);this.progressBar.setItemCount(t.length);var r=function(i,s,n){var t={},e=null,a=function(t,e){\"success\"===e&&t.assetId?this._uploadedAssetIds.push(t.assetId):t.error&&alert(t.error),s++,this.progressBar.incrementProcessedItemCount(1),this.progressBar.updateProgressBar(),s===i.length?n():r(i,s,n)}.bind(this);\"replace\"===i[s].choice?(e=\"assets/replace-file\",t.sourceAssetId=i[s].assetId,i[s].conflictingAssetId?t.assetId=i[s].conflictingAssetId:t.targetFilename=i[s].filename):\"cancel\"===i[s].choice&&(e=\"assets/delete-asset\",t.assetId=i[s].assetId),e?Craft.postActionRequest(e,t,a):a({assetId:i[s].assetId},\"success\")}.bind(this);this.progressBar.showProgressBar(),r(t,0,e)},onUpdateElements:function(){this._onUpdateElements(!1,this.view.getAllElements()),this.view.on(\"appendElements\",$.proxy(function(t){this._onUpdateElements(!0,t.newElements)},this)),this.base()},_onUpdateElements:function(t,e){if(\"index\"===this.settings.context&&(t||this._assetDrag.removeAllItems(),this._assetDrag.addItems(e)),this._uploadedAssetIds.length){if(this.view.settings.selectable)for(var i=0;i<this._uploadedAssetIds.length;i++)this.view.selectElementById(this._uploadedAssetIds[i]);this._uploadedAssetIds=[]}this.base(t,e),this.removeListener(this.$elements,\"keydown\"),this.addListener(this.$elements,\"keydown\",this._onKeyDown.bind(this)),this.view.elementSelect.on(\"focusItem\",this._onElementFocus.bind(this))},_onKeyDown:function(t){if(t.keyCode===Garnish.SPACE_KEY&&t.shiftKey){if(Craft.PreviewFileModal.openInstance)Craft.PreviewFileModal.openInstance.selfDestruct();else{var e=this.view.elementSelect.$focusedItem.find(\".element\");e.length&&this._loadPreview(e)}return t.stopPropagation(),!1}},_onElementFocus:function(t){var e=$(t.item).find(\".element\");Craft.PreviewFileModal.openInstance&&e.length&&this._loadPreview(e)},_loadPreview:function(t){var e={};t.data(\"image-width\")&&(e.startingWidth=t.data(\"image-width\"),e.startingHeight=t.data(\"image-height\")),new Craft.PreviewFileModal(t.data(\"id\"),this.view.elementSelect,e)},_onDragStart:function(){this._tempExpandedFolders=[]},_getFileDragHelper:function(t){var e,i;switch(this.getSelectedSourceState(\"mode\")){case\"table\":e=$('<div class=\"elements datatablesorthelper\"/>').appendTo(Garnish.$bod),i=$('<div class=\"tableview\"/>').appendTo(e);var s=$('<table class=\"data\"/>').appendTo(i),n=$(\"<tbody/>\").appendTo(s);t.appendTo(n),this._$firstRowCells=this.view.$table.children(\"tbody\").children(\"tr:first\").children();for(var a=t.children(),r=0;r<a.length;r++){var o=$(a[r]);if(o.hasClass(\"checkbox-cell\"))o.remove(),e.css(\"margin-\"+Craft.left,19);else{var l=$(this._$firstRowCells[r]),h=l.width();l.width(h),o.width(h)}}return e;case\"thumbs\":return e=$('<div class=\"elements thumbviewhelper\"/>').appendTo(Garnish.$bod),i=$('<ul class=\"thumbsview\"/>').appendTo(e),t.appendTo(i),e}return $()},_onDropTargetChange:function(t){if(clearTimeout(this._expandDropTargetFolderTimeout),t){var e=t.data(\"folder-id\");e?(this.dropTargetFolder=this._getSourceByKey(e),this._hasSubfolders(this.dropTargetFolder)&&!this._isExpanded(this.dropTargetFolder)&&(this._expandDropTargetFolderTimeout=setTimeout($.proxy(this,\"_expandFolder\"),500))):this.dropTargetFolder=null}t&&t[0]!==this.$source[0]?this.$source.removeClass(\"sel\"):this.$source.addClass(\"sel\")},_collapseExtraExpandedFolders:function(t){var e;clearTimeout(this._expandDropTargetFolderTimeout),t&&(e=this._getSourceByKey(t).parents(\"li\").children(\"a\"));for(var i=this._tempExpandedFolders.length-1;0<=i;i--){var s=this._tempExpandedFolders[i];void 0!==e&&0!==e.filter('[data-key=\"'+s.data(\"key\")+'\"]').length||(this._collapseFolder(s),this._tempExpandedFolders.splice(i,1))}},_getSourceByKey:function(t){return this.$sources.filter('[data-key$=\"'+t+'\"]')},_hasSubfolders:function(t){return t.siblings(\"ul\").find(\"li\").length},_isExpanded:function(t){return t.parent(\"li\").hasClass(\"expanded\")},_expandFolder:function(){this._collapseExtraExpandedFolders(this.dropTargetFolder.data(\"folder-id\")),this.dropTargetFolder.siblings(\".toggle\").trigger(\"click\"),this._tempExpandedFolders.push(this.dropTargetFolder)},_collapseFolder:function(t){t.parent().hasClass(\"expanded\")&&t.siblings(\".toggle\").trigger(\"click\")},_createFolderContextMenu:function(t){if(this._getFolderUidFromSourceKey(t.data(\"key\"))){var e=[{label:Craft.t(\"app\",\"New subfolder\"),onClick:$.proxy(this,\"_createSubfolder\",t)}];\"index\"===this.settings.context&&1<this._getSourceLevel(t)&&(e.push({label:Craft.t(\"app\",\"Rename folder\"),onClick:$.proxy(this,\"_renameFolder\",t)}),e.push({label:Craft.t(\"app\",\"Delete folder\"),onClick:$.proxy(this,\"_deleteFolder\",t)})),new Garnish.ContextMenu(t,e,{menuClass:\"menu\"})}},_createSubfolder:function(n){var t=prompt(Craft.t(\"app\",\"Enter the name of the folder\"));if(t){var e={parentId:n.data(\"folder-id\"),folderName:t};this.setIndexBusy(),Craft.postActionRequest(\"assets/create-folder\",e,$.proxy(function(t,e){if(this.setIndexAvailable(),\"success\"===e&&t.success){this._prepareParentForChildren(n);var i=$('<li><a data-key=\"'+n.data(\"key\")+\"/folder:\"+t.folderUid+'\"'+(Garnish.hasAttr(n,\"data-has-thumbs\")?\" data-has-thumbs\":\"\")+' data-upload=\"'+n.attr(\"data-upload\")+'\" data-folder-id=\"'+t.folderId+'\">'+t.folderName+\"</a></li>\"),s=i.children(\"a:first\");this._appendSubfolder(n,i),this.initSource(s)}\"success\"===e&&t.error&&alert(t.error)},this))}},_deleteFolder:function(s){if(confirm(Craft.t(\"app\",\"Really delete folder \u201c{folder}\u201d?\",{folder:$.trim(s.text())}))){var t={folderId:s.data(\"folder-id\")};this.setIndexBusy(),Craft.postActionRequest(\"assets/delete-folder\",t,$.proxy(function(t,e){if(this.setIndexAvailable(),\"success\"===e&&t.success){var i=this._getParentSource(s);this.deinitSource(s),s.parent().remove(),this._cleanUpTree(i)}\"success\"===e&&t.error&&alert(t.error)},this))}},_renameFolder:function(i){var t=$.trim(i.text()),e=prompt(Craft.t(\"app\",\"Rename folder\"),t);if(e&&e!==t){var s={folderId:i.data(\"folder-id\"),newName:e};this.setIndexBusy(),Craft.postActionRequest(\"assets/rename-folder\",s,$.proxy(function(t,e){this.setIndexAvailable(),\"success\"===e&&t.success&&(i.text(t.newName),this._getFolderUidFromSourceKey(this.sourceSelect.$selectedItems.data(\"key\"))===this._getFolderUidFromSourceKey(i.data(\"key\"))&&this.updateElements()),\"success\"===e&&t.error&&alert(t.error)},this),\"json\")}},_prepareParentForChildren:function(t){this._hasSubfolders(t)||(t.parent().addClass(\"expanded\").append('<div class=\"toggle\"></div><ul></ul>'),this.initSourceToggle(t))},_appendSubfolder:function(t,e){for(var i=t.siblings(\"ul\").children(\"li\"),s=$.trim(e.children(\"a:first\").text()),n=!1,a=0;a<i.length;a++){var r=$(i[a]);if($.trim(r.children(\"a:first\").text())>s){r.before(e),n=!0;break}}n||t.siblings(\"ul\").append(e)},_cleanUpTree:function(t){null!==t&&0===t.siblings(\"ul\").children(\"li\").length&&(this.deinitSourceToggle(t),t.siblings(\"ul\").remove(),t.siblings(\".toggle\").remove(),t.parent().removeClass(\"expanded\"))},_positionProgressBar:function(){this.progressBar||(this.progressBar=new Craft.ProgressBar(this.$main,!0));var t=$(),e=0,i=0,s=(e=\"index\"===this.settings.context?(t=this.progressBar.$progressBar.closest(\"#content\"),Garnish.$win.scrollTop()):(t=this.progressBar.$progressBar.closest(\".main\"),this.$main.scrollTop()))-t.offset().top,n=Garnish.$win.height();i=t.height()>n?n/2-6+s:t.height()/2-6,\"index\"!==this.settings.context&&(i=e+(t.height()/2-6)),this.progressBar.$progressBar.css({top:i})},_performBatchRequests:function(i,s){for(var n=[],t=function(t){Craft.postActionRequest(t.action,t.params,function(t,e){this.progressBar.incrementProcessedItemCount(1),this.progressBar.updateProgressBar(),\"success\"===e&&(n.push(t),Craft.cp.runQueue()),n.length>=i.length&&s(n)}.bind(this))}.bind(this),e=0;e<i.length;e++)t(i[e])}}),Craft.registerElementIndexClass(\"craft\\\\elements\\\\Asset\",Craft.AssetIndex),Craft.AssetSelectInput=Craft.BaseElementSelectInput.extend({requestId:0,hud:null,uploader:null,progressBar:null,originalFilename:\"\",originalExtension:\"\",init:function(){0<arguments.length&&\"object\"==typeof arguments[0]&&(arguments[0].editorSettings={onShowHud:$.proxy(this.resetOriginalFilename,this),onCreateForm:$.proxy(this._renameHelper,this),validators:[$.proxy(this.validateElementForm,this)]}),this.base.apply(this,arguments),this._attachUploader(),this.addListener(this.$elementsContainer,\"keydown\",this._onKeyDown.bind(this)),this.elementSelect.on(\"focusItem\",this._onElementFocus.bind(this))},_onKeyDown:function(t){if(t.keyCode===Garnish.SPACE_KEY&&t.shiftKey){if(Craft.PreviewFileModal.openInstance)Craft.PreviewFileModal.openInstance.selfDestruct();else{var e=this.elementSelect.$focusedItem;e.length&&this._loadPreview(e)}return t.stopPropagation(),!1}},_onElementFocus:function(t){var e=$(t.item);Craft.PreviewFileModal.openInstance&&e.length&&this._loadPreview(e)},_loadPreview:function(t){var e={};t.data(\"image-width\")&&(e.startingWidth=t.data(\"image-width\"),e.startingHeight=t.data(\"image-height\")),new Craft.PreviewFileModal(t.data(\"id\"),this.elementSelect,e)},createElementEditor:function(t){return this.base(t,{params:{defaultFieldLayoutId:this.settings.defaultFieldLayoutId}})},_attachUploader:function(){this.progressBar=new Craft.ProgressBar($('<div class=\"progress-shade\"></div>').appendTo(this.$container));var t={url:Craft.getActionUrl(\"assets/save-asset\"),dropZone:this.$container,formData:{fieldId:this.settings.fieldId,elementId:this.settings.sourceElementId}};void 0!==Craft.csrfTokenName&&void 0!==Craft.csrfTokenValue&&(t.formData[Craft.csrfTokenName]=Craft.csrfTokenValue),void 0!==this.settings.criteria.kind&&(t.allowedKinds=this.settings.criteria.kind),t.canAddMoreFiles=$.proxy(this,\"canAddMoreFiles\"),t.events={},t.events.fileuploadstart=$.proxy(this,\"_onUploadStart\"),t.events.fileuploadprogressall=$.proxy(this,\"_onUploadProgress\"),t.events.fileuploaddone=$.proxy(this,\"_onUploadComplete\"),this.uploader=new Craft.Uploader(this.$container,t)},selectUploadedFile:function(t){if(this.canAddMoreElements()){var e=t.$element;e.addClass(\"removable\"),e.prepend('<input type=\"hidden\" name=\"'+this.settings.name+'[]\" value=\"'+t.id+'\"><a class=\"delete icon\" title=\"'+Craft.t(\"app\",\"Remove\")+'\"></a>'),e.appendTo(this.$elementsContainer);var i=-(e.outerWidth()+10);this.$addElementBtn.css(\"margin-\"+Craft.left,i+\"px\");var s={};s[\"margin-\"+Craft.left]=0,this.$addElementBtn.velocity(s,\"fast\"),this.addElements(e),delete this.modal}},_onUploadStart:function(){this.progressBar.$progressBar.css({top:Math.round(this.$container.outerHeight()/2)-6}),this.$container.addClass(\"uploading\"),this.progressBar.resetProgressBar(),this.progressBar.showProgressBar()},_onUploadProgress:function(t,e){var i=parseInt(e.loaded/e.total*100,10);this.progressBar.setProgressPercentage(i)},_onUploadComplete:function(t,e){if(e.result.error)alert(e.result.error);else{var i={elementId:e.result.assetId,siteId:this.settings.criteria.siteId,size:this.settings.viewMode};Craft.postActionRequest(\"elements/get-element-html\",i,function(t){if(t.error)alert(t.error);else{var e=$(t.html);Craft.appendHeadHtml(t.headHtml),this.selectUploadedFile(Craft.getElementInfo(e))}this.uploader.isLastUpload()&&(this.progressBar.hideProgressBar(),this.$container.removeClass(\"uploading\"),window.draftEditor&&window.draftEditor.checkForm())}.bind(this)),Craft.cp.runQueue()}},canAddMoreFiles:function(t){return!this.settings.limit||this.$elements.length+t<this.settings.limit},_parseFilename:function(t){var e=t.split(\".\"),i=\"\";return 1<e.length&&(i=e.pop()),{extension:i,baseFileName:e.join(\".\")}},_renameHelper:function(t){$(\".renameHelper\",t).on(\"focus\",$.proxy(function(t){var e=t.currentTarget,i=this._parseFilename(e.value);\"\"===this.originalFilename&&\"\"===this.originalExtension&&(this.originalFilename=i.baseFileName,this.originalExtension=i.extension);var s=i.baseFileName.length;if(void 0!==e.selectionStart)e.selectionStart=0,e.selectionEnd=s;else if(document.selection&&document.selection.createRange){e.select();var n=document.selection.createRange();n.collapse(!0),n.moveEnd(\"character\",s),n.moveStart(\"character\",0),n.select()}},this))},resetOriginalFilename:function(){this.originalFilename=\"\",this.originalExtension=\"\"},validateElementForm:function(){var t=$(\".renameHelper\",this.elementEditor.hud.$hud.data(\"elementEditor\").$form),e=this._parseFilename(t.val());return e.extension===this.originalExtension||(\"\"===e.extension?this.originalFilename!==e.baseFileName?(t.val(e.baseFileName+\".\"+this.originalExtension),!0):confirm(Craft.t(\"app\",\"Are you sure you want to remove the extension \u201c.{ext}\u201d?\",{ext:this.originalExtension})):confirm(Craft.t(\"app\",\"Are you sure you want to change the extension from \u201c.{oldExt}\u201d to \u201c.{newExt}\u201d?\",{oldExt:this.originalExtension,newExt:e.extension})))}}),Craft.AssetSelectorModal=Craft.BaseElementSelectorModal.extend({$selectTransformBtn:null,_selectedTransform:null,init:function(t,e){e=$.extend({},Craft.AssetSelectorModal.defaults,e),this.base(t,e),e.transforms.length&&this.createSelectTransformButton(e.transforms)},createSelectTransformButton:function(t){if(t&&t.length){var e=$('<div class=\"btngroup\"/>').appendTo(this.$primaryButtons);this.$selectBtn.appendTo(e),this.$selectTransformBtn=$('<div class=\"btn menubtn disabled\">'+Craft.t(\"app\",\"Select transform\")+\"</div>\").appendTo(e);for(var i=$('<div class=\"menu\" data-align=\"right\"></div>').insertAfter(this.$selectTransformBtn),s=$(\"<ul></ul>\").appendTo(i),n=0;n<t.length;n++)$('<li><a data-transform=\"'+t[n].handle+'\">'+t[n].name+\"</a></li>\").appendTo(s);var a=new Garnish.MenuBtn(this.$selectTransformBtn,{onOptionSelect:$.proxy(this,\"onSelectTransform\")});a.disable(),this.$selectTransformBtn.data(\"menuButton\",a)}},onSelectionChange:function(t){var e=this.elementIndex.getSelectedElements(),i=!1;if(e.length&&this.settings.transforms.length){i=!0;for(var s=0;s<e.length&&$(\".element.hasthumb:first\",e[s]).length;s++);}var n=null;this.$selectTransformBtn&&(n=this.$selectTransformBtn.data(\"menuButton\")),i?(n&&n.enable(),this.$selectTransformBtn.removeClass(\"disabled\")):this.$selectTransformBtn&&(n&&n.disable(),this.$selectTransformBtn.addClass(\"disabled\")),this.base()},onSelectTransform:function(t){var e=$(t).data(\"transform\");this.selectImagesWithTransform(e)},selectImagesWithTransform:function(t){void 0===Craft.AssetSelectorModal.transformUrls[t]&&(Craft.AssetSelectorModal.transformUrls[t]={});for(var e=this.elementIndex.getSelectedElements(),i=[],s=0;s<e.length;s++){var n=$(e[s]),a=Craft.getElementInfo(n).id;void 0===Craft.AssetSelectorModal.transformUrls[t][a]&&i.push(a)}i.length?(this.showFooterSpinner(),this.fetchMissingTransformUrls(i,t,$.proxy(function(){this.hideFooterSpinner(),this.selectImagesWithTransform(t)},this))):(this._selectedTransform=t,this.selectElements(),this._selectedTransform=null)},fetchMissingTransformUrls:function(i,s,n){var a=i.pop(),t={assetId:a,handle:s};Craft.postActionRequest(\"assets/generate-transform\",t,$.proxy(function(t,e){Craft.AssetSelectorModal.transformUrls[s][a]=!1,\"success\"!==e||t.url&&(Craft.AssetSelectorModal.transformUrls[s][a]=t.url),i.length?this.fetchMissingTransformUrls(i,s,n):n()},this))},getElementInfo:function(t){var e=this.base(t);if(this._selectedTransform)for(var i=0;i<e.length;i++){var s=e[i].id;void 0!==Craft.AssetSelectorModal.transformUrls[this._selectedTransform][s]&&!1!==Craft.AssetSelectorModal.transformUrls[this._selectedTransform][s]&&(e[i].url=Craft.AssetSelectorModal.transformUrls[this._selectedTransform][s])}return e},onSelect:function(t){this.settings.onSelect(t,this._selectedTransform)}},{defaults:{canSelectImageTransforms:!1,transforms:[]},transformUrls:{}}),Craft.registerElementSelectorModalClass(\"craft\\\\elements\\\\Asset\",Craft.AssetSelectorModal),Craft.AuthManager=Garnish.Base.extend({remainingSessionTime:null,checkRemainingSessionTimer:null,showLoginModalTimer:null,decrementLogoutWarningInterval:null,showingLogoutWarningModal:!1,showingLoginModal:!1,logoutWarningModal:null,loginModal:null,$logoutWarningPara:null,$passwordInput:null,$passwordSpinner:null,$loginBtn:null,$loginErrorPara:null,submitLoginIfLoggedOut:!1,init:function(){this.updateRemainingSessionTime(Craft.remainingSessionTime)},setCheckRemainingSessionTimer:function(t){this.checkRemainingSessionTimer&&clearTimeout(this.checkRemainingSessionTimer),this.checkRemainingSessionTimer=setTimeout($.proxy(this,\"checkRemainingSessionTime\"),1e3*t)},checkRemainingSessionTime:function(t){$.ajax({url:Craft.getActionUrl(\"users/get-remaining-session-time\",t?null:\"dontExtendSession=1\"),type:\"GET\",dataType:\"json\",complete:$.proxy(function(t,e){\"success\"===e?(void 0!==t.responseJSON.csrfTokenValue&&void 0!==Craft.csrfTokenValue&&(Craft.csrfTokenValue=t.responseJSON.csrfTokenValue),this.updateRemainingSessionTime(t.responseJSON.timeout),this.submitLoginIfLoggedOut=!1):this.updateRemainingSessionTime(-1)},this)})},updateRemainingSessionTime:function(t){this.remainingSessionTime=parseInt(t),-1!==this.remainingSessionTime&&this.remainingSessionTime<Craft.AuthManager.minSafeSessiotTime?(this.remainingSessionTime?(this.showingLogoutWarningModal||this.showLogoutWarningModal(),this.remainingSessionTime<Craft.AuthManager.checkInterval&&(this.showLoginModalTimer&&clearTimeout(this.showLoginModalTimer),this.showLoginModalTimer=setTimeout($.proxy(this,\"showLoginModal\"),1e3*this.remainingSessionTime))):this.showingLoginModal?this.submitLoginIfLoggedOut&&this.submitLogin():this.showLoginModal(),this.setCheckRemainingSessionTimer(Craft.AuthManager.checkInterval)):(this.hideLogoutWarningModal(),this.hideLoginModal(),-1!==this.remainingSessionTime&&this.remainingSessionTime<Craft.AuthManager.minSafeSessiotTime+Craft.AuthManager.checkInterval?this.setCheckRemainingSessionTimer(this.remainingSessionTime-Craft.AuthManager.minSafeSessiotTime+1):this.setCheckRemainingSessionTimer(Craft.AuthManager.checkInterval))},showLogoutWarningModal:function(){var t;if(t=!!this.showingLoginModal&&(this.hideLoginModal(!0),!0),this.showingLogoutWarningModal=!0,!this.logoutWarningModal){var e=$('<form id=\"logoutwarningmodal\" class=\"modal alert fitted\"/>'),i=$('<div class=\"body\"/>').appendTo(e),s=$('<div class=\"buttons right\"/>').appendTo(i),n=$('<div class=\"btn\">'+Craft.t(\"app\",\"Log out now\")+\"</div>\").appendTo(s),a=$('<input type=\"submit\" class=\"btn submit\" value=\"'+Craft.t(\"app\",\"Keep me logged in\")+'\" />').appendTo(s);this.$logoutWarningPara=$(\"<p/>\").prependTo(i),this.logoutWarningModal=new Garnish.Modal(e,{autoShow:!1,closeOtherModals:!1,hideOnEsc:!1,hideOnShadeClick:!1,shadeClass:\"modal-shade dark logoutwarningmodalshade\",onFadeIn:function(){Garnish.isMobileBrowser(!0)||setTimeout(function(){a.trigger(\"focus\")},100)}}),this.addListener(n,\"activate\",\"logout\"),this.addListener(e,\"submit\",\"renewSession\")}t?this.logoutWarningModal.quickShow():this.logoutWarningModal.show(),this.updateLogoutWarningMessage(),this.decrementLogoutWarningInterval=setInterval($.proxy(this,\"decrementLogoutWarning\"),1e3)},updateLogoutWarningMessage:function(){this.$logoutWarningPara.text(Craft.t(\"app\",\"Your session will expire in {time}.\",{time:Craft.secondsToHumanTimeDuration(this.remainingSessionTime)})),this.logoutWarningModal.updateSizeAndPosition()},decrementLogoutWarning:function(){0<this.remainingSessionTime&&(this.remainingSessionTime--,this.updateLogoutWarningMessage()),0===this.remainingSessionTime&&clearInterval(this.decrementLogoutWarningInterval)},hideLogoutWarningModal:function(t){this.showingLogoutWarningModal=!1,this.logoutWarningModal&&(t?this.logoutWarningModal.quickHide():this.logoutWarningModal.hide(),this.decrementLogoutWarningInterval&&clearInterval(this.decrementLogoutWarningInterval))},showLoginModal:function(){var t;if(t=!!this.showingLogoutWarningModal&&(this.hideLogoutWarningModal(!0),!0),this.showingLoginModal=!0,!this.loginModal){var e=$('<form id=\"loginmodal\" class=\"modal alert fitted\"/>'),i=$('<div class=\"body\"><h2>'+Craft.t(\"app\",\"Your session has ended.\")+\"</h2><p>\"+Craft.t(\"app\",\"Enter your password to log back in.\")+\"</p></div>\").appendTo(e),s=$('<div class=\"inputcontainer\">').appendTo(i),n=$('<div class=\"flex\"/>').appendTo(s),a=$('<div class=\"flex-grow\"/>').appendTo(n),r=$(\"<div/>\").appendTo(n),o=$('<div class=\"passwordwrapper\"/>').appendTo(a);this.$passwordInput=$('<input type=\"password\" class=\"text password fullwidth\" placeholder=\"'+Craft.t(\"app\",\"Password\")+'\"/>').appendTo(o),this.$passwordSpinner=$('<div class=\"spinner hidden\"/>').appendTo(s),this.$loginBtn=$('<input type=\"submit\" class=\"btn submit disabled\" value=\"'+Craft.t(\"app\",\"Login\")+'\" />').appendTo(r),this.$loginErrorPara=$('<p class=\"error\"/>').appendTo(i),this.loginModal=new Garnish.Modal(e,{autoShow:!1,closeOtherModals:!1,hideOnEsc:!1,hideOnShadeClick:!1,shadeClass:\"modal-shade dark loginmodalshade\",onFadeIn:$.proxy(function(){Garnish.isMobileBrowser(!0)||setTimeout($.proxy(function(){this.$passwordInput.trigger(\"focus\")},this),100)},this),onFadeOut:$.proxy(function(){this.$passwordInput.val(\"\")},this)}),new Craft.PasswordInput(this.$passwordInput,{onToggleInput:$.proxy(function(t){this.$passwordInput=t},this)}),this.addListener(this.$passwordInput,\"textchange\",\"validatePassword\"),this.addListener(e,\"submit\",\"login\")}t?this.loginModal.quickShow():this.loginModal.show()},hideLoginModal:function(t){this.showingLoginModal=!1,this.loginModal&&(t?this.loginModal.quickHide():this.loginModal.hide())},logout:function(){$.get({url:Craft.getActionUrl(\"users/logout\"),dataType:\"json\",success:$.proxy(function(){Craft.redirectTo(\"\")},this)})},renewSession:function(t){t&&t.preventDefault(),this.hideLogoutWarningModal(),this.checkRemainingSessionTime(!0)},validatePassword:function(){return 6<=this.$passwordInput.val().length?(this.$loginBtn.removeClass(\"disabled\"),!0):(this.$loginBtn.addClass(\"disabled\"),!1)},login:function(t){t&&t.preventDefault(),this.validatePassword()&&(this.$passwordSpinner.removeClass(\"hidden\"),this.clearLoginError(),void 0!==Craft.csrfTokenValue?(this.submitLoginIfLoggedOut=!0,this.checkRemainingSessionTime()):this.submitLogin())},submitLogin:function(){var t={loginName:Craft.username,password:this.$passwordInput.val()};Craft.postActionRequest(\"users/login\",t,$.proxy(function(t,e){this.$passwordSpinner.addClass(\"hidden\"),\"success\"===e?t.success?(this.hideLoginModal(),this.checkRemainingSessionTime()):(this.showLoginError(t.error),Garnish.shake(this.loginModal.$container),Garnish.isMobileBrowser(!0)||this.$passwordInput.trigger(\"focus\")):this.showLoginError()},this))},showLoginError:function(t){null==t&&(t=Craft.t(\"app\",\"An unknown error occurred.\")),this.$loginErrorPara.text(t),this.loginModal.updateSizeAndPosition()},clearLoginError:function(){this.showLoginError(\"\")}},{checkInterval:60,minSafeSessiotTime:120}),Craft.CategoryIndex=Craft.BaseElementIndex.extend({editableGroups:null,$newCategoryBtnGroup:null,$newCategoryBtn:null,init:function(t,e,i){this.on(\"selectSource\",$.proxy(this,\"updateButton\")),this.on(\"selectSite\",$.proxy(this,\"updateButton\")),this.base(t,e,i)},afterInit:function(){this.editableGroups=[];for(var t=0;t<Craft.editableCategoryGroups.length;t++){var e=Craft.editableCategoryGroups[t];this.getSourceByKey(\"group:\"+e.uid)&&this.editableGroups.push(e)}this.base()},getDefaultSourceKey:function(){if(\"index\"===this.settings.context&&\"undefined\"!=typeof defaultGroupHandle)for(var t=0;t<this.$sources.length;t++){var e=$(this.$sources[t]);if(e.data(\"handle\")===defaultGroupHandle)return e.data(\"key\")}return this.base()},updateButton:function(){if(this.$source){var t,e,i,s=this.$source.data(\"handle\");if(this.editableGroups.length){var n,a;if(this.$newCategoryBtnGroup&&this.$newCategoryBtnGroup.remove(),s)for(t=0;t<this.editableGroups.length;t++)if(this.editableGroups[t].handle===s){n=this.editableGroups[t];break}if(this.$newCategoryBtnGroup=$('<div class=\"btngroup submit\"/>'),n?(e=this._getGroupTriggerHref(n),i=\"index\"===this.settings.context?Craft.t(\"app\",\"New category\"):Craft.t(\"app\",\"New {group} category\",{group:n.name}),this.$newCategoryBtn=$('<a class=\"btn submit add icon\" '+e+\">\"+Craft.escapeHtml(i)+\"</a>\").appendTo(this.$newCategoryBtnGroup),\"index\"!==this.settings.context&&this.addListener(this.$newCategoryBtn,\"click\",function(t){this._openCreateCategoryModal(t.currentTarget.getAttribute(\"data-id\"))}),1<this.editableGroups.length&&(a=$('<div class=\"btn submit menubtn\"></div>').appendTo(this.$newCategoryBtnGroup))):this.$newCategoryBtn=a=$('<div class=\"btn submit add icon menubtn\">'+Craft.t(\"app\",\"New category\")+\"</div>\").appendTo(this.$newCategoryBtnGroup),a){var r='<div class=\"menu\"><ul>';for(t=0;t<this.editableGroups.length;t++){var o=this.editableGroups[t];\"index\"!==this.settings.context&&o===n||(e=this._getGroupTriggerHref(o),i=\"index\"===this.settings.context?o.name:Craft.t(\"app\",\"New {group} category\",{group:o.name}),r+=\"<li><a \"+e+'\">'+Craft.escapeHtml(i)+\"</a></li>\")}$(r+=\"</ul></div>\").appendTo(this.$newCategoryBtnGroup);var l=new Garnish.MenuBtn(a);\"index\"!==this.settings.context&&l.on(\"optionSelect\",$.proxy(function(t){this._openCreateCategoryModal(t.option.getAttribute(\"data-id\"))},this))}this.addButton(this.$newCategoryBtnGroup)}if(\"index\"===this.settings.context&&\"undefined\"!=typeof history){var h=\"categories\";s&&(h+=\"/\"+s),history.replaceState({},\"\",Craft.getUrl(h))}}},_getGroupTriggerHref:function(t){if(\"index\"!==this.settings.context)return'data-id=\"'+t.id+'\"';var e=\"categories/\"+t.handle+\"/new\";if(this.siteId&&this.siteId!=Craft.primarySiteId)for(var i=0;i<Craft.sites.length;i++)Craft.sites[i].id==this.siteId&&(e+=\"/\"+Craft.sites[i].handle);return'href=\"'+Craft.getUrl(e)+'\"'},_openCreateCategoryModal:function(t){if(!this.$newCategoryBtn.hasClass(\"loading\")){for(var i,e=0;e<this.editableGroups.length;e++)if(this.editableGroups[e].id==t){i=this.editableGroups[e];break}if(i){this.$newCategoryBtn.addClass(\"inactive\");var s=this.$newCategoryBtn.text();this.$newCategoryBtn.text(Craft.t(\"app\",\"New {group} category\",{group:i.name})),Craft.createElementEditor(this.elementType,{hudTrigger:this.$newCategoryBtnGroup,elementType:\"craft\\\\elements\\\\Category\",siteId:this.siteId,attributes:{groupId:t},onBeginLoading:$.proxy(function(){this.$newCategoryBtn.addClass(\"loading\")},this),onEndLoading:$.proxy(function(){this.$newCategoryBtn.removeClass(\"loading\")},this),onHideHud:$.proxy(function(){this.$newCategoryBtn.removeClass(\"inactive\").text(s)},this),onSaveElement:$.proxy(function(t){var e=\"group:\"+i.uid;this.sourceKey!==e&&this.selectSourceByKey(e),this.selectElementAfterUpdate(t.id),this.updateElements()},this)})}}}}),Craft.registerElementIndexClass(\"craft\\\\elements\\\\Category\",Craft.CategoryIndex),Craft.CategorySelectInput=Craft.BaseElementSelectInput.extend({setSettings:function(){this.base.apply(this,arguments),this.settings.sortable=!1},getModalSettings:function(){var t=this.base();return t.hideOnSelect=!1,t},getElements:function(){return this.$elementsContainer.find(\".element\")},onModalSelect:function(o){this.modal.disable(),this.modal.disableCancelBtn(),this.modal.disableSelectBtn(),this.modal.showFooterSpinner();for(var t=this.getSelectedElementIds(),e=0;e<o.length;e++)t.push(o[e].id);var i={categoryIds:t,siteId:o[0].siteId,id:this.settings.id,name:this.settings.name,branchLimit:this.settings.branchLimit,selectionLabel:this.settings.selectionLabel};Craft.postActionRequest(\"elements/get-categories-input-html\",i,$.proxy(function(t,e){if(this.modal.enable(),this.modal.enableCancelBtn(),this.modal.enableSelectBtn(),this.modal.hideFooterSpinner(),\"success\"===e){var i=$(t.html).children(\".elements\");this.$elementsContainer.replaceWith(i),this.$elementsContainer=i,this.resetElements();for(var s=[],n=0;n<o.length;n++){var a=o[n],r=this.getElementById(a.id);r&&(this.animateElementIntoPlace(a.$element,r),s.push(a))}this.updateDisabledElementsInModal(),this.modal.hide(),this.onSelectElements(s)}},this))},removeElement:function(t){var e=t.add(t.parent().siblings(\"ul\").find(\".element\"));this.removeElements(e);for(var i=0;i<e.length;i++)this._animateCategoryAway(e,i)},_animateCategoryAway:function(i,t){var e;t===i.length-1&&(e=$.proxy(function(){var t=i.first().parent().parent(),e=t.parent();e[0]===this.$elementsContainer[0]||t.siblings().length?t.remove():e.remove()},this));var s=$.proxy(function(){this.animateElementAway(i.eq(t),e)},this);0===t?s():setTimeout(s,100*t)}}),Craft.charts={},Craft.charts.DataTable=Garnish.Base.extend({columns:null,rows:null,init:function(t){columns=t.columns,rows=t.rows,rows.forEach($.proxy(function(i){$.each(i,function(t){var e;switch(columns[t].type){case\"date\":e=d3.timeParse(\"%Y-%m-%d\"),i[t]=e(i[t]);break;case\"datetime\":e=d3.timeParse(\"%Y-%m-%d %H:00:00\"),i[t]=e(i[t]);break;case\"percent\":i[t]=i[t]/100;break;case\"number\":i[t]=+i[t]}})},this)),this.columns=columns,this.rows=rows}}),Craft.charts.Tip=Garnish.Base.extend({$container:null,$tip:null,init:function(t){this.$container=t,this.$tip=$('<div class=\"tooltip\"></div>').appendTo(this.$container),this.hide()},setContent:function(t){this.$tip.html(t)},setPosition:function(t){this.$tip.css(\"left\",t.left+\"px\"),this.$tip.css(\"top\",t.top+\"px\")},show:function(){this.$tip.css(\"display\",\"block\")},hide:function(){this.$tip.css(\"display\",\"none\")}}),Craft.charts.BaseChart=Garnish.Base.extend({$container:null,$chart:null,chartBaseClass:\"cp-chart\",dataTable:null,formatLocale:null,timeFormatLocale:null,orientation:null,svg:null,width:null,height:null,init:function(t,e){this.$container=t,this.setSettings(Craft.charts.BaseChart.defaults),this.setSettings(e);var i={formats:window.d3Formats,formatLocaleDefinition:window.d3FormatLocaleDefinition,timeFormatLocaleDefinition:window.d3TimeFormatLocaleDefinition};this.setSettings(i),d3.select(window).on(\"resize\",$.proxy(function(){this.resize()},this))},setSettings:function(t,e){var i=void 0===this.settings?{}:this.settings;this.settings=$.extend(!0,{},i,e,t)},draw:function(t,e){this.setSettings(e),this.dataTable=t,this.formatLocale=d3.formatLocale(this.settings.formatLocaleDefinition),this.timeFormatLocale=d3.timeFormatLocale(this.settings.timeFormatLocaleDefinition),this.orientation=this.settings.orientation,this.$chart&&this.$chart.remove();var i=this.chartBaseClass;this.settings.chartClass&&(i+=\" \"+this.settings.chartClass),this.$chart=$('<div class=\"'+i+'\" />').appendTo(this.$container)},resize:function(){this.draw(this.dataTable,this.settings)},onAfterDrawTicks:function(){$(\".tick\",this.$chart).each(function(t,e){var i=$(\"text\",e);i.clone().appendTo(e),i.attr(\"stroke\",\"#ffffff\"),i.attr(\"stroke-width\",3)})}},{defaults:{formatLocaleDefinition:null,timeFormatLocaleDefinition:null,formats:{numberFormat:\",.2f\",percentFormat:\",.2%\",currencyFormat:\"$,.2f\",shortDateFormats:{day:\"%-m/%-d\",month:\"%-m/%y\",year:\"%Y\"}},margin:{top:0,right:0,bottom:0,left:0},chartClass:null,colors:[\"#0594D1\",\"#DE3800\",\"#FF9A00\",\"#009802\",\"#9B009B\"]}}),Craft.charts.Area=Craft.charts.BaseChart.extend({tip:null,drawingArea:null,init:function(t,e){this.base(t,Craft.charts.Area.defaults),this.setSettings(e)},draw:function(t,e){this.base(t,e),this.tip&&(this.tip=null);var i=this.getChartMargin();this.width=this.$chart.width()-i.left-i.right,this.height=this.$chart.height()-i.top-i.bottom;var s={width:this.width+(i.left+i.right),height:this.height+(i.top+i.bottom),translateX:\"rtl\"!==this.orientation?i.left:i.right,translateY:i.top};this.svg=d3.select(this.$chart.get(0)).append(\"svg\").attr(\"width\",s.width).attr(\"height\",s.height),this.drawingArea=this.svg.append(\"g\").attr(\"transform\",\"translate(\"+s.translateX+\",\"+s.translateY+\")\"),this.drawTicks(),this.drawAxes(),this.drawChart(),this.drawTipTriggers()},drawTicks:function(){var t=this.getX(!0),e=d3.axisBottom(t).tickFormat(this.getXFormatter()).ticks(3);this.drawingArea.append(\"g\").attr(\"class\",\"x ticks-axis\").attr(\"transform\",\"translate(0, \"+this.height+\")\").call(e);var i,s=this.getY();\"rtl\"!==this.orientation?(i=d3.axisLeft(s).tickFormat(this.getYFormatter()).tickValues(this.getYTickValues()).ticks(2),this.drawingArea.append(\"g\").attr(\"class\",\"y ticks-axis\").call(i)):(i=d3.axisRight(s).tickFormat(this.getYFormatter()).tickValues(this.getYTickValues()).ticks(2),this.drawingArea.append(\"g\").attr(\"class\",\"y ticks-axis\").attr(\"transform\",\"translate(\"+this.width+\",0)\").call(i)),this.onAfterDrawTicks()},drawAxes:function(){if(this.settings.xAxis.showAxis){var t=this.getX(),e=d3.axisBottom(t).ticks(0).tickSizeOuter(0);this.drawingArea.append(\"g\").attr(\"class\",\"x axis\").attr(\"transform\",\"translate(0, \"+this.height+\")\").call(e)}if(this.settings.yAxis.showAxis){var i,s=this.getY();\"rtl\"===this.orientation?(i=d3.axisLeft(s).ticks(0),this.drawingArea.append(\"g\").attr(\"class\",\"y axis\").attr(\"transform\",\"translate(\"+(this.width-0)+\", 0)\").call(i)):(i=d3.axisRight(s).ticks(0),this.drawingArea.append(\"g\").attr(\"class\",\"y axis\").attr(\"transform\",\"translate(0, 0)\").call(i))}},drawChart:function(){var e=this.getX(!0),i=this.getY();if(this.settings.xAxis.gridlines){var t=d3.axisBottom(e);this.drawingArea.append(\"g\").attr(\"class\",\"x grid-line\").attr(\"transform\",\"translate(0,\"+this.height+\")\").call(t.tickSize(-this.height,0,0).tickFormat(\"\"))}if(this.settings.yAxis.gridlines){var s=d3.axisLeft(i);this.drawingArea.append(\"g\").attr(\"class\",\"y grid-line\").attr(\"transform\",\"translate(0 , 0)\").call(s.tickSize(-this.width,0).tickFormat(\"\").tickValues(this.getYTickValues()).ticks(2))}var n=d3.line().x(function(t){return e(t[0])}).y(function(t){return i(t[1])});this.drawingArea.append(\"g\").attr(\"class\",\"chart-line\").append(\"path\").datum(this.dataTable.rows).style(\"fill\",\"none\").style(\"stroke\",this.settings.colors[0]).style(\"stroke-width\",\"3px\").attr(\"d\",n);var a=d3.area().x(function(t){return e(t[0])}).y0(this.height).y1(function(t){return i(t[1])});this.drawingArea.append(\"g\").attr(\"class\",\"chart-area\").append(\"path\").datum(this.dataTable.rows).style(\"fill\",this.settings.colors[0]).style(\"fill-opacity\",\"0.3\").attr(\"d\",a),this.settings.plots&&this.drawingArea.append(\"g\").attr(\"class\",\"plots\").selectAll(\"circle\").data(this.dataTable.rows).enter().append(\"circle\").style(\"fill\",this.settings.colors[0]).attr(\"class\",$.proxy(function(t,e){return\"plot plot-\"+e},this)).attr(\"r\",4).attr(\"cx\",$.proxy(function(t){return e(t[0])},this)).attr(\"cy\",$.proxy(function(t){return i(t[1])},this))},drawTipTriggers:function(){if(this.settings.tips){this.tip||(this.tip=new Craft.charts.Tip(this.$chart));var t=this.getChartMargin(),e=(this.drawingArea.select(\".x path.domain\").node().getTotalLength()-t.left-t.right-12)/(this.dataTable.rows.length-1),i=Math.max(0,e),c=this.getX(!0),u=this.getY();this.drawingArea.append(\"g\").attr(\"class\",\"tip-triggers\").selectAll(\"rect\").data(this.dataTable.rows).enter().append(\"rect\").attr(\"class\",\"tip-trigger\").style(\"fill\",\"transparent\").style(\"fill-opacity\",\"1\").attr(\"width\",i).attr(\"height\",this.height).attr(\"x\",$.proxy(function(t){return c(t[0])-i/2},this)).on(\"mouseover\",$.proxy(function(t,e){this.drawingArea.select(\".plot-\"+e).attr(\"r\",5);var i=$(\"<div />\"),s=$('<div class=\"x-value\" />').appendTo(i),n=$('<div class=\"y-value\" />').appendTo(i);s.html(this.getXFormatter()(t[0])),n.html(this.getYFormatter()(t[1]));var a=i.get(0);this.tip.setContent(a);var r,o=this.getChartMargin(),l=u(t[1])+24;if(\"rtl\"!==this.orientation){r=c(t[0])+o.left+24;var h=this.$chart.offset().left+r+this.tip.$tip.width();this.$chart.offset().left+this.$chart.width()-24<h&&(r=c(t[0])-(this.tip.$tip.width()+24))}else r=c(t[0])-(this.tip.$tip.width()+o.left+24);r<0&&(r=c(t[0])+o.left+24);var d={top:l,left:r};this.tip.setPosition(d),this.tip.show()},this)).on(\"mouseout\",$.proxy(function(t,e){this.drawingArea.select(\".plot-\"+e).attr(\"r\",4),this.tip.hide()},this))}},getChartMargin:function(){var t=this.settings.margin,e=this.getYTickValues(),s=0;return $.each(e,$.proxy(function(t,e){var i=8*this.getYFormatter()(e).length;s<i&&(s=i)},this)),s+=10,t.left=s,t},getX:function(t){var e=d3.min(this.dataTable.rows,function(t){return t[0]}),i=d3.max(this.dataTable.rows,function(t){return t[0]}),s=[e,i];\"rtl\"===this.orientation&&(s=[i,e]);var n=0,a=0;t&&(a=n=0);var r=d3.scaleTime().range([n,this.width-a]);return r.domain(s),r},getY:function(){var t=[0,this.getYMaxValue()],e=d3.scaleLinear().range([this.height,0]);return e.domain(t),e},getXFormatter:function(){return this.settings.xAxis.formatter!==$.noop?this.settings.xAxis.formatter(this):Craft.charts.utils.getTimeFormatter(this.timeFormatLocale,this.settings)},getYFormatter:function(){return this.settings.yAxis.formatter!==$.noop?this.settings.yAxis.formatter(this):Craft.charts.utils.getNumberFormatter(this.formatLocale,this.dataTable.columns[1].type,this.settings)},getYMaxValue:function(){return d3.max(this.dataTable.rows,function(t){return t[1]})},getYTickValues:function(){var t=this.getYMaxValue();return 1<t?[t/2,t]:[0,t]}},{defaults:{chartClass:\"area\",margin:{top:25,right:5,bottom:25,left:0},plots:!0,tips:!0,xAxis:{gridlines:!1,showAxis:!0,formatter:$.noop},yAxis:{gridlines:!0,showAxis:!1,formatter:$.noop}}}),Craft.charts.utils={getDuration:function(t){var e=parseInt(t,10),i={hours:Math.floor(e/3600),minutes:Math.floor((e-3600*i.hours)/60),seconds:e-3600*i.hours-60*i.minutes};return i.hours<10&&(i.hours=\"0\"+i.hours),i.minutes<10&&(i.minutes=\"0\"+i.minutes),i.seconds<10&&(i.seconds=\"0\"+i.seconds),i.hours+\":\"+i.minutes+\":\"+i.seconds},getTimeFormatter:function(t,e){switch(e.dataScale){case\"year\":return t.format(\"%Y\");case\"month\":return t.format(e.formats.shortDateFormats.month);case\"hour\":return t.format(e.formats.shortDateFormats.day+\" %H:00:00\");default:return t.format(e.formats.shortDateFormats.day)}},getNumberFormatter:function(t,e,i){switch(e){case\"currency\":return t.format(i.formats.currencyFormat);case\"percent\":return t.format(i.formats.percentFormat);case\"time\":return Craft.charts.utils.getDuration;case\"number\":return t.format(i.formats.numberFormat)}}},Craft.ColorInput=Garnish.Base.extend({$container:null,$input:null,$colorContainer:null,$colorPreview:null,$colorInput:null,init:function(t){this.$container=$(t),this.$input=this.$container.children(\".color-input\"),this.$colorContainer=this.$container.children(\".color\"),this.$colorPreview=this.$colorContainer.children(\".color-preview\"),this.createColorInput(),this.handleTextChange(),this.addListener(this.$input,\"textchange\",\"handleTextChange\")},createColorInput:function(){var t=document.createElement(\"input\");t.setAttribute(\"type\",\"color\"),\"color\"===t.type&&(this.$colorContainer.removeClass(\"static\"),this.$colorInput=$(t).addClass(\"hidden\").insertAfter(this.$input),this.addListener(this.$colorContainer,\"click\",function(){this.$colorInput.trigger(\"click\")}),this.addListener(this.$colorInput,\"change\",\"updateColor\"))},updateColor:function(){this.$input.val(this.$colorInput.val()),this.$input.data(\"garnish-textchange-value\",this.$colorInput.val()),this.handleTextChange()},handleTextChange:function(){var t=this.$input.val();t.length&&\"#\"!==t?(\"#\"!==t[0]&&(t=\"#\"+t,this.$input.val(t),this.$input.data(\"garnish-textchange-value\",t)),this.$colorPreview.css(\"background-color\",t),this.$colorInput&&this.$colorInput.val(t)):this.$colorPreview.css(\"background-color\",\"\")}},{_browserSupportsColorInputs:null,doesBrowserSupportColorInputs:function(){return Craft.ColorInput._browserSupportsColorInputs,Craft.ColorInput._browserSupportsColorInputs}}),Craft.CP=Garnish.Base.extend({authManager:null,$nav:null,$mainContainer:null,$alerts:null,$crumbs:null,$notificationContainer:null,$main:null,$primaryForm:null,$header:null,$mainContent:null,$details:null,$selectedTab:null,$sidebar:null,$contentContainer:null,$edition:null,$collapsibleTables:null,fixedHeader:!1,enableQueue:!0,jobInfo:null,displayedJobInfo:null,displayedJobInfoUnchanged:1,trackJobProgressTimeout:null,jobProgressIcon:null,checkingForUpdates:!1,forcingRefreshOnUpdatesCheck:!1,checkForUpdatesCallbacks:null,init:function(){0!==Craft.remainingSessionTime&&(this.authManager=new Craft.AuthManager),this.$nav=$(\"#nav\"),this.$mainContainer=$(\"#main-container\"),this.$alerts=$(\"#alerts\"),this.$crumbs=$(\"#crumbs\"),this.$notificationContainer=$(\"#notifications\"),this.$main=$(\"#main\"),this.$primaryForm=$(\"#main-form\"),this.$header=$(\"#header\"),this.$mainContent=$(\"#main-content\"),this.$details=$(\"#details\"),this.$sidebar=$(\"#sidebar\"),this.$contentContainer=$(\"#content-container\"),this.$collapsibleTables=$(\"table.collapsible\"),this.$edition=$(\"#edition\"),this.updateSidebarMenuLabel(),this.addListener(Garnish.$win,\"scroll\",\"updateFixedHeader\"),this.updateFixedHeader(),Garnish.$doc.ready($.proxy(function(){this.addListener(Garnish.$win,\"resize\",\"updateResponsiveTables\"),this.updateResponsiveTables();var t=this.$notificationContainer.children(\".error\"),e=this.$notificationContainer.children(\":not(.error)\");t.delay(2*Craft.CP.notificationDuration).velocity(\"fadeOut\"),e.delay(Craft.CP.notificationDuration).velocity(\"fadeOut\"),Garnish.requestAnimationFrame($.proxy(this,\"initConfirmUnloadForms\"))},this)),this.$alerts.length&&this.initAlerts(),this.addListener($(\"#nav-toggle\"),\"click\",\"toggleNav\"),this.addListener($(\"#sidebar-toggle\"),\"click\",\"toggleSidebar\"),this.$primaryForm.length||(this.$primaryForm=$(\"form[data-saveshortcut]:first\")),this.$primaryForm.length&&Garnish.hasAttr(this.$primaryForm,\"data-saveshortcut\")&&this.addListener(Garnish.$doc,\"keydown\",function(t){return Garnish.isCtrlKeyPressed(t)&&t.keyCode===Garnish.S_KEY&&(t.preventDefault(),this.submitPrimaryForm()),!0}),this.initTabs(),this.$edition.hasClass(\"hot\")&&this.addListener(this.$edition,\"click\",function(){document.location.href=Craft.getUrl(\"plugin-store/upgrade-craft\")}),$.isTouchCapable()&&(this.$mainContainer.on(\"focus\",\"input, textarea, .focusable-input\",$.proxy(this,\"_handleInputFocus\")),this.$mainContainer.on(\"blur\",\"input, textarea, .focusable-input\",$.proxy(this,\"_handleInputBlur\"))),$(\"a\").each(function(){this.hostname.length&&this.hostname!==location.hostname&&void 0===$(this).attr(\"target\")&&$(this).attr(\"rel\",\"noopener\").attr(\"target\",\"_blank\")})},initConfirmUnloadForms:function(){if(this.$confirmUnloadForms=$(\"form[data-confirm-unload]\"),this.$confirmUnloadForms.length){for(var t,e,i=0;i<this.$confirmUnloadForms.length;i++)(t=this.$confirmUnloadForms.eq(i)).data(\"initialSerializedValue\")||(e=\"function\"==typeof t.data(\"serializer\")?t.data(\"serializer\")():t.serialize(),t.data(\"initialSerializedValue\",e)),this.addListener(t,\"submit\",function(){this.removeListener(Garnish.$win,\"beforeunload\")});this.addListener(Garnish.$win,\"beforeunload\",function(t){var e,i,s=!1;if(void 0!==Craft.livePreview&&Craft.livePreview.inPreviewMode)s=!0;else for(var n=0;n<this.$confirmUnloadForms.length;n++)if(i=\"function\"==typeof(e=this.$confirmUnloadForms.eq(n)).data(\"serializer\")?e.data(\"serializer\")():e.serialize(),e.data(\"initialSerializedValue\")!==i){s=!0;break}if(s){var a=Craft.t(\"app\",\"Any changes will be lost if you leave this page.\");return t?t.originalEvent.returnValue=a:window.event.returnValue=a,a}})}},_handleInputFocus:function(){this.updateFixedHeader()},_handleInputBlur:function(){this.updateFixedHeader()},submitPrimaryForm:function(){this.trigger(\"beforeSaveShortcut\"),this.$primaryForm.data(\"saveshortcut-redirect\")&&$('<input type=\"hidden\" name=\"redirect\" value=\"'+this.$primaryForm.data(\"saveshortcut-redirect\")+'\"/>').appendTo(this.$primaryForm),this.$primaryForm.trigger({type:\"submit\",saveShortcut:!0})},updateSidebarMenuLabel:function(){var t=this.$sidebar.find(\"a.sel:first\"),e=t.children(\".label\");$(\"#selected-sidebar-item-label\").text(e.length?e.text():t.text()),Garnish.$bod.removeClass(\"showing-sidebar\")},toggleNav:function(){Garnish.$bod.toggleClass(\"showing-nav\")},toggleSidebar:function(){Garnish.$bod.toggleClass(\"showing-sidebar\")},initTabs:function(){this.$selectedTab=null;var t,e,i,s=$(\"#tabs\").find(\"> ul > li\"),n=[],a=[],r=0;for(t=0;t<s.length;t++)n[t]=$(s[t]),a[t]=n[t].width(),r+=a[t],(i=(e=n[t].children(\"a\")).attr(\"href\"))&&\"#\"===i.charAt(0)&&(this.addListener(e,\"click\",function(t){t.preventDefault(),this.selectTab(t.currentTarget)}),encodeURIComponent(i.substr(1))===document.location.hash.substr(1)&&this.selectTab(e)),!this.$selectedTab&&e.hasClass(\"sel\")&&(this.$selectedTab=e);for(t=0;t<s.length;t++)n[t].css(\"max-width\",100*a[t]/r+\"%\")},selectTab:function(t){var e=$(t);if(this.$selectedTab){if(this.$selectedTab.get(0)===e.get(0))return;this.deselectTab()}e.addClass(\"sel\");var i=e.attr(\"href\");$(i).removeClass(\"hidden\"),\"undefined\"!=typeof history&&history.replaceState(void 0,void 0,i),Garnish.$win.trigger(\"resize\"),Garnish.$doc.trigger(\"scroll\"),this.$selectedTab=e},deselectTab:function(){this.$selectedTab&&(this.$selectedTab.removeClass(\"sel\"),\"#\"===this.$selectedTab.attr(\"href\").charAt(0)&&$(this.$selectedTab.attr(\"href\")).addClass(\"hidden\"),this.$selectedTab=null)},updateResponsiveTables:function(){for(this.updateResponsiveTables._i=0;this.updateResponsiveTables._i<this.$collapsibleTables.length;this.updateResponsiveTables._i++)this.updateResponsiveTables._$table=this.$collapsibleTables.eq(this.updateResponsiveTables._i),this.updateResponsiveTables._containerWidth=this.updateResponsiveTables._$table.parent().width(),this.updateResponsiveTables._check=!1,0<this.updateResponsiveTables._containerWidth&&(void 0===this.updateResponsiveTables._$table.data(\"lastContainerWidth\")?this.updateResponsiveTables._check=!0:(this.updateResponsiveTables._isCollapsed=this.updateResponsiveTables._$table.hasClass(\"collapsed\"),this.updateResponsiveTables._containerWidth>this.updateResponsiveTables._$table.data(\"lastContainerWidth\")?this.updateResponsiveTables._isCollapsed&&(this.updateResponsiveTables._$table.removeClass(\"collapsed\"),this.updateResponsiveTables._check=!0):this.updateResponsiveTables._isCollapsed||(this.updateResponsiveTables._check=!0)),!this.updateResponsiveTables._check||this.updateResponsiveTables._$table.width()>this.updateResponsiveTables._containerWidth&&this.updateResponsiveTables._$table.addClass(\"collapsed\"),this.updateResponsiveTables._$table.data(\"lastContainerWidth\",this.updateResponsiveTables._containerWidth))},updateFixedHeader:function(){if(this.$main.length&&this.$main[0].getBoundingClientRect().top<0){if(!this.fixedHeader){var t=this.$header.outerHeight(),e={top:t+\"px\",\"max-height\":\"calc(100vh - \"+t+\"px)\"};this.$sidebar.css(e),this.$details.css(e),this.$mainContent.css(\"margin-top\",this.$header.outerHeight()),Garnish.$bod.addClass(\"fixed-header\"),this.fixedheader=!0}}else this.fixedheader&&(Garnish.$bod.removeClass(\"fixed-header\"),this.$details.css({top:null,\"max-height\":null}),this.$header.css(\"top\",0),this.$mainContent.css(\"margin-top\",0),this.fixedheader=!1)},displayNotification:function(t,e){var i=Craft.CP.notificationDuration;\"error\"===t&&(i*=2);var s=$('<div class=\"notification '+t+'\">'+e+\"</div>\").appendTo(this.$notificationContainer),n=-s.outerWidth()/2+\"px\";s.hide().css({opacity:0,\"margin-left\":n,\"margin-right\":n}).velocity({opacity:1,\"margin-left\":\"2px\",\"margin-right\":\"2px\"},{display:\"inline-block\",duration:\"fast\"}).delay(i).velocity({opacity:0,\"margin-left\":n,\"margin-right\":n},{complete:function(){s.remove()}}),this.trigger(\"displayNotification\",{notificationType:t,message:e})},displayNotice:function(t){this.displayNotification(\"notice\",t)},displayError:function(t){t||(t=Craft.t(\"app\",\"An unknown error occurred.\")),this.displayNotification(\"error\",t)},fetchAlerts:function(){var t={path:Craft.path};Craft.queueActionRequest(\"app/get-cp-alerts\",t,$.proxy(this,\"displayAlerts\"))},displayAlerts:function(t){if(this.$alerts.remove(),Garnish.isArray(t)&&t.length){this.$alerts=$('<ul id=\"alerts\"/>').prependTo(this.$mainContainer);for(var e=0;e<t.length;e++)$(\"<li>\"+t[e]+\"</li>\").appendTo(this.$alerts);var i=this.$alerts.outerHeight();this.$alerts.css(\"margin-top\",-i).velocity({\"margin-top\":0},\"fast\"),this.initAlerts()}},initAlerts:function(){for(var t=this.$alerts.find('a[class^=\"shun:\"]'),e=0;e<t.length;e++)this.addListener(t[e],\"click\",$.proxy(function(t){t.preventDefault();var i=$(t.currentTarget),e={message:i.prop(\"className\").substr(5)};Craft.queueActionRequest(\"app/shun-cp-alert\",e,$.proxy(function(t,e){\"success\"===e&&(t.success?i.parent().remove():this.displayError(t.error))},this))},this))},checkForUpdates:function(t,e){if(this.checkingForUpdates&&!0===t&&!this.forcingRefreshOnUpdatesCheck){var i=e;e=function(){Craft.cp.checkForUpdates(!0,i)}}if(\"function\"==typeof e&&(Garnish.isArray(this.checkForUpdatesCallbacks)||(this.checkForUpdatesCallbacks=[]),this.checkForUpdatesCallbacks.push(e)),!this.checkingForUpdates){this.checkingForUpdates=!0,this.forcingRefreshOnUpdatesCheck=!0===t;var s={forceRefresh:!0===t};Craft.queueActionRequest(\"app/check-for-updates\",s,$.proxy(function(t){if(this.updateUtilitiesBadge(),this.checkingForUpdates=!1,Garnish.isArray(this.checkForUpdatesCallbacks)){var e=this.checkForUpdatesCallbacks;this.checkForUpdatesCallbacks=null;for(var i=0;i<e.length;i++)e[i](t)}this.trigger(\"checkForUpdates\",{updateInfo:t})},this))}},updateUtilitiesBadge:function(){var i=$(\"#nav-utilities\").find(\"> a:not(.sel)\");i.length&&Craft.queueActionRequest(\"app/get-utilities-badge-count\",$.proxy(function(t){var e=i.children(\".badge\");t.badgeCount?(e.length||(e=$('<span class=\"badge\"/>').appendTo(i)),e.text(t.badgeCount)):e.length&&e.remove()},this))},runQueue:function(){this.enableQueue&&(Craft.runQueueAutomatically?Craft.queueActionRequest(\"queue/run\",$.proxy(function(t,e){\"success\"===e&&this.trackJobProgress(!1,!0)},this)):this.trackJobProgress(!1,!0))},trackJobProgress:function(t,e){if(e&&this.trackJobProgressTimeout&&(clearTimeout(this.trackJobProgressTimeout),this.trackJobProgressTimeout=null),!this.trackJobProgressTimeout&&this.enableQueue)if(!0===t){var i=Math.min(6e4,500*this.displayedJobInfoUnchanged);this.trackJobProgressTimeout=setTimeout($.proxy(this,\"_trackJobProgressInternal\"),i)}else this._trackJobProgressInternal()},_trackJobProgressInternal:function(){Craft.queueActionRequest(\"queue/get-job-info?dontExtendSession=1\",$.proxy(function(t,e){\"success\"===e&&(this.trackJobProgressTimeout=null,this.setJobInfo(t,!0),this.jobInfo.length&&this.trackJobProgress(!0))},this))},setJobInfo:function(t,e){if(this.enableQueue){this.jobInfo=t;var i=this.displayedJobInfo;this.displayedJobInfo=this.getDisplayedJobInfo(),i&&this.displayedJobInfo&&i.id===this.displayedJobInfo.id&&i.progress===this.displayedJobInfo.progress&&i.progressLabel===this.displayedJobInfo.progressLabel&&i.status===this.displayedJobInfo.status?this.displayedJobInfoUnchanged++:this.displayedJobInfoUnchanged=1,this.updateJobIcon(e),this.trigger(\"setJobInfo\")}},getDisplayedJobInfo:function(){if(!this.enableQueue)return null;for(var t=[Craft.CP.JOB_STATUS_RESERVED,Craft.CP.JOB_STATUS_FAILED,Craft.CP.JOB_STATUS_WAITING],e=0;e<t.length;e++)for(var i=0;i<this.jobInfo.length;i++)if(this.jobInfo[i].status===t[e])return this.jobInfo[i]},updateJobIcon:function(t){this.enableQueue&&this.$nav.length&&(this.displayedJobInfo?(this.jobProgressIcon||(this.jobProgressIcon=new e),this.displayedJobInfo.status===Craft.CP.JOB_STATUS_RESERVED||this.displayedJobInfo.status===Craft.CP.JOB_STATUS_WAITING?(this.jobProgressIcon.hideFailMode(),this.jobProgressIcon.setDescription(this.displayedJobInfo.description),this.jobProgressIcon.setProgress(this.displayedJobInfo.progress,t)):this.displayedJobInfo.status===Craft.CP.JOB_STATUS_FAILED&&this.jobProgressIcon.showFailMode(Craft.t(\"app\",\"Failed\"))):this.jobProgressIcon&&(this.jobProgressIcon.hideFailMode(),this.jobProgressIcon.complete(),delete this.jobProgressIcon))}},{notificationDuration:2e3,JOB_STATUS_WAITING:1,JOB_STATUS_RESERVED:2,JOB_STATUS_DONE:3,JOB_STATUS_FAILED:4}),Garnish.$scrollContainer=$(\"#content\"),Craft.cp=new Craft.CP;var e=Garnish.Base.extend({$li:null,$a:null,$label:null,hud:null,failMode:!1,_canvasSupported:null,_$bgCanvas:null,_$staticCanvas:null,_$hoverCanvas:null,_$failCanvas:null,_staticCtx:null,_hoverCtx:null,_canvasSize:null,_arcPos:null,_arcRadius:null,_lineWidth:null,_arcStartPos:0,_arcEndPos:0,_arcStartStepSize:null,_arcEndStepSize:null,_arcStep:null,_arcStepTimeout:null,_arcAnimateCallback:null,_progressBar:null,init:function(){if(this.$li=$(\"<li/>\").appendTo(Craft.cp.$nav.children(\"ul\")),this.$a=$('<a id=\"job-icon\"/>').appendTo(this.$li),this.$canvasContainer=$('<span class=\"icon\"/>').appendTo(this.$a),this.$label=$('<span class=\"label\"></span>').appendTo(this.$a),this._canvasSupported=!!document.createElement(\"canvas\").getContext,this._canvasSupported){var t=1<window.devicePixelRatio?2:1;this._canvasSize=18*t,this._arcPos=this._canvasSize/2,this._arcRadius=7*t,this._lineWidth=3*t,this._$bgCanvas=this._createCanvas(\"bg\",\"#61666b\"),this._$staticCanvas=this._createCanvas(\"static\",\"#d7d9db\"),this._$hoverCanvas=this._createCanvas(\"hover\",\"#fff\"),this._$failCanvas=this._createCanvas(\"fail\",\"#da5a47\").hide(),this._staticCtx=this._$staticCanvas[0].getContext(\"2d\"),this._hoverCtx=this._$hoverCanvas[0].getContext(\"2d\"),this._drawArc(this._$bgCanvas[0].getContext(\"2d\"),0,1),this._drawArc(this._$failCanvas[0].getContext(\"2d\"),0,1)}else this._progressBar=new Craft.ProgressBar(this.$canvasContainer),this._progressBar.showProgressBar();this.addListener(this.$a,\"click\",\"toggleHud\")},setDescription:function(t){this.$a.attr(\"title\",t),this.$label.text(t)},setProgress:function(t,e){this._canvasSupported?e?this._animateArc(0,t/100):this._setArc(0,t/100):this._progressBar.setProgressPercentage(t)},complete:function(){this._canvasSupported?this._animateArc(0,1,$.proxy(function(){this._$bgCanvas.velocity(\"fadeOut\"),this._animateArc(1,1,$.proxy(function(){this.$a.remove(),this.destroy()},this))},this)):(this._progressBar.setProgressPercentage(100),this.$a.velocity(\"fadeOut\"))},showFailMode:function(t){this.failMode||(this.failMode=!0,this._canvasSupported?(this._$bgCanvas.hide(),this._$staticCanvas.hide(),this._$hoverCanvas.hide(),this._$failCanvas.show()):(this._progressBar.$progressBar.css(\"border-color\",\"#da5a47\"),this._progressBar.$innerProgressBar.css(\"background-color\",\"#da5a47\"),this._progressBar.setProgressPercentage(50)),this.setDescription(t))},hideFailMode:function(){this.failMode&&(this.failMode=!1,this._canvasSupported?(this._$bgCanvas.show(),this._$staticCanvas.show(),this._$hoverCanvas.show(),this._$failCanvas.hide()):(this._progressBar.$progressBar.css(\"border-color\",\"\"),this._progressBar.$innerProgressBar.css(\"background-color\",\"\"),this._progressBar.setProgressPercentage(50)))},toggleHud:function(){this.hud?this.hud.toggle():this.hud=new o},_createCanvas:function(t,e){var i=$('<canvas id=\"job-icon-'+t+'\" width=\"'+this._canvasSize+'\" height=\"'+this._canvasSize+'\"/>').appendTo(this.$canvasContainer),s=i[0].getContext(\"2d\");return s.strokeStyle=e,s.lineWidth=this._lineWidth,s.lineCap=\"round\",i},_setArc:function(t,e){this._arcStartPos=t,this._arcEndPos=e,this._drawArc(this._staticCtx,t,e),this._drawArc(this._hoverCtx,t,e)},_drawArc:function(t,e,i){t.clearRect(0,0,this._canvasSize,this._canvasSize),t.beginPath(),t.arc(this._arcPos,this._arcPos,this._arcRadius,(1.5+2*e)*Math.PI,(1.5+2*i)*Math.PI),t.stroke(),t.closePath()},_animateArc:function(t,e,i){this._arcStepTimeout&&clearTimeout(this._arcStepTimeout),this._arcStep=0,this._arcStartStepSize=(t-this._arcStartPos)/10,this._arcEndStepSize=(e-this._arcEndPos)/10,this._arcAnimateCallback=i,this._takeNextArcStep()},_takeNextArcStep:function(){this._setArc(this._arcStartPos+this._arcStartStepSize,this._arcEndPos+this._arcEndStepSize),this._arcStep++,this._arcStep<10?this._arcStepTimeout=setTimeout($.proxy(this,\"_takeNextArcStep\"),50):this._arcAnimateCallback&&this._arcAnimateCallback()}}),o=Garnish.HUD.extend({jobsById:null,completedJobs:null,updateViewProxy:null,init:function(){this.jobsById={},this.completedJobs=[],this.updateViewProxy=$.proxy(this,\"updateView\"),this.base(Craft.cp.jobProgressIcon.$a),this.$main.attr(\"id\",\"queue-hud\")},onShow:function(){Craft.cp.on(\"setJobInfo\",this.updateViewProxy),this.updateView(),this.base()},onHide:function(){if(Craft.cp.off(\"setJobInfo\",this.updateViewProxy),this.completedJobs.length){for(var t=0;t<this.completedJobs.length;t++)this.completedJobs[t].destroy();this.completedJobs=[]}this.base()},updateView:function(){var t,e=[];if(Craft.cp.jobInfo)for(t=0;t<Craft.cp.jobInfo.length;t++)e.push(parseInt(Craft.cp.jobInfo[t].id));for(var i in this.jobsById)this.jobsById.hasOwnProperty(i)&&(Craft.inArray(parseInt(i),e)||(this.jobsById[i].complete(),this.completedJobs.push(this.jobsById[i]),delete this.jobsById[i]));if(Craft.cp.jobInfo&&Craft.cp.jobInfo.length)for(t=0;t<Craft.cp.jobInfo.length;t++){var s=Craft.cp.jobInfo[t];if(this.jobsById[s.id])this.jobsById[s.id].updateStatus(s);else{this.jobsById[s.id]=new o.Job(this,s);for(var n=!1,a=t+1;a<Craft.cp.jobInfo.length;a++)if(this.jobsById[Craft.cp.jobInfo[a].id]){this.jobsById[s.id].$container.insertBefore(this.jobsById[Craft.cp.jobInfo[a].id].$container),n=!0;break}if(!n){var r=this.$main.children(\"object\");r.length?this.jobsById[s.id].$container.insertBefore(r):this.jobsById[s.id].$container.appendTo(this.$main)}}}else this.hide()}});o.Job=Garnish.Base.extend({hud:null,id:null,description:null,status:null,progress:null,$container:null,$statusContainer:null,$descriptionContainer:null,$progressLabel:null,_progressBar:null,init:function(t,e){this.hud=t,this.id=e.id,this.description=e.description,this.$container=$(\"<div/>\",{class:\"job\"});var i=$(\"<div/>\",{class:\"flex\"}).appendTo(this.$container);$(\"<div/>\",{class:\"flex-grow\"}).text(e.description).appendTo(i),this.$statusContainer=$('<div class=\"job-status\"/>').appendTo(i),this.$container.data(\"job\",this),this.updateStatus(e)},updateStatus:function(t){if(this.status!==(this.status=t.status))switch(this.$statusContainer.empty(),this.status){case Craft.CP.JOB_STATUS_WAITING:this.$statusContainer.text(Craft.t(\"app\",\"Pending\"));break;case Craft.CP.JOB_STATUS_RESERVED:this._progressBar=new Craft.ProgressBar(this.$statusContainer),this._progressBar.showProgressBar();break;case Craft.CP.JOB_STATUS_FAILED:$(\"<span/>\",{class:\"error\",text:Craft.t(\"app\",\"Failed\"),title:t.error}).appendTo(this.$statusContainer);var e=$('<a class=\"menubtn error\" title=\"'+Craft.t(\"app\",\"Options\")+'\"/>').appendTo(this.$statusContainer);$('<div class=\"menu\"><ul><li><a data-action=\"retry\">'+Craft.t(\"app\",\"Try again\")+'</a></li><li><a data-action=\"release\">'+Craft.t(\"app\",\"Cancel\")+\"</a></li></ul></div>\").appendTo(this.$statusContainer),new Garnish.MenuBtn(e,{onOptionSelect:$.proxy(this,\"performErrorAction\")})}this.status===Craft.CP.JOB_STATUS_RESERVED?(this._progressBar.setProgressPercentage(t.progress),t.progressLabel&&(this.$progressLabel||(this.$progressLabel=$('<div class=\"light smalltext\"/>').appendTo(this.$container)),this.$progressLabel.text(t.progressLabel))):this.$progressLabel&&(this.$progressLabel.remove(),this.$progressLabel=null)},performErrorAction:function(t){switch($(t).data(\"action\")){case\"retry\":Craft.cp.displayedJobInfo.status=Craft.CP.JOB_STATUS_WAITING,Craft.cp.displayedJobInfo.progress=0,Craft.cp.updateJobIcon(!1),Craft.postActionRequest(\"queue/retry\",{id:this.id},$.proxy(function(t,e){\"success\"===e&&Craft.cp.trackJobProgress(!1,!0)},this));break;case\"release\":Craft.postActionRequest(\"queue/release\",{id:this.id},$.proxy(function(t,e){\"success\"===e&&Craft.cp.trackJobProgress(!1,!0)},this))}},complete:function(){this.$statusContainer.empty(),$('<div data-icon=\"check\"/>').appendTo(this.$statusContainer)},destroy:function(){this.hud.jobsById[this.id]&&delete this.hud.jobsById[this.id],this.$container.remove(),this.base()}}),Craft.CustomizeSourcesModal=Garnish.Modal.extend({elementIndex:null,$elementIndexSourcesContainer:null,$sidebar:null,$sourcesContainer:null,$sourceSettingsContainer:null,$newHeadingBtn:null,$footer:null,$footerBtnContainer:null,$saveBtn:null,$cancelBtn:null,$saveSpinner:null,$loadingSpinner:null,sourceSort:null,sources:null,selectedSource:null,updateSourcesOnSave:!1,availableTableAttributes:null,init:function(t,e){this.base(),this.setSettings(e,{resizable:!0}),this.elementIndex=t,this.$elementIndexSourcesContainer=this.elementIndex.$sidebar.children(\"nav\").children(\"ul\");var i=$('<form class=\"modal customize-sources-modal\"/>').appendTo(Garnish.$bod);this.$sidebar=$('<div class=\"cs-sidebar block-types\"/>').appendTo(i),this.$sourcesContainer=$('<div class=\"sources\">').appendTo(this.$sidebar),this.$sourceSettingsContainer=$('<div class=\"source-settings\">').appendTo(i),this.$footer=$('<div class=\"footer\"/>').appendTo(i),this.$footerBtnContainer=$('<div class=\"buttons right\"/>').appendTo(this.$footer),this.$cancelBtn=$('<div class=\"btn\" role=\"button\"/>').text(Craft.t(\"app\",\"Cancel\")).appendTo(this.$footerBtnContainer),this.$saveBtn=$('<div class=\"btn submit disabled\" role=\"button\"/>').text(Craft.t(\"app\",\"Save\")).appendTo(this.$footerBtnContainer),this.$saveSpinner=$('<div class=\"spinner hidden\"/>').appendTo(this.$footerBtnContainer),this.$newHeadingBtn=$('<div class=\"btn submit add icon\"/>').text(Craft.t(\"app\",\"New heading\")).appendTo($('<div class=\"buttons left secondary-buttons\"/>').appendTo(this.$footer)),this.$loadingSpinner=$('<div class=\"spinner\"/>').appendTo(i),this.setContainer(i),this.show();var s={elementType:this.elementIndex.elementType};Craft.postActionRequest(\"element-index-settings/get-customize-sources-modal-data\",s,$.proxy(function(t,e){this.$loadingSpinner.remove(),\"success\"===e&&(this.$saveBtn.removeClass(\"disabled\"),this.buildModal(t))},this)),this.addListener(this.$newHeadingBtn,\"click\",\"handleNewHeadingBtnClick\"),this.addListener(this.$cancelBtn,\"click\",\"hide\"),this.addListener(this.$saveBtn,\"click\",\"save\"),this.addListener(this.$container,\"submit\",\"save\")},buildModal:function(t){this.availableTableAttributes=t.availableTableAttributes,this.sourceSort=new Garnish.DragSort({handle:\".move\",axis:\"y\",onSortChange:$.proxy(function(){this.updateSourcesOnSave=!0},this)}),this.sources=[];for(var e=0;e<t.sources.length;e++){var i=this.addSource(t.sources[e]);this.sources.push(i)}this.selectedSource||void 0===this.sources[0]||this.sources[0].select()},addSource:function(t){var e,i=$('<div class=\"customize-sources-item\"/>').appendTo(this.$sourcesContainer),s=$('<div class=\"label\"/>').appendTo(i),n=$('<input type=\"hidden\"/>').appendTo(i);return $('<a class=\"move icon\" title=\"'+Craft.t(\"app\",\"Reorder\")+'\" role=\"button\"></a>').appendTo(i),void 0!==t.heading?(i.addClass(\"heading\"),n.attr(\"name\",\"sourceOrder[][heading]\"),(e=new Craft.CustomizeSourcesModal.Heading(this,i,s,n,t)).updateItemLabel(t.heading)):(n.attr(\"name\",\"sourceOrder[][key]\").val(t.key),(e=new Craft.CustomizeSourcesModal.Source(this,i,s,n,t)).updateItemLabel(t.label),(this.elementIndex.sourceKey+\"/\").substr(0,t.key.length+1)===t.key+\"/\"&&e.select()),this.sourceSort.addItems(i),e},handleNewHeadingBtnClick:function(){var t=this.addSource({heading:\"\"});Garnish.scrollContainerToElement(this.$sidebar,t.$item),t.select(),this.updateSourcesOnSave=!0},save:function(t){if(t&&t.preventDefault(),!this.$saveBtn.hasClass(\"disabled\")&&this.$saveSpinner.hasClass(\"hidden\")){this.$saveSpinner.removeClass(\"hidden\");var e=this.$container.serialize()+\"&elementType=\"+this.elementIndex.elementType;Craft.postActionRequest(\"element-index-settings/save-customize-sources-modal-settings\",e,$.proxy(function(t,e){if(this.$saveSpinner.addClass(\"hidden\"),\"success\"===e&&t.success){if(this.updateSourcesOnSave&&this.$elementIndexSourcesContainer.length){for(var i,s=null,n=0;n<this.sourceSort.$items.length;n++){var a=this.sourceSort.$items.eq(n).data(\"source\"),r=a.getIndexSource();r&&(a.isHeading()?i=r:(i&&(this.appendSource(i,s),s=i,i=null),this.appendSource(r,s),s=r))}if(s){var o=s.nextAll();this.elementIndex.sourceSelect.removeItems(o),o.remove()}}this.selectedSource&&this.selectedSource.sourceData.key&&(this.elementIndex.selectSourceByKey(this.selectedSource.sourceData.key),this.elementIndex.updateElements()),Craft.cp.displayNotice(Craft.t(\"app\",\"Source settings saved\")),this.hide()}else{var l=\"success\"===e&&t.error?t.error:Craft.t(\"app\",\"An unknown error occurred.\");Craft.cp.displayError(l)}},this))}},appendSource:function(t,e){e?t.insertAfter(e):t.prependTo(this.$elementIndexSourcesContainer)},destroy:function(){for(var t=0;t<this.sources.length;t++)this.sources[t].destroy();delete this.sources,this.base()}}),Craft.CustomizeSourcesModal.BaseSource=Garnish.Base.extend({modal:null,$item:null,$itemLabel:null,$itemInput:null,$settingsContainer:null,sourceData:null,init:function(t,e,i,s,n){this.modal=t,this.$item=e,this.$itemLabel=i,this.$itemInput=s,this.sourceData=n,this.$item.data(\"source\",this),this.addListener(this.$item,\"click\",\"select\")},isHeading:function(){return!1},isSelected:function(){return this.modal.selectedSource===this},select:function(){this.isSelected()||(this.modal.selectedSource&&this.modal.selectedSource.deselect(),this.$item.addClass(\"sel\"),(this.modal.selectedSource=this).$settingsContainer?this.$settingsContainer.removeClass(\"hidden\"):this.$settingsContainer=$(\"<div/>\").append(this.createSettings()).appendTo(this.modal.$sourceSettingsContainer),this.modal.$sourceSettingsContainer.scrollTop(0))},createSettings:function(){},getIndexSource:function(){},deselect:function(){this.$item.removeClass(\"sel\"),this.modal.selectedSource=null,this.$settingsContainer.addClass(\"hidden\")},updateItemLabel:function(t){this.$itemLabel.text(t)},destroy:function(){this.$item.data(\"source\",null),this.base()}}),Craft.CustomizeSourcesModal.Source=Craft.CustomizeSourcesModal.BaseSource.extend({createSettings:function(){if(this.sourceData.tableAttributes.length){var t,e,i,s,n=this.sourceData.tableAttributes[0],a=n[0],r=n[1],o=this.createTableColumnOption(a,r,!0,!0),l=$(\"<div/>\"),h=[a];for($('<input type=\"hidden\" name=\"sources['+this.sourceData.key+'][tableAttributes][]\" value=\"\"/>').appendTo(l),t=1;t<this.sourceData.tableAttributes.length;t++)i=(e=this.sourceData.tableAttributes[t])[0],s=e[1],l.append(this.createTableColumnOption(i,s,!1,!0)),h.push(i);for(t=0;t<this.modal.availableTableAttributes.length;t++)i=(e=this.modal.availableTableAttributes[t])[0],s=e[1],Craft.inArray(i,h)||l.append(this.createTableColumnOption(i,s,!1,!1));return new Garnish.DragSort(l.children(),{handle:\".move\",axis:\"y\"}),Craft.ui.createField($([o[0],l[0]]),{label:Craft.t(\"app\",\"Table Columns\"),instructions:Craft.t(\"app\",\"Choose which table columns should be visible for this source, and in which order.\")})}},createTableColumnOption:function(t,e,i,s){var n=$('<div class=\"customize-sources-table-column\"/>').append('<div class=\"icon move\"/>').append(Craft.ui.createCheckbox({label:e,name:\"sources[\"+this.sourceData.key+\"][tableAttributes][]\",value:t,checked:s,disabled:i}));return i&&n.children(\".move\").addClass(\"disabled\"),n},getIndexSource:function(){var t=this.modal.elementIndex.getSourceByKey(this.sourceData.key);if(t)return t.closest(\"li\")}}),Craft.CustomizeSourcesModal.Heading=Craft.CustomizeSourcesModal.BaseSource.extend({$labelField:null,$labelInput:null,$deleteBtn:null,isHeading:function(){return!0},select:function(){this.base(),this.$labelInput.trigger(\"focus\")},createSettings:function(){return this.$labelField=Craft.ui.createTextField({label:Craft.t(\"app\",\"Heading\"),instructions:Craft.t(\"app\",\"This can be left blank if you just want an unlabeled separator.\"),value:this.sourceData.heading}),this.$labelInput=this.$labelField.find(\".text\"),this.$deleteBtn=$('<a class=\"error delete\"/>').text(Craft.t(\"app\",\"Delete heading\")),this.addListener(this.$labelInput,\"textchange\",\"handleLabelInputChange\"),this.addListener(this.$deleteBtn,\"click\",\"deleteHeading\"),$([this.$labelField[0],$(\"<hr/>\")[0],this.$deleteBtn[0]])},handleLabelInputChange:function(){this.updateItemLabel(this.$labelInput.val()),this.modal.updateSourcesOnSave=!0},updateItemLabel:function(t){this.$itemLabel.html((t?Craft.escapeHtml(t):'<em class=\"light\">'+Craft.t(\"app\",\"(blank)\")+\"</em>\")+\"&nbsp;\"),this.$itemInput.val(t)},deleteHeading:function(){this.modal.sourceSort.removeItems(this.$item),this.modal.sources.splice($.inArray(this,this.modal.sources),1),this.modal.updateSourcesOnSave=!0,this.isSelected()&&(this.deselect(),this.modal.sources.length&&this.modal.sources[0].select()),this.$item.remove(),this.$settingsContainer.remove(),this.destroy()},getIndexSource:function(){var t=this.$labelInput?this.$labelInput.val():this.sourceData.heading;return $('<li class=\"heading\"/>').append($(\"<span/>\").text(t))}}),Craft.DataTableSorter=Garnish.DragSort.extend({$table:null,init:function(t,e){this.$table=$(t);var i=this.$table.children(\"tbody\").children(\":not(.filler)\");(e=$.extend({},Craft.DataTableSorter.defaults,e)).container=this.$table.children(\"tbody\"),e.helper=$.proxy(this,\"getHelper\"),e.caboose=\"<tr/>\",e.axis=Garnish.Y_AXIS,e.magnetStrength=4,e.helperLagBase=1.5,this.base(i,e)},getHelper:function(t){var e=$('<div class=\"'+this.settings.helperClass+'\"/>').appendTo(Garnish.$bod),i=$(\"<table/>\").appendTo(e),s=$(\"<tbody/>\").appendTo(i);t.appendTo(s),i.width(this.$table.width()),i.prop(\"className\",this.$table.prop(\"className\"));for(var n=this.$table.find(\"tr:first\").children(),a=t.children(),r=0;r<a.length;r++)$(a[r]).width($(n[r]).width());return e}},{defaults:{handle:\".move\",helperClass:\"datatablesorthelper\"}}),Craft.DeleteUserModal=Garnish.Modal.extend({id:null,userId:null,$deleteActionRadios:null,$deleteSpinner:null,userSelect:null,_deleting:!1,init:function(t,e){this.id=Math.floor(1e9*Math.random()),this.userId=t,e=$.extend(Craft.DeleteUserModal.defaults,e);var i,s=$('<form class=\"modal fitted deleteusermodal\" method=\"post\" accept-charset=\"UTF-8\">'+Craft.getCsrfInput()+'<input type=\"hidden\" name=\"action\" value=\"users/delete-user\"/>'+(Garnish.isArray(this.userId)?\"\":'<input type=\"hidden\" name=\"userId\" value=\"'+this.userId+'\"/>')+(e.redirect?'<input type=\"hidden\" name=\"redirect\" value=\"'+e.redirect+'\"/>':\"\")+\"</form>\").appendTo(Garnish.$bod),n=$('<div class=\"body\"><div class=\"content-summary\"><p>'+Craft.t(\"app\",\"What do you want to do with their content?\")+'</p><ul class=\"bullets\"></ul></div><div class=\"options\"><label><input type=\"radio\" name=\"contentAction\" value=\"transfer\"/> '+Craft.t(\"app\",\"Transfer it to:\")+'</label><div id=\"transferselect'+this.id+'\" class=\"elementselect\"><div class=\"elements\"></div><div class=\"btn add icon dashed\">'+Craft.t(\"app\",\"Choose a user\")+'</div></div></div><div><label class=\"error\"><input type=\"radio\" name=\"contentAction\" value=\"delete\"/> '+Craft.t(\"app\",\"Delete it\")+\"</label></div></div>\").appendTo(s),a=$('<div class=\"buttons right\"/>').appendTo(n),r=$('<div class=\"btn\">'+Craft.t(\"app\",\"Cancel\")+\"</div>\").appendTo(a);if(e.contentSummary.length)for(var o=0;o<e.contentSummary.length;o++)n.find(\"ul\").append($(\"<li/>\",{text:e.contentSummary[o]}));else n.find(\"ul\").remove();if(this.$deleteActionRadios=n.find(\"input[type=radio]\"),this.$deleteSubmitBtn=$('<input type=\"submit\" class=\"btn submit disabled\" value=\"'+(Garnish.isArray(this.userId)?Craft.t(\"app\",\"Delete users\"):Craft.t(\"app\",\"Delete user\"))+'\" />').appendTo(a),this.$deleteSpinner=$('<div class=\"spinner hidden\"/>').appendTo(a),Garnish.isArray(this.userId)){i=[\"and\"];for(o=0;o<this.userId.length;o++)i.push(\"not \"+this.userId[o])}else i=\"not \"+this.userId;this.userSelect=new Craft.BaseElementSelectInput({id:\"transferselect\"+this.id,name:\"transferContentTo\",elementType:\"craft\\\\elements\\\\User\",criteria:{id:i},limit:1,modalSettings:{closeOtherModals:!1},onSelectElements:$.proxy(function(){this.updateSizeAndPosition(),this.$deleteActionRadios.first().prop(\"checked\")?this.validateDeleteInputs():this.$deleteActionRadios.first().trigger(\"click\")},this),onRemoveElements:$.proxy(this,\"validateDeleteInputs\"),selectable:!1,editable:!1}),this.addListener(r,\"click\",\"hide\"),this.addListener(this.$deleteActionRadios,\"change\",\"validateDeleteInputs\"),this.addListener(s,\"submit\",\"handleSubmit\"),this.base(s,e)},validateDeleteInputs:function(){var t=!1;return this.$deleteActionRadios.eq(0).prop(\"checked\")?t=!!this.userSelect.totalSelected:this.$deleteActionRadios.eq(1).prop(\"checked\")&&(t=!0),t?this.$deleteSubmitBtn.removeClass(\"disabled\"):this.$deleteSubmitBtn.addClass(\"disabled\"),t},handleSubmit:function(t){!this._deleting&&this.validateDeleteInputs()?(this.$deleteSubmitBtn.addClass(\"active\"),this.$deleteSpinner.removeClass(\"hidden\"),this.disable(),this.userSelect.disable(),!(this._deleting=!0)===this.settings.onSubmit()&&t.preventDefault()):t.preventDefault()},onFadeIn:function(){Garnish.isMobileBrowser(!0)||this.$deleteActionRadios.first().trigger(\"focus\"),this.base()}},{defaults:{contentSummary:[],onSubmit:$.noop,redirect:null}}),Craft.DraftEditor=Garnish.Base.extend({$revisionBtn:null,$revisionLabel:null,$spinner:null,$statusIcon:null,$editMetaBtn:null,metaHud:null,$nameTextInput:null,$notesTextInput:null,$saveMetaBtn:null,lastSerializedValue:null,timeout:null,saving:!1,saveXhr:null,checkFormAfterUpdate:!1,submittingForm:!1,duplicatedElements:null,errors:null,preview:null,previewToken:null,init:function(t){if(this.setSettings(t,Craft.DraftEditor.defaults),this.duplicatedElements={},this.$revisionBtn=$(\"#revision-btn\"),this.$revisionLabel=$(\"#revision-label\"),this.$spinner=$(\"#revision-spinner\"),this.$statusIcon=$(\"#revision-status\"),this.settings.previewTargets.length){this.settings.enablePreview&&this.addListener($(\"#preview-btn\"),\"click\",\"openPreview\");var e=$(\"#share-btn\");1===this.settings.previewTargets.length?this.addListener(e,\"click\",function(){this.openShareLink(this.settings.previewTargets[0].url)}):this.createShareMenu(e)}this.settings.revisionId||(this.lastSerializedValue=this.serializeForm(!0),Craft.cp.$primaryForm.data(\"initialSerializedValue\",this.lastSerializedValue),Craft.cp.$primaryForm.data(\"serializer\",function(){return this.serializeForm(!0)}.bind(this)),this.settings.draftId?this.initForDraft():(this.addListener($(\"#save-draft-btn\"),\"click\",function(t){t.preventDefault(),this.createDraft(),this.removeListener(Craft.cp.$primaryForm,\"submit.saveShortcut\")}.bind(this)),this.settings.canUpdateSource||this.addListener(Craft.cp.$primaryForm,\"submit.saveShortcut\",function(t){t.saveShortcut&&(t.preventDefault(),this.createDraft(),this.removeListener(Craft.cp.$primaryForm,\"submit.saveShortcut\"))}.bind(this))))},initForDraft:function(){this.createEditMetaBtn(),this.addListener(Garnish.$bod,\"keypress keyup change focus blur click mousedown mouseup\",function(t){$(t.target).is(this.statusIcons())||(clearTimeout(this.timeout),Craft.inArray(t.type,[\"keypress\",\"keyup\",\"change\"])?this.timeout=setTimeout(this.checkForm.bind(this),500):this.checkForm())}),this.addListener(Craft.cp.$primaryForm,\"submit\",\"handleFormSubmit\"),this.addListener(this.$statusIcon,\"click\",function(){this.showStatusHud(this.$statusIcon)}.bind(this))},showStatusHud:function(t){if(null===this.errors)e=\"<p>\"+Craft.t(\"app\",\"The draft has been saved.\")+\"</p>\";else{var e='<p class=\"error\">'+Craft.t(\"app\",\"The draft could not be saved.\")+\"</p>\";if(this.errors.length){for(e+='<ul class=\"errors\">',i=0;i<this.errors.length;i++)e+=\"<li>\"+Craft.escapeHtml(this.errors[i])+\"</li>\";e+=\"</ul>\"}}var s=new Garnish.HUD(t,e,{onHide:function(){s.destroy(),delete s}})},spinners:function(){return this.preview?this.$spinner.add(this.preview.$spinner):this.$spinner},statusIcons:function(){return this.preview?this.$statusIcon.add(this.preview.$statusIcon):this.$statusIcon},createEditMetaBtn:function(){this.$editMetaBtn=$(\"<a/>\",{class:\"btn edit icon\",title:Craft.t(\"app\",\"Edit draft settings\")}).appendTo($(\"#revision-btngroup\")),this.addListener(this.$editMetaBtn,\"click\",\"showMetaHud\")},createShareMenu:function(t){t.addClass(\"menubtn\");for(var e,i,s=$(\"<div/>\",{class:\"menu\"}).insertAfter(t),n=$(\"<ul/>\").appendTo(s),a=0;a<this.settings.previewTargets.length;a++)e=$(\"<li/>\").appendTo(n),i=$(\"<a/>\",{text:this.settings.previewTargets[a].label}).appendTo(e),this.addListener(i,\"click\",{target:a},function(t){this.openShareLink(this.settings.previewTargets[t.data.target].url)}.bind(this))},getPreviewToken:function(){return new Promise(function(i,s){this.previewToken?i(this.previewToken):Craft.postActionRequest(\"preview/create-token\",{elementType:this.settings.elementType,sourceId:this.settings.sourceId,siteId:this.settings.siteId,draftId:this.settings.draftId,revisionId:this.settings.revisionId},function(t,e){\"success\"===e?(this.previewToken=t.token,i(this.previewToken)):s()}.bind(this))}.bind(this))},getTokenizedPreviewUrl:function(s,n){return new Promise(function(e,t){var i={};!n&&this.settings.isLive||(i[n||\"x-craft-preview\"]=Craft.randomString(10)),this.settings.isLive?e(Craft.getUrl(s,i)):this.getPreviewToken().then(function(t){i[Craft.tokenParam]=t,e(Craft.getUrl(s,i))}).catch(t)}.bind(this))},openShareLink:function(t){this.getTokenizedPreviewUrl(t).then(function(t){window.open(t)})},getPreview:function(){return this.preview||(this.preview=new Craft.Preview(this)),this.preview},openPreview:function(){return new Promise(function(t,e){this.ensureIsDraftOrRevision().then(function(){this.getPreview().open(),t()}.bind(this)).catch(e)}.bind(this))},ensureIsDraftOrRevision:function(){return new Promise(function(t,e){this.settings.draftId||this.settings.revisionid?t():this.createDraft().then(t).catch(e)}.bind(this))},serializeForm:function(t){var e=Craft.cp.$primaryForm.serialize();return this.isPreviewActive()&&(e=e.replace(\"__PREVIEW_FIELDS__=1\",this.preview.$editor.serialize())),t&&!this.settings.isUnsavedDraft&&(e=(e=e.replace(/&action=[^&]*/,\"\")).replace(/&redirect=[^&]*/,\"\")),e},checkForm:function(t){if(this.settings.draftId){clearTimeout(this.timeout),this.timeout=null;var e=this.serializeForm(!0);!t&&e===this.lastSerializedValue||this.saveDraft(e)}},isPreviewActive:function(){return this.preview&&this.preview.isActive},createDraft:function(){return new Promise(function(t,e){this.saveDraft(this.serializeForm(!0)).then(t).catch(e)}.bind(this))},saveDraft:function(b){return new Promise(function(f,m){if(this.submittingForm)m();else if(this.lastSerializedValue=b,this.saving)this.checkFormAfterUpdate=!0;else{this.saving=!0;var v=this.spinners().removeClass(\"hidden\"),C=this.statusIcons().removeClass(\"invisible checkmark-icon alert-icon\").addClass(\"hidden\");this.$saveMetaBtn&&this.$saveMetaBtn.addClass(\"active\"),this.errors=null;var t=Craft.getActionUrl(this.settings.saveDraftAction);this.saveXhr=Craft.postActionRequest(t,this.prepareData(b),function(t,e){if(v.addClass(\"hidden\"),this.$saveMetaBtn&&this.$saveMetaBtn.removeClass(\"active\"),this.saving=!1,\"abort\"!==e){if(\"success\"!==e||t.errors)return this.errors=(t?t.errors:null)||[],C.removeClass(\"hidden checkmark-icon\").addClass(\"alert-icon\").attr(\"title\",Craft.t(\"app\",\"The draft could not be saved.\")),void m();t.title&&$(\"#header h1\").text(t.title),t.docTitle&&(document.title=t.docTitle),this.$revisionLabel.text(t.draftName),this.settings.draftName=t.draftName,this.settings.draftNotes=t.draftNotes;var i=this.$revisionBtn.data(\"menubtn\")?this.$revisionBtn.data(\"menubtn\").menu:null,s=!this.settings.draftId;if(s){var n,a=document.location.href.search(\"#\");n=-1!==a?document.location.href.substr(0,a):document.location.href,n+=(n.match(/\\?/)?\"&\":\"?\")+\"draftId=\"+t.draftId,-1!==a&&(n+=document.location.href.substr(a)),history.replaceState({},\"\",n);var r=$(\"#save-btn-container\");r.length&&r.replaceWith($(\"<input/>\",{type:\"submit\",class:\"btn submit\",value:Craft.t(\"app\",\"Update {type}\",{type:this.settings.elementTypeDisplayName})}));var o=$(\"#save-draft-btn-container\");if(o.add(o.prev(\".spacer\")).remove(),this.settings.draftId=t.draftId,this.settings.isLive=!1,this.settings.canDeleteDraft=!0,this.previewToken=null,this.initForDraft(),i){i.$options.filter(\":not(.site-option)\").removeClass(\"sel\");var l=i.$container.find(\".revision-group-drafts\");if(!l.length){var h=$(\"<h6/>\",{text:Craft.t(\"app\",\"Drafts\")}).insertAfter(i.$container.find(\".revision-group-current\"));l=$(\"<ul/>\",{class:\"padded revision-group-drafts\"}).insertAfter(h)}var d=$(\"<li/>\").appendTo(l),c=$(\"<a/>\",{class:\"sel\",html:'<span class=\"draft-name\"></span> <span class=\"draft-creator light\"></span>'}).appendTo(d);i.addOptions(c),i.selectOption(c);for(var u=i.$options.filter(\".site-option[href]\"),p=0;p<u.length;p++){var g=u.eq(p);g.attr(\"href\",Craft.getUrl(g.attr(\"href\"),{draftId:t.draftId}))}}}i&&(i.$options.filter(\".sel\").find(\".draft-name\").text(t.draftName),i.$options.filter(\".sel\").find(\".draft-creator\").text(Craft.t(\"app\",\"by {creator}\",{creator:t.creator}))),t.previewTargets&&JSON.stringify(t.previewTargets)!==JSON.stringify(this.settings.previewTargets)&&this.updatePreviewTargets(t.previewTargets),this.afterUpdate(b),s&&this.trigger(\"createDraft\"),this.$nameTextInput&&this.checkMetaValues(),$.extend(this.duplicatedElements,t.duplicatedElements),f()}}.bind(this))}}.bind(this))},prepareData:function(t){for(var e in this.duplicatedElements)this.duplicatedElements.hasOwnProperty(e)&&(t=t.replace(new RegExp(Craft.escapeRegex(encodeURIComponent(\"][\"+e+\"]\")),\"g\"),\"][\"+this.duplicatedElements[e]+\"]\"));return this.settings.draftId&&(t+=\"&draftId=\"+this.settings.draftId+\"&draftName=\"+encodeURIComponent(this.settings.draftName)+\"&draftNotes=\"+encodeURIComponent(this.settings.draftNotes||\"\")),t},updatePreviewTargets:function(t){for(var e={},i=0;i<this.settings.previewTargets.length;i++)e[this.settings.previewTargets[i].label]=this.settings.previewTargets[i];for(i=0;i<t.length;i++)e[t[i].label]&&(e[t[i].label].url=t[i].url)},afterUpdate:function(t){Craft.cp.$primaryForm.data(\"initialSerializedValue\",t),this.statusIcons().removeClass(\"hidden\").addClass(\"checkmark-icon\").attr(\"title\",Craft.t(\"app\",\"The draft has been saved.\")),this.trigger(\"update\"),this.checkFormAfterUpdate&&(this.checkFormAfterUpdate=!1,this.timeout||this.checkForm())},showMetaHud:function(){this.metaHud?this.metaHud.show():(this.createMetaHud(),this.onMetaHudShow()),Garnish.isMobileBrowser(!0)||this.$nameTextInput.trigger(\"focus\")},createMetaHud:function(){var t,e,i=$(\"<div/>\");t=$('<div class=\"field\"><div class=\"heading\"><label for=\"draft-name\">'+Craft.t(\"app\",\"Draft Name\")+\"</label></div></div>\").appendTo(i),e=$('<div class=\"input\"/>').appendTo(t),this.$nameTextInput=$('<input type=\"text\" class=\"text fullwidth\" id=\"draft-name\"/>').appendTo(e).val(this.settings.draftName),t=$('<div class=\"field\"><div class=\"heading\"><label for=\"draft-notes\">'+Craft.t(\"app\",\"Notes\")+\"</label></div></div>\").appendTo(i),e=$('<div class=\"input\"/>').appendTo(t),this.$notesTextInput=$('<textarea class=\"text fullwidth\" id=\"draft-notes\" rows=\"2\"/>').appendTo(e).val(this.settings.draftNotes);var s=$('<div class=\"hud-footer flex flex-center\"/>').appendTo(i);if(this.settings.canDeleteDraft)var n=$('<a class=\"error\" role=\"button\">'+Craft.t(\"app\",\"Delete\")+\"</a>\").appendTo(s);$('<div class=\"flex-grow\"></div>').appendTo(s),this.$saveMetaBtn=$('<input type=\"submit\" class=\"btn submit disabled\" value=\"'+Craft.t(\"app\",\"Save\")+'\"/>').appendTo(s),this.metaHud=new Garnish.HUD(this.$editMetaBtn,i,{onSubmit:this.saveMeta.bind(this)}),new Garnish.NiceText(this.$notesTextInput),this.addListener(this.$notesTextInput,\"keydown\",\"onNotesKeydown\"),this.addListener(this.$nameTextInput,\"textchange\",\"checkMetaValues\"),this.addListener(this.$notesTextInput,\"textchange\",\"checkMetaValues\"),this.metaHud.on(\"show\",this.onMetaHudShow.bind(this)),this.metaHud.on(\"hide\",this.onMetaHudHide.bind(this)),this.metaHud.on(\"escape\",this.onMetaHudEscape.bind(this)),n&&this.addListener(n,\"click\",\"deleteDraft\")},onMetaHudShow:function(){this.$editMetaBtn.addClass(\"active\")},onMetaHudHide:function(){this.$editMetaBtn.removeClass(\"active\")},onMetaHudEscape:function(){this.$nameTextInput.val(this.settings.draftName),this.$notesTextInput.val(this.settings.draftNotes)},onNotesKeydown:function(t){t.keyCode===Garnish.RETURN_KEY&&(t.preventDefault(),this.metaHud.submit())},checkMetaValues:function(){return!this.$nameTextInput.val()||this.$nameTextInput.val()===this.settings.draftName&&this.$notesTextInput.val()===this.settings.draftNotes?(this.$saveMetaBtn.addClass(\"disabled\"),!1):(this.$saveMetaBtn.removeClass(\"disabled\"),!0)},shakeMetaHud:function(){Garnish.shake(this.metaHud.$hud)},saveMeta:function(){this.checkMetaValues()?(this.settings.draftName=this.$nameTextInput.val(),this.settings.draftNotes=this.$notesTextInput.val(),this.metaHud.hide(),this.checkForm(!0)):this.shakeMetaHud()},deleteDraft:function(){confirm(Craft.t(\"app\",\"Are you sure you want to delete this draft?\"))&&Craft.postActionRequest(this.settings.deleteDraftAction,{draftId:this.settings.draftId},function(t,e){\"success\"===e&&(window.location.href=this.settings.cpEditUrl)}.bind(this))},handleFormSubmit:function(t){if(t.preventDefault(),!this.submittingForm&&(t.customTrigger||this.settings.isUnsavedDraft||!this.settings.draftId||this.settings.canUpdateSource)){Craft.cp.$confirmUnloadForms=Craft.cp.$confirmUnloadForms.not(Craft.cp.$primaryForm),this.saving&&this.saveXhr.abort();for(var e,i=$(\"<form/>\",{attr:{\"accept-charset\":Craft.cp.$primaryForm.attr(\"accept-charset\"),action:Craft.cp.$primaryForm.attr(\"action\"),enctype:Craft.cp.$primaryForm.attr(\"enctype\"),method:Craft.cp.$primaryForm.attr(\"method\"),target:Craft.cp.$primaryForm.attr(\"target\")}}),s=this.prepareData(this.serializeForm(!1)).split(\"&\"),n=0;n<s.length;n++)e=s[n].split(\"=\",2),$(\"<input/>\",{type:\"hidden\",name:decodeURIComponent(e[0]),value:decodeURIComponent(e[1]||\"\")}).appendTo(i);t.customTrigger&&t.customTrigger.data(\"action\")||$(\"<input/>\",{type:\"hidden\",name:\"action\",value:this.settings.applyDraftAction}).appendTo(i),t.saveShortcut&&Craft.cp.$primaryForm.data(\"saveshortcut-redirect\")||t.customTrigger&&t.customTrigger.data(\"redirect\")||$(\"<input/>\",{type:\"hidden\",name:\"redirect\",value:this.settings.hashedRedirectUrl}).appendTo(i),i.appendTo(Garnish.$bod),i.submit(),this.submittingForm=!0}}},{defaults:{elementType:null,sourceId:null,siteId:null,isLive:!1,cpEditUrl:null,draftId:null,revisionId:null,draftName:null,draftNotes:null,canDeleteDraft:!1,canUpdateSource:!1,saveDraftAction:null,deleteDraftAction:null,applyDraftAction:null,enablePreview:!1,previewTargets:[]}}),Craft.DynamicGenerator=Craft.BaseInputGenerator.extend({callback:$.noop,init:function(t,e,i){this.callback=i,this.base(t,e)},generateTargetValue:function(t){return this.callback(t)}}),Craft.EditableTable=Garnish.Base.extend({initialized:!1,id:null,baseName:null,columns:null,sorter:null,biggestId:-1,$table:null,$tbody:null,$addRowBtn:null,rowCount:0,hasMaxRows:!1,hasMinRows:!1,radioCheckboxes:null,init:function(t,e,i,s){if(this.id=t,this.baseName=e,this.columns=i,this.setSettings(s,Craft.EditableTable.defaults),this.radioCheckboxes={},this.$table=$(\"#\"+t),this.$tbody=this.$table.children(\"tbody\"),this.rowCount=this.$tbody.find(\"tr\").length,this.$table.data(\"editable-table\")&&(Garnish.log(\"Double-instantiating an editable table on an element\"),this.$table.data(\"editable-table\").destroy()),this.$table.data(\"editable-table\",this),this.sorter=new Craft.DataTableSorter(this.$table,{helperClass:\"editabletablesorthelper\",copyDraggeeInputValuesToHelper:!0}),this.isVisible()?this.initialize():setTimeout($.proxy(this,\"initializeIfVisible\"),500),this.settings.minRows&&this.rowCount<this.settings.minRows)for(var n=this.rowCount;n<this.settings.minRows;n++)this.addRow()},isVisible:function(){return 0<this.$table.height()},initialize:function(){if(this.initialized)return!1;this.initialized=!0,this.removeListener(Garnish.$win,\"resize\");for(var t=this.$tbody.children(),e=0;e<t.length;e++)this.createRowObj(t[e]);return this.$addRowBtn=this.$table.next(\".add\"),this.updateAddRowButton(),this.addListener(this.$addRowBtn,\"activate\",\"addRow\"),!0},initializeIfVisible:function(){this.removeListener(Garnish.$win,\"resize\"),this.isVisible()?this.initialize():this.addListener(Garnish.$win,\"resize\",\"initializeIfVisible\")},updateAddRowButton:function(){this.canAddRow()?(this.$addRowBtn.css(\"opacity\",\"1\"),this.$addRowBtn.css(\"pointer-events\",\"auto\")):(this.$addRowBtn.css(\"opacity\",\"0.2\"),this.$addRowBtn.css(\"pointer-events\",\"none\"))},canDeleteRow:function(){return this.rowCount>this.settings.minRows},deleteRow:function(t){this.canDeleteRow()&&(this.sorter.removeItems(t.$tr),t.$tr.remove(),this.rowCount--,this.updateAddRowButton(),this.settings.onDeleteRow(t.$tr),t.destroy())},canAddRow:function(){return!this.settings.staticRows&&(!this.settings.maxRows||this.rowCount<this.settings.maxRows)},addRow:function(t,e){if(this.canAddRow()){var i=this.settings.rowIdPrefix+(this.biggestId+1),s=this.createRow(i,this.columns,this.baseName,$.extend({},this.settings.defaultValues));e?s.prependTo(this.$tbody):s.appendTo(this.$tbody);var n=this.createRowObj(s);return this.sorter.addItems(s),!1!==t&&s.find(\"input:visible,textarea:visible,select:visible\").first().trigger(\"focus\"),this.rowCount++,this.updateAddRowButton(),this.settings.onAddRow(s),n}},createRow:function(t,e,i,s){return Craft.EditableTable.createRow(t,e,i,s)},createRowObj:function(t){return new Craft.EditableTable.Row(this,t)},focusOnPrevRow:function(t,e,i){var s,n=t.prev(\"tr\");if((s=n.length?n.data(\"editable-table-row\"):this.addRow(!1,!0))&&s.$tds[e])if($(s.$tds[e]).hasClass(\"disabled\"))n&&this.focusOnPrevRow(n,e,i);else{var a=$(\"textarea,input.text\",s.$tds[e]);a.length&&($(i).trigger(\"blur\"),a.trigger(\"focus\"))}},focusOnNextRow:function(t,e,i){var s,n=t.next(\"tr\");if((s=n.length?n.data(\"editable-table-row\"):this.addRow(!1))&&s.$tds[e])if($(s.$tds[e]).hasClass(\"disabled\"))n&&this.focusOnNextRow(n,e,i);else{var a=$(\"textarea,input.text\",s.$tds[e]);a.length&&($(i).trigger(\"blur\"),a.trigger(\"focus\"))}}},{textualColTypes:[\"color\",\"date\",\"email\",\"multiline\",\"number\",\"singleline\",\"template\",\"time\",\"url\"],defaults:{rowIdPrefix:\"\",defaultValues:{},staticRows:!1,minRows:null,maxRows:null,onAddRow:$.noop,onDeleteRow:$.noop},createRow:function(t,e,i,s){var n=$(\"<tr/>\",{\"data-id\":t});for(var a in e)if(e.hasOwnProperty(a)){var r,o=e[a],l=void 0!==s[a]?s[a]:\"\";if(\"heading\"===o.type)r=$(\"<th/>\",{scope:\"row\",class:o.class,html:l});else{var h=i+\"[\"+t+\"][\"+a+\"]\",d=Craft.inArray(o.type,Craft.EditableTable.textualColTypes);switch(r=$(\"<td/>\",{class:o.class,width:o.width}),d&&r.addClass(\"textual\"),o.code&&r.addClass(\"code\"),o.type){case\"checkbox\":Craft.ui.createCheckbox({name:h,value:o.value||\"1\",checked:!!l}).appendTo(r);break;case\"color\":Craft.ui.createColorInput({name:h,value:l,small:!0}).appendTo(r);break;case\"date\":Craft.ui.createDateInput({name:h,value:l}).appendTo(r);break;case\"lightswitch\":Craft.ui.createLightswitch({name:h,value:o.value||\"1\",on:!!l,small:!0}).appendTo(r);break;case\"select\":Craft.ui.createSelect({name:h,options:o.options,value:l||function(){for(var t in o.options)if(o.options.hasOwnProperty(t)&&o.options[t].default)return void 0!==o.options[t].value?o.options[t].value:t;return null}(),class:\"small\"}).appendTo(r);break;case\"time\":Craft.ui.createTimeInput({name:h,value:l}).appendTo(r);break;case\"email\":case\"url\":Craft.ui.createTextInput({name:h,value:l,type:o.type,placeholder:o.placeholder||null}).appendTo(r);break;default:$(\"<textarea/>\",{name:h,rows:1,val:l,placeholder:o.placeholder}).appendTo(r)}}r.appendTo(n)}return $(\"<td/>\",{class:\"thin action\"}).append($(\"<a/>\",{class:\"move icon\",title:Craft.t(\"app\",\"Reorder\")})).appendTo(n),$(\"<td/>\",{class:\"thin action\"}).append($(\"<a/>\",{class:\"delete icon\",title:Craft.t(\"app\",\"Delete\")})).appendTo(n),n}}),Craft.EditableTable.Row=Garnish.Base.extend({table:null,id:null,niceTexts:null,$tr:null,$tds:null,tds:null,$textareas:null,$deleteBtn:null,init:function(t,e){this.table=t,this.$tr=$(e),this.$tds=this.$tr.children(),this.tds=[],this.id=this.$tr.attr(\"data-id\"),this.$tr.data(\"editable-table-row\",this);var i=parseInt(this.id.substr(this.table.settings.rowIdPrefix.length));i>this.table.biggestId&&(this.table.biggestId=i),this.$textareas=$(),this.niceTexts=[];var s,n,a,r,o,l={},h=0;for(s in this.table.columns)this.table.columns.hasOwnProperty(s)&&(n=this.table.columns[s],a=this.tds[s]=this.$tds[h],Craft.inArray(n.type,Craft.EditableTable.textualColTypes)?(r=$(\"textarea, input.text\",a),this.$textareas=this.$textareas.add(r),this.addListener(r,\"focus\",\"onTextareaFocus\"),this.addListener(r,\"mousedown\",\"ignoreNextTextareaFocus\"),this.niceTexts.push(new Garnish.NiceText(r,{onHeightChange:$.proxy(this,\"onTextareaHeightChange\")})),this.addListener(r,\"keypress\",{tdIndex:h,type:n.type},\"handleKeypress\"),this.addListener(r,\"textchange\",{type:n.type},\"validateValue\"),r.trigger(\"textchange\"),l[s]=r):\"checkbox\"===n.type&&(o=$('input[type=\"checkbox\"]',a),n.radioMode&&(void 0===this.table.radioCheckboxes[s]&&(this.table.radioCheckboxes[s]=[]),this.table.radioCheckboxes[s].push(o[0]),this.addListener(o,\"change\",{colId:s},\"onRadioCheckboxChange\")),n.toggle&&this.addListener(o,\"change\",{colId:s},function(t){this.applyToggleCheckbox(t.data.colId)})),h++);for(s in this.onTextareaHeightChange(),this.table.columns)!this.table.columns.hasOwnProperty(s)||\"checkbox\"===(n=this.table.columns[s]).type&&n.toggle&&this.applyToggleCheckbox(s);for(s in this.table.columns)!this.table.columns.hasOwnProperty(s)||(n=this.table.columns[s]).autopopulate&&void 0!==l[n.autopopulate]&&!l[s].val()&&new Craft.HandleGenerator(l[s],l[n.autopopulate],{allowNonAlphaStart:!0});var d=this.$tr.children().last().find(\".delete\");this.addListener(d,\"click\",\"deleteRow\")},onTextareaFocus:function(t){this.onTextareaHeightChange();var e=$(t.currentTarget);e.data(\"ignoreNextFocus\")?e.data(\"ignoreNextFocus\",!1):setTimeout(function(){Craft.selectFullValue(e)},0)},onRadioCheckboxChange:function(t){if(t.currentTarget.checked)for(var e=0;e<this.table.radioCheckboxes[t.data.colId].length;e++){var i=this.table.radioCheckboxes[t.data.colId][e];i.checked=i===t.currentTarget}},applyToggleCheckbox:function(t){for(var e,i,s=this.table.columns[t],n=$('input[type=\"checkbox\"]',this.tds[t]).prop(\"checked\"),a=0;a<s.toggle.length;a++)e=s.toggle[a],this.table.colum,(i=\"!\"===e[0])&&(e=e.substr(1)),n&&!i||!n&&i?$(this.tds[e]).removeClass(\"disabled\").find(\"textarea, input\").prop(\"disabled\",!1):$(this.tds[e]).addClass(\"disabled\").find(\"textarea, input\").prop(\"disabled\",!0)},ignoreNextTextareaFocus:function(t){$.data(t.currentTarget,\"ignoreNextFocus\",!0)},handleKeypress:function(t){var e=t.keyCode?t.keyCode:t.charCode,i=Garnish.isCtrlKeyPressed(t);if(e===Garnish.RETURN_KEY&&(\"multiline\"!==t.data.type||i))return t.preventDefault(),void(t.shiftKey?this.table.focusOnPrevRow(this.$tr,t.data.tdIndex,t.currentTarget):this.table.focusOnNextRow(this.$tr,t.data.tdIndex,t.currentTarget));\"number\"!==t.data.type||i||Craft.inArray(e,Craft.EditableTable.Row.numericKeyCodes)||t.preventDefault()},validateValue:function(t){if(\"multiline\"!==t.data.type){var e;if(\"number\"===t.data.type){var i=t.currentTarget.value.match(/^\\s*(-?[\\d\\\\.]*)/);e=null!==i?i[1]:\"\"}else e=t.currentTarget.value.replace(/[\\r\\n]/g,\"\");e!==t.currentTarget.value&&(t.currentTarget.value=e)}},onTextareaHeightChange:function(){for(var t=-1,e=0;e<this.niceTexts.length;e++)this.niceTexts[e].height>t&&(t=this.niceTexts[e].height);this.$textareas.css(\"min-height\",t);var i=this.$textareas.filter(\":visible\").first().parent().height();t<i&&this.$textareas.css(\"min-height\",i)},deleteRow:function(){this.table.deleteRow(this)}},{numericKeyCodes:[9,8,37,38,39,40,45,91,46,190,48,49,50,51,52,53,54,55,56,57]}),Craft.ElementActionTrigger=Garnish.Base.extend({maxLevels:null,newChildUrl:null,$trigger:null,$selectedItems:null,triggerEnabled:!0,init:function(t){this.setSettings(t,Craft.ElementActionTrigger.defaults),this.$trigger=$(\"#\"+t.type.replace(/[\\[\\]\\\\]+/g,\"-\")+\"-actiontrigger\"),this.settings.activate&&(this.$trigger.data(\"custom-handler\",!0),\"FORM\"===this.$trigger.prop(\"nodeName\")?this.addListener(this.$trigger,\"submit\",\"handleTriggerActivation\"):this.addListener(this.$trigger,\"click\",\"handleTriggerActivation\")),this.updateTrigger(),Craft.elementIndex.on(\"selectionChange\",$.proxy(this,\"updateTrigger\"))},updateTrigger:function(){0!==Craft.elementIndex.getSelectedElements().length&&(this.validateSelection()?this.enableTrigger():this.disableTrigger())},validateSelection:function(){var t=!0;return this.$selectedItems=Craft.elementIndex.getSelectedElements(),!this.settings.batch&&1<this.$selectedItems.length?t=!1:\"function\"==typeof this.settings.validateSelection&&(t=this.settings.validateSelection(this.$selectedItems)),t},enableTrigger:function(){this.triggerEnabled||(this.$trigger.removeClass(\"disabled\"),this.triggerEnabled=!0)},disableTrigger:function(){this.triggerEnabled&&(this.$trigger.addClass(\"disabled\"),this.triggerEnabled=!1)},handleTriggerActivation:function(t){t.preventDefault(),t.stopPropagation(),this.triggerEnabled&&this.settings.activate(this.$selectedItems)}},{defaults:{type:null,batch:!0,validateSelection:null,activate:null}}),Craft.ElementThumbLoader=Garnish.Base.extend({queue:null,workers:[],init:function(){this.queue=[];for(var t=0;t<3;t++)this.workers.push(new Craft.ElementThumbLoader.Worker(this))},load:function(t){if(this.queue=this.queue.concat(t.find(\".elementthumb\").toArray()),this.queue.length)for(var e=0;e<this.workers.length;e++)this.workers[e].active||this.workers[e].loadNext()},destroy:function(){for(var t=0;t<this.workers.length;t++)this.workers[t].destroy();this.base()}}),Craft.ElementThumbLoader.Worker=Garnish.Base.extend({loader:null,active:!1,init:function(t){this.loader=t},loadNext:function(){var t=this.loader.queue.shift();if(void 0!==t){this.active=!0;var e=$(t);if(e.find(\"img\").length)this.loadNext();else{var i=$(\"<img/>\",{sizes:e.attr(\"data-sizes\"),srcset:e.attr(\"data-srcset\"),alt:\"\"});this.addListener(i,\"load\",\"loadNext\"),i.appendTo(e),picturefill({elements:[i[0]]})}}else this.active=!1}}),Craft.ElevatedSessionForm=Garnish.Base.extend({$form:null,inputs:null,init:function(t,e){if(this.$form=$(t),void 0!==e){this.inputs=[],e=$.makeArray(e);for(var i=0;i<e.length;i++)for(var s=$(e[i]),n=0;n<s.length;n++){var a=s.eq(n);this.inputs.push({input:a,val:Garnish.getInputPostVal(a)})}}this.addListener(this.$form,\"submit\",\"handleFormSubmit\")},handleFormSubmit:function(t){if(Craft.elevatedSessionManager.fetchingTimeout)t.preventDefault();else{if(this.inputs){for(var e,i=!1,s=0;s<this.inputs.length;s++)if((e=this.inputs[s].input).data(\"passwordInput\")&&(e=e.data(\"passwordInput\").$currentInput),Garnish.getInputPostVal(e)!==this.inputs[s].val){i=!0;break}if(!i)return}t.preventDefault(),Craft.elevatedSessionManager.requireElevatedSession($.proxy(this,\"submitForm\"))}},submitForm:function(){this.disable(),this.$form.trigger(\"submit\"),this.enable()}}),Craft.ElevatedSessionManager=Garnish.Base.extend({fetchingTimeout:!1,passwordModal:null,$passwordInput:null,$passwordSpinner:null,$submitBtn:null,$errorPara:null,callback:null,requireElevatedSession:function(t){this.callback=t,this.fetchingTimeout=!0,Craft.postActionRequest(\"users/get-elevated-session-timeout\",$.proxy(function(t,e){this.fetchingTimeout=!1,\"success\"===e&&(!1===t.timeout||t.timeout>=Craft.ElevatedSessionManager.minSafeElevatedSessionTimeout?this.callback():this.showPasswordModal())},this))},showPasswordModal:function(){if(this.passwordModal)this.passwordModal.show();else{var t=$('<form id=\"elevatedsessionmodal\" class=\"modal secure fitted\"/>'),e=$('<div class=\"body\"><p>'+Craft.t(\"app\",\"Enter your password to continue.\")+\"</p></div>\").appendTo(t),i=$('<div class=\"inputcontainer\">').appendTo(e),s=$('<div class=\"flex\"/>').appendTo(i),n=$('<div class=\"flex-grow\"/>').appendTo(s),a=$(\"<td/>\").appendTo(s),r=$('<div class=\"passwordwrapper\"/>').appendTo(n);this.$passwordInput=$('<input type=\"password\" class=\"text password fullwidth\" placeholder=\"'+Craft.t(\"app\",\"Password\")+'\" autocomplete=\"current-password\"/>').appendTo(r),this.$passwordSpinner=$('<div class=\"spinner hidden\"/>').appendTo(i),this.$submitBtn=$('<input type=\"submit\" class=\"btn submit disabled\" value=\"'+Craft.t(\"app\",\"Submit\")+'\" />').appendTo(a),this.$errorPara=$('<p class=\"error\"/>').appendTo(e),this.passwordModal=new Garnish.Modal(t,{closeOtherModals:!1,onFadeIn:$.proxy(function(){setTimeout($.proxy(this,\"focusPasswordInput\"),100)},this),onFadeOut:$.proxy(function(){this.$passwordInput.val(\"\")},this)}),new Craft.PasswordInput(this.$passwordInput,{onToggleInput:$.proxy(function(t){this.$passwordInput=t},this)}),this.addListener(this.$passwordInput,\"textchange\",\"validatePassword\"),this.addListener(t,\"submit\",\"submitPassword\")}},focusPasswordInput:function(){Garnish.isMobileBrowser(!0)||this.$passwordInput.trigger(\"focus\")},validatePassword:function(){return 6<=this.$passwordInput.val().length?(this.$submitBtn.removeClass(\"disabled\"),!0):(this.$submitBtn.addClass(\"disabled\"),!1)},submitPassword:function(t){if(t&&t.preventDefault(),this.validatePassword()){this.$passwordSpinner.removeClass(\"hidden\"),this.clearLoginError();var e={currentPassword:this.$passwordInput.val()};Craft.postActionRequest(\"users/start-elevated-session\",e,$.proxy(function(t,e){this.$passwordSpinner.addClass(\"hidden\"),\"success\"===e?t.success?(this.passwordModal.hide(),this.callback()):(this.showPasswordError(t.message||Craft.t(\"app\",\"Incorrect password.\")),Garnish.shake(this.passwordModal.$container),this.focusPasswordInput()):this.showPasswordError()},this))}},showPasswordError:function(t){null==t&&(t=Craft.t(\"app\",\"An unknown error occurred.\")),this.$errorPara.text(t),this.passwordModal.updateSizeAndPosition()},clearLoginError:function(){this.showPasswordError(\"\")}},{minSafeElevatedSessionTimeout:5}),Craft.elevatedSessionManager=new Craft.ElevatedSessionManager,Craft.EntryIndex=Craft.BaseElementIndex.extend({publishableSections:null,$newEntryBtnGroup:null,$newEntryBtn:null,init:function(t,e,i){this.on(\"selectSource\",$.proxy(this,\"updateButton\")),this.on(\"selectSite\",$.proxy(this,\"updateButton\")),this.base(t,e,i)},afterInit:function(){this.publishableSections=[];for(var t=0;t<Craft.publishableSections.length;t++){var e=Craft.publishableSections[t];this.getSourceByKey(\"section:\"+e.uid)&&this.publishableSections.push(e)}this.base()},getDefaultSourceKey:function(){if(\"index\"===this.settings.context&&\"undefined\"!=typeof defaultSectionHandle){if(\"singles\"===defaultSectionHandle)return\"singles\";for(var t=0;t<this.$sources.length;t++){var e=$(this.$sources[t]);if(e.data(\"handle\")===defaultSectionHandle)return e.data(\"key\")}}return this.base()},updateButton:function(){if(this.$source){var t,e,i,s;if(t=\"singles\"===this.$source.data(\"key\")?\"singles\":this.$source.data(\"handle\"),this.publishableSections.length){var n,a;if(this.$newEntryBtnGroup&&this.$newEntryBtnGroup.remove(),t)for(e=0;e<this.publishableSections.length;e++)if(this.publishableSections[e].handle===t){n=this.publishableSections[e];break}if(this.$newEntryBtnGroup=$('<div class=\"btngroup submit\"/>'),n?(i=this._getSectionTriggerHref(n),s=\"index\"===this.settings.context?Craft.t(\"app\",\"New entry\"):Craft.t(\"app\",\"New {section} entry\",{section:n.name}),this.$newEntryBtn=$('<a class=\"btn submit add icon\" '+i+\">\"+Craft.escapeHtml(s)+\"</a>\").appendTo(this.$newEntryBtnGroup),\"index\"!==this.settings.context&&this.addListener(this.$newEntryBtn,\"click\",function(t){this._openCreateEntryModal(t.currentTarget.getAttribute(\"data-id\"))}),1<this.publishableSections.length&&(a=$('<div class=\"btn submit menubtn\"></div>').appendTo(this.$newEntryBtnGroup))):this.$newEntryBtn=a=$('<div class=\"btn submit add icon menubtn\">'+Craft.t(\"app\",\"New entry\")+\"</div>\").appendTo(this.$newEntryBtnGroup),a){var r='<div class=\"menu\"><ul>';for(e=0;e<this.publishableSections.length;e++){var o=this.publishableSections[e];(\"index\"===this.settings.context&&-1!==$.inArray(this.siteId,o.sites)||\"index\"!==this.settings.context&&o!==n)&&(i=this._getSectionTriggerHref(o),s=\"index\"===this.settings.context?o.name:Craft.t(\"app\",\"New {section} entry\",{section:o.name}),r+=\"<li><a \"+i+'\">'+Craft.escapeHtml(s)+\"</a></li>\")}$(r+=\"</ul></div>\").appendTo(this.$newEntryBtnGroup);var l=new Garnish.MenuBtn(a);\"index\"!==this.settings.context&&l.on(\"optionSelect\",$.proxy(function(t){this._openCreateEntryModal(t.option.getAttribute(\"data-id\"))},this))}this.addButton(this.$newEntryBtnGroup)}if(\"index\"===this.settings.context&&\"undefined\"!=typeof history){var h=\"entries\";t&&(h+=\"/\"+t),history.replaceState({},\"\",Craft.getUrl(h))}}},_getSectionTriggerHref:function(t){if(\"index\"!==this.settings.context)return'data-id=\"'+t.id+'\"';var e=\"entries/\"+t.handle+\"/new\";if(params={},this.siteId)for(var i=0;i<Craft.sites.length;i++)Craft.sites[i].id==this.siteId&&(params.site=Craft.sites[i].handle);return'href=\"'+Craft.getUrl(e,params)+'\"'},_openCreateEntryModal:function(t){if(!this.$newEntryBtn.hasClass(\"loading\")){for(var i,e=0;e<this.publishableSections.length;e++)if(this.publishableSections[e].id==t){i=this.publishableSections[e];break}if(i){this.$newEntryBtn.addClass(\"inactive\");var s=this.$newEntryBtn.text();this.$newEntryBtn.text(Craft.t(\"app\",\"New {section} entry\",{section:i.name})),Craft.createElementEditor(this.elementType,{hudTrigger:this.$newEntryBtnGroup,elementType:\"craft\\\\elements\\\\Entry\",siteId:this.siteId,attributes:{sectionId:t,typeId:i.entryTypes[0].id},onBeginLoading:$.proxy(function(){this.$newEntryBtn.addClass(\"loading\")},this),onEndLoading:$.proxy(function(){this.$newEntryBtn.removeClass(\"loading\")},this),onHideHud:$.proxy(function(){this.$newEntryBtn.removeClass(\"inactive\").text(s)},this),onSaveElement:$.proxy(function(t){var e=\"section:\"+i.uid;this.sourceKey!==e&&this.selectSourceByKey(e),this.selectElementAfterUpdate(t.id),this.updateElements()},this)})}}}}),Craft.registerElementIndexClass(\"craft\\\\elements\\\\Entry\",Craft.EntryIndex),Craft.FieldLayoutDesigner=Garnish.Base.extend({$container:null,$tabContainer:null,$unusedFieldContainer:null,$newTabBtn:null,$allFields:null,tabGrid:null,unusedFieldGrid:null,tabDrag:null,fieldDrag:null,init:function(t,e){this.$container=$(t),this.setSettings(e,Craft.FieldLayoutDesigner.defaults),this.$tabContainer=this.$container.children(\".fld-tabs\"),this.$unusedFieldContainer=this.$container.children(\".unusedfields\"),this.$newTabBtn=this.$container.find(\"> .newtabbtn-container > .btn\"),this.$allFields=this.$unusedFieldContainer.find(\".fld-field\"),this.tabGrid=new Craft.Grid(this.$tabContainer,Craft.FieldLayoutDesigner.gridSettings),this.unusedFieldGrid=new Craft.Grid(this.$unusedFieldContainer,Craft.FieldLayoutDesigner.gridSettings);for(var i=this.$tabContainer.children(),s=0;s<i.length;s++)this.initTab($(i[s]));this.fieldDrag=new Craft.FieldLayoutDesigner.FieldDrag(this),this.settings.customizableTabs&&(this.tabDrag=new Craft.FieldLayoutDesigner.TabDrag(this),this.addListener(this.$newTabBtn,\"activate\",\"addTab\"))},initTab:function(t){if(this.settings.customizableTabs){var e=t.find(\".tabs .settings\"),i=$('<div class=\"menu\" data-align=\"center\"/>').insertAfter(e),s=$(\"<ul/>\").appendTo(i);$('<li><a data-action=\"rename\">'+Craft.t(\"app\",\"Rename\")+\"</a></li>\").appendTo(s),$('<li><a data-action=\"delete\">'+Craft.t(\"app\",\"Delete\")+\"</a></li>\").appendTo(s),new Garnish.MenuBtn(e,{onOptionSelect:$.proxy(this,\"onTabOptionSelect\")})}for(var n=t.children(\".fld-tabcontent\").children(),a=0;a<n.length;a++)this.initField($(n[a]))},initField:function(t){var e=t.find(\".settings\"),i=$('<div class=\"menu\" data-align=\"center\"/>').insertAfter(e),s=$(\"<ul/>\").appendTo(i);t.hasClass(\"fld-required\")?$('<li><a data-action=\"toggle-required\">'+Craft.t(\"app\",\"Make not required\")+\"</a></li>\").appendTo(s):$('<li><a data-action=\"toggle-required\">'+Craft.t(\"app\",\"Make required\")+\"</a></li>\").appendTo(s),$('<li><a data-action=\"remove\">'+Craft.t(\"app\",\"Remove\")+\"</a></li>\").appendTo(s),new Garnish.MenuBtn(e,{onOptionSelect:$.proxy(this,\"onFieldOptionSelect\")})},onTabOptionSelect:function(t){if(this.settings.customizableTabs){var e=$(t),i=e.data(\"menu\").$anchor.parent().parent().parent();switch(e.data(\"action\")){case\"rename\":this.renameTab(i);break;case\"delete\":this.deleteTab(i)}}},onFieldOptionSelect:function(t){var e=$(t),i=e.data(\"menu\").$anchor.parent();switch(e.data(\"action\")){case\"toggle-required\":this.toggleRequiredField(i,e);break;case\"remove\":this.removeField(i)}},renameTab:function(t){if(this.settings.customizableTabs){var e=t.find(\".tabs .tab span\"),i=e.text(),s=prompt(Craft.t(\"app\",\"Give your tab a name.\"),i);s&&s!==i&&(e.text(s),t.find(\".id-input\").attr(\"name\",this.getFieldInputName(s)))}},deleteTab:function(t){if(this.settings.customizableTabs){for(var e=t.find(\".fld-field\"),i=0;i<e.length;i++){var s=$(e[i]).attr(\"data-id\");this.removeFieldById(s)}this.tabGrid.removeItems(t),this.tabDrag.removeItems(t),t.remove()}},toggleRequiredField:function(t,e){t.hasClass(\"fld-required\")?(t.removeClass(\"fld-required\"),t.find(\".required-input\").remove(),setTimeout(function(){e.text(Craft.t(\"app\",\"Make required\"))},500)):(t.addClass(\"fld-required\"),$('<input class=\"required-input\" type=\"hidden\" name=\"'+this.settings.requiredFieldInputName+'\" value=\"'+t.data(\"id\")+'\">').appendTo(t),setTimeout(function(){e.text(Craft.t(\"app\",\"Make not required\"))},500))},removeField:function(t){var e=t.attr(\"data-id\");t.remove(),this.removeFieldById(e),this.tabGrid.refreshCols(!0)},removeFieldById:function(t){var e=this.$allFields.filter(\"[data-id=\"+t+\"]:first\"),i=e.closest(\".fld-tab\");e.removeClass(\"hidden\"),i.hasClass(\"hidden\")?(i.removeClass(\"hidden\"),this.unusedFieldGrid.addItems(i),this.settings.customizableTabs&&this.tabDrag.addItems(i)):this.unusedFieldGrid.refreshCols(!0)},addTab:function(){if(this.settings.customizableTabs){var t=$('<div class=\"fld-tab\"><div class=\"tabs\"><div class=\"tab sel draggable\"><span>Tab '+(this.tabGrid.$items.length+1)+'</span><a class=\"settings icon\" title=\"'+Craft.t(\"app\",\"Rename\")+'\"></a></div></div><div class=\"fld-tabcontent\"></div></div>').appendTo(this.$tabContainer);this.tabGrid.addItems(t),this.tabDrag.addItems(t),this.initTab(t)}},getFieldInputName:function(t){return this.settings.fieldInputName.replace(/__TAB_NAME__/g,Craft.encodeUriComponent(t))}},{gridSettings:{itemSelector:\".fld-tab:not(.hidden)\",minColWidth:240,fillMode:\"grid\",snapToGrid:30},defaults:{customizableTabs:!0,fieldInputName:\"fieldLayout[__TAB_NAME__][]\",requiredFieldInputName:\"requiredFields[]\"}}),Craft.FieldLayoutDesigner.BaseDrag=Garnish.Drag.extend({designer:null,$insertion:null,showingInsertion:!1,$caboose:null,draggingUnusedItem:!1,addToTabGrid:!1,init:function(t,e){this.designer=t;var i=this.designer.$tabContainer.find(this.itemSelector).add(this.designer.$unusedFieldContainer.find(this.itemSelector));this.base(i,e)},onDragStart:function(){this.base(),this.draggingUnusedItem=this.$draggee.hasClass(\"unused\"),this.$insertion=this.getInsertion(),this.addCaboose(),this.$items=$().add(this.$items.add(this.$caboose)),this.addToTabGrid&&this.designer.tabGrid.addItems(this.$caboose),this.draggingUnusedItem?this.showingInsertion=!1:(this.$insertion.insertBefore(this.$draggee),this.$draggee.detach(),this.$items=$().add(this.$items.not(this.$draggee).add(this.$insertion)),this.showingInsertion=!0,this.addToTabGrid&&(this.designer.tabGrid.removeItems(this.$draggee),this.designer.tabGrid.addItems(this.$insertion))),this.setMidpoints()},addCaboose:$.noop,getItemContainer:$.noop,isItemInTabContainer:function(t){return this.getItemContainer(t)[0]===this.designer.$tabContainer[0]},setMidpoints:function(){for(var t=0;t<this.$items.length;t++){var e=$(this.$items[t]);if(this.isItemInTabContainer(e)){var i=e.offset();e.data(\"midpoint\",{left:i.left+e.outerWidth()/2,top:i.top+e.outerHeight()/2})}}},onDrag:function(){this.draggingUnusedItem&&!Garnish.hitTest(this.mouseX,this.mouseY,this.designer.$tabContainer)?this.showingInsertion&&(this.$insertion.remove(),this.$items=$().add(this.$items.not(this.$insertion)),this.showingInsertion=!1,this.addToTabGrid?this.designer.tabGrid.removeItems(this.$insertion):this.designer.tabGrid.refreshCols(!0),this.setMidpoints()):(this.onDrag._closestItem=this.getClosestItem(),this.onDrag._closestItem!==this.$insertion[0]&&(this.showingInsertion&&$.inArray(this.$insertion[0],this.$items)<$.inArray(this.onDrag._closestItem,this.$items)&&-1===$.inArray(this.onDrag._closestItem,this.$caboose)?this.$insertion.insertAfter(this.onDrag._closestItem):this.$insertion.insertBefore(this.onDrag._closestItem),this.$items=$().add(this.$items.add(this.$insertion)),this.showingInsertion=!0,this.addToTabGrid?this.designer.tabGrid.addItems(this.$insertion):this.designer.tabGrid.refreshCols(!0),this.setMidpoints())),this.base()},getClosestItem:function(){for(this.getClosestItem._closestItem=null,this.getClosestItem._closestItemMouseDiff=null,this.getClosestItem._i=0;this.getClosestItem._i<this.$items.length;this.getClosestItem._i++)this.getClosestItem._$item=$(this.$items[this.getClosestItem._i]),this.isItemInTabContainer(this.getClosestItem._$item)&&(this.getClosestItem._midpoint=this.getClosestItem._$item.data(\"midpoint\"),this.getClosestItem._mouseDiff=Garnish.getDist(this.getClosestItem._midpoint.left,this.getClosestItem._midpoint.top,this.mouseX,this.mouseY),(null===this.getClosestItem._closestItem||this.getClosestItem._mouseDiff<this.getClosestItem._closestItemMouseDiff)&&(this.getClosestItem._closestItem=this.getClosestItem._$item[0],this.getClosestItem._closestItemMouseDiff=this.getClosestItem._mouseDiff));return this.getClosestItem._closestItem},onDragStop:function(){this.showingInsertion&&(this.$insertion.replaceWith(this.$draggee),this.$items=$().add(this.$items.not(this.$insertion).add(this.$draggee)),this.addToTabGrid&&(this.designer.tabGrid.removeItems(this.$insertion),this.designer.tabGrid.addItems(this.$draggee))),this.$items=this.$items.not(this.$caboose),this.$caboose.remove(),this.addToTabGrid&&this.designer.tabGrid.removeItems(this.$caboose),this.$draggee.css({display:this.draggeeDisplay,visibility:\"hidden\"}),this.designer.tabGrid.refreshCols(!0),this.designer.unusedFieldGrid.refreshCols(!0),this.returnHelpersToDraggees(),this.base()}}),Craft.FieldLayoutDesigner.TabDrag=Craft.FieldLayoutDesigner.BaseDrag.extend({itemSelector:\"> div.fld-tab\",addToTabGrid:!0,init:function(t){this.base(t,{handle:\".tab\"})},addCaboose:function(){this.$caboose=$('<div class=\"fld-tab fld-tab-caboose\"/>').appendTo(this.designer.$tabContainer)},getInsertion:function(){var t=this.$draggee.find(\".tab\");return $('<div class=\"fld-tab fld-insertion\" style=\"height: '+this.$draggee.height()+'px;\"><div class=\"tabs\"><div class=\"tab sel draggable\" style=\"width: '+t.width()+\"px; height: \"+t.height()+'px;\"></div></div><div class=\"fld-tabcontent\" style=\"height: '+this.$draggee.find(\".fld-tabcontent\").height()+'px;\"></div></div>')},getItemContainer:function(t){return t.parent()},onDragStop:function(){if(this.draggingUnusedItem&&this.showingInsertion){var t=this.$draggee.clone().removeClass(\"unused\"),e=t.find(\".tab span\").text();t.find(\".fld-field\").removeClass(\"unused\"),t.find(\".tabs .tab\").append('<a class=\"settings icon\" title=\"'+Craft.t(\"app\",\"Edit\")+'\"></a>');var i=t.find(\".fld-field\"),s=i.filter(\".hidden\").remove();(i=i.not(s)).prepend('<a class=\"settings icon\" title=\"'+Craft.t(\"app\",\"Edit\")+'\"></a>');for(var n=0;n<i.length;n++){var a=$(i[n]),r=this.designer.getFieldInputName(e);a.append('<input class=\"id-input\" type=\"hidden\" name=\"'+r+'\" value=\"'+a.data(\"id\")+'\">')}this.designer.fieldDrag.addItems(i),this.designer.initTab(t),this.$draggee.css({visibility:\"inherit\",display:\"field\"}).addClass(\"hidden\"),this.$draggee.find(\".fld-field\").addClass(\"hidden\"),this.$draggee=t,this.addItems(t),this.designer.tabGrid.addItems(t),this.designer.unusedFieldGrid.removeItems(this.$draggee)}this.base()}}),Craft.FieldLayoutDesigner.FieldDrag=Craft.FieldLayoutDesigner.BaseDrag.extend({itemSelector:\"> div.fld-tab .fld-field\",addCaboose:function(){this.$caboose=$();for(var t=this.designer.$tabContainer.children().children(\".fld-tabcontent\"),e=0;e<t.length;e++){var i=$('<div class=\"fld-tab fld-tab-caboose\"/>').appendTo(t[e]);this.$caboose=this.$caboose.add(i)}},getInsertion:function(){return $('<div class=\"fld-field fld-insertion\" style=\"height: '+this.$draggee.height()+'px;\"/>')},getItemContainer:function(t){return t.parent().parent().parent()},onDragStop:function(){if(this.draggingUnusedItem&&this.showingInsertion){var t=this.$draggee.clone().removeClass(\"unused\");if(t.prepend('<a class=\"settings icon\" title=\"'+Craft.t(\"app\",\"Edit\")+'\"></a>'),this.designer.initField(t),this.$draggee.css({visibility:\"inherit\",display:\"field\"}).addClass(\"hidden\"),0===this.$draggee.siblings(\":not(.hidden)\").length){var e=this.$draggee.parent().parent();e.addClass(\"hidden\"),this.designer.unusedFieldGrid.removeItems(e)}this.$draggee=t,this.addItems(t)}if(this.showingInsertion){var i=this.$insertion.parent().parent().find(\".tab span\").text(),s=this.designer.getFieldInputName(i);this.draggingUnusedItem?this.$draggee.append('<input class=\"id-input\" type=\"hidden\" name=\"'+s+'\" value=\"'+this.$draggee.data(\"id\")+'\">'):this.$draggee.find(\".id-input\").attr(\"name\",s)}this.base()}}),Craft.FieldToggle=Garnish.Base.extend({$toggle:null,targetPrefix:null,targetSelector:null,reverseTargetSelector:null,_$target:null,_$reverseTarget:null,type:null,init:function(t){this.$toggle=$(t),this.$toggle.data(\"fieldtoggle\")&&(Garnish.log(\"Double-instantiating a field toggle on an element\"),this.$toggle.data(\"fieldtoggle\").destroy()),this.$toggle.data(\"fieldtoggle\",this),this.type=this.getType(),\"select\"===this.type?this.targetPrefix=this.$toggle.attr(\"data-target-prefix\")||\"\":(this.targetSelector=this.normalizeTargetSelector(this.$toggle.data(\"target\")),this.reverseTargetSelector=this.normalizeTargetSelector(this.$toggle.data(\"reverse-target\"))),this.findTargets(),\"link\"===this.type?this.addListener(this.$toggle,\"click\",\"onToggleChange\"):this.addListener(this.$toggle,\"change\",\"onToggleChange\")},normalizeTargetSelector:function(t){return t&&!t.match(/^[#\\.]/)&&(t=\"#\"+t),t},getType:function(){return\"INPUT\"===this.$toggle.prop(\"nodeName\")&&\"checkbox\"===this.$toggle.attr(\"type\").toLowerCase()?\"checkbox\":\"SELECT\"===this.$toggle.prop(\"nodeName\")?\"select\":\"A\"===this.$toggle.prop(\"nodeName\")?\"link\":\"DIV\"===this.$toggle.prop(\"nodeName\")&&this.$toggle.hasClass(\"lightswitch\")?\"lightswitch\":void 0},findTargets:function(){\"select\"===this.type?this._$target=$(this.normalizeTargetSelector(this.targetPrefix+this.getToggleVal())):(this.targetSelector&&(this._$target=$(this.targetSelector)),this.reverseTargetSelector&&(this._$reverseTarget=$(this.reverseTargetSelector)))},getToggleVal:function(){if(\"lightswitch\"===this.type)return this.$toggle.children(\"input\").val();var t=Garnish.getInputPostVal(this.$toggle);return null===t?null:t.replace(/[\\[\\]\\\\]+/g,\"-\")},onToggleChange:function(){\"select\"===this.type?(this.hideTarget(this._$target),this.findTargets(),this.showTarget(this._$target)):(\"link\"===this.type?this.onToggleChange._show=this.$toggle.hasClass(\"collapsed\")||!this.$toggle.hasClass(\"expanded\"):this.onToggleChange._show=!!this.getToggleVal(),this.onToggleChange._show?(this.showTarget(this._$target),this.hideTarget(this._$reverseTarget)):(this.hideTarget(this._$target),this.showTarget(this._$reverseTarget)),delete this.onToggleChange._show)},showTarget:function(t){t&&t.length&&(this.showTarget._currentHeight=t.height(),t.removeClass(\"hidden\"),\"select\"!==this.type&&(\"link\"===this.type&&(this.$toggle.removeClass(\"collapsed\"),this.$toggle.addClass(\"expanded\")),t.height(\"auto\"),this.showTarget._targetHeight=t.height(),t.css({height:this.showTarget._currentHeight,overflow:\"hidden\"}),t.velocity(\"stop\"),t.velocity({height:this.showTarget._targetHeight},\"fast\",function(){t.css({height:\"\",overflow:\"\"})}),delete this.showTarget._targetHeight),delete this.showTarget._currentHeight,Garnish.$win.trigger(\"resize\"))},hideTarget:function(t){t&&t.length&&(\"select\"===this.type?t.addClass(\"hidden\"):(\"link\"===this.type&&(this.$toggle.removeClass(\"expanded\"),this.$toggle.addClass(\"collapsed\")),t.css(\"overflow\",\"hidden\"),t.velocity(\"stop\"),t.velocity({height:0},\"fast\",function(){t.addClass(\"hidden\")})))}}),Craft.Grid=Garnish.Base.extend({$container:null,$items:null,items:null,totalCols:null,colGutterDrop:null,colPctWidth:null,possibleItemColspans:null,possibleItemPositionsByColspan:null,itemPositions:null,itemColspansByPosition:null,layouts:null,layout:null,itemHeights:null,leftPadding:null,_refreshingCols:!1,_refreshColsAfterRefresh:!1,_forceRefreshColsAfterRefresh:!1,init:function(t,e){this.$container=$(t),this.$container.data(\"grid\")&&(Garnish.log(\"Double-instantiating a grid on an element\"),this.$container.data(\"grid\").destroy()),this.$container.data(\"grid\",this),this.setSettings(e,Craft.Grid.defaults),this.handleContainerHeightProxy=$.proxy(function(){this.refreshCols(!1,!0)},this),this.$items=this.$container.children(this.settings.itemSelector),this.setItems(),this.refreshCols(!0,!1),Garnish.$doc.ready($.proxy(function(){this.refreshCols(!1,!1)},this))},addItems:function(t){this.$items=$().add(this.$items.add(t)),this.setItems(),this.refreshCols(!0,!0)},removeItems:function(t){this.$items=$().add(this.$items.not(t)),this.setItems(),this.refreshCols(!0,!0)},resetItemOrder:function(){this.$items=$().add(this.$items),this.setItems(),this.refreshCols(!0,!0)},setItems:function(){for(this.setItems._={},this.items=[],this.setItems._.i=0;this.setItems._.i<this.$items.length;this.setItems._.i++)this.items.push($(this.$items[this.setItems._.i]));delete this.setItems._},refreshCols:function(t){if(this._refreshingCols)return this._refreshColsAfterRefresh=!0,void(t&&(this._forceRefreshColsAfterRefresh=!0));if(this._refreshingCols=!0,this.items.length)if(this.refreshCols._={},this.refreshCols._.oldHeight=this.$container[0].style.height,this.$container[0].style.height=1,this.refreshCols._.scrollHeight=this.$container[0].scrollHeight,this.$container[0].style.height=this.refreshCols._.oldHeight,0!==this.refreshCols._.scrollHeight)if(this.settings.cols?this.refreshCols._.totalCols=this.settings.cols:(this.refreshCols._.totalCols=Math.floor(this.$container.width()/this.settings.minColWidth),null!==this.totalCols&&this.refreshCols._.totalCols>this.totalCols&&(this.refreshCols._.totalCols=Math.floor((this.$container.width()-20)/this.settings.minColWidth)),this.settings.maxCols&&this.refreshCols._.totalCols>this.settings.maxCols&&(this.refreshCols._.totalCols=this.settings.maxCols)),0===this.refreshCols._.totalCols&&(this.refreshCols._.totalCols=1),!0===t||this.totalCols!==this.refreshCols._.totalCols){if(this.totalCols=this.refreshCols._.totalCols,this.colGutterDrop=this.settings.gutter*(this.totalCols-1)/this.totalCols,this.removeListener(this.$container,\"resize\"),\"grid\"===this.settings.fillMode)for(this.refreshCols._.itemIndex=0;this.refreshCols._.itemIndex<this.items.length;){for(this.refreshCols._.tallestItemHeight=-1,this.refreshCols._.colIndex=0,this.refreshCols._.i=this.refreshCols._.itemIndex;this.refreshCols._.i<this.refreshCols._.itemIndex+this.totalCols&&this.refreshCols._.i<this.items.length;this.refreshCols._.i++)this.refreshCols._.itemHeight=this.items[this.refreshCols._.i].height(\"auto\").height(),this.refreshCols._.itemHeight>this.refreshCols._.tallestItemHeight&&(this.refreshCols._.tallestItemHeight=this.refreshCols._.itemHeight),this.refreshCols._.colIndex++;for(this.settings.snapToGrid&&(this.refreshCols._.remainder=this.refreshCols._.tallestItemHeight%this.settings.snapToGrid,this.refreshCols._.remainder&&(this.refreshCols._.tallestItemHeight+=this.settings.snapToGrid-this.refreshCols._.remainder)),this.refreshCols._.i=this.refreshCols._.itemIndex;this.refreshCols._.i<this.refreshCols._.itemIndex+this.totalCols&&this.refreshCols._.i<this.items.length;this.refreshCols._.i++)this.items[this.refreshCols._.i].height(this.refreshCols._.tallestItemHeight);this.refreshCols._.itemIndex+=this.totalCols}else if(this.removeListener(this.$items,\"resize\"),1===this.totalCols)this.$container.height(\"auto\"),this.$items.show().css({position:\"relative\",width:\"auto\",top:0}).css(Craft.left,0);else{for(this.$items.css(\"position\",\"absolute\"),this.colPctWidth=100/this.totalCols,this.layouts=[],this.itemPositions=[],this.itemColspansByPosition=[],this.possibleItemColspans=[],this.possibleItemPositionsByColspan=[],this.itemHeightsByColspan=[],this.refreshCols._.item=0;this.refreshCols._.item<this.items.length;this.refreshCols._.item++)for(this.possibleItemColspans[this.refreshCols._.item]=[],this.possibleItemPositionsByColspan[this.refreshCols._.item]={},this.itemHeightsByColspan[this.refreshCols._.item]={},this.refreshCols._.$item=this.items[this.refreshCols._.item].show(),this.refreshCols._.positionRight=\"right\"===this.refreshCols._.$item.data(\"position\"),this.refreshCols._.positionLeft=\"left\"===this.refreshCols._.$item.data(\"position\"),this.refreshCols._.minColspan=this.refreshCols._.$item.data(\"colspan\")?this.refreshCols._.$item.data(\"colspan\"):this.refreshCols._.$item.data(\"min-colspan\")?this.refreshCols._.$item.data(\"min-colspan\"):1,this.refreshCols._.maxColspan=this.refreshCols._.$item.data(\"colspan\")?this.refreshCols._.$item.data(\"colspan\"):this.refreshCols._.$item.data(\"max-colspan\")?this.refreshCols._.$item.data(\"max-colspan\"):this.totalCols,this.refreshCols._.minColspan>this.totalCols&&(this.refreshCols._.minColspan=this.totalCols),this.refreshCols._.maxColspan>this.totalCols&&(this.refreshCols._.maxColspan=this.totalCols),this.refreshCols._.colspan=this.refreshCols._.minColspan;this.refreshCols._.colspan<=this.refreshCols._.maxColspan;this.refreshCols._.colspan++)for(this.refreshCols._.$item.css(\"width\",this.getItemWidthCss(this.refreshCols._.colspan)),this.itemHeightsByColspan[this.refreshCols._.item][this.refreshCols._.colspan]=this.refreshCols._.$item.outerHeight(),this.possibleItemColspans[this.refreshCols._.item].push(this.refreshCols._.colspan),this.possibleItemPositionsByColspan[this.refreshCols._.item][this.refreshCols._.colspan]=[],this.refreshCols._.positionLeft?(this.refreshCols._.minPosition=0,this.refreshCols._.maxPosition=0):this.refreshCols._.positionRight?(this.refreshCols._.minPosition=this.totalCols-this.refreshCols._.colspan,this.refreshCols._.maxPosition=this.refreshCols._.minPosition):(this.refreshCols._.minPosition=0,this.refreshCols._.maxPosition=this.totalCols-this.refreshCols._.colspan),this.refreshCols._.position=this.refreshCols._.minPosition;this.refreshCols._.position<=this.refreshCols._.maxPosition;this.refreshCols._.position++)this.possibleItemPositionsByColspan[this.refreshCols._.item][this.refreshCols._.colspan].push(this.refreshCols._.position);for(this.refreshCols._.colHeights=[],this.refreshCols._.i=0;this.refreshCols._.i<this.totalCols;this.refreshCols._.i++)this.refreshCols._.colHeights.push(0);for(this.createLayouts(0,[],[],this.refreshCols._.colHeights,0),this.refreshCols._.layoutTotalCols=[],this.refreshCols._.i=0;this.refreshCols._.i<this.layouts.length;this.refreshCols._.i++)for(this.refreshCols._.layoutTotalCols[this.refreshCols._.i]=0,this.refreshCols._.j=0;this.refreshCols._.j<this.totalCols;this.refreshCols._.j++)this.layouts[this.refreshCols._.i].colHeights[this.refreshCols._.j]&&this.refreshCols._.layoutTotalCols[this.refreshCols._.i]++;for(this.refreshCols._.highestTotalCols=Math.max.apply(null,this.refreshCols._.layoutTotalCols),this.refreshCols._.i=this.layouts.length-1;0<=this.refreshCols._.i;this.refreshCols._.i--)this.refreshCols._.layoutTotalCols[this.refreshCols._.i]!==this.refreshCols._.highestTotalCols&&this.layouts.splice(this.refreshCols._.i,1);for(this.refreshCols._.layoutHeights=[],this.refreshCols._.i=0;this.refreshCols._.i<this.layouts.length;this.refreshCols._.i++)this.refreshCols._.layoutHeights.push(Math.max.apply(null,this.layouts[this.refreshCols._.i].colHeights));for(this.refreshCols._.shortestHeight=Math.min.apply(null,this.refreshCols._.layoutHeights),this.refreshCols._.shortestLayouts=[],this.refreshCols._.emptySpaces=[],this.refreshCols._.i=0;this.refreshCols._.i<this.refreshCols._.layoutHeights.length;this.refreshCols._.i++)if(this.refreshCols._.layoutHeights[this.refreshCols._.i]===this.refreshCols._.shortestHeight){for(this.refreshCols._.shortestLayouts.push(this.layouts[this.refreshCols._.i]),this.refreshCols._.emptySpace=this.layouts[this.refreshCols._.i].emptySpace,this.refreshCols._.j=0;this.refreshCols._.j<this.totalCols;this.refreshCols._.j++)this.refreshCols._.emptySpace+=this.refreshCols._.shortestHeight-this.layouts[this.refreshCols._.i].colHeights[this.refreshCols._.j];this.refreshCols._.emptySpaces.push(this.refreshCols._.emptySpace)}for(this.layout=this.refreshCols._.shortestLayouts[$.inArray(Math.min.apply(null,this.refreshCols._.emptySpaces),this.refreshCols._.emptySpaces)],this.refreshCols._.i=0;this.refreshCols._.i<this.items.length;this.refreshCols._.i++)this.refreshCols._.css={width:this.getItemWidthCss(this.layout.colspans[this.refreshCols._.i])},this.refreshCols._.css[Craft.left]=this.getItemLeftPosCss(this.layout.positions[this.refreshCols._.i]),this.items[this.refreshCols._.i].css(this.refreshCols._.css);this.isSimpleLayout()?(this.$container.height(\"auto\"),this.$items.css({position:\"relative\",top:0,\"margin-bottom\":this.settings.gutter+\"px\"})):(this.$items.css(\"position\",\"absolute\"),this.positionItems(),this.addListener(this.$items,\"resize\",\"onItemResize\"))}this.completeRefreshCols(),this.addListener(this.$container,\"resize\",this.handleContainerHeightProxy),this.onRefreshCols()}else this.completeRefreshCols();else this.completeRefreshCols();else this.completeRefreshCols()},completeRefreshCols:function(){if(void 0!==this.refreshCols._&&delete this.refreshCols._,this._refreshingCols=!1,this._refreshColsAfterRefresh){var t=this._forceRefreshColsAfterRefresh;this._refreshColsAfterRefresh=!1,this._forceRefreshColsAfterRefresh=!1,Garnish.requestAnimationFrame($.proxy(function(){this.refreshCols(t)},this))}},getItemWidth:function(t){return this.colPctWidth*t},getItemWidthCss:function(t){return\"calc(\"+this.getItemWidth(t)+\"% - \"+this.colGutterDrop+\"px)\"},getItemWidthInPx:function(t){return this.getItemWidth(t)/100*this.$container.width()-this.colGutterDrop},getItemLeftPosCss:function(t){return\"calc((\"+this.getItemWidth(1)+\"% + \"+(this.settings.gutter-this.colGutterDrop)+\"px) * \"+t+\")\"},getItemLeftPosInPx:function(t){return(this.getItemWidth(1)/100*this.$container.width()+(this.settings.gutter-this.colGutterDrop))*t},createLayouts:function(t,e,i,s,n){new Craft.Grid.LayoutGenerator(this).createLayouts(t,e,i,s,n)},isSimpleLayout:function(){for(this.isSimpleLayout._={},this.isSimpleLayout._.i=0;this.isSimpleLayout._.i<this.layout.positions.length;this.isSimpleLayout._.i++)if(0!==this.layout.positions[this.isSimpleLayout._.i])return delete this.isSimpleLayout._,!1;return delete this.isSimpleLayout._,!0},positionItems:function(){for(this.positionItems._={},this.positionItems._.colHeights=[],this.positionItems._.i=0;this.positionItems._.i<this.totalCols;this.positionItems._.i++)this.positionItems._.colHeights.push(0);for(this.positionItems._.i=0;this.positionItems._.i<this.items.length;this.positionItems._.i++){for(this.positionItems._.endingCol=this.layout.positions[this.positionItems._.i]+this.layout.colspans[this.positionItems._.i]-1,this.positionItems._.affectedColHeights=[],this.positionItems._.col=this.layout.positions[this.positionItems._.i];this.positionItems._.col<=this.positionItems._.endingCol;this.positionItems._.col++)this.positionItems._.affectedColHeights.push(this.positionItems._.colHeights[this.positionItems._.col]);for(this.positionItems._.top=Math.max.apply(null,this.positionItems._.affectedColHeights),0<this.positionItems._.top&&(this.positionItems._.top+=this.settings.gutter),this.items[this.positionItems._.i].css(\"top\",this.positionItems._.top),this.positionItems._.col=this.layout.positions[this.positionItems._.i];this.positionItems._.col<=this.positionItems._.endingCol;this.positionItems._.col++)this.positionItems._.colHeights[this.positionItems._.col]=this.positionItems._.top+this.itemHeightsByColspan[this.positionItems._.i][this.layout.colspans[this.positionItems._.i]]}this.$container.height(Math.max.apply(null,this.positionItems._.colHeights)),delete this.positionItems._},onItemResize:function(t){this.onItemResize._={},t.stopPropagation(),this.onItemResize._.item=$.inArray(t.currentTarget,this.$items),-1!==this.onItemResize._.item&&(this.onItemResize._.newHeight=this.items[this.onItemResize._.item].outerHeight(),this.onItemResize._.newHeight!==this.itemHeightsByColspan[this.onItemResize._.item][this.layout.colspans[this.onItemResize._.item]]&&(this.itemHeightsByColspan[this.onItemResize._.item][this.layout.colspans[this.onItemResize._.item]]=this.onItemResize._.newHeight,this.positionItems(!1))),delete this.onItemResize._},onRefreshCols:function(){this.trigger(\"refreshCols\"),this.settings.onRefreshCols()}},{defaults:{itemSelector:\".item\",cols:null,maxCols:null,minColWidth:320,gutter:14,fillMode:\"top\",colClass:\"col\",snapToGrid:null,onRefreshCols:$.noop}}),Craft.Grid.LayoutGenerator=Garnish.Base.extend({grid:null,_:null,init:function(t){this.grid=t},createLayouts:function(t,e,i,s,n){for(this._={},this._.c=0;this._.c<this.grid.possibleItemColspans[t].length;this._.c++){for(this._.colspan=this.grid.possibleItemColspans[t][this._.c],this._.tallestColHeightsByPosition=[],this._.p=0;this._.p<this.grid.possibleItemPositionsByColspan[t][this._.colspan].length;this._.p++){for(this._.position=this.grid.possibleItemPositionsByColspan[t][this._.colspan][this._.p],this._.colHeightsForPosition=[],this._.endingCol=this._.position+this._.colspan-1,this._.col=this._.position;this._.col<=this._.endingCol;this._.col++)this._.colHeightsForPosition.push(s[this._.col]);this._.tallestColHeightsByPosition[this._.p]=Math.max.apply(null,this._.colHeightsForPosition)}for(this._.p=$.inArray(Math.min.apply(null,this._.tallestColHeightsByPosition),this._.tallestColHeightsByPosition),this._.position=this.grid.possibleItemPositionsByColspan[t][this._.colspan][this._.p],this._.positions=e.slice(0),this._.colspans=i.slice(0),this._.colHeights=s.slice(0),this._.emptySpace=n,this._.positions.push(this._.position),this._.colspans.push(this._.colspan),this._.tallestColHeight=this._.tallestColHeightsByPosition[this._.p],this._.endingCol=this._.position+this._.colspan-1,this._.col=this._.position;this._.col<=this._.endingCol;this._.col++)this._.emptySpace+=this._.tallestColHeight-this._.colHeights[this._.col],this._.colHeights[this._.col]=this._.tallestColHeight+this.grid.itemHeightsByColspan[t][this._.colspan];t===this.grid.items.length-1?this.grid.layouts.push({positions:this._.positions,colspans:this._.colspans,colHeights:this._.colHeights,emptySpace:this._.emptySpace}):this.grid.createLayouts(t+1,this._.positions,this._.colspans,this._.colHeights,this._.emptySpace)}delete this._}}),Craft.HandleGenerator=Craft.BaseInputGenerator.extend({generateTargetValue:function(t){var e=t.replace(\"/<(.*?)>/g\",\"\");e=(e=e.replace(/['\"\u2018\u2019\u201c\u201d\\[\\]\\(\\)\\{\\}:]/g,\"\")).toLowerCase(),e=Craft.asciiString(e),this.settings.allowNonAlphaStart||(e=e.replace(/^[^a-z]+/,\"\"));var i=Craft.filterArray(e.split(/[^a-z0-9]+/));e=\"\";for(var s=0;s<i.length;s++)e+=0===s?i[s]:i[s].charAt(0).toUpperCase()+i[s].substr(1);return e}}),Craft.ImageUpload=Garnish.Base.extend({$container:null,progressBar:null,uploader:null,init:function(t){this.setSettings(t,Craft.ImageUpload.defaults),this.initImageUpload()},initImageUpload:function(){this.$container=$(this.settings.containerSelector),this.progressBar=new Craft.ProgressBar($('<div class=\"progress-shade\"></div>').appendTo(this.$container));var t={url:Craft.getActionUrl(this.settings.uploadAction),formData:this.settings.postParameters,fileInput:this.$container.find(this.settings.fileInputSelector),paramName:this.settings.uploadParamName};void 0!==Craft.csrfTokenName&&void 0!==Craft.csrfTokenValue&&(t.formData[Craft.csrfTokenName]=Craft.csrfTokenValue),t.events={},t.events.fileuploadstart=$.proxy(this,\"_onUploadStart\"),t.events.fileuploadprogressall=$.proxy(this,\"_onUploadProgress\"),t.events.fileuploaddone=$.proxy(this,\"_onUploadComplete\"),t.events.fileuploadfail=$.proxy(this,\"_onUploadError\"),this.uploader=new Craft.Uploader(this.$container,t),this.initButtons()},initButtons:function(){this.$container.find(this.settings.uploadButtonSelector).on(\"click\",$.proxy(function(t){this.$container.find(this.settings.fileInputSelector).trigger(\"click\")},this)),this.$container.find(this.settings.deleteButtonSelector).on(\"click\",$.proxy(function(t){confirm(Craft.t(\"app\",\"Are you sure you want to delete this image?\"))&&($(t.currentTarget).parent().append('<div class=\"blocking-modal\"></div>'),Craft.postActionRequest(this.settings.deleteAction,this.settings.postParameters,$.proxy(function(t,e){\"success\"===e&&this.refreshImage(t)},this)))},this))},refreshImage:function(t){$(this.settings.containerSelector).replaceWith(t.html),this.settings.onAfterRefreshImage(t),this.initImageUpload()},_onUploadStart:function(t){this.progressBar.$progressBar.css({top:Math.round(this.$container.outerHeight()/2)-6}),this.$container.addClass(\"uploading\"),this.progressBar.resetProgressBar(),this.progressBar.showProgressBar()},_onUploadProgress:function(t,e){var i=parseInt(e.loaded/e.total*100,10);this.progressBar.setProgressPercentage(i)},_onUploadComplete:function(t,e){if(e.result.error)alert(e.result.error);else{$(e.result.html);this.refreshImage(e.result)}this.uploader.isLastUpload()&&(this.progressBar.hideProgressBar(),this.$container.removeClass(\"uploading\"))},_onUploadError:function(t,e){e.jqXHR.responseJSON.error&&(alert(e.jqXHR.responseJSON.error),this.$container.removeClass(\"uploading\"),this.progressBar.hideProgressBar(),this.progressBar.resetProgressBar())}},{defaults:{postParameters:{},uploadAction:\"\",deleteAction:\"\",fileInputSelector:\"\",onAfterRefreshImage:$.noop,containerSelector:null,uploadButtonSelector:null,deleteButtonSelector:null,uploadParamName:\"files\"}}),Craft.InfoIcon=Garnish.Base.extend({$icon:null,hud:null,init:function(t){this.$icon=$(t),this.addListener(this.$icon,\"click\",\"showHud\")},showHud:function(){this.hud?this.hud.show():this.hud=new Garnish.HUD(this.$icon,this.$icon.html(),{hudClass:\"hud info-hud\",closeOtherHUDs:!1})}}),Craft.LightSwitch=Garnish.Base.extend({settings:null,$outerContainer:null,$innerContainer:null,$input:null,small:!1,on:null,dragger:null,dragStartMargin:null,init:function(t,e){this.$outerContainer=$(t),this.$outerContainer.data(\"lightswitch\")&&(Garnish.log(\"Double-instantiating a lightswitch on an element\"),this.$outerContainer.data(\"lightswitch\").destroy()),this.$outerContainer.data(\"lightswitch\",this),this.small=this.$outerContainer.hasClass(\"small\"),this.setSettings(e,Craft.LightSwitch.defaults),this.$innerContainer=this.$outerContainer.find(\".lightswitch-container:first\"),this.$input=this.$outerContainer.find(\"input:first\"),this.$input.prop(\"disabled\")||(this.on=this.$outerContainer.hasClass(\"on\"),this.$outerContainer.attr({role:\"checkbox\",\"aria-checked\":this.on?\"true\":\"false\"}),this.addListener(this.$outerContainer,\"mousedown\",\"_onMouseDown\"),this.addListener(this.$outerContainer,\"keydown\",\"_onKeyDown\"),this.dragger=new Garnish.BaseDrag(this.$outerContainer,{axis:Garnish.X_AXIS,ignoreHandleSelector:null,onDragStart:$.proxy(this,\"_onDragStart\"),onDrag:$.proxy(this,\"_onDrag\"),onDragStop:$.proxy(this,\"_onDragStop\")}))},turnOn:function(){this.$outerContainer.addClass(\"dragging\");var t={};t[\"margin-\"+Craft.left]=0,this.$innerContainer.velocity(\"stop\").velocity(t,Craft.LightSwitch.animationDuration,$.proxy(this,\"_onSettle\")),this.$input.val(this.settings.value),this.$outerContainer.addClass(\"on\"),this.$outerContainer.attr(\"aria-checked\",\"true\"),this.on!==(this.on=!0)&&this.onChange()},turnOff:function(){this.$outerContainer.addClass(\"dragging\");var t={};t[\"margin-\"+Craft.left]=this._getOffMargin(),this.$innerContainer.velocity(\"stop\").velocity(t,Craft.LightSwitch.animationDuration,$.proxy(this,\"_onSettle\")),this.$input.val(\"\"),this.$outerContainer.removeClass(\"on\"),this.$outerContainer.attr(\"aria-checked\",\"false\"),this.on!==(this.on=!1)&&this.onChange()},toggle:function(t){this.on?this.turnOff():this.turnOn()},onChange:function(){this.trigger(\"change\"),this.settings.onChange(),this.$outerContainer.trigger(\"change\")},_onMouseDown:function(){this.addListener(Garnish.$doc,\"mouseup\",\"_onMouseUp\")},_onMouseUp:function(){this.removeListener(Garnish.$doc,\"mouseup\"),this.dragger.dragging||this.toggle()},_onKeyDown:function(t){switch(t.keyCode){case Garnish.SPACE_KEY:this.toggle(),t.preventDefault();break;case Garnish.RIGHT_KEY:\"ltr\"===Craft.orientation?this.turnOn():this.turnOff(),t.preventDefault();break;case Garnish.LEFT_KEY:\"ltr\"===Craft.orientation?this.turnOff():this.turnOn(),t.preventDefault()}},_getMargin:function(){return parseInt(this.$innerContainer.css(\"margin-\"+Craft.left))},_onDragStart:function(){this.$outerContainer.addClass(\"dragging\"),this.dragStartMargin=this._getMargin()},_onDrag:function(){var t;(t=\"ltr\"===Craft.orientation?this.dragStartMargin+this.dragger.mouseDistX:this.dragStartMargin-this.dragger.mouseDistX)<this._getOffMargin()?t=this._getOffMargin():0<t&&(t=0),this.$innerContainer.css(\"margin-\"+Craft.left,t)},_onDragStop:function(){this._getMargin()>this._getOffMargin()/2?this.turnOn():this.turnOff()},_onSettle:function(){this.$outerContainer.removeClass(\"dragging\")},destroy:function(){this.base(),this.dragger.destroy()},_getOffMargin:function(){return this.small?-9:-11}},{animationDuration:100,defaults:{value:\"1\",onChange:$.noop}}),Craft.LivePreview=Garnish.Base.extend({$extraFields:null,$trigger:null,$shade:null,$editorContainer:null,$editor:null,$dragHandle:null,$iframeContainer:null,$iframe:null,$fieldPlaceholder:null,previewUrl:null,token:null,basePostData:null,inPreviewMode:!1,fields:null,lastPostData:null,updateIframeInterval:null,loading:!1,checkAgain:!1,dragger:null,dragStartEditorWidth:null,_slideInOnIframeLoad:!1,_handleSuccessProxy:null,_handleErrorProxy:null,_forceUpdateIframeProxy:null,_scrollX:null,_scrollY:null,_editorWidth:null,_editorWidthInPx:null,init:function(t){this.setSettings(t,Craft.LivePreview.defaults),this.settings.previewUrl?this.previewUrl=this.settings.previewUrl:this.previewUrl=Craft.baseSiteUrl.replace(/\\/+$/,\"\")+\"/\",\"https:\"===document.location.protocol&&(this.previewUrl=this.previewUrl.replace(/^http:/,\"https:\")),this.basePostData=$.extend({},this.settings.previewParams),this._handleSuccessProxy=$.proxy(this,\"handleSuccess\"),this._handleErrorProxy=$.proxy(this,\"handleError\"),this._forceUpdateIframeProxy=$.proxy(this,\"forceUpdateIframe\"),this.$extraFields=$(this.settings.extraFields),this.$trigger=$(this.settings.trigger),this.$fieldPlaceholder=$(\"<div/>\"),this.editorWidth=Craft.getLocalStorage(\"LivePreview.editorWidth\",Craft.LivePreview.defaultEditorWidth),this.addListener(this.$trigger,\"activate\",\"toggle\"),Craft.cp.on(\"beforeSaveShortcut\",$.proxy(function(){this.inPreviewMode&&this.moveFieldsBack()},this))},get editorWidth(){return this._editorWidth},get editorWidthInPx(){return this._editorWidthInPx},set editorWidth(t){var e;1<=t?(e=t,t/=Garnish.$win.width()):e=Math.round(t*Garnish.$win.width()),e<Craft.LivePreview.minEditorWidthInPx&&(t=(e=Craft.LivePreview.minEditorWidthInPx)/Garnish.$win.width()),this._editorWidth=t,this._editorWidthInPx=e},toggle:function(){this.inPreviewMode?this.exit():this.enter()},enter:function(){if(!this.inPreviewMode)if(this.token){if(this.trigger(\"beforeEnter\"),$(document.activeElement).trigger(\"blur\"),!this.$editor){this.$shade=$(\"<div/>\",{class:\"modal-shade dark\"}).appendTo(Garnish.$bod),this.$editorContainer=$(\"<div/>\",{class:\"lp-editor-container\"}).appendTo(Garnish.$bod),this.$iframeContainer=$(\"<div/>\",{class:\"lp-preview-container\"}).appendTo(Garnish.$bod);var t=$(\"<header/>\",{class:\"flex\"}).appendTo(this.$editorContainer);this.$editor=$(\"<form/>\",{class:\"lp-editor\"}).appendTo(this.$editorContainer),this.$dragHandle=$(\"<div/>\",{class:\"lp-draghandle\"}).appendTo(this.$editorContainer);var e=$(\"<div/>\",{class:\"btn\",text:Craft.t(\"app\",\"Close Preview\")}).appendTo(t);$(\"<div/>\",{class:\"flex-grow\"}).appendTo(t);var i=$('<div class=\"btn submit\">'+Craft.t(\"app\",\"Save\")+\"</div>\").appendTo(t);this.dragger=new Garnish.BaseDrag(this.$dragHandle,{axis:Garnish.X_AXIS,onDragStart:$.proxy(this,\"_onDragStart\"),onDrag:$.proxy(this,\"_onDrag\"),onDragStop:$.proxy(this,\"_onDragStop\")}),this.addListener(e,\"click\",\"exit\"),this.addListener(i,\"click\",\"save\")}this.handleWindowResize(),this.addListener(Garnish.$win,\"resize\",\"handleWindowResize\"),this.$editorContainer.css(Craft.left,-(this.editorWidthInPx+Craft.LivePreview.dragHandleWidth)+\"px\"),this.$iframeContainer.css(Craft.right,-this.getIframeWidth()),this.fields=[];for(var s=$(this.settings.fields),n=0;n<s.length;n++){var a=$(s[n]),r=this._getClone(a);this.$fieldPlaceholder.insertAfter(a),a.detach(),this.$fieldPlaceholder.replaceWith(r),a.appendTo(this.$editor),this.fields.push({$field:a,$clone:r})}this.updateIframe()?this._slideInOnIframeLoad=!0:this.slideIn(),Garnish.on(Craft.BaseElementEditor,\"saveElement\",this._forceUpdateIframeProxy),Garnish.on(Craft.AssetImageEditor,\"save\",this._forceUpdateIframeProxy),this.inPreviewMode=!0,this.trigger(\"enter\")}else this.createToken()},createToken:function(){Craft.postActionRequest(\"live-preview/create-token\",{previewAction:this.settings.previewAction},$.proxy(function(t,e){\"success\"===e&&(this.token=t.token,this.enter())},this))},save:function(){Craft.cp.submitPrimaryForm()},handleWindowResize:function(){this.editorWidth=this.editorWidth,this.updateWidths()},slideIn:function(){$(\"html\").addClass(\"noscroll\"),this.$shade.velocity(\"fadeIn\"),this.$editorContainer.show().velocity(\"stop\").animateLeft(0,\"slow\",$.proxy(function(){this.trigger(\"slideIn\"),Garnish.$win.trigger(\"resize\")},this)),this.$iframeContainer.show().velocity(\"stop\").animateRight(0,\"slow\",$.proxy(function(){this.updateIframeInterval=setInterval($.proxy(this,\"updateIframe\"),1e3),this.addListener(Garnish.$bod,\"keyup\",function(t){t.keyCode===Garnish.ESC_KEY&&this.exit()})},this))},exit:function(){this.inPreviewMode&&(this.trigger(\"beforeExit\"),$(\"html\").removeClass(\"noscroll\"),this.removeListener(Garnish.$win,\"resize\"),this.removeListener(Garnish.$bod,\"keyup\"),this.updateIframeInterval&&clearInterval(this.updateIframeInterval),this.moveFieldsBack(),this.$shade.delay(200).velocity(\"fadeOut\"),this.$editorContainer.velocity(\"stop\").animateLeft(-(this.editorWidthInPx+Craft.LivePreview.dragHandleWidth),\"slow\",$.proxy(function(){for(var t=0;t<this.fields.length;t++)this.fields[t].$newClone.remove();this.$editorContainer.hide(),this.trigger(\"slideOut\")},this)),this.$iframeContainer.velocity(\"stop\").animateRight(-this.getIframeWidth(),\"slow\",$.proxy(function(){this.$iframeContainer.hide()},this)),Garnish.off(Craft.BaseElementEditor,\"saveElement\",this._forceUpdateIframeProxy),this.inPreviewMode=!1,this.trigger(\"exit\"))},moveFieldsBack:function(){for(var t=0;t<this.fields.length;t++){var e=this.fields[t];e.$newClone=this._getClone(e.$field),this.$fieldPlaceholder.insertAfter(e.$field),e.$field.detach(),this.$fieldPlaceholder.replaceWith(e.$newClone),e.$clone.replaceWith(e.$field)}Garnish.$win.trigger(\"resize\")},getIframeWidth:function(){return Garnish.$win.width()-(this.editorWidthInPx+Craft.LivePreview.dragHandleWidth)},updateWidths:function(){this.$editorContainer.css(\"width\",this.editorWidthInPx+\"px\"),this.$iframeContainer.width(this.getIframeWidth())},updateIframe:function(t){if(t&&(this.lastPostData=null),!this.inPreviewMode)return!1;if(this.loading)return!(this.checkAgain=!0);var e=$.extend(Garnish.getPostData(this.$editor),Garnish.getPostData(this.$extraFields));if(this.lastPostData&&Craft.compare(e,this.lastPostData,!1))return!1;this.lastPostData=e,this.loading=!0;var i=this.$iframe?$(this.$iframe[0].contentWindow.document):null;return this._scrollX=i?i.scrollLeft():0,this._scrollY=i?i.scrollTop():0,$.ajax({url:this.previewUrl+(-1!==this.previewUrl.indexOf(\"?\")?\"&\":\"?\")+Craft.tokenParam+\"=\"+this.token,method:\"POST\",data:$.extend({},e,this.basePostData),headers:{\"X-Craft-Token\":this.token},xhrFields:{withCredentials:!0},crossDomain:!0,success:this._handleSuccessProxy,error:this._handleErrorProxy}),!0},forceUpdateIframe:function(){return this.updateIframe(!0)},handleSuccess:function(t){var e=t+'<script type=\"text/javascript\">window.scrollTo('+this._scrollX+\", \"+this._scrollY+\");<\\/script>\",i=$('<iframe class=\"lp-preview\" frameborder=\"0\"/>');this.$iframe?i.insertBefore(this.$iframe):i.appendTo(this.$iframeContainer),this.addListener(i,\"load\",function(){this.$iframe&&this.$iframe.remove(),this.$iframe=i,this._slideInOnIframeLoad&&(this.slideIn(),this._slideInOnIframeLoad=!1),this.removeListener(i,\"load\")}),Garnish.requestAnimationFrame($.proxy(function(){i[0].contentWindow.document.open(),i[0].contentWindow.document.write(e),i[0].contentWindow.document.close(),this.onResponse()},this))},handleError:function(){this.onResponse()},onResponse:function(){this.loading=!1,this.checkAgain&&(this.checkAgain=!1,this.updateIframe())},_getClone:function(t){var e=t.clone();return Garnish.copyInputValues(t,e),e.attr(\"id\",\"\"),e.find(\"[id]\").attr(\"id\",\"\"),e},_onDragStart:function(){this.dragStartEditorWidth=this.editorWidthInPx,this.$iframeContainer.addClass(\"dragging\")},_onDrag:function(){\"ltr\"===Craft.orientation?this.editorWidth=this.dragStartEditorWidth+this.dragger.mouseDistX:this.editorWidth=this.dragStartEditorWidth-this.dragger.mouseDistX,this.updateWidths()},_onDragStop:function(){this.$iframeContainer.removeClass(\"dragging\"),Craft.setLocalStorage(\"LivePreview.editorWidth\",this.editorWidth)}},{defaultEditorWidth:.33,minEditorWidthInPx:320,dragHandleWidth:4,defaults:{trigger:\".livepreviewbtn\",fields:null,extraFields:null,previewUrl:null,previewAction:null,previewParams:{}}}),Craft.LivePreview.init=function(t){Craft.livePreview=new Craft.LivePreview(t)},Craft.PasswordInput=Garnish.Base.extend({$passwordInput:null,$textInput:null,$currentInput:null,$showPasswordToggle:null,showingPassword:null,init:function(t,e){this.$passwordInput=$(t),this.settings=$.extend({},Craft.PasswordInput.defaults,e),this.$passwordInput.data(\"passwordInput\")&&(Garnish.log(\"Double-instantiating a password input on an element\"),this.$passwordInput.data(\"passwordInput\").destroy()),this.$passwordInput.data(\"passwordInput\",this),this.$showPasswordToggle=$(\"<a/>\").hide(),this.$showPasswordToggle.addClass(\"password-toggle\"),this.$showPasswordToggle.insertAfter(this.$passwordInput),this.addListener(this.$showPasswordToggle,\"mousedown\",\"onToggleMouseDown\"),this.hidePassword()},setCurrentInput:function(t){this.$currentInput&&(t.addClass(\"focus\"),t.insertAfter(this.$currentInput),this.$currentInput.detach(),t.trigger(\"focus\"),t.removeClass(\"focus\"),t.val(this.$currentInput.val())),this.$currentInput=t,this.addListener(this.$currentInput,\"keypress,keyup,change,blur\",\"onInputChange\")},updateToggleLabel:function(t){this.$showPasswordToggle.text(t)},showPassword:function(){this.showingPassword||(this.$textInput||(this.$textInput=this.$passwordInput.clone(!0),this.$textInput.attr(\"type\",\"text\")),this.setCurrentInput(this.$textInput),this.updateToggleLabel(Craft.t(\"app\",\"Hide\")),this.showingPassword=!0)},hidePassword:function(){!1!==this.showingPassword&&(this.setCurrentInput(this.$passwordInput),this.updateToggleLabel(Craft.t(\"app\",\"Show\")),this.showingPassword=!1,this.addListener(this.$passwordInput,\"keydown\",\"onKeyDown\"))},togglePassword:function(){this.showingPassword?this.hidePassword():this.showPassword(),this.settings.onToggleInput(this.$currentInput)},onKeyDown:function(t){t.keyCode===Garnish.ALT_KEY&&this.$currentInput.val()&&(this.showPassword(),this.$showPasswordToggle.hide(),this.addListener(this.$textInput,\"keyup\",\"onKeyUp\"))},onKeyUp:function(t){t.preventDefault(),t.keyCode===Garnish.ALT_KEY&&(this.hidePassword(),this.$showPasswordToggle.show())},onInputChange:function(){this.$currentInput.val()?this.$showPasswordToggle.show():this.$showPasswordToggle.hide()},onToggleMouseDown:function(t){if(t.preventDefault(),this.$currentInput[0].setSelectionRange){var e=this.$currentInput[0].selectionStart,i=this.$currentInput[0].selectionEnd;this.togglePassword(),this.$currentInput[0].setSelectionRange(e,i)}else this.togglePassword()}},{defaults:{onToggleInput:$.noop}}),Craft.Preview=Garnish.Base.extend({draftEditor:null,$shade:null,$editorContainer:null,$editor:null,$spinner:null,$statusIcon:null,$dragHandle:null,$previewContainer:null,$targetBtn:null,$targetMenu:null,$iframe:null,$tempInput:null,$fieldPlaceholder:null,isActive:!1,activeTarget:0,url:null,fields:null,scrollLeft:0,scrollTop:0,dragger:null,dragStartEditorWidth:null,_slideInOnIframeLoad:!1,_updateIframeProxy:null,_editorWidth:null,_editorWidthInPx:null,init:function(t){this.draftEditor=t,this._updateIframeProxy=$.proxy(this,\"updateIframe\"),this.$tempInput=$(\"<input/>\",{type:\"hidden\",name:\"__PREVIEW_FIELDS__\",value:\"1\"}),this.$fieldPlaceholder=$(\"<div/>\"),this.editorWidth=Craft.getLocalStorage(\"LivePreview.editorWidth\",Craft.Preview.defaultEditorWidth)},get editorWidth(){return this._editorWidth},get editorWidthInPx(){return this._editorWidthInPx},set editorWidth(t){var e;1<=t?(e=t,t/=Garnish.$win.width()):e=Math.round(t*Garnish.$win.width()),e<Craft.Preview.minEditorWidthInPx&&(t=(e=Craft.Preview.minEditorWidthInPx)/Garnish.$win.width()),this._editorWidth=t,this._editorWidthInPx=e},open:function(){if(!this.isActive){if(this.isActive=!0,this.trigger(\"beforeOpen\"),$(document.activeElement).trigger(\"blur\"),!this.$editor){this.$shade=$(\"<div/>\",{class:\"modal-shade dark\"}).appendTo(Garnish.$bod),this.$editorContainer=$(\"<div/>\",{class:\"lp-editor-container\"}).appendTo(Garnish.$bod),this.$previewContainer=$(\"<div/>\",{class:\"lp-preview-container\"}).appendTo(Garnish.$bod);var t=$(\"<header/>\",{class:\"flex\"}).appendTo(this.$editorContainer);this.$editor=$(\"<form/>\",{class:\"lp-editor\"}).appendTo(this.$editorContainer),this.$dragHandle=$(\"<div/>\",{class:\"lp-draghandle\"}).appendTo(this.$editorContainer);var e=$(\"<div/>\",{class:\"btn\",text:Craft.t(\"app\",\"Close Preview\")}).appendTo(t);if($(\"<div/>\",{class:\"flex-grow\"}).appendTo(t),this.$spinner=$(\"<div/>\",{class:\"spinner hidden\",title:Craft.t(\"app\",\"Saving\")}).appendTo(t),this.$statusIcon=$(\"<div/>\",{class:\"invisible\"}).appendTo(t),1<this.draftEditor.settings.previewTargets.length){var i=$(\"<header/>\",{class:\"flex\"}).appendTo(this.$previewContainer);this.$targetBtn=$(\"<div/>\",{class:\"btn menubtn\",text:this.draftEditor.settings.previewTargets[0].label,role:\"btn\"}).appendTo(i),this.$targetMenu=$(\"<div/>\",{class:\"menu lp-target-menu\"}).insertAfter(this.$targetBtn);for(var s,n=$(\"<ul/>\",{class:\"padded\"}).appendTo(this.$targetMenu),a=0;a<this.draftEditor.settings.previewTargets.length;a++)s=$(\"<li/>\").appendTo(n),$(\"<a/>\",{data:{target:a},text:this.draftEditor.settings.previewTargets[a].label,class:0===a?\"sel\":null}).appendTo(s);new Garnish.MenuBtn(this.$targetBtn,{onOptionSelect:$.proxy(function(t){this.switchTarget($(t).data(\"target\"))},this)})}this.dragger=new Garnish.BaseDrag(this.$dragHandle,{axis:Garnish.X_AXIS,onDragStart:$.proxy(this,\"_onDragStart\"),onDrag:$.proxy(this,\"_onDrag\"),onDragStop:$.proxy(this,\"_onDragStop\")}),this.addListener(e,\"click\",\"close\"),this.addListener(this.$statusIcon,\"click\",function(){this.draftEditor.showStatusHud(this.$statusIcon)}.bind(this))}this.handleWindowResize(),this.addListener(Garnish.$win,\"resize\",\"handleWindowResize\"),this.$editorContainer.css(Craft.left,-(this.editorWidthInPx+Craft.Preview.dragHandleWidth)+\"px\"),this.$previewContainer.css(Craft.right,-this.getIframeWidth()),this.fields=[];var r=$(\"#content .field\").not($(\"#content .field .field\"));if(r.length){this.$tempInput.insertBefore(r.get(0));for(a=0;a<r.length;a++){var o=$(r[a]),l=this._getClone(o);this.$fieldPlaceholder.insertAfter(o),o.detach(),this.$fieldPlaceholder.replaceWith(l),o.appendTo(this.$editor),this.fields.push({$field:o,$clone:l})}}this._slideInOnIframeLoad=!0,this.updateIframe(),this.draftEditor.on(\"update\",this._updateIframeProxy),Garnish.on(Craft.BaseElementEditor,\"saveElement\",this._updateIframeProxy),Garnish.on(Craft.AssetImageEditor,\"save\",this._updateIframeProxy),this.trigger(\"open\")}},switchTarget:function(t){this.activeTarget=t,this.$targetBtn.text(this.draftEditor.settings.previewTargets[t].label),this.$targetMenu.find(\"a.sel\").removeClass(\"sel\"),this.$targetMenu.find(\"a\").eq(t).addClass(\"sel\"),this.updateIframe(!0)},handleWindowResize:function(){this.editorWidth=this.editorWidth,this.updateWidths()},slideIn:function(){$(\"html\").addClass(\"noscroll\"),this.$shade.velocity(\"fadeIn\"),this.$editorContainer.show().velocity(\"stop\").animateLeft(0,\"slow\",$.proxy(function(){this.trigger(\"slideIn\"),Garnish.$win.trigger(\"resize\")},this)),this.$previewContainer.show().velocity(\"stop\").animateRight(0,\"slow\",$.proxy(function(){this.addListener(Garnish.$bod,\"keyup\",function(t){t.keyCode===Garnish.ESC_KEY&&this.close()})},this))},close:function(){this.isActive&&(this.trigger(\"beforeClose\"),$(\"html\").removeClass(\"noscroll\"),this.removeListener(Garnish.$win,\"resize\"),this.removeListener(Garnish.$bod,\"keyup\"),this.$tempInput.detach(),this.moveFieldsBack(),this.$shade.delay(200).velocity(\"fadeOut\"),this.$editorContainer.velocity(\"stop\").animateLeft(-(this.editorWidthInPx+Craft.Preview.dragHandleWidth),\"slow\",$.proxy(function(){for(var t=0;t<this.fields.length;t++)this.fields[t].$newClone.remove();this.$editorContainer.hide(),this.trigger(\"slideOut\")},this)),this.$previewContainer.velocity(\"stop\").animateRight(-this.getIframeWidth(),\"slow\",$.proxy(function(){this.$previewContainer.hide()},this)),this.draftEditor.off(\"update\",this._updateIframeProxy),Garnish.off(Craft.BaseElementEditor,\"saveElement\",this._updateIframeProxy),Garnish.off(Craft.AssetImageEditor,\"save\",this._updateIframeProxy),this.isActive=!1,this.trigger(\"close\"))},moveFieldsBack:function(){for(var t=0;t<this.fields.length;t++){var e=this.fields[t];e.$newClone=this._getClone(e.$field),this.$fieldPlaceholder.insertAfter(e.$field),e.$field.detach(),this.$fieldPlaceholder.replaceWith(e.$newClone),e.$clone.replaceWith(e.$field)}Garnish.$win.trigger(\"resize\")},getIframeWidth:function(){return Garnish.$win.width()-(this.editorWidthInPx+Craft.Preview.dragHandleWidth)},updateWidths:function(){this.$editorContainer.css(\"width\",this.editorWidthInPx+\"px\"),this.$previewContainer.width(this.getIframeWidth())},updateIframe:function(n){if(!this.isActive)return!1;n=!0===n;var t=this.draftEditor.settings.previewTargets[this.activeTarget].url;this.draftEditor.getTokenizedPreviewUrl(t,\"x-craft-live-preview\").then(function(t){var e;if(n)this.scrollLeft=0,this.scrolllTop=0;else if((e=Craft.isSameHost(t))&&this.$iframe&&this.$iframe[0].contentWindow){var i=$(this.$iframe[0].contentWindow.document);this.scrollLeft=i.scrollLeft(),this.scrollTop=i.scrollTop()}var s=$(\"<iframe/>\",{class:\"lp-preview\",frameborder:0,src:t});!n&&e&&s.on(\"load\",function(){var t=$(s[0].contentWindow.document);t.scrollLeft(this.scrollLeft),t.scrollTop(this.scrollTop)}.bind(this)),this.$iframe?this.$iframe.replaceWith(s):s.appendTo(this.$previewContainer),this.url=t,this.$iframe=s,this.afterUpdateIframe()}.bind(this))},afterUpdateIframe:function(){this.trigger(\"afterUpdateIframe\"),this._slideInOnIframeLoad&&(this.slideIn(),this._slideInOnIframeLoad=!1)},_getClone:function(t){var e=t.clone();return Garnish.copyInputValues(t,e),e.attr(\"id\",\"\"),e.find(\"[id]\").attr(\"id\",\"\"),e.find(\"[name]\").prop(\"disabled\",!0),e},_onDragStart:function(){this.dragStartEditorWidth=this.editorWidthInPx,this.$previewContainer.addClass(\"dragging\")},_onDrag:function(){\"ltr\"===Craft.orientation?this.editorWidth=this.dragStartEditorWidth+this.dragger.mouseDistX:this.editorWidth=this.dragStartEditorWidth-this.dragger.mouseDistX,this.updateWidths()},_onDragStop:function(){this.$previewContainer.removeClass(\"dragging\"),Craft.setLocalStorage(\"LivePreview.editorWidth\",this.editorWidth)}},{defaultEditorWidth:.33,minEditorWidthInPx:320,dragHandleWidth:2}),Craft.PreviewFileModal=Garnish.Modal.extend({assetId:null,$spinner:null,elementSelect:null,type:null,loaded:null,requestId:0,init:function(t,e,i){if((i=$.extend(this.defaultSettings,i)).onHide=this._onHide.bind(this),Craft.PreviewFileModal.openInstance){var s=Craft.PreviewFileModal.openInstance;return s.assetId!==t&&(s.loadAsset(t,i.startingWidth,i.startingHeight),s.elementSelect=e),this.destroy()}(Craft.PreviewFileModal.openInstance=this).elementSelect=e,this.$container=$('<div id=\"previewmodal\" class=\"modal loading\"/>').appendTo(Garnish.$bod),this.base(this.$container,$.extend({resizable:!0},i)),this.$container&&(this.$container.velocity(\"stop\"),this.$container.show().css(\"opacity\",1),this.$shade.velocity(\"stop\"),this.$shade.show().css(\"opacity\",1)),this.loadAsset(t,i.startingWidth,i.startingHeight)},_onHide:function(){return Craft.PreviewFileModal.openInstance=null,this.elementSelect.focusItem(this.elementSelect.$focusedItem),this.$shade.remove(),this.destroy()},selfDestruct:function(){var t=Craft.PreviewFileModal.openInstance;return t.hide(),t.$shade.remove(),t.destroy(),!(Craft.PreviewFileModal.openInstance=null)},loadAsset:function(t,e,i){this.assetId=t,this.$container.empty(),this.loaded=!1,this.desiredHeight=null,this.desiredWidth=null;var n=.66*Garnish.$win.height(),a=Math.min(n/3*4,Garnish.$win.width()-2*this.settings.minGutter);if(n=a/4*3,e&&i){var s=e/i;a=Math.min(e,Garnish.$win.width()-2*this.settings.minGutter),n=Math.min(a/s,Garnish.$win.height()-2*this.settings.minGutter),(a=n*s)>Math.min(e,Garnish.$win.width()-2*this.settings.minGutter)&&(a=Math.min(e,Garnish.$win.width()-2*this.settings.minGutter),n=a/s)}this._resizeContainer(a,n),this.$spinner=$('<div class=\"spinner centeralign\"></div>').appendTo(this.$container);var r=this.$container.height()/2-this.$spinner.height()/2+\"px\",o=this.$container.width()/2-this.$spinner.width()/2+\"px\";this.$spinner.css({left:o,top:r,position:\"absolute\"}),this.requestId++,Craft.postActionRequest(\"assets/preview-file\",{assetId:t,requestId:this.requestId},function(t,e){if(\"success\"===e)if(t.success){if(t.requestId!=this.requestId)return;this.$container.removeClass(\"loading\"),this.$spinner.remove(),this.loaded=!0,this.$container.append(t.modalHtml);var i=this.$container.find(\".highlight\");if(i.length&&i.hasClass(\"json\")){var s=i.find(\"code\");s.html(JSON.stringify(JSON.parse(s.html()),void 0,4))}i.length?Prism.highlightElement(i.find(\"code\").get(0)):this.$container.find(\"img\").css({width:a,height:n}),this.updateSizeAndPosition()}else alert(t.error),this.hide()}.bind(this))},updateSizeAndPosition:function(){if(this.loaded){var t=this.$container.find(\"img\");if(this.loaded&&t.length){var e=t.data(\"maxwidth\"),i=t.data(\"maxheight\"),s=e/i,n=this.desiredWidth?this.desiredWidth:this.$container.width(),a=(this.desiredHeight?this.desiredHeight:this.$container.height(),Math.min(n,e)),r=Math.round(Math.min(i,a/s));a=Math.round(r*s),t.css({width:a,height:r}),this._resizeContainer(a,r),this.desiredWidth=a,this.desiredHeight=r}if(this.base(),this.loaded&&t.length){var o=Math.round(Math.min(Math.max(t.height()*s),Garnish.$win.width()-2*this.settings.minGutter)),l=Math.round(Math.min(Math.max(o/s),Garnish.$win.height()-2*this.settings.minGutter));(o=Math.round(l*s))>Math.min(o,Garnish.$win.width()-2*this.settings.minGutter)&&(l=(o=Math.min(o,Garnish.$win.width()-2*this.settings.minGutter))/s),this._resizeContainer(o,l),t.css({width:o,height:l})}else this.loaded&&this.$container.find(\".highlight\").height(this.$container.height()).width(this.$container.width()).css({overflow:\"auto\"})}},_resizeContainer:function(t,e){this.$container.css({width:t,\"min-width\":t,\"max-width\":t,height:e,\"min-height\":e,\"max-height\":e,top:(Garnish.$win.height()-e)/2,left:(Garnish.$win.width()-t)/2})}},{defaultSettings:{startingWidth:null,startingHeight:null}}),Craft.ProgressBar=Garnish.Base.extend({$progressBar:null,$innerProgressBar:null,$progressBarStatus:null,_itemCount:0,_processedItemCount:0,_displaySteps:!1,init:function(t,e){e&&(this._displaySteps=!0),this.$progressBar=$('<div class=\"progressbar pending hidden\"/>').appendTo(t),this.$innerProgressBar=$('<div class=\"progressbar-inner\"/>').appendTo(this.$progressBar),this.$progressBarStatus=$('<div class=\"progressbar-status hidden\" />').insertAfter(this.$progressBar),this.resetProgressBar()},resetProgressBar:function(){this.setProgressPercentage(100),this.$progressBar.addClass(\"pending\"),this.setItemCount(1),this.setProcessedItemCount(0),this.$progressBarStatus.html(\"\"),this._displaySteps&&this.$progressBar.addClass(\"has-status\")},hideProgressBar:function(){this.$progressBar.fadeTo(\"fast\",.01,$.proxy(function(){this.$progressBar.addClass(\"hidden\").fadeTo(1,1,$.noop)},this))},showProgressBar:function(){this.$progressBar.removeClass(\"hidden\"),this.$progressBarStatus.removeClass(\"hidden\")},setItemCount:function(t){this._itemCount=t},incrementItemCount:function(t){this._itemCount+=t},setProcessedItemCount:function(t){this._processedItemCount=t},incrementProcessedItemCount:function(t){this._processedItemCount+=t},updateProgressBar:function(){this._itemCount=Math.max(this._itemCount,1);var t=Math.min(100,Math.round(100*this._processedItemCount/this._itemCount));this.setProgressPercentage(t),this._displaySteps&&this.$progressBarStatus.html(this._processedItemCount+\" / \"+this._itemCount)},setProgressPercentage:function(t,e){0===t?this.$progressBar.addClass(\"pending\"):(this.$progressBar.removeClass(\"pending\"),e?this.$innerProgressBar.velocity(\"stop\").velocity({width:t+\"%\"},\"fast\"):this.$innerProgressBar.velocity(\"stop\").width(t+\"%\"))}}),Craft.PromptHandler=Garnish.Base.extend({modal:null,$modalContainerDiv:null,$prompt:null,$promptApplyToRemainingContainer:null,$promptApplyToRemainingCheckbox:null,$promptApplyToRemainingLabel:null,$pomptChoices:null,_prompts:[],_promptBatchCallback:$.noop,_promptBatchReturnData:[],_promptBatchNum:0,resetPrompts:function(){this._prompts=[],this._promptBatchCallback=$.noop,this._promptBatchReturnData=[],this._promptBatchNum=0},addPrompt:function(t){this._prompts.push(t)},getPromptCount:function(){return this._prompts.length},showBatchPrompts:function(t){this._promptBatchCallback=t,this._promptBatchReturnData=[],this._promptBatchNum=0,this._showNextPromptInBatch()},_showNextPromptInBatch:function(){var t=this._prompts[this._promptBatchNum].prompt,e=this._prompts.length-(this._promptBatchNum+1);this._showPrompt(t.message,t.choices,$.proxy(this,\"_handleBatchPromptSelection\"),e)},_handleBatchPromptSelection:function(t,e){var i=this._prompts[this._promptBatchNum],s=this._prompts.length-(this._promptBatchNum+1),n=$.extend(i,{choice:t});this._promptBatchReturnData.push(n),s?(this._promptBatchNum++,e?this._handleBatchPromptSelection(t,!0):this._showNextPromptInBatch()):\"function\"==typeof this._promptBatchCallback&&this._promptBatchCallback(this._promptBatchReturnData)},_showPrompt:function(t,e,i,s){this._promptCallback=i,null===this.modal&&(this.modal=new Garnish.Modal({closeOtherModals:!1})),null===this.$modalContainerDiv&&(this.$modalContainerDiv=$('<div class=\"modal fitted prompt-modal\"></div>').addClass().appendTo(Garnish.$bod)),this.$prompt=$('<div class=\"body\"></div>').appendTo(this.$modalContainerDiv.empty()),this.$promptMessage=$('<p class=\"prompt-msg\"/>').appendTo(this.$prompt),this.$promptChoices=$('<div class=\"options\"></div>').appendTo(this.$prompt),this.$promptApplyToRemainingContainer=$('<label class=\"assets-applytoremaining\"/>').appendTo(this.$prompt).hide(),this.$promptApplyToRemainingCheckbox=$('<input type=\"checkbox\"/>').appendTo(this.$promptApplyToRemainingContainer),this.$promptApplyToRemainingLabel=$(\"<span/>\").appendTo(this.$promptApplyToRemainingContainer),this.$promptButtons=$('<div class=\"buttons right\"/>').appendTo(this.$prompt),this.modal.setContainer(this.$modalContainerDiv),this.$promptMessage.html(t);for(var n=$('<div class=\"btn\">'+Craft.t(\"app\",\"Cancel\")+\"</div>\").appendTo(this.$promptButtons),a=$('<input type=\"submit\" class=\"btn submit disabled\" value=\"'+Craft.t(\"app\",\"OK\")+'\" />').appendTo(this.$promptButtons),r=0;r<e.length;r++){var o=$('<div><label><input type=\"radio\" name=\"promptAction\" value=\"'+e[r].value+'\"/> '+e[r].title+\"</label></div>\").appendTo(this.$promptChoices).find(\"input\");this.addListener(o,\"click\",function(){a.removeClass(\"disabled\")})}this.addListener(a,\"activate\",function(t){var e=$(t.currentTarget).parents(\".modal\").find(\"input[name=promptAction]:checked\").val(),i=this.$promptApplyToRemainingCheckbox.prop(\"checked\");this._selectPromptChoice(e,i)}),this.addListener(n,\"activate\",function(){var t=this.$promptApplyToRemainingCheckbox.prop(\"checked\");this._selectPromptChoice(\"cancel\",t)}),s&&(this.$promptApplyToRemainingContainer.show(),this.$promptApplyToRemainingLabel.html(\" \"+Craft.t(\"app\",\"Apply this to the {number} remaining conflicts?\",{number:s}))),this.modal.show(),this.modal.removeListener(Garnish.Modal.$shade,\"click\"),this.addListener(Garnish.Modal.$shade,\"click\",\"_cancelPrompt\")},_selectPromptChoice:function(t,e){this.$prompt.fadeOut(\"fast\",$.proxy(function(){this.modal.hide(),this._promptCallback(t,e)},this))},_cancelPrompt:function(){this._selectPromptChoice(\"cancel\",!0)}}),Craft.SlideRuleInput=Garnish.Base.extend({$container:null,$options:null,$selectedOption:null,$input:null,value:null,startPositionX:null,init:function(t,e){this.setSettings(e,Craft.SlideRuleInput.defaultSettings),this.value=0,this.graduationsMin=-70,this.graduationsMax=70,this.slideMin=-45,this.slideMax=45,this.$container=$(\"#\"+t),this.$overlay=$('<div class=\"overlay\"></div>').appendTo(this.$container),this.$cursor=$('<div class=\"cursor\"></div>').appendTo(this.$container),this.$graduations=$('<div class=\"graduations\"></div>').appendTo(this.$container),this.$graduationsUl=$(\"<ul></ul>\").appendTo(this.$graduations);for(var i=this.graduationsMin;i<=this.graduationsMax;i++){var s=$('<li class=\"graduation\" data-graduation=\"'+i+'\"><div class=\"label\">'+i+\"</div></li>\").appendTo(this.$graduationsUl);i%5==0&&s.addClass(\"main-graduation\"),0===i&&s.addClass(\"selected\")}this.$options=this.$container.find(\".graduation\"),this.addListener(this.$container,\"resize\",$.proxy(this,\"_handleResize\")),this.addListener(this.$container,\"tapstart\",$.proxy(this,\"_handleTapStart\")),this.addListener(Garnish.$bod,\"tapmove\",$.proxy(this,\"_handleTapMove\")),this.addListener(Garnish.$bod,\"tapend\",$.proxy(this,\"_handleTapEnd\")),setTimeout($.proxy(function(){this.graduationsCalculatedWidth=10*(this.$options.length-1),this.$graduationsUl.css(\"left\",-this.graduationsCalculatedWidth/2+this.$container.width()/2)},this),50)},_handleResize:function(){var t=this.valueToPosition(this.value);this.$graduationsUl.css(\"left\",t)},_handleTapStart:function(t,e){t.preventDefault(),this.startPositionX=e.position.x,this.startLeft=this.$graduationsUl.position().left,this.dragging=!0,this.onStart()},_handleTapMove:function(t,e){if(this.dragging){t.preventDefault();var i=this.startPositionX-e.position.x,s=this.startLeft-i,n=this.positionToValue(s);this.setValue(n),this.onChange()}},setValue:function(i){var t=this.valueToPosition(i);i<this.slideMin?(i=this.slideMin,t=this.valueToPosition(i)):i>this.slideMax&&(i=this.slideMax,t=this.valueToPosition(i)),this.$graduationsUl.css(\"left\",t),i>=this.slideMin&&i<=this.slideMax&&(this.$options.removeClass(\"selected\"),$.each(this.$options,function(t,e){0<$(e).data(\"graduation\")&&$(e).data(\"graduation\")<=i&&$(e).addClass(\"selected\"),$(e).data(\"graduation\")<0&&$(e).data(\"graduation\")>=i&&$(e).addClass(\"selected\"),0==$(e).data(\"graduation\")&&$(e).addClass(\"selected\")})),this.value=i},_handleTapEnd:function(t){this.dragging&&(t.preventDefault(),this.dragging=!1,this.onEnd())},positionToValue:function(t){var e=-1*this.graduationsMin,i=-1*(this.graduationsMin-this.graduationsMax);return(this.$graduations.width()/2+-1*t)/this.graduationsCalculatedWidth*i-e},valueToPosition:function(t){var e=-1*this.graduationsMin,i=-1*(this.graduationsMin-this.graduationsMax);return-((t+e)*this.graduationsCalculatedWidth/i-this.$graduations.width()/2)},onStart:function(){\"function\"==typeof this.settings.onChange&&this.settings.onStart(this)},onChange:function(){\"function\"==typeof this.settings.onChange&&this.settings.onChange(this)},onEnd:function(){\"function\"==typeof this.settings.onChange&&this.settings.onEnd(this)},defaultSettings:{onStart:$.noop,onChange:$.noop,onEnd:$.noop}}),Craft.SlugGenerator=Craft.BaseInputGenerator.extend({generateTargetValue:function(t){t=(t=t.replace(/<(.*?)>/g,\"\")).replace(/['\"\u2018\u2019\u201c\u201d\\[\\]\\(\\)\\{\\}:]/g,\"\"),Craft.allowUppercaseInSlug||(t=t.toLowerCase()),Craft.limitAutoSlugsToAscii&&(t=Craft.asciiString(t,this.settings.charMap));var e=Craft.filterArray(XRegExp.matchChain(t,[XRegExp(\"[\\\\p{L}\\\\p{N}\\\\p{M}]+\")]));return e.length?e.join(Craft.slugWordSeparator):\"\"}}),Craft.Structure=Garnish.Base.extend({id:null,$container:null,state:null,structureDrag:null,init:function(t,e,i){this.id=t,this.$container=$(e),this.setSettings(i,Craft.Structure.defaults),this.$container.data(\"structure\")&&(Garnish.log(\"Double-instantiating a structure on an element\"),this.$container.data(\"structure\").destroy()),this.$container.data(\"structure\",this),this.state={},this.settings.storageKey&&$.extend(this.state,Craft.getLocalStorage(this.settings.storageKey,{})),void 0===this.state.collapsedElementIds&&(this.state.collapsedElementIds=[]);for(var s=this.$container.find(\"ul\").prev(\".row\"),n=0;n<s.length;n++){var a=$(s[n]),r=a.parent(),o=$('<div class=\"toggle\" title=\"'+Craft.t(\"app\",\"Show/hide children\")+'\"/>').prependTo(a);-1!==$.inArray(a.children(\".element\").data(\"id\"),this.state.collapsedElementIds)&&r.addClass(\"collapsed\"),this.initToggle(o)}this.settings.sortable&&(this.structureDrag=new Craft.StructureDrag(this,this.settings.maxLevels)),this.settings.newChildUrl&&this.initNewChildMenus(this.$container.find(\".add\"))},initToggle:function(t){t.on(\"click\",$.proxy(function(t){var e=$(t.currentTarget).closest(\"li\"),i=e.children(\".row\").find(\".element:first\").data(\"id\"),s=$.inArray(i,this.state.collapsedElementIds);e.hasClass(\"collapsed\")?(e.removeClass(\"collapsed\"),-1!==s&&this.state.collapsedElementIds.splice(s,1)):(e.addClass(\"collapsed\"),-1===s&&this.state.collapsedElementIds.push(i)),this.settings.storageKey&&Craft.setLocalStorage(this.settings.storageKey,this.state)},this))},initNewChildMenus:function(t){this.addListener(t,\"click\",\"onNewChildMenuClick\")},onNewChildMenuClick:function(t){var e=$(t.currentTarget);if(!e.data(\"menubtn\")){var i=e.parent().children(\".element\").data(\"id\"),s=Craft.getUrl(this.settings.newChildUrl,\"parentId=\"+i);$('<div class=\"menu\"><ul><li><a href=\"'+s+'\">'+Craft.t(\"app\",\"New child\")+\"</a></li></ul></div>\").insertAfter(e),new Garnish.MenuBtn(e).showMenu()}},getIndent:function(t){return Craft.Structure.baseIndent+(t-1)*Craft.Structure.nestedIndent},addElement:function(t){var e=$('<li data-level=\"1\"/>').appendTo(this.$container),i=$('<div class=\"row\" style=\"margin-'+Craft.left+\": -\"+Craft.Structure.baseIndent+\"px; padding-\"+Craft.left+\": \"+Craft.Structure.baseIndent+'px;\">').appendTo(e);if(i.append(t),this.settings.sortable&&(i.append('<a class=\"move icon\" title=\"'+Craft.t(\"app\",\"Move\")+'\"></a>'),this.structureDrag.addItems(e)),this.settings.newChildUrl){var s=$('<a class=\"add icon\" title=\"'+Craft.t(\"app\",\"New child\")+'\"></a>').appendTo(i);this.initNewChildMenus(s)}i.css(\"margin-bottom\",-30),i.velocity({\"margin-bottom\":0},\"fast\")},removeElement:function(t){var e,i=t.parent().parent();this.settings.sortable&&this.structureDrag.removeItems(i),i.siblings().length||(e=i.parent()),i.css(\"visibility\",\"hidden\").velocity({marginBottom:-i.height()},\"fast\",$.proxy(function(){i.remove(),void 0!==e&&this._removeUl(e)},this))},_removeUl:function(t){t.siblings(\".row\").children(\".toggle\").remove(),t.remove()}},{baseIndent:8,nestedIndent:35,defaults:{storageKey:null,sortable:!1,newChildUrl:null,maxLevels:null}}),Craft.StructureDrag=Garnish.Drag.extend({structure:null,maxLevels:null,draggeeLevel:null,$helperLi:null,$targets:null,draggeeHeight:null,init:function(t,e){this.structure=t,this.maxLevels=e,this.$insertion=$('<li class=\"draginsertion\"/>');var i=this.structure.$container.find(\"li\");this.base(i,{handle:\".element:first, .move:first\",helper:$.proxy(this,\"getHelper\")})},getHelper:function(t){this.$helperLi=t;var e=$('<ul class=\"structure draghelper\"/>').append(t);return t.css(\"padding-\"+Craft.left,this.$draggee.css(\"padding-\"+Craft.left)),t.find(\".move\").removeAttr(\"title\"),e},onDragStart:function(){this.$targets=$(),this.findTargets(this.structure.$container),this.draggeeLevel=0;for(var t=this.$draggee;this.draggeeLevel++,(t=t.find(\"> ul > li\")).length;);this.draggeeHeight=this.$draggee.height(),this.$draggee.velocity({height:0},\"fast\",$.proxy(function(){this.$draggee.addClass(\"hidden\")},this)),this.base(),this.addListener(Garnish.$doc,\"keydown\",function(t){t.keyCode===Garnish.ESC_KEY&&this.cancelDrag()})},findTargets:function(t){for(var e=t.children().not(this.$draggee),i=0;i<e.length;i++){var s=$(e[i]);this.$targets=this.$targets.add(s.children(\".row\")),s.hasClass(\"collapsed\")||this.findTargets(s.children(\"ul\"))}},onDrag:function(){for(this._.$closestTarget&&(this._.$closestTarget.removeClass(\"draghover\"),this.$insertion.remove()),this._.$closestTarget=null,this._.closestTargetPos=null,this._.closestTargetYDiff=null,this._.closestTargetOffset=null,this._.closestTargetHeight=null,this._.i=0;this._.i<this.$targets.length&&(this._.$target=$(this.$targets[this._.i]),this._.targetOffset=this._.$target.offset(),this._.targetHeight=this._.$target.outerHeight(),this._.targetYMidpoint=this._.targetOffset.top+this._.targetHeight/2,this._.targetYDiff=Math.abs(this.mouseY-this._.targetYMidpoint),0===this._.i||this.mouseY>=this._.targetOffset.top+5&&this._.targetYDiff<this._.closestTargetYDiff);this._.i++)this._.$closestTarget=this._.$target,this._.closestTargetPos=this._.i,this._.closestTargetYDiff=this._.targetYDiff,this._.closestTargetOffset=this._.targetOffset,this._.closestTargetHeight=this._.targetHeight;if(this._.$closestTarget)if(0===this._.closestTargetPos&&this.mouseY<this._.closestTargetOffset.top+5)this.$insertion.prependTo(this.structure.$container);else if(this._.$closestTargetLi=this._.$closestTarget.parent(),this._.closestTargetLevel=this._.$closestTargetLi.data(\"level\"),this._.closestTargetPos<this.$targets.length-1?(this._.$nextTargetLi=$(this.$targets[this._.closestTargetPos+1]).parent(),this._.nextTargetLevel=this._.$nextTargetLi.data(\"level\")):(this._.$nextTargetLi=null,this._.nextTargetLevel=null),this._.hoveringBetweenRows=this.mouseY>=this._.closestTargetOffset.top+this._.closestTargetHeight-5,this._.$nextTargetLi&&this._.nextTargetLevel==this._.closestTargetLevel)this._.hoveringBetweenRows?(!this.maxLevels||this.maxLevels>=this._.closestTargetLevel+this.draggeeLevel-1)&&this.$insertion.insertAfter(this._.$closestTargetLi):(!this.maxLevels||this.maxLevels>=this._.closestTargetLevel+this.draggeeLevel)&&this._.$closestTarget.addClass(\"draghover\");else if(this._.$nextTargetLi&&this._.nextTargetLevel>this._.closestTargetLevel)(!this.maxLevels||this.maxLevels>=this._.nextTargetLevel+this.draggeeLevel-1)&&(this._.hoveringBetweenRows?this.$insertion.insertBefore(this._.$nextTargetLi):(this._.$closestTarget.addClass(\"draghover\"),this.$insertion.appendTo(this._.$closestTargetLi.children(\"ul\"))));else if(this._.hoveringBetweenRows){for(this._.draggeeX=this.mouseX-this.targetItemMouseDiffX,\"rtl\"===Craft.orientation&&(this._.draggeeX+=this.$helperLi.width()),this._.$parentLis=this._.$closestTarget.parentsUntil(this.structure.$container,\"li\"),this._.$closestParentLi=null,this._.closestParentLiXDiff=null,this._.closestParentLevel=null,this._.i=0;this._.i<this._.$parentLis.length;this._.i++)this._.$parentLi=$(this._.$parentLis[this._.i]),this._.parentLiX=this._.$parentLi.offset().left,\"rtl\"===Craft.orientation&&(this._.parentLiX+=this._.$parentLi.width()),this._.parentLiXDiff=Math.abs(this._.parentLiX-this._.draggeeX),this._.parentLevel=this._.$parentLi.data(\"level\"),(!this.maxLevels||this.maxLevels>=this._.parentLevel+this.draggeeLevel-1)&&(!this._.$closestParentLi||this._.parentLiXDiff<this._.closestParentLiXDiff&&(!this._.$nextTargetLi||this._.parentLevel>=this._.nextTargetLevel))&&(this._.$closestParentLi=this._.$parentLi,this._.closestParentLiXDiff=this._.parentLiXDiff,this._.closestParentLevel=this._.parentLevel);this._.$closestParentLi&&this.$insertion.insertAfter(this._.$closestParentLi)}else(!this.maxLevels||this.maxLevels>=this._.closestTargetLevel+this.draggeeLevel)&&this._.$closestTarget.addClass(\"draghover\")},cancelDrag:function(){this.$insertion.remove(),this._.$closestTarget&&this._.$closestTarget.removeClass(\"draghover\"),this.onMouseUp()},onDragStop:function(){if(this._.$closestTarget&&(this.$insertion.parent().length||this._.$closestTarget.hasClass(\"draghover\"))){var t,e;if(this.$draggee.siblings().length||(t=this.$draggee.parent()),this.$insertion.parent().length){var i=this.$insertion.next().add(this.$insertion.prev());e=-1===$.inArray(this.$draggee[0],i)?(this.$insertion.replaceWith(this.$draggee),!0):(this.$insertion.remove(),!1)}else{var s=this._.$closestTargetLi.children(\"ul\");if(t&&s.length&&s[0]===t[0])e=!1;else{if(s.length)this._.$closestTargetLi.hasClass(\"collapsed\")&&this._.$closestTarget.children(\".toggle\").trigger(\"click\");else{var n=$('<div class=\"toggle\" title=\"'+Craft.t(\"app\",\"Show/hide children\")+'\"/>').prependTo(this._.$closestTarget);this.structure.initToggle(n),s=$(\"<ul>\").appendTo(this._.$closestTargetLi)}this.$draggee.appendTo(s),e=!0}}if(this._.$closestTarget.removeClass(\"draghover\"),e){t&&this.structure._removeUl(t);var a,r=this.$draggee.parentsUntil(this.structure.$container,\"li\").length+1;r!=this.$draggee.data(\"level\")&&(1==this.$draggee.data(\"level\")?((a={})[\"padding-\"+Craft.left]=38,this.$helperLi.velocity(a,\"fast\")):1==r&&((a={})[\"padding-\"+Craft.left]=Craft.Structure.baseIndent,this.$helperLi.velocity(a,\"fast\")),this.setLevel(this.$draggee,r));var o=this.$draggee.children(\".row\").children(\".element\"),l={structureId:this.structure.id,elementId:o.data(\"id\"),siteId:o.data(\"site-id\"),prevId:this.$draggee.prev().children(\".row\").children(\".element\").data(\"id\"),parentId:this.$draggee.parent(\"ul\").parent(\"li\").children(\".row\").children(\".element\").data(\"id\")};Craft.postActionRequest(\"structures/move-element\",l,function(t,e){\"success\"===e&&Craft.cp.displayNotice(Craft.t(\"app\",\"New order saved.\"))})}}this.$draggee.velocity(\"stop\").removeClass(\"hidden\").velocity({height:this.draggeeHeight},\"fast\",$.proxy(function(){this.$draggee.css(\"height\",\"auto\")},this)),this.returnHelpersToDraggees(),this.base()},setLevel:function(t,e){t.data(\"level\",e);var i=this.structure.getIndent(e),s={};s[\"margin-\"+Craft.left]=\"-\"+i+\"px\",s[\"padding-\"+Craft.left]=i+\"px\",this.$draggee.children(\".row\").css(s);for(var n=t.children(\"ul\").children(),a=0;a<n.length;a++)this.setLevel($(n[a]),e+1)}}),Craft.StructureTableSorter=Garnish.DragSort.extend({tableView:null,structureId:null,maxLevels:null,_helperMargin:null,_$firstRowCells:null,_$titleHelperCell:null,_titleHelperCellOuterWidth:null,_ancestors:null,_updateAncestorsFrame:null,_updateAncestorsProxy:null,_draggeeLevel:null,_draggeeLevelDelta:null,draggingLastElements:null,_loadingDraggeeLevelDelta:!1,_targetLevel:null,_targetLevelBounds:null,_positionChanged:null,init:function(t,e,i){this.tableView=t,this.structureId=this.tableView.$table.data(\"structure-id\"),this.maxLevels=parseInt(this.tableView.$table.attr(\"data-max-levels\")),i=$.extend({},Craft.StructureTableSorter.defaults,i,{handle:\".move\",collapseDraggees:!0,singleHelper:!0,helperSpacingY:2,magnetStrength:4,helper:$.proxy(this,\"getHelper\"),helperLagBase:1.5,axis:Garnish.Y_AXIS}),this.base(e,i)},startDragging:function(){this._helperMargin=Craft.StructureTableSorter.HELPER_MARGIN+(this.tableView.elementIndex.actions?24:0),this.base()},findDraggee:function(){this._draggeeLevel=this._targetLevel=this.$targetItem.data(\"level\"),this._draggeeLevelDelta=0;for(var t=$(this.$targetItem),e=this.$targetItem.next();e.length;){var i=e.data(\"level\");if(i<=this._draggeeLevel)break;var s=i-this._draggeeLevel;s>this._draggeeLevelDelta&&(this._draggeeLevelDelta=s),t=t.add(e),e=e.next()}if(this.draggingLastElements=!e.length,this.maxLevels&&this.draggingLastElements&&this.tableView.getMorePending()){this._loadingDraggeeLevelDelta=!0;var n=this._getAjaxBaseData(this.$targetItem);Craft.postActionRequest(\"structures/get-element-level-delta\",n,$.proxy(function(t,e){\"success\"===e&&(this._loadingDraggeeLevelDelta=!1,this.dragging&&(this._draggeeLevelDelta=t.delta,this.drag(!1)))},this))}return t},getHelper:function(t){var e=$('<div class=\"elements datatablesorthelper\"/>').appendTo(Garnish.$bod),i=$('<div class=\"tableview\"/>').appendTo(e),s=$('<table class=\"data\"/>').appendTo(i),n=$(\"<tbody/>\").appendTo(s);t.appendTo(n),this._$firstRowCells=this.tableView.$elementContainer.children(\"tr:first\").children();for(var a=t.children(),r=0;r<a.length;r++){var o=$(a[r]);if(o.hasClass(\"checkbox-cell\"))o.remove();else{var l=$(this._$firstRowCells[r]),h=l.width();if(l.width(h),o.width(h),Garnish.hasAttr(l,\"data-titlecell\")){this._$titleHelperCell=o;var d=parseInt(l.css(\"padding-\"+Craft.left));this._titleHelperCellOuterWidth=h+d-(this.tableView.elementIndex.actions?12:0),o.css(\"padding-\"+Craft.left,Craft.StructureTableSorter.BASE_PADDING)}}}return e},canInsertBefore:function(t){return!this._loadingDraggeeLevelDelta&&!1!==this._getLevelBounds(t.prev(),t)},canInsertAfter:function(t){return!this._loadingDraggeeLevelDelta&&!1!==this._getLevelBounds(t,t.next())},onDragStart:function(){this._ancestors=this._getAncestors(this.$targetItem,this.$targetItem.data(\"level\")),this._setTargetLevelBounds(),this.tableView.maybeLoadMore(),this.base()},onDrag:function(){this.base(),this._updateIndent()},onInsertionPointChange:function(){this._setTargetLevelBounds(),this._updateAncestorsBeforeRepaint(),this.base()},onDragStop:function(){if(this._positionChanged=!1,this.base(),this._targetLevel!=this._draggeeLevel){for(var t=this._targetLevel-this._draggeeLevel,e=0;e<this.$draggee.length;e++){var i=$(this.$draggee[e]),s=i.data(\"level\")+t,n=Craft.StructureTableSorter.BASE_PADDING+(this.tableView.elementIndex.actions?7:0)+this._getLevelIndent(s);i.data(\"level\",s),i.find(\".element\").data(\"level\",s),i.children(\"[data-titlecell]:first\").css(\"padding-\"+Craft.left,n)}this._positionChanged=!0}if(this._positionChanged){for(var a=this._getAjaxBaseData(this.$draggee),r=this.$draggee.first().prev();r.length;){var o=r.data(\"level\");if(o==this._targetLevel){a.prevId=r.data(\"id\");break}if(o<this._targetLevel){a.parentId=r.data(\"id\");var l=r.find(\"> td > .toggle\");if(!l.hasClass(\"expanded\")){l.addClass(\"expanded\");var h=this.tableView._createSpinnerRowAfter(r);this.tableView.elementSelect&&this.tableView.elementSelect.removeItems(this.$targetItem),this.removeItems(this.$targetItem),this.$targetItem.remove(),this.tableView._totalVisible--}break}r=r.prev()}Craft.postActionRequest(\"structures/move-element\",a,$.proxy(function(t,e){if(\"success\"===e){if(!t.success)return Craft.cp.displayError(Craft.t(\"app\",\"An unknown error occurred.\")),void this.tableView.elementIndex.updateElements();Craft.cp.displayNotice(Craft.t(\"app\",\"New position saved.\")),this.onPositionChange(),h&&h.parent().length&&(h.remove(),this.tableView._expandElement(l,!0)),Craft.cp.runQueue()}},this))}},onSortChange:function(){this.tableView.elementSelect&&this.tableView.elementSelect.resetItemOrder(),this._positionChanged=!0,this.base()},onPositionChange:function(){Garnish.requestAnimationFrame($.proxy(function(){this.trigger(\"positionChange\"),this.settings.onPositionChange()},this))},onReturnHelpersToDraggees:function(){if(this._$firstRowCells.css(\"width\",\"\"),this.draggingLastElements&&this.tableView.getMorePending()){this.tableView._totalVisible+=this.newDraggeeIndexes[0]-this.oldDraggeeIndexes[0];var t=this.$draggee.last().nextAll();t.length&&(this.removeItems(t),t.remove(),this.tableView.maybeLoadMore())}this.base()},_getLevelBounds:function(t,e){if(e&&e.length?this._getLevelBounds._minLevel=e.data(\"level\"):this._getLevelBounds._minLevel=1,t&&t.length?this._getLevelBounds._maxLevel=t.data(\"level\")+1:this._getLevelBounds._maxLevel=1,this.maxLevels){if(1!=this._getLevelBounds._minLevel&&this._getLevelBounds._minLevel+this._draggeeLevelDelta>this.maxLevels)return!1;this._getLevelBounds._maxLevel+this._draggeeLevelDelta>this.maxLevels&&(this._getLevelBounds._maxLevel=this.maxLevels-this._draggeeLevelDelta,this._getLevelBounds._maxLevel<this._getLevelBounds._minLevel&&(this._getLevelBounds._maxLevel=this._getLevelBounds._minLevel))}return{min:this._getLevelBounds._minLevel,max:this._getLevelBounds._maxLevel}},_setTargetLevelBounds:function(){this._targetLevelBounds=this._getLevelBounds(this.$draggee.first().prev(),this.$draggee.last().next())},_updateIndent:function(t){this._updateIndent._mouseDist=this.realMouseX-this.mousedownX,\"rtl\"===Craft.orientation&&(this._updateIndent._mouseDist*=-1),this._updateIndent._indentationDist=Math.round(this._updateIndent._mouseDist/Craft.StructureTableSorter.LEVEL_INDENT),this._updateIndent._targetLevel=this._draggeeLevel+this._updateIndent._indentationDist,this._updateIndent._targetLevel<this._targetLevelBounds.min?(this._updateIndent._indentationDist+=this._targetLevelBounds.min-this._updateIndent._targetLevel,this._updateIndent._targetLevel=this._targetLevelBounds.min):this._updateIndent._targetLevel>this._targetLevelBounds.max&&(this._updateIndent._indentationDist-=this._updateIndent._targetLevel-this._targetLevelBounds.max,this._updateIndent._targetLevel=this._targetLevelBounds.max),this._targetLevel!==(this._targetLevel=this._updateIndent._targetLevel)&&this._updateAncestorsBeforeRepaint(),this._updateIndent._targetLevelMouseDiff=this._updateIndent._mouseDist-this._updateIndent._indentationDist*Craft.StructureTableSorter.LEVEL_INDENT,this._updateIndent._magnetImpact=Math.round(this._updateIndent._targetLevelMouseDiff/15),Math.abs(this._updateIndent._magnetImpact)>Craft.StructureTableSorter.MAX_GIVE&&(this._updateIndent._magnetImpact=(0<this._updateIndent._magnetImpact?1:-1)*Craft.StructureTableSorter.MAX_GIVE),this._updateIndent._closestLevelMagnetIndent=this._getLevelIndent(this._targetLevel)+this._updateIndent._magnetImpact,this.helpers[0].css(\"margin-\"+Craft.left,this._updateIndent._closestLevelMagnetIndent+this._helperMargin),this._$titleHelperCell.width(this._titleHelperCellOuterWidth-(this._updateIndent._closestLevelMagnetIndent+Craft.StructureTableSorter.BASE_PADDING))},_getLevelIndent:function(t){return(t-1)*Craft.StructureTableSorter.LEVEL_INDENT},_getAjaxBaseData:function(t){return{structureId:this.structureId,elementId:t.data(\"id\"),siteId:t.find(\".element:first\").data(\"site-id\")}},_getAncestors:function(t,e){if(this._getAncestors._ancestors=[],0!=e)for(this._getAncestors._level=e,this._getAncestors._$prevRow=t.prev();this._getAncestors._$prevRow.length&&!(this._getAncestors._$prevRow.data(\"level\")<this._getAncestors._level&&(this._getAncestors._ancestors.unshift(this._getAncestors._$prevRow),this._getAncestors._level=this._getAncestors._$prevRow.data(\"level\"),0==this._getAncestors._level));)this._getAncestors._$prevRow=this._getAncestors._$prevRow.prev();return this._getAncestors._ancestors},_updateAncestorsBeforeRepaint:function(){this._updateAncestorsFrame&&Garnish.cancelAnimationFrame(this._updateAncestorsFrame),this._updateAncestorsProxy||(this._updateAncestorsProxy=$.proxy(this,\"_updateAncestors\")),this._updateAncestorsFrame=Garnish.requestAnimationFrame(this._updateAncestorsProxy)},_updateAncestors:function(){for(this._updateAncestorsFrame=null,this._updateAncestors._i=0;this._updateAncestors._i<this._ancestors.length;this._updateAncestors._i++)this._updateAncestors._$ancestor=this._ancestors[this._updateAncestors._i],this._updateAncestors._$ancestor.data(\"descendants\",this._updateAncestors._$ancestor.data(\"descendants\")-1),0==this._updateAncestors._$ancestor.data(\"descendants\")&&this._updateAncestors._$ancestor.find(\"> td > .toggle:first\").remove();for(this._updateAncestors._newAncestors=this._getAncestors(this.$targetItem,this._targetLevel),this._updateAncestors._i=0;this._updateAncestors._i<this._updateAncestors._newAncestors.length;this._updateAncestors._i++)this._updateAncestors._$ancestor=this._updateAncestors._newAncestors[this._updateAncestors._i],this._updateAncestors._$ancestor.data(\"descendants\",this._updateAncestors._$ancestor.data(\"descendants\")+1),1==this._updateAncestors._$ancestor.data(\"descendants\")&&$('<span class=\"toggle expanded\" title=\"'+Craft.t(\"app\",\"Show/hide children\")+'\"></span>').insertAfter(this._updateAncestors._$ancestor.find(\"> td .move:first\"));this._ancestors=this._updateAncestors._newAncestors,delete this._updateAncestors._i,delete this._updateAncestors._$ancestor,delete this._updateAncestors._newAncestors}},{BASE_PADDING:36,HELPER_MARGIN:-7,LEVEL_INDENT:44,MAX_GIVE:22,defaults:{onPositionChange:$.noop}}),Craft.TableElementIndexView=Craft.BaseElementIndexView.extend({$table:null,$selectedSortHeader:null,structureTableSort:null,_totalVisiblePostStructureTableDraggee:null,_morePendingPostStructureTableDraggee:!1,getElementContainer:function(){return this.$table=this.$container.find(\"table:first\"),this.$table.children(\"tbody:first\")},afterInit:function(){Craft.cp.$collapsibleTables=Craft.cp.$collapsibleTables.add(this.$table),Craft.cp.updateResponsiveTables(),this.initTableHeaders(),\"index\"===this.elementIndex.settings.context&&\"structure\"===this.elementIndex.getSelectedSortAttribute()&&Garnish.hasAttr(this.$table,\"data-structure-id\")?this.structureTableSort=new Craft.StructureTableSorter(this,this.getAllElements(),{onSortChange:$.proxy(this,\"_onStructureTableSortChange\")}):this.structureTableSort=null,\"structure\"===this.elementIndex.getSelectedSortAttribute()&&this.addListener(this.$elementContainer,\"click\",function(t){var e=$(t.target);!e.hasClass(\"toggle\")||!1===this._collapseElement(e)&&this._expandElement(e)})},initTableHeaders:function(){for(var t=this.elementIndex.getSelectedSortAttribute(),e=this.$table.children(\"thead\").children().children(\"[data-attribute]\"),i=0;i<e.length;i++){var s=e.eq(i),n=s.attr(\"data-attribute\");if(n===t){this.$selectedSortHeader=s;var a=this.elementIndex.getSelectedSortDirection();s.addClass(\"ordered \"+a).on(\"click\",$.proxy(this,\"_handleSelectedSortHeaderClick\"))}else{this.elementIndex.getSortAttributeOption(n).length&&s.addClass(\"orderable\").on(\"click\",$.proxy(this,\"_handleUnselectedSortHeaderClick\"))}}},isVerticalList:function(){return!0},getTotalVisible:function(){return this._isStructureTableDraggingLastElements()?this._totalVisiblePostStructureTableDraggee:this._totalVisible},setTotalVisible:function(t){this._isStructureTableDraggingLastElements()?this._totalVisiblePostStructureTableDraggee=t:this._totalVisible=t},getMorePending:function(){return this._isStructureTableDraggingLastElements()?this._morePendingPostStructureTableDraggee:this._morePending},setMorePending:function(t){this._isStructureTableDraggingLastElements()?this._morePendingPostStructureTableDraggee=t:this._morePending=this._morePendingPostStructureTableDraggee=t},getLoadMoreParams:function(){var t=this.base();return this._isStructureTableDraggingLastElements()&&(t.criteria.positionedAfter=this.structureTableSort.$targetItem.data(\"id\")),t},appendElements:function(t){this.base(t),this.structureTableSort&&this.structureTableSort.addItems(t),Craft.cp.updateResponsiveTables()},destroy:function(){this.$table&&(Craft.cp.$collapsibleTables=Craft.cp.$collapsibleTables.not(this.$table)),this.base()},createElementEditor:function(e){Craft.createElementEditor(e.data(\"type\"),e,{params:{includeTableAttributesForSource:this.elementIndex.sourceKey},onSaveElement:$.proxy(function(t){t.tableAttributes&&this._updateTableAttributes(e,t.tableAttributes)},this),elementIndex:this.elementIndex})},_collapseElement:function(t,e){if(!e&&!t.hasClass(\"expanded\"))return!1;t.removeClass(\"expanded\");for(var i=t.parent().parent(),s=i.data(\"id\"),n=i.data(\"level\"),a=i.next();a.length;){if(!Garnish.hasAttr(a,\"data-spinnerrow\")){if(a.data(\"level\")<=n)break;this.elementSelect&&this.elementSelect.removeItems(a),this.structureTableSort&&this.structureTableSort.removeItems(a),this._totalVisible--}var r=a.next();a.remove(),a=r}this.elementIndex.instanceState.collapsedElementIds||(this.elementIndex.instanceState.collapsedElementIds=[]),this.elementIndex.instanceState.collapsedElementIds.push(s),this.elementIndex.setInstanceState(\"collapsedElementIds\",this.elementIndex.instanceState.collapsedElementIds),this.maybeLoadMore()},_expandElement:function(t,e){if(!e&&t.hasClass(\"expanded\"))return!1;if(t.addClass(\"expanded\"),this.elementIndex.instanceState.collapsedElementIds){var i=t.parent().parent(),s=i.data(\"id\"),n=$.inArray(s,this.elementIndex.instanceState.collapsedElementIds);if(-1!==n){this.elementIndex.instanceState.collapsedElementIds.splice(n,1),this.elementIndex.setInstanceState(\"collapsedElementIds\",this.elementIndex.instanceState.collapsedElementIds);var r=this._createSpinnerRowAfter(i),a=$.extend(!0,{},this.settings.params);a.criteria.descendantOf=s,Craft.postActionRequest(\"element-indexes/get-more-elements\",a,$.proxy(function(t,e){if(r.parent().length&&\"success\"===e){var i=$(t.html),s=this._totalVisible+i.length,n=this.settings.batchSize&&i.length===this.settings.batchSize;if(n){var a=r.nextAll();this.elementSelect&&this.elementSelect.removeItems(a),this.structureTableSort&&this.structureTableSort.removeItems(a),a.remove(),s-=a.length}else n=this._morePending;r.replaceWith(i),this.thumbLoader.load(i),(this.elementIndex.actions||this.settings.selectable)&&(this.elementSelect.addItems(i.filter(\":not(.disabled)\")),this.elementIndex.updateActionTriggers()),this.structureTableSort&&this.structureTableSort.addItems(i),Craft.appendHeadHtml(t.headHtml),Craft.appendFootHtml(t.footHtml),Craft.cp.updateResponsiveTables(),this.setTotalVisible(s),this.setMorePending(n),this.maybeLoadMore()}},this))}}},_createSpinnerRowAfter:function(t){return $('<tr data-spinnerrow><td class=\"centeralign\" colspan=\"'+t.children().length+'\"><div class=\"spinner\"/></td></tr>').insertAfter(t)},_isStructureTableDraggingLastElements:function(){return this.structureTableSort&&this.structureTableSort.dragging&&this.structureTableSort.draggingLastElements},_handleSelectedSortHeaderClick:function(t){var e=$(t.currentTarget);if(!e.hasClass(\"loading\")){var i=\"asc\"===this.elementIndex.getSelectedSortDirection()?\"desc\":\"asc\";this.elementIndex.setSortDirection(i),this._handleSortHeaderClick(t,e)}},_handleUnselectedSortHeaderClick:function(t){var e=$(t.currentTarget);if(!e.hasClass(\"loading\")){var i=e.attr(\"data-attribute\");this.elementIndex.setSortAttribute(i),this._handleSortHeaderClick(t,e)}},_handleSortHeaderClick:function(t,e){this.$selectedSortHeader&&this.$selectedSortHeader.removeClass(\"ordered asc desc\"),e.removeClass(\"orderable\").addClass(\"ordered loading\"),this.elementIndex.storeSortAttributeAndDirection(),this.elementIndex.updateElements(),this.elementIndex.setIndexAvailable()},_updateTableAttributes:function(t,e){var i=t.closest(\"tr\");for(var s in e)e.hasOwnProperty(s)&&i.children('td[data-attr=\"'+s+'\"]:first').html(e[s])}}),Craft.TagSelectInput=Craft.BaseElementSelectInput.extend({searchTimeout:null,searchMenu:null,$container:null,$elementsContainer:null,$elements:null,$addTagInput:null,$spinner:null,_ignoreBlur:!1,init:function(t){if(!$.isPlainObject(t)){for(var e={},i=[\"id\",\"name\",\"tagGroupId\",\"sourceElementId\"],s=0;s<i.length&&void 0!==arguments[s];s++)e[i[s]]=arguments[s];t=e}this.base($.extend({},Craft.TagSelectInput.defaults,t)),this.$addTagInput=this.$container.children(\".add\").children(\".text\"),this.$spinner=this.$addTagInput.next(),this.addListener(this.$addTagInput,\"textchange\",$.proxy(function(){this.searchTimeout&&clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout($.proxy(this,\"searchForTags\"),500)},this)),this.addListener(this.$addTagInput,\"keypress\",function(t){t.keyCode===Garnish.RETURN_KEY&&(t.preventDefault(),this.searchMenu&&this.selectTag(this.searchMenu.$options[0]))}),this.addListener(this.$addTagInput,\"focus\",function(){this.searchMenu&&this.searchMenu.show()}),this.addListener(this.$addTagInput,\"blur\",function(){this._ignoreBlur?this._ignoreBlur=!1:setTimeout($.proxy(function(){this.searchMenu&&this.searchMenu.hide()},this),1)})},getAddElementsBtn:$.noop,getElementSortAxis:function(){return null},searchForTags:function(){if(this.searchMenu&&this.killSearchMenu(),this.$addTagInput.val()){this.$spinner.removeClass(\"hidden\");for(var t=[],e=0;e<this.$elements.length;e++){var i=$(this.$elements[e]).data(\"id\");i&&t.push(i)}this.settings.sourceElementId&&t.push(this.settings.sourceElementId);var r={search:this.$addTagInput.val(),tagGroupId:this.settings.tagGroupId,excludeIds:t};Craft.postActionRequest(\"tags/search-for-tags\",r,$.proxy(function(t,e){if(this.searchMenu&&this.killSearchMenu(),this.$spinner.addClass(\"hidden\"),\"success\"===e){for(var i,s=$('<div class=\"menu tagmenu\"/>').appendTo(Garnish.$bod),n=$(\"<ul/>\").appendTo(s),a=0;a<t.tags.length;a++)i=$(\"<li/>\").appendTo(n),$('<a data-icon=\"tag\"/>').appendTo(i).text(t.tags[a].title).data(\"id\",t.tags[a].id).addClass(t.tags[a].exclude?\"disabled\":\"\");t.exactMatch||(i=$(\"<li/>\").appendTo(n),$('<a data-icon=\"plus\"/>').appendTo(i).text(r.search)),n.find(\"a:not(.disabled):first\").addClass(\"hover\"),this.searchMenu=new Garnish.Menu(s,{attachToElement:this.$addTagInput,onOptionSelect:$.proxy(this,\"selectTag\")}),this.addListener(s,\"mousedown\",$.proxy(function(){this._ignoreBlur=!0},this)),this.searchMenu.show()}},this))}else this.$spinner.addClass(\"hidden\")},selectTag:function(t){var e=$(t);if(!e.hasClass(\"disabled\")){var i=e.data(\"id\"),s=e.text(),n=$(\"<div/>\",{class:\"element small removable\",\"data-id\":i,\"data-site-id\":this.settings.targetSiteId,\"data-label\":s,\"data-editable\":\"1\"}).appendTo(this.$elementsContainer),a=$(\"<input/>\",{type:\"hidden\",name:this.settings.name+\"[]\",value:i}).appendTo(n);$(\"<a/>\",{class:\"delete icon\",title:Craft.t(\"app\",\"Remove\")}).appendTo(n);var r=$(\"<div/>\",{class:\"label\"}).appendTo(n);$(\"<span/>\",{class:\"title\",text:s}).appendTo(r);var o=-(n.outerWidth()+10);this.$addTagInput.css(\"margin-\"+Craft.left,o+\"px\");var l={};if(l[\"margin-\"+Craft.left]=0,this.$addTagInput.velocity(l,\"fast\"),this.$elements=this.$elements.add(n),this.addElements(n),this.killSearchMenu(),this.$addTagInput.val(\"\"),this.$addTagInput.trigger(\"focus\"),!i){n.addClass(\"loading disabled\");var h={groupId:this.settings.tagGroupId,title:s};Craft.postActionRequest(\"tags/create-tag\",h,$.proxy(function(t,e){\"success\"===e&&t.success?(n.attr(\"data-id\",t.id),a.val(t.id),n.removeClass(\"loading disabled\")):(this.removeElement(n),\"success\"===e&&Craft.cp.displayError(Craft.t(\"app\",\"An unknown error occurred.\")))},this))}}},killSearchMenu:function(){this.searchMenu.hide(),this.searchMenu.destroy(),this.searchMenu=null}},{defaults:{tagGroupId:null}}),Craft.ThumbsElementIndexView=Craft.BaseElementIndexView.extend({getElementContainer:function(){return this.$container.children(\"ul\")}}),Craft.ui={createTextInput:function(t){var e=$(\"<input/>\",{attr:{class:\"text\",type:t.type||\"text\",id:t.id,size:t.size,name:t.name,value:t.value,maxlength:t.maxlength,autofocus:this.getAutofocusValue(t.autofocus),autocomplete:void 0!==t.autocomplete&&t.autocomplete?null:\"off\",disabled:this.getDisabledValue(t.disabled),readonly:t.readonly,title:t.title,placeholder:t.placeholder,step:t.step,min:t.min,max:t.max}});return t.class&&e.addClass(t.class),t.placeholder&&e.addClass(\"nicetext\"),\"password\"===t.type&&e.addClass(\"password\"),t.disabled&&e.addClass(\"disabled\"),t.size||e.addClass(\"fullwidth\"),t.showCharsLeft&&t.maxlength&&e.attr(\"data-show-chars-left\").css(\"padding-\"+(\"ltr\"===Craft.orientation?\"right\":\"left\"),7.2*t.maxlength.toString().length+14+\"px\"),(t.placeholder||t.showCharsLeft)&&new Garnish.NiceText(e),\"password\"===t.type?$('<div class=\"passwordwrapper\"/>').append(e):e},createTextField:function(t){return this.createField(this.createTextInput(t),t)},createTextarea:function(t){var e=$(\"<textarea/>\",{class:\"text\",rows:t.rows||2,cols:t.cols||50,id:t.id,name:t.name,maxlength:t.maxlength,autofocus:t.autofocus&&!Garnish.isMobileBrowser(!0),disabled:!!t.disabled,placeholder:t.placeholder,html:t.value});return t.showCharsLeft&&e.attr(\"data-show-chars-left\",\"\"),t.class&&e.addClass(t.class),t.size||e.addClass(\"fullwidth\"),e},createTextareaField:function(t){return this.createField(this.createTextarea(t),t)},createSelect:function(t){var e=$(\"<div/>\",{class:\"select\"});t.class&&e.addClass(t.class);var i=$(\"<select/>\",{id:t.id,name:t.name,autofocus:t.autofocus&&Garnish.isMobileBrowser(!0),disabled:t.disabled,\"data-target-prefix\":t.targetPrefix}).appendTo(e),s=null;for(var n in t.options)if(t.options.hasOwnProperty(n)){var a=t.options[n];if(void 0!==a.optgroup)s=$(\"<optgroup/>\",{label:a.label}).appendTo(i);else{var r=void 0!==a.label?a.label:a,o=void 0!==a.value?a.value:n,l=void 0!==a.disabled&&a.disabled;$(\"<option/>\",{value:o,selected:o==t.value,disabled:l,html:r}).appendTo(s||i)}}return t.toggle&&(i.addClass(\"fieldtoggle\"),new Craft.FieldToggle(i)),e},createSelectField:function(t){return this.createField(this.createSelect(t),t)},createCheckbox:function(t){var e=t.id||\"checkbox\"+Math.floor(1e9*Math.random()),i=$(\"<input/>\",{type:\"checkbox\",value:void 0!==t.value?t.value:\"1\",id:e,class:\"checkbox\",name:t.name,checked:t.checked?\"checked\":null,autofocus:this.getAutofocusValue(t.autofocus),disabled:this.getDisabledValue(t.disabled),\"data-target\":t.toggle,\"data-reverse-target\":t.reverseToggle});t.class&&i.addClass(t.class),(t.toggle||t.reverseToggle)&&(i.addClass(\"fieldtoggle\"),new Craft.FieldToggle(i));var s=$(\"<label/>\",{for:e,text:t.label});return t.name&&(t.name.length<3||\"[]\"!==t.name.substr(-2))?$([$(\"<input/>\",{type:\"hidden\",name:t.name,value:\"\"})[0],i[0],s[0]]):$([i[0],s[0]])},createCheckboxField:function(t){var e=$('<div class=\"field checkboxfield\"/>',{id:t.id?t.id+\"-field\":null});return t.first&&e.addClass(\"first\"),t.instructions&&e.addClass(\"has-instructions\"),this.createCheckbox(t).appendTo(e),t.instructions&&$('<div class=\"instructions\"/>').text(t.instructions).appendTo(e),e},createCheckboxSelect:function(t){var e,i,s=$('<div class=\"checkbox-select\"/>');t.class&&s.addClass(t.class),t.showAllOption?(e=t.allValue||\"*\",i=t.values==e,$(\"<div/>\").appendTo(s).append(this.createCheckbox({id:t.id,class:\"all\",label:\"<b>\"+(t.allLabel||Craft.t(\"app\",\"All\"))+\"</b>\",name:t.name,value:e,checked:i,autofocus:t.autofocus}))):i=!1;for(var n=0;n<t.options.length;n++){var a=t.options[n];a.value!=e&&$(\"<div/>\").appendTo(s).append(this.createCheckbox({label:a.label,name:t.name?t.name+\"[]\":null,value:a.value,checked:i||Craft.inArray(a.value,t.values),disabled:i}))}return new Garnish.CheckboxSelect(s),s},createCheckboxSelectField:function(t){return this.createField(this.createCheckboxSelect(t),t)},createLightswitch:function(t){var e=t.value||\"1\",i=$(\"<div/>\",{class:\"lightswitch\",tabindex:\"0\",\"data-value\":e,id:t.id,\"aria-labelledby\":t.labelId,\"data-target\":t.toggle,\"data-reverse-target\":t.reverseToggle});return t.on&&i.addClass(\"on\"),t.small&&i.addClass(\"small\"),t.disabled&&i.addClass(\"disabled\"),$('<div class=\"lightswitch-container\"><div class=\"label on\"></div><div class=\"handle\"></div><div class=\"label off\"></div></div>').appendTo(i),t.name&&$(\"<input/>\",{type:\"hidden\",name:t.name,value:t.on?e:\"\",disabled:t.disabled}).appendTo(i),(t.toggle||t.reverseToggle)&&(i.addClass(\"fieldtoggle\"),new Craft.FieldToggle(i)),i.lightswitch()},createLightswitchField:function(t){return this.createField(this.createLightswitch(t),t)},createColorInput:function(t){var e=t.id||\"color\"+Math.floor(1e9*Math.random()),i=t.containerId||e+\"-container\",s=t.name||null,n=t.value||null,a=t.small||!1,r=t.autofocus&&Garnish.isMobileBrowser(!0),o=t.disabled||!1,l=$(\"<div/>\",{id:i,class:\"flex color-container\"}),h=$(\"<div/>\",{class:\"color static\"+(a?\" small\":\"\")}).appendTo(l);$(\"<div/>\",{class:\"color-preview\",style:t.value?{backgroundColor:t.value}:null}).appendTo(h),this.createTextInput({id:e,name:s,value:n,size:10,class:\"color-input\",autofocus:r,disabled:o}).appendTo(l);return new Craft.ColorInput(l),l},createColorField:function(t){return this.createField(this.createColorInput(t),t)},createDateInput:function(t){var e=(t.id||\"date\"+Math.floor(1e9*Math.random()))+\"-date\",i=t.name||null,s=i?i+\"[date]\":null,n=t.value&&\"function\"==typeof t.value.getMonth?t.value:null,a=n?Craft.formatDate(n):null,r=t.autofocus&&Garnish.isMobileBrowser(!0),o=t.disabled||!1,l=$(\"<div/>\",{class:\"datewrapper\"}),h=this.createTextInput({id:e,name:s,value:a,placeholder:\" \",autocomplete:!1,autofocus:r,disabled:o}).appendTo(l);return $('<div data-icon=\"date\"></div>').appendTo(l),i&&$(\"<input/>\",{type:\"hidden\",name:i+\"[timezone]\",val:Craft.timezone}).appendTo(l),h.datepicker($.extend({defaultDate:n||new Date},Craft.datepickerOptions)),l},createDateField:function(t){return this.createField(this.createDateInput(t),t)},createTimeInput:function(t){var e=(t.id||\"time\"+Math.floor(1e9*Math.random()))+\"-time\",i=t.name||null,s=i?i+\"[time]\":null,n=t.value&&\"function\"==typeof t.value.getMonth?t.value:null,a=t.autofocus&&Garnish.isMobileBrowser(!0),r=t.disabled||!1,o=$(\"<div/>\",{class:\"timewrapper\"}),l=this.createTextInput({id:e,name:s,placeholder:\" \",autocomplete:!1,autofocus:a,disabled:r}).appendTo(o);return $('<div data-icon=\"time\"></div>').appendTo(o),i&&$(\"<input/>\",{type:\"hidden\",name:i+\"[timezone]\",val:Craft.timezone}).appendTo(o),l.timepicker(Craft.timepickerOptions),n&&l.timepicker(\"setTime\",3600*n.getHours()+60*n.getMinutes()+n.getSeconds()),o},createTimeField:function(t){return this.createField(this.createTimeInput(t),t)},createField:function(t,e){var i=e.label&&\"__blank__\"!==e.label?e.label:null,s=Craft.isMultiSite&&e.siteId?e.siteId:null,n=$(\"<div/>\",{class:\"field\",id:e.fieldId||(e.id?e.id+\"-field\":null)});if(e.first&&n.addClass(\"first\"),i||e.instructions){var a=$('<div class=\"heading\"/>').appendTo(n);if(i){var r=$(\"<label/>\",{id:e.labelId||(e.id?e.id+\"-label\":null),class:e.required?\"required\":null,for:e.id,text:i}).appendTo(a);if(s)for(var o=0;o<Craft.sites.length;o++)if(Craft.sites[o].id==s){$('<span class=\"site\"/>').text(Craft.sites[o].name).appendTo(r);break}}e.instructions&&$('<div class=\"instructions\"/>').text(e.instructions).appendTo(a)}return $('<div class=\"input\"/>').append(t).appendTo(n),e.warning&&$('<p class=\"warning\"/>').text(e.warning).appendTo(n),e.errors&&this.addErrorsToField(n,e.errors),n},createErrorList:function(t){var e=$('<ul class=\"errors\"/>');return t&&this.addErrorsToList(e,t),e},addErrorsToList:function(t,e){for(var i=0;i<e.length;i++)$(\"<li/>\").text(e[i]).appendTo(t)},addErrorsToField:function(t,e){if(e){t.addClass(\"has-errors\"),t.children(\".input\").addClass(\"errors\");var i=t.children(\"ul.errors\");i.length||(i=this.createErrorList().appendTo(t)),this.addErrorsToList(i,e)}},clearErrorsFromField:function(t){t.removeClass(\"has-errors\"),t.children(\".input\").removeClass(\"errors\"),t.children(\"ul.errors\").remove()},getAutofocusValue:function(t){return t&&!Garnish.isMobileBrowser(!0)?\"autofocus\":null},getDisabledValue:function(t){return t?\"disabled\":null}},Craft.Uploader=Garnish.Base.extend({uploader:null,allowedKinds:null,$element:null,settings:null,_rejectedFiles:{},_extensionList:null,_totalFileCounter:0,_validFileCounter:0,init:function(t,e){this._rejectedFiles={size:[],type:[],limit:[]},this.$element=t,this.allowedKinds=null,this._extensionList=null,this._totalFileCounter=0,this._validFileCounter=0;var i=(e=$.extend({},Craft.Uploader.defaults,e)).events;for(var s in delete e.events,e.allowedKinds&&e.allowedKinds.length&&(\"string\"==typeof e.allowedKinds&&(e.allowedKinds=[e.allowedKinds]),this.allowedKinds=e.allowedKinds,delete e.allowedKinds),e.autoUpload=!1,this.uploader=this.$element.fileupload(e),i)i.hasOwnProperty(s)&&this.uploader.on(s,i[s]);this.settings=e,this.uploader.on(\"fileuploadadd\",$.proxy(this,\"onFileAdd\"))},setParams:function(t){void 0!==Craft.csrfTokenName&&void 0!==Craft.csrfTokenValue&&(t[Craft.csrfTokenName]=Craft.csrfTokenValue),this.uploader.fileupload(\"option\",{formData:t})},getInProgress:function(){return this.uploader.fileupload(\"active\")},isLastUpload:function(){return this.getInProgress()<2},onFileAdd:function(t,s){t.stopPropagation();var n=!1;return this.allowedKinds&&(this._extensionList||this._createExtensionList(),n=!0),s.process().done($.proxy(function(){var t=s.files[0],e=!0;if(n){var i=t.name.match(/\\.([a-z0-4_]+)$/i)[1];-1===$.inArray(i.toLowerCase(),this._extensionList)&&(e=!1,this._rejectedFiles.type.push(\"\u201c\"+t.name+\"\u201d\"))}t.size>this.settings.maxFileSize&&(this._rejectedFiles.size.push(\"\u201c\"+t.name+\"\u201d\"),e=!1),e&&\"function\"==typeof this.settings.canAddMoreFiles&&!this.settings.canAddMoreFiles(this._validFileCounter)&&(this._rejectedFiles.limit.push(\"\u201c\"+t.name+\"\u201d\"),e=!1),e&&(this._validFileCounter++,s.submit()),++this._totalFileCounter===s.originalFiles.length&&(this._totalFileCounter=0,this._validFileCounter=0,this.processErrorMessages())},this)),!0},processErrorMessages:function(){var t;this._rejectedFiles.type.length&&(t=1===this._rejectedFiles.type.length?\"The file {files} could not be uploaded. The allowed file kinds are: {kinds}.\":\"The files {files} could not be uploaded. The allowed file kinds are: {kinds}.\",t=Craft.t(\"app\",t,{files:this._rejectedFiles.type.join(\", \"),kinds:this.allowedKinds.join(\", \")}),this._rejectedFiles.type=[],alert(t)),this._rejectedFiles.size.length&&(t=1===this._rejectedFiles.size.length?\"The file {files} could not be uploaded, because it exceeds the maximum upload size of {size}.\":\"The files {files} could not be uploaded, because they exceeded the maximum upload size of {size}.\",t=Craft.t(\"app\",t,{files:this._rejectedFiles.size.join(\", \"),size:this.humanFileSize(Craft.maxUploadSize)}),this._rejectedFiles.size=[],alert(t)),this._rejectedFiles.limit.length&&(t=1===this._rejectedFiles.limit.length?\"The file {files} could not be uploaded, because the field limit has been reached.\":\"The files {files} could not be uploaded, because the field limit has been reached.\",t=Craft.t(\"app\",t,{files:this._rejectedFiles.limit.join(\", \")}),this._rejectedFiles.limit=[],alert(t))},humanFileSize:function(t){if(t<1024)return t+\" B\";for(var e=-1;++e,1024<=(t/=1024););return t.toFixed(1)+\" \"+[\"kB\",\"MB\",\"GB\",\"TB\",\"PB\",\"EB\",\"ZB\",\"YB\"][e]},_createExtensionList:function(){this._extensionList=[];for(var t=0;t<this.allowedKinds.length;t++){var e=this.allowedKinds[t];if(void 0!==Craft.fileKinds[e])for(var i=0;i<Craft.fileKinds[e].extensions.length;i++){var s=Craft.fileKinds[e].extensions[i];this._extensionList.push(s)}}},destroy:function(){this.$element.fileupload(\"destroy\"),this.base()}},{defaults:{dropZone:null,pasteZone:null,fileInput:null,sequentialUploads:!0,maxFileSize:Craft.maxUploadSize,allowedKinds:null,events:{},canAddMoreFiles:null,headers:{Accept:\"application/json;q=0.9,*/*;q=0.8\"},paramName:\"assets-upload\"}}),Craft.UriFormatGenerator=Craft.BaseInputGenerator.extend({generateTargetValue:function(t){t=(t=t.replace(\"/<(.*?)>/g\",\"\")).toLowerCase(),t=(t=(t=Craft.asciiString(t)).replace(/^[^a-z]+/,\"\")).replace(/[^a-z0-9]+$/,\"\");var e=Craft.filterArray(t.split(/[^a-z0-9]+/)).join(\"-\");return e&&this.settings.suffix&&(e+=this.settings.suffix),e}})}(jQuery);\n//# sourceMappingURL=Craft.min.js.map", "{\"version\":3,\"sources\":[\"Craft.js\"],\"names\":[\"$\",\"extend\",\"Craft\",\"navHeight\",\"t\",\"category\",\"message\",\"params\",\"translations\",\"key\",\"hasOwnProperty\",\"replace\",\"formatDate\",\"date\",\"Date\",\"datepicker\",\"datepickerOptions\",\"dateFormat\",\"formatNumber\",\"number\",\"format\",\"d3\",\"formatLocale\",\"d3FormatLocaleDefinition\",\"formatter\",\"escapeHtml\",\"str\",\"text\",\"html\",\"escapeRegex\",\"getText\",\"encodeUriComponent\",\"encodeURIComponent\",\"differences\",\"!\",\"*\",\"'\",\"(\",\")\",\"chr\",\"re\",\"RegExp\",\"selectFullValue\",\"input\",\"$input\",\"val\",\"setSelectionRange\",\"length\",\"formatInputId\",\"inputName\",\"this\",\"rtrim\",\"getUrl\",\"path\",\"baseUrl\",\"anchor\",\"isPlainObject\",\"aParams\",\"name\",\"value\",\"push\",\"Garnish\",\"isArray\",\"join\",\"trim\",\"url\",\"qpos\",\"indexOf\",\"substr\",\"search\",\"pathMatch\",\"match\",\"pathParam\",\"omitScriptNameInUrls\",\"usePathInfo\",\"scriptName\",\"basePath\",\"endPath\",\"substring\",\"getCpUrl\",\"baseCpUrl\",\"getSiteUrl\",\"baseSiteUrl\",\"getActionUrl\",\"actionUrl\",\"redirectTo\",\"document\",\"location\",\"href\",\"getCsrfInput\",\"csrfTokenName\",\"csrfTokenValue\",\"postActionRequest\",\"action\",\"data\",\"callback\",\"options\",\"headers\",\"X-Registered-Asset-Bundles\",\"Object\",\"keys\",\"registeredAssetBundles\",\"X-Registered-Js-Files\",\"registeredJsFiles\",\"jqXHR\",\"ajax\",\"type\",\"dataType\",\"success\",\"error\",\"textStatus\",\"errorThrown\",\"readyState\",\"cp\",\"displayError\",\"alert\",\"send\",\"_waitingOnAjax\",\"_ajaxQueue\",\"queueActionRequest\",\"undefined\",\"_postNextActionRequestInQueue\",\"args\",\"shift\",\"stringToArray\",\"arr\",\"split\",\"i\",\"expandPostArray\",\"expanded\",\"m\",\"unshift\",\"parentElem\",\"parseInt\",\"compare\",\"obj1\",\"obj2\",\"sortObjectKeys\",\"Array\",\"getObjectKeys\",\"sort\",\"obj\",\"escapeChars\",\"chars\",\"escaped\",\"ltrim\",\"startsWith\",\"filterArray\",\"filtered\",\"inArray\",\"elem\",\"removeFromArray\",\"index\",\"splice\",\"getLast\",\"uppercaseFirst\",\"charAt\",\"toUpperCase\",\"slice\",\"lowercaseFirst\",\"toLowerCase\",\"parseUrl\",\"scheme\",\"host\",\"hostname\",\"port\",\"query\",\"hash\",\"isSameHost\",\"requestUrlInfo\",\"urlInfo\",\"secondsToHumanTimeDuration\",\"seconds\",\"showSeconds\",\"weeks\",\"Math\",\"floor\",\"days\",\"minutes\",\"hours\",\"round\",\"timeComponents\",\"asciiString\",\"charMap\",\"char\",\"asciiStr\",\"asciiCharMap\",\"randomString\",\"result\",\"random\",\"preventOutlineOnMouseFocus\",\"$elem\",\"namespace\",\"on\",\"addClass\",\"trigger\",\"event\",\"keyCode\",\"SHIFT_KEY\",\"CTRL_KEY\",\"CMD_KEY\",\"removeClass\",\"createErrorList\",\"errors\",\"$ul\",\"createElement\",\"$li\",\"appendTo\",\"appendHeadHtml\",\"$existingCss\",\"existingCss\",\"eq\",\"attr\",\"regexp\",\"append\",\"appendFootHtml\",\"$existingJs\",\"src\",\"existingJs\",\"$bod\",\"initUiElements\",\"$container\",\"grid\",\"infoicon\",\"checkboxselect\",\"fieldtoggle\",\"lightswitch\",\"nicetext\",\"pill\",\"formsubmit\",\"menubtn\",\"_elementIndexClasses\",\"_elementSelectorModalClasses\",\"_elementEditorClasses\",\"registerElementIndexClass\",\"elementType\",\"func\",\"registerElementSelectorModalClass\",\"registerElementEditorClass\",\"createElementIndex\",\"settings\",\"BaseElementIndex\",\"createElementSelectorModal\",\"BaseElementSelectorModal\",\"createElementEditor\",\"element\",\"BaseElementEditor\",\"getLocalStorage\",\"defaultValue\",\"systemUid\",\"localStorage\",\"JSON\",\"parse\",\"setLocalStorage\",\"stringify\",\"e\",\"getElementInfo\",\"$element\",\"hasClass\",\"find\",\"id\",\"siteId\",\"label\",\"status\",\"hasThumb\",\"setElementSize\",\"size\",\"otherSize\",\"$oldImg\",\"$newImg\",\"sizes\",\"srcset\",\"replaceWith\",\"picturefill\",\"elements\",\"fn\",\"animateLeft\",\"pos\",\"duration\",\"easing\",\"complete\",\"orientation\",\"velocity\",\"left\",\"right\",\"animateRight\",\"disable\",\"each\",\"removeAttr\",\"enable\",\"itemSelector\",\"cols\",\"maxCols\",\"minColWidth\",\"mode\",\"fillMode\",\"colClass\",\"snapToGrid\",\"Grid\",\"InfoIcon\",\"CheckboxSelect\",\"FieldToggle\",\"settingName\",\"settingValue\",\"setSettings\",\"thisSettings\",\"hasAttr\",\"LightSwitch\",\"NiceText\",\"Pill\",\"ev\",\"$btn\",\"currentTarget\",\"confirm\",\"$anchor\",\"$form\",\"closest\",\"customTrigger\",\"next\",\"menuAnchor\",\"MenuBtn\",\"$doc\",\"ready\",\"Base\",\"elementId\",\"$fieldsContainer\",\"$cancelBtn\",\"$saveBtn\",\"$spinner\",\"$siteSelect\",\"$siteSpinner\",\"hud\",\"init\",\"defaults\",\"loadHud\",\"setElementAttribute\",\"attributes\",\"getBaseData\",\"prevalidate\",\"onBeginLoading\",\"includeSites\",\"isMultiSite\",\"showSiteSwitcher\",\"proxy\",\"showHud\",\"response\",\"onEndLoading\",\"$hudContents\",\"sites\",\"$header\",\"$siteSelectContainer\",\"siteInfo\",\"addListener\",\"add\",\"updateForm\",\"onCreateForm\",\"$footer\",\"$buttonsContainer\",\"updateBody\",\"updateSizeAndPosition\",\"hudTrigger\",\"HUD\",\"bodyClass\",\"closeOtherHUDs\",\"onShow\",\"onHide\",\"onSubmit\",\"$hud\",\"hide\",\"switchSite\",\"newSiteId\",\"reloadForm\",\"$instructions\",\"class\",\"children\",\"requestAnimationFrame\",\"headHtml\",\"footHtml\",\"saveElement\",\"validators\",\"isFunction\",\"call\",\"param\",\"$body\",\"serialize\",\"$title\",\"$a\",\"cpEditUrl\",\"newTitle\",\"closeHud\",\"onSaveElement\",\"shake\",\"onShowHud\",\"onHideHud\",\"runQueue\",\"elementIndex\",\"noop\",\"initialized\",\"instanceState\",\"sourceStates\",\"sourceStatesStorageKey\",\"searchTimeout\",\"sourceSelect\",\"$main\",\"$mainSpinner\",\"isIndexBusy\",\"$sidebar\",\"showingSidebar\",\"sourceKey\",\"sourceViewModes\",\"$source\",\"sourcesByKey\",\"$visibleSources\",\"$customizeSourcesBtn\",\"customizeSourcesModal\",\"$toolbar\",\"$toolbarFlexContainer\",\"toolbarOffset\",\"$search\",\"searching\",\"searchText\",\"trashed\",\"drafts\",\"$clearSearchBtn\",\"$statusMenuBtn\",\"$statusMenuContainer\",\"statusMenu\",\"$siteMenuBtn\",\"siteMenu\",\"$sortMenuBtn\",\"sortMenu\",\"$sortAttributesList\",\"$sortDirectionsList\",\"$scoreSortAttribute\",\"$structureSortAttribute\",\"$elements\",\"$viewModeBtnContainer\",\"viewModeBtns\",\"viewMode\",\"view\",\"_autoSelectElements\",\"$countContainer\",\"page\",\"$exportBtn\",\"actions\",\"actionsHeadHtml\",\"actionsFootHtml\",\"$selectAllContainer\",\"$selectAllCheckbox\",\"showingActionTriggers\",\"_$detachedToolbarItems\",\"_$triggers\",\"getDefaultInstanceState\",\"storageKey\",\"context\",\"parent\",\"hideSidebar\",\"toolbarFixed\",\"isMobileBrowser\",\"$win\",\"$scrollContainer\",\"initSources\",\"menu\",\"$option\",\"$options\",\"filter\",\"first\",\"_setSite\",\"criteria\",\"storedSiteId\",\"$storedSiteOption\",\"startSearching\",\"stopSearching\",\"clearTimeout\",\"setTimeout\",\"RETURN_KEY\",\"preventDefault\",\"updateElementsIfSearchTextChanged\",\"afterInit\",\"selectDefaultSource\",\"setPage\",\"pageNum\",\"updateElements\",\"onAfterInit\",\"getSourceContainer\",\"$sources\",\"$items\",\"_getSourcesInList\",\"Select\",\"multi\",\"allowEmpty\",\"vertical\",\"onSelectionChange\",\"_initSources\",\"getDefaultSourceKey\",\"getSourceByKey\",\"selectSource\",\"refreshSources\",\"removeAllItems\",\"setIndexBusy\",\"refreshSourcesAction\",\"setIndexAvailable\",\"updateFixedToolbar\",\"_scrollTop\",\"scrollTop\",\"width\",\"_makingFixed\",\"css\",\"outerHeight\",\"top\",\"offset\",\"initSource\",\"addItems\",\"initSourceToggle\",\"expandedSources\",\"_expandSource\",\"deinitSourceToggle\",\"$toggle\",\"_getSourceToggle\",\"deinitSource\",\"removeItems\",\"removeListener\",\"removeData\",\"selectedSource\",\"getDefaultExpandedSources\",\"addOptions\",\"prependTo\",\"_updateStructureSortOption\",\"setSortAttribute\",\"detach\",\"setInstanceState\",\"storeInstanceState\",\"getSourceState\",\"source\",\"getSelectedSourceState\",\"setSelecetedSourceState\",\"viewState\",\"storeSortAttributeAndDirection\",\"getSelectedSortAttribute\",\"order\",\"getSelectedSortDirection\",\"max\",\"pageTrigger\",\"history\",\"replaceState\",\"getViewParams\",\"batchSize\",\"limit\",\"disabledElementIds\",\"paginated\",\"_isViewPaginated\",\"collapsedElementIds\",\"preservePagination\",\"destroy\",\"updateElementsAction\",\"totalPages\",\"ceil\",\"count\",\"_updateView\",\"showActionTriggers\",\"height\",\"not\",\"insertAfter\",\"_createTriggers\",\"submitAction\",\"actionClass\",\"actionParams\",\"selectedElementIds\",\"getSelectedElementIds\",\"viewParams\",\"elementAction\",\"elementIds\",\"submitActionsAction\",\"displayNotice\",\"afterAction\",\"onAfterAction\",\"hideActionTriggers\",\"insertBefore\",\"updateActionTriggers\",\"totalSelected\",\"getSelectedElements\",\"getEnabledElements\",\"$selectAllBtn\",\"getSortAttributeOption\",\"attribute\",\"setSortDirection\",\"getSortDirectionOption\",\"dir\",\"getSelectedViewMode\",\"selectItem\",\"updateSidebarMenuLabel\",\"setStoredSortOptionsForSource\",\"remove\",\"getViewModesForSource\",\"sourceViewMode\",\"$viewModeBtn\",\"className\",\"title\",\"icon\",\"selectViewMode\",\"doesSourceHaveViewMode\",\"onSelectSource\",\"selectSourceByKey\",\"sortAttr\",\"sortDir\",\"getDefaultSort\",\"viewModes\",\"force\",\"createView\",\"getViewClass\",\"TableElementIndexView\",\"ThumbsElementIndexView\",\"rememberDisabledElementId\",\"forgetDisabledElementId\",\"enableElements\",\"parents\",\"onEnableElements\",\"disableElements\",\"onDisableElements\",\"getElementById\",\"enableElementsById\",\"ids\",\"makeArray\",\"disableElementsById\",\"selectElementAfterUpdate\",\"addButton\",\"$button\",\"getButtonContainer\",\"isShowingSidebar\",\"buttonContainer\",\"createCustomizeSourcesModal\",\"modal\",\"CustomizeSourcesModal\",\"base\",\"onSelectSite\",\"onUpdateElements\",\"_handleSourceSelectionChange\",\"$selectedItems\",\"_handleActionTriggerSubmit\",\"getPostData\",\"_handleMenuActionTriggerSubmit\",\"option\",\"_handleStatusChange\",\"selectedOption\",\"_handleSiteChange\",\"$firstVisibleSource\",\"selectNewSource\",\"toString\",\"get\",\"$heading\",\"$headings\",\"nextUntil\",\"_handleSortChange\",\"is\",\"_handleSelectionChange\",\"_handleSourceDblClick\",\"_toggleSource\",\"stopPropagation\",\"_handleSourceToggleClick\",\"prev\",\"$firstOption\",\"$list\",\"_getChildSources\",\"siblings\",\"_deinitSources\",\"_collapseSource\",\"$childSources\",\"countLabel\",\"$paginationContainer\",\"$prevBtn\",\"data-icon\",\"$nextBtn\",\"role\",\"tabindex\",\"aria-checked\",\"selectAllElements\",\"deselectAllElements\",\"SPACE_KEY\",\"selectable\",\"multiSelect\",\"checkboxMode\",\"selectElementById\",\"triggers\",\"safeMenuActions\",\"destructiveMenuActions\",\"destructive\",\"$menuTrigger\",\"$menu\",\"$safeList\",\"_createMenuTriggerList\",\"$destructiveList\",\"$div\",\"_showExportHud\",\"$limitField\",\"ui\",\"createTextField\",\"placeholder\",\"min\",\"submitting\",\"isNaN\",\"tokenParam\",\"token\",\"data-action\",\"BaseElementIndexView\",\"$loadingMoreSpinner\",\"$elementContainer\",\"$scroller\",\"thumbLoader\",\"elementSelect\",\"loadingMore\",\"_totalVisible\",\"_morePending\",\"_handleEnableElements\",\"_handleDisableElements\",\"container\",\"getElementContainer\",\"setTotalVisible\",\"setMorePending\",\"ElementThumbLoader\",\"load\",\"isVerticalList\",\"handle\",\"_handleElementEditing\",\"$target\",\"target\",\"prop\",\"isTouchCapable\",\"maybeLoadMore\",\"getAllElements\",\"$selectedElements\",\"selectElement\",\"selectAll\",\"deselectAll\",\"getTotalVisible\",\"totalVisible\",\"getMorePending\",\"morePending\",\"canLoadMore\",\"loadMore\",\"winHeight\",\"innerHeight\",\"winScrollTop\",\"getLoadMoreParams\",\"loadMoreElementsAction\",\"$newElements\",\"appendElements\",\"onAppendElements\",\"newElements\",\"off\",\"BaseElementSelectInput\",\"elementSort\",\"elementEditor\",\"$elementsContainer\",\"$addElementBtn\",\"_initialized\",\"normalizedSettings\",\"arguments\",\"modalStorageKey\",\"sortable\",\"getContainer\",\"getElementsContainer\",\"getAddElementsBtn\",\"initElementSelect\",\"initElementSort\",\"resetElements\",\"getElements\",\"DragSort\",\"$targetItem\",\"getSelectedItems\",\"ignoreHandleSelector\",\"axis\",\"getElementSortAxis\",\"collapseDraggees\",\"magnetStrength\",\"helperLagBase\",\"onSortChange\",\"resetItemOrder\",\"canAddMoreElements\",\"updateAddElementsBtn\",\"enableAddElementsBtn\",\"disableAddElementsBtn\",\"ADD_FX_DURATION\",\"REMOVE_FX_DURATION\",\"show\",\"removeElements\",\"addElements\",\"editable\",\"_handleShowElementEditor\",\"removeElement\",\"onRemoveElements\",\"animateElementAway\",\"animateCss\",\"opacity\",\"outerWidth\",\"showModal\",\"createModal\",\"getModalSettings\",\"closeOtherModals\",\"sources\",\"showSiteMenu\",\"getDisabledElementIds\",\"onSelect\",\"modalSettings\",\"sourceElementId\",\"onModalSelect\",\"slotsLeft\",\"selectElements\",\"updateDisabledElementsInModal\",\"elementInfo\",\"createNewElement\",\"appendElement\",\"animateElementIntoPlace\",\"onSelectElements\",\"clone\",\"prepend\",\"$modalElement\",\"$inputElement\",\"origOffset\",\"destOffset\",\"$helper\",\"position\",\"zIndex\",\"window\",\"draftEditor\",\"checkForm\",\"fieldId\",\"editorSettings\",\"Modal\",\"$selectBtn\",\"$sourceToggles\",\"$tbody\",\"$primaryButtons\",\"$secondaryButtons\",\"$footerSpinner\",\"onFadeIn\",\"_createElementIndex\",\"updateSelectBtnState\",\"enableSelectBtn\",\"disableSelectBtn\",\"enableCancelBtn\",\"disableCancelBtn\",\"showFooterSpinner\",\"hideFooterSpinner\",\"cancel\",\"clearMouseUpTimeout\",\"disableElementsOnSelect\",\"hideOnSelect\",\"info\",\"has\",\"touchData\",\"firstTap\",\"secondTap\",\"resizable\",\"onCancel\",\"hideIndexSidebar\",\"BaseInputGenerator\",\"listening\",\"timeout\",\"startListening\",\"setNewSource\",\"stopListening\",\"removeAllListeners\",\"onSourceTextChange\",\"onTargetTextChange\",\"activeElement\",\"onFormSubmit\",\"updateTarget\",\"sourceVal\",\"targetVal\",\"generateTargetValue\",\"AdminTable\",\"totalItems\",\"sorter\",\"$noItems\",\"$table\",\"$deleteBtns\",\"allowDeleteAll\",\"minItems\",\"noItemsSelector\",\"tableSelector\",\"DataTableSorter\",\"updateUI\",\"addRow\",\"row\",\"maxItems\",\"$row\",\"$deleteBtn\",\"reorderItems\",\"idAttribute\",\"reorderAction\",\"onReorderItems\",\"reorderSuccessMessage\",\"reorderFailMessage\",\"handleDeleteBtnClick\",\"confirmDeleteItem\",\"deleteItem\",\"getItemName\",\"confirmDeleteMessage\",\"getItemId\",\"deleteAction\",\"handleDeleteItemResponse\",\"onDeleteItem\",\"deleteSuccessMessage\",\"deleteFailMessage\",\"nameAttribute\",\"$moveButtons\",\"newItemBtnSelector\",\"AssetEditor\",\"reloadIndex\",\"$imageEditorTrigger\",\"showImageEditor\",\"AssetImageEditor\",\"onSave\",\"bind\",\"allowDegreeFractions\",\"isImagick\",\"$imageTools\",\"$buttons\",\"$replaceBtn\",\"$editorContainer\",\"$straighten\",\"$croppingCanvas\",\"$spinnerCanvas\",\"canvas\",\"image\",\"viewport\",\"focalPoint\",\"croppingCanvas\",\"clipper\",\"croppingRectangle\",\"cropperHandles\",\"cropperGrid\",\"croppingShade\",\"imageStraightenAngle\",\"viewportRotation\",\"originalWidth\",\"originalHeight\",\"imageVerticeCoords\",\"zoomRatio\",\"animationInProgress\",\"currentView\",\"assetId\",\"cacheBust\",\"draggingCropper\",\"scalingCropper\",\"draggingFocal\",\"previousMouseX\",\"previousMouseY\",\"shiftKeyHeld\",\"editorHeight\",\"editorWidth\",\"cropperState\",\"scaleFactor\",\"flipData\",\"focalPointState\",\"croppingConstraint\",\"spinnerInterval\",\"maxImageSize\",\"lastLoadedDimensions\",\"imageIsLoading\",\"renderImage\",\"renderCropper\",\"now\",\"x\",\"y\",\"allowSavingAsNew\",\"saveImage\",\"$shade\",\"getMaxImageSize\",\"browserViewportWidth\",\"documentElement\",\"clientWidth\",\"browserViewportHeight\",\"clientHeight\",\"devicePixelRatio\",\"loadEditor\",\"$tabs\",\"$viewsContainer\",\"$views\",\"innerWidth\",\"_showSpinner\",\"fabric\",\"StaticCanvas\",\"enableRetinaScaling\",\"renderAll\",\"imageUrl\",\"Image\",\"fromURL\",\"imageObject\",\"set\",\"originX\",\"originY\",\"getHeight\",\"getWidth\",\"getScaledImageDimensions\",\"_setFittedImageVerticeCoordinates\",\"_repositionEditorElements\",\"focalState\",\"imageDimensions\",\"offsetX\",\"offsetY\",\"focal\",\"focalData\",\"adjustedX\",\"adjustedY\",\"storeFocalPointState\",\"_createFocalPoint\",\"_createViewport\",\"storeCropperState\",\"_addControlListeners\",\"_handleMouseMove\",\"_handleMouseDown\",\"_handleMouseUp\",\"_hideSpinner\",\"_reloadImage\",\"setSrc\",\"min-width\",\"min-height\",\"previousEditorDimensions\",\"setDimensions\",\"currentScaledDimensions\",\"getZoomToFitRatio\",\"previouslyOccupiedArea\",\"_getBoundingRectangle\",\"_repositionCropper\",\"getZoomToCoverRatio\",\"_repositionImage\",\"_repositionViewport\",\"_repositionFocalPoint\",\"_zoomImage\",\"Rect\",\"fill\",\"globalCompositeOperation\",\"sizeFactor\",\"focalX\",\"focalY\",\"deltaX\",\"deltaY\",\"Group\",\"Circle\",\"radius\",\"strokeWidth\",\"stroke\",\"toggleFocalPoint\",\"dimensions\",\"state\",\"currentWidth\",\"ratio\",\"hasOrientationChanged\",\"imageRatio\",\"rotateImage\",\"flipImage\",\"straighteningInput\",\"SlideRuleInput\",\"onStart\",\"_showGrid\",\"onChange\",\"slider\",\"straighten\",\"onEnd\",\"_hideGrid\",\"_cleanupFocalPointAfterStraighten\",\"onOptionSelect\",\"setCroppingConstraint\",\"enforceCroppingConstraint\",\"_handleTabClick\",\"$tab\",\"showView\",\"enableSlider\",\"disableSlider\",\"disableCropMode\",\"enableCropMode\",\"zoomFactor\",\"degrees\",\"imageZoomRatio\",\"newAngle\",\"angle\",\"scaledImageDimensions\",\"viewportProperties\",\"imageProperties\",\"angleInRadians\",\"PI\",\"newDeltaX\",\"cos\",\"sin\",\"newDeltaY\",\"modifiedDeltaX\",\"modifiedDeltaY\",\"temp\",\"animate\",\"animationDuration\",\"onComplete\",\"cleanAngle\",\"parseFloat\",\"_adjustFocalPointByAngle\",\"_resetFocalPointPosition\",\"editorCenter\",\"setValue\",\"properties\",\"scaleY\",\"scaleX\",\"previousAngle\",\"_adjustEditorElementsOnStraighten\",\"newCenterX\",\"newCenterY\",\"angleDelta\",\"currentZoomRatio\",\"adjustmentRatio\",\"cropperCenterX\",\"cropperCenterY\",\"imageVertices\",\"getImageVerticeCoords\",\"rectangle\",\"_getZoomRatioToFitRectangle\",\"_isCenterInside\",\"object\",\"containingObject\",\"newFocalX\",\"newFocalY\",\"adjustedFocalX\",\"adjustedFocalY\",\"containingVertices\",\"vertex\",\"rectangleVertices\",\"_getRectangleVertices\",\"verticeIndex\",\"arePointsInsideRectangle\",\"edge\",\"_getEdgeCrossed\",\"rectangleCenter\",\"distanceFromVertexToEdge\",\"abs\",\"sqrt\",\"pow\",\"distanceFromCenterToEdge\",\"postData\",\"imageRotation\",\"cropData\",\"zoom\",\"end\",\"scaledWidth\",\"scaledHeight\",\"boundingBox\",\"_getImageBoundingBox\",\"scale\",\"vertScale\",\"horiScale\",\"getCombinedZoomRatio\",\"strokeOptions\",\"gridWidth\",\"gridHeight\",\"xStep\",\"yStep\",\"Line\",\"onFadeOut\",\"cropperData\",\"_showCropper\",\"_editorModeTransition\",\"_hideCropper\",\"targetZoom\",\"inverseZoomFactor\",\"imageOffsetX\",\"imageOffsetY\",\"getContext\",\"start\",\"cW\",\"cH\",\"setInterval\",\"rotation\",\"save\",\"clearRect\",\"translate\",\"rotate\",\"beginPath\",\"moveTo\",\"lineTo\",\"lineWidth\",\"strokeStyle\",\"restore\",\"clearInterval\",\"clipperData\",\"_setupCropperLayer\",\"_redrawCropperElements\",\"backgroundColor\",\"hoverCursor\",\"selection\",\"rectangleRatio\",\"rectWidth\",\"rectHeight\",\"lineOptions\",\"gridOptions\",\"pathGroup\",\"Path\",\"previousImageArea\",\"currentOffset\",\"areaFactor\",\"coordinateSet\",\"a\",\"b\",\"c\",\"d\",\"_isMouseOver\",\"move\",\"_cropperHandleHitTest\",\"pageX\",\"pageY\",\"_handleFocalDrag\",\"_handleCropperDrag\",\"_handleCropperResize\",\"_setMouseCursor\",\"vertices\",\"newX\",\"newY\",\"constraint\",\"previousHeight\",\"previousWidth\",\"topDelta\",\"leftDelta\",\"change\",\"cursor\",\"parentOffset\",\"mouseX\",\"mouseY\",\"lb\",\"rb\",\"tb\",\"bb\",\"topLeft\",\"topRight\",\"bottomRight\",\"zoomMode\",\"topVerticalSegment\",\"bottomVerticalSegment\",\"rightHorizontalSegment\",\"leftHorizontalSegment\",\"verticalOffset\",\"horizontalOffset\",\"_debug\",\"fabricObj\",\"debugger\",\"points\",\"ab\",\"_getVector\",\"bc\",\"scalarAbAb\",\"_getScalarProduct\",\"scalarBcBc\",\"point\",\"ap\",\"bp\",\"scalarAbAp\",\"scalarBcBp\",\"_getVectorMagnitude\",\"vector\",\"_getAngleBetweenVectors\",\"acos\",\"edgePoints\",\"centerPoint\",\"smallestDiff\",\"edgeCrossed\",\"edgeIndex\",\"toCenter\",\"edgeVector\",\"toVertex\",\"diff\",\"box\",\"proportion\",\"AssetIndex\",\"$includeSubfoldersContainer\",\"$includeSubfoldersCheckbox\",\"showingIncludeSubfoldersCheckbox\",\"$uploadButton\",\"$uploadInput\",\"$progressBar\",\"$folders\",\"uploader\",\"promptHandler\",\"progressBar\",\"_uploadTotalFiles\",\"_uploadFileProgress\",\"_uploadedAssetIds\",\"_currentUploaderSettings\",\"_assetDrag\",\"_folderDrag\",\"_expandDropTargetFolderTimeout\",\"_tempExpandedFolders\",\"_fileConflictTemplate\",\"choices\",\"_folderConflictTemplate\",\"_initIndexPageMode\",\"_createFolderContextMenu\",\"_getSourceLevel\",\"updateDropTargets\",\"contextMenu\",\"parentsUntil\",\"onDragStartProxy\",\"onDropTargetChangeProxy\",\"DragDrop\",\"activeDropTargetClass\",\"helperOpacity\",\"helper\",\"$file\",\"_getFileDragHelper\",\"dropTargets\",\"targets\",\"_getFolderUidFromSourceKey\",\"onDragStart\",\"onDropTargetChange\",\"onDragStop\",\"$selected\",\"draggees\",\"$draggeeHelper\",\"$helperSidebar\",\"$helperNav\",\"$helperUl\",\"padding-top\",\"$draggee\",\"padding-right\",\"padding-bottom\",\"padding-left\",\"draggedSourceIds\",\"_onFileDragStop\",\"$activeDropTarget\",\"originatingSource\",\"targetFolderId\",\"originalAssetIds\",\"originalAssetId\",\"_positionProgressBar\",\"resetProgressBar\",\"setItemCount\",\"showProgressBar\",\"parameterArray\",\"folderId\",\"onMoveFinish\",\"responseArray\",\"resetPrompts\",\"conflict\",\"addPrompt\",\"suggestedFilename\",\"prompt\",\"hideProgressBar\",\"performAfterMoveActions\",\"_collapseExtraExpandedFolders\",\"getPromptCount\",\"promptCallback\",\"returnData\",\"newParameterArray\",\"choice\",\"filename\",\"apply\",\"_performBatchRequests\",\"fadeOutHelpers\",\"showBatchPrompts\",\"returnHelpersToDraggees\",\"_onFolderDragStop\",\"folderIds\",\"reverse\",\"parentId\",\"requestId\",\"fileMoveList\",\"newSourceKey\",\"transferList\",\"newFolderId\",\"newFolderUid\",\"merge\",\"_performActualFolderMove\",\"folderDeleteList\",\"moveCallback\",\"counter\",\"_getParentSource\",\"_selectSourceByFolderId\",\"$targetSource\",\"_getSourceByKey\",\"$parentSources\",\"$parentSource\",\"PromptHandler\",\"ProgressBar\",\"fileInput\",\"dropZone\",\"events\",\"fileuploadstart\",\"fileuploadprogressall\",\"fileuploaddone\",\"kind\",\"allowedKinds\",\"Uploader\",\"setParams\",\"$subContainer\",\"checked\",\"marginBottom\",\"includeSubfolders\",\"_onUploadStart\",\"_onUploadProgress\",\"progress\",\"loaded\",\"total\",\"setProgressPercentage\",\"_onUploadComplete\",\"files\",\"doReload\",\"file\",\"isLastUpload\",\"_updateAfterUpload\",\"_uploadFollowup\",\"finalCallback\",\"doFollowup\",\"parameterIndex\",\"followupCallback\",\"incrementProcessedItemCount\",\"updateProgressBar\",\"sourceAssetId\",\"conflictingAssetId\",\"targetFilename\",\"_onUpdateElements\",\"_onKeyDown\",\"_onElementFocus\",\"shiftKey\",\"PreviewFileModal\",\"openInstance\",\"selfDestruct\",\"$focusedItem\",\"_loadPreview\",\"item\",\"startingWidth\",\"startingHeight\",\"_onDragStart\",\"$outerContainer\",\"$innerContainer\",\"_$firstRowCells\",\"$helperCells\",\"$helperCell\",\"$firstRowCell\",\"_onDropTargetChange\",\"$dropTarget\",\"dropTargetFolder\",\"_hasSubfolders\",\"_isExpanded\",\"dropTargetFolderId\",\"$excludedSources\",\"_collapseFolder\",\"_expandFolder\",\"menuOptions\",\"onClick\",\"ContextMenu\",\"menuClass\",\"_createSubfolder\",\"$parentFolder\",\"subfolderName\",\"folderName\",\"_prepareParentForChildren\",\"$subfolder\",\"folderUid\",\"_appendSubfolder\",\"_deleteFolder\",\"$targetFolder\",\"folder\",\"_cleanUpTree\",\"_renameFolder\",\"oldName\",\"newName\",\"$existingChildren\",\"subfolderLabel\",\"folderInserted\",\"$existingChild\",\"before\",\"windowHeight\",\"doRequest\",\"parameters\",\"AssetSelectInput\",\"originalFilename\",\"originalExtension\",\"resetOriginalFilename\",\"_renameHelper\",\"validateElementForm\",\"_attachUploader\",\"defaultFieldLayoutId\",\"formData\",\"canAddMoreFiles\",\"selectUploadedFile\",\"$newElement\",\"margin\",\"slotsTaken\",\"_parseFilename\",\"parts\",\"extension\",\"pop\",\"baseFileName\",\"endPos\",\"selectionStart\",\"selectionEnd\",\"createRange\",\"select\",\"range\",\"collapse\",\"moveEnd\",\"moveStart\",\"$filenameField\",\"ext\",\"oldExt\",\"newExt\",\"AssetSelectorModal\",\"$selectTransformBtn\",\"_selectedTransform\",\"transforms\",\"createSelectTransformButton\",\"$btnGroup\",\"$menuList\",\"MenuButton\",\"allowTransforms\",\"onSelectTransform\",\"transform\",\"selectImagesWithTransform\",\"transformUrls\",\"imageIdsWithMissingUrls\",\"$item\",\"fetchMissingTransformUrls\",\"canSelectImageTransforms\",\"AuthManager\",\"remainingSessionTime\",\"checkRemainingSessionTimer\",\"showLoginModalTimer\",\"decrementLogoutWarningInterval\",\"showingLogoutWarningModal\",\"showingLoginModal\",\"logoutWarningModal\",\"loginModal\",\"$logoutWarningPara\",\"$passwordInput\",\"$passwordSpinner\",\"$loginBtn\",\"$loginErrorPara\",\"submitLoginIfLoggedOut\",\"updateRemainingSessionTime\",\"setCheckRemainingSessionTimer\",\"checkRemainingSessionTime\",\"extendSession\",\"responseJSON\",\"minSafeSessiotTime\",\"showLogoutWarningModal\",\"checkInterval\",\"submitLogin\",\"showLoginModal\",\"hideLogoutWarningModal\",\"hideLoginModal\",\"quickShow\",\"$logoutBtn\",\"$renewSessionBtn\",\"autoShow\",\"hideOnEsc\",\"hideOnShadeClick\",\"shadeClass\",\"updateLogoutWarningMessage\",\"time\",\"decrementLogoutWarning\",\"quick\",\"quickHide\",\"$inputContainer\",\"$inputsFlexContainer\",\"$passwordContainer\",\"$buttonContainer\",\"$passwordWrapper\",\"PasswordInput\",\"onToggleInput\",\"$newPasswordInput\",\"logout\",\"renewSession\",\"validatePassword\",\"login\",\"clearLoginError\",\"loginName\",\"username\",\"password\",\"showLoginError\",\"CategoryIndex\",\"editableGroups\",\"$newCategoryBtnGroup\",\"$newCategoryBtn\",\"editableCategoryGroups\",\"group\",\"uid\",\"defaultGroupHandle\",\"updateButton\",\"selectedSourceHandle\",\"selectedGroup\",\"$menuBtn\",\"_getGroupTriggerHref\",\"_openCreateCategoryModal\",\"getAttribute\",\"menuHtml\",\"menuBtn\",\"uri\",\"primarySiteId\",\"groupId\",\"newCategoryBtnText\",\"groupSourceKey\",\"CategorySelectInput\",\"selectedCategoryIds\",\"categoryIds\",\"branchLimit\",\"selectionLabel\",\"$newElementsContainer\",\"filteredElements\",\"$allCategories\",\"_animateCategoryAway\",\"charts\",\"DataTable\",\"columns\",\"rows\",\"forEach\",\"cellIndex\",\"parseTime\",\"timeParse\",\"Tip\",\"$tip\",\"setContent\",\"setPosition\",\"BaseChart\",\"$chart\",\"chartBaseClass\",\"dataTable\",\"timeFormatLocale\",\"svg\",\"globalSettings\",\"formats\",\"d3Formats\",\"formatLocaleDefinition\",\"timeFormatLocaleDefinition\",\"d3TimeFormatLocaleDefinition\",\"resize\",\"baseSettings\",\"draw\",\"chartClass\",\"onAfterDrawTicks\",\"tickKey\",\"tick\",\"$tickText\",\"numberFormat\",\"percentFormat\",\"currencyFormat\",\"shortDateFormats\",\"day\",\"month\",\"year\",\"bottom\",\"colors\",\"Area\",\"tip\",\"drawingArea\",\"getChartMargin\",\"translateX\",\"translateY\",\"drawTicks\",\"drawAxes\",\"drawChart\",\"drawTipTriggers\",\"getX\",\"xAxis\",\"axisBottom\",\"tickFormat\",\"getXFormatter\",\"ticks\",\"yAxis\",\"getY\",\"axisLeft\",\"getYFormatter\",\"tickValues\",\"getYTickValues\",\"axisRight\",\"showAxis\",\"tickSizeOuter\",\"gridlines\",\"xLineAxis\",\"tickSize\",\"yLineAxis\",\"line\",\"datum\",\"style\",\"area\",\"y0\",\"y1\",\"plots\",\"enter\",\"tips\",\"chartMargin\",\"xAxisTickInterval\",\"node\",\"getTotalLength\",\"tipTriggerWidth\",\"$content\",\"$xValue\",\"$yValue\",\"content\",\"calcLeft\",\"values\",\"yTicksMaxWidth\",\"computedTickWidth\",\"padded\",\"xDomainMin\",\"xDomainMax\",\"xDomain\",\"scaleTime\",\"domain\",\"yDomain\",\"getYMaxValue\",\"scaleLinear\",\"utils\",\"getTimeFormatter\",\"getNumberFormatter\",\"maxValue\",\"getDuration\",\"secondsNum\",\"chartSettings\",\"dataScale\",\"ColorInput\",\"$colorContainer\",\"$colorPreview\",\"$colorInput\",\"createColorInput\",\"handleTextChange\",\"setAttribute\",\"updateColor\",\"_browserSupportsColorInputs\",\"doesBrowserSupportColorInputs\",\"CP\",\"authManager\",\"$nav\",\"$mainContainer\",\"$alerts\",\"$crumbs\",\"$notificationContainer\",\"$primaryForm\",\"$mainContent\",\"$details\",\"$selectedTab\",\"$contentContainer\",\"$edition\",\"$collapsibleTables\",\"fixedHeader\",\"enableQueue\",\"jobInfo\",\"displayedJobInfo\",\"displayedJobInfoUnchanged\",\"trackJobProgressTimeout\",\"jobProgressIcon\",\"checkingForUpdates\",\"forcingRefreshOnUpdatesCheck\",\"checkForUpdatesCallbacks\",\"updateFixedHeader\",\"updateResponsiveTables\",\"$errorNotifications\",\"$otherNotifications\",\"delay\",\"notificationDuration\",\"initAlerts\",\"isCtrlKeyPressed\",\"S_KEY\",\"submitPrimaryForm\",\"initTabs\",\"initConfirmUnloadForms\",\"$confirmUnloadForms\",\"serialized\",\"confirmUnload\",\"livePreview\",\"inPreviewMode\",\"originalEvent\",\"returnValue\",\"_handleInputFocus\",\"_handleInputBlur\",\"saveShortcut\",\"$label\",\"toggleNav\",\"toggleClass\",\"toggleSidebar\",\"tabs\",\"tabWidths\",\"totalWidth\",\"selectTab\",\"tab\",\"deselectTab\",\"_i\",\"_$table\",\"_containerWidth\",\"_check\",\"_isCollapsed\",\"getBoundingClientRect\",\"headerHeight\",\"max-height\",\"fixedheader\",\"displayNotification\",\"$notification\",\"fadedMargin\",\"margin-left\",\"margin-right\",\"display\",\"notificationType\",\"fetchAlerts\",\"displayAlerts\",\"alerts\",\"margin-top\",\"$shunnableAlerts\",\"$link\",\"checkForUpdates\",\"forceRefresh\",\"realCallback\",\"updateUtilitiesBadge\",\"callbacks\",\"updateInfo\",\"$utilitiesLink\",\"$badge\",\"badgeCount\",\"runQueueAutomatically\",\"trackJobProgress\",\"_trackJobProgressInternal\",\"setJobInfo\",\"animateIcon\",\"oldInfo\",\"getDisplayedJobInfo\",\"progressLabel\",\"updateJobIcon\",\"statuses\",\"JOB_STATUS_RESERVED\",\"JOB_STATUS_FAILED\",\"JOB_STATUS_WAITING\",\"j\",\"JobProgressIcon\",\"hideFailMode\",\"setDescription\",\"description\",\"setProgress\",\"showFailMode\",\"JOB_STATUS_DONE\",\"failMode\",\"_canvasSupported\",\"_$bgCanvas\",\"_$staticCanvas\",\"_$hoverCanvas\",\"_$failCanvas\",\"_staticCtx\",\"_hoverCtx\",\"_canvasSize\",\"_arcPos\",\"_arcRadius\",\"_lineWidth\",\"_arcStartPos\",\"_arcEndPos\",\"_arcStartStepSize\",\"_arcEndStepSize\",\"_arcStep\",\"_arcStepTimeout\",\"_arcAnimateCallback\",\"_progressBar\",\"$canvasContainer\",\"_createCanvas\",\"_drawArc\",\"_animateArc\",\"_setArc\",\"$innerProgressBar\",\"toggleHud\",\"toggle\",\"QueueHUD\",\"color\",\"$canvas\",\"ctx\",\"lineCap\",\"startPos\",\"arc\",\"closePath\",\"targetStartPos\",\"targetEndPos\",\"_takeNextArcStep\",\"jobsById\",\"completedJobs\",\"updateViewProxy\",\"updateView\",\"newJobIds\",\"updateStatus\",\"Job\",\"placed\",\"$object\",\"$statusContainer\",\"$descriptionContainer\",\"$progressLabel\",\"$flex\",\"empty\",\"$actionBtn\",\"performErrorAction\",\"$elementIndexSourcesContainer\",\"$sourcesContainer\",\"$sourceSettingsContainer\",\"$newHeadingBtn\",\"$footerBtnContainer\",\"$saveSpinner\",\"$loadingSpinner\",\"sourceSort\",\"updateSourcesOnSave\",\"availableTableAttributes\",\"setContainer\",\"buildModal\",\"addSource\",\"sourceData\",\"$itemLabel\",\"$itemInput\",\"heading\",\"Heading\",\"updateItemLabel\",\"Source\",\"handleNewHeadingBtnClick\",\"scrollContainerToElement\",\"$pendingHeading\",\"$lastSource\",\"$indexSource\",\"getIndexSource\",\"isHeading\",\"appendSource\",\"$extraSources\",\"nextAll\",\"BaseSource\",\"$settingsContainer\",\"isSelected\",\"deselect\",\"createSettings\",\"tableAttributes\",\"firstAttribute\",\"firstKey\",\"firstLabel\",\"$titleColumnCheckbox\",\"createTableColumnOption\",\"$columnCheckboxes\",\"selectedAttributes\",\"createField\",\"instructions\",\"createCheckbox\",\"disabled\",\"$labelField\",\"$labelInput\",\"handleLabelInputChange\",\"deleteHeading\",\"table\",\"$rows\",\"caboose\",\"Y_AXIS\",\"getHelper\",\"$helperRow\",\"helperClass\",\"$cells\",\"DeleteUserModal\",\"userId\",\"$deleteActionRadios\",\"$deleteSpinner\",\"userSelect\",\"_deleting\",\"idParam\",\"redirect\",\"contentSummary\",\"$deleteSubmitBtn\",\"validateDeleteInputs\",\"validates\",\"handleSubmit\",\"DraftEditor\",\"$revisionBtn\",\"$revisionLabel\",\"$statusIcon\",\"$editMetaBtn\",\"metaHud\",\"$nameTextInput\",\"$notesTextInput\",\"$saveMetaBtn\",\"lastSerializedValue\",\"saving\",\"saveXhr\",\"checkFormAfterUpdate\",\"submittingForm\",\"duplicatedElements\",\"preview\",\"previewToken\",\"previewTargets\",\"enablePreview\",\"$shareBtn\",\"openShareLink\",\"createShareMenu\",\"revisionId\",\"serializeForm\",\"draftId\",\"initForDraft\",\"createDraft\",\"canUpdateSource\",\"createEditMetaBtn\",\"statusIcons\",\"showStatusHud\",\"bodyHtml\",\"spinners\",\"getPreviewToken\",\"Promise\",\"resolve\",\"reject\",\"sourceId\",\"getTokenizedPreviewUrl\",\"randoParam\",\"isLive\",\"then\",\"catch\",\"open\",\"getPreview\",\"Preview\",\"openPreview\",\"ensureIsDraftOrRevision\",\"revisionid\",\"removeActionParams\",\"isPreviewActive\",\"$editor\",\"isUnsavedDraft\",\"saveDraft\",\"isActive\",\"$spinners\",\"$statusIcons\",\"saveDraftAction\",\"prepareData\",\"docTitle\",\"draftName\",\"draftNotes\",\"revisionMenu\",\"draftCreated\",\"newHref\",\"anchorPos\",\"$saveBtnContainer\",\"elementTypeDisplayName\",\"$saveDraftBtn\",\"canDeleteDraft\",\"$draftsUl\",\"$draftHeading\",\"$draftLi\",\"$draftA\",\"selectOption\",\"$siteOptions\",\"$siteOption\",\"creator\",\"updatePreviewTargets\",\"afterUpdate\",\"checkMetaValues\",\"oldId\",\"currentTargets\",\"showMetaHud\",\"createMetaHud\",\"onMetaHudShow\",\"$field\",\"$hudBody\",\"$deleteLink\",\"saveMeta\",\"onMetaHudHide\",\"onMetaHudEscape\",\"onNotesKeydown\",\"submit\",\"shakeMetaHud\",\"deleteDraft\",\"deleteDraftAction\",\"handleFormSubmit\",\"abort\",\"chunks\",\"accept-charset\",\"enctype\",\"method\",\"decodeURIComponent\",\"applyDraftAction\",\"hashedRedirectUrl\",\"DynamicGenerator\",\"EditableTable\",\"baseName\",\"biggestId\",\"$addRowBtn\",\"rowCount\",\"hasMaxRows\",\"hasMinRows\",\"radioCheckboxes\",\"log\",\"copyDraggeeInputValuesToHelper\",\"isVisible\",\"initialize\",\"minRows\",\"createRowObj\",\"updateAddRowButton\",\"initializeIfVisible\",\"canAddRow\",\"canDeleteRow\",\"deleteRow\",\"$tr\",\"onDeleteRow\",\"staticRows\",\"maxRows\",\"focus\",\"rowId\",\"rowIdPrefix\",\"createRow\",\"defaultValues\",\"onAddRow\",\"Row\",\"focusOnPrevRow\",\"tdIndex\",\"blurTd\",\"prevRow\",\"$prevTr\",\"$tds\",\"focusOnNextRow\",\"nextRow\",\"$nextTr\",\"textualColTypes\",\"data-id\",\"colId\",\"$cell\",\"col\",\"scope\",\"textual\",\"code\",\"small\",\"createDateInput\",\"createLightswitch\",\"createSelect\",\"default\",\"createTimeInput\",\"createTextInput\",\"niceTexts\",\"tds\",\"$textareas\",\"tr\",\"td\",\"$textarea\",\"$checkbox\",\"textareasByColId\",\"onHeightChange\",\"radioMode\",\"applyToggleCheckbox\",\"onTextareaHeightChange\",\"autopopulate\",\"HandleGenerator\",\"allowNonAlphaStart\",\"last\",\"onTextareaFocus\",\"onRadioCheckboxChange\",\"checkbox\",\"checkboxColId\",\"neg\",\"checkboxCol\",\"colum\",\"ignoreNextTextareaFocus\",\"handleKeypress\",\"charCode\",\"ctrl\",\"numericKeyCodes\",\"validateValue\",\"safeValue\",\"tallestTextareaHeight\",\"tdHeight\",\"ElementActionTrigger\",\"maxLevels\",\"newChildUrl\",\"$trigger\",\"triggerEnabled\",\"activate\",\"updateTrigger\",\"validateSelection\",\"enableTrigger\",\"disableTrigger\",\"valid\",\"batch\",\"handleTriggerActivation\",\"queue\",\"workers\",\"Worker\",\"concat\",\"toArray\",\"active\",\"loadNext\",\"loader\",\"$img\",\"alt\",\"ElevatedSessionForm\",\"inputs\",\"form\",\"$inputs\",\"getInputPostVal\",\"elevatedSessionManager\",\"fetchingTimeout\",\"inputsChanged\",\"$currentInput\",\"requireElevatedSession\",\"submitForm\",\"ElevatedSessionManager\",\"passwordModal\",\"$submitBtn\",\"$errorPara\",\"minSafeElevatedSessionTimeout\",\"showPasswordModal\",\"$passwordModal\",\"focusPasswordInput\",\"submitPassword\",\"currentPassword\",\"showPasswordError\",\"EntryIndex\",\"publishableSections\",\"$newEntryBtnGroup\",\"$newEntryBtn\",\"section\",\"defaultSectionHandle\",\"selectedSection\",\"_getSectionTriggerHref\",\"_openCreateEntryModal\",\"site\",\"sectionId\",\"newEntryBtnText\",\"typeId\",\"entryTypes\",\"sectionSourceKey\",\"FieldLayoutDesigner\",\"$tabContainer\",\"$unusedFieldContainer\",\"$newTabBtn\",\"$allFields\",\"tabGrid\",\"unusedFieldGrid\",\"tabDrag\",\"fieldDrag\",\"gridSettings\",\"initTab\",\"FieldDrag\",\"customizableTabs\",\"TabDrag\",\"$editBtn\",\"$fields\",\"initField\",\"onTabOptionSelect\",\"renameTab\",\"deleteTab\",\"onFieldOptionSelect\",\"toggleRequiredField\",\"removeField\",\"$labelSpan\",\"getFieldInputName\",\"removeFieldById\",\"requiredFieldInputName\",\"refreshCols\",\"$group\",\"addTab\",\"tabName\",\"fieldInputName\",\"BaseDrag\",\"Drag\",\"designer\",\"$insertion\",\"showingInsertion\",\"$caboose\",\"draggingUnusedItem\",\"addToTabGrid\",\"getInsertion\",\"addCaboose\",\"setMidpoints\",\"getItemContainer\",\"isItemInTabContainer\",\"onDrag\",\"hitTest\",\"_closestItem\",\"getClosestItem\",\"_closestItemMouseDiff\",\"_$item\",\"_midpoint\",\"_mouseDiff\",\"getDist\",\"draggeeDisplay\",\"visibility\",\"$hiddenFields\",\"$fieldContainers\",\"targetPrefix\",\"targetSelector\",\"reverseTargetSelector\",\"_$target\",\"_$reverseTarget\",\"getType\",\"normalizeTargetSelector\",\"findTargets\",\"selector\",\"getToggleVal\",\"postVal\",\"onToggleChange\",\"hideTarget\",\"showTarget\",\"_show\",\"_currentHeight\",\"_targetHeight\",\"overflow\",\"items\",\"totalCols\",\"colGutterDrop\",\"colPctWidth\",\"possibleItemColspans\",\"possibleItemPositionsByColspan\",\"itemPositions\",\"itemColspansByPosition\",\"layouts\",\"layout\",\"itemHeights\",\"leftPadding\",\"_refreshingCols\",\"_refreshColsAfterRefresh\",\"_forceRefreshColsAfterRefresh\",\"handleContainerHeightProxy\",\"setItems\",\"_\",\"oldHeight\",\"scrollHeight\",\"gutter\",\"itemIndex\",\"tallestItemHeight\",\"colIndex\",\"itemHeight\",\"remainder\",\"itemHeightsByColspan\",\"positionRight\",\"positionLeft\",\"minColspan\",\"maxColspan\",\"colspan\",\"getItemWidthCss\",\"minPosition\",\"maxPosition\",\"colHeights\",\"createLayouts\",\"layoutTotalCols\",\"highestTotalCols\",\"layoutHeights\",\"shortestHeight\",\"shortestLayouts\",\"emptySpaces\",\"emptySpace\",\"colspans\",\"getItemLeftPosCss\",\"positions\",\"isSimpleLayout\",\"margin-bottom\",\"positionItems\",\"completeRefreshCols\",\"onRefreshCols\",\"getItemWidth\",\"getItemWidthInPx\",\"getItemLeftPosInPx\",\"prevPositions\",\"prevColspans\",\"prevColHeights\",\"prevEmptySpace\",\"LayoutGenerator\",\"endingCol\",\"affectedColHeights\",\"onItemResize\",\"newHeight\",\"tallestColHeightsByPosition\",\"p\",\"colHeightsForPosition\",\"tallestColHeight\",\"words\",\"ImageUpload\",\"initImageUpload\",\"containerSelector\",\"uploadAction\",\"postParameters\",\"fileInputSelector\",\"paramName\",\"uploadParamName\",\"fileuploadfail\",\"initButtons\",\"uploadButtonSelector\",\"deleteButtonSelector\",\"refreshImage\",\"onAfterRefreshImage\",\"_onUploadError\",\"$icon\",\"hudClass\",\"dragger\",\"dragStartMargin\",\"outerContainer\",\"X_AXIS\",\"turnOn\",\"turnOff\",\"_getOffMargin\",\"_onMouseDown\",\"_onMouseUp\",\"dragging\",\"RIGHT_KEY\",\"LEFT_KEY\",\"_getMargin\",\"_onDrag\",\"mouseDistX\",\"_onDragStop\",\"_onSettle\",\"LivePreview\",\"$extraFields\",\"$dragHandle\",\"$iframeContainer\",\"$iframe\",\"$fieldPlaceholder\",\"previewUrl\",\"basePostData\",\"fields\",\"lastPostData\",\"updateIframeInterval\",\"loading\",\"checkAgain\",\"dragStartEditorWidth\",\"_slideInOnIframeLoad\",\"_handleSuccessProxy\",\"_handleErrorProxy\",\"_forceUpdateIframeProxy\",\"_scrollX\",\"_scrollY\",\"_editorWidth\",\"_editorWidthInPx\",\"protocol\",\"previewParams\",\"extraFields\",\"defaultEditorWidth\",\"moveFieldsBack\",\"editorWidthInPx\",\"inPx\",\"minEditorWidthInPx\",\"exit\",\"$editorHeader\",\"$closeBtn\",\"handleWindowResize\",\"dragHandleWidth\",\"getIframeWidth\",\"$clone\",\"_getClone\",\"updateIframe\",\"slideIn\",\"createToken\",\"previewAction\",\"updateWidths\",\"ESC_KEY\",\"$newClone\",\"field\",\"contentWindow\",\"scrollLeft\",\"X-Craft-Token\",\"xhrFields\",\"withCredentials\",\"crossDomain\",\"forceUpdateIframe\",\"handleSuccess\",\"write\",\"close\",\"onResponse\",\"handleError\",\"copyInputValues\",\"$textInput\",\"$showPasswordToggle\",\"showingPassword\",\"passwordInput\",\"hidePassword\",\"setCurrentInput\",\"updateToggleLabel\",\"showPassword\",\"togglePassword\",\"onKeyDown\",\"ALT_KEY\",\"onKeyUp\",\"onInputChange\",\"onToggleMouseDown\",\"$previewContainer\",\"$targetBtn\",\"$targetMenu\",\"$tempInput\",\"activeTarget\",\"_updateIframeProxy\",\"$previewHeader\",\"switchTarget\",\"resetScroll\",\"sameHost\",\"scrolllTop\",\"frameborder\",\"afterUpdateIframe\",\"defaultSettings\",\"_onHide\",\"instance\",\"loadAsset\",\"focusItem\",\"desiredHeight\",\"desiredWidth\",\"containerHeight\",\"containerWidth\",\"minGutter\",\"_resizeContainer\",\"modalHtml\",\"$highlight\",\"Prism\",\"highlightElement\",\"maxWidth\",\"maxHeight\",\"max-width\",\"$progressBarStatus\",\"_itemCount\",\"_processedItemCount\",\"_displaySteps\",\"displaySteps\",\"setProcessedItemCount\",\"fadeTo\",\"incrementItemCount\",\"percentage\",\"$modalContainerDiv\",\"$prompt\",\"$promptApplyToRemainingContainer\",\"$promptApplyToRemainingCheckbox\",\"$promptApplyToRemainingLabel\",\"$pomptChoices\",\"_prompts\",\"_promptBatchCallback\",\"_promptBatchReturnData\",\"_promptBatchNum\",\"_showNextPromptInBatch\",\"remainingInBatch\",\"_showPrompt\",\"_handleBatchPromptSelection\",\"applyToRemaining\",\"choiceData\",\"itemsToGo\",\"_promptCallback\",\"$promptMessage\",\"$promptChoices\",\"$promptButtons\",\"$cancelButton\",\"$radioButton\",\"_selectPromptChoice\",\"fadeOut\",\"_cancelPrompt\",\"$selectedOption\",\"startPositionX\",\"graduationsMin\",\"graduationsMax\",\"slideMin\",\"slideMax\",\"$overlay\",\"$cursor\",\"$graduations\",\"$graduationsUl\",\"graduationsCalculatedWidth\",\"_handleResize\",\"valueToPosition\",\"_handleTapStart\",\"touch\",\"startLeft\",\"_handleTapMove\",\"curX\",\"positionToValue\",\"_handleTapEnd\",\"scaleMin\",\"scaleMax\",\"SlugGenerator\",\"allowUppercaseInSlug\",\"limitAutoSlugsToAscii\",\"XRegExp\",\"matchChain\",\"slugWordSeparator\",\"Structure\",\"structureDrag\",\"$parents\",\"initToggle\",\"StructureDrag\",\"initNewChildMenus\",\"viewStateKey\",\"$addBtns\",\"onNewChildMenuClick\",\"showMenu\",\"getIndent\",\"level\",\"baseIndent\",\"nestedIndent\",\"addElement\",\"$addBtn\",\"$parentUl\",\"_removeUl\",\"structure\",\"draggeeLevel\",\"$helperLi\",\"$targets\",\"draggeeHeight\",\"$level\",\"cancelDrag\",\"$lis\",\"$closestTarget\",\"closestTargetPos\",\"closestTargetYDiff\",\"closestTargetOffset\",\"closestTargetHeight\",\"targetOffset\",\"targetHeight\",\"targetYMidpoint\",\"targetYDiff\",\"$closestTargetLi\",\"closestTargetLevel\",\"$nextTargetLi\",\"nextTargetLevel\",\"hoveringBetweenRows\",\"draggeeX\",\"targetItemMouseDiffX\",\"$parentLis\",\"$closestParentLi\",\"closestParentLiXDiff\",\"closestParentLevel\",\"$parentLi\",\"parentLiX\",\"parentLiXDiff\",\"parentLevel\",\"onMouseUp\",\"$draggeeParent\",\"moved\",\"$closestSiblings\",\"newLevel\",\"setLevel\",\"structureId\",\"prevId\",\"indent\",\"$childLis\",\"StructureTableSorter\",\"tableView\",\"_helperMargin\",\"_$titleHelperCell\",\"_titleHelperCellOuterWidth\",\"_ancestors\",\"_updateAncestorsFrame\",\"_updateAncestorsProxy\",\"_draggeeLevel\",\"_draggeeLevelDelta\",\"draggingLastElements\",\"_loadingDraggeeLevelDelta\",\"_targetLevel\",\"_targetLevelBounds\",\"_positionChanged\",\"singleHelper\",\"helperSpacingY\",\"startDragging\",\"HELPER_MARGIN\",\"findDraggee\",\"$nextRow\",\"nextRowLevel\",\"nextRowLevelDelta\",\"_getAjaxBaseData\",\"delta\",\"drag\",\"padding\",\"BASE_PADDING\",\"canInsertBefore\",\"_getLevelBounds\",\"canInsertAfter\",\"_getAncestors\",\"_setTargetLevelBounds\",\"_updateIndent\",\"onInsertionPointChange\",\"_updateAncestorsBeforeRepaint\",\"levelDiff\",\"_getLevelIndent\",\"$prevRow\",\"prevRowLevel\",\"$spinnerRow\",\"_createSpinnerRowAfter\",\"onPositionChange\",\"_expandElement\",\"onReturnHelpersToDraggees\",\"newDraggeeIndexes\",\"oldDraggeeIndexes\",\"$postDraggeeItems\",\"_minLevel\",\"_maxLevel\",\"forcePositionChange\",\"_mouseDist\",\"realMouseX\",\"mousedownX\",\"_indentationDist\",\"LEVEL_INDENT\",\"_targetLevelMouseDiff\",\"_magnetImpact\",\"MAX_GIVE\",\"_closestLevelMagnetIndent\",\"helpers\",\"targetLevel\",\"_level\",\"_$prevRow\",\"cancelAnimationFrame\",\"_updateAncestors\",\"_$ancestor\",\"_newAncestors\",\"$selectedSortHeader\",\"structureTableSort\",\"_totalVisiblePostStructureTableDraggee\",\"_morePendingPostStructureTableDraggee\",\"initTableHeaders\",\"_collapseElement\",\"selectedSortAttr\",\"$tableHeaders\",\"selectedSortDir\",\"_isStructureTableDraggingLastElements\",\"positionedAfter\",\"includeTableAttributesForSource\",\"_updateTableAttributes\",\"$nextNextRow\",\"descendantOf\",\"$nextRows\",\"_handleSelectedSortHeaderClick\",\"newSortDir\",\"_handleSortHeaderClick\",\"_handleUnselectedSortHeaderClick\",\"TagSelectInput\",\"searchMenu\",\"$addTagInput\",\"_ignoreBlur\",\"selectTag\",\"searchForTags\",\"killSearchMenu\",\"excludeIds\",\"tagGroupId\",\"tags\",\"exclude\",\"exactMatch\",\"Menu\",\"attachToElement\",\"data-site-id\",\"targetSiteId\",\"data-label\",\"data-editable\",\"$titleContainer\",\"config\",\"maxlength\",\"autofocus\",\"getAutofocusValue\",\"autocomplete\",\"getDisabledValue\",\"readonly\",\"step\",\"showCharsLeft\",\"createTextarea\",\"createTextareaField\",\"$select\",\"data-target-prefix\",\"$optgroup\",\"optgroup\",\"optionLabel\",\"optionValue\",\"optionDisabled\",\"selected\",\"createSelectField\",\"data-target\",\"data-reverse-target\",\"reverseToggle\",\"for\",\"createCheckboxField\",\"createCheckboxSelect\",\"allValue\",\"allChecked\",\"showAllOption\",\"allLabel\",\"createCheckboxSelectField\",\"data-value\",\"aria-labelledby\",\"labelId\",\"createLightswitchField\",\"containerId\",\"$colorPreviewContainer\",\"createColorField\",\"getMonth\",\"formattedValue\",\"timezone\",\"defaultDate\",\"createDateField\",\"timepicker\",\"timepickerOptions\",\"getHours\",\"getMinutes\",\"getSeconds\",\"createTimeField\",\"required\",\"warning\",\"addErrorsToField\",\"addErrorsToList\",\"$errors\",\"clearErrorsFromField\",\"_rejectedFiles\",\"_extensionList\",\"_totalFileCounter\",\"_validFileCounter\",\"autoUpload\",\"fileupload\",\"paramObject\",\"getInProgress\",\"onFileAdd\",\"validateExtension\",\"_createExtensionList\",\"process\",\"done\",\"pass\",\"fileExtension\",\"maxFileSize\",\"originalFiles\",\"processErrorMessages\",\"kinds\",\"humanFileSize\",\"maxUploadSize\",\"bytes\",\"u\",\"toFixed\",\"allowedKind\",\"fileKinds\",\"extensions\",\"pasteZone\",\"sequentialUploads\",\"Accept\",\"UriFormatGenerator\",\"uriFormat\",\"suffix\",\"jQuery\"],\"mappings\":\"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\",\"file\":\"Craft.min.js\"}", "/** global: Craft */\n/** global: Garnish */\n/**\n * Admin table class\n */\nCraft.AdminTable = Garnish.Base.extend(\n    {\n        settings: null,\n        totalItems: null,\n        sorter: null,\n\n        $noItems: null,\n        $table: null,\n        $tbody: null,\n        $deleteBtns: null,\n\n        init: function(settings) {\n            this.setSettings(settings, Craft.AdminTable.defaults);\n\n            if (!this.settings.allowDeleteAll) {\n                this.settings.minItems = 1;\n            }\n\n            this.$noItems = $(this.settings.noItemsSelector);\n            this.$table = $(this.settings.tableSelector);\n            this.$tbody = this.$table.children('tbody');\n            this.totalItems = this.$tbody.children().length;\n\n            if (this.settings.sortable) {\n                this.sorter = new Craft.DataTableSorter(this.$table, {\n                    onSortChange: $.proxy(this, 'reorderItems')\n                });\n            }\n\n            this.$deleteBtns = this.$table.find('.delete:not(.disabled)');\n            this.addListener(this.$deleteBtns, 'click', 'handleDeleteBtnClick');\n\n            this.updateUI();\n        },\n\n        addRow: function(row) {\n            if (this.settings.maxItems && this.totalItems >= this.settings.maxItems) {\n                // Sorry pal.\n                return;\n            }\n\n            var $row = $(row).appendTo(this.$tbody),\n                $deleteBtn = $row.find('.delete');\n\n            if (this.settings.sortable) {\n                this.sorter.addItems($row);\n            }\n\n            this.$deleteBtns = this.$deleteBtns.add($deleteBtn);\n\n            this.addListener($deleteBtn, 'click', 'handleDeleteBtnClick');\n            this.totalItems++;\n\n            this.updateUI();\n        },\n\n        reorderItems: function() {\n            if (!this.settings.sortable) {\n                return;\n            }\n\n            // Get the new field order\n            var ids = [];\n\n            for (var i = 0; i < this.sorter.$items.length; i++) {\n                var id = $(this.sorter.$items[i]).attr(this.settings.idAttribute);\n                ids.push(id);\n            }\n\n            // Send it to the server\n            var data = {\n                ids: JSON.stringify(ids)\n            };\n\n            Craft.postActionRequest(this.settings.reorderAction, data, $.proxy(function(response, textStatus) {\n                if (textStatus === 'success') {\n                    if (response.success) {\n                        this.onReorderItems(ids);\n                        Craft.cp.displayNotice(Craft.t('app', this.settings.reorderSuccessMessage));\n                    }\n                    else {\n                        Craft.cp.displayError(Craft.t('app', this.settings.reorderFailMessage));\n                    }\n                }\n\n            }, this));\n        },\n\n        handleDeleteBtnClick: function(event) {\n            if (this.settings.minItems && this.totalItems <= this.settings.minItems) {\n                // Sorry pal.\n                return;\n            }\n\n            var $row = $(event.target).closest('tr');\n\n            if (this.confirmDeleteItem($row)) {\n                this.deleteItem($row);\n            }\n        },\n\n        confirmDeleteItem: function($row) {\n            var name = this.getItemName($row);\n            return confirm(Craft.t('app', this.settings.confirmDeleteMessage, {name: name}));\n        },\n\n        deleteItem: function($row) {\n            var data = {\n                id: this.getItemId($row)\n            };\n\n            Craft.postActionRequest(this.settings.deleteAction, data, $.proxy(function(response, textStatus) {\n                if (textStatus === 'success') {\n                    this.handleDeleteItemResponse(response, $row);\n                }\n            }, this));\n        },\n\n        handleDeleteItemResponse: function(response, $row) {\n            var id = this.getItemId($row),\n                name = this.getItemName($row);\n\n            if (response.success) {\n                if (this.sorter) {\n                    this.sorter.removeItems($row);\n                }\n\n                $row.remove();\n                this.totalItems--;\n                this.updateUI();\n                this.onDeleteItem(id);\n\n                Craft.cp.displayNotice(Craft.t('app', this.settings.deleteSuccessMessage, {name: Craft.escapeHtml(name)}));\n            }\n            else {\n                Craft.cp.displayError(Craft.t('app', this.settings.deleteFailMessage, {name: Craft.escapeHtml(name)}));\n            }\n        },\n\n        onReorderItems: function(ids) {\n            this.settings.onReorderItems(ids);\n        },\n\n        onDeleteItem: function(id) {\n            this.settings.onDeleteItem(id);\n        },\n\n        getItemId: function($row) {\n            return $row.attr(this.settings.idAttribute);\n        },\n\n        getItemName: function($row) {\n            return $row.attr(this.settings.nameAttribute);\n        },\n\n        updateUI: function() {\n            // Show the \"No Whatever Exists\" message if there aren't any\n            if (this.totalItems === 0) {\n                this.$table.hide();\n                this.$noItems.removeClass('hidden');\n            }\n            else {\n                this.$table.show();\n                this.$noItems.addClass('hidden');\n            }\n\n            // Disable the sort buttons if there's only one row\n            if (this.settings.sortable) {\n                var $moveButtons = this.$table.find('.move');\n\n                if (this.totalItems === 1) {\n                    $moveButtons.addClass('disabled');\n                }\n                else {\n                    $moveButtons.removeClass('disabled');\n                }\n            }\n\n            // Disable the delete buttons if we've reached the minimum items\n            if (this.settings.minItems && this.totalItems <= this.settings.minItems) {\n                this.$deleteBtns.addClass('disabled');\n            }\n            else {\n                this.$deleteBtns.removeClass('disabled');\n            }\n\n            // Hide the New Whatever button if we've reached the maximum items\n            if (this.settings.newItemBtnSelector) {\n                if (this.settings.maxItems && this.totalItems >= this.settings.maxItems) {\n                    $(this.settings.newItemBtnSelector).addClass('hidden');\n                }\n                else {\n                    $(this.settings.newItemBtnSelector).removeClass('hidden');\n                }\n            }\n        }\n    },\n    {\n        defaults: {\n            tableSelector: null,\n            noItemsSelector: null,\n            newItemBtnSelector: null,\n            idAttribute: 'data-id',\n            nameAttribute: 'data-name',\n            sortable: false,\n            allowDeleteAll: true,\n            minItems: 0,\n            maxItems: null,\n            reorderAction: null,\n            deleteAction: null,\n            reorderSuccessMessage: Craft.t('app', 'New order saved.'),\n            reorderFailMessage: Craft.t('app', 'Couldn\u2019t save new order.'),\n            confirmDeleteMessage: Craft.t('app', 'Are you sure you want to delete \u201c{name}\u201d?'),\n            deleteSuccessMessage: Craft.t('app', '\u201c{name}\u201d deleted.'),\n            deleteFailMessage: Craft.t('app', 'Couldn\u2019t delete \u201c{name}\u201d.'),\n            onReorderItems: $.noop,\n            onDeleteItem: $.noop\n        }\n    });\n"], "fixing_code": ["# Release Notes for Craft CMS 3.x\n\n## Unreleased\n\n### Added\n- Added `craft\\web\\Request::getNormalizedContentType()`.\n\n### Changed\n- Eliminated a `SHOW TABLES` SQL query that was getting executed on every request.\n- Craft no longer routes requests based on `action` params in the request body, if the request\u2019s content type is `application/json`.\n- Updated Twig to 2.12.\n\n### Fixed\n- Fixed a SQL error that could occur when deleting an entry or category with three or more nested levels of elements. ([#3456](https://github.com/craftcms/cms/issues/3456))\n- Fixed a bug where deleting an entry or category with nested elements could leave the structure in a jumbled state.\n- Fixed a PHP error occurred when viewing the PHP Info utility if `register_argc_argv` was set to `On` in `php.ini`. ([#4878](https://github.com/craftcms/cms/issues/4878))\n- Fixed a bug where the `resave/matrix-blocks` command would wittingly resave Matrix blocks even if they hadn\u2019t been loaded with their content, resulting in lost content. ([#5030](https://github.com/craftcms/cms/issues/5030))\n\n### Security\n- Fixed an XSS vulnerability.\n\n## 3.3.7 - 2019-10-03\n\n### Changed\n- When saving a user, email validation errors are now copied over to the `email` attribute from the `unverifiedEmail` attribute. ([#5019](https://github.com/craftcms/cms/issues/5019))\n- `craft\\web\\View::renderString()` and `renderObjectTemplate()` now have `$templateMode` arguments. ([#5020](https://github.com/craftcms/cms/issues/5020))\n\n### Fixed\n- Fixed a bug where the Edit User page would list a \u201cCopy activation URL\u201d action for publicly-registered users who already had a password set.\n- Fixed a bug where the list and structure icons were missing on element index pages for RTL languages. ([#5018](https://github.com/craftcms/cms/issues/5018))\n- Fixed a bug where the `prevSiblingOf` and `nextSiblingOf` element query params weren\u2019t working reliably. ([#4997](https://github.com/craftcms/cms/issues/4997))\n- Fixed a bug where the `descendantOf` element query param wasn\u2019t working when previewing a draft or revision. ([#5021](https://github.com/craftcms/cms/issues/5021))\n- Fixed a PHP error that occurred when saving a Dropdown or Multi-select field with optgroups. ([#5014](https://github.com/craftcms/cms/issues/5014))\n- Fixed a bug where relational fields that were managing relations on a per-site basis would forget other sites\u2019 relations when duplicated. ([#5038](https://github.com/craftcms/cms/issues/5038))\n\n## 3.3.6 - 2019-09-27\n\n### Added\n- Added `craft\\base\\ElementInterface::getIsHomepage()`. ([#4993](https://github.com/craftcms/cms/issues/4993))\n- Added `craft\\base\\Element::HOMEPAGE_URI`.\n\n### Changed\n- Updated Garnish to 0.1.31.\n\n### Fixed\n- Fixed a bug where some HTML in the Control Panel was getting improperly encoded. ([#5002](https://github.com/craftcms/cms/issues/5002))\n- Fixed a bug where `craft\\helper\\UrlHelper` wasn\u2019t encoding `+` and `&` characters in query param values.\n- Fixed an error where GraphQL would sometimes not return a proper error message. ([#4999](https://github.com/craftcms/cms/issues/4999))\n- Fixed a bug where HUDs could be positioned incorrectly when first opened. ([#5004](https://github.com/craftcms/cms/issues/5004))\n- Fixed a bug where HUD tip images could be pointing the wrong way for RTL languages.\n\n## 3.3.5 - 2019-09-25\n\n### Added\n- The Control Panel is now translated into Persian. ([#4969](https://github.com/craftcms/cms/pull/4969))\n- Added `craft\\test\\fixtures\\elements\\ElementFixture::$unload`.\n\n### Changed\n- All users with permission to register users can now choose to not have an activation email sent immediately, when registering a new user. ([#4981](https://github.com/craftcms/cms/pull/4981))\n- Craft now shows validation errors when attempting to save a Dropdown, Radio Buttons, Checkboxes, or Multi-select field with duplicate option labels or values. ([#4983](https://github.com/craftcms/cms/issues/4983))\n- Live Preview requests now have an `x-craft-live-preview` query string param, rather than `x-craft-preview`. ([#4950](https://github.com/craftcms/cms/issues/4950))\n- The `_includes/pagination.html` template can now be passed `itemLabel` and `itemsLabel` variables.\n- Any migrations applied during testing are now recorded as content migrations.\n- Added the option to automatically apply all content migrations when setting up the test environment. ([#4904](https://github.com/craftcms/cms/issues/4904))\n- `craft\\helpers\\Html::parseTagAttributes()` now has a `$decode` argument.\n- `craft\\test\\fixtures\\elements\\GlobalSetFixture` now has the option to load the active record instance. ([#4947](https://github.com/craftcms/cms/pull/4947))\n\n### Fixed\n- Fixed a bug where checkbox inputs were positioned incorrectly for RTL languages.\n- Fixed a bug where the updater and `project.yaml` sync pages weren\u2019t always handling error responses correctly. ([#4988](https://github.com/craftcms/cms/issues/4988))\n- Fixed an error that could occur when syncing the project config, if a volume was being deleted that didn\u2019t exist in the database to begin with. ([#4990](https://github.com/craftcms/cms/pull/4990))\n- Fixed an error that could occur if a project config value changed from scalar to an array. ([#4932](https://github.com/craftcms/cms/issues/4932))\n- Fixed a bug where Craft would not recognize certain block types when using the GraphQL API. ([#4961](https://github.com/craftcms/cms/issues/4961))\n- Fixed a bug where `craft\\helpers\\Html::renderTagAttributes()` was double-encoding preexisting attributes. ([#4984](https://github.com/craftcms/cms/issues/4984))\n\n## 3.3.4.1 - 2019-09-17\n\n### Fixed\n- Fixed a bug where elements with enabled Lightswitch fields weren\u2019t getting returned in element queries. ([#4951](https://github.com/craftcms/cms/issues/4951))\n\n## 3.3.4 - 2019-09-17\n\n### Changed\n- It\u2019s now possible to run the `migrate/create install` command for uninstalled plugins.\n- Improved the button labels in the confirmation dialog that can appear after running the Asset Indexes utility. ([#4943](https://github.com/craftcms/cms/issues/4943))\n\n### Fixed\n- Fixed a bug where asset queries\u2019 `withTransforms` param wasn\u2019t working for eager-loaded assets. ([#4931](https://github.com/craftcms/cms/issues/4931))\n- Fixed a bug where the \u201cEdit Image\u201d asset action could be missing even if the user had the required permissions. ([#3349](https://github.com/craftcms/cms/issues/3349))\n- Fixed a bug where querying for elements by their Lightswitch field value could only return elements that had been saved since the Lightswitch field was added. ([#4939](https://github.com/craftcms/cms/issues/4939))\n- Fixed a bug where the Updates utility wasn\u2019t showing the \u201cUpdate all\u201d button when multiple updates were available. ([#4938](https://github.com/craftcms/cms/issues/4938))\n- Fixed a bug where the \u201cUpdating search indexes\u201d job could fail when updating search indexes for a Matrix block that contained a relational field.\n- Fixed a bug where category groups\u2019 site settings weren\u2019t being added to the project config when a new site was created.\n- Fixed a bug where the Translation Method setting wasn\u2019t immediately shown for Matrix sub-fields, if the field type was changed from one that didn\u2019t have multiple translation methods to one that does. ([#4949](https://github.com/craftcms/cms/issues/4949))\n- Fixed a bug where it wasn\u2019t possible to query for entries by author ID using the GraphQL API.\n- Fixed a bug where it wasn\u2019t possible to query for Matrix blocks directly using the GraphQL API.\n\n## 3.3.3 - 2019-09-12\n\n### Changed\n- The GraphQL API now prebuilds the schema for all introspection queries, regardless of whether Dev Mode is enabled.\n\n### Fixed\n- Fixed a bug where Craft was ignoring the `invalidUserTokenPath` request when it was set to an empty string. ([#1998](https://github.com/craftcms/cms/issues/1998))\n- Fixed a bug where the `invalidUserTokenPath` was affecting Control Panel requests.\n- Fixed a bug where revisions weren\u2019t being sorted correctly in Structure sections.\n- Fixed a bug where Edit Entry pages weren\u2019t working with certain versions of PHP if the user\u2019s preferred language was set to French. ([#4930](https://github.com/craftcms/cms/issues/4930))\n\n## 3.3.2 - 2019-09-11\n\n### Added\n- Added the `graphql/dump-schema` and `graphql/print-schema` commands. ([#4834](https://github.com/craftcms/cms/pull/4834))\n- It\u2019s now possible to access a `parent` field on entries and categories when querying the GraphQL API. ([#4880](https://github.com/craftcms/cms/issues/4880))\n- It\u2019s now possible to apply transforms to assets via `url` field arguments when querying the GraphQL API.\n\n### Changed\n- Craft now resets the `dateCreated` attribute when duplicating elements. ([#4906](https://github.com/craftcms/cms/issues/4906))\n- It\u2019s no longer possible to access the `author` field for entries when querying the GraphQL API, if the schema doesn\u2019t include user data.\n- It\u2019s no longer possible to access the `photo` field for users when querying the GraphQL API, if the schema doesn\u2019t include the user photo volume.\n\n### Fixed\n- Fixed a bug where Lightswitch fields weren\u2019t returning a boolean value for the GraphQL API.\n- Fixed a bug where `craft\\web\\View::renderString()` and `renderObjectTemplate()` could leave Craft set to the `site` template mode if an error occurred when preparing or rendering the template. ([#4912](https://github.com/craftcms/cms/issues/4912))\n- Fixed a bug where the Plugin Store wasn\u2019t applying edition upgrade pricing for plugins if the higher edition was already installed as a trial.\n\n## 3.3.1.2 - 2019-09-08\n\n### Fixed\n- Fixed an error that occurred after saving an element with a validation error. ([#4898](https://github.com/craftcms/cms/issues/4898))\n\n## 3.3.1.1 - 2019-09-06\n\n### Changed\n- `graphql/api` preflight responses now explicitly allow `Authorization` headers. ([#4830](https://github.com/craftcms/cms/issues/4830))\n- Updated Garnish to 0.1.30.\n\n### Fixed\n- Fixed a bug where selecting Matrix blocks would cause the content container to scroll. ([#3762](https://github.com/craftcms/cms/issues/3762))\n- Fixed an error that occurred if Stringy 5.2 was installed.\n\n## 3.3.1 - 2019-09-06\n\n### Added\n- Added support for setting `offset` and `limit` params to individual paths\u2019 criteria when eager-loading elements.\n- Added the `enableGql` config setting. ([#4836](https://github.com/craftcms/cms/issues/4836))\n- Added the `children` field to the `EntryInterface` and `CategoryInterface` GraphQL types. ([#4843](https://github.com/craftcms/cms/issues/4843))\n- Added the `markdown` GraphQL directive. ([#4832](https://github.com/craftcms/cms/issues/4832))\n\n### Changed\n- Preview target URIs can now be set to environment variables (e.g. `$NEWS_INDEX`) or URLs that begin with an alias (e.g. `@rootUrl/news` or `@rootUrl/news/{slug}`).\n- Templates passed to `craft\\web\\View::renderString()` and `renderObjectTemplate()` can now include front-end templates.\n- Element queries with the `revisions` param set will now return revisions ordered by `num DESC` by default. ([#4825](https://github.com/craftcms/cms/issues/4825))\n- `graphql/api` responses now set the `Access-Control-Allow-Headers: Content-Type` header for preflight requests.\n- Craft no longer forces preview target URLs to use `https` if the current request is over SSL. ([#4867](https://github.com/craftcms/cms/issues/4867))\n\n### Removed\n- Removed `craft\\elements\\MatrixBlock::getField()`. ([#4882](https://github.com/craftcms/cms/issues/4882))\n\n### Fixed\n- Fixed a bug where Number fields weren\u2019t showing validation errors when non-numeric values were entered. ([#4849](https://github.com/craftcms/cms/issues/4849))\n- Fixed an error that occurred when accessing the GraphQL section in the Control Panel if the `allowAdminChanges` config setting was disabled. ([#4884](https://github.com/craftcms/cms/issues/4884))\n- Fixed an error that could occur when executing a GraphQL query if a Matrix field had been converted to a different field type. ([#4848](https://github.com/craftcms/cms/issues/4848))\n- Fixed a deprecation warning when running tests in PhpStorm. ([#4772](https://github.com/craftcms/cms/pull/4772))\n- Fixed an SQL error that occurred when eager-loading children for an element that wasn\u2019t in a structure.\n- Fixed a bug that could cause queue jobs to fail when they were run automatically by Craft, if the `enableCsrfProtection` config setting was disabled. ([#4854](https://github.com/craftcms/cms/issues/4854))\n- Fixed an error that could occur if the `select` clause had been completely overridden on an element query, but the `asArray` param wasn\u2019t enabled. ([#4886](https://github.com/craftcms/cms/issues/4886))\n- Fixed a bug where Craft wasn\u2019t always respecting the site-specific status when saving new entries. ([#4892](https://github.com/craftcms/cms/issues/4892))\n\n## 3.3.0.1 - 2019-08-27\n\n### Changed\n- `graphql/api` responses now send CORS headers to allow crossdomain requests. ([#4830](https://github.com/craftcms/cms/issues/4830))\n\n### Fixed\n- Fixed a PHP error that could occur when editing an existing GraphQL schema. ([#4827](https://github.com/craftcms/cms/issues/4827))\n- Fixed a PHP error that could occur when using PostgreSQL. ([#4828](https://github.com/craftcms/cms/issues/4828))\n\n## 3.3.0 - 2019-08-27\n\n### Added\n- Added a built-in, autogenerated GraphQL API for content (Craft Pro only). ([#4540](https://github.com/craftcms/cms/pull/4540)) \n- Added \u201cHeadless Mode\u201d, which optimizes the system and Control Panel for headless CMS implementations.\n- It\u2019s now possible to create Single sections without URLs. ([#3883](https://github.com/craftcms/cms/issues/3883))\n- Added the `hiddenInput()` Twig function, which generates a hidden input tag.\n- Added the `input()` Twig function, which generates an input tag.\n- Added the `tag()` Twig function, which generates an HTML tag.\n- Added the `|attr` Twig filter, which modifies the attributes on an HTML tag. ([#4660](https://github.com/craftcms/cms/issues/4660))\n- Added the `|append` and `|prepend` Twig filters, which add new HTML elements as children of an HTML tag. ([#3937](https://github.com/craftcms/cms/issues/3937))\n- Added the `headlessMode` config setting.\n- Added the `purgeStaleUserSessionDuration` config setting.\n- Admin users can now opt into getting the full stack trace view when an uncaught exception occurs when Dev Mode isn\u2019t enabled. ([#4765](https://github.com/craftcms/cms/issues/4765))\n- Admin users can now opt into having Twig templates profiled when Dev Mode isn\u2019t enabled.\n- Added the `graphql/api` controller action.\n- Added `craft\\base\\ApplicationTrait::getGql()`.\n- Added `craft\\base\\EagerLoadingFieldInterface::getEagerLoadingGqlConditions()`.\n- Added `craft\\base\\ElementInterface::getGqlTypeName()`.\n- Added `craft\\base\\ElementInterface::gqlScopesByContext()`.\n- Added `craft\\base\\ElementInterface::gqlTypeNameByContext()`.\n- Added `craft\\base\\Field::getEagerLoadingGqlConditions()`.\n- Added `craft\\base\\FieldInterface::getContentGqlType()`.\n- Added `craft\\base\\GqlInlineFragmentFieldInterface`.\n- Added `craft\\base\\GqlInlineFragmentInterface`.\n- Added `craft\\controllers\\GraphqlController`.\n- Added `craft\\errors\\GqlException`.\n- Added `craft\\events\\RegisterGqlDirectivesEvent`.\n- Added `craft\\events\\RegisterGqlQueriesEvent`.\n- Added `craft\\events\\RegisterGqlTypesEvent`.\n- Added `craft\\gql\\arguments\\elements\\Asset`.\n- Added `craft\\gql\\arguments\\elements\\Category`.\n- Added `craft\\gql\\arguments\\elements\\Entry`.\n- Added `craft\\gql\\arguments\\elements\\GlobalSet`.\n- Added `craft\\gql\\arguments\\elements\\MatrixBlock`.\n- Added `craft\\gql\\arguments\\elements\\Tag`.\n- Added `craft\\gql\\arguments\\elements\\User`.\n- Added `craft\\gql\\base\\Arguments`.\n- Added `craft\\gql\\base\\Directive`.\n- Added `craft\\gql\\base\\ElementArguments`.\n- Added `craft\\gql\\base\\ElementResolver`.\n- Added `craft\\gql\\base\\GeneratorInterface`.\n- Added `craft\\gql\\base\\GqlTypeTrait`.\n- Added `craft\\gql\\base\\InterfaceType`.\n- Added `craft\\gql\\base\\ObjectType`.\n- Added `craft\\gql\\base\\Query`.\n- Added `craft\\gql\\base\\Resolver`.\n- Added `craft\\gql\\base\\StructureElementArguments`.\n- Added `craft\\gql\\directives\\FormatDateTime`.\n- Added `craft\\gql\\directives\\Transform`.\n- Added `craft\\gql\\GqlEntityRegistry`.\n- Added `craft\\gql\\interfaces\\Element`.\n- Added `craft\\gql\\interfaces\\elements\\Asset`.\n- Added `craft\\gql\\interfaces\\elements\\Category`.\n- Added `craft\\gql\\interfaces\\elements\\Entry`.\n- Added `craft\\gql\\interfaces\\elements\\GlobalSet`.\n- Added `craft\\gql\\interfaces\\elements\\MatrixBlock`.\n- Added `craft\\gql\\interfaces\\elements\\Tag`.\n- Added `craft\\gql\\interfaces\\elements\\User`.\n- Added `craft\\gql\\interfaces\\Structure`.\n- Added `craft\\gql\\queries\\Asset`.\n- Added `craft\\gql\\queries\\Category`.\n- Added `craft\\gql\\queries\\Entry`.\n- Added `craft\\gql\\queries\\GlobalSet`.\n- Added `craft\\gql\\queries\\Ping`.\n- Added `craft\\gql\\queries\\Tag`.\n- Added `craft\\gql\\queries\\User`.\n- Added `craft\\gql\\resolvers\\elements\\Asset`.\n- Added `craft\\gql\\resolvers\\elements\\Category`.\n- Added `craft\\gql\\resolvers\\elements\\Entry`.\n- Added `craft\\gql\\resolvers\\elements\\GlobalSet`.\n- Added `craft\\gql\\resolvers\\elements\\MatrixBlock`.\n- Added `craft\\gql\\resolvers\\elements\\Tag`.\n- Added `craft\\gql\\resolvers\\elements\\User`.\n- Added `craft\\gql\\TypeLoader`.\n- Added `craft\\gql\\types\\DateTime`.\n- Added `craft\\gql\\types\\elements\\Asset`.\n- Added `craft\\gql\\types\\elements\\Category`.\n- Added `craft\\gql\\types\\elements\\Element`.\n- Added `craft\\gql\\types\\elements\\Entry`.\n- Added `craft\\gql\\types\\elements\\GlobalSet`.\n- Added `craft\\gql\\types\\elements\\MatrixBlock`.\n- Added `craft\\gql\\types\\elements\\Tag`.\n- Added `craft\\gql\\types\\elements\\User`.\n- Added `craft\\gql\\types\\generators\\AssetType`.\n- Added `craft\\gql\\types\\generators\\CategoryType`.\n- Added `craft\\gql\\types\\generators\\ElementType`.\n- Added `craft\\gql\\types\\generators\\EntryType`.\n- Added `craft\\gql\\types\\generators\\GlobalSetType`.\n- Added `craft\\gql\\types\\generators\\MatrixBlockType`.\n- Added `craft\\gql\\types\\generators\\TableRowType`.\n- Added `craft\\gql\\types\\generators\\TagType`.\n- Added `craft\\gql\\types\\generators\\UserType`.\n- Added `craft\\gql\\types\\Query`.\n- Added `craft\\gql\\types\\TableRow`.\n- Added `craft\\helpers\\App::webResponseConfig()`.\n- Added `craft\\helpers\\ArrayHelper::whereMultiple()`.\n- Added `craft\\helpers\\ElementHelper::sourceElement()`.\n- Added `craft\\helpers\\Gql`.\n- Added `craft\\helpers\\Html::a()`.\n- Added `craft\\helpers\\Html::actionInput()`.\n- Added `craft\\helpers\\Html::appendToTag()`.\n- Added `craft\\helpers\\Html::csrfInput()`.\n- Added `craft\\helpers\\Html::modifyTagAttributes()`.\n- Added `craft\\helpers\\Html::normalizeTagAttributes()`.\n- Added `craft\\helpers\\Html::parseTag()`.\n- Added `craft\\helpers\\Html::parseTagAttributes()`.\n- Added `craft\\helpers\\Html::prependToTag()`.\n- Added `craft\\helpers\\Html::redirectInput()`.\n- Added `craft\\helpers\\StringHelper::afterFirst()`.\n- Added `craft\\helpers\\StringHelper::afterLast()`.\n- Added `craft\\helpers\\StringHelper::append()`.\n- Added `craft\\helpers\\StringHelper::appendRandomString()`.\n- Added `craft\\helpers\\StringHelper::appendUniqueIdentifier()`.\n- Added `craft\\helpers\\StringHelper::at()`.\n- Added `craft\\helpers\\StringHelper::beforeFirst()`.\n- Added `craft\\helpers\\StringHelper::beforeLast()`.\n- Added `craft\\helpers\\StringHelper::capitalizePersonalName()`.\n- Added `craft\\helpers\\StringHelper::count()`.\n- Added `craft\\helpers\\StringHelper::dasherize()`.\n- Added `craft\\helpers\\StringHelper::endsWithAny()`.\n- Added `craft\\helpers\\StringHelper::escape()`.\n- Added `craft\\helpers\\StringHelper::extractText()`.\n- Added `craft\\helpers\\StringHelper::htmlDecode()`.\n- Added `craft\\helpers\\StringHelper::htmlEncode()`.\n- Added `craft\\helpers\\StringHelper::humanize()`.\n- Added `craft\\helpers\\StringHelper::is()`.\n- Added `craft\\helpers\\StringHelper::isBase64()`.\n- Added `craft\\helpers\\StringHelper::isBlank()`.\n- Added `craft\\helpers\\StringHelper::isHexadecimal()`.\n- Added `craft\\helpers\\StringHelper::isHtml()`.\n- Added `craft\\helpers\\StringHelper::isJson()`.\n- Added `craft\\helpers\\StringHelper::isSerialized()`.\n- Added `craft\\helpers\\StringHelper::isUtf8()`.\n- Added `craft\\helpers\\StringHelper::isWhitespace()`.\n- Added `craft\\helpers\\StringHelper::lastSubstringOf()`.\n- Added `craft\\helpers\\StringHelper::lineWrapAfterWord()`.\n- Added `craft\\helpers\\StringHelper::pad()`.\n- Added `craft\\helpers\\StringHelper::padBoth()`.\n- Added `craft\\helpers\\StringHelper::padLeft()`.\n- Added `craft\\helpers\\StringHelper::padRight()`.\n- Added `craft\\helpers\\StringHelper::removeHtml()`.\n- Added `craft\\helpers\\StringHelper::removeHtmlBreak()`.\n- Added `craft\\helpers\\StringHelper::repeat()`.\n- Added `craft\\helpers\\StringHelper::replaceAll()`.\n- Added `craft\\helpers\\StringHelper::replaceBeginning()`.\n- Added `craft\\helpers\\StringHelper::replaceEnding()`.\n- Added `craft\\helpers\\StringHelper::replaceFirst()`.\n- Added `craft\\helpers\\StringHelper::replaceLast()`.\n- Added `craft\\helpers\\StringHelper::safeTruncate()`.\n- Added `craft\\helpers\\StringHelper::shortenAfterWord()`.\n- Added `craft\\helpers\\StringHelper::shuffle()`.\n- Added `craft\\helpers\\StringHelper::slice()`.\n- Added `craft\\helpers\\StringHelper::slugify()`.\n- Added `craft\\helpers\\StringHelper::split()`.\n- Added `craft\\helpers\\StringHelper::startsWithAny()`.\n- Added `craft\\helpers\\StringHelper::stripCssMediaQueries()`.\n- Added `craft\\helpers\\StringHelper::stripEmptyHtmlTags()`.\n- Added `craft\\helpers\\StringHelper::stripHtml()`.\n- Added `craft\\helpers\\StringHelper::stripWhitespace()`.\n- Added `craft\\helpers\\StringHelper::substringOf()`.\n- Added `craft\\helpers\\StringHelper::surround()`.\n- Added `craft\\helpers\\StringHelper::tidy()`.\n- Added `craft\\helpers\\StringHelper::titleizeForHumans()`.\n- Added `craft\\helpers\\StringHelper::toBoolean()`.\n- Added `craft\\helpers\\StringHelper::toSpaces()`.\n- Added `craft\\helpers\\StringHelper::toTabs()`.\n- Added `craft\\helpers\\StringHelper::toTransliterate()`.\n- Added `craft\\helpers\\StringHelper::trimLeft()`.\n- Added `craft\\helpers\\StringHelper::trimRight()`.\n- Added `craft\\helpers\\StringHelper::upperCamelize()`.\n- Added `craft\\helpers\\StringHelper::upperCaseFirst()`.\n- Added `craft\\helpers\\Template::beginProfile()`.\n- Added `craft\\helpers\\Template::endProfile()`.\n- Added `craft\\helpers\\UrlHelper::buildQuery()`.\n- Added `craft\\model\\MatrixBlockType::getField()`.\n- Added `craft\\models\\GqlSchema`.\n- Added `craft\\records\\GqlSchema`.\n- Added `craft\\services\\Fields::getGroupByUid()`.\n- Added `craft\\services\\Gql`.\n- Added `craft\\services\\Matrix::getAllBlockTypes()`.\n- Added `craft\\services\\Sections::getAllEntryTypes()`.\n- Added `craft\\web\\assets\\graphiql\\GraphiqlAsset`.\n- Added `craft\\web\\assets\\graphiql\\VendorAsset`.\n- Added `craft\\web\\twig\\nodes\\ProfileNode`.\n- Added `craft\\web\\twig\\nodevisitors\\Profiler`.\n\n### Changed\n- Relational fields without a specific target site will now only return related elements from the same site as the source element by default, as they did before Craft 3.2. ([#4751](https://github.com/craftcms/cms/issues/4751))\n- Element arrays no longer include `hasDescendants` or `totalDescendants` keys by default. ([#4820](https://github.com/craftcms/cms/issues/4820))\n- Matrix block queries no longer include blocks owned by drafts or revisions by default. ([#4790](https://github.com/craftcms/cms/issues/4790))\n- Entries\u2019 drafts and revisions are now soft-deleted and restored along with their source elements. ([#4797](https://github.com/craftcms/cms/issues/4797))\n- Global set reference tags can now refer to the global set by its handle. ([#4645](https://github.com/craftcms/cms/issues/4645))\n- Improved Twig template profiling to include blocks and macros.\n- Twig template profiling no longer occurs when Dev Mode isn\u2019t enabled, unless an admin user is logged in and has opted into it.\n- The `actionInput()`, `csrfInput()`, and `redirectInput()` Twig functions now support an `options` argument for customizing the HTML tag attributes.\n- The `_layouts/forms/field.html` template now supports `label`, `instructions`, `tip`, `warning`, and `input` blocks that can be overridden when including the template with an `{% embed %}` tag.\n- Editable tables now support a `fullWidth` setting, which can be set to `false` to prevent the table from spanning the full width of the page.\n- Editable tables now support `thin` column settings.\n- Editable tables now support `headingHtml` column settings.\n- Craft no longer overrides the base Twig template class, unless the now-deprecated `suppressTemplateErrors` config setting is enabled. ([#4755](https://github.com/craftcms/cms/issues/4755))\n- Edit Entry pages now get updated preview target URLs after saving a draft, in case the URLs have changed.\n- The confirmation dialog that can appear after running the Asset Indexes utility no longer will close by pressing the <kbd>Esc</kbd> key or clicking outside of the modal. ([#4795](https://github.com/craftcms/cms/issues/4795))\n- Section and Matrix \u201cPropagation Method\u201d settings now display warnings about the potential for data loss when appropriate.\n- Site group settings now display a warning about the potential for data loss.\n- Control Panel subnav items can now have badge counts. ([#4756](https://github.com/craftcms/cms/issues/4756))\n- Improved the performance of element duplication on multi-site installs.\n- Improved the performance of `craft\\web\\View::renderString()` for templates that don\u2019t contain any Twig code.\n- `craft\\behaviors\\DraftBehavior::getCreator()` can now return `null`.\n- `craft\\helpers\\Db::parseParam()` now has an optional `$columnType` argument. ([#4807](https://github.com/craftcms/cms/pull/4807))\n- `craft\\test\\TestSetup::setupCraftDb()` no longer accepts a second argument. Ensure that `craft\\test\\Craft::$testConfig` is set before calling this function. ([#4804](https://github.com/craftcms/cms/pull/4804))\n- `craft\\web\\Request::post()` and `getBodyParam()` will now work with posted JSON data, if the request\u2019s content type is set to `application/json`.\n- Switched from the `stringy/stringy` library to `voku/stringy`. ([#4753](https://github.com/craftcms/cms/issues/4753))\n\n### Deprecated\n- Deprecated the `suppressTemplateErrors` config setting.\n- Deprecated `craft\\services\\Sections::isSectionTemplateValid()`.\n- Deprecated `craft\\web\\twig\\Template`.\n\n### Removed\n- Removed `craft\\base\\ElementInterface::getSource()`. ([#4754](https://github.com/craftcms/cms/issues/4754))\n- Removed `craft\\web\\twig\\Extension::actionInputFunction()`.\n- Removed `craft\\web\\twig\\Extension::csrfInputFunction()`.\n- Removed `craft\\web\\twig\\Extension::redirectInputFunction()`.\n\n### Fixed\n- Fixed an error that could occur if garbage collection was run while Craft 3.2 migrations were pending. ([#4720](https://github.com/craftcms/cms/issues/4720))\n- Fixed a validation error that occurred when duplicating an entry, if the URI format was based on a custom field value. ([#4759](https://github.com/craftcms/cms/issues/4759))\n- Fixed a bug where the \u201cPublish live changes for other authors\u2019 entries\u201d permission was being enforced when saving another author\u2019s entry as a new entry. ([#4758](https://github.com/craftcms/cms/issues/4758))\n- Fixed a bug where `craft\\helpers\\UrlHelper` methods would strip out array params in the query string. ([#4778](https://github.com/craftcms/cms/issues/4778))\n- Fixed a SQL error that occurred when a `{% cache %}` tag was used on a page with a 4-byte character in the URI. ([#4780](https://github.com/craftcms/cms/issues/4780))\n- Fixed a bug where Craft could show a nondescript error when navigating away from a Control Panel page if an Ajax request was currently in progress. ([#4796](https://github.com/craftcms/cms/issues/4796))\n- Fixed an error that occurred when editing an entry with a draft that was created by a soft-deleted user. ([#4800](https://github.com/craftcms/cms/issues/4800))\n- Fixed a bug where entry revisions and drafts would be deleted when the user that created them was hard-deleted.\n- Fixed a SQL error that could occur when executing an element query that had custom `JOIN` and `WHERE` clauses if the `search` param was also set. ([#4788](https://github.com/craftcms/cms/issues/4788))\n- Fixed a bug where default field values weren\u2019t being applied to Matrix blocks that were autocreated per the Min Blocks setting. ([#4806](https://github.com/craftcms/cms/issues/4806))\n- Fixed Plugin Store dropdowns which were not working properly with Windows Edge browsers.\n- Fixed a SQL error that could occur when `:empty:` or `not :empty:` was passed to a date param on an element query when running MySQL 8. ([#4808](https://github.com/craftcms/cms/issues/4808))\n- Fixed a bug where Dropdown and Multi-select fields\u2019 Dropdown Options settings weren\u2019t autofocussing on the first input when adding a new row with the keyboard. ([#4823](https://github.com/craftcms/cms/issues/4823))\n\n## 3.2.10 - 2019-08-13\n\n### Added\n- Added `craft\\fields\\BaseRelationField::settingsTemplateVariables()`. ([#4732](https://github.com/craftcms/cms/issues/4732))\n- Added `craft\\services\\Search::deleteOrphanedIndexes()`.\n- Added `craft\\validators\\UriFormatValidator::$disallowTriggers`.\n- Added the `Craft.startsWith()` JavaScript method.\n\n### Changed\n- Improved garbage collection performance when hard-deleting hundreds of thousands of elements. ([#4735](https://github.com/craftcms/cms/issues/4735))\n- Element queries\u2019 `title` param will now accept a value of `'0'`.\n- `craft\\services\\Elements::deleteElementById()` now has a `$hardDelete` argument. ([#4747](https://github.com/craftcms/cms/pull/4747))\n- It\u2019s no longer possible to save routes or URI formats that begin with the `actionTrigger` or `cpTrigger` config settings. ([#4154](https://github.com/craftcms/cms/issues/4154))\n- Categories fields\u2019 selection modals now show the site menu. ([#4749](https://github.com/craftcms/cms/issues/4749))\n\n### Removed\n- Removed `craft\\records\\Route`.\n\n### Fixed\n- Fixed a bug where Entry fixtures wouldn\u2019t get unloaded. ([#4663](https://github.com/craftcms/cms/issues/4663))\n- Fixed a bug where entry content wouldn\u2019t get propagated to other sites if an entry was created and then saved before Craft had finished autosaving the draft. ([#4423](https://github.com/craftcms/cms/issues/4423))\n- Fixed a bug where entry forms could miss the fact that a Matrix block had been deleted. ([#4727](https://github.com/craftcms/cms/issues/4727))\n- Fixed a PHP error that could occur on environments where the Intl PHP extension was installed but the `IDNA_NONTRANSITIONAL_TO_ASCII` or `INTL_IDNA_VARIANT_UTS46` constants weren\u2019t defined. ([#4722](https://github.com/craftcms/cms/issues/4722))\n- Fixed a PHP error that could occur if a plugin was configured with settings even though it didn\u2019t support settings. ([#4706](https://github.com/craftcms/cms/issues/4706))\n- Fixed an error that occurred when a validation error occurred on an entry while it was being created or updated from a draft. ([#4733](https://github.com/craftcms/cms/issues/4733))\n- Fixed an infinite recursion bug that could occur when validating circular relations. ([#4482](https://github.com/craftcms/cms/issues/4482))\n- Fixed a bug where elements with a title of \u201c0\u201d would show their ID instead of their title in element indexes and relational fields. ([#4745](https://github.com/craftcms/cms/issues/4745))\n- Fixed a bug where Craft was redirecting to the Dashboard when attempting to export elements, if the `tokenParam` config setting was set to something besides `token`. ([#4737](https://github.com/craftcms/cms/issues/4737))\n\n## 3.2.9 - 2019-08-06\n\n### Added\n- Added the `ignorePlaceholders` element query param.\n- Added the `cp.entries.edit.meta` and `cp.entries.edit.settings` template hooks to the Edit Entry page.\n- Added `craft\\base\\ElementInterface::getSource()`.\n- Added `craft\\base\\ElementTrait::$newSiteIds`.\n- Added `craft\\models\\Site::$dateCreated` and `$dateUpdated`. ([#4703](https://github.com/craftcms/cms/issues/4703))\n\n### Changed\n- Improved the Control Panel header styling for mobile and on pages with long titles. ([#4548](https://github.com/craftcms/cms/issues/4548))\n- Element references in the Control Panel now reveal the site the element was fetched from in their tooltips, on multi-site installs. ([#4690](https://github.com/craftcms/cms/issues/4690))\n- Element editor HUDs now always show a header with the element\u2019s site name on multi-site installs, even if the element is only editable in one site. ([#4690](https://github.com/craftcms/cms/issues/4690))\n- Entry preview tokens now respect the `defaultTokenDuration` config setting, rather than always expiring after 24 hours. ([#4683](https://github.com/craftcms/cms/pull/4683))\n- Improved disabled select field styling. ([#4709](https://github.com/craftcms/cms/pull/4709))\n\n### Deprecated\n- Deprecated `craft\\behaviors\\DraftBehavior::getSource()`.\n- Deprecated `craft\\behaviors\\RevisionBehavior::getSource()`.\n\n### Fixed\n- Fixed a bug where elements listed in a Structure view could be missing their descendant toggles even if all of their descendants were disabled. ([#4685](https://github.com/craftcms/cms/issues/4685))\n- Fixed a bug where element CSV exports were limited to 50 elements if no limit was set. ([#4692](https://github.com/craftcms/cms/issues/4692))\n- Fixed a 400 error that occurred when submitting an entry form that didn\u2019t have an `entryId` param. ([#4693](https://github.com/craftcms/cms/issues/4693))\n- Fixed a bug where `craft\\base\\Element::getDescendants()` and other structure methods could return the wrong results when called on a draft. ([#4694](https://github.com/craftcms/cms/issues/4694))\n- Fixed a bug where Matrix blocks weren\u2019t getting duplicated to newly-enabled sites for elements if the field\u2019s Propagation Method setting wasn\u2019t set to \u201cSave blocks to all sites the owner element is saved in\u201d. ([#4698](https://github.com/craftcms/cms/issues/4698))\n- Fixed a bug where the Database Backup could result in a 404 error on load-balanced environments. ([#4699](https://github.com/craftcms/cms/issues/4699))\n- Fixed a bug where the \u201cCurrent\u201d entry revision link wouldn\u2019t always work. ([#4705](https://github.com/craftcms/cms/issues/4705))\n- Fixed a bug where the `craft\\services\\Search::EVENT_AFTER_SEARCH` event wasn\u2019t always firing. ([#4710](https://github.com/craftcms/cms/issues/4710))\n- Fixed a bug where `craft\\services\\Users::purgeExpiredPendingUsers()` was attempting to delete already-trashed users.\n\n### Security\n- Fixed an XSS vulnerability.\n\n## 3.2.8 - 2019-07-30\n\n### Added\n- Element indexes with unsaved drafts now show a \u201cDrafts\u201d option in the status menu.\n- Added the `utils/fix-element-uids` command, which ensures all elements have unique UIDs. ([#4653](https://github.com/craftcms/cms/issues/4653))\n\n### Fixed\n- Fixed a bug where it wasn\u2019t possible to create a homepage Single section if a prior entry revisions\u2019 URI had been set to `__home__`. ([#4657](https://github.com/craftcms/cms/issues/4657))\n- Fixed a bug where the user deletion confirmation dialog was including revisions and drafts when counting entries for the content summary.\n- Fixed an error that occurred when deleting a user, if another user had been chosen to inherit their content. ([#4670](https://github.com/craftcms/cms/issues/4670))\n- Fixed a bug where users could be warned about losing unsaved changes when updating an entry from a draft, while the draft was being autosaved. ([#4614](https://github.com/craftcms/cms/issues/4614))\n- Fixed a bug where Categories fields weren\u2019t always getting updated when a category they were related to got moved under another category. ([#4672](https://github.com/craftcms/cms/issues/4672))\n- Fixed an error that occurred on the Settings \u2192 Routes page, if one of the routes didn\u2019t have a URI pattern. ([#4676](https://github.com/craftcms/cms/issues/4676))\n- Fixed some styling and behavior issues on the Settings \u2192 Routes page.\n\n## 3.2.7 - 2019-07-25\n\n### Fixed\n- Fixed an error where it wasn\u2019t possible to scale SVGs using only height. ([#4643](https://github.com/craftcms/cms/pull/4643))\n- Fixed a bug where the content area of some Control Panel pages weren\u2019t getting any bottom padding. ([#4644](https://github.com/craftcms/cms/issues/4644))\n- Fixed a bug where installing a plugin immediately after installing Craft from the console could corrupt the project config if `useProjectConfigFile` was enabled. ([#3870](https://github.com/craftcms/cms/issues/3870))\n- Fixed a bug where entry forms could overlook changes made to Categories fields. ([#4648](https://github.com/craftcms/cms/issues/4648))\n- Fixed a bug where element search indexes weren\u2019t being updated right away after an element was created or updated from an element editor HUD.\n- Fixed a bug where back-end slug validation wasn\u2019t working correctly for slugs with some Unicode characters. ([#1535](https://github.com/craftcms/cms/issues/1535))\n- Fixed a bug where Craft was attempting to delete template caches even when saving a draft or revision.\n\n## 3.2.6 - 2019-07-23\n\n### Changed\n- When enabling a new site for a Single section, Craft now uses the primary site\u2019s content as the starting point for the new site\u2019s content, if the section was already enabled for it.\n- Swapped the position of the \u201cSave as a Draft\u201d and \u201cSave Entry\u201d buttons. ([#4622](https://github.com/craftcms/cms/issues/4622))\n- `craft\\helpers\\DateTimeHelper::toDateTime()` now supports arrays created from `DateTime` objects. ([#4627](https://github.com/craftcms/cms/issues/4627))\n- Plugin license key inputs are no longer limited to 29 characters, to make room for long environment variable names. ([#4393](https://github.com/craftcms/cms/issues/4393))\n- Updated Imagine to 1.2.2.1.\n\n### Fixed\n- Fixed a bug where Craft could load the same JavaScript and CSS files multiple times when opening element editor HUDs. ([#4620](https://github.com/craftcms/cms/issues/4620))\n- Fixed a bug where each animated GIF frame would still be parsed when generating a thumbnail, even if the `transformGifs` setting was set to `false`. ([#4588](https://github.com/craftcms/cms/issues/4588))\n- Fixed a bug where back-end slug validation wasn\u2019t working correctly for slugs with Unicode characters. ([#4628](https://github.com/craftcms/cms/issues/4628))\n- Fixed a bug where it wasn\u2019t possible to create new entries if the section handle matched the `pageTrigger` config setting, and the `pageTrigger` config setting had a trailing slash. ([#4631](https://github.com/craftcms/cms/issues/4631))\n- Fixed a bug where the `sections.previewTargets` database column was getting created as a `varchar` instead of `text` column for new Craft installs. ([#4638](https://github.com/craftcms/cms/issues/4638))\n\n### Security\n- Fixed a bug where the `preserveExifData` config setting wasn\u2019t being respected on image upload.\n\n## 3.2.5.1 - 2019-07-19\n\n### Fixed\n- Fixed an error that occurred if a plugin license key was set to an environment variable, which was set to an invalid key. ([#4604](https://github.com/craftcms/cms/issues/4604))\n- Fixed an error that prevented image thumbnails from generating in the Control Panel when using ImageMagick. ([#4609](https://github.com/craftcms/cms/issues/4609))\n\n## 3.2.5 - 2019-07-19\n\n### Added\n- Added `craft\\services\\Elements::getPlaceholderElements()`.\n\n### Changed\n- If an invalid entry draft or revision edit URL is accessed, but the source entry does exist, Craft now redirects the browser to the source entry\u2019s edit page. ([#4574](https://github.com/craftcms/cms/issues/4574))\n- Preview requests now include the previewed entry in element queries even if the `status`, `drafts`, or `revisions` parameters are set to exclude it. ([#4581](https://github.com/craftcms/cms/issues/4581))\n- Back-end slug generation now follows the same rules as JavaScript. ([#4607](https://github.com/craftcms/cms/issues/4607))\n- Unsaved entry drafts now get assigned a new ID when they are fully saved, so they are treated as new elements. ([#4589](https://github.com/craftcms/cms/issues/4589))\n\n### Fixed\n- Fixed some bugs with the \u201cSave Entry\u201d menu options, when editing an unsaved draft. ([#4614](https://github.com/craftcms/cms/issues/4614))\n- Fixed a bug where Craft could forget which site was being edited when updating an entry from a draft. ([#4615](https://github.com/craftcms/cms/issues/4615))\n\n## 3.2.4.1 - 2019-07-17\n\n### Fixed\n- Fixed an error that occurred when attempting to share a disabled entry. ([#4596](https://github.com/craftcms/cms/issues/4596))\n- Fixed a bug where new Email and URL cells in Table fields weren\u2019t getting the correct input type. ([#4595](https://github.com/craftcms/cms/issues/4595))\n\n## 3.2.4 - 2019-07-17\n\n### Changed\n- Brought back the \u201cPreview\u201d button for the Current revision of entries, which now creates a draft before activating the entry preview. ([#4584](https://github.com/craftcms/cms/issues/4584))\n- The \u201cSave as a Draft\u201d button now creates the draft over Ajax, when it\u2019s not the primary submit button for the page.\n- When Craft isn\u2019t able to sync incoming `project.yaml` changes due to schema version conflicts, Craft now lists which packages are conflicting.. ([#4568](https://github.com/craftcms/cms/issues/4568))\n\n### Fixed\n- Fixed a JavaScript error that could occur after uploading a file directly onto an Assets field when editing the Current revision of an entry.\n- Fixed a bug where draft forms could become unresponsive if the user attempted to navigate away from the page or submit the form in the middle of an autosave. ([#4578](https://github.com/craftcms/cms/issues/4578))\n- Fixed a SQL error that could occur when passing `:empty:` or `:notempty:` to a relational field\u2019s element query param. ([#4529](https://github.com/craftcms/cms/issues/4529))\n- Fixed a bug where Number fields weren\u2019t getting set to their default values for new entries. ([#4586](https://github.com/craftcms/cms/issues/4586))\n- Fixed a bug query string parameters were getting URL-encoded when applied to generated pagination URLs.\n- Fixed a bug where Single entries had the option to be duplicated or deleted. ([#4590](https://github.com/craftcms/cms/issues/4590))\n\n## 3.2.3 - 2019-07-16\n\n### Added\n- Added `craft\\controllers\\EntriesController::actionDuplicateEntry()`.\n- Added `craft\\web\\UrlManager::setMatchedElement()`.\n\n### Changed\n- Craft no longer creates drafts automatically when editing entries. The user must click a \u201cSave as a Draft\u201d button to create one. ([#4549](https://github.com/craftcms/cms/issues/4549))\n- Entries are now immediately savable, whether or not any changes were made. ([#4535](https://github.com/craftcms/cms/issues/4535))\n- The \u201cSave Entry\u201d button now redirects the user to the Entries index page. ([#4575](https://github.com/craftcms/cms/issues/4575))\n- Brought back the \u201cSave and continue editing\u201d and \u201cSave and add another\u201d options for entries.\n- It\u2019s no longer possible to preview entries\u2019 Current revision. A draft must be created first.\n\n### Fixed\n- Fixed a bug where it wasn\u2019t possible to delete Matrix blocks if Min Blocks and Max Blocks were set to the same value, and an element already had more than that many blocks. ([#4562](https://github.com/craftcms/cms/issues/4562))\n- Fixed a bug where `craft\\web\\UrlManager::getMatchedElement()` could return the incorrect result on preview requests. ([#4542](https://github.com/craftcms/cms/issues/4542))\n- Fixed an error that occurred on the Settings \u2192 Email page if email settings were missing from the project config. ([#4552](https://github.com/craftcms/cms/issues/4552))\n- Fixed a bug where it wasn\u2019t possible to toggle site-specific entry statuses when editing drafts. ([#4577](https://github.com/craftcms/cms/issues/4577))\n\n## 3.2.2 - 2019-07-14\n\n### Added\n- Added `craft\\helpers\\ElementHelper::isTempSlug()`.\n- Added `craft\\helpers\\ElementHelper::tempSlug()`.\n- Added `craft\\helpers\\UrlHelper::removeParam()`.\n\n### Changed\n- Craft no longer ensures a recent revision exists before creating a draft for an element.\n- Element exports are limited to CSV files now, to avoid the GD requirement imposed by the PHPSpreadsheet library. ([#4553](https://github.com/craftcms/cms/issues/4553))\n\n### Fixed\n- Fixed a bug where multi-site element queries with the `unique` and `offset` params set weren\u2019t returning any results. ([#4560](https://github.com/craftcms/cms/issues/4560))\n- Fixed an error that could occur when creating a draft. ([#4515](https://github.com/craftcms/cms/issues/4515))\n- Fixed a bug where Craft wasn\u2019t generating a new slug for entries that were saved with a blank Slug field. ([#4518](https://github.com/craftcms/cms/issues/4518))\n- Fixed a bug where disabled select options could lose their disabled text styling in Firefox. ([#4526](https://github.com/craftcms/cms/issues/4526))\n- Fixed a bug where entry forms could miss the fact that a file had been uploaded to an Assets field. ([#4534](https://github.com/craftcms/cms/issues/4534))\n- Fixed a bug where selecting \u201cCreate a new child entry\u201d in a Structure section on a multi-site install would result in a 404 error. ([#4541](https://github.com/craftcms/cms/issues/4541))\n- Fixed a bug where it wasn\u2019t possible to set test-specific config settings. ([#4539](https://github.com/craftcms/cms/pull/4539))\n- Fixed an error that occurred when exporting elements if Limit was set to `0`. ([#4547](https://github.com/craftcms/cms/issues/4547))\n- Fixed a bug where the `{% paginate %}` tag wouldn\u2019t generate links to the first page correctly when using query string pagination. ([#4550](https://github.com/craftcms/cms/issues/4550))\n- Fixed an error that occurred when indexing assets from a console request, if no volumes were defined yet. ([#2798](https://github.com/craftcms/cms/issues/2798))\n- Fixed a bug where the \u201cDelete\u201d link could show up in the draft meta HUD for unsaved drafts. ([#4557](https://github.com/craftcms/cms/issues/4557))\n\n## 3.2.1 - 2019-07-11\n\n### Added\n- Added `craft\\console\\Request::getIsPreview()`.\n- Added `craft\\web\\Request::getIsPreview()`.\n\n### Changed\n- If a draft can\u2019t be saved, an alert icon is now shown in the Control Panel header, which can be clicked on to reveal more information.\n- Element revisions no longer store snapshot data.\n\n### Fixed\n- Fixed a bug where Feed widget items weren\u2019t getting hyperlinked.\n- Fixed a bug where the `app/migrate` controller wasn\u2019t applying new `project.yaml` changes if there were no pending migrations.\n- Fixed a SQL error that could occur when saving an entry or entry draft. ([#4508](https://github.com/craftcms/cms/issues/4508))\n- Fixed a bug where Assets fields set to restrict uploads to a single folder could have empty selector modals. ([#4522](https://github.com/craftcms/cms/issues/4522))\n- Fixed an error that could occur if a template was accessing the deprecated `locale` property of an element query, but `siteId` wasn\u2019t set to an integer. ([#4531](https://github.com/craftcms/cms/issues/4531))\n- Fixed a bug where users without the \u201cPublish live changes\u201d permission for a section weren\u2019t able to create new entries. ([#4528](https://github.com/craftcms/cms/issues/4529))\n- Fixed a PHP error that could occur when uploading files to Assets fields on the front-end. ([#4382](https://github.com/craftcms/cms/issues/4382))\n- Fixed a bug where elements listed in a Structure view could show descendant toggles even if they had no descendants. ([#4504](https://github.com/craftcms/cms/issues/4504))\n- Fixed a backwards compatibility issue. ([#4523](https://github.com/craftcms/cms/issues/4523))\n\n## 3.2.0 - 2019-07-09\n\n> {warning} If you\u2019ve ever run the `project-config/rebuild` command, it\u2019s highly recommended that you run it again with Craft 3.1.34.2, before updating to Craft 3.2.\n\n> {warning} Custom login controllers must now explicitly set their `$allowAnonymous` values to include `self::ALLOW_ANONYMOUS_OFFLINE` if they wish to be available when the system is offline.\n\n> {tip} If you have Super Table or Neo installed, you should update those **at the same time** as Craft, to avoid unnecessary search index jobs from being added to the queue.\n\n### Added\n- All element types now have the option to support drafts and revisions.\n- Drafts are now autocreated when content is modified, and autosaved whenever the content changes. ([#1034](https://github.com/craftcms/cms/issues/1034))\n- Drafts and revisions now store content across all sites supported by the element. ([#2669](https://github.com/craftcms/cms/issues/2669))\n- Content previewing is now draft-based, and drafts are stored as specialized elements, so it\u2019s no longer necessary to add special cases in templates for preview requests. ([#1787](https://github.com/craftcms/cms/issues/1787), [#2801](https://github.com/craftcms/cms/issues/2801))\n- Sections now have a \u201cPreview Targets\u201d setting when running Craft Pro, which can be used to configure additional locations that entries can be previewed from. ([#1489](https://github.com/craftcms/cms/issues/1489))\n- Sections now have a \u201cPropagation Method\u201d setting, enabling entries to only be propagated to other sites in the same site group, or with the same language. ([#3554](https://github.com/craftcms/cms/issues/3554))\n- Matrix fields now have a \u201cPropagation Method\u201d setting, enabling blocks to only be propagated to other sites in the same site group, or with the same language. ([#3554](https://github.com/craftcms/cms/issues/3554))\n- Single entries now have editable slugs. ([#3368](https://github.com/craftcms/cms/issues/3368))\n- Headless content previewing is now possible by forwarding request tokens off to content API requests. ([#1231](https://github.com/craftcms/cms/issues/1231))\n- Preview iframes are now created with a `src` attribute already in place, improving SPA support. ([#2120](https://github.com/craftcms/cms/issues/2120))\n- Entry \u201cShare\u201d buttons are now visible on mobile. ([#4408](https://github.com/craftcms/cms/issues/4408))\n- Added the \u201cTemp Uploads Location\u201d system setting (available from Settings \u2192 Assets \u2192 Settings), which makes it possible to choose the volume and path that temporary asset uploads should be stored. ([#4010](https://github.com/craftcms/cms/issues/4010))\n- Added the `maxRevisions` config setting. ([#926](https://github.com/craftcms/cms/issues/926))\n- Added the `purgeUnsavedDraftsDuration` config setting, which determines how long unsaved drafts should be allowed to exist before getting deleted via garbage collection.\n- Added the \u201cEdit images\u201d permission. ([#3349](https://github.com/craftcms/cms/issues/3349))\n- Added the \u201cImpersonate users\u201d permission. ([#3501](https://github.com/craftcms/cms/issues/3501))\n- Added the `drafts`, `draftId`, `draftOf`, `draftCreator`, `revisions`, `revisionId`, `revisionOf`, and `revisionCreator` element query params.\n- The `site` element query params now support passing multiple site handles, or `'*'`, to query elements across multiple sites at once. ([#2854](https://github.com/craftcms/cms/issues/2854))\n- Relational fields now have a \u201cValidate related elements\u201d setting, which ensures that the related elements pass validation before the source element can be saved with them selected. ([#4095](https://github.com/craftcms/cms/issues/4095))\n- Table fields can now have Dropdown, Email, and URL columns. ([#811](https://github.com/craftcms/cms/issues/811), [#4180](https://github.com/craftcms/cms/pull/4180))\n- Dropdown and Multi-select fields can now have optgroups. ([#4236](https://github.com/craftcms/cms/issues/4236))\n- Date/Time, Dropdown, Lightswitch, Number, and Radio Buttons fields are now listed as sort options in element indexes. ([#2818](https://github.com/craftcms/cms/issues/2818))\n- Asset, category, entry, and user indexes can now have \u201cUID\u201d columns. ([#4433](https://github.com/craftcms/cms/issues/4433))\n- Added the `unique` element query param, which can be used to prevent duplicate elements when querying elements across multiple sites.\n- Added the `preferSites` element query param, which can be used to set the preferred sites that should be used for multi-site element queries, when the `unique` param is also enabled.\n- Element index pages are now paginated for non-Structure views. ([#818](https://github.com/craftcms/cms/issues/818))\n- Element index pages now have an \u201cExport\u2026\u201d button that will export all of the elements in the current view (across all pages) or up to a custom limit, in either CSV, XLS, XLSX, or ODS format. ([#994](https://github.com/craftcms/cms/issues/994))\n- Added the `{% dd %}` Twig tag. ([#4399](https://github.com/craftcms/cms/issues/4399))\n- Added the `attr()` Twig function, which can generate a list of HTML/XML attributes. ([#4237](https://github.com/craftcms/cms/pull/4237))\n- Added the `|withoutKey` Twig filter.\n- Added the `resave/matrix-blocks` console command.\n- The `index-assets/*` commands now support a `--create-missing-assets=0` option, which prevents Craft from creating asset records when they don\u2019t exist yet, and offers an opportunity to fix the location of any asset records that are missing their associated files, when the filename matches one of the files missing an index.\n- Added the `mailer/test` command. ([#4020](https://github.com/craftcms/cms/issues/4020))\n- Added the `tests/setup` command, which generates a test suite for the current Craft project.\n- Jobs can now set progress labels, which will be shown below their description and progress bar in the queue HUD. ([#1931](https://github.com/craftcms/cms/pull/1931))\n- Added the `_layouts/element` template, which can be extended by element edit pages that wish to support drafts, revisions, and content previewing.\n- Added the `_special/sitepicker` template.\n- It\u2019s now possible for plugins and modules to define custom actions on console controllers.\n- Added a testing framework for Craft and plugins, powered by Codeception. ([#3382](https://github.com/craftcms/cms/pull/3382), [#1485](https://github.com/craftcms/cms/issues/1485), [#944](https://github.com/craftcms/cms/issues/944))\n- Added `craft\\base\\ApplicationTrait::getInstalledSchemaVersion()`.\n- Added `craft\\base\\BlockElementInterface`.\n- Added `craft\\base\\Element::EVENT_AFTER_PROPAGATE`.\n- Added `craft\\base\\Element::EVENT_REGISTER_PREVIEW_TARGETS`.\n- Added `craft\\base\\Element::previewTargets()`.\n- Added `craft\\base\\ElementInterface::afterPropagate()`.\n- Added `craft\\base\\ElementInterface::getCurrentRevision()`.\n- Added `craft\\base\\ElementInterface::getIsDraft()`.\n- Added `craft\\base\\ElementInterface::getIsRevision()`.\n- Added `craft\\base\\ElementInterface::getIsUnsavedDraft()`.\n- Added `craft\\base\\ElementInterface::getPreviewTargets()`.\n- Added `craft\\base\\ElementInterface::getSourceId()`.\n- Added `craft\\base\\ElementInterface::getSourceUid()`.\n- Added `craft\\base\\ElementInterface::getUiLabel()`, which is now used to define what an element will be called in the Control Panel. ([#4211](https://github.com/craftcms/cms/pull/4211))\n- Added `craft\\base\\ElementInterface::pluralDisplayName()`, which element type classes can use to define the plural of their display name.\n- Added `craft\\base\\ElementInterface::setRevisionCreatorId()`.\n- Added `craft\\base\\ElementInterface::setRevisionNotes()`.\n- Added `craft\\base\\ElementTrait::$dateDeleted`. ([#4493](https://github.com/craftcms/cms/issues/4493))\n- Added `craft\\base\\ElementTrait::$draftId`.\n- Added `craft\\base\\ElementTrait::$hardDelete`.\n- Added `craft\\base\\ElementTrait::$previewing`.\n- Added `craft\\base\\ElementTrait::$propagateAll`.\n- Added `craft\\base\\ElementTrait::$revisionId`.\n- Added `craft\\base\\Field::EVENT_AFTER_ELEMENT_PROPAGATE`.\n- Added `craft\\base\\Field::getSortOption()`.\n- Added `craft\\base\\FieldInterface::afterElementPropagate()`.\n- Added `craft\\base\\FieldInterface::valueType()`. ([#3894](https://github.com/craftcms/cms/issues/3894))\n- Added `craft\\base\\SortableFieldInterface`, which can be implemented by field classes that should be sortable in element indexes.\n- Added `craft\\behaviors\\DraftBehavior`.\n- Added `craft\\behaviors\\RevisionBehavior`.\n- Added `craft\\console\\CallableAction`.\n- Added `craft\\console\\Controller`.\n- Added `craft\\console\\controllers\\ResaveController::saveElements()`.\n- Added `craft\\console\\ControllerTrait`.\n- Added `craft\\console\\Request::getToken()`.\n- Added `craft\\controllers\\PreviewController`.\n- Added `craft\\errors\\MissingAssetException`.\n- Added `craft\\events\\BatchElementActionEvent`.\n- Added `craft\\events\\DefineConsoleActionsEvent`.\n- Added `craft\\events\\ElementQueryEvent`.\n- Added `craft\\events\\RegisterPreviewTargetsEvent`.\n- Added `craft\\events\\RevisionEvent`.\n- Added `craft\\helpers\\Component::validateComponentClass()`.\n- Added `craft\\helpers\\ElementHelper::isDraftOrRevision()`.\n- Added `craft\\helpers\\ElementHelper::rootElement()`.\n- Added `craft\\models\\Section::$propagationMethod`.\n- Added `craft\\queue\\jobs\\UpdateSearchIndex`.\n- Added `craft\\services\\Drafts`, accessible via `Craft::$app->drafts`.\n- Added `craft\\services\\Elements::propagateElements()` along with `EVENT_BEFORE_PROPAGATE_ELEMENTS`, `EVENT_AFTER_PROPAGATE_ELEMENTS`, `EVENT_BEFORE_PROPAGATE_ELEMENT`, and `EVENT_AFTER_PROPAGATE_ELEMENT` events. ([#4139](https://github.com/craftcms/cms/issues/4139))\n- Added `craft\\services\\Elements::resaveElements()` along with `EVENT_BEFORE_RESAVE_ELEMENTS`, `EVENT_AFTER_RESAVE_ELEMENTS`, `EVENT_BEFORE_RESAVE_ELEMENT`, and `EVENT_AFTER_RESAVE_ELEMENT` events. ([#3482](https://github.com/craftcms/cms/issues/3482))\n- Added `craft\\services\\Matrix::duplicateBlocks()`.\n- Added `craft\\services\\Matrix::getSupportedSiteIdsForField()`.\n- Added `craft\\services\\Revisions`, accessible via `Craft::$app->revisions`.\n- Added `craft\\services\\Users::canImpersonate()`.\n- Added `craft\\web\\Request::getIsLoginRequest()` and `craft\\console\\Request::getIsLoginRequest()`.\n- Added `craft\\web\\UrlManager::$checkToken`.\n- Added the `Craft.isSameHost()` JavaScript method.\n- Added the `Craft.parseUrl()` JavaScript method.\n- Added the `Craft.randomString()` JavaScript method.\n- Added the `Craft.DraftEditor` JavaScript class.\n- Added the `Craft.Preview` JavaScript class.\n\n### Changed\n- Relational fields are now capable of selecting elements from multiple sites, if they haven\u2019t been locked down to only related elements from a single site. ([#3584](https://github.com/craftcms/cms/issues/3584))\n- Element selector modals now always show source headings, and list sources in the configured order. ([#4494](https://github.com/craftcms/cms/issues/4494))\n- Reference tags can now specify the site to load the element from. ([#2956](https://github.com/craftcms/cms/issues/2956))\n- Improved the button layout of Edit Entry pages. ([#2325](https://github.com/craftcms/cms/issues/2325))\n- Improved the performance of saving elements.\n- The Control Panel now shows the sidebar on screens that are at least 1,000 pixels wide. ([#4079](https://github.com/craftcms/cms/issues/4079))\n- The `_layouts/cp` template now supports a `showHeader` variable that can be set to `false` to remove the header.\n- The `_layouts/cp` Control Panel template now supports a `footer` block, which will be output below the main content area.\n- Renamed `craft\\helpers\\ArrayHelper::filterByValue()` to `where()`.\n- Anonymous/offline/Control Panel access validation now takes place from `craft\\web\\Controller::beforeAction()` rather than `craft\\web\\Application::handleRequest()`, giving controllers a chance to do things like set CORS headers before a `ForbiddenHttpException` or `ServiceUnavailableHttpException` is thrown. ([#4008](https://github.com/craftcms/cms/issues/4008))\n- Controllers can now set `$allowAnonymous` to a combination of bitwise integers `self::ALLOW_ANONYMOUS_LIVE` and `self::ALLOW_ANONYMOUS_OFFLINE`, or an array of action ID/bitwise integer pairs, to define whether their actions should be accessible anonymously even when the system is offline.\n- Improved the error message when Project Config reaches the maximum deferred event count.\n- Craft now deletes expired template caches as part of its garbage collection routine.\n- Craft no longer warns about losing unsaved changes when leaving the page while previewing entries, if the changes were autosaved. ([#4439](https://github.com/craftcms/cms/issues/4439))\n- `fieldValues` is a now reserved field handle. ([#4453](https://github.com/craftcms/cms/issues/4453))\n- Improved the reliability of `craft\\helpers\\UrlHelper::rootRelativeUrl()` and `cpUrl()`.\n- `craft\\base\\ElementInterface::eagerLoadingMap()` and `craft\\base\\EagerLoadingFieldInterface::getEagerLoadingMap()` can now return `null` to opt out of eager-loading. ([#4220](https://github.com/craftcms/cms/pull/4220))\n- `craft\\db\\ActiveRecord` no longer sets the `uid`, `dateCreated`, or `dateUpdated` values for new records if they were already explicitly set.\n- `craft\\db\\ActiveRecord` no longer updates the `dateUpdated` value for existing records if nothing else changed or if `dateUpdated` had already been explicitly changed.\n- `craft\\helpers\\UrlHelper::siteUrl()` and `url()` will now include the current request\u2019s token in the generated URL\u2019s query string, for site URLs.\n- `craft\\events\\MoveElementEvent` now extends `craft\\events\\ElementEvent`. ([#4315](https://github.com/craftcms/cms/pull/4315))\n- `craft\\queue\\BaseJob::setProgress()` now has a `$label` argument.\n- `craft\\queue\\jobs\\PropagateElements` no longer needs to be configured with a `siteId`, and no longer propagates elements to sites if they were updated in the target site more recently than the source site.\n- `craft\\queue\\QueueInterface::setProgress()` now has a `$label` argument.\n- `craft\\services\\Assets::getUserTemporaryUploadFolder()` now returns the current user\u2019s temporary upload folder by default if no user is provided.\n- `craft\\services\\Elements::deleteElement()` now has a `$hardDelete` argument.\n- `craft\\services\\Elements::deleteElement()` now has a `$hardDelete` argument. ([#3392](https://github.com/craftcms/cms/issues/3392))\n- `craft\\services\\Elements::getElementById()` now has a `$criteria` argument.\n- `craft\\services\\Elements::propagateElement()` now has a `$siteElement` argument.\n- `craft\\services\\Elements::saveElement()` now preserves existing elements\u2019 current `dateUpdated` value when propagating or auto-resaving elements.\n- `craft\\services\\Elements::saveElement()` now preserves the `uid`, `dateCreated`, and `dateUpdated` values on new elements if they were explicitly set. ([#2909](https://github.com/craftcms/cms/issues/2909))\n- `craft\\services\\Elements::setPlaceholderElement()` now throws an exception if the element that was passed in doesn\u2019t have an ID.\n- `craft\\services\\Matrix::saveField()` is no longer is responsible for duplicating blocks from other elements.\n- `craft\\web\\twig\\variables\\CraftVariable` no longer triggers the `defineComponents` event. ([#4416](https://github.com/craftcms/cms/issues/4416))\n- `craft\\web\\UrlManager::setRouteParams()` now has a `$merge` argument, which can be set to `false` to completely override the route params.\n- It\u2019s now possible to pass a `behaviors` key to the `$newAttributes` argument of `craft\\services\\Elements::duplicateElement()`, to preattach behaviors to the cloned element before it\u2019s saved.\n\n### Removed\n- Removed the Search Indexes utility. ([#3698](https://github.com/craftcms/cms/issues/3698))\n- Removed the `--batch-size` option from `resave/*` actions.\n- Removed the `craft.entryRevisions` Twig component.\n- Removed `craft\\controllers\\EntriesController::actionPreviewEntry()`.\n- Removed `craft\\controllers\\EntriesController::actionShareEntry()`.\n- Removed `craft\\controllers\\EntriesController::actionViewSharedEntry()`.\n- Removed `craft\\events\\VersionEvent`.\n- Removed `craft\\records\\Entry::getVersions()`.\n- Removed `craft\\records\\EntryDraft`.\n- Removed `craft\\records\\EntryVersion`.\n- Removed `craft\\services\\EntryRevisions::saveDraft()`.\n- Removed `craft\\services\\EntryRevisions::publishDraft()`.\n- Removed `craft\\services\\EntryRevisions::deleteDraft()`.\n- Removed `craft\\services\\EntryRevisions::saveVersion()`.\n- Removed `craft\\services\\EntryRevisions::revertEntryToVersion()`.\n- Removed the `Craft.EntryDraftEditor` JavaScript class.\n\n### Deprecated\n- Deprecated the `ownerSite` and `ownerSiteId` Matrix block query params.\n- Deprecated `craft\\controllers\\EntriesController::EVENT_PREVIEW_ENTRY`.\n- Deprecated `craft\\controllers\\LivePreviewController`.\n- Deprecated `craft\\elements\\MatrixBlock::$ownerSiteId`.\n- Deprecated `craft\\events\\DefineComponentsEvent`.\n- Deprecated `craft\\helpers\\ArrayHelper::filterByValue()`. Use `where()` instead.\n- Deprecated `craft\\models\\BaseEntryRevisionModel`.\n- Deprecated `craft\\models\\EntryDraft`.\n- Deprecated `craft\\models\\EntryVersion`.\n- Deprecated `craft\\models\\Section::$propagateEntries`. Use `$propagationMethod` instead.\n- Deprecated `craft\\services\\Assets::getCurrentUserTemporaryUploadFolder()`.\n- Deprecated `craft\\services\\EntryRevisions`.\n- Deprecated `craft\\web\\Request::getIsLivePreview()`.\n- Deprecated `craft\\web\\Request::getIsSingleActionRequest()` and `craft\\console\\Request::getIsSingleActionRequest()`.\n- Deprecated the `Craft.LivePreview` JavaScript class.\n\n### Fixed\n- Fixed a bug where `craft\\helpers\\UrlHelper` methods could add duplicate query params on generated URLs.\n- Fixed a bug where Matrix blocks weren\u2019t getting duplicated for other sites when creating a new element. ([#4449](https://github.com/craftcms/cms/issues/4449))\n\n## 3.1.34.3 - 2019-08-21\n\n### Fixed\n- Fixed a bug where the `project-config/rebuild` command wasn\u2019t discarding unused user groups or user field layouts in the project config. ([#4781](https://github.com/craftcms/cms/pull/4781))\n\n## 3.1.34.2 - 2019-07-23\n\n### Fixed\n- Fixed a bug where the `project-config/rebuild` command was discarding email and user settings.\n\n## 3.1.34.1 - 2019-07-22\n\n### Fixed\n- Fixed a bug where the `project-config/rebuild` command was ignoring entry types that didn\u2019t have a field layout. ([#4600](https://github.com/craftcms/cms/issues/4600))\n\n## 3.1.34 - 2019-07-09\n\n### Changed\n- The `project-config/rebuild` command now rebuilds the existing project config wherever possible, instead of merging database data with the existing project config.\n\n## 3.1.33 - 2019-07-02\n\n### Added\n- Added `craft\\base\\ApplicationTrait::saveInfoAfterRequest()`.\n\n### Changed\n- Craft no longer strips some punctuation symbols from slugs.\n- Improved the performance of saving project config updates. ([#4459](https://github.com/craftcms/cms/issues/4459))\n- Improved the performance of saving fields. ([#4459](https://github.com/craftcms/cms/issues/4459))\n- The `craft update` command no longer updates Craft or plugins if not specified.\n\n### Removed\n- Removed `craft\\services\\ProjectConfig::saveDataAfterRequest()`.\n- Removed `craft\\services\\ProjectConfig::preventSavingDataAfterRequest()`.\n\n### Fixed\n- Fixed a PHP error that occurred when deleting an asset transform. ([#4473](https://github.com/craftcms/cms/issues/4473))\n\n### Security\n- Fixed an XSS vulnerability.\n- Fixed a path disclosure vulnerability. ([#4468](https://github.com/craftcms/cms/issues/4468))\n- Added the `sameSiteCookieValue` config setting. ([#4462](https://github.com/craftcms/cms/issues/4462))\n\n## 3.1.32.1 - 2019-06-25\n\n### Fixed\n- Fixed a couple Windows compatibility issues.\n\n## 3.1.32 - 2019-06-25\n\n### Changed\n- Project Config now sorts arrays when all of the keys are UIDs. ([#4425](https://github.com/craftcms/cms/issues/4425))\n\n### Fixed\n- Fixed a bug where Craft might not match a domain to the proper site if it had a non-ASCII character in the host name.\n- Fixed an error that could occur when using the `|filter` Twig filter. ([#4437](https://github.com/craftcms/cms/issues/4437))\n- Fixed a bug where pagination URL could get repeated page params added to the query string if using query string-based pagination.\n\n## 3.1.31 - 2019-06-18\n\n### Added\n- It\u2019s now possible to set plugin license keys to environment variables using the `$VARIABLE_NAME` syntax. ([#4393](https://github.com/craftcms/cms/issues/4393))\n- Added `craft\\services\\Elements::mergeElements()`. ([#4404](https://github.com/craftcms/cms/pull/4404))\n\n### Changed\n- Pagination URLs now include any query string parameters set on the current request.\n- The default email template no longer sets text or background colors, so emails look better in dark mode. ([#4396](https://github.com/craftcms/cms/pull/4396))\n- Improved the error message that gets logged when Craft isn\u2019t able to finish processing project config changes, due to unresolved dependencies.\n- Craft will no longer log errors and warnings arising from `yii\\i18n\\PhpMessageSource`. ([#4109](https://github.com/craftcms/cms/issues/4109))\n- Improved the performance and reliability of user queries when the `group` param is set to a user group with a large number of users.\n- Updated Yii to 2.0.21.\n\n### Fixed\n- Fixed a bug where `Craft::dd()` wouldn\u2019t work properly if output buffering was enabled. ([#4399](https://github.com/craftcms/cms/issues/4399))\n- Fixed a bug where `Craft::alias()` wasn\u2019t working on Windows servers. ([#4405](https://github.com/craftcms/cms/issues/4405))\n- Fixed a bug where Craft wasn\u2019t parsing the `dsn` DB connection setting properly if it was supplied.\n\n### Security\n- Fixed an XSS vulnerability.\n\n## 3.1.30 - 2019-06-11\n\n### Changed\n- Improved query performance. ([yiisoft/yii2#17344](https://github.com/yiisoft/yii2/pull/17344), [yiisoft/yii2#17345](https://github.com/yiisoft/yii2/pull/17345), [yiisoft/yii2#17348](https://github.com/yiisoft/yii2/pull/17348))\n- `craft\\services\\Elements::saveElement()` now always propagates elements regardless of the `$propagate` argument value, when saving new elements. ([#4370](https://github.com/craftcms/cms/issues/4370))\n\n### Fixed\n- Fixed a bug where new elements weren\u2019t assigned a UID in time if their URI format contained a `{uid}` token. ([#4364](https://github.com/craftcms/cms/issues/4364))\n- Fixed a bug where Craft was modifying custom log target configs before executing queue jobs. ([#3766](https://github.com/craftcms/cms/issues/3766))\n- Fixed a bug where `craft\\helpers\\ChartHelper::getRunChartDataFromQuery()` assumed that the value would be integers. ([craftcms/commerce#849](https://github.com/craftcms/commerce/issues/849))\n- Fixed a bug where `craft\\services\\Security::validateData()` was returning an empty string instead of `false` when the data didn\u2019t validate. ([#4387](https://github.com/craftcms/cms/issues/4387))\n- Fixed a bug where Craft could inject unexpected JavaScript into front-end requests. ([#4390](https://github.com/craftcms/cms/issues/4390))\n\n## 3.1.29 - 2019-06-04\n\n### Added\n- Added the `restore` command, which restores a database backup.\n- Added the `Craft.escapeRegex()` JavaScript method.\n\n### Changed\n- Asset indexes now sort assets by Date Uploaded in descending order by default. ([#1153](https://github.com/craftcms/cms/issues/1153))\n- `craft\\db\\Paginator` no longer assumes that the application\u2019s database connection should be used.\n- Updated Twig to 2.11. ([#4342](https://github.com/craftcms/cms/issues/4342))\n\n### Fixed\n- Fixed a bug where the Status menu wasn\u2019t visible for the \u201cAll users\u201d source on user indexes. ([#4306](https://github.com/craftcms/cms/pull/4306))\n- Fixed a bug where pressing the <kbd>Esc</kbd> key in the setup wizard would close the modal window. ([#4307](https://github.com/craftcms/cms/issues/4307))\n- Fixed a bug where `craft\\validators\\ArrayValidator::validate()` didn\u2019t work. ([#4309](https://github.com/craftcms/cms/pull/4309))\n- Fixed an error that could occur when rendering templates with a `loop.parent.loop` reference in a nested for-loop. ([#4271](https://github.com/craftcms/cms/issues/4271))\n- Fixed a bug where publishing a Single entry\u2019s draft, or reverting a Single entry to a prior version, would overwrite its title to the section name. ([#4323](https://github.com/craftcms/cms/pull/4323))\n- Fixed a bug where Craft wasn\u2019t invalidating existing asset transforms when changing the dimensions of a named transform.\n- Fixed a bug where `craft\\services\\Fields::getFieldsByElementType()` would return duplicate results if a field was used in more than one field layout for the element type. ([#4336](https://github.com/craftcms/cms/issues/4336))\n- Fixed a bug where Craft wasn\u2019t respecting the `allowUppercaseInSlug` config setting when generating slugs in the Control Panel. ([#4330](https://github.com/craftcms/cms/issues/4330))\n- Fixed a bug where Control Panel Ajax requests weren\u2019t working if a custom `pathParam` config setting value was set. ([#4334](https://github.com/craftcms/cms/issues/4334))\n- Fixed a JavaScript error that could occur when saving a new entry, if the selected entry type didn\u2019t have a Title field. ([#4353](https://github.com/craftcms/cms/issues/4353))\n\n## 3.1.28 - 2019-05-21\n\n### Added\n- Added the \u201cCustomize element sources\u201d user permission. ([#4282](https://github.com/craftcms/cms/pull/4282))\n- Matrix sub-fields now have a \u201cUse this field\u2019s values as search keywords?\u201d setting. ([#4291](https://github.com/craftcms/cms/issues/4291))\n- Added `craft\\web\\twig\\variables::setBasePath()`. ([#4286](https://github.com/craftcms/cms/issues/4286))\n\n### Changed\n- Craft now requires Yii 2.0.19.\n\n### Fixed\n- Fixed a bug where slugs could get double-hyphenated. ([#4266](https://github.com/craftcms/cms/issues/4266))\n- Fixed an error that would occur when installing Craft if the `allowAdminChanges` config setting was disabled. ([#4267](https://github.com/craftcms/cms/issues/4267))\n- Fixed a bug where Matrix fields would return the wrong set of Matrix blocks on new or duplicated elements, immediately after they were saved.\n- Fixed a bug where users could not assign additional user groups to their own account if their permission to do so was granted by another user group they belonged to.\n- Fixed a bug where Number fields would attempt to save non-numeric values. ([craftcms/feed-me#527](https://github.com/craftcms/feed-me/issues/527))\n- Fixed a bug where it was possible to assign a Structure entry or category to a new parent, even if that would cause its descendants to violate the Max Levels setting. ([#4279](https://github.com/craftcms/cms/issues/4279))\n- Fixed an error that could occur when rendering a template from a console request, if the template contained any non-global `{% cache %}` tags. ([#4284](https://github.com/craftcms/cms/pull/4284))\n\n## 3.1.27 - 2019-05-14\n\n### Added\n- Added `craft\\fields\\Matrix::EVENT_SET_FIELD_BLOCK_TYPES`. ([#4252](https://github.com/craftcms/cms/issues/4252))\n\n### Changed\n- Pressing <kbd>Shift</kbd> + <kbd>Return</kbd> (or <kbd>Shift</kbd> + <kbd>Ctrl</kbd>/<kbd>Command</kbd> + <kbd>Return</kbd>) when a textual cell is focused in an editable table will now change the focus to the same cell in the previous row (after creating a new row if necessary.) ([#4259](https://github.com/craftcms/cms/issues/4259))\n- Craft no longer shows the status menu for element sources that define a status. ([#4249](https://github.com/craftcms/cms/issues/4249))\n- Element URI formats can now conditionally output an empty string, opting the element out of getting its own system URI. ([#4254](https://github.com/craftcms/cms/issues/4254))\n- Table fields now get validation errors if any column handles are entered in the format of \u201ccolX\u201d.\n- Craft no longer clear out users\u2019 verification codes after login. ([#4257](https://github.com/craftcms/cms/issues/4257))\n- The `users/upload-user-photo` and `users/delete-user-photo` actions are now available to front-end requests. ([#3932](https://github.com/craftcms/cms/issues/3932))\n\n### Fixed\n- Fixed a bug where rebuilding the project config could set an incorrect value for the user field layout.\n- Fixed a bug Craft wouldn\u2019t allow users to edit their own photos if they didn\u2019t have upload/remove asset permissions.\n- Fixed a bug where Craft wasn\u2019t removing newline characters when pasting text into some single-line Table column types.\n- Fixed a bug where project config syncing could have inconsistent results on load-balanced environments. ([#4136](https://github.com/craftcms/cms/issues/4136))\n- Fixed a bug where the Plugin Store was not able to load developer details. ([#4241](https://github.com/craftcms/cms/issues/4241))\n- Fixed a bug that could occur when Craft generated URLs with multi-byte characters in the query string.\n- Fixed a bug where you could get some character encoding issues in some environments when using PHP 7.3.\n- Fixed a bug where Craft wasn\u2019t attempting to set a unique URI on duplicated elements. ([#4253](https://github.com/craftcms/cms/issues/4253))\n- Fixed a bug where Table fields could copy cell values to other cells if a column had a handle in the format of \u201ccolX\u201d. ([#4200](https://github.com/craftcms/cms/issues/4200))\n- Fixed an error that could occur on the Login page if a custom Login Page Logo was selected. ([#4261](https://github.com/craftcms/cms/issues/4261))\n\n## 3.1.26 - 2019-05-08\n\n### Changed\n- The \u201cUpdate all\u201d button on the Updates utility is now shown even if the page contains some uninstallable updates. ([#4230](https://github.com/craftcms/cms/issues/4230))\n- Craft now stores the Default User Group\u2019s UID in the project config, in case the group\u2019s ID is different across environments.\n- `craft\\services\\Assets::EVENT_BEFORE_REPLACE_ASSET` event handlers can now change the filename of the replaced asset before it is saved.\n- Improved the performance of background jobs. ([#4219](https://github.com/craftcms/cms/pull/4219))\n- Improved the Plugin Store\u2019s screenshots with arrows for navigation and pinch-to-zoom capability for touch devices.\n\n### Fixed\n- Fixed an error that could occur when saving a Single section if one of its sites had been disabled.\n- Fixed an error that could occur when deleting a site.\n- Fixed a PHP compile error that could occur when paginating a query. ([#4208](https://github.com/craftcms/cms/pull/4208))\n- Fixed an error that could occur on the Settings \u2192 Users \u2192 Settings page if the project config was missing its `users` key. ([#4206](https://github.com/craftcms/cms/issues/4206))\n- Fixed a bug where Craft wasn\u2019t requiring email verification for new user accounts if the project config was missing its `users` key.\n- Fixed a bug where Craft wasn\u2019t eager-loading elements in the same site as the source element, if that was different than the currently requested site. ([#3954](https://github.com/craftcms/cms/issues/3954))\n\n## 3.1.25 - 2019-04-30\n\n### Added\n- Added the `|ascii` Twig filter. ([#4193](https://github.com/craftcms/cms/issues/4193))\n\n### Changed\n- Craft now registers its project config event handlers before loading plugins. ([#3943](https://github.com/craftcms/cms/issues/3943))\n- The Control Panel now uses jQuery 3.4.0. ([#4183](https://github.com/craftcms/cms/issues/4183))\n- `behavior` and `behaviors` are now reserved field handles. ([#4184](https://github.com/craftcms/cms/issues/4184))\n- The Updates utility no longer shows notices for expired plugins if no updates are actually available. ([#4186](https://github.com/craftcms/cms/issues/4186))\n\n### Fixed\n- Fixed an error where rebuilding the project config would not typecast the `propagateEntries` and `enableVersioning` section settings correctly. ([#3695](https://github.com/craftcms/cms/issues/3695))\n- Fixed a bug where the Edit Draft HUD would include the current site name in the default Draft Name value for multi-site entries. ([#4171](https://github.com/craftcms/cms/issues/4171))\n- Fixed a bug where resource requests could send a 500 response if the resource didn\u2019t exist. ([#4197](https://github.com/craftcms/cms/pull/4197))\n\n## 3.1.24 - 2019-04-23\n\n### Added\n- Added `craft\\services\\Fields::getFieldIdsByLayoutId()`.\n\n### Changed\n- Craft now correctly typecasts all core boolean and integer values saved to the project config. ([#3695](https://github.com/craftcms/cms/issues/3695))\n- Craft now saves new entry versions every time an entry is saved, unless it\u2019s being propagated or resaved.\n- `users/save-user` and `users/start-elevated-session` requests now check for a `currentPassword` body param in addition to `password`, when looking for the user\u2019s current password. ([#4169](https://github.com/craftcms/cms/issues/4169))\n- `craft\\services\\Path::getStoragePath()` now has a `$create` argument.\n- Updated Twig to 2.8.\n\n### Fixed\n- Fixed an error where re-saving a site would reset its sorting order. ([#4147](https://github.com/craftcms/cms/issues/4147))\n- Fixed a SQL error that could occur when updating to Craft 3.1. ([#3663](https://github.com/craftcms/cms/issues/3663))\n- Fixed an error that occurred when an SVG with `/` characters in its `id` attributes was passed to the `svg()` Twig function. ([#4155](https://github.com/craftcms/cms/issues/4155))\n- Fixed a bug where passing `:empty:` or `:notempty:` to a Matrix field param on an element query could return incorrect results for fields that had soft-deleted blocks. ([#4161](https://github.com/craftcms/cms/issues/4161))\n- Fixed a bug where Craft wasn\u2019t returning a `1` exit code for console requests if the server was running under PHP 7. ([#4153](https://github.com/craftcms/cms/issues/4153))\n- Fixed a \u201cWorld-writable config file 'my.cnf' is ignored\u201d warning that could occur when creating a database backup. ([#4163](https://github.com/craftcms/cms/pull/4163))\n- Fixed a bug where `craft\\services\\Elements::duplicateElements()` would only ignore non-safe attributes passed to the `$newAttributes` argument.\n- Fixed a bug where `craft\\elements\\db\\ElementQuery::exists()` and `offsetExists()` were ignoring cached query results.\n\n## 3.1.23 - 2019-04-16\n\n### Added\n- The `project-config/sync` command now has a `--force` option, which forces the project config to treat all preexisting config values as new. ([#4126](https://github.com/craftcms/cms/issues/4126))\n- Added `craft\\base\\LogTargetTrait`, which can be used by custom `log` components, to gain security and privacy features provided by Craft\u2019s built-in file target. ([#4127](https://github.com/craftcms/cms/pull/4127))\n\n### Changed\n- When creating a new site, global sets are now propagated to it before other element types. ([#3446](https://github.com/craftcms/cms/issues/3446))\n- Locked Twig down to 2.7, to avoid a bug in 2.8.0. ([twigphp/Twig#2942](https://github.com/twigphp/Twig/issues/2942))\n\n### Fixed\n- Fixed an error that occurred when installing a missing plugin from the Settings \u2192 Plugins page. ([#4140](https://github.com/craftcms/cms/issues/4140))\n- Fixed PHP type errors that could occur when calling some deprecated `craft.request` methods in templates. ([#4124](https://github.com/craftcms/cms/issues/4124))\n- Fixed performance issues that could occur where uploading GIFs in the Control Panel. ([#4131](https://github.com/craftcms/cms/pull/4131))\n- Fixed a bug where it wasn\u2019t possible to create a new global set with the same name or handle as a soft-deleted one. ([#4091](https://github.com/craftcms/cms/issues/4091))\n- Fixed a bug where pending users\u2019 verification codes were getting deleted if they were impersonated by an admin. ([#4130](https://github.com/craftcms/cms/issues/4130))\n\n## 3.1.22 - 2019-04-10\n\n### Added\n- Added `craft\\base\\ElementTrait::$resaving`, which indicates whether the element is currently being resaved via a `ResaveElements` job or a `resave` command. ([#3482](https://github.com/craftcms/cms/issues/3482))\n- Added `craft\\db\\Paginator::setPageResults()`. ([#4120](https://github.com/craftcms/cms/issues/4120))\n\n### Changed\n- Changed the way Craft updates search indexes, to reduce the likelihood of a deadlock. ([#3197](https://github.com/craftcms/cms/issues/3197))\n- Improved styles and behavior of the Plugin Store.\n- The Settings \u2192 Plugins page now notes which plugins are expired, with links to renew them on [id.craftcms.com](https://id.craftcms.com).\n- Improved the styling of info HUDs that contain long text or tables. ([#4107](https://github.com/craftcms/cms/pull/4107))\n\n### Fixed\n- Fixed a PHP error that could occur during asset indexing in some cases.\n- Fixed a bug where entry drafts weren\u2019t showing previous changes to Matrix fields on the draft. ([#4105](https://github.com/craftcms/cms/issues/4105))\n- Fixed a bug where `project.yaml` changes weren\u2019t always getting picked up. ([#4028](https://github.com/craftcms/cms/issues/4028))\n- Fixed a bug where the `project-config/rebuild` command would restore soft-deleted components. ([#4100](https://github.com/craftcms/cms/issues/4100))\n- Fixed a bug where the `project-config/sync` command was not performing schema checks.\n- Fixed an error that occurred when backing up the database if the database password contained a `$` character. ([#4115](https://github.com/craftcms/cms/issues/4115))\n\n## 3.1.21.1 - 2019-04-04\n\n### Fixed\n- Fixed a bug where underscores were getting stripped from element slugs. ([#4096](https://github.com/craftcms/cms/issues/4096))\n\n## 3.1.21 - 2019-04-03\n\n### Added\n- Added the `backup` command, which creates a new database backup. ([#4075](https://github.com/craftcms/cms/issues/4075))\n- Added the `queue/retry` command, which can be passed a failed job ID, or `all` to retry all failed jobs. ([#4072](https://github.com/craftcms/cms/issues/4072))\n- Added `craft\\queue\\Queue::retryAll()`.\n- Added `craft\\services\\sections::$autoResaveEntries`, which can be set to `false` from `config/app.php` to prevent Craft from auto-resaving entries after sections and entry types are updated. ([#3482](https://github.com/craftcms/cms/issues/3482))\n\n### Changed\n- It\u2019s now possible to double-click on asset sources to expand/collapse their subfolders. ([#4070](https://github.com/craftcms/cms/issues/4070))\n- Craft no longer auto-resaves entries after saving a section or entry type if nothing changed of any significance to entries. ([#3482](https://github.com/craftcms/cms/issues/3482))\n- Craft now formats filesizes using metric units (e.g. MB instead of MiB).\n- The updater is now capable of handling package name changes.\n- Craft now requires Yii 2.0.17.\n\n### Fixed\n- Fixed a bug where the Asset Indexes utility wasn\u2019t logging exceptions.\n- Fixed a SQL error that could occur when using the Asset Indexes utility, if any filenames contained 4+ byte characters.\n- Fixed a bug where entry queries could return duplicate results for any entries that belong to a section that has soft-deleted structures associated with it. ([#4066](https://github.com/craftcms/cms/issues/4066))\n- Fixed a bug where rebuilding project config would not work with Matrix fields with no block types. ([#4074](https://github.com/craftcms/cms/issues/4074)\n- Fixed an error that occurred when sending emails if the `testToEmailAddress` config setting was set. ([#4076](https://github.com/craftcms/cms/issues/4076))\n- Fixed a bug where it wasn\u2019t possible to pass the `--element-id` option on `resave/*` commands.\n- Fixed a bug where Matrix fields were including disabled blocks if any changes had been made to the Matrix block query params.\n- Fixed SQL errors that could occur if the table prefix had ever changed.\n\n## 3.1.20.1 - 2019-03-27\n\n### Fixed\n- Fixed an error that occurred when regenerating the project config, if there were any fields without settings. ([#4062](https://github.com/craftcms/cms/issues/4062))\n- Fixed an error that occurred when loading the `_includes/forms/date` template without passing a `value` variable. ([#4063](https://github.com/craftcms/cms/issues/4063))\n\n## 3.1.20 - 2019-03-27\n\n### Added\n- Added the `project-config/rebuild` console command.\n- Added the `verifyEmailSuccessPath` config setting.\n- Added the \u201cPrefix\u201d and \u201cSuffix\u201d settings for Number fields. ([#4055](https://github.com/craftcms/cms/issues/4055))\n- Added the \u201cMax Length\u201d setting for URL fields. ([#4019](https://github.com/craftcms/cms/issues/4019))\n- Added the `devMode` global Twig variable. ([#4038](https://github.com/craftcms/cms/issues/4038))\n- Added `craft\\config\\GeneralConfig::getVerifyEmailSuccessPath()`.\n- Added `craft\\events\\RebuildConfigEvent`.\n- Added `craft\\services\\ProjectConfig::rebuild()`.\n- Added `craft\\services\\Sections::pruneDeletedField()`.\n\n### Changed\n- Textareas within the Control Panel can now be manually vertically resized. ([#4030](https://github.com/craftcms/cms/issues/4030))\n- The Craft Support widget now includes a \u201cMore Resources\u201d section. ([#4058](https://github.com/craftcms/cms/issues/4058))\n- The `_includes/forms/text` Control Panel template now supports `step`, `min`, and `max` attributes.\n- Users without access to the Control Panel are now redirected according to the `verifyEmailSuccessPath` config setting after verifying a new email address. ([#1998](https://github.com/craftcms/cms/issues/1998))\n- The `_includes/forms/text` Control Panel template now supports passing `autocorrect: false` and `autocapitalize: false`, to disable autocorrect and auto-capitalization on iOS devices.\n- iOS autocorrect and auto-capitalization has been disabled for all core \u201cHandle\u201d and \u201cSlug\u201d fields in the Control Panel. ([#4009](https://github.com/craftcms/cms/issues/4009))\n- Number fields now format their values for element index tables. ([#4059](https://github.com/craftcms/cms/issues/4059))\n- When installing Craft using a `project.yaml`, Craft now backups the existing config to the config backup folder if there are errors. ([#4017](https://github.com/craftcms/cms/issues/4017))\n- Craft now prunes entry type layouts when deleting a field.\n- Craft no longer modifies the DSN string if set explicitly with the `dsn` database config setting.\n- Craft no longer throws an `InvalidConfigException` when the `dsn` database config setting is set and contains an unexpected parameter.\n\n### Fixed\n- Fixed a bug where Craft wasn\u2019t removing hyphens and other symbols from auto-generated asset titles. ([#4011](https://github.com/craftcms/cms/issues/4011))\n- Fixed a PHP error that occurred when calling `craft\\services\\EntryRevisions::getDraftById()` or `getVersionById()` for a draft/version that belonged to a soft-deleted entry. ([#4013](https://github.com/craftcms/cms/issues/4013))\n- Fixed a bug where Craft wasn\u2019t respecting the site selection for routes defined in Settings \u2192 Routes. ([#4021](https://github.com/craftcms/cms/issues/4021))\n- Fixed a bug where the `project-config/sync` command wasn\u2019t logging exceptions. ([#4015](https://github.com/craftcms/cms/issues/4015))\n- Fixed an error that occurred when attempting to use Live Preview with a pending user account. ([#4025](https://github.com/craftcms/cms/issues/4025))\n- Fixed an error when displaying a date input in the Control Panel if the value passed wasn\u2019t a `DateTime` object. ([#4041](https://github.com/craftcms/cms/issues/4041))\n- Fixed a PHP error that occurred when passing an array of `craft\\elements\\User` objects to `craft\\mail\\Message::setTo()`. ([#4048](https://github.com/craftcms/cms/issues/4048))\n- Fixed a bug where Craft was applying the `offset` param to both ends of the result set when paginating queries. ([#4052](https://github.com/craftcms/cms/issues/4052))\n- Fixed a PHP error that occurred if `true` or `false` was passed to the third argument of `craft\\db\\Command::upsert()`. ([#4054](https://github.com/craftcms/cms/pull/4054))\n- Fixed a bug where deleting fields via `project.yaml` could prevent other changes from being applied.\n- Fixed a bug where field UIDs could be overwritten in some cases.\n\n## 3.1.19 - 2019-03-19\n\n### Added\n- Added the `_includes/pagination` Control Panel template.\n- Added `craft\\db\\Paginator`.\n- Added `craft\\web\\twig\\variables\\Paginate::create()`.\n\n### Changed\n- The `{% paginate %}` tag now accepts any query object, not just element queries.\n- The `_includes/forms/autosuggest` template now has `data` and `methods` blocks that can be overridden by sub-templates to customize the autosuggest behavior.\n\n### Fixed\n- Fixed a bug where sidebar badge counts in the Control Panel were getting formatted with two decimals if the Intl extension wasn\u2019t loaded. ([#4002](https://github.com/craftcms/cms/issues/4002))\n- Fixed a bug where entry drafts would forget that certain field values had been cleared out, and continue using the live revision\u2019s content instead. ([#3981](https://github.com/craftcms/cms/issues/3981))\n- Fixed an error that occurred if a Table field was created with a Date or Time column and no rows in the Default Values setting. ([#4005](https://github.com/craftcms/cms/issues/4005))\n- Fixed a bug where Table fields would forget that they had been saved without any rows in the Default Values setting.\n- Fixed a SQL error that could occur when saving non-UTF-8 characters to the project config. ([#4007](https://github.com/craftcms/cms/issues/4007))\n\n## 3.1.18 - 2019-03-14\n\n### Added\n- Added `craft\\services\\Deprecator::$throwExceptions`. ([#3972](https://github.com/craftcms/cms/pull/3972))\n\n### Changed\n- `Craft::parseEnv()` will now boolean values for environment variables set to `true` or `false`. ([#3975](https://github.com/craftcms/cms/issues/3975))\n- Nested project config keys are no longer sorted alphabetically.\n- Craft now requires Twig 2.7+.\n\n### Fixed\n- Fixed a SQL error that occurred when using a token with a usage limit, if using PostgreSQL. ([#3969](https://github.com/craftcms/cms/issues/3969))\n- Fixed a bug where the Edit User page would forget user group selection changes if there was a validation error. ([#3971](https://github.com/craftcms/cms/issues/3971))\n- Fixed a bug where the updater would get an unexpected response when updating from 3.1.14 - 3.1.16 to 3.1.17+.\n- Fixed a bug where it wasn\u2019t possible to switch plugin editions when the `allowUpdates` config setting was disabled. ([#3987](https://github.com/craftcms/cms/issues/3987))\n- Fixed a bug where multiple consecutive newlines in field instructions would result in multiple `<br>` tags rather than new paragraphs.\n- Fixed a bug where Table fields weren\u2019t always remembering the sort order for their Default Values settings. ([#3947](https://github.com/craftcms/cms/issues/3947))\n- Fixed a bug where Table fields weren\u2019t always remembering the sort order for their Table Columns settings. ([#3997](https://github.com/craftcms/cms/issues/3997))\n\n## 3.1.17.2 - 2019-03-12\n\n### Changed\n- Craft now requires Twig 2.6.\n\n## 3.1.17.1 - 2019-03-08\n\n### Added\n- Added `craft\\helpers\\ArrayHelper::ensureNonAssociative()`.\n\n### Fixed\n- Fixed a bug where commercial plugin editions weren\u2019t showing up in the Plugin Store.\n- Fixed a bug where installing a plugin from the Plugin Store would not respect the selected edition.\n- Fixed a bug where plugins with free and commercial editions weren\u2019t getting license key inputs on the Setting \u2192 Plugins page.\n- Fixed a bug where the Setting \u2192 Plugins page wasn\u2019t linking plugins\u2019 edition badge to their page in the Plugin Store for plugins with free and commercial editions, if the free edition was currently active.\n\n## 3.1.17 - 2019-03-08\n\n### Changed\n- When installing Craft using a `project.yaml`, Craft now processes all sites before installing any plugins. ([craftcms/commerce#752](https://github.com/craftcms/commerce/issues/752))\n- The Plugin Store now shows \u201cReport an issue\u201d links on plugin screens.\n- The Plugin Store now includes a \u201cPackage Name\u201d section on plugin screens. ([#2757](https://github.com/craftcms/cms/issues/2757))\n- The Plugin Store now shows discounted upgrade prices for plugins when a lower edition is already licensed.\n- Craft now requires Yii 2.0.16.1.\n\n### Fixed\n- Fixed a bug where the `positionedBefore` element query param was not including direct ancestors in the results.\n- Fixed a bug where HTML in plugin-supplied field instructions was getting encoded. ([#3928](https://github.com/craftcms/cms/issues/3928))\n- Fixed a bug where Craft would prompt for a user\u2019s current password when registering a new user, even if they weren\u2019t assigning any groups or permissions to that user\n- Fixed a bug where asset indexing could yield inconsistent results in some cases. ([#3450](https://github.com/craftcms/cms/issues/3450))\n- Fixed a bug where the Plugin Store was showing info icons in the feature matrix of multi-edition plugins, even for features that didn\u2019t have an extended description.\n- Fixed a bug where entries weren\u2019t getting new versions when edited from element editor HUDs. ([#3959](https://github.com/craftcms/cms/issues/3959))\n\n## 3.1.16 - 2019-03-05\n\n### Added\n- The Plugin Store now shows Repository links on plugin screens.\n- Added the `create()` Twig function. ([#3921](https://github.com/craftcms/cms/pull/3921))\n- Added the `--type` option to the `resave/entries` command. ([#3939](https://github.com/craftcms/cms/issues/3939))\n- Added `craft\\helers\\Assets::getAllowedFileKinds()`.\n\n### Changed\n- Line breaks in field instructions now get converted to `<br>` tags. ([#3928](https://github.com/craftcms/cms/issues/3928))\n- Assets field settings no longer list file kinds that aren\u2019t allowed to be uploaded, per the `allowedFileExtensions` and `extraAllowedFileExtensions` config settings. ([#3917](https://github.com/craftcms/cms/issues/3917))\n- The `{% exit %}` tag now throws a more specific exception depending on the status code passed to it (e.g. `yii\\web\\NotFoundHttpException` for 404s). ([#3915](https://github.com/craftcms/cms/issues/3915))\n- `craft\\helpers\\MigrationHelper::dropAllIndexesOnTable()` is no longer deprecated.\n- The `--id` option on `resave/*` console commands is now named `--element-id`. ([#3940](https://github.com/craftcms/cms/issues/3940))\n- The `_includes/forms/autosuggest.html` template now supports passing `disabled: true`. ([#3925](https://github.com/craftcms/cms/issues/3925))\n\n### Fixed\n- Fixed a bug where Control Panel content areas weren\u2019t getting their bottom padding applied in Firefox. ([#3874](https://github.com/craftcms/cms/issues/3874))\n- Fixed a PHP error that occurred on the front-end if two routes defined in Settings \u2192 Routes had the same URI pattern. ([#3922](https://github.com/craftcms/cms/issues/3922))\n- Fixed a bug where Craft wasn\u2019t always preselecting the correct tab on Control Panel pages if the tab name contained non-ASCII characters. ([#3923](https://github.com/craftcms/cms/issues/3923))\n- Fixed a bug where the `--uid` option on `resave/*` console commands wasn\u2019t working. ([#3941](https://github.com/craftcms/cms/issues/3941))\n- Fixed a SQL error that could occur when running `resave/*` console commands.\n- Fixed a PHP error that occurred when calling the deprecated `getError()` method on a model that had no errors. ([#3934](https://github.com/craftcms/cms/issues/3934))\n- Fixed a bug where Craft wasn\u2019t sanitizing new asset subfolder names. ([#3689](https://github.com/craftcms/cms/issues/3689))\n- Fixed a bug where Table fields weren\u2019t remembering the sort order for their Default Values settings. ([#3947](https://github.com/craftcms/cms/issues/3947))\n\n## 3.1.15 - 2019-02-26\n\n### Added\n- Added the `resave/assets`, `resave/categories`, `resave/entries`, `resave/tags`, and `resave/users` console commands.\n\n### Changed\n- Craft now sends system messages authored for the same root language as the requested language, if an exact language match can\u2019t be found. ([#3888](https://github.com/craftcms/cms/issues/3888))\n- Element source definitions can now include a `badgeCount` key.\n- Login requests no longer enforce CSRF validation if someone is already logged in.\n- Craft now throws an `InvalidConfigException` when updating the project config if any unexpected data types are encountered.\n- The `testToEmailAddress` config setting can now be set to `false`. ([#3910](https://github.com/craftcms/cms/pull/3910))\n\n### Fixed\n- Fixed a bug where the System Messages utility wouldn\u2019t update message previews after editing a message for the primary site\u2019s language, if the user had a different preferred language selected.\n- Fixed a bug where structures weren\u2019t getting deleted and unassigned from their sections properly after converting a Structure section to a Channel or Single. ([#3895](https://github.com/craftcms/cms/issues/3895))\n- Really fixed a bug where Craft could update the `dateModified` value in the project config even when nothing had changed. ([#3792](https://github.com/craftcms/cms/issues/3792))\n- Fixed a bug where the Settings \u2192 Routes page wasn\u2019t listing routes in the user-defined order. ([#3892](https://github.com/craftcms/cms/issues/3892))\n- Fixed an error that occurred when viewing trashed entries, if the \u201cEntry Type\u201d column was shown and one of the trashed entries\u2019 entry types had been deleted. ([#3899](https://github.com/craftcms/cms/issues/3899))\n\n## 3.1.14 - 2019-02-21\n\n### Added\n- Added `craft\\helpers\\ProjectConfig::cleanupConfig()`.\n- Added `craft\\web\\Request::$maxPageNum`, which determines the maximum page number Craft should accept (100,000 by default). ([#3880](https://github.com/craftcms/cms/issues/3880))\n\n### Deprecated\n- Deprecated `craft\\mutex\\FileMutex`.\n\n### Fixed\n- Fixed a bug where Craft could update the `dateModified` value in the project config even when nothing had changed. ([#3792](https://github.com/craftcms/cms/issues/3792))\n- Fixed a SQL error that occurred when running the \u201cLocalizing relations\u201d task if using PostgreSQL. ([#3877](https://github.com/craftcms/cms/issues/3877))\n- Fixed a bug where file locking wasn\u2019t working on Windows. ([#3879](https://github.com/craftcms/cms/issues/3879))\n\n### Security\n- Fixed a bug where sensitive environment variable values weren\u2019t getting redacted correctly.\n\n## 3.1.13 - 2019-02-20\n\n### Added\n- Added `craft\\helpers\\StringHelper::replaceMb4()`.\n- Added `craft\\services\\ProjectConfig::defer()`.\n\n### Changed\n- The `users/login` and `users/logout` actions now include a `csrfTokenValue` key in JSON responses. ([#3858](https://github.com/craftcms/cms/issues/3858))\n- Craft no longer deletes search indexes when soft-deleting an element, until the element gets hard-deleted. ([#3863](https://github.com/craftcms/cms/issues/3863))\n- Updated Yii to 2.0.16.\n\n### Fixed\n- Fixed a bug where Craft could auto-place the `{{ beginBody() }}` and `{{ endBody() }}` tags in the wrong places.\n- Fixed a bug where Craft wasn\u2019t storing custom volume sort orders. ([#3764](https://github.com/craftcms/cms/issues/3764))\n- Fixed a SQL error that would occur when uploading a file with emojis in its name, if using MySQL. ([#3852](https://github.com/craftcms/cms/issues/3852))\n- Fixed a bug where Assets fields weren\u2019t respecting their View Mode setting when files were drag-uploaded to them. ([#3578](https://github.com/craftcms/cms/issues/3578))\n- Fixed a bug where asset queries\u2019 `kind` param wasn\u2019t working for custom file kinds defined by the `extraFileKinds` config setting, for file extensions that were already associated with another file kind. ([#3869](https://github.com/craftcms/cms/issues/3869))\n- Fixed a bug where `craft\\helpers\\FileHelper::sanitizeFilename()` could return inconsistent results.\n- Fixed an error that could occur when syncing `project.yaml` if it introduced a new Super Table field with a nested Matrix field.\n\n## 3.1.12 - 2019-02-15\n\n### Fixed\n- Fixed a bug where the `relatedTo` element query param could include results for elements that were related via soft-deleted Matrix blocks. ([#3846](https://github.com/craftcms/cms/issues/3846))\n- Fixed a bug where some search queries were not returning results when they should, if using MySQL.\n- Fixed an error that could occur when syncing `project.yaml` changes if the `allowAdminChanges` config setting was disabled. ([#3823](https://github.com/craftcms/cms/issues/3823))\n- Fixed an `InvalidConfigException` that was thrown if a user\u2019s photo was soft-deleted. ([#3849](https://github.com/craftcms/cms/issues/3849))\n\n## 3.1.11 - 2019-02-14\n\n### Added\n- Added `craft\\helpers\\UrlHelper::rootRelativeUrl()`.\n\n### Fixed\n- Fixed a bug where the Plugin Store wouldn\u2019t load if the `baseCpUrl` config setting was set to a URL with a different scheme than Craft believed the request had.\n- Fixed a validation error that would occur on non-required Checkboxes and Multi-select fields if no options were selected. ([#3844](https://github.com/craftcms/cms/issues/3844))\n- Fixed a validation error that would occur on Dropdown and Radio Buttons fields if the selected option\u2019s value was `0`. ([#3842](https://github.com/craftcms/cms/issues/3842))\n- Fixed a bug where the Value column for Checkboxes, Dropdown, Multi-select, and Radio Buttons fields\u2019 Options settings weren\u2019t auto-populating if the Option Label column was set to a number.\n- Fixed an error on the Settings \u2192 Users page if `users.photoVolumeUid` was not defined in the project config. ([#3303](https://github.com/craftcms/cms/issues/3303))\n\n## 3.1.10 - 2019-02-13\n\n### Changed\n- `craft\\helpers\\FileHelper::writeToFile()` now invalidates the OPcache for the file. ([#3838](https://github.com/craftcms/cms/pull/3838))\n- The `serve` command now uses `@webroot` as the default `docroot` option value. ([#3770](https://github.com/craftcms/cms/pull/3770))\n\n###\u00a0Fixed\n- Fixed a bug where the `users/save-user` action wasn\u2019t deleting user photos properly.\n- Fixed a bug where changes to Matrix block type fields\u2019 settings weren\u2019t always saving. ([#3832](https://github.com/craftcms/cms/issues/3832))\n- Fixed a bug where non-searchable fields were still getting search keywords stored when using the Search Indexes utility. ([#3837](https://github.com/craftcms/cms/issues/3837))\n\n## 3.1.9.1 - 2019-02-12\n\n### Fixed\n- Fixed a bug where `Craft::alias()` wasn\u2019t beginning the response string with an `@` character if no `@` was passed into `Craft::setAlias()` to begin with.\n- Fixed an error that could occur if there were any HTML entities in the project config.\n\n## 3.1.9 - 2019-02-12\n\n### Added\n- Added the `disabledPlugins` config setting. ([craftcms/webhooks#4](https://github.com/craftcms/webhooks/issues/4))\n- Added the `$language` argument to `craft\\helpers\\StringHelper::toAscii()`.\n- Added `craft\\validators\\SlugValidator::$language`.\n- Added `craft\\web\\twig\\variables\\Cp::getAsciiCharMap()`.\n\n### Changed\n- The operating system name & version are now shown in the System Report utility. ([#3784](https://github.com/craftcms/cms/issues/3784))\n- Craft\u2019s installer no longer applies the current `project.yaml` file if the installed schema version doesn\u2019t match the one in the file. ([#3783](https://github.com/craftcms/cms/issues/3783))\n- Control Panel settings no longer warn about using the `@web` alias, if it was defined by the `aliases` config setting. ([#3798](https://github.com/craftcms/cms/pull/3798))\n- The `clear-caches` console command now clears CP resource files if the `@webroot` alias was defined by the `aliases` config setting. ([#3787](https://github.com/craftcms/cms/issues/3787))\n- `craft\\models\\VolumeFolder::getVolume()` now throws an `InvalidConfigException` if its `$volumeId` property is set to an invalid volume ID, rather than returning `null`.\n- Craft now checks if all files in project config mapping are valid and regenerates the map if they are not.\n- Craft now auto-generates slugs using an ASCII char map based on the language of the current entry/category, rather than the logged-in user. ([#3820](https://github.com/craftcms/cms/issues/3820))\n\n### Fixed\n- Fixed a SQL error that could occur when deleting an asset. ([#3786](https://github.com/craftcms/cms/issues/3786))\n- Fixed an error that occurred when customizing element indexes if the `allowAdminChanges` config setting was disabled. ([#3788](https://github.com/craftcms/cms/issues/3788))\n- Fixed a bug where Checkboxes, Dropdown, Multi-select, and Radio Buttons fields wouldn\u2019t pass validation if the selected option value was `true` or `false`.\n- Fixed an error that occurred on the Settings \u2192 Plugins page, if there were any plugins in the database that weren\u2019t Composer-installed.\n- Fixed an error that could occur if an Assets field was configured to upload to a deleted volume. ([#3799](https://github.com/craftcms/cms/issues/3799))\n- Fixed a bug where sections\u2019 Default Status settings weren\u2019t always being respected. ([#3791](https://github.com/craftcms/cms/issues/3791))\n- Fixed a bug where only users with the \u201cEdit users\u201d user permission were allowed to upload a new user photo. ([#3735](https://github.com/craftcms/cms/issues/3735))\n- Fixed a bug where renaming a Matrix block type\u2019s handle would result in new content columns being created in the database, and existing Matrix blocks losing their content. ([#3809](https://github.com/craftcms/cms/issues/3809))\n- Fixed a SQL error that could occur when updating to Craft 3.1 if any system messages contained emoji characters.\n- Fixed an error that could occur when working with elements, if a site had been created earlier in the same request. ([#3824](https://github.com/craftcms/cms/issues/3824))\n\n## 3.1.8 - 2019-02-05\n\n### Changed\n- Craft now automatically logs users in after resetting their password, if the `autoLoginAfterAccountActivation` config setting is enabled.\n\n### Fixed\n- Fixed a bug where pressing the <kbd>Return</kbd> key on editable tables with a static number of rows would add a new row. ([#3765](https://github.com/craftcms/cms/issues/3765))\n- Fixed a bug where pressing the <kbd>Return</kbd> key on editable tables would select the next row\u2019s cell even if the cell was disabled.\n- Fixed a bug where pressing the <kbd>Return</kbd> key on an editable table wouldn\u2019t move the focus to the next row\u2019s sell if it had an `<input>` instead of a `<textarea>`.\n- Fixed an error that could occur in the Control Panel if any environment variable values began with an `@` character. ([#3769](https://github.com/craftcms/cms/issues/3769))\n- Fixed a bug where `craft\\helpers\\DateTimeHelper::toDateTime()` was mistaking year-only values for Unix timestamps. ([#3772](https://github.com/craftcms/cms/issues/3772))\n- Fixed an error that occurred when a non-admin user attempted to edit a system message, or when the `allowAdminChanges` config setting was disabled. ([#3775](https://github.com/craftcms/cms/issues/3775))\n- Fixed a bug where it was hard to see error notifications on pages with a licensing alert. ([#3776](https://github.com/craftcms/cms/issues/3776))\n- Fixed a JavaScript error that occurred when adding a new row to a custom editable table that contained a `time` column, if no rows existed on page load. ([#3780](https://github.com/craftcms/cms/issues/3780))\n\n## 3.1.7 - 2019-01-31\n\n### Added\n- Added all the things that came in [Craft 3.0.40](https://github.com/craftcms/cms/blob/master/CHANGELOG-v3.md#3040---2019-01-31).\n- Added `craft\\helpers\\FileHelper::canTrustMimeType()`.\n- Added `craft\\web\\UploadedFile::getMimeType()`.\n\n### Changed\n- The \u201cPort\u201d SMTP mail transport setting can now be set to an environment variable. ([#3740](https://github.com/craftcms/cms/issues/3740))\n- `craft\\web\\Controller::requireAdmin()` now has a `$requireAdminChanges` argument, which dictates whether the `allowAdminChanges` config setting must also be enabled (`true` by default).\n- The `project-config/sync` console command now creates a `project.yaml` file, if it\u2019s missing. ([#3736](https://github.com/craftcms/cms/issues/3736))\n- Querying for active users no longer excludes locked users.\n- `craft\\helpers\\FileHelper::getMimeType()` now returns `application/x-yaml` for `.yaml` and `.yml` files.\n- Updated Craft UI to 0.2.0.\n\n### Fixed\n- Fixed an error that occurred when updating to Craft 3.1 if a plugin or module was calling `craft\\records\\User::find()`.\n- Fixed a bug where cross-domain Live Preview requests could fail due to CORS restrictions.\n- Fixed a 403 error that would occur when an admin attempted to log in as another user on an environment where the `allowAdminChanges` config setting was disabled. ([#3749](https://github.com/craftcms/cms/issues/3749))\n- Fixed a bug where asset index toolbar items would be misaligned when searching in a volume or folder with subfolders.\n- Fixed a bug where asset indexes could show multiple view mode toggles if a different volume or subfolder was selected while at least one asset was checked. ([#3702](https://github.com/craftcms/cms/issues/3702))\n- Fixed a bug where Plugin Store screenshots were not showing properly. ([#3709](https://github.com/craftcms/cms/issues/3709))\n- Fixed a bug where zoomed Plugin Store screenshots would not close when hitting the browser\u2019s Back button. ([#3754](https://github.com/craftcms/cms/issues/3754))\n- Fixed a bug where the Plugin Store was not working properly when Dev Mode was enabled.\n\n### Security\n- User accounts are now locked after multiple failed password attempts in current-password modals, per the `maxInvalidLogins` config setting.\n- Users are no longer signed out of active sessions when their account becomes locked.\n- Database backup/restore exception messages now redact the database password when using PostgreSQL.\n\n## 3.1.6.1 - 2019-01-29\n\n### Fixed\n- Fixed an error that occurred when creating a Table field with a Date column. ([#3748](https://github.com/craftcms/cms/issues/3748))\n\n## 3.1.6 - 2019-01-29\n\n### Added\n- It\u2019s now possible to update disabled plugins.\n\n### Changed\n- `craft\\web\\Controller::requireAdmin()` now sends a 403 (Forbidden) response if the `allowAdminChanges` config setting has been set to `false`. ([#3728](https://github.com/craftcms/cms/issues/3728))\n- `craft\\helpers\\DateTimeHelper::toDateTime()` now supports passing an array with a `date` key set to the `YYYY-MM-DD` format, in addition to the current locale\u2019s short date format.\n- `craft\\helpers\\DateTimeHelper::toDateTime()` now supports passing an array with a `time` key set to the `HH:MM` format, in addition to the current locale\u2019s short time format.\n- `craft\\helpers\\DateTimeHelper::toDateTime()` now supports passing an array with a `datetime` key, which will be handled the same way strings passed to the method are handled (except that the `datetime` key can be paired with a `timezone` key).\n\n### Fixed\n- Fixed an error that occurred when using the `json_decode` filter. ([#3722](https://github.com/craftcms/cms/pull/3722))\n- Fixed a bug a bug where plugin screenshots in the Plugin Store were not rendering correctly. ([#3709](https://github.com/craftcms/cms/issues/3709))\n- Fixed an error where the `index-assets/one` and `index-assets/all` console commands were creating `.` folders in each volume.\n- Fixed a bug where the Settings \u2192 Plugins page was showing extra \u201cMissing\u201d rows for any unlicensed plugins that were Composer-installed but not Craft-installed. ([#3726](https://github.com/craftcms/cms/issues/3726))\n- Fixed an error that could occur when viewing trashed elements.\n- Fixed a bug where many system message translations were missing line breaks. ([#3737](https://github.com/craftcms/cms/issues/3737))\n- Fixed a bug where unparsed markdown code was present in the Control Panel error message displayed when the system was offline. ([#3746](https://github.com/craftcms/cms/issues/3746))\n\n## 3.1.5 - 2019-01-25\n\n### Changed\n- Control Panel settings that can be set to environment variables now show a tip about that if the value is not already set to an environment variable or alias.\n- Control Panel form fields can now be configured with a `tip` property, which will be displayed below the field.\n- Control Panel templates can now pass `suggestEnvVars: true` and `suggestAliases: true` to autosuggest fields, rather that supplying the `suggestions` array.\n\n### Fixed\n- Fixed a bug where the \u201cDuplicate\u201d action wasn\u2019t available on the Entries index page for non-admin users. ([#3705](https://github.com/craftcms/cms/issues/3705))\n- Fixed a bug where it wasn\u2019t possible to rename an asset\u2019s filename from the Assets index page. ([#3707](https://github.com/craftcms/cms/issues/3707))\n- Fixed an error that occurred when saving a user that had a first or last name set.\n- Fixed a bug where it wasn\u2019t possible to apply project config changes. ([#3713](https://github.com/craftcms/cms/issues/3713))\n- Fixed a bug where the Password field on SMTP and Gmail mail transport settings could be set to an encoded and encrypted password. ([#3699](https://github.com/craftcms/cms/issues/3699))\n- Fixed a bug where it was possible to remove the Primary Site status from the primary site, without offering a new primary site. ([#3720](https://github.com/craftcms/cms/issues/3720))\n- Fixed an error that could occur if PHP\u2019s `memory_limit` was set to a higher size (in bytes) than `PHP_INT_MAX`. ([#3717](https://github.com/craftcms/cms/issues/3717))\n\n### Security\n- Control Panel settings that can be set to an alias now show a warning if the current value begins with the `@web` alias.\n\n## 3.1.4 - 2019-01-24\n\n### Added\n- Added all the things that came in [Craft 3.0.38](https://github.com/craftcms/cms/blob/master/CHANGELOG-v3.md#3038---2019-01-24).\n- The System Name setting can now be set to an environment variable. ([#3529](https://github.com/craftcms/cms/issues/3529))\n- Added the `index-assets/one` console command, which can now be used to index a single subfolder.\n- Added `craft\\base\\ApplicationTrait::getSystemName()`.\n\n### Changed\n- Craft now ensures that installed schema versions match the schema versions in `project.yaml` before syncing project config changes.\n- The `project-config/sync` console command now bails if there are pending Craft or plugin migrations.\n\n### Fixed\n- Fixed a bug where `site` translations were falling back to English if the translated message was identical to the source message. ([#3692](https://github.com/craftcms/cms/issues/3692))\n- Fixed a bug where syncing Matrix field changes to the project config would result in new changes to the project config. ([#3695](https://github.com/craftcms/cms/issues/3695))\n- Fixed an error that occurred when indexing assets in an empty volume.\n- Fixed a bug where soft-deleted assets would show up as missing after indexing.\n- Fixed a JavaScript error that could occur on the Settings \u2192 Plugins page.\n- Fixed a bug where `Craft::parseEnv()` was throwing an `InvalidConfigException` if the given string began with `@` but was not an alias. ([#3700](https://github.com/craftcms/cms/issues/3700))\n\n### Security\n- URLs are no longer allowed in users\u2019 first or last names.\n\n## 3.1.3 - 2019-01-21\n\n### Added\n- Added the `|json_decode` Twig filter.  ([#3678](https://github.com/craftcms/cms/pull/3678))\n\n### Fixed\n- Fixed an error that occurred when updating to Craft 3.1 if a plugin or module was calling any soft-deletable records\u2019 `find()` methods.\n- Fixed an error that occurred when updating from Craft 2 to Craft 3.1 if there were any RichText fields. ([#3677](https://github.com/craftcms/cms/issues/3677))\n- Fixed a bug where it was possible to create duplicate tags by searching for and selecting the same tag name twice in the same Tags field. ([#3676](https://github.com/craftcms/cms/issues/3676))\n- Fixed a bug where system messages were getting sent with the message keys (e.g. \u201cforgot_password_subject\u201d and \u201cforgot_password_body\u201d) if Craft didn\u2019t provide a default message translation for the site language, and the message hadn\u2019t been translated for the user\u2019s preferred language. ([#3673](https://github.com/craftcms/cms/issues/3673))\n- Fixed a bug where `craft\\web\\Request::getIsLivePreview()` was returning `false` on Live Preview requests when called from an `yii\\base\\Controller::EVENT_BEFORE_ACTION` event handler. ([#3680](https://github.com/craftcms/cms/issues/3680))\n\n## 3.1.2.2 - 2019-01-19\n\n### Fixed\n- Fixed an error that occurred when updating to Craft 3.1 if a plugin or module was calling any `craft\\services\\Sections` methods.\n\n## 3.1.2.1 - 2019-01-19\n\n### Fixed\n- Fixed an error that occurred when updating to Craft 3.1 if there were any Matrix sub-fields that had their type set to a non-existing class. ([#3662](https://github.com/craftcms/cms/issues/3662))\n- Fixed a bug where the project config could be in an unexpected state if a `project.yaml` file existed already when initially updating to Craft 3.1.\n\n## 3.1.2 - 2019-01-18\n\n### Added\n- Added the `index-assets <volume>` and `index-assets/all` console commands. ([#3595](https://github.com/craftcms/cms/pull/3595))\n- Added `craft\\base\\FieldTrait::$oldSettings`.\n- Added `craft\\helpers\\Install`.\n- Added `craft\\services\\Fields::prepFieldForSave()`.\n- Added `craft\\services\\Path::getProjectConfigFilePath()`.\n- Added `craft\\services\\ProjectConfig::$muteEvents`.\n\n### Changed\n- The installer now checks `project.yaml` when determining the default site name, handle, base URL, and language values. ([#3661](https://github.com/craftcms/cms/issues/3661))\n- The Base URL field in the web-based installer now autouggests environment variable names and aliases.\n- Craft now creates a `.gitignore` file in the `storage/config-backups/` folder, preventing any other files within it from getting tracked by Git.\n- Craft no longer prevents changes in `project.yaml` from being synced if a plugins\u2019 schema version in `project.yaml` doesn\u2019t match up with its installed schema version, if one of them is blank.\n\n### Deprecated\n- Deprecated `craft\\services\\Fields::$ignoreProjectConfigChanges`.\n- Deprecated `craft\\services\\Matrix::$ignoreProjectConfigChanges`.\n\n### Fixed\n- Fixed a PHP notice that occurred when updating to Craft 3.1 if there were any plugins installed without settings.\n- Fixed a SQL error that occurred when updating to Craft 3.1 if a plugin or module was calling any `craft\\services\\Fields` methods. ([#3663](https://github.com/craftcms/cms/issues/3663))\n- Fixed a bug where element indexes would forget their source settings after updating to Craft 3.1. ([#3659](https://github.com/craftcms/cms/issues/3659))\n- Fixed a bug where commercial plugins weren\u2019t installable from the Plugin Store.\n- Fixed a bug where Matrix block type fields\u2019 `beforeSave()` methods weren\u2019t getting called.\n- Fixed a bug where Matrix fields could forget their content table name if they were created with a non-global context.\n- Fixed a bug where links to the Plugin Store from Settings \u2192 Plugins were 404ing. ([#3664](https://github.com/craftcms/cms/issues/3664))\n- Fixed a bug where soft-deleted sections and entry types were still showing up in the Control Panel. ([#3648](https://github.com/craftcms/cms/issues/3648))\n- Fixed a bug where an update to Craft 3.1 would fail with a database error in some scenarios.\n- Fixed a bug where Plugin Store\u2019s Try buttons would appear as disabled when they should be enabled. ([#3619](https://github.com/craftcms/cms/issues/3619))\n- Fixed an error that occurred when updating to Craft 3.1 if there were any relational fields that were missing some expected settings. ([#3641](https://github.com/craftcms/cms/issues/3641))\n\n### Security\n- Fixed two XSS vulnerabilities.\n\n## 3.1.1 - 2019-01-16\n\n### Added\n- Added support for the `CRAFT_LOG_PHP_ERRORS` PHP constant. ([#3619](https://github.com/craftcms/cms/issues/3619))\n- Added `craft\\web\\User::generateToken()`.\n\n### Changed\n- System error message templates no longer parse exception messages as Markdown.\n\n### Fixed\n- Fixed a bug where `craft\\services\\Volumes::getVolumeByHandle()` wasn\u2019t working. ([#3633](https://github.com/craftcms/cms/pull/3633))\n- Fixed a bug where the `clear-caches/cp-resources` command could clear out the wrong directory if the `resourceBasePath` config setting began with `@webroot`. ([#3637](https://github.com/craftcms/cms/issues/3637))\n- Fixed a bug where eager-loading Matrix blocks would come up empty. ([#3644](https://github.com/craftcms/cms/issues/3644))\n- Fixed an error that occurred when updating to Craft 3.1 if there were any Matrix blocks without any sub-fields. ([#3635](https://github.com/craftcms/cms/pull/3635))\n- Fixed an error that occurred when updating to Craft 3.1 if there were any Matrix block types left over from a Matrix field that had been converted to something else.\n- Fixed an error that occurred when updating to Craft 3.1 if there were any Assets fields that were missing some expected field settings. ([#3641](https://github.com/craftcms/cms/issues/3641))\n- Fixed an error that occurred when updating to Craft 3.1 if anything was calling `craft\\services\\Fields::getLayoutById()` or `getLayoutByType()` before the update was applied.\n- Fixed an error that could occur when logging deprecation errors on PostgreSQL. ([#3638](https://github.com/craftcms/cms/issues/3638))\n- Fixed a bug where users would get logged out while updating to Craft 3.1, causing a \u201cUser is not permitted to perform this action\u201d error.\n- Fixed a bug where \u201cJavaScript must be enabled\u201d and \u201cCookies must be enabled\u201d messages weren\u2019t getting positioned correctly. ([#3639](https://github.com/craftcms/cms/issues/3639))\n- Fixed a \u201cVariable \"message\" does not exist.\u201d error that could occur in the Control Panel.\n- Fixed a bug where free plugins weren\u2019t installable from the Plugin Store. ([#3642](https://github.com/craftcms/cms/issues/3642))\n\n### Security\n- The Request panel in the Debug Toolbar now redacts any sensitive information. ([#3619](https://github.com/craftcms/cms/issues/3619))\n- Fixed two XSS vulnerabilities.\n\n## 3.1.0 - 2019-01-15\n\n> {warning} This is a more complex update than usual, and failed update attempts are not uncommon. Please ensure you have a recent database backup, and we recommend you test the update on a local/staging environment before updating your production server.\n\n### Added\n- Added the Project Config, a portable and centralized configuration for system settings. ([#1429](https://github.com/craftcms/cms/issues/1429)) \n- Category groups, elements, entry types, field layouts, global sets, sections, sites, site groups, structures, tag groups, and volumes are now soft-deleted. ([#867](https://github.com/craftcms/cms/issues/867))\n- Entries, categories, and users can now be restored within the Control Panel by selecting \u201cTrashed\u201d from the status menu on element index pages, and clicking the \u201cRestore\u201d button.\n- Added the System Messages utility for editing system messages, replacing the Settings \u2192 Email \u2192 System Messages page. ([#3421](https://github.com/craftcms/cms/issues/3421))\n- Some Site settings (Base URL), volume settings (Base URL and File System Path), and email settings (System Email Address, Sender Name, HTML Email Template, Username, Password, and Host Name) can now be set to environment variables using a `$VARIABLE_NAME` syntax. ([#3219](https://github.com/craftcms/cms/issues/3219))\n- The installer now checks whether a `project.yaml` file exists and applies any changes in it. ([#3291](https://github.com/craftcms/cms/issues/3291))\n- Control Panel settings that support environment variables now autosuggest environment variable names (and aliases when applicable) while typing.\n- Control Panel settings that define a template path now autosuggest existing template files.\n- Added cross-domain support for Live Preview. ([#1521](https://github.com/craftcms/cms/issues/1521))\n- Plugins can now have multiple editions.\n- Custom fields can now opt out of being included in elements\u2019 search keywords. ([#2600](https://github.com/craftcms/cms/issues/2600))\n- Added the `allowAdminChanges` config setting.\n- Added the `softDeleteDuration` config setting.\n- Added the `storeUserIps` config setting. ([#3311](https://github.com/craftcms/cms/issues/3311))\n- Added the `useProjectConfigFile` config setting.\n- Added the `gc` console command, which can be used to run garbage collection tasks.\n- Added the `project-config/sync` console command. ([#3510](https://github.com/craftcms/cms/issues/3510))\n- Added the `trashed` element query param, which can be used to query for elements that have been soft-deleted.\n- Added the `expression()` Twig function, for creating new `yii\\db\\Expression` objects in templates. ([#3289](https://github.com/craftcms/cms/pull/3289))\n- Added the `parseEnv()` Twig function.\n- Added the `plugin()` Twig function.\n- Added the `_includes/forms/autosuggest.html` include template for the Control Panel. \n- Added `Craft::parseEnv()`.\n- Added `craft\\base\\ApplicationTrait::getIsLive()`.\n- Added `craft\\base\\Element::EVENT_AFTER_RESTORE`.\n- Added `craft\\base\\Element::EVENT_BEFORE_RESTORE`.\n- Added `craft\\base\\Element::EVENT_DEFINE_EAGER_LOADING_MAP`.\n- Added `craft\\base\\ElementInterface::afterRestore()`.\n- Added `craft\\base\\ElementInterface::beforeRestore()`.\n- Added `craft\\base\\Field::EVENT_AFTER_ELEMENT_RESTORE`.\n- Added `craft\\base\\Field::EVENT_BEFORE_ELEMENT_RESTORE`.\n- Added `craft\\base\\FieldInterface::afterElementRestore()`.\n- Added `craft\\base\\FieldInterface::beforeElementRestore()`.\n- Added `craft\\base\\Model::EVENT_DEFINE_RULES`.\n- Added `craft\\base\\Plugin::editions()`.\n- Added `craft\\base\\Plugin::is()`.\n- Added `craft\\base\\SavableComponentInterface::beforeApplyDelete()`.\n- Added `craft\\behaviors\\EnvAttributeParserBehavior`.\n- Added `craft\\controllers\\LivePreviewController`.\n- Added `craft\\db\\ActiveRecord::prepareForDb()`.\n- Added `craft\\db\\Command::restore()`.\n- Added `craft\\db\\Command::softDelete()`.\n- Added `craft\\db\\Migration::restore()`.\n- Added `craft\\db\\Migration::softDelete()`.\n- Added `craft\\db\\SoftDeleteTrait`, which can be used by Active Record classes that wish to support soft deletes.\n- Added `craft\\db\\Table`.\n- Added `craft\\elements\\actions\\Restore`, which can be included in elements\u2019 `defineActions()` methods to opt into element restoration.\n- Added `craft\\events\\ConfigEvent`.\n- Added `craft\\events\\DeleteElementEvent`, which provides a `$hardDelete` property that can be set to `true` to force an element to be immediately hard-deleted. ([#3403](https://github.com/craftcms/cms/pull/3403))\n- Added `craft\\helpers\\App::editionHandle()`.\n- Added `craft\\helpers\\App::editionIdByHandle()`.\n- Added `craft\\helpers\\App::mailSettings()`.\n- Added `craft\\helpers\\ArrayHelper::firstWhere()`.\n- Added `craft\\helpers\\Db::idByUid()`.\n- Added `craft\\helpers\\Db::idsByUids()`.\n- Added `craft\\helpers\\Db::uidById()`.\n- Added `craft\\helpers\\Db::uidsByIds()`.\n- Added `craft\\helpers\\ProjectConfig`.\n- Added `craft\\helpers\\StringHelper::toWords()`.\n- Added `craft\\models\\FieldLayout::createFromConfig()`.\n- Added `craft\\models\\FieldLayout::getConfig()`.\n- Added `craft\\models\\Section::setEntryTypes()`.\n- Added `craft\\models\\Site::getBaseUrl()`.\n- Added `craft\\services\\AssetTransforms::getTransformByUid()`.\n- Added `craft\\services\\AssetTransforms::EVENT_BEFORE_APPLY_TRANSFORM_DELETE`.\n- Added `craft\\services\\Categories::getGroupByUid()`.\n- Added `craft\\services\\Categories::EVENT_BEFORE_APPLY_GROUP_DELETE`.\n- Added `craft\\services\\Elements::restoreElement()`.\n- Added `craft\\services\\Elements::EVENT_AFTER_RESTORE_ELEMENT`.\n- Added `craft\\services\\Elements::EVENT_BEFORE_RESTORE_ELEMENT`.\n- Added `craft\\services\\Fields::applyFieldDelete()`.\n- Added `craft\\services\\Fields::applyFieldSave()`.\n- Added `craft\\services\\Fields::createFieldConfig()`.\n- Added `craft\\services\\Fields::deleteFieldInternal()`.\n- Added `craft\\services\\Fields::restoreLayoutById()`.\n- Added `craft\\services\\Fields::saveFieldInternal()`.\n- Added `craft\\services\\Fields::EVENT_BEFORE_APPLY_FIELD_DELETE`.\n- Added `craft\\services\\Fields::EVENT_BEFORE_APPLY_GROUP_DELETE`.\n- Added `craft\\services\\Gc` for handling garbage collection tasks.\n- Added `craft\\services\\Path::getConfigBackupPath()`.\n- Added `craft\\services\\ProjectConfig`.\n- Added `craft\\services\\Routes::deleteRouteByUid()`\n- Added `craft\\services\\Sections::getSectionByUid()`.\n- Added `craft\\services\\Sections::EVENT_BEFORE_APPLY_ENTRY_TYPE_DELETE`.\n- Added `craft\\services\\Sections::EVENT_BEFORE_APPLY_SECTION_DELETE`.\n- Added `craft\\services\\Sites::restoreSiteById()`.\n- Added `craft\\services\\Sites::EVENT_BEFORE_APPLY_GROUP_DELETE`.\n- Added `craft\\services\\Sites::EVENT_BEFORE_APPLY_SITE_DELETE`.\n- Added `craft\\services\\Tags::EVENT_BEFORE_APPLY_GROUP_DELETE`.\n- Added `craft\\services\\UserGroups::EVENT_BEFORE_APPLY_GROUP_DELETE`.\n- Added `craft\\services\\Volumes::EVENT_BEFORE_APPLY_VOLUME_DELETE`.\n- Added `craft\\validators\\TemplateValidator`.\n- Added `craft\\web\\Controller::requireCpRequest()`.\n- Added `craft\\web\\Controller::requireSiteRequest()`.\n- Added `craft\\web\\twig\\variables\\Cp::EVENT_REGISTER_CP_SETTINGS`. ([#3314](https://github.com/craftcms/cms/issues/3314))\n- Added `craft\\web\\twig\\variables\\Cp::getEnvSuggestions()`.\n- Added `craft\\web\\twig\\variables\\Cp::getTemplateSuggestions()`.\n- Added the ActiveRecord Soft Delete Extension for Yii2.\n- Added the Symfony Yaml Component.\n- The bundled Vue asset bundle now includes Vue-autosuggest.\n\n### Changed\n- The `defaultWeekStartDay` config setting is now set to `1` (Monday) by default, to conform with the ISO 8601 standard.\n- Renamed the `isSystemOn` config setting to `isSystemLive`.\n- The `app/migrate` web action now applies pending `project.yaml` changes, if the `useProjectConfigFile` config setting is enabled.\n- The `svg()` function now strips `<title>`, `<desc>`, and comments from the SVG document as part of its sanitization process.\n- The `svg()` function now supports a `class` argument, which will add a class name to the root `<svg>` node. ([#3174](https://github.com/craftcms/cms/issues/3174))\n- The `{% redirect %}` tag now supports `with notice` and `with error` params for setting flash messages. ([#3625](https://github.com/craftcms/cms/pull/3625))\n- `info` buttons can now also have a `warning` class.\n- User permission definitions can now include `info` and/or `warning` keys.\n- The old \u201cAdministrate users\u201d permission has been renamed to \u201cModerate users\u201d.\n- The old \u201cChange users\u2019 emails\u201d permission has been renamed to \u201cAdministrate users\u201d, and now comes with the ability to activate user accounts and reset their passwords. ([#942](https://github.com/craftcms/cms/issues/942))  \n- All users now have the ability to delete their own user accounts. ([#3013](https://github.com/craftcms/cms/issues/3013))\n- System user permissions now reference things by their UIDs rather than IDs (e.g. `editEntries:<UID>` rather than `editEntries:<ID>`).\n- Animated GIF thumbnails are no longer animated. ([#3110](https://github.com/craftcms/cms/issues/3110))\n- Craft Tokens can now be sent either as a query string param (named after the `tokenParam` config setting) or an `X-Craft-Token` header.\n- Element types that support Live Preview must now hash the `previewAction` value for `Craft.LivePreview`.\n- Live Preview now loads each new preview into its own `<iframe>` element. ([#3366](https://github.com/craftcms/cms/issues/3366))\n- Assets\u2019 default titles now only capitalize the first word extracted from the filename, rather than all the words. ([#2339](https://github.com/craftcms/cms/issues/2339))\n- All console commands besides `setup/*` and `install/craft` now output a warning if Craft isn\u2019t installed yet. ([#3620](https://github.com/craftcms/cms/issues/3620))\n- All classes that extend `craft\\base\\Model` now have `EVENT_INIT` and `EVENT_DEFINE_BEHAVIORS` events; not just classes that extend `craft\\base\\Component`.\n- `craft\\db\\mysql\\Schema::findIndexes()` and `craft\\db\\pgsql\\Schema::findIndexes()` now return arrays with `columns` and `unique` keys.\n- `craft\\helpers\\ArrayHelper::filterByValue()` now defaults its `$value` argument to `true`.\n- `craft\\helpers\\MigrationHelper::doesIndexExist()` no longer has a `$foreignKey` argument, and now has an optional `$db` argument.\n- `craft\\mail\\Mailer::send()` now swallows any exceptions that are thrown when attempting to render the email HTML body, and sends the email as plain text only. ([#3443](https://github.com/craftcms/cms/issues/3443))\n- `craft\\mail\\Mailer::send()` now fires an `afterSend` event with `yii\\mail\\MailEvent::$isSuccessful` set to `false` if any exceptions were thrown when sending the email, and returns `false`. ([#3443](https://github.com/craftcms/cms/issues/3443))\n- `craft\\services\\Routes::saveRoute()` now expects site and route UIDs instead of IDs.\n- `craft\\services\\Routes::updateRouteOrder()` now expects route UIDs instead of IDs.\n- The `craft\\helpers\\Assets::EVENT_SET_FILENAME` event is now fired after sanitizing the filename.\n\n### Removed\n- Removed `craft\\elements\\User::authData()`.\n- Removed `craft\\fields\\Matrix::getOldContentTable()`.\n- Removed `craft\\services\\Routes::deleteRouteById()`\n\n### Deprecated\n- Deprecated `craft\\base\\ApplicationTrait::getIsSystemOn()`. `getIsLive()` should be used instead.\n- Deprecated `craft\\helpers\\MigrationHelper::dropAllIndexesOnTable()`.\n- Deprecated `craft\\helpers\\MigrationHelper::dropAllUniqueIndexesOnTable()`.\n- Deprecated `craft\\helpers\\MigrationHelper::dropIndex()`.\n- Deprecated `craft\\helpers\\MigrationHelper::restoreForeignKey()`.\n- Deprecated `craft\\helpers\\MigrationHelper::restoreIndex()`.\n- Deprecated `craft\\models\\Info::getEdition()`. `Craft::$app->getEdition()` should be used instead.\n- Deprecated `craft\\models\\Info::getName()`. `Craft::$app->projectConfig->get('system.name')` should be used instead.\n- Deprecated `craft\\models\\Info::getOn()`. `Craft::$app->getIsLive()` should be used instead.\n- Deprecated `craft\\models\\Info::getTimezone()`. `Craft::$app->getTimeZone()` should be used instead.\n- Deprecated `craft\\services\\Routes::getDbRoutes()`. `craft\\services\\Routes::getProjectConfigRoutes()` should be used instead.\n- Deprecated `craft\\services\\SystemSettings`. `craft\\services\\ProjectConfig` should be used instead.\n- Deprecated `craft\\validators\\UrlValidator::$allowAlias`. `craft\\behaviors\\EnvAttributeParserBehavior` should be used instead.\n\n### Fixed\n- Fixed a bug where the Dashboard could rapidly switch between two column sizes at certain browser sizes. ([#2438](https://github.com/craftcms/cms/issues/2438))\n- Fixed a bug where ordered and unordered lists in field instructions didn\u2019t have numbers or bullets.\n- Fixed a bug where switching an entry\u2019s type could initially show the wrong field layout tab. ([#3600](https://github.com/craftcms/cms/issues/3600))\n- Fixed an error that occurred when updating to Craft 3 if there were any Rich Text fields without any stored settings.\n- Fixed a bug where Craft wasn\u2019t saving Dashboard widget sizes properly on PostgreSQL. ([#3609](https://github.com/craftcms/cms/issues/3609))\n- Fixed a PHP error that could occur if the primary site didn\u2019t have a base URL. ([#3624](https://github.com/craftcms/cms/issues/3624))\n- Fixed a bug where `craft\\helpers\\MigrationHelper::dropIndexIfExists()` wasn\u2019t working if the index had an unexpected name.\n- Fixed an error that could occur if a plugin attempted to register the same Twig extension twice in the same request.\n\n### Security\n- The web and CLI installers no longer suggest `@web` for the site URL, and now attempt to save the entered site URL as a `DEFAULT_SITE_URL` environment variable in `.env`. ([#3559](https://github.com/craftcms/cms/issues/3559))\n- Craft now destroys all other sessions associated with a user account when a user changes their password.\n- It\u2019s no longer possible to spoof Live Preview requests.\n\n## 3.0.41.1 - 2019-03-12\n\n### Changed\n- Craft now requires Twig 2.6.\n\n## 3.0.41 - 2019-02-22\n\n### Changed\n- System error message templates no longer parse exception messages as Markdown.\n\n### Security\n- Database backup/restore exception messages now redact the database password when using PostgreSQL.\n- URLs are no longer allowed in users\u2019 first or last names.\n- The Request panel in the Debug Toolbar now redacts any sensitive information. ([#3619](https://github.com/craftcms/cms/issues/3619))\n- Fixed XSS vulnerabilities.\n\n## 3.0.40.1 - 2019-02-21\n\n### Fixed\n- Fixed a bug where Craft wasn\u2019t always aware of plugin licensing issues. ([#3876](https://github.com/craftcms/cms/issues/3876))\n\n## 3.0.40 - 2019-01-31\n\n### Added\n- Added `craft\\helpers\\App::testIniSet()`.\n\n### Changed\n- Craft now warns if `ini_set()` is disabled and [memory_limit](http://php.net/manual/en/ini.core.php#ini.memory-limit) is less than `256M` or [max_execution_time](http://php.net/manual/en/info.configuration.php#ini.max-execution-time) is less than `120` before performing Composer operations.\n- `craft\\helpers\\App::maxPowerCaptain()` now attempts to set the `memory_limit` to `1536M` rather than `-1`.\n\n## 3.0.39 - 2019-01-29\n\n### Changed\n- It\u2019s now possible to update disabled plugins.\n\n### Fixed\n- Fixed an error that could occur if PHP\u2019s `memory_limit` was set to a higher size (in bytes) than `PHP_INT_MAX`. ([#3717](https://github.com/craftcms/cms/issues/3717))\n\n## 3.0.38 - 2019-01-24\n\n### Added\n- Added the `update` command, which can be used to [update Craft from the terminal](https://docs.craftcms.com/v3/updating.html#updating-from-the-terminal).\n- Craft now warns if PHP is running in Safe Mode with a [max_execution_time](http://php.net/manual/en/info.configuration.php#ini.max-execution-time) of less than 120 seconds, before performing Composer operations.\n- Craft now stores backups of `composer.json` and `composer.lock` files in `storage/composer-backups/` before running Composer operations.\n- Added `craft\\db\\Connection::getBackupFilePath()`.\n- Added `craft\\helpers\\App::phpConfigValueInBytes()`.\n- Added `craft\\helpers\\Console::isColorEnabled()`.\n- Added `craft\\helpers\\Console::outputCommand()`.\n- Added `craft\\helpers\\Console::outputWarning()`.\n- Added `craft\\helpers\\FileHelper::cycle()`.\n- Added `craft\\services\\Composer::$maxBackups`.\n- Added `craft\\services\\Path::getComposerBackupsPath()`.\n\n### Changed\n- The `migrate/all` console command now supports a `--no-content` argument that can be passed to ignore pending content migrations.\n- Craft now attempts to disable PHP\u2019s memory and time limits before running Composer operations.\n- Craft no longer respects the `phpMaxMemoryLimit` config setting if PHP\u2019s `memory_limit` setting is already set to `-1` (no limit).\n- Craft now respects Composer\u2019s [classmap-authoritative](https://getcomposer.org/doc/06-config.md#classmap-authoritative) config setting.\n- Craft now links to the [Troubleshooting Failed Updates](https://craftcms.com/guides/failed-updates) guide when an update fails.\n- `craft\\services\\Composer::install()` can now behave like the `composer install` command, if `$requirements` is `null`.\n- `craft\\services\\Composer::install()` now has a `$whitelist` argument, which can be set to an array of packages to whitelist, or `false` to disable the whitelist.\n\n## 3.0.37 - 2019-01-08\n\n### Added\n- Routes defined in the Control Panel can now have a `uid` token, and URL rules defined in `config/routes.php` can now have a `{uid}` token. ([#3583](https://github.com/craftcms/cms/pull/3583))\n- Added the `extraFileKinds` config setting. ([#1584](https://github.com/craftcms/cms/issues/1584))\n- Added the `clear-caches` console command. ([#3588](https://github.com/craftcms/cms/pull/3588))\n- Added `craft\\feeds\\Feeds::getFeed()`.\n- Added `craft\\helpers\\StringHelper::UUID_PATTERN`.\n\n### Changed\n- Pressing the <kbd>Return</kbd> key (or <kbd>Ctrl</kbd>/<kbd>Command</kbd> + <kbd>Return</kbd>) when a textual cell is focused in an editable table will now change the focus to the same cell in the next row (after creating a new row if necessary.) ([#3576](https://github.com/craftcms/cms/issues/3576))\n- The Password input in the web-based Craft setup wizard now has a \u201cShow\u201d button like other password inputs.\n- The Feed widget now sets the items\u2019 text direction based on the feed\u2019s language.\n- Matrix blocks that contain validation errors now have red titles and alert icons, to help them stand out when collapsed. ([#3599](https://github.com/craftcms/cms/issues/3599))\n\n### Fixed\n- Fixed a bug where the \u201cEdit\u201d button on asset editor HUDs didn\u2019t launch the Image Editor if the asset was being edited on another element type\u2019s index page. ([#3575](https://github.com/craftcms/cms/issues/3575))\n- Fixed an exception that would be thrown when saving a user from a front-end form with a non-empty `email` or `newPassword` param, if the `password` param was missing or empty. ([#3585](https://github.com/craftcms/cms/issues/3585))\n- Fixed a bug where global set, Matrix block, tag, and user queries weren\u2019t respecting `fixedOrder` params.\n- Fixed a bug where `craft\\helpers\\MigrationHelper::renameColumn()` was only restoring the last foreign key for each table that had multiple foreign keys referencing the table with the renamed column.\n- Fixed a bug where Date/Time fields could output the wrong date in Live Preview requests. ([#3594](https://github.com/craftcms/cms/issues/3594))\n- Fixed a few RTL language styling issues.\n- Fixed a bug where drap-and-drop uploading would not work for custom asset selector inputs. ([#3590](https://github.com/craftcms/cms/pull/3590))\n- Fixed a bug where Number fields weren\u2019t enforcing thein Min Value and Max Value settings if set to 0. ([#3598](https://github.com/craftcms/cms/issues/3598))\n- Fixed a SQL error that occurred when uploading assets with filenames that contained emoji characters, if using MySQL. ([#3601](https://github.com/craftcms/cms/issues/3601))\n\n### Security\n- Fixed a directory traversal vulnerability.\n- Fixed a remote code execution vulnerability.\n\n## 3.0.36 - 2018-12-18\n\n### Added\n- Added the `{{ actionInput() }}` global Twig function. ([#3566](https://github.com/craftcms/cms/issues/3566))\n\n### Changed\n- Suspended users are no longer shown when viewing pending or locked users. ([#3556](https://github.com/craftcms/cms/issues/3556))\n- The Control Panel\u2019s Composer installer now prevents scripts defined in `composer.json` from running. ([#3574](https://github.com/craftcms/cms/issues/3574))\n\n### Fixed\n- Fixed a bug where elements that belonged to more than one structure would be returned twice in element queries.\n\n### Security\n- Fixed a self-XSS vulnerability in the Recent Entries widget.\n- Fixed a self-XSS vulnerability in the Feed widget.\n\n## 3.0.35 - 2018-12-11\n\n### Added\n- Added `craft\\models\\Section::getHasMultiSiteEntries()`.\n\n### Changed\n- Field types that extend `craft\\fields\\BaseRelationField` now pass their `$sortable` property value to the `BaseElementSelectInput` JavaScript class by default. ([#3542](https://github.com/craftcms/cms/pull/3542))\n\n### Fixed\n- Fixed a bug where the \u201cDisabled for Site\u201d entry status option was visible for sections where site propagation was disabled. ([#3519](https://github.com/craftcms/cms/issues/3519))\n- Fixed a bug where saving an entry that was disabled for a site would retain its site status even if site propagation had been disabled for the section.\n- Fixed a SQL error that occurred when saving a field layout with 4-byte characters (like emojis) in a tab name. ([#3532](https://github.com/craftcms/cms/issues/3532))\n- Fixed a bug where autogenerated Post Date values could be a few hours off when saving new entries with validation errors. ([#3528](https://github.com/craftcms/cms/issues/3528))\n- Fixed a bug where plugins\u2019 minimum version requirements could be enforced even if a development version of a plugin had been installed previously.\n\n## 3.0.34 - 2018-12-04\n\n### Fixed\n- Fixed a bug where new Matrix blocks wouldn\u2019t remember that they were supposed to be collapsed if \u201cSave and continue editing\u201d was clicked. ([#3499](https://github.com/craftcms/cms/issues/3499))\n- Fixed an error that occurred on the System Report utility if any non-bootstrapped modules were configured with an array or callable rather than a string. ([#3507](https://github.com/craftcms/cms/issues/3507))\n- Fixed an error that occurred on pages with date or time inputs, if the user\u2019s preferred language was set to Arabic. ([#3509](https://github.com/craftcms/cms/issues/3509))\n- Fixed a bug where new entries within sections where site propagation was disabled would show both \u201cEnabled Globally\u201d and \u201cEnabled for [Site Name]\u201d settings. ([#3519](https://github.com/craftcms/cms/issues/3519))\n- Fixed a bug where Craft wasn\u2019t reducing the size of elements\u2019 slugs if the resulting URI was over 255 characters. ([#3514](https://github.com/craftcms/cms/issues/3514))\n\n## 3.0.33 - 2018-11-27\n\n### Changed\n- Table fields with a fixed number of rows no longer show Delete buttons or the \u201cAdd a row\u201d button. ([#3488](https://github.com/craftcms/cms/issues/3488))\n- Table fields that are fixed to a single row no longer show the Reorder button. ([#3488](https://github.com/craftcms/cms/issues/3488))\n- Setting `components.security.sensitiveKeywords` in `config/app.php` will now append keywords to the default array `craft\\services\\Security::$sensitiveKeywords` array, rather than completely overriding it.\n- When performing an action that requires an elevated session while impersonating another user, admin must now enter their own password instead of the impersonated user\u2019s. ([#3487](https://github.com/craftcms/cms/issues/3487))\n- The System Report utility now lists any custom modules that are installed. ([#3490](https://github.com/craftcms/cms/issues/3490))\n- Control Panel charts now give preference to `ar-SA` for Arabic locales, `de-DE` for German locales, `en-US` for English locales, `es-ES` for Spanish locales, or `fr-FR` for French locales, if data for the exact application locale doesn\u2019t exist. ([#3492](https://github.com/craftcms/cms/pull/3492))\n- \u201cCreate a new child entry\u201d and \u201cCreate a new child category\u201d element actions now open an edit page for the same site that was selected on the index page. ([#3496](https://github.com/craftcms/cms/issues/3496))\n- The default `allowedFileExtensions` config setting value now includes `webp`.\n- The Craft Support widget now sends `composer.json` and `composer.lock` files when contacting Craft Support.\n- It\u2019s now possible to create element select inputs that include a site selection menu by passing `showSiteMenu: true` when including the `_includes/forms/elementSelect.html` Control Panel include template. ([#3494](https://github.com/craftcms/cms/pull/3494))\n\n### Fixed\n- Fixed a bug where a Matrix fields\u2019 block types and content table could be deleted even if something set `$isValid` to `false` on the `beforeDelete` event.\n- Fixed a bug where a global sets\u2019 field layout could be deleted even if something set `$isValid` to `false` on the `beforeDelete` event.\n- Fixed a bug where after impersonating another user, the Login page would show the impersonated user\u2019s username rather than the admin\u2019s.\n- Fixed a bug where `craft\\services\\Sections::getAllSections()` could return stale results if a new section had been added recently. ([#3484](https://github.com/craftcms/cms/issues/3484))\n- Fixed a bug where \u201cView entry\u201d and \u201cView category\u201d element actions weren\u2019t available when viewing a specific section or category group.\n- Fixed a bug where Craft would attempt to index image transforms.\n- Fixed a bug where the Asset Indexes utility could report that asset files were missing even though they weren\u2019t. ([#3450](https://github.com/craftcms/cms/issues/3450))\n\n### Security\n- Updated jQuery File Upload to 9.28.0.\n\n## 3.0.32 - 2018-11-20\n\n### Added\n- The `seq()` Twig function now has a `next` argument, which can be set to `false` to have it return the current number in the sequence without incrementing it. ([#3466](https://github.com/craftcms/cms/issues/3466))\n- Added `craft\\db\\MigrationManager::truncateHistory()`.\n- Added `craft\\helpers\\Sequence::current()`.\n\n### Changed\n- Edit Entry pages now show the entry\u2019s site in the revision menu label so long as the section is enabled for multiple sites, even if \u201cPropagate entries across all enabled sites?\u201d isn\u2019t checked. ([#3471](https://github.com/craftcms/cms/issues/3471))\n- Exact-match search terms (using `::`) now disable `subLeft` and `subRight` attributes by default, regardless of the `defaultSearchTermOptions` config setting says. ([#3474](https://github.com/craftcms/cms/issues/3474))\n\n### Deprecated\n- Deprecated `craft\\validators\\StringValidator::$trim`. Yii\u2019s `'trim'` validator should be used instead.\n\n### Fixed\n- Fixed an error that occurred when querying for Matrix blocks if both the `with` and `indexBy` parameters were set.\n- Fixed an error that occurred when running the `migrate/fresh` console command. ([#3472](https://github.com/craftcms/cms/issues/3472))\n\n## 3.0.31 - 2018-11-13\n\n### Added\n- Added the `seq()` Twig function, for outputting sequential numbers.\n- Added `craft\\helpers\\Sequence`.\n\n### Changed\n- Control Panel templates can now customize `#main-form` HTML attributes by overriding the `mainFormAttributes` block. ([#1665](https://github.com/craftcms/cms/issues/1665))\n- The default PostgreSQL backup command no longer includes database owner, privilege or ACL information in the backup.\n- Craft now attempts to reset OPcache after installing/uninstalling things with Composer. ([#3460](https://github.com/craftcms/cms/issues/3460))\n- Gmail and SMTP mail transport types now trim whitespace off of their Username, Password, and Host Name settings. ([#3459](https://github.com/craftcms/cms/issues/3459))\n\n### Fixed\n- Fixed an error that could occur when duplicating an element with a Matrix field with \u201cManage blocks on a per-site basis\u201d disabled.\n- Fixed a bug where Matrix blocks wouldn\u2019t retain their content translations when an entry was duplicated from the Edit Entry page.\n- Fixed a bug where system message modals could have the wrong language selected by default. ([#3440](https://github.com/craftcms/cms/issues/3440))\n- Fixed a bug where an Internal Server Error would occur if a `users/login` request was missing the `loginName` or `password` parameters. ([#3458](https://github.com/craftcms/cms/issues/3458))\n- Fixed a bug where `craft\\validators\\StringValidator` was trimming whitespace off of strings _after_ performing string length validation.\n- Fixed an infinite recursion bug that could occur if `config/general.php` had any deprecated config settings, and the database connection settings were invalid.\n- Fixed an error that occurred when saving a new entry or category, if its URI format referenced the `level` attribute. ([#3465](https://github.com/craftcms/cms/issues/3465))\n\n## 3.0.30.2 - 2018-11-08\n\n### Fixed\n- Fixed an error that could occur on servers running PHP 7.0.32. ([#3453](https://github.com/craftcms/cms/issues/3453))\n\n## 3.0.30.1 - 2018-11-07\n\n### Fixed\n- Fixed an error that occurred when saving an element with a new Matrix block, if the Matrix field was set to manage blocks on a per-site basis. ([#3445](https://github.com/craftcms/cms/issues/3445))\n\n## 3.0.30 - 2018-11-06\n\n### Added\n- Added \u201cDuplicate\u201d and \u201cDuplicate (with children)\u201d actions to the Entries and Categories index pages. ([#1291](https://github.com/craftcms/cms/issues/1291))\n- Added `craft\\base\\ElementAction::$elementType`, which element action classes can use to reference their associated element type.\n- Added `craft\\elements\\actions\\DeepDuplicate`.\n- Added `craft\\elements\\actions\\Duplicate`.\n- Added `craft\\elements\\actions\\SetStatus::$allowDisabledForSite`, which can be used by localizable element types to enable a \u201cDisabled for Site\u201d status option.\n\n### Changed\n- Entries\u2019 \u201cEnabled\u201d setting is now labeled \u201cEnabled Globally\u201d on multi-site installs. ([#2899](https://github.com/craftcms/cms/issues/2899))\n- Entries\u2019 \u201cEnabled for site\u201d setting now includes the site name in its label, and only shows up if the \u201cEnabled Globally\u201d setting is checked. ([#2899](https://github.com/craftcms/cms/issues/2899))\n- The Set Status action on the Entries index page now includes a \u201cDisabled for Site\u201d option. ([#2899](https://github.com/craftcms/cms/issues/2899))\n- Edit Category pages now have `edit-category` and `site--<SiteHandle>` classes on the `<body>`. ([#3439](https://github.com/craftcms/cms/issues/3439))\n- Edit Entry pages now have `edit-entry` and `site--<SiteHandle>` classes on the `<body>`. ([#3439](https://github.com/craftcms/cms/issues/3439))\n- Edit Global Set pages now have `edit-global-set` and `site--<SiteHandle>` classes on the `<body>`. ([#3439](https://github.com/craftcms/cms/issues/3439))\n- Edit User pages now have an `edit-user` class on the `<body>`. ([#3439](https://github.com/craftcms/cms/issues/3439))\n\n### Fixed\n- Fixed a bug where the Edit User page could forget which permissions were selected when saving a user with validation errors, if the Username, First Name, and Last name fields were all blank. ([#3412](https://github.com/craftcms/cms/issues/3412))\n- Fixed a bug where the Edit User Group page could forget which permissions were selected when saving a user group with validation errors, if the Name field was blank.\n- Fixed a bug where the `{% paginate %}` tag wasn\u2019t factoring the `offset` element query param into its total page calculation. ([#3420](https://github.com/craftcms/cms/issues/3420))\n\n### Security\n- Fixed a bug where sensitive info could be displayed in the Craft log files if there was a problem connecting to the email server.\n\n## 3.0.29 - 2018-10-30\n\n### Added\n- Email and URL fields now have \u201cPlaceholder Text\u201d settings. ([#3397](https://github.com/craftcms/cms/issues/3397))\n\n### Changed\n- The default HTML Purifier configuration now allows `download` attributes in `<a>` tags. ([craftcms/redactor#86](https://github.com/craftcms/redactor/issues/86))\n\n### Fixed\n- Fixed a bug where the `ContentBehaviour` and `ElementQueryBehavior` classes could be missing some field properties. ([#3400](https://github.com/craftcms/cms/issues/3400))\n- Fixed a bug where some fields within Matrix fields could lose their values after enabling the \u201cManage blocks on a per-site basis\u201d setting. ([verbb/super-table#203](https://github.com/verbb/super-table/issues/203))\n- Fixed a bug where HTML Purifier wasn\u2019t being initialized with HTML 5 element support.\n- Fixed a bug where it was possible to save Assets fields with the \u201cRestrict allowed file types?\u201d setting enabled, but no specific file types selected. ([#3410](https://github.com/craftcms/cms/issues/3410))\n\n## 3.0.28 - 2018-10-23\n\n### Added\n- Structure sections now have the ability to disable entry propagation, like Channel sections. ([#2386](https://github.com/craftcms/cms/issues/2386))\n\n### Changed\n- `craft\\base\\Field::supportedTranslationMethods()` now defaults to only returning `none` if the field type doesn\u2019t have a content column. ([#3385](https://github.com/craftcms/cms/issues/3385))\n- Craft.EntryTypeSwitcher now fires a `beforeTypeChange` event before swapping the Edit Entry form tabs. ([#3375](https://github.com/craftcms/cms/pull/3375))\n- Craft.MatrixInput now fires an `afterInit` event after initialization. ([#3375](https://github.com/craftcms/cms/pull/3375))\n- Craft.MatrixInput now fires an `blockAdded` event after adding a new block. ([#3375](https://github.com/craftcms/cms/pull/3375))\n- System messages sent from front-end requests are now sent using the current site\u2019s language. ([#3388](https://github.com/craftcms/cms/issues/3388))\n\n### Fixed\n- Fixed an error that could occur when acquiring a lock for a file path, if the `mutex` component was swapped out with `yii\\mutex\\MysqlMutex`.\n\n## 3.0.27.1 - 2018-10-12\n\n### Fixed\n- Fixed an error that occurred when deleting an entry from the Edit Entry page. ([#3372](https://github.com/craftcms/cms/issues/3372))\n- Fixed an error that could occur when changing a Channel section to Structure. ([#3373](https://github.com/craftcms/cms/issues/3373))\n- Fixed an error that occurred when saving Matrix content from console requests.\n\n## 3.0.27 - 2018-10-11\n\n### Added\n- Added `craft\\helpers\\MigrationHelper::findForeignKey()`.\n- Added the `cp.globals.edit` and `cp.globals.edit.content` template hooks to the Edit Global Set page. ([#3356](https://github.com/craftcms/cms/pull/3356))\n\n### Changed\n- It\u2019s now possible to load a Create Entry page with a specific user preselected in the Author field, using a new `authorId` query string param. ([#3326](https://github.com/craftcms/cms/pull/3326))\n- Matrix fields that are set to manage blocks on a per-site basis will now duplicate Matrix blocks across all of the owner element\u2019s supported sites when the element is first created. ([#3082](https://github.com/craftcms/cms/issues/3082))\n- Disabled Matrix blocks are no longer visible when sharing an entry draft or version. ([#3338](https://github.com/craftcms/cms/issues/3338))\n- Control Panel tabs that have errors now have alert icons.\n- The Debug Toolbar is no longer shown in Live Preview iframes.\n- The Plugin Store now requires browsers with ES6 support.\n- Updated jQuery Touch Events to 2.0.0.\n- Updated Garnish to 0.1.29.\n\n### Fixed\n- Fixed a bug where enabling the \u201cPropagate entries across all enabled sites?\u201d setting for an existing Channel section (or converting the section to a Structure) wouldn\u2019t update entries that had been created for the non-primary site.\n- Fixed a bug where Craft wasn\u2019t detecting and retrying queue jobs that had timed out.\n- Fixed a bug where `Craft::$app->locale` could return the wrong locale during Live Preview requests. ([#3336](https://github.com/craftcms/cms/issues/3336))\n- Fixed a SQL error that could occur when upgrading to Craft 3, if a foreign key had an unexpected name.\n- Fixed a bug where page titles in the Control Panel could be blank when showing validation errors for things that were missing their name or title. ([#3344](https://github.com/craftcms/cms/issues/3344))\n- Fixed an error that could occur if a component\u2019s settings were stored as `null`. ([#3342](https://github.com/craftcms/cms/pull/3342))\n- Fixed a bug where details panes weren\u2019t visible on browser windows sized between 999 and 1,223 pixels wide.\n- Fixed an error that occurred if a Quick Post widget contained a Matrix field that had Min Blocks set and only had one block type.\n- Fixed a bug where disabled Matrix blocks were getting validated as live. ([#3354](https://github.com/craftcms/cms/issues/3354))\n- Fixed a bug where the `EVENT_AFTER_ACTIVATE_USER` event wasn\u2019t getting triggered on user registration when email verification isn\u2019t required. ([craftcms/commerce-digital-products#18](https://github.com/craftcms/commerce-digital-products/issues/18))\n- Added garbage collection for offline storage of remote assets. ([#3335](https://github.com/craftcms/cms/pull/3335))\n- Fixed a bug where Twig could end up in a strange state if an error occurred when preparing to render an object template. ([#3364](https://github.com/craftcms/cms/issues/3364))\n\n### Security\n- The `svg()` Twig function no longer sanitizes SVGs or namespaces their IDs or class names by default when a file path (or alias) was passed in. ([#3337](https://github.com/craftcms/cms/issues/3337))\n\n## 3.0.26.1 - 2018-09-29\n\n### Changed\n- Changed the `yiisoft/yii2-queue` version requirement to `2.1.0`. ([#3332](https://github.com/craftcms/cms/issues/3332))\n\n## 3.0.26 - 2018-09-29\n\n### Changed\n- `ancestors`, `descendants`, `nextSibling`, `parent`, and `prevSibling` are now reserved field handles.\n- The `svg()` Twig function namespaces class names in addition to IDs now.\n- Changed the `yiisoft/yii2-queue` version requirement to `2.0.1`. ([#3332](https://github.com/craftcms/cms/issues/3332))\n\n### Fixed\n- Fixed a validation error that could occur when saving an entry as a new entry if the URI format didn\u2019t contain a `{slug}` tag. ([#3320](https://github.com/craftcms/cms/issues/3320))\n- Fixed a SQL error that could occur if a deprecation error occurred when attempting to upgrade a Craft 2 project. ([#3324](https://github.com/craftcms/cms/issues/3324))\n\n## 3.0.25 - 2018-09-18\n\n### Added\n- Added `craft\\log\\FileTarget::$includeUserIp` which determines whether users\u2019 IP addresses should be included in the logs (`false` by default). ([#3310](https://github.com/craftcms/cms/pull/3310))\n\n### Fixed\n- Fixed an error that could occur when installing or updating something within the Control Panel if `composer.json` required the `roave/security-advisories` package.\n- Fixed a SQL error that could occur when searching elements on PostgreSQL installs.\n- Fixed a bug where Craft would ignore the last segment of template paths that ended in `/0`. ([#3304](https://github.com/craftcms/cms/issues/3304))\n- Fixed a Twig Template Loading Error that would occur when testing email settings, if a custom email template was used and an error occurred when rendering it. ([#3309](https://github.com/craftcms/cms/issues/3309))\n\n## 3.0.24 - 2018-09-11\n\n### Added\n- Added the `extraAppLocales` config setting.\n\n### Changed\n- The `defaultCpLanguage` config setting no longer needs to be a language that Craft is translated into, as long as it is a valid locale ID.\n- Resave Elements jobs that are queued up after saving an entry type now include the section name in the job description. ([#3290](https://github.com/craftcms/cms/issues/3290))\n- Updated Garnish to 0.1.28.\n\n### Fixed\n- Fixed a SQL error that could occur when an element query\u2019s `orderBy` parameter was set to `dateCreated` or `dateUpdated`.\n- Fixed an error that could occur when updating to v3.0.23+ if multiple Matrix fields existed with the same handle, but they had no content tables, somehow.\n- Fixed a bug where links in activation and forgot-password emails weren\u2019t hyperlinked, leaving it up to the mail client to hopefully be smart about it. ([#3288](https://github.com/craftcms/cms/issues/3288))\n\n## 3.0.23.1 - 2018-09-04\n\n### Fixed\n- Fixed a bug where Matrix fields would get new content tables each time they were saved.\n\n## 3.0.23 - 2018-09-04\n\n### Changed\n- Browser-based form validation is now disabled for page forms. ([#3247](https://github.com/craftcms/cms/issues/3247))\n- `craft\\base\\Model::hasErrors()` now supports passing an attribute name with a `.*` suffix, which will return whether any errors exist for the given attribute or any nested model attributes.\n- Added `json` to the default `allowedFileExtensions` config setting value. ([#3254](https://github.com/craftcms/cms/issues/3254))\n- Exception call stacks now collapse internal Twig methods by default.\n- Twig exception call stacks now show all of the steps leading up to the error.\n- Live Preview now reloads the preview pane automatically after an asset is saved from the Image Editor. ([#3265](https://github.com/craftcms/cms/issues/3265))\n\n### Deprecated\n- Deprecated `craft\\services\\Matrix::getContentTableName()`. `craft\\fields\\Matrix::$contentTable` should be used instead.\n\n### Removed\n- Removed `craft\\services\\Matrix::getParentMatrixField()`.\n\n### Fixed\n- Fixed a bug where element selection modals could be initialized without a default source selected, if some of the sources were hidden for not being available on the currently-selected site. ([#3227](https://github.com/craftcms/cms/issues/3227))\n- Fixed a bug where edit pages for categories, entries, global sets, and users weren\u2019t revealing which tab(s) had errors on it, if the errors occurred within a Matrix field. ([#3248](https://github.com/craftcms/cms/issues/3248))\n- Fixed a SQL error that occurred when saving a Matrix field with new sub-fields on PostgreSQL. ([#3252](https://github.com/craftcms/cms/issues/3252))\n- Fixed a bug where custom user fields weren\u2019t showing up on the My Account page when running Craft Solo edition. ([#3228](https://github.com/craftcms/cms/issues/3228))\n- Fixed a bug where multiple Matrix fields could share the same content table. ([#3249]())\n- Fixed a \u201ccache is corrupted\u201d Twig error that could occur when editing or saving an element if it had an Assets field with an unresolvable subfolder path template. ([#3257](https://github.com/craftcms/cms/issues/3257))\n- Fixed a bug where the Dev Mode indicator strip wasn\u2019t visible on Chrome/Windows when using a scaled display. ([#3259](https://github.com/craftcms/cms/issues/3259))\n- Fixed a SQL error that could occur when validating an attribute using `craft\\validators\\UniqueValidator`, if the target record\u2019s `find()` method joined in another table.\n\n## 3.0.22 - 2018-08-28\n\n### Changed\n- The \u201cDeleting stale template caches\u201d job now ensures all expired template caches have been deleted before it begins processing the caches.\n- Text inputs\u2019 `autocomplete` attributes now get set to `off` by default, and they will only not be added if explicitly set to `null`.\n- Improved the error response when Composer is unable to perform an update due to a dependency conflict.\n- Email fields in the Control Panel now have `type=\"email\"`.\n- `craft\\helpers\\Db::parseParam()` now has a `$caseInnensitive` argument, which can be set to `true` to force case-insensitive conditions on PostgreSQL installs.\n- `craft\\validators\\UniqueValidator` now has a `$caseInsensitive` property, which can be set to `true` to cause the unique validation to be case-insensitive on PostgreSQL installs.\n- The CLI setup wizard now detects common database connection errors that occur with MAMP, and automatically retests with adjusted settings.\n- The CLI setup wizard now detects common database authentication errors, and lets the user retry the username and password settings, skipping the others.\n- Updated Garnish to 0.1.27.\n\n### Fixed\n- Fixed a bug where Craft wasn\u2019t reverting `composer.json` to its original state if something went wrong when running a Composer update.\n- Fixed a bug where string casing functions in `craft\\helpers\\StringHelper` were adding extra hyphens to strings that came in as `Upper-Kebab-Case`.\n- Fixed a bug where unique validation for element URIs, usernames, and user email address was not case-insensitive on PostgreSQL installs.\n- Fixed a bug where element queries\u2019 `uri` params, and user queries\u2019 `firstName`, `lastName`, `username`, and `email` params, were not case-insensitive on PostgreSQL installs.\n- Fixed a bug where the CLI setup wizard was allowing empty database names.\n- Fixed a bug where it wasn\u2019t possible to clear template caches if template caching was disabled by the `enableTemplateCaching` config setting. ([#3229](https://github.com/craftcms/cms/issues/3229))\n- Fixed a bug where element index toolbars weren\u2019t staying fixed to the top of the content area when scrolling down the page. ([#3233](https://github.com/craftcms/cms/issues/3233))\n- Fixed an error that could occur when updating Craft if the system was reliant on the SSL certificate provided by the`composer/ca-bundle` package.\n\n## 3.0.21 - 2018-08-21\n\n### Added\n- Most element query parameters can now be set to `['not', 'X', 'Y']`, as a shortcut for `['and', 'not X', 'not Y']`.\n\n### Changed\n- The \u201cNew Password\u201d input on the My Account page now has a \u201cShow\u201d button, like other password inputs in the Control Panel.\n- Plugin settings pages now redirect to the Settings index page after save. ([#3216](https://github.com/craftcms/cms/issues/3216))\n- It\u2019s now possible to set [autofill detail tokens](https://html.spec.whatwg.org/multipage/form-control-infrastructure.html#autofill-detail-tokens) on the `autocomplete` variable when including the `_includes/forms/text.html` template (e.g. `'name'`).\n- Username and password inputs now have the correct `autocomplete` values, increasing the likelihood that tools like 1Password will handle the form correctly. ([#3207](https://github.com/craftcms/cms/issues/3207))\n\n### Fixed\n- Fixed a SQL error that occurred when saving a user if a `craft\\elements\\User::EVENT_BEFORE_SAVE` event listener was setting `$event->isValid = false`. ([#3206](https://github.com/craftcms/cms/issues/3206))\n- Fixed a bug where password inputs\u2019 jQuery data was getting erased when the \u201cShow\u201d button was clicked.\n- Fixed an error that could occur when upgrading to Craft 3. ([#3208](https://github.com/craftcms/cms/pull/3208))\n- Fixed a bug where non-image assets\u2019 file extension icons could bleed out of the preview area within asset editor HUDs. ([#3209](https://github.com/craftcms/cms/issues/3209))\n- Fixed a bug where Craft wasn\u2019t saving a new entry version when reverting an entry to a previous version. ([#3210](https://github.com/craftcms/cms/issues/3210))\n- Fixed an error that could occur when a Matrix block was saved by a queue job. ([#3217](https://github.com/craftcms/cms/pull/3217))\n\n### Security\n- External links in the Control Panel now set `rel=\"noopener\"`. ([#3201](https://github.com/craftcms/cms/issues/3201))\n\n## 3.0.20 - 2018-08-14\n\n### Added\n- Added `craft\\services\\Fields::refreshFields()`.\n\n### Fixed\n- Fixed a bug where `DateTime` model attributes were getting converted to ISO-8601 date strings for `craft\\web\\View::renderObjectTemplate()`. ([#3185](https://github.com/craftcms/cms/issues/3185))\n- Fixed a bug where timepicker menus had a higher z-index than session expiration modal shades. ([#3186](https://github.com/craftcms/cms/issues/3186))\n- Fixed a bug where users could not log in after upgrading to Craft 3, if there was a custom field named `owner`.\n- Fixed a bug where it was not possible to set non-integer values on asset queries\u2019 `width`, `height`, or `size` params. ([#3195](https://github.com/craftcms/cms/issues/3195))\n- Fixed a bug where all Asset folders were being initiated at once, resulting in performance issues.\n\n## 3.0.19 - 2018-08-07\n\n### Added\n- Added the `craft.query()` template function, for creating new database queries.\n- Added `craft\\services\\Structures::mutexTimeout`. ([#3148](https://github.com/craftcms/cms/issues/3148))\n- Added `craft\\services\\Api::getComposerWhitelist()`.\n\n### Removed\n- Removed `craft\\services\\Api::getOptimizedComposerRequirements()`.\n\n### Fixed\n- Craft\u2019s console commands now return the correct exit codes. ([#3175](https://github.com/craftcms/cms/issues/3175))\n- Fixed the appearance of checkboxes in IE11 on element index pages. ([#3177](https://github.com/craftcms/cms/issues/3177))\n- Fixed a bug where `composer.json` could end up with a bunch of extra dependencies in the `require` object after a failed update or plugin installation.\n- Fixed an error that could occur when viewing an entry revision, if it had a Matrix field and one of the sub-fields within the Matrix field had been deleted. ([#3183](https://github.com/craftcms/cms/issues/3183))\n- Fixed a bug where thumbnails weren\u2019t loading in relational fields when viewing an entry version.\n\n## 3.0.18 - 2018-07-31\n\n### Added\n- Added `craft\\helpers\\App::assetManagerConfig()`.\n- Added `craft\\helpers\\App::cacheConfig()`.\n- Added `craft\\helpers\\App::dbConfig()`.\n- Added `craft\\helpers\\App::mailerConfig()`.\n- Added `craft\\helpers\\App::mutexConfig()`.\n- Added `craft\\helpers\\App::logConfig()`.\n- Added `craft\\helpers\\App::sessionConfig()`.\n- Added `craft\\helpers\\App::userConfig()`.\n- Added `craft\\helpers\\App::viewConfig()`.\n- Added `craft\\helpers\\App::webRequestConfig()`.\n- Added `craft\\validators\\StringValidator::$trim`, which will cause leading/trailing whitespace to be stripped from model attributes.\n\n### Changed\n- User verification and password-reset emails now link them back to the same site they were on when the email was sent, if it was sent from a front-end request. ([#3029](https://github.com/craftcms/cms/issues/3029))\n- Dynamic app component configs are now defined by methods on `craft\\helpers\\App`, making it easier to modify them from `config/app.php`. ([#3152](https://github.com/craftcms/cms/issues/3152))\n- Structure operations now ensure that no other operations are being performed on the same structure, reducing the risk of corrupting the structure. ([#3148](https://github.com/craftcms/cms/issues/3148))\n- The `{% js %}` tag now supports the following position params: `at POS_HEAD`, `at POS_BEGIN`, `at POS_END`, `on POS_READY`, and `on POS_LOAD` (e.g. `{% js at POS_END %}`).\n- Craft once again checks for `X-Forwarded-For` headers when determining the user\u2019s IP. ([#3036](https://github.com/craftcms/cms/issues/3036))\n- Leading/trailing whitespace characters are now stripped from element titles on save. ([#3020](https://github.com/craftcms/cms/issues/3020))\n- Updated svg-sanitize to 0.9.\n\n### Deprecated\n- Deprecated `craft\\db\\Connection::createFromConfig()`. `craft\\helpers\\App::dbConfig()` should be used instead.\n- Deprecated `craft\\helpers\\MailerHelper::createMailer()`. `craft\\helpers\\App::mailerConfig()` should be used instead.\n\n### Fixed\n- Fixed a bug where collapsing structure elements would only hide up to 50 of their descendants.\n- Fixed a bug where Date/Time fields could lose their value if they were used in an entry type\u2019s Title Format, and the entry\u2019s site\u2019s language was different than the user\u2019s preferred language. ([#3151](https://github.com/craftcms/cms/issues/3151))\n- Fixed a bug where Dropdown fields could show an incorrect selected value in limited circumstances.\n- Fixed a bug where Dropdown fields on an element index view could show an incorrect selected value in limited circumstances.\n\n## 3.0.17.1 - 2018-07-24\n\n### Fixed\n- Really fixed a PHP error that could occur if the PHP\u2019s `set_time_limit()` was added to the php.ini `disable_functions` list.\n\n## 3.0.17 - 2018-07-24\n\n### Added\n- The Control Panel is now translated for Norwegian Nynorsk. ([#3135](https://github.com/craftcms/cms/pull/3135))\n- Added `craft\\elements\\db\\ElementQuery::anyStatus()`, which can be called when the default `status` and `enabledForSite` filters aren\u2019t desired. ([#3117](https://github.com/craftcms/cms/issues/3117))\n\n### Changed\n- The `addTrailingSlashesToUrls` config setting no longer applies to URLs that end with a segment that has a dot (`.`). ([#3123](https://github.com/craftcms/cms/issues/3123))\n- Craft now redirects install requests back to the Dashboard if it\u2019s already installed. ([#3143](https://github.com/craftcms/cms/issues/3143))\n\n### Fixed\n- Fixed a bug where the Settings \u2192 Email \u2192 System Messages page would show messages in the current application language rather than the primary site\u2019s language.\n- Fixed a bug where system message modals on the Settings \u2192 Email \u2192 System Messages page would initially show messages in the current application language rather than the primary site\u2019s language, even if the application language wasn\u2019t in use by any sites. ([#3115](https://github.com/craftcms/cms/issues/3115))\n- Fixed an error that could occur if `craft\\web\\View::registerAssetFlashes()` was called on a console request. ([#3124](https://github.com/craftcms/cms/issues/3124))\n- Fixed a PHP error that could occur if the PHP\u2019s `set_time_limit()` was added to the php.ini `disable_functions` list.\n- Fixed a bug where expanding a disabled element within a structure index view in the Control Panel wouldn\u2019t reveal any descendants. ([#3126](https://github.com/craftcms/cms/issues/3126))\n- Fixed a bug thumbnails weren\u2019t loading for element index rows that were revealed after expanding a parent element.\n- Fixed an error that occurred if an element\u2019s `getRoute()` method returned a string. ([#3128](https://github.com/craftcms/cms/issues/3128))\n- Fixed a bug where the `|without` filter wasn\u2019t working if an object was passed in. ([#3137](https://github.com/craftcms/cms/issues/3137))\n- Fixed a bug where users\u2019 Language preference would default to Deutsch if the current application language wasn\u2019t one of the available language options. ([#3142](https://github.com/craftcms/cms/issues/3142))\n\n## 3.0.16.1 - 2018-07-18\n\n### Fixed\n- Fixed a bug where the `orderBy` element query param wasn\u2019t being respected when used in conjunction with a `with` param to eager-load elements in a specific order. ([#3109](https://github.com/craftcms/cms/issues/3109))\n- Fixed a bug where underscores were getting removed from slugs. ([#3111](https://github.com/craftcms/cms/issues/3111))\n\n## 3.0.16 - 2018-07-17\n\n### Added\n- The progress bar on the Asset Indexes utility now shows how many files have been indexed, and how many there are in total. ([#2934](https://github.com/craftcms/cms/issues/2934))\n- Added `craft\\base\\PluginInterface::beforeSaveSettings()`.\n- Added `craft\\base\\PluginInterface::afterSaveSettings()`.\n- Added `craft\\base\\Plugin::EVENT_AFTER_SAVE_SETTINGS`.\n- Added `craft\\base\\Plugin::EVENT_BEFORE_SAVE_SETTINGS`.\n\n### Changed\n- Craft no longer relies on ImageMagick or GD to define the image formats that should be considered manipulatable. ([#2408](https://github.com/craftcms/cms/issues/2408))\n- Removed the `showBetaUpdates` config setting as it\u2019s no longer being used.\n- When uploading a file to an Assets field, Craft will automatically sort the file list to show the latest uploads first. ([#2812](https://github.com/craftcms/cms/issues/2812))\n- `dateCreated`, `dateUpdated`, `postDate`, `expiryDate`, `after`, and  `before` element query params can new be set to `DateTime` objects.\n- Matrix fields now auto-focus the first text input within newly-created Matrix blocks. ([#3104](https://github.com/craftcms/cms/issues/3104))\n- Updated Twig to 2.5.0.\n- Updated Garnish to 0.1.26.\n- Updated Selectize to 0.12.6.\n\n### Fixed\n- Fixed an error that could occur when sending emails to international domains if the Intl extension wasn\u2019t enabled.\n- Fixed an exception that was thrown if the `securityKey` config setting was changed and Craft was set to use either the SMTP or Gmail mailer transport type. ([#3083](https://github.com/craftcms/cms/issues/3083))\n- Fixed a bug where Asset view was not being refreshed in some cases after using Image Editor. ([#3035](https://github.com/craftcms/cms/issues/3035))\n- Fixed a bug where Craft wouldn\u2019t warn before leaving an edit page with unsaved changes, if Live Preview was active. ([#3092](https://github.com/craftcms/cms/issues/3092))\n- Fixed a bug where entries, categories, and global sets\u2019 `getCpEditUrl()` methods could omit the site handle on multi-site installs. ([#3089](https://github.com/craftcms/cms/issues/3089))\n- Fixed a JavaScript error that occurred when closing Live Preview. ([#3098](https://github.com/craftcms/cms/issues/3098))\n- Fixed a bug where Dashboard widgets could be spaced incorrectly if there was only one grid column. ([#3100](https://github.com/craftcms/cms/issues/3100))\n- Fixed a bug where modal windows with Field Layout Designers could cause the browser to crash. ([#3096](https://github.com/craftcms/cms/pull/3096))\n- Fixed a bug where `craft\\services\\Fields::getAllGroups()` and `getGroupById()` could return incorrect results. ([#3102](https://github.com/craftcms/cms/issues/3102))\n\n## 3.0.15 - 2018-07-09\n\n### Changed\n- It\u2019s now possible to fetch only non-admin users by setting `craft\\elements\\db\\UserQuery::$admin` to `false`.\n- `Craft.EntryTypeSwitcher` now triggers a `typeChange` event after switching the entry type. ([#3067](https://github.com/craftcms/cms/pull/3067))\n- Reduced the left and right padding in the Control Panel for screens less than 768 pixels wide. ([#3073](https://github.com/craftcms/cms/issues/3073))\n- Removed the `useXSendFile` config setting as it\u2019s no longer being used.\n- `craft\\helpers\\StringHelper::toKebabCase()`, `toCamelCase()`, `toPascalCase()`, and `toSnakeCase()` now treat camelCase\u2019d and PascalCale\u2019d strings as multiple words. ([#3090](https://github.com/craftcms/cms/issues/3090))\n\n### Fixed\n- Fixed a bug where\u00a0`craft\\i18n\\I18N::getPrimarySiteLocale()` and `getPrimarySiteLocaleId()` were returning locale info for the _first_ site, rather than the primary one. ([#3063](https://github.com/craftcms/cms/issues/3063))\n- Fixed a bug where element index pages were loading all elements in the view, rather than waiting for the user to scroll to the bottom of the page before loading the next batch. ([#3068](https://github.com/craftcms/cms/issues/3068))\n- Fixed a bug where sites listed in the Control Panel weren\u2019t always in the correct sort order. ([#3065](https://github.com/craftcms/cms/issues/3065))\n- Fixed an error that occurred when users attempted to create new entries within entry selector modals, for a section they didn\u2019t have permission to publish peer entries in. ([#3069](https://github.com/craftcms/cms/issues/3069))\n- Fixed a bug where the \u201cSave as a new asset\u201d button label wasn\u2019t getting translated in the Image Editor. ([#3070](https://github.com/craftcms/cms/pull/3070))\n- Fixed a bug where it was impossible to set the filename of assets when uploading them as data strings. ([#2973](https://github.com/craftcms/cms/issues/2973))\n- Fixed a bug where the Field Type menu\u2019s options within new Matrix block type settings weren\u2019t getting sorted alphabetically. ([#3072](https://github.com/craftcms/cms/issues/3072))\n- Fixed an exception that was thrown when testing email settings if the Template setting was invalid. ([#3074](https://github.com/craftcms/cms/issues/3074))\n- Fixed a bug where Dropdown fields\u2019 bottom margin could jump up a bit when an empty option was selected. ([#3075](https://github.com/craftcms/cms/issues/3075))\n- Fixed a bug where main content containers in the Control Panel could become too wide in Firefox. ([#3071](https://github.com/craftcms/cms/issues/3071))\n\n## 3.0.14 - 2018-07-03\n\n### Changed\n- `craft\\events\\SiteEvent` now has a `$oldPrimarySiteId` property, which will be set to the previous primary site ID (which may stil be the current site ID, if it didn\u2019t just change).\n- `craft\\helpers\\Search::normalizeKeywords()` now has a `$language` argument, which can be set if the character mappings should be pulled from a different language than the current app language.\n- `craft\\services\\Sites::getEditableSiteIds()` and `getEditableSites()` now return the same things as `getAllSiteIds()` and `getAllSites()` when there\u2019s only one site. ([#3049](https://github.com/craftcms/cms/issues/3049))\n\n### Fixed\n- Fixed a bug where user verification links could get mangled when emails were parsed as Markdown, if the verification code contained two or more underscores.\n- Fixed a bug where Craft was misinterpreting `X-Forwarded-For` headers as the user\u2019s IP instead of the server\u2019s IP. ([#3036](https://github.com/craftcms/cms/issues/3036))\n- Fixed a bug where Craft wasn\u2019t auto-scrolling the content container when dragging items near a window edge. ([#3048](https://github.com/craftcms/cms/issues/3048))\n- Fixed a PHP error that occurred when loading a Debug Toolbar panel on a page that contained serialized Checkboxes or Multi-Select field data. ([#3034](https://github.com/craftcms/cms/issues/3034))\n- Fixed a bug where elements\u2019 normalized search keywords weren\u2019t always using the correct language-specific character mappings. ([#3046](https://github.com/craftcms/cms/issues/3046))\n- Fixed a bug where the `<html lang>` attribute was hard-set to `en-US` rather than the current application language. ([#3053](https://github.com/craftcms/cms/pull/3053))\n- Fixed a PHP error that occurred when entering an invalid number into a Number field that was set to have decimal digits. ([#3059](https://github.com/craftcms/cms/issues/3059))\n\n### Security\n- Craft no longer shows the installer when it can\u2019t establish a database connection if Dev Mode isn\u2019t enabled.\n\n## 3.0.13.2 - 2018-06-27\n\n### Fixed\n- Fixed an error that occurred when deleting users from the Users index page.\n\n## 3.0.13.1 - 2018-06-26\n\n### Fixed\n- Fixed a bug where Delete User modals weren\u2019t showing the total number of entries that will be transferred/deleted.\n\n## 3.0.13 - 2018-06-26\n\n### Added\n- Craft now includes a summary of the content that will be transferred/deleted in Delete User modals. ([#875](https://github.com/craftcms/cms/issues/875))\n- `|date`, `|time`, and `|datetime` filters now support a `locale` argument, for specifying which locale\u2019s formatter should be doing the date/time formatting. ([#3006](https://github.com/craftcms/cms/issues/3006))\n- Added `craft\\base\\ApplicationTrait::getIsInitialized()`.\n- Added `craft\\base\\ClonefixTrait`.\n- Added `craft\\controllers\\AssetsController::actionThumb()`.\n- Added `craft\\controllers\\UsersController::actionUserContentSummary()`.\n- Added `craft\\controllers\\UsersController::EVENT_DEFINE_CONTENT_SUMMARY`.\n- Added `craft\\helpers\\App::backtrace()`.\n- Added `craft\\queue\\jobs\\PropagateElements`.\n- Added `craft\\services\\Elements::propagateElement()`.\n\n### Changed\n- Editable tables now submit an empty string when they have no rows.\n- Reduced the overhead when adding a new site by only resaving existing assets, categories, global sets, and tags once for the newly-created site, rather than for all sites.\n- Web-based queue workers now call `craft\\helpers\\App::maxPowerCaptain()` before running the queue. ([#3011](https://github.com/craftcms/cms/issues/3011))\n- The PHP Info utility no longer displays the original values for settings and only the current environment value. ([#2990](https://github.com/craftcms/cms/issues/2990))\n- Loosened up most of Craft\u2019s Composer dependency constraints.\n- Craft no longer publishes asset thumbnails to the `cpresources/` folder.\n- `attributes`, `error`, `errors`, and `scenario` are now reserved field handles. ([#3032](https://github.com/craftcms/cms/issues/3032))\n- Improved the look of Control Panel tabs.\n- `craft\\web\\UrlManager::createUrl()`, `createAbsoluteUrl()`, and `getMatchedElement()` now log warnings if they\u2019re called before Craft has been fully initialized. ([#3028](https://github.com/craftcms/cms/issues/3028))\n\n### Deprecated\n- Deprecated `craft\\controllers\\AssetsController::actionGenerateThumb()`.\n\n### Fixed\n- Fixed a bug where sidebar meta info on Edit User pages was bleeding over the edge of the page\u2019s content area.\n- Fixed a bug where Table fields wouldn\u2019t remember if they had no rows in their Default Values setting. ([#2979](https://github.com/craftcms/cms/issues/2979))\n- Fixed a bug where passing `timezone=false` to the `|date`, `|time`, and `|datetime` filters would not preserve the given date\u2019s time zone.\n- Fixed a bug where AM/PM strings in formatted dates weren\u2019t respecting the casing specified by the `A`/`a` character in the date format. ([#3007](https://github.com/craftcms/cms/issues/3007))\n- Fixed a bug you could get an invalid license warning in cases where web API calls returned a 500 response code.\n- Fixed a bug where cloning models and queries would lose any associated behaviors. ([#2857](https://github.com/craftcms/cms/issues/2857))\n- Fixed a bug where custom field params were getting forgotten when calling `getNext()` and `getPrev()`, if an element query object was passed in. ([#3019](https://github.com/craftcms/cms/issues/3019))\n- Fixed a bug where datepickers were getting scrollbars.\n- Fixed a bug where volumes\u2019 field layouts weren\u2019t getting deleted when volumes were deleted. ([#3022](https://github.com/craftcms/cms/pull/3022))\n- Fixed a bug where deleting a section or an entry type wouldn\u2019t delete any associated entries that didn\u2019t exist in the primary site. ([#3023](https://github.com/craftcms/cms/issues/3023))\n- Fixed a bug where the `svg()` Twig function could convert `id` attributes within the SVG contents to invalid IDs. ([#3025](https://github.com/craftcms/cms/issues/3025))\n- Fixed a bug where asset thumbnails wouldn\u2019t load reliably in the Control Panel on load-balanced environments. ([#3026](https://github.com/craftcms/cms/issues/3026))\n- Fixed a PHP error that could occur when validating Assets fields if a file was uploaded but no longer exists at the temp location. ([#3033](https://github.com/craftcms/cms/pull/3033))\n\n## 3.0.12 - 2018-06-18\n\n### Added\n- Added a `leaves` element query param that limits the selected elements to just the leaves in the structure (elements without children).\n- Added `craft\\helpers\\Db::deleteIfExists()`.\n- Added `craft\\services\\Categories::deleteGroup()`. ([#3000](https://github.com/craftcms/cms/pull/3000))\n- Added `craft\\services\\Tags::deleteTagGroup()`. ([#3000](https://github.com/craftcms/cms/pull/3000))\n- Added `craft\\services\\UserGroups::deleteGroup()`. ([#3000](https://github.com/craftcms/cms/pull/3000))\n\n### Changed\n- Improved Control Panel styling. ([#2883](https://github.com/craftcms/cms/issues/2883))\n\n### Removed\n- Removed `craft\\services\\Fields::updateFieldVersionAfterRequest()`.\n\n### Fixed\n- Fixed a caching bug where the Fields service could still think a field existed after it had been deleted. ([#2985](https://github.com/craftcms/cms/issues/2985))\n- Fixed a bug where Craft would not invalidate the dynamically-generated `craft\\behaviors\\ContentBehavior` and `craft\\behaviors\\ElementQueryBehavior` after saving/deleting a custom field, if the request didn\u2019t end normally. ([#2999](https://github.com/craftcms/cms/issues/2999))\n- Fixed a PHP error that could occur when saving entries with a URI format that contained certain Twig filters. ([#2995](https://github.com/craftcms/cms/issues/2995))\n- Fixed a bug where `{shorthand}` variables in templates rendered by `craft\\web\\View::renderObjectTemplate()` could end up referencing global variables, if the variable wasn\u2019t a property of the object. ([#3002](https://github.com/craftcms/cms/issues/3002))\n- Fixed a bug where the Find and Replace utility wasn\u2019t updating element titles. ([#2996](https://github.com/craftcms/cms/issues/2996))\n- Fixed some wonky behavior if one of the custom user profile tabs was called \u201cAccount\u201d. ([#2998](https://github.com/craftcms/cms/issues/2998))\n- Fixed a bug where dragging a folder on the Assets index page could have unexpected results. ([#2873](https://github.com/craftcms/cms/issues/2873))\n- Reduced the likelihood of SQL deadlock errors when saving elements. ([#3003](https://github.com/craftcms/cms/issues/3003))\n\n## 3.0.11 - 2018-06-12\n\n### Changed\n- Sort options defined by element types\u2019 `sortOptions()` / `defineSortOptions()` methods can now be specified as sub-arrays with `label`, `orderBy`, and `attribute` keys.\n- Entries and categories can now be sorted by their slugs.\n- The \u201cCache remote images?\u201d option in the Asset Indexes utility is now enabled by default. ([#2977](https://github.com/craftcms/cms/issues/2977))\n\n### Fixed\n- Fixed a bug where it was not possible to order search results by search score, if the element type didn\u2019t specify any sort options.\n- Fixed a bug where clicking on \u201cDate Created\u201d and \u201cDate Updated\u201d column headers on element indexes wouldn\u2019t update the sort order. ([#2975](https://github.com/craftcms/cms/issues/2975))\n- Fixed a bug where Edit Entry pages were listing more than the 10 most recent versions. ([#2976](https://github.com/craftcms/cms/issues/2976))\n- Fixed a SQL error that occurred when upgrading from Craft 2 to 3 via the terminal. ([#1347](https://github.com/craftcms/cms/issues/1347))\n- Fixed the alignment of expand/collapse toggles in asset index sidebars. ([#2981](https://github.com/craftcms/cms/issues/2981))\n\n## 3.0.10.3 - 2018-06-07\n\n### Fixed\n- Fixed a bug where the \u201cNew Entry\u201d menu on the Entries index page would not contain any options on single-site installs, running MySQL. ([#2961](https://github.com/craftcms/cms/issues/2961))\n- Fixed a bug where the `siteName` config setting wasn\u2019t working as expected when set to an array. ([#2968](https://github.com/craftcms/cms/issues/2968))\n\n## 3.0.10.2 - 2018-06-07\n\n### Changed\n- Improved the output of `craft\\helpers\\DateTimeHelper::humanDurationFromInterval()`.\n- Updated Garnish to 0.1.24.\n\n### Fixed\n- Fixed JavaScript errors that could occur in the Control Panel on pages with Ajax requests. ([#2966](https://github.com/craftcms/cms/issues/2966))\n- Fixed a bug where the \u201cNew Entry\u201d menu on the Entries index page would not contain any options on single-site installs. ([#2961](https://github.com/craftcms/cms/issues/2961))\n- Fixed a bug where JavaScript files registered with `craft\\web\\View::registerJsFile()` would be ignored if the `depends` option was set. ([#2965](https://github.com/craftcms/cms/issues/2965))\n\n## 3.0.10.1 - 2018-06-06\n\n### Fixed\n- Fixed a bug where Craft wasn\u2019t converting empty strings to `null` when saving data to non-textual columns.\n- Fixed a bug where Craft would show a Database Connection Error on Install requests, if it couldn\u2019t connect to the database.\n- Fixed a bug where Craft wasn\u2019t keeping track of element queries that were executed within `{% cache %}` tags. ([#2959](https://github.com/craftcms/cms/issues/2959))\n\n## 3.0.10 - 2018-06-05\n\n### Added\n- Added support for a `CRAFT_LICENSE_KEY` PHP constant, which can be set to the project\u2019s license key, taking precedence over the `license.key` file.\n- Added `craft\\helpers\\Stringy::getLangSpecificCharsArray()`.\n- Added `craft\\web\\View::setRegisteredAssetBundles()`.\n- Added `craft\\web\\View::setRegisteredJsFiles()`.\n\n### Changed\n- Generated site URLs now always include full host info, even if the base site URL is root/protocol-relative. ([#2919](https://github.com/craftcms/cms/issues/2919))\n- Variables passed into `craft\\web\\View::renderObjectTemplate()` can now be referenced using the shorthand syntax (e.g. `{foo}`).\n- `craft\\helpers\\StringHelper::asciiCharMap()` now has `$flat` and `$language` arguments.\n- Craft no longer saves new versions of entries when absolutely nothing changed about them in the save request. ([#2923](https://github.com/craftcms/cms/issues/2923))\n- Craft no longer enforces plugins\u2019 `minVersionRequired` settings if the currently-installed version begins with `\n- \n- dev-`.\n- Improved the performance of element queries when a lot of values were passed into a param, such as `id`, by using `IN()` and `NOT IN()` conditions when possible. ([#2937](https://github.com/craftcms/cms/pull/2937))\n- The Asset Indexes utility no longer skips files with leading underscores. ([#2943](https://github.com/craftcms/cms/issues/2943))\n- Updated Garnish to 0.1.23.\n\n### Deprecated\n- Deprecated the `customAsciiCharMappings` config setting. (Any corrections to ASCII char mappings should be submitted to [Stringy](https://github.com/danielstjules/Stringy).)\n\n### Fixed\n- Fixed a PHP error that could occur when `craft\\fields\\Number::normalizeValue()` was called without passing an `$element` argument. ([#2913](https://github.com/craftcms/cms/issues/2913))\n- Fixed a bug where it was not possible to fetch Matrix blocks with the `relatedTo` param if a specific custom field was specified.\n- Fixed a bug where `craft\\helpers\\UrlHelper::url()` and `siteUrl()` were not respecting the `$scheme` argument for site URLs.\n- Fixed a bug where `{id}` tags within element URI formats weren\u2019t getting parsed correctly on first save. ([#2922](https://github.com/craftcms/cms/issues/2922))\n- Fixed a bug where `craft\\helpers\\MigrationHelper::dropAllForeignKeysToTable()` wasn\u2019t working correctly. ([#2897](https://github.com/craftcms/cms/issues/2897))\n- Fixed a \u201cCraft is not defined\u201d JavaScript error that could occur on the Forgot Password page in the Control Panel and Dev Toolbar requests.\n- Fixed a bug where rotating the screen on iOS would change how the page was zoomed.\n- Fixed a bug where `craft\\helpers\\StringHelper::toAscii()` and the `Craft.asciiString()` JS method weren\u2019t using language-specific character replacements, or any custom replacements defined by the `customAsciiCharMappings` config setting.\n- Fixed a bug where the number `0` would not save in a Plain Text field.\n- Fixed a bug where Craft could pick the wrong current site if the primary site had a root-relative or protocol-relative URL, and another site didn\u2019t, but was otherwise an equal match.\n- Fixed a bug where Control Panel Ajax requests could cause some asset bundles and JavaScript files to be double-registered in the browser.\n- Fixed a bug where the \u201cNew entry\u201d menu on the Entries index page was including sections that weren\u2019t available in the selected site, and they weren\u2019t linking to Edit Entry pages for the selected site. ([#2925](https://github.com/craftcms/cms/issues/2925))\n- Fixed a bug where the `|date`, `|time`, and `|datetime` filters weren\u2019t respecting their `$timezone` arguments. ([#2926](https://github.com/craftcms/cms/issues/2926))\n- Fixed a bug where element queries weren\u2019t respecting the `asArray` param when calling `one()`. ([#2940](https://github.com/craftcms/cms/issues/2940))\n- Fixed a bug where the Asset Indexes utility wouldn\u2019t work as expected if all of a volume\u2019s assets had been deleted from the file system. ([#2955](https://github.com/craftcms/cms/issues/2955))\n- Fixed a SQL error that could occur when a `{% cache %}` tag had no body. ([#2953](https://github.com/craftcms/cms/issues/2953))\n\n## 3.0.9 - 2018-05-22\n\n### Added\n- Added a default plugin icon to plugins without an icon in the Plugin Store.\n- Added `craft\\helpers\\ArrayHelper::without()` and `withoutValue()`.\n- Added `craft\\base\\FieldInterface::modifyElementIndexQuery()`.\n- Added `craft\\elements\\db\\ElementQueryInterface::andWith()`.\n\n### Changed\n- Fixed a bug where Craft was checking the file system when determining if an asset was a GIF, when it should have just been checking the file extension.\n- `craft\\base\\Plugin` now sets the default `$controllerNamespace` value to the plugin class\u2019 namespace + `\\controllers` or `\\console\\controllers`, depending on whether it\u2019s a web or console request.\n- Improved the contrast of success and error notices in the Control Panel to meet WCAG AA requirements. ([#2885](https://github.com/craftcms/cms/issues/2885))\n- `fieldValue` is now a protected field handle. ([#2893](https://github.com/craftcms/cms/issues/2893))\n- Craft will no longer discard any preloaded elements when setting the `with` param on an element query, fixing a bug where disabled Matrix blocks could show up in Live Preview if any nested fields were getting eager-loaded. ([#1576](https://github.com/craftcms/cms/issues/1576))\n- Improved memory usage when using the `{% cache %}` tag. ([#2903](https://github.com/craftcms/cms/issues/2903))\n\n### Fixed\n- Fixed a bug where the Plugin Store was listing featured plugins (e.g. \u201cRecently Added\u201d) in alphabetical order rather than the API-defined order. ([pixelandtonic/craftnet#83](https://github.com/pixelandtonic/craftnet/issues/83))\n- Fixed a SQL error that occurred when programmatically saving a field layout, if the field\u2019s `required` property wasn\u2019t set.\n- Fixed a JavaScript error that could occur when multiple Assets fields were present on the same page.\n- Fixed an error that could occur when running the `setup` command on some environments.\n- Fixed a PHP error that could occur when calling `craft\\elements\\db\\ElementQuery::addOrderBy()` if `$columns` normalized to an empty array. ([#2896](https://github.com/craftcms/cms/issues/2896))\n- Fixed a bug where it wasn\u2019t possible to access custom field values on Matrix blocks via `matrixblock` reference tags.\n- Fixed a bug where relational fields with only disabled elements selected would get empty table cells on element indexes. ([#2910](https://github.com/craftcms/cms/issues/2910))\n\n## 3.0.8 - 2018-05-15\n\n### Added\n- Number fields now have a \u201cDefault Value\u201d setting. ([#927](https://github.com/craftcms/cms/issues/927))\n- Added the `preserveCmykColorspace` config setting, which can be set to `true` to prevent images\u2019 color spaces from getting converted to sRGB on environments running ImageMagick.\n\n### Changed\n- Error text is now orange instead of red. ([#2885](https://github.com/craftcms/cms/issues/2885))\n- Detail panes now have a lighter, more saturated background color.\n\n### Fixed\n- Fixed a bug where Craft\u2019s default MySQL backup command would not respect the `unixSocket` database config setting. ([#2794](https://github.com/craftcms/cms/issues/2794))\n- Fixed a bug where some SVG files were not recognized as SVG files.\n- Fixed a bug where Table fields could add the wrong number of default rows if the Min Rows setting was set, and the Default Values setting had something other than one row. ([#2864](https://github.com/craftcms/cms/issues/2864))\n- Fixed an error that could occur when parsing asset reference tags. ([craftcms/redactor#47](https://github.com/craftcms/redactor/issues/47))\n- Fixed a bug where \u201cTry\u201d and \u201cBuy\u201d buttons in the Plugin Store were visible when the `allowUpdates` config setting was disabled. ([#2781](https://github.com/craftcms/cms/issues/2781))\n- Fixed a bug where Number fields would forget their Min/Max Value settings if they were set to 0.\n- Fixed a bug where entry versions could be displayed in the wrong order if multiple versions had the same creation date. ([#2889](https://github.com/craftcms/cms/issues/2889))\n- Fixed an error that occurred when installing Craft on a domain with an active user session.\n- Fixed a bug where email verification links weren\u2019t working for publicly-registered users if the registration form contained a Password field and the default user group granted permission to access the Control Panel.\n\n### Security\n- Login errors for locked users now factor in whether the `preventUserEnumeration` config setting is enabled.\n\n## 3.0.7 - 2018-05-10\n\n### Added\n- Added the `transformGifs` config setting, which can be set to `false` to prevent GIFs from getting transformed or cleansed. ([#2845](https://github.com/craftcms/cms/issues/2845))\n- Added `craft\\helpers\\FileHelper::isGif()`.\n\n### Changed\n- Craft no longer logs warnings about missing translation files when Dev Mode isn\u2019t enabled. ([#1531](https://github.com/craftcms/cms/issues/1531))\n- Added `craft\\services\\Deprecator::$logTarget`. ([#2870](https://github.com/craftcms/cms/issues/2870))\n- `craft\\services\\Deprecator::log()` no longer returns anything.\n\n### Fixed\n- Fixed a bug where it was impossible to upload new assets to Assets fields using base64-encoded strings. ([#2855](https://github.com/craftcms/cms/issues/2855))\n- Fixed a bug where Assets fields would ignore all submitted asset IDs if any new assets were uploaded as well.\n- Fixed a bug where SVG files that were using single quotes instead of double quotes would not be recognized as SVGs.\n- Fixed a bug where translated versions of the \u201cIt looks like someone is currently performing a system update.\u201d message contained an HTML-encoded `<br/>` tag.\n- Fixed a bug where changing an entry\u2019s type could skip adding the new entry type\u2019s tabs, if the previous entry type didn\u2019t have any tabs. ([#2859](https://github.com/craftcms/cms/issues/2859))\n- Fixed warnings about missing SVG files that were logged by Control Panel requests.\n- Fixed a bug where the `|date` filter would ignore date formatting characters that don\u2019t have ICU counterparts. ([#2867](https://github.com/craftcms/cms/issues/2867))\n- Fixed a bug where the global `currentUser` Twig variable could be set to `null` and global sets and could be missing some custom field values when a user was logged-in, if a plugin was loading Twig during or immediately after plugin instantiation. ([#2866](https://github.com/craftcms/cms/issues/2866))\n\n## 3.0.6 - 2018-05-08\n\n### Added\n- Error messages about missing plugin-supplied field and volume types now show an Install button when possible.\n- Added `craft\\base\\MissingComponentTrait::getPlaceholderHtml()`.\n- Added `craft\\db\\Migration::EVENT_AFTER_UP` and `EVENT_AFTER_DOWN` events.\n- Added `craft\\elements\\Asset::getContents()`.\n\n### Changed\n- Edit User pages will now warn editors when leaving the page with unsaved changes. ([#2832](https://github.com/craftcms/cms/issues/2832))\n- Modules are once again loaded before plugins, so they have a chance to register Twig initialization events before a plugin initializes Twig. ([#2831](https://github.com/craftcms/cms/issues/2831))\n- `craft\\helpers\\FileHelper::isSvg()` now returns `true` for files with an `image/svg` MIME type (missing the `+xml`). ([#2837](https://github.com/craftcms/cms/pull/2837))\n- The `svg()` Twig function now accepts assets to be passed directly into it. ([#2838](https://github.com/craftcms/cms/pull/2838))\n- The \u201cSave and add another\u201d save menu option on Edit Entry and Edit Categories pages now maintain the currently-selected site. ([#2844](https://github.com/craftcms/cms/issues/2844))\n- PHP date patterns that are *only* a month name or week day name character will now format the date using the stand-alone month/week day name value. (For example, `'F'` will format a date as \u201cMaggio\u201d instead of \u201cmaggio\u201d.)\n- Servers without the Intl extension will now use location-agnostic locale data as a fallback if locale data for the specific locale isn\u2019t available.\n- The `|date` Twig filter always goes through `craft\\i18n\\Formatter::asDate()` now, unless formatting a `DateInterval` object.\n- The Settings \u2192 Plugins page now shows \u201cBuy now\u201d buttons for any commercial plugins that don\u2019t have a license key yet.\n\n### Deprecated\n- Deprecated `craft\\helpers\\DateTimeHelper::translateDate()`. `craft\\i18n\\Formatter::asDate()` should be used instead.\n\n### Removed\n- Removed the `translate` argument from the `|date`, `|time`, and `|datetime` Twig filters; the resulting formatted dates will always be translated now. (Use `myDate.format()` to avoid translations.)\n\n### Fixed\n- Fixed an error that could occur in the Plugin Store.\n- Fixed a bug where `myDate|date('F')` was returning the short \u201cMay\u201d translation rather than the full-length one. ([#2848](https://github.com/craftcms/cms/issues/2848))\n\n## 3.0.5 - 2018-05-01\n\n### Changed\n- Fields\u2019 translation icons now reveal the chosen Translation Method in their tooltip. ([#2808](https://github.com/craftcms/cms/issues/2808))\n- Improved the error messages displayed when an Assets field has an invalid Upload Location setting. ([#2803](https://github.com/craftcms/cms/issues/2803))\n- Craft now logs errors that occur when saving and replacing assets. ([#2814](https://github.com/craftcms/cms/issues/2814))\n- Single sections\u2019 entry types\u2019 handles are now updated to match their section\u2019s handle whenever the section is saved. ([#2824](https://github.com/craftcms/cms/issues/2824))\n- The Control Panel background color was lightened up a bit.\n\n### Fixed\n- Fixed an error that would occur on servers without the Phar PHP extension enabled.\n- Fixed an error that could occur if a Matrix block was deleted by a queue job. ([#2813](https://github.com/craftcms/cms/issues/2813))\n- Fixed a bug where Twig could be configured to output times in UTC rather than the system timezone, if a bootstrapped module was loading Twig. ([#2761](https://github.com/craftcms/cms/issues/2761))\n- Fixed a SQL error that could occur when upgrading from Craft 2 to Craft 3 with an active user session.\n- Fixed various SQL errors that could occur when upgrading from Craft 2 to Craft 3, if there were any lingering Craft 3 database tables from a previous upgrade attempt.\n- Fixed a bug where the Clear Caches tool was deleting the `.gitignore` file inside `web/cpresources/`. ([#2823](https://github.com/craftcms/cms/issues/2823))\n- Fixed the vertical positioning of checkboxes in the Control Panel. ([#2825](https://github.com/craftcms/cms/issues/2825))\n- Fixed a JavaScript error that could occur if an element type\u2019s class name contained `\\u`. ([#2826](https://github.com/craftcms/cms/issues/2826))\n\n## 3.0.4 - 2018-04-24\n\n### Added\n- Added the `craft.globalSets()` template function. ([#2790](https://github.com/craftcms/cms/issues/2790))\n- Added the `hasDescendants` element query param. ([#2786](https://github.com/craftcms/cms/issues/2786))\n- Added `craft\\elements\\User::hasDashboard`.\n\n### Changed\n- Sections and category groups now ignore posted Template settings for sites that don\u2019t have URI Formats.\n- Control Panel resources are once again eager-published. ([#2763](https://github.com/craftcms/cms/issues/2763))\n- `entries/save-entries` and `categories/save-category` actions now include the `slug` for responses that accept JSON. ([#2792](https://github.com/craftcms/cms/issues/2792))\n- Most `craft\\services\\Path` methods now have a `$create` argument, which can be set to `false` to prevent the directory from being created if it doesn\u2019t exist yet.\n- Craft no longer creates directories when it just needed to clear it. ([#2771](https://github.com/craftcms/cms/issues/2771))\n- `craft\\services\\Config::setDotEnvVar()` now sets the environment variable for the current request, in addition to updating the `.env` file.\n- Removed `craft\\controllers\\AssetsController::actionDownloadTempAsset()`.\n- User now must be logged in to use the Asset Preview File functionality.\n\n### Fixed\n- Fixed a bug where users would regain all default Dashboard widgets if all widgets were removed. ([#2769](https://github.com/craftcms/cms/issues/2769))\n- Fixed a bug where you would get a \u201cnot a valid language\u201d error message when creating a new site using certain languages.\n- Fixed a bug where database connection settings that were set by the `setup` command weren\u2019t always taking effect in time for the CLI installer. ([#2774](https://github.com/craftcms/cms/issues/2774))\n- Fixed a bug where empty Plain Text fields were getting empty string values rather than `null`.\n- Fixed a bug where elements within relational fields could have two thumbnails. ([#2785](https://github.com/craftcms/cms/issues/2785))\n- Fixed a bug where it was not possible to pass a `--table-prefix` argument to the `setup/db-creds` command. ([#2791](https://github.com/craftcms/cms/pull/2791))\n- Fixed an error that occurred for users without permission to perform updates, if available update info wasn\u2019t cached.\n- Fixed an error that occurred when `craft\\elements\\Asset::sources()` was called in a console request. ([#2798](https://github.com/craftcms/cms/issues/2798))\n- Fixed JavaScript errors that could occur on the front-end after deleting Matrix blocks. ([#2799](https://github.com/craftcms/cms/pull/2799))\n\n## 3.0.3.1 - 2018-04-18\n\n### Fixed\n- Fixed an error that occurred when editing an entry if any of the entry\u2019s revisions were created with an entry type that no longer exists.\n- Fixed an error that could occur when saving an asset. ([#2764](https://github.com/craftcms/cms/issues/2764))\n- Fixed a bug where Craft assumed an asset was missing if there was an error when indexing it. ([#2763](https://github.com/craftcms/cms/issues/2763))\n\n## 3.0.3 - 2018-04-17\n\n### Added\n- Added `craft\\elements\\Entry::updateTitle()`.\n- Added `Yii::alias()`.\n\n### Changed\n- New sites\u2019 Base URLs now default to `@web/`.\n- Textual custom fields now ensure that they don\u2019t contain 4+ byte characters. ([#2725](https://github.com/craftcms/cms/issues/2725))\n- It is no longer expected that all of the `defaultSearchTermOptions` config setting options will be set if any of the default option values need to be overridden. ([#2737](https://github.com/craftcms/cms/issues/2737))\n- Control Panel panes now have at least 48 pixels of bottom padding. ([#2744](https://github.com/craftcms/cms/issues/2744))\n- Craft now intercepts 404-ing resource requests, and publishes the resources on the fly.\n- The Clear Caches utility now has a \u201cControl Panel resources\u201d option.\n- The Clear Caches utility now sorts the cache options alphabetically.\n- When enabling new sites for a section, the new sites\u2019 content is now based on the primary site\u2019s content, if the section was and still is enabled for the primary site. ([#2748](https://github.com/craftcms/cms/issues/2748))\n- Improved the responsiveness of element indexes.\n- `Craft.BaseElementIndexView` now has a `loadMoreElementsAction` setting. ([#2762](https://github.com/craftcms/cms/pull/2762))\n\n### Fixed\n- Fixed a bug where the Clear Caches utility was not deleting template caches. ([#2720](https://github.com/craftcms/cms/issues/2720))\n- Fixed a bug where the Plugin Store was not displaying payment errors on checkout.\n- Fixed a bug where Control Panel-defined routes that contained special regular expression characters weren\u2019t working. ([#2721](https://github.com/craftcms/cms/issues/2721))\n- Fixed a bug where it was not possible to save system messages in some cases.\n- Fixed a bug where static translations within dynamic entry title formats were getting translated using the current site\u2019s language, rather than the entry\u2019s language. ([#2722](https://github.com/craftcms/cms/issues/2722))\n- Fixed a bug where deprecation errors for some date formatting methods were not escaping backslashes.\n- Fixed a bug where plugins\u2019 \u201cLast update\u201d timestamps in the Plugin Store weren\u2019t getting formatted correctly in Safari. ([#2733](https://github.com/craftcms/cms/issues/2733))\n- Fixed references to a nonexistent `Craft.eot` file in the Control Panel CSS. ([#2740](https://github.com/craftcms/cms/issues/2740))\n- Fixed a bug where the default PostgreSQL database restore command wasn\u2019t setting the `PGPASSWORD` environment variable. ([#2741](https://github.com/craftcms/cms/pull/2741))\n- Fixed an error that could occur if the system time zone was not supported by the ICU library, on environments with the Intl extension loaded.\n- Fixed a bug where several administrative fields had translatable icons. ([#2742](https://github.com/craftcms/cms/issues/2742))\n- Fixed a bug where `craft\\controllers\\PluginStoreController::actionSavePluginLicenseKeys()` was trying to set a plugin license key for plugins which were not installed.\n\n### Security\n- Fixed a bug assets were not getting cleansed on upload. ([#2709](https://github.com/craftcms/cms/issues/2709))\n\n## 3.0.2 - 2018-04-10\n\n### Added\n- Added the `EVENT_BEFORE_DELETE_CACHES` and `EVENT_AFTER_DELETE_CACHES` events to `craft\\services\\TemplateCaches`.\n- Added `craft\\events\\DeleteTemplateCachesEvent`.\n\n### Changed\n- Craft now deletes all compiled templates whenever Craft or a plugin is updated. ([#2686](https://github.com/craftcms/cms/issues/2686))\n- The Plugin Store now displays commercial plugins\u2019 renewal prices. ([#2690](https://github.com/craftcms/cms/issues/2690))\n- The Plugin Store no longer shows the \u201cUpgrade Craft CMS\u201d link if Craft is already running (and licensed to run) the Pro edition. ([#2713](https://github.com/craftcms/cms/issues/2713))\n- Matrix fields now set `$propagating` to `true` when saving Matrix blocks, if the owner element is propagating.\n- `craft\\helpers\\ArrayHelper::toArray()` no longer throws a deprecation error when a string without commas is passed to it. ([#2711](https://github.com/craftcms/cms/issues/2711))\n- Editable tables now support an `html` column type, which will output cell values directly without encoding HTML entities. ([#2716](https://github.com/craftcms/cms/pull/2716))\n- `Craft.EditableTable` instances are now accessible via `.data('editable-table')` on their `<table>` element. ([#2694](https://github.com/craftcms/cms/issues/2694))\n- Updated Composer to 1.6.3. ([#2707](https://github.com/craftcms/cms/issues/2707))\n- Updated Garnish to 0.1.22. ([#2689](https://github.com/craftcms/cms/issues/2689))\n\n### Fixed\n- Fixed an error that could occur in the Control Panel if any plugins with licensing issues were installed. ([#2691](https://github.com/craftcms/cms/pull/2691))\n- Fixed a bug on the Plugin Store\u2019s Payment screen where the \u201cUse a new credit card\u201d radio option would not get selected automatically even if it was the only one available.\n- Fixed a bug where `craft\\web\\assets\\vue\\VueAsset` didn\u2019t respect the `useCompressedJs` config setting.\n- Fixed an error that occurred when saving a Single entry over Ajax. ([#2687](https://github.com/craftcms/cms/issues/2687))\n- Fixed an error that could occur when disabling a site on a Single section. ([#2695](https://github.com/craftcms/cms/issues/2695))\n- Fixed an error that could occur on requests without a content type on the response. ([#2704](https://github.com/craftcms/cms/issues/2704))\n- Fixed a bug where the `includeSubfolders` asset query param wasn\u2019t including results in the parent folder. ([#2706](https://github.com/craftcms/cms/issues/2706))\n- Fixed an error that could occur when querying for users eager-loaded with their photos, if any of the resulting users didn\u2019t have a photo. ([#2708](https://github.com/craftcms/cms/issues/2708))\n- Fixed a bug where relational fields within Matrix fields wouldn\u2019t save relations to elements that didn\u2019t exist on all of the sites the owner element existed on. ([#2683](https://github.com/craftcms/cms/issues/2683))\n- Fixed a bug where relational fields were ignoring disabled related elements in various functions, including required field validation and value serialization.\n- Fixed an error that would occur if a new custom field was created and added to an element\u2019s field layout, and its value was accessed, all in the same request. ([#2705](https://github.com/craftcms/cms/issues/2705))\n- Fixed a bug where the `id` param was ignored when used on an eager-loaded elements\u2019 criteria. ([#2717](https://github.com/craftcms/cms/issues/2717))\n- Fixed a bug where the default restore command for MySQL wouldn\u2019t actually restore the database. ([#2714](https://github.com/craftcms/cms/issues/2714))\n\n## 3.0.1 - 2018-04-04\n\n### Deprecated\n- Brought back and deprecated the `Craft::Personal` and `Craft::Client` constants.\n\n### Fixed\n- Fixed a bug where elements\u2019 `getNext()` and `getPrev()` methods were modifying the element query passed into them. ([#2160](https://github.com/craftcms/cms/issues/2160))\n- Fixed a bug where Table fields could be pre-populated with one too many rows. ([#2680](https://github.com/craftcms/cms/pull/2680))\n\n### Security\n- Craft no longer sends exception messages to error templates, unless the exception is an instance of `yii\\base\\UserException`.\n\n## 3.0.0.2 - 2018-04-04\n\n### Fixed\n- Fixed a bug where Craft Pro installs were getting identified as Craft Solo in the Control Panel.\n\n## 3.0.0 - 2018-04-04\n\n### Added\n- The codebase has been completely rewritten and refactored to improve performance, maintainability, and extensibility.\n- Craft can now be [installed](https://docs.craftcms.com/v3/installation.html) via Composer in addition to a zip file. ([#895](https://github.com/craftcms/cms/issues/895))\n- Craft\u2019s setup wizard is now available as a CLI tool in addition to the web-based one.\n- [Plugins](https://docs.craftcms.com/v3/plugin-intro.html) are now loaded as Composer dependencies, and implemented as extensions of [Yii modules](http://www.yiiframework.com/doc-2.0/guide-structure-modules.html).\n- Added [multi-site](https://docs.craftcms.com/v3/sites.html) support.\n- Added the Plugin Store, where plugins can be discovered, trialled, and purchased. ([#808](https://github.com/craftcms/cms/issues/808))\n- Plugins can now be updated and removed from within the Control Panel.\n- Asset sources are now called \u201cvolumes\u201d, and plugins can supply their own volume types.\n- Added the Image Editor, which can be used to rotate, crop, and flip images, as well as set focal points on them.\n- Added asset previews, which can be triggered via a \u201cPreview file\u201d action on the Assets index, or with a `shift` + `spacebar` keyboard shortcut throughout the Control Panel.\n- Asset editor HUDs now show image previews. ([#837](https://github.com/craftcms/cms/issues/837))\n- Added the \u201cUtilities\u201d section to the Control Panel, replacing the Tools area of the Settings page.\n- Added the Debug Toolbar, powered by the [Debug Extension for Yii 2](http://www.yiiframework.com/doc-2.0/guide-tool-debugger.html).\n- Added support for [Content Migrations](https://docs.craftcms.com/v3/content-migrations.html).\n- Added support for PostgreSQL.\n\n### Changed\n- The Control Panel has been redesigned for better usability, readability and responsiveness.\n- Renamed all \u201cURL Format\u201d things to \u201cURI Format\u201d, in the Control Panel UI and in the code.\n- Added the \u201cPropagate entries across all enabled sites?\u201d section setting. If disabled, entries will only be associated with the site they were created on. ([#2330](https://github.com/craftcms/cms/issues/2330))\n- Structure sections and category groups no longer have Nested URL Format settings. (It\u2019s still possible to achieve the same result with a single URI Format setting.)\n- When an entry type is updated, Craft now re-saves all entries of that type.\n- When a category is deleted, its nested categories are no longer deleted with it.\n- Craft no longer re-saves *all* localizable elements after a new site is created; entries and Matrix blocks are skipped, and plugins that supply custom element types must now re-save their elements manually as well.\n- The \u201cNew entry\u201d and \u201cNew category\u201d buttons on Entries and Categories index pages now load the Edit page for the currently-selected site. ([#2236](https://github.com/craftcms/cms/issues/2236))\n- Elements now validate that custom field values will fit within their database columns, for fields with textual or numeric column types.\n- User photos are now assets. ([#933](https://github.com/craftcms/cms/issues/933))\n- Assets now have a \u201cLink\u201d table attribute option.\n- Volumes\u2019 \u201cBase URL\u201d settings can now begin with `@web`, which is an alias for the root URL that Craft is running from.\n- Local volumes\u2019 \u201cFile System Path\u201d settings can now begin with `@webroot`, which is an alias for the path to the directory that `index.php` lives in.\n- Global Sets\u2019 field layouts can now have custom tabs.\n- Color inputs can now be left blank.\n- Color values within Table fields are now represented by `craft\\fields\\data\\ColorData` objects.\n- Element titles now get a validation error if they contain any 4+ byte characters (like emoji), on servers running MySQL. ([#2513](https://github.com/craftcms/cms/issues/2513))\n- Lightswitch fields that don\u2019t have a value yet will now be assigned the default field value, even for existing elements. ([#2404](https://github.com/craftcms/cms/issues/2404))\n- The system installer now sets the initial admin account\u2019s preferred language to the site language selected in the installation wizard. ([#2480](https://github.com/craftcms/cms/issues/2480))\n- Table fields now have \u201cMin Rows\u201d, \u201cMax Rows\u201d, and \u201cAdd Row Label\u201d settings. ([#2372](https://github.com/craftcms/cms/issues/2372))\n- Table fields now have \u201cDate\u201d, \u201cTime\u201d, \u201cLightswitch\u201d, and \u201cColor\u201d column type options.\n- Color fields now return a `craft\\fields\\data\\ColorData` object, with `hex`, `rgb`, `red`, `green`, `blue`, `r`, `g`, `b`, and `luma` properties.\n- Matrix fields now have \u201cManage blocks on a per-site basis\u201d, \u201cMin Blocks\u201d, and \u201cMax Blocks\u201d settings.\n- Matrix fields with only one block type, and equal values for the Min Blocks and Max Blocks settings, now hide the UI for adding and deleting blocks.\n- Matrix fields with only one block type will now auto-create the minimum number of blocks required by the field, per the Min Blocks setting, for new elements. ([#850](https://github.com/craftcms/cms/issues/850))\n- The `migrate/up` console command will now update the appropriate schema version in the database after successfully completing all migrations. ([#1907](https://github.com/craftcms/cms/issues/1907))\n- Users can now set their preferred language to any supported application language. ([#847](https://github.com/craftcms/cms/issues/847))\n- Users are no longer logged out when verifying a new email address on their own account. ([#1421](https://github.com/craftcms/cms/issues/1421))\n- Users no longer get an exception or error message if they click on an invalid/expired email verification link and are already logged in. Instead they\u2019ll be redirected to wherever they would normally be taken immediately after logging in. ([#1422](https://github.com/craftcms/cms/issues/1422))\n- If anything prevents a user from being deleted, any changes that were made in preparation for deleting the user are now rolled back.\n- Added `webp` as a web-safe image format.\n- Craft now checks if the current installation can manipulate an image instead of checking against a predefined list. ([#1648](https://github.com/craftcms/cms/issues/1648), [#1545](https://github.com/craftcms/cms/issues/1545))\n- The `getCsrfInput()` global function has been renamed to `csrfInput()`. (getCsrfInput() still works but produces a deprecation error.)\n- The `{% cache %}` tag no longer includes the query string when storing the cache URL.\n- Added the `|timestamp` Twig filter, for formatting a date as a user-friendly timestamp.\n- Added the `|datetime` Twig filter, for formatting a date with a localized date+time format.\n- Added the `|time` Twig filter, for formatting a date with a localized time format.\n- Added the `|multisort` Twig filter, which duplicates an array and sorts it with [craft\\helpers\\ArrayHelper::multisort()](http://www.yiiframework.com/doc-2.0/yii-helpers-basearrayhelper.html#multisort()-detail).\n- Added the `|atom` and `|rss` Twig filters, for formatting dates in Atom and RSS date formats, respectively.\n- Added the `|column` Twig filter, for capturing the key/property values of a series of arrays/objects.\n- Added the `|index` Twig filter, for indexing an array of arrays/objects by one of their keys/values.\n- Added the `|filterByValue` Twig filter.\n- Added the `|duration` Twig filter, which converts a `DateInterval` object into a human-readable duration.\n- The `t` filter now always defaults to translating the given string using the `site` category unless it is otherwise specified (e.g. `myString|t('pluginhandle')`).\n- The `|date` filter can be passed `'short'`, `'medium'`, `'long'`, and `'full'`, which will format the date with a localized date format.\n- It is now possibly to customize the SQL of [element queries](https://docs.craftcms.com/v3/element-queries.html), and there are more choices on how the data should be returned.\n- Element queries are no longer limited to 100 results by default.\n- The \u201cFailed\u201d message in the queue HUD in the Control Panel now shows the full error message as alt text. ([#855](https://github.com/craftcms/cms/issues/855))\n- Added the `convertFilenamesToAscii` config setting.\n- Added the `preserveExifData` config setting, `false` by default and requires Imagick. ([#2034](https://github.com/craftcms/cms/issues/2034))\n- Added the `aliases` config setting, providing an easy way to define custom [aliases](http://www.yiiframework.com/doc-2.0/guide-concept-aliases.html).\n- Removed support for automatically determining the values for the `omitScriptNameInUrls` and `usePathInfo` config settings.\n- It\u2019s now possible to override Craft\u2019s application config via `config/app.php`.\n- It\u2019s now possible to override volume settings via `config/volumes.php`.\n- It\u2019s now possible to override all plugins\u2019 settings via `config/<plugin-handle>.php`.\n- Renamed the `runTasksAutomatically` config setting to `runQueueAutomatically`.\n- The `translationDebugOutput` config setting will now wrap strings with `@` characters if the category is `app`, `$` if the category is `site`, and `%` for anything else.\n- All user-defined strings in the Control Panel (e.g. section names) are now translated using the `site` category, to prevent translation conflicts with Craft\u2019s own Control Panel translations.\n- Routes can now be stored on a per-site basis, rather than per-locale.\n- Web requests are now logged to `storage/logs/web.log`.\n- Web requests that result in 404 errors are now logged to `storage/logs/web-404s.log`.\n- Console requests are now logged to `storage/logs/console.log`.\n- Queue requests are now logged to `storage/logs/queue.log`.\n- Craft 3 now requires PHP 7.0.0 or later.\n- Craft 3 now requires MySQL 5.5+ or PostgreSQL 9.5+.\n- Craft now takes advantage of the [PHP Intl extension](http://php.net/manual/en/book.intl.php) when available.\n- Craft now uses Stringy for better string processing support.\n- Craft now uses Flysystem for better asset volume support.\n- Craft now uses Swiftmailer for better email sending support.\n- Craft now uses the [Yii 2 Queue Extension](https://github.com/yiisoft/yii2-queue) for managing background tasks.\n- Craft now uses the Zend Feed library for better RSS and Atom processing support.\n- Updated Yii to 2.0.15.1.\n- Updated Twig to 2.4.\n- Updated Guzzle to 6.3.\n\n### Deprecated\n- Many things have been deprecated. See [Changes in Craft 3](https://docs.craftcms.com/v3/changes-in-craft-3.html) for a complete list.\n\n### Fixed\n- Fixed a bug where a PHP session would be started on every template rendering request whether it was needed or not. ([#1765](https://github.com/craftcms/cms/issues/1765))\n\n### Security\n- Craft uses OpenSSL for encryption rather than mcrypt, which is far more secure and well-maintained.\n", "/*!   - 2019-10-08 */\n(function($){\n\n/** global: Craft */\n/** global: Garnish */\n// Set all the standard Craft.* stuff\n$.extend(Craft,\n    {\n        navHeight: 48,\n\n        /**\n         * Get a translated message.\n         *\n         * @param {string} category\n         * @param {string} message\n         * @param {object} params\n         * @return string\n         */\n        t: function(category, message, params) {\n            if (\n                typeof Craft.translations[category] !== 'undefined' &&\n                typeof Craft.translations[category][message] !== 'undefined'\n            ) {\n                message = Craft.translations[category][message];\n            }\n\n            if (params) {\n                for (var key in params) {\n                    if (!params.hasOwnProperty(key)) {\n                        continue;\n                    }\n\n                    message = message.replace('{' + key + '}', params[key]);\n                }\n            }\n\n            return message;\n        },\n\n        formatDate: function(date) {\n            if (typeof date !== 'object') {\n                date = new Date(date);\n            }\n\n            return $.datepicker.formatDate(Craft.datepickerOptions.dateFormat, date);\n        },\n\n        /**\n         * Formats a number.\n         *\n         * @param {string} number\n         * @return string D3 format\n         */\n        formatNumber: function(number, format) {\n            if(typeof format == 'undefined') {\n                format = ',.0f';\n            }\n\n            var formatter = d3.formatLocale(d3FormatLocaleDefinition).format(format);\n\n            return formatter(number);\n        },\n\n        /**\n         * Escapes some HTML.\n         *\n         * @param {string} str\n         * @return string\n         */\n        escapeHtml: function(str) {\n            return $('<div/>').text(str).html();\n        },\n\n        /**\n         * Escapes special regular expression characters.\n         *\n         * @param {string} str\n         * @return string\n         */\n        escapeRegex: function(str) {\n            // h/t https://stackoverflow.com/a/9310752\n            return str.replace(/[-[\\]{}()*+?.,\\\\^$|#\\s]/g, '\\\\$&');\n        },\n\n        /**\n         * Returns the text in a string that might contain HTML tags.\n         *\n         * @param {string} str\n         * @return string\n         */\n        getText: function(str) {\n            return $('<div/>').html(str).text();\n        },\n\n        /**\n         * Encodes a URI copmonent. Mirrors PHP's rawurlencode().\n         *\n         * @param {string} str\n         * @return string\n         * @see http://stackoverflow.com/questions/1734250/what-is-the-equivalent-of-javascripts-encodeuricomponent-in-php\n         */\n        encodeUriComponent: function(str) {\n            str = encodeURIComponent(str);\n\n            var differences = {\n                '!': '%21',\n                '*': '%2A',\n                \"'\": '%27',\n                '(': '%28',\n                ')': '%29'\n            };\n\n            for (var chr in differences) {\n                var re = new RegExp('\\\\' + chr, 'g');\n                str = str.replace(re, differences[chr]);\n            }\n\n            return str;\n        },\n\n        /**\n         * Selects the full value of a given text input.\n         *\n         * @param input\n         */\n        selectFullValue: function(input) {\n            var $input = $(input);\n            var val = $input.val();\n\n            // Does the browser support setSelectionRange()?\n            if (typeof $input[0].setSelectionRange !== 'undefined') {\n                // Select the whole value\n                var length = val.length * 2;\n                $input[0].setSelectionRange(0, length);\n            }\n            else {\n                // Refresh the value to get the cursor positioned at the end\n                $input.val(val);\n            }\n        },\n\n        /**\n         * Formats an ID out of an input name.\n         *\n         * @param {string} inputName\n         * @return string\n         */\n        formatInputId: function(inputName) {\n            return this.rtrim(inputName.replace(/[\\[\\]\\\\]+/g, '-'), '-');\n        },\n\n        /**\n         * @return string\n         * @param path\n         * @param params\n         * @param baseUrl\n         */\n        getUrl: function(path, params, baseUrl) {\n            if (typeof path !== 'string') {\n                path = '';\n            }\n\n            // Normalize the params\n            var anchor = '';\n\n            if ($.isPlainObject(params)) {\n                var aParams = [];\n\n                for (var name in params) {\n                    if (!params.hasOwnProperty(name)) {\n                        continue;\n                    }\n\n                    var value = params[name];\n\n                    if (name === '#') {\n                        anchor = value;\n                    }\n                    else if (value !== null && value !== '') {\n                        aParams.push(name + '=' + value);\n                    }\n                }\n\n                params = aParams;\n            }\n\n            if (Garnish.isArray(params)) {\n                params = params.join('&');\n            }\n            else {\n                params = Craft.trim(params, '&?');\n            }\n\n            // Were there already any query string params in the path?\n            var qpos = path.indexOf('?');\n            if (qpos !== -1) {\n                params = path.substr(qpos + 1) + (params ? '&' + params : '');\n                path = path.substr(0, qpos);\n            }\n\n            // Return path if it appears to be an absolute URL.\n            if (path.search('://') !== -1 || path[0] === '/') {\n                return path + (params ? '?' + params : '');\n            }\n\n            path = Craft.trim(path, '/');\n\n            // Put it all together\n            var url;\n\n            if (baseUrl) {\n                url = baseUrl;\n\n                if (path) {\n                    // Does baseUrl already contain a path?\n                    var pathMatch = url.match(new RegExp('[&\\?]' + Craft.escapeRegex(Craft.pathParam) + '=[^&]+'));\n                    if (pathMatch) {\n                        url = url.replace(pathMatch[0], Craft.rtrim(pathMatch[0], '/') + '/' + path);\n                        path = '';\n                    }\n                }\n            }\n            else {\n                url = Craft.baseUrl;\n            }\n\n            // Does the base URL already have a query string?\n            qpos = url.indexOf('?');\n            if (qpos !== -1) {\n                params = url.substr(qpos + 1) + (params ? '&' + params : '');\n                url = url.substr(0, qpos);\n            }\n\n            if (!Craft.omitScriptNameInUrls && path) {\n                if (Craft.usePathInfo) {\n                    // Make sure that the script name is in the URL\n                    if (url.search(Craft.scriptName) === -1) {\n                        url = Craft.rtrim(url, '/') + '/' + Craft.scriptName;\n                    }\n                }\n                else {\n                    // Move the path into the query string params\n\n                    // Is the path param already set?\n                    if (params && params.substr(0, Craft.pathParam.length + 1) === Craft.pathParam + '=') {\n                        var basePath,\n                            endPath = params.indexOf('&');\n\n                        if (endPath !== -1) {\n                            basePath = params.substring(2, endPath);\n                            params = params.substr(endPath + 1);\n                        }\n                        else {\n                            basePath = params.substr(2);\n                            params = null;\n                        }\n\n                        // Just in case\n                        basePath = Craft.rtrim(basePath);\n\n                        path = basePath + (path ? '/' + path : '');\n                    }\n\n                    // Now move the path into the params\n                    params = Craft.pathParam + '=' + path + (params ? '&' + params : '');\n                    path = null;\n                }\n            }\n\n            if (path) {\n                url = Craft.rtrim(url, '/') + '/' + path;\n            }\n\n            if (params) {\n                url += '?' + params;\n            }\n\n            if (anchor) {\n                url += '#' + anchor;\n            }\n\n            return url;\n        },\n\n        /**\n         * @return string\n         * @param path\n         * @param params\n         */\n        getCpUrl: function(path, params) {\n            return this.getUrl(path, params, Craft.baseCpUrl);\n        },\n\n        /**\n         * @return string\n         * @param path\n         * @param params\n         */\n        getSiteUrl: function(path, params) {\n            return this.getUrl(path, params, Craft.baseSiteUrl);\n        },\n\n        /**\n         * Returns an action URL.\n         *\n         * @param {string} path\n         * @param {object|string|undefined} params\n         * @return string\n         */\n        getActionUrl: function(path, params) {\n            return Craft.getUrl(path, params, Craft.actionUrl);\n        },\n\n        /**\n         * Redirects the window to a given URL.\n         *\n         * @param {string} url\n         */\n        redirectTo: function(url) {\n            document.location.href = this.getUrl(url);\n        },\n\n        /**\n         * Returns a hidden CSRF token input, if CSRF protection is enabled.\n         *\n         * @return string\n         */\n        getCsrfInput: function() {\n            if (Craft.csrfTokenName) {\n                return '<input type=\"hidden\" name=\"' + Craft.csrfTokenName + '\" value=\"' + Craft.csrfTokenValue + '\"/>';\n            }\n            else {\n                return '';\n            }\n        },\n\n        /**\n         * Posts an action request to the server.\n         *\n         * @param {string} action\n         * @param {object|undefined} data\n         * @param {function|undefined} callback\n         * @param {object|undefined} options\n         * @return jqXHR\n         */\n        postActionRequest: function(action, data, callback, options) {\n            // Make 'data' optional\n            if (typeof data === 'function') {\n                options = callback;\n                callback = data;\n                data = {};\n            }\n\n            var headers = {\n                'X-Registered-Asset-Bundles': Object.keys(Craft.registeredAssetBundles).join(','),\n                'X-Registered-Js-Files': Object.keys(Craft.registeredJsFiles).join(',')\n            };\n\n            if (Craft.csrfTokenValue && Craft.csrfTokenName) {\n                headers['X-CSRF-Token'] = Craft.csrfTokenValue;\n            }\n\n            var jqXHR = $.ajax($.extend({\n                url: Craft.getActionUrl(action),\n                type: 'POST',\n                dataType: 'json',\n                headers: headers,\n                data: data,\n                success: callback,\n                error: function(jqXHR, textStatus, errorThrown) {\n                    // Ignore incomplete requests, likely due to navigating away from the page\n                    // h/t https://stackoverflow.com/a/22107079/1688568\n                    if (jqXHR.readyState !== 4) {\n                        return;\n                    }\n\n                    if (typeof Craft.cp !== 'undefined') {\n                        Craft.cp.displayError();\n                    } else {\n                        alert(Craft.t('app', 'An unknown error occurred.'));\n                    }\n\n                    if (callback) {\n                        callback(null, textStatus, jqXHR);\n                    }\n                }\n            }, options));\n\n            // Call the 'send' callback\n            if (options && typeof options.send === 'function') {\n                options.send(jqXHR);\n            }\n\n            return jqXHR;\n        },\n\n        _waitingOnAjax: false,\n        _ajaxQueue: [],\n\n        /**\n         * Queues up an action request to be posted to the server.\n         */\n        queueActionRequest: function(action, data, callback, options) {\n            // Make 'data' optional\n            if (typeof data === 'function') {\n                options = callback;\n                callback = data;\n                data = undefined;\n            }\n\n            Craft._ajaxQueue.push([action, data, callback, options]);\n\n            if (!Craft._waitingOnAjax) {\n                Craft._postNextActionRequestInQueue();\n            }\n        },\n\n        _postNextActionRequestInQueue: function() {\n            Craft._waitingOnAjax = true;\n\n            var args = Craft._ajaxQueue.shift();\n\n            Craft.postActionRequest(args[0], args[1], function(data, textStatus, jqXHR) {\n                if (args[2] && typeof args[2] === 'function') {\n                    args[2](data, textStatus, jqXHR);\n                }\n\n                if (Craft._ajaxQueue.length) {\n                    Craft._postNextActionRequestInQueue();\n                }\n                else {\n                    Craft._waitingOnAjax = false;\n                }\n            }, args[3]);\n        },\n\n        /**\n         * Converts a comma-delimited string into an array.\n         *\n         * @param {string} str\n         * @return array\n         */\n        stringToArray: function(str) {\n            if (typeof str !== 'string') {\n                return str;\n            }\n\n            var arr = str.split(',');\n            for (var i = 0; i < arr.length; i++) {\n                arr[i] = $.trim(arr[i]);\n            }\n            return arr;\n        },\n\n        /**\n         * Expands an array of POST array-style strings into an actual array.\n         *\n         * @param {object} arr\n         * @return array\n         */\n        expandPostArray: function(arr) {\n            var expanded = {};\n            var i;\n\n            for (var key in arr) {\n                if (!arr.hasOwnProperty(key)) {\n                    continue;\n                }\n\n                var value = arr[key],\n                    m = key.match(/^(\\w+)(\\[.*)?/),\n                    keys;\n\n                if (m[2]) {\n                    // Get all of the nested keys\n                    keys = m[2].match(/\\[[^\\[\\]]*\\]/g);\n\n                    // Chop off the brackets\n                    for (i = 0; i < keys.length; i++) {\n                        keys[i] = keys[i].substring(1, keys[i].length - 1);\n                    }\n                }\n                else {\n                    keys = [];\n                }\n\n                keys.unshift(m[1]);\n\n                var parentElem = expanded;\n\n                for (i = 0; i < keys.length; i++) {\n                    if (i < keys.length - 1) {\n                        if (typeof parentElem[keys[i]] !== 'object') {\n                            // Figure out what this will be by looking at the next key\n                            if (!keys[i + 1] || parseInt(keys[i + 1]) == keys[i + 1]) {\n                                parentElem[keys[i]] = [];\n                            }\n                            else {\n                                parentElem[keys[i]] = {};\n                            }\n                        }\n\n                        parentElem = parentElem[keys[i]];\n                    }\n                    else {\n                        // Last one. Set the value\n                        if (!keys[i]) {\n                            keys[i] = parentElem.length;\n                        }\n\n                        parentElem[keys[i]] = value;\n                    }\n                }\n            }\n\n            return expanded;\n        },\n\n        /**\n         * Compares two variables and returns whether they are equal in value.\n         * Recursively compares array and object values.\n         *\n         * @param obj1\n         * @param obj2\n         * @param sortObjectKeys Whether object keys should be sorted before being compared. Default is true.\n         * @return boolean\n         */\n        compare: function(obj1, obj2, sortObjectKeys) {\n            // Compare the types\n            if (typeof obj1 !== typeof obj2) {\n                return false;\n            }\n\n            if (typeof obj1 === 'object') {\n                // Compare the lengths\n                if (obj1.length !== obj2.length) {\n                    return false;\n                }\n\n                // Is one of them an array but the other is not?\n                if ((obj1 instanceof Array) !== (obj2 instanceof Array)) {\n                    return false;\n                }\n\n                // If they're actual objects (not arrays), compare the keys\n                if (!(obj1 instanceof Array)) {\n                    if (typeof sortObjectKeys === 'undefined' || sortObjectKeys === true) {\n                        if (!Craft.compare(Craft.getObjectKeys(obj1).sort(), Craft.getObjectKeys(obj2).sort())) {\n                            return false;\n                        }\n                    }\n                    else {\n                        if (!Craft.compare(Craft.getObjectKeys(obj1), Craft.getObjectKeys(obj2))) {\n                            return false;\n                        }\n                    }\n                }\n\n                // Compare each value\n                for (var i in obj1) {\n                    if (!obj1.hasOwnProperty(i)) {\n                        continue;\n                    }\n\n                    if (!Craft.compare(obj1[i], obj2[i])) {\n                        return false;\n                    }\n                }\n\n                // All clear\n                return true;\n            }\n            else {\n                return (obj1 === obj2);\n            }\n        },\n\n        /**\n         * Returns an array of an object's keys.\n         *\n         * @param {object} obj\n         * @return string\n         */\n        getObjectKeys: function(obj) {\n            var keys = [];\n\n            for (var key in obj) {\n                if (!obj.hasOwnProperty(key)) {\n                    continue;\n                }\n\n                keys.push(key);\n            }\n\n            return keys;\n        },\n\n        /**\n         * Takes an array or string of chars, and places a backslash before each one, returning the combined string.\n         *\n         * Userd by ltrim() and rtrim()\n         *\n         * @param {string|object} chars\n         * @return string\n         */\n        escapeChars: function(chars) {\n            if (!Garnish.isArray(chars)) {\n                chars = chars.split();\n            }\n\n            var escaped = '';\n\n            for (var i = 0; i < chars.length; i++) {\n                escaped += \"\\\\\" + chars[i];\n            }\n\n            return escaped;\n        },\n\n        /**\n         * Trim characters off of the beginning of a string.\n         *\n         * @param {string} str\n         * @param {string|object|undefined} chars The characters to trim off. Defaults to a space if left blank.\n         * @return string\n         */\n        ltrim: function(str, chars) {\n            if (!str) {\n                return str;\n            }\n            if (typeof chars === 'undefined') {\n                chars = ' \\t\\n\\r\\0\\x0B';\n            }\n            var re = new RegExp('^[' + Craft.escapeChars(chars) + ']+');\n            return str.replace(re, '');\n        },\n\n        /**\n         * Trim characters off of the end of a string.\n         *\n         * @param {string} str\n         * @param {string|object|undefined} chars The characters to trim off. Defaults to a space if left blank.\n         * @return string\n         */\n        rtrim: function(str, chars) {\n            if (!str) {\n                return str;\n            }\n            if (typeof chars === 'undefined') {\n                chars = ' \\t\\n\\r\\0\\x0B';\n            }\n            var re = new RegExp('[' + Craft.escapeChars(chars) + ']+$');\n            return str.replace(re, '');\n        },\n\n        /**\n         * Trim characters off of the beginning and end of a string.\n         *\n         * @param {string} str\n         * @param {string|object|undefined} chars The characters to trim off. Defaults to a space if left blank.\n         * @return string\n         */\n        trim: function(str, chars) {\n            str = Craft.ltrim(str, chars);\n            str = Craft.rtrim(str, chars);\n            return str;\n        },\n\n        /**\n         * Returns whether a string starts with another string.\n         *\n         * @param {string} str\n         * @param {string} substr\n         * @return boolean\n         */\n        startsWith: function(str, substr) {\n            return str.substr(0, substr.length) === substr;\n        },\n\n        /**\n         * Filters an array.\n         *\n         * @param {object} arr\n         * @param {function} callback A user-defined callback function. If null, we'll just remove any elements that equate to false.\n         * @return array\n         */\n        filterArray: function(arr, callback) {\n            var filtered = [];\n\n            for (var i = 0; i < arr.length; i++) {\n                var include;\n\n                if (typeof callback === 'function') {\n                    include = callback(arr[i], i);\n                }\n                else {\n                    include = arr[i];\n                }\n\n                if (include) {\n                    filtered.push(arr[i]);\n                }\n            }\n\n            return filtered;\n        },\n\n        /**\n         * Returns whether an element is in an array (unlike jQuery.inArray(), which returns the element's index, or -1).\n         *\n         * @param elem\n         * @param arr\n         * @return boolean\n         */\n        inArray: function(elem, arr) {\n            return ($.inArray(elem, arr) !== -1);\n        },\n\n        /**\n         * Removes an element from an array.\n         *\n         * @param elem\n         * @param {object} arr\n         * @return boolean Whether the element could be found or not.\n         */\n        removeFromArray: function(elem, arr) {\n            var index = $.inArray(elem, arr);\n            if (index !== -1) {\n                arr.splice(index, 1);\n                return true;\n            }\n            else {\n                return false;\n            }\n        },\n\n        /**\n         * Returns the last element in an array.\n         *\n         * @param {object} arr\n         * @return mixed\n         */\n        getLast: function(arr) {\n            if (!arr.length) {\n                return null;\n            } else {\n                return arr[arr.length - 1];\n            }\n        },\n\n        /**\n         * Makes the first character of a string uppercase.\n         *\n         * @param {string} str\n         * @return string\n         */\n        uppercaseFirst: function(str) {\n            return str.charAt(0).toUpperCase() + str.slice(1);\n        },\n\n        /**\n         * Makes the first character of a string lowercase.\n         *\n         * @param {string} str\n         * @return string\n         */\n        lowercaseFirst: function(str) {\n            return str.charAt(0).toLowerCase() + str.slice(1);\n        },\n\n        parseUrl: function(url) {\n            var m = url.match(/^(?:(https?):\\/\\/|\\/\\/)([^\\/\\:]*)(?:\\:(\\d+))?(\\/[^\\?]*)?(?:\\?([^#]*))?(#.*)?/);\n            if (!m) {\n                return {};\n            }\n            return {\n                scheme: m[1],\n                host: m[2] + (m[3] ? ':' + m[3] : ''),\n                hostname: m[2],\n                port: m[3] || null,\n                path: m[4] || '/',\n                query: m[5] || null,\n                hash: m[6] || null,\n            };\n        },\n\n        isSameHost: function(url) {\n            var requestUrlInfo = this.parseUrl(document.location.href);\n            if (!requestUrlInfo) {\n                return false;\n            }\n            var urlInfo = this.parseUrl(url);\n            if (!urlInfo) {\n                return false;\n            }\n            return requestUrlInfo.host === urlInfo.host;\n        },\n\n        /**\n         * Converts a number of seconds into a human-facing time duration.\n         */\n        secondsToHumanTimeDuration: function(seconds, showSeconds) {\n            if (typeof showSeconds === 'undefined') {\n                showSeconds = true;\n            }\n\n            var secondsInWeek = 604800,\n                secondsInDay = 86400,\n                secondsInHour = 3600,\n                secondsInMinute = 60;\n\n            var weeks = Math.floor(seconds / secondsInWeek);\n            seconds = seconds % secondsInWeek;\n\n            var days = Math.floor(seconds / secondsInDay);\n            seconds = seconds % secondsInDay;\n\n            var hours = Math.floor(seconds / secondsInHour);\n            seconds = seconds % secondsInHour;\n\n            var minutes;\n\n            if (showSeconds) {\n                minutes = Math.floor(seconds / secondsInMinute);\n                seconds = seconds % secondsInMinute;\n            }\n            else {\n                minutes = Math.round(seconds / secondsInMinute);\n                seconds = 0;\n            }\n\n            var timeComponents = [];\n\n            if (weeks) {\n                timeComponents.push(weeks + ' ' + (weeks === 1 ? Craft.t('app', 'week') : Craft.t('app', 'weeks')));\n            }\n\n            if (days) {\n                timeComponents.push(days + ' ' + (days === 1 ? Craft.t('app', 'day') : Craft.t('app', 'days')));\n            }\n\n            if (hours) {\n                timeComponents.push(hours + ' ' + (hours === 1 ? Craft.t('app', 'hour') : Craft.t('app', 'hours')));\n            }\n\n            if (minutes || (!showSeconds && !weeks && !days && !hours)) {\n                timeComponents.push(minutes + ' ' + (minutes === 1 ? Craft.t('app', 'minute') : Craft.t('app', 'minutes')));\n            }\n\n            if (seconds || (showSeconds && !weeks && !days && !hours && !minutes)) {\n                timeComponents.push(seconds + ' ' + (seconds === 1 ? Craft.t('app', 'second') : Craft.t('app', 'seconds')));\n            }\n\n            return timeComponents.join(', ');\n        },\n\n        /**\n         * Converts extended ASCII characters to ASCII.\n         *\n         * @param {string} str\n         * @param {object|undefined} charMap\n         * @return string\n         */\n        asciiString: function(str, charMap) {\n            var asciiStr = '';\n            var char;\n\n            for (var i = 0; i < str.length; i++) {\n                char = str.charAt(i);\n                asciiStr += (charMap || Craft.asciiCharMap)[char] || char;\n            }\n\n            return asciiStr;\n        },\n\n        randomString: function(length) {\n            // h/t https://stackoverflow.com/a/1349426/1688568\n            var result = '';\n            var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\n            for (var i = 0; i < length; i++) {\n                result += characters.charAt(Math.floor(Math.random() * 62));\n            }\n            return result;\n        },\n\n        /**\n         * Prevents the outline when an element is focused by the mouse.\n         *\n         * @param elem Either an actual element or a jQuery collection.\n         */\n        preventOutlineOnMouseFocus: function(elem) {\n            var $elem = $(elem),\n                namespace = '.preventOutlineOnMouseFocus';\n\n            $elem.on('mousedown' + namespace, function() {\n                    $elem.addClass('no-outline');\n                    $elem.trigger('focus');\n                })\n                .on('keydown' + namespace + ' blur' + namespace, function(event) {\n                    if (event.keyCode !== Garnish.SHIFT_KEY && event.keyCode !== Garnish.CTRL_KEY && event.keyCode !== Garnish.CMD_KEY) {\n                        $elem.removeClass('no-outline');\n                    }\n                });\n        },\n\n        /**\n         * Creates a validation error list.\n         *\n         * @param {object} errors\n         * @return jQuery\n         */\n        createErrorList: function(errors) {\n            var $ul = $(document.createElement('ul')).addClass('errors');\n\n            for (var i = 0; i < errors.length; i++) {\n                var $li = $(document.createElement('li'));\n                $li.appendTo($ul);\n                $li.html(errors[i]);\n            }\n\n            return $ul;\n        },\n\n        appendHeadHtml: function(html) {\n            if (!html) {\n                return;\n            }\n\n            // Prune out any link tags that are already included\n            var $existingCss = $('link[href]');\n\n            if ($existingCss.length) {\n                var existingCss = [];\n                var href;\n\n                for (var i = 0; i < $existingCss.length; i++) {\n                    href = $existingCss.eq(i).attr('href').replace(/&/g, '&amp;');\n                    existingCss.push(Craft.escapeRegex(href));\n                }\n\n                var regexp = new RegExp('<link\\\\s[^>]*href=\"(?:' + existingCss.join('|') + ')\".*?></script>', 'g');\n\n                html = html.replace(regexp, '');\n            }\n\n            $('head').append(html);\n        },\n\n        appendFootHtml: function(html) {\n            if (!html) {\n                return;\n            }\n\n            // Prune out any script tags that are already included\n            var $existingJs = $('script[src]');\n\n            if ($existingJs.length) {\n                var existingJs = [];\n                var src;\n\n                for (var i = 0; i < $existingJs.length; i++) {\n                    src = $existingJs.eq(i).attr('src').replace(/&/g, '&amp;');\n                    existingJs.push(Craft.escapeRegex(src));\n                }\n\n                var regexp = new RegExp('<script\\\\s[^>]*src=\"(?:' + existingJs.join('|') + ')\".*?></script>', 'g');\n\n                html = html.replace(regexp, '');\n            }\n\n            Garnish.$bod.append(html);\n        },\n\n        /**\n         * Initializes any common UI elements in a given container.\n         *\n         * @param {object} $container\n         */\n        initUiElements: function($container) {\n            $('.grid', $container).grid();\n            $('.info', $container).infoicon();\n            $('.checkbox-select', $container).checkboxselect();\n            $('.fieldtoggle', $container).fieldtoggle();\n            $('.lightswitch', $container).lightswitch();\n            $('.nicetext', $container).nicetext();\n            $('.pill', $container).pill();\n            $('.formsubmit', $container).formsubmit();\n            $('.menubtn', $container).menubtn();\n        },\n\n        _elementIndexClasses: {},\n        _elementSelectorModalClasses: {},\n        _elementEditorClasses: {},\n\n        /**\n         * Registers an element index class for a given element type.\n         *\n         * @param {string} elementType\n         * @param {function} func\n         */\n        registerElementIndexClass: function(elementType, func) {\n            if (typeof this._elementIndexClasses[elementType] !== 'undefined') {\n                throw 'An element index class has already been registered for the element type \u201c' + elementType + '\u201d.';\n            }\n\n            this._elementIndexClasses[elementType] = func;\n        },\n\n        /**\n         * Registers an element selector modal class for a given element type.\n         *\n         * @param {string} elementType\n         * @param {function} func\n         */\n        registerElementSelectorModalClass: function(elementType, func) {\n            if (typeof this._elementSelectorModalClasses[elementType] !== 'undefined') {\n                throw 'An element selector modal class has already been registered for the element type \u201c' + elementType + '\u201d.';\n            }\n\n            this._elementSelectorModalClasses[elementType] = func;\n        },\n\n        /**\n         * Registers an element editor class for a given element type.\n         *\n         * @param {string} elementType\n         * @param {function} func\n         */\n        registerElementEditorClass: function(elementType, func) {\n            if (typeof this._elementEditorClasses[elementType] !== 'undefined') {\n                throw 'An element editor class has already been registered for the element type \u201c' + elementType + '\u201d.';\n            }\n\n            this._elementEditorClasses[elementType] = func;\n        },\n\n        /**\n         * Creates a new element index for a given element type.\n         *\n         * @param {string} elementType\n         * @param $container\n         * @param {object} settings\n         * @return BaseElementIndex\n         */\n        createElementIndex: function(elementType, $container, settings) {\n            var func;\n\n            if (typeof this._elementIndexClasses[elementType] !== 'undefined') {\n                func = this._elementIndexClasses[elementType];\n            }\n            else {\n                func = Craft.BaseElementIndex;\n            }\n\n            return new func(elementType, $container, settings);\n        },\n\n        /**\n         * Creates a new element selector modal for a given element type.\n         *\n         * @param {string} elementType\n         * @param {object} settings\n         */\n        createElementSelectorModal: function(elementType, settings) {\n            var func;\n\n            if (typeof this._elementSelectorModalClasses[elementType] !== 'undefined') {\n                func = this._elementSelectorModalClasses[elementType];\n            }\n            else {\n                func = Craft.BaseElementSelectorModal;\n            }\n\n            return new func(elementType, settings);\n        },\n\n        /**\n         * Creates a new element editor HUD for a given element type.\n         *\n         * @param {string} elementType\n         * @param element $element\n         * @param {object} settings\n         */\n        createElementEditor: function(elementType, element, settings) {\n            var func;\n\n            if (typeof this._elementEditorClasses[elementType] !== 'undefined') {\n                func = this._elementEditorClasses[elementType];\n            }\n            else {\n                func = Craft.BaseElementEditor;\n            }\n\n            return new func(element, settings);\n        },\n\n        /**\n         * Retrieves a value from localStorage if it exists.\n         *\n         * @param {string} key\n         * @param defaultValue\n         */\n        getLocalStorage: function(key, defaultValue) {\n            key = 'Craft-' + Craft.systemUid + '.' + key;\n\n            if (typeof localStorage !== 'undefined' && typeof localStorage[key] !== 'undefined') {\n                return JSON.parse(localStorage[key]);\n            }\n            else {\n                return defaultValue;\n            }\n        },\n\n        /**\n         * Saves a value to localStorage.\n         *\n         * @param {string} key\n         * @param value\n         */\n        setLocalStorage: function(key, value) {\n            if (typeof localStorage !== 'undefined') {\n                key = 'Craft-' + Craft.systemUid + '.' + key;\n\n                // localStorage might be filled all the way up.\n                // Especially likely if this is a private window in Safari 8+, where localStorage technically exists,\n                // but has a max size of 0 bytes.\n                try {\n                    localStorage[key] = JSON.stringify(value);\n                }\n                catch (e) {\n                }\n            }\n        },\n\n        /**\n         * Returns element information from it's HTML.\n         *\n         * @param element\n         * @returns object\n         */\n        getElementInfo: function(element) {\n            var $element = $(element);\n\n            if (!$element.hasClass('element')) {\n                $element = $element.find('.element:first');\n            }\n\n            return {\n                id: $element.data('id'),\n                siteId: $element.data('site-id'),\n                label: $element.data('label'),\n                status: $element.data('status'),\n                url: $element.data('url'),\n                hasThumb: $element.hasClass('hasthumb'),\n                $element: $element\n            };\n        },\n\n        /**\n         * Changes an element to the requested size.\n         *\n         * @param element\n         * @param size\n         */\n        setElementSize: function(element, size) {\n            var $element = $(element);\n\n            if (size !== 'small' && size !== 'large') {\n                size = 'small';\n            }\n\n            if ($element.hasClass(size)) {\n                return;\n            }\n\n            var otherSize = (size === 'small' ? 'large' : 'small');\n\n            $element\n                .addClass(size)\n                .removeClass(otherSize);\n\n            if ($element.hasClass('hasthumb')) {\n                var $oldImg = $element.find('> .elementthumb > img'),\n                    imgSize = (size === 'small' ? '30' : '100'),\n                    $newImg = $('<img/>', {\n                        sizes: imgSize + 'px',\n                        srcset: $oldImg.attr('srcset') || $oldImg.attr('data-pfsrcset')\n                    });\n\n                $oldImg.replaceWith($newImg);\n\n                picturefill({\n                    elements: [$newImg[0]]\n                });\n            }\n        }\n    });\n\n\n// -------------------------------------------\n//  Custom jQuery plugins\n// -------------------------------------------\n\n$.extend($.fn,\n    {\n        animateLeft: function(pos, duration, easing, complete) {\n            if (Craft.orientation === 'ltr') {\n                return this.velocity({left: pos}, duration, easing, complete);\n            }\n            else {\n                return this.velocity({right: pos}, duration, easing, complete);\n            }\n        },\n\n        animateRight: function(pos, duration, easing, complete) {\n            if (Craft.orientation === 'ltr') {\n                return this.velocity({right: pos}, duration, easing, complete);\n            }\n            else {\n                return this.velocity({left: pos}, duration, easing, complete);\n            }\n        },\n\n        /**\n         * Disables elements by adding a .disabled class and preventing them from receiving focus.\n         */\n        disable: function() {\n            return this.each(function() {\n                var $elem = $(this);\n                $elem.addClass('disabled');\n\n                if ($elem.data('activatable')) {\n                    $elem.removeAttr('tabindex');\n                }\n            });\n        },\n\n        /**\n         * Enables elements by removing their .disabled class and allowing them to receive focus.\n         */\n        enable: function() {\n            return this.each(function() {\n                var $elem = $(this);\n                $elem.removeClass('disabled');\n\n                if ($elem.data('activatable')) {\n                    $elem.attr('tabindex', '0');\n                }\n            });\n        },\n\n        /**\n         * Sets the element as the container of a grid.\n         */\n        grid: function() {\n            return this.each(function() {\n                var $container = $(this),\n                    settings = {};\n\n                if ($container.data('item-selector')) {\n                    settings.itemSelector = $container.data('item-selector');\n                }\n                if ($container.data('cols')) {\n                    settings.cols = parseInt($container.data('cols'));\n                }\n                if ($container.data('max-cols')) {\n                    settings.maxCols = parseInt($container.data('max-cols'));\n                }\n                if ($container.data('min-col-width')) {\n                    settings.minColWidth = parseInt($container.data('min-col-width'));\n                }\n                if ($container.data('mode')) {\n                    settings.mode = $container.data('mode');\n                }\n                if ($container.data('fill-mode')) {\n                    settings.fillMode = $container.data('fill-mode');\n                }\n                if ($container.data('col-class')) {\n                    settings.colClass = $container.data('col-class');\n                }\n                if ($container.data('snap-to-grid')) {\n                    settings.snapToGrid = !!$container.data('snap-to-grid');\n                }\n\n                new Craft.Grid(this, settings);\n            });\n        },\n\n        infoicon: function() {\n            return this.each(function() {\n                new Craft.InfoIcon(this);\n            });\n        },\n\n        /**\n         * Sets the element as a container for a checkbox select.\n         */\n        checkboxselect: function() {\n            return this.each(function() {\n                if (!$.data(this, 'checkboxselect')) {\n                    new Garnish.CheckboxSelect(this);\n                }\n            });\n        },\n\n        /**\n         * Sets the element as a field toggle trigger.\n         */\n        fieldtoggle: function() {\n            return this.each(function() {\n                if (!$.data(this, 'fieldtoggle')) {\n                    new Craft.FieldToggle(this);\n                }\n            });\n        },\n\n        lightswitch: function(settings, settingName, settingValue) {\n            // param mapping\n            if (settings === 'settings') {\n                if (typeof settingName === 'string') {\n                    settings = {};\n                    settings[settingName] = settingValue;\n                }\n                else {\n                    settings = settingName;\n                }\n\n                return this.each(function() {\n                    var obj = $.data(this, 'lightswitch');\n                    if (obj) {\n                        obj.setSettings(settings);\n                    }\n                });\n            }\n            else {\n                if (!$.isPlainObject(settings)) {\n                    settings = {};\n                }\n\n                return this.each(function() {\n                    var thisSettings = $.extend({}, settings);\n\n                    if (Garnish.hasAttr(this, 'data-value')) {\n                        thisSettings.value = $(this).attr('data-value');\n                    }\n\n                    if (!$.data(this, 'lightswitch')) {\n                        new Craft.LightSwitch(this, thisSettings);\n                    }\n                });\n            }\n        },\n\n        nicetext: function() {\n            return this.each(function() {\n                if (!$.data(this, 'nicetext')) {\n                    new Garnish.NiceText(this);\n                }\n            });\n        },\n\n        pill: function() {\n            return this.each(function() {\n                if (!$.data(this, 'pill')) {\n                    new Garnish.Pill(this);\n                }\n            });\n        },\n\n        formsubmit: function() {\n            // Secondary form submit buttons\n            this.on('click', function(ev) {\n                var $btn = $(ev.currentTarget);\n\n                if ($btn.attr('data-confirm')) {\n                    if (!confirm($btn.attr('data-confirm'))) {\n                        return;\n                    }\n                }\n\n                var $anchor = $btn.data('menu') ? $btn.data('menu').$anchor : $btn;\n                var $form = $anchor.attr('data-form') ? $('#'+$anchor.attr('data-form')) : $anchor.closest('form');\n\n                if ($btn.data('action')) {\n                    $('<input type=\"hidden\" name=\"action\"/>')\n                        .val($btn.data('action'))\n                        .appendTo($form);\n                }\n\n                if ($btn.data('redirect')) {\n                    $('<input type=\"hidden\" name=\"redirect\"/>')\n                        .val($btn.data('redirect'))\n                        .appendTo($form);\n                }\n\n                if ($btn.data('param')) {\n                    $('<input type=\"hidden\"/>')\n                        .attr({\n                            name: $btn.data('param'),\n                            value: $btn.data('value')\n                        })\n                        .appendTo($form);\n                }\n\n                $form.trigger({\n                    type: 'submit',\n                    customTrigger: $btn,\n                });\n            });\n        },\n\n        menubtn: function() {\n            return this.each(function() {\n                var $btn = $(this);\n\n                if (!$btn.data('menubtn') && $btn.next().hasClass('menu')) {\n                    var settings = {};\n\n                    if ($btn.data('menu-anchor')) {\n                        settings.menuAnchor = $btn.data('menu-anchor');\n                    }\n\n                    new Garnish.MenuBtn($btn, settings);\n                }\n            });\n        }\n    });\n\n\nGarnish.$doc.ready(function() {\n    Craft.initUiElements();\n});\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Element editor\n */\nCraft.BaseElementEditor = Garnish.Base.extend(\n    {\n        $element: null,\n        elementId: null,\n        siteId: null,\n\n        $form: null,\n        $fieldsContainer: null,\n        $cancelBtn: null,\n        $saveBtn: null,\n        $spinner: null,\n\n        $siteSelect: null,\n        $siteSpinner: null,\n\n        hud: null,\n\n        init: function(element, settings) {\n            // Param mapping\n            if (typeof settings === 'undefined' && $.isPlainObject(element)) {\n                // (settings)\n                settings = element;\n                element = null;\n            }\n\n            this.$element = $(element);\n            this.setSettings(settings, Craft.BaseElementEditor.defaults);\n\n            this.loadHud();\n        },\n\n        setElementAttribute: function(name, value) {\n            if (!this.settings.attributes) {\n                this.settings.attributes = {};\n            }\n\n            if (value === null) {\n                delete this.settings.attributes[name];\n            }\n            else {\n                this.settings.attributes[name] = value;\n            }\n        },\n\n        getBaseData: function() {\n            var data = $.extend({}, this.settings.params);\n\n            if (this.settings.siteId) {\n                data.siteId = this.settings.siteId;\n            }\n            else if (this.$element && this.$element.data('site-id')) {\n                data.siteId = this.$element.data('site-id');\n            }\n\n            if (this.settings.elementId) {\n                data.elementId = this.settings.elementId;\n            }\n            else if (this.$element && this.$element.data('id')) {\n                data.elementId = this.$element.data('id');\n            }\n\n            if (this.settings.elementType) {\n                data.elementType = this.settings.elementType;\n            }\n\n            if (this.settings.attributes) {\n                data.attributes = this.settings.attributes;\n            }\n\n            if (this.settings.prevalidate) {\n                data.prevalidate = 1;\n            }\n\n            return data;\n        },\n\n        loadHud: function() {\n            this.onBeginLoading();\n            var data = this.getBaseData();\n            data.includeSites = Craft.isMultiSite && this.settings.showSiteSwitcher;\n            Craft.postActionRequest('elements/get-editor-html', data, $.proxy(this, 'showHud'));\n        },\n\n        showHud: function(response, textStatus) {\n            this.onEndLoading();\n\n            if (textStatus === 'success') {\n                var $hudContents = $();\n\n                if (response.sites) {\n                    var $header = $('<div class=\"hud-header\"/>');\n\n                    if (response.sites.length === 1) {\n                        $('<h5/>', {text: response.sites[0].name}).appendTo($header);;\n                    } else {\n                        var $siteSelectContainer = $('<div class=\"select\"/>').appendTo($header);\n\n                        this.$siteSelect = $('<select/>').appendTo($siteSelectContainer);\n                        this.$siteSpinner = $('<div class=\"spinner hidden\"/>').appendTo($header);\n\n                        for (var i = 0; i < response.sites.length; i++) {\n                            var siteInfo = response.sites[i];\n                            $('<option value=\"' + siteInfo.id + '\"' + (siteInfo.id == response.siteId ? ' selected=\"selected\"' : '') + '>' + siteInfo.name + '</option>').appendTo(this.$siteSelect);\n                        }\n\n                        this.addListener(this.$siteSelect, 'change', 'switchSite');\n                    }\n\n                    $hudContents = $hudContents.add($header);\n                }\n\n                this.$form = $('<div/>');\n                this.$fieldsContainer = $('<div class=\"fields\"/>').appendTo(this.$form);\n\n                this.updateForm(response);\n\n                this.onCreateForm(this.$form);\n\n                var $footer = $('<div class=\"hud-footer\"/>').appendTo(this.$form),\n                    $buttonsContainer = $('<div class=\"buttons right\"/>').appendTo($footer);\n                this.$cancelBtn = $('<div class=\"btn\">' + Craft.t('app', 'Cancel') + '</div>').appendTo($buttonsContainer);\n                this.$saveBtn = $('<input class=\"btn submit\" type=\"submit\" value=\"' + Craft.t('app', 'Save') + '\"/>').appendTo($buttonsContainer);\n                this.$spinner = $('<div class=\"spinner hidden\"/>').appendTo($buttonsContainer);\n\n                $hudContents = $hudContents.add(this.$form);\n\n                if (!this.hud) {\n                    var hudTrigger = (this.settings.hudTrigger || this.$element);\n\n                    this.hud = new Garnish.HUD(hudTrigger, $hudContents, {\n                        bodyClass: 'body elementeditor',\n                        closeOtherHUDs: false,\n                        onShow: $.proxy(this, 'onShowHud'),\n                        onHide: $.proxy(this, 'onHideHud'),\n                        onSubmit: $.proxy(this, 'saveElement')\n                    });\n\n                    this.hud.$hud.data('elementEditor', this);\n\n                    this.hud.on('hide', $.proxy(function() {\n                        delete this.hud;\n                    }, this));\n                }\n                else {\n                    this.hud.updateBody($hudContents);\n                    this.hud.updateSizeAndPosition();\n                }\n\n                // Focus on the first text input\n                $hudContents.find('.text:first').trigger('focus');\n\n                this.addListener(this.$cancelBtn, 'click', function() {\n                    this.hud.hide();\n                });\n            }\n        },\n\n        switchSite: function() {\n            var newSiteId = this.$siteSelect.val();\n\n            if (newSiteId == this.siteId) {\n                return;\n            }\n\n            this.$siteSpinner.removeClass('hidden');\n\n            this.reloadForm({ siteId: newSiteId }, $.proxy(function(textStatus) {\n                this.$siteSpinner.addClass('hidden');\n                if (textStatus !== 'success') {\n                    // Reset the site select\n                    this.$siteSelect.val(this.siteId);\n                }\n            }, this));\n        },\n\n        reloadForm: function(data, callback) {\n            data = $.extend(this.getBaseData(), data);\n\n            Craft.postActionRequest('elements/get-editor-html', data, $.proxy(function(response, textStatus) {\n                if (textStatus === 'success') {\n                    this.updateForm(response);\n                }\n\n                if (callback) {\n                    callback(textStatus);\n                }\n            }, this));\n        },\n\n        updateForm: function(response) {\n            this.siteId = response.siteId;\n\n            this.$fieldsContainer.html(response.html);\n\n            // Swap any instruction text with info icons\n            var $instructions = this.$fieldsContainer.find('> .meta > .field > .heading > .instructions');\n\n            for (var i = 0; i < $instructions.length; i++) {\n\n                $instructions.eq(i)\n                    .replaceWith($('<span/>', {\n                        'class': 'info',\n                        'html': $instructions.eq(i).children().html()\n                    }))\n                    .infoicon();\n            }\n\n            Garnish.requestAnimationFrame($.proxy(function() {\n                Craft.appendHeadHtml(response.headHtml);\n                Craft.appendFootHtml(response.footHtml);\n                Craft.initUiElements(this.$fieldsContainer);\n            }, this));\n        },\n\n        saveElement: function() {\n            var validators = this.settings.validators;\n\n            if ($.isArray(validators)) {\n                for (var i = 0; i < validators.length; i++) {\n                    if ($.isFunction(validators[i]) && !validators[i].call()) {\n                        return false;\n                    }\n                }\n            }\n\n            this.$spinner.removeClass('hidden');\n\n            var data = $.param(this.getBaseData()) + '&' + this.hud.$body.serialize();\n            Craft.postActionRequest('elements/save-element', data, $.proxy(function(response, textStatus) {\n                this.$spinner.addClass('hidden');\n\n                if (textStatus === 'success') {\n                    if (response.success) {\n                        if (this.$element && this.siteId == this.$element.data('site-id')) {\n                            // Update the label\n                            var $title = this.$element.find('.title'),\n                                $a = $title.find('a');\n\n                            if ($a.length && response.cpEditUrl) {\n                                $a.attr('href', response.cpEditUrl);\n                                $a.text(response.newTitle);\n                            }\n                            else {\n                                $title.text(response.newTitle);\n                            }\n                        }\n\n                        this.closeHud();\n                        this.onSaveElement(response);\n                    }\n                    else {\n                        this.updateForm(response);\n                        Garnish.shake(this.hud.$hud);\n                    }\n                }\n            }, this));\n        },\n\n        closeHud: function() {\n            this.hud.hide();\n            delete this.hud;\n        },\n\n        // Events\n        // -------------------------------------------------------------------------\n\n        onShowHud: function() {\n            this.settings.onShowHud();\n            this.trigger('showHud');\n        },\n\n        onHideHud: function() {\n            this.settings.onHideHud();\n            this.trigger('hideHud');\n        },\n\n        onBeginLoading: function() {\n            if (this.$element) {\n                this.$element.addClass('loading');\n            }\n\n            this.settings.onBeginLoading();\n            this.trigger('beginLoading');\n        },\n\n        onEndLoading: function() {\n            if (this.$element) {\n                this.$element.removeClass('loading');\n            }\n\n            this.settings.onEndLoading();\n            this.trigger('endLoading');\n        },\n\n        onSaveElement: function(response) {\n            this.settings.onSaveElement(response);\n            this.trigger('saveElement', {\n                response: response\n            });\n\n            // There may be a new background job that needs to be run\n            Craft.cp.runQueue();\n        },\n\n        onCreateForm: function($form) {\n            this.settings.onCreateForm($form);\n        }\n    },\n    {\n        defaults: {\n            hudTrigger: null,\n            showSiteSwitcher: true,\n            elementId: null,\n            elementType: null,\n            siteId: null,\n            attributes: null,\n            params: null,\n            prevalidate: false,\n            elementIndex: null,\n\n            onShowHud: $.noop,\n            onHideHud: $.noop,\n            onBeginLoading: $.noop,\n            onEndLoading: $.noop,\n            onCreateForm: $.noop,\n            onSaveElement: $.noop,\n\n            validators: []\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Element index class\n */\nCraft.BaseElementIndex = Garnish.Base.extend(\n    {\n        // Properties\n        // =========================================================================\n\n        initialized: false,\n        elementType: null,\n\n        instanceState: null,\n        sourceStates: null,\n        sourceStatesStorageKey: null,\n\n        searchTimeout: null,\n        sourceSelect: null,\n\n        $container: null,\n        $main: null,\n        $mainSpinner: null,\n        isIndexBusy: false,\n\n        $sidebar: null,\n        showingSidebar: null,\n        sourceKey: null,\n        sourceViewModes: null,\n        $source: null,\n        sourcesByKey: null,\n        $visibleSources: null,\n\n        $customizeSourcesBtn: null,\n        customizeSourcesModal: null,\n\n        $toolbar: null,\n        $toolbarFlexContainer: null,\n        toolbarOffset: null,\n\n        $search: null,\n        searching: false,\n        searchText: null,\n        trashed: false,\n        drafts: false,\n        $clearSearchBtn: null,\n\n        $statusMenuBtn: null,\n        $statusMenuContainer: null,\n        statusMenu: null,\n        status: null,\n\n        $siteMenuBtn: null,\n        siteMenu: null,\n        siteId: null,\n\n        $sortMenuBtn: null,\n        sortMenu: null,\n        $sortAttributesList: null,\n        $sortDirectionsList: null,\n        $scoreSortAttribute: null,\n        $structureSortAttribute: null,\n\n        $elements: null,\n        $viewModeBtnContainer: null,\n        viewModeBtns: null,\n        viewMode: null,\n        view: null,\n        _autoSelectElements: null,\n        $countContainer: null,\n        page: 1,\n        $exportBtn: null,\n\n        actions: null,\n        actionsHeadHtml: null,\n        actionsFootHtml: null,\n        $selectAllContainer: null,\n        $selectAllCheckbox: null,\n        showingActionTriggers: false,\n        _$detachedToolbarItems: null,\n        _$triggers: null,\n\n        // Public methods\n        // =========================================================================\n\n        /**\n         * Constructor\n         */\n        init: function(elementType, $container, settings) {\n            this.elementType = elementType;\n            this.$container = $container;\n            this.setSettings(settings, Craft.BaseElementIndex.defaults);\n\n            // Set the state objects\n            // ---------------------------------------------------------------------\n\n            this.instanceState = this.getDefaultInstanceState();\n\n            this.sourceStates = {};\n\n            // Instance states (selected source) are stored by a custom storage key defined in the settings\n            if (this.settings.storageKey) {\n                $.extend(this.instanceState, Craft.getLocalStorage(this.settings.storageKey), {});\n            }\n\n            // Source states (view mode, etc.) are stored by the element type and context\n            this.sourceStatesStorageKey = 'BaseElementIndex.' + this.elementType + '.' + this.settings.context;\n            $.extend(this.sourceStates, Craft.getLocalStorage(this.sourceStatesStorageKey, {}));\n\n            // Find the DOM elements\n            // ---------------------------------------------------------------------\n\n            this.$main = this.$container.find('.main');\n            this.$toolbar = this.$container.find('.toolbar:first');\n            this.$toolbarFlexContainer = this.$toolbar.children('.flex');\n            this.$statusMenuBtn = this.$toolbarFlexContainer.find('.statusmenubtn:first');\n            this.$statusMenuContainer = this.$statusMenuBtn.parent();\n            this.$siteMenuBtn = this.$container.find('.sitemenubtn:first');\n            this.$sortMenuBtn = this.$toolbarFlexContainer.find('.sortmenubtn:first');\n            this.$search = this.$toolbarFlexContainer.find('.search:first input:first');\n            this.$clearSearchBtn = this.$toolbarFlexContainer.find('.search:first > .clear');\n            this.$mainSpinner = this.$toolbarFlexContainer.find('.spinner:first');\n            this.$sidebar = this.$container.find('.sidebar:first');\n            this.$customizeSourcesBtn = this.$sidebar.find('.customize-sources');\n            this.$elements = this.$container.find('.elements:first');\n            this.$countContainer = this.$container.find('#count-container');\n            this.$exportBtn = this.$container.find('#export-btn');\n\n            // Hide sidebar if needed\n            if (this.settings.hideSidebar) {\n                this.$sidebar.hide();\n                $('.body, .content', this.$container).removeClass('has-sidebar');\n            }\n\n            // Keep the toolbar at the top of the window\n            if (\n                (this.settings.toolbarFixed || (this.settings.toolbarFixed === null && this.settings.context === 'index')) &&\n                !Garnish.isMobileBrowser(true)\n            ) {\n                this.addListener(Garnish.$win, 'resize', 'updateFixedToolbar');\n                this.addListener(Garnish.$scrollContainer, 'scroll', 'updateFixedToolbar');\n            }\n\n            // Initialize the sources\n            // ---------------------------------------------------------------------\n\n            if (!this.initSources()) {\n                return;\n            }\n\n            // Customize button\n            if (this.$customizeSourcesBtn.length) {\n                this.addListener(this.$customizeSourcesBtn, 'click', 'createCustomizeSourcesModal');\n            }\n\n            // Initialize the status menu\n            // ---------------------------------------------------------------------\n\n            if (this.$statusMenuBtn.length) {\n                this.statusMenu = this.$statusMenuBtn.menubtn().data('menubtn').menu;\n                this.statusMenu.on('optionselect', $.proxy(this, '_handleStatusChange'));\n            }\n\n            // Initialize the site menu\n            // ---------------------------------------------------------------------\n\n            // Is there a site menu?\n            if (this.$siteMenuBtn.length) {\n                this.siteMenu = this.$siteMenuBtn.menubtn().data('menubtn').menu;\n\n                // Figure out the initial site\n                var $option = this.siteMenu.$options.filter('.sel:first');\n\n                if (!$option.length) {\n                    $option = this.siteMenu.$options.first();\n                }\n\n                if ($option.length) {\n                    this._setSite($option.data('site-id'));\n                } else {\n                    // No site options -- they must not have any site permissions\n                    this.settings.criteria = {id: '0'};\n                }\n\n                this.siteMenu.on('optionselect', $.proxy(this, '_handleSiteChange'));\n\n                if (this.siteId) {\n                    // Do we have a different site stored in localStorage?\n                    var storedSiteId = Craft.getLocalStorage('BaseElementIndex.siteId');\n\n                    if (storedSiteId && storedSiteId != this.siteId) {\n                        // Is that one available here?\n                        var $storedSiteOption = this.siteMenu.$options.filter('[data-site-id=\"' + storedSiteId + '\"]:first');\n\n                        if ($storedSiteOption.length) {\n                            // Todo: switch this to siteMenu.selectOption($storedSiteOption) once Menu is updated to support that\n                            $storedSiteOption.trigger('click');\n                        }\n                    }\n                }\n            } else if (this.settings.criteria && this.settings.criteria.siteId) {\n                this._setSite(this.settings.criteria.siteId);\n            } else {\n                this._setSite(Craft.siteId);\n            }\n\n            // Initialize the search input\n            // ---------------------------------------------------------------------\n\n            // Automatically update the elements after new search text has been sitting for a 1/2 second\n            this.addListener(this.$search, 'textchange', $.proxy(function() {\n                if (!this.searching && this.$search.val()) {\n                    this.startSearching();\n                } else if (this.searching && !this.$search.val()) {\n                    this.stopSearching();\n                }\n\n                if (this.searchTimeout) {\n                    clearTimeout(this.searchTimeout);\n                }\n\n                this.searchTimeout = setTimeout($.proxy(this, 'updateElementsIfSearchTextChanged'), 500);\n            }, this));\n\n            // Update the elements when the Return key is pressed\n            this.addListener(this.$search, 'keypress', $.proxy(function(ev) {\n                if (ev.keyCode === Garnish.RETURN_KEY) {\n                    ev.preventDefault();\n\n                    if (this.searchTimeout) {\n                        clearTimeout(this.searchTimeout);\n                    }\n\n                    this.updateElementsIfSearchTextChanged();\n                }\n            }, this));\n\n            // Clear the search when the X button is clicked\n            this.addListener(this.$clearSearchBtn, 'click', $.proxy(function() {\n                this.$search.val('');\n\n                if (this.searchTimeout) {\n                    clearTimeout(this.searchTimeout);\n                }\n\n                if (!Garnish.isMobileBrowser(true)) {\n                    this.$search.trigger('focus');\n                }\n\n                this.stopSearching();\n\n                this.updateElementsIfSearchTextChanged();\n\n            }, this));\n\n            // Auto-focus the Search box\n            if (!Garnish.isMobileBrowser(true)) {\n                this.$search.trigger('focus');\n            }\n\n            // Initialize the sort menu\n            // ---------------------------------------------------------------------\n\n            // Is there a sort menu?\n            if (this.$sortMenuBtn.length) {\n                this.sortMenu = this.$sortMenuBtn.menubtn().data('menubtn').menu;\n                this.$sortAttributesList = this.sortMenu.$container.children('.sort-attributes');\n                this.$sortDirectionsList = this.sortMenu.$container.children('.sort-directions');\n\n                this.sortMenu.on('optionselect', $.proxy(this, '_handleSortChange'));\n            }\n\n            // Initialize the Export button\n            // ---------------------------------------------------------------------\n\n            this.addListener(this.$exportBtn, 'click', '_showExportHud');\n\n            // Let everyone know that the UI is initialized\n            // ---------------------------------------------------------------------\n\n            this.initialized = true;\n            this.afterInit();\n\n            // Select the initial source\n            // ---------------------------------------------------------------------\n\n            this.selectDefaultSource();\n\n            // Load the first batch of elements!\n            // ---------------------------------------------------------------------\n\n            // Default to whatever page is in the URL\n            if (this.settings.context === 'index') {\n                this.setPage(Craft.pageNum);\n            }\n\n            this.updateElements(true);\n        },\n\n        afterInit: function() {\n            this.onAfterInit();\n        },\n\n        getSourceContainer: function() {\n            return this.$sidebar.find('nav>ul');\n        },\n\n        get $sources() {\n            if (!this.sourceSelect) {\n                return undefined;\n            }\n\n            return this.sourceSelect.$items;\n        },\n\n        initSources: function() {\n            var $sources = this._getSourcesInList(this.getSourceContainer());\n\n            // No source, no party.\n            if ($sources.length === 0) {\n                return false;\n            }\n\n            // The source selector\n            if (!this.sourceSelect) {\n                this.sourceSelect = new Garnish.Select(this.$sidebar.find('nav'), {\n                    multi: false,\n                    allowEmpty: false,\n                    vertical: true,\n                    onSelectionChange: $.proxy(this, '_handleSourceSelectionChange')\n                });\n            }\n\n            this.sourcesByKey = {};\n            this._initSources($sources);\n\n            return true;\n        },\n\n        selectDefaultSource: function() {\n            var sourceKey = this.getDefaultSourceKey(),\n                $source;\n\n            if (sourceKey) {\n                $source = this.getSourceByKey(sourceKey);\n\n                // Make sure it's visible\n                if (this.$visibleSources.index($source) === -1) {\n                    $source = null;\n                }\n            }\n\n            if (!sourceKey || !$source) {\n                // Select the first source by default\n                $source = this.$visibleSources.first();\n            }\n\n            if ($source.length) {\n                this.selectSource($source);\n            }\n        },\n\n        refreshSources: function() {\n            this.sourceSelect.removeAllItems();\n\n            var params = {\n                context: this.settings.context,\n                elementType: this.elementType\n            };\n\n            this.setIndexBusy();\n\n            Craft.postActionRequest(this.settings.refreshSourcesAction, params, $.proxy(function(response, textStatus) {\n                this.setIndexAvailable();\n\n                if (textStatus === 'success') {\n                    this.getSourceContainer().replaceWith(response.html);\n                    this.initSources();\n                    this.selectDefaultSource();\n                } else {\n                    Craft.cp.displayError(Craft.t('app', 'An unknown error occurred.'));\n                }\n\n            }, this));\n        },\n\n        updateFixedToolbar: function(e) {\n            this.updateFixedToolbar._scrollTop = Garnish.$scrollContainer.scrollTop();\n\n            if (Garnish.$win.width() > 992 && this.updateFixedToolbar._scrollTop >= 17) {\n                if (this.updateFixedToolbar._makingFixed = !this.$toolbar.hasClass('fixed')) {\n                    this.$elements.css('padding-top', (this.$toolbar.outerHeight() + 21));\n                    this.$toolbar.addClass('fixed');\n                }\n\n                if (this.updateFixedToolbar._makingFixed || e.type === 'resize') {\n                    this.$toolbar.css({\n                        top: Garnish.$scrollContainer.offset().top,\n                        width: this.$main.width()\n                    });\n                }\n            } else {\n                if (this.$toolbar.hasClass('fixed')) {\n                    this.$toolbar.removeClass('fixed');\n                    this.$toolbar.css('width', '');\n                    this.$elements.css('padding-top', '');\n                    this.$toolbar.css('top', '0');\n                }\n            }\n        },\n\n        initSource: function($source) {\n            this.sourceSelect.addItems($source);\n            this.initSourceToggle($source);\n            this.sourcesByKey[$source.data('key')] = $source;\n\n            if ($source.data('hasNestedSources') && this.instanceState.expandedSources.indexOf($source.data('key')) !== -1) {\n                this._expandSource($source);\n            }\n        },\n\n        initSourceToggle: function($source) {\n            // Remove handlers for the same thing. Just in case.\n            this.deinitSourceToggle($source);\n\n            var $toggle = this._getSourceToggle($source);\n\n            if ($toggle.length) {\n                this.addListener($source, 'dblclick', '_handleSourceDblClick');\n                this.addListener($toggle, 'click', '_handleSourceToggleClick');\n                $source.data('hasNestedSources', true);\n            } else {\n                $source.data('hasNestedSources', false);\n            }\n        },\n\n        deinitSource: function($source) {\n            this.sourceSelect.removeItems($source);\n            this.deinitSourceToggle($source);\n            delete this.sourcesByKey[$source.data('key')];\n        },\n\n        deinitSourceToggle: function($source) {\n            if ($source.data('hasNestedSources')) {\n                this.removeListener($source, 'dblclick');\n                this.removeListener(this._getSourceToggle($source), 'click');\n            }\n\n            $source.removeData('hasNestedSources');\n        },\n\n        getDefaultInstanceState: function() {\n            return {\n                selectedSource: null,\n                expandedSources: []\n            };\n        },\n\n        getDefaultSourceKey: function() {\n            return this.instanceState.selectedSource;\n        },\n\n        getDefaultExpandedSources: function() {\n            return this.instanceState.expandedSources;\n        },\n\n        startSearching: function() {\n            // Show the clear button and add/select the Score sort option\n            this.$clearSearchBtn.removeClass('hidden');\n\n            if (!this.$scoreSortAttribute) {\n                this.$scoreSortAttribute = $('<li><a data-attr=\"score\">' + Craft.t('app', 'Score') + '</a></li>');\n                this.sortMenu.addOptions(this.$scoreSortAttribute.children());\n            }\n\n            this.$scoreSortAttribute.prependTo(this.$sortAttributesList);\n\n            this.searching = true;\n\n            this._updateStructureSortOption();\n            this.setSortAttribute('score');\n        },\n\n        stopSearching: function() {\n            // Hide the clear button and Score sort option\n            this.$clearSearchBtn.addClass('hidden');\n\n            this.$scoreSortAttribute.detach();\n\n            this.searching = false;\n\n            this._updateStructureSortOption();\n        },\n\n        setInstanceState: function(key, value) {\n            if (typeof key === 'object') {\n                $.extend(this.instanceState, key);\n            } else {\n                this.instanceState[key] = value;\n            }\n\n            this.storeInstanceState();\n        },\n\n        storeInstanceState: function() {\n            if (this.settings.storageKey) {\n                Craft.setLocalStorage(this.settings.storageKey, this.instanceState);\n            }\n        },\n\n        getSourceState: function(source, key, defaultValue) {\n            if (typeof this.sourceStates[source] === 'undefined') {\n                // Set it now so any modifications to it by whoever's calling this will be stored.\n                this.sourceStates[source] = {};\n            }\n\n            if (typeof key === 'undefined') {\n                return this.sourceStates[source];\n            } else if (typeof this.sourceStates[source][key] !== 'undefined') {\n                return this.sourceStates[source][key];\n            } else {\n                return (typeof defaultValue !== 'undefined' ? defaultValue : null);\n            }\n        },\n\n        getSelectedSourceState: function(key, defaultValue) {\n            return this.getSourceState(this.instanceState.selectedSource, key, defaultValue);\n        },\n\n        setSelecetedSourceState: function(key, value) {\n            var viewState = this.getSelectedSourceState();\n\n            if (typeof key === 'object') {\n                $.extend(viewState, key);\n            } else {\n                viewState[key] = value;\n            }\n\n            this.sourceStates[this.instanceState.selectedSource] = viewState;\n\n            // Store it in localStorage too\n            Craft.setLocalStorage(this.sourceStatesStorageKey, this.sourceStates);\n        },\n\n        storeSortAttributeAndDirection: function() {\n            var attr = this.getSelectedSortAttribute();\n\n            if (attr !== 'score') {\n                this.setSelecetedSourceState({\n                    order: attr,\n                    sort: this.getSelectedSortDirection()\n                });\n            }\n        },\n\n        /**\n         * Sets the page number.\n         */\n        setPage: function(page) {\n            page = Math.max(page, 1);\n            this.page = page;\n\n            // Update the URL\n            var url = document.location.href\n                .replace(/\\?.*$/, '')\n                .replace(new RegExp('/' + Craft.pageTrigger.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&') + '\\\\d+$'), '')\n                .replace(/\\/+$/, '');\n\n            if (this.page !== 1) {\n                if (Craft.pageTrigger[0] !== '?') {\n                    url += '/';\n                }\n                url += Craft.pageTrigger + this.page;\n            }\n\n            history.replaceState({}, '', url);\n        },\n\n        /**\n         * Returns the data that should be passed to the elementIndex/getElements controller action\n         * when loading elements.\n         */\n        getViewParams: function() {\n            var criteria = {\n                siteId: this.siteId,\n                search: this.searchText,\n                offset: this.settings.batchSize * (this.page - 1),\n                limit: this.settings.batchSize,\n                trashed: this.trashed ? 1 : 0,\n                drafts: this.drafts ? 1 : 0,\n            };\n\n            if (!Garnish.hasAttr(this.$source, 'data-override-status')) {\n                criteria.status = this.status;\n            }\n\n            $.extend(criteria, this.settings.criteria);\n\n            var params = {\n                context: this.settings.context,\n                elementType: this.elementType,\n                source: this.instanceState.selectedSource,\n                criteria: criteria,\n                disabledElementIds: this.settings.disabledElementIds,\n                viewState: $.extend({}, this.getSelectedSourceState()),\n                paginated: this._isViewPaginated() ? 1 : 0,\n            };\n\n            // Possible that the order/sort isn't entirely accurate if we're sorting by Score\n            params.viewState.order = this.getSelectedSortAttribute();\n            params.viewState.sort = this.getSelectedSortDirection();\n\n            if (this.getSelectedSortAttribute() === 'structure') {\n                if (typeof this.instanceState.collapsedElementIds === 'undefined') {\n                    this.instanceState.collapsedElementIds = [];\n                }\n                params.collapsedElementIds = this.instanceState.collapsedElementIds;\n            }\n\n            return params;\n        },\n\n        updateElements: function(preservePagination) {\n            // Ignore if we're not fully initialized yet\n            if (!this.initialized) {\n                return;\n            }\n\n            this.setIndexBusy();\n\n            // Kill the old view class\n            if (this.view) {\n                this.view.destroy();\n                delete this.view;\n            }\n\n            this.$elements.html('');\n\n            if (preservePagination !== true) {\n                this.$countContainer.html('&nbsp;');\n                this.setPage(1);\n            }\n\n            var params = this.getViewParams();\n\n            Craft.postActionRequest(this.settings.updateElementsAction, params, $.proxy(function(response, textStatus) {\n                this.setIndexAvailable();\n\n                if (textStatus === 'success') {\n                    // Have we gone too far?\n                    var totalPages = Math.max(Math.ceil(response.count / this.settings.batchSize), 1);\n                    if (this.page > totalPages) {\n                        this.setPage(totalPages);\n                        this.updateElements(true);\n                        return;\n                    }\n\n                    this._updateView(params, response);\n                } else {\n                    Craft.cp.displayError(Craft.t('app', 'An unknown error occurred.'));\n                }\n\n            }, this));\n        },\n\n        updateElementsIfSearchTextChanged: function() {\n            if (this.searchText !== (this.searchText = this.searching ? this.$search.val() : null)) {\n                this.updateElements();\n            }\n        },\n\n        showActionTriggers: function() {\n            // Ignore if they're already shown\n            if (this.showingActionTriggers) {\n                return;\n            }\n\n            // Hard-code the min toolbar height in case it was taller than the actions toolbar\n            // (prevents the elements from jumping if this ends up being a double-click)\n            this.$toolbar.css('min-height', this.$toolbar.height());\n\n            // Hide any toolbar inputs\n            this._$detachedToolbarItems = this.$toolbarFlexContainer.children().not(this.$selectAllContainer).not(this.$mainSpinner);\n            this._$detachedToolbarItems.detach();\n\n            if (!this._$triggers) {\n                this._createTriggers();\n            } else {\n                this._$triggers.insertAfter(this.$selectAllContainer);\n            }\n\n            this.showingActionTriggers = true;\n        },\n\n        submitAction: function(actionClass, actionParams) {\n            // Make sure something's selected\n            var selectedElementIds = this.view.getSelectedElementIds(),\n                totalSelected = selectedElementIds.length;\n\n            if (totalSelected === 0) {\n                return;\n            }\n\n            // Find the action\n            var action;\n\n            for (var i = 0; i < this.actions.length; i++) {\n                if (this.actions[i].type === actionClass) {\n                    action = this.actions[i];\n                    break;\n                }\n            }\n\n            if (!action || (action.confirm && !confirm(action.confirm))) {\n                return;\n            }\n\n            // Get ready to submit\n            var viewParams = this.getViewParams();\n\n            var params = $.extend(viewParams, actionParams, {\n                elementAction: actionClass,\n                elementIds: selectedElementIds\n            });\n\n            // Do it\n            this.setIndexBusy();\n            this._autoSelectElements = selectedElementIds;\n\n            Craft.postActionRequest(this.settings.submitActionsAction, params, $.proxy(function(response, textStatus) {\n                this.setIndexAvailable();\n\n                if (textStatus === 'success') {\n                    if (response.success) {\n                        this._updateView(viewParams, response);\n\n                        if (response.message) {\n                            Craft.cp.displayNotice(response.message);\n                        }\n\n                        this.afterAction(action, params);\n                    } else {\n                        Craft.cp.displayError(response.message);\n                    }\n                }\n            }, this));\n        },\n\n        afterAction: function(action, params) {\n\n            // There may be a new background job that needs to be run\n            Craft.cp.runQueue();\n\n            this.onAfterAction(action, params);\n        },\n\n        hideActionTriggers: function() {\n            // Ignore if there aren't any\n            if (!this.showingActionTriggers) {\n                return;\n            }\n\n            this._$detachedToolbarItems.insertBefore(this.$mainSpinner);\n            this._$triggers.detach();\n\n            this.$toolbarFlexContainer.children().not(this.$selectAllContainer).removeClass('hidden');\n\n            // Unset the min toolbar height\n            this.$toolbar.css('min-height', '');\n\n            this.showingActionTriggers = false;\n        },\n\n        updateActionTriggers: function() {\n            // Do we have an action UI to update?\n            if (this.actions) {\n                var totalSelected = this.view.getSelectedElements().length;\n\n                if (totalSelected !== 0) {\n                    if (totalSelected === this.view.getEnabledElements().length) {\n                        this.$selectAllCheckbox.removeClass('indeterminate');\n                        this.$selectAllCheckbox.addClass('checked');\n                        this.$selectAllBtn.attr('aria-checked', 'true');\n                    } else {\n                        this.$selectAllCheckbox.addClass('indeterminate');\n                        this.$selectAllCheckbox.removeClass('checked');\n                        this.$selectAllBtn.attr('aria-checked', 'mixed');\n                    }\n\n                    this.showActionTriggers();\n                } else {\n                    this.$selectAllCheckbox.removeClass('indeterminate checked');\n                    this.$selectAllBtn.attr('aria-checked', 'false');\n                    this.hideActionTriggers();\n                }\n            }\n        },\n\n        getSelectedElements: function() {\n            return this.view ? this.view.getSelectedElements() : $();\n        },\n\n        getSelectedElementIds: function() {\n            return this.view ? this.view.getSelectedElementIds() : [];\n        },\n\n        getSortAttributeOption: function(attr) {\n            return this.$sortAttributesList.find('a[data-attr=\"' + attr + '\"]:first');\n        },\n\n        getSelectedSortAttribute: function() {\n            return this.$sortAttributesList.find('a.sel:first').data('attr');\n        },\n\n        setSortAttribute: function(attr) {\n            // Find the option (and make sure it actually exists)\n            var $option = this.getSortAttributeOption(attr);\n\n            if ($option.length) {\n                this.$sortAttributesList.find('a.sel').removeClass('sel');\n                $option.addClass('sel');\n\n                var label = $option.text();\n                this.$sortMenuBtn.attr('title', Craft.t('app', 'Sort by {attribute}', {attribute: label}));\n                this.$sortMenuBtn.text(label);\n\n                this.setSortDirection(attr === 'score' ? 'desc' : 'asc');\n\n                if (attr === 'structure') {\n                    this.$sortDirectionsList.find('a').addClass('disabled');\n                } else {\n                    this.$sortDirectionsList.find('a').removeClass('disabled');\n                }\n            }\n        },\n\n        getSortDirectionOption: function(dir) {\n            return this.$sortDirectionsList.find('a[data-dir=' + dir + ']:first');\n        },\n\n        getSelectedSortDirection: function() {\n            return this.$sortDirectionsList.find('a.sel:first').data('dir');\n        },\n\n        getSelectedViewMode: function() {\n            return this.getSelectedSourceState('mode');\n        },\n\n        setSortDirection: function(dir) {\n            if (dir !== 'desc') {\n                dir = 'asc';\n            }\n\n            this.$sortMenuBtn.attr('data-icon', dir);\n            this.$sortDirectionsList.find('a.sel').removeClass('sel');\n            this.getSortDirectionOption(dir).addClass('sel');\n        },\n\n        getSourceByKey: function(key) {\n            if (typeof this.sourcesByKey[key] === 'undefined') {\n                return null;\n            }\n\n            return this.sourcesByKey[key];\n        },\n\n        selectSource: function($source) {\n            if (!$source || !$source.length) {\n                return false;\n            }\n\n            if (this.$source && this.$source[0] && this.$source[0] === $source[0] && $source.data('key') === this.sourceKey) {\n                return false;\n            }\n\n            // Hide action triggers if they're currently being shown\n            this.hideActionTriggers();\n\n            this.$source = $source;\n            this.sourceKey = $source.data('key');\n            this.setInstanceState('selectedSource', this.sourceKey);\n            this.sourceSelect.selectItem($source);\n\n            Craft.cp.updateSidebarMenuLabel();\n\n            if (this.searching) {\n                // Clear the search value without causing it to update elements\n                this.searchText = null;\n                this.$search.val('');\n                this.stopSearching();\n            }\n\n            // Sort menu\n            // ----------------------------------------------------------------------\n\n            // Does this source have a structure?\n            if (Garnish.hasAttr(this.$source, 'data-has-structure')) {\n                if (!this.$structureSortAttribute) {\n                    this.$structureSortAttribute = $('<li><a data-attr=\"structure\">' + Craft.t('app', 'Structure') + '</a></li>');\n                    this.sortMenu.addOptions(this.$structureSortAttribute.children());\n                }\n\n                this.$structureSortAttribute.prependTo(this.$sortAttributesList);\n            } else if (this.$structureSortAttribute) {\n                this.$structureSortAttribute.removeClass('sel').detach();\n            }\n\n            this.setStoredSortOptionsForSource();\n\n            // Status menu\n            // ----------------------------------------------------------------------\n\n            if (this.$statusMenuBtn.length) {\n                if (Garnish.hasAttr(this.$source, 'data-override-status')) {\n                    this.$statusMenuContainer.addClass('hidden');\n                } else {\n                    this.$statusMenuContainer.removeClass('hidden');\n                }\n            }\n\n            // View mode buttons\n            // ----------------------------------------------------------------------\n\n            // Clear out any previous view mode data\n            if (this.$viewModeBtnContainer) {\n                this.$viewModeBtnContainer.remove();\n            }\n\n            this.viewModeBtns = {};\n            this.viewMode = null;\n\n            // Get the new list of view modes\n            this.sourceViewModes = this.getViewModesForSource();\n\n            // Create the buttons if there's more than one mode available to this source\n            if (this.sourceViewModes.length > 1) {\n                this.$viewModeBtnContainer = $('<div class=\"btngroup\"/>').insertBefore(this.$mainSpinner);\n\n                for (var i = 0; i < this.sourceViewModes.length; i++) {\n                    var sourceViewMode = this.sourceViewModes[i];\n\n                    var $viewModeBtn = $('<div data-view=\"' + sourceViewMode.mode + '\" role=\"button\"' +\n                        ' class=\"btn' + (typeof sourceViewMode.className !== 'undefined' ? ' ' + sourceViewMode.className : '') + '\"' +\n                        ' title=\"' + sourceViewMode.title + '\"' +\n                        (typeof sourceViewMode.icon !== 'undefined' ? ' data-icon=\"' + sourceViewMode.icon + '\"' : '') +\n                        '/>'\n                    ).appendTo(this.$viewModeBtnContainer);\n\n                    this.viewModeBtns[sourceViewMode.mode] = $viewModeBtn;\n\n                    this.addListener($viewModeBtn, 'click', {mode: sourceViewMode.mode}, function(ev) {\n                        this.selectViewMode(ev.data.mode);\n                        this.updateElements();\n                    });\n                }\n            }\n\n            // Figure out which mode we should start with\n            var viewMode = this.getSelectedViewMode();\n\n            if (!viewMode || !this.doesSourceHaveViewMode(viewMode)) {\n                // Try to keep using the current view mode\n                if (this.viewMode && this.doesSourceHaveViewMode(this.viewMode)) {\n                    viewMode = this.viewMode;\n                }\n                // Just use the first one\n                else {\n                    viewMode = this.sourceViewModes[0].mode;\n                }\n            }\n\n            this.selectViewMode(viewMode);\n\n            this.onSelectSource();\n\n            return true;\n        },\n\n        selectSourceByKey: function(key) {\n            var $source = this.getSourceByKey(key);\n\n            if ($source) {\n                return this.selectSource($source);\n            } else {\n                return false;\n            }\n        },\n\n        setStoredSortOptionsForSource: function() {\n            var sortAttr = this.getSelectedSourceState('order'),\n                sortDir = this.getSelectedSourceState('sort');\n\n            if (!sortAttr || !sortDir) {\n                // Get the default\n                sortAttr = this.getDefaultSort();\n\n                if (Garnish.isArray(sortAttr)) {\n                    sortDir = sortAttr[1];\n                    sortAttr = sortAttr[0];\n                }\n            }\n\n            if (sortDir !== 'asc' && sortDir !== 'desc') {\n                sortDir = 'asc';\n            }\n\n            this.setSortAttribute(sortAttr);\n            this.setSortDirection(sortDir);\n        },\n\n        getDefaultSort: function() {\n            // Does the source specify what to do?\n            if (this.$source && Garnish.hasAttr(this.$source, 'data-default-sort')) {\n                return this.$source.attr('data-default-sort').split(':');\n            } else {\n                // Default to whatever's first\n                return [this.$sortAttributesList.find('a:first').data('attr'), 'asc'];\n            }\n        },\n\n        getViewModesForSource: function() {\n            var viewModes = [\n                {mode: 'table', title: Craft.t('app', 'Display in a table'), icon: 'list'}\n            ];\n\n            if (this.$source && Garnish.hasAttr(this.$source, 'data-has-thumbs')) {\n                viewModes.push({mode: 'thumbs', title: Craft.t('app', 'Display as thumbnails'), icon: 'grid'});\n            }\n\n            return viewModes;\n        },\n\n        doesSourceHaveViewMode: function(viewMode) {\n            for (var i = 0; i < this.sourceViewModes.length; i++) {\n                if (this.sourceViewModes[i].mode === viewMode) {\n                    return true;\n                }\n            }\n\n            return false;\n        },\n\n        selectViewMode: function(viewMode, force) {\n            // Make sure that the current source supports it\n            if (!force && !this.doesSourceHaveViewMode(viewMode)) {\n                viewMode = this.sourceViewModes[0].mode;\n            }\n\n            // Has anything changed?\n            if (viewMode === this.viewMode) {\n                return;\n            }\n\n            // Deselect the previous view mode\n            if (this.viewMode && typeof this.viewModeBtns[this.viewMode] !== 'undefined') {\n                this.viewModeBtns[this.viewMode].removeClass('active');\n            }\n\n            this.viewMode = viewMode;\n            this.setSelecetedSourceState('mode', this.viewMode);\n\n            if (typeof this.viewModeBtns[this.viewMode] !== 'undefined') {\n                this.viewModeBtns[this.viewMode].addClass('active');\n            }\n        },\n\n        createView: function(mode, settings) {\n            var viewClass = this.getViewClass(mode);\n            return new viewClass(this, this.$elements, settings);\n        },\n\n        getViewClass: function(mode) {\n            switch (mode) {\n                case 'table':\n                    return Craft.TableElementIndexView;\n                case 'thumbs':\n                    return Craft.ThumbsElementIndexView;\n                default:\n                    throw 'View mode\u00a0\"' + mode + '\" not supported.';\n            }\n        },\n\n        rememberDisabledElementId: function(id) {\n            var index = $.inArray(id, this.settings.disabledElementIds);\n\n            if (index === -1) {\n                this.settings.disabledElementIds.push(id);\n            }\n        },\n\n        forgetDisabledElementId: function(id) {\n            var index = $.inArray(id, this.settings.disabledElementIds);\n\n            if (index !== -1) {\n                this.settings.disabledElementIds.splice(index, 1);\n            }\n        },\n\n        enableElements: function($elements) {\n            $elements.removeClass('disabled').parents('.disabled').removeClass('disabled');\n\n            for (var i = 0; i < $elements.length; i++) {\n                var id = $($elements[i]).data('id');\n                this.forgetDisabledElementId(id);\n            }\n\n            this.onEnableElements($elements);\n        },\n\n        disableElements: function($elements) {\n            $elements.removeClass('sel').addClass('disabled');\n\n            for (var i = 0; i < $elements.length; i++) {\n                var id = $($elements[i]).data('id');\n                this.rememberDisabledElementId(id);\n            }\n\n            this.onDisableElements($elements);\n        },\n\n        getElementById: function(id) {\n            return this.view.getElementById(id);\n        },\n\n        enableElementsById: function(ids) {\n            ids = $.makeArray(ids);\n\n            for (var i = 0; i < ids.length; i++) {\n                var id = ids[i],\n                    $element = this.getElementById(id);\n\n                if ($element && $element.length) {\n                    this.enableElements($element);\n                } else {\n                    this.forgetDisabledElementId(id);\n                }\n            }\n        },\n\n        disableElementsById: function(ids) {\n            ids = $.makeArray(ids);\n\n            for (var i = 0; i < ids.length; i++) {\n                var id = ids[i],\n                    $element = this.getElementById(id);\n\n                if ($element && $element.length) {\n                    this.disableElements($element);\n                } else {\n                    this.rememberDisabledElementId(id);\n                }\n            }\n        },\n\n        selectElementAfterUpdate: function(id) {\n            if (this._autoSelectElements === null) {\n                this._autoSelectElements = [];\n            }\n\n            this._autoSelectElements.push(id);\n        },\n\n        addButton: function($button) {\n            this.getButtonContainer().append($button);\n        },\n\n        isShowingSidebar: function() {\n            if (this.showingSidebar === null) {\n                this.showingSidebar = (this.$sidebar.length && !this.$sidebar.hasClass('hidden'));\n            }\n\n            return this.showingSidebar;\n        },\n\n        getButtonContainer: function() {\n            // Is there a predesignated place where buttons should go?\n            if (this.settings.buttonContainer) {\n                return $(this.settings.buttonContainer);\n            } else {\n                var $container = $('#button-container');\n\n                if (!$container.length) {\n                    $container = $('<div id=\"button-container\"/>').appendTo(Craft.cp.$header);\n                }\n\n                return $container;\n            }\n        },\n\n        setIndexBusy: function() {\n            this.$mainSpinner.removeClass('invisible');\n            this.isIndexBusy = true;\n        },\n\n        setIndexAvailable: function() {\n            this.$mainSpinner.addClass('invisible');\n            this.isIndexBusy = false;\n        },\n\n        createCustomizeSourcesModal: function() {\n            // Recreate it each time\n            var modal = new Craft.CustomizeSourcesModal(this, {\n                onHide: function() {\n                    modal.destroy();\n                }\n            });\n\n            return modal;\n        },\n\n        disable: function() {\n            if (this.sourceSelect) {\n                this.sourceSelect.disable();\n            }\n\n            if (this.view) {\n                this.view.disable();\n            }\n\n            this.base();\n        },\n\n        enable: function() {\n            if (this.sourceSelect) {\n                this.sourceSelect.enable();\n            }\n\n            if (this.view) {\n                this.view.enable();\n            }\n\n            this.base();\n        },\n\n        // Events\n        // =========================================================================\n\n        onAfterInit: function() {\n            this.settings.onAfterInit();\n            this.trigger('afterInit');\n        },\n\n        onSelectSource: function() {\n            this.settings.onSelectSource(this.sourceKey);\n            this.trigger('selectSource', {sourceKey: this.sourceKey});\n        },\n\n        onSelectSite: function() {\n            this.settings.onSelectSite(this.siteId);\n            this.trigger('selectSite', {siteId: this.siteId});\n        },\n\n        onUpdateElements: function() {\n            this.settings.onUpdateElements();\n            this.trigger('updateElements');\n        },\n\n        onSelectionChange: function() {\n            this.settings.onSelectionChange();\n            this.trigger('selectionChange');\n        },\n\n        onEnableElements: function($elements) {\n            this.settings.onEnableElements($elements);\n            this.trigger('enableElements', {elements: $elements});\n        },\n\n        onDisableElements: function($elements) {\n            this.settings.onDisableElements($elements);\n            this.trigger('disableElements', {elements: $elements});\n        },\n\n        onAfterAction: function(action, params) {\n            this.settings.onAfterAction(action, params);\n            this.trigger('afterAction', {action: action, params: params});\n        },\n\n        // Private methods\n        // =========================================================================\n\n        // UI state handlers\n        // -------------------------------------------------------------------------\n\n        _handleSourceSelectionChange: function() {\n            // If the selected source was just removed (maybe because its parent was collapsed),\n            // there won't be a selected source\n            if (!this.sourceSelect.totalSelected) {\n                this.sourceSelect.selectItem(this.$visibleSources.first());\n                return;\n            }\n\n            if (this.selectSource(this.sourceSelect.$selectedItems)) {\n                this.updateElements();\n            }\n        },\n\n        _handleActionTriggerSubmit: function(ev) {\n            ev.preventDefault();\n\n            var $form = $(ev.currentTarget);\n\n            // Make sure Craft.ElementActionTrigger isn't overriding this\n            if ($form.hasClass('disabled') || $form.data('custom-handler')) {\n                return;\n            }\n\n            var actionClass = $form.data('action'),\n                params = Garnish.getPostData($form);\n\n            this.submitAction(actionClass, params);\n        },\n\n        _handleMenuActionTriggerSubmit: function(ev) {\n            var $option = $(ev.option);\n\n            // Make sure Craft.ElementActionTrigger isn't overriding this\n            if ($option.hasClass('disabled') || $option.data('custom-handler')) {\n                return;\n            }\n\n            var actionClass = $option.data('action');\n            this.submitAction(actionClass);\n        },\n\n        _handleStatusChange: function(ev) {\n            this.statusMenu.$options.removeClass('sel');\n            var $option = $(ev.selectedOption).addClass('sel');\n            this.$statusMenuBtn.html($option.html());\n\n            this.trashed = false;\n            this.drafts = false;\n            this.status = null;\n\n            if (Garnish.hasAttr($option, 'data-trashed')) {\n                this.trashed = true;\n            } else if (Garnish.hasAttr($option, 'data-drafts')) {\n                this.drafts = true;\n            } else {\n                this.status = $option.data('status');\n            }\n\n            this._updateStructureSortOption();\n            this.updateElements();\n        },\n\n        _handleSiteChange: function(ev) {\n            this.siteMenu.$options.removeClass('sel');\n            var $option = $(ev.selectedOption).addClass('sel');\n            this.$siteMenuBtn.html($option.html());\n            this._setSite($option.data('site-id'));\n            this.onSelectSite();\n        },\n\n        _setSite: function(siteId) {\n            this.siteId = siteId;\n            this.$visibleSources = $();\n\n            // Hide any sources that aren't available for this site\n            var $firstVisibleSource;\n            var $source;\n            var selectNewSource = false;\n\n            for (var i = 0; i < this.$sources.length; i++) {\n                $source = this.$sources.eq(i);\n                if (typeof $source.data('sites') === 'undefined' || $source.data('sites').toString().split(',').indexOf(siteId.toString()) !== -1) {\n                    $source.parent().removeClass('hidden');\n                    this.$visibleSources = this.$visibleSources.add($source);\n                    if (!$firstVisibleSource) {\n                        $firstVisibleSource = $source;\n                    }\n                } else {\n                    $source.parent().addClass('hidden');\n\n                    // Is this the currently selected source?\n                    if (this.$source && this.$source.get(0) == $source.get(0)) {\n                        selectNewSource = true;\n                    }\n                }\n            }\n\n            if (selectNewSource) {\n                this.selectSource($firstVisibleSource);\n            }\n\n            // Hide any empty-nester headings\n            var $headings = this.getSourceContainer().children('.heading');\n            var $heading;\n\n            for (i = 0; i < $headings.length; i++) {\n                $heading = $headings.eq(i);\n                if ($heading.nextUntil('.heading', ':not(.hidden)').length !== 0) {\n                    $heading.removeClass('hidden');\n                } else {\n                    $heading.addClass('hidden');\n                }\n            }\n\n            if (this.initialized) {\n                // Remember this site for later\n                Craft.setLocalStorage('BaseElementIndex.siteId', siteId);\n\n                // Update the elements\n                this.updateElements();\n            }\n        },\n\n        _handleSortChange: function(ev) {\n            var $option = $(ev.selectedOption);\n\n            if ($option.hasClass('disabled') || $option.hasClass('sel')) {\n                return;\n            }\n\n            // Is this an attribute or a direction?\n            if ($option.parent().parent().is(this.$sortAttributesList)) {\n                this.setSortAttribute($option.data('attr'));\n            } else {\n                this.setSortDirection($option.data('dir'));\n            }\n\n            this.storeSortAttributeAndDirection();\n            this.updateElements();\n        },\n\n        _handleSelectionChange: function() {\n            this.updateActionTriggers();\n            this.onSelectionChange();\n        },\n\n        _handleSourceDblClick: function(ev) {\n            this._toggleSource($(ev.currentTarget));\n            ev.stopPropagation();\n        },\n\n        _handleSourceToggleClick: function(ev) {\n            this._toggleSource($(ev.currentTarget).prev('a'));\n            ev.stopPropagation();\n        },\n\n        _updateStructureSortOption: function() {\n            var $option = this.getSortAttributeOption('structure');\n\n            if (!$option.length) {\n                return;\n            }\n\n            if (this.trashed || this.drafts || this.searching) {\n                $option.addClass('disabled');\n                if (this.getSelectedSortAttribute() === 'structure') {\n                    // Temporarily set the sort to the first option\n                    var $firstOption = this.$sortAttributesList.find('a:not(.disabled):first')\n                    this.setSortAttribute($firstOption.data('attr'));\n                    this.setSortDirection('asc');\n                }\n            } else {\n                $option.removeClass('disabled');\n                this.setStoredSortOptionsForSource();\n            }\n        },\n\n        // Source managemnet\n        // -------------------------------------------------------------------------\n\n        _getSourcesInList: function($list) {\n            return $list.children('li').children('a');\n        },\n\n        _getChildSources: function($source) {\n            var $list = $source.siblings('ul');\n            return this._getSourcesInList($list);\n        },\n\n        _getSourceToggle: function($source) {\n            return $source.siblings('.toggle');\n        },\n\n        _initSources: function($sources) {\n            for (var i = 0; i < $sources.length; i++) {\n                this.initSource($($sources[i]));\n            }\n        },\n\n        _deinitSources: function($sources) {\n            for (var i = 0; i < $sources.length; i++) {\n                this.deinitSource($($sources[i]));\n            }\n        },\n\n        _toggleSource: function($source) {\n            if ($source.parent('li').hasClass('expanded')) {\n                this._collapseSource($source);\n            } else {\n                this._expandSource($source);\n            }\n        },\n\n        _expandSource: function($source) {\n            $source.parent('li').addClass('expanded');\n\n            var $childSources = this._getChildSources($source);\n            this._initSources($childSources);\n\n            var key = $source.data('key');\n            if (this.instanceState.expandedSources.indexOf(key) === -1) {\n                this.instanceState.expandedSources.push(key);\n                this.storeInstanceState();\n            }\n        },\n\n        _collapseSource: function($source) {\n            $source.parent('li').removeClass('expanded');\n\n            var $childSources = this._getChildSources($source);\n            this._deinitSources($childSources);\n\n            var i = this.instanceState.expandedSources.indexOf($source.data('key'));\n            if (i !== -1) {\n                this.instanceState.expandedSources.splice(i, 1);\n                this.storeInstanceState();\n            }\n        },\n\n        // View\n        // -------------------------------------------------------------------------\n\n        _isViewPaginated: function() {\n            return this.settings.context === 'index' && this.getSelectedSortAttribute() !== 'structure';\n        },\n\n        _updateView: function(params, response) {\n            // Cleanup\n            // -------------------------------------------------------------\n\n            // Get rid of the old action triggers regardless of whether the new batch has actions or not\n            if (this.actions) {\n                this.hideActionTriggers();\n                this.actions = this.actionsHeadHtml = this.actionsFootHtml = this._$triggers = null;\n            }\n\n            if (this.$selectAllContainer) {\n                // Git rid of the old select all button\n                this.$selectAllContainer.detach();\n            }\n\n            // Update the count text\n            // -------------------------------------------------------------\n\n            this.$countContainer.html('');\n\n            if (!this._isViewPaginated() || response.count <= this.settings.batchSize) {\n                this.$countContainer.text(response.countLabel);\n            } else {\n                var $paginationContainer = $('<div class=\"flex pagination\"/>').appendTo(this.$countContainer);\n                var totalPages = Math.max(Math.ceil(response.count / this.settings.batchSize), 1);\n\n                var $prevBtn = $('<div/>', {\n                    'class': 'page-link' + (this.page > 1 ? '' : ' disabled'),\n                    'data-icon': 'leftangle',\n                    title: Craft.t('app', 'Previous Page')\n                }).appendTo($paginationContainer);\n                var $nextBtn = $('<div/>', {\n                    'class': 'page-link' + (this.page < totalPages ? '' : ' disabled'),\n                    'data-icon': 'rightangle',\n                    title: Craft.t('app', 'Next Page')\n                }).appendTo($paginationContainer);\n\n                $('<div/>', {\n                    'class': 'page-info',\n                    text: response.countLabel\n                }).appendTo($paginationContainer);\n\n                if (this.page > 1) {\n                    this.addListener($prevBtn, 'click', function() {\n                        this.removeListener($prevBtn, 'click');\n                        this.removeListener($nextBtn, 'click');\n                        this.setPage(this.page - 1);\n                        this.updateElements(true);\n                    });\n                }\n\n                if (this.page < totalPages) {\n                    this.addListener($nextBtn, 'click', function() {\n                        this.removeListener($prevBtn, 'click');\n                        this.removeListener($nextBtn, 'click');\n                        this.setPage(this.page + 1);\n                        this.updateElements(true);\n                    });\n                }\n            }\n\n            // Batch actions setup\n            // -------------------------------------------------------------\n\n            if (response.actions && response.actions.length) {\n                this.actions = response.actions;\n                this.actionsHeadHtml = response.actionsHeadHtml;\n                this.actionsFootHtml = response.actionsFootHtml;\n\n                // First time?\n                if (!this.$selectAllContainer) {\n                    // Create the select all button\n                    this.$selectAllContainer = $('<div class=\"selectallcontainer\"/>');\n                    this.$selectAllBtn = $('<div class=\"btn\"/>').appendTo(this.$selectAllContainer);\n                    this.$selectAllCheckbox = $('<div class=\"checkbox\"/>').appendTo(this.$selectAllBtn);\n\n                    this.$selectAllBtn.attr({\n                        'role': 'checkbox',\n                        'tabindex': '0',\n                        'aria-checked': 'false'\n                    });\n\n                    this.addListener(this.$selectAllBtn, 'click', function() {\n                        if (this.view.getSelectedElements().length === 0) {\n                            this.view.selectAllElements();\n                        } else {\n                            this.view.deselectAllElements();\n                        }\n                    });\n\n                    this.addListener(this.$selectAllBtn, 'keydown', function(ev) {\n                        if (ev.keyCode === Garnish.SPACE_KEY) {\n                            ev.preventDefault();\n\n                            $(ev.currentTarget).trigger('click');\n                        }\n                    });\n                } else {\n                    // Reset the select all button\n                    this.$selectAllCheckbox.removeClass('indeterminate checked');\n\n                    this.$selectAllBtn.attr('aria-checked', 'false');\n                }\n\n                // Place the select all button at the beginning of the toolbar\n                this.$selectAllContainer.prependTo(this.$toolbarFlexContainer);\n            }\n\n            // Update the view with the new container + elements HTML\n            // -------------------------------------------------------------\n\n            this.$elements.html(response.html);\n            Craft.appendHeadHtml(response.headHtml);\n            Craft.appendFootHtml(response.footHtml);\n\n            // Create the view\n            // -------------------------------------------------------------\n\n            // Should we make the view selectable?\n            var selectable = (this.actions || this.settings.selectable);\n\n            this.view = this.createView(this.getSelectedViewMode(), {\n                context: this.settings.context,\n                batchSize: this.settings.context !== 'index' || this.getSelectedSortAttribute() === 'structure' ? this.settings.batchSize : null,\n                params: params,\n                selectable: selectable,\n                multiSelect: (this.actions || this.settings.multiSelect),\n                checkboxMode: !!this.actions,\n                onSelectionChange: $.proxy(this, '_handleSelectionChange')\n            });\n\n            // Auto-select elements\n            // -------------------------------------------------------------\n\n            if (this._autoSelectElements) {\n                if (selectable) {\n                    for (var i = 0; i < this._autoSelectElements.length; i++) {\n                        this.view.selectElementById(this._autoSelectElements[i]);\n                    }\n                }\n\n                this._autoSelectElements = null;\n            }\n\n            // Trigger the event\n            // -------------------------------------------------------------\n\n            this.onUpdateElements();\n        },\n\n        _createTriggers: function() {\n            var triggers = [],\n                safeMenuActions = [],\n                destructiveMenuActions = [];\n\n            var i;\n\n            for (i = 0; i < this.actions.length; i++) {\n                var action = this.actions[i];\n\n                if (action.trigger) {\n                    var $form = $('<form id=\"' + Craft.formatInputId(action.type) + '-actiontrigger\"/>')\n                        .data('action', action.type)\n                        .append(action.trigger);\n\n                    this.addListener($form, 'submit', '_handleActionTriggerSubmit');\n                    triggers.push($form);\n                } else {\n                    if (!action.destructive) {\n                        safeMenuActions.push(action);\n                    } else {\n                        destructiveMenuActions.push(action);\n                    }\n                }\n            }\n\n            var $btn;\n\n            if (safeMenuActions.length || destructiveMenuActions.length) {\n                var $menuTrigger = $('<form/>');\n\n                $btn = $('<div class=\"btn menubtn\" data-icon=\"settings\" title=\"' + Craft.t('app', 'Actions') + '\"/>').appendTo($menuTrigger);\n\n                var $menu = $('<ul class=\"menu\"/>').appendTo($menuTrigger),\n                    $safeList = this._createMenuTriggerList(safeMenuActions, false),\n                    $destructiveList = this._createMenuTriggerList(destructiveMenuActions, true);\n\n                if ($safeList) {\n                    $safeList.appendTo($menu);\n                }\n\n                if ($safeList && $destructiveList) {\n                    $('<hr/>').appendTo($menu);\n                }\n\n                if ($destructiveList) {\n                    $destructiveList.appendTo($menu);\n                }\n\n                triggers.push($menuTrigger);\n            }\n\n            this._$triggers = $();\n\n            for (i = 0; i < triggers.length; i++) {\n                var $div = $('<div/>').append(triggers[i]);\n                this._$triggers = this._$triggers.add($div);\n            }\n\n            this._$triggers.insertAfter(this.$selectAllContainer);\n            Craft.appendHeadHtml(this.actionsHeadHtml);\n            Craft.appendFootHtml(this.actionsFootHtml);\n\n            Craft.initUiElements(this._$triggers);\n\n            if ($btn) {\n                $btn.data('menubtn').on('optionSelect', $.proxy(this, '_handleMenuActionTriggerSubmit'));\n            }\n        },\n\n        _showExportHud: function() {\n            this.$exportBtn.addClass('active');\n\n            var $form = $('<form/>', {\n                'class': 'export-form'\n            });\n\n            var $limitField = Craft.ui.createTextField({\n                label: Craft.t('app', 'Limit'),\n                placeholder: Craft.t('app', 'No limit'),\n                type: 'number',\n                min: 1\n            }).appendTo($form);\n\n            $('<input/>', {\n                type: 'submit',\n                'class': 'btn submit fullwidth',\n                value: Craft.t('app', 'Export')\n            }).appendTo($form)\n\n            var $spinner = $('<div/>', {\n                'class': 'spinner hidden'\n            }).appendTo($form);\n\n            var hud = new Garnish.HUD(this.$exportBtn, $form);\n\n            hud.on('hide', $.proxy(function() {\n                this.$exportBtn.removeClass('active');\n            }, this));\n\n            var submitting = false;\n\n            this.addListener($form, 'submit', function(ev) {\n                ev.preventDefault();\n                if (submitting) {\n                    return;\n                }\n\n                submitting = true;\n                $spinner.removeClass('hidden');\n\n                var params = this.getViewParams();\n                delete params.criteria.limit;\n\n                var limit = parseInt($limitField.find('input').val());\n                if (limit && !isNaN(limit)) {\n                    params.criteria.limit = limit;\n                }\n\n                Craft.postActionRequest('element-indexes/create-export-token', params, $.proxy(function(response, textStatus) {\n                    submitting = false;\n                    $spinner.addClass('hidden');\n\n                    if (textStatus === 'success') {\n                        var params = {};\n                        params[Craft.tokenParam] = response.token;\n                        var url = Craft.getCpUrl('', params);\n                        document.location.href = url;\n                    } else {\n                        Craft.cp.displayError(Craft.t('app', 'An unknown error occurred.'));\n                    }\n\n                }, this));\n            });\n        },\n\n        _createMenuTriggerList: function(actions, destructive) {\n            if (actions && actions.length) {\n                var $ul = $('<ul/>');\n\n                for (var i = 0; i < actions.length; i++) {\n                    var actionClass = actions[i].type;\n                    $('<li/>').append($('<a/>', {\n                        id: Craft.formatInputId(actionClass) + '-actiontrigger',\n                        'class': (destructive ? 'error' : null),\n                        'data-action': actionClass,\n                        text: actions[i].name\n                    })).appendTo($ul);\n                }\n\n                return $ul;\n            }\n        }\n    },\n\n// Static Properties\n// =============================================================================\n\n    {\n        defaults: {\n            context: 'index',\n            modal: null,\n            storageKey: null,\n            criteria: null,\n            batchSize: 50,\n            disabledElementIds: [],\n            selectable: false,\n            multiSelect: false,\n            buttonContainer: null,\n            hideSidebar: false,\n            refreshSourcesAction: 'element-indexes/get-source-tree-html',\n            updateElementsAction: 'element-indexes/get-elements',\n            submitActionsAction: 'element-indexes/perform-action',\n            toolbarFixed: null,\n\n            onAfterInit: $.noop,\n            onSelectSource: $.noop,\n            onSelectSite: $.noop,\n            onUpdateElements: $.noop,\n            onSelectionChange: $.noop,\n            onEnableElements: $.noop,\n            onDisableElements: $.noop,\n            onAfterAction: $.noop\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Base Element Index View\n */\nCraft.BaseElementIndexView = Garnish.Base.extend(\n    {\n        $container: null,\n        $loadingMoreSpinner: null,\n        $elementContainer: null,\n        $scroller: null,\n\n        elementIndex: null,\n        thumbLoader: null,\n        elementSelect: null,\n\n        loadingMore: false,\n\n        _totalVisible: null,\n        _morePending: null,\n        _handleEnableElements: null,\n        _handleDisableElements: null,\n\n        init: function(elementIndex, container, settings) {\n            this.elementIndex = elementIndex;\n            this.$container = $(container);\n            this.setSettings(settings, Craft.BaseElementIndexView.defaults);\n\n            // Create a \"loading-more\" spinner\n            this.$loadingMoreSpinner = $(\n                '<div class=\"centeralign hidden\">' +\n                '<div class=\"spinner loadingmore\"></div>' +\n                '</div>'\n            ).insertAfter(this.$container);\n\n            // Get the actual elements container and its child elements\n            this.$elementContainer = this.getElementContainer();\n            var $elements = this.$elementContainer.children();\n\n            this.setTotalVisible($elements.length);\n            this.setMorePending(this.settings.batchSize && $elements.length == this.settings.batchSize);\n\n            // Instantiate the thumb loader\n            this.thumbLoader = new Craft.ElementThumbLoader();\n            this.thumbLoader.load($elements);\n\n            if (this.settings.selectable) {\n                this.elementSelect = new Garnish.Select(\n                    this.$elementContainer,\n                    $elements.filter(':not(.disabled)'),\n                    {\n                        multi: this.settings.multiSelect,\n                        vertical: this.isVerticalList(),\n                        handle: (this.settings.context === 'index' ? '.checkbox, .element:first' : null),\n                        filter: ':not(a):not(.toggle)',\n                        checkboxMode: this.settings.checkboxMode,\n                        onSelectionChange: $.proxy(this, 'onSelectionChange')\n                    }\n                );\n\n                this._handleEnableElements = $.proxy(function(ev) {\n                    this.elementSelect.addItems(ev.elements);\n                }, this);\n\n                this._handleDisableElements = $.proxy(function(ev) {\n                    this.elementSelect.removeItems(ev.elements);\n                }, this);\n\n                this.elementIndex.on('enableElements', this._handleEnableElements);\n                this.elementIndex.on('disableElements', this._handleDisableElements);\n            }\n\n            // Enable inline element editing if this is an index page\n            if (this.settings.context === 'index') {\n                this._handleElementEditing = $.proxy(function(ev) {\n                    var $target = $(ev.target);\n\n                    if ($target.prop('nodeName') === 'A') {\n                        // Let the link do its thing\n                        return;\n                    }\n\n                    var $element;\n\n                    if ($target.hasClass('element')) {\n                        $element = $target;\n                    }\n                    else {\n                        $element = $target.closest('.element');\n\n                        if (!$element.length) {\n                            return;\n                        }\n                    }\n\n                    if (Garnish.hasAttr($element, 'data-editable')) {\n                        this.createElementEditor($element);\n                    }\n                }, this);\n\n                if (!this.elementIndex.trashed) {\n                    this.addListener(this.$elementContainer, 'dblclick', this._handleElementEditing);\n                    if ($.isTouchCapable()) {\n                        this.addListener(this.$elementContainer, 'taphold', this._handleElementEditing);\n                    }\n                }\n            }\n\n            // Give sub-classes a chance to do post-initialization stuff here\n            this.afterInit();\n\n            // Set up lazy-loading\n            if (this.settings.batchSize) {\n                if (this.settings.context === 'index') {\n                    this.$scroller = Garnish.$scrollContainer;\n                }\n                else {\n                    this.$scroller = this.elementIndex.$main;\n                }\n\n                this.$scroller.scrollTop(0);\n                this.addListener(this.$scroller, 'scroll', 'maybeLoadMore');\n                this.maybeLoadMore();\n            }\n        },\n\n        getElementContainer: function() {\n            throw 'Classes that extend Craft.BaseElementIndexView must supply a getElementContainer() method.';\n        },\n\n        afterInit: function() {\n        },\n\n        getAllElements: function() {\n            return this.$elementContainer.children();\n        },\n\n        getEnabledElements: function() {\n            return this.$elementContainer.children(':not(.disabled)');\n        },\n\n        getElementById: function(id) {\n            var $element = this.$elementContainer.children('[data-id=\"' + id + '\"]:first');\n\n            if ($element.length) {\n                return $element;\n            }\n            else {\n                return null;\n            }\n        },\n\n        getSelectedElements: function() {\n            if (!this.elementSelect) {\n                throw 'This view is not selectable.';\n            }\n\n            return this.elementSelect.$selectedItems;\n        },\n\n        getSelectedElementIds: function() {\n            var $selectedElements = this.getSelectedElements(),\n                ids = [];\n\n            if ($selectedElements) {\n                for (var i = 0; i < $selectedElements.length; i++) {\n                    ids.push($selectedElements.eq(i).data('id'));\n                }\n            }\n\n            return ids;\n        },\n\n        selectElement: function($element) {\n            if (!this.elementSelect) {\n                throw 'This view is not selectable.';\n            }\n\n            this.elementSelect.selectItem($element, true);\n            return true;\n        },\n\n        selectElementById: function(id) {\n            if (!this.elementSelect) {\n                throw 'This view is not selectable.';\n            }\n\n            var $element = this.getElementById(id);\n\n            if ($element) {\n                this.elementSelect.selectItem($element, true);\n                return true;\n            }\n            else {\n                return false;\n            }\n        },\n\n        selectAllElements: function() {\n            this.elementSelect.selectAll();\n        },\n\n        deselectAllElements: function() {\n            this.elementSelect.deselectAll();\n        },\n\n        isVerticalList: function() {\n            return false;\n        },\n\n        getTotalVisible: function() {\n            return this._totalVisible;\n        },\n\n        setTotalVisible: function(totalVisible) {\n            this._totalVisible = totalVisible;\n        },\n\n        getMorePending: function() {\n            return this._morePending;\n        },\n\n        setMorePending: function(morePending) {\n            this._morePending = morePending;\n        },\n\n        /**\n         * Checks if the user has reached the bottom of the scroll area, and if so, loads the next batch of elemets.\n         */\n        maybeLoadMore: function() {\n            if (this.canLoadMore()) {\n                this.loadMore();\n            }\n        },\n\n        /**\n         * Returns whether the user has reached the bottom of the scroll area.\n         */\n        canLoadMore: function() {\n            if (!this.getMorePending() || !this.settings.batchSize) {\n                return false;\n            }\n\n            // Check if the user has reached the bottom of the scroll area\n            var containerHeight;\n\n            if (this.$scroller[0] === Garnish.$win[0]) {\n                var winHeight = Garnish.$win.innerHeight(),\n                    winScrollTop = Garnish.$win.scrollTop(),\n                    containerOffset = this.$container.offset().top;\n                containerHeight = this.$container.height();\n\n                return (winHeight + winScrollTop >= containerOffset + containerHeight);\n            }\n            else {\n                var containerScrollHeight = this.$scroller.prop('scrollHeight'),\n                    containerScrollTop = this.$scroller.scrollTop();\n                containerHeight = this.$scroller.outerHeight();\n\n                return (containerScrollHeight - containerScrollTop <= containerHeight + 15);\n            }\n        },\n\n        /**\n         * Loads the next batch of elements.\n         */\n        loadMore: function() {\n            if (!this.getMorePending() || this.loadingMore || !this.settings.batchSize) {\n                return;\n            }\n\n            this.loadingMore = true;\n            this.$loadingMoreSpinner.removeClass('hidden');\n            this.removeListener(this.$scroller, 'scroll');\n\n            var data = this.getLoadMoreParams();\n\n            Craft.postActionRequest(this.settings.loadMoreElementsAction, data, $.proxy(function(response, textStatus) {\n                this.loadingMore = false;\n                this.$loadingMoreSpinner.addClass('hidden');\n\n                if (textStatus === 'success') {\n                    var $newElements = $(response.html);\n\n                    this.appendElements($newElements);\n                    Craft.appendHeadHtml(response.headHtml);\n                    Craft.appendFootHtml(response.footHtml);\n\n                    if (this.elementSelect) {\n                        this.elementSelect.addItems($newElements.filter(':not(.disabled)'));\n                        this.elementIndex.updateActionTriggers();\n                    }\n\n                    this.setTotalVisible(this.getTotalVisible() + $newElements.length);\n                    this.setMorePending($newElements.length == this.settings.batchSize);\n\n                    // Is there room to load more right now?\n                    this.addListener(this.$scroller, 'scroll', 'maybeLoadMore');\n                    this.maybeLoadMore();\n                }\n\n            }, this));\n        },\n\n        getLoadMoreParams: function() {\n            // Use the same params that were passed when initializing this view\n            var params = $.extend(true, {}, this.settings.params);\n            params.criteria.offset = this.getTotalVisible();\n            return params;\n        },\n\n        appendElements: function($newElements) {\n            $newElements.appendTo(this.$elementContainer);\n            this.thumbLoader.load($newElements);\n            this.onAppendElements($newElements);\n        },\n\n        onAppendElements: function($newElements) {\n            this.settings.onAppendElements($newElements);\n            this.trigger('appendElements', {\n                newElements: $newElements\n            });\n        },\n\n        onSelectionChange: function() {\n            this.settings.onSelectionChange();\n            this.trigger('selectionChange');\n        },\n\n        createElementEditor: function($element) {\n            Craft.createElementEditor($element.data('type'), $element, {\n                elementIndex: this.elementIndex\n            });\n        },\n\n        disable: function() {\n            if (this.elementSelect) {\n                this.elementSelect.disable();\n            }\n        },\n\n        enable: function() {\n            if (this.elementSelect) {\n                this.elementSelect.enable();\n            }\n        },\n\n        destroy: function() {\n            // Remove the \"loading-more\" spinner, since we added that outside of the view container\n            this.$loadingMoreSpinner.remove();\n\n            // Kill the thumb loader\n            this.thumbLoader.destroy();\n            delete this.thumbLoader;\n\n            // Delete the element select\n            if (this.elementSelect) {\n                this.elementIndex.off('enableElements', this._handleEnableElements);\n                this.elementIndex.off('disableElements', this._handleDisableElements);\n\n                this.elementSelect.destroy();\n                delete this.elementSelect;\n            }\n\n            this.base();\n        }\n    },\n    {\n        defaults: {\n            context: 'index',\n            batchSize: null,\n            params: null,\n            selectable: false,\n            multiSelect: false,\n            checkboxMode: false,\n            loadMoreElementsAction: 'element-indexes/get-more-elements',\n            onAppendElements: $.noop,\n            onSelectionChange: $.noop\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Element Select input\n */\nCraft.BaseElementSelectInput = Garnish.Base.extend(\n    {\n        thumbLoader: null,\n        elementSelect: null,\n        elementSort: null,\n        modal: null,\n        elementEditor: null,\n\n        $container: null,\n        $elementsContainer: null,\n        $elements: null,\n        $addElementBtn: null,\n\n        _initialized: false,\n\n        init: function(settings) {\n            // Normalize the settings and set them\n            // ---------------------------------------------------------------------\n\n            // Are they still passing in a bunch of arguments?\n            if (!$.isPlainObject(settings)) {\n                // Loop through all of the old arguments and apply them to the settings\n                var normalizedSettings = {},\n                    args = ['id', 'name', 'elementType', 'sources', 'criteria', 'sourceElementId', 'limit', 'modalStorageKey', 'fieldId'];\n\n                for (var i = 0; i < args.length; i++) {\n                    if (typeof arguments[i] !== 'undefined') {\n                        normalizedSettings[args[i]] = arguments[i];\n                    }\n                    else {\n                        break;\n                    }\n                }\n\n                settings = normalizedSettings;\n            }\n\n            this.setSettings(settings, Craft.BaseElementSelectInput.defaults);\n\n            // Apply the storage key prefix\n            if (this.settings.modalStorageKey) {\n                this.modalStorageKey = 'BaseElementSelectInput.' + this.settings.modalStorageKey;\n            }\n\n            // No reason for this to be sortable if we're only allowing 1 selection\n            if (this.settings.limit == 1) {\n                this.settings.sortable = false;\n            }\n\n            this.$container = this.getContainer();\n\n            // Store a reference to this class\n            this.$container.data('elementSelect', this);\n\n            this.$elementsContainer = this.getElementsContainer();\n            this.$addElementBtn = this.getAddElementsBtn();\n\n            if (this.$addElementBtn && this.settings.limit == 1) {\n                this.$addElementBtn\n                    .css('position', 'absolute')\n                    .css('top', 0)\n                    .css(Craft.left, 0);\n            }\n\n            this.thumbLoader = new Craft.ElementThumbLoader();\n\n            this.initElementSelect();\n            this.initElementSort();\n            this.resetElements();\n\n            if (this.$addElementBtn) {\n                this.addListener(this.$addElementBtn, 'activate', 'showModal');\n            }\n\n            this._initialized = true;\n        },\n\n        get totalSelected() {\n            return this.$elements.length;\n        },\n\n        getContainer: function() {\n            return $('#' + this.settings.id);\n        },\n\n        getElementsContainer: function() {\n            return this.$container.children('.elements');\n        },\n\n        getElements: function() {\n            return this.$elementsContainer.children();\n        },\n\n        getAddElementsBtn: function() {\n            return this.$container.children('.btn.add');\n        },\n\n        initElementSelect: function() {\n            if (this.settings.selectable) {\n                this.elementSelect = new Garnish.Select({\n                    multi: this.settings.sortable,\n                    filter: ':not(.delete)'\n                });\n            }\n        },\n\n        initElementSort: function() {\n            if (this.settings.sortable) {\n                this.elementSort = new Garnish.DragSort({\n                    container: this.$elementsContainer,\n                    filter: (this.settings.selectable ? $.proxy(function() {\n                            // Only return all the selected items if the target item is selected\n                            if (this.elementSort.$targetItem.hasClass('sel')) {\n                                return this.elementSelect.getSelectedItems();\n                            }\n                            else {\n                                return this.elementSort.$targetItem;\n                            }\n                        }, this) : null),\n                    ignoreHandleSelector: '.delete',\n                    axis: this.getElementSortAxis(),\n                    collapseDraggees: true,\n                    magnetStrength: 4,\n                    helperLagBase: 1.5,\n                    onSortChange: (this.settings.selectable ? $.proxy(function() {\n                            this.elementSelect.resetItemOrder();\n                        }, this) : null)\n                });\n            }\n        },\n\n        getElementSortAxis: function() {\n            return (this.settings.viewMode === 'list' ? 'y' : null);\n        },\n\n        canAddMoreElements: function() {\n            return (!this.settings.limit || this.$elements.length < this.settings.limit);\n        },\n\n        updateAddElementsBtn: function() {\n            if (this.canAddMoreElements()) {\n                this.enableAddElementsBtn();\n            }\n            else {\n                this.disableAddElementsBtn();\n            }\n        },\n\n        disableAddElementsBtn: function() {\n            if (this.$addElementBtn && !this.$addElementBtn.hasClass('disabled')) {\n                this.$addElementBtn.addClass('disabled');\n\n                if (this.settings.limit == 1) {\n                    if (this._initialized) {\n                        this.$addElementBtn.velocity('fadeOut', Craft.BaseElementSelectInput.ADD_FX_DURATION);\n                    }\n                    else {\n                        this.$addElementBtn.hide();\n                    }\n                }\n            }\n        },\n\n        enableAddElementsBtn: function() {\n            if (this.$addElementBtn && this.$addElementBtn.hasClass('disabled')) {\n                this.$addElementBtn.removeClass('disabled');\n\n                if (this.settings.limit == 1) {\n                    if (this._initialized) {\n                        this.$addElementBtn.velocity('fadeIn', Craft.BaseElementSelectInput.REMOVE_FX_DURATION);\n                    }\n                    else {\n                        this.$addElementBtn.show();\n                    }\n                }\n            }\n        },\n\n        resetElements: function() {\n            if (this.$elements !== null) {\n                this.removeElements(this.$elements);\n            } else {\n                this.$elements = $();\n            }\n\n            this.addElements(this.getElements());\n        },\n\n        addElements: function($elements) {\n            this.thumbLoader.load($elements);\n\n            if (this.settings.selectable) {\n                this.elementSelect.addItems($elements);\n            }\n\n            if (this.settings.sortable) {\n                this.elementSort.addItems($elements);\n            }\n\n            if (this.settings.editable) {\n                this._handleShowElementEditor = $.proxy(function(ev) {\n                    var $element = $(ev.currentTarget);\n                    if (Garnish.hasAttr($element, 'data-editable') && !$element.hasClass('disabled') && !$element.hasClass('loading')) {\n                        this.elementEditor = this.createElementEditor($element);\n                    }\n                }, this);\n\n                this.addListener($elements, 'dblclick', this._handleShowElementEditor);\n\n                if ($.isTouchCapable()) {\n                    this.addListener($elements, 'taphold', this._handleShowElementEditor);\n                }\n            }\n\n            $elements.find('.delete').on('click', $.proxy(function(ev) {\n                this.removeElement($(ev.currentTarget).closest('.element'));\n            }, this));\n\n            this.$elements = this.$elements.add($elements);\n            this.updateAddElementsBtn();\n        },\n\n        createElementEditor: function($element, settings) {\n            if (!settings) {\n                settings = {};\n            }\n            settings.prevalidate = this.settings.prevalidate;\n            return Craft.createElementEditor(this.settings.elementType, $element, settings);\n        },\n\n        removeElements: function($elements) {\n            if (this.settings.selectable) {\n                this.elementSelect.removeItems($elements);\n            }\n\n            if (this.modal) {\n                var ids = [];\n\n                for (var i = 0; i < $elements.length; i++) {\n                    var id = $elements.eq(i).data('id');\n\n                    if (id) {\n                        ids.push(id);\n                    }\n                }\n\n                if (ids.length) {\n                    this.modal.elementIndex.enableElementsById(ids);\n                }\n            }\n\n            // Disable the hidden input in case the form is submitted before this element gets removed from the DOM\n            $elements.children('input').prop('disabled', true);\n\n            this.$elements = this.$elements.not($elements);\n            this.updateAddElementsBtn();\n\n            this.onRemoveElements();\n        },\n\n        removeElement: function($element) {\n            this.removeElements($element);\n            this.animateElementAway($element, function() {\n                $element.remove();\n            });\n        },\n\n        animateElementAway: function($element, callback) {\n            $element.css('z-index', 0);\n\n            var animateCss = {\n                opacity: -1\n            };\n            animateCss['margin-' + Craft.left] = -($element.outerWidth() + parseInt($element.css('margin-' + Craft.right)));\n\n            if (this.settings.viewMode === 'list' || this.$elements.length === 0) {\n                animateCss['margin-bottom'] = -($element.outerHeight() + parseInt($element.css('margin-bottom')));\n            }\n\n            $element.velocity(animateCss, Craft.BaseElementSelectInput.REMOVE_FX_DURATION, callback);\n        },\n\n        showModal: function() {\n            // Make sure we haven't reached the limit\n            if (!this.canAddMoreElements()) {\n                return;\n            }\n\n            if (!this.modal) {\n                this.modal = this.createModal();\n            }\n            else {\n                this.modal.show();\n            }\n        },\n\n        createModal: function() {\n            return Craft.createElementSelectorModal(this.settings.elementType, this.getModalSettings());\n        },\n\n        getModalSettings: function() {\n            return $.extend({\n                closeOtherModals: false,\n                storageKey: this.modalStorageKey,\n                sources: this.settings.sources,\n                criteria: this.settings.criteria,\n                multiSelect: (this.settings.limit != 1),\n                showSiteMenu: this.settings.showSiteMenu,\n                disabledElementIds: this.getDisabledElementIds(),\n                onSelect: $.proxy(this, 'onModalSelect')\n            }, this.settings.modalSettings);\n        },\n\n        getSelectedElementIds: function() {\n            var ids = [];\n\n            for (var i = 0; i < this.$elements.length; i++) {\n                ids.push(this.$elements.eq(i).data('id'));\n            }\n\n            return ids;\n        },\n\n        getDisabledElementIds: function() {\n            var ids = this.getSelectedElementIds();\n\n            if (this.settings.sourceElementId) {\n                ids.push(this.settings.sourceElementId);\n            }\n\n            return ids;\n        },\n\n        onModalSelect: function(elements) {\n            if (this.settings.limit) {\n                // Cut off any excess elements\n                var slotsLeft = this.settings.limit - this.$elements.length;\n\n                if (elements.length > slotsLeft) {\n                    elements = elements.slice(0, slotsLeft);\n                }\n            }\n\n            this.selectElements(elements);\n            this.updateDisabledElementsInModal();\n        },\n\n        selectElements: function(elements) {\n            for (var i = 0; i < elements.length; i++) {\n                var elementInfo = elements[i],\n                    $element = this.createNewElement(elementInfo);\n\n                this.appendElement($element);\n                this.addElements($element);\n                this.animateElementIntoPlace(elementInfo.$element, $element);\n            }\n\n            this.onSelectElements(elements);\n        },\n\n        createNewElement: function(elementInfo) {\n            var $element = elementInfo.$element.clone();\n\n            // Make a couple tweaks\n            Craft.setElementSize($element, (this.settings.viewMode === 'large' ? 'large' : 'small'));\n            $element.addClass('removable');\n            $element.prepend('<input type=\"hidden\" name=\"' + this.settings.name + '[]\" value=\"' + elementInfo.id + '\">' +\n                '<a class=\"delete icon\" title=\"' + Craft.t('app', 'Remove') + '\"></a>');\n\n            return $element;\n        },\n\n        appendElement: function($element) {\n            $element.appendTo(this.$elementsContainer);\n        },\n\n        animateElementIntoPlace: function($modalElement, $inputElement) {\n            var origOffset = $modalElement.offset(),\n                destOffset = $inputElement.offset(),\n                $helper = $inputElement.clone().appendTo(Garnish.$bod);\n\n            $inputElement.css('visibility', 'hidden');\n\n            $helper.css({\n                position: 'absolute',\n                zIndex: 10000,\n                top: origOffset.top,\n                left: origOffset.left\n            });\n\n            var animateCss = {\n                top: destOffset.top,\n                left: destOffset.left\n            };\n\n            $helper.velocity(animateCss, Craft.BaseElementSelectInput.ADD_FX_DURATION, function() {\n                $helper.remove();\n                $inputElement.css('visibility', 'visible');\n            });\n        },\n\n        updateDisabledElementsInModal: function() {\n            if (this.modal.elementIndex) {\n                this.modal.elementIndex.disableElementsById(this.getDisabledElementIds());\n            }\n        },\n\n        getElementById: function(id) {\n            for (var i = 0; i < this.$elements.length; i++) {\n                var $element = this.$elements.eq(i);\n\n                if ($element.data('id') == id) {\n                    return $element;\n                }\n            }\n        },\n\n        onSelectElements: function(elements) {\n            this.trigger('selectElements', {elements: elements});\n            this.settings.onSelectElements(elements);\n\n            if (window.draftEditor) {\n                window.draftEditor.checkForm();\n            }\n        },\n\n        onRemoveElements: function() {\n            this.trigger('removeElements');\n            this.settings.onRemoveElements();\n        }\n    },\n    {\n        ADD_FX_DURATION: 200,\n        REMOVE_FX_DURATION: 200,\n\n        defaults: {\n            id: null,\n            name: null,\n            fieldId: null,\n            elementType: null,\n            sources: null,\n            criteria: {},\n            sourceElementId: null,\n            viewMode: 'list',\n            limit: null,\n            showSiteMenu: false,\n            modalStorageKey: null,\n            modalSettings: {},\n            onSelectElements: $.noop,\n            onRemoveElements: $.noop,\n            sortable: true,\n            selectable: true,\n            editable: true,\n            prevalidate: false,\n            editorSettings: {}\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Element selector modal class\n */\nCraft.BaseElementSelectorModal = Garnish.Modal.extend(\n    {\n        elementType: null,\n        elementIndex: null,\n\n        $body: null,\n        $selectBtn: null,\n        $sidebar: null,\n        $sources: null,\n        $sourceToggles: null,\n        $main: null,\n        $search: null,\n        $elements: null,\n        $tbody: null,\n        $primaryButtons: null,\n        $secondaryButtons: null,\n        $cancelBtn: null,\n        $footerSpinner: null,\n\n        init: function(elementType, settings) {\n            this.elementType = elementType;\n            this.setSettings(settings, Craft.BaseElementSelectorModal.defaults);\n\n            // Build the modal\n            var $container = $('<div class=\"modal elementselectormodal\"></div>').appendTo(Garnish.$bod),\n                $body = $('<div class=\"body\"><div class=\"spinner big\"></div></div>').appendTo($container),\n                $footer = $('<div class=\"footer\"/>').appendTo($container);\n\n            this.base($container, this.settings);\n\n            this.$footerSpinner = $('<div class=\"spinner hidden\"/>').appendTo($footer);\n            this.$primaryButtons = $('<div class=\"buttons right\"/>').appendTo($footer);\n            this.$secondaryButtons = $('<div class=\"buttons left secondary-buttons\"/>').appendTo($footer);\n            this.$cancelBtn = $('<div class=\"btn\">' + Craft.t('app', 'Cancel') + '</div>').appendTo(this.$primaryButtons);\n            this.$selectBtn = $('<div class=\"btn disabled submit\">' + Craft.t('app', 'Select') + '</div>').appendTo(this.$primaryButtons);\n\n            this.$body = $body;\n\n            this.addListener(this.$cancelBtn, 'activate', 'cancel');\n            this.addListener(this.$selectBtn, 'activate', 'selectElements');\n        },\n\n        onFadeIn: function() {\n            if (!this.elementIndex) {\n                this._createElementIndex();\n            }\n            else {\n                // Auto-focus the Search box\n                if (!Garnish.isMobileBrowser(true)) {\n                    this.elementIndex.$search.trigger('focus');\n                }\n            }\n\n            this.base();\n        },\n\n        onSelectionChange: function() {\n            this.updateSelectBtnState();\n        },\n\n        updateSelectBtnState: function() {\n            if (this.$selectBtn) {\n                if (this.elementIndex.getSelectedElements().length) {\n                    this.enableSelectBtn();\n                }\n                else {\n                    this.disableSelectBtn();\n                }\n            }\n        },\n\n        enableSelectBtn: function() {\n            this.$selectBtn.removeClass('disabled');\n        },\n\n        disableSelectBtn: function() {\n            this.$selectBtn.addClass('disabled');\n        },\n\n        enableCancelBtn: function() {\n            this.$cancelBtn.removeClass('disabled');\n        },\n\n        disableCancelBtn: function() {\n            this.$cancelBtn.addClass('disabled');\n        },\n\n        showFooterSpinner: function() {\n            this.$footerSpinner.removeClass('hidden');\n        },\n\n        hideFooterSpinner: function() {\n            this.$footerSpinner.addClass('hidden');\n        },\n\n        cancel: function() {\n            if (!this.$cancelBtn.hasClass('disabled')) {\n                this.hide();\n            }\n        },\n\n        selectElements: function() {\n            if (this.elementIndex && this.elementIndex.getSelectedElements().length) {\n                // TODO: This code shouldn't know about views' elementSelect objects\n                this.elementIndex.view.elementSelect.clearMouseUpTimeout();\n\n                var $selectedElements = this.elementIndex.getSelectedElements(),\n                    elementInfo = this.getElementInfo($selectedElements);\n\n                this.onSelect(elementInfo);\n\n                if (this.settings.disableElementsOnSelect) {\n                    this.elementIndex.disableElements(this.elementIndex.getSelectedElements());\n                }\n\n                if (this.settings.hideOnSelect) {\n                    this.hide();\n                }\n            }\n        },\n\n        getElementInfo: function($selectedElements) {\n            var info = [];\n\n            for (var i = 0; i < $selectedElements.length; i++) {\n                var $element = $($selectedElements[i]);\n                var elementInfo = Craft.getElementInfo($element);\n\n                info.push(elementInfo);\n            }\n\n            return info;\n        },\n\n        show: function() {\n            this.updateSelectBtnState();\n            this.base();\n        },\n\n        onSelect: function(elementInfo) {\n            this.settings.onSelect(elementInfo);\n        },\n\n        disable: function() {\n            if (this.elementIndex) {\n                this.elementIndex.disable();\n            }\n\n            this.base();\n        },\n\n        enable: function() {\n            if (this.elementIndex) {\n                this.elementIndex.enable();\n            }\n\n            this.base();\n        },\n\n        _createElementIndex: function() {\n            // Get the modal body HTML based on the settings\n            var data = {\n                context: 'modal',\n                elementType: this.elementType,\n                sources: this.settings.sources\n            };\n\n            if (this.settings.showSiteMenu !== null && this.settings.showSiteMenu !== 'auto') {\n                data.showSiteMenu = this.settings.showSiteMenu ? '1' : '0';\n            }\n\n            Craft.postActionRequest('elements/get-modal-body', data, $.proxy(function(response, textStatus) {\n                if (textStatus === 'success') {\n                    this.$body.html(response.html);\n\n                    if (this.$body.has('.sidebar:not(.hidden)').length) {\n                        this.$body.addClass('has-sidebar');\n                    }\n\n                    // Initialize the element index\n                    this.elementIndex = Craft.createElementIndex(this.elementType, this.$body, {\n                        context: 'modal',\n                        modal: this,\n                        storageKey: this.settings.storageKey,\n                        criteria: this.settings.criteria,\n                        disabledElementIds: this.settings.disabledElementIds,\n                        selectable: true,\n                        multiSelect: this.settings.multiSelect,\n                        buttonContainer: this.$secondaryButtons,\n                        onSelectionChange: $.proxy(this, 'onSelectionChange'),\n                        hideSidebar: this.settings.hideSidebar\n                    });\n\n                    // Double-clicking or double-tapping should select the elements\n                    this.addListener(this.elementIndex.$elements, 'doubletap', function(ev, touchData) {\n                        // Make sure the touch targets are the same\n                        // (they may be different if Command/Ctrl/Shift-clicking on multiple elements quickly)\n                        if (touchData.firstTap.target === touchData.secondTap.target) {\n                            this.selectElements();\n                        }\n                    });\n                }\n\n            }, this));\n        }\n    },\n    {\n        defaults: {\n            resizable: true,\n            storageKey: null,\n            sources: null,\n            criteria: null,\n            multiSelect: false,\n            showSiteMenu: null,\n            disabledElementIds: [],\n            disableElementsOnSelect: false,\n            hideOnSelect: true,\n            onCancel: $.noop,\n            onSelect: $.noop,\n            hideIndexSidebar: false\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Input Generator\n */\nCraft.BaseInputGenerator = Garnish.Base.extend(\n    {\n        $source: null,\n        $target: null,\n        $form: null,\n        settings: null,\n\n        listening: null,\n        timeout: null,\n\n        init: function(source, target, settings) {\n            this.$source = $(source);\n            this.$target = $(target);\n            this.$form = this.$source.closest('form');\n\n            this.setSettings(settings);\n\n            this.startListening();\n        },\n\n        setNewSource: function(source) {\n            var listening = this.listening;\n            this.stopListening();\n\n            this.$source = $(source);\n\n            if (listening) {\n                this.startListening();\n            }\n        },\n\n        startListening: function() {\n            if (this.listening) {\n                return;\n            }\n\n            this.listening = true;\n\n            this.addListener(this.$source, 'textchange', 'onSourceTextChange');\n            this.addListener(this.$target, 'textchange', 'onTargetTextChange');\n            this.addListener(this.$form, 'submit', 'onFormSubmit');\n        },\n\n        stopListening: function() {\n            if (!this.listening) {\n                return;\n            }\n\n            this.listening = false;\n\n            if (this.timeout) {\n                clearTimeout(this.timeout);\n            }\n\n            this.removeAllListeners(this.$source);\n            this.removeAllListeners(this.$target);\n            this.removeAllListeners(this.$form);\n        },\n\n        onSourceTextChange: function() {\n            if (this.timeout) {\n                clearTimeout(this.timeout);\n            }\n\n            this.timeout = setTimeout($.proxy(this, 'updateTarget'), 250);\n        },\n\n        onTargetTextChange: function() {\n            if (this.$target.get(0) === document.activeElement) {\n                this.stopListening();\n            }\n        },\n\n        onFormSubmit: function() {\n            if (this.timeout) {\n                clearTimeout(this.timeout);\n            }\n\n            this.updateTarget();\n        },\n\n        updateTarget: function() {\n            var sourceVal = this.$source.val();\n\n            if (typeof sourceVal === 'undefined') {\n                // The source input may not exist anymore\n                return;\n            }\n\n            var targetVal = this.generateTargetValue(sourceVal);\n\n            this.$target.val(targetVal);\n            this.$target.trigger('change');\n\n            // If the target already has focus, select its whole value to mimic\n            // the behavior if the value had already been generated and they just tabbed in\n            if (this.$target.is(':focus')) {\n                Craft.selectFullValue(this.$target);\n            }\n        },\n\n        generateTargetValue: function(sourceVal) {\n            return sourceVal;\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Admin table class\n */\nCraft.AdminTable = Garnish.Base.extend(\n    {\n        settings: null,\n        totalItems: null,\n        sorter: null,\n\n        $noItems: null,\n        $table: null,\n        $tbody: null,\n        $deleteBtns: null,\n\n        init: function(settings) {\n            this.setSettings(settings, Craft.AdminTable.defaults);\n\n            if (!this.settings.allowDeleteAll) {\n                this.settings.minItems = 1;\n            }\n\n            this.$noItems = $(this.settings.noItemsSelector);\n            this.$table = $(this.settings.tableSelector);\n            this.$tbody = this.$table.children('tbody');\n            this.totalItems = this.$tbody.children().length;\n\n            if (this.settings.sortable) {\n                this.sorter = new Craft.DataTableSorter(this.$table, {\n                    onSortChange: $.proxy(this, 'reorderItems')\n                });\n            }\n\n            this.$deleteBtns = this.$table.find('.delete:not(.disabled)');\n            this.addListener(this.$deleteBtns, 'click', 'handleDeleteBtnClick');\n\n            this.updateUI();\n        },\n\n        addRow: function(row) {\n            if (this.settings.maxItems && this.totalItems >= this.settings.maxItems) {\n                // Sorry pal.\n                return;\n            }\n\n            var $row = $(row).appendTo(this.$tbody),\n                $deleteBtn = $row.find('.delete');\n\n            if (this.settings.sortable) {\n                this.sorter.addItems($row);\n            }\n\n            this.$deleteBtns = this.$deleteBtns.add($deleteBtn);\n\n            this.addListener($deleteBtn, 'click', 'handleDeleteBtnClick');\n            this.totalItems++;\n\n            this.updateUI();\n        },\n\n        reorderItems: function() {\n            if (!this.settings.sortable) {\n                return;\n            }\n\n            // Get the new field order\n            var ids = [];\n\n            for (var i = 0; i < this.sorter.$items.length; i++) {\n                var id = $(this.sorter.$items[i]).attr(this.settings.idAttribute);\n                ids.push(id);\n            }\n\n            // Send it to the server\n            var data = {\n                ids: JSON.stringify(ids)\n            };\n\n            Craft.postActionRequest(this.settings.reorderAction, data, $.proxy(function(response, textStatus) {\n                if (textStatus === 'success') {\n                    if (response.success) {\n                        this.onReorderItems(ids);\n                        Craft.cp.displayNotice(Craft.t('app', this.settings.reorderSuccessMessage));\n                    }\n                    else {\n                        Craft.cp.displayError(Craft.t('app', this.settings.reorderFailMessage));\n                    }\n                }\n\n            }, this));\n        },\n\n        handleDeleteBtnClick: function(event) {\n            if (this.settings.minItems && this.totalItems <= this.settings.minItems) {\n                // Sorry pal.\n                return;\n            }\n\n            var $row = $(event.target).closest('tr');\n\n            if (this.confirmDeleteItem($row)) {\n                this.deleteItem($row);\n            }\n        },\n\n        confirmDeleteItem: function($row) {\n            var name = this.getItemName($row);\n            return confirm(Craft.t('app', this.settings.confirmDeleteMessage, {name: name}));\n        },\n\n        deleteItem: function($row) {\n            var data = {\n                id: this.getItemId($row)\n            };\n\n            Craft.postActionRequest(this.settings.deleteAction, data, $.proxy(function(response, textStatus) {\n                if (textStatus === 'success') {\n                    this.handleDeleteItemResponse(response, $row);\n                }\n            }, this));\n        },\n\n        handleDeleteItemResponse: function(response, $row) {\n            var id = this.getItemId($row),\n                name = this.getItemName($row);\n\n            if (response.success) {\n                if (this.sorter) {\n                    this.sorter.removeItems($row);\n                }\n\n                $row.remove();\n                this.totalItems--;\n                this.updateUI();\n                this.onDeleteItem(id);\n\n                Craft.cp.displayNotice(Craft.t('app', this.settings.deleteSuccessMessage, {name: name}));\n            }\n            else {\n                Craft.cp.displayError(Craft.t('app', this.settings.deleteFailMessage, {name: name}));\n            }\n        },\n\n        onReorderItems: function(ids) {\n            this.settings.onReorderItems(ids);\n        },\n\n        onDeleteItem: function(id) {\n            this.settings.onDeleteItem(id);\n        },\n\n        getItemId: function($row) {\n            return $row.attr(this.settings.idAttribute);\n        },\n\n        getItemName: function($row) {\n            return Craft.escapeHtml($row.attr(this.settings.nameAttribute));\n        },\n\n        updateUI: function() {\n            // Show the \"No Whatever Exists\" message if there aren't any\n            if (this.totalItems === 0) {\n                this.$table.hide();\n                this.$noItems.removeClass('hidden');\n            }\n            else {\n                this.$table.show();\n                this.$noItems.addClass('hidden');\n            }\n\n            // Disable the sort buttons if there's only one row\n            if (this.settings.sortable) {\n                var $moveButtons = this.$table.find('.move');\n\n                if (this.totalItems === 1) {\n                    $moveButtons.addClass('disabled');\n                }\n                else {\n                    $moveButtons.removeClass('disabled');\n                }\n            }\n\n            // Disable the delete buttons if we've reached the minimum items\n            if (this.settings.minItems && this.totalItems <= this.settings.minItems) {\n                this.$deleteBtns.addClass('disabled');\n            }\n            else {\n                this.$deleteBtns.removeClass('disabled');\n            }\n\n            // Hide the New Whatever button if we've reached the maximum items\n            if (this.settings.newItemBtnSelector) {\n                if (this.settings.maxItems && this.totalItems >= this.settings.maxItems) {\n                    $(this.settings.newItemBtnSelector).addClass('hidden');\n                }\n                else {\n                    $(this.settings.newItemBtnSelector).removeClass('hidden');\n                }\n            }\n        }\n    },\n    {\n        defaults: {\n            tableSelector: null,\n            noItemsSelector: null,\n            newItemBtnSelector: null,\n            idAttribute: 'data-id',\n            nameAttribute: 'data-name',\n            sortable: false,\n            allowDeleteAll: true,\n            minItems: 0,\n            maxItems: null,\n            reorderAction: null,\n            deleteAction: null,\n            reorderSuccessMessage: Craft.t('app', 'New order saved.'),\n            reorderFailMessage: Craft.t('app', 'Couldn\u2019t save new order.'),\n            confirmDeleteMessage: Craft.t('app', 'Are you sure you want to delete \u201c{name}\u201d?'),\n            deleteSuccessMessage: Craft.t('app', '\u201c{name}\u201d deleted.'),\n            deleteFailMessage: Craft.t('app', 'Couldn\u2019t delete \u201c{name}\u201d.'),\n            onReorderItems: $.noop,\n            onDeleteItem: $.noop\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Asset index class\n */\nCraft.AssetEditor = Craft.BaseElementEditor.extend(\n    {\n        reloadIndex: false,\n\n        updateForm: function(response) {\n            this.base(response);\n\n            if (this.$element.data('id')) {\n                var $imageEditorTrigger = this.$fieldsContainer.find('> .meta > .image-preview-container.editable');\n\n                if ($imageEditorTrigger.length) {\n                    this.addListener($imageEditorTrigger, 'click', 'showImageEditor');\n                }\n            }\n\n        },\n\n        showImageEditor: function()\n        {\n            new Craft.AssetImageEditor(this.$element.data('id'), {\n                onSave: function () {\n                    this.reloadIndex = true;\n                    this.reloadForm();\n                }.bind(this),\n                allowDegreeFractions: Craft.isImagick\n            });\n        },\n\n        onHideHud: function () {\n            if (this.reloadIndex && this.settings.elementIndex) {\n                this.settings.elementIndex.updateElements();\n            }\n\n            this.base();\n        }\n    });\n\n// Register it!\nCraft.registerElementEditorClass('craft\\\\elements\\\\Asset', Craft.AssetEditor);\n\n/** global: Craft */\n/** global: Garnish */\n\n/**\n * Asset image editor class\n */\n\nCraft.AssetImageEditor = Garnish.Modal.extend(\n    {\n        // jQuery objects\n        $body: null,\n        $footer: null,\n        $imageTools: null,\n        $buttons: null,\n        $cancelBtn: null,\n        $replaceBtn: null,\n        $saveBtn: null,\n        $editorContainer: null,\n        $straighten: null,\n        $croppingCanvas: null,\n        $spinnerCanvas: null,\n\n        // FabricJS objects\n        canvas: null,\n        image: null,\n        viewport: null,\n        focalPoint: null,\n        grid: null,\n        croppingCanvas: null,\n        clipper: null,\n        croppingRectangle: null,\n        cropperHandles: null,\n        cropperGrid: null,\n        croppingShade: null,\n\n        // Image state attributes\n        imageStraightenAngle: 0,\n        viewportRotation: 0,\n        originalWidth: 0,\n        originalHeight: 0,\n        imageVerticeCoords: null,\n        zoomRatio: 1,\n\n        // Editor state attributes\n        animationInProgress: false,\n        currentView: '',\n        assetId: null,\n        cacheBust: null,\n        draggingCropper: false,\n        scalingCropper: false,\n        draggingFocal: false,\n        previousMouseX: 0,\n        previousMouseY: 0,\n        shiftKeyHeld: false,\n        editorHeight: 0,\n        editorWidth: 0,\n        cropperState: false,\n        scaleFactor: 1,\n        flipData: {},\n        focalPointState: false,\n        croppingConstraint: false,\n        spinnerInterval: null,\n        maxImageSize: null,\n        lastLoadedDimensions: null,\n        imageIsLoading: false,\n\n        // Rendering proxy functions\n        renderImage: null,\n        renderCropper: null,\n\n        init: function(assetId, settings) {\n            this.cacheBust = Date.now();\n\n            this.setSettings(settings, Craft.AssetImageEditor.defaults);\n\n            this.assetId = assetId;\n            this.flipData = {x: 0, y: 0};\n\n            // Build the modal\n            this.$container = $('<form class=\"modal fitted imageeditor\"></form>').appendTo(Garnish.$bod);\n            this.$body = $('<div class=\"body\"></div>').appendTo(this.$container);\n            this.$footer = $('<div class=\"footer\"/>').appendTo(this.$container);\n\n            this.base(this.$container, this.settings);\n\n            this.$buttons = $('<div class=\"buttons right\"/>').appendTo(this.$footer);\n            this.$cancelBtn = $('<div class=\"btn cancel\">' + Craft.t('app', 'Cancel') + '</div>').appendTo(this.$buttons);\n            this.$replaceBtn = $('<div class=\"btn submit save replace\">' + Craft.t('app', 'Save') + '</div>').appendTo(this.$buttons);\n\n            if (this.settings.allowSavingAsNew) {\n                this.$saveBtn = $('<div class=\"btn submit save copy\">' + Craft.t('app', 'Save as a new asset') + '</div>').appendTo(this.$buttons);\n                this.addListener(this.$saveBtn, 'activate', this.saveImage.bind(this));\n            }\n\n            this.addListener(this.$replaceBtn, 'activate', this.saveImage.bind(this));\n            this.addListener(this.$cancelBtn, 'activate', $.proxy(this, 'hide'));\n            this.removeListener(this.$shade, 'click');\n\n            this.maxImageSize = this.getMaxImageSize();\n\n            Craft.postActionRequest('assets/image-editor', {assetId: assetId}, $.proxy(this, 'loadEditor'));\n        },\n\n        /**\n         * Get the max image size that is viewable in the editor currently\n         */\n        getMaxImageSize: function() {\n            var browserViewportWidth = Garnish.$doc.get(0).documentElement.clientWidth;\n            var browserViewportHeight = Garnish.$doc.get(0).documentElement.clientHeight;\n\n            return  Math.max(browserViewportHeight, browserViewportWidth) * (window.devicePixelRatio > 1 ? 2 : 1);\n        },\n\n        /**\n         * Load the editor markup and start loading components and the image.\n         *\n         * @param data\n         */\n        loadEditor: function(data) {\n\n            if (!data.html) {\n                alert(Craft.t('app', 'Could not load the image editor.'));\n            }\n\n            this.$body.html(data.html);\n            this.$tabs = $('.tabs li', this.$body);\n            this.$viewsContainer = $('.views', this.$body);\n            this.$views = $('> div', this.$viewsContainer);\n            this.$imageTools = $('.image-container .image-tools', this.$body);\n            this.$editorContainer = $('.image-container .image', this.$body);\n            this.editorHeight = this.$editorContainer.innerHeight();\n            this.editorWidth = this.$editorContainer.innerWidth();\n\n            this._showSpinner();\n\n            this.updateSizeAndPosition();\n\n            // Load the canvas on which we'll host our image and set up the proxy render function\n            this.canvas = new fabric.StaticCanvas('image-canvas');\n\n            // Set up the cropping canvas jquery element for tracking all the nice events\n            this.$croppingCanvas = $('#cropping-canvas', this.$editorContainer);\n            this.$croppingCanvas.width(this.editorWidth);\n            this.$croppingCanvas.height(this.editorHeight);\n\n            this.canvas.enableRetinaScaling = true;\n            this.renderImage = function() {\n                Garnish.requestAnimationFrame(this.canvas.renderAll.bind(this.canvas));\n            }.bind(this);\n\n            // Load the image from URL\n            var imageUrl = Craft.getActionUrl('assets/edit-image', {\n                assetId: this.assetId,\n                size: this.maxImageSize,\n                cacheBust: this.cacheBust\n            });\n\n            // Load image and set up the initial properties\n            fabric.Image.fromURL(imageUrl, $.proxy(function(imageObject) {\n\n                this.image = imageObject;\n                this.image.set({\n                    originX: 'center',\n                    originY: 'center',\n                    left: this.editorWidth / 2,\n                    top: this.editorHeight / 2\n                });\n                this.canvas.add(this.image);\n\n                this.originalHeight = this.image.getHeight();\n                this.originalWidth = this.image.getWidth();\n                this.zoomRatio = 1;\n\n                this.lastLoadedDimensions = this.getScaledImageDimensions();\n\n                // Set up the image bounding box, viewport and position everything\n                this._setFittedImageVerticeCoordinates();\n                this._repositionEditorElements();\n\n                // Set up the focal point\n                var focalState = {\n                    imageDimensions: this.getScaledImageDimensions(),\n                    offsetX: 0,\n                    offsetY: 0\n                };\n\n                var focal = false;\n                if (data.focalPoint) {\n                    // Transform the focal point coordinates from relative to absolute\n                    var focalData = data.focalPoint;\n\n                    // Resolve for the current image dimensions.\n                    var adjustedX = focalState.imageDimensions.width * focalData.x;\n                    var adjustedY = focalState.imageDimensions.height * focalData.y;\n\n                    focalState.offsetX = adjustedX - focalState.imageDimensions.width / 2;\n                    focalState.offsetY = adjustedY - focalState.imageDimensions.height / 2;\n\n                    focal = true;\n                }\n\n                this.storeFocalPointState(focalState);\n\n                if (focal) {\n                    this._createFocalPoint();\n                }\n\n                this._createViewport();\n                this.storeCropperState();\n\n                // Add listeners to buttons\n                this._addControlListeners();\n\n                // Add mouse event listeners\n                this.addListener(this.$croppingCanvas, 'mousemove', this._handleMouseMove.bind(this));\n                this.addListener(this.$croppingCanvas, 'mousedown', this._handleMouseDown.bind(this));\n                this.addListener(this.$croppingCanvas, 'mouseup', this._handleMouseUp.bind(this));\n                this.addListener(this.$croppingCanvas, 'mouseout', function(ev) {\n                    this._handleMouseUp(ev);\n                    this._handleMouseMove(ev);\n                }.bind(this));\n\n                this._hideSpinner();\n\n                // Render it, finally\n                this.renderImage();\n\n                // Make sure verything gets fired for the first tab\n                this.$tabs.first().trigger('click');\n            }, this));\n        },\n\n        /**\n         * Reload the image to better fit the current available image editor viewport.\n         */\n        _reloadImage: function () {\n\n            if (this.imageIsLoading) {\n                return;\n            }\n\n            this.imageIsLoading = true;\n            this.maxImageSize = this.getMaxImageSize();\n\n            // Load the image from URL\n            var imageUrl = Craft.getActionUrl('assets/edit-image', {\n                assetId: this.assetId,\n                size: this.maxImageSize,\n                cacheBust: this.cacheBust\n            });\n\n            this.image.setSrc(imageUrl, function(imageObject) {\n                this.originalHeight = imageObject.getHeight();\n                this.originalWidth = imageObject.getWidth();\n                this.lastLoadedDimensions = {width: this.originalHeight, height: this.originalWidth};\n                this.updateSizeAndPosition();\n                this.renderImage();\n                this.imageIsLoading = false;\n            }.bind(this));\n        },\n\n        /**\n         * Update the modal size and position on browser resize\n         */\n        updateSizeAndPosition: function() {\n            if (!this.$container) {\n                return;\n            }\n\n            // Fullscreen modal\n            var innerWidth = window.innerWidth;\n            var innerHeight = window.innerHeight;\n\n            this.$container.css({\n                'width': innerWidth,\n                'min-width': innerWidth,\n                'left': 0,\n\n                'height': innerHeight,\n                'min-height': innerHeight,\n                'top': 0\n            });\n\n            this.$body.css({\n                'height': innerHeight - 58\n            });\n\n            if (innerWidth < innerHeight) {\n                this.$container.addClass('vertical');\n            }\n            else {\n                this.$container.removeClass('vertical');\n            }\n\n            if (this.$spinnerCanvas) {\n                this.$spinnerCanvas.css({\n                    left: ((this.$spinnerCanvas.parent().width()/2)-(this.$spinnerCanvas.width()/2))+'px',\n                    top: ((this.$spinnerCanvas.parent().height()/2)-(this.$spinnerCanvas.height()/2))+'px'\n                });\n            }\n\n            // If image is already loaded, make sure it looks pretty.\n            if (this.$editorContainer && this.image) {\n                this._repositionEditorElements();\n            }\n        },\n\n        /**\n         * Reposition the editor elements to accurately reflect the editor state with current dimensions\n         */\n        _repositionEditorElements: function() {\n\n            // Remember what the dimensions were before the resize took place\n            var previousEditorDimensions = {\n                width: this.editorWidth,\n                height: this.editorHeight\n            };\n\n            this.editorHeight = this.$editorContainer.innerHeight();\n            this.editorWidth = this.$editorContainer.innerWidth();\n\n            this.canvas.setDimensions({\n                width: this.editorWidth,\n                height: this.editorHeight\n            });\n\n            var currentScaledDimensions = this.getScaledImageDimensions();\n\n            // If we're cropping now, we have to reposition the cropper correctly in case\n            // the area for image changes, forcing the image size to change as well.\n            if (this.currentView === 'crop') {\n                this.zoomRatio = this.getZoomToFitRatio(this.getScaledImageDimensions());\n                var previouslyOccupiedArea = this._getBoundingRectangle(this.imageVerticeCoords);\n                this._setFittedImageVerticeCoordinates();\n                this._repositionCropper(previouslyOccupiedArea);\n            } else {\n                // Otherwise just recalculate the image zoom ratio\n                this.zoomRatio = this.getZoomToCoverRatio(this.getScaledImageDimensions()) * this.scaleFactor;\n            }\n\n            // Reposition the image relatively to the previous editor dimensions.\n            this._repositionImage(previousEditorDimensions);\n            this._repositionViewport();\n            this._repositionFocalPoint(previousEditorDimensions);\n            this._zoomImage();\n\n            this.renderImage();\n\n            if (currentScaledDimensions.width / this.lastLoadedDimensions.width > 1.5 || currentScaledDimensions.height / this.lastLoadedDimensions.height > 1.5) {\n                this._reloadImage();\n            }\n        },\n\n        /**\n         * Reposition image based on how the editor dimensions have changed.\n         * This ensures keeping the image center offset, if there is any.\n         *\n         * @param previousEditorDimensions\n         */\n        _repositionImage: function(previousEditorDimensions) {\n            this.image.set({\n                left: this.image.left - (previousEditorDimensions.width - this.editorWidth) / 2,\n                top: this.image.top - (previousEditorDimensions.height - this.editorHeight) / 2\n            });\n        },\n\n        /**\n         * Create the viewport for image editor.\n         */\n        _createViewport: function() {\n            this.viewport = new fabric.Rect({\n                width: this.image.width,\n                height: this.image.height,\n                fill: 'rgba(127,0,0,1)',\n                originX: 'center',\n                originY: 'center',\n                globalCompositeOperation: 'destination-in', // This clips everything outside of the viewport\n                left: this.image.left,\n                top: this.image.top\n            });\n            this.canvas.add(this.viewport);\n            this.renderImage();\n        },\n\n        /**\n         * Create the focal point.\n         */\n        _createFocalPoint: function() {\n            var focalPointState = this.focalPointState;\n            var sizeFactor = this.getScaledImageDimensions().width / focalPointState.imageDimensions.width;\n\n            var focalX = focalPointState.offsetX * sizeFactor * this.zoomRatio * this.scaleFactor;\n            var focalY = focalPointState.offsetY * sizeFactor * this.zoomRatio * this.scaleFactor;\n\n            // Adjust by image margins\n            focalX += this.image.left;\n            focalY += this.image.top;\n\n            var deltaX = 0;\n            var deltaY = 0;\n\n            // When creating a fresh focal point, drop it dead in the center of the viewport, not the image.\n            if (this.viewport && focalPointState.offsetX === 0 && focalPointState.offsetY === 0) {\n                if (this.currentView !== 'crop') {\n                    deltaX = this.viewport.left - this.image.left;\n                    deltaY = this.viewport.top - this.image.top;\n\n                } else {\n                    // Unless we have a cropper showing, in which case drop it in the middle of the cropper\n                    deltaX = this.clipper.left - this.image.left;\n                    deltaY = this.clipper.top - this.image.top;\n                }\n\n                // Bump focal to middle of viewport\n                focalX += deltaX;\n                focalY += deltaY;\n\n                // Reflect changes in saved state\n                focalPointState.offsetX += deltaX / (sizeFactor * this.zoomRatio * this.scaleFactor);\n                focalPointState.offsetY += deltaY / (sizeFactor * this.zoomRatio * this.scaleFactor);\n            }\n\n            this.focalPoint = new fabric.Group([\n                new fabric.Circle({radius: 8, fill: 'rgba(0,0,0,0.5)', strokeWidth: 2, stroke: 'rgba(255,255,255,0.8)', left: 0, top: 0, originX: 'center', originY: 'center'}),\n                new fabric.Circle({radius: 1, fill: 'rgba(255,255,255,0)', strokeWidth: 2, stroke: 'rgba(255,255,255,0.8)', left: 0, top: 0, originX: 'center', originY: 'center'})\n            ], {\n                originX: 'center',\n                originY: 'center',\n                left: focalX,\n                top: focalY\n            });\n\n            this.storeFocalPointState(focalPointState);\n            this.canvas.add(this.focalPoint);\n        },\n\n        /**\n         * Toggle focal point\n         */\n        toggleFocalPoint: function() {\n            if (!this.focalPoint) {\n                this._createFocalPoint();\n            } else {\n                this.canvas.remove(this.focalPoint);\n                this.focalPoint = null;\n            }\n\n            this.renderImage();\n        },\n\n        /**\n         * Reposition the viewport to handle editor resizing.\n         */\n        _repositionViewport: function() {\n            if (this.viewport) {\n                var dimensions = {\n                    left: this.editorWidth / 2,\n                    top: this.editorHeight / 2\n                };\n\n                // If we're cropping, nothing exciting happens for the viewport\n                if (this.currentView === 'crop') {\n                    dimensions.width = this.editorWidth;\n                    dimensions.height = this.editorHeight;\n                } else {\n                    // If this is the first initial reposition, no cropper state yet\n                    if (this.cropperState) {\n\n                        // Recall the state\n                        var state = this.cropperState;\n\n                        var scaledImageDimensions = this.getScaledImageDimensions();\n                        // Make sure we have the correct current image size\n                        var sizeFactor = scaledImageDimensions.width / state.imageDimensions.width;\n\n                        // Set the viewport dimensions\n                        dimensions.width = state.width * sizeFactor * this.zoomRatio;\n                        dimensions.height = state.height * sizeFactor * this.zoomRatio;\n\n                        // Adjust the image position to show the correct part of the image in the viewport\n                        this.image.set({\n                            left: (this.editorWidth / 2) - (state.offsetX * sizeFactor),\n                            top: (this.editorHeight / 2) - (state.offsetY * sizeFactor)\n                        });\n                    } else {\n                        $.extend(dimensions, this.getScaledImageDimensions());\n                    }\n                }\n                this.viewport.set(dimensions);\n            }\n        },\n\n        _repositionFocalPoint: function(previousEditorDimensions) {\n            if (this.focalPoint) {\n                var offsetX = this.focalPoint.left - this.editorWidth / 2;\n                var offsetY = this.focalPoint.top - this.editorHeight / 2;\n\n                var currentWidth = this.image.width;\n                var newWidth = this.getScaledImageDimensions().width * this.zoomRatio;\n                var ratio = newWidth / currentWidth / this.scaleFactor;\n\n                offsetX -= (previousEditorDimensions.width - this.editorWidth) / 2;\n                offsetY -= (previousEditorDimensions.height - this.editorHeight) / 2;\n\n                offsetX *= ratio;\n                offsetY *= ratio;\n\n                this.focalPoint.set({\n                    left: this.editorWidth / 2 + offsetX,\n                    top: this.editorHeight / 2 + offsetY\n                });\n            }\n        },\n\n        /**\n         * Return true if the image orientation has changed\n         */\n        hasOrientationChanged: function() {\n            return this.viewportRotation % 180 !== 0;\n        },\n\n        /**\n         * Return the current image dimensions that would be used in the current image area with no straightening or rotation applied.\n         */\n        getScaledImageDimensions: function() {\n            var imageRatio = this.originalHeight / this.originalWidth;\n            var editorRatio = this.editorHeight / this.editorWidth;\n\n            var dimensions = {};\n            if (imageRatio > editorRatio) {\n                dimensions.height = Math.min(this.editorHeight, this.originalHeight);\n                dimensions.width = Math.round(this.originalWidth / (this.originalHeight / dimensions.height));\n            } else {\n                dimensions.width = Math.min(this.editorWidth, this.originalWidth);\n                dimensions.height = Math.round(this.originalHeight * (dimensions.width / this.originalWidth));\n            }\n\n            return dimensions;\n        },\n\n        /**\n         * Set the image dimensions to reflect the current zoom ratio.\n         */\n        _zoomImage: function() {\n            var imageDimensions = this.getScaledImageDimensions();\n            this.image.set({\n                width: imageDimensions.width * this.zoomRatio,\n                height: imageDimensions.height * this.zoomRatio\n            });\n        },\n\n        /**\n         * Set up listeners for the controls.\n         */\n        _addControlListeners: function() {\n\n            // Tabs\n            this.addListener(this.$tabs, 'click', '_handleTabClick');\n\n            // Focal point\n            this.addListener($('.focal-point'), 'click', function(ev) {\n                this.toggleFocalPoint(ev);\n            }.bind(this));\n\n            // Rotate controls\n            this.addListener($('.rotate-left'), 'click', function() {\n                this.rotateImage(-90);\n            }.bind(this));\n            this.addListener($('.rotate-right'), 'click', function() {\n                this.rotateImage(90);\n            }.bind(this));\n            this.addListener($('.flip-vertical'), 'click', function() {\n                this.flipImage('y');\n            }.bind(this));\n            this.addListener($('.flip-horizontal'), 'click', function() {\n                this.flipImage('x');\n            }.bind(this));\n\n            // Straighten slider\n            this.straighteningInput = new Craft.SlideRuleInput(\"slide-rule\", {\n                onStart: function() {\n                    this._showGrid();\n                }.bind(this),\n                onChange: function(slider) {\n                    this.straighten(slider);\n                }.bind(this),\n                onEnd: function() {\n                    this._hideGrid();\n                    this._cleanupFocalPointAfterStraighten();\n                }.bind(this)\n            });\n\n            // Cropper scale modifier key\n            this.addListener(Garnish.$doc, 'keydown', function(ev) {\n                if (ev.keyCode === Garnish.SHIFT_KEY) {\n                    this.shiftKeyHeld = true;\n                }\n            }.bind(this));\n            this.addListener(Garnish.$doc, 'keyup', function(ev) {\n                if (ev.keyCode === Garnish.SHIFT_KEY) {\n                    this.shiftKeyHeld = false;\n                }\n            }.bind(this));\n\n            // Cropper constraint menu\n            var constraintMenu = new Garnish.MenuBtn($('.crop .menubtn', this.$container), {\n                onOptionSelect: function (option) {\n                    $('.constraint', this.$container).html($(option).html());\n                    this.setCroppingConstraint($(option).data('constraint'));\n                    this.enforceCroppingConstraint();\n                }.bind(this)\n            });\n            constraintMenu.menu.$container.addClass('dark');\n        },\n\n        /**\n         * Handle tab click.\n         *\n         * @param ev\n         */\n        _handleTabClick: function(ev) {\n            if (!this.animationInProgress) {\n                var $tab = $(ev.currentTarget);\n                var view = $tab.data('view');\n                this.$tabs.removeClass('selected');\n                $tab.addClass('selected');\n                this.showView(view);\n            }\n        },\n\n        /**\n         * Show a view.\n         *\n         * @param view\n         */\n        showView: function(view) {\n            if (this.currentView === view) {\n                return;\n            }\n\n            this.$views.addClass('hidden');\n            var $view = this.$views.filter('[data-view=\"' + view + '\"]');\n            $view.removeClass('hidden');\n\n            if (view === 'rotate') {\n                this.enableSlider();\n            } else {\n                this.disableSlider();\n            }\n\n\n            // Now that most likely our editor dimensions have changed, time to reposition stuff\n            this.updateSizeAndPosition();\n\n            // See if we have to enable or disable crop mode as we transition between tabs\n            if (this.currentView === 'crop' && view !== 'crop') {\n                this.disableCropMode();\n            } else if (this.currentView !== 'crop' && view === 'crop') {\n                this.enableCropMode();\n            }\n\n            // Mark the current view\n            this.currentView = view;\n        },\n\n        /**\n         * Store the current cropper state.\n         *\n         * Cropper state is always assumed to be saved at a zoom ratio of 1 to be used\n         * as the basis for recalculating the cropper position and dimensions.\n         *\n         * @param [state]\n         */\n        storeCropperState: function(state) {\n            // If we're asked to store a specific state.\n            if (state) {\n                this.cropperState = state;\n            } else if (this.clipper) {\n                var zoomFactor = 1 / this.zoomRatio;\n\n                this.cropperState = {\n                    offsetX: (this.clipper.left - this.image.left) * zoomFactor,\n                    offsetY: (this.clipper.top - this.image.top) * zoomFactor,\n                    height: this.clipper.height * zoomFactor,\n                    width: this.clipper.width * zoomFactor,\n                    imageDimensions: this.getScaledImageDimensions()\n                };\n            } else {\n                var dimensions = this.getScaledImageDimensions();\n                this.cropperState = {\n                    offsetX: 0,\n                    offsetY: 0,\n                    height: dimensions.height,\n                    width: dimensions.width,\n                    imageDimensions: dimensions\n                };\n            }\n        },\n\n        /**\n         * Store focal point coordinates in a manner that is not tied to zoom ratio and rotation.\n         */\n        storeFocalPointState: function(state) {\n            // If we're asked to store a specific state.\n            if (state) {\n                this.focalPointState = state;\n            } else if (this.focalPoint) {\n                var zoomFactor = 1 / this.zoomRatio;\n                this.focalPointState = {\n                    offsetX: (this.focalPoint.left - this.image.left) * zoomFactor / this.scaleFactor,\n                    offsetY: (this.focalPoint.top - this.image.top) * zoomFactor / this.scaleFactor,\n                    imageDimensions: this.getScaledImageDimensions()\n                };\n            }\n        },\n\n        /**\n         * Rotate the image along with the viewport.\n         *\n         * @param degrees\n         */\n        rotateImage: function(degrees) {\n            if (!this.animationInProgress) {\n\n                // We're not that kind of an establishment, sir.\n                if (degrees !== 90 && degrees !== -90) {\n                    return false;\n                }\n\n                this.animationInProgress = true;\n                this.viewportRotation += degrees;\n\n                // Normalize the viewport rotation angle so it's between 0 and 359\n                this.viewportRotation = parseInt((this.viewportRotation + 360) % 360, 10);\n\n                var newAngle = this.image.angle + degrees;\n                var scaledImageDimensions = this.getScaledImageDimensions();\n                var imageZoomRatio;\n\n                if (this.hasOrientationChanged()) {\n                    imageZoomRatio = this.getZoomToCoverRatio({height: scaledImageDimensions.width, width: scaledImageDimensions.height});\n                } else {\n                    imageZoomRatio = this.getZoomToCoverRatio(scaledImageDimensions);\n                }\n\n                // In cases when for some reason we've already zoomed in on the image,\n                // use existing zoom.\n                if (this.zoomRatio > imageZoomRatio) {\n                    imageZoomRatio = this.zoomRatio;\n                }\n\n                var viewportProperties = {\n                    angle: degrees === 90 ? '+=90' : '-=90'\n                };\n\n                var imageProperties = {\n                    angle: newAngle,\n                    width: scaledImageDimensions.width * imageZoomRatio,\n                    height: scaledImageDimensions.height * imageZoomRatio\n                };\n\n                var scaleFactor = 1;\n                if (this.scaleFactor < 1) {\n                    scaleFactor = 1 / this.scaleFactor;\n                    this.scaleFactor = 1;\n                } else {\n                    if (this.viewport.width > this.editorHeight) {\n                        scaleFactor = this.editorHeight / this.viewport.width;\n                    } else if (this.viewport.height > this.editorWidth) {\n                        scaleFactor = this.editorWidth / this.viewport.height;\n                    }\n                    this.scaleFactor = scaleFactor;\n                }\n\n                if (scaleFactor < 1) {\n                    imageProperties.width *= scaleFactor;\n                    imageProperties.height *= scaleFactor;\n                }\n\n                var state = this.cropperState;\n\n                // Make sure we reposition the image as well to focus on the same image area\n                var deltaX = state.offsetX;\n                var deltaY = state.offsetY;\n                var angleInRadians = degrees * (Math.PI / 180);\n\n                // Calculate how the cropper would need to move in a circle to maintain\n                // the focus on the same region if the image was rotated with zoom intact.\n                var newDeltaX = deltaX * Math.cos(angleInRadians) - deltaY * Math.sin(angleInRadians);\n                var newDeltaY = deltaX * Math.sin(angleInRadians) + deltaY * Math.cos(angleInRadians);\n\n                var sizeFactor = scaledImageDimensions.width / state.imageDimensions.width;\n\n                var modifiedDeltaX = newDeltaX * sizeFactor * this.zoomRatio * this.scaleFactor;\n                var modifiedDeltaY = newDeltaY * sizeFactor * this.zoomRatio * this.scaleFactor;\n\n                imageProperties.left = this.editorWidth / 2 - modifiedDeltaX;\n                imageProperties.top = this.editorHeight / 2 - modifiedDeltaY;\n\n                state.offsetX = newDeltaX;\n                state.offsetY = newDeltaY;\n\n                var temp = state.width;\n                state.width = state.height;\n                state.height = temp;\n\n                this.storeCropperState(state);\n\n                if (this.focalPoint) {\n                    this.canvas.remove(this.focalPoint);\n                }\n\n                this.viewport.animate(viewportProperties, {\n                    duration: this.settings.animationDuration,\n                    onComplete: function() {\n                        // If we're zooming the image in or out, better do the same to viewport\n                        var temp = this.viewport.height * scaleFactor;\n                        this.viewport.height = this.viewport.width * scaleFactor;\n                        this.viewport.width = temp;\n                        this.viewport.set({angle: 0});\n                    }.bind(this)\n                });\n\n                // Animate the rotation and dimension change\n                this.image.animate(imageProperties, {\n                    onChange: this.canvas.renderAll.bind(this.canvas),\n                    duration: this.settings.animationDuration,\n                    onComplete: function() {\n                        var cleanAngle = parseFloat((this.image.angle + 360) % 360);\n                        this.image.set({angle: cleanAngle});\n                        this.animationInProgress = false;\n                        if (this.focalPoint) {\n                            this._adjustFocalPointByAngle(degrees);\n                            this.straighten(this.straighteningInput);\n                            this.canvas.add(this.focalPoint);\n                        } else {\n                            this._resetFocalPointPosition();\n                        }\n                    }.bind(this)\n                });\n            }\n        },\n\n        /**\n         * Flip an image along an axis.\n         *\n         * @param axis\n         */\n        flipImage: function(axis) {\n            if (!this.animationInProgress) {\n                this.animationInProgress = true;\n\n                if (this.hasOrientationChanged()) {\n                    axis = axis === 'y' ? 'x' : 'y';\n                }\n\n                if (this.focalPoint) {\n                    this.canvas.remove(this.focalPoint);\n                } else {\n                    this._resetFocalPointPosition();\n                }\n\n                var editorCenter = {x: this.editorWidth / 2, y: this.editorHeight / 2};\n                this.straighteningInput.setValue(-this.imageStraightenAngle);\n                this.imageStraightenAngle = -this.imageStraightenAngle;\n                var properties = {\n                    angle: this.viewportRotation + this.imageStraightenAngle\n                };\n\n                var deltaY, deltaX;\n                var cropperState = this.cropperState;\n                var focalPointState = this.focalPointState;\n\n                // Reposition the image, viewport, and stored cropper and focal point states.\n                if ((axis === 'y' && this.hasOrientationChanged()) || (axis !== 'y' && !this.hasOrientationChanged())) {\n                    cropperState.offsetX = -cropperState.offsetX;\n                    focalPointState.offsetX = -focalPointState.offsetX;\n                    deltaX = this.image.left - editorCenter.x;\n                    properties.left = editorCenter.x - deltaX;\n                } else {\n                    cropperState.offsetY = -cropperState.offsetY;\n                    focalPointState.offsetY = -focalPointState.offsetY;\n                    deltaY = this.image.top - editorCenter.y;\n                    properties.top = editorCenter.y - deltaY;\n                }\n\n                if (axis === 'y') {\n                    properties.scaleY = this.image.scaleY * -1;\n                    this.flipData.y = 1 - this.flipData.y;\n                } else {\n                    properties.scaleX = this.image.scaleX * -1;\n                    this.flipData.x = 1 - this.flipData.x;\n                }\n\n                this.storeCropperState(cropperState);\n                this.storeFocalPointState(focalPointState);\n\n                this.image.animate(properties, {\n                    onChange: this.canvas.renderAll.bind(this.canvas),\n                    duration: this.settings.animationDuration,\n                    onComplete: function() {\n                        this.animationInProgress = false;\n                        if (this.focalPoint) {\n                            // Well this is handy\n                            this._adjustFocalPointByAngle(0);\n                            this.canvas.add(this.focalPoint);\n                        }\n                    }.bind(this)\n                });\n            }\n        },\n\n        /**\n         * Perform the straightening with input slider.\n         *\n         * @param {Craft.SlideRuleInput} slider\n         */\n        straighten: function(slider) {\n            if (!this.animationInProgress) {\n                this.animationInProgress = true;\n\n                var previousAngle = this.image.angle;\n\n                this.imageStraightenAngle = (this.settings.allowDegreeFractions ? parseFloat(slider.value) : Math.round(parseFloat(slider.value))) % 360;\n\n                // Straighten the image\n                this.image.set({\n                    angle: this.viewportRotation + this.imageStraightenAngle\n                });\n\n                // Set the new zoom ratio\n                this.zoomRatio = this.getZoomToCoverRatio(this.getScaledImageDimensions()) * this.scaleFactor;\n                this._zoomImage();\n\n                if (this.cropperState) {\n                    this._adjustEditorElementsOnStraighten(previousAngle);\n                }\n\n                this.renderImage();\n\n                this.animationInProgress = false;\n            }\n        },\n\n        /**\n         * Adjust the cropped viewport when straightening the image to correct for\n         * bumping into edges, keeping focus on the cropped area center and to\n         * maintain the illusion that the image is being straightened relative to the viewport center.\n         *\n         * @param {integer} previousAngle integer the previous image angle before straightening\n         */\n        _adjustEditorElementsOnStraighten: function(previousAngle) {\n            var scaledImageDimensions = this.getScaledImageDimensions();\n            var angleDelta = this.image.angle - previousAngle;\n            var state = this.cropperState;\n\n            var currentZoomRatio = this.zoomRatio;\n            var adjustmentRatio = 1;\n\n            var deltaX, deltaY, newCenterX, newCenterY, sizeFactor;\n\n            do {\n                // Get the cropper center coordinates\n                var cropperCenterX = state.offsetX;\n                var cropperCenterY = state.offsetY;\n                var angleInRadians = angleDelta * (Math.PI / 180);\n\n                // Calculate how the cropper would need to move in a circle to maintain\n                // the focus on the same region if the image was rotated with zoom intact.\n                newCenterX = cropperCenterX * Math.cos(angleInRadians) - cropperCenterY * Math.sin(angleInRadians);\n                newCenterY = cropperCenterX * Math.sin(angleInRadians) + cropperCenterY * Math.cos(angleInRadians);\n\n                sizeFactor = scaledImageDimensions.width / state.imageDimensions.width;\n\n                // Figure out the final image offset to keep the viewport focused where we need it\n                deltaX = newCenterX * currentZoomRatio * sizeFactor;\n                deltaY = newCenterY * currentZoomRatio * sizeFactor;\n\n                // If the image would creep in the viewport, figure out how to math around it.\n                var imageVertices = this.getImageVerticeCoords(currentZoomRatio);\n                var rectangle = {\n                    width: this.viewport.width,\n                    height: this.viewport.height,\n                    left: this.editorWidth / 2 - this.viewport.width / 2 + deltaX,\n                    top: this.editorHeight / 2 - this.viewport.height / 2 + deltaY\n                };\n                adjustmentRatio = this._getZoomRatioToFitRectangle(rectangle, imageVertices);\n                currentZoomRatio = currentZoomRatio * adjustmentRatio;\n\n                // If we had to make adjustments, do the calculations again\n            } while (adjustmentRatio !== 1);\n\n            // Reposition the image correctly\n            this.image.set({\n                left: this.editorWidth / 2 - deltaX,\n                top: this.editorHeight / 2 - deltaY\n            });\n\n            // Finally, store the new cropper state to reflect the rotation change.\n            state.offsetX = newCenterX;\n            state.offsetY = newCenterY;\n            state.width = this.viewport.width / currentZoomRatio / sizeFactor;\n            state.height = this.viewport.height / currentZoomRatio / sizeFactor;\n\n            this.storeCropperState(state);\n\n            // Zoom the image in and we're done.\n            this.zoomRatio = currentZoomRatio;\n\n            if (this.focalPoint) {\n                this._adjustFocalPointByAngle(angleDelta);\n\n                if (!this._isCenterInside(this.focalPoint, this.viewport)) {\n                    this.focalPoint.set({opacity: 0});\n                } else {\n                    this.focalPoint.set({opacity: 1});\n                }\n            } else if (angleDelta !== 0) {\n                this._resetFocalPointPosition();\n            }\n\n            this._zoomImage();\n        },\n\n        /**\n         * If focal point is active and outside of viewport after straightening, reset it.\n         */\n        _cleanupFocalPointAfterStraighten: function() {\n            if (this.focalPoint && !this._isCenterInside(this.focalPoint, this.viewport)) {\n                this.focalPoint.set({opacity: 1});\n                var state = this.focalPointState;\n                state.offsetX = 0;\n                state.offsetY = 0;\n                this.storeFocalPointState(state);\n                this.toggleFocalPoint();\n            }\n        },\n\n        /**\n         * Reset focal point to the middle of image.\n         */\n        _resetFocalPointPosition: function () {\n            var state = this.focalPointState;\n            state.offsetX = 0;\n            state.offsetY = 0;\n            this.storeFocalPointState(state);\n        },\n\n        /**\n         * Returns true if a center of an object is inside another rectangle shaped object that is not rotated.\n         *\n         * @param object\n         * @param containingObject\n         *\n         * @returns {boolean}\n         */\n        _isCenterInside: function(object, containingObject) {\n            return (object.left > containingObject.left - containingObject.width / 2\n                && object.top > containingObject.top - containingObject.height / 2\n                && object.left < containingObject.left + containingObject.width / 2\n                && object.top < containingObject.top + containingObject.height / 2\n            );\n        },\n\n        /**\n         * Adjust the focal point by an angle in degrees.\n         * @param angle\n         */\n        _adjustFocalPointByAngle: function(angle) {\n            var angleInRadians = angle * (Math.PI / 180);\n            var state = this.focalPointState;\n\n            var focalX = state.offsetX;\n            var focalY = state.offsetY;\n\n            // Calculate how the focal point would need to move in a circle to keep on the same spot\n            // on the image if it was rotated with zoom intact.\n            var newFocalX = focalX * Math.cos(angleInRadians) - focalY * Math.sin(angleInRadians);\n            var newFocalY = focalX * Math.sin(angleInRadians) + focalY * Math.cos(angleInRadians);\n            var sizeFactor = this.getScaledImageDimensions().width / state.imageDimensions.width;\n\n            var adjustedFocalX = newFocalX * sizeFactor * this.zoomRatio;\n            var adjustedFocalY = newFocalY * sizeFactor * this.zoomRatio;\n\n            this.focalPoint.left = this.image.left + adjustedFocalX;\n            this.focalPoint.top = this.image.top + adjustedFocalY;\n\n            state.offsetX = newFocalX;\n            state.offsetY = newFocalY;\n            this.storeFocalPointState(state);\n        },\n\n        /**\n         * Get the zoom ratio required to fit a rectangle within another rectangle, that is defined by vertices.\n         * If the rectangle fits, 1 will be returned.\n         *\n         * @param rectangle\n         * @param containingVertices\n         */\n        _getZoomRatioToFitRectangle: function(rectangle, containingVertices) {\n            var rectangleVertices = this._getRectangleVertices(rectangle);\n            var vertex;\n\n            // Check if any of the viewport vertices end up out of bounds\n            for (var verticeIndex = 0; verticeIndex < rectangleVertices.length; verticeIndex++) {\n                vertex = rectangleVertices[verticeIndex];\n\n                if (!this.arePointsInsideRectangle([vertex], containingVertices)) {\n                    break;\n                }\n\n                vertex = false;\n            }\n\n            // If there's no vertex set after loop, it means that all of them are inside the image rectangle\n            var adjustmentRatio;\n\n            if (!vertex) {\n                adjustmentRatio = 1;\n            } else {\n                // Find out which edge got crossed by the vertex\n                var edge = this._getEdgeCrossed(containingVertices, vertex);\n\n                var rectangleCenter = {\n                    x: rectangle.left + rectangle.width / 2,\n                    y: rectangle.top + rectangle.height / 2\n                };\n\n                // Calculate how much further that edge needs to be.\n                // https://en.wikipedia.org/wiki/Distance_from_a_point_to_a_line#Line_defined_by_two_points\n                var distanceFromVertexToEdge = Math.abs((edge[1].y - edge[0].y) * vertex.x - (edge[1].x - edge[0].x) * vertex.y + edge[1].x * edge[0].y - edge[1].y * edge[0].x) / Math.sqrt(Math.pow(edge[1].y - edge[0].y, 2) + Math.pow(edge[1].x - edge[0].x, 2));\n                var distanceFromCenterToEdge = Math.abs((edge[1].y - edge[0].y) * rectangleCenter.x - (edge[1].x - edge[0].x) * rectangleCenter.y + edge[1].x * edge[0].y - edge[1].y * edge[0].x) / Math.sqrt(Math.pow(edge[1].y - edge[0].y, 2) + Math.pow(edge[1].x - edge[0].x, 2));\n\n                // Adjust the zoom ratio\n                adjustmentRatio = ((distanceFromVertexToEdge + distanceFromCenterToEdge) / distanceFromCenterToEdge);\n            }\n\n            return adjustmentRatio;\n        },\n\n        /**\n         * Save the image.\n         *\n         * @param ev\n         */\n        saveImage: function(ev) {\n            var $button = $(ev.currentTarget);\n            if ($button.hasClass('disabled')) {\n                return false;\n            }\n\n            $('.btn', this.$buttons).addClass('disabled');\n            this.$buttons.append('<div class=\"spinner\"></div>');\n\n            var postData = {\n                assetId: this.assetId,\n                viewportRotation: this.viewportRotation,\n                imageRotation: this.imageStraightenAngle,\n                replace: $button.hasClass('replace') ? 1 : 0\n            };\n\n            if (this.cropperState) {\n                var cropData = {};\n\n                cropData.height = this.cropperState.height;\n                cropData.width = this.cropperState.width;\n                cropData.offsetX = this.cropperState.offsetX;\n                cropData.offsetY = this.cropperState.offsetY;\n\n                postData.imageDimensions = this.cropperState.imageDimensions;\n\n                postData.cropData = cropData;\n            } else {\n                postData.imageDimensions = this.getScaledImageDimensions();\n            }\n\n            if (this.focalPoint) {\n                postData.focalPoint = this.focalPointState;\n            }\n\n            postData.flipData = this.flipData;\n            postData.zoom = this.zoomRatio;\n\n            Craft.postActionRequest('assets/save-image', postData, function(data) {\n                this.$buttons.find('.btn').removeClass('disabled').end().find('.spinner').remove();\n\n                if (data.error) {\n                    alert(data.error);\n                    return;\n                }\n\n                this.onSave();\n                this.hide();\n                Craft.cp.runQueue();\n            }.bind(this));\n        },\n\n        /**\n         * Return image zoom ratio depending on the straighten angle to cover a viewport by given dimensions.\n         *\n         * @param dimensions\n         */\n        getZoomToCoverRatio: function(dimensions) {\n            // Convert the angle to radians\n            var angleInRadians = Math.abs(this.imageStraightenAngle) * (Math.PI / 180);\n\n            // Calculate the dimensions of the scaled image using the magic of math\n            var scaledWidth = Math.sin(angleInRadians) * dimensions.height + Math.cos(angleInRadians) * dimensions.width;\n            var scaledHeight = Math.sin(angleInRadians) * dimensions.width + Math.cos(angleInRadians) * dimensions.height;\n\n            // Calculate the ratio\n            return Math.max(scaledWidth / dimensions.width, scaledHeight / dimensions.height);\n        },\n\n        /**\n         * Return image zoom ratio depending on the straighten angle to fit inside a viewport by given dimensions.\n         *\n         * @param dimensions\n         */\n        getZoomToFitRatio: function(dimensions) {\n\n            // Get the bounding box for a rotated image\n            var boundingBox = this._getImageBoundingBox(dimensions);\n\n            // Scale the bounding box to fit\n            var scale = 1;\n            if (boundingBox.height > this.editorHeight || boundingBox.width > this.editorWidth) {\n                var vertScale = this.editorHeight / boundingBox.height;\n                var horiScale = this.editorWidth / boundingBox.width;\n                scale = Math.min(horiScale, vertScale);\n            }\n\n            return scale;\n        },\n\n        /**\n         * Return the combined zoom ratio to fit a rectangle inside image that's been zoomed to fit.\n         */\n        getCombinedZoomRatio: function(dimensions) {\n            return this.getZoomToCoverRatio(dimensions) / this.getZoomToFitRatio(dimensions);\n        },\n\n        /**\n         * Draw the grid.\n         *\n         * @private\n         */\n        _showGrid: function() {\n            if (!this.grid) {\n                var strokeOptions = {\n                    strokeWidth: 1,\n                    stroke: 'rgba(255,255,255,0.5)'\n                };\n\n                var lineCount = 8;\n                var gridWidth = this.viewport.width;\n                var gridHeight = this.viewport.height;\n                var xStep = gridWidth / (lineCount + 1);\n                var yStep = gridHeight / (lineCount + 1);\n\n                var grid = [\n                    new fabric.Rect({\n                        strokeWidth: 2,\n                        stroke: 'rgba(255,255,255,1)',\n                        originX: 'center',\n                        originY: 'center',\n                        width: gridWidth,\n                        height: gridHeight,\n                        left: gridWidth / 2,\n                        top: gridHeight / 2,\n                        fill: 'rgba(255,255,255,0)'\n                    })\n                ];\n\n                var i;\n                for (i = 1; i <= lineCount; i++) {\n                    grid.push(new fabric.Line([i * xStep, 0, i * xStep, gridHeight], strokeOptions));\n                }\n                for (i = 1; i <= lineCount; i++) {\n                    grid.push(new fabric.Line([0, i * yStep, gridWidth, i * yStep], strokeOptions));\n                }\n\n                this.grid = new fabric.Group(grid, {\n                    left: this.editorWidth / 2,\n                    top: this.editorHeight / 2,\n                    originX: 'center',\n                    originY: 'center',\n                    angle: this.viewport.angle\n                });\n\n                this.canvas.add(this.grid);\n                this.renderImage();\n            }\n        },\n\n        /**\n         * Hide the grid\n         */\n        _hideGrid: function() {\n            this.canvas.remove(this.grid);\n            this.grid = null;\n            this.renderImage();\n        },\n\n        /**\n         * Remove all the events when hiding the editor.\n         */\n        onFadeOut: function() {\n            this.removeListener(this.$croppingCanvas, 'mousemove', this._handleMouseMove.bind(this));\n            this.removeListener(this.$croppingCanvas, 'mousedown', this._handleMouseDown.bind(this));\n            this.removeListener(this.$croppingCanvas, 'mouseup', this._handleMouseUp.bind(this));\n            this.removeListener(this.$croppingCanvas, 'mouseout', function(ev) {\n                this._handleMouseUp(ev);\n                this._handleMouseMove(ev);\n            }.bind(this));\n            this.destroy();\n        },\n\n        /**\n         * Make sure underlying content is not scrolled by accident.\n         */\n        show: function() {\n            this.base();\n\n            $('html').addClass('noscroll');\n        },\n\n        /**\n         * Allow the content to scroll.\n         */\n        hide: function() {\n            this.removeAllListeners();\n            this.straighteningInput.removeAllListeners();\n            $('html').removeClass('noscroll');\n            this.base();\n        },\n\n        /**\n         * onSave callback.\n         */\n        onSave: function() {\n            this.settings.onSave();\n            this.trigger('save');\n        },\n\n        /**\n         * Enable the rotation slider.\n         */\n        enableSlider: function() {\n            this.$imageTools.removeClass('hidden');\n        },\n\n        /**\n         * Disable the rotation slider.\n         */\n        disableSlider: function() {\n            this.$imageTools.addClass('hidden');\n        },\n\n        /**\n         * Switch to crop mode.\n         */\n        enableCropMode: function() {\n            var imageDimensions = this.getScaledImageDimensions();\n            this.zoomRatio = this.getZoomToFitRatio(imageDimensions);\n\n            var viewportProperties = {\n                width: this.editorWidth,\n                height: this.editorHeight\n            };\n\n            var imageProperties = {\n                width: imageDimensions.width * this.zoomRatio,\n                height: imageDimensions.height * this.zoomRatio,\n                left: this.editorWidth / 2,\n                top: this.editorHeight / 2\n            };\n\n            var callback = function() {\n                this._setFittedImageVerticeCoordinates();\n\n                // Restore cropper\n                var state = this.cropperState;\n                var scaledImageDimensions = this.getScaledImageDimensions();\n                var sizeFactor = scaledImageDimensions.width / state.imageDimensions.width;\n\n                // Restore based on the stored information\n                var cropperData = {\n                    left: this.image.left + (state.offsetX * sizeFactor * this.zoomRatio),\n                    top: this.image.top + (state.offsetY * sizeFactor * this.zoomRatio),\n                    width: state.width * sizeFactor * this.zoomRatio,\n                    height: state.height * sizeFactor * this.zoomRatio\n                };\n\n                this._showCropper(cropperData);\n\n                if (this.focalPoint) {\n                    sizeFactor = scaledImageDimensions.width / this.focalPointState.imageDimensions.width;\n                    this.focalPoint.left = this.image.left + (this.focalPointState.offsetX * sizeFactor * this.zoomRatio);\n                    this.focalPoint.top = this.image.top + (this.focalPointState.offsetY * sizeFactor * this.zoomRatio);\n                    this.canvas.add(this.focalPoint);\n                }\n            }.bind(this);\n\n            this._editorModeTransition(callback, imageProperties, viewportProperties);\n        },\n\n        /**\n         * Switch out of crop mode.\n         */\n        disableCropMode: function() {\n\n            var viewportProperties = {};\n\n            var imageProperties = {\n                left: this.editorWidth / 2,\n                top: this.editorHeight / 2\n            };\n\n            this._hideCropper();\n            var targetZoom = this.getZoomToCoverRatio(this.getScaledImageDimensions()) * this.scaleFactor;\n            var inverseZoomFactor = targetZoom / this.zoomRatio;\n            this.zoomRatio = targetZoom;\n\n            var offsetX = this.clipper.left - this.image.left;\n            var offsetY = this.clipper.top - this.image.top;\n\n            var imageOffsetX = offsetX * inverseZoomFactor;\n            var imageOffsetY = offsetY * inverseZoomFactor;\n            imageProperties.left = (this.editorWidth / 2) - imageOffsetX;\n            imageProperties.top = (this.editorHeight / 2) - imageOffsetY;\n\n            // Calculate the cropper dimensions after all the zooming\n            viewportProperties.height = this.clipper.height * inverseZoomFactor;\n            viewportProperties.width = this.clipper.width * inverseZoomFactor;\n\n            if (!this.focalPoint || (this.focalPoint && !this._isCenterInside(this.focalPoint, this.clipper))) {\n                if (this.focalPoint) {\n                    this.toggleFocalPoint();\n                }\n\n                this._resetFocalPointPosition();\n            }\n\n            var callback = function() {\n                // Reposition focal point correctly\n                if (this.focalPoint) {\n                    var sizeFactor = this.getScaledImageDimensions().width / this.focalPointState.imageDimensions.width;\n                    this.focalPoint.left = this.image.left + (this.focalPointState.offsetX * sizeFactor * this.zoomRatio);\n                    this.focalPoint.top = this.image.top + (this.focalPointState.offsetY * sizeFactor * this.zoomRatio);\n                    this.canvas.add(this.focalPoint);\n                }\n            }.bind(this);\n\n            this._editorModeTransition(callback, imageProperties, viewportProperties);\n        },\n\n        /**\n         * Transition between cropping end editor modes\n         *\n         * @param callback\n         * @param imageProperties\n         * @param viewportProperties\n         * @private\n         */\n        _editorModeTransition: function (callback, imageProperties, viewportProperties) {\n\n            if (!this.animationInProgress) {\n                this.animationInProgress = true;\n\n                // Without this it looks semi-broken during animation\n                if (this.focalPoint) {\n                    this.canvas.remove(this.focalPoint);\n                    this.renderImage();\n                }\n\n                this.image.animate(imageProperties, {\n                    onChange: this.canvas.renderAll.bind(this.canvas),\n                    duration: this.settings.animationDuration,\n                    onComplete: function() {\n                        callback();\n                        this.animationInProgress = false;\n                        this.renderImage();\n                    }.bind(this)\n                });\n\n                this.viewport.animate(viewportProperties, {\n                    duration: this.settings.animationDuration\n                });\n            }\n        },\n\n        _showSpinner: function() {\n            this.$spinnerCanvas = $('<canvas id=\"spinner-canvas\"></canvas>').appendTo($('.image', this.$container));\n            var canvas = document.getElementById('spinner-canvas');\n            var context = canvas.getContext('2d');\n            var start = new Date();\n            var lines = 16,\n                cW = context.canvas.width,\n                cH = context.canvas.height;\n\n            var draw = function() {\n                var rotation = parseInt(((new Date() - start) / 1000) * lines) / lines;\n                context.save();\n                context.clearRect(0, 0, cW, cH);\n                context.translate(cW / 2, cH / 2);\n                context.rotate(Math.PI * 2 * rotation);\n                for (var i = 0; i < lines; i++) {\n\n                    context.beginPath();\n                    context.rotate(Math.PI * 2 / lines);\n                    context.moveTo(cW / 10, 0);\n                    context.lineTo(cW / 4, 0);\n                    context.lineWidth = cW / 30;\n                    context.strokeStyle = \"rgba(255,255,255,\" + i / lines + \")\";\n                    context.stroke();\n                }\n                context.restore();\n            };\n            this.spinnerInterval = window.setInterval(draw, 1000 / 30);\n        },\n\n        _hideSpinner: function () {\n            window.clearInterval(this.spinnerInterval);\n            this.$spinnerCanvas.remove();\n            this.$spinnerCanvas = null;\n        },\n\n        /**\n         * Show the cropper.\n         *\n         * @param clipperData\n         */\n        _showCropper: function(clipperData) {\n            this._setupCropperLayer(clipperData);\n            this._redrawCropperElements();\n            this.renderCropper();\n        },\n\n        /**\n         * Hide the cropper.\n         */\n        _hideCropper: function() {\n            if (this.clipper) {\n                this.croppingCanvas.remove(this.clipper);\n                this.croppingCanvas.remove(this.croppingShade);\n                this.croppingCanvas.remove(this.cropperHandles);\n                this.croppingCanvas.remove(this.cropperGrid);\n                this.croppingCanvas.remove(this.croppingRectangle);\n\n                this.croppingCanvas = null;\n                this.renderCropper = null;\n            }\n        },\n\n        /**\n         * Draw the cropper.\n         *\n         * @param clipperData\n         */\n        _setupCropperLayer: function(clipperData) {\n            // Set up the canvas for cropper\n            this.croppingCanvas = new fabric.StaticCanvas('cropping-canvas', {\n                backgroundColor: 'rgba(0,0,0,0)',\n                hoverCursor: 'default',\n                selection: false\n            });\n\n            this.croppingCanvas.setDimensions({\n                width: this.editorWidth,\n                height: this.editorHeight\n            });\n\n            this.renderCropper = function() {\n                Garnish.requestAnimationFrame(this.croppingCanvas.renderAll.bind(this.croppingCanvas));\n            }.bind(this);\n\n\n            $('#cropping-canvas', this.$editorContainer).css({\n                position: 'absolute',\n                top: 0,\n                left: 0\n            });\n\n            this.croppingShade = new fabric.Rect({\n                left: this.editorWidth / 2,\n                top: this.editorHeight / 2,\n                originX: 'center',\n                originY: 'center',\n                width: this.editorWidth,\n                height: this.editorHeight,\n                fill: 'rgba(0,0,0,0.7)'\n            });\n\n            // Calculate the cropping rectangle size\n            var imageDimensions = this.getScaledImageDimensions();\n            var rectangleRatio = this.imageStraightenAngle === 0 ? 1 : this.getCombinedZoomRatio(imageDimensions) * 1.2;\n            var rectWidth = imageDimensions.width / rectangleRatio;\n            var rectHeight = imageDimensions.height / rectangleRatio;\n\n            if (this.hasOrientationChanged()) {\n                var temp = rectHeight;\n                rectHeight = rectWidth;\n                rectWidth = temp;\n            }\n\n            // Set up the cropping viewport rectangle\n            this.clipper = new fabric.Rect({\n                left: this.editorWidth / 2,\n                top: this.editorHeight / 2,\n                originX: 'center',\n                originY: 'center',\n                width: rectWidth,\n                height: rectHeight,\n                stroke: 'black',\n                fill: 'rgba(128,0,0,1)',\n                strokeWidth: 0\n            });\n\n            // Set from clipper data\n            if (clipperData) {\n                this.clipper.set(clipperData);\n            }\n\n            this.clipper.globalCompositeOperation = 'destination-out';\n            this.croppingCanvas.add(this.croppingShade);\n            this.croppingCanvas.add(this.clipper);\n        },\n\n        /**\n         * Redraw the cropper boundaries\n         */\n        _redrawCropperElements: function() {\n            if (this.cropperHandles) {\n                this.croppingCanvas.remove(this.cropperHandles);\n                this.croppingCanvas.remove(this.cropperGrid);\n                this.croppingCanvas.remove(this.croppingRectangle);\n            }\n            var lineOptions = {\n                strokeWidth: 4,\n                stroke: 'rgb(255,255,255)',\n                fill: false\n            };\n\n            var gridOptions = {\n                strokeWidth: 2,\n                stroke: 'rgba(255,255,255,0.5)'\n            };\n\n            // Draw the handles\n            var pathGroup = [\n                new fabric.Path('M 0,10 L 0,0 L 10,0', lineOptions),\n                new fabric.Path('M ' + (this.clipper.width - 8) + ',0 L ' + (this.clipper.width + 4) + ',0 L ' + (this.clipper.width + 4) + ',10', lineOptions),\n                new fabric.Path('M ' + (this.clipper.width + 4) + ',' + (this.clipper.height - 8) + ' L' + (this.clipper.width + 4) + ',' + (this.clipper.height + 4) + ' L ' + (this.clipper.width - 8) + ',' + (this.clipper.height + 4), lineOptions),\n                new fabric.Path('M 10,' + (this.clipper.height + 4) + ' L 0,' + (this.clipper.height + 4) + ' L 0,' + (this.clipper.height - 8), lineOptions)\n            ];\n\n            this.cropperHandles = new fabric.Group(pathGroup, {\n                left: this.clipper.left,\n                top: this.clipper.top,\n                originX: 'center',\n                originY: 'center'\n            });\n\n            // Don't forget the rectangle\n            this.croppingRectangle = new fabric.Rect({\n                left: this.clipper.left,\n                top: this.clipper.top,\n                width: this.clipper.width,\n                height: this.clipper.height,\n                fill: 'rgba(0,0,0,0)',\n                stroke: 'rgba(255,255,255,0.8)',\n                strokeWidth: 2,\n                originX: 'center',\n                originY: 'center'\n            });\n\n            this.cropperGrid = new fabric.Group(\n                [\n                    new fabric.Line([this.clipper.width * 0.33, 0, this.clipper.width * 0.33, this.clipper.height], gridOptions),\n                    new fabric.Line([this.clipper.width * 0.66, 0, this.clipper.width * 0.66, this.clipper.height], gridOptions),\n                    new fabric.Line([0, this.clipper.height * 0.33, this.clipper.width, this.clipper.height * 0.33], gridOptions),\n                    new fabric.Line([0, this.clipper.height * 0.66, this.clipper.width, this.clipper.height * 0.66], gridOptions)\n                ], {\n                    left: this.clipper.left,\n                    top: this.clipper.top,\n                    originX: 'center',\n                    originY: 'center'\n                }\n            );\n\n            this.croppingCanvas.add(this.cropperHandles);\n            this.croppingCanvas.add(this.cropperGrid);\n            this.croppingCanvas.add(this.croppingRectangle);\n        },\n\n        /**\n         * Reposition the cropper when the image editor dimensions change.\n         *\n         * @param previousImageArea\n         */\n        _repositionCropper: function(previousImageArea) {\n            if (!this.croppingCanvas) {\n                return;\n            }\n\n            // Get the current clipper offset relative to center\n            var currentOffset = {\n                x: this.clipper.left - this.croppingCanvas.width / 2,\n                y: this.clipper.top - this.croppingCanvas.height / 2\n            };\n\n            // Resize the cropping canvas\n            this.croppingCanvas.setDimensions({\n                width: this.editorWidth,\n                height: this.editorHeight\n            });\n\n            // Check by what factor will the new final bounding box be different\n            var currentArea = this._getBoundingRectangle(this.imageVerticeCoords);\n            var areaFactor = currentArea.width / previousImageArea.width;\n\n            // Adjust the cropper size to scale along with the bounding box\n            this.clipper.width = Math.round(this.clipper.width * areaFactor);\n            this.clipper.height = Math.round(this.clipper.height * areaFactor);\n\n            // Adjust the coordinates: re-position clipper in relation to the new center to adjust\n            // for editor size changes and then multiply by the size factor to adjust for image size changes\n            this.clipper.left = this.editorWidth / 2 + (currentOffset.x * areaFactor);\n            this.clipper.top = this.editorHeight / 2 + (currentOffset.y * areaFactor);\n\n            // Resize the cropping shade\n            this.croppingShade.set({\n                width: this.editorWidth,\n                height: this.editorHeight,\n                left: this.editorWidth / 2,\n                top: this.editorHeight / 2\n            });\n\n            this._redrawCropperElements();\n            this.renderCropper();\n        },\n\n        /**\n         * Get the dimensions of a bounding rectangle by a set of four coordinates.\n         *\n         * @param coordinateSet\n         */\n        _getBoundingRectangle: function(coordinateSet) {\n            return {\n                width: Math.max(coordinateSet.a.x, coordinateSet.b.x, coordinateSet.c.x, coordinateSet.d.x) - Math.min(coordinateSet.a.x, coordinateSet.b.x, coordinateSet.c.x, coordinateSet.d.x),\n                height: Math.max(coordinateSet.a.y, coordinateSet.b.y, coordinateSet.c.y, coordinateSet.d.y) - Math.min(coordinateSet.a.y, coordinateSet.b.y, coordinateSet.c.y, coordinateSet.d.y)\n            };\n        },\n\n        /**\n         * Handle the mouse being clicked.\n         *\n         * @param ev\n         */\n        _handleMouseDown: function(ev) {\n            // Focal before resize before dragging\n            var focal = this.focalPoint && this._isMouseOver(ev, this.focalPoint);\n            var move = this.croppingCanvas && this._isMouseOver(ev, this.clipper);\n            var handle = this.croppingCanvas && this._cropperHandleHitTest(ev);\n\n            if (handle || move || focal) {\n                this.previousMouseX = ev.pageX;\n                this.previousMouseY = ev.pageY;\n\n                if (focal) {\n                    this.draggingFocal = true;\n                } else if (handle) {\n                    this.scalingCropper = handle;\n                } else if (move) {\n                    this.draggingCropper = true;\n                }\n            }\n        },\n\n        /**\n         * Handle the mouse being moved.\n         *\n         * @param ev\n         */\n        _handleMouseMove: function(ev) {\n            if (this.focalPoint && this.draggingFocal) {\n                this._handleFocalDrag(ev);\n                this.storeFocalPointState();\n                this.renderImage();\n            } else if (this.draggingCropper || this.scalingCropper) {\n                if (this.draggingCropper) {\n                    this._handleCropperDrag(ev);\n                } else {\n                    this._handleCropperResize(ev);\n                }\n\n                this._redrawCropperElements();\n\n                this.storeCropperState();\n                this.renderCropper();\n            } else {\n                this._setMouseCursor(ev);\n            }\n\n            this.previousMouseX = ev.pageX;\n            this.previousMouseY = ev.pageY;\n        },\n\n        /**\n         * Handle mouse being released.\n         *\n         * @param ev\n         */\n        _handleMouseUp: function(ev) {\n            this.draggingCropper = false;\n            this.scalingCropper = false;\n            this.draggingFocal = false;\n        },\n\n        /**\n         * Handle cropper being dragged.\n         *\n         * @param ev\n         */\n        _handleCropperDrag: function(ev) {\n            var deltaX = ev.pageX - this.previousMouseX;\n            var deltaY = ev.pageY - this.previousMouseY;\n\n            if (deltaX === 0 && deltaY === 0) {\n                return;\n            }\n\n            var rectangle = {\n                left: this.clipper.left - this.clipper.width / 2,\n                top: this.clipper.top - this.clipper.height / 2,\n                width: this.clipper.width,\n                height: this.clipper.height\n            };\n\n            var vertices = this._getRectangleVertices(rectangle, deltaX, deltaY);\n\n            // Just make sure that the cropper stays inside the image\n            if (!this.arePointsInsideRectangle(vertices, this.imageVerticeCoords)) {\n                return;\n            }\n\n            this.clipper.set({\n                left: this.clipper.left + deltaX,\n                top: this.clipper.top + deltaY\n            });\n\n        },\n\n        /**\n         * Handle focal point being dragged.\n         *\n         * @param ev\n         */\n        _handleFocalDrag: function(ev) {\n            if (this.focalPoint) {\n                var deltaX = ev.pageX - this.previousMouseX;\n                var deltaY = ev.pageY - this.previousMouseY;\n\n                if (deltaX === 0 && deltaY === 0) {\n                    return;\n                }\n\n                var newX = this.focalPoint.left + deltaX;\n                var newY = this.focalPoint.top + deltaY;\n\n                // Just make sure that the focal point stays inside the image\n                if (this.currentView === 'crop') {\n                    if (!this.arePointsInsideRectangle([{x: newX, y: newY}], this.imageVerticeCoords)) {\n                        return;\n                    }\n                } else {\n                    if (!(this.viewport.left - this.viewport.width / 2 - newX < 0 && this.viewport.left + this.viewport.width / 2 - newX > 0\n                        && this.viewport.top - this.viewport.height / 2 - newY < 0 && this.viewport.top + this.viewport.height / 2 - newY > 0)) {\n                        return;\n                    }\n                }\n\n                this.focalPoint.set({\n                    left: this.focalPoint.left + deltaX,\n                    top: this.focalPoint.top + deltaY\n                });\n            }\n        },\n\n        /**\n         * Set the cropping constraint\n         * @param constraint\n         */\n        setCroppingConstraint: function(constraint) {\n\n            // In case this caused the sidebar width to change.\n            this.updateSizeAndPosition();\n\n            switch (constraint) {\n                case 'none':\n                    constraint = false;\n                    break;\n\n                case 'original':\n                    constraint = this.originalWidth / this.originalHeight;\n                    break;\n\n                case 'current':\n                    constraint = this.clipper.width / this.clipper.height;\n                    break;\n\n                default:\n                    constraint = parseFloat(constraint);\n                    break;\n            }\n\n            this.croppingConstraint = constraint;\n        },\n\n        /**\n         * Enforce the cropping constraint\n         */\n        enforceCroppingConstraint: function () {\n            if (this.animationInProgress || !this.croppingConstraint) {\n                return;\n            }\n\n            this.animationInProgress = true;\n\n            // Mock the clipping rectangle for collision tests\n            var rectangle = {\n                left: this.clipper.left - this.clipper.width / 2,\n                top: this.clipper.top - this.clipper.height / 2,\n                width: this.clipper.width,\n                height: this.clipper.height\n            };\n\n            // If wider than it should be\n            if (this.clipper.width > this.clipper.height * this.croppingConstraint)\n            {\n                var previousHeight = rectangle.height;\n\n                // Make it taller!\n                rectangle.height = this.clipper.width / this.croppingConstraint;\n\n                // Getting really awkward having to convert between 0;0 being center or top-left corner.\n                rectangle.top -= (rectangle.height - previousHeight) / 2;\n\n                // If the clipper would end up out of bounds, make it narrower instead.\n                if (!this.arePointsInsideRectangle(this._getRectangleVertices(rectangle), this.imageVerticeCoords)) {\n                    rectangle.width = this.clipper.height * this.croppingConstraint;\n                    rectangle.height = rectangle.width / this.croppingConstraint;\n                }\n            } else {\n                // Follow the same pattern, if taller than it should be.\n                var previousWidth = rectangle.width;\n                rectangle.width = this.clipper.height * this.croppingConstraint;\n                rectangle.left -= (rectangle.width - previousWidth) / 2;\n\n                if (!this.arePointsInsideRectangle(this._getRectangleVertices(rectangle), this.imageVerticeCoords)) {\n                    rectangle.height = this.clipper.width / this.croppingConstraint;\n                    rectangle.width = rectangle.height * this.croppingConstraint;\n                }\n            }\n\n            var properties = {\n                height: rectangle.height,\n                width: rectangle.width\n            };\n\n            // Make sure to redraw cropper handles and gridlines when resizing\n            this.clipper.animate(properties, {\n                onChange: function() {\n                    this._redrawCropperElements();\n                    this.croppingCanvas.renderAll();\n                }.bind(this),\n                duration: this.settings.animationDuration,\n                onComplete: function() {\n                    this._redrawCropperElements();\n                    this.animationInProgress = false;\n                    this.renderCropper();\n                }.bind(this)\n            });\n        },\n\n        /**\n         * Handle cropper being resized.\n         *\n         * @param ev\n         */\n        _handleCropperResize: function(ev) {\n            // Size deltas\n            var deltaX = ev.pageX - this.previousMouseX;\n            var deltaY = ev.pageY - this.previousMouseY;\n\n            // Center deltas\n            var topDelta = 0;\n            var leftDelta = 0;\n\n            if (this.scalingCropper === 'b' || this.scalingCropper === 't') {\n                deltaX = 0;\n            }\n\n            if (this.scalingCropper === 'l' || this.scalingCropper === 'r') {\n                deltaY = 0;\n            }\n\n            if (deltaX === 0 && deltaY === 0) {\n                return;\n            }\n\n            var rectangle = {\n                left: this.clipper.left - this.clipper.width / 2,\n                top: this.clipper.top - this.clipper.height / 2,\n                width: this.clipper.width,\n                height: this.clipper.height\n            };\n\n            // Lock the aspect ratio if needed\n            if (this.croppingConstraint) {\n                var change = 0;\n\n                // Take into account the mouse direction and figure out the \"real\" change in cropper size\n                switch (this.scalingCropper) {\n                    case 't':\n                        change = -deltaY;\n                        break;\n                    case 'b':\n                        change = deltaY;\n                        break;\n                    case 'r':\n                        change = deltaX;\n                        break;\n                    case 'l':\n                        change = -deltaX;\n                        break;\n                    case 'tr':\n                        change = -deltaY + deltaX;\n                        break;\n                    case 'tl':\n                        change = -deltaY - deltaX;\n                        break;\n                    case 'br':\n                        change = deltaY + deltaX;\n                        break;\n                    case 'bl':\n                        change = deltaY - deltaX;\n                        break;\n                }\n\n                if (this.croppingConstraint > 1) {\n                    deltaX = change;\n                    deltaY = deltaX / this.croppingConstraint;\n                } else {\n                    deltaY = change;\n                    deltaX = deltaY * this.croppingConstraint;\n                }\n\n                rectangle.height += deltaY;\n                rectangle.width += deltaX;\n\n                // Make the cropper compress/expand relative to the correct edge to make it feel \"right\"\n                if (this.scalingCropper.match(/t/)) {\n                    rectangle.top -= deltaY;\n                    rectangle.left -= deltaX / 2;\n                    topDelta = -deltaY/2;\n                }\n\n                if (this.scalingCropper.match(/b/)) {\n                    rectangle.left += -deltaX / 2;\n                    topDelta = deltaY/2;\n                }\n\n                if (this.scalingCropper.match(/r/)) {\n                    rectangle.top += -deltaY / 2;\n                    leftDelta = deltaX/2;\n                }\n\n                if (this.scalingCropper.match(/l/)) {\n                    rectangle.top -= deltaY / 2;\n                    rectangle.left -= deltaX;\n                    leftDelta = -deltaX/2;\n                }\n            } else {\n\n                // Lock the aspect ratio\n                if (this.shiftKeyHeld &&\n                    (this.scalingCropper === 'tl' || this.scalingCropper === 'tr' ||\n                    this.scalingCropper === 'bl' || this.scalingCropper === 'br')\n                ) {\n                    var ratio;\n                    if (Math.abs(deltaX) > Math.abs(deltaY)) {\n                        ratio = this.clipper.width / this.clipper.height;\n                        deltaY = deltaX / ratio;\n                        deltaY *= (this.scalingCropper === 'tr' || this.scalingCropper === 'bl') ? -1 : 1;\n                    } else {\n                        ratio = this.clipper.width / this.clipper.height;\n                        deltaX = deltaY * ratio;\n                        deltaX *= (this.scalingCropper === 'tr' || this.scalingCropper === 'bl') ? -1 : 1;\n                    }\n                }\n\n                if (this.scalingCropper.match(/t/)) {\n                    rectangle.top += deltaY;\n                    rectangle.height -= deltaY;\n                }\n                if (this.scalingCropper.match(/b/)) {\n                    rectangle.height += deltaY;\n                }\n                if (this.scalingCropper.match(/r/)) {\n                    rectangle.width += deltaX;\n                }\n                if (this.scalingCropper.match(/l/)) {\n                    rectangle.left += deltaX;\n                    rectangle.width -= deltaX;\n                }\n\n                topDelta = deltaY/2;\n                leftDelta = deltaX/2;\n            }\n\n            if (rectangle.height < 30 || rectangle.width < 30) {\n                return;\n            }\n\n            if (!this.arePointsInsideRectangle(this._getRectangleVertices(rectangle), this.imageVerticeCoords)) {\n                return;\n            }\n\n            this.clipper.set({\n                top: this.clipper.top + topDelta,\n                left: this.clipper.left + leftDelta,\n                width: rectangle.width,\n                height: rectangle.height\n            });\n\n            this._redrawCropperElements();\n        },\n\n        /**\n         * Set mouse cursor by it's position over cropper.\n         *\n         * @param ev\n         */\n        _setMouseCursor: function(ev) {\n            var cursor = 'default';\n            var handle = this.croppingCanvas && this._cropperHandleHitTest(ev);\n            if (this.focalPoint && this._isMouseOver(ev, this.focalPoint)) {\n                cursor = 'pointer';\n            } else if (handle) {\n                if (handle === 't' || handle === 'b') {\n                    cursor = 'ns-resize';\n                } else if (handle === 'l' || handle === 'r') {\n                    cursor = 'ew-resize';\n                } else if (handle === 'tl' || handle === 'br') {\n                    cursor = 'nwse-resize';\n                } else if (handle === 'bl' || handle === 'tr') {\n                    cursor = 'nesw-resize';\n                }\n            } else if (this.croppingCanvas && this._isMouseOver(ev, this.clipper)) {\n                cursor = 'move';\n            }\n\n            $('.body').css('cursor', cursor);\n        },\n\n        /**\n         * Test whether the mouse cursor is on any cropper handles.\n         *\n         * @param ev\n         */\n        _cropperHandleHitTest: function(ev) {\n            var parentOffset = this.$croppingCanvas.offset();\n            var mouseX = ev.pageX - parentOffset.left;\n            var mouseY = ev.pageY - parentOffset.top;\n\n            // Compensate for center origin coordinate-wise\n            var lb = this.clipper.left - this.clipper.width / 2;\n            var rb = lb + this.clipper.width;\n            var tb = this.clipper.top - this.clipper.height / 2;\n            var bb = tb + this.clipper.height;\n\n            // Left side top/bottom\n            if (mouseX < lb + 10 && mouseX > lb - 3) {\n                if (mouseY < tb + 10 && mouseY > tb - 3) {\n                    return 'tl';\n                } else if (mouseY < bb + 3 && mouseY > bb - 10) {\n                    return 'bl';\n                }\n            }\n            // Right side top/bottom\n            if (mouseX > rb - 13 && mouseX < rb + 3) {\n                if (mouseY < tb + 10 && mouseY > tb - 3) {\n                    return 'tr';\n                } else if (mouseY < bb + 2 && mouseY > bb - 10) {\n                    return 'br';\n                }\n            }\n\n            // Left or right\n            if (mouseX < lb + 3 && mouseX > lb - 3 && mouseY < bb - 10 && mouseY > tb + 10) {\n                return 'l';\n            }\n            if (mouseX < rb + 1 && mouseX > rb - 5 && mouseY < bb - 10 && mouseY > tb + 10) {\n                return 'r';\n            }\n\n            // Top or bottom\n            if (mouseY < tb + 4 && mouseY > tb - 2 && mouseX > lb + 10 && mouseX < rb - 10) {\n                return 't';\n            }\n            if (mouseY < bb + 2 && mouseY > bb - 4 && mouseX > lb + 10 && mouseX < rb - 10) {\n                return 'b';\n            }\n\n            return false;\n        },\n\n        /**\n         * Test whether the mouse cursor is on a fabricJS object.\n         *\n         * @param object\n         * @param event\n         *\n         * @return boolean\n         */\n\n        _isMouseOver: function(event, object) {\n            var parentOffset = this.$croppingCanvas.offset();\n            var mouseX = event.pageX - parentOffset.left;\n            var mouseY = event.pageY - parentOffset.top;\n\n            // Compensate for center origin coordinate-wise\n            var lb = object.left - object.width / 2;\n            var rb = lb + object.width;\n            var tb = object.top - object.height / 2;\n            var bb = tb + object.height;\n\n            return (mouseX >= lb && mouseX <= rb && mouseY >= tb && mouseY <= bb);\n        },\n\n        /**\n         * Get vertices of a rectangle defined by left,top,height and width properties.\n         * Optionally it's possible to provide offsetX and offsetY values.\n         * Left and top properties of rectangle reference the top-left corner.\n         *\n         * @param rectangle\n         * @param [offsetX]\n         * @param [offsetY]\n         */\n        _getRectangleVertices: function(rectangle, offsetX, offsetY) {\n            if (typeof offsetX === 'undefined') {\n                offsetX = 0;\n            }\n            if (typeof offsetY === 'undefined') {\n                offsetY = 0;\n            }\n\n            var topLeft = {\n                x: rectangle.left + offsetX,\n                y: rectangle.top + offsetY\n            };\n\n            var topRight = {x: topLeft.x + rectangle.width, y: topLeft.y};\n            var bottomRight = {x: topRight.x, y: topRight.y + rectangle.height};\n            var bottomLeft = {x: topLeft.x, y: bottomRight.y};\n\n            return [topLeft, topRight, bottomRight, bottomLeft];\n        },\n\n        /**\n         * Set image vertice coordinates for an image that's been zoomed to fit.\n         */\n        _setFittedImageVerticeCoordinates: function() {\n            this.imageVerticeCoords = this.getImageVerticeCoords('fit');\n        },\n\n        /**\n         * Get image vertice coords by a zoom mode and taking into account the straightening angle.\n         * The zoomMode can be either \"cover\", \"fit\" or a discrete float value.\n         *\n         * @param zoomMode\n         */\n        getImageVerticeCoords: function(zoomMode) {\n            var angleInRadians = -1 * ((this.hasOrientationChanged() ? 90 : 0) + this.imageStraightenAngle) * (Math.PI / 180);\n\n            var imageDimensions = this.getScaledImageDimensions();\n\n            var ratio;\n\n            if (typeof zoomMode === \"number\") {\n                ratio = zoomMode;\n            } else if (zoomMode === \"cover\") {\n                ratio = this.getZoomToCoverRatio(imageDimensions);\n            } else {\n                ratio = this.getZoomToFitRatio(imageDimensions);\n            }\n\n            // Get the dimensions of the scaled image\n            var scaledHeight = imageDimensions.height * ratio;\n            var scaledWidth = imageDimensions.width * ratio;\n\n            // Calculate the segments of the containing box for the image.\n            // When referring to top/bottom or right/left segments, these are on the\n            // right-side and bottom projection of the containing box for the zoomed out image.\n            var topVerticalSegment = Math.cos(angleInRadians) * scaledHeight;\n            var bottomVerticalSegment = Math.sin(angleInRadians) * scaledWidth;\n            var rightHorizontalSegment = Math.cos(angleInRadians) * scaledWidth;\n            var leftHorizontalSegment = Math.sin(angleInRadians) * scaledHeight;\n\n            // Calculate the offsets from editor box for the image-containing box\n            var verticalOffset = (this.editorHeight - (topVerticalSegment + bottomVerticalSegment)) / 2;\n            var horizontalOffset = (this.editorWidth - (leftHorizontalSegment + rightHorizontalSegment)) / 2;\n\n            // Finally, calculate the image vertice coordinates\n            return {\n                a: {\n                    x: horizontalOffset + rightHorizontalSegment,\n                    y: verticalOffset\n                },\n                b: {\n                    x: this.editorWidth - horizontalOffset,\n                    y: verticalOffset + topVerticalSegment\n                },\n                c: {\n                    x: horizontalOffset + leftHorizontalSegment,\n                    y: this.editorHeight - verticalOffset\n                },\n                d: {\n                    x: horizontalOffset,\n                    y: verticalOffset + bottomVerticalSegment\n                }\n            };\n        },\n\n        /**\n         * Debug stuff by continuously rendering a fabric object on canvas.\n         *\n         * @param fabricObj\n         */\n        _debug: function(fabricObj) {\n            this.canvas.remove(this.debugger);\n            this.debugger = fabricObj;\n            this.canvas.add(this.debugger);\n        },\n\n        /**\n         * Given an array of points in the form of {x: int, y:int} and a rectangle in the form of\n         * {a:{x:int, y:int}, b:{x:int, y:int}, c:{x:int, y:int}} (the fourth vertice is unnecessary)\n         * return true if the point is in the rectangle.\n         *\n         * Adapted from: http://stackoverflow.com/a/2763387/2040791\n         *\n         * @param points\n         * @param rectangle\n         */\n        arePointsInsideRectangle: function(points, rectangle) {\n\n            // Pre-calculate the vectors and scalar products for two rectangle edges\n            var ab = this._getVector(rectangle.a, rectangle.b);\n            var bc = this._getVector(rectangle.b, rectangle.c);\n            var scalarAbAb = this._getScalarProduct(ab, ab);\n            var scalarBcBc = this._getScalarProduct(bc, bc);\n\n            for (var i = 0; i < points.length; i++) {\n                var point = points[i];\n\n                // Calculate the vectors for two rectangle sides and for\n                // the vector from vertices a and b to the point P\n                var ap = this._getVector(rectangle.a, point);\n                var bp = this._getVector(rectangle.b, point);\n\n                // Calculate scalar or dot products for some vector combinations\n                var scalarAbAp = this._getScalarProduct(ab, ap);\n                var scalarBcBp = this._getScalarProduct(bc, bp);\n\n                var projectsOnAB = 0 <= scalarAbAp && scalarAbAp <= scalarAbAb;\n                var projectsOnBC = 0 <= scalarBcBp && scalarBcBp <= scalarBcBc;\n\n                if (!(projectsOnAB && projectsOnBC)) {\n                    return false;\n                }\n            }\n\n            return true;\n        },\n\n        /**\n         * Returns an object representing the vector between points a and b.\n         *\n         * @param a\n         * @param b\n         */\n        _getVector: function(a, b) {\n            return {x: b.x - a.x, y: b.y - a.y};\n        },\n\n        /**\n         * Returns the scalar product of two vectors\n         *\n         * @param a\n         * @param b\n         */\n        _getScalarProduct: function(a, b) {\n            return a.x * b.x + a.y * b.y;\n        },\n\n        /**\n         * Returns the magnitude of a vector.\n         *\n         * @param vector\n         */\n        _getVectorMagnitude: function(vector) {\n            return Math.sqrt(vector.x * vector.x + vector.y * vector.y);\n        },\n\n        /**\n         * Returns the angle between two vectors in degrees with two decimal points\n         *\n         * @param a\n         * @param b\n         */\n        _getAngleBetweenVectors: function(a, b) {\n            return Math.round(Math.acos(Math.min(1, this._getScalarProduct(a, b) / (this._getVectorMagnitude(a) * this._getVectorMagnitude(b)))) * 180 / Math.PI * 100) / 100;\n        },\n\n        /**\n         * Return the rectangle edge crossed by an imaginary line drawn from editor center to a vertex\n         *\n         * @param rectangle\n         * @param vertex\n         *\n         * @returns {*}\n         */\n        _getEdgeCrossed: function(rectangle, vertex) {\n            // Determine over which edge the vertex is\n            var edgePoints = [\n                [rectangle.a, rectangle.b],\n                [rectangle.b, rectangle.c],\n                [rectangle.c, rectangle.d],\n                [rectangle.d, rectangle.a]\n            ];\n\n            var centerPoint = {x: this.editorWidth / 2, y: this.editorHeight / 2};\n            var smallestDiff = 180;\n            var edgeCrossed = null;\n\n            // Test each edge\n            for (var edgeIndex = 0; edgeIndex < edgePoints.length; edgeIndex++) {\n                var edge = edgePoints[edgeIndex];\n                var toCenter = this._getVector(edge[0], centerPoint);\n                var edgeVector = this._getVector(edge[0], edge[1]);\n                var toVertex = this._getVector(edge[0], vertex);\n\n                // If the angle between toCenter/toVertex is the sum of\n                // angles between edgeVector/toCenter and edgeVector/toVertex, it means that\n                // the edgeVector is between the other two meaning that this is the offending vertex.\n                // To avoid the rounding errors, we'll take the closest match\n                var diff = Math.abs(this._getAngleBetweenVectors(toCenter, toVertex) - (this._getAngleBetweenVectors(toCenter, edgeVector) + this._getAngleBetweenVectors(edgeVector, toVertex)));\n\n                if (diff < smallestDiff) {\n                    smallestDiff = diff;\n                    edgeCrossed = edge;\n                }\n            }\n\n            return edgeCrossed;\n        },\n\n        /**\n         * Get the image bounding box by image scaled dimensions, taking ingo account the straightening angle.\n         *\n         * @param dimensions\n         */\n        _getImageBoundingBox: function(dimensions) {\n\n            var box = {};\n\n            var angleInRadians = Math.abs(this.imageStraightenAngle) * (Math.PI / 180);\n\n            var proportion = dimensions.height / dimensions.width;\n            box.height = dimensions.width * (Math.sin(angleInRadians) + Math.cos(angleInRadians) * proportion);\n            box.width = dimensions.width * (Math.cos(angleInRadians) + Math.sin(angleInRadians) * proportion);\n\n            if (this.hasOrientationChanged()) {\n                var temp = box.width;\n                box.width = box.height;\n                box.height = temp;\n            }\n\n            return box;\n        }\n    },\n    {\n        defaults: {\n            animationDuration: 100,\n            allowSavingAsNew: true,\n            onSave: $.noop,\n            allowDegreeFractions: true\n        }\n    }\n);\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Asset index class\n */\nCraft.AssetIndex = Craft.BaseElementIndex.extend(\n    {\n        $includeSubfoldersContainer: null,\n        $includeSubfoldersCheckbox: null,\n        showingIncludeSubfoldersCheckbox: false,\n\n        $uploadButton: null,\n        $uploadInput: null,\n        $progressBar: null,\n        $folders: null,\n\n        uploader: null,\n        promptHandler: null,\n        progressBar: null,\n\n        _uploadTotalFiles: 0,\n        _uploadFileProgress: {},\n        _uploadedAssetIds: [],\n        _currentUploaderSettings: {},\n\n        _assetDrag: null,\n        _folderDrag: null,\n        _expandDropTargetFolderTimeout: null,\n        _tempExpandedFolders: [],\n\n        _fileConflictTemplate: {\n            choices: [\n                {value: 'keepBoth', title: Craft.t('app', 'Keep both')},\n                {value: 'replace', title: Craft.t('app', 'Replace it')}\n            ]\n        },\n        _folderConflictTemplate: {\n            choices: [\n                {value: 'replace', title: Craft.t('app', 'Replace the folder (all existing files will be deleted)')},\n                {value: 'merge', title: Craft.t('app', 'Merge the folder (any conflicting files will be replaced)')}\n            ]\n        },\n\n        init: function(elementType, $container, settings) {\n            this.base(elementType, $container, settings);\n\n            if (this.settings.context === 'index') {\n                if (!this._folderDrag) {\n                    this._initIndexPageMode();\n                }\n\n                this.addListener(Garnish.$win, 'resize,scroll', '_positionProgressBar');\n            } else {\n                this.addListener(this.$main, 'scroll', '_positionProgressBar');\n\n                if (this.settings.modal) {\n                    this.settings.modal.on('updateSizeAndPosition', $.proxy(this, '_positionProgressBar'));\n                }\n            }\n        },\n\n        initSources: function() {\n            if (this.settings.context === 'index' && !this._folderDrag) {\n                this._initIndexPageMode();\n            }\n\n            return this.base();\n        },\n\n        initSource: function($source) {\n            this.base($source);\n\n            this._createFolderContextMenu($source);\n\n            if (this.settings.context === 'index') {\n                if (this._folderDrag && this._getSourceLevel($source) > 1) {\n                    if ($source.data('folder-id')) {\n                        this._folderDrag.addItems($source.parent());\n                    }\n                }\n\n                if (this._assetDrag) {\n                    this._assetDrag.updateDropTargets();\n                }\n            }\n        },\n\n        deinitSource: function($source) {\n            this.base($source);\n\n            // Does this source have a context menu?\n            var contextMenu = $source.data('contextmenu');\n\n            if (contextMenu) {\n                contextMenu.destroy();\n            }\n\n            if (this.settings.context === 'index') {\n                if (this._folderDrag && this._getSourceLevel($source) > 1) {\n                    this._folderDrag.removeItems($source.parent());\n                }\n\n                if (this._assetDrag) {\n                    this._assetDrag.updateDropTargets();\n                }\n            }\n        },\n\n        _getSourceLevel: function($source) {\n            return $source.parentsUntil('nav', 'ul').length;\n        },\n\n        /**\n         * Initialize the index page-specific features\n         */\n        _initIndexPageMode: function() {\n            if (this._folderDrag) {\n                return;\n            }\n\n            // Make the elements selectable\n            this.settings.selectable = true;\n            this.settings.multiSelect = true;\n\n            var onDragStartProxy = $.proxy(this, '_onDragStart'),\n                onDropTargetChangeProxy = $.proxy(this, '_onDropTargetChange');\n\n            // Asset dragging\n            // ---------------------------------------------------------------------\n\n            this._assetDrag = new Garnish.DragDrop({\n                activeDropTargetClass: 'sel',\n                helperOpacity: 0.75,\n\n                filter: $.proxy(function() {\n                    return this.view.getSelectedElements();\n                }, this),\n\n                helper: $.proxy(function($file) {\n                    return this._getFileDragHelper($file);\n                }, this),\n\n                dropTargets: $.proxy(function() {\n                    var targets = [];\n\n                    for (var i = 0; i < this.$sources.length; i++) {\n                        // Make sure it's a volume folder\n                        var $source = this.$sources.eq(i);\n                        if (!this._getFolderUidFromSourceKey($source.data('key'))) {\n                            continue;\n                        }\n                        targets.push($source);\n                    }\n\n                    return targets;\n                }, this),\n\n                onDragStart: onDragStartProxy,\n                onDropTargetChange: onDropTargetChangeProxy,\n                onDragStop: $.proxy(this, '_onFileDragStop')\n            });\n\n            // Folder dragging\n            // ---------------------------------------------------------------------\n\n            this._folderDrag = new Garnish.DragDrop(\n                {\n                    activeDropTargetClass: 'sel',\n                    helperOpacity: 0.75,\n\n                    filter: $.proxy(function() {\n                        // Return each of the selected <a>'s parent <li>s, except for top level drag attempts.\n                        var $selected = this.sourceSelect.getSelectedItems(),\n                            draggees = [];\n\n                        for (var i = 0; i < $selected.length; i++) {\n                            var $source = $selected.eq(i);\n\n                            if (!this._getFolderUidFromSourceKey($source.data('key'))) {\n                                continue;\n                            }\n\n                            if ($source.hasClass('sel') && this._getSourceLevel($source) > 1) {\n                                draggees.push($source.parent()[0]);\n                            }\n                        }\n\n                        return $(draggees);\n                    }, this),\n\n                    helper: $.proxy(function($draggeeHelper) {\n                        var $helperSidebar = $('<div class=\"sidebar\" style=\"padding-top: 0; padding-bottom: 0;\"/>'),\n                            $helperNav = $('<nav/>').appendTo($helperSidebar),\n                            $helperUl = $('<ul/>').appendTo($helperNav);\n\n                        $draggeeHelper.appendTo($helperUl).removeClass('expanded');\n                        $draggeeHelper.children('a').addClass('sel');\n\n                        // Match the style\n                        $draggeeHelper.css({\n                            'padding-top': this._folderDrag.$draggee.css('padding-top'),\n                            'padding-right': this._folderDrag.$draggee.css('padding-right'),\n                            'padding-bottom': this._folderDrag.$draggee.css('padding-bottom'),\n                            'padding-left': this._folderDrag.$draggee.css('padding-left')\n                        });\n\n                        return $helperSidebar;\n                    }, this),\n\n                    dropTargets: $.proxy(function() {\n                        var targets = [];\n\n                        // Tag the dragged folder and it's subfolders\n                        var draggedSourceIds = [];\n                        this._folderDrag.$draggee.find('a[data-key]').each(function() {\n                            draggedSourceIds.push($(this).data('key'));\n                        });\n\n                        for (var i = 0; i < this.$sources.length; i++) {\n                            // Make sure it's a volume folder and not one of the dragged folders\n                            var $source = this.$sources.eq(i),\n                                key = $source.data('key');\n\n                            if (!this._getFolderUidFromSourceKey(key)) {\n                                continue;\n                            }\n\n                            if (!Craft.inArray(key, draggedSourceIds)) {\n                                targets.push($source);\n                            }\n                        }\n\n                        return targets;\n                    }, this),\n\n                    onDragStart: onDragStartProxy,\n                    onDropTargetChange: onDropTargetChangeProxy,\n                    onDragStop: $.proxy(this, '_onFolderDragStop')\n                });\n        },\n\n        /**\n         * On file drag stop\n         */\n        _onFileDragStop: function() {\n            if (this._assetDrag.$activeDropTarget && this._assetDrag.$activeDropTarget[0] !== this.$source[0]) {\n                // Keep it selected\n                var originatingSource = this.$source;\n\n                var targetFolderId = this._assetDrag.$activeDropTarget.data('folder-id'),\n                    originalAssetIds = [];\n\n                // For each file, prepare array data.\n                for (var i = 0; i < this._assetDrag.$draggee.length; i++) {\n                    var originalAssetId = Craft.getElementInfo(this._assetDrag.$draggee[i]).id;\n\n                    originalAssetIds.push(originalAssetId);\n                }\n\n                // Are any files actually getting moved?\n                if (originalAssetIds.length) {\n                    this.setIndexBusy();\n\n                    this._positionProgressBar();\n                    this.progressBar.resetProgressBar();\n                    this.progressBar.setItemCount(originalAssetIds.length);\n                    this.progressBar.showProgressBar();\n\n\n                    // For each file to move a separate request\n                    var parameterArray = [];\n                    for (i = 0; i < originalAssetIds.length; i++) {\n                        parameterArray.push({\n                            action: 'assets/move-asset',\n                            params: {\n                                assetId: originalAssetIds[i],\n                                folderId: targetFolderId\n                            }\n                        });\n                    }\n\n                    // Define the callback for when all file moves are complete\n                    var onMoveFinish = $.proxy(function(responseArray) {\n                        this.promptHandler.resetPrompts();\n\n                        // Loop trough all the responses\n                        for (var i = 0; i < responseArray.length; i++) {\n                            var response = responseArray[i];\n\n                            // Push prompt into prompt array\n                            if (response.conflict) {\n                                this.promptHandler.addPrompt({\n                                    assetId: response.assetId,\n                                    suggestedFilename: response.suggestedFilename,\n                                    prompt: {message: response.conflict, choices: this._fileConflictTemplate.choices}\n                                });\n                            }\n\n                            if (response.error) {\n                                alert(response.error);\n                            }\n                        }\n\n                        this.setIndexAvailable();\n                        this.progressBar.hideProgressBar();\n                        var reloadIndex = false;\n\n                        var performAfterMoveActions = function() {\n                            // Select original source\n                            this.sourceSelect.selectItem(originatingSource);\n\n                            // Make sure we use the correct offset when fetching the next page\n                            this._totalVisible -= this._assetDrag.$draggee.length;\n\n                            // And remove the elements that have been moved away\n                            for (var i = 0; i < originalAssetIds.length; i++) {\n                                $('[data-id=' + originalAssetIds[i] + ']').remove();\n                            }\n\n                            this.view.deselectAllElements();\n                            this._collapseExtraExpandedFolders(targetFolderId);\n\n                            if (reloadIndex) {\n                                this.updateElements();\n                            }\n                        };\n\n                        if (this.promptHandler.getPromptCount()) {\n                            // Define callback for completing all prompts\n                            var promptCallback = $.proxy(function(returnData) {\n                                var newParameterArray = [];\n\n                                // Loop trough all returned data and prepare a new request array\n                                for (var i = 0; i < returnData.length; i++) {\n                                    if (returnData[i].choice === 'cancel') {\n                                        reloadIndex = true;\n                                        continue;\n                                    }\n\n                                    if (returnData[i].choice === 'keepBoth') {\n                                        newParameterArray.push({\n                                            action: 'assets/move-asset',\n                                            params: {\n                                                folderId: targetFolderId,\n                                                assetId: returnData[i].assetId,\n                                                filename: returnData[i].suggestedFilename\n                                            }\n                                        });\n                                    }\n\n                                    if (returnData[i].choice === 'replace') {\n                                        newParameterArray.push({\n                                            action: 'assets/move-asset',\n                                            params: {\n                                                folderId: targetFolderId,\n                                                assetId: returnData[i].assetId,\n                                                force: true\n                                            }\n                                        });\n                                    }\n                                }\n\n                                // Nothing to do, carry on\n                                if (newParameterArray.length === 0) {\n                                    performAfterMoveActions.apply(this);\n                                }\n                                else {\n                                    // Start working\n                                    this.setIndexBusy();\n                                    this.progressBar.resetProgressBar();\n                                    this.progressBar.setItemCount(this.promptHandler.getPromptCount());\n                                    this.progressBar.showProgressBar();\n\n                                    // Move conflicting files again with resolutions now\n                                    this._performBatchRequests(newParameterArray, onMoveFinish);\n                                }\n                            }, this);\n\n                            this._assetDrag.fadeOutHelpers();\n                            this.promptHandler.showBatchPrompts(promptCallback);\n                        }\n                        else {\n                            performAfterMoveActions.apply(this);\n                            this._assetDrag.fadeOutHelpers();\n                        }\n                    }, this);\n\n                    // Initiate the file move with the built array, index of 0 and callback to use when done\n                    this._performBatchRequests(parameterArray, onMoveFinish);\n\n                    // Skip returning dragees\n                    return;\n                }\n            }\n            else {\n                // Add the .sel class back on the selected source\n                this.$source.addClass('sel');\n\n                this._collapseExtraExpandedFolders();\n            }\n\n            this._assetDrag.returnHelpersToDraggees();\n        },\n\n        /**\n         * On folder drag stop\n         */\n        _onFolderDragStop: function() {\n            // Only move if we have a valid target and we're not trying to move into our direct parent\n            if (\n                this._folderDrag.$activeDropTarget &&\n                this._folderDrag.$activeDropTarget.siblings('ul').children('li').filter(this._folderDrag.$draggee).length === 0\n            ) {\n                var targetFolderId = this._folderDrag.$activeDropTarget.data('folder-id');\n\n                this._collapseExtraExpandedFolders(targetFolderId);\n\n                // Get the old folder IDs, and sort them so that we're moving the most-nested folders first\n                var folderIds = [];\n\n                for (var i = 0; i < this._folderDrag.$draggee.length; i++) {\n                    var $a = this._folderDrag.$draggee.eq(i).children('a'),\n                        folderId = $a.data('folder-id');\n\n                    // Make sure it's not already in the target folder and use this single folder Id.\n                    if (folderId != targetFolderId) {\n                        folderIds.push(folderId);\n                        break;\n                    }\n                }\n\n                if (folderIds.length) {\n                    folderIds.sort();\n                    folderIds.reverse();\n\n                    this.setIndexBusy();\n                    this._positionProgressBar();\n                    this.progressBar.resetProgressBar();\n                    this.progressBar.setItemCount(folderIds.length);\n                    this.progressBar.showProgressBar();\n\n                    var parameterArray = [];\n\n                    for (i = 0; i < folderIds.length; i++) {\n                        parameterArray.push({\n                            action: 'assets/move-folder',\n                            params: {\n                                folderId: folderIds[i],\n                                parentId: targetFolderId\n                            }\n                        });\n                    }\n\n                    // Increment, so to avoid displaying folder files that are being moved\n                    this.requestId++;\n\n                    /*\n                     Here's the rundown:\n                     1) Send all the folders being moved\n                     2) Get results:\n                     a) For all conflicting, receive prompts and resolve them to get:\n                     b) For all valid move operations: by now server has created the needed folders\n                     in target destination. Server returns an array of file move operations\n                     c) server also returns a list of all the folder id changes\n                     d) and the data-id of node to be removed, in case of conflict\n                     e) and a list of folders to delete after the move\n                     3) From data in 2) build a large file move operation array\n                     4) Create a request loop based on this, so we can display progress bar\n                     5) when done, delete all the folders and perform other maintenance\n                     6) Champagne\n                     */\n\n                    // This will hold the final list of files to move\n                    var fileMoveList = [];\n\n                    var newSourceKey = '';\n\n                    var onMoveFinish = function(responseArray) {\n                        this.promptHandler.resetPrompts();\n\n                        // Loop trough all the responses\n                        for (var i = 0; i < responseArray.length; i++) {\n                            var data = responseArray[i];\n\n                            // If successful and have data, then update\n                            if (data.success) {\n                                if (data.transferList) {\n                                    fileMoveList = data.transferList;\n                                }\n\n                                if (data.newFolderId) {\n                                    newSourceKey = this._folderDrag.$activeDropTarget.data('key') + '/folder:' + data.newFolderUid;\n                                }\n                            }\n\n                            // Push prompt into prompt array\n                            if (data.conflict) {\n                                data.prompt = {\n                                    message: data.conflict,\n                                    choices: this._folderConflictTemplate.choices\n                                };\n\n                                this.promptHandler.addPrompt(data);\n                            }\n\n                            if (data.error) {\n                                alert(data.error);\n                            }\n                        }\n\n                        if (this.promptHandler.getPromptCount()) {\n                            // Define callback for completing all prompts\n                            var promptCallback = $.proxy(function(returnData) {\n                                this.promptHandler.resetPrompts();\n\n                                var newParameterArray = [];\n\n                                var params = {};\n                                // Loop trough all returned data and prepare a new request array\n                                for (var i = 0; i < returnData.length; i++) {\n                                    if (returnData[i].choice === 'cancel') {\n                                        continue;\n                                    }\n\n                                    if (returnData[i].choice === 'replace') {\n                                        params.force = true;\n                                    }\n\n                                    if (returnData[i].choice === 'merge') {\n                                        params.merge = true;\n                                    }\n\n                                    params.folderId = data.folderId;\n                                    params.parentId = data.parentId;\n\n                                    newParameterArray.push({\n                                        action: 'assets/move-folder',\n                                        params: params\n                                    });\n                                }\n\n                                // Start working on them lists, baby\n                                if (newParameterArray.length === 0) {\n                                    $.proxy(this, '_performActualFolderMove', fileMoveList, folderIds, newSourceKey)();\n                                }\n                                else {\n                                    // Start working\n                                    this.setIndexBusy();\n                                    this.progressBar.resetProgressBar();\n                                    this.progressBar.setItemCount(this.promptHandler.getPromptCount());\n                                    this.progressBar.showProgressBar();\n\n                                    this._performBatchRequests(newParameterArray, onMoveFinish);\n                                }\n                            }, this);\n\n                            this.promptHandler.showBatchPrompts(promptCallback);\n\n                            this.setIndexAvailable();\n                            this.progressBar.hideProgressBar();\n                        }\n                        else {\n                            $.proxy(this, '_performActualFolderMove', fileMoveList, folderIds, newSourceKey)();\n                        }\n                    }.bind(this);\n\n                    // Initiate the folder move with the built array, index of 0 and callback to use when done\n                    this._performBatchRequests(parameterArray, onMoveFinish);\n\n                    // Skip returning dragees until we get the Ajax response\n                    return;\n                }\n            }\n            else {\n                // Add the .sel class back on the selected source\n                this.$source.addClass('sel');\n\n                this._collapseExtraExpandedFolders();\n            }\n\n            this._folderDrag.returnHelpersToDraggees();\n        },\n\n        /**\n         * Really move the folder. Like really. For real.\n         */\n        _performActualFolderMove: function(fileMoveList, folderDeleteList, newSourceKey) {\n            this.setIndexBusy();\n            this.progressBar.resetProgressBar();\n            this.progressBar.setItemCount(1);\n            this.progressBar.showProgressBar();\n\n            var moveCallback = function(folderDeleteList) {\n                // Delete the old folders\n                var counter = 0;\n                var limit = folderDeleteList.length;\n                for (var i = 0; i < folderDeleteList.length; i++) {\n                    // When all folders are deleted, reload the sources.\n                    Craft.postActionRequest('assets/delete-folder', {folderId: folderDeleteList[i]}, function() {\n                        if (++counter === limit) {\n                            this.setIndexAvailable();\n                            this.progressBar.hideProgressBar();\n                            this._folderDrag.returnHelpersToDraggees();\n                            this.setInstanceState('selectedSource', newSourceKey);\n                            this.refreshSources();\n                        }\n                    }.bind(this));\n                }\n            }.bind(this);\n\n\n            if (fileMoveList.length > 0) {\n                var parameterArray =[];\n\n                for (var i = 0; i < fileMoveList.length; i++) {\n                    parameterArray.push({\n                        action: 'assets/move-asset',\n                        params: fileMoveList[i]\n                    });\n\n                }\n                this._performBatchRequests(parameterArray, function() {\n                    moveCallback(folderDeleteList);\n                });\n            }\n            else {\n                moveCallback(folderDeleteList);\n            }\n        },\n\n        /**\n         * Get parent source for a source.\n         *\n         * @param $source\n         * @returns {*}\n         * @private\n         */\n        _getParentSource: function($source) {\n            if (this._getSourceLevel($source) > 1) {\n                return $source.parent().parent().siblings('a');\n            }\n        },\n\n        _selectSourceByFolderId: function(targetFolderId) {\n            var $targetSource = this._getSourceByKey(targetFolderId);\n\n            // Make sure that all the parent sources are expanded and this source is visible.\n            var $parentSources = $targetSource.parent().parents('li');\n\n            for (var i = 0; i < $parentSources.length; i++) {\n                var $parentSource = $($parentSources[i]);\n\n                if (!$parentSource.hasClass('expanded')) {\n                    $parentSource.children('.toggle').trigger('click');\n                }\n            }\n\n            this.selectSource($targetSource);\n            this.updateElements();\n        },\n\n        /**\n         * Initialize the uploader.\n         *\n         * @private\n         */\n        afterInit: function() {\n            if (!this.$uploadButton) {\n                this.$uploadButton = $('<div class=\"btn submit\" data-icon=\"upload\" style=\"position: relative; overflow: hidden;\" role=\"button\">' + Craft.t('app', 'Upload files') + '</div>');\n                this.addButton(this.$uploadButton);\n\n                this.$uploadInput = $('<input type=\"file\" multiple=\"multiple\" name=\"assets-upload\" />').hide().insertBefore(this.$uploadButton);\n            }\n\n            this.promptHandler = new Craft.PromptHandler();\n            this.progressBar = new Craft.ProgressBar(this.$main, true);\n\n            var options = {\n                url: Craft.getActionUrl('assets/save-asset'),\n                fileInput: this.$uploadInput,\n                dropZone: this.$container\n            };\n\n            options.events = {\n                fileuploadstart: $.proxy(this, '_onUploadStart'),\n                fileuploadprogressall: $.proxy(this, '_onUploadProgress'),\n                fileuploaddone: $.proxy(this, '_onUploadComplete')\n            };\n\n            if (this.settings.criteria && typeof this.settings.criteria.kind !== 'undefined') {\n                options.allowedKinds = this.settings.criteria.kind;\n            }\n\n            this._currentUploaderSettings = options;\n\n            this.uploader = new Craft.Uploader(this.$uploadButton, options);\n\n            this.$uploadButton.on('click', $.proxy(function() {\n                if (this.$uploadButton.hasClass('disabled')) {\n                    return;\n                }\n                if (!this.isIndexBusy) {\n                    this.$uploadButton.parent().find('input[name=assets-upload]').trigger('click');\n                }\n            }, this));\n\n            this.base();\n        },\n\n        onSelectSource: function() {\n            var $source = this._getSourceByKey(this.sourceKey);\n            var folderId = $source.data('folder-id');\n\n            if (folderId && this.$source.attr('data-upload')) {\n                this.uploader.setParams({\n                    folderId: this.$source.attr('data-folder-id')\n                });\n                this.$uploadButton.removeClass('disabled');\n            } else {\n                this.$uploadButton.addClass('disabled');\n            }\n\n            this.base();\n        },\n\n        _getFolderUidFromSourceKey: function(sourceKey) {\n            var m = sourceKey.match(/\\bfolder:([0-9a-f\\-]+)$/);\n\n            return m ? m[1] : null;\n        },\n\n        startSearching: function() {\n            // Does this source have subfolders?\n            if (this.$source.siblings('ul').length) {\n                if (this.$includeSubfoldersContainer === null) {\n                    var id = 'includeSubfolders-' + Math.floor(Math.random() * 1000000000);\n\n                    this.$includeSubfoldersContainer = $('<div style=\"margin-bottom: -23px; opacity: 0;\"/>').insertAfter(this.$search);\n                    var $subContainer = $('<div style=\"padding-top: 5px;\"/>').appendTo(this.$includeSubfoldersContainer);\n                    this.$includeSubfoldersCheckbox = $('<input type=\"checkbox\" id=\"' + id + '\" class=\"checkbox\"/>').appendTo($subContainer);\n                    $('<label class=\"light smalltext\" for=\"' + id + '\"/>').text(' ' + Craft.t('app', 'Search in subfolders')).appendTo($subContainer);\n\n                    this.addListener(this.$includeSubfoldersCheckbox, 'change', function() {\n                        this.setSelecetedSourceState('includeSubfolders', this.$includeSubfoldersCheckbox.prop('checked'));\n                        this.updateElements();\n                    });\n                }\n                else {\n                    this.$includeSubfoldersContainer.velocity('stop');\n                }\n\n                var checked = this.getSelectedSourceState('includeSubfolders', false);\n                this.$includeSubfoldersCheckbox.prop('checked', checked);\n\n                this.$includeSubfoldersContainer.velocity({\n                    marginBottom: 0,\n                    opacity: 1\n                }, 'fast');\n\n                this.showingIncludeSubfoldersCheckbox = true;\n            }\n\n            this.base();\n        },\n\n        stopSearching: function() {\n            if (this.showingIncludeSubfoldersCheckbox) {\n                this.$includeSubfoldersContainer.velocity('stop');\n\n                this.$includeSubfoldersContainer.velocity({\n                    marginBottom: -23,\n                    opacity: 0\n                }, 'fast');\n\n                this.showingIncludeSubfoldersCheckbox = false;\n            }\n\n            this.base();\n        },\n\n        getViewParams: function() {\n            var data = this.base();\n\n            if (this.showingIncludeSubfoldersCheckbox && this.$includeSubfoldersCheckbox.prop('checked')) {\n                data.criteria.includeSubfolders = true;\n            }\n\n            return data;\n        },\n\n        /**\n         * React on upload submit.\n         *\n         * @private\n         */\n        _onUploadStart: function() {\n            this.setIndexBusy();\n\n            // Initial values\n            this._positionProgressBar();\n            this.progressBar.resetProgressBar();\n            this.progressBar.showProgressBar();\n\n            this.promptHandler.resetPrompts();\n        },\n\n        /**\n         * Update uploaded byte count.\n         */\n        _onUploadProgress: function(event, data) {\n            var progress = parseInt(data.loaded / data.total * 100, 10);\n            this.progressBar.setProgressPercentage(progress);\n        },\n\n        /**\n         * On Upload Complete.\n         */\n        _onUploadComplete: function(event, data) {\n            var response = data.result;\n            var filename = data.files[0].name;\n\n            var doReload = true;\n\n            if (response.success || response.conflict) {\n                // Add the uploaded file to the selected ones, if appropriate\n                this._uploadedAssetIds.push(response.assetId);\n\n                // If there is a prompt, add it to the queue\n                if (response.conflict) {\n                    response.prompt =  {\n                        message: Craft.t('app', response.conflict, {file: response.filename}),\n                        choices: this._fileConflictTemplate.choices\n                    };\n\n                    this.promptHandler.addPrompt(response);\n                }\n\n                Craft.cp.runQueue();\n            }\n            else {\n                if (response.error) {\n                    alert(Craft.t('app', 'Upload failed. The error message was: \u201c{error}\u201d', {error: response.error}));\n                }\n                else {\n                    alert(Craft.t('app', 'Upload failed for {filename}.', {filename: filename}));\n                }\n\n                doReload = false;\n            }\n\n            // For the last file, display prompts, if any. If not - just update the element view.\n            if (this.uploader.isLastUpload()) {\n                this.setIndexAvailable();\n                this.progressBar.hideProgressBar();\n\n                if (this.promptHandler.getPromptCount()) {\n                    this.promptHandler.showBatchPrompts($.proxy(this, '_uploadFollowup'));\n                }\n                else {\n                    if (doReload) {\n                        this._updateAfterUpload();\n                    }\n                }\n            }\n        },\n\n        /**\n         * Update the elements after an upload, setting sort to dateModified descending, if not using index.\n         * \n         * @private\n         */\n        _updateAfterUpload: function () {\n            if (this.settings.context !== 'index') {\n                this.setSortAttribute('dateModified');\n                this.setSortDirection('desc');\n            }\n            this.updateElements();\n        },\n\n        /**\n         * Follow up to an upload that triggered at least one conflict resolution prompt.\n         *\n         * @param returnData\n         * @private\n         */\n        _uploadFollowup: function(returnData) {\n            this.setIndexBusy();\n            this.progressBar.resetProgressBar();\n\n            this.promptHandler.resetPrompts();\n\n            var finalCallback = function() {\n                this.setIndexAvailable();\n                this.progressBar.hideProgressBar();\n                this._updateAfterUpload();\n            }.bind(this);\n\n            this.progressBar.setItemCount(returnData.length);\n\n            var doFollowup = function(parameterArray, parameterIndex, callback) {\n                var postData = {};\n                var action = null;\n\n                var followupCallback = function (data, textStatus) {\n                    if (textStatus === 'success' && data.assetId) {\n                        this._uploadedAssetIds.push(data.assetId);\n                    } else if (data.error) {\n                        alert(data.error);\n                    }\n                    parameterIndex++;\n                    this.progressBar.incrementProcessedItemCount(1);\n                    this.progressBar.updateProgressBar();\n\n                    if (parameterIndex === parameterArray.length) {\n                        callback();\n                    }\n                    else {\n                        doFollowup(parameterArray, parameterIndex, callback);\n                    }\n\n                }.bind(this);\n\n                if (parameterArray[parameterIndex].choice === 'replace') {\n                    action = 'assets/replace-file';\n                    postData.sourceAssetId = parameterArray[parameterIndex].assetId;\n\n                    if (parameterArray[parameterIndex].conflictingAssetId) {\n                        postData.assetId = parameterArray[parameterIndex].conflictingAssetId;\n                    } else {\n                        postData.targetFilename = parameterArray[parameterIndex].filename;\n                    }\n                } else if (parameterArray[parameterIndex].choice === 'cancel') {\n                    action = 'assets/delete-asset';\n                    postData.assetId = parameterArray[parameterIndex].assetId;\n                }\n\n                if (!action) {\n                    // We don't really need to do another request, so let's pretend that already happened\n                    followupCallback({assetId: parameterArray[parameterIndex].assetId}, 'success');\n                } else {\n                    Craft.postActionRequest(action, postData, followupCallback);\n                }\n            }.bind(this);\n\n            this.progressBar.showProgressBar();\n            doFollowup(returnData, 0, finalCallback);\n        },\n\n        /**\n         * Perform actions after updating elements\n         * @private\n         */\n        onUpdateElements: function() {\n            this._onUpdateElements(false, this.view.getAllElements());\n            this.view.on('appendElements', $.proxy(function(ev) {\n                this._onUpdateElements(true, ev.newElements);\n            }, this));\n\n            this.base();\n        },\n\n        /**\n         * Do the after-update initializations\n         * @private\n         */\n        _onUpdateElements: function(append, $newElements) {\n            if (this.settings.context === 'index') {\n                if (!append) {\n                    this._assetDrag.removeAllItems();\n                }\n\n                this._assetDrag.addItems($newElements);\n            }\n\n            // See if we have freshly uploaded files to add to selection\n            if (this._uploadedAssetIds.length) {\n                if (this.view.settings.selectable) {\n                    for (var i = 0; i < this._uploadedAssetIds.length; i++) {\n                        this.view.selectElementById(this._uploadedAssetIds[i]);\n                    }\n                }\n\n                // Reset the list.\n                this._uploadedAssetIds = [];\n            }\n\n            this.base(append, $newElements);\n\n            this.removeListener(this.$elements, 'keydown');\n            this.addListener(this.$elements, 'keydown', this._onKeyDown.bind(this));\n            this.view.elementSelect.on('focusItem', this._onElementFocus.bind(this));\n        },\n\n        /**\n         * Handle a keypress\n         * @private\n         */\n        _onKeyDown: function(ev) {\n            if (ev.keyCode === Garnish.SPACE_KEY && ev.shiftKey) {\n                if (Craft.PreviewFileModal.openInstance) {\n                    Craft.PreviewFileModal.openInstance.selfDestruct();\n                } else {\n                    var $element = this.view.elementSelect.$focusedItem.find('.element');\n\n                    if ($element.length) {\n                        this._loadPreview($element);\n                    }\n                }\n\n                ev.stopPropagation();\n                return false;\n            }\n        },\n\n        /**\n         * Handle element being focused\n         * @private\n         */\n        _onElementFocus: function (ev) {\n            var $element = $(ev.item).find('.element');\n\n            if (Craft.PreviewFileModal.openInstance && $element.length) {\n                this._loadPreview($element);\n            }\n        },\n\n        /**\n         * Load the preview for an Asset element\n         * @private\n         */\n        _loadPreview: function($element) {\n            var settings = {};\n\n            if ($element.data('image-width')) {\n                settings.startingWidth = $element.data('image-width');\n                settings.startingHeight = $element.data('image-height');\n            }\n\n            new Craft.PreviewFileModal($element.data('id'), this.view.elementSelect, settings);\n        },\n\n        /**\n         * On Drag Start\n         */\n        _onDragStart: function() {\n            this._tempExpandedFolders = [];\n        },\n\n        /**\n         * Get File Drag Helper\n         */\n        _getFileDragHelper: function($element) {\n            var currentView = this.getSelectedSourceState('mode');\n            var $outerContainer;\n            var $innerContainer;\n\n            switch (currentView) {\n                case 'table': {\n                    $outerContainer = $('<div class=\"elements datatablesorthelper\"/>').appendTo(Garnish.$bod);\n                    $innerContainer = $('<div class=\"tableview\"/>').appendTo($outerContainer);\n                    var $table = $('<table class=\"data\"/>').appendTo($innerContainer);\n                    var $tbody = $('<tbody/>').appendTo($table);\n\n                    $element.appendTo($tbody);\n\n                    // Copy the column widths\n                    this._$firstRowCells = this.view.$table.children('tbody').children('tr:first').children();\n                    var $helperCells = $element.children();\n\n                    for (var i = 0; i < $helperCells.length; i++) {\n                        // Hard-set the cell widths\n                        var $helperCell = $($helperCells[i]);\n\n                        // Skip the checkbox cell\n                        if ($helperCell.hasClass('checkbox-cell')) {\n                            $helperCell.remove();\n                            $outerContainer.css('margin-' + Craft.left, 19); // 26 - 7\n                            continue;\n                        }\n\n                        var $firstRowCell = $(this._$firstRowCells[i]),\n                            width = $firstRowCell.width();\n\n                        $firstRowCell.width(width);\n                        $helperCell.width(width);\n                    }\n\n                    return $outerContainer;\n                }\n                case 'thumbs': {\n                    $outerContainer = $('<div class=\"elements thumbviewhelper\"/>').appendTo(Garnish.$bod);\n                    $innerContainer = $('<ul class=\"thumbsview\"/>').appendTo($outerContainer);\n\n                    $element.appendTo($innerContainer);\n\n                    return $outerContainer;\n                }\n            }\n\n            return $();\n        },\n\n        /**\n         * On Drop Target Change\n         */\n        _onDropTargetChange: function($dropTarget) {\n            clearTimeout(this._expandDropTargetFolderTimeout);\n\n            if ($dropTarget) {\n                var folderId = $dropTarget.data('folder-id');\n\n                if (folderId) {\n                    this.dropTargetFolder = this._getSourceByKey(folderId);\n\n                    if (this._hasSubfolders(this.dropTargetFolder) && !this._isExpanded(this.dropTargetFolder)) {\n                        this._expandDropTargetFolderTimeout = setTimeout($.proxy(this, '_expandFolder'), 500);\n                    }\n                }\n                else {\n                    this.dropTargetFolder = null;\n                }\n            }\n\n            if ($dropTarget && $dropTarget[0] !== this.$source[0]) {\n                // Temporarily remove the .sel class on the active source\n                this.$source.removeClass('sel');\n            }\n            else {\n                this.$source.addClass('sel');\n            }\n        },\n\n        /**\n         * Collapse Extra Expanded Folders\n         */\n        _collapseExtraExpandedFolders: function(dropTargetFolderId) {\n            clearTimeout(this._expandDropTargetFolderTimeout);\n\n            // If a source ID is passed in, exclude its parents\n            var $excludedSources;\n\n            if (dropTargetFolderId) {\n                $excludedSources = this._getSourceByKey(dropTargetFolderId).parents('li').children('a');\n            }\n\n            for (var i = this._tempExpandedFolders.length - 1; i >= 0; i--) {\n                var $source = this._tempExpandedFolders[i];\n\n                // Check the parent list, if a source id is passed in\n                if (typeof $excludedSources === 'undefined' || $excludedSources.filter('[data-key=\"' + $source.data('key') + '\"]').length === 0) {\n                    this._collapseFolder($source);\n                    this._tempExpandedFolders.splice(i, 1);\n                }\n            }\n        },\n\n        _getSourceByKey: function(key) {\n            return this.$sources.filter('[data-key$=\"' + key + '\"]');\n        },\n\n        _hasSubfolders: function($source) {\n            return $source.siblings('ul').find('li').length;\n        },\n\n        _isExpanded: function($source) {\n            return $source.parent('li').hasClass('expanded');\n        },\n\n        _expandFolder: function() {\n            // Collapse any temp-expanded drop targets that aren't parents of this one\n            this._collapseExtraExpandedFolders(this.dropTargetFolder.data('folder-id'));\n\n            this.dropTargetFolder.siblings('.toggle').trigger('click');\n\n            // Keep a record of that\n            this._tempExpandedFolders.push(this.dropTargetFolder);\n        },\n\n        _collapseFolder: function($source) {\n            if ($source.parent().hasClass('expanded')) {\n                $source.siblings('.toggle').trigger('click');\n            }\n        },\n\n        _createFolderContextMenu: function($source) {\n            // Make sure it's a volume folder\n            if (!this._getFolderUidFromSourceKey($source.data('key'))) {\n                return;\n            }\n\n            var menuOptions = [{label: Craft.t('app', 'New subfolder'), onClick: $.proxy(this, '_createSubfolder', $source)}];\n\n            // For all folders that are not top folders\n            if (this.settings.context === 'index' && this._getSourceLevel($source) > 1) {\n                menuOptions.push({label: Craft.t('app', 'Rename folder'), onClick: $.proxy(this, '_renameFolder', $source)});\n                menuOptions.push({label: Craft.t('app', 'Delete folder'), onClick: $.proxy(this, '_deleteFolder', $source)});\n            }\n\n            new Garnish.ContextMenu($source, menuOptions, {menuClass: 'menu'});\n        },\n\n        _createSubfolder: function($parentFolder) {\n            var subfolderName = prompt(Craft.t('app', 'Enter the name of the folder'));\n\n            if (subfolderName) {\n                var params = {\n                    parentId: $parentFolder.data('folder-id'),\n                    folderName: subfolderName\n                };\n\n                this.setIndexBusy();\n\n                Craft.postActionRequest('assets/create-folder', params, $.proxy(function(data, textStatus) {\n                    this.setIndexAvailable();\n\n                    if (textStatus === 'success' && data.success) {\n                        this._prepareParentForChildren($parentFolder);\n\n                        var $subfolder = $(\n                            '<li>' +\n                            '<a data-key=\"' + $parentFolder.data('key') + '/folder:' + data.folderUid + '\"' +\n                            (Garnish.hasAttr($parentFolder, 'data-has-thumbs') ? ' data-has-thumbs' : '') +\n                            ' data-upload=\"' + $parentFolder.attr('data-upload') + '\"' +\n                            ' data-folder-id=\"' + data.folderId + '\"' +\n                            '>' +\n                            data.folderName +\n                            '</a>' +\n                            '</li>'\n                        );\n\n                        var $a = $subfolder.children('a:first');\n                        this._appendSubfolder($parentFolder, $subfolder);\n                        this.initSource($a);\n                    }\n\n                    if (textStatus === 'success' && data.error) {\n                        alert(data.error);\n                    }\n                }, this));\n            }\n        },\n\n        _deleteFolder: function($targetFolder) {\n            if (confirm(Craft.t('app', 'Really delete folder \u201c{folder}\u201d?', {folder: $.trim($targetFolder.text())}))) {\n                var params = {\n                    folderId: $targetFolder.data('folder-id')\n                };\n\n                this.setIndexBusy();\n\n                Craft.postActionRequest('assets/delete-folder', params, $.proxy(function(data, textStatus) {\n                    this.setIndexAvailable();\n\n                    if (textStatus === 'success' && data.success) {\n                        var $parentFolder = this._getParentSource($targetFolder);\n\n                        // Remove folder and any trace from its parent, if needed\n                        this.deinitSource($targetFolder);\n\n                        $targetFolder.parent().remove();\n                        this._cleanUpTree($parentFolder);\n                    }\n\n                    if (textStatus === 'success' && data.error) {\n                        alert(data.error);\n                    }\n                }, this));\n            }\n        },\n\n        /**\n         * Rename\n         */\n        _renameFolder: function($targetFolder) {\n            var oldName = $.trim($targetFolder.text()),\n                newName = prompt(Craft.t('app', 'Rename folder'), oldName);\n\n            if (newName && newName !== oldName) {\n                var params = {\n                    folderId: $targetFolder.data('folder-id'),\n                    newName: newName\n                };\n\n                this.setIndexBusy();\n\n                Craft.postActionRequest('assets/rename-folder', params, $.proxy(function(data, textStatus) {\n                    this.setIndexAvailable();\n\n                    if (textStatus === 'success' && data.success) {\n                        $targetFolder.text(data.newName);\n\n                        // If the current folder was renamed.\n                        if (this._getFolderUidFromSourceKey(this.sourceSelect.$selectedItems.data('key')) === this._getFolderUidFromSourceKey($targetFolder.data('key'))) {\n                            this.updateElements();\n                        }\n                    }\n\n                    if (textStatus === 'success' && data.error) {\n                        alert(data.error);\n                    }\n\n                }, this), 'json');\n            }\n        },\n\n        /**\n         * Prepare a source folder for children folder.\n         *\n         * @param $parentFolder\n         * @private\n         */\n        _prepareParentForChildren: function($parentFolder) {\n            if (!this._hasSubfolders($parentFolder)) {\n                $parentFolder.parent().addClass('expanded').append('<div class=\"toggle\"></div><ul></ul>');\n                this.initSourceToggle($parentFolder);\n            }\n        },\n\n        /**\n         * Appends a subfolder to the parent folder at the correct spot.\n         *\n         * @param $parentFolder\n         * @param $subfolder\n         * @private\n         */\n        _appendSubfolder: function($parentFolder, $subfolder) {\n            var $subfolderList = $parentFolder.siblings('ul'),\n                $existingChildren = $subfolderList.children('li'),\n                subfolderLabel = $.trim($subfolder.children('a:first').text()),\n                folderInserted = false;\n\n            for (var i = 0; i < $existingChildren.length; i++) {\n                var $existingChild = $($existingChildren[i]);\n\n                if ($.trim($existingChild.children('a:first').text()) > subfolderLabel) {\n                    $existingChild.before($subfolder);\n                    folderInserted = true;\n                    break;\n                }\n            }\n\n            if (!folderInserted) {\n                $parentFolder.siblings('ul').append($subfolder);\n            }\n        },\n\n        _cleanUpTree: function($parentFolder) {\n            if ($parentFolder !== null && $parentFolder.siblings('ul').children('li').length === 0) {\n                this.deinitSourceToggle($parentFolder);\n                $parentFolder.siblings('ul').remove();\n                $parentFolder.siblings('.toggle').remove();\n                $parentFolder.parent().removeClass('expanded');\n            }\n        },\n\n        _positionProgressBar: function() {\n            if (!this.progressBar) {\n                this.progressBar = new Craft.ProgressBar(this.$main, true);\n            }\n\n            var $container = $(),\n                scrollTop = 0,\n                offset = 0;\n\n            if (this.settings.context === 'index') {\n                $container = this.progressBar.$progressBar.closest('#content');\n                scrollTop = Garnish.$win.scrollTop();\n            } else {\n                $container = this.progressBar.$progressBar.closest('.main');\n                scrollTop = this.$main.scrollTop();\n            }\n\n            var containerTop = $container.offset().top;\n            var diff = scrollTop - containerTop;\n            var windowHeight = Garnish.$win.height();\n\n            if ($container.height() > windowHeight) {\n                offset = (windowHeight / 2) - 6 + diff;\n            } else {\n                offset = ($container.height() / 2) - 6;\n            }\n\n            if (this.settings.context !== 'index') {\n                offset = scrollTop + (($container.height() / 2) - 6);\n            }\n\n            this.progressBar.$progressBar.css({\n                top: offset\n            });\n        },\n\n        _performBatchRequests: function(parameterArray, finalCallback) {\n\n            var responseArray = [];\n\n            var doRequest = function (parameters) {\n                Craft.postActionRequest(parameters.action, parameters.params, function (data, textStatus) {\n                    this.progressBar.incrementProcessedItemCount(1);\n                    this.progressBar.updateProgressBar();\n\n                    if (textStatus === 'success') {\n                        responseArray.push(data);\n\n                        // If assets were just merged we should get the reference tags updated right away\n                        Craft.cp.runQueue();\n                    }\n\n                    if (responseArray.length >= parameterArray.length) {\n                        finalCallback(responseArray);\n                    }\n                }.bind(this));\n            }.bind(this);\n\n            for (var i = 0; i < parameterArray.length; i++) {\n                doRequest(parameterArray[i]);\n            }\n        }\n\n    });\n\n// Register it!\nCraft.registerElementIndexClass('craft\\\\elements\\\\Asset', Craft.AssetIndex);\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Asset Select input\n */\nCraft.AssetSelectInput = Craft.BaseElementSelectInput.extend(\n    {\n        requestId: 0,\n        hud: null,\n        uploader: null,\n        progressBar: null,\n\n        originalFilename: '',\n        originalExtension: '',\n\n        init: function() {\n            if (arguments.length > 0 && typeof arguments[0] === 'object') {\n                arguments[0].editorSettings = {\n                    onShowHud: $.proxy(this.resetOriginalFilename, this),\n                    onCreateForm: $.proxy(this._renameHelper, this),\n                    validators: [$.proxy(this.validateElementForm, this)]\n                };\n            }\n\n            this.base.apply(this, arguments);\n            this._attachUploader();\n\n            this.addListener(this.$elementsContainer, 'keydown', this._onKeyDown.bind(this));\n            this.elementSelect.on('focusItem', this._onElementFocus.bind(this));\n        },\n\n        /**\n         * Handle a keypress\n         * @private\n         */\n        _onKeyDown: function(ev) {\n            if (ev.keyCode === Garnish.SPACE_KEY && ev.shiftKey) {\n                if (Craft.PreviewFileModal.openInstance) {\n                    Craft.PreviewFileModal.openInstance.selfDestruct();\n                } else {\n                    var $element = this.elementSelect.$focusedItem;\n\n                    if ($element.length) {\n                        this._loadPreview($element);\n                    }\n                }\n\n                ev.stopPropagation();\n\n                return false;\n            }\n        },\n\n        /**\n         * Handle element being focused\n         * @private\n         */\n        _onElementFocus: function(ev) {\n            var $element = $(ev.item);\n\n            if (Craft.PreviewFileModal.openInstance && $element.length) {\n                this._loadPreview($element);\n            }\n        },\n\n        /**\n         * Load the preview for an Asset element\n         * @private\n         */\n        _loadPreview: function($element) {\n            var settings = {};\n\n            if ($element.data('image-width')) {\n                settings.startingWidth = $element.data('image-width');\n                settings.startingHeight = $element.data('image-height');\n            }\n\n            new Craft.PreviewFileModal($element.data('id'), this.elementSelect, settings);\n        },\n\n        /**\n         * Create the element editor\n         */\n        createElementEditor: function($element) {\n            return this.base($element, {\n                params: {\n                    defaultFieldLayoutId: this.settings.defaultFieldLayoutId\n                }\n            });\n        },\n\n        /**\n         * Attach the uploader with drag event handler\n         */\n        _attachUploader: function() {\n            this.progressBar = new Craft.ProgressBar($('<div class=\"progress-shade\"></div>').appendTo(this.$container));\n\n            var options = {\n                url: Craft.getActionUrl('assets/save-asset'),\n                dropZone: this.$container,\n                formData: {\n                    fieldId: this.settings.fieldId,\n                    elementId: this.settings.sourceElementId\n                }\n            };\n\n            // If CSRF protection isn't enabled, these won't be defined.\n            if (typeof Craft.csrfTokenName !== 'undefined' && typeof Craft.csrfTokenValue !== 'undefined') {\n                // Add the CSRF token\n                options.formData[Craft.csrfTokenName] = Craft.csrfTokenValue;\n            }\n\n            if (typeof this.settings.criteria.kind !== 'undefined') {\n                options.allowedKinds = this.settings.criteria.kind;\n            }\n\n            options.canAddMoreFiles = $.proxy(this, 'canAddMoreFiles');\n\n            options.events = {};\n            options.events.fileuploadstart = $.proxy(this, '_onUploadStart');\n            options.events.fileuploadprogressall = $.proxy(this, '_onUploadProgress');\n            options.events.fileuploaddone = $.proxy(this, '_onUploadComplete');\n\n            this.uploader = new Craft.Uploader(this.$container, options);\n        },\n\n        /**\n         * Add the freshly uploaded file to the input field.\n         */\n        selectUploadedFile: function(element) {\n            // Check if we're able to add new elements\n            if (!this.canAddMoreElements()) {\n                return;\n            }\n\n            var $newElement = element.$element;\n\n            // Make a couple tweaks\n            $newElement.addClass('removable');\n            $newElement.prepend('<input type=\"hidden\" name=\"' + this.settings.name + '[]\" value=\"' + element.id + '\">' +\n                '<a class=\"delete icon\" title=\"' + Craft.t('app', 'Remove') + '\"></a>');\n\n            $newElement.appendTo(this.$elementsContainer);\n\n            var margin = -($newElement.outerWidth() + 10);\n\n            this.$addElementBtn.css('margin-' + Craft.left, margin + 'px');\n\n            var animateCss = {};\n            animateCss['margin-' + Craft.left] = 0;\n            this.$addElementBtn.velocity(animateCss, 'fast');\n\n            this.addElements($newElement);\n\n            delete this.modal;\n        },\n\n        /**\n         * On upload start.\n         */\n        _onUploadStart: function() {\n            this.progressBar.$progressBar.css({\n                top: Math.round(this.$container.outerHeight() / 2) - 6\n            });\n\n            this.$container.addClass('uploading');\n            this.progressBar.resetProgressBar();\n            this.progressBar.showProgressBar();\n        },\n\n        /**\n         * On upload progress.\n         */\n        _onUploadProgress: function(event, data) {\n            var progress = parseInt(data.loaded / data.total * 100, 10);\n            this.progressBar.setProgressPercentage(progress);\n        },\n\n        /**\n         * On a file being uploaded.\n         */\n        _onUploadComplete: function(event, data) {\n            if (data.result.error) {\n                alert(data.result.error);\n            } else {\n                var parameters = {\n                    elementId: data.result.assetId,\n                    siteId: this.settings.criteria.siteId,\n                    size: this.settings.viewMode\n                };\n\n                Craft.postActionRequest('elements/get-element-html', parameters, function(data) {\n                    if (data.error) {\n                        alert(data.error);\n                    } else {\n                        var html = $(data.html);\n                        Craft.appendHeadHtml(data.headHtml);\n                        this.selectUploadedFile(Craft.getElementInfo(html));\n                    }\n\n                    // Last file\n                    if (this.uploader.isLastUpload()) {\n                        this.progressBar.hideProgressBar();\n                        this.$container.removeClass('uploading');\n\n                        if (window.draftEditor) {\n                            window.draftEditor.checkForm();\n                        }\n                    }\n                }.bind(this));\n\n                Craft.cp.runQueue();\n            }\n        },\n\n        /**\n         * We have to take into account files about to be added as well\n         */\n        canAddMoreFiles: function(slotsTaken) {\n            return (!this.settings.limit || this.$elements.length + slotsTaken < this.settings.limit);\n        },\n\n        /**\n         * Parse the passed filename into the base filename and extension.\n         *\n         * @param filename\n         * @returns {{extension: string, baseFileName: string}}\n         */\n        _parseFilename: function(filename) {\n            var parts = filename.split('.'),\n                extension = '';\n\n            if (parts.length > 1) {\n                extension = parts.pop();\n            }\n            var baseFileName = parts.join('.');\n            return {extension: extension, baseFileName: baseFileName};\n        },\n\n        /**\n         * A helper function or the filename field.\n         * @private\n         */\n        _renameHelper: function($form) {\n            $('.renameHelper', $form).on('focus', $.proxy(function(e) {\n                var input = e.currentTarget,\n                    filename = this._parseFilename(input.value);\n\n                if (this.originalFilename === '' && this.originalExtension === '') {\n                    this.originalFilename = filename.baseFileName;\n                    this.originalExtension = filename.extension;\n                }\n\n                var startPos = 0,\n                    endPos = filename.baseFileName.length;\n\n                if (typeof input.selectionStart !== 'undefined') {\n                    input.selectionStart = startPos;\n                    input.selectionEnd = endPos;\n                } else if (document.selection && document.selection.createRange) {\n                    // IE branch\n                    input.select();\n                    var range = document.selection.createRange();\n                    range.collapse(true);\n                    range.moveEnd(\"character\", endPos);\n                    range.moveStart(\"character\", startPos);\n                    range.select();\n                }\n\n            }, this));\n        },\n\n        resetOriginalFilename: function() {\n            this.originalFilename = \"\";\n            this.originalExtension = \"\";\n        },\n\n        validateElementForm: function() {\n            var $filenameField = $('.renameHelper', this.elementEditor.hud.$hud.data('elementEditor').$form);\n            var filename = this._parseFilename($filenameField.val());\n\n            if (filename.extension !== this.originalExtension) {\n                // Blank extension\n                if (filename.extension === '') {\n                    // If filename changed as well, assume removal of extension a mistake\n                    if (this.originalFilename !== filename.baseFileName) {\n                        $filenameField.val(filename.baseFileName + '.' + this.originalExtension);\n                        return true;\n                    } else {\n                        // If filename hasn't changed, make sure they want to remove extension\n                        return confirm(Craft.t('app', \"Are you sure you want to remove the extension \u201c.{ext}\u201d?\", {ext: this.originalExtension}));\n                    }\n                } else {\n                    // If the extension has changed, make sure it s intentional\n                    return confirm(Craft.t('app', \"Are you sure you want to change the extension from \u201c.{oldExt}\u201d to \u201c.{newExt}\u201d?\",\n                        {\n                            oldExt: this.originalExtension,\n                            newExt: filename.extension\n                        }));\n                }\n            }\n            return true;\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Asset selector modal class\n */\nCraft.AssetSelectorModal = Craft.BaseElementSelectorModal.extend(\n    {\n        $selectTransformBtn: null,\n        _selectedTransform: null,\n\n        init: function(elementType, settings) {\n            settings = $.extend({}, Craft.AssetSelectorModal.defaults, settings);\n\n            this.base(elementType, settings);\n\n            if (settings.transforms.length) {\n                this.createSelectTransformButton(settings.transforms);\n            }\n        },\n\n        createSelectTransformButton: function(transforms) {\n            if (!transforms || !transforms.length) {\n                return;\n            }\n\n            var $btnGroup = $('<div class=\"btngroup\"/>').appendTo(this.$primaryButtons);\n            this.$selectBtn.appendTo($btnGroup);\n\n            this.$selectTransformBtn = $('<div class=\"btn menubtn disabled\">' + Craft.t('app', 'Select transform') + '</div>').appendTo($btnGroup);\n\n            var $menu = $('<div class=\"menu\" data-align=\"right\"></div>').insertAfter(this.$selectTransformBtn),\n                $menuList = $('<ul></ul>').appendTo($menu);\n\n            for (var i = 0; i < transforms.length; i++) {\n                $('<li><a data-transform=\"' + transforms[i].handle + '\">' + transforms[i].name + '</a></li>').appendTo($menuList);\n            }\n\n            var MenuButton = new Garnish.MenuBtn(this.$selectTransformBtn, {\n                onOptionSelect: $.proxy(this, 'onSelectTransform')\n            });\n            MenuButton.disable();\n\n            this.$selectTransformBtn.data('menuButton', MenuButton);\n        },\n\n        onSelectionChange: function(ev) {\n            var $selectedElements = this.elementIndex.getSelectedElements(),\n                allowTransforms = false;\n\n            if ($selectedElements.length && this.settings.transforms.length) {\n                allowTransforms = true;\n\n                for (var i = 0; i < $selectedElements.length; i++) {\n                    if (!$('.element.hasthumb:first', $selectedElements[i]).length) {\n                        break;\n                    }\n                }\n            }\n\n            var MenuBtn = null;\n\n            if (this.$selectTransformBtn) {\n                MenuBtn = this.$selectTransformBtn.data('menuButton');\n            }\n\n            if (allowTransforms) {\n                if (MenuBtn) {\n                    MenuBtn.enable();\n                }\n\n                this.$selectTransformBtn.removeClass('disabled');\n            }\n            else if (this.$selectTransformBtn) {\n                if (MenuBtn) {\n                    MenuBtn.disable();\n                }\n\n                this.$selectTransformBtn.addClass('disabled');\n            }\n\n            this.base();\n        },\n\n        onSelectTransform: function(option) {\n            var transform = $(option).data('transform');\n            this.selectImagesWithTransform(transform);\n        },\n\n        selectImagesWithTransform: function(transform) {\n            // First we must get any missing transform URLs\n            if (typeof Craft.AssetSelectorModal.transformUrls[transform] === 'undefined') {\n                Craft.AssetSelectorModal.transformUrls[transform] = {};\n            }\n\n            var $selectedElements = this.elementIndex.getSelectedElements(),\n                imageIdsWithMissingUrls = [];\n\n            for (var i = 0; i < $selectedElements.length; i++) {\n                var $item = $($selectedElements[i]),\n                    elementId = Craft.getElementInfo($item).id;\n\n                if (typeof Craft.AssetSelectorModal.transformUrls[transform][elementId] === 'undefined') {\n                    imageIdsWithMissingUrls.push(elementId);\n                }\n            }\n\n            if (imageIdsWithMissingUrls.length) {\n                this.showFooterSpinner();\n\n                this.fetchMissingTransformUrls(imageIdsWithMissingUrls, transform, $.proxy(function() {\n                    this.hideFooterSpinner();\n                    this.selectImagesWithTransform(transform);\n                }, this));\n            }\n            else {\n                this._selectedTransform = transform;\n                this.selectElements();\n                this._selectedTransform = null;\n            }\n        },\n\n        fetchMissingTransformUrls: function(imageIdsWithMissingUrls, transform, callback) {\n            var elementId = imageIdsWithMissingUrls.pop();\n\n            var data = {\n                assetId: elementId,\n                handle: transform\n            };\n\n            Craft.postActionRequest('assets/generate-transform', data, $.proxy(function(response, textStatus) {\n                Craft.AssetSelectorModal.transformUrls[transform][elementId] = false;\n\n                if (textStatus === 'success') {\n                    if (response.url) {\n                        Craft.AssetSelectorModal.transformUrls[transform][elementId] = response.url;\n                    }\n                }\n\n                // More to load?\n                if (imageIdsWithMissingUrls.length) {\n                    this.fetchMissingTransformUrls(imageIdsWithMissingUrls, transform, callback);\n                }\n                else {\n                    callback();\n                }\n            }, this));\n        },\n\n        getElementInfo: function($selectedElements) {\n            var info = this.base($selectedElements);\n\n            if (this._selectedTransform) {\n                for (var i = 0; i < info.length; i++) {\n                    var elementId = info[i].id;\n\n                    if (\n                        typeof Craft.AssetSelectorModal.transformUrls[this._selectedTransform][elementId] !== 'undefined' &&\n                        Craft.AssetSelectorModal.transformUrls[this._selectedTransform][elementId] !== false\n                    ) {\n                        info[i].url = Craft.AssetSelectorModal.transformUrls[this._selectedTransform][elementId];\n                    }\n                }\n            }\n\n            return info;\n        },\n\n        onSelect: function(elementInfo) {\n            this.settings.onSelect(elementInfo, this._selectedTransform);\n        }\n    },\n    {\n        defaults: {\n            canSelectImageTransforms: false,\n            transforms: []\n        },\n\n        transformUrls: {}\n    });\n\n// Register it!\nCraft.registerElementSelectorModalClass('craft\\\\elements\\\\Asset', Craft.AssetSelectorModal);\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * AuthManager class\n */\nCraft.AuthManager = Garnish.Base.extend(\n    {\n        remainingSessionTime: null,\n        checkRemainingSessionTimer: null,\n        showLoginModalTimer: null,\n        decrementLogoutWarningInterval: null,\n\n        showingLogoutWarningModal: false,\n        showingLoginModal: false,\n\n        logoutWarningModal: null,\n        loginModal: null,\n\n        $logoutWarningPara: null,\n        $passwordInput: null,\n        $passwordSpinner: null,\n        $loginBtn: null,\n        $loginErrorPara: null,\n\n        submitLoginIfLoggedOut: false,\n\n        /**\n         * Init\n         */\n        init: function() {\n            this.updateRemainingSessionTime(Craft.remainingSessionTime);\n        },\n\n        /**\n         * Sets a timer for the next time to check the auth timeout.\n         */\n        setCheckRemainingSessionTimer: function(seconds) {\n            if (this.checkRemainingSessionTimer) {\n                clearTimeout(this.checkRemainingSessionTimer);\n            }\n\n            this.checkRemainingSessionTimer = setTimeout($.proxy(this, 'checkRemainingSessionTime'), seconds * 1000);\n        },\n\n        /**\n         * Pings the server to see how many seconds are left on the current user session, and handles the response.\n         */\n        checkRemainingSessionTime: function(extendSession) {\n            $.ajax({\n                url: Craft.getActionUrl('users/get-remaining-session-time', (extendSession ? null : 'dontExtendSession=1')),\n                type: 'GET',\n                dataType: 'json',\n                complete: $.proxy(function(jqXHR, textStatus) {\n                    if (textStatus === 'success') {\n                        if (typeof jqXHR.responseJSON.csrfTokenValue !== 'undefined' && typeof Craft.csrfTokenValue !== 'undefined') {\n                            Craft.csrfTokenValue = jqXHR.responseJSON.csrfTokenValue;\n                        }\n\n                        this.updateRemainingSessionTime(jqXHR.responseJSON.timeout);\n                        this.submitLoginIfLoggedOut = false;\n                    }\n                    else {\n                        this.updateRemainingSessionTime(-1);\n                    }\n                }, this)\n            });\n        },\n\n        /**\n         * Updates our record of the auth timeout, and handles it.\n         */\n        updateRemainingSessionTime: function(remainingSessionTime) {\n            this.remainingSessionTime = parseInt(remainingSessionTime);\n\n            // Are we within the warning window?\n            if (this.remainingSessionTime !== -1 && this.remainingSessionTime < Craft.AuthManager.minSafeSessiotTime) {\n                // Is there still time to renew the session?\n                if (this.remainingSessionTime) {\n                    if (!this.showingLogoutWarningModal) {\n                        // Show the warning modal\n                        this.showLogoutWarningModal();\n                    }\n\n                    // Will the session expire before the next checkup?\n                    if (this.remainingSessionTime < Craft.AuthManager.checkInterval) {\n                        if (this.showLoginModalTimer) {\n                            clearTimeout(this.showLoginModalTimer);\n                        }\n\n                        this.showLoginModalTimer = setTimeout($.proxy(this, 'showLoginModal'), this.remainingSessionTime * 1000);\n                    }\n                }\n                else {\n                    if (this.showingLoginModal) {\n                        if (this.submitLoginIfLoggedOut) {\n                            this.submitLogin();\n                        }\n                    }\n                    else {\n                        // Show the login modal\n                        this.showLoginModal();\n                    }\n                }\n\n                this.setCheckRemainingSessionTimer(Craft.AuthManager.checkInterval);\n            }\n            else {\n                // Everything's good!\n                this.hideLogoutWarningModal();\n                this.hideLoginModal();\n\n                // Will be be within the minSafeSessiotTime before the next update?\n                if (this.remainingSessionTime !== -1 && this.remainingSessionTime < (Craft.AuthManager.minSafeSessiotTime + Craft.AuthManager.checkInterval)) {\n                    this.setCheckRemainingSessionTimer(this.remainingSessionTime - Craft.AuthManager.minSafeSessiotTime + 1);\n                }\n                else {\n                    this.setCheckRemainingSessionTimer(Craft.AuthManager.checkInterval);\n                }\n            }\n        },\n\n        /**\n         * Shows the logout warning modal.\n         */\n        showLogoutWarningModal: function() {\n            var quickShow;\n\n            if (this.showingLoginModal) {\n                this.hideLoginModal(true);\n                quickShow = true;\n            }\n            else {\n                quickShow = false;\n            }\n\n            this.showingLogoutWarningModal = true;\n\n            if (!this.logoutWarningModal) {\n                var $form = $('<form id=\"logoutwarningmodal\" class=\"modal alert fitted\"/>'),\n                    $body = $('<div class=\"body\"/>').appendTo($form),\n                    $buttons = $('<div class=\"buttons right\"/>').appendTo($body),\n                    $logoutBtn = $('<div class=\"btn\">' + Craft.t('app', 'Log out now') + '</div>').appendTo($buttons),\n                    $renewSessionBtn = $('<input type=\"submit\" class=\"btn submit\" value=\"' + Craft.t('app', 'Keep me logged in') + '\" />').appendTo($buttons);\n\n                this.$logoutWarningPara = $('<p/>').prependTo($body);\n\n                this.logoutWarningModal = new Garnish.Modal($form, {\n                    autoShow: false,\n                    closeOtherModals: false,\n                    hideOnEsc: false,\n                    hideOnShadeClick: false,\n                    shadeClass: 'modal-shade dark logoutwarningmodalshade',\n                    onFadeIn: function() {\n                        if (!Garnish.isMobileBrowser(true)) {\n                            // Auto-focus the renew button\n                            setTimeout(function() {\n                                $renewSessionBtn.trigger('focus');\n                            }, 100);\n                        }\n                    }\n                });\n\n                this.addListener($logoutBtn, 'activate', 'logout');\n                this.addListener($form, 'submit', 'renewSession');\n            }\n\n            if (quickShow) {\n                this.logoutWarningModal.quickShow();\n            }\n            else {\n                this.logoutWarningModal.show();\n            }\n\n            this.updateLogoutWarningMessage();\n\n            this.decrementLogoutWarningInterval = setInterval($.proxy(this, 'decrementLogoutWarning'), 1000);\n        },\n\n        /**\n         * Updates the logout warning message indicating that the session is about to expire.\n         */\n        updateLogoutWarningMessage: function() {\n            this.$logoutWarningPara.text(Craft.t('app', 'Your session will expire in {time}.', {\n                time: Craft.secondsToHumanTimeDuration(this.remainingSessionTime)\n            }));\n\n            this.logoutWarningModal.updateSizeAndPosition();\n        },\n\n        decrementLogoutWarning: function() {\n            if (this.remainingSessionTime > 0) {\n                this.remainingSessionTime--;\n                this.updateLogoutWarningMessage();\n            }\n\n            if (this.remainingSessionTime === 0) {\n                clearInterval(this.decrementLogoutWarningInterval);\n            }\n        },\n\n        /**\n         * Hides the logout warning modal.\n         */\n        hideLogoutWarningModal: function(quick) {\n            this.showingLogoutWarningModal = false;\n\n            if (this.logoutWarningModal) {\n                if (quick) {\n                    this.logoutWarningModal.quickHide();\n                }\n                else {\n                    this.logoutWarningModal.hide();\n                }\n\n                if (this.decrementLogoutWarningInterval) {\n                    clearInterval(this.decrementLogoutWarningInterval);\n                }\n            }\n        },\n\n        /**\n         * Shows the login modal.\n         */\n        showLoginModal: function() {\n            var quickShow;\n\n            if (this.showingLogoutWarningModal) {\n                this.hideLogoutWarningModal(true);\n                quickShow = true;\n            }\n            else {\n                quickShow = false;\n            }\n\n            this.showingLoginModal = true;\n\n            if (!this.loginModal) {\n                var $form = $('<form id=\"loginmodal\" class=\"modal alert fitted\"/>'),\n                    $body = $('<div class=\"body\"><h2>' + Craft.t('app', 'Your session has ended.') + '</h2><p>' + Craft.t('app', 'Enter your password to log back in.') + '</p></div>').appendTo($form),\n                    $inputContainer = $('<div class=\"inputcontainer\">').appendTo($body),\n                    $inputsFlexContainer = $('<div class=\"flex\"/>').appendTo($inputContainer),\n                    $passwordContainer = $('<div class=\"flex-grow\"/>').appendTo($inputsFlexContainer),\n                    $buttonContainer = $('<div/>').appendTo($inputsFlexContainer),\n                    $passwordWrapper = $('<div class=\"passwordwrapper\"/>').appendTo($passwordContainer);\n\n                this.$passwordInput = $('<input type=\"password\" class=\"text password fullwidth\" placeholder=\"' + Craft.t('app', 'Password') + '\"/>').appendTo($passwordWrapper);\n                this.$passwordSpinner = $('<div class=\"spinner hidden\"/>').appendTo($inputContainer);\n                this.$loginBtn = $('<input type=\"submit\" class=\"btn submit disabled\" value=\"' + Craft.t('app', 'Login') + '\" />').appendTo($buttonContainer);\n                this.$loginErrorPara = $('<p class=\"error\"/>').appendTo($body);\n\n                this.loginModal = new Garnish.Modal($form, {\n                    autoShow: false,\n                    closeOtherModals: false,\n                    hideOnEsc: false,\n                    hideOnShadeClick: false,\n                    shadeClass: 'modal-shade dark loginmodalshade',\n                    onFadeIn: $.proxy(function() {\n                        if (!Garnish.isMobileBrowser(true)) {\n                            // Auto-focus the password input\n                            setTimeout($.proxy(function() {\n                                this.$passwordInput.trigger('focus');\n                            }, this), 100);\n                        }\n                    }, this),\n                    onFadeOut: $.proxy(function() {\n                        this.$passwordInput.val('');\n                    }, this)\n                });\n\n                new Craft.PasswordInput(this.$passwordInput, {\n                    onToggleInput: $.proxy(function($newPasswordInput) {\n                        this.$passwordInput = $newPasswordInput;\n                    }, this)\n                });\n\n                this.addListener(this.$passwordInput, 'textchange', 'validatePassword');\n                this.addListener($form, 'submit', 'login');\n            }\n\n            if (quickShow) {\n                this.loginModal.quickShow();\n            }\n            else {\n                this.loginModal.show();\n            }\n        },\n\n        /**\n         * Hides the login modal.\n         */\n        hideLoginModal: function(quick) {\n            this.showingLoginModal = false;\n\n            if (this.loginModal) {\n                if (quick) {\n                    this.loginModal.quickHide();\n                }\n                else {\n                    this.loginModal.hide();\n                }\n            }\n        },\n\n        logout: function() {\n            $.get({\n                url: Craft.getActionUrl('users/logout'),\n                dataType: 'json',\n                success: $.proxy(function() {\n                    Craft.redirectTo('');\n                }, this)\n            });\n        },\n\n        renewSession: function(ev) {\n            if (ev) {\n                ev.preventDefault();\n            }\n\n            this.hideLogoutWarningModal();\n            this.checkRemainingSessionTime(true);\n        },\n\n        validatePassword: function() {\n            if (this.$passwordInput.val().length >= 6) {\n                this.$loginBtn.removeClass('disabled');\n                return true;\n            }\n            else {\n                this.$loginBtn.addClass('disabled');\n                return false;\n            }\n        },\n\n        login: function(ev) {\n            if (ev) {\n                ev.preventDefault();\n            }\n\n            if (this.validatePassword()) {\n                this.$passwordSpinner.removeClass('hidden');\n                this.clearLoginError();\n\n                if (typeof Craft.csrfTokenValue !== 'undefined') {\n                    // Check the auth status one last time before sending this off,\n                    // in case the user has already logged back in from another window/tab\n                    this.submitLoginIfLoggedOut = true;\n                    this.checkRemainingSessionTime();\n                }\n                else {\n                    this.submitLogin();\n                }\n            }\n        },\n\n        submitLogin: function() {\n            var data = {\n                loginName: Craft.username,\n                password: this.$passwordInput.val()\n            };\n\n            Craft.postActionRequest('users/login', data, $.proxy(function(response, textStatus) {\n                this.$passwordSpinner.addClass('hidden');\n\n                if (textStatus === 'success') {\n                    if (response.success) {\n                        this.hideLoginModal();\n                        this.checkRemainingSessionTime();\n                    }\n                    else {\n                        this.showLoginError(response.error);\n                        Garnish.shake(this.loginModal.$container);\n\n                        if (!Garnish.isMobileBrowser(true)) {\n                            this.$passwordInput.trigger('focus');\n                        }\n                    }\n                }\n                else {\n                    this.showLoginError();\n                }\n\n            }, this));\n        },\n\n        showLoginError: function(error) {\n            if (error === null || typeof error === 'undefined') {\n                error = Craft.t('app', 'An unknown error occurred.');\n            }\n\n            this.$loginErrorPara.text(error);\n            this.loginModal.updateSizeAndPosition();\n        },\n\n        clearLoginError: function() {\n            this.showLoginError('');\n        }\n    },\n    {\n        checkInterval: 60,\n        minSafeSessiotTime: 120\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Category index class\n */\nCraft.CategoryIndex = Craft.BaseElementIndex.extend(\n    {\n        editableGroups: null,\n        $newCategoryBtnGroup: null,\n        $newCategoryBtn: null,\n\n        init: function(elementType, $container, settings) {\n            this.on('selectSource', $.proxy(this, 'updateButton'));\n            this.on('selectSite', $.proxy(this, 'updateButton'));\n            this.base(elementType, $container, settings);\n        },\n\n        afterInit: function() {\n            // Find which of the visible groups the user has permission to create new categories in\n            this.editableGroups = [];\n\n            for (var i = 0; i < Craft.editableCategoryGroups.length; i++) {\n                var group = Craft.editableCategoryGroups[i];\n\n                if (this.getSourceByKey('group:' + group.uid)) {\n                    this.editableGroups.push(group);\n                }\n            }\n\n            this.base();\n        },\n\n        getDefaultSourceKey: function() {\n            // Did they request a specific category group in the URL?\n            if (this.settings.context === 'index' && typeof defaultGroupHandle !== 'undefined') {\n                for (var i = 0; i < this.$sources.length; i++) {\n                    var $source = $(this.$sources[i]);\n\n                    if ($source.data('handle') === defaultGroupHandle) {\n                        return $source.data('key');\n                    }\n                }\n            }\n\n            return this.base();\n        },\n\n        updateButton: function() {\n            if (!this.$source) {\n                return;\n            }\n\n            // Get the handle of the selected source\n            var selectedSourceHandle = this.$source.data('handle');\n\n            var i, href, label;\n\n            // Update the New Category button\n            // ---------------------------------------------------------------------\n\n            if (this.editableGroups.length) {\n                // Remove the old button, if there is one\n                if (this.$newCategoryBtnGroup) {\n                    this.$newCategoryBtnGroup.remove();\n                }\n\n                // Determine if they are viewing a group that they have permission to create categories in\n                var selectedGroup;\n\n                if (selectedSourceHandle) {\n                    for (i = 0; i < this.editableGroups.length; i++) {\n                        if (this.editableGroups[i].handle === selectedSourceHandle) {\n                            selectedGroup = this.editableGroups[i];\n                            break;\n                        }\n                    }\n                }\n\n                this.$newCategoryBtnGroup = $('<div class=\"btngroup submit\"/>');\n                var $menuBtn;\n\n                // If they are, show a primary \"New category\" button, and a dropdown of the other groups (if any).\n                // Otherwise only show a menu button\n                if (selectedGroup) {\n                    href = this._getGroupTriggerHref(selectedGroup);\n                    label = (this.settings.context === 'index' ? Craft.t('app', 'New category') : Craft.t('app', 'New {group} category', {group: selectedGroup.name}));\n                    this.$newCategoryBtn = $('<a class=\"btn submit add icon\" ' + href + '>' + Craft.escapeHtml(label) + '</a>').appendTo(this.$newCategoryBtnGroup);\n\n                    if (this.settings.context !== 'index') {\n                        this.addListener(this.$newCategoryBtn, 'click', function(ev) {\n                            this._openCreateCategoryModal(ev.currentTarget.getAttribute('data-id'));\n                        });\n                    }\n\n                    if (this.editableGroups.length > 1) {\n                        $menuBtn = $('<div class=\"btn submit menubtn\"></div>').appendTo(this.$newCategoryBtnGroup);\n                    }\n                }\n                else {\n                    this.$newCategoryBtn = $menuBtn = $('<div class=\"btn submit add icon menubtn\">' + Craft.t('app', 'New category') + '</div>').appendTo(this.$newCategoryBtnGroup);\n                }\n\n                if ($menuBtn) {\n                    var menuHtml = '<div class=\"menu\"><ul>';\n\n                    for (i = 0; i < this.editableGroups.length; i++) {\n                        var group = this.editableGroups[i];\n\n                        if (this.settings.context === 'index' || group !== selectedGroup) {\n                            href = this._getGroupTriggerHref(group);\n                            label = (this.settings.context === 'index' ? group.name : Craft.t('app', 'New {group} category', {group: group.name}));\n                            menuHtml += '<li><a ' + href + '\">' + Craft.escapeHtml(label) + '</a></li>';\n                        }\n                    }\n\n                    menuHtml += '</ul></div>';\n\n                    $(menuHtml).appendTo(this.$newCategoryBtnGroup);\n                    var menuBtn = new Garnish.MenuBtn($menuBtn);\n\n                    if (this.settings.context !== 'index') {\n                        menuBtn.on('optionSelect', $.proxy(function(ev) {\n                            this._openCreateCategoryModal(ev.option.getAttribute('data-id'));\n                        }, this));\n                    }\n                }\n\n                this.addButton(this.$newCategoryBtnGroup);\n            }\n\n            // Update the URL if we're on the Categories index\n            // ---------------------------------------------------------------------\n\n            if (this.settings.context === 'index' && typeof history !== 'undefined') {\n                var uri = 'categories';\n\n                if (selectedSourceHandle) {\n                    uri += '/' + selectedSourceHandle;\n                }\n\n                history.replaceState({}, '', Craft.getUrl(uri));\n            }\n        },\n\n        _getGroupTriggerHref: function(group) {\n            if (this.settings.context === 'index') {\n                var uri = 'categories/' + group.handle + '/new';\n                if (this.siteId && this.siteId != Craft.primarySiteId) {\n                    for (var i = 0; i < Craft.sites.length; i++) {\n                        if (Craft.sites[i].id == this.siteId) {\n                            uri += '/'+Craft.sites[i].handle;\n                        }\n                    }\n                }\n                return 'href=\"' + Craft.getUrl(uri) + '\"';\n            }\n            else {\n                return 'data-id=\"' + group.id + '\"';\n            }\n        },\n\n        _openCreateCategoryModal: function(groupId) {\n            if (this.$newCategoryBtn.hasClass('loading')) {\n                return;\n            }\n\n            // Find the group\n            var group;\n\n            for (var i = 0; i < this.editableGroups.length; i++) {\n                if (this.editableGroups[i].id == groupId) {\n                    group = this.editableGroups[i];\n                    break;\n                }\n            }\n\n            if (!group) {\n                return;\n            }\n\n            this.$newCategoryBtn.addClass('inactive');\n            var newCategoryBtnText = this.$newCategoryBtn.text();\n            this.$newCategoryBtn.text(Craft.t('app', 'New {group} category', {group: group.name}));\n\n            Craft.createElementEditor(this.elementType, {\n                hudTrigger: this.$newCategoryBtnGroup,\n                elementType: 'craft\\\\elements\\\\Category',\n                siteId: this.siteId,\n                attributes: {\n                    groupId: groupId\n                },\n                onBeginLoading: $.proxy(function() {\n                    this.$newCategoryBtn.addClass('loading');\n                }, this),\n                onEndLoading: $.proxy(function() {\n                    this.$newCategoryBtn.removeClass('loading');\n                }, this),\n                onHideHud: $.proxy(function() {\n                    this.$newCategoryBtn.removeClass('inactive').text(newCategoryBtnText);\n                }, this),\n                onSaveElement: $.proxy(function(response) {\n                    // Make sure the right group is selected\n                    var groupSourceKey = 'group:' + group.uid;\n\n                    if (this.sourceKey !== groupSourceKey) {\n                        this.selectSourceByKey(groupSourceKey);\n                    }\n\n                    this.selectElementAfterUpdate(response.id);\n                    this.updateElements();\n                }, this)\n            });\n        }\n    });\n\n// Register it!\nCraft.registerElementIndexClass('craft\\\\elements\\\\Category', Craft.CategoryIndex);\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Category Select input\n */\nCraft.CategorySelectInput = Craft.BaseElementSelectInput.extend(\n    {\n        setSettings: function() {\n            this.base.apply(this, arguments);\n            this.settings.sortable = false;\n        },\n\n        getModalSettings: function() {\n            var settings = this.base();\n            settings.hideOnSelect = false;\n            return settings;\n        },\n\n        getElements: function() {\n            return this.$elementsContainer.find('.element');\n        },\n\n        onModalSelect: function(elements) {\n            // Disable the modal\n            this.modal.disable();\n            this.modal.disableCancelBtn();\n            this.modal.disableSelectBtn();\n            this.modal.showFooterSpinner();\n\n            // Get the new category HTML\n            var selectedCategoryIds = this.getSelectedElementIds();\n\n            for (var i = 0; i < elements.length; i++) {\n                selectedCategoryIds.push(elements[i].id);\n            }\n\n            var data = {\n                categoryIds: selectedCategoryIds,\n                siteId: elements[0].siteId,\n                id: this.settings.id,\n                name: this.settings.name,\n                branchLimit: this.settings.branchLimit,\n                selectionLabel: this.settings.selectionLabel\n            };\n\n            Craft.postActionRequest('elements/get-categories-input-html', data, $.proxy(function(response, textStatus) {\n                this.modal.enable();\n                this.modal.enableCancelBtn();\n                this.modal.enableSelectBtn();\n                this.modal.hideFooterSpinner();\n\n                if (textStatus === 'success') {\n                    var $newInput = $(response.html),\n                        $newElementsContainer = $newInput.children('.elements');\n\n                    this.$elementsContainer.replaceWith($newElementsContainer);\n                    this.$elementsContainer = $newElementsContainer;\n                    this.resetElements();\n\n                    var filteredElements = [];\n\n                    for (var i = 0; i < elements.length; i++) {\n                        var element = elements[i],\n                            $element = this.getElementById(element.id);\n\n                        if ($element) {\n                            this.animateElementIntoPlace(element.$element, $element);\n                            filteredElements.push(element);\n                        }\n                    }\n\n                    this.updateDisabledElementsInModal();\n                    this.modal.hide();\n                    this.onSelectElements(filteredElements);\n                }\n            }, this));\n        },\n\n        removeElement: function($element) {\n            // Find any descendants this category might have\n            var $allCategories = $element.add($element.parent().siblings('ul').find('.element'));\n\n            // Remove our record of them all at once\n            this.removeElements($allCategories);\n\n            // Animate them away one at a time\n            for (var i = 0; i < $allCategories.length; i++) {\n                this._animateCategoryAway($allCategories, i);\n            }\n        },\n\n        _animateCategoryAway: function($allCategories, i) {\n            var callback;\n\n            // Is this the last one?\n            if (i === $allCategories.length - 1) {\n                callback = $.proxy(function() {\n                    var $li = $allCategories.first().parent().parent(),\n                        $ul = $li.parent();\n\n                    if ($ul[0] === this.$elementsContainer[0] || $li.siblings().length) {\n                        $li.remove();\n                    }\n                    else {\n                        $ul.remove();\n                    }\n                }, this);\n            }\n\n            var func = $.proxy(function() {\n                this.animateElementAway($allCategories.eq(i), callback);\n            }, this);\n\n            if (i === 0) {\n                func();\n            }\n            else {\n                setTimeout(func, 100 * i);\n            }\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Craft Charts\n */\n\nCraft.charts = {};\n\n// ---------------------------------------------------------------------\n\n/**\n * Class Craft.charts.DataTable\n */\nCraft.charts.DataTable = Garnish.Base.extend(\n    {\n        columns: null,\n        rows: null,\n\n        init: function(data) {\n            columns = data.columns;\n            rows = data.rows;\n\n            rows.forEach($.proxy(function(d) {\n                $.each(d, function(cellIndex) {\n                    var column = columns[cellIndex];\n\n                    var parseTime;\n\n                    switch (column.type) {\n                        case 'date':\n                            parseTime = d3.timeParse(\"%Y-%m-%d\");\n                            d[cellIndex] = parseTime(d[cellIndex]);\n                            break;\n\n                        case 'datetime':\n                            parseTime = d3.timeParse(\"%Y-%m-%d %H:00:00\");\n                            d[cellIndex] = parseTime(d[cellIndex]);\n                            break;\n\n                        case 'percent':\n                            d[cellIndex] = d[cellIndex] / 100;\n                            break;\n\n                        case 'number':\n                            d[cellIndex] = +d[cellIndex];\n                            break;\n\n                        default:\n                        // do nothing\n                    }\n                });\n\n            }, this));\n\n            this.columns = columns;\n            this.rows = rows;\n        }\n    });\n\n// ---------------------------------------------------------------------\n\n/**\n * Class Craft.charts.Tip\n */\n\nCraft.charts.Tip = Garnish.Base.extend(\n    {\n        $container: null,\n        $tip: null,\n\n        init: function($container) {\n            this.$container = $container;\n\n            this.$tip = $('<div class=\"tooltip\"></div>').appendTo(this.$container);\n\n            this.hide();\n        },\n\n        setContent: function(html) {\n            this.$tip.html(html);\n        },\n\n        setPosition: function(position) {\n            this.$tip.css(\"left\", position.left + \"px\");\n            this.$tip.css(\"top\", position.top + \"px\");\n        },\n\n        show: function() {\n            this.$tip.css(\"display\", 'block');\n        },\n\n        hide: function() {\n            this.$tip.css(\"display\", 'none');\n        }\n    });\n\n// ---------------------------------------------------------------------\n\n/**\n * Class Craft.charts.BaseChart\n */\nCraft.charts.BaseChart = Garnish.Base.extend(\n    {\n        $container: null,\n        $chart: null,\n\n        chartBaseClass: 'cp-chart',\n        dataTable: null,\n\n        formatLocale: null,\n        timeFormatLocale: null,\n        orientation: null,\n\n        svg: null,\n        width: null,\n        height: null,\n\n        init: function(container, settings) {\n            this.$container = container;\n\n            this.setSettings(Craft.charts.BaseChart.defaults);\n            this.setSettings(settings);\n\n            var globalSettings = {\n                formats: window.d3Formats,\n                formatLocaleDefinition: window.d3FormatLocaleDefinition,\n                timeFormatLocaleDefinition: window.d3TimeFormatLocaleDefinition\n            };\n\n            this.setSettings(globalSettings);\n\n            d3.select(window).on('resize', $.proxy(function() {\n                this.resize();\n            }, this));\n        },\n\n        setSettings: function(settings, defaults) {\n            var baseSettings = (typeof this.settings === 'undefined' ? {} : this.settings);\n            this.settings = $.extend(true, {}, baseSettings, defaults, settings);\n        },\n\n        draw: function(dataTable, settings) {\n            // Settings and chart attributes\n\n            this.setSettings(settings);\n\n            this.dataTable = dataTable;\n            this.formatLocale = d3.formatLocale(this.settings.formatLocaleDefinition);\n            this.timeFormatLocale = d3.timeFormatLocale(this.settings.timeFormatLocaleDefinition);\n            this.orientation = this.settings.orientation;\n\n\n            // Set (or reset) the chart element\n\n            if (this.$chart) {\n                this.$chart.remove();\n            }\n\n            var className = this.chartBaseClass;\n\n            if (this.settings.chartClass) {\n                className += ' ' + this.settings.chartClass;\n            }\n\n            this.$chart = $('<div class=\"' + className + '\" />').appendTo(this.$container);\n        },\n\n        resize: function() {\n            this.draw(this.dataTable, this.settings);\n        },\n\n        onAfterDrawTicks: function() {\n            // White border for ticks' text\n            $('.tick', this.$chart).each(function(tickKey, tick) {\n                var $tickText = $('text', tick);\n\n                var $clone = $tickText.clone();\n                $clone.appendTo(tick);\n\n                $tickText.attr('stroke', '#ffffff');\n                $tickText.attr('stroke-width', 3);\n            });\n        }\n    },\n    {\n        defaults: {\n            formatLocaleDefinition: null,\n            timeFormatLocaleDefinition: null,\n            formats: {\n                numberFormat: ',.2f',\n                percentFormat: ',.2%',\n                currencyFormat: '$,.2f',\n                shortDateFormats: {\n                    day: \"%-m/%-d\",\n                    month: \"%-m/%y\",\n                    year: \"%Y\"\n                }\n            },\n            margin: {top: 0, right: 0, bottom: 0, left: 0},\n            chartClass: null,\n            colors: [\"#0594D1\", \"#DE3800\", \"#FF9A00\", \"#009802\", \"#9B009B\"]\n        }\n    });\n\n// ---------------------------------------------------------------------\n\n/**\n * Class Craft.charts.Area\n */\nCraft.charts.Area = Craft.charts.BaseChart.extend(\n    {\n        tip: null,\n        drawingArea: null,\n\n        init: function(container, settings) {\n            this.base(container, Craft.charts.Area.defaults);\n\n            this.setSettings(settings);\n        },\n\n        draw: function(dataTable, settings) {\n\n            this.base(dataTable, settings);\n\n            if (this.tip) {\n                this.tip = null;\n            }\n\n            var margin = this.getChartMargin();\n\n            this.width = this.$chart.width() - margin.left - margin.right;\n            this.height = this.$chart.height() - margin.top - margin.bottom;\n\n\n            // Append SVG to chart element\n\n            var svg = {\n                width: this.width + (margin.left + margin.right),\n                height: this.height + (margin.top + margin.bottom),\n                translateX: (this.orientation !== 'rtl' ? (margin.left) : (margin.right)),\n                translateY: margin.top\n            };\n\n            this.svg = d3.select(this.$chart.get(0)).append(\"svg\")\n                .attr(\"width\", svg.width)\n                .attr(\"height\", svg.height);\n\n            this.drawingArea = this.svg.append(\"g\")\n                .attr(\"transform\", \"translate(\" + svg.translateX + \",\" + svg.translateY + \")\");\n\n\n            // Draw elements\n\n            this.drawTicks();\n            this.drawAxes();\n            this.drawChart();\n            this.drawTipTriggers();\n        },\n\n        drawTicks: function() {\n            // Draw X ticks\n\n            var x = this.getX(true);\n            var xTicks = 3;\n            var xAxis = d3.axisBottom(x)\n                .tickFormat(this.getXFormatter())\n                .ticks(xTicks);\n\n            this.drawingArea.append(\"g\")\n                .attr(\"class\", \"x ticks-axis\")\n                .attr(\"transform\", \"translate(0, \" + this.height + \")\")\n                .call(xAxis);\n\n\n            // Draw Y ticks\n\n            var y = this.getY();\n            var yTicks = 2;\n            var yAxis;\n\n            if (this.orientation !== 'rtl') {\n                yAxis = d3.axisLeft(y)\n                    .tickFormat(this.getYFormatter())\n                    .tickValues(this.getYTickValues())\n                    .ticks(yTicks);\n\n                this.drawingArea.append(\"g\")\n                    .attr(\"class\", \"y ticks-axis\")\n                    .call(yAxis);\n            } else {\n                yAxis = d3.axisRight(y)\n                    .tickFormat(this.getYFormatter())\n                    .tickValues(this.getYTickValues())\n                    .ticks(yTicks);\n\n                this.drawingArea.append(\"g\")\n                    .attr(\"class\", \"y ticks-axis\")\n                    .attr(\"transform\", \"translate(\" + this.width + \",0)\")\n                    .call(yAxis);\n            }\n\n\n            // On after draw ticks\n\n            this.onAfterDrawTicks();\n        },\n\n        drawAxes: function() {\n            if (this.settings.xAxis.showAxis) {\n                var x = this.getX();\n                var xAxis = d3.axisBottom(x).ticks(0).tickSizeOuter(0);\n                this.drawingArea.append(\"g\")\n                    .attr(\"class\", \"x axis\")\n                    .attr(\"transform\", \"translate(0, \" + this.height + \")\")\n                    .call(xAxis);\n            }\n\n            if (this.settings.yAxis.showAxis) {\n                var y = this.getY();\n                var chartPadding = 0;\n                var yAxis;\n\n                if (this.orientation === 'rtl') {\n                    yAxis = d3.axisLeft(y).ticks(0);\n                    this.drawingArea.append(\"g\")\n                        .attr(\"class\", \"y axis\")\n                        .attr(\"transform\", \"translate(\" + (this.width - chartPadding) + \", 0)\")\n                        .call(yAxis);\n                } else {\n                    yAxis = d3.axisRight(y).ticks(0);\n                    this.drawingArea.append(\"g\")\n                        .attr(\"class\", \"y axis\")\n                        .attr(\"transform\", \"translate(\" + chartPadding + \", 0)\")\n                        .call(yAxis);\n                }\n            }\n        },\n\n        drawChart: function() {\n            var x = this.getX(true);\n            var y = this.getY();\n\n\n            // X & Y grid lines\n\n            if (this.settings.xAxis.gridlines) {\n                var xLineAxis = d3.axisBottom(x);\n\n                this.drawingArea.append(\"g\")\n                    .attr(\"class\", \"x grid-line\")\n                    .attr(\"transform\", \"translate(0,\" + this.height + \")\")\n                    .call(xLineAxis\n                        .tickSize(-this.height, 0, 0)\n                        .tickFormat(\"\")\n                    );\n            }\n\n            var yTicks = 2;\n\n            if (this.settings.yAxis.gridlines) {\n                var yLineAxis = d3.axisLeft(y);\n\n                this.drawingArea.append(\"g\")\n                    .attr(\"class\", \"y grid-line\")\n                    .attr(\"transform\", \"translate(0 , 0)\")\n                    .call(yLineAxis\n                        .tickSize(-(this.width), 0)\n                        .tickFormat(\"\")\n                        .tickValues(this.getYTickValues())\n                        .ticks(yTicks)\n                    );\n            }\n\n            // Line\n\n            var line = d3.line()\n                .x(function(d) {\n                    return x(d[0]);\n                })\n                .y(function(d) {\n                    return y(d[1]);\n                });\n\n            this.drawingArea\n                .append(\"g\")\n                .attr(\"class\", \"chart-line\")\n                .append(\"path\")\n                .datum(this.dataTable.rows)\n                .style('fill', 'none')\n                .style('stroke', this.settings.colors[0])\n                .style('stroke-width', '3px')\n                .attr(\"d\", line);\n\n\n            // Area\n\n            var area = d3.area()\n                .x(function(d) {\n                    return x(d[0]);\n                })\n                .y0(this.height)\n                .y1(function(d) {\n                    return y(d[1]);\n                });\n\n            this.drawingArea\n                .append(\"g\")\n                .attr(\"class\", \"chart-area\")\n                .append(\"path\")\n                .datum(this.dataTable.rows)\n                .style('fill', this.settings.colors[0])\n                .style('fill-opacity', '0.3')\n                .attr(\"d\", area);\n\n\n            // Plots\n\n            if (this.settings.plots) {\n                this.drawingArea.append('g')\n                    .attr(\"class\", \"plots\")\n                    .selectAll(\"circle\")\n                    .data(this.dataTable.rows)\n                    .enter()\n                    .append(\"circle\")\n                    .style('fill', this.settings.colors[0])\n                    .attr(\"class\", $.proxy(function(d, index) {\n                        return 'plot plot-' + index;\n                    }, this))\n                    .attr(\"r\", 4)\n                    .attr(\"cx\", $.proxy(function(d) {\n                        return x(d[0]);\n                    }, this))\n                    .attr(\"cy\", $.proxy(function(d) {\n                        return y(d[1]);\n                    }, this));\n            }\n        },\n\n        drawTipTriggers: function() {\n            if (this.settings.tips) {\n                if (!this.tip) {\n                    this.tip = new Craft.charts.Tip(this.$chart);\n                }\n\n\n                // Define xAxisTickInterval\n\n                var chartMargin = this.getChartMargin();\n                var tickSizeOuter = 6;\n                var length = this.drawingArea.select('.x path.domain').node().getTotalLength() - chartMargin.left - chartMargin.right - tickSizeOuter * 2;\n                var xAxisTickInterval = length / (this.dataTable.rows.length - 1);\n\n\n                // Tip trigger width\n\n                var tipTriggerWidth = Math.max(0, xAxisTickInterval);\n\n\n                // Draw triggers\n\n                var x = this.getX(true);\n                var y = this.getY();\n\n                this.drawingArea.append('g')\n                    .attr(\"class\", \"tip-triggers\")\n                    .selectAll(\"rect\")\n                    .data(this.dataTable.rows)\n                    .enter().append(\"rect\")\n                    .attr(\"class\", \"tip-trigger\")\n                    .style('fill', 'transparent')\n                    .style('fill-opacity', '1')\n                    .attr(\"width\", tipTriggerWidth)\n                    .attr(\"height\", this.height)\n                    .attr(\"x\", $.proxy(function(d) {\n                        return x(d[0]) - tipTriggerWidth / 2;\n                    }, this))\n                    .on(\"mouseover\", $.proxy(function(d, index) {\n                        // Expand plot\n\n                        this.drawingArea.select('.plot-' + index).attr(\"r\", 5);\n\n\n                        // Set tip content\n\n                        var $content = $('<div />');\n                        var $xValue = $('<div class=\"x-value\" />').appendTo($content);\n                        var $yValue = $('<div class=\"y-value\" />').appendTo($content);\n\n                        $xValue.html(this.getXFormatter()(d[0]));\n                        $yValue.html(this.getYFormatter()(d[1]));\n\n                        var content = $content.get(0);\n\n                        this.tip.setContent(content);\n\n\n                        // Set tip position\n\n                        var margin = this.getChartMargin();\n\n                        var offset = 24;\n                        var top = (y(d[1]) + offset);\n                        var left;\n\n                        if (this.orientation !== 'rtl') {\n                            left = (x(d[0]) + margin.left + offset);\n\n                            var calcLeft = (this.$chart.offset().left + left + this.tip.$tip.width());\n                            var maxLeft = this.$chart.offset().left + this.$chart.width() - offset;\n\n                            if (calcLeft > maxLeft) {\n                                left = x(d[0]) - (this.tip.$tip.width() + offset);\n                            }\n                        } else {\n                            left = (x(d[0]) - (this.tip.$tip.width() + margin.left + offset));\n                        }\n\n                        if (left < 0) {\n                            left = (x(d[0]) + margin.left + offset);\n                        }\n\n                        var position = {\n                            top: top,\n                            left: left\n                        };\n\n                        this.tip.setPosition(position);\n\n\n                        // Show tip\n\n                        this.tip.show();\n\n                    }, this))\n                    .on(\"mouseout\", $.proxy(function(d, index) {\n                        // Unexpand Plot\n                        this.drawingArea.select('.plot-' + index).attr(\"r\", 4);\n\n                        // Hide tip\n                        this.tip.hide();\n                    }, this));\n            }\n        },\n\n        getChartMargin: function() {\n            var margin = this.settings.margin;\n\n\n            // Estimate the max width of y ticks and set it as the left margin\n\n            var values = this.getYTickValues();\n            var yTicksMaxWidth = 0;\n\n            $.each(values, $.proxy(function(key, value) {\n                var characterWidth = 8;\n\n                var formatter = this.getYFormatter();\n\n                var formattedValue = formatter(value);\n                var computedTickWidth = formattedValue.length * characterWidth;\n\n                if (computedTickWidth > yTicksMaxWidth) {\n                    yTicksMaxWidth = computedTickWidth;\n                }\n            }, this));\n\n            yTicksMaxWidth += 10;\n\n            margin.left = yTicksMaxWidth;\n\n            return margin;\n        },\n\n        getX: function(padded) {\n            var xDomainMin = d3.min(this.dataTable.rows, function(d) {\n                return d[0];\n            });\n\n            var xDomainMax = d3.max(this.dataTable.rows, function(d) {\n                return d[0];\n            });\n\n            var xDomain = [xDomainMin, xDomainMax];\n\n            if (this.orientation === 'rtl') {\n                xDomain = [xDomainMax, xDomainMin];\n            }\n\n            var left = 0;\n            var right = 0;\n\n            if (padded) {\n                left = 0;\n                right = 0;\n            }\n\n            var x = d3.scaleTime().range([left, (this.width - right)]);\n\n            x.domain(xDomain);\n\n            return x;\n        },\n\n        getY: function() {\n            var yDomain = [0, this.getYMaxValue()];\n\n            var y = d3.scaleLinear().range([this.height, 0]);\n\n            y.domain(yDomain);\n\n            return y;\n        },\n\n        getXFormatter: function() {\n            var formatter;\n\n            if (this.settings.xAxis.formatter !== $.noop) {\n                formatter = this.settings.xAxis.formatter(this);\n            } else {\n                formatter = Craft.charts.utils.getTimeFormatter(this.timeFormatLocale, this.settings);\n            }\n\n            return formatter;\n        },\n\n        getYFormatter: function() {\n            var formatter;\n\n            if (this.settings.yAxis.formatter !== $.noop) {\n                formatter = this.settings.yAxis.formatter(this);\n            } else {\n                formatter = Craft.charts.utils.getNumberFormatter(this.formatLocale, this.dataTable.columns[1].type, this.settings);\n            }\n\n            return formatter;\n        },\n\n        getYMaxValue: function() {\n            return d3.max(this.dataTable.rows, function(d) {\n                return d[1];\n            });\n        },\n\n        getYTickValues: function() {\n            var maxValue = this.getYMaxValue();\n\n            if (maxValue > 1) {\n                return [(maxValue / 2), maxValue];\n            } else {\n                return [0, maxValue];\n            }\n        }\n    },\n    {\n        defaults: {\n            chartClass: 'area',\n            margin: {top: 25, right: 5, bottom: 25, left: 0},\n            plots: true,\n            tips: true,\n            xAxis: {\n                gridlines: false,\n                showAxis: true,\n                formatter: $.noop\n            },\n            yAxis: {\n                gridlines: true,\n                showAxis: false,\n                formatter: $.noop\n            }\n        }\n    });\n\n// ---------------------------------------------------------------------\n\n/**\n * Class Craft.charts.Utils\n */\nCraft.charts.utils = {\n\n    getDuration: function(seconds) {\n        var secondsNum = parseInt(seconds, 10);\n\n        var duration = {\n            hours: (Math.floor(secondsNum / 3600)),\n            minutes: (Math.floor((secondsNum - (duration.hours * 3600)) / 60)),\n            seconds: (secondsNum - (duration.hours * 3600) - (duration.minutes * 60))\n        };\n\n        if (duration.hours < 10) {\n            duration.hours = \"0\" + duration.hours;\n        }\n\n        if (duration.minutes < 10) {\n            duration.minutes = \"0\" + duration.minutes;\n        }\n\n        if (duration.seconds < 10) {\n            duration.seconds = \"0\" + duration.seconds;\n        }\n\n        return duration.hours + ':' + duration.minutes + ':' + duration.seconds;\n    },\n\n    getTimeFormatter: function(timeFormatLocale, chartSettings) {\n        switch (chartSettings.dataScale) {\n            case 'year':\n                return timeFormatLocale.format('%Y');\n\n            case 'month':\n                return timeFormatLocale.format(chartSettings.formats.shortDateFormats.month);\n\n            case 'hour':\n                return timeFormatLocale.format(chartSettings.formats.shortDateFormats.day + \" %H:00:00\");\n\n            default:\n                return timeFormatLocale.format(chartSettings.formats.shortDateFormats.day);\n        }\n    },\n\n    getNumberFormatter: function(formatLocale, type, chartSettings) {\n        switch (type) {\n            case 'currency':\n                return formatLocale.format(chartSettings.formats.currencyFormat);\n\n            case 'percent':\n                return formatLocale.format(chartSettings.formats.percentFormat);\n\n            case 'time':\n                return Craft.charts.utils.getDuration;\n\n            case 'number':\n                return formatLocale.format(chartSettings.formats.numberFormat);\n        }\n    }\n};\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Color input\n */\nCraft.ColorInput = Garnish.Base.extend({\n    $container: null,\n    $input: null,\n    $colorContainer: null,\n    $colorPreview: null,\n    $colorInput: null,\n\n    init: function(container) {\n        this.$container = $(container);\n        this.$input = this.$container.children('.color-input');\n        this.$colorContainer = this.$container.children('.color');\n        this.$colorPreview = this.$colorContainer.children('.color-preview');\n\n        this.createColorInput();\n        this.handleTextChange();\n\n        this.addListener(this.$input, 'textchange', 'handleTextChange');\n    },\n\n    createColorInput: function() {\n        var input = document.createElement('input');\n        input.setAttribute('type', 'color');\n\n        if (input.type !== 'color') {\n            // The browser doesn't support input[type=color]\n            return;\n        }\n\n        this.$colorContainer.removeClass('static');\n        this.$colorInput = $(input)\n            .addClass('hidden')\n            .insertAfter(this.$input);\n\n        this.addListener(this.$colorContainer, 'click', function() {\n            this.$colorInput.trigger('click');\n        });\n\n        this.addListener(this.$colorInput, 'change', 'updateColor');\n    },\n\n    updateColor: function() {\n        this.$input.val(this.$colorInput.val());\n        this.$input.data('garnish-textchange-value', this.$colorInput.val());\n        this.handleTextChange();\n    },\n\n    handleTextChange: function() {\n        var val = this.$input.val();\n\n        // If empty, set the preview to transparent\n        if (!val.length || val === '#') {\n            this.$colorPreview.css('background-color', '');\n            return;\n        }\n\n        // Make sure the value starts with a #\n        if (val[0] !== '#') {\n            val = '#'+val;\n            this.$input.val(val);\n            this.$input.data('garnish-textchange-value', val);\n        }\n\n        this.$colorPreview.css('background-color', val);\n\n        if (this.$colorInput) {\n            this.$colorInput.val(val);\n        }\n    }\n}, {\n    _browserSupportsColorInputs: null,\n\n    doesBrowserSupportColorInputs: function()\n    {\n        if (Craft.ColorInput._browserSupportsColorInputs === null)\n        {\n\n        }\n\n        return Craft.ColorInput._browserSupportsColorInputs;\n    }\n});\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * CP class\n */\nCraft.CP = Garnish.Base.extend(\n    {\n        authManager: null,\n\n        $nav: null,\n        $mainContainer: null,\n        $alerts: null,\n        $crumbs: null,\n        $notificationContainer: null,\n        $main: null,\n        $primaryForm: null,\n        $header: null,\n        $mainContent: null,\n        $details: null,\n        $selectedTab: null,\n        $sidebar: null,\n        $contentContainer: null,\n        $edition: null,\n\n        $collapsibleTables: null,\n\n        fixedHeader: false,\n\n        enableQueue: true,\n        jobInfo: null,\n        displayedJobInfo: null,\n        displayedJobInfoUnchanged: 1,\n        trackJobProgressTimeout: null,\n        jobProgressIcon: null,\n\n        checkingForUpdates: false,\n        forcingRefreshOnUpdatesCheck: false,\n        checkForUpdatesCallbacks: null,\n\n        init: function() {\n            // Is this session going to expire?\n            if (Craft.remainingSessionTime !== 0) {\n                this.authManager = new Craft.AuthManager();\n            }\n\n            // Find all the key elements\n            this.$nav = $('#nav');\n            this.$mainContainer = $('#main-container');\n            this.$alerts = $('#alerts');\n            this.$crumbs = $('#crumbs');\n            this.$notificationContainer = $('#notifications');\n            this.$main = $('#main');\n            this.$primaryForm = $('#main-form');\n            this.$header = $('#header');\n            this.$mainContent = $('#main-content');\n            this.$details = $('#details');\n            this.$sidebar = $('#sidebar');\n            this.$contentContainer = $('#content-container');\n            this.$collapsibleTables = $('table.collapsible');\n            this.$edition = $('#edition');\n\n            this.updateSidebarMenuLabel();\n\n            this.addListener(Garnish.$win, 'scroll', 'updateFixedHeader');\n            this.updateFixedHeader();\n\n            Garnish.$doc.ready($.proxy(function() {\n                // Update responsive tables on window resize\n                this.addListener(Garnish.$win, 'resize', 'updateResponsiveTables');\n                this.updateResponsiveTables();\n\n                // Fade the notification out two seconds after page load\n                var $errorNotifications = this.$notificationContainer.children('.error'),\n                    $otherNotifications = this.$notificationContainer.children(':not(.error)');\n\n                $errorNotifications.delay(Craft.CP.notificationDuration * 2).velocity('fadeOut');\n                $otherNotifications.delay(Craft.CP.notificationDuration).velocity('fadeOut');\n\n                // Wait a frame before initializing any confirm-unload forms,\n                // so other JS that runs on ready() has a chance to initialize\n                Garnish.requestAnimationFrame($.proxy(this, 'initConfirmUnloadForms'));\n            }, this));\n\n            // Alerts\n            if (this.$alerts.length) {\n                this.initAlerts();\n            }\n\n            // Toggles\n            this.addListener($('#nav-toggle'), 'click', 'toggleNav');\n            this.addListener($('#sidebar-toggle'), 'click', 'toggleSidebar');\n\n            // Does this page have a primary form?\n            if (!this.$primaryForm.length) {\n                this.$primaryForm = $('form[data-saveshortcut]:first');\n            }\n\n            // Does the primary form support the save shortcut?\n            if (this.$primaryForm.length && Garnish.hasAttr(this.$primaryForm, 'data-saveshortcut')) {\n                this.addListener(Garnish.$doc, 'keydown', function(ev) {\n                    if (Garnish.isCtrlKeyPressed(ev) && ev.keyCode === Garnish.S_KEY) {\n                        ev.preventDefault();\n                        this.submitPrimaryForm();\n                    }\n\n                    return true;\n                });\n            }\n\n            this.initTabs();\n\n            if (this.$edition.hasClass('hot')) {\n                this.addListener(this.$edition, 'click', function() {\n                    document.location.href = Craft.getUrl('plugin-store/upgrade-craft');\n                });\n            }\n\n            if ($.isTouchCapable()) {\n                this.$mainContainer.on('focus', 'input, textarea, .focusable-input', $.proxy(this, '_handleInputFocus'));\n                this.$mainContainer.on('blur', 'input, textarea, .focusable-input', $.proxy(this, '_handleInputBlur'));\n            }\n\n            // Open outbound links in new windows\n            // hat tip: https://stackoverflow.com/a/2911045/1688568\n            $('a').each(function() {\n                if (this.hostname.length && this.hostname !== location.hostname && typeof $(this).attr('target') === 'undefined') {\n                    $(this).attr('rel', 'noopener').attr('target', '_blank')\n                }\n            });\n        },\n\n        initConfirmUnloadForms: function() {\n            // Look for forms that we should watch for changes on\n            this.$confirmUnloadForms = $('form[data-confirm-unload]');\n\n            if (!this.$confirmUnloadForms.length) {\n                return;\n            }\n\n            var $form, serialized;\n\n            for (var i = 0; i < this.$confirmUnloadForms.length; i++) {\n                $form = this.$confirmUnloadForms.eq(i);\n                if (!$form.data('initialSerializedValue')) {\n                    if (typeof $form.data('serializer') === 'function') {\n                        serialized = $form.data('serializer')();\n                    } else {\n                        serialized = $form.serialize();\n                    }\n                    $form.data('initialSerializedValue', serialized);\n                }\n                this.addListener($form, 'submit', function() {\n                    this.removeListener(Garnish.$win, 'beforeunload');\n                });\n            }\n\n            this.addListener(Garnish.$win, 'beforeunload', function(ev) {\n                var confirmUnload = false;\n                var $form, serialized;\n                if (typeof Craft.livePreview !== 'undefined' && Craft.livePreview.inPreviewMode) {\n                    confirmUnload = true;\n                } else {\n                    for (var i = 0; i < this.$confirmUnloadForms.length; i++) {\n                        $form = this.$confirmUnloadForms.eq(i);\n                        if (typeof $form.data('serializer') === 'function') {\n                            serialized = $form.data('serializer')();\n                        } else {\n                            serialized = $form.serialize();\n                        }\n                        if ($form.data('initialSerializedValue') !== serialized) {\n                            confirmUnload = true;\n                            break;\n                        }\n                    }\n                }\n\n                if (confirmUnload) {\n                    var message = Craft.t('app', 'Any changes will be lost if you leave this page.');\n\n                    if (ev) {\n                        ev.originalEvent.returnValue = message;\n                    }\n                    else {\n                        window.event.returnValue = message;\n                    }\n\n                    return message;\n                }\n            });\n        },\n\n        _handleInputFocus: function() {\n            this.updateFixedHeader();\n        },\n\n        _handleInputBlur: function() {\n            this.updateFixedHeader();\n        },\n\n        submitPrimaryForm: function() {\n            // Give other stuff on the page a chance to prepare\n            this.trigger('beforeSaveShortcut');\n\n            if (this.$primaryForm.data('saveshortcut-redirect')) {\n                $('<input type=\"hidden\" name=\"redirect\" value=\"' + this.$primaryForm.data('saveshortcut-redirect') + '\"/>').appendTo(this.$primaryForm);\n            }\n\n            this.$primaryForm.trigger({\n                type: 'submit',\n                saveShortcut: true,\n            });\n        },\n\n        updateSidebarMenuLabel: function() {\n            var $item = this.$sidebar.find('a.sel:first');\n            var $label = $item.children('.label');\n            $('#selected-sidebar-item-label').text($label.length ? $label.text() : $item.text());\n            Garnish.$bod.removeClass('showing-sidebar');\n        },\n\n        toggleNav: function() {\n            Garnish.$bod.toggleClass('showing-nav');\n        },\n\n        toggleSidebar: function() {\n            Garnish.$bod.toggleClass('showing-sidebar');\n        },\n\n        initTabs: function() {\n            this.$selectedTab = null;\n\n            var $tabs = $('#tabs').find('> ul > li');\n            var tabs = [];\n            var tabWidths = [];\n            var totalWidth = 0;\n            var i, a, href;\n\n            for (i = 0; i < $tabs.length; i++) {\n                tabs[i] = $($tabs[i]);\n                tabWidths[i] = tabs[i].width();\n                totalWidth += tabWidths[i];\n\n                // Does it link to an anchor?\n                a = tabs[i].children('a');\n                href = a.attr('href');\n                if (href && href.charAt(0) === '#') {\n                    this.addListener(a, 'click', function(ev) {\n                        ev.preventDefault();\n                        this.selectTab(ev.currentTarget);\n                    });\n\n                    if (encodeURIComponent(href.substr(1)) === document.location.hash.substr(1)) {\n                        this.selectTab(a);\n                    }\n                }\n\n                if (!this.$selectedTab && a.hasClass('sel')) {\n                    this.$selectedTab = a;\n                }\n            }\n\n            // Now set their max widths\n            for (i = 0; i < $tabs.length; i++) {\n                tabs[i].css('max-width', (100 * tabWidths[i] / totalWidth) + '%');\n            }\n        },\n\n        selectTab: function(tab) {\n            var $tab = $(tab);\n\n            if (this.$selectedTab) {\n                if (this.$selectedTab.get(0) === $tab.get(0)) {\n                    return;\n                }\n                this.deselectTab();\n            }\n\n            $tab.addClass('sel');\n            var href = $tab.attr('href')\n            $(href).removeClass('hidden');\n            if (typeof history !== 'undefined') {\n                history.replaceState(undefined, undefined, href);\n            }\n            Garnish.$win.trigger('resize');\n            // Fixes Redactor fixed toolbars on previously hidden panes\n            Garnish.$doc.trigger('scroll');\n            this.$selectedTab = $tab;\n        },\n\n        deselectTab: function() {\n            if (!this.$selectedTab) {\n                return;\n            }\n\n            this.$selectedTab.removeClass('sel');\n            if (this.$selectedTab.attr('href').charAt(0) === '#') {\n                $(this.$selectedTab.attr('href')).addClass('hidden');\n            }\n            this.$selectedTab = null;\n        },\n\n        updateResponsiveTables: function() {\n            for (this.updateResponsiveTables._i = 0; this.updateResponsiveTables._i < this.$collapsibleTables.length; this.updateResponsiveTables._i++) {\n                this.updateResponsiveTables._$table = this.$collapsibleTables.eq(this.updateResponsiveTables._i);\n                this.updateResponsiveTables._containerWidth = this.updateResponsiveTables._$table.parent().width();\n                this.updateResponsiveTables._check = false;\n\n                if (this.updateResponsiveTables._containerWidth > 0) {\n                    // Is this the first time we've checked this table?\n                    if (typeof this.updateResponsiveTables._$table.data('lastContainerWidth') === 'undefined') {\n                        this.updateResponsiveTables._check = true;\n                    }\n                    else {\n                        this.updateResponsiveTables._isCollapsed = this.updateResponsiveTables._$table.hasClass('collapsed');\n\n                        // Getting wider?\n                        if (this.updateResponsiveTables._containerWidth > this.updateResponsiveTables._$table.data('lastContainerWidth')) {\n                            if (this.updateResponsiveTables._isCollapsed) {\n                                this.updateResponsiveTables._$table.removeClass('collapsed');\n                                this.updateResponsiveTables._check = true;\n                            }\n                        }\n                        else if (!this.updateResponsiveTables._isCollapsed) {\n                            this.updateResponsiveTables._check = true;\n                        }\n                    }\n\n                    // Are we checking the table width?\n                    if (this.updateResponsiveTables._check) {\n                        if (this.updateResponsiveTables._$table.width() > this.updateResponsiveTables._containerWidth) {\n                            this.updateResponsiveTables._$table.addClass('collapsed');\n                        }\n                    }\n\n                    // Remember the container width for next time\n                    this.updateResponsiveTables._$table.data('lastContainerWidth', this.updateResponsiveTables._containerWidth);\n                }\n            }\n        },\n\n        updateFixedHeader: function() {\n            // Have we scrolled passed the top of #main?\n            if (this.$main.length && this.$main[0].getBoundingClientRect().top < 0) {\n                if (!this.fixedHeader) {\n                    var headerHeight = this.$header.outerHeight();\n                    var css = {\n                        top: headerHeight + 'px',\n                        'max-height': 'calc(100vh - ' + headerHeight + 'px)'\n                    };\n                    this.$sidebar.css(css);\n                    this.$details.css(css);\n\n                    this.$mainContent.css('margin-top', this.$header.outerHeight());\n                    Garnish.$bod.addClass('fixed-header');\n                    this.fixedheader = true;\n                }\n            }\n            else if (this.fixedheader) {\n                Garnish.$bod.removeClass('fixed-header');\n                this.$details.css({\n                    top: null,\n                    'max-height': null\n                });\n                this.$header.css('top', 0);\n                this.$mainContent.css('margin-top', 0);\n                this.fixedheader = false;\n            }\n        },\n\n        /**\n         * Dispays a notification.\n         *\n         * @param {string} type\n         * @param {string} message\n         */\n        displayNotification: function(type, message) {\n            var notificationDuration = Craft.CP.notificationDuration;\n\n            if (type === 'error') {\n                notificationDuration *= 2;\n            }\n\n            var $notification = $('<div class=\"notification ' + type + '\">' + message + '</div>')\n                .appendTo(this.$notificationContainer);\n\n            var fadedMargin = -($notification.outerWidth() / 2) + 'px';\n\n            $notification\n                .hide()\n                .css({opacity: 0, 'margin-left': fadedMargin, 'margin-right': fadedMargin})\n                .velocity({opacity: 1, 'margin-left': '2px', 'margin-right': '2px'}, {display: 'inline-block', duration: 'fast'})\n                .delay(notificationDuration)\n                .velocity({opacity: 0, 'margin-left': fadedMargin, 'margin-right': fadedMargin}, {\n                    complete: function() {\n                        $notification.remove();\n                    }\n                });\n\n            this.trigger('displayNotification', {\n                notificationType: type,\n                message: message\n            });\n        },\n\n        /**\n         * Displays a notice.\n         *\n         * @param {string} message\n         */\n        displayNotice: function(message) {\n            this.displayNotification('notice', message);\n        },\n\n        /**\n         * Displays an error.\n         *\n         * @param {string} message\n         */\n        displayError: function(message) {\n            if (!message) {\n                message = Craft.t('app', 'An unknown error occurred.');\n            }\n\n            this.displayNotification('error', message);\n        },\n\n        fetchAlerts: function() {\n            var data = {\n                path: Craft.path\n            };\n\n            Craft.queueActionRequest('app/get-cp-alerts', data, $.proxy(this, 'displayAlerts'));\n        },\n\n        displayAlerts: function(alerts) {\n            this.$alerts.remove();\n\n            if (Garnish.isArray(alerts) && alerts.length) {\n                this.$alerts = $('<ul id=\"alerts\"/>').prependTo(this.$mainContainer);\n\n                for (var i = 0; i < alerts.length; i++) {\n                    $('<li>' + alerts[i] + '</li>').appendTo(this.$alerts);\n                }\n\n                var height = this.$alerts.outerHeight();\n                this.$alerts.css('margin-top', -height).velocity({'margin-top': 0}, 'fast');\n\n                this.initAlerts();\n            }\n        },\n\n        initAlerts: function() {\n            // Are there any shunnable alerts?\n            var $shunnableAlerts = this.$alerts.find('a[class^=\"shun:\"]');\n\n            for (var i = 0; i < $shunnableAlerts.length; i++) {\n                this.addListener($shunnableAlerts[i], 'click', $.proxy(function(ev) {\n                    ev.preventDefault();\n\n                    var $link = $(ev.currentTarget);\n\n                    var data = {\n                        message: $link.prop('className').substr(5)\n                    };\n\n                    Craft.queueActionRequest('app/shun-cp-alert', data, $.proxy(function(response, textStatus) {\n                        if (textStatus === 'success') {\n                            if (response.success) {\n                                $link.parent().remove();\n                            }\n                            else {\n                                this.displayError(response.error);\n                            }\n                        }\n\n                    }, this));\n\n                }, this));\n            }\n        },\n\n        checkForUpdates: function(forceRefresh, callback) {\n            // If forceRefresh == true, we're currently checking for updates, and not currently forcing a refresh,\n            // then just set a new callback that re-checks for updates when the current one is done.\n            if (this.checkingForUpdates && forceRefresh === true && !this.forcingRefreshOnUpdatesCheck) {\n                var realCallback = callback;\n\n                callback = function() {\n                    Craft.cp.checkForUpdates(true, realCallback);\n                };\n            }\n\n            // Callback function?\n            if (typeof callback === 'function') {\n                if (!Garnish.isArray(this.checkForUpdatesCallbacks)) {\n                    this.checkForUpdatesCallbacks = [];\n                }\n\n                this.checkForUpdatesCallbacks.push(callback);\n            }\n\n            if (!this.checkingForUpdates) {\n                this.checkingForUpdates = true;\n                this.forcingRefreshOnUpdatesCheck = (forceRefresh === true);\n\n                var data = {\n                    forceRefresh: (forceRefresh === true)\n                };\n\n                Craft.queueActionRequest('app/check-for-updates', data, $.proxy(function(info) {\n                    this.updateUtilitiesBadge();\n                    this.checkingForUpdates = false;\n\n                    if (Garnish.isArray(this.checkForUpdatesCallbacks)) {\n                        var callbacks = this.checkForUpdatesCallbacks;\n                        this.checkForUpdatesCallbacks = null;\n\n                        for (var i = 0; i < callbacks.length; i++) {\n                            callbacks[i](info);\n                        }\n                    }\n\n                    this.trigger('checkForUpdates', {\n                        updateInfo: info\n                    });\n                }, this));\n            }\n        },\n\n        updateUtilitiesBadge: function() {\n            var $utilitiesLink = $('#nav-utilities').find('> a:not(.sel)');\n\n            // Ignore if there is no (non-selected) Utilities nav item\n            if (!$utilitiesLink.length) {\n                return;\n            }\n\n            Craft.queueActionRequest('app/get-utilities-badge-count', $.proxy(function(response) {\n                // Get the existing utility nav badge, if any\n                var $badge = $utilitiesLink.children('.badge');\n\n                if (response.badgeCount) {\n                    if (!$badge.length) {\n                        $badge = $('<span class=\"badge\"/>').appendTo($utilitiesLink);\n                    }\n                    $badge.text(response.badgeCount);\n                } else if ($badge.length) {\n                    $badge.remove();\n                }\n            }, this));\n        },\n\n        runQueue: function() {\n            if (!this.enableQueue) {\n                return;\n            }\n\n            if (Craft.runQueueAutomatically) {\n                Craft.queueActionRequest('queue/run', $.proxy(function(response, textStatus) {\n                    if (textStatus === 'success') {\n                        this.trackJobProgress(false, true);\n                    }\n                }, this));\n            }\n            else {\n                this.trackJobProgress(false, true);\n            }\n        },\n\n        trackJobProgress: function(delay, force) {\n            if (force && this.trackJobProgressTimeout) {\n                clearTimeout(this.trackJobProgressTimeout);\n                this.trackJobProgressTimeout = null;\n            }\n\n            // Ignore if we're already tracking jobs, or the queue is disabled\n            if (this.trackJobProgressTimeout || !this.enableQueue) {\n                return;\n            }\n\n            if (delay === true) {\n                // Determine the delay based on how long the displayed job info has remained unchanged\n                var timeout = Math.min(60000, this.displayedJobInfoUnchanged * 500);\n                this.trackJobProgressTimeout = setTimeout($.proxy(this, '_trackJobProgressInternal'), timeout);\n            } else {\n                this._trackJobProgressInternal();\n            }\n        },\n\n        _trackJobProgressInternal: function() {\n            Craft.queueActionRequest('queue/get-job-info?dontExtendSession=1', $.proxy(function(response, textStatus) {\n                if (textStatus === 'success') {\n                    this.trackJobProgressTimeout = null;\n                    this.setJobInfo(response, true);\n\n                    if (this.jobInfo.length) {\n                        // Check again after a delay\n                        this.trackJobProgress(true);\n                    }\n                }\n            }, this));\n        },\n\n        setJobInfo: function(jobInfo, animateIcon) {\n            if (!this.enableQueue) {\n                return;\n            }\n\n            this.jobInfo = jobInfo;\n\n            // Update the displayed job info\n            var oldInfo = this.displayedJobInfo;\n            this.displayedJobInfo = this.getDisplayedJobInfo();\n\n            // Same old same old?\n            if (\n                oldInfo &&\n                this.displayedJobInfo &&\n                oldInfo.id === this.displayedJobInfo.id &&\n                oldInfo.progress === this.displayedJobInfo.progress &&\n                oldInfo.progressLabel === this.displayedJobInfo.progressLabel &&\n                oldInfo.status === this.displayedJobInfo.status\n            ) {\n                this.displayedJobInfoUnchanged++;\n            } else {\n                // Reset the counter\n                this.displayedJobInfoUnchanged = 1;\n            }\n\n            this.updateJobIcon(animateIcon);\n\n            // Fire a setJobInfo event\n            this.trigger('setJobInfo');\n        },\n\n        /**\n         * Returns info for the job that should be displayed in the CP sidebar\n         */\n        getDisplayedJobInfo: function() {\n            if (!this.enableQueue) {\n                return null;\n            }\n\n            // Set the status preference order\n            var statuses = [\n                Craft.CP.JOB_STATUS_RESERVED,\n                Craft.CP.JOB_STATUS_FAILED,\n                Craft.CP.JOB_STATUS_WAITING\n            ];\n\n            for (var i = 0; i < statuses.length; i++) {\n                for (var j = 0; j < this.jobInfo.length; j++) {\n                    if (this.jobInfo[j].status === statuses[i]) {\n                        return this.jobInfo[j];\n                    }\n                }\n            }\n        },\n\n        updateJobIcon: function(animate) {\n            if (!this.enableQueue || !this.$nav.length) {\n                return;\n            }\n\n            if (this.displayedJobInfo) {\n                if (!this.jobProgressIcon) {\n                    this.jobProgressIcon = new JobProgressIcon();\n                }\n\n                if (this.displayedJobInfo.status === Craft.CP.JOB_STATUS_RESERVED || this.displayedJobInfo.status === Craft.CP.JOB_STATUS_WAITING) {\n                    this.jobProgressIcon.hideFailMode();\n                    this.jobProgressIcon.setDescription(this.displayedJobInfo.description);\n                    this.jobProgressIcon.setProgress(this.displayedJobInfo.progress, animate);\n                }\n                else if (this.displayedJobInfo.status === Craft.CP.JOB_STATUS_FAILED) {\n                    this.jobProgressIcon.showFailMode(Craft.t('app', 'Failed'));\n                }\n            }\n            else {\n                if (this.jobProgressIcon) {\n                    this.jobProgressIcon.hideFailMode();\n                    this.jobProgressIcon.complete();\n                    delete this.jobProgressIcon;\n                }\n            }\n        }\n    },\n    {\n        //maxWidth: 1051, //1024,\n        notificationDuration: 2000,\n\n        JOB_STATUS_WAITING: 1,\n        JOB_STATUS_RESERVED: 2,\n        JOB_STATUS_DONE: 3,\n        JOB_STATUS_FAILED: 4\n    });\n\nGarnish.$scrollContainer = $('#content');\nCraft.cp = new Craft.CP();\n\n\n/**\n * Job progress icon class\n */\nvar JobProgressIcon = Garnish.Base.extend(\n    {\n        $li: null,\n        $a: null,\n        $label: null,\n\n        hud: null,\n        failMode: false,\n\n        _canvasSupported: null,\n\n        _$bgCanvas: null,\n        _$staticCanvas: null,\n        _$hoverCanvas: null,\n        _$failCanvas: null,\n\n        _staticCtx: null,\n        _hoverCtx: null,\n        _canvasSize: null,\n        _arcPos: null,\n        _arcRadius: null,\n        _lineWidth: null,\n\n        _arcStartPos: 0,\n        _arcEndPos: 0,\n        _arcStartStepSize: null,\n        _arcEndStepSize: null,\n        _arcStep: null,\n        _arcStepTimeout: null,\n        _arcAnimateCallback: null,\n\n        _progressBar: null,\n\n        init: function() {\n            this.$li = $('<li/>').appendTo(Craft.cp.$nav.children('ul'));\n            this.$a = $('<a id=\"job-icon\"/>').appendTo(this.$li);\n            this.$canvasContainer = $('<span class=\"icon\"/>').appendTo(this.$a);\n            this.$label = $('<span class=\"label\"></span>').appendTo(this.$a);\n\n            this._canvasSupported = !!(document.createElement('canvas').getContext);\n\n            if (this._canvasSupported) {\n                var m = (window.devicePixelRatio > 1 ? 2 : 1);\n                this._canvasSize = 18 * m;\n                this._arcPos = this._canvasSize / 2;\n                this._arcRadius = 7 * m;\n                this._lineWidth = 3 * m;\n\n                this._$bgCanvas = this._createCanvas('bg', '#61666b');\n                this._$staticCanvas = this._createCanvas('static', '#d7d9db');\n                this._$hoverCanvas = this._createCanvas('hover', '#fff');\n                this._$failCanvas = this._createCanvas('fail', '#da5a47').hide();\n\n                this._staticCtx = this._$staticCanvas[0].getContext('2d');\n                this._hoverCtx = this._$hoverCanvas[0].getContext('2d');\n\n                this._drawArc(this._$bgCanvas[0].getContext('2d'), 0, 1);\n                this._drawArc(this._$failCanvas[0].getContext('2d'), 0, 1);\n            }\n            else {\n                this._progressBar = new Craft.ProgressBar(this.$canvasContainer);\n                this._progressBar.showProgressBar();\n            }\n\n            this.addListener(this.$a, 'click', 'toggleHud');\n        },\n\n        setDescription: function(description) {\n            this.$a.attr('title', description);\n            this.$label.text(description);\n        },\n\n        setProgress: function(progress, animate) {\n            if (this._canvasSupported) {\n                if (animate) {\n                    this._animateArc(0, progress / 100);\n                }\n                else {\n                    this._setArc(0, progress / 100);\n                }\n            }\n            else {\n                this._progressBar.setProgressPercentage(progress);\n            }\n        },\n\n        complete: function() {\n            if (this._canvasSupported) {\n                this._animateArc(0, 1, $.proxy(function() {\n                    this._$bgCanvas.velocity('fadeOut');\n\n                    this._animateArc(1, 1, $.proxy(function() {\n                        this.$a.remove();\n                        this.destroy();\n                    }, this));\n                }, this));\n            }\n            else {\n                this._progressBar.setProgressPercentage(100);\n                this.$a.velocity('fadeOut');\n            }\n        },\n\n        showFailMode: function(message) {\n            if (this.failMode) {\n                return;\n            }\n\n            this.failMode = true;\n\n            if (this._canvasSupported) {\n                this._$bgCanvas.hide();\n                this._$staticCanvas.hide();\n                this._$hoverCanvas.hide();\n                this._$failCanvas.show();\n            }\n            else {\n                this._progressBar.$progressBar.css('border-color', '#da5a47');\n                this._progressBar.$innerProgressBar.css('background-color', '#da5a47');\n                this._progressBar.setProgressPercentage(50);\n            }\n\n            this.setDescription(message);\n        },\n\n        hideFailMode: function() {\n            if (!this.failMode) {\n                return;\n            }\n\n            this.failMode = false;\n\n            if (this._canvasSupported) {\n                this._$bgCanvas.show();\n                this._$staticCanvas.show();\n                this._$hoverCanvas.show();\n                this._$failCanvas.hide();\n            }\n            else {\n                this._progressBar.$progressBar.css('border-color', '');\n                this._progressBar.$innerProgressBar.css('background-color', '');\n                this._progressBar.setProgressPercentage(50);\n            }\n        },\n\n        toggleHud: function() {\n            if (!this.hud) {\n                this.hud = new QueueHUD();\n            }\n            else {\n                this.hud.toggle();\n            }\n        },\n\n        _createCanvas: function(id, color) {\n            var $canvas = $('<canvas id=\"job-icon-' + id + '\" width=\"' + this._canvasSize + '\" height=\"' + this._canvasSize + '\"/>').appendTo(this.$canvasContainer),\n                ctx = $canvas[0].getContext('2d');\n\n            ctx.strokeStyle = color;\n            ctx.lineWidth = this._lineWidth;\n            ctx.lineCap = 'round';\n            return $canvas;\n        },\n\n        _setArc: function(startPos, endPos) {\n            this._arcStartPos = startPos;\n            this._arcEndPos = endPos;\n\n            this._drawArc(this._staticCtx, startPos, endPos);\n            this._drawArc(this._hoverCtx, startPos, endPos);\n        },\n\n        _drawArc: function(ctx, startPos, endPos) {\n            ctx.clearRect(0, 0, this._canvasSize, this._canvasSize);\n            ctx.beginPath();\n            ctx.arc(this._arcPos, this._arcPos, this._arcRadius, (1.5 + (startPos * 2)) * Math.PI, (1.5 + (endPos * 2)) * Math.PI);\n            ctx.stroke();\n            ctx.closePath();\n        },\n\n        _animateArc: function(targetStartPos, targetEndPos, callback) {\n            if (this._arcStepTimeout) {\n                clearTimeout(this._arcStepTimeout);\n            }\n\n            this._arcStep = 0;\n            this._arcStartStepSize = (targetStartPos - this._arcStartPos) / 10;\n            this._arcEndStepSize = (targetEndPos - this._arcEndPos) / 10;\n            this._arcAnimateCallback = callback;\n            this._takeNextArcStep();\n        },\n\n        _takeNextArcStep: function() {\n            this._setArc(this._arcStartPos + this._arcStartStepSize, this._arcEndPos + this._arcEndStepSize);\n\n            this._arcStep++;\n\n            if (this._arcStep < 10) {\n                this._arcStepTimeout = setTimeout($.proxy(this, '_takeNextArcStep'), 50);\n            }\n            else if (this._arcAnimateCallback) {\n                this._arcAnimateCallback();\n            }\n        }\n    });\n\nvar QueueHUD = Garnish.HUD.extend(\n    {\n        jobsById: null,\n        completedJobs: null,\n        updateViewProxy: null,\n\n        init: function() {\n            this.jobsById = {};\n            this.completedJobs = [];\n            this.updateViewProxy = $.proxy(this, 'updateView');\n\n            this.base(Craft.cp.jobProgressIcon.$a);\n\n            this.$main.attr('id', 'queue-hud');\n        },\n\n        onShow: function() {\n            Craft.cp.on('setJobInfo', this.updateViewProxy);\n            this.updateView();\n            this.base();\n        },\n\n        onHide: function() {\n            Craft.cp.off('setJobInfo', this.updateViewProxy);\n\n            // Clear out any completed jobs\n            if (this.completedJobs.length) {\n                for (var i = 0; i < this.completedJobs.length; i++) {\n                    this.completedJobs[i].destroy();\n                }\n\n                this.completedJobs = [];\n            }\n\n            this.base();\n        },\n\n        updateView: function() {\n            // First remove any jobs that have completed\n            var newJobIds = [];\n\n            var i;\n\n            if (Craft.cp.jobInfo) {\n                for (i = 0; i < Craft.cp.jobInfo.length; i++) {\n                    newJobIds.push(parseInt(Craft.cp.jobInfo[i].id));\n                }\n            }\n\n            for (var id in this.jobsById) {\n                if (!this.jobsById.hasOwnProperty(id)) {\n                    continue;\n                }\n                if (!Craft.inArray(parseInt(id), newJobIds)) {\n                    this.jobsById[id].complete();\n                    this.completedJobs.push(this.jobsById[id]);\n                    delete this.jobsById[id];\n                }\n            }\n\n            // Now display the jobs that are still around\n            if (Craft.cp.jobInfo && Craft.cp.jobInfo.length) {\n                for (i = 0; i < Craft.cp.jobInfo.length; i++) {\n                    var info = Craft.cp.jobInfo[i];\n\n                    if (this.jobsById[info.id]) {\n                        this.jobsById[info.id].updateStatus(info);\n                    }\n                    else {\n                        this.jobsById[info.id] = new QueueHUD.Job(this, info);\n\n                        // Place it before the next already known job\n                        var placed = false;\n                        for (var j = i + 1; j < Craft.cp.jobInfo.length; j++) {\n                            if (this.jobsById[Craft.cp.jobInfo[j].id]) {\n                                this.jobsById[info.id].$container.insertBefore(this.jobsById[Craft.cp.jobInfo[j].id].$container);\n                                placed = true;\n                                break;\n                            }\n                        }\n\n                        if (!placed) {\n                            // Place it before the resize <object> if there is one\n                            var $object = this.$main.children('object');\n                            if ($object.length) {\n                                this.jobsById[info.id].$container.insertBefore($object);\n                            }\n                            else {\n                                this.jobsById[info.id].$container.appendTo(this.$main);\n                            }\n                        }\n                    }\n                }\n            }\n            else {\n                this.hide();\n            }\n        }\n    });\n\nQueueHUD.Job = Garnish.Base.extend(\n    {\n        hud: null,\n        id: null,\n        description: null,\n\n        status: null,\n        progress: null,\n\n        $container: null,\n        $statusContainer: null,\n        $descriptionContainer: null,\n        $progressLabel: null,\n\n        _progressBar: null,\n\n        init: function(hud, info) {\n            this.hud = hud;\n\n            this.id = info.id;\n            this.description = info.description;\n\n            this.$container = $('<div/>', { 'class': 'job' });\n            var $flex = $('<div/>', { 'class': 'flex' }).appendTo(this.$container);\n            $('<div/>', { 'class': 'flex-grow' }).text(info.description).appendTo($flex);\n            this.$statusContainer = $('<div class=\"job-status\"/>').appendTo($flex);\n\n            this.$container.data('job', this);\n\n            this.updateStatus(info);\n        },\n\n        updateStatus: function(info) {\n            if (this.status !== (this.status = info.status)) {\n                this.$statusContainer.empty();\n\n                switch (this.status) {\n                    case Craft.CP.JOB_STATUS_WAITING: {\n                        this.$statusContainer.text(Craft.t('app', 'Pending'));\n                        break;\n                    }\n                    case Craft.CP.JOB_STATUS_RESERVED: {\n                        this._progressBar = new Craft.ProgressBar(this.$statusContainer);\n                        this._progressBar.showProgressBar();\n                        break;\n                    }\n                    case Craft.CP.JOB_STATUS_FAILED: {\n                        $('<span/>', {\n                            'class': 'error',\n                            text: Craft.t('app', 'Failed'),\n                            title: info.error\n                        }).appendTo(this.$statusContainer);\n\n                        var $actionBtn = $('<a class=\"menubtn error\" title=\"' + Craft.t('app', 'Options') + '\"/>').appendTo(this.$statusContainer);\n                        $(\n                            '<div class=\"menu\">' +\n                            '<ul>' +\n                            '<li><a data-action=\"retry\">' + Craft.t('app', 'Try again') + '</a></li>' +\n                            '<li><a data-action=\"release\">' + Craft.t('app', 'Cancel') + '</a></li>' +\n                            '</ul>' +\n                            '</div>'\n                        ).appendTo(this.$statusContainer);\n\n                        new Garnish.MenuBtn($actionBtn, {\n                            onOptionSelect: $.proxy(this, 'performErrorAction')\n                        });\n\n                        break;\n                    }\n                }\n            }\n\n            if (this.status === Craft.CP.JOB_STATUS_RESERVED) {\n                this._progressBar.setProgressPercentage(info.progress);\n\n                if (info.progressLabel) {\n                    if (!this.$progressLabel) {\n                        this.$progressLabel = $('<div class=\"light smalltext\"/>').appendTo(this.$container);\n                    }\n                    this.$progressLabel.text(info.progressLabel);\n                }\n            } else if (this.$progressLabel) {\n                this.$progressLabel.remove();\n                this.$progressLabel = null;\n            }\n        },\n\n        performErrorAction: function(option) {\n            // What option did they choose?\n            switch ($(option).data('action')) {\n                case 'retry': {\n                    // Update the icon\n                    Craft.cp.displayedJobInfo.status = Craft.CP.JOB_STATUS_WAITING;\n                    Craft.cp.displayedJobInfo.progress = 0;\n                    Craft.cp.updateJobIcon(false);\n\n                    Craft.postActionRequest('queue/retry', {id: this.id}, $.proxy(function(response, textStatus) {\n                        if (textStatus === 'success') {\n                            Craft.cp.trackJobProgress(false, true);\n                        }\n                    }, this));\n                    break;\n                }\n                case 'release': {\n                    Craft.postActionRequest('queue/release', {id: this.id}, $.proxy(function(response, textStatus) {\n                        if (textStatus === 'success') {\n                            Craft.cp.trackJobProgress(false, true);\n                        }\n                    }, this));\n                }\n            }\n        },\n\n        complete: function() {\n            this.$statusContainer.empty();\n            $('<div data-icon=\"check\"/>').appendTo(this.$statusContainer);\n        },\n\n        destroy: function() {\n            if (this.hud.jobsById[this.id]) {\n                delete this.hud.jobsById[this.id];\n            }\n\n            this.$container.remove();\n            this.base();\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Customize Sources modal\n */\nCraft.CustomizeSourcesModal = Garnish.Modal.extend(\n    {\n        elementIndex: null,\n        $elementIndexSourcesContainer: null,\n\n        $sidebar: null,\n        $sourcesContainer: null,\n        $sourceSettingsContainer: null,\n        $newHeadingBtn: null,\n        $footer: null,\n        $footerBtnContainer: null,\n        $saveBtn: null,\n        $cancelBtn: null,\n        $saveSpinner: null,\n        $loadingSpinner: null,\n\n        sourceSort: null,\n        sources: null,\n        selectedSource: null,\n        updateSourcesOnSave: false,\n\n        availableTableAttributes: null,\n\n        init: function(elementIndex, settings) {\n            this.base();\n\n            this.setSettings(settings, {\n                resizable: true\n            });\n\n            this.elementIndex = elementIndex;\n            this.$elementIndexSourcesContainer = this.elementIndex.$sidebar.children('nav').children('ul');\n\n            var $container = $('<form class=\"modal customize-sources-modal\"/>').appendTo(Garnish.$bod);\n\n            this.$sidebar = $('<div class=\"cs-sidebar block-types\"/>').appendTo($container);\n            this.$sourcesContainer = $('<div class=\"sources\">').appendTo(this.$sidebar);\n            this.$sourceSettingsContainer = $('<div class=\"source-settings\">').appendTo($container);\n\n            this.$footer = $('<div class=\"footer\"/>').appendTo($container);\n            this.$footerBtnContainer = $('<div class=\"buttons right\"/>').appendTo(this.$footer);\n            this.$cancelBtn = $('<div class=\"btn\" role=\"button\"/>').text(Craft.t('app', 'Cancel')).appendTo(this.$footerBtnContainer);\n            this.$saveBtn = $('<div class=\"btn submit disabled\" role=\"button\"/>').text(Craft.t('app', 'Save')).appendTo(this.$footerBtnContainer);\n            this.$saveSpinner = $('<div class=\"spinner hidden\"/>').appendTo(this.$footerBtnContainer);\n            this.$newHeadingBtn = $('<div class=\"btn submit add icon\"/>').text(Craft.t('app', 'New heading')).appendTo($('<div class=\"buttons left secondary-buttons\"/>').appendTo(this.$footer));\n\n            this.$loadingSpinner = $('<div class=\"spinner\"/>').appendTo($container);\n\n            this.setContainer($container);\n            this.show();\n\n            var data = {\n                elementType: this.elementIndex.elementType\n            };\n\n            Craft.postActionRequest('element-index-settings/get-customize-sources-modal-data', data, $.proxy(function(response, textStatus) {\n                this.$loadingSpinner.remove();\n\n                if (textStatus === 'success') {\n                    this.$saveBtn.removeClass('disabled');\n                    this.buildModal(response);\n                }\n\n            }, this));\n\n            this.addListener(this.$newHeadingBtn, 'click', 'handleNewHeadingBtnClick');\n            this.addListener(this.$cancelBtn, 'click', 'hide');\n            this.addListener(this.$saveBtn, 'click', 'save');\n            this.addListener(this.$container, 'submit', 'save');\n        },\n\n        buildModal: function(response) {\n            // Store the available table attribute options\n            this.availableTableAttributes = response.availableTableAttributes;\n\n            // Create the source item sorter\n            this.sourceSort = new Garnish.DragSort({\n                handle: '.move',\n                axis: 'y',\n                onSortChange: $.proxy(function() {\n                    this.updateSourcesOnSave = true;\n                }, this)\n            });\n\n            // Create the sources\n            this.sources = [];\n\n            for (var i = 0; i < response.sources.length; i++) {\n                var source = this.addSource(response.sources[i]);\n                this.sources.push(source);\n            }\n\n            if (!this.selectedSource && typeof this.sources[0] !== 'undefined') {\n                this.sources[0].select();\n            }\n        },\n\n        addSource: function(sourceData) {\n            var $item = $('<div class=\"customize-sources-item\"/>').appendTo(this.$sourcesContainer);\n            var $itemLabel = $('<div class=\"label\"/>').appendTo($item);\n            var $itemInput = $('<input type=\"hidden\"/>').appendTo($item);\n            $('<a class=\"move icon\" title=\"' + Craft.t('app', 'Reorder') + '\" role=\"button\"></a>').appendTo($item);\n\n            var source;\n\n            // Is this a heading?\n            if (typeof sourceData.heading !== 'undefined') {\n                $item.addClass('heading');\n                $itemInput.attr('name', 'sourceOrder[][heading]');\n                source = new Craft.CustomizeSourcesModal.Heading(this, $item, $itemLabel, $itemInput, sourceData);\n                source.updateItemLabel(sourceData.heading);\n            }\n            else {\n                $itemInput.attr('name', 'sourceOrder[][key]').val(sourceData.key);\n                source = new Craft.CustomizeSourcesModal.Source(this, $item, $itemLabel, $itemInput, sourceData);\n                source.updateItemLabel(sourceData.label);\n\n                // Select this by default?\n                if ((this.elementIndex.sourceKey+'/').substr(0, sourceData.key.length+1) === sourceData.key+'/') {\n                    source.select();\n                }\n            }\n\n            this.sourceSort.addItems($item);\n\n            return source;\n        },\n\n        handleNewHeadingBtnClick: function() {\n            var source = this.addSource({\n                heading: ''\n            });\n\n            Garnish.scrollContainerToElement(this.$sidebar, source.$item);\n\n            source.select();\n            this.updateSourcesOnSave = true;\n        },\n\n        save: function(ev) {\n            if (ev) {\n                ev.preventDefault();\n            }\n\n            if (this.$saveBtn.hasClass('disabled') || !this.$saveSpinner.hasClass('hidden')) {\n                return;\n            }\n\n            this.$saveSpinner.removeClass('hidden');\n            var data = this.$container.serialize() + '&elementType=' + this.elementIndex.elementType;\n\n            Craft.postActionRequest('element-index-settings/save-customize-sources-modal-settings', data, $.proxy(function(response, textStatus) {\n                this.$saveSpinner.addClass('hidden');\n\n                if (textStatus === 'success' && response.success) {\n                    // Have any changes been made to the source list?\n                    if (this.updateSourcesOnSave) {\n                        if (this.$elementIndexSourcesContainer.length) {\n                            var $lastSource = null,\n                                $pendingHeading;\n\n                            for (var i = 0; i < this.sourceSort.$items.length; i++) {\n                                var $item = this.sourceSort.$items.eq(i),\n                                    source = $item.data('source'),\n                                    $indexSource = source.getIndexSource();\n\n                                if (!$indexSource) {\n                                    continue;\n                                }\n\n                                if (source.isHeading()) {\n                                    $pendingHeading = $indexSource;\n                                }\n                                else {\n                                    if ($pendingHeading) {\n                                        this.appendSource($pendingHeading, $lastSource);\n                                        $lastSource = $pendingHeading;\n                                        $pendingHeading = null;\n                                    }\n\n                                    this.appendSource($indexSource, $lastSource);\n                                    $lastSource = $indexSource;\n                                }\n                            }\n\n                            // Remove any additional sources (most likely just old headings)\n                            if ($lastSource) {\n                                var $extraSources = $lastSource.nextAll();\n                                this.elementIndex.sourceSelect.removeItems($extraSources);\n                                $extraSources.remove();\n                            }\n                        }\n                    }\n\n                    // If a source is selected, have the element index select that one by default on the next request\n                    if (this.selectedSource && this.selectedSource.sourceData.key) {\n                        this.elementIndex.selectSourceByKey(this.selectedSource.sourceData.key);\n                        this.elementIndex.updateElements();\n                    }\n\n                    Craft.cp.displayNotice(Craft.t('app', 'Source settings saved'));\n                    this.hide();\n                }\n                else {\n                    var error = (textStatus === 'success' && response.error ? response.error : Craft.t('app', 'An unknown error occurred.'));\n                    Craft.cp.displayError(error);\n                }\n            }, this));\n        },\n\n        appendSource: function($source, $lastSource) {\n            if (!$lastSource) {\n                $source.prependTo(this.$elementIndexSourcesContainer);\n            }\n            else {\n                $source.insertAfter($lastSource);\n            }\n        },\n\n        destroy: function() {\n            for (var i = 0; i < this.sources.length; i++) {\n                this.sources[i].destroy();\n            }\n\n            delete this.sources;\n            this.base();\n        }\n    });\n\nCraft.CustomizeSourcesModal.BaseSource = Garnish.Base.extend(\n    {\n        modal: null,\n\n        $item: null,\n        $itemLabel: null,\n        $itemInput: null,\n        $settingsContainer: null,\n\n        sourceData: null,\n\n        init: function(modal, $item, $itemLabel, $itemInput, sourceData) {\n            this.modal = modal;\n            this.$item = $item;\n            this.$itemLabel = $itemLabel;\n            this.$itemInput = $itemInput;\n            this.sourceData = sourceData;\n\n            this.$item.data('source', this);\n\n            this.addListener(this.$item, 'click', 'select');\n        },\n\n        isHeading: function() {\n            return false;\n        },\n\n        isSelected: function() {\n            return (this.modal.selectedSource === this);\n        },\n\n        select: function() {\n            if (this.isSelected()) {\n                return;\n            }\n\n            if (this.modal.selectedSource) {\n                this.modal.selectedSource.deselect();\n            }\n\n            this.$item.addClass('sel');\n            this.modal.selectedSource = this;\n\n            if (!this.$settingsContainer) {\n                this.$settingsContainer = $('<div/>')\n                    .append(this.createSettings())\n                    .appendTo(this.modal.$sourceSettingsContainer);\n            }\n            else {\n                this.$settingsContainer.removeClass('hidden');\n            }\n\n            this.modal.$sourceSettingsContainer.scrollTop(0);\n        },\n\n        createSettings: function() {\n        },\n\n        getIndexSource: function() {\n        },\n\n        deselect: function() {\n            this.$item.removeClass('sel');\n            this.modal.selectedSource = null;\n            this.$settingsContainer.addClass('hidden');\n        },\n\n        updateItemLabel: function(val) {\n            this.$itemLabel.text(val);\n        },\n\n        destroy: function() {\n            this.$item.data('source', null);\n            this.base();\n        }\n    });\n\nCraft.CustomizeSourcesModal.Source = Craft.CustomizeSourcesModal.BaseSource.extend(\n    {\n        createSettings: function() {\n            if (this.sourceData.tableAttributes.length) {\n                // Create the title column option\n                var firstAttribute = this.sourceData.tableAttributes[0],\n                    firstKey = firstAttribute[0],\n                    firstLabel = firstAttribute[1],\n                    $titleColumnCheckbox = this.createTableColumnOption(firstKey, firstLabel, true, true);\n\n                // Create the rest of the options\n                var $columnCheckboxes = $('<div/>'),\n                    selectedAttributes = [firstKey];\n\n                $('<input type=\"hidden\" name=\"sources[' + this.sourceData.key + '][tableAttributes][]\" value=\"\"/>').appendTo($columnCheckboxes);\n\n                var i, attribute, key, label;\n\n                // Add the selected columns, in the selected order\n                for (i = 1; i < this.sourceData.tableAttributes.length; i++) {\n                    attribute = this.sourceData.tableAttributes[i];\n                    key = attribute[0];\n                    label = attribute[1];\n\n                    $columnCheckboxes.append(this.createTableColumnOption(key, label, false, true));\n                    selectedAttributes.push(key);\n                }\n\n                // Add the rest\n                for (i = 0; i < this.modal.availableTableAttributes.length; i++) {\n                    attribute = this.modal.availableTableAttributes[i];\n                    key = attribute[0];\n                    label = attribute[1];\n\n                    if (!Craft.inArray(key, selectedAttributes)) {\n                        $columnCheckboxes.append(this.createTableColumnOption(key, label, false, false));\n                    }\n                }\n\n                new Garnish.DragSort($columnCheckboxes.children(), {\n                    handle: '.move',\n                    axis: 'y'\n                });\n\n                return Craft.ui.createField($([$titleColumnCheckbox[0], $columnCheckboxes[0]]), {\n                    label: Craft.t('app', 'Table Columns'),\n                    instructions: Craft.t('app', 'Choose which table columns should be visible for this source, and in which order.')\n                });\n            }\n        },\n\n        createTableColumnOption: function(key, label, first, checked) {\n            var $option = $('<div class=\"customize-sources-table-column\"/>')\n                .append('<div class=\"icon move\"/>')\n                .append(\n                    Craft.ui.createCheckbox({\n                        label: label,\n                        name: 'sources[' + this.sourceData.key + '][tableAttributes][]',\n                        value: key,\n                        checked: checked,\n                        disabled: first\n                    })\n                );\n\n            if (first) {\n                $option.children('.move').addClass('disabled');\n            }\n\n            return $option;\n        },\n\n        getIndexSource: function() {\n            var $source = this.modal.elementIndex.getSourceByKey(this.sourceData.key);\n\n            if ($source) {\n                return $source.closest('li');\n            }\n        }\n    });\n\nCraft.CustomizeSourcesModal.Heading = Craft.CustomizeSourcesModal.BaseSource.extend(\n    {\n        $labelField: null,\n        $labelInput: null,\n        $deleteBtn: null,\n\n        isHeading: function() {\n            return true;\n        },\n\n        select: function() {\n            this.base();\n            this.$labelInput.trigger('focus');\n        },\n\n        createSettings: function() {\n            this.$labelField = Craft.ui.createTextField({\n                label: Craft.t('app', 'Heading'),\n                instructions: Craft.t('app', 'This can be left blank if you just want an unlabeled separator.'),\n                value: this.sourceData.heading\n            });\n\n            this.$labelInput = this.$labelField.find('.text');\n\n            this.$deleteBtn = $('<a class=\"error delete\"/>').text(Craft.t('app', 'Delete heading'));\n\n            this.addListener(this.$labelInput, 'textchange', 'handleLabelInputChange');\n            this.addListener(this.$deleteBtn, 'click', 'deleteHeading');\n\n            return $([\n                this.$labelField[0],\n                $('<hr/>')[0],\n                this.$deleteBtn[0]\n            ]);\n        },\n\n        handleLabelInputChange: function() {\n            this.updateItemLabel(this.$labelInput.val());\n            this.modal.updateSourcesOnSave = true;\n        },\n\n        updateItemLabel: function(val) {\n            this.$itemLabel.html((val ? Craft.escapeHtml(val) : '<em class=\"light\">' + Craft.t('app', '(blank)') + '</em>') + '&nbsp;');\n            this.$itemInput.val(val);\n        },\n\n        deleteHeading: function() {\n            this.modal.sourceSort.removeItems(this.$item);\n            this.modal.sources.splice($.inArray(this, this.modal.sources), 1);\n            this.modal.updateSourcesOnSave = true;\n\n            if (this.isSelected()) {\n                this.deselect();\n\n                if (this.modal.sources.length) {\n                    this.modal.sources[0].select();\n                }\n            }\n\n            this.$item.remove();\n            this.$settingsContainer.remove();\n            this.destroy();\n        },\n\n        getIndexSource: function() {\n            var label = (this.$labelInput ? this.$labelInput.val() : this.sourceData.heading);\n            return $('<li class=\"heading\"/>').append($('<span/>').text(label));\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * DataTableSorter\n */\nCraft.DataTableSorter = Garnish.DragSort.extend(\n    {\n        $table: null,\n\n        init: function(table, settings) {\n            this.$table = $(table);\n            var $rows = this.$table.children('tbody').children(':not(.filler)');\n\n            settings = $.extend({}, Craft.DataTableSorter.defaults, settings);\n\n            settings.container = this.$table.children('tbody');\n            settings.helper = $.proxy(this, 'getHelper');\n            settings.caboose = '<tr/>';\n            settings.axis = Garnish.Y_AXIS;\n            settings.magnetStrength = 4;\n            settings.helperLagBase = 1.5;\n\n            this.base($rows, settings);\n        },\n\n        getHelper: function($helperRow) {\n            var $helper = $('<div class=\"' + this.settings.helperClass + '\"/>').appendTo(Garnish.$bod),\n                $table = $('<table/>').appendTo($helper),\n                $tbody = $('<tbody/>').appendTo($table);\n\n            $helperRow.appendTo($tbody);\n\n            // Copy the table width and classes\n            $table.width(this.$table.width());\n            $table.prop('className', this.$table.prop('className'));\n\n            // Copy the column widths\n            var $firstRow = this.$table.find('tr:first'),\n                $cells = $firstRow.children(),\n                $helperCells = $helperRow.children();\n\n            for (var i = 0; i < $helperCells.length; i++) {\n                $($helperCells[i]).width($($cells[i]).width());\n            }\n\n            return $helper;\n        }\n\n    },\n    {\n        defaults: {\n            handle: '.move',\n            helperClass: 'datatablesorthelper'\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Delete User Modal\n */\nCraft.DeleteUserModal = Garnish.Modal.extend(\n    {\n        id: null,\n        userId: null,\n\n        $deleteActionRadios: null,\n        $deleteSpinner: null,\n\n        userSelect: null,\n        _deleting: false,\n\n        init: function(userId, settings) {\n            this.id = Math.floor(Math.random() * 1000000000);\n            this.userId = userId;\n            settings = $.extend(Craft.DeleteUserModal.defaults, settings);\n\n            var $form = $(\n                    '<form class=\"modal fitted deleteusermodal\" method=\"post\" accept-charset=\"UTF-8\">' +\n                    Craft.getCsrfInput() +\n                    '<input type=\"hidden\" name=\"action\" value=\"users/delete-user\"/>' +\n                    (!Garnish.isArray(this.userId) ? '<input type=\"hidden\" name=\"userId\" value=\"' + this.userId + '\"/>' : '') +\n                    (settings.redirect ? '<input type=\"hidden\" name=\"redirect\" value=\"' + settings.redirect + '\"/>' : '') +\n                    '</form>'\n                ).appendTo(Garnish.$bod),\n                $body = $(\n                    '<div class=\"body\">' +\n                    '<div class=\"content-summary\">' +\n                    '<p>' + Craft.t('app', 'What do you want to do with their content?') + '</p>' +\n                    '<ul class=\"bullets\"></ul>' +\n                    '</div>' +\n                    '<div class=\"options\">' +\n                    '<label><input type=\"radio\" name=\"contentAction\" value=\"transfer\"/> ' + Craft.t('app', 'Transfer it to:') + '</label>' +\n                    '<div id=\"transferselect' + this.id + '\" class=\"elementselect\">' +\n                    '<div class=\"elements\"></div>' +\n                    '<div class=\"btn add icon dashed\">' + Craft.t('app', 'Choose a user') + '</div>' +\n                    '</div>' +\n                    '</div>' +\n                    '<div>' +\n                    '<label class=\"error\"><input type=\"radio\" name=\"contentAction\" value=\"delete\"/> ' + Craft.t('app', 'Delete it') + '</label>' +\n                    '</div>' +\n                    '</div>'\n                ).appendTo($form),\n                $buttons = $('<div class=\"buttons right\"/>').appendTo($body),\n                $cancelBtn = $('<div class=\"btn\">' + Craft.t('app', 'Cancel') + '</div>').appendTo($buttons);\n\n            if (settings.contentSummary.length) {\n                for (var i = 0; i < settings.contentSummary.length; i++) {\n                    $body.find('ul').append($('<li/>', { text: settings.contentSummary[i] }));\n                }\n            } else {\n                $body.find('ul').remove();\n            }\n\n            this.$deleteActionRadios = $body.find('input[type=radio]');\n            this.$deleteSubmitBtn = $('<input type=\"submit\" class=\"btn submit disabled\" value=\"' + (Garnish.isArray(this.userId) ? Craft.t('app', 'Delete users') : Craft.t('app', 'Delete user')) + '\" />').appendTo($buttons);\n            this.$deleteSpinner = $('<div class=\"spinner hidden\"/>').appendTo($buttons);\n\n            var idParam;\n\n            if (Garnish.isArray(this.userId)) {\n                idParam = ['and'];\n\n                for (var i = 0; i < this.userId.length; i++) {\n                    idParam.push('not ' + this.userId[i]);\n                }\n            }\n            else {\n                idParam = 'not ' + this.userId;\n            }\n\n            this.userSelect = new Craft.BaseElementSelectInput({\n                id: 'transferselect' + this.id,\n                name: 'transferContentTo',\n                elementType: 'craft\\\\elements\\\\User',\n                criteria: {\n                    id: idParam\n                },\n                limit: 1,\n                modalSettings: {\n                    closeOtherModals: false\n                },\n                onSelectElements: $.proxy(function() {\n                    this.updateSizeAndPosition();\n\n                    if (!this.$deleteActionRadios.first().prop('checked')) {\n                        this.$deleteActionRadios.first().trigger('click');\n                    }\n                    else {\n                        this.validateDeleteInputs();\n                    }\n                }, this),\n                onRemoveElements: $.proxy(this, 'validateDeleteInputs'),\n                selectable: false,\n                editable: false\n            });\n\n            this.addListener($cancelBtn, 'click', 'hide');\n\n            this.addListener(this.$deleteActionRadios, 'change', 'validateDeleteInputs');\n            this.addListener($form, 'submit', 'handleSubmit');\n\n            this.base($form, settings);\n        },\n\n        validateDeleteInputs: function() {\n            var validates = false;\n\n            if (this.$deleteActionRadios.eq(0).prop('checked')) {\n                validates = !!this.userSelect.totalSelected;\n            }\n            else if (this.$deleteActionRadios.eq(1).prop('checked')) {\n                validates = true;\n            }\n\n            if (validates) {\n                this.$deleteSubmitBtn.removeClass('disabled');\n            }\n            else {\n                this.$deleteSubmitBtn.addClass('disabled');\n            }\n\n            return validates;\n        },\n\n        handleSubmit: function(ev) {\n            if (this._deleting || !this.validateDeleteInputs()) {\n                ev.preventDefault();\n                return;\n            }\n\n            this.$deleteSubmitBtn.addClass('active');\n            this.$deleteSpinner.removeClass('hidden');\n            this.disable();\n            this.userSelect.disable();\n            this._deleting = true;\n\n            // Let the onSubmit callback prevent the form from getting submitted\n            if (this.settings.onSubmit() === false) {\n                ev.preventDefault();\n            }\n        },\n\n        onFadeIn: function() {\n            // Auto-focus the first radio\n            if (!Garnish.isMobileBrowser(true)) {\n                this.$deleteActionRadios.first().trigger('focus');\n            }\n\n            this.base();\n        }\n    },\n    {\n        defaults: {\n            contentSummary: [],\n            onSubmit: $.noop,\n            redirect: null\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Element Monitor\n */\nCraft.DraftEditor = Garnish.Base.extend(\n    {\n        $revisionBtn: null,\n        $revisionLabel: null,\n        $spinner: null,\n        $statusIcon: null,\n\n        $editMetaBtn: null,\n        metaHud: null,\n        $nameTextInput: null,\n        $notesTextInput: null,\n        $saveMetaBtn: null,\n\n        lastSerializedValue: null,\n        timeout: null,\n        saving: false,\n        saveXhr: null,\n        checkFormAfterUpdate: false,\n        submittingForm: false,\n\n        duplicatedElements: null,\n        errors: null,\n\n        preview: null,\n        previewToken: null,\n\n        init: function(settings) {\n            this.setSettings(settings, Craft.DraftEditor.defaults);\n\n            this.duplicatedElements = {};\n\n            this.$revisionBtn = $('#revision-btn');\n            this.$revisionLabel = $('#revision-label');\n            this.$spinner = $('#revision-spinner');\n            this.$statusIcon = $('#revision-status');\n\n            if (this.settings.previewTargets.length) {\n                if (this.settings.enablePreview) {\n                    this.addListener($('#preview-btn'), 'click', 'openPreview');\n                }\n\n                var $shareBtn = $('#share-btn');\n\n                if (this.settings.previewTargets.length === 1) {\n                    this.addListener($shareBtn, 'click', function() {\n                        this.openShareLink(this.settings.previewTargets[0].url);\n                    });\n                } else {\n                    this.createShareMenu($shareBtn);\n                }\n            }\n\n            // If this is a revision, we're done here\n            if (this.settings.revisionId) {\n                return;\n            }\n\n            // Store the initial form value\n            this.lastSerializedValue = this.serializeForm(true);\n            Craft.cp.$primaryForm.data('initialSerializedValue', this.lastSerializedValue);\n\n            // Override the serializer to use our own\n            Craft.cp.$primaryForm.data('serializer', function() {\n                return this.serializeForm(true)\n            }.bind(this));\n\n            if (this.settings.draftId) {\n                this.initForDraft();\n            } else {\n                // If the \"Save as a Draft\" button is a secondary button, then add special handling for it\n                this.addListener($('#save-draft-btn'), 'click', function(ev) {\n                    ev.preventDefault();\n                    this.createDraft();\n                    this.removeListener(Craft.cp.$primaryForm, 'submit.saveShortcut');\n                }.bind(this));\n\n                // If they're not allowed to update the source element, override the save shortcut to create a draft too\n                if (!this.settings.canUpdateSource) {\n                    this.addListener(Craft.cp.$primaryForm, 'submit.saveShortcut', function(ev) {\n                        if (ev.saveShortcut) {\n                            ev.preventDefault();\n                            this.createDraft();\n                            this.removeListener(Craft.cp.$primaryForm, 'submit.saveShortcut');\n                        }\n                    }.bind(this));\n                }\n            }\n        },\n\n        initForDraft: function() {\n            // Create the edit draft button\n            this.createEditMetaBtn();\n\n            this.addListener(Garnish.$bod, 'keypress keyup change focus blur click mousedown mouseup', function(ev) {\n                if ($(ev.target).is(this.statusIcons())) {\n                    return;\n                }\n                clearTimeout(this.timeout);\n                // If they are typing, wait half a second before checking the form\n                if (Craft.inArray(ev.type, ['keypress', 'keyup', 'change'])) {\n                    this.timeout = setTimeout(this.checkForm.bind(this), 500);\n                } else {\n                    this.checkForm();\n                }\n            });\n\n            this.addListener(Craft.cp.$primaryForm, 'submit', 'handleFormSubmit');\n            this.addListener(this.$statusIcon, 'click', function() {\n                this.showStatusHud(this.$statusIcon);\n            }.bind(this));\n        },\n\n        showStatusHud: function(target) {\n            var bodyHtml;\n\n            if (this.errors === null) {\n                bodyHtml = '<p>' + Craft.t('app', 'The draft has been saved.') + '</p>';\n            } else {\n                var bodyHtml = '<p class=\"error\">' + Craft.t('app', 'The draft could not be saved.') + '</p>';\n\n                if (this.errors.length) {\n                    bodyHtml += '<ul class=\"errors\">';\n                    for (i = 0; i < this.errors.length; i++) {\n                        bodyHtml += '<li>' + Craft.escapeHtml(this.errors[i]) + '</li>';\n                    }\n                    bodyHtml += '</ul>';\n                }\n            }\n\n            var hud = new Garnish.HUD(target, bodyHtml, {\n                onHide: function() {\n                    hud.destroy();\n                    delete hud;\n                }\n            });\n        },\n\n        spinners: function() {\n            return this.preview\n                ? this.$spinner.add(this.preview.$spinner)\n                : this.$spinner;\n        },\n\n        statusIcons: function() {\n            return this.preview\n                ? this.$statusIcon.add(this.preview.$statusIcon)\n                : this.$statusIcon;\n        },\n\n        createEditMetaBtn: function() {\n            this.$editMetaBtn = $('<a/>', {\n                'class': 'btn edit icon',\n                title: Craft.t('app', 'Edit draft settings'),\n            }).appendTo($('#revision-btngroup'));\n            this.addListener(this.$editMetaBtn, 'click', 'showMetaHud');\n        },\n\n        createShareMenu: function($shareBtn) {\n            $shareBtn.addClass('menubtn');\n\n            var $menu = $('<div/>', {'class': 'menu'}).insertAfter($shareBtn);\n            var $ul = $('<ul/>').appendTo($menu);\n            var $li, $a;\n            var $a;\n\n            for (var i = 0; i < this.settings.previewTargets.length; i++) {\n                $li = $('<li/>').appendTo($ul);\n                $a = $('<a/>', {\n                    text: this.settings.previewTargets[i].label,\n                }).appendTo($li);\n                this.addListener($a, 'click', {\n                    target: i,\n                }, function(ev) {\n                    this.openShareLink(this.settings.previewTargets[ev.data.target].url);\n                }.bind(this));\n            }\n        },\n\n        getPreviewToken: function() {\n            return new Promise(function(resolve, reject) {\n                if (this.previewToken) {\n                    resolve(this.previewToken);\n                    return;\n                }\n\n                Craft.postActionRequest('preview/create-token', {\n                    elementType: this.settings.elementType,\n                    sourceId: this.settings.sourceId,\n                    siteId: this.settings.siteId,\n                    draftId: this.settings.draftId,\n                    revisionId: this.settings.revisionId,\n                }, function(response, textStatus) {\n                    if (textStatus === 'success') {\n                        this.previewToken = response.token;\n                        resolve(this.previewToken);\n                    } else {\n                        reject();\n                    }\n                }.bind(this));\n            }.bind(this));\n        },\n\n        getTokenizedPreviewUrl: function(url, randoParam) {\n            return new Promise(function(resolve, reject) {\n                var params = {};\n\n                if (randoParam || !this.settings.isLive) {\n                    // Randomize the URL so CDNs don't return cached pages\n                    params[randoParam || 'x-craft-preview'] = Craft.randomString(10);\n                }\n\n                // No need for a token if we're looking at a live element\n                if (this.settings.isLive) {\n                    resolve(Craft.getUrl(url, params));\n                    return;\n                }\n\n                this.getPreviewToken().then(function(token) {\n                    params[Craft.tokenParam] = token;\n                    resolve(Craft.getUrl(url, params));\n                }).catch(reject);\n            }.bind(this));\n        },\n\n        openShareLink: function(url) {\n            this.getTokenizedPreviewUrl(url).then(function(url) {\n                window.open(url);\n            });\n        },\n\n        getPreview: function() {\n            if (!this.preview) {\n                this.preview = new Craft.Preview(this);\n            }\n            return this.preview;\n        },\n\n        openPreview: function() {\n            return new Promise(function(resolve, reject) {\n                this.ensureIsDraftOrRevision()\n                    .then(function() {\n                        this.getPreview().open();\n                        resolve();\n                    }.bind(this))\n                    .catch(reject);\n            }.bind(this))\n        },\n\n        ensureIsDraftOrRevision: function() {\n            return new Promise(function(resolve, reject) {\n                if (!this.settings.draftId && !this.settings.revisionid) {\n                    this.createDraft()\n                        .then(resolve)\n                        .catch(reject);\n                } else {\n                    resolve();\n                }\n            }.bind(this));\n        },\n\n        serializeForm: function(removeActionParams) {\n            var data = Craft.cp.$primaryForm.serialize();\n\n            if (this.isPreviewActive()) {\n                // Replace the temp input with the preview form data\n                data = data.replace('__PREVIEW_FIELDS__=1', this.preview.$editor.serialize());\n            }\n\n            if (removeActionParams && !this.settings.isUnsavedDraft) {\n                // Remove action and redirect params\n                data = data.replace(/&action=[^&]*/, '');\n                data = data.replace(/&redirect=[^&]*/, '');\n            }\n\n            return data;\n        },\n\n        checkForm: function(force) {\n            // If this isn't a draft, then there's nothing to check\n            if (!this.settings.draftId) {\n                return;\n            }\n\n            clearTimeout(this.timeout);\n            this.timeout = null;\n\n            // Has anything changed?\n            var data = this.serializeForm(true);\n            if (force || (data !== this.lastSerializedValue)) {\n                this.saveDraft(data);\n            }\n        },\n\n        isPreviewActive: function() {\n            return this.preview && this.preview.isActive;\n        },\n\n        createDraft: function() {\n            return new Promise(function(resolve, reject) {\n                this.saveDraft(this.serializeForm(true))\n                    .then(resolve)\n                    .catch(reject);\n            }.bind(this));\n        },\n\n        saveDraft: function(data) {\n            return new Promise(function(resolve, reject) {\n                // Ignore if we're already submitting the main form\n                if (this.submittingForm) {\n                    reject();\n                    return;\n                }\n\n                this.lastSerializedValue = data;\n\n                if (this.saving) {\n                    this.checkFormAfterUpdate = true;\n                    return;\n                }\n\n                this.saving = true;\n                var $spinners = this.spinners().removeClass('hidden');\n                var $statusIcons = this.statusIcons().removeClass('invisible checkmark-icon alert-icon').addClass('hidden');\n                if (this.$saveMetaBtn) {\n                    this.$saveMetaBtn.addClass('active');\n                }\n                this.errors = null;\n\n                var url = Craft.getActionUrl(this.settings.saveDraftAction);\n                var i;\n\n                this.saveXhr = Craft.postActionRequest(url, this.prepareData(data), function(response, textStatus) {\n                    $spinners.addClass('hidden');\n                    if (this.$saveMetaBtn) {\n                        this.$saveMetaBtn.removeClass('active');\n                    }\n                    this.saving = false;\n\n                    if (textStatus === 'abort') {\n                        return;\n                    }\n\n                    if (textStatus !== 'success' || response.errors) {\n                        this.errors = (response ? response.errors : null) || [];\n                        $statusIcons\n                            .removeClass('hidden checkmark-icon')\n                            .addClass('alert-icon')\n                            .attr('title', Craft.t('app', 'The draft could not be saved.'));\n                        reject();\n                        return;\n                    }\n\n                    if (response.title) {\n                        $('#header h1').text(response.title);\n                    }\n\n                    if (response.docTitle) {\n                        document.title = response.docTitle;\n                    }\n\n                    this.$revisionLabel.text(response.draftName);\n\n                    this.settings.draftName = response.draftName;\n                    this.settings.draftNotes = response.draftNotes;\n\n                    var revisionMenu = this.$revisionBtn.data('menubtn') ? this.$revisionBtn.data('menubtn').menu : null;\n\n                    // Did we just create a draft?\n                    var draftCreated = !this.settings.draftId;\n                    if (draftCreated) {\n                        // Update the document location HREF\n                        var newHref;\n                        var anchorPos = document.location.href.search('#');\n                        if (anchorPos !== -1) {\n                            newHref = document.location.href.substr(0, anchorPos);\n                        } else {\n                            newHref = document.location.href;\n                        }\n                        newHref += (newHref.match(/\\?/) ? '&' : '?') + 'draftId=' + response.draftId;\n                        if (anchorPos !== -1) {\n                            newHref += document.location.href.substr(anchorPos);\n                        }\n                        history.replaceState({}, '', newHref);\n\n                        // Replace the Save button with an Update button, if there is one.\n                        // Otherwise, the user must not have permission to update the source element\n                        var $saveBtnContainer = $('#save-btn-container');\n                        if ($saveBtnContainer.length) {\n                            $saveBtnContainer.replaceWith($('<input/>', {\n                                type: 'submit',\n                                'class': 'btn submit',\n                                value: Craft.t('app', 'Update {type}', {type: this.settings.elementTypeDisplayName})\n                            }));\n                        }\n\n                        // Remove the \"Save as a Draft\" button\n                        var $saveDraftBtn = $('#save-draft-btn-container');\n                        $saveDraftBtn.add($saveDraftBtn.prev('.spacer')).remove();\n\n                        // Update the editor settings\n                        this.settings.draftId = response.draftId;\n                        this.settings.isLive = false;\n                        this.settings.canDeleteDraft = true;\n                        this.previewToken = null;\n                        this.initForDraft();\n\n                        // Add the draft to the revision menu\n                        if (revisionMenu) {\n                            revisionMenu.$options.filter(':not(.site-option)').removeClass('sel');\n                            var $draftsUl = revisionMenu.$container.find('.revision-group-drafts');\n                            if (!$draftsUl.length) {\n                                var $draftHeading = $('<h6/>', {\n                                    text: Craft.t('app', 'Drafts'),\n                                }).insertAfter(revisionMenu.$container.find('.revision-group-current'));\n                                $draftsUl = $('<ul/>', {\n                                    'class': 'padded revision-group-drafts',\n                                }).insertAfter($draftHeading);\n                            }\n                            var $draftLi = $('<li/>').appendTo($draftsUl);\n                            var $draftA = $('<a/>', {\n                                'class': 'sel',\n                                html: '<span class=\"draft-name\"></span> <span class=\"draft-creator light\"></span>',\n                            }).appendTo($draftLi);\n                            revisionMenu.addOptions($draftA);\n                            revisionMenu.selectOption($draftA);\n\n                            // Update the site URLs\n                            var $siteOptions = revisionMenu.$options.filter('.site-option[href]');\n                            for (var i = 0; i < $siteOptions.length; i++) {\n                                var $siteOption = $siteOptions.eq(i);\n                                $siteOption.attr('href', Craft.getUrl($siteOption.attr('href'), {draftId: response.draftId}));\n                            }\n                        }\n                    }\n\n                    if (revisionMenu) {\n                        revisionMenu.$options.filter('.sel').find('.draft-name').text(response.draftName);\n                        revisionMenu.$options.filter('.sel').find('.draft-creator').text(Craft.t('app', 'by {creator}', {\n                            creator: response.creator\n                        }));\n                    }\n\n                    // Did the controller send us updated preview targets?\n                    if (\n                        response.previewTargets &&\n                        JSON.stringify(response.previewTargets) !== JSON.stringify(this.settings.previewTargets)\n                    ) {\n                        this.updatePreviewTargets(response.previewTargets);\n                    }\n\n                    this.afterUpdate(data);\n\n                    if (draftCreated) {\n                        this.trigger('createDraft');\n                    }\n\n                    if (this.$nameTextInput) {\n                        this.checkMetaValues();\n                    }\n\n                    $.extend(this.duplicatedElements, response.duplicatedElements);\n\n                    resolve();\n                }.bind(this));\n            }.bind(this));\n        },\n\n        prepareData: function(data) {\n            // Swap out element IDs with their duplicated ones\n            for (var oldId in this.duplicatedElements) {\n                if (this.duplicatedElements.hasOwnProperty(oldId)) {\n                    data = data.replace(new RegExp(Craft.escapeRegex(encodeURIComponent('][' + oldId + ']')), 'g'),\n                        '][' + this.duplicatedElements[oldId] + ']');\n                }\n            }\n\n            // Add the draft info\n            if (this.settings.draftId) {\n                data += '&draftId=' + this.settings.draftId\n                    + '&draftName=' + encodeURIComponent(this.settings.draftName)\n                    + '&draftNotes=' + encodeURIComponent(this.settings.draftNotes || '');\n            }\n\n            return data;\n        },\n\n        updatePreviewTargets: function(previewTargets) {\n            // index the current preview targets by label\n            var currentTargets = {};\n            for (var i = 0; i < this.settings.previewTargets.length; i++) {\n                currentTargets[this.settings.previewTargets[i].label] = this.settings.previewTargets[i];\n            }\n            for (i = 0; i < previewTargets.length; i++) {\n                if (currentTargets[previewTargets[i].label]) {\n                    currentTargets[previewTargets[i].label].url = previewTargets[i].url;\n                }\n            }\n        },\n\n        afterUpdate: function(data) {\n            Craft.cp.$primaryForm.data('initialSerializedValue', data);\n            this.statusIcons()\n                .removeClass('hidden')\n                .addClass('checkmark-icon')\n                .attr('title', Craft.t('app', 'The draft has been saved.'));\n\n            this.trigger('update');\n\n            if (this.checkFormAfterUpdate) {\n                this.checkFormAfterUpdate = false;\n\n                // Only actually check the form if there's no active timeout for it\n                if (!this.timeout) {\n                    this.checkForm();\n                }\n            }\n        },\n\n        showMetaHud: function() {\n            if (!this.metaHud) {\n                this.createMetaHud();\n                this.onMetaHudShow();\n            } else {\n                this.metaHud.show();\n            }\n\n            if (!Garnish.isMobileBrowser(true)) {\n                this.$nameTextInput.trigger('focus');\n            }\n        },\n\n        createMetaHud: function() {\n            var $hudBody = $('<div/>');\n            var $field, $inputContainer;\n\n            // Add the Name field\n            $field = $('<div class=\"field\"><div class=\"heading\"><label for=\"draft-name\">' + Craft.t('app', 'Draft Name') + '</label></div></div>').appendTo($hudBody);\n            $inputContainer = $('<div class=\"input\"/>').appendTo($field);\n            this.$nameTextInput = $('<input type=\"text\" class=\"text fullwidth\" id=\"draft-name\"/>').appendTo($inputContainer).val(this.settings.draftName);\n\n            // Add the Notes field\n            $field = $('<div class=\"field\"><div class=\"heading\"><label for=\"draft-notes\">' + Craft.t('app', 'Notes') + '</label></div></div>').appendTo($hudBody);\n            $inputContainer = $('<div class=\"input\"/>').appendTo($field);\n            this.$notesTextInput = $('<textarea class=\"text fullwidth\" id=\"draft-notes\" rows=\"2\"/>').appendTo($inputContainer).val(this.settings.draftNotes);\n\n            // HUD footer\n            var $footer = $('<div class=\"hud-footer flex flex-center\"/>').appendTo($hudBody);\n\n            // Delete button\n            if (this.settings.canDeleteDraft) {\n                var $deleteLink = $('<a class=\"error\" role=\"button\">' + Craft.t('app', 'Delete') + '</a>').appendTo($footer);\n            }\n\n            $('<div class=\"flex-grow\"></div>').appendTo($footer);\n            this.$saveMetaBtn = $('<input type=\"submit\" class=\"btn submit disabled\" value=\"' + Craft.t('app', 'Save') + '\"/>').appendTo($footer);\n\n            this.metaHud = new Garnish.HUD(this.$editMetaBtn, $hudBody, {\n                onSubmit: this.saveMeta.bind(this)\n            });\n\n            new Garnish.NiceText(this.$notesTextInput);\n\n            this.addListener(this.$notesTextInput, 'keydown', 'onNotesKeydown');\n\n            this.addListener(this.$nameTextInput, 'textchange', 'checkMetaValues');\n            this.addListener(this.$notesTextInput, 'textchange', 'checkMetaValues');\n\n            this.metaHud.on('show', this.onMetaHudShow.bind(this));\n            this.metaHud.on('hide', this.onMetaHudHide.bind(this));\n            this.metaHud.on('escape', this.onMetaHudEscape.bind(this));\n\n            if ($deleteLink) {\n                this.addListener($deleteLink, 'click', 'deleteDraft');\n            }\n        },\n\n        onMetaHudShow: function() {\n            this.$editMetaBtn.addClass('active');\n        },\n\n        onMetaHudHide: function() {\n            this.$editMetaBtn.removeClass('active');\n        },\n\n        onMetaHudEscape: function() {\n            this.$nameTextInput.val(this.settings.draftName);\n            this.$notesTextInput.val(this.settings.draftNotes);\n        },\n\n        onNotesKeydown: function(ev) {\n            if (ev.keyCode === Garnish.RETURN_KEY) {\n                ev.preventDefault();\n                this.metaHud.submit();\n            }\n        },\n\n        checkMetaValues: function() {\n            if (\n                this.$nameTextInput.val() && (\n                    this.$nameTextInput.val() !== this.settings.draftName ||\n                    this.$notesTextInput.val() !== this.settings.draftNotes\n                )\n            ) {\n                this.$saveMetaBtn.removeClass('disabled');\n                return true;\n            }\n\n            this.$saveMetaBtn.addClass('disabled');\n            return false;\n        },\n\n        shakeMetaHud: function() {\n            Garnish.shake(this.metaHud.$hud);\n        },\n\n        saveMeta: function() {\n            if (!this.checkMetaValues()) {\n                this.shakeMetaHud();\n                return;\n            }\n\n            this.settings.draftName = this.$nameTextInput.val();\n            this.settings.draftNotes = this.$notesTextInput.val();\n\n            this.metaHud.hide();\n            this.checkForm(true);\n        },\n\n        deleteDraft: function() {\n            if (!confirm(Craft.t('app', 'Are you sure you want to delete this draft?'))) {\n                return;\n            }\n\n            Craft.postActionRequest(this.settings.deleteDraftAction, {draftId: this.settings.draftId}, function(response, textStatus) {\n                if (textStatus === 'success') {\n                    window.location.href = this.settings.cpEditUrl;\n                }\n            }.bind(this))\n        },\n\n        handleFormSubmit: function(ev) {\n            ev.preventDefault();\n\n            // Prevent double form submits\n            if (this.submittingForm) {\n                return;\n            }\n\n            // If we're editing a draft, this isn't a custom trigger, and the user isn't allowed to update the source,\n            // then ignore the submission\n            if (!ev.customTrigger && !this.settings.isUnsavedDraft && this.settings.draftId && !this.settings.canUpdateSource) {\n                return;\n            }\n\n            // Prevent the normal unload confirmation dialog\n            Craft.cp.$confirmUnloadForms = Craft.cp.$confirmUnloadForms.not(Craft.cp.$primaryForm);\n\n            // Abort the current save request if there is one\n            if (this.saving) {\n                this.saveXhr.abort();\n            }\n\n            // Duplicate the form with normalized data\n            var $form = $('<form/>', {\n                attr: {\n                    'accept-charset': Craft.cp.$primaryForm.attr('accept-charset'),\n                    'action': Craft.cp.$primaryForm.attr('action'),\n                    'enctype': Craft.cp.$primaryForm.attr('enctype'),\n                    'method': Craft.cp.$primaryForm.attr('method'),\n                    'target': Craft.cp.$primaryForm.attr('target'),\n                }\n            });\n            var data = this.prepareData(this.serializeForm(false));\n            var values = data.split('&');\n            var chunks;\n            for (var i = 0; i < values.length; i++) {\n                chunks = values[i].split('=', 2);\n                $('<input/>', {\n                    type: 'hidden',\n                    name: decodeURIComponent(chunks[0]),\n                    value: decodeURIComponent(chunks[1] || '')\n                }).appendTo($form);\n            }\n\n            if (!ev.customTrigger || !ev.customTrigger.data('action')) {\n                $('<input/>', {\n                    type: 'hidden',\n                    name: 'action',\n                    value: this.settings.applyDraftAction\n                }).appendTo($form);\n            }\n\n            if (\n                (!ev.saveShortcut || !Craft.cp.$primaryForm.data('saveshortcut-redirect')) &&\n                (!ev.customTrigger || !ev.customTrigger.data('redirect'))\n            ) {\n                $('<input/>', {\n                    type: 'hidden',\n                    name: 'redirect',\n                    value: this.settings.hashedRedirectUrl\n                }).appendTo($form);\n            }\n\n            $form.appendTo(Garnish.$bod);\n            $form.submit();\n            this.submittingForm = true;\n        },\n    },\n    {\n        defaults: {\n            elementType: null,\n            sourceId: null,\n            siteId: null,\n            isLive: false,\n            cpEditUrl: null,\n            draftId: null,\n            revisionId: null,\n            draftName: null,\n            draftNotes: null,\n            canDeleteDraft: false,\n            canUpdateSource: false,\n            saveDraftAction: null,\n            deleteDraftAction: null,\n            applyDraftAction: null,\n            enablePreview: false,\n            previewTargets: [],\n        }\n    }\n);\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Handle Generator\n */\nCraft.DynamicGenerator = Craft.BaseInputGenerator.extend(\n    {\n        callback: $.noop,\n\n        init: function(source, target, callback) {\n            this.callback = callback;\n            this.base(source, target);\n        },\n\n        generateTargetValue: function(sourceVal) {\n            return this.callback(sourceVal);\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Editable table class\n */\nCraft.EditableTable = Garnish.Base.extend(\n    {\n        initialized: false,\n\n        id: null,\n        baseName: null,\n        columns: null,\n        sorter: null,\n        biggestId: -1,\n\n        $table: null,\n        $tbody: null,\n        $addRowBtn: null,\n\n        rowCount: 0,\n        hasMaxRows: false,\n        hasMinRows: false,\n\n        radioCheckboxes: null,\n\n        init: function(id, baseName, columns, settings) {\n            this.id = id;\n            this.baseName = baseName;\n            this.columns = columns;\n            this.setSettings(settings, Craft.EditableTable.defaults);\n            this.radioCheckboxes = {};\n\n            this.$table = $('#' + id);\n            this.$tbody = this.$table.children('tbody');\n            this.rowCount = this.$tbody.find('tr').length;\n\n            // Is this already an editable table?\n            if (this.$table.data('editable-table')) {\n                Garnish.log('Double-instantiating an editable table on an element');\n                this.$table.data('editable-table').destroy();\n            }\n\n            this.$table.data('editable-table', this);\n\n            this.sorter = new Craft.DataTableSorter(this.$table, {\n                helperClass: 'editabletablesorthelper',\n                copyDraggeeInputValuesToHelper: true\n            });\n\n            if (this.isVisible()) {\n                this.initialize();\n            } else {\n                // Give everything a chance to initialize\n                setTimeout($.proxy(this, 'initializeIfVisible'), 500);\n            }\n\n            if (this.settings.minRows && this.rowCount < this.settings.minRows) {\n                for (var i = this.rowCount; i < this.settings.minRows; i++) {\n                    this.addRow()\n                }\n            }\n        },\n\n        isVisible: function() {\n            return (this.$table.height() > 0);\n        },\n\n        initialize: function() {\n            if (this.initialized) {\n                return false;\n            }\n\n            this.initialized = true;\n            this.removeListener(Garnish.$win, 'resize');\n\n            var $rows = this.$tbody.children();\n\n            for (var i = 0; i < $rows.length; i++) {\n                this.createRowObj($rows[i]);\n            }\n\n            this.$addRowBtn = this.$table.next('.add');\n            this.updateAddRowButton();\n            this.addListener(this.$addRowBtn, 'activate', 'addRow');\n            return true;\n        },\n        initializeIfVisible: function() {\n            this.removeListener(Garnish.$win, 'resize');\n\n            if (this.isVisible()) {\n                this.initialize();\n            } else {\n                this.addListener(Garnish.$win, 'resize', 'initializeIfVisible');\n            }\n        },\n        updateAddRowButton: function() {\n            if (!this.canAddRow()) {\n                this.$addRowBtn.css('opacity', '0.2');\n                this.$addRowBtn.css('pointer-events', 'none');\n            } else {\n                this.$addRowBtn.css('opacity', '1');\n                this.$addRowBtn.css('pointer-events', 'auto');\n            }\n        },\n        canDeleteRow: function() {\n            return (this.rowCount > this.settings.minRows);\n        },\n        deleteRow: function(row) {\n            if (!this.canDeleteRow()) {\n                return;\n            }\n\n            this.sorter.removeItems(row.$tr);\n            row.$tr.remove();\n\n            this.rowCount--;\n\n            this.updateAddRowButton();\n            // onDeleteRow callback\n            this.settings.onDeleteRow(row.$tr);\n\n            row.destroy();\n        },\n        canAddRow: function() {\n            if (this.settings.staticRows) {\n                return false;\n            }\n\n            if (this.settings.maxRows) {\n                return (this.rowCount < this.settings.maxRows);\n            }\n\n            return true;\n        },\n        addRow: function(focus, prepend) {\n            if (!this.canAddRow()) {\n                return;\n            }\n\n            var rowId = this.settings.rowIdPrefix + (this.biggestId + 1),\n                $tr = this.createRow(rowId, this.columns, this.baseName, $.extend({}, this.settings.defaultValues));\n\n            if (prepend) {\n                $tr.prependTo(this.$tbody);\n            } else {\n                $tr.appendTo(this.$tbody);\n            }\n\n            var row = this.createRowObj($tr);\n            this.sorter.addItems($tr);\n\n            // Focus the first input in the row\n            if (focus !== false) {\n                $tr.find('input:visible,textarea:visible,select:visible').first().trigger('focus');\n            }\n\n            this.rowCount++;\n            this.updateAddRowButton();\n\n            // onAddRow callback\n            this.settings.onAddRow($tr);\n\n            return row;\n        },\n\n        createRow: function(rowId, columns, baseName, values) {\n            return Craft.EditableTable.createRow(rowId, columns, baseName, values);\n        },\n\n        createRowObj: function($tr) {\n            return new Craft.EditableTable.Row(this, $tr);\n        },\n\n        focusOnPrevRow: function($tr, tdIndex, blurTd) {\n            var $prevTr = $tr.prev('tr');\n            var prevRow;\n\n            if ($prevTr.length) {\n                prevRow = $prevTr.data('editable-table-row');\n            } else {\n                prevRow = this.addRow(false, true);\n            }\n\n            // Focus on the same cell in the previous row\n            if (!prevRow) {\n                return;\n            }\n\n            if (!prevRow.$tds[tdIndex]) {\n                return;\n            }\n\n            if ($(prevRow.$tds[tdIndex]).hasClass('disabled')) {\n                if ($prevTr) {\n                    this.focusOnPrevRow($prevTr, tdIndex, blurTd);\n                }\n                return;\n            }\n\n            var $input = $('textarea,input.text', prevRow.$tds[tdIndex]);\n            if ($input.length) {\n                $(blurTd).trigger('blur');\n                $input.trigger('focus');\n            }\n        },\n\n        focusOnNextRow: function($tr, tdIndex, blurTd) {\n            var $nextTr = $tr.next('tr');\n            var nextRow;\n\n            if ($nextTr.length) {\n                nextRow = $nextTr.data('editable-table-row');\n            } else {\n                nextRow = this.addRow(false);\n            }\n\n            // Focus on the same cell in the next row\n            if (!nextRow) {\n                return;\n            }\n\n            if (!nextRow.$tds[tdIndex]) {\n                return;\n            }\n\n            if ($(nextRow.$tds[tdIndex]).hasClass('disabled')) {\n                if ($nextTr) {\n                    this.focusOnNextRow($nextTr, tdIndex, blurTd);\n                }\n                return;\n            }\n\n            var $input = $('textarea,input.text', nextRow.$tds[tdIndex]);\n            if ($input.length) {\n                $(blurTd).trigger('blur');\n                $input.trigger('focus');\n            }\n        },\n    },\n    {\n        textualColTypes: ['color', 'date', 'email', 'multiline', 'number', 'singleline', 'template', 'time', 'url'],\n        defaults: {\n            rowIdPrefix: '',\n            defaultValues: {},\n            staticRows: false,\n            minRows: null,\n            maxRows: null,\n            onAddRow: $.noop,\n            onDeleteRow: $.noop\n        },\n\n        createRow: function(rowId, columns, baseName, values) {\n            var $tr = $('<tr/>', {\n                'data-id': rowId\n            });\n\n            for (var colId in columns) {\n                if (!columns.hasOwnProperty(colId)) {\n                    continue;\n                }\n\n                var col = columns[colId],\n                    value = (typeof values[colId] !== 'undefined' ? values[colId] : ''),\n                    $cell;\n\n                if (col.type === 'heading') {\n                    $cell = $('<th/>', {\n                        'scope': 'row',\n                        'class': col['class'],\n                        'html': value\n                    });\n                } else {\n                    var name = baseName + '[' + rowId + '][' + colId + ']',\n                        textual = Craft.inArray(col.type, Craft.EditableTable.textualColTypes);\n\n                    $cell = $('<td/>', {\n                        'class': col['class'],\n                        'width': col.width\n                    });\n\n                    if (textual) {\n                        $cell.addClass('textual');\n                    }\n\n                    if (col.code) {\n                        $cell.addClass('code');\n                    }\n\n                    switch (col.type) {\n                        case 'checkbox':\n                            Craft.ui.createCheckbox({\n                                name: name,\n                                value: col.value || '1',\n                                checked: !!value\n                            }).appendTo($cell);\n                            break;\n\n                        case 'color':\n                            Craft.ui.createColorInput({\n                                name: name,\n                                value: value,\n                                small: true\n                            }).appendTo($cell);\n                            break;\n\n                        case 'date':\n                            Craft.ui.createDateInput({\n                                name: name,\n                                value: value\n                            }).appendTo($cell);\n                            break;\n\n                        case 'lightswitch':\n                            Craft.ui.createLightswitch({\n                                name: name,\n                                value: col.value || '1',\n                                on: !!value,\n                                small: true\n                            }).appendTo($cell);\n                            break;\n\n                        case 'select':\n                            Craft.ui.createSelect({\n                                name: name,\n                                options: col.options,\n                                value: value || (function() {\n                                    for (var key in col.options) {\n                                        if (col.options.hasOwnProperty(key) && col.options[key].default) {\n                                            return typeof col.options[key].value !== 'undefined' ? col.options[key].value : key;\n                                        }\n                                    }\n                                    return null;\n                                })(),\n                                'class': 'small'\n                            }).appendTo($cell);\n                            break;\n\n                        case 'time':\n                            Craft.ui.createTimeInput({\n                                name: name,\n                                value: value\n                            }).appendTo($cell);\n                            break;\n\n                        case 'email':\n                        case 'url':\n                            Craft.ui.createTextInput({\n                                name: name,\n                                value: value,\n                                type: col.type,\n                                placeholder: col.placeholder || null,\n                            }).appendTo($cell);\n                            break;\n\n                        default:\n                            $('<textarea/>', {\n                                'name': name,\n                                'rows': 1,\n                                'val': value,\n                                'placeholder': col.placeholder\n                            }).appendTo($cell);\n                    }\n                }\n\n                $cell.appendTo($tr);\n            }\n\n            $('<td/>', {\n                'class': 'thin action'\n            }).append(\n                $('<a/>', {\n                    'class': 'move icon',\n                    'title': Craft.t('app', 'Reorder')\n                })\n            ).appendTo($tr);\n\n            $('<td/>', {\n                'class': 'thin action'\n            }).append(\n                $('<a/>', {\n                    'class': 'delete icon',\n                    'title': Craft.t('app', 'Delete')\n                })\n            ).appendTo($tr);\n\n            return $tr;\n        }\n    });\n\n/**\n * Editable table row class\n */\nCraft.EditableTable.Row = Garnish.Base.extend(\n    {\n        table: null,\n        id: null,\n        niceTexts: null,\n\n        $tr: null,\n        $tds: null,\n        tds: null,\n        $textareas: null,\n        $deleteBtn: null,\n\n        init: function(table, tr) {\n            this.table = table;\n            this.$tr = $(tr);\n            this.$tds = this.$tr.children();\n            this.tds = [];\n            this.id = this.$tr.attr('data-id');\n\n            this.$tr.data('editable-table-row', this);\n\n            // Get the row ID, sans prefix\n            var id = parseInt(this.id.substr(this.table.settings.rowIdPrefix.length));\n\n            if (id > this.table.biggestId) {\n                this.table.biggestId = id;\n            }\n\n            this.$textareas = $();\n            this.niceTexts = [];\n            var textareasByColId = {};\n\n            var i = 0;\n            var colId, col, td, $textarea, $checkbox;\n\n            for (colId in this.table.columns) {\n                if (!this.table.columns.hasOwnProperty(colId)) {\n                    continue;\n                }\n\n                col = this.table.columns[colId];\n                td = this.tds[colId] = this.$tds[i];\n\n                if (Craft.inArray(col.type, Craft.EditableTable.textualColTypes)) {\n                    $textarea = $('textarea, input.text', td);\n                    this.$textareas = this.$textareas.add($textarea);\n\n                    this.addListener($textarea, 'focus', 'onTextareaFocus');\n                    this.addListener($textarea, 'mousedown', 'ignoreNextTextareaFocus');\n\n                    this.niceTexts.push(new Garnish.NiceText($textarea, {\n                        onHeightChange: $.proxy(this, 'onTextareaHeightChange')\n                    }));\n\n                    this.addListener($textarea, 'keypress', {tdIndex: i, type: col.type}, 'handleKeypress');\n                    this.addListener($textarea, 'textchange', {type: col.type}, 'validateValue');\n                    $textarea.trigger('textchange');\n\n                    textareasByColId[colId] = $textarea;\n                } else if (col.type === 'checkbox') {\n                    $checkbox = $('input[type=\"checkbox\"]', td);\n\n                    if (col.radioMode) {\n                        if (typeof this.table.radioCheckboxes[colId] === 'undefined') {\n                            this.table.radioCheckboxes[colId] = [];\n                        }\n                        this.table.radioCheckboxes[colId].push($checkbox[0]);\n                        this.addListener($checkbox, 'change', {colId: colId}, 'onRadioCheckboxChange');\n                    }\n\n                    if (col.toggle) {\n                        this.addListener($checkbox, 'change', {colId: colId}, function(ev) {\n                            this.applyToggleCheckbox(ev.data.colId);\n                        });\n                    }\n                }\n\n                i++;\n            }\n\n            // Now that all of the text cells have been nice-ified, let's normalize the heights\n            this.onTextareaHeightChange();\n\n            // See if we need to apply any checkbox toggles now that we've indexed all the TDs\n            for (colId in this.table.columns) {\n                if (!this.table.columns.hasOwnProperty(colId)) {\n                    continue;\n                }\n                col = this.table.columns[colId];\n                if (col.type === 'checkbox' && col.toggle) {\n                    this.applyToggleCheckbox(colId);\n                }\n            }\n\n            // Now look for any autopopulate columns\n            for (colId in this.table.columns) {\n                if (!this.table.columns.hasOwnProperty(colId)) {\n                    continue;\n                }\n\n                col = this.table.columns[colId];\n\n                if (col.autopopulate && typeof textareasByColId[col.autopopulate] !== 'undefined' && !textareasByColId[colId].val()) {\n                    new Craft.HandleGenerator(textareasByColId[colId], textareasByColId[col.autopopulate], {\n                        allowNonAlphaStart: true\n                    });\n                }\n            }\n\n            var $deleteBtn = this.$tr.children().last().find('.delete');\n            this.addListener($deleteBtn, 'click', 'deleteRow');\n        },\n\n        onTextareaFocus: function(ev) {\n            this.onTextareaHeightChange();\n\n            var $textarea = $(ev.currentTarget);\n\n            if ($textarea.data('ignoreNextFocus')) {\n                $textarea.data('ignoreNextFocus', false);\n                return;\n            }\n\n            setTimeout(function() {\n                Craft.selectFullValue($textarea);\n            }, 0);\n        },\n\n        onRadioCheckboxChange: function(ev) {\n            if (ev.currentTarget.checked) {\n                for (var i = 0; i < this.table.radioCheckboxes[ev.data.colId].length; i++) {\n                    var checkbox = this.table.radioCheckboxes[ev.data.colId][i];\n                    checkbox.checked = (checkbox === ev.currentTarget);\n                }\n            }\n        },\n\n        applyToggleCheckbox: function(checkboxColId) {\n            var checkboxCol = this.table.columns[checkboxColId];\n            var checked = $('input[type=\"checkbox\"]', this.tds[checkboxColId]).prop('checked');\n            var colId, colIndex, neg;\n            for (var i = 0; i < checkboxCol.toggle.length; i++) {\n                colId = checkboxCol.toggle[i];\n                colIndex = this.table.colum;\n                if (neg = colId[0] === '!') {\n                    colId = colId.substr(1);\n                }\n                if ((checked && !neg) || (!checked && neg))  {\n                    $(this.tds[colId])\n                        .removeClass('disabled')\n                        .find('textarea, input').prop('disabled', false);\n                } else {\n                    $(this.tds[colId])\n                        .addClass('disabled')\n                        .find('textarea, input').prop('disabled', true);\n                }\n            }\n        },\n\n        ignoreNextTextareaFocus: function(ev) {\n            $.data(ev.currentTarget, 'ignoreNextFocus', true);\n        },\n\n        handleKeypress: function(ev) {\n            var keyCode = ev.keyCode ? ev.keyCode : ev.charCode;\n            var ctrl = Garnish.isCtrlKeyPressed(ev);\n\n            // Going to the next/previous row?\n            if (keyCode === Garnish.RETURN_KEY && (ev.data.type !== 'multiline' || ctrl)) {\n                ev.preventDefault();\n                if (ev.shiftKey) {\n                    this.table.focusOnPrevRow(this.$tr, ev.data.tdIndex, ev.currentTarget);\n                } else {\n                    this.table.focusOnNextRow(this.$tr, ev.data.tdIndex, ev.currentTarget);\n                }\n                return;\n            }\n\n            // Was this an invalid number character?\n            if (ev.data.type === 'number' && !ctrl && !Craft.inArray(keyCode, Craft.EditableTable.Row.numericKeyCodes)) {\n                ev.preventDefault();\n            }\n        },\n\n        validateValue: function(ev) {\n            if (ev.data.type === 'multiline') {\n                return;\n            }\n\n            var safeValue;\n\n            if (ev.data.type === 'number') {\n                // Only grab the number at the beginning of the value (if any)\n                var match = ev.currentTarget.value.match(/^\\s*(-?[\\d\\\\.]*)/);\n\n                if (match !== null) {\n                    safeValue = match[1];\n                }\n                else {\n                    safeValue = '';\n                }\n            }\n            else {\n                // Just strip any newlines\n                safeValue = ev.currentTarget.value.replace(/[\\r\\n]/g, '');\n            }\n\n            if (safeValue !== ev.currentTarget.value) {\n                ev.currentTarget.value = safeValue;\n            }\n        },\n\n        onTextareaHeightChange: function() {\n            // Keep all the textareas' heights in sync\n            var tallestTextareaHeight = -1;\n\n            for (var i = 0; i < this.niceTexts.length; i++) {\n                if (this.niceTexts[i].height > tallestTextareaHeight) {\n                    tallestTextareaHeight = this.niceTexts[i].height;\n                }\n            }\n\n            this.$textareas.css('min-height', tallestTextareaHeight);\n\n            // If the <td> is still taller, go with that instead\n            var tdHeight = this.$textareas.filter(':visible').first().parent().height();\n\n            if (tdHeight > tallestTextareaHeight) {\n                this.$textareas.css('min-height', tdHeight);\n            }\n        },\n\n        deleteRow: function() {\n            this.table.deleteRow(this);\n        }\n    },\n    {\n        numericKeyCodes: [9 /* (tab) */, 8 /* (delete) */, 37, 38, 39, 40 /* (arrows) */, 45, 91 /* (minus) */, 46, 190 /* period */, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57 /* (0-9) */]\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Element Action Trigger\n */\nCraft.ElementActionTrigger = Garnish.Base.extend(\n    {\n        maxLevels: null,\n        newChildUrl: null,\n        $trigger: null,\n        $selectedItems: null,\n        triggerEnabled: true,\n\n        init: function(settings) {\n            this.setSettings(settings, Craft.ElementActionTrigger.defaults);\n\n            this.$trigger = $('#' + settings.type.replace(/[\\[\\]\\\\]+/g, '-') + '-actiontrigger');\n\n            // Do we have a custom handler?\n            if (this.settings.activate) {\n                // Prevent the element index's click handler\n                this.$trigger.data('custom-handler', true);\n\n                // Is this a custom trigger?\n                if (this.$trigger.prop('nodeName') === 'FORM') {\n                    this.addListener(this.$trigger, 'submit', 'handleTriggerActivation');\n                }\n                else {\n                    this.addListener(this.$trigger, 'click', 'handleTriggerActivation');\n                }\n            }\n\n            this.updateTrigger();\n            Craft.elementIndex.on('selectionChange', $.proxy(this, 'updateTrigger'));\n        },\n\n        updateTrigger: function() {\n            // Ignore if the last element was just unselected\n            if (Craft.elementIndex.getSelectedElements().length === 0) {\n                return;\n            }\n\n            if (this.validateSelection()) {\n                this.enableTrigger();\n            }\n            else {\n                this.disableTrigger();\n            }\n        },\n\n        /**\n         * Determines if this action can be performed on the currently selected elements.\n         *\n         * @return boolean\n         */\n        validateSelection: function() {\n            var valid = true;\n            this.$selectedItems = Craft.elementIndex.getSelectedElements();\n\n            if (!this.settings.batch && this.$selectedItems.length > 1) {\n                valid = false;\n            }\n            else if (typeof this.settings.validateSelection === 'function') {\n                valid = this.settings.validateSelection(this.$selectedItems);\n            }\n\n            return valid;\n        },\n\n        enableTrigger: function() {\n            if (this.triggerEnabled) {\n                return;\n            }\n\n            this.$trigger.removeClass('disabled');\n            this.triggerEnabled = true;\n        },\n\n        disableTrigger: function() {\n            if (!this.triggerEnabled) {\n                return;\n            }\n\n            this.$trigger.addClass('disabled');\n            this.triggerEnabled = false;\n        },\n\n        handleTriggerActivation: function(ev) {\n            ev.preventDefault();\n            ev.stopPropagation();\n\n            if (this.triggerEnabled) {\n                this.settings.activate(this.$selectedItems);\n            }\n        }\n    },\n    {\n        defaults: {\n            type: null,\n            batch: true,\n            validateSelection: null,\n            activate: null\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Base Element Index View\n */\nCraft.ElementThumbLoader = Garnish.Base.extend(\n    {\n        queue: null,\n        workers: [],\n\n        init: function() {\n            this.queue = [];\n\n            for (var i = 0; i < 3; i++) {\n                this.workers.push(new Craft.ElementThumbLoader.Worker(this));\n            }\n        },\n\n        load: function($elements) {\n            this.queue = this.queue.concat($elements.find('.elementthumb').toArray());\n\n            if (this.queue.length) {\n                // See if there are any inactive workers\n                for (var i = 0; i < this.workers.length; i++) {\n                    if (!this.workers[i].active) {\n                        this.workers[i].loadNext();\n                    }\n                }\n            }\n        },\n\n        destroy: function() {\n            for (var i = 0; i < this.workers.length; i++) {\n                this.workers[i].destroy();\n            }\n\n            this.base();\n        }\n    }\n);\n\nCraft.ElementThumbLoader.Worker = Garnish.Base.extend(\n    {\n        loader: null,\n        active: false,\n\n        init: function(loader) {\n            this.loader = loader;\n        },\n\n        loadNext: function() {\n            var container = this.loader.queue.shift();\n            if (typeof container === 'undefined') {\n                this.active = false;\n                return;\n            }\n\n            this.active = true;\n            var $container = $(container);\n            if ($container.find('img').length) {\n                this.loadNext();\n                return;\n            }\n            var $img = $('<img/>', {\n                sizes: $container.attr('data-sizes'),\n                srcset: $container.attr('data-srcset'),\n                alt: ''\n            });\n            this.addListener($img, 'load', 'loadNext');\n            $img.appendTo($container);\n            picturefill({\n                elements: [$img[0]]\n            });\n        }\n    }\n);\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Elevated Session Form\n */\nCraft.ElevatedSessionForm = Garnish.Base.extend(\n    {\n        $form: null,\n        inputs: null,\n\n        init: function(form, inputs) {\n            this.$form = $(form);\n\n            // Only check specific inputs?\n            if (typeof inputs !== 'undefined') {\n                this.inputs = [];\n                inputs = $.makeArray(inputs);\n\n                for (var i = 0; i < inputs.length; i++) {\n                    var $inputs = $(inputs[i]);\n\n                    for (var j = 0; j < $inputs.length; j++) {\n                        var $input = $inputs.eq(j);\n\n                        this.inputs.push({\n                            input: $input,\n                            val: Garnish.getInputPostVal($input)\n                        });\n                    }\n                }\n            }\n\n            this.addListener(this.$form, 'submit', 'handleFormSubmit');\n        },\n\n        handleFormSubmit: function(ev) {\n            // Ignore if we're in the middle of getting the elevated session timeout\n            if (Craft.elevatedSessionManager.fetchingTimeout) {\n                ev.preventDefault();\n                return;\n            }\n\n            // Are we only interested in certain inputs?\n            if (this.inputs) {\n                var inputsChanged = false;\n                var $input;\n\n                for (var i = 0; i < this.inputs.length; i++) {\n                    $input = this.inputs[i].input;\n                    // Is this a password input?\n                    if ($input.data('passwordInput')) {\n                        $input = $input.data('passwordInput').$currentInput;\n                    }\n\n                    // Has this input's value changed?\n                    if (Garnish.getInputPostVal($input) !== this.inputs[i].val) {\n                        inputsChanged = true;\n                        break;\n                    }\n                }\n\n                if (!inputsChanged) {\n                    // No need to interrupt the submit\n                    return;\n                }\n            }\n\n            // Prevent the form from submitting until the user has an elevated session\n            ev.preventDefault();\n            Craft.elevatedSessionManager.requireElevatedSession($.proxy(this, 'submitForm'));\n        },\n\n        submitForm: function() {\n            // Don't let handleFormSubmit() interrupt this time\n            this.disable();\n            this.$form.trigger('submit');\n            this.enable();\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Elevated Session Manager\n */\nCraft.ElevatedSessionManager = Garnish.Base.extend(\n    {\n        fetchingTimeout: false,\n\n        passwordModal: null,\n        $passwordInput: null,\n        $passwordSpinner: null,\n        $submitBtn: null,\n        $errorPara: null,\n\n        callback: null,\n\n        /**\n         * Requires that the user has an elevated session.\n         *\n         * @param {function} callback The callback function that should be called once the user has an elevated session\n         */\n        requireElevatedSession: function(callback) {\n            this.callback = callback;\n\n            // Check the time remaining on the user's elevated session (if any)\n            this.fetchingTimeout = true;\n\n            Craft.postActionRequest('users/get-elevated-session-timeout', $.proxy(function(response, textStatus) {\n                this.fetchingTimeout = false;\n\n                if (textStatus === 'success') {\n                    // Is there still enough time left or has it been disabled?\n                    if (response.timeout === false || response.timeout >= Craft.ElevatedSessionManager.minSafeElevatedSessionTimeout) {\n                        this.callback();\n                    }\n                    else {\n                        // Show the password modal\n                        this.showPasswordModal();\n                    }\n                }\n            }, this));\n        },\n\n        showPasswordModal: function() {\n            if (!this.passwordModal) {\n                var $passwordModal = $('<form id=\"elevatedsessionmodal\" class=\"modal secure fitted\"/>'),\n                    $body = $('<div class=\"body\"><p>' + Craft.t('app', 'Enter your password to continue.') + '</p></div>').appendTo($passwordModal),\n                    $inputContainer = $('<div class=\"inputcontainer\">').appendTo($body),\n                    $inputsFlexContainer = $('<div class=\"flex\"/>').appendTo($inputContainer),\n                    $passwordContainer = $('<div class=\"flex-grow\"/>').appendTo($inputsFlexContainer),\n                    $buttonContainer= $('<td/>').appendTo($inputsFlexContainer),\n                    $passwordWrapper = $('<div class=\"passwordwrapper\"/>').appendTo($passwordContainer);\n\n                this.$passwordInput = $('<input type=\"password\" class=\"text password fullwidth\" placeholder=\"' + Craft.t('app', 'Password') + '\" autocomplete=\"current-password\"/>').appendTo($passwordWrapper);\n                this.$passwordSpinner = $('<div class=\"spinner hidden\"/>').appendTo($inputContainer);\n                this.$submitBtn = $('<input type=\"submit\" class=\"btn submit disabled\" value=\"' + Craft.t('app', 'Submit') + '\" />').appendTo($buttonContainer);\n                this.$errorPara = $('<p class=\"error\"/>').appendTo($body);\n\n                this.passwordModal = new Garnish.Modal($passwordModal, {\n                    closeOtherModals: false,\n                    onFadeIn: $.proxy(function() {\n                        setTimeout($.proxy(this, 'focusPasswordInput'), 100);\n                    }, this),\n                    onFadeOut: $.proxy(function() {\n                        this.$passwordInput.val('');\n                    }, this)\n                });\n\n                new Craft.PasswordInput(this.$passwordInput, {\n                    onToggleInput: $.proxy(function($newPasswordInput) {\n                        this.$passwordInput = $newPasswordInput;\n                    }, this)\n                });\n\n                this.addListener(this.$passwordInput, 'textchange', 'validatePassword');\n                this.addListener($passwordModal, 'submit', 'submitPassword');\n            }\n            else {\n                this.passwordModal.show();\n            }\n        },\n\n        focusPasswordInput: function() {\n            if (!Garnish.isMobileBrowser(true)) {\n                this.$passwordInput.trigger('focus');\n            }\n        },\n\n        validatePassword: function() {\n            if (this.$passwordInput.val().length >= 6) {\n                this.$submitBtn.removeClass('disabled');\n                return true;\n            }\n            else {\n                this.$submitBtn.addClass('disabled');\n                return false;\n            }\n        },\n\n        submitPassword: function(ev) {\n            if (ev) {\n                ev.preventDefault();\n            }\n\n            if (!this.validatePassword()) {\n                return;\n            }\n\n            this.$passwordSpinner.removeClass('hidden');\n            this.clearLoginError();\n\n            var data = {\n                currentPassword: this.$passwordInput.val()\n            };\n\n            Craft.postActionRequest('users/start-elevated-session', data, $.proxy(function(response, textStatus) {\n                this.$passwordSpinner.addClass('hidden');\n\n                if (textStatus === 'success') {\n                    if (response.success) {\n                        this.passwordModal.hide();\n                        this.callback();\n                    }\n                    else {\n                        this.showPasswordError(response.message || Craft.t('app', 'Incorrect password.'));\n                        Garnish.shake(this.passwordModal.$container);\n                        this.focusPasswordInput();\n                    }\n                }\n                else {\n                    this.showPasswordError();\n                }\n\n            }, this));\n        },\n\n        showPasswordError: function(error) {\n            if (error === null || typeof error === 'undefined') {\n                error = Craft.t('app', 'An unknown error occurred.');\n            }\n\n            this.$errorPara.text(error);\n            this.passwordModal.updateSizeAndPosition();\n        },\n\n        clearLoginError: function() {\n            this.showPasswordError('');\n        }\n    },\n    {\n        minSafeElevatedSessionTimeout: 5\n    });\n\n// Instantiate it\nCraft.elevatedSessionManager = new Craft.ElevatedSessionManager();\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Entry index class\n */\nCraft.EntryIndex = Craft.BaseElementIndex.extend(\n    {\n        publishableSections: null,\n        $newEntryBtnGroup: null,\n        $newEntryBtn: null,\n\n        init: function(elementType, $container, settings) {\n            this.on('selectSource', $.proxy(this, 'updateButton'));\n            this.on('selectSite', $.proxy(this, 'updateButton'));\n            this.base(elementType, $container, settings);\n        },\n\n        afterInit: function() {\n            // Find which of the visible sections the user has permission to create new entries in\n            this.publishableSections = [];\n\n            for (var i = 0; i < Craft.publishableSections.length; i++) {\n                var section = Craft.publishableSections[i];\n\n                if (this.getSourceByKey('section:' + section.uid)) {\n                    this.publishableSections.push(section);\n                }\n            }\n\n            this.base();\n        },\n\n        getDefaultSourceKey: function() {\n            // Did they request a specific section in the URL?\n            if (this.settings.context === 'index' && typeof defaultSectionHandle !== 'undefined') {\n                if (defaultSectionHandle === 'singles') {\n                    return 'singles';\n                }\n                else {\n                    for (var i = 0; i < this.$sources.length; i++) {\n                        var $source = $(this.$sources[i]);\n\n                        if ($source.data('handle') === defaultSectionHandle) {\n                            return $source.data('key');\n                        }\n                    }\n                }\n            }\n\n            return this.base();\n        },\n\n        updateButton: function() {\n            if (!this.$source) {\n                return;\n            }\n\n            var handle;\n\n            // Get the handle of the selected source\n            if (this.$source.data('key') === 'singles') {\n                handle = 'singles';\n            }\n            else {\n                handle = this.$source.data('handle');\n            }\n\n            // Update the New Entry button\n            // ---------------------------------------------------------------------\n\n            var i, href, label;\n\n            if (this.publishableSections.length) {\n                // Remove the old button, if there is one\n                if (this.$newEntryBtnGroup) {\n                    this.$newEntryBtnGroup.remove();\n                }\n\n                // Determine if they are viewing a section that they have permission to create entries in\n                var selectedSection;\n\n                if (handle) {\n                    for (i = 0; i < this.publishableSections.length; i++) {\n                        if (this.publishableSections[i].handle === handle) {\n                            selectedSection = this.publishableSections[i];\n                            break;\n                        }\n                    }\n                }\n\n                this.$newEntryBtnGroup = $('<div class=\"btngroup submit\"/>');\n                var $menuBtn;\n\n                // If they are, show a primary \"New entry\" button, and a dropdown of the other sections (if any).\n                // Otherwise only show a menu button\n                if (selectedSection) {\n                    href = this._getSectionTriggerHref(selectedSection);\n                    label = (this.settings.context === 'index' ? Craft.t('app', 'New entry') : Craft.t('app', 'New {section} entry', {section: selectedSection.name}));\n                    this.$newEntryBtn = $('<a class=\"btn submit add icon\" ' + href + '>' + Craft.escapeHtml(label) + '</a>').appendTo(this.$newEntryBtnGroup);\n\n                    if (this.settings.context !== 'index') {\n                        this.addListener(this.$newEntryBtn, 'click', function(ev) {\n                            this._openCreateEntryModal(ev.currentTarget.getAttribute('data-id'));\n                        });\n                    }\n\n                    if (this.publishableSections.length > 1) {\n                        $menuBtn = $('<div class=\"btn submit menubtn\"></div>').appendTo(this.$newEntryBtnGroup);\n                    }\n                }\n                else {\n                    this.$newEntryBtn = $menuBtn = $('<div class=\"btn submit add icon menubtn\">' + Craft.t('app', 'New entry') + '</div>').appendTo(this.$newEntryBtnGroup);\n                }\n\n                if ($menuBtn) {\n                    var menuHtml = '<div class=\"menu\"><ul>';\n\n                    for (i = 0; i < this.publishableSections.length; i++) {\n                        var section = this.publishableSections[i];\n\n                        if (\n                            (this.settings.context === 'index' && $.inArray(this.siteId, section.sites) !== -1) ||\n                            (this.settings.context !== 'index' && section !== selectedSection)\n                        ) {\n                            href = this._getSectionTriggerHref(section);\n                            label = (this.settings.context === 'index' ? section.name : Craft.t('app', 'New {section} entry', {section: section.name}));\n                            menuHtml += '<li><a ' + href + '\">' + Craft.escapeHtml(label) + '</a></li>';\n                        }\n                    }\n\n                    menuHtml += '</ul></div>';\n\n                    $(menuHtml).appendTo(this.$newEntryBtnGroup);\n                    var menuBtn = new Garnish.MenuBtn($menuBtn);\n\n                    if (this.settings.context !== 'index') {\n                        menuBtn.on('optionSelect', $.proxy(function(ev) {\n                            this._openCreateEntryModal(ev.option.getAttribute('data-id'));\n                        }, this));\n                    }\n                }\n\n                this.addButton(this.$newEntryBtnGroup);\n            }\n\n            // Update the URL if we're on the Entries index\n            // ---------------------------------------------------------------------\n\n            if (this.settings.context === 'index' && typeof history !== 'undefined') {\n                var uri = 'entries';\n\n                if (handle) {\n                    uri += '/' + handle;\n                }\n\n                history.replaceState({}, '', Craft.getUrl(uri));\n            }\n        },\n\n        _getSectionTriggerHref: function(section) {\n            if (this.settings.context === 'index') {\n                var uri = 'entries/' + section.handle + '/new';\n                params = {};\n                if (this.siteId) {\n                    for (var i = 0; i < Craft.sites.length; i++) {\n                        if (Craft.sites[i].id == this.siteId) {\n                            params.site = Craft.sites[i].handle;\n                        }\n                    }\n                }\n                return 'href=\"' + Craft.getUrl(uri, params) + '\"';\n            } else {\n                return 'data-id=\"' + section.id + '\"';\n            }\n        },\n\n        _openCreateEntryModal: function(sectionId) {\n            if (this.$newEntryBtn.hasClass('loading')) {\n                return;\n            }\n\n            // Find the section\n            var section;\n\n            for (var i = 0; i < this.publishableSections.length; i++) {\n                if (this.publishableSections[i].id == sectionId) {\n                    section = this.publishableSections[i];\n                    break;\n                }\n            }\n\n            if (!section) {\n                return;\n            }\n\n            this.$newEntryBtn.addClass('inactive');\n            var newEntryBtnText = this.$newEntryBtn.text();\n            this.$newEntryBtn.text(Craft.t('app', 'New {section} entry', {section: section.name}));\n\n            Craft.createElementEditor(this.elementType, {\n                hudTrigger: this.$newEntryBtnGroup,\n                elementType: 'craft\\\\elements\\\\Entry',\n                siteId: this.siteId,\n                attributes: {\n                    sectionId: sectionId,\n                    typeId: section.entryTypes[0].id\n                },\n                onBeginLoading: $.proxy(function() {\n                    this.$newEntryBtn.addClass('loading');\n                }, this),\n                onEndLoading: $.proxy(function() {\n                    this.$newEntryBtn.removeClass('loading');\n                }, this),\n                onHideHud: $.proxy(function() {\n                    this.$newEntryBtn.removeClass('inactive').text(newEntryBtnText);\n                }, this),\n                onSaveElement: $.proxy(function(response) {\n                    // Make sure the right section is selected\n                    var sectionSourceKey = 'section:' + section.uid;\n\n                    if (this.sourceKey !== sectionSourceKey) {\n                        this.selectSourceByKey(sectionSourceKey);\n                    }\n\n                    this.selectElementAfterUpdate(response.id);\n                    this.updateElements();\n                }, this)\n            });\n        }\n    });\n\n// Register it!\nCraft.registerElementIndexClass('craft\\\\elements\\\\Entry', Craft.EntryIndex);\n\n/** global: Craft */\n/** global: Garnish */\nCraft.FieldLayoutDesigner = Garnish.Base.extend(\n    {\n        $container: null,\n        $tabContainer: null,\n        $unusedFieldContainer: null,\n        $newTabBtn: null,\n        $allFields: null,\n\n        tabGrid: null,\n        unusedFieldGrid: null,\n\n        tabDrag: null,\n        fieldDrag: null,\n\n        init: function(container, settings) {\n            this.$container = $(container);\n            this.setSettings(settings, Craft.FieldLayoutDesigner.defaults);\n\n            this.$tabContainer = this.$container.children('.fld-tabs');\n            this.$unusedFieldContainer = this.$container.children('.unusedfields');\n            this.$newTabBtn = this.$container.find('> .newtabbtn-container > .btn');\n            this.$allFields = this.$unusedFieldContainer.find('.fld-field');\n\n            // Set up the layout grids\n            this.tabGrid = new Craft.Grid(this.$tabContainer, Craft.FieldLayoutDesigner.gridSettings);\n            this.unusedFieldGrid = new Craft.Grid(this.$unusedFieldContainer, Craft.FieldLayoutDesigner.gridSettings);\n\n            var $tabs = this.$tabContainer.children();\n            for (var i = 0; i < $tabs.length; i++) {\n                this.initTab($($tabs[i]));\n            }\n\n            this.fieldDrag = new Craft.FieldLayoutDesigner.FieldDrag(this);\n\n            if (this.settings.customizableTabs) {\n                this.tabDrag = new Craft.FieldLayoutDesigner.TabDrag(this);\n\n                this.addListener(this.$newTabBtn, 'activate', 'addTab');\n            }\n        },\n\n        initTab: function($tab) {\n            if (this.settings.customizableTabs) {\n                var $editBtn = $tab.find('.tabs .settings'),\n                    $menu = $('<div class=\"menu\" data-align=\"center\"/>').insertAfter($editBtn),\n                    $ul = $('<ul/>').appendTo($menu);\n\n                $('<li><a data-action=\"rename\">' + Craft.t('app', 'Rename') + '</a></li>').appendTo($ul);\n                $('<li><a data-action=\"delete\">' + Craft.t('app', 'Delete') + '</a></li>').appendTo($ul);\n\n                new Garnish.MenuBtn($editBtn, {\n                    onOptionSelect: $.proxy(this, 'onTabOptionSelect')\n                });\n            }\n\n            // Don't forget the fields!\n            var $fields = $tab.children('.fld-tabcontent').children();\n\n            for (var i = 0; i < $fields.length; i++) {\n                this.initField($($fields[i]));\n            }\n        },\n\n        initField: function($field) {\n            var $editBtn = $field.find('.settings'),\n                $menu = $('<div class=\"menu\" data-align=\"center\"/>').insertAfter($editBtn),\n                $ul = $('<ul/>').appendTo($menu);\n\n            if ($field.hasClass('fld-required')) {\n                $('<li><a data-action=\"toggle-required\">' + Craft.t('app', 'Make not required') + '</a></li>').appendTo($ul);\n            }\n            else {\n                $('<li><a data-action=\"toggle-required\">' + Craft.t('app', 'Make required') + '</a></li>').appendTo($ul);\n            }\n\n            $('<li><a data-action=\"remove\">' + Craft.t('app', 'Remove') + '</a></li>').appendTo($ul);\n\n            new Garnish.MenuBtn($editBtn, {\n                onOptionSelect: $.proxy(this, 'onFieldOptionSelect')\n            });\n        },\n\n        onTabOptionSelect: function(option) {\n            if (!this.settings.customizableTabs) {\n                return;\n            }\n\n            var $option = $(option),\n                $tab = $option.data('menu').$anchor.parent().parent().parent(),\n                action = $option.data('action');\n\n            switch (action) {\n                case 'rename': {\n                    this.renameTab($tab);\n                    break;\n                }\n                case 'delete': {\n                    this.deleteTab($tab);\n                    break;\n                }\n            }\n        },\n\n        onFieldOptionSelect: function(option) {\n            var $option = $(option),\n                $field = $option.data('menu').$anchor.parent(),\n                action = $option.data('action');\n\n            switch (action) {\n                case 'toggle-required': {\n                    this.toggleRequiredField($field, $option);\n                    break;\n                }\n                case 'remove': {\n                    this.removeField($field);\n                    break;\n                }\n            }\n        },\n\n        renameTab: function($tab) {\n            if (!this.settings.customizableTabs) {\n                return;\n            }\n\n            var $labelSpan = $tab.find('.tabs .tab span'),\n                oldName = $labelSpan.text(),\n                newName = prompt(Craft.t('app', 'Give your tab a name.'), oldName);\n\n            if (newName && newName !== oldName) {\n                $labelSpan.text(newName);\n                $tab.find('.id-input').attr('name', this.getFieldInputName(newName));\n            }\n        },\n\n        deleteTab: function($tab) {\n            if (!this.settings.customizableTabs) {\n                return;\n            }\n\n            // Find all the fields in this tab\n            var $fields = $tab.find('.fld-field');\n\n            for (var i = 0; i < $fields.length; i++) {\n                var fieldId = $($fields[i]).attr('data-id');\n                this.removeFieldById(fieldId);\n            }\n\n            this.tabGrid.removeItems($tab);\n            this.tabDrag.removeItems($tab);\n\n            $tab.remove();\n        },\n\n        toggleRequiredField: function($field, $option) {\n            if ($field.hasClass('fld-required')) {\n                $field.removeClass('fld-required');\n                $field.find('.required-input').remove();\n\n                setTimeout(function() {\n                    $option.text(Craft.t('app', 'Make required'));\n                }, 500);\n            }\n            else {\n                $field.addClass('fld-required');\n                $('<input class=\"required-input\" type=\"hidden\" name=\"' + this.settings.requiredFieldInputName + '\" value=\"' + $field.data('id') + '\">').appendTo($field);\n\n                setTimeout(function() {\n                    $option.text(Craft.t('app', 'Make not required'));\n                }, 500);\n            }\n        },\n\n        removeField: function($field) {\n            var fieldId = $field.attr('data-id');\n\n            $field.remove();\n\n            this.removeFieldById(fieldId);\n            this.tabGrid.refreshCols(true);\n        },\n\n        removeFieldById: function(fieldId) {\n            var $field = this.$allFields.filter('[data-id=' + fieldId + ']:first'),\n                $group = $field.closest('.fld-tab');\n\n            $field.removeClass('hidden');\n\n            if ($group.hasClass('hidden')) {\n                $group.removeClass('hidden');\n                this.unusedFieldGrid.addItems($group);\n\n                if (this.settings.customizableTabs) {\n                    this.tabDrag.addItems($group);\n                }\n            }\n            else {\n                this.unusedFieldGrid.refreshCols(true);\n            }\n        },\n\n        addTab: function() {\n            if (!this.settings.customizableTabs) {\n                return;\n            }\n\n            var $tab = $('<div class=\"fld-tab\">' +\n                '<div class=\"tabs\">' +\n                '<div class=\"tab sel draggable\">' +\n                '<span>Tab ' + (this.tabGrid.$items.length + 1) + '</span>' +\n                '<a class=\"settings icon\" title=\"' + Craft.t('app', 'Rename') + '\"></a>' +\n                '</div>' +\n                '</div>' +\n                '<div class=\"fld-tabcontent\"></div>' +\n                '</div>').appendTo(this.$tabContainer);\n\n            this.tabGrid.addItems($tab);\n            this.tabDrag.addItems($tab);\n\n            this.initTab($tab);\n        },\n\n        getFieldInputName: function(tabName) {\n            return this.settings.fieldInputName.replace(/__TAB_NAME__/g, Craft.encodeUriComponent(tabName));\n        }\n    },\n    {\n        gridSettings: {\n            itemSelector: '.fld-tab:not(.hidden)',\n            minColWidth: 240,\n            fillMode: 'grid',\n            snapToGrid: 30\n        },\n        defaults: {\n            customizableTabs: true,\n            fieldInputName: 'fieldLayout[__TAB_NAME__][]',\n            requiredFieldInputName: 'requiredFields[]'\n        }\n    });\n\n\nCraft.FieldLayoutDesigner.BaseDrag = Garnish.Drag.extend(\n    {\n        designer: null,\n        $insertion: null,\n        showingInsertion: false,\n        $caboose: null,\n        draggingUnusedItem: false,\n        addToTabGrid: false,\n\n        /**\n         * Constructor\n         */\n        init: function(designer, settings) {\n            this.designer = designer;\n\n            // Find all the items from both containers\n            var $items = this.designer.$tabContainer.find(this.itemSelector)\n                .add(this.designer.$unusedFieldContainer.find(this.itemSelector));\n\n            this.base($items, settings);\n        },\n\n        /**\n         * On Drag Start\n         */\n        onDragStart: function() {\n            this.base();\n\n            // Are we dragging an unused item?\n            this.draggingUnusedItem = this.$draggee.hasClass('unused');\n\n            // Create the insertion\n            this.$insertion = this.getInsertion();\n\n            // Add the caboose\n            this.addCaboose();\n            this.$items = $().add(this.$items.add(this.$caboose));\n\n            if (this.addToTabGrid) {\n                this.designer.tabGrid.addItems(this.$caboose);\n            }\n\n            // Swap the draggee with the insertion if dragging a selected item\n            if (this.draggingUnusedItem) {\n                this.showingInsertion = false;\n            }\n            else {\n                // Actually replace the draggee with the insertion\n                this.$insertion.insertBefore(this.$draggee);\n                this.$draggee.detach();\n                this.$items = $().add(this.$items.not(this.$draggee).add(this.$insertion));\n                this.showingInsertion = true;\n\n                if (this.addToTabGrid) {\n                    this.designer.tabGrid.removeItems(this.$draggee);\n                    this.designer.tabGrid.addItems(this.$insertion);\n                }\n            }\n\n            this.setMidpoints();\n        },\n\n        /**\n         * Append the caboose\n         */\n        addCaboose: $.noop,\n\n        /**\n         * Returns the item's container\n         */\n        getItemContainer: $.noop,\n\n        /**\n         * Tests if an item is within the tab container.\n         */\n        isItemInTabContainer: function($item) {\n            return (this.getItemContainer($item)[0] === this.designer.$tabContainer[0]);\n        },\n\n        /**\n         * Sets the item midpoints up front so we don't have to keep checking on every mouse move\n         */\n        setMidpoints: function() {\n            for (var i = 0; i < this.$items.length; i++) {\n                var $item = $(this.$items[i]);\n\n                // Skip the unused tabs\n                if (!this.isItemInTabContainer($item)) {\n                    continue;\n                }\n\n                var offset = $item.offset();\n\n                $item.data('midpoint', {\n                    left: offset.left + $item.outerWidth() / 2,\n                    top: offset.top + $item.outerHeight() / 2\n                });\n            }\n        },\n\n        /**\n         * On Drag\n         */\n        onDrag: function() {\n            // Are we hovering over the tab container?\n            if (this.draggingUnusedItem && !Garnish.hitTest(this.mouseX, this.mouseY, this.designer.$tabContainer)) {\n                if (this.showingInsertion) {\n                    this.$insertion.remove();\n                    this.$items = $().add(this.$items.not(this.$insertion));\n                    this.showingInsertion = false;\n\n                    if (this.addToTabGrid) {\n                        this.designer.tabGrid.removeItems(this.$insertion);\n                    }\n                    else {\n                        this.designer.tabGrid.refreshCols(true);\n                    }\n\n                    this.setMidpoints();\n                }\n            }\n            else {\n                // Is there a new closest item?\n                this.onDrag._closestItem = this.getClosestItem();\n\n                if (this.onDrag._closestItem !== this.$insertion[0]) {\n                    if (this.showingInsertion &&\n                        ($.inArray(this.$insertion[0], this.$items) < $.inArray(this.onDrag._closestItem, this.$items)) &&\n                        ($.inArray(this.onDrag._closestItem, this.$caboose) === -1)\n                    ) {\n                        this.$insertion.insertAfter(this.onDrag._closestItem);\n                    }\n                    else {\n                        this.$insertion.insertBefore(this.onDrag._closestItem);\n                    }\n\n                    this.$items = $().add(this.$items.add(this.$insertion));\n                    this.showingInsertion = true;\n\n                    if (this.addToTabGrid) {\n                        this.designer.tabGrid.addItems(this.$insertion);\n                    }\n                    else {\n                        this.designer.tabGrid.refreshCols(true);\n                    }\n\n                    this.setMidpoints();\n                }\n            }\n\n            this.base();\n        },\n\n        /**\n         * Returns the closest item to the cursor.\n         */\n        getClosestItem: function() {\n            this.getClosestItem._closestItem = null;\n            this.getClosestItem._closestItemMouseDiff = null;\n\n            for (this.getClosestItem._i = 0; this.getClosestItem._i < this.$items.length; this.getClosestItem._i++) {\n                this.getClosestItem._$item = $(this.$items[this.getClosestItem._i]);\n\n                // Skip the unused tabs\n                if (!this.isItemInTabContainer(this.getClosestItem._$item)) {\n                    continue;\n                }\n\n                this.getClosestItem._midpoint = this.getClosestItem._$item.data('midpoint');\n                this.getClosestItem._mouseDiff = Garnish.getDist(this.getClosestItem._midpoint.left, this.getClosestItem._midpoint.top, this.mouseX, this.mouseY);\n\n                if (this.getClosestItem._closestItem === null || this.getClosestItem._mouseDiff < this.getClosestItem._closestItemMouseDiff) {\n                    this.getClosestItem._closestItem = this.getClosestItem._$item[0];\n                    this.getClosestItem._closestItemMouseDiff = this.getClosestItem._mouseDiff;\n                }\n            }\n\n            return this.getClosestItem._closestItem;\n        },\n\n        /**\n         * On Drag Stop\n         */\n        onDragStop: function() {\n            if (this.showingInsertion) {\n                this.$insertion.replaceWith(this.$draggee);\n                this.$items = $().add(this.$items.not(this.$insertion).add(this.$draggee));\n\n                if (this.addToTabGrid) {\n                    this.designer.tabGrid.removeItems(this.$insertion);\n                    this.designer.tabGrid.addItems(this.$draggee);\n                }\n            }\n\n            // Drop the caboose\n            this.$items = this.$items.not(this.$caboose);\n            this.$caboose.remove();\n\n            if (this.addToTabGrid) {\n                this.designer.tabGrid.removeItems(this.$caboose);\n            }\n\n            // \"show\" the drag items, but make them invisible\n            this.$draggee.css({\n                display: this.draggeeDisplay,\n                visibility: 'hidden'\n            });\n\n            this.designer.tabGrid.refreshCols(true);\n            this.designer.unusedFieldGrid.refreshCols(true);\n\n            // return the helpers to the draggees\n            this.returnHelpersToDraggees();\n\n            this.base();\n        }\n    });\n\n\nCraft.FieldLayoutDesigner.TabDrag = Craft.FieldLayoutDesigner.BaseDrag.extend(\n    {\n        itemSelector: '> div.fld-tab',\n        addToTabGrid: true,\n\n        /**\n         * Constructor\n         */\n        init: function(designer) {\n            var settings = {\n                handle: '.tab'\n            };\n\n            this.base(designer, settings);\n        },\n\n        /**\n         * Append the caboose\n         */\n        addCaboose: function() {\n            this.$caboose = $('<div class=\"fld-tab fld-tab-caboose\"/>').appendTo(this.designer.$tabContainer);\n        },\n\n        /**\n         * Returns the insertion\n         */\n        getInsertion: function() {\n            var $tab = this.$draggee.find('.tab');\n\n            return $('<div class=\"fld-tab fld-insertion\" style=\"height: ' + this.$draggee.height() + 'px;\">' +\n                '<div class=\"tabs\"><div class=\"tab sel draggable\" style=\"width: ' + $tab.width() + 'px; height: ' + $tab.height() + 'px;\"></div></div>' +\n                '<div class=\"fld-tabcontent\" style=\"height: ' + this.$draggee.find('.fld-tabcontent').height() + 'px;\"></div>' +\n                '</div>');\n        },\n\n        /**\n         * Returns the item's container\n         */\n        getItemContainer: function($item) {\n            return $item.parent();\n        },\n\n        /**\n         * On Drag Stop\n         */\n        onDragStop: function() {\n            if (this.draggingUnusedItem && this.showingInsertion) {\n                // Create a new tab based on that field group\n                var $tab = this.$draggee.clone().removeClass('unused'),\n                    tabName = $tab.find('.tab span').text();\n\n                $tab.find('.fld-field').removeClass('unused');\n\n                // Add the edit button\n                $tab.find('.tabs .tab').append('<a class=\"settings icon\" title=\"' + Craft.t('app', 'Edit') + '\"></a>');\n\n                // Remove any hidden fields\n                var $fields = $tab.find('.fld-field'),\n                    $hiddenFields = $fields.filter('.hidden').remove();\n\n                $fields = $fields.not($hiddenFields);\n                $fields.prepend('<a class=\"settings icon\" title=\"' + Craft.t('app', 'Edit') + '\"></a>');\n\n                for (var i = 0; i < $fields.length; i++) {\n                    var $field = $($fields[i]),\n                        inputName = this.designer.getFieldInputName(tabName);\n\n                    $field.append('<input class=\"id-input\" type=\"hidden\" name=\"' + inputName + '\" value=\"' + $field.data('id') + '\">');\n                }\n\n                this.designer.fieldDrag.addItems($fields);\n\n                this.designer.initTab($tab);\n\n                // Set the unused field group and its fields to hidden\n                this.$draggee.css({visibility: 'inherit', display: 'field'}).addClass('hidden');\n                this.$draggee.find('.fld-field').addClass('hidden');\n\n                // Set this.$draggee to the clone, as if we were dragging that all along\n                this.$draggee = $tab;\n\n                // Remember it for later\n                this.addItems($tab);\n\n                // Update the grids\n                this.designer.tabGrid.addItems($tab);\n                this.designer.unusedFieldGrid.removeItems(this.$draggee);\n            }\n\n            this.base();\n        }\n    });\n\n\nCraft.FieldLayoutDesigner.FieldDrag = Craft.FieldLayoutDesigner.BaseDrag.extend(\n    {\n        itemSelector: '> div.fld-tab .fld-field',\n\n        /**\n         * Append the caboose\n         */\n        addCaboose: function() {\n            this.$caboose = $();\n\n            var $fieldContainers = this.designer.$tabContainer.children().children('.fld-tabcontent');\n\n            for (var i = 0; i < $fieldContainers.length; i++) {\n                var $caboose = $('<div class=\"fld-tab fld-tab-caboose\"/>').appendTo($fieldContainers[i]);\n                this.$caboose = this.$caboose.add($caboose);\n            }\n        },\n\n        /**\n         * Returns the insertion\n         */\n        getInsertion: function() {\n            return $('<div class=\"fld-field fld-insertion\" style=\"height: ' + this.$draggee.height() + 'px;\"/>');\n        },\n\n        /**\n         * Returns the item's container\n         */\n        getItemContainer: function($item) {\n            return $item.parent().parent().parent();\n        },\n\n        /**\n         * On Drag Stop\n         */\n        onDragStop: function() {\n            if (this.draggingUnusedItem && this.showingInsertion) {\n                // Create a new field based on that one\n                var $field = this.$draggee.clone().removeClass('unused');\n                $field.prepend('<a class=\"settings icon\" title=\"' + Craft.t('app', 'Edit') + '\"></a>');\n                this.designer.initField($field);\n\n                // Hide the unused field\n                this.$draggee.css({visibility: 'inherit', display: 'field'}).addClass('hidden');\n\n                // Hide the group too?\n                if (this.$draggee.siblings(':not(.hidden)').length === 0) {\n                    var $group = this.$draggee.parent().parent();\n                    $group.addClass('hidden');\n                    this.designer.unusedFieldGrid.removeItems($group);\n                }\n\n                // Set this.$draggee to the clone, as if we were dragging that all along\n                this.$draggee = $field;\n\n                // Remember it for later\n                this.addItems($field);\n            }\n\n            if (this.showingInsertion) {\n                // Find the field's new tab name\n                var tabName = this.$insertion.parent().parent().find('.tab span').text(),\n                    inputName = this.designer.getFieldInputName(tabName);\n\n                if (this.draggingUnusedItem) {\n                    this.$draggee.append('<input class=\"id-input\" type=\"hidden\" name=\"' + inputName + '\" value=\"' + this.$draggee.data('id') + '\">');\n                }\n                else {\n                    this.$draggee.find('.id-input').attr('name', inputName);\n                }\n            }\n\n            this.base();\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * FieldToggle\n */\nCraft.FieldToggle = Garnish.Base.extend(\n    {\n        $toggle: null,\n        targetPrefix: null,\n        targetSelector: null,\n        reverseTargetSelector: null,\n\n        _$target: null,\n        _$reverseTarget: null,\n        type: null,\n\n        init: function(toggle) {\n            this.$toggle = $(toggle);\n\n            // Is this already a field toggle?\n            if (this.$toggle.data('fieldtoggle')) {\n                Garnish.log('Double-instantiating a field toggle on an element');\n                this.$toggle.data('fieldtoggle').destroy();\n            }\n\n            this.$toggle.data('fieldtoggle', this);\n\n            this.type = this.getType();\n\n            if (this.type === 'select') {\n                this.targetPrefix = (this.$toggle.attr('data-target-prefix') || '');\n            }\n            else {\n                this.targetSelector = this.normalizeTargetSelector(this.$toggle.data('target'));\n                this.reverseTargetSelector = this.normalizeTargetSelector(this.$toggle.data('reverse-target'));\n            }\n\n            this.findTargets();\n\n            if (this.type === 'link') {\n                this.addListener(this.$toggle, 'click', 'onToggleChange');\n            }\n            else {\n                this.addListener(this.$toggle, 'change', 'onToggleChange');\n            }\n        },\n\n        normalizeTargetSelector: function(selector) {\n            if (selector && !selector.match(/^[#\\.]/)) {\n                selector = '#' + selector;\n            }\n\n            return selector;\n        },\n\n        getType: function() {\n            if (this.$toggle.prop('nodeName') === 'INPUT' && this.$toggle.attr('type').toLowerCase() === 'checkbox') {\n                return 'checkbox';\n            }\n            else if (this.$toggle.prop('nodeName') === 'SELECT') {\n                return 'select';\n            }\n            else if (this.$toggle.prop('nodeName') === 'A') {\n                return 'link';\n            }\n            else if (this.$toggle.prop('nodeName') === 'DIV' && this.$toggle.hasClass('lightswitch')) {\n                return 'lightswitch';\n            }\n        },\n\n        findTargets: function() {\n            if (this.type === 'select') {\n                this._$target = $(this.normalizeTargetSelector(this.targetPrefix + this.getToggleVal()));\n            }\n            else {\n                if (this.targetSelector) {\n                    this._$target = $(this.targetSelector);\n                }\n\n                if (this.reverseTargetSelector) {\n                    this._$reverseTarget = $(this.reverseTargetSelector);\n                }\n            }\n        },\n\n        getToggleVal: function() {\n            if (this.type === 'lightswitch') {\n                return this.$toggle.children('input').val();\n            }\n            else {\n                var postVal = Garnish.getInputPostVal(this.$toggle);\n                return postVal === null ? null : postVal.replace(/[\\[\\]\\\\]+/g, '-');\n            }\n        },\n\n        onToggleChange: function() {\n            if (this.type === 'select') {\n                this.hideTarget(this._$target);\n                this.findTargets();\n                this.showTarget(this._$target);\n            }\n            else {\n                if (this.type === 'link') {\n                    this.onToggleChange._show = this.$toggle.hasClass('collapsed') || !this.$toggle.hasClass('expanded');\n                }\n                else {\n                    this.onToggleChange._show = !!this.getToggleVal();\n                }\n\n                if (this.onToggleChange._show) {\n                    this.showTarget(this._$target);\n                    this.hideTarget(this._$reverseTarget);\n                }\n                else {\n                    this.hideTarget(this._$target);\n                    this.showTarget(this._$reverseTarget);\n                }\n\n                delete this.onToggleChange._show;\n            }\n        },\n\n        showTarget: function($target) {\n            if ($target && $target.length) {\n                this.showTarget._currentHeight = $target.height();\n\n                $target.removeClass('hidden');\n\n                if (this.type !== 'select') {\n                    if (this.type === 'link') {\n                        this.$toggle.removeClass('collapsed');\n                        this.$toggle.addClass('expanded');\n                    }\n\n                    $target.height('auto');\n                    this.showTarget._targetHeight = $target.height();\n                    $target.css({\n                        height: this.showTarget._currentHeight,\n                        overflow: 'hidden'\n                    });\n\n                    $target.velocity('stop');\n\n                    $target.velocity({height: this.showTarget._targetHeight}, 'fast', function() {\n                        $target.css({\n                            height: '',\n                            overflow: ''\n                        });\n                    });\n\n                    delete this.showTarget._targetHeight;\n                }\n\n                delete this.showTarget._currentHeight;\n\n                // Trigger a resize event in case there are any grids in the target that need to initialize\n                Garnish.$win.trigger('resize');\n            }\n        },\n\n        hideTarget: function($target) {\n            if ($target && $target.length) {\n                if (this.type === 'select') {\n                    $target.addClass('hidden');\n                }\n                else {\n                    if (this.type === 'link') {\n                        this.$toggle.removeClass('expanded');\n                        this.$toggle.addClass('collapsed');\n                    }\n\n                    $target.css('overflow', 'hidden');\n                    $target.velocity('stop');\n                    $target.velocity({height: 0}, 'fast', function() {\n                        $target.addClass('hidden');\n                    });\n                }\n            }\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\nCraft.Grid = Garnish.Base.extend(\n    {\n        $container: null,\n\n        $items: null,\n        items: null,\n        totalCols: null,\n        colGutterDrop: null,\n        colPctWidth: null,\n\n        possibleItemColspans: null,\n        possibleItemPositionsByColspan: null,\n\n        itemPositions: null,\n        itemColspansByPosition: null,\n\n        layouts: null,\n        layout: null,\n        itemHeights: null,\n        leftPadding: null,\n\n        _refreshingCols: false,\n        _refreshColsAfterRefresh: false,\n        _forceRefreshColsAfterRefresh: false,\n\n        init: function(container, settings) {\n            this.$container = $(container);\n\n            // Is this already a grid?\n            if (this.$container.data('grid')) {\n                Garnish.log('Double-instantiating a grid on an element');\n                this.$container.data('grid').destroy();\n            }\n\n            this.$container.data('grid', this);\n\n            this.setSettings(settings, Craft.Grid.defaults);\n\n            // Set the refreshCols() proxy that container resizes will trigger\n            this.handleContainerHeightProxy = $.proxy(function() {\n                this.refreshCols(false, true);\n            }, this);\n\n            this.$items = this.$container.children(this.settings.itemSelector);\n            this.setItems();\n            this.refreshCols(true, false);\n\n            Garnish.$doc.ready($.proxy(function() {\n                this.refreshCols(false, false);\n            }, this));\n        },\n\n        addItems: function(items) {\n            this.$items = $().add(this.$items.add(items));\n            this.setItems();\n            this.refreshCols(true, true);\n        },\n\n        removeItems: function(items) {\n            this.$items = $().add(this.$items.not(items));\n            this.setItems();\n            this.refreshCols(true, true);\n        },\n\n        resetItemOrder: function() {\n            this.$items = $().add(this.$items);\n            this.setItems();\n            this.refreshCols(true, true);\n        },\n\n        setItems: function() {\n            this.setItems._ = {};\n\n            this.items = [];\n\n            for (this.setItems._.i = 0; this.setItems._.i < this.$items.length; this.setItems._.i++) {\n                this.items.push($(this.$items[this.setItems._.i]));\n            }\n\n            delete this.setItems._;\n        },\n\n        refreshCols: function(force) {\n            if (this._refreshingCols) {\n                this._refreshColsAfterRefresh = true;\n                if (force) {\n                    this._forceRefreshColsAfterRefresh = true;\n                }\n                return;\n            }\n\n            this._refreshingCols = true;\n\n            if (!this.items.length) {\n                this.completeRefreshCols();\n                return;\n            }\n\n            this.refreshCols._ = {};\n\n            // Check to see if the grid is actually visible\n            this.refreshCols._.oldHeight = this.$container[0].style.height;\n            this.$container[0].style.height = 1;\n            this.refreshCols._.scrollHeight = this.$container[0].scrollHeight;\n            this.$container[0].style.height = this.refreshCols._.oldHeight;\n\n            if (this.refreshCols._.scrollHeight === 0) {\n                this.completeRefreshCols();\n                return;\n            }\n\n            if (this.settings.cols) {\n                this.refreshCols._.totalCols = this.settings.cols;\n            }\n            else {\n                this.refreshCols._.totalCols = Math.floor(this.$container.width() / this.settings.minColWidth);\n\n                // If we're adding a new column, require an extra 20 pixels in case a scrollbar shows up\n                if (this.totalCols !== null && this.refreshCols._.totalCols > this.totalCols) {\n                    this.refreshCols._.totalCols = Math.floor((this.$container.width() - 20) / this.settings.minColWidth)\n                }\n\n                if (this.settings.maxCols && this.refreshCols._.totalCols > this.settings.maxCols) {\n                    this.refreshCols._.totalCols = this.settings.maxCols;\n                }\n            }\n\n            if (this.refreshCols._.totalCols === 0) {\n                this.refreshCols._.totalCols = 1;\n            }\n\n            // Same number of columns as before?\n            if (force !== true && this.totalCols === this.refreshCols._.totalCols) {\n                this.completeRefreshCols();\n                return;\n            }\n\n            this.totalCols = this.refreshCols._.totalCols;\n            this.colGutterDrop = this.settings.gutter * (this.totalCols - 1) / this.totalCols;\n\n            // Temporarily stop listening to container resizes\n            this.removeListener(this.$container, 'resize');\n\n            if (this.settings.fillMode === 'grid') {\n                this.refreshCols._.itemIndex = 0;\n\n                while (this.refreshCols._.itemIndex < this.items.length) {\n                    // Append the next X items and figure out which one is the tallest\n                    this.refreshCols._.tallestItemHeight = -1;\n                    this.refreshCols._.colIndex = 0;\n\n                    for (this.refreshCols._.i = this.refreshCols._.itemIndex; (this.refreshCols._.i < this.refreshCols._.itemIndex + this.totalCols && this.refreshCols._.i < this.items.length); this.refreshCols._.i++) {\n                        this.refreshCols._.itemHeight = this.items[this.refreshCols._.i].height('auto').height();\n\n                        if (this.refreshCols._.itemHeight > this.refreshCols._.tallestItemHeight) {\n                            this.refreshCols._.tallestItemHeight = this.refreshCols._.itemHeight;\n                        }\n\n                        this.refreshCols._.colIndex++;\n                    }\n\n                    if (this.settings.snapToGrid) {\n                        this.refreshCols._.remainder = this.refreshCols._.tallestItemHeight % this.settings.snapToGrid;\n\n                        if (this.refreshCols._.remainder) {\n                            this.refreshCols._.tallestItemHeight += this.settings.snapToGrid - this.refreshCols._.remainder;\n                        }\n                    }\n\n                    // Now set their heights to the tallest one\n                    for (this.refreshCols._.i = this.refreshCols._.itemIndex; (this.refreshCols._.i < this.refreshCols._.itemIndex + this.totalCols && this.refreshCols._.i < this.items.length); this.refreshCols._.i++) {\n                        this.items[this.refreshCols._.i].height(this.refreshCols._.tallestItemHeight);\n                    }\n\n                    // set the this.refreshCols._.itemIndex pointer to the next one up\n                    this.refreshCols._.itemIndex += this.totalCols;\n                }\n            }\n            else {\n                this.removeListener(this.$items, 'resize');\n\n                // If there's only one column, sneak out early\n                if (this.totalCols === 1) {\n                    this.$container.height('auto');\n                    this.$items\n                        .show()\n                        .css({\n                            position: 'relative',\n                            width: 'auto',\n                            top: 0\n                        })\n                        .css(Craft.left, 0);\n                }\n                else {\n                    this.$items.css('position', 'absolute');\n                    this.colPctWidth = (100 / this.totalCols);\n\n                    // The setup\n\n                    this.layouts = [];\n\n                    this.itemPositions = [];\n                    this.itemColspansByPosition = [];\n\n                    // Figure out all of the possible colspans for each item,\n                    // as well as all the possible positions for each item at each of its colspans\n\n                    this.possibleItemColspans = [];\n                    this.possibleItemPositionsByColspan = [];\n                    this.itemHeightsByColspan = [];\n\n                    for (this.refreshCols._.item = 0; this.refreshCols._.item < this.items.length; this.refreshCols._.item++) {\n                        this.possibleItemColspans[this.refreshCols._.item] = [];\n                        this.possibleItemPositionsByColspan[this.refreshCols._.item] = {};\n                        this.itemHeightsByColspan[this.refreshCols._.item] = {};\n\n                        this.refreshCols._.$item = this.items[this.refreshCols._.item].show();\n                        this.refreshCols._.positionRight = (this.refreshCols._.$item.data('position') === 'right');\n                        this.refreshCols._.positionLeft = (this.refreshCols._.$item.data('position') === 'left');\n                        this.refreshCols._.minColspan = (this.refreshCols._.$item.data('colspan') ? this.refreshCols._.$item.data('colspan') : (this.refreshCols._.$item.data('min-colspan') ? this.refreshCols._.$item.data('min-colspan') : 1));\n                        this.refreshCols._.maxColspan = (this.refreshCols._.$item.data('colspan') ? this.refreshCols._.$item.data('colspan') : (this.refreshCols._.$item.data('max-colspan') ? this.refreshCols._.$item.data('max-colspan') : this.totalCols));\n\n                        if (this.refreshCols._.minColspan > this.totalCols) {\n                            this.refreshCols._.minColspan = this.totalCols;\n                        }\n                        if (this.refreshCols._.maxColspan > this.totalCols) {\n                            this.refreshCols._.maxColspan = this.totalCols;\n                        }\n\n                        for (this.refreshCols._.colspan = this.refreshCols._.minColspan; this.refreshCols._.colspan <= this.refreshCols._.maxColspan; this.refreshCols._.colspan++) {\n                            // Get the height for this colspan\n                            this.refreshCols._.$item.css('width', this.getItemWidthCss(this.refreshCols._.colspan));\n                            this.itemHeightsByColspan[this.refreshCols._.item][this.refreshCols._.colspan] = this.refreshCols._.$item.outerHeight();\n\n                            this.possibleItemColspans[this.refreshCols._.item].push(this.refreshCols._.colspan);\n                            this.possibleItemPositionsByColspan[this.refreshCols._.item][this.refreshCols._.colspan] = [];\n\n                            if (this.refreshCols._.positionLeft) {\n                                this.refreshCols._.minPosition = 0;\n                                this.refreshCols._.maxPosition = 0;\n                            }\n                            else if (this.refreshCols._.positionRight) {\n                                this.refreshCols._.minPosition = this.totalCols - this.refreshCols._.colspan;\n                                this.refreshCols._.maxPosition = this.refreshCols._.minPosition;\n                            }\n                            else {\n                                this.refreshCols._.minPosition = 0;\n                                this.refreshCols._.maxPosition = this.totalCols - this.refreshCols._.colspan;\n                            }\n\n                            for (this.refreshCols._.position = this.refreshCols._.minPosition; this.refreshCols._.position <= this.refreshCols._.maxPosition; this.refreshCols._.position++) {\n                                this.possibleItemPositionsByColspan[this.refreshCols._.item][this.refreshCols._.colspan].push(this.refreshCols._.position);\n                            }\n                        }\n                    }\n\n                    // Find all the possible layouts\n\n                    this.refreshCols._.colHeights = [];\n\n                    for (this.refreshCols._.i = 0; this.refreshCols._.i < this.totalCols; this.refreshCols._.i++) {\n                        this.refreshCols._.colHeights.push(0);\n                    }\n\n                    this.createLayouts(0, [], [], this.refreshCols._.colHeights, 0);\n\n                    // Now find the layout that looks the best.\n\n                    // First find the layouts with the highest number of used columns\n                    this.refreshCols._.layoutTotalCols = [];\n\n                    for (this.refreshCols._.i = 0; this.refreshCols._.i < this.layouts.length; this.refreshCols._.i++) {\n                        this.refreshCols._.layoutTotalCols[this.refreshCols._.i] = 0;\n\n                        for (this.refreshCols._.j = 0; this.refreshCols._.j < this.totalCols; this.refreshCols._.j++) {\n                            if (this.layouts[this.refreshCols._.i].colHeights[this.refreshCols._.j]) {\n                                this.refreshCols._.layoutTotalCols[this.refreshCols._.i]++;\n                            }\n                        }\n                    }\n\n                    this.refreshCols._.highestTotalCols = Math.max.apply(null, this.refreshCols._.layoutTotalCols);\n\n                    // Filter out the ones that aren't using as many columns as they could be\n                    for (this.refreshCols._.i = this.layouts.length - 1; this.refreshCols._.i >= 0; this.refreshCols._.i--) {\n                        if (this.refreshCols._.layoutTotalCols[this.refreshCols._.i] !== this.refreshCols._.highestTotalCols) {\n                            this.layouts.splice(this.refreshCols._.i, 1);\n                        }\n                    }\n\n                    // Find the layout(s) with the least overall height\n                    this.refreshCols._.layoutHeights = [];\n\n                    for (this.refreshCols._.i = 0; this.refreshCols._.i < this.layouts.length; this.refreshCols._.i++) {\n                        this.refreshCols._.layoutHeights.push(Math.max.apply(null, this.layouts[this.refreshCols._.i].colHeights));\n                    }\n\n                    this.refreshCols._.shortestHeight = Math.min.apply(null, this.refreshCols._.layoutHeights);\n                    this.refreshCols._.shortestLayouts = [];\n                    this.refreshCols._.emptySpaces = [];\n\n                    for (this.refreshCols._.i = 0; this.refreshCols._.i < this.refreshCols._.layoutHeights.length; this.refreshCols._.i++) {\n                        if (this.refreshCols._.layoutHeights[this.refreshCols._.i] === this.refreshCols._.shortestHeight) {\n                            this.refreshCols._.shortestLayouts.push(this.layouts[this.refreshCols._.i]);\n\n                            // Now get its total empty space, including any trailing empty space\n                            this.refreshCols._.emptySpace = this.layouts[this.refreshCols._.i].emptySpace;\n\n                            for (this.refreshCols._.j = 0; this.refreshCols._.j < this.totalCols; this.refreshCols._.j++) {\n                                this.refreshCols._.emptySpace += (this.refreshCols._.shortestHeight - this.layouts[this.refreshCols._.i].colHeights[this.refreshCols._.j]);\n                            }\n\n                            this.refreshCols._.emptySpaces.push(this.refreshCols._.emptySpace);\n                        }\n                    }\n\n                    // And the layout with the least empty space is...\n                    this.layout = this.refreshCols._.shortestLayouts[$.inArray(Math.min.apply(null, this.refreshCols._.emptySpaces), this.refreshCols._.emptySpaces)];\n\n                    // Set the item widths and left positions\n                    for (this.refreshCols._.i = 0; this.refreshCols._.i < this.items.length; this.refreshCols._.i++) {\n                        this.refreshCols._.css = {\n                            width: this.getItemWidthCss(this.layout.colspans[this.refreshCols._.i])\n                        };\n                        this.refreshCols._.css[Craft.left] = this.getItemLeftPosCss(this.layout.positions[this.refreshCols._.i]);\n                        this.items[this.refreshCols._.i].css(this.refreshCols._.css);\n                    }\n\n                    // If every item is at position 0, then let them lay out au naturel\n                    if (this.isSimpleLayout()) {\n\n                        this.$container.height('auto');\n                        this.$items.css({\n                            position: 'relative',\n                            top: 0,\n                            'margin-bottom': this.settings.gutter+'px'\n                        });\n                    }\n                    else {\n                        this.$items.css('position', 'absolute');\n\n                        // Now position the items\n                        this.positionItems();\n\n                        // Update the positions as the items' heigthts change\n                        this.addListener(this.$items, 'resize', 'onItemResize');\n                    }\n                }\n            }\n\n            this.completeRefreshCols();\n\n            // Resume container resize listening\n            this.addListener(this.$container, 'resize', this.handleContainerHeightProxy);\n\n            this.onRefreshCols();\n        },\n\n        completeRefreshCols: function() {\n            // Delete the internal variable object\n            if (typeof this.refreshCols._ !== 'undefined') {\n                delete this.refreshCols._;\n            }\n\n            this._refreshingCols = false;\n\n            if (this._refreshColsAfterRefresh) {\n                var force = this._forceRefreshColsAfterRefresh;\n                this._refreshColsAfterRefresh = false;\n                this._forceRefreshColsAfterRefresh = false;\n\n                Garnish.requestAnimationFrame($.proxy(function() {\n                    this.refreshCols(force);\n                }, this));\n            }\n        },\n\n        getItemWidth: function(colspan) {\n            return (this.colPctWidth * colspan);\n        },\n\n        getItemWidthCss: function(colspan) {\n            return 'calc(' + this.getItemWidth(colspan) + '% - ' + this.colGutterDrop + 'px)';\n        },\n\n        getItemWidthInPx: function(colspan) {\n            return this.getItemWidth(colspan)/100 * this.$container.width() - this.colGutterDrop;\n        },\n\n        getItemLeftPosCss: function(position) {\n            return 'calc(' + '(' + this.getItemWidth(1) + '% + ' + (this.settings.gutter - this.colGutterDrop) + 'px) * ' + position + ')';\n        },\n\n        getItemLeftPosInPx: function(position) {\n            return (this.getItemWidth(1)/100 * this.$container.width() + (this.settings.gutter - this.colGutterDrop)) * position;\n        },\n\n        createLayouts: function(item, prevPositions, prevColspans, prevColHeights, prevEmptySpace) {\n            (new Craft.Grid.LayoutGenerator(this)).createLayouts(item, prevPositions, prevColspans, prevColHeights, prevEmptySpace);\n        },\n\n        isSimpleLayout: function() {\n            this.isSimpleLayout._ = {};\n\n            for (this.isSimpleLayout._.i = 0; this.isSimpleLayout._.i < this.layout.positions.length; this.isSimpleLayout._.i++) {\n                if (this.layout.positions[this.isSimpleLayout._.i] !== 0) {\n                    delete this.isSimpleLayout._;\n                    return false;\n                }\n            }\n\n            delete this.isSimpleLayout._;\n            return true;\n        },\n\n        positionItems: function() {\n            this.positionItems._ = {};\n\n            this.positionItems._.colHeights = [];\n\n            for (this.positionItems._.i = 0; this.positionItems._.i < this.totalCols; this.positionItems._.i++) {\n                this.positionItems._.colHeights.push(0);\n            }\n\n            for (this.positionItems._.i = 0; this.positionItems._.i < this.items.length; this.positionItems._.i++) {\n                this.positionItems._.endingCol = this.layout.positions[this.positionItems._.i] + this.layout.colspans[this.positionItems._.i] - 1;\n                this.positionItems._.affectedColHeights = [];\n\n                for (this.positionItems._.col = this.layout.positions[this.positionItems._.i]; this.positionItems._.col <= this.positionItems._.endingCol; this.positionItems._.col++) {\n                    this.positionItems._.affectedColHeights.push(this.positionItems._.colHeights[this.positionItems._.col]);\n                }\n\n                this.positionItems._.top = Math.max.apply(null, this.positionItems._.affectedColHeights);\n                if (this.positionItems._.top > 0) {\n                    this.positionItems._.top += this.settings.gutter;\n                }\n\n                this.items[this.positionItems._.i].css('top', this.positionItems._.top);\n\n                // Now add the new heights to those columns\n                for (this.positionItems._.col = this.layout.positions[this.positionItems._.i]; this.positionItems._.col <= this.positionItems._.endingCol; this.positionItems._.col++) {\n                    this.positionItems._.colHeights[this.positionItems._.col] = this.positionItems._.top + this.itemHeightsByColspan[this.positionItems._.i][this.layout.colspans[this.positionItems._.i]];\n                }\n            }\n\n            // Set the container height\n            this.$container.height(Math.max.apply(null, this.positionItems._.colHeights));\n\n            delete this.positionItems._;\n        },\n\n        onItemResize: function(ev) {\n            this.onItemResize._ = {};\n\n            // Prevent this from bubbling up to the container, which has its own resize listener\n            ev.stopPropagation();\n\n            this.onItemResize._.item = $.inArray(ev.currentTarget, this.$items);\n\n            if (this.onItemResize._.item !== -1) {\n                // Update the height and reposition the items\n                this.onItemResize._.newHeight = this.items[this.onItemResize._.item].outerHeight();\n\n                if (this.onItemResize._.newHeight !== this.itemHeightsByColspan[this.onItemResize._.item][this.layout.colspans[this.onItemResize._.item]]) {\n                    this.itemHeightsByColspan[this.onItemResize._.item][this.layout.colspans[this.onItemResize._.item]] = this.onItemResize._.newHeight;\n                    this.positionItems(false);\n                }\n            }\n\n            delete this.onItemResize._;\n        },\n\n        onRefreshCols: function() {\n            this.trigger('refreshCols');\n            this.settings.onRefreshCols();\n        }\n    },\n    {\n        defaults: {\n            itemSelector: '.item',\n            cols: null,\n            maxCols: null,\n            minColWidth: 320,\n            gutter: 14,\n            fillMode: 'top',\n            colClass: 'col',\n            snapToGrid: null,\n\n            onRefreshCols: $.noop\n        }\n    });\n\n\nCraft.Grid.LayoutGenerator = Garnish.Base.extend(\n    {\n        grid: null,\n        _: null,\n\n        init: function(grid) {\n            this.grid = grid;\n        },\n\n        createLayouts: function(item, prevPositions, prevColspans, prevColHeights, prevEmptySpace) {\n            this._ = {};\n\n            // Loop through all possible colspans\n            for (this._.c = 0; this._.c < this.grid.possibleItemColspans[item].length; this._.c++) {\n                this._.colspan = this.grid.possibleItemColspans[item][this._.c];\n\n                // Loop through all the possible positions for this colspan,\n                // and find the one that is closest to the top\n\n                this._.tallestColHeightsByPosition = [];\n\n                for (this._.p = 0; this._.p < this.grid.possibleItemPositionsByColspan[item][this._.colspan].length; this._.p++) {\n                    this._.position = this.grid.possibleItemPositionsByColspan[item][this._.colspan][this._.p];\n\n                    this._.colHeightsForPosition = [];\n                    this._.endingCol = this._.position + this._.colspan - 1;\n\n                    for (this._.col = this._.position; this._.col <= this._.endingCol; this._.col++) {\n                        this._.colHeightsForPosition.push(prevColHeights[this._.col]);\n                    }\n\n                    this._.tallestColHeightsByPosition[this._.p] = Math.max.apply(null, this._.colHeightsForPosition);\n                }\n\n                // And the shortest position for this colspan is...\n                this._.p = $.inArray(Math.min.apply(null, this._.tallestColHeightsByPosition), this._.tallestColHeightsByPosition);\n                this._.position = this.grid.possibleItemPositionsByColspan[item][this._.colspan][this._.p];\n\n                // Now log the colspan/position placement\n                this._.positions = prevPositions.slice(0);\n                this._.colspans = prevColspans.slice(0);\n                this._.colHeights = prevColHeights.slice(0);\n                this._.emptySpace = prevEmptySpace;\n\n                this._.positions.push(this._.position);\n                this._.colspans.push(this._.colspan);\n\n                // Add the new heights to those columns\n                this._.tallestColHeight = this._.tallestColHeightsByPosition[this._.p];\n                this._.endingCol = this._.position + this._.colspan - 1;\n\n                for (this._.col = this._.position; this._.col <= this._.endingCol; this._.col++) {\n                    this._.emptySpace += this._.tallestColHeight - this._.colHeights[this._.col];\n                    this._.colHeights[this._.col] = this._.tallestColHeight + this.grid.itemHeightsByColspan[item][this._.colspan];\n                }\n\n                // If this is the last item, create the layout\n                if (item === this.grid.items.length - 1) {\n                    this.grid.layouts.push({\n                        positions: this._.positions,\n                        colspans: this._.colspans,\n                        colHeights: this._.colHeights,\n                        emptySpace: this._.emptySpace\n                    });\n                }\n                else {\n                    // Dive deeper\n                    this.grid.createLayouts(item + 1, this._.positions, this._.colspans, this._.colHeights, this._.emptySpace);\n                }\n            }\n\n            delete this._;\n        }\n\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Handle Generator\n */\nCraft.HandleGenerator = Craft.BaseInputGenerator.extend(\n    {\n        generateTargetValue: function(sourceVal) {\n            // Remove HTML tags\n            var handle = sourceVal.replace(\"/<(.*?)>/g\", '');\n\n            // Remove inner-word punctuation\n            handle = handle.replace(/['\"\u2018\u2019\u201c\u201d\\[\\]\\(\\)\\{\\}:]/g, '');\n\n            // Make it lowercase\n            handle = handle.toLowerCase();\n\n            // Convert extended ASCII characters to basic ASCII\n            handle = Craft.asciiString(handle);\n\n            if (!this.settings.allowNonAlphaStart) {\n                // Handle must start with a letter\n                handle = handle.replace(/^[^a-z]+/, '');\n            }\n\n            // Get the \"words\"\n            var words = Craft.filterArray(handle.split(/[^a-z0-9]+/));\n            handle = '';\n\n            // Make it camelCase\n            for (var i = 0; i < words.length; i++) {\n                if (i === 0) {\n                    handle += words[i];\n                }\n                else {\n                    handle += words[i].charAt(0).toUpperCase() + words[i].substr(1);\n                }\n            }\n\n            return handle;\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n\n/**\n * Image upload class for user photos, site icon and logo.\n */\nCraft.ImageUpload = Garnish.Base.extend(\n    {\n        $container: null,\n        progressBar: null,\n        uploader: null,\n\n        init: function(settings) {\n            this.setSettings(settings, Craft.ImageUpload.defaults);\n            this.initImageUpload();\n        },\n\n        initImageUpload: function() {\n            this.$container = $(this.settings.containerSelector);\n            this.progressBar = new Craft.ProgressBar($('<div class=\"progress-shade\"></div>').appendTo(this.$container));\n\n            var options = {\n                url: Craft.getActionUrl(this.settings.uploadAction),\n                formData: this.settings.postParameters,\n                fileInput: this.$container.find(this.settings.fileInputSelector),\n                paramName: this.settings.uploadParamName\n            };\n\n            // If CSRF protection isn't enabled, these won't be defined.\n            if (typeof Craft.csrfTokenName !== 'undefined' && typeof Craft.csrfTokenValue !== 'undefined') {\n                // Add the CSRF token\n                options.formData[Craft.csrfTokenName] = Craft.csrfTokenValue;\n            }\n\n            options.events = {};\n            options.events.fileuploadstart = $.proxy(this, '_onUploadStart');\n            options.events.fileuploadprogressall = $.proxy(this, '_onUploadProgress');\n            options.events.fileuploaddone = $.proxy(this, '_onUploadComplete');\n            options.events.fileuploadfail = $.proxy(this, '_onUploadError');\n\n            this.uploader = new Craft.Uploader(this.$container, options);\n\n            this.initButtons();\n        },\n\n        initButtons: function() {\n            this.$container.find(this.settings.uploadButtonSelector).on('click', $.proxy(function(ev) {\n                this.$container.find(this.settings.fileInputSelector).trigger('click');\n            }, this));\n\n            this.$container.find(this.settings.deleteButtonSelector).on('click', $.proxy(function(ev) {\n                if (confirm(Craft.t('app', 'Are you sure you want to delete this image?'))) {\n                    $(ev.currentTarget).parent().append('<div class=\"blocking-modal\"></div>');\n                    Craft.postActionRequest(this.settings.deleteAction, this.settings.postParameters, $.proxy(function(response, textStatus) {\n                        if (textStatus === 'success') {\n                            this.refreshImage(response);\n                        }\n                    }, this));\n                }\n            }, this));\n\n        },\n\n        refreshImage: function(response) {\n            $(this.settings.containerSelector).replaceWith(response.html);\n            this.settings.onAfterRefreshImage(response);\n            this.initImageUpload();\n        },\n\n        /**\n         * On upload start.\n         */\n        _onUploadStart: function(event) {\n            this.progressBar.$progressBar.css({\n                top: Math.round(this.$container.outerHeight() / 2) - 6\n            });\n\n            this.$container.addClass('uploading');\n            this.progressBar.resetProgressBar();\n            this.progressBar.showProgressBar();\n        },\n\n        /**\n         * On upload progress.\n         */\n        _onUploadProgress: function(event, data) {\n            var progress = parseInt(data.loaded / data.total * 100, 10);\n            this.progressBar.setProgressPercentage(progress);\n        },\n\n        /**\n         * On a file being uploaded.\n         */\n        _onUploadComplete: function(event, data) {\n            if (data.result.error) {\n                alert(data.result.error);\n            } else {\n                var html = $(data.result.html);\n                this.refreshImage(data.result);\n            }\n\n            // Last file\n            if (this.uploader.isLastUpload()) {\n                this.progressBar.hideProgressBar();\n                this.$container.removeClass('uploading');\n            }\n        },\n\n        /**\n         * On a file being uploaded.\n         */\n        _onUploadError: function(event, data) {\n            if (data.jqXHR.responseJSON.error) {\n                alert(data.jqXHR.responseJSON.error);\n                this.$container.removeClass('uploading');\n                this.progressBar.hideProgressBar();\n                this.progressBar.resetProgressBar();\n            }\n        }\n    },\n    {\n        defaults: {\n            postParameters: {},\n            uploadAction: \"\",\n            deleteAction: \"\",\n            fileInputSelector: \"\",\n\n            onAfterRefreshImage: $.noop,\n            containerSelector: null,\n\n            uploadButtonSelector: null,\n            deleteButtonSelector: null,\n\n            uploadParamName: 'files'\n        }\n    }\n);\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Info icon class\n */\nCraft.InfoIcon = Garnish.Base.extend(\n    {\n        $icon: null,\n        hud: null,\n\n        init: function(icon) {\n            this.$icon = $(icon);\n\n            this.addListener(this.$icon, 'click', 'showHud');\n        },\n\n        showHud: function() {\n            if (!this.hud) {\n                this.hud = new Garnish.HUD(this.$icon, this.$icon.html(), {\n                    hudClass: 'hud info-hud',\n                    closeOtherHUDs: false\n                });\n            }\n            else {\n                this.hud.show();\n            }\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Light Switch\n */\nCraft.LightSwitch = Garnish.Base.extend(\n    {\n        settings: null,\n        $outerContainer: null,\n        $innerContainer: null,\n        $input: null,\n        small: false,\n        on: null,\n        dragger: null,\n\n        dragStartMargin: null,\n\n        init: function(outerContainer, settings) {\n            this.$outerContainer = $(outerContainer);\n\n            // Is this already a lightswitch?\n            if (this.$outerContainer.data('lightswitch')) {\n                Garnish.log('Double-instantiating a lightswitch on an element');\n                this.$outerContainer.data('lightswitch').destroy();\n            }\n\n            this.$outerContainer.data('lightswitch', this);\n\n            this.small = this.$outerContainer.hasClass('small');\n\n            this.setSettings(settings, Craft.LightSwitch.defaults);\n\n            this.$innerContainer = this.$outerContainer.find('.lightswitch-container:first');\n            this.$input = this.$outerContainer.find('input:first');\n\n            // If the input is disabled, go no further\n            if (this.$input.prop('disabled')) {\n                return;\n            }\n\n            this.on = this.$outerContainer.hasClass('on');\n\n            this.$outerContainer.attr({\n                'role': 'checkbox',\n                'aria-checked': (this.on ? 'true' : 'false')\n            });\n\n            this.addListener(this.$outerContainer, 'mousedown', '_onMouseDown');\n            this.addListener(this.$outerContainer, 'keydown', '_onKeyDown');\n\n            this.dragger = new Garnish.BaseDrag(this.$outerContainer, {\n                axis: Garnish.X_AXIS,\n                ignoreHandleSelector: null,\n                onDragStart: $.proxy(this, '_onDragStart'),\n                onDrag: $.proxy(this, '_onDrag'),\n                onDragStop: $.proxy(this, '_onDragStop')\n            });\n        },\n\n        turnOn: function() {\n            this.$outerContainer.addClass('dragging');\n\n            var animateCss = {};\n            animateCss['margin-' + Craft.left] = 0;\n            this.$innerContainer.velocity('stop').velocity(animateCss, Craft.LightSwitch.animationDuration, $.proxy(this, '_onSettle'));\n\n            this.$input.val(this.settings.value);\n            this.$outerContainer.addClass('on');\n            this.$outerContainer.attr('aria-checked', 'true');\n\n            if (this.on !== (this.on = true)) {\n                this.onChange();\n            }\n        },\n\n        turnOff: function() {\n            this.$outerContainer.addClass('dragging');\n\n            var animateCss = {};\n            animateCss['margin-' + Craft.left] = this._getOffMargin();\n            this.$innerContainer.velocity('stop').velocity(animateCss, Craft.LightSwitch.animationDuration, $.proxy(this, '_onSettle'));\n\n            this.$input.val('');\n            this.$outerContainer.removeClass('on');\n            this.$outerContainer.attr('aria-checked', 'false');\n\n            if (this.on !== (this.on = false)) {\n                this.onChange();\n            }\n        },\n\n        toggle: function(event) {\n            if (!this.on) {\n                this.turnOn();\n            }\n            else {\n                this.turnOff();\n            }\n        },\n\n        onChange: function() {\n            this.trigger('change');\n            this.settings.onChange();\n            this.$outerContainer.trigger('change');\n        },\n\n        _onMouseDown: function() {\n            this.addListener(Garnish.$doc, 'mouseup', '_onMouseUp');\n        },\n\n        _onMouseUp: function() {\n            this.removeListener(Garnish.$doc, 'mouseup');\n\n            // Was this a click?\n            if (!this.dragger.dragging) {\n                this.toggle();\n            }\n        },\n\n        _onKeyDown: function(event) {\n            switch (event.keyCode) {\n                case Garnish.SPACE_KEY: {\n                    this.toggle();\n                    event.preventDefault();\n                    break;\n                }\n                case Garnish.RIGHT_KEY: {\n                    if (Craft.orientation === 'ltr') {\n                        this.turnOn();\n                    }\n                    else {\n                        this.turnOff();\n                    }\n\n                    event.preventDefault();\n                    break;\n                }\n                case Garnish.LEFT_KEY: {\n                    if (Craft.orientation === 'ltr') {\n                        this.turnOff();\n                    }\n                    else {\n                        this.turnOn();\n                    }\n\n                    event.preventDefault();\n                    break;\n                }\n            }\n        },\n\n        _getMargin: function() {\n            return parseInt(this.$innerContainer.css('margin-' + Craft.left));\n        },\n\n        _onDragStart: function() {\n            this.$outerContainer.addClass('dragging');\n            this.dragStartMargin = this._getMargin();\n        },\n\n        _onDrag: function() {\n            var margin;\n\n            if (Craft.orientation === 'ltr') {\n                margin = this.dragStartMargin + this.dragger.mouseDistX;\n            }\n            else {\n                margin = this.dragStartMargin - this.dragger.mouseDistX;\n            }\n\n            if (margin < this._getOffMargin()) {\n                margin = this._getOffMargin();\n            }\n            else if (margin > 0) {\n                margin = 0;\n            }\n\n            this.$innerContainer.css('margin-' + Craft.left, margin);\n        },\n\n        _onDragStop: function() {\n            var margin = this._getMargin();\n\n            if (margin > (this._getOffMargin() / 2)) {\n                this.turnOn();\n            }\n            else {\n                this.turnOff();\n            }\n        },\n\n        _onSettle: function() {\n            this.$outerContainer.removeClass('dragging');\n        },\n\n        destroy: function() {\n            this.base();\n            this.dragger.destroy();\n        },\n\n        _getOffMargin: function() {\n            return (this.small ? -9 : -11);\n        }\n\n    }, {\n        animationDuration: 100,\n        defaults: {\n            value: '1',\n            onChange: $.noop\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Live Preview\n */\nCraft.LivePreview = Garnish.Base.extend(\n    {\n        $extraFields: null,\n        $trigger: null,\n        $shade: null,\n        $editorContainer: null,\n        $editor: null,\n        $dragHandle: null,\n        $iframeContainer: null,\n        $iframe: null,\n        $fieldPlaceholder: null,\n\n        previewUrl: null,\n        token: null,\n        basePostData: null,\n        inPreviewMode: false,\n        fields: null,\n        lastPostData: null,\n        updateIframeInterval: null,\n        loading: false,\n        checkAgain: false,\n\n        dragger: null,\n        dragStartEditorWidth: null,\n\n        _slideInOnIframeLoad: false,\n        _handleSuccessProxy: null,\n        _handleErrorProxy: null,\n        _forceUpdateIframeProxy: null,\n\n        _scrollX: null,\n        _scrollY: null,\n\n        _editorWidth: null,\n        _editorWidthInPx: null,\n\n        init: function(settings) {\n            this.setSettings(settings, Craft.LivePreview.defaults);\n\n            // Should preview requests use a specific URL?\n            // This won't affect how the request gets routed (the action param will override it),\n            // but it will allow the templates to change behavior based on the request URI.\n            if (this.settings.previewUrl) {\n                this.previewUrl = this.settings.previewUrl;\n            }\n            else {\n                this.previewUrl = Craft.baseSiteUrl.replace(/\\/+$/, '') + '/';\n            }\n\n            // Load the preview over SSL if the current request is\n            if (document.location.protocol === 'https:') {\n                this.previewUrl = this.previewUrl.replace(/^http:/, 'https:');\n            }\n\n            // Set the base post data\n            this.basePostData = $.extend({}, this.settings.previewParams);\n\n            this._handleSuccessProxy = $.proxy(this, 'handleSuccess');\n            this._handleErrorProxy = $.proxy(this, 'handleError');\n            this._forceUpdateIframeProxy = $.proxy(this, 'forceUpdateIframe');\n\n            // Find the DOM elements\n            this.$extraFields = $(this.settings.extraFields);\n            this.$trigger = $(this.settings.trigger);\n            this.$fieldPlaceholder = $('<div/>');\n\n            // Set the initial editor width\n            this.editorWidth = Craft.getLocalStorage('LivePreview.editorWidth', Craft.LivePreview.defaultEditorWidth);\n\n            // Event Listeners\n            this.addListener(this.$trigger, 'activate', 'toggle');\n\n            Craft.cp.on('beforeSaveShortcut', $.proxy(function() {\n                if (this.inPreviewMode) {\n                    this.moveFieldsBack();\n                }\n            }, this));\n        },\n\n        get editorWidth() {\n            return this._editorWidth;\n        },\n\n        get editorWidthInPx() {\n            return this._editorWidthInPx;\n        },\n\n        set editorWidth(width) {\n            var inPx;\n\n            // Is this getting set in pixels?\n            if (width >= 1) {\n                inPx = width;\n                width /= Garnish.$win.width();\n            }\n            else {\n                inPx = Math.round(width * Garnish.$win.width());\n            }\n\n            // Make sure it's no less than the minimum\n            if (inPx < Craft.LivePreview.minEditorWidthInPx) {\n                inPx = Craft.LivePreview.minEditorWidthInPx;\n                width = inPx / Garnish.$win.width();\n            }\n\n            this._editorWidth = width;\n            this._editorWidthInPx = inPx;\n        },\n\n        toggle: function() {\n            if (this.inPreviewMode) {\n                this.exit();\n            }\n            else {\n                this.enter();\n            }\n        },\n\n        enter: function() {\n            if (this.inPreviewMode) {\n                return;\n            }\n\n            if (!this.token) {\n                this.createToken();\n                return;\n            }\n\n            this.trigger('beforeEnter');\n\n            $(document.activeElement).trigger('blur');\n\n            if (!this.$editor) {\n                this.$shade = $('<div/>', {'class': 'modal-shade dark'}).appendTo(Garnish.$bod);\n                this.$editorContainer = $('<div/>', {'class': 'lp-editor-container'}).appendTo(Garnish.$bod);\n                this.$iframeContainer =$('<div/>', {'class': 'lp-preview-container'}).appendTo(Garnish.$bod);\n\n                var $editorHeader = $('<header/>', {'class': 'flex'}).appendTo(this.$editorContainer);\n                this.$editor = $('<form/>', {'class': 'lp-editor'}).appendTo(this.$editorContainer);\n                this.$dragHandle = $('<div/>', {'class': 'lp-draghandle'}).appendTo(this.$editorContainer);\n                var $closeBtn = $('<div/>', {'class': 'btn', text: Craft.t('app', 'Close Preview')}).appendTo($editorHeader);\n                $('<div/>', {'class': 'flex-grow'}).appendTo($editorHeader);\n                var $saveBtn = $('<div class=\"btn submit\">' + Craft.t('app', 'Save') + '</div>').appendTo($editorHeader);\n\n                this.dragger = new Garnish.BaseDrag(this.$dragHandle, {\n                    axis: Garnish.X_AXIS,\n                    onDragStart: $.proxy(this, '_onDragStart'),\n                    onDrag: $.proxy(this, '_onDrag'),\n                    onDragStop: $.proxy(this, '_onDragStop')\n                });\n\n                this.addListener($closeBtn, 'click', 'exit');\n                this.addListener($saveBtn, 'click', 'save');\n            }\n\n            // Set the sizes\n            this.handleWindowResize();\n            this.addListener(Garnish.$win, 'resize', 'handleWindowResize');\n\n            this.$editorContainer.css(Craft.left, -(this.editorWidthInPx + Craft.LivePreview.dragHandleWidth) + 'px');\n            this.$iframeContainer.css(Craft.right, -this.getIframeWidth());\n\n            // Move all the fields into the editor rather than copying them\n            // so any JS that's referencing the elements won't break.\n            this.fields = [];\n            var $fields = $(this.settings.fields);\n\n            for (var i = 0; i < $fields.length; i++) {\n                var $field = $($fields[i]),\n                    $clone = this._getClone($field);\n\n                // It's important that the actual field is added to the DOM *after* the clone,\n                // so any radio buttons in the field get deselected from the clone rather than the actual field.\n                this.$fieldPlaceholder.insertAfter($field);\n                $field.detach();\n                this.$fieldPlaceholder.replaceWith($clone);\n                $field.appendTo(this.$editor);\n\n                this.fields.push({\n                    $field: $field,\n                    $clone: $clone\n                });\n            }\n\n            if (this.updateIframe()) {\n                this._slideInOnIframeLoad = true;\n            } else {\n                this.slideIn();\n            }\n\n            Garnish.on(Craft.BaseElementEditor, 'saveElement', this._forceUpdateIframeProxy);\n            Garnish.on(Craft.AssetImageEditor, 'save', this._forceUpdateIframeProxy);\n\n            this.inPreviewMode = true;\n            this.trigger('enter');\n        },\n\n        createToken: function() {\n            Craft.postActionRequest('live-preview/create-token', {\n                previewAction: this.settings.previewAction\n            }, $.proxy(function(response, textStatus) {\n                if (textStatus === 'success') {\n                    this.token = response.token;\n                    this.enter();\n                }\n            }, this));\n        },\n\n        save: function() {\n            Craft.cp.submitPrimaryForm();\n        },\n\n        handleWindowResize: function() {\n            // Reset the width so the min width is enforced\n            this.editorWidth = this.editorWidth;\n\n            // Update the editor/iframe sizes\n            this.updateWidths();\n        },\n\n        slideIn: function() {\n            $('html').addClass('noscroll');\n            this.$shade.velocity('fadeIn');\n\n            this.$editorContainer.show().velocity('stop').animateLeft(0, 'slow', $.proxy(function() {\n                this.trigger('slideIn');\n                Garnish.$win.trigger('resize');\n            }, this));\n\n            this.$iframeContainer.show().velocity('stop').animateRight(0, 'slow', $.proxy(function() {\n                this.updateIframeInterval = setInterval($.proxy(this, 'updateIframe'), 1000);\n\n                this.addListener(Garnish.$bod, 'keyup', function(ev) {\n                    if (ev.keyCode === Garnish.ESC_KEY) {\n                        this.exit();\n                    }\n                });\n            }, this));\n        },\n\n        exit: function() {\n            if (!this.inPreviewMode) {\n                return;\n            }\n\n            this.trigger('beforeExit');\n\n            $('html').removeClass('noscroll');\n\n            this.removeListener(Garnish.$win, 'resize');\n            this.removeListener(Garnish.$bod, 'keyup');\n\n            if (this.updateIframeInterval) {\n                clearInterval(this.updateIframeInterval);\n            }\n\n            this.moveFieldsBack();\n\n            this.$shade.delay(200).velocity('fadeOut');\n\n            this.$editorContainer.velocity('stop').animateLeft(-(this.editorWidthInPx + Craft.LivePreview.dragHandleWidth), 'slow', $.proxy(function() {\n                for (var i = 0; i < this.fields.length; i++) {\n                    this.fields[i].$newClone.remove();\n                }\n                this.$editorContainer.hide();\n                this.trigger('slideOut');\n            }, this));\n\n            this.$iframeContainer.velocity('stop').animateRight(-this.getIframeWidth(), 'slow', $.proxy(function() {\n                this.$iframeContainer.hide();\n            }, this));\n\n            Garnish.off(Craft.BaseElementEditor, 'saveElement', this._forceUpdateIframeProxy);\n\n            this.inPreviewMode = false;\n            this.trigger('exit');\n        },\n\n        moveFieldsBack: function() {\n            for (var i = 0; i < this.fields.length; i++) {\n                var field = this.fields[i];\n                field.$newClone = this._getClone(field.$field);\n\n                // It's important that the actual field is added to the DOM *after* the clone,\n                // so any radio buttons in the field get deselected from the clone rather than the actual field.\n                this.$fieldPlaceholder.insertAfter(field.$field);\n                field.$field.detach();\n                this.$fieldPlaceholder.replaceWith(field.$newClone);\n                field.$clone.replaceWith(field.$field);\n            }\n\n            Garnish.$win.trigger('resize');\n        },\n\n        getIframeWidth: function() {\n            return Garnish.$win.width() - (this.editorWidthInPx + Craft.LivePreview.dragHandleWidth);\n        },\n\n        updateWidths: function() {\n            this.$editorContainer.css('width', this.editorWidthInPx + 'px');\n            this.$iframeContainer.width(this.getIframeWidth());\n        },\n\n        updateIframe: function(force) {\n            if (force) {\n                this.lastPostData = null;\n            }\n\n            if (!this.inPreviewMode) {\n                return false;\n            }\n\n            if (this.loading) {\n                this.checkAgain = true;\n                return false;\n            }\n\n            // Has the post data changed?\n            var postData = $.extend(Garnish.getPostData(this.$editor), Garnish.getPostData(this.$extraFields));\n\n            if (!this.lastPostData || !Craft.compare(postData, this.lastPostData, false)) {\n                this.lastPostData = postData;\n                this.loading = true;\n\n                var $doc = this.$iframe ? $(this.$iframe[0].contentWindow.document) : null;\n\n                this._scrollX = $doc ? $doc.scrollLeft() : 0;\n                this._scrollY = $doc ? $doc.scrollTop() : 0;\n\n                $.ajax({\n                    url: this.previewUrl + (this.previewUrl.indexOf('?') !== -1 ? '&' : '?') + Craft.tokenParam + '=' + this.token,\n                    method: 'POST',\n                    data: $.extend({}, postData, this.basePostData),\n                    headers: {\n                        'X-Craft-Token': this.token\n                    },\n                    xhrFields: {\n                        withCredentials: true\n                    },\n                    crossDomain: true,\n                    success: this._handleSuccessProxy,\n                    error: this._handleErrorProxy\n                });\n\n                return true;\n            }\n            else {\n                return false;\n            }\n        },\n\n        forceUpdateIframe: function() {\n            return this.updateIframe(true);\n        },\n\n        handleSuccess: function(data) {\n            var html = data +\n                '<script type=\"text/javascript\">window.scrollTo(' + this._scrollX + ', ' + this._scrollY + ');</script>';\n\n            // Create a new iframe\n            var $iframe = $('<iframe class=\"lp-preview\" frameborder=\"0\"/>');\n            if (this.$iframe) {\n                $iframe.insertBefore(this.$iframe);\n            } else {\n                $iframe.appendTo(this.$iframeContainer);\n            }\n\n            this.addListener($iframe, 'load', function() {\n                if (this.$iframe) {\n                    this.$iframe.remove();\n                }\n                this.$iframe = $iframe;\n\n                if (this._slideInOnIframeLoad) {\n                    this.slideIn();\n                    this._slideInOnIframeLoad = false;\n                }\n\n                this.removeListener($iframe, 'load');\n            });\n\n            Garnish.requestAnimationFrame($.proxy(function() {\n                $iframe[0].contentWindow.document.open();\n                $iframe[0].contentWindow.document.write(html);\n                $iframe[0].contentWindow.document.close();\n                this.onResponse();\n            }, this));\n        },\n\n        handleError: function() {\n            this.onResponse();\n        },\n\n        onResponse: function() {\n            this.loading = false;\n\n            if (this.checkAgain) {\n                this.checkAgain = false;\n                this.updateIframe();\n            }\n        },\n\n        _getClone: function($field) {\n            var $clone = $field.clone();\n\n            // clone() won't account for input values that have changed since the original HTML set them\n            Garnish.copyInputValues($field, $clone);\n\n            // Remove any id= attributes\n            $clone.attr('id', '');\n            $clone.find('[id]').attr('id', '');\n\n            return $clone;\n        },\n\n        _onDragStart: function() {\n            this.dragStartEditorWidth = this.editorWidthInPx;\n            this.$iframeContainer.addClass('dragging');\n        },\n\n        _onDrag: function() {\n            if (Craft.orientation === 'ltr') {\n                this.editorWidth = this.dragStartEditorWidth + this.dragger.mouseDistX;\n            }\n            else {\n                this.editorWidth = this.dragStartEditorWidth - this.dragger.mouseDistX;\n            }\n\n            this.updateWidths();\n        },\n\n        _onDragStop: function() {\n            this.$iframeContainer.removeClass('dragging');\n            Craft.setLocalStorage('LivePreview.editorWidth', this.editorWidth);\n        }\n    },\n    {\n        defaultEditorWidth: 0.33,\n        minEditorWidthInPx: 320,\n        dragHandleWidth: 4,\n\n        defaults: {\n            trigger: '.livepreviewbtn',\n            fields: null,\n            extraFields: null,\n            previewUrl: null,\n            previewAction: null,\n            previewParams: {}\n        }\n    });\n\nCraft.LivePreview.init = function(settings) {\n    Craft.livePreview = new Craft.LivePreview(settings);\n};\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Password Input\n */\nCraft.PasswordInput = Garnish.Base.extend(\n    {\n        $passwordInput: null,\n        $textInput: null,\n        $currentInput: null,\n\n        $showPasswordToggle: null,\n        showingPassword: null,\n\n        init: function(passwordInput, settings) {\n            this.$passwordInput = $(passwordInput);\n            this.settings = $.extend({}, Craft.PasswordInput.defaults, settings);\n\n            // Is this already a password input?\n            if (this.$passwordInput.data('passwordInput')) {\n                Garnish.log('Double-instantiating a password input on an element');\n                this.$passwordInput.data('passwordInput').destroy();\n            }\n\n            this.$passwordInput.data('passwordInput', this);\n\n            this.$showPasswordToggle = $('<a/>').hide();\n            this.$showPasswordToggle.addClass('password-toggle');\n            this.$showPasswordToggle.insertAfter(this.$passwordInput);\n            this.addListener(this.$showPasswordToggle, 'mousedown', 'onToggleMouseDown');\n            this.hidePassword();\n        },\n\n        setCurrentInput: function($input) {\n            if (this.$currentInput) {\n                // Swap the inputs, while preventing the focus animation\n                $input.addClass('focus');\n                $input.insertAfter(this.$currentInput);\n                this.$currentInput.detach();\n                $input.trigger('focus');\n                $input.removeClass('focus');\n\n                // Restore the input value\n                $input.val(this.$currentInput.val());\n            }\n\n            this.$currentInput = $input;\n\n            this.addListener(this.$currentInput, 'keypress,keyup,change,blur', 'onInputChange');\n        },\n\n        updateToggleLabel: function(label) {\n            this.$showPasswordToggle.text(label);\n        },\n\n        showPassword: function() {\n            if (this.showingPassword) {\n                return;\n            }\n\n            if (!this.$textInput) {\n                this.$textInput = this.$passwordInput.clone(true);\n                this.$textInput.attr('type', 'text');\n            }\n\n            this.setCurrentInput(this.$textInput);\n            this.updateToggleLabel(Craft.t('app', 'Hide'));\n            this.showingPassword = true;\n        },\n\n        hidePassword: function() {\n            // showingPassword could be null, which is acceptable\n            if (this.showingPassword === false) {\n                return;\n            }\n\n            this.setCurrentInput(this.$passwordInput);\n            this.updateToggleLabel(Craft.t('app', 'Show'));\n            this.showingPassword = false;\n\n            // Alt key temporarily shows the password\n            this.addListener(this.$passwordInput, 'keydown', 'onKeyDown');\n        },\n\n        togglePassword: function() {\n            if (this.showingPassword) {\n                this.hidePassword();\n            }\n            else {\n                this.showPassword();\n            }\n\n            this.settings.onToggleInput(this.$currentInput);\n        },\n\n        onKeyDown: function(ev) {\n            if (ev.keyCode === Garnish.ALT_KEY && this.$currentInput.val()) {\n                this.showPassword();\n                this.$showPasswordToggle.hide();\n                this.addListener(this.$textInput, 'keyup', 'onKeyUp');\n            }\n        },\n\n        onKeyUp: function(ev) {\n            ev.preventDefault();\n\n            if (ev.keyCode === Garnish.ALT_KEY) {\n                this.hidePassword();\n                this.$showPasswordToggle.show();\n            }\n        },\n\n        onInputChange: function() {\n            if (this.$currentInput.val()) {\n                this.$showPasswordToggle.show();\n            }\n            else {\n                this.$showPasswordToggle.hide();\n            }\n        },\n\n        onToggleMouseDown: function(ev) {\n            // Prevent focus change\n            ev.preventDefault();\n\n            if (this.$currentInput[0].setSelectionRange) {\n                var selectionStart = this.$currentInput[0].selectionStart,\n                    selectionEnd = this.$currentInput[0].selectionEnd;\n\n                this.togglePassword();\n                this.$currentInput[0].setSelectionRange(selectionStart, selectionEnd);\n            }\n            else {\n                this.togglePassword();\n            }\n        }\n    },\n    {\n        defaults: {\n            onToggleInput: $.noop\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Preview\n */\nCraft.Preview = Garnish.Base.extend(\n    {\n        draftEditor: null,\n\n        $shade: null,\n        $editorContainer: null,\n        $editor: null,\n        $spinner: null,\n        $statusIcon: null,\n        $dragHandle: null,\n        $previewContainer: null,\n        $targetBtn: null,\n        $targetMenu: null,\n        $iframe: null,\n        $tempInput: null,\n        $fieldPlaceholder: null,\n\n        isActive: false,\n        activeTarget: 0,\n        url: null,\n        fields: null,\n\n        scrollLeft: 0,\n        scrollTop: 0,\n\n        dragger: null,\n        dragStartEditorWidth: null,\n\n        _slideInOnIframeLoad: false,\n        _updateIframeProxy: null,\n\n        _editorWidth: null,\n        _editorWidthInPx: null,\n\n        init: function(draftEditor) {\n            this.draftEditor = draftEditor;\n\n            this._updateIframeProxy = $.proxy(this,'updateIframe');\n\n            this.$tempInput = $('<input/>', {type: 'hidden', name: '__PREVIEW_FIELDS__', value: '1'});\n            this.$fieldPlaceholder = $('<div/>');\n\n            // Set the initial editor width\n            this.editorWidth = Craft.getLocalStorage('LivePreview.editorWidth', Craft.Preview.defaultEditorWidth);\n        },\n\n        get editorWidth() {\n            return this._editorWidth;\n        },\n\n        get editorWidthInPx() {\n            return this._editorWidthInPx;\n        },\n\n        set editorWidth(width) {\n            var inPx;\n\n            // Is this getting set in pixels?\n            if (width >= 1) {\n                inPx = width;\n                width /= Garnish.$win.width();\n            } else {\n                inPx = Math.round(width * Garnish.$win.width());\n            }\n\n            // Make sure it's no less than the minimum\n            if (inPx < Craft.Preview.minEditorWidthInPx) {\n                inPx = Craft.Preview.minEditorWidthInPx;\n                width = inPx / Garnish.$win.width();\n            }\n\n            this._editorWidth = width;\n            this._editorWidthInPx = inPx;\n        },\n\n        open: function() {\n            if (this.isActive) {\n                return;\n            }\n\n            this.isActive = true;\n            this.trigger('beforeOpen');\n\n            $(document.activeElement).trigger('blur');\n\n            if (!this.$editor) {\n                this.$shade = $('<div/>', {'class': 'modal-shade dark'}).appendTo(Garnish.$bod);\n                this.$editorContainer = $('<div/>', {'class': 'lp-editor-container'}).appendTo(Garnish.$bod);\n                this.$previewContainer = $('<div/>', {'class': 'lp-preview-container'}).appendTo(Garnish.$bod);\n\n                var $editorHeader = $('<header/>', {'class': 'flex'}).appendTo(this.$editorContainer);\n                this.$editor = $('<form/>', {'class': 'lp-editor'}).appendTo(this.$editorContainer);\n                this.$dragHandle = $('<div/>', {'class': 'lp-draghandle'}).appendTo(this.$editorContainer);\n                var $closeBtn = $('<div/>', {'class': 'btn', text: Craft.t('app', 'Close Preview')}).appendTo($editorHeader);\n                $('<div/>', {'class': 'flex-grow'}).appendTo($editorHeader);\n                this.$spinner = $('<div/>', {'class': 'spinner hidden', title: Craft.t('app', 'Saving')}).appendTo($editorHeader);\n                this.$statusIcon = $('<div/>', {'class': 'invisible'}).appendTo($editorHeader);\n\n                if (this.draftEditor.settings.previewTargets.length > 1) {\n                    var $previewHeader = $('<header/>', {'class': 'flex'}).appendTo(this.$previewContainer);\n                    this.$targetBtn = $('<div/>', {\n                        'class': 'btn menubtn',\n                        text: this.draftEditor.settings.previewTargets[0].label,\n                        role: 'btn',\n                    }).appendTo($previewHeader);\n                    this.$targetMenu = $('<div/>', {'class': 'menu lp-target-menu'}).insertAfter(this.$targetBtn);\n                    var $ul = $('<ul/>', {'class': 'padded'}).appendTo(this.$targetMenu);\n                    var $li, $a;\n                    for (var i = 0; i < this.draftEditor.settings.previewTargets.length; i++) {\n                        $li = $('<li/>').appendTo($ul)\n                        $a = $('<a/>', {\n                            data: {target: i},\n                            text: this.draftEditor.settings.previewTargets[i].label,\n                            'class': i === 0 ? 'sel' : null,\n                        }).appendTo($li);\n                    }\n                    new Garnish.MenuBtn(this.$targetBtn, {\n                        onOptionSelect: $.proxy(function(option) {\n                            this.switchTarget($(option).data('target'));\n                        }, this)\n                    });\n                }\n\n                this.dragger = new Garnish.BaseDrag(this.$dragHandle, {\n                    axis: Garnish.X_AXIS,\n                    onDragStart: $.proxy(this, '_onDragStart'),\n                    onDrag: $.proxy(this, '_onDrag'),\n                    onDragStop: $.proxy(this, '_onDragStop')\n                });\n\n                this.addListener($closeBtn, 'click', 'close');\n                this.addListener(this.$statusIcon, 'click', function() {\n                    this.draftEditor.showStatusHud(this.$statusIcon);\n                }.bind(this));\n            }\n\n            // Set the sizes\n            this.handleWindowResize();\n            this.addListener(Garnish.$win, 'resize', 'handleWindowResize');\n\n            this.$editorContainer.css(Craft.left, -(this.editorWidthInPx + Craft.Preview.dragHandleWidth) + 'px');\n            this.$previewContainer.css(Craft.right, -this.getIframeWidth());\n\n            // Find the fields, excluding nested fields\n            this.fields = [];\n            var $fields = $('#content .field').not($('#content .field .field'));\n\n            if ($fields.length) {\n                // Insert our temporary input before the first field so we know where to swap in the serialized form values\n                this.$tempInput.insertBefore($fields.get(0));\n\n                // Move all the fields into the editor rather than copying them\n                // so any JS that's referencing the elements won't break.\n                for (var i = 0; i < $fields.length; i++) {\n                    var $field = $($fields[i]),\n                        $clone = this._getClone($field);\n\n                    // It's important that the actual field is added to the DOM *after* the clone,\n                    // so any radio buttons in the field get deselected from the clone rather than the actual field.\n                    this.$fieldPlaceholder.insertAfter($field);\n                    $field.detach();\n                    this.$fieldPlaceholder.replaceWith($clone);\n                    $field.appendTo(this.$editor);\n\n                    this.fields.push({\n                        $field: $field,\n                        $clone: $clone\n                    });\n                }\n\n            }\n\n            this._slideInOnIframeLoad = true;\n            this.updateIframe();\n\n            this.draftEditor.on('update', this._updateIframeProxy);\n            Garnish.on(Craft.BaseElementEditor, 'saveElement', this._updateIframeProxy);\n            Garnish.on(Craft.AssetImageEditor, 'save', this._updateIframeProxy);\n\n            this.trigger('open');\n        },\n\n        switchTarget: function(i) {\n            this.activeTarget = i;\n            this.$targetBtn.text(this.draftEditor.settings.previewTargets[i].label);\n            this.$targetMenu.find('a.sel').removeClass('sel');\n            this.$targetMenu.find('a').eq(i).addClass('sel');\n            this.updateIframe(true);\n        },\n\n        handleWindowResize: function() {\n            // Reset the width so the min width is enforced\n            this.editorWidth = this.editorWidth;\n\n            // Update the editor/iframe sizes\n            this.updateWidths();\n        },\n\n        slideIn: function() {\n            $('html').addClass('noscroll');\n            this.$shade.velocity('fadeIn');\n\n            this.$editorContainer.show().velocity('stop').animateLeft(0, 'slow', $.proxy(function() {\n                this.trigger('slideIn');\n                Garnish.$win.trigger('resize');\n            }, this));\n\n            this.$previewContainer.show().velocity('stop').animateRight(0, 'slow', $.proxy(function() {\n                this.addListener(Garnish.$bod, 'keyup', function(ev) {\n                    if (ev.keyCode === Garnish.ESC_KEY) {\n                        this.close();\n                    }\n                });\n            }, this));\n        },\n\n        close: function() {\n            if (!this.isActive) {\n                return;\n            }\n\n            this.trigger('beforeClose');\n\n            $('html').removeClass('noscroll');\n\n            this.removeListener(Garnish.$win, 'resize');\n            this.removeListener(Garnish.$bod, 'keyup');\n\n            // Remove our temporary input and move the preview fields back into place\n            this.$tempInput.detach();\n            this.moveFieldsBack();\n\n            this.$shade.delay(200).velocity('fadeOut');\n\n            this.$editorContainer.velocity('stop').animateLeft(-(this.editorWidthInPx + Craft.Preview.dragHandleWidth), 'slow', $.proxy(function() {\n                for (var i = 0; i < this.fields.length; i++) {\n                    this.fields[i].$newClone.remove();\n                }\n                this.$editorContainer.hide();\n                this.trigger('slideOut');\n            }, this));\n\n            this.$previewContainer.velocity('stop').animateRight(-this.getIframeWidth(), 'slow', $.proxy(function() {\n                this.$previewContainer.hide();\n            }, this));\n\n            this.draftEditor.off('update', this._updateIframeProxy);\n            Garnish.off(Craft.BaseElementEditor, 'saveElement', this._updateIframeProxy);\n            Garnish.off(Craft.AssetImageEditor, 'save', this._updateIframeProxy);\n\n            this.isActive = false;\n            this.trigger('close');\n        },\n\n        moveFieldsBack: function() {\n            for (var i = 0; i < this.fields.length; i++) {\n                var field = this.fields[i];\n                field.$newClone = this._getClone(field.$field);\n\n                // It's important that the actual field is added to the DOM *after* the clone,\n                // so any radio buttons in the field get deselected from the clone rather than the actual field.\n                this.$fieldPlaceholder.insertAfter(field.$field);\n                field.$field.detach();\n                this.$fieldPlaceholder.replaceWith(field.$newClone);\n                field.$clone.replaceWith(field.$field);\n            }\n\n            Garnish.$win.trigger('resize');\n        },\n\n        getIframeWidth: function() {\n            return Garnish.$win.width() - (this.editorWidthInPx + Craft.Preview.dragHandleWidth);\n        },\n\n        updateWidths: function() {\n            this.$editorContainer.css('width', this.editorWidthInPx + 'px');\n            this.$previewContainer.width(this.getIframeWidth());\n        },\n\n        updateIframe: function(resetScroll) {\n            if (!this.isActive) {\n                return false;\n            }\n\n            // Ignore non-boolean resetScroll values\n            resetScroll = resetScroll === true;\n\n            var url = this.draftEditor.settings.previewTargets[this.activeTarget].url;\n\n            this.draftEditor.getTokenizedPreviewUrl(url, 'x-craft-live-preview').then(function(url) {\n                // Capture the current scroll position?\n                var sameHost;\n                if (resetScroll) {\n                    this.scrollLeft = 0;\n                    this.scrolllTop = 0;\n                } else {\n                    sameHost = Craft.isSameHost(url);\n                    if (sameHost && this.$iframe && this.$iframe[0].contentWindow) {\n                        var $doc = $(this.$iframe[0].contentWindow.document);\n                        this.scrollLeft = $doc.scrollLeft();\n                        this.scrollTop = $doc.scrollTop();\n                    }\n                }\n\n                var $iframe = $('<iframe/>', {\n                    'class': 'lp-preview',\n                    frameborder: 0,\n                    src: url,\n                });\n\n                if (!resetScroll && sameHost) {\n                    $iframe.on('load', function() {\n                        var $doc = $($iframe[0].contentWindow.document);\n                        $doc.scrollLeft(this.scrollLeft);\n                        $doc.scrollTop(this.scrollTop);\n                    }.bind(this));\n                }\n\n                if (this.$iframe) {\n                    this.$iframe.replaceWith($iframe);\n                } else {\n                    $iframe.appendTo(this.$previewContainer);\n                }\n\n                this.url = url;\n                this.$iframe = $iframe;\n                this.afterUpdateIframe();\n            }.bind(this));\n        },\n\n        afterUpdateIframe: function() {\n            this.trigger('afterUpdateIframe');\n\n            if (this._slideInOnIframeLoad) {\n                this.slideIn();\n                this._slideInOnIframeLoad = false;\n            }\n        },\n\n        _getClone: function($field) {\n            var $clone = $field.clone();\n\n            // clone() won't account for input values that have changed since the original HTML set them\n            Garnish.copyInputValues($field, $clone);\n\n            // Remove any id= attributes\n            $clone.attr('id', '');\n            $clone.find('[id]').attr('id', '');\n\n            // Disable anything with a name attribute\n            $clone.find('[name]').prop('disabled', true);\n\n            return $clone;\n        },\n\n        _onDragStart: function() {\n            this.dragStartEditorWidth = this.editorWidthInPx;\n            this.$previewContainer.addClass('dragging');\n        },\n\n        _onDrag: function() {\n            if (Craft.orientation === 'ltr') {\n                this.editorWidth = this.dragStartEditorWidth + this.dragger.mouseDistX;\n            } else {\n                this.editorWidth = this.dragStartEditorWidth - this.dragger.mouseDistX;\n            }\n\n            this.updateWidths();\n        },\n\n        _onDragStop: function() {\n            this.$previewContainer.removeClass('dragging');\n            Craft.setLocalStorage('LivePreview.editorWidth', this.editorWidth);\n        }\n    },\n    {\n        defaultEditorWidth: 0.33,\n        minEditorWidthInPx: 320,\n        dragHandleWidth: 2,\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Preview File Modal\n */\nCraft.PreviewFileModal = Garnish.Modal.extend(\n    {\n        assetId: null,\n        $spinner: null,\n        elementSelect: null,\n        type: null,\n        loaded: null,\n        requestId: 0,\n\n        /**\n         * Initialize the preview file modal.\n         * @returns {*|void}\n         */\n        init: function(assetId, elementSelect, settings) {\n            settings = $.extend(this.defaultSettings, settings);\n\n            settings.onHide = this._onHide.bind(this);\n\n            if (Craft.PreviewFileModal.openInstance) {\n                var instance = Craft.PreviewFileModal.openInstance;\n\n                if (instance.assetId !== assetId) {\n                    instance.loadAsset(assetId, settings.startingWidth, settings.startingHeight);\n                    instance.elementSelect = elementSelect;\n                }\n\n                return this.destroy();\n            }\n\n            Craft.PreviewFileModal.openInstance = this;\n            this.elementSelect = elementSelect;\n\n            this.$container = $('<div id=\"previewmodal\" class=\"modal loading\"/>').appendTo(Garnish.$bod);\n\n            this.base(this.$container, $.extend({\n                resizable: true\n            }, settings));\n\n            // Cut the flicker, just show the nice person the preview.\n            if (this.$container) {\n                this.$container.velocity('stop');\n                this.$container.show().css('opacity', 1);\n\n                this.$shade.velocity('stop');\n                this.$shade.show().css('opacity', 1);\n            }\n\n            this.loadAsset(assetId, settings.startingWidth, settings.startingHeight);\n        },\n\n        /**\n         * When hiding, remove all traces and focus last focused element.\n         * @private\n         */\n        _onHide: function () {\n            Craft.PreviewFileModal.openInstance = null;\n            this.elementSelect.focusItem(this.elementSelect.$focusedItem);\n\n            this.$shade.remove();\n\n            return this.destroy();\n        },\n\n        /**\n         * Disappear immediately forever.\n         * @returns {boolean}\n         */\n        selfDestruct: function () {\n            var instance = Craft.PreviewFileModal.openInstance;\n\n            instance.hide();\n            instance.$shade.remove();\n            instance.destroy();\n\n            Craft.PreviewFileModal.openInstance = null;\n\n            return true;\n        },\n\n        /**\n         * Load an asset, using starting width and height, if applicable\n         * @param assetId\n         * @param startingWidth\n         * @param startingHeight\n         */\n        loadAsset: function (assetId, startingWidth, startingHeight) {\n            this.assetId = assetId;\n\n            this.$container.empty();\n            this.loaded = false;\n\n            this.desiredHeight = null;\n            this.desiredWidth = null;\n\n            var containerHeight = Garnish.$win.height() * 0.66;\n            var containerWidth = Math.min(containerHeight / 3 * 4, Garnish.$win.width() - this.settings.minGutter * 2);\n            containerHeight = containerWidth / 4 * 3;\n\n            if (startingWidth && startingHeight) {\n                var ratio = startingWidth / startingHeight;\n                containerWidth =  Math.min(startingWidth, Garnish.$win.width() - this.settings.minGutter * 2);\n                containerHeight = Math.min(containerWidth / ratio, Garnish.$win.height() - this.settings.minGutter * 2);\n                containerWidth = containerHeight * ratio;\n\n                // This might actually have put width over the viewport limits, so doublecheck\n                if (containerWidth > Math.min(startingWidth, Garnish.$win.width() - this.settings.minGutter * 2)) {\n                    containerWidth =  Math.min(startingWidth, Garnish.$win.width() - this.settings.minGutter * 2);\n                    containerHeight = containerWidth / ratio;\n                }\n            }\n\n            this._resizeContainer(containerWidth, containerHeight);\n\n            this.$spinner = $('<div class=\"spinner centeralign\"></div>').appendTo(this.$container);\n            var top = (this.$container.height() / 2 - this.$spinner.height() / 2) + 'px',\n                left = (this.$container.width() / 2 - this.$spinner.width() / 2) + 'px';\n\n            this.$spinner.css({left: left, top: top, position: 'absolute'});\n            this.requestId++;\n\n            Craft.postActionRequest('assets/preview-file', {assetId: assetId, requestId: this.requestId}, function(response, textStatus) {\n                if (textStatus === 'success') {\n                    if (response.success) {\n                        if (response.requestId != this.requestId) {\n                            return;\n                        }\n\n                        this.$container.removeClass('loading');\n                        this.$spinner.remove();\n\n                        this.loaded = true;\n                        this.$container.append(response.modalHtml);\n\n                        var $highlight = this.$container.find('.highlight');\n\n                        if ($highlight.length && $highlight.hasClass('json')) {\n                            var $target = $highlight.find('code');\n                            $target.html(JSON.stringify(JSON.parse($target.html()), undefined, 4));\n                        }\n\n                        if ($highlight.length) {\n                            Prism.highlightElement($highlight.find('code').get(0));\n                        } else {\n                            this.$container.find('img').css({\n                                width: containerWidth,\n                                height: containerHeight\n                            });\n                        }\n\n                        this.updateSizeAndPosition();\n                    } else {\n                        alert(response.error);\n\n                        this.hide();\n                    }\n                }\n            }.bind(this));\n        },\n\n        /**\n         * Override default logic with some extra shenanigans\n         */\n        updateSizeAndPosition: function() {\n            if (!this.loaded) {\n                return;\n            }\n\n            var $img = this.$container.find('img');\n\n            if (this.loaded && $img.length) {\n                // Make sure we maintain the ratio\n\n                var maxWidth = $img.data('maxwidth'),\n                    maxHeight = $img.data('maxheight'),\n                    imageRatio = maxWidth / maxHeight,\n                    desiredWidth = this.desiredWidth ? this.desiredWidth : this.$container.width(),\n                    desiredHeight = this.desiredHeight ? this.desiredHeight : this.$container.height(),\n                    width = Math.min(desiredWidth, maxWidth),\n                    height = Math.round(Math.min(maxHeight, width / imageRatio));\n\n                width = Math.round(height * imageRatio);\n\n                $img.css({'width': width, 'height': height});\n                this._resizeContainer(width, height);\n\n                this.desiredWidth = width;\n                this.desiredHeight = height;\n\n            }\n\n            this.base();\n\n            if (this.loaded && $img.length) {\n                // Correct anomalities\n                var containerWidth = Math.round(Math.min(Math.max($img.height() * imageRatio), Garnish.$win.width() - (this.settings.minGutter * 2))),\n                    containerHeight = Math.round(Math.min(Math.max(containerWidth / imageRatio), Garnish.$win.height() - (this.settings.minGutter * 2)));\n                    containerWidth = Math.round(containerHeight * imageRatio);\n\n                // This might actually have put width over the viewport limits, so doublecheck that\n                if (containerWidth > Math.min(containerWidth, Garnish.$win.width() - this.settings.minGutter * 2)) {\n                    containerWidth =  Math.min(containerWidth, Garnish.$win.width() - this.settings.minGutter * 2);\n                    containerHeight = containerWidth / imageRatio;\n                }\n\n                this._resizeContainer(containerWidth, containerHeight);\n\n                $img.css({'width': containerWidth, 'height': containerHeight});\n            } else if (this.loaded) {\n                this.$container.find('.highlight')\n                    .height(this.$container.height())\n                    .width(this.$container.width())\n                    .css({'overflow': 'auto'});\n            }\n        },\n\n        /**\n         * Resize the container to specified dimensions\n         * @param containerWidth\n         * @param containerHeight\n         * @private\n         */\n        _resizeContainer: function (containerWidth, containerHeight) {\n            this.$container.css({\n                'width': containerWidth,\n                'min-width': containerWidth,\n                'max-width': containerWidth,\n                'height': containerHeight,\n                'min-height': containerHeight,\n                'max-height': containerHeight,\n                'top': (Garnish.$win.height() - containerHeight) / 2,\n                'left': (Garnish.$win.width() - containerWidth) / 2\n            });\n        }\n    },\n    {\n        defaultSettings: {\n            startingWidth: null,\n            startingHeight: null\n        }\n    }\n);\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * File Manager.\n */\nCraft.ProgressBar = Garnish.Base.extend(\n    {\n        $progressBar: null,\n        $innerProgressBar: null,\n        $progressBarStatus: null,\n\n        _itemCount: 0,\n        _processedItemCount: 0,\n        _displaySteps: false,\n\n        init: function($element, displaySteps) {\n            if (displaySteps) {\n                this._displaySteps = true;\n            }\n\n            this.$progressBar = $('<div class=\"progressbar pending hidden\"/>').appendTo($element);\n            this.$innerProgressBar = $('<div class=\"progressbar-inner\"/>').appendTo(this.$progressBar);\n            this.$progressBarStatus = $('<div class=\"progressbar-status hidden\" />').insertAfter(this.$progressBar);\n\n            this.resetProgressBar();\n        },\n\n        /**\n         * Reset the progress bar\n         */\n        resetProgressBar: function() {\n            // Since setting the progress percentage implies that there is progress to be shown\n            // It removes the pending class - we must add it back.\n            this.setProgressPercentage(100);\n            this.$progressBar.addClass('pending');\n\n            // Reset all the counters\n            this.setItemCount(1);\n            this.setProcessedItemCount(0);\n            this.$progressBarStatus.html('');\n\n            if (this._displaySteps) {\n                this.$progressBar.addClass('has-status');\n            }\n        },\n\n        /**\n         * Fade to invisible, hide it using a class and reset opacity to visible\n         */\n        hideProgressBar: function() {\n            this.$progressBar.fadeTo('fast', 0.01, $.proxy(function() {\n                this.$progressBar.addClass('hidden').fadeTo(1, 1, $.noop);\n            }, this));\n        },\n\n        showProgressBar: function() {\n            this.$progressBar.removeClass('hidden');\n            this.$progressBarStatus.removeClass('hidden');\n        },\n\n        setItemCount: function(count) {\n            this._itemCount = count;\n        },\n\n        incrementItemCount: function(count) {\n            this._itemCount += count;\n        },\n\n        setProcessedItemCount: function(count) {\n            this._processedItemCount = count;\n        },\n\n        incrementProcessedItemCount: function(count) {\n            this._processedItemCount += count;\n        },\n\n        updateProgressBar: function() {\n            // Only fools would allow accidental division by zero.\n            this._itemCount = Math.max(this._itemCount, 1);\n\n            var width = Math.min(100, Math.round(100 * this._processedItemCount / this._itemCount));\n\n            this.setProgressPercentage(width);\n\n            if (this._displaySteps) {\n                this.$progressBarStatus.html(this._processedItemCount + ' / ' + this._itemCount);\n            }\n        },\n\n        setProgressPercentage: function(percentage, animate) {\n            if (percentage === 0) {\n                this.$progressBar.addClass('pending');\n            }\n            else {\n                this.$progressBar.removeClass('pending');\n\n                if (animate) {\n                    this.$innerProgressBar.velocity('stop').velocity({width: percentage + '%'}, 'fast');\n                }\n                else {\n                    this.$innerProgressBar.velocity('stop').width(percentage + '%');\n                }\n            }\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * File Manager.\n */\nCraft.PromptHandler = Garnish.Base.extend({\n\n    modal: null,\n    $modalContainerDiv: null,\n    $prompt: null,\n    $promptApplyToRemainingContainer: null,\n    $promptApplyToRemainingCheckbox: null,\n    $promptApplyToRemainingLabel: null,\n    $pomptChoices: null,\n\n\n    _prompts: [],\n    _promptBatchCallback: $.noop,\n    _promptBatchReturnData: [],\n    _promptBatchNum: 0,\n\n    resetPrompts: function() {\n        this._prompts = [];\n        this._promptBatchCallback = $.noop;\n        this._promptBatchReturnData = [];\n        this._promptBatchNum = 0;\n    },\n\n    addPrompt: function(prompt) {\n        this._prompts.push(prompt);\n    },\n\n    getPromptCount: function() {\n        return this._prompts.length;\n    },\n\n    showBatchPrompts: function(callback) {\n        this._promptBatchCallback = callback;\n        this._promptBatchReturnData = [];\n        this._promptBatchNum = 0;\n\n        this._showNextPromptInBatch();\n    },\n\n    _showNextPromptInBatch: function() {\n        var prompt = this._prompts[this._promptBatchNum].prompt,\n            remainingInBatch = this._prompts.length - (this._promptBatchNum + 1);\n\n        this._showPrompt(prompt.message, prompt.choices, $.proxy(this, '_handleBatchPromptSelection'), remainingInBatch);\n    },\n\n    /**\n     * Handles a prompt choice selection.\n     *\n     * @param choice\n     * @param applyToRemaining\n     * @private\n     */\n    _handleBatchPromptSelection: function(choice, applyToRemaining) {\n        var prompt = this._prompts[this._promptBatchNum],\n            remainingInBatch = this._prompts.length - (this._promptBatchNum + 1);\n\n        // Record this choice\n        var choiceData = $.extend(prompt, {choice: choice});\n        this._promptBatchReturnData.push(choiceData);\n\n        // Are there any remaining items in the batch?\n        if (remainingInBatch) {\n            // Get ready to deal with the next prompt\n            this._promptBatchNum++;\n\n            // Apply the same choice to the remaining items?\n            if (applyToRemaining) {\n                this._handleBatchPromptSelection(choice, true);\n            }\n            else {\n                // Show the next prompt\n                this._showNextPromptInBatch();\n            }\n        }\n        else {\n            // All done! Call the callback\n            if (typeof this._promptBatchCallback === 'function') {\n                this._promptBatchCallback(this._promptBatchReturnData);\n            }\n        }\n    },\n\n    /**\n     * Show the user prompt with a given message and choices, plus an optional \"Apply to remaining\" checkbox.\n     *\n     * @param {string} message\n     * @param {object} choices\n     * @param {function} callback\n     * @param {number} itemsToGo\n     */\n    _showPrompt: function(message, choices, callback, itemsToGo) {\n        this._promptCallback = callback;\n\n        if (this.modal === null) {\n            this.modal = new Garnish.Modal({closeOtherModals: false});\n        }\n\n        if (this.$modalContainerDiv === null) {\n            this.$modalContainerDiv = $('<div class=\"modal fitted prompt-modal\"></div>').addClass().appendTo(Garnish.$bod);\n        }\n\n        this.$prompt = $('<div class=\"body\"></div>').appendTo(this.$modalContainerDiv.empty());\n\n        this.$promptMessage = $('<p class=\"prompt-msg\"/>').appendTo(this.$prompt);\n\n        this.$promptChoices = $('<div class=\"options\"></div>').appendTo(this.$prompt);\n\n        this.$promptApplyToRemainingContainer = $('<label class=\"assets-applytoremaining\"/>').appendTo(this.$prompt).hide();\n        this.$promptApplyToRemainingCheckbox = $('<input type=\"checkbox\"/>').appendTo(this.$promptApplyToRemainingContainer);\n        this.$promptApplyToRemainingLabel = $('<span/>').appendTo(this.$promptApplyToRemainingContainer);\n\n        this.$promptButtons = $('<div class=\"buttons right\"/>').appendTo(this.$prompt);\n\n        this.modal.setContainer(this.$modalContainerDiv);\n\n        this.$promptMessage.html(message);\n\n        var $cancelButton = $('<div class=\"btn\">' + Craft.t('app', 'Cancel') + '</div>').appendTo(this.$promptButtons),\n            $submitBtn = $('<input type=\"submit\" class=\"btn submit disabled\" value=\"' + Craft.t('app', 'OK') + '\" />').appendTo(this.$promptButtons);\n\n        for (var i = 0; i < choices.length; i++) {\n            var $radioButtonHtml = $('<div><label><input type=\"radio\" name=\"promptAction\" value=\"' + choices[i].value + '\"/> ' + choices[i].title + '</label></div>').appendTo(this.$promptChoices),\n                $radioButton = $radioButtonHtml.find('input');\n\n            this.addListener($radioButton, 'click', function() {\n                $submitBtn.removeClass('disabled');\n            });\n        }\n\n        this.addListener($submitBtn, 'activate', function(ev) {\n            var choice = $(ev.currentTarget).parents('.modal').find('input[name=promptAction]:checked').val(),\n                applyToRemaining = this.$promptApplyToRemainingCheckbox.prop('checked');\n\n            this._selectPromptChoice(choice, applyToRemaining);\n        });\n\n        this.addListener($cancelButton, 'activate', function() {\n            var choice = 'cancel',\n                applyToRemaining = this.$promptApplyToRemainingCheckbox.prop('checked');\n\n            this._selectPromptChoice(choice, applyToRemaining);\n        });\n\n        if (itemsToGo) {\n            this.$promptApplyToRemainingContainer.show();\n            this.$promptApplyToRemainingLabel.html(' ' + Craft.t('app', 'Apply this to the {number} remaining conflicts?', {number: itemsToGo}));\n        }\n\n        this.modal.show();\n        this.modal.removeListener(Garnish.Modal.$shade, 'click');\n        this.addListener(Garnish.Modal.$shade, 'click', '_cancelPrompt');\n\n    },\n\n    /**\n     * Handles when a user selects one of the prompt choices.\n     *\n     * @param choice\n     * @param applyToRemaining\n     * @private\n     */\n    _selectPromptChoice: function(choice, applyToRemaining) {\n        this.$prompt.fadeOut('fast', $.proxy(function() {\n            this.modal.hide();\n            this._promptCallback(choice, applyToRemaining);\n        }, this));\n    },\n\n    /**\n     * Cancels the prompt.\n     */\n    _cancelPrompt: function() {\n        this._selectPromptChoice('cancel', true);\n    }\n});\n\n/** global: Garnish */\n\nCraft.SlideRuleInput = Garnish.Base.extend({\n\n    $container: null,\n    $options: null,\n    $selectedOption: null,\n    $input: null,\n    value: null,\n\n    startPositionX: null,\n\n    init: function(id, settings) {\n        this.setSettings(settings, Craft.SlideRuleInput.defaultSettings);\n\n        this.value = 0;\n        this.graduationsMin = -70;\n        this.graduationsMax = 70;\n        this.slideMin = -45;\n        this.slideMax = 45;\n\n        this.$container = $('#' + id);\n        this.$overlay = $('<div class=\"overlay\"></div>').appendTo(this.$container);\n        this.$cursor = $('<div class=\"cursor\"></div>').appendTo(this.$container);\n        this.$graduations = $('<div class=\"graduations\"></div>').appendTo(this.$container);\n        this.$graduationsUl = $('<ul></ul>').appendTo(this.$graduations);\n\n        for (var i = this.graduationsMin; i <= this.graduationsMax; i++) {\n            var $li = $('<li class=\"graduation\" data-graduation=\"' + i + '\"><div class=\"label\">' + i + '</div></li>').appendTo(this.$graduationsUl);\n\n            if ((i % 5) === 0) {\n                $li.addClass('main-graduation');\n            }\n\n            if (i === 0) {\n                $li.addClass('selected');\n            }\n        }\n\n        this.$options = this.$container.find('.graduation');\n\n        this.addListener(this.$container, 'resize', $.proxy(this, '_handleResize'));\n        this.addListener(this.$container, 'tapstart', $.proxy(this, '_handleTapStart'));\n        this.addListener(Garnish.$bod, 'tapmove', $.proxy(this, '_handleTapMove'));\n        this.addListener(Garnish.$bod, 'tapend', $.proxy(this, '_handleTapEnd'));\n\n        // Set to zero\n\n        // this.setValue(0);\n\n        setTimeout($.proxy(function() {\n            // (n -1) options because the border is placed on the left of the 10px box\n            this.graduationsCalculatedWidth = (this.$options.length - 1) * 10;\n            this.$graduationsUl.css('left', (-this.graduationsCalculatedWidth / 2) + this.$container.width() / 2);\n        }, this), 50);\n    },\n\n    _handleResize: function() {\n        var left = this.valueToPosition(this.value);\n        this.$graduationsUl.css('left', left);\n    },\n\n    _handleTapStart: function(ev, touch) {\n        ev.preventDefault();\n\n        this.startPositionX = touch.position.x;\n        this.startLeft = this.$graduationsUl.position().left;\n\n        this.dragging = true;\n        this.onStart();\n    },\n\n    _handleTapMove: function(ev, touch) {\n        if (this.dragging) {\n            ev.preventDefault();\n\n            var curX = this.startPositionX - touch.position.x;\n            var left = this.startLeft - curX;\n            var value = this.positionToValue(left);\n\n            this.setValue(value);\n\n            this.onChange();\n        }\n    },\n\n    setValue: function(value) {\n        var left = this.valueToPosition(value);\n        if (value < this.slideMin) {\n            value = this.slideMin;\n            left = this.valueToPosition(value);\n\n        }\n        else if (value > this.slideMax) {\n            value = this.slideMax;\n            left = this.valueToPosition(value);\n        }\n\n        this.$graduationsUl.css('left', left);\n\n        if (value >= this.slideMin && value <= this.slideMax) {\n            this.$options.removeClass('selected');\n\n            $.each(this.$options, function(key, option) {\n                if ($(option).data('graduation') > 0) {\n                    if ($(option).data('graduation') <= value) {\n                        $(option).addClass('selected');\n                    }\n                }\n                if ($(option).data('graduation') < 0) {\n                    if ($(option).data('graduation') >= value) {\n                        $(option).addClass('selected');\n                    }\n                }\n\n                if ($(option).data('graduation') == 0) {\n                    $(option).addClass('selected');\n                }\n            });\n        }\n\n        this.value = value;\n    },\n\n    _handleTapEnd: function(ev) {\n        if (this.dragging) {\n            ev.preventDefault();\n            this.dragging = false;\n            this.onEnd();\n        }\n    },\n\n    positionToValue: function(position) {\n        var scaleMin = (this.graduationsMin * -1);\n        var scaleMax = (this.graduationsMin - this.graduationsMax) * -1;\n\n        return (( ( this.$graduations.width() / 2 ) + (position * -1) ) / this.graduationsCalculatedWidth) * scaleMax - scaleMin;\n    },\n\n    valueToPosition: function(value) {\n        var scaleMin = (this.graduationsMin * -1);\n        var scaleMax = (this.graduationsMin - this.graduationsMax) * -1;\n\n        return -((value + scaleMin) * this.graduationsCalculatedWidth / scaleMax - this.$graduations.width() / 2);\n    },\n\n    onStart: function() {\n        if (typeof this.settings.onChange === 'function') {\n            this.settings.onStart(this);\n        }\n    },\n\n    onChange: function() {\n        if (typeof this.settings.onChange === 'function') {\n            this.settings.onChange(this);\n        }\n    },\n\n    onEnd: function() {\n        if (typeof this.settings.onChange === 'function') {\n            this.settings.onEnd(this);\n        }\n    },\n\n    defaultSettings: {\n        onStart: $.noop,\n        onChange: $.noop,\n        onEnd: $.noop\n    }\n});\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Slug Generator\n */\nCraft.SlugGenerator = Craft.BaseInputGenerator.extend(\n    {\n        generateTargetValue: function(sourceVal) {\n            // Remove HTML tags\n            sourceVal = sourceVal.replace(/<(.*?)>/g, '');\n\n            // Remove inner-word punctuation\n            sourceVal = sourceVal.replace(/['\"\u2018\u2019\u201c\u201d\\[\\]\\(\\)\\{\\}:]/g, '');\n\n            // Make it lowercase\n            if (!Craft.allowUppercaseInSlug) {\n                sourceVal = sourceVal.toLowerCase();\n            }\n\n            if (Craft.limitAutoSlugsToAscii) {\n                // Convert extended ASCII characters to basic ASCII\n                sourceVal = Craft.asciiString(sourceVal, this.settings.charMap);\n            }\n\n            // Get the \"words\". Split on anything that is not alphanumeric.\n            // Reference: http://www.regular-expressions.info/unicode.html\n            var words = Craft.filterArray(XRegExp.matchChain(sourceVal, [XRegExp('[\\\\p{L}\\\\p{N}\\\\p{M}]+')]));\n\n            if (words.length) {\n                return words.join(Craft.slugWordSeparator);\n            }\n            else {\n                return '';\n            }\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Structure class\n */\nCraft.Structure = Garnish.Base.extend(\n    {\n        id: null,\n\n        $container: null,\n        state: null,\n        structureDrag: null,\n\n        /**\n         * Init\n         */\n        init: function(id, container, settings) {\n            this.id = id;\n            this.$container = $(container);\n            this.setSettings(settings, Craft.Structure.defaults);\n\n            // Is this already a structure?\n            if (this.$container.data('structure')) {\n                Garnish.log('Double-instantiating a structure on an element');\n                this.$container.data('structure').destroy();\n            }\n\n            this.$container.data('structure', this);\n\n            this.state = {};\n\n            if (this.settings.storageKey) {\n                $.extend(this.state, Craft.getLocalStorage(this.settings.storageKey, {}));\n            }\n\n            if (typeof this.state.collapsedElementIds === 'undefined') {\n                this.state.collapsedElementIds = [];\n            }\n\n            var $parents = this.$container.find('ul').prev('.row');\n\n            for (var i = 0; i < $parents.length; i++) {\n                var $row = $($parents[i]),\n                    $li = $row.parent(),\n                    $toggle = $('<div class=\"toggle\" title=\"' + Craft.t('app', 'Show/hide children') + '\"/>').prependTo($row);\n\n                if ($.inArray($row.children('.element').data('id'), this.state.collapsedElementIds) !== -1) {\n                    $li.addClass('collapsed');\n                }\n\n                this.initToggle($toggle);\n            }\n\n            if (this.settings.sortable) {\n                this.structureDrag = new Craft.StructureDrag(this, this.settings.maxLevels);\n            }\n\n            if (this.settings.newChildUrl) {\n                this.initNewChildMenus(this.$container.find('.add'));\n            }\n        },\n\n        initToggle: function($toggle) {\n            $toggle.on('click', $.proxy(function(ev) {\n                var $li = $(ev.currentTarget).closest('li'),\n                    elementId = $li.children('.row').find('.element:first').data('id'),\n                    viewStateKey = $.inArray(elementId, this.state.collapsedElementIds);\n\n                if ($li.hasClass('collapsed')) {\n                    $li.removeClass('collapsed');\n\n                    if (viewStateKey !== -1) {\n                        this.state.collapsedElementIds.splice(viewStateKey, 1);\n                    }\n                }\n                else {\n                    $li.addClass('collapsed');\n\n                    if (viewStateKey === -1) {\n                        this.state.collapsedElementIds.push(elementId);\n                    }\n                }\n\n                if (this.settings.storageKey) {\n                    Craft.setLocalStorage(this.settings.storageKey, this.state);\n                }\n\n            }, this));\n        },\n\n        initNewChildMenus: function($addBtns) {\n            this.addListener($addBtns, 'click', 'onNewChildMenuClick');\n        },\n\n        onNewChildMenuClick: function(ev) {\n            var $btn = $(ev.currentTarget);\n\n            if (!$btn.data('menubtn')) {\n                var elementId = $btn.parent().children('.element').data('id'),\n                    newChildUrl = Craft.getUrl(this.settings.newChildUrl, 'parentId=' + elementId);\n\n                $('<div class=\"menu\"><ul><li><a href=\"' + newChildUrl + '\">' + Craft.t('app', 'New child') + '</a></li></ul></div>').insertAfter($btn);\n\n                var menuBtn = new Garnish.MenuBtn($btn);\n                menuBtn.showMenu();\n            }\n        },\n\n        getIndent: function(level) {\n            return Craft.Structure.baseIndent + (level - 1) * Craft.Structure.nestedIndent;\n        },\n\n        addElement: function($element) {\n            var $li = $('<li data-level=\"1\"/>').appendTo(this.$container),\n                $row = $('<div class=\"row\" style=\"margin-' + Craft.left + ': -' + Craft.Structure.baseIndent + 'px; padding-' + Craft.left + ': ' + Craft.Structure.baseIndent + 'px;\">').appendTo($li);\n\n            $row.append($element);\n\n            if (this.settings.sortable) {\n                $row.append('<a class=\"move icon\" title=\"' + Craft.t('app', 'Move') + '\"></a>');\n                this.structureDrag.addItems($li);\n            }\n\n            if (this.settings.newChildUrl) {\n                var $addBtn = $('<a class=\"add icon\" title=\"' + Craft.t('app', 'New child') + '\"></a>').appendTo($row);\n                this.initNewChildMenus($addBtn);\n            }\n\n            $row.css('margin-bottom', -30);\n            $row.velocity({'margin-bottom': 0}, 'fast');\n        },\n\n        removeElement: function($element) {\n            var $li = $element.parent().parent();\n\n            if (this.settings.sortable) {\n                this.structureDrag.removeItems($li);\n            }\n\n            var $parentUl;\n\n            if (!$li.siblings().length) {\n                $parentUl = $li.parent();\n            }\n\n            $li.css('visibility', 'hidden').velocity({marginBottom: -$li.height()}, 'fast', $.proxy(function() {\n                $li.remove();\n\n                if (typeof $parentUl !== 'undefined') {\n                    this._removeUl($parentUl);\n                }\n            }, this));\n        },\n\n        _removeUl: function($ul) {\n            $ul.siblings('.row').children('.toggle').remove();\n            $ul.remove();\n        }\n    },\n    {\n        baseIndent: 8,\n        nestedIndent: 35,\n\n        defaults: {\n            storageKey: null,\n            sortable: false,\n            newChildUrl: null,\n            maxLevels: null\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Structure drag class\n */\nCraft.StructureDrag = Garnish.Drag.extend(\n    {\n        structure: null,\n        maxLevels: null,\n        draggeeLevel: null,\n\n        $helperLi: null,\n        $targets: null,\n        draggeeHeight: null,\n\n        init: function(structure, maxLevels) {\n            this.structure = structure;\n            this.maxLevels = maxLevels;\n\n            this.$insertion = $('<li class=\"draginsertion\"/>');\n\n            var $items = this.structure.$container.find('li');\n\n            this.base($items, {\n                handle: '.element:first, .move:first',\n                helper: $.proxy(this, 'getHelper')\n            });\n        },\n\n        getHelper: function($helper) {\n            this.$helperLi = $helper;\n            var $ul = $('<ul class=\"structure draghelper\"/>').append($helper);\n            $helper.css('padding-' + Craft.left, this.$draggee.css('padding-' + Craft.left));\n            $helper.find('.move').removeAttr('title');\n            return $ul;\n        },\n\n        onDragStart: function() {\n            this.$targets = $();\n\n            // Recursively find each of the targets, in the order they appear to be in\n            this.findTargets(this.structure.$container);\n\n            // How deep does the rabbit hole go?\n            this.draggeeLevel = 0;\n            var $level = this.$draggee;\n            do {\n                this.draggeeLevel++;\n                $level = $level.find('> ul > li');\n            } while ($level.length);\n\n            // Collapse the draggee\n            this.draggeeHeight = this.$draggee.height();\n            this.$draggee.velocity({\n                height: 0\n            }, 'fast', $.proxy(function() {\n                this.$draggee.addClass('hidden');\n            }, this));\n            this.base();\n\n            this.addListener(Garnish.$doc, 'keydown', function(ev) {\n                if (ev.keyCode === Garnish.ESC_KEY) {\n                    this.cancelDrag();\n                }\n            });\n        },\n\n        findTargets: function($ul) {\n            var $lis = $ul.children().not(this.$draggee);\n\n            for (var i = 0; i < $lis.length; i++) {\n                var $li = $($lis[i]);\n                this.$targets = this.$targets.add($li.children('.row'));\n\n                if (!$li.hasClass('collapsed')) {\n                    this.findTargets($li.children('ul'));\n                }\n            }\n        },\n\n        onDrag: function() {\n            if (this._.$closestTarget) {\n                this._.$closestTarget.removeClass('draghover');\n                this.$insertion.remove();\n            }\n\n            // First let's find the closest target\n            this._.$closestTarget = null;\n            this._.closestTargetPos = null;\n            this._.closestTargetYDiff = null;\n            this._.closestTargetOffset = null;\n            this._.closestTargetHeight = null;\n\n            for (this._.i = 0; this._.i < this.$targets.length; this._.i++) {\n                this._.$target = $(this.$targets[this._.i]);\n                this._.targetOffset = this._.$target.offset();\n                this._.targetHeight = this._.$target.outerHeight();\n                this._.targetYMidpoint = this._.targetOffset.top + (this._.targetHeight / 2);\n                this._.targetYDiff = Math.abs(this.mouseY - this._.targetYMidpoint);\n\n                if (this._.i === 0 || (this.mouseY >= this._.targetOffset.top + 5 && this._.targetYDiff < this._.closestTargetYDiff)) {\n                    this._.$closestTarget = this._.$target;\n                    this._.closestTargetPos = this._.i;\n                    this._.closestTargetYDiff = this._.targetYDiff;\n                    this._.closestTargetOffset = this._.targetOffset;\n                    this._.closestTargetHeight = this._.targetHeight;\n                }\n                else {\n                    // Getting colder\n                    break;\n                }\n            }\n\n            if (!this._.$closestTarget) {\n                return;\n            }\n\n            // Are we hovering above the first row?\n            if (this._.closestTargetPos === 0 && this.mouseY < this._.closestTargetOffset.top + 5) {\n                this.$insertion.prependTo(this.structure.$container);\n            }\n            else {\n                this._.$closestTargetLi = this._.$closestTarget.parent();\n                this._.closestTargetLevel = this._.$closestTargetLi.data('level');\n\n                // Is there a next row?\n                if (this._.closestTargetPos < this.$targets.length - 1) {\n                    this._.$nextTargetLi = $(this.$targets[this._.closestTargetPos + 1]).parent();\n                    this._.nextTargetLevel = this._.$nextTargetLi.data('level');\n                }\n                else {\n                    this._.$nextTargetLi = null;\n                    this._.nextTargetLevel = null;\n                }\n\n                // Are we hovering between this row and the next one?\n                this._.hoveringBetweenRows = (this.mouseY >= this._.closestTargetOffset.top + this._.closestTargetHeight - 5);\n\n                /**\n                 * Scenario 1: Both rows have the same level.\n                 *\n                 *     * Row 1\n                 *     ----------------------\n                 *     * Row 2\n                 */\n\n                if (this._.$nextTargetLi && this._.nextTargetLevel == this._.closestTargetLevel) {\n                    if (this._.hoveringBetweenRows) {\n                        if (!this.maxLevels || this.maxLevels >= (this._.closestTargetLevel + this.draggeeLevel - 1)) {\n                            // Position the insertion after the closest target\n                            this.$insertion.insertAfter(this._.$closestTargetLi);\n                        }\n\n                    }\n                    else {\n                        if (!this.maxLevels || this.maxLevels >= (this._.closestTargetLevel + this.draggeeLevel)) {\n                            this._.$closestTarget.addClass('draghover');\n                        }\n                    }\n                }\n\n                /**\n                 * Scenario 2: Next row is a child of this one.\n                 *\n                 *     * Row 1\n                 *     ----------------------\n                 *         * Row 2\n                 */\n\n                else if (this._.$nextTargetLi && this._.nextTargetLevel > this._.closestTargetLevel) {\n                    if (!this.maxLevels || this.maxLevels >= (this._.nextTargetLevel + this.draggeeLevel - 1)) {\n                        if (this._.hoveringBetweenRows) {\n                            // Position the insertion as the first child of the closest target\n                            this.$insertion.insertBefore(this._.$nextTargetLi);\n                        }\n                        else {\n                            this._.$closestTarget.addClass('draghover');\n                            this.$insertion.appendTo(this._.$closestTargetLi.children('ul'));\n                        }\n                    }\n                }\n\n                /**\n                 * Scenario 3: Next row is a child of a parent node, or there is no next row.\n                 *\n                 *         * Row 1\n                 *     ----------------------\n                 *     * Row 2\n                 */\n\n                else {\n                    if (this._.hoveringBetweenRows) {\n                        // Determine which <li> to position the insertion after\n                        this._.draggeeX = this.mouseX - this.targetItemMouseDiffX;\n\n                        if (Craft.orientation === 'rtl') {\n                            this._.draggeeX += this.$helperLi.width();\n                        }\n\n                        this._.$parentLis = this._.$closestTarget.parentsUntil(this.structure.$container, 'li');\n                        this._.$closestParentLi = null;\n                        this._.closestParentLiXDiff = null;\n                        this._.closestParentLevel = null;\n\n                        for (this._.i = 0; this._.i < this._.$parentLis.length; this._.i++) {\n                            this._.$parentLi = $(this._.$parentLis[this._.i]);\n                            this._.parentLiX = this._.$parentLi.offset().left;\n\n                            if (Craft.orientation === 'rtl') {\n                                this._.parentLiX += this._.$parentLi.width();\n                            }\n\n                            this._.parentLiXDiff = Math.abs(this._.parentLiX - this._.draggeeX);\n                            this._.parentLevel = this._.$parentLi.data('level');\n\n                            if ((!this.maxLevels || this.maxLevels >= (this._.parentLevel + this.draggeeLevel - 1)) && (\n                                    !this._.$closestParentLi || (\n                                        this._.parentLiXDiff < this._.closestParentLiXDiff &&\n                                        (!this._.$nextTargetLi || this._.parentLevel >= this._.nextTargetLevel)\n                                    )\n                                )) {\n                                this._.$closestParentLi = this._.$parentLi;\n                                this._.closestParentLiXDiff = this._.parentLiXDiff;\n                                this._.closestParentLevel = this._.parentLevel;\n                            }\n                        }\n\n                        if (this._.$closestParentLi) {\n                            this.$insertion.insertAfter(this._.$closestParentLi);\n                        }\n                    }\n                    else {\n                        if (!this.maxLevels || this.maxLevels >= (this._.closestTargetLevel + this.draggeeLevel)) {\n                            this._.$closestTarget.addClass('draghover');\n                        }\n                    }\n                }\n            }\n        },\n\n        cancelDrag: function() {\n            this.$insertion.remove();\n\n            if (this._.$closestTarget) {\n                this._.$closestTarget.removeClass('draghover');\n            }\n\n            this.onMouseUp();\n        },\n\n        onDragStop: function() {\n            // Are we repositioning the draggee?\n            if (this._.$closestTarget && (this.$insertion.parent().length || this._.$closestTarget.hasClass('draghover'))) {\n                var $draggeeParent,\n                    moved;\n\n                // Are we about to leave the draggee's original parent childless?\n                if (!this.$draggee.siblings().length) {\n                    $draggeeParent = this.$draggee.parent();\n                }\n\n                if (this.$insertion.parent().length) {\n                    // Make sure the insertion isn't right next to the draggee\n                    var $closestSiblings = this.$insertion.next().add(this.$insertion.prev());\n\n                    if ($.inArray(this.$draggee[0], $closestSiblings) === -1) {\n                        this.$insertion.replaceWith(this.$draggee);\n                        moved = true;\n                    }\n                    else {\n                        this.$insertion.remove();\n                        moved = false;\n                    }\n                }\n                else {\n                    var $ul = this._.$closestTargetLi.children('ul');\n\n                    // Make sure this is a different parent than the draggee's\n                    if (!$draggeeParent || !$ul.length || $ul[0] !== $draggeeParent[0]) {\n                        if (!$ul.length) {\n                            var $toggle = $('<div class=\"toggle\" title=\"' + Craft.t('app', 'Show/hide children') + '\"/>').prependTo(this._.$closestTarget);\n                            this.structure.initToggle($toggle);\n\n                            $ul = $('<ul>').appendTo(this._.$closestTargetLi);\n                        }\n                        else if (this._.$closestTargetLi.hasClass('collapsed')) {\n                            this._.$closestTarget.children('.toggle').trigger('click');\n                        }\n\n                        this.$draggee.appendTo($ul);\n                        moved = true;\n                    }\n                    else {\n                        moved = false;\n                    }\n                }\n\n                // Remove the class either way\n                this._.$closestTarget.removeClass('draghover');\n\n                if (moved) {\n                    // Now deal with the now-childless parent\n                    if ($draggeeParent) {\n                        this.structure._removeUl($draggeeParent);\n                    }\n\n                    // Has the level changed?\n                    var newLevel = this.$draggee.parentsUntil(this.structure.$container, 'li').length + 1;\n\n                    var animateCss;\n\n                    if (newLevel != this.$draggee.data('level')) {\n                        // Correct the helper's padding if moving to/from level 1\n                        if (this.$draggee.data('level') == 1) {\n                            animateCss = {};\n                            animateCss['padding-' + Craft.left] = 38;\n                            this.$helperLi.velocity(animateCss, 'fast');\n                        }\n                        else if (newLevel == 1) {\n                            animateCss = {};\n                            animateCss['padding-' + Craft.left] = Craft.Structure.baseIndent;\n                            this.$helperLi.velocity(animateCss, 'fast');\n                        }\n\n                        this.setLevel(this.$draggee, newLevel);\n                    }\n\n                    // Make it real\n                    var $element = this.$draggee.children('.row').children('.element');\n\n                    var data = {\n                        structureId: this.structure.id,\n                        elementId: $element.data('id'),\n                        siteId: $element.data('site-id'),\n                        prevId: this.$draggee.prev().children('.row').children('.element').data('id'),\n                        parentId: this.$draggee.parent('ul').parent('li').children('.row').children('.element').data('id')\n                    };\n\n                    Craft.postActionRequest('structures/move-element', data, function(response, textStatus) {\n                        if (textStatus === 'success') {\n                            Craft.cp.displayNotice(Craft.t('app', 'New order saved.'));\n                        }\n\n                    });\n                }\n            }\n\n            // Animate things back into place\n            this.$draggee.velocity('stop').removeClass('hidden').velocity({\n                height: this.draggeeHeight\n            }, 'fast', $.proxy(function() {\n                this.$draggee.css('height', 'auto');\n            }, this));\n\n            this.returnHelpersToDraggees();\n\n            this.base();\n        },\n\n        setLevel: function($li, level) {\n            $li.data('level', level);\n\n            var indent = this.structure.getIndent(level);\n\n            var css = {};\n            css['margin-' + Craft.left] = '-' + indent + 'px';\n            css['padding-' + Craft.left] = indent + 'px';\n            this.$draggee.children('.row').css(css);\n\n            var $childLis = $li.children('ul').children();\n\n            for (var i = 0; i < $childLis.length; i++) {\n                this.setLevel($($childLis[i]), level + 1);\n            }\n        }\n\n    });\n\n/** global: Craft */\n/** global: Garnish */\nCraft.StructureTableSorter = Garnish.DragSort.extend({\n\n        // Properties\n        // =========================================================================\n\n        tableView: null,\n        structureId: null,\n        maxLevels: null,\n\n        _helperMargin: null,\n\n        _$firstRowCells: null,\n        _$titleHelperCell: null,\n\n        _titleHelperCellOuterWidth: null,\n\n        _ancestors: null,\n        _updateAncestorsFrame: null,\n        _updateAncestorsProxy: null,\n\n        _draggeeLevel: null,\n        _draggeeLevelDelta: null,\n        draggingLastElements: null,\n        _loadingDraggeeLevelDelta: false,\n\n        _targetLevel: null,\n        _targetLevelBounds: null,\n\n        _positionChanged: null,\n\n        // Public methods\n        // =========================================================================\n\n        /**\n         * Constructor\n         */\n        init: function(tableView, $elements, settings) {\n            this.tableView = tableView;\n            this.structureId = this.tableView.$table.data('structure-id');\n            this.maxLevels = parseInt(this.tableView.$table.attr('data-max-levels'));\n\n            settings = $.extend({}, Craft.StructureTableSorter.defaults, settings, {\n                handle: '.move',\n                collapseDraggees: true,\n                singleHelper: true,\n                helperSpacingY: 2,\n                magnetStrength: 4,\n                helper: $.proxy(this, 'getHelper'),\n                helperLagBase: 1.5,\n                axis: Garnish.Y_AXIS\n            });\n\n            this.base($elements, settings);\n        },\n\n        /**\n         * Start Dragging\n         */\n        startDragging: function() {\n            this._helperMargin = Craft.StructureTableSorter.HELPER_MARGIN + (this.tableView.elementIndex.actions ? 24 : 0);\n            this.base();\n        },\n\n        /**\n         * Returns the draggee rows (including any descendent rows).\n         */\n        findDraggee: function() {\n            this._draggeeLevel = this._targetLevel = this.$targetItem.data('level');\n            this._draggeeLevelDelta = 0;\n\n            var $draggee = $(this.$targetItem),\n                $nextRow = this.$targetItem.next();\n\n            while ($nextRow.length) {\n                // See if this row is a descendant of the draggee\n                var nextRowLevel = $nextRow.data('level');\n\n                if (nextRowLevel <= this._draggeeLevel) {\n                    break;\n                }\n\n                // Is this the deepest descendant we've seen so far?\n                var nextRowLevelDelta = nextRowLevel - this._draggeeLevel;\n\n                if (nextRowLevelDelta > this._draggeeLevelDelta) {\n                    this._draggeeLevelDelta = nextRowLevelDelta;\n                }\n\n                // Add it and prep the next row\n                $draggee = $draggee.add($nextRow);\n                $nextRow = $nextRow.next();\n            }\n\n            // Are we dragging the last elements on the page?\n            this.draggingLastElements = !$nextRow.length;\n\n            // Do we have a maxLevels to enforce,\n            // and does it look like this draggee has descendants we don't know about yet?\n            if (\n                this.maxLevels &&\n                this.draggingLastElements &&\n                this.tableView.getMorePending()\n            ) {\n                // Only way to know the true descendant level delta is to ask PHP\n                this._loadingDraggeeLevelDelta = true;\n\n                var data = this._getAjaxBaseData(this.$targetItem);\n\n                Craft.postActionRequest('structures/get-element-level-delta', data, $.proxy(function(response, textStatus) {\n                    if (textStatus === 'success') {\n                        this._loadingDraggeeLevelDelta = false;\n\n                        if (this.dragging) {\n                            this._draggeeLevelDelta = response.delta;\n                            this.drag(false);\n                        }\n                    }\n                }, this));\n            }\n\n            return $draggee;\n        },\n\n        /**\n         * Returns the drag helper.\n         */\n        getHelper: function($helperRow) {\n            var $outerContainer = $('<div class=\"elements datatablesorthelper\"/>').appendTo(Garnish.$bod),\n                $innerContainer = $('<div class=\"tableview\"/>').appendTo($outerContainer),\n                $table = $('<table class=\"data\"/>').appendTo($innerContainer),\n                $tbody = $('<tbody/>').appendTo($table);\n\n            $helperRow.appendTo($tbody);\n\n            // Copy the column widths\n            this._$firstRowCells = this.tableView.$elementContainer.children('tr:first').children();\n            var $helperCells = $helperRow.children();\n\n            for (var i = 0; i < $helperCells.length; i++) {\n                var $helperCell = $($helperCells[i]);\n\n                // Skip the checkbox cell\n                if ($helperCell.hasClass('checkbox-cell')) {\n                    $helperCell.remove();\n                    continue;\n                }\n\n                // Hard-set the cell widths\n                var $firstRowCell = $(this._$firstRowCells[i]),\n                    width = $firstRowCell.width();\n\n                $firstRowCell.width(width);\n                $helperCell.width(width);\n\n                // Is this the title cell?\n                if (Garnish.hasAttr($firstRowCell, 'data-titlecell')) {\n                    this._$titleHelperCell = $helperCell;\n\n                    var padding = parseInt($firstRowCell.css('padding-' + Craft.left));\n                    this._titleHelperCellOuterWidth = width + padding - (this.tableView.elementIndex.actions ? 12 : 0);\n\n                    $helperCell.css('padding-' + Craft.left, Craft.StructureTableSorter.BASE_PADDING);\n                }\n            }\n\n            return $outerContainer;\n        },\n\n        /**\n         * Returns whether the draggee can be inserted before a given item.\n         */\n        canInsertBefore: function($item) {\n            if (this._loadingDraggeeLevelDelta) {\n                return false;\n            }\n\n            return (this._getLevelBounds($item.prev(), $item) !== false);\n        },\n\n        /**\n         * Returns whether the draggee can be inserted after a given item.\n         */\n        canInsertAfter: function($item) {\n            if (this._loadingDraggeeLevelDelta) {\n                return false;\n            }\n\n            return (this._getLevelBounds($item, $item.next()) !== false);\n        },\n\n        // Events\n        // -------------------------------------------------------------------------\n\n        /**\n         * On Drag Start\n         */\n        onDragStart: function() {\n            // Get the initial set of ancestors, before the item gets moved\n            this._ancestors = this._getAncestors(this.$targetItem, this.$targetItem.data('level'));\n\n            // Set the initial target level bounds\n            this._setTargetLevelBounds();\n\n            // Check to see if we should load more elements now\n            this.tableView.maybeLoadMore();\n\n            this.base();\n        },\n\n        /**\n         * On Drag\n         */\n        onDrag: function() {\n            this.base();\n            this._updateIndent();\n        },\n\n        /**\n         * On Insertion Point Change\n         */\n        onInsertionPointChange: function() {\n            this._setTargetLevelBounds();\n            this._updateAncestorsBeforeRepaint();\n            this.base();\n        },\n\n        /**\n         * On Drag Stop\n         */\n        onDragStop: function() {\n            this._positionChanged = false;\n            this.base();\n\n            // Update the draggee's padding if the position just changed\n            // ---------------------------------------------------------------------\n\n            if (this._targetLevel != this._draggeeLevel) {\n                var levelDiff = this._targetLevel - this._draggeeLevel;\n\n                for (var i = 0; i < this.$draggee.length; i++) {\n                    var $draggee = $(this.$draggee[i]),\n                        oldLevel = $draggee.data('level'),\n                        newLevel = oldLevel + levelDiff,\n                        padding = Craft.StructureTableSorter.BASE_PADDING + (this.tableView.elementIndex.actions ? 7 : 0) + this._getLevelIndent(newLevel);\n\n                    $draggee.data('level', newLevel);\n                    $draggee.find('.element').data('level', newLevel);\n                    $draggee.children('[data-titlecell]:first').css('padding-' + Craft.left, padding);\n                }\n\n                this._positionChanged = true;\n            }\n\n            // Keep in mind this could have also been set by onSortChange()\n            if (this._positionChanged) {\n                // Tell the server about the new position\n                // -----------------------------------------------------------------\n\n                var data = this._getAjaxBaseData(this.$draggee);\n\n                // Find the previous sibling/parent, if there is one\n                var $prevRow = this.$draggee.first().prev();\n\n                while ($prevRow.length) {\n                    var prevRowLevel = $prevRow.data('level');\n\n                    if (prevRowLevel == this._targetLevel) {\n                        data.prevId = $prevRow.data('id');\n                        break;\n                    }\n\n                    if (prevRowLevel < this._targetLevel) {\n                        data.parentId = $prevRow.data('id');\n\n                        // Is this row collapsed?\n                        var $toggle = $prevRow.find('> td > .toggle');\n\n                        if (!$toggle.hasClass('expanded')) {\n                            // Make it look expanded\n                            $toggle.addClass('expanded');\n\n                            // Add a temporary row\n                            var $spinnerRow = this.tableView._createSpinnerRowAfter($prevRow);\n\n                            // Remove the target item\n                            if (this.tableView.elementSelect) {\n                                this.tableView.elementSelect.removeItems(this.$targetItem);\n                            }\n\n                            this.removeItems(this.$targetItem);\n                            this.$targetItem.remove();\n                            this.tableView._totalVisible--;\n                        }\n\n                        break;\n                    }\n\n                    $prevRow = $prevRow.prev();\n                }\n\n                Craft.postActionRequest('structures/move-element', data, $.proxy(function(response, textStatus) {\n                    if (textStatus === 'success') {\n                        if (!response.success) {\n                            Craft.cp.displayError(Craft.t('app', 'An unknown error occurred.'));\n                            this.tableView.elementIndex.updateElements();\n                            return;\n                        }\n                        Craft.cp.displayNotice(Craft.t('app', 'New position saved.'));\n                        this.onPositionChange();\n\n                        // Were we waiting on this to complete so we can expand the new parent?\n                        if ($spinnerRow && $spinnerRow.parent().length) {\n                            $spinnerRow.remove();\n                            this.tableView._expandElement($toggle, true);\n                        }\n\n                        // See if we should run any pending tasks\n                        Craft.cp.runQueue();\n                    }\n                }, this));\n            }\n        },\n\n        onSortChange: function() {\n            if (this.tableView.elementSelect) {\n                this.tableView.elementSelect.resetItemOrder();\n            }\n\n            this._positionChanged = true;\n            this.base();\n        },\n\n        onPositionChange: function() {\n            Garnish.requestAnimationFrame($.proxy(function() {\n                this.trigger('positionChange');\n                this.settings.onPositionChange();\n            }, this));\n        },\n\n        onReturnHelpersToDraggees: function() {\n            this._$firstRowCells.css('width', '');\n\n            // If we were dragging the last elements on the page and ended up loading any additional elements in,\n            // there could be a gap between the last draggee item and whatever now comes after it.\n            // So remove the post-draggee elements and possibly load up the next batch.\n            if (this.draggingLastElements && this.tableView.getMorePending()) {\n                // Update the element index's record of how many items are actually visible\n                this.tableView._totalVisible += (this.newDraggeeIndexes[0] - this.oldDraggeeIndexes[0]);\n\n                var $postDraggeeItems = this.$draggee.last().nextAll();\n\n                if ($postDraggeeItems.length) {\n                    this.removeItems($postDraggeeItems);\n                    $postDraggeeItems.remove();\n                    this.tableView.maybeLoadMore();\n                }\n            }\n\n            this.base();\n        },\n\n        // Private methods\n        // =========================================================================\n\n        /**\n         * Returns the min and max levels that the draggee could occupy between\n         * two given rows, or false if it\u2019s not going to work out.\n         */\n        _getLevelBounds: function($prevRow, $nextRow) {\n            // Can't go any lower than the next row, if there is one\n            if ($nextRow && $nextRow.length) {\n                this._getLevelBounds._minLevel = $nextRow.data('level');\n            }\n            else {\n                this._getLevelBounds._minLevel = 1;\n            }\n\n            // Can't go any higher than the previous row + 1\n            if ($prevRow && $prevRow.length) {\n                this._getLevelBounds._maxLevel = $prevRow.data('level') + 1;\n            }\n            else {\n                this._getLevelBounds._maxLevel = 1;\n            }\n\n            // Does this structure have a max level?\n            if (this.maxLevels) {\n                // Make sure it's going to fit at all here\n                if (\n                    this._getLevelBounds._minLevel != 1 &&\n                    this._getLevelBounds._minLevel + this._draggeeLevelDelta > this.maxLevels\n                ) {\n                    return false;\n                }\n\n                // Limit the max level if we have to\n                if (this._getLevelBounds._maxLevel + this._draggeeLevelDelta > this.maxLevels) {\n                    this._getLevelBounds._maxLevel = this.maxLevels - this._draggeeLevelDelta;\n\n                    if (this._getLevelBounds._maxLevel < this._getLevelBounds._minLevel) {\n                        this._getLevelBounds._maxLevel = this._getLevelBounds._minLevel;\n                    }\n                }\n            }\n\n            return {\n                min: this._getLevelBounds._minLevel,\n                max: this._getLevelBounds._maxLevel\n            };\n        },\n\n        /**\n         * Determines the min and max possible levels at the current draggee's position.\n         */\n        _setTargetLevelBounds: function() {\n            this._targetLevelBounds = this._getLevelBounds(\n                this.$draggee.first().prev(),\n                this.$draggee.last().next()\n            );\n        },\n\n        /**\n         * Determines the target level based on the current mouse position.\n         */\n        _updateIndent: function(forcePositionChange) {\n            // Figure out the target level\n            // ---------------------------------------------------------------------\n\n            // How far has the cursor moved?\n            this._updateIndent._mouseDist = this.realMouseX - this.mousedownX;\n\n            // Flip that if this is RTL\n            if (Craft.orientation === 'rtl') {\n                this._updateIndent._mouseDist *= -1;\n            }\n\n            // What is that in indentation levels?\n            this._updateIndent._indentationDist = Math.round(this._updateIndent._mouseDist / Craft.StructureTableSorter.LEVEL_INDENT);\n\n            // Combine with the original level to get the new target level\n            this._updateIndent._targetLevel = this._draggeeLevel + this._updateIndent._indentationDist;\n\n            // Contain it within our min/max levels\n            if (this._updateIndent._targetLevel < this._targetLevelBounds.min) {\n                this._updateIndent._indentationDist += (this._targetLevelBounds.min - this._updateIndent._targetLevel);\n                this._updateIndent._targetLevel = this._targetLevelBounds.min;\n            }\n            else if (this._updateIndent._targetLevel > this._targetLevelBounds.max) {\n                this._updateIndent._indentationDist -= (this._updateIndent._targetLevel - this._targetLevelBounds.max);\n                this._updateIndent._targetLevel = this._targetLevelBounds.max;\n            }\n\n            // Has the target level changed?\n            if (this._targetLevel !== (this._targetLevel = this._updateIndent._targetLevel)) {\n                // Target level is changing, so update the ancestors\n                this._updateAncestorsBeforeRepaint();\n            }\n\n            // Update the UI\n            // ---------------------------------------------------------------------\n\n            // How far away is the cursor from the exact target level distance?\n            this._updateIndent._targetLevelMouseDiff = this._updateIndent._mouseDist - (this._updateIndent._indentationDist * Craft.StructureTableSorter.LEVEL_INDENT);\n\n            // What's the magnet impact of that?\n            this._updateIndent._magnetImpact = Math.round(this._updateIndent._targetLevelMouseDiff / 15);\n\n            // Put it on a leash\n            if (Math.abs(this._updateIndent._magnetImpact) > Craft.StructureTableSorter.MAX_GIVE) {\n                this._updateIndent._magnetImpact = (this._updateIndent._magnetImpact > 0 ? 1 : -1) * Craft.StructureTableSorter.MAX_GIVE;\n            }\n\n            // Apply the new margin/width\n            this._updateIndent._closestLevelMagnetIndent = this._getLevelIndent(this._targetLevel) + this._updateIndent._magnetImpact;\n            this.helpers[0].css('margin-' + Craft.left, this._updateIndent._closestLevelMagnetIndent + this._helperMargin);\n            this._$titleHelperCell.width(this._titleHelperCellOuterWidth - (this._updateIndent._closestLevelMagnetIndent + Craft.StructureTableSorter.BASE_PADDING));\n        },\n\n        /**\n         * Returns the indent size for a given level\n         */\n        _getLevelIndent: function(level) {\n            return (level - 1) * Craft.StructureTableSorter.LEVEL_INDENT;\n        },\n\n        /**\n         * Returns the base data that should be sent with StructureController Ajax requests.\n         */\n        _getAjaxBaseData: function($row) {\n            return {\n                structureId: this.structureId,\n                elementId: $row.data('id'),\n                siteId: $row.find('.element:first').data('site-id')\n            };\n        },\n\n        /**\n         * Returns a row's ancestor rows\n         */\n        _getAncestors: function($row, targetLevel) {\n            this._getAncestors._ancestors = [];\n\n            if (targetLevel != 0) {\n                this._getAncestors._level = targetLevel;\n                this._getAncestors._$prevRow = $row.prev();\n\n                while (this._getAncestors._$prevRow.length) {\n                    if (this._getAncestors._$prevRow.data('level') < this._getAncestors._level) {\n                        this._getAncestors._ancestors.unshift(this._getAncestors._$prevRow);\n                        this._getAncestors._level = this._getAncestors._$prevRow.data('level');\n\n                        // Did we just reach the top?\n                        if (this._getAncestors._level == 0) {\n                            break;\n                        }\n                    }\n\n                    this._getAncestors._$prevRow = this._getAncestors._$prevRow.prev();\n                }\n            }\n\n            return this._getAncestors._ancestors;\n        },\n\n        /**\n         * Prepares to have the ancestors updated before the screen is repainted.\n         */\n        _updateAncestorsBeforeRepaint: function() {\n            if (this._updateAncestorsFrame) {\n                Garnish.cancelAnimationFrame(this._updateAncestorsFrame);\n            }\n\n            if (!this._updateAncestorsProxy) {\n                this._updateAncestorsProxy = $.proxy(this, '_updateAncestors');\n            }\n\n            this._updateAncestorsFrame = Garnish.requestAnimationFrame(this._updateAncestorsProxy);\n        },\n\n        _updateAncestors: function() {\n            this._updateAncestorsFrame = null;\n\n            // Update the old ancestors\n            // -----------------------------------------------------------------\n\n            for (this._updateAncestors._i = 0; this._updateAncestors._i < this._ancestors.length; this._updateAncestors._i++) {\n                this._updateAncestors._$ancestor = this._ancestors[this._updateAncestors._i];\n\n                // One less descendant now\n                this._updateAncestors._$ancestor.data('descendants', this._updateAncestors._$ancestor.data('descendants') - 1);\n\n                // Is it now childless?\n                if (this._updateAncestors._$ancestor.data('descendants') == 0) {\n                    // Remove its toggle\n                    this._updateAncestors._$ancestor.find('> td > .toggle:first').remove();\n                }\n            }\n\n            // Update the new ancestors\n            // -----------------------------------------------------------------\n\n            this._updateAncestors._newAncestors = this._getAncestors(this.$targetItem, this._targetLevel);\n\n            for (this._updateAncestors._i = 0; this._updateAncestors._i < this._updateAncestors._newAncestors.length; this._updateAncestors._i++) {\n                this._updateAncestors._$ancestor = this._updateAncestors._newAncestors[this._updateAncestors._i];\n\n                // One more descendant now\n                this._updateAncestors._$ancestor.data('descendants', this._updateAncestors._$ancestor.data('descendants') + 1);\n\n                // Is this its first child?\n                if (this._updateAncestors._$ancestor.data('descendants') == 1) {\n                    // Create its toggle\n                    $('<span class=\"toggle expanded\" title=\"' + Craft.t('app', 'Show/hide children') + '\"></span>')\n                        .insertAfter(this._updateAncestors._$ancestor.find('> td .move:first'));\n\n                }\n            }\n\n            this._ancestors = this._updateAncestors._newAncestors;\n\n            delete this._updateAncestors._i;\n            delete this._updateAncestors._$ancestor;\n            delete this._updateAncestors._newAncestors;\n        }\n    },\n\n// Static Properties\n// =============================================================================\n\n    {\n        BASE_PADDING: 36,\n        HELPER_MARGIN: -7,\n        LEVEL_INDENT: 44,\n        MAX_GIVE: 22,\n\n        defaults: {\n            onPositionChange: $.noop\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Table Element Index View\n */\nCraft.TableElementIndexView = Craft.BaseElementIndexView.extend(\n    {\n        $table: null,\n        $selectedSortHeader: null,\n\n        structureTableSort: null,\n\n        _totalVisiblePostStructureTableDraggee: null,\n        _morePendingPostStructureTableDraggee: false,\n\n        getElementContainer: function() {\n            // Save a reference to the table\n            this.$table = this.$container.find('table:first');\n            return this.$table.children('tbody:first');\n        },\n\n        afterInit: function() {\n            // Make the table collapsible for mobile devices\n            Craft.cp.$collapsibleTables = Craft.cp.$collapsibleTables.add(this.$table);\n            Craft.cp.updateResponsiveTables();\n\n            // Set the sort header\n            this.initTableHeaders();\n\n            // Create the Structure Table Sorter\n            if (\n                this.elementIndex.settings.context === 'index' &&\n                this.elementIndex.getSelectedSortAttribute() === 'structure' &&\n                Garnish.hasAttr(this.$table, 'data-structure-id')\n            ) {\n                this.structureTableSort = new Craft.StructureTableSorter(this, this.getAllElements(), {\n                    onSortChange: $.proxy(this, '_onStructureTableSortChange')\n                });\n            }\n            else {\n                this.structureTableSort = null;\n            }\n\n            // Handle expand/collapse toggles for Structures\n            if (this.elementIndex.getSelectedSortAttribute() === 'structure') {\n                this.addListener(this.$elementContainer, 'click', function(ev) {\n                    var $target = $(ev.target);\n\n                    if ($target.hasClass('toggle')) {\n                        if (this._collapseElement($target) === false) {\n                            this._expandElement($target);\n                        }\n                    }\n                });\n            }\n        },\n\n        initTableHeaders: function() {\n            var selectedSortAttr = this.elementIndex.getSelectedSortAttribute(),\n                $tableHeaders = this.$table.children('thead').children().children('[data-attribute]');\n\n            for (var i = 0; i < $tableHeaders.length; i++) {\n                var $header = $tableHeaders.eq(i),\n                    attr = $header.attr('data-attribute');\n\n                // Is this the selected sort attribute?\n                if (attr === selectedSortAttr) {\n                    this.$selectedSortHeader = $header;\n                    var selectedSortDir = this.elementIndex.getSelectedSortDirection();\n\n                    $header\n                        .addClass('ordered ' + selectedSortDir)\n                        .on('click', $.proxy(this, '_handleSelectedSortHeaderClick'));\n                }\n                else {\n                    // Is this attribute sortable?\n                    var $sortAttribute = this.elementIndex.getSortAttributeOption(attr);\n\n                    if ($sortAttribute.length) {\n                        $header\n                            .addClass('orderable')\n                            .on('click', $.proxy(this, '_handleUnselectedSortHeaderClick'));\n                    }\n                }\n            }\n        },\n\n        isVerticalList: function() {\n            return true;\n        },\n\n        getTotalVisible: function() {\n            if (this._isStructureTableDraggingLastElements()) {\n                return this._totalVisiblePostStructureTableDraggee;\n            }\n            else {\n                return this._totalVisible;\n            }\n        },\n\n        setTotalVisible: function(totalVisible) {\n            if (this._isStructureTableDraggingLastElements()) {\n                this._totalVisiblePostStructureTableDraggee = totalVisible;\n            }\n            else {\n                this._totalVisible = totalVisible;\n            }\n        },\n\n        getMorePending: function() {\n            if (this._isStructureTableDraggingLastElements()) {\n                return this._morePendingPostStructureTableDraggee;\n            }\n            else {\n                return this._morePending;\n            }\n        },\n\n        setMorePending: function(morePending) {\n            if (this._isStructureTableDraggingLastElements()) {\n                this._morePendingPostStructureTableDraggee = morePending;\n            }\n            else {\n                this._morePending = this._morePendingPostStructureTableDraggee = morePending;\n            }\n        },\n\n        getLoadMoreParams: function() {\n            var params = this.base();\n\n            // If we are dragging the last elements on the page,\n            // tell the controller to only load elements positioned after the draggee.\n            if (this._isStructureTableDraggingLastElements()) {\n                params.criteria.positionedAfter = this.structureTableSort.$targetItem.data('id');\n            }\n\n            return params;\n        },\n\n        appendElements: function($newElements) {\n            this.base($newElements);\n\n            if (this.structureTableSort) {\n                this.structureTableSort.addItems($newElements);\n            }\n\n            Craft.cp.updateResponsiveTables();\n        },\n\n        destroy: function() {\n            if (this.$table) {\n                // Remove the soon-to-be-wiped-out table from the list of collapsible tables\n                Craft.cp.$collapsibleTables = Craft.cp.$collapsibleTables.not(this.$table);\n            }\n\n            this.base();\n        },\n\n        createElementEditor: function($element) {\n            Craft.createElementEditor($element.data('type'), $element, {\n                params: {\n                    includeTableAttributesForSource: this.elementIndex.sourceKey\n                },\n                onSaveElement: $.proxy(function(response) {\n                    if (response.tableAttributes) {\n                        this._updateTableAttributes($element, response.tableAttributes);\n                    }\n                }, this),\n                elementIndex: this.elementIndex\n            });\n        },\n\n        _collapseElement: function($toggle, force) {\n            if (!force && !$toggle.hasClass('expanded')) {\n                return false;\n            }\n\n            $toggle.removeClass('expanded');\n\n            // Find and remove the descendant rows\n            var $row = $toggle.parent().parent(),\n                id = $row.data('id'),\n                level = $row.data('level'),\n                $nextRow = $row.next();\n\n            while ($nextRow.length) {\n                if (!Garnish.hasAttr($nextRow, 'data-spinnerrow')) {\n                    if ($nextRow.data('level') <= level) {\n                        break;\n                    }\n\n                    if (this.elementSelect) {\n                        this.elementSelect.removeItems($nextRow);\n                    }\n\n                    if (this.structureTableSort) {\n                        this.structureTableSort.removeItems($nextRow);\n                    }\n\n                    this._totalVisible--;\n                }\n\n                var $nextNextRow = $nextRow.next();\n                $nextRow.remove();\n                $nextRow = $nextNextRow;\n            }\n\n            // Remember that this row should be collapsed\n            if (!this.elementIndex.instanceState.collapsedElementIds) {\n                this.elementIndex.instanceState.collapsedElementIds = [];\n            }\n\n            this.elementIndex.instanceState.collapsedElementIds.push(id);\n            this.elementIndex.setInstanceState('collapsedElementIds', this.elementIndex.instanceState.collapsedElementIds);\n\n            // Bottom of the index might be viewable now\n            this.maybeLoadMore();\n        },\n\n        _expandElement: function($toggle, force) {\n            if (!force && $toggle.hasClass('expanded')) {\n                return false;\n            }\n\n            $toggle.addClass('expanded');\n\n            // Remove this element from our list of collapsed elements\n            if (this.elementIndex.instanceState.collapsedElementIds) {\n                var $row = $toggle.parent().parent(),\n                    id = $row.data('id'),\n                    index = $.inArray(id, this.elementIndex.instanceState.collapsedElementIds);\n\n                if (index !== -1) {\n                    this.elementIndex.instanceState.collapsedElementIds.splice(index, 1);\n                    this.elementIndex.setInstanceState('collapsedElementIds', this.elementIndex.instanceState.collapsedElementIds);\n\n                    // Add a temporary row\n                    var $spinnerRow = this._createSpinnerRowAfter($row);\n\n                    // Load the nested elements\n                    var params = $.extend(true, {}, this.settings.params);\n                    params.criteria.descendantOf = id;\n\n                    Craft.postActionRequest('element-indexes/get-more-elements', params, $.proxy(function(response, textStatus) {\n                        // Do we even care about this anymore?\n                        if (!$spinnerRow.parent().length) {\n                            return;\n                        }\n\n                        if (textStatus === 'success') {\n                            var $newElements = $(response.html);\n\n                            // Are there more descendants we didn't get in this batch?\n                            var totalVisible = (this._totalVisible + $newElements.length),\n                                morePending = (this.settings.batchSize && $newElements.length === this.settings.batchSize);\n\n                            if (morePending) {\n                                // Remove all the elements after it\n                                var $nextRows = $spinnerRow.nextAll();\n\n                                if (this.elementSelect) {\n                                    this.elementSelect.removeItems($nextRows);\n                                }\n\n                                if (this.structureTableSort) {\n                                    this.structureTableSort.removeItems($nextRows);\n                                }\n\n                                $nextRows.remove();\n                                totalVisible -= $nextRows.length;\n                            }\n                            else {\n                                // Maintain the current 'more' status\n                                morePending = this._morePending;\n                            }\n\n                            $spinnerRow.replaceWith($newElements);\n                            this.thumbLoader.load($newElements);\n\n                            if (this.elementIndex.actions || this.settings.selectable) {\n                                this.elementSelect.addItems($newElements.filter(':not(.disabled)'));\n                                this.elementIndex.updateActionTriggers();\n                            }\n\n                            if (this.structureTableSort) {\n                                this.structureTableSort.addItems($newElements);\n                            }\n\n                            Craft.appendHeadHtml(response.headHtml);\n                            Craft.appendFootHtml(response.footHtml);\n                            Craft.cp.updateResponsiveTables();\n\n                            this.setTotalVisible(totalVisible);\n                            this.setMorePending(morePending);\n\n                            // Is there room to load more right now?\n                            this.maybeLoadMore();\n                        }\n\n                    }, this));\n                }\n            }\n        },\n\n        _createSpinnerRowAfter: function($row) {\n            return $(\n                '<tr data-spinnerrow>' +\n                '<td class=\"centeralign\" colspan=\"' + $row.children().length + '\">' +\n                '<div class=\"spinner\"/>' +\n                '</td>' +\n                '</tr>'\n            ).insertAfter($row);\n        },\n\n        _isStructureTableDraggingLastElements: function() {\n            return (\n                this.structureTableSort &&\n                this.structureTableSort.dragging &&\n                this.structureTableSort.draggingLastElements\n            );\n        },\n\n        _handleSelectedSortHeaderClick: function(ev) {\n            var $header = $(ev.currentTarget);\n\n            if ($header.hasClass('loading')) {\n                return;\n            }\n\n            // Reverse the sort direction\n            var selectedSortDir = this.elementIndex.getSelectedSortDirection(),\n                newSortDir = (selectedSortDir === 'asc' ? 'desc' : 'asc');\n\n            this.elementIndex.setSortDirection(newSortDir);\n            this._handleSortHeaderClick(ev, $header);\n        },\n\n        _handleUnselectedSortHeaderClick: function(ev) {\n            var $header = $(ev.currentTarget);\n\n            if ($header.hasClass('loading')) {\n                return;\n            }\n\n            var attr = $header.attr('data-attribute');\n\n            this.elementIndex.setSortAttribute(attr);\n            this._handleSortHeaderClick(ev, $header);\n        },\n\n        _handleSortHeaderClick: function(ev, $header) {\n            if (this.$selectedSortHeader) {\n                this.$selectedSortHeader.removeClass('ordered asc desc');\n            }\n\n            $header.removeClass('orderable').addClass('ordered loading');\n            this.elementIndex.storeSortAttributeAndDirection();\n            this.elementIndex.updateElements();\n\n            // No need for two spinners\n            this.elementIndex.setIndexAvailable();\n        },\n\n        _updateTableAttributes: function($element, tableAttributes) {\n            var $tr = $element.closest('tr');\n\n            for (var attr in tableAttributes) {\n                if (!tableAttributes.hasOwnProperty(attr)) {\n                    continue;\n                }\n\n                $tr.children('td[data-attr=\"' + attr + '\"]:first').html(tableAttributes[attr]);\n            }\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Tag select input\n */\nCraft.TagSelectInput = Craft.BaseElementSelectInput.extend(\n    {\n        searchTimeout: null,\n        searchMenu: null,\n\n        $container: null,\n        $elementsContainer: null,\n        $elements: null,\n        $addTagInput: null,\n        $spinner: null,\n\n        _ignoreBlur: false,\n\n        init: function(settings) {\n            // Normalize the settings\n            // ---------------------------------------------------------------------\n\n            // Are they still passing in a bunch of arguments?\n            if (!$.isPlainObject(settings)) {\n                // Loop through all of the old arguments and apply them to the settings\n                var normalizedSettings = {},\n                    args = ['id', 'name', 'tagGroupId', 'sourceElementId'];\n\n                for (var i = 0; i < args.length; i++) {\n                    if (typeof arguments[i] !== 'undefined') {\n                        normalizedSettings[args[i]] = arguments[i];\n                    }\n                    else {\n                        break;\n                    }\n                }\n\n                settings = normalizedSettings;\n            }\n\n            this.base($.extend({}, Craft.TagSelectInput.defaults, settings));\n\n            this.$addTagInput = this.$container.children('.add').children('.text');\n            this.$spinner = this.$addTagInput.next();\n\n            this.addListener(this.$addTagInput, 'textchange', $.proxy(function() {\n                if (this.searchTimeout) {\n                    clearTimeout(this.searchTimeout);\n                }\n\n                this.searchTimeout = setTimeout($.proxy(this, 'searchForTags'), 500);\n            }, this));\n\n            this.addListener(this.$addTagInput, 'keypress', function(ev) {\n                if (ev.keyCode === Garnish.RETURN_KEY) {\n                    ev.preventDefault();\n\n                    if (this.searchMenu) {\n                        this.selectTag(this.searchMenu.$options[0]);\n                    }\n                }\n            });\n\n            this.addListener(this.$addTagInput, 'focus', function() {\n                if (this.searchMenu) {\n                    this.searchMenu.show();\n                }\n            });\n\n            this.addListener(this.$addTagInput, 'blur', function() {\n                if (this._ignoreBlur) {\n                    this._ignoreBlur = false;\n                    return;\n                }\n\n                setTimeout($.proxy(function() {\n                    if (this.searchMenu) {\n                        this.searchMenu.hide();\n                    }\n                }, this), 1);\n            });\n        },\n\n        // No \"add\" button\n        getAddElementsBtn: $.noop,\n\n        getElementSortAxis: function() {\n            return null;\n        },\n\n        searchForTags: function() {\n            if (this.searchMenu) {\n                this.killSearchMenu();\n            }\n\n            var val = this.$addTagInput.val();\n\n            if (val) {\n                this.$spinner.removeClass('hidden');\n\n                var excludeIds = [];\n\n                for (var i = 0; i < this.$elements.length; i++) {\n                    var id = $(this.$elements[i]).data('id');\n\n                    if (id) {\n                        excludeIds.push(id);\n                    }\n                }\n\n                if (this.settings.sourceElementId) {\n                    excludeIds.push(this.settings.sourceElementId);\n                }\n\n                var data = {\n                    search: this.$addTagInput.val(),\n                    tagGroupId: this.settings.tagGroupId,\n                    excludeIds: excludeIds\n                };\n\n                Craft.postActionRequest('tags/search-for-tags', data, $.proxy(function(response, textStatus) {\n                    // Just in case\n                    if (this.searchMenu) {\n                        this.killSearchMenu();\n                    }\n\n                    this.$spinner.addClass('hidden');\n\n                    if (textStatus === 'success') {\n                        var $menu = $('<div class=\"menu tagmenu\"/>').appendTo(Garnish.$bod),\n                            $ul = $('<ul/>').appendTo($menu);\n\n                        var $li;\n\n                        for (var i = 0; i < response.tags.length; i++) {\n                            $li = $('<li/>')\n                                .appendTo($ul);\n\n                            $('<a data-icon=\"tag\"/>')\n                                .appendTo($li)\n                                .text(response.tags[i].title)\n                                .data('id', response.tags[i].id)\n                                .addClass(response.tags[i].exclude ? 'disabled' : '');\n                        }\n\n                        if (!response.exactMatch) {\n                            $li = $('<li/>').appendTo($ul);\n                            $('<a data-icon=\"plus\"/>').appendTo($li).text(data.search);\n                        }\n\n                        $ul.find('a:not(.disabled):first').addClass('hover');\n\n                        this.searchMenu = new Garnish.Menu($menu, {\n                            attachToElement: this.$addTagInput,\n                            onOptionSelect: $.proxy(this, 'selectTag')\n                        });\n\n                        this.addListener($menu, 'mousedown', $.proxy(function() {\n                            this._ignoreBlur = true;\n                        }, this));\n\n                        this.searchMenu.show();\n                    }\n\n                }, this));\n            }\n            else {\n                this.$spinner.addClass('hidden');\n            }\n        },\n\n        selectTag: function(option) {\n            var $option = $(option);\n\n            if ($option.hasClass('disabled')) {\n                return;\n            }\n\n            var id = $option.data('id');\n            var title = $option.text();\n\n            var $element = $('<div/>', {\n                'class': 'element small removable',\n                'data-id': id,\n                'data-site-id': this.settings.targetSiteId,\n                'data-label': title,\n                'data-editable': '1'\n            }).appendTo(this.$elementsContainer);\n\n            var $input = $('<input/>', {\n                'type': 'hidden',\n                'name': this.settings.name + '[]',\n                'value': id\n            }).appendTo($element);\n\n            $('<a/>', {\n                'class': 'delete icon',\n                'title': Craft.t('app', 'Remove')\n            }).appendTo($element);\n\n            var $titleContainer = $('<div/>', {\n                'class': 'label'\n            }).appendTo($element);\n\n            $('<span/>', {\n                'class': 'title',\n                text: title\n            }).appendTo($titleContainer);\n\n            var margin = -($element.outerWidth() + 10);\n            this.$addTagInput.css('margin-' + Craft.left, margin + 'px');\n\n            var animateCss = {};\n            animateCss['margin-' + Craft.left] = 0;\n            this.$addTagInput.velocity(animateCss, 'fast');\n\n            this.$elements = this.$elements.add($element);\n\n            this.addElements($element);\n\n            this.killSearchMenu();\n            this.$addTagInput.val('');\n            this.$addTagInput.trigger('focus');\n\n            if (!id) {\n                // We need to create the tag first\n                $element.addClass('loading disabled');\n\n                var data = {\n                    groupId: this.settings.tagGroupId,\n                    title: title\n                };\n\n                Craft.postActionRequest('tags/create-tag', data, $.proxy(function(response, textStatus) {\n                    if (textStatus === 'success' && response.success) {\n                        $element.attr('data-id', response.id);\n                        $input.val(response.id);\n\n                        $element.removeClass('loading disabled');\n                    }\n                    else {\n                        this.removeElement($element);\n\n                        if (textStatus === 'success') {\n                            // Some sort of validation error that still resulted in  a 200 response. Shouldn't be possible though.\n                            Craft.cp.displayError(Craft.t('app', 'An unknown error occurred.'));\n                        }\n                    }\n                }, this));\n            }\n        },\n\n        killSearchMenu: function() {\n            this.searchMenu.hide();\n            this.searchMenu.destroy();\n            this.searchMenu = null;\n        }\n    },\n    {\n        defaults: {\n            tagGroupId: null\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Thumb Element Index View\n */\nCraft.ThumbsElementIndexView = Craft.BaseElementIndexView.extend(\n    {\n        getElementContainer: function() {\n            return this.$container.children('ul');\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\nCraft.ui =\n    {\n        createTextInput: function(config) {\n            var $input = $('<input/>', {\n                attr: {\n                    'class': 'text',\n                    type: (config.type || 'text'),\n                    id: config.id,\n                    size: config.size,\n                    name: config.name,\n                    value: config.value,\n                    maxlength: config.maxlength,\n                    autofocus: this.getAutofocusValue(config.autofocus),\n                    autocomplete: (typeof config.autocomplete === 'undefined' || !config.autocomplete ? 'off' : null),\n                    disabled: this.getDisabledValue(config.disabled),\n                    readonly: config.readonly,\n                    title: config.title,\n                    placeholder: config.placeholder,\n                    step: config.step,\n                    min: config.min,\n                    max: config.max\n                }\n            });\n\n            if (config.class) {\n                $input.addClass(config.class);\n            }\n            if (config.placeholder) {\n                $input.addClass('nicetext');\n            }\n            if (config.type === 'password') {\n                $input.addClass('password');\n            }\n            if (config.disabled) {\n                $input.addClass('disabled');\n            }\n            if (!config.size) {\n                $input.addClass('fullwidth');\n            }\n\n            if (config.showCharsLeft && config.maxlength) {\n                $input\n                    .attr('data-show-chars-left')\n                    .css('padding-' + (Craft.orientation === 'ltr' ? 'right' : 'left'), (7.2 * config.maxlength.toString().length + 14) + 'px');\n            }\n\n            if (config.placeholder || config.showCharsLeft) {\n                new Garnish.NiceText($input);\n            }\n\n            if (config.type === 'password') {\n                return $('<div class=\"passwordwrapper\"/>').append($input);\n            }\n            else {\n                return $input;\n            }\n        },\n\n        createTextField: function(config) {\n            return this.createField(this.createTextInput(config), config);\n        },\n\n        createTextarea: function(config) {\n            var $textarea = $('<textarea/>', {\n                'class': 'text',\n                'rows': config.rows || 2,\n                'cols': config.cols || 50,\n                'id': config.id,\n                'name': config.name,\n                'maxlength': config.maxlength,\n                'autofocus': config.autofocus && !Garnish.isMobileBrowser(true),\n                'disabled': !!config.disabled,\n                'placeholder': config.placeholder,\n                'html': config.value\n            });\n\n            if (config.showCharsLeft) {\n                $textarea.attr('data-show-chars-left', '');\n            }\n\n            if (config.class) {\n                $textarea.addClass(config.class);\n            }\n\n            if (!config.size) {\n                $textarea.addClass('fullwidth');\n            }\n\n            return $textarea;\n        },\n\n        createTextareaField: function(config) {\n            return this.createField(this.createTextarea(config), config);\n        },\n\n        createSelect: function(config) {\n            var $container = $('<div/>', {\n                'class': 'select'\n            });\n\n            if (config.class) {\n                $container.addClass(config.class);\n            }\n\n            var $select = $('<select/>', {\n                'id': config.id,\n                'name': config.name,\n                'autofocus': config.autofocus && Garnish.isMobileBrowser(true),\n                'disabled': config.disabled,\n                'data-target-prefix': config.targetPrefix\n            }).appendTo($container);\n\n            var $optgroup = null;\n\n            for (var key in config.options) {\n                if (!config.options.hasOwnProperty(key)) {\n                    continue;\n                }\n\n                var option = config.options[key];\n\n                // Starting a new <optgroup>?\n                if (typeof option.optgroup !== 'undefined') {\n                    $optgroup = $('<optgroup/>', {\n                        'label': option.label\n                    }).appendTo($select);\n                } else {\n                    var optionLabel = (typeof option.label !== 'undefined' ? option.label : option),\n                        optionValue = (typeof option.value !== 'undefined' ? option.value : key),\n                        optionDisabled = (typeof option.disabled !== 'undefined' ? option.disabled : false);\n\n                    $('<option/>', {\n                        'value': optionValue,\n                        'selected': (optionValue == config.value),\n                        'disabled': optionDisabled,\n                        'html': optionLabel\n                    }).appendTo($optgroup || $select);\n                }\n            }\n\n            if (config.toggle) {\n                $select.addClass('fieldtoggle');\n                new Craft.FieldToggle($select);\n            }\n\n            return $container;\n        },\n\n        createSelectField: function(config) {\n            return this.createField(this.createSelect(config), config);\n        },\n\n        createCheckbox: function(config) {\n            var id = (config.id || 'checkbox' + Math.floor(Math.random() * 1000000000));\n\n            var $input = $('<input/>', {\n                type: 'checkbox',\n                value: (typeof config.value !== 'undefined' ? config.value : '1'),\n                id: id,\n                'class': 'checkbox',\n                name: config.name,\n                checked: (config.checked ? 'checked' : null),\n                autofocus: this.getAutofocusValue(config.autofocus),\n                disabled: this.getDisabledValue(config.disabled),\n                'data-target': config.toggle,\n                'data-reverse-target': config.reverseToggle\n            });\n\n            if (config.class) {\n                $input.addClass(config.class);\n            }\n\n            if (config.toggle || config.reverseToggle) {\n                $input.addClass('fieldtoggle');\n                new Craft.FieldToggle($input);\n            }\n\n            var $label = $('<label/>', {\n                'for': id,\n                text: config.label\n            });\n\n            // Should we include a hidden input first?\n            if (config.name && (config.name.length < 3 || config.name.substr(-2) !== '[]')) {\n                return $([\n                    $('<input/>', {\n                        type: 'hidden',\n                        name: config.name,\n                        value: ''\n                    })[0],\n                    $input[0],\n                    $label[0]\n                ]);\n            }\n            else {\n                return $([\n                    $input[0],\n                    $label[0]\n                ]);\n            }\n        },\n\n        createCheckboxField: function(config) {\n            var $field = $('<div class=\"field checkboxfield\"/>', {\n                id: (config.id ? config.id + '-field' : null)\n            });\n\n            if (config.first) {\n                $field.addClass('first');\n            }\n            if (config.instructions) {\n                $field.addClass('has-instructions');\n            }\n\n            this.createCheckbox(config).appendTo($field);\n\n            if (config.instructions) {\n                $('<div class=\"instructions\"/>').text(config.instructions).appendTo($field);\n            }\n\n            return $field;\n        },\n\n        createCheckboxSelect: function(config) {\n            var $container = $('<div class=\"checkbox-select\"/>');\n\n            if (config.class) {\n                $container.addClass(config.class);\n            }\n\n            var allValue, allChecked;\n\n            if (config.showAllOption) {\n                allValue = (config.allValue || '*');\n                allChecked = (config.values == allValue);\n\n                // Create the \"All\" checkbox\n                $('<div/>').appendTo($container).append(\n                    this.createCheckbox({\n                        id: config.id,\n                        'class': 'all',\n                        label: '<b>' + (config.allLabel || Craft.t('app', 'All')) + '</b>',\n                        name: config.name,\n                        value: allValue,\n                        checked: allChecked,\n                        autofocus: config.autofocus\n                    })\n                );\n            } else {\n                allChecked = false;\n            }\n\n            // Create the actual options\n            for (var i = 0; i < config.options.length; i++) {\n                var option = config.options[i];\n\n                if (option.value == allValue) {\n                    continue;\n                }\n\n                $('<div/>').appendTo($container).append(\n                    this.createCheckbox({\n                        label: option.label,\n                        name: (config.name ? config.name + '[]' : null),\n                        value: option.value,\n                        checked: (allChecked || Craft.inArray(option.value, config.values)),\n                        disabled: allChecked\n                    })\n                );\n            }\n\n            new Garnish.CheckboxSelect($container);\n\n            return $container;\n        },\n\n        createCheckboxSelectField: function(config) {\n            return this.createField(this.createCheckboxSelect(config), config);\n        },\n\n        createLightswitch: function(config) {\n            var value = config.value || '1';\n\n            var $container = $('<div/>', {\n                'class': 'lightswitch',\n                tabindex: '0',\n                'data-value': value,\n                id: config.id,\n                'aria-labelledby': config.labelId,\n                'data-target': config.toggle,\n                'data-reverse-target': config.reverseToggle\n            });\n\n            if (config.on) {\n                $container.addClass('on');\n            }\n\n            if (config.small) {\n                $container.addClass('small');\n            }\n\n            if (config.disabled) {\n                $container.addClass('disabled');\n            }\n\n            $(\n                '<div class=\"lightswitch-container\">' +\n                '<div class=\"label on\"></div>' +\n                '<div class=\"handle\"></div>' +\n                '<div class=\"label off\"></div>' +\n                '</div>'\n            ).appendTo($container);\n\n            if (config.name) {\n                $('<input/>', {\n                    type: 'hidden',\n                    name: config.name,\n                    value: (config.on ? value : ''),\n                    disabled: config.disabled\n                }).appendTo($container);\n            }\n\n            if (config.toggle || config.reverseToggle) {\n                $container.addClass('fieldtoggle');\n                new Craft.FieldToggle($container);\n            }\n\n            return $container.lightswitch();\n        },\n\n        createLightswitchField: function(config) {\n            return this.createField(this.createLightswitch(config), config);\n        },\n\n        createColorInput: function(config) {\n            var id = (config.id || 'color' + Math.floor(Math.random() * 1000000000));\n            var containerId = config.containerId || id + '-container';\n            var name = config.name || null;\n            var value = config.value || null;\n            var small = config.small || false;\n            var autofocus = config.autofocus && Garnish.isMobileBrowser(true);\n            var disabled = config.disabled || false;\n\n            var $container = $('<div/>', {\n                id: containerId,\n                'class': 'flex color-container'\n            });\n\n            var $colorPreviewContainer = $('<div/>', {\n                'class': 'color static' + (small ? ' small' : '')\n            }).appendTo($container);\n\n            var $colorPreview = $('<div/>', {\n                'class': 'color-preview',\n                style: config.value ? {backgroundColor: config.value} : null\n            }).appendTo($colorPreviewContainer);\n\n            var $input = this.createTextInput({\n                id: id,\n                name: name,\n                value: value,\n                size: 10,\n                'class': 'color-input',\n                autofocus: autofocus,\n                disabled: disabled\n            }).appendTo($container);\n\n            new Craft.ColorInput($container);\n            return $container;\n        },\n\n        createColorField: function(config) {\n            return this.createField(this.createColorInput(config), config);\n        },\n\n        createDateInput: function(config) {\n            var id = (config.id || 'date' + Math.floor(Math.random() * 1000000000))+'-date';\n            var name = config.name || null;\n            var inputName = name ? name+'[date]' : null;\n            var value = config.value && typeof config.value.getMonth === 'function' ? config.value : null;\n            var formattedValue = value ? Craft.formatDate(value) : null;\n            var autofocus = config.autofocus && Garnish.isMobileBrowser(true);\n            var disabled = config.disabled || false;\n\n            var $container = $('<div/>', {\n                'class': 'datewrapper'\n            });\n\n            var $input = this.createTextInput({\n                id: id,\n                name: inputName,\n                value: formattedValue,\n                placeholder: ' ',\n                autocomplete: false,\n                autofocus: autofocus,\n                disabled: disabled\n            }).appendTo($container);\n\n            $('<div data-icon=\"date\"></div>').appendTo($container);\n\n            if (name) {\n                $('<input/>', {\n                    type: 'hidden',\n                    name: name+'[timezone]',\n                    val: Craft.timezone\n                }).appendTo($container);\n            }\n\n            $input.datepicker($.extend({\n                defaultDate: value || new Date()\n            }, Craft.datepickerOptions));\n\n            return $container;\n        },\n\n        createDateField: function(config) {\n            return this.createField(this.createDateInput(config), config);\n        },\n\n        createTimeInput: function(config) {\n            var id = (config.id || 'time' + Math.floor(Math.random() * 1000000000))+'-time';\n            var name = config.name || null;\n            var inputName = name ? name+'[time]' : null;\n            var value = config.value && typeof config.value.getMonth === 'function' ? config.value : null;\n            var autofocus = config.autofocus && Garnish.isMobileBrowser(true);\n            var disabled = config.disabled || false;\n\n            var $container = $('<div/>', {\n                'class': 'timewrapper'\n            });\n\n            var $input = this.createTextInput({\n                id: id,\n                name: inputName,\n                placeholder: ' ',\n                autocomplete: false,\n                autofocus: autofocus,\n                disabled: disabled\n            }).appendTo($container);\n\n            $('<div data-icon=\"time\"></div>').appendTo($container);\n\n            if (name) {\n                $('<input/>', {\n                    type: 'hidden',\n                    name: name+'[timezone]',\n                    val: Craft.timezone\n                }).appendTo($container);\n            }\n\n            $input.timepicker(Craft.timepickerOptions);\n            if (value) {\n                $input.timepicker('setTime', value.getHours()*3600 + value.getMinutes()*60 + value.getSeconds());\n            }\n\n            return $container;\n        },\n\n        createTimeField: function(config) {\n            return this.createField(this.createTimeInput(config), config);\n        },\n\n        createField: function(input, config) {\n            var label = (config.label && config.label !== '__blank__' ? config.label : null),\n                siteId = (Craft.isMultiSite && config.siteId ? config.siteId : null);\n\n            var $field = $('<div/>', {\n                'class': 'field',\n                'id': config.fieldId || (config.id ? config.id + '-field' : null)\n            });\n\n            if (config.first) {\n                $field.addClass('first');\n            }\n\n            if (label || config.instructions) {\n                var $heading = $('<div class=\"heading\"/>').appendTo($field);\n\n                if (label) {\n                    var $label = $('<label/>', {\n                        'id': config.labelId || (config.id ? config.id + '-label' : null),\n                        'class': (config.required ? 'required' : null),\n                        'for': config.id,\n                        text: label\n                    }).appendTo($heading);\n\n                    if (siteId) {\n                        for (var i = 0; i < Craft.sites.length; i++) {\n                            if (Craft.sites[i].id == siteId) {\n                                $('<span class=\"site\"/>').text(Craft.sites[i].name).appendTo($label);\n                                break;\n                            }\n                        }\n                    }\n                }\n\n                if (config.instructions) {\n                    $('<div class=\"instructions\"/>').text(config.instructions).appendTo($heading);\n                }\n            }\n\n            $('<div class=\"input\"/>').append(input).appendTo($field);\n\n            if (config.warning) {\n                $('<p class=\"warning\"/>').text(config.warning).appendTo($field);\n            }\n\n            if (config.errors) {\n                this.addErrorsToField($field, config.errors);\n            }\n\n            return $field;\n        },\n\n        createErrorList: function(errors) {\n            var $list = $('<ul class=\"errors\"/>');\n\n            if (errors) {\n                this.addErrorsToList($list, errors);\n            }\n\n            return $list;\n        },\n\n        addErrorsToList: function($list, errors) {\n            for (var i = 0; i < errors.length; i++) {\n                $('<li/>').text(errors[i]).appendTo($list);\n            }\n        },\n\n        addErrorsToField: function($field, errors) {\n            if (!errors) {\n                return;\n            }\n\n            $field.addClass('has-errors');\n            $field.children('.input').addClass('errors');\n\n            var $errors = $field.children('ul.errors');\n\n            if (!$errors.length) {\n                $errors = this.createErrorList().appendTo($field);\n            }\n\n            this.addErrorsToList($errors, errors);\n        },\n\n        clearErrorsFromField: function($field) {\n            $field.removeClass('has-errors');\n            $field.children('.input').removeClass('errors');\n            $field.children('ul.errors').remove();\n        },\n\n        getAutofocusValue: function(autofocus) {\n            return (autofocus && !Garnish.isMobileBrowser(true) ? 'autofocus' : null);\n        },\n\n        getDisabledValue: function(disabled) {\n            return (disabled ? 'disabled' : null);\n        }\n    };\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * File Manager.\n */\nCraft.Uploader = Garnish.Base.extend(\n    {\n        uploader: null,\n        allowedKinds: null,\n        $element: null,\n        settings: null,\n        _rejectedFiles: {},\n        _extensionList: null,\n        _totalFileCounter: 0,\n        _validFileCounter: 0,\n\n        init: function($element, settings) {\n            this._rejectedFiles = {\"size\": [], \"type\": [], \"limit\": []};\n            this.$element = $element;\n            this.allowedKinds = null;\n            this._extensionList = null;\n            this._totalFileCounter = 0;\n            this._validFileCounter = 0;\n\n            settings = $.extend({}, Craft.Uploader.defaults, settings);\n\n            var events = settings.events;\n            delete settings.events;\n\n            if (settings.allowedKinds && settings.allowedKinds.length) {\n                if (typeof settings.allowedKinds === 'string') {\n                    settings.allowedKinds = [settings.allowedKinds];\n                }\n\n                this.allowedKinds = settings.allowedKinds;\n                delete settings.allowedKinds;\n            }\n\n            settings.autoUpload = false;\n\n            this.uploader = this.$element.fileupload(settings);\n            for (var event in events) {\n                if (!events.hasOwnProperty(event)) {\n                    continue;\n                }\n\n                this.uploader.on(event, events[event]);\n            }\n\n            this.settings = settings;\n\n            this.uploader.on('fileuploadadd', $.proxy(this, 'onFileAdd'));\n        },\n\n        /**\n         * Set uploader parameters.\n         */\n        setParams: function(paramObject) {\n            // If CSRF protection isn't enabled, these won't be defined.\n            if (typeof Craft.csrfTokenName !== 'undefined' && typeof Craft.csrfTokenValue !== 'undefined') {\n                // Add the CSRF token\n                paramObject[Craft.csrfTokenName] = Craft.csrfTokenValue;\n            }\n\n            this.uploader.fileupload('option', {formData: paramObject});\n        },\n\n        /**\n         * Get the number of uploads in progress.\n         */\n        getInProgress: function() {\n            return this.uploader.fileupload('active');\n        },\n\n        /**\n         * Return true, if this is the last upload.\n         */\n        isLastUpload: function() {\n            // Processing the last file or not processing at all.\n            return this.getInProgress() < 2;\n        },\n\n        /**\n         * Called on file add.\n         */\n        onFileAdd: function(e, data) {\n            e.stopPropagation();\n\n            var validateExtension = false;\n\n            if (this.allowedKinds) {\n                if (!this._extensionList) {\n                    this._createExtensionList();\n                }\n\n                validateExtension = true;\n            }\n\n            // Make sure that file API is there before relying on it\n            data.process().done($.proxy(function() {\n                var file = data.files[0];\n                var pass = true;\n                if (validateExtension) {\n\n                    var matches = file.name.match(/\\.([a-z0-4_]+)$/i);\n                    var fileExtension = matches[1];\n                    if ($.inArray(fileExtension.toLowerCase(), this._extensionList) === -1) {\n                        pass = false;\n                        this._rejectedFiles.type.push('\u201c' + file.name + '\u201d');\n                    }\n                }\n\n                if (file.size > this.settings.maxFileSize) {\n                    this._rejectedFiles.size.push('\u201c' + file.name + '\u201d');\n                    pass = false;\n                }\n\n                // If the validation has passed for this file up to now, check if we're not hitting any limits\n                if (pass && typeof this.settings.canAddMoreFiles === 'function' && !this.settings.canAddMoreFiles(this._validFileCounter)) {\n                    this._rejectedFiles.limit.push('\u201c' + file.name + '\u201d');\n                    pass = false;\n                }\n\n                if (pass) {\n                    this._validFileCounter++;\n                    data.submit();\n                }\n\n                if (++this._totalFileCounter === data.originalFiles.length) {\n                    this._totalFileCounter = 0;\n                    this._validFileCounter = 0;\n                    this.processErrorMessages();\n                }\n\n            }, this));\n\n            return true;\n        },\n\n        /**\n         * Process error messages.\n         */\n        processErrorMessages: function() {\n            var str;\n\n            if (this._rejectedFiles.type.length) {\n                if (this._rejectedFiles.type.length === 1) {\n                    str = \"The file {files} could not be uploaded. The allowed file kinds are: {kinds}.\";\n                }\n                else {\n                    str = \"The files {files} could not be uploaded. The allowed file kinds are: {kinds}.\";\n                }\n\n                str = Craft.t('app', str, {files: this._rejectedFiles.type.join(\", \"), kinds: this.allowedKinds.join(\", \")});\n                this._rejectedFiles.type = [];\n                alert(str);\n            }\n\n            if (this._rejectedFiles.size.length) {\n                if (this._rejectedFiles.size.length === 1) {\n                    str = \"The file {files} could not be uploaded, because it exceeds the maximum upload size of {size}.\";\n                }\n                else {\n                    str = \"The files {files} could not be uploaded, because they exceeded the maximum upload size of {size}.\";\n                }\n\n                str = Craft.t('app', str, {files: this._rejectedFiles.size.join(\", \"), size: this.humanFileSize(Craft.maxUploadSize)});\n                this._rejectedFiles.size = [];\n                alert(str);\n            }\n\n            if (this._rejectedFiles.limit.length) {\n                if (this._rejectedFiles.limit.length === 1) {\n                    str = \"The file {files} could not be uploaded, because the field limit has been reached.\";\n                }\n                else {\n                    str = \"The files {files} could not be uploaded, because the field limit has been reached.\";\n                }\n\n                str = Craft.t('app', str, {files: this._rejectedFiles.limit.join(\", \")});\n                this._rejectedFiles.limit = [];\n                alert(str);\n            }\n        },\n\n        humanFileSize: function(bytes) {\n            var threshold = 1024;\n\n            if (bytes < threshold) {\n                return bytes + ' B';\n            }\n\n            var units = ['kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];\n\n            var u = -1;\n\n            do\n            {\n                bytes = bytes / threshold;\n                ++u;\n            }\n            while (bytes >= threshold);\n\n            return bytes.toFixed(1) + ' ' + units[u];\n        },\n\n        _createExtensionList: function() {\n            this._extensionList = [];\n\n            for (var i = 0; i < this.allowedKinds.length; i++) {\n                var allowedKind = this.allowedKinds[i];\n\n                if (typeof Craft.fileKinds[allowedKind] !== 'undefined') {\n                    for (var j = 0; j < Craft.fileKinds[allowedKind].extensions.length; j++) {\n                        var ext = Craft.fileKinds[allowedKind].extensions[j];\n                        this._extensionList.push(ext);\n                    }\n                }\n            }\n        },\n\n        destroy: function() {\n            this.$element.fileupload('destroy');\n            this.base();\n        }\n    },\n\n// Static Properties\n// =============================================================================\n\n    {\n        defaults: {\n            dropZone: null,\n            pasteZone: null,\n            fileInput: null,\n            sequentialUploads: true,\n            maxFileSize: Craft.maxUploadSize,\n            allowedKinds: null,\n            events: {},\n            canAddMoreFiles: null,\n            headers: {'Accept' : 'application/json;q=0.9,*/*;q=0.8'},\n            paramName: 'assets-upload'\n        }\n    });\n\n/** global: Craft */\n/** global: Garnish */\n/**\n * Handle Generator\n */\nCraft.UriFormatGenerator = Craft.BaseInputGenerator.extend(\n    {\n        generateTargetValue: function(sourceVal) {\n            // Remove HTML tags\n            sourceVal = sourceVal.replace(\"/<(.*?)>/g\", '');\n\n            // Make it lowercase\n            sourceVal = sourceVal.toLowerCase();\n\n            // Convert extended ASCII characters to basic ASCII\n            sourceVal = Craft.asciiString(sourceVal);\n\n            // Handle must start with a letter and end with a letter/number\n            sourceVal = sourceVal.replace(/^[^a-z]+/, '');\n            sourceVal = sourceVal.replace(/[^a-z0-9]+$/, '');\n\n            // Get the \"words\"\n            var words = Craft.filterArray(sourceVal.split(/[^a-z0-9]+/));\n\n            var uriFormat = words.join('-');\n\n            if (uriFormat && this.settings.suffix) {\n                uriFormat += this.settings.suffix;\n            }\n\n            return uriFormat;\n        }\n    });\n\n})(jQuery);\n", "!function($){$.extend(Craft,{navHeight:48,t:function(t,e,i){if(void 0!==Craft.translations[t]&&void 0!==Craft.translations[t][e]&&(e=Craft.translations[t][e]),i)for(var s in i)i.hasOwnProperty(s)&&(e=e.replace(\"{\"+s+\"}\",i[s]));return e},formatDate:function(t){return\"object\"!=typeof t&&(t=new Date(t)),$.datepicker.formatDate(Craft.datepickerOptions.dateFormat,t)},formatNumber:function(t,e){return void 0===e&&(e=\",.0f\"),d3.formatLocale(d3FormatLocaleDefinition).format(e)(t)},escapeHtml:function(t){return $(\"<div/>\").text(t).html()},escapeRegex:function(t){return t.replace(/[-[\\]{}()*+?.,\\\\^$|#\\s]/g,\"\\\\$&\")},getText:function(t){return $(\"<div/>\").html(t).text()},encodeUriComponent:function(t){t=encodeURIComponent(t);var e={\"!\":\"%21\",\"*\":\"%2A\",\"'\":\"%27\",\"(\":\"%28\",\")\":\"%29\"};for(var i in e){var s=new RegExp(\"\\\\\"+i,\"g\");t=t.replace(s,e[i])}return t},selectFullValue:function(t){var e=$(t),i=e.val();if(void 0!==e[0].setSelectionRange){var s=2*i.length;e[0].setSelectionRange(0,s)}else e.val(i)},formatInputId:function(t){return this.rtrim(t.replace(/[\\[\\]\\\\]+/g,\"-\"),\"-\")},getUrl:function(t,e,i){\"string\"!=typeof t&&(t=\"\");var s=\"\";if($.isPlainObject(e)){var n=[];for(var a in e)if(e.hasOwnProperty(a)){var r=e[a];\"#\"===a?s=r:null!==r&&\"\"!==r&&n.push(a+\"=\"+r)}e=n}e=Garnish.isArray(e)?e.join(\"&\"):Craft.trim(e,\"&?\");var o,l=t.indexOf(\"?\");if(-1!==l&&(e=t.substr(l+1)+(e?\"&\"+e:\"\"),t=t.substr(0,l)),-1!==t.search(\"://\")||\"/\"===t[0])return t+(e?\"?\"+e:\"\");if(t=Craft.trim(t,\"/\"),i){if(o=i,t){var h=o.match(new RegExp(\"[&?]\"+Craft.escapeRegex(Craft.pathParam)+\"=[^&]+\"));h&&(o=o.replace(h[0],Craft.rtrim(h[0],\"/\")+\"/\"+t),t=\"\")}}else o=Craft.baseUrl;if(-1!==(l=o.indexOf(\"?\"))&&(e=o.substr(l+1)+(e?\"&\"+e:\"\"),o=o.substr(0,l)),!Craft.omitScriptNameInUrls&&t)if(Craft.usePathInfo)-1===o.search(Craft.scriptName)&&(o=Craft.rtrim(o,\"/\")+\"/\"+Craft.scriptName);else{if(e&&e.substr(0,Craft.pathParam.length+1)===Craft.pathParam+\"=\"){var d,c=e.indexOf(\"&\");e=-1!==c?(d=e.substring(2,c),e.substr(c+1)):(d=e.substr(2),null),t=(d=Craft.rtrim(d))+(t?\"/\"+t:\"\")}e=Craft.pathParam+\"=\"+t+(e?\"&\"+e:\"\"),t=null}return t&&(o=Craft.rtrim(o,\"/\")+\"/\"+t),e&&(o+=\"?\"+e),s&&(o+=\"#\"+s),o},getCpUrl:function(t,e){return this.getUrl(t,e,Craft.baseCpUrl)},getSiteUrl:function(t,e){return this.getUrl(t,e,Craft.baseSiteUrl)},getActionUrl:function(t,e){return Craft.getUrl(t,e,Craft.actionUrl)},redirectTo:function(t){document.location.href=this.getUrl(t)},getCsrfInput:function(){return Craft.csrfTokenName?'<input type=\"hidden\" name=\"'+Craft.csrfTokenName+'\" value=\"'+Craft.csrfTokenValue+'\"/>':\"\"},postActionRequest:function(t,e,s,i){\"function\"==typeof e&&(i=s,s=e,e={});var n={\"X-Registered-Asset-Bundles\":Object.keys(Craft.registeredAssetBundles).join(\",\"),\"X-Registered-Js-Files\":Object.keys(Craft.registeredJsFiles).join(\",\")};Craft.csrfTokenValue&&Craft.csrfTokenName&&(n[\"X-CSRF-Token\"]=Craft.csrfTokenValue);var a=$.ajax($.extend({url:Craft.getActionUrl(t),type:\"POST\",dataType:\"json\",headers:n,data:e,success:s,error:function(t,e,i){4===t.readyState&&(void 0!==Craft.cp?Craft.cp.displayError():alert(Craft.t(\"app\",\"An unknown error occurred.\")),s&&s(null,e,t))}},i));return i&&\"function\"==typeof i.send&&i.send(a),a},_waitingOnAjax:!1,_ajaxQueue:[],queueActionRequest:function(t,e,i,s){\"function\"==typeof e&&(s=i,i=e,e=void 0),Craft._ajaxQueue.push([t,e,i,s]),Craft._waitingOnAjax||Craft._postNextActionRequestInQueue()},_postNextActionRequestInQueue:function(){Craft._waitingOnAjax=!0;var s=Craft._ajaxQueue.shift();Craft.postActionRequest(s[0],s[1],function(t,e,i){s[2]&&\"function\"==typeof s[2]&&s[2](t,e,i),Craft._ajaxQueue.length?Craft._postNextActionRequestInQueue():Craft._waitingOnAjax=!1},s[3])},stringToArray:function(t){if(\"string\"!=typeof t)return t;for(var e=t.split(\",\"),i=0;i<e.length;i++)e[i]=$.trim(e[i]);return e},expandPostArray:function(t){var e,i={};for(var s in t)if(t.hasOwnProperty(s)){var n,a=t[s],r=s.match(/^(\\w+)(\\[.*)?/);if(r[2])for(n=r[2].match(/\\[[^\\[\\]]*\\]/g),e=0;e<n.length;e++)n[e]=n[e].substring(1,n[e].length-1);else n=[];n.unshift(r[1]);var o=i;for(e=0;e<n.length;e++)e<n.length-1?(\"object\"!=typeof o[n[e]]&&(n[e+1]&&parseInt(n[e+1])!=n[e+1]?o[n[e]]={}:o[n[e]]=[]),o=o[n[e]]):(n[e]||(n[e]=o.length),o[n[e]]=a)}return i},compare:function(t,e,i){if(typeof t!=typeof e)return!1;if(\"object\"!=typeof t)return t===e;if(t.length!==e.length)return!1;if(t instanceof Array!=e instanceof Array)return!1;if(!(t instanceof Array))if(void 0===i||!0===i){if(!Craft.compare(Craft.getObjectKeys(t).sort(),Craft.getObjectKeys(e).sort()))return!1}else if(!Craft.compare(Craft.getObjectKeys(t),Craft.getObjectKeys(e)))return!1;for(var s in t)if(t.hasOwnProperty(s)&&!Craft.compare(t[s],e[s]))return!1;return!0},getObjectKeys:function(t){var e=[];for(var i in t)t.hasOwnProperty(i)&&e.push(i);return e},escapeChars:function(t){Garnish.isArray(t)||(t=t.split());for(var e=\"\",i=0;i<t.length;i++)e+=\"\\\\\"+t[i];return e},ltrim:function(t,e){if(!t)return t;void 0===e&&(e=\" \\t\\n\\r\\0\\v\");var i=new RegExp(\"^[\"+Craft.escapeChars(e)+\"]+\");return t.replace(i,\"\")},rtrim:function(t,e){if(!t)return t;void 0===e&&(e=\" \\t\\n\\r\\0\\v\");var i=new RegExp(\"[\"+Craft.escapeChars(e)+\"]+$\");return t.replace(i,\"\")},trim:function(t,e){return t=Craft.ltrim(t,e),t=Craft.rtrim(t,e)},startsWith:function(t,e){return t.substr(0,e.length)===e},filterArray:function(t,e){for(var i=[],s=0;s<t.length;s++){(\"function\"==typeof e?e(t[s],s):t[s])&&i.push(t[s])}return i},inArray:function(t,e){return-1!==$.inArray(t,e)},removeFromArray:function(t,e){var i=$.inArray(t,e);return-1!==i&&(e.splice(i,1),!0)},getLast:function(t){return t.length?t[t.length-1]:null},uppercaseFirst:function(t){return t.charAt(0).toUpperCase()+t.slice(1)},lowercaseFirst:function(t){return t.charAt(0).toLowerCase()+t.slice(1)},parseUrl:function(t){var e=t.match(/^(?:(https?):\\/\\/|\\/\\/)([^\\/\\:]*)(?:\\:(\\d+))?(\\/[^\\?]*)?(?:\\?([^#]*))?(#.*)?/);return e?{scheme:e[1],host:e[2]+(e[3]?\":\"+e[3]:\"\"),hostname:e[2],port:e[3]||null,path:e[4]||\"/\",query:e[5]||null,hash:e[6]||null}:{}},isSameHost:function(t){var e=this.parseUrl(document.location.href);if(!e)return!1;var i=this.parseUrl(t);return!!i&&e.host===i.host},secondsToHumanTimeDuration:function(t,e){void 0===e&&(e=!0);var i=Math.floor(t/604800);t%=604800;var s=Math.floor(t/86400);t%=86400;var n,a=Math.floor(t/3600);t%=3600,e?(n=Math.floor(t/60),t%=60):(n=Math.round(t/60),t=0);var r=[];return i&&r.push(i+\" \"+(1===i?Craft.t(\"app\",\"week\"):Craft.t(\"app\",\"weeks\"))),s&&r.push(s+\" \"+(1===s?Craft.t(\"app\",\"day\"):Craft.t(\"app\",\"days\"))),a&&r.push(a+\" \"+(1===a?Craft.t(\"app\",\"hour\"):Craft.t(\"app\",\"hours\"))),!n&&(e||i||s||a)||r.push(n+\" \"+(1===n?Craft.t(\"app\",\"minute\"):Craft.t(\"app\",\"minutes\"))),!t&&(!e||i||s||a||n)||r.push(t+\" \"+(1===t?Craft.t(\"app\",\"second\"):Craft.t(\"app\",\"seconds\"))),r.join(\", \")},asciiString:function(t,e){for(var i,s=\"\",n=0;n<t.length;n++)i=t.charAt(n),s+=(e||Craft.asciiCharMap)[i]||i;return s},randomString:function(t){for(var e=\"\",i=0;i<t;i++)e+=\"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789\".charAt(Math.floor(62*Math.random()));return e},preventOutlineOnMouseFocus:function(t){var e=$(t),i=\".preventOutlineOnMouseFocus\";e.on(\"mousedown\"+i,function(){e.addClass(\"no-outline\"),e.trigger(\"focus\")}).on(\"keydown\"+i+\" blur\"+i,function(t){t.keyCode!==Garnish.SHIFT_KEY&&t.keyCode!==Garnish.CTRL_KEY&&t.keyCode!==Garnish.CMD_KEY&&e.removeClass(\"no-outline\")})},createErrorList:function(t){for(var e=$(document.createElement(\"ul\")).addClass(\"errors\"),i=0;i<t.length;i++){var s=$(document.createElement(\"li\"));s.appendTo(e),s.html(t[i])}return e},appendHeadHtml:function(t){if(t){var e=$(\"link[href]\");if(e.length){for(var i,s=[],n=0;n<e.length;n++)i=e.eq(n).attr(\"href\").replace(/&/g,\"&amp;\"),s.push(Craft.escapeRegex(i));var a=new RegExp('<link\\\\s[^>]*href=\"(?:'+s.join(\"|\")+')\".*?><\\/script>',\"g\");t=t.replace(a,\"\")}$(\"head\").append(t)}},appendFootHtml:function(t){if(t){var e=$(\"script[src]\");if(e.length){for(var i,s=[],n=0;n<e.length;n++)i=e.eq(n).attr(\"src\").replace(/&/g,\"&amp;\"),s.push(Craft.escapeRegex(i));var a=new RegExp('<script\\\\s[^>]*src=\"(?:'+s.join(\"|\")+')\".*?><\\/script>',\"g\");t=t.replace(a,\"\")}Garnish.$bod.append(t)}},initUiElements:function(t){$(\".grid\",t).grid(),$(\".info\",t).infoicon(),$(\".checkbox-select\",t).checkboxselect(),$(\".fieldtoggle\",t).fieldtoggle(),$(\".lightswitch\",t).lightswitch(),$(\".nicetext\",t).nicetext(),$(\".pill\",t).pill(),$(\".formsubmit\",t).formsubmit(),$(\".menubtn\",t).menubtn()},_elementIndexClasses:{},_elementSelectorModalClasses:{},_elementEditorClasses:{},registerElementIndexClass:function(t,e){if(void 0!==this._elementIndexClasses[t])throw\"An element index class has already been registered for the element type \u201c\"+t+\"\u201d.\";this._elementIndexClasses[t]=e},registerElementSelectorModalClass:function(t,e){if(void 0!==this._elementSelectorModalClasses[t])throw\"An element selector modal class has already been registered for the element type \u201c\"+t+\"\u201d.\";this._elementSelectorModalClasses[t]=e},registerElementEditorClass:function(t,e){if(void 0!==this._elementEditorClasses[t])throw\"An element editor class has already been registered for the element type \u201c\"+t+\"\u201d.\";this._elementEditorClasses[t]=e},createElementIndex:function(t,e,i){return new(void 0!==this._elementIndexClasses[t]?this._elementIndexClasses[t]:Craft.BaseElementIndex)(t,e,i)},createElementSelectorModal:function(t,e){return new(void 0!==this._elementSelectorModalClasses[t]?this._elementSelectorModalClasses[t]:Craft.BaseElementSelectorModal)(t,e)},createElementEditor:function(t,e,i){return new(void 0!==this._elementEditorClasses[t]?this._elementEditorClasses[t]:Craft.BaseElementEditor)(e,i)},getLocalStorage:function(t,e){return t=\"Craft-\"+Craft.systemUid+\".\"+t,\"undefined\"!=typeof localStorage&&void 0!==localStorage[t]?JSON.parse(localStorage[t]):e},setLocalStorage:function(t,e){if(\"undefined\"!=typeof localStorage){t=\"Craft-\"+Craft.systemUid+\".\"+t;try{localStorage[t]=JSON.stringify(e)}catch(t){}}},getElementInfo:function(t){var e=$(t);return e.hasClass(\"element\")||(e=e.find(\".element:first\")),{id:e.data(\"id\"),siteId:e.data(\"site-id\"),label:e.data(\"label\"),status:e.data(\"status\"),url:e.data(\"url\"),hasThumb:e.hasClass(\"hasthumb\"),$element:e}},setElementSize:function(t,e){var i=$(t);if(\"small\"!==e&&\"large\"!==e&&(e=\"small\"),!i.hasClass(e)){var s=\"small\"===e?\"large\":\"small\";if(i.addClass(e).removeClass(s),i.hasClass(\"hasthumb\")){var n=i.find(\"> .elementthumb > img\"),a=$(\"<img/>\",{sizes:(\"small\"===e?\"30\":\"100\")+\"px\",srcset:n.attr(\"srcset\")||n.attr(\"data-pfsrcset\")});n.replaceWith(a),picturefill({elements:[a[0]]})}}}}),$.extend($.fn,{animateLeft:function(t,e,i,s){return\"ltr\"===Craft.orientation?this.velocity({left:t},e,i,s):this.velocity({right:t},e,i,s)},animateRight:function(t,e,i,s){return\"ltr\"===Craft.orientation?this.velocity({right:t},e,i,s):this.velocity({left:t},e,i,s)},disable:function(){return this.each(function(){var t=$(this);t.addClass(\"disabled\"),t.data(\"activatable\")&&t.removeAttr(\"tabindex\")})},enable:function(){return this.each(function(){var t=$(this);t.removeClass(\"disabled\"),t.data(\"activatable\")&&t.attr(\"tabindex\",\"0\")})},grid:function(){return this.each(function(){var t=$(this),e={};t.data(\"item-selector\")&&(e.itemSelector=t.data(\"item-selector\")),t.data(\"cols\")&&(e.cols=parseInt(t.data(\"cols\"))),t.data(\"max-cols\")&&(e.maxCols=parseInt(t.data(\"max-cols\"))),t.data(\"min-col-width\")&&(e.minColWidth=parseInt(t.data(\"min-col-width\"))),t.data(\"mode\")&&(e.mode=t.data(\"mode\")),t.data(\"fill-mode\")&&(e.fillMode=t.data(\"fill-mode\")),t.data(\"col-class\")&&(e.colClass=t.data(\"col-class\")),t.data(\"snap-to-grid\")&&(e.snapToGrid=!!t.data(\"snap-to-grid\")),new Craft.Grid(this,e)})},infoicon:function(){return this.each(function(){new Craft.InfoIcon(this)})},checkboxselect:function(){return this.each(function(){$.data(this,\"checkboxselect\")||new Garnish.CheckboxSelect(this)})},fieldtoggle:function(){return this.each(function(){$.data(this,\"fieldtoggle\")||new Craft.FieldToggle(this)})},lightswitch:function(e,t,i){return\"settings\"===e?(\"string\"==typeof t?(e={})[t]=i:e=t,this.each(function(){var t=$.data(this,\"lightswitch\");t&&t.setSettings(e)})):($.isPlainObject(e)||(e={}),this.each(function(){var t=$.extend({},e);Garnish.hasAttr(this,\"data-value\")&&(t.value=$(this).attr(\"data-value\")),$.data(this,\"lightswitch\")||new Craft.LightSwitch(this,t)}))},nicetext:function(){return this.each(function(){$.data(this,\"nicetext\")||new Garnish.NiceText(this)})},pill:function(){return this.each(function(){$.data(this,\"pill\")||new Garnish.Pill(this)})},formsubmit:function(){this.on(\"click\",function(t){var e=$(t.currentTarget);if(!e.attr(\"data-confirm\")||confirm(e.attr(\"data-confirm\"))){var i=e.data(\"menu\")?e.data(\"menu\").$anchor:e,s=i.attr(\"data-form\")?$(\"#\"+i.attr(\"data-form\")):i.closest(\"form\");e.data(\"action\")&&$('<input type=\"hidden\" name=\"action\"/>').val(e.data(\"action\")).appendTo(s),e.data(\"redirect\")&&$('<input type=\"hidden\" name=\"redirect\"/>').val(e.data(\"redirect\")).appendTo(s),e.data(\"param\")&&$('<input type=\"hidden\"/>').attr({name:e.data(\"param\"),value:e.data(\"value\")}).appendTo(s),s.trigger({type:\"submit\",customTrigger:e})}})},menubtn:function(){return this.each(function(){var t=$(this);if(!t.data(\"menubtn\")&&t.next().hasClass(\"menu\")){var e={};t.data(\"menu-anchor\")&&(e.menuAnchor=t.data(\"menu-anchor\")),new Garnish.MenuBtn(t,e)}})}}),Garnish.$doc.ready(function(){Craft.initUiElements()}),Craft.BaseElementEditor=Garnish.Base.extend({$element:null,elementId:null,siteId:null,$form:null,$fieldsContainer:null,$cancelBtn:null,$saveBtn:null,$spinner:null,$siteSelect:null,$siteSpinner:null,hud:null,init:function(t,e){void 0===e&&$.isPlainObject(t)&&(e=t,t=null),this.$element=$(t),this.setSettings(e,Craft.BaseElementEditor.defaults),this.loadHud()},setElementAttribute:function(t,e){this.settings.attributes||(this.settings.attributes={}),null===e?delete this.settings.attributes[t]:this.settings.attributes[t]=e},getBaseData:function(){var t=$.extend({},this.settings.params);return this.settings.siteId?t.siteId=this.settings.siteId:this.$element&&this.$element.data(\"site-id\")&&(t.siteId=this.$element.data(\"site-id\")),this.settings.elementId?t.elementId=this.settings.elementId:this.$element&&this.$element.data(\"id\")&&(t.elementId=this.$element.data(\"id\")),this.settings.elementType&&(t.elementType=this.settings.elementType),this.settings.attributes&&(t.attributes=this.settings.attributes),this.settings.prevalidate&&(t.prevalidate=1),t},loadHud:function(){this.onBeginLoading();var t=this.getBaseData();t.includeSites=Craft.isMultiSite&&this.settings.showSiteSwitcher,Craft.postActionRequest(\"elements/get-editor-html\",t,$.proxy(this,\"showHud\"))},showHud:function(t,e){if(this.onEndLoading(),\"success\"===e){var i=$();if(t.sites){var s=$('<div class=\"hud-header\"/>');if(1===t.sites.length)$(\"<h5/>\",{text:t.sites[0].name}).appendTo(s);else{var n=$('<div class=\"select\"/>').appendTo(s);this.$siteSelect=$(\"<select/>\").appendTo(n),this.$siteSpinner=$('<div class=\"spinner hidden\"/>').appendTo(s);for(var a=0;a<t.sites.length;a++){var r=t.sites[a];$('<option value=\"'+r.id+'\"'+(r.id==t.siteId?' selected=\"selected\"':\"\")+\">\"+r.name+\"</option>\").appendTo(this.$siteSelect)}this.addListener(this.$siteSelect,\"change\",\"switchSite\")}i=i.add(s)}this.$form=$(\"<div/>\"),this.$fieldsContainer=$('<div class=\"fields\"/>').appendTo(this.$form),this.updateForm(t),this.onCreateForm(this.$form);var o=$('<div class=\"hud-footer\"/>').appendTo(this.$form),l=$('<div class=\"buttons right\"/>').appendTo(o);if(this.$cancelBtn=$('<div class=\"btn\">'+Craft.t(\"app\",\"Cancel\")+\"</div>\").appendTo(l),this.$saveBtn=$('<input class=\"btn submit\" type=\"submit\" value=\"'+Craft.t(\"app\",\"Save\")+'\"/>').appendTo(l),this.$spinner=$('<div class=\"spinner hidden\"/>').appendTo(l),i=i.add(this.$form),this.hud)this.hud.updateBody(i),this.hud.updateSizeAndPosition();else{var h=this.settings.hudTrigger||this.$element;this.hud=new Garnish.HUD(h,i,{bodyClass:\"body elementeditor\",closeOtherHUDs:!1,onShow:$.proxy(this,\"onShowHud\"),onHide:$.proxy(this,\"onHideHud\"),onSubmit:$.proxy(this,\"saveElement\")}),this.hud.$hud.data(\"elementEditor\",this),this.hud.on(\"hide\",$.proxy(function(){delete this.hud},this))}i.find(\".text:first\").trigger(\"focus\"),this.addListener(this.$cancelBtn,\"click\",function(){this.hud.hide()})}},switchSite:function(){var t=this.$siteSelect.val();t!=this.siteId&&(this.$siteSpinner.removeClass(\"hidden\"),this.reloadForm({siteId:t},$.proxy(function(t){this.$siteSpinner.addClass(\"hidden\"),\"success\"!==t&&this.$siteSelect.val(this.siteId)},this)))},reloadForm:function(t,i){t=$.extend(this.getBaseData(),t),Craft.postActionRequest(\"elements/get-editor-html\",t,$.proxy(function(t,e){\"success\"===e&&this.updateForm(t),i&&i(e)},this))},updateForm:function(t){this.siteId=t.siteId,this.$fieldsContainer.html(t.html);for(var e=this.$fieldsContainer.find(\"> .meta > .field > .heading > .instructions\"),i=0;i<e.length;i++)e.eq(i).replaceWith($(\"<span/>\",{class:\"info\",html:e.eq(i).children().html()})).infoicon();Garnish.requestAnimationFrame($.proxy(function(){Craft.appendHeadHtml(t.headHtml),Craft.appendFootHtml(t.footHtml),Craft.initUiElements(this.$fieldsContainer)},this))},saveElement:function(){var t=this.settings.validators;if($.isArray(t))for(var e=0;e<t.length;e++)if($.isFunction(t[e])&&!t[e].call())return!1;this.$spinner.removeClass(\"hidden\");var i=$.param(this.getBaseData())+\"&\"+this.hud.$body.serialize();Craft.postActionRequest(\"elements/save-element\",i,$.proxy(function(t,e){if(this.$spinner.addClass(\"hidden\"),\"success\"===e)if(t.success){if(this.$element&&this.siteId==this.$element.data(\"site-id\")){var i=this.$element.find(\".title\"),s=i.find(\"a\");s.length&&t.cpEditUrl?(s.attr(\"href\",t.cpEditUrl),s.text(t.newTitle)):i.text(t.newTitle)}this.closeHud(),this.onSaveElement(t)}else this.updateForm(t),Garnish.shake(this.hud.$hud)},this))},closeHud:function(){this.hud.hide(),delete this.hud},onShowHud:function(){this.settings.onShowHud(),this.trigger(\"showHud\")},onHideHud:function(){this.settings.onHideHud(),this.trigger(\"hideHud\")},onBeginLoading:function(){this.$element&&this.$element.addClass(\"loading\"),this.settings.onBeginLoading(),this.trigger(\"beginLoading\")},onEndLoading:function(){this.$element&&this.$element.removeClass(\"loading\"),this.settings.onEndLoading(),this.trigger(\"endLoading\")},onSaveElement:function(t){this.settings.onSaveElement(t),this.trigger(\"saveElement\",{response:t}),Craft.cp.runQueue()},onCreateForm:function(t){this.settings.onCreateForm(t)}},{defaults:{hudTrigger:null,showSiteSwitcher:!0,elementId:null,elementType:null,siteId:null,attributes:null,params:null,prevalidate:!1,elementIndex:null,onShowHud:$.noop,onHideHud:$.noop,onBeginLoading:$.noop,onEndLoading:$.noop,onCreateForm:$.noop,onSaveElement:$.noop,validators:[]}}),Craft.BaseElementIndex=Garnish.Base.extend({initialized:!1,elementType:null,instanceState:null,sourceStates:null,sourceStatesStorageKey:null,searchTimeout:null,sourceSelect:null,$container:null,$main:null,$mainSpinner:null,isIndexBusy:!1,$sidebar:null,showingSidebar:null,sourceKey:null,sourceViewModes:null,$source:null,sourcesByKey:null,$visibleSources:null,$customizeSourcesBtn:null,customizeSourcesModal:null,$toolbar:null,$toolbarFlexContainer:null,toolbarOffset:null,$search:null,searching:!1,searchText:null,trashed:!1,drafts:!1,$clearSearchBtn:null,$statusMenuBtn:null,$statusMenuContainer:null,statusMenu:null,status:null,$siteMenuBtn:null,siteMenu:null,siteId:null,$sortMenuBtn:null,sortMenu:null,$sortAttributesList:null,$sortDirectionsList:null,$scoreSortAttribute:null,$structureSortAttribute:null,$elements:null,$viewModeBtnContainer:null,viewModeBtns:null,viewMode:null,view:null,_autoSelectElements:null,$countContainer:null,page:1,$exportBtn:null,actions:null,actionsHeadHtml:null,actionsFootHtml:null,$selectAllContainer:null,$selectAllCheckbox:null,showingActionTriggers:!1,_$detachedToolbarItems:null,_$triggers:null,init:function(t,e,i){if(this.elementType=t,this.$container=e,this.setSettings(i,Craft.BaseElementIndex.defaults),this.instanceState=this.getDefaultInstanceState(),this.sourceStates={},this.settings.storageKey&&$.extend(this.instanceState,Craft.getLocalStorage(this.settings.storageKey),{}),this.sourceStatesStorageKey=\"BaseElementIndex.\"+this.elementType+\".\"+this.settings.context,$.extend(this.sourceStates,Craft.getLocalStorage(this.sourceStatesStorageKey,{})),this.$main=this.$container.find(\".main\"),this.$toolbar=this.$container.find(\".toolbar:first\"),this.$toolbarFlexContainer=this.$toolbar.children(\".flex\"),this.$statusMenuBtn=this.$toolbarFlexContainer.find(\".statusmenubtn:first\"),this.$statusMenuContainer=this.$statusMenuBtn.parent(),this.$siteMenuBtn=this.$container.find(\".sitemenubtn:first\"),this.$sortMenuBtn=this.$toolbarFlexContainer.find(\".sortmenubtn:first\"),this.$search=this.$toolbarFlexContainer.find(\".search:first input:first\"),this.$clearSearchBtn=this.$toolbarFlexContainer.find(\".search:first > .clear\"),this.$mainSpinner=this.$toolbarFlexContainer.find(\".spinner:first\"),this.$sidebar=this.$container.find(\".sidebar:first\"),this.$customizeSourcesBtn=this.$sidebar.find(\".customize-sources\"),this.$elements=this.$container.find(\".elements:first\"),this.$countContainer=this.$container.find(\"#count-container\"),this.$exportBtn=this.$container.find(\"#export-btn\"),this.settings.hideSidebar&&(this.$sidebar.hide(),$(\".body, .content\",this.$container).removeClass(\"has-sidebar\")),(this.settings.toolbarFixed||null===this.settings.toolbarFixed&&\"index\"===this.settings.context)&&!Garnish.isMobileBrowser(!0)&&(this.addListener(Garnish.$win,\"resize\",\"updateFixedToolbar\"),this.addListener(Garnish.$scrollContainer,\"scroll\",\"updateFixedToolbar\")),this.initSources()){if(this.$customizeSourcesBtn.length&&this.addListener(this.$customizeSourcesBtn,\"click\",\"createCustomizeSourcesModal\"),this.$statusMenuBtn.length&&(this.statusMenu=this.$statusMenuBtn.menubtn().data(\"menubtn\").menu,this.statusMenu.on(\"optionselect\",$.proxy(this,\"_handleStatusChange\"))),this.$siteMenuBtn.length){this.siteMenu=this.$siteMenuBtn.menubtn().data(\"menubtn\").menu;var s=this.siteMenu.$options.filter(\".sel:first\");if(s.length||(s=this.siteMenu.$options.first()),s.length?this._setSite(s.data(\"site-id\")):this.settings.criteria={id:\"0\"},this.siteMenu.on(\"optionselect\",$.proxy(this,\"_handleSiteChange\")),this.siteId){var n=Craft.getLocalStorage(\"BaseElementIndex.siteId\");if(n&&n!=this.siteId){var a=this.siteMenu.$options.filter('[data-site-id=\"'+n+'\"]:first');a.length&&a.trigger(\"click\")}}}else this.settings.criteria&&this.settings.criteria.siteId?this._setSite(this.settings.criteria.siteId):this._setSite(Craft.siteId);this.addListener(this.$search,\"textchange\",$.proxy(function(){!this.searching&&this.$search.val()?this.startSearching():this.searching&&!this.$search.val()&&this.stopSearching(),this.searchTimeout&&clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout($.proxy(this,\"updateElementsIfSearchTextChanged\"),500)},this)),this.addListener(this.$search,\"keypress\",$.proxy(function(t){t.keyCode===Garnish.RETURN_KEY&&(t.preventDefault(),this.searchTimeout&&clearTimeout(this.searchTimeout),this.updateElementsIfSearchTextChanged())},this)),this.addListener(this.$clearSearchBtn,\"click\",$.proxy(function(){this.$search.val(\"\"),this.searchTimeout&&clearTimeout(this.searchTimeout),Garnish.isMobileBrowser(!0)||this.$search.trigger(\"focus\"),this.stopSearching(),this.updateElementsIfSearchTextChanged()},this)),Garnish.isMobileBrowser(!0)||this.$search.trigger(\"focus\"),this.$sortMenuBtn.length&&(this.sortMenu=this.$sortMenuBtn.menubtn().data(\"menubtn\").menu,this.$sortAttributesList=this.sortMenu.$container.children(\".sort-attributes\"),this.$sortDirectionsList=this.sortMenu.$container.children(\".sort-directions\"),this.sortMenu.on(\"optionselect\",$.proxy(this,\"_handleSortChange\"))),this.addListener(this.$exportBtn,\"click\",\"_showExportHud\"),this.initialized=!0,this.afterInit(),this.selectDefaultSource(),\"index\"===this.settings.context&&this.setPage(Craft.pageNum),this.updateElements(!0)}},afterInit:function(){this.onAfterInit()},getSourceContainer:function(){return this.$sidebar.find(\"nav>ul\")},get $sources(){if(this.sourceSelect)return this.sourceSelect.$items},initSources:function(){var t=this._getSourcesInList(this.getSourceContainer());return 0!==t.length&&(this.sourceSelect||(this.sourceSelect=new Garnish.Select(this.$sidebar.find(\"nav\"),{multi:!1,allowEmpty:!1,vertical:!0,onSelectionChange:$.proxy(this,\"_handleSourceSelectionChange\")})),this.sourcesByKey={},this._initSources(t),!0)},selectDefaultSource:function(){var t,e=this.getDefaultSourceKey();e&&(t=this.getSourceByKey(e),-1===this.$visibleSources.index(t)&&(t=null)),e&&t||(t=this.$visibleSources.first()),t.length&&this.selectSource(t)},refreshSources:function(){this.sourceSelect.removeAllItems();var t={context:this.settings.context,elementType:this.elementType};this.setIndexBusy(),Craft.postActionRequest(this.settings.refreshSourcesAction,t,$.proxy(function(t,e){this.setIndexAvailable(),\"success\"===e?(this.getSourceContainer().replaceWith(t.html),this.initSources(),this.selectDefaultSource()):Craft.cp.displayError(Craft.t(\"app\",\"An unknown error occurred.\"))},this))},updateFixedToolbar:function(t){this.updateFixedToolbar._scrollTop=Garnish.$scrollContainer.scrollTop(),992<Garnish.$win.width()&&17<=this.updateFixedToolbar._scrollTop?((this.updateFixedToolbar._makingFixed=!this.$toolbar.hasClass(\"fixed\"))&&(this.$elements.css(\"padding-top\",this.$toolbar.outerHeight()+21),this.$toolbar.addClass(\"fixed\")),!this.updateFixedToolbar._makingFixed&&\"resize\"!==t.type||this.$toolbar.css({top:Garnish.$scrollContainer.offset().top,width:this.$main.width()})):this.$toolbar.hasClass(\"fixed\")&&(this.$toolbar.removeClass(\"fixed\"),this.$toolbar.css(\"width\",\"\"),this.$elements.css(\"padding-top\",\"\"),this.$toolbar.css(\"top\",\"0\"))},initSource:function(t){this.sourceSelect.addItems(t),this.initSourceToggle(t),(this.sourcesByKey[t.data(\"key\")]=t).data(\"hasNestedSources\")&&-1!==this.instanceState.expandedSources.indexOf(t.data(\"key\"))&&this._expandSource(t)},initSourceToggle:function(t){this.deinitSourceToggle(t);var e=this._getSourceToggle(t);e.length?(this.addListener(t,\"dblclick\",\"_handleSourceDblClick\"),this.addListener(e,\"click\",\"_handleSourceToggleClick\"),t.data(\"hasNestedSources\",!0)):t.data(\"hasNestedSources\",!1)},deinitSource:function(t){this.sourceSelect.removeItems(t),this.deinitSourceToggle(t),delete this.sourcesByKey[t.data(\"key\")]},deinitSourceToggle:function(t){t.data(\"hasNestedSources\")&&(this.removeListener(t,\"dblclick\"),this.removeListener(this._getSourceToggle(t),\"click\")),t.removeData(\"hasNestedSources\")},getDefaultInstanceState:function(){return{selectedSource:null,expandedSources:[]}},getDefaultSourceKey:function(){return this.instanceState.selectedSource},getDefaultExpandedSources:function(){return this.instanceState.expandedSources},startSearching:function(){this.$clearSearchBtn.removeClass(\"hidden\"),this.$scoreSortAttribute||(this.$scoreSortAttribute=$('<li><a data-attr=\"score\">'+Craft.t(\"app\",\"Score\")+\"</a></li>\"),this.sortMenu.addOptions(this.$scoreSortAttribute.children())),this.$scoreSortAttribute.prependTo(this.$sortAttributesList),this.searching=!0,this._updateStructureSortOption(),this.setSortAttribute(\"score\")},stopSearching:function(){this.$clearSearchBtn.addClass(\"hidden\"),this.$scoreSortAttribute.detach(),this.searching=!1,this._updateStructureSortOption()},setInstanceState:function(t,e){\"object\"==typeof t?$.extend(this.instanceState,t):this.instanceState[t]=e,this.storeInstanceState()},storeInstanceState:function(){this.settings.storageKey&&Craft.setLocalStorage(this.settings.storageKey,this.instanceState)},getSourceState:function(t,e,i){return void 0===this.sourceStates[t]&&(this.sourceStates[t]={}),void 0===e?this.sourceStates[t]:void 0!==this.sourceStates[t][e]?this.sourceStates[t][e]:void 0!==i?i:null},getSelectedSourceState:function(t,e){return this.getSourceState(this.instanceState.selectedSource,t,e)},setSelecetedSourceState:function(t,e){var i=this.getSelectedSourceState();\"object\"==typeof t?$.extend(i,t):i[t]=e,this.sourceStates[this.instanceState.selectedSource]=i,Craft.setLocalStorage(this.sourceStatesStorageKey,this.sourceStates)},storeSortAttributeAndDirection:function(){var t=this.getSelectedSortAttribute();\"score\"!==t&&this.setSelecetedSourceState({order:t,sort:this.getSelectedSortDirection()})},setPage:function(t){t=Math.max(t,1),this.page=t;var e=document.location.href.replace(/\\?.*$/,\"\").replace(new RegExp(\"/\"+Craft.pageTrigger.replace(/[.*+?^${}()|[\\]\\\\]/g,\"\\\\$&\")+\"\\\\d+$\"),\"\").replace(/\\/+$/,\"\");1!==this.page&&(\"?\"!==Craft.pageTrigger[0]&&(e+=\"/\"),e+=Craft.pageTrigger+this.page),history.replaceState({},\"\",e)},getViewParams:function(){var t={siteId:this.siteId,search:this.searchText,offset:this.settings.batchSize*(this.page-1),limit:this.settings.batchSize,trashed:this.trashed?1:0,drafts:this.drafts?1:0};Garnish.hasAttr(this.$source,\"data-override-status\")||(t.status=this.status),$.extend(t,this.settings.criteria);var e={context:this.settings.context,elementType:this.elementType,source:this.instanceState.selectedSource,criteria:t,disabledElementIds:this.settings.disabledElementIds,viewState:$.extend({},this.getSelectedSourceState()),paginated:this._isViewPaginated()?1:0};return e.viewState.order=this.getSelectedSortAttribute(),e.viewState.sort=this.getSelectedSortDirection(),\"structure\"===this.getSelectedSortAttribute()&&(void 0===this.instanceState.collapsedElementIds&&(this.instanceState.collapsedElementIds=[]),e.collapsedElementIds=this.instanceState.collapsedElementIds),e},updateElements:function(t){if(this.initialized){this.setIndexBusy(),this.view&&(this.view.destroy(),delete this.view),this.$elements.html(\"\"),!0!==t&&(this.$countContainer.html(\"&nbsp;\"),this.setPage(1));var s=this.getViewParams();Craft.postActionRequest(this.settings.updateElementsAction,s,$.proxy(function(t,e){if(this.setIndexAvailable(),\"success\"===e){var i=Math.max(Math.ceil(t.count/this.settings.batchSize),1);if(this.page>i)return this.setPage(i),void this.updateElements(!0);this._updateView(s,t)}else Craft.cp.displayError(Craft.t(\"app\",\"An unknown error occurred.\"))},this))}},updateElementsIfSearchTextChanged:function(){this.searchText!==(this.searchText=this.searching?this.$search.val():null)&&this.updateElements()},showActionTriggers:function(){this.showingActionTriggers||(this.$toolbar.css(\"min-height\",this.$toolbar.height()),this._$detachedToolbarItems=this.$toolbarFlexContainer.children().not(this.$selectAllContainer).not(this.$mainSpinner),this._$detachedToolbarItems.detach(),this._$triggers?this._$triggers.insertAfter(this.$selectAllContainer):this._createTriggers(),this.showingActionTriggers=!0)},submitAction:function(t,e){var i=this.view.getSelectedElementIds();if(0!==i.length){for(var s,n=0;n<this.actions.length;n++)if(this.actions[n].type===t){s=this.actions[n];break}if(s&&(!s.confirm||confirm(s.confirm))){var a=this.getViewParams(),r=$.extend(a,e,{elementAction:t,elementIds:i});this.setIndexBusy(),this._autoSelectElements=i,Craft.postActionRequest(this.settings.submitActionsAction,r,$.proxy(function(t,e){this.setIndexAvailable(),\"success\"===e&&(t.success?(this._updateView(a,t),t.message&&Craft.cp.displayNotice(t.message),this.afterAction(s,r)):Craft.cp.displayError(t.message))},this))}}},afterAction:function(t,e){Craft.cp.runQueue(),this.onAfterAction(t,e)},hideActionTriggers:function(){this.showingActionTriggers&&(this._$detachedToolbarItems.insertBefore(this.$mainSpinner),this._$triggers.detach(),this.$toolbarFlexContainer.children().not(this.$selectAllContainer).removeClass(\"hidden\"),this.$toolbar.css(\"min-height\",\"\"),this.showingActionTriggers=!1)},updateActionTriggers:function(){if(this.actions){var t=this.view.getSelectedElements().length;0!==t?(t===this.view.getEnabledElements().length?(this.$selectAllCheckbox.removeClass(\"indeterminate\"),this.$selectAllCheckbox.addClass(\"checked\"),this.$selectAllBtn.attr(\"aria-checked\",\"true\")):(this.$selectAllCheckbox.addClass(\"indeterminate\"),this.$selectAllCheckbox.removeClass(\"checked\"),this.$selectAllBtn.attr(\"aria-checked\",\"mixed\")),this.showActionTriggers()):(this.$selectAllCheckbox.removeClass(\"indeterminate checked\"),this.$selectAllBtn.attr(\"aria-checked\",\"false\"),this.hideActionTriggers())}},getSelectedElements:function(){return this.view?this.view.getSelectedElements():$()},getSelectedElementIds:function(){return this.view?this.view.getSelectedElementIds():[]},getSortAttributeOption:function(t){return this.$sortAttributesList.find('a[data-attr=\"'+t+'\"]:first')},getSelectedSortAttribute:function(){return this.$sortAttributesList.find(\"a.sel:first\").data(\"attr\")},setSortAttribute:function(t){var e=this.getSortAttributeOption(t);if(e.length){this.$sortAttributesList.find(\"a.sel\").removeClass(\"sel\"),e.addClass(\"sel\");var i=e.text();this.$sortMenuBtn.attr(\"title\",Craft.t(\"app\",\"Sort by {attribute}\",{attribute:i})),this.$sortMenuBtn.text(i),this.setSortDirection(\"score\"===t?\"desc\":\"asc\"),\"structure\"===t?this.$sortDirectionsList.find(\"a\").addClass(\"disabled\"):this.$sortDirectionsList.find(\"a\").removeClass(\"disabled\")}},getSortDirectionOption:function(t){return this.$sortDirectionsList.find(\"a[data-dir=\"+t+\"]:first\")},getSelectedSortDirection:function(){return this.$sortDirectionsList.find(\"a.sel:first\").data(\"dir\")},getSelectedViewMode:function(){return this.getSelectedSourceState(\"mode\")},setSortDirection:function(t){\"desc\"!==t&&(t=\"asc\"),this.$sortMenuBtn.attr(\"data-icon\",t),this.$sortDirectionsList.find(\"a.sel\").removeClass(\"sel\"),this.getSortDirectionOption(t).addClass(\"sel\")},getSourceByKey:function(t){return void 0===this.sourcesByKey[t]?null:this.sourcesByKey[t]},selectSource:function(t){if(!t||!t.length)return!1;if(this.$source&&this.$source[0]&&this.$source[0]===t[0]&&t.data(\"key\")===this.sourceKey)return!1;if(this.hideActionTriggers(),this.$source=t,this.sourceKey=t.data(\"key\"),this.setInstanceState(\"selectedSource\",this.sourceKey),this.sourceSelect.selectItem(t),Craft.cp.updateSidebarMenuLabel(),this.searching&&(this.searchText=null,this.$search.val(\"\"),this.stopSearching()),Garnish.hasAttr(this.$source,\"data-has-structure\")?(this.$structureSortAttribute||(this.$structureSortAttribute=$('<li><a data-attr=\"structure\">'+Craft.t(\"app\",\"Structure\")+\"</a></li>\"),this.sortMenu.addOptions(this.$structureSortAttribute.children())),this.$structureSortAttribute.prependTo(this.$sortAttributesList)):this.$structureSortAttribute&&this.$structureSortAttribute.removeClass(\"sel\").detach(),this.setStoredSortOptionsForSource(),this.$statusMenuBtn.length&&(Garnish.hasAttr(this.$source,\"data-override-status\")?this.$statusMenuContainer.addClass(\"hidden\"):this.$statusMenuContainer.removeClass(\"hidden\")),this.$viewModeBtnContainer&&this.$viewModeBtnContainer.remove(),this.viewModeBtns={},this.viewMode=null,this.sourceViewModes=this.getViewModesForSource(),1<this.sourceViewModes.length){this.$viewModeBtnContainer=$('<div class=\"btngroup\"/>').insertBefore(this.$mainSpinner);for(var e=0;e<this.sourceViewModes.length;e++){var i=this.sourceViewModes[e],s=$('<div data-view=\"'+i.mode+'\" role=\"button\" class=\"btn'+(void 0!==i.className?\" \"+i.className:\"\")+'\" title=\"'+i.title+'\"'+(void 0!==i.icon?' data-icon=\"'+i.icon+'\"':\"\")+\"/>\").appendTo(this.$viewModeBtnContainer);this.viewModeBtns[i.mode]=s,this.addListener(s,\"click\",{mode:i.mode},function(t){this.selectViewMode(t.data.mode),this.updateElements()})}}var n=this.getSelectedViewMode();return n&&this.doesSourceHaveViewMode(n)||(n=this.viewMode&&this.doesSourceHaveViewMode(this.viewMode)?this.viewMode:this.sourceViewModes[0].mode),this.selectViewMode(n),this.onSelectSource(),!0},selectSourceByKey:function(t){var e=this.getSourceByKey(t);return!!e&&this.selectSource(e)},setStoredSortOptionsForSource:function(){var t=this.getSelectedSourceState(\"order\"),e=this.getSelectedSourceState(\"sort\");t&&e||(t=this.getDefaultSort(),Garnish.isArray(t)&&(e=t[1],t=t[0])),\"asc\"!==e&&\"desc\"!==e&&(e=\"asc\"),this.setSortAttribute(t),this.setSortDirection(e)},getDefaultSort:function(){return this.$source&&Garnish.hasAttr(this.$source,\"data-default-sort\")?this.$source.attr(\"data-default-sort\").split(\":\"):[this.$sortAttributesList.find(\"a:first\").data(\"attr\"),\"asc\"]},getViewModesForSource:function(){var t=[{mode:\"table\",title:Craft.t(\"app\",\"Display in a table\"),icon:\"list\"}];return this.$source&&Garnish.hasAttr(this.$source,\"data-has-thumbs\")&&t.push({mode:\"thumbs\",title:Craft.t(\"app\",\"Display as thumbnails\"),icon:\"grid\"}),t},doesSourceHaveViewMode:function(t){for(var e=0;e<this.sourceViewModes.length;e++)if(this.sourceViewModes[e].mode===t)return!0;return!1},selectViewMode:function(t,e){e||this.doesSourceHaveViewMode(t)||(t=this.sourceViewModes[0].mode),t!==this.viewMode&&(this.viewMode&&void 0!==this.viewModeBtns[this.viewMode]&&this.viewModeBtns[this.viewMode].removeClass(\"active\"),this.viewMode=t,this.setSelecetedSourceState(\"mode\",this.viewMode),void 0!==this.viewModeBtns[this.viewMode]&&this.viewModeBtns[this.viewMode].addClass(\"active\"))},createView:function(t,e){return new(this.getViewClass(t))(this,this.$elements,e)},getViewClass:function(t){switch(t){case\"table\":return Craft.TableElementIndexView;case\"thumbs\":return Craft.ThumbsElementIndexView;default:throw'View mode\u00a0\"'+t+'\" not supported.'}},rememberDisabledElementId:function(t){-1===$.inArray(t,this.settings.disabledElementIds)&&this.settings.disabledElementIds.push(t)},forgetDisabledElementId:function(t){var e=$.inArray(t,this.settings.disabledElementIds);-1!==e&&this.settings.disabledElementIds.splice(e,1)},enableElements:function(t){t.removeClass(\"disabled\").parents(\".disabled\").removeClass(\"disabled\");for(var e=0;e<t.length;e++){var i=$(t[e]).data(\"id\");this.forgetDisabledElementId(i)}this.onEnableElements(t)},disableElements:function(t){t.removeClass(\"sel\").addClass(\"disabled\");for(var e=0;e<t.length;e++){var i=$(t[e]).data(\"id\");this.rememberDisabledElementId(i)}this.onDisableElements(t)},getElementById:function(t){return this.view.getElementById(t)},enableElementsById:function(t){t=$.makeArray(t);for(var e=0;e<t.length;e++){var i=t[e],s=this.getElementById(i);s&&s.length?this.enableElements(s):this.forgetDisabledElementId(i)}},disableElementsById:function(t){t=$.makeArray(t);for(var e=0;e<t.length;e++){var i=t[e],s=this.getElementById(i);s&&s.length?this.disableElements(s):this.rememberDisabledElementId(i)}},selectElementAfterUpdate:function(t){null===this._autoSelectElements&&(this._autoSelectElements=[]),this._autoSelectElements.push(t)},addButton:function(t){this.getButtonContainer().append(t)},isShowingSidebar:function(){return null===this.showingSidebar&&(this.showingSidebar=this.$sidebar.length&&!this.$sidebar.hasClass(\"hidden\")),this.showingSidebar},getButtonContainer:function(){if(this.settings.buttonContainer)return $(this.settings.buttonContainer);var t=$(\"#button-container\");return t.length||(t=$('<div id=\"button-container\"/>').appendTo(Craft.cp.$header)),t},setIndexBusy:function(){this.$mainSpinner.removeClass(\"invisible\"),this.isIndexBusy=!0},setIndexAvailable:function(){this.$mainSpinner.addClass(\"invisible\"),this.isIndexBusy=!1},createCustomizeSourcesModal:function(){var t=new Craft.CustomizeSourcesModal(this,{onHide:function(){t.destroy()}});return t},disable:function(){this.sourceSelect&&this.sourceSelect.disable(),this.view&&this.view.disable(),this.base()},enable:function(){this.sourceSelect&&this.sourceSelect.enable(),this.view&&this.view.enable(),this.base()},onAfterInit:function(){this.settings.onAfterInit(),this.trigger(\"afterInit\")},onSelectSource:function(){this.settings.onSelectSource(this.sourceKey),this.trigger(\"selectSource\",{sourceKey:this.sourceKey})},onSelectSite:function(){this.settings.onSelectSite(this.siteId),this.trigger(\"selectSite\",{siteId:this.siteId})},onUpdateElements:function(){this.settings.onUpdateElements(),this.trigger(\"updateElements\")},onSelectionChange:function(){this.settings.onSelectionChange(),this.trigger(\"selectionChange\")},onEnableElements:function(t){this.settings.onEnableElements(t),this.trigger(\"enableElements\",{elements:t})},onDisableElements:function(t){this.settings.onDisableElements(t),this.trigger(\"disableElements\",{elements:t})},onAfterAction:function(t,e){this.settings.onAfterAction(t,e),this.trigger(\"afterAction\",{action:t,params:e})},_handleSourceSelectionChange:function(){this.sourceSelect.totalSelected?this.selectSource(this.sourceSelect.$selectedItems)&&this.updateElements():this.sourceSelect.selectItem(this.$visibleSources.first())},_handleActionTriggerSubmit:function(t){t.preventDefault();var e=$(t.currentTarget);if(!e.hasClass(\"disabled\")&&!e.data(\"custom-handler\")){var i=e.data(\"action\"),s=Garnish.getPostData(e);this.submitAction(i,s)}},_handleMenuActionTriggerSubmit:function(t){var e=$(t.option);if(!e.hasClass(\"disabled\")&&!e.data(\"custom-handler\")){var i=e.data(\"action\");this.submitAction(i)}},_handleStatusChange:function(t){this.statusMenu.$options.removeClass(\"sel\");var e=$(t.selectedOption).addClass(\"sel\");this.$statusMenuBtn.html(e.html()),this.trashed=!1,this.drafts=!1,this.status=null,Garnish.hasAttr(e,\"data-trashed\")?this.trashed=!0:Garnish.hasAttr(e,\"data-drafts\")?this.drafts=!0:this.status=e.data(\"status\"),this._updateStructureSortOption(),this.updateElements()},_handleSiteChange:function(t){this.siteMenu.$options.removeClass(\"sel\");var e=$(t.selectedOption).addClass(\"sel\");this.$siteMenuBtn.html(e.html()),this._setSite(e.data(\"site-id\")),this.onSelectSite()},_setSite:function(t){var e,i;this.siteId=t,this.$visibleSources=$();for(var s=!1,n=0;n<this.$sources.length;n++)void 0===(i=this.$sources.eq(n)).data(\"sites\")||-1!==i.data(\"sites\").toString().split(\",\").indexOf(t.toString())?(i.parent().removeClass(\"hidden\"),this.$visibleSources=this.$visibleSources.add(i),e||(e=i)):(i.parent().addClass(\"hidden\"),this.$source&&this.$source.get(0)==i.get(0)&&(s=!0));s&&this.selectSource(e);var a,r=this.getSourceContainer().children(\".heading\");for(n=0;n<r.length;n++)0!==(a=r.eq(n)).nextUntil(\".heading\",\":not(.hidden)\").length?a.removeClass(\"hidden\"):a.addClass(\"hidden\");this.initialized&&(Craft.setLocalStorage(\"BaseElementIndex.siteId\",t),this.updateElements())},_handleSortChange:function(t){var e=$(t.selectedOption);e.hasClass(\"disabled\")||e.hasClass(\"sel\")||(e.parent().parent().is(this.$sortAttributesList)?this.setSortAttribute(e.data(\"attr\")):this.setSortDirection(e.data(\"dir\")),this.storeSortAttributeAndDirection(),this.updateElements())},_handleSelectionChange:function(){this.updateActionTriggers(),this.onSelectionChange()},_handleSourceDblClick:function(t){this._toggleSource($(t.currentTarget)),t.stopPropagation()},_handleSourceToggleClick:function(t){this._toggleSource($(t.currentTarget).prev(\"a\")),t.stopPropagation()},_updateStructureSortOption:function(){var t=this.getSortAttributeOption(\"structure\");if(t.length)if(this.trashed||this.drafts||this.searching){if(t.addClass(\"disabled\"),\"structure\"===this.getSelectedSortAttribute()){var e=this.$sortAttributesList.find(\"a:not(.disabled):first\");this.setSortAttribute(e.data(\"attr\")),this.setSortDirection(\"asc\")}}else t.removeClass(\"disabled\"),this.setStoredSortOptionsForSource()},_getSourcesInList:function(t){return t.children(\"li\").children(\"a\")},_getChildSources:function(t){var e=t.siblings(\"ul\");return this._getSourcesInList(e)},_getSourceToggle:function(t){return t.siblings(\".toggle\")},_initSources:function(t){for(var e=0;e<t.length;e++)this.initSource($(t[e]))},_deinitSources:function(t){for(var e=0;e<t.length;e++)this.deinitSource($(t[e]))},_toggleSource:function(t){t.parent(\"li\").hasClass(\"expanded\")?this._collapseSource(t):this._expandSource(t)},_expandSource:function(t){t.parent(\"li\").addClass(\"expanded\");var e=this._getChildSources(t);this._initSources(e);var i=t.data(\"key\");-1===this.instanceState.expandedSources.indexOf(i)&&(this.instanceState.expandedSources.push(i),this.storeInstanceState())},_collapseSource:function(t){t.parent(\"li\").removeClass(\"expanded\");var e=this._getChildSources(t);this._deinitSources(e);var i=this.instanceState.expandedSources.indexOf(t.data(\"key\"));-1!==i&&(this.instanceState.expandedSources.splice(i,1),this.storeInstanceState())},_isViewPaginated:function(){return\"index\"===this.settings.context&&\"structure\"!==this.getSelectedSortAttribute()},_updateView:function(t,e){if(this.actions&&(this.hideActionTriggers(),this.actions=this.actionsHeadHtml=this.actionsFootHtml=this._$triggers=null),this.$selectAllContainer&&this.$selectAllContainer.detach(),this.$countContainer.html(\"\"),!this._isViewPaginated()||e.count<=this.settings.batchSize)this.$countContainer.text(e.countLabel);else{var i=$('<div class=\"flex pagination\"/>').appendTo(this.$countContainer),s=Math.max(Math.ceil(e.count/this.settings.batchSize),1),n=$(\"<div/>\",{class:\"page-link\"+(1<this.page?\"\":\" disabled\"),\"data-icon\":\"leftangle\",title:Craft.t(\"app\",\"Previous Page\")}).appendTo(i),a=$(\"<div/>\",{class:\"page-link\"+(this.page<s?\"\":\" disabled\"),\"data-icon\":\"rightangle\",title:Craft.t(\"app\",\"Next Page\")}).appendTo(i);$(\"<div/>\",{class:\"page-info\",text:e.countLabel}).appendTo(i),1<this.page&&this.addListener(n,\"click\",function(){this.removeListener(n,\"click\"),this.removeListener(a,\"click\"),this.setPage(this.page-1),this.updateElements(!0)}),this.page<s&&this.addListener(a,\"click\",function(){this.removeListener(n,\"click\"),this.removeListener(a,\"click\"),this.setPage(this.page+1),this.updateElements(!0)})}e.actions&&e.actions.length&&(this.actions=e.actions,this.actionsHeadHtml=e.actionsHeadHtml,this.actionsFootHtml=e.actionsFootHtml,this.$selectAllContainer?(this.$selectAllCheckbox.removeClass(\"indeterminate checked\"),this.$selectAllBtn.attr(\"aria-checked\",\"false\")):(this.$selectAllContainer=$('<div class=\"selectallcontainer\"/>'),this.$selectAllBtn=$('<div class=\"btn\"/>').appendTo(this.$selectAllContainer),this.$selectAllCheckbox=$('<div class=\"checkbox\"/>').appendTo(this.$selectAllBtn),this.$selectAllBtn.attr({role:\"checkbox\",tabindex:\"0\",\"aria-checked\":\"false\"}),this.addListener(this.$selectAllBtn,\"click\",function(){0===this.view.getSelectedElements().length?this.view.selectAllElements():this.view.deselectAllElements()}),this.addListener(this.$selectAllBtn,\"keydown\",function(t){t.keyCode===Garnish.SPACE_KEY&&(t.preventDefault(),$(t.currentTarget).trigger(\"click\"))})),this.$selectAllContainer.prependTo(this.$toolbarFlexContainer)),this.$elements.html(e.html),Craft.appendHeadHtml(e.headHtml),Craft.appendFootHtml(e.footHtml);var r=this.actions||this.settings.selectable;if(this.view=this.createView(this.getSelectedViewMode(),{context:this.settings.context,batchSize:\"index\"!==this.settings.context||\"structure\"===this.getSelectedSortAttribute()?this.settings.batchSize:null,params:t,selectable:r,multiSelect:this.actions||this.settings.multiSelect,checkboxMode:!!this.actions,onSelectionChange:$.proxy(this,\"_handleSelectionChange\")}),this._autoSelectElements){if(r)for(var o=0;o<this._autoSelectElements.length;o++)this.view.selectElementById(this._autoSelectElements[o]);this._autoSelectElements=null}this.onUpdateElements()},_createTriggers:function(){var t,e,i=[],s=[],n=[];for(t=0;t<this.actions.length;t++){var a=this.actions[t];if(a.trigger){var r=$('<form id=\"'+Craft.formatInputId(a.type)+'-actiontrigger\"/>').data(\"action\",a.type).append(a.trigger);this.addListener(r,\"submit\",\"_handleActionTriggerSubmit\"),i.push(r)}else a.destructive?n.push(a):s.push(a)}if(s.length||n.length){var o=$(\"<form/>\");e=$('<div class=\"btn menubtn\" data-icon=\"settings\" title=\"'+Craft.t(\"app\",\"Actions\")+'\"/>').appendTo(o);var l=$('<ul class=\"menu\"/>').appendTo(o),h=this._createMenuTriggerList(s,!1),d=this._createMenuTriggerList(n,!0);h&&h.appendTo(l),h&&d&&$(\"<hr/>\").appendTo(l),d&&d.appendTo(l),i.push(o)}for(this._$triggers=$(),t=0;t<i.length;t++){var c=$(\"<div/>\").append(i[t]);this._$triggers=this._$triggers.add(c)}this._$triggers.insertAfter(this.$selectAllContainer),Craft.appendHeadHtml(this.actionsHeadHtml),Craft.appendFootHtml(this.actionsFootHtml),Craft.initUiElements(this._$triggers),e&&e.data(\"menubtn\").on(\"optionSelect\",$.proxy(this,\"_handleMenuActionTriggerSubmit\"))},_showExportHud:function(){this.$exportBtn.addClass(\"active\");var t=$(\"<form/>\",{class:\"export-form\"}),s=Craft.ui.createTextField({label:Craft.t(\"app\",\"Limit\"),placeholder:Craft.t(\"app\",\"No limit\"),type:\"number\",min:1}).appendTo(t);$(\"<input/>\",{type:\"submit\",class:\"btn submit fullwidth\",value:Craft.t(\"app\",\"Export\")}).appendTo(t);var n=$(\"<div/>\",{class:\"spinner hidden\"}).appendTo(t);new Garnish.HUD(this.$exportBtn,t).on(\"hide\",$.proxy(function(){this.$exportBtn.removeClass(\"active\")},this));var a=!1;this.addListener(t,\"submit\",function(t){if(t.preventDefault(),!a){a=!0,n.removeClass(\"hidden\");var e=this.getViewParams();delete e.criteria.limit;var i=parseInt(s.find(\"input\").val());i&&!isNaN(i)&&(e.criteria.limit=i),Craft.postActionRequest(\"element-indexes/create-export-token\",e,$.proxy(function(t,e){if(a=!1,n.addClass(\"hidden\"),\"success\"===e){var i={};i[Craft.tokenParam]=t.token;var s=Craft.getCpUrl(\"\",i);document.location.href=s}else Craft.cp.displayError(Craft.t(\"app\",\"An unknown error occurred.\"))},this))}})},_createMenuTriggerList:function(t,e){if(t&&t.length){for(var i=$(\"<ul/>\"),s=0;s<t.length;s++){var n=t[s].type;$(\"<li/>\").append($(\"<a/>\",{id:Craft.formatInputId(n)+\"-actiontrigger\",class:e?\"error\":null,\"data-action\":n,text:t[s].name})).appendTo(i)}return i}}},{defaults:{context:\"index\",modal:null,storageKey:null,criteria:null,batchSize:50,disabledElementIds:[],selectable:!1,multiSelect:!1,buttonContainer:null,hideSidebar:!1,refreshSourcesAction:\"element-indexes/get-source-tree-html\",updateElementsAction:\"element-indexes/get-elements\",submitActionsAction:\"element-indexes/perform-action\",toolbarFixed:null,onAfterInit:$.noop,onSelectSource:$.noop,onSelectSite:$.noop,onUpdateElements:$.noop,onSelectionChange:$.noop,onEnableElements:$.noop,onDisableElements:$.noop,onAfterAction:$.noop}}),Craft.BaseElementIndexView=Garnish.Base.extend({$container:null,$loadingMoreSpinner:null,$elementContainer:null,$scroller:null,elementIndex:null,thumbLoader:null,elementSelect:null,loadingMore:!1,_totalVisible:null,_morePending:null,_handleEnableElements:null,_handleDisableElements:null,init:function(t,e,i){this.elementIndex=t,this.$container=$(e),this.setSettings(i,Craft.BaseElementIndexView.defaults),this.$loadingMoreSpinner=$('<div class=\"centeralign hidden\"><div class=\"spinner loadingmore\"></div></div>').insertAfter(this.$container),this.$elementContainer=this.getElementContainer();var s=this.$elementContainer.children();this.setTotalVisible(s.length),this.setMorePending(this.settings.batchSize&&s.length==this.settings.batchSize),this.thumbLoader=new Craft.ElementThumbLoader,this.thumbLoader.load(s),this.settings.selectable&&(this.elementSelect=new Garnish.Select(this.$elementContainer,s.filter(\":not(.disabled)\"),{multi:this.settings.multiSelect,vertical:this.isVerticalList(),handle:\"index\"===this.settings.context?\".checkbox, .element:first\":null,filter:\":not(a):not(.toggle)\",checkboxMode:this.settings.checkboxMode,onSelectionChange:$.proxy(this,\"onSelectionChange\")}),this._handleEnableElements=$.proxy(function(t){this.elementSelect.addItems(t.elements)},this),this._handleDisableElements=$.proxy(function(t){this.elementSelect.removeItems(t.elements)},this),this.elementIndex.on(\"enableElements\",this._handleEnableElements),this.elementIndex.on(\"disableElements\",this._handleDisableElements)),\"index\"===this.settings.context&&(this._handleElementEditing=$.proxy(function(t){var e=$(t.target);if(\"A\"!==e.prop(\"nodeName\")){var i;if(e.hasClass(\"element\"))i=e;else if(!(i=e.closest(\".element\")).length)return;Garnish.hasAttr(i,\"data-editable\")&&this.createElementEditor(i)}},this),this.elementIndex.trashed||(this.addListener(this.$elementContainer,\"dblclick\",this._handleElementEditing),$.isTouchCapable()&&this.addListener(this.$elementContainer,\"taphold\",this._handleElementEditing))),this.afterInit(),this.settings.batchSize&&(\"index\"===this.settings.context?this.$scroller=Garnish.$scrollContainer:this.$scroller=this.elementIndex.$main,this.$scroller.scrollTop(0),this.addListener(this.$scroller,\"scroll\",\"maybeLoadMore\"),this.maybeLoadMore())},getElementContainer:function(){throw\"Classes that extend Craft.BaseElementIndexView must supply a getElementContainer() method.\"},afterInit:function(){},getAllElements:function(){return this.$elementContainer.children()},getEnabledElements:function(){return this.$elementContainer.children(\":not(.disabled)\")},getElementById:function(t){var e=this.$elementContainer.children('[data-id=\"'+t+'\"]:first');return e.length?e:null},getSelectedElements:function(){if(!this.elementSelect)throw\"This view is not selectable.\";return this.elementSelect.$selectedItems},getSelectedElementIds:function(){var t=this.getSelectedElements(),e=[];if(t)for(var i=0;i<t.length;i++)e.push(t.eq(i).data(\"id\"));return e},selectElement:function(t){if(!this.elementSelect)throw\"This view is not selectable.\";return this.elementSelect.selectItem(t,!0),!0},selectElementById:function(t){if(!this.elementSelect)throw\"This view is not selectable.\";var e=this.getElementById(t);return!!e&&(this.elementSelect.selectItem(e,!0),!0)},selectAllElements:function(){this.elementSelect.selectAll()},deselectAllElements:function(){this.elementSelect.deselectAll()},isVerticalList:function(){return!1},getTotalVisible:function(){return this._totalVisible},setTotalVisible:function(t){this._totalVisible=t},getMorePending:function(){return this._morePending},setMorePending:function(t){this._morePending=t},maybeLoadMore:function(){this.canLoadMore()&&this.loadMore()},canLoadMore:function(){if(!this.getMorePending()||!this.settings.batchSize)return!1;if(this.$scroller[0]!==Garnish.$win[0])return this.$scroller.prop(\"scrollHeight\")-this.$scroller.scrollTop()<=this.$scroller.outerHeight()+15;var t=Garnish.$win.innerHeight(),e=Garnish.$win.scrollTop();return this.$container.offset().top+this.$container.height()<=t+e},loadMore:function(){if(this.getMorePending()&&!this.loadingMore&&this.settings.batchSize){this.loadingMore=!0,this.$loadingMoreSpinner.removeClass(\"hidden\"),this.removeListener(this.$scroller,\"scroll\");var t=this.getLoadMoreParams();Craft.postActionRequest(this.settings.loadMoreElementsAction,t,$.proxy(function(t,e){if(this.loadingMore=!1,this.$loadingMoreSpinner.addClass(\"hidden\"),\"success\"===e){var i=$(t.html);this.appendElements(i),Craft.appendHeadHtml(t.headHtml),Craft.appendFootHtml(t.footHtml),this.elementSelect&&(this.elementSelect.addItems(i.filter(\":not(.disabled)\")),this.elementIndex.updateActionTriggers()),this.setTotalVisible(this.getTotalVisible()+i.length),this.setMorePending(i.length==this.settings.batchSize),this.addListener(this.$scroller,\"scroll\",\"maybeLoadMore\"),this.maybeLoadMore()}},this))}},getLoadMoreParams:function(){var t=$.extend(!0,{},this.settings.params);return t.criteria.offset=this.getTotalVisible(),t},appendElements:function(t){t.appendTo(this.$elementContainer),this.thumbLoader.load(t),this.onAppendElements(t)},onAppendElements:function(t){this.settings.onAppendElements(t),this.trigger(\"appendElements\",{newElements:t})},onSelectionChange:function(){this.settings.onSelectionChange(),this.trigger(\"selectionChange\")},createElementEditor:function(t){Craft.createElementEditor(t.data(\"type\"),t,{elementIndex:this.elementIndex})},disable:function(){this.elementSelect&&this.elementSelect.disable()},enable:function(){this.elementSelect&&this.elementSelect.enable()},destroy:function(){this.$loadingMoreSpinner.remove(),this.thumbLoader.destroy(),delete this.thumbLoader,this.elementSelect&&(this.elementIndex.off(\"enableElements\",this._handleEnableElements),this.elementIndex.off(\"disableElements\",this._handleDisableElements),this.elementSelect.destroy(),delete this.elementSelect),this.base()}},{defaults:{context:\"index\",batchSize:null,params:null,selectable:!1,multiSelect:!1,checkboxMode:!1,loadMoreElementsAction:\"element-indexes/get-more-elements\",onAppendElements:$.noop,onSelectionChange:$.noop}}),Craft.BaseElementSelectInput=Garnish.Base.extend({thumbLoader:null,elementSelect:null,elementSort:null,modal:null,elementEditor:null,$container:null,$elementsContainer:null,$elements:null,$addElementBtn:null,_initialized:!1,init:function(t){if(!$.isPlainObject(t)){for(var e={},i=[\"id\",\"name\",\"elementType\",\"sources\",\"criteria\",\"sourceElementId\",\"limit\",\"modalStorageKey\",\"fieldId\"],s=0;s<i.length&&void 0!==arguments[s];s++)e[i[s]]=arguments[s];t=e}this.setSettings(t,Craft.BaseElementSelectInput.defaults),this.settings.modalStorageKey&&(this.modalStorageKey=\"BaseElementSelectInput.\"+this.settings.modalStorageKey),1==this.settings.limit&&(this.settings.sortable=!1),this.$container=this.getContainer(),this.$container.data(\"elementSelect\",this),this.$elementsContainer=this.getElementsContainer(),this.$addElementBtn=this.getAddElementsBtn(),this.$addElementBtn&&1==this.settings.limit&&this.$addElementBtn.css(\"position\",\"absolute\").css(\"top\",0).css(Craft.left,0),this.thumbLoader=new Craft.ElementThumbLoader,this.initElementSelect(),this.initElementSort(),this.resetElements(),this.$addElementBtn&&this.addListener(this.$addElementBtn,\"activate\",\"showModal\"),this._initialized=!0},get totalSelected(){return this.$elements.length},getContainer:function(){return $(\"#\"+this.settings.id)},getElementsContainer:function(){return this.$container.children(\".elements\")},getElements:function(){return this.$elementsContainer.children()},getAddElementsBtn:function(){return this.$container.children(\".btn.add\")},initElementSelect:function(){this.settings.selectable&&(this.elementSelect=new Garnish.Select({multi:this.settings.sortable,filter:\":not(.delete)\"}))},initElementSort:function(){this.settings.sortable&&(this.elementSort=new Garnish.DragSort({container:this.$elementsContainer,filter:this.settings.selectable?$.proxy(function(){return this.elementSort.$targetItem.hasClass(\"sel\")?this.elementSelect.getSelectedItems():this.elementSort.$targetItem},this):null,ignoreHandleSelector:\".delete\",axis:this.getElementSortAxis(),collapseDraggees:!0,magnetStrength:4,helperLagBase:1.5,onSortChange:this.settings.selectable?$.proxy(function(){this.elementSelect.resetItemOrder()},this):null}))},getElementSortAxis:function(){return\"list\"===this.settings.viewMode?\"y\":null},canAddMoreElements:function(){return!this.settings.limit||this.$elements.length<this.settings.limit},updateAddElementsBtn:function(){this.canAddMoreElements()?this.enableAddElementsBtn():this.disableAddElementsBtn()},disableAddElementsBtn:function(){this.$addElementBtn&&!this.$addElementBtn.hasClass(\"disabled\")&&(this.$addElementBtn.addClass(\"disabled\"),1==this.settings.limit&&(this._initialized?this.$addElementBtn.velocity(\"fadeOut\",Craft.BaseElementSelectInput.ADD_FX_DURATION):this.$addElementBtn.hide()))},enableAddElementsBtn:function(){this.$addElementBtn&&this.$addElementBtn.hasClass(\"disabled\")&&(this.$addElementBtn.removeClass(\"disabled\"),1==this.settings.limit&&(this._initialized?this.$addElementBtn.velocity(\"fadeIn\",Craft.BaseElementSelectInput.REMOVE_FX_DURATION):this.$addElementBtn.show()))},resetElements:function(){null!==this.$elements?this.removeElements(this.$elements):this.$elements=$(),this.addElements(this.getElements())},addElements:function(t){this.thumbLoader.load(t),this.settings.selectable&&this.elementSelect.addItems(t),this.settings.sortable&&this.elementSort.addItems(t),this.settings.editable&&(this._handleShowElementEditor=$.proxy(function(t){var e=$(t.currentTarget);!Garnish.hasAttr(e,\"data-editable\")||e.hasClass(\"disabled\")||e.hasClass(\"loading\")||(this.elementEditor=this.createElementEditor(e))},this),this.addListener(t,\"dblclick\",this._handleShowElementEditor),$.isTouchCapable()&&this.addListener(t,\"taphold\",this._handleShowElementEditor)),t.find(\".delete\").on(\"click\",$.proxy(function(t){this.removeElement($(t.currentTarget).closest(\".element\"))},this)),this.$elements=this.$elements.add(t),this.updateAddElementsBtn()},createElementEditor:function(t,e){return e||(e={}),e.prevalidate=this.settings.prevalidate,Craft.createElementEditor(this.settings.elementType,t,e)},removeElements:function(t){if(this.settings.selectable&&this.elementSelect.removeItems(t),this.modal){for(var e=[],i=0;i<t.length;i++){var s=t.eq(i).data(\"id\");s&&e.push(s)}e.length&&this.modal.elementIndex.enableElementsById(e)}t.children(\"input\").prop(\"disabled\",!0),this.$elements=this.$elements.not(t),this.updateAddElementsBtn(),this.onRemoveElements()},removeElement:function(t){this.removeElements(t),this.animateElementAway(t,function(){t.remove()})},animateElementAway:function(t,e){t.css(\"z-index\",0);var i={opacity:-1};i[\"margin-\"+Craft.left]=-(t.outerWidth()+parseInt(t.css(\"margin-\"+Craft.right))),\"list\"!==this.settings.viewMode&&0!==this.$elements.length||(i[\"margin-bottom\"]=-(t.outerHeight()+parseInt(t.css(\"margin-bottom\")))),t.velocity(i,Craft.BaseElementSelectInput.REMOVE_FX_DURATION,e)},showModal:function(){this.canAddMoreElements()&&(this.modal?this.modal.show():this.modal=this.createModal())},createModal:function(){return Craft.createElementSelectorModal(this.settings.elementType,this.getModalSettings())},getModalSettings:function(){return $.extend({closeOtherModals:!1,storageKey:this.modalStorageKey,sources:this.settings.sources,criteria:this.settings.criteria,multiSelect:1!=this.settings.limit,showSiteMenu:this.settings.showSiteMenu,disabledElementIds:this.getDisabledElementIds(),onSelect:$.proxy(this,\"onModalSelect\")},this.settings.modalSettings)},getSelectedElementIds:function(){for(var t=[],e=0;e<this.$elements.length;e++)t.push(this.$elements.eq(e).data(\"id\"));return t},getDisabledElementIds:function(){var t=this.getSelectedElementIds();return this.settings.sourceElementId&&t.push(this.settings.sourceElementId),t},onModalSelect:function(t){if(this.settings.limit){var e=this.settings.limit-this.$elements.length;t.length>e&&(t=t.slice(0,e))}this.selectElements(t),this.updateDisabledElementsInModal()},selectElements:function(t){for(var e=0;e<t.length;e++){var i=t[e],s=this.createNewElement(i);this.appendElement(s),this.addElements(s),this.animateElementIntoPlace(i.$element,s)}this.onSelectElements(t)},createNewElement:function(t){var e=t.$element.clone();return Craft.setElementSize(e,\"large\"===this.settings.viewMode?\"large\":\"small\"),e.addClass(\"removable\"),e.prepend('<input type=\"hidden\" name=\"'+this.settings.name+'[]\" value=\"'+t.id+'\"><a class=\"delete icon\" title=\"'+Craft.t(\"app\",\"Remove\")+'\"></a>'),e},appendElement:function(t){t.appendTo(this.$elementsContainer)},animateElementIntoPlace:function(t,e){var i=t.offset(),s=e.offset(),n=e.clone().appendTo(Garnish.$bod);e.css(\"visibility\",\"hidden\"),n.css({position:\"absolute\",zIndex:1e4,top:i.top,left:i.left});var a={top:s.top,left:s.left};n.velocity(a,Craft.BaseElementSelectInput.ADD_FX_DURATION,function(){n.remove(),e.css(\"visibility\",\"visible\")})},updateDisabledElementsInModal:function(){this.modal.elementIndex&&this.modal.elementIndex.disableElementsById(this.getDisabledElementIds())},getElementById:function(t){for(var e=0;e<this.$elements.length;e++){var i=this.$elements.eq(e);if(i.data(\"id\")==t)return i}},onSelectElements:function(t){this.trigger(\"selectElements\",{elements:t}),this.settings.onSelectElements(t),window.draftEditor&&window.draftEditor.checkForm()},onRemoveElements:function(){this.trigger(\"removeElements\"),this.settings.onRemoveElements()}},{ADD_FX_DURATION:200,REMOVE_FX_DURATION:200,defaults:{id:null,name:null,fieldId:null,elementType:null,sources:null,criteria:{},sourceElementId:null,viewMode:\"list\",limit:null,showSiteMenu:!1,modalStorageKey:null,modalSettings:{},onSelectElements:$.noop,onRemoveElements:$.noop,sortable:!0,selectable:!0,editable:!0,prevalidate:!1,editorSettings:{}}}),Craft.BaseElementSelectorModal=Garnish.Modal.extend({elementType:null,elementIndex:null,$body:null,$selectBtn:null,$sidebar:null,$sources:null,$sourceToggles:null,$main:null,$search:null,$elements:null,$tbody:null,$primaryButtons:null,$secondaryButtons:null,$cancelBtn:null,$footerSpinner:null,init:function(t,e){this.elementType=t,this.setSettings(e,Craft.BaseElementSelectorModal.defaults);var i=$('<div class=\"modal elementselectormodal\"></div>').appendTo(Garnish.$bod),s=$('<div class=\"body\"><div class=\"spinner big\"></div></div>').appendTo(i),n=$('<div class=\"footer\"/>').appendTo(i);this.base(i,this.settings),this.$footerSpinner=$('<div class=\"spinner hidden\"/>').appendTo(n),this.$primaryButtons=$('<div class=\"buttons right\"/>').appendTo(n),this.$secondaryButtons=$('<div class=\"buttons left secondary-buttons\"/>').appendTo(n),this.$cancelBtn=$('<div class=\"btn\">'+Craft.t(\"app\",\"Cancel\")+\"</div>\").appendTo(this.$primaryButtons),this.$selectBtn=$('<div class=\"btn disabled submit\">'+Craft.t(\"app\",\"Select\")+\"</div>\").appendTo(this.$primaryButtons),this.$body=s,this.addListener(this.$cancelBtn,\"activate\",\"cancel\"),this.addListener(this.$selectBtn,\"activate\",\"selectElements\")},onFadeIn:function(){this.elementIndex?Garnish.isMobileBrowser(!0)||this.elementIndex.$search.trigger(\"focus\"):this._createElementIndex(),this.base()},onSelectionChange:function(){this.updateSelectBtnState()},updateSelectBtnState:function(){this.$selectBtn&&(this.elementIndex.getSelectedElements().length?this.enableSelectBtn():this.disableSelectBtn())},enableSelectBtn:function(){this.$selectBtn.removeClass(\"disabled\")},disableSelectBtn:function(){this.$selectBtn.addClass(\"disabled\")},enableCancelBtn:function(){this.$cancelBtn.removeClass(\"disabled\")},disableCancelBtn:function(){this.$cancelBtn.addClass(\"disabled\")},showFooterSpinner:function(){this.$footerSpinner.removeClass(\"hidden\")},hideFooterSpinner:function(){this.$footerSpinner.addClass(\"hidden\")},cancel:function(){this.$cancelBtn.hasClass(\"disabled\")||this.hide()},selectElements:function(){if(this.elementIndex&&this.elementIndex.getSelectedElements().length){this.elementIndex.view.elementSelect.clearMouseUpTimeout();var t=this.elementIndex.getSelectedElements(),e=this.getElementInfo(t);this.onSelect(e),this.settings.disableElementsOnSelect&&this.elementIndex.disableElements(this.elementIndex.getSelectedElements()),this.settings.hideOnSelect&&this.hide()}},getElementInfo:function(t){for(var e=[],i=0;i<t.length;i++){var s=$(t[i]),n=Craft.getElementInfo(s);e.push(n)}return e},show:function(){this.updateSelectBtnState(),this.base()},onSelect:function(t){this.settings.onSelect(t)},disable:function(){this.elementIndex&&this.elementIndex.disable(),this.base()},enable:function(){this.elementIndex&&this.elementIndex.enable(),this.base()},_createElementIndex:function(){var t={context:\"modal\",elementType:this.elementType,sources:this.settings.sources};null!==this.settings.showSiteMenu&&\"auto\"!==this.settings.showSiteMenu&&(t.showSiteMenu=this.settings.showSiteMenu?\"1\":\"0\"),Craft.postActionRequest(\"elements/get-modal-body\",t,$.proxy(function(t,e){\"success\"===e&&(this.$body.html(t.html),this.$body.has(\".sidebar:not(.hidden)\").length&&this.$body.addClass(\"has-sidebar\"),this.elementIndex=Craft.createElementIndex(this.elementType,this.$body,{context:\"modal\",modal:this,storageKey:this.settings.storageKey,criteria:this.settings.criteria,disabledElementIds:this.settings.disabledElementIds,selectable:!0,multiSelect:this.settings.multiSelect,buttonContainer:this.$secondaryButtons,onSelectionChange:$.proxy(this,\"onSelectionChange\"),hideSidebar:this.settings.hideSidebar}),this.addListener(this.elementIndex.$elements,\"doubletap\",function(t,e){e.firstTap.target===e.secondTap.target&&this.selectElements()}))},this))}},{defaults:{resizable:!0,storageKey:null,sources:null,criteria:null,multiSelect:!1,showSiteMenu:null,disabledElementIds:[],disableElementsOnSelect:!1,hideOnSelect:!0,onCancel:$.noop,onSelect:$.noop,hideIndexSidebar:!1}}),Craft.BaseInputGenerator=Garnish.Base.extend({$source:null,$target:null,$form:null,settings:null,listening:null,timeout:null,init:function(t,e,i){this.$source=$(t),this.$target=$(e),this.$form=this.$source.closest(\"form\"),this.setSettings(i),this.startListening()},setNewSource:function(t){var e=this.listening;this.stopListening(),this.$source=$(t),e&&this.startListening()},startListening:function(){this.listening||(this.listening=!0,this.addListener(this.$source,\"textchange\",\"onSourceTextChange\"),this.addListener(this.$target,\"textchange\",\"onTargetTextChange\"),this.addListener(this.$form,\"submit\",\"onFormSubmit\"))},stopListening:function(){this.listening&&(this.listening=!1,this.timeout&&clearTimeout(this.timeout),this.removeAllListeners(this.$source),this.removeAllListeners(this.$target),this.removeAllListeners(this.$form))},onSourceTextChange:function(){this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout($.proxy(this,\"updateTarget\"),250)},onTargetTextChange:function(){this.$target.get(0)===document.activeElement&&this.stopListening()},onFormSubmit:function(){this.timeout&&clearTimeout(this.timeout),this.updateTarget()},updateTarget:function(){var t=this.$source.val();if(void 0!==t){var e=this.generateTargetValue(t);this.$target.val(e),this.$target.trigger(\"change\"),this.$target.is(\":focus\")&&Craft.selectFullValue(this.$target)}},generateTargetValue:function(t){return t}}),Craft.AdminTable=Garnish.Base.extend({settings:null,totalItems:null,sorter:null,$noItems:null,$table:null,$tbody:null,$deleteBtns:null,init:function(t){this.setSettings(t,Craft.AdminTable.defaults),this.settings.allowDeleteAll||(this.settings.minItems=1),this.$noItems=$(this.settings.noItemsSelector),this.$table=$(this.settings.tableSelector),this.$tbody=this.$table.children(\"tbody\"),this.totalItems=this.$tbody.children().length,this.settings.sortable&&(this.sorter=new Craft.DataTableSorter(this.$table,{onSortChange:$.proxy(this,\"reorderItems\")})),this.$deleteBtns=this.$table.find(\".delete:not(.disabled)\"),this.addListener(this.$deleteBtns,\"click\",\"handleDeleteBtnClick\"),this.updateUI()},addRow:function(t){if(!(this.settings.maxItems&&this.totalItems>=this.settings.maxItems)){var e=$(t).appendTo(this.$tbody),i=e.find(\".delete\");this.settings.sortable&&this.sorter.addItems(e),this.$deleteBtns=this.$deleteBtns.add(i),this.addListener(i,\"click\",\"handleDeleteBtnClick\"),this.totalItems++,this.updateUI()}},reorderItems:function(){if(this.settings.sortable){for(var i=[],t=0;t<this.sorter.$items.length;t++){var e=$(this.sorter.$items[t]).attr(this.settings.idAttribute);i.push(e)}var s={ids:JSON.stringify(i)};Craft.postActionRequest(this.settings.reorderAction,s,$.proxy(function(t,e){\"success\"===e&&(t.success?(this.onReorderItems(i),Craft.cp.displayNotice(Craft.t(\"app\",this.settings.reorderSuccessMessage))):Craft.cp.displayError(Craft.t(\"app\",this.settings.reorderFailMessage)))},this))}},handleDeleteBtnClick:function(t){if(!(this.settings.minItems&&this.totalItems<=this.settings.minItems)){var e=$(t.target).closest(\"tr\");this.confirmDeleteItem(e)&&this.deleteItem(e)}},confirmDeleteItem:function(t){var e=this.getItemName(t);return confirm(Craft.t(\"app\",this.settings.confirmDeleteMessage,{name:e}))},deleteItem:function(i){var t={id:this.getItemId(i)};Craft.postActionRequest(this.settings.deleteAction,t,$.proxy(function(t,e){\"success\"===e&&this.handleDeleteItemResponse(t,i)},this))},handleDeleteItemResponse:function(t,e){var i=this.getItemId(e),s=this.getItemName(e);t.success?(this.sorter&&this.sorter.removeItems(e),e.remove(),this.totalItems--,this.updateUI(),this.onDeleteItem(i),Craft.cp.displayNotice(Craft.t(\"app\",this.settings.deleteSuccessMessage,{name:s}))):Craft.cp.displayError(Craft.t(\"app\",this.settings.deleteFailMessage,{name:s}))},onReorderItems:function(t){this.settings.onReorderItems(t)},onDeleteItem:function(t){this.settings.onDeleteItem(t)},getItemId:function(t){return t.attr(this.settings.idAttribute)},getItemName:function(t){return Craft.escapeHtml(t.attr(this.settings.nameAttribute))},updateUI:function(){if(0===this.totalItems?(this.$table.hide(),this.$noItems.removeClass(\"hidden\")):(this.$table.show(),this.$noItems.addClass(\"hidden\")),this.settings.sortable){var t=this.$table.find(\".move\");1===this.totalItems?t.addClass(\"disabled\"):t.removeClass(\"disabled\")}this.settings.minItems&&this.totalItems<=this.settings.minItems?this.$deleteBtns.addClass(\"disabled\"):this.$deleteBtns.removeClass(\"disabled\"),this.settings.newItemBtnSelector&&(this.settings.maxItems&&this.totalItems>=this.settings.maxItems?$(this.settings.newItemBtnSelector).addClass(\"hidden\"):$(this.settings.newItemBtnSelector).removeClass(\"hidden\"))}},{defaults:{tableSelector:null,noItemsSelector:null,newItemBtnSelector:null,idAttribute:\"data-id\",nameAttribute:\"data-name\",sortable:!1,allowDeleteAll:!0,minItems:0,maxItems:null,reorderAction:null,deleteAction:null,reorderSuccessMessage:Craft.t(\"app\",\"New order saved.\"),reorderFailMessage:Craft.t(\"app\",\"Couldn\u2019t save new order.\"),confirmDeleteMessage:Craft.t(\"app\",\"Are you sure you want to delete \u201c{name}\u201d?\"),deleteSuccessMessage:Craft.t(\"app\",\"\u201c{name}\u201d deleted.\"),deleteFailMessage:Craft.t(\"app\",\"Couldn\u2019t delete \u201c{name}\u201d.\"),onReorderItems:$.noop,onDeleteItem:$.noop}}),Craft.AssetEditor=Craft.BaseElementEditor.extend({reloadIndex:!1,updateForm:function(t){if(this.base(t),this.$element.data(\"id\")){var e=this.$fieldsContainer.find(\"> .meta > .image-preview-container.editable\");e.length&&this.addListener(e,\"click\",\"showImageEditor\")}},showImageEditor:function(){new Craft.AssetImageEditor(this.$element.data(\"id\"),{onSave:function(){this.reloadIndex=!0,this.reloadForm()}.bind(this),allowDegreeFractions:Craft.isImagick})},onHideHud:function(){this.reloadIndex&&this.settings.elementIndex&&this.settings.elementIndex.updateElements(),this.base()}}),Craft.registerElementEditorClass(\"craft\\\\elements\\\\Asset\",Craft.AssetEditor),Craft.AssetImageEditor=Garnish.Modal.extend({$body:null,$footer:null,$imageTools:null,$buttons:null,$cancelBtn:null,$replaceBtn:null,$saveBtn:null,$editorContainer:null,$straighten:null,$croppingCanvas:null,$spinnerCanvas:null,canvas:null,image:null,viewport:null,focalPoint:null,grid:null,croppingCanvas:null,clipper:null,croppingRectangle:null,cropperHandles:null,cropperGrid:null,croppingShade:null,imageStraightenAngle:0,viewportRotation:0,originalWidth:0,originalHeight:0,imageVerticeCoords:null,zoomRatio:1,animationInProgress:!1,currentView:\"\",assetId:null,cacheBust:null,draggingCropper:!1,scalingCropper:!1,draggingFocal:!1,previousMouseX:0,previousMouseY:0,shiftKeyHeld:!1,editorHeight:0,editorWidth:0,cropperState:!1,scaleFactor:1,flipData:{},focalPointState:!1,croppingConstraint:!1,spinnerInterval:null,maxImageSize:null,lastLoadedDimensions:null,imageIsLoading:!1,renderImage:null,renderCropper:null,init:function(t,e){this.cacheBust=Date.now(),this.setSettings(e,Craft.AssetImageEditor.defaults),this.assetId=t,this.flipData={x:0,y:0},this.$container=$('<form class=\"modal fitted imageeditor\"></form>').appendTo(Garnish.$bod),this.$body=$('<div class=\"body\"></div>').appendTo(this.$container),this.$footer=$('<div class=\"footer\"/>').appendTo(this.$container),this.base(this.$container,this.settings),this.$buttons=$('<div class=\"buttons right\"/>').appendTo(this.$footer),this.$cancelBtn=$('<div class=\"btn cancel\">'+Craft.t(\"app\",\"Cancel\")+\"</div>\").appendTo(this.$buttons),this.$replaceBtn=$('<div class=\"btn submit save replace\">'+Craft.t(\"app\",\"Save\")+\"</div>\").appendTo(this.$buttons),this.settings.allowSavingAsNew&&(this.$saveBtn=$('<div class=\"btn submit save copy\">'+Craft.t(\"app\",\"Save as a new asset\")+\"</div>\").appendTo(this.$buttons),this.addListener(this.$saveBtn,\"activate\",this.saveImage.bind(this))),this.addListener(this.$replaceBtn,\"activate\",this.saveImage.bind(this)),this.addListener(this.$cancelBtn,\"activate\",$.proxy(this,\"hide\")),this.removeListener(this.$shade,\"click\"),this.maxImageSize=this.getMaxImageSize(),Craft.postActionRequest(\"assets/image-editor\",{assetId:t},$.proxy(this,\"loadEditor\"))},getMaxImageSize:function(){var t=Garnish.$doc.get(0).documentElement.clientWidth,e=Garnish.$doc.get(0).documentElement.clientHeight;return Math.max(e,t)*(1<window.devicePixelRatio?2:1)},loadEditor:function(r){r.html||alert(Craft.t(\"app\",\"Could not load the image editor.\")),this.$body.html(r.html),this.$tabs=$(\".tabs li\",this.$body),this.$viewsContainer=$(\".views\",this.$body),this.$views=$(\"> div\",this.$viewsContainer),this.$imageTools=$(\".image-container .image-tools\",this.$body),this.$editorContainer=$(\".image-container .image\",this.$body),this.editorHeight=this.$editorContainer.innerHeight(),this.editorWidth=this.$editorContainer.innerWidth(),this._showSpinner(),this.updateSizeAndPosition(),this.canvas=new fabric.StaticCanvas(\"image-canvas\"),this.$croppingCanvas=$(\"#cropping-canvas\",this.$editorContainer),this.$croppingCanvas.width(this.editorWidth),this.$croppingCanvas.height(this.editorHeight),this.canvas.enableRetinaScaling=!0,this.renderImage=function(){Garnish.requestAnimationFrame(this.canvas.renderAll.bind(this.canvas))}.bind(this);var t=Craft.getActionUrl(\"assets/edit-image\",{assetId:this.assetId,size:this.maxImageSize,cacheBust:this.cacheBust});fabric.Image.fromURL(t,$.proxy(function(t){this.image=t,this.image.set({originX:\"center\",originY:\"center\",left:this.editorWidth/2,top:this.editorHeight/2}),this.canvas.add(this.image),this.originalHeight=this.image.getHeight(),this.originalWidth=this.image.getWidth(),this.zoomRatio=1,this.lastLoadedDimensions=this.getScaledImageDimensions(),this._setFittedImageVerticeCoordinates(),this._repositionEditorElements();var e={imageDimensions:this.getScaledImageDimensions(),offsetX:0,offsetY:0},i=!1;if(r.focalPoint){var s=r.focalPoint,n=e.imageDimensions.width*s.x,a=e.imageDimensions.height*s.y;e.offsetX=n-e.imageDimensions.width/2,e.offsetY=a-e.imageDimensions.height/2,i=!0}this.storeFocalPointState(e),i&&this._createFocalPoint(),this._createViewport(),this.storeCropperState(),this._addControlListeners(),this.addListener(this.$croppingCanvas,\"mousemove\",this._handleMouseMove.bind(this)),this.addListener(this.$croppingCanvas,\"mousedown\",this._handleMouseDown.bind(this)),this.addListener(this.$croppingCanvas,\"mouseup\",this._handleMouseUp.bind(this)),this.addListener(this.$croppingCanvas,\"mouseout\",function(t){this._handleMouseUp(t),this._handleMouseMove(t)}.bind(this)),this._hideSpinner(),this.renderImage(),this.$tabs.first().trigger(\"click\")},this))},_reloadImage:function(){if(!this.imageIsLoading){this.imageIsLoading=!0,this.maxImageSize=this.getMaxImageSize();var t=Craft.getActionUrl(\"assets/edit-image\",{assetId:this.assetId,size:this.maxImageSize,cacheBust:this.cacheBust});this.image.setSrc(t,function(t){this.originalHeight=t.getHeight(),this.originalWidth=t.getWidth(),this.lastLoadedDimensions={width:this.originalHeight,height:this.originalWidth},this.updateSizeAndPosition(),this.renderImage(),this.imageIsLoading=!1}.bind(this))}},updateSizeAndPosition:function(){if(this.$container){var t=window.innerWidth,e=window.innerHeight;this.$container.css({width:t,\"min-width\":t,left:0,height:e,\"min-height\":e,top:0}),this.$body.css({height:e-58}),t<e?this.$container.addClass(\"vertical\"):this.$container.removeClass(\"vertical\"),this.$spinnerCanvas&&this.$spinnerCanvas.css({left:this.$spinnerCanvas.parent().width()/2-this.$spinnerCanvas.width()/2+\"px\",top:this.$spinnerCanvas.parent().height()/2-this.$spinnerCanvas.height()/2+\"px\"}),this.$editorContainer&&this.image&&this._repositionEditorElements()}},_repositionEditorElements:function(){var t={width:this.editorWidth,height:this.editorHeight};this.editorHeight=this.$editorContainer.innerHeight(),this.editorWidth=this.$editorContainer.innerWidth(),this.canvas.setDimensions({width:this.editorWidth,height:this.editorHeight});var e=this.getScaledImageDimensions();if(\"crop\"===this.currentView){this.zoomRatio=this.getZoomToFitRatio(this.getScaledImageDimensions());var i=this._getBoundingRectangle(this.imageVerticeCoords);this._setFittedImageVerticeCoordinates(),this._repositionCropper(i)}else this.zoomRatio=this.getZoomToCoverRatio(this.getScaledImageDimensions())*this.scaleFactor;this._repositionImage(t),this._repositionViewport(),this._repositionFocalPoint(t),this._zoomImage(),this.renderImage(),(1.5<e.width/this.lastLoadedDimensions.width||1.5<e.height/this.lastLoadedDimensions.height)&&this._reloadImage()},_repositionImage:function(t){this.image.set({left:this.image.left-(t.width-this.editorWidth)/2,top:this.image.top-(t.height-this.editorHeight)/2})},_createViewport:function(){this.viewport=new fabric.Rect({width:this.image.width,height:this.image.height,fill:\"rgba(127,0,0,1)\",originX:\"center\",originY:\"center\",globalCompositeOperation:\"destination-in\",left:this.image.left,top:this.image.top}),this.canvas.add(this.viewport),this.renderImage()},_createFocalPoint:function(){var t=this.focalPointState,e=this.getScaledImageDimensions().width/t.imageDimensions.width,i=t.offsetX*e*this.zoomRatio*this.scaleFactor,s=t.offsetY*e*this.zoomRatio*this.scaleFactor;i+=this.image.left,s+=this.image.top;var n=0,a=0;this.viewport&&0===t.offsetX&&0===t.offsetY&&(a=\"crop\"!==this.currentView?(n=this.viewport.left-this.image.left,this.viewport.top-this.image.top):(n=this.clipper.left-this.image.left,this.clipper.top-this.image.top),i+=n,s+=a,t.offsetX+=n/(e*this.zoomRatio*this.scaleFactor),t.offsetY+=a/(e*this.zoomRatio*this.scaleFactor)),this.focalPoint=new fabric.Group([new fabric.Circle({radius:8,fill:\"rgba(0,0,0,0.5)\",strokeWidth:2,stroke:\"rgba(255,255,255,0.8)\",left:0,top:0,originX:\"center\",originY:\"center\"}),new fabric.Circle({radius:1,fill:\"rgba(255,255,255,0)\",strokeWidth:2,stroke:\"rgba(255,255,255,0.8)\",left:0,top:0,originX:\"center\",originY:\"center\"})],{originX:\"center\",originY:\"center\",left:i,top:s}),this.storeFocalPointState(t),this.canvas.add(this.focalPoint)},toggleFocalPoint:function(){this.focalPoint?(this.canvas.remove(this.focalPoint),this.focalPoint=null):this._createFocalPoint(),this.renderImage()},_repositionViewport:function(){if(this.viewport){var t={left:this.editorWidth/2,top:this.editorHeight/2};if(\"crop\"===this.currentView)t.width=this.editorWidth,t.height=this.editorHeight;else if(this.cropperState){var e=this.cropperState,i=this.getScaledImageDimensions().width/e.imageDimensions.width;t.width=e.width*i*this.zoomRatio,t.height=e.height*i*this.zoomRatio,this.image.set({left:this.editorWidth/2-e.offsetX*i,top:this.editorHeight/2-e.offsetY*i})}else $.extend(t,this.getScaledImageDimensions());this.viewport.set(t)}},_repositionFocalPoint:function(t){if(this.focalPoint){var e=this.focalPoint.left-this.editorWidth/2,i=this.focalPoint.top-this.editorHeight/2,s=this.image.width,n=this.getScaledImageDimensions().width*this.zoomRatio/s/this.scaleFactor;e-=(t.width-this.editorWidth)/2,i-=(t.height-this.editorHeight)/2,e*=n,i*=n,this.focalPoint.set({left:this.editorWidth/2+e,top:this.editorHeight/2+i})}},hasOrientationChanged:function(){return this.viewportRotation%180!=0},getScaledImageDimensions:function(){var t=this.originalHeight/this.originalWidth,e={};return this.editorHeight/this.editorWidth<t?(e.height=Math.min(this.editorHeight,this.originalHeight),e.width=Math.round(this.originalWidth/(this.originalHeight/e.height))):(e.width=Math.min(this.editorWidth,this.originalWidth),e.height=Math.round(this.originalHeight*(e.width/this.originalWidth))),e},_zoomImage:function(){var t=this.getScaledImageDimensions();this.image.set({width:t.width*this.zoomRatio,height:t.height*this.zoomRatio})},_addControlListeners:function(){this.addListener(this.$tabs,\"click\",\"_handleTabClick\"),this.addListener($(\".focal-point\"),\"click\",function(t){this.toggleFocalPoint(t)}.bind(this)),this.addListener($(\".rotate-left\"),\"click\",function(){this.rotateImage(-90)}.bind(this)),this.addListener($(\".rotate-right\"),\"click\",function(){this.rotateImage(90)}.bind(this)),this.addListener($(\".flip-vertical\"),\"click\",function(){this.flipImage(\"y\")}.bind(this)),this.addListener($(\".flip-horizontal\"),\"click\",function(){this.flipImage(\"x\")}.bind(this)),this.straighteningInput=new Craft.SlideRuleInput(\"slide-rule\",{onStart:function(){this._showGrid()}.bind(this),onChange:function(t){this.straighten(t)}.bind(this),onEnd:function(){this._hideGrid(),this._cleanupFocalPointAfterStraighten()}.bind(this)}),this.addListener(Garnish.$doc,\"keydown\",function(t){t.keyCode===Garnish.SHIFT_KEY&&(this.shiftKeyHeld=!0)}.bind(this)),this.addListener(Garnish.$doc,\"keyup\",function(t){t.keyCode===Garnish.SHIFT_KEY&&(this.shiftKeyHeld=!1)}.bind(this)),new Garnish.MenuBtn($(\".crop .menubtn\",this.$container),{onOptionSelect:function(t){$(\".constraint\",this.$container).html($(t).html()),this.setCroppingConstraint($(t).data(\"constraint\")),this.enforceCroppingConstraint()}.bind(this)}).menu.$container.addClass(\"dark\")},_handleTabClick:function(t){if(!this.animationInProgress){var e=$(t.currentTarget),i=e.data(\"view\");this.$tabs.removeClass(\"selected\"),e.addClass(\"selected\"),this.showView(i)}},showView:function(t){this.currentView!==t&&(this.$views.addClass(\"hidden\"),this.$views.filter('[data-view=\"'+t+'\"]').removeClass(\"hidden\"),\"rotate\"===t?this.enableSlider():this.disableSlider(),this.updateSizeAndPosition(),\"crop\"===this.currentView&&\"crop\"!==t?this.disableCropMode():\"crop\"!==this.currentView&&\"crop\"===t&&this.enableCropMode(),this.currentView=t)},storeCropperState:function(t){if(t)this.cropperState=t;else if(this.clipper){var e=1/this.zoomRatio;this.cropperState={offsetX:(this.clipper.left-this.image.left)*e,offsetY:(this.clipper.top-this.image.top)*e,height:this.clipper.height*e,width:this.clipper.width*e,imageDimensions:this.getScaledImageDimensions()}}else{var i=this.getScaledImageDimensions();this.cropperState={offsetX:0,offsetY:0,height:i.height,width:i.width,imageDimensions:i}}},storeFocalPointState:function(t){if(t)this.focalPointState=t;else if(this.focalPoint){var e=1/this.zoomRatio;this.focalPointState={offsetX:(this.focalPoint.left-this.image.left)*e/this.scaleFactor,offsetY:(this.focalPoint.top-this.image.top)*e/this.scaleFactor,imageDimensions:this.getScaledImageDimensions()}}},rotateImage:function(e){if(!this.animationInProgress){if(90!==e&&-90!==e)return!1;this.animationInProgress=!0,this.viewportRotation+=e,this.viewportRotation=parseInt((this.viewportRotation+360)%360,10);var t,i=this.image.angle+e,s=this.getScaledImageDimensions();t=this.hasOrientationChanged()?this.getZoomToCoverRatio({height:s.width,width:s.height}):this.getZoomToCoverRatio(s),this.zoomRatio>t&&(t=this.zoomRatio);var n={angle:90===e?\"+=90\":\"-=90\"},a={angle:i,width:s.width*t,height:s.height*t},r=1;this.scaleFactor<1?(r=1/this.scaleFactor,this.scaleFactor=1):(this.viewport.width>this.editorHeight?r=this.editorHeight/this.viewport.width:this.viewport.height>this.editorWidth&&(r=this.editorWidth/this.viewport.height),this.scaleFactor=r),r<1&&(a.width*=r,a.height*=r);var o=this.cropperState,l=o.offsetX,h=o.offsetY,d=e*(Math.PI/180),c=l*Math.cos(d)-h*Math.sin(d),u=l*Math.sin(d)+h*Math.cos(d),p=s.width/o.imageDimensions.width,g=c*p*this.zoomRatio*this.scaleFactor,f=u*p*this.zoomRatio*this.scaleFactor;a.left=this.editorWidth/2-g,a.top=this.editorHeight/2-f,o.offsetX=c,o.offsetY=u;var m=o.width;o.width=o.height,o.height=m,this.storeCropperState(o),this.focalPoint&&this.canvas.remove(this.focalPoint),this.viewport.animate(n,{duration:this.settings.animationDuration,onComplete:function(){var t=this.viewport.height*r;this.viewport.height=this.viewport.width*r,this.viewport.width=t,this.viewport.set({angle:0})}.bind(this)}),this.image.animate(a,{onChange:this.canvas.renderAll.bind(this.canvas),duration:this.settings.animationDuration,onComplete:function(){var t=parseFloat((this.image.angle+360)%360);this.image.set({angle:t}),this.animationInProgress=!1,this.focalPoint?(this._adjustFocalPointByAngle(e),this.straighten(this.straighteningInput),this.canvas.add(this.focalPoint)):this._resetFocalPointPosition()}.bind(this)})}},flipImage:function(t){if(!this.animationInProgress){this.animationInProgress=!0,this.hasOrientationChanged()&&(t=\"y\"===t?\"x\":\"y\"),this.focalPoint?this.canvas.remove(this.focalPoint):this._resetFocalPointPosition();var e=this.editorWidth/2,i=this.editorHeight/2;this.straighteningInput.setValue(-this.imageStraightenAngle),this.imageStraightenAngle=-this.imageStraightenAngle;var s,n,a={angle:this.viewportRotation+this.imageStraightenAngle},r=this.cropperState,o=this.focalPointState;\"y\"===t&&this.hasOrientationChanged()||\"y\"!==t&&!this.hasOrientationChanged()?(r.offsetX=-r.offsetX,o.offsetX=-o.offsetX,n=this.image.left-e,a.left=e-n):(r.offsetY=-r.offsetY,o.offsetY=-o.offsetY,s=this.image.top-i,a.top=i-s),\"y\"===t?(a.scaleY=-1*this.image.scaleY,this.flipData.y=1-this.flipData.y):(a.scaleX=-1*this.image.scaleX,this.flipData.x=1-this.flipData.x),this.storeCropperState(r),this.storeFocalPointState(o),this.image.animate(a,{onChange:this.canvas.renderAll.bind(this.canvas),duration:this.settings.animationDuration,onComplete:function(){this.animationInProgress=!1,this.focalPoint&&(this._adjustFocalPointByAngle(0),this.canvas.add(this.focalPoint))}.bind(this)})}},straighten:function(t){if(!this.animationInProgress){this.animationInProgress=!0;var e=this.image.angle;this.imageStraightenAngle=(this.settings.allowDegreeFractions?parseFloat(t.value):Math.round(parseFloat(t.value)))%360,this.image.set({angle:this.viewportRotation+this.imageStraightenAngle}),this.zoomRatio=this.getZoomToCoverRatio(this.getScaledImageDimensions())*this.scaleFactor,this._zoomImage(),this.cropperState&&this._adjustEditorElementsOnStraighten(e),this.renderImage(),this.animationInProgress=!1}},_adjustEditorElementsOnStraighten:function(t){var e,i,s,n,a,r=this.getScaledImageDimensions(),o=this.image.angle-t,l=this.cropperState,h=this.zoomRatio,d=1;do{var c=l.offsetX,u=l.offsetY,p=o*(Math.PI/180);s=c*Math.cos(p)-u*Math.sin(p),n=c*Math.sin(p)+u*Math.cos(p),e=s*h*(a=r.width/l.imageDimensions.width),i=n*h*a;var g=this.getImageVerticeCoords(h),f={width:this.viewport.width,height:this.viewport.height,left:this.editorWidth/2-this.viewport.width/2+e,top:this.editorHeight/2-this.viewport.height/2+i};h*=d=this._getZoomRatioToFitRectangle(f,g)}while(1!==d);this.image.set({left:this.editorWidth/2-e,top:this.editorHeight/2-i}),l.offsetX=s,l.offsetY=n,l.width=this.viewport.width/h/a,l.height=this.viewport.height/h/a,this.storeCropperState(l),this.zoomRatio=h,this.focalPoint?(this._adjustFocalPointByAngle(o),this._isCenterInside(this.focalPoint,this.viewport)?this.focalPoint.set({opacity:1}):this.focalPoint.set({opacity:0})):0!=o&&this._resetFocalPointPosition(),this._zoomImage()},_cleanupFocalPointAfterStraighten:function(){if(this.focalPoint&&!this._isCenterInside(this.focalPoint,this.viewport)){this.focalPoint.set({opacity:1});var t=this.focalPointState;t.offsetX=0,t.offsetY=0,this.storeFocalPointState(t),this.toggleFocalPoint()}},_resetFocalPointPosition:function(){var t=this.focalPointState;t.offsetX=0,t.offsetY=0,this.storeFocalPointState(t)},_isCenterInside:function(t,e){return t.left>e.left-e.width/2&&t.top>e.top-e.height/2&&t.left<e.left+e.width/2&&t.top<e.top+e.height/2},_adjustFocalPointByAngle:function(t){var e=t*(Math.PI/180),i=this.focalPointState,s=i.offsetX,n=i.offsetY,a=s*Math.cos(e)-n*Math.sin(e),r=s*Math.sin(e)+n*Math.cos(e),o=this.getScaledImageDimensions().width/i.imageDimensions.width,l=a*o*this.zoomRatio,h=r*o*this.zoomRatio;this.focalPoint.left=this.image.left+l,this.focalPoint.top=this.image.top+h,i.offsetX=a,i.offsetY=r,this.storeFocalPointState(i)},_getZoomRatioToFitRectangle:function(t,e){for(var i,s,n=this._getRectangleVertices(t),a=0;a<n.length&&(i=n[a],this.arePointsInsideRectangle([i],e));a++)i=!1;if(i){var r=this._getEdgeCrossed(e,i),o=t.left+t.width/2,l=t.top+t.height/2,h=Math.abs((r[1].y-r[0].y)*i.x-(r[1].x-r[0].x)*i.y+r[1].x*r[0].y-r[1].y*r[0].x)/Math.sqrt(Math.pow(r[1].y-r[0].y,2)+Math.pow(r[1].x-r[0].x,2)),d=Math.abs((r[1].y-r[0].y)*o-(r[1].x-r[0].x)*l+r[1].x*r[0].y-r[1].y*r[0].x)/Math.sqrt(Math.pow(r[1].y-r[0].y,2)+Math.pow(r[1].x-r[0].x,2));s=(h+d)/d}else s=1;return s},saveImage:function(t){var e=$(t.currentTarget);if(e.hasClass(\"disabled\"))return!1;$(\".btn\",this.$buttons).addClass(\"disabled\"),this.$buttons.append('<div class=\"spinner\"></div>');var i={assetId:this.assetId,viewportRotation:this.viewportRotation,imageRotation:this.imageStraightenAngle,replace:e.hasClass(\"replace\")?1:0};if(this.cropperState){var s={};s.height=this.cropperState.height,s.width=this.cropperState.width,s.offsetX=this.cropperState.offsetX,s.offsetY=this.cropperState.offsetY,i.imageDimensions=this.cropperState.imageDimensions,i.cropData=s}else i.imageDimensions=this.getScaledImageDimensions();this.focalPoint&&(i.focalPoint=this.focalPointState),i.flipData=this.flipData,i.zoom=this.zoomRatio,Craft.postActionRequest(\"assets/save-image\",i,function(t){this.$buttons.find(\".btn\").removeClass(\"disabled\").end().find(\".spinner\").remove(),t.error?alert(t.error):(this.onSave(),this.hide(),Craft.cp.runQueue())}.bind(this))},getZoomToCoverRatio:function(t){var e=Math.abs(this.imageStraightenAngle)*(Math.PI/180),i=Math.sin(e)*t.height+Math.cos(e)*t.width,s=Math.sin(e)*t.width+Math.cos(e)*t.height;return Math.max(i/t.width,s/t.height)},getZoomToFitRatio:function(t){var e=this._getImageBoundingBox(t),i=1;if(e.height>this.editorHeight||e.width>this.editorWidth){var s=this.editorHeight/e.height,n=this.editorWidth/e.width;i=Math.min(n,s)}return i},getCombinedZoomRatio:function(t){return this.getZoomToCoverRatio(t)/this.getZoomToFitRatio(t)},_showGrid:function(){if(!this.grid){var t,e={strokeWidth:1,stroke:\"rgba(255,255,255,0.5)\"},i=this.viewport.width,s=this.viewport.height,n=i/9,a=s/9,r=[new fabric.Rect({strokeWidth:2,stroke:\"rgba(255,255,255,1)\",originX:\"center\",originY:\"center\",width:i,height:s,left:i/2,top:s/2,fill:\"rgba(255,255,255,0)\"})];for(t=1;t<=8;t++)r.push(new fabric.Line([t*n,0,t*n,s],e));for(t=1;t<=8;t++)r.push(new fabric.Line([0,t*a,i,t*a],e));this.grid=new fabric.Group(r,{left:this.editorWidth/2,top:this.editorHeight/2,originX:\"center\",originY:\"center\",angle:this.viewport.angle}),this.canvas.add(this.grid),this.renderImage()}},_hideGrid:function(){this.canvas.remove(this.grid),this.grid=null,this.renderImage()},onFadeOut:function(){this.removeListener(this.$croppingCanvas,\"mousemove\",this._handleMouseMove.bind(this)),this.removeListener(this.$croppingCanvas,\"mousedown\",this._handleMouseDown.bind(this)),this.removeListener(this.$croppingCanvas,\"mouseup\",this._handleMouseUp.bind(this)),this.removeListener(this.$croppingCanvas,\"mouseout\",function(t){this._handleMouseUp(t),this._handleMouseMove(t)}.bind(this)),this.destroy()},show:function(){this.base(),$(\"html\").addClass(\"noscroll\")},hide:function(){this.removeAllListeners(),this.straighteningInput.removeAllListeners(),$(\"html\").removeClass(\"noscroll\"),this.base()},onSave:function(){this.settings.onSave(),this.trigger(\"save\")},enableSlider:function(){this.$imageTools.removeClass(\"hidden\")},disableSlider:function(){this.$imageTools.addClass(\"hidden\")},enableCropMode:function(){var t=this.getScaledImageDimensions();this.zoomRatio=this.getZoomToFitRatio(t);var e={width:this.editorWidth,height:this.editorHeight},i={width:t.width*this.zoomRatio,height:t.height*this.zoomRatio,left:this.editorWidth/2,top:this.editorHeight/2},s=function(){this._setFittedImageVerticeCoordinates();var t=this.cropperState,e=this.getScaledImageDimensions(),i=e.width/t.imageDimensions.width,s={left:this.image.left+t.offsetX*i*this.zoomRatio,top:this.image.top+t.offsetY*i*this.zoomRatio,width:t.width*i*this.zoomRatio,height:t.height*i*this.zoomRatio};this._showCropper(s),this.focalPoint&&(i=e.width/this.focalPointState.imageDimensions.width,this.focalPoint.left=this.image.left+this.focalPointState.offsetX*i*this.zoomRatio,this.focalPoint.top=this.image.top+this.focalPointState.offsetY*i*this.zoomRatio,this.canvas.add(this.focalPoint))}.bind(this);this._editorModeTransition(s,i,e)},disableCropMode:function(){var t={},e={left:this.editorWidth/2,top:this.editorHeight/2};this._hideCropper();var i=this.getZoomToCoverRatio(this.getScaledImageDimensions())*this.scaleFactor,s=i/this.zoomRatio;this.zoomRatio=i;var n=(this.clipper.left-this.image.left)*s,a=(this.clipper.top-this.image.top)*s;e.left=this.editorWidth/2-n,e.top=this.editorHeight/2-a,t.height=this.clipper.height*s,t.width=this.clipper.width*s,this.focalPoint&&(!this.focalPoint||this._isCenterInside(this.focalPoint,this.clipper))||(this.focalPoint&&this.toggleFocalPoint(),this._resetFocalPointPosition());var r=function(){if(this.focalPoint){var t=this.getScaledImageDimensions().width/this.focalPointState.imageDimensions.width;this.focalPoint.left=this.image.left+this.focalPointState.offsetX*t*this.zoomRatio,this.focalPoint.top=this.image.top+this.focalPointState.offsetY*t*this.zoomRatio,this.canvas.add(this.focalPoint)}}.bind(this);this._editorModeTransition(r,e,t)},_editorModeTransition:function(t,e,i){this.animationInProgress||(this.animationInProgress=!0,this.focalPoint&&(this.canvas.remove(this.focalPoint),this.renderImage()),this.image.animate(e,{onChange:this.canvas.renderAll.bind(this.canvas),duration:this.settings.animationDuration,onComplete:function(){t(),this.animationInProgress=!1,this.renderImage()}.bind(this)}),this.viewport.animate(i,{duration:this.settings.animationDuration}))},_showSpinner:function(){this.$spinnerCanvas=$('<canvas id=\"spinner-canvas\"></canvas>').appendTo($(\".image\",this.$container));var i=document.getElementById(\"spinner-canvas\").getContext(\"2d\"),s=new Date,n=i.canvas.width,a=i.canvas.height;this.spinnerInterval=window.setInterval(function(){var t=parseInt((new Date-s)/1e3*16)/16;i.save(),i.clearRect(0,0,n,a),i.translate(n/2,a/2),i.rotate(2*Math.PI*t);for(var e=0;e<16;e++)i.beginPath(),i.rotate(2*Math.PI/16),i.moveTo(n/10,0),i.lineTo(n/4,0),i.lineWidth=n/30,i.strokeStyle=\"rgba(255,255,255,\"+e/16+\")\",i.stroke();i.restore()},1e3/30)},_hideSpinner:function(){window.clearInterval(this.spinnerInterval),this.$spinnerCanvas.remove(),this.$spinnerCanvas=null},_showCropper:function(t){this._setupCropperLayer(t),this._redrawCropperElements(),this.renderCropper()},_hideCropper:function(){this.clipper&&(this.croppingCanvas.remove(this.clipper),this.croppingCanvas.remove(this.croppingShade),this.croppingCanvas.remove(this.cropperHandles),this.croppingCanvas.remove(this.cropperGrid),this.croppingCanvas.remove(this.croppingRectangle),this.croppingCanvas=null,this.renderCropper=null)},_setupCropperLayer:function(t){this.croppingCanvas=new fabric.StaticCanvas(\"cropping-canvas\",{backgroundColor:\"rgba(0,0,0,0)\",hoverCursor:\"default\",selection:!1}),this.croppingCanvas.setDimensions({width:this.editorWidth,height:this.editorHeight}),this.renderCropper=function(){Garnish.requestAnimationFrame(this.croppingCanvas.renderAll.bind(this.croppingCanvas))}.bind(this),$(\"#cropping-canvas\",this.$editorContainer).css({position:\"absolute\",top:0,left:0}),this.croppingShade=new fabric.Rect({left:this.editorWidth/2,top:this.editorHeight/2,originX:\"center\",originY:\"center\",width:this.editorWidth,height:this.editorHeight,fill:\"rgba(0,0,0,0.7)\"});var e=this.getScaledImageDimensions(),i=0===this.imageStraightenAngle?1:1.2*this.getCombinedZoomRatio(e),s=e.width/i,n=e.height/i;if(this.hasOrientationChanged()){var a=n;n=s,s=a}this.clipper=new fabric.Rect({left:this.editorWidth/2,top:this.editorHeight/2,originX:\"center\",originY:\"center\",width:s,height:n,stroke:\"black\",fill:\"rgba(128,0,0,1)\",strokeWidth:0}),t&&this.clipper.set(t),this.clipper.globalCompositeOperation=\"destination-out\",this.croppingCanvas.add(this.croppingShade),this.croppingCanvas.add(this.clipper)},_redrawCropperElements:function(){this.cropperHandles&&(this.croppingCanvas.remove(this.cropperHandles),this.croppingCanvas.remove(this.cropperGrid),this.croppingCanvas.remove(this.croppingRectangle));var t={strokeWidth:4,stroke:\"rgb(255,255,255)\",fill:!1},e={strokeWidth:2,stroke:\"rgba(255,255,255,0.5)\"},i=[new fabric.Path(\"M 0,10 L 0,0 L 10,0\",t),new fabric.Path(\"M \"+(this.clipper.width-8)+\",0 L \"+(this.clipper.width+4)+\",0 L \"+(this.clipper.width+4)+\",10\",t),new fabric.Path(\"M \"+(this.clipper.width+4)+\",\"+(this.clipper.height-8)+\" L\"+(this.clipper.width+4)+\",\"+(this.clipper.height+4)+\" L \"+(this.clipper.width-8)+\",\"+(this.clipper.height+4),t),new fabric.Path(\"M 10,\"+(this.clipper.height+4)+\" L 0,\"+(this.clipper.height+4)+\" L 0,\"+(this.clipper.height-8),t)];this.cropperHandles=new fabric.Group(i,{left:this.clipper.left,top:this.clipper.top,originX:\"center\",originY:\"center\"}),this.croppingRectangle=new fabric.Rect({left:this.clipper.left,top:this.clipper.top,width:this.clipper.width,height:this.clipper.height,fill:\"rgba(0,0,0,0)\",stroke:\"rgba(255,255,255,0.8)\",strokeWidth:2,originX:\"center\",originY:\"center\"}),this.cropperGrid=new fabric.Group([new fabric.Line([.33*this.clipper.width,0,.33*this.clipper.width,this.clipper.height],e),new fabric.Line([.66*this.clipper.width,0,.66*this.clipper.width,this.clipper.height],e),new fabric.Line([0,.33*this.clipper.height,this.clipper.width,.33*this.clipper.height],e),new fabric.Line([0,.66*this.clipper.height,this.clipper.width,.66*this.clipper.height],e)],{left:this.clipper.left,top:this.clipper.top,originX:\"center\",originY:\"center\"}),this.croppingCanvas.add(this.cropperHandles),this.croppingCanvas.add(this.cropperGrid),this.croppingCanvas.add(this.croppingRectangle)},_repositionCropper:function(t){if(this.croppingCanvas){var e=this.clipper.left-this.croppingCanvas.width/2,i=this.clipper.top-this.croppingCanvas.height/2;this.croppingCanvas.setDimensions({width:this.editorWidth,height:this.editorHeight});var s=this._getBoundingRectangle(this.imageVerticeCoords).width/t.width;this.clipper.width=Math.round(this.clipper.width*s),this.clipper.height=Math.round(this.clipper.height*s),this.clipper.left=this.editorWidth/2+e*s,this.clipper.top=this.editorHeight/2+i*s,this.croppingShade.set({width:this.editorWidth,height:this.editorHeight,left:this.editorWidth/2,top:this.editorHeight/2}),this._redrawCropperElements(),this.renderCropper()}},_getBoundingRectangle:function(t){return{width:Math.max(t.a.x,t.b.x,t.c.x,t.d.x)-Math.min(t.a.x,t.b.x,t.c.x,t.d.x),height:Math.max(t.a.y,t.b.y,t.c.y,t.d.y)-Math.min(t.a.y,t.b.y,t.c.y,t.d.y)}},_handleMouseDown:function(t){var e=this.focalPoint&&this._isMouseOver(t,this.focalPoint),i=this.croppingCanvas&&this._isMouseOver(t,this.clipper),s=this.croppingCanvas&&this._cropperHandleHitTest(t);(s||i||e)&&(this.previousMouseX=t.pageX,this.previousMouseY=t.pageY,e?this.draggingFocal=!0:s?this.scalingCropper=s:i&&(this.draggingCropper=!0))},_handleMouseMove:function(t){this.focalPoint&&this.draggingFocal?(this._handleFocalDrag(t),this.storeFocalPointState(),this.renderImage()):this.draggingCropper||this.scalingCropper?(this.draggingCropper?this._handleCropperDrag(t):this._handleCropperResize(t),this._redrawCropperElements(),this.storeCropperState(),this.renderCropper()):this._setMouseCursor(t),this.previousMouseX=t.pageX,this.previousMouseY=t.pageY},_handleMouseUp:function(t){this.draggingCropper=!1,this.scalingCropper=!1,this.draggingFocal=!1},_handleCropperDrag:function(t){var e=t.pageX-this.previousMouseX,i=t.pageY-this.previousMouseY;if(0!=e||0!=i){var s={left:this.clipper.left-this.clipper.width/2,top:this.clipper.top-this.clipper.height/2,width:this.clipper.width,height:this.clipper.height},n=this._getRectangleVertices(s,e,i);this.arePointsInsideRectangle(n,this.imageVerticeCoords)&&this.clipper.set({left:this.clipper.left+e,top:this.clipper.top+i})}},_handleFocalDrag:function(t){if(this.focalPoint){var e=t.pageX-this.previousMouseX,i=t.pageY-this.previousMouseY;if(0==e&&0==i)return;var s=this.focalPoint.left+e,n=this.focalPoint.top+i;if(\"crop\"===this.currentView){if(!this.arePointsInsideRectangle([{x:s,y:n}],this.imageVerticeCoords))return}else if(!(this.viewport.left-this.viewport.width/2-s<0&&0<this.viewport.left+this.viewport.width/2-s&&this.viewport.top-this.viewport.height/2-n<0&&0<this.viewport.top+this.viewport.height/2-n))return;this.focalPoint.set({left:this.focalPoint.left+e,top:this.focalPoint.top+i})}},setCroppingConstraint:function(t){switch(this.updateSizeAndPosition(),t){case\"none\":t=!1;break;case\"original\":t=this.originalWidth/this.originalHeight;break;case\"current\":t=this.clipper.width/this.clipper.height;break;default:t=parseFloat(t)}this.croppingConstraint=t},enforceCroppingConstraint:function(){if(!this.animationInProgress&&this.croppingConstraint){this.animationInProgress=!0;var t={left:this.clipper.left-this.clipper.width/2,top:this.clipper.top-this.clipper.height/2,width:this.clipper.width,height:this.clipper.height};if(this.clipper.width>this.clipper.height*this.croppingConstraint){var e=t.height;t.height=this.clipper.width/this.croppingConstraint,t.top-=(t.height-e)/2,this.arePointsInsideRectangle(this._getRectangleVertices(t),this.imageVerticeCoords)||(t.width=this.clipper.height*this.croppingConstraint,t.height=t.width/this.croppingConstraint)}else{var i=t.width;t.width=this.clipper.height*this.croppingConstraint,t.left-=(t.width-i)/2,this.arePointsInsideRectangle(this._getRectangleVertices(t),this.imageVerticeCoords)||(t.height=this.clipper.width/this.croppingConstraint,t.width=t.height*this.croppingConstraint)}var s={height:t.height,width:t.width};this.clipper.animate(s,{onChange:function(){this._redrawCropperElements(),this.croppingCanvas.renderAll()}.bind(this),duration:this.settings.animationDuration,onComplete:function(){this._redrawCropperElements(),this.animationInProgress=!1,this.renderCropper()}.bind(this)})}},_handleCropperResize:function(t){var e=t.pageX-this.previousMouseX,i=t.pageY-this.previousMouseY,s=0,n=0;if(\"b\"!==this.scalingCropper&&\"t\"!==this.scalingCropper||(e=0),\"l\"!==this.scalingCropper&&\"r\"!==this.scalingCropper||(i=0),0!==e||0!==i){var a={left:this.clipper.left-this.clipper.width/2,top:this.clipper.top-this.clipper.height/2,width:this.clipper.width,height:this.clipper.height};if(this.croppingConstraint){var r=0;switch(this.scalingCropper){case\"t\":r=-i;break;case\"b\":r=i;break;case\"r\":r=e;break;case\"l\":r=-e;break;case\"tr\":r=-i+e;break;case\"tl\":r=-i-e;break;case\"br\":r=i+e;break;case\"bl\":r=i-e}1<this.croppingConstraint?i=(e=r)/this.croppingConstraint:e=(i=r)*this.croppingConstraint,a.height+=i,a.width+=e,this.scalingCropper.match(/t/)&&(a.top-=i,a.left-=e/2,s=-i/2),this.scalingCropper.match(/b/)&&(a.left+=-e/2,s=i/2),this.scalingCropper.match(/r/)&&(a.top+=-i/2,n=e/2),this.scalingCropper.match(/l/)&&(a.top-=i/2,a.left-=e,n=-e/2)}else{if(this.shiftKeyHeld&&(\"tl\"===this.scalingCropper||\"tr\"===this.scalingCropper||\"bl\"===this.scalingCropper||\"br\"===this.scalingCropper))Math.abs(e)>Math.abs(i)?(i=e/(this.clipper.width/this.clipper.height),i*=\"tr\"===this.scalingCropper||\"bl\"===this.scalingCropper?-1:1):(e=i*(this.clipper.width/this.clipper.height),e*=\"tr\"===this.scalingCropper||\"bl\"===this.scalingCropper?-1:1);this.scalingCropper.match(/t/)&&(a.top+=i,a.height-=i),this.scalingCropper.match(/b/)&&(a.height+=i),this.scalingCropper.match(/r/)&&(a.width+=e),this.scalingCropper.match(/l/)&&(a.left+=e,a.width-=e),s=i/2,n=e/2}a.height<30||a.width<30||this.arePointsInsideRectangle(this._getRectangleVertices(a),this.imageVerticeCoords)&&(this.clipper.set({top:this.clipper.top+s,left:this.clipper.left+n,width:a.width,height:a.height}),this._redrawCropperElements())}},_setMouseCursor:function(t){var e=\"default\",i=this.croppingCanvas&&this._cropperHandleHitTest(t);this.focalPoint&&this._isMouseOver(t,this.focalPoint)?e=\"pointer\":i?\"t\"===i||\"b\"===i?e=\"ns-resize\":\"l\"===i||\"r\"===i?e=\"ew-resize\":\"tl\"===i||\"br\"===i?e=\"nwse-resize\":\"bl\"!==i&&\"tr\"!==i||(e=\"nesw-resize\"):this.croppingCanvas&&this._isMouseOver(t,this.clipper)&&(e=\"move\"),$(\".body\").css(\"cursor\",e)},_cropperHandleHitTest:function(t){var e=this.$croppingCanvas.offset(),i=t.pageX-e.left,s=t.pageY-e.top,n=this.clipper.left-this.clipper.width/2,a=n+this.clipper.width,r=this.clipper.top-this.clipper.height/2,o=r+this.clipper.height;if(i<10+n&&n-3<i){if(s<10+r&&r-3<s)return\"tl\";if(s<o+3&&o-10<s)return\"bl\"}if(a-13<i&&i<a+3){if(s<10+r&&r-3<s)return\"tr\";if(s<o+2&&o-10<s)return\"br\"}return i<3+n&&n-3<i&&s<o-10&&10+r<s?\"l\":i<a+1&&a-5<i&&s<o-10&&10+r<s?\"r\":s<4+r&&r-2<s&&10+n<i&&i<a-10?\"t\":s<o+2&&o-4<s&&10+n<i&&i<a-10&&\"b\"},_isMouseOver:function(t,e){var i=this.$croppingCanvas.offset(),s=t.pageX-i.left,n=t.pageY-i.top,a=e.left-e.width/2,r=a+e.width,o=e.top-e.height/2,l=o+e.height;return a<=s&&s<=r&&o<=n&&n<=l},_getRectangleVertices:function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=0);var s={x:t.left+e,y:t.top+i},n={x:s.x+t.width,y:s.y},a={x:n.x,y:n.y+t.height};return[s,n,a,{x:s.x,y:a.y}]},_setFittedImageVerticeCoordinates:function(){this.imageVerticeCoords=this.getImageVerticeCoords(\"fit\")},getImageVerticeCoords:function(t){var e,i=-1*((this.hasOrientationChanged()?90:0)+this.imageStraightenAngle)*(Math.PI/180),s=this.getScaledImageDimensions();e=\"number\"==typeof t?t:\"cover\"===t?this.getZoomToCoverRatio(s):this.getZoomToFitRatio(s);var n=s.height*e,a=s.width*e,r=Math.cos(i)*n,o=Math.sin(i)*a,l=Math.cos(i)*a,h=Math.sin(i)*n,d=(this.editorHeight-(r+o))/2,c=(this.editorWidth-(h+l))/2;return{a:{x:c+l,y:d},b:{x:this.editorWidth-c,y:d+r},c:{x:c+h,y:this.editorHeight-d},d:{x:c,y:d+o}}},_debug:function(t){this.canvas.remove(this.debugger),this.debugger=t,this.canvas.add(this.debugger)},arePointsInsideRectangle:function(t,e){for(var i=this._getVector(e.a,e.b),s=this._getVector(e.b,e.c),n=this._getScalarProduct(i,i),a=this._getScalarProduct(s,s),r=0;r<t.length;r++){var o=t[r],l=this._getVector(e.a,o),h=this._getVector(e.b,o),d=this._getScalarProduct(i,l),c=this._getScalarProduct(s,h);if(!(0<=d&&d<=n)||!(0<=c&&c<=a))return!1}return!0},_getVector:function(t,e){return{x:e.x-t.x,y:e.y-t.y}},_getScalarProduct:function(t,e){return t.x*e.x+t.y*e.y},_getVectorMagnitude:function(t){return Math.sqrt(t.x*t.x+t.y*t.y)},_getAngleBetweenVectors:function(t,e){return Math.round(180*Math.acos(Math.min(1,this._getScalarProduct(t,e)/(this._getVectorMagnitude(t)*this._getVectorMagnitude(e))))/Math.PI*100)/100},_getEdgeCrossed:function(t,e){for(var i=[[t.a,t.b],[t.b,t.c],[t.c,t.d],[t.d,t.a]],s={x:this.editorWidth/2,y:this.editorHeight/2},n=180,a=null,r=0;r<i.length;r++){var o=i[r],l=this._getVector(o[0],s),h=this._getVector(o[0],o[1]),d=this._getVector(o[0],e),c=Math.abs(this._getAngleBetweenVectors(l,d)-(this._getAngleBetweenVectors(l,h)+this._getAngleBetweenVectors(h,d)));c<n&&(n=c,a=o)}return a},_getImageBoundingBox:function(t){var e={},i=Math.abs(this.imageStraightenAngle)*(Math.PI/180),s=t.height/t.width;if(e.height=t.width*(Math.sin(i)+Math.cos(i)*s),e.width=t.width*(Math.cos(i)+Math.sin(i)*s),this.hasOrientationChanged()){var n=e.width;e.width=e.height,e.height=n}return e}},{defaults:{animationDuration:100,allowSavingAsNew:!0,onSave:$.noop,allowDegreeFractions:!0}}),Craft.AssetIndex=Craft.BaseElementIndex.extend({$includeSubfoldersContainer:null,$includeSubfoldersCheckbox:null,showingIncludeSubfoldersCheckbox:!1,$uploadButton:null,$uploadInput:null,$progressBar:null,$folders:null,uploader:null,promptHandler:null,progressBar:null,_uploadTotalFiles:0,_uploadFileProgress:{},_uploadedAssetIds:[],_currentUploaderSettings:{},_assetDrag:null,_folderDrag:null,_expandDropTargetFolderTimeout:null,_tempExpandedFolders:[],_fileConflictTemplate:{choices:[{value:\"keepBoth\",title:Craft.t(\"app\",\"Keep both\")},{value:\"replace\",title:Craft.t(\"app\",\"Replace it\")}]},_folderConflictTemplate:{choices:[{value:\"replace\",title:Craft.t(\"app\",\"Replace the folder (all existing files will be deleted)\")},{value:\"merge\",title:Craft.t(\"app\",\"Merge the folder (any conflicting files will be replaced)\")}]},init:function(t,e,i){this.base(t,e,i),\"index\"===this.settings.context?(this._folderDrag||this._initIndexPageMode(),this.addListener(Garnish.$win,\"resize,scroll\",\"_positionProgressBar\")):(this.addListener(this.$main,\"scroll\",\"_positionProgressBar\"),this.settings.modal&&this.settings.modal.on(\"updateSizeAndPosition\",$.proxy(this,\"_positionProgressBar\")))},initSources:function(){return\"index\"!==this.settings.context||this._folderDrag||this._initIndexPageMode(),this.base()},initSource:function(t){this.base(t),this._createFolderContextMenu(t),\"index\"===this.settings.context&&(this._folderDrag&&1<this._getSourceLevel(t)&&t.data(\"folder-id\")&&this._folderDrag.addItems(t.parent()),this._assetDrag&&this._assetDrag.updateDropTargets())},deinitSource:function(t){this.base(t);var e=t.data(\"contextmenu\");e&&e.destroy(),\"index\"===this.settings.context&&(this._folderDrag&&1<this._getSourceLevel(t)&&this._folderDrag.removeItems(t.parent()),this._assetDrag&&this._assetDrag.updateDropTargets())},_getSourceLevel:function(t){return t.parentsUntil(\"nav\",\"ul\").length},_initIndexPageMode:function(){if(!this._folderDrag){this.settings.selectable=!0,this.settings.multiSelect=!0;var t=$.proxy(this,\"_onDragStart\"),e=$.proxy(this,\"_onDropTargetChange\");this._assetDrag=new Garnish.DragDrop({activeDropTargetClass:\"sel\",helperOpacity:.75,filter:$.proxy(function(){return this.view.getSelectedElements()},this),helper:$.proxy(function(t){return this._getFileDragHelper(t)},this),dropTargets:$.proxy(function(){for(var t=[],e=0;e<this.$sources.length;e++){var i=this.$sources.eq(e);this._getFolderUidFromSourceKey(i.data(\"key\"))&&t.push(i)}return t},this),onDragStart:t,onDropTargetChange:e,onDragStop:$.proxy(this,\"_onFileDragStop\")}),this._folderDrag=new Garnish.DragDrop({activeDropTargetClass:\"sel\",helperOpacity:.75,filter:$.proxy(function(){for(var t=this.sourceSelect.getSelectedItems(),e=[],i=0;i<t.length;i++){var s=t.eq(i);!this._getFolderUidFromSourceKey(s.data(\"key\"))||s.hasClass(\"sel\")&&1<this._getSourceLevel(s)&&e.push(s.parent()[0])}return $(e)},this),helper:$.proxy(function(t){var e=$('<div class=\"sidebar\" style=\"padding-top: 0; padding-bottom: 0;\"/>'),i=$(\"<nav/>\").appendTo(e),s=$(\"<ul/>\").appendTo(i);return t.appendTo(s).removeClass(\"expanded\"),t.children(\"a\").addClass(\"sel\"),t.css({\"padding-top\":this._folderDrag.$draggee.css(\"padding-top\"),\"padding-right\":this._folderDrag.$draggee.css(\"padding-right\"),\"padding-bottom\":this._folderDrag.$draggee.css(\"padding-bottom\"),\"padding-left\":this._folderDrag.$draggee.css(\"padding-left\")}),e},this),dropTargets:$.proxy(function(){var t=[],e=[];this._folderDrag.$draggee.find(\"a[data-key]\").each(function(){e.push($(this).data(\"key\"))});for(var i=0;i<this.$sources.length;i++){var s=this.$sources.eq(i),n=s.data(\"key\");this._getFolderUidFromSourceKey(n)&&(Craft.inArray(n,e)||t.push(s))}return t},this),onDragStart:t,onDropTargetChange:e,onDragStop:$.proxy(this,\"_onFolderDragStop\")})}},_onFileDragStop:function(){if(this._assetDrag.$activeDropTarget&&this._assetDrag.$activeDropTarget[0]!==this.$source[0]){for(var r=this.$source,o=this._assetDrag.$activeDropTarget.data(\"folder-id\"),l=[],t=0;t<this._assetDrag.$draggee.length;t++){var e=Craft.getElementInfo(this._assetDrag.$draggee[t]).id;l.push(e)}if(l.length){this.setIndexBusy(),this._positionProgressBar(),this.progressBar.resetProgressBar(),this.progressBar.setItemCount(l.length),this.progressBar.showProgressBar();var i=[];for(t=0;t<l.length;t++)i.push({action:\"assets/move-asset\",params:{assetId:l[t],folderId:o}});var h=$.proxy(function(t){this.promptHandler.resetPrompts();for(var e=0;e<t.length;e++){var i=t[e];i.conflict&&this.promptHandler.addPrompt({assetId:i.assetId,suggestedFilename:i.suggestedFilename,prompt:{message:i.conflict,choices:this._fileConflictTemplate.choices}}),i.error&&alert(i.error)}this.setIndexAvailable(),this.progressBar.hideProgressBar();function s(){this.sourceSelect.selectItem(r),this._totalVisible-=this._assetDrag.$draggee.length;for(var t=0;t<l.length;t++)$(\"[data-id=\"+l[t]+\"]\").remove();this.view.deselectAllElements(),this._collapseExtraExpandedFolders(o),n&&this.updateElements()}var n=!1;if(this.promptHandler.getPromptCount()){var a=$.proxy(function(t){for(var e=[],i=0;i<t.length;i++)\"cancel\"!==t[i].choice?(\"keepBoth\"===t[i].choice&&e.push({action:\"assets/move-asset\",params:{folderId:o,assetId:t[i].assetId,filename:t[i].suggestedFilename}}),\"replace\"===t[i].choice&&e.push({action:\"assets/move-asset\",params:{folderId:o,assetId:t[i].assetId,force:!0}})):n=!0;0===e.length?s.apply(this):(this.setIndexBusy(),this.progressBar.resetProgressBar(),this.progressBar.setItemCount(this.promptHandler.getPromptCount()),this.progressBar.showProgressBar(),this._performBatchRequests(e,h))},this);this._assetDrag.fadeOutHelpers(),this.promptHandler.showBatchPrompts(a)}else s.apply(this),this._assetDrag.fadeOutHelpers()},this);return void this._performBatchRequests(i,h)}}else this.$source.addClass(\"sel\"),this._collapseExtraExpandedFolders();this._assetDrag.returnHelpersToDraggees()},_onFolderDragStop:function(){if(this._folderDrag.$activeDropTarget&&0===this._folderDrag.$activeDropTarget.siblings(\"ul\").children(\"li\").filter(this._folderDrag.$draggee).length){var t=this._folderDrag.$activeDropTarget.data(\"folder-id\");this._collapseExtraExpandedFolders(t);for(var a=[],e=0;e<this._folderDrag.$draggee.length;e++){var i=this._folderDrag.$draggee.eq(e).children(\"a\").data(\"folder-id\");if(i!=t){a.push(i);break}}if(a.length){a.sort(),a.reverse(),this.setIndexBusy(),this._positionProgressBar(),this.progressBar.resetProgressBar(),this.progressBar.setItemCount(a.length),this.progressBar.showProgressBar();var s=[];for(e=0;e<a.length;e++)s.push({action:\"assets/move-folder\",params:{folderId:a[e],parentId:t}});this.requestId++;var r=[],o=\"\",l=function(t){this.promptHandler.resetPrompts();for(var e=0;e<t.length;e++){var n=t[e];n.success&&(n.transferList&&(r=n.transferList),n.newFolderId&&(o=this._folderDrag.$activeDropTarget.data(\"key\")+\"/folder:\"+n.newFolderUid)),n.conflict&&(n.prompt={message:n.conflict,choices:this._folderConflictTemplate.choices},this.promptHandler.addPrompt(n)),n.error&&alert(n.error)}if(this.promptHandler.getPromptCount()){var i=$.proxy(function(t){this.promptHandler.resetPrompts();for(var e=[],i={},s=0;s<t.length;s++)\"cancel\"!==t[s].choice&&(\"replace\"===t[s].choice&&(i.force=!0),\"merge\"===t[s].choice&&(i.merge=!0),i.folderId=n.folderId,i.parentId=n.parentId,e.push({action:\"assets/move-folder\",params:i}));0===e.length?$.proxy(this,\"_performActualFolderMove\",r,a,o)():(this.setIndexBusy(),this.progressBar.resetProgressBar(),this.progressBar.setItemCount(this.promptHandler.getPromptCount()),this.progressBar.showProgressBar(),this._performBatchRequests(e,l))},this);this.promptHandler.showBatchPrompts(i),this.setIndexAvailable(),this.progressBar.hideProgressBar()}else $.proxy(this,\"_performActualFolderMove\",r,a,o)()}.bind(this);return void this._performBatchRequests(s,l)}}else this.$source.addClass(\"sel\"),this._collapseExtraExpandedFolders();this._folderDrag.returnHelpersToDraggees()},_performActualFolderMove:function(t,e,n){this.setIndexBusy(),this.progressBar.resetProgressBar(),this.progressBar.setItemCount(1),this.progressBar.showProgressBar();var i=function(t){for(var e=0,i=t.length,s=0;s<t.length;s++)Craft.postActionRequest(\"assets/delete-folder\",{folderId:t[s]},function(){++e===i&&(this.setIndexAvailable(),this.progressBar.hideProgressBar(),this._folderDrag.returnHelpersToDraggees(),this.setInstanceState(\"selectedSource\",n),this.refreshSources())}.bind(this))}.bind(this);if(0<t.length){for(var s=[],a=0;a<t.length;a++)s.push({action:\"assets/move-asset\",params:t[a]});this._performBatchRequests(s,function(){i(e)})}else i(e)},_getParentSource:function(t){if(1<this._getSourceLevel(t))return t.parent().parent().siblings(\"a\")},_selectSourceByFolderId:function(t){for(var e=this._getSourceByKey(t),i=e.parent().parents(\"li\"),s=0;s<i.length;s++){var n=$(i[s]);n.hasClass(\"expanded\")||n.children(\".toggle\").trigger(\"click\")}this.selectSource(e),this.updateElements()},afterInit:function(){this.$uploadButton||(this.$uploadButton=$('<div class=\"btn submit\" data-icon=\"upload\" style=\"position: relative; overflow: hidden;\" role=\"button\">'+Craft.t(\"app\",\"Upload files\")+\"</div>\"),this.addButton(this.$uploadButton),this.$uploadInput=$('<input type=\"file\" multiple=\"multiple\" name=\"assets-upload\" />').hide().insertBefore(this.$uploadButton)),this.promptHandler=new Craft.PromptHandler,this.progressBar=new Craft.ProgressBar(this.$main,!0);var t={url:Craft.getActionUrl(\"assets/save-asset\"),fileInput:this.$uploadInput,dropZone:this.$container};t.events={fileuploadstart:$.proxy(this,\"_onUploadStart\"),fileuploadprogressall:$.proxy(this,\"_onUploadProgress\"),fileuploaddone:$.proxy(this,\"_onUploadComplete\")},this.settings.criteria&&void 0!==this.settings.criteria.kind&&(t.allowedKinds=this.settings.criteria.kind),this._currentUploaderSettings=t,this.uploader=new Craft.Uploader(this.$uploadButton,t),this.$uploadButton.on(\"click\",$.proxy(function(){this.$uploadButton.hasClass(\"disabled\")||this.isIndexBusy||this.$uploadButton.parent().find(\"input[name=assets-upload]\").trigger(\"click\")},this)),this.base()},onSelectSource:function(){this._getSourceByKey(this.sourceKey).data(\"folder-id\")&&this.$source.attr(\"data-upload\")?(this.uploader.setParams({folderId:this.$source.attr(\"data-folder-id\")}),this.$uploadButton.removeClass(\"disabled\")):this.$uploadButton.addClass(\"disabled\"),this.base()},_getFolderUidFromSourceKey:function(t){var e=t.match(/\\bfolder:([0-9a-f\\-]+)$/);return e?e[1]:null},startSearching:function(){if(this.$source.siblings(\"ul\").length){if(null===this.$includeSubfoldersContainer){var t=\"includeSubfolders-\"+Math.floor(1e9*Math.random());this.$includeSubfoldersContainer=$('<div style=\"margin-bottom: -23px; opacity: 0;\"/>').insertAfter(this.$search);var e=$('<div style=\"padding-top: 5px;\"/>').appendTo(this.$includeSubfoldersContainer);this.$includeSubfoldersCheckbox=$('<input type=\"checkbox\" id=\"'+t+'\" class=\"checkbox\"/>').appendTo(e),$('<label class=\"light smalltext\" for=\"'+t+'\"/>').text(\" \"+Craft.t(\"app\",\"Search in subfolders\")).appendTo(e),this.addListener(this.$includeSubfoldersCheckbox,\"change\",function(){this.setSelecetedSourceState(\"includeSubfolders\",this.$includeSubfoldersCheckbox.prop(\"checked\")),this.updateElements()})}else this.$includeSubfoldersContainer.velocity(\"stop\");var i=this.getSelectedSourceState(\"includeSubfolders\",!1);this.$includeSubfoldersCheckbox.prop(\"checked\",i),this.$includeSubfoldersContainer.velocity({marginBottom:0,opacity:1},\"fast\"),this.showingIncludeSubfoldersCheckbox=!0}this.base()},stopSearching:function(){this.showingIncludeSubfoldersCheckbox&&(this.$includeSubfoldersContainer.velocity(\"stop\"),this.$includeSubfoldersContainer.velocity({marginBottom:-23,opacity:0},\"fast\"),this.showingIncludeSubfoldersCheckbox=!1),this.base()},getViewParams:function(){var t=this.base();return this.showingIncludeSubfoldersCheckbox&&this.$includeSubfoldersCheckbox.prop(\"checked\")&&(t.criteria.includeSubfolders=!0),t},_onUploadStart:function(){this.setIndexBusy(),this._positionProgressBar(),this.progressBar.resetProgressBar(),this.progressBar.showProgressBar(),this.promptHandler.resetPrompts()},_onUploadProgress:function(t,e){var i=parseInt(e.loaded/e.total*100,10);this.progressBar.setProgressPercentage(i)},_onUploadComplete:function(t,e){var i=e.result,s=e.files[0].name,n=!0;i.success||i.conflict?(this._uploadedAssetIds.push(i.assetId),i.conflict&&(i.prompt={message:Craft.t(\"app\",i.conflict,{file:i.filename}),choices:this._fileConflictTemplate.choices},this.promptHandler.addPrompt(i)),Craft.cp.runQueue()):(i.error?alert(Craft.t(\"app\",\"Upload failed. The error message was: \u201c{error}\u201d\",{error:i.error})):alert(Craft.t(\"app\",\"Upload failed for {filename}.\",{filename:s})),n=!1),this.uploader.isLastUpload()&&(this.setIndexAvailable(),this.progressBar.hideProgressBar(),this.promptHandler.getPromptCount()?this.promptHandler.showBatchPrompts($.proxy(this,\"_uploadFollowup\")):n&&this._updateAfterUpload())},_updateAfterUpload:function(){\"index\"!==this.settings.context&&(this.setSortAttribute(\"dateModified\"),this.setSortDirection(\"desc\")),this.updateElements()},_uploadFollowup:function(t){this.setIndexBusy(),this.progressBar.resetProgressBar(),this.promptHandler.resetPrompts();var e=function(){this.setIndexAvailable(),this.progressBar.hideProgressBar(),this._updateAfterUpload()}.bind(this);this.progressBar.setItemCount(t.length);var r=function(i,s,n){var t={},e=null,a=function(t,e){\"success\"===e&&t.assetId?this._uploadedAssetIds.push(t.assetId):t.error&&alert(t.error),s++,this.progressBar.incrementProcessedItemCount(1),this.progressBar.updateProgressBar(),s===i.length?n():r(i,s,n)}.bind(this);\"replace\"===i[s].choice?(e=\"assets/replace-file\",t.sourceAssetId=i[s].assetId,i[s].conflictingAssetId?t.assetId=i[s].conflictingAssetId:t.targetFilename=i[s].filename):\"cancel\"===i[s].choice&&(e=\"assets/delete-asset\",t.assetId=i[s].assetId),e?Craft.postActionRequest(e,t,a):a({assetId:i[s].assetId},\"success\")}.bind(this);this.progressBar.showProgressBar(),r(t,0,e)},onUpdateElements:function(){this._onUpdateElements(!1,this.view.getAllElements()),this.view.on(\"appendElements\",$.proxy(function(t){this._onUpdateElements(!0,t.newElements)},this)),this.base()},_onUpdateElements:function(t,e){if(\"index\"===this.settings.context&&(t||this._assetDrag.removeAllItems(),this._assetDrag.addItems(e)),this._uploadedAssetIds.length){if(this.view.settings.selectable)for(var i=0;i<this._uploadedAssetIds.length;i++)this.view.selectElementById(this._uploadedAssetIds[i]);this._uploadedAssetIds=[]}this.base(t,e),this.removeListener(this.$elements,\"keydown\"),this.addListener(this.$elements,\"keydown\",this._onKeyDown.bind(this)),this.view.elementSelect.on(\"focusItem\",this._onElementFocus.bind(this))},_onKeyDown:function(t){if(t.keyCode===Garnish.SPACE_KEY&&t.shiftKey){if(Craft.PreviewFileModal.openInstance)Craft.PreviewFileModal.openInstance.selfDestruct();else{var e=this.view.elementSelect.$focusedItem.find(\".element\");e.length&&this._loadPreview(e)}return t.stopPropagation(),!1}},_onElementFocus:function(t){var e=$(t.item).find(\".element\");Craft.PreviewFileModal.openInstance&&e.length&&this._loadPreview(e)},_loadPreview:function(t){var e={};t.data(\"image-width\")&&(e.startingWidth=t.data(\"image-width\"),e.startingHeight=t.data(\"image-height\")),new Craft.PreviewFileModal(t.data(\"id\"),this.view.elementSelect,e)},_onDragStart:function(){this._tempExpandedFolders=[]},_getFileDragHelper:function(t){var e,i;switch(this.getSelectedSourceState(\"mode\")){case\"table\":e=$('<div class=\"elements datatablesorthelper\"/>').appendTo(Garnish.$bod),i=$('<div class=\"tableview\"/>').appendTo(e);var s=$('<table class=\"data\"/>').appendTo(i),n=$(\"<tbody/>\").appendTo(s);t.appendTo(n),this._$firstRowCells=this.view.$table.children(\"tbody\").children(\"tr:first\").children();for(var a=t.children(),r=0;r<a.length;r++){var o=$(a[r]);if(o.hasClass(\"checkbox-cell\"))o.remove(),e.css(\"margin-\"+Craft.left,19);else{var l=$(this._$firstRowCells[r]),h=l.width();l.width(h),o.width(h)}}return e;case\"thumbs\":return e=$('<div class=\"elements thumbviewhelper\"/>').appendTo(Garnish.$bod),i=$('<ul class=\"thumbsview\"/>').appendTo(e),t.appendTo(i),e}return $()},_onDropTargetChange:function(t){if(clearTimeout(this._expandDropTargetFolderTimeout),t){var e=t.data(\"folder-id\");e?(this.dropTargetFolder=this._getSourceByKey(e),this._hasSubfolders(this.dropTargetFolder)&&!this._isExpanded(this.dropTargetFolder)&&(this._expandDropTargetFolderTimeout=setTimeout($.proxy(this,\"_expandFolder\"),500))):this.dropTargetFolder=null}t&&t[0]!==this.$source[0]?this.$source.removeClass(\"sel\"):this.$source.addClass(\"sel\")},_collapseExtraExpandedFolders:function(t){var e;clearTimeout(this._expandDropTargetFolderTimeout),t&&(e=this._getSourceByKey(t).parents(\"li\").children(\"a\"));for(var i=this._tempExpandedFolders.length-1;0<=i;i--){var s=this._tempExpandedFolders[i];void 0!==e&&0!==e.filter('[data-key=\"'+s.data(\"key\")+'\"]').length||(this._collapseFolder(s),this._tempExpandedFolders.splice(i,1))}},_getSourceByKey:function(t){return this.$sources.filter('[data-key$=\"'+t+'\"]')},_hasSubfolders:function(t){return t.siblings(\"ul\").find(\"li\").length},_isExpanded:function(t){return t.parent(\"li\").hasClass(\"expanded\")},_expandFolder:function(){this._collapseExtraExpandedFolders(this.dropTargetFolder.data(\"folder-id\")),this.dropTargetFolder.siblings(\".toggle\").trigger(\"click\"),this._tempExpandedFolders.push(this.dropTargetFolder)},_collapseFolder:function(t){t.parent().hasClass(\"expanded\")&&t.siblings(\".toggle\").trigger(\"click\")},_createFolderContextMenu:function(t){if(this._getFolderUidFromSourceKey(t.data(\"key\"))){var e=[{label:Craft.t(\"app\",\"New subfolder\"),onClick:$.proxy(this,\"_createSubfolder\",t)}];\"index\"===this.settings.context&&1<this._getSourceLevel(t)&&(e.push({label:Craft.t(\"app\",\"Rename folder\"),onClick:$.proxy(this,\"_renameFolder\",t)}),e.push({label:Craft.t(\"app\",\"Delete folder\"),onClick:$.proxy(this,\"_deleteFolder\",t)})),new Garnish.ContextMenu(t,e,{menuClass:\"menu\"})}},_createSubfolder:function(n){var t=prompt(Craft.t(\"app\",\"Enter the name of the folder\"));if(t){var e={parentId:n.data(\"folder-id\"),folderName:t};this.setIndexBusy(),Craft.postActionRequest(\"assets/create-folder\",e,$.proxy(function(t,e){if(this.setIndexAvailable(),\"success\"===e&&t.success){this._prepareParentForChildren(n);var i=$('<li><a data-key=\"'+n.data(\"key\")+\"/folder:\"+t.folderUid+'\"'+(Garnish.hasAttr(n,\"data-has-thumbs\")?\" data-has-thumbs\":\"\")+' data-upload=\"'+n.attr(\"data-upload\")+'\" data-folder-id=\"'+t.folderId+'\">'+t.folderName+\"</a></li>\"),s=i.children(\"a:first\");this._appendSubfolder(n,i),this.initSource(s)}\"success\"===e&&t.error&&alert(t.error)},this))}},_deleteFolder:function(s){if(confirm(Craft.t(\"app\",\"Really delete folder \u201c{folder}\u201d?\",{folder:$.trim(s.text())}))){var t={folderId:s.data(\"folder-id\")};this.setIndexBusy(),Craft.postActionRequest(\"assets/delete-folder\",t,$.proxy(function(t,e){if(this.setIndexAvailable(),\"success\"===e&&t.success){var i=this._getParentSource(s);this.deinitSource(s),s.parent().remove(),this._cleanUpTree(i)}\"success\"===e&&t.error&&alert(t.error)},this))}},_renameFolder:function(i){var t=$.trim(i.text()),e=prompt(Craft.t(\"app\",\"Rename folder\"),t);if(e&&e!==t){var s={folderId:i.data(\"folder-id\"),newName:e};this.setIndexBusy(),Craft.postActionRequest(\"assets/rename-folder\",s,$.proxy(function(t,e){this.setIndexAvailable(),\"success\"===e&&t.success&&(i.text(t.newName),this._getFolderUidFromSourceKey(this.sourceSelect.$selectedItems.data(\"key\"))===this._getFolderUidFromSourceKey(i.data(\"key\"))&&this.updateElements()),\"success\"===e&&t.error&&alert(t.error)},this),\"json\")}},_prepareParentForChildren:function(t){this._hasSubfolders(t)||(t.parent().addClass(\"expanded\").append('<div class=\"toggle\"></div><ul></ul>'),this.initSourceToggle(t))},_appendSubfolder:function(t,e){for(var i=t.siblings(\"ul\").children(\"li\"),s=$.trim(e.children(\"a:first\").text()),n=!1,a=0;a<i.length;a++){var r=$(i[a]);if($.trim(r.children(\"a:first\").text())>s){r.before(e),n=!0;break}}n||t.siblings(\"ul\").append(e)},_cleanUpTree:function(t){null!==t&&0===t.siblings(\"ul\").children(\"li\").length&&(this.deinitSourceToggle(t),t.siblings(\"ul\").remove(),t.siblings(\".toggle\").remove(),t.parent().removeClass(\"expanded\"))},_positionProgressBar:function(){this.progressBar||(this.progressBar=new Craft.ProgressBar(this.$main,!0));var t=$(),e=0,i=0,s=(e=\"index\"===this.settings.context?(t=this.progressBar.$progressBar.closest(\"#content\"),Garnish.$win.scrollTop()):(t=this.progressBar.$progressBar.closest(\".main\"),this.$main.scrollTop()))-t.offset().top,n=Garnish.$win.height();i=t.height()>n?n/2-6+s:t.height()/2-6,\"index\"!==this.settings.context&&(i=e+(t.height()/2-6)),this.progressBar.$progressBar.css({top:i})},_performBatchRequests:function(i,s){for(var n=[],t=function(t){Craft.postActionRequest(t.action,t.params,function(t,e){this.progressBar.incrementProcessedItemCount(1),this.progressBar.updateProgressBar(),\"success\"===e&&(n.push(t),Craft.cp.runQueue()),n.length>=i.length&&s(n)}.bind(this))}.bind(this),e=0;e<i.length;e++)t(i[e])}}),Craft.registerElementIndexClass(\"craft\\\\elements\\\\Asset\",Craft.AssetIndex),Craft.AssetSelectInput=Craft.BaseElementSelectInput.extend({requestId:0,hud:null,uploader:null,progressBar:null,originalFilename:\"\",originalExtension:\"\",init:function(){0<arguments.length&&\"object\"==typeof arguments[0]&&(arguments[0].editorSettings={onShowHud:$.proxy(this.resetOriginalFilename,this),onCreateForm:$.proxy(this._renameHelper,this),validators:[$.proxy(this.validateElementForm,this)]}),this.base.apply(this,arguments),this._attachUploader(),this.addListener(this.$elementsContainer,\"keydown\",this._onKeyDown.bind(this)),this.elementSelect.on(\"focusItem\",this._onElementFocus.bind(this))},_onKeyDown:function(t){if(t.keyCode===Garnish.SPACE_KEY&&t.shiftKey){if(Craft.PreviewFileModal.openInstance)Craft.PreviewFileModal.openInstance.selfDestruct();else{var e=this.elementSelect.$focusedItem;e.length&&this._loadPreview(e)}return t.stopPropagation(),!1}},_onElementFocus:function(t){var e=$(t.item);Craft.PreviewFileModal.openInstance&&e.length&&this._loadPreview(e)},_loadPreview:function(t){var e={};t.data(\"image-width\")&&(e.startingWidth=t.data(\"image-width\"),e.startingHeight=t.data(\"image-height\")),new Craft.PreviewFileModal(t.data(\"id\"),this.elementSelect,e)},createElementEditor:function(t){return this.base(t,{params:{defaultFieldLayoutId:this.settings.defaultFieldLayoutId}})},_attachUploader:function(){this.progressBar=new Craft.ProgressBar($('<div class=\"progress-shade\"></div>').appendTo(this.$container));var t={url:Craft.getActionUrl(\"assets/save-asset\"),dropZone:this.$container,formData:{fieldId:this.settings.fieldId,elementId:this.settings.sourceElementId}};void 0!==Craft.csrfTokenName&&void 0!==Craft.csrfTokenValue&&(t.formData[Craft.csrfTokenName]=Craft.csrfTokenValue),void 0!==this.settings.criteria.kind&&(t.allowedKinds=this.settings.criteria.kind),t.canAddMoreFiles=$.proxy(this,\"canAddMoreFiles\"),t.events={},t.events.fileuploadstart=$.proxy(this,\"_onUploadStart\"),t.events.fileuploadprogressall=$.proxy(this,\"_onUploadProgress\"),t.events.fileuploaddone=$.proxy(this,\"_onUploadComplete\"),this.uploader=new Craft.Uploader(this.$container,t)},selectUploadedFile:function(t){if(this.canAddMoreElements()){var e=t.$element;e.addClass(\"removable\"),e.prepend('<input type=\"hidden\" name=\"'+this.settings.name+'[]\" value=\"'+t.id+'\"><a class=\"delete icon\" title=\"'+Craft.t(\"app\",\"Remove\")+'\"></a>'),e.appendTo(this.$elementsContainer);var i=-(e.outerWidth()+10);this.$addElementBtn.css(\"margin-\"+Craft.left,i+\"px\");var s={};s[\"margin-\"+Craft.left]=0,this.$addElementBtn.velocity(s,\"fast\"),this.addElements(e),delete this.modal}},_onUploadStart:function(){this.progressBar.$progressBar.css({top:Math.round(this.$container.outerHeight()/2)-6}),this.$container.addClass(\"uploading\"),this.progressBar.resetProgressBar(),this.progressBar.showProgressBar()},_onUploadProgress:function(t,e){var i=parseInt(e.loaded/e.total*100,10);this.progressBar.setProgressPercentage(i)},_onUploadComplete:function(t,e){if(e.result.error)alert(e.result.error);else{var i={elementId:e.result.assetId,siteId:this.settings.criteria.siteId,size:this.settings.viewMode};Craft.postActionRequest(\"elements/get-element-html\",i,function(t){if(t.error)alert(t.error);else{var e=$(t.html);Craft.appendHeadHtml(t.headHtml),this.selectUploadedFile(Craft.getElementInfo(e))}this.uploader.isLastUpload()&&(this.progressBar.hideProgressBar(),this.$container.removeClass(\"uploading\"),window.draftEditor&&window.draftEditor.checkForm())}.bind(this)),Craft.cp.runQueue()}},canAddMoreFiles:function(t){return!this.settings.limit||this.$elements.length+t<this.settings.limit},_parseFilename:function(t){var e=t.split(\".\"),i=\"\";return 1<e.length&&(i=e.pop()),{extension:i,baseFileName:e.join(\".\")}},_renameHelper:function(t){$(\".renameHelper\",t).on(\"focus\",$.proxy(function(t){var e=t.currentTarget,i=this._parseFilename(e.value);\"\"===this.originalFilename&&\"\"===this.originalExtension&&(this.originalFilename=i.baseFileName,this.originalExtension=i.extension);var s=i.baseFileName.length;if(void 0!==e.selectionStart)e.selectionStart=0,e.selectionEnd=s;else if(document.selection&&document.selection.createRange){e.select();var n=document.selection.createRange();n.collapse(!0),n.moveEnd(\"character\",s),n.moveStart(\"character\",0),n.select()}},this))},resetOriginalFilename:function(){this.originalFilename=\"\",this.originalExtension=\"\"},validateElementForm:function(){var t=$(\".renameHelper\",this.elementEditor.hud.$hud.data(\"elementEditor\").$form),e=this._parseFilename(t.val());return e.extension===this.originalExtension||(\"\"===e.extension?this.originalFilename!==e.baseFileName?(t.val(e.baseFileName+\".\"+this.originalExtension),!0):confirm(Craft.t(\"app\",\"Are you sure you want to remove the extension \u201c.{ext}\u201d?\",{ext:this.originalExtension})):confirm(Craft.t(\"app\",\"Are you sure you want to change the extension from \u201c.{oldExt}\u201d to \u201c.{newExt}\u201d?\",{oldExt:this.originalExtension,newExt:e.extension})))}}),Craft.AssetSelectorModal=Craft.BaseElementSelectorModal.extend({$selectTransformBtn:null,_selectedTransform:null,init:function(t,e){e=$.extend({},Craft.AssetSelectorModal.defaults,e),this.base(t,e),e.transforms.length&&this.createSelectTransformButton(e.transforms)},createSelectTransformButton:function(t){if(t&&t.length){var e=$('<div class=\"btngroup\"/>').appendTo(this.$primaryButtons);this.$selectBtn.appendTo(e),this.$selectTransformBtn=$('<div class=\"btn menubtn disabled\">'+Craft.t(\"app\",\"Select transform\")+\"</div>\").appendTo(e);for(var i=$('<div class=\"menu\" data-align=\"right\"></div>').insertAfter(this.$selectTransformBtn),s=$(\"<ul></ul>\").appendTo(i),n=0;n<t.length;n++)$('<li><a data-transform=\"'+t[n].handle+'\">'+t[n].name+\"</a></li>\").appendTo(s);var a=new Garnish.MenuBtn(this.$selectTransformBtn,{onOptionSelect:$.proxy(this,\"onSelectTransform\")});a.disable(),this.$selectTransformBtn.data(\"menuButton\",a)}},onSelectionChange:function(t){var e=this.elementIndex.getSelectedElements(),i=!1;if(e.length&&this.settings.transforms.length){i=!0;for(var s=0;s<e.length&&$(\".element.hasthumb:first\",e[s]).length;s++);}var n=null;this.$selectTransformBtn&&(n=this.$selectTransformBtn.data(\"menuButton\")),i?(n&&n.enable(),this.$selectTransformBtn.removeClass(\"disabled\")):this.$selectTransformBtn&&(n&&n.disable(),this.$selectTransformBtn.addClass(\"disabled\")),this.base()},onSelectTransform:function(t){var e=$(t).data(\"transform\");this.selectImagesWithTransform(e)},selectImagesWithTransform:function(t){void 0===Craft.AssetSelectorModal.transformUrls[t]&&(Craft.AssetSelectorModal.transformUrls[t]={});for(var e=this.elementIndex.getSelectedElements(),i=[],s=0;s<e.length;s++){var n=$(e[s]),a=Craft.getElementInfo(n).id;void 0===Craft.AssetSelectorModal.transformUrls[t][a]&&i.push(a)}i.length?(this.showFooterSpinner(),this.fetchMissingTransformUrls(i,t,$.proxy(function(){this.hideFooterSpinner(),this.selectImagesWithTransform(t)},this))):(this._selectedTransform=t,this.selectElements(),this._selectedTransform=null)},fetchMissingTransformUrls:function(i,s,n){var a=i.pop(),t={assetId:a,handle:s};Craft.postActionRequest(\"assets/generate-transform\",t,$.proxy(function(t,e){Craft.AssetSelectorModal.transformUrls[s][a]=!1,\"success\"!==e||t.url&&(Craft.AssetSelectorModal.transformUrls[s][a]=t.url),i.length?this.fetchMissingTransformUrls(i,s,n):n()},this))},getElementInfo:function(t){var e=this.base(t);if(this._selectedTransform)for(var i=0;i<e.length;i++){var s=e[i].id;void 0!==Craft.AssetSelectorModal.transformUrls[this._selectedTransform][s]&&!1!==Craft.AssetSelectorModal.transformUrls[this._selectedTransform][s]&&(e[i].url=Craft.AssetSelectorModal.transformUrls[this._selectedTransform][s])}return e},onSelect:function(t){this.settings.onSelect(t,this._selectedTransform)}},{defaults:{canSelectImageTransforms:!1,transforms:[]},transformUrls:{}}),Craft.registerElementSelectorModalClass(\"craft\\\\elements\\\\Asset\",Craft.AssetSelectorModal),Craft.AuthManager=Garnish.Base.extend({remainingSessionTime:null,checkRemainingSessionTimer:null,showLoginModalTimer:null,decrementLogoutWarningInterval:null,showingLogoutWarningModal:!1,showingLoginModal:!1,logoutWarningModal:null,loginModal:null,$logoutWarningPara:null,$passwordInput:null,$passwordSpinner:null,$loginBtn:null,$loginErrorPara:null,submitLoginIfLoggedOut:!1,init:function(){this.updateRemainingSessionTime(Craft.remainingSessionTime)},setCheckRemainingSessionTimer:function(t){this.checkRemainingSessionTimer&&clearTimeout(this.checkRemainingSessionTimer),this.checkRemainingSessionTimer=setTimeout($.proxy(this,\"checkRemainingSessionTime\"),1e3*t)},checkRemainingSessionTime:function(t){$.ajax({url:Craft.getActionUrl(\"users/get-remaining-session-time\",t?null:\"dontExtendSession=1\"),type:\"GET\",dataType:\"json\",complete:$.proxy(function(t,e){\"success\"===e?(void 0!==t.responseJSON.csrfTokenValue&&void 0!==Craft.csrfTokenValue&&(Craft.csrfTokenValue=t.responseJSON.csrfTokenValue),this.updateRemainingSessionTime(t.responseJSON.timeout),this.submitLoginIfLoggedOut=!1):this.updateRemainingSessionTime(-1)},this)})},updateRemainingSessionTime:function(t){this.remainingSessionTime=parseInt(t),-1!==this.remainingSessionTime&&this.remainingSessionTime<Craft.AuthManager.minSafeSessiotTime?(this.remainingSessionTime?(this.showingLogoutWarningModal||this.showLogoutWarningModal(),this.remainingSessionTime<Craft.AuthManager.checkInterval&&(this.showLoginModalTimer&&clearTimeout(this.showLoginModalTimer),this.showLoginModalTimer=setTimeout($.proxy(this,\"showLoginModal\"),1e3*this.remainingSessionTime))):this.showingLoginModal?this.submitLoginIfLoggedOut&&this.submitLogin():this.showLoginModal(),this.setCheckRemainingSessionTimer(Craft.AuthManager.checkInterval)):(this.hideLogoutWarningModal(),this.hideLoginModal(),-1!==this.remainingSessionTime&&this.remainingSessionTime<Craft.AuthManager.minSafeSessiotTime+Craft.AuthManager.checkInterval?this.setCheckRemainingSessionTimer(this.remainingSessionTime-Craft.AuthManager.minSafeSessiotTime+1):this.setCheckRemainingSessionTimer(Craft.AuthManager.checkInterval))},showLogoutWarningModal:function(){var t;if(t=!!this.showingLoginModal&&(this.hideLoginModal(!0),!0),this.showingLogoutWarningModal=!0,!this.logoutWarningModal){var e=$('<form id=\"logoutwarningmodal\" class=\"modal alert fitted\"/>'),i=$('<div class=\"body\"/>').appendTo(e),s=$('<div class=\"buttons right\"/>').appendTo(i),n=$('<div class=\"btn\">'+Craft.t(\"app\",\"Log out now\")+\"</div>\").appendTo(s),a=$('<input type=\"submit\" class=\"btn submit\" value=\"'+Craft.t(\"app\",\"Keep me logged in\")+'\" />').appendTo(s);this.$logoutWarningPara=$(\"<p/>\").prependTo(i),this.logoutWarningModal=new Garnish.Modal(e,{autoShow:!1,closeOtherModals:!1,hideOnEsc:!1,hideOnShadeClick:!1,shadeClass:\"modal-shade dark logoutwarningmodalshade\",onFadeIn:function(){Garnish.isMobileBrowser(!0)||setTimeout(function(){a.trigger(\"focus\")},100)}}),this.addListener(n,\"activate\",\"logout\"),this.addListener(e,\"submit\",\"renewSession\")}t?this.logoutWarningModal.quickShow():this.logoutWarningModal.show(),this.updateLogoutWarningMessage(),this.decrementLogoutWarningInterval=setInterval($.proxy(this,\"decrementLogoutWarning\"),1e3)},updateLogoutWarningMessage:function(){this.$logoutWarningPara.text(Craft.t(\"app\",\"Your session will expire in {time}.\",{time:Craft.secondsToHumanTimeDuration(this.remainingSessionTime)})),this.logoutWarningModal.updateSizeAndPosition()},decrementLogoutWarning:function(){0<this.remainingSessionTime&&(this.remainingSessionTime--,this.updateLogoutWarningMessage()),0===this.remainingSessionTime&&clearInterval(this.decrementLogoutWarningInterval)},hideLogoutWarningModal:function(t){this.showingLogoutWarningModal=!1,this.logoutWarningModal&&(t?this.logoutWarningModal.quickHide():this.logoutWarningModal.hide(),this.decrementLogoutWarningInterval&&clearInterval(this.decrementLogoutWarningInterval))},showLoginModal:function(){var t;if(t=!!this.showingLogoutWarningModal&&(this.hideLogoutWarningModal(!0),!0),this.showingLoginModal=!0,!this.loginModal){var e=$('<form id=\"loginmodal\" class=\"modal alert fitted\"/>'),i=$('<div class=\"body\"><h2>'+Craft.t(\"app\",\"Your session has ended.\")+\"</h2><p>\"+Craft.t(\"app\",\"Enter your password to log back in.\")+\"</p></div>\").appendTo(e),s=$('<div class=\"inputcontainer\">').appendTo(i),n=$('<div class=\"flex\"/>').appendTo(s),a=$('<div class=\"flex-grow\"/>').appendTo(n),r=$(\"<div/>\").appendTo(n),o=$('<div class=\"passwordwrapper\"/>').appendTo(a);this.$passwordInput=$('<input type=\"password\" class=\"text password fullwidth\" placeholder=\"'+Craft.t(\"app\",\"Password\")+'\"/>').appendTo(o),this.$passwordSpinner=$('<div class=\"spinner hidden\"/>').appendTo(s),this.$loginBtn=$('<input type=\"submit\" class=\"btn submit disabled\" value=\"'+Craft.t(\"app\",\"Login\")+'\" />').appendTo(r),this.$loginErrorPara=$('<p class=\"error\"/>').appendTo(i),this.loginModal=new Garnish.Modal(e,{autoShow:!1,closeOtherModals:!1,hideOnEsc:!1,hideOnShadeClick:!1,shadeClass:\"modal-shade dark loginmodalshade\",onFadeIn:$.proxy(function(){Garnish.isMobileBrowser(!0)||setTimeout($.proxy(function(){this.$passwordInput.trigger(\"focus\")},this),100)},this),onFadeOut:$.proxy(function(){this.$passwordInput.val(\"\")},this)}),new Craft.PasswordInput(this.$passwordInput,{onToggleInput:$.proxy(function(t){this.$passwordInput=t},this)}),this.addListener(this.$passwordInput,\"textchange\",\"validatePassword\"),this.addListener(e,\"submit\",\"login\")}t?this.loginModal.quickShow():this.loginModal.show()},hideLoginModal:function(t){this.showingLoginModal=!1,this.loginModal&&(t?this.loginModal.quickHide():this.loginModal.hide())},logout:function(){$.get({url:Craft.getActionUrl(\"users/logout\"),dataType:\"json\",success:$.proxy(function(){Craft.redirectTo(\"\")},this)})},renewSession:function(t){t&&t.preventDefault(),this.hideLogoutWarningModal(),this.checkRemainingSessionTime(!0)},validatePassword:function(){return 6<=this.$passwordInput.val().length?(this.$loginBtn.removeClass(\"disabled\"),!0):(this.$loginBtn.addClass(\"disabled\"),!1)},login:function(t){t&&t.preventDefault(),this.validatePassword()&&(this.$passwordSpinner.removeClass(\"hidden\"),this.clearLoginError(),void 0!==Craft.csrfTokenValue?(this.submitLoginIfLoggedOut=!0,this.checkRemainingSessionTime()):this.submitLogin())},submitLogin:function(){var t={loginName:Craft.username,password:this.$passwordInput.val()};Craft.postActionRequest(\"users/login\",t,$.proxy(function(t,e){this.$passwordSpinner.addClass(\"hidden\"),\"success\"===e?t.success?(this.hideLoginModal(),this.checkRemainingSessionTime()):(this.showLoginError(t.error),Garnish.shake(this.loginModal.$container),Garnish.isMobileBrowser(!0)||this.$passwordInput.trigger(\"focus\")):this.showLoginError()},this))},showLoginError:function(t){null==t&&(t=Craft.t(\"app\",\"An unknown error occurred.\")),this.$loginErrorPara.text(t),this.loginModal.updateSizeAndPosition()},clearLoginError:function(){this.showLoginError(\"\")}},{checkInterval:60,minSafeSessiotTime:120}),Craft.CategoryIndex=Craft.BaseElementIndex.extend({editableGroups:null,$newCategoryBtnGroup:null,$newCategoryBtn:null,init:function(t,e,i){this.on(\"selectSource\",$.proxy(this,\"updateButton\")),this.on(\"selectSite\",$.proxy(this,\"updateButton\")),this.base(t,e,i)},afterInit:function(){this.editableGroups=[];for(var t=0;t<Craft.editableCategoryGroups.length;t++){var e=Craft.editableCategoryGroups[t];this.getSourceByKey(\"group:\"+e.uid)&&this.editableGroups.push(e)}this.base()},getDefaultSourceKey:function(){if(\"index\"===this.settings.context&&\"undefined\"!=typeof defaultGroupHandle)for(var t=0;t<this.$sources.length;t++){var e=$(this.$sources[t]);if(e.data(\"handle\")===defaultGroupHandle)return e.data(\"key\")}return this.base()},updateButton:function(){if(this.$source){var t,e,i,s=this.$source.data(\"handle\");if(this.editableGroups.length){var n,a;if(this.$newCategoryBtnGroup&&this.$newCategoryBtnGroup.remove(),s)for(t=0;t<this.editableGroups.length;t++)if(this.editableGroups[t].handle===s){n=this.editableGroups[t];break}if(this.$newCategoryBtnGroup=$('<div class=\"btngroup submit\"/>'),n?(e=this._getGroupTriggerHref(n),i=\"index\"===this.settings.context?Craft.t(\"app\",\"New category\"):Craft.t(\"app\",\"New {group} category\",{group:n.name}),this.$newCategoryBtn=$('<a class=\"btn submit add icon\" '+e+\">\"+Craft.escapeHtml(i)+\"</a>\").appendTo(this.$newCategoryBtnGroup),\"index\"!==this.settings.context&&this.addListener(this.$newCategoryBtn,\"click\",function(t){this._openCreateCategoryModal(t.currentTarget.getAttribute(\"data-id\"))}),1<this.editableGroups.length&&(a=$('<div class=\"btn submit menubtn\"></div>').appendTo(this.$newCategoryBtnGroup))):this.$newCategoryBtn=a=$('<div class=\"btn submit add icon menubtn\">'+Craft.t(\"app\",\"New category\")+\"</div>\").appendTo(this.$newCategoryBtnGroup),a){var r='<div class=\"menu\"><ul>';for(t=0;t<this.editableGroups.length;t++){var o=this.editableGroups[t];\"index\"!==this.settings.context&&o===n||(e=this._getGroupTriggerHref(o),i=\"index\"===this.settings.context?o.name:Craft.t(\"app\",\"New {group} category\",{group:o.name}),r+=\"<li><a \"+e+'\">'+Craft.escapeHtml(i)+\"</a></li>\")}$(r+=\"</ul></div>\").appendTo(this.$newCategoryBtnGroup);var l=new Garnish.MenuBtn(a);\"index\"!==this.settings.context&&l.on(\"optionSelect\",$.proxy(function(t){this._openCreateCategoryModal(t.option.getAttribute(\"data-id\"))},this))}this.addButton(this.$newCategoryBtnGroup)}if(\"index\"===this.settings.context&&\"undefined\"!=typeof history){var h=\"categories\";s&&(h+=\"/\"+s),history.replaceState({},\"\",Craft.getUrl(h))}}},_getGroupTriggerHref:function(t){if(\"index\"!==this.settings.context)return'data-id=\"'+t.id+'\"';var e=\"categories/\"+t.handle+\"/new\";if(this.siteId&&this.siteId!=Craft.primarySiteId)for(var i=0;i<Craft.sites.length;i++)Craft.sites[i].id==this.siteId&&(e+=\"/\"+Craft.sites[i].handle);return'href=\"'+Craft.getUrl(e)+'\"'},_openCreateCategoryModal:function(t){if(!this.$newCategoryBtn.hasClass(\"loading\")){for(var i,e=0;e<this.editableGroups.length;e++)if(this.editableGroups[e].id==t){i=this.editableGroups[e];break}if(i){this.$newCategoryBtn.addClass(\"inactive\");var s=this.$newCategoryBtn.text();this.$newCategoryBtn.text(Craft.t(\"app\",\"New {group} category\",{group:i.name})),Craft.createElementEditor(this.elementType,{hudTrigger:this.$newCategoryBtnGroup,elementType:\"craft\\\\elements\\\\Category\",siteId:this.siteId,attributes:{groupId:t},onBeginLoading:$.proxy(function(){this.$newCategoryBtn.addClass(\"loading\")},this),onEndLoading:$.proxy(function(){this.$newCategoryBtn.removeClass(\"loading\")},this),onHideHud:$.proxy(function(){this.$newCategoryBtn.removeClass(\"inactive\").text(s)},this),onSaveElement:$.proxy(function(t){var e=\"group:\"+i.uid;this.sourceKey!==e&&this.selectSourceByKey(e),this.selectElementAfterUpdate(t.id),this.updateElements()},this)})}}}}),Craft.registerElementIndexClass(\"craft\\\\elements\\\\Category\",Craft.CategoryIndex),Craft.CategorySelectInput=Craft.BaseElementSelectInput.extend({setSettings:function(){this.base.apply(this,arguments),this.settings.sortable=!1},getModalSettings:function(){var t=this.base();return t.hideOnSelect=!1,t},getElements:function(){return this.$elementsContainer.find(\".element\")},onModalSelect:function(o){this.modal.disable(),this.modal.disableCancelBtn(),this.modal.disableSelectBtn(),this.modal.showFooterSpinner();for(var t=this.getSelectedElementIds(),e=0;e<o.length;e++)t.push(o[e].id);var i={categoryIds:t,siteId:o[0].siteId,id:this.settings.id,name:this.settings.name,branchLimit:this.settings.branchLimit,selectionLabel:this.settings.selectionLabel};Craft.postActionRequest(\"elements/get-categories-input-html\",i,$.proxy(function(t,e){if(this.modal.enable(),this.modal.enableCancelBtn(),this.modal.enableSelectBtn(),this.modal.hideFooterSpinner(),\"success\"===e){var i=$(t.html).children(\".elements\");this.$elementsContainer.replaceWith(i),this.$elementsContainer=i,this.resetElements();for(var s=[],n=0;n<o.length;n++){var a=o[n],r=this.getElementById(a.id);r&&(this.animateElementIntoPlace(a.$element,r),s.push(a))}this.updateDisabledElementsInModal(),this.modal.hide(),this.onSelectElements(s)}},this))},removeElement:function(t){var e=t.add(t.parent().siblings(\"ul\").find(\".element\"));this.removeElements(e);for(var i=0;i<e.length;i++)this._animateCategoryAway(e,i)},_animateCategoryAway:function(i,t){var e;t===i.length-1&&(e=$.proxy(function(){var t=i.first().parent().parent(),e=t.parent();e[0]===this.$elementsContainer[0]||t.siblings().length?t.remove():e.remove()},this));var s=$.proxy(function(){this.animateElementAway(i.eq(t),e)},this);0===t?s():setTimeout(s,100*t)}}),Craft.charts={},Craft.charts.DataTable=Garnish.Base.extend({columns:null,rows:null,init:function(t){columns=t.columns,rows=t.rows,rows.forEach($.proxy(function(i){$.each(i,function(t){var e;switch(columns[t].type){case\"date\":e=d3.timeParse(\"%Y-%m-%d\"),i[t]=e(i[t]);break;case\"datetime\":e=d3.timeParse(\"%Y-%m-%d %H:00:00\"),i[t]=e(i[t]);break;case\"percent\":i[t]=i[t]/100;break;case\"number\":i[t]=+i[t]}})},this)),this.columns=columns,this.rows=rows}}),Craft.charts.Tip=Garnish.Base.extend({$container:null,$tip:null,init:function(t){this.$container=t,this.$tip=$('<div class=\"tooltip\"></div>').appendTo(this.$container),this.hide()},setContent:function(t){this.$tip.html(t)},setPosition:function(t){this.$tip.css(\"left\",t.left+\"px\"),this.$tip.css(\"top\",t.top+\"px\")},show:function(){this.$tip.css(\"display\",\"block\")},hide:function(){this.$tip.css(\"display\",\"none\")}}),Craft.charts.BaseChart=Garnish.Base.extend({$container:null,$chart:null,chartBaseClass:\"cp-chart\",dataTable:null,formatLocale:null,timeFormatLocale:null,orientation:null,svg:null,width:null,height:null,init:function(t,e){this.$container=t,this.setSettings(Craft.charts.BaseChart.defaults),this.setSettings(e);var i={formats:window.d3Formats,formatLocaleDefinition:window.d3FormatLocaleDefinition,timeFormatLocaleDefinition:window.d3TimeFormatLocaleDefinition};this.setSettings(i),d3.select(window).on(\"resize\",$.proxy(function(){this.resize()},this))},setSettings:function(t,e){var i=void 0===this.settings?{}:this.settings;this.settings=$.extend(!0,{},i,e,t)},draw:function(t,e){this.setSettings(e),this.dataTable=t,this.formatLocale=d3.formatLocale(this.settings.formatLocaleDefinition),this.timeFormatLocale=d3.timeFormatLocale(this.settings.timeFormatLocaleDefinition),this.orientation=this.settings.orientation,this.$chart&&this.$chart.remove();var i=this.chartBaseClass;this.settings.chartClass&&(i+=\" \"+this.settings.chartClass),this.$chart=$('<div class=\"'+i+'\" />').appendTo(this.$container)},resize:function(){this.draw(this.dataTable,this.settings)},onAfterDrawTicks:function(){$(\".tick\",this.$chart).each(function(t,e){var i=$(\"text\",e);i.clone().appendTo(e),i.attr(\"stroke\",\"#ffffff\"),i.attr(\"stroke-width\",3)})}},{defaults:{formatLocaleDefinition:null,timeFormatLocaleDefinition:null,formats:{numberFormat:\",.2f\",percentFormat:\",.2%\",currencyFormat:\"$,.2f\",shortDateFormats:{day:\"%-m/%-d\",month:\"%-m/%y\",year:\"%Y\"}},margin:{top:0,right:0,bottom:0,left:0},chartClass:null,colors:[\"#0594D1\",\"#DE3800\",\"#FF9A00\",\"#009802\",\"#9B009B\"]}}),Craft.charts.Area=Craft.charts.BaseChart.extend({tip:null,drawingArea:null,init:function(t,e){this.base(t,Craft.charts.Area.defaults),this.setSettings(e)},draw:function(t,e){this.base(t,e),this.tip&&(this.tip=null);var i=this.getChartMargin();this.width=this.$chart.width()-i.left-i.right,this.height=this.$chart.height()-i.top-i.bottom;var s={width:this.width+(i.left+i.right),height:this.height+(i.top+i.bottom),translateX:\"rtl\"!==this.orientation?i.left:i.right,translateY:i.top};this.svg=d3.select(this.$chart.get(0)).append(\"svg\").attr(\"width\",s.width).attr(\"height\",s.height),this.drawingArea=this.svg.append(\"g\").attr(\"transform\",\"translate(\"+s.translateX+\",\"+s.translateY+\")\"),this.drawTicks(),this.drawAxes(),this.drawChart(),this.drawTipTriggers()},drawTicks:function(){var t=this.getX(!0),e=d3.axisBottom(t).tickFormat(this.getXFormatter()).ticks(3);this.drawingArea.append(\"g\").attr(\"class\",\"x ticks-axis\").attr(\"transform\",\"translate(0, \"+this.height+\")\").call(e);var i,s=this.getY();\"rtl\"!==this.orientation?(i=d3.axisLeft(s).tickFormat(this.getYFormatter()).tickValues(this.getYTickValues()).ticks(2),this.drawingArea.append(\"g\").attr(\"class\",\"y ticks-axis\").call(i)):(i=d3.axisRight(s).tickFormat(this.getYFormatter()).tickValues(this.getYTickValues()).ticks(2),this.drawingArea.append(\"g\").attr(\"class\",\"y ticks-axis\").attr(\"transform\",\"translate(\"+this.width+\",0)\").call(i)),this.onAfterDrawTicks()},drawAxes:function(){if(this.settings.xAxis.showAxis){var t=this.getX(),e=d3.axisBottom(t).ticks(0).tickSizeOuter(0);this.drawingArea.append(\"g\").attr(\"class\",\"x axis\").attr(\"transform\",\"translate(0, \"+this.height+\")\").call(e)}if(this.settings.yAxis.showAxis){var i,s=this.getY();\"rtl\"===this.orientation?(i=d3.axisLeft(s).ticks(0),this.drawingArea.append(\"g\").attr(\"class\",\"y axis\").attr(\"transform\",\"translate(\"+(this.width-0)+\", 0)\").call(i)):(i=d3.axisRight(s).ticks(0),this.drawingArea.append(\"g\").attr(\"class\",\"y axis\").attr(\"transform\",\"translate(0, 0)\").call(i))}},drawChart:function(){var e=this.getX(!0),i=this.getY();if(this.settings.xAxis.gridlines){var t=d3.axisBottom(e);this.drawingArea.append(\"g\").attr(\"class\",\"x grid-line\").attr(\"transform\",\"translate(0,\"+this.height+\")\").call(t.tickSize(-this.height,0,0).tickFormat(\"\"))}if(this.settings.yAxis.gridlines){var s=d3.axisLeft(i);this.drawingArea.append(\"g\").attr(\"class\",\"y grid-line\").attr(\"transform\",\"translate(0 , 0)\").call(s.tickSize(-this.width,0).tickFormat(\"\").tickValues(this.getYTickValues()).ticks(2))}var n=d3.line().x(function(t){return e(t[0])}).y(function(t){return i(t[1])});this.drawingArea.append(\"g\").attr(\"class\",\"chart-line\").append(\"path\").datum(this.dataTable.rows).style(\"fill\",\"none\").style(\"stroke\",this.settings.colors[0]).style(\"stroke-width\",\"3px\").attr(\"d\",n);var a=d3.area().x(function(t){return e(t[0])}).y0(this.height).y1(function(t){return i(t[1])});this.drawingArea.append(\"g\").attr(\"class\",\"chart-area\").append(\"path\").datum(this.dataTable.rows).style(\"fill\",this.settings.colors[0]).style(\"fill-opacity\",\"0.3\").attr(\"d\",a),this.settings.plots&&this.drawingArea.append(\"g\").attr(\"class\",\"plots\").selectAll(\"circle\").data(this.dataTable.rows).enter().append(\"circle\").style(\"fill\",this.settings.colors[0]).attr(\"class\",$.proxy(function(t,e){return\"plot plot-\"+e},this)).attr(\"r\",4).attr(\"cx\",$.proxy(function(t){return e(t[0])},this)).attr(\"cy\",$.proxy(function(t){return i(t[1])},this))},drawTipTriggers:function(){if(this.settings.tips){this.tip||(this.tip=new Craft.charts.Tip(this.$chart));var t=this.getChartMargin(),e=(this.drawingArea.select(\".x path.domain\").node().getTotalLength()-t.left-t.right-12)/(this.dataTable.rows.length-1),i=Math.max(0,e),c=this.getX(!0),u=this.getY();this.drawingArea.append(\"g\").attr(\"class\",\"tip-triggers\").selectAll(\"rect\").data(this.dataTable.rows).enter().append(\"rect\").attr(\"class\",\"tip-trigger\").style(\"fill\",\"transparent\").style(\"fill-opacity\",\"1\").attr(\"width\",i).attr(\"height\",this.height).attr(\"x\",$.proxy(function(t){return c(t[0])-i/2},this)).on(\"mouseover\",$.proxy(function(t,e){this.drawingArea.select(\".plot-\"+e).attr(\"r\",5);var i=$(\"<div />\"),s=$('<div class=\"x-value\" />').appendTo(i),n=$('<div class=\"y-value\" />').appendTo(i);s.html(this.getXFormatter()(t[0])),n.html(this.getYFormatter()(t[1]));var a=i.get(0);this.tip.setContent(a);var r,o=this.getChartMargin(),l=u(t[1])+24;if(\"rtl\"!==this.orientation){r=c(t[0])+o.left+24;var h=this.$chart.offset().left+r+this.tip.$tip.width();this.$chart.offset().left+this.$chart.width()-24<h&&(r=c(t[0])-(this.tip.$tip.width()+24))}else r=c(t[0])-(this.tip.$tip.width()+o.left+24);r<0&&(r=c(t[0])+o.left+24);var d={top:l,left:r};this.tip.setPosition(d),this.tip.show()},this)).on(\"mouseout\",$.proxy(function(t,e){this.drawingArea.select(\".plot-\"+e).attr(\"r\",4),this.tip.hide()},this))}},getChartMargin:function(){var t=this.settings.margin,e=this.getYTickValues(),s=0;return $.each(e,$.proxy(function(t,e){var i=8*this.getYFormatter()(e).length;s<i&&(s=i)},this)),s+=10,t.left=s,t},getX:function(t){var e=d3.min(this.dataTable.rows,function(t){return t[0]}),i=d3.max(this.dataTable.rows,function(t){return t[0]}),s=[e,i];\"rtl\"===this.orientation&&(s=[i,e]);var n=0,a=0;t&&(a=n=0);var r=d3.scaleTime().range([n,this.width-a]);return r.domain(s),r},getY:function(){var t=[0,this.getYMaxValue()],e=d3.scaleLinear().range([this.height,0]);return e.domain(t),e},getXFormatter:function(){return this.settings.xAxis.formatter!==$.noop?this.settings.xAxis.formatter(this):Craft.charts.utils.getTimeFormatter(this.timeFormatLocale,this.settings)},getYFormatter:function(){return this.settings.yAxis.formatter!==$.noop?this.settings.yAxis.formatter(this):Craft.charts.utils.getNumberFormatter(this.formatLocale,this.dataTable.columns[1].type,this.settings)},getYMaxValue:function(){return d3.max(this.dataTable.rows,function(t){return t[1]})},getYTickValues:function(){var t=this.getYMaxValue();return 1<t?[t/2,t]:[0,t]}},{defaults:{chartClass:\"area\",margin:{top:25,right:5,bottom:25,left:0},plots:!0,tips:!0,xAxis:{gridlines:!1,showAxis:!0,formatter:$.noop},yAxis:{gridlines:!0,showAxis:!1,formatter:$.noop}}}),Craft.charts.utils={getDuration:function(t){var e=parseInt(t,10),i={hours:Math.floor(e/3600),minutes:Math.floor((e-3600*i.hours)/60),seconds:e-3600*i.hours-60*i.minutes};return i.hours<10&&(i.hours=\"0\"+i.hours),i.minutes<10&&(i.minutes=\"0\"+i.minutes),i.seconds<10&&(i.seconds=\"0\"+i.seconds),i.hours+\":\"+i.minutes+\":\"+i.seconds},getTimeFormatter:function(t,e){switch(e.dataScale){case\"year\":return t.format(\"%Y\");case\"month\":return t.format(e.formats.shortDateFormats.month);case\"hour\":return t.format(e.formats.shortDateFormats.day+\" %H:00:00\");default:return t.format(e.formats.shortDateFormats.day)}},getNumberFormatter:function(t,e,i){switch(e){case\"currency\":return t.format(i.formats.currencyFormat);case\"percent\":return t.format(i.formats.percentFormat);case\"time\":return Craft.charts.utils.getDuration;case\"number\":return t.format(i.formats.numberFormat)}}},Craft.ColorInput=Garnish.Base.extend({$container:null,$input:null,$colorContainer:null,$colorPreview:null,$colorInput:null,init:function(t){this.$container=$(t),this.$input=this.$container.children(\".color-input\"),this.$colorContainer=this.$container.children(\".color\"),this.$colorPreview=this.$colorContainer.children(\".color-preview\"),this.createColorInput(),this.handleTextChange(),this.addListener(this.$input,\"textchange\",\"handleTextChange\")},createColorInput:function(){var t=document.createElement(\"input\");t.setAttribute(\"type\",\"color\"),\"color\"===t.type&&(this.$colorContainer.removeClass(\"static\"),this.$colorInput=$(t).addClass(\"hidden\").insertAfter(this.$input),this.addListener(this.$colorContainer,\"click\",function(){this.$colorInput.trigger(\"click\")}),this.addListener(this.$colorInput,\"change\",\"updateColor\"))},updateColor:function(){this.$input.val(this.$colorInput.val()),this.$input.data(\"garnish-textchange-value\",this.$colorInput.val()),this.handleTextChange()},handleTextChange:function(){var t=this.$input.val();t.length&&\"#\"!==t?(\"#\"!==t[0]&&(t=\"#\"+t,this.$input.val(t),this.$input.data(\"garnish-textchange-value\",t)),this.$colorPreview.css(\"background-color\",t),this.$colorInput&&this.$colorInput.val(t)):this.$colorPreview.css(\"background-color\",\"\")}},{_browserSupportsColorInputs:null,doesBrowserSupportColorInputs:function(){return Craft.ColorInput._browserSupportsColorInputs,Craft.ColorInput._browserSupportsColorInputs}}),Craft.CP=Garnish.Base.extend({authManager:null,$nav:null,$mainContainer:null,$alerts:null,$crumbs:null,$notificationContainer:null,$main:null,$primaryForm:null,$header:null,$mainContent:null,$details:null,$selectedTab:null,$sidebar:null,$contentContainer:null,$edition:null,$collapsibleTables:null,fixedHeader:!1,enableQueue:!0,jobInfo:null,displayedJobInfo:null,displayedJobInfoUnchanged:1,trackJobProgressTimeout:null,jobProgressIcon:null,checkingForUpdates:!1,forcingRefreshOnUpdatesCheck:!1,checkForUpdatesCallbacks:null,init:function(){0!==Craft.remainingSessionTime&&(this.authManager=new Craft.AuthManager),this.$nav=$(\"#nav\"),this.$mainContainer=$(\"#main-container\"),this.$alerts=$(\"#alerts\"),this.$crumbs=$(\"#crumbs\"),this.$notificationContainer=$(\"#notifications\"),this.$main=$(\"#main\"),this.$primaryForm=$(\"#main-form\"),this.$header=$(\"#header\"),this.$mainContent=$(\"#main-content\"),this.$details=$(\"#details\"),this.$sidebar=$(\"#sidebar\"),this.$contentContainer=$(\"#content-container\"),this.$collapsibleTables=$(\"table.collapsible\"),this.$edition=$(\"#edition\"),this.updateSidebarMenuLabel(),this.addListener(Garnish.$win,\"scroll\",\"updateFixedHeader\"),this.updateFixedHeader(),Garnish.$doc.ready($.proxy(function(){this.addListener(Garnish.$win,\"resize\",\"updateResponsiveTables\"),this.updateResponsiveTables();var t=this.$notificationContainer.children(\".error\"),e=this.$notificationContainer.children(\":not(.error)\");t.delay(2*Craft.CP.notificationDuration).velocity(\"fadeOut\"),e.delay(Craft.CP.notificationDuration).velocity(\"fadeOut\"),Garnish.requestAnimationFrame($.proxy(this,\"initConfirmUnloadForms\"))},this)),this.$alerts.length&&this.initAlerts(),this.addListener($(\"#nav-toggle\"),\"click\",\"toggleNav\"),this.addListener($(\"#sidebar-toggle\"),\"click\",\"toggleSidebar\"),this.$primaryForm.length||(this.$primaryForm=$(\"form[data-saveshortcut]:first\")),this.$primaryForm.length&&Garnish.hasAttr(this.$primaryForm,\"data-saveshortcut\")&&this.addListener(Garnish.$doc,\"keydown\",function(t){return Garnish.isCtrlKeyPressed(t)&&t.keyCode===Garnish.S_KEY&&(t.preventDefault(),this.submitPrimaryForm()),!0}),this.initTabs(),this.$edition.hasClass(\"hot\")&&this.addListener(this.$edition,\"click\",function(){document.location.href=Craft.getUrl(\"plugin-store/upgrade-craft\")}),$.isTouchCapable()&&(this.$mainContainer.on(\"focus\",\"input, textarea, .focusable-input\",$.proxy(this,\"_handleInputFocus\")),this.$mainContainer.on(\"blur\",\"input, textarea, .focusable-input\",$.proxy(this,\"_handleInputBlur\"))),$(\"a\").each(function(){this.hostname.length&&this.hostname!==location.hostname&&void 0===$(this).attr(\"target\")&&$(this).attr(\"rel\",\"noopener\").attr(\"target\",\"_blank\")})},initConfirmUnloadForms:function(){if(this.$confirmUnloadForms=$(\"form[data-confirm-unload]\"),this.$confirmUnloadForms.length){for(var t,e,i=0;i<this.$confirmUnloadForms.length;i++)(t=this.$confirmUnloadForms.eq(i)).data(\"initialSerializedValue\")||(e=\"function\"==typeof t.data(\"serializer\")?t.data(\"serializer\")():t.serialize(),t.data(\"initialSerializedValue\",e)),this.addListener(t,\"submit\",function(){this.removeListener(Garnish.$win,\"beforeunload\")});this.addListener(Garnish.$win,\"beforeunload\",function(t){var e,i,s=!1;if(void 0!==Craft.livePreview&&Craft.livePreview.inPreviewMode)s=!0;else for(var n=0;n<this.$confirmUnloadForms.length;n++)if(i=\"function\"==typeof(e=this.$confirmUnloadForms.eq(n)).data(\"serializer\")?e.data(\"serializer\")():e.serialize(),e.data(\"initialSerializedValue\")!==i){s=!0;break}if(s){var a=Craft.t(\"app\",\"Any changes will be lost if you leave this page.\");return t?t.originalEvent.returnValue=a:window.event.returnValue=a,a}})}},_handleInputFocus:function(){this.updateFixedHeader()},_handleInputBlur:function(){this.updateFixedHeader()},submitPrimaryForm:function(){this.trigger(\"beforeSaveShortcut\"),this.$primaryForm.data(\"saveshortcut-redirect\")&&$('<input type=\"hidden\" name=\"redirect\" value=\"'+this.$primaryForm.data(\"saveshortcut-redirect\")+'\"/>').appendTo(this.$primaryForm),this.$primaryForm.trigger({type:\"submit\",saveShortcut:!0})},updateSidebarMenuLabel:function(){var t=this.$sidebar.find(\"a.sel:first\"),e=t.children(\".label\");$(\"#selected-sidebar-item-label\").text(e.length?e.text():t.text()),Garnish.$bod.removeClass(\"showing-sidebar\")},toggleNav:function(){Garnish.$bod.toggleClass(\"showing-nav\")},toggleSidebar:function(){Garnish.$bod.toggleClass(\"showing-sidebar\")},initTabs:function(){this.$selectedTab=null;var t,e,i,s=$(\"#tabs\").find(\"> ul > li\"),n=[],a=[],r=0;for(t=0;t<s.length;t++)n[t]=$(s[t]),a[t]=n[t].width(),r+=a[t],(i=(e=n[t].children(\"a\")).attr(\"href\"))&&\"#\"===i.charAt(0)&&(this.addListener(e,\"click\",function(t){t.preventDefault(),this.selectTab(t.currentTarget)}),encodeURIComponent(i.substr(1))===document.location.hash.substr(1)&&this.selectTab(e)),!this.$selectedTab&&e.hasClass(\"sel\")&&(this.$selectedTab=e);for(t=0;t<s.length;t++)n[t].css(\"max-width\",100*a[t]/r+\"%\")},selectTab:function(t){var e=$(t);if(this.$selectedTab){if(this.$selectedTab.get(0)===e.get(0))return;this.deselectTab()}e.addClass(\"sel\");var i=e.attr(\"href\");$(i).removeClass(\"hidden\"),\"undefined\"!=typeof history&&history.replaceState(void 0,void 0,i),Garnish.$win.trigger(\"resize\"),Garnish.$doc.trigger(\"scroll\"),this.$selectedTab=e},deselectTab:function(){this.$selectedTab&&(this.$selectedTab.removeClass(\"sel\"),\"#\"===this.$selectedTab.attr(\"href\").charAt(0)&&$(this.$selectedTab.attr(\"href\")).addClass(\"hidden\"),this.$selectedTab=null)},updateResponsiveTables:function(){for(this.updateResponsiveTables._i=0;this.updateResponsiveTables._i<this.$collapsibleTables.length;this.updateResponsiveTables._i++)this.updateResponsiveTables._$table=this.$collapsibleTables.eq(this.updateResponsiveTables._i),this.updateResponsiveTables._containerWidth=this.updateResponsiveTables._$table.parent().width(),this.updateResponsiveTables._check=!1,0<this.updateResponsiveTables._containerWidth&&(void 0===this.updateResponsiveTables._$table.data(\"lastContainerWidth\")?this.updateResponsiveTables._check=!0:(this.updateResponsiveTables._isCollapsed=this.updateResponsiveTables._$table.hasClass(\"collapsed\"),this.updateResponsiveTables._containerWidth>this.updateResponsiveTables._$table.data(\"lastContainerWidth\")?this.updateResponsiveTables._isCollapsed&&(this.updateResponsiveTables._$table.removeClass(\"collapsed\"),this.updateResponsiveTables._check=!0):this.updateResponsiveTables._isCollapsed||(this.updateResponsiveTables._check=!0)),!this.updateResponsiveTables._check||this.updateResponsiveTables._$table.width()>this.updateResponsiveTables._containerWidth&&this.updateResponsiveTables._$table.addClass(\"collapsed\"),this.updateResponsiveTables._$table.data(\"lastContainerWidth\",this.updateResponsiveTables._containerWidth))},updateFixedHeader:function(){if(this.$main.length&&this.$main[0].getBoundingClientRect().top<0){if(!this.fixedHeader){var t=this.$header.outerHeight(),e={top:t+\"px\",\"max-height\":\"calc(100vh - \"+t+\"px)\"};this.$sidebar.css(e),this.$details.css(e),this.$mainContent.css(\"margin-top\",this.$header.outerHeight()),Garnish.$bod.addClass(\"fixed-header\"),this.fixedheader=!0}}else this.fixedheader&&(Garnish.$bod.removeClass(\"fixed-header\"),this.$details.css({top:null,\"max-height\":null}),this.$header.css(\"top\",0),this.$mainContent.css(\"margin-top\",0),this.fixedheader=!1)},displayNotification:function(t,e){var i=Craft.CP.notificationDuration;\"error\"===t&&(i*=2);var s=$('<div class=\"notification '+t+'\">'+e+\"</div>\").appendTo(this.$notificationContainer),n=-s.outerWidth()/2+\"px\";s.hide().css({opacity:0,\"margin-left\":n,\"margin-right\":n}).velocity({opacity:1,\"margin-left\":\"2px\",\"margin-right\":\"2px\"},{display:\"inline-block\",duration:\"fast\"}).delay(i).velocity({opacity:0,\"margin-left\":n,\"margin-right\":n},{complete:function(){s.remove()}}),this.trigger(\"displayNotification\",{notificationType:t,message:e})},displayNotice:function(t){this.displayNotification(\"notice\",t)},displayError:function(t){t||(t=Craft.t(\"app\",\"An unknown error occurred.\")),this.displayNotification(\"error\",t)},fetchAlerts:function(){var t={path:Craft.path};Craft.queueActionRequest(\"app/get-cp-alerts\",t,$.proxy(this,\"displayAlerts\"))},displayAlerts:function(t){if(this.$alerts.remove(),Garnish.isArray(t)&&t.length){this.$alerts=$('<ul id=\"alerts\"/>').prependTo(this.$mainContainer);for(var e=0;e<t.length;e++)$(\"<li>\"+t[e]+\"</li>\").appendTo(this.$alerts);var i=this.$alerts.outerHeight();this.$alerts.css(\"margin-top\",-i).velocity({\"margin-top\":0},\"fast\"),this.initAlerts()}},initAlerts:function(){for(var t=this.$alerts.find('a[class^=\"shun:\"]'),e=0;e<t.length;e++)this.addListener(t[e],\"click\",$.proxy(function(t){t.preventDefault();var i=$(t.currentTarget),e={message:i.prop(\"className\").substr(5)};Craft.queueActionRequest(\"app/shun-cp-alert\",e,$.proxy(function(t,e){\"success\"===e&&(t.success?i.parent().remove():this.displayError(t.error))},this))},this))},checkForUpdates:function(t,e){if(this.checkingForUpdates&&!0===t&&!this.forcingRefreshOnUpdatesCheck){var i=e;e=function(){Craft.cp.checkForUpdates(!0,i)}}if(\"function\"==typeof e&&(Garnish.isArray(this.checkForUpdatesCallbacks)||(this.checkForUpdatesCallbacks=[]),this.checkForUpdatesCallbacks.push(e)),!this.checkingForUpdates){this.checkingForUpdates=!0,this.forcingRefreshOnUpdatesCheck=!0===t;var s={forceRefresh:!0===t};Craft.queueActionRequest(\"app/check-for-updates\",s,$.proxy(function(t){if(this.updateUtilitiesBadge(),this.checkingForUpdates=!1,Garnish.isArray(this.checkForUpdatesCallbacks)){var e=this.checkForUpdatesCallbacks;this.checkForUpdatesCallbacks=null;for(var i=0;i<e.length;i++)e[i](t)}this.trigger(\"checkForUpdates\",{updateInfo:t})},this))}},updateUtilitiesBadge:function(){var i=$(\"#nav-utilities\").find(\"> a:not(.sel)\");i.length&&Craft.queueActionRequest(\"app/get-utilities-badge-count\",$.proxy(function(t){var e=i.children(\".badge\");t.badgeCount?(e.length||(e=$('<span class=\"badge\"/>').appendTo(i)),e.text(t.badgeCount)):e.length&&e.remove()},this))},runQueue:function(){this.enableQueue&&(Craft.runQueueAutomatically?Craft.queueActionRequest(\"queue/run\",$.proxy(function(t,e){\"success\"===e&&this.trackJobProgress(!1,!0)},this)):this.trackJobProgress(!1,!0))},trackJobProgress:function(t,e){if(e&&this.trackJobProgressTimeout&&(clearTimeout(this.trackJobProgressTimeout),this.trackJobProgressTimeout=null),!this.trackJobProgressTimeout&&this.enableQueue)if(!0===t){var i=Math.min(6e4,500*this.displayedJobInfoUnchanged);this.trackJobProgressTimeout=setTimeout($.proxy(this,\"_trackJobProgressInternal\"),i)}else this._trackJobProgressInternal()},_trackJobProgressInternal:function(){Craft.queueActionRequest(\"queue/get-job-info?dontExtendSession=1\",$.proxy(function(t,e){\"success\"===e&&(this.trackJobProgressTimeout=null,this.setJobInfo(t,!0),this.jobInfo.length&&this.trackJobProgress(!0))},this))},setJobInfo:function(t,e){if(this.enableQueue){this.jobInfo=t;var i=this.displayedJobInfo;this.displayedJobInfo=this.getDisplayedJobInfo(),i&&this.displayedJobInfo&&i.id===this.displayedJobInfo.id&&i.progress===this.displayedJobInfo.progress&&i.progressLabel===this.displayedJobInfo.progressLabel&&i.status===this.displayedJobInfo.status?this.displayedJobInfoUnchanged++:this.displayedJobInfoUnchanged=1,this.updateJobIcon(e),this.trigger(\"setJobInfo\")}},getDisplayedJobInfo:function(){if(!this.enableQueue)return null;for(var t=[Craft.CP.JOB_STATUS_RESERVED,Craft.CP.JOB_STATUS_FAILED,Craft.CP.JOB_STATUS_WAITING],e=0;e<t.length;e++)for(var i=0;i<this.jobInfo.length;i++)if(this.jobInfo[i].status===t[e])return this.jobInfo[i]},updateJobIcon:function(t){this.enableQueue&&this.$nav.length&&(this.displayedJobInfo?(this.jobProgressIcon||(this.jobProgressIcon=new e),this.displayedJobInfo.status===Craft.CP.JOB_STATUS_RESERVED||this.displayedJobInfo.status===Craft.CP.JOB_STATUS_WAITING?(this.jobProgressIcon.hideFailMode(),this.jobProgressIcon.setDescription(this.displayedJobInfo.description),this.jobProgressIcon.setProgress(this.displayedJobInfo.progress,t)):this.displayedJobInfo.status===Craft.CP.JOB_STATUS_FAILED&&this.jobProgressIcon.showFailMode(Craft.t(\"app\",\"Failed\"))):this.jobProgressIcon&&(this.jobProgressIcon.hideFailMode(),this.jobProgressIcon.complete(),delete this.jobProgressIcon))}},{notificationDuration:2e3,JOB_STATUS_WAITING:1,JOB_STATUS_RESERVED:2,JOB_STATUS_DONE:3,JOB_STATUS_FAILED:4}),Garnish.$scrollContainer=$(\"#content\"),Craft.cp=new Craft.CP;var e=Garnish.Base.extend({$li:null,$a:null,$label:null,hud:null,failMode:!1,_canvasSupported:null,_$bgCanvas:null,_$staticCanvas:null,_$hoverCanvas:null,_$failCanvas:null,_staticCtx:null,_hoverCtx:null,_canvasSize:null,_arcPos:null,_arcRadius:null,_lineWidth:null,_arcStartPos:0,_arcEndPos:0,_arcStartStepSize:null,_arcEndStepSize:null,_arcStep:null,_arcStepTimeout:null,_arcAnimateCallback:null,_progressBar:null,init:function(){if(this.$li=$(\"<li/>\").appendTo(Craft.cp.$nav.children(\"ul\")),this.$a=$('<a id=\"job-icon\"/>').appendTo(this.$li),this.$canvasContainer=$('<span class=\"icon\"/>').appendTo(this.$a),this.$label=$('<span class=\"label\"></span>').appendTo(this.$a),this._canvasSupported=!!document.createElement(\"canvas\").getContext,this._canvasSupported){var t=1<window.devicePixelRatio?2:1;this._canvasSize=18*t,this._arcPos=this._canvasSize/2,this._arcRadius=7*t,this._lineWidth=3*t,this._$bgCanvas=this._createCanvas(\"bg\",\"#61666b\"),this._$staticCanvas=this._createCanvas(\"static\",\"#d7d9db\"),this._$hoverCanvas=this._createCanvas(\"hover\",\"#fff\"),this._$failCanvas=this._createCanvas(\"fail\",\"#da5a47\").hide(),this._staticCtx=this._$staticCanvas[0].getContext(\"2d\"),this._hoverCtx=this._$hoverCanvas[0].getContext(\"2d\"),this._drawArc(this._$bgCanvas[0].getContext(\"2d\"),0,1),this._drawArc(this._$failCanvas[0].getContext(\"2d\"),0,1)}else this._progressBar=new Craft.ProgressBar(this.$canvasContainer),this._progressBar.showProgressBar();this.addListener(this.$a,\"click\",\"toggleHud\")},setDescription:function(t){this.$a.attr(\"title\",t),this.$label.text(t)},setProgress:function(t,e){this._canvasSupported?e?this._animateArc(0,t/100):this._setArc(0,t/100):this._progressBar.setProgressPercentage(t)},complete:function(){this._canvasSupported?this._animateArc(0,1,$.proxy(function(){this._$bgCanvas.velocity(\"fadeOut\"),this._animateArc(1,1,$.proxy(function(){this.$a.remove(),this.destroy()},this))},this)):(this._progressBar.setProgressPercentage(100),this.$a.velocity(\"fadeOut\"))},showFailMode:function(t){this.failMode||(this.failMode=!0,this._canvasSupported?(this._$bgCanvas.hide(),this._$staticCanvas.hide(),this._$hoverCanvas.hide(),this._$failCanvas.show()):(this._progressBar.$progressBar.css(\"border-color\",\"#da5a47\"),this._progressBar.$innerProgressBar.css(\"background-color\",\"#da5a47\"),this._progressBar.setProgressPercentage(50)),this.setDescription(t))},hideFailMode:function(){this.failMode&&(this.failMode=!1,this._canvasSupported?(this._$bgCanvas.show(),this._$staticCanvas.show(),this._$hoverCanvas.show(),this._$failCanvas.hide()):(this._progressBar.$progressBar.css(\"border-color\",\"\"),this._progressBar.$innerProgressBar.css(\"background-color\",\"\"),this._progressBar.setProgressPercentage(50)))},toggleHud:function(){this.hud?this.hud.toggle():this.hud=new o},_createCanvas:function(t,e){var i=$('<canvas id=\"job-icon-'+t+'\" width=\"'+this._canvasSize+'\" height=\"'+this._canvasSize+'\"/>').appendTo(this.$canvasContainer),s=i[0].getContext(\"2d\");return s.strokeStyle=e,s.lineWidth=this._lineWidth,s.lineCap=\"round\",i},_setArc:function(t,e){this._arcStartPos=t,this._arcEndPos=e,this._drawArc(this._staticCtx,t,e),this._drawArc(this._hoverCtx,t,e)},_drawArc:function(t,e,i){t.clearRect(0,0,this._canvasSize,this._canvasSize),t.beginPath(),t.arc(this._arcPos,this._arcPos,this._arcRadius,(1.5+2*e)*Math.PI,(1.5+2*i)*Math.PI),t.stroke(),t.closePath()},_animateArc:function(t,e,i){this._arcStepTimeout&&clearTimeout(this._arcStepTimeout),this._arcStep=0,this._arcStartStepSize=(t-this._arcStartPos)/10,this._arcEndStepSize=(e-this._arcEndPos)/10,this._arcAnimateCallback=i,this._takeNextArcStep()},_takeNextArcStep:function(){this._setArc(this._arcStartPos+this._arcStartStepSize,this._arcEndPos+this._arcEndStepSize),this._arcStep++,this._arcStep<10?this._arcStepTimeout=setTimeout($.proxy(this,\"_takeNextArcStep\"),50):this._arcAnimateCallback&&this._arcAnimateCallback()}}),o=Garnish.HUD.extend({jobsById:null,completedJobs:null,updateViewProxy:null,init:function(){this.jobsById={},this.completedJobs=[],this.updateViewProxy=$.proxy(this,\"updateView\"),this.base(Craft.cp.jobProgressIcon.$a),this.$main.attr(\"id\",\"queue-hud\")},onShow:function(){Craft.cp.on(\"setJobInfo\",this.updateViewProxy),this.updateView(),this.base()},onHide:function(){if(Craft.cp.off(\"setJobInfo\",this.updateViewProxy),this.completedJobs.length){for(var t=0;t<this.completedJobs.length;t++)this.completedJobs[t].destroy();this.completedJobs=[]}this.base()},updateView:function(){var t,e=[];if(Craft.cp.jobInfo)for(t=0;t<Craft.cp.jobInfo.length;t++)e.push(parseInt(Craft.cp.jobInfo[t].id));for(var i in this.jobsById)this.jobsById.hasOwnProperty(i)&&(Craft.inArray(parseInt(i),e)||(this.jobsById[i].complete(),this.completedJobs.push(this.jobsById[i]),delete this.jobsById[i]));if(Craft.cp.jobInfo&&Craft.cp.jobInfo.length)for(t=0;t<Craft.cp.jobInfo.length;t++){var s=Craft.cp.jobInfo[t];if(this.jobsById[s.id])this.jobsById[s.id].updateStatus(s);else{this.jobsById[s.id]=new o.Job(this,s);for(var n=!1,a=t+1;a<Craft.cp.jobInfo.length;a++)if(this.jobsById[Craft.cp.jobInfo[a].id]){this.jobsById[s.id].$container.insertBefore(this.jobsById[Craft.cp.jobInfo[a].id].$container),n=!0;break}if(!n){var r=this.$main.children(\"object\");r.length?this.jobsById[s.id].$container.insertBefore(r):this.jobsById[s.id].$container.appendTo(this.$main)}}}else this.hide()}});o.Job=Garnish.Base.extend({hud:null,id:null,description:null,status:null,progress:null,$container:null,$statusContainer:null,$descriptionContainer:null,$progressLabel:null,_progressBar:null,init:function(t,e){this.hud=t,this.id=e.id,this.description=e.description,this.$container=$(\"<div/>\",{class:\"job\"});var i=$(\"<div/>\",{class:\"flex\"}).appendTo(this.$container);$(\"<div/>\",{class:\"flex-grow\"}).text(e.description).appendTo(i),this.$statusContainer=$('<div class=\"job-status\"/>').appendTo(i),this.$container.data(\"job\",this),this.updateStatus(e)},updateStatus:function(t){if(this.status!==(this.status=t.status))switch(this.$statusContainer.empty(),this.status){case Craft.CP.JOB_STATUS_WAITING:this.$statusContainer.text(Craft.t(\"app\",\"Pending\"));break;case Craft.CP.JOB_STATUS_RESERVED:this._progressBar=new Craft.ProgressBar(this.$statusContainer),this._progressBar.showProgressBar();break;case Craft.CP.JOB_STATUS_FAILED:$(\"<span/>\",{class:\"error\",text:Craft.t(\"app\",\"Failed\"),title:t.error}).appendTo(this.$statusContainer);var e=$('<a class=\"menubtn error\" title=\"'+Craft.t(\"app\",\"Options\")+'\"/>').appendTo(this.$statusContainer);$('<div class=\"menu\"><ul><li><a data-action=\"retry\">'+Craft.t(\"app\",\"Try again\")+'</a></li><li><a data-action=\"release\">'+Craft.t(\"app\",\"Cancel\")+\"</a></li></ul></div>\").appendTo(this.$statusContainer),new Garnish.MenuBtn(e,{onOptionSelect:$.proxy(this,\"performErrorAction\")})}this.status===Craft.CP.JOB_STATUS_RESERVED?(this._progressBar.setProgressPercentage(t.progress),t.progressLabel&&(this.$progressLabel||(this.$progressLabel=$('<div class=\"light smalltext\"/>').appendTo(this.$container)),this.$progressLabel.text(t.progressLabel))):this.$progressLabel&&(this.$progressLabel.remove(),this.$progressLabel=null)},performErrorAction:function(t){switch($(t).data(\"action\")){case\"retry\":Craft.cp.displayedJobInfo.status=Craft.CP.JOB_STATUS_WAITING,Craft.cp.displayedJobInfo.progress=0,Craft.cp.updateJobIcon(!1),Craft.postActionRequest(\"queue/retry\",{id:this.id},$.proxy(function(t,e){\"success\"===e&&Craft.cp.trackJobProgress(!1,!0)},this));break;case\"release\":Craft.postActionRequest(\"queue/release\",{id:this.id},$.proxy(function(t,e){\"success\"===e&&Craft.cp.trackJobProgress(!1,!0)},this))}},complete:function(){this.$statusContainer.empty(),$('<div data-icon=\"check\"/>').appendTo(this.$statusContainer)},destroy:function(){this.hud.jobsById[this.id]&&delete this.hud.jobsById[this.id],this.$container.remove(),this.base()}}),Craft.CustomizeSourcesModal=Garnish.Modal.extend({elementIndex:null,$elementIndexSourcesContainer:null,$sidebar:null,$sourcesContainer:null,$sourceSettingsContainer:null,$newHeadingBtn:null,$footer:null,$footerBtnContainer:null,$saveBtn:null,$cancelBtn:null,$saveSpinner:null,$loadingSpinner:null,sourceSort:null,sources:null,selectedSource:null,updateSourcesOnSave:!1,availableTableAttributes:null,init:function(t,e){this.base(),this.setSettings(e,{resizable:!0}),this.elementIndex=t,this.$elementIndexSourcesContainer=this.elementIndex.$sidebar.children(\"nav\").children(\"ul\");var i=$('<form class=\"modal customize-sources-modal\"/>').appendTo(Garnish.$bod);this.$sidebar=$('<div class=\"cs-sidebar block-types\"/>').appendTo(i),this.$sourcesContainer=$('<div class=\"sources\">').appendTo(this.$sidebar),this.$sourceSettingsContainer=$('<div class=\"source-settings\">').appendTo(i),this.$footer=$('<div class=\"footer\"/>').appendTo(i),this.$footerBtnContainer=$('<div class=\"buttons right\"/>').appendTo(this.$footer),this.$cancelBtn=$('<div class=\"btn\" role=\"button\"/>').text(Craft.t(\"app\",\"Cancel\")).appendTo(this.$footerBtnContainer),this.$saveBtn=$('<div class=\"btn submit disabled\" role=\"button\"/>').text(Craft.t(\"app\",\"Save\")).appendTo(this.$footerBtnContainer),this.$saveSpinner=$('<div class=\"spinner hidden\"/>').appendTo(this.$footerBtnContainer),this.$newHeadingBtn=$('<div class=\"btn submit add icon\"/>').text(Craft.t(\"app\",\"New heading\")).appendTo($('<div class=\"buttons left secondary-buttons\"/>').appendTo(this.$footer)),this.$loadingSpinner=$('<div class=\"spinner\"/>').appendTo(i),this.setContainer(i),this.show();var s={elementType:this.elementIndex.elementType};Craft.postActionRequest(\"element-index-settings/get-customize-sources-modal-data\",s,$.proxy(function(t,e){this.$loadingSpinner.remove(),\"success\"===e&&(this.$saveBtn.removeClass(\"disabled\"),this.buildModal(t))},this)),this.addListener(this.$newHeadingBtn,\"click\",\"handleNewHeadingBtnClick\"),this.addListener(this.$cancelBtn,\"click\",\"hide\"),this.addListener(this.$saveBtn,\"click\",\"save\"),this.addListener(this.$container,\"submit\",\"save\")},buildModal:function(t){this.availableTableAttributes=t.availableTableAttributes,this.sourceSort=new Garnish.DragSort({handle:\".move\",axis:\"y\",onSortChange:$.proxy(function(){this.updateSourcesOnSave=!0},this)}),this.sources=[];for(var e=0;e<t.sources.length;e++){var i=this.addSource(t.sources[e]);this.sources.push(i)}this.selectedSource||void 0===this.sources[0]||this.sources[0].select()},addSource:function(t){var e,i=$('<div class=\"customize-sources-item\"/>').appendTo(this.$sourcesContainer),s=$('<div class=\"label\"/>').appendTo(i),n=$('<input type=\"hidden\"/>').appendTo(i);return $('<a class=\"move icon\" title=\"'+Craft.t(\"app\",\"Reorder\")+'\" role=\"button\"></a>').appendTo(i),void 0!==t.heading?(i.addClass(\"heading\"),n.attr(\"name\",\"sourceOrder[][heading]\"),(e=new Craft.CustomizeSourcesModal.Heading(this,i,s,n,t)).updateItemLabel(t.heading)):(n.attr(\"name\",\"sourceOrder[][key]\").val(t.key),(e=new Craft.CustomizeSourcesModal.Source(this,i,s,n,t)).updateItemLabel(t.label),(this.elementIndex.sourceKey+\"/\").substr(0,t.key.length+1)===t.key+\"/\"&&e.select()),this.sourceSort.addItems(i),e},handleNewHeadingBtnClick:function(){var t=this.addSource({heading:\"\"});Garnish.scrollContainerToElement(this.$sidebar,t.$item),t.select(),this.updateSourcesOnSave=!0},save:function(t){if(t&&t.preventDefault(),!this.$saveBtn.hasClass(\"disabled\")&&this.$saveSpinner.hasClass(\"hidden\")){this.$saveSpinner.removeClass(\"hidden\");var e=this.$container.serialize()+\"&elementType=\"+this.elementIndex.elementType;Craft.postActionRequest(\"element-index-settings/save-customize-sources-modal-settings\",e,$.proxy(function(t,e){if(this.$saveSpinner.addClass(\"hidden\"),\"success\"===e&&t.success){if(this.updateSourcesOnSave&&this.$elementIndexSourcesContainer.length){for(var i,s=null,n=0;n<this.sourceSort.$items.length;n++){var a=this.sourceSort.$items.eq(n).data(\"source\"),r=a.getIndexSource();r&&(a.isHeading()?i=r:(i&&(this.appendSource(i,s),s=i,i=null),this.appendSource(r,s),s=r))}if(s){var o=s.nextAll();this.elementIndex.sourceSelect.removeItems(o),o.remove()}}this.selectedSource&&this.selectedSource.sourceData.key&&(this.elementIndex.selectSourceByKey(this.selectedSource.sourceData.key),this.elementIndex.updateElements()),Craft.cp.displayNotice(Craft.t(\"app\",\"Source settings saved\")),this.hide()}else{var l=\"success\"===e&&t.error?t.error:Craft.t(\"app\",\"An unknown error occurred.\");Craft.cp.displayError(l)}},this))}},appendSource:function(t,e){e?t.insertAfter(e):t.prependTo(this.$elementIndexSourcesContainer)},destroy:function(){for(var t=0;t<this.sources.length;t++)this.sources[t].destroy();delete this.sources,this.base()}}),Craft.CustomizeSourcesModal.BaseSource=Garnish.Base.extend({modal:null,$item:null,$itemLabel:null,$itemInput:null,$settingsContainer:null,sourceData:null,init:function(t,e,i,s,n){this.modal=t,this.$item=e,this.$itemLabel=i,this.$itemInput=s,this.sourceData=n,this.$item.data(\"source\",this),this.addListener(this.$item,\"click\",\"select\")},isHeading:function(){return!1},isSelected:function(){return this.modal.selectedSource===this},select:function(){this.isSelected()||(this.modal.selectedSource&&this.modal.selectedSource.deselect(),this.$item.addClass(\"sel\"),(this.modal.selectedSource=this).$settingsContainer?this.$settingsContainer.removeClass(\"hidden\"):this.$settingsContainer=$(\"<div/>\").append(this.createSettings()).appendTo(this.modal.$sourceSettingsContainer),this.modal.$sourceSettingsContainer.scrollTop(0))},createSettings:function(){},getIndexSource:function(){},deselect:function(){this.$item.removeClass(\"sel\"),this.modal.selectedSource=null,this.$settingsContainer.addClass(\"hidden\")},updateItemLabel:function(t){this.$itemLabel.text(t)},destroy:function(){this.$item.data(\"source\",null),this.base()}}),Craft.CustomizeSourcesModal.Source=Craft.CustomizeSourcesModal.BaseSource.extend({createSettings:function(){if(this.sourceData.tableAttributes.length){var t,e,i,s,n=this.sourceData.tableAttributes[0],a=n[0],r=n[1],o=this.createTableColumnOption(a,r,!0,!0),l=$(\"<div/>\"),h=[a];for($('<input type=\"hidden\" name=\"sources['+this.sourceData.key+'][tableAttributes][]\" value=\"\"/>').appendTo(l),t=1;t<this.sourceData.tableAttributes.length;t++)i=(e=this.sourceData.tableAttributes[t])[0],s=e[1],l.append(this.createTableColumnOption(i,s,!1,!0)),h.push(i);for(t=0;t<this.modal.availableTableAttributes.length;t++)i=(e=this.modal.availableTableAttributes[t])[0],s=e[1],Craft.inArray(i,h)||l.append(this.createTableColumnOption(i,s,!1,!1));return new Garnish.DragSort(l.children(),{handle:\".move\",axis:\"y\"}),Craft.ui.createField($([o[0],l[0]]),{label:Craft.t(\"app\",\"Table Columns\"),instructions:Craft.t(\"app\",\"Choose which table columns should be visible for this source, and in which order.\")})}},createTableColumnOption:function(t,e,i,s){var n=$('<div class=\"customize-sources-table-column\"/>').append('<div class=\"icon move\"/>').append(Craft.ui.createCheckbox({label:e,name:\"sources[\"+this.sourceData.key+\"][tableAttributes][]\",value:t,checked:s,disabled:i}));return i&&n.children(\".move\").addClass(\"disabled\"),n},getIndexSource:function(){var t=this.modal.elementIndex.getSourceByKey(this.sourceData.key);if(t)return t.closest(\"li\")}}),Craft.CustomizeSourcesModal.Heading=Craft.CustomizeSourcesModal.BaseSource.extend({$labelField:null,$labelInput:null,$deleteBtn:null,isHeading:function(){return!0},select:function(){this.base(),this.$labelInput.trigger(\"focus\")},createSettings:function(){return this.$labelField=Craft.ui.createTextField({label:Craft.t(\"app\",\"Heading\"),instructions:Craft.t(\"app\",\"This can be left blank if you just want an unlabeled separator.\"),value:this.sourceData.heading}),this.$labelInput=this.$labelField.find(\".text\"),this.$deleteBtn=$('<a class=\"error delete\"/>').text(Craft.t(\"app\",\"Delete heading\")),this.addListener(this.$labelInput,\"textchange\",\"handleLabelInputChange\"),this.addListener(this.$deleteBtn,\"click\",\"deleteHeading\"),$([this.$labelField[0],$(\"<hr/>\")[0],this.$deleteBtn[0]])},handleLabelInputChange:function(){this.updateItemLabel(this.$labelInput.val()),this.modal.updateSourcesOnSave=!0},updateItemLabel:function(t){this.$itemLabel.html((t?Craft.escapeHtml(t):'<em class=\"light\">'+Craft.t(\"app\",\"(blank)\")+\"</em>\")+\"&nbsp;\"),this.$itemInput.val(t)},deleteHeading:function(){this.modal.sourceSort.removeItems(this.$item),this.modal.sources.splice($.inArray(this,this.modal.sources),1),this.modal.updateSourcesOnSave=!0,this.isSelected()&&(this.deselect(),this.modal.sources.length&&this.modal.sources[0].select()),this.$item.remove(),this.$settingsContainer.remove(),this.destroy()},getIndexSource:function(){var t=this.$labelInput?this.$labelInput.val():this.sourceData.heading;return $('<li class=\"heading\"/>').append($(\"<span/>\").text(t))}}),Craft.DataTableSorter=Garnish.DragSort.extend({$table:null,init:function(t,e){this.$table=$(t);var i=this.$table.children(\"tbody\").children(\":not(.filler)\");(e=$.extend({},Craft.DataTableSorter.defaults,e)).container=this.$table.children(\"tbody\"),e.helper=$.proxy(this,\"getHelper\"),e.caboose=\"<tr/>\",e.axis=Garnish.Y_AXIS,e.magnetStrength=4,e.helperLagBase=1.5,this.base(i,e)},getHelper:function(t){var e=$('<div class=\"'+this.settings.helperClass+'\"/>').appendTo(Garnish.$bod),i=$(\"<table/>\").appendTo(e),s=$(\"<tbody/>\").appendTo(i);t.appendTo(s),i.width(this.$table.width()),i.prop(\"className\",this.$table.prop(\"className\"));for(var n=this.$table.find(\"tr:first\").children(),a=t.children(),r=0;r<a.length;r++)$(a[r]).width($(n[r]).width());return e}},{defaults:{handle:\".move\",helperClass:\"datatablesorthelper\"}}),Craft.DeleteUserModal=Garnish.Modal.extend({id:null,userId:null,$deleteActionRadios:null,$deleteSpinner:null,userSelect:null,_deleting:!1,init:function(t,e){this.id=Math.floor(1e9*Math.random()),this.userId=t,e=$.extend(Craft.DeleteUserModal.defaults,e);var i,s=$('<form class=\"modal fitted deleteusermodal\" method=\"post\" accept-charset=\"UTF-8\">'+Craft.getCsrfInput()+'<input type=\"hidden\" name=\"action\" value=\"users/delete-user\"/>'+(Garnish.isArray(this.userId)?\"\":'<input type=\"hidden\" name=\"userId\" value=\"'+this.userId+'\"/>')+(e.redirect?'<input type=\"hidden\" name=\"redirect\" value=\"'+e.redirect+'\"/>':\"\")+\"</form>\").appendTo(Garnish.$bod),n=$('<div class=\"body\"><div class=\"content-summary\"><p>'+Craft.t(\"app\",\"What do you want to do with their content?\")+'</p><ul class=\"bullets\"></ul></div><div class=\"options\"><label><input type=\"radio\" name=\"contentAction\" value=\"transfer\"/> '+Craft.t(\"app\",\"Transfer it to:\")+'</label><div id=\"transferselect'+this.id+'\" class=\"elementselect\"><div class=\"elements\"></div><div class=\"btn add icon dashed\">'+Craft.t(\"app\",\"Choose a user\")+'</div></div></div><div><label class=\"error\"><input type=\"radio\" name=\"contentAction\" value=\"delete\"/> '+Craft.t(\"app\",\"Delete it\")+\"</label></div></div>\").appendTo(s),a=$('<div class=\"buttons right\"/>').appendTo(n),r=$('<div class=\"btn\">'+Craft.t(\"app\",\"Cancel\")+\"</div>\").appendTo(a);if(e.contentSummary.length)for(var o=0;o<e.contentSummary.length;o++)n.find(\"ul\").append($(\"<li/>\",{text:e.contentSummary[o]}));else n.find(\"ul\").remove();if(this.$deleteActionRadios=n.find(\"input[type=radio]\"),this.$deleteSubmitBtn=$('<input type=\"submit\" class=\"btn submit disabled\" value=\"'+(Garnish.isArray(this.userId)?Craft.t(\"app\",\"Delete users\"):Craft.t(\"app\",\"Delete user\"))+'\" />').appendTo(a),this.$deleteSpinner=$('<div class=\"spinner hidden\"/>').appendTo(a),Garnish.isArray(this.userId)){i=[\"and\"];for(o=0;o<this.userId.length;o++)i.push(\"not \"+this.userId[o])}else i=\"not \"+this.userId;this.userSelect=new Craft.BaseElementSelectInput({id:\"transferselect\"+this.id,name:\"transferContentTo\",elementType:\"craft\\\\elements\\\\User\",criteria:{id:i},limit:1,modalSettings:{closeOtherModals:!1},onSelectElements:$.proxy(function(){this.updateSizeAndPosition(),this.$deleteActionRadios.first().prop(\"checked\")?this.validateDeleteInputs():this.$deleteActionRadios.first().trigger(\"click\")},this),onRemoveElements:$.proxy(this,\"validateDeleteInputs\"),selectable:!1,editable:!1}),this.addListener(r,\"click\",\"hide\"),this.addListener(this.$deleteActionRadios,\"change\",\"validateDeleteInputs\"),this.addListener(s,\"submit\",\"handleSubmit\"),this.base(s,e)},validateDeleteInputs:function(){var t=!1;return this.$deleteActionRadios.eq(0).prop(\"checked\")?t=!!this.userSelect.totalSelected:this.$deleteActionRadios.eq(1).prop(\"checked\")&&(t=!0),t?this.$deleteSubmitBtn.removeClass(\"disabled\"):this.$deleteSubmitBtn.addClass(\"disabled\"),t},handleSubmit:function(t){!this._deleting&&this.validateDeleteInputs()?(this.$deleteSubmitBtn.addClass(\"active\"),this.$deleteSpinner.removeClass(\"hidden\"),this.disable(),this.userSelect.disable(),!(this._deleting=!0)===this.settings.onSubmit()&&t.preventDefault()):t.preventDefault()},onFadeIn:function(){Garnish.isMobileBrowser(!0)||this.$deleteActionRadios.first().trigger(\"focus\"),this.base()}},{defaults:{contentSummary:[],onSubmit:$.noop,redirect:null}}),Craft.DraftEditor=Garnish.Base.extend({$revisionBtn:null,$revisionLabel:null,$spinner:null,$statusIcon:null,$editMetaBtn:null,metaHud:null,$nameTextInput:null,$notesTextInput:null,$saveMetaBtn:null,lastSerializedValue:null,timeout:null,saving:!1,saveXhr:null,checkFormAfterUpdate:!1,submittingForm:!1,duplicatedElements:null,errors:null,preview:null,previewToken:null,init:function(t){if(this.setSettings(t,Craft.DraftEditor.defaults),this.duplicatedElements={},this.$revisionBtn=$(\"#revision-btn\"),this.$revisionLabel=$(\"#revision-label\"),this.$spinner=$(\"#revision-spinner\"),this.$statusIcon=$(\"#revision-status\"),this.settings.previewTargets.length){this.settings.enablePreview&&this.addListener($(\"#preview-btn\"),\"click\",\"openPreview\");var e=$(\"#share-btn\");1===this.settings.previewTargets.length?this.addListener(e,\"click\",function(){this.openShareLink(this.settings.previewTargets[0].url)}):this.createShareMenu(e)}this.settings.revisionId||(this.lastSerializedValue=this.serializeForm(!0),Craft.cp.$primaryForm.data(\"initialSerializedValue\",this.lastSerializedValue),Craft.cp.$primaryForm.data(\"serializer\",function(){return this.serializeForm(!0)}.bind(this)),this.settings.draftId?this.initForDraft():(this.addListener($(\"#save-draft-btn\"),\"click\",function(t){t.preventDefault(),this.createDraft(),this.removeListener(Craft.cp.$primaryForm,\"submit.saveShortcut\")}.bind(this)),this.settings.canUpdateSource||this.addListener(Craft.cp.$primaryForm,\"submit.saveShortcut\",function(t){t.saveShortcut&&(t.preventDefault(),this.createDraft(),this.removeListener(Craft.cp.$primaryForm,\"submit.saveShortcut\"))}.bind(this))))},initForDraft:function(){this.createEditMetaBtn(),this.addListener(Garnish.$bod,\"keypress keyup change focus blur click mousedown mouseup\",function(t){$(t.target).is(this.statusIcons())||(clearTimeout(this.timeout),Craft.inArray(t.type,[\"keypress\",\"keyup\",\"change\"])?this.timeout=setTimeout(this.checkForm.bind(this),500):this.checkForm())}),this.addListener(Craft.cp.$primaryForm,\"submit\",\"handleFormSubmit\"),this.addListener(this.$statusIcon,\"click\",function(){this.showStatusHud(this.$statusIcon)}.bind(this))},showStatusHud:function(t){if(null===this.errors)e=\"<p>\"+Craft.t(\"app\",\"The draft has been saved.\")+\"</p>\";else{var e='<p class=\"error\">'+Craft.t(\"app\",\"The draft could not be saved.\")+\"</p>\";if(this.errors.length){for(e+='<ul class=\"errors\">',i=0;i<this.errors.length;i++)e+=\"<li>\"+Craft.escapeHtml(this.errors[i])+\"</li>\";e+=\"</ul>\"}}var s=new Garnish.HUD(t,e,{onHide:function(){s.destroy(),delete s}})},spinners:function(){return this.preview?this.$spinner.add(this.preview.$spinner):this.$spinner},statusIcons:function(){return this.preview?this.$statusIcon.add(this.preview.$statusIcon):this.$statusIcon},createEditMetaBtn:function(){this.$editMetaBtn=$(\"<a/>\",{class:\"btn edit icon\",title:Craft.t(\"app\",\"Edit draft settings\")}).appendTo($(\"#revision-btngroup\")),this.addListener(this.$editMetaBtn,\"click\",\"showMetaHud\")},createShareMenu:function(t){t.addClass(\"menubtn\");for(var e,i,s=$(\"<div/>\",{class:\"menu\"}).insertAfter(t),n=$(\"<ul/>\").appendTo(s),a=0;a<this.settings.previewTargets.length;a++)e=$(\"<li/>\").appendTo(n),i=$(\"<a/>\",{text:this.settings.previewTargets[a].label}).appendTo(e),this.addListener(i,\"click\",{target:a},function(t){this.openShareLink(this.settings.previewTargets[t.data.target].url)}.bind(this))},getPreviewToken:function(){return new Promise(function(i,s){this.previewToken?i(this.previewToken):Craft.postActionRequest(\"preview/create-token\",{elementType:this.settings.elementType,sourceId:this.settings.sourceId,siteId:this.settings.siteId,draftId:this.settings.draftId,revisionId:this.settings.revisionId},function(t,e){\"success\"===e?(this.previewToken=t.token,i(this.previewToken)):s()}.bind(this))}.bind(this))},getTokenizedPreviewUrl:function(s,n){return new Promise(function(e,t){var i={};!n&&this.settings.isLive||(i[n||\"x-craft-preview\"]=Craft.randomString(10)),this.settings.isLive?e(Craft.getUrl(s,i)):this.getPreviewToken().then(function(t){i[Craft.tokenParam]=t,e(Craft.getUrl(s,i))}).catch(t)}.bind(this))},openShareLink:function(t){this.getTokenizedPreviewUrl(t).then(function(t){window.open(t)})},getPreview:function(){return this.preview||(this.preview=new Craft.Preview(this)),this.preview},openPreview:function(){return new Promise(function(t,e){this.ensureIsDraftOrRevision().then(function(){this.getPreview().open(),t()}.bind(this)).catch(e)}.bind(this))},ensureIsDraftOrRevision:function(){return new Promise(function(t,e){this.settings.draftId||this.settings.revisionid?t():this.createDraft().then(t).catch(e)}.bind(this))},serializeForm:function(t){var e=Craft.cp.$primaryForm.serialize();return this.isPreviewActive()&&(e=e.replace(\"__PREVIEW_FIELDS__=1\",this.preview.$editor.serialize())),t&&!this.settings.isUnsavedDraft&&(e=(e=e.replace(/&action=[^&]*/,\"\")).replace(/&redirect=[^&]*/,\"\")),e},checkForm:function(t){if(this.settings.draftId){clearTimeout(this.timeout),this.timeout=null;var e=this.serializeForm(!0);!t&&e===this.lastSerializedValue||this.saveDraft(e)}},isPreviewActive:function(){return this.preview&&this.preview.isActive},createDraft:function(){return new Promise(function(t,e){this.saveDraft(this.serializeForm(!0)).then(t).catch(e)}.bind(this))},saveDraft:function(b){return new Promise(function(f,m){if(this.submittingForm)m();else if(this.lastSerializedValue=b,this.saving)this.checkFormAfterUpdate=!0;else{this.saving=!0;var v=this.spinners().removeClass(\"hidden\"),C=this.statusIcons().removeClass(\"invisible checkmark-icon alert-icon\").addClass(\"hidden\");this.$saveMetaBtn&&this.$saveMetaBtn.addClass(\"active\"),this.errors=null;var t=Craft.getActionUrl(this.settings.saveDraftAction);this.saveXhr=Craft.postActionRequest(t,this.prepareData(b),function(t,e){if(v.addClass(\"hidden\"),this.$saveMetaBtn&&this.$saveMetaBtn.removeClass(\"active\"),this.saving=!1,\"abort\"!==e){if(\"success\"!==e||t.errors)return this.errors=(t?t.errors:null)||[],C.removeClass(\"hidden checkmark-icon\").addClass(\"alert-icon\").attr(\"title\",Craft.t(\"app\",\"The draft could not be saved.\")),void m();t.title&&$(\"#header h1\").text(t.title),t.docTitle&&(document.title=t.docTitle),this.$revisionLabel.text(t.draftName),this.settings.draftName=t.draftName,this.settings.draftNotes=t.draftNotes;var i=this.$revisionBtn.data(\"menubtn\")?this.$revisionBtn.data(\"menubtn\").menu:null,s=!this.settings.draftId;if(s){var n,a=document.location.href.search(\"#\");n=-1!==a?document.location.href.substr(0,a):document.location.href,n+=(n.match(/\\?/)?\"&\":\"?\")+\"draftId=\"+t.draftId,-1!==a&&(n+=document.location.href.substr(a)),history.replaceState({},\"\",n);var r=$(\"#save-btn-container\");r.length&&r.replaceWith($(\"<input/>\",{type:\"submit\",class:\"btn submit\",value:Craft.t(\"app\",\"Update {type}\",{type:this.settings.elementTypeDisplayName})}));var o=$(\"#save-draft-btn-container\");if(o.add(o.prev(\".spacer\")).remove(),this.settings.draftId=t.draftId,this.settings.isLive=!1,this.settings.canDeleteDraft=!0,this.previewToken=null,this.initForDraft(),i){i.$options.filter(\":not(.site-option)\").removeClass(\"sel\");var l=i.$container.find(\".revision-group-drafts\");if(!l.length){var h=$(\"<h6/>\",{text:Craft.t(\"app\",\"Drafts\")}).insertAfter(i.$container.find(\".revision-group-current\"));l=$(\"<ul/>\",{class:\"padded revision-group-drafts\"}).insertAfter(h)}var d=$(\"<li/>\").appendTo(l),c=$(\"<a/>\",{class:\"sel\",html:'<span class=\"draft-name\"></span> <span class=\"draft-creator light\"></span>'}).appendTo(d);i.addOptions(c),i.selectOption(c);for(var u=i.$options.filter(\".site-option[href]\"),p=0;p<u.length;p++){var g=u.eq(p);g.attr(\"href\",Craft.getUrl(g.attr(\"href\"),{draftId:t.draftId}))}}}i&&(i.$options.filter(\".sel\").find(\".draft-name\").text(t.draftName),i.$options.filter(\".sel\").find(\".draft-creator\").text(Craft.t(\"app\",\"by {creator}\",{creator:t.creator}))),t.previewTargets&&JSON.stringify(t.previewTargets)!==JSON.stringify(this.settings.previewTargets)&&this.updatePreviewTargets(t.previewTargets),this.afterUpdate(b),s&&this.trigger(\"createDraft\"),this.$nameTextInput&&this.checkMetaValues(),$.extend(this.duplicatedElements,t.duplicatedElements),f()}}.bind(this))}}.bind(this))},prepareData:function(t){for(var e in this.duplicatedElements)this.duplicatedElements.hasOwnProperty(e)&&(t=t.replace(new RegExp(Craft.escapeRegex(encodeURIComponent(\"][\"+e+\"]\")),\"g\"),\"][\"+this.duplicatedElements[e]+\"]\"));return this.settings.draftId&&(t+=\"&draftId=\"+this.settings.draftId+\"&draftName=\"+encodeURIComponent(this.settings.draftName)+\"&draftNotes=\"+encodeURIComponent(this.settings.draftNotes||\"\")),t},updatePreviewTargets:function(t){for(var e={},i=0;i<this.settings.previewTargets.length;i++)e[this.settings.previewTargets[i].label]=this.settings.previewTargets[i];for(i=0;i<t.length;i++)e[t[i].label]&&(e[t[i].label].url=t[i].url)},afterUpdate:function(t){Craft.cp.$primaryForm.data(\"initialSerializedValue\",t),this.statusIcons().removeClass(\"hidden\").addClass(\"checkmark-icon\").attr(\"title\",Craft.t(\"app\",\"The draft has been saved.\")),this.trigger(\"update\"),this.checkFormAfterUpdate&&(this.checkFormAfterUpdate=!1,this.timeout||this.checkForm())},showMetaHud:function(){this.metaHud?this.metaHud.show():(this.createMetaHud(),this.onMetaHudShow()),Garnish.isMobileBrowser(!0)||this.$nameTextInput.trigger(\"focus\")},createMetaHud:function(){var t,e,i=$(\"<div/>\");t=$('<div class=\"field\"><div class=\"heading\"><label for=\"draft-name\">'+Craft.t(\"app\",\"Draft Name\")+\"</label></div></div>\").appendTo(i),e=$('<div class=\"input\"/>').appendTo(t),this.$nameTextInput=$('<input type=\"text\" class=\"text fullwidth\" id=\"draft-name\"/>').appendTo(e).val(this.settings.draftName),t=$('<div class=\"field\"><div class=\"heading\"><label for=\"draft-notes\">'+Craft.t(\"app\",\"Notes\")+\"</label></div></div>\").appendTo(i),e=$('<div class=\"input\"/>').appendTo(t),this.$notesTextInput=$('<textarea class=\"text fullwidth\" id=\"draft-notes\" rows=\"2\"/>').appendTo(e).val(this.settings.draftNotes);var s=$('<div class=\"hud-footer flex flex-center\"/>').appendTo(i);if(this.settings.canDeleteDraft)var n=$('<a class=\"error\" role=\"button\">'+Craft.t(\"app\",\"Delete\")+\"</a>\").appendTo(s);$('<div class=\"flex-grow\"></div>').appendTo(s),this.$saveMetaBtn=$('<input type=\"submit\" class=\"btn submit disabled\" value=\"'+Craft.t(\"app\",\"Save\")+'\"/>').appendTo(s),this.metaHud=new Garnish.HUD(this.$editMetaBtn,i,{onSubmit:this.saveMeta.bind(this)}),new Garnish.NiceText(this.$notesTextInput),this.addListener(this.$notesTextInput,\"keydown\",\"onNotesKeydown\"),this.addListener(this.$nameTextInput,\"textchange\",\"checkMetaValues\"),this.addListener(this.$notesTextInput,\"textchange\",\"checkMetaValues\"),this.metaHud.on(\"show\",this.onMetaHudShow.bind(this)),this.metaHud.on(\"hide\",this.onMetaHudHide.bind(this)),this.metaHud.on(\"escape\",this.onMetaHudEscape.bind(this)),n&&this.addListener(n,\"click\",\"deleteDraft\")},onMetaHudShow:function(){this.$editMetaBtn.addClass(\"active\")},onMetaHudHide:function(){this.$editMetaBtn.removeClass(\"active\")},onMetaHudEscape:function(){this.$nameTextInput.val(this.settings.draftName),this.$notesTextInput.val(this.settings.draftNotes)},onNotesKeydown:function(t){t.keyCode===Garnish.RETURN_KEY&&(t.preventDefault(),this.metaHud.submit())},checkMetaValues:function(){return!this.$nameTextInput.val()||this.$nameTextInput.val()===this.settings.draftName&&this.$notesTextInput.val()===this.settings.draftNotes?(this.$saveMetaBtn.addClass(\"disabled\"),!1):(this.$saveMetaBtn.removeClass(\"disabled\"),!0)},shakeMetaHud:function(){Garnish.shake(this.metaHud.$hud)},saveMeta:function(){this.checkMetaValues()?(this.settings.draftName=this.$nameTextInput.val(),this.settings.draftNotes=this.$notesTextInput.val(),this.metaHud.hide(),this.checkForm(!0)):this.shakeMetaHud()},deleteDraft:function(){confirm(Craft.t(\"app\",\"Are you sure you want to delete this draft?\"))&&Craft.postActionRequest(this.settings.deleteDraftAction,{draftId:this.settings.draftId},function(t,e){\"success\"===e&&(window.location.href=this.settings.cpEditUrl)}.bind(this))},handleFormSubmit:function(t){if(t.preventDefault(),!this.submittingForm&&(t.customTrigger||this.settings.isUnsavedDraft||!this.settings.draftId||this.settings.canUpdateSource)){Craft.cp.$confirmUnloadForms=Craft.cp.$confirmUnloadForms.not(Craft.cp.$primaryForm),this.saving&&this.saveXhr.abort();for(var e,i=$(\"<form/>\",{attr:{\"accept-charset\":Craft.cp.$primaryForm.attr(\"accept-charset\"),action:Craft.cp.$primaryForm.attr(\"action\"),enctype:Craft.cp.$primaryForm.attr(\"enctype\"),method:Craft.cp.$primaryForm.attr(\"method\"),target:Craft.cp.$primaryForm.attr(\"target\")}}),s=this.prepareData(this.serializeForm(!1)).split(\"&\"),n=0;n<s.length;n++)e=s[n].split(\"=\",2),$(\"<input/>\",{type:\"hidden\",name:decodeURIComponent(e[0]),value:decodeURIComponent(e[1]||\"\")}).appendTo(i);t.customTrigger&&t.customTrigger.data(\"action\")||$(\"<input/>\",{type:\"hidden\",name:\"action\",value:this.settings.applyDraftAction}).appendTo(i),t.saveShortcut&&Craft.cp.$primaryForm.data(\"saveshortcut-redirect\")||t.customTrigger&&t.customTrigger.data(\"redirect\")||$(\"<input/>\",{type:\"hidden\",name:\"redirect\",value:this.settings.hashedRedirectUrl}).appendTo(i),i.appendTo(Garnish.$bod),i.submit(),this.submittingForm=!0}}},{defaults:{elementType:null,sourceId:null,siteId:null,isLive:!1,cpEditUrl:null,draftId:null,revisionId:null,draftName:null,draftNotes:null,canDeleteDraft:!1,canUpdateSource:!1,saveDraftAction:null,deleteDraftAction:null,applyDraftAction:null,enablePreview:!1,previewTargets:[]}}),Craft.DynamicGenerator=Craft.BaseInputGenerator.extend({callback:$.noop,init:function(t,e,i){this.callback=i,this.base(t,e)},generateTargetValue:function(t){return this.callback(t)}}),Craft.EditableTable=Garnish.Base.extend({initialized:!1,id:null,baseName:null,columns:null,sorter:null,biggestId:-1,$table:null,$tbody:null,$addRowBtn:null,rowCount:0,hasMaxRows:!1,hasMinRows:!1,radioCheckboxes:null,init:function(t,e,i,s){if(this.id=t,this.baseName=e,this.columns=i,this.setSettings(s,Craft.EditableTable.defaults),this.radioCheckboxes={},this.$table=$(\"#\"+t),this.$tbody=this.$table.children(\"tbody\"),this.rowCount=this.$tbody.find(\"tr\").length,this.$table.data(\"editable-table\")&&(Garnish.log(\"Double-instantiating an editable table on an element\"),this.$table.data(\"editable-table\").destroy()),this.$table.data(\"editable-table\",this),this.sorter=new Craft.DataTableSorter(this.$table,{helperClass:\"editabletablesorthelper\",copyDraggeeInputValuesToHelper:!0}),this.isVisible()?this.initialize():setTimeout($.proxy(this,\"initializeIfVisible\"),500),this.settings.minRows&&this.rowCount<this.settings.minRows)for(var n=this.rowCount;n<this.settings.minRows;n++)this.addRow()},isVisible:function(){return 0<this.$table.height()},initialize:function(){if(this.initialized)return!1;this.initialized=!0,this.removeListener(Garnish.$win,\"resize\");for(var t=this.$tbody.children(),e=0;e<t.length;e++)this.createRowObj(t[e]);return this.$addRowBtn=this.$table.next(\".add\"),this.updateAddRowButton(),this.addListener(this.$addRowBtn,\"activate\",\"addRow\"),!0},initializeIfVisible:function(){this.removeListener(Garnish.$win,\"resize\"),this.isVisible()?this.initialize():this.addListener(Garnish.$win,\"resize\",\"initializeIfVisible\")},updateAddRowButton:function(){this.canAddRow()?(this.$addRowBtn.css(\"opacity\",\"1\"),this.$addRowBtn.css(\"pointer-events\",\"auto\")):(this.$addRowBtn.css(\"opacity\",\"0.2\"),this.$addRowBtn.css(\"pointer-events\",\"none\"))},canDeleteRow:function(){return this.rowCount>this.settings.minRows},deleteRow:function(t){this.canDeleteRow()&&(this.sorter.removeItems(t.$tr),t.$tr.remove(),this.rowCount--,this.updateAddRowButton(),this.settings.onDeleteRow(t.$tr),t.destroy())},canAddRow:function(){return!this.settings.staticRows&&(!this.settings.maxRows||this.rowCount<this.settings.maxRows)},addRow:function(t,e){if(this.canAddRow()){var i=this.settings.rowIdPrefix+(this.biggestId+1),s=this.createRow(i,this.columns,this.baseName,$.extend({},this.settings.defaultValues));e?s.prependTo(this.$tbody):s.appendTo(this.$tbody);var n=this.createRowObj(s);return this.sorter.addItems(s),!1!==t&&s.find(\"input:visible,textarea:visible,select:visible\").first().trigger(\"focus\"),this.rowCount++,this.updateAddRowButton(),this.settings.onAddRow(s),n}},createRow:function(t,e,i,s){return Craft.EditableTable.createRow(t,e,i,s)},createRowObj:function(t){return new Craft.EditableTable.Row(this,t)},focusOnPrevRow:function(t,e,i){var s,n=t.prev(\"tr\");if((s=n.length?n.data(\"editable-table-row\"):this.addRow(!1,!0))&&s.$tds[e])if($(s.$tds[e]).hasClass(\"disabled\"))n&&this.focusOnPrevRow(n,e,i);else{var a=$(\"textarea,input.text\",s.$tds[e]);a.length&&($(i).trigger(\"blur\"),a.trigger(\"focus\"))}},focusOnNextRow:function(t,e,i){var s,n=t.next(\"tr\");if((s=n.length?n.data(\"editable-table-row\"):this.addRow(!1))&&s.$tds[e])if($(s.$tds[e]).hasClass(\"disabled\"))n&&this.focusOnNextRow(n,e,i);else{var a=$(\"textarea,input.text\",s.$tds[e]);a.length&&($(i).trigger(\"blur\"),a.trigger(\"focus\"))}}},{textualColTypes:[\"color\",\"date\",\"email\",\"multiline\",\"number\",\"singleline\",\"template\",\"time\",\"url\"],defaults:{rowIdPrefix:\"\",defaultValues:{},staticRows:!1,minRows:null,maxRows:null,onAddRow:$.noop,onDeleteRow:$.noop},createRow:function(t,e,i,s){var n=$(\"<tr/>\",{\"data-id\":t});for(var a in e)if(e.hasOwnProperty(a)){var r,o=e[a],l=void 0!==s[a]?s[a]:\"\";if(\"heading\"===o.type)r=$(\"<th/>\",{scope:\"row\",class:o.class,html:l});else{var h=i+\"[\"+t+\"][\"+a+\"]\",d=Craft.inArray(o.type,Craft.EditableTable.textualColTypes);switch(r=$(\"<td/>\",{class:o.class,width:o.width}),d&&r.addClass(\"textual\"),o.code&&r.addClass(\"code\"),o.type){case\"checkbox\":Craft.ui.createCheckbox({name:h,value:o.value||\"1\",checked:!!l}).appendTo(r);break;case\"color\":Craft.ui.createColorInput({name:h,value:l,small:!0}).appendTo(r);break;case\"date\":Craft.ui.createDateInput({name:h,value:l}).appendTo(r);break;case\"lightswitch\":Craft.ui.createLightswitch({name:h,value:o.value||\"1\",on:!!l,small:!0}).appendTo(r);break;case\"select\":Craft.ui.createSelect({name:h,options:o.options,value:l||function(){for(var t in o.options)if(o.options.hasOwnProperty(t)&&o.options[t].default)return void 0!==o.options[t].value?o.options[t].value:t;return null}(),class:\"small\"}).appendTo(r);break;case\"time\":Craft.ui.createTimeInput({name:h,value:l}).appendTo(r);break;case\"email\":case\"url\":Craft.ui.createTextInput({name:h,value:l,type:o.type,placeholder:o.placeholder||null}).appendTo(r);break;default:$(\"<textarea/>\",{name:h,rows:1,val:l,placeholder:o.placeholder}).appendTo(r)}}r.appendTo(n)}return $(\"<td/>\",{class:\"thin action\"}).append($(\"<a/>\",{class:\"move icon\",title:Craft.t(\"app\",\"Reorder\")})).appendTo(n),$(\"<td/>\",{class:\"thin action\"}).append($(\"<a/>\",{class:\"delete icon\",title:Craft.t(\"app\",\"Delete\")})).appendTo(n),n}}),Craft.EditableTable.Row=Garnish.Base.extend({table:null,id:null,niceTexts:null,$tr:null,$tds:null,tds:null,$textareas:null,$deleteBtn:null,init:function(t,e){this.table=t,this.$tr=$(e),this.$tds=this.$tr.children(),this.tds=[],this.id=this.$tr.attr(\"data-id\"),this.$tr.data(\"editable-table-row\",this);var i=parseInt(this.id.substr(this.table.settings.rowIdPrefix.length));i>this.table.biggestId&&(this.table.biggestId=i),this.$textareas=$(),this.niceTexts=[];var s,n,a,r,o,l={},h=0;for(s in this.table.columns)this.table.columns.hasOwnProperty(s)&&(n=this.table.columns[s],a=this.tds[s]=this.$tds[h],Craft.inArray(n.type,Craft.EditableTable.textualColTypes)?(r=$(\"textarea, input.text\",a),this.$textareas=this.$textareas.add(r),this.addListener(r,\"focus\",\"onTextareaFocus\"),this.addListener(r,\"mousedown\",\"ignoreNextTextareaFocus\"),this.niceTexts.push(new Garnish.NiceText(r,{onHeightChange:$.proxy(this,\"onTextareaHeightChange\")})),this.addListener(r,\"keypress\",{tdIndex:h,type:n.type},\"handleKeypress\"),this.addListener(r,\"textchange\",{type:n.type},\"validateValue\"),r.trigger(\"textchange\"),l[s]=r):\"checkbox\"===n.type&&(o=$('input[type=\"checkbox\"]',a),n.radioMode&&(void 0===this.table.radioCheckboxes[s]&&(this.table.radioCheckboxes[s]=[]),this.table.radioCheckboxes[s].push(o[0]),this.addListener(o,\"change\",{colId:s},\"onRadioCheckboxChange\")),n.toggle&&this.addListener(o,\"change\",{colId:s},function(t){this.applyToggleCheckbox(t.data.colId)})),h++);for(s in this.onTextareaHeightChange(),this.table.columns)!this.table.columns.hasOwnProperty(s)||\"checkbox\"===(n=this.table.columns[s]).type&&n.toggle&&this.applyToggleCheckbox(s);for(s in this.table.columns)!this.table.columns.hasOwnProperty(s)||(n=this.table.columns[s]).autopopulate&&void 0!==l[n.autopopulate]&&!l[s].val()&&new Craft.HandleGenerator(l[s],l[n.autopopulate],{allowNonAlphaStart:!0});var d=this.$tr.children().last().find(\".delete\");this.addListener(d,\"click\",\"deleteRow\")},onTextareaFocus:function(t){this.onTextareaHeightChange();var e=$(t.currentTarget);e.data(\"ignoreNextFocus\")?e.data(\"ignoreNextFocus\",!1):setTimeout(function(){Craft.selectFullValue(e)},0)},onRadioCheckboxChange:function(t){if(t.currentTarget.checked)for(var e=0;e<this.table.radioCheckboxes[t.data.colId].length;e++){var i=this.table.radioCheckboxes[t.data.colId][e];i.checked=i===t.currentTarget}},applyToggleCheckbox:function(t){for(var e,i,s=this.table.columns[t],n=$('input[type=\"checkbox\"]',this.tds[t]).prop(\"checked\"),a=0;a<s.toggle.length;a++)e=s.toggle[a],this.table.colum,(i=\"!\"===e[0])&&(e=e.substr(1)),n&&!i||!n&&i?$(this.tds[e]).removeClass(\"disabled\").find(\"textarea, input\").prop(\"disabled\",!1):$(this.tds[e]).addClass(\"disabled\").find(\"textarea, input\").prop(\"disabled\",!0)},ignoreNextTextareaFocus:function(t){$.data(t.currentTarget,\"ignoreNextFocus\",!0)},handleKeypress:function(t){var e=t.keyCode?t.keyCode:t.charCode,i=Garnish.isCtrlKeyPressed(t);if(e===Garnish.RETURN_KEY&&(\"multiline\"!==t.data.type||i))return t.preventDefault(),void(t.shiftKey?this.table.focusOnPrevRow(this.$tr,t.data.tdIndex,t.currentTarget):this.table.focusOnNextRow(this.$tr,t.data.tdIndex,t.currentTarget));\"number\"!==t.data.type||i||Craft.inArray(e,Craft.EditableTable.Row.numericKeyCodes)||t.preventDefault()},validateValue:function(t){if(\"multiline\"!==t.data.type){var e;if(\"number\"===t.data.type){var i=t.currentTarget.value.match(/^\\s*(-?[\\d\\\\.]*)/);e=null!==i?i[1]:\"\"}else e=t.currentTarget.value.replace(/[\\r\\n]/g,\"\");e!==t.currentTarget.value&&(t.currentTarget.value=e)}},onTextareaHeightChange:function(){for(var t=-1,e=0;e<this.niceTexts.length;e++)this.niceTexts[e].height>t&&(t=this.niceTexts[e].height);this.$textareas.css(\"min-height\",t);var i=this.$textareas.filter(\":visible\").first().parent().height();t<i&&this.$textareas.css(\"min-height\",i)},deleteRow:function(){this.table.deleteRow(this)}},{numericKeyCodes:[9,8,37,38,39,40,45,91,46,190,48,49,50,51,52,53,54,55,56,57]}),Craft.ElementActionTrigger=Garnish.Base.extend({maxLevels:null,newChildUrl:null,$trigger:null,$selectedItems:null,triggerEnabled:!0,init:function(t){this.setSettings(t,Craft.ElementActionTrigger.defaults),this.$trigger=$(\"#\"+t.type.replace(/[\\[\\]\\\\]+/g,\"-\")+\"-actiontrigger\"),this.settings.activate&&(this.$trigger.data(\"custom-handler\",!0),\"FORM\"===this.$trigger.prop(\"nodeName\")?this.addListener(this.$trigger,\"submit\",\"handleTriggerActivation\"):this.addListener(this.$trigger,\"click\",\"handleTriggerActivation\")),this.updateTrigger(),Craft.elementIndex.on(\"selectionChange\",$.proxy(this,\"updateTrigger\"))},updateTrigger:function(){0!==Craft.elementIndex.getSelectedElements().length&&(this.validateSelection()?this.enableTrigger():this.disableTrigger())},validateSelection:function(){var t=!0;return this.$selectedItems=Craft.elementIndex.getSelectedElements(),!this.settings.batch&&1<this.$selectedItems.length?t=!1:\"function\"==typeof this.settings.validateSelection&&(t=this.settings.validateSelection(this.$selectedItems)),t},enableTrigger:function(){this.triggerEnabled||(this.$trigger.removeClass(\"disabled\"),this.triggerEnabled=!0)},disableTrigger:function(){this.triggerEnabled&&(this.$trigger.addClass(\"disabled\"),this.triggerEnabled=!1)},handleTriggerActivation:function(t){t.preventDefault(),t.stopPropagation(),this.triggerEnabled&&this.settings.activate(this.$selectedItems)}},{defaults:{type:null,batch:!0,validateSelection:null,activate:null}}),Craft.ElementThumbLoader=Garnish.Base.extend({queue:null,workers:[],init:function(){this.queue=[];for(var t=0;t<3;t++)this.workers.push(new Craft.ElementThumbLoader.Worker(this))},load:function(t){if(this.queue=this.queue.concat(t.find(\".elementthumb\").toArray()),this.queue.length)for(var e=0;e<this.workers.length;e++)this.workers[e].active||this.workers[e].loadNext()},destroy:function(){for(var t=0;t<this.workers.length;t++)this.workers[t].destroy();this.base()}}),Craft.ElementThumbLoader.Worker=Garnish.Base.extend({loader:null,active:!1,init:function(t){this.loader=t},loadNext:function(){var t=this.loader.queue.shift();if(void 0!==t){this.active=!0;var e=$(t);if(e.find(\"img\").length)this.loadNext();else{var i=$(\"<img/>\",{sizes:e.attr(\"data-sizes\"),srcset:e.attr(\"data-srcset\"),alt:\"\"});this.addListener(i,\"load\",\"loadNext\"),i.appendTo(e),picturefill({elements:[i[0]]})}}else this.active=!1}}),Craft.ElevatedSessionForm=Garnish.Base.extend({$form:null,inputs:null,init:function(t,e){if(this.$form=$(t),void 0!==e){this.inputs=[],e=$.makeArray(e);for(var i=0;i<e.length;i++)for(var s=$(e[i]),n=0;n<s.length;n++){var a=s.eq(n);this.inputs.push({input:a,val:Garnish.getInputPostVal(a)})}}this.addListener(this.$form,\"submit\",\"handleFormSubmit\")},handleFormSubmit:function(t){if(Craft.elevatedSessionManager.fetchingTimeout)t.preventDefault();else{if(this.inputs){for(var e,i=!1,s=0;s<this.inputs.length;s++)if((e=this.inputs[s].input).data(\"passwordInput\")&&(e=e.data(\"passwordInput\").$currentInput),Garnish.getInputPostVal(e)!==this.inputs[s].val){i=!0;break}if(!i)return}t.preventDefault(),Craft.elevatedSessionManager.requireElevatedSession($.proxy(this,\"submitForm\"))}},submitForm:function(){this.disable(),this.$form.trigger(\"submit\"),this.enable()}}),Craft.ElevatedSessionManager=Garnish.Base.extend({fetchingTimeout:!1,passwordModal:null,$passwordInput:null,$passwordSpinner:null,$submitBtn:null,$errorPara:null,callback:null,requireElevatedSession:function(t){this.callback=t,this.fetchingTimeout=!0,Craft.postActionRequest(\"users/get-elevated-session-timeout\",$.proxy(function(t,e){this.fetchingTimeout=!1,\"success\"===e&&(!1===t.timeout||t.timeout>=Craft.ElevatedSessionManager.minSafeElevatedSessionTimeout?this.callback():this.showPasswordModal())},this))},showPasswordModal:function(){if(this.passwordModal)this.passwordModal.show();else{var t=$('<form id=\"elevatedsessionmodal\" class=\"modal secure fitted\"/>'),e=$('<div class=\"body\"><p>'+Craft.t(\"app\",\"Enter your password to continue.\")+\"</p></div>\").appendTo(t),i=$('<div class=\"inputcontainer\">').appendTo(e),s=$('<div class=\"flex\"/>').appendTo(i),n=$('<div class=\"flex-grow\"/>').appendTo(s),a=$(\"<td/>\").appendTo(s),r=$('<div class=\"passwordwrapper\"/>').appendTo(n);this.$passwordInput=$('<input type=\"password\" class=\"text password fullwidth\" placeholder=\"'+Craft.t(\"app\",\"Password\")+'\" autocomplete=\"current-password\"/>').appendTo(r),this.$passwordSpinner=$('<div class=\"spinner hidden\"/>').appendTo(i),this.$submitBtn=$('<input type=\"submit\" class=\"btn submit disabled\" value=\"'+Craft.t(\"app\",\"Submit\")+'\" />').appendTo(a),this.$errorPara=$('<p class=\"error\"/>').appendTo(e),this.passwordModal=new Garnish.Modal(t,{closeOtherModals:!1,onFadeIn:$.proxy(function(){setTimeout($.proxy(this,\"focusPasswordInput\"),100)},this),onFadeOut:$.proxy(function(){this.$passwordInput.val(\"\")},this)}),new Craft.PasswordInput(this.$passwordInput,{onToggleInput:$.proxy(function(t){this.$passwordInput=t},this)}),this.addListener(this.$passwordInput,\"textchange\",\"validatePassword\"),this.addListener(t,\"submit\",\"submitPassword\")}},focusPasswordInput:function(){Garnish.isMobileBrowser(!0)||this.$passwordInput.trigger(\"focus\")},validatePassword:function(){return 6<=this.$passwordInput.val().length?(this.$submitBtn.removeClass(\"disabled\"),!0):(this.$submitBtn.addClass(\"disabled\"),!1)},submitPassword:function(t){if(t&&t.preventDefault(),this.validatePassword()){this.$passwordSpinner.removeClass(\"hidden\"),this.clearLoginError();var e={currentPassword:this.$passwordInput.val()};Craft.postActionRequest(\"users/start-elevated-session\",e,$.proxy(function(t,e){this.$passwordSpinner.addClass(\"hidden\"),\"success\"===e?t.success?(this.passwordModal.hide(),this.callback()):(this.showPasswordError(t.message||Craft.t(\"app\",\"Incorrect password.\")),Garnish.shake(this.passwordModal.$container),this.focusPasswordInput()):this.showPasswordError()},this))}},showPasswordError:function(t){null==t&&(t=Craft.t(\"app\",\"An unknown error occurred.\")),this.$errorPara.text(t),this.passwordModal.updateSizeAndPosition()},clearLoginError:function(){this.showPasswordError(\"\")}},{minSafeElevatedSessionTimeout:5}),Craft.elevatedSessionManager=new Craft.ElevatedSessionManager,Craft.EntryIndex=Craft.BaseElementIndex.extend({publishableSections:null,$newEntryBtnGroup:null,$newEntryBtn:null,init:function(t,e,i){this.on(\"selectSource\",$.proxy(this,\"updateButton\")),this.on(\"selectSite\",$.proxy(this,\"updateButton\")),this.base(t,e,i)},afterInit:function(){this.publishableSections=[];for(var t=0;t<Craft.publishableSections.length;t++){var e=Craft.publishableSections[t];this.getSourceByKey(\"section:\"+e.uid)&&this.publishableSections.push(e)}this.base()},getDefaultSourceKey:function(){if(\"index\"===this.settings.context&&\"undefined\"!=typeof defaultSectionHandle){if(\"singles\"===defaultSectionHandle)return\"singles\";for(var t=0;t<this.$sources.length;t++){var e=$(this.$sources[t]);if(e.data(\"handle\")===defaultSectionHandle)return e.data(\"key\")}}return this.base()},updateButton:function(){if(this.$source){var t,e,i,s;if(t=\"singles\"===this.$source.data(\"key\")?\"singles\":this.$source.data(\"handle\"),this.publishableSections.length){var n,a;if(this.$newEntryBtnGroup&&this.$newEntryBtnGroup.remove(),t)for(e=0;e<this.publishableSections.length;e++)if(this.publishableSections[e].handle===t){n=this.publishableSections[e];break}if(this.$newEntryBtnGroup=$('<div class=\"btngroup submit\"/>'),n?(i=this._getSectionTriggerHref(n),s=\"index\"===this.settings.context?Craft.t(\"app\",\"New entry\"):Craft.t(\"app\",\"New {section} entry\",{section:n.name}),this.$newEntryBtn=$('<a class=\"btn submit add icon\" '+i+\">\"+Craft.escapeHtml(s)+\"</a>\").appendTo(this.$newEntryBtnGroup),\"index\"!==this.settings.context&&this.addListener(this.$newEntryBtn,\"click\",function(t){this._openCreateEntryModal(t.currentTarget.getAttribute(\"data-id\"))}),1<this.publishableSections.length&&(a=$('<div class=\"btn submit menubtn\"></div>').appendTo(this.$newEntryBtnGroup))):this.$newEntryBtn=a=$('<div class=\"btn submit add icon menubtn\">'+Craft.t(\"app\",\"New entry\")+\"</div>\").appendTo(this.$newEntryBtnGroup),a){var r='<div class=\"menu\"><ul>';for(e=0;e<this.publishableSections.length;e++){var o=this.publishableSections[e];(\"index\"===this.settings.context&&-1!==$.inArray(this.siteId,o.sites)||\"index\"!==this.settings.context&&o!==n)&&(i=this._getSectionTriggerHref(o),s=\"index\"===this.settings.context?o.name:Craft.t(\"app\",\"New {section} entry\",{section:o.name}),r+=\"<li><a \"+i+'\">'+Craft.escapeHtml(s)+\"</a></li>\")}$(r+=\"</ul></div>\").appendTo(this.$newEntryBtnGroup);var l=new Garnish.MenuBtn(a);\"index\"!==this.settings.context&&l.on(\"optionSelect\",$.proxy(function(t){this._openCreateEntryModal(t.option.getAttribute(\"data-id\"))},this))}this.addButton(this.$newEntryBtnGroup)}if(\"index\"===this.settings.context&&\"undefined\"!=typeof history){var h=\"entries\";t&&(h+=\"/\"+t),history.replaceState({},\"\",Craft.getUrl(h))}}},_getSectionTriggerHref:function(t){if(\"index\"!==this.settings.context)return'data-id=\"'+t.id+'\"';var e=\"entries/\"+t.handle+\"/new\";if(params={},this.siteId)for(var i=0;i<Craft.sites.length;i++)Craft.sites[i].id==this.siteId&&(params.site=Craft.sites[i].handle);return'href=\"'+Craft.getUrl(e,params)+'\"'},_openCreateEntryModal:function(t){if(!this.$newEntryBtn.hasClass(\"loading\")){for(var i,e=0;e<this.publishableSections.length;e++)if(this.publishableSections[e].id==t){i=this.publishableSections[e];break}if(i){this.$newEntryBtn.addClass(\"inactive\");var s=this.$newEntryBtn.text();this.$newEntryBtn.text(Craft.t(\"app\",\"New {section} entry\",{section:i.name})),Craft.createElementEditor(this.elementType,{hudTrigger:this.$newEntryBtnGroup,elementType:\"craft\\\\elements\\\\Entry\",siteId:this.siteId,attributes:{sectionId:t,typeId:i.entryTypes[0].id},onBeginLoading:$.proxy(function(){this.$newEntryBtn.addClass(\"loading\")},this),onEndLoading:$.proxy(function(){this.$newEntryBtn.removeClass(\"loading\")},this),onHideHud:$.proxy(function(){this.$newEntryBtn.removeClass(\"inactive\").text(s)},this),onSaveElement:$.proxy(function(t){var e=\"section:\"+i.uid;this.sourceKey!==e&&this.selectSourceByKey(e),this.selectElementAfterUpdate(t.id),this.updateElements()},this)})}}}}),Craft.registerElementIndexClass(\"craft\\\\elements\\\\Entry\",Craft.EntryIndex),Craft.FieldLayoutDesigner=Garnish.Base.extend({$container:null,$tabContainer:null,$unusedFieldContainer:null,$newTabBtn:null,$allFields:null,tabGrid:null,unusedFieldGrid:null,tabDrag:null,fieldDrag:null,init:function(t,e){this.$container=$(t),this.setSettings(e,Craft.FieldLayoutDesigner.defaults),this.$tabContainer=this.$container.children(\".fld-tabs\"),this.$unusedFieldContainer=this.$container.children(\".unusedfields\"),this.$newTabBtn=this.$container.find(\"> .newtabbtn-container > .btn\"),this.$allFields=this.$unusedFieldContainer.find(\".fld-field\"),this.tabGrid=new Craft.Grid(this.$tabContainer,Craft.FieldLayoutDesigner.gridSettings),this.unusedFieldGrid=new Craft.Grid(this.$unusedFieldContainer,Craft.FieldLayoutDesigner.gridSettings);for(var i=this.$tabContainer.children(),s=0;s<i.length;s++)this.initTab($(i[s]));this.fieldDrag=new Craft.FieldLayoutDesigner.FieldDrag(this),this.settings.customizableTabs&&(this.tabDrag=new Craft.FieldLayoutDesigner.TabDrag(this),this.addListener(this.$newTabBtn,\"activate\",\"addTab\"))},initTab:function(t){if(this.settings.customizableTabs){var e=t.find(\".tabs .settings\"),i=$('<div class=\"menu\" data-align=\"center\"/>').insertAfter(e),s=$(\"<ul/>\").appendTo(i);$('<li><a data-action=\"rename\">'+Craft.t(\"app\",\"Rename\")+\"</a></li>\").appendTo(s),$('<li><a data-action=\"delete\">'+Craft.t(\"app\",\"Delete\")+\"</a></li>\").appendTo(s),new Garnish.MenuBtn(e,{onOptionSelect:$.proxy(this,\"onTabOptionSelect\")})}for(var n=t.children(\".fld-tabcontent\").children(),a=0;a<n.length;a++)this.initField($(n[a]))},initField:function(t){var e=t.find(\".settings\"),i=$('<div class=\"menu\" data-align=\"center\"/>').insertAfter(e),s=$(\"<ul/>\").appendTo(i);t.hasClass(\"fld-required\")?$('<li><a data-action=\"toggle-required\">'+Craft.t(\"app\",\"Make not required\")+\"</a></li>\").appendTo(s):$('<li><a data-action=\"toggle-required\">'+Craft.t(\"app\",\"Make required\")+\"</a></li>\").appendTo(s),$('<li><a data-action=\"remove\">'+Craft.t(\"app\",\"Remove\")+\"</a></li>\").appendTo(s),new Garnish.MenuBtn(e,{onOptionSelect:$.proxy(this,\"onFieldOptionSelect\")})},onTabOptionSelect:function(t){if(this.settings.customizableTabs){var e=$(t),i=e.data(\"menu\").$anchor.parent().parent().parent();switch(e.data(\"action\")){case\"rename\":this.renameTab(i);break;case\"delete\":this.deleteTab(i)}}},onFieldOptionSelect:function(t){var e=$(t),i=e.data(\"menu\").$anchor.parent();switch(e.data(\"action\")){case\"toggle-required\":this.toggleRequiredField(i,e);break;case\"remove\":this.removeField(i)}},renameTab:function(t){if(this.settings.customizableTabs){var e=t.find(\".tabs .tab span\"),i=e.text(),s=prompt(Craft.t(\"app\",\"Give your tab a name.\"),i);s&&s!==i&&(e.text(s),t.find(\".id-input\").attr(\"name\",this.getFieldInputName(s)))}},deleteTab:function(t){if(this.settings.customizableTabs){for(var e=t.find(\".fld-field\"),i=0;i<e.length;i++){var s=$(e[i]).attr(\"data-id\");this.removeFieldById(s)}this.tabGrid.removeItems(t),this.tabDrag.removeItems(t),t.remove()}},toggleRequiredField:function(t,e){t.hasClass(\"fld-required\")?(t.removeClass(\"fld-required\"),t.find(\".required-input\").remove(),setTimeout(function(){e.text(Craft.t(\"app\",\"Make required\"))},500)):(t.addClass(\"fld-required\"),$('<input class=\"required-input\" type=\"hidden\" name=\"'+this.settings.requiredFieldInputName+'\" value=\"'+t.data(\"id\")+'\">').appendTo(t),setTimeout(function(){e.text(Craft.t(\"app\",\"Make not required\"))},500))},removeField:function(t){var e=t.attr(\"data-id\");t.remove(),this.removeFieldById(e),this.tabGrid.refreshCols(!0)},removeFieldById:function(t){var e=this.$allFields.filter(\"[data-id=\"+t+\"]:first\"),i=e.closest(\".fld-tab\");e.removeClass(\"hidden\"),i.hasClass(\"hidden\")?(i.removeClass(\"hidden\"),this.unusedFieldGrid.addItems(i),this.settings.customizableTabs&&this.tabDrag.addItems(i)):this.unusedFieldGrid.refreshCols(!0)},addTab:function(){if(this.settings.customizableTabs){var t=$('<div class=\"fld-tab\"><div class=\"tabs\"><div class=\"tab sel draggable\"><span>Tab '+(this.tabGrid.$items.length+1)+'</span><a class=\"settings icon\" title=\"'+Craft.t(\"app\",\"Rename\")+'\"></a></div></div><div class=\"fld-tabcontent\"></div></div>').appendTo(this.$tabContainer);this.tabGrid.addItems(t),this.tabDrag.addItems(t),this.initTab(t)}},getFieldInputName:function(t){return this.settings.fieldInputName.replace(/__TAB_NAME__/g,Craft.encodeUriComponent(t))}},{gridSettings:{itemSelector:\".fld-tab:not(.hidden)\",minColWidth:240,fillMode:\"grid\",snapToGrid:30},defaults:{customizableTabs:!0,fieldInputName:\"fieldLayout[__TAB_NAME__][]\",requiredFieldInputName:\"requiredFields[]\"}}),Craft.FieldLayoutDesigner.BaseDrag=Garnish.Drag.extend({designer:null,$insertion:null,showingInsertion:!1,$caboose:null,draggingUnusedItem:!1,addToTabGrid:!1,init:function(t,e){this.designer=t;var i=this.designer.$tabContainer.find(this.itemSelector).add(this.designer.$unusedFieldContainer.find(this.itemSelector));this.base(i,e)},onDragStart:function(){this.base(),this.draggingUnusedItem=this.$draggee.hasClass(\"unused\"),this.$insertion=this.getInsertion(),this.addCaboose(),this.$items=$().add(this.$items.add(this.$caboose)),this.addToTabGrid&&this.designer.tabGrid.addItems(this.$caboose),this.draggingUnusedItem?this.showingInsertion=!1:(this.$insertion.insertBefore(this.$draggee),this.$draggee.detach(),this.$items=$().add(this.$items.not(this.$draggee).add(this.$insertion)),this.showingInsertion=!0,this.addToTabGrid&&(this.designer.tabGrid.removeItems(this.$draggee),this.designer.tabGrid.addItems(this.$insertion))),this.setMidpoints()},addCaboose:$.noop,getItemContainer:$.noop,isItemInTabContainer:function(t){return this.getItemContainer(t)[0]===this.designer.$tabContainer[0]},setMidpoints:function(){for(var t=0;t<this.$items.length;t++){var e=$(this.$items[t]);if(this.isItemInTabContainer(e)){var i=e.offset();e.data(\"midpoint\",{left:i.left+e.outerWidth()/2,top:i.top+e.outerHeight()/2})}}},onDrag:function(){this.draggingUnusedItem&&!Garnish.hitTest(this.mouseX,this.mouseY,this.designer.$tabContainer)?this.showingInsertion&&(this.$insertion.remove(),this.$items=$().add(this.$items.not(this.$insertion)),this.showingInsertion=!1,this.addToTabGrid?this.designer.tabGrid.removeItems(this.$insertion):this.designer.tabGrid.refreshCols(!0),this.setMidpoints()):(this.onDrag._closestItem=this.getClosestItem(),this.onDrag._closestItem!==this.$insertion[0]&&(this.showingInsertion&&$.inArray(this.$insertion[0],this.$items)<$.inArray(this.onDrag._closestItem,this.$items)&&-1===$.inArray(this.onDrag._closestItem,this.$caboose)?this.$insertion.insertAfter(this.onDrag._closestItem):this.$insertion.insertBefore(this.onDrag._closestItem),this.$items=$().add(this.$items.add(this.$insertion)),this.showingInsertion=!0,this.addToTabGrid?this.designer.tabGrid.addItems(this.$insertion):this.designer.tabGrid.refreshCols(!0),this.setMidpoints())),this.base()},getClosestItem:function(){for(this.getClosestItem._closestItem=null,this.getClosestItem._closestItemMouseDiff=null,this.getClosestItem._i=0;this.getClosestItem._i<this.$items.length;this.getClosestItem._i++)this.getClosestItem._$item=$(this.$items[this.getClosestItem._i]),this.isItemInTabContainer(this.getClosestItem._$item)&&(this.getClosestItem._midpoint=this.getClosestItem._$item.data(\"midpoint\"),this.getClosestItem._mouseDiff=Garnish.getDist(this.getClosestItem._midpoint.left,this.getClosestItem._midpoint.top,this.mouseX,this.mouseY),(null===this.getClosestItem._closestItem||this.getClosestItem._mouseDiff<this.getClosestItem._closestItemMouseDiff)&&(this.getClosestItem._closestItem=this.getClosestItem._$item[0],this.getClosestItem._closestItemMouseDiff=this.getClosestItem._mouseDiff));return this.getClosestItem._closestItem},onDragStop:function(){this.showingInsertion&&(this.$insertion.replaceWith(this.$draggee),this.$items=$().add(this.$items.not(this.$insertion).add(this.$draggee)),this.addToTabGrid&&(this.designer.tabGrid.removeItems(this.$insertion),this.designer.tabGrid.addItems(this.$draggee))),this.$items=this.$items.not(this.$caboose),this.$caboose.remove(),this.addToTabGrid&&this.designer.tabGrid.removeItems(this.$caboose),this.$draggee.css({display:this.draggeeDisplay,visibility:\"hidden\"}),this.designer.tabGrid.refreshCols(!0),this.designer.unusedFieldGrid.refreshCols(!0),this.returnHelpersToDraggees(),this.base()}}),Craft.FieldLayoutDesigner.TabDrag=Craft.FieldLayoutDesigner.BaseDrag.extend({itemSelector:\"> div.fld-tab\",addToTabGrid:!0,init:function(t){this.base(t,{handle:\".tab\"})},addCaboose:function(){this.$caboose=$('<div class=\"fld-tab fld-tab-caboose\"/>').appendTo(this.designer.$tabContainer)},getInsertion:function(){var t=this.$draggee.find(\".tab\");return $('<div class=\"fld-tab fld-insertion\" style=\"height: '+this.$draggee.height()+'px;\"><div class=\"tabs\"><div class=\"tab sel draggable\" style=\"width: '+t.width()+\"px; height: \"+t.height()+'px;\"></div></div><div class=\"fld-tabcontent\" style=\"height: '+this.$draggee.find(\".fld-tabcontent\").height()+'px;\"></div></div>')},getItemContainer:function(t){return t.parent()},onDragStop:function(){if(this.draggingUnusedItem&&this.showingInsertion){var t=this.$draggee.clone().removeClass(\"unused\"),e=t.find(\".tab span\").text();t.find(\".fld-field\").removeClass(\"unused\"),t.find(\".tabs .tab\").append('<a class=\"settings icon\" title=\"'+Craft.t(\"app\",\"Edit\")+'\"></a>');var i=t.find(\".fld-field\"),s=i.filter(\".hidden\").remove();(i=i.not(s)).prepend('<a class=\"settings icon\" title=\"'+Craft.t(\"app\",\"Edit\")+'\"></a>');for(var n=0;n<i.length;n++){var a=$(i[n]),r=this.designer.getFieldInputName(e);a.append('<input class=\"id-input\" type=\"hidden\" name=\"'+r+'\" value=\"'+a.data(\"id\")+'\">')}this.designer.fieldDrag.addItems(i),this.designer.initTab(t),this.$draggee.css({visibility:\"inherit\",display:\"field\"}).addClass(\"hidden\"),this.$draggee.find(\".fld-field\").addClass(\"hidden\"),this.$draggee=t,this.addItems(t),this.designer.tabGrid.addItems(t),this.designer.unusedFieldGrid.removeItems(this.$draggee)}this.base()}}),Craft.FieldLayoutDesigner.FieldDrag=Craft.FieldLayoutDesigner.BaseDrag.extend({itemSelector:\"> div.fld-tab .fld-field\",addCaboose:function(){this.$caboose=$();for(var t=this.designer.$tabContainer.children().children(\".fld-tabcontent\"),e=0;e<t.length;e++){var i=$('<div class=\"fld-tab fld-tab-caboose\"/>').appendTo(t[e]);this.$caboose=this.$caboose.add(i)}},getInsertion:function(){return $('<div class=\"fld-field fld-insertion\" style=\"height: '+this.$draggee.height()+'px;\"/>')},getItemContainer:function(t){return t.parent().parent().parent()},onDragStop:function(){if(this.draggingUnusedItem&&this.showingInsertion){var t=this.$draggee.clone().removeClass(\"unused\");if(t.prepend('<a class=\"settings icon\" title=\"'+Craft.t(\"app\",\"Edit\")+'\"></a>'),this.designer.initField(t),this.$draggee.css({visibility:\"inherit\",display:\"field\"}).addClass(\"hidden\"),0===this.$draggee.siblings(\":not(.hidden)\").length){var e=this.$draggee.parent().parent();e.addClass(\"hidden\"),this.designer.unusedFieldGrid.removeItems(e)}this.$draggee=t,this.addItems(t)}if(this.showingInsertion){var i=this.$insertion.parent().parent().find(\".tab span\").text(),s=this.designer.getFieldInputName(i);this.draggingUnusedItem?this.$draggee.append('<input class=\"id-input\" type=\"hidden\" name=\"'+s+'\" value=\"'+this.$draggee.data(\"id\")+'\">'):this.$draggee.find(\".id-input\").attr(\"name\",s)}this.base()}}),Craft.FieldToggle=Garnish.Base.extend({$toggle:null,targetPrefix:null,targetSelector:null,reverseTargetSelector:null,_$target:null,_$reverseTarget:null,type:null,init:function(t){this.$toggle=$(t),this.$toggle.data(\"fieldtoggle\")&&(Garnish.log(\"Double-instantiating a field toggle on an element\"),this.$toggle.data(\"fieldtoggle\").destroy()),this.$toggle.data(\"fieldtoggle\",this),this.type=this.getType(),\"select\"===this.type?this.targetPrefix=this.$toggle.attr(\"data-target-prefix\")||\"\":(this.targetSelector=this.normalizeTargetSelector(this.$toggle.data(\"target\")),this.reverseTargetSelector=this.normalizeTargetSelector(this.$toggle.data(\"reverse-target\"))),this.findTargets(),\"link\"===this.type?this.addListener(this.$toggle,\"click\",\"onToggleChange\"):this.addListener(this.$toggle,\"change\",\"onToggleChange\")},normalizeTargetSelector:function(t){return t&&!t.match(/^[#\\.]/)&&(t=\"#\"+t),t},getType:function(){return\"INPUT\"===this.$toggle.prop(\"nodeName\")&&\"checkbox\"===this.$toggle.attr(\"type\").toLowerCase()?\"checkbox\":\"SELECT\"===this.$toggle.prop(\"nodeName\")?\"select\":\"A\"===this.$toggle.prop(\"nodeName\")?\"link\":\"DIV\"===this.$toggle.prop(\"nodeName\")&&this.$toggle.hasClass(\"lightswitch\")?\"lightswitch\":void 0},findTargets:function(){\"select\"===this.type?this._$target=$(this.normalizeTargetSelector(this.targetPrefix+this.getToggleVal())):(this.targetSelector&&(this._$target=$(this.targetSelector)),this.reverseTargetSelector&&(this._$reverseTarget=$(this.reverseTargetSelector)))},getToggleVal:function(){if(\"lightswitch\"===this.type)return this.$toggle.children(\"input\").val();var t=Garnish.getInputPostVal(this.$toggle);return null===t?null:t.replace(/[\\[\\]\\\\]+/g,\"-\")},onToggleChange:function(){\"select\"===this.type?(this.hideTarget(this._$target),this.findTargets(),this.showTarget(this._$target)):(\"link\"===this.type?this.onToggleChange._show=this.$toggle.hasClass(\"collapsed\")||!this.$toggle.hasClass(\"expanded\"):this.onToggleChange._show=!!this.getToggleVal(),this.onToggleChange._show?(this.showTarget(this._$target),this.hideTarget(this._$reverseTarget)):(this.hideTarget(this._$target),this.showTarget(this._$reverseTarget)),delete this.onToggleChange._show)},showTarget:function(t){t&&t.length&&(this.showTarget._currentHeight=t.height(),t.removeClass(\"hidden\"),\"select\"!==this.type&&(\"link\"===this.type&&(this.$toggle.removeClass(\"collapsed\"),this.$toggle.addClass(\"expanded\")),t.height(\"auto\"),this.showTarget._targetHeight=t.height(),t.css({height:this.showTarget._currentHeight,overflow:\"hidden\"}),t.velocity(\"stop\"),t.velocity({height:this.showTarget._targetHeight},\"fast\",function(){t.css({height:\"\",overflow:\"\"})}),delete this.showTarget._targetHeight),delete this.showTarget._currentHeight,Garnish.$win.trigger(\"resize\"))},hideTarget:function(t){t&&t.length&&(\"select\"===this.type?t.addClass(\"hidden\"):(\"link\"===this.type&&(this.$toggle.removeClass(\"expanded\"),this.$toggle.addClass(\"collapsed\")),t.css(\"overflow\",\"hidden\"),t.velocity(\"stop\"),t.velocity({height:0},\"fast\",function(){t.addClass(\"hidden\")})))}}),Craft.Grid=Garnish.Base.extend({$container:null,$items:null,items:null,totalCols:null,colGutterDrop:null,colPctWidth:null,possibleItemColspans:null,possibleItemPositionsByColspan:null,itemPositions:null,itemColspansByPosition:null,layouts:null,layout:null,itemHeights:null,leftPadding:null,_refreshingCols:!1,_refreshColsAfterRefresh:!1,_forceRefreshColsAfterRefresh:!1,init:function(t,e){this.$container=$(t),this.$container.data(\"grid\")&&(Garnish.log(\"Double-instantiating a grid on an element\"),this.$container.data(\"grid\").destroy()),this.$container.data(\"grid\",this),this.setSettings(e,Craft.Grid.defaults),this.handleContainerHeightProxy=$.proxy(function(){this.refreshCols(!1,!0)},this),this.$items=this.$container.children(this.settings.itemSelector),this.setItems(),this.refreshCols(!0,!1),Garnish.$doc.ready($.proxy(function(){this.refreshCols(!1,!1)},this))},addItems:function(t){this.$items=$().add(this.$items.add(t)),this.setItems(),this.refreshCols(!0,!0)},removeItems:function(t){this.$items=$().add(this.$items.not(t)),this.setItems(),this.refreshCols(!0,!0)},resetItemOrder:function(){this.$items=$().add(this.$items),this.setItems(),this.refreshCols(!0,!0)},setItems:function(){for(this.setItems._={},this.items=[],this.setItems._.i=0;this.setItems._.i<this.$items.length;this.setItems._.i++)this.items.push($(this.$items[this.setItems._.i]));delete this.setItems._},refreshCols:function(t){if(this._refreshingCols)return this._refreshColsAfterRefresh=!0,void(t&&(this._forceRefreshColsAfterRefresh=!0));if(this._refreshingCols=!0,this.items.length)if(this.refreshCols._={},this.refreshCols._.oldHeight=this.$container[0].style.height,this.$container[0].style.height=1,this.refreshCols._.scrollHeight=this.$container[0].scrollHeight,this.$container[0].style.height=this.refreshCols._.oldHeight,0!==this.refreshCols._.scrollHeight)if(this.settings.cols?this.refreshCols._.totalCols=this.settings.cols:(this.refreshCols._.totalCols=Math.floor(this.$container.width()/this.settings.minColWidth),null!==this.totalCols&&this.refreshCols._.totalCols>this.totalCols&&(this.refreshCols._.totalCols=Math.floor((this.$container.width()-20)/this.settings.minColWidth)),this.settings.maxCols&&this.refreshCols._.totalCols>this.settings.maxCols&&(this.refreshCols._.totalCols=this.settings.maxCols)),0===this.refreshCols._.totalCols&&(this.refreshCols._.totalCols=1),!0===t||this.totalCols!==this.refreshCols._.totalCols){if(this.totalCols=this.refreshCols._.totalCols,this.colGutterDrop=this.settings.gutter*(this.totalCols-1)/this.totalCols,this.removeListener(this.$container,\"resize\"),\"grid\"===this.settings.fillMode)for(this.refreshCols._.itemIndex=0;this.refreshCols._.itemIndex<this.items.length;){for(this.refreshCols._.tallestItemHeight=-1,this.refreshCols._.colIndex=0,this.refreshCols._.i=this.refreshCols._.itemIndex;this.refreshCols._.i<this.refreshCols._.itemIndex+this.totalCols&&this.refreshCols._.i<this.items.length;this.refreshCols._.i++)this.refreshCols._.itemHeight=this.items[this.refreshCols._.i].height(\"auto\").height(),this.refreshCols._.itemHeight>this.refreshCols._.tallestItemHeight&&(this.refreshCols._.tallestItemHeight=this.refreshCols._.itemHeight),this.refreshCols._.colIndex++;for(this.settings.snapToGrid&&(this.refreshCols._.remainder=this.refreshCols._.tallestItemHeight%this.settings.snapToGrid,this.refreshCols._.remainder&&(this.refreshCols._.tallestItemHeight+=this.settings.snapToGrid-this.refreshCols._.remainder)),this.refreshCols._.i=this.refreshCols._.itemIndex;this.refreshCols._.i<this.refreshCols._.itemIndex+this.totalCols&&this.refreshCols._.i<this.items.length;this.refreshCols._.i++)this.items[this.refreshCols._.i].height(this.refreshCols._.tallestItemHeight);this.refreshCols._.itemIndex+=this.totalCols}else if(this.removeListener(this.$items,\"resize\"),1===this.totalCols)this.$container.height(\"auto\"),this.$items.show().css({position:\"relative\",width:\"auto\",top:0}).css(Craft.left,0);else{for(this.$items.css(\"position\",\"absolute\"),this.colPctWidth=100/this.totalCols,this.layouts=[],this.itemPositions=[],this.itemColspansByPosition=[],this.possibleItemColspans=[],this.possibleItemPositionsByColspan=[],this.itemHeightsByColspan=[],this.refreshCols._.item=0;this.refreshCols._.item<this.items.length;this.refreshCols._.item++)for(this.possibleItemColspans[this.refreshCols._.item]=[],this.possibleItemPositionsByColspan[this.refreshCols._.item]={},this.itemHeightsByColspan[this.refreshCols._.item]={},this.refreshCols._.$item=this.items[this.refreshCols._.item].show(),this.refreshCols._.positionRight=\"right\"===this.refreshCols._.$item.data(\"position\"),this.refreshCols._.positionLeft=\"left\"===this.refreshCols._.$item.data(\"position\"),this.refreshCols._.minColspan=this.refreshCols._.$item.data(\"colspan\")?this.refreshCols._.$item.data(\"colspan\"):this.refreshCols._.$item.data(\"min-colspan\")?this.refreshCols._.$item.data(\"min-colspan\"):1,this.refreshCols._.maxColspan=this.refreshCols._.$item.data(\"colspan\")?this.refreshCols._.$item.data(\"colspan\"):this.refreshCols._.$item.data(\"max-colspan\")?this.refreshCols._.$item.data(\"max-colspan\"):this.totalCols,this.refreshCols._.minColspan>this.totalCols&&(this.refreshCols._.minColspan=this.totalCols),this.refreshCols._.maxColspan>this.totalCols&&(this.refreshCols._.maxColspan=this.totalCols),this.refreshCols._.colspan=this.refreshCols._.minColspan;this.refreshCols._.colspan<=this.refreshCols._.maxColspan;this.refreshCols._.colspan++)for(this.refreshCols._.$item.css(\"width\",this.getItemWidthCss(this.refreshCols._.colspan)),this.itemHeightsByColspan[this.refreshCols._.item][this.refreshCols._.colspan]=this.refreshCols._.$item.outerHeight(),this.possibleItemColspans[this.refreshCols._.item].push(this.refreshCols._.colspan),this.possibleItemPositionsByColspan[this.refreshCols._.item][this.refreshCols._.colspan]=[],this.refreshCols._.positionLeft?(this.refreshCols._.minPosition=0,this.refreshCols._.maxPosition=0):this.refreshCols._.positionRight?(this.refreshCols._.minPosition=this.totalCols-this.refreshCols._.colspan,this.refreshCols._.maxPosition=this.refreshCols._.minPosition):(this.refreshCols._.minPosition=0,this.refreshCols._.maxPosition=this.totalCols-this.refreshCols._.colspan),this.refreshCols._.position=this.refreshCols._.minPosition;this.refreshCols._.position<=this.refreshCols._.maxPosition;this.refreshCols._.position++)this.possibleItemPositionsByColspan[this.refreshCols._.item][this.refreshCols._.colspan].push(this.refreshCols._.position);for(this.refreshCols._.colHeights=[],this.refreshCols._.i=0;this.refreshCols._.i<this.totalCols;this.refreshCols._.i++)this.refreshCols._.colHeights.push(0);for(this.createLayouts(0,[],[],this.refreshCols._.colHeights,0),this.refreshCols._.layoutTotalCols=[],this.refreshCols._.i=0;this.refreshCols._.i<this.layouts.length;this.refreshCols._.i++)for(this.refreshCols._.layoutTotalCols[this.refreshCols._.i]=0,this.refreshCols._.j=0;this.refreshCols._.j<this.totalCols;this.refreshCols._.j++)this.layouts[this.refreshCols._.i].colHeights[this.refreshCols._.j]&&this.refreshCols._.layoutTotalCols[this.refreshCols._.i]++;for(this.refreshCols._.highestTotalCols=Math.max.apply(null,this.refreshCols._.layoutTotalCols),this.refreshCols._.i=this.layouts.length-1;0<=this.refreshCols._.i;this.refreshCols._.i--)this.refreshCols._.layoutTotalCols[this.refreshCols._.i]!==this.refreshCols._.highestTotalCols&&this.layouts.splice(this.refreshCols._.i,1);for(this.refreshCols._.layoutHeights=[],this.refreshCols._.i=0;this.refreshCols._.i<this.layouts.length;this.refreshCols._.i++)this.refreshCols._.layoutHeights.push(Math.max.apply(null,this.layouts[this.refreshCols._.i].colHeights));for(this.refreshCols._.shortestHeight=Math.min.apply(null,this.refreshCols._.layoutHeights),this.refreshCols._.shortestLayouts=[],this.refreshCols._.emptySpaces=[],this.refreshCols._.i=0;this.refreshCols._.i<this.refreshCols._.layoutHeights.length;this.refreshCols._.i++)if(this.refreshCols._.layoutHeights[this.refreshCols._.i]===this.refreshCols._.shortestHeight){for(this.refreshCols._.shortestLayouts.push(this.layouts[this.refreshCols._.i]),this.refreshCols._.emptySpace=this.layouts[this.refreshCols._.i].emptySpace,this.refreshCols._.j=0;this.refreshCols._.j<this.totalCols;this.refreshCols._.j++)this.refreshCols._.emptySpace+=this.refreshCols._.shortestHeight-this.layouts[this.refreshCols._.i].colHeights[this.refreshCols._.j];this.refreshCols._.emptySpaces.push(this.refreshCols._.emptySpace)}for(this.layout=this.refreshCols._.shortestLayouts[$.inArray(Math.min.apply(null,this.refreshCols._.emptySpaces),this.refreshCols._.emptySpaces)],this.refreshCols._.i=0;this.refreshCols._.i<this.items.length;this.refreshCols._.i++)this.refreshCols._.css={width:this.getItemWidthCss(this.layout.colspans[this.refreshCols._.i])},this.refreshCols._.css[Craft.left]=this.getItemLeftPosCss(this.layout.positions[this.refreshCols._.i]),this.items[this.refreshCols._.i].css(this.refreshCols._.css);this.isSimpleLayout()?(this.$container.height(\"auto\"),this.$items.css({position:\"relative\",top:0,\"margin-bottom\":this.settings.gutter+\"px\"})):(this.$items.css(\"position\",\"absolute\"),this.positionItems(),this.addListener(this.$items,\"resize\",\"onItemResize\"))}this.completeRefreshCols(),this.addListener(this.$container,\"resize\",this.handleContainerHeightProxy),this.onRefreshCols()}else this.completeRefreshCols();else this.completeRefreshCols();else this.completeRefreshCols()},completeRefreshCols:function(){if(void 0!==this.refreshCols._&&delete this.refreshCols._,this._refreshingCols=!1,this._refreshColsAfterRefresh){var t=this._forceRefreshColsAfterRefresh;this._refreshColsAfterRefresh=!1,this._forceRefreshColsAfterRefresh=!1,Garnish.requestAnimationFrame($.proxy(function(){this.refreshCols(t)},this))}},getItemWidth:function(t){return this.colPctWidth*t},getItemWidthCss:function(t){return\"calc(\"+this.getItemWidth(t)+\"% - \"+this.colGutterDrop+\"px)\"},getItemWidthInPx:function(t){return this.getItemWidth(t)/100*this.$container.width()-this.colGutterDrop},getItemLeftPosCss:function(t){return\"calc((\"+this.getItemWidth(1)+\"% + \"+(this.settings.gutter-this.colGutterDrop)+\"px) * \"+t+\")\"},getItemLeftPosInPx:function(t){return(this.getItemWidth(1)/100*this.$container.width()+(this.settings.gutter-this.colGutterDrop))*t},createLayouts:function(t,e,i,s,n){new Craft.Grid.LayoutGenerator(this).createLayouts(t,e,i,s,n)},isSimpleLayout:function(){for(this.isSimpleLayout._={},this.isSimpleLayout._.i=0;this.isSimpleLayout._.i<this.layout.positions.length;this.isSimpleLayout._.i++)if(0!==this.layout.positions[this.isSimpleLayout._.i])return delete this.isSimpleLayout._,!1;return delete this.isSimpleLayout._,!0},positionItems:function(){for(this.positionItems._={},this.positionItems._.colHeights=[],this.positionItems._.i=0;this.positionItems._.i<this.totalCols;this.positionItems._.i++)this.positionItems._.colHeights.push(0);for(this.positionItems._.i=0;this.positionItems._.i<this.items.length;this.positionItems._.i++){for(this.positionItems._.endingCol=this.layout.positions[this.positionItems._.i]+this.layout.colspans[this.positionItems._.i]-1,this.positionItems._.affectedColHeights=[],this.positionItems._.col=this.layout.positions[this.positionItems._.i];this.positionItems._.col<=this.positionItems._.endingCol;this.positionItems._.col++)this.positionItems._.affectedColHeights.push(this.positionItems._.colHeights[this.positionItems._.col]);for(this.positionItems._.top=Math.max.apply(null,this.positionItems._.affectedColHeights),0<this.positionItems._.top&&(this.positionItems._.top+=this.settings.gutter),this.items[this.positionItems._.i].css(\"top\",this.positionItems._.top),this.positionItems._.col=this.layout.positions[this.positionItems._.i];this.positionItems._.col<=this.positionItems._.endingCol;this.positionItems._.col++)this.positionItems._.colHeights[this.positionItems._.col]=this.positionItems._.top+this.itemHeightsByColspan[this.positionItems._.i][this.layout.colspans[this.positionItems._.i]]}this.$container.height(Math.max.apply(null,this.positionItems._.colHeights)),delete this.positionItems._},onItemResize:function(t){this.onItemResize._={},t.stopPropagation(),this.onItemResize._.item=$.inArray(t.currentTarget,this.$items),-1!==this.onItemResize._.item&&(this.onItemResize._.newHeight=this.items[this.onItemResize._.item].outerHeight(),this.onItemResize._.newHeight!==this.itemHeightsByColspan[this.onItemResize._.item][this.layout.colspans[this.onItemResize._.item]]&&(this.itemHeightsByColspan[this.onItemResize._.item][this.layout.colspans[this.onItemResize._.item]]=this.onItemResize._.newHeight,this.positionItems(!1))),delete this.onItemResize._},onRefreshCols:function(){this.trigger(\"refreshCols\"),this.settings.onRefreshCols()}},{defaults:{itemSelector:\".item\",cols:null,maxCols:null,minColWidth:320,gutter:14,fillMode:\"top\",colClass:\"col\",snapToGrid:null,onRefreshCols:$.noop}}),Craft.Grid.LayoutGenerator=Garnish.Base.extend({grid:null,_:null,init:function(t){this.grid=t},createLayouts:function(t,e,i,s,n){for(this._={},this._.c=0;this._.c<this.grid.possibleItemColspans[t].length;this._.c++){for(this._.colspan=this.grid.possibleItemColspans[t][this._.c],this._.tallestColHeightsByPosition=[],this._.p=0;this._.p<this.grid.possibleItemPositionsByColspan[t][this._.colspan].length;this._.p++){for(this._.position=this.grid.possibleItemPositionsByColspan[t][this._.colspan][this._.p],this._.colHeightsForPosition=[],this._.endingCol=this._.position+this._.colspan-1,this._.col=this._.position;this._.col<=this._.endingCol;this._.col++)this._.colHeightsForPosition.push(s[this._.col]);this._.tallestColHeightsByPosition[this._.p]=Math.max.apply(null,this._.colHeightsForPosition)}for(this._.p=$.inArray(Math.min.apply(null,this._.tallestColHeightsByPosition),this._.tallestColHeightsByPosition),this._.position=this.grid.possibleItemPositionsByColspan[t][this._.colspan][this._.p],this._.positions=e.slice(0),this._.colspans=i.slice(0),this._.colHeights=s.slice(0),this._.emptySpace=n,this._.positions.push(this._.position),this._.colspans.push(this._.colspan),this._.tallestColHeight=this._.tallestColHeightsByPosition[this._.p],this._.endingCol=this._.position+this._.colspan-1,this._.col=this._.position;this._.col<=this._.endingCol;this._.col++)this._.emptySpace+=this._.tallestColHeight-this._.colHeights[this._.col],this._.colHeights[this._.col]=this._.tallestColHeight+this.grid.itemHeightsByColspan[t][this._.colspan];t===this.grid.items.length-1?this.grid.layouts.push({positions:this._.positions,colspans:this._.colspans,colHeights:this._.colHeights,emptySpace:this._.emptySpace}):this.grid.createLayouts(t+1,this._.positions,this._.colspans,this._.colHeights,this._.emptySpace)}delete this._}}),Craft.HandleGenerator=Craft.BaseInputGenerator.extend({generateTargetValue:function(t){var e=t.replace(\"/<(.*?)>/g\",\"\");e=(e=e.replace(/['\"\u2018\u2019\u201c\u201d\\[\\]\\(\\)\\{\\}:]/g,\"\")).toLowerCase(),e=Craft.asciiString(e),this.settings.allowNonAlphaStart||(e=e.replace(/^[^a-z]+/,\"\"));var i=Craft.filterArray(e.split(/[^a-z0-9]+/));e=\"\";for(var s=0;s<i.length;s++)e+=0===s?i[s]:i[s].charAt(0).toUpperCase()+i[s].substr(1);return e}}),Craft.ImageUpload=Garnish.Base.extend({$container:null,progressBar:null,uploader:null,init:function(t){this.setSettings(t,Craft.ImageUpload.defaults),this.initImageUpload()},initImageUpload:function(){this.$container=$(this.settings.containerSelector),this.progressBar=new Craft.ProgressBar($('<div class=\"progress-shade\"></div>').appendTo(this.$container));var t={url:Craft.getActionUrl(this.settings.uploadAction),formData:this.settings.postParameters,fileInput:this.$container.find(this.settings.fileInputSelector),paramName:this.settings.uploadParamName};void 0!==Craft.csrfTokenName&&void 0!==Craft.csrfTokenValue&&(t.formData[Craft.csrfTokenName]=Craft.csrfTokenValue),t.events={},t.events.fileuploadstart=$.proxy(this,\"_onUploadStart\"),t.events.fileuploadprogressall=$.proxy(this,\"_onUploadProgress\"),t.events.fileuploaddone=$.proxy(this,\"_onUploadComplete\"),t.events.fileuploadfail=$.proxy(this,\"_onUploadError\"),this.uploader=new Craft.Uploader(this.$container,t),this.initButtons()},initButtons:function(){this.$container.find(this.settings.uploadButtonSelector).on(\"click\",$.proxy(function(t){this.$container.find(this.settings.fileInputSelector).trigger(\"click\")},this)),this.$container.find(this.settings.deleteButtonSelector).on(\"click\",$.proxy(function(t){confirm(Craft.t(\"app\",\"Are you sure you want to delete this image?\"))&&($(t.currentTarget).parent().append('<div class=\"blocking-modal\"></div>'),Craft.postActionRequest(this.settings.deleteAction,this.settings.postParameters,$.proxy(function(t,e){\"success\"===e&&this.refreshImage(t)},this)))},this))},refreshImage:function(t){$(this.settings.containerSelector).replaceWith(t.html),this.settings.onAfterRefreshImage(t),this.initImageUpload()},_onUploadStart:function(t){this.progressBar.$progressBar.css({top:Math.round(this.$container.outerHeight()/2)-6}),this.$container.addClass(\"uploading\"),this.progressBar.resetProgressBar(),this.progressBar.showProgressBar()},_onUploadProgress:function(t,e){var i=parseInt(e.loaded/e.total*100,10);this.progressBar.setProgressPercentage(i)},_onUploadComplete:function(t,e){if(e.result.error)alert(e.result.error);else{$(e.result.html);this.refreshImage(e.result)}this.uploader.isLastUpload()&&(this.progressBar.hideProgressBar(),this.$container.removeClass(\"uploading\"))},_onUploadError:function(t,e){e.jqXHR.responseJSON.error&&(alert(e.jqXHR.responseJSON.error),this.$container.removeClass(\"uploading\"),this.progressBar.hideProgressBar(),this.progressBar.resetProgressBar())}},{defaults:{postParameters:{},uploadAction:\"\",deleteAction:\"\",fileInputSelector:\"\",onAfterRefreshImage:$.noop,containerSelector:null,uploadButtonSelector:null,deleteButtonSelector:null,uploadParamName:\"files\"}}),Craft.InfoIcon=Garnish.Base.extend({$icon:null,hud:null,init:function(t){this.$icon=$(t),this.addListener(this.$icon,\"click\",\"showHud\")},showHud:function(){this.hud?this.hud.show():this.hud=new Garnish.HUD(this.$icon,this.$icon.html(),{hudClass:\"hud info-hud\",closeOtherHUDs:!1})}}),Craft.LightSwitch=Garnish.Base.extend({settings:null,$outerContainer:null,$innerContainer:null,$input:null,small:!1,on:null,dragger:null,dragStartMargin:null,init:function(t,e){this.$outerContainer=$(t),this.$outerContainer.data(\"lightswitch\")&&(Garnish.log(\"Double-instantiating a lightswitch on an element\"),this.$outerContainer.data(\"lightswitch\").destroy()),this.$outerContainer.data(\"lightswitch\",this),this.small=this.$outerContainer.hasClass(\"small\"),this.setSettings(e,Craft.LightSwitch.defaults),this.$innerContainer=this.$outerContainer.find(\".lightswitch-container:first\"),this.$input=this.$outerContainer.find(\"input:first\"),this.$input.prop(\"disabled\")||(this.on=this.$outerContainer.hasClass(\"on\"),this.$outerContainer.attr({role:\"checkbox\",\"aria-checked\":this.on?\"true\":\"false\"}),this.addListener(this.$outerContainer,\"mousedown\",\"_onMouseDown\"),this.addListener(this.$outerContainer,\"keydown\",\"_onKeyDown\"),this.dragger=new Garnish.BaseDrag(this.$outerContainer,{axis:Garnish.X_AXIS,ignoreHandleSelector:null,onDragStart:$.proxy(this,\"_onDragStart\"),onDrag:$.proxy(this,\"_onDrag\"),onDragStop:$.proxy(this,\"_onDragStop\")}))},turnOn:function(){this.$outerContainer.addClass(\"dragging\");var t={};t[\"margin-\"+Craft.left]=0,this.$innerContainer.velocity(\"stop\").velocity(t,Craft.LightSwitch.animationDuration,$.proxy(this,\"_onSettle\")),this.$input.val(this.settings.value),this.$outerContainer.addClass(\"on\"),this.$outerContainer.attr(\"aria-checked\",\"true\"),this.on!==(this.on=!0)&&this.onChange()},turnOff:function(){this.$outerContainer.addClass(\"dragging\");var t={};t[\"margin-\"+Craft.left]=this._getOffMargin(),this.$innerContainer.velocity(\"stop\").velocity(t,Craft.LightSwitch.animationDuration,$.proxy(this,\"_onSettle\")),this.$input.val(\"\"),this.$outerContainer.removeClass(\"on\"),this.$outerContainer.attr(\"aria-checked\",\"false\"),this.on!==(this.on=!1)&&this.onChange()},toggle:function(t){this.on?this.turnOff():this.turnOn()},onChange:function(){this.trigger(\"change\"),this.settings.onChange(),this.$outerContainer.trigger(\"change\")},_onMouseDown:function(){this.addListener(Garnish.$doc,\"mouseup\",\"_onMouseUp\")},_onMouseUp:function(){this.removeListener(Garnish.$doc,\"mouseup\"),this.dragger.dragging||this.toggle()},_onKeyDown:function(t){switch(t.keyCode){case Garnish.SPACE_KEY:this.toggle(),t.preventDefault();break;case Garnish.RIGHT_KEY:\"ltr\"===Craft.orientation?this.turnOn():this.turnOff(),t.preventDefault();break;case Garnish.LEFT_KEY:\"ltr\"===Craft.orientation?this.turnOff():this.turnOn(),t.preventDefault()}},_getMargin:function(){return parseInt(this.$innerContainer.css(\"margin-\"+Craft.left))},_onDragStart:function(){this.$outerContainer.addClass(\"dragging\"),this.dragStartMargin=this._getMargin()},_onDrag:function(){var t;(t=\"ltr\"===Craft.orientation?this.dragStartMargin+this.dragger.mouseDistX:this.dragStartMargin-this.dragger.mouseDistX)<this._getOffMargin()?t=this._getOffMargin():0<t&&(t=0),this.$innerContainer.css(\"margin-\"+Craft.left,t)},_onDragStop:function(){this._getMargin()>this._getOffMargin()/2?this.turnOn():this.turnOff()},_onSettle:function(){this.$outerContainer.removeClass(\"dragging\")},destroy:function(){this.base(),this.dragger.destroy()},_getOffMargin:function(){return this.small?-9:-11}},{animationDuration:100,defaults:{value:\"1\",onChange:$.noop}}),Craft.LivePreview=Garnish.Base.extend({$extraFields:null,$trigger:null,$shade:null,$editorContainer:null,$editor:null,$dragHandle:null,$iframeContainer:null,$iframe:null,$fieldPlaceholder:null,previewUrl:null,token:null,basePostData:null,inPreviewMode:!1,fields:null,lastPostData:null,updateIframeInterval:null,loading:!1,checkAgain:!1,dragger:null,dragStartEditorWidth:null,_slideInOnIframeLoad:!1,_handleSuccessProxy:null,_handleErrorProxy:null,_forceUpdateIframeProxy:null,_scrollX:null,_scrollY:null,_editorWidth:null,_editorWidthInPx:null,init:function(t){this.setSettings(t,Craft.LivePreview.defaults),this.settings.previewUrl?this.previewUrl=this.settings.previewUrl:this.previewUrl=Craft.baseSiteUrl.replace(/\\/+$/,\"\")+\"/\",\"https:\"===document.location.protocol&&(this.previewUrl=this.previewUrl.replace(/^http:/,\"https:\")),this.basePostData=$.extend({},this.settings.previewParams),this._handleSuccessProxy=$.proxy(this,\"handleSuccess\"),this._handleErrorProxy=$.proxy(this,\"handleError\"),this._forceUpdateIframeProxy=$.proxy(this,\"forceUpdateIframe\"),this.$extraFields=$(this.settings.extraFields),this.$trigger=$(this.settings.trigger),this.$fieldPlaceholder=$(\"<div/>\"),this.editorWidth=Craft.getLocalStorage(\"LivePreview.editorWidth\",Craft.LivePreview.defaultEditorWidth),this.addListener(this.$trigger,\"activate\",\"toggle\"),Craft.cp.on(\"beforeSaveShortcut\",$.proxy(function(){this.inPreviewMode&&this.moveFieldsBack()},this))},get editorWidth(){return this._editorWidth},get editorWidthInPx(){return this._editorWidthInPx},set editorWidth(t){var e;1<=t?(e=t,t/=Garnish.$win.width()):e=Math.round(t*Garnish.$win.width()),e<Craft.LivePreview.minEditorWidthInPx&&(t=(e=Craft.LivePreview.minEditorWidthInPx)/Garnish.$win.width()),this._editorWidth=t,this._editorWidthInPx=e},toggle:function(){this.inPreviewMode?this.exit():this.enter()},enter:function(){if(!this.inPreviewMode)if(this.token){if(this.trigger(\"beforeEnter\"),$(document.activeElement).trigger(\"blur\"),!this.$editor){this.$shade=$(\"<div/>\",{class:\"modal-shade dark\"}).appendTo(Garnish.$bod),this.$editorContainer=$(\"<div/>\",{class:\"lp-editor-container\"}).appendTo(Garnish.$bod),this.$iframeContainer=$(\"<div/>\",{class:\"lp-preview-container\"}).appendTo(Garnish.$bod);var t=$(\"<header/>\",{class:\"flex\"}).appendTo(this.$editorContainer);this.$editor=$(\"<form/>\",{class:\"lp-editor\"}).appendTo(this.$editorContainer),this.$dragHandle=$(\"<div/>\",{class:\"lp-draghandle\"}).appendTo(this.$editorContainer);var e=$(\"<div/>\",{class:\"btn\",text:Craft.t(\"app\",\"Close Preview\")}).appendTo(t);$(\"<div/>\",{class:\"flex-grow\"}).appendTo(t);var i=$('<div class=\"btn submit\">'+Craft.t(\"app\",\"Save\")+\"</div>\").appendTo(t);this.dragger=new Garnish.BaseDrag(this.$dragHandle,{axis:Garnish.X_AXIS,onDragStart:$.proxy(this,\"_onDragStart\"),onDrag:$.proxy(this,\"_onDrag\"),onDragStop:$.proxy(this,\"_onDragStop\")}),this.addListener(e,\"click\",\"exit\"),this.addListener(i,\"click\",\"save\")}this.handleWindowResize(),this.addListener(Garnish.$win,\"resize\",\"handleWindowResize\"),this.$editorContainer.css(Craft.left,-(this.editorWidthInPx+Craft.LivePreview.dragHandleWidth)+\"px\"),this.$iframeContainer.css(Craft.right,-this.getIframeWidth()),this.fields=[];for(var s=$(this.settings.fields),n=0;n<s.length;n++){var a=$(s[n]),r=this._getClone(a);this.$fieldPlaceholder.insertAfter(a),a.detach(),this.$fieldPlaceholder.replaceWith(r),a.appendTo(this.$editor),this.fields.push({$field:a,$clone:r})}this.updateIframe()?this._slideInOnIframeLoad=!0:this.slideIn(),Garnish.on(Craft.BaseElementEditor,\"saveElement\",this._forceUpdateIframeProxy),Garnish.on(Craft.AssetImageEditor,\"save\",this._forceUpdateIframeProxy),this.inPreviewMode=!0,this.trigger(\"enter\")}else this.createToken()},createToken:function(){Craft.postActionRequest(\"live-preview/create-token\",{previewAction:this.settings.previewAction},$.proxy(function(t,e){\"success\"===e&&(this.token=t.token,this.enter())},this))},save:function(){Craft.cp.submitPrimaryForm()},handleWindowResize:function(){this.editorWidth=this.editorWidth,this.updateWidths()},slideIn:function(){$(\"html\").addClass(\"noscroll\"),this.$shade.velocity(\"fadeIn\"),this.$editorContainer.show().velocity(\"stop\").animateLeft(0,\"slow\",$.proxy(function(){this.trigger(\"slideIn\"),Garnish.$win.trigger(\"resize\")},this)),this.$iframeContainer.show().velocity(\"stop\").animateRight(0,\"slow\",$.proxy(function(){this.updateIframeInterval=setInterval($.proxy(this,\"updateIframe\"),1e3),this.addListener(Garnish.$bod,\"keyup\",function(t){t.keyCode===Garnish.ESC_KEY&&this.exit()})},this))},exit:function(){this.inPreviewMode&&(this.trigger(\"beforeExit\"),$(\"html\").removeClass(\"noscroll\"),this.removeListener(Garnish.$win,\"resize\"),this.removeListener(Garnish.$bod,\"keyup\"),this.updateIframeInterval&&clearInterval(this.updateIframeInterval),this.moveFieldsBack(),this.$shade.delay(200).velocity(\"fadeOut\"),this.$editorContainer.velocity(\"stop\").animateLeft(-(this.editorWidthInPx+Craft.LivePreview.dragHandleWidth),\"slow\",$.proxy(function(){for(var t=0;t<this.fields.length;t++)this.fields[t].$newClone.remove();this.$editorContainer.hide(),this.trigger(\"slideOut\")},this)),this.$iframeContainer.velocity(\"stop\").animateRight(-this.getIframeWidth(),\"slow\",$.proxy(function(){this.$iframeContainer.hide()},this)),Garnish.off(Craft.BaseElementEditor,\"saveElement\",this._forceUpdateIframeProxy),this.inPreviewMode=!1,this.trigger(\"exit\"))},moveFieldsBack:function(){for(var t=0;t<this.fields.length;t++){var e=this.fields[t];e.$newClone=this._getClone(e.$field),this.$fieldPlaceholder.insertAfter(e.$field),e.$field.detach(),this.$fieldPlaceholder.replaceWith(e.$newClone),e.$clone.replaceWith(e.$field)}Garnish.$win.trigger(\"resize\")},getIframeWidth:function(){return Garnish.$win.width()-(this.editorWidthInPx+Craft.LivePreview.dragHandleWidth)},updateWidths:function(){this.$editorContainer.css(\"width\",this.editorWidthInPx+\"px\"),this.$iframeContainer.width(this.getIframeWidth())},updateIframe:function(t){if(t&&(this.lastPostData=null),!this.inPreviewMode)return!1;if(this.loading)return!(this.checkAgain=!0);var e=$.extend(Garnish.getPostData(this.$editor),Garnish.getPostData(this.$extraFields));if(this.lastPostData&&Craft.compare(e,this.lastPostData,!1))return!1;this.lastPostData=e,this.loading=!0;var i=this.$iframe?$(this.$iframe[0].contentWindow.document):null;return this._scrollX=i?i.scrollLeft():0,this._scrollY=i?i.scrollTop():0,$.ajax({url:this.previewUrl+(-1!==this.previewUrl.indexOf(\"?\")?\"&\":\"?\")+Craft.tokenParam+\"=\"+this.token,method:\"POST\",data:$.extend({},e,this.basePostData),headers:{\"X-Craft-Token\":this.token},xhrFields:{withCredentials:!0},crossDomain:!0,success:this._handleSuccessProxy,error:this._handleErrorProxy}),!0},forceUpdateIframe:function(){return this.updateIframe(!0)},handleSuccess:function(t){var e=t+'<script type=\"text/javascript\">window.scrollTo('+this._scrollX+\", \"+this._scrollY+\");<\\/script>\",i=$('<iframe class=\"lp-preview\" frameborder=\"0\"/>');this.$iframe?i.insertBefore(this.$iframe):i.appendTo(this.$iframeContainer),this.addListener(i,\"load\",function(){this.$iframe&&this.$iframe.remove(),this.$iframe=i,this._slideInOnIframeLoad&&(this.slideIn(),this._slideInOnIframeLoad=!1),this.removeListener(i,\"load\")}),Garnish.requestAnimationFrame($.proxy(function(){i[0].contentWindow.document.open(),i[0].contentWindow.document.write(e),i[0].contentWindow.document.close(),this.onResponse()},this))},handleError:function(){this.onResponse()},onResponse:function(){this.loading=!1,this.checkAgain&&(this.checkAgain=!1,this.updateIframe())},_getClone:function(t){var e=t.clone();return Garnish.copyInputValues(t,e),e.attr(\"id\",\"\"),e.find(\"[id]\").attr(\"id\",\"\"),e},_onDragStart:function(){this.dragStartEditorWidth=this.editorWidthInPx,this.$iframeContainer.addClass(\"dragging\")},_onDrag:function(){\"ltr\"===Craft.orientation?this.editorWidth=this.dragStartEditorWidth+this.dragger.mouseDistX:this.editorWidth=this.dragStartEditorWidth-this.dragger.mouseDistX,this.updateWidths()},_onDragStop:function(){this.$iframeContainer.removeClass(\"dragging\"),Craft.setLocalStorage(\"LivePreview.editorWidth\",this.editorWidth)}},{defaultEditorWidth:.33,minEditorWidthInPx:320,dragHandleWidth:4,defaults:{trigger:\".livepreviewbtn\",fields:null,extraFields:null,previewUrl:null,previewAction:null,previewParams:{}}}),Craft.LivePreview.init=function(t){Craft.livePreview=new Craft.LivePreview(t)},Craft.PasswordInput=Garnish.Base.extend({$passwordInput:null,$textInput:null,$currentInput:null,$showPasswordToggle:null,showingPassword:null,init:function(t,e){this.$passwordInput=$(t),this.settings=$.extend({},Craft.PasswordInput.defaults,e),this.$passwordInput.data(\"passwordInput\")&&(Garnish.log(\"Double-instantiating a password input on an element\"),this.$passwordInput.data(\"passwordInput\").destroy()),this.$passwordInput.data(\"passwordInput\",this),this.$showPasswordToggle=$(\"<a/>\").hide(),this.$showPasswordToggle.addClass(\"password-toggle\"),this.$showPasswordToggle.insertAfter(this.$passwordInput),this.addListener(this.$showPasswordToggle,\"mousedown\",\"onToggleMouseDown\"),this.hidePassword()},setCurrentInput:function(t){this.$currentInput&&(t.addClass(\"focus\"),t.insertAfter(this.$currentInput),this.$currentInput.detach(),t.trigger(\"focus\"),t.removeClass(\"focus\"),t.val(this.$currentInput.val())),this.$currentInput=t,this.addListener(this.$currentInput,\"keypress,keyup,change,blur\",\"onInputChange\")},updateToggleLabel:function(t){this.$showPasswordToggle.text(t)},showPassword:function(){this.showingPassword||(this.$textInput||(this.$textInput=this.$passwordInput.clone(!0),this.$textInput.attr(\"type\",\"text\")),this.setCurrentInput(this.$textInput),this.updateToggleLabel(Craft.t(\"app\",\"Hide\")),this.showingPassword=!0)},hidePassword:function(){!1!==this.showingPassword&&(this.setCurrentInput(this.$passwordInput),this.updateToggleLabel(Craft.t(\"app\",\"Show\")),this.showingPassword=!1,this.addListener(this.$passwordInput,\"keydown\",\"onKeyDown\"))},togglePassword:function(){this.showingPassword?this.hidePassword():this.showPassword(),this.settings.onToggleInput(this.$currentInput)},onKeyDown:function(t){t.keyCode===Garnish.ALT_KEY&&this.$currentInput.val()&&(this.showPassword(),this.$showPasswordToggle.hide(),this.addListener(this.$textInput,\"keyup\",\"onKeyUp\"))},onKeyUp:function(t){t.preventDefault(),t.keyCode===Garnish.ALT_KEY&&(this.hidePassword(),this.$showPasswordToggle.show())},onInputChange:function(){this.$currentInput.val()?this.$showPasswordToggle.show():this.$showPasswordToggle.hide()},onToggleMouseDown:function(t){if(t.preventDefault(),this.$currentInput[0].setSelectionRange){var e=this.$currentInput[0].selectionStart,i=this.$currentInput[0].selectionEnd;this.togglePassword(),this.$currentInput[0].setSelectionRange(e,i)}else this.togglePassword()}},{defaults:{onToggleInput:$.noop}}),Craft.Preview=Garnish.Base.extend({draftEditor:null,$shade:null,$editorContainer:null,$editor:null,$spinner:null,$statusIcon:null,$dragHandle:null,$previewContainer:null,$targetBtn:null,$targetMenu:null,$iframe:null,$tempInput:null,$fieldPlaceholder:null,isActive:!1,activeTarget:0,url:null,fields:null,scrollLeft:0,scrollTop:0,dragger:null,dragStartEditorWidth:null,_slideInOnIframeLoad:!1,_updateIframeProxy:null,_editorWidth:null,_editorWidthInPx:null,init:function(t){this.draftEditor=t,this._updateIframeProxy=$.proxy(this,\"updateIframe\"),this.$tempInput=$(\"<input/>\",{type:\"hidden\",name:\"__PREVIEW_FIELDS__\",value:\"1\"}),this.$fieldPlaceholder=$(\"<div/>\"),this.editorWidth=Craft.getLocalStorage(\"LivePreview.editorWidth\",Craft.Preview.defaultEditorWidth)},get editorWidth(){return this._editorWidth},get editorWidthInPx(){return this._editorWidthInPx},set editorWidth(t){var e;1<=t?(e=t,t/=Garnish.$win.width()):e=Math.round(t*Garnish.$win.width()),e<Craft.Preview.minEditorWidthInPx&&(t=(e=Craft.Preview.minEditorWidthInPx)/Garnish.$win.width()),this._editorWidth=t,this._editorWidthInPx=e},open:function(){if(!this.isActive){if(this.isActive=!0,this.trigger(\"beforeOpen\"),$(document.activeElement).trigger(\"blur\"),!this.$editor){this.$shade=$(\"<div/>\",{class:\"modal-shade dark\"}).appendTo(Garnish.$bod),this.$editorContainer=$(\"<div/>\",{class:\"lp-editor-container\"}).appendTo(Garnish.$bod),this.$previewContainer=$(\"<div/>\",{class:\"lp-preview-container\"}).appendTo(Garnish.$bod);var t=$(\"<header/>\",{class:\"flex\"}).appendTo(this.$editorContainer);this.$editor=$(\"<form/>\",{class:\"lp-editor\"}).appendTo(this.$editorContainer),this.$dragHandle=$(\"<div/>\",{class:\"lp-draghandle\"}).appendTo(this.$editorContainer);var e=$(\"<div/>\",{class:\"btn\",text:Craft.t(\"app\",\"Close Preview\")}).appendTo(t);if($(\"<div/>\",{class:\"flex-grow\"}).appendTo(t),this.$spinner=$(\"<div/>\",{class:\"spinner hidden\",title:Craft.t(\"app\",\"Saving\")}).appendTo(t),this.$statusIcon=$(\"<div/>\",{class:\"invisible\"}).appendTo(t),1<this.draftEditor.settings.previewTargets.length){var i=$(\"<header/>\",{class:\"flex\"}).appendTo(this.$previewContainer);this.$targetBtn=$(\"<div/>\",{class:\"btn menubtn\",text:this.draftEditor.settings.previewTargets[0].label,role:\"btn\"}).appendTo(i),this.$targetMenu=$(\"<div/>\",{class:\"menu lp-target-menu\"}).insertAfter(this.$targetBtn);for(var s,n=$(\"<ul/>\",{class:\"padded\"}).appendTo(this.$targetMenu),a=0;a<this.draftEditor.settings.previewTargets.length;a++)s=$(\"<li/>\").appendTo(n),$(\"<a/>\",{data:{target:a},text:this.draftEditor.settings.previewTargets[a].label,class:0===a?\"sel\":null}).appendTo(s);new Garnish.MenuBtn(this.$targetBtn,{onOptionSelect:$.proxy(function(t){this.switchTarget($(t).data(\"target\"))},this)})}this.dragger=new Garnish.BaseDrag(this.$dragHandle,{axis:Garnish.X_AXIS,onDragStart:$.proxy(this,\"_onDragStart\"),onDrag:$.proxy(this,\"_onDrag\"),onDragStop:$.proxy(this,\"_onDragStop\")}),this.addListener(e,\"click\",\"close\"),this.addListener(this.$statusIcon,\"click\",function(){this.draftEditor.showStatusHud(this.$statusIcon)}.bind(this))}this.handleWindowResize(),this.addListener(Garnish.$win,\"resize\",\"handleWindowResize\"),this.$editorContainer.css(Craft.left,-(this.editorWidthInPx+Craft.Preview.dragHandleWidth)+\"px\"),this.$previewContainer.css(Craft.right,-this.getIframeWidth()),this.fields=[];var r=$(\"#content .field\").not($(\"#content .field .field\"));if(r.length){this.$tempInput.insertBefore(r.get(0));for(a=0;a<r.length;a++){var o=$(r[a]),l=this._getClone(o);this.$fieldPlaceholder.insertAfter(o),o.detach(),this.$fieldPlaceholder.replaceWith(l),o.appendTo(this.$editor),this.fields.push({$field:o,$clone:l})}}this._slideInOnIframeLoad=!0,this.updateIframe(),this.draftEditor.on(\"update\",this._updateIframeProxy),Garnish.on(Craft.BaseElementEditor,\"saveElement\",this._updateIframeProxy),Garnish.on(Craft.AssetImageEditor,\"save\",this._updateIframeProxy),this.trigger(\"open\")}},switchTarget:function(t){this.activeTarget=t,this.$targetBtn.text(this.draftEditor.settings.previewTargets[t].label),this.$targetMenu.find(\"a.sel\").removeClass(\"sel\"),this.$targetMenu.find(\"a\").eq(t).addClass(\"sel\"),this.updateIframe(!0)},handleWindowResize:function(){this.editorWidth=this.editorWidth,this.updateWidths()},slideIn:function(){$(\"html\").addClass(\"noscroll\"),this.$shade.velocity(\"fadeIn\"),this.$editorContainer.show().velocity(\"stop\").animateLeft(0,\"slow\",$.proxy(function(){this.trigger(\"slideIn\"),Garnish.$win.trigger(\"resize\")},this)),this.$previewContainer.show().velocity(\"stop\").animateRight(0,\"slow\",$.proxy(function(){this.addListener(Garnish.$bod,\"keyup\",function(t){t.keyCode===Garnish.ESC_KEY&&this.close()})},this))},close:function(){this.isActive&&(this.trigger(\"beforeClose\"),$(\"html\").removeClass(\"noscroll\"),this.removeListener(Garnish.$win,\"resize\"),this.removeListener(Garnish.$bod,\"keyup\"),this.$tempInput.detach(),this.moveFieldsBack(),this.$shade.delay(200).velocity(\"fadeOut\"),this.$editorContainer.velocity(\"stop\").animateLeft(-(this.editorWidthInPx+Craft.Preview.dragHandleWidth),\"slow\",$.proxy(function(){for(var t=0;t<this.fields.length;t++)this.fields[t].$newClone.remove();this.$editorContainer.hide(),this.trigger(\"slideOut\")},this)),this.$previewContainer.velocity(\"stop\").animateRight(-this.getIframeWidth(),\"slow\",$.proxy(function(){this.$previewContainer.hide()},this)),this.draftEditor.off(\"update\",this._updateIframeProxy),Garnish.off(Craft.BaseElementEditor,\"saveElement\",this._updateIframeProxy),Garnish.off(Craft.AssetImageEditor,\"save\",this._updateIframeProxy),this.isActive=!1,this.trigger(\"close\"))},moveFieldsBack:function(){for(var t=0;t<this.fields.length;t++){var e=this.fields[t];e.$newClone=this._getClone(e.$field),this.$fieldPlaceholder.insertAfter(e.$field),e.$field.detach(),this.$fieldPlaceholder.replaceWith(e.$newClone),e.$clone.replaceWith(e.$field)}Garnish.$win.trigger(\"resize\")},getIframeWidth:function(){return Garnish.$win.width()-(this.editorWidthInPx+Craft.Preview.dragHandleWidth)},updateWidths:function(){this.$editorContainer.css(\"width\",this.editorWidthInPx+\"px\"),this.$previewContainer.width(this.getIframeWidth())},updateIframe:function(n){if(!this.isActive)return!1;n=!0===n;var t=this.draftEditor.settings.previewTargets[this.activeTarget].url;this.draftEditor.getTokenizedPreviewUrl(t,\"x-craft-live-preview\").then(function(t){var e;if(n)this.scrollLeft=0,this.scrolllTop=0;else if((e=Craft.isSameHost(t))&&this.$iframe&&this.$iframe[0].contentWindow){var i=$(this.$iframe[0].contentWindow.document);this.scrollLeft=i.scrollLeft(),this.scrollTop=i.scrollTop()}var s=$(\"<iframe/>\",{class:\"lp-preview\",frameborder:0,src:t});!n&&e&&s.on(\"load\",function(){var t=$(s[0].contentWindow.document);t.scrollLeft(this.scrollLeft),t.scrollTop(this.scrollTop)}.bind(this)),this.$iframe?this.$iframe.replaceWith(s):s.appendTo(this.$previewContainer),this.url=t,this.$iframe=s,this.afterUpdateIframe()}.bind(this))},afterUpdateIframe:function(){this.trigger(\"afterUpdateIframe\"),this._slideInOnIframeLoad&&(this.slideIn(),this._slideInOnIframeLoad=!1)},_getClone:function(t){var e=t.clone();return Garnish.copyInputValues(t,e),e.attr(\"id\",\"\"),e.find(\"[id]\").attr(\"id\",\"\"),e.find(\"[name]\").prop(\"disabled\",!0),e},_onDragStart:function(){this.dragStartEditorWidth=this.editorWidthInPx,this.$previewContainer.addClass(\"dragging\")},_onDrag:function(){\"ltr\"===Craft.orientation?this.editorWidth=this.dragStartEditorWidth+this.dragger.mouseDistX:this.editorWidth=this.dragStartEditorWidth-this.dragger.mouseDistX,this.updateWidths()},_onDragStop:function(){this.$previewContainer.removeClass(\"dragging\"),Craft.setLocalStorage(\"LivePreview.editorWidth\",this.editorWidth)}},{defaultEditorWidth:.33,minEditorWidthInPx:320,dragHandleWidth:2}),Craft.PreviewFileModal=Garnish.Modal.extend({assetId:null,$spinner:null,elementSelect:null,type:null,loaded:null,requestId:0,init:function(t,e,i){if((i=$.extend(this.defaultSettings,i)).onHide=this._onHide.bind(this),Craft.PreviewFileModal.openInstance){var s=Craft.PreviewFileModal.openInstance;return s.assetId!==t&&(s.loadAsset(t,i.startingWidth,i.startingHeight),s.elementSelect=e),this.destroy()}(Craft.PreviewFileModal.openInstance=this).elementSelect=e,this.$container=$('<div id=\"previewmodal\" class=\"modal loading\"/>').appendTo(Garnish.$bod),this.base(this.$container,$.extend({resizable:!0},i)),this.$container&&(this.$container.velocity(\"stop\"),this.$container.show().css(\"opacity\",1),this.$shade.velocity(\"stop\"),this.$shade.show().css(\"opacity\",1)),this.loadAsset(t,i.startingWidth,i.startingHeight)},_onHide:function(){return Craft.PreviewFileModal.openInstance=null,this.elementSelect.focusItem(this.elementSelect.$focusedItem),this.$shade.remove(),this.destroy()},selfDestruct:function(){var t=Craft.PreviewFileModal.openInstance;return t.hide(),t.$shade.remove(),t.destroy(),!(Craft.PreviewFileModal.openInstance=null)},loadAsset:function(t,e,i){this.assetId=t,this.$container.empty(),this.loaded=!1,this.desiredHeight=null,this.desiredWidth=null;var n=.66*Garnish.$win.height(),a=Math.min(n/3*4,Garnish.$win.width()-2*this.settings.minGutter);if(n=a/4*3,e&&i){var s=e/i;a=Math.min(e,Garnish.$win.width()-2*this.settings.minGutter),n=Math.min(a/s,Garnish.$win.height()-2*this.settings.minGutter),(a=n*s)>Math.min(e,Garnish.$win.width()-2*this.settings.minGutter)&&(a=Math.min(e,Garnish.$win.width()-2*this.settings.minGutter),n=a/s)}this._resizeContainer(a,n),this.$spinner=$('<div class=\"spinner centeralign\"></div>').appendTo(this.$container);var r=this.$container.height()/2-this.$spinner.height()/2+\"px\",o=this.$container.width()/2-this.$spinner.width()/2+\"px\";this.$spinner.css({left:o,top:r,position:\"absolute\"}),this.requestId++,Craft.postActionRequest(\"assets/preview-file\",{assetId:t,requestId:this.requestId},function(t,e){if(\"success\"===e)if(t.success){if(t.requestId!=this.requestId)return;this.$container.removeClass(\"loading\"),this.$spinner.remove(),this.loaded=!0,this.$container.append(t.modalHtml);var i=this.$container.find(\".highlight\");if(i.length&&i.hasClass(\"json\")){var s=i.find(\"code\");s.html(JSON.stringify(JSON.parse(s.html()),void 0,4))}i.length?Prism.highlightElement(i.find(\"code\").get(0)):this.$container.find(\"img\").css({width:a,height:n}),this.updateSizeAndPosition()}else alert(t.error),this.hide()}.bind(this))},updateSizeAndPosition:function(){if(this.loaded){var t=this.$container.find(\"img\");if(this.loaded&&t.length){var e=t.data(\"maxwidth\"),i=t.data(\"maxheight\"),s=e/i,n=this.desiredWidth?this.desiredWidth:this.$container.width(),a=(this.desiredHeight?this.desiredHeight:this.$container.height(),Math.min(n,e)),r=Math.round(Math.min(i,a/s));a=Math.round(r*s),t.css({width:a,height:r}),this._resizeContainer(a,r),this.desiredWidth=a,this.desiredHeight=r}if(this.base(),this.loaded&&t.length){var o=Math.round(Math.min(Math.max(t.height()*s),Garnish.$win.width()-2*this.settings.minGutter)),l=Math.round(Math.min(Math.max(o/s),Garnish.$win.height()-2*this.settings.minGutter));(o=Math.round(l*s))>Math.min(o,Garnish.$win.width()-2*this.settings.minGutter)&&(l=(o=Math.min(o,Garnish.$win.width()-2*this.settings.minGutter))/s),this._resizeContainer(o,l),t.css({width:o,height:l})}else this.loaded&&this.$container.find(\".highlight\").height(this.$container.height()).width(this.$container.width()).css({overflow:\"auto\"})}},_resizeContainer:function(t,e){this.$container.css({width:t,\"min-width\":t,\"max-width\":t,height:e,\"min-height\":e,\"max-height\":e,top:(Garnish.$win.height()-e)/2,left:(Garnish.$win.width()-t)/2})}},{defaultSettings:{startingWidth:null,startingHeight:null}}),Craft.ProgressBar=Garnish.Base.extend({$progressBar:null,$innerProgressBar:null,$progressBarStatus:null,_itemCount:0,_processedItemCount:0,_displaySteps:!1,init:function(t,e){e&&(this._displaySteps=!0),this.$progressBar=$('<div class=\"progressbar pending hidden\"/>').appendTo(t),this.$innerProgressBar=$('<div class=\"progressbar-inner\"/>').appendTo(this.$progressBar),this.$progressBarStatus=$('<div class=\"progressbar-status hidden\" />').insertAfter(this.$progressBar),this.resetProgressBar()},resetProgressBar:function(){this.setProgressPercentage(100),this.$progressBar.addClass(\"pending\"),this.setItemCount(1),this.setProcessedItemCount(0),this.$progressBarStatus.html(\"\"),this._displaySteps&&this.$progressBar.addClass(\"has-status\")},hideProgressBar:function(){this.$progressBar.fadeTo(\"fast\",.01,$.proxy(function(){this.$progressBar.addClass(\"hidden\").fadeTo(1,1,$.noop)},this))},showProgressBar:function(){this.$progressBar.removeClass(\"hidden\"),this.$progressBarStatus.removeClass(\"hidden\")},setItemCount:function(t){this._itemCount=t},incrementItemCount:function(t){this._itemCount+=t},setProcessedItemCount:function(t){this._processedItemCount=t},incrementProcessedItemCount:function(t){this._processedItemCount+=t},updateProgressBar:function(){this._itemCount=Math.max(this._itemCount,1);var t=Math.min(100,Math.round(100*this._processedItemCount/this._itemCount));this.setProgressPercentage(t),this._displaySteps&&this.$progressBarStatus.html(this._processedItemCount+\" / \"+this._itemCount)},setProgressPercentage:function(t,e){0===t?this.$progressBar.addClass(\"pending\"):(this.$progressBar.removeClass(\"pending\"),e?this.$innerProgressBar.velocity(\"stop\").velocity({width:t+\"%\"},\"fast\"):this.$innerProgressBar.velocity(\"stop\").width(t+\"%\"))}}),Craft.PromptHandler=Garnish.Base.extend({modal:null,$modalContainerDiv:null,$prompt:null,$promptApplyToRemainingContainer:null,$promptApplyToRemainingCheckbox:null,$promptApplyToRemainingLabel:null,$pomptChoices:null,_prompts:[],_promptBatchCallback:$.noop,_promptBatchReturnData:[],_promptBatchNum:0,resetPrompts:function(){this._prompts=[],this._promptBatchCallback=$.noop,this._promptBatchReturnData=[],this._promptBatchNum=0},addPrompt:function(t){this._prompts.push(t)},getPromptCount:function(){return this._prompts.length},showBatchPrompts:function(t){this._promptBatchCallback=t,this._promptBatchReturnData=[],this._promptBatchNum=0,this._showNextPromptInBatch()},_showNextPromptInBatch:function(){var t=this._prompts[this._promptBatchNum].prompt,e=this._prompts.length-(this._promptBatchNum+1);this._showPrompt(t.message,t.choices,$.proxy(this,\"_handleBatchPromptSelection\"),e)},_handleBatchPromptSelection:function(t,e){var i=this._prompts[this._promptBatchNum],s=this._prompts.length-(this._promptBatchNum+1),n=$.extend(i,{choice:t});this._promptBatchReturnData.push(n),s?(this._promptBatchNum++,e?this._handleBatchPromptSelection(t,!0):this._showNextPromptInBatch()):\"function\"==typeof this._promptBatchCallback&&this._promptBatchCallback(this._promptBatchReturnData)},_showPrompt:function(t,e,i,s){this._promptCallback=i,null===this.modal&&(this.modal=new Garnish.Modal({closeOtherModals:!1})),null===this.$modalContainerDiv&&(this.$modalContainerDiv=$('<div class=\"modal fitted prompt-modal\"></div>').addClass().appendTo(Garnish.$bod)),this.$prompt=$('<div class=\"body\"></div>').appendTo(this.$modalContainerDiv.empty()),this.$promptMessage=$('<p class=\"prompt-msg\"/>').appendTo(this.$prompt),this.$promptChoices=$('<div class=\"options\"></div>').appendTo(this.$prompt),this.$promptApplyToRemainingContainer=$('<label class=\"assets-applytoremaining\"/>').appendTo(this.$prompt).hide(),this.$promptApplyToRemainingCheckbox=$('<input type=\"checkbox\"/>').appendTo(this.$promptApplyToRemainingContainer),this.$promptApplyToRemainingLabel=$(\"<span/>\").appendTo(this.$promptApplyToRemainingContainer),this.$promptButtons=$('<div class=\"buttons right\"/>').appendTo(this.$prompt),this.modal.setContainer(this.$modalContainerDiv),this.$promptMessage.html(t);for(var n=$('<div class=\"btn\">'+Craft.t(\"app\",\"Cancel\")+\"</div>\").appendTo(this.$promptButtons),a=$('<input type=\"submit\" class=\"btn submit disabled\" value=\"'+Craft.t(\"app\",\"OK\")+'\" />').appendTo(this.$promptButtons),r=0;r<e.length;r++){var o=$('<div><label><input type=\"radio\" name=\"promptAction\" value=\"'+e[r].value+'\"/> '+e[r].title+\"</label></div>\").appendTo(this.$promptChoices).find(\"input\");this.addListener(o,\"click\",function(){a.removeClass(\"disabled\")})}this.addListener(a,\"activate\",function(t){var e=$(t.currentTarget).parents(\".modal\").find(\"input[name=promptAction]:checked\").val(),i=this.$promptApplyToRemainingCheckbox.prop(\"checked\");this._selectPromptChoice(e,i)}),this.addListener(n,\"activate\",function(){var t=this.$promptApplyToRemainingCheckbox.prop(\"checked\");this._selectPromptChoice(\"cancel\",t)}),s&&(this.$promptApplyToRemainingContainer.show(),this.$promptApplyToRemainingLabel.html(\" \"+Craft.t(\"app\",\"Apply this to the {number} remaining conflicts?\",{number:s}))),this.modal.show(),this.modal.removeListener(Garnish.Modal.$shade,\"click\"),this.addListener(Garnish.Modal.$shade,\"click\",\"_cancelPrompt\")},_selectPromptChoice:function(t,e){this.$prompt.fadeOut(\"fast\",$.proxy(function(){this.modal.hide(),this._promptCallback(t,e)},this))},_cancelPrompt:function(){this._selectPromptChoice(\"cancel\",!0)}}),Craft.SlideRuleInput=Garnish.Base.extend({$container:null,$options:null,$selectedOption:null,$input:null,value:null,startPositionX:null,init:function(t,e){this.setSettings(e,Craft.SlideRuleInput.defaultSettings),this.value=0,this.graduationsMin=-70,this.graduationsMax=70,this.slideMin=-45,this.slideMax=45,this.$container=$(\"#\"+t),this.$overlay=$('<div class=\"overlay\"></div>').appendTo(this.$container),this.$cursor=$('<div class=\"cursor\"></div>').appendTo(this.$container),this.$graduations=$('<div class=\"graduations\"></div>').appendTo(this.$container),this.$graduationsUl=$(\"<ul></ul>\").appendTo(this.$graduations);for(var i=this.graduationsMin;i<=this.graduationsMax;i++){var s=$('<li class=\"graduation\" data-graduation=\"'+i+'\"><div class=\"label\">'+i+\"</div></li>\").appendTo(this.$graduationsUl);i%5==0&&s.addClass(\"main-graduation\"),0===i&&s.addClass(\"selected\")}this.$options=this.$container.find(\".graduation\"),this.addListener(this.$container,\"resize\",$.proxy(this,\"_handleResize\")),this.addListener(this.$container,\"tapstart\",$.proxy(this,\"_handleTapStart\")),this.addListener(Garnish.$bod,\"tapmove\",$.proxy(this,\"_handleTapMove\")),this.addListener(Garnish.$bod,\"tapend\",$.proxy(this,\"_handleTapEnd\")),setTimeout($.proxy(function(){this.graduationsCalculatedWidth=10*(this.$options.length-1),this.$graduationsUl.css(\"left\",-this.graduationsCalculatedWidth/2+this.$container.width()/2)},this),50)},_handleResize:function(){var t=this.valueToPosition(this.value);this.$graduationsUl.css(\"left\",t)},_handleTapStart:function(t,e){t.preventDefault(),this.startPositionX=e.position.x,this.startLeft=this.$graduationsUl.position().left,this.dragging=!0,this.onStart()},_handleTapMove:function(t,e){if(this.dragging){t.preventDefault();var i=this.startPositionX-e.position.x,s=this.startLeft-i,n=this.positionToValue(s);this.setValue(n),this.onChange()}},setValue:function(i){var t=this.valueToPosition(i);i<this.slideMin?(i=this.slideMin,t=this.valueToPosition(i)):i>this.slideMax&&(i=this.slideMax,t=this.valueToPosition(i)),this.$graduationsUl.css(\"left\",t),i>=this.slideMin&&i<=this.slideMax&&(this.$options.removeClass(\"selected\"),$.each(this.$options,function(t,e){0<$(e).data(\"graduation\")&&$(e).data(\"graduation\")<=i&&$(e).addClass(\"selected\"),$(e).data(\"graduation\")<0&&$(e).data(\"graduation\")>=i&&$(e).addClass(\"selected\"),0==$(e).data(\"graduation\")&&$(e).addClass(\"selected\")})),this.value=i},_handleTapEnd:function(t){this.dragging&&(t.preventDefault(),this.dragging=!1,this.onEnd())},positionToValue:function(t){var e=-1*this.graduationsMin,i=-1*(this.graduationsMin-this.graduationsMax);return(this.$graduations.width()/2+-1*t)/this.graduationsCalculatedWidth*i-e},valueToPosition:function(t){var e=-1*this.graduationsMin,i=-1*(this.graduationsMin-this.graduationsMax);return-((t+e)*this.graduationsCalculatedWidth/i-this.$graduations.width()/2)},onStart:function(){\"function\"==typeof this.settings.onChange&&this.settings.onStart(this)},onChange:function(){\"function\"==typeof this.settings.onChange&&this.settings.onChange(this)},onEnd:function(){\"function\"==typeof this.settings.onChange&&this.settings.onEnd(this)},defaultSettings:{onStart:$.noop,onChange:$.noop,onEnd:$.noop}}),Craft.SlugGenerator=Craft.BaseInputGenerator.extend({generateTargetValue:function(t){t=(t=t.replace(/<(.*?)>/g,\"\")).replace(/['\"\u2018\u2019\u201c\u201d\\[\\]\\(\\)\\{\\}:]/g,\"\"),Craft.allowUppercaseInSlug||(t=t.toLowerCase()),Craft.limitAutoSlugsToAscii&&(t=Craft.asciiString(t,this.settings.charMap));var e=Craft.filterArray(XRegExp.matchChain(t,[XRegExp(\"[\\\\p{L}\\\\p{N}\\\\p{M}]+\")]));return e.length?e.join(Craft.slugWordSeparator):\"\"}}),Craft.Structure=Garnish.Base.extend({id:null,$container:null,state:null,structureDrag:null,init:function(t,e,i){this.id=t,this.$container=$(e),this.setSettings(i,Craft.Structure.defaults),this.$container.data(\"structure\")&&(Garnish.log(\"Double-instantiating a structure on an element\"),this.$container.data(\"structure\").destroy()),this.$container.data(\"structure\",this),this.state={},this.settings.storageKey&&$.extend(this.state,Craft.getLocalStorage(this.settings.storageKey,{})),void 0===this.state.collapsedElementIds&&(this.state.collapsedElementIds=[]);for(var s=this.$container.find(\"ul\").prev(\".row\"),n=0;n<s.length;n++){var a=$(s[n]),r=a.parent(),o=$('<div class=\"toggle\" title=\"'+Craft.t(\"app\",\"Show/hide children\")+'\"/>').prependTo(a);-1!==$.inArray(a.children(\".element\").data(\"id\"),this.state.collapsedElementIds)&&r.addClass(\"collapsed\"),this.initToggle(o)}this.settings.sortable&&(this.structureDrag=new Craft.StructureDrag(this,this.settings.maxLevels)),this.settings.newChildUrl&&this.initNewChildMenus(this.$container.find(\".add\"))},initToggle:function(t){t.on(\"click\",$.proxy(function(t){var e=$(t.currentTarget).closest(\"li\"),i=e.children(\".row\").find(\".element:first\").data(\"id\"),s=$.inArray(i,this.state.collapsedElementIds);e.hasClass(\"collapsed\")?(e.removeClass(\"collapsed\"),-1!==s&&this.state.collapsedElementIds.splice(s,1)):(e.addClass(\"collapsed\"),-1===s&&this.state.collapsedElementIds.push(i)),this.settings.storageKey&&Craft.setLocalStorage(this.settings.storageKey,this.state)},this))},initNewChildMenus:function(t){this.addListener(t,\"click\",\"onNewChildMenuClick\")},onNewChildMenuClick:function(t){var e=$(t.currentTarget);if(!e.data(\"menubtn\")){var i=e.parent().children(\".element\").data(\"id\"),s=Craft.getUrl(this.settings.newChildUrl,\"parentId=\"+i);$('<div class=\"menu\"><ul><li><a href=\"'+s+'\">'+Craft.t(\"app\",\"New child\")+\"</a></li></ul></div>\").insertAfter(e),new Garnish.MenuBtn(e).showMenu()}},getIndent:function(t){return Craft.Structure.baseIndent+(t-1)*Craft.Structure.nestedIndent},addElement:function(t){var e=$('<li data-level=\"1\"/>').appendTo(this.$container),i=$('<div class=\"row\" style=\"margin-'+Craft.left+\": -\"+Craft.Structure.baseIndent+\"px; padding-\"+Craft.left+\": \"+Craft.Structure.baseIndent+'px;\">').appendTo(e);if(i.append(t),this.settings.sortable&&(i.append('<a class=\"move icon\" title=\"'+Craft.t(\"app\",\"Move\")+'\"></a>'),this.structureDrag.addItems(e)),this.settings.newChildUrl){var s=$('<a class=\"add icon\" title=\"'+Craft.t(\"app\",\"New child\")+'\"></a>').appendTo(i);this.initNewChildMenus(s)}i.css(\"margin-bottom\",-30),i.velocity({\"margin-bottom\":0},\"fast\")},removeElement:function(t){var e,i=t.parent().parent();this.settings.sortable&&this.structureDrag.removeItems(i),i.siblings().length||(e=i.parent()),i.css(\"visibility\",\"hidden\").velocity({marginBottom:-i.height()},\"fast\",$.proxy(function(){i.remove(),void 0!==e&&this._removeUl(e)},this))},_removeUl:function(t){t.siblings(\".row\").children(\".toggle\").remove(),t.remove()}},{baseIndent:8,nestedIndent:35,defaults:{storageKey:null,sortable:!1,newChildUrl:null,maxLevels:null}}),Craft.StructureDrag=Garnish.Drag.extend({structure:null,maxLevels:null,draggeeLevel:null,$helperLi:null,$targets:null,draggeeHeight:null,init:function(t,e){this.structure=t,this.maxLevels=e,this.$insertion=$('<li class=\"draginsertion\"/>');var i=this.structure.$container.find(\"li\");this.base(i,{handle:\".element:first, .move:first\",helper:$.proxy(this,\"getHelper\")})},getHelper:function(t){this.$helperLi=t;var e=$('<ul class=\"structure draghelper\"/>').append(t);return t.css(\"padding-\"+Craft.left,this.$draggee.css(\"padding-\"+Craft.left)),t.find(\".move\").removeAttr(\"title\"),e},onDragStart:function(){this.$targets=$(),this.findTargets(this.structure.$container),this.draggeeLevel=0;for(var t=this.$draggee;this.draggeeLevel++,(t=t.find(\"> ul > li\")).length;);this.draggeeHeight=this.$draggee.height(),this.$draggee.velocity({height:0},\"fast\",$.proxy(function(){this.$draggee.addClass(\"hidden\")},this)),this.base(),this.addListener(Garnish.$doc,\"keydown\",function(t){t.keyCode===Garnish.ESC_KEY&&this.cancelDrag()})},findTargets:function(t){for(var e=t.children().not(this.$draggee),i=0;i<e.length;i++){var s=$(e[i]);this.$targets=this.$targets.add(s.children(\".row\")),s.hasClass(\"collapsed\")||this.findTargets(s.children(\"ul\"))}},onDrag:function(){for(this._.$closestTarget&&(this._.$closestTarget.removeClass(\"draghover\"),this.$insertion.remove()),this._.$closestTarget=null,this._.closestTargetPos=null,this._.closestTargetYDiff=null,this._.closestTargetOffset=null,this._.closestTargetHeight=null,this._.i=0;this._.i<this.$targets.length&&(this._.$target=$(this.$targets[this._.i]),this._.targetOffset=this._.$target.offset(),this._.targetHeight=this._.$target.outerHeight(),this._.targetYMidpoint=this._.targetOffset.top+this._.targetHeight/2,this._.targetYDiff=Math.abs(this.mouseY-this._.targetYMidpoint),0===this._.i||this.mouseY>=this._.targetOffset.top+5&&this._.targetYDiff<this._.closestTargetYDiff);this._.i++)this._.$closestTarget=this._.$target,this._.closestTargetPos=this._.i,this._.closestTargetYDiff=this._.targetYDiff,this._.closestTargetOffset=this._.targetOffset,this._.closestTargetHeight=this._.targetHeight;if(this._.$closestTarget)if(0===this._.closestTargetPos&&this.mouseY<this._.closestTargetOffset.top+5)this.$insertion.prependTo(this.structure.$container);else if(this._.$closestTargetLi=this._.$closestTarget.parent(),this._.closestTargetLevel=this._.$closestTargetLi.data(\"level\"),this._.closestTargetPos<this.$targets.length-1?(this._.$nextTargetLi=$(this.$targets[this._.closestTargetPos+1]).parent(),this._.nextTargetLevel=this._.$nextTargetLi.data(\"level\")):(this._.$nextTargetLi=null,this._.nextTargetLevel=null),this._.hoveringBetweenRows=this.mouseY>=this._.closestTargetOffset.top+this._.closestTargetHeight-5,this._.$nextTargetLi&&this._.nextTargetLevel==this._.closestTargetLevel)this._.hoveringBetweenRows?(!this.maxLevels||this.maxLevels>=this._.closestTargetLevel+this.draggeeLevel-1)&&this.$insertion.insertAfter(this._.$closestTargetLi):(!this.maxLevels||this.maxLevels>=this._.closestTargetLevel+this.draggeeLevel)&&this._.$closestTarget.addClass(\"draghover\");else if(this._.$nextTargetLi&&this._.nextTargetLevel>this._.closestTargetLevel)(!this.maxLevels||this.maxLevels>=this._.nextTargetLevel+this.draggeeLevel-1)&&(this._.hoveringBetweenRows?this.$insertion.insertBefore(this._.$nextTargetLi):(this._.$closestTarget.addClass(\"draghover\"),this.$insertion.appendTo(this._.$closestTargetLi.children(\"ul\"))));else if(this._.hoveringBetweenRows){for(this._.draggeeX=this.mouseX-this.targetItemMouseDiffX,\"rtl\"===Craft.orientation&&(this._.draggeeX+=this.$helperLi.width()),this._.$parentLis=this._.$closestTarget.parentsUntil(this.structure.$container,\"li\"),this._.$closestParentLi=null,this._.closestParentLiXDiff=null,this._.closestParentLevel=null,this._.i=0;this._.i<this._.$parentLis.length;this._.i++)this._.$parentLi=$(this._.$parentLis[this._.i]),this._.parentLiX=this._.$parentLi.offset().left,\"rtl\"===Craft.orientation&&(this._.parentLiX+=this._.$parentLi.width()),this._.parentLiXDiff=Math.abs(this._.parentLiX-this._.draggeeX),this._.parentLevel=this._.$parentLi.data(\"level\"),(!this.maxLevels||this.maxLevels>=this._.parentLevel+this.draggeeLevel-1)&&(!this._.$closestParentLi||this._.parentLiXDiff<this._.closestParentLiXDiff&&(!this._.$nextTargetLi||this._.parentLevel>=this._.nextTargetLevel))&&(this._.$closestParentLi=this._.$parentLi,this._.closestParentLiXDiff=this._.parentLiXDiff,this._.closestParentLevel=this._.parentLevel);this._.$closestParentLi&&this.$insertion.insertAfter(this._.$closestParentLi)}else(!this.maxLevels||this.maxLevels>=this._.closestTargetLevel+this.draggeeLevel)&&this._.$closestTarget.addClass(\"draghover\")},cancelDrag:function(){this.$insertion.remove(),this._.$closestTarget&&this._.$closestTarget.removeClass(\"draghover\"),this.onMouseUp()},onDragStop:function(){if(this._.$closestTarget&&(this.$insertion.parent().length||this._.$closestTarget.hasClass(\"draghover\"))){var t,e;if(this.$draggee.siblings().length||(t=this.$draggee.parent()),this.$insertion.parent().length){var i=this.$insertion.next().add(this.$insertion.prev());e=-1===$.inArray(this.$draggee[0],i)?(this.$insertion.replaceWith(this.$draggee),!0):(this.$insertion.remove(),!1)}else{var s=this._.$closestTargetLi.children(\"ul\");if(t&&s.length&&s[0]===t[0])e=!1;else{if(s.length)this._.$closestTargetLi.hasClass(\"collapsed\")&&this._.$closestTarget.children(\".toggle\").trigger(\"click\");else{var n=$('<div class=\"toggle\" title=\"'+Craft.t(\"app\",\"Show/hide children\")+'\"/>').prependTo(this._.$closestTarget);this.structure.initToggle(n),s=$(\"<ul>\").appendTo(this._.$closestTargetLi)}this.$draggee.appendTo(s),e=!0}}if(this._.$closestTarget.removeClass(\"draghover\"),e){t&&this.structure._removeUl(t);var a,r=this.$draggee.parentsUntil(this.structure.$container,\"li\").length+1;r!=this.$draggee.data(\"level\")&&(1==this.$draggee.data(\"level\")?((a={})[\"padding-\"+Craft.left]=38,this.$helperLi.velocity(a,\"fast\")):1==r&&((a={})[\"padding-\"+Craft.left]=Craft.Structure.baseIndent,this.$helperLi.velocity(a,\"fast\")),this.setLevel(this.$draggee,r));var o=this.$draggee.children(\".row\").children(\".element\"),l={structureId:this.structure.id,elementId:o.data(\"id\"),siteId:o.data(\"site-id\"),prevId:this.$draggee.prev().children(\".row\").children(\".element\").data(\"id\"),parentId:this.$draggee.parent(\"ul\").parent(\"li\").children(\".row\").children(\".element\").data(\"id\")};Craft.postActionRequest(\"structures/move-element\",l,function(t,e){\"success\"===e&&Craft.cp.displayNotice(Craft.t(\"app\",\"New order saved.\"))})}}this.$draggee.velocity(\"stop\").removeClass(\"hidden\").velocity({height:this.draggeeHeight},\"fast\",$.proxy(function(){this.$draggee.css(\"height\",\"auto\")},this)),this.returnHelpersToDraggees(),this.base()},setLevel:function(t,e){t.data(\"level\",e);var i=this.structure.getIndent(e),s={};s[\"margin-\"+Craft.left]=\"-\"+i+\"px\",s[\"padding-\"+Craft.left]=i+\"px\",this.$draggee.children(\".row\").css(s);for(var n=t.children(\"ul\").children(),a=0;a<n.length;a++)this.setLevel($(n[a]),e+1)}}),Craft.StructureTableSorter=Garnish.DragSort.extend({tableView:null,structureId:null,maxLevels:null,_helperMargin:null,_$firstRowCells:null,_$titleHelperCell:null,_titleHelperCellOuterWidth:null,_ancestors:null,_updateAncestorsFrame:null,_updateAncestorsProxy:null,_draggeeLevel:null,_draggeeLevelDelta:null,draggingLastElements:null,_loadingDraggeeLevelDelta:!1,_targetLevel:null,_targetLevelBounds:null,_positionChanged:null,init:function(t,e,i){this.tableView=t,this.structureId=this.tableView.$table.data(\"structure-id\"),this.maxLevels=parseInt(this.tableView.$table.attr(\"data-max-levels\")),i=$.extend({},Craft.StructureTableSorter.defaults,i,{handle:\".move\",collapseDraggees:!0,singleHelper:!0,helperSpacingY:2,magnetStrength:4,helper:$.proxy(this,\"getHelper\"),helperLagBase:1.5,axis:Garnish.Y_AXIS}),this.base(e,i)},startDragging:function(){this._helperMargin=Craft.StructureTableSorter.HELPER_MARGIN+(this.tableView.elementIndex.actions?24:0),this.base()},findDraggee:function(){this._draggeeLevel=this._targetLevel=this.$targetItem.data(\"level\"),this._draggeeLevelDelta=0;for(var t=$(this.$targetItem),e=this.$targetItem.next();e.length;){var i=e.data(\"level\");if(i<=this._draggeeLevel)break;var s=i-this._draggeeLevel;s>this._draggeeLevelDelta&&(this._draggeeLevelDelta=s),t=t.add(e),e=e.next()}if(this.draggingLastElements=!e.length,this.maxLevels&&this.draggingLastElements&&this.tableView.getMorePending()){this._loadingDraggeeLevelDelta=!0;var n=this._getAjaxBaseData(this.$targetItem);Craft.postActionRequest(\"structures/get-element-level-delta\",n,$.proxy(function(t,e){\"success\"===e&&(this._loadingDraggeeLevelDelta=!1,this.dragging&&(this._draggeeLevelDelta=t.delta,this.drag(!1)))},this))}return t},getHelper:function(t){var e=$('<div class=\"elements datatablesorthelper\"/>').appendTo(Garnish.$bod),i=$('<div class=\"tableview\"/>').appendTo(e),s=$('<table class=\"data\"/>').appendTo(i),n=$(\"<tbody/>\").appendTo(s);t.appendTo(n),this._$firstRowCells=this.tableView.$elementContainer.children(\"tr:first\").children();for(var a=t.children(),r=0;r<a.length;r++){var o=$(a[r]);if(o.hasClass(\"checkbox-cell\"))o.remove();else{var l=$(this._$firstRowCells[r]),h=l.width();if(l.width(h),o.width(h),Garnish.hasAttr(l,\"data-titlecell\")){this._$titleHelperCell=o;var d=parseInt(l.css(\"padding-\"+Craft.left));this._titleHelperCellOuterWidth=h+d-(this.tableView.elementIndex.actions?12:0),o.css(\"padding-\"+Craft.left,Craft.StructureTableSorter.BASE_PADDING)}}}return e},canInsertBefore:function(t){return!this._loadingDraggeeLevelDelta&&!1!==this._getLevelBounds(t.prev(),t)},canInsertAfter:function(t){return!this._loadingDraggeeLevelDelta&&!1!==this._getLevelBounds(t,t.next())},onDragStart:function(){this._ancestors=this._getAncestors(this.$targetItem,this.$targetItem.data(\"level\")),this._setTargetLevelBounds(),this.tableView.maybeLoadMore(),this.base()},onDrag:function(){this.base(),this._updateIndent()},onInsertionPointChange:function(){this._setTargetLevelBounds(),this._updateAncestorsBeforeRepaint(),this.base()},onDragStop:function(){if(this._positionChanged=!1,this.base(),this._targetLevel!=this._draggeeLevel){for(var t=this._targetLevel-this._draggeeLevel,e=0;e<this.$draggee.length;e++){var i=$(this.$draggee[e]),s=i.data(\"level\")+t,n=Craft.StructureTableSorter.BASE_PADDING+(this.tableView.elementIndex.actions?7:0)+this._getLevelIndent(s);i.data(\"level\",s),i.find(\".element\").data(\"level\",s),i.children(\"[data-titlecell]:first\").css(\"padding-\"+Craft.left,n)}this._positionChanged=!0}if(this._positionChanged){for(var a=this._getAjaxBaseData(this.$draggee),r=this.$draggee.first().prev();r.length;){var o=r.data(\"level\");if(o==this._targetLevel){a.prevId=r.data(\"id\");break}if(o<this._targetLevel){a.parentId=r.data(\"id\");var l=r.find(\"> td > .toggle\");if(!l.hasClass(\"expanded\")){l.addClass(\"expanded\");var h=this.tableView._createSpinnerRowAfter(r);this.tableView.elementSelect&&this.tableView.elementSelect.removeItems(this.$targetItem),this.removeItems(this.$targetItem),this.$targetItem.remove(),this.tableView._totalVisible--}break}r=r.prev()}Craft.postActionRequest(\"structures/move-element\",a,$.proxy(function(t,e){if(\"success\"===e){if(!t.success)return Craft.cp.displayError(Craft.t(\"app\",\"An unknown error occurred.\")),void this.tableView.elementIndex.updateElements();Craft.cp.displayNotice(Craft.t(\"app\",\"New position saved.\")),this.onPositionChange(),h&&h.parent().length&&(h.remove(),this.tableView._expandElement(l,!0)),Craft.cp.runQueue()}},this))}},onSortChange:function(){this.tableView.elementSelect&&this.tableView.elementSelect.resetItemOrder(),this._positionChanged=!0,this.base()},onPositionChange:function(){Garnish.requestAnimationFrame($.proxy(function(){this.trigger(\"positionChange\"),this.settings.onPositionChange()},this))},onReturnHelpersToDraggees:function(){if(this._$firstRowCells.css(\"width\",\"\"),this.draggingLastElements&&this.tableView.getMorePending()){this.tableView._totalVisible+=this.newDraggeeIndexes[0]-this.oldDraggeeIndexes[0];var t=this.$draggee.last().nextAll();t.length&&(this.removeItems(t),t.remove(),this.tableView.maybeLoadMore())}this.base()},_getLevelBounds:function(t,e){if(e&&e.length?this._getLevelBounds._minLevel=e.data(\"level\"):this._getLevelBounds._minLevel=1,t&&t.length?this._getLevelBounds._maxLevel=t.data(\"level\")+1:this._getLevelBounds._maxLevel=1,this.maxLevels){if(1!=this._getLevelBounds._minLevel&&this._getLevelBounds._minLevel+this._draggeeLevelDelta>this.maxLevels)return!1;this._getLevelBounds._maxLevel+this._draggeeLevelDelta>this.maxLevels&&(this._getLevelBounds._maxLevel=this.maxLevels-this._draggeeLevelDelta,this._getLevelBounds._maxLevel<this._getLevelBounds._minLevel&&(this._getLevelBounds._maxLevel=this._getLevelBounds._minLevel))}return{min:this._getLevelBounds._minLevel,max:this._getLevelBounds._maxLevel}},_setTargetLevelBounds:function(){this._targetLevelBounds=this._getLevelBounds(this.$draggee.first().prev(),this.$draggee.last().next())},_updateIndent:function(t){this._updateIndent._mouseDist=this.realMouseX-this.mousedownX,\"rtl\"===Craft.orientation&&(this._updateIndent._mouseDist*=-1),this._updateIndent._indentationDist=Math.round(this._updateIndent._mouseDist/Craft.StructureTableSorter.LEVEL_INDENT),this._updateIndent._targetLevel=this._draggeeLevel+this._updateIndent._indentationDist,this._updateIndent._targetLevel<this._targetLevelBounds.min?(this._updateIndent._indentationDist+=this._targetLevelBounds.min-this._updateIndent._targetLevel,this._updateIndent._targetLevel=this._targetLevelBounds.min):this._updateIndent._targetLevel>this._targetLevelBounds.max&&(this._updateIndent._indentationDist-=this._updateIndent._targetLevel-this._targetLevelBounds.max,this._updateIndent._targetLevel=this._targetLevelBounds.max),this._targetLevel!==(this._targetLevel=this._updateIndent._targetLevel)&&this._updateAncestorsBeforeRepaint(),this._updateIndent._targetLevelMouseDiff=this._updateIndent._mouseDist-this._updateIndent._indentationDist*Craft.StructureTableSorter.LEVEL_INDENT,this._updateIndent._magnetImpact=Math.round(this._updateIndent._targetLevelMouseDiff/15),Math.abs(this._updateIndent._magnetImpact)>Craft.StructureTableSorter.MAX_GIVE&&(this._updateIndent._magnetImpact=(0<this._updateIndent._magnetImpact?1:-1)*Craft.StructureTableSorter.MAX_GIVE),this._updateIndent._closestLevelMagnetIndent=this._getLevelIndent(this._targetLevel)+this._updateIndent._magnetImpact,this.helpers[0].css(\"margin-\"+Craft.left,this._updateIndent._closestLevelMagnetIndent+this._helperMargin),this._$titleHelperCell.width(this._titleHelperCellOuterWidth-(this._updateIndent._closestLevelMagnetIndent+Craft.StructureTableSorter.BASE_PADDING))},_getLevelIndent:function(t){return(t-1)*Craft.StructureTableSorter.LEVEL_INDENT},_getAjaxBaseData:function(t){return{structureId:this.structureId,elementId:t.data(\"id\"),siteId:t.find(\".element:first\").data(\"site-id\")}},_getAncestors:function(t,e){if(this._getAncestors._ancestors=[],0!=e)for(this._getAncestors._level=e,this._getAncestors._$prevRow=t.prev();this._getAncestors._$prevRow.length&&!(this._getAncestors._$prevRow.data(\"level\")<this._getAncestors._level&&(this._getAncestors._ancestors.unshift(this._getAncestors._$prevRow),this._getAncestors._level=this._getAncestors._$prevRow.data(\"level\"),0==this._getAncestors._level));)this._getAncestors._$prevRow=this._getAncestors._$prevRow.prev();return this._getAncestors._ancestors},_updateAncestorsBeforeRepaint:function(){this._updateAncestorsFrame&&Garnish.cancelAnimationFrame(this._updateAncestorsFrame),this._updateAncestorsProxy||(this._updateAncestorsProxy=$.proxy(this,\"_updateAncestors\")),this._updateAncestorsFrame=Garnish.requestAnimationFrame(this._updateAncestorsProxy)},_updateAncestors:function(){for(this._updateAncestorsFrame=null,this._updateAncestors._i=0;this._updateAncestors._i<this._ancestors.length;this._updateAncestors._i++)this._updateAncestors._$ancestor=this._ancestors[this._updateAncestors._i],this._updateAncestors._$ancestor.data(\"descendants\",this._updateAncestors._$ancestor.data(\"descendants\")-1),0==this._updateAncestors._$ancestor.data(\"descendants\")&&this._updateAncestors._$ancestor.find(\"> td > .toggle:first\").remove();for(this._updateAncestors._newAncestors=this._getAncestors(this.$targetItem,this._targetLevel),this._updateAncestors._i=0;this._updateAncestors._i<this._updateAncestors._newAncestors.length;this._updateAncestors._i++)this._updateAncestors._$ancestor=this._updateAncestors._newAncestors[this._updateAncestors._i],this._updateAncestors._$ancestor.data(\"descendants\",this._updateAncestors._$ancestor.data(\"descendants\")+1),1==this._updateAncestors._$ancestor.data(\"descendants\")&&$('<span class=\"toggle expanded\" title=\"'+Craft.t(\"app\",\"Show/hide children\")+'\"></span>').insertAfter(this._updateAncestors._$ancestor.find(\"> td .move:first\"));this._ancestors=this._updateAncestors._newAncestors,delete this._updateAncestors._i,delete this._updateAncestors._$ancestor,delete this._updateAncestors._newAncestors}},{BASE_PADDING:36,HELPER_MARGIN:-7,LEVEL_INDENT:44,MAX_GIVE:22,defaults:{onPositionChange:$.noop}}),Craft.TableElementIndexView=Craft.BaseElementIndexView.extend({$table:null,$selectedSortHeader:null,structureTableSort:null,_totalVisiblePostStructureTableDraggee:null,_morePendingPostStructureTableDraggee:!1,getElementContainer:function(){return this.$table=this.$container.find(\"table:first\"),this.$table.children(\"tbody:first\")},afterInit:function(){Craft.cp.$collapsibleTables=Craft.cp.$collapsibleTables.add(this.$table),Craft.cp.updateResponsiveTables(),this.initTableHeaders(),\"index\"===this.elementIndex.settings.context&&\"structure\"===this.elementIndex.getSelectedSortAttribute()&&Garnish.hasAttr(this.$table,\"data-structure-id\")?this.structureTableSort=new Craft.StructureTableSorter(this,this.getAllElements(),{onSortChange:$.proxy(this,\"_onStructureTableSortChange\")}):this.structureTableSort=null,\"structure\"===this.elementIndex.getSelectedSortAttribute()&&this.addListener(this.$elementContainer,\"click\",function(t){var e=$(t.target);!e.hasClass(\"toggle\")||!1===this._collapseElement(e)&&this._expandElement(e)})},initTableHeaders:function(){for(var t=this.elementIndex.getSelectedSortAttribute(),e=this.$table.children(\"thead\").children().children(\"[data-attribute]\"),i=0;i<e.length;i++){var s=e.eq(i),n=s.attr(\"data-attribute\");if(n===t){this.$selectedSortHeader=s;var a=this.elementIndex.getSelectedSortDirection();s.addClass(\"ordered \"+a).on(\"click\",$.proxy(this,\"_handleSelectedSortHeaderClick\"))}else{this.elementIndex.getSortAttributeOption(n).length&&s.addClass(\"orderable\").on(\"click\",$.proxy(this,\"_handleUnselectedSortHeaderClick\"))}}},isVerticalList:function(){return!0},getTotalVisible:function(){return this._isStructureTableDraggingLastElements()?this._totalVisiblePostStructureTableDraggee:this._totalVisible},setTotalVisible:function(t){this._isStructureTableDraggingLastElements()?this._totalVisiblePostStructureTableDraggee=t:this._totalVisible=t},getMorePending:function(){return this._isStructureTableDraggingLastElements()?this._morePendingPostStructureTableDraggee:this._morePending},setMorePending:function(t){this._isStructureTableDraggingLastElements()?this._morePendingPostStructureTableDraggee=t:this._morePending=this._morePendingPostStructureTableDraggee=t},getLoadMoreParams:function(){var t=this.base();return this._isStructureTableDraggingLastElements()&&(t.criteria.positionedAfter=this.structureTableSort.$targetItem.data(\"id\")),t},appendElements:function(t){this.base(t),this.structureTableSort&&this.structureTableSort.addItems(t),Craft.cp.updateResponsiveTables()},destroy:function(){this.$table&&(Craft.cp.$collapsibleTables=Craft.cp.$collapsibleTables.not(this.$table)),this.base()},createElementEditor:function(e){Craft.createElementEditor(e.data(\"type\"),e,{params:{includeTableAttributesForSource:this.elementIndex.sourceKey},onSaveElement:$.proxy(function(t){t.tableAttributes&&this._updateTableAttributes(e,t.tableAttributes)},this),elementIndex:this.elementIndex})},_collapseElement:function(t,e){if(!e&&!t.hasClass(\"expanded\"))return!1;t.removeClass(\"expanded\");for(var i=t.parent().parent(),s=i.data(\"id\"),n=i.data(\"level\"),a=i.next();a.length;){if(!Garnish.hasAttr(a,\"data-spinnerrow\")){if(a.data(\"level\")<=n)break;this.elementSelect&&this.elementSelect.removeItems(a),this.structureTableSort&&this.structureTableSort.removeItems(a),this._totalVisible--}var r=a.next();a.remove(),a=r}this.elementIndex.instanceState.collapsedElementIds||(this.elementIndex.instanceState.collapsedElementIds=[]),this.elementIndex.instanceState.collapsedElementIds.push(s),this.elementIndex.setInstanceState(\"collapsedElementIds\",this.elementIndex.instanceState.collapsedElementIds),this.maybeLoadMore()},_expandElement:function(t,e){if(!e&&t.hasClass(\"expanded\"))return!1;if(t.addClass(\"expanded\"),this.elementIndex.instanceState.collapsedElementIds){var i=t.parent().parent(),s=i.data(\"id\"),n=$.inArray(s,this.elementIndex.instanceState.collapsedElementIds);if(-1!==n){this.elementIndex.instanceState.collapsedElementIds.splice(n,1),this.elementIndex.setInstanceState(\"collapsedElementIds\",this.elementIndex.instanceState.collapsedElementIds);var r=this._createSpinnerRowAfter(i),a=$.extend(!0,{},this.settings.params);a.criteria.descendantOf=s,Craft.postActionRequest(\"element-indexes/get-more-elements\",a,$.proxy(function(t,e){if(r.parent().length&&\"success\"===e){var i=$(t.html),s=this._totalVisible+i.length,n=this.settings.batchSize&&i.length===this.settings.batchSize;if(n){var a=r.nextAll();this.elementSelect&&this.elementSelect.removeItems(a),this.structureTableSort&&this.structureTableSort.removeItems(a),a.remove(),s-=a.length}else n=this._morePending;r.replaceWith(i),this.thumbLoader.load(i),(this.elementIndex.actions||this.settings.selectable)&&(this.elementSelect.addItems(i.filter(\":not(.disabled)\")),this.elementIndex.updateActionTriggers()),this.structureTableSort&&this.structureTableSort.addItems(i),Craft.appendHeadHtml(t.headHtml),Craft.appendFootHtml(t.footHtml),Craft.cp.updateResponsiveTables(),this.setTotalVisible(s),this.setMorePending(n),this.maybeLoadMore()}},this))}}},_createSpinnerRowAfter:function(t){return $('<tr data-spinnerrow><td class=\"centeralign\" colspan=\"'+t.children().length+'\"><div class=\"spinner\"/></td></tr>').insertAfter(t)},_isStructureTableDraggingLastElements:function(){return this.structureTableSort&&this.structureTableSort.dragging&&this.structureTableSort.draggingLastElements},_handleSelectedSortHeaderClick:function(t){var e=$(t.currentTarget);if(!e.hasClass(\"loading\")){var i=\"asc\"===this.elementIndex.getSelectedSortDirection()?\"desc\":\"asc\";this.elementIndex.setSortDirection(i),this._handleSortHeaderClick(t,e)}},_handleUnselectedSortHeaderClick:function(t){var e=$(t.currentTarget);if(!e.hasClass(\"loading\")){var i=e.attr(\"data-attribute\");this.elementIndex.setSortAttribute(i),this._handleSortHeaderClick(t,e)}},_handleSortHeaderClick:function(t,e){this.$selectedSortHeader&&this.$selectedSortHeader.removeClass(\"ordered asc desc\"),e.removeClass(\"orderable\").addClass(\"ordered loading\"),this.elementIndex.storeSortAttributeAndDirection(),this.elementIndex.updateElements(),this.elementIndex.setIndexAvailable()},_updateTableAttributes:function(t,e){var i=t.closest(\"tr\");for(var s in e)e.hasOwnProperty(s)&&i.children('td[data-attr=\"'+s+'\"]:first').html(e[s])}}),Craft.TagSelectInput=Craft.BaseElementSelectInput.extend({searchTimeout:null,searchMenu:null,$container:null,$elementsContainer:null,$elements:null,$addTagInput:null,$spinner:null,_ignoreBlur:!1,init:function(t){if(!$.isPlainObject(t)){for(var e={},i=[\"id\",\"name\",\"tagGroupId\",\"sourceElementId\"],s=0;s<i.length&&void 0!==arguments[s];s++)e[i[s]]=arguments[s];t=e}this.base($.extend({},Craft.TagSelectInput.defaults,t)),this.$addTagInput=this.$container.children(\".add\").children(\".text\"),this.$spinner=this.$addTagInput.next(),this.addListener(this.$addTagInput,\"textchange\",$.proxy(function(){this.searchTimeout&&clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout($.proxy(this,\"searchForTags\"),500)},this)),this.addListener(this.$addTagInput,\"keypress\",function(t){t.keyCode===Garnish.RETURN_KEY&&(t.preventDefault(),this.searchMenu&&this.selectTag(this.searchMenu.$options[0]))}),this.addListener(this.$addTagInput,\"focus\",function(){this.searchMenu&&this.searchMenu.show()}),this.addListener(this.$addTagInput,\"blur\",function(){this._ignoreBlur?this._ignoreBlur=!1:setTimeout($.proxy(function(){this.searchMenu&&this.searchMenu.hide()},this),1)})},getAddElementsBtn:$.noop,getElementSortAxis:function(){return null},searchForTags:function(){if(this.searchMenu&&this.killSearchMenu(),this.$addTagInput.val()){this.$spinner.removeClass(\"hidden\");for(var t=[],e=0;e<this.$elements.length;e++){var i=$(this.$elements[e]).data(\"id\");i&&t.push(i)}this.settings.sourceElementId&&t.push(this.settings.sourceElementId);var r={search:this.$addTagInput.val(),tagGroupId:this.settings.tagGroupId,excludeIds:t};Craft.postActionRequest(\"tags/search-for-tags\",r,$.proxy(function(t,e){if(this.searchMenu&&this.killSearchMenu(),this.$spinner.addClass(\"hidden\"),\"success\"===e){for(var i,s=$('<div class=\"menu tagmenu\"/>').appendTo(Garnish.$bod),n=$(\"<ul/>\").appendTo(s),a=0;a<t.tags.length;a++)i=$(\"<li/>\").appendTo(n),$('<a data-icon=\"tag\"/>').appendTo(i).text(t.tags[a].title).data(\"id\",t.tags[a].id).addClass(t.tags[a].exclude?\"disabled\":\"\");t.exactMatch||(i=$(\"<li/>\").appendTo(n),$('<a data-icon=\"plus\"/>').appendTo(i).text(r.search)),n.find(\"a:not(.disabled):first\").addClass(\"hover\"),this.searchMenu=new Garnish.Menu(s,{attachToElement:this.$addTagInput,onOptionSelect:$.proxy(this,\"selectTag\")}),this.addListener(s,\"mousedown\",$.proxy(function(){this._ignoreBlur=!0},this)),this.searchMenu.show()}},this))}else this.$spinner.addClass(\"hidden\")},selectTag:function(t){var e=$(t);if(!e.hasClass(\"disabled\")){var i=e.data(\"id\"),s=e.text(),n=$(\"<div/>\",{class:\"element small removable\",\"data-id\":i,\"data-site-id\":this.settings.targetSiteId,\"data-label\":s,\"data-editable\":\"1\"}).appendTo(this.$elementsContainer),a=$(\"<input/>\",{type:\"hidden\",name:this.settings.name+\"[]\",value:i}).appendTo(n);$(\"<a/>\",{class:\"delete icon\",title:Craft.t(\"app\",\"Remove\")}).appendTo(n);var r=$(\"<div/>\",{class:\"label\"}).appendTo(n);$(\"<span/>\",{class:\"title\",text:s}).appendTo(r);var o=-(n.outerWidth()+10);this.$addTagInput.css(\"margin-\"+Craft.left,o+\"px\");var l={};if(l[\"margin-\"+Craft.left]=0,this.$addTagInput.velocity(l,\"fast\"),this.$elements=this.$elements.add(n),this.addElements(n),this.killSearchMenu(),this.$addTagInput.val(\"\"),this.$addTagInput.trigger(\"focus\"),!i){n.addClass(\"loading disabled\");var h={groupId:this.settings.tagGroupId,title:s};Craft.postActionRequest(\"tags/create-tag\",h,$.proxy(function(t,e){\"success\"===e&&t.success?(n.attr(\"data-id\",t.id),a.val(t.id),n.removeClass(\"loading disabled\")):(this.removeElement(n),\"success\"===e&&Craft.cp.displayError(Craft.t(\"app\",\"An unknown error occurred.\")))},this))}}},killSearchMenu:function(){this.searchMenu.hide(),this.searchMenu.destroy(),this.searchMenu=null}},{defaults:{tagGroupId:null}}),Craft.ThumbsElementIndexView=Craft.BaseElementIndexView.extend({getElementContainer:function(){return this.$container.children(\"ul\")}}),Craft.ui={createTextInput:function(t){var e=$(\"<input/>\",{attr:{class:\"text\",type:t.type||\"text\",id:t.id,size:t.size,name:t.name,value:t.value,maxlength:t.maxlength,autofocus:this.getAutofocusValue(t.autofocus),autocomplete:void 0!==t.autocomplete&&t.autocomplete?null:\"off\",disabled:this.getDisabledValue(t.disabled),readonly:t.readonly,title:t.title,placeholder:t.placeholder,step:t.step,min:t.min,max:t.max}});return t.class&&e.addClass(t.class),t.placeholder&&e.addClass(\"nicetext\"),\"password\"===t.type&&e.addClass(\"password\"),t.disabled&&e.addClass(\"disabled\"),t.size||e.addClass(\"fullwidth\"),t.showCharsLeft&&t.maxlength&&e.attr(\"data-show-chars-left\").css(\"padding-\"+(\"ltr\"===Craft.orientation?\"right\":\"left\"),7.2*t.maxlength.toString().length+14+\"px\"),(t.placeholder||t.showCharsLeft)&&new Garnish.NiceText(e),\"password\"===t.type?$('<div class=\"passwordwrapper\"/>').append(e):e},createTextField:function(t){return this.createField(this.createTextInput(t),t)},createTextarea:function(t){var e=$(\"<textarea/>\",{class:\"text\",rows:t.rows||2,cols:t.cols||50,id:t.id,name:t.name,maxlength:t.maxlength,autofocus:t.autofocus&&!Garnish.isMobileBrowser(!0),disabled:!!t.disabled,placeholder:t.placeholder,html:t.value});return t.showCharsLeft&&e.attr(\"data-show-chars-left\",\"\"),t.class&&e.addClass(t.class),t.size||e.addClass(\"fullwidth\"),e},createTextareaField:function(t){return this.createField(this.createTextarea(t),t)},createSelect:function(t){var e=$(\"<div/>\",{class:\"select\"});t.class&&e.addClass(t.class);var i=$(\"<select/>\",{id:t.id,name:t.name,autofocus:t.autofocus&&Garnish.isMobileBrowser(!0),disabled:t.disabled,\"data-target-prefix\":t.targetPrefix}).appendTo(e),s=null;for(var n in t.options)if(t.options.hasOwnProperty(n)){var a=t.options[n];if(void 0!==a.optgroup)s=$(\"<optgroup/>\",{label:a.label}).appendTo(i);else{var r=void 0!==a.label?a.label:a,o=void 0!==a.value?a.value:n,l=void 0!==a.disabled&&a.disabled;$(\"<option/>\",{value:o,selected:o==t.value,disabled:l,html:r}).appendTo(s||i)}}return t.toggle&&(i.addClass(\"fieldtoggle\"),new Craft.FieldToggle(i)),e},createSelectField:function(t){return this.createField(this.createSelect(t),t)},createCheckbox:function(t){var e=t.id||\"checkbox\"+Math.floor(1e9*Math.random()),i=$(\"<input/>\",{type:\"checkbox\",value:void 0!==t.value?t.value:\"1\",id:e,class:\"checkbox\",name:t.name,checked:t.checked?\"checked\":null,autofocus:this.getAutofocusValue(t.autofocus),disabled:this.getDisabledValue(t.disabled),\"data-target\":t.toggle,\"data-reverse-target\":t.reverseToggle});t.class&&i.addClass(t.class),(t.toggle||t.reverseToggle)&&(i.addClass(\"fieldtoggle\"),new Craft.FieldToggle(i));var s=$(\"<label/>\",{for:e,text:t.label});return t.name&&(t.name.length<3||\"[]\"!==t.name.substr(-2))?$([$(\"<input/>\",{type:\"hidden\",name:t.name,value:\"\"})[0],i[0],s[0]]):$([i[0],s[0]])},createCheckboxField:function(t){var e=$('<div class=\"field checkboxfield\"/>',{id:t.id?t.id+\"-field\":null});return t.first&&e.addClass(\"first\"),t.instructions&&e.addClass(\"has-instructions\"),this.createCheckbox(t).appendTo(e),t.instructions&&$('<div class=\"instructions\"/>').text(t.instructions).appendTo(e),e},createCheckboxSelect:function(t){var e,i,s=$('<div class=\"checkbox-select\"/>');t.class&&s.addClass(t.class),t.showAllOption?(e=t.allValue||\"*\",i=t.values==e,$(\"<div/>\").appendTo(s).append(this.createCheckbox({id:t.id,class:\"all\",label:\"<b>\"+(t.allLabel||Craft.t(\"app\",\"All\"))+\"</b>\",name:t.name,value:e,checked:i,autofocus:t.autofocus}))):i=!1;for(var n=0;n<t.options.length;n++){var a=t.options[n];a.value!=e&&$(\"<div/>\").appendTo(s).append(this.createCheckbox({label:a.label,name:t.name?t.name+\"[]\":null,value:a.value,checked:i||Craft.inArray(a.value,t.values),disabled:i}))}return new Garnish.CheckboxSelect(s),s},createCheckboxSelectField:function(t){return this.createField(this.createCheckboxSelect(t),t)},createLightswitch:function(t){var e=t.value||\"1\",i=$(\"<div/>\",{class:\"lightswitch\",tabindex:\"0\",\"data-value\":e,id:t.id,\"aria-labelledby\":t.labelId,\"data-target\":t.toggle,\"data-reverse-target\":t.reverseToggle});return t.on&&i.addClass(\"on\"),t.small&&i.addClass(\"small\"),t.disabled&&i.addClass(\"disabled\"),$('<div class=\"lightswitch-container\"><div class=\"label on\"></div><div class=\"handle\"></div><div class=\"label off\"></div></div>').appendTo(i),t.name&&$(\"<input/>\",{type:\"hidden\",name:t.name,value:t.on?e:\"\",disabled:t.disabled}).appendTo(i),(t.toggle||t.reverseToggle)&&(i.addClass(\"fieldtoggle\"),new Craft.FieldToggle(i)),i.lightswitch()},createLightswitchField:function(t){return this.createField(this.createLightswitch(t),t)},createColorInput:function(t){var e=t.id||\"color\"+Math.floor(1e9*Math.random()),i=t.containerId||e+\"-container\",s=t.name||null,n=t.value||null,a=t.small||!1,r=t.autofocus&&Garnish.isMobileBrowser(!0),o=t.disabled||!1,l=$(\"<div/>\",{id:i,class:\"flex color-container\"}),h=$(\"<div/>\",{class:\"color static\"+(a?\" small\":\"\")}).appendTo(l);$(\"<div/>\",{class:\"color-preview\",style:t.value?{backgroundColor:t.value}:null}).appendTo(h),this.createTextInput({id:e,name:s,value:n,size:10,class:\"color-input\",autofocus:r,disabled:o}).appendTo(l);return new Craft.ColorInput(l),l},createColorField:function(t){return this.createField(this.createColorInput(t),t)},createDateInput:function(t){var e=(t.id||\"date\"+Math.floor(1e9*Math.random()))+\"-date\",i=t.name||null,s=i?i+\"[date]\":null,n=t.value&&\"function\"==typeof t.value.getMonth?t.value:null,a=n?Craft.formatDate(n):null,r=t.autofocus&&Garnish.isMobileBrowser(!0),o=t.disabled||!1,l=$(\"<div/>\",{class:\"datewrapper\"}),h=this.createTextInput({id:e,name:s,value:a,placeholder:\" \",autocomplete:!1,autofocus:r,disabled:o}).appendTo(l);return $('<div data-icon=\"date\"></div>').appendTo(l),i&&$(\"<input/>\",{type:\"hidden\",name:i+\"[timezone]\",val:Craft.timezone}).appendTo(l),h.datepicker($.extend({defaultDate:n||new Date},Craft.datepickerOptions)),l},createDateField:function(t){return this.createField(this.createDateInput(t),t)},createTimeInput:function(t){var e=(t.id||\"time\"+Math.floor(1e9*Math.random()))+\"-time\",i=t.name||null,s=i?i+\"[time]\":null,n=t.value&&\"function\"==typeof t.value.getMonth?t.value:null,a=t.autofocus&&Garnish.isMobileBrowser(!0),r=t.disabled||!1,o=$(\"<div/>\",{class:\"timewrapper\"}),l=this.createTextInput({id:e,name:s,placeholder:\" \",autocomplete:!1,autofocus:a,disabled:r}).appendTo(o);return $('<div data-icon=\"time\"></div>').appendTo(o),i&&$(\"<input/>\",{type:\"hidden\",name:i+\"[timezone]\",val:Craft.timezone}).appendTo(o),l.timepicker(Craft.timepickerOptions),n&&l.timepicker(\"setTime\",3600*n.getHours()+60*n.getMinutes()+n.getSeconds()),o},createTimeField:function(t){return this.createField(this.createTimeInput(t),t)},createField:function(t,e){var i=e.label&&\"__blank__\"!==e.label?e.label:null,s=Craft.isMultiSite&&e.siteId?e.siteId:null,n=$(\"<div/>\",{class:\"field\",id:e.fieldId||(e.id?e.id+\"-field\":null)});if(e.first&&n.addClass(\"first\"),i||e.instructions){var a=$('<div class=\"heading\"/>').appendTo(n);if(i){var r=$(\"<label/>\",{id:e.labelId||(e.id?e.id+\"-label\":null),class:e.required?\"required\":null,for:e.id,text:i}).appendTo(a);if(s)for(var o=0;o<Craft.sites.length;o++)if(Craft.sites[o].id==s){$('<span class=\"site\"/>').text(Craft.sites[o].name).appendTo(r);break}}e.instructions&&$('<div class=\"instructions\"/>').text(e.instructions).appendTo(a)}return $('<div class=\"input\"/>').append(t).appendTo(n),e.warning&&$('<p class=\"warning\"/>').text(e.warning).appendTo(n),e.errors&&this.addErrorsToField(n,e.errors),n},createErrorList:function(t){var e=$('<ul class=\"errors\"/>');return t&&this.addErrorsToList(e,t),e},addErrorsToList:function(t,e){for(var i=0;i<e.length;i++)$(\"<li/>\").text(e[i]).appendTo(t)},addErrorsToField:function(t,e){if(e){t.addClass(\"has-errors\"),t.children(\".input\").addClass(\"errors\");var i=t.children(\"ul.errors\");i.length||(i=this.createErrorList().appendTo(t)),this.addErrorsToList(i,e)}},clearErrorsFromField:function(t){t.removeClass(\"has-errors\"),t.children(\".input\").removeClass(\"errors\"),t.children(\"ul.errors\").remove()},getAutofocusValue:function(t){return t&&!Garnish.isMobileBrowser(!0)?\"autofocus\":null},getDisabledValue:function(t){return t?\"disabled\":null}},Craft.Uploader=Garnish.Base.extend({uploader:null,allowedKinds:null,$element:null,settings:null,_rejectedFiles:{},_extensionList:null,_totalFileCounter:0,_validFileCounter:0,init:function(t,e){this._rejectedFiles={size:[],type:[],limit:[]},this.$element=t,this.allowedKinds=null,this._extensionList=null,this._totalFileCounter=0,this._validFileCounter=0;var i=(e=$.extend({},Craft.Uploader.defaults,e)).events;for(var s in delete e.events,e.allowedKinds&&e.allowedKinds.length&&(\"string\"==typeof e.allowedKinds&&(e.allowedKinds=[e.allowedKinds]),this.allowedKinds=e.allowedKinds,delete e.allowedKinds),e.autoUpload=!1,this.uploader=this.$element.fileupload(e),i)i.hasOwnProperty(s)&&this.uploader.on(s,i[s]);this.settings=e,this.uploader.on(\"fileuploadadd\",$.proxy(this,\"onFileAdd\"))},setParams:function(t){void 0!==Craft.csrfTokenName&&void 0!==Craft.csrfTokenValue&&(t[Craft.csrfTokenName]=Craft.csrfTokenValue),this.uploader.fileupload(\"option\",{formData:t})},getInProgress:function(){return this.uploader.fileupload(\"active\")},isLastUpload:function(){return this.getInProgress()<2},onFileAdd:function(t,s){t.stopPropagation();var n=!1;return this.allowedKinds&&(this._extensionList||this._createExtensionList(),n=!0),s.process().done($.proxy(function(){var t=s.files[0],e=!0;if(n){var i=t.name.match(/\\.([a-z0-4_]+)$/i)[1];-1===$.inArray(i.toLowerCase(),this._extensionList)&&(e=!1,this._rejectedFiles.type.push(\"\u201c\"+t.name+\"\u201d\"))}t.size>this.settings.maxFileSize&&(this._rejectedFiles.size.push(\"\u201c\"+t.name+\"\u201d\"),e=!1),e&&\"function\"==typeof this.settings.canAddMoreFiles&&!this.settings.canAddMoreFiles(this._validFileCounter)&&(this._rejectedFiles.limit.push(\"\u201c\"+t.name+\"\u201d\"),e=!1),e&&(this._validFileCounter++,s.submit()),++this._totalFileCounter===s.originalFiles.length&&(this._totalFileCounter=0,this._validFileCounter=0,this.processErrorMessages())},this)),!0},processErrorMessages:function(){var t;this._rejectedFiles.type.length&&(t=1===this._rejectedFiles.type.length?\"The file {files} could not be uploaded. The allowed file kinds are: {kinds}.\":\"The files {files} could not be uploaded. The allowed file kinds are: {kinds}.\",t=Craft.t(\"app\",t,{files:this._rejectedFiles.type.join(\", \"),kinds:this.allowedKinds.join(\", \")}),this._rejectedFiles.type=[],alert(t)),this._rejectedFiles.size.length&&(t=1===this._rejectedFiles.size.length?\"The file {files} could not be uploaded, because it exceeds the maximum upload size of {size}.\":\"The files {files} could not be uploaded, because they exceeded the maximum upload size of {size}.\",t=Craft.t(\"app\",t,{files:this._rejectedFiles.size.join(\", \"),size:this.humanFileSize(Craft.maxUploadSize)}),this._rejectedFiles.size=[],alert(t)),this._rejectedFiles.limit.length&&(t=1===this._rejectedFiles.limit.length?\"The file {files} could not be uploaded, because the field limit has been reached.\":\"The files {files} could not be uploaded, because the field limit has been reached.\",t=Craft.t(\"app\",t,{files:this._rejectedFiles.limit.join(\", \")}),this._rejectedFiles.limit=[],alert(t))},humanFileSize:function(t){if(t<1024)return t+\" B\";for(var e=-1;++e,1024<=(t/=1024););return t.toFixed(1)+\" \"+[\"kB\",\"MB\",\"GB\",\"TB\",\"PB\",\"EB\",\"ZB\",\"YB\"][e]},_createExtensionList:function(){this._extensionList=[];for(var t=0;t<this.allowedKinds.length;t++){var e=this.allowedKinds[t];if(void 0!==Craft.fileKinds[e])for(var i=0;i<Craft.fileKinds[e].extensions.length;i++){var s=Craft.fileKinds[e].extensions[i];this._extensionList.push(s)}}},destroy:function(){this.$element.fileupload(\"destroy\"),this.base()}},{defaults:{dropZone:null,pasteZone:null,fileInput:null,sequentialUploads:!0,maxFileSize:Craft.maxUploadSize,allowedKinds:null,events:{},canAddMoreFiles:null,headers:{Accept:\"application/json;q=0.9,*/*;q=0.8\"},paramName:\"assets-upload\"}}),Craft.UriFormatGenerator=Craft.BaseInputGenerator.extend({generateTargetValue:function(t){t=(t=t.replace(\"/<(.*?)>/g\",\"\")).toLowerCase(),t=(t=(t=Craft.asciiString(t)).replace(/^[^a-z]+/,\"\")).replace(/[^a-z0-9]+$/,\"\");var e=Craft.filterArray(t.split(/[^a-z0-9]+/)).join(\"-\");return e&&this.settings.suffix&&(e+=this.settings.suffix),e}})}(jQuery);\n//# sourceMappingURL=Craft.min.js.map", "{\"version\":3,\"sources\":[\"Craft.js\"],\"names\":[\"$\",\"extend\",\"Craft\",\"navHeight\",\"t\",\"category\",\"message\",\"params\",\"translations\",\"key\",\"hasOwnProperty\",\"replace\",\"formatDate\",\"date\",\"Date\",\"datepicker\",\"datepickerOptions\",\"dateFormat\",\"formatNumber\",\"number\",\"format\",\"d3\",\"formatLocale\",\"d3FormatLocaleDefinition\",\"formatter\",\"escapeHtml\",\"str\",\"text\",\"html\",\"escapeRegex\",\"getText\",\"encodeUriComponent\",\"encodeURIComponent\",\"differences\",\"!\",\"*\",\"'\",\"(\",\")\",\"chr\",\"re\",\"RegExp\",\"selectFullValue\",\"input\",\"$input\",\"val\",\"setSelectionRange\",\"length\",\"formatInputId\",\"inputName\",\"this\",\"rtrim\",\"getUrl\",\"path\",\"baseUrl\",\"anchor\",\"isPlainObject\",\"aParams\",\"name\",\"value\",\"push\",\"Garnish\",\"isArray\",\"join\",\"trim\",\"url\",\"qpos\",\"indexOf\",\"substr\",\"search\",\"pathMatch\",\"match\",\"pathParam\",\"omitScriptNameInUrls\",\"usePathInfo\",\"scriptName\",\"basePath\",\"endPath\",\"substring\",\"getCpUrl\",\"baseCpUrl\",\"getSiteUrl\",\"baseSiteUrl\",\"getActionUrl\",\"actionUrl\",\"redirectTo\",\"document\",\"location\",\"href\",\"getCsrfInput\",\"csrfTokenName\",\"csrfTokenValue\",\"postActionRequest\",\"action\",\"data\",\"callback\",\"options\",\"headers\",\"X-Registered-Asset-Bundles\",\"Object\",\"keys\",\"registeredAssetBundles\",\"X-Registered-Js-Files\",\"registeredJsFiles\",\"jqXHR\",\"ajax\",\"type\",\"dataType\",\"success\",\"error\",\"textStatus\",\"errorThrown\",\"readyState\",\"cp\",\"displayError\",\"alert\",\"send\",\"_waitingOnAjax\",\"_ajaxQueue\",\"queueActionRequest\",\"undefined\",\"_postNextActionRequestInQueue\",\"args\",\"shift\",\"stringToArray\",\"arr\",\"split\",\"i\",\"expandPostArray\",\"expanded\",\"m\",\"unshift\",\"parentElem\",\"parseInt\",\"compare\",\"obj1\",\"obj2\",\"sortObjectKeys\",\"Array\",\"getObjectKeys\",\"sort\",\"obj\",\"escapeChars\",\"chars\",\"escaped\",\"ltrim\",\"startsWith\",\"filterArray\",\"filtered\",\"inArray\",\"elem\",\"removeFromArray\",\"index\",\"splice\",\"getLast\",\"uppercaseFirst\",\"charAt\",\"toUpperCase\",\"slice\",\"lowercaseFirst\",\"toLowerCase\",\"parseUrl\",\"scheme\",\"host\",\"hostname\",\"port\",\"query\",\"hash\",\"isSameHost\",\"requestUrlInfo\",\"urlInfo\",\"secondsToHumanTimeDuration\",\"seconds\",\"showSeconds\",\"weeks\",\"Math\",\"floor\",\"days\",\"minutes\",\"hours\",\"round\",\"timeComponents\",\"asciiString\",\"charMap\",\"char\",\"asciiStr\",\"asciiCharMap\",\"randomString\",\"result\",\"random\",\"preventOutlineOnMouseFocus\",\"$elem\",\"namespace\",\"on\",\"addClass\",\"trigger\",\"event\",\"keyCode\",\"SHIFT_KEY\",\"CTRL_KEY\",\"CMD_KEY\",\"removeClass\",\"createErrorList\",\"errors\",\"$ul\",\"createElement\",\"$li\",\"appendTo\",\"appendHeadHtml\",\"$existingCss\",\"existingCss\",\"eq\",\"attr\",\"regexp\",\"append\",\"appendFootHtml\",\"$existingJs\",\"src\",\"existingJs\",\"$bod\",\"initUiElements\",\"$container\",\"grid\",\"infoicon\",\"checkboxselect\",\"fieldtoggle\",\"lightswitch\",\"nicetext\",\"pill\",\"formsubmit\",\"menubtn\",\"_elementIndexClasses\",\"_elementSelectorModalClasses\",\"_elementEditorClasses\",\"registerElementIndexClass\",\"elementType\",\"func\",\"registerElementSelectorModalClass\",\"registerElementEditorClass\",\"createElementIndex\",\"settings\",\"BaseElementIndex\",\"createElementSelectorModal\",\"BaseElementSelectorModal\",\"createElementEditor\",\"element\",\"BaseElementEditor\",\"getLocalStorage\",\"defaultValue\",\"systemUid\",\"localStorage\",\"JSON\",\"parse\",\"setLocalStorage\",\"stringify\",\"e\",\"getElementInfo\",\"$element\",\"hasClass\",\"find\",\"id\",\"siteId\",\"label\",\"status\",\"hasThumb\",\"setElementSize\",\"size\",\"otherSize\",\"$oldImg\",\"$newImg\",\"sizes\",\"srcset\",\"replaceWith\",\"picturefill\",\"elements\",\"fn\",\"animateLeft\",\"pos\",\"duration\",\"easing\",\"complete\",\"orientation\",\"velocity\",\"left\",\"right\",\"animateRight\",\"disable\",\"each\",\"removeAttr\",\"enable\",\"itemSelector\",\"cols\",\"maxCols\",\"minColWidth\",\"mode\",\"fillMode\",\"colClass\",\"snapToGrid\",\"Grid\",\"InfoIcon\",\"CheckboxSelect\",\"FieldToggle\",\"settingName\",\"settingValue\",\"setSettings\",\"thisSettings\",\"hasAttr\",\"LightSwitch\",\"NiceText\",\"Pill\",\"ev\",\"$btn\",\"currentTarget\",\"confirm\",\"$anchor\",\"$form\",\"closest\",\"customTrigger\",\"next\",\"menuAnchor\",\"MenuBtn\",\"$doc\",\"ready\",\"Base\",\"elementId\",\"$fieldsContainer\",\"$cancelBtn\",\"$saveBtn\",\"$spinner\",\"$siteSelect\",\"$siteSpinner\",\"hud\",\"init\",\"defaults\",\"loadHud\",\"setElementAttribute\",\"attributes\",\"getBaseData\",\"prevalidate\",\"onBeginLoading\",\"includeSites\",\"isMultiSite\",\"showSiteSwitcher\",\"proxy\",\"showHud\",\"response\",\"onEndLoading\",\"$hudContents\",\"sites\",\"$header\",\"$siteSelectContainer\",\"siteInfo\",\"addListener\",\"add\",\"updateForm\",\"onCreateForm\",\"$footer\",\"$buttonsContainer\",\"updateBody\",\"updateSizeAndPosition\",\"hudTrigger\",\"HUD\",\"bodyClass\",\"closeOtherHUDs\",\"onShow\",\"onHide\",\"onSubmit\",\"$hud\",\"hide\",\"switchSite\",\"newSiteId\",\"reloadForm\",\"$instructions\",\"class\",\"children\",\"requestAnimationFrame\",\"headHtml\",\"footHtml\",\"saveElement\",\"validators\",\"isFunction\",\"call\",\"param\",\"$body\",\"serialize\",\"$title\",\"$a\",\"cpEditUrl\",\"newTitle\",\"closeHud\",\"onSaveElement\",\"shake\",\"onShowHud\",\"onHideHud\",\"runQueue\",\"elementIndex\",\"noop\",\"initialized\",\"instanceState\",\"sourceStates\",\"sourceStatesStorageKey\",\"searchTimeout\",\"sourceSelect\",\"$main\",\"$mainSpinner\",\"isIndexBusy\",\"$sidebar\",\"showingSidebar\",\"sourceKey\",\"sourceViewModes\",\"$source\",\"sourcesByKey\",\"$visibleSources\",\"$customizeSourcesBtn\",\"customizeSourcesModal\",\"$toolbar\",\"$toolbarFlexContainer\",\"toolbarOffset\",\"$search\",\"searching\",\"searchText\",\"trashed\",\"drafts\",\"$clearSearchBtn\",\"$statusMenuBtn\",\"$statusMenuContainer\",\"statusMenu\",\"$siteMenuBtn\",\"siteMenu\",\"$sortMenuBtn\",\"sortMenu\",\"$sortAttributesList\",\"$sortDirectionsList\",\"$scoreSortAttribute\",\"$structureSortAttribute\",\"$elements\",\"$viewModeBtnContainer\",\"viewModeBtns\",\"viewMode\",\"view\",\"_autoSelectElements\",\"$countContainer\",\"page\",\"$exportBtn\",\"actions\",\"actionsHeadHtml\",\"actionsFootHtml\",\"$selectAllContainer\",\"$selectAllCheckbox\",\"showingActionTriggers\",\"_$detachedToolbarItems\",\"_$triggers\",\"getDefaultInstanceState\",\"storageKey\",\"context\",\"parent\",\"hideSidebar\",\"toolbarFixed\",\"isMobileBrowser\",\"$win\",\"$scrollContainer\",\"initSources\",\"menu\",\"$option\",\"$options\",\"filter\",\"first\",\"_setSite\",\"criteria\",\"storedSiteId\",\"$storedSiteOption\",\"startSearching\",\"stopSearching\",\"clearTimeout\",\"setTimeout\",\"RETURN_KEY\",\"preventDefault\",\"updateElementsIfSearchTextChanged\",\"afterInit\",\"selectDefaultSource\",\"setPage\",\"pageNum\",\"updateElements\",\"onAfterInit\",\"getSourceContainer\",\"$sources\",\"$items\",\"_getSourcesInList\",\"Select\",\"multi\",\"allowEmpty\",\"vertical\",\"onSelectionChange\",\"_initSources\",\"getDefaultSourceKey\",\"getSourceByKey\",\"selectSource\",\"refreshSources\",\"removeAllItems\",\"setIndexBusy\",\"refreshSourcesAction\",\"setIndexAvailable\",\"updateFixedToolbar\",\"_scrollTop\",\"scrollTop\",\"width\",\"_makingFixed\",\"css\",\"outerHeight\",\"top\",\"offset\",\"initSource\",\"addItems\",\"initSourceToggle\",\"expandedSources\",\"_expandSource\",\"deinitSourceToggle\",\"$toggle\",\"_getSourceToggle\",\"deinitSource\",\"removeItems\",\"removeListener\",\"removeData\",\"selectedSource\",\"getDefaultExpandedSources\",\"addOptions\",\"prependTo\",\"_updateStructureSortOption\",\"setSortAttribute\",\"detach\",\"setInstanceState\",\"storeInstanceState\",\"getSourceState\",\"source\",\"getSelectedSourceState\",\"setSelecetedSourceState\",\"viewState\",\"storeSortAttributeAndDirection\",\"getSelectedSortAttribute\",\"order\",\"getSelectedSortDirection\",\"max\",\"pageTrigger\",\"history\",\"replaceState\",\"getViewParams\",\"batchSize\",\"limit\",\"disabledElementIds\",\"paginated\",\"_isViewPaginated\",\"collapsedElementIds\",\"preservePagination\",\"destroy\",\"updateElementsAction\",\"totalPages\",\"ceil\",\"count\",\"_updateView\",\"showActionTriggers\",\"height\",\"not\",\"insertAfter\",\"_createTriggers\",\"submitAction\",\"actionClass\",\"actionParams\",\"selectedElementIds\",\"getSelectedElementIds\",\"viewParams\",\"elementAction\",\"elementIds\",\"submitActionsAction\",\"displayNotice\",\"afterAction\",\"onAfterAction\",\"hideActionTriggers\",\"insertBefore\",\"updateActionTriggers\",\"totalSelected\",\"getSelectedElements\",\"getEnabledElements\",\"$selectAllBtn\",\"getSortAttributeOption\",\"attribute\",\"setSortDirection\",\"getSortDirectionOption\",\"dir\",\"getSelectedViewMode\",\"selectItem\",\"updateSidebarMenuLabel\",\"setStoredSortOptionsForSource\",\"remove\",\"getViewModesForSource\",\"sourceViewMode\",\"$viewModeBtn\",\"className\",\"title\",\"icon\",\"selectViewMode\",\"doesSourceHaveViewMode\",\"onSelectSource\",\"selectSourceByKey\",\"sortAttr\",\"sortDir\",\"getDefaultSort\",\"viewModes\",\"force\",\"createView\",\"getViewClass\",\"TableElementIndexView\",\"ThumbsElementIndexView\",\"rememberDisabledElementId\",\"forgetDisabledElementId\",\"enableElements\",\"parents\",\"onEnableElements\",\"disableElements\",\"onDisableElements\",\"getElementById\",\"enableElementsById\",\"ids\",\"makeArray\",\"disableElementsById\",\"selectElementAfterUpdate\",\"addButton\",\"$button\",\"getButtonContainer\",\"isShowingSidebar\",\"buttonContainer\",\"createCustomizeSourcesModal\",\"modal\",\"CustomizeSourcesModal\",\"base\",\"onSelectSite\",\"onUpdateElements\",\"_handleSourceSelectionChange\",\"$selectedItems\",\"_handleActionTriggerSubmit\",\"getPostData\",\"_handleMenuActionTriggerSubmit\",\"option\",\"_handleStatusChange\",\"selectedOption\",\"_handleSiteChange\",\"$firstVisibleSource\",\"selectNewSource\",\"toString\",\"get\",\"$heading\",\"$headings\",\"nextUntil\",\"_handleSortChange\",\"is\",\"_handleSelectionChange\",\"_handleSourceDblClick\",\"_toggleSource\",\"stopPropagation\",\"_handleSourceToggleClick\",\"prev\",\"$firstOption\",\"$list\",\"_getChildSources\",\"siblings\",\"_deinitSources\",\"_collapseSource\",\"$childSources\",\"countLabel\",\"$paginationContainer\",\"$prevBtn\",\"data-icon\",\"$nextBtn\",\"role\",\"tabindex\",\"aria-checked\",\"selectAllElements\",\"deselectAllElements\",\"SPACE_KEY\",\"selectable\",\"multiSelect\",\"checkboxMode\",\"selectElementById\",\"triggers\",\"safeMenuActions\",\"destructiveMenuActions\",\"destructive\",\"$menuTrigger\",\"$menu\",\"$safeList\",\"_createMenuTriggerList\",\"$destructiveList\",\"$div\",\"_showExportHud\",\"$limitField\",\"ui\",\"createTextField\",\"placeholder\",\"min\",\"submitting\",\"isNaN\",\"tokenParam\",\"token\",\"data-action\",\"BaseElementIndexView\",\"$loadingMoreSpinner\",\"$elementContainer\",\"$scroller\",\"thumbLoader\",\"elementSelect\",\"loadingMore\",\"_totalVisible\",\"_morePending\",\"_handleEnableElements\",\"_handleDisableElements\",\"container\",\"getElementContainer\",\"setTotalVisible\",\"setMorePending\",\"ElementThumbLoader\",\"load\",\"isVerticalList\",\"handle\",\"_handleElementEditing\",\"$target\",\"target\",\"prop\",\"isTouchCapable\",\"maybeLoadMore\",\"getAllElements\",\"$selectedElements\",\"selectElement\",\"selectAll\",\"deselectAll\",\"getTotalVisible\",\"totalVisible\",\"getMorePending\",\"morePending\",\"canLoadMore\",\"loadMore\",\"winHeight\",\"innerHeight\",\"winScrollTop\",\"getLoadMoreParams\",\"loadMoreElementsAction\",\"$newElements\",\"appendElements\",\"onAppendElements\",\"newElements\",\"off\",\"BaseElementSelectInput\",\"elementSort\",\"elementEditor\",\"$elementsContainer\",\"$addElementBtn\",\"_initialized\",\"normalizedSettings\",\"arguments\",\"modalStorageKey\",\"sortable\",\"getContainer\",\"getElementsContainer\",\"getAddElementsBtn\",\"initElementSelect\",\"initElementSort\",\"resetElements\",\"getElements\",\"DragSort\",\"$targetItem\",\"getSelectedItems\",\"ignoreHandleSelector\",\"axis\",\"getElementSortAxis\",\"collapseDraggees\",\"magnetStrength\",\"helperLagBase\",\"onSortChange\",\"resetItemOrder\",\"canAddMoreElements\",\"updateAddElementsBtn\",\"enableAddElementsBtn\",\"disableAddElementsBtn\",\"ADD_FX_DURATION\",\"REMOVE_FX_DURATION\",\"show\",\"removeElements\",\"addElements\",\"editable\",\"_handleShowElementEditor\",\"removeElement\",\"onRemoveElements\",\"animateElementAway\",\"animateCss\",\"opacity\",\"outerWidth\",\"showModal\",\"createModal\",\"getModalSettings\",\"closeOtherModals\",\"sources\",\"showSiteMenu\",\"getDisabledElementIds\",\"onSelect\",\"modalSettings\",\"sourceElementId\",\"onModalSelect\",\"slotsLeft\",\"selectElements\",\"updateDisabledElementsInModal\",\"elementInfo\",\"createNewElement\",\"appendElement\",\"animateElementIntoPlace\",\"onSelectElements\",\"clone\",\"prepend\",\"$modalElement\",\"$inputElement\",\"origOffset\",\"destOffset\",\"$helper\",\"position\",\"zIndex\",\"window\",\"draftEditor\",\"checkForm\",\"fieldId\",\"editorSettings\",\"Modal\",\"$selectBtn\",\"$sourceToggles\",\"$tbody\",\"$primaryButtons\",\"$secondaryButtons\",\"$footerSpinner\",\"onFadeIn\",\"_createElementIndex\",\"updateSelectBtnState\",\"enableSelectBtn\",\"disableSelectBtn\",\"enableCancelBtn\",\"disableCancelBtn\",\"showFooterSpinner\",\"hideFooterSpinner\",\"cancel\",\"clearMouseUpTimeout\",\"disableElementsOnSelect\",\"hideOnSelect\",\"info\",\"has\",\"touchData\",\"firstTap\",\"secondTap\",\"resizable\",\"onCancel\",\"hideIndexSidebar\",\"BaseInputGenerator\",\"listening\",\"timeout\",\"startListening\",\"setNewSource\",\"stopListening\",\"removeAllListeners\",\"onSourceTextChange\",\"onTargetTextChange\",\"activeElement\",\"onFormSubmit\",\"updateTarget\",\"sourceVal\",\"targetVal\",\"generateTargetValue\",\"AdminTable\",\"totalItems\",\"sorter\",\"$noItems\",\"$table\",\"$deleteBtns\",\"allowDeleteAll\",\"minItems\",\"noItemsSelector\",\"tableSelector\",\"DataTableSorter\",\"updateUI\",\"addRow\",\"row\",\"maxItems\",\"$row\",\"$deleteBtn\",\"reorderItems\",\"idAttribute\",\"reorderAction\",\"onReorderItems\",\"reorderSuccessMessage\",\"reorderFailMessage\",\"handleDeleteBtnClick\",\"confirmDeleteItem\",\"deleteItem\",\"getItemName\",\"confirmDeleteMessage\",\"getItemId\",\"deleteAction\",\"handleDeleteItemResponse\",\"onDeleteItem\",\"deleteSuccessMessage\",\"deleteFailMessage\",\"nameAttribute\",\"$moveButtons\",\"newItemBtnSelector\",\"AssetEditor\",\"reloadIndex\",\"$imageEditorTrigger\",\"showImageEditor\",\"AssetImageEditor\",\"onSave\",\"bind\",\"allowDegreeFractions\",\"isImagick\",\"$imageTools\",\"$buttons\",\"$replaceBtn\",\"$editorContainer\",\"$straighten\",\"$croppingCanvas\",\"$spinnerCanvas\",\"canvas\",\"image\",\"viewport\",\"focalPoint\",\"croppingCanvas\",\"clipper\",\"croppingRectangle\",\"cropperHandles\",\"cropperGrid\",\"croppingShade\",\"imageStraightenAngle\",\"viewportRotation\",\"originalWidth\",\"originalHeight\",\"imageVerticeCoords\",\"zoomRatio\",\"animationInProgress\",\"currentView\",\"assetId\",\"cacheBust\",\"draggingCropper\",\"scalingCropper\",\"draggingFocal\",\"previousMouseX\",\"previousMouseY\",\"shiftKeyHeld\",\"editorHeight\",\"editorWidth\",\"cropperState\",\"scaleFactor\",\"flipData\",\"focalPointState\",\"croppingConstraint\",\"spinnerInterval\",\"maxImageSize\",\"lastLoadedDimensions\",\"imageIsLoading\",\"renderImage\",\"renderCropper\",\"now\",\"x\",\"y\",\"allowSavingAsNew\",\"saveImage\",\"$shade\",\"getMaxImageSize\",\"browserViewportWidth\",\"documentElement\",\"clientWidth\",\"browserViewportHeight\",\"clientHeight\",\"devicePixelRatio\",\"loadEditor\",\"$tabs\",\"$viewsContainer\",\"$views\",\"innerWidth\",\"_showSpinner\",\"fabric\",\"StaticCanvas\",\"enableRetinaScaling\",\"renderAll\",\"imageUrl\",\"Image\",\"fromURL\",\"imageObject\",\"set\",\"originX\",\"originY\",\"getHeight\",\"getWidth\",\"getScaledImageDimensions\",\"_setFittedImageVerticeCoordinates\",\"_repositionEditorElements\",\"focalState\",\"imageDimensions\",\"offsetX\",\"offsetY\",\"focal\",\"focalData\",\"adjustedX\",\"adjustedY\",\"storeFocalPointState\",\"_createFocalPoint\",\"_createViewport\",\"storeCropperState\",\"_addControlListeners\",\"_handleMouseMove\",\"_handleMouseDown\",\"_handleMouseUp\",\"_hideSpinner\",\"_reloadImage\",\"setSrc\",\"min-width\",\"min-height\",\"previousEditorDimensions\",\"setDimensions\",\"currentScaledDimensions\",\"getZoomToFitRatio\",\"previouslyOccupiedArea\",\"_getBoundingRectangle\",\"_repositionCropper\",\"getZoomToCoverRatio\",\"_repositionImage\",\"_repositionViewport\",\"_repositionFocalPoint\",\"_zoomImage\",\"Rect\",\"fill\",\"globalCompositeOperation\",\"sizeFactor\",\"focalX\",\"focalY\",\"deltaX\",\"deltaY\",\"Group\",\"Circle\",\"radius\",\"strokeWidth\",\"stroke\",\"toggleFocalPoint\",\"dimensions\",\"state\",\"currentWidth\",\"ratio\",\"hasOrientationChanged\",\"imageRatio\",\"rotateImage\",\"flipImage\",\"straighteningInput\",\"SlideRuleInput\",\"onStart\",\"_showGrid\",\"onChange\",\"slider\",\"straighten\",\"onEnd\",\"_hideGrid\",\"_cleanupFocalPointAfterStraighten\",\"onOptionSelect\",\"setCroppingConstraint\",\"enforceCroppingConstraint\",\"_handleTabClick\",\"$tab\",\"showView\",\"enableSlider\",\"disableSlider\",\"disableCropMode\",\"enableCropMode\",\"zoomFactor\",\"degrees\",\"imageZoomRatio\",\"newAngle\",\"angle\",\"scaledImageDimensions\",\"viewportProperties\",\"imageProperties\",\"angleInRadians\",\"PI\",\"newDeltaX\",\"cos\",\"sin\",\"newDeltaY\",\"modifiedDeltaX\",\"modifiedDeltaY\",\"temp\",\"animate\",\"animationDuration\",\"onComplete\",\"cleanAngle\",\"parseFloat\",\"_adjustFocalPointByAngle\",\"_resetFocalPointPosition\",\"editorCenter\",\"setValue\",\"properties\",\"scaleY\",\"scaleX\",\"previousAngle\",\"_adjustEditorElementsOnStraighten\",\"newCenterX\",\"newCenterY\",\"angleDelta\",\"currentZoomRatio\",\"adjustmentRatio\",\"cropperCenterX\",\"cropperCenterY\",\"imageVertices\",\"getImageVerticeCoords\",\"rectangle\",\"_getZoomRatioToFitRectangle\",\"_isCenterInside\",\"object\",\"containingObject\",\"newFocalX\",\"newFocalY\",\"adjustedFocalX\",\"adjustedFocalY\",\"containingVertices\",\"vertex\",\"rectangleVertices\",\"_getRectangleVertices\",\"verticeIndex\",\"arePointsInsideRectangle\",\"edge\",\"_getEdgeCrossed\",\"rectangleCenter\",\"distanceFromVertexToEdge\",\"abs\",\"sqrt\",\"pow\",\"distanceFromCenterToEdge\",\"postData\",\"imageRotation\",\"cropData\",\"zoom\",\"end\",\"scaledWidth\",\"scaledHeight\",\"boundingBox\",\"_getImageBoundingBox\",\"scale\",\"vertScale\",\"horiScale\",\"getCombinedZoomRatio\",\"strokeOptions\",\"gridWidth\",\"gridHeight\",\"xStep\",\"yStep\",\"Line\",\"onFadeOut\",\"cropperData\",\"_showCropper\",\"_editorModeTransition\",\"_hideCropper\",\"targetZoom\",\"inverseZoomFactor\",\"imageOffsetX\",\"imageOffsetY\",\"getContext\",\"start\",\"cW\",\"cH\",\"setInterval\",\"rotation\",\"save\",\"clearRect\",\"translate\",\"rotate\",\"beginPath\",\"moveTo\",\"lineTo\",\"lineWidth\",\"strokeStyle\",\"restore\",\"clearInterval\",\"clipperData\",\"_setupCropperLayer\",\"_redrawCropperElements\",\"backgroundColor\",\"hoverCursor\",\"selection\",\"rectangleRatio\",\"rectWidth\",\"rectHeight\",\"lineOptions\",\"gridOptions\",\"pathGroup\",\"Path\",\"previousImageArea\",\"currentOffset\",\"areaFactor\",\"coordinateSet\",\"a\",\"b\",\"c\",\"d\",\"_isMouseOver\",\"move\",\"_cropperHandleHitTest\",\"pageX\",\"pageY\",\"_handleFocalDrag\",\"_handleCropperDrag\",\"_handleCropperResize\",\"_setMouseCursor\",\"vertices\",\"newX\",\"newY\",\"constraint\",\"previousHeight\",\"previousWidth\",\"topDelta\",\"leftDelta\",\"change\",\"cursor\",\"parentOffset\",\"mouseX\",\"mouseY\",\"lb\",\"rb\",\"tb\",\"bb\",\"topLeft\",\"topRight\",\"bottomRight\",\"zoomMode\",\"topVerticalSegment\",\"bottomVerticalSegment\",\"rightHorizontalSegment\",\"leftHorizontalSegment\",\"verticalOffset\",\"horizontalOffset\",\"_debug\",\"fabricObj\",\"debugger\",\"points\",\"ab\",\"_getVector\",\"bc\",\"scalarAbAb\",\"_getScalarProduct\",\"scalarBcBc\",\"point\",\"ap\",\"bp\",\"scalarAbAp\",\"scalarBcBp\",\"_getVectorMagnitude\",\"vector\",\"_getAngleBetweenVectors\",\"acos\",\"edgePoints\",\"centerPoint\",\"smallestDiff\",\"edgeCrossed\",\"edgeIndex\",\"toCenter\",\"edgeVector\",\"toVertex\",\"diff\",\"box\",\"proportion\",\"AssetIndex\",\"$includeSubfoldersContainer\",\"$includeSubfoldersCheckbox\",\"showingIncludeSubfoldersCheckbox\",\"$uploadButton\",\"$uploadInput\",\"$progressBar\",\"$folders\",\"uploader\",\"promptHandler\",\"progressBar\",\"_uploadTotalFiles\",\"_uploadFileProgress\",\"_uploadedAssetIds\",\"_currentUploaderSettings\",\"_assetDrag\",\"_folderDrag\",\"_expandDropTargetFolderTimeout\",\"_tempExpandedFolders\",\"_fileConflictTemplate\",\"choices\",\"_folderConflictTemplate\",\"_initIndexPageMode\",\"_createFolderContextMenu\",\"_getSourceLevel\",\"updateDropTargets\",\"contextMenu\",\"parentsUntil\",\"onDragStartProxy\",\"onDropTargetChangeProxy\",\"DragDrop\",\"activeDropTargetClass\",\"helperOpacity\",\"helper\",\"$file\",\"_getFileDragHelper\",\"dropTargets\",\"targets\",\"_getFolderUidFromSourceKey\",\"onDragStart\",\"onDropTargetChange\",\"onDragStop\",\"$selected\",\"draggees\",\"$draggeeHelper\",\"$helperSidebar\",\"$helperNav\",\"$helperUl\",\"padding-top\",\"$draggee\",\"padding-right\",\"padding-bottom\",\"padding-left\",\"draggedSourceIds\",\"_onFileDragStop\",\"$activeDropTarget\",\"originatingSource\",\"targetFolderId\",\"originalAssetIds\",\"originalAssetId\",\"_positionProgressBar\",\"resetProgressBar\",\"setItemCount\",\"showProgressBar\",\"parameterArray\",\"folderId\",\"onMoveFinish\",\"responseArray\",\"resetPrompts\",\"conflict\",\"addPrompt\",\"suggestedFilename\",\"prompt\",\"hideProgressBar\",\"performAfterMoveActions\",\"_collapseExtraExpandedFolders\",\"getPromptCount\",\"promptCallback\",\"returnData\",\"newParameterArray\",\"choice\",\"filename\",\"apply\",\"_performBatchRequests\",\"fadeOutHelpers\",\"showBatchPrompts\",\"returnHelpersToDraggees\",\"_onFolderDragStop\",\"folderIds\",\"reverse\",\"parentId\",\"requestId\",\"fileMoveList\",\"newSourceKey\",\"transferList\",\"newFolderId\",\"newFolderUid\",\"merge\",\"_performActualFolderMove\",\"folderDeleteList\",\"moveCallback\",\"counter\",\"_getParentSource\",\"_selectSourceByFolderId\",\"$targetSource\",\"_getSourceByKey\",\"$parentSources\",\"$parentSource\",\"PromptHandler\",\"ProgressBar\",\"fileInput\",\"dropZone\",\"events\",\"fileuploadstart\",\"fileuploadprogressall\",\"fileuploaddone\",\"kind\",\"allowedKinds\",\"Uploader\",\"setParams\",\"$subContainer\",\"checked\",\"marginBottom\",\"includeSubfolders\",\"_onUploadStart\",\"_onUploadProgress\",\"progress\",\"loaded\",\"total\",\"setProgressPercentage\",\"_onUploadComplete\",\"files\",\"doReload\",\"file\",\"isLastUpload\",\"_updateAfterUpload\",\"_uploadFollowup\",\"finalCallback\",\"doFollowup\",\"parameterIndex\",\"followupCallback\",\"incrementProcessedItemCount\",\"updateProgressBar\",\"sourceAssetId\",\"conflictingAssetId\",\"targetFilename\",\"_onUpdateElements\",\"_onKeyDown\",\"_onElementFocus\",\"shiftKey\",\"PreviewFileModal\",\"openInstance\",\"selfDestruct\",\"$focusedItem\",\"_loadPreview\",\"item\",\"startingWidth\",\"startingHeight\",\"_onDragStart\",\"$outerContainer\",\"$innerContainer\",\"_$firstRowCells\",\"$helperCells\",\"$helperCell\",\"$firstRowCell\",\"_onDropTargetChange\",\"$dropTarget\",\"dropTargetFolder\",\"_hasSubfolders\",\"_isExpanded\",\"dropTargetFolderId\",\"$excludedSources\",\"_collapseFolder\",\"_expandFolder\",\"menuOptions\",\"onClick\",\"ContextMenu\",\"menuClass\",\"_createSubfolder\",\"$parentFolder\",\"subfolderName\",\"folderName\",\"_prepareParentForChildren\",\"$subfolder\",\"folderUid\",\"_appendSubfolder\",\"_deleteFolder\",\"$targetFolder\",\"folder\",\"_cleanUpTree\",\"_renameFolder\",\"oldName\",\"newName\",\"$existingChildren\",\"subfolderLabel\",\"folderInserted\",\"$existingChild\",\"before\",\"windowHeight\",\"doRequest\",\"parameters\",\"AssetSelectInput\",\"originalFilename\",\"originalExtension\",\"resetOriginalFilename\",\"_renameHelper\",\"validateElementForm\",\"_attachUploader\",\"defaultFieldLayoutId\",\"formData\",\"canAddMoreFiles\",\"selectUploadedFile\",\"$newElement\",\"margin\",\"slotsTaken\",\"_parseFilename\",\"parts\",\"extension\",\"pop\",\"baseFileName\",\"endPos\",\"selectionStart\",\"selectionEnd\",\"createRange\",\"select\",\"range\",\"collapse\",\"moveEnd\",\"moveStart\",\"$filenameField\",\"ext\",\"oldExt\",\"newExt\",\"AssetSelectorModal\",\"$selectTransformBtn\",\"_selectedTransform\",\"transforms\",\"createSelectTransformButton\",\"$btnGroup\",\"$menuList\",\"MenuButton\",\"allowTransforms\",\"onSelectTransform\",\"transform\",\"selectImagesWithTransform\",\"transformUrls\",\"imageIdsWithMissingUrls\",\"$item\",\"fetchMissingTransformUrls\",\"canSelectImageTransforms\",\"AuthManager\",\"remainingSessionTime\",\"checkRemainingSessionTimer\",\"showLoginModalTimer\",\"decrementLogoutWarningInterval\",\"showingLogoutWarningModal\",\"showingLoginModal\",\"logoutWarningModal\",\"loginModal\",\"$logoutWarningPara\",\"$passwordInput\",\"$passwordSpinner\",\"$loginBtn\",\"$loginErrorPara\",\"submitLoginIfLoggedOut\",\"updateRemainingSessionTime\",\"setCheckRemainingSessionTimer\",\"checkRemainingSessionTime\",\"extendSession\",\"responseJSON\",\"minSafeSessiotTime\",\"showLogoutWarningModal\",\"checkInterval\",\"submitLogin\",\"showLoginModal\",\"hideLogoutWarningModal\",\"hideLoginModal\",\"quickShow\",\"$logoutBtn\",\"$renewSessionBtn\",\"autoShow\",\"hideOnEsc\",\"hideOnShadeClick\",\"shadeClass\",\"updateLogoutWarningMessage\",\"time\",\"decrementLogoutWarning\",\"quick\",\"quickHide\",\"$inputContainer\",\"$inputsFlexContainer\",\"$passwordContainer\",\"$buttonContainer\",\"$passwordWrapper\",\"PasswordInput\",\"onToggleInput\",\"$newPasswordInput\",\"logout\",\"renewSession\",\"validatePassword\",\"login\",\"clearLoginError\",\"loginName\",\"username\",\"password\",\"showLoginError\",\"CategoryIndex\",\"editableGroups\",\"$newCategoryBtnGroup\",\"$newCategoryBtn\",\"editableCategoryGroups\",\"group\",\"uid\",\"defaultGroupHandle\",\"updateButton\",\"selectedSourceHandle\",\"selectedGroup\",\"$menuBtn\",\"_getGroupTriggerHref\",\"_openCreateCategoryModal\",\"getAttribute\",\"menuHtml\",\"menuBtn\",\"uri\",\"primarySiteId\",\"groupId\",\"newCategoryBtnText\",\"groupSourceKey\",\"CategorySelectInput\",\"selectedCategoryIds\",\"categoryIds\",\"branchLimit\",\"selectionLabel\",\"$newElementsContainer\",\"filteredElements\",\"$allCategories\",\"_animateCategoryAway\",\"charts\",\"DataTable\",\"columns\",\"rows\",\"forEach\",\"cellIndex\",\"parseTime\",\"timeParse\",\"Tip\",\"$tip\",\"setContent\",\"setPosition\",\"BaseChart\",\"$chart\",\"chartBaseClass\",\"dataTable\",\"timeFormatLocale\",\"svg\",\"globalSettings\",\"formats\",\"d3Formats\",\"formatLocaleDefinition\",\"timeFormatLocaleDefinition\",\"d3TimeFormatLocaleDefinition\",\"resize\",\"baseSettings\",\"draw\",\"chartClass\",\"onAfterDrawTicks\",\"tickKey\",\"tick\",\"$tickText\",\"numberFormat\",\"percentFormat\",\"currencyFormat\",\"shortDateFormats\",\"day\",\"month\",\"year\",\"bottom\",\"colors\",\"Area\",\"tip\",\"drawingArea\",\"getChartMargin\",\"translateX\",\"translateY\",\"drawTicks\",\"drawAxes\",\"drawChart\",\"drawTipTriggers\",\"getX\",\"xAxis\",\"axisBottom\",\"tickFormat\",\"getXFormatter\",\"ticks\",\"yAxis\",\"getY\",\"axisLeft\",\"getYFormatter\",\"tickValues\",\"getYTickValues\",\"axisRight\",\"showAxis\",\"tickSizeOuter\",\"gridlines\",\"xLineAxis\",\"tickSize\",\"yLineAxis\",\"line\",\"datum\",\"style\",\"area\",\"y0\",\"y1\",\"plots\",\"enter\",\"tips\",\"chartMargin\",\"xAxisTickInterval\",\"node\",\"getTotalLength\",\"tipTriggerWidth\",\"$content\",\"$xValue\",\"$yValue\",\"content\",\"calcLeft\",\"values\",\"yTicksMaxWidth\",\"computedTickWidth\",\"padded\",\"xDomainMin\",\"xDomainMax\",\"xDomain\",\"scaleTime\",\"domain\",\"yDomain\",\"getYMaxValue\",\"scaleLinear\",\"utils\",\"getTimeFormatter\",\"getNumberFormatter\",\"maxValue\",\"getDuration\",\"secondsNum\",\"chartSettings\",\"dataScale\",\"ColorInput\",\"$colorContainer\",\"$colorPreview\",\"$colorInput\",\"createColorInput\",\"handleTextChange\",\"setAttribute\",\"updateColor\",\"_browserSupportsColorInputs\",\"doesBrowserSupportColorInputs\",\"CP\",\"authManager\",\"$nav\",\"$mainContainer\",\"$alerts\",\"$crumbs\",\"$notificationContainer\",\"$primaryForm\",\"$mainContent\",\"$details\",\"$selectedTab\",\"$contentContainer\",\"$edition\",\"$collapsibleTables\",\"fixedHeader\",\"enableQueue\",\"jobInfo\",\"displayedJobInfo\",\"displayedJobInfoUnchanged\",\"trackJobProgressTimeout\",\"jobProgressIcon\",\"checkingForUpdates\",\"forcingRefreshOnUpdatesCheck\",\"checkForUpdatesCallbacks\",\"updateFixedHeader\",\"updateResponsiveTables\",\"$errorNotifications\",\"$otherNotifications\",\"delay\",\"notificationDuration\",\"initAlerts\",\"isCtrlKeyPressed\",\"S_KEY\",\"submitPrimaryForm\",\"initTabs\",\"initConfirmUnloadForms\",\"$confirmUnloadForms\",\"serialized\",\"confirmUnload\",\"livePreview\",\"inPreviewMode\",\"originalEvent\",\"returnValue\",\"_handleInputFocus\",\"_handleInputBlur\",\"saveShortcut\",\"$label\",\"toggleNav\",\"toggleClass\",\"toggleSidebar\",\"tabs\",\"tabWidths\",\"totalWidth\",\"selectTab\",\"tab\",\"deselectTab\",\"_i\",\"_$table\",\"_containerWidth\",\"_check\",\"_isCollapsed\",\"getBoundingClientRect\",\"headerHeight\",\"max-height\",\"fixedheader\",\"displayNotification\",\"$notification\",\"fadedMargin\",\"margin-left\",\"margin-right\",\"display\",\"notificationType\",\"fetchAlerts\",\"displayAlerts\",\"alerts\",\"margin-top\",\"$shunnableAlerts\",\"$link\",\"checkForUpdates\",\"forceRefresh\",\"realCallback\",\"updateUtilitiesBadge\",\"callbacks\",\"updateInfo\",\"$utilitiesLink\",\"$badge\",\"badgeCount\",\"runQueueAutomatically\",\"trackJobProgress\",\"_trackJobProgressInternal\",\"setJobInfo\",\"animateIcon\",\"oldInfo\",\"getDisplayedJobInfo\",\"progressLabel\",\"updateJobIcon\",\"statuses\",\"JOB_STATUS_RESERVED\",\"JOB_STATUS_FAILED\",\"JOB_STATUS_WAITING\",\"j\",\"JobProgressIcon\",\"hideFailMode\",\"setDescription\",\"description\",\"setProgress\",\"showFailMode\",\"JOB_STATUS_DONE\",\"failMode\",\"_canvasSupported\",\"_$bgCanvas\",\"_$staticCanvas\",\"_$hoverCanvas\",\"_$failCanvas\",\"_staticCtx\",\"_hoverCtx\",\"_canvasSize\",\"_arcPos\",\"_arcRadius\",\"_lineWidth\",\"_arcStartPos\",\"_arcEndPos\",\"_arcStartStepSize\",\"_arcEndStepSize\",\"_arcStep\",\"_arcStepTimeout\",\"_arcAnimateCallback\",\"_progressBar\",\"$canvasContainer\",\"_createCanvas\",\"_drawArc\",\"_animateArc\",\"_setArc\",\"$innerProgressBar\",\"toggleHud\",\"toggle\",\"QueueHUD\",\"color\",\"$canvas\",\"ctx\",\"lineCap\",\"startPos\",\"arc\",\"closePath\",\"targetStartPos\",\"targetEndPos\",\"_takeNextArcStep\",\"jobsById\",\"completedJobs\",\"updateViewProxy\",\"updateView\",\"newJobIds\",\"updateStatus\",\"Job\",\"placed\",\"$object\",\"$statusContainer\",\"$descriptionContainer\",\"$progressLabel\",\"$flex\",\"empty\",\"$actionBtn\",\"performErrorAction\",\"$elementIndexSourcesContainer\",\"$sourcesContainer\",\"$sourceSettingsContainer\",\"$newHeadingBtn\",\"$footerBtnContainer\",\"$saveSpinner\",\"$loadingSpinner\",\"sourceSort\",\"updateSourcesOnSave\",\"availableTableAttributes\",\"setContainer\",\"buildModal\",\"addSource\",\"sourceData\",\"$itemLabel\",\"$itemInput\",\"heading\",\"Heading\",\"updateItemLabel\",\"Source\",\"handleNewHeadingBtnClick\",\"scrollContainerToElement\",\"$pendingHeading\",\"$lastSource\",\"$indexSource\",\"getIndexSource\",\"isHeading\",\"appendSource\",\"$extraSources\",\"nextAll\",\"BaseSource\",\"$settingsContainer\",\"isSelected\",\"deselect\",\"createSettings\",\"tableAttributes\",\"firstAttribute\",\"firstKey\",\"firstLabel\",\"$titleColumnCheckbox\",\"createTableColumnOption\",\"$columnCheckboxes\",\"selectedAttributes\",\"createField\",\"instructions\",\"createCheckbox\",\"disabled\",\"$labelField\",\"$labelInput\",\"handleLabelInputChange\",\"deleteHeading\",\"table\",\"$rows\",\"caboose\",\"Y_AXIS\",\"getHelper\",\"$helperRow\",\"helperClass\",\"$cells\",\"DeleteUserModal\",\"userId\",\"$deleteActionRadios\",\"$deleteSpinner\",\"userSelect\",\"_deleting\",\"idParam\",\"redirect\",\"contentSummary\",\"$deleteSubmitBtn\",\"validateDeleteInputs\",\"validates\",\"handleSubmit\",\"DraftEditor\",\"$revisionBtn\",\"$revisionLabel\",\"$statusIcon\",\"$editMetaBtn\",\"metaHud\",\"$nameTextInput\",\"$notesTextInput\",\"$saveMetaBtn\",\"lastSerializedValue\",\"saving\",\"saveXhr\",\"checkFormAfterUpdate\",\"submittingForm\",\"duplicatedElements\",\"preview\",\"previewToken\",\"previewTargets\",\"enablePreview\",\"$shareBtn\",\"openShareLink\",\"createShareMenu\",\"revisionId\",\"serializeForm\",\"draftId\",\"initForDraft\",\"createDraft\",\"canUpdateSource\",\"createEditMetaBtn\",\"statusIcons\",\"showStatusHud\",\"bodyHtml\",\"spinners\",\"getPreviewToken\",\"Promise\",\"resolve\",\"reject\",\"sourceId\",\"getTokenizedPreviewUrl\",\"randoParam\",\"isLive\",\"then\",\"catch\",\"open\",\"getPreview\",\"Preview\",\"openPreview\",\"ensureIsDraftOrRevision\",\"revisionid\",\"removeActionParams\",\"isPreviewActive\",\"$editor\",\"isUnsavedDraft\",\"saveDraft\",\"isActive\",\"$spinners\",\"$statusIcons\",\"saveDraftAction\",\"prepareData\",\"docTitle\",\"draftName\",\"draftNotes\",\"revisionMenu\",\"draftCreated\",\"newHref\",\"anchorPos\",\"$saveBtnContainer\",\"elementTypeDisplayName\",\"$saveDraftBtn\",\"canDeleteDraft\",\"$draftsUl\",\"$draftHeading\",\"$draftLi\",\"$draftA\",\"selectOption\",\"$siteOptions\",\"$siteOption\",\"creator\",\"updatePreviewTargets\",\"afterUpdate\",\"checkMetaValues\",\"oldId\",\"currentTargets\",\"showMetaHud\",\"createMetaHud\",\"onMetaHudShow\",\"$field\",\"$hudBody\",\"$deleteLink\",\"saveMeta\",\"onMetaHudHide\",\"onMetaHudEscape\",\"onNotesKeydown\",\"submit\",\"shakeMetaHud\",\"deleteDraft\",\"deleteDraftAction\",\"handleFormSubmit\",\"abort\",\"chunks\",\"accept-charset\",\"enctype\",\"method\",\"decodeURIComponent\",\"applyDraftAction\",\"hashedRedirectUrl\",\"DynamicGenerator\",\"EditableTable\",\"baseName\",\"biggestId\",\"$addRowBtn\",\"rowCount\",\"hasMaxRows\",\"hasMinRows\",\"radioCheckboxes\",\"log\",\"copyDraggeeInputValuesToHelper\",\"isVisible\",\"initialize\",\"minRows\",\"createRowObj\",\"updateAddRowButton\",\"initializeIfVisible\",\"canAddRow\",\"canDeleteRow\",\"deleteRow\",\"$tr\",\"onDeleteRow\",\"staticRows\",\"maxRows\",\"focus\",\"rowId\",\"rowIdPrefix\",\"createRow\",\"defaultValues\",\"onAddRow\",\"Row\",\"focusOnPrevRow\",\"tdIndex\",\"blurTd\",\"prevRow\",\"$prevTr\",\"$tds\",\"focusOnNextRow\",\"nextRow\",\"$nextTr\",\"textualColTypes\",\"data-id\",\"colId\",\"$cell\",\"col\",\"scope\",\"textual\",\"code\",\"small\",\"createDateInput\",\"createLightswitch\",\"createSelect\",\"default\",\"createTimeInput\",\"createTextInput\",\"niceTexts\",\"tds\",\"$textareas\",\"tr\",\"td\",\"$textarea\",\"$checkbox\",\"textareasByColId\",\"onHeightChange\",\"radioMode\",\"applyToggleCheckbox\",\"onTextareaHeightChange\",\"autopopulate\",\"HandleGenerator\",\"allowNonAlphaStart\",\"last\",\"onTextareaFocus\",\"onRadioCheckboxChange\",\"checkbox\",\"checkboxColId\",\"neg\",\"checkboxCol\",\"colum\",\"ignoreNextTextareaFocus\",\"handleKeypress\",\"charCode\",\"ctrl\",\"numericKeyCodes\",\"validateValue\",\"safeValue\",\"tallestTextareaHeight\",\"tdHeight\",\"ElementActionTrigger\",\"maxLevels\",\"newChildUrl\",\"$trigger\",\"triggerEnabled\",\"activate\",\"updateTrigger\",\"validateSelection\",\"enableTrigger\",\"disableTrigger\",\"valid\",\"batch\",\"handleTriggerActivation\",\"queue\",\"workers\",\"Worker\",\"concat\",\"toArray\",\"active\",\"loadNext\",\"loader\",\"$img\",\"alt\",\"ElevatedSessionForm\",\"inputs\",\"form\",\"$inputs\",\"getInputPostVal\",\"elevatedSessionManager\",\"fetchingTimeout\",\"inputsChanged\",\"$currentInput\",\"requireElevatedSession\",\"submitForm\",\"ElevatedSessionManager\",\"passwordModal\",\"$submitBtn\",\"$errorPara\",\"minSafeElevatedSessionTimeout\",\"showPasswordModal\",\"$passwordModal\",\"focusPasswordInput\",\"submitPassword\",\"currentPassword\",\"showPasswordError\",\"EntryIndex\",\"publishableSections\",\"$newEntryBtnGroup\",\"$newEntryBtn\",\"section\",\"defaultSectionHandle\",\"selectedSection\",\"_getSectionTriggerHref\",\"_openCreateEntryModal\",\"site\",\"sectionId\",\"newEntryBtnText\",\"typeId\",\"entryTypes\",\"sectionSourceKey\",\"FieldLayoutDesigner\",\"$tabContainer\",\"$unusedFieldContainer\",\"$newTabBtn\",\"$allFields\",\"tabGrid\",\"unusedFieldGrid\",\"tabDrag\",\"fieldDrag\",\"gridSettings\",\"initTab\",\"FieldDrag\",\"customizableTabs\",\"TabDrag\",\"$editBtn\",\"$fields\",\"initField\",\"onTabOptionSelect\",\"renameTab\",\"deleteTab\",\"onFieldOptionSelect\",\"toggleRequiredField\",\"removeField\",\"$labelSpan\",\"getFieldInputName\",\"removeFieldById\",\"requiredFieldInputName\",\"refreshCols\",\"$group\",\"addTab\",\"tabName\",\"fieldInputName\",\"BaseDrag\",\"Drag\",\"designer\",\"$insertion\",\"showingInsertion\",\"$caboose\",\"draggingUnusedItem\",\"addToTabGrid\",\"getInsertion\",\"addCaboose\",\"setMidpoints\",\"getItemContainer\",\"isItemInTabContainer\",\"onDrag\",\"hitTest\",\"_closestItem\",\"getClosestItem\",\"_closestItemMouseDiff\",\"_$item\",\"_midpoint\",\"_mouseDiff\",\"getDist\",\"draggeeDisplay\",\"visibility\",\"$hiddenFields\",\"$fieldContainers\",\"targetPrefix\",\"targetSelector\",\"reverseTargetSelector\",\"_$target\",\"_$reverseTarget\",\"getType\",\"normalizeTargetSelector\",\"findTargets\",\"selector\",\"getToggleVal\",\"postVal\",\"onToggleChange\",\"hideTarget\",\"showTarget\",\"_show\",\"_currentHeight\",\"_targetHeight\",\"overflow\",\"items\",\"totalCols\",\"colGutterDrop\",\"colPctWidth\",\"possibleItemColspans\",\"possibleItemPositionsByColspan\",\"itemPositions\",\"itemColspansByPosition\",\"layouts\",\"layout\",\"itemHeights\",\"leftPadding\",\"_refreshingCols\",\"_refreshColsAfterRefresh\",\"_forceRefreshColsAfterRefresh\",\"handleContainerHeightProxy\",\"setItems\",\"_\",\"oldHeight\",\"scrollHeight\",\"gutter\",\"itemIndex\",\"tallestItemHeight\",\"colIndex\",\"itemHeight\",\"remainder\",\"itemHeightsByColspan\",\"positionRight\",\"positionLeft\",\"minColspan\",\"maxColspan\",\"colspan\",\"getItemWidthCss\",\"minPosition\",\"maxPosition\",\"colHeights\",\"createLayouts\",\"layoutTotalCols\",\"highestTotalCols\",\"layoutHeights\",\"shortestHeight\",\"shortestLayouts\",\"emptySpaces\",\"emptySpace\",\"colspans\",\"getItemLeftPosCss\",\"positions\",\"isSimpleLayout\",\"margin-bottom\",\"positionItems\",\"completeRefreshCols\",\"onRefreshCols\",\"getItemWidth\",\"getItemWidthInPx\",\"getItemLeftPosInPx\",\"prevPositions\",\"prevColspans\",\"prevColHeights\",\"prevEmptySpace\",\"LayoutGenerator\",\"endingCol\",\"affectedColHeights\",\"onItemResize\",\"newHeight\",\"tallestColHeightsByPosition\",\"p\",\"colHeightsForPosition\",\"tallestColHeight\",\"words\",\"ImageUpload\",\"initImageUpload\",\"containerSelector\",\"uploadAction\",\"postParameters\",\"fileInputSelector\",\"paramName\",\"uploadParamName\",\"fileuploadfail\",\"initButtons\",\"uploadButtonSelector\",\"deleteButtonSelector\",\"refreshImage\",\"onAfterRefreshImage\",\"_onUploadError\",\"$icon\",\"hudClass\",\"dragger\",\"dragStartMargin\",\"outerContainer\",\"X_AXIS\",\"turnOn\",\"turnOff\",\"_getOffMargin\",\"_onMouseDown\",\"_onMouseUp\",\"dragging\",\"RIGHT_KEY\",\"LEFT_KEY\",\"_getMargin\",\"_onDrag\",\"mouseDistX\",\"_onDragStop\",\"_onSettle\",\"LivePreview\",\"$extraFields\",\"$dragHandle\",\"$iframeContainer\",\"$iframe\",\"$fieldPlaceholder\",\"previewUrl\",\"basePostData\",\"fields\",\"lastPostData\",\"updateIframeInterval\",\"loading\",\"checkAgain\",\"dragStartEditorWidth\",\"_slideInOnIframeLoad\",\"_handleSuccessProxy\",\"_handleErrorProxy\",\"_forceUpdateIframeProxy\",\"_scrollX\",\"_scrollY\",\"_editorWidth\",\"_editorWidthInPx\",\"protocol\",\"previewParams\",\"extraFields\",\"defaultEditorWidth\",\"moveFieldsBack\",\"editorWidthInPx\",\"inPx\",\"minEditorWidthInPx\",\"exit\",\"$editorHeader\",\"$closeBtn\",\"handleWindowResize\",\"dragHandleWidth\",\"getIframeWidth\",\"$clone\",\"_getClone\",\"updateIframe\",\"slideIn\",\"createToken\",\"previewAction\",\"updateWidths\",\"ESC_KEY\",\"$newClone\",\"field\",\"contentWindow\",\"scrollLeft\",\"X-Craft-Token\",\"xhrFields\",\"withCredentials\",\"crossDomain\",\"forceUpdateIframe\",\"handleSuccess\",\"write\",\"close\",\"onResponse\",\"handleError\",\"copyInputValues\",\"$textInput\",\"$showPasswordToggle\",\"showingPassword\",\"passwordInput\",\"hidePassword\",\"setCurrentInput\",\"updateToggleLabel\",\"showPassword\",\"togglePassword\",\"onKeyDown\",\"ALT_KEY\",\"onKeyUp\",\"onInputChange\",\"onToggleMouseDown\",\"$previewContainer\",\"$targetBtn\",\"$targetMenu\",\"$tempInput\",\"activeTarget\",\"_updateIframeProxy\",\"$previewHeader\",\"switchTarget\",\"resetScroll\",\"sameHost\",\"scrolllTop\",\"frameborder\",\"afterUpdateIframe\",\"defaultSettings\",\"_onHide\",\"instance\",\"loadAsset\",\"focusItem\",\"desiredHeight\",\"desiredWidth\",\"containerHeight\",\"containerWidth\",\"minGutter\",\"_resizeContainer\",\"modalHtml\",\"$highlight\",\"Prism\",\"highlightElement\",\"maxWidth\",\"maxHeight\",\"max-width\",\"$progressBarStatus\",\"_itemCount\",\"_processedItemCount\",\"_displaySteps\",\"displaySteps\",\"setProcessedItemCount\",\"fadeTo\",\"incrementItemCount\",\"percentage\",\"$modalContainerDiv\",\"$prompt\",\"$promptApplyToRemainingContainer\",\"$promptApplyToRemainingCheckbox\",\"$promptApplyToRemainingLabel\",\"$pomptChoices\",\"_prompts\",\"_promptBatchCallback\",\"_promptBatchReturnData\",\"_promptBatchNum\",\"_showNextPromptInBatch\",\"remainingInBatch\",\"_showPrompt\",\"_handleBatchPromptSelection\",\"applyToRemaining\",\"choiceData\",\"itemsToGo\",\"_promptCallback\",\"$promptMessage\",\"$promptChoices\",\"$promptButtons\",\"$cancelButton\",\"$radioButton\",\"_selectPromptChoice\",\"fadeOut\",\"_cancelPrompt\",\"$selectedOption\",\"startPositionX\",\"graduationsMin\",\"graduationsMax\",\"slideMin\",\"slideMax\",\"$overlay\",\"$cursor\",\"$graduations\",\"$graduationsUl\",\"graduationsCalculatedWidth\",\"_handleResize\",\"valueToPosition\",\"_handleTapStart\",\"touch\",\"startLeft\",\"_handleTapMove\",\"curX\",\"positionToValue\",\"_handleTapEnd\",\"scaleMin\",\"scaleMax\",\"SlugGenerator\",\"allowUppercaseInSlug\",\"limitAutoSlugsToAscii\",\"XRegExp\",\"matchChain\",\"slugWordSeparator\",\"Structure\",\"structureDrag\",\"$parents\",\"initToggle\",\"StructureDrag\",\"initNewChildMenus\",\"viewStateKey\",\"$addBtns\",\"onNewChildMenuClick\",\"showMenu\",\"getIndent\",\"level\",\"baseIndent\",\"nestedIndent\",\"addElement\",\"$addBtn\",\"$parentUl\",\"_removeUl\",\"structure\",\"draggeeLevel\",\"$helperLi\",\"$targets\",\"draggeeHeight\",\"$level\",\"cancelDrag\",\"$lis\",\"$closestTarget\",\"closestTargetPos\",\"closestTargetYDiff\",\"closestTargetOffset\",\"closestTargetHeight\",\"targetOffset\",\"targetHeight\",\"targetYMidpoint\",\"targetYDiff\",\"$closestTargetLi\",\"closestTargetLevel\",\"$nextTargetLi\",\"nextTargetLevel\",\"hoveringBetweenRows\",\"draggeeX\",\"targetItemMouseDiffX\",\"$parentLis\",\"$closestParentLi\",\"closestParentLiXDiff\",\"closestParentLevel\",\"$parentLi\",\"parentLiX\",\"parentLiXDiff\",\"parentLevel\",\"onMouseUp\",\"$draggeeParent\",\"moved\",\"$closestSiblings\",\"newLevel\",\"setLevel\",\"structureId\",\"prevId\",\"indent\",\"$childLis\",\"StructureTableSorter\",\"tableView\",\"_helperMargin\",\"_$titleHelperCell\",\"_titleHelperCellOuterWidth\",\"_ancestors\",\"_updateAncestorsFrame\",\"_updateAncestorsProxy\",\"_draggeeLevel\",\"_draggeeLevelDelta\",\"draggingLastElements\",\"_loadingDraggeeLevelDelta\",\"_targetLevel\",\"_targetLevelBounds\",\"_positionChanged\",\"singleHelper\",\"helperSpacingY\",\"startDragging\",\"HELPER_MARGIN\",\"findDraggee\",\"$nextRow\",\"nextRowLevel\",\"nextRowLevelDelta\",\"_getAjaxBaseData\",\"delta\",\"drag\",\"padding\",\"BASE_PADDING\",\"canInsertBefore\",\"_getLevelBounds\",\"canInsertAfter\",\"_getAncestors\",\"_setTargetLevelBounds\",\"_updateIndent\",\"onInsertionPointChange\",\"_updateAncestorsBeforeRepaint\",\"levelDiff\",\"_getLevelIndent\",\"$prevRow\",\"prevRowLevel\",\"$spinnerRow\",\"_createSpinnerRowAfter\",\"onPositionChange\",\"_expandElement\",\"onReturnHelpersToDraggees\",\"newDraggeeIndexes\",\"oldDraggeeIndexes\",\"$postDraggeeItems\",\"_minLevel\",\"_maxLevel\",\"forcePositionChange\",\"_mouseDist\",\"realMouseX\",\"mousedownX\",\"_indentationDist\",\"LEVEL_INDENT\",\"_targetLevelMouseDiff\",\"_magnetImpact\",\"MAX_GIVE\",\"_closestLevelMagnetIndent\",\"helpers\",\"targetLevel\",\"_level\",\"_$prevRow\",\"cancelAnimationFrame\",\"_updateAncestors\",\"_$ancestor\",\"_newAncestors\",\"$selectedSortHeader\",\"structureTableSort\",\"_totalVisiblePostStructureTableDraggee\",\"_morePendingPostStructureTableDraggee\",\"initTableHeaders\",\"_collapseElement\",\"selectedSortAttr\",\"$tableHeaders\",\"selectedSortDir\",\"_isStructureTableDraggingLastElements\",\"positionedAfter\",\"includeTableAttributesForSource\",\"_updateTableAttributes\",\"$nextNextRow\",\"descendantOf\",\"$nextRows\",\"_handleSelectedSortHeaderClick\",\"newSortDir\",\"_handleSortHeaderClick\",\"_handleUnselectedSortHeaderClick\",\"TagSelectInput\",\"searchMenu\",\"$addTagInput\",\"_ignoreBlur\",\"selectTag\",\"searchForTags\",\"killSearchMenu\",\"excludeIds\",\"tagGroupId\",\"tags\",\"exclude\",\"exactMatch\",\"Menu\",\"attachToElement\",\"data-site-id\",\"targetSiteId\",\"data-label\",\"data-editable\",\"$titleContainer\",\"config\",\"maxlength\",\"autofocus\",\"getAutofocusValue\",\"autocomplete\",\"getDisabledValue\",\"readonly\",\"step\",\"showCharsLeft\",\"createTextarea\",\"createTextareaField\",\"$select\",\"data-target-prefix\",\"$optgroup\",\"optgroup\",\"optionLabel\",\"optionValue\",\"optionDisabled\",\"selected\",\"createSelectField\",\"data-target\",\"data-reverse-target\",\"reverseToggle\",\"for\",\"createCheckboxField\",\"createCheckboxSelect\",\"allValue\",\"allChecked\",\"showAllOption\",\"allLabel\",\"createCheckboxSelectField\",\"data-value\",\"aria-labelledby\",\"labelId\",\"createLightswitchField\",\"containerId\",\"$colorPreviewContainer\",\"createColorField\",\"getMonth\",\"formattedValue\",\"timezone\",\"defaultDate\",\"createDateField\",\"timepicker\",\"timepickerOptions\",\"getHours\",\"getMinutes\",\"getSeconds\",\"createTimeField\",\"required\",\"warning\",\"addErrorsToField\",\"addErrorsToList\",\"$errors\",\"clearErrorsFromField\",\"_rejectedFiles\",\"_extensionList\",\"_totalFileCounter\",\"_validFileCounter\",\"autoUpload\",\"fileupload\",\"paramObject\",\"getInProgress\",\"onFileAdd\",\"validateExtension\",\"_createExtensionList\",\"process\",\"done\",\"pass\",\"fileExtension\",\"maxFileSize\",\"originalFiles\",\"processErrorMessages\",\"kinds\",\"humanFileSize\",\"maxUploadSize\",\"bytes\",\"u\",\"toFixed\",\"allowedKind\",\"fileKinds\",\"extensions\",\"pasteZone\",\"sequentialUploads\",\"Accept\",\"UriFormatGenerator\",\"uriFormat\",\"suffix\",\"jQuery\"],\"mappings\":\"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\",\"file\":\"Craft.min.js\"}", "/** global: Craft */\n/** global: Garnish */\n/**\n * Admin table class\n */\nCraft.AdminTable = Garnish.Base.extend(\n    {\n        settings: null,\n        totalItems: null,\n        sorter: null,\n\n        $noItems: null,\n        $table: null,\n        $tbody: null,\n        $deleteBtns: null,\n\n        init: function(settings) {\n            this.setSettings(settings, Craft.AdminTable.defaults);\n\n            if (!this.settings.allowDeleteAll) {\n                this.settings.minItems = 1;\n            }\n\n            this.$noItems = $(this.settings.noItemsSelector);\n            this.$table = $(this.settings.tableSelector);\n            this.$tbody = this.$table.children('tbody');\n            this.totalItems = this.$tbody.children().length;\n\n            if (this.settings.sortable) {\n                this.sorter = new Craft.DataTableSorter(this.$table, {\n                    onSortChange: $.proxy(this, 'reorderItems')\n                });\n            }\n\n            this.$deleteBtns = this.$table.find('.delete:not(.disabled)');\n            this.addListener(this.$deleteBtns, 'click', 'handleDeleteBtnClick');\n\n            this.updateUI();\n        },\n\n        addRow: function(row) {\n            if (this.settings.maxItems && this.totalItems >= this.settings.maxItems) {\n                // Sorry pal.\n                return;\n            }\n\n            var $row = $(row).appendTo(this.$tbody),\n                $deleteBtn = $row.find('.delete');\n\n            if (this.settings.sortable) {\n                this.sorter.addItems($row);\n            }\n\n            this.$deleteBtns = this.$deleteBtns.add($deleteBtn);\n\n            this.addListener($deleteBtn, 'click', 'handleDeleteBtnClick');\n            this.totalItems++;\n\n            this.updateUI();\n        },\n\n        reorderItems: function() {\n            if (!this.settings.sortable) {\n                return;\n            }\n\n            // Get the new field order\n            var ids = [];\n\n            for (var i = 0; i < this.sorter.$items.length; i++) {\n                var id = $(this.sorter.$items[i]).attr(this.settings.idAttribute);\n                ids.push(id);\n            }\n\n            // Send it to the server\n            var data = {\n                ids: JSON.stringify(ids)\n            };\n\n            Craft.postActionRequest(this.settings.reorderAction, data, $.proxy(function(response, textStatus) {\n                if (textStatus === 'success') {\n                    if (response.success) {\n                        this.onReorderItems(ids);\n                        Craft.cp.displayNotice(Craft.t('app', this.settings.reorderSuccessMessage));\n                    }\n                    else {\n                        Craft.cp.displayError(Craft.t('app', this.settings.reorderFailMessage));\n                    }\n                }\n\n            }, this));\n        },\n\n        handleDeleteBtnClick: function(event) {\n            if (this.settings.minItems && this.totalItems <= this.settings.minItems) {\n                // Sorry pal.\n                return;\n            }\n\n            var $row = $(event.target).closest('tr');\n\n            if (this.confirmDeleteItem($row)) {\n                this.deleteItem($row);\n            }\n        },\n\n        confirmDeleteItem: function($row) {\n            var name = this.getItemName($row);\n            return confirm(Craft.t('app', this.settings.confirmDeleteMessage, {name: name}));\n        },\n\n        deleteItem: function($row) {\n            var data = {\n                id: this.getItemId($row)\n            };\n\n            Craft.postActionRequest(this.settings.deleteAction, data, $.proxy(function(response, textStatus) {\n                if (textStatus === 'success') {\n                    this.handleDeleteItemResponse(response, $row);\n                }\n            }, this));\n        },\n\n        handleDeleteItemResponse: function(response, $row) {\n            var id = this.getItemId($row),\n                name = this.getItemName($row);\n\n            if (response.success) {\n                if (this.sorter) {\n                    this.sorter.removeItems($row);\n                }\n\n                $row.remove();\n                this.totalItems--;\n                this.updateUI();\n                this.onDeleteItem(id);\n\n                Craft.cp.displayNotice(Craft.t('app', this.settings.deleteSuccessMessage, {name: name}));\n            }\n            else {\n                Craft.cp.displayError(Craft.t('app', this.settings.deleteFailMessage, {name: name}));\n            }\n        },\n\n        onReorderItems: function(ids) {\n            this.settings.onReorderItems(ids);\n        },\n\n        onDeleteItem: function(id) {\n            this.settings.onDeleteItem(id);\n        },\n\n        getItemId: function($row) {\n            return $row.attr(this.settings.idAttribute);\n        },\n\n        getItemName: function($row) {\n            return Craft.escapeHtml($row.attr(this.settings.nameAttribute));\n        },\n\n        updateUI: function() {\n            // Show the \"No Whatever Exists\" message if there aren't any\n            if (this.totalItems === 0) {\n                this.$table.hide();\n                this.$noItems.removeClass('hidden');\n            }\n            else {\n                this.$table.show();\n                this.$noItems.addClass('hidden');\n            }\n\n            // Disable the sort buttons if there's only one row\n            if (this.settings.sortable) {\n                var $moveButtons = this.$table.find('.move');\n\n                if (this.totalItems === 1) {\n                    $moveButtons.addClass('disabled');\n                }\n                else {\n                    $moveButtons.removeClass('disabled');\n                }\n            }\n\n            // Disable the delete buttons if we've reached the minimum items\n            if (this.settings.minItems && this.totalItems <= this.settings.minItems) {\n                this.$deleteBtns.addClass('disabled');\n            }\n            else {\n                this.$deleteBtns.removeClass('disabled');\n            }\n\n            // Hide the New Whatever button if we've reached the maximum items\n            if (this.settings.newItemBtnSelector) {\n                if (this.settings.maxItems && this.totalItems >= this.settings.maxItems) {\n                    $(this.settings.newItemBtnSelector).addClass('hidden');\n                }\n                else {\n                    $(this.settings.newItemBtnSelector).removeClass('hidden');\n                }\n            }\n        }\n    },\n    {\n        defaults: {\n            tableSelector: null,\n            noItemsSelector: null,\n            newItemBtnSelector: null,\n            idAttribute: 'data-id',\n            nameAttribute: 'data-name',\n            sortable: false,\n            allowDeleteAll: true,\n            minItems: 0,\n            maxItems: null,\n            reorderAction: null,\n            deleteAction: null,\n            reorderSuccessMessage: Craft.t('app', 'New order saved.'),\n            reorderFailMessage: Craft.t('app', 'Couldn\u2019t save new order.'),\n            confirmDeleteMessage: Craft.t('app', 'Are you sure you want to delete \u201c{name}\u201d?'),\n            deleteSuccessMessage: Craft.t('app', '\u201c{name}\u201d deleted.'),\n            deleteFailMessage: Craft.t('app', 'Couldn\u2019t delete \u201c{name}\u201d.'),\n            onReorderItems: $.noop,\n            onDeleteItem: $.noop\n        }\n    });\n"], "filenames": ["CHANGELOG-v3.md", "src/web/assets/cp/dist/js/Craft.js", "src/web/assets/cp/dist/js/Craft.min.js", "src/web/assets/cp/dist/js/Craft.min.js.map", "src/web/assets/cp/src/js/AdminTable.js"], "buggy_code_start_loc": [17, 1, 1, 1, 138], "buggy_code_end_loc": [17, 4976, 2, 2, 159], "fixing_code_start_loc": [18, 1, 1, 1, 138], "fixing_code_end_loc": [21, 4976, 2, 2, 159], "type": "CWE-79", "message": "Craft CMS before 3.3.8 has stored XSS via a name field. This field is mishandled during site deletion.", "other": {"cve": {"id": "CVE-2019-17496", "sourceIdentifier": "cve@mitre.org", "published": "2019-10-11T00:15:10.473", "lastModified": "2019-10-15T18:17:03.250", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Craft CMS before 3.3.8 has stored XSS via a name field. This field is mishandled during site deletion."}, {"lang": "es", "value": "Craft CMS versiones anteriores a la veris\u00f3n  3.3.8, tiene  una vulnerabilidad de tipo XSS almacenado por medio de un campo name. Este campo es manejado inapropiadamente durante la eliminaci\u00f3n del sitio"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:craftcms:craft_cms:*:*:*:*:*:*:*:*", "versionEndExcluding": "3.3.8", "matchCriteriaId": "81762957-B22C-4A18-B40C-DA9296F7DDF8"}]}]}], "references": [{"url": "https://github.com/craftcms/cms/blob/develop/CHANGELOG-v3.md#338---2019-10-09", "source": "cve@mitre.org", "tags": ["Release Notes"]}, {"url": "https://github.com/craftcms/cms/commit/0ee66d29281af2b6c4f866e1437842c61983a672", "source": "cve@mitre.org", "tags": ["Patch"]}]}, "github_commit_url": "https://github.com/craftcms/cms/commit/0ee66d29281af2b6c4f866e1437842c61983a672"}}