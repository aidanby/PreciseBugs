{"buggy_code": ["<?php\n/*\n\tFusionPBX\n\tVersion: MPL 1.1\n\n\tThe contents of this file are subject to the Mozilla Public License Version\n\t1.1 (the \"License\"); you may not use this file except in compliance with\n\tthe License. You may obtain a copy of the License at\n\thttp://www.mozilla.org/MPL/\n\n\tSoftware distributed under the License is distributed on an \"AS IS\" basis,\n\tWITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n\tfor the specific language governing rights and limitations under the\n\tLicense.\n\n\tThe Original Code is FusionPBX\n\n\tThe Initial Developer of the Original Code is\n\tMark J Crane <markjcrane@fusionpbx.com>\n\tCopyright (C) 2008-2012\n\tAll Rights Reserved.\n\n\tContributor(s):\n\tMark J Crane <markjcrane@fusionpbx.com>\n*/\n\n//includes\n\tinclude \"root.php\";\n\trequire_once \"resources/require.php\";\n\trequire_once \"resources/check_auth.php\";\n\n//check permisions\n\tif (permission_exists('xml_cdr_delete')) {\n\t\t//access granted\n\t}\n\telse {\n\t\techo \"access denied\";\n\t\texit;\n\t}\n\n//add multi-lingual support\n\t$language = new text;\n\t$text = $language->get();\n\n//get posted values, if any\n\tif (sizeof($_REQUEST) > 0) {\n\t\t$xml_cdr_uuids = $_REQUEST[\"id\"];\n\t\t$recording_file_path = $_REQUEST[\"rec\"];\n\n\t\tif (sizeof($xml_cdr_uuids) > 0) {\n\t\t\tforeach ($xml_cdr_uuids as $index => $xml_cdr_uuid) {\n\t\t\t\t// delete record from v_xml_cdr\n\t\t\t\t$sql = \"delete from v_xml_cdr \";\n\t\t\t\t$sql .= \"where xml_cdr_uuid = '\".$xml_cdr_uuid.\"' \";\n\t\t\t\t$prep_statement = $db->prepare(check_sql($sql));\n\t\t\t\t$prep_statement->execute();\n\t\t\t\tunset($sql, $prep_statement);\n\t\t\t\t//delete recording from fs and v_call_recordings respectively, if any\n\t\t\t\tif ($recording_file_path[$index] != '' ) {\n\t\t\t\t\t$sql = \"delete from v_call_recordings \";\n\t\t\t\t\t$sql .= \"where call_recording_uuid = '\".$xml_cdr_uuid.\"' \";\n\t\t\t\t\t$prep_statement = $db->prepare(check_sql($sql));\n\t\t\t\t\t$prep_statement->execute();\n\t\t\t\t\tunset($sql, $prep_statement);\n\t\t\t\t\tif (file_exists(base64_decode($recording_file_path[$index]))) {\n\t\t\t\t\t\t@unlink(base64_decode($recording_file_path[$index]));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n//set message and redirect the user\n\t$_SESSION[\"message\"] = $text['message-delete'].\": \".sizeof($xml_cdr_uuids);\n\theader(\"Location: xml_cdr.php\".(($_SESSION['xml_cdr']['last_query'] != '') ? \"?\".$_SESSION['xml_cdr']['last_query'] : null));\n\n?>\n"], "fixing_code": ["<?php\n/*\n\tFusionPBX\n\tVersion: MPL 1.1\n\n\tThe contents of this file are subject to the Mozilla Public License Version\n\t1.1 (the \"License\"); you may not use this file except in compliance with\n\tthe License. You may obtain a copy of the License at\n\thttp://www.mozilla.org/MPL/\n\n\tSoftware distributed under the License is distributed on an \"AS IS\" basis,\n\tWITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n\tfor the specific language governing rights and limitations under the\n\tLicense.\n\n\tThe Original Code is FusionPBX\n\n\tThe Initial Developer of the Original Code is\n\tMark J Crane <markjcrane@fusionpbx.com>\n\tCopyright (C) 2008-2019\n\tAll Rights Reserved.\n\n\tContributor(s):\n\tMark J Crane <markjcrane@fusionpbx.com>\n*/\n\n//includes\n\tinclude \"root.php\";\n\trequire_once \"resources/require.php\";\n\trequire_once \"resources/check_auth.php\";\n\n//check permisions\n\tif (permission_exists('xml_cdr_delete')) {\n\t\t//access granted\n\t}\n\telse {\n\t\techo \"access denied\";\n\t\texit;\n\t}\n\n//add multi-lingual support\n\t$language = new text;\n\t$text = $language->get();\n\n//get posted values, if any\n\tif (sizeof($_REQUEST) > 0) {\n\t\t$xml_cdr_uuids = $_REQUEST[\"id\"];\n\t\tif (sizeof($xml_cdr_uuids) > 0) {\n\t\t\tforeach ($xml_cdr_uuids as $index => $xml_cdr_uuid) {\n\t\t\t\tif (is_uuid($xml_cdr_uuid)) {\n\t\t\t\t\t// delete record from v_xml_cdr\n\t\t\t\t\t$sql = \"delete from v_xml_cdr \";\n\t\t\t\t\t$sql .= \"where xml_cdr_uuid = :xml_cdr_uuid \";\n\t\t\t\t\t$parameters['xml_cdr_uuid'] = $xml_cdr_uuid;\n\t\t\t\t\t$database = new database;\n\t\t\t\t\t$database->execute($sql, $parameters);\n\t\t\t\t\tunset($sql, $parameters);\n\n\t\t\t\t\t//get the call recordings\n\t\t\t\t\t$sql = \"select * from v_call_recordings \";\n\t\t\t\t\t$sql .= \"where call_recording_uuid = :xml_cdr_uuid \";\n\t\t\t\t\t$parameters['xml_cdr_uuid'] = $xml_cdr_uuid;\n\t\t\t\t\t$database = new database;\n\t\t\t\t\t$row = $database->select($sql, $parameters, 'row');\n\t\t\t\t\tunset($sql, $parameters);\n\n\t\t\t\t\t//delete the call recording\n\t\t\t\t\t$call_recording_path = realpath($row['call_recording_path']);\n\t\t\t\t\t$call_recording_name = $row['call_recording_name'];\n\t\t\t\t\tif (file_exists($call_recording_path.'/'.$call_recording_name)) {\n\t\t\t\t\t\t@unlink($call_recording_path.'/'.$call_recording_name);\n\t\t\t\t\t}\n\n\t\t\t\t\t//delete the call recording meta data\n\t\t\t\t\t$sql = \"delete from v_call_recordings \";\n\t\t\t\t\t$sql .= \"where call_recording_uuid = :xml_cdr_uuid \";\n\t\t\t\t\t$parameters['xml_cdr_uuid'] = $xml_cdr_uuid;\n\t\t\t\t\t$database = new database;\n\t\t\t\t\t$database->execute($sql, $parameters);\n\t\t\t\t\tunset($sql, $parameters);\n\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n//set message and redirect the user\n\t$_SESSION[\"message\"] = $text['message-delete'].\": \".sizeof($xml_cdr_uuids);\n\theader(\"Location: xml_cdr.php\");\n\n?>\n"], "filenames": ["app/xml_cdr/xml_cdr_delete.php"], "buggy_code_start_loc": [20], "buggy_code_end_loc": [76], "fixing_code_start_loc": [20], "fixing_code_end_loc": [90], "type": "CWE-22", "message": "In FusionPBX up to v4.5.7, the file app\\xml_cdr\\xml_cdr_delete.php uses an unsanitized \"rec\" variable coming from the URL, which is base64 decoded and allows deletion of any file of the system.", "other": {"cve": {"id": "CVE-2019-16985", "sourceIdentifier": "cve@mitre.org", "published": "2019-10-21T16:15:18.057", "lastModified": "2023-02-03T21:36:26.750", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "In FusionPBX up to v4.5.7, the file app\\xml_cdr\\xml_cdr_delete.php uses an unsanitized \"rec\" variable coming from the URL, which is base64 decoded and allows deletion of any file of the system."}, {"lang": "es", "value": "En FusionPBX versiones hasta v4.5.7, el archivo app\\xml_cdr\\xml_cdr_delete.php utiliza una variable \"rec\" no saneada que proviene de la URL, que es decodificada en base64 y permite la eliminaci\u00f3n de cualquier archivo del sistema."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:H/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "NONE", "integrityImpact": "HIGH", "availabilityImpact": "NONE", "baseScore": 6.5, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 3.6}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:S/C:N/I:C/A:C", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "SINGLE", "confidentialityImpact": "NONE", "integrityImpact": "COMPLETE", "availabilityImpact": "COMPLETE", "baseScore": 8.5}, "baseSeverity": "HIGH", "exploitabilityScore": 8.0, "impactScore": 9.2, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-22"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:fusionpbx:fusionpbx:*:*:*:*:*:*:*:*", "versionEndIncluding": "4.5.7", "matchCriteriaId": "A5A0C1F9-8032-46C6-8DD4-DB91FACF7330"}]}]}], "references": [{"url": "https://github.com/fusionpbx/fusionpbx/commit/284b0a91968f126fd6be0a486a84e065926905ca", "source": "cve@mitre.org", "tags": ["Patch"]}, {"url": "https://resp3ctblog.wordpress.com/2019/10/19/fusionpbx-path-traversal-1/", "source": "cve@mitre.org", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/fusionpbx/fusionpbx/commit/284b0a91968f126fd6be0a486a84e065926905ca"}}