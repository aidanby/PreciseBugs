{"buggy_code": ["<%--\n\n    The contents of this file are subject to the license and copyright\n    detailed in the LICENSE and NOTICE files at the root of the source\n    tree and available online at\n\n    http://www.dspace.org/license/\n\n--%>\n\n<%--\n  - Display the form to refine the simple-search and dispaly the results of the search\n  -\n  - Attributes to pass in:\n  -\n  -   scope            - pass in if the scope of the search was a community\n  -                      or a collection\n  -   scopes \t\t   - the list of available scopes where limit the search\n  -   sortOptions\t   - the list of available sort options\n  -   availableFilters - the list of filters available to the user\n  -\n  -   query            - The original query\n  -   queryArgs\t\t   - The query configuration parameters (rpp, sort, etc.)\n  -   appliedFilters   - The list of applied filters (user input or facet)\n  -\n  -   search.error     - a flag to say that an error has occurred\n  -   spellcheck\t   - the suggested spell check query (if any)\n  -   qResults\t\t   - the discovery results\n  -   items            - the results.  An array of Items, most relevant first\n  -   communities      - results, Community[]\n  -   collections      - results, Collection[]\n  -\n  -   admin_button     - If the user is an admin\n  --%>\n\n<%@page import=\"org.dspace.core.Utils\"%>\n<%@page import=\"com.coverity.security.Escape\"%>\n<%@page import=\"org.dspace.discovery.configuration.DiscoverySearchFilterFacet\"%>\n<%@page import=\"org.dspace.app.webui.util.UIUtil\"%>\n<%@page import=\"java.util.HashMap\"%>\n<%@page import=\"java.util.ArrayList\"%>\n<%@page import=\"org.dspace.discovery.DiscoverFacetField\"%>\n<%@page import=\"org.dspace.discovery.configuration.DiscoverySearchFilter\"%>\n<%@page import=\"org.dspace.discovery.DiscoverFilterQuery\"%>\n<%@page import=\"org.dspace.discovery.DiscoverQuery\"%>\n<%@page import=\"org.apache.commons.lang.StringUtils\"%>\n<%@page import=\"java.util.Map\"%>\n<%@page import=\"org.dspace.discovery.DiscoverResult.FacetResult\"%>\n<%@page import=\"org.dspace.discovery.DiscoverResult\"%>\n<%@page import=\"org.dspace.content.DSpaceObject\"%>\n<%@page import=\"java.util.List\"%>\n<%@ page contentType=\"text/html;charset=UTF-8\" %>\n\n<%@ taglib uri=\"http://java.sun.com/jsp/jstl/fmt\"\n    prefix=\"fmt\" %>\n<%@ taglib uri=\"http://java.sun.com/jsp/jstl/core\"\n    prefix=\"c\" %>\n\n<%@ taglib uri=\"http://www.dspace.org/dspace-tags.tld\" prefix=\"dspace\" %>\n<%@ page import=\"java.net.URLEncoder\"            %>\n<%@ page import=\"org.dspace.content.Community\"   %>\n<%@ page import=\"org.dspace.content.Collection\"  %>\n<%@ page import=\"org.dspace.content.Item\"        %>\n<%@ page import=\"org.dspace.sort.SortOption\" %>\n<%@ page import=\"java.util.Enumeration\" %>\n<%@ page import=\"java.util.Set\" %>\n<%\n    // Get the attributes\n    DSpaceObject scope = (DSpaceObject) request.getAttribute(\"scope\" );\n    String searchScope = scope!=null ? scope.getHandle() : \"\";\n    List<DSpaceObject> scopes = (List<DSpaceObject>) request.getAttribute(\"scopes\");\n    List<String> sortOptions = (List<String>) request.getAttribute(\"sortOptions\");\n\n    String query = (String) request.getAttribute(\"query\");\n\tif (query == null)\n\t{\n\t    query = \"\";\n\t}\n    Boolean error_b = (Boolean)request.getAttribute(\"search.error\");\n    boolean error = error_b==null ? false : error_b.booleanValue();\n    \n    DiscoverQuery qArgs = (DiscoverQuery) request.getAttribute(\"queryArgs\");\n    String sortedBy = qArgs.getSortField();\n    String order = qArgs.getSortOrder().toString();\n    String ascSelected = (SortOption.ASCENDING.equalsIgnoreCase(order)   ? \"selected=\\\"selected\\\"\" : \"\");\n    String descSelected = (SortOption.DESCENDING.equalsIgnoreCase(order) ? \"selected=\\\"selected\\\"\" : \"\");\n    String httpFilters =\"\";\n\tString spellCheckQuery = (String) request.getAttribute(\"spellcheck\");\n    List<DiscoverySearchFilter> availableFilters = (List<DiscoverySearchFilter>) request.getAttribute(\"availableFilters\");\n\tList<String[]> appliedFilters = (List<String[]>) request.getAttribute(\"appliedFilters\");\n\tList<String> appliedFilterQueries = (List<String>) request.getAttribute(\"appliedFilterQueries\");\n\tif (appliedFilters != null && appliedFilters.size() >0 ) \n\t{\n\t    int idx = 1;\n\t    for (String[] filter : appliedFilters)\n\t    {\n                if (filter == null\n                        || filter[0] == null || filter[0].trim().equals(\"\")\n                        || filter[2] == null || filter[2].trim().equals(\"\"))\n                {\n                    idx++;\n                    continue;\n                }\n\t        httpFilters += \"&amp;filter_field_\"+idx+\"=\"+URLEncoder.encode(filter[0],\"UTF-8\");\n\t        httpFilters += \"&amp;filter_type_\"+idx+\"=\"+URLEncoder.encode(filter[1],\"UTF-8\");\n\t        httpFilters += \"&amp;filter_value_\"+idx+\"=\"+URLEncoder.encode(filter[2],\"UTF-8\");\n\t        idx++;\n\t    }\n\t}\n    int rpp          = qArgs.getMaxResults();\n    int etAl         = ((Integer) request.getAttribute(\"etal\")).intValue();\n\n    String[] options = new String[]{\"equals\",\"contains\",\"authority\",\"notequals\",\"notcontains\",\"notauthority\"};\n    \n    // Admin user or not\n    Boolean admin_b = (Boolean)request.getAttribute(\"admin_button\");\n    boolean admin_button = (admin_b == null ? false : admin_b.booleanValue());\n%>\n\n<c:set var=\"dspace.layout.head.last\" scope=\"request\">\n<script type=\"text/javascript\">\n\tvar jQ = jQuery.noConflict();\n\tjQ(document).ready(function() {\n\t\tjQ( \"#spellCheckQuery\").on(\"click\", function(){\n\t\t\tjQ(\"#query\").val(jQ(this).attr('data-spell'));\n\t\t\tjQ(\"#main-query-submit\").click();\n\t\t});\n\t\tjQ( \"#filterquery\" )\n\t\t\t.autocomplete({\n\t\t\t\tsource: function( request, response ) {\n\t\t\t\t\tjQ.ajax({\n\t\t\t\t\t\turl: \"<%= request.getContextPath() %>/json/discovery/autocomplete?query=<%= URLEncoder.encode(query,\"UTF-8\")%><%= httpFilters.replaceAll(\"&amp;\",\"&\") %>\",\n\t\t\t\t\t\tdataType: \"json\",\n\t\t\t\t\t\tcache: false,\n\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\tauto_idx: jQ(\"#filtername\").val(),\n\t\t\t\t\t\t\tauto_query: request.term,\n\t\t\t\t\t\t\tauto_sort: 'count',\n\t\t\t\t\t\t\tauto_type: jQ(\"#filtertype\").val(),\n\t\t\t\t\t\t\tlocation: '<%= searchScope %>'\t\n\t\t\t\t\t\t},\n\t\t\t\t\t\tsuccess: function( data ) {\n\t\t\t\t\t\t\tresponse( jQ.map( data.autocomplete, function( item ) {\n\t\t\t\t\t\t\t\tvar tmp_val = item.authorityKey;\n\t\t\t\t\t\t\t\tif (tmp_val == null || tmp_val == '')\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttmp_val = item.displayedValue;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\tlabel: item.displayedValue + \" (\" + item.count + \")\",\n\t\t\t\t\t\t\t\t\tvalue: tmp_val\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t}))\t\t\t\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t});\n\t});\n\tfunction validateFilters() {\n\t\treturn document.getElementById(\"filterquery\").value.length > 0;\n\t}\n</script>\t\t\n</c:set>\n\n<dspace:layout titlekey=\"jsp.search.title\">\n\n    <%-- <h1>Search Results</h1> --%>\n\n<h2><fmt:message key=\"jsp.search.title\"/></h2>\n\n<div class=\"discovery-search-form panel panel-default row\">\n    <%-- Controls for a repeat search --%>\n\t<div class=\"discovery-query panel-heading\">\n    <form action=\"simple-search\" method=\"get\">\n        <label for=\"tlocation\">\n         \t<fmt:message key=\"jsp.search.results.searchin\"/>\n        </label>\n        <select name=\"location\" id=\"tlocation\">\n<%\n    if (scope == null)\n    {\n        // Scope of the search was all of DSpace.  The scope control will list\n        // \"all of DSpace\" and the communities.\n%>\n            <%-- <option selected value=\"/\">All of DSpace</option> --%>\n            <option selected=\"selected\" value=\"/\"><fmt:message key=\"jsp.general.genericScope\"/></option>\n<%  }\n    else\n    {\n%>\n            <option value=\"/\"><fmt:message key=\"jsp.general.genericScope\"/></option>\n<%  }      \n    for (DSpaceObject dso : scopes)\n    {\n%>\n            <option value=\"<%= dso.getHandle() %>\" <%=dso.getHandle().equals(searchScope)?\"selected=\\\"selected\\\"\":\"\" %>>\n                <%= dso.getName() %>\n            </option>\n<%\n    }\n%>\n        </select><br/>\n        <label for=\"query\"><fmt:message key=\"jsp.search.results.searchfor\"/></label>\n        <input type=\"text\" size=\"50\" id=\"query\" name=\"query\" value=\"<%= (query==null ? \"\" : Utils.addEntities(query)) %>\"/>\n        <input type=\"submit\" id=\"main-query-submit\" class=\"btn btn-primary\" value=\"<fmt:message key=\"jsp.general.go\"/>\" />\n<% if (StringUtils.isNotBlank(spellCheckQuery)) {%>\n\t<p class=\"lead\"><fmt:message key=\"jsp.search.didyoumean\"><fmt:param><a id=\"spellCheckQuery\" data-spell=\"<%= Utils.addEntities(spellCheckQuery) %>\" href=\"#\"><%= spellCheckQuery %></a></fmt:param></fmt:message></p>\n<% } %>                  \n        <input type=\"hidden\" value=\"<%= rpp %>\" name=\"rpp\" />\n        <input type=\"hidden\" value=\"<%= Utils.addEntities(sortedBy) %>\" name=\"sort_by\" />\n        <input type=\"hidden\" value=\"<%= Utils.addEntities(order) %>\" name=\"order\" />\n<% if (appliedFilters.size() > 0 ) { %>                                \n\t\t<div class=\"discovery-search-appliedFilters\">\n\t\t<span><fmt:message key=\"jsp.search.filter.applied\" /></span>\n\t\t<%\n\t\t\tint idx = 1;\n\t\t\tfor (String[] filter : appliedFilters)\n\t\t\t{\n\t\t\t    boolean found = false;\n\t\t\t    %>\n\t\t\t    <select id=\"filter_field_<%=idx %>\" name=\"filter_field_<%=idx %>\">\n\t\t\t\t<%\n\t\t\t\t\tfor (DiscoverySearchFilter searchFilter : availableFilters)\n\t\t\t\t\t{\n\t\t\t\t\t    String fkey = \"jsp.search.filter.\" + Escape.uriParam(searchFilter.getIndexFieldName());\n\t\t\t\t\t    %><option value=\"<%= Utils.addEntities(searchFilter.getIndexFieldName()) %>\"<% \n\t\t\t\t\t            if (searchFilter.getIndexFieldName().equals(filter[0]))\n\t\t\t\t\t            {\n\t\t\t\t\t                %> selected=\"selected\"<%\n\t\t\t\t\t                found = true;\n\t\t\t\t\t            }\n\t\t\t\t\t            %>><fmt:message key=\"<%= fkey %>\"/></option><%\n\t\t\t\t\t}\n\t\t\t\t\tif (!found)\n\t\t\t\t\t{\n\t\t\t\t\t    String fkey = \"jsp.search.filter.\" + Escape.uriParam(filter[0]);\n\t\t\t\t\t    %><option value=\"<%= Utils.addEntities(filter[0]) %>\" selected=\"selected\"><fmt:message key=\"<%= fkey %>\"/></option><%\n\t\t\t\t\t}\n\t\t\t\t%>\n\t\t\t\t</select>\n\t\t\t\t<select id=\"filter_type_<%=idx %>\" name=\"filter_type_<%=idx %>\">\n\t\t\t\t<%\n\t\t\t\t\tfor (String opt : options)\n\t\t\t\t\t{\n\t\t\t\t\t    String fkey = \"jsp.search.filter.op.\" + Escape.uriParam(opt);\n\t\t\t\t\t    %><option value=\"<%= Utils.addEntities(opt) %>\"<%= opt.equals(filter[1])?\" selected=\\\"selected\\\"\":\"\" %>><fmt:message key=\"<%= fkey %>\"/></option><%\n\t\t\t\t\t}\n\t\t\t\t%>\n\t\t\t\t</select>\n\t\t\t\t<input type=\"text\" id=\"filter_value_<%=idx %>\" name=\"filter_value_<%=idx %>\" value=\"<%= Utils.addEntities(filter[2]) %>\" size=\"45\"/>\n\t\t\t\t<input class=\"btn btn-default\" type=\"submit\" id=\"submit_filter_remove_<%=idx %>\" name=\"submit_filter_remove_<%=idx %>\" value=\"X\" />\n\t\t\t\t<br/>\n\t\t\t\t<%\n\t\t\t\tidx++;\n\t\t\t}\n\t\t%>\n\t\t</div>\n<% } %>\n<a class=\"btn btn-default\" href=\"<%= request.getContextPath()+\"/simple-search\" %>\"><fmt:message key=\"jsp.search.general.new-search\" /></a>\t\n\t\t</form>\n\t\t</div>\n<% if (availableFilters.size() > 0) { %>\n\t\t<div class=\"discovery-search-filters panel-body\">\n\t\t<h5><fmt:message key=\"jsp.search.filter.heading\" /></h5>\n\t\t<p class=\"discovery-search-filters-hint\"><fmt:message key=\"jsp.search.filter.hint\" /></p>\n\t\t<form action=\"simple-search\" method=\"get\">\n\t\t<input type=\"hidden\" value=\"<%= Utils.addEntities(searchScope) %>\" name=\"location\" />\n\t\t<input type=\"hidden\" value=\"<%= Utils.addEntities(query) %>\" name=\"query\" />\n\t\t<% if (appliedFilterQueries.size() > 0 ) { \n\t\t\t\tint idx = 1;\n\t\t\t\tfor (String[] filter : appliedFilters)\n\t\t\t\t{\n\t\t\t\t    boolean found = false;\n\t\t\t\t    %>\n\t\t\t\t    <input type=\"hidden\" id=\"filter_field_<%=idx %>\" name=\"filter_field_<%=idx %>\" value=\"<%= Utils.addEntities(filter[0]) %>\" />\n\t\t\t\t\t<input type=\"hidden\" id=\"filter_type_<%=idx %>\" name=\"filter_type_<%=idx %>\" value=\"<%= Utils.addEntities(filter[1]) %>\" />\n\t\t\t\t\t<input type=\"hidden\" id=\"filter_value_<%=idx %>\" name=\"filter_value_<%=idx %>\" value=\"<%= Utils.addEntities(filter[2]) %>\" />\n\t\t\t\t\t<%\n\t\t\t\t\tidx++;\n\t\t\t\t}\n\t\t} %>\n\t\t<select id=\"filtername\" name=\"filtername\">\n\t\t<%\n\t\t\tfor (DiscoverySearchFilter searchFilter : availableFilters)\n\t\t\t{\n\t\t\t    String fkey = \"jsp.search.filter.\" + Escape.uriParam(searchFilter.getIndexFieldName());\n\t\t\t    %><option value=\"<%= Utils.addEntities(searchFilter.getIndexFieldName()) %>\"><fmt:message key=\"<%= fkey %>\"/></option><%\n\t\t\t}\n\t\t%>\n\t\t</select>\n\t\t<select id=\"filtertype\" name=\"filtertype\">\n\t\t<%\n\t\t\tfor (String opt : options)\n\t\t\t{\n\t\t\t    String fkey = \"jsp.search.filter.op.\" + Escape.uriParam(opt);\n\t\t\t    %><option value=\"<%= Utils.addEntities(opt) %>\"><fmt:message key=\"<%= fkey %>\"/></option><%\n\t\t\t}\n\t\t%>\n\t\t</select>\n\t\t<input type=\"text\" id=\"filterquery\" name=\"filterquery\" size=\"45\" required=\"required\" />\n\t\t<input type=\"hidden\" value=\"<%= rpp %>\" name=\"rpp\" />\n\t\t<input type=\"hidden\" value=\"<%= Utils.addEntities(sortedBy) %>\" name=\"sort_by\" />\n\t\t<input type=\"hidden\" value=\"<%= Utils.addEntities(order) %>\" name=\"order\" />\n\t\t<input class=\"btn btn-default\" type=\"submit\" value=\"<fmt:message key=\"jsp.search.filter.add\"/>\" onclick=\"return validateFilters()\" />\n\t\t</form>\n\t\t</div>        \n<% } %>\n        <%-- Include a component for modifying sort by, order, results per page, and et-al limit --%>\n   <div class=\"discovery-pagination-controls panel-footer\">\n   <form action=\"simple-search\" method=\"get\">\n   <input type=\"hidden\" value=\"<%= Utils.addEntities(searchScope) %>\" name=\"location\" />\n   <input type=\"hidden\" value=\"<%= Utils.addEntities(query) %>\" name=\"query\" />\n\t<% if (appliedFilterQueries.size() > 0 ) { \n\t\t\t\tint idx = 1;\n\t\t\t\tfor (String[] filter : appliedFilters)\n\t\t\t\t{\n\t\t\t\t    boolean found = false;\n\t\t\t\t    %>\n\t\t\t\t    <input type=\"hidden\" id=\"filter_field_<%=idx %>\" name=\"filter_field_<%=idx %>\" value=\"<%= Utils.addEntities(filter[0]) %>\" />\n\t\t\t\t\t<input type=\"hidden\" id=\"filter_type_<%=idx %>\" name=\"filter_type_<%=idx %>\" value=\"<%= Utils.addEntities(filter[1]) %>\" />\n\t\t\t\t\t<input type=\"hidden\" id=\"filter_value_<%=idx %>\" name=\"filter_value_<%=idx %>\" value=\"<%= Utils.addEntities(filter[2]) %>\" />\n\t\t\t\t\t<%\n\t\t\t\t\tidx++;\n\t\t\t\t}\n\t} %>\t\n           <label for=\"rpp\"><fmt:message key=\"search.results.perpage\"/></label>\n           <select name=\"rpp\" id=\"rpp\">\n<%\n               for (int i = 5; i <= 100 ; i += 5)\n               {\n                   String selected = (i == rpp ? \"selected=\\\"selected\\\"\" : \"\");\n%>\n                   <option value=\"<%= i %>\" <%= selected %>><%= i %></option>\n<%\n               }\n%>\n           </select>\n           &nbsp;|&nbsp;\n<%\n           if (sortOptions.size() > 0)\n           {\n%>\n               <label for=\"sort_by\"><fmt:message key=\"search.results.sort-by\"/></label>\n               <select name=\"sort_by\" id=\"sort_by\">\n                   <option value=\"score\"><fmt:message key=\"search.sort-by.relevance\"/></option>\n<%\n               for (String sortBy : sortOptions)\n               {\n                   String selected = (sortBy.equals(sortedBy) ? \"selected=\\\"selected\\\"\" : \"\");\n                   String mKey = \"search.sort-by.\" + Utils.addEntities(sortBy);\n                   %> <option value=\"<%= Utils.addEntities(sortBy) %>\" <%= selected %>><fmt:message key=\"<%= mKey %>\"/></option><%\n               }\n%>\n               </select>\n<%\n           }\n%>\n           <label for=\"order\"><fmt:message key=\"search.results.order\"/></label>\n           <select name=\"order\" id=\"order\">\n               <option value=\"ASC\" <%= ascSelected %>><fmt:message key=\"search.order.asc\" /></option>\n               <option value=\"DESC\" <%= descSelected %>><fmt:message key=\"search.order.desc\" /></option>\n           </select>\n           <label for=\"etal\"><fmt:message key=\"search.results.etal\" /></label>\n           <select name=\"etal\" id=\"etal\">\n<%\n               String unlimitedSelect = \"\";\n               if (etAl < 1)\n               {\n                   unlimitedSelect = \"selected=\\\"selected\\\"\";\n               }\n%>\n               <option value=\"0\" <%= unlimitedSelect %>><fmt:message key=\"browse.full.etal.unlimited\"/></option>\n<%\n               boolean insertedCurrent = false;\n               for (int i = 0; i <= 50 ; i += 5)\n               {\n                   // for the first one, we want 1 author, not 0\n                   if (i == 0)\n                   {\n                       String sel = (i + 1 == etAl ? \"selected=\\\"selected\\\"\" : \"\");\n                       %><option value=\"1\" <%= sel %>>1</option><%\n                   }\n\n                   // if the current i is greated than that configured by the user,\n                   // insert the one specified in the right place in the list\n                   if (i > etAl && !insertedCurrent && etAl > 1)\n                   {\n                       %><option value=\"<%= etAl %>\" selected=\"selected\"><%= etAl %></option><%\n                       insertedCurrent = true;\n                   }\n\n                   // determine if the current not-special case is selected\n                   String selected = (i == etAl ? \"selected=\\\"selected\\\"\" : \"\");\n\n                   // do this for all other cases than the first and the current\n                   if (i != 0 && i != etAl)\n                   {\n%>\n                       <option value=\"<%= i %>\" <%= selected %>><%= i %></option>\n<%\n                   }\n               }\n%>\n           </select>\n           <input class=\"btn btn-default\" type=\"submit\" name=\"submit_search\" value=\"<fmt:message key=\"search.update\" />\" />\n\n<%\n    if (admin_button)\n    {\n        %><input type=\"submit\" class=\"btn btn-default\" name=\"submit_export_metadata\" value=\"<fmt:message key=\"jsp.general.metadataexport.button\"/>\" /><%\n    }\n%>\n</form>\n   </div>\n</div>   \n<% \n\nDiscoverResult qResults = (DiscoverResult)request.getAttribute(\"queryresults\");\nList<Item>      items       = (List<Item>      )request.getAttribute(\"items\");\nList<Community> communities = (List<Community> )request.getAttribute(\"communities\");\nList<Collection>collections = (List<Collection>)request.getAttribute(\"collections\");\n\nif( error )\n{\n %>\n\t<p align=\"center\" class=\"submitFormWarn\">\n\t\t<fmt:message key=\"jsp.search.error.discovery\" />\n\t</p>\n\t<%\n}\nelse if( qResults != null && qResults.getTotalSearchResults() == 0 )\n{\n %>\n    <%-- <p align=\"center\">Search produced no results.</p> --%>\n    <p align=\"center\"><fmt:message key=\"jsp.search.general.noresults\"/></p>\n<%\n}\nelse if( qResults != null)\n{\n    long pageTotal   = ((Long)request.getAttribute(\"pagetotal\"  )).longValue();\n    long pageCurrent = ((Long)request.getAttribute(\"pagecurrent\")).longValue();\n    long pageLast    = ((Long)request.getAttribute(\"pagelast\"   )).longValue();\n    long pageFirst   = ((Long)request.getAttribute(\"pagefirst\"  )).longValue();\n    \n    // create the URLs accessing the previous and next search result pages\n    String baseURL =  request.getContextPath()\n                    + (!searchScope.equals(\"\") ? \"/handle/\" + searchScope : \"\")\n                    + \"/simple-search?query=\"\n                    + URLEncoder.encode(query,\"UTF-8\")\n                    + httpFilters\n                    + \"&amp;sort_by=\" + sortedBy\n                    + \"&amp;order=\" + order\n                    + \"&amp;rpp=\" + rpp\n                    + \"&amp;etal=\" + etAl\n                    + \"&amp;start=\";\n\n    String nextURL = baseURL;\n    String firstURL = baseURL;\n    String lastURL = baseURL;\n\n    String prevURL = baseURL\n            + (pageCurrent-2) * qResults.getMaxResults();\n\n    nextURL = nextURL\n            + (pageCurrent) * qResults.getMaxResults();\n    \n    firstURL = firstURL +\"0\";\n    lastURL = lastURL + (pageTotal-1) * qResults.getMaxResults();\n\n\n%>\n<hr/>\n<div class=\"discovery-result-pagination row\">\n<%\n\tlong lastHint = qResults.getStart()+qResults.getMaxResults() <= qResults.getTotalSearchResults()?\n\t        qResults.getStart()+qResults.getMaxResults():qResults.getTotalSearchResults();\n%>\n    <%-- <p align=\"center\">Results <//%=qResults.getStart()+1%>-<//%=qResults.getStart()+qResults.getHitHandles().size()%> of --%>\n\t<div class=\"alert alert-info\"><fmt:message key=\"jsp.search.results.results\">\n        <fmt:param><%=qResults.getStart()+1%></fmt:param>\n        <fmt:param><%=lastHint%></fmt:param>\n        <fmt:param><%=qResults.getTotalSearchResults()%></fmt:param>\n        <fmt:param><%=(float) qResults.getSearchTime() / 1000%></fmt:param>\n    </fmt:message></div>\n    <ul class=\"pagination pull-right\">\n\t<%\n\tif (pageFirst != pageCurrent)\n\t{\n\t    %><li><a href=\"<%= prevURL %>\"><fmt:message key=\"jsp.search.general.previous\" /></a></li><%\n\t}\n\telse\n\t{\n\t    %><li class=\"disabled\"><span><fmt:message key=\"jsp.search.general.previous\" /></span></li><%\n\t}\n\t\n\tif (pageFirst != 1)\n\t{\n\t    %><li><a href=\"<%= firstURL %>\">1</a></li><li class=\"disabled\"><span>...</span></li><%\n\t}\n\t\n\tfor( long q = pageFirst; q <= pageLast; q++ )\n\t{\n\t    String myLink = \"<li><a href=\\\"\"\n\t                    + baseURL;\n\t\n\t\n\t    if( q == pageCurrent )\n\t    {\n\t        myLink = \"<li class=\\\"active\\\"><span>\" + q + \"</span></li>\";\n\t    }\n\t    else\n\t    {\n\t        myLink = myLink\n\t            + (q-1) * qResults.getMaxResults()\n\t            + \"\\\">\"\n\t            + q\n\t            + \"</a></li>\";\n\t    }\n\t%>\n\t\n\t<%= myLink %>\n\n\t<%\n\t}\n\t\n\tif (pageTotal > pageLast)\n\t{\n\t    %><li class=\"disabled\"><span>...</span></li><li><a href=\"<%= lastURL %>\"><%= pageTotal %></a></li><%\n\t}\n\tif (pageTotal > pageCurrent)\n\t{\n\t    %><li><a href=\"<%= nextURL %>\"><fmt:message key=\"jsp.search.general.next\" /></a></li><%\n\t}\n\telse\n\t{\n\t    %><li class=\"disabled\"><span><fmt:message key=\"jsp.search.general.next\" /></span></li><%\n\t}\n\t%>\n\t</ul>\n<!-- give a content to the div -->\n</div>\n<div class=\"discovery-result-results row\">\n<% if (communities.size() > 0 ) { %>\n    <div class=\"panel panel-info\">\n    <div class=\"panel-heading\"><fmt:message key=\"jsp.search.results.comhits\"/></div>\n    <dspace:communitylist  communities=\"<%= communities %>\" />\n    </div>\n<% } %>\n\n<% if (collections.size() > 0 ) { %>\n    <div class=\"panel panel-info\">\n    <div class=\"panel-heading\"><fmt:message key=\"jsp.search.results.colhits\"/></div>\n    <dspace:collectionlist collections=\"<%= collections %>\" />\n    </div>\n<% } %>\n\n<% if (items.size() > 0) { %>\n    <div class=\"panel panel-info\">\n    <div class=\"panel-heading\"><fmt:message key=\"jsp.search.results.itemhits\"/></div>\n    <dspace:itemlist items=\"<%= items %>\" authorLimit=\"<%= etAl %>\" />\n    </div>\n<% } %>\n</div>\n<%-- if the result page is enought long... --%>\n<% if ((communities.size() + collections.size() + items.size()) > 10) {%>\n<%-- show again the navigation info/links --%>\n<div class=\"discovery-result-pagination row container\">\n    <%-- <p align=\"center\">Results <//%=qResults.getStart()+1%>-<//%=qResults.getStart()+qResults.getHitHandles().size()%> of --%>\n\t<div class=\"alert alert-info\"><fmt:message key=\"jsp.search.results.results\">\n        <fmt:param><%=qResults.getStart()+1%></fmt:param>\n        <fmt:param><%=lastHint%></fmt:param>\n        <fmt:param><%=qResults.getTotalSearchResults()%></fmt:param>\n        <fmt:param><%=(float) qResults.getSearchTime() / 1000 %></fmt:param>\n    </fmt:message></div>\n    <ul class=\"pagination pull-right\">\n<%\nif (pageFirst != pageCurrent)\n{\n    %><li><a href=\"<%= prevURL %>\"><fmt:message key=\"jsp.search.general.previous\" /></a></li><%\n}\nelse\n{\n    %><li class=\"disabled\"><span><fmt:message key=\"jsp.search.general.previous\" /></span></li><%\n}    \n\nif (pageFirst != 1)\n{\n    %><li><a href=\"<%= firstURL %>\">1</a></li><li class=\"disabled\"><span>...</span></li><%\n}\n\nfor( long q = pageFirst; q <= pageLast; q++ )\n{\n    String myLink = \"<li><a href=\\\"\"\n                    + baseURL;\n\n\n    if( q == pageCurrent )\n    {\n        myLink = \"<li class=\\\"active\\\"><span>\" + q + \"</span></li>\";\n    }\n    else\n    {\n        myLink = myLink\n            + (q-1) * qResults.getMaxResults()\n            + \"\\\">\"\n            + q\n            + \"</a></li>\";\n    }\n%>\n\n<%= myLink %>\n\n<%\n}\n\nif (pageTotal > pageLast)\n{\n    %><li class=\"disabled\"><span>...</span></li><li><a href=\"<%= lastURL %>\"><%= pageTotal %></a></li><%\n}\nif (pageTotal > pageCurrent)\n{\n    %><li><a href=\"<%= nextURL %>\"><fmt:message key=\"jsp.search.general.next\" /></a></li><%\n}\nelse\n{\n    %><li class=\"disabled\"><span><fmt:message key=\"jsp.search.general.next\" /></span></li><%\n}\n%>\n</ul>\n<!-- give a content to the div -->\n</div>\n<% } %>\n<% } %>\n<dspace:sidebar>\n<%\n\tboolean brefine = false;\n\t\n\tList<DiscoverySearchFilterFacet> facetsConf = (List<DiscoverySearchFilterFacet>) request.getAttribute(\"facetsConfig\");\n\tMap<String, Boolean> showFacets = new HashMap<String, Boolean>();\n\t\t\n\tfor (DiscoverySearchFilterFacet facetConf : facetsConf)\n\t{\n\t\tif(qResults!=null) {\n\t\t    String f = facetConf.getIndexFieldName();\n\t\t    List<FacetResult> facet = qResults.getFacetResult(f);\n\t\t    if (facet.size() == 0)\n\t\t    {\n\t\t        facet = qResults.getFacetResult(f+\".year\");\n\t\t\t    if (facet.size() == 0)\n\t\t\t    {\n\t\t\t        showFacets.put(f, false);\n\t\t\t        continue;\n\t\t\t    }\n\t\t    }\n\t\t    boolean showFacet = false;\n\t\t    for (FacetResult fvalue : facet)\n\t\t    { \n\t\t\t\tif(!appliedFilterQueries.contains(f+\"::\"+fvalue.getFilterType()+\"::\"+fvalue.getAsFilterQuery()))\n\t\t\t    {\n\t\t\t        showFacet = true;\n\t\t\t        break;\n\t\t\t    }\n\t\t    }\n\t\t    showFacets.put(f, showFacet);\n\t\t    brefine = brefine || showFacet;\n\t\t}\n\t}\n\tif (brefine) {\n%>\n\n<h3 class=\"facets\"><fmt:message key=\"jsp.search.facet.refine\" /></h3>\n<div id=\"facets\" class=\"facetsBox\">\n\n<%\n\tfor (DiscoverySearchFilterFacet facetConf : facetsConf)\n\t{\n\t    String f = facetConf.getIndexFieldName();\n\t    if (!showFacets.get(f))\n\t        continue;\n\t    List<FacetResult> facet = qResults.getFacetResult(f);\n\t    if (facet.size() == 0)\n\t    {\n\t        facet = qResults.getFacetResult(f+\".year\");\n\t    }\n\t    int limit = facetConf.getFacetLimit()+1;\n\t    \n\t    String fkey = \"jsp.search.facet.refine.\"+f;\n\t    %><div id=\"facet_<%= f %>\" class=\"panel panel-success\">\n\t    <div class=\"panel-heading\"><fmt:message key=\"<%= fkey %>\" /></div>\n\t    <ul class=\"list-group\"><%\n\t    int idx = 1;\n\t    int currFp = UIUtil.getIntParameter(request, f+\"_page\");\n\t    if (currFp < 0)\n\t    {\n\t        currFp = 0;\n\t    }\n\t    for (FacetResult fvalue : facet)\n\t    { \n\t        if (idx != limit && !appliedFilterQueries.contains(f+\"::\"+fvalue.getFilterType()+\"::\"+fvalue.getAsFilterQuery()))\n\t        {\n\t        %><li class=\"list-group-item\"><span class=\"badge\"><%= fvalue.getCount() %></span> <a href=\"<%= request.getContextPath()\n                + (!searchScope.equals(\"\")?\"/handle/\"+searchScope:\"\")\n                + \"/simple-search?query=\"\n                + URLEncoder.encode(query,\"UTF-8\")\n                + \"&amp;sort_by=\" + sortedBy\n                + \"&amp;order=\" + order\n                + \"&amp;rpp=\" + rpp\n                + httpFilters\n                + \"&amp;etal=\" + etAl\n                + \"&amp;filtername=\"+URLEncoder.encode(f,\"UTF-8\")\n                + \"&amp;filterquery=\"+URLEncoder.encode(fvalue.getAsFilterQuery(),\"UTF-8\")\n                + \"&amp;filtertype=\"+URLEncoder.encode(fvalue.getFilterType(),\"UTF-8\") %>\"\n                title=\"<fmt:message key=\"jsp.search.facet.narrow\"><fmt:param><%=fvalue.getDisplayedValue() %></fmt:param></fmt:message>\">\n                <%= StringUtils.abbreviate(fvalue.getDisplayedValue(),36) %></a></li><%\n                idx++;\n\t        }\n\t        if (idx > limit)\n\t        {\n\t            break;\n\t        }\n\t    }\n\t    if (currFp > 0 || idx == limit)\n\t    {\n\t        %><li class=\"list-group-item\"><span style=\"visibility: hidden;\">.</span>\n\t        <% if (currFp > 0) { %>\n\t        <a class=\"pull-left\" href=\"<%= request.getContextPath()\n\t            + (!searchScope.equals(\"\")?\"/handle/\"+searchScope:\"\")\n                + \"/simple-search?query=\"\n                + URLEncoder.encode(query,\"UTF-8\")\n                + \"&amp;sort_by=\" + sortedBy\n                + \"&amp;order=\" + order\n                + \"&amp;rpp=\" + rpp\n                + httpFilters\n                + \"&amp;etal=\" + etAl  \n                + \"&amp;\"+f+\"_page=\"+(currFp-1) %>\"><fmt:message key=\"jsp.search.facet.refine.previous\" /></a>\n            <% } %>\n            <% if (idx == limit) { %>\n            <a href=\"<%= request.getContextPath()\n\t            + (!searchScope.equals(\"\")?\"/handle/\"+searchScope:\"\")\n                + \"/simple-search?query=\"\n                + URLEncoder.encode(query,\"UTF-8\")\n                + \"&amp;sort_by=\" + sortedBy\n                + \"&amp;order=\" + order\n                + \"&amp;rpp=\" + rpp\n                + httpFilters\n                + \"&amp;etal=\" + etAl  \n                + \"&amp;\"+f+\"_page=\"+(currFp+1) %>\"><span class=\"pull-right\"><fmt:message key=\"jsp.search.facet.refine.next\" /></span></a>\n            <%\n            }\n            %></li><%\n\t    }\n\t    %></ul></div><%\n\t}\n\n%>\n\n</div>\n<% } %>\n</dspace:sidebar>\n</dspace:layout>\n"], "fixing_code": ["<%--\n\n    The contents of this file are subject to the license and copyright\n    detailed in the LICENSE and NOTICE files at the root of the source\n    tree and available online at\n\n    http://www.dspace.org/license/\n\n--%>\n\n<%--\n  - Display the form to refine the simple-search and dispaly the results of the search\n  -\n  - Attributes to pass in:\n  -\n  -   scope            - pass in if the scope of the search was a community\n  -                      or a collection\n  -   scopes \t\t   - the list of available scopes where limit the search\n  -   sortOptions\t   - the list of available sort options\n  -   availableFilters - the list of filters available to the user\n  -\n  -   query            - The original query\n  -   queryArgs\t\t   - The query configuration parameters (rpp, sort, etc.)\n  -   appliedFilters   - The list of applied filters (user input or facet)\n  -\n  -   search.error     - a flag to say that an error has occurred\n  -   spellcheck\t   - the suggested spell check query (if any)\n  -   qResults\t\t   - the discovery results\n  -   items            - the results.  An array of Items, most relevant first\n  -   communities      - results, Community[]\n  -   collections      - results, Collection[]\n  -\n  -   admin_button     - If the user is an admin\n  --%>\n\n<%@page import=\"org.dspace.core.Utils\"%>\n<%@page import=\"com.coverity.security.Escape\"%>\n<%@page import=\"org.dspace.discovery.configuration.DiscoverySearchFilterFacet\"%>\n<%@page import=\"org.dspace.app.webui.util.UIUtil\"%>\n<%@page import=\"java.util.HashMap\"%>\n<%@page import=\"java.util.ArrayList\"%>\n<%@page import=\"org.dspace.discovery.DiscoverFacetField\"%>\n<%@page import=\"org.dspace.discovery.configuration.DiscoverySearchFilter\"%>\n<%@page import=\"org.dspace.discovery.DiscoverFilterQuery\"%>\n<%@page import=\"org.dspace.discovery.DiscoverQuery\"%>\n<%@page import=\"org.apache.commons.lang.StringUtils\"%>\n<%@page import=\"java.util.Map\"%>\n<%@page import=\"org.dspace.discovery.DiscoverResult.FacetResult\"%>\n<%@page import=\"org.dspace.discovery.DiscoverResult\"%>\n<%@page import=\"org.dspace.content.DSpaceObject\"%>\n<%@page import=\"java.util.List\"%>\n<%@ page contentType=\"text/html;charset=UTF-8\" %>\n\n<%@ taglib uri=\"http://java.sun.com/jsp/jstl/fmt\"\n    prefix=\"fmt\" %>\n<%@ taglib uri=\"http://java.sun.com/jsp/jstl/core\"\n    prefix=\"c\" %>\n\n<%@ taglib uri=\"http://www.dspace.org/dspace-tags.tld\" prefix=\"dspace\" %>\n<%@ page import=\"java.net.URLEncoder\"            %>\n<%@ page import=\"org.dspace.content.Community\"   %>\n<%@ page import=\"org.dspace.content.Collection\"  %>\n<%@ page import=\"org.dspace.content.Item\"        %>\n<%@ page import=\"org.dspace.sort.SortOption\" %>\n<%@ page import=\"java.util.Enumeration\" %>\n<%@ page import=\"java.util.Set\" %>\n<%\n    // Get the attributes\n    DSpaceObject scope = (DSpaceObject) request.getAttribute(\"scope\" );\n    String searchScope = scope!=null ? scope.getHandle() : \"\";\n    List<DSpaceObject> scopes = (List<DSpaceObject>) request.getAttribute(\"scopes\");\n    List<String> sortOptions = (List<String>) request.getAttribute(\"sortOptions\");\n\n    String query = (String) request.getAttribute(\"query\");\n\tif (query == null)\n\t{\n\t    query = \"\";\n\t}\n    Boolean error_b = (Boolean)request.getAttribute(\"search.error\");\n    boolean error = error_b==null ? false : error_b.booleanValue();\n    \n    DiscoverQuery qArgs = (DiscoverQuery) request.getAttribute(\"queryArgs\");\n    String sortedBy = qArgs.getSortField();\n    String order = qArgs.getSortOrder().toString();\n    String ascSelected = (SortOption.ASCENDING.equalsIgnoreCase(order)   ? \"selected=\\\"selected\\\"\" : \"\");\n    String descSelected = (SortOption.DESCENDING.equalsIgnoreCase(order) ? \"selected=\\\"selected\\\"\" : \"\");\n    String httpFilters =\"\";\n\tString spellCheckQuery = (String) request.getAttribute(\"spellcheck\");\n    List<DiscoverySearchFilter> availableFilters = (List<DiscoverySearchFilter>) request.getAttribute(\"availableFilters\");\n\tList<String[]> appliedFilters = (List<String[]>) request.getAttribute(\"appliedFilters\");\n\tList<String> appliedFilterQueries = (List<String>) request.getAttribute(\"appliedFilterQueries\");\n\tif (appliedFilters != null && appliedFilters.size() >0 ) \n\t{\n\t    int idx = 1;\n\t    for (String[] filter : appliedFilters)\n\t    {\n                if (filter == null\n                        || filter[0] == null || filter[0].trim().equals(\"\")\n                        || filter[2] == null || filter[2].trim().equals(\"\"))\n                {\n                    idx++;\n                    continue;\n                }\n\t        httpFilters += \"&amp;filter_field_\"+idx+\"=\"+URLEncoder.encode(filter[0],\"UTF-8\");\n\t        httpFilters += \"&amp;filter_type_\"+idx+\"=\"+URLEncoder.encode(filter[1],\"UTF-8\");\n\t        httpFilters += \"&amp;filter_value_\"+idx+\"=\"+URLEncoder.encode(filter[2],\"UTF-8\");\n\t        idx++;\n\t    }\n\t}\n    int rpp          = qArgs.getMaxResults();\n    int etAl         = ((Integer) request.getAttribute(\"etal\")).intValue();\n\n    String[] options = new String[]{\"equals\",\"contains\",\"authority\",\"notequals\",\"notcontains\",\"notauthority\"};\n    \n    // Admin user or not\n    Boolean admin_b = (Boolean)request.getAttribute(\"admin_button\");\n    boolean admin_button = (admin_b == null ? false : admin_b.booleanValue());\n%>\n\n<c:set var=\"dspace.layout.head.last\" scope=\"request\">\n<script type=\"text/javascript\">\n\tvar jQ = jQuery.noConflict();\n\tjQ(document).ready(function() {\n\t\tjQ( \"#spellCheckQuery\").on(\"click\", function(){\n\t\t\tjQ(\"#query\").val(jQ(this).attr('data-spell'));\n\t\t\tjQ(\"#main-query-submit\").click();\n\t\t});\n\t\tjQ( \"#filterquery\" )\n\t\t\t.autocomplete({\n\t\t\t\tsource: function( request, response ) {\n\t\t\t\t\tjQ.ajax({\n\t\t\t\t\t\turl: \"<%= request.getContextPath() %>/json/discovery/autocomplete?query=<%= URLEncoder.encode(query,\"UTF-8\")%><%= httpFilters.replaceAll(\"&amp;\",\"&\") %>\",\n\t\t\t\t\t\tdataType: \"json\",\n\t\t\t\t\t\tcache: false,\n\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\tauto_idx: jQ(\"#filtername\").val(),\n\t\t\t\t\t\t\tauto_query: request.term,\n\t\t\t\t\t\t\tauto_sort: 'count',\n\t\t\t\t\t\t\tauto_type: jQ(\"#filtertype\").val(),\n\t\t\t\t\t\t\tlocation: '<%= searchScope %>'\t\n\t\t\t\t\t\t},\n\t\t\t\t\t\tsuccess: function( data ) {\n\t\t\t\t\t\t\tresponse( jQ.map( data.autocomplete, function( item ) {\n\t\t\t\t\t\t\t\tvar tmp_val = item.authorityKey;\n\t\t\t\t\t\t\t\tif (tmp_val == null || tmp_val == '')\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttmp_val = item.displayedValue;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\tlabel: escapeHtml(item.displayedValue) + \" (\" + item.count + \")\",\n\t\t\t\t\t\t\t\t\tvalue: tmp_val\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t}))\t\t\t\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t});\n\t});\n\tfunction validateFilters() {\n\t\treturn document.getElementById(\"filterquery\").value.length > 0;\n\t}\n\t// Generic HTML escape utility\n\tvar escapeHtml = s => (s + '').replace(/[&<>\"']/g, m => ({\n\t\t'&': '&amp;', '<': '&lt;', '>': '&gt;',\n\t\t'\"': '&quot;', \"'\": '&#39;'\n\t})[m]);\n</script>\t\t\n</c:set>\n\n<dspace:layout titlekey=\"jsp.search.title\">\n\n    <%-- <h1>Search Results</h1> --%>\n\n<h2><fmt:message key=\"jsp.search.title\"/></h2>\n\n<div class=\"discovery-search-form panel panel-default row\">\n    <%-- Controls for a repeat search --%>\n\t<div class=\"discovery-query panel-heading\">\n    <form action=\"simple-search\" method=\"get\">\n        <label for=\"tlocation\">\n         \t<fmt:message key=\"jsp.search.results.searchin\"/>\n        </label>\n        <select name=\"location\" id=\"tlocation\">\n<%\n    if (scope == null)\n    {\n        // Scope of the search was all of DSpace.  The scope control will list\n        // \"all of DSpace\" and the communities.\n%>\n            <%-- <option selected value=\"/\">All of DSpace</option> --%>\n            <option selected=\"selected\" value=\"/\"><fmt:message key=\"jsp.general.genericScope\"/></option>\n<%  }\n    else\n    {\n%>\n            <option value=\"/\"><fmt:message key=\"jsp.general.genericScope\"/></option>\n<%  }      \n    for (DSpaceObject dso : scopes)\n    {\n%>\n            <option value=\"<%= dso.getHandle() %>\" <%=dso.getHandle().equals(searchScope)?\"selected=\\\"selected\\\"\":\"\" %>>\n                <%= dso.getName() %>\n            </option>\n<%\n    }\n%>\n        </select><br/>\n        <label for=\"query\"><fmt:message key=\"jsp.search.results.searchfor\"/></label>\n        <input type=\"text\" size=\"50\" id=\"query\" name=\"query\" value=\"<%= (query==null ? \"\" : Utils.addEntities(query)) %>\"/>\n        <input type=\"submit\" id=\"main-query-submit\" class=\"btn btn-primary\" value=\"<fmt:message key=\"jsp.general.go\"/>\" />\n<% if (StringUtils.isNotBlank(spellCheckQuery)) {%>\n\t<p class=\"lead\"><fmt:message key=\"jsp.search.didyoumean\"><fmt:param><a id=\"spellCheckQuery\" data-spell=\"<%= Utils.addEntities(spellCheckQuery) %>\" href=\"#\"><%= spellCheckQuery %></a></fmt:param></fmt:message></p>\n<% } %>                  \n        <input type=\"hidden\" value=\"<%= rpp %>\" name=\"rpp\" />\n        <input type=\"hidden\" value=\"<%= Utils.addEntities(sortedBy) %>\" name=\"sort_by\" />\n        <input type=\"hidden\" value=\"<%= Utils.addEntities(order) %>\" name=\"order\" />\n<% if (appliedFilters.size() > 0 ) { %>                                \n\t\t<div class=\"discovery-search-appliedFilters\">\n\t\t<span><fmt:message key=\"jsp.search.filter.applied\" /></span>\n\t\t<%\n\t\t\tint idx = 1;\n\t\t\tfor (String[] filter : appliedFilters)\n\t\t\t{\n\t\t\t    boolean found = false;\n\t\t\t    %>\n\t\t\t    <select id=\"filter_field_<%=idx %>\" name=\"filter_field_<%=idx %>\">\n\t\t\t\t<%\n\t\t\t\t\tfor (DiscoverySearchFilter searchFilter : availableFilters)\n\t\t\t\t\t{\n\t\t\t\t\t    String fkey = \"jsp.search.filter.\" + Escape.uriParam(searchFilter.getIndexFieldName());\n\t\t\t\t\t    %><option value=\"<%= Utils.addEntities(searchFilter.getIndexFieldName()) %>\"<% \n\t\t\t\t\t            if (searchFilter.getIndexFieldName().equals(filter[0]))\n\t\t\t\t\t            {\n\t\t\t\t\t                %> selected=\"selected\"<%\n\t\t\t\t\t                found = true;\n\t\t\t\t\t            }\n\t\t\t\t\t            %>><fmt:message key=\"<%= fkey %>\"/></option><%\n\t\t\t\t\t}\n\t\t\t\t\tif (!found)\n\t\t\t\t\t{\n\t\t\t\t\t    String fkey = \"jsp.search.filter.\" + Escape.uriParam(filter[0]);\n\t\t\t\t\t    %><option value=\"<%= Utils.addEntities(filter[0]) %>\" selected=\"selected\"><fmt:message key=\"<%= fkey %>\"/></option><%\n\t\t\t\t\t}\n\t\t\t\t%>\n\t\t\t\t</select>\n\t\t\t\t<select id=\"filter_type_<%=idx %>\" name=\"filter_type_<%=idx %>\">\n\t\t\t\t<%\n\t\t\t\t\tfor (String opt : options)\n\t\t\t\t\t{\n\t\t\t\t\t    String fkey = \"jsp.search.filter.op.\" + Escape.uriParam(opt);\n\t\t\t\t\t    %><option value=\"<%= Utils.addEntities(opt) %>\"<%= opt.equals(filter[1])?\" selected=\\\"selected\\\"\":\"\" %>><fmt:message key=\"<%= fkey %>\"/></option><%\n\t\t\t\t\t}\n\t\t\t\t%>\n\t\t\t\t</select>\n\t\t\t\t<input type=\"text\" id=\"filter_value_<%=idx %>\" name=\"filter_value_<%=idx %>\" value=\"<%= Utils.addEntities(filter[2]) %>\" size=\"45\"/>\n\t\t\t\t<input class=\"btn btn-default\" type=\"submit\" id=\"submit_filter_remove_<%=idx %>\" name=\"submit_filter_remove_<%=idx %>\" value=\"X\" />\n\t\t\t\t<br/>\n\t\t\t\t<%\n\t\t\t\tidx++;\n\t\t\t}\n\t\t%>\n\t\t</div>\n<% } %>\n<a class=\"btn btn-default\" href=\"<%= request.getContextPath()+\"/simple-search\" %>\"><fmt:message key=\"jsp.search.general.new-search\" /></a>\t\n\t\t</form>\n\t\t</div>\n<% if (availableFilters.size() > 0) { %>\n\t\t<div class=\"discovery-search-filters panel-body\">\n\t\t<h5><fmt:message key=\"jsp.search.filter.heading\" /></h5>\n\t\t<p class=\"discovery-search-filters-hint\"><fmt:message key=\"jsp.search.filter.hint\" /></p>\n\t\t<form action=\"simple-search\" method=\"get\">\n\t\t<input type=\"hidden\" value=\"<%= Utils.addEntities(searchScope) %>\" name=\"location\" />\n\t\t<input type=\"hidden\" value=\"<%= Utils.addEntities(query) %>\" name=\"query\" />\n\t\t<% if (appliedFilterQueries.size() > 0 ) { \n\t\t\t\tint idx = 1;\n\t\t\t\tfor (String[] filter : appliedFilters)\n\t\t\t\t{\n\t\t\t\t    boolean found = false;\n\t\t\t\t    %>\n\t\t\t\t    <input type=\"hidden\" id=\"filter_field_<%=idx %>\" name=\"filter_field_<%=idx %>\" value=\"<%= Utils.addEntities(filter[0]) %>\" />\n\t\t\t\t\t<input type=\"hidden\" id=\"filter_type_<%=idx %>\" name=\"filter_type_<%=idx %>\" value=\"<%= Utils.addEntities(filter[1]) %>\" />\n\t\t\t\t\t<input type=\"hidden\" id=\"filter_value_<%=idx %>\" name=\"filter_value_<%=idx %>\" value=\"<%= Utils.addEntities(filter[2]) %>\" />\n\t\t\t\t\t<%\n\t\t\t\t\tidx++;\n\t\t\t\t}\n\t\t} %>\n\t\t<select id=\"filtername\" name=\"filtername\">\n\t\t<%\n\t\t\tfor (DiscoverySearchFilter searchFilter : availableFilters)\n\t\t\t{\n\t\t\t    String fkey = \"jsp.search.filter.\" + Escape.uriParam(searchFilter.getIndexFieldName());\n\t\t\t    %><option value=\"<%= Utils.addEntities(searchFilter.getIndexFieldName()) %>\"><fmt:message key=\"<%= fkey %>\"/></option><%\n\t\t\t}\n\t\t%>\n\t\t</select>\n\t\t<select id=\"filtertype\" name=\"filtertype\">\n\t\t<%\n\t\t\tfor (String opt : options)\n\t\t\t{\n\t\t\t    String fkey = \"jsp.search.filter.op.\" + Escape.uriParam(opt);\n\t\t\t    %><option value=\"<%= Utils.addEntities(opt) %>\"><fmt:message key=\"<%= fkey %>\"/></option><%\n\t\t\t}\n\t\t%>\n\t\t</select>\n\t\t<input type=\"text\" id=\"filterquery\" name=\"filterquery\" size=\"45\" required=\"required\" />\n\t\t<input type=\"hidden\" value=\"<%= rpp %>\" name=\"rpp\" />\n\t\t<input type=\"hidden\" value=\"<%= Utils.addEntities(sortedBy) %>\" name=\"sort_by\" />\n\t\t<input type=\"hidden\" value=\"<%= Utils.addEntities(order) %>\" name=\"order\" />\n\t\t<input class=\"btn btn-default\" type=\"submit\" value=\"<fmt:message key=\"jsp.search.filter.add\"/>\" onclick=\"return validateFilters()\" />\n\t\t</form>\n\t\t</div>        \n<% } %>\n        <%-- Include a component for modifying sort by, order, results per page, and et-al limit --%>\n   <div class=\"discovery-pagination-controls panel-footer\">\n   <form action=\"simple-search\" method=\"get\">\n   <input type=\"hidden\" value=\"<%= Utils.addEntities(searchScope) %>\" name=\"location\" />\n   <input type=\"hidden\" value=\"<%= Utils.addEntities(query) %>\" name=\"query\" />\n\t<% if (appliedFilterQueries.size() > 0 ) { \n\t\t\t\tint idx = 1;\n\t\t\t\tfor (String[] filter : appliedFilters)\n\t\t\t\t{\n\t\t\t\t    boolean found = false;\n\t\t\t\t    %>\n\t\t\t\t    <input type=\"hidden\" id=\"filter_field_<%=idx %>\" name=\"filter_field_<%=idx %>\" value=\"<%= Utils.addEntities(filter[0]) %>\" />\n\t\t\t\t\t<input type=\"hidden\" id=\"filter_type_<%=idx %>\" name=\"filter_type_<%=idx %>\" value=\"<%= Utils.addEntities(filter[1]) %>\" />\n\t\t\t\t\t<input type=\"hidden\" id=\"filter_value_<%=idx %>\" name=\"filter_value_<%=idx %>\" value=\"<%= Utils.addEntities(filter[2]) %>\" />\n\t\t\t\t\t<%\n\t\t\t\t\tidx++;\n\t\t\t\t}\n\t} %>\t\n           <label for=\"rpp\"><fmt:message key=\"search.results.perpage\"/></label>\n           <select name=\"rpp\" id=\"rpp\">\n<%\n               for (int i = 5; i <= 100 ; i += 5)\n               {\n                   String selected = (i == rpp ? \"selected=\\\"selected\\\"\" : \"\");\n%>\n                   <option value=\"<%= i %>\" <%= selected %>><%= i %></option>\n<%\n               }\n%>\n           </select>\n           &nbsp;|&nbsp;\n<%\n           if (sortOptions.size() > 0)\n           {\n%>\n               <label for=\"sort_by\"><fmt:message key=\"search.results.sort-by\"/></label>\n               <select name=\"sort_by\" id=\"sort_by\">\n                   <option value=\"score\"><fmt:message key=\"search.sort-by.relevance\"/></option>\n<%\n               for (String sortBy : sortOptions)\n               {\n                   String selected = (sortBy.equals(sortedBy) ? \"selected=\\\"selected\\\"\" : \"\");\n                   String mKey = \"search.sort-by.\" + Utils.addEntities(sortBy);\n                   %> <option value=\"<%= Utils.addEntities(sortBy) %>\" <%= selected %>><fmt:message key=\"<%= mKey %>\"/></option><%\n               }\n%>\n               </select>\n<%\n           }\n%>\n           <label for=\"order\"><fmt:message key=\"search.results.order\"/></label>\n           <select name=\"order\" id=\"order\">\n               <option value=\"ASC\" <%= ascSelected %>><fmt:message key=\"search.order.asc\" /></option>\n               <option value=\"DESC\" <%= descSelected %>><fmt:message key=\"search.order.desc\" /></option>\n           </select>\n           <label for=\"etal\"><fmt:message key=\"search.results.etal\" /></label>\n           <select name=\"etal\" id=\"etal\">\n<%\n               String unlimitedSelect = \"\";\n               if (etAl < 1)\n               {\n                   unlimitedSelect = \"selected=\\\"selected\\\"\";\n               }\n%>\n               <option value=\"0\" <%= unlimitedSelect %>><fmt:message key=\"browse.full.etal.unlimited\"/></option>\n<%\n               boolean insertedCurrent = false;\n               for (int i = 0; i <= 50 ; i += 5)\n               {\n                   // for the first one, we want 1 author, not 0\n                   if (i == 0)\n                   {\n                       String sel = (i + 1 == etAl ? \"selected=\\\"selected\\\"\" : \"\");\n                       %><option value=\"1\" <%= sel %>>1</option><%\n                   }\n\n                   // if the current i is greated than that configured by the user,\n                   // insert the one specified in the right place in the list\n                   if (i > etAl && !insertedCurrent && etAl > 1)\n                   {\n                       %><option value=\"<%= etAl %>\" selected=\"selected\"><%= etAl %></option><%\n                       insertedCurrent = true;\n                   }\n\n                   // determine if the current not-special case is selected\n                   String selected = (i == etAl ? \"selected=\\\"selected\\\"\" : \"\");\n\n                   // do this for all other cases than the first and the current\n                   if (i != 0 && i != etAl)\n                   {\n%>\n                       <option value=\"<%= i %>\" <%= selected %>><%= i %></option>\n<%\n                   }\n               }\n%>\n           </select>\n           <input class=\"btn btn-default\" type=\"submit\" name=\"submit_search\" value=\"<fmt:message key=\"search.update\" />\" />\n\n<%\n    if (admin_button)\n    {\n        %><input type=\"submit\" class=\"btn btn-default\" name=\"submit_export_metadata\" value=\"<fmt:message key=\"jsp.general.metadataexport.button\"/>\" /><%\n    }\n%>\n</form>\n   </div>\n</div>   \n<% \n\nDiscoverResult qResults = (DiscoverResult)request.getAttribute(\"queryresults\");\nList<Item>      items       = (List<Item>      )request.getAttribute(\"items\");\nList<Community> communities = (List<Community> )request.getAttribute(\"communities\");\nList<Collection>collections = (List<Collection>)request.getAttribute(\"collections\");\n\nif( error )\n{\n %>\n\t<p align=\"center\" class=\"submitFormWarn\">\n\t\t<fmt:message key=\"jsp.search.error.discovery\" />\n\t</p>\n\t<%\n}\nelse if( qResults != null && qResults.getTotalSearchResults() == 0 )\n{\n %>\n    <%-- <p align=\"center\">Search produced no results.</p> --%>\n    <p align=\"center\"><fmt:message key=\"jsp.search.general.noresults\"/></p>\n<%\n}\nelse if( qResults != null)\n{\n    long pageTotal   = ((Long)request.getAttribute(\"pagetotal\"  )).longValue();\n    long pageCurrent = ((Long)request.getAttribute(\"pagecurrent\")).longValue();\n    long pageLast    = ((Long)request.getAttribute(\"pagelast\"   )).longValue();\n    long pageFirst   = ((Long)request.getAttribute(\"pagefirst\"  )).longValue();\n    \n    // create the URLs accessing the previous and next search result pages\n    String baseURL =  request.getContextPath()\n                    + (!searchScope.equals(\"\") ? \"/handle/\" + searchScope : \"\")\n                    + \"/simple-search?query=\"\n                    + URLEncoder.encode(query,\"UTF-8\")\n                    + httpFilters\n                    + \"&amp;sort_by=\" + sortedBy\n                    + \"&amp;order=\" + order\n                    + \"&amp;rpp=\" + rpp\n                    + \"&amp;etal=\" + etAl\n                    + \"&amp;start=\";\n\n    String nextURL = baseURL;\n    String firstURL = baseURL;\n    String lastURL = baseURL;\n\n    String prevURL = baseURL\n            + (pageCurrent-2) * qResults.getMaxResults();\n\n    nextURL = nextURL\n            + (pageCurrent) * qResults.getMaxResults();\n    \n    firstURL = firstURL +\"0\";\n    lastURL = lastURL + (pageTotal-1) * qResults.getMaxResults();\n\n\n%>\n<hr/>\n<div class=\"discovery-result-pagination row\">\n<%\n\tlong lastHint = qResults.getStart()+qResults.getMaxResults() <= qResults.getTotalSearchResults()?\n\t        qResults.getStart()+qResults.getMaxResults():qResults.getTotalSearchResults();\n%>\n    <%-- <p align=\"center\">Results <//%=qResults.getStart()+1%>-<//%=qResults.getStart()+qResults.getHitHandles().size()%> of --%>\n\t<div class=\"alert alert-info\"><fmt:message key=\"jsp.search.results.results\">\n        <fmt:param><%=qResults.getStart()+1%></fmt:param>\n        <fmt:param><%=lastHint%></fmt:param>\n        <fmt:param><%=qResults.getTotalSearchResults()%></fmt:param>\n        <fmt:param><%=(float) qResults.getSearchTime() / 1000%></fmt:param>\n    </fmt:message></div>\n    <ul class=\"pagination pull-right\">\n\t<%\n\tif (pageFirst != pageCurrent)\n\t{\n\t    %><li><a href=\"<%= prevURL %>\"><fmt:message key=\"jsp.search.general.previous\" /></a></li><%\n\t}\n\telse\n\t{\n\t    %><li class=\"disabled\"><span><fmt:message key=\"jsp.search.general.previous\" /></span></li><%\n\t}\n\t\n\tif (pageFirst != 1)\n\t{\n\t    %><li><a href=\"<%= firstURL %>\">1</a></li><li class=\"disabled\"><span>...</span></li><%\n\t}\n\t\n\tfor( long q = pageFirst; q <= pageLast; q++ )\n\t{\n\t    String myLink = \"<li><a href=\\\"\"\n\t                    + baseURL;\n\t\n\t\n\t    if( q == pageCurrent )\n\t    {\n\t        myLink = \"<li class=\\\"active\\\"><span>\" + q + \"</span></li>\";\n\t    }\n\t    else\n\t    {\n\t        myLink = myLink\n\t            + (q-1) * qResults.getMaxResults()\n\t            + \"\\\">\"\n\t            + q\n\t            + \"</a></li>\";\n\t    }\n\t%>\n\t\n\t<%= myLink %>\n\n\t<%\n\t}\n\t\n\tif (pageTotal > pageLast)\n\t{\n\t    %><li class=\"disabled\"><span>...</span></li><li><a href=\"<%= lastURL %>\"><%= pageTotal %></a></li><%\n\t}\n\tif (pageTotal > pageCurrent)\n\t{\n\t    %><li><a href=\"<%= nextURL %>\"><fmt:message key=\"jsp.search.general.next\" /></a></li><%\n\t}\n\telse\n\t{\n\t    %><li class=\"disabled\"><span><fmt:message key=\"jsp.search.general.next\" /></span></li><%\n\t}\n\t%>\n\t</ul>\n<!-- give a content to the div -->\n</div>\n<div class=\"discovery-result-results row\">\n<% if (communities.size() > 0 ) { %>\n    <div class=\"panel panel-info\">\n    <div class=\"panel-heading\"><fmt:message key=\"jsp.search.results.comhits\"/></div>\n    <dspace:communitylist  communities=\"<%= communities %>\" />\n    </div>\n<% } %>\n\n<% if (collections.size() > 0 ) { %>\n    <div class=\"panel panel-info\">\n    <div class=\"panel-heading\"><fmt:message key=\"jsp.search.results.colhits\"/></div>\n    <dspace:collectionlist collections=\"<%= collections %>\" />\n    </div>\n<% } %>\n\n<% if (items.size() > 0) { %>\n    <div class=\"panel panel-info\">\n    <div class=\"panel-heading\"><fmt:message key=\"jsp.search.results.itemhits\"/></div>\n    <dspace:itemlist items=\"<%= items %>\" authorLimit=\"<%= etAl %>\" />\n    </div>\n<% } %>\n</div>\n<%-- if the result page is enought long... --%>\n<% if ((communities.size() + collections.size() + items.size()) > 10) {%>\n<%-- show again the navigation info/links --%>\n<div class=\"discovery-result-pagination row container\">\n    <%-- <p align=\"center\">Results <//%=qResults.getStart()+1%>-<//%=qResults.getStart()+qResults.getHitHandles().size()%> of --%>\n\t<div class=\"alert alert-info\"><fmt:message key=\"jsp.search.results.results\">\n        <fmt:param><%=qResults.getStart()+1%></fmt:param>\n        <fmt:param><%=lastHint%></fmt:param>\n        <fmt:param><%=qResults.getTotalSearchResults()%></fmt:param>\n        <fmt:param><%=(float) qResults.getSearchTime() / 1000 %></fmt:param>\n    </fmt:message></div>\n    <ul class=\"pagination pull-right\">\n<%\nif (pageFirst != pageCurrent)\n{\n    %><li><a href=\"<%= prevURL %>\"><fmt:message key=\"jsp.search.general.previous\" /></a></li><%\n}\nelse\n{\n    %><li class=\"disabled\"><span><fmt:message key=\"jsp.search.general.previous\" /></span></li><%\n}    \n\nif (pageFirst != 1)\n{\n    %><li><a href=\"<%= firstURL %>\">1</a></li><li class=\"disabled\"><span>...</span></li><%\n}\n\nfor( long q = pageFirst; q <= pageLast; q++ )\n{\n    String myLink = \"<li><a href=\\\"\"\n                    + baseURL;\n\n\n    if( q == pageCurrent )\n    {\n        myLink = \"<li class=\\\"active\\\"><span>\" + q + \"</span></li>\";\n    }\n    else\n    {\n        myLink = myLink\n            + (q-1) * qResults.getMaxResults()\n            + \"\\\">\"\n            + q\n            + \"</a></li>\";\n    }\n%>\n\n<%= myLink %>\n\n<%\n}\n\nif (pageTotal > pageLast)\n{\n    %><li class=\"disabled\"><span>...</span></li><li><a href=\"<%= lastURL %>\"><%= pageTotal %></a></li><%\n}\nif (pageTotal > pageCurrent)\n{\n    %><li><a href=\"<%= nextURL %>\"><fmt:message key=\"jsp.search.general.next\" /></a></li><%\n}\nelse\n{\n    %><li class=\"disabled\"><span><fmt:message key=\"jsp.search.general.next\" /></span></li><%\n}\n%>\n</ul>\n<!-- give a content to the div -->\n</div>\n<% } %>\n<% } %>\n<dspace:sidebar>\n<%\n\tboolean brefine = false;\n\t\n\tList<DiscoverySearchFilterFacet> facetsConf = (List<DiscoverySearchFilterFacet>) request.getAttribute(\"facetsConfig\");\n\tMap<String, Boolean> showFacets = new HashMap<String, Boolean>();\n\t\t\n\tfor (DiscoverySearchFilterFacet facetConf : facetsConf)\n\t{\n\t\tif(qResults!=null) {\n\t\t    String f = facetConf.getIndexFieldName();\n\t\t    List<FacetResult> facet = qResults.getFacetResult(f);\n\t\t    if (facet.size() == 0)\n\t\t    {\n\t\t        facet = qResults.getFacetResult(f+\".year\");\n\t\t\t    if (facet.size() == 0)\n\t\t\t    {\n\t\t\t        showFacets.put(f, false);\n\t\t\t        continue;\n\t\t\t    }\n\t\t    }\n\t\t    boolean showFacet = false;\n\t\t    for (FacetResult fvalue : facet)\n\t\t    { \n\t\t\t\tif(!appliedFilterQueries.contains(f+\"::\"+fvalue.getFilterType()+\"::\"+fvalue.getAsFilterQuery()))\n\t\t\t    {\n\t\t\t        showFacet = true;\n\t\t\t        break;\n\t\t\t    }\n\t\t    }\n\t\t    showFacets.put(f, showFacet);\n\t\t    brefine = brefine || showFacet;\n\t\t}\n\t}\n\tif (brefine) {\n%>\n\n<h3 class=\"facets\"><fmt:message key=\"jsp.search.facet.refine\" /></h3>\n<div id=\"facets\" class=\"facetsBox\">\n\n<%\n\tfor (DiscoverySearchFilterFacet facetConf : facetsConf)\n\t{\n\t    String f = facetConf.getIndexFieldName();\n\t    if (!showFacets.get(f))\n\t        continue;\n\t    List<FacetResult> facet = qResults.getFacetResult(f);\n\t    if (facet.size() == 0)\n\t    {\n\t        facet = qResults.getFacetResult(f+\".year\");\n\t    }\n\t    int limit = facetConf.getFacetLimit()+1;\n\t    \n\t    String fkey = \"jsp.search.facet.refine.\"+f;\n\t    %><div id=\"facet_<%= f %>\" class=\"panel panel-success\">\n\t    <div class=\"panel-heading\"><fmt:message key=\"<%= fkey %>\" /></div>\n\t    <ul class=\"list-group\"><%\n\t    int idx = 1;\n\t    int currFp = UIUtil.getIntParameter(request, f+\"_page\");\n\t    if (currFp < 0)\n\t    {\n\t        currFp = 0;\n\t    }\n\t    for (FacetResult fvalue : facet)\n\t    { \n\t        if (idx != limit && !appliedFilterQueries.contains(f+\"::\"+fvalue.getFilterType()+\"::\"+fvalue.getAsFilterQuery()))\n\t        {\n\t        %><li class=\"list-group-item\"><span class=\"badge\"><%= fvalue.getCount() %></span> <a href=\"<%= request.getContextPath()\n                + (!searchScope.equals(\"\")?\"/handle/\"+searchScope:\"\")\n                + \"/simple-search?query=\"\n                + URLEncoder.encode(query,\"UTF-8\")\n                + \"&amp;sort_by=\" + sortedBy\n                + \"&amp;order=\" + order\n                + \"&amp;rpp=\" + rpp\n                + httpFilters\n                + \"&amp;etal=\" + etAl\n                + \"&amp;filtername=\"+URLEncoder.encode(f,\"UTF-8\")\n                + \"&amp;filterquery=\"+URLEncoder.encode(fvalue.getAsFilterQuery(),\"UTF-8\")\n                + \"&amp;filtertype=\"+URLEncoder.encode(fvalue.getFilterType(),\"UTF-8\") %>\"\n                title=\"<fmt:message key=\"jsp.search.facet.narrow\"><fmt:param><%=fvalue.getDisplayedValue() %></fmt:param></fmt:message>\">\n                <%= StringUtils.abbreviate(fvalue.getDisplayedValue(),36) %></a></li><%\n                idx++;\n\t        }\n\t        if (idx > limit)\n\t        {\n\t            break;\n\t        }\n\t    }\n\t    if (currFp > 0 || idx == limit)\n\t    {\n\t        %><li class=\"list-group-item\"><span style=\"visibility: hidden;\">.</span>\n\t        <% if (currFp > 0) { %>\n\t        <a class=\"pull-left\" href=\"<%= request.getContextPath()\n\t            + (!searchScope.equals(\"\")?\"/handle/\"+searchScope:\"\")\n                + \"/simple-search?query=\"\n                + URLEncoder.encode(query,\"UTF-8\")\n                + \"&amp;sort_by=\" + sortedBy\n                + \"&amp;order=\" + order\n                + \"&amp;rpp=\" + rpp\n                + httpFilters\n                + \"&amp;etal=\" + etAl  \n                + \"&amp;\"+f+\"_page=\"+(currFp-1) %>\"><fmt:message key=\"jsp.search.facet.refine.previous\" /></a>\n            <% } %>\n            <% if (idx == limit) { %>\n            <a href=\"<%= request.getContextPath()\n\t            + (!searchScope.equals(\"\")?\"/handle/\"+searchScope:\"\")\n                + \"/simple-search?query=\"\n                + URLEncoder.encode(query,\"UTF-8\")\n                + \"&amp;sort_by=\" + sortedBy\n                + \"&amp;order=\" + order\n                + \"&amp;rpp=\" + rpp\n                + httpFilters\n                + \"&amp;etal=\" + etAl  \n                + \"&amp;\"+f+\"_page=\"+(currFp+1) %>\"><span class=\"pull-right\"><fmt:message key=\"jsp.search.facet.refine.next\" /></span></a>\n            <%\n            }\n            %></li><%\n\t    }\n\t    %></ul></div><%\n\t}\n\n%>\n\n</div>\n<% } %>\n</dspace:sidebar>\n</dspace:layout>\n"], "filenames": ["dspace-jspui/src/main/webapp/search/discovery.jsp"], "buggy_code_start_loc": [150], "buggy_code_end_loc": [161], "fixing_code_start_loc": [150], "fixing_code_end_loc": [167], "type": "CWE-79", "message": "DSpace open source software is a repository application which provides durable access to digital resources. dspace-jspui is a UI component for DSpace. The JSPUI spellcheck \"Did you mean\" HTML escapes the data-spell attribute in the link, but not the actual displayed text. Similarly, the JSPUI autocomplete HTML does not properly escape text passed to it. Both are vulnerable to XSS. This vulnerability only impacts the JSPUI. Users are advised to upgrade. There are no known workarounds for this issue.", "other": {"cve": {"id": "CVE-2022-31191", "sourceIdentifier": "security-advisories@github.com", "published": "2022-08-01T21:15:13.280", "lastModified": "2022-08-08T17:04:51.190", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "DSpace open source software is a repository application which provides durable access to digital resources. dspace-jspui is a UI component for DSpace. The JSPUI spellcheck \"Did you mean\" HTML escapes the data-spell attribute in the link, but not the actual displayed text. Similarly, the JSPUI autocomplete HTML does not properly escape text passed to it. Both are vulnerable to XSS. This vulnerability only impacts the JSPUI. Users are advised to upgrade. There are no known workarounds for this issue."}, {"lang": "es", "value": "El software de c\u00f3digo abierto DSpace es una aplicaci\u00f3n de repositorio que proporciona acceso duradero a los recursos digitales. dspace-jspui es un componente de interfaz de usuario para DSpace. El corrector ortogr\u00e1fico de JSPUI \"Did you mean\" HTML escapa el atributo data-spell en el enlace, pero no el texto real mostrado. Del mismo modo, el HTML de autocompletar de JSPUI no escapa correctamente el texto que le es  pasado. Ambos son vulnerables a un ataque de tipo XSS. Esta vulnerabilidad s\u00f3lo afecta a la JSPUI. Es recomendado a usuarios actualizar. No se presentan mitigaciones conocidas para este problema"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}, {"source": "security-advisories@github.com", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:L", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "LOW", "baseScore": 7.1, "baseSeverity": "HIGH"}, "exploitabilityScore": 2.8, "impactScore": 3.7}]}, "weaknesses": [{"source": "security-advisories@github.com", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:duraspace:dspace:*:*:*:*:*:*:*:*", "versionStartExcluding": "4.0", "versionEndIncluding": "5.10", "matchCriteriaId": "89609B7B-870E-41BB-98F5-9F0BDA11A08C"}, {"vulnerable": true, "criteria": "cpe:2.3:a:duraspace:dspace:*:*:*:*:*:*:*:*", "versionStartExcluding": "6.0", "versionEndExcluding": "6.4", "matchCriteriaId": "27C1503E-2C8B-43CD-8937-9ABE6C24C67F"}]}]}], "references": [{"url": "https://github.com/DSpace/DSpace/commit/35030a23e48b5946f5853332c797e1c4adea7bb7", "source": "security-advisories@github.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/DSpace/DSpace/commit/6f75bb084ab1937d094208c55cd84340040bcbb5", "source": "security-advisories@github.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/DSpace/DSpace/commit/c89e493e517b424dea6175caba54e91d3847fc3a", "source": "security-advisories@github.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/DSpace/DSpace/commit/ebb83a75234d3de9be129464013e998dc929b68d", "source": "security-advisories@github.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/DSpace/DSpace/security/advisories/GHSA-c558-5gfm-p2r8", "source": "security-advisories@github.com", "tags": ["Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/DSpace/DSpace/commit/35030a23e48b5946f5853332c797e1c4adea7bb7"}}