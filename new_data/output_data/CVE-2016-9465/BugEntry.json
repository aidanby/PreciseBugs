{"buggy_code": ["<?php\n/**\n * @copyright Copyright (c) 2016, ownCloud, Inc.\n *\n * @author Georg Ehrke <georg@owncloud.com>\n *\n * @license AGPL-3.0\n *\n * This code is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License, version 3,\n * as published by the Free Software Foundation.\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License, version 3,\n * along with this program.  If not, see <http://www.gnu.org/licenses/>\n *\n */\n\nnamespace OCA\\DAV\\CardDAV;\n\nuse OCP\\ILogger;\nuse Sabre\\CardDAV\\Card;\nuse Sabre\\DAV\\Server;\nuse Sabre\\DAV\\ServerPlugin;\nuse Sabre\\HTTP\\RequestInterface;\nuse Sabre\\HTTP\\ResponseInterface;\nuse Sabre\\VObject\\Parameter;\nuse Sabre\\VObject\\Property\\Binary;\nuse Sabre\\VObject\\Reader;\n\nclass ImageExportPlugin extends ServerPlugin {\n\n\t/** @var Server */\n\tprotected $server;\n\t/** @var ILogger */\n\tprivate $logger;\n\n\tpublic function __construct(ILogger $logger) {\n\t\t$this->logger = $logger;\n\t}\n\n\t/**\n\t * Initializes the plugin and registers event handlers\n\t *\n\t * @param Server $server\n\t * @return void\n\t */\n\tfunction initialize(Server $server) {\n\n\t\t$this->server = $server;\n\t\t$this->server->on('method:GET', [$this, 'httpGet'], 90);\n\t}\n\n\t/**\n\t * Intercepts GET requests on addressbook urls ending with ?photo.\n\t *\n\t * @param RequestInterface $request\n\t * @param ResponseInterface $response\n\t * @return bool|void\n\t */\n\tfunction httpGet(RequestInterface $request, ResponseInterface $response) {\n\n\t\t$queryParams = $request->getQueryParameters();\n\t\t// TODO: in addition to photo we should also add logo some point in time\n\t\tif (!array_key_exists('photo', $queryParams)) {\n\t\t\treturn true;\n\t\t}\n\n\t\t$path = $request->getPath();\n\t\t$node = $this->server->tree->getNodeForPath($path);\n\n\t\tif (!($node instanceof Card)) {\n\t\t\treturn true;\n\t\t}\n\n\t\t$this->server->transactionType = 'carddav-image-export';\n\n\t\t// Checking ACL, if available.\n\t\tif ($aclPlugin = $this->server->getPlugin('acl')) {\n\t\t\t/** @var \\Sabre\\DAVACL\\Plugin $aclPlugin */\n\t\t\t$aclPlugin->checkPrivileges($path, '{DAV:}read');\n\t\t}\n\n\t\tif ($result = $this->getPhoto($node)) {\n\t\t\t$response->setHeader('Content-Type', $result['Content-Type']);\n\t\t\t$response->setStatus(200);\n\n\t\t\t$response->setBody($result['body']);\n\n\t\t\t// Returning false to break the event chain\n\t\t\treturn false;\n\t\t}\n\t\treturn true;\n\t}\n\n\tfunction getPhoto(Card $node) {\n\t\t// TODO: this is kind of expensive - load carddav data from database and parse it\n\t\t//       we might want to build up a cache one day\n\t\ttry {\n\t\t\t$vObject = $this->readCard($node->get());\n\t\t\tif (!$vObject->PHOTO) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t$photo = $vObject->PHOTO;\n\t\t\t$type = $this->getType($photo);\n\n\t\t\t$val = $photo->getValue();\n\t\t\tif ($photo->getValueType() === 'URI') {\n\t\t\t\t$parsed = \\Sabre\\URI\\parse($val);\n\t\t\t\t//only allow data://\n\t\t\t\tif ($parsed['scheme'] !== 'data') {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t\tif (substr_count($parsed['path'], ';') === 1) {\n\t\t\t\t\tlist($type,) = explode(';', $parsed['path']);\n\t\t\t\t}\n\t\t\t\t$val = file_get_contents($val);\n\t\t\t}\n\t\t\treturn [\n\t\t\t\t'Content-Type' => $type,\n\t\t\t\t'body' => $val\n\t\t\t];\n\t\t} catch(\\Exception $ex) {\n\t\t\t$this->logger->logException($ex);\n\t\t}\n\t\treturn false;\n\t}\n\n\tprivate function readCard($cardData) {\n\t\treturn Reader::read($cardData);\n\t}\n\n\t/**\n\t * @param Binary $photo\n\t * @return Parameter\n\t */\n\tprivate function getType($photo) {\n\t\t$params = $photo->parameters();\n\t\tif (isset($params['TYPE']) || isset($params['MEDIATYPE'])) {\n\t\t\t/** @var Parameter $typeParam */\n\t\t\t$typeParam = isset($params['TYPE']) ? $params['TYPE'] : $params['MEDIATYPE'];\n\t\t\t$type = $typeParam->getValue();\n\n\t\t\tif (strpos($type, 'image/') === 0) {\n\t\t\t\treturn $type;\n\t\t\t} else {\n\t\t\t\treturn 'image/' . strtolower($type);\n\t\t\t}\n\t\t}\n\t\treturn '';\n\t}\n}\n", "<?php\n/**\n * @copyright Copyright (c) 2016, ownCloud, Inc.\n *\n * @author Georg Ehrke <georg@owncloud.com>\n * @author Roeland Jago Douma <roeland@famdouma.nl>\n *\n * @license AGPL-3.0\n *\n * This code is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License, version 3,\n * as published by the Free Software Foundation.\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License, version 3,\n * along with this program.  If not, see <http://www.gnu.org/licenses/>\n *\n */\n\n\nnamespace OCA\\DAV\\Tests\\unit\\CardDAV;\n\n\nuse OCA\\DAV\\CardDAV\\ImageExportPlugin;\nuse OCP\\ILogger;\nuse Sabre\\CardDAV\\Card;\nuse Sabre\\DAV\\Server;\nuse Sabre\\DAV\\Tree;\nuse Sabre\\HTTP\\RequestInterface;\nuse Sabre\\HTTP\\ResponseInterface;\nuse Test\\TestCase;\n\nclass ImageExportPluginTest extends TestCase {\n\n\t/** @var ResponseInterface | \\PHPUnit_Framework_MockObject_MockObject */\n\tprivate $response;\n\t/** @var RequestInterface | \\PHPUnit_Framework_MockObject_MockObject */\n\tprivate $request;\n\t/** @var ImageExportPlugin | \\PHPUnit_Framework_MockObject_MockObject */\n\tprivate $plugin;\n\t/** @var Server */\n\tprivate $server;\n\t/** @var Tree | \\PHPUnit_Framework_MockObject_MockObject */\n\tprivate $tree;\n\t/** @var ILogger | \\PHPUnit_Framework_MockObject_MockObject */\n\tprivate $logger;\n\n\tfunction setUp() {\n\t\tparent::setUp();\n\n\t\t$this->request = $this->getMockBuilder('Sabre\\HTTP\\RequestInterface')->getMock();\n\t\t$this->response = $this->getMockBuilder('Sabre\\HTTP\\ResponseInterface')->getMock();\n\t\t$this->server = $this->getMockBuilder('Sabre\\DAV\\Server')->getMock();\n\t\t$this->tree = $this->getMockBuilder('Sabre\\DAV\\Tree')->disableOriginalConstructor()->getMock();\n\t\t$this->server->tree = $this->tree;\n\t\t$this->logger = $this->getMockBuilder('\\OCP\\ILogger')->getMock();\n\n\t\t$this->plugin = $this->getMockBuilder('OCA\\DAV\\CardDAV\\ImageExportPlugin')\n\t\t\t->setMethods(['getPhoto'])\n\t\t\t->setConstructorArgs([$this->logger])\n\t\t\t->getMock();\n\t\t$this->plugin->initialize($this->server);\n\t}\n\n\t/**\n\t * @dataProvider providesQueryParams\n\t * @param $param\n\t */\n\tpublic function testQueryParams($param) {\n\t\t$this->request->expects($this->once())->method('getQueryParameters')->willReturn($param);\n\t\t$result = $this->plugin->httpGet($this->request, $this->response);\n\t\t$this->assertTrue($result);\n\t}\n\n\tpublic function providesQueryParams() {\n\t\treturn [\n\t\t\t[[]],\n\t\t\t[['1']],\n\t\t\t[['foo' => 'bar']],\n\t\t];\n\t}\n\n\tpublic function testNotACard() {\n\t\t$this->request->expects($this->once())->method('getQueryParameters')->willReturn(['photo' => true]);\n\t\t$this->request->expects($this->once())->method('getPath')->willReturn('/files/welcome.txt');\n\t\t$this->tree->expects($this->once())->method('getNodeForPath')->with('/files/welcome.txt')->willReturn(null);\n\t\t$result = $this->plugin->httpGet($this->request, $this->response);\n\t\t$this->assertTrue($result);\n\t}\n\n\t/**\n\t * @dataProvider providesCardWithOrWithoutPhoto\n\t * @param bool $expected\n\t * @param array $getPhotoResult\n\t */\n\tpublic function testCardWithOrWithoutPhoto($expected, $getPhotoResult) {\n\t\t$this->request->expects($this->once())->method('getQueryParameters')->willReturn(['photo' => true]);\n\t\t$this->request->expects($this->once())->method('getPath')->willReturn('/files/welcome.txt');\n\n\t\t$card = $this->getMockBuilder('Sabre\\CardDAV\\Card')->disableOriginalConstructor()->getMock();\n\t\t$this->tree->expects($this->once())->method('getNodeForPath')->with('/files/welcome.txt')->willReturn($card);\n\n\t\t$this->plugin->expects($this->once())->method('getPhoto')->willReturn($getPhotoResult);\n\n\t\tif (!$expected) {\n\t\t\t$this->response->expects($this->once())->method('setHeader');\n\t\t\t$this->response->expects($this->once())->method('setStatus');\n\t\t\t$this->response->expects($this->once())->method('setBody');\n\t\t}\n\n\t\t$result = $this->plugin->httpGet($this->request, $this->response);\n\t\t$this->assertEquals($expected, $result);\n\t}\n\n\tpublic function providesCardWithOrWithoutPhoto() {\n\t\treturn [\n\t\t\t[true, null],\n\t\t\t[false, ['Content-Type' => 'image/jpeg', 'body' => '1234']],\n\t\t];\n\t}\n\n\t/**\n\t * @dataProvider providesPhotoData\n\t * @param $expected\n\t * @param $cardData\n\t */\n\tpublic function testGetPhoto($expected, $cardData) {\n\t\t/** @var Card | \\PHPUnit_Framework_MockObject_MockObject $card */\n\t\t$card = $this->getMockBuilder('Sabre\\CardDAV\\Card')->disableOriginalConstructor()->getMock();\n\t\t$card->expects($this->once())->method('get')->willReturn($cardData);\n\n\t\t$this->plugin = new ImageExportPlugin($this->logger);\n\t\t$this->plugin->initialize($this->server);\n\n\t\t$result = $this->plugin->getPhoto($card);\n\t\t$this->assertEquals($expected, $result);\n\t}\n\n\tpublic function providesPhotoData() {\n\t\treturn [\n\t\t\t'empty vcard' => [false, ''],\n\t\t\t'vcard without PHOTO' => [false, \"BEGIN:VCARD\\r\\nVERSION:3.0\\r\\nPRODID:-//Sabre//Sabre VObject 3.5.0//EN\\r\\nUID:12345\\r\\nFN:12345\\r\\nN:12345;;;;\\r\\nEND:VCARD\\r\\n\"],\n\t\t\t'vcard 3 with PHOTO' => [['Content-Type' => 'image/jpeg', 'body' => '12345'], \"BEGIN:VCARD\\r\\nVERSION:3.0\\r\\nPRODID:-//Sabre//Sabre VObject 3.5.0//EN\\r\\nUID:12345\\r\\nFN:12345\\r\\nN:12345;;;;\\r\\nPHOTO;ENCODING=b;TYPE=JPEG:MTIzNDU=\\r\\nEND:VCARD\\r\\n\"],\n\t\t\t'vcard 3 with PHOTO URL' => [false, \"BEGIN:VCARD\\r\\nVERSION:3.0\\r\\nPRODID:-//Sabre//Sabre VObject 3.5.0//EN\\r\\nUID:12345\\r\\nFN:12345\\r\\nN:12345;;;;\\r\\nPHOTO;TYPE=JPEG;VALUE=URI:http://example.com/photo.jpg\\r\\nEND:VCARD\\r\\n\"],\n\t\t\t'vcard 4 with PHOTO' => [['Content-Type' => 'image/jpeg', 'body' => '12345'], \"BEGIN:VCARD\\r\\nVERSION:4.0\\r\\nPRODID:-//Sabre//Sabre VObject 3.5.0//EN\\r\\nUID:12345\\r\\nFN:12345\\r\\nN:12345;;;;\\r\\nPHOTO:data:image/jpeg;base64,MTIzNDU=\\r\\nEND:VCARD\\r\\n\"],\n\t\t\t'vcard 4 with PHOTO URL' => [false, \"BEGIN:VCARD\\r\\nVERSION:4.0\\r\\nPRODID:-//Sabre//Sabre VObject 3.5.0//EN\\r\\nUID:12345\\r\\nFN:12345\\r\\nN:12345;;;;\\r\\nPHOTO;MEDIATYPE=image/jpeg:http://example.org/photo.jpg\\r\\nEND:VCARD\\r\\n\"],\n\t\t];\n\t}\n}\n"], "fixing_code": ["<?php\n/**\n * @copyright Copyright (c) 2016, ownCloud, Inc.\n *\n * @author Georg Ehrke <georg@owncloud.com>\n *\n * @license AGPL-3.0\n *\n * This code is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License, version 3,\n * as published by the Free Software Foundation.\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License, version 3,\n * along with this program.  If not, see <http://www.gnu.org/licenses/>\n *\n */\n\nnamespace OCA\\DAV\\CardDAV;\n\nuse OCP\\ILogger;\nuse Sabre\\CardDAV\\Card;\nuse Sabre\\DAV\\Server;\nuse Sabre\\DAV\\ServerPlugin;\nuse Sabre\\HTTP\\RequestInterface;\nuse Sabre\\HTTP\\ResponseInterface;\nuse Sabre\\VObject\\Parameter;\nuse Sabre\\VObject\\Property\\Binary;\nuse Sabre\\VObject\\Reader;\n\nclass ImageExportPlugin extends ServerPlugin {\n\n\t/** @var Server */\n\tprotected $server;\n\t/** @var ILogger */\n\tprivate $logger;\n\n\tpublic function __construct(ILogger $logger) {\n\t\t$this->logger = $logger;\n\t}\n\n\t/**\n\t * Initializes the plugin and registers event handlers\n\t *\n\t * @param Server $server\n\t * @return void\n\t */\n\tfunction initialize(Server $server) {\n\n\t\t$this->server = $server;\n\t\t$this->server->on('method:GET', [$this, 'httpGet'], 90);\n\t}\n\n\t/**\n\t * Intercepts GET requests on addressbook urls ending with ?photo.\n\t *\n\t * @param RequestInterface $request\n\t * @param ResponseInterface $response\n\t * @return bool|void\n\t */\n\tfunction httpGet(RequestInterface $request, ResponseInterface $response) {\n\n\t\t$queryParams = $request->getQueryParameters();\n\t\t// TODO: in addition to photo we should also add logo some point in time\n\t\tif (!array_key_exists('photo', $queryParams)) {\n\t\t\treturn true;\n\t\t}\n\n\t\t$path = $request->getPath();\n\t\t$node = $this->server->tree->getNodeForPath($path);\n\n\t\tif (!($node instanceof Card)) {\n\t\t\treturn true;\n\t\t}\n\n\t\t$this->server->transactionType = 'carddav-image-export';\n\n\t\t// Checking ACL, if available.\n\t\tif ($aclPlugin = $this->server->getPlugin('acl')) {\n\t\t\t/** @var \\Sabre\\DAVACL\\Plugin $aclPlugin */\n\t\t\t$aclPlugin->checkPrivileges($path, '{DAV:}read');\n\t\t}\n\n\t\tif ($result = $this->getPhoto($node)) {\n\t\t\t$response->setHeader('Content-Type', $result['Content-Type']);\n\t\t\t$response->setHeader('Content-Disposition', 'attachment');\n\t\t\t$response->setStatus(200);\n\n\t\t\t$response->setBody($result['body']);\n\n\t\t\t// Returning false to break the event chain\n\t\t\treturn false;\n\t\t}\n\t\treturn true;\n\t}\n\n\tfunction getPhoto(Card $node) {\n\t\t// TODO: this is kind of expensive - load carddav data from database and parse it\n\t\t//       we might want to build up a cache one day\n\t\ttry {\n\t\t\t$vObject = $this->readCard($node->get());\n\t\t\tif (!$vObject->PHOTO) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t$photo = $vObject->PHOTO;\n\t\t\t$type = $this->getType($photo);\n\n\t\t\t$val = $photo->getValue();\n\t\t\tif ($photo->getValueType() === 'URI') {\n\t\t\t\t$parsed = \\Sabre\\URI\\parse($val);\n\t\t\t\t//only allow data://\n\t\t\t\tif ($parsed['scheme'] !== 'data') {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t\tif (substr_count($parsed['path'], ';') === 1) {\n\t\t\t\t\tlist($type,) = explode(';', $parsed['path']);\n\t\t\t\t}\n\t\t\t\t$val = file_get_contents($val);\n\t\t\t}\n\n\t\t\t$allowedContentTypes = [\n\t\t\t\t'image/png',\n\t\t\t\t'image/jpeg',\n\t\t\t\t'image/gif',\n\t\t\t];\n\n\t\t\tif(!in_array($type, $allowedContentTypes, true)) {\n\t\t\t\t$type = 'application/octet-stream';\n\t\t\t}\n\n\t\t\treturn [\n\t\t\t\t'Content-Type' => $type,\n\t\t\t\t'body' => $val\n\t\t\t];\n\t\t} catch(\\Exception $ex) {\n\t\t\t$this->logger->logException($ex);\n\t\t}\n\t\treturn false;\n\t}\n\n\tprivate function readCard($cardData) {\n\t\treturn Reader::read($cardData);\n\t}\n\n\t/**\n\t * @param Binary $photo\n\t * @return Parameter\n\t */\n\tprivate function getType($photo) {\n\t\t$params = $photo->parameters();\n\t\tif (isset($params['TYPE']) || isset($params['MEDIATYPE'])) {\n\t\t\t/** @var Parameter $typeParam */\n\t\t\t$typeParam = isset($params['TYPE']) ? $params['TYPE'] : $params['MEDIATYPE'];\n\t\t\t$type = $typeParam->getValue();\n\n\t\t\tif (strpos($type, 'image/') === 0) {\n\t\t\t\treturn $type;\n\t\t\t} else {\n\t\t\t\treturn 'image/' . strtolower($type);\n\t\t\t}\n\t\t}\n\t\treturn '';\n\t}\n}\n", "<?php\n/**\n * @copyright Copyright (c) 2016, ownCloud, Inc.\n *\n * @author Georg Ehrke <georg@owncloud.com>\n * @author Roeland Jago Douma <roeland@famdouma.nl>\n *\n * @license AGPL-3.0\n *\n * This code is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License, version 3,\n * as published by the Free Software Foundation.\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License, version 3,\n * along with this program.  If not, see <http://www.gnu.org/licenses/>\n *\n */\n\n\nnamespace OCA\\DAV\\Tests\\unit\\CardDAV;\n\n\nuse OCA\\DAV\\CardDAV\\ImageExportPlugin;\nuse OCP\\ILogger;\nuse Sabre\\CardDAV\\Card;\nuse Sabre\\DAV\\Server;\nuse Sabre\\DAV\\Tree;\nuse Sabre\\HTTP\\RequestInterface;\nuse Sabre\\HTTP\\ResponseInterface;\nuse Test\\TestCase;\n\nclass ImageExportPluginTest extends TestCase {\n\n\t/** @var ResponseInterface | \\PHPUnit_Framework_MockObject_MockObject */\n\tprivate $response;\n\t/** @var RequestInterface | \\PHPUnit_Framework_MockObject_MockObject */\n\tprivate $request;\n\t/** @var ImageExportPlugin | \\PHPUnit_Framework_MockObject_MockObject */\n\tprivate $plugin;\n\t/** @var Server */\n\tprivate $server;\n\t/** @var Tree | \\PHPUnit_Framework_MockObject_MockObject */\n\tprivate $tree;\n\t/** @var ILogger | \\PHPUnit_Framework_MockObject_MockObject */\n\tprivate $logger;\n\n\tfunction setUp() {\n\t\tparent::setUp();\n\n\t\t$this->request = $this->getMockBuilder('Sabre\\HTTP\\RequestInterface')->getMock();\n\t\t$this->response = $this->getMockBuilder('Sabre\\HTTP\\ResponseInterface')->getMock();\n\t\t$this->server = $this->getMockBuilder('Sabre\\DAV\\Server')->getMock();\n\t\t$this->tree = $this->getMockBuilder('Sabre\\DAV\\Tree')->disableOriginalConstructor()->getMock();\n\t\t$this->server->tree = $this->tree;\n\t\t$this->logger = $this->getMockBuilder('\\OCP\\ILogger')->getMock();\n\n\t\t$this->plugin = $this->getMockBuilder('OCA\\DAV\\CardDAV\\ImageExportPlugin')\n\t\t\t->setMethods(['getPhoto'])\n\t\t\t->setConstructorArgs([$this->logger])\n\t\t\t->getMock();\n\t\t$this->plugin->initialize($this->server);\n\t}\n\n\t/**\n\t * @dataProvider providesQueryParams\n\t * @param $param\n\t */\n\tpublic function testQueryParams($param) {\n\t\t$this->request->expects($this->once())->method('getQueryParameters')->willReturn($param);\n\t\t$result = $this->plugin->httpGet($this->request, $this->response);\n\t\t$this->assertTrue($result);\n\t}\n\n\tpublic function providesQueryParams() {\n\t\treturn [\n\t\t\t[[]],\n\t\t\t[['1']],\n\t\t\t[['foo' => 'bar']],\n\t\t];\n\t}\n\n\tpublic function testNotACard() {\n\t\t$this->request->expects($this->once())->method('getQueryParameters')->willReturn(['photo' => true]);\n\t\t$this->request->expects($this->once())->method('getPath')->willReturn('/files/welcome.txt');\n\t\t$this->tree->expects($this->once())->method('getNodeForPath')->with('/files/welcome.txt')->willReturn(null);\n\t\t$result = $this->plugin->httpGet($this->request, $this->response);\n\t\t$this->assertTrue($result);\n\t}\n\n\t/**\n\t * @dataProvider providesCardWithOrWithoutPhoto\n\t * @param bool $expected\n\t * @param array $getPhotoResult\n\t */\n\tpublic function testCardWithOrWithoutPhoto($expected, $getPhotoResult) {\n\t\t$this->request->expects($this->once())->method('getQueryParameters')->willReturn(['photo' => true]);\n\t\t$this->request->expects($this->once())->method('getPath')->willReturn('/files/welcome.txt');\n\n\t\t$card = $this->getMockBuilder('Sabre\\CardDAV\\Card')->disableOriginalConstructor()->getMock();\n\t\t$this->tree->expects($this->once())->method('getNodeForPath')->with('/files/welcome.txt')->willReturn($card);\n\n\t\t$this->plugin->expects($this->once())->method('getPhoto')->willReturn($getPhotoResult);\n\n\t\tif (!$expected) {\n\t\t\t$this->response\n\t\t\t\t->expects($this->at(0))\n\t\t\t\t->method('setHeader')\n\t\t\t\t->with('Content-Type', $getPhotoResult['Content-Type']);\n\t\t\t$this->response\n\t\t\t\t->expects($this->at(1))\n\t\t\t\t->method('setHeader')\n\t\t\t\t->with('Content-Disposition', 'attachment');\n\t\t\t$this->response\n\t\t\t\t->expects($this->once())\n\t\t\t\t->method('setStatus');\n\t\t\t$this->response\n\t\t\t\t->expects($this->once())\n\t\t\t\t->method('setBody');\n\t\t}\n\n\t\t$result = $this->plugin->httpGet($this->request, $this->response);\n\t\t$this->assertEquals($expected, $result);\n\t}\n\n\tpublic function providesCardWithOrWithoutPhoto() {\n\t\treturn [\n\t\t\t[true, null],\n\t\t\t[false, ['Content-Type' => 'image/jpeg', 'body' => '1234']],\n\t\t];\n\t}\n\n\t/**\n\t * @dataProvider providesPhotoData\n\t * @param $expected\n\t * @param $cardData\n\t */\n\tpublic function testGetPhoto($expected, $cardData) {\n\t\t/** @var Card | \\PHPUnit_Framework_MockObject_MockObject $card */\n\t\t$card = $this->getMockBuilder('Sabre\\CardDAV\\Card')->disableOriginalConstructor()->getMock();\n\t\t$card->expects($this->once())->method('get')->willReturn($cardData);\n\n\t\t$this->plugin = new ImageExportPlugin($this->logger);\n\t\t$this->plugin->initialize($this->server);\n\n\t\t$result = $this->plugin->getPhoto($card);\n\t\t$this->assertEquals($expected, $result);\n\t}\n\n\tpublic function providesPhotoData() {\n\t\treturn [\n\t\t\t'empty vcard' => [\n\t\t\t\tfalse,\n\t\t\t\t''\n\t\t\t],\n\t\t\t'vcard without PHOTO' => [\n\t\t\t\tfalse,\n\t\t\t\t\"BEGIN:VCARD\\r\\nVERSION:3.0\\r\\nPRODID:-//Sabre//Sabre VObject 3.5.0//EN\\r\\nUID:12345\\r\\nFN:12345\\r\\nN:12345;;;;\\r\\nEND:VCARD\\r\\n\"\n\t\t\t],\n\t\t\t'vcard 3 with PHOTO' => [\n\t\t\t\t[\n\t\t\t\t\t'Content-Type' => 'image/jpeg',\n\t\t\t\t\t'body' => '12345'\n\t\t\t\t],\n\t\t\t\t\"BEGIN:VCARD\\r\\nVERSION:3.0\\r\\nPRODID:-//Sabre//Sabre VObject 3.5.0//EN\\r\\nUID:12345\\r\\nFN:12345\\r\\nN:12345;;;;\\r\\nPHOTO;ENCODING=b;TYPE=JPEG:MTIzNDU=\\r\\nEND:VCARD\\r\\n\"\n\t\t\t],\n\t\t\t'vcard 3 with PHOTO URL' => [\n\t\t\t\tfalse,\n\t\t\t\t\"BEGIN:VCARD\\r\\nVERSION:3.0\\r\\nPRODID:-//Sabre//Sabre VObject 3.5.0//EN\\r\\nUID:12345\\r\\nFN:12345\\r\\nN:12345;;;;\\r\\nPHOTO;TYPE=JPEG;VALUE=URI:http://example.com/photo.jpg\\r\\nEND:VCARD\\r\\n\"\n\t\t\t],\n\t\t\t'vcard 4 with PHOTO' => [\n\t\t\t\t[\n\t\t\t\t\t'Content-Type' => 'image/jpeg',\n\t\t\t\t\t'body' => '12345'\n\t\t\t\t],\n\t\t\t\t\"BEGIN:VCARD\\r\\nVERSION:4.0\\r\\nPRODID:-//Sabre//Sabre VObject 3.5.0//EN\\r\\nUID:12345\\r\\nFN:12345\\r\\nN:12345;;;;\\r\\nPHOTO:data:image/jpeg;base64,MTIzNDU=\\r\\nEND:VCARD\\r\\n\"\n\t\t\t],\n\t\t\t'vcard 4 with PHOTO URL' => [\n\t\t\t\tfalse,\n\t\t\t\t\"BEGIN:VCARD\\r\\nVERSION:4.0\\r\\nPRODID:-//Sabre//Sabre VObject 3.5.0//EN\\r\\nUID:12345\\r\\nFN:12345\\r\\nN:12345;;;;\\r\\nPHOTO;MEDIATYPE=image/jpeg:http://example.org/photo.jpg\\r\\nEND:VCARD\\r\\n\"\n\t\t\t],\n\t\t\t'vcard 4 with PHOTO AND INVALID MIMEtYPE' => [\n\t\t\t\t[\n\t\t\t\t\t'Content-Type' => 'application/octet-stream',\n\t\t\t\t\t'body' => '12345'\n\t\t\t\t],\n\t\t\t\t\"BEGIN:VCARD\\r\\nVERSION:4.0\\r\\nPRODID:-//Sabre//Sabre VObject 3.5.0//EN\\r\\nUID:12345\\r\\nFN:12345\\r\\nN:12345;;;;\\r\\nPHOTO:data:image/svg;base64,MTIzNDU=\\r\\nEND:VCARD\\r\\n\"\n\t\t\t],\n\t\t];\n\t}\n}\n"], "filenames": ["apps/dav/lib/CardDAV/ImageExportPlugin.php", "apps/dav/tests/unit/CardDAV/ImageExportPluginTest.php"], "buggy_code_start_loc": [89, 110], "buggy_code_end_loc": [123, 151], "fixing_code_start_loc": [90, 110], "fixing_code_end_loc": [136, 193], "type": "CWE-79", "message": "Nextcloud Server before 10.0.1 & ownCloud Server before 9.0.6 and 9.1.2 suffer from Stored XSS in CardDAV image export. The CardDAV image export functionality as implemented in Nextcloud/ownCloud allows the download of images stored within a vCard. Due to not performing any kind of verification on the image content this is prone to a stored Cross-Site Scripting attack.", "other": {"cve": {"id": "CVE-2016-9465", "sourceIdentifier": "support@hackerone.com", "published": "2017-03-28T02:59:01.043", "lastModified": "2019-10-09T23:20:29.383", "vulnStatus": "Modified", "descriptions": [{"lang": "en", "value": "Nextcloud Server before 10.0.1 & ownCloud Server before 9.0.6 and 9.1.2 suffer from Stored XSS in CardDAV image export. The CardDAV image export functionality as implemented in Nextcloud/ownCloud allows the download of images stored within a vCard. Due to not performing any kind of verification on the image content this is prone to a stored Cross-Site Scripting attack."}, {"lang": "es", "value": "Nextcloud Server en versiones anteriores a 10.0.1 y ownCloud Server en versiones anteriores a 9.0.6 y 9.1.2 sufren de XSS almacenado en la exportaci\u00f3n de im\u00e1genes CardDAV. La funcionalidad de exportaci\u00f3n de im\u00e1genes CardDAV implementada en Nextcloud/ownCloud permite descargar im\u00e1genes almacenadas dentro de una vCard. Debido a que no realiza ning\u00fan tipo de verificaci\u00f3n en el contenido de la imagen, esto es propenso a un ataque de secuencias de comandos entre sitios."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 5.4, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.3, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:S/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "SINGLE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 3.5}, "baseSeverity": "LOW", "exploitabilityScore": 6.8, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}, {"source": "support@hackerone.com", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:nextcloud:nextcloud_server:*:*:*:*:*:*:*:*", "versionStartIncluding": "10.0.0", "versionEndExcluding": "10.0.1", "matchCriteriaId": "8288B81D-CA35-46EB-A7E7-B60B193E3F81"}, {"vulnerable": true, "criteria": "cpe:2.3:a:owncloud:owncloud:*:*:*:*:*:*:*:*", "versionStartIncluding": "9.0.0", "versionEndExcluding": "9.0.6", "matchCriteriaId": "CA8CCC5C-D019-4A80-BD8D-3914BFFC60C0"}, {"vulnerable": true, "criteria": "cpe:2.3:a:owncloud:owncloud:*:*:*:*:*:*:*:*", "versionStartIncluding": "9.1.0", "versionEndExcluding": "9.1.2", "matchCriteriaId": "8E9501A9-E507-4A81-954B-D6D3223EE2F8"}]}]}], "references": [{"url": "https://github.com/nextcloud/server/commit/68ab8325c799d20c1fb7e98d670785176590e7d0", "source": "support@hackerone.com", "tags": ["Issue Tracking", "Patch", "Third Party Advisory"]}, {"url": "https://github.com/owncloud/core/commit/6bf3be3877d9d9fda9c66926fe273fe79cbaf58e", "source": "support@hackerone.com", "tags": ["Issue Tracking", "Patch", "Third Party Advisory"]}, {"url": "https://github.com/owncloud/core/commit/b5a5be24c418033cb2ef965a4f3f06b7b4213845", "source": "support@hackerone.com", "tags": ["Issue Tracking", "Patch", "Third Party Advisory"]}, {"url": "https://hackerone.com/reports/163338", "source": "support@hackerone.com", "tags": ["Exploit", "Third Party Advisory"]}, {"url": "https://nextcloud.com/security/advisory/?id=nc-sa-2016-008", "source": "support@hackerone.com", "tags": ["Patch", "Vendor Advisory"]}, {"url": "https://owncloud.org/security/advisory/?id=oc-sa-2016-018", "source": "support@hackerone.com", "tags": ["Patch", "Vendor Advisory"]}]}, "github_commit_url": "https://github.com/nextcloud/server/commit/68ab8325c799d20c1fb7e98d670785176590e7d0"}}