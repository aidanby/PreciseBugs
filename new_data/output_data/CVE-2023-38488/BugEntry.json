{"buggy_code": ["<?php\n\nnamespace Kirby\\Data;\n\nuse Kirby\\Exception\\InvalidArgumentException;\nuse Kirby\\Toolkit\\A;\nuse Kirby\\Toolkit\\Str;\n\n/**\n * Kirby Txt Data Handler\n *\n * @package   Kirby Data\n * @author    Bastian Allgeier <bastian@getkirby.com>\n * @link      https://getkirby.com\n * @copyright Bastian Allgeier\n * @license   https://opensource.org/licenses/MIT\n */\nclass Txt extends Handler\n{\n\t/**\n\t * Converts an array to an encoded Kirby txt string\n\t */\n\tpublic static function encode($data): string\n\t{\n\t\t$result = [];\n\n\t\tforeach (A::wrap($data) as $key => $value) {\n\t\t\tif (empty($key) === true || $value === null) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t$key          = Str::ucfirst(Str::slug($key));\n\t\t\t$value        = static::encodeValue($value);\n\t\t\t$result[$key] = static::encodeResult($key, $value);\n\t\t}\n\n\t\treturn implode(\"\\n\\n----\\n\\n\", $result);\n\t}\n\n\t/**\n\t * Helper for converting the value\n\t */\n\tprotected static function encodeValue(array|string|float $value): string\n\t{\n\t\t// avoid problems with arrays\n\t\tif (is_array($value) === true) {\n\t\t\t$value = Data::encode($value, 'yaml');\n\t\t// avoid problems with localized floats\n\t\t} elseif (is_float($value) === true) {\n\t\t\t$value = Str::float($value);\n\t\t}\n\n\t\t// escape accidental dividers within a field\n\t\t$value = preg_replace('!(?<=\\n|^)----!', '\\\\----', $value);\n\n\t\treturn $value;\n\t}\n\n\t/**\n\t * Helper for converting the key and value to the result string\n\t */\n\tprotected static function encodeResult(string $key, string $value): string\n\t{\n\t\t$value = trim($value);\n\t\t$result = $key . ':';\n\n\t\t// multi-line content\n\t\tif (preg_match('!\\R!', $value) === 1) {\n\t\t\t$result .= \"\\n\\n\";\n\t\t} else {\n\t\t\t$result .= ' ';\n\t\t}\n\n\t\t$result .= $value;\n\n\t\treturn $result;\n\t}\n\n\t/**\n\t * Parses a Kirby txt string and returns a multi-dimensional array\n\t */\n\tpublic static function decode($string): array\n\t{\n\t\tif ($string === null || $string === '') {\n\t\t\treturn [];\n\t\t}\n\n\t\tif (is_array($string) === true) {\n\t\t\treturn $string;\n\t\t}\n\n\t\tif (is_string($string) === false) {\n\t\t\tthrow new InvalidArgumentException('Invalid TXT data; please pass a string');\n\t\t}\n\n\t\t// remove BOM\n\t\t$string = str_replace(\"\\xEF\\xBB\\xBF\", '', $string);\n\t\t// explode all fields by the line separator\n\t\t$fields = preg_split('!\\n----\\s*\\n*!', $string);\n\t\t// start the data array\n\t\t$data = [];\n\n\t\t// loop through all fields and add them to the content\n\t\tforeach ($fields as $field) {\n\t\t\tif ($pos = strpos($field, ':')) {\n\t\t\t\t$key = strtolower(trim(substr($field, 0, $pos)));\n\t\t\t\t$key = str_replace(['-', ' '], '_', $key);\n\n\t\t\t\t// Don't add fields with empty keys\n\t\t\t\tif (empty($key) === true) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\t$value = trim(substr($field, $pos + 1));\n\n\t\t\t\t// unescape escaped dividers within a field\n\t\t\t\t$data[$key] = preg_replace(\n\t\t\t\t\t'!(?<=\\n|^)\\\\\\\\----!',\n\t\t\t\t\t'----',\n\t\t\t\t\t$value\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\treturn $data;\n\t}\n}\n", "<?php\n\nnamespace Kirby\\Data;\n\nuse Kirby\\Exception\\InvalidArgumentException;\nuse PHPUnit\\Framework\\TestCase;\n\n/**\n * @coversDefaultClass \\Kirby\\Data\\Txt\n */\nclass TxtTest extends TestCase\n{\n\tpublic const FIXTURES = __DIR__ . '/fixtures';\n\n\t/**\n\t * @covers ::encode\n\t * @covers ::encodeValue\n\t * @covers ::encodeResult\n\t * @covers ::decode\n\t */\n\tpublic function testEncodeDecode()\n\t{\n\t\t$array = [\n\t\t\t'title' => 'Title',\n\t\t\t'text'  => 'Text'\n\t\t];\n\n\t\t$data = Txt::encode($array);\n\t\t$this->assertSame(\n\t\t\t\"Title: Title\\n\\n----\\n\\nText: Text\",\n\t\t\t$data\n\t\t);\n\n\t\t$result = Txt::decode($data);\n\t\t$this->assertSame($array, $result);\n\n\t\t$this->assertSame('', Txt::encode([]));\n\t\t$this->assertSame([], Txt::decode(''));\n\n\t\t$this->assertSame([], Txt::decode(null));\n\t\t$this->assertSame(['this is' => 'an array'], Txt::decode(['this is' => 'an array']));\n\t}\n\n\t/**\n\t * @covers ::encode\n\t * @covers ::encodeValue\n\t * @covers ::encodeResult\n\t * @covers ::decode\n\t */\n\tpublic function testEncodeDecodeMixedCase()\n\t{\n\t\t$array = [\n\t\t\t'title' => 'Title',\n\t\t\t'text'  => 'Text',\n\t\t\t'tItLe' => 'Another title',\n\t\t\t'TEXT'  => 'UPPERTEXT'\n\t\t];\n\n\t\t$data = Txt::encode($array);\n\t\t$this->assertSame(\n\t\t\t\"Title: Another title\\n\\n----\\n\\nText: UPPERTEXT\",\n\t\t\t$data\n\t\t);\n\n\t\t$result = Txt::decode($data);\n\t\t$this->assertSame([\n\t\t\t'title' => 'Another title',\n\t\t\t'text'  => 'UPPERTEXT'\n\t\t], $result);\n\t}\n\n\t/**\n\t * @covers ::encode\n\t * @covers ::encodeValue\n\t * @covers ::encodeResult\n\t */\n\tpublic function testEncodeMissingValues()\n\t{\n\t\t$array = [\n\t\t\t'title' => 'Title',\n\t\t\t'text'  => null,\n\t\t\t''      => 'text',\n\t\t\t'field' => 'content'\n\t\t];\n\n\t\t$data = Txt::encode($array);\n\t\t$this->assertSame(\n\t\t\t\"Title: Title\\n\\n----\\n\\nField: content\",\n\t\t\t$data\n\t\t);\n\t}\n\n\t/**\n\t * @covers ::encode\n\t * @covers ::encodeValue\n\t * @covers ::encodeResult\n\t */\n\tpublic function testEncodeMultiline()\n\t{\n\t\t$array = [\n\t\t\t'title' => 'Title',\n\t\t\t'text'  => \"Text\\nText\"\n\t\t];\n\n\t\t$data = Txt::encode($array);\n\t\t$this->assertSame(\n\t\t\t\"Title: Title\\n\\n----\\n\\nText:\\n\\nText\\nText\",\n\t\t\t$data\n\t\t);\n\t}\n\n\t/**\n\t * @covers ::encode\n\t * @covers ::encodeValue\n\t * @covers ::encodeResult\n\t */\n\tpublic function testEncodeDecodeDivider()\n\t{\n\t\t$array = [\n\t\t\t'title' => 'Title',\n\t\t\t'text'  => \"----\\n----\\nText\\n\\n----Field:\\nValue\\n----  \\n----\"\n\t\t];\n\n\t\t$data = Txt::encode($array);\n\t\t$this->assertSame(\n\t\t\t\"Title: Title\\n\\n----\\n\\nText:\\n\\n\\\\----\\n\\\\----\\n\" .\n\t\t\t\"Text\\n\\n\\\\----Field:\\nValue\\n\\\\----  \\n\\\\----\",\n\t\t\t$data\n\t\t);\n\n\t\t$this->assertSame($array, Txt::decode($data));\n\t}\n\n\t/**\n\t * @covers ::encode\n\t * @covers ::encodeValue\n\t * @covers ::encodeResult\n\t */\n\tpublic function testEncodeArray()\n\t{\n\t\t$array = [\n\t\t\t'title' => 'Title',\n\t\t\t'text'  => ['a', 'b', 'c'],\n\t\t\t'text2' => ['a']\n\t\t];\n\n\t\t$data = Txt::encode($array);\n\t\t$this->assertSame(file_get_contents(static::FIXTURES . '/test.txt'), $data);\n\t}\n\n\t/**\n\t * @covers ::encode\n\t * @covers ::encodeValue\n\t * @covers ::encodeResult\n\t */\n\tpublic function testEncodeFloat()\n\t{\n\t\t$data = Txt::encode([\n\t\t\t'number' => (float)3.2\n\t\t]);\n\n\t\t$this->assertSame('Number: 3.2', $data);\n\t}\n\n\t/**\n\t * @covers ::encode\n\t * @covers ::encodeValue\n\t * @covers ::encodeResult\n\t */\n\tpublic function testEncodeFloatWithLocaleSetting()\n\t{\n\t\t$currentLocale = setlocale(LC_ALL, 0);\n\t\tsetlocale(LC_ALL, 'de_DE');\n\n\t\t$data = Txt::encode([\n\t\t\t'number' => (float)3.2\n\t\t]);\n\n\t\t$this->assertSame('Number: 3.2', $data);\n\n\t\tsetlocale(LC_ALL, $currentLocale);\n\t}\n\n\t/**\n\t * @covers ::decode\n\t */\n\tpublic function testDecodeFile()\n\t{\n\t\t$array = [\n\t\t\t'title_with_spaces' => 'Title',\n\t\t\t'text_with_dashes'  => 'Text'\n\t\t];\n\n\t\t$data = Txt::decode(file_get_contents(static::FIXTURES . '/decode.txt'));\n\t\t$this->assertSame($array, $data);\n\t}\n\n\t/**\n\t * @covers ::decode\n\t */\n\tpublic function testDecodeInvalid1()\n\t{\n\t\t// pass invalid object\n\t\t$this->expectException(InvalidArgumentException::class);\n\t\t$this->expectExceptionMessage('Invalid TXT data; please pass a string');\n\t\tTxt::decode(new \\stdClass());\n\t}\n\n\t/**\n\t * @covers ::decode\n\t */\n\tpublic function testDecodeInvalid2()\n\t{\n\t\t// pass invalid int\n\t\t$this->expectException(InvalidArgumentException::class);\n\t\t$this->expectExceptionMessage('Invalid TXT data; please pass a string');\n\t\tTxt::decode(1);\n\t}\n}\n"], "fixing_code": ["<?php\n\nnamespace Kirby\\Data;\n\nuse Kirby\\Exception\\InvalidArgumentException;\nuse Kirby\\Toolkit\\A;\nuse Kirby\\Toolkit\\Str;\n\n/**\n * Kirby Txt Data Handler\n *\n * @package   Kirby Data\n * @author    Bastian Allgeier <bastian@getkirby.com>\n * @link      https://getkirby.com\n * @copyright Bastian Allgeier\n * @license   https://opensource.org/licenses/MIT\n */\nclass Txt extends Handler\n{\n\t/**\n\t * Converts an array to an encoded Kirby txt string\n\t */\n\tpublic static function encode($data): string\n\t{\n\t\t$result = [];\n\n\t\tforeach (A::wrap($data) as $key => $value) {\n\t\t\tif (empty($key) === true || $value === null) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t$key          = Str::ucfirst(Str::slug($key));\n\t\t\t$value        = static::encodeValue($value);\n\t\t\t$result[$key] = static::encodeResult($key, $value);\n\t\t}\n\n\t\treturn implode(\"\\n\\n----\\n\\n\", $result);\n\t}\n\n\t/**\n\t * Helper for converting the value\n\t */\n\tprotected static function encodeValue(array|string|float $value): string\n\t{\n\t\t// avoid problems with arrays\n\t\tif (is_array($value) === true) {\n\t\t\t$value = Data::encode($value, 'yaml');\n\t\t// avoid problems with localized floats\n\t\t} elseif (is_float($value) === true) {\n\t\t\t$value = Str::float($value);\n\t\t}\n\n\t\t// escape accidental dividers within a field\n\t\t$value = preg_replace('!(?<=\\n|^)----!', '\\\\----', $value);\n\n\t\treturn $value;\n\t}\n\n\t/**\n\t * Helper for converting the key and value to the result string\n\t */\n\tprotected static function encodeResult(string $key, string $value): string\n\t{\n\t\t$value = trim($value);\n\t\t$result = $key . ':';\n\n\t\t// multi-line content\n\t\tif (preg_match('!\\R!', $value) === 1) {\n\t\t\t$result .= \"\\n\\n\";\n\t\t} else {\n\t\t\t$result .= ' ';\n\t\t}\n\n\t\t$result .= $value;\n\n\t\treturn $result;\n\t}\n\n\t/**\n\t * Parses a Kirby txt string and returns a multi-dimensional array\n\t */\n\tpublic static function decode($string): array\n\t{\n\t\tif ($string === null || $string === '') {\n\t\t\treturn [];\n\t\t}\n\n\t\tif (is_array($string) === true) {\n\t\t\treturn $string;\n\t\t}\n\n\t\tif (is_string($string) === false) {\n\t\t\tthrow new InvalidArgumentException('Invalid TXT data; please pass a string');\n\t\t}\n\n\t\t// remove Unicode BOM at the beginning of the file\n\t\tif (Str::startsWith($string, \"\\xEF\\xBB\\xBF\") === true) {\n\t\t\t$string = substr($string, 3);\n\t\t}\n\n\t\t// explode all fields by the line separator\n\t\t$fields = preg_split('!\\n----\\s*\\n*!', $string);\n\n\t\t// start the data array\n\t\t$data = [];\n\n\t\t// loop through all fields and add them to the content\n\t\tforeach ($fields as $field) {\n\t\t\tif ($pos = strpos($field, ':')) {\n\t\t\t\t$key = strtolower(trim(substr($field, 0, $pos)));\n\t\t\t\t$key = str_replace(['-', ' '], '_', $key);\n\n\t\t\t\t// Don't add fields with empty keys\n\t\t\t\tif (empty($key) === true) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\t$value = trim(substr($field, $pos + 1));\n\n\t\t\t\t// unescape escaped dividers within a field\n\t\t\t\t$data[$key] = preg_replace(\n\t\t\t\t\t'!(?<=\\n|^)\\\\\\\\----!',\n\t\t\t\t\t'----',\n\t\t\t\t\t$value\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\treturn $data;\n\t}\n}\n", "<?php\n\nnamespace Kirby\\Data;\n\nuse Kirby\\Exception\\InvalidArgumentException;\nuse PHPUnit\\Framework\\TestCase;\n\n/**\n * @coversDefaultClass \\Kirby\\Data\\Txt\n */\nclass TxtTest extends TestCase\n{\n\tpublic const FIXTURES = __DIR__ . '/fixtures';\n\n\t/**\n\t * @covers ::encode\n\t * @covers ::encodeValue\n\t * @covers ::encodeResult\n\t * @covers ::decode\n\t */\n\tpublic function testEncodeDecode()\n\t{\n\t\t$array = [\n\t\t\t'title' => 'Title',\n\t\t\t'text'  => 'Text'\n\t\t];\n\n\t\t$data = Txt::encode($array);\n\t\t$this->assertSame(\n\t\t\t\"Title: Title\\n\\n----\\n\\nText: Text\",\n\t\t\t$data\n\t\t);\n\n\t\t$result = Txt::decode($data);\n\t\t$this->assertSame($array, $result);\n\n\t\t$this->assertSame('', Txt::encode([]));\n\t\t$this->assertSame([], Txt::decode(''));\n\n\t\t$this->assertSame([], Txt::decode(null));\n\t\t$this->assertSame(['this is' => 'an array'], Txt::decode(['this is' => 'an array']));\n\t}\n\n\t/**\n\t * @covers ::encode\n\t * @covers ::encodeValue\n\t * @covers ::encodeResult\n\t * @covers ::decode\n\t */\n\tpublic function testEncodeDecodeMixedCase()\n\t{\n\t\t$array = [\n\t\t\t'title' => 'Title',\n\t\t\t'text'  => 'Text',\n\t\t\t'tItLe' => 'Another title',\n\t\t\t'TEXT'  => 'UPPERTEXT'\n\t\t];\n\n\t\t$data = Txt::encode($array);\n\t\t$this->assertSame(\n\t\t\t\"Title: Another title\\n\\n----\\n\\nText: UPPERTEXT\",\n\t\t\t$data\n\t\t);\n\n\t\t$result = Txt::decode($data);\n\t\t$this->assertSame([\n\t\t\t'title' => 'Another title',\n\t\t\t'text'  => 'UPPERTEXT'\n\t\t], $result);\n\t}\n\n\t/**\n\t * @covers ::encode\n\t * @covers ::encodeValue\n\t * @covers ::encodeResult\n\t */\n\tpublic function testEncodeMissingValues()\n\t{\n\t\t$array = [\n\t\t\t'title' => 'Title',\n\t\t\t'text'  => null,\n\t\t\t''      => 'text',\n\t\t\t'field' => 'content'\n\t\t];\n\n\t\t$data = Txt::encode($array);\n\t\t$this->assertSame(\n\t\t\t\"Title: Title\\n\\n----\\n\\nField: content\",\n\t\t\t$data\n\t\t);\n\t}\n\n\t/**\n\t * @covers ::encode\n\t * @covers ::encodeValue\n\t * @covers ::encodeResult\n\t */\n\tpublic function testEncodeMultiline()\n\t{\n\t\t$array = [\n\t\t\t'title' => 'Title',\n\t\t\t'text'  => \"Text\\nText\"\n\t\t];\n\n\t\t$data = Txt::encode($array);\n\t\t$this->assertSame(\n\t\t\t\"Title: Title\\n\\n----\\n\\nText:\\n\\nText\\nText\",\n\t\t\t$data\n\t\t);\n\t}\n\n\t/**\n\t * @covers ::encode\n\t * @covers ::encodeValue\n\t * @covers ::encodeResult\n\t */\n\tpublic function testEncodeDecodeDivider()\n\t{\n\t\t$array = [\n\t\t\t'title' => 'Title',\n\t\t\t'text'  => \"----\\n----\\nText\\n\\n----Field:\\nValue\\n----  \\n----\"\n\t\t];\n\n\t\t$data = Txt::encode($array);\n\t\t$this->assertSame(\n\t\t\t\"Title: Title\\n\\n----\\n\\nText:\\n\\n\\\\----\\n\\\\----\\n\" .\n\t\t\t\"Text\\n\\n\\\\----Field:\\nValue\\n\\\\----  \\n\\\\----\",\n\t\t\t$data\n\t\t);\n\n\t\t$this->assertSame($array, Txt::decode($data));\n\t}\n\n\t/**\n\t * @covers ::encode\n\t * @covers ::encodeValue\n\t * @covers ::encodeResult\n\t */\n\tpublic function testEncodeArray()\n\t{\n\t\t$array = [\n\t\t\t'title' => 'Title',\n\t\t\t'text'  => ['a', 'b', 'c'],\n\t\t\t'text2' => ['a']\n\t\t];\n\n\t\t$data = Txt::encode($array);\n\t\t$this->assertSame(file_get_contents(static::FIXTURES . '/test.txt'), $data);\n\t}\n\n\t/**\n\t * @covers ::encode\n\t * @covers ::encodeValue\n\t * @covers ::encodeResult\n\t */\n\tpublic function testEncodeFloat()\n\t{\n\t\t$data = Txt::encode([\n\t\t\t'number' => (float)3.2\n\t\t]);\n\n\t\t$this->assertSame('Number: 3.2', $data);\n\t}\n\n\t/**\n\t * @covers ::encode\n\t * @covers ::encodeValue\n\t * @covers ::encodeResult\n\t */\n\tpublic function testEncodeFloatWithLocaleSetting()\n\t{\n\t\t$currentLocale = setlocale(LC_ALL, 0);\n\t\tsetlocale(LC_ALL, 'de_DE');\n\n\t\t$data = Txt::encode([\n\t\t\t'number' => (float)3.2\n\t\t]);\n\n\t\t$this->assertSame('Number: 3.2', $data);\n\n\t\tsetlocale(LC_ALL, $currentLocale);\n\t}\n\n\t/**\n\t * @covers ::decode\n\t */\n\tpublic function testDecodeFile()\n\t{\n\t\t$array = [\n\t\t\t'title_with_spaces' => 'Title',\n\t\t\t'text_with_dashes'  => 'Text'\n\t\t];\n\n\t\t$data = Txt::decode(file_get_contents(static::FIXTURES . '/decode.txt'));\n\t\t$this->assertSame($array, $data);\n\t}\n\n\t/**\n\t * @covers ::decode\n\t */\n\tpublic function testDecodeBom1()\n\t{\n\t\t$string = \"\\xEF\\xBB\\xBFTitle: title field with BOM \\xEF\\xBB\\xBF\\n----\\nText: text field\";\n\t\t$array  = [\n\t\t\t'title' => \"title field with BOM \\xEF\\xBB\\xBF\",\n\t\t\t'text'  => 'text field'\n\t\t];\n\n\t\t$this->assertSame($array, Txt::decode($string));\n\t}\n\n\t/**\n\t * @covers ::decode\n\t */\n\tpublic function testDecodeBom2()\n\t{\n\t\t$string = \"\\xEF\\xBB\\xBFTitle: title field with BOM\\n--\\xEF\\xBB\\xBF--\\nand more text\\n----\\nText: text field\";\n\t\t$array  = [\n\t\t\t'title' => \"title field with BOM\\n--\\xEF\\xBB\\xBF--\\nand more text\",\n\t\t\t'text'  => 'text field'\n\t\t];\n\n\t\t$this->assertSame($array, Txt::decode($string));\n\t}\n\n\t/**\n\t * @covers ::decode\n\t */\n\tpublic function testDecodeInvalid1()\n\t{\n\t\t// pass invalid object\n\t\t$this->expectException(InvalidArgumentException::class);\n\t\t$this->expectExceptionMessage('Invalid TXT data; please pass a string');\n\t\tTxt::decode(new \\stdClass());\n\t}\n\n\t/**\n\t * @covers ::decode\n\t */\n\tpublic function testDecodeInvalid2()\n\t{\n\t\t// pass invalid int\n\t\t$this->expectException(InvalidArgumentException::class);\n\t\t$this->expectExceptionMessage('Invalid TXT data; please pass a string');\n\t\tTxt::decode(1);\n\t}\n}\n"], "filenames": ["src/Data/Txt.php", "tests/Data/TxtTest.php"], "buggy_code_start_loc": [96, 200], "buggy_code_end_loc": [99, 200], "fixing_code_start_loc": [96, 201], "fixing_code_end_loc": [104, 229], "type": "CWE-863", "message": "Kirby is a content management system. A vulnerability in versions prior to 3.5.8.3, 3.6.6.3, 3.7.5.2, 3.8.4.1, and 3.9.6 affects all Kirby sites that might have potential attackers in the group of authenticated Panel users or that allow external visitors to update a Kirby content file (e.g. via a contact or comment form). Kirby sites are *not* affected if they don't allow write access for untrusted users or visitors.\n\nA field injection in a content storage implementation is a type of vulnerability that allows attackers with content write access to overwrite content fields that the site developer didn't intend to be modified. In a Kirby site this can be used to alter site content, break site behavior or inject malicious data or code. The exact security risk depends on the field type and usage.\n\nKirby stores content of the site, of pages, files and users in text files by default. The text files use Kirby's KirbyData format where each field is separated by newlines and a line with four dashes (`----`). When reading a KirbyData file, the affected code first removed the Unicode BOM sequence from the file contents and afterwards split the content into fields by the field separator.\n\nWhen writing to a KirbyData file, field separators in field data are escaped to prevent user input from interfering with the field structure. However this escaping could be tricked by including a Unicode BOM sequence in a field separator (e.g. `--\\xEF\\xBB\\xBF--`). When writing, this was not detected as a separator, but because the BOM was removed during reading, it could be abused by attackers to inject other field data into content files.\n\nBecause each field can only be defined once per content file, this vulnerability only affects fields in the content file that were defined above the vulnerable user-writable field or not at all. Fields that are defined below the vulnerable field override the injected field content and were therefore already protected.\n\nThe problem has been patched in Kirby 3.5.8.3, 3.6.6.3, 3.7.5.2, 3.8.4.1, and 3.9.6. In all of the mentioned releases, the maintainers have fixed the affected code to only remove the Unicode BOM sequence at the beginning of the file. This fixes this vulnerability both for newly written as well as for existing content files.", "other": {"cve": {"id": "CVE-2023-38488", "sourceIdentifier": "security-advisories@github.com", "published": "2023-07-27T15:15:11.840", "lastModified": "2023-08-03T13:27:45.163", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Kirby is a content management system. A vulnerability in versions prior to 3.5.8.3, 3.6.6.3, 3.7.5.2, 3.8.4.1, and 3.9.6 affects all Kirby sites that might have potential attackers in the group of authenticated Panel users or that allow external visitors to update a Kirby content file (e.g. via a contact or comment form). Kirby sites are *not* affected if they don't allow write access for untrusted users or visitors.\n\nA field injection in a content storage implementation is a type of vulnerability that allows attackers with content write access to overwrite content fields that the site developer didn't intend to be modified. In a Kirby site this can be used to alter site content, break site behavior or inject malicious data or code. The exact security risk depends on the field type and usage.\n\nKirby stores content of the site, of pages, files and users in text files by default. The text files use Kirby's KirbyData format where each field is separated by newlines and a line with four dashes (`----`). When reading a KirbyData file, the affected code first removed the Unicode BOM sequence from the file contents and afterwards split the content into fields by the field separator.\n\nWhen writing to a KirbyData file, field separators in field data are escaped to prevent user input from interfering with the field structure. However this escaping could be tricked by including a Unicode BOM sequence in a field separator (e.g. `--\\xEF\\xBB\\xBF--`). When writing, this was not detected as a separator, but because the BOM was removed during reading, it could be abused by attackers to inject other field data into content files.\n\nBecause each field can only be defined once per content file, this vulnerability only affects fields in the content file that were defined above the vulnerable user-writable field or not at all. Fields that are defined below the vulnerable field override the injected field content and were therefore already protected.\n\nThe problem has been patched in Kirby 3.5.8.3, 3.6.6.3, 3.7.5.2, 3.8.4.1, and 3.9.6. In all of the mentioned releases, the maintainers have fixed the affected code to only remove the Unicode BOM sequence at the beginning of the file. This fixes this vulnerability both for newly written as well as for existing content files."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 8.8, "baseSeverity": "HIGH"}, "exploitabilityScore": 2.8, "impactScore": 5.9}, {"source": "security-advisories@github.com", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:H/A:L", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "NONE", "integrityImpact": "HIGH", "availabilityImpact": "LOW", "baseScore": 7.1, "baseSeverity": "HIGH"}, "exploitabilityScore": 2.8, "impactScore": 4.2}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-863"}]}, {"source": "security-advisories@github.com", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-140"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:getkirby:kirby:*:*:*:*:*:*:*:*", "versionStartIncluding": "3.5.0", "versionEndExcluding": "3.5.8.3", "matchCriteriaId": "E4FCE332-95EB-4BAC-B5CF-D7D24DA38476"}, {"vulnerable": true, "criteria": "cpe:2.3:a:getkirby:kirby:*:*:*:*:*:*:*:*", "versionStartIncluding": "3.6.0", "versionEndExcluding": "3.6.6.3", "matchCriteriaId": "7AE383B6-2730-4760-B58C-F08D60C4C91B"}, {"vulnerable": true, "criteria": "cpe:2.3:a:getkirby:kirby:*:*:*:*:*:*:*:*", "versionStartIncluding": "3.7.0", "versionEndExcluding": "3.7.5.2", "matchCriteriaId": "CF9A36C4-9169-48F3-B43A-F7CB3825A020"}, {"vulnerable": true, "criteria": "cpe:2.3:a:getkirby:kirby:*:*:*:*:*:*:*:*", "versionStartIncluding": "3.8.0", "versionEndExcluding": "3.8.4.1", "matchCriteriaId": "C33BAD98-F500-4CE4-80A0-745A13DE9785"}, {"vulnerable": true, "criteria": "cpe:2.3:a:getkirby:kirby:*:*:*:*:*:*:*:*", "versionStartIncluding": "3.9.0", "versionEndExcluding": "3.9.6", "matchCriteriaId": "AC260646-C9E1-40A0-BB77-36A3E05FC76F"}]}]}], "references": [{"url": "https://github.com/getkirby/kirby/commit/a1e0f81c799ddae1af91cf37216f8ded9cb93540", "source": "security-advisories@github.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/getkirby/kirby/releases/tag/3.5.8.3", "source": "security-advisories@github.com", "tags": ["Third Party Advisory"]}, {"url": "https://github.com/getkirby/kirby/releases/tag/3.6.6.3", "source": "security-advisories@github.com", "tags": ["Third Party Advisory"]}, {"url": "https://github.com/getkirby/kirby/releases/tag/3.7.5.2", "source": "security-advisories@github.com", "tags": ["Third Party Advisory"]}, {"url": "https://github.com/getkirby/kirby/releases/tag/3.8.4.1", "source": "security-advisories@github.com", "tags": ["Third Party Advisory"]}, {"url": "https://github.com/getkirby/kirby/releases/tag/3.9.6", "source": "security-advisories@github.com", "tags": ["Third Party Advisory"]}, {"url": "https://github.com/getkirby/kirby/security/advisories/GHSA-x5mr-p6v4-wp93", "source": "security-advisories@github.com", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/getkirby/kirby/commit/a1e0f81c799ddae1af91cf37216f8ded9cb93540"}}