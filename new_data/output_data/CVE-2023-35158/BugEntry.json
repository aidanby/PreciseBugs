{"buggy_code": ["## ---------------------------------------------------------------------------\n## See the NOTICE file distributed with this work for additional\n## information regarding copyright ownership.\n##\n## This is free software; you can redistribute it and/or modify it\n## under the terms of the GNU Lesser General Public License as\n## published by the Free Software Foundation; either version 2.1 of\n## the License, or (at your option) any later version.\n##\n## This software is distributed in the hope that it will be useful,\n## but WITHOUT ANY WARRANTY; without even the implied warranty of\n## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n## Lesser General Public License for more details.\n##\n## You should have received a copy of the GNU Lesser General Public\n## License along with this software; if not, write to the Free\n## Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n## 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n## ---------------------------------------------------------------------------\n#######################################################\n###              RESTORE (UNDELETE) PAGE ACTION\n###              ------------------\n###\n#######################################################\n##\n#######################################################\n##                     GLOBALS\n#######################################################\n#set($fullmsg = '')\n#set($quote = '\"')\n#set($hasInlinks = false)\n#######################################################\n##                     DISPLAY\n#######################################################\n#if ($xcontext.action == 'get' && \"$!request.jobId\" != '')\n  #handleStatusRequest()\n#else\n  #template(\"startpage.vm\")\n  <div class=\"main\">\n    <div id=\"mainContentArea\">\n      #define($title)<a href=\"$doc.getURL('view')\">$!escapetool.xml($doc.plainTitle)</a>#end\n      #set($titleToDisplay = $services.localization.render('core.restore.title', [$title]))\n      <div class=\"xcontent\">\n        #template('contentheader.vm')\n        #controller()\n        <div class=\"clearfloats\"></div>\n      </div> ## xcontent\n    </div>## mainContentArea\n  </div>## main\n  #template(\"endpage.vm\")\n#end\n#######################################################\n##                    CONTROLLER\n#######################################################\n#macro(controller)\n  #if(\"$!{request.jobId}\" != '')\n    ## A restore job is running\n    #displayProgressBar()\n  #elseif(\"$!{request.showBatch}\" == 'true')\n    ## showBatch=true means that we are displaying the other documents that were deleted in the same batch as the\n    ## current one, which we might want to restore as well.\n    #displayConfirmationPage()\n  #end\n#end\n#######################################################\n##            DISPLAY CONFIRMATION PAGE\n#######################################################\n#macro(displayConfirmationPage)\n  <form action=\"$xwiki.relativeRequestURL\" method=\"post\">\n    #getBatch()\n    #displayConfirmMessage()\n  </form>\n#end\n#######################################################\n##              DISPLAY PROGRESS BAR\n#######################################################\n#macro(displayProgressBar)\n  #handleStatusRequest()\n#end\n#macro (handleStatusRequest)\n  #template('job_macros.vm')\n  #set ($jobStatus = $services.job.getJobStatus($stringtool.split($request.jobId, '/')))\n  #if ($jobStatus)\n    #if ($xcontext.action == 'get')\n      #outputJobStatusJSON($jobStatus)\n    #else\n      #displayJobStatus($jobStatus)\n    #end\n  #else\n    $response.setStatus(404)\n    <div class=\"box errormessage\">\n      $services.localization.render('core.restore.status.notFound')\n    </div>\n  #end\n#end\n#macro (outputJobStatusJSON $jobStatus)\n  #getJobStatusJSON($jobStatus $json)\n  #set ($json.message = \"#displayJobFinishedMessage($jobStatus)\")\n  $response.setContentType('application/json')\n  $jsontool.serialize($json)\n#end\n#macro (displayJobFinishedMessage $jobStatus)\n  #template('refactoringStatus_macros.vm')\n  #displayRefactoringJobFinishedMessage($jobStatus 'core.restore.status.success' 'core.restore.status.failure')\n#end\n#######################################################\n##                  DISPLAY PANEL\n#######################################################\n#macro(displayPanel $panelId $panelClass $heading $body)\n  <div class=\"panel $!panelClass\">\n    <div class=\"panel-heading\">\n      $heading\n      <div class=\"pull-right\"><a class=\"panel-collapse-carret\" role=\"button\" data-toggle=\"collapse\" href=\"#$panelId\" aria-expanded=\"false\" aria-controls=\"$panelId\"><span class=\"caret\"></span></a></div>\n    </div>\n    <div class=\"panel-body collapse\" id=\"$panelId\">\n      $body\n    </div>\n  </div>\n#end\n#######################################################\n##                    BATCH\n#######################################################\n#macro(getBatch)\n  #set ($deletedDocument = $xwiki.getDeletedDocument($request.get('id')))\n  #set ($batchDeletedDocuments = $xwiki.getDeletedDocuments($deletedDocument.batchId))\n  ## Only propose to restore the batch if it also contains other documents than the current one.\n  #if ($batchDeletedDocuments.size() > 1)\n    #define($heading)\n      <input name=\"includeBatch\" id=\"includeBatch\" type=\"checkbox\" value=\"true\"/><label for=\"includeBatch\">$services.localization.render('core.restore.includeBatch')</label> ($batchDeletedDocuments.size())\n    #end\n    #define($body)\n      ##\n      ## Batch details.\n      ##\n      <div class=\"row\">\n        <div class=\"col-xs-12 col-lg-4\">\n          <div><b>$services.localization.render('core.restore.deleter')</b></div> $xwiki.getUserName($deletedDocument.deleter)\n        </div>\n        <div class=\"col-xs-12 col-lg-4\">\n          <div><b>$services.localization.render('core.restore.deleteDate')</b></div> $xwiki.formatDate($deletedDocument.date)\n        </div>\n        <div class=\"col-xs-12 col-lg-4\">\n          <div><b>$services.localization.render('core.restore.batchId')</b></div> $deletedDocument.batchId\n        </div>\n      </div>\n      ##\n      ## List the deleted documents in the batch using a livetable.\n      ##\n      #set ($collist = ['doc.name', 'doc.location', '_actions'])\n      #set ($colprops = {\n        'doc.name'     : { 'link' : 'view', 'filterable': false, 'sortable' : 'false' },\n        'doc.location' : { 'type' : 'text', 'link' : false, 'filterable': true, 'html': true},\n        '_actions'     : { 'actions' : ['restore', 'delete'] }\n      })\n      #set ($urlParameters = \"xpage=getdeleteddocuments&doc.batchId=$!{escapetool.url($deletedDocument.batchId)}\")\n      #set ($options = { \n        'url' : \"$doc.getURL('get', $urlParameters)\",\n        'translationPrefix' : 'core.restore.batch.',\n        'outputOnlyHtml' : true,\n        'selectedColumn' : 'doc.location'\n      })\n      #livetable('deletedBatch' $collist $colprops $options)\n    #end\n    #displayPanel('panel-batch', 'panel-default', $heading, $body)\n  #end\n#end\n#######################################################\n##              DISPLAY CONFIRM MESSAGE\n#######################################################\n#macro(displayConfirmMessage)\n  <div class=\"hidden\">\n    <input type=\"hidden\" name=\"form_token\" value=\"$!{services.csrf.getToken()}\" />\n    <input type=\"hidden\" name=\"confirm\" value=\"true\"/>\n    <input type=\"hidden\" name=\"async\" value=\"true\"/>\n    #if(\"$!{request.xredirect}\" != '')\n      <input type=\"hidden\" name=\"xredirect\" value=\"$!{escapetool.xml($request.xredirect)}\"/>\n    #end\n  </div>\n  <button class=\"btn btn-primary\">$services.localization.render('core.restore.confirm.yes')</button>\n  #if(\"$!{request.xredirect}\" != '')\n    #set($cancelUrl = \"$request.xredirect\")\n  #else\n    #set($cancelUrl = $doc.getURL())\n  #end\n  <a class=\"btn btn-default\" href=\"$!{escapetool.xml(${cancelUrl})}\">$services.localization.render('core.restore.confirm.no')</a>\n#end\n"], "fixing_code": ["## ---------------------------------------------------------------------------\n## See the NOTICE file distributed with this work for additional\n## information regarding copyright ownership.\n##\n## This is free software; you can redistribute it and/or modify it\n## under the terms of the GNU Lesser General Public License as\n## published by the Free Software Foundation; either version 2.1 of\n## the License, or (at your option) any later version.\n##\n## This software is distributed in the hope that it will be useful,\n## but WITHOUT ANY WARRANTY; without even the implied warranty of\n## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n## Lesser General Public License for more details.\n##\n## You should have received a copy of the GNU Lesser General Public\n## License along with this software; if not, write to the Free\n## Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n## 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n## ---------------------------------------------------------------------------\n#######################################################\n###              RESTORE (UNDELETE) PAGE ACTION\n###              ------------------\n###\n#######################################################\n##\n#######################################################\n##                     GLOBALS\n#######################################################\n#set($fullmsg = '')\n#set($quote = '\"')\n#set($hasInlinks = false)\n#######################################################\n##                     DISPLAY\n#######################################################\n#if ($xcontext.action == 'get' && \"$!request.jobId\" != '')\n  #handleStatusRequest()\n#else\n  #template(\"startpage.vm\")\n  <div class=\"main\">\n    <div id=\"mainContentArea\">\n      #define($title)<a href=\"$doc.getURL('view')\">$!escapetool.xml($doc.plainTitle)</a>#end\n      #set($titleToDisplay = $services.localization.render('core.restore.title', [$title]))\n      <div class=\"xcontent\">\n        #template('contentheader.vm')\n        #controller()\n        <div class=\"clearfloats\"></div>\n      </div> ## xcontent\n    </div>## mainContentArea\n  </div>## main\n  #template(\"endpage.vm\")\n#end\n#######################################################\n##                    CONTROLLER\n#######################################################\n#macro(controller)\n  #if(\"$!{request.jobId}\" != '')\n    ## A restore job is running\n    #displayProgressBar()\n  #elseif(\"$!{request.showBatch}\" == 'true')\n    ## showBatch=true means that we are displaying the other documents that were deleted in the same batch as the\n    ## current one, which we might want to restore as well.\n    #displayConfirmationPage()\n  #end\n#end\n#######################################################\n##            DISPLAY CONFIRMATION PAGE\n#######################################################\n#macro(displayConfirmationPage)\n  <form action=\"$xwiki.relativeRequestURL\" method=\"post\">\n    #getBatch()\n    #displayConfirmMessage()\n  </form>\n#end\n#######################################################\n##              DISPLAY PROGRESS BAR\n#######################################################\n#macro(displayProgressBar)\n  #handleStatusRequest()\n#end\n#macro (handleStatusRequest)\n  #template('job_macros.vm')\n  #set ($jobStatus = $services.job.getJobStatus($stringtool.split($request.jobId, '/')))\n  #if ($jobStatus)\n    #if ($xcontext.action == 'get')\n      #outputJobStatusJSON($jobStatus)\n    #else\n      #displayJobStatus($jobStatus)\n    #end\n  #else\n    $response.setStatus(404)\n    <div class=\"box errormessage\">\n      $services.localization.render('core.restore.status.notFound')\n    </div>\n  #end\n#end\n#macro (outputJobStatusJSON $jobStatus)\n  #getJobStatusJSON($jobStatus $json)\n  #set ($json.message = \"#displayJobFinishedMessage($jobStatus)\")\n  $response.setContentType('application/json')\n  $jsontool.serialize($json)\n#end\n#macro (displayJobFinishedMessage $jobStatus)\n  #template('refactoringStatus_macros.vm')\n  #displayRefactoringJobFinishedMessage($jobStatus 'core.restore.status.success' 'core.restore.status.failure')\n#end\n#######################################################\n##                  DISPLAY PANEL\n#######################################################\n#macro(displayPanel $panelId $panelClass $heading $body)\n  <div class=\"panel $!panelClass\">\n    <div class=\"panel-heading\">\n      $heading\n      <div class=\"pull-right\"><a class=\"panel-collapse-carret\" role=\"button\" data-toggle=\"collapse\" href=\"#$panelId\" aria-expanded=\"false\" aria-controls=\"$panelId\"><span class=\"caret\"></span></a></div>\n    </div>\n    <div class=\"panel-body collapse\" id=\"$panelId\">\n      $body\n    </div>\n  </div>\n#end\n#######################################################\n##                    BATCH\n#######################################################\n#macro(getBatch)\n  #set ($deletedDocument = $xwiki.getDeletedDocument($request.get('id')))\n  #set ($batchDeletedDocuments = $xwiki.getDeletedDocuments($deletedDocument.batchId))\n  ## Only propose to restore the batch if it also contains other documents than the current one.\n  #if ($batchDeletedDocuments.size() > 1)\n    #define($heading)\n      <input name=\"includeBatch\" id=\"includeBatch\" type=\"checkbox\" value=\"true\"/><label for=\"includeBatch\">$services.localization.render('core.restore.includeBatch')</label> ($batchDeletedDocuments.size())\n    #end\n    #define($body)\n      ##\n      ## Batch details.\n      ##\n      <div class=\"row\">\n        <div class=\"col-xs-12 col-lg-4\">\n          <div><b>$services.localization.render('core.restore.deleter')</b></div> $xwiki.getUserName($deletedDocument.deleter)\n        </div>\n        <div class=\"col-xs-12 col-lg-4\">\n          <div><b>$services.localization.render('core.restore.deleteDate')</b></div> $xwiki.formatDate($deletedDocument.date)\n        </div>\n        <div class=\"col-xs-12 col-lg-4\">\n          <div><b>$services.localization.render('core.restore.batchId')</b></div> $deletedDocument.batchId\n        </div>\n      </div>\n      ##\n      ## List the deleted documents in the batch using a livetable.\n      ##\n      #set ($collist = ['doc.name', 'doc.location', '_actions'])\n      #set ($colprops = {\n        'doc.name'     : { 'link' : 'view', 'filterable': false, 'sortable' : 'false' },\n        'doc.location' : { 'type' : 'text', 'link' : false, 'filterable': true, 'html': true},\n        '_actions'     : { 'actions' : ['restore', 'delete'] }\n      })\n      #set ($urlParameters = \"xpage=getdeleteddocuments&doc.batchId=$!{escapetool.url($deletedDocument.batchId)}\")\n      #set ($options = { \n        'url' : \"$doc.getURL('get', $urlParameters)\",\n        'translationPrefix' : 'core.restore.batch.',\n        'outputOnlyHtml' : true,\n        'selectedColumn' : 'doc.location'\n      })\n      #livetable('deletedBatch' $collist $colprops $options)\n    #end\n    #displayPanel('panel-batch', 'panel-default', $heading, $body)\n  #end\n#end\n#######################################################\n##              DISPLAY CONFIRM MESSAGE\n#######################################################\n#macro(displayConfirmMessage)\n  <div class=\"hidden\">\n    <input type=\"hidden\" name=\"form_token\" value=\"$!{services.csrf.getToken()}\" />\n    <input type=\"hidden\" name=\"confirm\" value=\"true\"/>\n    <input type=\"hidden\" name=\"async\" value=\"true\"/>\n    #if(\"$!{request.xredirect}\" != '')\n      <input type=\"hidden\" name=\"xredirect\" value=\"$!{escapetool.xml($request.xredirect)}\"/>\n    #end\n  </div>\n  <button class=\"btn btn-primary\">$services.localization.render('core.restore.confirm.yes')</button>\n  #if(\"$!{request.xredirect}\" != '')\n    #getSanitizedURLAttributeValue('a','href',$request.xredirect,$doc.getURL(),$cancelUrl)\n  #else\n    #set($cancelUrl = $escapetool.xml($doc.getURL()))\n  #end\n  <a class=\"btn btn-default\" href=\"$cancelUrl\">$services.localization.render('core.restore.confirm.no')</a>\n#end\n"], "filenames": ["xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-resources/src/main/resources/flamingo/restore.vm"], "buggy_code_start_loc": [181], "buggy_code_end_loc": [186], "fixing_code_start_loc": [181], "fixing_code_end_loc": [186], "type": "CWE-87", "message": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. Users are able to forge an URL with a payload allowing to inject Javascript in the page (XSS). It's possible to exploit the restore template to perform a XSS, e.g. by using URL such as: > /xwiki/bin/view/XWiki/Main?xpage=restore&showBatch=true&xredirect=javascript:alert(document.domain). This vulnerability exists since XWiki 9.4-rc-1. The vulnerability has been patched in XWiki 14.10.5 and 15.1-rc-1. ", "other": {"cve": {"id": "CVE-2023-35158", "sourceIdentifier": "security-advisories@github.com", "published": "2023-06-23T19:15:09.420", "lastModified": "2023-06-30T13:10:25.870", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. Users are able to forge an URL with a payload allowing to inject Javascript in the page (XSS). It's possible to exploit the restore template to perform a XSS, e.g. by using URL such as: > /xwiki/bin/view/XWiki/Main?xpage=restore&showBatch=true&xredirect=javascript:alert(document.domain). This vulnerability exists since XWiki 9.4-rc-1. The vulnerability has been patched in XWiki 14.10.5 and 15.1-rc-1. "}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}, {"source": "security-advisories@github.com", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 9.6, "baseSeverity": "CRITICAL"}, "exploitabilityScore": 2.8, "impactScore": 6.0}]}, "weaknesses": [{"source": "security-advisories@github.com", "type": "Primary", "description": [{"lang": "en", "value": "CWE-87"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:xwiki:xwiki:*:*:*:*:*:*:*:*", "versionStartIncluding": "9.4", "versionEndExcluding": "14.10.5", "matchCriteriaId": "0B391316-31F5-43BF-84FA-5D7EA4ED2B4C"}, {"vulnerable": true, "criteria": "cpe:2.3:a:xwiki:xwiki:9.4:-:*:*:*:*:*:*", "matchCriteriaId": "43906365-8CE4-40E3-A727-8248416D2ED9"}, {"vulnerable": true, "criteria": "cpe:2.3:a:xwiki:xwiki:9.4:rc-1:*:*:*:*:*:*", "matchCriteriaId": "5A6A9821-3FDF-457E-8CC7-0C18CCBB9D3C"}, {"vulnerable": true, "criteria": "cpe:2.3:a:xwiki:xwiki:15.0:-:*:*:*:*:*:*", "matchCriteriaId": "99329652-2907-4903-AAB1-1038F225C020"}]}]}], "references": [{"url": "https://github.com/xwiki/xwiki-platform/commit/d5472100606c8355ed44ada273e91df91f682738", "source": "security-advisories@github.com", "tags": ["Patch", "Vendor Advisory"]}, {"url": "https://github.com/xwiki/xwiki-platform/security/advisories/GHSA-mwxj-g7fw-7hc8", "source": "security-advisories@github.com", "tags": ["Vendor Advisory"]}, {"url": "https://jira.xwiki.org/browse/XWIKI-20352", "source": "security-advisories@github.com", "tags": ["Issue Tracking", "Vendor Advisory"]}, {"url": "https://jira.xwiki.org/browse/XWIKI-20583", "source": "security-advisories@github.com", "tags": ["Issue Tracking", "Patch", "Vendor Advisory"]}]}, "github_commit_url": "https://github.com/xwiki/xwiki-platform/commit/d5472100606c8355ed44ada273e91df91f682738"}}