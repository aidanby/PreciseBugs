{"buggy_code": ["<?php\n\n// Including the check_permission file, don't delete the following row!\nrequire(__DIR__ . '/check_permission.php');\n\nif(isset($_POST[\"username\"]) or isset($_POST[\"password\"])){\n    $tmpusername = strip_tags($_POST[\"username\"]);\n    $tmpusername = htmlspecialchars($tmpusername, ENT_QUOTES);\n    $tmppassword = md5($_POST[\"password\"]);\n    $data = '$username = \"'.$tmpusername.'\"; $password = \\''.$tmppassword.'\\';'.PHP_EOL;\n    $fp = fopen(__DIR__ . '/pluginconfig.php', 'a');\n    fwrite($fp, $data);\n    unlink(__DIR__ . \"/new.php\");\n    unlink(__DIR__ . \"/create.php\");\n    header(\"Location: imgbrowser.php\");\n} \n\n", "<?php\n\n// checking lang value\nif(isset($_COOKIE['sy_lang'])) {\n    $load_lang_code = $_COOKIE['sy_lang'];\n} else {\n    $load_lang_code = \"en\";\n}\n\n// including lang files\nswitch ($load_lang_code) {\n    case \"en\":\n        require(__DIR__ . '/lang/en.php');\n        break;\n    case \"pl\":\n        require(__DIR__ . '/lang/pl.php');\n        break;\n}\n\nif(isset($_POST[\"newpath\"]) or isset($_POST[\"extension\"]) or isset($_GET[\"file_style\"])){\n    session_start();\n}\n\nif(isset($_SESSION['username'])){\n    \n    if(isset($_POST[\"newpath\"])){\n        $newpath = filter_input(INPUT_POST, 'newpath', FILTER_SANITIZE_STRING);\n        $root = $_SERVER['DOCUMENT_ROOT'];\n        $data = '\n    $useruploadfolder = \"'.$newpath.'\";\n    $useruploadpath = $usersiteroot.\"$useruploadfolder/\";\n    $foldershistory[] = \"'.$newpath.'\";\n        '.PHP_EOL;\n        $fp = fopen(__DIR__ . '/pluginconfig.php', 'a');\n        fwrite($fp, $data);\n    }\n    \n    if(isset($_POST[\"extension\"])){\n        $extension_setting = filter_input(INPUT_POST, 'extension', FILTER_SANITIZE_STRING);\n        if($extension_setting == \"no\" or $extension_setting == \"yes\"){\n            setcookie(\n                \"file_extens\",\n                $extension_setting,\n                time() + (10 * 365 * 24 * 60 * 60)\n            );\n        } else {\n            echo '\n                <script>\n                alert(\"'.$dltimageerrors1.'\\r\\n\\r\\n'.$configerrors1.'\");\n                history.back();\n                </script>\n            ';\n        }\n    } \n    if(isset($_GET[\"file_style\"])){\n        $file_style = filter_input(INPUT_GET, 'file_style', FILTER_SANITIZE_STRING);\n        if($file_style == \"block\" or $file_style == \"list\"){\n            setcookie(\n                \"file_style\",\n                $file_style,\n                time() + (10 * 365 * 24 * 60 * 60)\n            );\n            header('Location: ' . $_SERVER['HTTP_REFERER']);\n        } else {\n            echo '\n                <script>\n                alert(\"'.$dltimageerrors1.'\\r\\n\\r\\n'.$configerrors2.'\");\n                history.back();\n                </script>\n            ';\n        }\n    } \n    \n}\n\n// Version of the plugin\n$currentpluginver = \"4.1.8\";\n\n// Show/Hide the settings button\n$show_settings = true;\n\n// username and password\n$username = \"\";\n$password = \"\";\n\n// ststem icons\n$sy_icons = array( \n    \"cd-ico-browser.ico\",\n    \"cd-icon-block.png\",\n    \"cd-icon-browser.png\",\n    \"cd-icon-bug.png\",\n    \"cd-icon-close-black.png\",\n    \"cd-icon-close-grey.png\",\n    \"cd-icon-close.png\",\n    \"cd-icon-coffee.png\",\n    \"cd-icon-credits.png\",\n    \"cd-icon-delete.png\",\n    \"cd-icon-disable.png\",\n    \"cd-icon-done.png\",\n    \"cd-icon-download.png\",\n    \"cd-icon-edit.png\",\n    \"cd-icon-english.png\",\n    \"cd-icon-faq.png\",\n    \"cd-icon-german.png\",\n    \"cd-icon-hideext.png\",\n    \"cd-icon-image.png\",\n    \"cd-icon-images.png\",\n    \"cd-icon-list.png\",\n    \"cd-icon-logout.png\",\n    \"cd-icon-password.png\",\n    \"cd-icon-polish.png\",\n    \"cd-icon-qedit.png\",\n    \"cd-icon-qtrash.png\",\n    \"cd-icon-refresh.png\",\n    \"cd-icon-select.png\",\n    \"cd-icon-settings.png\",\n    \"cd-icon-showext.png\",\n    \"cd-icon-translate.png\",\n    \"cd-icon-updates.png\",\n    \"cd-icon-upload-big.png\",\n    \"cd-icon-upload-grey.png\",\n    \"cd-icon-upload.png\",\n    \"cd-icon-use.png\",\n    \"cd-icon-version.png\",\n    \"cd-icon-warning.png\",\n);\n\n// show/hide file extension\nif(!isset($_COOKIE[\"file_extens\"])){\n    $file_extens = \"no\";\n} else {\n    $file_extens = $_COOKIE[\"file_extens\"];\n}\n\n// show/hide news section\nif(!isset($_COOKIE[\"show_news\"])){\n    $news_sction = \"yes\";\n} else {\n    $news_sction = \"no\";\n}\n\n// file_style\nif(!isset($_COOKIE[\"file_style\"])){\n    $file_style = \"block\";\n} else {\n    $file_style = $_COOKIE[\"file_style\"];\n}\n\n// Path to the upload folder, please set the path using the Image Browser Settings menu.\n\n$foldershistory = array();\n$useruploadroot = \"http://$_SERVER[HTTP_HOST]\";\n$browserfolder = pathinfo(\"$_SERVER[REQUEST_URI]\");\n$browserfolder = ltrim($browserfolder[\"dirname\"], '/');\n$usersiteroot = substr($_SERVER[\"SCRIPT_FILENAME\"], 0, (stripos($_SERVER[\"SCRIPT_FILENAME\"], $_SERVER[\"SCRIPT_NAME\"])+1));\n\n$useruploadfolder = \"$browserfolder/uploads\";\n$useruploadpath = $usersiteroot.\"$useruploadfolder/\";\n$foldershistory[] = $useruploadfolder;\n\n"], "fixing_code": ["<?php\n\n// Including the check_permission file, don't delete the following row!\nrequire(__DIR__ . '/check_permission.php');\n\nif(isset($_POST[\"username\"]) or isset($_POST[\"password\"])){\n    // only allow alphanumeric, underscore, dot, and dash for username\n    $tmpusername =  preg_replace(\"/[^a-zA-Z0-9_.\\-]+/\", \"\", $_POST[\"username\"]);\n    $tmppassword = md5($_POST[\"password\"]);\n    $data = '$username = \\''.$tmpusername.'\\'; $password = \\''.$tmppassword.'\\';'.PHP_EOL;\n    $fp = fopen(__DIR__ . '/pluginconfig.php', 'a');\n    fwrite($fp, $data);\n    unlink(__DIR__ . \"/new.php\");\n    unlink(__DIR__ . \"/create.php\");\n    header(\"Location: imgbrowser.php\");\n}\n\n", "<?php\n\n// checking lang value\nif(isset($_COOKIE['sy_lang'])) {\n    $load_lang_code = $_COOKIE['sy_lang'];\n} else {\n    $load_lang_code = \"en\";\n}\n\n// including lang files\nswitch ($load_lang_code) {\n    case \"en\":\n        require(__DIR__ . '/lang/en.php');\n        break;\n    case \"pl\":\n        require(__DIR__ . '/lang/pl.php');\n        break;\n}\n\nif(isset($_POST[\"newpath\"]) or isset($_POST[\"extension\"]) or isset($_GET[\"file_style\"])){\n    session_start();\n}\n\nif(isset($_SESSION['username'])){\n\n    if(isset($_POST[\"newpath\"])){\n        $options = array(\"flags\" => FILTER_FLAG_STRIP_LOW | FILTER_FLAG_STRIP_HIGH | FILTER_FLAG_STRIP_BACKTICK);\n        $newpath = filter_input(INPUT_POST, 'newpath', FILTER_SANITIZE_STRING, $options);\n        $newpath = addslashes($newpath);\n        $root = $_SERVER['DOCUMENT_ROOT'];\n        $data = '\n    $useruploadfolder = \\''.$newpath.'\\';\n    $useruploadpath = $usersiteroot.\"$useruploadfolder/\";\n    $foldershistory[] = \\''.$newpath.'\\';\n        '.PHP_EOL;\n        $fp = fopen(__DIR__ . '/pluginconfig.php', 'a');\n        fwrite($fp, $data);\n    }\n\n    if(isset($_POST[\"extension\"])){\n        $extension_setting = filter_input(INPUT_POST, 'extension', FILTER_SANITIZE_STRING);\n        if($extension_setting == \"no\" or $extension_setting == \"yes\"){\n            setcookie(\n                \"file_extens\",\n                $extension_setting,\n                time() + (10 * 365 * 24 * 60 * 60)\n            );\n        } else {\n            echo '\n                <script>\n                alert(\"'.$dltimageerrors1.'\\r\\n\\r\\n'.$configerrors1.'\");\n                history.back();\n                </script>\n            ';\n        }\n    }\n    if(isset($_GET[\"file_style\"])){\n        $file_style = filter_input(INPUT_GET, 'file_style', FILTER_SANITIZE_STRING);\n        if($file_style == \"block\" or $file_style == \"list\"){\n            setcookie(\n                \"file_style\",\n                $file_style,\n                time() + (10 * 365 * 24 * 60 * 60)\n            );\n            header('Location: ' . $_SERVER['HTTP_REFERER']);\n        } else {\n            echo '\n                <script>\n                alert(\"'.$dltimageerrors1.'\\r\\n\\r\\n'.$configerrors2.'\");\n                history.back();\n                </script>\n            ';\n        }\n    }\n\n}\n\n// Version of the plugin\n$currentpluginver = \"4.1.8\";\n\n// Show/Hide the settings button\n$show_settings = true;\n\n// username and password\n$username = \"\";\n$password = \"\";\n\n// ststem icons\n$sy_icons = array(\n    \"cd-ico-browser.ico\",\n    \"cd-icon-block.png\",\n    \"cd-icon-browser.png\",\n    \"cd-icon-bug.png\",\n    \"cd-icon-close-black.png\",\n    \"cd-icon-close-grey.png\",\n    \"cd-icon-close.png\",\n    \"cd-icon-coffee.png\",\n    \"cd-icon-credits.png\",\n    \"cd-icon-delete.png\",\n    \"cd-icon-disable.png\",\n    \"cd-icon-done.png\",\n    \"cd-icon-download.png\",\n    \"cd-icon-edit.png\",\n    \"cd-icon-english.png\",\n    \"cd-icon-faq.png\",\n    \"cd-icon-german.png\",\n    \"cd-icon-hideext.png\",\n    \"cd-icon-image.png\",\n    \"cd-icon-images.png\",\n    \"cd-icon-list.png\",\n    \"cd-icon-logout.png\",\n    \"cd-icon-password.png\",\n    \"cd-icon-polish.png\",\n    \"cd-icon-qedit.png\",\n    \"cd-icon-qtrash.png\",\n    \"cd-icon-refresh.png\",\n    \"cd-icon-select.png\",\n    \"cd-icon-settings.png\",\n    \"cd-icon-showext.png\",\n    \"cd-icon-translate.png\",\n    \"cd-icon-updates.png\",\n    \"cd-icon-upload-big.png\",\n    \"cd-icon-upload-grey.png\",\n    \"cd-icon-upload.png\",\n    \"cd-icon-use.png\",\n    \"cd-icon-version.png\",\n    \"cd-icon-warning.png\",\n);\n\n// show/hide file extension\nif(!isset($_COOKIE[\"file_extens\"])){\n    $file_extens = \"no\";\n} else {\n    $file_extens = $_COOKIE[\"file_extens\"];\n}\n\n// show/hide news section\nif(!isset($_COOKIE[\"show_news\"])){\n    $news_sction = \"yes\";\n} else {\n    $news_sction = \"no\";\n}\n\n// file_style\nif(!isset($_COOKIE[\"file_style\"])){\n    $file_style = \"block\";\n} else {\n    $file_style = $_COOKIE[\"file_style\"];\n}\n\n// Path to the upload folder, please set the path using the Image Browser Settings menu.\n\n$foldershistory = array();\n$useruploadroot = \"http://$_SERVER[HTTP_HOST]\";\n$browserfolder = pathinfo(\"$_SERVER[REQUEST_URI]\");\n$browserfolder = ltrim($browserfolder[\"dirname\"], '/');\n$usersiteroot = substr($_SERVER[\"SCRIPT_FILENAME\"], 0, (stripos($_SERVER[\"SCRIPT_FILENAME\"], $_SERVER[\"SCRIPT_NAME\"])+1));\n\n$useruploadfolder = \"$browserfolder/uploads\";\n$useruploadpath = $usersiteroot.\"$useruploadfolder/\";\n$foldershistory[] = $useruploadfolder;\n\n"], "filenames": ["create.php", "pluginconfig.php"], "buggy_code_start_loc": [7, 25], "buggy_code_end_loc": [17, 88], "fixing_code_start_loc": [7, 25], "fixing_code_end_loc": [17, 90], "type": "CWE-94", "message": "Code injection in pluginconfig.php in Image Uploader and Browser for CKEditor before 4.1.9 allows remote authenticated users to execute arbitrary PHP code.", "other": {"cve": {"id": "CVE-2019-19502", "sourceIdentifier": "cve@mitre.org", "published": "2019-12-02T16:15:12.470", "lastModified": "2020-08-24T17:37:01.140", "vulnStatus": "Modified", "descriptions": [{"lang": "en", "value": "Code injection in pluginconfig.php in Image Uploader and Browser for CKEditor before 4.1.9 allows remote authenticated users to execute arbitrary PHP code."}, {"lang": "es", "value": "La inyecci\u00f3n de c\u00f3digo en pluginconfig.php en Image Uploader and Browser for CKEditor anterior a la versi\u00f3n 4.1.9 permite a los usuarios autenticados remotos ejecutar c\u00f3digo PHP arbitrario."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 9.8, "baseSeverity": "CRITICAL"}, "exploitabilityScore": 3.9, "impactScore": 5.9}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:N/C:P/I:P/A:P", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "NONE", "confidentialityImpact": "PARTIAL", "integrityImpact": "PARTIAL", "availabilityImpact": "PARTIAL", "baseScore": 7.5}, "baseSeverity": "HIGH", "exploitabilityScore": 10.0, "impactScore": 6.4, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-94"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:maleck:image_uploader_and_browser_for_ckeditor:*:*:*:*:*:*:*:*", "versionEndExcluding": "4.1.9", "matchCriteriaId": "EFC9A02D-959D-41CE-9E59-BB47D7676268"}]}]}], "references": [{"url": "https://github.com/xsmo/Image-Uploader-and-Browser-for-CKEditor/commit/c293d38c8b99444e775d94c1af50c9676c6544d2", "source": "cve@mitre.org", "tags": ["Patch"]}, {"url": "https://github.com/xsmo/Image-Uploader-and-Browser-for-CKEditor/compare/4.1.8...v4.1.9", "source": "cve@mitre.org", "tags": ["Third Party Advisory"]}, {"url": "https://github.com/xsmo/Image-Uploader-and-Browser-for-CKEditor/pull/11", "source": "cve@mitre.org", "tags": ["Third Party Advisory"]}, {"url": "https://github.com/xsmo/Image-Uploader-and-Browser-for-CKEditor/pull/11/commits/5c7a6b0e10504f08e2f50655541b767e276ce749", "source": "cve@mitre.org", "tags": ["Patch"]}, {"url": "https://visat.me/security/cve-2019-19502/", "source": "cve@mitre.org"}]}, "github_commit_url": "https://github.com/xsmo/Image-Uploader-and-Browser-for-CKEditor/commit/c293d38c8b99444e775d94c1af50c9676c6544d2"}}