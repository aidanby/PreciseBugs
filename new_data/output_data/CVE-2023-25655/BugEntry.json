{"buggy_code": ["<?php\n/**\n * baserCMS :  Based Website Development Project <https://basercms.net>\n * Copyright (c) baserCMS Users Community <https://basercms.net/community/>\n *\n * @copyright       Copyright (c) baserCMS Users Community\n * @link            https://basercms.net baserCMS Project\n * @package         Baser.Model.Behavior\n * @since           baserCMS v 1.5.3\n * @license         https://basercms.net/license/index.html\n */\n\nApp::uses('Imageresizer', 'Vendor');\nApp::uses('BcFileUploader', 'Lib');\n\n/**\n * Class BcUploadBehavior\n *\n * \u30d5\u30a1\u30a4\u30eb\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u30d3\u30d8\u30a4\u30d3\u30a2\n *\n * \u300a\u8a2d\u5b9a\u4f8b\u300b\n * public $actsAs = array(\n *  'BcUpload' => array(\n *     'saveDir'  => \"editor\",\n *     'fields'  => array(\n *       'image'  => array(\n *         'type'      => 'image',\n *         'namefield'    => 'id',\n *         'nameadd'    => false,\n *            'subdirDateFormat'    => 'Y/m'    // Or false\n *         'imageresize'  => array('prefix' => 'template', 'width' => '100', 'height' => '100'),\n *                'imagecopy'        => array(\n *                    'thumb'            => array('suffix' => 'template', 'width' => '150', 'height' => '150'),\n *                    'thumb_mobile'    => array('suffix' => 'template', 'width' => '100', 'height' => '100')\n *                )\n *       ),\n *       'pdf' => array(\n *         'type'      => 'pdf',\n *         'namefield'    => 'id',\n *         'nameformat'  => '%d',\n *         'nameadd'    => false\n *       )\n *     )\n *   )\n * );\n *\n * @package Baser.Model.Behavior\n * @property BcFileUploader[] $BcFileUploader\n */\nclass BcUploadBehavior extends ModelBehavior\n{\n\n    /**\n     * BcFileUploader\n     * @var BcFileUploader[]\n     */\n    public $BcFileUploader = [];\n\n\t/**\n\t * oldEntity\n\t * @var array\n\t */\n\tpublic $oldEntity = [];\n\n\t/**\n\t * \u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u4e2d\u306e\u30ed\u30c3\u30af\n\t * @var bool\n\t */\n\tpublic $validatingLock = [];\n\n\t/**\n\t * \u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n\t *\n\t * @param Model $Model\n\t * @param array $settings actsAs\u306e\u8a2d\u5b9a\n\t */\n\tpublic function setup(Model $Model, $settings = [])\n\t{\n\t\t$this->BcFileUploader[$Model->alias] = new BcFileUploader();\n        $this->BcFileUploader[$Model->alias]->initialize($settings, $Model);\n\t\t$this->validatingLock[$Model->alias] = false;\n        // @deprecated \u5f8c\u65b9\u4e92\u63db since v4.5.6, v5.0.0 \u3067\u524a\u9664\u4e88\u5b9a\n        // CuApprover-4.3.2\u4ee5\u4e0b\u306b\u5bfe\u5fdc\u3059\u308b\u305f\u3081\u306e\u51e6\u7406\n        // >>>\n        $this->settings[$Model->alias] = $this->BcFileUploader[$Model->alias]->settings;\n        // <<<\n\n\t}\n\n\t/**\n\t * @param $modelName\n\t * @return BcFileUploader|false\n\t */\n\tpublic function getFileUploader(Model $model)\n\t{\n\t\treturn (isset($this->BcFileUploader[$model->alias]))? $this->BcFileUploader[$model->alias] : false;\n\t}\n\n\t/**\n\t * After Validate\n\t *\n\t * @param Model $Model\n\t * @param array $options\n\t * @return mixed\n\t */\n\tpublic function afterValidate(Model $Model, $options = [])\n\t{\n\t\tif($this->validatingLock[$Model->alias]) return true;\n        $Model->data[$Model->alias] = $this->BcFileUploader[$Model->alias]->setupRequestData(isset($Model->data[$Model->alias])? $Model->data[$Model->alias] : $Model->data);\n        $Model->data[$Model->alias] = $this->BcFileUploader[$Model->alias]->setupTmpData(isset($Model->data[$Model->alias])? $Model->data[$Model->alias] : $Model->data);\n        $this->oldEntity[$Model->alias] = (!empty($Model->data[$Model->alias]['id']))? $this->getOldEntity($Model, $Model->data[$Model->alias]['id']) : [];\n        $this->validatingLock[$Model->alias] = true;\n\n\t\t// @deprecated \u5f8c\u65b9\u4e92\u63db since v4.5.6, v5.0.0 \u3067\u524a\u9664\u4e88\u5b9a\n\t\t// CuApprover-4.3.2\u4ee5\u4e0b\u306b\u5bfe\u5fdc\u3059\u308b\u305f\u3081\u306e\u51e6\u7406\n\t\t// \u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u3092\u914d\u5217\u3067\u5b9f\u884c\u3055\u305b\u308b\u305f\u3081\u914d\u5217\u306b\u5909\u63db\n\t\t// >>>\n\t\t$files = $this->BcFileUploader[$Model->alias]->getUploadingFiles();\n\t\tforeach($files as $key => $file) {\n\t\t\t$this->settings[$Model->alias]['fields'][$key]['upload'] = (!empty($file['uploadable'])) ? true : false;\n\t\t\tif(!empty($file['uploadable'])) {\n\t\t\t\t$Model->data[$Model->alias][$key] = $file;\n\t\t\t\t// \u516c\u958b\u627f\u8a8d\u306e\u304a\u3051\u308b\u8349\u7a3f\u306e\u65b0\u898f\u6295\u7a3f\u5bfe\u5fdc\n\t\t\t\t$setting = $this->settings[$Model->alias]['fields'][$key];\n\t\t\t\t$Model->data[$Model->alias][$key] = $fileName = $this->BcFileUploader[$Model->alias]->saveFile($setting, $file);\n\t\t\t\tif (($setting['type'] == 'all' || $setting['type'] == 'image') && !empty($setting['imagecopy']) && in_array($file['ext'], $this->BcFileUploader[$Model->alias]->imgExts)) {\n\t\t\t\t\t$this->BcFileUploader[$Model->alias]->copyImages($setting, $file);\n\t\t\t\t\tif (!empty($setting['imageresize'])) {\n\t\t\t\t\t\t$filePath = $this->BcFileUploader[$Model->alias]->savePath . $fileName;\n\t\t\t\t\t\t$this->BcFileUploader[$Model->alias]->resizeImage($filePath, $filePath, $setting['imageresize']['width'], $setting['imageresize']['height'], $setting['imageresize']['thumb']);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t// <<<\n\n        return true;\n\t}\n\n\t/**\n\t * before save\n\t *\n\t * \u30d5\u30a1\u30a4\u30eb\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3057\u3066\u3044\u308b\u5834\u5408\u3001\u30c7\u30fc\u30bf\u304c\u914d\u5217\u306b\u306a\u3063\u3066\u3044\u308b\u305f\u3081\u3001\u6587\u5b57\u5217\u30c7\u30fc\u30bf\u306b\u5909\u63db\u3059\u308b\n\t * \u305f\u3060\u3057\u3001\u516c\u958b\u627f\u8a8d\u306e\u4e0b\u66f8\u304d\u30e2\u30fc\u30c9\u306e\u5834\u5408\u3001BlogPost\u5074\u306e\u30c7\u30fc\u30bf\u304c\u65b0\u3057\u3044\u30c7\u30fc\u30bf\u3067\u66f8\u304d\u63db\u308f\u3063\u3066\u3057\u307e\u3063\u3066\u306f\u554f\u984c\u3068\u306a\u308b\u305f\u3081\n\t * \u4fdd\u5b58\u3055\u305b\u306a\u3044\u3088\u3046\u306b\u3059\u308b\u305f\u3081\u51e6\u7406\u3092\u30b9\u30eb\u30fc\u3055\u305b\u308b\n\t * @param Model $Model\n\t * @param array $options\n\t * @return boolean\n\t * @deprecated \u5f8c\u65b9\u4e92\u63db since v4.5.6, v5.0.0 \u3067\u524a\u9664\u4e88\u5b9a\n\t * CuApprover-4.3.2\u4ee5\u4e0b\u306b\u5bfe\u5fdc\u3059\u308b\u305f\u3081\u306e\u51e6\u7406\n\t */\n\tpublic function beforeSave(Model $Model, $options = [])\n\t{\n\t\tif (isset($Model->data['CuApproverApplication']['contentsMode'])\n\t\t\t&& isset($Model->data['CuApproverApplication']['is_published'])) {\n\t\t\tif($Model->alias === 'BlogPost' &&\n\t\t\t\t$Model->data['CuApproverApplication']['contentsMode'] === 'draft' &&\n\t\t\t\t$Model->data['CuApproverApplication']['is_published']) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\t$files = $this->BcFileUploader[$Model->alias]->getUploadingFiles();\n\t\tforeach($files as $key => $file) {\n\t\t\tif(!empty($file['uploadable'])) {\n\t\t\t\tif(empty($Model->data['CuApproverApplication'])) {\n\t\t\t\t\t// Content \u306e\u516c\u958b\u627f\u8a8d\u306e\u4e0b\u66f8\u304d\u4fdd\u5b58\u6642\u3001BcContentsBehavior::afterSave() \u3067\u5225\u9014\u4fdd\u5b58\u51e6\u7406\u304c\u767a\u751f\u3059\u308b\u305f\u3081\u3001\n\t\t\t\t\t// \u305d\u306e\u969b\u3001eyecatch \u306e\u914d\u5217\u3067\u304f\u308b\u304c\u4fdd\u5b58\u3055\u305b\u306a\u3044\u3088\u3046\u306b unset \u3059\u308b\n\t\t\t\t\tunset($Model->data[$Model->alias][$key]);\n\t\t\t\t} else {\n\t\t\t\t\t$Model->data[$Model->alias][$key] = $file['name'];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n\n\t/**\n\t * After save\n\t *\n\t * @param Model $Model\n\t * @param array $options\n\t * @return boolean\n\t */\n\tpublic function afterSave(Model $Model, $created, $options = [])\n\t{\n\t\t// @deprecated \u5f8c\u65b9\u4e92\u63db since v4.5.6, v5.0.0 \u3067\u524a\u9664\u4e88\u5b9a\n\t\t// CuApprover-4.3.2\u4ee5\u4e0b\u306b\u5bfe\u5fdc\u3059\u308b\u305f\u3081\u306e\u51e6\u7406\n\t\t// >>>\n\t\tif(!empty($this->settings[$Model->alias]['fields'])) {\n\t\t\t$files = $this->BcFileUploader[$Model->alias]->getUploadingFiles();\n\t\t\tforeach($this->settings[$Model->alias]['fields'] as $key => $field) {\n\t\t\t\t$files[$key]['uploadable'] = (!empty($field['upload']))? true : false;\n\t\t\t}\n\t\t\t$this->BcFileUploader[$Model->alias]->setUploadingFiles($files);\n\t\t}\n\t\t// <<<\n\n\t\t$data = isset($Model->data[$Model->alias])? $Model->data[$Model->alias] : $Model->data;\n        if ($Model->exists() && isset($this->oldEntity[$Model->alias])) {\n            $this->BcFileUploader[$Model->alias]->deleteExistingFiles($this->oldEntity[$Model->alias]);\n        }\n        $entity = $this->BcFileUploader[$Model->alias]->saveFiles($data);\n\n\t\t// @deprecated \u5f8c\u65b9\u4e92\u63db since v4.5.6, v5.0.0 \u3067\u524a\u9664\u4e88\u5b9a\n\t\t// CuApprover-4.3.2\u4ee5\u4e0b\u306b\u5bfe\u5fdc\u3059\u308b\u305f\u3081\u306e\u51e6\u7406\n\t\t// >>>\n\t\t$this->uploaded[$Model->alias] = $this->BcFileUploader[$Model->alias]->uploaded;\n\t\t// <<<\n\n        if ($Model->exists() && isset($this->oldEntity[$Model->alias])) {\n            $entity = $this->BcFileUploader[$Model->alias]->deleteFiles($this->oldEntity[$Model->alias], $entity);\n        }\n        if ($this->BcFileUploader[$Model->alias]->isUploaded()) {\n            $entity = $this->BcFileUploader[$Model->alias]->renameToBasenameFields($entity);\n            $this->BcFileUploader[$Model->alias]->resetUploaded();\n\n            // @deprecated \u5f8c\u65b9\u4e92\u63db since v4.5.6, v5.0.0 \u3067\u524a\u9664\u4e88\u5b9a\n            // CuApprover-4.3.2\u4ee5\u4e0b\u306b\u5bfe\u5fdc\u3059\u308b\u305f\u3081\u306e\u51e6\u7406\n            // >>>\n            $this->uploaded[$Model->alias] = false;\n            // <<<\n\n        }\n        $Model->data = $Model->save($entity, ['validate' => false, 'callbacks' => false]);\n\n\t\t// @deprecated \u5f8c\u65b9\u4e92\u63db since v4.5.6, v5.0.0 \u3067\u524a\u9664\n\t\t// CuApprover-4.3.2\u4ee5\u4e0b\u306b\u5bfe\u5fdc\u3059\u308b\u305f\u3081\u306e\u51e6\u7406\n\t\t// \u516c\u958b\u627f\u8a8d\u306e\u304a\u3051\u308b\u8349\u7a3f\u306e\u65b0\u898f\u6295\u7a3f\u5bfe\u5fdc\n\t\t// afterValidate \u3067\u7121\u7406\u3084\u308a\u751f\u6210\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u3092\u524a\u9664\u3059\u308b\n\t\t// >>>\n\t\tif(!empty($files)) {\n\t\t\tforeach($files as $key => $file) {\n\t\t\t\tif(!empty($file['name'])) {\n\t\t\t\t\t$setting = $this->settings[$Model->alias]['fields'][$key];\n\t\t\t\t\t$this->BcFileUploader[$Model->alias]->deleteFile($setting, $file['name']);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t// <<<\n        return true;\n\t}\n\n\t/**\n\t * Before delete\n\t * \u753b\u50cf\u30d5\u30a1\u30a4\u30eb\u306e\u524a\u9664\u3092\u884c\u3046\n\t * \u524a\u9664\u306b\u5931\u6557\u3057\u3066\u3082\u30c7\u30fc\u30bf\u306e\u524a\u9664\u306f\u884c\u3046\n\t *\n\t * @param Model $Model\n\t * @param bool $cascade\n\t * @return bool\n\t */\n\tpublic function beforeDelete(Model $Model, $cascade = true)\n\t{\n\t\t$oldEntity = $this->getOldEntity($Model, $Model->id);\n\t\t$this->BcFileUploader[$Model->alias]->deleteFiles($oldEntity, [], true);\n\t\treturn true;\n\t}\n\n\t/**\n\t * \u4e00\u6642\u30d5\u30a1\u30a4\u30eb\u3068\u3057\u3066\u4fdd\u5b58\u3059\u308b\n\t *\n\t * @param Model $Model\n\t * @param array $data\n\t * @param string $tmpId\n\t * @return mixed false|array\n\t */\n\tpublic function saveTmpFiles(Model $Model, $data, $tmpId)\n\t{\n\t\tif(isset($data[$Model->alias])) {\n\t\t\t$entity = $data[$Model->alias];\n\t\t} else {\n\t\t\t$entity = $data;\n\t\t\t$data = [];\n\t\t}\n\t\t$data[$Model->alias] = $this->BcFileUploader[$Model->alias]->saveTmpFiles($entity, $tmpId);\n\t\treturn $data;\n\t}\n\n    /**\n     * \u8a2d\u5b9a\u60c5\u5831\u3092\u53d6\u5f97\n     * @param $alias\n     * @return mixed\n     * @checked\n     * @noTodo\n     * @unitTest\n     */\n    public function getSettings(Model $Model)\n    {\n        return $this->BcFileUploader[$Model->alias]->settings;\n    }\n\n    /**\n     * \u8a2d\u5b9a\u60c5\u5831\u3092\u8a2d\u5b9a\n     * @param $alias\n     * @param $settings\n     * @checked\n     * @noTodo\n     * @unitTest\n     */\n    public function setSettings(Model $Model, $settings)\n    {\n        $this->BcFileUploader[$Model->alias]->settings = $settings;\n    }\n\n    /**\n     * \u4fdd\u5b58\u5148\u306e\u30d1\u30b9\u3092\u53d6\u5f97\n     * @param $alias\n     * @param false $isTheme\n     * @param false $limited\n     * @return string\n     */\n    public function getSaveDir(Model $Model, $isTheme = false, $limited = false)\n    {\n        return $this->BcFileUploader[$Model->alias]->getSaveDir($isTheme, $limited);\n    }\n\n\t/**\n\t * saveFiles\n\t * @param Model $Model\n\t * @param $entity\n\t * @return mixed\n\t * @deprecated \u5f8c\u65b9\u4e92\u63db since v4.5.6, v5.0.0 \u3067\u524a\u9664\u4e88\u5b9a\n\t */\n    public function saveFiles(Model $Model, $entity)\n\t{\n\t\t$entity[$Model->alias] = $this->BcFileUploader[$Model->alias]->saveFiles($entity[$Model->alias]);\n\t\treturn $entity;\n\t}\n\n\t/**\n\t * saveFiles\n\t * @param Model $Model\n\t * @param $entity\n\t * @return mixed\n\t * @deprecated \u5f8c\u65b9\u4e92\u63db since v4.5.6, v5.0.0 \u3067\u524a\u9664\u4e88\u5b9a\n\t */\n    public function deleteFiles(Model $Model, $newEntity)\n    {\n\t\t$entity[$Model->alias] = $this->BcFileUploader[$Model->alias]->deleteFiles([], $newEntity);\n\t\treturn $entity;\n    }\n\n\t/**\n\t * setupRequestData\n\t * @param Model $Model\n\t * @deprecated \u5f8c\u65b9\u4e92\u63db since v4.5.6, v5.0.0 \u3067\u524a\u9664\u4e88\u5b9a\n\t * CuApprover-4.3.2\u4ee5\u4e0b\u306b\u5bfe\u5fdc\u3059\u308b\u305f\u3081\u306e\u51e6\u7406\n\t */\n\tpublic function setupRequestData(Model $Model)\n\t{\n\t\t// CuApproverApplication.php 261\u884c\u76ee\u3042\u305f\u308a\u3001$this->setupRequestData()\u3000\u3067\u3001\n\t\t// BlogPost\u3001Content \u30e2\u30c7\u30eb\u306e\u524a\u9664\u306e\u969b\u306e\u524a\u9664\u30d5\u30e9\u30b0\u304c\u521d\u671f\u5316\u3055\u308c\u3066\u3057\u307e\u3046\u305f\u3081 return \u3067\u5b9f\u884c\u3057\u306a\u3044\n\t\t// \u521d\u671f\u5316\u3055\u308c\u306a\u304b\u3063\u305f\u30c7\u30fc\u30bf\u306f deleteFileWhileChecking \u306b\u3066\u5229\u7528\u3059\u308b\n\t\t// \u3082\u3068\u3082\u3068\u4e0a\u8a18\u306e\u51e6\u7406\u306f\u3001Content \u3084 Content \u306e\u30d3\u30d8\u30a4\u30d3\u30a2\u8a2d\u5b9a\u3092\n\t\t// CuApproverApplication \u30e2\u30c7\u30eb\u306b\u5f15\u304d\u7d99\u304c\u305b\u308b\u305f\u3081\u306e\u51e6\u7406\u3060\u3063\u305f\u304c\u4e0d\u8981\u3060\u3063\u305f\u3053\u3068\u304c\u308f\u304b\u3063\u305f\u3002\n\t\tif($Model->alias === 'BlogPost' || $Model->alias === 'Content') return;\n\t\t$Model->data[$Model->alias] = $this->BcFileUploader[$Model->alias]->setupRequestData(isset($Model->data[$Model->alias])? $Model->data[$Model->alias] : $Model->data);\n\t\t// CuApprover \u30d7\u30e9\u30b0\u30a4\u30f3\u306b\u3066\u3001CuApproverApplicationBehavior.php 65\u884c\u76ee\u3042\u305f\u308a $model->CuApproverApplication->validates() \u3067\u3001\n\t\t// BcFileUploader->uploadingFiles \u304c\u521d\u671f\u5316\u3055\u308c\u3066\u3057\u307e\u3046\u305f\u3081\u9000\u907f\n        $this->files[$Model->alias] = $this->BcFileUploader[$Model->alias]->getUploadingFiles();\n\t}\n\n\t/**\n\t * delFile\n\t * @param Model $Model\n\t * @deprecated \u5f8c\u65b9\u4e92\u63db since v4.5.6, v5.0.0 \u3067\u524a\u9664\u4e88\u5b9a\n\t * CuApprover-4.3.2\u4ee5\u4e0b\u306b\u5bfe\u5fdc\u3059\u308b\u305f\u3081\u306e\u51e6\u7406\n\t */\n\tpublic function delFile(Model $Model, $fileName, $setting)\n\t{\n\t\t$this->BcFileUploader[$Model->alias]->deleteFile($setting, $fileName);\n\t}\n\n\t/**\n\t * deleteFileWhileChecking\n\t * @param Model $Model\n\t * @deprecated \u5f8c\u65b9\u4e92\u63db since v4.5.6, v5.0.0 \u3067\u524a\u9664\u4e88\u5b9a\n\t * CuApprover-4.3.2\u4ee5\u4e0b\u306b\u5bfe\u5fdc\u3059\u308b\u305f\u3081\u306e\u51e6\u7406\n\t */\n\tpublic function deleteFileWhileChecking(Model $Model, $setting, $requestData, $oldValue)\n\t{\n\t\tif($Model->alias === 'CuApproverApplication') {\n\t\t\t// \u516c\u958b\u627f\u8a8d\u306e\u4e0b\u66f8\u304d\u306e\u30d5\u30a1\u30a4\u30eb\u524a\u9664\u306e\u5834\u5408\u3001\u524a\u9664\u30d5\u30e9\u30b0\u304c\u30ea\u30bb\u30c3\u30c8\u3055\u308c\u305f\u30c7\u30fc\u30bf\u3092\u5229\u7528\u3057\u3066\u3044\u308b\u305f\u3081\u3001\n\t\t\t// \u5143\u30c7\u30fc\u30bf\u306e files \u3092\u5229\u7528\u3059\u308b\n\t\t\tif(!empty($requestData['CuApproverApplication']['blog_content_id'])) {\n\t\t\t\t$files = $this->BcFileUploader['BlogPost']->getUploadingFiles();\n\t\t\t} else {\n\t\t\t\t$files = $this->BcFileUploader['Content']->getUploadingFiles();\n\t\t\t}\n\t\t} else {\n\t\t\t$files = $this->BcFileUploader[$Model->alias]->getUploadingFiles();\n\t\t}\n\t\tif(!$files && !empty($this->files[$Model->alias])) {\n\t\t\t$files = $this->files[$Model->alias];\n\t\t}\n\t\tif(isset($files[$setting['name']])) {\n\t\t\t$file = $files[$setting['name']];\n\t\t} else {\n\t\t\t$file = [];\n\t\t}\n\t\treturn [\n\t\t\t$Model->alias => $this->BcFileUploader[$Model->alias]->deleteFileWhileChecking($setting, $file, $requestData[$Model->alias], [$setting['name'] => $oldValue])\n\t\t];\n\t}\n\n\t/**\n\t * renameToBasenameField\n\t * @param Model $Model\n\t * @deprecated \u5f8c\u65b9\u4e92\u63db since v4.5.6, v5.0.0 \u3067\u524a\u9664\u4e88\u5b9a\n\t * CuApprover-4.3.2\u4ee5\u4e0b\u306b\u5bfe\u5fdc\u3059\u308b\u305f\u3081\u306e\u51e6\u7406\n\t */\n\tpublic function renameToBasenameField(Model $Model, $setting)\n\t{\n\t\t$files = $this->BcFileUploader[$Model->alias]->getUploadingFiles();\n\t\tif(!$files && !empty($this->files[$Model->alias])) {\n\t\t\t$files = $this->files[$Model->alias];\n\t\t}\n\t\tif(isset($files[$setting['name']])) {\n\t\t\t$file = $files[$setting['name']];\n\t\t\tif(!empty($file['name'])) {\n\t\t\t\treturn $this->BcFileUploader[$Model->alias]->renameToBasenameField($setting, $file, $Model->data[$Model->alias]);\n\t\t\t}\n\t\t}\n\t\treturn $Model->data[$Model->alias][$setting['name']];\n\t}\n\n\t/**\n\t * saveFileWhileChecking\n\t * @param Model $Model\n\t * @deprecated \u5f8c\u65b9\u4e92\u63db since v4.5.6, v5.0.0 \u3067\u524a\u9664\u4e88\u5b9a\n\t * CuApprover-4.3.2\u4ee5\u4e0b\u306b\u5bfe\u5fdc\u3059\u308b\u305f\u3081\u306e\u51e6\u7406\n\t */\n\tpublic function saveFileWhileChecking(Model $Model, $setting, $data, $options)\n\t{\n\t\t$file = $this->BcFileUploader[$Model->alias]->saveFileWhileChecking($setting, $this->BcFileUploader[$Model->alias]->getUploadingFiles()[$setting['name']], $data[$Model->alias], $options);\n\t\tif($file) {\n\t\t\t$files = $this->BcFileUploader[$Model->alias]->getUploadingFiles();\n\t\t\t$files[$setting['name']] = $file;\n\t\t\t$this->BcFileUploader[$Model->alias]->setUploadingFiles($files);\n\t\t\t$data[$Model->alias][$setting['name']] = $file['name'];\n\t\t}\n\t\t$this->uploaded[$Model->alias] = $this->BcFileUploader[$Model->alias]->uploaded;\n\t\treturn $data;\n\t}\n\n\t/**\n\t * getFieldBasename\n\t * @param Model $Model\n\t * @deprecated \u5f8c\u65b9\u4e92\u63db since v4.5.6, v5.0.0 \u3067\u524a\u9664\u4e88\u5b9a\n\t * CuApprover-4.3.2\u4ee5\u4e0b\u306b\u5bfe\u5fdc\u3059\u308b\u305f\u3081\u306e\u51e6\u7406\n\t */\n\tpublic function getFieldBasename(Model $Model, $setting, $ext)\n\t{\n\t\t$files = $this->BcFileUploader[$Model->alias]->getUploadingFiles();\n\t\tif(!$files && !empty($this->files[$Model->alias])) {\n\t\t\t$files = $this->files[$Model->alias];\n\t\t}\n\t\tif(isset($files[$setting['name']])) {\n\t\t\t$file = $files[$setting['name']];\n\t\t\tif(empty($file['ext'])) {\n\t\t\t\t$file = ['ext' => $ext];\n\t\t\t}\n\t\t\treturn $this->BcFileUploader[$Model->alias]->getFieldBasename($setting, $file, $Model->data[$Model->alias]);\n\t\t}\n\t\treturn false;\n\t}\n\n\t/**\n\t * getFileName\n\t * @param Model $Model\n\t * @deprecated \u5f8c\u65b9\u4e92\u63db since v4.5.6, v5.0.0 \u3067\u524a\u9664\u4e88\u5b9a\n\t * CuApprover-4.3.2\u4ee5\u4e0b\u306b\u5bfe\u5fdc\u3059\u308b\u305f\u3081\u306e\u51e6\u7406\n\t */\n\tpublic function getFileName(Model $Model , $setting, $name)\n\t{\n\t\treturn $this->BcFileUploader[$Model->alias]->getFileName($setting, $name);\n\t}\n\n\t/**\n\t * getOldEntity\n\t * @param Model $model\n\t * @param int $id\n\t * @return array|int|null\n\t */\n\tpublic function getOldEntity(Model $model, $id)\n\t{\n\t\tif($model instanceof Content) {\n\t\t\t$softDelete = $model->softDelete(null);\n\t\t\t$model->softDelete(false);\n\t\t}\n\t\t$oldEntity = $model->find('first', [\n\t\t\t'conditions' => [$model->alias . '.id' => $id],\n\t\t\t'recursive' => -1\n\t\t]);\n\t\tif($model instanceof Content) {\n\t\t\t$model->softDelete($softDelete);\n\t\t}\n\t\treturn ($oldEntity)? $oldEntity[$model->alias] : [];\n\t}\n\n\t/**\n\t * renameToBasenameFields\n\t * @param Model $Model\n\t */\n\tpublic function renameToBasenameFields(Model $model, $copy = false)\n\t{\n\t\t$model->data[$model->alias] = $this->BcFileUploader[$model->alias]->renameToBasenameFields($model->data[$model->alias], $copy);\n\t\treturn $model->data;\n\t}\n\n}\n"], "fixing_code": ["<?php\n/**\n * baserCMS :  Based Website Development Project <https://basercms.net>\n * Copyright (c) baserCMS Users Community <https://basercms.net/community/>\n *\n * @copyright       Copyright (c) baserCMS Users Community\n * @link            https://basercms.net baserCMS Project\n * @package         Baser.Model.Behavior\n * @since           baserCMS v 1.5.3\n * @license         https://basercms.net/license/index.html\n */\n\nApp::uses('Imageresizer', 'Vendor');\nApp::uses('BcFileUploader', 'Lib');\n\n/**\n * Class BcUploadBehavior\n *\n * \u30d5\u30a1\u30a4\u30eb\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u30d3\u30d8\u30a4\u30d3\u30a2\n *\n * \u300a\u8a2d\u5b9a\u4f8b\u300b\n * public $actsAs = array(\n *  'BcUpload' => array(\n *     'saveDir'  => \"editor\",\n *     'fields'  => array(\n *       'image'  => array(\n *         'type'      => 'image',\n *         'namefield'    => 'id',\n *         'nameadd'    => false,\n *            'subdirDateFormat'    => 'Y/m'    // Or false\n *         'imageresize'  => array('prefix' => 'template', 'width' => '100', 'height' => '100'),\n *                'imagecopy'        => array(\n *                    'thumb'            => array('suffix' => 'template', 'width' => '150', 'height' => '150'),\n *                    'thumb_mobile'    => array('suffix' => 'template', 'width' => '100', 'height' => '100')\n *                )\n *       ),\n *       'pdf' => array(\n *         'type'      => 'pdf',\n *         'namefield'    => 'id',\n *         'nameformat'  => '%d',\n *         'nameadd'    => false\n *       )\n *     )\n *   )\n * );\n *\n * @package Baser.Model.Behavior\n * @property BcFileUploader[] $BcFileUploader\n */\nclass BcUploadBehavior extends ModelBehavior\n{\n\n    /**\n     * BcFileUploader\n     * @var BcFileUploader[]\n     */\n    public $BcFileUploader = [];\n\n\t/**\n\t * oldEntity\n\t * @var array\n\t */\n\tpublic $oldEntity = [];\n\n\t/**\n\t * \u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u4e2d\u306e\u30ed\u30c3\u30af\n\t * @var bool\n\t */\n\tpublic $validatingLock = [];\n\n\t/**\n\t * \u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n\t *\n\t * @param Model $Model\n\t * @param array $settings actsAs\u306e\u8a2d\u5b9a\n\t */\n\tpublic function setup(Model $Model, $settings = [])\n\t{\n\t\t$this->BcFileUploader[$Model->alias] = new BcFileUploader();\n        $this->BcFileUploader[$Model->alias]->initialize($settings, $Model);\n\t\t$this->validatingLock[$Model->alias] = false;\n        // @deprecated \u5f8c\u65b9\u4e92\u63db since v4.5.6, v5.0.0 \u3067\u524a\u9664\u4e88\u5b9a\n        // CuApprover-4.3.2\u4ee5\u4e0b\u306b\u5bfe\u5fdc\u3059\u308b\u305f\u3081\u306e\u51e6\u7406\n        // >>>\n        $this->settings[$Model->alias] = $this->BcFileUploader[$Model->alias]->settings;\n        // <<<\n\n\t}\n\n\t/**\n\t * @param $modelName\n\t * @return BcFileUploader|false\n\t */\n\tpublic function getFileUploader(Model $model)\n\t{\n\t\treturn (isset($this->BcFileUploader[$model->alias]))? $this->BcFileUploader[$model->alias] : false;\n\t}\n\n\t/**\n\t * After Validate\n\t *\n\t * @param Model $Model\n\t * @param array $options\n\t * @return void\n\t */\n\tpublic function afterValidate(Model $Model, $options = [])\n\t{\n\t\tif ($Model->validationErrors) {\n\t\t\treturn;\n\t\t}\n\t\tif ($this->validatingLock[$Model->alias]) {\n\t\t\treturn;\n\t\t}\n\t\t$Model->data[$Model->alias] = $this->BcFileUploader[$Model->alias]->setupRequestData(isset($Model->data[$Model->alias])? $Model->data[$Model->alias] : $Model->data);\n\t\t$Model->data[$Model->alias] = $this->BcFileUploader[$Model->alias]->setupTmpData(isset($Model->data[$Model->alias])? $Model->data[$Model->alias] : $Model->data);\n\t\t$this->oldEntity[$Model->alias] = (!empty($Model->data[$Model->alias]['id']))? $this->getOldEntity($Model, $Model->data[$Model->alias]['id']) : [];\n\t\t$this->validatingLock[$Model->alias] = true;\n\n\t\t// @deprecated \u5f8c\u65b9\u4e92\u63db since v4.5.6, v5.0.0 \u3067\u524a\u9664\u4e88\u5b9a\n\t\t// CuApprover-4.3.2\u4ee5\u4e0b\u306b\u5bfe\u5fdc\u3059\u308b\u305f\u3081\u306e\u51e6\u7406\n\t\t// \u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u3092\u914d\u5217\u3067\u5b9f\u884c\u3055\u305b\u308b\u305f\u3081\u914d\u5217\u306b\u5909\u63db\n\t\t// >>>\n\t\t$files = $this->BcFileUploader[$Model->alias]->getUploadingFiles();\n\t\tforeach($files as $key => $file) {\n\t\t\t$this->settings[$Model->alias]['fields'][$key]['upload'] = (!empty($file['uploadable'])) ? true : false;\n\t\t\tif(!empty($file['uploadable'])) {\n\t\t\t\t$Model->data[$Model->alias][$key] = $file;\n\t\t\t\t// \u516c\u958b\u627f\u8a8d\u306e\u304a\u3051\u308b\u8349\u7a3f\u306e\u65b0\u898f\u6295\u7a3f\u5bfe\u5fdc\n\t\t\t\t$setting = $this->settings[$Model->alias]['fields'][$key];\n\t\t\t\t$Model->data[$Model->alias][$key] = $fileName = $this->BcFileUploader[$Model->alias]->saveFile($setting, $file);\n\t\t\t\tif (($setting['type'] == 'all' || $setting['type'] == 'image') && !empty($setting['imagecopy']) && in_array($file['ext'], $this->BcFileUploader[$Model->alias]->imgExts)) {\n\t\t\t\t\t$this->BcFileUploader[$Model->alias]->copyImages($setting, $file);\n\t\t\t\t\tif (!empty($setting['imageresize'])) {\n\t\t\t\t\t\t$filePath = $this->BcFileUploader[$Model->alias]->savePath . $fileName;\n\t\t\t\t\t\t$this->BcFileUploader[$Model->alias]->resizeImage($filePath, $filePath, $setting['imageresize']['width'], $setting['imageresize']['height'], $setting['imageresize']['thumb']);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t// <<<\n\t}\n\n\t/**\n\t * before save\n\t *\n\t * \u30d5\u30a1\u30a4\u30eb\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3057\u3066\u3044\u308b\u5834\u5408\u3001\u30c7\u30fc\u30bf\u304c\u914d\u5217\u306b\u306a\u3063\u3066\u3044\u308b\u305f\u3081\u3001\u6587\u5b57\u5217\u30c7\u30fc\u30bf\u306b\u5909\u63db\u3059\u308b\n\t * \u305f\u3060\u3057\u3001\u516c\u958b\u627f\u8a8d\u306e\u4e0b\u66f8\u304d\u30e2\u30fc\u30c9\u306e\u5834\u5408\u3001BlogPost\u5074\u306e\u30c7\u30fc\u30bf\u304c\u65b0\u3057\u3044\u30c7\u30fc\u30bf\u3067\u66f8\u304d\u63db\u308f\u3063\u3066\u3057\u307e\u3063\u3066\u306f\u554f\u984c\u3068\u306a\u308b\u305f\u3081\n\t * \u4fdd\u5b58\u3055\u305b\u306a\u3044\u3088\u3046\u306b\u3059\u308b\u305f\u3081\u51e6\u7406\u3092\u30b9\u30eb\u30fc\u3055\u305b\u308b\n\t * @param Model $Model\n\t * @param array $options\n\t * @return boolean\n\t * @deprecated \u5f8c\u65b9\u4e92\u63db since v4.5.6, v5.0.0 \u3067\u524a\u9664\u4e88\u5b9a\n\t * CuApprover-4.3.2\u4ee5\u4e0b\u306b\u5bfe\u5fdc\u3059\u308b\u305f\u3081\u306e\u51e6\u7406\n\t */\n\tpublic function beforeSave(Model $Model, $options = [])\n\t{\n\t\tif (isset($Model->data['CuApproverApplication']['contentsMode'])\n\t\t\t&& isset($Model->data['CuApproverApplication']['is_published'])) {\n\t\t\tif($Model->alias === 'BlogPost' &&\n\t\t\t\t$Model->data['CuApproverApplication']['contentsMode'] === 'draft' &&\n\t\t\t\t$Model->data['CuApproverApplication']['is_published']) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\t$files = $this->BcFileUploader[$Model->alias]->getUploadingFiles();\n\t\tforeach($files as $key => $file) {\n\t\t\tif(!empty($file['uploadable'])) {\n\t\t\t\tif(empty($Model->data['CuApproverApplication'])) {\n\t\t\t\t\t// Content \u306e\u516c\u958b\u627f\u8a8d\u306e\u4e0b\u66f8\u304d\u4fdd\u5b58\u6642\u3001BcContentsBehavior::afterSave() \u3067\u5225\u9014\u4fdd\u5b58\u51e6\u7406\u304c\u767a\u751f\u3059\u308b\u305f\u3081\u3001\n\t\t\t\t\t// \u305d\u306e\u969b\u3001eyecatch \u306e\u914d\u5217\u3067\u304f\u308b\u304c\u4fdd\u5b58\u3055\u305b\u306a\u3044\u3088\u3046\u306b unset \u3059\u308b\n\t\t\t\t\tunset($Model->data[$Model->alias][$key]);\n\t\t\t\t} else {\n\t\t\t\t\t$Model->data[$Model->alias][$key] = $file['name'];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n\n\t/**\n\t * After save\n\t *\n\t * @param Model $Model\n\t * @param array $options\n\t * @return boolean\n\t */\n\tpublic function afterSave(Model $Model, $created, $options = [])\n\t{\n\t\t// @deprecated \u5f8c\u65b9\u4e92\u63db since v4.5.6, v5.0.0 \u3067\u524a\u9664\u4e88\u5b9a\n\t\t// CuApprover-4.3.2\u4ee5\u4e0b\u306b\u5bfe\u5fdc\u3059\u308b\u305f\u3081\u306e\u51e6\u7406\n\t\t// >>>\n\t\tif(!empty($this->settings[$Model->alias]['fields'])) {\n\t\t\t$files = $this->BcFileUploader[$Model->alias]->getUploadingFiles();\n\t\t\tforeach($this->settings[$Model->alias]['fields'] as $key => $field) {\n\t\t\t\t$files[$key]['uploadable'] = (!empty($field['upload']))? true : false;\n\t\t\t}\n\t\t\t$this->BcFileUploader[$Model->alias]->setUploadingFiles($files);\n\t\t}\n\t\t// <<<\n\n\t\t$data = isset($Model->data[$Model->alias])? $Model->data[$Model->alias] : $Model->data;\n        if ($Model->exists() && isset($this->oldEntity[$Model->alias])) {\n            $this->BcFileUploader[$Model->alias]->deleteExistingFiles($this->oldEntity[$Model->alias]);\n        }\n        $entity = $this->BcFileUploader[$Model->alias]->saveFiles($data);\n\n\t\t// @deprecated \u5f8c\u65b9\u4e92\u63db since v4.5.6, v5.0.0 \u3067\u524a\u9664\u4e88\u5b9a\n\t\t// CuApprover-4.3.2\u4ee5\u4e0b\u306b\u5bfe\u5fdc\u3059\u308b\u305f\u3081\u306e\u51e6\u7406\n\t\t// >>>\n\t\t$this->uploaded[$Model->alias] = $this->BcFileUploader[$Model->alias]->uploaded;\n\t\t// <<<\n\n        if ($Model->exists() && isset($this->oldEntity[$Model->alias])) {\n            $entity = $this->BcFileUploader[$Model->alias]->deleteFiles($this->oldEntity[$Model->alias], $entity);\n        }\n        if ($this->BcFileUploader[$Model->alias]->isUploaded()) {\n            $entity = $this->BcFileUploader[$Model->alias]->renameToBasenameFields($entity);\n            $this->BcFileUploader[$Model->alias]->resetUploaded();\n\n            // @deprecated \u5f8c\u65b9\u4e92\u63db since v4.5.6, v5.0.0 \u3067\u524a\u9664\u4e88\u5b9a\n            // CuApprover-4.3.2\u4ee5\u4e0b\u306b\u5bfe\u5fdc\u3059\u308b\u305f\u3081\u306e\u51e6\u7406\n            // >>>\n            $this->uploaded[$Model->alias] = false;\n            // <<<\n\n        }\n        $Model->data = $Model->save($entity, ['validate' => false, 'callbacks' => false]);\n\n\t\t// @deprecated \u5f8c\u65b9\u4e92\u63db since v4.5.6, v5.0.0 \u3067\u524a\u9664\n\t\t// CuApprover-4.3.2\u4ee5\u4e0b\u306b\u5bfe\u5fdc\u3059\u308b\u305f\u3081\u306e\u51e6\u7406\n\t\t// \u516c\u958b\u627f\u8a8d\u306e\u304a\u3051\u308b\u8349\u7a3f\u306e\u65b0\u898f\u6295\u7a3f\u5bfe\u5fdc\n\t\t// afterValidate \u3067\u7121\u7406\u3084\u308a\u751f\u6210\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u3092\u524a\u9664\u3059\u308b\n\t\t// >>>\n\t\tif(!empty($files)) {\n\t\t\tforeach($files as $key => $file) {\n\t\t\t\tif(!empty($file['name'])) {\n\t\t\t\t\t$setting = $this->settings[$Model->alias]['fields'][$key];\n\t\t\t\t\t$this->BcFileUploader[$Model->alias]->deleteFile($setting, $file['name']);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t// <<<\n        return true;\n\t}\n\n\t/**\n\t * Before delete\n\t * \u753b\u50cf\u30d5\u30a1\u30a4\u30eb\u306e\u524a\u9664\u3092\u884c\u3046\n\t * \u524a\u9664\u306b\u5931\u6557\u3057\u3066\u3082\u30c7\u30fc\u30bf\u306e\u524a\u9664\u306f\u884c\u3046\n\t *\n\t * @param Model $Model\n\t * @param bool $cascade\n\t * @return bool\n\t */\n\tpublic function beforeDelete(Model $Model, $cascade = true)\n\t{\n\t\t$oldEntity = $this->getOldEntity($Model, $Model->id);\n\t\t$this->BcFileUploader[$Model->alias]->deleteFiles($oldEntity, [], true);\n\t\treturn true;\n\t}\n\n\t/**\n\t * \u4e00\u6642\u30d5\u30a1\u30a4\u30eb\u3068\u3057\u3066\u4fdd\u5b58\u3059\u308b\n\t *\n\t * @param Model $Model\n\t * @param array $data\n\t * @param string $tmpId\n\t * @return mixed false|array\n\t */\n\tpublic function saveTmpFiles(Model $Model, $data, $tmpId)\n\t{\n\t\tif(isset($data[$Model->alias])) {\n\t\t\t$entity = $data[$Model->alias];\n\t\t} else {\n\t\t\t$entity = $data;\n\t\t\t$data = [];\n\t\t}\n\t\t$data[$Model->alias] = $this->BcFileUploader[$Model->alias]->saveTmpFiles($entity, $tmpId);\n\t\treturn $data;\n\t}\n\n    /**\n     * \u8a2d\u5b9a\u60c5\u5831\u3092\u53d6\u5f97\n     * @param $alias\n     * @return mixed\n     * @checked\n     * @noTodo\n     * @unitTest\n     */\n    public function getSettings(Model $Model)\n    {\n        return $this->BcFileUploader[$Model->alias]->settings;\n    }\n\n    /**\n     * \u8a2d\u5b9a\u60c5\u5831\u3092\u8a2d\u5b9a\n     * @param $alias\n     * @param $settings\n     * @checked\n     * @noTodo\n     * @unitTest\n     */\n    public function setSettings(Model $Model, $settings)\n    {\n        $this->BcFileUploader[$Model->alias]->settings = $settings;\n    }\n\n    /**\n     * \u4fdd\u5b58\u5148\u306e\u30d1\u30b9\u3092\u53d6\u5f97\n     * @param $alias\n     * @param false $isTheme\n     * @param false $limited\n     * @return string\n     */\n    public function getSaveDir(Model $Model, $isTheme = false, $limited = false)\n    {\n        return $this->BcFileUploader[$Model->alias]->getSaveDir($isTheme, $limited);\n    }\n\n\t/**\n\t * saveFiles\n\t * @param Model $Model\n\t * @param $entity\n\t * @return mixed\n\t * @deprecated \u5f8c\u65b9\u4e92\u63db since v4.5.6, v5.0.0 \u3067\u524a\u9664\u4e88\u5b9a\n\t */\n    public function saveFiles(Model $Model, $entity)\n\t{\n\t\t$entity[$Model->alias] = $this->BcFileUploader[$Model->alias]->saveFiles($entity[$Model->alias]);\n\t\treturn $entity;\n\t}\n\n\t/**\n\t * saveFiles\n\t * @param Model $Model\n\t * @param $entity\n\t * @return mixed\n\t * @deprecated \u5f8c\u65b9\u4e92\u63db since v4.5.6, v5.0.0 \u3067\u524a\u9664\u4e88\u5b9a\n\t */\n    public function deleteFiles(Model $Model, $newEntity)\n    {\n\t\t$entity[$Model->alias] = $this->BcFileUploader[$Model->alias]->deleteFiles([], $newEntity);\n\t\treturn $entity;\n    }\n\n\t/**\n\t * setupRequestData\n\t * @param Model $Model\n\t * @deprecated \u5f8c\u65b9\u4e92\u63db since v4.5.6, v5.0.0 \u3067\u524a\u9664\u4e88\u5b9a\n\t * CuApprover-4.3.2\u4ee5\u4e0b\u306b\u5bfe\u5fdc\u3059\u308b\u305f\u3081\u306e\u51e6\u7406\n\t */\n\tpublic function setupRequestData(Model $Model)\n\t{\n\t\t// CuApproverApplication.php 261\u884c\u76ee\u3042\u305f\u308a\u3001$this->setupRequestData()\u3000\u3067\u3001\n\t\t// BlogPost\u3001Content \u30e2\u30c7\u30eb\u306e\u524a\u9664\u306e\u969b\u306e\u524a\u9664\u30d5\u30e9\u30b0\u304c\u521d\u671f\u5316\u3055\u308c\u3066\u3057\u307e\u3046\u305f\u3081 return \u3067\u5b9f\u884c\u3057\u306a\u3044\n\t\t// \u521d\u671f\u5316\u3055\u308c\u306a\u304b\u3063\u305f\u30c7\u30fc\u30bf\u306f deleteFileWhileChecking \u306b\u3066\u5229\u7528\u3059\u308b\n\t\t// \u3082\u3068\u3082\u3068\u4e0a\u8a18\u306e\u51e6\u7406\u306f\u3001Content \u3084 Content \u306e\u30d3\u30d8\u30a4\u30d3\u30a2\u8a2d\u5b9a\u3092\n\t\t// CuApproverApplication \u30e2\u30c7\u30eb\u306b\u5f15\u304d\u7d99\u304c\u305b\u308b\u305f\u3081\u306e\u51e6\u7406\u3060\u3063\u305f\u304c\u4e0d\u8981\u3060\u3063\u305f\u3053\u3068\u304c\u308f\u304b\u3063\u305f\u3002\n\t\tif($Model->alias === 'BlogPost' || $Model->alias === 'Content') return;\n\t\t$Model->data[$Model->alias] = $this->BcFileUploader[$Model->alias]->setupRequestData(isset($Model->data[$Model->alias])? $Model->data[$Model->alias] : $Model->data);\n\t\t// CuApprover \u30d7\u30e9\u30b0\u30a4\u30f3\u306b\u3066\u3001CuApproverApplicationBehavior.php 65\u884c\u76ee\u3042\u305f\u308a $model->CuApproverApplication->validates() \u3067\u3001\n\t\t// BcFileUploader->uploadingFiles \u304c\u521d\u671f\u5316\u3055\u308c\u3066\u3057\u307e\u3046\u305f\u3081\u9000\u907f\n        $this->files[$Model->alias] = $this->BcFileUploader[$Model->alias]->getUploadingFiles();\n\t}\n\n\t/**\n\t * delFile\n\t * @param Model $Model\n\t * @deprecated \u5f8c\u65b9\u4e92\u63db since v4.5.6, v5.0.0 \u3067\u524a\u9664\u4e88\u5b9a\n\t * CuApprover-4.3.2\u4ee5\u4e0b\u306b\u5bfe\u5fdc\u3059\u308b\u305f\u3081\u306e\u51e6\u7406\n\t */\n\tpublic function delFile(Model $Model, $fileName, $setting)\n\t{\n\t\t$this->BcFileUploader[$Model->alias]->deleteFile($setting, $fileName);\n\t}\n\n\t/**\n\t * deleteFileWhileChecking\n\t * @param Model $Model\n\t * @deprecated \u5f8c\u65b9\u4e92\u63db since v4.5.6, v5.0.0 \u3067\u524a\u9664\u4e88\u5b9a\n\t * CuApprover-4.3.2\u4ee5\u4e0b\u306b\u5bfe\u5fdc\u3059\u308b\u305f\u3081\u306e\u51e6\u7406\n\t */\n\tpublic function deleteFileWhileChecking(Model $Model, $setting, $requestData, $oldValue)\n\t{\n\t\tif($Model->alias === 'CuApproverApplication') {\n\t\t\t// \u516c\u958b\u627f\u8a8d\u306e\u4e0b\u66f8\u304d\u306e\u30d5\u30a1\u30a4\u30eb\u524a\u9664\u306e\u5834\u5408\u3001\u524a\u9664\u30d5\u30e9\u30b0\u304c\u30ea\u30bb\u30c3\u30c8\u3055\u308c\u305f\u30c7\u30fc\u30bf\u3092\u5229\u7528\u3057\u3066\u3044\u308b\u305f\u3081\u3001\n\t\t\t// \u5143\u30c7\u30fc\u30bf\u306e files \u3092\u5229\u7528\u3059\u308b\n\t\t\tif(!empty($requestData['CuApproverApplication']['blog_content_id'])) {\n\t\t\t\t$files = $this->BcFileUploader['BlogPost']->getUploadingFiles();\n\t\t\t} else {\n\t\t\t\t$files = $this->BcFileUploader['Content']->getUploadingFiles();\n\t\t\t}\n\t\t} else {\n\t\t\t$files = $this->BcFileUploader[$Model->alias]->getUploadingFiles();\n\t\t}\n\t\tif(!$files && !empty($this->files[$Model->alias])) {\n\t\t\t$files = $this->files[$Model->alias];\n\t\t}\n\t\tif(isset($files[$setting['name']])) {\n\t\t\t$file = $files[$setting['name']];\n\t\t} else {\n\t\t\t$file = [];\n\t\t}\n\t\treturn [\n\t\t\t$Model->alias => $this->BcFileUploader[$Model->alias]->deleteFileWhileChecking($setting, $file, $requestData[$Model->alias], [$setting['name'] => $oldValue])\n\t\t];\n\t}\n\n\t/**\n\t * renameToBasenameField\n\t * @param Model $Model\n\t * @deprecated \u5f8c\u65b9\u4e92\u63db since v4.5.6, v5.0.0 \u3067\u524a\u9664\u4e88\u5b9a\n\t * CuApprover-4.3.2\u4ee5\u4e0b\u306b\u5bfe\u5fdc\u3059\u308b\u305f\u3081\u306e\u51e6\u7406\n\t */\n\tpublic function renameToBasenameField(Model $Model, $setting)\n\t{\n\t\t$files = $this->BcFileUploader[$Model->alias]->getUploadingFiles();\n\t\tif(!$files && !empty($this->files[$Model->alias])) {\n\t\t\t$files = $this->files[$Model->alias];\n\t\t}\n\t\tif(isset($files[$setting['name']])) {\n\t\t\t$file = $files[$setting['name']];\n\t\t\tif(!empty($file['name'])) {\n\t\t\t\treturn $this->BcFileUploader[$Model->alias]->renameToBasenameField($setting, $file, $Model->data[$Model->alias]);\n\t\t\t}\n\t\t}\n\t\treturn $Model->data[$Model->alias][$setting['name']];\n\t}\n\n\t/**\n\t * saveFileWhileChecking\n\t * @param Model $Model\n\t * @deprecated \u5f8c\u65b9\u4e92\u63db since v4.5.6, v5.0.0 \u3067\u524a\u9664\u4e88\u5b9a\n\t * CuApprover-4.3.2\u4ee5\u4e0b\u306b\u5bfe\u5fdc\u3059\u308b\u305f\u3081\u306e\u51e6\u7406\n\t */\n\tpublic function saveFileWhileChecking(Model $Model, $setting, $data, $options)\n\t{\n\t\t$file = $this->BcFileUploader[$Model->alias]->saveFileWhileChecking($setting, $this->BcFileUploader[$Model->alias]->getUploadingFiles()[$setting['name']], $data[$Model->alias], $options);\n\t\tif($file) {\n\t\t\t$files = $this->BcFileUploader[$Model->alias]->getUploadingFiles();\n\t\t\t$files[$setting['name']] = $file;\n\t\t\t$this->BcFileUploader[$Model->alias]->setUploadingFiles($files);\n\t\t\t$data[$Model->alias][$setting['name']] = $file['name'];\n\t\t}\n\t\t$this->uploaded[$Model->alias] = $this->BcFileUploader[$Model->alias]->uploaded;\n\t\treturn $data;\n\t}\n\n\t/**\n\t * getFieldBasename\n\t * @param Model $Model\n\t * @deprecated \u5f8c\u65b9\u4e92\u63db since v4.5.6, v5.0.0 \u3067\u524a\u9664\u4e88\u5b9a\n\t * CuApprover-4.3.2\u4ee5\u4e0b\u306b\u5bfe\u5fdc\u3059\u308b\u305f\u3081\u306e\u51e6\u7406\n\t */\n\tpublic function getFieldBasename(Model $Model, $setting, $ext)\n\t{\n\t\t$files = $this->BcFileUploader[$Model->alias]->getUploadingFiles();\n\t\tif(!$files && !empty($this->files[$Model->alias])) {\n\t\t\t$files = $this->files[$Model->alias];\n\t\t}\n\t\tif(isset($files[$setting['name']])) {\n\t\t\t$file = $files[$setting['name']];\n\t\t\tif(empty($file['ext'])) {\n\t\t\t\t$file = ['ext' => $ext];\n\t\t\t}\n\t\t\treturn $this->BcFileUploader[$Model->alias]->getFieldBasename($setting, $file, $Model->data[$Model->alias]);\n\t\t}\n\t\treturn false;\n\t}\n\n\t/**\n\t * getFileName\n\t * @param Model $Model\n\t * @deprecated \u5f8c\u65b9\u4e92\u63db since v4.5.6, v5.0.0 \u3067\u524a\u9664\u4e88\u5b9a\n\t * CuApprover-4.3.2\u4ee5\u4e0b\u306b\u5bfe\u5fdc\u3059\u308b\u305f\u3081\u306e\u51e6\u7406\n\t */\n\tpublic function getFileName(Model $Model , $setting, $name)\n\t{\n\t\treturn $this->BcFileUploader[$Model->alias]->getFileName($setting, $name);\n\t}\n\n\t/**\n\t * getOldEntity\n\t * @param Model $model\n\t * @param int $id\n\t * @return array|int|null\n\t */\n\tpublic function getOldEntity(Model $model, $id)\n\t{\n\t\tif($model instanceof Content) {\n\t\t\t$softDelete = $model->softDelete(null);\n\t\t\t$model->softDelete(false);\n\t\t}\n\t\t$oldEntity = $model->find('first', [\n\t\t\t'conditions' => [$model->alias . '.id' => $id],\n\t\t\t'recursive' => -1\n\t\t]);\n\t\tif($model instanceof Content) {\n\t\t\t$model->softDelete($softDelete);\n\t\t}\n\t\treturn ($oldEntity)? $oldEntity[$model->alias] : [];\n\t}\n\n\t/**\n\t * renameToBasenameFields\n\t * @param Model $Model\n\t */\n\tpublic function renameToBasenameFields(Model $model, $copy = false)\n\t{\n\t\t$model->data[$model->alias] = $this->BcFileUploader[$model->alias]->renameToBasenameFields($model->data[$model->alias], $copy);\n\t\treturn $model->data;\n\t}\n\n}\n"], "filenames": ["lib/Baser/Model/Behavior/BcUploadBehavior.php"], "buggy_code_start_loc": [104], "buggy_code_end_loc": [138], "fixing_code_start_loc": [104], "fixing_code_end_loc": [140], "type": "CWE-434", "message": "baserCMS is a Content Management system. Prior to version 4.7.5, any file may be uploaded on the management system of baserCMS. Version 4.7.5 contains a patch.", "other": {"cve": {"id": "CVE-2023-25655", "sourceIdentifier": "security-advisories@github.com", "published": "2023-03-23T20:15:15.067", "lastModified": "2023-03-28T15:02:27.250", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "baserCMS is a Content Management system. Prior to version 4.7.5, any file may be uploaded on the management system of baserCMS. Version 4.7.5 contains a patch."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 9.8, "baseSeverity": "CRITICAL"}, "exploitabilityScore": 3.9, "impactScore": 5.9}, {"source": "security-advisories@github.com", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 9.8, "baseSeverity": "CRITICAL"}, "exploitabilityScore": 3.9, "impactScore": 5.9}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-434"}]}, {"source": "security-advisories@github.com", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-434"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:basercms:basercms:*:*:*:*:*:*:*:*", "versionEndExcluding": "4.7.5", "matchCriteriaId": "8E320A5C-F148-4B1C-A910-EE042EBD72E7"}]}]}], "references": [{"url": "https://github.com/baserproject/basercms/commit/922025a98b0e697ab78f6a785a004e0729aa9100", "source": "security-advisories@github.com", "tags": ["Patch"]}, {"url": "https://github.com/baserproject/basercms/commit/9297629983ed908c7f51bf61a0231dde91404ebd", "source": "security-advisories@github.com", "tags": ["Patch"]}, {"url": "https://github.com/baserproject/basercms/releases/tag/basercms-4.7.5", "source": "security-advisories@github.com", "tags": ["Release Notes"]}, {"url": "https://github.com/baserproject/basercms/security/advisories/GHSA-mfvg-qwcw-qvc8", "source": "security-advisories@github.com", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/baserproject/basercms/commit/922025a98b0e697ab78f6a785a004e0729aa9100"}}