{"buggy_code": ["<?php\n\n/*\n * W2\n *\n * Copyright (C) 2007-2011 Steven Frank <http://stevenf.com/>\n *\n * Code may be re-used as long as the above copyright notice is retained.\n * See README.txt for full details.\n *\n * Written with Coda: <http://panic.com/coda/>\n *\n */\n \n// Install PSR-4-compatible class autoloader\nspl_autoload_register(function($class){\n\trequire str_replace('\\\\', DIRECTORY_SEPARATOR, ltrim($class, '\\\\')).'.php';\n});\n\n\n// Get Markdown class\nuse Michelf\\MarkdownExtra;\n\n\n// User configurable options:\n\ninclude_once \"config.php\";\n\nini_set('session.gc_maxlifetime', W2_SESSION_LIFETIME);\n\nsession_set_cookie_params(W2_SESSION_LIFETIME);\nsession_name(W2_SESSION_NAME);\nsession_start();\n\nif ( count($allowedIPs) > 0 )\n{\n\t$ip = $_SERVER['REMOTE_ADDR'];\n\t$accepted = false;\n\t\n\tforeach ( $allowedIPs as $allowed )\n\t{\n\t\tif ( strncmp($allowed, $ip, strlen($allowed)) == 0 )\n\t\t{\n\t\t\t$accepted = true;\n\t\t\tbreak;\n\t\t}\n\t}\n\t\n\tif ( !$accepted )\n\t{\n\t\tprint \"<html><body>Access from IP address $ip is not allowed\";\n\t\tprint \"</body></html>\";\n\t\texit;\n\t}\n}\n\nif ( REQUIRE_PASSWORD && !isset($_SESSION['password']) )\n{\n\tif ( !defined('W2_PASSWORD_HASH') || W2_PASSWORD_HASH == '' )\n\t\tdefine('W2_PASSWORD_HASH', sha1(W2_PASSWORD));\n\t\n\tif ( (isset($_POST['p'])) && (sha1($_POST['p']) == W2_PASSWORD_HASH) )\n\t\t$_SESSION['password'] = W2_PASSWORD_HASH;\n\telse\n\t{\n\t\tprint \"<!DOCTYPE html PUBLIC \\\"-//W3C//DTD XHTML 1.0 Strict//EN\\\" \\\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd\\\">\\n\";\n\t\tprint \"<html>\\n\";\n\t\tprint \"<head>\\n\";\n\t\tprint \"<link rel=\\\"apple-touch-icon\\\" href=\\\"apple-touch-icon.png\\\"/>\";\n\t\tprint \"<meta name=\\\"viewport\\\" content=\\\"width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=false\\\" />\\n\";\n\t\t\n\t\tprint \"<link type=\\\"text/css\\\" rel=\\\"stylesheet\\\" href=\\\"\" . BASE_URI . \"/\" . CSS_FILE .\"\\\" />\\n\";\n\t\tprint \"<title>Log In</title>\\n\";\n\t\tprint \"</head>\\n\";\n\t\tprint \"<body><form method=\\\"post\\\">\";\n\t\tprint \"<input type=\\\"password\\\" name=\\\"p\\\">\\n\";\n\t\tprint \"<input type=\\\"submit\\\" value=\\\"Go\\\"></form>\";\n\t\tprint \"</body></html>\";\n\t\texit;\n\t}\n}\n\n// Support functions\n\nfunction printToolbar()\n{\n\tglobal $upage, $page, $action;\n\n\tprint \"<div class=\\\"toolbar\\\">\";\n\tprint \"<a class=\\\"tool first\\\" href=\\\"\" . SELF . \"?action=edit&amp;page=$upage\\\">Edit</a> \";\n\tprint \"<a class=\\\"tool\\\" href=\\\"\" . SELF . \"?action=new\\\">New</a> \";\n\n\tif ( !DISABLE_UPLOADS )\n\t\tprint \"<a class=\\\"tool\\\" href=\\\"\" . SELF . VIEW . \"?action=upload\\\">Upload</a> \";\n\n \tprint \"<a class=\\\"tool\\\" href=\\\"\" . SELF . \"?action=all_name\\\">All</a> \";\n\tprint \"<a class=\\\"tool\\\" href=\\\"\" . SELF . \"?action=all_date\\\">Recent</a> \";\n \tprint \"<a class=\\\"tool\\\" href=\\\"\" . SELF . \"\\\">\". DEFAULT_PAGE . \"</a>\";\n \t\n\tif ( REQUIRE_PASSWORD )\n\t\tprint '<a class=\"tool\" href=\"' . SELF . '?action=logout\">Exit</a>';\n\n\tprint \"<form method=\\\"post\\\" action=\\\"\" . SELF . \"?action=search\\\">\\n\";\n\tprint \"<input class=\\\"tool\\\" placeholder=\\\"Search\\\" size=\\\"6\\\" id=\\\"search\\\" type=\\\"text\\\" name=\\\"q\\\" /></form>\\n\";\n\t\t\n\tprint \"</div>\\n\";\n}\n\n\nfunction descLengthSort($val_1, $val_2) \n{ \n\t$retVal = 0;\n\n\t$firstVal = strlen($val_1); \n\t$secondVal = strlen($val_2);\n\n\tif ( $firstVal > $secondVal ) \n\t\t$retVal = -1; \n\t\n\telse if ( $firstVal < $secondVal ) \n\t\t$retVal = 1; \n\n\treturn $retVal; \n}\n\n\nfunction toHTML($inText)\n{\n\tglobal $page;\n\t\n\t$dir = opendir(PAGES_PATH);\n\twhile ( $filename = readdir($dir) )\n\t{\n\t\tif ( $filename{0} == '.' )\n\t\t\tcontinue;\n\t\t\t\n\t\t$filename = preg_replace(\"/(.*?)\\.txt/\", \"\\\\1\", $filename);\n\t\t$filenames[] = $filename;\n\t}\n\tclosedir($dir);\n\t\n\tuasort($filenames, \"descLengthSort\"); \n\n\tif ( AUTOLINK_PAGE_TITLES )\n\t{\t\n\t\tforeach ( $filenames as $filename )\n\t\t{\n\t \t\t$inText = preg_replace(\"/(?<![\\>\\[\\/])($filename)(?!\\]\\>)/im\", \"<a href=\\\"\" . SELF . VIEW . \"/$filename\\\">\\\\1</a>\", $inText);\n\t\t}\n\t}\n\t\n \t$inText = preg_replace(\"/\\[\\[(.*?)\\]\\]/\", \"<a href=\\\"\" . SELF . VIEW . \"/\\\\1\\\">\\\\1</a>\", $inText);\n\t$inText = preg_replace(\"/\\{\\{(.*?)\\}\\}/\", \"<img src=\\\"\" . BASE_URI . \"/images/\\\\1\\\" alt=\\\"\\\\1\\\" />\", $inText);\n\t$inText = preg_replace(\"/message:(.*?)\\s/\", \"[<a href=\\\"message:\\\\1\\\">email</a>]\", $inText);\n\n\t$html = MarkdownExtra::defaultTransform($inText);\n\t$inText = htmlentities($inText);\n\n\treturn $html;\n}\n\nfunction sanitizeFilename($inFileName)\n{\n\treturn str_replace(array('..', '~', '/', '\\\\', ':'), '-', $inFileName);\n}\n\nfunction destroy_session()\n{\n\tif ( isset($_COOKIE[session_name()]) )\n\t\tsetcookie(session_name(), '', time() - 42000, '/');\n\n\tsession_destroy();\n\tunset($_SESSION[\"password\"]);\n\tunset($_SESSION);\n}\n\n// Support PHP4 by defining file_put_contents if it doesn't already exist\n\nif ( !function_exists('file_put_contents') )\n{\n    function file_put_contents($n, $d)\n    {\n\t\t$f = @fopen($n, \"w\");\n\t\t\n\t\tif ( !$f )\n\t\t{\n\t\t\treturn false;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tfwrite($f, $d);\n\t\t\tfclose($f);\n\t\t\treturn true;\n\t\t}\n    }\n}\n\n// Main code\n\nif ( isset($_REQUEST['action']) )\n\t$action = $_REQUEST['action'];\nelse \n\t$action = 'view';\n\n// Look for page name following the script name in the URL, like this:\n// http://stevenf.com/w2demo/index.php/Markdown%20Syntax\n//\n// Otherwise, get page name from 'page' request variable.\n\nif ( preg_match('@^/@', @$_SERVER[\"PATH_INFO\"]) ) \n\t$page = sanitizeFilename(substr($_SERVER[\"PATH_INFO\"], 1));\nelse \n\t$page = sanitizeFilename(@$_REQUEST['page']);\n\n$upage = urlencode($page);\n\nif ( $page == \"\" )\n\t$page = DEFAULT_PAGE;\n\n$filename = PAGES_PATH . \"/$page.txt\";\n\nif ( file_exists($filename) )\n{\n\t$text = file_get_contents($filename);\n}\nelse\n{\n\tif ( $action != \"save\" && $action != \"all_name\" && $action != \"all_date\" && $action != \"upload\" && $action != \"new\" && $action != \"logout\" && $action != \"uploaded\" && $action != \"search\" && $action != \"view\" )\n\t{\n\t\t$action = \"edit\";\n\t}\n}\n\nif ( $action == \"edit\" || $action == \"new\" )\n{\n\t$formAction = SELF . (($action == 'edit') ? \"/$page\" : \"\");\n\t$html = \"<form id=\\\"edit\\\" method=\\\"post\\\" action=\\\"$formAction\\\">\\n\";\n\n\tif ( $action == \"edit\" )\n\t\t$html .= \"<input type=\\\"hidden\\\" name=\\\"page\\\" value=\\\"$page\\\" />\\n\";\n\telse\n\t\t$html .= \"<p>Title: <input id=\\\"title\\\" type=\\\"text\\\" name=\\\"page\\\" /></p>\\n\";\n\n\tif ( $action == \"new\" )\n\t\t$text = \"\";\n\n\t$html .= \"<p><textarea id=\\\"text\\\" name=\\\"newText\\\" rows=\\\"\" . EDIT_ROWS . \"\\\">$text</textarea></p>\\n\";\n\t$html .= \"<p><input type=\\\"hidden\\\" name=\\\"action\\\" value=\\\"save\\\" />\";\n\t$html .= \"<input id=\\\"save\\\" type=\\\"submit\\\" value=\\\"Save\\\" />\\n\";\n\t$html .= \"<input id=\\\"cancel\\\" type=\\\"button\\\" onclick=\\\"history.go(-1);\\\" value=\\\"Cancel\\\" /></p>\\n\";\n\t$html .= \"</form>\\n\";\n}\nelse if ( $action == \"logout\" )\n{\n\tdestroy_session();\n\theader(\"Location: \" . SELF);\n\texit;\n}\nelse if ( $action == \"upload\" )\n{\n\tif ( DISABLE_UPLOADS )\n\t{\n\t\t$html = \"<p>Image uploading has been disabled on this installation.</p>\";\n\t}\n\telse\n\t{\n\t\t$html = \"<form id=\\\"upload\\\" method=\\\"post\\\" action=\\\"\" . SELF . \"\\\" enctype=\\\"multipart/form-data\\\"><p>\\n\";\n\t\t$html .= \"<input type=\\\"hidden\\\" name=\\\"action\\\" value=\\\"uploaded\\\" />\";\n\t\t$html .= \"<input id=\\\"file\\\" type=\\\"file\\\" name=\\\"userfile\\\" />\\n\";\n\t\t$html .= \"<input id=\\\"upload\\\" type=\\\"submit\\\" value=\\\"Upload\\\" />\\n\";\n\t\t$html .= \"<input id=\\\"cancel\\\" type=\\\"button\\\" onclick=\\\"history.go(-1);\\\" value=\\\"Cancel\\\" />\\n\";\n\t\t$html .= \"</p></form>\\n\";\n\t}\n}\nelse if ( $action == \"uploaded\" )\n{\n\tif ( !DISABLE_UPLOADS )\n\t{\n\t\t$dstName = sanitizeFilename($_FILES['userfile']['name']);\n\t\t$fileType = $_FILES['userfile']['type'];\n\t\tpreg_match('/\\.([^.]+)$/', $dstName, $matches);\n\t\t$fileExt = isset($matches[1]) ? $matches[1] : null;\n\t\t\n\t\tif (in_array($fileType, explode(',', VALID_UPLOAD_TYPES)) &&\n\t\t\tin_array($fileExt, explode(',', VALID_UPLOAD_EXTS)))\n\t\t{\n\t\t\t$errLevel = error_reporting(0);\n\n\t\t\tif ( move_uploaded_file($_FILES['userfile']['tmp_name'], \n\t\t\t\tBASE_PATH . \"/images/$dstName\") === true ) \n\t\t\t{\n\t\t\t\t$html = \"<p class=\\\"note\\\">File '$dstName' uploaded</p>\\n\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$html = \"<p class=\\\"note\\\">Upload error</p>\\n\";\n\t\t\t}\n\n\t\t\terror_reporting($errLevel);\n\t\t} else {\n\t\t\t$html = \"<p class=\\\"note\\\">Upload error: invalid file type</p>\\n\";\n\t\t}\n\t}\n\n\t$html .= toHTML($text);\n}\nelse if ( $action == \"save\" )\n{\n\t$newText = $_REQUEST['newText'];\n\n\t$errLevel = error_reporting(0);\n\t$success = file_put_contents($filename, $newText);\n \terror_reporting($errLevel);\n\n\tif ( $success )\t\n\t\t$html = \"<p class=\\\"note\\\">Saved</p>\\n\";\n\telse\n\t\t$html = \"<p class=\\\"note\\\">Error saving changes! Make sure your web server has write access to \" . PAGES_PATH . \"</p>\\n\";\n\n\t$html .= toHTML($newText);\n}\n/*\nelse if ( $action == \"rename\" )\n{\n\t$html = \"<form id=\\\"rename\\\" method=\\\"post\\\" action=\\\"\" . SELF . \"\\\">\";\n\t$html .= \"<p>Title: <input id=\\\"title\\\" type=\\\"text\\\" name=\\\"page\\\" value=\\\"\" . htmlspecialchars($page) . \"\\\" />\";\n\t$html .= \"<input id=\\\"rename\\\" type=\\\"submit\\\" value=\\\"Rename\\\">\";\n\t$html .= \"<input id=\\\"cancel\\\" type=\\\"button\\\" onclick=\\\"history.go(-1);\\\" value=\\\"Cancel\\\" />\\n\";\n\t$html .= \"<input type=\\\"hidden\\\" name=\\\"action\\\" value=\\\"renamed\\\" />\";\n\t$html .= \"<input type=\\\"hidden\\\" name=\\\"prevpage\\\" value=\\\"\" . htmlspecialchars($page) . \"\\\" />\";\n\t$html .= \"</p></form>\";\n}\nelse if ( $action == \"renamed\" )\n{\n\t$pp = $_REQUEST['prevpage'];\n\t$pg = $_REQUEST['page'];\n\n\t$prevpage = sanitizeFilename($pp);\n\t$prevpage = urlencode($prevpage);\n\t\n\t$prevfilename = PAGES_PATH . \"/$prevpage.txt\";\n\n\tif ( rename($prevfilename, $filename) )\n\t{\n\t\t// Success.  Change links in all pages to point to new page\n\t\tif ( $dh = opendir(PAGES_PATH) )\n\t\t{\n\t\t\twhile ( ($file = readdir($dh)) !== false )\n\t\t\t{\n\t\t\t\t$content = file_get_contents($file);\n\t\t\t\t$pattern = \"/\\[\\[\" . $pp . \"\\]\\]/g\";\n\t\t\t\tpreg_replace($pattern, \"[[$pg]]\", $content);\n\t\t\t\tfile_put_contents($file, $content);\n\t\t\t}\n\t\t}\n\t}\n\telse\n\t{\n\t\t$html = \"<p class=\\\"note\\\">Error renaming file</p>\\n\";\n\t}\n}\n*/\nelse if ( $action == \"all_name\" )\n{\n\t$dir = opendir(PAGES_PATH);\n\t$filelist = array();\n\n\t$color = \"#ffffff\";\n\n\twhile ( $file = readdir($dir) )\n\t{\n\t\tif ( $file{0} == \".\" )\n\t\t\tcontinue;\n\n\t\t$afile = preg_replace(\"/(.*?)\\.txt/\", \"<a href=\\\"\" . SELF . VIEW . \"/\\\\1\\\">\\\\1</a>\", $file);\n\t\t$efile = preg_replace(\"/(.*?)\\.txt/\", \"<a href=\\\"?action=edit&amp;page=\\\\1\\\">edit</a>\", urlencode($file));\n\n\t\tarray_push($filelist, \"<tr style=\\\"background-color: $color;\\\"><td>$afile</td><td width=\\\"20\\\"></td><td>$efile</td></tr>\");\n\n\t\tif ( $color == \"#ffffff\" )\n\t\t\t$color = \"#f4f4f4\";\n\t\telse\n\t\t\t$color = \"#ffffff\";\n\t}\n\n\tclosedir($dir);\n\n\tnatcasesort($filelist);\n\t\n\t$html = \"<table>\";\n\n\n\tfor ($i = 0; $i < count($filelist); $i++)\n\t{\n\t\t$html .= $filelist[$i];\n\t}\n\n\t$html .= \"</table>\\n\";\n}\nelse if ( $action == \"all_date\" )\n{\n\t$html = \"<table>\\n\";\n\t$dir = opendir(PAGES_PATH);\n\t$filelist = array();\n\twhile ( $file = readdir($dir) )\n\t{\n\t\tif ( $file{0} == \".\" )\n\t\t\tcontinue;\n\t\t\t\n\t\t$filelist[preg_replace(\"/(.*?)\\.txt/\", \"<a href=\\\"\" . SELF . VIEW . \"/\\\\1\\\">\\\\1</a>\", $file)] = filemtime(PAGES_PATH . \"/$file\");\n\t}\n\n\tclosedir($dir);\n\n\t$color = \"#ffffff\";\n\tarsort($filelist, SORT_NUMERIC);\n\n\tforeach ($filelist as $key => $value)\n\t{\n\t\t$html .= \"<tr style=\\\"background-color: $color;\\\"><td valign=\\\"top\\\">$key</td><td width=\\\"20\\\"></td><td valign=\\\"top\\\"><nobr>\" . date(TITLE_DATE_NO_TIME, $value) . \"</nobr></td></tr>\\n\";\n\t\t\n\t\tif ( $color == \"#ffffff\" )\n\t\t\t$color = \"#f4f4f4\";\n\t\telse\n\t\t\t$color = \"#ffffff\";\n\t}\n\t$html .= \"</table>\\n\";\n}\nelse if ( $action == \"search\" )\n{\n\t$matches = 0;\n\t$q = $_REQUEST['q'];\n\t$html = \"<h1>Search: $q</h1>\\n<ul>\\n\";\n\n\tif ( trim($q) != \"\" )\n\t{\n\t\t$dir = opendir(PAGES_PATH);\n\t\t\n\t\twhile ( $file = readdir($dir) )\n\t\t{\n\t\t\tif ( $file{0} == \".\" )\n\t\t\t\tcontinue;\n\n\t\t\t$text = file_get_contents(PAGES_PATH . \"/$file\");\n\t\t\t\n                        if ( preg_match(\"/{$q}/i\", $text) || preg_match(\"/{$q}/i\", $file) )\n\t\t\t{\n\t\t\t\t++$matches;\n\t\t\t\t$file = preg_replace(\"/(.*?)\\.txt/\", \"<a href=\\\"\" . SELF . VIEW . \"/\\\\1\\\">\\\\1</a>\", $file);\n\t\t\t\t$html .= \"<li>$file</li>\\n\";\n\t\t\t}\n\t\t}\n\t\t\n\t\tclosedir($dir);\n\t}\n\n\t$html .= \"</ul>\\n\";\n\t$html .= \"<p>$matches matched</p>\\n\";\n}\nelse\n{\n\t$html = toHTML($text);\n}\n\n$datetime = '';\n\nif ( ($action == \"all_name\") || ($action == \"all_date\"))\n\t$title = \"All Pages\";\n\t\nelse if ( $action == \"upload\" )\n\t$title = \"Upload Image\";\n\nelse if ( $action == \"new\" )\n\t$title = \"New\";\n\nelse if ( $action == \"search\" )\n\t$title = \"Search\";\n\nelse\n{\n\t$title = $page;\n\n\tif ( TITLE_DATE )\n\t{\n\t\t$datetime = \"<span class=\\\"titledate\\\">\" . date(TITLE_DATE, @filemtime($filename)) . \"</span>\";\n\t}\n}\n\n// Disable caching on the client (the iPhone is pretty agressive about this\n// and it can cause problems with the editing function)\n\nheader(\"Cache-Control: no-cache, must-revalidate\"); // HTTP/1.1\nheader(\"Expires: Mon, 26 Jul 1997 05:00:00 GMT\"); // Date in the past\n\nprint \"<!DOCTYPE html PUBLIC \\\"-//W3C//DTD XHTML 1.0 Strict//EN\\\" \\\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd\\\">\\n\";\nprint \"<html>\\n\";\nprint \"<head>\\n\";\nprint \"<link rel=\\\"apple-touch-icon\\\" href=\\\"apple-touch-icon.png\\\"/>\";\nprint \"<meta name=\\\"viewport\\\" content=\\\"width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=false\\\" />\\n\";\n\nprint \"<link type=\\\"text/css\\\" rel=\\\"stylesheet\\\" href=\\\"\" . BASE_URI . \"/\" . CSS_FILE .\"\\\" />\\n\";\nprint \"<title>$title</title>\\n\";\nprint \"</head>\\n\";\nprint \"<body>\\n\";\nprint \"<div class=\\\"titlebar\\\">$title <span style=\\\"font-weight: normal;\\\">$datetime</span></div>\\n\";\n\nprintToolbar();\n\nprint \"<div class=\\\"main\\\">\\n\";\nprint \"$html\\n\";\nprint \"</div>\\n\";\n\nprint \"</body>\\n\";\nprint \"</html>\\n\";\n\n?>\n"], "fixing_code": ["<?php\n\n/*\n * W2\n *\n * Copyright (C) 2007-2011 Steven Frank <http://stevenf.com/>\n *\n * Code may be re-used as long as the above copyright notice is retained.\n * See README.txt for full details.\n *\n * Written with Coda: <http://panic.com/coda/>\n *\n */\n \n// Install PSR-4-compatible class autoloader\nspl_autoload_register(function($class){\n\trequire str_replace('\\\\', DIRECTORY_SEPARATOR, ltrim($class, '\\\\')).'.php';\n});\n\n\n// Get Markdown class\nuse Michelf\\MarkdownExtra;\n\n\n// User configurable options:\n\ninclude_once \"config.php\";\n\nini_set('session.gc_maxlifetime', W2_SESSION_LIFETIME);\n\nsession_set_cookie_params(W2_SESSION_LIFETIME);\nsession_name(W2_SESSION_NAME);\nsession_start();\n\nif ( count($allowedIPs) > 0 )\n{\n\t$ip = $_SERVER['REMOTE_ADDR'];\n\t$accepted = false;\n\t\n\tforeach ( $allowedIPs as $allowed )\n\t{\n\t\tif ( strncmp($allowed, $ip, strlen($allowed)) == 0 )\n\t\t{\n\t\t\t$accepted = true;\n\t\t\tbreak;\n\t\t}\n\t}\n\t\n\tif ( !$accepted )\n\t{\n\t\tprint \"<html><body>Access from IP address $ip is not allowed\";\n\t\tprint \"</body></html>\";\n\t\texit;\n\t}\n}\n\nif ( REQUIRE_PASSWORD && !isset($_SESSION['password']) )\n{\n\tif ( !defined('W2_PASSWORD_HASH') || W2_PASSWORD_HASH == '' )\n\t\tdefine('W2_PASSWORD_HASH', sha1(W2_PASSWORD));\n\t\n\tif ( (isset($_POST['p'])) && (sha1($_POST['p']) == W2_PASSWORD_HASH) )\n\t\t$_SESSION['password'] = W2_PASSWORD_HASH;\n\telse\n\t{\n\t\tprint \"<!DOCTYPE html PUBLIC \\\"-//W3C//DTD XHTML 1.0 Strict//EN\\\" \\\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd\\\">\\n\";\n\t\tprint \"<html>\\n\";\n\t\tprint \"<head>\\n\";\n\t\tprint \"<link rel=\\\"apple-touch-icon\\\" href=\\\"apple-touch-icon.png\\\"/>\";\n\t\tprint \"<meta name=\\\"viewport\\\" content=\\\"width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=false\\\" />\\n\";\n\t\t\n\t\tprint \"<link type=\\\"text/css\\\" rel=\\\"stylesheet\\\" href=\\\"\" . BASE_URI . \"/\" . CSS_FILE .\"\\\" />\\n\";\n\t\tprint \"<title>Log In</title>\\n\";\n\t\tprint \"</head>\\n\";\n\t\tprint \"<body><form method=\\\"post\\\">\";\n\t\tprint \"<input type=\\\"password\\\" name=\\\"p\\\">\\n\";\n\t\tprint \"<input type=\\\"submit\\\" value=\\\"Go\\\"></form>\";\n\t\tprint \"</body></html>\";\n\t\texit;\n\t}\n}\n\n// Support functions\n\nfunction _handle_links($match)\n{\n\treturn \"<a href=\\\"\" . SELF . VIEW . \"/\" . htmlentities($match[1]) . \"\\\">\" . htmlentities($match[1]) . \"</a>\";\n}\n\n\nfunction _handle_images($match)\n{\n\treturn \"<img src=\\\"\" . BASE_URI . \"/images/\" . htmlentities($match[1]) . \"\\\" alt=\\\"\" . htmlentities($match[1]) . \"\\\" />\";\n}\n\n\nfunction _handle_message($match)\n{\n\treturn \"[<a href=\\\"message:\" . htmlentities($match[1]) . \"\\\">email</a>]\";\n}\n\n\nfunction printToolbar()\n{\n\tglobal $upage, $page, $action;\n\n\tprint \"<div class=\\\"toolbar\\\">\";\n\tprint \"<a class=\\\"tool first\\\" href=\\\"\" . SELF . \"?action=edit&amp;page=$upage\\\">Edit</a> \";\n\tprint \"<a class=\\\"tool\\\" href=\\\"\" . SELF . \"?action=new\\\">New</a> \";\n\n\tif ( !DISABLE_UPLOADS )\n\t\tprint \"<a class=\\\"tool\\\" href=\\\"\" . SELF . VIEW . \"?action=upload\\\">Upload</a> \";\n\n \tprint \"<a class=\\\"tool\\\" href=\\\"\" . SELF . \"?action=all_name\\\">All</a> \";\n\tprint \"<a class=\\\"tool\\\" href=\\\"\" . SELF . \"?action=all_date\\\">Recent</a> \";\n \tprint \"<a class=\\\"tool\\\" href=\\\"\" . SELF . \"\\\">\". DEFAULT_PAGE . \"</a>\";\n \t\n\tif ( REQUIRE_PASSWORD )\n\t\tprint '<a class=\"tool\" href=\"' . SELF . '?action=logout\">Exit</a>';\n\n\tprint \"<form method=\\\"post\\\" action=\\\"\" . SELF . \"?action=search\\\">\\n\";\n\tprint \"<input class=\\\"tool\\\" placeholder=\\\"Search\\\" size=\\\"6\\\" id=\\\"search\\\" type=\\\"text\\\" name=\\\"q\\\" /></form>\\n\";\n\t\t\n\tprint \"</div>\\n\";\n}\n\n\nfunction descLengthSort($val_1, $val_2) \n{ \n\t$retVal = 0;\n\n\t$firstVal = strlen($val_1); \n\t$secondVal = strlen($val_2);\n\n\tif ( $firstVal > $secondVal ) \n\t\t$retVal = -1; \n\t\n\telse if ( $firstVal < $secondVal ) \n\t\t$retVal = 1; \n\n\treturn $retVal; \n}\n\n\nfunction toHTML($inText)\n{\n\tglobal $page;\n\t\n\t$dir = opendir(PAGES_PATH);\n\twhile ( $filename = readdir($dir) )\n\t{\n\t\tif ( $filename{0} == '.' )\n\t\t\tcontinue;\n\t\t\t\n\t\t$filename = preg_replace(\"/(.*?)\\.txt/\", \"\\\\1\", $filename);\n\t\t$filenames[] = $filename;\n\t}\n\tclosedir($dir);\n\t\n\tuasort($filenames, \"descLengthSort\"); \n\n\tif ( AUTOLINK_PAGE_TITLES )\n\t{\t\n\t\tforeach ( $filenames as $filename )\n\t\t{\n\t \t\t$inText = preg_replace(\"/(?<![\\>\\[\\/])($filename)(?!\\]\\>)/im\", \"<a href=\\\"\" . SELF . VIEW . \"/$filename\\\">\\\\1</a>\", $inText);\n\t\t}\n\t}\n\t\n\t$inText = preg_replace_callback(\"/\\[\\[(.*?)\\]\\]/\", '_handle_links', $inText);\n\t$inText = preg_replace_callback(\"/\\{\\{(.*?)\\}\\}/\", '_handle_images', $inText);\n\t$inText = preg_replace_callback(\"/message:(.*?)\\s/\", '_handle_message', $inText);\n\n\t$html = MarkdownExtra::defaultTransform($inText);\n\t$inText = htmlentities($inText);\n\n\treturn $html;\n}\n\nfunction sanitizeFilename($inFileName)\n{\n\treturn str_replace(array('..', '~', '/', '\\\\', ':'), '-', $inFileName);\n}\n\nfunction destroy_session()\n{\n\tif ( isset($_COOKIE[session_name()]) )\n\t\tsetcookie(session_name(), '', time() - 42000, '/');\n\n\tsession_destroy();\n\tunset($_SESSION[\"password\"]);\n\tunset($_SESSION);\n}\n\n// Support PHP4 by defining file_put_contents if it doesn't already exist\n\nif ( !function_exists('file_put_contents') )\n{\n    function file_put_contents($n, $d)\n    {\n\t\t$f = @fopen($n, \"w\");\n\t\t\n\t\tif ( !$f )\n\t\t{\n\t\t\treturn false;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tfwrite($f, $d);\n\t\t\tfclose($f);\n\t\t\treturn true;\n\t\t}\n    }\n}\n\n// Main code\n\nif ( isset($_REQUEST['action']) )\n\t$action = $_REQUEST['action'];\nelse \n\t$action = 'view';\n\n// Look for page name following the script name in the URL, like this:\n// http://stevenf.com/w2demo/index.php/Markdown%20Syntax\n//\n// Otherwise, get page name from 'page' request variable.\n\nif ( preg_match('@^/@', @$_SERVER[\"PATH_INFO\"]) ) \n\t$page = sanitizeFilename(substr($_SERVER[\"PATH_INFO\"], 1));\nelse \n\t$page = sanitizeFilename(@$_REQUEST['page']);\n\n$upage = urlencode($page);\n\nif ( $page == \"\" )\n\t$page = DEFAULT_PAGE;\n\n$filename = PAGES_PATH . \"/$page.txt\";\n\nif ( file_exists($filename) )\n{\n\t$text = file_get_contents($filename);\n}\nelse\n{\n\tif ( $action != \"save\" && $action != \"all_name\" && $action != \"all_date\" && $action != \"upload\" && $action != \"new\" && $action != \"logout\" && $action != \"uploaded\" && $action != \"search\" && $action != \"view\" )\n\t{\n\t\t$action = \"edit\";\n\t}\n}\n\nif ( $action == \"edit\" || $action == \"new\" )\n{\n\t$formAction = SELF . (($action == 'edit') ? \"/$page\" : \"\");\n\t$html = \"<form id=\\\"edit\\\" method=\\\"post\\\" action=\\\"$formAction\\\">\\n\";\n\n\tif ( $action == \"edit\" )\n\t\t$html .= \"<input type=\\\"hidden\\\" name=\\\"page\\\" value=\\\"$page\\\" />\\n\";\n\telse\n\t\t$html .= \"<p>Title: <input id=\\\"title\\\" type=\\\"text\\\" name=\\\"page\\\" /></p>\\n\";\n\n\tif ( $action == \"new\" )\n\t\t$text = \"\";\n\n\t$html .= \"<p><textarea id=\\\"text\\\" name=\\\"newText\\\" rows=\\\"\" . EDIT_ROWS . \"\\\">$text</textarea></p>\\n\";\n\t$html .= \"<p><input type=\\\"hidden\\\" name=\\\"action\\\" value=\\\"save\\\" />\";\n\t$html .= \"<input id=\\\"save\\\" type=\\\"submit\\\" value=\\\"Save\\\" />\\n\";\n\t$html .= \"<input id=\\\"cancel\\\" type=\\\"button\\\" onclick=\\\"history.go(-1);\\\" value=\\\"Cancel\\\" /></p>\\n\";\n\t$html .= \"</form>\\n\";\n}\nelse if ( $action == \"logout\" )\n{\n\tdestroy_session();\n\theader(\"Location: \" . SELF);\n\texit;\n}\nelse if ( $action == \"upload\" )\n{\n\tif ( DISABLE_UPLOADS )\n\t{\n\t\t$html = \"<p>Image uploading has been disabled on this installation.</p>\";\n\t}\n\telse\n\t{\n\t\t$html = \"<form id=\\\"upload\\\" method=\\\"post\\\" action=\\\"\" . SELF . \"\\\" enctype=\\\"multipart/form-data\\\"><p>\\n\";\n\t\t$html .= \"<input type=\\\"hidden\\\" name=\\\"action\\\" value=\\\"uploaded\\\" />\";\n\t\t$html .= \"<input id=\\\"file\\\" type=\\\"file\\\" name=\\\"userfile\\\" />\\n\";\n\t\t$html .= \"<input id=\\\"upload\\\" type=\\\"submit\\\" value=\\\"Upload\\\" />\\n\";\n\t\t$html .= \"<input id=\\\"cancel\\\" type=\\\"button\\\" onclick=\\\"history.go(-1);\\\" value=\\\"Cancel\\\" />\\n\";\n\t\t$html .= \"</p></form>\\n\";\n\t}\n}\nelse if ( $action == \"uploaded\" )\n{\n\tif ( !DISABLE_UPLOADS )\n\t{\n\t\t$dstName = sanitizeFilename($_FILES['userfile']['name']);\n\t\t$fileType = $_FILES['userfile']['type'];\n\t\tpreg_match('/\\.([^.]+)$/', $dstName, $matches);\n\t\t$fileExt = isset($matches[1]) ? $matches[1] : null;\n\t\t\n\t\tif (in_array($fileType, explode(',', VALID_UPLOAD_TYPES)) &&\n\t\t\tin_array($fileExt, explode(',', VALID_UPLOAD_EXTS)))\n\t\t{\n\t\t\t$errLevel = error_reporting(0);\n\n\t\t\tif ( move_uploaded_file($_FILES['userfile']['tmp_name'], \n\t\t\t\tBASE_PATH . \"/images/$dstName\") === true ) \n\t\t\t{\n\t\t\t\t$html = \"<p class=\\\"note\\\">File '$dstName' uploaded</p>\\n\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$html = \"<p class=\\\"note\\\">Upload error</p>\\n\";\n\t\t\t}\n\n\t\t\terror_reporting($errLevel);\n\t\t} else {\n\t\t\t$html = \"<p class=\\\"note\\\">Upload error: invalid file type</p>\\n\";\n\t\t}\n\t}\n\n\t$html .= toHTML($text);\n}\nelse if ( $action == \"save\" )\n{\n\t$newText = $_REQUEST['newText'];\n\n\t$errLevel = error_reporting(0);\n\t$success = file_put_contents($filename, $newText);\n \terror_reporting($errLevel);\n\n\tif ( $success )\t\n\t\t$html = \"<p class=\\\"note\\\">Saved</p>\\n\";\n\telse\n\t\t$html = \"<p class=\\\"note\\\">Error saving changes! Make sure your web server has write access to \" . PAGES_PATH . \"</p>\\n\";\n\n\t$html .= toHTML($newText);\n}\n/*\nelse if ( $action == \"rename\" )\n{\n\t$html = \"<form id=\\\"rename\\\" method=\\\"post\\\" action=\\\"\" . SELF . \"\\\">\";\n\t$html .= \"<p>Title: <input id=\\\"title\\\" type=\\\"text\\\" name=\\\"page\\\" value=\\\"\" . htmlspecialchars($page) . \"\\\" />\";\n\t$html .= \"<input id=\\\"rename\\\" type=\\\"submit\\\" value=\\\"Rename\\\">\";\n\t$html .= \"<input id=\\\"cancel\\\" type=\\\"button\\\" onclick=\\\"history.go(-1);\\\" value=\\\"Cancel\\\" />\\n\";\n\t$html .= \"<input type=\\\"hidden\\\" name=\\\"action\\\" value=\\\"renamed\\\" />\";\n\t$html .= \"<input type=\\\"hidden\\\" name=\\\"prevpage\\\" value=\\\"\" . htmlspecialchars($page) . \"\\\" />\";\n\t$html .= \"</p></form>\";\n}\nelse if ( $action == \"renamed\" )\n{\n\t$pp = $_REQUEST['prevpage'];\n\t$pg = $_REQUEST['page'];\n\n\t$prevpage = sanitizeFilename($pp);\n\t$prevpage = urlencode($prevpage);\n\t\n\t$prevfilename = PAGES_PATH . \"/$prevpage.txt\";\n\n\tif ( rename($prevfilename, $filename) )\n\t{\n\t\t// Success.  Change links in all pages to point to new page\n\t\tif ( $dh = opendir(PAGES_PATH) )\n\t\t{\n\t\t\twhile ( ($file = readdir($dh)) !== false )\n\t\t\t{\n\t\t\t\t$content = file_get_contents($file);\n\t\t\t\t$pattern = \"/\\[\\[\" . $pp . \"\\]\\]/g\";\n\t\t\t\tpreg_replace($pattern, \"[[$pg]]\", $content);\n\t\t\t\tfile_put_contents($file, $content);\n\t\t\t}\n\t\t}\n\t}\n\telse\n\t{\n\t\t$html = \"<p class=\\\"note\\\">Error renaming file</p>\\n\";\n\t}\n}\n*/\nelse if ( $action == \"all_name\" )\n{\n\t$dir = opendir(PAGES_PATH);\n\t$filelist = array();\n\n\t$color = \"#ffffff\";\n\n\twhile ( $file = readdir($dir) )\n\t{\n\t\tif ( $file{0} == \".\" )\n\t\t\tcontinue;\n\n\t\t$afile = preg_replace(\"/(.*?)\\.txt/\", \"<a href=\\\"\" . SELF . VIEW . \"/\\\\1\\\">\\\\1</a>\", $file);\n\t\t$efile = preg_replace(\"/(.*?)\\.txt/\", \"<a href=\\\"?action=edit&amp;page=\\\\1\\\">edit</a>\", urlencode($file));\n\n\t\tarray_push($filelist, \"<tr style=\\\"background-color: $color;\\\"><td>$afile</td><td width=\\\"20\\\"></td><td>$efile</td></tr>\");\n\n\t\tif ( $color == \"#ffffff\" )\n\t\t\t$color = \"#f4f4f4\";\n\t\telse\n\t\t\t$color = \"#ffffff\";\n\t}\n\n\tclosedir($dir);\n\n\tnatcasesort($filelist);\n\t\n\t$html = \"<table>\";\n\n\n\tfor ($i = 0; $i < count($filelist); $i++)\n\t{\n\t\t$html .= $filelist[$i];\n\t}\n\n\t$html .= \"</table>\\n\";\n}\nelse if ( $action == \"all_date\" )\n{\n\t$html = \"<table>\\n\";\n\t$dir = opendir(PAGES_PATH);\n\t$filelist = array();\n\twhile ( $file = readdir($dir) )\n\t{\n\t\tif ( $file{0} == \".\" )\n\t\t\tcontinue;\n\t\t\t\n\t\t$filelist[preg_replace(\"/(.*?)\\.txt/\", \"<a href=\\\"\" . SELF . VIEW . \"/\\\\1\\\">\\\\1</a>\", $file)] = filemtime(PAGES_PATH . \"/$file\");\n\t}\n\n\tclosedir($dir);\n\n\t$color = \"#ffffff\";\n\tarsort($filelist, SORT_NUMERIC);\n\n\tforeach ($filelist as $key => $value)\n\t{\n\t\t$html .= \"<tr style=\\\"background-color: $color;\\\"><td valign=\\\"top\\\">$key</td><td width=\\\"20\\\"></td><td valign=\\\"top\\\"><nobr>\" . date(TITLE_DATE_NO_TIME, $value) . \"</nobr></td></tr>\\n\";\n\t\t\n\t\tif ( $color == \"#ffffff\" )\n\t\t\t$color = \"#f4f4f4\";\n\t\telse\n\t\t\t$color = \"#ffffff\";\n\t}\n\t$html .= \"</table>\\n\";\n}\nelse if ( $action == \"search\" )\n{\n\t$matches = 0;\n\t$q = $_REQUEST['q'];\n\t$html = \"<h1>Search: $q</h1>\\n<ul>\\n\";\n\n\tif ( trim($q) != \"\" )\n\t{\n\t\t$dir = opendir(PAGES_PATH);\n\t\t\n\t\twhile ( $file = readdir($dir) )\n\t\t{\n\t\t\tif ( $file{0} == \".\" )\n\t\t\t\tcontinue;\n\n\t\t\t$text = file_get_contents(PAGES_PATH . \"/$file\");\n\t\t\t\n                        if ( preg_match(\"/{$q}/i\", $text) || preg_match(\"/{$q}/i\", $file) )\n\t\t\t{\n\t\t\t\t++$matches;\n\t\t\t\t$file = preg_replace(\"/(.*?)\\.txt/\", \"<a href=\\\"\" . SELF . VIEW . \"/\\\\1\\\">\\\\1</a>\", $file);\n\t\t\t\t$html .= \"<li>$file</li>\\n\";\n\t\t\t}\n\t\t}\n\t\t\n\t\tclosedir($dir);\n\t}\n\n\t$html .= \"</ul>\\n\";\n\t$html .= \"<p>$matches matched</p>\\n\";\n}\nelse\n{\n\t$html = toHTML($text);\n}\n\n$datetime = '';\n\nif ( ($action == \"all_name\") || ($action == \"all_date\"))\n\t$title = \"All Pages\";\n\t\nelse if ( $action == \"upload\" )\n\t$title = \"Upload Image\";\n\nelse if ( $action == \"new\" )\n\t$title = \"New\";\n\nelse if ( $action == \"search\" )\n\t$title = \"Search\";\n\nelse\n{\n\t$title = $page;\n\n\tif ( TITLE_DATE )\n\t{\n\t\t$datetime = \"<span class=\\\"titledate\\\">\" . date(TITLE_DATE, @filemtime($filename)) . \"</span>\";\n\t}\n}\n\n// Disable caching on the client (the iPhone is pretty agressive about this\n// and it can cause problems with the editing function)\n\nheader(\"Cache-Control: no-cache, must-revalidate\"); // HTTP/1.1\nheader(\"Expires: Mon, 26 Jul 1997 05:00:00 GMT\"); // Date in the past\n\nprint \"<!DOCTYPE html PUBLIC \\\"-//W3C//DTD XHTML 1.0 Strict//EN\\\" \\\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd\\\">\\n\";\nprint \"<html>\\n\";\nprint \"<head>\\n\";\nprint \"<link rel=\\\"apple-touch-icon\\\" href=\\\"apple-touch-icon.png\\\"/>\";\nprint \"<meta name=\\\"viewport\\\" content=\\\"width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=false\\\" />\\n\";\n\nprint \"<link type=\\\"text/css\\\" rel=\\\"stylesheet\\\" href=\\\"\" . BASE_URI . \"/\" . CSS_FILE .\"\\\" />\\n\";\nprint \"<title>$title</title>\\n\";\nprint \"</head>\\n\";\nprint \"<body>\\n\";\nprint \"<div class=\\\"titlebar\\\">$title <span style=\\\"font-weight: normal;\\\">$datetime</span></div>\\n\";\n\nprintToolbar();\n\nprint \"<div class=\\\"main\\\">\\n\";\nprint \"$html\\n\";\nprint \"</div>\\n\";\n\nprint \"</body>\\n\";\nprint \"</html>\\n\";\n\n?>\n"], "filenames": ["index.php"], "buggy_code_start_loc": [84], "buggy_code_end_loc": [155], "fixing_code_start_loc": [85], "fixing_code_end_loc": [173], "type": "CWE-79", "message": "A vulnerability was found in panicsteve w2wiki. It has been rated as problematic. Affected by this issue is the function toHTML of the file index.php of the component Markdown Handler. The manipulation leads to cross site scripting. The attack may be launched remotely. The name of the patch is 8f1d0470b4ddb1c7699e3308e765c11ed29542b6. It is recommended to apply a patch to fix this issue. The identifier of this vulnerability is VDB-216476.", "other": {"cve": {"id": "CVE-2021-4271", "sourceIdentifier": "cna@vuldb.com", "published": "2022-12-21T19:15:13.820", "lastModified": "2022-12-30T21:52:49.250", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "A vulnerability was found in panicsteve w2wiki. It has been rated as problematic. Affected by this issue is the function toHTML of the file index.php of the component Markdown Handler. The manipulation leads to cross site scripting. The attack may be launched remotely. The name of the patch is 8f1d0470b4ddb1c7699e3308e765c11ed29542b6. It is recommended to apply a patch to fix this issue. The identifier of this vulnerability is VDB-216476."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}, {"source": "cna@vuldb.com", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:U/C:N/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "UNCHANGED", "confidentialityImpact": "NONE", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 3.5, "baseSeverity": "LOW"}, "exploitabilityScore": 2.1, "impactScore": 1.4}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}, {"source": "cna@vuldb.com", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-707"}, {"lang": "en", "value": "CWE-74"}, {"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:w2wiki_project:w2wiki:-:*:*:*:*:*:*:*", "matchCriteriaId": "0272307B-6C76-4DBB-8C86-1082FFFB13F7"}]}]}], "references": [{"url": "https://github.com/panicsteve/w2wiki/commit/8f1d0470b4ddb1c7699e3308e765c11ed29542b6", "source": "cna@vuldb.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://vuldb.com/?id.216476", "source": "cna@vuldb.com", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/panicsteve/w2wiki/commit/8f1d0470b4ddb1c7699e3308e765c11ed29542b6"}}