{"buggy_code": ["<?php\n\n/**\n * @file controllers/grid/CustomLocaleGridHandler.php\n *\n * Copyright (c) 2016-2022 Language Science Press\n * Distributed under the GNU GPL v3. For full terms see the file docs/COPYING.\n *\n * @class CustomLocaleGridHandler\n */\n\nnamespace APP\\plugins\\generic\\customLocale\\controllers\\grid;\n\nuse APP\\notification\\NotificationManager;\nuse APP\\plugins\\generic\\customLocale\\classes\\CustomLocale;\nuse APP\\plugins\\generic\\customLocale\\controllers\\grid\\form\\LocaleFileForm;\nuse APP\\plugins\\generic\\customLocale\\CustomLocalePlugin;\nuse Exception;\nuse Gettext\\Generator\\PoGenerator;\nuse Gettext\\Translation;\nuse Gettext\\Translations;\nuse PKP\\controllers\\grid\\feature\\PagingFeature;\nuse PKP\\controllers\\grid\\GridColumn;\nuse PKP\\controllers\\grid\\GridHandler;\nuse PKP\\core\\JSONMessage;\nuse PKP\\core\\PKPRequest;\nuse PKP\\i18n\\translation\\LocaleFile;\nuse PKP\\security\\authorization\\ContextAccessPolicy;\nuse PKP\\security\\Role;\n\nclass CustomLocaleGridHandler extends GridHandler\n{\n    protected LocaleFileForm $form;\n\n    protected static CustomLocalePlugin $plugin;\n\n    /**\n     * Set the custom locale plugin.\n     */\n    public static function setPlugin(CustomLocalePlugin $plugin): void\n    {\n        static::$plugin = $plugin;\n    }\n\n    /**\n     * Constructor\n     */\n    public function __construct()\n    {\n        parent::__construct();\n        $this->addRoleAssignment(\n            [Role::ROLE_ID_MANAGER, Role::ROLE_ID_SITE_ADMIN],\n            ['fetchGrid', 'editLocale', 'updateLocale']\n        );\n    }\n\n    /**\n     * Edit a locale file.\n     */\n    public function editLocale(array $args, PKPRequest $request): JSONMessage\n    {\n        $this->setupTemplate($request);\n\n        // Create and present the edit form\n        $localeFileForm = new LocaleFileForm(self::$plugin, $args['locale']);\n        $localeFileForm->initData();\n        return new JSONMessage(true, $localeFileForm->fetch($request));\n    }\n\n    /**\n     * Update the custom locale data.\n     */\n    public function updateLocale(array $args, PKPRequest $request): JSONMessage\n    {\n        ['locale' => $locale, 'changes' => $changes] = $args;\n\n        if (!count($changes)) {\n            $this->setupTemplate($request);\n            // Create and present the edit form\n            $localeFileForm = new LocaleFileForm(self::$plugin, $locale);\n            $localeFileForm->initData();\n            return new JSONMessage(true, $localeFileForm->fetch($request));\n        }\n\n        // save changes\n        $customLocalePath = CustomLocalePlugin::getStoragePath();\n        $customFilePath = \"{$customLocalePath}/{$locale}/locale.po\";\n        $translator = CustomLocalePlugin::getTranslator($locale);\n        $translations = file_exists($customFilePath)\n            ? LocaleFile::loadTranslations($customFilePath)\n            : Translations::create(null, $locale);\n        foreach ($changes as $key => $value) {\n            $value = str_replace(\"\\r\\n\", \"\\n\", $value);\n            $translation = $translations->find('', $key);\n            if (!strlen($value) || $translator->getSingular($key) === $value) {\n                if ($translation) {\n                    $translations->remove($translation);\n                }\n                continue;\n            }\n            if (!$translation) {\n                $translation = Translation::create('', $key);\n                $translations->add($translation);\n            }\n            $translation->translate($value);\n        }\n\n        $contextFileManager = CustomLocalePlugin::getContextFileManager();\n        if (!is_dir($basePath = dirname($customFilePath))) {\n            $contextFileManager->mkdir($basePath);\n        }\n        $poGenerator = new PoGenerator();\n        if (!$poGenerator->generateFile($translations, $customFilePath)) {\n            throw new Exception('Failed to serialize translations');\n        }\n\n        // Create success notification and close modal on save\n        $notificationMgr = new NotificationManager();\n        $notificationMgr->createTrivialNotification($request->getUser()->getId());\n        return new JSONMessage(false);\n    }\n\n    //\n    // Overridden template methods\n    //\n    /**\n     * @copydoc PKPHandler::authorize()\n     */\n    public function authorize($request, &$args, $roleAssignments): bool\n    {\n        $this->addPolicy(new ContextAccessPolicy($request, $roleAssignments));\n        return parent::authorize($request, $args, $roleAssignments);\n    }\n\n    /**\n     * @copydoc Gridhandler::initialize()\n     *\n     * @param null|mixed $args\n     */\n    public function initialize($request, $args = null): void\n    {\n        parent::initialize($request, $args);\n\n        // Set the grid details.\n        $this->setTitle('plugins.generic.customLocale.customLocaleFiles');\n        $this->setEmptyRowText('plugins.generic.customLocale.noneCreated');\n\n        // Columns\n        $cellProvider = new CustomLocaleGridCellProvider();\n        $addColumn = fn (string $id, string $title) => $this->addColumn(new GridColumn($id, $title, null, 'controllers/grid/gridCell.tpl', $cellProvider));\n        $addColumn('name', 'common.description');\n        $addColumn('locale', 'grid.columns.locale');\n        $addColumn('action', 'common.action');\n    }\n\n    /**\n     * @copydoc GridHandler::loadData()\n     */\n    public function loadData($request, $filter): array\n    {\n        $gridDataElements = [];\n        $locales = $request->getContext()->getSupportedFormLocaleNames();\n        foreach (array_keys($locales) as $i => $locale) {\n            $gridDataElements[] = new CustomLocale($i, $locale, $locales[$locale]);\n        }\n\n        return $gridDataElements;\n    }\n\n    /**\n     * @copydoc GridHandler::initFeatures()\n     */\n    public function initFeatures($request, $args): array\n    {\n        return [new PagingFeature()];\n    }\n}\n\nif (!PKP_STRICT_MODE) {\n    class_alias('\\APP\\plugins\\generic\\customLocale\\controllers\\grid\\CustomLocaleGridHandler', '\\CustomLocaleGridHandler');\n}\n", "{**\n * templates/localeFile.tpl\n *\n * Copyright (c) 2016-2022 Language Science Press\n * Distributed under the GNU GPL v3. For full terms see the file docs/COPYING.\n *\n *}\n\n<form class=\"pkp_form\" id=\"localeFilesForm\" method=\"post\" action=\"{url router=$smarty.const.ROUTE_COMPONENT component=\"plugins.generic.customLocale.controllers.grid.CustomLocaleGridHandler\" op=\"updateLocale\" locale=$locale key=$name anchor=\"localeContents\"}\">\n\t<link rel=\"stylesheet\" href=\"{$baseUrl}/plugins/generic/customLocale/css/customLocale.css\" type=\"text/css\" />\n\t<div id=\"customLocales\">\n\t\t{* TABLE *}\n\t\t<table class=\"pkpTable\">\n\t\t\t{* TABLE HEADER *}\n\t\t\t<caption>\n\t\t\t\t<span class=\"pkpHeader__title\">\n\t\t\t\t\t<h3>{translate key=\"plugins.generic.customLocale.file.editHeader\"}</h3>\n\t\t\t\t</span>\n\t\t\t\t<div class=\"pkpHeader__actions\">\n\t\t\t\t\t{* SEARCH BOX *}\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<label>\n\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\ttype=\"checkbox\"\n\t\t\t\t\t\t\t\tv-model=\"onlyModified\"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t{translate key=\"plugins.generic.customLocale.file.onlyModified\"}\n\t\t\t\t\t\t</label>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"pkpSearch\">\n\t\t\t\t\t\t<label>\n\t\t\t\t\t\t\t<span class=\"-screenReader\">{translate key=\"common.search\"}</span>\n\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\ttype=\"search\"\n\t\t\t\t\t\t\t\tid=\"customLocale__searchInput\"\n\t\t\t\t\t\t\t\tplaceholder=\"{translate key=\"common.search\"}\"\n\t\t\t\t\t\t\t\tclass=\"pkpSearch__input\"\n\t\t\t\t\t\t\t\tv-model=\"searchPhrase\"\n\t\t\t\t\t\t\t\t@keydown.enter.prevent=\"search\"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t<span class=\"pkpSearch__icons\" @click.prevent=\"search\">\n\t\t\t\t\t\t\t\t<span aria-hidden=\"true\" class=\"fa pkpSearch__icons--search fa-search pkpIcon--inline\"></span>\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</label>\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\taria-controls=\"customLocale__searchInput\"\n\t\t\t\t\t\t\tclass=\"pkpSearch__clear\"\n\t\t\t\t\t\t\t@click.prevent=\"initializeView\"\n\t\t\t\t\t\t\tv-if=\"searchPhrase.length > 0\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<span aria-hidden=\"true\" class=\"fa fa-times\"></span>\n\t\t\t\t\t\t\t<span class=\"-screenReader\">{translate key=\"common.clearSearch\"}</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t\t<button class=\"pkpButton\" @click.prevent=\"search\">{translate key=\"common.search\"}</button>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"customLocale__headerDescription\">\n\t\t\t\t\t{translate key=\"plugins.generic.customLocale.file.edit\" filename=$name|escape}\n\t\t\t\t</div>\n\t\t\t</caption>\n\t\t\t<tr v-if=\"displaySearchResults\">\n\t\t\t\t<td class=\"customLocale__itemCount\">\n\t\t\t\t\t{translate key=\"plugins.generic.customLocale.searchResultsCount\"}\n\t\t\t\t</td>\n\t\t\t</tr>\n\t\t\t{* MAIN BODY *}\n\t\t\t<tr v-for=\"(localeKey, index) in currentLocaleKeys\" :key=\"localeKey.localeKey\">\n\t\t\t\t<td>\n\t\t\t\t\t<table class=\"pkpTable customLocale__cellTable\">\n\t\t\t\t\t\t<tr class=\"customLocale__cellHeader\">\n\t\t\t\t\t\t\t<td colspan=\"2\">{{ localeKey.localeKey }}</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td width=\"50%\">\n\t\t\t\t\t\t\t\t<label class=\"-screenReader\" :for=\"'default-text-' + index\">{translate key=\"plugins.generic.customLocale.file.reference\"}</label>\n\t\t\t\t\t\t\t\t<div v-if=\"localeKey.value.length > 50\">\n\t\t\t\t\t\t\t\t\t<textarea\n\t\t\t\t\t\t\t\t\t\tclass=\"customLocale__fixedSize\"\n\t\t\t\t\t\t\t\t\t\t:id=\"'default-text-' + index\"\n\t\t\t\t\t\t\t\t\t\tv-model=\"localeKey.value\"\n\t\t\t\t\t\t\t\t\t\trows=\"5\"\n\t\t\t\t\t\t\t\t\t\tcols=\"50\"\n\t\t\t\t\t\t\t\t\t\tdisabled\n\t\t\t\t\t\t\t\t\t></textarea>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<div v-else>\n\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\t\t:id=\"'default-text-' + index\"\n\t\t\t\t\t\t\t\t\t\tv-model=\"localeKey.value\"\n\t\t\t\t\t\t\t\t\t\tsize=\"50\"\n\t\t\t\t\t\t\t\t\t\tdisabled\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t\t<td width=\"50%\">\n\t\t\t\t\t\t\t\t<label class=\"-screenReader\" :for=\"'custom-text-' + index\">{translate key=\"plugins.generic.customLocale.file.custom\"}</label>\n\t\t\t\t\t\t\t\t<div v-if=\"localeKey.value.length > 50\">\n\t\t\t\t\t\t\t\t\t<textarea\n\t\t\t\t\t\t\t\t\t\tclass=\"customLocale__fixedSize\"\n\t\t\t\t\t\t\t\t\t\t:id=\"'custom-text-' + index\"\n\t\t\t\t\t\t\t\t\t\t:name=\"'changes[' + localeKey.localeKey + ']'\"\n\t\t\t\t\t\t\t\t\t\tv-model=\"localEdited[localeKey.localeKey]\"\n\t\t\t\t\t\t\t\t\t\trows=\"5\"\n\t\t\t\t\t\t\t\t\t\tcols=\"50\"\n\t\t\t\t\t\t\t\t\t\t:class=\"{ valueChanged : localEdited[localeKey.localeKey] != null}\"\n\t\t\t\t\t\t\t\t\t></textarea>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<div v-else>\n\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\t\t:id=\"'custom-text-' + index\"\n\t\t\t\t\t\t\t\t\t\t:name=\"'changes[' + localeKey.localeKey + ']'\"\n\t\t\t\t\t\t\t\t\t\tv-model=\"localEdited[localeKey.localeKey]\"\n\t\t\t\t\t\t\t\t\t\t:class=\"{ valueChanged : localEdited[localeKey.localeKey] != null}\"\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t</table>\n\t\t\t\t</td>\n\t\t\t</tr>\n\t\t</table>\n\n\t\t{* PAGINATION *}\n\t\t<nav role=\"navigation\" aria-label=\"{translate key='common.pagination.label'}\" class=\"pkpPagination\" v-if=\"lastPage > 1\">\n\t\t\t<ul>\n\t\t\t\t<li>\n\t\t\t\t\t<button \n\t\t\t\t\t\tclass=\"pkpButton\"\n\t\t\t\t\t\t:disabled=\"currentPage === 1 ? true : null\"\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t@click=\"() => (currentPage -= 1)\"\n\t\t\t\t\t\taria-label=\"{translate key='common.pagination.goToPage' page={translate key='common.pagination.previous'}}\"\n\t\t\t\t\t>\n\t\t\t\t\t\t{translate key=\"common.pagination.previous\"}\n\t\t\t\t\t</button>\n\t\t\t\t</li>\n\t\t\t\t<li v-for=\"(page, index) in pages\" :key=\"index\">\n\t\t\t\t\t<span\n\t\t\t\t\t\tv-if=\"page.isSeparator\"\n\t\t\t\t\t\tclass=\"pkpPagination__separator\"\n\t\t\t\t\t\t:aria-hidden=\"true\"\n\t\t\t\t\t>\n\t\t\t\t\t\t\u00b7\u00b7\u00b7\n\t\t\t\t\t</span>\n\t\t\t\t\t<button\n\t\t\t\t\t\tv-else\n\t\t\t\t\t\tclass=\"pkpButton\"\n\t\t\t\t\t\t:class=\"currentPage === page.value ? 'pkpButton--isActive' : 'pkpButton--isLink'\"\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t@click=\"() => (currentPage = page.value)\"\n\t\t\t\t\t\t:aria-label=\"'{translate key=\"common.pagination.goToPage\" page=\"{translate key='common.pageNumber' pageNumber=''}\"}' + page.value\"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{ page.value }}\n\t\t\t\t\t</button>\n\n\t\t\t\t</li>\n\t\t\t\t<li>\n\t\t\t\t\t<button\n\t\t\t\t\t\tclass=\"pkpButton\"\n\t\t\t\t\t\t:disabled=\"currentPage === lastPage ? true : null\"\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t@click=\"() => (currentPage += 1)\"\n\t\t\t\t\t\taria-label=\"{translate key='common.pagination.goToPage' page={translate key='common.pagination.next'}}\"\n\t\t\t\t\t>\n\t\t\t\t\t\t{translate key=\"common.pagination.next\"}\n\t\t\t\t\t</button>\n\t\t\t\t</li>\n\t\t\t</ul>\n\t\t</nav>\n\n\t\t{fbvFormButtons id=\"submitCustomLocaleFileTemplate\" submitText=\"plugins.generic.customLocale.saveAndContinue\"}\n\t</div>\n\t<script type=\"text/javascript\">\n\t\t$(function() {ldelim}\n\t\t\t// Attach the form handler.\n\t\t\t$('#localeFilesForm').pkpHandler('$.pkp.controllers.form.AjaxFormHandler');\n\t\t{rdelim});\n\t\t{if $localeContents}\n\t\t\tcustomLocalesApp.data.edited = {$localeContents|json_encode};\n\t\t{else}\n\t\t\tcustomLocalesApp.data.edited = {ldelim}{rdelim};\n\t\t{/if}\n\t\tcustomLocalesApp.data.localeKeysMaster = {$referenceLocaleContents|json_encode};\n\t\tnew pkp.Vue(customLocalesApp);\n\t</script>\n</form>"], "fixing_code": ["<?php\n\n/**\n * @file controllers/grid/CustomLocaleGridHandler.php\n *\n * Copyright (c) 2016-2022 Language Science Press\n * Distributed under the GNU GPL v3. For full terms see the file docs/COPYING.\n *\n * @class CustomLocaleGridHandler\n */\n\nnamespace APP\\plugins\\generic\\customLocale\\controllers\\grid;\n\nuse APP\\notification\\NotificationManager;\nuse APP\\plugins\\generic\\customLocale\\classes\\CustomLocale;\nuse APP\\plugins\\generic\\customLocale\\controllers\\grid\\form\\LocaleFileForm;\nuse APP\\plugins\\generic\\customLocale\\CustomLocalePlugin;\nuse Exception;\nuse Gettext\\Generator\\PoGenerator;\nuse Gettext\\Translation;\nuse Gettext\\Translations;\nuse PKP\\controllers\\grid\\feature\\PagingFeature;\nuse PKP\\controllers\\grid\\GridColumn;\nuse PKP\\controllers\\grid\\GridHandler;\nuse PKP\\core\\JSONMessage;\nuse PKP\\core\\PKPRequest;\nuse PKP\\i18n\\translation\\LocaleFile;\nuse PKP\\security\\authorization\\ContextAccessPolicy;\nuse PKP\\security\\Role;\n\nclass CustomLocaleGridHandler extends GridHandler\n{\n    protected LocaleFileForm $form;\n\n    protected static CustomLocalePlugin $plugin;\n\n    /**\n     * Set the custom locale plugin.\n     */\n    public static function setPlugin(CustomLocalePlugin $plugin): void\n    {\n        static::$plugin = $plugin;\n    }\n\n    /**\n     * Constructor\n     */\n    public function __construct()\n    {\n        parent::__construct();\n        $this->addRoleAssignment(\n            [Role::ROLE_ID_MANAGER, Role::ROLE_ID_SITE_ADMIN],\n            ['fetchGrid', 'editLocale', 'updateLocale']\n        );\n    }\n\n    /**\n     * Edit a locale file.\n     */\n    public function editLocale(array $args, PKPRequest $request): JSONMessage\n    {\n        $this->setupTemplate($request);\n\n        // Create and present the edit form\n        $localeFileForm = new LocaleFileForm(self::$plugin, $args['locale']);\n        $localeFileForm->initData();\n        return new JSONMessage(true, $localeFileForm->fetch($request));\n    }\n\n    /**\n     * Update the custom locale data.\n     */\n    public function updateLocale(array $args, PKPRequest $request): JSONMessage\n    {\n        ['locale' => $locale, 'changes' => $changes] = $args;\n\n\tif (!$request->checkCSRF()) return new JSONMessage(false);\n\n        if (!count($changes)) {\n            $this->setupTemplate($request);\n            // Create and present the edit form\n            $localeFileForm = new LocaleFileForm(self::$plugin, $locale);\n            $localeFileForm->initData();\n            return new JSONMessage(true, $localeFileForm->fetch($request));\n        }\n\n        // save changes\n        $customLocalePath = CustomLocalePlugin::getStoragePath();\n        $customFilePath = \"{$customLocalePath}/{$locale}/locale.po\";\n        $translator = CustomLocalePlugin::getTranslator($locale);\n        $translations = file_exists($customFilePath)\n            ? LocaleFile::loadTranslations($customFilePath)\n            : Translations::create(null, $locale);\n        foreach ($changes as $key => $value) {\n            $value = str_replace(\"\\r\\n\", \"\\n\", $value);\n            $translation = $translations->find('', $key);\n            if (!strlen($value) || $translator->getSingular($key) === $value) {\n                if ($translation) {\n                    $translations->remove($translation);\n                }\n                continue;\n            }\n            if (!$translation) {\n                $translation = Translation::create('', $key);\n                $translations->add($translation);\n            }\n            $translation->translate($value);\n        }\n\n        $contextFileManager = CustomLocalePlugin::getContextFileManager();\n        if (!is_dir($basePath = dirname($customFilePath))) {\n            $contextFileManager->mkdir($basePath);\n        }\n        $poGenerator = new PoGenerator();\n        if (!$poGenerator->generateFile($translations, $customFilePath)) {\n            throw new Exception('Failed to serialize translations');\n        }\n\n        // Create success notification and close modal on save\n        $notificationMgr = new NotificationManager();\n        $notificationMgr->createTrivialNotification($request->getUser()->getId());\n        return new JSONMessage(false);\n    }\n\n    //\n    // Overridden template methods\n    //\n    /**\n     * @copydoc PKPHandler::authorize()\n     */\n    public function authorize($request, &$args, $roleAssignments): bool\n    {\n        $this->addPolicy(new ContextAccessPolicy($request, $roleAssignments));\n        return parent::authorize($request, $args, $roleAssignments);\n    }\n\n    /**\n     * @copydoc Gridhandler::initialize()\n     *\n     * @param null|mixed $args\n     */\n    public function initialize($request, $args = null): void\n    {\n        parent::initialize($request, $args);\n\n        // Set the grid details.\n        $this->setTitle('plugins.generic.customLocale.customLocaleFiles');\n        $this->setEmptyRowText('plugins.generic.customLocale.noneCreated');\n\n        // Columns\n        $cellProvider = new CustomLocaleGridCellProvider();\n        $addColumn = fn (string $id, string $title) => $this->addColumn(new GridColumn($id, $title, null, 'controllers/grid/gridCell.tpl', $cellProvider));\n        $addColumn('name', 'common.description');\n        $addColumn('locale', 'grid.columns.locale');\n        $addColumn('action', 'common.action');\n    }\n\n    /**\n     * @copydoc GridHandler::loadData()\n     */\n    public function loadData($request, $filter): array\n    {\n        $gridDataElements = [];\n        $locales = $request->getContext()->getSupportedFormLocaleNames();\n        foreach (array_keys($locales) as $i => $locale) {\n            $gridDataElements[] = new CustomLocale($i, $locale, $locales[$locale]);\n        }\n\n        return $gridDataElements;\n    }\n\n    /**\n     * @copydoc GridHandler::initFeatures()\n     */\n    public function initFeatures($request, $args): array\n    {\n        return [new PagingFeature()];\n    }\n}\n\nif (!PKP_STRICT_MODE) {\n    class_alias('\\APP\\plugins\\generic\\customLocale\\controllers\\grid\\CustomLocaleGridHandler', '\\CustomLocaleGridHandler');\n}\n", "{**\n * templates/localeFile.tpl\n *\n * Copyright (c) 2016-2022 Language Science Press\n * Distributed under the GNU GPL v3. For full terms see the file docs/COPYING.\n *\n *}\n\n<form class=\"pkp_form\" id=\"localeFilesForm\" method=\"post\" action=\"{url router=$smarty.const.ROUTE_COMPONENT component=\"plugins.generic.customLocale.controllers.grid.CustomLocaleGridHandler\" op=\"updateLocale\" locale=$locale key=$name anchor=\"localeContents\"}\">\n\t{csrf}\n\t<link rel=\"stylesheet\" href=\"{$baseUrl}/plugins/generic/customLocale/css/customLocale.css\" type=\"text/css\" />\n\t<div id=\"customLocales\">\n\t\t{* TABLE *}\n\t\t<table class=\"pkpTable\">\n\t\t\t{* TABLE HEADER *}\n\t\t\t<caption>\n\t\t\t\t<span class=\"pkpHeader__title\">\n\t\t\t\t\t<h3>{translate key=\"plugins.generic.customLocale.file.editHeader\"}</h3>\n\t\t\t\t</span>\n\t\t\t\t<div class=\"pkpHeader__actions\">\n\t\t\t\t\t{* SEARCH BOX *}\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<label>\n\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\ttype=\"checkbox\"\n\t\t\t\t\t\t\t\tv-model=\"onlyModified\"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t{translate key=\"plugins.generic.customLocale.file.onlyModified\"}\n\t\t\t\t\t\t</label>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"pkpSearch\">\n\t\t\t\t\t\t<label>\n\t\t\t\t\t\t\t<span class=\"-screenReader\">{translate key=\"common.search\"}</span>\n\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\ttype=\"search\"\n\t\t\t\t\t\t\t\tid=\"customLocale__searchInput\"\n\t\t\t\t\t\t\t\tplaceholder=\"{translate key=\"common.search\"}\"\n\t\t\t\t\t\t\t\tclass=\"pkpSearch__input\"\n\t\t\t\t\t\t\t\tv-model=\"searchPhrase\"\n\t\t\t\t\t\t\t\t@keydown.enter.prevent=\"search\"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t<span class=\"pkpSearch__icons\" @click.prevent=\"search\">\n\t\t\t\t\t\t\t\t<span aria-hidden=\"true\" class=\"fa pkpSearch__icons--search fa-search pkpIcon--inline\"></span>\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</label>\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\taria-controls=\"customLocale__searchInput\"\n\t\t\t\t\t\t\tclass=\"pkpSearch__clear\"\n\t\t\t\t\t\t\t@click.prevent=\"initializeView\"\n\t\t\t\t\t\t\tv-if=\"searchPhrase.length > 0\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<span aria-hidden=\"true\" class=\"fa fa-times\"></span>\n\t\t\t\t\t\t\t<span class=\"-screenReader\">{translate key=\"common.clearSearch\"}</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t\t<button class=\"pkpButton\" @click.prevent=\"search\">{translate key=\"common.search\"}</button>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"customLocale__headerDescription\">\n\t\t\t\t\t{translate key=\"plugins.generic.customLocale.file.edit\" filename=$name|escape}\n\t\t\t\t</div>\n\t\t\t</caption>\n\t\t\t<tr v-if=\"displaySearchResults\">\n\t\t\t\t<td class=\"customLocale__itemCount\">\n\t\t\t\t\t{translate key=\"plugins.generic.customLocale.searchResultsCount\"}\n\t\t\t\t</td>\n\t\t\t</tr>\n\t\t\t{* MAIN BODY *}\n\t\t\t<tr v-for=\"(localeKey, index) in currentLocaleKeys\" :key=\"localeKey.localeKey\">\n\t\t\t\t<td>\n\t\t\t\t\t<table class=\"pkpTable customLocale__cellTable\">\n\t\t\t\t\t\t<tr class=\"customLocale__cellHeader\">\n\t\t\t\t\t\t\t<td colspan=\"2\">{{ localeKey.localeKey }}</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td width=\"50%\">\n\t\t\t\t\t\t\t\t<label class=\"-screenReader\" :for=\"'default-text-' + index\">{translate key=\"plugins.generic.customLocale.file.reference\"}</label>\n\t\t\t\t\t\t\t\t<div v-if=\"localeKey.value.length > 50\">\n\t\t\t\t\t\t\t\t\t<textarea\n\t\t\t\t\t\t\t\t\t\tclass=\"customLocale__fixedSize\"\n\t\t\t\t\t\t\t\t\t\t:id=\"'default-text-' + index\"\n\t\t\t\t\t\t\t\t\t\tv-model=\"localeKey.value\"\n\t\t\t\t\t\t\t\t\t\trows=\"5\"\n\t\t\t\t\t\t\t\t\t\tcols=\"50\"\n\t\t\t\t\t\t\t\t\t\tdisabled\n\t\t\t\t\t\t\t\t\t></textarea>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<div v-else>\n\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\t\t:id=\"'default-text-' + index\"\n\t\t\t\t\t\t\t\t\t\tv-model=\"localeKey.value\"\n\t\t\t\t\t\t\t\t\t\tsize=\"50\"\n\t\t\t\t\t\t\t\t\t\tdisabled\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t\t<td width=\"50%\">\n\t\t\t\t\t\t\t\t<label class=\"-screenReader\" :for=\"'custom-text-' + index\">{translate key=\"plugins.generic.customLocale.file.custom\"}</label>\n\t\t\t\t\t\t\t\t<div v-if=\"localeKey.value.length > 50\">\n\t\t\t\t\t\t\t\t\t<textarea\n\t\t\t\t\t\t\t\t\t\tclass=\"customLocale__fixedSize\"\n\t\t\t\t\t\t\t\t\t\t:id=\"'custom-text-' + index\"\n\t\t\t\t\t\t\t\t\t\t:name=\"'changes[' + localeKey.localeKey + ']'\"\n\t\t\t\t\t\t\t\t\t\tv-model=\"localEdited[localeKey.localeKey]\"\n\t\t\t\t\t\t\t\t\t\trows=\"5\"\n\t\t\t\t\t\t\t\t\t\tcols=\"50\"\n\t\t\t\t\t\t\t\t\t\t:class=\"{ valueChanged : localEdited[localeKey.localeKey] != null}\"\n\t\t\t\t\t\t\t\t\t></textarea>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<div v-else>\n\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\t\t:id=\"'custom-text-' + index\"\n\t\t\t\t\t\t\t\t\t\t:name=\"'changes[' + localeKey.localeKey + ']'\"\n\t\t\t\t\t\t\t\t\t\tv-model=\"localEdited[localeKey.localeKey]\"\n\t\t\t\t\t\t\t\t\t\t:class=\"{ valueChanged : localEdited[localeKey.localeKey] != null}\"\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t</table>\n\t\t\t\t</td>\n\t\t\t</tr>\n\t\t</table>\n\n\t\t{* PAGINATION *}\n\t\t<nav role=\"navigation\" aria-label=\"{translate key='common.pagination.label'}\" class=\"pkpPagination\" v-if=\"lastPage > 1\">\n\t\t\t<ul>\n\t\t\t\t<li>\n\t\t\t\t\t<button \n\t\t\t\t\t\tclass=\"pkpButton\"\n\t\t\t\t\t\t:disabled=\"currentPage === 1 ? true : null\"\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t@click=\"() => (currentPage -= 1)\"\n\t\t\t\t\t\taria-label=\"{translate key='common.pagination.goToPage' page={translate key='common.pagination.previous'}}\"\n\t\t\t\t\t>\n\t\t\t\t\t\t{translate key=\"common.pagination.previous\"}\n\t\t\t\t\t</button>\n\t\t\t\t</li>\n\t\t\t\t<li v-for=\"(page, index) in pages\" :key=\"index\">\n\t\t\t\t\t<span\n\t\t\t\t\t\tv-if=\"page.isSeparator\"\n\t\t\t\t\t\tclass=\"pkpPagination__separator\"\n\t\t\t\t\t\t:aria-hidden=\"true\"\n\t\t\t\t\t>\n\t\t\t\t\t\t\u00b7\u00b7\u00b7\n\t\t\t\t\t</span>\n\t\t\t\t\t<button\n\t\t\t\t\t\tv-else\n\t\t\t\t\t\tclass=\"pkpButton\"\n\t\t\t\t\t\t:class=\"currentPage === page.value ? 'pkpButton--isActive' : 'pkpButton--isLink'\"\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t@click=\"() => (currentPage = page.value)\"\n\t\t\t\t\t\t:aria-label=\"'{translate key=\"common.pagination.goToPage\" page=\"{translate key='common.pageNumber' pageNumber=''}\"}' + page.value\"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{ page.value }}\n\t\t\t\t\t</button>\n\n\t\t\t\t</li>\n\t\t\t\t<li>\n\t\t\t\t\t<button\n\t\t\t\t\t\tclass=\"pkpButton\"\n\t\t\t\t\t\t:disabled=\"currentPage === lastPage ? true : null\"\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t@click=\"() => (currentPage += 1)\"\n\t\t\t\t\t\taria-label=\"{translate key='common.pagination.goToPage' page={translate key='common.pagination.next'}}\"\n\t\t\t\t\t>\n\t\t\t\t\t\t{translate key=\"common.pagination.next\"}\n\t\t\t\t\t</button>\n\t\t\t\t</li>\n\t\t\t</ul>\n\t\t</nav>\n\n\t\t{fbvFormButtons id=\"submitCustomLocaleFileTemplate\" submitText=\"plugins.generic.customLocale.saveAndContinue\"}\n\t</div>\n\t<script type=\"text/javascript\">\n\t\t$(function() {ldelim}\n\t\t\t// Attach the form handler.\n\t\t\t$('#localeFilesForm').pkpHandler('$.pkp.controllers.form.AjaxFormHandler');\n\t\t{rdelim});\n\t\t{if $localeContents}\n\t\t\tcustomLocalesApp.data.edited = {$localeContents|json_encode};\n\t\t{else}\n\t\t\tcustomLocalesApp.data.edited = {ldelim}{rdelim};\n\t\t{/if}\n\t\tcustomLocalesApp.data.localeKeysMaster = {$referenceLocaleContents|json_encode};\n\t\tnew pkp.Vue(customLocalesApp);\n\t</script>\n</form>\n"], "filenames": ["controllers/grid/CustomLocaleGridHandler.php", "templates/localeFile.tpl"], "buggy_code_start_loc": [75, 9], "buggy_code_end_loc": [75, 189], "fixing_code_start_loc": [76, 10], "fixing_code_end_loc": [78, 190], "type": "CWE-352", "message": "Cross-Site Request Forgery (CSRF) in GitHub repository pkp/customLocale prior to 1.2.0-1.", "other": {"cve": {"id": "CVE-2023-5897", "sourceIdentifier": "security@huntr.dev", "published": "2023-11-01T01:15:07.937", "lastModified": "2023-11-08T20:26:14.077", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Cross-Site Request Forgery (CSRF) in GitHub repository pkp/customLocale prior to 1.2.0-1."}, {"lang": "es", "value": "Cross-Site Request Forgery (CSRF) en el repositorio de GitHub pkp/customLocale anterior a 1.2.0-1."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 8.8, "baseSeverity": "HIGH"}, "exploitabilityScore": 2.8, "impactScore": 5.9}], "cvssMetricV30": [{"source": "security@huntr.dev", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:L/UI:R/S:U/C:H/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.3, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.1, "impactScore": 4.2}]}, "weaknesses": [{"source": "security@huntr.dev", "type": "Primary", "description": [{"lang": "en", "value": "CWE-352"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:sfu:customlocale:*:*:*:*:*:*:*:*", "versionEndExcluding": "1.2.0-1", "matchCriteriaId": "4EC7A09B-0417-4F3A-9391-45B1C7218486"}]}]}], "references": [{"url": "https://github.com/pkp/customLocale/commit/407ba30f12f78efe79122591c1d85709c10b6831", "source": "security@huntr.dev", "tags": ["Patch"]}, {"url": "https://huntr.com/bounties/7c215b8e-63f6-4146-b8e3-8482c731876f", "source": "security@huntr.dev", "tags": ["Exploit", "Issue Tracking", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/pkp/customLocale/commit/407ba30f12f78efe79122591c1d85709c10b6831"}}