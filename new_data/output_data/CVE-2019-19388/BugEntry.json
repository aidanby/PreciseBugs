{"buggy_code": ["<?php\n/*\n\tFusionPBX\n\tVersion: MPL 1.1\n\n\tThe contents of this file are subject to the Mozilla Public License Version\n\t1.1 (the \"License\"); you may not use this file except in compliance with\n\tthe License. You may obtain a copy of the License at\n\thttp://www.mozilla.org/MPL/\n\n\tSoftware distributed under the License is distributed on an \"AS IS\" basis,\n\tWITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n\tfor the specific language governing rights and limitations under the\n\tLicense.\n\n\tThe Original Code is FusionPBX\n\n\tThe Initial Developer of the Original Code is\n\tMark J Crane <markjcrane@fusionpbx.com>\n\tPortions created by the Initial Developer are Copyright (C) 2008-2013\n\tthe Initial Developer. All Rights Reserved.\n\n\tContributor(s):\n\tMark J Crane <markjcrane@fusionpbx.com>\n*/\ninclude \"root.php\";\nrequire_once \"resources/require.php\";\nrequire_once \"resources/check_auth.php\";\nif (permission_exists('dialplan_add')\n\t|| permission_exists('dialplan_edit')\n\t|| permission_exists('inbound_route_add')\n\t|| permission_exists('inbound_route_edit')\n\t|| permission_exists('outbound_route_add')\n\t|| permission_exists('outbound_route_edit')\n\t|| permission_exists('fifo_edit')\n\t|| permission_exists('fifo_add')\n\t|| permission_exists('time_condition_add')\n\t|| permission_exists('time_condition_edit')) {\n\t//access granted\n}\nelse {\n\techo \"access denied\";\n\texit;\n}\n\n//add multi-lingual support\n\t$language = new text;\n\t$text = $language->get();\n\n//set the action as an add or update\n\tif (is_uuid($_REQUEST[\"id\"])) {\n\t\t$action = \"update\";\n\t\t$dialplan_detail_uuid = $_REQUEST[\"id\"];\n\t}\n\telse {\n\t\t$action = \"add\";\n\t}\n\t$dialplan_uuid = $_REQUEST[\"dialplan_uuid\"];\n\n//get the http values and set them as php variables\n\t$app_uuid = $_REQUEST[\"app_uuid\"];\n\tif (count($_POST)>0) {\n\t\t$dialplan_uuid = $_POST[\"dialplan_uuid\"];\n\t\t$dialplan_detail_tag = $_POST[\"dialplan_detail_tag\"];\n\t\t$dialplan_detail_order = $_POST[\"dialplan_detail_order\"];\n\t\t$dialplan_detail_type = $_POST[\"dialplan_detail_type\"];\n\t\t$dialplan_detail_data = $_POST[\"dialplan_detail_data\"];\n\t\t$dialplan_detail_break = $_POST[\"dialplan_detail_break\"];\n\t\t$dialplan_detail_inline = $_POST[\"dialplan_detail_inline\"];\n\t\t$dialplan_detail_group = $_POST[\"dialplan_detail_group\"];\n\t}\n\nif (count($_POST)>0 && strlen($_POST[\"persistformvar\"]) == 0) {\n\n\t$msg = '';\n\tif ($action == \"update\") {\n\t\t$dialplan_detail_uuid = $_POST[\"dialplan_detail_uuid\"];\n\t}\n\n\t//validate the token\n\t\t$token = new token;\n\t\tif (!$token->validate($_SERVER['PHP_SELF'])) {\n\t\t\tmessage::add($text['message-invalid_token'],'negative');\n\t\t\theader('Location: dialplans.php');\n\t\t\texit;\n\t\t}\n\n\t//check for all required data\n\t\tif (strlen($dialplan_detail_tag) == 0) { $msg .= $text['message-required'].$text['label-tag'].\"<br>\\n\"; }\n\t\tif (strlen($dialplan_detail_order) == 0) { $msg .= $text['message-required'].$text['label-order'].\"<br>\\n\"; }\n\t\t//if (strlen($dialplan_detail_type) == 0) { $msg .= $text['message-required'].$text['label-type'].\"<br>\\n\"; }\n\t\t//if (strlen($dialplan_detail_data) == 0) { $msg .= $text['message-required'].$text['label-data'].\"<br>\\n\"; }\n\t\tif (strlen($msg) > 0 && strlen($_POST[\"persistformvar\"]) == 0) {\n\t\t\trequire_once \"resources/header.php\";\n\t\t\trequire_once \"resources/persist_form_var.php\";\n\t\t\techo \"<div align='center'>\\n\";\n\t\t\techo \"<table><tr><td>\\n\";\n\t\t\techo $msg.\"<br />\";\n\t\t\techo \"</td></tr></table>\\n\";\n\t\t\tpersistformvar($_POST);\n\t\t\techo \"</div>\\n\";\n\t\t\trequire_once \"resources/footer.php\";\n\t\t\treturn;\n\t\t}\n\n\t//add or update the database\n\t\tif ($_POST[\"persistformvar\"] != \"true\") {\n\t\t\tif ($action == \"add\" && permission_exists('dialplan_add')) {\n\t\t\t\t$dialplan_detail_uuid = uuid();\n\t\t\t\t$array['dialplan_details'][0]['dialplan_uuid'] = $dialplan_uuid;\n\t\t\t\t$array['dialplan_details'][0]['dialplan_detail_uuid'] = $dialplan_detail_uuid;\n\t\t\t\t$array['dialplan_details'][0]['dialplan_detail_tag'] = $dialplan_detail_tag;\n\t\t\t\t$array['dialplan_details'][0]['dialplan_detail_order'] = $dialplan_detail_order;\n\t\t\t\t$array['dialplan_details'][0]['dialplan_detail_type'] = $dialplan_detail_type;\n\t\t\t\t$array['dialplan_details'][0]['dialplan_detail_data'] = $dialplan_detail_data;\n\t\t\t\t$array['dialplan_details'][0]['dialplan_detail_break'] = $dialplan_detail_break;\n\t\t\t\t$array['dialplan_details'][0]['dialplan_detail_inline'] = $dialplan_detail_inline;\n\t\t\t\t$array['dialplan_details'][0]['dialplan_detail_group'] = $dialplan_detail_group != '' ? $dialplan_detail_group : null;\n\t\t\t\t$array['dialplan_details'][0]['domain_uuid'] = $_SESSION['domain_uuid'];\n\n\t\t\t\t$p = new permissions;\n\t\t\t\t$p->add('dialplan_detail_add', 'temp');\n\n\t\t\t\t$database = new database;\n\t\t\t\t$database->app_name = 'dialplans';\n\t\t\t\t$database->app_uuid = '742714e5-8cdf-32fd-462c-cbe7e3d655db';\n\t\t\t\t$database->save($array);\n\t\t\t\tunset($array);\n\n\t\t\t\t$p->delete('dialplan_detail_add', 'temp');\n\n\t\t\t\t//synchronize the xml config\n\t\t\t\tsave_dialplan_xml();\n\n\t\t\t\t//clear the cache\n\t\t\t\t$cache = new cache;\n\t\t\t\t$cache->delete(\"dialplan:\".$_SESSION[\"context\"]);\n\n\t\t\t\t//set the message and redirect the user\n\t\t\t\tmessage::add($text['message-add']);\n\t\t\t\theader(\"Location: dialplan_edit.php?id=\".$dialplan_uuid.\"&app_uuid=\".$app_uuid);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif ($action == \"update\" && permission_exists('dialplan_edit')) {\n\t\t\t\t$sql = \"update v_dialplan_details set \";\n\t\t\t\t$sql .= \"dialplan_uuid = :dialplan_uuid \";\n\t\t\t\t$sql .= \"dialplan_detail_tag = :dialplan_detail_tag, \";\n\t\t\t\t$sql .= \"dialplan_detail_order = :dialplan_detail_order, \";\n\t\t\t\t$sql .= \"dialplan_detail_type = :dialplan_detail_type, \";\n\t\t\t\t$sql .= \"dialplan_detail_data = :dialplan_detail_data, \";\n\t\t\t\t$sql .= \"dialplan_detail_break = :dialplan_detail_break, \";\n\t\t\t\t$sql .= \"dialplan_detail_inline = :dialplan_detail_inline, \";\n\t\t\t\t$sql .= \"dialplan_detail_group = :dialplan_detail_group \";\n\t\t\t\t$sql .= \"where (domain_uuid = :domain_uuid or domain_uuid is null) \";\n\t\t\t\t$sql .= \"and dialplan_detail_uuid = :dialplan_detail_uuid \";\n\t\t\t\t$parameters['dialplan_uuid'] = $dialplan_uuid;\n\t\t\t\t$parameters['dialplan_detail_tag'] = $dialplan_detail_tag;\n\t\t\t\t$parameters['dialplan_detail_order'] = $dialplan_detail_order;\n\t\t\t\t$parameters['dialplan_detail_type'] = $dialplan_detail_type;\n\t\t\t\t$parameters['dialplan_detail_data'] = $dialplan_detail_data;\n\t\t\t\t$parameters['dialplan_detail_break'] = $dialplan_detail_break;\n\t\t\t\t$parameters['dialplan_detail_inline'] = $dialplan_detail_inline;\n\t\t\t\t$parameters['dialplan_detail_group'] = $dialplan_detail_group != '' ? $dialplan_detail_group : null;\n\t\t\t\t$parameters['domain_uuid'] = $_SESSION['domain_uuid'];\n\t\t\t\t$parameters['dialplan_detail_uuid'] = $dialplan_detail_uuid;\n\t\t\t\t$database = new database;\n\t\t\t\t$database->execute($sql, $parameters);\n\t\t\t\tunset($sql, $parameters);\n\n\t\t\t\t//synchronize the xml config\n\t\t\t\tsave_dialplan_xml();\n\n\t\t\t\t//delete the dialplan context from memcache\n\t\t\t\t$fp = event_socket_create($_SESSION['event_socket_ip_address'], $_SESSION['event_socket_port'], $_SESSION['event_socket_password']);\n\t\t\t\tif ($fp) {\n\t\t\t\t\t$switch_cmd = \"memcache delete dialplan:\".$_SESSION[\"context\"].\"@\".$_SESSION['domain_name'];\n\t\t\t\t\t$switch_result = event_socket_request($fp, 'api '.$switch_cmd);\n\t\t\t\t}\n\n\t\t\t\tmessage::add($text['message-update']);\n\t\t\t\theader(\"Location: dialplan_edit.php?id=\".$dialplan_uuid.\"&app_uuid=\".$app_uuid);\n\t\t\t\treturn;\n\t\t   } //if ($action == \"update\")\n\t\t} //if ($_POST[\"persistformvar\"] != \"true\") {\n} //(count($_POST)>0 && strlen($_POST[\"persistformvar\"]) == 0)\n\n//pre-populate the form\n\tif (count($_GET)>0 && $_POST[\"persistformvar\"] != \"true\") {\n\t\t$dialplan_detail_uuid = $_GET[\"id\"];\n\t\t$sql = \"select * from v_dialplan_details \";\n\t\t$sql .= \"where domain_uuid = :domain_uuid \";\n\t\t$sql .= \"and dialplan_detail_uuid = :dialplan_detail_uuid \";\n\t\t$parameters['domain_uuid'] = $domain_uuid;\n\t\t$parameters['dialplan_detail_uuid'] = $dialplan_detail_uuid;\n\t\t$database = new database;\n\t\t$row = $database->select($sql, $parameters, 'row');\n\t\tif (is_array($row) && @sizeof($row) != 0) {\n\t\t\t$dialplan_uuid = $row[\"dialplan_uuid\"];\n\t\t\t$dialplan_detail_tag = $row[\"dialplan_detail_tag\"];\n\t\t\t$dialplan_detail_order = $row[\"dialplan_detail_order\"];\n\t\t\t$dialplan_detail_type = $row[\"dialplan_detail_type\"];\n\t\t\t$dialplan_detail_data = $row[\"dialplan_detail_data\"];\n\t\t\t$dialplan_detail_break = $row[\"dialplan_detail_break\"];\n\t\t\t$dialplan_detail_inline = $row[\"dialplan_detail_inline\"];\n\t\t\t$dialplan_detail_group = $row[\"dialplan_detail_group\"];\n\t\t}\n\t\tunset($sql, $parameters, $row);\n\t}\n\n//create token\n\t$object = new token;\n\t$token = $object->create($_SERVER['PHP_SELF']);\n\n//show the header\n\trequire_once \"resources/header.php\";\n\t$document['title'] = $text['title-dialplan_detail'];\n\n//show the content\n\techo \"<form method='post' name='frm' action=''>\\n\";\n\techo \"<table width='100%' border='0' cellpadding='0' cellspacing='0'>\\n\";\n\techo \"<tr>\\n\";\n\techo \"<td align='left' width='30%' nowrap=\\\"nowrap\\\"><span class=\\\"title\\\">\".$text['header-dialplan_detail'].\"</span></td>\\n\";\n\techo \"<td width='70%' align='right'><input type='button' class='btn' name='' alt='\".$text['button-back'].\"' onclick=\\\"window.location='dialplan_edit.php?id=\".$dialplan_uuid.\"&app_uuid=\".$app_uuid.\"';\\\" value='\".$text['button-back'].\"'></td>\\n\";\n\techo \"</tr>\\n\";\n\n\techo \"<tr>\\n\";\n\techo \"\t<td>\\n\";\n\techo \"\t\t&nbsp;\\n\";\n\techo \"\t</td>\\n\";\n\techo \"</tr>\\n\";\n\n\techo \"<tr>\\n\";\n\techo \"<td class='vncellreq' valign='top' align='left' nowrap>\\n\";\n\techo \"    \".$text['label-tag'].\"\\n\";\n\techo \"</td>\\n\";\n\techo \"<td class='vtable' align='left'>\\n\";\n\techo \"\t<select name='dialplan_detail_tag' class='formfld' id='form_tag'>\\n\";\n\techo \"\t<option></option>\\n\";\n\techo \"\t<option value='condition' \".($dialplan_detail_tag == \"condition\" ? $selected:\"\").\">\".$text['option-condition'].\"</option>\\n\";\n\techo \"\t<option value='regex' \".($dialplan_detail_tag == \"regex\" ? $selected:\"\").\">\".$text['option-regex'].\"</option>\\n\";\n\techo \"\t<option value='action' \".($dialplan_detail_tag == \"action\" ? $selected:\"\").\">\".$text['option-condition'].\"</option>\\n\";\n\techo \"\t<option value='anti-action' \".($dialplan_detail_tag == \"anti-action\" ? $selected:\"\").\">\".$text['option-condition'].\"</option>\\n\";\n\techo \"\t<option value='param' \".($dialplan_detail_tag == \"param\" ? $selected:\"\").\">\".$text['option-condition'].\"</option>\\n\";\n\techo \"\t<option value='condition' \".($dialplan_detail_tag == \"condition\" ? $selected:\"\").\">\".$text['option-condition'].\"</option>\\n\";\n\techo \"\t</select>\\n\";\n\techo \"<br />\\n\";\n\techo \"\\n\";\n\techo \"</td>\\n\";\n\techo \"</tr>\\n\";\n\n\techo \"<tr>\\n\";\n\techo \"<td class='vncellreq' valign='top' align='left' nowrap>\\n\";\n\techo \"    \".$text['label-order'].\"\\n\";\n\techo \"</td>\\n\";\n\techo \"<td class='vtable' align='left'>\\n\";\n\techo \"              <select name='dialplan_detail_order' class='formfld'>\\n\";\n\tif (strlen($dialplan_detail_order)> 0) {\n\t\techo \"              <option selected='selected' value='\".htmlspecialchars($dialplan_detail_order).\"'>\".htmlspecialchars($dialplan_detail_order).\"</option>\\n\";\n\t}\n\t$i=0;\n\twhile($i<=999) {\n\t\tif (strlen($i) == 1) {\n\t\t\techo \"              <option value='00$i'>00$i</option>\\n\";\n\t\t}\n\t\tif (strlen($i) == 2) {\n\t\t\techo \"              <option value='0$i'>0$i</option>\\n\";\n\t\t}\n\t\tif (strlen($i) == 3) {\n\t\t\techo \"              <option value='$i'>$i</option>\\n\";\n\t\t}\n\t\t$i++;\n\t}\n\techo \"              </select>\\n\";\n\techo \"<br />\\n\";\n\techo \"\\n\";\n\techo \"</td>\\n\";\n\techo \"</tr>\\n\";\n?>\n<script language=\"javascript\">\nvar Objs;\n\nfunction change_to_input(obj){\n\ttb=document.createElement('INPUT');\n\ttb.type='text';\n\ttb.name=obj.name;\n\ttb.className='formfld';\n\ttb.setAttribute('id', 'ivr_menu_option_param');\n\ttb.setAttribute('style', '');\n\ttb.value=obj.options[obj.selectedIndex].value;\n\tdocument.getElementById('btn_select_to_input_dialplan_detail_type').style.visibility = 'hidden';\n\ttbb=document.createElement('INPUT');\n\ttbb.setAttribute('class', 'btn');\n\ttbb.setAttribute('style', 'margin-left: 4px;');\n\ttbb.type='button';\n\ttbb.value=$(\"<div />\").html('&#9665;').text();\n\ttbb.objs=[obj,tb,tbb];\n\ttbb.onclick=function(){ replace_param(this.objs); }\n\tobj.parentNode.insertBefore(tb,obj);\n\tobj.parentNode.insertBefore(tbb,obj);\n\tobj.parentNode.removeChild(obj);\n\treplace_param(this.objs);\n}\n\nfunction replace_param(obj){\n\tobj[2].parentNode.insertBefore(obj[0],obj[2]);\n\tobj[0].parentNode.removeChild(obj[1]);\n\tobj[0].parentNode.removeChild(obj[2]);\n\tdocument.getElementById('btn_select_to_input_dialplan_detail_type').style.visibility = 'visible';\n}\n</script>\n<?php\n\techo \"<tr>\\n\";\n\techo \"<td class='vncell' valign='top' align='left' nowrap>\\n\";\n\techo \"    \".$text['label-type'].\"\\n\";\n\techo \"</td>\\n\";\n\techo \"<td class='vtable' align='left'>\\n\";\n\techo \"<select name='dialplan_detail_type' id='dialplan_detail_type' class='formfld' onchange='change_to_input(this);'>\\n\";\n\tif (strlen($dialplan_detail_type) > 0) {\n\t\techo \"<optgroup label='selected'>\\n\";\n\t\techo \"\t<option value='\".htmlspecialchars($dialplan_detail_type).\"'>\".htmlspecialchars($dialplan_detail_type).\"</option>\\n\";\n\t\techo \"</optgroup>\\n\";\n\t}\n\telse {\n\t\techo \"\t<option value=''></option>\\n\";\n\t}\n\tif (strlen($dialplan_detail_tag) == 0 || $dialplan_detail_tag == \"condition\" || $dialplan_detail_tag == \"regex\") {\n\t\techo \"\t<optgroup label='\".$text['optgroup-conditions_or_regular_expressions'].\"'>\\n\";\n\t\techo \"\t<option value='context'>\".$text['option-context'].\"</option>\\n\";\n\t\techo \"\t<option value='username'>\".$text['option-username'].\"</option>\\n\";\n\t\techo \"\t<option value='rdnis'>\".$text['option-rdnis'].\"</option>\\n\";\n\t\techo \"\t<option value='destination_number'>\".$text['option-destination_number'].\"</option>\\n\";\n\t\techo \"\t<option value='dialplan'>\".$text['option-dialplan'].\"</option>\\n\";\n\t\techo \"\t<option value='caller_id_name'>\".$text['option-caller_id_name'].\"</option>\\n\";\n\t\techo \"\t<option value='caller_id_number'>\".$text['option-caller_id_number'].\"</option>\\n\";\n\t\techo \"\t<option value='ani'>\".$text['option-ani'].\"</option>\\n\";\n\t\techo \"\t<option value='ani2'>\".$text['option-ani2'].\"</option>\\n\";\n\t\techo \"\t<option value='uuid'>\".$text['option-uuid'].\"</option>\\n\";\n\t\techo \"\t<option value='source'>\".$text['option-source'].\"</option>\\n\";\n\t\techo \"\t<option value='chan_name'>\".$text['option-chan_name'].\"</option>\\n\";\n\t\techo \"\t<option value='network_addr'>\".$text['option-network_addr'].\"</option>\\n\";\n\t\techo \"\t<option value='\\${number_alias}'>\\${number_alias}</option>\\n\";\n\t\techo \"\t<option value='\\${sip_from_uri}'>\\${sip_from_uri}</option>\\n\";\n\t\techo \"\t<option value='\\${sip_from_user}'>\\${sip_from_user}</option>\\n\";\n\t\techo \"\t<option value='\\${sip_from_host}'>\\${sip_from_host}</option>\\n\";\n\t\techo \"\t<option value='\\${sip_contact_uri}'>\\${sip_contact_uri}</option>\\n\";\n\t\techo \"\t<option value='\\${sip_contact_user}'>\\${sip_contact_user}</option>\\n\";\n\t\techo \"\t<option value='\\${sip_contact_host}'>\\${sip_contact_host}</option>\\n\";\n\t\techo \"\t<option value='\\${sip_to_uri}'>\\${sip_to_uri}</option>\\n\";\n\t\techo \"\t<option value='\\${sip_to_user}'>\\${sip_to_user}</option>\\n\";\n\t\techo \"\t<option value='\\${sip_to_host}'>\\${sip_to_host}</option>\\n\";\n\t\techo \"  <option value='\\${sip_h_Diversion}'>\\${sip_h_Diversion}</option>\\n\";\n\t\techo \"</optgroup>\\n\";\n\t}\n\tif (strlen($dialplan_detail_tag) == 0 || $dialplan_detail_tag == \"action\" || $dialplan_detail_tag == \"anti-action\") {\n\t\techo \"<optgroup label='\".$text['optgroup-applications'].\"'>\\n\";\n\t\t//get the list of applications\n\t\t$fp = event_socket_create($_SESSION['event_socket_ip_address'], $_SESSION['event_socket_port'], $_SESSION['event_socket_password']);\n\t\t$result = event_socket_request($fp, 'api show application');\n\t\t$tmp = explode(\"\\n\\n\", $result);\n\t\t$tmp = explode(\"\\n\", $tmp[0]);\n\t\tforeach ($tmp as $row) {\n\t\t\tif (strlen($row) > 0) {\n\t\t\t\t$application = explode(\",\", $row);\n\t\t\t\tif ($application[0] != \"name\" && stristr($application[0], \"[\") != true) {\n\t\t\t\t\techo \"\t<option value='\".$application[0].\"'>\".$application[0].\"</option>\\n\";\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\techo \"</optgroup>\\n\";\n\t}\n\techo \"<input type='button' id='btn_select_to_input_dialplan_detail_type' class='btn' name='' alt='\".$text['button-back'].\"' onclick='change_to_input(document.getElementById(\\\"dialplan_detail_type\\\"));this.style.visibility = \\\"hidden\\\";' value='&#9665;'>\\n\";\n\techo \"</td>\\n\";\n\techo \"</tr>\\n\";\n\n\techo \"<tr>\\n\";\n\techo \"<td class='vncell' valign='top' align='left' nowrap>\\n\";\n\techo \"    \".$text['label-data'].\"\\n\";\n\techo \"</td>\\n\";\n\techo \"<td class='vtable' align='left'>\\n\";\n\techo \"    <input class='formfld' type='text' name='dialplan_detail_data' value=\\\"\".htmlspecialchars($dialplan_detail_data).\"\\\">\\n\";\n\techo \"<br />\\n\";\n\techo \"\\n\";\n\techo \"</td>\\n\";\n\techo \"</tr>\\n\";\n\n\techo \"<tr>\\n\";\n\techo \"<td class='vncell' valign='top' align='left' nowrap>\\n\";\n\techo \"    \".$text['label-group'].\"\\n\";\n\techo \"</td>\\n\";\n\techo \"<td class='vtable' align='left'>\\n\";\n\techo \"              <select name='dialplan_detail_group' class='formfld'>\\n\";\n\techo \"              <option value=''></option>\\n\";\n\tif (strlen($dialplan_detail_group)> 0) {\n\t\techo \"              <option selected='selected' value='\".htmlspecialchars($dialplan_detail_group).\"'>\".htmlspecialchars($dialplan_detail_group).\"</option>\\n\";\n\t}\n\t$i=0;\n\twhile($i<=999) {\n\t\techo \"              <option value='$i'>$i</option>\\n\";\n\t\t$i++;\n\t}\n\techo \"              </select>\\n\";\n\techo \"<br />\\n\";\n\techo \"\\n\";\n\techo \"</td>\\n\";\n\techo \"</tr>\\n\";\n\n\tif ($action == \"update\") {\n\t\tif ($dialplan_detail_tag == \"condition\") {\n\t\t\techo \"<tr>\\n\";\n\t\t\techo \"<td class='vncell' valign='top' align='left' nowrap>\\n\";\n\t\t\techo \"    \".$text['label-break'].\"\\n\";\n\t\t\techo \"</td>\\n\";\n\t\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\t\techo \"              <select name='dialplan_detail_break' class='formfld'>\\n\";\n\t\t\techo \"              <option></option>\\n\";\n\t\t\tif ($dialplan_detail_break == \"on-true\") {\n\t\t\t\techo \"              <option selected='selected' value='on-true'>\".$text['option-on_true'].\"</option>\\n\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\techo \"              <option value='on-true'>\".$text['option-on_true'].\"</option>\\n\";\n\t\t\t}\n\t\t\tif ($dialplan_detail_break == \"on-false\") {\n\t\t\t\techo \"              <option selected='selected' value='on-false'>\".$text['option-on_false'].\"</option>\\n\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\techo \"              <option value='on-false'>\".$text['option-on_false'].\"</option>\\n\";\n\t\t\t}\n\t\t\tif ($dialplan_detail_break == \"always\") {\n\t\t\t\techo \"              <option selected='selected' value='always'>\".$text['option-always'].\"</option>\\n\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\techo \"              <option value='always'>\".$text['option-always'].\"</option>\\n\";\n\t\t\t}\n\t\t\tif ($dialplan_detail_break == \"never\") {\n\t\t\t\techo \"              <option selected='selected' value='never'>\".$text['option-never'].\"</option>\\n\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\techo \"              <option value='never'>\".$text['option-never'].\"</option>\\n\";\n\t\t\t}\n\t\t\techo \"              </select>\\n\";\n\t\t\techo \"<br />\\n\";\n\t\t\techo \"\\n\";\n\t\t\techo \"</td>\\n\";\n\t\t\techo \"</tr>\\n\";\n\t\t}\n\n\t\tif ($dialplan_detail_tag == \"action\") {\n\t\t\techo \"<tr>\\n\";\n\t\t\techo \"<td class='vncell' valign='top' align='left' nowrap>\\n\";\n\t\t\techo \"    \".$text['label-inline'].\"\\n\";\n\t\t\techo \"</td>\\n\";\n\t\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\t\techo \"              <select name='dialplan_detail_inline' class='formfld'>\\n\";\n\t\t\techo \"              <option></option>\\n\";\n\t\t\tif ($dialplan_detail_inline == \"true\") {\n\t\t\t\techo \"              <option selected='selected' value='true'>\".$text['option-true'].\"</option>\\n\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\techo \"              <option value='true'>\".$text['option-true'].\"</option>\\n\";\n\t\t\t}\n\t\t\tif ($dialplan_detail_inline == \"false\") {\n\t\t\t\techo \"              <option selected='selected' value='false'>\".$text['option-false'].\"</option>\\n\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\techo \"              <option value='false'>\".$text['option-false'].\"</option>\\n\";\n\t\t\t}\n\t\t\techo \"              </select>\\n\";\n\t\t\techo \"<br />\\n\";\n\t\t\techo \"\\n\";\n\t\t\techo \"</td>\\n\";\n\t\t\techo \"</tr>\\n\";\n\t\t}\n\t}\n\n\techo \"\t<tr>\\n\";\n\techo \"\t\t<td colspan='2' align='right'>\\n\";\n\techo \"\t\t\t<input type='hidden' name='dialplan_uuid' value='$dialplan_uuid'>\\n\";\n\techo \"\t\t\t<input type='hidden' name='app_uuid' value='$app_uuid'>\\n\";\n\tif ($action == \"update\") {\n\t\techo \"\t\t<input type='hidden' name='dialplan_detail_uuid' value='$dialplan_detail_uuid'>\\n\";\n\t}\n\techo \"\t\t\t<input type='hidden' name='\".$token['name'].\"' value='\".$token['hash'].\"'>\\n\";\n\techo \"\t\t\t<br>\";\n\techo \"\t\t\t<input type='submit' name='submit' class='btn' value='\".$text['button-save'].\"'>\\n\";\n\techo \"\t\t</td>\\n\";\n\techo \"\t</tr>\";\n\techo \"</table>\";\n\techo \"<br><br>\";\n\techo \"</form>\";\n\n//include the footer\n\trequire_once \"resources/footer.php\";\n?>\n"], "fixing_code": ["<?php\n/*\n\tFusionPBX\n\tVersion: MPL 1.1\n\n\tThe contents of this file are subject to the Mozilla Public License Version\n\t1.1 (the \"License\"); you may not use this file except in compliance with\n\tthe License. You may obtain a copy of the License at\n\thttp://www.mozilla.org/MPL/\n\n\tSoftware distributed under the License is distributed on an \"AS IS\" basis,\n\tWITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n\tfor the specific language governing rights and limitations under the\n\tLicense.\n\n\tThe Original Code is FusionPBX\n\n\tThe Initial Developer of the Original Code is\n\tMark J Crane <markjcrane@fusionpbx.com>\n\tPortions created by the Initial Developer are Copyright (C) 2008-2019\n\tthe Initial Developer. All Rights Reserved.\n\n\tContributor(s):\n\tMark J Crane <markjcrane@fusionpbx.com>\n*/\n\n//includes\n\tinclude \"root.php\";\n\trequire_once \"resources/require.php\";\n\trequire_once \"resources/check_auth.php\";\n\n//check permisions\n\tif (permission_exists('dialplan_add')\n\t\t|| permission_exists('dialplan_edit')\n\t\t|| permission_exists('inbound_route_add')\n\t\t|| permission_exists('inbound_route_edit')\n\t\t|| permission_exists('outbound_route_add')\n\t\t|| permission_exists('outbound_route_edit')\n\t\t|| permission_exists('fifo_edit')\n\t\t|| permission_exists('fifo_add')\n\t\t|| permission_exists('time_condition_add')\n\t\t|| permission_exists('time_condition_edit')) {\n\t\t//access granted\n\t}\n\telse {\n\t\techo \"access denied\";\n\t\texit;\n\t}\n\n//add multi-lingual support\n\t$language = new text;\n\t$text = $language->get();\n\n//set the action as an add or update\n\tif (is_uuid($_REQUEST[\"id\"])) {\n\t\t$action = \"update\";\n\t\t$dialplan_detail_uuid = $_REQUEST[\"id\"];\n\t}\n\telse {\n\t\t$action = \"add\";\n\t}\n\n//get the http values and set them as php variables\n\tif (count($_POST) > 0) {\n\t\t$dialplan_uuid = $_POST[\"dialplan_uuid\"];\n\t\t$dialplan_detail_tag = $_POST[\"dialplan_detail_tag\"];\n\t\t$dialplan_detail_order = $_POST[\"dialplan_detail_order\"];\n\t\t$dialplan_detail_type = $_POST[\"dialplan_detail_type\"];\n\t\t$dialplan_detail_data = $_POST[\"dialplan_detail_data\"];\n\t\t$dialplan_detail_break = $_POST[\"dialplan_detail_break\"];\n\t\t$dialplan_detail_inline = $_POST[\"dialplan_detail_inline\"];\n\t\t$dialplan_detail_group = $_POST[\"dialplan_detail_group\"];\n\t}\n\tif (is_uuid($_REQUEST[\"app_uuid\"])) {\n\t\t$app_uuid = $_REQUEST[\"app_uuid\"];\n\t}\n\tif (is_uuid($_REQUEST[\"dialplan_uuid\"])) {\n\t\t$dialplan_uuid = $_REQUEST[\"dialplan_uuid\"];\n\t}\n\nif (count($_POST)>0 && strlen($_POST[\"persistformvar\"]) == 0) {\n\n\t$msg = '';\n\tif ($action == \"update\") {\n\t\t$dialplan_detail_uuid = $_POST[\"dialplan_detail_uuid\"];\n\t}\n\n\t//validate the token\n\t\t$token = new token;\n\t\tif (!$token->validate($_SERVER['PHP_SELF'])) {\n\t\t\tmessage::add($text['message-invalid_token'],'negative');\n\t\t\theader('Location: dialplans.php');\n\t\t\texit;\n\t\t}\n\n\t//check for all required data\n\t\tif (strlen($dialplan_detail_tag) == 0) { $msg .= $text['message-required'].$text['label-tag'].\"<br>\\n\"; }\n\t\tif (strlen($dialplan_detail_order) == 0) { $msg .= $text['message-required'].$text['label-order'].\"<br>\\n\"; }\n\t\t//if (strlen($dialplan_detail_type) == 0) { $msg .= $text['message-required'].$text['label-type'].\"<br>\\n\"; }\n\t\t//if (strlen($dialplan_detail_data) == 0) { $msg .= $text['message-required'].$text['label-data'].\"<br>\\n\"; }\n\t\tif (strlen($msg) > 0 && strlen($_POST[\"persistformvar\"]) == 0) {\n\t\t\trequire_once \"resources/header.php\";\n\t\t\trequire_once \"resources/persist_form_var.php\";\n\t\t\techo \"<div align='center'>\\n\";\n\t\t\techo \"<table><tr><td>\\n\";\n\t\t\techo $msg.\"<br />\";\n\t\t\techo \"</td></tr></table>\\n\";\n\t\t\tpersistformvar($_POST);\n\t\t\techo \"</div>\\n\";\n\t\t\trequire_once \"resources/footer.php\";\n\t\t\treturn;\n\t\t}\n\n\t//add or update the database\n\t\tif ($_POST[\"persistformvar\"] != \"true\") {\n\t\t\tif ($action == \"add\" && permission_exists('dialplan_add')) {\n\t\t\t\t$dialplan_detail_uuid = uuid();\n\t\t\t\t$array['dialplan_details'][0]['dialplan_uuid'] = $dialplan_uuid;\n\t\t\t\t$array['dialplan_details'][0]['dialplan_detail_uuid'] = $dialplan_detail_uuid;\n\t\t\t\t$array['dialplan_details'][0]['dialplan_detail_tag'] = $dialplan_detail_tag;\n\t\t\t\t$array['dialplan_details'][0]['dialplan_detail_order'] = $dialplan_detail_order;\n\t\t\t\t$array['dialplan_details'][0]['dialplan_detail_type'] = $dialplan_detail_type;\n\t\t\t\t$array['dialplan_details'][0]['dialplan_detail_data'] = $dialplan_detail_data;\n\t\t\t\t$array['dialplan_details'][0]['dialplan_detail_break'] = $dialplan_detail_break;\n\t\t\t\t$array['dialplan_details'][0]['dialplan_detail_inline'] = $dialplan_detail_inline;\n\t\t\t\t$array['dialplan_details'][0]['dialplan_detail_group'] = $dialplan_detail_group != '' ? $dialplan_detail_group : null;\n\t\t\t\t$array['dialplan_details'][0]['domain_uuid'] = $_SESSION['domain_uuid'];\n\n\t\t\t\t$p = new permissions;\n\t\t\t\t$p->add('dialplan_detail_add', 'temp');\n\n\t\t\t\t$database = new database;\n\t\t\t\t$database->app_name = 'dialplans';\n\t\t\t\t$database->app_uuid = '742714e5-8cdf-32fd-462c-cbe7e3d655db';\n\t\t\t\t$database->save($array);\n\t\t\t\tunset($array);\n\n\t\t\t\t$p->delete('dialplan_detail_add', 'temp');\n\n\t\t\t\t//synchronize the xml config\n\t\t\t\tsave_dialplan_xml();\n\n\t\t\t\t//clear the cache\n\t\t\t\t$cache = new cache;\n\t\t\t\t$cache->delete(\"dialplan:\".$_SESSION[\"context\"]);\n\n\t\t\t\t//set the message and redirect the user\n\t\t\t\tmessage::add($text['message-add']);\n\t\t\t\theader(\"Location: dialplan_edit.php?id=\".$dialplan_uuid.\"&app_uuid=\".$app_uuid);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif ($action == \"update\" && permission_exists('dialplan_edit')) {\n\t\t\t\t$sql = \"update v_dialplan_details set \";\n\t\t\t\t$sql .= \"dialplan_uuid = :dialplan_uuid \";\n\t\t\t\t$sql .= \"dialplan_detail_tag = :dialplan_detail_tag, \";\n\t\t\t\t$sql .= \"dialplan_detail_order = :dialplan_detail_order, \";\n\t\t\t\t$sql .= \"dialplan_detail_type = :dialplan_detail_type, \";\n\t\t\t\t$sql .= \"dialplan_detail_data = :dialplan_detail_data, \";\n\t\t\t\t$sql .= \"dialplan_detail_break = :dialplan_detail_break, \";\n\t\t\t\t$sql .= \"dialplan_detail_inline = :dialplan_detail_inline, \";\n\t\t\t\t$sql .= \"dialplan_detail_group = :dialplan_detail_group \";\n\t\t\t\t$sql .= \"where (domain_uuid = :domain_uuid or domain_uuid is null) \";\n\t\t\t\t$sql .= \"and dialplan_detail_uuid = :dialplan_detail_uuid \";\n\t\t\t\t$parameters['dialplan_uuid'] = $dialplan_uuid;\n\t\t\t\t$parameters['dialplan_detail_tag'] = $dialplan_detail_tag;\n\t\t\t\t$parameters['dialplan_detail_order'] = $dialplan_detail_order;\n\t\t\t\t$parameters['dialplan_detail_type'] = $dialplan_detail_type;\n\t\t\t\t$parameters['dialplan_detail_data'] = $dialplan_detail_data;\n\t\t\t\t$parameters['dialplan_detail_break'] = $dialplan_detail_break;\n\t\t\t\t$parameters['dialplan_detail_inline'] = $dialplan_detail_inline;\n\t\t\t\t$parameters['dialplan_detail_group'] = $dialplan_detail_group != '' ? $dialplan_detail_group : null;\n\t\t\t\t$parameters['domain_uuid'] = $_SESSION['domain_uuid'];\n\t\t\t\t$parameters['dialplan_detail_uuid'] = $dialplan_detail_uuid;\n\t\t\t\t$database = new database;\n\t\t\t\t$database->execute($sql, $parameters);\n\t\t\t\tunset($sql, $parameters);\n\n\t\t\t\t//synchronize the xml config\n\t\t\t\tsave_dialplan_xml();\n\n\t\t\t\t//delete the dialplan context from memcache\n\t\t\t\t$fp = event_socket_create($_SESSION['event_socket_ip_address'], $_SESSION['event_socket_port'], $_SESSION['event_socket_password']);\n\t\t\t\tif ($fp) {\n\t\t\t\t\t$switch_cmd = \"memcache delete dialplan:\".$_SESSION[\"context\"].\"@\".$_SESSION['domain_name'];\n\t\t\t\t\t$switch_result = event_socket_request($fp, 'api '.$switch_cmd);\n\t\t\t\t}\n\n\t\t\t\tmessage::add($text['message-update']);\n\t\t\t\theader(\"Location: dialplan_edit.php?id=\".$dialplan_uuid.\"&app_uuid=\".$app_uuid);\n\t\t\t\treturn;\n\t\t   } //if ($action == \"update\")\n\t\t} //if ($_POST[\"persistformvar\"] != \"true\") {\n} //(count($_POST)>0 && strlen($_POST[\"persistformvar\"]) == 0)\n\n//pre-populate the form\n\tif (count($_GET)>0 && $_POST[\"persistformvar\"] != \"true\") {\n\t\t$dialplan_detail_uuid = $_GET[\"id\"];\n\t\t$sql = \"select * from v_dialplan_details \";\n\t\t$sql .= \"where domain_uuid = :domain_uuid \";\n\t\t$sql .= \"and dialplan_detail_uuid = :dialplan_detail_uuid \";\n\t\t$parameters['domain_uuid'] = $domain_uuid;\n\t\t$parameters['dialplan_detail_uuid'] = $dialplan_detail_uuid;\n\t\t$database = new database;\n\t\t$row = $database->select($sql, $parameters, 'row');\n\t\tif (is_array($row) && @sizeof($row) != 0) {\n\t\t\t$dialplan_uuid = $row[\"dialplan_uuid\"];\n\t\t\t$dialplan_detail_tag = $row[\"dialplan_detail_tag\"];\n\t\t\t$dialplan_detail_order = $row[\"dialplan_detail_order\"];\n\t\t\t$dialplan_detail_type = $row[\"dialplan_detail_type\"];\n\t\t\t$dialplan_detail_data = $row[\"dialplan_detail_data\"];\n\t\t\t$dialplan_detail_break = $row[\"dialplan_detail_break\"];\n\t\t\t$dialplan_detail_inline = $row[\"dialplan_detail_inline\"];\n\t\t\t$dialplan_detail_group = $row[\"dialplan_detail_group\"];\n\t\t}\n\t\tunset($sql, $parameters, $row);\n\t}\n\n//create token\n\t$object = new token;\n\t$token = $object->create($_SERVER['PHP_SELF']);\n\n//show the header\n\trequire_once \"resources/header.php\";\n\t$document['title'] = $text['title-dialplan_detail'];\n\n//show the content\n\techo \"<form method='post' name='frm' action=''>\\n\";\n\techo \"<table width='100%' border='0' cellpadding='0' cellspacing='0'>\\n\";\n\techo \"<tr>\\n\";\n\techo \"<td align='left' width='30%' nowrap=\\\"nowrap\\\"><span class=\\\"title\\\">\".$text['header-dialplan_detail'].\"</span></td>\\n\";\n\techo \"<td width='70%' align='right'><input type='button' class='btn' name='' alt='\".$text['button-back'].\"' onclick=\\\"window.location='dialplan_edit.php?id=\".$dialplan_uuid.\"&app_uuid=\".$app_uuid.\"';\\\" value='\".$text['button-back'].\"'></td>\\n\";\n\techo \"</tr>\\n\";\n\n\techo \"<tr>\\n\";\n\techo \"\t<td>\\n\";\n\techo \"\t\t&nbsp;\\n\";\n\techo \"\t</td>\\n\";\n\techo \"</tr>\\n\";\n\n\techo \"<tr>\\n\";\n\techo \"<td class='vncellreq' valign='top' align='left' nowrap>\\n\";\n\techo \"    \".$text['label-tag'].\"\\n\";\n\techo \"</td>\\n\";\n\techo \"<td class='vtable' align='left'>\\n\";\n\techo \"\t<select name='dialplan_detail_tag' class='formfld' id='form_tag'>\\n\";\n\techo \"\t<option></option>\\n\";\n\techo \"\t<option value='condition' \".($dialplan_detail_tag == \"condition\" ? $selected:\"\").\">\".$text['option-condition'].\"</option>\\n\";\n\techo \"\t<option value='regex' \".($dialplan_detail_tag == \"regex\" ? $selected:\"\").\">\".$text['option-regex'].\"</option>\\n\";\n\techo \"\t<option value='action' \".($dialplan_detail_tag == \"action\" ? $selected:\"\").\">\".$text['option-condition'].\"</option>\\n\";\n\techo \"\t<option value='anti-action' \".($dialplan_detail_tag == \"anti-action\" ? $selected:\"\").\">\".$text['option-condition'].\"</option>\\n\";\n\techo \"\t<option value='param' \".($dialplan_detail_tag == \"param\" ? $selected:\"\").\">\".$text['option-condition'].\"</option>\\n\";\n\techo \"\t<option value='condition' \".($dialplan_detail_tag == \"condition\" ? $selected:\"\").\">\".$text['option-condition'].\"</option>\\n\";\n\techo \"\t</select>\\n\";\n\techo \"<br />\\n\";\n\techo \"\\n\";\n\techo \"</td>\\n\";\n\techo \"</tr>\\n\";\n\n\techo \"<tr>\\n\";\n\techo \"<td class='vncellreq' valign='top' align='left' nowrap>\\n\";\n\techo \"    \".$text['label-order'].\"\\n\";\n\techo \"</td>\\n\";\n\techo \"<td class='vtable' align='left'>\\n\";\n\techo \"              <select name='dialplan_detail_order' class='formfld'>\\n\";\n\tif (strlen($dialplan_detail_order)> 0) {\n\t\techo \"              <option selected='selected' value='\".htmlspecialchars($dialplan_detail_order).\"'>\".htmlspecialchars($dialplan_detail_order).\"</option>\\n\";\n\t}\n\t$i=0;\n\twhile($i<=999) {\n\t\tif (strlen($i) == 1) {\n\t\t\techo \"              <option value='00$i'>00$i</option>\\n\";\n\t\t}\n\t\tif (strlen($i) == 2) {\n\t\t\techo \"              <option value='0$i'>0$i</option>\\n\";\n\t\t}\n\t\tif (strlen($i) == 3) {\n\t\t\techo \"              <option value='$i'>$i</option>\\n\";\n\t\t}\n\t\t$i++;\n\t}\n\techo \"              </select>\\n\";\n\techo \"<br />\\n\";\n\techo \"\\n\";\n\techo \"</td>\\n\";\n\techo \"</tr>\\n\";\n?>\n<script language=\"javascript\">\nvar Objs;\n\nfunction change_to_input(obj){\n\ttb=document.createElement('INPUT');\n\ttb.type='text';\n\ttb.name=obj.name;\n\ttb.className='formfld';\n\ttb.setAttribute('id', 'ivr_menu_option_param');\n\ttb.setAttribute('style', '');\n\ttb.value=obj.options[obj.selectedIndex].value;\n\tdocument.getElementById('btn_select_to_input_dialplan_detail_type').style.visibility = 'hidden';\n\ttbb=document.createElement('INPUT');\n\ttbb.setAttribute('class', 'btn');\n\ttbb.setAttribute('style', 'margin-left: 4px;');\n\ttbb.type='button';\n\ttbb.value=$(\"<div />\").html('&#9665;').text();\n\ttbb.objs=[obj,tb,tbb];\n\ttbb.onclick=function(){ replace_param(this.objs); }\n\tobj.parentNode.insertBefore(tb,obj);\n\tobj.parentNode.insertBefore(tbb,obj);\n\tobj.parentNode.removeChild(obj);\n\treplace_param(this.objs);\n}\n\nfunction replace_param(obj){\n\tobj[2].parentNode.insertBefore(obj[0],obj[2]);\n\tobj[0].parentNode.removeChild(obj[1]);\n\tobj[0].parentNode.removeChild(obj[2]);\n\tdocument.getElementById('btn_select_to_input_dialplan_detail_type').style.visibility = 'visible';\n}\n</script>\n<?php\n\techo \"<tr>\\n\";\n\techo \"<td class='vncell' valign='top' align='left' nowrap>\\n\";\n\techo \"    \".$text['label-type'].\"\\n\";\n\techo \"</td>\\n\";\n\techo \"<td class='vtable' align='left'>\\n\";\n\techo \"<select name='dialplan_detail_type' id='dialplan_detail_type' class='formfld' onchange='change_to_input(this);'>\\n\";\n\tif (strlen($dialplan_detail_type) > 0) {\n\t\techo \"<optgroup label='selected'>\\n\";\n\t\techo \"\t<option value='\".htmlspecialchars($dialplan_detail_type).\"'>\".htmlspecialchars($dialplan_detail_type).\"</option>\\n\";\n\t\techo \"</optgroup>\\n\";\n\t}\n\telse {\n\t\techo \"\t<option value=''></option>\\n\";\n\t}\n\tif (strlen($dialplan_detail_tag) == 0 || $dialplan_detail_tag == \"condition\" || $dialplan_detail_tag == \"regex\") {\n\t\techo \"\t<optgroup label='\".$text['optgroup-conditions_or_regular_expressions'].\"'>\\n\";\n\t\techo \"\t<option value='context'>\".$text['option-context'].\"</option>\\n\";\n\t\techo \"\t<option value='username'>\".$text['option-username'].\"</option>\\n\";\n\t\techo \"\t<option value='rdnis'>\".$text['option-rdnis'].\"</option>\\n\";\n\t\techo \"\t<option value='destination_number'>\".$text['option-destination_number'].\"</option>\\n\";\n\t\techo \"\t<option value='dialplan'>\".$text['option-dialplan'].\"</option>\\n\";\n\t\techo \"\t<option value='caller_id_name'>\".$text['option-caller_id_name'].\"</option>\\n\";\n\t\techo \"\t<option value='caller_id_number'>\".$text['option-caller_id_number'].\"</option>\\n\";\n\t\techo \"\t<option value='ani'>\".$text['option-ani'].\"</option>\\n\";\n\t\techo \"\t<option value='ani2'>\".$text['option-ani2'].\"</option>\\n\";\n\t\techo \"\t<option value='uuid'>\".$text['option-uuid'].\"</option>\\n\";\n\t\techo \"\t<option value='source'>\".$text['option-source'].\"</option>\\n\";\n\t\techo \"\t<option value='chan_name'>\".$text['option-chan_name'].\"</option>\\n\";\n\t\techo \"\t<option value='network_addr'>\".$text['option-network_addr'].\"</option>\\n\";\n\t\techo \"\t<option value='\\${number_alias}'>\\${number_alias}</option>\\n\";\n\t\techo \"\t<option value='\\${sip_from_uri}'>\\${sip_from_uri}</option>\\n\";\n\t\techo \"\t<option value='\\${sip_from_user}'>\\${sip_from_user}</option>\\n\";\n\t\techo \"\t<option value='\\${sip_from_host}'>\\${sip_from_host}</option>\\n\";\n\t\techo \"\t<option value='\\${sip_contact_uri}'>\\${sip_contact_uri}</option>\\n\";\n\t\techo \"\t<option value='\\${sip_contact_user}'>\\${sip_contact_user}</option>\\n\";\n\t\techo \"\t<option value='\\${sip_contact_host}'>\\${sip_contact_host}</option>\\n\";\n\t\techo \"\t<option value='\\${sip_to_uri}'>\\${sip_to_uri}</option>\\n\";\n\t\techo \"\t<option value='\\${sip_to_user}'>\\${sip_to_user}</option>\\n\";\n\t\techo \"\t<option value='\\${sip_to_host}'>\\${sip_to_host}</option>\\n\";\n\t\techo \"  <option value='\\${sip_h_Diversion}'>\\${sip_h_Diversion}</option>\\n\";\n\t\techo \"</optgroup>\\n\";\n\t}\n\tif (strlen($dialplan_detail_tag) == 0 || $dialplan_detail_tag == \"action\" || $dialplan_detail_tag == \"anti-action\") {\n\t\techo \"<optgroup label='\".$text['optgroup-applications'].\"'>\\n\";\n\t\t//get the list of applications\n\t\t$fp = event_socket_create($_SESSION['event_socket_ip_address'], $_SESSION['event_socket_port'], $_SESSION['event_socket_password']);\n\t\t$result = event_socket_request($fp, 'api show application');\n\t\t$tmp = explode(\"\\n\\n\", $result);\n\t\t$tmp = explode(\"\\n\", $tmp[0]);\n\t\tforeach ($tmp as $row) {\n\t\t\tif (strlen($row) > 0) {\n\t\t\t\t$application = explode(\",\", $row);\n\t\t\t\tif ($application[0] != \"name\" && stristr($application[0], \"[\") != true) {\n\t\t\t\t\techo \"\t<option value='\".$application[0].\"'>\".$application[0].\"</option>\\n\";\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\techo \"</optgroup>\\n\";\n\t}\n\techo \"<input type='button' id='btn_select_to_input_dialplan_detail_type' class='btn' name='' alt='\".$text['button-back'].\"' onclick='change_to_input(document.getElementById(\\\"dialplan_detail_type\\\"));this.style.visibility = \\\"hidden\\\";' value='&#9665;'>\\n\";\n\techo \"</td>\\n\";\n\techo \"</tr>\\n\";\n\n\techo \"<tr>\\n\";\n\techo \"<td class='vncell' valign='top' align='left' nowrap>\\n\";\n\techo \"    \".$text['label-data'].\"\\n\";\n\techo \"</td>\\n\";\n\techo \"<td class='vtable' align='left'>\\n\";\n\techo \"    <input class='formfld' type='text' name='dialplan_detail_data' value=\\\"\".htmlspecialchars($dialplan_detail_data).\"\\\">\\n\";\n\techo \"<br />\\n\";\n\techo \"\\n\";\n\techo \"</td>\\n\";\n\techo \"</tr>\\n\";\n\n\techo \"<tr>\\n\";\n\techo \"<td class='vncell' valign='top' align='left' nowrap>\\n\";\n\techo \"    \".$text['label-group'].\"\\n\";\n\techo \"</td>\\n\";\n\techo \"<td class='vtable' align='left'>\\n\";\n\techo \"              <select name='dialplan_detail_group' class='formfld'>\\n\";\n\techo \"              <option value=''></option>\\n\";\n\tif (strlen($dialplan_detail_group)> 0) {\n\t\techo \"              <option selected='selected' value='\".htmlspecialchars($dialplan_detail_group).\"'>\".htmlspecialchars($dialplan_detail_group).\"</option>\\n\";\n\t}\n\t$i=0;\n\twhile($i<=999) {\n\t\techo \"              <option value='$i'>$i</option>\\n\";\n\t\t$i++;\n\t}\n\techo \"              </select>\\n\";\n\techo \"<br />\\n\";\n\techo \"\\n\";\n\techo \"</td>\\n\";\n\techo \"</tr>\\n\";\n\n\tif ($action == \"update\") {\n\t\tif ($dialplan_detail_tag == \"condition\") {\n\t\t\techo \"<tr>\\n\";\n\t\t\techo \"<td class='vncell' valign='top' align='left' nowrap>\\n\";\n\t\t\techo \"    \".$text['label-break'].\"\\n\";\n\t\t\techo \"</td>\\n\";\n\t\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\t\techo \"              <select name='dialplan_detail_break' class='formfld'>\\n\";\n\t\t\techo \"              <option></option>\\n\";\n\t\t\tif ($dialplan_detail_break == \"on-true\") {\n\t\t\t\techo \"              <option selected='selected' value='on-true'>\".$text['option-on_true'].\"</option>\\n\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\techo \"              <option value='on-true'>\".$text['option-on_true'].\"</option>\\n\";\n\t\t\t}\n\t\t\tif ($dialplan_detail_break == \"on-false\") {\n\t\t\t\techo \"              <option selected='selected' value='on-false'>\".$text['option-on_false'].\"</option>\\n\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\techo \"              <option value='on-false'>\".$text['option-on_false'].\"</option>\\n\";\n\t\t\t}\n\t\t\tif ($dialplan_detail_break == \"always\") {\n\t\t\t\techo \"              <option selected='selected' value='always'>\".$text['option-always'].\"</option>\\n\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\techo \"              <option value='always'>\".$text['option-always'].\"</option>\\n\";\n\t\t\t}\n\t\t\tif ($dialplan_detail_break == \"never\") {\n\t\t\t\techo \"              <option selected='selected' value='never'>\".$text['option-never'].\"</option>\\n\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\techo \"              <option value='never'>\".$text['option-never'].\"</option>\\n\";\n\t\t\t}\n\t\t\techo \"              </select>\\n\";\n\t\t\techo \"<br />\\n\";\n\t\t\techo \"\\n\";\n\t\t\techo \"</td>\\n\";\n\t\t\techo \"</tr>\\n\";\n\t\t}\n\n\t\tif ($dialplan_detail_tag == \"action\") {\n\t\t\techo \"<tr>\\n\";\n\t\t\techo \"<td class='vncell' valign='top' align='left' nowrap>\\n\";\n\t\t\techo \"    \".$text['label-inline'].\"\\n\";\n\t\t\techo \"</td>\\n\";\n\t\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\t\techo \"              <select name='dialplan_detail_inline' class='formfld'>\\n\";\n\t\t\techo \"              <option></option>\\n\";\n\t\t\tif ($dialplan_detail_inline == \"true\") {\n\t\t\t\techo \"              <option selected='selected' value='true'>\".$text['option-true'].\"</option>\\n\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\techo \"              <option value='true'>\".$text['option-true'].\"</option>\\n\";\n\t\t\t}\n\t\t\tif ($dialplan_detail_inline == \"false\") {\n\t\t\t\techo \"              <option selected='selected' value='false'>\".$text['option-false'].\"</option>\\n\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\techo \"              <option value='false'>\".$text['option-false'].\"</option>\\n\";\n\t\t\t}\n\t\t\techo \"              </select>\\n\";\n\t\t\techo \"<br />\\n\";\n\t\t\techo \"\\n\";\n\t\t\techo \"</td>\\n\";\n\t\t\techo \"</tr>\\n\";\n\t\t}\n\t}\n\n\techo \"\t<tr>\\n\";\n\techo \"\t\t<td colspan='2' align='right'>\\n\";\n\techo \"\t\t\t<input type='hidden' name='dialplan_uuid' value='$dialplan_uuid'>\\n\";\n\techo \"\t\t\t<input type='hidden' name='app_uuid' value='$app_uuid'>\\n\";\n\tif ($action == \"update\") {\n\t\techo \"\t\t<input type='hidden' name='dialplan_detail_uuid' value='$dialplan_detail_uuid'>\\n\";\n\t}\n\techo \"\t\t\t<input type='hidden' name='\".$token['name'].\"' value='\".$token['hash'].\"'>\\n\";\n\techo \"\t\t\t<br>\";\n\techo \"\t\t\t<input type='submit' name='submit' class='btn' value='\".$text['button-save'].\"'>\\n\";\n\techo \"\t\t</td>\\n\";\n\techo \"\t</tr>\";\n\techo \"</table>\";\n\techo \"<br><br>\";\n\techo \"</form>\";\n\n//include the footer\n\trequire_once \"resources/footer.php\";\n\n?>\n"], "filenames": ["app/dialplans/dialplan_detail_edit.php"], "buggy_code_start_loc": [20], "buggy_code_end_loc": [493], "fixing_code_start_loc": [20], "fixing_code_end_loc": [503], "type": "CWE-79", "message": "A cross-site scripting (XSS) vulnerability in app/dialplans/dialplan_detail_edit.php in FusionPBX 4.4.1 allows remote attackers to inject arbitrary web script or HTML via the dialplan_uuid parameter.", "other": {"cve": {"id": "CVE-2019-19388", "sourceIdentifier": "cve@mitre.org", "published": "2019-11-29T00:15:11.683", "lastModified": "2019-12-02T19:56:12.387", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "A cross-site scripting (XSS) vulnerability in app/dialplans/dialplan_detail_edit.php in FusionPBX 4.4.1 allows remote attackers to inject arbitrary web script or HTML via the dialplan_uuid parameter."}, {"lang": "es", "value": "Una vulnerabilidad de tipo cross-site scripting (XSS) en el archivo app/dialplans/dialplan_detail_edit.php en FusionPBX versi\u00f3n 4.4.1, permite a atacantes remotos inyectar script web o HTML arbitrario por medio del par\u00e1metro dialplan_uuid."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:fusionpbx:fusionpbx:4.4.1:*:*:*:*:*:*:*", "matchCriteriaId": "954E2072-AC03-4E55-8A7F-640534279042"}]}]}], "references": [{"url": "https://gist.github.com/xax007/28e7326acfae677be0b351216888e522", "source": "cve@mitre.org", "tags": ["Exploit", "Patch", "Third Party Advisory"]}, {"url": "https://github.com/fusionpbx/fusionpbx/commit/b584973e73a4d25be623c9748dd9817f69422ecc", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/fusionpbx/fusionpbx/commit/b584973e73a4d25be623c9748dd9817f69422ecc"}}