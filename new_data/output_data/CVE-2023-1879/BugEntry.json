{"buggy_code": ["<?php\n\n/**\n * Edits a category.\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @package phpMyFAQ\n * @author Thorsten Rinne <thorsten@phpmyfaq.de>\n * @copyright 2003-2022 phpMyFAQ Team\n * @license http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n * @link https://www.phpmyfaq.de\n * @since 2003-03-10\n */\n\nuse phpMyFAQ\\Category;\nuse phpMyFAQ\\Category\\CategoryPermission;\nuse phpMyFAQ\\Filter;\nuse phpMyFAQ\\Helper\\UserHelper;\n\nif (!defined('IS_VALID_PHPMYFAQ')) {\n    http_response_code(400);\n    exit();\n}\n\n$currentUserId = $user->getUserId();\n\nif ($user->perm->hasPermission($user->getUserId(), 'editcateg')) {\n    $categoryId = Filter::filterInput(INPUT_GET, 'cat', FILTER_VALIDATE_INT, 0);\n\n    $category = new Category($faqConfig, [], false);\n    $category->setUser($currentAdminUser);\n    $category->setGroups($currentAdminGroups);\n\n    $categoryPermission = new CategoryPermission($faqConfig);\n\n    $userHelper = new UserHelper($user);\n\n    $categoryData = $category->getCategoryData($categoryId);\n    $userPermission = $categoryPermission->get(CategoryPermission::USER, [$categoryId]);\n\n    if ($userPermission[0] == -1) {\n        $allUsers = true;\n        $restrictedUsers = false;\n    } else {\n        $allUsers = false;\n        $restrictedUsers = true;\n    }\n\n    $groupPermission = $categoryPermission->get(CategoryPermission::GROUP, [$categoryId]);\n    if ($groupPermission[0] == -1) {\n        $allGroups = true;\n        $restrictedGroups = false;\n    } else {\n        $allGroups = false;\n        $restrictedGroups = true;\n    }\n\n    $header = $PMF_LANG['ad_categ_edit_1'] . ' \"' . $categoryData->getName() . '\" ' . $PMF_LANG['ad_categ_edit_2'];\n    ?>\n        <div class=\"d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom\">\n          <h1 class=\"h2\">\n            <i aria-hidden=\"true\" class=\"fa fa-folder\"></i> <?= $header ?>\n          </h1>\n        </div>\n\n        <div class=\"row\">\n          <div class=\"col-lg-12\">\n          <form enctype=\"multipart/form-data\" action=\"?action=updatecategory\" method=\"post\">\n            <input type=\"hidden\" name=\"id\" value=\"<?= $categoryId ?>\">\n            <input type=\"hidden\" id=\"catlang\" name=\"catlang\" value=\"<?= $categoryData->getLang() ?>\">\n            <input type=\"hidden\" name=\"parent_id\" value=\"<?= $categoryData->getParentId() ?>\">\n            <input type=\"hidden\" name=\"csrf\" value=\"<?= $user->getCsrfTokenFromSession() ?>\">\n            <input type=\"hidden\" name=\"existing_image\" value=\"<?= $categoryData->getImage() ?>\"\n                   id=\"pmf-category-existing-image\">\n\n            <div class=\"form-group row\">\n              <label class=\"col-lg-2 col-form-label\">\n                  <?= $PMF_LANG['ad_categ_titel'] ?>:\n              </label>\n              <div class=\"col-lg-4\">\n                <input type=\"text\" id=\"name\" name=\"name\" value=\"<?= $categoryData->getName() ?>\"\n                       class=\"form-control\">\n              </div>\n            </div>\n\n            <div class=\"form-group row\">\n              <label class=\"col-lg-2 col-form-label\">\n                  <?= $PMF_LANG['ad_categ_desc'] ?>:\n              </label>\n              <div class=\"col-lg-4\">\n                <textarea id=\"description\" name=\"description\" rows=\"3\"\n                          class=\"form-control\"><?= $categoryData->getDescription() ?></textarea>\n              </div>\n            </div>\n\n            <div class=\"form-group row\">\n              <div class=\"offset-lg-2 col-lg-4\">\n                <div class=\"checkbox\">\n                  <label>\n                    <input type=\"checkbox\" name=\"active\" value=\"1\"\n                        <?= (1 === (int)$categoryData->getActive() ? 'checked' : '') ?>>\n                      <?= $PMF_LANG['ad_user_active'] ?>\n                  </label>\n                </div>\n              </div>\n            </div>\n\n            <div class=\"form-group row\">\n              <div class=\"offset-lg-2 col-lg-4\">\n                <div class=\"checkbox\">\n                  <label>\n                    <input type=\"checkbox\" name=\"show_home\" value=\"1\"\n                        <?= (1 === (int)$categoryData->getShowHome() ? 'checked' : '') ?>>\n                      <?= $PMF_LANG['ad_user_show_home'] ?>\n                  </label>\n                </div>\n              </div>\n            </div>\n\n\n            <div class=\"form-group row\">\n              <label class=\"col-lg-2 col-form-label\" for=\"pmf-category-image-upload\">\n                  <?= $PMF_LANG['ad_category_image'] ?>\n              </label>\n              <div class=\"col-lg-4\">\n                <div class=\"form-group\">\n                  <div class=\"custom-file\">\n                    <input type=\"file\" class=\"custom-file-input\" name=\"image\" id=\"pmf-category-image-upload\"\n                           value=\"<?= $categoryData->getImage() ?>\">\n                    <label class=\"custom-file-label\" for=\"pmf-category-image-upload\" id=\"pmf-category-image-label\">\n                        <?= $categoryData->getImage() ?>\n                    </label>\n                  </div>\n                </div>\n                <div class=\"form-group\">\n                  <button type=\"button\" class=\"btn btn-info\" id=\"button-reset-category-image\">\n                    Reset category image\n                  </button>\n                </div>\n              </div>\n            </div>\n\n            <div class=\"form-group row\">\n              <label class=\"col-lg-2 col-form-label\" for=\"user_id\">\n                  <?= $PMF_LANG['ad_categ_owner'] ?>\n              </label>\n              <div class=\"col-lg-4\">\n                <select id=\"user_id\" name=\"user_id\" class=\"form-control\">\n                    <?= $userHelper->getAllUserOptions($categoryData->getUserId()) ?>\n                </select>\n              </div>\n            </div>\n              <?php if ($faqConfig->get('security.permLevel') != 'basic') { ?>\n                <div class=\"form-group row\">\n                  <label class=\"col-lg-2 col-form-label\" for=\"group_id\"><?= $PMF_LANG['ad_categ_moderator'] ?>:</label>\n                  <div class=\"col-lg-4\">\n                    <select name=\"group_id\" id=\"group_id\" class=\"form-control\">\n                        <?= $user->perm->getAllGroupsOptions([$categoryData->getGroupId()], $user) ?>\n                    </select>\n                  </div>\n                </div>\n\n                <div class=\"form-group row\">\n                  <label class=\"col-lg-2 col-form-label\" for=\"grouppermission\">\n                      <?= $PMF_LANG['ad_entry_grouppermission'] ?>\n                  </label>\n                  <div class=\"col-lg-4\">\n                    <div class=\"radio\">\n                      <input type=\"radio\" id=\"grouppermission\" name=\"grouppermission\" value=\"all\"\n                          <?php echo($allGroups ? 'checked' : '') ?>>\n                        <?= $PMF_LANG['ad_entry_all_groups'] ?>\n                    </div>\n                    <label class=\"radio\">\n                      <input type=\"radio\" name=\"grouppermission\" value=\"restricted\"\n                          <?php echo($restrictedGroups ? 'checked' : '') ?>>\n                        <?= $PMF_LANG['ad_entry_restricted_groups'] ?>\n                    </label>\n                    <select name=\"restricted_groups[]\" size=\"3\" class=\"form-control\" multiple>\n                        <?= $user->perm->getAllGroupsOptions($groupPermission, $user) ?>\n                    </select>\n                  </div>\n                </div>\n              <?php } else { ?>\n                <input type=\"hidden\" name=\"grouppermission\" value=\"all\">\n              <?php } ?>\n            <div class=\"form-group row\">\n              <label class=\"col-lg-2 col-form-label\">\n                  <?= $PMF_LANG['ad_entry_userpermission'] ?>\n              </label>\n              <div class=\"col-lg-4\">\n                <div class=\"radio\">\n                  <input type=\"radio\" name=\"userpermission\" value=\"all\"\n                      <?= ($allUsers ? 'checked' : '') ?>>\n                    <?= $PMF_LANG['ad_entry_all_users'] ?>\n                </div>\n                <div class=\"radio\">\n                  <input type=\"radio\" name=\"userpermission\" value=\"restricted\"\n                      <?= ($restrictedUsers ? 'checked' : '') ?>>\n                    <?= $PMF_LANG['ad_entry_restricted_users'] ?>\n                </div>\n                <select name=\"restricted_users\" class=\"form-control\">\n                    <?= $userHelper->getAllUserOptions($userPermission[0]) ?>\n                </select>\n              </div>\n            </div>\n\n            <div class=\"form-group row\">\n              <div class=\"offset-lg-2 col-lg-4\">\n                <button class=\"btn btn-primary\" type=\"submit\" name=\"submit\">\n                    <?= $PMF_LANG['ad_categ_updatecateg'] ?>\n                </button>\n              </div>\n            </div>\n          </form>\n          </div>\n        </div>\n        <script>\n          document.addEventListener('DOMContentLoaded', () => {\n            bsCustomFileInput.init();\n\n            const resetButton = document.getElementById('button-reset-category-image');\n            const categoryExistingImage = document.getElementById('pmf-category-existing-image');\n            const categoryImageInput = document.getElementById('pmf-category-image-upload');\n            const categoryImageLabel = document.getElementById('pmf-category-image-label');\n            resetButton.addEventListener('click', () => {\n              categoryImageInput.value = '';\n              categoryExistingImage.value = '';\n              categoryImageLabel.innerHTML = '';\n            });\n          });\n        </script>\n    <?php\n} else {\n    echo $PMF_LANG['err_NotAuth'];\n}\n", "<?php\n\n/**\n * List all categories in the admin section.\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @package phpMyFAQ\n * @author Thorsten Rinne <thorsten@phpmyfaq.de>\n * @copyright 2003-2022 phpMyFAQ Team\n * @license http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n * @link https://www.phpmyfaq.de\n * @since 2003-12-20\n */\n\nuse phpMyFAQ\\Category;\nuse phpMyFAQ\\Category\\CategoryImage;\nuse phpMyFAQ\\Category\\CategoryPermission;\nuse phpMyFAQ\\Category\\CategoryRelation;\nuse phpMyFAQ\\Database;\nuse phpMyFAQ\\Filter;\nuse phpMyFAQ\\Strings;\n\nif (!defined('IS_VALID_PHPMYFAQ')) {\n    http_response_code(400);\n    exit();\n}\n?>\n  <div class=\"d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom\">\n    <h1 class=\"h2\">\n      <i aria-hidden=\"true\" class=\"fa fa-folder\"></i> <?= $PMF_LANG['ad_menu_categ_edit'] ?>\n    </h1>\n    <div class=\"btn-toolbar mb-2 mb-md-0\">\n      <div class=\"btn-group mr-2\">\n        <a class=\"btn btn-sm btn-success\" href=\"?action=addcategory\">\n          <i aria-hidden=\"true\" class=\"fa fa-folder-plus\"></i> <?= $PMF_LANG['ad_kateg_add']; ?>\n        </a>\n        <a class=\"btn btn-sm btn-info\" href=\"?action=showcategory\">\n          <i aria-hidden=\"true\" class=\"fa fa-list\"></i> <?= $PMF_LANG['ad_categ_show']; ?>\n        </a>\n      </div>\n    </div>\n  </div>\n\n  <div class=\"row\">\n    <div class=\"col-lg-12\">\n        <?php\n        //\n        // CSRF Check\n        //\n        $csrfToken = Filter::filterInput(INPUT_POST, 'csrf', FILTER_UNSAFE_RAW);\n        if (\n            'category' != $action && 'content' != $action &&\n            (!isset($_SESSION['phpmyfaq_csrf_token']) || $_SESSION['phpmyfaq_csrf_token'] !== $csrfToken)\n        ) {\n            $csrfCheck = false;\n        } else {\n            $csrfCheck = true;\n        }\n\n        //\n        // Image upload\n        //\n        $uploadedFile = (isset($_FILES['image']['size']) && $_FILES['image']['size'] > 0) ? $_FILES['image'] : [];\n        $categoryImage = new CategoryImage($faqConfig);\n        $categoryImage->setUploadedFile($uploadedFile);\n\n        $categoryPermission = new CategoryPermission($faqConfig);\n\n        if ($user->perm->hasPermission($user->getUserId(), 'editcateg') && $csrfCheck) {\n            // Save a new category\n            if ($action == 'savecategory') {\n                $category = new Category($faqConfig, [], false);\n                $category->setUser($currentAdminUser);\n                $category->setGroups($currentAdminGroups);\n                $parentId = Filter::filterInput(INPUT_POST, 'parent_id', FILTER_VALIDATE_INT);\n                $categoryId = $faqConfig->getDb()->nextId(Database::getTablePrefix() . 'faqcategories', 'id');\n                $categoryLang = Filter::filterInput(INPUT_POST, 'lang', FILTER_UNSAFE_RAW);\n                $categoryData = [\n                    'lang' => $categoryLang,\n                    'name' => Filter::filterInput(INPUT_POST, 'name', FILTER_SANITIZE_SPECIAL_CHARS),\n                    'description' => Filter::filterInput(INPUT_POST, 'description', FILTER_SANITIZE_SPECIAL_CHARS),\n                    'user_id' => Filter::filterInput(INPUT_POST, 'user_id', FILTER_VALIDATE_INT),\n                    'group_id' => Filter::filterInput(INPUT_POST, 'group_id', FILTER_VALIDATE_INT),\n                    'active' => Filter::filterInput(INPUT_POST, 'active', FILTER_VALIDATE_INT),\n                    'image' => $categoryImage->getFileName($categoryId, $categoryLang),\n                    'show_home' => Filter::filterInput(INPUT_POST, 'show_home', FILTER_VALIDATE_INT)\n                ];\n\n                $permissions = [];\n                if ('all' === Filter::filterInput(INPUT_POST, 'userpermission', FILTER_UNSAFE_RAW)) {\n                    $permissions += [\n                    'restricted_user' => [\n                        -1,\n                    ],\n                    ];\n                } else {\n                    $permissions += [\n                    'restricted_user' => [\n                        Filter::filterInput(INPUT_POST, 'restricted_users', FILTER_VALIDATE_INT),\n                    ],\n                    ];\n                }\n\n                if ('all' === Filter::filterInput(INPUT_POST, 'grouppermission', FILTER_UNSAFE_RAW)) {\n                    $permissions += [\n                    'restricted_groups' => [\n                        -1,\n                    ],\n                    ];\n                } else {\n                    $permissions += Filter::filterInputArray(\n                        INPUT_POST,\n                        [\n                        'restricted_groups' => [\n                            'filter' => FILTER_VALIDATE_INT,\n                            'flags' => FILTER_REQUIRE_ARRAY,\n                        ],\n                        ]\n                    );\n                }\n\n                if ($category->checkIfCategoryExists($categoryData) > 0) {\n                    printf('<p class=\"alert alert-danger\">%s</p>', $PMF_LANG['ad_categ_existing']);\n                    exit();\n                }\n\n                $categoryId = $category->addCategory($categoryData, $parentId);\n\n                if ($categoryId) {\n                    $categoryPermission->add(CategoryPermission::USER, [$categoryId], $permissions['restricted_user']);\n                    $categoryPermission->add(\n                        CategoryPermission::GROUP,\n                        [$categoryId],\n                        $permissions['restricted_groups']\n                    );\n\n                    $categoryImage->upload();\n\n                    // All the other translations\n                    $languages = Filter::filterInput(INPUT_POST, 'used_translated_languages', FILTER_UNSAFE_RAW);\n                    printf('<p class=\"alert alert-success\">%s</p>', $PMF_LANG['ad_categ_added']);\n                } else {\n                    printf('<p class=\"alert alert-danger\">%s</p>', $faqConfig->getDb()->error());\n                }\n            }\n\n            // Updates an existing category\n            if ($action == 'updatecategory') {\n                $category = new Category($faqConfig, [], false);\n                $category->setUser($currentAdminUser);\n                $category->setGroups($currentAdminGroups);\n\n                $parentId = Filter::filterInput(INPUT_POST, 'parent_id', FILTER_VALIDATE_INT);\n                $categoryId = Filter::filterInput(INPUT_POST, 'id', FILTER_VALIDATE_INT);\n                $categoryLang = Filter::filterInput(INPUT_POST, 'catlang', FILTER_UNSAFE_RAW);\n                $existingImage = Filter::filterInput(INPUT_POST, 'existing_image', FILTER_UNSAFE_RAW);\n                $image = count($uploadedFile) ? $categoryImage->getFileName(\n                    $categoryId,\n                    $categoryLang\n                ) : $existingImage;\n                $categoryData = [\n                    'id' => $categoryId,\n                    'lang' => $categoryLang,\n                    'parent_id' => $parentId,\n                    'name' => Filter::filterInput(INPUT_POST, 'name', FILTER_UNSAFE_RAW),\n                    'description' => Filter::filterInput(INPUT_POST, 'description', FILTER_UNSAFE_RAW),\n                    'user_id' => Filter::filterInput(INPUT_POST, 'user_id', FILTER_VALIDATE_INT),\n                    'group_id' => Filter::filterInput(INPUT_POST, 'group_id', FILTER_VALIDATE_INT),\n                    'active' => Filter::filterInput(INPUT_POST, 'active', FILTER_VALIDATE_INT),\n                    'image' => $image,\n                    'show_home' => Filter::filterInput(INPUT_POST, 'show_home', FILTER_VALIDATE_INT),\n                ];\n\n                $permissions = [];\n                if ('all' === Filter::filterInput(INPUT_POST, 'userpermission', FILTER_UNSAFE_RAW)) {\n                    $permissions += [\n                    'restricted_user' => [\n                        -1,\n                    ],\n                    ];\n                } else {\n                    $permissions += [\n                    'restricted_user' => [\n                        Filter::filterInput(INPUT_POST, 'restricted_users', FILTER_VALIDATE_INT),\n                    ],\n                    ];\n                }\n\n                if ('all' === Filter::filterInput(INPUT_POST, 'grouppermission', FILTER_UNSAFE_RAW)) {\n                    $permissions += [\n                    'restricted_groups' => [\n                        -1,\n                    ],\n                    ];\n                } else {\n                    $permissions += Filter::filterInputArray(\n                        INPUT_POST,\n                        [\n                        'restricted_groups' => [\n                            'filter' => FILTER_VALIDATE_INT,\n                            'flags' => FILTER_REQUIRE_ARRAY,\n                        ],\n                        ]\n                    );\n                }\n\n                if (!$category->checkLanguage($categoryData['id'], $categoryData['lang'])) {\n                    if (\n                        $category->addCategory($categoryData, $parentId, $categoryData['id']) &&\n                        $categoryPermission->add(\n                            CategoryPermission::USER,\n                            [$categoryData['id']],\n                            $permissions['restricted_user']\n                        ) &&\n                        $categoryPermission->add(\n                            CategoryPermission::GROUP,\n                            [$categoryData['id']],\n                            $permissions['restricted_groups']\n                        )\n                    ) {\n                        printf('<p class=\"alert alert-success\">%s</p>', $PMF_LANG['ad_categ_translated']);\n                    } else {\n                        printf('<p class=\"alert alert-danger\">%s</p>', $faqConfig->getDb()->error());\n                    }\n                } else {\n                    if ($category->updateCategory($categoryData)) {\n                        $categoryPermission->delete(CategoryPermission::USER, [$categoryData['id']]);\n                        $categoryPermission->delete(CategoryPermission::GROUP, [$categoryData['id']]);\n                        $categoryPermission->add(\n                            CategoryPermission::USER,\n                            [$categoryData['id']],\n                            $permissions['restricted_user']\n                        );\n                        $categoryPermission->add(\n                            CategoryPermission::GROUP,\n                            [$categoryData['id']],\n                            $permissions['restricted_groups']\n                        );\n\n                        $categoryImage->upload();\n\n                        printf('<p class=\"alert alert-success\">%s</p>', $PMF_LANG['ad_categ_updated']);\n                    } else {\n                        printf('<p class=\"alert alert-danger\">%s</p>', $faqConfig->getDb()->error());\n                    }\n                }\n\n                // All the other translations\n                $languages = Filter::filterInput(INPUT_POST, 'used_translated_languages', FILTER_UNSAFE_RAW);\n            }\n\n            // Deletes an existing category\n            if ($user->perm->hasPermission($user->getUserId(), 'delcateg') && $action == 'removecategory') {\n                $categoryId = Filter::filterInput(INPUT_POST, 'cat', FILTER_VALIDATE_INT);\n                $categoryLang = Filter::filterInput(INPUT_POST, 'lang', FILTER_UNSAFE_RAW);\n\n                $category = new Category($faqConfig, [], false);\n                $category->setUser($currentAdminUser);\n                $category->setGroups($currentAdminGroups);\n\n                $categoryRelation = new CategoryRelation($faqConfig);\n\n                $categoryImage = new CategoryImage($faqConfig);\n                $categoryImage->setFileName($category->getCategoryData($categoryId)->getImage());\n\n                if (count($category->getCategoryLanguagesTranslated($categoryId)) === 1) {\n                    $categoryPermission->delete(CategoryPermission::USER, [$categoryId]);\n                    $categoryPermission->delete(CategoryPermission::GROUP, [$categoryId]);\n                    $categoryImage->delete();\n                }\n\n                if (\n                    $category->deleteCategory($categoryId, $categoryLang) &&\n                    $categoryRelation->delete($categoryId, $categoryLang)\n                ) {\n                    printf('<p class=\"alert alert-success\">%s</p>', $PMF_LANG['ad_categ_deleted']);\n                } else {\n                    printf('<p class=\"alert alert-danger\">%s</p>', $faqConfig->getDb()->error());\n                }\n            }\n\n            // Pastes a category\n            if ($action == 'pastecategory') {\n                $category = new Category($faqConfig, [], false);\n                $category->setUser($currentAdminUser);\n                $category->setGroups($currentAdminGroups);\n                $categoryId = Filter::filterInput(INPUT_POST, 'cat', FILTER_VALIDATE_INT);\n                $parentId = Filter::filterInput(INPUT_POST, 'after', FILTER_VALIDATE_INT);\n                if ($category->updateParentCategory((int) $categoryId, (int) $parentId)) {\n                    printf('<p class=\"alert alert-success\">%s</p>', $PMF_LANG['ad_categ_updated']);\n                } else {\n                    printf(\n                        '<p class=\"alert alert-danger\">%s<br>%s</p>',\n                        $PMF_LANG['ad_categ_paste_error'],\n                        $faqConfig->getDb()->error()\n                    );\n                }\n            }\n\n            // Lists all categories\n            $lang = Filter::filterInput(INPUT_POST, 'lang', FILTER_UNSAFE_RAW, $faqLangCode);\n\n            // If we changed the category tree, unset the object\n            if (isset($category)) {\n                unset($category);\n            }\n\n            $category = new Category($faqConfig, $currentAdminGroups, true);\n            $category->setUser($currentAdminUser);\n            $category->setGroups($currentAdminGroups);\n            $category->getMissingCategories();\n            $category->buildCategoryTree();\n\n            $open = $lastCatId = $openDiv = 0;\n\n            echo '<div class=\"list-group list-group-root\">';\n            foreach ($category->getCategoryTree() as $id => $cat) {\n                // CategoryHelper translated in this language?\n                if ($cat['lang'] == $lang) {\n                    $categoryName = Strings::htmlentities($cat['name']);\n                } else {\n                    $categoryName = Strings::htmlentities($cat['name']) .\n                        ' (' . $languageCodes[strtoupper($cat['lang'])] . ')';\n                }\n\n\n                // Has permissions, show lock icon\n                if ($categoryPermission->isRestricted($cat['id'])) {\n                    $categoryName .= ' <i class=\"fa fa-lock\" aria-hidden=\"true\"></i>';\n                }\n\n                   // Category is shown on start page\n                if ((int)$cat['show_home'] === 1) {\n                    $categoryName .= ' <i class=\"fa fa-star\" aria-hidden=\"true\"></i>';\n                }\n\n                // Category is inactive\n                if ((int)$cat['active'] === 0) {\n                    $categoryName .= ' <i class=\"fa fa-eye-slash\" aria-hidden=\"true\"></i>';\n                }\n\n                // Level of the category\n                $level = $cat['indent'];\n\n                // Any sub-categories?\n                $subCategories = $category->getChildren($cat['id']);\n                $numSubCategories = count($subCategories);\n\n                $hasParent = (bool) $cat['parent_id'];\n\n                if ($hasParent) {\n                    printf(\n                        '<div class=\"list-group collapse\" id=\"category-id-%d\">',\n                        $cat['parent_id']\n                    );\n                }\n\n                printf(\n                    '<div href=\"#category-id-%d\" id=\"%s-%d\" class=\"list-group-item list-group-item-action border-left-0 border-right-0 d-flex justify-content-between align-items-center\" %s>',\n                    $cat['id'],\n                    trim(strip_tags($categoryName)),\n                    $cat['id'],\n                    $numSubCategories > 0 ? 'data-toggle=\"collapse\"' : ''\n                );\n                printf(\n                    '<span>%s %s</span>',\n                    $numSubCategories > 0 ? '<i class=\"fa fa-caret-right pmf-has-subcategories\"></i>' : '',\n                    $categoryName\n                );\n\n                // Buttons:\n                echo '<span>';\n                // Add FAQ to category (always)\n                printf(\n                    '<a class=\"btn btn-info btn-sm\" href=\"?action=editentry&amp;cat=%s&amp;lang=%s\"><i aria-hidden=\"true\" class=\"fa fa-indent\" title=\"%s\"></i></a></a> ',\n                    $cat['id'],\n                    $cat['lang'],\n                    $PMF_LANG['ad_quick_entry']\n                );\n\n                if ($cat['lang'] == $lang) {\n                    // add sub category (if current language)\n                    printf(\n                        '<a class=\"btn btn-info btn-sm\" href=\"?action=addcategory&amp;cat=%s&amp;lang=%s\"><i aria-hidden=\"true\" class=\"fa fa-plus-square\" title=\"%s\"></i></a> ',\n                        $cat['id'],\n                        $cat['lang'],\n                        $PMF_LANG['ad_quick_category']\n                    );\n\n                    // rename (sub) category (if current language)\n                    printf(\n                        '<a class=\"btn btn-info btn-sm\" href=\"?action=editcategory&amp;cat=%s\"><i aria-hidden=\"true\" class=\"fa fa-edit\" title=\"%s\"></i></a> ',\n                        $cat['id'],\n                        $PMF_LANG['ad_kateg_rename']\n                    );\n                }\n\n                // translate category (always)\n                printf(\n                    '<a class=\"btn btn-info btn-sm\" href=\"?action=translatecategory&amp;cat=%s\"><i aria-hidden=\"true\" class=\"fa fa-globe\" title=\"%s\"></i></a> ',\n                    $cat['id'],\n                    $PMF_LANG['ad_categ_translate']\n                );\n\n                // delete (sub) category (if current language)\n                if (count($category->getChildren($cat['id'])) == 0 && $cat['lang'] == $lang) {\n                    printf(\n                        '<a class=\"btn btn-danger btn-sm\" href=\"?action=deletecategory&amp;cat=%s&amp;catlang=%s\"><i aria-hidden=\"true\" class=\"fa fa-trash\" title=\"%s\"></i></a> ',\n                        $cat['id'],\n                        $cat['lang'],\n                        $PMF_LANG['ad_categ_delete']\n                    );\n                } else {\n                    echo '<a class=\"btn btn-inverse btn-sm\" style=\"cursor: not-allowed;\"><i aria-hidden=\"true\" class=\"fa fa-trash\"></i></a>';\n                }\n\n                if ($cat['lang'] == $lang) {\n                    // cut category (if current language)\n                    printf(\n                        '<a class=\"btn btn-warning btn-sm\" href=\"?action=cutcategory&amp;cat=%s\"><i aria-hidden=\"true\" class=\"fa fa-cut\" title=\"%s\"></i></a>  ',\n                        $cat['id'],\n                        $PMF_LANG['ad_categ_cut']\n                    );\n                }\n                echo '</span>';\n                echo '</div>';\n\n                if ($hasParent) {\n                    echo '</div>';\n                }\n\n                $lastCatId = $cat['id'];\n            }\n            ?>\n      <div class=\"d-flex flex-row\">\n      <form method=\"post\">\n        <input type=\"hidden\" name=\"csrf\" value=\"<?= $user->getCsrfTokenFromSession() ?>\">\n        <button class=\"pmf-save-category-order text-white btn btn-primary mt-3 mr-1\">\n            <?= $PMF_LANG['ad_categ_save_order'] ?>\n        </button>\n      </form>\n      </div>\n      <p class=\"alert alert-info mt-4\"><?= $PMF_LANG['ad_categ_remark'] ?></p>\n    </div>\n  </div>\n  <script src=\"assets/js/category.js\"></script>\n            <?php\n        } else {\n            echo $PMF_LANG['err_NotAuth'];\n        }\n"], "fixing_code": ["<?php\n\n/**\n * Edits a category.\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @package phpMyFAQ\n * @author Thorsten Rinne <thorsten@phpmyfaq.de>\n * @copyright 2003-2022 phpMyFAQ Team\n * @license http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n * @link https://www.phpmyfaq.de\n * @since 2003-03-10\n */\n\nuse phpMyFAQ\\Category;\nuse phpMyFAQ\\Category\\CategoryPermission;\nuse phpMyFAQ\\Filter;\nuse phpMyFAQ\\Helper\\UserHelper;\nuse phpMyFAQ\\Strings;\n\nif (!defined('IS_VALID_PHPMYFAQ')) {\n    http_response_code(400);\n    exit();\n}\n\n$currentUserId = $user->getUserId();\n\nif ($user->perm->hasPermission($user->getUserId(), 'editcateg')) {\n    $categoryId = Filter::filterInput(INPUT_GET, 'cat', FILTER_VALIDATE_INT, 0);\n\n    $category = new Category($faqConfig, [], false);\n    $category->setUser($currentAdminUser);\n    $category->setGroups($currentAdminGroups);\n\n    $categoryPermission = new CategoryPermission($faqConfig);\n\n    $userHelper = new UserHelper($user);\n\n    $categoryData = $category->getCategoryData($categoryId);\n    $userPermission = $categoryPermission->get(CategoryPermission::USER, [$categoryId]);\n\n    if ($userPermission[0] == -1) {\n        $allUsers = true;\n        $restrictedUsers = false;\n    } else {\n        $allUsers = false;\n        $restrictedUsers = true;\n    }\n\n    $groupPermission = $categoryPermission->get(CategoryPermission::GROUP, [$categoryId]);\n    if ($groupPermission[0] == -1) {\n        $allGroups = true;\n        $restrictedGroups = false;\n    } else {\n        $allGroups = false;\n        $restrictedGroups = true;\n    }\n\n    $header = $PMF_LANG['ad_categ_edit_1'] . ' \"' . Strings::htmlentities($categoryData->getName()) .\n        '\" ' . $PMF_LANG['ad_categ_edit_2'];\n    ?>\n        <div class=\"d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom\">\n          <h1 class=\"h2\">\n            <i aria-hidden=\"true\" class=\"fa fa-folder\"></i> <?= $header ?>\n          </h1>\n        </div>\n\n        <div class=\"row\">\n          <div class=\"col-lg-12\">\n          <form enctype=\"multipart/form-data\" action=\"?action=updatecategory\" method=\"post\">\n            <input type=\"hidden\" name=\"id\" value=\"<?= $categoryId ?>\">\n            <input type=\"hidden\" id=\"catlang\" name=\"catlang\" value=\"<?= $categoryData->getLang() ?>\">\n            <input type=\"hidden\" name=\"parent_id\" value=\"<?= $categoryData->getParentId() ?>\">\n            <input type=\"hidden\" name=\"csrf\" value=\"<?= $user->getCsrfTokenFromSession() ?>\">\n            <input type=\"hidden\" name=\"existing_image\" value=\"<?= $categoryData->getImage() ?>\"\n                   id=\"pmf-category-existing-image\">\n\n            <div class=\"form-group row\">\n              <label class=\"col-lg-2 col-form-label\">\n                  <?= $PMF_LANG['ad_categ_titel'] ?>:\n              </label>\n              <div class=\"col-lg-4\">\n                <input type=\"text\" id=\"name\" name=\"name\" value=\"<?= Strings::htmlentities($categoryData->getName()) ?>\"\n                       class=\"form-control\">\n              </div>\n            </div>\n\n            <div class=\"form-group row\">\n              <label class=\"col-lg-2 col-form-label\">\n                  <?= $PMF_LANG['ad_categ_desc'] ?>:\n              </label>\n              <div class=\"col-lg-4\">\n                <textarea id=\"description\" name=\"description\" rows=\"3\"\n                          class=\"form-control\"><?= Strings::htmlentities($categoryData->getDescription()) ?></textarea>\n              </div>\n            </div>\n\n            <div class=\"form-group row\">\n              <div class=\"offset-lg-2 col-lg-4\">\n                <div class=\"checkbox\">\n                  <label>\n                    <input type=\"checkbox\" name=\"active\" value=\"1\"\n                        <?= (1 === (int)$categoryData->getActive() ? 'checked' : '') ?>>\n                      <?= $PMF_LANG['ad_user_active'] ?>\n                  </label>\n                </div>\n              </div>\n            </div>\n\n            <div class=\"form-group row\">\n              <div class=\"offset-lg-2 col-lg-4\">\n                <div class=\"checkbox\">\n                  <label>\n                    <input type=\"checkbox\" name=\"show_home\" value=\"1\"\n                        <?= (1 === (int)$categoryData->getShowHome() ? 'checked' : '') ?>>\n                      <?= $PMF_LANG['ad_user_show_home'] ?>\n                  </label>\n                </div>\n              </div>\n            </div>\n\n\n            <div class=\"form-group row\">\n              <label class=\"col-lg-2 col-form-label\" for=\"pmf-category-image-upload\">\n                  <?= $PMF_LANG['ad_category_image'] ?>\n              </label>\n              <div class=\"col-lg-4\">\n                <div class=\"form-group\">\n                  <div class=\"custom-file\">\n                    <input type=\"file\" class=\"custom-file-input\" name=\"image\" id=\"pmf-category-image-upload\"\n                           value=\"<?= $categoryData->getImage() ?>\">\n                    <label class=\"custom-file-label\" for=\"pmf-category-image-upload\" id=\"pmf-category-image-label\">\n                        <?= $categoryData->getImage() ?>\n                    </label>\n                  </div>\n                </div>\n                <div class=\"form-group\">\n                  <button type=\"button\" class=\"btn btn-info\" id=\"button-reset-category-image\">\n                    Reset category image\n                  </button>\n                </div>\n              </div>\n            </div>\n\n            <div class=\"form-group row\">\n              <label class=\"col-lg-2 col-form-label\" for=\"user_id\">\n                  <?= $PMF_LANG['ad_categ_owner'] ?>\n              </label>\n              <div class=\"col-lg-4\">\n                <select id=\"user_id\" name=\"user_id\" class=\"form-control\">\n                    <?= $userHelper->getAllUserOptions($categoryData->getUserId()) ?>\n                </select>\n              </div>\n            </div>\n              <?php if ($faqConfig->get('security.permLevel') != 'basic') { ?>\n                <div class=\"form-group row\">\n                  <label class=\"col-lg-2 col-form-label\" for=\"group_id\"><?= $PMF_LANG['ad_categ_moderator'] ?>:</label>\n                  <div class=\"col-lg-4\">\n                    <select name=\"group_id\" id=\"group_id\" class=\"form-control\">\n                        <?= $user->perm->getAllGroupsOptions([$categoryData->getGroupId()], $user) ?>\n                    </select>\n                  </div>\n                </div>\n\n                <div class=\"form-group row\">\n                  <label class=\"col-lg-2 col-form-label\" for=\"grouppermission\">\n                      <?= $PMF_LANG['ad_entry_grouppermission'] ?>\n                  </label>\n                  <div class=\"col-lg-4\">\n                    <div class=\"radio\">\n                      <input type=\"radio\" id=\"grouppermission\" name=\"grouppermission\" value=\"all\"\n                          <?php echo($allGroups ? 'checked' : '') ?>>\n                        <?= $PMF_LANG['ad_entry_all_groups'] ?>\n                    </div>\n                    <label class=\"radio\">\n                      <input type=\"radio\" name=\"grouppermission\" value=\"restricted\"\n                          <?php echo($restrictedGroups ? 'checked' : '') ?>>\n                        <?= $PMF_LANG['ad_entry_restricted_groups'] ?>\n                    </label>\n                    <select name=\"restricted_groups[]\" size=\"3\" class=\"form-control\" multiple>\n                        <?= $user->perm->getAllGroupsOptions($groupPermission, $user) ?>\n                    </select>\n                  </div>\n                </div>\n              <?php } else { ?>\n                <input type=\"hidden\" name=\"grouppermission\" value=\"all\">\n              <?php } ?>\n            <div class=\"form-group row\">\n              <label class=\"col-lg-2 col-form-label\">\n                  <?= $PMF_LANG['ad_entry_userpermission'] ?>\n              </label>\n              <div class=\"col-lg-4\">\n                <div class=\"radio\">\n                  <input type=\"radio\" name=\"userpermission\" value=\"all\"\n                      <?= ($allUsers ? 'checked' : '') ?>>\n                    <?= $PMF_LANG['ad_entry_all_users'] ?>\n                </div>\n                <div class=\"radio\">\n                  <input type=\"radio\" name=\"userpermission\" value=\"restricted\"\n                      <?= ($restrictedUsers ? 'checked' : '') ?>>\n                    <?= $PMF_LANG['ad_entry_restricted_users'] ?>\n                </div>\n                <select name=\"restricted_users\" class=\"form-control\">\n                    <?= $userHelper->getAllUserOptions($userPermission[0]) ?>\n                </select>\n              </div>\n            </div>\n\n            <div class=\"form-group row\">\n              <div class=\"offset-lg-2 col-lg-4\">\n                <button class=\"btn btn-primary\" type=\"submit\" name=\"submit\">\n                    <?= $PMF_LANG['ad_categ_updatecateg'] ?>\n                </button>\n              </div>\n            </div>\n          </form>\n          </div>\n        </div>\n        <script>\n          document.addEventListener('DOMContentLoaded', () => {\n            bsCustomFileInput.init();\n\n            const resetButton = document.getElementById('button-reset-category-image');\n            const categoryExistingImage = document.getElementById('pmf-category-existing-image');\n            const categoryImageInput = document.getElementById('pmf-category-image-upload');\n            const categoryImageLabel = document.getElementById('pmf-category-image-label');\n            resetButton.addEventListener('click', () => {\n              categoryImageInput.value = '';\n              categoryExistingImage.value = '';\n              categoryImageLabel.innerHTML = '';\n            });\n          });\n        </script>\n    <?php\n} else {\n    echo $PMF_LANG['err_NotAuth'];\n}\n", "<?php\n\n/**\n * List all categories in the admin section.\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @package phpMyFAQ\n * @author Thorsten Rinne <thorsten@phpmyfaq.de>\n * @copyright 2003-2022 phpMyFAQ Team\n * @license http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n * @link https://www.phpmyfaq.de\n * @since 2003-12-20\n */\n\nuse phpMyFAQ\\Category;\nuse phpMyFAQ\\Category\\CategoryImage;\nuse phpMyFAQ\\Category\\CategoryPermission;\nuse phpMyFAQ\\Category\\CategoryRelation;\nuse phpMyFAQ\\Database;\nuse phpMyFAQ\\Filter;\nuse phpMyFAQ\\Strings;\n\nif (!defined('IS_VALID_PHPMYFAQ')) {\n    http_response_code(400);\n    exit();\n}\n?>\n  <div class=\"d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom\">\n    <h1 class=\"h2\">\n      <i aria-hidden=\"true\" class=\"fa fa-folder\"></i> <?= $PMF_LANG['ad_menu_categ_edit'] ?>\n    </h1>\n    <div class=\"btn-toolbar mb-2 mb-md-0\">\n      <div class=\"btn-group mr-2\">\n        <a class=\"btn btn-sm btn-success\" href=\"?action=addcategory\">\n          <i aria-hidden=\"true\" class=\"fa fa-folder-plus\"></i> <?= $PMF_LANG['ad_kateg_add']; ?>\n        </a>\n        <a class=\"btn btn-sm btn-info\" href=\"?action=showcategory\">\n          <i aria-hidden=\"true\" class=\"fa fa-list\"></i> <?= $PMF_LANG['ad_categ_show']; ?>\n        </a>\n      </div>\n    </div>\n  </div>\n\n  <div class=\"row\">\n    <div class=\"col-lg-12\">\n        <?php\n        //\n        // CSRF Check\n        //\n        $csrfToken = Filter::filterInput(INPUT_POST, 'csrf', FILTER_UNSAFE_RAW);\n        if (\n            'category' != $action && 'content' != $action &&\n            (!isset($_SESSION['phpmyfaq_csrf_token']) || $_SESSION['phpmyfaq_csrf_token'] !== $csrfToken)\n        ) {\n            $csrfCheck = false;\n        } else {\n            $csrfCheck = true;\n        }\n\n        //\n        // Image upload\n        //\n        $uploadedFile = (isset($_FILES['image']['size']) && $_FILES['image']['size'] > 0) ? $_FILES['image'] : [];\n        $categoryImage = new CategoryImage($faqConfig);\n        $categoryImage->setUploadedFile($uploadedFile);\n\n        $categoryPermission = new CategoryPermission($faqConfig);\n\n        if ($user->perm->hasPermission($user->getUserId(), 'editcateg') && $csrfCheck) {\n            // Save a new category\n            if ($action == 'savecategory') {\n                $category = new Category($faqConfig, [], false);\n                $category->setUser($currentAdminUser);\n                $category->setGroups($currentAdminGroups);\n                $parentId = Filter::filterInput(INPUT_POST, 'parent_id', FILTER_VALIDATE_INT);\n                $categoryId = $faqConfig->getDb()->nextId(Database::getTablePrefix() . 'faqcategories', 'id');\n                $categoryLang = Filter::filterInput(INPUT_POST, 'lang', FILTER_UNSAFE_RAW);\n                $categoryData = [\n                    'lang' => $categoryLang,\n                    'name' => Filter::filterInput(INPUT_POST, 'name', FILTER_SANITIZE_SPECIAL_CHARS),\n                    'description' => Filter::filterInput(INPUT_POST, 'description', FILTER_SANITIZE_SPECIAL_CHARS),\n                    'user_id' => Filter::filterInput(INPUT_POST, 'user_id', FILTER_VALIDATE_INT),\n                    'group_id' => Filter::filterInput(INPUT_POST, 'group_id', FILTER_VALIDATE_INT),\n                    'active' => Filter::filterInput(INPUT_POST, 'active', FILTER_VALIDATE_INT),\n                    'image' => $categoryImage->getFileName($categoryId, $categoryLang),\n                    'show_home' => Filter::filterInput(INPUT_POST, 'show_home', FILTER_VALIDATE_INT)\n                ];\n\n                $permissions = [];\n                if ('all' === Filter::filterInput(INPUT_POST, 'userpermission', FILTER_UNSAFE_RAW)) {\n                    $permissions += [\n                    'restricted_user' => [\n                        -1,\n                    ],\n                    ];\n                } else {\n                    $permissions += [\n                    'restricted_user' => [\n                        Filter::filterInput(INPUT_POST, 'restricted_users', FILTER_VALIDATE_INT),\n                    ],\n                    ];\n                }\n\n                if ('all' === Filter::filterInput(INPUT_POST, 'grouppermission', FILTER_UNSAFE_RAW)) {\n                    $permissions += [\n                    'restricted_groups' => [\n                        -1,\n                    ],\n                    ];\n                } else {\n                    $permissions += Filter::filterInputArray(\n                        INPUT_POST,\n                        [\n                        'restricted_groups' => [\n                            'filter' => FILTER_VALIDATE_INT,\n                            'flags' => FILTER_REQUIRE_ARRAY,\n                        ],\n                        ]\n                    );\n                }\n\n                if ($category->checkIfCategoryExists($categoryData) > 0) {\n                    printf('<p class=\"alert alert-danger\">%s</p>', $PMF_LANG['ad_categ_existing']);\n                    exit();\n                }\n\n                $categoryId = $category->addCategory($categoryData, $parentId);\n\n                if ($categoryId) {\n                    $categoryPermission->add(CategoryPermission::USER, [$categoryId], $permissions['restricted_user']);\n                    $categoryPermission->add(\n                        CategoryPermission::GROUP,\n                        [$categoryId],\n                        $permissions['restricted_groups']\n                    );\n\n                    $categoryImage->upload();\n\n                    // All the other translations\n                    $languages = Filter::filterInput(INPUT_POST, 'used_translated_languages', FILTER_UNSAFE_RAW);\n                    printf('<p class=\"alert alert-success\">%s</p>', $PMF_LANG['ad_categ_added']);\n                } else {\n                    printf('<p class=\"alert alert-danger\">%s</p>', $faqConfig->getDb()->error());\n                }\n            }\n\n            // Updates an existing category\n            if ($action == 'updatecategory') {\n                $category = new Category($faqConfig, [], false);\n                $category->setUser($currentAdminUser);\n                $category->setGroups($currentAdminGroups);\n\n                $parentId = Filter::filterInput(INPUT_POST, 'parent_id', FILTER_VALIDATE_INT);\n                $categoryId = Filter::filterInput(INPUT_POST, 'id', FILTER_VALIDATE_INT);\n                $categoryLang = Filter::filterInput(INPUT_POST, 'catlang', FILTER_SANITIZE_SPECIAL_CHARS);\n                $existingImage = Filter::filterInput(INPUT_POST, 'existing_image', FILTER_SANITIZE_SPECIAL_CHARS);\n                $image = count($uploadedFile) ? $categoryImage->getFileName(\n                    $categoryId,\n                    $categoryLang\n                ) : $existingImage;\n                $categoryData = [\n                    'id' => $categoryId,\n                    'lang' => $categoryLang,\n                    'parent_id' => $parentId,\n                    'name' => Filter::filterInput(INPUT_POST, 'name', FILTER_UNSAFE_RAW),\n                    'description' => Filter::filterInput(INPUT_POST, 'description', FILTER_UNSAFE_RAW),\n                    'user_id' => Filter::filterInput(INPUT_POST, 'user_id', FILTER_VALIDATE_INT),\n                    'group_id' => Filter::filterInput(INPUT_POST, 'group_id', FILTER_VALIDATE_INT),\n                    'active' => Filter::filterInput(INPUT_POST, 'active', FILTER_VALIDATE_INT),\n                    'image' => $image,\n                    'show_home' => Filter::filterInput(INPUT_POST, 'show_home', FILTER_VALIDATE_INT),\n                ];\n\n                $permissions = [];\n                if ('all' === Filter::filterInput(INPUT_POST, 'userpermission', FILTER_UNSAFE_RAW)) {\n                    $permissions += [\n                    'restricted_user' => [\n                        -1,\n                    ],\n                    ];\n                } else {\n                    $permissions += [\n                    'restricted_user' => [\n                        Filter::filterInput(INPUT_POST, 'restricted_users', FILTER_VALIDATE_INT),\n                    ],\n                    ];\n                }\n\n                if ('all' === Filter::filterInput(INPUT_POST, 'grouppermission', FILTER_UNSAFE_RAW)) {\n                    $permissions += [\n                    'restricted_groups' => [\n                        -1,\n                    ],\n                    ];\n                } else {\n                    $permissions += Filter::filterInputArray(\n                        INPUT_POST,\n                        [\n                        'restricted_groups' => [\n                            'filter' => FILTER_VALIDATE_INT,\n                            'flags' => FILTER_REQUIRE_ARRAY,\n                        ],\n                        ]\n                    );\n                }\n\n                if (!$category->checkLanguage($categoryData['id'], $categoryData['lang'])) {\n                    if (\n                        $category->addCategory($categoryData, $parentId, $categoryData['id']) &&\n                        $categoryPermission->add(\n                            CategoryPermission::USER,\n                            [$categoryData['id']],\n                            $permissions['restricted_user']\n                        ) &&\n                        $categoryPermission->add(\n                            CategoryPermission::GROUP,\n                            [$categoryData['id']],\n                            $permissions['restricted_groups']\n                        )\n                    ) {\n                        printf('<p class=\"alert alert-success\">%s</p>', $PMF_LANG['ad_categ_translated']);\n                    } else {\n                        printf('<p class=\"alert alert-danger\">%s</p>', $faqConfig->getDb()->error());\n                    }\n                } else {\n                    if ($category->updateCategory($categoryData)) {\n                        $categoryPermission->delete(CategoryPermission::USER, [$categoryData['id']]);\n                        $categoryPermission->delete(CategoryPermission::GROUP, [$categoryData['id']]);\n                        $categoryPermission->add(\n                            CategoryPermission::USER,\n                            [$categoryData['id']],\n                            $permissions['restricted_user']\n                        );\n                        $categoryPermission->add(\n                            CategoryPermission::GROUP,\n                            [$categoryData['id']],\n                            $permissions['restricted_groups']\n                        );\n\n                        $categoryImage->upload();\n\n                        printf('<p class=\"alert alert-success\">%s</p>', $PMF_LANG['ad_categ_updated']);\n                    } else {\n                        printf('<p class=\"alert alert-danger\">%s</p>', $faqConfig->getDb()->error());\n                    }\n                }\n\n                // All the other translations\n                $languages = Filter::filterInput(INPUT_POST, 'used_translated_languages', FILTER_UNSAFE_RAW);\n            }\n\n            // Deletes an existing category\n            if ($user->perm->hasPermission($user->getUserId(), 'delcateg') && $action == 'removecategory') {\n                $categoryId = Filter::filterInput(INPUT_POST, 'cat', FILTER_VALIDATE_INT);\n                $categoryLang = Filter::filterInput(INPUT_POST, 'lang', FILTER_UNSAFE_RAW);\n\n                $category = new Category($faqConfig, [], false);\n                $category->setUser($currentAdminUser);\n                $category->setGroups($currentAdminGroups);\n\n                $categoryRelation = new CategoryRelation($faqConfig);\n\n                $categoryImage = new CategoryImage($faqConfig);\n                $categoryImage->setFileName($category->getCategoryData($categoryId)->getImage());\n\n                if (count($category->getCategoryLanguagesTranslated($categoryId)) === 1) {\n                    $categoryPermission->delete(CategoryPermission::USER, [$categoryId]);\n                    $categoryPermission->delete(CategoryPermission::GROUP, [$categoryId]);\n                    $categoryImage->delete();\n                }\n\n                if (\n                    $category->deleteCategory($categoryId, $categoryLang) &&\n                    $categoryRelation->delete($categoryId, $categoryLang)\n                ) {\n                    printf('<p class=\"alert alert-success\">%s</p>', $PMF_LANG['ad_categ_deleted']);\n                } else {\n                    printf('<p class=\"alert alert-danger\">%s</p>', $faqConfig->getDb()->error());\n                }\n            }\n\n            // Pastes a category\n            if ($action == 'pastecategory') {\n                $category = new Category($faqConfig, [], false);\n                $category->setUser($currentAdminUser);\n                $category->setGroups($currentAdminGroups);\n                $categoryId = Filter::filterInput(INPUT_POST, 'cat', FILTER_VALIDATE_INT);\n                $parentId = Filter::filterInput(INPUT_POST, 'after', FILTER_VALIDATE_INT);\n                if ($category->updateParentCategory((int) $categoryId, (int) $parentId)) {\n                    printf('<p class=\"alert alert-success\">%s</p>', $PMF_LANG['ad_categ_updated']);\n                } else {\n                    printf(\n                        '<p class=\"alert alert-danger\">%s<br>%s</p>',\n                        $PMF_LANG['ad_categ_paste_error'],\n                        $faqConfig->getDb()->error()\n                    );\n                }\n            }\n\n            // Lists all categories\n            $lang = Filter::filterInput(INPUT_POST, 'lang', FILTER_UNSAFE_RAW, $faqLangCode);\n\n            // If we changed the category tree, unset the object\n            if (isset($category)) {\n                unset($category);\n            }\n\n            $category = new Category($faqConfig, $currentAdminGroups, true);\n            $category->setUser($currentAdminUser);\n            $category->setGroups($currentAdminGroups);\n            $category->getMissingCategories();\n            $category->buildCategoryTree();\n\n            $open = $lastCatId = $openDiv = 0;\n\n            echo '<div class=\"list-group list-group-root\">';\n            foreach ($category->getCategoryTree() as $id => $cat) {\n                // CategoryHelper translated in this language?\n                if ($cat['lang'] == $lang) {\n                    $categoryName = Strings::htmlentities($cat['name']);\n                } else {\n                    $categoryName = Strings::htmlentities($cat['name']) .\n                        ' (' . $languageCodes[strtoupper($cat['lang'])] . ')';\n                }\n\n\n                // Has permissions, show lock icon\n                if ($categoryPermission->isRestricted($cat['id'])) {\n                    $categoryName .= ' <i class=\"fa fa-lock\" aria-hidden=\"true\"></i>';\n                }\n\n                   // Category is shown on start page\n                if ((int)$cat['show_home'] === 1) {\n                    $categoryName .= ' <i class=\"fa fa-star\" aria-hidden=\"true\"></i>';\n                }\n\n                // Category is inactive\n                if ((int)$cat['active'] === 0) {\n                    $categoryName .= ' <i class=\"fa fa-eye-slash\" aria-hidden=\"true\"></i>';\n                }\n\n                // Level of the category\n                $level = $cat['indent'];\n\n                // Any sub-categories?\n                $subCategories = $category->getChildren($cat['id']);\n                $numSubCategories = count($subCategories);\n\n                $hasParent = (bool) $cat['parent_id'];\n\n                if ($hasParent) {\n                    printf(\n                        '<div class=\"list-group collapse\" id=\"category-id-%d\">',\n                        $cat['parent_id']\n                    );\n                }\n\n                printf(\n                    '<div href=\"#category-id-%d\" id=\"%s-%d\" class=\"list-group-item list-group-item-action border-left-0 border-right-0 d-flex justify-content-between align-items-center\" %s>',\n                    $cat['id'],\n                    trim(strip_tags($categoryName)),\n                    $cat['id'],\n                    $numSubCategories > 0 ? 'data-toggle=\"collapse\"' : ''\n                );\n                printf(\n                    '<span>%s %s</span>',\n                    $numSubCategories > 0 ? '<i class=\"fa fa-caret-right pmf-has-subcategories\"></i>' : '',\n                    $categoryName\n                );\n\n                // Buttons:\n                echo '<span>';\n                // Add FAQ to category (always)\n                printf(\n                    '<a class=\"btn btn-info btn-sm\" href=\"?action=editentry&amp;cat=%s&amp;lang=%s\"><i aria-hidden=\"true\" class=\"fa fa-indent\" title=\"%s\"></i></a></a> ',\n                    $cat['id'],\n                    $cat['lang'],\n                    $PMF_LANG['ad_quick_entry']\n                );\n\n                if ($cat['lang'] == $lang) {\n                    // add sub category (if current language)\n                    printf(\n                        '<a class=\"btn btn-info btn-sm\" href=\"?action=addcategory&amp;cat=%s&amp;lang=%s\"><i aria-hidden=\"true\" class=\"fa fa-plus-square\" title=\"%s\"></i></a> ',\n                        $cat['id'],\n                        $cat['lang'],\n                        $PMF_LANG['ad_quick_category']\n                    );\n\n                    // rename (sub) category (if current language)\n                    printf(\n                        '<a class=\"btn btn-info btn-sm\" href=\"?action=editcategory&amp;cat=%s\"><i aria-hidden=\"true\" class=\"fa fa-edit\" title=\"%s\"></i></a> ',\n                        $cat['id'],\n                        $PMF_LANG['ad_kateg_rename']\n                    );\n                }\n\n                // translate category (always)\n                printf(\n                    '<a class=\"btn btn-info btn-sm\" href=\"?action=translatecategory&amp;cat=%s\"><i aria-hidden=\"true\" class=\"fa fa-globe\" title=\"%s\"></i></a> ',\n                    $cat['id'],\n                    $PMF_LANG['ad_categ_translate']\n                );\n\n                // delete (sub) category (if current language)\n                if (count($category->getChildren($cat['id'])) == 0 && $cat['lang'] == $lang) {\n                    printf(\n                        '<a class=\"btn btn-danger btn-sm\" href=\"?action=deletecategory&amp;cat=%s&amp;catlang=%s\"><i aria-hidden=\"true\" class=\"fa fa-trash\" title=\"%s\"></i></a> ',\n                        $cat['id'],\n                        $cat['lang'],\n                        $PMF_LANG['ad_categ_delete']\n                    );\n                } else {\n                    echo '<a class=\"btn btn-inverse btn-sm\" style=\"cursor: not-allowed;\"><i aria-hidden=\"true\" class=\"fa fa-trash\"></i></a>';\n                }\n\n                if ($cat['lang'] == $lang) {\n                    // cut category (if current language)\n                    printf(\n                        '<a class=\"btn btn-warning btn-sm\" href=\"?action=cutcategory&amp;cat=%s\"><i aria-hidden=\"true\" class=\"fa fa-cut\" title=\"%s\"></i></a>  ',\n                        $cat['id'],\n                        $PMF_LANG['ad_categ_cut']\n                    );\n                }\n                echo '</span>';\n                echo '</div>';\n\n                if ($hasParent) {\n                    echo '</div>';\n                }\n\n                $lastCatId = $cat['id'];\n            }\n            ?>\n      <div class=\"d-flex flex-row\">\n      <form method=\"post\">\n        <input type=\"hidden\" name=\"csrf\" value=\"<?= $user->getCsrfTokenFromSession() ?>\">\n        <button class=\"pmf-save-category-order text-white btn btn-primary mt-3 mr-1\">\n            <?= $PMF_LANG['ad_categ_save_order'] ?>\n        </button>\n      </form>\n      </div>\n      <p class=\"alert alert-info mt-4\"><?= $PMF_LANG['ad_categ_remark'] ?></p>\n    </div>\n  </div>\n  <script src=\"assets/js/category.js\"></script>\n            <?php\n        } else {\n            echo $PMF_LANG['err_NotAuth'];\n        }\n"], "filenames": ["phpmyfaq/admin/category.edit.php", "phpmyfaq/admin/category.main.php"], "buggy_code_start_loc": [21, 158], "buggy_code_end_loc": [96, 160], "fixing_code_start_loc": [22, 158], "fixing_code_end_loc": [98, 160], "type": "CWE-79", "message": "Cross-site Scripting (XSS) - Stored in GitHub repository thorsten/phpmyfaq prior to 3.1.12.", "other": {"cve": {"id": "CVE-2023-1879", "sourceIdentifier": "security@huntr.dev", "published": "2023-04-05T17:15:07.083", "lastModified": "2023-04-11T18:16:06.953", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Cross-site Scripting (XSS) - Stored in GitHub repository thorsten/phpmyfaq prior to 3.1.12."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 5.4, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.3, "impactScore": 2.7}], "cvssMetricV30": [{"source": "security@huntr.dev", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:H/UI:N/S:U/C:L/I:L/A:L", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "HIGH", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "LOW", "baseScore": 4.7, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 1.2, "impactScore": 3.4}]}, "weaknesses": [{"source": "security@huntr.dev", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:phpmyfaq:phpmyfaq:*:*:*:*:*:*:*:*", "versionEndExcluding": "3.1.12", "matchCriteriaId": "653EC167-06FC-4D30-AAF8-B75F596519AE"}]}]}], "references": [{"url": "https://github.com/thorsten/phpmyfaq/commit/0dc8e527c375007cd4b8dbf61f7167393a6f6e91", "source": "security@huntr.dev", "tags": ["Patch"]}, {"url": "https://huntr.dev/bounties/1dc7f818-c8ea-4f80-b000-31b48a426334", "source": "security@huntr.dev", "tags": ["Exploit", "Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/thorsten/phpmyfaq/commit/0dc8e527c375007cd4b8dbf61f7167393a6f6e91"}}