{"buggy_code": ["/**\n * This code is mostly from the old Etherpad. Please help us to comment this code. \n * This helps other people to understand this code better and helps them to improve it.\n * TL;DR COMMENTS ON THIS FILE ARE HIGHLY APPRECIATED\n */\n\n/**\n * Copyright 2009 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nvar Security = require('./security');\n\n/**\n * Generates a random String with the given length. Is needed to generate the Author, Group, readonly, session Ids\n */\n\nfunction randomString(len)\n{\n  var chars = \"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz\";\n  var randomstring = '';\n  len = len || 20\n  for (var i = 0; i < len; i++)\n  {\n    var rnum = Math.floor(Math.random() * chars.length);\n    randomstring += chars.substring(rnum, rnum + 1);\n  }\n  return randomstring;\n}\n\nfunction createCookie(name, value, days, path){ /* Used by IE */\n  if (days)\n  {\n    var date = new Date();\n    date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));\n    var expires = \"; expires=\" + date.toGMTString();\n  }\n  else{\n    var expires = \"\";\n  }\n\n  if(!path){ // IF the Path of the cookie isn't set then just create it on root\n    path = \"/\";\n  }\n  \n  //Check if we accessed the pad over https\n  var secure = window.location.protocol == \"https:\" ? \";secure\" : \"\";\n\n  //Check if the browser is IE and if so make sure the full path is set in the cookie\n  if((navigator.appName == 'Microsoft Internet Explorer') || ((navigator.appName == 'Netscape') && (new RegExp(\"Trident/.*rv:([0-9]{1,}[\\.0-9]{0,})\").exec(navigator.userAgent) != null))){\n    document.cookie = name + \"=\" + value + expires + \"; path=/\" + secure; /* Note this bodge fix for IE is temporary until auth is rewritten */\n  }\n  else{\n    document.cookie = name + \"=\" + value + expires + \"; path=\" + path + secure;\n  }\n\n}\n\nfunction readCookie(name)\n{\n  var nameEQ = name + \"=\";\n  var ca = document.cookie.split(';');\n  for (var i = 0; i < ca.length; i++)\n  {\n    var c = ca[i];\n    while (c.charAt(0) == ' ') c = c.substring(1, c.length);\n    if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);\n  }\n  return null;\n}\n\nvar padutils = {\n  escapeHtml: function(x)\n  {\n    return Security.escapeHTML(String(x));\n  },\n  uniqueId: function()\n  {\n    var pad = require('./pad').pad; // Sidestep circular dependency\n    function encodeNum(n, width)\n    {\n      // returns string that is exactly 'width' chars, padding with zeros\n      // and taking rightmost digits\n      return (Array(width + 1).join('0') + Number(n).toString(35)).slice(-width);\n    }\n    return [pad.getClientIp(), encodeNum(+new Date, 7), encodeNum(Math.floor(Math.random() * 1e9), 4)].join('.');\n  },\n  uaDisplay: function(ua)\n  {\n    var m;\n\n    function clean(a)\n    {\n      var maxlen = 16;\n      a = a.replace(/[^a-zA-Z0-9\\.]/g, '');\n      if (a.length > maxlen)\n      {\n        a = a.substr(0, maxlen);\n      }\n      return a;\n    }\n\n    function checkver(name)\n    {\n      var m = ua.match(RegExp(name + '\\\\/([\\\\d\\\\.]+)'));\n      if (m && m.length > 1)\n      {\n        return clean(name + m[1]);\n      }\n      return null;\n    }\n\n    // firefox\n    if (checkver('Firefox'))\n    {\n      return checkver('Firefox');\n    }\n\n    // misc browsers, including IE\n    m = ua.match(/compatible; ([^;]+);/);\n    if (m && m.length > 1)\n    {\n      return clean(m[1]);\n    }\n\n    // iphone\n    if (ua.match(/\\(iPhone;/))\n    {\n      return 'iPhone';\n    }\n\n    // chrome\n    if (checkver('Chrome'))\n    {\n      return checkver('Chrome');\n    }\n\n    // safari\n    m = ua.match(/Safari\\/[\\d\\.]+/);\n    if (m)\n    {\n      var v = '?';\n      m = ua.match(/Version\\/([\\d\\.]+)/);\n      if (m && m.length > 1)\n      {\n        v = m[1];\n      }\n      return clean('Safari' + v);\n    }\n\n    // everything else\n    var x = ua.split(' ')[0];\n    return clean(x);\n  },\n  // e.g. \"Thu Jun 18 2009 13:09\"\n  simpleDateTime: function(date)\n  {\n    var d = new Date(+date); // accept either number or date\n    var dayOfWeek = (['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'])[d.getDay()];\n    var month = (['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'])[d.getMonth()];\n    var dayOfMonth = d.getDate();\n    var year = d.getFullYear();\n    var hourmin = d.getHours() + \":\" + (\"0\" + d.getMinutes()).slice(-2);\n    return dayOfWeek + ' ' + month + ' ' + dayOfMonth + ' ' + year + ' ' + hourmin;\n  },\n  findURLs: function(text)\n  {\n    // copied from ACE\n    var _REGEX_WORDCHAR = /[\\u0030-\\u0039\\u0041-\\u005A\\u0061-\\u007A\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u00FF\\u0100-\\u1FFF\\u3040-\\u9FFF\\uF900-\\uFDFF\\uFE70-\\uFEFE\\uFF10-\\uFF19\\uFF21-\\uFF3A\\uFF41-\\uFF5A\\uFF66-\\uFFDC]/;\n    var _REGEX_URLCHAR = new RegExp('(' + /[-:@a-zA-Z0-9_.,~%+\\/?=&#;()$]/.source + '|' + _REGEX_WORDCHAR.source + ')');\n    var _REGEX_URL = new RegExp(/(?:(?:https?|s?ftp|ftps|file|nfs):\\/\\/|(about|geo|mailto|tel):)/.source + _REGEX_URLCHAR.source + '*(?![:.,;])' + _REGEX_URLCHAR.source, 'g');\n\n    // returns null if no URLs, or [[startIndex1, url1], [startIndex2, url2], ...]\n\n\n    function _findURLs(text)\n    {\n      _REGEX_URL.lastIndex = 0;\n      var urls = null;\n      var execResult;\n      while ((execResult = _REGEX_URL.exec(text)))\n      {\n        urls = (urls || []);\n        var startIndex = execResult.index;\n        var url = execResult[0];\n        urls.push([startIndex, url]);\n      }\n\n      return urls;\n    }\n\n    return _findURLs(text);\n  },\n  escapeHtmlWithClickableLinks: function(text, target)\n  {\n    var idx = 0;\n    var pieces = [];\n    var urls = padutils.findURLs(text);\n\n    function advanceTo(i)\n    {\n      if (i > idx)\n      {\n        pieces.push(Security.escapeHTML(text.substring(idx, i)));\n        idx = i;\n      }\n    }\n    if (urls)\n    {\n      for (var j = 0; j < urls.length; j++)\n      {\n        var startIndex = urls[j][0];\n        var href = urls[j][1];\n        advanceTo(startIndex);\n        pieces.push('<a ', (target ? 'target=\"' + Security.escapeHTMLAttribute(target) + '\" ' : ''), 'href=\"', Security.escapeHTMLAttribute(href), '\">');\n        advanceTo(startIndex + href.length);\n        pieces.push('</a>');\n      }\n    }\n    advanceTo(text.length);\n    return pieces.join('');\n  },\n  bindEnterAndEscape: function(node, onEnter, onEscape)\n  {\n\n    // Use keypress instead of keyup in bindEnterAndEscape\n    // Keyup event is fired on enter in IME (Input Method Editor), But\n    // keypress is not. So, I changed to use keypress instead of keyup.\n    // It is work on Windows (IE8, Chrome 6.0.472), CentOs (Firefox 3.0) and Mac OSX (Firefox 3.6.10, Chrome 6.0.472, Safari 5.0).\n    if (onEnter)\n    {\n      node.keypress(function(evt)\n      {\n        if (evt.which == 13)\n        {\n          onEnter(evt);\n        }\n      });\n    }\n\n    if (onEscape)\n    {\n      node.keydown(function(evt)\n      {\n        if (evt.which == 27)\n        {\n          onEscape(evt);\n        }\n      });\n    }\n  },\n  timediff: function(d)\n  {\n    var pad = require('./pad').pad; // Sidestep circular dependency\n    function format(n, word)\n    {\n      n = Math.round(n);\n      return ('' + n + ' ' + word + (n != 1 ? 's' : '') + ' ago');\n    }\n    d = Math.max(0, (+(new Date) - (+d) - pad.clientTimeOffset) / 1000);\n    if (d < 60)\n    {\n      return format(d, 'second');\n    }\n    d /= 60;\n    if (d < 60)\n    {\n      return format(d, 'minute');\n    }\n    d /= 60;\n    if (d < 24)\n    {\n      return format(d, 'hour');\n    }\n    d /= 24;\n    return format(d, 'day');\n  },\n  makeAnimationScheduler: function(funcToAnimateOneStep, stepTime, stepsAtOnce)\n  {\n    if (stepsAtOnce === undefined)\n    {\n      stepsAtOnce = 1;\n    }\n\n    var animationTimer = null;\n\n    function scheduleAnimation()\n    {\n      if (!animationTimer)\n      {\n        animationTimer = window.setTimeout(function()\n        {\n          animationTimer = null;\n          var n = stepsAtOnce;\n          var moreToDo = true;\n          while (moreToDo && n > 0)\n          {\n            moreToDo = funcToAnimateOneStep();\n            n--;\n          }\n          if (moreToDo)\n          {\n            // more to do\n            scheduleAnimation();\n          }\n        }, stepTime * stepsAtOnce);\n      }\n    }\n    return {\n      scheduleAnimation: scheduleAnimation\n    };\n  },\n  makeShowHideAnimator: function(funcToArriveAtState, initiallyShown, fps, totalMs)\n  {\n    var animationState = (initiallyShown ? 0 : -2); // -2 hidden, -1 to 0 fade in, 0 to 1 fade out\n    var animationFrameDelay = 1000 / fps;\n    var animationStep = animationFrameDelay / totalMs;\n\n    var scheduleAnimation = padutils.makeAnimationScheduler(animateOneStep, animationFrameDelay).scheduleAnimation;\n\n    function doShow()\n    {\n      animationState = -1;\n      funcToArriveAtState(animationState);\n      scheduleAnimation();\n    }\n\n    function doQuickShow()\n    { // start showing without losing any fade-in progress\n      if (animationState < -1)\n      {\n        animationState = -1;\n      }\n      else if (animationState <= 0)\n      {\n        animationState = animationState;\n      }\n      else\n      {\n        animationState = Math.max(-1, Math.min(0, -animationState));\n      }\n      funcToArriveAtState(animationState);\n      scheduleAnimation();\n    }\n\n    function doHide()\n    {\n      if (animationState >= -1 && animationState <= 0)\n      {\n        animationState = 1e-6;\n        scheduleAnimation();\n      }\n    }\n\n    function animateOneStep()\n    {\n      if (animationState < -1 || animationState == 0)\n      {\n        return false;\n      }\n      else if (animationState < 0)\n      {\n        // animate show\n        animationState += animationStep;\n        if (animationState >= 0)\n        {\n          animationState = 0;\n          funcToArriveAtState(animationState);\n          return false;\n        }\n        else\n        {\n          funcToArriveAtState(animationState);\n          return true;\n        }\n      }\n      else if (animationState > 0)\n      {\n        // animate hide\n        animationState += animationStep;\n        if (animationState >= 1)\n        {\n          animationState = 1;\n          funcToArriveAtState(animationState);\n          animationState = -2;\n          return false;\n        }\n        else\n        {\n          funcToArriveAtState(animationState);\n          return true;\n        }\n      }\n    }\n\n    return {\n      show: doShow,\n      hide: doHide,\n      quickShow: doQuickShow\n    };\n  },\n  _nextActionId: 1,\n  uncanceledActions: {},\n  getCancellableAction: function(actionType, actionFunc)\n  {\n    var o = padutils.uncanceledActions[actionType];\n    if (!o)\n    {\n      o = {};\n      padutils.uncanceledActions[actionType] = o;\n    }\n    var actionId = (padutils._nextActionId++);\n    o[actionId] = true;\n    return function()\n    {\n      var p = padutils.uncanceledActions[actionType];\n      if (p && p[actionId])\n      {\n        actionFunc();\n      }\n    };\n  },\n  cancelActions: function(actionType)\n  {\n    var o = padutils.uncanceledActions[actionType];\n    if (o)\n    {\n      // clear it\n      delete padutils.uncanceledActions[actionType];\n    }\n  },\n  makeFieldLabeledWhenEmpty: function(field, labelText)\n  {\n    field = $(field);\n\n    function clear()\n    {\n      field.addClass('editempty');\n      field.val(labelText);\n    }\n    field.focus(function()\n    {\n      if (field.hasClass('editempty'))\n      {\n        field.val('');\n      }\n      field.removeClass('editempty');\n    });\n    field.blur(function()\n    {\n      if (!field.val())\n      {\n        clear();\n      }\n    });\n    return {\n      clear: clear\n    };\n  },\n  getCheckbox: function(node)\n  {\n    return $(node).is(':checked');\n  },\n  setCheckbox: function(node, value)\n  {\n    if (value)\n    {\n      $(node).attr('checked', 'checked');\n    }\n    else\n    {\n      $(node).removeAttr('checked');\n    }\n  },\n  bindCheckboxChange: function(node, func)\n  {\n    $(node).change(func);\n  },\n  encodeUserId: function(userId)\n  {\n    return userId.replace(/[^a-y0-9]/g, function(c)\n    {\n      if (c == \".\") return \"-\";\n      return 'z' + c.charCodeAt(0) + 'z';\n    });\n  },\n  decodeUserId: function(encodedUserId)\n  {\n    return encodedUserId.replace(/[a-y0-9]+|-|z.+?z/g, function(cc)\n    {\n      if (cc == '-') return '.';\n      else if (cc.charAt(0) == 'z')\n      {\n        return String.fromCharCode(Number(cc.slice(1, -1)));\n      }\n      else\n      {\n        return cc;\n      }\n    });\n  }\n};\n\nvar globalExceptionHandler = undefined;\nfunction setupGlobalExceptionHandler() {\n  if (!globalExceptionHandler) {\n    globalExceptionHandler = function test (msg, url, linenumber)\n    {\n      var errorId = randomString(20);\n      var userAgent = padutils.escapeHtml(navigator.userAgent);\n      if ($(\"#editorloadingbox\").attr(\"display\") != \"none\"){\n        //show javascript errors to the user\n        $(\"#editorloadingbox\").css(\"padding\", \"10px\");\n        $(\"#editorloadingbox\").css(\"padding-top\", \"45px\");\n        $(\"#editorloadingbox\").html(\"<div style='text-align:left;color:red;font-size:16px;'><b>An error occurred</b><br>The error was reported with the following id: '\" + errorId + \"'<br><br><span style='color:black;font-weight:bold;font-size:16px'>Please press and hold Ctrl and press F5 to reload this page, if the problem persists please send this error message to your webmaster: </span><div style='color:black;font-size:14px'>'\"\n          + \"ErrorId: \" + errorId + \"<br>URL: \" + window.location.href + \"<br>UserAgent: \" + userAgent + \"<br>\" + msg + \" in \" + url + \" at line \" + linenumber + \"'</div></div>\");\n      }\n\n      //send javascript errors to the server\n      var errObj = {errorInfo: JSON.stringify({errorId: errorId, msg: msg, url: window.location.href, linenumber: linenumber, userAgent: navigator.userAgent})};\n      var loc = document.location;\n      var url = loc.protocol + \"//\" + loc.hostname + \":\" + loc.port + \"/\" + loc.pathname.substr(1, loc.pathname.indexOf(\"/p/\")) + \"jserror\";\n \n      $.post(url, errObj);\n \n      return false;\n    };\n    window.onerror = globalExceptionHandler;\n  }\n}\n\npadutils.setupGlobalExceptionHandler = setupGlobalExceptionHandler;\n\npadutils.binarySearch = require('./ace2_common').binarySearch;\n\nexports.randomString = randomString;\nexports.createCookie = createCookie;\nexports.readCookie = readCookie;\nexports.padutils = padutils;\n"], "fixing_code": ["/**\n * This code is mostly from the old Etherpad. Please help us to comment this code. \n * This helps other people to understand this code better and helps them to improve it.\n * TL;DR COMMENTS ON THIS FILE ARE HIGHLY APPRECIATED\n */\n\n/**\n * Copyright 2009 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nvar Security = require('./security');\n\n/**\n * Generates a random String with the given length. Is needed to generate the Author, Group, readonly, session Ids\n */\n\nfunction randomString(len)\n{\n  var chars = \"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz\";\n  var randomstring = '';\n  len = len || 20\n  for (var i = 0; i < len; i++)\n  {\n    var rnum = Math.floor(Math.random() * chars.length);\n    randomstring += chars.substring(rnum, rnum + 1);\n  }\n  return randomstring;\n}\n\nfunction createCookie(name, value, days, path){ /* Used by IE */\n  if (days)\n  {\n    var date = new Date();\n    date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));\n    var expires = \"; expires=\" + date.toGMTString();\n  }\n  else{\n    var expires = \"\";\n  }\n\n  if(!path){ // IF the Path of the cookie isn't set then just create it on root\n    path = \"/\";\n  }\n  \n  //Check if we accessed the pad over https\n  var secure = window.location.protocol == \"https:\" ? \";secure\" : \"\";\n\n  //Check if the browser is IE and if so make sure the full path is set in the cookie\n  if((navigator.appName == 'Microsoft Internet Explorer') || ((navigator.appName == 'Netscape') && (new RegExp(\"Trident/.*rv:([0-9]{1,}[\\.0-9]{0,})\").exec(navigator.userAgent) != null))){\n    document.cookie = name + \"=\" + value + expires + \"; path=/\" + secure; /* Note this bodge fix for IE is temporary until auth is rewritten */\n  }\n  else{\n    document.cookie = name + \"=\" + value + expires + \"; path=\" + path + secure;\n  }\n\n}\n\nfunction readCookie(name)\n{\n  var nameEQ = name + \"=\";\n  var ca = document.cookie.split(';');\n  for (var i = 0; i < ca.length; i++)\n  {\n    var c = ca[i];\n    while (c.charAt(0) == ' ') c = c.substring(1, c.length);\n    if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);\n  }\n  return null;\n}\n\nvar padutils = {\n  escapeHtml: function(x)\n  {\n    return Security.escapeHTML(String(x));\n  },\n  uniqueId: function()\n  {\n    var pad = require('./pad').pad; // Sidestep circular dependency\n    function encodeNum(n, width)\n    {\n      // returns string that is exactly 'width' chars, padding with zeros\n      // and taking rightmost digits\n      return (Array(width + 1).join('0') + Number(n).toString(35)).slice(-width);\n    }\n    return [pad.getClientIp(), encodeNum(+new Date, 7), encodeNum(Math.floor(Math.random() * 1e9), 4)].join('.');\n  },\n  uaDisplay: function(ua)\n  {\n    var m;\n\n    function clean(a)\n    {\n      var maxlen = 16;\n      a = a.replace(/[^a-zA-Z0-9\\.]/g, '');\n      if (a.length > maxlen)\n      {\n        a = a.substr(0, maxlen);\n      }\n      return a;\n    }\n\n    function checkver(name)\n    {\n      var m = ua.match(RegExp(name + '\\\\/([\\\\d\\\\.]+)'));\n      if (m && m.length > 1)\n      {\n        return clean(name + m[1]);\n      }\n      return null;\n    }\n\n    // firefox\n    if (checkver('Firefox'))\n    {\n      return checkver('Firefox');\n    }\n\n    // misc browsers, including IE\n    m = ua.match(/compatible; ([^;]+);/);\n    if (m && m.length > 1)\n    {\n      return clean(m[1]);\n    }\n\n    // iphone\n    if (ua.match(/\\(iPhone;/))\n    {\n      return 'iPhone';\n    }\n\n    // chrome\n    if (checkver('Chrome'))\n    {\n      return checkver('Chrome');\n    }\n\n    // safari\n    m = ua.match(/Safari\\/[\\d\\.]+/);\n    if (m)\n    {\n      var v = '?';\n      m = ua.match(/Version\\/([\\d\\.]+)/);\n      if (m && m.length > 1)\n      {\n        v = m[1];\n      }\n      return clean('Safari' + v);\n    }\n\n    // everything else\n    var x = ua.split(' ')[0];\n    return clean(x);\n  },\n  // e.g. \"Thu Jun 18 2009 13:09\"\n  simpleDateTime: function(date)\n  {\n    var d = new Date(+date); // accept either number or date\n    var dayOfWeek = (['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'])[d.getDay()];\n    var month = (['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'])[d.getMonth()];\n    var dayOfMonth = d.getDate();\n    var year = d.getFullYear();\n    var hourmin = d.getHours() + \":\" + (\"0\" + d.getMinutes()).slice(-2);\n    return dayOfWeek + ' ' + month + ' ' + dayOfMonth + ' ' + year + ' ' + hourmin;\n  },\n  findURLs: function(text)\n  {\n    // copied from ACE\n    var _REGEX_WORDCHAR = /[\\u0030-\\u0039\\u0041-\\u005A\\u0061-\\u007A\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u00FF\\u0100-\\u1FFF\\u3040-\\u9FFF\\uF900-\\uFDFF\\uFE70-\\uFEFE\\uFF10-\\uFF19\\uFF21-\\uFF3A\\uFF41-\\uFF5A\\uFF66-\\uFFDC]/;\n    var _REGEX_URLCHAR = new RegExp('(' + /[-:@a-zA-Z0-9_.,~%+\\/?=&#;()$]/.source + '|' + _REGEX_WORDCHAR.source + ')');\n    var _REGEX_URL = new RegExp(/(?:(?:https?|s?ftp|ftps|file|nfs):\\/\\/|(about|geo|mailto|tel):)/.source + _REGEX_URLCHAR.source + '*(?![:.,;])' + _REGEX_URLCHAR.source, 'g');\n\n    // returns null if no URLs, or [[startIndex1, url1], [startIndex2, url2], ...]\n\n\n    function _findURLs(text)\n    {\n      _REGEX_URL.lastIndex = 0;\n      var urls = null;\n      var execResult;\n      while ((execResult = _REGEX_URL.exec(text)))\n      {\n        urls = (urls || []);\n        var startIndex = execResult.index;\n        var url = execResult[0];\n        urls.push([startIndex, url]);\n      }\n\n      return urls;\n    }\n\n    return _findURLs(text);\n  },\n  escapeHtmlWithClickableLinks: function(text, target)\n  {\n    var idx = 0;\n    var pieces = [];\n    var urls = padutils.findURLs(text);\n\n    function advanceTo(i)\n    {\n      if (i > idx)\n      {\n        pieces.push(Security.escapeHTML(text.substring(idx, i)));\n        idx = i;\n      }\n    }\n    if (urls)\n    {\n      for (var j = 0; j < urls.length; j++)\n      {\n        var startIndex = urls[j][0];\n        var href = urls[j][1];\n        advanceTo(startIndex);\n        pieces.push('<a ', (target ? 'target=\"' + Security.escapeHTMLAttribute(target) + '\" ' : ''), 'href=\"', Security.escapeHTMLAttribute(href), '\">');\n        advanceTo(startIndex + href.length);\n        pieces.push('</a>');\n      }\n    }\n    advanceTo(text.length);\n    return pieces.join('');\n  },\n  bindEnterAndEscape: function(node, onEnter, onEscape)\n  {\n\n    // Use keypress instead of keyup in bindEnterAndEscape\n    // Keyup event is fired on enter in IME (Input Method Editor), But\n    // keypress is not. So, I changed to use keypress instead of keyup.\n    // It is work on Windows (IE8, Chrome 6.0.472), CentOs (Firefox 3.0) and Mac OSX (Firefox 3.6.10, Chrome 6.0.472, Safari 5.0).\n    if (onEnter)\n    {\n      node.keypress(function(evt)\n      {\n        if (evt.which == 13)\n        {\n          onEnter(evt);\n        }\n      });\n    }\n\n    if (onEscape)\n    {\n      node.keydown(function(evt)\n      {\n        if (evt.which == 27)\n        {\n          onEscape(evt);\n        }\n      });\n    }\n  },\n  timediff: function(d)\n  {\n    var pad = require('./pad').pad; // Sidestep circular dependency\n    function format(n, word)\n    {\n      n = Math.round(n);\n      return ('' + n + ' ' + word + (n != 1 ? 's' : '') + ' ago');\n    }\n    d = Math.max(0, (+(new Date) - (+d) - pad.clientTimeOffset) / 1000);\n    if (d < 60)\n    {\n      return format(d, 'second');\n    }\n    d /= 60;\n    if (d < 60)\n    {\n      return format(d, 'minute');\n    }\n    d /= 60;\n    if (d < 24)\n    {\n      return format(d, 'hour');\n    }\n    d /= 24;\n    return format(d, 'day');\n  },\n  makeAnimationScheduler: function(funcToAnimateOneStep, stepTime, stepsAtOnce)\n  {\n    if (stepsAtOnce === undefined)\n    {\n      stepsAtOnce = 1;\n    }\n\n    var animationTimer = null;\n\n    function scheduleAnimation()\n    {\n      if (!animationTimer)\n      {\n        animationTimer = window.setTimeout(function()\n        {\n          animationTimer = null;\n          var n = stepsAtOnce;\n          var moreToDo = true;\n          while (moreToDo && n > 0)\n          {\n            moreToDo = funcToAnimateOneStep();\n            n--;\n          }\n          if (moreToDo)\n          {\n            // more to do\n            scheduleAnimation();\n          }\n        }, stepTime * stepsAtOnce);\n      }\n    }\n    return {\n      scheduleAnimation: scheduleAnimation\n    };\n  },\n  makeShowHideAnimator: function(funcToArriveAtState, initiallyShown, fps, totalMs)\n  {\n    var animationState = (initiallyShown ? 0 : -2); // -2 hidden, -1 to 0 fade in, 0 to 1 fade out\n    var animationFrameDelay = 1000 / fps;\n    var animationStep = animationFrameDelay / totalMs;\n\n    var scheduleAnimation = padutils.makeAnimationScheduler(animateOneStep, animationFrameDelay).scheduleAnimation;\n\n    function doShow()\n    {\n      animationState = -1;\n      funcToArriveAtState(animationState);\n      scheduleAnimation();\n    }\n\n    function doQuickShow()\n    { // start showing without losing any fade-in progress\n      if (animationState < -1)\n      {\n        animationState = -1;\n      }\n      else if (animationState <= 0)\n      {\n        animationState = animationState;\n      }\n      else\n      {\n        animationState = Math.max(-1, Math.min(0, -animationState));\n      }\n      funcToArriveAtState(animationState);\n      scheduleAnimation();\n    }\n\n    function doHide()\n    {\n      if (animationState >= -1 && animationState <= 0)\n      {\n        animationState = 1e-6;\n        scheduleAnimation();\n      }\n    }\n\n    function animateOneStep()\n    {\n      if (animationState < -1 || animationState == 0)\n      {\n        return false;\n      }\n      else if (animationState < 0)\n      {\n        // animate show\n        animationState += animationStep;\n        if (animationState >= 0)\n        {\n          animationState = 0;\n          funcToArriveAtState(animationState);\n          return false;\n        }\n        else\n        {\n          funcToArriveAtState(animationState);\n          return true;\n        }\n      }\n      else if (animationState > 0)\n      {\n        // animate hide\n        animationState += animationStep;\n        if (animationState >= 1)\n        {\n          animationState = 1;\n          funcToArriveAtState(animationState);\n          animationState = -2;\n          return false;\n        }\n        else\n        {\n          funcToArriveAtState(animationState);\n          return true;\n        }\n      }\n    }\n\n    return {\n      show: doShow,\n      hide: doHide,\n      quickShow: doQuickShow\n    };\n  },\n  _nextActionId: 1,\n  uncanceledActions: {},\n  getCancellableAction: function(actionType, actionFunc)\n  {\n    var o = padutils.uncanceledActions[actionType];\n    if (!o)\n    {\n      o = {};\n      padutils.uncanceledActions[actionType] = o;\n    }\n    var actionId = (padutils._nextActionId++);\n    o[actionId] = true;\n    return function()\n    {\n      var p = padutils.uncanceledActions[actionType];\n      if (p && p[actionId])\n      {\n        actionFunc();\n      }\n    };\n  },\n  cancelActions: function(actionType)\n  {\n    var o = padutils.uncanceledActions[actionType];\n    if (o)\n    {\n      // clear it\n      delete padutils.uncanceledActions[actionType];\n    }\n  },\n  makeFieldLabeledWhenEmpty: function(field, labelText)\n  {\n    field = $(field);\n\n    function clear()\n    {\n      field.addClass('editempty');\n      field.val(labelText);\n    }\n    field.focus(function()\n    {\n      if (field.hasClass('editempty'))\n      {\n        field.val('');\n      }\n      field.removeClass('editempty');\n    });\n    field.blur(function()\n    {\n      if (!field.val())\n      {\n        clear();\n      }\n    });\n    return {\n      clear: clear\n    };\n  },\n  getCheckbox: function(node)\n  {\n    return $(node).is(':checked');\n  },\n  setCheckbox: function(node, value)\n  {\n    if (value)\n    {\n      $(node).attr('checked', 'checked');\n    }\n    else\n    {\n      $(node).removeAttr('checked');\n    }\n  },\n  bindCheckboxChange: function(node, func)\n  {\n    $(node).change(func);\n  },\n  encodeUserId: function(userId)\n  {\n    return userId.replace(/[^a-y0-9]/g, function(c)\n    {\n      if (c == \".\") return \"-\";\n      return 'z' + c.charCodeAt(0) + 'z';\n    });\n  },\n  decodeUserId: function(encodedUserId)\n  {\n    return encodedUserId.replace(/[a-y0-9]+|-|z.+?z/g, function(cc)\n    {\n      if (cc == '-') return '.';\n      else if (cc.charAt(0) == 'z')\n      {\n        return String.fromCharCode(Number(cc.slice(1, -1)));\n      }\n      else\n      {\n        return cc;\n      }\n    });\n  }\n};\n\nvar globalExceptionHandler = undefined;\nfunction setupGlobalExceptionHandler() {\n  if (!globalExceptionHandler) {\n    globalExceptionHandler = function test (msg, url, linenumber)\n    {\n      var errorId = randomString(20);\n      var userAgent = padutils.escapeHtml(navigator.userAgent);\n      if ($(\"#editorloadingbox\").attr(\"display\") != \"none\"){\n        //show javascript errors to the user\n        $(\"#editorloadingbox\").css(\"padding\", \"10px\");\n        $(\"#editorloadingbox\").css(\"padding-top\", \"45px\");\n        $(\"#editorloadingbox\").html(\"<div style='text-align:left;color:red;font-size:16px;'><b>An error occurred</b><br>The error was reported with the following id: '\" + errorId + \"'<br><br><span style='color:black;font-weight:bold;font-size:16px'>Please press and hold Ctrl and press F5 to reload this page, if the problem persists please send this error message to your webmaster: </span><div style='color:black;font-size:14px'>'\"\n          + \"ErrorId: \" + errorId + \"<br>URL: \" + padutils.escapeHtml(window.location.href) + \"<br>UserAgent: \" + userAgent + \"<br>\" + msg + \" in \" + url + \" at line \" + linenumber + \"'</div></div>\");\n      }\n\n      //send javascript errors to the server\n      var errObj = {errorInfo: JSON.stringify({errorId: errorId, msg: msg, url: window.location.href, linenumber: linenumber, userAgent: navigator.userAgent})};\n      var loc = document.location;\n      var url = loc.protocol + \"//\" + loc.hostname + \":\" + loc.port + \"/\" + loc.pathname.substr(1, loc.pathname.indexOf(\"/p/\")) + \"jserror\";\n \n      $.post(url, errObj);\n \n      return false;\n    };\n    window.onerror = globalExceptionHandler;\n  }\n}\n\npadutils.setupGlobalExceptionHandler = setupGlobalExceptionHandler;\n\npadutils.binarySearch = require('./ace2_common').binarySearch;\n\nexports.randomString = randomString;\nexports.createCookie = createCookie;\nexports.readCookie = readCookie;\nexports.padutils = padutils;\n"], "filenames": ["src/static/js/pad_utils.js"], "buggy_code_start_loc": [527], "buggy_code_end_loc": [528], "fixing_code_start_loc": [527], "fixing_code_end_loc": [528], "type": "CWE-79", "message": "static/js/pad_utils.js in Etherpad Lite before v1.6.3 has XSS via window.location.href.", "other": {"cve": {"id": "CVE-2018-6834", "sourceIdentifier": "cve@mitre.org", "published": "2018-02-08T07:29:01.100", "lastModified": "2018-02-26T18:46:00.097", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "static/js/pad_utils.js in Etherpad Lite before v1.6.3 has XSS via window.location.href."}, {"lang": "es", "value": "static/js/pad_utils.js en Etherpad Lite, en versiones anteriores a la v1.6.3 tiene XSS mediante window.location.href."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:etherpad:etherpad_lite:*:*:*:*:*:*:*:*", "versionEndExcluding": "1.6.3", "matchCriteriaId": "7D675623-7969-4484-A364-B6FA85444408"}]}]}], "references": [{"url": "https://github.com/ether/etherpad-lite/commit/a03422b09468cdd5f192b05643311c705447588b", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/ether/etherpad-lite/releases/tag/1.6.3", "source": "cve@mitre.org", "tags": ["Release Notes", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/ether/etherpad-lite/commit/a03422b09468cdd5f192b05643311c705447588b"}}