{"buggy_code": ["<?php\nuse XoopsModules\\Tadtools\\CkEditor;\nuse XoopsModules\\Tadtools\\FormValidator;\nuse XoopsModules\\Tadtools\\TadUpFiles;\nuse XoopsModules\\Tadtools\\Utility;\n/*-----------\u5f15\u5165\u6a94\u6848\u5340--------------*/\nrequire __DIR__ . '/header.php';\n$xoopsOption['template_main'] = 'tad_discuss_discuss.tpl';\nrequire_once XOOPS_ROOT_PATH . '/header.php';\n$TadUpFiles = new TadUpFiles('tad_discuss');\n/*-----------function\u5340--------------*/\n\n//tad_discuss\u7de8\u8f2f\u8868\u55ae\nfunction tad_discuss_form($BoardID = '', $DefDiscussID = '', $DefReDiscussID = '', $dir = 'left', $mode = '')\n{\n    global $xoopsDB, $xoopsUser, $isAdmin, $xoopsModuleConfig, $xoopsModule, $xoopsTpl, $TadUpFiles;\n\n    if (empty($BoardID)) {\n        return;\n    }\n\n    //\u53d6\u5f97\u672c\u6a21\u7d44\u7de8\u865f\n    $module_id = $xoopsModule->mid();\n\n    //\u53d6\u5f97\u76ee\u524d\u4f7f\u7528\u8005\u7684\u7fa4\u7d44\u7de8\u865f\n    if ($xoopsUser) {\n        $uid = $xoopsUser->uid();\n        $groups = $xoopsUser->getGroups();\n    } else {\n        $uid = 0;\n        $groups = XOOPS_GROUP_ANONYMOUS;\n    }\n\n    $gpermHandler = xoops_getHandler('groupperm');\n\n    if (!$gpermHandler->checkRight('forum_post', $BoardID, $groups, $module_id)) {\n        if ('return' === $mode) {\n            return;\n        }\n\n        header('location:index.php');\n    }\n\n    //\u6293\u53d6\u9810\u8a2d\u503c\n    if (!empty($DefDiscussID)) {\n        $DBV = get_tad_discuss($DefDiscussID);\n    } else {\n        $DBV = [];\n    }\n\n    //\u8a2d\u5b9a\u300cDiscussID\u300d\u6b04\u4f4d\u9810\u8a2d\u503c\n    $DiscussID = (!isset($DBV['DiscussID'])) ? $DefDiscussID : $DBV['DiscussID'];\n\n    //\u8a2d\u5b9a\u300cReDiscussID\u300d\u6b04\u4f4d\u9810\u8a2d\u503c\n    $ReDiscussID = (!isset($DBV['ReDiscussID'])) ? $DefReDiscussID : $DBV['ReDiscussID'];\n\n    //\u8a2d\u5b9a\u300cuid\u300d\u6b04\u4f4d\u9810\u8a2d\u503c\n    $uid = (!isset($DBV['uid'])) ? '' : $DBV['uid'];\n    $uid = (is_object($xoopsUser) and empty($uid)) ? $xoopsUser->uid() : $uid;\n\n    //\u8a2d\u5b9a\u300cDiscussTitle\u300d\u6b04\u4f4d\u9810\u8a2d\u503c\n    $DiscussTitle = (!isset($DBV['DiscussTitle'])) ? '' : $DBV['DiscussTitle'];\n\n    //\u8a2d\u5b9a\u300cDiscussContent\u300d\u6b04\u4f4d\u9810\u8a2d\u503c\n    $DiscussContent = (!isset($DBV['DiscussContent'])) ? '' : $DBV['DiscussContent'];\n\n    //\u8a2d\u5b9a\u300cDiscussDate\u300d\u6b04\u4f4d\u9810\u8a2d\u503c\n    $DiscussDate = (!isset($DBV['DiscussDate'])) ? date('Y-m-d H:i:s') : $DBV['DiscussDate'];\n\n    //\u8a2d\u5b9a\u300cBoardID\u300d\u6b04\u4f4d\u9810\u8a2d\u503c\n    $BoardID = (!isset($DBV['BoardID'])) ? $BoardID : $DBV['BoardID'];\n\n    //\u8a2d\u5b9a\u300cLastTime\u300d\u6b04\u4f4d\u9810\u8a2d\u503c\n    $LastTime = (!isset($DBV['LastTime'])) ? date('Y-m-d H:i:s') : $DBV['LastTime'];\n\n    //\u8a2d\u5b9a\u300cCounter\u300d\u6b04\u4f4d\u9810\u8a2d\u503c\n    $Counter = (!isset($DBV['Counter'])) ? '' : $DBV['Counter'];\n\n    //\u8a2d\u5b9a\u300conlyTo\u300d\u6b04\u4f4d\u9810\u8a2d\u503c\n    $onlyTo = (!isset($DBV['onlyTo'])) ? '' : $DBV['onlyTo'];\n\n    $op = (empty($DiscussID)) ? 'insert_tad_discuss' : 'update_tad_discuss';\n    //$op=\"replace_tad_discuss\";\n\n    $FormValidator = new FormValidator('#myForm', true);\n    $FormValidator->render();\n\n    $RE = !empty($DefReDiscussID) ? get_tad_discuss($DefReDiscussID) : [];\n\n    if (empty($ReDiscussID)) {\n        $board_option = \"<select name='BoardID' class='form-control'>\" . get_tad_discuss_board_option($BoardID) . '</select>';\n        $twidth = '76%';\n    } else {\n        $board_option = \"<input type='hidden' name='BoardID' value='{$BoardID}'>\";\n        $twidth = '99%';\n    }\n\n    if (empty($DefReDiscussID)) {\n        $DiscussTitle = \"\n        <div class='row' style='margin: 10px 0px;'>\n            <div class='col-sm-3'>{$board_option}</div>\n            <div class='col-sm-9'>\n                <input type='text' name='DiscussTitle' value='{$DiscussTitle}' id='DiscussTitle' class='form-control validate[required]' placeholder='\" . _MD_TADDISCUS_INPUT_TITLE . \"' class=''>\n            </div>\n        </div>\";\n    } else {\n        $DiscussTitle = \"\n        {$board_option}\n        <input type='hidden' name='DiscussTitle' value='RE:{$RE['DiscussTitle']}'>\";\n    }\n\n    $Board = get_tad_discuss_board($BoardID);\n    if ('0' == $Board['BoardEnable']) {\n        redirect_header('index.php', 3, _MD_TADDISCUS_BOARD_UNABLE);\n    }\n\n    //$BoardTitle=(empty($DefDiscussID) and empty($DefReDiscussID))?\"<h1><a href='discuss.php?BoardID=$BoardID'>{$Board['BoardTitle']}</a></h1>\":\"\";\n    //die('$BoardID:'.$BoardID.',$DefDiscussID:'.$DefDiscussID.',$DefReDiscussID:'.$DefReDiscussID);\n    if (!empty($BoardID) and empty($DefDiscussID) and empty($DefReDiscussID)) {\n        $BoardTitle = get_board_title($BoardID);\n    }\n\n    $TadUpFiles->set_col('DiscussID', $DefDiscussID); //\u82e5 $show_list_del_file ==true \u6642\u4e00\u5b9a\u8981\u6709\n    $upform = $TadUpFiles->upform(true, 'upfile', 100, true);\n\n    $checked = !empty($onlyTo) ? 'checked' : '';\n    if ($DefReDiscussID) {\n        $RE = get_tad_discuss($DefReDiscussID);\n        $checked = !empty($RE['onlyTo']) ? 'checked' : '';\n    }\n\n    if ('CKEditor' === $xoopsModuleConfig['def_editor']) {\n\n        $ck = new CkEditor('tad_discuss', 'DiscussContent', $DiscussContent);\n        $ck->setToolbarSet('mySimple');\n        $ck->setHeight(250);\n        $editor = $ck->render();\n    } else {\n        $editor = \"<textarea name='DiscussContent' cols='50' rows=8 id='DiscussContent' class='validate[required,minSize[5]]' style='width:100%; height:150px;font-size: 75%;line-height:150%;border:1px dotted #B0B0B0;'>{$DiscussContent}</textarea>\";\n    }\n    $xoopsTpl->assign('def_editor', $xoopsModuleConfig['def_editor']);\n\n    $captcha_js = '';\n    $captcha_div = '';\n    if (!is_object($xoopsUser)) {\n        $captcha_js = \"\n        <link rel='stylesheet' type='text/css' href='class/Qaptcha3/jquery/QapTcha.jquery.css' media='screen'>\n        <script type='text/javascript' src='class/Qaptcha3/jquery/jquery.ui.touch.js'></script>\n        <script type='text/javascript' src='class/Qaptcha3/jquery/QapTcha.jquery.js'></script>\n        <script type='text/javascript'>\n            $(document).ready(function(){\n            $('.QapTcha').QapTcha({disabledSubmit:true , autoRevert:true , PHPfile:'class/Qaptcha3/php/Qaptcha.jquery.php', txtLock:'\" . _MD_TADDISCUS_TXTLOCK . \"' , txtUnlock:'\" . _MD_TADDISCUS_TXTUNLOCK . \"'});\n            });\n        </script>\";\n        $captcha_div = \"<div class='QapTcha'></div>\";\n        $only_root = '';\n    } else {\n        $only_root = \"\n        <label class='checkbox-inline'>\n            <input type='checkbox' name='only_root' value='1' $checked>\" . _MD_TADDISCUS_ONLY_ROOT . '\n        </label>';\n    }\n\n    $DiscussContent = \"\n    $DiscussTitle\n    <div style='margin: 10px 0px;'>\n        {$editor}\n    </div>\n    <div class='row'>\n        <div class='col-sm-6'>\n            {$captcha_div}\n        </div>\n        <div class='col-sm-6 text-right'>\n            {$only_root}\n            <input type='hidden' name='OldBoardID' value='{$BoardID}'>\n            <input type='hidden' name='DiscussID' value='{$DefDiscussID}'>\n            <input type='hidden' name='ReDiscussID' value='{$ReDiscussID}'>\n            <input type='hidden' name='uid' value='{$uid}'>\n            <input type='hidden' name='op' value='{$op}'>\n            <button type='submit' class='btn btn-primary'>\" . _TAD_SAVE . \"</button>\n            {$captcha_js}\n        </div>\n    </div>\n    {$upform}\";\n\n    $DiscussDate = date('Y-m-d H:i:s', xoops_getUserTimestamp(strtotime($DiscussDate)));\n\n    if ('left' === $xoopsModuleConfig['display_mode']) {\n        $dir = 'left';\n        $width = 100;\n    } elseif ('top' === $xoopsModuleConfig['display_mode']) {\n        $dir = 'top';\n        $width = 100;\n    } elseif ('bottom' === $xoopsModuleConfig['display_mode']) {\n        $dir = 'bottom';\n        $width = 100;\n    } elseif ('mobile' === $xoopsModuleConfig['display_mode']) {\n        $dir = '';\n        $width = 120;\n    } elseif ('clean' === $xoopsModuleConfig['display_mode']) {\n        $dir = '';\n        $width = 50;\n    } elseif ('default' === $xoopsModuleConfig['display_mode']) {\n        $dir = $i % 2 ? 'left' : 'right';\n        $width = 100;\n    } else {\n        $dir = '';\n        $width = 100;\n    }\n\n    $all[0] = talk_bubble($BoardID, $DiscussID, $DiscussContent, $dir, $uid, $publisher, $DiscussDate, 'return', null, null, $width, $onlyTo);\n\n    if ('return' === $mode) {\n        return $all;\n    }\n    $xoopsTpl->assign('display_mode', $xoopsModuleConfig['display_mode']);\n    $xoopsTpl->assign('op', $_REQUEST['op']);\n    $xoopsTpl->assign('form_data', $all);\n    $xoopsTpl->assign('uid', $uid);\n}\n\n//\u53d6\u5f97tad_discuss_board\u5206\u985e\u9078\u55ae\u7684\u9078\u9805\uff08\u55ae\u5c64\u9078\u55ae\uff09\nfunction get_tad_discuss_board_option($default_BoardID = '0')\n{\n    global $xoopsDB, $xoopsUser, $xoopsModule;\n\n    //\u53d6\u5f97\u672c\u6a21\u7d44\u7de8\u865f\n    $module_id = $xoopsModule->mid();\n\n    //\u53d6\u5f97\u76ee\u524d\u4f7f\u7528\u8005\u7684\u7fa4\u7d44\u7de8\u865f\n    if ($xoopsUser) {\n        $uid = $xoopsUser->uid();\n        $groups = $xoopsUser->getGroups();\n    } else {\n        $uid = 0;\n        $groups = XOOPS_GROUP_ANONYMOUS;\n    }\n    $gpermHandler = xoops_getHandler('groupperm');\n\n    $sql = 'SELECT `BoardID` , `ofBoardID` , `BoardTitle` FROM `' . $xoopsDB->prefix('tad_discuss_board') . '` ORDER BY `BoardSort`';\n    $result = $xoopsDB->query($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n\n    $option = '';\n    while (list($BoardID, $ofBoardID, $BoardTitle) = $xoopsDB->fetchRow($result)) {\n        if (!$gpermHandler->checkRight('forum_post', $BoardID, $groups, $module_id)) {\n            continue;\n        }\n\n        $selected = ($BoardID == $default_BoardID) ? 'selected' : '';\n        // $option[$i]['selected']=$selected;\n        // $option[$i]['BoardID']=$BoardID;\n        // $option[$i]['ofBoardID']=$ofBoardID;\n        // $option[$i]['BoardTitle']=$BoardTitle;\n        $option .= \"<option value='{$BoardID}' {$selected}>{$BoardTitle}</option>\";\n    }\n\n    return $option;\n}\n\n//\u4ee5\u6d41\u6c34\u865f\u79c0\u51fa\u67d0\u7b46tad_discuss\u8cc7\u6599\u5167\u5bb9\nfunction show_one_tad_discuss($DefDiscussID = '')\n{\n    global $xoopsDB, $xoopsModule, $xoopsUser, $isAdmin, $xoopsModuleConfig, $xoopsTpl, $xoTheme;\n\n    $myts = \\MyTextSanitizer::getInstance();\n    if (empty($DefDiscussID)) {\n        return;\n    }\n    $DefDiscussID = (int) $DefDiscussID;\n    $discuss = get_tad_discuss($DefDiscussID);\n\n    //\u53d6\u5f97\u672c\u6a21\u7d44\u7de8\u865f\n    $module_id = $xoopsModule->mid();\n\n    //\u53d6\u5f97\u76ee\u524d\u4f7f\u7528\u8005\u7684\u7fa4\u7d44\u7de8\u865f\n    if ($xoopsUser) {\n        $now_uid = $xoopsUser->uid();\n        $groups = $xoopsUser->getGroups();\n    } else {\n        $now_uid = 0;\n        $groups = XOOPS_GROUP_ANONYMOUS;\n    }\n\n    $gpermHandler = xoops_getHandler('groupperm');\n    if (!$gpermHandler->checkRight('forum_read', $discuss['BoardID'], $groups, $module_id)) {\n        header('location:index.php');\n    }\n\n    if (0 != $discuss['ReDiscussID']) {\n        header(\"location: {$_SERVER['PHP_SELF']}?DiscussID={$discuss['ReDiscussID']}&BoardID={$discuss['BoardID']}\");\n    }\n\n    add_tad_discuss_counter($DefDiscussID);\n\n    $js = \"\n    <script type='text/javascript' src='\" . XOOPS_URL . \"/modules/tadtools/jqueryCookie/jquery.cookie.js'></script>\n    <link rel='stylesheet' type='text/css' media='screen' href='reset.css'>\n    <script>\n        function like(op,DiscussID){\n            if($.cookie('like'+DiscussID)){\n                alert('\" . _MD_TADDISCUS_HAD_LIKE . \"');\n            }else{\n            $.post('like.php',  {op: op , DiscussID: DiscussID} , function(data) {\n                $('#'+op+DiscussID).html(data);\n            });\n\n            $.cookie('like'+DiscussID , true , { expires: 7 });\n            }\n        }\n\n\n        function delete_tad_discuss_func(DiscussID){\n            var sure = window.confirm('\" . _TAD_DEL_CONFIRM . \"');\n            if (!sure)  return;\n            location.href=\\\"{$_SERVER['PHP_SELF']}?op=delete_tad_discuss&ReDiscussID=$DefDiscussID&BoardID={$discuss['BoardID']}&DiscussID=\\\" + DiscussID;\n        }\n    </script>\";\n\n    $Board = get_tad_discuss_board($discuss['BoardID']);\n\n    $sql = 'select * from ' . $xoopsDB->prefix('tad_discuss') . \" where DiscussID='$DefDiscussID' or ReDiscussID='$DefDiscussID' order by ReDiscussID , DiscussDate\";\n\n    //Utility::getPageBar($\u539fsql\u8a9e\u6cd5, \u6bcf\u9801\u986f\u793a\u5e7e\u7b46\u8cc7\u6599, \u6700\u591a\u986f\u793a\u5e7e\u500b\u9801\u6578\u9078\u9805);\n    $PageBar = Utility::getPageBar($sql, $xoopsModuleConfig['show_bubble_amount'], 10);\n    $bar = $PageBar['bar'];\n    $sql = $PageBar['sql'];\n    $total = $PageBar['total'];\n\n    if (empty($total)) {\n        redirect_header($_SERVER['PHP_SELF'], 3, _MD_TADDISCUS_THE_DISCUSS_EMPTY);\n    }\n\n    $result = $xoopsDB->query($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n\n    $discuss_data = [];\n    $i = 1;\n    $first = '';\n\n    $memberHandler = xoops_getHandler('member');\n    while (false !== ($all = $xoopsDB->fetchArray($result))) {\n        //\u4ee5\u4e0b\u6703\u7522\u751f\u9019\u4e9b\u8b8a\u6578\uff1a $DiscussID , $ReDiscussID , $uid , $DiscussTitle , $DiscussContent , $DiscussDate , $BoardID , $LastTime , $Counter\n        foreach ($all as $k => $v) {\n            $$k = $v;\n        }\n\n        if (!isset($onlyTo1)) {\n            $onlyTo1 = $onlyTo;\n        }\n\n        if ('left' === $xoopsModuleConfig['display_mode']) {\n            $dir = 'left';\n            $width = 100;\n        } elseif ('top' === $xoopsModuleConfig['display_mode']) {\n            $dir = 'top';\n            $width = 100;\n        } elseif ('bottom' === $xoopsModuleConfig['display_mode']) {\n            $dir = 'bottom';\n            $width = 100;\n        } elseif ('mobile' === $xoopsModuleConfig['display_mode']) {\n            $dir = '';\n            $width = 120;\n        } elseif ('clean' === $xoopsModuleConfig['display_mode']) {\n            $dir = '';\n            $width = 50;\n        } elseif ('default' === $xoopsModuleConfig['display_mode']) {\n            $dir = $i % 2 ? 'left' : 'right';\n            $width = 100;\n        } else {\n            $dir = '';\n            $width = 100;\n        }\n\n        if (empty($first)) {\n            $first = $DiscussContent;\n        }\n\n        $discuss['DiscussTitle'] = str_replace('[s', \"<img src='\" . XOOPS_URL . '/modules/tad_discuss/images/smiles/s', $discuss['DiscussTitle']);\n        $discuss['DiscussTitle'] = str_replace('.gif]', \".gif' hspace=2 align='absmiddle'>\", $discuss['DiscussTitle']);\n\n        $DiscussContent = str_replace('[s', \"<img src='\" . XOOPS_URL . '/modules/tad_discuss/images/smiles/s', $DiscussContent);\n        $DiscussContent = str_replace('.gif]', \".gif' hspace=2 align='absmiddle'>\", $DiscussContent);\n\n        //\u82e5\u7121\u4efb\u4f55\u6a19\u7c64\u5247\u5957\u7528nl2br\n        if (false === mb_strpos($DiscussContent, '<')) {\n            $DiscussContent = $myts->displayTarea($DiscussContent, 0, 1, 1, 1, 1);\n        } else {\n            $DiscussContent = $myts->displayTarea($DiscussContent, 1, 0, 0, 1, 0);\n        }\n\n        $discuss_data[$i] = talk_bubble($discuss['BoardID'], $DiscussID, $DiscussContent, $dir, $uid, $publisher, $DiscussDate, 'return', $Good, $Bad, $width, $onlyTo);\n        $i++;\n    }\n\n    //if($xoopsUser){\n    $dir = $i % 2 ? 'left' : 'right';\n    $form_data = tad_discuss_form($discuss['BoardID'], '', $DefDiscussID, $dir, 'return');\n    //}\n\n    $onlyToName = getOnlyToName($onlyTo1);\n    $discuss['DiscussTitle'] = isPublic($onlyTo1, $uid, $discuss['BoardID']) ? $discuss['DiscussTitle'] : sprintf(_MD_TADDISCUS_ONLYTO, $onlyToName);\n    //die(var_export($discuss_data));\n    $xoopsTpl->assign('BoardID', $discuss['BoardID']);\n    $xoopsTpl->assign('BoardTitle', $Board['BoardTitle']);\n    $xoopsTpl->assign('DiscussTitle', $discuss['DiscussTitle']);\n    $xoopsTpl->assign('display_mode', $xoopsModuleConfig['display_mode']);\n    $xoopsTpl->assign('op', 'show_one_tad_discuss');\n    $xoopsTpl->assign('js', $js);\n    $xoopsTpl->assign('discuss_data', $discuss_data);\n    $xoopsTpl->assign('form_data', $form_data);\n    $xoopsTpl->assign('bar', $bar);\n    $xoopsTpl->assign('isPublic', isPublic($onlyTo1, $uid, $discuss['BoardID']));\n    $xoopsTpl->assign('onlyTo', $onlyTo);\n    $xoopsTpl->assign('ReDiscussID', $DefDiscussID);\n\n    $title = $discuss['DiscussTitle'];\n    $description = strip_tags($first);\n\n    $fb_tag = \"\n      <meta property=\\\"og:title\\\" content=\\\"{$title}\\\">\n      \";\n    $xoopsTpl->assign('xoops_module_header', $fb_tag);\n    $xoopsTpl->assign('xoops_pagetitle', $title);\n    if (is_object($xoTheme)) {\n        $xoTheme->addMeta('meta', 'keywords', $title);\n    } else {\n        $xoopsTpl->assign('xoops_meta_keywords', 'keywords', $title);\n    }\n}\n\n//\u66f4\u65b0tad_discuss\u67d0\u4e00\u7b46\u8cc7\u6599\nfunction update_tad_discuss($DiscussID = '')\n{\n    global $xoopsDB, $xoopsUser, $TadUpFiles;\n\n    $myts = \\MyTextSanitizer::getInstance();\n    $DiscussTitle = $myts->addSlashes($_POST['DiscussTitle']);\n    $DiscussContent = $myts->addSlashes($_POST['DiscussContent']);\n\n    if (empty($_SERVER['HTTP_X_FORWARDED_FOR'])) {\n        $myip = $_SERVER['REMOTE_ADDR'];\n    } else {\n        $myip = explode(',', $_SERVER['HTTP_X_FORWARDED_FOR']);\n        $myip = $myip[0];\n    }\n\n    $anduid = onlyMine($DiscussID);\n\n    if (chk_spam($DiscussTitle)) {\n        redirect_header($_SERVER['PHP_SELF'], 3, _MD_TADDISCUS_FOUND_SPAM);\n    }\n\n    if (chk_spam($DiscussContent)) {\n        redirect_header($_SERVER['PHP_SELF'], 3, _MD_TADDISCUS_FOUND_SPAM);\n    }\n\n    $onlyTo = '';\n    $ReDiscussID = isset($_POST['ReDiscussID']) ? (int) $_POST['ReDiscussID'] : 0;\n    $BoardID = isset($_POST['BoardID']) ? (int) $_POST['BoardID'] : 0;\n    $OldBoardID = isset($_POST['OldBoardID']) ? (int) $_POST['OldBoardID'] : 0;\n\n    $Discuss = get_tad_discuss($ReDiscussID);\n    if ('1' == $_POST['only_root'] and !empty($ReDiscussID)) {\n        $onlyTo = $Discuss['uid'];\n    } elseif ('1' == $_POST['only_root']) {\n        $memberHandler = xoops_getHandler('member');\n        $adminusers = $memberHandler->getUsersByGroup(1);\n        $onlyTo = implode(',', $adminusers);\n    }\n\n    //$now=date('Y-m-d H:i:s',xoops_getUserTimestamp(time()));\n    $time = date('Y-m-d H:i:s');\n    $sql = 'update ' . $xoopsDB->prefix('tad_discuss') . \" set\n   `BoardID` = '{$BoardID}' ,\n   `DiscussTitle` = '{$DiscussTitle}' ,\n   `DiscussContent` = '{$DiscussContent}' ,\n   `LastTime` = '$time',\n   `FromIP` = '$myip',\n   `onlyTo` = '$onlyTo'\n  where DiscussID='$DiscussID' $anduid\";\n\n    //die($sql);\n    $xoopsDB->queryF($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n\n    if ($OldBoardID != $BoardID) {\n        $sql = 'update ' . $xoopsDB->prefix('tad_discuss') . \" set\n     `BoardID` = '{$BoardID}'\n    where ReDiscussID='$DiscussID'\";\n        $xoopsDB->queryF($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n    }\n\n    $TadUpFiles->set_col('DiscussID', $DiscussID);\n    $TadUpFiles->upload_file('upfile', 1024, 120, null, '', true);\n\n    return $DiscussID;\n}\n\nfunction change_lock($lock, $BoardID, $DiscussID)\n{\n    global $xoopsDB, $xoopsUser;\n\n    $anduid = onlyMine($DiscussID);\n\n    $onlyTo = '';\n\n    if ($lock) {\n        $ReDiscussID = isset($_REQUEST['ReDiscussID']) ? (int) $_REQUEST['ReDiscussID'] : 0;\n        $Discuss = get_tad_discuss($ReDiscussID);\n        if ('1' == $_POST['only_root'] and !empty($ReDiscussID)) {\n            $onlyTo = $Discuss['uid'];\n        } elseif ('1' == $_POST['only_root']) {\n            $adminusers = $memberHandler->getUsersByGroup(1);\n            $onlyTo = implode(',', $adminusers);\n        }\n    }\n\n    $sql = 'update ' . $xoopsDB->prefix('tad_discuss') . \" set\n   `onlyTo` = '$onlyTo'\n  where DiscussID='$DiscussID' $anduid\";\n    //die($sql);\n    $xoopsDB->queryF($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n\n    return $DiscussID;\n}\n\n//\u65b0\u589etad_discuss\u8a08\u6578\u5668\nfunction add_tad_discuss_counter($DiscussID = '')\n{\n    global $xoopsDB, $xoopsModule;\n    $sql = 'update ' . $xoopsDB->prefix('tad_discuss') . \" set `Counter`=`Counter`+1 where `DiscussID`='{$DiscussID}'\";\n    $xoopsDB->queryF($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n}\n\n/*-----------\u57f7\u884c\u52d5\u4f5c\u5224\u65b7\u5340----------*/\nrequire_once $GLOBALS['xoops']->path('/modules/system/include/functions.php');\n$op = system_CleanVars($_REQUEST, 'op', '', 'string');\n$BoardID = system_CleanVars($_REQUEST, 'BoardID', 0, 'int');\n$DiscussID = system_CleanVars($_REQUEST, 'DiscussID', 0, 'int');\n$ReDiscussID = system_CleanVars($_REQUEST, 'ReDiscussID', 0, 'int');\n$files_sn = system_CleanVars($_REQUEST, 'files_sn', 0, 'int');\n\n$xoopsTpl->assign('toolbar', Utility::toolbar_bootstrap($interface_menu));\n$xoopsTpl->assign('jquery', Utility::get_jquery(true));\n$xoopsTpl->assign('isAdmin', $isAdmin);\nif ($xoopsUser) {\n    $xoopsTpl->assign('now_uid', $xoopsUser->uid());\n} else {\n    $xoopsTpl->assign('now_uid', '--');\n}\n\nswitch ($op) {\n    //\u65b0\u589e\u8cc7\u6599\n    case 'insert_tad_discuss':\n        $DiscussID = insert_tad_discuss();\n        redirect_header(\"discuss.php?DiscussID={$DiscussID}&BoardID={$BoardID}\", 0, _MD_TADDISCUS_SAVE_OK);\n        break;\n    //\u66f4\u65b0\u8cc7\u6599\n    case 'update_tad_discuss':\n        update_tad_discuss($DiscussID);\n        $ID = empty($ReDiscussID) ? $DiscussID : $ReDiscussID;\n        header(\"location: {$_SERVER['PHP_SELF']}?DiscussID=$ID&BoardID=$BoardID\");\n        exit;\n        break;\n    //\u522a\u9664\u8cc7\u6599\n    case 'delete_tad_discuss':\n        delete_tad_discuss($DiscussID);\n        header(\"location: {$_SERVER['PHP_SELF']}?BoardID=$BoardID\");\n        exit;\n        break;\n    //\u8f38\u5165\u8868\u683c\n    case 'tad_discuss_form':\n        tad_discuss_form($BoardID, $DiscussID, $ReDiscussID);\n        break;\n    //\u4e0b\u8f09\u6a94\u6848\n    case 'tufdl':\n        $files_sn = isset($_GET['files_sn']) ? (int) $_GET['files_sn'] : '';\n        $TadUpFiles->add_file_counter($files_sn);\n        exit;\n        break;\n    case 'unlock':\n        change_lock(false, $BoardID, $DiscussID);\n        header(\"location: {$_SERVER['PHP_SELF']}?DiscussID=$DiscussID&BoardID=$BoardID\");\n        exit;\n        break;\n    case 'lock':\n        change_lock(true, $BoardID, $DiscussID);\n        header(\"location: {$_SERVER['PHP_SELF']}?DiscussID=$DiscussID&BoardID=$BoardID\");\n        exit;\n        break;\n    //\u9810\u8a2d\u52d5\u4f5c\n    default:\n        if (empty($DiscussID)) {\n            list_tad_discuss($BoardID);\n        } else {\n            show_one_tad_discuss($DiscussID);\n        }\n        break;\n}\n\n/*-----------\u79c0\u51fa\u7d50\u679c\u5340--------------*/\nrequire_once XOOPS_ROOT_PATH . '/footer.php';\n", "<?php\nuse XoopsModules\\Tadtools\\FooTable;\nuse XoopsModules\\Tadtools\\Utility;\n\nxoops_loadLanguage('main', 'tadtools');\n\nrequire_once __DIR__ . '/function_block.php';\n\nrequire_once $GLOBALS['xoops']->path('/modules/system/include/functions.php');\n/********************* \u81ea\u8a02\u51fd\u6578 ********************\n * @param string $BoardID\n * @param string $DiscussID\n * @param string $DiscussContent\n * @param string $dir\n * @param string $uid\n * @param string $publisher\n * @param string $DiscussDate\n * @param string $mode\n * @param int    $Good\n * @param int    $Bad\n * @param int    $width\n * @param string $onlyTo\n * @return mixed\n */\n\n//\u5c0d\u8a71\u6846\u683c\u5f0f\nfunction talk_bubble($BoardID = '', $DiscussID = '', $DiscussContent = '', $dir = 'left', $uid = '', $publisher = '', $DiscussDate = '', $mode = '', $Good = 0, $Bad = 0, $width = 100, $onlyTo = '')\n{\n    global $xoopsUser, $xoopsTpl, $xoopsModuleConfig, $TadUpFiles;\n\n    $memberHandler = xoops_getHandler('member');\n    $user = $memberHandler->getUser($uid);\n    $pic = XOOPS_URL . '/modules/tad_discuss/images/nobody.png';\n    $uid_name = _MD_TADDISCUS_NOBODY;\n    $user_sig = '';\n    if (is_object($user) and $uid) {\n        $ts = \\MyTextSanitizer::getInstance();\n        $uid_name = empty($publisher) ? $ts->htmlSpecialChars($user->name()) : $publisher;\n        if (empty($uid_name)) {\n            $uid_name = $ts->htmlSpecialChars($user->uname());\n        }\n        $user_sig = $user->user_sig();\n        $user_avatar = $ts->htmlSpecialChars($user->getVar('user_avatar'));\n        $pic = !empty($user_avatar) ? XOOPS_URL . '/uploads/' . $user_avatar : $pic;\n    }\n\n    $pic_js = $pic_css = '';\n\n    $now_uid = is_object($xoopsUser) ? $xoopsUser->uid() : '0';\n\n    if ($now_uid == $uid) {\n        $pic_js = \"onClick=\\\"location.href='\" . XOOPS_URL . \"/edituser.php?op=avatarform'\\\"\";\n        $pic_css = 'cursor:pointer;';\n    }\n\n    $like = (!empty($DiscussID) && 'tad_discuss_form' !== $_REQUEST['op']) ? true : false;\n    //$fun=(isMine($uid,$BoardID) and !empty($BoardID) and !empty($DiscussID) and $_REQUEST['op']!='tad_discuss_form')?true:false;\n\n    $fun = (isMine($uid, $BoardID) && 'tad_discuss_form' !== $_REQUEST['op'] && !empty($DiscussID)) ? true : false;\n\n    //$files=show_files(\"DiscussID\" , $DiscussID , true , '' , true , false);\n    if ('tad_discuss_form' !== $_REQUEST['op']) {\n        $TadUpFiles->set_col('DiscussID', $DiscussID);\n        $files = $TadUpFiles->show_files('upfile', true, null, true, false); //\u662f\u5426\u7e2e\u5716,\u986f\u793a\u6a21\u5f0f filename\u3001small,\u986f\u793a\u63cf\u8ff0,\u986f\u793a\u4e0b\u8f09\u6b21\u6578\n    }\n\n    $files = isPublic($onlyTo, $uid, $BoardID) ? $files : '';\n    $DiscussDate = date('Y-m-d H:i:s', xoops_getUserTimestamp(strtotime($DiscussDate)));\n    if ('mobile' === $xoopsModuleConfig['display_mode']) {\n        $DiscussDate = mb_substr($DiscussDate, 0, 16);\n    }\n\n    $onlyToName = getOnlyToName($onlyTo);\n\n    $all['width'] = $width;\n    $all['dir'] = $dir;\n    $all['pic'] = $pic;\n    $all['pic_css'] = $pic_css;\n    $all['pic_js'] = $pic_js;\n    $all['fun'] = $fun;\n\n    if ('1' == $xoopsModuleConfig['show_like']) {\n        $all['like'] = $like;\n    } else {\n        $all['like'] = '';\n    }\n\n    $all['uid'] = $uid;\n    $all['uid_name'] = $uid_name;\n    $all['user_sig'] = $user_sig;\n    $all['DiscussDate'] = $DiscussDate;\n    //$all['DiscussContent']=$DiscussContent;\n    $all['DiscussContent'] = isPublic($onlyTo, $uid, $BoardID) ? $DiscussContent : sprintf(_MD_TADDISCUS_ONLYTO, $onlyToName);\n    $all['DiscussID'] = $DiscussID;\n    $all['BoardID'] = $BoardID;\n    $all['Bad'] = $Bad;\n    $all['Good'] = $Good;\n    $all['files'] = $files;\n    $all['onlyTo'] = $onlyTo;\n    $all['show_sig'] = $xoopsModuleConfig['show_sig'];\n    $all['sig_style'] = $xoopsModuleConfig['sig_style'];\n    //die(var_export($all));\n    if ('return' === $mode) {\n        return $all;\n    }\n    $xoopsTpl->assign('discuss', $all);\n}\n\n//\u65b0\u589e\u8cc7\u6599\u5230tad_discuss_board\u4e2d\nfunction insert_tad_discuss_board($BoardTitle = '')\n{\n    global $xoopsDB, $xoopsUser, $TadUpFiles;\n\n    $myts = \\MyTextSanitizer::getInstance();\n    $BoardTitle = $myts->addSlashes($BoardTitle);\n    $BoardDesc = $myts->addSlashes($_POST['BoardDesc']);\n\n    $BoardManager = is_array($_POST['BoardManager']) ? implode(',', $_POST['BoardManager']) : $_POST['BoardManager'];\n    if (empty($BoardManager)) {\n        $BoardManager = $xoopsUser->uid();\n    }\n\n    $forum_read = system_CleanVars($_REQUEST, 'forum_read', [1, 2, 3], 'array');\n    $forum_post = system_CleanVars($_REQUEST, 'forum_post', [1, 2], 'array');\n    $BoardEnable = system_CleanVars($_REQUEST, 'BoardEnable', 1, 'int');\n    $ofBoardID = (int) $_POST['ofBoardID'];\n\n    $sql = 'insert into `' . $xoopsDB->prefix('tad_discuss_board') . \"`\n  (`ofBoardID` , `BoardTitle` , `BoardDesc` , `BoardManager` , `BoardEnable`)\n  values('{$ofBoardID}' , '{$BoardTitle}' , '{$BoardDesc}' , '{$BoardManager}' , '{$BoardEnable}')\";\n    $xoopsDB->query($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n\n    //\u53d6\u5f97\u6700\u5f8c\u65b0\u589e\u8cc7\u6599\u7684\u6d41\u6c34\u7de8\u865f\n    $BoardID = $xoopsDB->getInsertId();\n\n    //\u5beb\u5165\u6b0a\u9650\n    saveItem_Permissions($forum_read, $BoardID, 'forum_read');\n    saveItem_Permissions($forum_post, $BoardID, 'forum_post');\n\n    $TadUpFiles->set_col('BoardID', $BoardID);\n    $TadUpFiles->upload_file('upfile', 1024, 120, null, '', true);\n\n    return $BoardID;\n}\n\n//\u65b0\u589e\u8cc7\u6599\u5230tad_discuss_cbox_setup\u4e2d\nfunction insert_tad_discuss_cbox_setup($setupName = '', $setupRule = '', $newBorard = '', $BoardID = '')\n{\n    global $xoopsDB, $xoopsUser, $TadUpFiles;\n\n    //\u53d6\u5f97\u4f7f\u7528\u8005\u7de8\u865f\n    $uid = ($xoopsUser) ? $xoopsUser->uid() : '';\n\n    $myts = \\MyTextSanitizer::getInstance();\n    $setupName = $myts->addSlashes($setupName);\n    $setupRule = $myts->addSlashes($setupRule);\n    $newBorard = $myts->addSlashes($newBorard);\n\n    if (!empty($newBorard)) {\n        $BoardID = insert_tad_discuss_board($newBorard);\n    }\n\n    $setupSort = tad_discuss_cbox_setup_max_sort();\n\n    $sql = 'insert into `' . $xoopsDB->prefix('tad_discuss_cbox_setup') . \"`\n  (`setupName` , `setupRule` , `BoardID` , `setupSort`)\n  values('{$setupName}' , '{$setupRule}' , '{$BoardID}' , '{$setupSort}')\";\n    $xoopsDB->query($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n\n    //\u53d6\u5f97\u6700\u5f8c\u65b0\u589e\u8cc7\u6599\u7684\u6d41\u6c34\u7de8\u865f\n    //$setupID = $xoopsDB->getInsertId();\n    return $BoardID;\n}\n\n//\u81ea\u52d5\u53d6\u5f97tad_discuss_cbox_setup\u7684\u6700\u65b0\u6392\u5e8f\nfunction tad_discuss_cbox_setup_max_sort()\n{\n    global $xoopsDB;\n    $sql = 'SELECT max(`setupSort`) FROM `' . $xoopsDB->prefix('tad_discuss_cbox_setup') . '`';\n    $result = $xoopsDB->query($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n    list($sort) = $xoopsDB->fetchRow($result);\n\n    return ++$sort;\n}\n\n//\u5132\u5b58\u6b0a\u9650\nfunction saveItem_Permissions($groups, $itemid, $perm_name)\n{\n    global $xoopsModule;\n    $module_id = $xoopsModule->mid();\n    $gpermHandler = xoops_getHandler('groupperm');\n\n    // First, if the permissions are already there, delete them\n    $gpermHandler->deleteByModule($module_id, $perm_name, $itemid);\n\n    // Save the new permissions\n    if (count($groups) > 0) {\n        foreach ($groups as $group_id) {\n            $gpermHandler->addRight($perm_name, $itemid, $group_id, $module_id);\n        }\n    }\n}\n\n//\u5217\u51fa\u6240\u6709tad_discuss\u8cc7\u6599\nfunction list_tad_discuss($DefBoardID = null)\n{\n    global $xoopsDB, $xoopsModule, $xoopsUser, $xoopsModuleConfig, $isAdmin, $xoopsTpl;\n    $now_uid = is_object($xoopsUser) ? $xoopsUser->uid() : '0';\n\n    //\u53d6\u5f97\u672c\u6a21\u7d44\u7de8\u865f\n    $module_id = $xoopsModule->mid();\n\n    //\u53d6\u5f97\u76ee\u524d\u4f7f\u7528\u8005\u7684\u7fa4\u7d44\u7de8\u865f\n    if ($xoopsUser) {\n        $uid = $xoopsUser->uid();\n        $groups = $xoopsUser->getGroups();\n    } else {\n        $uid = 0;\n        $groups = XOOPS_GROUP_ANONYMOUS;\n    }\n\n    $gpermHandler = xoops_getHandler('groupperm');\n    if (!$gpermHandler->checkRight('forum_read', $DefBoardID, $groups, $module_id)) {\n        header('location:index.php');\n    }\n\n    $post = $gpermHandler->checkRight('forum_post', $DefBoardID, $groups, $module_id);\n    $xoopsTpl->assign('post', $post);\n\n    $andBoardID = (empty($DefBoardID)) ? '' : \"and a.BoardID='$DefBoardID'\";\n    $andLimit = ($limit > 0) ? \"limit 0,$limit\" : '';\n    $sql = 'select a.*,b.* from ' . $xoopsDB->prefix('tad_discuss') . ' as a left join ' . $xoopsDB->prefix('tad_discuss_board') . \" as b on a.BoardID = b.BoardID where a.ReDiscussID='0' and b.BoardEnable='1' $andBoardID  order by a.LastTime desc\";\n\n    //Utility::getPageBar($\u539fsql\u8a9e\u6cd5, \u6bcf\u9801\u986f\u793a\u5e7e\u7b46\u8cc7\u6599, \u6700\u591a\u986f\u793a\u5e7e\u500b\u9801\u6578\u9078\u9805);\n    $PageBar = Utility::getPageBar($sql, $xoopsModuleConfig['show_discuss_amount'], 10);\n    $bar = $PageBar['bar'];\n    $sql = $PageBar['sql'];\n    $total = $PageBar['total'];\n\n    $result = $xoopsDB->query($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n\n    $main_data = [];\n    $i = 1;\n    while (false !== ($all = $xoopsDB->fetchArray($result))) {\n        //\u4ee5\u4e0b\u6703\u7522\u751f\u9019\u4e9b\u8b8a\u6578\uff1a $DiscussID , $ReDiscussID , $uid , $DiscussTitle , $DiscussContent , $DiscussDate , $BoardID , $LastTime , $Counter\n        foreach ($all as $k => $v) {\n            $$k = $v;\n        }\n\n        $renum = get_re_num($DiscussID);\n        $renum = empty($renum) ? '0' : $renum;\n\n        if (empty($publisher)) {\n            $uid_name = \\XoopsUser::getUnameFromId($uid, 1);\n            if (empty($uid_name)) {\n                $uid_name = \\XoopsUser::getUnameFromId($uid, 0);\n            }\n        } else {\n            $uid_name = $publisher;\n        }\n\n        //\u6700\u5f8c\u56de\u61c9\u8005\n        $sql2 = 'select uid,publisher from ' . $xoopsDB->prefix('tad_discuss') . \" where ReDiscussID='$DiscussID' order by DiscussDate desc limit 0,1\";\n        $result2 = $xoopsDB->queryF($sql2) or Utility::web_error($sql2);\n        //if($isAdmin)die($sql2);\n        list($last_uid, $last_uid_name) = $xoopsDB->fetchRow($result2);\n        //if($isAdmin and $BoardID==19)die(\"<div>$sql2</div>\\$last_uid={$last_uid}\");\n        if (empty($last_uid_name)) {\n            if (empty($last_uid)) {\n                $last_uid_name = $uid_name;\n            } else {\n                $last_uid_name = \\XoopsUser::getUnameFromId($last_uid, 1);\n                if (empty($last_uid_name)) {\n                    $last_uid_name = \\XoopsUser::getUnameFromId($last_uid, 0);\n                }\n            }\n        }\n\n        $LastTime = date('Y-m-d H:i:s', xoops_getUserTimestamp(strtotime($LastTime)));\n        $LastTime = mb_substr($LastTime, 0, 16);\n        $DiscussDate = date('Y-m-d H:i:s', xoops_getUserTimestamp(strtotime($DiscussDate)));\n        $DiscussDate = mb_substr($DiscussDate, 0, 16);\n\n        $isPublic = isPublic($onlyTo, $uid, $DefBoardID);\n        $onlyToName = getOnlyToName($onlyTo);\n\n        $DiscussTitle = str_replace('[s', \"<img src='\" . XOOPS_URL . '/modules/tad_discuss/images/smiles/s', $DiscussTitle);\n        $DiscussTitle = str_replace('.gif]', \".gif' hspace=2 align='absmiddle'>\", $DiscussTitle);\n\n        $main_data[$i]['LastTime'] = $LastTime;\n        $main_data[$i]['DiscussID'] = $DiscussID;\n        $main_data[$i]['BoardID'] = $BoardID;\n        $main_data[$i]['DiscussTitle'] = $isPublic ? $DiscussTitle : sprintf(_MD_TADDISCUS_ONLYTO, $onlyToName);\n        $main_data[$i]['uid_name'] = $uid_name;\n        $main_data[$i]['renum'] = $renum;\n        $main_data[$i]['DiscussDate'] = $DiscussDate;\n        $main_data[$i]['LastTime'] = $LastTime;\n        $main_data[$i]['last_uid_name'] = $last_uid_name;\n        $main_data[$i]['isPublic'] = $isPublic;\n        $main_data[$i]['onlyTo'] = $onlyTo;\n        $i++;\n    }\n\n    $xoopsTpl->assign('main_data', $main_data);\n    $xoopsTpl->assign('DefBoardID', $DefBoardID);\n\n    $post_tool = ($post and !empty($DefBoardID)) ? \"<a href='{$_SERVER['PHP_SELF']}?op=tad_discuss_form&BoardID=$DefBoardID' class='btn btn-default btn-secondary'><img src='images/edit.png' align='absmiddle' hspace=4 alt='\" . _MD_TADDISCUS_ADD_DISCUSS . \"'>\" . _MD_TADDISCUS_ADD_DISCUSS . '</a>' : '';\n\n    $FooTable = new FooTable();\n    $FooTableJS = $FooTable->render();\n\n    $ShowBoardTitle = '';\n    if (!empty($DefBoardID)) {\n        $ShowBoardTitle = get_board_title($DefBoardID);\n    }\n\n    $xoopsTpl->assign('FooTableJS', $FooTableJS);\n    $xoopsTpl->assign('post_tool', $post_tool);\n    $xoopsTpl->assign('bar', $bar);\n    $xoopsTpl->assign('ShowBoardTitle', $ShowBoardTitle);\n}\n\n//\u8a0e\u8ad6\u5340\u6a19\u984c\nfunction get_board_title($DefBoardID = '')\n{\n    global $TadUpFiles;\n    if (empty($DefBoardID)) {\n        return;\n    }\n\n    $Board = get_tad_discuss_board($DefBoardID);\n    //$pic=get_pic_file('BoardID' , $Board['BoardID'] , 1 , 'thumb');\n    $TadUpFiles->set_col('BoardID', $DefBoardID);\n    $pic = $TadUpFiles->get_pic_file('thumb'); //thumb \u5c0f\u5716, images \u5927\u5716\uff08default\uff09, file \u6a94\u6848\n    $pic = empty($pic) ? XOOPS_URL . '/modules/tad_discuss/images/board.png' : $pic;\n    $main = \"<div style='width:90px;height:60px;background: transparent url($pic) no-repeat center top;-moz-border-radius: 5px;-khtml-border-radius: 5px;-webkit-border-radius: 5px;border-radius: 5px;position:relative;float:left;margin:0px 10px 6px 0px;' alt='{$Board['BoardTitle']}' title='{$Board['BoardTitle']}'></div>{$Board['BoardTitle']}<div style='font-size: 80%;color:gray;font-weight:normal;cursor:pointer;' onClick=\\\"location.href='discuss.php?BoardID={$DefBoardID}'\\\">{$Board['BoardDesc']}</div><div style='clear:both'></div>\";\n\n    return $main;\n}\n\n//\u4ee5\u6d41\u6c34\u865f\u53d6\u5f97\u67d0\u7b46tad_discuss\u8cc7\u6599\nfunction get_tad_discuss($DiscussID = '')\n{\n    global $xoopsDB;\n    if (empty($DiscussID)) {\n        return;\n    }\n\n    $sql = 'select * from ' . $xoopsDB->prefix('tad_discuss') . \" where DiscussID='$DiscussID'\";\n    $result = $xoopsDB->query($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n    $data = $xoopsDB->fetchArray($result);\n\n    return $data;\n}\n\n//\u53d6\u5f97\u6587\u7ae0\u6578\u91cf\nfunction get_board_num($BoardID = '', $onlyMainDiscuss = true)\n{\n    global $xoopsDB, $xoopsModule, $xoopsUser;\n    if (empty($BoardID)) {\n        return 0;\n    }\n\n    $andMainDiscuss = ($onlyMainDiscuss) ? \"and ReDiscussID='0'\" : '';\n    $sql = 'select count(*) from ' . $xoopsDB->prefix('tad_discuss') . \" where BoardID='$BoardID' {$andMainDiscuss}\";\n    $result = $xoopsDB->query($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n    list($counter) = $xoopsDB->fetchRow($result);\n\n    return $counter;\n}\n\n//\u53d6\u5f97\u56de\u8986\u6578\u91cf\nfunction get_re_num($DiscussID = '')\n{\n    global $xoopsDB, $xoopsModule, $xoopsUser;\n    if (empty($DiscussID)) {\n        return 0;\n    }\n\n    $sql = 'select count(*) from ' . $xoopsDB->prefix('tad_discuss') . \" where ReDiscussID='$DiscussID'\";\n    $result = $xoopsDB->query($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n    list($counter) = $xoopsDB->fetchRow($result);\n\n    return $counter;\n}\n\n//\u662f\u5426\u6709\u7ba1\u7406\u6b0a\uff08\u6216\u7531\u81ea\u5df1\u767c\u5e03\u7684\uff09\uff0c\u5224\u65b7\u662f\u5426\u8981\u79c0\u51fa\u7ba1\u7406\u5de5\u5177\nfunction isMine($discuss_uid = null, $BoardID = null)\n{\n    global $xoopsUser, $isAdmin;\n    if (empty($xoopsUser)) {\n        return false;\n    }\n\n    if ($BoardID) {\n        $board = get_tad_discuss_board($BoardID);\n        $BoardManagerArr = explode(',', $board['BoardManager']);\n    } else {\n        $BoardManagerArr = [];\n    }\n    //die(\"aa\".var_export($board));\n    $uid = $xoopsUser->uid();\n\n    //  echo \"<p>{$isAdmin}?{$uid} -- {$board['BoardManager']}</p>\";\n    if ($isAdmin) {\n        return true;\n    } elseif (in_array($uid, $BoardManagerArr)) {\n        return true;\n    } elseif ($uid == $discuss_uid) {\n        return true;\n    }\n\n    return false;\n}\n\n//\u53d6\u5f97\u7248\u4e3b\u59d3\u540d\nfunction getBoardManager($BoardID = '', $mode = '')\n{\n    if (empty($BoardID)) {\n        return false;\n    }\n\n    $board = get_tad_discuss_board($BoardID);\n    $BoardManagerArr = explode(',', $board['BoardManager']);\n    foreach ($BoardManagerArr as $uid) {\n        $BoardManagerName = \\XoopsUser::getUnameFromId($uid, 1);\n        if (empty($BoardManagerName)) {\n            $BoardManagerName = \\XoopsUser::getUnameFromId($uid, 0);\n        }\n\n        $name[] = \"<a href='\" . XOOPS_URL . \"/userinfo.php?uid={$uid}'>{$BoardManagerName}</a>\";\n    }\n\n    return $name;\n}\n\n//\u66f4\u65b0\u522a\u9664\u6642\u662f\u5426\u9650\u5236\u8eab\u4efd\nfunction onlyMine($DiscussID = '')\n{\n    global $xoopsUser, $isAdmin, $xoopsModule;\n    $uid = is_object($xoopsUser) ? $xoopsUser->uid() : '0';\n    $Discuss = get_tad_discuss($DiscussID);\n    $board = get_tad_discuss_board($Discuss['BoardID']);\n    $BoardManagerArr = explode(',', $board['BoardManager']);\n\n    if ($xoopsUser) {\n        $module_id = $xoopsModule->mid();\n        $isAdmin = $xoopsUser->isAdmin($module_id);\n    }\n\n    if ($isAdmin) {\n        return;\n    } elseif (in_array($uid, $BoardManagerArr)) {\n        return;\n    }\n\n    return \"and uid='$uid'\";\n}\n\n//\u522a\u9664tad_discuss\u67d0\u7b46\u8cc7\u6599\u8cc7\u6599\nfunction delete_tad_discuss($DiscussID = '')\n{\n    global $xoopsDB, $xoopsUser, $isAdmin, $TadUpFiles;\n\n    if (!$xoopsUser) {\n        return;\n    }\n\n    $anduid = onlyMine($DiscussID);\n\n    $sql = 'delete from ' . $xoopsDB->prefix('tad_discuss') . \" where DiscussID='$DiscussID' $anduid\";\n    //die($sql);\n    if ($xoopsDB->queryF($sql)) {\n        $TadUpFiles->set_col('DiscussID', $DiscussID); //\u82e5\u8981\u6574\u500b\u522a\u9664\n        $TadUpFiles->del_files();\n\n        $sql = 'select DiscussID from ' . $xoopsDB->prefix('tad_discuss') . \" where ReDiscussID='$DiscussID'\";\n        $result = $xoopsDB->query($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n        while (list($DiscussID) = $xoopsDB->fetchRow($result)) {\n            delete_tad_discuss($DiscussID);\n        }\n    } else {\n        Utility::web_error($sql, __FILE__, __LINE__);\n    }\n}\n\n//\u6aa2\u67e5\u662f\u5426\u6709\u4e0d\u7576\u8a00\u8ad6\nfunction chk_spam($content = '')\n{\n    global $xoopsModuleConfig;\n    $content = str_replace('/', '', $content);\n    $content = str_replace(' ', '', $content);\n    $content = str_replace('\\\\', '', $content);\n    $content = str_replace('-', '', $content);\n    $content = str_replace('+', '', $content);\n    $content = str_replace('.', '', $content);\n    $content = str_replace('|', '', $content);\n\n    $keys = explode(',', $xoopsModuleConfig['spam_keyword']);\n    foreach ($keys as $key) {\n        $strpos = mb_strpos($content, $key);\n        if (false !== $strpos) {\n            return true;\n        }\n    }\n\n    return false;\n}\n\n//\u65b0\u589e\u8cc7\u6599\u5230tad_discuss\u4e2d\nfunction insert_tad_discuss($nl2br = false)\n{\n    global $xoopsDB, $xoopsUser, $TadUpFiles;\n\n    //\u53d6\u5f97\u4f7f\u7528\u8005\u7de8\u865f\n    //if(!$xoopsUser)return;\n\n    $memberHandler = xoops_getHandler('member');\n\n    $uid = ($xoopsUser) ? $xoopsUser->uid() : (int) $_POST['uid'];\n\n    $myts = \\MyTextSanitizer::getInstance();\n    //$_POST['DiscussContent']=$myts->addSlashes($_POST['DiscussContent']);\n\n    if (empty($_SERVER['HTTP_X_FORWARDED_FOR'])) {\n        $myip = $_SERVER['REMOTE_ADDR'];\n    } else {\n        $myip = explode(',', $_SERVER['HTTP_X_FORWARDED_FOR']);\n        $myip = $myip[0];\n    }\n\n    $ReDiscussID = isset($_POST['ReDiscussID']) ? (int) $_POST['ReDiscussID'] : 0;\n    //$now=date('Y-m-d H:i:s',xoops_getUserTimestamp(time()));\n    $Discuss = get_tad_discuss($ReDiscussID);\n    $DiscussTitle = empty($_POST['DiscussTitle']) ? 'RE:' . $Discuss['DiscussTitle'] : $_POST['DiscussTitle'];\n    $DiscussTitle = $myts->addSlashes($DiscussTitle);\n    $publisher = $myts->addSlashes($_POST['publisher']);\n    $BoardID = (int) $_POST['BoardID'];\n\n    $DiscussContent = $myts->addSlashes($_POST['DiscussContent']);\n    if ($nl2br) {\n        $DiscussContent = nl2br($DiscussContent);\n    }\n\n    if (chk_spam($DiscussTitle)) {\n        redirect_header($_SERVER['PHP_SELF'], 3, _MD_TADDISCUS_FOUND_SPAM);\n    }\n\n    if (chk_spam($DiscussContent)) {\n        redirect_header($_SERVER['PHP_SELF'], 3, _MD_TADDISCUS_FOUND_SPAM);\n    }\n\n    $onlyTo = '';\n    if ('1' == $_POST['only_root'] and !empty($ReDiscussID)) {\n        $onlyTo = $Discuss['uid'];\n    } elseif ('1' == $_POST['only_root']) {\n        $adminusers = $memberHandler->getUsersByGroup(1);\n        $onlyTo = implode(',', $adminusers);\n    }\n\n    $time = date('Y-m-d H:i:s');\n    $sql = 'insert into ' . $xoopsDB->prefix('tad_discuss') . \"   (`ReDiscussID` , `uid` , `publisher` , `DiscussTitle` , `DiscussContent` , `DiscussDate` , `BoardID` , `LastTime` , `Counter` , `FromIP` , `onlyTo`)\n  values('{$ReDiscussID}' , '{$uid}' , '{$publisher}' , '{$DiscussTitle}' , '{$DiscussContent}' , '{$time}', '{$BoardID}' , '{$time}' , '0', '$myip' , '{$onlyTo}')\";\n    $xoopsDB->query($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n\n    //\u53d6\u5f97\u6700\u5f8c\u65b0\u589e\u8cc7\u6599\u7684\u6d41\u6c34\u7de8\u865f\n    $DiscussID = $xoopsDB->getInsertId();\n\n    if ($xoopsUser) {\n        $xoopsUser->incrementPost();\n    }\n\n    $TadUpFiles->set_col('DiscussID', $DiscussID);\n    //$TadUpFiles->upload_file($upname,$width,$thumb_width,$files_sn,$desc,$safe_name=false,$hash=false);\n    $TadUpFiles->upload_file('upfile', 1024, 120, null, '', true);\n\n    $ToDiscussID = $DiscussID;\n    if (!empty($ReDiscussID)) {\n        $sql = 'update ' . $xoopsDB->prefix('tad_discuss') . \" set `LastTime` = '{$time}'\n    where `DiscussID` = '{$ReDiscussID}' or `ReDiscussID` = '{$ReDiscussID}'\";\n        $xoopsDB->queryF($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n        $ToDiscussID = $ReDiscussID;\n    }\n\n    //\u5168\u5c40\n    $extra_tags['DISCUSS_TITLE'] = $_POST['DiscussTitle'];\n    $extra_tags['DISCUSS_CONTENT'] = strip_tags($_POST['DiscussContent']);\n    $extra_tags['DISCUSS_URL'] = XOOPS_URL . \"/modules/tad_discuss/discuss.php?DiscussID={$ToDiscussID}&BoardID={$_POST['BoardID']}\";\n\n    $notificationHandler = xoops_getHandler('notification');\n    $notificationHandler->triggerEvent('global', 0, 'new_discuss', $extra_tags, null, null, 0);\n\n    //\u5206\u985e\n    if (!empty($_POST['BoardID'])) {\n        $Board = get_tad_discuss_board($_POST['BoardID']);\n        $extra_tags['BOARD_TITLE'] = $Board['BoardTitle'];\n        $notificationHandler = xoops_getHandler('notification');\n        $notificationHandler->triggerEvent('board', $_POST['BoardID'], 'new_board_discuss', $extra_tags, null, null, 0);\n    }\n\n    if (!empty($ReDiscussID)) {\n        return $ReDiscussID;\n    }\n\n    return $DiscussID;\n}\n", "<?php\nuse XoopsModules\\Tadtools\\FooTable;\nuse XoopsModules\\Tadtools\\TadUpFiles;\nuse XoopsModules\\Tadtools\\Utility;\n/*-----------\u5f15\u5165\u6a94\u6848\u5340--------------*/\nrequire __DIR__ . '/header.php';\n$xoopsOption['template_main'] = 'tad_discuss_index.tpl';\nrequire_once XOOPS_ROOT_PATH . '/header.php';\n$TadUpFiles = new TadUpFiles('tad_discuss');\n/*-----------function\u5340--------------*/\n\n//\u5217\u51fa\u6240\u6709tad_discuss_board\u8cc7\u6599\nfunction list_tad_discuss_board($ofBoardID = 0, $mode = 'tpl')\n{\n    global $xoopsDB, $xoopsModule, $isAdmin, $xoopsUser, $xoopsTpl, $TadUpFiles, $xoopsModuleConfig;\n\n    //\u53d6\u5f97\u672c\u6a21\u7d44\u7de8\u865f\n    $module_id = $xoopsModule->mid();\n\n    //\u53d6\u5f97\u76ee\u524d\u4f7f\u7528\u8005\u7684\u7fa4\u7d44\u7de8\u865f\n    if ($xoopsUser) {\n        $uid = $xoopsUser->uid();\n        $groups = $xoopsUser->getGroups();\n    } else {\n        $uid = 0;\n        $groups = XOOPS_GROUP_ANONYMOUS;\n    }\n    $gpermHandler = xoops_getHandler('groupperm');\n\n    $sql = 'select * from `' . $xoopsDB->prefix('tad_discuss_board') . \"` where BoardEnable='1' and `ofBoardID`='$ofBoardID' order by BoardSort\";\n    $result = $xoopsDB->query($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n\n    $all_content = [];\n    $i = 0;\n    while (false !== ($all = $xoopsDB->fetchArray($result))) {\n        //\u4ee5\u4e0b\u6703\u7522\u751f\u9019\u4e9b\u8b8a\u6578\uff1a $BoardID , $BoardTitle , $BoardDesc , $BoardManager , $BoardEnable\n        foreach ($all as $k => $v) {\n            $$k = $v;\n        }\n\n        if (!$gpermHandler->checkRight('forum_read', $BoardID, $groups, $module_id)) {\n            continue;\n        }\n        $post = $gpermHandler->checkRight('forum_post', $BoardID, $groups, $module_id);\n\n        //$pic=get_pic_file('BoardID' , $BoardID , 1 , 'thumb');\n        $TadUpFiles->set_col('BoardID', $BoardID);\n        $pic = $TadUpFiles->get_pic_file('thumb'); //thumb \u5c0f\u5716, images \u5927\u5716\uff08default\uff09, file \u6a94\u6848\n        $pic = empty($pic) ? 'images/board.png' : $pic;\n\n        $display_number = isset($xoopsModuleConfig['display_number']) ? (int) $xoopsModuleConfig['display_number'] : 7;\n        $list_tad_discuss = list_tad_discuss_short($BoardID, $display_number);\n\n        $fun = ($isAdmin) ? \"<a href='admin/main.php?op=tad_discuss_board_form&BoardID=$BoardID'><img src='images/edit.png' alt='\" . _TAD_EDIT . \"'></a>\" : '';\n        $BoardManager = implode(' , ', getBoardManager($BoardID, 'uname'));\n\n        $BoardNum = get_board_num($BoardID);\n        $DiscussNum = get_board_num($BoardID, false);\n\n        $all_content[$i]['post'] = $post;\n        $all_content[$i]['pic'] = $pic;\n        $all_content[$i]['BoardTitle'] = $BoardTitle;\n        $all_content[$i]['BoardID'] = $BoardID;\n        $all_content[$i]['ofBoardID'] = $ofBoardID;\n        $all_content[$i]['fun'] = $fun;\n        $all_content[$i]['BoardNum'] = sprintf(_MD_TADDISCUS_BOARD_DISCUSS, number_format($BoardNum));\n        $all_content[$i]['DiscussNum'] = sprintf(_MD_TADDISCUS_ALL_DISCUSS, number_format($DiscussNum));\n        $all_content[$i]['list_tad_discuss'] = $list_tad_discuss;\n        $all_content[$i]['BoardManager'] = $BoardManager;\n        $all_content[$i]['subBoard'] = list_tad_discuss_board($BoardID, 'return');\n\n        $i++;\n    }\n\n    if ('return' === $mode) {\n        return $all_content;\n    }\n\n    $FooTable = new FooTable();\n    $FooTableJS = $FooTable->render();\n\n    $xoopsTpl->assign('FooTableJS', $FooTableJS);\n    $xoopsTpl->assign('all_content', $all_content);\n\n    if ($xoopsUser) {\n        $xoopsTpl->assign('login', true);\n    } else {\n        $xoopsTpl->assign('login', false);\n    }\n}\n\n//\u5217\u51fa\u6240\u6709tad_discuss\u8cc7\u6599\nfunction list_tad_discuss_short($BoardID = null, $limit = null)\n{\n    global $xoopsDB, $xoopsModule, $xoopsUser, $xoopsTpl;\n\n    $andBoardID = (empty($BoardID)) ? '' : \"and a.BoardID='$BoardID'\";\n    $andLimit = null !== $limit ? \"limit 0,$limit\" : '';\n    $sql = 'select a.*,b.* from ' . $xoopsDB->prefix('tad_discuss') . ' as a left join ' . $xoopsDB->prefix('tad_discuss_board') . \" as b on a.BoardID = b.BoardID where a.ReDiscussID='0' $andBoardID  order by a.LastTime desc $andLimit\";\n\n    $result = $xoopsDB->query($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n\n    $main_data = [];\n    $i = 0;\n    while (false !== ($all = $xoopsDB->fetchArray($result))) {\n        //\u4ee5\u4e0b\u6703\u7522\u751f\u9019\u4e9b\u8b8a\u6578\uff1a $DiscussID , $ReDiscussID , $uid , $DiscussTitle , $DiscussContent , $DiscussDate , $BoardID , $LastTime , $Counter\n        foreach ($all as $k => $v) {\n            $$k = $v;\n        }\n\n        $renum = get_re_num($DiscussID);\n        //$show_re_num=empty($renum)?\"\":sprintf(_MD_TADDISCUS_RE_DISCUSS,$renum);\n\n        $uid_name = \\XoopsUser::getUnameFromId($uid, 1);\n        $LastTime = mb_substr($LastTime, 0, 10);\n\n        $isPublic = isPublic($onlyTo, $uid, $BoardID);\n        $onlyToName = getOnlyToName($onlyTo);\n        $DiscussTitle = $isPublic ? $DiscussTitle : sprintf(_MD_TADDISCUS_ONLYTO, $onlyToName);\n\n        $DiscussTitle = str_replace('[s', \"<img src='\" . XOOPS_URL . '/modules/tad_discuss/images/smiles/s', $DiscussTitle);\n        $DiscussTitle = str_replace('.gif]', \".gif' hspace=2 align='absmiddle'>\", $DiscussTitle);\n\n        $main_data[$i]['LastTime'] = $LastTime;\n        $main_data[$i]['DiscussID'] = $DiscussID;\n        $main_data[$i]['BoardID'] = $BoardID;\n        $main_data[$i]['DiscussTitle'] = $DiscussTitle;\n        $main_data[$i]['uid_name'] = $uid_name;\n        $main_data[$i]['renum'] = $renum;\n\n        $i++;\n    }\n\n    return $main_data;\n}\n\n/*-----------\u57f7\u884c\u52d5\u4f5c\u5224\u65b7\u5340----------*/\nrequire_once $GLOBALS['xoops']->path('/modules/system/include/functions.php');\n$op = system_CleanVars($_REQUEST, 'op', '', 'string');\n$BoardID = system_CleanVars($_REQUEST, 'BoardID', 0, 'int');\n$DiscussID = system_CleanVars($_REQUEST, 'DiscussID', 0, 'int');\n$files_sn = system_CleanVars($_REQUEST, 'files_sn', 0, 'int');\n\n$xoopsTpl->assign('toolbar', Utility::toolbar_bootstrap($interface_menu));\n$xoopsTpl->assign('jquery', Utility::get_jquery(true));\n\nswitch ($op) {\n    default:\n        list_tad_discuss_board(0);\n        break;\n}\n\n/*-----------\u79c0\u51fa\u7d50\u679c\u5340--------------*/\nrequire_once XOOPS_ROOT_PATH . '/footer.php';\n"], "fixing_code": ["<?php\nuse XoopsModules\\Tadtools\\CkEditor;\nuse XoopsModules\\Tadtools\\FormValidator;\nuse XoopsModules\\Tadtools\\TadUpFiles;\nuse XoopsModules\\Tadtools\\Utility;\n/*-----------\u5f15\u5165\u6a94\u6848\u5340--------------*/\nrequire __DIR__ . '/header.php';\n$xoopsOption['template_main'] = 'tad_discuss_discuss.tpl';\nrequire_once XOOPS_ROOT_PATH . '/header.php';\n$TadUpFiles = new TadUpFiles('tad_discuss');\n/*-----------function\u5340--------------*/\n\n//tad_discuss\u7de8\u8f2f\u8868\u55ae\nfunction tad_discuss_form($BoardID = '', $DefDiscussID = '', $DefReDiscussID = '', $dir = 'left', $mode = '')\n{\n    global $xoopsDB, $xoopsUser, $isAdmin, $xoopsModuleConfig, $xoopsModule, $xoopsTpl, $TadUpFiles;\n\n    if (empty($BoardID)) {\n        return;\n    }\n\n    //\u53d6\u5f97\u672c\u6a21\u7d44\u7de8\u865f\n    $module_id = $xoopsModule->mid();\n\n    //\u53d6\u5f97\u76ee\u524d\u4f7f\u7528\u8005\u7684\u7fa4\u7d44\u7de8\u865f\n    if ($xoopsUser) {\n        $uid = $xoopsUser->uid();\n        $groups = $xoopsUser->getGroups();\n    } else {\n        $uid = 0;\n        $groups = XOOPS_GROUP_ANONYMOUS;\n    }\n\n    $gpermHandler = xoops_getHandler('groupperm');\n\n    if (!$gpermHandler->checkRight('forum_post', $BoardID, $groups, $module_id)) {\n        if ('return' === $mode) {\n            return;\n        }\n\n        header('location:index.php');\n    }\n\n    //\u6293\u53d6\u9810\u8a2d\u503c\n    if (!empty($DefDiscussID)) {\n        $DBV = get_tad_discuss($DefDiscussID);\n    } else {\n        $DBV = [];\n    }\n\n    //\u8a2d\u5b9a\u300cDiscussID\u300d\u6b04\u4f4d\u9810\u8a2d\u503c\n    $DiscussID = (!isset($DBV['DiscussID'])) ? $DefDiscussID : $DBV['DiscussID'];\n\n    //\u8a2d\u5b9a\u300cReDiscussID\u300d\u6b04\u4f4d\u9810\u8a2d\u503c\n    $ReDiscussID = (!isset($DBV['ReDiscussID'])) ? $DefReDiscussID : $DBV['ReDiscussID'];\n\n    //\u8a2d\u5b9a\u300cuid\u300d\u6b04\u4f4d\u9810\u8a2d\u503c\n    $uid = (!isset($DBV['uid'])) ? '' : $DBV['uid'];\n    $uid = (is_object($xoopsUser) and empty($uid)) ? $xoopsUser->uid() : $uid;\n\n    //\u8a2d\u5b9a\u300cDiscussTitle\u300d\u6b04\u4f4d\u9810\u8a2d\u503c\n    $DiscussTitle = (!isset($DBV['DiscussTitle'])) ? '' : $DBV['DiscussTitle'];\n\n    //\u8a2d\u5b9a\u300cDiscussContent\u300d\u6b04\u4f4d\u9810\u8a2d\u503c\n    $DiscussContent = (!isset($DBV['DiscussContent'])) ? '' : $DBV['DiscussContent'];\n\n    //\u8a2d\u5b9a\u300cDiscussDate\u300d\u6b04\u4f4d\u9810\u8a2d\u503c\n    $DiscussDate = (!isset($DBV['DiscussDate'])) ? date('Y-m-d H:i:s') : $DBV['DiscussDate'];\n\n    //\u8a2d\u5b9a\u300cBoardID\u300d\u6b04\u4f4d\u9810\u8a2d\u503c\n    $BoardID = (!isset($DBV['BoardID'])) ? $BoardID : $DBV['BoardID'];\n\n    //\u8a2d\u5b9a\u300cLastTime\u300d\u6b04\u4f4d\u9810\u8a2d\u503c\n    $LastTime = (!isset($DBV['LastTime'])) ? date('Y-m-d H:i:s') : $DBV['LastTime'];\n\n    //\u8a2d\u5b9a\u300cCounter\u300d\u6b04\u4f4d\u9810\u8a2d\u503c\n    $Counter = (!isset($DBV['Counter'])) ? '' : $DBV['Counter'];\n\n    //\u8a2d\u5b9a\u300conlyTo\u300d\u6b04\u4f4d\u9810\u8a2d\u503c\n    $onlyTo = (!isset($DBV['onlyTo'])) ? '' : $DBV['onlyTo'];\n\n    $op = (empty($DiscussID)) ? 'insert_tad_discuss' : 'update_tad_discuss';\n    //$op=\"replace_tad_discuss\";\n\n    $FormValidator = new FormValidator('#myForm', true);\n    $FormValidator->render();\n\n    $RE = !empty($DefReDiscussID) ? get_tad_discuss($DefReDiscussID) : [];\n\n    if (empty($ReDiscussID)) {\n        $board_option = \"<select name='BoardID' class='form-control'>\" . get_tad_discuss_board_option($BoardID) . '</select>';\n        $twidth = '76%';\n    } else {\n        $board_option = \"<input type='hidden' name='BoardID' value='{$BoardID}'>\";\n        $twidth = '99%';\n    }\n\n    if (empty($DefReDiscussID)) {\n        $DiscussTitle = \"\n        <div class='row' style='margin: 10px 0px;'>\n            <div class='col-sm-3'>{$board_option}</div>\n            <div class='col-sm-9'>\n                <input type='text' name='DiscussTitle' value='{$DiscussTitle}' id='DiscussTitle' class='form-control validate[required]' placeholder='\" . _MD_TADDISCUS_INPUT_TITLE . \"' class=''>\n            </div>\n        </div>\";\n    } else {\n        $DiscussTitle = \"\n        {$board_option}\n        <input type='hidden' name='DiscussTitle' value='RE:{$RE['DiscussTitle']}'>\";\n    }\n\n    $Board = get_tad_discuss_board($BoardID);\n    if ('0' == $Board['BoardEnable']) {\n        redirect_header('index.php', 3, _MD_TADDISCUS_BOARD_UNABLE);\n    }\n\n    //$BoardTitle=(empty($DefDiscussID) and empty($DefReDiscussID))?\"<h1><a href='discuss.php?BoardID=$BoardID'>{$Board['BoardTitle']}</a></h1>\":\"\";\n    //die('$BoardID:'.$BoardID.',$DefDiscussID:'.$DefDiscussID.',$DefReDiscussID:'.$DefReDiscussID);\n    if (!empty($BoardID) and empty($DefDiscussID) and empty($DefReDiscussID)) {\n        $BoardTitle = get_board_title($BoardID);\n    }\n\n    $TadUpFiles->set_col('DiscussID', $DefDiscussID); //\u82e5 $show_list_del_file ==true \u6642\u4e00\u5b9a\u8981\u6709\n    $upform = $TadUpFiles->upform(true, 'upfile', 100, true);\n\n    $checked = !empty($onlyTo) ? 'checked' : '';\n    if ($DefReDiscussID) {\n        $RE = get_tad_discuss($DefReDiscussID);\n        $checked = !empty($RE['onlyTo']) ? 'checked' : '';\n    }\n\n    if ('CKEditor' === $xoopsModuleConfig['def_editor']) {\n\n        $ck = new CkEditor('tad_discuss', 'DiscussContent', $DiscussContent);\n        $ck->setToolbarSet('mySimple');\n        $ck->setHeight(250);\n        $editor = $ck->render();\n    } else {\n        $editor = \"<textarea name='DiscussContent' cols='50' rows=8 id='DiscussContent' class='validate[required,minSize[5]]' style='width:100%; height:150px;font-size: 75%;line-height:150%;border:1px dotted #B0B0B0;'>{$DiscussContent}</textarea>\";\n    }\n    $xoopsTpl->assign('def_editor', $xoopsModuleConfig['def_editor']);\n\n    $captcha_js = '';\n    $captcha_div = '';\n    if (!is_object($xoopsUser)) {\n        $captcha_js = \"\n        <link rel='stylesheet' type='text/css' href='class/Qaptcha3/jquery/QapTcha.jquery.css' media='screen'>\n        <script type='text/javascript' src='class/Qaptcha3/jquery/jquery.ui.touch.js'></script>\n        <script type='text/javascript' src='class/Qaptcha3/jquery/QapTcha.jquery.js'></script>\n        <script type='text/javascript'>\n            $(document).ready(function(){\n            $('.QapTcha').QapTcha({disabledSubmit:true , autoRevert:true , PHPfile:'class/Qaptcha3/php/Qaptcha.jquery.php', txtLock:'\" . _MD_TADDISCUS_TXTLOCK . \"' , txtUnlock:'\" . _MD_TADDISCUS_TXTUNLOCK . \"'});\n            });\n        </script>\";\n        $captcha_div = \"<div class='QapTcha'></div>\";\n        $only_root = '';\n    } else {\n        $only_root = \"\n        <label class='checkbox-inline'>\n            <input type='checkbox' name='only_root' value='1' $checked>\" . _MD_TADDISCUS_ONLY_ROOT . '\n        </label>';\n    }\n\n    $DiscussContent = \"\n    $DiscussTitle\n    <div style='margin: 10px 0px;'>\n        {$editor}\n    </div>\n    <div class='row'>\n        <div class='col-sm-6'>\n            {$captcha_div}\n        </div>\n        <div class='col-sm-6 text-right'>\n            {$only_root}\n            <input type='hidden' name='OldBoardID' value='{$BoardID}'>\n            <input type='hidden' name='DiscussID' value='{$DefDiscussID}'>\n            <input type='hidden' name='ReDiscussID' value='{$ReDiscussID}'>\n            <input type='hidden' name='uid' value='{$uid}'>\n            <input type='hidden' name='op' value='{$op}'>\n            <button type='submit' class='btn btn-primary'>\" . _TAD_SAVE . \"</button>\n            {$captcha_js}\n        </div>\n    </div>\n    {$upform}\";\n\n    $DiscussDate = date('Y-m-d H:i:s', xoops_getUserTimestamp(strtotime($DiscussDate)));\n\n    if ('left' === $xoopsModuleConfig['display_mode']) {\n        $dir = 'left';\n        $width = 100;\n    } elseif ('top' === $xoopsModuleConfig['display_mode']) {\n        $dir = 'top';\n        $width = 100;\n    } elseif ('bottom' === $xoopsModuleConfig['display_mode']) {\n        $dir = 'bottom';\n        $width = 100;\n    } elseif ('mobile' === $xoopsModuleConfig['display_mode']) {\n        $dir = '';\n        $width = 120;\n    } elseif ('clean' === $xoopsModuleConfig['display_mode']) {\n        $dir = '';\n        $width = 50;\n    } elseif ('default' === $xoopsModuleConfig['display_mode']) {\n        $dir = $i % 2 ? 'left' : 'right';\n        $width = 100;\n    } else {\n        $dir = '';\n        $width = 100;\n    }\n\n    $all[0] = talk_bubble($BoardID, $DiscussID, $DiscussContent, $dir, $uid, $publisher, $DiscussDate, 'return', null, null, $width, $onlyTo);\n\n    if ('return' === $mode) {\n        return $all;\n    }\n    $xoopsTpl->assign('display_mode', $xoopsModuleConfig['display_mode']);\n    $xoopsTpl->assign('op', $_REQUEST['op']);\n    $xoopsTpl->assign('form_data', $all);\n    $xoopsTpl->assign('uid', $uid);\n}\n\n//\u53d6\u5f97tad_discuss_board\u5206\u985e\u9078\u55ae\u7684\u9078\u9805\uff08\u55ae\u5c64\u9078\u55ae\uff09\nfunction get_tad_discuss_board_option($default_BoardID = '0')\n{\n    global $xoopsDB, $xoopsUser, $xoopsModule;\n\n    //\u53d6\u5f97\u672c\u6a21\u7d44\u7de8\u865f\n    $module_id = $xoopsModule->mid();\n\n    //\u53d6\u5f97\u76ee\u524d\u4f7f\u7528\u8005\u7684\u7fa4\u7d44\u7de8\u865f\n    if ($xoopsUser) {\n        $uid = $xoopsUser->uid();\n        $groups = $xoopsUser->getGroups();\n    } else {\n        $uid = 0;\n        $groups = XOOPS_GROUP_ANONYMOUS;\n    }\n    $gpermHandler = xoops_getHandler('groupperm');\n\n    $sql = 'SELECT `BoardID` , `ofBoardID` , `BoardTitle` FROM `' . $xoopsDB->prefix('tad_discuss_board') . '` ORDER BY `BoardSort`';\n    $result = $xoopsDB->query($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n\n    $option = '';\n    while (list($BoardID, $ofBoardID, $BoardTitle) = $xoopsDB->fetchRow($result)) {\n        if (!$gpermHandler->checkRight('forum_post', $BoardID, $groups, $module_id)) {\n            continue;\n        }\n\n        $selected = ($BoardID == $default_BoardID) ? 'selected' : '';\n        // $option[$i]['selected']=$selected;\n        // $option[$i]['BoardID']=$BoardID;\n        // $option[$i]['ofBoardID']=$ofBoardID;\n        // $option[$i]['BoardTitle']=$BoardTitle;\n        $option .= \"<option value='{$BoardID}' {$selected}>{$BoardTitle}</option>\";\n    }\n\n    return $option;\n}\n\n//\u4ee5\u6d41\u6c34\u865f\u79c0\u51fa\u67d0\u7b46tad_discuss\u8cc7\u6599\u5167\u5bb9\nfunction show_one_tad_discuss($DefDiscussID = '')\n{\n    global $xoopsDB, $xoopsModule, $xoopsUser, $isAdmin, $xoopsModuleConfig, $xoopsTpl, $xoTheme;\n\n    $myts = \\MyTextSanitizer::getInstance();\n    if (empty($DefDiscussID)) {\n        return;\n    }\n    $DefDiscussID = (int) $DefDiscussID;\n    $discuss = get_tad_discuss($DefDiscussID);\n\n    //\u53d6\u5f97\u672c\u6a21\u7d44\u7de8\u865f\n    $module_id = $xoopsModule->mid();\n\n    //\u53d6\u5f97\u76ee\u524d\u4f7f\u7528\u8005\u7684\u7fa4\u7d44\u7de8\u865f\n    if ($xoopsUser) {\n        $now_uid = $xoopsUser->uid();\n        $groups = $xoopsUser->getGroups();\n    } else {\n        $now_uid = 0;\n        $groups = XOOPS_GROUP_ANONYMOUS;\n    }\n\n    $gpermHandler = xoops_getHandler('groupperm');\n    if (!$gpermHandler->checkRight('forum_read', $discuss['BoardID'], $groups, $module_id)) {\n        header('location:index.php');\n    }\n\n    if (0 != $discuss['ReDiscussID']) {\n        header(\"location: {$_SERVER['PHP_SELF']}?DiscussID={$discuss['ReDiscussID']}&BoardID={$discuss['BoardID']}\");\n    }\n\n    add_tad_discuss_counter($DefDiscussID);\n\n    $js = \"\n    <script type='text/javascript' src='\" . XOOPS_URL . \"/modules/tadtools/jqueryCookie/jquery.cookie.js'></script>\n    <link rel='stylesheet' type='text/css' media='screen' href='reset.css'>\n    <script>\n        function like(op,DiscussID){\n            if($.cookie('like'+DiscussID)){\n                alert('\" . _MD_TADDISCUS_HAD_LIKE . \"');\n            }else{\n            $.post('like.php',  {op: op , DiscussID: DiscussID} , function(data) {\n                $('#'+op+DiscussID).html(data);\n            });\n\n            $.cookie('like'+DiscussID , true , { expires: 7 });\n            }\n        }\n\n\n        function delete_tad_discuss_func(DiscussID){\n            var sure = window.confirm('\" . _TAD_DEL_CONFIRM . \"');\n            if (!sure)  return;\n            location.href=\\\"{$_SERVER['PHP_SELF']}?op=delete_tad_discuss&ReDiscussID=$DefDiscussID&BoardID={$discuss['BoardID']}&DiscussID=\\\" + DiscussID;\n        }\n    </script>\";\n\n    $Board = get_tad_discuss_board($discuss['BoardID']);\n\n    $sql = 'select * from ' . $xoopsDB->prefix('tad_discuss') . \" where DiscussID='$DefDiscussID' or ReDiscussID='$DefDiscussID' order by ReDiscussID , DiscussDate\";\n\n    //Utility::getPageBar($\u539fsql\u8a9e\u6cd5, \u6bcf\u9801\u986f\u793a\u5e7e\u7b46\u8cc7\u6599, \u6700\u591a\u986f\u793a\u5e7e\u500b\u9801\u6578\u9078\u9805);\n    $PageBar = Utility::getPageBar($sql, $xoopsModuleConfig['show_bubble_amount'], 10);\n    $bar = $PageBar['bar'];\n    $sql = $PageBar['sql'];\n    $total = $PageBar['total'];\n\n    if (empty($total)) {\n        redirect_header($_SERVER['PHP_SELF'], 3, _MD_TADDISCUS_THE_DISCUSS_EMPTY);\n    }\n\n    $result = $xoopsDB->query($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n\n    $discuss_data = [];\n    $i = 1;\n    $first = '';\n\n    $memberHandler = xoops_getHandler('member');\n    while (false !== ($all = $xoopsDB->fetchArray($result))) {\n        //\u4ee5\u4e0b\u6703\u7522\u751f\u9019\u4e9b\u8b8a\u6578\uff1a $DiscussID , $ReDiscussID , $uid , $DiscussTitle , $DiscussContent , $DiscussDate , $BoardID , $LastTime , $Counter\n        foreach ($all as $k => $v) {\n            $$k = $v;\n        }\n\n        if (!isset($onlyTo1)) {\n            $onlyTo1 = $onlyTo;\n        }\n\n        if ('left' === $xoopsModuleConfig['display_mode']) {\n            $dir = 'left';\n            $width = 100;\n        } elseif ('top' === $xoopsModuleConfig['display_mode']) {\n            $dir = 'top';\n            $width = 100;\n        } elseif ('bottom' === $xoopsModuleConfig['display_mode']) {\n            $dir = 'bottom';\n            $width = 100;\n        } elseif ('mobile' === $xoopsModuleConfig['display_mode']) {\n            $dir = '';\n            $width = 120;\n        } elseif ('clean' === $xoopsModuleConfig['display_mode']) {\n            $dir = '';\n            $width = 50;\n        } elseif ('default' === $xoopsModuleConfig['display_mode']) {\n            $dir = $i % 2 ? 'left' : 'right';\n            $width = 100;\n        } else {\n            $dir = '';\n            $width = 100;\n        }\n\n        if (empty($first)) {\n            $first = $DiscussContent;\n        }\n\n        $discuss['DiscussTitle'] = $myts->htmlSpecialChars($discuss['DiscussTitle']);\n        $discuss['DiscussTitle'] = str_replace('[s', \"<img src='\" . XOOPS_URL . '/modules/tad_discuss/images/smiles/s', $discuss['DiscussTitle']);\n        $discuss['DiscussTitle'] = str_replace('.gif]', \".gif' hspace=2 align='absmiddle'>\", $discuss['DiscussTitle']);\n\n        $DiscussContent = str_replace('[s', \"<img src='\" . XOOPS_URL . '/modules/tad_discuss/images/smiles/s', $DiscussContent);\n        $DiscussContent = str_replace('.gif]', \".gif' hspace=2 align='absmiddle'>\", $DiscussContent);\n\n        //\u82e5\u7121\u4efb\u4f55\u6a19\u7c64\u5247\u5957\u7528nl2br\n        if (false === mb_strpos($DiscussContent, '<')) {\n            $DiscussContent = $myts->displayTarea($DiscussContent, 0, 1, 1, 1, 1);\n        } else {\n            $DiscussContent = $myts->displayTarea($DiscussContent, 1, 0, 0, 1, 0);\n        }\n\n        $discuss_data[$i] = talk_bubble($discuss['BoardID'], $DiscussID, $DiscussContent, $dir, $uid, $publisher, $DiscussDate, 'return', $Good, $Bad, $width, $onlyTo);\n        $i++;\n    }\n\n    //if($xoopsUser){\n    $dir = $i % 2 ? 'left' : 'right';\n    $form_data = tad_discuss_form($discuss['BoardID'], '', $DefDiscussID, $dir, 'return');\n    //}\n\n    $onlyToName = getOnlyToName($onlyTo1);\n    $discuss['DiscussTitle'] = isPublic($onlyTo1, $uid, $discuss['BoardID']) ? $discuss['DiscussTitle'] : sprintf(_MD_TADDISCUS_ONLYTO, $onlyToName);\n    //die(var_export($discuss_data));\n    $xoopsTpl->assign('BoardID', $discuss['BoardID']);\n    $xoopsTpl->assign('BoardTitle', $Board['BoardTitle']);\n    $xoopsTpl->assign('DiscussTitle', $discuss['DiscussTitle']);\n    $xoopsTpl->assign('display_mode', $xoopsModuleConfig['display_mode']);\n    $xoopsTpl->assign('op', 'show_one_tad_discuss');\n    $xoopsTpl->assign('js', $js);\n    $xoopsTpl->assign('discuss_data', $discuss_data);\n    $xoopsTpl->assign('form_data', $form_data);\n    $xoopsTpl->assign('bar', $bar);\n    $xoopsTpl->assign('isPublic', isPublic($onlyTo1, $uid, $discuss['BoardID']));\n    $xoopsTpl->assign('onlyTo', $onlyTo);\n    $xoopsTpl->assign('ReDiscussID', $DefDiscussID);\n\n    $title = $discuss['DiscussTitle'];\n    $description = strip_tags($first);\n\n    $fb_tag = \"\n      <meta property=\\\"og:title\\\" content=\\\"{$title}\\\">\n      \";\n    $xoopsTpl->assign('xoops_module_header', $fb_tag);\n    $xoopsTpl->assign('xoops_pagetitle', $title);\n    if (is_object($xoTheme)) {\n        $xoTheme->addMeta('meta', 'keywords', $title);\n    } else {\n        $xoopsTpl->assign('xoops_meta_keywords', 'keywords', $title);\n    }\n}\n\n//\u66f4\u65b0tad_discuss\u67d0\u4e00\u7b46\u8cc7\u6599\nfunction update_tad_discuss($DiscussID = '')\n{\n    global $xoopsDB, $xoopsUser, $TadUpFiles;\n\n    $myts = \\MyTextSanitizer::getInstance();\n    $DiscussTitle = $myts->addSlashes($_POST['DiscussTitle']);\n    $DiscussContent = $myts->addSlashes($_POST['DiscussContent']);\n\n    if (empty($_SERVER['HTTP_X_FORWARDED_FOR'])) {\n        $myip = $_SERVER['REMOTE_ADDR'];\n    } else {\n        $myip = explode(',', $_SERVER['HTTP_X_FORWARDED_FOR']);\n        $myip = $myip[0];\n    }\n\n    $anduid = onlyMine($DiscussID);\n\n    if (chk_spam($DiscussTitle)) {\n        redirect_header($_SERVER['PHP_SELF'], 3, _MD_TADDISCUS_FOUND_SPAM);\n    }\n\n    if (chk_spam($DiscussContent)) {\n        redirect_header($_SERVER['PHP_SELF'], 3, _MD_TADDISCUS_FOUND_SPAM);\n    }\n\n    $onlyTo = '';\n    $ReDiscussID = isset($_POST['ReDiscussID']) ? (int) $_POST['ReDiscussID'] : 0;\n    $BoardID = isset($_POST['BoardID']) ? (int) $_POST['BoardID'] : 0;\n    $OldBoardID = isset($_POST['OldBoardID']) ? (int) $_POST['OldBoardID'] : 0;\n\n    $Discuss = get_tad_discuss($ReDiscussID);\n    if ('1' == $_POST['only_root'] and !empty($ReDiscussID)) {\n        $onlyTo = $Discuss['uid'];\n    } elseif ('1' == $_POST['only_root']) {\n        $memberHandler = xoops_getHandler('member');\n        $adminusers = $memberHandler->getUsersByGroup(1);\n        $onlyTo = implode(',', $adminusers);\n    }\n\n    //$now=date('Y-m-d H:i:s',xoops_getUserTimestamp(time()));\n    $time = date('Y-m-d H:i:s');\n    $sql = 'update ' . $xoopsDB->prefix('tad_discuss') . \" set\n   `BoardID` = '{$BoardID}' ,\n   `DiscussTitle` = '{$DiscussTitle}' ,\n   `DiscussContent` = '{$DiscussContent}' ,\n   `LastTime` = '$time',\n   `FromIP` = '$myip',\n   `onlyTo` = '$onlyTo'\n  where DiscussID='$DiscussID' $anduid\";\n\n    //die($sql);\n    $xoopsDB->queryF($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n\n    if ($OldBoardID != $BoardID) {\n        $sql = 'update ' . $xoopsDB->prefix('tad_discuss') . \" set\n     `BoardID` = '{$BoardID}'\n    where ReDiscussID='$DiscussID'\";\n        $xoopsDB->queryF($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n    }\n\n    $TadUpFiles->set_col('DiscussID', $DiscussID);\n    $TadUpFiles->upload_file('upfile', 1024, 120, null, '', true);\n\n    return $DiscussID;\n}\n\nfunction change_lock($lock, $BoardID, $DiscussID)\n{\n    global $xoopsDB, $xoopsUser;\n\n    $anduid = onlyMine($DiscussID);\n\n    $onlyTo = '';\n\n    if ($lock) {\n        $ReDiscussID = isset($_REQUEST['ReDiscussID']) ? (int) $_REQUEST['ReDiscussID'] : 0;\n        $Discuss = get_tad_discuss($ReDiscussID);\n        if ('1' == $_POST['only_root'] and !empty($ReDiscussID)) {\n            $onlyTo = $Discuss['uid'];\n        } elseif ('1' == $_POST['only_root']) {\n            $adminusers = $memberHandler->getUsersByGroup(1);\n            $onlyTo = implode(',', $adminusers);\n        }\n    }\n\n    $sql = 'update ' . $xoopsDB->prefix('tad_discuss') . \" set\n   `onlyTo` = '$onlyTo'\n  where DiscussID='$DiscussID' $anduid\";\n    //die($sql);\n    $xoopsDB->queryF($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n\n    return $DiscussID;\n}\n\n//\u65b0\u589etad_discuss\u8a08\u6578\u5668\nfunction add_tad_discuss_counter($DiscussID = '')\n{\n    global $xoopsDB, $xoopsModule;\n    $sql = 'update ' . $xoopsDB->prefix('tad_discuss') . \" set `Counter`=`Counter`+1 where `DiscussID`='{$DiscussID}'\";\n    $xoopsDB->queryF($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n}\n\n/*-----------\u57f7\u884c\u52d5\u4f5c\u5224\u65b7\u5340----------*/\nrequire_once $GLOBALS['xoops']->path('/modules/system/include/functions.php');\n$op = system_CleanVars($_REQUEST, 'op', '', 'string');\n$BoardID = system_CleanVars($_REQUEST, 'BoardID', 0, 'int');\n$DiscussID = system_CleanVars($_REQUEST, 'DiscussID', 0, 'int');\n$ReDiscussID = system_CleanVars($_REQUEST, 'ReDiscussID', 0, 'int');\n$files_sn = system_CleanVars($_REQUEST, 'files_sn', 0, 'int');\n\n$xoopsTpl->assign('toolbar', Utility::toolbar_bootstrap($interface_menu));\n$xoopsTpl->assign('jquery', Utility::get_jquery(true));\n$xoopsTpl->assign('isAdmin', $isAdmin);\nif ($xoopsUser) {\n    $xoopsTpl->assign('now_uid', $xoopsUser->uid());\n} else {\n    $xoopsTpl->assign('now_uid', '--');\n}\n\nswitch ($op) {\n    //\u65b0\u589e\u8cc7\u6599\n    case 'insert_tad_discuss':\n        $DiscussID = insert_tad_discuss();\n        redirect_header(\"discuss.php?DiscussID={$DiscussID}&BoardID={$BoardID}\", 0, _MD_TADDISCUS_SAVE_OK);\n        break;\n    //\u66f4\u65b0\u8cc7\u6599\n    case 'update_tad_discuss':\n        update_tad_discuss($DiscussID);\n        $ID = empty($ReDiscussID) ? $DiscussID : $ReDiscussID;\n        header(\"location: {$_SERVER['PHP_SELF']}?DiscussID=$ID&BoardID=$BoardID\");\n        exit;\n        break;\n    //\u522a\u9664\u8cc7\u6599\n    case 'delete_tad_discuss':\n        delete_tad_discuss($DiscussID);\n        header(\"location: {$_SERVER['PHP_SELF']}?BoardID=$BoardID\");\n        exit;\n        break;\n    //\u8f38\u5165\u8868\u683c\n    case 'tad_discuss_form':\n        tad_discuss_form($BoardID, $DiscussID, $ReDiscussID);\n        break;\n    //\u4e0b\u8f09\u6a94\u6848\n    case 'tufdl':\n        $files_sn = isset($_GET['files_sn']) ? (int) $_GET['files_sn'] : '';\n        $TadUpFiles->add_file_counter($files_sn);\n        exit;\n        break;\n    case 'unlock':\n        change_lock(false, $BoardID, $DiscussID);\n        header(\"location: {$_SERVER['PHP_SELF']}?DiscussID=$DiscussID&BoardID=$BoardID\");\n        exit;\n        break;\n    case 'lock':\n        change_lock(true, $BoardID, $DiscussID);\n        header(\"location: {$_SERVER['PHP_SELF']}?DiscussID=$DiscussID&BoardID=$BoardID\");\n        exit;\n        break;\n    //\u9810\u8a2d\u52d5\u4f5c\n    default:\n        if (empty($DiscussID)) {\n            list_tad_discuss($BoardID);\n        } else {\n            show_one_tad_discuss($DiscussID);\n        }\n        break;\n}\n\n/*-----------\u79c0\u51fa\u7d50\u679c\u5340--------------*/\nrequire_once XOOPS_ROOT_PATH . '/footer.php';\n", "<?php\nuse XoopsModules\\Tadtools\\FooTable;\nuse XoopsModules\\Tadtools\\Utility;\n\nxoops_loadLanguage('main', 'tadtools');\n\nrequire_once __DIR__ . '/function_block.php';\n\nrequire_once $GLOBALS['xoops']->path('/modules/system/include/functions.php');\n/********************* \u81ea\u8a02\u51fd\u6578 ********************\n * @param string $BoardID\n * @param string $DiscussID\n * @param string $DiscussContent\n * @param string $dir\n * @param string $uid\n * @param string $publisher\n * @param string $DiscussDate\n * @param string $mode\n * @param int    $Good\n * @param int    $Bad\n * @param int    $width\n * @param string $onlyTo\n * @return mixed\n */\n\n//\u5c0d\u8a71\u6846\u683c\u5f0f\nfunction talk_bubble($BoardID = '', $DiscussID = '', $DiscussContent = '', $dir = 'left', $uid = '', $publisher = '', $DiscussDate = '', $mode = '', $Good = 0, $Bad = 0, $width = 100, $onlyTo = '')\n{\n    global $xoopsUser, $xoopsTpl, $xoopsModuleConfig, $TadUpFiles;\n\n    $memberHandler = xoops_getHandler('member');\n    $user = $memberHandler->getUser($uid);\n    $pic = XOOPS_URL . '/modules/tad_discuss/images/nobody.png';\n    $uid_name = _MD_TADDISCUS_NOBODY;\n    $user_sig = '';\n    if (is_object($user) and $uid) {\n        $ts = \\MyTextSanitizer::getInstance();\n        $uid_name = empty($publisher) ? $ts->htmlSpecialChars($user->name()) : $publisher;\n        if (empty($uid_name)) {\n            $uid_name = $ts->htmlSpecialChars($user->uname());\n        }\n        $user_sig = $user->user_sig();\n        $user_avatar = $ts->htmlSpecialChars($user->getVar('user_avatar'));\n        $pic = !empty($user_avatar) ? XOOPS_URL . '/uploads/' . $user_avatar : $pic;\n    }\n\n    $pic_js = $pic_css = '';\n\n    $now_uid = is_object($xoopsUser) ? $xoopsUser->uid() : '0';\n\n    if ($now_uid == $uid) {\n        $pic_js = \"onClick=\\\"location.href='\" . XOOPS_URL . \"/edituser.php?op=avatarform'\\\"\";\n        $pic_css = 'cursor:pointer;';\n    }\n\n    $like = (!empty($DiscussID) && 'tad_discuss_form' !== $_REQUEST['op']) ? true : false;\n    //$fun=(isMine($uid,$BoardID) and !empty($BoardID) and !empty($DiscussID) and $_REQUEST['op']!='tad_discuss_form')?true:false;\n\n    $fun = (isMine($uid, $BoardID) && 'tad_discuss_form' !== $_REQUEST['op'] && !empty($DiscussID)) ? true : false;\n\n    //$files=show_files(\"DiscussID\" , $DiscussID , true , '' , true , false);\n    if ('tad_discuss_form' !== $_REQUEST['op']) {\n        $TadUpFiles->set_col('DiscussID', $DiscussID);\n        $files = $TadUpFiles->show_files('upfile', true, null, true, false); //\u662f\u5426\u7e2e\u5716,\u986f\u793a\u6a21\u5f0f filename\u3001small,\u986f\u793a\u63cf\u8ff0,\u986f\u793a\u4e0b\u8f09\u6b21\u6578\n    }\n\n    $files = isPublic($onlyTo, $uid, $BoardID) ? $files : '';\n    $DiscussDate = date('Y-m-d H:i:s', xoops_getUserTimestamp(strtotime($DiscussDate)));\n    if ('mobile' === $xoopsModuleConfig['display_mode']) {\n        $DiscussDate = mb_substr($DiscussDate, 0, 16);\n    }\n\n    $onlyToName = getOnlyToName($onlyTo);\n\n    $all['width'] = $width;\n    $all['dir'] = $dir;\n    $all['pic'] = $pic;\n    $all['pic_css'] = $pic_css;\n    $all['pic_js'] = $pic_js;\n    $all['fun'] = $fun;\n\n    if ('1' == $xoopsModuleConfig['show_like']) {\n        $all['like'] = $like;\n    } else {\n        $all['like'] = '';\n    }\n\n    $all['uid'] = $uid;\n    $all['uid_name'] = $uid_name;\n    $all['user_sig'] = $user_sig;\n    $all['DiscussDate'] = $DiscussDate;\n    //$all['DiscussContent']=$DiscussContent;\n    $all['DiscussContent'] = isPublic($onlyTo, $uid, $BoardID) ? $DiscussContent : sprintf(_MD_TADDISCUS_ONLYTO, $onlyToName);\n    $all['DiscussID'] = $DiscussID;\n    $all['BoardID'] = $BoardID;\n    $all['Bad'] = $Bad;\n    $all['Good'] = $Good;\n    $all['files'] = $files;\n    $all['onlyTo'] = $onlyTo;\n    $all['show_sig'] = $xoopsModuleConfig['show_sig'];\n    $all['sig_style'] = $xoopsModuleConfig['sig_style'];\n    //die(var_export($all));\n    if ('return' === $mode) {\n        return $all;\n    }\n    $xoopsTpl->assign('discuss', $all);\n}\n\n//\u65b0\u589e\u8cc7\u6599\u5230tad_discuss_board\u4e2d\nfunction insert_tad_discuss_board($BoardTitle = '')\n{\n    global $xoopsDB, $xoopsUser, $TadUpFiles;\n\n    $myts = \\MyTextSanitizer::getInstance();\n    $BoardTitle = $myts->addSlashes($BoardTitle);\n    $BoardDesc = $myts->addSlashes($_POST['BoardDesc']);\n\n    $BoardManager = is_array($_POST['BoardManager']) ? implode(',', $_POST['BoardManager']) : $_POST['BoardManager'];\n    if (empty($BoardManager)) {\n        $BoardManager = $xoopsUser->uid();\n    }\n\n    $forum_read = system_CleanVars($_REQUEST, 'forum_read', [1, 2, 3], 'array');\n    $forum_post = system_CleanVars($_REQUEST, 'forum_post', [1, 2], 'array');\n    $BoardEnable = system_CleanVars($_REQUEST, 'BoardEnable', 1, 'int');\n    $ofBoardID = (int) $_POST['ofBoardID'];\n\n    $sql = 'insert into `' . $xoopsDB->prefix('tad_discuss_board') . \"`\n  (`ofBoardID` , `BoardTitle` , `BoardDesc` , `BoardManager` , `BoardEnable`)\n  values('{$ofBoardID}' , '{$BoardTitle}' , '{$BoardDesc}' , '{$BoardManager}' , '{$BoardEnable}')\";\n    $xoopsDB->query($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n\n    //\u53d6\u5f97\u6700\u5f8c\u65b0\u589e\u8cc7\u6599\u7684\u6d41\u6c34\u7de8\u865f\n    $BoardID = $xoopsDB->getInsertId();\n\n    //\u5beb\u5165\u6b0a\u9650\n    saveItem_Permissions($forum_read, $BoardID, 'forum_read');\n    saveItem_Permissions($forum_post, $BoardID, 'forum_post');\n\n    $TadUpFiles->set_col('BoardID', $BoardID);\n    $TadUpFiles->upload_file('upfile', 1024, 120, null, '', true);\n\n    return $BoardID;\n}\n\n//\u65b0\u589e\u8cc7\u6599\u5230tad_discuss_cbox_setup\u4e2d\nfunction insert_tad_discuss_cbox_setup($setupName = '', $setupRule = '', $newBorard = '', $BoardID = '')\n{\n    global $xoopsDB, $xoopsUser, $TadUpFiles;\n\n    //\u53d6\u5f97\u4f7f\u7528\u8005\u7de8\u865f\n    $uid = ($xoopsUser) ? $xoopsUser->uid() : '';\n\n    $myts = \\MyTextSanitizer::getInstance();\n    $setupName = $myts->addSlashes($setupName);\n    $setupRule = $myts->addSlashes($setupRule);\n    $newBorard = $myts->addSlashes($newBorard);\n\n    if (!empty($newBorard)) {\n        $BoardID = insert_tad_discuss_board($newBorard);\n    }\n\n    $setupSort = tad_discuss_cbox_setup_max_sort();\n\n    $sql = 'insert into `' . $xoopsDB->prefix('tad_discuss_cbox_setup') . \"`\n  (`setupName` , `setupRule` , `BoardID` , `setupSort`)\n  values('{$setupName}' , '{$setupRule}' , '{$BoardID}' , '{$setupSort}')\";\n    $xoopsDB->query($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n\n    //\u53d6\u5f97\u6700\u5f8c\u65b0\u589e\u8cc7\u6599\u7684\u6d41\u6c34\u7de8\u865f\n    //$setupID = $xoopsDB->getInsertId();\n    return $BoardID;\n}\n\n//\u81ea\u52d5\u53d6\u5f97tad_discuss_cbox_setup\u7684\u6700\u65b0\u6392\u5e8f\nfunction tad_discuss_cbox_setup_max_sort()\n{\n    global $xoopsDB;\n    $sql = 'SELECT max(`setupSort`) FROM `' . $xoopsDB->prefix('tad_discuss_cbox_setup') . '`';\n    $result = $xoopsDB->query($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n    list($sort) = $xoopsDB->fetchRow($result);\n\n    return ++$sort;\n}\n\n//\u5132\u5b58\u6b0a\u9650\nfunction saveItem_Permissions($groups, $itemid, $perm_name)\n{\n    global $xoopsModule;\n    $module_id = $xoopsModule->mid();\n    $gpermHandler = xoops_getHandler('groupperm');\n\n    // First, if the permissions are already there, delete them\n    $gpermHandler->deleteByModule($module_id, $perm_name, $itemid);\n\n    // Save the new permissions\n    if (count($groups) > 0) {\n        foreach ($groups as $group_id) {\n            $gpermHandler->addRight($perm_name, $itemid, $group_id, $module_id);\n        }\n    }\n}\n\n//\u5217\u51fa\u6240\u6709tad_discuss\u8cc7\u6599\nfunction list_tad_discuss($DefBoardID = null)\n{\n    global $xoopsDB, $xoopsModule, $xoopsUser, $xoopsModuleConfig, $isAdmin, $xoopsTpl;\n    $myts = \\MyTextSanitizer::getInstance();\n    $now_uid = is_object($xoopsUser) ? $xoopsUser->uid() : '0';\n\n    //\u53d6\u5f97\u672c\u6a21\u7d44\u7de8\u865f\n    $module_id = $xoopsModule->mid();\n\n    //\u53d6\u5f97\u76ee\u524d\u4f7f\u7528\u8005\u7684\u7fa4\u7d44\u7de8\u865f\n    if ($xoopsUser) {\n        $uid = $xoopsUser->uid();\n        $groups = $xoopsUser->getGroups();\n    } else {\n        $uid = 0;\n        $groups = XOOPS_GROUP_ANONYMOUS;\n    }\n\n    $gpermHandler = xoops_getHandler('groupperm');\n    if (!$gpermHandler->checkRight('forum_read', $DefBoardID, $groups, $module_id)) {\n        header('location:index.php');\n    }\n\n    $post = $gpermHandler->checkRight('forum_post', $DefBoardID, $groups, $module_id);\n    $xoopsTpl->assign('post', $post);\n\n    $andBoardID = (empty($DefBoardID)) ? '' : \"and a.BoardID='$DefBoardID'\";\n    $andLimit = ($limit > 0) ? \"limit 0,$limit\" : '';\n    $sql = 'select a.*,b.* from ' . $xoopsDB->prefix('tad_discuss') . ' as a left join ' . $xoopsDB->prefix('tad_discuss_board') . \" as b on a.BoardID = b.BoardID where a.ReDiscussID='0' and b.BoardEnable='1' $andBoardID  order by a.LastTime desc\";\n\n    //Utility::getPageBar($\u539fsql\u8a9e\u6cd5, \u6bcf\u9801\u986f\u793a\u5e7e\u7b46\u8cc7\u6599, \u6700\u591a\u986f\u793a\u5e7e\u500b\u9801\u6578\u9078\u9805);\n    $PageBar = Utility::getPageBar($sql, $xoopsModuleConfig['show_discuss_amount'], 10);\n    $bar = $PageBar['bar'];\n    $sql = $PageBar['sql'];\n    $total = $PageBar['total'];\n\n    $result = $xoopsDB->query($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n\n    $main_data = [];\n    $i = 1;\n    while (false !== ($all = $xoopsDB->fetchArray($result))) {\n        //\u4ee5\u4e0b\u6703\u7522\u751f\u9019\u4e9b\u8b8a\u6578\uff1a $DiscussID , $ReDiscussID , $uid , $DiscussTitle , $DiscussContent , $DiscussDate , $BoardID , $LastTime , $Counter\n        foreach ($all as $k => $v) {\n            $$k = $v;\n        }\n\n        $renum = get_re_num($DiscussID);\n        $renum = empty($renum) ? '0' : $renum;\n\n        if (empty($publisher)) {\n            $uid_name = \\XoopsUser::getUnameFromId($uid, 1);\n            if (empty($uid_name)) {\n                $uid_name = \\XoopsUser::getUnameFromId($uid, 0);\n            }\n        } else {\n            $uid_name = $publisher;\n        }\n\n        //\u6700\u5f8c\u56de\u61c9\u8005\n        $sql2 = 'select uid,publisher from ' . $xoopsDB->prefix('tad_discuss') . \" where ReDiscussID='$DiscussID' order by DiscussDate desc limit 0,1\";\n        $result2 = $xoopsDB->queryF($sql2) or Utility::web_error($sql2);\n        //if($isAdmin)die($sql2);\n        list($last_uid, $last_uid_name) = $xoopsDB->fetchRow($result2);\n        //if($isAdmin and $BoardID==19)die(\"<div>$sql2</div>\\$last_uid={$last_uid}\");\n        if (empty($last_uid_name)) {\n            if (empty($last_uid)) {\n                $last_uid_name = $uid_name;\n            } else {\n                $last_uid_name = \\XoopsUser::getUnameFromId($last_uid, 1);\n                if (empty($last_uid_name)) {\n                    $last_uid_name = \\XoopsUser::getUnameFromId($last_uid, 0);\n                }\n            }\n        }\n\n        $LastTime = date('Y-m-d H:i:s', xoops_getUserTimestamp(strtotime($LastTime)));\n        $LastTime = mb_substr($LastTime, 0, 16);\n        $DiscussDate = date('Y-m-d H:i:s', xoops_getUserTimestamp(strtotime($DiscussDate)));\n        $DiscussDate = mb_substr($DiscussDate, 0, 16);\n\n        $isPublic = isPublic($onlyTo, $uid, $DefBoardID);\n        $onlyToName = getOnlyToName($onlyTo);\n\n        $DiscussTitle = $myts->htmlSpecialChars($DiscussTitle);\n        $DiscussTitle = str_replace('[s', \"<img src='\" . XOOPS_URL . '/modules/tad_discuss/images/smiles/s', $DiscussTitle);\n        $DiscussTitle = str_replace('.gif]', \".gif' hspace=2 align='absmiddle'>\", $DiscussTitle);\n\n        $main_data[$i]['LastTime'] = $LastTime;\n        $main_data[$i]['DiscussID'] = $DiscussID;\n        $main_data[$i]['BoardID'] = $BoardID;\n        $main_data[$i]['DiscussTitle'] = $isPublic ? $DiscussTitle : sprintf(_MD_TADDISCUS_ONLYTO, $onlyToName);\n        $main_data[$i]['uid_name'] = $uid_name;\n        $main_data[$i]['renum'] = $renum;\n        $main_data[$i]['DiscussDate'] = $DiscussDate;\n        $main_data[$i]['LastTime'] = $LastTime;\n        $main_data[$i]['last_uid_name'] = $last_uid_name;\n        $main_data[$i]['isPublic'] = $isPublic;\n        $main_data[$i]['onlyTo'] = $onlyTo;\n        $i++;\n    }\n\n    $xoopsTpl->assign('main_data', $main_data);\n    $xoopsTpl->assign('DefBoardID', $DefBoardID);\n\n    $post_tool = ($post and !empty($DefBoardID)) ? \"<a href='{$_SERVER['PHP_SELF']}?op=tad_discuss_form&BoardID=$DefBoardID' class='btn btn-default btn-secondary'><img src='images/edit.png' align='absmiddle' hspace=4 alt='\" . _MD_TADDISCUS_ADD_DISCUSS . \"'>\" . _MD_TADDISCUS_ADD_DISCUSS . '</a>' : '';\n\n    $FooTable = new FooTable();\n    $FooTableJS = $FooTable->render();\n\n    $ShowBoardTitle = '';\n    if (!empty($DefBoardID)) {\n        $ShowBoardTitle = get_board_title($DefBoardID);\n    }\n\n    $xoopsTpl->assign('FooTableJS', $FooTableJS);\n    $xoopsTpl->assign('post_tool', $post_tool);\n    $xoopsTpl->assign('bar', $bar);\n    $xoopsTpl->assign('ShowBoardTitle', $ShowBoardTitle);\n}\n\n//\u8a0e\u8ad6\u5340\u6a19\u984c\nfunction get_board_title($DefBoardID = '')\n{\n    global $TadUpFiles;\n    if (empty($DefBoardID)) {\n        return;\n    }\n\n    $Board = get_tad_discuss_board($DefBoardID);\n    //$pic=get_pic_file('BoardID' , $Board['BoardID'] , 1 , 'thumb');\n    $TadUpFiles->set_col('BoardID', $DefBoardID);\n    $pic = $TadUpFiles->get_pic_file('thumb'); //thumb \u5c0f\u5716, images \u5927\u5716\uff08default\uff09, file \u6a94\u6848\n    $pic = empty($pic) ? XOOPS_URL . '/modules/tad_discuss/images/board.png' : $pic;\n    $main = \"<div style='width:90px;height:60px;background: transparent url($pic) no-repeat center top;-moz-border-radius: 5px;-khtml-border-radius: 5px;-webkit-border-radius: 5px;border-radius: 5px;position:relative;float:left;margin:0px 10px 6px 0px;' alt='{$Board['BoardTitle']}' title='{$Board['BoardTitle']}'></div>{$Board['BoardTitle']}<div style='font-size: 80%;color:gray;font-weight:normal;cursor:pointer;' onClick=\\\"location.href='discuss.php?BoardID={$DefBoardID}'\\\">{$Board['BoardDesc']}</div><div style='clear:both'></div>\";\n\n    return $main;\n}\n\n//\u4ee5\u6d41\u6c34\u865f\u53d6\u5f97\u67d0\u7b46tad_discuss\u8cc7\u6599\nfunction get_tad_discuss($DiscussID = '')\n{\n    global $xoopsDB;\n    if (empty($DiscussID)) {\n        return;\n    }\n\n    $sql = 'select * from ' . $xoopsDB->prefix('tad_discuss') . \" where DiscussID='$DiscussID'\";\n    $result = $xoopsDB->query($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n    $data = $xoopsDB->fetchArray($result);\n\n    return $data;\n}\n\n//\u53d6\u5f97\u6587\u7ae0\u6578\u91cf\nfunction get_board_num($BoardID = '', $onlyMainDiscuss = true)\n{\n    global $xoopsDB, $xoopsModule, $xoopsUser;\n    if (empty($BoardID)) {\n        return 0;\n    }\n\n    $andMainDiscuss = ($onlyMainDiscuss) ? \"and ReDiscussID='0'\" : '';\n    $sql = 'select count(*) from ' . $xoopsDB->prefix('tad_discuss') . \" where BoardID='$BoardID' {$andMainDiscuss}\";\n    $result = $xoopsDB->query($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n    list($counter) = $xoopsDB->fetchRow($result);\n\n    return $counter;\n}\n\n//\u53d6\u5f97\u56de\u8986\u6578\u91cf\nfunction get_re_num($DiscussID = '')\n{\n    global $xoopsDB, $xoopsModule, $xoopsUser;\n    if (empty($DiscussID)) {\n        return 0;\n    }\n\n    $sql = 'select count(*) from ' . $xoopsDB->prefix('tad_discuss') . \" where ReDiscussID='$DiscussID'\";\n    $result = $xoopsDB->query($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n    list($counter) = $xoopsDB->fetchRow($result);\n\n    return $counter;\n}\n\n//\u662f\u5426\u6709\u7ba1\u7406\u6b0a\uff08\u6216\u7531\u81ea\u5df1\u767c\u5e03\u7684\uff09\uff0c\u5224\u65b7\u662f\u5426\u8981\u79c0\u51fa\u7ba1\u7406\u5de5\u5177\nfunction isMine($discuss_uid = null, $BoardID = null)\n{\n    global $xoopsUser, $isAdmin;\n    if (empty($xoopsUser)) {\n        return false;\n    }\n\n    if ($BoardID) {\n        $board = get_tad_discuss_board($BoardID);\n        $BoardManagerArr = explode(',', $board['BoardManager']);\n    } else {\n        $BoardManagerArr = [];\n    }\n    //die(\"aa\".var_export($board));\n    $uid = $xoopsUser->uid();\n\n    //  echo \"<p>{$isAdmin}?{$uid} -- {$board['BoardManager']}</p>\";\n    if ($isAdmin) {\n        return true;\n    } elseif (in_array($uid, $BoardManagerArr)) {\n        return true;\n    } elseif ($uid == $discuss_uid) {\n        return true;\n    }\n\n    return false;\n}\n\n//\u53d6\u5f97\u7248\u4e3b\u59d3\u540d\nfunction getBoardManager($BoardID = '', $mode = '')\n{\n    if (empty($BoardID)) {\n        return false;\n    }\n\n    $board = get_tad_discuss_board($BoardID);\n    $BoardManagerArr = explode(',', $board['BoardManager']);\n    foreach ($BoardManagerArr as $uid) {\n        $BoardManagerName = \\XoopsUser::getUnameFromId($uid, 1);\n        if (empty($BoardManagerName)) {\n            $BoardManagerName = \\XoopsUser::getUnameFromId($uid, 0);\n        }\n\n        $name[] = \"<a href='\" . XOOPS_URL . \"/userinfo.php?uid={$uid}'>{$BoardManagerName}</a>\";\n    }\n\n    return $name;\n}\n\n//\u66f4\u65b0\u522a\u9664\u6642\u662f\u5426\u9650\u5236\u8eab\u4efd\nfunction onlyMine($DiscussID = '')\n{\n    global $xoopsUser, $isAdmin, $xoopsModule;\n    $uid = is_object($xoopsUser) ? $xoopsUser->uid() : '0';\n    $Discuss = get_tad_discuss($DiscussID);\n    $board = get_tad_discuss_board($Discuss['BoardID']);\n    $BoardManagerArr = explode(',', $board['BoardManager']);\n\n    if ($xoopsUser) {\n        $module_id = $xoopsModule->mid();\n        $isAdmin = $xoopsUser->isAdmin($module_id);\n    }\n\n    if ($isAdmin) {\n        return;\n    } elseif (in_array($uid, $BoardManagerArr)) {\n        return;\n    }\n\n    return \"and uid='$uid'\";\n}\n\n//\u522a\u9664tad_discuss\u67d0\u7b46\u8cc7\u6599\u8cc7\u6599\nfunction delete_tad_discuss($DiscussID = '')\n{\n    global $xoopsDB, $xoopsUser, $isAdmin, $TadUpFiles;\n\n    if (!$xoopsUser) {\n        return;\n    }\n\n    $anduid = onlyMine($DiscussID);\n\n    $sql = 'delete from ' . $xoopsDB->prefix('tad_discuss') . \" where DiscussID='$DiscussID' $anduid\";\n    //die($sql);\n    if ($xoopsDB->queryF($sql)) {\n        $TadUpFiles->set_col('DiscussID', $DiscussID); //\u82e5\u8981\u6574\u500b\u522a\u9664\n        $TadUpFiles->del_files();\n\n        $sql = 'select DiscussID from ' . $xoopsDB->prefix('tad_discuss') . \" where ReDiscussID='$DiscussID'\";\n        $result = $xoopsDB->query($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n        while (list($DiscussID) = $xoopsDB->fetchRow($result)) {\n            delete_tad_discuss($DiscussID);\n        }\n    } else {\n        Utility::web_error($sql, __FILE__, __LINE__);\n    }\n}\n\n//\u6aa2\u67e5\u662f\u5426\u6709\u4e0d\u7576\u8a00\u8ad6\nfunction chk_spam($content = '')\n{\n    global $xoopsModuleConfig;\n    $content = str_replace('/', '', $content);\n    $content = str_replace(' ', '', $content);\n    $content = str_replace('\\\\', '', $content);\n    $content = str_replace('-', '', $content);\n    $content = str_replace('+', '', $content);\n    $content = str_replace('.', '', $content);\n    $content = str_replace('|', '', $content);\n\n    $keys = explode(',', $xoopsModuleConfig['spam_keyword']);\n    foreach ($keys as $key) {\n        $strpos = mb_strpos($content, $key);\n        if (false !== $strpos) {\n            return true;\n        }\n    }\n\n    return false;\n}\n\n//\u65b0\u589e\u8cc7\u6599\u5230tad_discuss\u4e2d\nfunction insert_tad_discuss($nl2br = false)\n{\n    global $xoopsDB, $xoopsUser, $TadUpFiles;\n\n    //\u53d6\u5f97\u4f7f\u7528\u8005\u7de8\u865f\n    //if(!$xoopsUser)return;\n\n    $memberHandler = xoops_getHandler('member');\n\n    $uid = ($xoopsUser) ? $xoopsUser->uid() : (int) $_POST['uid'];\n\n    $myts = \\MyTextSanitizer::getInstance();\n    //$_POST['DiscussContent']=$myts->addSlashes($_POST['DiscussContent']);\n\n    if (empty($_SERVER['HTTP_X_FORWARDED_FOR'])) {\n        $myip = $_SERVER['REMOTE_ADDR'];\n    } else {\n        $myip = explode(',', $_SERVER['HTTP_X_FORWARDED_FOR']);\n        $myip = $myip[0];\n    }\n\n    $ReDiscussID = isset($_POST['ReDiscussID']) ? (int) $_POST['ReDiscussID'] : 0;\n    //$now=date('Y-m-d H:i:s',xoops_getUserTimestamp(time()));\n    $Discuss = get_tad_discuss($ReDiscussID);\n    $DiscussTitle = empty($_POST['DiscussTitle']) ? 'RE:' . $Discuss['DiscussTitle'] : $myts->addSlashes($_POST['DiscussTitle']);\n    $DiscussTitle = $myts->addSlashes($DiscussTitle);\n    $publisher = $myts->addSlashes($_POST['publisher']);\n    $BoardID = (int) $_POST['BoardID'];\n\n    $DiscussContent = $myts->addSlashes($_POST['DiscussContent']);\n    if ($nl2br) {\n        $DiscussContent = nl2br($DiscussContent);\n    }\n\n    if (chk_spam($DiscussTitle)) {\n        redirect_header($_SERVER['PHP_SELF'], 3, _MD_TADDISCUS_FOUND_SPAM);\n    }\n\n    if (chk_spam($DiscussContent)) {\n        redirect_header($_SERVER['PHP_SELF'], 3, _MD_TADDISCUS_FOUND_SPAM);\n    }\n\n    $onlyTo = '';\n    if ('1' == $_POST['only_root'] and !empty($ReDiscussID)) {\n        $onlyTo = $Discuss['uid'];\n    } elseif ('1' == $_POST['only_root']) {\n        $adminusers = $memberHandler->getUsersByGroup(1);\n        $onlyTo = implode(',', $adminusers);\n    }\n\n    $time = date('Y-m-d H:i:s');\n    $sql = 'insert into ' . $xoopsDB->prefix('tad_discuss') . \"   (`ReDiscussID` , `uid` , `publisher` , `DiscussTitle` , `DiscussContent` , `DiscussDate` , `BoardID` , `LastTime` , `Counter` , `FromIP` , `onlyTo`)\n  values('{$ReDiscussID}' , '{$uid}' , '{$publisher}' , '{$DiscussTitle}' , '{$DiscussContent}' , '{$time}', '{$BoardID}' , '{$time}' , '0', '$myip' , '{$onlyTo}')\";\n    $xoopsDB->query($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n\n    //\u53d6\u5f97\u6700\u5f8c\u65b0\u589e\u8cc7\u6599\u7684\u6d41\u6c34\u7de8\u865f\n    $DiscussID = $xoopsDB->getInsertId();\n\n    if ($xoopsUser) {\n        $xoopsUser->incrementPost();\n    }\n\n    $TadUpFiles->set_col('DiscussID', $DiscussID);\n    //$TadUpFiles->upload_file($upname,$width,$thumb_width,$files_sn,$desc,$safe_name=false,$hash=false);\n    $TadUpFiles->upload_file('upfile', 1024, 120, null, '', true);\n\n    $ToDiscussID = $DiscussID;\n    if (!empty($ReDiscussID)) {\n        $sql = 'update ' . $xoopsDB->prefix('tad_discuss') . \" set `LastTime` = '{$time}'\n    where `DiscussID` = '{$ReDiscussID}' or `ReDiscussID` = '{$ReDiscussID}'\";\n        $xoopsDB->queryF($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n        $ToDiscussID = $ReDiscussID;\n    }\n\n    //\u5168\u5c40\n    $extra_tags['DISCUSS_TITLE'] = $myts->htmlSpecialChars($_POST['DiscussTitle']);\n    $extra_tags['DISCUSS_CONTENT'] = strip_tags($_POST['DiscussContent']);\n    $extra_tags['DISCUSS_URL'] = XOOPS_URL . \"/modules/tad_discuss/discuss.php?DiscussID={$ToDiscussID}&BoardID={$_POST['BoardID']}\";\n\n    $notificationHandler = xoops_getHandler('notification');\n    $notificationHandler->triggerEvent('global', 0, 'new_discuss', $extra_tags, null, null, 0);\n\n    //\u5206\u985e\n    if (!empty($_POST['BoardID'])) {\n        $Board = get_tad_discuss_board($_POST['BoardID']);\n        $extra_tags['BOARD_TITLE'] = $myts->htmlSpecialChars($Board['BoardTitle']);\n        $notificationHandler = xoops_getHandler('notification');\n        $notificationHandler->triggerEvent('board', $_POST['BoardID'], 'new_board_discuss', $extra_tags, null, null, 0);\n    }\n\n    if (!empty($ReDiscussID)) {\n        return $ReDiscussID;\n    }\n\n    return $DiscussID;\n}\n", "<?php\nuse XoopsModules\\Tadtools\\FooTable;\nuse XoopsModules\\Tadtools\\TadUpFiles;\nuse XoopsModules\\Tadtools\\Utility;\n/*-----------\u5f15\u5165\u6a94\u6848\u5340--------------*/\nrequire __DIR__ . '/header.php';\n$xoopsOption['template_main'] = 'tad_discuss_index.tpl';\nrequire_once XOOPS_ROOT_PATH . '/header.php';\n$TadUpFiles = new TadUpFiles('tad_discuss');\n/*-----------function\u5340--------------*/\n\n//\u5217\u51fa\u6240\u6709tad_discuss_board\u8cc7\u6599\nfunction list_tad_discuss_board($ofBoardID = 0, $mode = 'tpl')\n{\n    global $xoopsDB, $xoopsModule, $isAdmin, $xoopsUser, $xoopsTpl, $TadUpFiles, $xoopsModuleConfig;\n\n    //\u53d6\u5f97\u672c\u6a21\u7d44\u7de8\u865f\n    $module_id = $xoopsModule->mid();\n\n    //\u53d6\u5f97\u76ee\u524d\u4f7f\u7528\u8005\u7684\u7fa4\u7d44\u7de8\u865f\n    if ($xoopsUser) {\n        $uid = $xoopsUser->uid();\n        $groups = $xoopsUser->getGroups();\n    } else {\n        $uid = 0;\n        $groups = XOOPS_GROUP_ANONYMOUS;\n    }\n    $gpermHandler = xoops_getHandler('groupperm');\n\n    $sql = 'select * from `' . $xoopsDB->prefix('tad_discuss_board') . \"` where BoardEnable='1' and `ofBoardID`='$ofBoardID' order by BoardSort\";\n    $result = $xoopsDB->query($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n\n    $all_content = [];\n    $i = 0;\n    while (false !== ($all = $xoopsDB->fetchArray($result))) {\n        //\u4ee5\u4e0b\u6703\u7522\u751f\u9019\u4e9b\u8b8a\u6578\uff1a $BoardID , $BoardTitle , $BoardDesc , $BoardManager , $BoardEnable\n        foreach ($all as $k => $v) {\n            $$k = $v;\n        }\n\n        if (!$gpermHandler->checkRight('forum_read', $BoardID, $groups, $module_id)) {\n            continue;\n        }\n        $post = $gpermHandler->checkRight('forum_post', $BoardID, $groups, $module_id);\n\n        //$pic=get_pic_file('BoardID' , $BoardID , 1 , 'thumb');\n        $TadUpFiles->set_col('BoardID', $BoardID);\n        $pic = $TadUpFiles->get_pic_file('thumb'); //thumb \u5c0f\u5716, images \u5927\u5716\uff08default\uff09, file \u6a94\u6848\n        $pic = empty($pic) ? 'images/board.png' : $pic;\n\n        $display_number = isset($xoopsModuleConfig['display_number']) ? (int) $xoopsModuleConfig['display_number'] : 7;\n        $list_tad_discuss = list_tad_discuss_short($BoardID, $display_number);\n\n        $fun = ($isAdmin) ? \"<a href='admin/main.php?op=tad_discuss_board_form&BoardID=$BoardID'><img src='images/edit.png' alt='\" . _TAD_EDIT . \"'></a>\" : '';\n        $BoardManager = implode(' , ', getBoardManager($BoardID, 'uname'));\n\n        $BoardNum = get_board_num($BoardID);\n        $DiscussNum = get_board_num($BoardID, false);\n\n        $all_content[$i]['post'] = $post;\n        $all_content[$i]['pic'] = $pic;\n        $all_content[$i]['BoardTitle'] = $BoardTitle;\n        $all_content[$i]['BoardID'] = $BoardID;\n        $all_content[$i]['ofBoardID'] = $ofBoardID;\n        $all_content[$i]['fun'] = $fun;\n        $all_content[$i]['BoardNum'] = sprintf(_MD_TADDISCUS_BOARD_DISCUSS, number_format($BoardNum));\n        $all_content[$i]['DiscussNum'] = sprintf(_MD_TADDISCUS_ALL_DISCUSS, number_format($DiscussNum));\n        $all_content[$i]['list_tad_discuss'] = $list_tad_discuss;\n        $all_content[$i]['BoardManager'] = $BoardManager;\n        $all_content[$i]['subBoard'] = list_tad_discuss_board($BoardID, 'return');\n\n        $i++;\n    }\n\n    if ('return' === $mode) {\n        return $all_content;\n    }\n\n    $FooTable = new FooTable();\n    $FooTableJS = $FooTable->render();\n\n    $xoopsTpl->assign('FooTableJS', $FooTableJS);\n    $xoopsTpl->assign('all_content', $all_content);\n\n    if ($xoopsUser) {\n        $xoopsTpl->assign('login', true);\n    } else {\n        $xoopsTpl->assign('login', false);\n    }\n}\n\n//\u5217\u51fa\u6240\u6709tad_discuss\u8cc7\u6599\nfunction list_tad_discuss_short($BoardID = null, $limit = null)\n{\n    global $xoopsDB, $xoopsModule, $xoopsUser, $xoopsTpl;\n\n    $myts = \\MyTextSanitizer::getInstance();\n\n    $andBoardID = (empty($BoardID)) ? '' : \"and a.BoardID='$BoardID'\";\n    $andLimit = null !== $limit ? \"limit 0,$limit\" : '';\n    $sql = 'select a.*,b.* from ' . $xoopsDB->prefix('tad_discuss') . ' as a left join ' . $xoopsDB->prefix('tad_discuss_board') . \" as b on a.BoardID = b.BoardID where a.ReDiscussID='0' $andBoardID  order by a.LastTime desc $andLimit\";\n\n    $result = $xoopsDB->query($sql) or Utility::web_error($sql, __FILE__, __LINE__);\n\n    $main_data = [];\n    $i = 0;\n    while (false !== ($all = $xoopsDB->fetchArray($result))) {\n        //\u4ee5\u4e0b\u6703\u7522\u751f\u9019\u4e9b\u8b8a\u6578\uff1a $DiscussID , $ReDiscussID , $uid , $DiscussTitle , $DiscussContent , $DiscussDate , $BoardID , $LastTime , $Counter\n        foreach ($all as $k => $v) {\n            $$k = $v;\n        }\n\n        $renum = get_re_num($DiscussID);\n        //$show_re_num=empty($renum)?\"\":sprintf(_MD_TADDISCUS_RE_DISCUSS,$renum);\n\n        $uid_name = \\XoopsUser::getUnameFromId($uid, 1);\n        $LastTime = mb_substr($LastTime, 0, 10);\n\n        $isPublic = isPublic($onlyTo, $uid, $BoardID);\n        $onlyToName = getOnlyToName($onlyTo);\n        $DiscussTitle = $isPublic ? $myts->htmlSpecialChars($DiscussTitle) : sprintf(_MD_TADDISCUS_ONLYTO, $onlyToName);\n\n        $DiscussTitle = str_replace('[s', \"<img src='\" . XOOPS_URL . '/modules/tad_discuss/images/smiles/s', $DiscussTitle);\n        $DiscussTitle = str_replace('.gif]', \".gif' hspace=2 align='absmiddle'>\", $DiscussTitle);\n\n        $main_data[$i]['LastTime'] = $LastTime;\n        $main_data[$i]['DiscussID'] = $DiscussID;\n        $main_data[$i]['BoardID'] = $BoardID;\n        $main_data[$i]['DiscussTitle'] = $DiscussTitle;\n        $main_data[$i]['uid_name'] = $uid_name;\n        $main_data[$i]['renum'] = $renum;\n\n        $i++;\n    }\n\n    return $main_data;\n}\n\n/*-----------\u57f7\u884c\u52d5\u4f5c\u5224\u65b7\u5340----------*/\nrequire_once $GLOBALS['xoops']->path('/modules/system/include/functions.php');\n$op = system_CleanVars($_REQUEST, 'op', '', 'string');\n$BoardID = system_CleanVars($_REQUEST, 'BoardID', 0, 'int');\n$DiscussID = system_CleanVars($_REQUEST, 'DiscussID', 0, 'int');\n$files_sn = system_CleanVars($_REQUEST, 'files_sn', 0, 'int');\n\n$xoopsTpl->assign('toolbar', Utility::toolbar_bootstrap($interface_menu));\n$xoopsTpl->assign('jquery', Utility::get_jquery(true));\n\nswitch ($op) {\n    default:\n        list_tad_discuss_board(0);\n        break;\n}\n\n/*-----------\u79c0\u51fa\u7d50\u679c\u5340--------------*/\nrequire_once XOOPS_ROOT_PATH . '/footer.php';\n"], "filenames": ["discuss.php", "function.php", "index.php"], "buggy_code_start_loc": [376, 207, 96], "buggy_code_end_loc": [376, 597, 120], "fixing_code_start_loc": [377, 208, 97], "fixing_code_end_loc": [378, 599, 122], "type": "CWE-79", "message": "A vulnerability classified as problematic was found in tad_discuss. Affected by this vulnerability is an unknown functionality. The manipulation of the argument DiscussTitle leads to cross site scripting. The attack can be launched remotely. The name of the patch is af94d034ff8db642d05fd8788179eab05f433958. It is recommended to apply a patch to fix this issue. The identifier VDB-216469 was assigned to this vulnerability.", "other": {"cve": {"id": "CVE-2021-4267", "sourceIdentifier": "cna@vuldb.com", "published": "2022-12-21T19:15:13.143", "lastModified": "2022-12-27T22:48:43.663", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "A vulnerability classified as problematic was found in tad_discuss. Affected by this vulnerability is an unknown functionality. The manipulation of the argument DiscussTitle leads to cross site scripting. The attack can be launched remotely. The name of the patch is af94d034ff8db642d05fd8788179eab05f433958. It is recommended to apply a patch to fix this issue. The identifier VDB-216469 was assigned to this vulnerability."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}, {"source": "cna@vuldb.com", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:U/C:N/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "UNCHANGED", "confidentialityImpact": "NONE", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 3.5, "baseSeverity": "LOW"}, "exploitabilityScore": 2.1, "impactScore": 1.4}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}, {"source": "cna@vuldb.com", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-707"}, {"lang": "en", "value": "CWE-74"}, {"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:tad_discuss_project:tad_discuss:*:*:*:*:*:*:*:*", "versionEndExcluding": "2021-03-23", "matchCriteriaId": "2E2ADB04-5EDC-40AD-A1B5-48FBB16C1A12"}]}]}], "references": [{"url": "https://github.com/tad0616/tad_discuss/commit/af94d034ff8db642d05fd8788179eab05f433958", "source": "cna@vuldb.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/tad0616/tad_discuss/pull/19", "source": "cna@vuldb.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://vuldb.com/?id.216469", "source": "cna@vuldb.com", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/tad0616/tad_discuss/commit/af94d034ff8db642d05fd8788179eab05f433958"}}