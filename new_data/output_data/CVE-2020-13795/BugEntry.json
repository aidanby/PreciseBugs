{"buggy_code": ["<?php\r\nrequire_once(NAVIGATE_PATH.'/lib/packages/webdictionary/webdictionary.class.php');\r\nrequire_once(NAVIGATE_PATH.'/lib/packages/themes/theme.class.php');\r\n\r\nclass template\r\n{\r\n\tpublic $id;\r\n\tpublic $title;\r\n\tpublic $file;\r\n\tpublic $sections;\r\n\tpublic $gallery;\r\n\tpublic $comments;\r\n\tpublic $tags;\r\n\tpublic $statistics;\r\n\tpublic $permission; // 0 => public, 1 => private (only navigate cms users), 2 => hidden\r\n\tpublic $enabled;\r\n\t\r\n\tpublic function load($id)\r\n\t{\r\n\t\tglobal $DB;\r\n\t\tglobal $website;\r\n\t\tglobal $theme;\r\n\t\t\r\n\t\tif(is_numeric($id))\r\n\t\t{\t\t\r\n\t\t\tif($DB->query('SELECT * FROM nv_templates WHERE id = '.intval($id).' AND website = '.$website->id))\r\n\t\t\t{\r\n\t\t\t\t$data = $DB->result();\r\n\t\t\t\t$this->load_from_resultset($data); // there will be as many entries as languages enabled\r\n\t\t\t}\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tif(empty($theme))\r\n\t\t\t{\r\n\t\t\t\t$theme = new theme();\r\n\t\t\t\t$theme->load($website->theme);\r\n\t\t\t}\r\n\r\n\t\t\t$this->load_from_theme($id);\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic function load_from_resultset($rs)\r\n\t{\r\n\t\t$main = $rs[0];\r\n\t\t\r\n\t\t$this->id\t\t\t= $main->id;\r\n\t\t$this->website\t\t= $main->website;\t\t\r\n\t\t$this->title  \t\t= $main->title;\r\n\t\t$this->file\t\t\t= $main->file;\r\n\t\t$this->sections\t\t= mb_unserialize($main->sections);\r\n\t\t$this->gallery\t\t= $main->gallery;\r\n\t\t$this->comments\t\t= $main->comments;\t\t\r\n\t\t$this->tags\t\t\t= $main->tags;\t\t\r\n\t\t$this->statistics\t= $main->statistics;\t\t\t\t\t\t\r\n\t\t$this->permission\t= $main->permission;\t\t\r\n\t\t$this->enabled\t\t= $main->enabled;\t\t\t\t\t\t\r\n\t}\r\n\t\r\n\tpublic function load_from_theme($id, $theme_name=null)\r\n\t{\r\n\t\tglobal $theme;\r\n\t\tglobal $website;\r\n\r\n\t\t$ws_theme = $theme;\r\n\t\tif(empty($ws_theme) && !empty($theme_name))\r\n\t\t{\r\n\t\t\t$ws_theme = new theme();\r\n\t\t\t$ws_theme->load($theme_name);\r\n\t\t}\r\n\r\n\t\t$template = NULL;\r\n\t\tfor($t=0; $t < count($ws_theme->templates); $t++)\r\n\t\t{\r\n\t\t\tif($ws_theme->templates[$t]->type == $id)\r\n\t\t\t\t$template = $ws_theme->templates[$t];\r\n\t\t}\r\n\r\n\t\tif(!$template) return;\r\n\r\n        $defaults = array(\r\n            'sections' => array(\r\n                0 => array(\r\n                    'id' => 'main',\r\n                    'name' => '#main#',\r\n                    'editor' => 'tinymce',\r\n                    'width' => '960'\r\n                )\r\n            ),\r\n            'gallery'  => 0,\r\n            'comments' => 0,\r\n            'tags' => 0,\r\n            'statistics' => 1,\r\n            'permission' => 0,\r\n            'enabled' => 1,\r\n            'properties' => array()\r\n        );\r\n\r\n\t\t$this->id\t\t\t= $template->type;\r\n\t\t$this->website\t\t= $website->id;\r\n\t\t$this->title  \t\t= $ws_theme->template_title($template->type);\r\n\t\t$this->file\t\t\t= NAVIGATE_PATH.'/themes/'.$ws_theme->name.'/'.$template->file;\r\n\t\t$this->sections\t\t= (isset($template->sections)? json_decode(json_encode($template->sections), true) : $defaults['sections']);\r\n\t\t$this->gallery\t\t= (isset($template->gallery)? $template->gallery : $defaults['gallery']);\r\n\t\t$this->comments\t\t= (isset($template->comments)? $template->comments : $defaults['comments']);\r\n\t\t$this->tags\t\t\t= (isset($template->tags)? $template->tags : $defaults['tags']);\r\n\t\t$this->statistics\t= (isset($template->statistics)? $template->statistics : $defaults['statistics']);\r\n\t\t$this->permission\t= (isset($template->permission)? $template->permission : $defaults['permission']);\r\n\t\t$this->enabled\t\t= (isset($template->enabled)? $template->enabled : $defaults['enabled']);\r\n        $this->properties   = (isset($template->properties)? (array)$template->properties : $defaults['properties']);\r\n\r\n        // process properties (translate titles, etc.)\r\n        for($p=0; $p < count($this->properties); $p++)\r\n        {\r\n            if($this->properties[$p]->type == 'option')\r\n            {\r\n                $poptions = array();\r\n                foreach($this->properties[$p]->options as $key => $value)\r\n                    $poptions[$key] = $ws_theme->t($value);\r\n\r\n                $this->properties[$p]->options = $poptions;\r\n            }\r\n        }\r\n\t}\r\n\t\r\n\tpublic function load_from_post()\r\n\t{\r\n\t\t$this->title  \t\t= $_REQUEST['title'];\r\n\t\t$this->file\t\t\t= $_REQUEST['file'];\r\n\t\t$this->permission\t= intval($_REQUEST['permission']);\r\n\t\t$this->enabled\t\t= intval($_REQUEST['enabled']);\t\r\n\t\t\r\n\t\t// sections\r\n\t\t$this->sections\t\t= array();\r\n\t\tfor($s = 0; $s < count($_REQUEST['template-sections-code']); $s++)\r\n\t\t{\r\n\t\t\tif(empty($_REQUEST['template-sections-code'][$s])) continue;\r\n\t\t\t$this->sections[] = array(\r\n\t\t\t    'code' => $_REQUEST['template-sections-code'][$s],\r\n\t\t\t\t'name' => $_REQUEST['template-sections-name'][$s],\r\n\t\t\t\t'editor' => $_REQUEST['template-sections-editor'][$s],\r\n\t\t\t\t'width' => $_REQUEST['template-sections-width'][$s]\r\n            );\r\n\t\t}\r\n\t\tif(empty($this->sections))\r\n\t\t{\r\n\t\t\t$this->sections = array(\r\n\t\t\t\t0 => array(\r\n\t\t\t\t\t'code' => 'id',\r\n\t\t\t\t\t'name' => '#main#',\r\n\t\t\t\t\t'editor' => 'tinymce',\r\n\t\t\t\t\t'width' => '960'\r\n\t\t\t\t)\r\n\t\t\t);\r\n\t\t}\r\n\t\t\r\n\t\t$this->gallery\t\t= intval($_REQUEST['gallery']);\t\r\n\t\t$this->comments\t\t= intval($_REQUEST['comments']);\t\r\n\t\t$this->tags\t\t\t= intval($_REQUEST['tags']);\t\r\n\t\t$this->statistics\t= intval($_REQUEST['statistics']);\t\t\t\t\t\t\t\t\r\n\t}\r\n\t\r\n\t\r\n\tpublic function save()\r\n\t{\r\n\t\tif(!empty($this->id))\r\n\t\t\treturn $this->update();\r\n\t\telse\r\n\t\t\treturn $this->insert();\t\t\t\r\n\t}\r\n\t\r\n\tpublic function delete()\r\n\t{\r\n\t\tglobal $DB;\r\n\t\tglobal $website;\r\n\r\n\t\t// remove all old entries\r\n\t\tif(!empty($this->id))\r\n\t\t{\r\n            // remove associated properties values and definitions\r\n            $DB->execute(\"\r\n                DELETE FROM nv_properties_items\r\n                 WHERE property_id IN (\r\n                            SELECT id FROM nv_properties\r\n                            WHERE template = \".intval($this->id).\"\r\n                            AND website = \".$website->id.\"\r\n                       )\r\n                   AND website = \".$website->id\r\n            );\r\n\r\n            $DB->execute(\"\r\n                DELETE FROM nv_properties\r\n                 WHERE template = \".intval($this->id).\"\r\n                   AND website = \".$website->id\r\n            );\r\n\r\n\t\t\t$DB->execute(\"\r\n\t\t\t    DELETE FROM nv_templates\r\n                 WHERE id = \".intval($this->id).\"\r\n                   AND website = \".$website->id\r\n            );\r\n\t\t}\r\n\t\t\r\n\t\treturn $DB->get_affected_rows();\t\t\r\n\t}\r\n\t\r\n\tpublic function insert()\r\n\t{\r\n\t\tglobal $DB;\r\n\t\tglobal $website;\r\n\t\t\r\n\t\t$ok = $DB->execute(' \r\n \t\t\tINSERT INTO nv_templates\r\n\t\t\t\t(id, website, title, file, sections, gallery, comments, tags, statistics, permission, enabled)\r\n\t\t\tVALUES \r\n\t\t\t\t( 0, :website, :title, :file, :sections, :gallery, :comments, :tags, :statistics, :permission, :enabled )',\r\n\t\t\tarray(\r\n\t\t\t\t':website' => value_or_default($this->website, $website->id),\r\n\t\t\t\t':title' => value_or_default($this->title, \"\"),\r\n\t\t\t\t':file' => value_or_default($this->file, \"\"),\r\n\t\t\t\t':sections' => serialize($this->sections),\r\n\t\t\t\t':gallery' => value_or_default($this->gallery, 0),\r\n\t\t\t\t':comments' => value_or_default($this->comments, 0),\r\n\t\t\t\t':tags' => value_or_default($this->tags, 0),\r\n\t\t\t\t':statistics' => value_or_default($this->statistics, 0),\r\n\t\t\t\t':permission' => value_or_default($this->permission, 0),\r\n\t\t\t\t':enabled' => value_or_default($this->enabled, 0)\r\n\t\t\t)\r\n\t\t);\r\n\t\t\t\r\n\t\tif(!$ok)\r\n\t\t\tthrow new Exception($DB->get_last_error());\r\n\t\t\r\n\t\t$this->id = $DB->get_last_id();\r\n\t\t\r\n\t\treturn true;\r\n\t}\r\n\t\r\n\tpublic function update()\r\n\t{\r\n\t\tglobal $DB;\r\n\t\tglobal $website;\r\n\t\t\t\r\n\t\t$ok = $DB->execute(' \r\n \t\t\tUPDATE nv_templates\r\n\t\t\t   SET  title = :title, file = :file, sections = :sections, gallery = :gallery,\r\n\t\t\t    \tcomments = :comments, tags = :tags, statistics = :statistics, \r\n\t\t\t    \tpermission = :permission, enabled = :enabled \r\n\t\t\t WHERE id = :id\r\n\t\t\t   AND website = :website',\r\n\t\t\tarray(\r\n\t\t\t\t':id' => $this->id,\r\n\t\t\t\t':website' => value_or_default($this->website, $website->id),\r\n\t\t\t\t':title' => value_or_default($this->title, \"\"),\r\n\t\t\t\t':file' => value_or_default($this->file, \"\"),\r\n\t\t\t\t':sections' => serialize($this->sections),\r\n\t\t\t\t':gallery' => value_or_default($this->gallery, 0),\r\n\t\t\t\t':comments' => value_or_default($this->comments, 0),\r\n\t\t\t\t':tags' => value_or_default($this->tags, 0),\r\n\t\t\t\t':statistics' => value_or_default($this->statistics, 0),\r\n\t\t\t\t':permission' => value_or_default($this->permission, 0),\r\n\t\t\t\t':enabled' => value_or_default($this->enabled, 0)\r\n\t\t\t)\r\n\t\t);\r\n\t\t\r\n\t\tif(!$ok) throw new Exception($DB->get_last_error());\r\n\t\t\r\n\t\treturn true;\r\n\t}\t\t\r\n\t\r\n\tpublic static function elements($uses=\"\")\r\n\t{\r\n\t\tglobal $DB;\r\n\t\tglobal $website;\r\n\t\t\r\n\t\t$data = array();\r\n\t\t\r\n\t\t// get available theme templates\r\n\t\tif(!empty($website->theme) && empty($theme))\r\n\t\t{\t\t\r\n\t\t\t$theme = new theme();\r\n\t\t\t$theme->load($website->theme);\r\n\t\t\t$out = $theme->templates();\r\n\t\t}\r\n\t\t\t\t\r\n\t\t// merge theme templates with custom templates\r\n\t\tif(is_array($out))\r\n\t\t\t$data = array_merge($data, $out);\r\n\t\t\r\n\t\tif($DB->query('\r\n\t\t    SELECT id, title\r\n\t\t\t  FROM nv_templates\r\n\t\t\t WHERE website = '.$website->id.'\r\n\t\t  ORDER BY title'))\r\n\t\t{\r\n\t\t\t$out = $DB->result();\r\n\t\t}\r\n\r\n\t\tif(is_array($out))\r\n\t\t\t$data = array_merge($data, $out);\r\n\r\n        // clean templates not for the given use\r\n        // for example, don't display \"blog_entry\" template in the \"structure\" template selector\r\n        if(!empty($uses))\r\n        {\r\n            $uses = explode(',', $uses);\r\n            for($t=0; $t < count($data); $t++)\r\n            {\r\n                if(isset($data[$t]->uses) && !empty($data[$t]->uses))\r\n                {\r\n                    $template_uses = explode(',', $data[$t]->uses);\r\n                    $matches = array_intersect($template_uses, $uses);\r\n                    if(empty($matches))\r\n                        $data[$t] = null;\r\n                }\r\n            }\r\n        }\r\n\r\n        $data = array_filter($data);\r\n\r\n\t\treturn $data;\r\n\t}\r\n\r\n\tpublic static function section_name($default)\r\n\t{\r\n\t\tglobal $website;\r\n\t\tglobal $theme;\r\n\t\t\r\n\t\t$out = $default;\r\n\t\t\t\r\n\t\tif(!empty($website->theme))\r\n\t\t{\r\n\t\t\tif(empty($theme))\r\n\t\t\t{\r\n\t\t\t\t$theme = new theme();\r\n\t\t\t\t$theme->load($website->theme);\t\t\t\r\n\t\t\t}\r\n\t\t\t\t\r\n\t\t\t$out = $theme->template_title($default, false);\r\n\t\t}\r\n\t\t\t\r\n\t\tswitch($default)\r\n\t\t{\r\n\t\t\tcase '#main#':\r\n            case 'main':\r\n                if(isset($theme))\r\n                    $out = $theme->t(\"main\");\r\n                if(empty($out) || $out == 'main')\r\n\t\t\t\t    $out = t(238, 'Main content');\r\n\t\t\t\tbreak;\r\n\t\t\t\t\r\n\t\t\tdefault:\t\r\n\t\t}\r\n\t\t\r\n\t\treturn $out;\r\n\t}\r\n\r\n    public static function search($orderby=\"\", $filters=false)\r\n    {\r\n        global $DB;\r\n        global $website;\r\n        global $theme;\r\n\r\n        // retrieve custom templates\r\n        $DB->queryLimit('id,title,NULL as theme,permission,enabled',\r\n                        'nv_templates',\r\n                        'website = '.$website->id,\r\n                        $orderby,\r\n                        0,\r\n                        PHP_INT_MAX);\r\n\r\n        $dataset = $DB->result();\r\n\r\n        // retrieve theme templates\r\n        for($t=0; $t < count($theme->templates); $t++)\r\n        {\r\n            $template = new template();\r\n            $template->load_from_theme($theme->templates[$t]->type);\r\n\r\n            $dataset[] = array(\r\n                'id'            =>  $template->id,\r\n                'title'         =>  $template->title,\r\n                'theme'         =>  $theme->title,\r\n                'permission'    =>  $template->permission,\r\n                'enabled'       =>  $template->enabled\r\n            );\r\n\r\n            unset($template);\r\n        }\r\n\r\n        // filter results\r\n        if(!empty($filters))\r\n        {\r\n            if(!empty($filters['quicksearch']))\r\n            {\r\n                $dataset = array_filter_quicksearch($dataset, $filters['quicksearch']);\r\n            }\r\n        }\r\n\r\n        // reorder results\r\n        // SQL format: column direction (only ONE column allowed)\r\n        // example: id desc\r\n        $column = array();\r\n        list($order_column, $order_direction) = explode(' ', $orderby);\r\n        for($d=0; $d < count($dataset); $d++)\r\n            $column[] = $dataset[$d][$order_column];\r\n\r\n        array_multisort($column, ($order_direction=='desc'? SORT_DESC : SORT_ASC), $dataset);\r\n\r\n        return $dataset;\r\n    }\r\n\r\n    public function backup($type='json')\r\n    {\r\n        global $DB;\r\n        global $website;\r\n\r\n        $out = array();\r\n\r\n        $DB->query('SELECT * FROM nv_templates WHERE website = '.intval($website->id), 'object');\r\n\r\n        if($type='json')\r\n            $out = json_encode($DB->result());\r\n\r\n        return $out;\r\n    }\r\n}\r\n\r\n?>", "<?php\r\nrequire_once(NAVIGATE_PATH.'/lib/packages/themes/theme.class.php');\r\nrequire_once(NAVIGATE_PATH.'/lib/packages/templates/template.class.php');\r\nrequire_once(NAVIGATE_PATH.'/lib/packages/properties/property.class.php');\r\n\r\nfunction run()\r\n{\r\n\tglobal $user;\t\r\n\tglobal $layout;\r\n\tglobal $DB;\r\n\tglobal $website;\r\n\t\r\n\t$out = '';\r\n\t$item = new template();\r\n\t\t\t\r\n\tswitch($_REQUEST['act'])\r\n\t{\r\n        case 'json':\r\n\t\tcase 1:\t// json data retrieval & operations\r\n\t\t\tswitch($_REQUEST['oper'])\r\n\t\t\t{\r\n\t\t\t\tcase 'del':\t// remove rows\r\n\t\t\t\t\t$ids = $_REQUEST['ids'];\r\n\t\t\t\t\tforeach($ids as $id)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t$item->load($id);\r\n\t\t\t\t\t\t$item->delete();\r\n\t\t\t\t\t}\r\n\t\t\t\t\techo json_encode(true);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t\t\r\n\t\t\t\tdefault: // list or search\r\n\r\n                    // we have to merge the theme templates with the custom private templates (which are defined in the DB)\r\n                    // as we don't expect a lot of templates, we will always return the whole dataset\r\n                    // for this reason, paginate is useless\r\n\r\n                    // filter orderby vars\r\n                    if( !in_array($_REQUEST['sord'], array('', 'desc', 'DESC', 'asc', 'ASC')) ||\r\n                        !in_array($_REQUEST['sidx'], array('id', 'title', 'enabled', 'permission'))\r\n                    )\r\n                    {\r\n                        return false;\r\n                    }\r\n                    $orderby = $_REQUEST['sidx'].' '.$_REQUEST['sord'];\r\n\r\n\t\t\t\t\tif(isset($_REQUEST['quicksearch']))\r\n                    {\r\n                        $dataset = template::search($orderby, array('quicksearch' => $_REQUEST['quicksearch']));\r\n                    }\r\n\t                else\r\n                    {\r\n                        $dataset = template::search($orderby);\r\n                    }\r\n\r\n\t\t\t\t\t$total = count($dataset);\r\n\t\t\t\t\t\r\n\t\t\t\t\t$out = array();\t\t\r\n\t\t\t\t\t$permissions = array(\t\r\n\t\t\t\t\t\t\t0 => '<img src=\"img/icons/silk/world.png\" align=\"absmiddle\" /> '.t(69, 'Published'),\r\n\t\t\t\t\t\t\t1 => '<img src=\"img/icons/silk/world_dawn.png\" align=\"absmiddle\" /> '.t(70, 'Private'),\r\n\t\t\t\t\t\t\t2 => '<img src=\"img/icons/silk/world_night.png\" align=\"absmiddle\" /> '.t(81, 'Hidden')\r\n\t\t\t\t\t\t);\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tif(empty($dataset)) $rows = 0;\r\n\t\t\t\t\telse\t\t\t\t$rows = count($dataset);\r\n\t\r\n\t\t\t\t\tfor($i=0; $i < $rows; $i++)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t$out[$i] = array(\r\n\t\t\t\t\t\t\t0\t=> $dataset[$i]['id'],\r\n\t\t\t\t\t\t\t1 \t=> $dataset[$i]['title'],\r\n\t\t\t\t\t\t\t2 \t=> $dataset[$i]['theme'],\r\n\t\t\t\t\t\t\t3\t=> $permissions[$dataset[$i]['permission']],\r\n\t\t\t\t\t\t\t4\t=> (($dataset[$i]['enabled']==1)? '<img src=\"img/icons/silk/accept.png\" />' : '<img src=\"img/icons/silk/cancel.png\" />')\r\n\t\t\t\t\t\t);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tnavitable::jqgridJson($out, 1, 0, PHP_INT_MAX, $total);\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tcore_terminate();\r\n\t\t\tbreak;\r\n\t\t\t\t\r\n\t\tcase 'load':\r\n\t\tcase 2: // edit/new form\t\t\r\n\t\t\tif(!empty($_REQUEST['id']))\r\n\t\t\t{\r\n                if(is_numeric($_REQUEST['id']))\r\n                {\r\n                    $item->load(intval($_REQUEST['id']));\r\n                }\r\n                else\r\n                {\r\n                    $item->load_from_theme($_REQUEST['id']);\r\n                }\r\n\t\t\t}\r\n\t\t\r\n\t\t\tif(isset($_REQUEST['form-sent']))\r\n\t\t\t{\r\n\t\t\t\t$item->load_from_post();\r\n\t\t\t\ttry\r\n\t\t\t\t{\r\n\t\t\t\t\t$item->save();\r\n\t\t\t\t\tif(!empty($_REQUEST['property-enabled']))\r\n\t\t\t\t\t\t$enableds = array_values($_REQUEST['property-enabled']);\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\t$enableds = array();\r\n\t\t\t\t\tproperty::reorder(\"template\", $item->id, $_REQUEST['template-properties-order'], $enableds);\r\n                    $layout->navigate_notification(t(53, \"Data saved successfully.\"), false, false, 'fa fa-check');\r\n\t\t\t\t}\r\n\t\t\t\tcatch(Exception $e)\r\n\t\t\t\t{\r\n\t\t\t\t\t$layout->navigate_notification($e->getMessage(), true, true);\t\r\n\t\t\t\t}\r\n\t\t\t\tusers_log::action($_REQUEST['fid'], $item->id, 'save', $item->title, json_encode($_REQUEST));\t\t\t\t\r\n\t\t\t}\r\n\t\t\telse\r\n            {\r\n                users_log::action($_REQUEST['fid'], $item->id, 'load', $item->title);\r\n            }\r\n\t\t\r\n\t\t\t$out = templates_form($item);\r\n\t\t\tbreak;\r\n\t\t\r\n\t\tcase 'save_template_file':\t// save template html\r\n\t\t\tif(!empty($_REQUEST['id']))\r\n\t\t\t{\r\n\t\t\t\t$item->load(intval($_REQUEST['id']));\t\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t$data = $_REQUEST['templates-file-edit-area'];\r\n\t\t\t\r\n\t\t\t$data = str_replace(\"\\r\\n\", \"\\r\", $data);\r\n\t\t\t\r\n\t\t\t$x = file_put_contents(NAVIGATE_PRIVATE.'/'.$website->id.'/templates/'.$item->file, $data);\r\n\t\t\t\t\t\t\r\n\t\t\techo json_encode(($x > 0));\r\n\t\t\t\r\n\t\t\tsession_write_close();\r\n\t\t\texit;\r\n\t\t\r\n\t\t\tbreak;\t\r\n\t\t\t\r\n\t\tcase 4: // remove \r\n\t\t\tif(!empty($_REQUEST['id']))\r\n\t\t\t{\r\n\t\t\t\t$item->load(intval($_REQUEST['id']));\t\r\n\t\t\t\tif($item->delete() > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\t$layout->navigate_notification(t(55, 'Item removed successfully.'), false);\r\n\t\t\t\t\t$out = templates_list();\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$layout->navigate_notification(t(56, 'Unexpected error.'), false);\r\n\t\t\t\t\t$out = webdictionary_list();\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tusers_log::action($_REQUEST['fid'], $item->id, $item->title, 'remove');\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\t\t\t\r\n\t\tcase 'template_property_load':\r\n\t\t\r\n\t\t\t$property = new property();\r\n\t\t\t\r\n\t\t\tif(!empty($_REQUEST['id']))\r\n            {\r\n                if(is_numeric($_REQUEST['id']))\r\n\t\t\t\t    $property->load(intval($_REQUEST['id']));\r\n                else\r\n                    $property->load_from_theme($_REQUEST['id'], null, 'template', $_REQUEST['template']);\r\n            }\r\n\r\n\t\t\theader('Content-type: text/json');\r\n\r\n\t\t\t$types = property::types();\r\n\t\t\t$property->type_text = $types[$property->type];\r\n\r\n\t\t\techo json_encode($property);\r\n\t\t\t\t\t\t\r\n\t\t\tsession_write_close();\r\n\t\t\texit;\r\n\t\t\tbreak;\t\t\t\r\n\t\t\t\t\t\r\n\t\tcase 'template_property_save': // save property details\r\n\t\t\r\n\t\t\t$property = new property();\r\n\t\t\t\r\n\t\t\tif(!empty($_REQUEST['property-id']))\r\n\t\t\t\t$property->load(intval($_REQUEST['property-id']));\r\n\r\n\t\t\t$property->load_from_post();\r\n\t\t\t$property->save();\r\n\t\t\t\r\n\t\t\theader('Content-type: text/json');\r\n\r\n\t\t\t$types = property::types();\r\n\t\t\t$property->type_text = $types[$property->type];\r\n\r\n\t\t\techo json_encode($property);\t\t\t\r\n\t\t\t\r\n\t\t\tsession_write_close();\r\n\t\t\texit;\r\n\t\t\tbreak;\t\r\n\r\n\t\tcase 'template_property_remove': // remove property\r\n\t\t\r\n\t\t\t$property = new property();\r\n\t\t\t\r\n\t\t\tif(!empty($_REQUEST['property-id']))\r\n\t\t\t\t$property->load(intval($_REQUEST['property-id']));\r\n\r\n\t\t\t$property->delete();\r\n\t\t\t\r\n\t\t\tsession_write_close();\r\n\t\t\texit;\r\n\t\t\tbreak;\t\r\n\r\n\t\t\t\t\t\r\n\t\tcase 0: // list / search result\r\n\t\tdefault:\t\t\t\r\n\t\t\t$out = templates_list();\r\n\t\t\tbreak;\r\n\t}\r\n\t\r\n\treturn $out;\r\n}\r\n\r\nfunction templates_list()\r\n{\r\n\t$navibars = new navibars();\r\n\t$navitable = new navitable(\"templates_list\");\r\n\t\r\n\t$navibars->title(t(20, 'Templates'));\r\n\r\n\t$navibars->add_actions(\r\n\t    array(\r\n\t        '<a href=\"?fid='.$_REQUEST['fid'].'&act=2\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/add.png\"> '.t(38, 'Create').'</a>',\r\n\t\t\t'<a href=\"?fid='.$_REQUEST['fid'].'&act=0\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/application_view_list.png\"> '.t(39, 'List').'</a>',\r\n\t\t\t'search_form'\r\n        )\r\n    );\r\n\t\r\n\tif($_REQUEST['quicksearch']=='true')\r\n    {\r\n        $navitable->setInitialURL(\"?fid=\".$_REQUEST['fid'].'&act=json&_search=true&quicksearch='.$_REQUEST['navigate-quicksearch']);\r\n    }\r\n\t\r\n\t$navitable->setURL('?fid='.$_REQUEST['fid'].'&act=json');\r\n\t$navitable->sortBy('id');\r\n\t$navitable->setDataIndex('id');\r\n\t$navitable->setEditUrl('id', '?fid='.$_REQUEST['fid'].'&act=load&id=');\r\n    $navitable->disableSelect();\r\n\t\r\n\t$navitable->addCol(\"ID\", 'id', \"60\", \"true\", \"left\");\t\r\n\t$navitable->addCol(t(67, 'Title'), 'title', \"260\", \"true\", \"left\");\t\t\r\n\t$navitable->addCol(t(368, 'Theme'), 'theme', \"180\", \"false\", \"left\");\t\r\n\t$navitable->addCol(t(68, 'Status'), 'permission', \"80\", \"true\", \"center\");\r\n\t$navitable->addCol(t(65, 'Enabled'), 'enabled', \"60\", \"true\", \"center\");\t\t\r\n\t\r\n\t$navibars->add_content($navitable->generate());\t\r\n\t\r\n\treturn $navibars->generate();\r\n}\r\n\r\nfunction templates_form($item)\r\n{\r\n\tglobal $user;\r\n\tglobal $DB;\r\n\tglobal $website;\r\n\tglobal $layout;\r\n\t\r\n\t$navibars = new navibars();\r\n\t$naviforms = new naviforms();\r\n\t\r\n\tif(empty($item->id))\r\n\t\t$navibars->title(t(20, 'Templates').' / '.t(38, 'Create'));\t\r\n\telse\r\n\t\t$navibars->title(t(20, 'Templates').' / '.t(170, 'Edit').' ['.$item->id.']');\t\t\r\n\r\n    $readonly = false;\r\n    if(!empty($item->id) && !is_numeric($item->id))\r\n    {\r\n        $layout->navigate_notification(t(432, \"Read only mode\"), false, true);\r\n        $readonly = true;\r\n    }\r\n\telse if(empty($item->id))\r\n\t{\r\n\t\t$navibars->add_actions(\t\tarray(\t'<a href=\"#\" onclick=\"navigate_tabform_submit(1);\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/accept.png\"> '.t(34, 'Save').'</a>'\t)\r\n\t\t\t\t\t\t\t\t\t);\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$navibars->add_actions(\t\tarray(\t'<a href=\"#\" onclick=\"navigate_tabform_submit(1);\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/accept.png\"> '.t(34, 'Save').'</a>',\r\n\t\t\t\t\t\t\t\t\t\t\t'<a href=\"#\" onclick=\"navigate_delete_dialog();\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/cancel.png\"> '.t(35, 'Delete').'</a>'\r\n\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t\t\t);\t\t\r\n\t\t\r\n\t\t$delete_html = array();\r\n\t\t$delete_html[] = '<div id=\"navigate-delete-dialog\" class=\"hidden\">'.t(57, 'Do you really want to delete this item?').'</div>';\r\n\t\t$delete_html[] = '<script language=\"javascript\" type=\"text/javascript\">';\r\n\t\t$delete_html[] = 'function navigate_delete_dialog()';\t\t\r\n\t\t$delete_html[] = '{';\r\n        $delete_html[] = '$(\"#navigate-delete-dialog\").removeClass(\"hidden\");';\r\n\t\t$delete_html[] = '$(\"#navigate-delete-dialog\").dialog({\r\n\t\t\t\t\t\t\tresizable: true,\r\n\t\t\t\t\t\t\theight: 150,\r\n\t\t\t\t\t\t\twidth: 300,\r\n\t\t\t\t\t\t\tmodal: true,\r\n\t\t\t\t\t\t\ttitle: \"'.t(59, 'Confirmation').'\",\r\n\t\t\t\t\t\t\tbuttons: {\r\n\t\t\t\t\t\t\t\t\"'.t(58, 'Cancel').'\": function() {\r\n\t\t\t\t\t\t\t\t\t$(this).dialog(\"close\");\r\n\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t\"'.t(35, 'Delete').'\": function() {\r\n\t\t\t\t\t\t\t\t\t$(this).dialog(\"close\");\r\n\t\t\t\t\t\t\t\t\twindow.location.href = \"?fid='.$_REQUEST['fid'].'&act=4&id='.$item->id.'\";\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});';\t\t\r\n\t\t$delete_html[] = '}';\t\t\t\t\t\t\t\r\n\t\t$delete_html[] = '</script>';\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t$navibars->add_content(implode(\"\\n\", $delete_html));\r\n\t}\r\n\t\r\n\t$navibars->add_actions(\tarray(\t(!empty($item->id)? '<a href=\"?fid=templates&act=2\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/add.png\"> '.t(38, 'Create').'</a>' : ''),\r\n\t\t\t\t\t\t\t\t\t'<a href=\"?fid=templates&act=0\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/application_view_list.png\"> '.t(39, 'List').'</a>',\r\n\t\t\t\t\t\t\t\t\t'search_form' ));\r\n\r\n\t$navibars->form();\r\n\r\n\t$navibars->add_tab(t(43, \"Main\"));\r\n\t\r\n\t$navibars->add_tab_content($naviforms->hidden('form-sent', 'true'));\r\n\t$navibars->add_tab_content($naviforms->hidden('id', $item->id));\t\r\n\t\r\n\t$navibars->add_tab_content_row(array(\t'<label>ID</label>',\r\n\t\t\t\t\t\t\t\t\t\t\t'<span>'.(!empty($item->id)? $item->id : t(52, '(new)')).'</span>' ));\r\n\r\n\t$navibars->add_tab_content_row(array(\t'<label>'.t(67, 'Title').'</label>',\r\n\t\t\t\t\t\t\t\t\t\t\t$naviforms->textfield('title', $item->title),\r\n\t\t\t\t\t\t\t\t\t\t));\t\t\r\n\r\n    if($readonly)\r\n    {\r\n        $navibars->add_tab_content_row(array(\t'<label>'.t(82, 'File').'</label>',\r\n                                                        '<span>'.$item->file.'</span>'\r\n                                                    ));\r\n    }\r\n    else\r\n    {\r\n        $navibars->add_tab_content_row(\r\n            array(\r\n                '<label>'.t(82, 'File').'</label>',\r\n                '<span>'.NAVIGATE_PRIVATE.'/'.$website->id.'/templates/</span>',\r\n                $naviforms->textfield('file', $item->file, '236px'),\r\n                empty($item->file)? '' : '<a href=\"#\" onclick=\"navigate_templates_editor();\"><img src=\"'.NAVIGATE_URL.'/img/icons/silk/pencil.png\" /></a>'\r\n            )\r\n        );\r\n    }\r\n\t\r\n\t$navibars->add_content('\r\n\t\t<div id=\"templates-file-edit-dialog\" style=\" display: none; \">\r\n\t\t\t<textarea name=\"templates-file-edit-area\" id=\"templates-file-edit-area\" style=\" width: 99%; height: 98%; \">'.htmlentities(@file_get_contents(NAVIGATE_PRIVATE.'/'.$website->id.'/templates/'.$item->file), ENT_COMPAT, 'UTF-8').'</textarea>\r\n\t\t</div>\r\n\t');\r\n\t\t\t\t\t\t\t\r\n\t$layout->add_script('\r\n\t\tvar current_template_editor = null;\r\n\t\tfunction navigate_templates_editor()\r\n\t\t{\r\n\t\t\tvar file = $(\"#file\").val();\r\n\r\n\t\t\t$(\"#templates-file-edit-dialog\").dialog(\r\n\t\t\t{\r\n\t\t\t\ttitle: \\'<img src=\"'.NAVIGATE_URL.'/img/icons/silk/pencil.png\" align=\"absmiddle\" /> '.t(170, 'Edit').' \\' + file,\r\n\t\t\t\tresizable: true,\r\n\t\t\t\tdraggable: true,\r\n\t\t\t\twidth: $(window).width() - 60,\r\n\t\t\t\theight: $(window).height() - 50,\r\n\t\t\t\tposition: { my: \"center\", at: \"center\", of: window },\r\n\t\t\t\tmodal: true,\r\n\t\t\t\topen: function()\r\n\t\t\t\t{\r\n                    current_template_editor = CodeMirror.fromTextArea(\r\n                        $(\"#templates-file-edit-area\")[0],\r\n                        {\r\n                            mode: \"text/html\",\r\n                            tabMode: \"indent\",\r\n                            lineNumbers: true,\r\n                            matchBrackets: true\r\n                        }\r\n                    );\r\n\r\n\t\t\t\t\t$(\".CodeMirror\").css({ width: \"99%\", height: \"98%\"});\r\n\t\t\t\t\t$(\".CodeMirror-scroll\").css({ width: \"100%\", height: \"100%\"});\r\n\t\t\t\t},\r\n\t\t\t\tbeforeClose: function() {\r\n\t\t\t\t    // dialog may be closed by clicking on a footer button or clicking the close \"x\" icon on top\r\n\t\t\t\t    if(current_template_editor)\r\n\t\t\t\t    {\r\n\t\t\t\t        current_template_editor.toTextArea();\r\n\t\t\t\t\t    current_template_editor = null;\r\n                    }\r\n\t\t\t\t},\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\t\"'.t(58, 'Cancel').'\": function() {\r\n\t\t\t\t\t\t$(\"#templates-file-edit-dialog\").dialog(\"close\");\r\n\t\t\t\t\t},\r\n\t\t\t\t\t\"'.t(34, 'Save').'\": function()\r\n\t\t\t\t\t{ \t\t\t\t\t\r\n\t\t\t\t\t\tcurrent_template_editor.toTextArea();\t\t\t\t\t\r\n\t\t\t\t\t\tcurrent_template_editor = null;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t$.ajax({\r\n\t\t\t\t\t\t   type: \"POST\",\r\n\t\t\t\t\t\t   async: false,\r\n\t\t\t\t\t\t   dateType: \"text\",\r\n\t\t\t\t\t\t   url: \"'.NAVIGATE_URL.'/'.NAVIGATE_MAIN.'?fid='.$_REQUEST['fid'].'&id='.$item->id.'&act=save_template_file\",\r\n\t\t\t\t\t\t   data: $(\"#templates-file-edit-area\").serialize(),\r\n\t\t\t\t\t\t   success: function(data)\r\n\t\t\t\t\t\t   {\t\t\t\r\n\t\t\t\t\t\t\t   \tif(data==\"true\")\r\n\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t$(\"#templates-file-edit-dialog\").dialog(\"close\"); \r\n\t\t\t\t\t\t\t\t\tnavigate_notification(\"'.t(235, 'File saved successfully.').'\");\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t$(\"#templates-file-edit-dialog\").dialog(\"close\"); \r\n\t\t\t\t\t\t\t\t\tnavigate_notification(\"'.t(56, 'Unexpected error.').'\");\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t   }\r\n\t\t\t\t\t\t });\r\n\t\t\t\t\t}\t\t\t\t\t\r\n\t\t\t\t}\t\t\t\t\r\n\t\t\t}).dialogExtend(\r\n\t\t\t{\r\n\t\t\t\tmaximizable: true\r\n\t\t\t});\r\n\t\t}\r\n\t');\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t$navibars->add_tab_content_row(array(\t'<label>'.t(68, 'Status').'</label>',\r\n\t\t\t\t\t\t\t\t\t\t\t$naviforms->selectfield('permission', \r\n\t\t\t\t\t\t\t\t\t\t\t\tarray(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t0 => 0,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t1 => 1,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t2 => 2\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t),\r\n\t\t\t\t\t\t\t\t\t\t\t\tarray(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t0 => t(69, 'Published'),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t1 => t(70, 'Private'),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t2 => t(81, 'Hidden')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t),\r\n\t\t\t\t\t\t\t\t\t\t\t\t$item->permission,\r\n\t\t\t\t\t\t\t\t\t\t\t\t'',\r\n\t\t\t\t\t\t\t\t\t\t\t\tfalse,\r\n\t\t\t\t\t\t\t\t\t\t\t\tarray(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t0 => t(360, 'Visible to everybody'),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t1 => t(359, 'Visible only to Navigate CMS users'),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t2 => t(358, 'Hidden to everybody')\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t$navibars->add_tab_content_row(array(\t'<label>'.t(62, 'Statistics').'</label>',\r\n\t\t\t\t\t\t\t\t\t\t\t$naviforms->checkbox('statistics', $item->statistics),\r\n\t\t\t\t\t\t\t\t\t\t));\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t$navibars->add_tab_content_row(array(\t'<label>'.t(65, 'Enabled').'</label>',\r\n\t\t\t\t\t\t\t\t\t\t\t$naviforms->checkbox('enabled', $item->enabled),\r\n\t\t\t\t\t\t\t\t\t\t));\t\r\n\r\n\tif(!empty($item->id))\r\n\t{\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t$navibars->add_tab(t(236, \"Sections\"));\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\r\n\t\t$table = new naviorderedtable(\"template_sections_table\");\r\n\t\t$table->setWidth(\"600px\");\r\n\t\t$table->setHiddenInput(\"template-sections-order\");\r\n\r\n\t\t$navibars->add_tab_content( $naviforms->hidden('template-sections-order', \"\") );\t\t\t\r\n\r\n\t\t$table->addHeaderColumn(t(237, 'Code'), 100);\t\t\t\r\n\t\t$table->addHeaderColumn(t(159, 'Name'), 250);\r\n\t\t$table->addHeaderColumn(t(267, 'Editor'), 100);\r\n\t\t$table->addHeaderColumn(t(155, 'Width'), 100);\t\t\t\t\r\n\t\t$table->addHeaderColumn(t(35, 'Remove'), 100);\t\t\r\n\r\n\t\tfor($p=0; $p < count($item->sections); $p++)\r\n\t\t{\r\n\t\t\t$disabled = ($item->sections[$p]['code']=='main');\r\n\t\t\tunset($selected);\r\n\t\t\t$selected = array();\r\n\t\t\t$selected[$item->sections[$p]['editor']] = ' selected=\"selected\" ';\r\n\t\t\t\r\n\t\t\t$select_editor = '<select name=\"template-sections-editor[]\" style=\" width: 125px; \">';\r\n\t\t\t$select_editor.= '\t<option value=\"tinymce\" '.$selected['tinymce'].'>TinyMCE</option>';\r\n\t\t\t$select_editor.= '\t<option value=\"html\" '.$selected['html'].'>'.t(269, 'HTML code').'</option>';\r\n\t\t\t$select_editor.= '\t<option value=\"raw\" '.$selected['raw'].'>'.t(268, 'Raw').'</option>';\t\t\t\r\n\t\t\t$select_editor.= '</select>';\r\n\t\t\t\r\n\t\t\t$table->addRow($p, array(\r\n\t\t\t\t\tarray('content' => '<input type=\"text\" name=\"template-sections-code[]\" value=\"'.$item->sections[$p]['code'].'\" style=\"width: 140px;\" />', 'align' => 'left'),\t\t\t\r\n\t\t\t\t\tarray('content' => '<input type=\"text\" name=\"template-sections-name[]\" value=\"'.template::section_name($item->sections[$p]['name']).'\" style=\"width: 290px;\" />', 'align' => 'left'),\r\n\t\t\t\t\tarray('content' => $select_editor, 'align' => 'left'),\r\n\t\t\t\t\tarray('content' => '<div style=\" white-space: nowrap; \"><input type=\"text\" name=\"template-sections-width[]\" value=\"'.template::section_name($item->sections[$p]['width']).'\" style=\"width: 40px;\" /> px</div>', 'align' => 'left'),\r\n\t\t\t\t\tarray('content' => ((!empty($disabled) || $readonly)? '' : '<img src=\"'.NAVIGATE_URL.'/img/icons/silk/cancel.png\" onclick=\"navigate_templates_sections_remove(this);\" />'), 'align' => 'center')\r\n\t\t\t\t));\t\t\t\r\n\t\t}\r\n\r\n        if($readonly)\r\n        {\r\n            $navibars->add_tab_content_row(array(\t'<label>'.t(236, 'Sections').'</label>',\r\n                                                    '<div>'.$table->generate().'</div>'));\r\n        }\r\n        else\r\n        {\r\n            $navibars->add_tab_content_row(array(\t'<label>'.t(236, 'Sections').'</label>',\r\n                                                    '<div>'.$table->generate().'</div>',\r\n                                                    '<div class=\"subcomment\">\r\n                                                        <img src=\"img/icons/silk/information.png\" align=\"absmiddle\" /> '.t(72, 'Drag any row to assign priorities').'.\r\n                                                         '.t(192, 'Double click any row to edit').'\r\n                                                    </div>' ));\r\n\r\n            $navibars->add_tab_content_row(array(\t'<label>&nbsp;</label>',\r\n                                                    '<button id=\"templates-sections-create\"><img src=\"img/icons/silk/add.png\" align=\"absmiddle\" style=\"cursor:pointer;\" /> '.t(38, 'Create').'</button>'));\r\n\t\t\r\n        }\r\n\r\n\t\t$navibars->add_content('\r\n\t\t\t<form id=\"templates-sections-edit-dialog\" style=\"display: none;\">\r\n\t\t\t\t'.$naviforms->hidden('section-id', '').'\r\n\t\t\t\t<div class=\"navigate-form-row\">\r\n\t\t\t\t\t<label>'.t(67, 'Title').'</label>\r\n\t\t\t\t\t'.$naviforms->textfield('section-name', '').'\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"navigate-form-row\">\r\n\t\t\t\t\t<label>'.t(237, 'Code').'</label>\r\n\t\t\t\t\t'.$naviforms->textfield('section-code', '').'\t\t\t\t\t\r\n\t\t\t\t</div>\t\t\t\r\n\t\t\t</form>');\r\n\t\t\t\r\n\t\t\r\n\t\t$section_widths = templates_section_widths();\r\n\t\t\r\n\t\t$layout->add_script('\r\n\t\t\t$(\"#templates-sections-create\").on(\"click\", function() {\r\n\t\t\t\tvar tr = \\'<tr id=\"\\'+(new Date().getTime())+\\'\">\\';\r\n\t\t\t\ttr += \\'<td><input type=\"text\" name=\"template-sections-code[]\" value=\"\" style=\"width: 140px;\" /></td>\\';\r\n\t\t\t\ttr += \\'<td><input type=\"text\" name=\"template-sections-name[]\" value=\"\" style=\"width: 290px;\" /></td>\\';\r\n\t\t\t\ttr += \\'<td><select style=\"width: 125px;\" name=\"template-sections-editor[]\"><option selected=\"selected\" value=\"tinymce\">TinyMCE</option><option value=\"html\">'.t(269, 'HTML code').'</option><option value=\"raw\">'.t(268, 'Raw').'</option></select></td>\\';\r\n\t\t\t\ttr += \\'<td><div style=\"white-space: nowrap;\"><input type=\"text\" style=\"width: 40px;\" value=\"950\" name=\"template-sections-width[]\"> px</div></td>\\';\r\n\t\t\t\ttr += \\'<td align=\"center\"><img src=\"'.NAVIGATE_URL.'/img/icons/silk/cancel.png\" onclick=\"navigate_templates_sections_remove(this);\" style=\"cursor:pointer;\" /></td>\\';\t\t\t\t\r\n\t\t\t\ttr += \\'</tr>\\';\r\n\t\t\t\t\r\n\t\t\t\t$(\"#template_sections_table\").find(\"tbody:last\").append(tr);\r\n\t\t\t\t$(\"#template_sections_table\").tableDnD(\r\n\t\t\t\t{\r\n\t\t\t\t\tonDrop: function(table, row) \r\n\t\t\t\t\t{\t\tnavigate_naviorderedtable_template_sections_table_reorder();\t\t}\r\n\t\t\t\t});\t\t\t\r\n\r\n\t\t\t\t$(\\'input[name=\"template-sections-width[]\"]\\').autocomplete(\r\n\t\t\t\t{\r\n\t\t\t\t\tsource: function(request, response) { response('.json_encode($section_widths).'); },\r\n\t\t\t\t\tminLength: 0\t\t\t\r\n\t\t\t\t});\t\t\t\t\r\n\r\n\t\t\t\treturn false;\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\tfunction navigate_templates_sections_remove(el)\r\n\t\t\t{\t\t\t\t\r\n\t\t\t\t$(el).parent().parent().remove();\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t$(\\'input[name=\"template-sections-width[]\"]\\').autocomplete(\r\n\t\t\t{\r\n\t\t\t\tsource: function(request, response) { response('.json_encode($section_widths).'); },\r\n\t\t\t\tminLength: 0\t\t\t\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\t$(document).on(\\'click\\', \\'input[name=\"template-sections-width[]\"]\\', function()\t\t\t\r\n\t\t\t{\r\n\t\t\t\t$(this).autocomplete( \"search\" , $(this).val());\r\n\t\t\t});\r\n\t\t');\r\n\t\t\r\n\t\t$navibars->add_tab_content_row(array(\t'<label>'.t(210, 'Gallery').'</label>',\r\n\t\t\t\t\t\t\t\t\t\t\t\t$naviforms->checkbox('gallery', $item->gallery),\r\n\t\t\t\t\t\t\t\t\t\t\t));\t\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t$navibars->add_tab_content_row(array(\t'<label>'.t(250, 'Comments').'</label>',\r\n\t\t\t\t\t\t\t\t\t\t\t\t$naviforms->checkbox('comments', $item->comments),\r\n\t\t\t\t\t\t\t\t\t\t\t));\t\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t$navibars->add_tab_content_row(array(\t'<label>'.t(265, 'Tags').'</label>',\r\n\t\t\t\t\t\t\t\t\t\t\t\t$naviforms->checkbox('tags', $item->tags),\r\n\t\t\t\t\t\t\t\t\t\t\t));\t\t\t\t\t\t\t\t\t\t\t\t\r\n\r\n\r\n\t\t$navibars->add_tab(t(77, \"Properties\"));\r\n\t\r\n\t\t$table = new naviorderedtable(\"template_properties_table\");\r\n\t\t$table->setWidth(\"550px\");\r\n\t\t$table->setHiddenInput(\"template-properties-order\");\r\n\t\t$table->setDblclickCallback(\"navigate_templates_edit_property\");\r\n\t\t\r\n\t\t$navibars->add_tab_content( $naviforms->hidden('template-properties-order', \"\") );\t\t\t\r\n\t\t\r\n\t\t$table->addHeaderColumn(t(159, 'Name'), 250, true);\r\n\t\t$table->addHeaderColumn(t(160, 'Type'), 150);\r\n\t\t$table->addHeaderColumn(t(87, 'Association'), 100);\t\t\r\n\t\t$table->addHeaderColumn(t(65, 'Enabled'), 50);\t\r\n\r\n        $properties = property::elements($item->id);\r\n\t\t$types\t\t= property::types();\r\n\r\n        $element_types = array(\t'item'\t=> \tt(180, 'Item'),\r\n\t\t\t\t\t\t\t\t'structure' => t(16, 'Structure')/*,\r\n\t\t\t\t\t\t\t\t'product' => t(214, 'Product')*/);\r\n\t\t\r\n\t\tfor($p=0; $p < count($properties); $p++)\r\n\t\t{\r\n\t\t\t$table->addRow($properties[$p]->id, array(\r\n\t\t\t\t\tarray('content' => $properties[$p]->name, 'align' => 'left'),\r\n\t\t\t\t\tarray('content' => $types[$properties[$p]->type], 'align' => 'left'),\r\n\t\t\t\t\tarray('content' => $element_types[$properties[$p]->element], 'align' => 'left'),\t\t\t\t\t\r\n\t\t\t\t\tarray('content' => '<input type=\"checkbox\" name=\"property-enabled[]\" class=\"raw-checkbox\" value=\"'.$properties[$p]->id.'\" '.(($properties[$p]->enabled=='1'? ' checked=checked ' : '')).' />', 'align' => 'center'),\r\n\t\t\t\t));\r\n\t\t}\r\n\r\n        if($readonly)\r\n        {\r\n            $navibars->add_tab_content_row(array(\t'<label>'.t(77, 'Properties').'</label>',\r\n                                                    '<div>'.$table->generate().'</div>'));\r\n        }\r\n        else\r\n        {\r\n            $navibars->add_tab_content_row(array(\t'<label>'.t(77, 'Properties').'</label>',\r\n                                                    '<div>'.$table->generate().'</div>',\r\n                                                    '<div class=\"subcomment\">\r\n                                                        <img src=\"img/icons/silk/information.png\" align=\"absmiddle\" /> '.t(72, 'Drag any row to assign priorities').'.\r\n                                                         '.t(192, 'Double click any row to edit').'\r\n                                                    </div>' ));\r\n\r\n            $navibars->add_tab_content_row(array(\t'<label>&nbsp;</label>',\r\n                                                    '<button id=\"templates-properties-create\"><img src=\"img/icons/silk/add.png\" align=\"absmiddle\" /> '.t(38, 'Create').'</button>'));\r\n        }\r\n\t\r\n\t\t$navibars->add_content('\r\n\t\t<form id=\"templates-properties-edit-dialog\" style=\"display: none;\">\r\n\t\t\t<div class=\"navigate-form-row\">\r\n\t\t\t\t<label>ID</label>\r\n\t\t\t\t<span id=\"property-id-span\">'.t(52, '(new)').'</span>\r\n\t\t\t\t'.$naviforms->hidden('property-id', '').'\r\n\t\t\t\t'.$naviforms->hidden('property-template', $item->id).'\t\t\t\r\n\t\t\t</div>\t\r\n\t\t\t<div class=\"navigate-form-row\">\r\n\t\t\t\t<label>'.t(67, 'Title').'</label>\r\n\t\t\t\t'.$naviforms->textfield('property-name', '').'\r\n\t\t\t</div>\r\n\t\t\t<div class=\"navigate-form-row\">\r\n\t\t\t\t<label>'.t(87, 'Association').'</label>\r\n\t\t\t\t'.$naviforms->selectfield('property-element', \r\n\t\t\t\t\t\t\t\t\t\t\tarray_keys($element_types),\r\n\t\t\t\t\t\t\t\t\t\t\tarray_values($element_types),\r\n\t\t\t\t\t\t\t\t\t\t\t'value'\r\n\t\t\t\t\t\t\t\t\t\t).'\r\n\t\t\t</div>\t\t\t\r\n\t\t\t<div class=\"navigate-form-row\">\r\n\t\t\t\t<label>'.t(160, 'Type').'</label>\r\n\t\t\t\t'.$naviforms->selectfield('property-type', \r\n\t\t\t\t\t\t\t\t\t\t\tarray_keys($types),\r\n\t\t\t\t\t\t\t\t\t\t\tarray_values($types),\r\n\t\t\t\t\t\t\t\t\t\t\t'value',\r\n\t\t\t\t\t\t\t\t\t\t\t'navigate_templates_property_type_change()'\r\n\t\t\t\t\t\t\t\t\t\t).'\r\n\t\t\t</div>\r\n\t\t\t<div class=\"navigate-form-row\">\r\n\t\t\t\t<label>'.t(200, 'Options').'</label>\r\n\t\t\t\t'.$naviforms->textarea('property-options', '').'\r\n\t\t\t\t<div class=\"subcomment\">\r\n\t\t\t\t\t'.t(201, 'One line per option, formatted like this: value#title').'\r\n\t\t\t\t</div>\t\t\t\t\r\n\t\t\t</div>\r\n\t\t\t<div class=\"navigate-form-row\">\r\n\t\t\t\t<label>'.t(547, 'Multilanguage').'</label>\r\n\t\t\t\t'.$naviforms->checkbox('property-multilanguage', false).'\r\n\t\t\t</div>\r\n\t\t\t<div class=\"navigate-form-row\">\r\n\t\t\t\t<label>'.t(199, 'Default value').'</label>\r\n\t\t\t\t'.$naviforms->textfield('property-dvalue', '').'\t\r\n\t\t\t\t<div class=\"subcomment\">\r\n\t\t\t\t    <span id=\"property-comment-boolean\">'.t(426, 'Enter \"1\" for true, \"0\" for false').'</span>\r\n\t\t\t\t\t<span id=\"property-comment-option\">'.t(202, 'Enter only the value').'</span>\r\n\t\t\t\t\t<span id=\"property-comment-moption\">'.t(212, 'Enter the selected values separated by commas').': 3,5,8</span>\r\n\t\t\t\t\t<span id=\"property-comment-text\">'.t(203, 'Same value for all languages').'</span>\r\n\t\t\t\t\t<span id=\"property-comment-rating\">'.t(223, 'Default is 5 stars, if you want a different number: default_value#number_of_stars').' 5#10</span>\r\n\t\t\t\t\t<span id=\"property-comment-date\">'.t(50, 'Date format').': '.date($user->date_format).'</span>\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t<span id=\"property-comment-color\">'.t(442, 'Hexadecimal color code').': #ffffff</span>\r\n\t\t\t\t\t<span id=\"property-comment-country\">'.t(225, 'Alpha-2 country code').' (es, us, uk...)</span>\r\n\t\t\t\t\t<span id=\"property-comment-file\">'.t(204, 'ID of the file').'</span>\r\n\t\t\t\t\t<span id=\"property-comment-video\">'.t(490, 'ID of the file or public video URL').'</span>\r\n\t\t\t\t\t<span id=\"property-comment-coordinates\">'.t(298, 'Latitude').'#'.t(299, 'Longitude').': 40.689231#-74.044505</span>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"navigate-form-row\">\r\n\t\t\t\t<label>'.t(65, 'Enabled').'</label>\r\n\t\t\t\t'.$naviforms->checkbox('property-enabled', 1).'\r\n\t\t\t</div>\r\n            <div class=\"navigate-form-row\">\r\n\t\t\t\t<label>'.t(550, 'Help text').'</label>\r\n\t\t\t\t'.$naviforms->textfield('property-helper', '').'\r\n\t\t\t</div>\r\n\t\t</form>');\r\n\r\n\t\t$layout->add_script('\r\n\t\t\t$(\"#templates-properties-create\").on(\"click\", function()\r\n\t\t\t{\r\n\t\t\t\tnavigate_templates_edit_property();\r\n\t\t\t\treturn false;\r\n\t\t\t});\r\n\t\t\r\n\t\t\tfunction navigate_templates_edit_property(el)\r\n\t\t\t{\t\r\n\t\t\t\tif(!el)\t// new property\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#property-id\").val(\"\");\r\n\t\t\t\t\t$(\"#property-id-span\").html(\"'.t(52, '(new)').'\");\r\n\t\t\t\t\t$(\"#property-element\").val(\"template\");\r\n\t\t\t\t\t$(\"#property-template\").val(\"'.$item->id.'\");\r\n\t\t\t\t\t$(\"#property-name\").val(\"\");\r\n\t\t\t\t\t$(\"#property-type\").val(\"value\");\r\n\t\t\t\t\t$(\"#property-options\").val(\"\");\r\n\t\t\t\t\t$(\"#property-dvalue\").val(\"\");\r\n\t\t\t\t\t$(\"#property-helper\").val(\"\");\r\n\t\t\t\t\t$(\"#property-multilanguage\").removeAttr(\"checked\");\r\n\t\t\t\t    $(\"#property-enabled\").attr(\"checked\", \"checked\");\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$.ajax({\r\n\t\t\t\t\t   type: \"GET\",\r\n\t\t\t\t\t   async: false,\r\n\t\t\t\t\t   dateType: \"json\",\r\n\t\t\t\t\t   url: \"'.NAVIGATE_URL.'/'.NAVIGATE_MAIN.'?fid=templates&act=template_property_load&template='.$item->id.'&id=\" + $(el).attr(\"id\"),\r\n\t\t\t\t\t   success: function(data)\r\n\t\t\t\t\t   {\r\n\t\t\t\t\t\t   $(\"#property-id-span\").html(data.id);\r\n\t\t\t\t\t\t   $(\"#property-id\").val(data.id);\r\n\t\t\t\t\t\t   $(\"#property-element\").val(data.element);\r\n\t\t\t\t\t\t   $(\"#property-template\").val(data.template);\r\n\t\t\t\t\t\t   $(\"#property-name\").val(data.name);\r\n\t\t\t\t\t\t   $(\"#property-type\").val(data.type);\r\n\t\t\t\t\t\t   $(\"#property-options\").val(data.options);\r\n\t\t\t\t\t\t   $(\"#property-dvalue\").val(data.dvalue);\r\n\t\t\t\t\t\t   $(\"#property-helper\").val(data.helper);\r\n\r\n\t\t\t\t\t\t   if(data.multilanguage==\"true\")\r\n\t\t\t\t\t\t\t   $(\"#property-multilanguage\").attr(\"checked\", \"checked\");\r\n\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t   $(\"#property-multilanguage\").removeAttr(\"checked\");\r\n\r\n\t\t\t\t\t\t   if(data.enabled==\"1\")\r\n\t\t\t\t\t\t\t   $(\"#property-enabled\").attr(\"checked\", \"checked\");\r\n\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t   $(\"#property-enabled\").removeAttr(\"checked\");\r\n\t\t\t\t\t\t\t   \r\n\t\t\t\t\t\t   var options = \"\";\r\n\t\t\t\t\t\t   for(var o in data.options)\r\n\t\t\t\t\t\t   {\r\n\t\t\t\t\t\t\t   options += o + \"#\" + data.options[o] + \"\\n\";\r\n\t\t\t\t\t\t   }\r\n\t\t\t\t\t\t   $(\"#property-options\").val(options);\r\n\r\n\t\t\t\t\t   }\r\n\t\t\t\t\t });\t\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tnavigate_templates_property_type_change();\r\n\t\t\t\t\r\n\t\t\t\tvar navigate_templates_element_types = new Array();\r\n\t\t\t\tnavigate_templates_element_types[\"item\"] = \"'.t(180, 'Item').'\";\r\n\t\t\t\tnavigate_templates_element_types[\"structure\"] = \"'.t(16, 'Structure').'\";\r\n\t\t\t\t//navigate_templates_element_types[\"product\"] = \"'.t(214, 'Product').'\";\r\n\r\n\t\t\t\tif('.($readonly? 'true' : 'false').')\r\n\t\t\t\t{\r\n                    $(\"#templates-properties-edit-dialog\").dialog(\r\n                    {\r\n                        title: \\'<img src=\"img/icons/silk/pencil.png\" align=\"absmiddle\" /> '.t(170, 'Edit').'\\',\r\n                        resizable: true,\r\n                        height: 360,\r\n                        width: 650,\r\n                        modal: true,\r\n                    });\r\n\t\t\t\t}\r\n\t\t\t\telse // show dialog with action buttons\r\n\t\t\t\t{\r\n                    $(\"#templates-properties-edit-dialog\").dialog(\r\n                    {\r\n                        title: \\'<img src=\"img/icons/silk/pencil.png\" align=\"absmiddle\" /> '.t(170, 'Edit').'\\',\r\n                        resizable: true,\r\n                        height: 410,\r\n                        width: 650,\r\n                        modal: true,\r\n                        buttons: {\r\n                            \"'.t(58, 'Cancel').'\": function() {\r\n                                $(this).dialog(\"close\");\r\n                            },\r\n                            \"'.t(35, 'Delete').'\": function() {\r\n                                $.ajax({\r\n                                   type: \"POST\",\r\n                                   async: false,\r\n                                   dateType: \"text\",\r\n                                   url: \"'.NAVIGATE_URL.'/'.NAVIGATE_MAIN.'?fid='.$_REQUEST['fid'].'&act=template_property_remove\",\r\n                                   data: $(\"#templates-properties-edit-dialog\").serialize(),\r\n                                   success: function(msg)\r\n                                   {\r\n                                     $(\"#template_properties_table\").find(\"#\" + $(\"#property-id\").val()).remove();\r\n                                     navigate_naviorderedtable_template_properties_table_reorder();\r\n                                     $(\"#templates-properties-edit-dialog\").dialog(\"close\");\r\n                                   }\r\n                                 });\r\n                            },\r\n                            \"'.t(190, 'Ok').'\": function()\r\n                            {\r\n                                $.ajax({\r\n                                   type: \"POST\",\r\n                                   async: false,\r\n                                   dateType: \"text\",\r\n                                   url: \"'.NAVIGATE_URL.'/'.NAVIGATE_MAIN.'?fid='.$_REQUEST['fid'].'&act=template_property_save\",\r\n                                   data: $(\"#templates-properties-edit-dialog\").serialize(),\r\n                                   success: function(data)\r\n                                   {\r\n                                       if($(\"#property-id\").val() > 0)\r\n                                       {\r\n                                           // update\r\n                                           var tr = $(\"#template_properties_table\").find(\"#\" + $(\"#property-id\").val());\r\n                                           tr.find(\"td\").eq(0).html(data.name);\r\n                                           tr.find(\"td\").eq(1).html(data.type_text);\r\n                                           tr.find(\"td\").eq(2).html(navigate_templates_element_types[data.element]);\r\n                                           tr.find(\"input[type=checkbox]\").attr(\"checked\", (data.enabled==1));\r\n                                       }\r\n                                       else\r\n                                       {\r\n                                           // insert\r\n                                           var checked = \"\";\r\n                                           if(data.enabled) checked = \\' checked=\"checked\" \\';\r\n                                           var tr = \\'<tr id=\"\\'+data.id+\\'\"><td>\\'+data.name+\\'</td><td>\\'+data.type_text+\\'</td><td>\\'+navigate_templates_element_types[data.element]+\\'</td><td align=\"center\"><input name=\"property-enabled[]\" class=\"raw-checkbox\" type=\"checkbox\" value=\"\\'+data.id+\\'\" \\'+checked+\\' /></td></tr>\\';\r\n                                           $(\"#template_properties_table\").find(\"tbody:last\").append(tr);\r\n                                           $(\"#template_properties_table\").find(\"tr:last\").on(\"dblclick\", function() { navigate_templates_edit_property(this); });\r\n                                           $(\"#template_properties_table\").tableDnD(\r\n                                            {\r\n                                                onDrop: function(table, row)\r\n                                                {\t\tnavigate_naviorderedtable_template_properties_table_reorder();\t\t}\r\n                                            });\r\n                                       }\r\n                                       navigate_naviorderedtable_template_properties_table_reorder();\r\n                                       $(\"#templates-properties-edit-dialog\").dialog(\"close\");\r\n                                   }\r\n                                 });\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tfunction navigate_templates_property_type_change()\r\n\t\t\t{\r\n\t\t\t\t$(\"#property-options\").parent().hide();\r\n\t\t\t\t$(\"#property-multilanguage\").parent().hide();\r\n\t\t\t\t$(\"#property-dvalue\").next().find(\"span\").hide();\r\n\t\t\t\t\r\n\t\t\t\tswitch($(\"#property-type\").val())\r\n\t\t\t\t{\t\t\t\t\t\t\r\n\t\t\t\t\tcase \"option\":\r\n\t\t\t\t\t\t$(\"#property-options\").parent().show();\r\n\t\t\t\t\t\t$(\"#property-comment-option\").show();\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tcase \"moption\":\r\n\t\t\t\t\t\t$(\"#property-options\").parent().show();\r\n\t\t\t\t\t\t$(\"#property-comment-moption\").show();\r\n\t\t\t\t\t\tbreak;\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tcase \"text\":\r\n\t\t\t\t\tcase \"textarea\":\r\n\t\t\t\t\tcase \"link\":\r\n\t\t\t\t\tcase \"rich_textarea\":\r\n\t\t\t\t\tcase \"source_code\":\r\n\t\t\t\t\t\t$(\"#property-comment-text\").show();\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tcase \"date\":\r\n\t\t\t\t\tcase \"datetime\":\r\n\t\t\t\t\t\t$(\"#property-comment-date\").show();\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tcase \"image\":\r\n\t\t\t\t\tcase \"file\":\r\n\t\t\t\t\t\t$(\"#property-comment-file\").show();\r\n\t\t\t\t\t\t$(\"#property-multilanguage\").parent().show();\r\n\t\t\t\t\t\tbreak;\r\n\r\n                    case \"video\":\r\n\t\t\t\t\t\t$(\"#property-comment-video\").show();\r\n\t\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\tcase \"rating\":\r\n\t\t\t\t\t\t$(\"#property-comment-rating\").show();\r\n\t\t\t\t\t\tbreak;\t\r\n\r\n                    case \"color\":\r\n\t\t\t\t\t\t$(\"#property-comment-color\").show();\r\n\t\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\tcase \"coordinates\":\r\n\t\t\t\t\t\t$(\"#property-comment-coordinates\").show();\r\n\t\t\t\t\t\tbreak;\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tcase \"country\":\r\n\t\t\t\t\t\t$(\"#property-comment-country\").show();\r\n\t\t\t\t\t\tbreak;\r\n\r\n                    case \"boolean\":\r\n\t\t\t\t\t\t$(\"#property-comment-boolean\").show();\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\r\n\t\t\t\t\tcase \"comment\":\r\n\t\t\t\t\tcase \"value\":\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tnavigate_naviorderedtable_template_properties_table_reorder();\t\r\n\t\t');\t\t\t\r\n\r\n\t}\r\n\r\n\treturn $navibars->generate();\r\n}\r\n\r\n// find all website section widths\r\nfunction templates_section_widths()\r\n{\r\n\tglobal $DB;\r\n\tglobal $website;\r\n\t\r\n\t$DB->query('SELECT sections\r\n\t\t\t\t  FROM nv_templates\r\n\t\t\t\t WHERE website = '.intval($website->id),\r\n\t\t\t\t'array');\r\n\t\t\t\t\r\n\t$result = $DB->result();\r\n\t\r\n\t$widths = array();\r\n\tforeach($result as $sections)\r\n\t{\r\n\t\t$sections = mb_unserialize($sections['sections']);\r\n\t\tif(!is_array($sections)) $sections = array();\r\n\t\tforeach($sections as $section)\r\n\t\t{\r\n\t\t\tif(!empty($section['width']) && !in_array($section['width'], $widths))\r\n\t\t\t\tarray_push($widths, $section['width']);\r\n\t\t}\r\n\t}\t\r\n\t\r\n\treturn $widths;\r\n}\r\n\r\n?>", "<?php\r\nrequire_once(NAVIGATE_PATH.'/lib/packages/themes/theme.class.php');\r\nrequire_once(NAVIGATE_PATH.'/lib/packages/properties/property.class.php');\r\n\r\nfunction run()\r\n{\r\n\tglobal $user;\t\r\n\tglobal $layout;\r\n\tglobal $website;\r\n    global $theme;\r\n    global $DB;\r\n\t\r\n\t$out = '';\r\n\r\n\tswitch($_REQUEST['act'])\r\n\t{\r\n        case 'theme_info':\r\n            echo '<iframe src=\"'.NAVIGATE_URL.'/themes/'.$_REQUEST['theme'].'/'.$_REQUEST['theme'].'.info.html'.'\" scrolling=\"auto\" frameborder=\"0\"  width=\"100%\" height=\"100%\"></iframe>';\r\n            core_terminate();\r\n            break;\r\n\r\n        case 'remove':\r\n            // check the theme is not actually used in any website\r\n            $usages = $DB->query_single(\r\n                'COUNT(*)',\r\n                'nv_websites',\r\n                ' theme = :theme',\r\n                null,\r\n                array(\r\n                    ':theme' => $_REQUEST['theme']\r\n                )\r\n            );\r\n            if($usages == 0)\r\n            {\r\n                try\r\n                {\r\n                    $theme = new theme();\r\n                    $theme->load($_REQUEST['theme']);\r\n                    $status = $theme->delete();\r\n                    echo json_encode($status);\r\n                }\r\n                catch(Exception $e)\r\n                {\r\n                    echo $e->getMessage();\r\n                }\r\n            }\r\n            else\r\n            {\r\n                $status = t(537, \"Can't remove the theme because it is currently being used by another website.\");\r\n                echo $status;\r\n            }\r\n            core_terminate();\r\n            break;\r\n\r\n        /*\r\n        case 'export':\r\n            $out = themes_export_form();\r\n            break;\r\n        */\r\n\r\n        case 'theme_sample_content_import':\r\n            try\r\n            {\r\n                $theme->import_sample();\r\n                $layout->navigate_notification(t(374, \"Item installed successfully.\"), false);\r\n            }\r\n            catch(Exception $e)\r\n            {\r\n                $layout->navigate_notification($e->getMessage(), true, true);\r\n            }\r\n\r\n            $themes = theme::list_available();\r\n            $out = themes_grid($themes);\r\n            break;\r\n\r\n        case 'theme_sample_content_export':\r\n            if(empty($_POST))\r\n                $out = themes_sample_content_export_form();\r\n            else\r\n            {\r\n                $categories = explode(',', $_POST['categories']);\r\n                $folder = $_POST['folder'];\r\n                $items = explode(',', $_POST['elements']);\r\n                $block_groups = explode(',', $_POST['block_groups']);\r\n                $blocks = explode(',', $_POST['blocks']);\r\n                $comments = explode(',', $_POST['comments']);\r\n\r\n                theme::export_sample($categories, $items, $block_groups, $blocks, $comments, $folder);\r\n\r\n                core_terminate();\r\n            }\r\n            break;\r\n\r\n        case 'install_from_hash':\r\n            $url = base64_decode($_GET['hash']);\r\n\r\n            if(!empty($url) && $user->permission(\"themes.install\")==\"true\")\r\n            {\r\n                $error = false;\r\n                parse_str(parse_url($url, PHP_URL_QUERY), $query);\r\n\r\n                $tmp_file = sys_get_temp_dir().DIRECTORY_SEPARATOR.$query['code'].'.zip';\r\n                @core_file_curl($url, $tmp_file);\r\n                if(@filesize($tmp_file) == 0)\r\n                {\r\n                    @unlink($tmp_file);\r\n                    // core file curl failed, try using file_get_contents...\r\n                    $tmp = @file_get_contents($url);\r\n                    if(!empty($tmp))\r\n                        @file_put_contents($tmp_file, $tmp);\r\n                    unset($tmp);\r\n                }\r\n\r\n                if(@filesize($tmp_file) > 0)\r\n                {\r\n                    // uncompress ZIP and copy it to the themes dir\r\n                    @mkdir(NAVIGATE_PATH.'/themes/'.$query['code']);\r\n\r\n                    $zip = new ZipArchive();\r\n                    $zip_open_status = $zip->open($tmp_file);\r\n                    if($zip_open_status === TRUE)\r\n                    {\r\n                        $zip->extractTo(NAVIGATE_PATH.'/themes/'.$query['code']);\r\n                        $zip->close();\r\n\r\n                        $layout->navigate_notification(t(374, \"Item installed successfully.\"), false);\r\n                    }\r\n                    else // zip extraction failed\r\n                    {\r\n                        $layout->navigate_notification('ERROR '.$zip_open_status, true, true);\r\n                        $error = true;\r\n                    }\r\n                }\r\n                else\r\n                {\r\n                    $layout->navigate_notification(t(56, 'Unexpected error'), true, true);\r\n                    $error = true;\r\n                }\r\n\r\n                if($error)\r\n                {\r\n                    $layout->add_content('\r\n                        <div id=\"navigate_marketplace_install_from_hash_error\">\r\n                            <p>'.t(529, \"It has not been possible to download the item you have just bought from the marketplace.\").'</p>\r\n                            <p>'.t(530, \"You have to visit your Marketplace Dashboard and download the file, then use the <strong>Install from file</strong> button you'll find in the actions bar on the right.\").'</p>\r\n                            <p>'.t(531, \"Sorry for the inconvenience.\").'</p>\r\n                            <a class=\"uibutton\" href=\"http://www.navigatecms.com/en/marketplace/dashboard\" target=\"_blank\"><span class=\"ui-icon ui-icon-extlink\" style=\"float: left;\"></span> '.t(532, \"Navigate CMS Marketplace\").'</a>\r\n                        </div>\r\n                    ');\r\n                    $layout->add_script('\r\n                        $(\"#navigate_marketplace_install_from_hash_error\").dialog({\r\n                            modal: true,\r\n                            title: \"'.t(56, \"Unexpected error\").'\"\r\n                        });\r\n                    ');\r\n                }\r\n            }\r\n            // don't break, we want to show the themes grid right now (theme_upload by browser upload won't trigger)\r\n\r\n        case 'theme_upload':\r\n            if(isset($_FILES['theme-upload']) && $_FILES['theme-upload']['error']==0 &&  $user->permission(\"themes.install\")==\"true\")\r\n            {\r\n                // uncompress ZIP and copy it to the themes dir\r\n                $tmp = trim(substr($_FILES['theme-upload']['name'], 0, strpos($_FILES['theme-upload']['name'], '.')));\r\n                $theme_name = filter_var($tmp, FILTER_SANITIZE_EMAIL);\r\n\r\n                if($tmp!=$theme_name) // INVALID file name\r\n                {\r\n                    $layout->navigate_notification(t(344, 'Security error'), true, true);\r\n                }\r\n                else\r\n                {\r\n                    @mkdir(NAVIGATE_PATH.'/themes/'.$theme_name);\r\n\r\n                    $zip = new ZipArchive;\r\n                    if($zip->open($_FILES['theme-upload']['tmp_name']) === TRUE)\r\n                    {\r\n                        $zip->extractTo(NAVIGATE_PATH.'/themes/'.$theme_name);\r\n                        $zip->close();\r\n\r\n                        $layout->navigate_notification(t(374, \"Item installed successfully.\"), false);\r\n                    }\r\n                    else // zip extraction failed\r\n                    {\r\n                        $layout->navigate_notification(t(262, 'Error uploading file'), true, true);\r\n                    }\r\n                }\r\n            }\r\n            // don't break, we want to show the themes grid right now\r\n\r\n        case 'themes':\r\n        default:\r\n            if(@$_REQUEST['opt']=='install')\r\n            {\r\n                $ntheme = new theme();\r\n                $ntheme->load($_REQUEST['theme']);\r\n\r\n                $website->theme = $ntheme->name;\r\n\r\n                if(!empty($ntheme->styles))\r\n                {\r\n                    $nst = get_object_vars($ntheme->styles);\r\n                    $nst = array_keys($nst);\r\n\r\n                    if(!isset($website->theme_options) || empty($website->theme_options))\r\n                        $website->theme_options = json_decode('{\"style\": \"\"}');\r\n                    $website->theme_options->style = array_shift($nst);\r\n                }\r\n                else\r\n                {\r\n                    if(!isset($website->theme_options) || empty($website->theme_options))\r\n                        $website->theme_options = json_decode('{\"style\": \"\"}');\r\n                    else\r\n                        $website->theme_options->style = \"\";\r\n                }\r\n\r\n                try\r\n                {\r\n                    $website->update();\r\n                    $layout->navigate_notification(t(374, \"Item installed successfully.\"), false);\r\n                }\r\n                catch(Exception $e)\r\n                {\r\n                    $layout->navigate_notification($e->getMessage(), true, true);\r\n                }\r\n            }\r\n\r\n            $themes = theme::list_available();\r\n\r\n            $out = themes_grid($themes);\r\n            break;\r\n\r\n    }\r\n\t\r\n\treturn $out;\r\n}\r\n\r\nfunction themes_grid($list)\r\n{\r\n\tglobal $layout;\r\n\tglobal $website;\r\n    global $user;\r\n    global $current_version;\r\n\t\r\n\t$navibars = new navibars();\t\r\n\t$navibars->title(t(367, 'Themes'));\r\n\r\n    $marketplace = isset($_REQUEST['marketplace']);\r\n\r\n    if($user->permission(\"themes.install\")==\"true\")\r\n    {\r\n        $navibars->add_actions(\r\n            array(\r\n                '<a href=\"#\" id=\"theme-upload-button\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/package_add.png\"> '.t(461, 'Install from file').'</a>'\r\n            )\r\n        );\r\n    }\r\n\r\n    $navibars->add_actions(\r\n        array(\r\n            '<a href=\"?fid=themes&act=theme_sample_content_export\" id=\"theme-sample-content-export-button\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/server_compressed.png\"> '.t(480, 'Export sample content').'</a>'\r\n        )\r\n    );\r\n\r\n\t$grid = new navigrid('themes');\r\n\r\n\t$grid->set_header('\r\n        <div class=\"navibrowse-path ui-corner-all\">\r\n            <input type=\"checkbox\" id=\"theme-available-button\" /><label for=\"theme-available-button\"><img src=\"img/icons/silk/rainbow.png\" width=\"16px\" height=\"16px\" align=\"absbottom\" /> '.t(528, 'Available').'</label>\r\n            '.($user->permission(\"themes.marketplace\")==\"true\"? '<input type=\"checkbox\" id=\"theme-marketplace-button\" /><label for=\"theme-marketplace-button\"><img src=\"img/icons/silk/basket.png\" width=\"16px\" height=\"16px\" align=\"absbottom\" /> '.t(527, 'Marketplace').'</label>' : '').'\r\n        </div>\r\n\t');\r\n\r\n    $layout->add_script('\r\n        $(\"#theme-available-button\").button().on(\"click\", function()\r\n        {\r\n            window.location.replace(\"?fid=themes\");\r\n        });\r\n        $(\"#theme-marketplace-button\").button();\r\n        $(\"#theme-marketplace-button\").button().on(\"click\", function()\r\n        {\r\n            window.location.replace(\"?fid=themes&marketplace\");\r\n        });\r\n\r\n        $(\".navibrowse-path input\").removeAttr(\"checked\");\r\n        $(\"#theme-'.($marketplace? 'marketplace' : 'available').'-button\").attr(\"checked\", \"checked\");\r\n        $(\"#theme-marketplace-button,#theme-available-button\").button(\"refresh\");\r\n    ');\r\n\r\n    if(!$marketplace)\r\n    {\r\n        $grid->item_size(220, 220);\r\n        //$grid->thumbnail_size(138, 150); NV 1.x thumbnail size\r\n        $grid->thumbnail_size(205, 145);\r\n        $grid->highlight_on_click = false;\r\n\r\n        $themes = array();\r\n\r\n        // current website theme\r\n        if(!empty($website->theme))\r\n        {\r\n            $theme = new theme();\r\n            $theme->load($website->theme, true);\r\n            $update_ver = $_SESSION['themes_updates'][$theme->name];\r\n\r\n            if(version_compare($update_ver, $theme->version, '<='))\r\n                $update_ver = '';\r\n            else\r\n                $update_ver = $theme->version.' &raquo; '.$update_ver;\r\n\r\n            $themes[] = array(\r\n                'id'\t=>  $website->theme,\r\n                'name'\t=>\t'<div class=\"navigrid-themes-title navigrid-themes-installed\">'.$theme->title.'</div>',\r\n                'thumbnail' => NAVIGATE_URL.'/themes/'.$website->theme.'/thumbnail.png',\r\n                'header' => '\r\n                '.(file_exists(NAVIGATE_PATH.'/themes/'.$website->theme.'/'.$website->theme.'.info.html')? '<a href=\"#\" class=\"navigrid-themes-info\" theme=\"'.$website->theme.'\" theme-title=\"'.$theme->title.'\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/information.png\"></a>' : '').'\r\n                '.(empty($update_ver)? '' : '\r\n                    <a href=\"#\" class=\"navigrid-themes-update\" theme=\"'.$website->theme.'\" title=\"'.t(285, \"Update\").' '.$update_ver.'\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/asterisk_orange.png\"></a>\r\n                '),\r\n                'footer' => '\r\n                    <a href=\"?fid=websites&act=edit&id='.$website->id.'&tab=7\" class=\"uibutton navigrid-themes-button navigrid-theme-configure\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/wrench_orange.png\"> '.t(200, 'Options').'</a>\r\n                '.(\r\n                    !file_exists(NAVIGATE_PATH.'/themes/'.$website->theme.'/'.$website->theme.'_sample.zip')?\r\n                        '' : '<a href=\"#\" class=\"uibutton navigrid-themes-button navigrid-theme-install-demo\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/wand.png\"> '.t(484, 'Install demo').'</a>'\r\n                )\r\n            );\r\n        }\r\n\r\n        for($t=0; $t < count($list); $t++)\r\n        {\r\n            if($website->theme==$list[$t]['code']) continue;\r\n\r\n            $update_ver = $_SESSION['themes_updates'][$list[$t]['code']];\r\n            if(version_compare($update_ver, $list[$t]['version'], '<='))\r\n                $update_ver = '';\r\n            else\r\n                $update_ver = $list[$t]['version'].' &raquo; '.$update_ver;\r\n\r\n            $themes[] = array(\r\n                'id'\t=>  $list[$t]['code'],\r\n                'name'\t=>\t'<div class=\"navigrid-themes-title\">'.$list[$t]['title'].'</div>',\r\n                'thumbnail' => NAVIGATE_URL.'/themes/'.$list[$t]['code'].'/thumbnail.png',\r\n                'header' => '\r\n                    '.($user->permission(\"themes.delete\")==\"true\"? '<a href=\"#\" class=\"navigrid-themes-remove\" theme=\"'.$list[$t]['code'].'\" theme-title=\"'.$list[$t]['title'].'\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/cancel.png\"></a>' : '').'\r\n                    '.(file_exists(NAVIGATE_PATH.'/themes/'.$list[$t]['code'].'/'.$list[$t]['code'].'.info.html')? '<a href=\"#\" class=\"navigrid-themes-info\" theme=\"'.$list[$t]['code'].'\" theme-title=\"'.$list[$t]['title'].'\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/information.png\"></a>' : '').'\r\n                    '.(empty($update_ver)? '' : '\r\n                    '.($user->permission(\"themes.update\")==\"true\"? '<a href=\"#\" class=\"navigrid-themes-update\" theme=\"'.$list[$t]['code'].'\" title=\"'.t(285, \"Update\").' '.$update_ver.'\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/asterisk_orange.png\"></a>' : '').'\r\n                '),\r\n                'footer' => '\r\n                    '.(file_exists(NAVIGATE_PATH.'/themes/'.$list[$t]['code'].'/demo.html')? '<a href=\"'.NAVIGATE_URL.'/themes/'.$list[$t]['code'].'/demo.html'.'\" class=\"uibutton navigrid-themes-button\" target=\"_blank\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/monitor.png\"> '.t(274, 'Preview').'</a>' : '').'\r\n                    <a href=\"#\" class=\"uibutton navigrid-themes-button navigrid-themes-install\" theme=\"'.$list[$t]['code'].'\" target=\"_blank\" style=\" margin-left: 5px; \"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/world_go.png\"> '.t(365, 'Install').'</a>\r\n                '\r\n            );\r\n        }\r\n\r\n        $grid->items($themes);\r\n\r\n        $navibars->add_content($grid->generate());\r\n\r\n        $navibars->add_content('\r\n            <div id=\"navigrid-themes-install-confirmation\" title=\"'.t(59, 'Confirmation').'\" style=\" display: none; \">\r\n                '.t(371, 'Installing a new theme removes the settings of the old one.').'<br />\r\n                '.t(372, 'The list of available block types may also change.').'<br /><br />\r\n                '.t(373, 'Are you sure you want to continue?').'\r\n            </div>\r\n\r\n            <div id=\"navigrid-themes-information\" title=\"\" style=\" display: none; \"></div>\r\n        ');\r\n\r\n        $navibars->add_content('\r\n            <div id=\"navigrid-themes-install-demo-confirmation\" title=\"'.t(59, 'Confirmation').'\" style=\" display: none; \">\r\n                '.t(483, 'Do you really want to import the default website for the theme selected?').'\r\n            </div>'\r\n        );\r\n\r\n        $navibars->add_content('\r\n            <div id=\"navigrid-themes-remove-confirmation\" title=\"'.t(59, 'Confirmation').'\" style=\" display: none; \">\r\n                '.t(57, 'Do you really want to delete the item?').'\r\n            </div>'\r\n        );\r\n\r\n        $navibars->add_content('\r\n            <div id=\"navigrid-themes-update\" title=\"'.t(285, 'Update').'\" style=\" display: none; \">\r\n                <iframe src=\"about:blank\"\r\n                    class=\"ui-corner-all\"\r\n                    border=\"0\" frameborder=\"0\" allowtransparency=\"true\">\r\n                </iframe>\r\n            </div>'\r\n        );\r\n    }\r\n    else\r\n    {\r\n        $html = '\r\n            <div class=\"navibrowse-path ui-corner-all\">\r\n                <input type=\"checkbox\" id=\"theme-available-button\" /><label for=\"theme-available-button\"><img src=\"img/icons/silk/rainbow.png\" width=\"16px\" height=\"16px\" align=\"absbottom\" /> '.t(528, 'Available').'</label>\r\n                <input type=\"checkbox\" id=\"theme-marketplace-button\" /><label for=\"theme-marketplace-button\"><img src=\"img/icons/silk/basket.png\" width=\"16px\" height=\"16px\" align=\"absbottom\" /> '.t(527, 'Marketplace').'</label>\r\n            </div>\r\n        ';\r\n        $html .= '\r\n            <iframe src=\"http://www.navigatecms.com/en/marketplace/themes\"\r\n                    style=\"visibility: hidden; width: 1px; height: 1px;\"\r\n                    class=\"ui-corner-all\"\r\n                    border=\"0\" frameborder=\"0\" allowtransparency=\"true\">\r\n            </iframe>\r\n        ';\r\n\r\n        $navibars->add_content('<div id=\"navigate-content-safe\" class=\"ui-corner-all\">'.$html.'</div>');\r\n\r\n        $layout->add_script('\r\n            $(window).on(\"resize focus blur\", function()\r\n            {\r\n                $(\"#navigate-content-safe iframe\").css({\"width\": 1, \"height\": 1});\r\n\r\n                $(\"#navigate-content-safe iframe\").css({\r\n                    padding: \"0px 4px\",\r\n                    width: $(\".navibrowse-path\").width() + parseInt($(\".navibrowse-path\").css(\"padding-right\")) * 2,\r\n                    height: $(\"#navigate-content-safe\").height() - $(\"#navigate-content-safe div:first\").height() - 24,\r\n                    visibility: \"visible\"\r\n                });\r\n            });\r\n\r\n            $(\"#navigate-content-safe iframe\").on(\"focus blur load\", function(){ $(window).trigger(\"resize\");});\r\n        ');\r\n    }\r\n\r\n    $layout->add_script('\r\n        function navigatecms_marketplace_install_from_hash(hash)\r\n        {\r\n            window.location.replace(\"?fid=themes&act=install_from_hash&hash=\"+hash);\r\n        }\r\n\r\n        if(typeof(window.postMessage) != \"undefined\")\r\n        {\r\n           if(typeof(window.addEventListener) != \"undefined\")\r\n            {\r\n                window.addEventListener(\"message\", function(event) {\r\n                    navigatecms_marketplace_install_from_hash(event.data);\r\n                }, false);\r\n            }\r\n            else\r\n            {\r\n                window.attachEvent(\"onmessage\", function(e) {\r\n                    navigatecms_marketplace_install_from_hash(e.data);\r\n                });\r\n            }\r\n        }\r\n    ');\r\n\r\n    $out = $navibars->generate();\r\n\r\n    $layout->add_script('\r\n\t    $.ajax({\r\n\t        type: \"GET\",\r\n\t        dataType: \"script\",\r\n\t        cache: true,\r\n\t        url: \"lib/packages/themes/themes.js?r='.$current_version->revision.'\",\r\n\t        complete: function()\r\n\t        {\r\n                navigate_themes_init();\r\n\t        }\r\n\t    });\r\n\t');\r\n\r\n\treturn $out;\r\n}\r\n\r\nfunction themes_sample_content_export_form()\r\n{\r\n    // templates, blocks, files, properties\r\n    global $user;\r\n    global $DB;\r\n    global $website;\r\n    global $layout;\r\n    global $theme;\r\n\r\n    $navibars = new navibars();\r\n    $naviforms = new naviforms();\r\n\r\n    $navibars->title(t(367, 'Themes').' / '.t(480, 'Export sample content'));\r\n\r\n    $layout->navigate_media_browser();\t// we can use media browser in this function\r\n\r\n    $navibars->add_actions(\t\tarray(\t'<a href=\"#\" onclick=\"javascript: navigate_media_browser();\" title=\"Ctrl+M\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/images.png\"> '.t(36, 'Media').'</a>'\t));\r\n\r\n    $navibars->add_actions(\r\n        array(\t'<a href=\"#\" onclick=\"navigate_tabform_submit(0);\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/accept.png\"> '.t(34, 'Save').'</a>'\t)\r\n    );\r\n\r\n    $navibars->form();\r\n\r\n    /*\r\n    $navibars->add_tab(t(43, \"Main\"));\r\n\r\n    $navibars->add_tab_content_row(array(\r\n        '<label>'.t(67, 'Title').'</label>',\r\n        $naviforms->textfield('theme-title', $website->name)\r\n    ));\r\n    */\r\n\r\n    $navibars->add_tab(t(16, \"Structure\"));\r\n    // select structure points to export\r\n    $hierarchy = structure::hierarchy(0);\r\n    $categories_list = structure::hierarchyList($hierarchy);\r\n\r\n    $navibars->add_tab_content_row(array(\r\n        '<label>'.t(330, 'Categories').'<br /></label>',\r\n        '<div class=\"category_tree\" id=\"category-tree-parent\">\r\n            <img src=\"img/icons/silk/world.png\" align=\"absmiddle\" /> '.$website->name.\r\n            '<div class=\"tree_ul\">'.$categories_list.'</div>'.\r\n        '</div>',\r\n        '<label>&nbsp;</label>',\r\n        '<button id=\"theme_export_sample_content_select_all_categories\">'.t(481, 'Select all').'</button>'\r\n    ));\r\n\r\n    $navibars->add_tab_content($naviforms->hidden('categories', ''));\r\n\r\n    $layout->add_script('        \r\n        $(\"#category-tree-parent .tree_ul\").jstree({\r\n            plugins: [\"changed\", \"types\", \"checkbox\"],\r\n            \"types\" :\r\n            {\r\n                \"default\":  {   \"icon\": \"img/icons/silk/folder.png\"    },\r\n                \"leaf\":     {   \"icon\": \"img/icons/silk/page_white.png\"      }\r\n            },\r\n            \"checkbox\":\r\n            {\r\n                three_state: false,\r\n                cascade: \"undetermined\"\r\n            },\r\n            \"core\":\r\n            {\r\n                dblclick_toggle: false\r\n            }\r\n        })\r\n        .on(\"dblclick.jstree\", function(e)\r\n        {\r\n            e.preventDefault();\r\n            e.stopPropagation();\r\n        \r\n            var li = $(e.target).closest(\"li\");\r\n            $(\"#category-tree-parent .tree_ul\").jstree(\"open_node\", \"#\" + li[0].id);\r\n        \r\n            var children_nodes = new Array();\r\n            children_nodes.push(li);\r\n            $(li).find(\"li\").each(function() {\r\n                children_nodes.push(\"#\" + $(this)[0].id);\r\n            });\r\n        \r\n            $(\"#category-tree-parent .tree_ul\").jstree(\"select_node\", children_nodes);\r\n        \r\n            return false;\r\n        })\r\n        .on(\"changed.jstree\", function(e, data)\r\n        {        \r\n            var i, j, r = [];\r\n            var categories = new Array();\r\n            $(\"#categories\").val(\"\");       \r\n        \r\n            for(i = 0, j = data.selected.length; i < j; i++)\r\n            {\r\n                var id = data.instance.get_node(data.selected[i]).data.nodeId;\r\n                categories.push(id);\r\n            }\r\n            \r\n            if(categories.length > 0)\r\n                $(\"#categories\").val(categories);                                                                \r\n        });\r\n\r\n        $(\"#theme_export_sample_content_select_all_categories\").on(\"click\", function(e)\r\n        {\r\n            e.stopPropagation();\r\n            e.preventDefault();\r\n            $(\"#category-tree-parent .tree_ul\").jstree(\"select_all\");\r\n            return false;\r\n        });\r\n\t');\r\n\r\n    $navibars->add_tab(t(22, \"Elements\"));\r\n    // select elements to export\r\n    $navitable_items = new navitable(\"items_list\");\r\n    $navitable_items->setURL('?fid=items&act=1');\r\n    $navitable_items->sortBy('date_modified', 'DESC');\r\n\t$navitable_items->setDataIndex('id');\r\n\t$navitable_items->max_rows = 9999999;\r\n    $navitable_items->addCol(\"ID\", 'id', \"40\", \"true\", \"left\");\r\n    $navitable_items->addCol(t(67, 'Title'), 'title', \"350\", \"true\", \"left\");\r\n    $navitable_items->addCol(t(309, 'Social'), 'comments', \"80\", \"true\", \"center\");\r\n    $navitable_items->addCol(t(78, 'Category'), 'category', \"150\", \"true\", \"center\");\r\n    $navitable_items->addCol(t(266, 'Author'), 'author_username', \"100\", \"true\", \"left\");\r\n    $navitable_items->addCol(t(85, 'Date published'), 'dates', \"100\", \"true\", \"center\");\r\n    $navitable_items->addCol(t(80, 'Permission'), 'permission', \"80\", \"true\", \"center\");\r\n    $navitable_items->after_select_callback = ' $(\"#elements\").val(navitable_items_list_selected_rows); ';\r\n    $navitable_items->setLoadCallback('\r\n        if(!themes_export_first_select_elements) \r\n        {\r\n            $(\"#cb_items_list\").trigger(\"click\");\r\n            themes_export_first_select_elements = true; \r\n        }\r\n    ');\r\n    $navibars->add_tab_content($naviforms->hidden('elements', ''));\r\n    $navibars->add_tab_content($navitable_items->generate());\r\n\r\n\r\n    $navibars->add_tab(t(544, \"Block groups\"));\r\n    // select blocks to export\r\n    $navitable_block_groups = new navitable(\"block_groups_list\");\r\n    $navitable_block_groups->setURL('?fid=blocks&act=block_groups_json');\r\n    $navitable_block_groups->sortBy('id', 'DESC');\r\n    $navitable_block_groups->setDataIndex('id');\r\n    $navitable_items->max_rows = 9999999;\r\n    $navitable_block_groups->addCol(\"ID\", 'id', \"80\", \"true\", \"left\");\r\n    $navitable_block_groups->addCol(t(237, 'Code'), 'code', \"120\", \"true\", \"left\");\r\n    $navitable_block_groups->addCol(t(67, 'Title'), 'title', \"200\", \"true\", \"left\");\r\n    $navitable_block_groups->addCol(t(23, 'Blocks'), 'blocks', \"80\", \"true\", \"left\");\r\n    $navitable_block_groups->after_select_callback = ' $(\"#block_groups\").val(navitable_block_groups_list_selected_rows); ';\r\n    $navitable_block_groups->setLoadCallback('\r\n        if(!themes_export_first_select_blockgrp) \r\n        {\r\n            $(\"#cb_block_groups_list\").trigger(\"click\");\r\n            themes_export_first_select_blockgrp = true; \r\n        }\r\n    ');\r\n    $navibars->add_tab_content($naviforms->hidden('block_groups', ''));\r\n    $navibars->add_tab_content($navitable_block_groups->generate());\r\n\r\n\r\n    $navibars->add_tab(t(23, \"Blocks\"));\r\n    // select blocks to export\r\n    $navitable_blocks = new navitable(\"blocks_list\");\r\n    $navitable_blocks->setURL('?fid=blocks&act=1');\r\n    $navitable_blocks->sortBy('id', 'DESC');\r\n    $navitable_blocks->setDataIndex('id');\r\n    $navitable_items->max_rows = 9999999;\r\n    $navitable_blocks->addCol(\"ID\", 'id', \"40\", \"true\", \"left\");\r\n    $navitable_blocks->addCol(t(160, 'Type'), 'type', \"120\", \"true\", \"center\");\r\n    $navitable_blocks->addCol(t(67, 'Title'), 'title', \"400\", \"true\", \"left\");\r\n    $navitable_blocks->addCol(t(85, 'Date published'), 'dates', \"100\", \"true\", \"center\");\r\n    $navitable_blocks->addCol(t(364, 'Access'), 'access', \"40\", \"true\", \"center\");\r\n    $navitable_blocks->addCol(t(65, 'Enabled'), 'enabled', \"40\", \"true\", \"center\");\r\n    $navitable_blocks->after_select_callback = ' $(\"#blocks\").val(navitable_blocks_list_selected_rows); ';\r\n    $navitable_blocks->setLoadCallback('\r\n        if(!themes_export_first_select_blocks) \r\n        {\r\n            $(\"#cb_blocks_list\").trigger(\"click\"); \r\n            themes_export_first_select_blocks = true; \r\n        }\r\n    ');\r\n    $navibars->add_tab_content($naviforms->hidden('blocks', ''));\r\n    $navibars->add_tab_content($navitable_blocks->generate());\r\n\r\n\r\n    $navibars->add_tab(t(250, \"Comments\"));\r\n    // select comments to export\r\n    $navitable_comments = new navitable(\"comments_list\");\r\n    $navitable_comments->setURL('?fid=comments&act=1');\r\n    $navitable_comments->sortBy('date_created', 'desc');\r\n    $navitable_comments->setDataIndex('id');\r\n    $navitable_items->max_rows = 9999999;\r\n    $navitable_comments->addCol(\"ID\", 'id', \"80\", \"true\", \"left\");\r\n    $navitable_comments->addCol(t(180, 'Item'), 'item', \"200\", \"true\", \"left\");\r\n    $navitable_comments->addCol(t(226, 'Date created'), 'date_created', \"100\", \"true\", \"left\");\r\n    $navitable_comments->addCol(t(1, 'User'), 'user', \"100\", \"true\", \"left\");\r\n    $navitable_comments->addCol(t(54, 'Text'), 'message', \"200\", \"true\", \"left\");\r\n    $navitable_comments->addCol(t(68, 'Status'), 'status', \"80\", \"true\", \"center\");\r\n    $navitable_comments->after_select_callback = ' $(\"#comments\").val(navitable_comments_list_selected_rows); ';\r\n    $navitable_comments->setLoadCallback('\r\n        if(!themes_export_first_select_comments) \r\n        {\r\n            $(\"#cb_comments_list\").trigger(\"click\"); \r\n            themes_export_first_select_comments = true; \r\n        }\r\n    ');\r\n    $navibars->add_tab_content($naviforms->hidden('comments', ''));\r\n    $navibars->add_tab_content($navitable_comments->generate());\r\n    \r\n    $navibars->add_tab(t(89, \"Files\"));\r\n    $navibars->add_tab_content_row(\r\n        array(\r\n            '<label>'.t(141, 'Folder').'</label>',\r\n            $naviforms->dropbox('folder', 0, 'folder')\r\n        )\r\n    );\r\n\r\n    $navibars->add_tab_content_row(\r\n        '<div class=\"subcomment\"><span class=\"ui-icon ui-icon-info\" style=\"float: left;\"></span> '.\r\n            t(482, 'All sample files should be placed in a folder. Navigate CMS will also add files used in contents.').\r\n        '</div>'\r\n    );\r\n\r\n    // auto-select everything on load\r\n    $layout->add_script('\r\n        themes_export_first_select_elements = false;\r\n        themes_export_first_select_blockgrp = false;\r\n        themes_export_first_select_blocks   = false;\r\n        themes_export_first_select_comments = false;\r\n\r\n        $(\"#theme_export_sample_content_select_all_categories\").trigger(\"click\");               \r\n    ');\r\n\r\n    return $navibars->generate();\r\n}\r\n\r\n/* TODO: generate a theme from custom templates and blocks... maybe in NVCMS3.0?\r\nfunction themes_export_form()\r\n{\r\n    // templates, blocks, files, properties\r\n    global $user;\r\n    global $DB;\r\n    global $website;\r\n    global $layout;\r\n    global $theme;\r\n\r\n    $navibars = new navibars();\r\n    $naviforms = new naviforms();\r\n\r\n    $navibars->title(t(367, 'Themes').' / '.t(475, 'Export'));\r\n\r\n    $navibars->add_actions(\r\n        array(\t'<a href=\"#\" onclick=\"navigate_tabform_submit(1);\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/accept.png\"> '.t(34, 'Save').'</a>'\t)\r\n    );\r\n\r\n    $navibars->form();\r\n\r\n    $navibars->add_tab(t(43, \"Main\"));\r\n\r\n    $navibars->add_tab_content(\r\n        '<div class=\"subcomment\"><span class=\"ui-icon ui-icon-info\" style=\"float: left;\"></span></div>'\r\n    );\r\n\r\n    $navibars->add_tab_content_row(array(\r\n        '<label>'.t(67, 'Title').'</label>',\r\n        $naviforms->textfield('theme-title', $website->name)\r\n    ));\r\n\r\n    $navibars->add_tab_content_row(array(\r\n        '<label>'.t(237, 'Code').'</label>',\r\n        $naviforms->textfield('theme-name', $website->name)\r\n    ));\r\n\r\n    $layout->add_script('\r\n        $(\"#theme-name\").on(\"keyup\", function()\r\n        {\r\n            var title = $(this).val();\r\n\t\t\ttitle = title.replace(/([\\'\"?:\\+\\&!\u00bf#\\\\\\\\])/g, \"\");\r\n\t\t\ttitle = title.replace(/[.\\s]+/g, \"_\");\r\n            $(this).val(title.toLowerCase());\r\n        });\r\n        $(\"#theme-name\").trigger(\"keyup\");\r\n    ');\r\n\r\n    $navibars->add_tab_content_row(array(\r\n        '<label>'.t(220, 'Version').'</label>',\r\n        $naviforms->textfield('theme-version', '1.0')\r\n    ));\r\n\r\n\r\n    $navibars->add_tab_content_row(array(\r\n        '<label>'.t(266, 'Author').'</label>',\r\n        $naviforms->textfield('theme-author', $user->username)\r\n    ));\r\n\r\n    $navibars->add_tab_content_row(array(\r\n        '<label>'.t(177, 'Website').'</label>',\r\n        $naviforms->textfield('theme-website', $website->absolute_path())\r\n    ));\r\n\r\n    // languages (+auto create dictionary)\r\n    // styles\r\n\r\n    $navibars->add_tab(t(200, \"Properties\"));\r\n    // similar to template properties\r\n\r\n    $navibars->add_tab(t(20, \"Templates\"));\r\n    // select templates to export\r\n\r\n    $navibars->add_tab(t(23, \"Blocks\"));\r\n    // select block types to export\r\n\r\n    $navibars->add_tab(t(89, \"Files\"));\r\n    // upload JS files\r\n    // upload CSS files\r\n    // upload IMG files\r\n    // select files from database to be included\r\n\r\n    // + demo structure, content & blocks?\r\n\r\n    return $navibars->generate();\r\n}\r\n*/\r\n\r\n?>"], "fixing_code": ["<?php\r\nrequire_once(NAVIGATE_PATH.'/lib/packages/webdictionary/webdictionary.class.php');\r\nrequire_once(NAVIGATE_PATH.'/lib/packages/themes/theme.class.php');\r\n\r\nclass template\r\n{\r\n\tpublic $id;\r\n\tpublic $title;\r\n\tpublic $file;\r\n\tpublic $sections;\r\n\tpublic $gallery;\r\n\tpublic $comments;\r\n\tpublic $tags;\r\n\tpublic $statistics;\r\n\tpublic $permission; // 0 => public, 1 => private (only navigate cms users), 2 => hidden\r\n\tpublic $enabled;\r\n\t\r\n\tpublic function load($id)\r\n\t{\r\n\t\tglobal $DB;\r\n\t\tglobal $website;\r\n\t\tglobal $theme;\r\n\t\t\r\n\t\tif(is_numeric($id))\r\n\t\t{\t\t\r\n\t\t\tif($DB->query('SELECT * FROM nv_templates WHERE id = '.intval($id).' AND website = '.$website->id))\r\n\t\t\t{\r\n\t\t\t\t$data = $DB->result();\r\n\t\t\t\t$this->load_from_resultset($data); // there will be as many entries as languages enabled\r\n\t\t\t}\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tif(empty($theme))\r\n\t\t\t{\r\n\t\t\t\t$theme = new theme();\r\n\t\t\t\t$theme->load($website->theme);\r\n\t\t\t}\r\n\r\n\t\t\t$this->load_from_theme($id);\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic function load_from_resultset($rs)\r\n\t{\r\n\t\t$main = $rs[0];\r\n\t\t\r\n\t\t$this->id\t\t\t= $main->id;\r\n\t\t$this->website\t\t= $main->website;\t\t\r\n\t\t$this->title  \t\t= $main->title;\r\n\t\t$this->file\t\t\t= str_replace(array('../', '..\\\\'), '', $main->file);\r\n\t\t$this->sections\t\t= mb_unserialize($main->sections);\r\n\t\t$this->gallery\t\t= $main->gallery;\r\n\t\t$this->comments\t\t= $main->comments;\t\t\r\n\t\t$this->tags\t\t\t= $main->tags;\t\t\r\n\t\t$this->statistics\t= $main->statistics;\t\t\t\t\t\t\r\n\t\t$this->permission\t= $main->permission;\t\t\r\n\t\t$this->enabled\t\t= $main->enabled;\t\t\t\t\t\t\r\n\t}\r\n\t\r\n\tpublic function load_from_theme($id, $theme_name=null)\r\n\t{\r\n\t\tglobal $theme;\r\n\t\tglobal $website;\r\n\r\n\t\t$ws_theme = $theme;\r\n\t\tif(empty($ws_theme) && !empty($theme_name))\r\n\t\t{\r\n\t\t\t$ws_theme = new theme();\r\n\t\t\t$ws_theme->load($theme_name);\r\n\t\t}\r\n\r\n\t\t$template = NULL;\r\n\t\tfor($t=0; $t < count($ws_theme->templates); $t++)\r\n\t\t{\r\n\t\t\tif($ws_theme->templates[$t]->type == $id)\r\n            {\r\n                $template = $ws_theme->templates[$t];\r\n            }\r\n\t\t}\r\n\r\n\t\tif(!$template)\r\n        {\r\n            return;\r\n        }\r\n\r\n        $defaults = array(\r\n            'sections' => array(\r\n                0 => array(\r\n                    'id' => 'main',\r\n                    'name' => '#main#',\r\n                    'editor' => 'tinymce',\r\n                    'width' => '960'\r\n                )\r\n            ),\r\n            'gallery'  => 0,\r\n            'comments' => 0,\r\n            'tags' => 0,\r\n            'statistics' => 1,\r\n            'permission' => 0,\r\n            'enabled' => 1,\r\n            'properties' => array()\r\n        );\r\n\r\n        // filter file path\r\n        $template->file = str_replace(array('../', '..\\\\'), '', $template->file);\r\n\r\n\t\t$this->id\t\t\t= $template->type;\r\n\t\t$this->website\t\t= $website->id;\r\n\t\t$this->title  \t\t= $ws_theme->template_title($template->type);\r\n\t\t$this->file\t\t\t= NAVIGATE_PATH.'/themes/'.$ws_theme->name.'/'.$template->file;\r\n\t\t$this->sections\t\t= (isset($template->sections)? json_decode(json_encode($template->sections), true) : $defaults['sections']);\r\n\t\t$this->gallery\t\t= (isset($template->gallery)? $template->gallery : $defaults['gallery']);\r\n\t\t$this->comments\t\t= (isset($template->comments)? $template->comments : $defaults['comments']);\r\n\t\t$this->tags\t\t\t= (isset($template->tags)? $template->tags : $defaults['tags']);\r\n\t\t$this->statistics\t= (isset($template->statistics)? $template->statistics : $defaults['statistics']);\r\n\t\t$this->permission\t= (isset($template->permission)? $template->permission : $defaults['permission']);\r\n\t\t$this->enabled\t\t= (isset($template->enabled)? $template->enabled : $defaults['enabled']);\r\n        $this->properties   = (isset($template->properties)? (array)$template->properties : $defaults['properties']);\r\n\r\n        // process properties (translate titles, etc.)\r\n        for($p=0; $p < count($this->properties); $p++)\r\n        {\r\n            if($this->properties[$p]->type == 'option')\r\n            {\r\n                $poptions = array();\r\n                foreach($this->properties[$p]->options as $key => $value)\r\n                {\r\n                    $poptions[$key] = $ws_theme->t($value);\r\n                }\r\n\r\n                $this->properties[$p]->options = $poptions;\r\n            }\r\n        }\r\n\t}\r\n\t\r\n\tpublic function load_from_post()\r\n\t{\r\n\t\t$this->title  \t\t= $_REQUEST['title'];\r\n\t\t$this->file\t\t\t= str_replace(array('../', '..\\\\'), '', $_REQUEST['file']);\r\n\t\t$this->permission\t= intval($_REQUEST['permission']);\r\n\t\t$this->enabled\t\t= intval($_REQUEST['enabled']);\t\r\n\t\t\r\n\t\t// sections\r\n\t\t$this->sections\t\t= array();\r\n\t\tfor($s = 0; $s < count($_REQUEST['template-sections-code']); $s++)\r\n\t\t{\r\n\t\t\tif(empty($_REQUEST['template-sections-code'][$s]))\r\n            {\r\n                continue;\r\n            }\r\n\t\t\t$this->sections[] = array(\r\n\t\t\t    'code' => $_REQUEST['template-sections-code'][$s],\r\n\t\t\t\t'name' => $_REQUEST['template-sections-name'][$s],\r\n\t\t\t\t'editor' => $_REQUEST['template-sections-editor'][$s],\r\n\t\t\t\t'width' => $_REQUEST['template-sections-width'][$s]\r\n            );\r\n\t\t}\r\n\t\tif(empty($this->sections))\r\n\t\t{\r\n\t\t\t$this->sections = array(\r\n\t\t\t\t0 => array(\r\n\t\t\t\t\t'code' => 'id',\r\n\t\t\t\t\t'name' => '#main#',\r\n\t\t\t\t\t'editor' => 'tinymce',\r\n\t\t\t\t\t'width' => '960'\r\n\t\t\t\t)\r\n\t\t\t);\r\n\t\t}\r\n\t\t\r\n\t\t$this->gallery\t\t= intval($_REQUEST['gallery']);\t\r\n\t\t$this->comments\t\t= intval($_REQUEST['comments']);\t\r\n\t\t$this->tags\t\t\t= intval($_REQUEST['tags']);\t\r\n\t\t$this->statistics\t= intval($_REQUEST['statistics']);\t\t\t\t\t\t\t\t\r\n\t}\r\n\t\r\n\t\r\n\tpublic function save()\r\n\t{\r\n\t\tif(!empty($this->id))\r\n        {\r\n            return $this->update();\r\n        }\r\n\t\telse\r\n        {\r\n            return $this->insert();\r\n        }\r\n\t}\r\n\t\r\n\tpublic function delete()\r\n\t{\r\n\t\tglobal $DB;\r\n\t\tglobal $website;\r\n\r\n\t\t// remove all old entries\r\n\t\tif(!empty($this->id))\r\n\t\t{\r\n            // remove associated properties values and definitions\r\n            $DB->execute(\"\r\n                DELETE FROM nv_properties_items\r\n                 WHERE property_id IN (\r\n                            SELECT id FROM nv_properties\r\n                            WHERE template = \".intval($this->id).\"\r\n                            AND website = \".$website->id.\"\r\n                       )\r\n                   AND website = \".$website->id\r\n            );\r\n\r\n            $DB->execute(\"\r\n                DELETE FROM nv_properties\r\n                 WHERE template = \".intval($this->id).\"\r\n                   AND website = \".$website->id\r\n            );\r\n\r\n\t\t\t$DB->execute(\"\r\n\t\t\t    DELETE FROM nv_templates\r\n                 WHERE id = \".intval($this->id).\"\r\n                   AND website = \".$website->id\r\n            );\r\n\t\t}\r\n\t\t\r\n\t\treturn $DB->get_affected_rows();\t\t\r\n\t}\r\n\t\r\n\tpublic function insert()\r\n\t{\r\n\t\tglobal $DB;\r\n\t\tglobal $website;\r\n\t\t\r\n\t\t$ok = $DB->execute(' \r\n \t\t\tINSERT INTO nv_templates\r\n\t\t\t\t(id, website, title, file, sections, gallery, comments, tags, statistics, permission, enabled)\r\n\t\t\tVALUES \r\n\t\t\t\t( 0, :website, :title, :file, :sections, :gallery, :comments, :tags, :statistics, :permission, :enabled )',\r\n\t\t\tarray(\r\n\t\t\t\t':website' => value_or_default($this->website, $website->id),\r\n\t\t\t\t':title' => value_or_default($this->title, \"\"),\r\n\t\t\t\t':file' => value_or_default($this->file, \"\"),\r\n\t\t\t\t':sections' => serialize($this->sections),\r\n\t\t\t\t':gallery' => value_or_default($this->gallery, 0),\r\n\t\t\t\t':comments' => value_or_default($this->comments, 0),\r\n\t\t\t\t':tags' => value_or_default($this->tags, 0),\r\n\t\t\t\t':statistics' => value_or_default($this->statistics, 0),\r\n\t\t\t\t':permission' => value_or_default($this->permission, 0),\r\n\t\t\t\t':enabled' => value_or_default($this->enabled, 0)\r\n\t\t\t)\r\n\t\t);\r\n\t\t\t\r\n\t\tif(!$ok)\r\n\t\t\tthrow new Exception($DB->get_last_error());\r\n\t\t\r\n\t\t$this->id = $DB->get_last_id();\r\n\t\t\r\n\t\treturn true;\r\n\t}\r\n\t\r\n\tpublic function update()\r\n\t{\r\n\t\tglobal $DB;\r\n\t\tglobal $website;\r\n\t\t\t\r\n\t\t$ok = $DB->execute(' \r\n \t\t\tUPDATE nv_templates\r\n\t\t\t   SET  title = :title, file = :file, sections = :sections, gallery = :gallery,\r\n\t\t\t    \tcomments = :comments, tags = :tags, statistics = :statistics, \r\n\t\t\t    \tpermission = :permission, enabled = :enabled \r\n\t\t\t WHERE id = :id\r\n\t\t\t   AND website = :website',\r\n\t\t\tarray(\r\n\t\t\t\t':id' => $this->id,\r\n\t\t\t\t':website' => value_or_default($this->website, $website->id),\r\n\t\t\t\t':title' => value_or_default($this->title, \"\"),\r\n\t\t\t\t':file' => value_or_default($this->file, \"\"),\r\n\t\t\t\t':sections' => serialize($this->sections),\r\n\t\t\t\t':gallery' => value_or_default($this->gallery, 0),\r\n\t\t\t\t':comments' => value_or_default($this->comments, 0),\r\n\t\t\t\t':tags' => value_or_default($this->tags, 0),\r\n\t\t\t\t':statistics' => value_or_default($this->statistics, 0),\r\n\t\t\t\t':permission' => value_or_default($this->permission, 0),\r\n\t\t\t\t':enabled' => value_or_default($this->enabled, 0)\r\n\t\t\t)\r\n\t\t);\r\n\t\t\r\n\t\tif(!$ok) throw new Exception($DB->get_last_error());\r\n\t\t\r\n\t\treturn true;\r\n\t}\t\t\r\n\t\r\n\tpublic static function elements($uses=\"\")\r\n\t{\r\n\t\tglobal $DB;\r\n\t\tglobal $website;\r\n\t\t\r\n\t\t$data = array();\r\n\t\t\r\n\t\t// get available theme templates\r\n\t\tif(!empty($website->theme) && empty($theme))\r\n\t\t{\t\t\r\n\t\t\t$theme = new theme();\r\n\t\t\t$theme->load($website->theme);\r\n\t\t\t$out = $theme->templates();\r\n\t\t}\r\n\t\t\t\t\r\n\t\t// merge theme templates with custom templates\r\n\t\tif(is_array($out))\r\n\t\t\t$data = array_merge($data, $out);\r\n\t\t\r\n\t\tif($DB->query('\r\n\t\t    SELECT id, title\r\n\t\t\t  FROM nv_templates\r\n\t\t\t WHERE website = '.$website->id.'\r\n\t\t  ORDER BY title'))\r\n\t\t{\r\n\t\t\t$out = $DB->result();\r\n\t\t}\r\n\r\n\t\tif(is_array($out))\r\n\t\t\t$data = array_merge($data, $out);\r\n\r\n        // clean templates not for the given use\r\n        // for example, don't display \"blog_entry\" template in the \"structure\" template selector\r\n        if(!empty($uses))\r\n        {\r\n            $uses = explode(',', $uses);\r\n            for($t=0; $t < count($data); $t++)\r\n            {\r\n                if(isset($data[$t]->uses) && !empty($data[$t]->uses))\r\n                {\r\n                    $template_uses = explode(',', $data[$t]->uses);\r\n                    $matches = array_intersect($template_uses, $uses);\r\n                    if(empty($matches))\r\n                        $data[$t] = null;\r\n                }\r\n            }\r\n        }\r\n\r\n        $data = array_filter($data);\r\n\r\n\t\treturn $data;\r\n\t}\r\n\r\n\tpublic static function section_name($default)\r\n\t{\r\n\t\tglobal $website;\r\n\t\tglobal $theme;\r\n\t\t\r\n\t\t$out = $default;\r\n\t\t\t\r\n\t\tif(!empty($website->theme))\r\n\t\t{\r\n\t\t\tif(empty($theme))\r\n\t\t\t{\r\n\t\t\t\t$theme = new theme();\r\n\t\t\t\t$theme->load($website->theme);\t\t\t\r\n\t\t\t}\r\n\t\t\t\t\r\n\t\t\t$out = $theme->template_title($default, false);\r\n\t\t}\r\n\t\t\t\r\n\t\tswitch($default)\r\n\t\t{\r\n\t\t\tcase '#main#':\r\n            case 'main':\r\n                if(isset($theme))\r\n                    $out = $theme->t(\"main\");\r\n                if(empty($out) || $out == 'main')\r\n\t\t\t\t    $out = t(238, 'Main content');\r\n\t\t\t\tbreak;\r\n\t\t\t\t\r\n\t\t\tdefault:\t\r\n\t\t}\r\n\t\t\r\n\t\treturn $out;\r\n\t}\r\n\r\n    public static function search($orderby=\"\", $filters=false)\r\n    {\r\n        global $DB;\r\n        global $website;\r\n        global $theme;\r\n\r\n        // retrieve custom templates\r\n        $DB->queryLimit('id,title,NULL as theme,permission,enabled',\r\n                        'nv_templates',\r\n                        'website = '.$website->id,\r\n                        $orderby,\r\n                        0,\r\n                        PHP_INT_MAX);\r\n\r\n        $dataset = $DB->result();\r\n\r\n        // retrieve theme templates\r\n        for($t=0; $t < count($theme->templates); $t++)\r\n        {\r\n            $template = new template();\r\n            $template->load_from_theme($theme->templates[$t]->type);\r\n\r\n            $dataset[] = array(\r\n                'id'            =>  $template->id,\r\n                'title'         =>  $template->title,\r\n                'theme'         =>  $theme->title,\r\n                'permission'    =>  $template->permission,\r\n                'enabled'       =>  $template->enabled\r\n            );\r\n\r\n            unset($template);\r\n        }\r\n\r\n        // filter results\r\n        if(!empty($filters))\r\n        {\r\n            if(!empty($filters['quicksearch']))\r\n            {\r\n                $dataset = array_filter_quicksearch($dataset, $filters['quicksearch']);\r\n            }\r\n        }\r\n\r\n        // reorder results\r\n        // SQL format: column direction (only ONE column allowed)\r\n        // example: id desc\r\n        $column = array();\r\n        list($order_column, $order_direction) = explode(' ', $orderby);\r\n        for($d=0; $d < count($dataset); $d++)\r\n            $column[] = $dataset[$d][$order_column];\r\n\r\n        array_multisort($column, ($order_direction=='desc'? SORT_DESC : SORT_ASC), $dataset);\r\n\r\n        return $dataset;\r\n    }\r\n\r\n    public function backup($type='json')\r\n    {\r\n        global $DB;\r\n        global $website;\r\n\r\n        $out = array();\r\n\r\n        $DB->query('SELECT * FROM nv_templates WHERE website = '.intval($website->id), 'object');\r\n\r\n        if($type='json')\r\n            $out = json_encode($DB->result());\r\n\r\n        return $out;\r\n    }\r\n}\r\n\r\n?>", "<?php\r\nrequire_once(NAVIGATE_PATH.'/lib/packages/themes/theme.class.php');\r\nrequire_once(NAVIGATE_PATH.'/lib/packages/templates/template.class.php');\r\nrequire_once(NAVIGATE_PATH.'/lib/packages/properties/property.class.php');\r\n\r\nfunction run()\r\n{\r\n\tglobal $user;\t\r\n\tglobal $layout;\r\n\tglobal $DB;\r\n\tglobal $website;\r\n\t\r\n\t$out = '';\r\n\t$item = new template();\r\n\t\t\t\r\n\tswitch($_REQUEST['act'])\r\n\t{\r\n        case 'json':\r\n\t\tcase 1:\t// json data retrieval & operations\r\n\t\t\tswitch($_REQUEST['oper'])\r\n\t\t\t{\r\n\t\t\t\tcase 'del':\t// remove rows\r\n\t\t\t\t\t$ids = $_REQUEST['ids'];\r\n\t\t\t\t\tforeach($ids as $id)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t$item->load($id);\r\n\t\t\t\t\t\t$item->delete();\r\n\t\t\t\t\t}\r\n\t\t\t\t\techo json_encode(true);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t\t\r\n\t\t\t\tdefault: // list or search\r\n\r\n                    // we have to merge the theme templates with the custom private templates (which are defined in the DB)\r\n                    // as we don't expect a lot of templates, we will always return the whole dataset\r\n                    // for this reason, paginate is useless\r\n\r\n                    // filter orderby vars\r\n                    if( !in_array($_REQUEST['sord'], array('', 'desc', 'DESC', 'asc', 'ASC')) ||\r\n                        !in_array($_REQUEST['sidx'], array('id', 'title', 'enabled', 'permission'))\r\n                    )\r\n                    {\r\n                        return false;\r\n                    }\r\n                    $orderby = $_REQUEST['sidx'].' '.$_REQUEST['sord'];\r\n\r\n\t\t\t\t\tif(isset($_REQUEST['quicksearch']))\r\n                    {\r\n                        $dataset = template::search($orderby, array('quicksearch' => $_REQUEST['quicksearch']));\r\n                    }\r\n\t                else\r\n                    {\r\n                        $dataset = template::search($orderby);\r\n                    }\r\n\r\n\t\t\t\t\t$total = count($dataset);\r\n\t\t\t\t\t\r\n\t\t\t\t\t$out = array();\t\t\r\n\t\t\t\t\t$permissions = array(\t\r\n\t\t\t\t\t\t\t0 => '<img src=\"img/icons/silk/world.png\" align=\"absmiddle\" /> '.t(69, 'Published'),\r\n\t\t\t\t\t\t\t1 => '<img src=\"img/icons/silk/world_dawn.png\" align=\"absmiddle\" /> '.t(70, 'Private'),\r\n\t\t\t\t\t\t\t2 => '<img src=\"img/icons/silk/world_night.png\" align=\"absmiddle\" /> '.t(81, 'Hidden')\r\n\t\t\t\t\t\t);\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tif(empty($dataset)) $rows = 0;\r\n\t\t\t\t\telse\t\t\t\t$rows = count($dataset);\r\n\t\r\n\t\t\t\t\tfor($i=0; $i < $rows; $i++)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t$out[$i] = array(\r\n\t\t\t\t\t\t\t0\t=> $dataset[$i]['id'],\r\n\t\t\t\t\t\t\t1 \t=> $dataset[$i]['title'],\r\n\t\t\t\t\t\t\t2 \t=> $dataset[$i]['theme'],\r\n\t\t\t\t\t\t\t3\t=> $permissions[$dataset[$i]['permission']],\r\n\t\t\t\t\t\t\t4\t=> (($dataset[$i]['enabled']==1)? '<img src=\"img/icons/silk/accept.png\" />' : '<img src=\"img/icons/silk/cancel.png\" />')\r\n\t\t\t\t\t\t);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tnavitable::jqgridJson($out, 1, 0, PHP_INT_MAX, $total);\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tcore_terminate();\r\n\t\t\tbreak;\r\n\t\t\t\t\r\n\t\tcase 'load':\r\n\t\tcase 2: // edit/new form\t\t\r\n\t\t\tif(!empty($_REQUEST['id']))\r\n\t\t\t{\r\n                if(is_numeric($_REQUEST['id']))\r\n                {\r\n                    $item->load(intval($_REQUEST['id']));\r\n                }\r\n                else\r\n                {\r\n                    $item->load_from_theme($_REQUEST['id']);\r\n                }\r\n\t\t\t}\r\n\t\t\r\n\t\t\tif(isset($_REQUEST['form-sent']))\r\n\t\t\t{\r\n\t\t\t\t$item->load_from_post();\r\n\t\t\t\ttry\r\n\t\t\t\t{\r\n\t\t\t\t\t$item->save();\r\n\t\t\t\t\tif(!empty($_REQUEST['property-enabled']))\r\n\t\t\t\t\t\t$enableds = array_values($_REQUEST['property-enabled']);\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\t$enableds = array();\r\n\t\t\t\t\tproperty::reorder(\"template\", $item->id, $_REQUEST['template-properties-order'], $enableds);\r\n                    $layout->navigate_notification(t(53, \"Data saved successfully.\"), false, false, 'fa fa-check');\r\n\t\t\t\t}\r\n\t\t\t\tcatch(Exception $e)\r\n\t\t\t\t{\r\n\t\t\t\t\t$layout->navigate_notification($e->getMessage(), true, true);\t\r\n\t\t\t\t}\r\n\t\t\t\tusers_log::action($_REQUEST['fid'], $item->id, 'save', $item->title, json_encode($_REQUEST));\t\t\t\t\r\n\t\t\t}\r\n\t\t\telse\r\n            {\r\n                users_log::action($_REQUEST['fid'], $item->id, 'load', $item->title);\r\n            }\r\n\t\t\r\n\t\t\t$out = templates_form($item);\r\n\t\t\tbreak;\r\n\t\t\r\n\t\tcase 'save_template_file':\t// save template html\r\n\t\t\tif(!empty($_REQUEST['id']))\r\n\t\t\t{\r\n\t\t\t\t$item->load(intval($_REQUEST['id']));\t\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t$data = $_REQUEST['templates-file-edit-area'];\r\n\t\t\t\r\n\t\t\t$data = str_replace(\"\\r\\n\", \"\\r\", $data);\r\n\t\t\t\r\n\t\t\t$x = file_put_contents(NAVIGATE_PRIVATE.'/'.$website->id.'/templates/'.$item->file, $data);\r\n\t\t\t\t\t\t\r\n\t\t\techo json_encode(($x > 0));\r\n\t\t\t\r\n\t\t\tsession_write_close();\r\n\t\t\texit;\r\n\t\t\r\n\t\t\tbreak;\t\r\n\t\t\t\r\n\t\tcase 4: // remove \r\n\t\t\tif(!empty($_REQUEST['id']))\r\n\t\t\t{\r\n\t\t\t\t$item->load(intval($_REQUEST['id']));\t\r\n\t\t\t\tif($item->delete() > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\t$layout->navigate_notification(t(55, 'Item removed successfully.'), false);\r\n\t\t\t\t\t$out = templates_list();\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$layout->navigate_notification(t(56, 'Unexpected error.'), false);\r\n\t\t\t\t\t$out = webdictionary_list();\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tusers_log::action($_REQUEST['fid'], $item->id, $item->title, 'remove');\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\t\t\t\r\n\t\tcase 'template_property_load':\r\n\t\t\r\n\t\t\t$property = new property();\r\n\t\t\t\r\n\t\t\tif(!empty($_REQUEST['id']))\r\n            {\r\n                if(is_numeric($_REQUEST['id']))\r\n\t\t\t\t    $property->load(intval($_REQUEST['id']));\r\n                else\r\n                    $property->load_from_theme($_REQUEST['id'], null, 'template', $_REQUEST['template']);\r\n            }\r\n\r\n\t\t\theader('Content-type: text/json');\r\n\r\n\t\t\t$types = property::types();\r\n\t\t\t$property->type_text = $types[$property->type];\r\n\r\n\t\t\techo json_encode($property);\r\n\t\t\t\t\t\t\r\n\t\t\tsession_write_close();\r\n\t\t\texit;\r\n\t\t\tbreak;\t\t\t\r\n\t\t\t\t\t\r\n\t\tcase 'template_property_save': // save property details\r\n\t\t\r\n\t\t\t$property = new property();\r\n\t\t\t\r\n\t\t\tif(!empty($_REQUEST['property-id']))\r\n\t\t\t\t$property->load(intval($_REQUEST['property-id']));\r\n\r\n\t\t\t$property->load_from_post();\r\n\t\t\t$property->save();\r\n\t\t\t\r\n\t\t\theader('Content-type: text/json');\r\n\r\n\t\t\t$types = property::types();\r\n\t\t\t$property->type_text = $types[$property->type];\r\n\r\n\t\t\techo json_encode($property);\t\t\t\r\n\t\t\t\r\n\t\t\tsession_write_close();\r\n\t\t\texit;\r\n\t\t\tbreak;\t\r\n\r\n\t\tcase 'template_property_remove': // remove property\r\n\t\t\r\n\t\t\t$property = new property();\r\n\t\t\t\r\n\t\t\tif(!empty($_REQUEST['property-id']))\r\n\t\t\t\t$property->load(intval($_REQUEST['property-id']));\r\n\r\n\t\t\t$property->delete();\r\n\t\t\t\r\n\t\t\tsession_write_close();\r\n\t\t\texit;\r\n\t\t\tbreak;\t\r\n\r\n\t\t\t\t\t\r\n\t\tcase 0: // list / search result\r\n\t\tdefault:\t\t\t\r\n\t\t\t$out = templates_list();\r\n\t\t\tbreak;\r\n\t}\r\n\t\r\n\treturn $out;\r\n}\r\n\r\nfunction templates_list()\r\n{\r\n\t$navibars = new navibars();\r\n\t$navitable = new navitable(\"templates_list\");\r\n\t\r\n\t$navibars->title(t(20, 'Templates'));\r\n\r\n\t$navibars->add_actions(\r\n\t    array(\r\n\t        '<a href=\"?fid='.$_REQUEST['fid'].'&act=2\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/add.png\"> '.t(38, 'Create').'</a>',\r\n\t\t\t'<a href=\"?fid='.$_REQUEST['fid'].'&act=0\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/application_view_list.png\"> '.t(39, 'List').'</a>',\r\n\t\t\t'search_form'\r\n        )\r\n    );\r\n\t\r\n\tif($_REQUEST['quicksearch']=='true')\r\n    {\r\n        $navitable->setInitialURL(\"?fid=\".$_REQUEST['fid'].'&act=json&_search=true&quicksearch='.$_REQUEST['navigate-quicksearch']);\r\n    }\r\n\t\r\n\t$navitable->setURL('?fid='.$_REQUEST['fid'].'&act=json');\r\n\t$navitable->sortBy('id');\r\n\t$navitable->setDataIndex('id');\r\n\t$navitable->setEditUrl('id', '?fid='.$_REQUEST['fid'].'&act=load&id=');\r\n    $navitable->disableSelect();\r\n\t\r\n\t$navitable->addCol(\"ID\", 'id', \"60\", \"true\", \"left\");\t\r\n\t$navitable->addCol(t(67, 'Title'), 'title', \"260\", \"true\", \"left\");\t\t\r\n\t$navitable->addCol(t(368, 'Theme'), 'theme', \"180\", \"false\", \"left\");\t\r\n\t$navitable->addCol(t(68, 'Status'), 'permission', \"80\", \"true\", \"center\");\r\n\t$navitable->addCol(t(65, 'Enabled'), 'enabled', \"60\", \"true\", \"center\");\t\t\r\n\t\r\n\t$navibars->add_content($navitable->generate());\t\r\n\t\r\n\treturn $navibars->generate();\r\n}\r\n\r\nfunction templates_form($item)\r\n{\r\n\tglobal $user;\r\n\tglobal $DB;\r\n\tglobal $website;\r\n\tglobal $layout;\r\n\t\r\n\t$navibars = new navibars();\r\n\t$naviforms = new naviforms();\r\n\t\r\n\tif(empty($item->id))\r\n    {\r\n        $navibars->title(t(20, 'Templates').' / '.t(38, 'Create'));\r\n    }\r\n\telse\r\n    {\r\n        $navibars->title(t(20, 'Templates').' / '.t(170, 'Edit').' ['.$item->id.']');\r\n    }\r\n\r\n    $readonly = false;\r\n    if(!empty($item->id) && !is_numeric($item->id))\r\n    {\r\n        $layout->navigate_notification(t(432, \"Read only mode\"), false, true);\r\n        $readonly = true;\r\n    }\r\n\telse if(empty($item->id))\r\n\t{\r\n\t\t$navibars->add_actions(\r\n\t\t    array(\r\n\t\t        '<a href=\"#\" onclick=\"navigate_tabform_submit(1);\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/accept.png\"> '.t(34, 'Save').'</a>'\r\n            )\r\n        );\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$navibars->add_actions(\r\n\t\t    array(\r\n\t\t        '<a href=\"#\" onclick=\"navigate_tabform_submit(1);\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/accept.png\"> '.t(34, 'Save').'</a>',\r\n                '<a href=\"#\" onclick=\"navigate_delete_dialog();\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/cancel.png\"> '.t(35, 'Delete').'</a>'\r\n            )\r\n        );\r\n\t\t\r\n\t\t$delete_html = array();\r\n\t\t$delete_html[] = '<div id=\"navigate-delete-dialog\" class=\"hidden\">'.t(57, 'Do you really want to delete this item?').'</div>';\r\n\t\t$delete_html[] = '<script language=\"javascript\" type=\"text/javascript\">';\r\n\t\t$delete_html[] = 'function navigate_delete_dialog()';\t\t\r\n\t\t$delete_html[] = '{';\r\n        $delete_html[] = '$(\"#navigate-delete-dialog\").removeClass(\"hidden\");';\r\n\t\t$delete_html[] = '$(\"#navigate-delete-dialog\").dialog({\r\n\t\t\t\t\t\t\tresizable: true,\r\n\t\t\t\t\t\t\theight: 150,\r\n\t\t\t\t\t\t\twidth: 300,\r\n\t\t\t\t\t\t\tmodal: true,\r\n\t\t\t\t\t\t\ttitle: \"'.t(59, 'Confirmation').'\",\r\n\t\t\t\t\t\t\tbuttons: {\r\n\t\t\t\t\t\t\t\t\"'.t(58, 'Cancel').'\": function() {\r\n\t\t\t\t\t\t\t\t\t$(this).dialog(\"close\");\r\n\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t\"'.t(35, 'Delete').'\": function() {\r\n\t\t\t\t\t\t\t\t\t$(this).dialog(\"close\");\r\n\t\t\t\t\t\t\t\t\twindow.location.href = \"?fid='.$_REQUEST['fid'].'&act=4&id='.$item->id.'\";\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});';\t\t\r\n\t\t$delete_html[] = '}';\t\t\t\t\t\t\t\r\n\t\t$delete_html[] = '</script>';\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t$navibars->add_content(implode(\"\\n\", $delete_html));\r\n\t}\r\n\t\r\n\t$navibars->add_actions(\r\n\t    array(\r\n\t        (!empty($item->id)? '<a href=\"?fid=templates&act=2\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/add.png\"> '.t(38, 'Create').'</a>' : ''),\r\n            '<a href=\"?fid=templates&act=0\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/application_view_list.png\"> '.t(39, 'List').'</a>',\r\n\t\t\t'search_form'\r\n        )\r\n    );\r\n\r\n\t$navibars->form();\r\n\r\n\t$navibars->add_tab(t(43, \"Main\"));\r\n\t\r\n\t$navibars->add_tab_content($naviforms->hidden('form-sent', 'true'));\r\n\t$navibars->add_tab_content($naviforms->hidden('id', $item->id));\t\r\n\t\r\n\t$navibars->add_tab_content_row(\r\n\t    array(\r\n\t        '<label>ID</label>',\r\n\t\t\t'<span>'.(!empty($item->id)? $item->id : t(52, '(new)')).'</span>'\r\n        )\r\n    );\r\n\r\n\t$navibars->add_tab_content_row(\r\n\t    array(\r\n\t        '<label>'.t(67, 'Title').'</label>',\r\n\t\t\t$naviforms->textfield('title', $item->title),\r\n        )\r\n    );\r\n\r\n    if($readonly)\r\n    {\r\n        $navibars->add_tab_content_row(\r\n            array(\r\n                '<label>'.t(82, 'File').'</label>',\r\n                '<span>'.$item->file.'</span>'\r\n            )\r\n        );\r\n    }\r\n    else\r\n    {\r\n        $navibars->add_tab_content_row(\r\n            array(\r\n                '<label>'.t(82, 'File').'</label>',\r\n                '<span>'.NAVIGATE_PRIVATE.'/'.$website->id.'/templates/</span>',\r\n                $naviforms->textfield('file', $item->file, '236px'),\r\n                empty($item->file)? '' : '<a href=\"#\" onclick=\"navigate_templates_editor();\"><img src=\"'.NAVIGATE_URL.'/img/icons/silk/pencil.png\" /></a>'\r\n            )\r\n        );\r\n    }\r\n\t\r\n\t$navibars->add_content('\r\n\t\t<div id=\"templates-file-edit-dialog\" style=\" display: none; \">\r\n\t\t\t<textarea name=\"templates-file-edit-area\" id=\"templates-file-edit-area\" style=\" width: 99%; height: 98%; \">'.htmlentities(@file_get_contents(NAVIGATE_PRIVATE.'/'.$website->id.'/templates/'.$item->file), ENT_COMPAT, 'UTF-8').'</textarea>\r\n\t\t</div>\r\n\t');\r\n\t\t\t\t\t\t\t\r\n\t$layout->add_script('\r\n\t\tvar current_template_editor = null;\r\n\t\tfunction navigate_templates_editor()\r\n\t\t{\r\n\t\t\tvar file = $(\"#file\").val();\r\n\r\n\t\t\t$(\"#templates-file-edit-dialog\").dialog(\r\n\t\t\t{\r\n\t\t\t\ttitle: \\'<img src=\"'.NAVIGATE_URL.'/img/icons/silk/pencil.png\" align=\"absmiddle\" /> '.t(170, 'Edit').' \\' + file,\r\n\t\t\t\tresizable: true,\r\n\t\t\t\tdraggable: true,\r\n\t\t\t\twidth: $(window).width() - 60,\r\n\t\t\t\theight: $(window).height() - 50,\r\n\t\t\t\tposition: { my: \"center\", at: \"center\", of: window },\r\n\t\t\t\tmodal: true,\r\n\t\t\t\topen: function()\r\n\t\t\t\t{\r\n                    current_template_editor = CodeMirror.fromTextArea(\r\n                        $(\"#templates-file-edit-area\")[0],\r\n                        {\r\n                            mode: \"text/html\",\r\n                            tabMode: \"indent\",\r\n                            lineNumbers: true,\r\n                            matchBrackets: true\r\n                        }\r\n                    );\r\n\r\n\t\t\t\t\t$(\".CodeMirror\").css({ width: \"99%\", height: \"98%\"});\r\n\t\t\t\t\t$(\".CodeMirror-scroll\").css({ width: \"100%\", height: \"100%\"});\r\n\t\t\t\t},\r\n\t\t\t\tbeforeClose: function() {\r\n\t\t\t\t    // dialog may be closed by clicking on a footer button or clicking the close \"x\" icon on top\r\n\t\t\t\t    if(current_template_editor)\r\n\t\t\t\t    {\r\n\t\t\t\t        current_template_editor.toTextArea();\r\n\t\t\t\t\t    current_template_editor = null;\r\n                    }\r\n\t\t\t\t},\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\t\"'.t(58, 'Cancel').'\": function() {\r\n\t\t\t\t\t\t$(\"#templates-file-edit-dialog\").dialog(\"close\");\r\n\t\t\t\t\t},\r\n\t\t\t\t\t\"'.t(34, 'Save').'\": function()\r\n\t\t\t\t\t{ \t\t\t\t\t\r\n\t\t\t\t\t\tcurrent_template_editor.toTextArea();\t\t\t\t\t\r\n\t\t\t\t\t\tcurrent_template_editor = null;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t$.ajax({\r\n\t\t\t\t\t\t   type: \"POST\",\r\n\t\t\t\t\t\t   async: false,\r\n\t\t\t\t\t\t   dateType: \"text\",\r\n\t\t\t\t\t\t   url: \"'.NAVIGATE_URL.'/'.NAVIGATE_MAIN.'?fid='.$_REQUEST['fid'].'&id='.$item->id.'&act=save_template_file\",\r\n\t\t\t\t\t\t   data: $(\"#templates-file-edit-area\").serialize(),\r\n\t\t\t\t\t\t   success: function(data)\r\n\t\t\t\t\t\t   {\t\t\t\r\n\t\t\t\t\t\t\t   \tif(data==\"true\")\r\n\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t$(\"#templates-file-edit-dialog\").dialog(\"close\"); \r\n\t\t\t\t\t\t\t\t\tnavigate_notification(\"'.t(235, 'File saved successfully.').'\");\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t$(\"#templates-file-edit-dialog\").dialog(\"close\"); \r\n\t\t\t\t\t\t\t\t\tnavigate_notification(\"'.t(56, 'Unexpected error.').'\");\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t   }\r\n\t\t\t\t\t\t });\r\n\t\t\t\t\t}\t\t\t\t\t\r\n\t\t\t\t}\t\t\t\t\r\n\t\t\t}).dialogExtend(\r\n\t\t\t{\r\n\t\t\t\tmaximizable: true\r\n\t\t\t});\r\n\t\t}\r\n\t');\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t$navibars->add_tab_content_row(\r\n\t    array(\r\n\t        '<label>'.t(68, 'Status').'</label>',\r\n\t\t\t$naviforms->selectfield(\r\n\t\t\t    'permission',\r\n                array(\r\n                        0 => 0,\r\n                        1 => 1,\r\n                        2 => 2\r\n                ),\r\n                array(\r\n                        0 => t(69, 'Published'),\r\n                        1 => t(70, 'Private'),\r\n                        2 => t(81, 'Hidden')\r\n                ),\r\n                $item->permission,\r\n                '',\r\n                false,\r\n                array(\r\n                        0 => t(360, 'Visible to everybody'),\r\n                        1 => t(359, 'Visible only to Navigate CMS users'),\r\n                        2 => t(358, 'Hidden to everybody')\r\n                )\r\n            )\r\n        )\r\n    );\r\n\t\t\t\t\t\t\t\t\t\r\n\t$navibars->add_tab_content_row(\r\n\t    array(\r\n\t        '<label>'.t(62, 'Statistics').'</label>',\r\n\t\t\t$naviforms->checkbox('statistics', $item->statistics),\r\n        )\r\n    );\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t$navibars->add_tab_content_row(\r\n\t    array(\r\n\t        '<label>'.t(65, 'Enabled').'</label>',\r\n\t\t\t$naviforms->checkbox('enabled', $item->enabled),\r\n        )\r\n    );\r\n\r\n\tif(!empty($item->id))\r\n\t{\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t$navibars->add_tab(t(236, \"Sections\"));\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\r\n\t\t$table = new naviorderedtable(\"template_sections_table\");\r\n\t\t$table->setWidth(\"600px\");\r\n\t\t$table->setHiddenInput(\"template-sections-order\");\r\n\r\n\t\t$navibars->add_tab_content( $naviforms->hidden('template-sections-order', \"\") );\t\t\t\r\n\r\n\t\t$table->addHeaderColumn(t(237, 'Code'), 100);\t\t\t\r\n\t\t$table->addHeaderColumn(t(159, 'Name'), 250);\r\n\t\t$table->addHeaderColumn(t(267, 'Editor'), 100);\r\n\t\t$table->addHeaderColumn(t(155, 'Width'), 100);\t\t\t\t\r\n\t\t$table->addHeaderColumn(t(35, 'Remove'), 100);\t\t\r\n\r\n\t\tfor($p=0; $p < count($item->sections); $p++)\r\n\t\t{\r\n\t\t\t$disabled = ($item->sections[$p]['code']=='main');\r\n\t\t\tunset($selected);\r\n\t\t\t$selected = array();\r\n\t\t\t$selected[$item->sections[$p]['editor']] = ' selected=\"selected\" ';\r\n\t\t\t\r\n\t\t\t$select_editor = '<select name=\"template-sections-editor[]\" style=\" width: 125px; \">';\r\n\t\t\t$select_editor.= '\t<option value=\"tinymce\" '.$selected['tinymce'].'>TinyMCE</option>';\r\n\t\t\t$select_editor.= '\t<option value=\"html\" '.$selected['html'].'>'.t(269, 'HTML code').'</option>';\r\n\t\t\t$select_editor.= '\t<option value=\"raw\" '.$selected['raw'].'>'.t(268, 'Raw').'</option>';\t\t\t\r\n\t\t\t$select_editor.= '</select>';\r\n\t\t\t\r\n\t\t\t$table->addRow(\r\n                $p,\r\n                array(\r\n                    array('content' => '<input type=\"text\" name=\"template-sections-code[]\" value=\"'.$item->sections[$p]['code'].'\" style=\"width: 140px;\" />', 'align' => 'left'),\r\n                    array('content' => '<input type=\"text\" name=\"template-sections-name[]\" value=\"'.template::section_name($item->sections[$p]['name']).'\" style=\"width: 290px;\" />', 'align' => 'left'),\r\n                    array('content' => $select_editor, 'align' => 'left'),\r\n                    array('content' => '<div style=\" white-space: nowrap; \"><input type=\"text\" name=\"template-sections-width[]\" value=\"'.template::section_name($item->sections[$p]['width']).'\" style=\"width: 40px;\" /> px</div>', 'align' => 'left'),\r\n                    array('content' => ((!empty($disabled) || $readonly)? '' : '<img src=\"'.NAVIGATE_URL.'/img/icons/silk/cancel.png\" onclick=\"navigate_templates_sections_remove(this);\" />'), 'align' => 'center')\r\n                )\r\n            );\r\n\t\t}\r\n\r\n        if($readonly)\r\n        {\r\n            $navibars->add_tab_content_row(\r\n                array(\r\n                    '<label>'.t(236, 'Sections').'</label>',\r\n                    '<div>'.$table->generate().'</div>'\r\n                )\r\n            );\r\n        }\r\n        else\r\n        {\r\n            $navibars->add_tab_content_row(\r\n                array(\r\n                    '<label>'.t(236, 'Sections').'</label>',\r\n                    '<div>'.$table->generate().'</div>',\r\n                    '<div class=\"subcomment\">\r\n                        <img src=\"img/icons/silk/information.png\" align=\"absmiddle\" /> '.t(72, 'Drag any row to assign priorities').'.\r\n                         '.t(192, 'Double click any row to edit').'\r\n                    </div>'\r\n                )\r\n            );\r\n\r\n            $navibars->add_tab_content_row(\r\n                array(\r\n                    '<label>&nbsp;</label>',\r\n                    '<button id=\"templates-sections-create\"><img src=\"img/icons/silk/add.png\" align=\"absmiddle\" style=\"cursor:pointer;\" /> '.t(38, 'Create').'</button>'\r\n                )\r\n            );\r\n\t\t\r\n        }\r\n\r\n\t\t$navibars->add_content('\r\n\t\t\t<form id=\"templates-sections-edit-dialog\" style=\"display: none;\">\r\n\t\t\t\t'.$naviforms->hidden('section-id', '').'\r\n\t\t\t\t<div class=\"navigate-form-row\">\r\n\t\t\t\t\t<label>'.t(67, 'Title').'</label>\r\n\t\t\t\t\t'.$naviforms->textfield('section-name', '').'\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"navigate-form-row\">\r\n\t\t\t\t\t<label>'.t(237, 'Code').'</label>\r\n\t\t\t\t\t'.$naviforms->textfield('section-code', '').'\t\t\t\t\t\r\n\t\t\t\t</div>\t\t\t\r\n\t\t\t</form>'\r\n        );\r\n\t\t\t\r\n\t\t\r\n\t\t$section_widths = templates_section_widths();\r\n\t\t\r\n\t\t$layout->add_script('\r\n\t\t\t$(\"#templates-sections-create\").on(\"click\", function() {\r\n\t\t\t\tvar tr = \\'<tr id=\"\\'+(new Date().getTime())+\\'\">\\';\r\n\t\t\t\ttr += \\'<td><input type=\"text\" name=\"template-sections-code[]\" value=\"\" style=\"width: 140px;\" /></td>\\';\r\n\t\t\t\ttr += \\'<td><input type=\"text\" name=\"template-sections-name[]\" value=\"\" style=\"width: 290px;\" /></td>\\';\r\n\t\t\t\ttr += \\'<td><select style=\"width: 125px;\" name=\"template-sections-editor[]\"><option selected=\"selected\" value=\"tinymce\">TinyMCE</option><option value=\"html\">'.t(269, 'HTML code').'</option><option value=\"raw\">'.t(268, 'Raw').'</option></select></td>\\';\r\n\t\t\t\ttr += \\'<td><div style=\"white-space: nowrap;\"><input type=\"text\" style=\"width: 40px;\" value=\"950\" name=\"template-sections-width[]\"> px</div></td>\\';\r\n\t\t\t\ttr += \\'<td align=\"center\"><img src=\"'.NAVIGATE_URL.'/img/icons/silk/cancel.png\" onclick=\"navigate_templates_sections_remove(this);\" style=\"cursor:pointer;\" /></td>\\';\t\t\t\t\r\n\t\t\t\ttr += \\'</tr>\\';\r\n\t\t\t\t\r\n\t\t\t\t$(\"#template_sections_table\").find(\"tbody:last\").append(tr);\r\n\t\t\t\t$(\"#template_sections_table\").tableDnD(\r\n\t\t\t\t{\r\n\t\t\t\t\tonDrop: function(table, row) \r\n\t\t\t\t\t{\t\tnavigate_naviorderedtable_template_sections_table_reorder();\t\t}\r\n\t\t\t\t});\t\t\t\r\n\r\n\t\t\t\t$(\\'input[name=\"template-sections-width[]\"]\\').autocomplete(\r\n\t\t\t\t{\r\n\t\t\t\t\tsource: function(request, response) { response('.json_encode($section_widths).'); },\r\n\t\t\t\t\tminLength: 0\t\t\t\r\n\t\t\t\t});\t\t\t\t\r\n\r\n\t\t\t\treturn false;\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\tfunction navigate_templates_sections_remove(el)\r\n\t\t\t{\t\t\t\t\r\n\t\t\t\t$(el).parent().parent().remove();\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t$(\\'input[name=\"template-sections-width[]\"]\\').autocomplete(\r\n\t\t\t{\r\n\t\t\t\tsource: function(request, response) { response('.json_encode($section_widths).'); },\r\n\t\t\t\tminLength: 0\t\t\t\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\t$(document).on(\\'click\\', \\'input[name=\"template-sections-width[]\"]\\', function()\t\t\t\r\n\t\t\t{\r\n\t\t\t\t$(this).autocomplete( \"search\" , $(this).val());\r\n\t\t\t});\r\n\t\t');\r\n\t\t\r\n\t\t$navibars->add_tab_content_row(\r\n\t\t    array(\r\n\t\t        '<label>'.t(210, 'Gallery').'</label>',\r\n\t\t\t\t$naviforms->checkbox('gallery', $item->gallery),\r\n            )\r\n        );\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t$navibars->add_tab_content_row(\r\n\t\t    array(\r\n\t\t        '<label>'.t(250, 'Comments').'</label>',\r\n\t\t\t\t$naviforms->checkbox('comments', $item->comments),\r\n            )\r\n        );\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t$navibars->add_tab_content_row(\r\n\t\t    array(\r\n\t\t        '<label>'.t(265, 'Tags').'</label>',\r\n\t\t\t\t$naviforms->checkbox('tags', $item->tags),\r\n            )\r\n        );\r\n\r\n\r\n\t\t$navibars->add_tab(t(77, \"Properties\"));\r\n\t\r\n\t\t$table = new naviorderedtable(\"template_properties_table\");\r\n\t\t$table->setWidth(\"550px\");\r\n\t\t$table->setHiddenInput(\"template-properties-order\");\r\n\t\t$table->setDblclickCallback(\"navigate_templates_edit_property\");\r\n\t\t\r\n\t\t$navibars->add_tab_content( $naviforms->hidden('template-properties-order', \"\") );\t\t\t\r\n\t\t\r\n\t\t$table->addHeaderColumn(t(159, 'Name'), 250, true);\r\n\t\t$table->addHeaderColumn(t(160, 'Type'), 150);\r\n\t\t$table->addHeaderColumn(t(87, 'Association'), 100);\t\t\r\n\t\t$table->addHeaderColumn(t(65, 'Enabled'), 50);\t\r\n\r\n        $properties = property::elements($item->id);\r\n\t\t$types\t\t= property::types();\r\n\r\n        $element_types = array(\r\n            'item'\t=> \tt(180, 'Item'),\r\n\t\t\t'structure' => t(16, 'Structure'),\r\n\t\t\t'product' => t(214, 'Product')\r\n        );\r\n\t\t\r\n\t\tfor($p=0; $p < count($properties); $p++)\r\n\t\t{\r\n\t\t\t$table->addRow(\r\n                $properties[$p]->id,\r\n                array(\r\n                    array('content' => $properties[$p]->name, 'align' => 'left'),\r\n                    array('content' => $types[$properties[$p]->type], 'align' => 'left'),\r\n                    array('content' => $element_types[$properties[$p]->element], 'align' => 'left'),\r\n                    array('content' => '<input type=\"checkbox\" name=\"property-enabled[]\" class=\"raw-checkbox\" value=\"'.$properties[$p]->id.'\" '.(($properties[$p]->enabled=='1'? ' checked=checked ' : '')).' />', 'align' => 'center'),\r\n                )\r\n            );\r\n\t\t}\r\n\r\n        if($readonly)\r\n        {\r\n            $navibars->add_tab_content_row(\r\n                array(\r\n                    '<label>'.t(77, 'Properties').'</label>',\r\n                    '<div>'.$table->generate().'</div>'\r\n                )\r\n            );\r\n        }\r\n        else\r\n        {\r\n            $navibars->add_tab_content_row(\r\n                array(\r\n                    '<label>'.t(77, 'Properties').'</label>',\r\n                    '<div>'.$table->generate().'</div>',\r\n                    '<div class=\"subcomment\">\r\n                        <img src=\"img/icons/silk/information.png\" align=\"absmiddle\" /> '.t(72, 'Drag any row to assign priorities').'.\r\n                         '.t(192, 'Double click any row to edit').'\r\n                    </div>'\r\n                )\r\n            );\r\n\r\n            $navibars->add_tab_content_row(\r\n                array(\r\n                    '<label>&nbsp;</label>',\r\n                    '<button id=\"templates-properties-create\"><img src=\"img/icons/silk/add.png\" align=\"absmiddle\" /> '.t(38, 'Create').'</button>'\r\n                )\r\n            );\r\n        }\r\n\t\r\n\t\t$navibars->add_content('\r\n\t\t<form id=\"templates-properties-edit-dialog\" style=\"display: none;\">\r\n\t\t\t<div class=\"navigate-form-row\">\r\n\t\t\t\t<label>ID</label>\r\n\t\t\t\t<span id=\"property-id-span\">'.t(52, '(new)').'</span>\r\n\t\t\t\t'.$naviforms->hidden('property-id', '').'\r\n\t\t\t\t'.$naviforms->hidden('property-template', $item->id).'\t\t\t\r\n\t\t\t</div>\t\r\n\t\t\t<div class=\"navigate-form-row\">\r\n\t\t\t\t<label>'.t(67, 'Title').'</label>\r\n\t\t\t\t'.$naviforms->textfield('property-name', '').'\r\n\t\t\t</div>\r\n\t\t\t<div class=\"navigate-form-row\">\r\n\t\t\t\t<label>'.t(87, 'Association').'</label>\r\n\t\t\t\t'.$naviforms->selectfield('property-element', \r\n\t\t\t\t\t\t\t\t\t\t\tarray_keys($element_types),\r\n\t\t\t\t\t\t\t\t\t\t\tarray_values($element_types),\r\n\t\t\t\t\t\t\t\t\t\t\t'value'\r\n\t\t\t\t\t\t\t\t\t\t).'\r\n\t\t\t</div>\t\t\t\r\n\t\t\t<div class=\"navigate-form-row\">\r\n\t\t\t\t<label>'.t(160, 'Type').'</label>\r\n\t\t\t\t'.$naviforms->selectfield('property-type', \r\n\t\t\t\t\t\t\t\t\t\t\tarray_keys($types),\r\n\t\t\t\t\t\t\t\t\t\t\tarray_values($types),\r\n\t\t\t\t\t\t\t\t\t\t\t'value',\r\n\t\t\t\t\t\t\t\t\t\t\t'navigate_templates_property_type_change()'\r\n\t\t\t\t\t\t\t\t\t\t).'\r\n\t\t\t</div>\r\n\t\t\t<div class=\"navigate-form-row\">\r\n\t\t\t\t<label>'.t(200, 'Options').'</label>\r\n\t\t\t\t'.$naviforms->textarea('property-options', '').'\r\n\t\t\t\t<div class=\"subcomment\">\r\n\t\t\t\t\t'.t(201, 'One line per option, formatted like this: value#title').'\r\n\t\t\t\t</div>\t\t\t\t\r\n\t\t\t</div>\r\n\t\t\t<div class=\"navigate-form-row\">\r\n\t\t\t\t<label>'.t(547, 'Multilanguage').'</label>\r\n\t\t\t\t'.$naviforms->checkbox('property-multilanguage', false).'\r\n\t\t\t</div>\r\n\t\t\t<div class=\"navigate-form-row\">\r\n\t\t\t\t<label>'.t(199, 'Default value').'</label>\r\n\t\t\t\t'.$naviforms->textfield('property-dvalue', '').'\t\r\n\t\t\t\t<div class=\"subcomment\">\r\n\t\t\t\t    <span id=\"property-comment-boolean\">'.t(426, 'Enter \"1\" for true, \"0\" for false').'</span>\r\n\t\t\t\t\t<span id=\"property-comment-option\">'.t(202, 'Enter only the value').'</span>\r\n\t\t\t\t\t<span id=\"property-comment-moption\">'.t(212, 'Enter the selected values separated by commas').': 3,5,8</span>\r\n\t\t\t\t\t<span id=\"property-comment-text\">'.t(203, 'Same value for all languages').'</span>\r\n\t\t\t\t\t<span id=\"property-comment-rating\">'.t(223, 'Default is 5 stars, if you want a different number: default_value#number_of_stars').' 5#10</span>\r\n\t\t\t\t\t<span id=\"property-comment-date\">'.t(50, 'Date format').': '.date($user->date_format).'</span>\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t<span id=\"property-comment-color\">'.t(442, 'Hexadecimal color code').': #ffffff</span>\r\n\t\t\t\t\t<span id=\"property-comment-country\">'.t(225, 'Alpha-2 country code').' (es, us, uk...)</span>\r\n\t\t\t\t\t<span id=\"property-comment-file\">'.t(204, 'ID of the file').'</span>\r\n\t\t\t\t\t<span id=\"property-comment-video\">'.t(490, 'ID of the file or public video URL').'</span>\r\n\t\t\t\t\t<span id=\"property-comment-coordinates\">'.t(298, 'Latitude').'#'.t(299, 'Longitude').': 40.689231#-74.044505</span>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"navigate-form-row\">\r\n\t\t\t\t<label>'.t(65, 'Enabled').'</label>\r\n\t\t\t\t'.$naviforms->checkbox('property-enabled', 1).'\r\n\t\t\t</div>\r\n            <div class=\"navigate-form-row\">\r\n\t\t\t\t<label>'.t(550, 'Help text').'</label>\r\n\t\t\t\t'.$naviforms->textfield('property-helper', '').'\r\n\t\t\t</div>\r\n\t\t</form>');\r\n\r\n\t\t$layout->add_script('\r\n\t\t\t$(\"#templates-properties-create\").on(\"click\", function()\r\n\t\t\t{\r\n\t\t\t\tnavigate_templates_edit_property();\r\n\t\t\t\treturn false;\r\n\t\t\t});\r\n\t\t\r\n\t\t\tfunction navigate_templates_edit_property(el)\r\n\t\t\t{\t\r\n\t\t\t\tif(!el)\t// new property\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#property-id\").val(\"\");\r\n\t\t\t\t\t$(\"#property-id-span\").html(\"'.t(52, '(new)').'\");\r\n\t\t\t\t\t$(\"#property-element\").val(\"template\");\r\n\t\t\t\t\t$(\"#property-template\").val(\"'.$item->id.'\");\r\n\t\t\t\t\t$(\"#property-name\").val(\"\");\r\n\t\t\t\t\t$(\"#property-type\").val(\"value\");\r\n\t\t\t\t\t$(\"#property-options\").val(\"\");\r\n\t\t\t\t\t$(\"#property-dvalue\").val(\"\");\r\n\t\t\t\t\t$(\"#property-helper\").val(\"\");\r\n\t\t\t\t\t$(\"#property-multilanguage\").removeAttr(\"checked\");\r\n\t\t\t\t    $(\"#property-enabled\").attr(\"checked\", \"checked\");\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$.ajax({\r\n\t\t\t\t\t   type: \"GET\",\r\n\t\t\t\t\t   async: false,\r\n\t\t\t\t\t   dateType: \"json\",\r\n\t\t\t\t\t   url: \"'.NAVIGATE_URL.'/'.NAVIGATE_MAIN.'?fid=templates&act=template_property_load&template='.$item->id.'&id=\" + $(el).attr(\"id\"),\r\n\t\t\t\t\t   success: function(data)\r\n\t\t\t\t\t   {\r\n\t\t\t\t\t\t   $(\"#property-id-span\").html(data.id);\r\n\t\t\t\t\t\t   $(\"#property-id\").val(data.id);\r\n\t\t\t\t\t\t   $(\"#property-element\").val(data.element);\r\n\t\t\t\t\t\t   $(\"#property-template\").val(data.template);\r\n\t\t\t\t\t\t   $(\"#property-name\").val(data.name);\r\n\t\t\t\t\t\t   $(\"#property-type\").val(data.type);\r\n\t\t\t\t\t\t   $(\"#property-options\").val(data.options);\r\n\t\t\t\t\t\t   $(\"#property-dvalue\").val(data.dvalue);\r\n\t\t\t\t\t\t   $(\"#property-helper\").val(data.helper);\r\n\r\n\t\t\t\t\t\t   if(data.multilanguage==\"true\")\r\n\t\t\t\t\t\t\t   $(\"#property-multilanguage\").attr(\"checked\", \"checked\");\r\n\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t   $(\"#property-multilanguage\").removeAttr(\"checked\");\r\n\r\n\t\t\t\t\t\t   if(data.enabled==\"1\")\r\n\t\t\t\t\t\t\t   $(\"#property-enabled\").attr(\"checked\", \"checked\");\r\n\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t   $(\"#property-enabled\").removeAttr(\"checked\");\r\n\t\t\t\t\t\t\t   \r\n\t\t\t\t\t\t   var options = \"\";\r\n\t\t\t\t\t\t   for(var o in data.options)\r\n\t\t\t\t\t\t   {\r\n\t\t\t\t\t\t\t   options += o + \"#\" + data.options[o] + \"\\n\";\r\n\t\t\t\t\t\t   }\r\n\t\t\t\t\t\t   $(\"#property-options\").val(options);\r\n\r\n\t\t\t\t\t   }\r\n\t\t\t\t\t });\t\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tnavigate_templates_property_type_change();\r\n\t\t\t\t\r\n\t\t\t\tvar navigate_templates_element_types = new Array();\r\n\t\t\t\tnavigate_templates_element_types[\"item\"] = \"'.t(180, 'Item').'\";\r\n\t\t\t\tnavigate_templates_element_types[\"structure\"] = \"'.t(16, 'Structure').'\";\r\n\t\t\t\t//navigate_templates_element_types[\"product\"] = \"'.t(214, 'Product').'\";\r\n\r\n\t\t\t\tif('.($readonly? 'true' : 'false').')\r\n\t\t\t\t{\r\n                    $(\"#templates-properties-edit-dialog\").dialog(\r\n                    {\r\n                        title: \\'<img src=\"img/icons/silk/pencil.png\" align=\"absmiddle\" /> '.t(170, 'Edit').'\\',\r\n                        resizable: true,\r\n                        height: 360,\r\n                        width: 650,\r\n                        modal: true,\r\n                    });\r\n\t\t\t\t}\r\n\t\t\t\telse // show dialog with action buttons\r\n\t\t\t\t{\r\n                    $(\"#templates-properties-edit-dialog\").dialog(\r\n                    {\r\n                        title: \\'<img src=\"img/icons/silk/pencil.png\" align=\"absmiddle\" /> '.t(170, 'Edit').'\\',\r\n                        resizable: true,\r\n                        height: 410,\r\n                        width: 650,\r\n                        modal: true,\r\n                        buttons: {\r\n                            \"'.t(58, 'Cancel').'\": function() {\r\n                                $(this).dialog(\"close\");\r\n                            },\r\n                            \"'.t(35, 'Delete').'\": function() {\r\n                                $.ajax({\r\n                                   type: \"POST\",\r\n                                   async: false,\r\n                                   dateType: \"text\",\r\n                                   url: \"'.NAVIGATE_URL.'/'.NAVIGATE_MAIN.'?fid='.$_REQUEST['fid'].'&act=template_property_remove\",\r\n                                   data: $(\"#templates-properties-edit-dialog\").serialize(),\r\n                                   success: function(msg)\r\n                                   {\r\n                                     $(\"#template_properties_table\").find(\"#\" + $(\"#property-id\").val()).remove();\r\n                                     navigate_naviorderedtable_template_properties_table_reorder();\r\n                                     $(\"#templates-properties-edit-dialog\").dialog(\"close\");\r\n                                   }\r\n                                 });\r\n                            },\r\n                            \"'.t(190, 'Ok').'\": function()\r\n                            {\r\n                                $.ajax({\r\n                                   type: \"POST\",\r\n                                   async: false,\r\n                                   dateType: \"text\",\r\n                                   url: \"'.NAVIGATE_URL.'/'.NAVIGATE_MAIN.'?fid='.$_REQUEST['fid'].'&act=template_property_save\",\r\n                                   data: $(\"#templates-properties-edit-dialog\").serialize(),\r\n                                   success: function(data)\r\n                                   {\r\n                                       if($(\"#property-id\").val() > 0)\r\n                                       {\r\n                                           // update\r\n                                           var tr = $(\"#template_properties_table\").find(\"#\" + $(\"#property-id\").val());\r\n                                           tr.find(\"td\").eq(0).html(data.name);\r\n                                           tr.find(\"td\").eq(1).html(data.type_text);\r\n                                           tr.find(\"td\").eq(2).html(navigate_templates_element_types[data.element]);\r\n                                           tr.find(\"input[type=checkbox]\").attr(\"checked\", (data.enabled==1));\r\n                                       }\r\n                                       else\r\n                                       {\r\n                                           // insert\r\n                                           var checked = \"\";\r\n                                           if(data.enabled) checked = \\' checked=\"checked\" \\';\r\n                                           var tr = \\'<tr id=\"\\'+data.id+\\'\"><td>\\'+data.name+\\'</td><td>\\'+data.type_text+\\'</td><td>\\'+navigate_templates_element_types[data.element]+\\'</td><td align=\"center\"><input name=\"property-enabled[]\" class=\"raw-checkbox\" type=\"checkbox\" value=\"\\'+data.id+\\'\" \\'+checked+\\' /></td></tr>\\';\r\n                                           $(\"#template_properties_table\").find(\"tbody:last\").append(tr);\r\n                                           $(\"#template_properties_table\").find(\"tr:last\").on(\"dblclick\", function() { navigate_templates_edit_property(this); });\r\n                                           $(\"#template_properties_table\").tableDnD(\r\n                                            {\r\n                                                onDrop: function(table, row)\r\n                                                {\t\tnavigate_naviorderedtable_template_properties_table_reorder();\t\t}\r\n                                            });\r\n                                       }\r\n                                       navigate_naviorderedtable_template_properties_table_reorder();\r\n                                       $(\"#templates-properties-edit-dialog\").dialog(\"close\");\r\n                                   }\r\n                                 });\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tfunction navigate_templates_property_type_change()\r\n\t\t\t{\r\n\t\t\t\t$(\"#property-options\").parent().hide();\r\n\t\t\t\t$(\"#property-multilanguage\").parent().hide();\r\n\t\t\t\t$(\"#property-dvalue\").next().find(\"span\").hide();\r\n\t\t\t\t\r\n\t\t\t\tswitch($(\"#property-type\").val())\r\n\t\t\t\t{\t\t\t\t\t\t\r\n\t\t\t\t\tcase \"option\":\r\n\t\t\t\t\t\t$(\"#property-options\").parent().show();\r\n\t\t\t\t\t\t$(\"#property-comment-option\").show();\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tcase \"moption\":\r\n\t\t\t\t\t\t$(\"#property-options\").parent().show();\r\n\t\t\t\t\t\t$(\"#property-comment-moption\").show();\r\n\t\t\t\t\t\tbreak;\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tcase \"text\":\r\n\t\t\t\t\tcase \"textarea\":\r\n\t\t\t\t\tcase \"link\":\r\n\t\t\t\t\tcase \"rich_textarea\":\r\n\t\t\t\t\tcase \"source_code\":\r\n\t\t\t\t\t\t$(\"#property-comment-text\").show();\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tcase \"date\":\r\n\t\t\t\t\tcase \"datetime\":\r\n\t\t\t\t\t\t$(\"#property-comment-date\").show();\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tcase \"image\":\r\n\t\t\t\t\tcase \"file\":\r\n\t\t\t\t\t\t$(\"#property-comment-file\").show();\r\n\t\t\t\t\t\t$(\"#property-multilanguage\").parent().show();\r\n\t\t\t\t\t\tbreak;\r\n\r\n                    case \"video\":\r\n\t\t\t\t\t\t$(\"#property-comment-video\").show();\r\n\t\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\tcase \"rating\":\r\n\t\t\t\t\t\t$(\"#property-comment-rating\").show();\r\n\t\t\t\t\t\tbreak;\t\r\n\r\n                    case \"color\":\r\n\t\t\t\t\t\t$(\"#property-comment-color\").show();\r\n\t\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\tcase \"coordinates\":\r\n\t\t\t\t\t\t$(\"#property-comment-coordinates\").show();\r\n\t\t\t\t\t\tbreak;\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tcase \"country\":\r\n\t\t\t\t\t\t$(\"#property-comment-country\").show();\r\n\t\t\t\t\t\tbreak;\r\n\r\n                    case \"boolean\":\r\n\t\t\t\t\t\t$(\"#property-comment-boolean\").show();\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\r\n\t\t\t\t\tcase \"comment\":\r\n\t\t\t\t\tcase \"value\":\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tnavigate_naviorderedtable_template_properties_table_reorder();\t\r\n\t\t');\t\t\t\r\n\r\n\t}\r\n\r\n\treturn $navibars->generate();\r\n}\r\n\r\n// find all website section widths\r\nfunction templates_section_widths()\r\n{\r\n\tglobal $DB;\r\n\tglobal $website;\r\n\t\r\n\t$DB->query(\r\n\t    'SELECT sections\r\n              FROM nv_templates\r\n             WHERE website = '.intval($website->id),\r\n\r\n        'array'\r\n    );\r\n\t\t\t\t\r\n\t$result = $DB->result();\r\n\t\r\n\t$widths = array();\r\n\tforeach($result as $sections)\r\n\t{\r\n\t\t$sections = mb_unserialize($sections['sections']);\r\n\t\tif(!is_array($sections))\r\n        {\r\n            $sections = array();\r\n        }\r\n\t\tforeach($sections as $section)\r\n\t\t{\r\n\t\t\tif(!empty($section['width']) && !in_array($section['width'], $widths))\r\n\t\t\t\tarray_push($widths, $section['width']);\r\n\t\t}\r\n\t}\t\r\n\t\r\n\treturn $widths;\r\n}\r\n\r\n?>", "<?php\r\nrequire_once(NAVIGATE_PATH.'/lib/packages/themes/theme.class.php');\r\nrequire_once(NAVIGATE_PATH.'/lib/packages/properties/property.class.php');\r\n\r\nfunction run()\r\n{\r\n\tglobal $user;\t\r\n\tglobal $layout;\r\n\tglobal $website;\r\n    global $theme;\r\n    global $DB;\r\n\t\r\n\t$out = '';\r\n\r\n\tswitch($_REQUEST['act'])\r\n\t{\r\n        case 'theme_info':\r\n            echo '<iframe src=\"'.NAVIGATE_URL.'/themes/'.$_REQUEST['theme'].'/'.$_REQUEST['theme'].'.info.html'.'\" scrolling=\"auto\" frameborder=\"0\"  width=\"100%\" height=\"100%\"></iframe>';\r\n            core_terminate();\r\n            break;\r\n\r\n        case 'remove':\r\n            // check the theme is not actually used in any website\r\n            $usages = $DB->query_single(\r\n                'COUNT(*)',\r\n                'nv_websites',\r\n                ' theme = :theme',\r\n                null,\r\n                array(\r\n                    ':theme' => $_REQUEST['theme']\r\n                )\r\n            );\r\n            if($usages == 0)\r\n            {\r\n                try\r\n                {\r\n                    $theme = new theme();\r\n                    $theme->load($_REQUEST['theme']);\r\n                    $status = $theme->delete();\r\n                    echo json_encode($status);\r\n                }\r\n                catch(Exception $e)\r\n                {\r\n                    echo $e->getMessage();\r\n                }\r\n            }\r\n            else\r\n            {\r\n                $status = t(537, \"Can't remove the theme because it is currently being used by another website.\");\r\n                echo $status;\r\n            }\r\n            core_terminate();\r\n            break;\r\n\r\n        /*\r\n        case 'export':\r\n            $out = themes_export_form();\r\n            break;\r\n        */\r\n\r\n        case 'theme_sample_content_import':\r\n            try\r\n            {\r\n                $theme->import_sample();\r\n                $layout->navigate_notification(t(374, \"Item installed successfully.\"), false);\r\n            }\r\n            catch(Exception $e)\r\n            {\r\n                $layout->navigate_notification($e->getMessage(), true, true);\r\n            }\r\n\r\n            $themes = theme::list_available();\r\n            $out = themes_grid($themes);\r\n            break;\r\n\r\n        case 'theme_sample_content_export':\r\n            if(empty($_POST))\r\n                $out = themes_sample_content_export_form();\r\n            else\r\n            {\r\n                $categories = explode(',', $_POST['categories']);\r\n                $folder = $_POST['folder'];\r\n                $items = explode(',', $_POST['elements']);\r\n                $block_groups = explode(',', $_POST['block_groups']);\r\n                $blocks = explode(',', $_POST['blocks']);\r\n                $comments = explode(',', $_POST['comments']);\r\n\r\n                theme::export_sample($categories, $items, $block_groups, $blocks, $comments, $folder);\r\n\r\n                core_terminate();\r\n            }\r\n            break;\r\n\r\n        case 'install_from_hash':\r\n            $url = base64_decode($_GET['hash']);\r\n\r\n            if(!empty($url) && $user->permission(\"themes.install\")==\"true\")\r\n            {\r\n                $error = false;\r\n                parse_str(parse_url($url, PHP_URL_QUERY), $query);\r\n\r\n                $tmp_file = sys_get_temp_dir() . DIRECTORY_SEPARATOR . $query['code'] . '.zip';\r\n                @core_file_curl($url, $tmp_file);\r\n                if(@filesize($tmp_file) == 0)\r\n                {\r\n                    @unlink($tmp_file);\r\n                    // core file curl failed, try using file_get_contents...\r\n                    $tmp = @file_get_contents($url);\r\n                    if(!empty($tmp))\r\n                    {\r\n                        @file_put_contents($tmp_file, $tmp);\r\n                    }\r\n                    unset($tmp);\r\n                }\r\n\r\n                if(@filesize($tmp_file) > 0)\r\n                {\r\n                    // uncompress ZIP and copy it to the themes dir\r\n                    @mkdir(NAVIGATE_PATH.'/themes/'.$query['code']);\r\n\r\n                    $zip = new ZipArchive();\r\n                    $zip_open_status = $zip->open($tmp_file);\r\n                    if($zip_open_status === TRUE)\r\n                    {\r\n                        $zip->extractTo(NAVIGATE_PATH.'/themes/'.$query['code']);\r\n                        $zip->close();\r\n\r\n                        $layout->navigate_notification(t(374, \"Item installed successfully.\"), false);\r\n                    }\r\n                    else // zip extraction failed\r\n                    {\r\n                        $layout->navigate_notification('ERROR '.$zip_open_status, true, true);\r\n                        $error = true;\r\n                    }\r\n                }\r\n                else\r\n                {\r\n                    $layout->navigate_notification(t(56, 'Unexpected error'), true, true);\r\n                    $error = true;\r\n                }\r\n\r\n                if($error)\r\n                {\r\n                    $layout->add_content('\r\n                        <div id=\"navigate_marketplace_install_from_hash_error\">\r\n                            <p>'.t(529, \"It has not been possible to download the item you have just bought from the marketplace.\").'</p>\r\n                            <p>'.t(530, \"You have to visit your Marketplace Dashboard and download the file, then use the <strong>Install from file</strong> button you'll find in the actions bar on the right.\").'</p>\r\n                            <p>'.t(531, \"Sorry for the inconvenience.\").'</p>\r\n                            <a class=\"uibutton\" href=\"http://www.navigatecms.com/en/marketplace/dashboard\" target=\"_blank\"><span class=\"ui-icon ui-icon-extlink\" style=\"float: left;\"></span> '.t(532, \"Navigate CMS Marketplace\").'</a>\r\n                        </div>\r\n                    ');\r\n                    $layout->add_script('\r\n                        $(\"#navigate_marketplace_install_from_hash_error\").dialog({\r\n                            modal: true,\r\n                            title: \"'.t(56, \"Unexpected error\").'\"\r\n                        });\r\n                    ');\r\n                }\r\n            }\r\n            // don't break, we want to show the themes grid right now (theme_upload by browser upload won't trigger)\r\n\r\n        case 'theme_upload':\r\n            if(isset($_FILES['theme-upload']) && $_FILES['theme-upload']['error']==0 &&  $user->permission(\"themes.install\")==\"true\")\r\n            {\r\n                // uncompress ZIP and copy it to the themes dir\r\n                $tmp = trim(substr($_FILES['theme-upload']['name'], 0, strpos($_FILES['theme-upload']['name'], '.')));\r\n                $theme_name = filter_var($tmp, FILTER_SANITIZE_EMAIL);\r\n\r\n                if($tmp!=$theme_name) // INVALID file name\r\n                {\r\n                    $layout->navigate_notification(t(344, 'Security error'), true, true);\r\n                }\r\n                else\r\n                {\r\n                    @mkdir(NAVIGATE_PATH.'/themes/'.$theme_name);\r\n\r\n                    $zip = new ZipArchive;\r\n                    if($zip->open($_FILES['theme-upload']['tmp_name']) === TRUE)\r\n                    {\r\n                        $zip->extractTo(NAVIGATE_PATH.'/themes/'.$theme_name);\r\n                        $zip->close();\r\n\r\n                        $layout->navigate_notification(t(374, \"Item installed successfully.\"), false);\r\n                    }\r\n                    else // zip extraction failed\r\n                    {\r\n                        $layout->navigate_notification(t(262, 'Error uploading file'), true, true);\r\n                    }\r\n                }\r\n            }\r\n            // don't break, we want to show the themes grid right now\r\n\r\n        case 'themes':\r\n        default:\r\n            if(@$_REQUEST['opt']=='install')\r\n            {\r\n                $ntheme = new theme();\r\n                $ntheme->load($_REQUEST['theme']);\r\n\r\n                $website->theme = $ntheme->name;\r\n\r\n                if(!empty($ntheme->styles))\r\n                {\r\n                    $nst = get_object_vars($ntheme->styles);\r\n                    $nst = array_keys($nst);\r\n\r\n                    if(!isset($website->theme_options) || empty($website->theme_options))\r\n                        $website->theme_options = json_decode('{\"style\": \"\"}');\r\n                    $website->theme_options->style = array_shift($nst);\r\n                }\r\n                else\r\n                {\r\n                    if(!isset($website->theme_options) || empty($website->theme_options))\r\n                        $website->theme_options = json_decode('{\"style\": \"\"}');\r\n                    else\r\n                        $website->theme_options->style = \"\";\r\n                }\r\n\r\n                try\r\n                {\r\n                    $website->update();\r\n                    $layout->navigate_notification(t(374, \"Item installed successfully.\"), false);\r\n                }\r\n                catch(Exception $e)\r\n                {\r\n                    $layout->navigate_notification($e->getMessage(), true, true);\r\n                }\r\n            }\r\n\r\n            $themes = theme::list_available();\r\n\r\n            $out = themes_grid($themes);\r\n            break;\r\n\r\n    }\r\n\t\r\n\treturn $out;\r\n}\r\n\r\nfunction themes_grid($list)\r\n{\r\n\tglobal $layout;\r\n\tglobal $website;\r\n    global $user;\r\n    global $current_version;\r\n\t\r\n\t$navibars = new navibars();\t\r\n\t$navibars->title(t(367, 'Themes'));\r\n\r\n    $marketplace = isset($_REQUEST['marketplace']);\r\n\r\n    if($user->permission(\"themes.install\")==\"true\")\r\n    {\r\n        $navibars->add_actions(\r\n            array(\r\n                '<a href=\"#\" id=\"theme-upload-button\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/package_add.png\"> '.t(461, 'Install from file').'</a>'\r\n            )\r\n        );\r\n    }\r\n\r\n    $navibars->add_actions(\r\n        array(\r\n            '<a href=\"?fid=themes&act=theme_sample_content_export\" id=\"theme-sample-content-export-button\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/server_compressed.png\"> '.t(480, 'Export sample content').'</a>'\r\n        )\r\n    );\r\n\r\n\t$grid = new navigrid('themes');\r\n\r\n\t$grid->set_header('\r\n        <div class=\"navibrowse-path ui-corner-all\">\r\n            <input type=\"checkbox\" id=\"theme-available-button\" /><label for=\"theme-available-button\"><img src=\"img/icons/silk/rainbow.png\" width=\"16px\" height=\"16px\" align=\"absbottom\" /> '.t(528, 'Available').'</label>\r\n            '.($user->permission(\"themes.marketplace\")==\"true\"? '<input type=\"checkbox\" id=\"theme-marketplace-button\" /><label for=\"theme-marketplace-button\"><img src=\"img/icons/silk/basket.png\" width=\"16px\" height=\"16px\" align=\"absbottom\" /> '.t(527, 'Marketplace').'</label>' : '').'\r\n        </div>\r\n\t');\r\n\r\n    $layout->add_script('\r\n        $(\"#theme-available-button\").button().on(\"click\", function()\r\n        {\r\n            window.location.replace(\"?fid=themes\");\r\n        });\r\n        $(\"#theme-marketplace-button\").button();\r\n        $(\"#theme-marketplace-button\").button().on(\"click\", function()\r\n        {\r\n            window.location.replace(\"?fid=themes&marketplace\");\r\n        });\r\n\r\n        $(\".navibrowse-path input\").removeAttr(\"checked\");\r\n        $(\"#theme-'.($marketplace? 'marketplace' : 'available').'-button\").attr(\"checked\", \"checked\");\r\n        $(\"#theme-marketplace-button,#theme-available-button\").button(\"refresh\");\r\n    ');\r\n\r\n    if(!$marketplace)\r\n    {\r\n        $grid->item_size(220, 220);\r\n        //$grid->thumbnail_size(138, 150); NV 1.x thumbnail size\r\n        $grid->thumbnail_size(205, 145);\r\n        $grid->highlight_on_click = false;\r\n\r\n        $themes = array();\r\n\r\n        // current website theme\r\n        if(!empty($website->theme))\r\n        {\r\n            $theme = new theme();\r\n            $theme->load($website->theme, true);\r\n            $update_ver = $_SESSION['themes_updates'][$theme->name];\r\n\r\n            if(version_compare($update_ver, $theme->version, '<='))\r\n                $update_ver = '';\r\n            else\r\n                $update_ver = $theme->version.' &raquo; '.$update_ver;\r\n\r\n            $themes[] = array(\r\n                'id'\t=>  $website->theme,\r\n                'name'\t=>\t'<div class=\"navigrid-themes-title navigrid-themes-installed\">'.$theme->title.'</div>',\r\n                'thumbnail' => NAVIGATE_URL.'/themes/'.$website->theme.'/thumbnail.png',\r\n                'header' => '\r\n                '.(file_exists(NAVIGATE_PATH.'/themes/'.$website->theme.'/'.$website->theme.'.info.html')? '<a href=\"#\" class=\"navigrid-themes-info\" theme=\"'.$website->theme.'\" theme-title=\"'.$theme->title.'\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/information.png\"></a>' : '').'\r\n                '.(empty($update_ver)? '' : '\r\n                    <a href=\"#\" class=\"navigrid-themes-update\" theme=\"'.$website->theme.'\" title=\"'.t(285, \"Update\").' '.$update_ver.'\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/asterisk_orange.png\"></a>\r\n                '),\r\n                'footer' => '\r\n                    <a href=\"?fid=websites&act=edit&id='.$website->id.'&tab=7\" class=\"uibutton navigrid-themes-button navigrid-theme-configure\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/wrench_orange.png\"> '.t(200, 'Options').'</a>\r\n                '.(\r\n                    !file_exists(NAVIGATE_PATH.'/themes/'.$website->theme.'/'.$website->theme.'_sample.zip')?\r\n                        '' : '<a href=\"#\" class=\"uibutton navigrid-themes-button navigrid-theme-install-demo\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/wand.png\"> '.t(484, 'Install demo').'</a>'\r\n                )\r\n            );\r\n        }\r\n\r\n        for($t=0; $t < count($list); $t++)\r\n        {\r\n            if($website->theme==$list[$t]['code']) continue;\r\n\r\n            $update_ver = $_SESSION['themes_updates'][$list[$t]['code']];\r\n            if(version_compare($update_ver, $list[$t]['version'], '<='))\r\n                $update_ver = '';\r\n            else\r\n                $update_ver = $list[$t]['version'].' &raquo; '.$update_ver;\r\n\r\n            $themes[] = array(\r\n                'id'\t=>  $list[$t]['code'],\r\n                'name'\t=>\t'<div class=\"navigrid-themes-title\">'.$list[$t]['title'].'</div>',\r\n                'thumbnail' => NAVIGATE_URL.'/themes/'.$list[$t]['code'].'/thumbnail.png',\r\n                'header' => '\r\n                    '.($user->permission(\"themes.delete\")==\"true\"? '<a href=\"#\" class=\"navigrid-themes-remove\" theme=\"'.$list[$t]['code'].'\" theme-title=\"'.$list[$t]['title'].'\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/cancel.png\"></a>' : '').'\r\n                    '.(file_exists(NAVIGATE_PATH.'/themes/'.$list[$t]['code'].'/'.$list[$t]['code'].'.info.html')? '<a href=\"#\" class=\"navigrid-themes-info\" theme=\"'.$list[$t]['code'].'\" theme-title=\"'.$list[$t]['title'].'\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/information.png\"></a>' : '').'\r\n                    '.(empty($update_ver)? '' : '\r\n                    '.($user->permission(\"themes.update\")==\"true\"? '<a href=\"#\" class=\"navigrid-themes-update\" theme=\"'.$list[$t]['code'].'\" title=\"'.t(285, \"Update\").' '.$update_ver.'\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/asterisk_orange.png\"></a>' : '').'\r\n                '),\r\n                'footer' => '\r\n                    '.(file_exists(NAVIGATE_PATH.'/themes/'.$list[$t]['code'].'/demo.html')? '<a href=\"'.NAVIGATE_URL.'/themes/'.$list[$t]['code'].'/demo.html'.'\" class=\"uibutton navigrid-themes-button\" target=\"_blank\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/monitor.png\"> '.t(274, 'Preview').'</a>' : '').'\r\n                    <a href=\"#\" class=\"uibutton navigrid-themes-button navigrid-themes-install\" theme=\"'.$list[$t]['code'].'\" target=\"_blank\" style=\" margin-left: 5px; \"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/world_go.png\"> '.t(365, 'Install').'</a>\r\n                '\r\n            );\r\n        }\r\n\r\n        $grid->items($themes);\r\n\r\n        $navibars->add_content($grid->generate());\r\n\r\n        $navibars->add_content('\r\n            <div id=\"navigrid-themes-install-confirmation\" title=\"'.t(59, 'Confirmation').'\" style=\" display: none; \">\r\n                '.t(371, 'Installing a new theme removes the settings of the old one.').'<br />\r\n                '.t(372, 'The list of available block types may also change.').'<br /><br />\r\n                '.t(373, 'Are you sure you want to continue?').'\r\n            </div>\r\n\r\n            <div id=\"navigrid-themes-information\" title=\"\" style=\" display: none; \"></div>\r\n        ');\r\n\r\n        $navibars->add_content('\r\n            <div id=\"navigrid-themes-install-demo-confirmation\" title=\"'.t(59, 'Confirmation').'\" style=\" display: none; \">\r\n                '.t(483, 'Do you really want to import the default website for the theme selected?').'\r\n            </div>'\r\n        );\r\n\r\n        $navibars->add_content('\r\n            <div id=\"navigrid-themes-remove-confirmation\" title=\"'.t(59, 'Confirmation').'\" style=\" display: none; \">\r\n                '.t(57, 'Do you really want to delete the item?').'\r\n            </div>'\r\n        );\r\n\r\n        $navibars->add_content('\r\n            <div id=\"navigrid-themes-update\" title=\"'.t(285, 'Update').'\" style=\" display: none; \">\r\n                <iframe src=\"about:blank\"\r\n                    class=\"ui-corner-all\"\r\n                    border=\"0\" frameborder=\"0\" allowtransparency=\"true\">\r\n                </iframe>\r\n            </div>'\r\n        );\r\n    }\r\n    else\r\n    {\r\n        $html = '\r\n            <div class=\"navibrowse-path ui-corner-all\">\r\n                <input type=\"checkbox\" id=\"theme-available-button\" /><label for=\"theme-available-button\"><img src=\"img/icons/silk/rainbow.png\" width=\"16px\" height=\"16px\" align=\"absbottom\" /> '.t(528, 'Available').'</label>\r\n                <input type=\"checkbox\" id=\"theme-marketplace-button\" /><label for=\"theme-marketplace-button\"><img src=\"img/icons/silk/basket.png\" width=\"16px\" height=\"16px\" align=\"absbottom\" /> '.t(527, 'Marketplace').'</label>\r\n            </div>\r\n        ';\r\n        $html .= '\r\n            <iframe src=\"http://www.navigatecms.com/en/marketplace/themes\"\r\n                    style=\"visibility: hidden; width: 1px; height: 1px;\"\r\n                    class=\"ui-corner-all\"\r\n                    border=\"0\" frameborder=\"0\" allowtransparency=\"true\">\r\n            </iframe>\r\n        ';\r\n\r\n        $navibars->add_content('<div id=\"navigate-content-safe\" class=\"ui-corner-all\">'.$html.'</div>');\r\n\r\n        $layout->add_script('\r\n            $(window).on(\"resize focus blur\", function()\r\n            {\r\n                $(\"#navigate-content-safe iframe\").css({\"width\": 1, \"height\": 1});\r\n\r\n                $(\"#navigate-content-safe iframe\").css({\r\n                    padding: \"0px 4px\",\r\n                    width: $(\".navibrowse-path\").width() + parseInt($(\".navibrowse-path\").css(\"padding-right\")) * 2,\r\n                    height: $(\"#navigate-content-safe\").height() - $(\"#navigate-content-safe div:first\").height() - 24,\r\n                    visibility: \"visible\"\r\n                });\r\n            });\r\n\r\n            $(\"#navigate-content-safe iframe\").on(\"focus blur load\", function(){ $(window).trigger(\"resize\");});\r\n        ');\r\n    }\r\n\r\n    $layout->add_script('\r\n        function navigatecms_marketplace_install_from_hash(hash)\r\n        {\r\n            window.location.replace(\"?fid=themes&act=install_from_hash&hash=\"+hash);\r\n        }\r\n\r\n        if(typeof(window.postMessage) != \"undefined\")\r\n        {\r\n           if(typeof(window.addEventListener) != \"undefined\")\r\n            {\r\n                window.addEventListener(\"message\", function(event) {\r\n                    navigatecms_marketplace_install_from_hash(event.data);\r\n                }, false);\r\n            }\r\n            else\r\n            {\r\n                window.attachEvent(\"onmessage\", function(e) {\r\n                    navigatecms_marketplace_install_from_hash(e.data);\r\n                });\r\n            }\r\n        }\r\n    ');\r\n\r\n    $out = $navibars->generate();\r\n\r\n    $layout->add_script('\r\n\t    $.ajax({\r\n\t        type: \"GET\",\r\n\t        dataType: \"script\",\r\n\t        cache: true,\r\n\t        url: \"lib/packages/themes/themes.js?r='.$current_version->revision.'\",\r\n\t        complete: function()\r\n\t        {\r\n                navigate_themes_init();\r\n\t        }\r\n\t    });\r\n\t');\r\n\r\n\treturn $out;\r\n}\r\n\r\nfunction themes_sample_content_export_form()\r\n{\r\n    // templates, blocks, files, properties\r\n    global $user;\r\n    global $DB;\r\n    global $website;\r\n    global $layout;\r\n    global $theme;\r\n\r\n    $navibars = new navibars();\r\n    $naviforms = new naviforms();\r\n\r\n    $navibars->title(t(367, 'Themes').' / '.t(480, 'Export sample content'));\r\n\r\n    $layout->navigate_media_browser();\t// we can use media browser in this function\r\n\r\n    $navibars->add_actions(\t\tarray(\t'<a href=\"#\" onclick=\"javascript: navigate_media_browser();\" title=\"Ctrl+M\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/images.png\"> '.t(36, 'Media').'</a>'\t));\r\n\r\n    $navibars->add_actions(\r\n        array(\t'<a href=\"#\" onclick=\"navigate_tabform_submit(0);\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/accept.png\"> '.t(34, 'Save').'</a>'\t)\r\n    );\r\n\r\n    $navibars->form();\r\n\r\n    /*\r\n    $navibars->add_tab(t(43, \"Main\"));\r\n\r\n    $navibars->add_tab_content_row(array(\r\n        '<label>'.t(67, 'Title').'</label>',\r\n        $naviforms->textfield('theme-title', $website->name)\r\n    ));\r\n    */\r\n\r\n    $navibars->add_tab(t(16, \"Structure\"));\r\n    // select structure points to export\r\n    $hierarchy = structure::hierarchy(0);\r\n    $categories_list = structure::hierarchyList($hierarchy);\r\n\r\n    $navibars->add_tab_content_row(array(\r\n        '<label>'.t(330, 'Categories').'<br /></label>',\r\n        '<div class=\"category_tree\" id=\"category-tree-parent\">\r\n            <img src=\"img/icons/silk/world.png\" align=\"absmiddle\" /> '.$website->name.\r\n            '<div class=\"tree_ul\">'.$categories_list.'</div>'.\r\n        '</div>',\r\n        '<label>&nbsp;</label>',\r\n        '<button id=\"theme_export_sample_content_select_all_categories\">'.t(481, 'Select all').'</button>'\r\n    ));\r\n\r\n    $navibars->add_tab_content($naviforms->hidden('categories', ''));\r\n\r\n    $layout->add_script('        \r\n        $(\"#category-tree-parent .tree_ul\").jstree({\r\n            plugins: [\"changed\", \"types\", \"checkbox\"],\r\n            \"types\" :\r\n            {\r\n                \"default\":  {   \"icon\": \"img/icons/silk/folder.png\"    },\r\n                \"leaf\":     {   \"icon\": \"img/icons/silk/page_white.png\"      }\r\n            },\r\n            \"checkbox\":\r\n            {\r\n                three_state: false,\r\n                cascade: \"undetermined\"\r\n            },\r\n            \"core\":\r\n            {\r\n                dblclick_toggle: false\r\n            }\r\n        })\r\n        .on(\"dblclick.jstree\", function(e)\r\n        {\r\n            e.preventDefault();\r\n            e.stopPropagation();\r\n        \r\n            var li = $(e.target).closest(\"li\");\r\n            $(\"#category-tree-parent .tree_ul\").jstree(\"open_node\", \"#\" + li[0].id);\r\n        \r\n            var children_nodes = new Array();\r\n            children_nodes.push(li);\r\n            $(li).find(\"li\").each(function() {\r\n                children_nodes.push(\"#\" + $(this)[0].id);\r\n            });\r\n        \r\n            $(\"#category-tree-parent .tree_ul\").jstree(\"select_node\", children_nodes);\r\n        \r\n            return false;\r\n        })\r\n        .on(\"changed.jstree\", function(e, data)\r\n        {        \r\n            var i, j, r = [];\r\n            var categories = new Array();\r\n            $(\"#categories\").val(\"\");       \r\n        \r\n            for(i = 0, j = data.selected.length; i < j; i++)\r\n            {\r\n                var id = data.instance.get_node(data.selected[i]).data.nodeId;\r\n                categories.push(id);\r\n            }\r\n            \r\n            if(categories.length > 0)\r\n                $(\"#categories\").val(categories);                                                                \r\n        });\r\n\r\n        $(\"#theme_export_sample_content_select_all_categories\").on(\"click\", function(e)\r\n        {\r\n            e.stopPropagation();\r\n            e.preventDefault();\r\n            $(\"#category-tree-parent .tree_ul\").jstree(\"select_all\");\r\n            return false;\r\n        });\r\n\t');\r\n\r\n    $navibars->add_tab(t(22, \"Elements\"));\r\n    // select elements to export\r\n    $navitable_items = new navitable(\"items_list\");\r\n    $navitable_items->setURL('?fid=items&act=1');\r\n    $navitable_items->sortBy('date_modified', 'DESC');\r\n\t$navitable_items->setDataIndex('id');\r\n\t$navitable_items->max_rows = 9999999;\r\n    $navitable_items->addCol(\"ID\", 'id', \"40\", \"true\", \"left\");\r\n    $navitable_items->addCol(t(67, 'Title'), 'title', \"350\", \"true\", \"left\");\r\n    $navitable_items->addCol(t(309, 'Social'), 'comments', \"80\", \"true\", \"center\");\r\n    $navitable_items->addCol(t(78, 'Category'), 'category', \"150\", \"true\", \"center\");\r\n    $navitable_items->addCol(t(266, 'Author'), 'author_username', \"100\", \"true\", \"left\");\r\n    $navitable_items->addCol(t(85, 'Date published'), 'dates', \"100\", \"true\", \"center\");\r\n    $navitable_items->addCol(t(80, 'Permission'), 'permission', \"80\", \"true\", \"center\");\r\n    $navitable_items->after_select_callback = ' $(\"#elements\").val(navitable_items_list_selected_rows); ';\r\n    $navitable_items->setLoadCallback('\r\n        if(!themes_export_first_select_elements) \r\n        {\r\n            $(\"#cb_items_list\").trigger(\"click\");\r\n            themes_export_first_select_elements = true; \r\n        }\r\n    ');\r\n    $navibars->add_tab_content($naviforms->hidden('elements', ''));\r\n    $navibars->add_tab_content($navitable_items->generate());\r\n\r\n\r\n    $navibars->add_tab(t(544, \"Block groups\"));\r\n    // select blocks to export\r\n    $navitable_block_groups = new navitable(\"block_groups_list\");\r\n    $navitable_block_groups->setURL('?fid=blocks&act=block_groups_json');\r\n    $navitable_block_groups->sortBy('id', 'DESC');\r\n    $navitable_block_groups->setDataIndex('id');\r\n    $navitable_items->max_rows = 9999999;\r\n    $navitable_block_groups->addCol(\"ID\", 'id', \"80\", \"true\", \"left\");\r\n    $navitable_block_groups->addCol(t(237, 'Code'), 'code', \"120\", \"true\", \"left\");\r\n    $navitable_block_groups->addCol(t(67, 'Title'), 'title', \"200\", \"true\", \"left\");\r\n    $navitable_block_groups->addCol(t(23, 'Blocks'), 'blocks', \"80\", \"true\", \"left\");\r\n    $navitable_block_groups->after_select_callback = ' $(\"#block_groups\").val(navitable_block_groups_list_selected_rows); ';\r\n    $navitable_block_groups->setLoadCallback('\r\n        if(!themes_export_first_select_blockgrp) \r\n        {\r\n            $(\"#cb_block_groups_list\").trigger(\"click\");\r\n            themes_export_first_select_blockgrp = true; \r\n        }\r\n    ');\r\n    $navibars->add_tab_content($naviforms->hidden('block_groups', ''));\r\n    $navibars->add_tab_content($navitable_block_groups->generate());\r\n\r\n\r\n    $navibars->add_tab(t(23, \"Blocks\"));\r\n    // select blocks to export\r\n    $navitable_blocks = new navitable(\"blocks_list\");\r\n    $navitable_blocks->setURL('?fid=blocks&act=1');\r\n    $navitable_blocks->sortBy('id', 'DESC');\r\n    $navitable_blocks->setDataIndex('id');\r\n    $navitable_items->max_rows = 9999999;\r\n    $navitable_blocks->addCol(\"ID\", 'id', \"40\", \"true\", \"left\");\r\n    $navitable_blocks->addCol(t(160, 'Type'), 'type', \"120\", \"true\", \"center\");\r\n    $navitable_blocks->addCol(t(67, 'Title'), 'title', \"400\", \"true\", \"left\");\r\n    $navitable_blocks->addCol(t(85, 'Date published'), 'dates', \"100\", \"true\", \"center\");\r\n    $navitable_blocks->addCol(t(364, 'Access'), 'access', \"40\", \"true\", \"center\");\r\n    $navitable_blocks->addCol(t(65, 'Enabled'), 'enabled', \"40\", \"true\", \"center\");\r\n    $navitable_blocks->after_select_callback = ' $(\"#blocks\").val(navitable_blocks_list_selected_rows); ';\r\n    $navitable_blocks->setLoadCallback('\r\n        if(!themes_export_first_select_blocks) \r\n        {\r\n            $(\"#cb_blocks_list\").trigger(\"click\"); \r\n            themes_export_first_select_blocks = true; \r\n        }\r\n    ');\r\n    $navibars->add_tab_content($naviforms->hidden('blocks', ''));\r\n    $navibars->add_tab_content($navitable_blocks->generate());\r\n\r\n\r\n    $navibars->add_tab(t(250, \"Comments\"));\r\n    // select comments to export\r\n    $navitable_comments = new navitable(\"comments_list\");\r\n    $navitable_comments->setURL('?fid=comments&act=1');\r\n    $navitable_comments->sortBy('date_created', 'desc');\r\n    $navitable_comments->setDataIndex('id');\r\n    $navitable_items->max_rows = 9999999;\r\n    $navitable_comments->addCol(\"ID\", 'id', \"80\", \"true\", \"left\");\r\n    $navitable_comments->addCol(t(180, 'Item'), 'item', \"200\", \"true\", \"left\");\r\n    $navitable_comments->addCol(t(226, 'Date created'), 'date_created', \"100\", \"true\", \"left\");\r\n    $navitable_comments->addCol(t(1, 'User'), 'user', \"100\", \"true\", \"left\");\r\n    $navitable_comments->addCol(t(54, 'Text'), 'message', \"200\", \"true\", \"left\");\r\n    $navitable_comments->addCol(t(68, 'Status'), 'status', \"80\", \"true\", \"center\");\r\n    $navitable_comments->after_select_callback = ' $(\"#comments\").val(navitable_comments_list_selected_rows); ';\r\n    $navitable_comments->setLoadCallback('\r\n        if(!themes_export_first_select_comments) \r\n        {\r\n            $(\"#cb_comments_list\").trigger(\"click\"); \r\n            themes_export_first_select_comments = true; \r\n        }\r\n    ');\r\n    $navibars->add_tab_content($naviforms->hidden('comments', ''));\r\n    $navibars->add_tab_content($navitable_comments->generate());\r\n    \r\n    $navibars->add_tab(t(89, \"Files\"));\r\n    $navibars->add_tab_content_row(\r\n        array(\r\n            '<label>'.t(141, 'Folder').'</label>',\r\n            $naviforms->dropbox('folder', 0, 'folder')\r\n        )\r\n    );\r\n\r\n    $navibars->add_tab_content_row(\r\n        '<div class=\"subcomment\"><span class=\"ui-icon ui-icon-info\" style=\"float: left;\"></span> '.\r\n            t(482, 'All sample files should be placed in a folder. Navigate CMS will also add files used in contents.').\r\n        '</div>'\r\n    );\r\n\r\n    // auto-select everything on load\r\n    $layout->add_script('\r\n        themes_export_first_select_elements = false;\r\n        themes_export_first_select_blockgrp = false;\r\n        themes_export_first_select_blocks   = false;\r\n        themes_export_first_select_comments = false;\r\n\r\n        $(\"#theme_export_sample_content_select_all_categories\").trigger(\"click\");               \r\n    ');\r\n\r\n    return $navibars->generate();\r\n}\r\n\r\n/* TODO: generate a theme from custom templates and blocks... maybe in NVCMS3.0?\r\nfunction themes_export_form()\r\n{\r\n    // templates, blocks, files, properties\r\n    global $user;\r\n    global $DB;\r\n    global $website;\r\n    global $layout;\r\n    global $theme;\r\n\r\n    $navibars = new navibars();\r\n    $naviforms = new naviforms();\r\n\r\n    $navibars->title(t(367, 'Themes').' / '.t(475, 'Export'));\r\n\r\n    $navibars->add_actions(\r\n        array(\t'<a href=\"#\" onclick=\"navigate_tabform_submit(1);\"><img height=\"16\" align=\"absmiddle\" width=\"16\" src=\"img/icons/silk/accept.png\"> '.t(34, 'Save').'</a>'\t)\r\n    );\r\n\r\n    $navibars->form();\r\n\r\n    $navibars->add_tab(t(43, \"Main\"));\r\n\r\n    $navibars->add_tab_content(\r\n        '<div class=\"subcomment\"><span class=\"ui-icon ui-icon-info\" style=\"float: left;\"></span></div>'\r\n    );\r\n\r\n    $navibars->add_tab_content_row(array(\r\n        '<label>'.t(67, 'Title').'</label>',\r\n        $naviforms->textfield('theme-title', $website->name)\r\n    ));\r\n\r\n    $navibars->add_tab_content_row(array(\r\n        '<label>'.t(237, 'Code').'</label>',\r\n        $naviforms->textfield('theme-name', $website->name)\r\n    ));\r\n\r\n    $layout->add_script('\r\n        $(\"#theme-name\").on(\"keyup\", function()\r\n        {\r\n            var title = $(this).val();\r\n\t\t\ttitle = title.replace(/([\\'\"?:\\+\\&!\u00bf#\\\\\\\\])/g, \"\");\r\n\t\t\ttitle = title.replace(/[.\\s]+/g, \"_\");\r\n            $(this).val(title.toLowerCase());\r\n        });\r\n        $(\"#theme-name\").trigger(\"keyup\");\r\n    ');\r\n\r\n    $navibars->add_tab_content_row(array(\r\n        '<label>'.t(220, 'Version').'</label>',\r\n        $naviforms->textfield('theme-version', '1.0')\r\n    ));\r\n\r\n\r\n    $navibars->add_tab_content_row(array(\r\n        '<label>'.t(266, 'Author').'</label>',\r\n        $naviforms->textfield('theme-author', $user->username)\r\n    ));\r\n\r\n    $navibars->add_tab_content_row(array(\r\n        '<label>'.t(177, 'Website').'</label>',\r\n        $naviforms->textfield('theme-website', $website->absolute_path())\r\n    ));\r\n\r\n    // languages (+auto create dictionary)\r\n    // styles\r\n\r\n    $navibars->add_tab(t(200, \"Properties\"));\r\n    // similar to template properties\r\n\r\n    $navibars->add_tab(t(20, \"Templates\"));\r\n    // select templates to export\r\n\r\n    $navibars->add_tab(t(23, \"Blocks\"));\r\n    // select block types to export\r\n\r\n    $navibars->add_tab(t(89, \"Files\"));\r\n    // upload JS files\r\n    // upload CSS files\r\n    // upload IMG files\r\n    // select files from database to be included\r\n\r\n    // + demo structure, content & blocks?\r\n\r\n    return $navibars->generate();\r\n}\r\n*/\r\n\r\n?>"], "filenames": ["lib/packages/templates/template.class.php", "lib/packages/templates/templates.php", "lib/packages/themes/themes.php"], "buggy_code_start_loc": [51, 280, 102], "buggy_code_end_loc": [171, 971, 110], "fixing_code_start_loc": [51, 280, 102], "fixing_code_end_loc": [188, 1051, 113], "type": "CWE-22", "message": "An issue was discovered in Navigate CMS through 2.8.7. It allows Directory Traversal because lib/packages/templates/template.class.php mishandles ../ and ..\\ substrings.", "other": {"cve": {"id": "CVE-2020-13795", "sourceIdentifier": "cve@mitre.org", "published": "2020-06-03T22:15:11.237", "lastModified": "2020-06-04T21:15:11.470", "vulnStatus": "Modified", "descriptions": [{"lang": "en", "value": "An issue was discovered in Navigate CMS through 2.8.7. It allows Directory Traversal because lib/packages/templates/template.class.php mishandles ../ and ..\\ substrings."}, {"lang": "es", "value": "Se detect\u00f3 un problema en Navigate CMS versiones hasta 2.8.7. Permite un Salto de Directorio porque la biblioteca lib/packages/templates/template.class.php maneja inapropiadamente las subcadenas ../ y ..\\"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "LOW", "integrityImpact": "NONE", "availabilityImpact": "NONE", "baseScore": 5.3, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 3.9, "impactScore": 1.4}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:N/C:P/I:N/A:N", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "NONE", "confidentialityImpact": "PARTIAL", "integrityImpact": "NONE", "availabilityImpact": "NONE", "baseScore": 5.0}, "baseSeverity": "MEDIUM", "exploitabilityScore": 10.0, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-22"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:naviwebs:navigate_cms:*:*:*:*:*:*:*:*", "versionEndIncluding": "2.8.7", "matchCriteriaId": "C51F59AB-DD05-4412-A392-D6137734D260"}]}]}], "references": [{"url": "http://packetstormsecurity.com/files/157940/Navigate-CMS-2.8.7-Directory-Traversal.html", "source": "cve@mitre.org"}, {"url": "https://github.com/NavigateCMS/Navigate-CMS/commit/88b41c7665ac7181be063b7a541dded7b207d9e7", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/NavigateCMS/Navigate-CMS/commit/88b41c7665ac7181be063b7a541dded7b207d9e7"}}