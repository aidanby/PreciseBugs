{"buggy_code": ["<?php\n\nrequire (\"config.php\");\nrequire (\"funcsv2.php\"); //required for errorMessage() function\n//Check session\nsession_start();\n\nif (!$_SESSION['admin_logged_in'])\n{\n\t//check fails\n\theader(\"Location: authenticate.php?status=session\");\n\texit();\n}\n?>\n\n<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\" \"http://www.w3.org/TR/html4/loose.dtd\">\n\n<html>\n<head>\n\t<title>Change CSS File</title>\n\t<meta http-equiv=\"Content-Type\" content=\"text/html; charset=iso-8859-1\" />\n\t<link rel=\"stylesheet\" href=\"./css/style.css\" type=\"text/css\" />\n\t<style type=\"text/css\">\n\t\ttd.cell{\n\t\t\twidth: 2%;\n\t\t\t}\n\t</style>\n\t<script type=\"text/javascript\">\n\tfunction changeColor(color)\n\t{\n\t\tdocument.getElementById(\"color_box\").value = color;\n\t\tdocument.getElementById(\"thecolor\").style.backgroundColor = color;\n\t}\n\t</script>\n</head>\n<body>\n<center>\n<h1>Change CSS File</h1>\n</center>\n<br>\n\n<?php\n\nif (isset($_POST[\"set_css\"]))\n{\n\t//delete style.css file\n\tif (copy(\"./css/\" . $_POST[\"set_css\"], \"./css/style.css\"))\n\t\techo \"<p class=\\\"success\\\">style.css file has been replaced with \" . $_POST[\"set_css\"] . \"</p>\";\n\telse\n\t{\n\t\techo errorMessage() . \"Error: Unable to copy over style.css, are the permissions correct?</p>\";\n\t\texit();\n\t}\n}\nelseif (isset($_POST[\"delete_css\"]))\n{\n\t//delete css file\n\tif (unlink(\"./css/\" . $_POST[\"delete_css\"]))\n\t\techo \"<p class=\\\"success\\\">\" . $_POST[\"delete_css\"] . \" has been deleted</p>\";\n\telse\n\t{\n\t\techo errorMessage() . \"Error: Unable to delete \" . $_POST[\"delete_css\"] . \", are you sure the permissions are correct?</p>\";\n\t\texit();\n\t}\n}\nelseif (isset($_POST[\"create_css\"]))\n{\n\t//create new css file by copying over style.css into new file\n\tif (substr($_POST[\"create_css\"], -4) == \".css\")\n\t{\n\t\tif (!file_exists(\"./css/\" . $_POST[\"create_css\"]))\n\t\t{\n\t\t\tif (copy(\"./css/style.css\", \"./css/\" . $_POST[\"create_css\"]))\n\t\t\t\techo \"<p class=\\\"success\\\">\" . $_POST[\"create_css\"] . \", was created successfuly</p>\";\n\t\t\telse\n\t\t\t{\n\t\t\t\techo errorMessage() . \"Error: Unabled to create \" . $_POST[\"create_css\"] . \", are you sure the permissions are correct?</p>\";\n\t\t\t\texit();\t\t\t\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\techo errorMessage() . \"Error: \" . $_POST[\"create_css\"] . \" already exists, please choose a different name</p>\";\n\t\t\texit();\n\t\t}\n\t}\n\telse\n\t{\n\t\techo errorMessage() . \"Error: Your file doesn't end with .css</p>\";\n\t\texit();\n\t}\n}\n\nif (isset($_POST[\"create_css\"]) || isset($_POST[\"edit_css\"]))\n{\n\t//display color picker\n\t?>\n\t<h2>Color Picker:</h2>\n\t<table style=\"cursor: pointer;\" border=\"0\">\n\t<?php\n\tfunction rgbhex($red, $green, $blue)\n\t{\n\t\treturn sprintf('#%02X%02X%02X', $red, $green, $blue);\n\t}\n\t\n\t//create table of 216 web safe colors\n\tfor ($red = 0; $red < 256; $red = $red + 51)\n\t{\n\t\techo \"<tr>\";\n\t\tfor ($green = 0; $green < 256; $green = $green + 51)\n\t\t{\n\t\t\tfor ($blue = 0; $blue < 256; $blue = $blue + 51)\n\t\t\t{\n\t\t\t\t$hexcolor = rgbhex($red, $green, $blue);\n\t\t\t\techo \"<td bgcolor='\" . $hexcolor . \"' title='\" . $hexcolor . \"' class='cell' onClick=\\\"changeColor('\" . $hexcolor . \"')\\\">&nbsp;</td>\\n\";\n\t\t\t}\n\t\t}\n\t\techo \"</tr>\";\n\t}\n\t\n\t?>\n\t</table>\n\t<br>\n\t<b>Color:</b>\n\t<table border=\"0\"><tr>\n\t<td id=\"thecolor\" align=\"left\" bgcolor=\"#000000\"><input type=\"text\" id=\"color_box\" value=\"#000000\"/>\n\t</td></tr>\n\t</table>\n\t<br>\n\t<?php\n\t\n\tif (isset($_POST[\"create_css\"]))\n\t\t$filename = $_POST[\"create_css\"];\n\tif (isset($_POST[\"edit_css\"]))\n\t\t$filename = $_POST[\"edit_css\"];\n\t//display text box with css in it\n\t?>\n\t<h2>Editing File: <?php echo $filename;?></h2>\n\t<form action=\"<?php echo htmlentities($_SERVER['PHP_SELF']);?>\" method=\"post\">\n\t<input type=\"hidden\" name=\"hidden_filename\" value=\"<?php echo $filename;?>\"/>\n\t<input type=\"hidden\" name=\"current_css_file\" value=\"<?php echo $_POST['current_css_file'];?>\"/>\n\t<textarea name=\"file_contents\" cols=\"120\" rows=\"20\"><?php\n\t//open css file\n\treadfile(\"./css/\" . $filename);\n\t?></textarea>\n\t<br><br>\n\t<input type=\"submit\" value=\"Save File\"/>\n\t</form>\n\t<?php\n\t\n}\n\nif (isset($_POST[\"file_contents\"]))\n{\n\t//save previously edited text into file\n\tif (is_writable(\"./css/\" . $_POST[\"hidden_filename\"]))\n\t{\n\t\t//open file\n\t\t$stream = fopen(\"./css/\" . $_POST[\"hidden_filename\"], \"w\");\n\t\tfwrite($stream, $_POST[\"file_contents\"]);\n\t\tfclose($stream);\n\t\techo \"<p class=\\\"success\\\">\" . $_POST[\"hidden_filename\"] . \", was saved successfuly</p>\";\n\t}\n\telse\n\t{\n\t\techo errorMessage() . \"Error: The file cannot be saved, check the permissions</p>\";\n\t\texit();\n\t}\n\t//if editing the current css file, replace that too\n\tif ($_POST[\"current_css_file\"] == $_POST[\"hidden_filename\"])\n\t{\n\t\tif (copy(\"./css/\" . $_POST[\"hidden_filename\"], \"./css/style.css\"))\n\t\t\techo \"<p class=\\\"success\\\">style.css file has been replaced with \" . $_POST[\"hidden_filename\"] . \"</p>\";\n\t\telse\n\t\t{\n\t\t\techo errorMessage() . \"Error: Unable to copy over style.css, are the permissions correct?</p>\";\n\t\t\texit();\n\t\t}\n\t}\n}\n\nif (!isset($_POST[\"create_css\"]) && !isset($_POST[\"edit_css\"]) && !isset($_POST[\"delete_css\"]) && \n!isset($_POST[\"set_css\"]) && !isset($_POST[\"file_contents\"]))\n{\n\t//save all files in css directory to array\n\t$current_css_file = \"\";\n\t$css_style_md5 = md5_file(\"./css/style.css\");\n\t$number_files = 0;\n\tif ($dh = opendir(\"./css/\"))\n\t{\n\t\twhile (($file = readdir($dh)) !== false)\n\t\t{\n\t\t\tif (filetype(\"./css/\" . $file) == \"file\" && $file != \"index.php\" && $file != \"style.css\" && substr($file, -4) == \".css\")\n\t\t\t{\n\t\t\t\tif (md5_file(\"./css/\" . $file) == $css_style_md5)\n\t\t\t\t\t$current_css_file = $file;\n\t\t\t\t$files_array[$number_files] = $file;\n\t\t\t\t$number_files++;\n\t\t\t}\n\t\t}\n\t\tclosedir($dh);\n\t}\n\techo \"<b>Currently Used CSS File: \" . $current_css_file . \"</b><br><br>\";\n\t?>\n\t\n\t<form action=\"<?php echo htmlentities($_SERVER['PHP_SELF']);?>\" method=\"post\">\n\t<b>Set CSS File:</b><select name=\"set_css\">\n\t<?php\n\tfor ($i = 0; $i < $number_files; $i++)\n\t{\n\t\tif ($files_array[$i] != $current_css_file) //no point setting it to itself...\n\t\t\techo \"<option value=\\\"\" . $files_array[$i] . \"\\\">\" . $files_array[$i] . \"</option>\\n\\t\";\n\t}\n\t?>\n\t</select>\n\t<input type=\"submit\" value=\"Set CSS File\"/>\n\t</form>\n\t<br><br>\n\t\n\t<form action=\"<?php echo htmlentities($_SERVER['PHP_SELF']);?>\" method=\"post\"> \n\t<b>Delete CSS File:</b><select name=\"delete_css\">\n\t<?php\n\tfor ($i = 0; $i < $number_files; $i++)\n\t{\n\t\tif ($files_array[$i] != $current_css_file) //can't delete the file if it's already being used...\n\t\t\techo \"<option value=\\\"\" . $files_array[$i] . \"\\\">\" . $files_array[$i] . \"</option>\\n\\t\";\n\t}\n\t?>\n\t</select>\n\t<input type=\"submit\" value=\"Delete CSS File\"/>\n\t</form>\n\t<br><br>\n\t\n\t<form action=\"<?php echo htmlentities($_SERVER['PHP_SELF']);?>\" method=\"post\">\n\t<input type=\"hidden\" name=\"current_css_file\" value=\"<?php echo $current_css_file;?>\"/>\n\t<b>Edit Existing CSS File:</b><select name=\"edit_css\">\n\t<?php\n\tfor ($i = 0; $i < $number_files; $i++)\n\t{\n\t\techo \"<option value=\\\"\" . $files_array[$i] . \"\\\">\" . $files_array[$i] . \"</option>\\n\\t\";\n\t}\n\t?>\n\t</select>\n\t<input type=\"submit\" value=\"Edit CSS File\"/>\n\t</form>\n\t<br><br>\n\t\n\t<form action=\"<?php echo htmlentities($_SERVER['PHP_SELF']);?>\" method=\"post\"> \n\t<b>Create New CSS File (e.g. mycssfile.css):</b>\n\t<input type=\"text\" size=\"40\" name=\"create_css\"/>\n\t<input type=\"submit\" value=\"Create New CSS File\"/>\n\t</form>\n\t<?php\n}\n?>\n\n<br>\n<br>\n<a href=\"admin.php\"><img src=\"images/admin.png\" border=\"0\" class=\"icon\" alt=\"Admin Page\" title=\"Admin Page\" /></a><a href=\"admin.php\">Return to Admin Page</a>\n</body>\n</html>\n", "<?php\nrequire (\"config.php\");\nrequire_once (\"funcsv2.php\");\n//Check session\nsession_start();\n\nif (!$_SESSION['admin_logged_in'])\n{\n\t//check fails\n\theader(\"Location: authenticate.php?status=session\");\n\texit();\n}\n?>\n\n<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\" \"http://www.w3.org/TR/html4/loose.dtd\">\n\n<html>\n<head>\n\t<title>Edit Torrent in Database</title>\n\t<meta http-equiv=\"Content-Type\" content=\"text/html; charset=iso-8859-1\" />\n\t<link rel=\"stylesheet\" href=\"./css/style.css\" type=\"text/css\" />\n</head>\n<body>\n<h1>Edit Torrent in Database</h1>\n<h2>This page allows you to edit torrents that are already in the database.  If you need to change other things about\nthe torrent please <a href=\"deleter.php\">delete it</a> and add it again.</h2>\n\t\n<?php\n\n//connect to database\nif ($GLOBALS[\"persist\"])\n\t$db = mysql_pconnect($dbhost, $dbuser, $dbpass) or die(errorMessage() . \"Tracker error: can't connect to database - \" . mysql_error() . \"</p>\");\nelse\n\t$db = mysql_connect($dbhost, $dbuser, $dbpass) or die(errorMessage() . \"Tracker error: can't connect to database - \" . mysql_error() . \"</p>\");\nmysql_select_db($database) or die(errorMessage() . \"Error selecting database.</p>\");\n\n//get filename from URL string\nif (isset($_GET['filename'])) {\n\t$filename = $_GET['filename'];\n}\n\n//if not edit database or filename set, display all torrents as links\nif (!isset($_POST[\"editdatabase\"]) && !isset($filename))\n{\n\t?>\n\t<p><strong>Click on a file to edit it:</strong></p>\n\t<table border=\"0\">\n\t<?php\n\t$query = \"SELECT filename FROM \".$prefix.\"namemap ORDER BY filename ASC\";\n\t$rows = mysql_query($query) or die(errorMessage() . \"Can't do SQL query - \" . mysql_error() . \"</p>\");\n\t\n\twhile ($data = mysql_fetch_row($rows))\n\t{\n\t\techo \"<tr><td><a href=\\\"\" . htmlentities($_SERVER['PHP_SELF']) . \"?filename=\" . rawurlencode($data[0]) . \"\\\">\" . $data[0] . \"</a></td></tr>\\n\";\n\t}\n\t?>\n\t</table>\n\t<?php\n}\n\nif (isset($filename) && !isset($_POST[\"editdatabase\"]))\n{\n\t$query = \"SELECT info_hash,filename,url,pubDate FROM \".$prefix.\"namemap WHERE filename = '\" . mysql_real_escape_string($filename) . \"'\";\n\t$rows = mysql_query($query) or die(errorMessage() . \"Can't do SQL query - \" . mysql_error() . \"</p>\");\n\t\n\t$data = mysql_fetch_row($rows); //should be only one entry...\n\t?>\n\t<form action=\"<?php echo htmlentities($_SERVER['PHP_SELF']);?>\" method=\"POST\">\n\t<input type=\"hidden\" name=\"editdatabase\" value=\"1\">\n\t<input type=\"hidden\" name=\"<?php echo $data[0];?>\" value=\"<?php echo $data[0];?>\">\n\t<input type=\"hidden\" name=\"<?php echo $data[0] . \"_old_filename\";?>\" value=\"<?php echo $data[1];?>\">\n\t<table border=\"0\">\n\t<tr><td><b>Info Hash: </b></td><td><?php echo $data[0];?></td></tr>\n\t<tr><td><b>Filename:</b></td><td><input type=\"text\" name=\"<?php echo $data[0] . \"_filename\";?>\" size=\"60\" value=\"<?php echo $data[1];?>\"></td></tr>\n\t<tr><td><b>URL:</b></td><td><input type=\"text\" name=\"<?php echo $data[0] . \"_url\";?>\" size=\"60\" value=\"<?php echo $data[2];?>\"></td></tr>\n\t<tr><td><b>Publication Date:</b></td><td><input type=\"text\" name=\"<?php echo $data[0] . \"_pubDate\";?>\" size=\"60\" value=\"<?php echo $data[3];?>\"></td></tr>\n\t<tr><td><hr></td><td><hr></td></tr>\t\t\n\t\n\t</table>\n\t<br>\n\t<input type=\"submit\" value=\"Edit Entry\">\n\t</form>\n\t\n\t<?php\n}\n\n//write data to database\nif (isset($_POST[\"editdatabase\"]))\n{\n\t$temp_counter = (count($_POST)-1)/5;\n\tarray_shift($_POST);\n\t\n\tfor ($i = 0; $i < $temp_counter; $i++)\n\t{\n\t\t$temp_hash = htmlspecialchars(array_shift($_POST));\n\t\t$old_filename = htmlspecialchars(array_shift($_POST));\n\t\t$temp_filename = array_shift($_POST);\n\t\t$temp_filename = Ltrim($temp_filename);\n\t\t$temp_filename = htmlspecialchars(rtrim($temp_filename));\n\t\t$temp_url = htmlspecialchars(array_shift($_POST));\n\t\t$temp_pubDate = htmlspecialchars(array_shift($_POST));\n\t\t$query = \"UPDATE \".$prefix.\"namemap SET filename=\\\"$temp_filename\\\", url=\\\"$temp_url\\\", pubDate=\\\"$temp_pubDate\\\" WHERE info_hash=\\\"$temp_hash\\\"\";\n\t\tmysql_query($query) or die(errorMessage() . \"Can't do SQL query - \" . mysql_error() . \"</p>\");\n\t\t//if filename changes, rename .torrent\n\t\tif ($old_filename != $temp_filename)\n\t\t\trename(\"torrents/\" . $old_filename . \".torrent\", \"torrents/\" . $temp_filename . \".torrent\");\n\t}\n\t\n\t//run RSS generator\n\trequire_once(\"rss_generator.php\");\n\t\n\techo \"<br><p class=\\\"success\\\">The database was edited successfully!</p>\\n\";\n}\n\n?>\n<br>\n<br>\n<a href=\"admin.php\"><img src=\"images/admin.png\" border=\"0\" class=\"icon\" alt=\"Admin Page\" title=\"Admin Page\" /></a><a href=\"admin.php\">Return to Admin Page</a>\n</body>\n</html>\n", "<?php\nrequire (\"config.php\");\nrequire_once(\"funcsv2.php\");\n//Check session\nsession_start();\n\nif (!$_SESSION['admin_logged_in'])\n{\n\t//check fails\n\theader(\"Location: authenticate.php?status=session\");\n\texit();\n}\n?>\n\n\n<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\" \"http://www.w3.org/TR/html4/loose.dtd\">\n<html>\n<head>\n\t<title>Check Tracker for Expired Peers</title>\n\t<meta http-equiv=\"Content-Type\" content=\"text/html; charset=iso-8859-1\" />\n\t<link rel=\"stylesheet\" type=\"text/css\" href=\"./css/style.css\" />\n</head>\n<body>\n<h1>Check Tracker for Expired Peers</h1>\n<?php\n\n\nerror_reporting(E_ALL);\n//header(\"Content-Type: text/plain\");\n\n//require_once(\"config.php\");\n//require_once(\"funcsv2.php\");\n\n$summaryupdate = array();\n\n// Non-persistant: we lock tables!\n$db = mysql_connect($dbhost, $dbuser, $dbpass) or die(errorMessage() . \"Tracker error: can't connect to database - \".mysql_error() . \"</p>\");\nmysql_select_db($database) or die(errorMessage() . \"Tracker error: can't open database $database - \".mysql_error() . \"</p>\");\n\nif (isset($_GET[\"nolock\"]))\n\t$locking = false;\nelse\n\t$locking = true;\n\n// Assumes success\nif ($locking)\n\tquickQuery(\"LOCK TABLES \".$prefix.\"summary WRITE, \".$prefix.\"namemap READ\");\n\n?>\n<table class=\"torrentlist\" cellspacing=\"1\">\n<!-- Column Headers -->\n<tr>\n\t<th>Name/Info Hash</th>\n\t<th>Seeders</th>\n\t<th>Leechers</th>\n\t<th>Bytes Transfered</th>\n\t<th>Stale Clients</th>\n\t<th>Peer Cache</th>\n</tr>\n<?php\n\n$results = mysql_query(\"SELECT \".$prefix.\"summary.info_hash, seeds, leechers, dlbytes, \".$prefix.\"namemap.filename FROM \".$prefix.\"summary LEFT JOIN \".$prefix.\"namemap ON \".$prefix.\"summary.info_hash = \".$prefix.\"namemap.info_hash\");\n\n$i = 0;\n\nwhile ($row = mysql_fetch_row($results))\n{\n\t$writeout = \"row\" . $i % 2;\n\tlist($hash, $seeders, $leechers, $bytes, $filename) = $row;\n\tif ($locking)\n\t{\n\t\t//peercaching ALWAYS on\n\t\tquickQuery(\"LOCK TABLES \".$prefix.\"x$hash WRITE, \".$prefix.\"y$hash WRITE, \".$prefix.\"summary WRITE\");\n\t}\n\t$results2 = mysql_query(\"SELECT status, COUNT(status) from \".$prefix.\"x$hash GROUP BY status\");\n\techo \"<tr class=\\\"$writeout\\\"><td>\";\n\tif (!is_null($filename))\n\t\techo $filename;\n\telse\n\t\techo $hash;\n\techo \"</td>\";\n\tif (!$results2)\n\t{\n\t\techo \"<td colspan=\\\"4\\\">Unable to process: \".mysql_error().\"</td></tr>\";\n\t\tcontinue;\n\t}\n\n\t$counts = array();\n\twhile ($row = mysql_fetch_row($results2))\n\t\t$counts[$row[0]] = $row[1];\t\n\tif (!isset($counts[\"leecher\"]))\n\t\t$counts[\"leecher\"] = 0;\n\tif (!isset($counts[\"seeder\"]))\n\t\t$counts[\"seeder\"] = 0;\n\n\tif ($counts[\"seeder\"] != $seeders)\n\t{\n\t\tquickQuery(\"UPDATE \".$prefix.\"summary SET seeds=\".$counts[\"seeder\"].\" WHERE info_hash=\\\"$hash\\\"\");\n\t\techo \"<td class=\\\"center\\\">$seeders -> \".$counts[\"seeder\"].\"</td>\";\n\t}\n\telse\n\t\techo \"<td class=\\\"center\\\">$seeders</td>\";\n\t\t\n\tif ($counts[\"leecher\"] != $leechers)\n\t{\n\t\tquickQuery(\"UPDATE \".$prefix.\"summary SET leechers=\".$counts[\"leecher\"].\" WHERE info_hash=\\\"$hash\\\"\");\n\t\techo \"<td class=\\\"center\\\">$leechers -> \".$counts[\"leecher\"].\"</td>\";\n\t}\n\telse\n\t\techo \"<td class=\\\"center\\\">$leechers</td>\";\n\t\t\n\tif ($counts[\"leecher\"] == 0)\n\t{\n\t\t//If there are no leechers, set the speed to zero\n\t\tquickQuery(\"UPDATE \".$prefix.\"summary set speed=0 WHERE info_hash=\\\"$hash\\\"\");\n\t}\n\n\tif ($bytes < 0)\n\t{\n\t\tquickQuery(\"UPDATE \".$prefix.\"summary SET dlbytes=0 WHERE info_hash=\\\"$hash\\\"\");\n\t\techo \"<td class=\\\"center\\\">$bytes -> Zero</td>\";\n\t}\n\telse\n\t\techo \"<td class=\\\"center\\\">\". round($bytes/1048576/1024,3) .\" GB</td>\";\n\n\tmyTrashCollector($hash, $report_interval, time(), $writeout);\n\techo \"<td class=\\\"center\\\">\";\n\t\n\t$result = mysql_query(\"SELECT \".$prefix.\"x$hash.sequence FROM \".$prefix.\"x$hash LEFT JOIN \".$prefix.\"y$hash ON \".$prefix.\"x$hash.sequence = \".$prefix.\"y$hash.sequence WHERE \".$prefix.\"y$hash.sequence IS NULL\") or die(errorMessage() . \"\" . mysql_error() . \"</p>\");\n\tif (mysql_num_rows($result) > 0)\n\t{\n\t\techo \"Added \", mysql_num_rows($result);\n\t\t$row = array();\n\t\t\n\t\twhile ($data = mysql_fetch_row($result))\n\t\t\t\t$row[] = \"sequence=\\\"${data[0]}\\\"\";\n\t\t$where = implode(\" OR \", $row);\n\t\t$query = mysql_query(\"SELECT * FROM \".$prefix.\"x$hash WHERE $where\");\n\t\t\n\t\twhile ($row = mysql_fetch_assoc($query))\n\t\t{\n\t\t\t$compact = mysql_escape_string(pack('Nn', ip2long($row[\"ip\"]), $row[\"port\"]));\n\t\t\t\t$peerid = mysql_escape_string('2:ip' . strlen($row[\"ip\"]) . ':' . $row[\"ip\"] . '7:peer id20:' . hex2bin($row[\"peer_id\"]) . \"4:porti{$row[\"port\"]}e\");\n\t\t\t$no_peerid = mysql_escape_string('2:ip' . strlen($row[\"ip\"]) . ':' . $row[\"ip\"] . \"4:porti{$row[\"port\"]}e\");\n\t\t\tmysql_query(\"INSERT INTO \".$prefix.\"y$hash SET sequence=\\\"{$row[\"sequence\"]}\\\", compact=\\\"$compact\\\", with_peerid=\\\"$peerid\\\", without_peerid=\\\"$no_peerid\\\"\");\n\t\t}\n\t}\t\n\telse\n\t\techo \"Added none\";\n\n\t$result = mysql_query(\"SELECT \".$prefix.\"y$hash.sequence FROM \".$prefix.\"y$hash LEFT JOIN \".$prefix.\"x$hash ON \".$prefix.\"y$hash.sequence = \".$prefix.\"x$hash.sequence WHERE \".$prefix.\"x$hash.sequence IS NULL\");\n\tif (mysql_num_rows($result) > 0)\n\t{\n\t\techo \", Deleted \",mysql_num_rows($result);\n\n\t\t$row = array();\n\t\t\n\t\twhile ($data = mysql_fetch_row($result))\n\t\t\t$row[] = \"sequence=\\\"${data[0]}\\\"\";\n\t\t$where = implode(\" OR \", $row);\n\t\t$query = mysql_query(\"DELETE FROM \".$prefix.\"y$hash WHERE $where\");\n\t}\n\telse\n\t\techo \", Deleted none\";\n\n\techo \"</td>\";\n\t\n\techo \"</tr>\\n\";\n\t$i ++;\n\n\n\tif ($locking)\n\t\tquickQuery(\"UNLOCK TABLES\");\n\t\t\n\t//Repair tables, is this necessary?  Sometimes the tables crash...\n\t//Can't repair table if locked?\n\t//quickQuery(\"REPAIR Table x$hash\");\n\t//quickQuery(\"REPAIR Table y$hash\");\n\n\t// Finally, it's time to do stuff to the summary table.\n\tif (!empty($summaryupdate))\n\t{\n\t\t$stuff = \"\";\n\t\tforeach ($summaryupdate as $column => $value)\n\t\t{\n\t\t\t$stuff .= ', '.$column. ($value[1] ? \"=\" : \"=$column+\") . $value[0];\n\t\t}\n\t\tmysql_query(\"UPDATE \".$prefix.\"summary SET \".substr($stuff, 1).\" WHERE info_hash=\\\"$hash\\\"\");\n\t\t$summaryupdate = array();\n\t}\n\n\n}\n\nfunction myTrashCollector($hash, $timeout, $now, $writeout)\n{\n//\terror_log(\"Trash collector working on $hash\");\n \trequire(\"config.php\");\n \t$peers = loadLostPeers($hash, $timeout);\n \tfor ($i=0; $i < $peers[\"size\"]; $i++)\n\t        killPeer($peers[$i][\"peer_id\"], $hash, $peers[$i][\"bytes\"], $peers[$i]);\n\tif ($i != 0)\n\t\techo \"<td class=\\\"center\\\">Removed $i</td>\";\n\telse\n\t\techo \"<td class=\\\"center\\\">Removed 0</td>\";\n \tquickQuery(\"UPDATE \".$prefix.\"summary SET lastcycle='$now' WHERE info_hash='$hash'\");\n}\n\n\n\n\n?>\n</table>\n<p><a href=\"sanity.php?nolock=on\">Not working? Try running this.</a></p>\n<a href=\"index.php\"><img src=\"images/stats.png\" border=\"0\" class=\"icon\" alt=\"Tracker Statistics\" title=\"Tracker Statistics\" /></a><a href=\"index.php\">Return to Statistics Page</a><br>\n<a href=\"admin.php\"><img src=\"images/admin.png\" border=\"0\" class=\"icon\" alt=\"Admin Page\" title=\"Admin Page\" /></a><a href=\"admin.php\">Return to Admin Page</a>\n</body>\n</html>\n", "<?php\nrequire_once(\"config.php\");\nrequire_once(\"funcsv2.php\");\n\n$summaryupdate = array();\n\n// Non-persistant: we lock tables!\n$db = mysql_connect($dbhost, $dbuser, $dbpass) or die(errorMessage() . \"Tracker error: can't connect to database - \".mysql_error() . \"</p>\");\nmysql_select_db($database) or die(errorMessage() . \"Tracker error: can't open database $database - \".mysql_error() . \"</p>\");\n\n\nquickQuery(\"LOCK TABLES \".$prefix.\"summary WRITE, \".$prefix.\"namemap READ\");\n\n$results = mysql_query(\"SELECT \".$prefix.\"summary.info_hash, seeds, leechers, dlbytes, \".$prefix.\"namemap.filename FROM \".$prefix.\"summary LEFT JOIN \".$prefix.\"namemap ON \".$prefix.\"summary.info_hash = \".$prefix.\"namemap.info_hash\");\n\n$i = 0;\n\nwhile ($row = mysql_fetch_row($results))\n{\n\t$writeout = \"row\" . $i % 2;\n\tlist($hash, $seeders, $leechers, $bytes, $filename) = $row;\n\tif (isset($locking) && $locking)\n\t{\n\t\t//peercaching ALWAYS on\n\t\tquickQuery(\"LOCK TABLES \".$prefix.\"x$hash WRITE, \".$prefix.\"y$hash WRITE, \".$prefix.\"summary WRITE\");\n\t}\n\t$results2 = mysql_query(\"SELECT status, COUNT(status) FROM \".$prefix.\"x$hash GROUP BY status\");\n\n\tif (!$results2)\n\t{\n\t\t//unable to process\n\t\tcontinue;\n\t}\n\n\t$counts = array();\n\twhile ($row = mysql_fetch_row($results2))\n\t\t$counts[$row[0]] = $row[1];\t\n\tif (!isset($counts[\"leecher\"]))\n\t\t$counts[\"leecher\"] = 0;\n\tif (!isset($counts[\"seeder\"]))\n\t\t$counts[\"seeder\"] = 0;\n\n\tif ($counts[\"leecher\"] != $leechers)\n\t\tquickQuery(\"UPDATE \".$prefix.\"summary SET leechers=\".$counts[\"leecher\"].\" WHERE info_hash=\\\"$hash\\\"\");\n\n\tif ($counts[\"seeder\"] != $seeders)\n\t\tquickQuery(\"UPDATE \".$prefix.\"summary SET seeds=\".$counts[\"seeder\"].\" WHERE info_hash=\\\"$hash\\\"\");\n\t\t\n\tif ($counts[\"leecher\"] == 0)\n\t{\n\t\t//If there are no leechers, set the speed to zero\n\t\tquickQuery(\"UPDATE \".$prefix.\"summary set speed=0 WHERE info_hash=\\\"$hash\\\"\");\n\t}\n\t\n\n\tif ($bytes < 0)\n\t\tquickQuery(\"UPDATE \".$prefix.\"summary SET dlbytes=0 WHERE info_hash=\\\"$hash\\\"\");\n\n\tmyTrashCollector($hash, $report_interval, time(), $writeout);\n\n\t$result = mysql_query(\"SELECT \".$prefix.\"x$hash.sequence FROM \".$prefix.\"x$hash LEFT JOIN \".$prefix.\"y$hash ON \".$prefix.\"x$hash.sequence = \".$prefix.\"y$hash.sequence WHERE \".$prefix.\"y$hash.sequence IS NULL\") or die(errorMessage() . \"\" . mysql_error() . \"</p>\");\n\tif (mysql_num_rows($result) > 0)\n\t{\n\t\t$row = array();\n\t\t\n\t\twhile ($data = mysql_fetch_row($result))\n\t\t\t\t$row[] = \"sequence=\\\"${data[0]}\\\"\";\n\t\t$where = implode(\" OR \", $row);\n\t\t$query = mysql_query(\"SELECT * FROM \".$prefix.\"x$hash WHERE $where\");\n\t\t\n\t\twhile ($row = mysql_fetch_assoc($query))\n\t\t{\n\t\t\t$compact = mysql_escape_string(pack('Nn', ip2long($row[\"ip\"]), $row[\"port\"]));\n\t\t\t\t$peerid = mysql_escape_string('2:ip' . strlen($row[\"ip\"]) . ':' . $row[\"ip\"] . '7:peer id20:' . hex2bin($row[\"peer_id\"]) . \"4:porti{$row[\"port\"]}e\");\n\t\t\t$no_peerid = mysql_escape_string('2:ip' . strlen($row[\"ip\"]) . ':' . $row[\"ip\"] . \"4:porti{$row[\"port\"]}e\");\n\t\t\tmysql_query(\"INSERT INTO \".$prefix.\"y$hash SET sequence=\\\"{$row[\"sequence\"]}\\\", compact=\\\"$compact\\\", with_peerid=\\\"$peerid\\\", without_peerid=\\\"$no_peerid\\\"\");\n\t\t}\n\t}\t\n\n\t$result = mysql_query(\"SELECT \".$prefix.\"y$hash.sequence FROM \".$prefix.\"y$hash LEFT JOIN \".$prefix.\"x$hash ON \".$prefix.\"y$hash.sequence = \".$prefix.\"x$hash.sequence WHERE \".$prefix.\"x$hash.sequence IS NULL\");\n\tif (mysql_num_rows($result) > 0)\n\t{\n\t\t$row = array();\n\t\t\n\t\twhile ($data = mysql_fetch_row($result))\n\t\t\t$row[] = \"sequence=\\\"${data[0]}\\\"\";\n\t\t$where = implode(\" OR \", $row);\n\t\t$query = mysql_query(\"DELETE FROM \".$prefix.\"y$hash WHERE $where\");\n\t}\n\n\n\t$i ++;\n\n\tquickQuery(\"UNLOCK TABLES\");\n\t\n\t//Repair tables, is this necessary?  Sometimes the tables crash...\n\t//Can't repair table if locked?\n\t//quickQuery(\"REPAIR Table x$hash\");\n\t//quickQuery(\"REPAIR Table y$hash\");\n\n\t// Finally, it's time to do stuff to the summary table.\n\tif (!empty($summaryupdate))\n\t{\n\t\t$stuff = \"\";\n\t\tforeach ($summaryupdate as $column => $value)\n\t\t{\n\t\t\t$stuff .= ', '.$column. ($value[1] ? \"=\" : \"=$column+\") . $value[0];\n\t\t}\n\t\tmysql_query(\"UPDATE \".$prefix.\"summary SET \".substr($stuff, 1).\" WHERE info_hash=\\\"$hash\\\"\");\n\t\t$summaryupdate = array();\n\t}\n\t\t\n}\n\n\nfunction myTrashCollector($hash, $timeout, $now, $writeout)\n{\n\trequire(\"config.php\");\n \t$peers = loadLostPeers($hash, $timeout);\n\tfor ($i=0; $i < $peers[\"size\"]; $i++) {\n\t        killPeer($peers[$i][\"peer_id\"], $hash, $peers[$i][\"bytes\"], $peers[$i]);\n\t}\n \tquickQuery(\"UPDATE \".$prefix.\"summary SET lastcycle='$now' WHERE info_hash='$hash'\");\n}\n\n?>\n", "<?php\nrequire (\"config.php\");\nrequire_once (\"funcsv2.php\");\n//Check session\nsession_start();\n\nif (!$_SESSION['admin_logged_in'])\n{\n\t//check fails\n\theader(\"Location: authenticate.php?status=session\");\n\texit();\n}\n?>\n\n<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\" \"http://www.w3.org/TR/html4/loose.dtd\">\n\n<html>\n<head>\n\t<title>Tracker User Statistics</title>\n\t<meta http-equiv=\"Content-Type\" content=\"text/html; charset=iso-8859-1\" />\n\t<link rel=\"stylesheet\" href=\"./css/style.css\" type=\"text/css\" />\n</head>\n<body>\n<h1>Tracker User Statistics</h1>\n\n<form action=\"<?php echo htmlentities($_SERVER['PHP_SELF']);?>\" method=\"POST\">\nFilename Search:<input type=\"text\" name=\"filename_search\" size=\"40\"<?php if (isset($_POST[\"filename_search\"]))echo \" value=\\\"\" . $_POST[\"filename_search\"] . \"\\\"\";?>>\n<input type=\"submit\" value=\"Search\">\n</form>\n<br>\n\n<?php\nrequire_once (\"config.php\");\nrequire_once (\"funcsv2.php\");\n\n//connect to database and grab each torrent in database\nif ($GLOBALS[\"persist\"])\n\t$db = mysql_pconnect($dbhost, $dbuser, $dbpass) or die(errorMessage() . \"Tracker error: can't connect to database - \" . mysql_error() . \"</p>\");\nelse\n\t$db = mysql_connect($dbhost, $dbuser, $dbpass) or die(errorMessage() . \"Tracker error: can't connect to database - \" . mysql_error() . \"</p>\");\nmysql_select_db($database) or die(errorMessage() . \"Tracker error: can't open database $database - \" . mysql_error() . \"</p>\");\n\n//Display search information\nif (isset($_POST[\"filename_search\"]) && $_POST[\"filename_search\"] != \"\")\n{\n\techo \"<h2 align=\\\"center\\\">Search Results:</h2>\";\n\t$query = \"SELECT * FROM \".$prefix.\"summary LEFT JOIN \".$prefix.\"namemap ON \".$prefix.\"summary.info_hash = \".$prefix.\"namemap.info_hash WHERE \".$prefix.\"namemap.filename REGEXP \\\"$_POST[filename_search]\\\" ORDER BY \".$prefix.\"namemap.filename\";\n}\nelse //display everything\n{\n\t$scriptname = htmlentities($_SERVER['PHP_SELF']) . \"?\";\n\t\n\tif (!isset($_GET[\"activeonly\"])) \n\t\techo \"<a href=\\\"$scriptname\" . \"activeonly=yes\\\">Show only torrents with seeders/leechers</a>\\n\";\n\telse\n\t{\n\t\techo \"<a href=\\\"$scriptname\\\">Show all torrents</a>\\n\";\n\t\t$scriptname = $scriptname . \"activeonly=yes&\";\t\n\t}\n\n\tif (isset($_GET[\"activeonly\"]))\n\t\t$where = \" WHERE leechers+seeds > 0\";\n\telse\n\t\t$where = \" \";\n\t\n\t$query = \"SELECT COUNT(*) FROM \".$prefix.\"summary $where\";\n\t$results = mysql_query($query);\n\t$res = mysql_result($results,0,0);\n\t\n\techo \"<p align='center'>Page: \\n\";\n\t$count = 0;\n\t$page = 1;\n\twhile($count < $res)\n\t{\n\t\tif (isset($_GET[\"page_number\"]) && $page == $_GET[\"page_number\"])\n\t\t\techo \"<b><a href=\\\"$scriptname\" . \"page_number=$page\\\">($page)</a></b>-\\n\";\n\t\telse if (!isset($_GET[\"page_number\"]) && $page == 1)\n\t\t\techo \"<b><a href=\\\"$scriptname\" . \"page_number=$page\\\">($page)</a></b>-\\n\";\n\t\telse\n\t\t\techo \"<a href=\\\"$scriptname\" . \"page_number=$page\\\">$page</a>-\\n\";\n\t\t$page++;\n\t\t$count = $count + ($GLOBALS[\"statspagelimitspecify\"]);\n\t}\n\techo \"</p>\\n\";\n\t\n\tif (!isset($_GET[\"page_number\"]))\n\t\t$query = \"SELECT * FROM \".$prefix.\"summary LEFT JOIN \".$prefix.\"namemap ON \".$prefix.\"summary.info_hash = \".$prefix.\"namemap.info_hash $where ORDER BY \".$prefix.\"namemap.filename LIMIT 0,${GLOBALS['statspagelimitspecify']}\";\n\telse\n\t{\n\t\t$page_limit = ($_GET[\"page_number\"] - 1) * ($GLOBALS[\"statspagelimitspecify\"]);\n\t\t$query = \"SELECT * FROM \".$prefix.\"summary LEFT JOIN \".$prefix.\"namemap ON \".$prefix.\"summary.info_hash = \".$prefix.\"namemap.info_hash $where ORDER BY \".$prefix.\"namemap.filename LIMIT $page_limit,${GLOBALS['statspagelimitspecify']}\";\n\t}\n}\n\n$results = mysql_query($query) or die(errorMessage() . \"Can't do SQL query - \" . mysql_error() . \"</p>\");\n\nwhile ($data = mysql_fetch_row($results))\n{\n\t$xhash = \"x\" . $data[0];\n\t$query2 = \"SELECT * FROM \".$prefix.\"$xhash\";\n\t$results2 = mysql_query($query2) or die(errorMessage() . \"Can't do SQL query - \" . mysql_error() . \"</p>\");\n\n\tif (mysql_num_rows($results2) == 0 && isset($_GET[\"activeonly\"]))\n\t\tbreak;\n\telse\n\t{\n\t\techo \"<hr><table>\\n\";\n\t\techo \"<tr><th>Info Hash</th><th>Filename</th><th>URL</th><th>File Size</th><th>Publication Date</th></tr>\\n\";\n\t\techo \"<tr><td>\" . $data[0] . \"</td><td>\" . $data[11] . \"</td><td>\\n\";\n\t\tif (Substr($data[12], 0, 7) == \"http://\")\n\t\t\techo \"<a href=\\\"\" . $data[12] . \"\\\">\" . $data[12] . \"</a>\\n\";\n\t\telse\n\t\t\techo $data[12];\n\t\techo \"</td><td>\" . bytesToString($data[13]) . \"</td>\\n\";\n\t\techo \"<td>\" . $data[14] . \"</td></tr>\\n\";\n\t\techo \"</table>\\n\";\n\t}\n\n\techo \"<table>\\n\";\n\techo \"<tr><th class=\\\"subheader\\\">IP Address</th><th class=\\\"subheader\\\">Data Left to Download</th><th class=\\\"subheader\\\" width=200>Percent Finished</th><th class=\\\"subheader\\\">Port</th><th class=\\\"subheader\\\">Last Update</th><th class=\\\"subheader\\\">NAT User</th></tr>\\n\";\n\twhile ($data2 = mysql_fetch_row($results2))\n\t{\n\t\t//grab information on each user\n\t\techo \"<tr><td>\" . $data2[2] . \"</td>\\n\";\n\t\techo \"<td>\" . bytesToString($data2[1]) . \"</td>\\n\";\n\n\t\t//calculate percent done for user\n\t\t$percent_done = 1.00;\n\t\tif ($data2[1] != 0) //only run calculation if they are still downloading\n\t\t{\n\t\t\t$size_in_bytes = $data[13];\n\t\t\tif ($size_in_bytes == 0) //thou shalt not divide by zero\n\t\t\t\t$percent_done = 0;\n\t\t\telse\n\t\t\t\t$percent_done = round(($size_in_bytes - $data2[1]) / $size_in_bytes, 3);\n\t\t}\n\n\t\t?>\n\t\t<td>\n\t\t<table class=\"percentages\" cellspacing=\"0\">\n\t\t<tr>\n\t\t<td align=\"right\" class=\"percent\" width=\"<?php echo round($percent_done * 200, 0); ?>\" height=\"15\">\n\t\t<?php if ($percent_done > .5) echo $percent_done * 100 . \"%\"; ?>\n\t\t</td>\n\t\t<td align=\"left\" class=\"percentleft\" width=\"<?php echo 200 - round($percent_done * 200, 0); ?>\" height=\"15\">\n\t\t<?php if ($percent_done <= .5) echo $percent_done * 100 . \"%\"; ?>\t\t\n\t\t</td>\n\t\t</tr>\n\t\t</table>\n\t\t</td>\n\t\t<?php\n\t\techo \"<td>\" . $data2[3] . \"</td>\\n\"; //port\n\t\techo \"<td>\" . date('g:ia m-d-Y', $data2[5]) . \"</td>\\n\"; //last time check-in\n\t\techo \"<td>\" . $data2[7] . \"</td>\\n\"; //NAT user\n\t\techo \"</tr>\\n\";\n\t}\n\techo \"</table><br>\\n\";\n}\necho \"<hr>\";\nif (!isset($_POST[\"filename_search\"]))\n{\n\techo \"<p align='center'>Page: \\n\";\n\t$count = 0;\n\t$page = 1;\n\twhile($count < $res)\n\t{\n\tif (isset($_GET[\"page_number\"]) && $page == $_GET[\"page_number\"])\n\t\techo \"<b><a href=\\\"$scriptname\" . \"page_number=$page\\\">($page)</a></b>-\\n\";\n\telse if (!isset($_GET[\"page_number\"]) && $page == 1)\n\t\techo \"<b><a href=\\\"$scriptname\" . \"page_number=$page\\\">($page)</a></b>-\\n\";\n\telse\n\t\techo \"<a href=\\\"$scriptname\" . \"page_number=$page\\\">$page</a>-\\n\";\n\t$page++;\n\t$count = $count + ($GLOBALS[\"statspagelimitspecify\"]);\n\t}\n\techo \"</p>\\n\";\n}\n?>\n\n<a href=\"admin.php\"><img src=\"images/admin.png\" border=\"0\" class=\"icon\" alt=\"Admin Page\" title=\"Admin Page\" /></a><a href=\"admin.php\">Return to Admin Page</a>\n</body>\n</html>\n"], "fixing_code": ["<?php\n\nrequire (\"config.php\");\nrequire (\"funcsv2.php\"); //required for errorMessage() function\n//Check session\nsession_start();\n\nif (!$_SESSION['admin_logged_in'])\n{\n\t//check fails\n\theader(\"Location: authenticate.php?status=session\");\n\texit();\n}\n\n// Prep database, needed for cleaning function\nif ($GLOBALS[\"persist\"])\n\t$db = @mysql_pconnect($dbhost, $dbuser, $dbpass) or showError(\"Can't connect to database. Contact the webmaster.\");\nelse\n\t$db = @mysql_connect($dbhost, $dbuser, $dbpass) or showError(\"Can't connect to database. Contact the webmaster.\");\n@mysql_select_db($database) or showError(\"Can't open database. Contact the webmaster\");\n\n?>\n\n<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\" \"http://www.w3.org/TR/html4/loose.dtd\">\n\n<html>\n<head>\n\t<title>Change CSS File</title>\n\t<meta http-equiv=\"Content-Type\" content=\"text/html; charset=iso-8859-1\" />\n\t<link rel=\"stylesheet\" href=\"./css/style.css\" type=\"text/css\" />\n\t<style type=\"text/css\">\n\t\ttd.cell{\n\t\t\twidth: 2%;\n\t\t\t}\n\t</style>\n\t<script type=\"text/javascript\">\n\tfunction changeColor(color)\n\t{\n\t\tdocument.getElementById(\"color_box\").value = color;\n\t\tdocument.getElementById(\"thecolor\").style.backgroundColor = color;\n\t}\n\t</script>\n</head>\n<body>\n<center>\n<h1>Change CSS File</h1>\n</center>\n<br>\n\n<?php\n\nif (isset($_POST[\"set_css\"]))\n{\n\t//delete style.css file\n\tif (copy(\"./css/\" . filterData($_POST[\"set_css\"]), \"./css/style.css\"))\n\t\techo \"<p class=\\\"success\\\">style.css file has been replaced with \" . filterData($_POST[\"set_css\"]) . \"</p>\";\n\telse\n\t{\n\t\techo errorMessage() . \"Error: Unable to copy over style.css, are the permissions correct?</p>\";\n\t\texit();\n\t}\n}\nelseif (isset($_POST[\"delete_css\"]))\n{\n\t//delete css file\n\tif (unlink(\"./css/\" . filterData($_POST[\"delete_css\"])))\n\t\techo \"<p class=\\\"success\\\">\" . filterData($_POST[\"delete_css\"]) . \" has been deleted</p>\";\n\telse\n\t{\n\t\techo errorMessage() . \"Error: Unable to delete \" . filterData($_POST[\"delete_css\"]) . \", are you sure the permissions are correct?</p>\";\n\t\texit();\n\t}\n}\nelseif (isset($_POST[\"create_css\"]))\n{\n\t//create new css file by copying over style.css into new file\n\tif (substr($_POST[\"create_css\"], -4) == \".css\")\n\t{\n\t\tif (!file_exists(\"./css/\" . filterData($_POST[\"create_css\"])))\n\t\t{\n\t\t\tif (copy(\"./css/style.css\", \"./css/\" . filterData($_POST[\"create_css\"])))\n\t\t\t\techo \"<p class=\\\"success\\\">\" . filterData($_POST[\"create_css\"]) . \", was created successfuly</p>\";\n\t\t\telse\n\t\t\t{\n\t\t\t\techo errorMessage() . \"Error: Unable to create \" . filterData($_POST[\"create_css\"]) . \", are you sure the permissions are correct?</p>\";\n\t\t\t\texit();\t\t\t\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\techo errorMessage() . \"Error: \" . filterData($_POST[\"create_css\"]) . \" already exists, please choose a different name</p>\";\n\t\t\texit();\n\t\t}\n\t}\n\telse\n\t{\n\t\techo errorMessage() . \"Error: Your file doesn't end with .css</p>\";\n\t\texit();\n\t}\n}\n\nif (isset($_POST[\"create_css\"]) || isset($_POST[\"edit_css\"]))\n{\n\t//display color picker\n\t?>\n\t<h2>Color Picker:</h2>\n\t<table style=\"cursor: pointer;\" border=\"0\">\n\t<?php\n\tfunction rgbhex($red, $green, $blue)\n\t{\n\t\treturn sprintf('#%02X%02X%02X', $red, $green, $blue);\n\t}\n\t\n\t//create table of 216 web safe colors\n\tfor ($red = 0; $red < 256; $red = $red + 51)\n\t{\n\t\techo \"<tr>\";\n\t\tfor ($green = 0; $green < 256; $green = $green + 51)\n\t\t{\n\t\t\tfor ($blue = 0; $blue < 256; $blue = $blue + 51)\n\t\t\t{\n\t\t\t\t$hexcolor = rgbhex($red, $green, $blue);\n\t\t\t\techo \"<td bgcolor='\" . $hexcolor . \"' title='\" . $hexcolor . \"' class='cell' onClick=\\\"changeColor('\" . $hexcolor . \"')\\\">&nbsp;</td>\\n\";\n\t\t\t}\n\t\t}\n\t\techo \"</tr>\";\n\t}\n\t\n\t?>\n\t</table>\n\t<br>\n\t<b>Color:</b>\n\t<table border=\"0\"><tr>\n\t<td id=\"thecolor\" align=\"left\" bgcolor=\"#000000\"><input type=\"text\" id=\"color_box\" value=\"#000000\"/>\n\t</td></tr>\n\t</table>\n\t<br>\n\t<?php\n\t\n\tif (isset($_POST[\"create_css\"]))\n\t\t$filename = filterData($_POST[\"create_css\"]);\n\tif (isset($_POST[\"edit_css\"]))\n\t\t$filename = filterData($_POST[\"edit_css\"]);\n\t//display text box with css in it\n\t?>\n\t<h2>Editing File: <?php echo $filename;?></h2>\n\t<form action=\"<?php echo htmlentities($_SERVER['PHP_SELF']);?>\" method=\"post\">\n\t<input type=\"hidden\" name=\"hidden_filename\" value=\"<?php echo $filename;?>\"/>\n\t<input type=\"hidden\" name=\"current_css_file\" value=\"<?php echo $_POST['current_css_file'];?>\"/>\n\t<textarea name=\"file_contents\" cols=\"120\" rows=\"20\"><?php\n\t//open css file\n\treadfile(\"./css/\" . $filename);\n\t?></textarea>\n\t<br><br>\n\t<input type=\"submit\" value=\"Save File\"/>\n\t</form>\n\t<?php\n\t\n}\n\nif (isset($_POST[\"file_contents\"]))\n{\n\t//save previously edited text into file\n\tif (is_writable(\"./css/\" . filterData($_POST[\"hidden_filename\"])))\n\t{\n\t\t//open file\n\t\t$stream = fopen(\"./css/\" . filterData($_POST[\"hidden_filename\"]), \"w\");\n\t\tfwrite($stream, filterData($_POST[\"file_contents\"]));\n\t\tfclose($stream);\n\t\techo \"<p class=\\\"success\\\">\" . filterData($_POST[\"hidden_filename\"]) . \", was saved successfuly</p>\";\n\t}\n\telse\n\t{\n\t\techo errorMessage() . \"Error: The file cannot be saved, check the permissions</p>\";\n\t\texit();\n\t}\n\t//if editing the current css file, replace that too\n\tif ($_POST[\"current_css_file\"] == $_POST[\"hidden_filename\"])\n\t{\n\t\tif (copy(\"./css/\" . filterData($_POST[\"hidden_filename\"]), \"./css/style.css\"))\n\t\t\techo \"<p class=\\\"success\\\">style.css file has been replaced with \" . filterData($_POST[\"hidden_filename\"]) . \"</p>\";\n\t\telse\n\t\t{\n\t\t\techo errorMessage() . \"Error: Unable to copy over style.css, are the permissions correct?</p>\";\n\t\t\texit();\n\t\t}\n\t}\n}\n\nif (!isset($_POST[\"create_css\"]) && !isset($_POST[\"edit_css\"]) && !isset($_POST[\"delete_css\"]) && \n!isset($_POST[\"set_css\"]) && !isset($_POST[\"file_contents\"]))\n{\n\t//save all files in css directory to array\n\t$current_css_file = \"\";\n\t$css_style_md5 = md5_file(\"./css/style.css\");\n\t$number_files = 0;\n\tif ($dh = opendir(\"./css/\"))\n\t{\n\t\twhile (($file = readdir($dh)) !== false)\n\t\t{\n\t\t\tif (filetype(\"./css/\" . $file) == \"file\" && $file != \"index.php\" && $file != \"style.css\" && substr($file, -4) == \".css\")\n\t\t\t{\n\t\t\t\tif (md5_file(\"./css/\" . $file) == $css_style_md5)\n\t\t\t\t\t$current_css_file = $file;\n\t\t\t\t$files_array[$number_files] = $file;\n\t\t\t\t$number_files++;\n\t\t\t}\n\t\t}\n\t\tclosedir($dh);\n\t}\n\techo \"<b>Currently Used CSS File: \" . $current_css_file . \"</b><br><br>\";\n\t?>\n\t\n\t<form action=\"<?php echo htmlentities($_SERVER['PHP_SELF']);?>\" method=\"post\">\n\t<b>Set CSS File:</b><select name=\"set_css\">\n\t<?php\n\tfor ($i = 0; $i < $number_files; $i++)\n\t{\n\t\tif ($files_array[$i] != $current_css_file) //no point setting it to itself...\n\t\t\techo \"<option value=\\\"\" . $files_array[$i] . \"\\\">\" . $files_array[$i] . \"</option>\\n\\t\";\n\t}\n\t?>\n\t</select>\n\t<input type=\"submit\" value=\"Set CSS File\"/>\n\t</form>\n\t<br><br>\n\t\n\t<form action=\"<?php echo htmlentities($_SERVER['PHP_SELF']);?>\" method=\"post\"> \n\t<b>Delete CSS File:</b><select name=\"delete_css\">\n\t<?php\n\tfor ($i = 0; $i < $number_files; $i++)\n\t{\n\t\tif ($files_array[$i] != $current_css_file) //can't delete the file if it's already being used...\n\t\t\techo \"<option value=\\\"\" . $files_array[$i] . \"\\\">\" . $files_array[$i] . \"</option>\\n\\t\";\n\t}\n\t?>\n\t</select>\n\t<input type=\"submit\" value=\"Delete CSS File\"/>\n\t</form>\n\t<br><br>\n\t\n\t<form action=\"<?php echo htmlentities($_SERVER['PHP_SELF']);?>\" method=\"post\">\n\t<input type=\"hidden\" name=\"current_css_file\" value=\"<?php echo $current_css_file;?>\"/>\n\t<b>Edit Existing CSS File:</b><select name=\"edit_css\">\n\t<?php\n\tfor ($i = 0; $i < $number_files; $i++)\n\t{\n\t\techo \"<option value=\\\"\" . $files_array[$i] . \"\\\">\" . $files_array[$i] . \"</option>\\n\\t\";\n\t}\n\t?>\n\t</select>\n\t<input type=\"submit\" value=\"Edit CSS File\"/>\n\t</form>\n\t<br><br>\n\t\n\t<form action=\"<?php echo htmlentities($_SERVER['PHP_SELF']);?>\" method=\"post\"> \n\t<b>Create New CSS File (e.g. mycssfile.css):</b>\n\t<input type=\"text\" size=\"40\" name=\"create_css\"/>\n\t<input type=\"submit\" value=\"Create New CSS File\"/>\n\t</form>\n\t<?php\n}\n?>\n\n<br>\n<br>\n<a href=\"admin.php\"><img src=\"images/admin.png\" border=\"0\" class=\"icon\" alt=\"Admin Page\" title=\"Admin Page\" /></a><a href=\"admin.php\">Return to Admin Page</a>\n</body>\n</html>\n", "<?php\nrequire (\"config.php\");\nrequire_once (\"funcsv2.php\");\n//Check session\nsession_start();\n\nif (!$_SESSION['admin_logged_in'])\n{\n\t//check fails\n\theader(\"Location: authenticate.php?status=session\");\n\texit();\n}\n?>\n\n<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\" \"http://www.w3.org/TR/html4/loose.dtd\">\n\n<html>\n<head>\n\t<title>Edit Torrent in Database</title>\n\t<meta http-equiv=\"Content-Type\" content=\"text/html; charset=iso-8859-1\" />\n\t<link rel=\"stylesheet\" href=\"./css/style.css\" type=\"text/css\" />\n</head>\n<body>\n<h1>Edit Torrent in Database</h1>\n<h2>This page allows you to edit torrents that are already in the database.  If you need to change other things about\nthe torrent please <a href=\"deleter.php\">delete it</a> and add it again.</h2>\n\t\n<?php\n\n//connect to database\nif ($GLOBALS[\"persist\"])\n\t$db = mysql_pconnect($dbhost, $dbuser, $dbpass) or die(errorMessage() . \"Tracker error: can't connect to database - \" . mysql_error() . \"</p>\");\nelse\n\t$db = mysql_connect($dbhost, $dbuser, $dbpass) or die(errorMessage() . \"Tracker error: can't connect to database - \" . mysql_error() . \"</p>\");\nmysql_select_db($database) or die(errorMessage() . \"Error selecting database.</p>\");\n\n//get filename from URL string\nif (isset($_GET['filename'])) {\n\t$filename = htmlentities($_GET['filename']);\n}\n\n//if not edit database or filename set, display all torrents as links\nif (!isset($_POST[\"editdatabase\"]) && !isset($filename))\n{\n\t?>\n\t<p><strong>Click on a file to edit it:</strong></p>\n\t<table border=\"0\">\n\t<?php\n\t$query = \"SELECT filename FROM \".$prefix.\"namemap ORDER BY filename ASC\";\n\t$rows = mysql_query($query) or die(errorMessage() . \"Can't do SQL query - \" . mysql_error() . \"</p>\");\n\t\n\twhile ($data = mysql_fetch_row($rows))\n\t{\n\t\techo \"<tr><td><a href=\\\"\" . htmlentities($_SERVER['PHP_SELF']) . \"?filename=\" . rawurlencode($data[0]) . \"\\\">\" . $data[0] . \"</a></td></tr>\\n\";\n\t}\n\t?>\n\t</table>\n\t<?php\n}\n\nif (isset($filename) && !isset($_POST[\"editdatabase\"]))\n{\n\t$query = \"SELECT info_hash,filename,url,pubDate FROM \".$prefix.\"namemap WHERE filename = '\" . mysql_real_escape_string($filename) . \"'\";\n\t$rows = mysql_query($query) or die(errorMessage() . \"Can't do SQL query - \" . mysql_error() . \"</p>\");\n\t\n\t$data = mysql_fetch_row($rows); //should be only one entry...\n\t?>\n\t<form action=\"<?php echo htmlentities($_SERVER['PHP_SELF']);?>\" method=\"POST\">\n\t<input type=\"hidden\" name=\"editdatabase\" value=\"1\">\n\t<input type=\"hidden\" name=\"<?php echo $data[0];?>\" value=\"<?php echo $data[0];?>\">\n\t<input type=\"hidden\" name=\"<?php echo $data[0] . \"_old_filename\";?>\" value=\"<?php echo $data[1];?>\">\n\t<table border=\"0\">\n\t<tr><td><b>Info Hash: </b></td><td><?php echo $data[0];?></td></tr>\n\t<tr><td><b>Filename:</b></td><td><input type=\"text\" name=\"<?php echo $data[0] . \"_filename\";?>\" size=\"60\" value=\"<?php echo $data[1];?>\"></td></tr>\n\t<tr><td><b>URL:</b></td><td><input type=\"text\" name=\"<?php echo $data[0] . \"_url\";?>\" size=\"60\" value=\"<?php echo $data[2];?>\"></td></tr>\n\t<tr><td><b>Publication Date:</b></td><td><input type=\"text\" name=\"<?php echo $data[0] . \"_pubDate\";?>\" size=\"60\" value=\"<?php echo $data[3];?>\"></td></tr>\n\t<tr><td><hr></td><td><hr></td></tr>\t\t\n\t\n\t</table>\n\t<br>\n\t<input type=\"submit\" value=\"Edit Entry\">\n\t</form>\n\t\n\t<?php\n}\n\n//write data to database\nif (isset($_POST[\"editdatabase\"]))\n{\n\t$temp_counter = (count($_POST)-1)/5;\n\tarray_shift($_POST);\n\t\n\tfor ($i = 0; $i < $temp_counter; $i++)\n\t{\n\t\t$temp_hash = htmlspecialchars(array_shift($_POST));\n\t\t$old_filename = htmlspecialchars(array_shift($_POST));\n\t\t$temp_filename = array_shift($_POST);\n\t\t$temp_filename = Ltrim($temp_filename);\n\t\t$temp_filename = htmlspecialchars(rtrim($temp_filename));\n\t\t$temp_url = htmlspecialchars(array_shift($_POST));\n\t\t$temp_pubDate = htmlspecialchars(array_shift($_POST));\n\t\t$query = \"UPDATE \".$prefix.\"namemap SET filename=\\\"$temp_filename\\\", url=\\\"$temp_url\\\", pubDate=\\\"$temp_pubDate\\\" WHERE info_hash=\\\"$temp_hash\\\"\";\n\t\tmysql_query($query) or die(errorMessage() . \"Can't do SQL query - \" . mysql_error() . \"</p>\");\n\t\t//if filename changes, rename .torrent\n\t\tif ($old_filename != $temp_filename)\n\t\t\trename(\"torrents/\" . $old_filename . \".torrent\", \"torrents/\" . $temp_filename . \".torrent\");\n\t}\n\t\n\t//run RSS generator\n\trequire_once(\"rss_generator.php\");\n\t\n\techo \"<br><p class=\\\"success\\\">The database was edited successfully!</p>\\n\";\n}\n\n?>\n<br>\n<br>\n<a href=\"admin.php\"><img src=\"images/admin.png\" border=\"0\" class=\"icon\" alt=\"Admin Page\" title=\"Admin Page\" /></a><a href=\"admin.php\">Return to Admin Page</a>\n</body>\n</html>\n", "<?php\nrequire (\"config.php\");\nrequire_once(\"funcsv2.php\");\n//Check session\nsession_start();\n\nif (!$_SESSION['admin_logged_in'])\n{\n\t//check fails\n\theader(\"Location: authenticate.php?status=session\");\n\texit();\n}\n?>\n\n\n<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\" \"http://www.w3.org/TR/html4/loose.dtd\">\n<html>\n<head>\n\t<title>Check Tracker for Expired Peers</title>\n\t<meta http-equiv=\"Content-Type\" content=\"text/html; charset=iso-8859-1\" />\n\t<link rel=\"stylesheet\" type=\"text/css\" href=\"./css/style.css\" />\n</head>\n<body>\n<h1>Check Tracker for Expired Peers</h1>\n<?php\n\n\nerror_reporting(E_ALL);\n//header(\"Content-Type: text/plain\");\n\n//require_once(\"config.php\");\n//require_once(\"funcsv2.php\");\n\n$summaryupdate = array();\n\n// Non-persistant: we lock tables!\n$db = mysql_connect($dbhost, $dbuser, $dbpass) or die(errorMessage() . \"Tracker error: can't connect to database - \".mysql_error() . \"</p>\");\nmysql_select_db($database) or die(errorMessage() . \"Tracker error: can't open database $database - \".mysql_error() . \"</p>\");\n\nif (isset($_GET[\"nolock\"]))\n\t$locking = false;\nelse\n\t$locking = true;\n\n// Assumes success\nif ($locking)\n\tquickQuery(\"LOCK TABLES \".$prefix.\"summary WRITE, \".$prefix.\"namemap READ\");\n\n?>\n<table class=\"torrentlist\" cellspacing=\"1\">\n<!-- Column Headers -->\n<tr>\n\t<th>Name/Info Hash</th>\n\t<th>Seeders</th>\n\t<th>Leechers</th>\n\t<th>Bytes Transfered</th>\n\t<th>Stale Clients</th>\n\t<th>Peer Cache</th>\n</tr>\n<?php\n\n$results = mysql_query(\"SELECT \".$prefix.\"summary.info_hash, seeds, leechers, dlbytes, \".$prefix.\"namemap.filename FROM \".$prefix.\"summary LEFT JOIN \".$prefix.\"namemap ON \".$prefix.\"summary.info_hash = \".$prefix.\"namemap.info_hash\");\n\n$i = 0;\n\nwhile ($row = mysql_fetch_row($results))\n{\n\t$writeout = \"row\" . $i % 2;\n\tlist($hash, $seeders, $leechers, $bytes, $filename) = $row;\n\tif ($locking)\n\t{\n\t\t//peercaching ALWAYS on\n\t\tquickQuery(\"LOCK TABLES \".$prefix.\"x$hash WRITE, \".$prefix.\"y$hash WRITE, \".$prefix.\"summary WRITE\");\n\t}\n\t$results2 = mysql_query(\"SELECT status, COUNT(status) from \".$prefix.\"x$hash GROUP BY status\");\n\techo \"<tr class=\\\"$writeout\\\"><td>\";\n\tif (!is_null($filename))\n\t\techo $filename;\n\telse\n\t\techo $hash;\n\techo \"</td>\";\n\tif (!$results2)\n\t{\n\t\techo \"<td colspan=\\\"4\\\">Unable to process: \".mysql_error().\"</td></tr>\";\n\t\tcontinue;\n\t}\n\n\t$counts = array();\n\twhile ($row = mysql_fetch_row($results2))\n\t\t$counts[$row[0]] = $row[1];\t\n\tif (!isset($counts[\"leecher\"]))\n\t\t$counts[\"leecher\"] = 0;\n\tif (!isset($counts[\"seeder\"]))\n\t\t$counts[\"seeder\"] = 0;\n\n\tif ($counts[\"seeder\"] != $seeders)\n\t{\n\t\tquickQuery(\"UPDATE \".$prefix.\"summary SET seeds=\".$counts[\"seeder\"].\" WHERE info_hash=\\\"$hash\\\"\");\n\t\techo \"<td class=\\\"center\\\">$seeders -> \".$counts[\"seeder\"].\"</td>\";\n\t}\n\telse\n\t\techo \"<td class=\\\"center\\\">$seeders</td>\";\n\t\t\n\tif ($counts[\"leecher\"] != $leechers)\n\t{\n\t\tquickQuery(\"UPDATE \".$prefix.\"summary SET leechers=\".$counts[\"leecher\"].\" WHERE info_hash=\\\"$hash\\\"\");\n\t\techo \"<td class=\\\"center\\\">$leechers -> \".$counts[\"leecher\"].\"</td>\";\n\t}\n\telse\n\t\techo \"<td class=\\\"center\\\">$leechers</td>\";\n\t\t\n\tif ($counts[\"leecher\"] == 0)\n\t{\n\t\t//If there are no leechers, set the speed to zero\n\t\tquickQuery(\"UPDATE \".$prefix.\"summary set speed=0 WHERE info_hash=\\\"$hash\\\"\");\n\t}\n\n\tif ($bytes < 0)\n\t{\n\t\tquickQuery(\"UPDATE \".$prefix.\"summary SET dlbytes=0 WHERE info_hash=\\\"$hash\\\"\");\n\t\techo \"<td class=\\\"center\\\">$bytes -> Zero</td>\";\n\t}\n\telse\n\t\techo \"<td class=\\\"center\\\">\". round($bytes/1048576/1024,3) .\" GB</td>\";\n\n\tmyTrashCollector($hash, $report_interval, time(), $writeout);\n\techo \"<td class=\\\"center\\\">\";\n\t\n\t$result = mysql_query(\"SELECT \".$prefix.\"x$hash.sequence FROM \".$prefix.\"x$hash LEFT JOIN \".$prefix.\"y$hash ON \".$prefix.\"x$hash.sequence = \".$prefix.\"y$hash.sequence WHERE \".$prefix.\"y$hash.sequence IS NULL\") or die(errorMessage() . \"\" . mysql_error() . \"</p>\");\n\tif (mysql_num_rows($result) > 0)\n\t{\n\t\techo \"Added \", mysql_num_rows($result);\n\t\t$row = array();\n\t\t\n\t\twhile ($data = mysql_fetch_row($result))\n\t\t\t\t$row[] = \"sequence=\\\"${data[0]}\\\"\";\n\t\t$where = implode(\" OR \", $row);\n\t\t$query = mysql_query(\"SELECT * FROM \".$prefix.\"x$hash WHERE $where\");\n\t\t\n\t\twhile ($row = mysql_fetch_assoc($query))\n\t\t{\n\t\t\t$compact = mysql_real_escape_string(pack('Nn', ip2long($row[\"ip\"]), $row[\"port\"]));\n\t\t\t$peerid = mysql_real_escape_string('2:ip' . strlen($row[\"ip\"]) . ':' . $row[\"ip\"] . '7:peer id20:' . hex2bin($row[\"peer_id\"]) . \"4:porti{$row[\"port\"]}e\");\n\t\t\t$no_peerid = mysql_real_escape_string('2:ip' . strlen($row[\"ip\"]) . ':' . $row[\"ip\"] . \"4:porti{$row[\"port\"]}e\");\n\t\t\tmysql_query(\"INSERT INTO \".$prefix.\"y$hash SET sequence='{$row[\"sequence\"]}', compact='$compact', with_peerid='$peerid', without_peerid='$no_peerid'\");\n\t\t}\n\t}\t\n\telse\n\t\techo \"Added none\";\n\n\t$result = mysql_query(\"SELECT \".$prefix.\"y$hash.sequence FROM \".$prefix.\"y$hash LEFT JOIN \".$prefix.\"x$hash ON \".$prefix.\"y$hash.sequence = \".$prefix.\"x$hash.sequence WHERE \".$prefix.\"x$hash.sequence IS NULL\");\n\tif (mysql_num_rows($result) > 0)\n\t{\n\t\techo \", Deleted \",mysql_num_rows($result);\n\n\t\t$row = array();\n\t\t\n\t\twhile ($data = mysql_fetch_row($result))\n\t\t\t$row[] = \"sequence=\\\"${data[0]}\\\"\";\n\t\t$where = implode(\" OR \", $row);\n\t\t$query = mysql_query(\"DELETE FROM \".$prefix.\"y$hash WHERE $where\");\n\t}\n\telse\n\t\techo \", Deleted none\";\n\n\techo \"</td>\";\n\t\n\techo \"</tr>\\n\";\n\t$i ++;\n\n\n\tif ($locking)\n\t\tquickQuery(\"UNLOCK TABLES\");\n\t\t\n\t//Repair tables, is this necessary?  Sometimes the tables crash...\n\t//Can't repair table if locked?\n\t//quickQuery(\"REPAIR Table x$hash\");\n\t//quickQuery(\"REPAIR Table y$hash\");\n\n\t// Finally, it's time to do stuff to the summary table.\n\tif (!empty($summaryupdate))\n\t{\n\t\t$stuff = \"\";\n\t\tforeach ($summaryupdate as $column => $value)\n\t\t{\n\t\t\t$stuff .= ', '.$column. ($value[1] ? \"=\" : \"=$column+\") . $value[0];\n\t\t}\n\t\tmysql_query(\"UPDATE \".$prefix.\"summary SET \".substr($stuff, 1).\" WHERE info_hash=\\\"$hash\\\"\");\n\t\t$summaryupdate = array();\n\t}\n\n\n}\n\nfunction myTrashCollector($hash, $timeout, $now, $writeout)\n{\n//\terror_log(\"Trash collector working on $hash\");\n \trequire(\"config.php\");\n \t$peers = loadLostPeers($hash, $timeout);\n \tfor ($i=0; $i < $peers[\"size\"]; $i++)\n\t        killPeer($peers[$i][\"peer_id\"], $hash, $peers[$i][\"bytes\"], $peers[$i]);\n\tif ($i != 0)\n\t\techo \"<td class=\\\"center\\\">Removed $i</td>\";\n\telse\n\t\techo \"<td class=\\\"center\\\">Removed 0</td>\";\n \tquickQuery(\"UPDATE \".$prefix.\"summary SET lastcycle='$now' WHERE info_hash='$hash'\");\n}\n\n\n\n\n?>\n</table>\n<p><a href=\"sanity.php?nolock=on\">Not working? Try running this.</a></p>\n<a href=\"index.php\"><img src=\"images/stats.png\" border=\"0\" class=\"icon\" alt=\"Tracker Statistics\" title=\"Tracker Statistics\" /></a><a href=\"index.php\">Return to Statistics Page</a><br>\n<a href=\"admin.php\"><img src=\"images/admin.png\" border=\"0\" class=\"icon\" alt=\"Admin Page\" title=\"Admin Page\" /></a><a href=\"admin.php\">Return to Admin Page</a>\n</body>\n</html>\n", "<?php\nrequire_once(\"config.php\");\nrequire_once(\"funcsv2.php\");\n\n$summaryupdate = array();\n\n// Non-persistant: we lock tables!\n$db = mysql_connect($dbhost, $dbuser, $dbpass) or die(errorMessage() . \"Tracker error: can't connect to database - \".mysql_error() . \"</p>\");\nmysql_select_db($database) or die(errorMessage() . \"Tracker error: can't open database $database - \".mysql_error() . \"</p>\");\n\n\nquickQuery(\"LOCK TABLES \".$prefix.\"summary WRITE, \".$prefix.\"namemap READ\");\n\n$results = mysql_query(\"SELECT \".$prefix.\"summary.info_hash, seeds, leechers, dlbytes, \".$prefix.\"namemap.filename FROM \".$prefix.\"summary LEFT JOIN \".$prefix.\"namemap ON \".$prefix.\"summary.info_hash = \".$prefix.\"namemap.info_hash\");\n\n$i = 0;\n\nwhile ($row = mysql_fetch_row($results))\n{\n\t$writeout = \"row\" . $i % 2;\n\tlist($hash, $seeders, $leechers, $bytes, $filename) = $row;\n\tif (isset($locking) && $locking)\n\t{\n\t\t//peercaching ALWAYS on\n\t\tquickQuery(\"LOCK TABLES \".$prefix.\"x$hash WRITE, \".$prefix.\"y$hash WRITE, \".$prefix.\"summary WRITE\");\n\t}\n\t$results2 = mysql_query(\"SELECT status, COUNT(status) FROM \".$prefix.\"x$hash GROUP BY status\");\n\n\tif (!$results2)\n\t{\n\t\t//unable to process\n\t\tcontinue;\n\t}\n\n\t$counts = array();\n\twhile ($row = mysql_fetch_row($results2))\n\t\t$counts[$row[0]] = $row[1];\t\n\tif (!isset($counts[\"leecher\"]))\n\t\t$counts[\"leecher\"] = 0;\n\tif (!isset($counts[\"seeder\"]))\n\t\t$counts[\"seeder\"] = 0;\n\n\tif ($counts[\"leecher\"] != $leechers)\n\t\tquickQuery(\"UPDATE \".$prefix.\"summary SET leechers=\".$counts[\"leecher\"].\" WHERE info_hash=\\\"$hash\\\"\");\n\n\tif ($counts[\"seeder\"] != $seeders)\n\t\tquickQuery(\"UPDATE \".$prefix.\"summary SET seeds=\".$counts[\"seeder\"].\" WHERE info_hash=\\\"$hash\\\"\");\n\t\t\n\tif ($counts[\"leecher\"] == 0)\n\t{\n\t\t//If there are no leechers, set the speed to zero\n\t\tquickQuery(\"UPDATE \".$prefix.\"summary set speed=0 WHERE info_hash='$hash'\");\n\t}\n\t\n\n\tif ($bytes < 0)\n\t\tquickQuery(\"UPDATE \".$prefix.\"summary SET dlbytes=0 WHERE info_hash='$hash'\");\n\n\tmyTrashCollector($hash, $report_interval, time(), $writeout);\n\n\t$result = mysql_query(\"SELECT \".$prefix.\"x$hash.sequence FROM \".$prefix.\"x$hash LEFT JOIN \".$prefix.\"y$hash ON \".$prefix.\"x$hash.sequence = \".$prefix.\"y$hash.sequence WHERE \".$prefix.\"y$hash.sequence IS NULL\") or die(errorMessage() . \"\" . mysql_error() . \"</p>\");\n\tif (mysql_num_rows($result) > 0)\n\t{\n\t\t$row = array();\n\t\t\n\t\twhile ($data = mysql_fetch_row($result))\n\t\t\t\t$row[] = \"sequence=\\\"${data[0]}\\\"\";\n\t\t$where = implode(\" OR \", $row);\n\t\t$query = mysql_query(\"SELECT * FROM \".$prefix.\"x$hash WHERE $where\");\n\t\t\n\t\twhile ($row = mysql_fetch_assoc($query))\n\t\t{\n\t\t\t$compact = mysql_real_escape_string(pack('Nn', ip2long($row[\"ip\"]), $row[\"port\"]));\n\t\t\t$peerid = mysql_real_escape_string('2:ip' . strlen($row[\"ip\"]) . ':' . $row[\"ip\"] . '7:peer id20:' . hex2bin($row[\"peer_id\"]) . \"4:porti{$row[\"port\"]}e\");\n\t\t\t$no_peerid = mysql_real_escape_string('2:ip' . strlen($row[\"ip\"]) . ':' . $row[\"ip\"] . \"4:porti{$row[\"port\"]}e\");\n\t\t\tmysql_query(\"INSERT INTO \".$prefix.\"y$hash SET sequence='{$row[\"sequence\"]}', compact='$compact', with_peerid='$peerid', without_peerid='$no_peerid'\");\n\t\t}\n\t}\t\n\n\t$result = mysql_query(\"SELECT \".$prefix.\"y$hash.sequence FROM \".$prefix.\"y$hash LEFT JOIN \".$prefix.\"x$hash ON \".$prefix.\"y$hash.sequence = \".$prefix.\"x$hash.sequence WHERE \".$prefix.\"x$hash.sequence IS NULL\");\n\tif (mysql_num_rows($result) > 0)\n\t{\n\t\t$row = array();\n\t\t\n\t\twhile ($data = mysql_fetch_row($result))\n\t\t\t$row[] = \"sequence=\\\"${data[0]}\\\"\";\n\t\t$where = implode(\" OR \", $row);\n\t\t$query = mysql_query(\"DELETE FROM \".$prefix.\"y$hash WHERE $where\");\n\t}\n\n\n\t$i ++;\n\n\tquickQuery(\"UNLOCK TABLES\");\n\t\n\t//Repair tables, is this necessary?  Sometimes the tables crash...\n\t//Can't repair table if locked?\n\t//quickQuery(\"REPAIR Table x$hash\");\n\t//quickQuery(\"REPAIR Table y$hash\");\n\n\t// Finally, it's time to do stuff to the summary table.\n\tif (!empty($summaryupdate))\n\t{\n\t\t$stuff = \"\";\n\t\tforeach ($summaryupdate as $column => $value)\n\t\t{\n\t\t\t$stuff .= ', '.$column. ($value[1] ? \"=\" : \"=$column+\") . $value[0];\n\t\t}\n\t\tmysql_query(\"UPDATE \".$prefix.\"summary SET \".substr($stuff, 1).\" WHERE info_hash=\\\"$hash\\\"\");\n\t\t$summaryupdate = array();\n\t}\n\t\t\n}\n\n\nfunction myTrashCollector($hash, $timeout, $now, $writeout)\n{\n\trequire(\"config.php\");\n\t$peers = loadLostPeers($hash, $timeout);\n\tfor ($i=0; $i < $peers[\"size\"]; $i++) {\n\t        killPeer($peers[$i][\"peer_id\"], $hash, $peers[$i][\"bytes\"], $peers[$i]);\n\t}\n \tquickQuery(\"UPDATE \".$prefix.\"summary SET lastcycle='$now' WHERE info_hash='$hash'\");\n}\n\n?>", "<?php\nrequire (\"config.php\");\nrequire_once (\"funcsv2.php\");\n//Check session\nsession_start();\n\nif (!$_SESSION['admin_logged_in'])\n{\n\t//check fails\n\theader(\"Location: authenticate.php?status=session\");\n\texit();\n}\n?>\n\n<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\" \"http://www.w3.org/TR/html4/loose.dtd\">\n\n<html>\n<head>\n\t<title>Tracker User Statistics</title>\n\t<meta http-equiv=\"Content-Type\" content=\"text/html; charset=iso-8859-1\" />\n\t<link rel=\"stylesheet\" href=\"./css/style.css\" type=\"text/css\" />\n</head>\n<body>\n<h1>Tracker User Statistics</h1>\n\n<form action=\"<?php echo htmlentities($_SERVER['PHP_SELF']);?>\" method=\"POST\">\nFilename Search:<input type=\"text\" name=\"filename_search\" size=\"40\"<?php if (isset($_POST[\"filename_search\"]))echo \" value=\\\"\" . filterData($_POST[\"filename_search\"]) . \"\\\"\";?>>\n<input type=\"submit\" value=\"Search\">\n</form>\n<br>\n\n<?php\nrequire_once (\"config.php\");\nrequire_once (\"funcsv2.php\");\n\n//connect to database and grab each torrent in database\nif ($GLOBALS[\"persist\"])\n\t$db = mysql_pconnect($dbhost, $dbuser, $dbpass) or die(errorMessage() . \"Tracker error: can't connect to database - \" . mysql_error() . \"</p>\");\nelse\n\t$db = mysql_connect($dbhost, $dbuser, $dbpass) or die(errorMessage() . \"Tracker error: can't connect to database - \" . mysql_error() . \"</p>\");\nmysql_select_db($database) or die(errorMessage() . \"Tracker error: can't open database $database - \" . mysql_error() . \"</p>\");\n\n//Display search information\nif (isset($_POST[\"filename_search\"]) && $_POST[\"filename_search\"] != \"\")\n{\n\techo \"<h2 align=\\\"center\\\">Search Results:</h2>\";\n\t$query = \"SELECT * FROM \".$prefix.\"summary LEFT JOIN \".$prefix.\"namemap ON \".$prefix.\"summary.info_hash = \".$prefix.\"namemap.info_hash WHERE \".$prefix.\"namemap.filename REGEXP \\\"$_POST[filename_search]\\\" ORDER BY \".$prefix.\"namemap.filename\";\n}\nelse //display everything\n{\n\t$scriptname = htmlentities($_SERVER['PHP_SELF']) . \"?\";\n\t\n\tif (!isset($_GET[\"activeonly\"])) \n\t\techo \"<a href=\\\"$scriptname\" . \"activeonly=yes\\\">Show only torrents with seeders/leechers</a>\\n\";\n\telse\n\t{\n\t\techo \"<a href=\\\"$scriptname\\\">Show all torrents</a>\\n\";\n\t\t$scriptname = $scriptname . \"activeonly=yes&\";\t\n\t}\n\n\tif (isset($_GET[\"activeonly\"]))\n\t\t$where = \" WHERE leechers+seeds > 0\";\n\telse\n\t\t$where = \" \";\n\t\n\t$query = \"SELECT COUNT(*) FROM \".$prefix.\"summary $where\";\n\t$results = mysql_query($query);\n\t$res = mysql_result($results,0,0);\n\t\n\techo \"<p align='center'>Page: \\n\";\n\t$count = 0;\n\t$page = 1;\n\twhile($count < $res)\n\t{\n\t\tif (isset($_GET[\"page_number\"]) && $page == $_GET[\"page_number\"])\n\t\t\techo \"<b><a href=\\\"$scriptname\" . \"page_number=$page\\\">($page)</a></b>-\\n\";\n\t\telse if (!isset($_GET[\"page_number\"]) && $page == 1)\n\t\t\techo \"<b><a href=\\\"$scriptname\" . \"page_number=$page\\\">($page)</a></b>-\\n\";\n\t\telse\n\t\t\techo \"<a href=\\\"$scriptname\" . \"page_number=$page\\\">$page</a>-\\n\";\n\t\t$page++;\n\t\t$count = $count + ($GLOBALS[\"statspagelimitspecify\"]);\n\t}\n\techo \"</p>\\n\";\n\t\n\tif (!isset($_GET[\"page_number\"]))\n\t\t$query = \"SELECT * FROM \".$prefix.\"summary LEFT JOIN \".$prefix.\"namemap ON \".$prefix.\"summary.info_hash = \".$prefix.\"namemap.info_hash $where ORDER BY \".$prefix.\"namemap.filename LIMIT 0,${GLOBALS['statspagelimitspecify']}\";\n\telse\n\t{\n\t\t$page_limit = ($_GET[\"page_number\"] - 1) * ($GLOBALS[\"statspagelimitspecify\"]);\n\t\t$query = \"SELECT * FROM \".$prefix.\"summary LEFT JOIN \".$prefix.\"namemap ON \".$prefix.\"summary.info_hash = \".$prefix.\"namemap.info_hash $where ORDER BY \".$prefix.\"namemap.filename LIMIT $page_limit,${GLOBALS['statspagelimitspecify']}\";\n\t}\n}\n\n$results = mysql_query($query) or die(errorMessage() . \"Can't do SQL query - \" . mysql_error() . \"</p>\");\n\nwhile ($data = mysql_fetch_row($results))\n{\n\t$xhash = \"x\" . $data[0];\n\t$query2 = \"SELECT * FROM \".$prefix.\"$xhash\";\n\t$results2 = mysql_query($query2) or die(errorMessage() . \"Can't do SQL query - \" . mysql_error() . \"</p>\");\n\n\tif (mysql_num_rows($results2) == 0 && isset($_GET[\"activeonly\"]))\n\t\tbreak;\n\telse\n\t{\n\t\techo \"<hr><table>\\n\";\n\t\techo \"<tr><th>Info Hash</th><th>Filename</th><th>URL</th><th>File Size</th><th>Publication Date</th></tr>\\n\";\n\t\techo \"<tr><td>\" . $data[0] . \"</td><td>\" . $data[11] . \"</td><td>\\n\";\n\t\tif (Substr($data[12], 0, 7) == \"http://\")\n\t\t\techo \"<a href=\\\"\" . $data[12] . \"\\\">\" . $data[12] . \"</a>\\n\";\n\t\telse\n\t\t\techo $data[12];\n\t\techo \"</td><td>\" . bytesToString($data[13]) . \"</td>\\n\";\n\t\techo \"<td>\" . $data[14] . \"</td></tr>\\n\";\n\t\techo \"</table>\\n\";\n\t}\n\n\techo \"<table>\\n\";\n\techo \"<tr><th class=\\\"subheader\\\">IP Address</th><th class=\\\"subheader\\\">Data Left to Download</th><th class=\\\"subheader\\\" width=200>Percent Finished</th><th class=\\\"subheader\\\">Port</th><th class=\\\"subheader\\\">Last Update</th><th class=\\\"subheader\\\">NAT User</th></tr>\\n\";\n\twhile ($data2 = mysql_fetch_row($results2))\n\t{\n\t\t//grab information on each user\n\t\techo \"<tr><td>\" . $data2[2] . \"</td>\\n\";\n\t\techo \"<td>\" . bytesToString($data2[1]) . \"</td>\\n\";\n\n\t\t//calculate percent done for user\n\t\t$percent_done = 1.00;\n\t\tif ($data2[1] != 0) //only run calculation if they are still downloading\n\t\t{\n\t\t\t$size_in_bytes = $data[13];\n\t\t\tif ($size_in_bytes == 0) //thou shalt not divide by zero\n\t\t\t\t$percent_done = 0;\n\t\t\telse\n\t\t\t\t$percent_done = round(($size_in_bytes - $data2[1]) / $size_in_bytes, 3);\n\t\t}\n\n\t\t?>\n\t\t<td>\n\t\t<table class=\"percentages\" cellspacing=\"0\">\n\t\t<tr>\n\t\t<td align=\"right\" class=\"percent\" width=\"<?php echo round($percent_done * 200, 0); ?>\" height=\"15\">\n\t\t<?php if ($percent_done > .5) echo $percent_done * 100 . \"%\"; ?>\n\t\t</td>\n\t\t<td align=\"left\" class=\"percentleft\" width=\"<?php echo 200 - round($percent_done * 200, 0); ?>\" height=\"15\">\n\t\t<?php if ($percent_done <= .5) echo $percent_done * 100 . \"%\"; ?>\t\t\n\t\t</td>\n\t\t</tr>\n\t\t</table>\n\t\t</td>\n\t\t<?php\n\t\techo \"<td>\" . $data2[3] . \"</td>\\n\"; //port\n\t\techo \"<td>\" . date('g:ia m-d-Y', $data2[5]) . \"</td>\\n\"; //last time check-in\n\t\techo \"<td>\" . $data2[7] . \"</td>\\n\"; //NAT user\n\t\techo \"</tr>\\n\";\n\t}\n\techo \"</table><br>\\n\";\n}\necho \"<hr>\";\nif (!isset($_POST[\"filename_search\"]))\n{\n\techo \"<p align='center'>Page: \\n\";\n\t$count = 0;\n\t$page = 1;\n\twhile($count < $res)\n\t{\n\tif (isset($_GET[\"page_number\"]) && $page == $_GET[\"page_number\"])\n\t\techo \"<b><a href=\\\"$scriptname\" . \"page_number=$page\\\">($page)</a></b>-\\n\";\n\telse if (!isset($_GET[\"page_number\"]) && $page == 1)\n\t\techo \"<b><a href=\\\"$scriptname\" . \"page_number=$page\\\">($page)</a></b>-\\n\";\n\telse\n\t\techo \"<a href=\\\"$scriptname\" . \"page_number=$page\\\">$page</a>-\\n\";\n\t$page++;\n\t$count = $count + ($GLOBALS[\"statspagelimitspecify\"]);\n\t}\n\techo \"</p>\\n\";\n}\n?>\n\n<a href=\"admin.php\"><img src=\"images/admin.png\" border=\"0\" class=\"icon\" alt=\"Admin Page\" title=\"Admin Page\" /></a><a href=\"admin.php\">Return to Admin Page</a>\n</body>\n</html>\n"], "filenames": ["css.php", "edit_database.php", "sanity.php", "sanity_no_output.php", "statistics.php"], "buggy_code_start_loc": [13, 39, 142, 52, 27], "buggy_code_end_loc": [174, 40, 146, 127, 28], "fixing_code_start_loc": [14, 39, 142, 52, 27], "fixing_code_end_loc": [182, 40, 146, 127, 28], "type": "CWE-79", "message": "A vulnerability was found in ahmyi RivetTracker. It has been declared as problematic. Affected by this vulnerability is the function changeColor of the file css.php. The manipulation of the argument set_css leads to cross site scripting. The attack can be launched remotely. The name of the patch is 45a0f33876d58cb7e4a0f17da149e58fc893b858. It is recommended to apply a patch to fix this issue. The associated identifier of this vulnerability is VDB-217267.", "other": {"cve": {"id": "CVE-2012-10002", "sourceIdentifier": "cna@vuldb.com", "published": "2023-01-03T09:15:09.463", "lastModified": "2023-01-09T20:01:34.220", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "A vulnerability was found in ahmyi RivetTracker. It has been declared as problematic. Affected by this vulnerability is the function changeColor of the file css.php. The manipulation of the argument set_css leads to cross site scripting. The attack can be launched remotely. The name of the patch is 45a0f33876d58cb7e4a0f17da149e58fc893b858. It is recommended to apply a patch to fix this issue. The associated identifier of this vulnerability is VDB-217267."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}], "cvssMetricV30": [{"source": "cna@vuldb.com", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:L/UI:R/S:U/C:N/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "UNCHANGED", "confidentialityImpact": "NONE", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 3.5, "baseSeverity": "LOW"}, "exploitabilityScore": 2.1, "impactScore": 1.4}], "cvssMetricV2": [{"source": "cna@vuldb.com", "type": "Secondary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:S/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "SINGLE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.0}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.0, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "cna@vuldb.com", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:rivettracker_project:rivettracker:*:*:*:*:*:*:*:*", "versionEndExcluding": "2012-03-13", "matchCriteriaId": "A0C825B5-2FD7-4DC4-A925-F1C355B4C5E4"}]}]}], "references": [{"url": "https://github.com/ahmyi/rivettracker/commit/45a0f33876d58cb7e4a0f17da149e58fc893b858", "source": "cna@vuldb.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/ahmyi/rivettracker/pull/1", "source": "cna@vuldb.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://vuldb.com/?ctiid.217267", "source": "cna@vuldb.com", "tags": ["Third Party Advisory"]}, {"url": "https://vuldb.com/?id.217267", "source": "cna@vuldb.com", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/ahmyi/rivettracker/commit/45a0f33876d58cb7e4a0f17da149e58fc893b858"}}