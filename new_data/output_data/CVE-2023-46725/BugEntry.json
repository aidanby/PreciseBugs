{"buggy_code": ["<h1 align=\"center\">\n  <a href=\"https://www.foodcoopshop.com\"><img src=\"https://raw.githubusercontent.com/foodcoopshop/foodcoopshop/develop/webroot/files/images/logo.png\" alt=\"FoodCoopShop\"></a>\n</h1>\n\n# Changelog v3.x\n\nDas Format basiert auf [keepachangelog.com](http://keepachangelog.com) und verwendet [Semantic Versioning](http://semver.org/).\n\n## v3.6.0\n\n### Neue Datenschutz-Funktionen\n- Personenbezogene Mitglieder-Daten (Vorname, Nachname, E-Mail) k\u00f6nnen nun f\u00fcr bestimmte Hersteller systemweit **anonymisiert** werden. Im Sinne des Datenschutzes ist das f\u00fcr neu angelegte Hersteller auch die Standard-Einstellung. [I#767](https://github.com/foodcoopshop/foodcoopshop/issues/767) / [I#929](https://github.com/foodcoopshop/foodcoopshop/issues/929) / [PR#930](https://github.com/foodcoopshop/foodcoopshop/pull/930) / [PR#932](https://github.com/foodcoopshop/foodcoopshop/pull/932) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- E-Mail-Adressen, die \u00fcber den Editor eingegeben wurden (z.B. auf Seiten oder in Blog-Artikeln), werden jetzt automatisch verlinkt und spamgesch\u00fctzt angezeigt. [I#933](https://github.com/foodcoopshop/foodcoopshop/issues/933) / [PR#943](https://github.com/foodcoopshop/foodcoopshop/pull/934) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n\n### Neue Funktionen / Verbesserungen\n- Ab sofort kann auch ein **dunkles Design / Dark Mode** verwendet werden. Das schont die Augen und spart bei OLED-Bildschirmen auch Strom. Einfach auf den Mond neben dem Anmelde-Link klicken. [I#873](https://github.com/foodcoopshop/foodcoopshop/issues/873) / [PR#913](https://github.com/foodcoopshop/foodcoopshop/pull/913) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Beim Anpassen des Gewichts f\u00fcr Produkte, die mehrmals bestellt wurden, ist jetzt ein **eingebauter Taschenrechner** hilfreich. Man kann z.B. \"192+167\" eintippen und das Ergebnis wird automatisch \u00fcbernommen. Der Taschenrechner ist auch im Selbstbedienungs-Modus integriert. [PR#923](https://github.com/foodcoopshop/foodcoopshop/pull/923) / [Commit](https://github.com/foodcoopshop/foodcoopshop/commit/449aedc29269cd1d74322c3f2239a4953d6500a5) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Superadmins k\u00f6nnen Tag und Uhrzeit der **Cronjobs** (z.B. die automatische Bestell-Erinnerung, Rechnungsversand) jetzt selber im Admin-Bereich (Homepage-Verwaltung / Einstellungen / neuer Tab \"Cronjobs\") \u00e4ndern. [I#860](https://github.com/foodcoopshop/foodcoopshop/issues/860) / [PR#74](https://github.com/foodcoopshop/foodcoopshop/pull/874) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Die \u00dcberschriften aller Tabellen im Admin-Bereich bleiben jetzt beim Scrollen sichtbar (nicht in iOS). [PR#888](https://github.com/foodcoopshop/foodcoopshop/pull/888) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Im Produkt-Admin kann jetzt der Status (aktiviert, deaktiviert) von mehreren markierten Produkten auf einmal ge\u00e4ndert werden. [I#895](https://github.com/foodcoopshop/foodcoopshop/issues/895) / [PR#897](https://github.com/foodcoopshop/foodcoopshop/pull/897) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Hersteller k\u00f6nnen ihre Bestellungen \u00fcber [eine neue API](https://foodcoopshop.github.io/de/netzwerk-modul.html#6-api-zum-abrufen-von-bestellungen) abrufen und sie so im eigenen System weiterverarbeiten. [I#894](https://github.com/foodcoopshop/foodcoopshop/issues/894) / [PR#899](https://github.com/foodcoopshop/foodcoopshop/pull/899) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Bei der Umsatzstatistik kann jetzt auch nach \"letzte 12 bzw. 24 Monate\" gefiltert werden. [I#904](https://github.com/foodcoopshop/foodcoopshop/issues/904) / [PR#908](https://github.com/foodcoopshop/foodcoopshop/pull/908) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Bei allen Produkten kann jetzt die Anzahl der bestellten Einheiten f\u00fcr den n\u00e4chsten Abholtag angezeigt werden. Das hilft, wenn bestimmte Gebindegr\u00f6\u00dfen erreicht werden sollen. [I#909](https://github.com/foodcoopshop/foodcoopshop/issues/909) / [PR#910](https://github.com/foodcoopshop/foodcoopshop/pull/910) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Beim Umbuchen auf ein anderes Mitglied kann jetzt \u00fcber eine Checkbox ausgew\u00e4hlt werden, ob die betroffenen Mitglieder per Mail benachrichtigt werden sollen. [I#920](https://github.com/foodcoopshop/foodcoopshop/issues/920) / [PR#921](https://github.com/foodcoopshop/foodcoopshop/pull/921) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Bei einer herstellerbasierten Lieferpause sind Lagerprodukte jetzt weiterhin vorbestellbar. [PR#924](https://github.com/foodcoopshop/foodcoopshop/pull/924) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Alle Initiativen, die die Funktion \"Rechnung an Kunden\" aktiviert haben, werden jetzt mit einer E-Mail \u00fcber einen Bestell-Kommentar benachrichtigt. [PR#926](https://github.com/foodcoopshop/foodcoopshop/pull/926) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Die Konfiguration \"Freitag Bestellschluss / Samstag Bestelllisten-Versand / Donnerstag Abholtag\" ist jetzt m\u00f6glich. [I#866](https://github.com/foodcoopshop/foodcoopshop/issues/866) / [PR#867](https://github.com/foodcoopshop/foodcoopshop/pull/867) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n\n### For developers\n- New \ud83d\udc33 [Docker Dev Environment](https://foodcoopshop.github.io/en/docker-dev-environment.html) and [Gitpod-Integration](https://gitpod.io/#https://github.com/foodcoopshop/foodcoopshop).  [I#871](https://github.com/foodcoopshop/foodcoopshop/issues/871) / [PR#876](https://github.com/foodcoopshop/foodcoopshop/pull/876) / [PR#879](https://github.com/foodcoopshop/foodcoopshop/pull/879) / [PR#881](https://github.com/foodcoopshop/foodcoopshop/pull/881) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Enable strict typing in every php file to improve code quality. [I#872](https://github.com/foodcoopshop/foodcoopshop/issues/872) / [PR#893](https://github.com/foodcoopshop/foodcoopshop/pull/893) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Replace CakePHP's deprecated classes: File, Folder, Shell. [I#902](https://github.com/foodcoopshop/foodcoopshop/issues/902) [I#906](https://github.com/foodcoopshop/foodcoopshop/issues/906) / [PR#905](https://github.com/foodcoopshop/foodcoopshop/pull/905) / [PR#907](https://github.com/foodcoopshop/foodcoopshop/pull/907) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Die Software ist jetzt kompatibel mit PHP 8.2. [I#915](https://github.com/foodcoopshop/foodcoopshop/issues/915) / [PR#916](https://github.com/foodcoopshop/foodcoopshop/pull/916) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n\n### Bugfixes\n- Sofern Rechnungen an Kunden generiert wurden (Dorfladen) UND die Steuer f\u00fcr Pfand nicht auf 20% gesetzt war, wurde die Steuer von geliefertem Pfand trotzdem immer mit 20% berechnet. [I#940](https://github.com/foodcoopshop/foodcoopshop/issues/940) / [PR#941](https://github.com/foodcoopshop/foodcoopshop/pull/941) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Bei Sofort-Bestellungen ist es ab sofort nicht mehr m\u00f6glich, das erneute Laden von langsamen Seiten durch wiederholtes Klicken zu erzwingen. Diese Mehrfach-Requests haben n\u00e4mlich den eingeloggten User und den User, f\u00fcr den bestellt wird, durcheinandergewirbelt. [I#945](https://github.com/foodcoopshop/foodcoopshop/issues/945) / [PR#946](https://github.com/foodcoopshop/foodcoopshop/pull/946) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n\nDatum: 12.04.2023 / [Mehr Details zum Release](https://github.com/foodcoopshop/foodcoopshop/projects/18) / [Alle \u00c4nderungen anzeigen](https://github.com/foodcoopshop/foodcoopshop/compare/v3.5.1...v3.6.0)\n\n# v3.5.1\n\n### Herzlichen Dank an alle beteiligten Personen\n* <img src=\"https://github.com/mrothauer.png\" width=\"20\"> [mrothauer](https://github.com/mrothauer)\n* <img src=\"https://github.com/pabneukistl.png\" width=\"20\"> [pabneukistl](https://github.com/pabneukistl)\n* <img src=\"https://github.com/toblinga.png\" width=\"20\"> [toblinga](https://github.com/toblinga)\n\n### Bugfixes\n- Das mysteri\u00f6se Verschwinden von Produkt-Bildern ist gel\u00f6st. Ob deine Installation vom Bug betroffen ist, kannst du \u00fcber diese Route feststellen: /admin/products/detectMissingProductImages. [I#824](https://github.com/foodcoopshop/foodcoopshop/issues/824)\n- Die Umsatzsteuer wurde beim Abschlie\u00dfen des Warenkorb immer mit 0,00 \u20ac ausgewiesen. [Commit](https://github.com/foodcoopshop/foodcoopshop/commit/cb876b9ae7d384c576f7bf60649af94260564414)\n- Bei einer Barcode-Suche im Selbstbedienungs-Modus wurde immer nur die erste Variante direkt in den Warenkorb gelegt. [I#939](https://github.com/foodcoopshop/foodcoopshop/issues/939)\n- In seltenen F\u00e4llen wurden bei der Barcode-Suche falsche Produkte angezeigt. [I#938](https://github.com/foodcoopshop/foodcoopshop/issues/938)\n- Bei einer Sofort-Bestellung wurde bei Dorfl\u00e4den unter bestimmten Umst\u00e4nden Verkaufspreis und Einkaufspreis in der Anzeige verwechselt. Bestell- und Rechnungsdaten waren korrekt, es war \"lediglich\" ein Anzeigeproblem. [I#937](https://github.com/foodcoopshop/foodcoopshop/issues/937)\n- Anpassungen der Hello-Cash-API-Requests.\n\nDatum: 28.02.2023 / [Alle \u00c4nderungen anzeigen](https://github.com/foodcoopshop/foodcoopshop/compare/v3.5.0...v3.5.1)\n\n# v3.5.0\n\n### Herzlichen Dank an alle beteiligten Personen\n* <img src=\"https://github.com/MaxGitHubAccount.png\" width=\"20\"> [MaxGitHubAccount](https://github.com/MaxGitHubAccount)\n* <img src=\"https://github.com/mrothauer.png\" width=\"20\"> [mrothauer](https://github.com/mrothauer)\n\n### \u00c4nderung der Open-Source-Lizenz\n- Ab v3.5 wird der FoodCoopShop unter der GNU Affero General Public License v3.0 (AGPL) ver\u00f6ffentlicht. [I#837](https://github.com/foodcoopshop/foodcoopshop/issues/837) / [PR#845](https://github.com/foodcoopshop/foodcoopshop/pull/845)\n\n### Neue Funktionen / Verbesserungen\n- Das User-Men\u00fc rechts oben ist jetzt aufger\u00e4umter: Die Unterpunkte erscheinen bei Mouseover, bei Mitgliedern ist der verwirrende Button \"Admin-Bereich\" entfernt und die Admin-Men\u00fcstruktur ist bereits im Frontend abgebildet. [PR#836](https://github.com/foodcoopshop/foodcoopshop/pull/863) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Mitglieder und Hersteller k\u00f6nnen jetzt \u00fcber ein eigenes Formular Feedback verfassen, welches dann \u00f6ffentlich angezeigt wird. [Zur Online-Doku](https://foodcoopshop.github.io/de/user-feedback.html). [I#342](https://github.com/foodcoopshop/foodcoopshop/issues/342) / [PR#861](https://github.com/foodcoopshop/foodcoopshop/pull/861) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Verbesserte Darstellung der Blog-Artikel: Der Men\u00fcpunkt \"Aktuelles\" wandert in den Footer, hei\u00dft jetzt \"Blog-Archiv\"und zeigt nur noch jene Blog-Artikel an, die nicht auf der Startseite angezeigt werden. Im Blog-Archiv-Slider \u00fcber den Produkten werden nur noch die Blog-Artikel von der Startseite angezeigt. [I#790](https://github.com/foodcoopshop/foodcoopshop/issues/790) / [PR#795](https://github.com/foodcoopshop/foodcoopshop/pull/795) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Die Software beinhaltet jetzt eine Newsletter-Funktion. [Zur Online-Doku](https://foodcoopshop.github.io/de/mitglieder.html#newsletter-funktion). [I#818](https://github.com/foodcoopshop/foodcoopshop/issues/818) / [PR#823](https://github.com/foodcoopshop/foodcoopshop/pull/823) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Nach Klick auf \"Warenkorb anzeigen\" wird automatisch zum Button \"Zahlungspflichtig bestellen\" gescrollt. Dieser konnte - vor allem wenn viele Produkte im Warenkorb sind - leicht \u00fcbersehen werden. [PR#796](https://github.com/foodcoopshop/foodcoopshop/pull/796) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Schnellere Ladezeit des Produkt-Kataloges, speziell f\u00fcr Dorfladen-Online-Installationen. [I#763](https://github.com/foodcoopshop/foodcoopshop/issues/763) / [PR#813](https://github.com/foodcoopshop/foodcoopshop/pull/813) / [PR#815](https://github.com/foodcoopshop/foodcoopshop/pull/815) / [PR#822](https://github.com/foodcoopshop/foodcoopshop/pull/822) / [I#816](https://github.com/foodcoopshop/foodcoopshop/issues/816) / [PR#835](https://github.com/foodcoopshop/foodcoopshop/pull/835) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Der CSV-Upload f\u00fcr die Guthaben-Aufladungen unterst\u00fctzt jetzt auch die Sparkasse und die GLS-Bank. [C#1](https://github.com/foodcoopshop/foodcoopshop/commit/a3fc47e23d489efb545f57a33f43fecbebf65ed2) [C#2](https://github.com/foodcoopshop/foodcoopshop/commit/513021e6a7acc3e5e38a61489d45ecc813ce8a1d) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Da der E-Mail-Versand (z.B. Verschicken der Bestellbest\u00e4tigung) immer wieder komplizierte Probleme verursacht, werden ab sofort alle E-Mails in einer Queue gesammelt und \u00fcber einen Hintergrund-Prozess (Worker) versendet. [I#842](https://github.com/foodcoopshop/foodcoopshop/issues/842) / [PR#843](https://github.com/foodcoopshop/foodcoopshop/pull/843)\n- Bei der Produkt-Suche werden jetzt zuerst alle Produkte angezeigt, bei denen der Suchbegriff im Produktnamen vorkommt. Und dann jene mit dem Suchbegriff in der kurzen Beschreibung. [PR#852](https://github.com/foodcoopshop/foodcoopshop/pull/852)\n- Bei monatlichen Cronjobs kann jetzt mit dem Wert \"0\" auch der Monatsletzte als Ausf\u00fchrtag angegeben werden. [I#854](https://github.com/foodcoopshop/foodcoopshop/issues/854) / [PR#859](https://github.com/foodcoopshop/foodcoopshop/pull/859)\n- Die Umsatzsteuer in der Bestellbest\u00e4tigung kann nun mittels `app.showTaxInOrderConfirmationEmail => false` ausgeblendet werden. [PR#869](https://github.com/foodcoopshop/foodcoopshop/pull/869) <a href=\"https://github.com/MaxGitHubAccount\"><img src=\"https://github.com/MaxGitHubAccount.png\" width=\"20\"></a>\n\n### Neue Funktionen f\u00fcr den [Einzelhandels-Modus](https://foodcoopshop.github.io/de/dorfladen-online.html)\n- Kunden k\u00f6nnen sich jetzt auch als Firma (mit Firmennamen und optionaler Ansprechperson) registrieren. [I#819](https://github.com/foodcoopshop/foodcoopshop/issues/819) / [PR#821](https://github.com/foodcoopshop/foodcoopshop/pull/821) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- F\u00fcr Kunden-Rechnungen kann nun ein Pr\u00e4fix (max. 6 Zeichen) angegeben werden. Achtung: Nicht m\u00f6glich bei Verwendung der Hello-Cash-API! [I#809](https://github.com/foodcoopshop/foodcoopshop/issues/809) / [PR#810](https://github.com/foodcoopshop/foodcoopshop/pull/810) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Die Berechnung der Umsatzsteuer auf den Rechnungen kann jetzt so eingestellt werden, dass die Gesamt-Steuer auf Basis der Gesamt-Netto-Erl\u00f6se berechnet wird. Das ist f\u00fcr pauschalierte Betriebe sinnvoll, die die Software auch zur Verrechnung verwenden. Achtung: Nicht m\u00f6glich bei Verwendung der Hello-Cash-API! [I#807](https://github.com/foodcoopshop/foodcoopshop/issues/807) / [PR#812](https://github.com/foodcoopshop/foodcoopshop/pull/812) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Einkaufen zum Nullpreis ist jetzt auch f\u00fcr Dorfl\u00e4den ohne aktivierter Einkaufspreis-Funktion m\u00f6glich. So kann Lagerware, die erneut \u00fcber das System verkauft wird, bequem vorbestellt werden. [I#829](https://github.com/foodcoopshop/foodcoopshop/issues/829) / [PR#830](https://github.com/foodcoopshop/foodcoopshop/pull/830) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Die neue Umsatz- und Gewinnstatistik zeigt jetzt ausschlie\u00dflich Netto-Werte an (Netto-Einkaufpreis, Netto-Gewinn) und zus\u00e4tzulich den Gewinn-Aufschlag in %. [I#840](https://github.com/foodcoopshop/foodcoopshop/issues/840) / [PR#841](https://github.com/foodcoopshop/foodcoopshop/pull/841) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n\n### Bugfixes / Updates / Code cleaning\n- Ab und zu wurde man w\u00e4hrend bzw. nach Abschluss einer Sofort- oder Lagerprodukt-Bestellung ausgeloggt. [I#832](https://github.com/foodcoopshop/foodcoopshop/issues/832) / [PR#831](https://github.com/foodcoopshop/foodcoopshop/pull/831) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Produkt, das von Lieferrhythmus \"Sammelbestellung - mit abgelaufenem Bestellschlusss\" auf \"Lagerprodukt\" umgestellt wurde, war nicht bestellbar. [I#774](https://github.com/foodcoopshop/foodcoopshop/issues/774) / [PR#801](https://github.com/foodcoopshop/foodcoopshop/pull/801) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Beim Stornieren wird die Anzahl nicht mehr erh\u00f6ht, wenn das Produkt die Funktion \"Standard-Anzahl pro Lieferrhythmus\" verwendet. [I#838](https://github.com/foodcoopshop/foodcoopshop/issues/838) / [PR#839](https://github.com/foodcoopshop/foodcoopshop/pull/839) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Manchmal wurden \u00fcber den Editor Base64-codierte Bilder eingef\u00fcgt und gespeichert (z.B. Copy/Paste aus E-Mail-Client) und diese haben dann die Datenbank aufgebl\u00e4ht. Das ist jetzt systemweit unterbunden. [I#804](https://github.com/foodcoopshop/foodcoopshop/issues/804) / [PR#805](https://github.com/foodcoopshop/foodcoopshop/pull/805) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Support f\u00fcr MySQL 8.0 [I#803](https://github.com/foodcoopshop/foodcoopshop/issues/803) / [PR#806](https://github.com/foodcoopshop/foodcoopshop/pull/806) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Bootstrap v5 und Bootstrap Select v1.14 Updates. [I#679](https://github.com/foodcoopshop/foodcoopshop/issues/679) / [PR#828](https://github.com/foodcoopshop/foodcoopshop/pull/828) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- \u00dcberfl\u00fcssige Einstellung app.isDepositPaymentCashless wurde entfernt. [I#827](https://github.com/foodcoopshop/foodcoopshop/issues/827) / [PR#834](https://github.com/foodcoopshop/foodcoopshop/pull/834) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Das Stundenabrechnungs-Modul wurde schon lange nicht mehr verwendet und deswegen entfernt. [I#848](https://github.com/foodcoopshop/foodcoopshop/issues/848) / [PR#849](https://github.com/foodcoopshop/foodcoopshop/pull/849) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Die Software ist jetzt kompatibel mit PHP 8.1. [I#750](https://github.com/foodcoopshop/foodcoopshop/issues/750) / [PR#851](https://github.com/foodcoopshop/foodcoopshop/pull/851) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Doppelte Aufrufe von lang andauerenden Cronjobs sind jetzt nicht mehr m\u00f6glich. Das kam sehr selten vor, aber eben doch. [PR#853](https://github.com/foodcoopshop/foodcoopshop/pull/853) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Neuer CSS-Compressor: CssMin wurde durch CleanCss ersetzt. [PR#856](https://github.com/foodcoopshop/foodcoopshop/pull/856) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Fontawesome v6 Update. [PR#855](https://github.com/foodcoopshop/foodcoopshop/pull/855) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n\nDatum: 12.09.2022 / [Mehr Details zum Release](https://github.com/foodcoopshop/foodcoopshop/projects/17) / [Alle \u00c4nderungen anzeigen](https://github.com/foodcoopshop/foodcoopshop/compare/v3.4.2...v3.5.0)\n\n[Zum Changelog von FoodCoopShop v3.0-v3.4](devtools/CHANGELOG-v3.md)\n", "3.6.0", "<?php\ndeclare(strict_types=1);\n\nuse App\\Lib\\Error\\Exception\\InvalidParameterException;\nuse App\\Test\\TestCase\\AppCakeTestCase;\nuse Cake\\Core\\Configure;\nuse App\\Test\\TestCase\\Traits\\AppIntegrationTestTrait;\nuse App\\Test\\TestCase\\Traits\\LoginTrait;\n\n/**\n * FoodCoopShop - The open source software for your foodcoop\n *\n * Licensed under the GNU Affero General Public License version 3\n * For full copyright and license information, please see LICENSE\n * Redistributions of files must retain the above copyright notice.\n *\n * @since         FoodCoopShop 1.0.0\n * @license       https://opensource.org/licenses/AGPL-3.0\n * @author        Mario Rothauer <office@foodcoopshop.com>\n * @copyright     Copyright (c) Mario Rothauer, https://www.rothauer-it.com\n * @link          https://www.foodcoopshop.com\n */\nclass ProductsTableTest extends AppCakeTestCase\n{\n\n    use AppIntegrationTestTrait;\n    use LoginTrait;\n\n    public $Product;\n\n    public function setUp(): void\n    {\n        parent::setUp();\n        $this->Product = $this->getTableLocator()->get('Products');\n    }\n\n    public function testChangeImageValidImageAndDeleteImage()\n    {\n\n        // add image\n        $productId = 346;\n        $products = [\n            [$productId => WWW_ROOT . 'img/tests/test-image.jpg']\n        ];\n        $this->Product->changeImage($products);\n\n        $product = $this->Product->find('all', [\n            'conditions' => [\n                'Products.id_product' => $productId\n            ],\n            'contain' => [\n                'Images'\n            ]\n        ])->first();\n        $imageId = $product->image->id_image;\n\n        $imageIdAsPath = Configure::read('app.htmlHelper')->getProductImageIdAsPath($imageId);\n        $thumbsPath = Configure::read('app.htmlHelper')->getProductThumbsPath($imageIdAsPath);\n\n        foreach (Configure::read('app.productImageSizes') as $thumbSize => $options) {\n            $thumbsFileName = $thumbsPath . DS . $imageId . $options['suffix'] . '.' . 'jpg';\n            $this->assertTrue(file_exists($thumbsFileName), 'physical file not added');\n        }\n\n        // delete image\n        $products = [\n            [$productId => 'no-image']\n        ];\n        $this->Product->changeImage($products);\n\n        $product = $this->Product->find('all', [\n            'conditions' => [\n                'Products.id_product' => $productId\n            ],\n            'contain' => [\n                'Images'\n            ]\n        ])->first();\n\n        $this->assertTrue(empty($product->image));\n\n        foreach (Configure::read('app.productImageSizes') as $thumbSize => $options) {\n            $thumbsFileName = $thumbsPath . DS . $imageId . $options['suffix'] . '.' . 'jpg';\n            $this->assertFalse(file_exists($thumbsFileName), 'physical file not deleted');\n        }\n\n    }\n\n    public function testChangeImageInvalidImage()\n    {\n        $productId = 346;\n        $products = [\n            [$productId => Configure::read('App.fullBaseUrl') . '/css/global.css']\n        ];\n        $exceptionThrown = false;\n\n        try {\n            $this->Product->changeImage($products);\n        } catch (InvalidParameterException $e) {\n            $exceptionThrown = true;\n        }\n\n        $this->assertSame(true, $exceptionThrown);\n    }\n\n    public function testChangeImageNonExistingFile()\n    {\n        $productId = 346;\n        $products = [\n            [$productId => Configure::read('App.fullBaseUrl') . '/img/tests/non-existing-file.jpg']\n        ];\n        $exceptionThrown = false;\n\n        try {\n            $this->Product->changeImage($products);\n        } catch (InvalidParameterException $e) {\n            $exceptionThrown = true;\n        }\n\n        $this->assertSame(true, $exceptionThrown);\n    }\n\n    public function testGetCompositeProductIdAndAttributeId()\n    {\n        $tests = [\n            [\n                'ids' => [\n                    'productId' => 5,\n                    'attributeId' => 0\n                ],\n                'result' => '5',\n            ],\n            [\n                'ids' => [\n                    'productId' => 8,\n                    'attributeId' => 0\n                ],\n                'result' => 8,\n            ],\n            [\n                'ids' => [\n                    'productId' => 80,\n                    'attributeId' => 9\n                ],\n                'result' => '80-9',\n            ]\n        ];\n\n        foreach ($tests as $test) {\n            $result = $this->Product->getCompositeProductIdAndAttributeId($test['ids']['productId'], $test['ids']['attributeId']);\n            $this->assertEquals($test['result'], $result);\n        }\n    }\n\n    public function testGetProductIdAndAttributeId()\n    {\n        $tests = [\n            [\n                'id' => '5',\n                'result' => [\n                    'productId' => 5,\n                    'attributeId' => 0\n                ]\n            ],\n            [\n                'id' => 8,\n                'result' => [\n                    'productId' => 8,\n                    'attributeId' => 0\n                ]\n            ],\n            [\n                'id' => '80-9',\n                'result' => [\n                    'productId' => 80,\n                    'attributeId' => 9\n                ]\n            ]\n        ];\n\n        foreach ($tests as $test) {\n            $result = $this->Product->getProductIdAndAttributeId($test['id']);\n            $this->assertEquals($test['result'], $result);\n        }\n    }\n\n    public function testAddProduct()\n    {\n        $manufacturerId = $this->Customer->getManufacturerIdByCustomerId(Configure::read('test.vegetableManufacturerId'));\n        $manufacturer = $this->Manufacturer->find('all', [\n            'conditions' => [\n                'Manufacturers.id_manufacturer' => $manufacturerId\n            ]\n        ])->first();\n\n        $name = 'New product <b>test</b>';\n        $descriptionShort = 'description short<img src=\"test.jpg\" />';\n        $description = 'description <img src=\"test.jpg\" />';\n        $unity = '<b>piece</b>';\n        $isDeclarationOk = 0;\n        $idStorageLocation = 1;\n        $barcode = '1234567890123';\n        $newProduct = $this->Product->add($manufacturer, $name, $descriptionShort, $description, $unity, $isDeclarationOk, $idStorageLocation, $barcode);\n\n        $product = $this->Product->find('all', [\n            'conditions' => [\n                'Products.id_product' => $newProduct->id_product\n            ],\n            'contain' => [\n                'CategoryProducts',\n                'StockAvailables',\n                'BarcodeProducts',\n            ]\n        ])->first();\n\n        $this->assertEquals($product->id_product, $newProduct->id_product);\n        $this->assertEquals($product->id_manufacturer, $manufacturerId);\n        $this->assertEquals($product->active, APP_OFF);\n        $this->assertEquals($product->category_products[0]->id_category, Configure::read('app.categoryAllProducts'));\n        $this->assertEquals($product->name, 'New product test');\n        $this->assertEquals($product->description_short, 'description short');\n        $this->assertEquals($product->description, $description);\n        $this->assertEquals($product->unity, 'piece');\n        $this->assertEquals($product->is_declaration_ok, $isDeclarationOk);\n        $this->assertEquals($product->id_tax, $this->Manufacturer->getOptionDefaultTaxId($manufacturer->default_tax_id));\n        $this->assertEquals($product->stock_available->quantity, 0);\n        $this->assertEquals($product->id_storage_location, $idStorageLocation);\n        $this->assertEquals($product->barcode_product->barcode, $barcode);\n    }\n\n    /**\n     * START tests change quantity\n     */\n    public function testChangeQuantityWithOneProductAndInvalidStringQuantity()\n    {\n        $products = [\n            [346 => [\n                'quantity' => 'invalid-quantity'\n            ]]\n        ];\n\n        $exceptionThrown = false;\n\n        try {\n            $this->Product->changeQuantity($products);\n        } catch (InvalidParameterException $e) {\n            $exceptionThrown = true;\n        }\n\n        $this->assertProductQuantity($products, '97');\n        $this->assertSame(true, $exceptionThrown);\n    }\n\n    public function testChangeQuantityWithOneProductAndNegativeQuantity()\n    {\n        $products = [\n            [346 => [\n                'quantity' => -50\n            ]]\n        ];\n        $this->Product->changeQuantity($products);\n        $this->assertProductQuantity($products, -50);\n    }\n\n    public function testChangeQuantityWithOneProduct()\n    {\n        $products = [\n            [102 => [\n                'quantity' => '5'\n            ]]\n        ];\n        $this->Product->changeQuantity($products);\n        $this->assertProductQuantity($products);\n    }\n\n    public function testChangeQuantityWithOneProductAttribute()\n    {\n        $products = [\n            ['60-10' => [\n                'quantity' => '5'\n            ]]\n        ];\n        $this->Product->changeQuantity($products);\n        $this->assertProductQuantity($products);\n    }\n\n    public function testChangeQuantityWithMultipleProductsAndAttributes()\n    {\n        $products = [\n            [102 => [\n                'quantity' => '5'\n            ]],\n            [346 => [\n                'quantity' => '1'\n            ]],\n            ['60-10' => [\n                'quantity' => '90'\n            ]]\n        ];\n        $this->Product->changeQuantity($products);\n        $this->assertProductQuantity($products);\n    }\n\n    /**\n     * START tests change price\n     */\n    public function testChangePriceWithOneProductAndInvalidNegativePrice()\n    {\n\n        $products = [\n            [346 => ['gross_price' => '-1']]\n        ];\n\n        $exceptionThrown = false;\n\n        try {\n            $this->Product->changePrice($products);\n        } catch (InvalidParameterException $e) {\n            $exceptionThrown = true;\n        }\n\n        $this->assertProductPrice($products, '1,82');\n        $this->assertSame(true, $exceptionThrown);\n    }\n\n    public function testChangePriceOneProductAndInvalidStringPrice()\n    {\n        $products = [\n            [346 => ['gross_price' => 'invalid-price']]\n        ];\n\n        $exceptionThrown = false;\n\n        try {\n            $this->Product->changePrice($products);\n        } catch (InvalidParameterException $e) {\n            $exceptionThrown = true;\n        }\n\n        $this->assertProductPrice($products, '1,82');\n        $this->assertSame(true, $exceptionThrown);\n    }\n\n    public function testChangePriceWithOneProduct()\n    {\n        $products = [\n            [102 => ['gross_price' => '5,22']]\n        ];\n        $success = $this->Product->changePrice($products);\n        $this->assertTrue($success);\n        $this->assertProductPrice($products);\n    }\n\n    public function testChangePriceWithOneProductAttribute()\n    {\n        $products = [\n            ['60-10' => ['gross_price' => '3,22']]\n        ];\n        $success = $this->Product->changePrice($products);\n        $this->assertTrue($success);\n        $this->assertProductPrice($products);\n    }\n\n    public function testChangePriceWithMultipleProductsAndAttributes()\n    {\n        $products = [\n            [102 => ['gross_price' => '5,22']],\n            [346 => ['gross_price' => '1,00']],\n            ['60-10' => ['gross_price' => '2,98']]\n        ];\n        $success = $this->Product->changePrice($products);\n        $this->assertTrue($success);\n        $this->assertProductPrice($products);\n    }\n\n    public function testChangePriceWithMultipleProductsAndOneWithInvalidNegativePrice()\n    {\n\n        // 1) change prices to same price to be able to test if the price has not changed\n        $samePrice = '2,55';\n        $products = [\n            [346 => ['gross_price' => $samePrice]],\n            [102 => ['gross_price' => $samePrice]],\n            [103 => ['gross_price' => $samePrice]]\n        ];\n        $success = $this->Product->changePrice($products);\n        $this->assertTrue($success);\n        $this->assertProductPrice($products);\n\n        // try to change prices, but include one invalid price\n        $products = [\n            [346 => ['gross_price' => '-1']], // invalid price\n            [102 => ['gross_price' => '2,58']],\n            [103 => ['gross_price' => '1,01']]\n        ];\n\n        $exceptionThrown = false;\n\n        try {\n            $this->Product->changePrice($products);\n        } catch (InvalidParameterException $e) {\n            $exceptionThrown = true;\n        }\n\n        $this->assertProductPrice($products, $samePrice);\n        $this->assertSame(true, $exceptionThrown);\n    }\n\n    /**\n     * START tests change deposit\n     */\n\n    public function testChangeDepositWithOneProduct()\n    {\n        $products = [\n            [102 => '1,00']\n        ];\n        $this->Product->changeDeposit($products);\n        $this->assertProductDeposit($products);\n    }\n\n    public function testChangeDepositWithOneProductAttribute()\n    {\n        $products = [\n            ['60-10' => '1,00']\n        ];\n        $this->Product->changeDeposit($products);\n        $this->assertProductDeposit($products);\n    }\n\n    public function testChangeDepositWithMultipleProductsAndOneWithInvalidNegativeDeposit()\n    {\n\n        // 1) change deposits to same deposit to be able to test if the price has not changed\n        $sameDeposit = '1,00';\n        $products = [\n            [346 => $sameDeposit],\n            [102 => $sameDeposit],\n            [103 => $sameDeposit]\n        ];\n        $this->Product->changeDeposit($products);\n        $this->assertProductDeposit($products);\n\n        // try to change deposits, but include one invalid deposit\n        $products = [\n            [346 => '-1'], // invalid deposit\n            [102 => '2,00'],\n            [103 => '1,00']\n        ];\n\n        $exceptionThrown = false;\n\n        try {\n            $this->Product->changeDeposit($products);\n        } catch (InvalidParameterException $e) {\n            $exceptionThrown = true;\n        }\n\n        $this->assertProductDeposit($products, $sameDeposit);\n        $this->assertSame(true, $exceptionThrown);\n    }\n\n    /**\n     * START tests change status\n     */\n\n    public function testChangeStatusWithStringStatus()\n    {\n        $products = [\n            [102 => 'invalid parameter']\n        ];\n        $this->expectException(InvalidParameterException::class);\n        $this->expectExceptionMessage('Products.active for product 102 needs to be 0 or 1');\n        $this->Product->changeStatus($products);\n    }\n\n    public function testChangeStatusWithInvalidIntegerStatus()\n    {\n        $products = [\n            [102 => 5] // invalid status\n        ];\n        $this->expectException(InvalidParameterException::class);\n        $this->expectExceptionMessage('Products.active for product 102 needs to be 0 or 1');\n        $this->Product->changeStatus($products);\n    }\n\n    public function testChangeStatusForProductAttribute()\n    {\n        $products = [\n            ['60-10' => 0]\n        ];\n        $this->expectException(InvalidParameterException::class);\n        $this->expectExceptionMessage('change status is not allowed for product attributes');\n        $this->Product->changeStatus($products);\n    }\n\n    public function testChangeStatusDisableWithOneProduct()\n    {\n        $products = [\n            [102 => 0]\n        ];\n        $response = $this->Product->changeStatus($products);\n        $this->assertEquals(true, $response);\n        $this->assertProductStatus($products);\n    }\n\n    public function testChangeStatusEnableWithOneProduct()\n    {\n        $products = [\n            [102 => 1]\n        ];\n        $response = $this->Product->changeStatus($products);\n        $this->assertEquals(true, $response);\n        $this->assertProductStatus($products);\n    }\n\n    public function testChangeStatusWithMultipleProductsAndDifferentStati()\n    {\n        $products = [\n            [102 => 1],\n            [340 => 1],\n            [346 => 0]\n        ];\n        $response = $this->Product->changeStatus($products);\n        $this->assertEquals(true, $response);\n        $this->assertProductStatus($products);\n    }\n\n    public function testChangeStatusWithOneProductAndInvalidStatus()\n    {\n        $products = [\n            [102 => 5] // invalid status\n        ];\n\n        $exceptionThrown = false;\n\n        try {\n            $this->Product->changeStatus($products);\n        } catch (InvalidParameterException $e) {\n            $exceptionThrown = true;\n        }\n\n        $this->assertProductStatus($products, APP_ON);\n        $this->assertSame(true, $exceptionThrown);\n    }\n\n    public function testChangeStatusWithMultipleProductsAndOneWithInvalidStatus()\n    {\n        $products = [\n            [346 => 0],  // pass correct but different to current status\n            [102 => -1], // invalid status\n            [103 => 0]   // pass correct but different to current status\n        ];\n\n        $exceptionThrown = false;\n\n        try {\n            $this->Product->changeStatus($products);\n        } catch (InvalidParameterException $e) {\n            $exceptionThrown = true;\n        }\n\n        $this->assertProductStatus($products, APP_ON);\n        $this->assertSame(true, $exceptionThrown);\n    }\n\n    public function testChangeNameWithOneProductAndInvalidStringName()\n    {\n        $products = [\n            [346 => [\n                'name' => 'a', // at least 2 chars needed\n                'unity' => '',\n                'description' => 'Beschreibung',\n                'description_short' => 'Kurze Beschreibung'\n            ]]\n        ];\n\n        $exceptionThrown = false;\n\n        try {\n            $this->Product->changeName($products);\n        } catch (InvalidParameterException $e) {\n            $exceptionThrown = true;\n        }\n\n        $expectedResult = ['name' => 'Artischocke', 'unity' => 'St\u00fcck', 'description' => '', 'description_short' => ''];\n        $this->assertProductName($products, $expectedResult);\n        $this->assertSame(true, $exceptionThrown);\n    }\n\n    public function testChangeNameForProductAttribute()\n    {\n        $products = [\n            ['60-10' => 0]\n        ];\n        $this->expectException(InvalidParameterException::class);\n        $this->expectExceptionMessage('change name is not allowed for product attributes');\n        $this->Product->changeName($products);\n    }\n\n    public function testChangeNameWithMultipleProducts()\n    {\n        $parameters = [\n            'name' => 'test <b>name</b>', // no tags allowed\n            'unity' => ' test unity ',    // trim and no tags allowed\n            'description' => '    <p>test <br /><strong><em>description</em></strong><img src=\"/test.jpg\" /><img src=\"data:image/png;base64,iVBORw0KGgoAAAANSUCYII=\" /></p>',\n            'description_short' => '<p>test description<br /> <em>short</em></p>    ',\n            'id_storage_location' => 2,\n            'barcode' => '1234567890123',\n        ];\n\n        $products = [\n            [102 => $parameters],\n            [346 => $parameters]\n        ];\n        $this->Product->changeName($products);\n\n        $expectedResults = [\n            'name' => 'test name',\n            'unity' => 'test unity',\n            'description' => '<p>test <br /><strong><em>description</em></strong><img src=\"/test.jpg\" /><img src=\"invalid-image\" /></p>',\n            'description_short' => '<p>test description<br /> <em>short</em></p>',\n            'id_storage_location' => 2,\n            'barcode' => '1234567890123',\n        ];\n        $this->assertProductName($products, $expectedResults);\n    }\n\n    private function assertProductName($products, $expectedResults)\n    {\n        foreach ($products as $product) {\n\n            $productId = key($product);\n            $changedProduct = $this->Product->find('all', [\n                'conditions' => [\n                    'Products.id_product' => $productId,\n                ],\n                'contain' => [\n                    'BarcodeProducts',\n                ]\n            ])->first();\n            $this->assertEquals($expectedResults['name'], $changedProduct->name);\n            $this->assertEquals($expectedResults['unity'], $changedProduct->unity);\n            $this->assertEquals($expectedResults['description'], $changedProduct->description);\n            $this->assertEquals($expectedResults['description_short'], $changedProduct->description_short);\n\n            if (isset($expectedResults['id_storage_location'])) {\n                $this->assertEquals($expectedResults['id_storage_location'], $changedProduct->id_storage_location);\n            }\n\n            if (isset($expectedResults['barcode'])) {\n                $this->assertEquals($expectedResults['barcode'], $changedProduct->barcode_product->barcode);\n            }\n\n        }\n    }\n\n    private function assertProductQuantity($products, $forceUseThisQuantity = null)\n    {\n        foreach ($products as $product) {\n            $originalProductId = key($product);\n            $productAndAttributeId = $this->Product->getProductIdAndAttributeId($originalProductId);\n            $productId = $productAndAttributeId['productId'];\n            $expectedQuantity = $product[$originalProductId]['quantity'];\n            if ($forceUseThisQuantity) {\n                $expectedQuantity = $forceUseThisQuantity;\n            }\n            if ($productAndAttributeId['attributeId'] == 0) {\n                $contain = ['StockAvailables'];\n            } else {\n                $this->Product->getAssociation('ProductAttributes')->setConditions(\n                    ['ProductAttributes.id_product_attribute' => $productAndAttributeId['attributeId']]\n                );\n                $contain = ['ProductAttributes.StockAvailables'];\n            }\n            $changedProduct = $this->Product->find('all', [\n                'conditions' => [\n                    'Products.id_product' => $productId\n                ],\n                'contain' => $contain\n            ])->first();\n            if ($productAndAttributeId['attributeId'] == 0) {\n                $result = $changedProduct->stock_available->quantity;\n            } else {\n                $result = $changedProduct->product_attributes[0]->stock_available->quantity;\n            }\n            $this->assertEquals($expectedQuantity, $result, 'changing the quantity flag did not work');\n        }\n    }\n\n    private function assertProductDeposit($products, $forceUseThisDeposit = null)\n    {\n        foreach ($products as $product) {\n            $originalProductId = key($product);\n            $productAndAttributeId = $this->Product->getProductIdAndAttributeId($originalProductId);\n            $productId = $productAndAttributeId['productId'];\n            $expectedDeposit = $product[$originalProductId];\n            if ($forceUseThisDeposit) {\n                $expectedDeposit = $forceUseThisDeposit;\n            }\n            $expectedDeposit = Configure::read('app.numberHelper')->parseFloatRespectingLocale($expectedDeposit);\n            if ($productAndAttributeId['attributeId'] == 0) {\n                $contain = ['DepositProducts'];\n            } else {\n                $contain = ['ProductAttributes', 'ProductAttributes.DepositProductAttributes'];\n                $this->Product->getAssociation('ProductAttributes')->setConditions(\n                    ['ProductAttributes.id_product_attribute' => $productAndAttributeId['attributeId']]\n                );\n            }\n\n            $changedProduct = $this->Product->find('all', [\n                'conditions' => [\n                    'Products.id_product' => $productId\n                ],\n                'contain' => $contain,\n            ])->first();\n\n            if ($productAndAttributeId['attributeId'] == 0) {\n                $resultEntity = $changedProduct->deposit_product;\n                ;\n            } else {\n                $resultEntity = $changedProduct->product_attributes[0]->deposit_product_attribute;\n            }\n            $this->assertEquals($expectedDeposit, $resultEntity->deposit, 'changing the deposit did not work');\n        }\n    }\n\n    private function assertProductPrice($products, $forceUseThisPrice = null)\n    {\n        foreach ($products as $product) {\n            $originalProductId = key($product);\n            $productAndAttributeId = $this->Product->getProductIdAndAttributeId($originalProductId);\n            $productId = $productAndAttributeId['productId'];\n            $expectedPrice = $product[$originalProductId]['gross_price'];\n            if ($forceUseThisPrice) {\n                $expectedPrice = $forceUseThisPrice;\n            }\n            $contain = ['Taxes'];\n            $expectedPrice = Configure::read('app.numberHelper')->parseFloatRespectingLocale($expectedPrice);\n            if ($productAndAttributeId['attributeId'] > 0) {\n                $this->Product->getAssociation('ProductAttributes')->setConditions(\n                    ['ProductAttributes.id_product_attribute' => $productAndAttributeId['attributeId']]\n                );\n                $contain[] = 'ProductAttributes';\n            }\n            $changedProduct = $this->Product->find('all', [\n                'conditions' => [\n                    'Products.id_product' => $productId\n                ],\n                'contain' => $contain,\n            ])->first();\n            if ($productAndAttributeId['attributeId'] == 0) {\n                $resultEntity = $changedProduct;\n            } else {\n                $resultEntity = $changedProduct->product_attributes[0];\n            }\n            $taxRate = $changedProduct->tax->rate ?? 0;\n            $this->assertEquals($expectedPrice, $this->Product->getGrossPrice($resultEntity->price, $taxRate));\n        }\n    }\n\n    private function assertProductStatus($products, $forceUseThisStatus = null)\n    {\n        foreach ($products as $product) {\n            $productId = key($product);\n            $expectedStatus = $product[$productId];\n            if ($forceUseThisStatus) {\n                $expectedStatus = $forceUseThisStatus;\n            }\n            $changedProduct = $this->Product->find('all', [\n                'conditions' => [\n                    'Products.id_product' => $productId,\n                ]\n            ])->first();\n            $this->assertEquals($expectedStatus, $changedProduct->active, 'changing the active flag did not work');\n        }\n    }\n}\n", "<?php\ndeclare(strict_types=1);\n\n/**\n * FoodCoopShop - The open source software for your foodcoop\n *\n * Licensed under the GNU Affero General Public License version 3\n * For full copyright and license information, please see LICENSE\n * Redistributions of files must retain the above copyright notice.\n *\n * @since         FoodCoopShop 3.2.0\n * @license       https://opensource.org/licenses/AGPL-3.0\n * @author        Mario Rothauer <office@foodcoopshop.com>\n * @copyright     Copyright (c) Mario Rothauer, https://www.rothauer-it.com\n * @link          https://www.foodcoopshop.com\n */\nnamespace App\\Lib\\RemoteFile;\n\nclass RemoteFile\n{\n    public static function exists(string $remoteFile): bool\n    {\n\n        $ch = curl_init($remoteFile);\n        curl_setopt($ch, CURLOPT_NOBODY, true);\n        curl_exec($ch);\n        $responseCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);\n        curl_close($ch);\n\n        if ($responseCode == 200){\n            return true;\n        }\n\n        return false;\n\n    }\n\n}\n", "<?php\ndeclare(strict_types=1);\n\nnamespace App\\Model\\Table;\n\nuse Cake\\Log\\Log;\nuse Cake\\Utility\\Hash;\nuse Cake\\Core\\Configure;\nuse App\\Lib\\Folder\\Folder;\nuse App\\Lib\\Catalog\\Catalog;\nuse Cake\\Validation\\Validator;\nuse App\\Lib\\RemoteFile\\RemoteFile;\nuse Cake\\Datasource\\FactoryLocator;\nuse App\\Lib\\DeliveryRhythm\\DeliveryRhythm;\nuse App\\Controller\\Component\\StringComponent;\nuse App\\Lib\\Error\\Exception\\InvalidParameterException;\nuse App\\Model\\Traits\\ProductCacheClearAfterSaveAndDeleteTrait;\n\n/**\n * FoodCoopShop - The open source software for your foodcoop\n *\n * Licensed under the GNU Affero General Public License version 3\n * For full copyright and license information, please see LICENSE\n * Redistributions of files must retain the above copyright notice.\n *\n * @since         FoodCoopShop 1.0.0\n * @license       https://opensource.org/licenses/AGPL-3.0\n * @author        Mario Rothauer <office@foodcoopshop.com>\n * @copyright     Copyright (c) Mario Rothauer, https://www.rothauer-it.com\n * @link          https://www.foodcoopshop.com\n */\nclass ProductsTable extends AppTable\n{\n\n    use ProductCacheClearAfterSaveAndDeleteTrait;\n\n    public const ALLOWED_TAGS_DESCRIPTION_SHORT = '<p><b><strong><i><em><br>';\n    public const ALLOWED_TAGS_DESCRIPTION       = '<p><b><strong><i><em><br><img>';\n\n    private $Catalog;\n    private $Configuration;\n    private $Manufacturer;\n    private $Unit;\n\n    public function initialize(array $config): void\n    {\n        $this->setTable('product');\n        parent::initialize($config);\n        $this->setPrimaryKey('id_product');\n        $this->belongsTo('Manufacturers', [\n            'foreignKey' => 'id_manufacturer'\n        ]);\n        $this->belongsTo('StockAvailables', [\n            'foreignKey' => 'id_product'\n        ]);\n        $this->belongsTo('PurchasePriceProducts', [\n            'foreignKey' => 'id_product',\n            'conditions' => [\n                'PurchasePriceProducts.product_attribute_id = 0',\n            ],\n        ]);\n        $this->belongsTo('BarcodeProducts', [\n            'foreignKey' => 'id_product',\n            'conditions' => [\n                'BarcodeProducts.product_attribute_id = 0',\n            ],\n        ]);\n        $this->belongsTo('Taxes', [\n            'foreignKey' => 'id_tax'\n        ]);\n        $this->hasOne('DepositProducts', [\n            'foreignKey' => 'id_product'\n        ]);\n        $this->hasOne('Images', [\n            'foreignKey' => 'id_product',\n            'order' => [\n                'Images.id_image' => 'DESC'\n            ]\n        ]);\n        $this->hasOne('ProductAttribute', [\n            'foreignKey' => 'id_product'\n        ]);\n        $this->hasMany('ProductAttributes', [\n            'foreignKey' => 'id_product'\n        ]);\n        $this->hasMany('CategoryProducts', [\n            'foreignKey' => 'id_product'\n        ]);\n        $this->hasOne('UnitProducts', [\n            'foreignKey' => 'id_product'\n        ]);\n        $this->belongsTo('StorageLocations', [\n            'foreignKey' => 'id_storage_location',\n        ]);\n        $this->addBehavior('Timestamp');\n    }\n\n    public function __construct(array $config = [])\n    {\n        parent::__construct($config);\n        $this->Configuration = FactoryLocator::get('Table')->get('Configurations');\n    }\n\n    public function validationName(Validator $validator)\n    {\n        $validator->notEmptyString('name', __('Please_enter_a_name.'));\n        $validator->minLength('name', 2, __('The_name_of_the_product_needs_to_be_at_least_{0}_characters_long.', [2]));\n        return $validator;\n    }\n\n    public function validationDeliveryRhythm(Validator $validator)\n    {\n        $validator->add('delivery_rhythm_type', 'allowed-count-values', [\n            'rule' => function ($value, $context) {\n                if ($value == 'week') {\n                    return in_array($context['data']['delivery_rhythm_count'], [1,2,4]);\n                }\n                if ($value == 'month') {\n                    return in_array($context['data']['delivery_rhythm_count'], [0,1,2,3,4]);\n                }\n                if ($value == 'individual') {\n                    return in_array($context['data']['delivery_rhythm_count'], [0]);\n                }\n                return false;\n            },\n            'message' => __('The_delivery_ryhthm_is_not_valid.')\n        ]);\n        $validator->allowEmptyString('delivery_rhythm_first_delivery_day');\n        $validator->notEquals('delivery_rhythm_first_delivery_day', '1970-01-01', __('The_first_delivery_day_is_not_valid.'));\n        $validator->allowEmptyString('delivery_rhythm_order_possible_until');\n        $validator->notEquals('delivery_rhythm_order_possible_until', '1970-01-01', __('The_order_possible_until_field_is_not_valid.'));\n        $validator->add('delivery_rhythm_order_possible_until', 'allowed-only-smaller-than-first-delivery-day', [\n            'rule' => function ($value, $context) {\n                if ($context['data']['delivery_rhythm_type'] == 'individual') {\n                    return $context['data']['delivery_rhythm_first_delivery_day'] > $value;\n                }\n                return true;\n            },\n            'message' => __('The_order_possible_until_field_needs_to_be_smaller_than_the_delivery_date.')\n        ]);\n        $validator = $this->getCorrectDayOfMonthValidator($validator, 'delivery_rhythm_first_delivery_day');\n        $validator = $this->getCorrectDayOfMonthValidator($validator, 'delivery_rhythm_first_delivery_day');\n        $validator = $this->getAllowOnlyOneWeekdayValidator($validator, 'delivery_rhythm_first_delivery_day', __('The_first_delivery_day'));\n        $validator->range('delivery_rhythm_send_order_list_weekday', [0, 6], __('Please_enter_a_number_between_{0}_and_{1}.', [0, 6]));\n        $validator->allowEmptyString('delivery_rhythm_send_order_list_day');\n        $validator->notEquals('delivery_rhythm_send_order_list_day', '1970-01-01', __('The_send_order_list_day_field_is_not_valid.'));\n        $validator->add('delivery_rhythm_send_order_list_day', 'allowed-only-between-two-dates', [\n            'rule' => function ($value, $context) {\n                if ($context['data']['delivery_rhythm_type'] == 'individual') {\n                    return $context['data']['delivery_rhythm_first_delivery_day'] > $value && $context['data']['delivery_rhythm_order_possible_until'] < $value;\n                }\n                return true;\n            },\n            'message' => __('The_send_order_list_day_field_needs_to_be_between_order_possible_until_date_and_first_delivery_day.')\n        ]);\n\n        return $validator;\n    }\n\n    private function getCorrectDayOfMonthValidator(Validator $validator, $field)\n    {\n        $validator->add($field, 'allow-only-correct-weekday-of-month', [\n\n            'rule' => function ($value, $context) {\n\n                if ($context['data']['delivery_rhythm_type'] == 'month') {\n\n                    switch($context['data']['delivery_rhythm_count']) {\n                        case '1':\n                            $ordinal = 'first';\n                            $ordinalForWeekday = __('first_for_weekday');\n                            break;\n                        case '2':\n                            $ordinal = 'second';\n                            $ordinalForWeekday = __('second_for_weekday');\n                            break;\n                        case '3':\n                            $ordinal = 'third';\n                            $ordinalForWeekday = __('third_for_weekday');\n                            break;\n                        case '4':\n                            $ordinal = 'fourth';\n                            $ordinalForWeekday = __('fourth_for_weekday');\n                            break;\n                        case '0':\n                            $ordinal = 'last';\n                            $ordinalForWeekday = __('last_for_weekday');\n                            break;\n                    }\n\n                    $deliveryDayAsWeekdayInEnglish = strtolower(date('l', strtotime($context['data']['delivery_rhythm_first_delivery_day'])));\n                    $calculatedPickupDay = date(Configure::read('app.timeHelper')->getI18Format('DatabaseAlt'), strtotime($context['data']['delivery_rhythm_first_delivery_day'] . ' ' . $ordinal . ' ' . $deliveryDayAsWeekdayInEnglish . ' of this month'));\n\n                    $deliveryWeekdayName = Configure::read('app.timeHelper')->getWeekdayName(DeliveryRhythm::getDeliveryWeekday());\n                    $message = __('The_first_delivery_day_needs_to_be_a_{0}_{1}_of_the_month.', [\n                        $ordinalForWeekday,\n                        $deliveryWeekdayName,\n                    ]);\n\n                    if ($calculatedPickupDay != $value) {\n                        return $message;\n                    }\n\n                }\n\n                return true;\n\n            }\n\n        ]);\n        return $validator;\n    }\n\n    private function deliveryBreakEnabledBase(string|null $noDeliveryDaysAsString, string $deliveryDate): bool\n    {\n        return $noDeliveryDaysAsString != '' && preg_match('`' . $deliveryDate . '`', $noDeliveryDaysAsString);\n    }\n\n    public function deliveryBreakGlobalEnabled(string|null $noDeliveryDaysAsString, string $deliveryDate): bool\n    {\n        return $this->deliveryBreakEnabledBase($noDeliveryDaysAsString, $deliveryDate);\n    }\n\n    /**\n     * manufacturer based delivery break is never applied for stock products\n     */\n    public function deliveryBreakManufacturerEnabled(\n        string|null $noDeliveryDaysAsString,\n        string $deliveryDate,\n        bool|int $stockManagementEnabled,\n        bool|int $isStockProduct): bool\n    {\n        if ($stockManagementEnabled && $isStockProduct) {\n            return false;\n        }\n        return $this->deliveryBreakEnabledBase($noDeliveryDaysAsString, $deliveryDate);\n    }\n\n    /**\n     * @param int $productId\n     * @param int $manufacturerId\n     * @return boolean success\n     */\n    public function isOwner($productId, $manufacturerId)\n    {\n        $found = $this->find('all', [\n            'conditions' => [\n                'Products.id_product' => $productId,\n                'Products.id_manufacturer' => $manufacturerId\n            ]\n        ])->count();\n        return (bool) $found;\n    }\n\n    /**\n     * @param string|int $productId (eg. 4 or '4-10' or '4')\n     */\n    public function getProductIdAndAttributeId($productId): array\n    {\n        $attributeId = 0;\n        $explodedProductId = explode('-', (string) $productId);\n        if (count($explodedProductId) == 2) {\n            $productId = $explodedProductId[0];\n            $attributeId = $explodedProductId[1];\n        }\n        return [\n            'productId' => (int) $productId,\n            'attributeId' => (int) $attributeId,\n        ];\n    }\n\n    public function getCompositeProductIdAndAttributeId($productId, $attributeId = 0)\n    {\n        $compositeId = $productId;\n        if ($attributeId > 0) {\n            $compositeId .= '-'.$attributeId;\n        }\n        return $compositeId;\n    }\n\n    /**\n     * @param array $products\n     * Array\n     *   (\n     *       [0] => Array\n     *           (\n     *               [productId] => (int) status\n     *           )\n     *   )\n     * @throws InvalidParameterException\n     * @return boolean $success\n     */\n    public function changeStatus($products)\n    {\n\n        $products2save = [];\n\n        foreach ($products as $product) {\n            $productId = key($product);\n            $ids = $this->getProductIdAndAttributeId($productId);\n            if ($ids['attributeId'] > 0) {\n                throw new InvalidParameterException('change status is not allowed for product attributes');\n            }\n            $status = $product[$ids['productId']];\n            $allowed = [APP_OFF, APP_ON];\n            if (!in_array($status, $allowed, true)) { // last param for type check\n                throw new InvalidParameterException('Products.active for product ' .$ids['productId'] . ' needs to be ' .APP_OFF . ' or ' . APP_ON.'; was: ' . $status);\n            } else {\n                $products2save[] = [\n                    'id_product' => $ids['productId'],\n                    'active' => $status\n                ];\n            }\n        }\n\n        $success = false;\n        if (!empty($products2save)) {\n            $entities = $this->newEntities($products2save);\n            $result = $this->saveMany($entities);\n            $success = !empty($result);\n        }\n\n        return $success;\n    }\n\n    /**\n     * @param string $quantity\n     * @return boolean / int\n     */\n    public function getQuantityAsInteger($quantity)\n    {\n        $quantity = trim($quantity);\n\n        if (!is_numeric($quantity)) {\n            return -1; // do not return false, because 0 is a valid return value!\n        }\n        $quantity = (int) ($quantity);\n\n        return $quantity;\n    }\n\n    /**\n     * @param array $products\n     *  Array\n     *  (\n     *      [0] => Array\n     *          (\n     *              [productId] => (float) deposit\n     *          )\n     *  )\n     * @return boolean $success\n     */\n    public function changeDeposit($products)\n    {\n\n        foreach ($products as $product) {\n            $productId = key($product);\n            $deposit = $product[$productId];\n            if (is_string($deposit)) {\n                $deposit = Configure::read('app.numberHelper')->getStringAsFloat($product[$productId]);\n            }\n            if ($deposit < 0) {\n                throw new InvalidParameterException('input format not correct: '.$product[$productId]);\n            }\n        }\n\n        $success = false;\n        foreach ($products as $product) {\n\n            $productId = key($product);\n\n            $deposit = $product[$productId];\n            if (is_string($deposit)) {\n                $deposit = Configure::read('app.numberHelper')->getStringAsFloat($product[$productId]);\n            }\n\n            $ids = $this->getProductIdAndAttributeId($productId);\n\n            if ($ids['attributeId'] > 0) {\n                $oldDeposit = $this->DepositProducts->find('all', [\n                    'conditions' => [\n                        'id_product_attribute' => $ids['attributeId']\n                    ]\n                ])->first();\n\n                if (empty($oldDeposit)) {\n                    $entity = $this->DepositProducts->newEntity([]);\n                } else {\n                    $this->DepositProducts->setPrimaryKey('id_product_attribute');\n                    $entity = $this->DepositProducts->get($oldDeposit->id_product_attribute);\n                }\n\n                $deposit2save = [\n                    'id_product_attribute' => $ids['attributeId'],\n                    'deposit' => $deposit\n                ];\n            } else {\n                // deposit is set for productId\n                $oldDeposit = $this->DepositProducts->find('all', [\n                    'conditions' => [\n                        'id_product' => $productId\n                    ]\n                ])->first();\n\n                if (empty($oldDeposit)) {\n                    $entity = $this->DepositProducts->newEntity([]);\n                } else {\n                    $entity = $this->DepositProducts->get($oldDeposit->id_product);\n                }\n\n                $deposit2save = [\n                    'id_product' => $productId,\n                    'deposit' => $deposit\n                ];\n            }\n\n            $this->DepositProducts->setPrimaryKey('id');\n            $result = $this->DepositProducts->save(\n                $this->DepositProducts->patchEntity($entity, $deposit2save)\n            );\n            $this->DepositProducts->setPrimaryKey('id_product');\n            $success |= is_object($result);\n        }\n\n        return $success;\n    }\n\n    /**\n     * @param array $products\n     *  Array\n     *  (\n     *      [0] => Array\n     *          (\n     *              [\n     *                  productId] => [\n     *                      'gross_price' => (float) price\n     *                      'product unit fields'\n     *                  ]\n     *          )\n     *  )\n     * @return boolean $success\n     */\n    public function changePrice($products)\n    {\n\n        foreach ($products as $product) {\n            $productId = key($product);\n            $price = $product[$productId]['gross_price'];\n            if (is_string($price)) {\n                $price = Configure::read('app.numberHelper')->getStringAsFloat($product[$productId]['gross_price']);\n            }\n            if ($price < 0) {\n                throw new InvalidParameterException('input format not correct: '.$product[$productId]['gross_price']);\n            }\n        }\n\n        $success = false;\n        foreach ($products as $product) {\n\n            $productId = key($product);\n            $price = $product[$productId]['gross_price'];\n            if (is_string($price)) {\n                $price = Configure::read('app.numberHelper')->getStringAsFloat($price);\n            }\n\n            $ids = $this->getProductIdAndAttributeId($productId);\n            $productEntity = $this->find('all', [\n                'conditions' => [\n                    'Products.id_product' => $ids['productId'],\n                ],\n                'contain' => [\n                    'Taxes',\n                ]\n            ])->first();\n            $taxRate = $productEntity->tax->rate ?? 0;\n\n            $netPrice = $this->getNetPrice($price, $taxRate);\n\n            if ($ids['attributeId'] > 0) {\n                // update attribute - updateAll needed for multi conditions of update\n                $result = $this->ProductAttributes->updateAll([\n                    'price' => $netPrice\n                ], [\n                    'id_product_attribute' => $ids['attributeId']\n                ]);\n                // if results are not the returned row count would be 0, so always set to true;\n                $success |= true;\n            } else {\n                $product2update = [\n                    'price' => $netPrice\n                ];\n                $entity = $this->get($ids['productId']);\n                $result = $this->save(\n                    $this->patchEntity($entity, $product2update)\n                );\n                $success |= is_object($result);\n            }\n\n            if (isset($product[$productId]['unit_product_price_per_unit_enabled']) && isset($product[$productId]['unit_product_price_incl_per_unit'])) {\n\n                $this->Unit = FactoryLocator::get('Table')->get('Units');\n\n                $priceInclPerUnit = $product[$productId]['unit_product_price_incl_per_unit'];\n                if (is_string($priceInclPerUnit)) {\n                    $priceInclPerUnit = Configure::read('app.numberHelper')->getStringAsFloat($priceInclPerUnit);\n                }\n                $quantityInUnits = $product[$productId]['unit_product_quantity_in_units'];\n                if (is_string($quantityInUnits)) {\n                    $quantityInUnits = Configure::read('app.numberHelper')->getStringAsFloat($quantityInUnits);\n                }\n\n                $this->Unit->saveUnits(\n                    $ids['productId'],\n                    $ids['attributeId'],\n                    $product[$productId]['unit_product_price_per_unit_enabled'],\n                    $priceInclPerUnit == -1 ? 0 : $priceInclPerUnit,\n                    $product[$productId]['unit_product_name'],\n                    $product[$productId]['unit_product_amount'],\n                    $quantityInUnits == -1 ? 0 : $quantityInUnits\n                );\n            }\n        }\n\n        return (bool) $success;\n        \n    }\n\n    /**\n     * @param array $products\n     *  Array\n     *  (\n     *      [0] => Array\n     *          (\n     *              [productId] => [\n     *                  'quantity' => (int) quantity\n     *              ]\n     *          )\n     *  )\n     */\n    public function changeQuantity($products)\n    {\n\n        foreach ($products as $product) {\n            $productId = key($product);\n            $ids = $this->getProductIdAndAttributeId($productId);\n            $entity = $this->StockAvailables->newEntity($product[$productId]);\n            if ($entity->hasErrors()) {\n                throw new InvalidParameterException(join(' ', $this->StockAvailables->getAllValidationErrors($entity)));\n            }\n        }\n\n        foreach ($products as $product) {\n            $productId = key($product);\n            $ids = $this->getProductIdAndAttributeId($productId);\n            if ($ids['attributeId'] > 0) {\n                $entity = $this->StockAvailables->find('all', [\n                    'conditions' => [\n                        'id_product_attribute' => $ids['attributeId'],\n                        'id_product' => $ids['productId']\n                    ],\n                ])->first();\n                if (is_null($entity)) {\n                    Log::error('entity was empty: productId: ' . $ids['productId'] . ' / attributeId: ' . $ids['attributeId']);\n                    continue;\n                }\n                $originalPrimaryKey = $this->StockAvailables->getPrimaryKey();\n                $this->StockAvailables->setPrimaryKey('id_product_attribute');\n                $this->StockAvailables->save(\n                    $this->StockAvailables->patchEntity($entity, $product[$productId])\n                );\n                $this->StockAvailables->setPrimaryKey($originalPrimaryKey);\n                $this->StockAvailables->updateQuantityForMainProduct($ids['productId']);\n            } else {\n                $entity = $this->StockAvailables->get($ids['productId']);\n                $this->StockAvailables->save(\n                    $this->StockAvailables->patchEntity($entity, $product[$productId])\n                );\n            }\n        }\n    }\n\n    /**\n     * @param array $products\n     *  Array\n     *  (\n     *      [0] => Array\n     *          (\n     *              [productId] => (int) delivery_rhythm\n     *          )\n     *  )\n     * @return boolean $success\n     */\n    public function changeDeliveryRhythm($products)\n    {\n\n        $products2save = [];\n\n        foreach ($products as $product) {\n            $productId = key($product);\n            $ids = $this->getProductIdAndAttributeId($productId);\n            if ($ids['attributeId'] > 0) {\n                throw new InvalidParameterException('change delivery_rhythm is not allowed for product attributes');\n            }\n            $entity = $this->newEntity(\n                $product[$productId],\n                [\n                    'validate' => 'deliveryRhythm'\n                ]\n            );\n            if ($entity->hasErrors()) {\n                throw new InvalidParameterException(join(' ', $this->getAllValidationErrors($entity)));\n            } else {\n                $products2save[] = array_merge(\n                    ['id_product' => $ids['productId']], $product[$productId]\n                );\n            }\n        }\n\n        $success = false;\n        if (!empty($products2save)) {\n            $entities = $this->newEntities($products2save);\n            $result = $this->saveMany($entities);\n            $success = !empty($result);\n        }\n\n        return $success;\n    }\n\n    /**\n     * @param array $products\n     *  Array\n     *  (\n     *      [0] => Array\n     *          (\n     *              [productId] => (int) is_stock_product\n     *          )\n     *  )\n     * @return boolean $success\n     */\n    public function changeIsStockProduct($products)\n    {\n\n        $products2save = [];\n        foreach ($products as $product) {\n            $productId = key($product);\n            $ids = $this->getProductIdAndAttributeId($productId);\n            if ($ids['attributeId'] > 0) {\n                throw new InvalidParameterException('change is_stock_product is not allowed for product attributes');\n            }\n            $isStockProduct = (int) $product[$ids['productId']];\n            $allowed = [APP_OFF, APP_ON];\n            if (!in_array($isStockProduct, $allowed, true)) { // last param for type check\n                throw new InvalidParameterException('Products.is_stock_product for product ' .$ids['productId'] . ' needs to be ' .APP_OFF . ' or ' . APP_ON.'; was: ' . $isStockProduct);\n            } else {\n                $products2save[] = [\n                    'id_product' => $ids['productId'],\n                    'is_stock_product' => $isStockProduct\n                ];\n            }\n        }\n\n        $success = false;\n        if (!empty($products2save)) {\n            $entities = $this->newEntities($products2save);\n            $result = $this->saveMany($entities);\n            $success = !empty($result);\n        }\n\n        return $success;\n\n    }\n\n    /**\n     * @param array $products\n     *  Array\n     *  (\n     *      [0] => Array\n     *          (\n     *              [productId] => Array\n     *                  (\n     *                      [name] => Brokkoli-1\n     *                      [description] => gr\u00fcnes Gem\u00fcse: Strunk mit R\u00f6schen auch angeschwollenen Knospen-1\n     *                      [description_short] => kbA, vom Gem\u00fcsehof Wild-Obermayr-1\n     *                      [unity] => ca. 0,4 kg-1\n     *                      [is_declaration_ok] => 1\n     *                      [id_storage_location] => 1\n     *                      [barcode] => '1234567890123'\n     *                  )\n     *          )\n     *  )\n     * @return boolean $success\n     */\n    public function changeName($products)\n    {\n\n        $products2save = [];\n\n        foreach ($products as $product) {\n            $productId = key($product);\n            $name = $product[$productId];\n            $ids = $this->getProductIdAndAttributeId($productId);\n            if ($ids['attributeId'] > 0) {\n                throw new InvalidParameterException('change name is not allowed for product attributes');\n            }\n            $newName = StringComponent::removeSpecialChars(strip_tags(trim($name['name'])));\n\n            $productEntity = $this->newEntity(\n                [\n                    'name' => $newName,\n                ],\n                [\n                    'validate' => 'name',\n                ]\n            );\n            if ($productEntity->hasErrors()) {\n                throw new InvalidParameterException(join(' ', $this->getAllValidationErrors($productEntity)));\n            }\n\n            if (isset($name['barcode'])) {\n                $barcode = StringComponent::removeSpecialChars(strip_tags(trim($name['barcode'])));\n                $barcodeProductEntity = $this->BarcodeProducts->newEntity(\n                    [\n                        'barcode' => $barcode,\n                    ],\n                    [\n                        'validate' => true\n                    ]\n                );\n                if ($barcodeProductEntity->hasErrors()) {\n                    throw new InvalidParameterException(join(' ', $this->getAllValidationErrors($barcodeProductEntity)));\n                }\n            }\n\n            $tmpProduct2Save = [\n                'id_product' => $ids['productId'],\n                'name' => StringComponent::removeSpecialChars(strip_tags(trim($name['name']))),\n                'description_short' => StringComponent::prepareWysiwygEditorHtml($name['description_short'], self::ALLOWED_TAGS_DESCRIPTION_SHORT),\n                'description' => StringComponent::prepareWysiwygEditorHtml($name['description'], self::ALLOWED_TAGS_DESCRIPTION),\n                'unity' => StringComponent::removeSpecialChars(strip_tags(trim($name['unity']))),\n            ];\n            if (isset($name['is_declaration_ok'])) {\n                $tmpProduct2Save['is_declaration_ok'] = $name['is_declaration_ok'];\n            }\n            if (isset($name['id_storage_location']) && $name['id_storage_location'] > 0) {\n                $tmpProduct2Save['id_storage_location'] = $name['id_storage_location'];\n            }\n\n            if (isset($name['barcode'])) {\n                $tmpProduct2Save['barcode_product'] = [\n                    'product_id' => $ids['productId'],\n                    'barcode' => $barcode,\n                ];\n            }\n            $products2save[] = $tmpProduct2Save;\n\n        }\n\n        $success = false;\n\n        if (!empty($products2save)) {\n            $entities = $this->newEntities($products2save, [\n                'associated' => [\n                    'BarcodeProducts',\n                ],\n            ]);\n            $result = $this->saveMany($entities);\n            $success = !empty($result);\n        }\n\n        return $success;\n    }\n\n    public function isNew($date)\n    {\n        $showAsNewExpirationDate = date('Y-m-d', strtotime($date . ' + ' . Configure::read('appDb.FCS_DAYS_SHOW_PRODUCT_AS_NEW') . ' days'));\n        if (strtotime($showAsNewExpirationDate) > strtotime(date('Y-m-d'))) {\n            return true;\n        }\n        return false;\n    }\n\n    public function getProductsForBackend($appAuth, $productIds, $manufacturerId, $active, $categoryId = '', $isQuantityMinFilterSet = false, $isPriceZero = false, $addProductNameToAttributes = false, $controller = null)\n    {\n\n        $conditions = [];\n        if ($manufacturerId != 'all') {\n            $conditions['Products.id_manufacturer'] = $manufacturerId;\n        } else {\n            // do not show any non-associated products that might be found in database\n            $conditions[] = 'Products.id_manufacturer > 0';\n        }\n\n        if ($productIds != '') {\n            $conditions['Products.id_product IN'] = $productIds;\n        }\n\n        if ($active != 'all') {\n            $conditions['Products.active'] = $active;\n        } else {\n            $conditions['Products.active >'] = APP_DEL;\n        }\n\n        if ($isQuantityMinFilterSet) {\n            $conditions[] = $this->getIsQuantityMinFilterSetCondition();\n        }\n\n        if ($isPriceZero) {\n            $conditions[] = $this->getIsPriceZeroCondition();\n        }\n\n        $quantityIsZeroFilterOn = false;\n        $priceIsZeroFilterOn = false;\n        foreach ($conditions as $condition) {\n            if (is_int($condition) || !is_array($condition)) {\n                continue;\n            }\n            if (is_string($condition)) {\n                if (preg_match('/'.$this->getIsQuantityMinFilterSetCondition().'/', $condition)) {\n                    $this->getAssociation('ProductAttributes')->setConditions(\n                        [\n                            'StockAvailables.quantity < 3'\n                        ]\n                    );\n                    $quantityIsZeroFilterOn = true;\n                }\n                if (preg_match('/'.$this->getIsPriceZeroCondition().'/', $condition)) {\n                    $this->ProductAttributes->setConditions(\n                        [\n                            'ProductAttributes.price' => 0\n                        ]\n                    );\n                    $priceIsZeroFilterOn = true;\n                }\n            }\n        }\n        $contain = [\n            'CategoryProducts',\n            'CategoryProducts.Categories',\n            'DepositProducts',\n            'Images',\n            'Taxes',\n            'UnitProducts',\n            'Manufacturers',\n            'StockAvailables' => [\n                'conditions' => [\n                    'StockAvailables.id_product_attribute' => 0\n                ]\n            ],\n            'ProductAttributes',\n            'ProductAttributes.StockAvailables' => [\n                'conditions' => [\n                    'StockAvailables.id_product_attribute > 0'\n                ]\n            ],\n            'ProductAttributes.DepositProductAttributes',\n            'ProductAttributes.UnitProductAttributes',\n            'ProductAttributes.ProductAttributeCombinations.Attributes'\n        ];\n\n        if (Configure::read('appDb.FCS_PURCHASE_PRICE_ENABLED')) {\n            $contain[] = 'PurchasePriceProducts.Taxes';\n            $contain[] = 'ProductAttributes.PurchasePriceProductAttributes';\n        }\n\n        if (Configure::read('appDb.FCS_SELF_SERVICE_MODE_FOR_STOCK_PRODUCTS_ENABLED')) {\n            $contain[] = 'BarcodeProducts';\n            $contain[] = 'ProductAttributes.BarcodeProductAttributes';\n        }\n\n        $order = [\n            'Products.active' => 'DESC',\n            'Products.name' => 'ASC'\n        ];\n\n        $query = $this->find('all', [\n            'conditions' => $conditions,\n            'contain' => $contain,\n            'order' => ($controller === null ? $order : null)\n        ]);\n\n        if ($categoryId != '') {\n            $query->matching('CategoryProducts', function ($q) use ($categoryId) {\n                return $q->where(['id_category IN' => $categoryId]);\n            });\n        }\n\n        $query\n        ->select('Products.id_product')->distinct()\n        ->select($this) // Products\n        ->select($this->DepositProducts)\n        ->select('Images.id_image')\n        ->select($this->Taxes)\n        ->select($this->Manufacturers)\n        ->select($this->UnitProducts)\n        ->select($this->StockAvailables);\n\n        if (Configure::read('appDb.FCS_PURCHASE_PRICE_ENABLED')) {\n            $query->select($this->PurchasePriceProducts);\n        }\n\n        if (Configure::read('appDb.FCS_SELF_SERVICE_MODE_FOR_STOCK_PRODUCTS_ENABLED')) {\n            $this->Catalog = new Catalog();\n            $query->select(['system_bar_code' => $this->Catalog->getProductIdentifierField()]);\n            $query->select($this->BarcodeProducts);\n        }\n\n        if ($controller) {\n            $query = $controller->paginate($query, [\n                'sortableFields' => [\n                    'Images.id_image', 'Products.name', 'Products.is_declaration_ok', 'Taxes.rate', 'Products.active', 'Manufacturers.name', 'Products.is_stock_product'\n                ],\n                'order' => $order\n            ]);\n        }\n\n        $i = 0;\n        $preparedProducts = [];\n        foreach ($query as $product) {\n            $product->category = (object) [\n                'names' => [],\n                'all_products_found' => false\n            ];\n            foreach ($product->category_products as $category) {\n                // assignment to \"all products\" has to be checked... otherwise show error message\n                if ($category->id_category == Configure::read('app.categoryAllProducts')) {\n                    $product->category->all_products_found = true;\n                } else {\n                    // sometimes associated category does not exist any more...\n                    if (!empty($category->category)) {\n                        $product->category->names[] = $category->category->name;\n                    }\n                }\n            }\n            $product->selected_categories = Hash::extract($product->category_products, '{n}.id_category');\n\n            $product->is_new = true;\n            if ($product->created) {\n                $product->is_new = $this->isNew($product->created->i18nFormat(Configure::read('DateFormat.Database')));\n            }\n\n            $taxRate = is_null($product->tax) ? 0 : $product->tax->rate;\n            $product->gross_price = $this->getGrossPrice($product->price, $taxRate);\n\n            $product->delivery_rhythm_string = Configure::read('app.htmlHelper')->getDeliveryRhythmString(\n                $product->is_stock_product && $product->manufacturer->stock_management_enabled,\n                $product->delivery_rhythm_type,\n                $product->delivery_rhythm_count\n            );\n            $product->last_order_weekday = Configure::read('app.timeHelper')->getWeekdayName(\n                Configure::read('app.timeHelper')->getNthWeekdayBeforeWeekday(1, $product->delivery_rhythm_send_order_list_weekday)\n            );\n\n            $rowClass = [];\n            if (! $product->active) {\n                $rowClass[] = 'deactivated';\n            }\n\n            if (!empty($product->deposit_product)) {\n                $product->deposit = $product->deposit_product->deposit;\n            } else {\n                $product->deposit = 0;\n            }\n\n            if (!empty($product->image)) {\n                $imageSrc = Configure::read('app.htmlHelper')->getProductImageSrc($product->image->id_image, 'home');\n                $imageFile = str_replace('//', '/', $_SERVER['DOCUMENT_ROOT'] . $imageSrc);\n                $imageFile = Configure::read('app.htmlHelper')->removeTimestampFromFile($imageFile);\n                if ($imageFile != '' && !preg_match('/de-default-home/', $imageFile) && file_exists($imageFile)) {\n                    $product->image->hash = sha1_file($imageFile);\n                    $product->image->src = Configure::read('App.fullBaseUrl') . $imageSrc;\n                }\n            }\n\n            // show unity only for main products\n            $additionalProductNameInfos = [];\n            if (empty($product->product_attributes) && $product->unity != '') {\n                $additionalProductNameInfos[] = '<span class=\"unity-for-dialog\">' . $product->unity . '</span>';\n            }\n\n            $product->price_is_zero = false;\n            if (empty($product->product_attributes) && $product->gross_price == 0) {\n                $product->price_is_zero = true;\n            }\n            $product->unit = null;\n            if (empty($product->product_attributes) && !empty($product->unit_product)) {\n\n                $product->unit = $product->unit_product;\n\n                $quantityInUnitsString = Configure::read('app.pricePerUnitHelper')->getQuantityInUnitsWithWrapper($product->unit_product->price_per_unit_enabled, $product->unit_product->quantity_in_units, $product->unit_product->name);\n                if ($quantityInUnitsString != '') {\n                    $additionalProductNameInfos[] = $quantityInUnitsString;\n                }\n\n                if ($product->unit_product->price_per_unit_enabled) {\n                    $product->price_is_zero = false;\n                }\n\n            }\n\n            $product->unchanged_name = $product->name;\n            $product->name = '<span class=\"product-name\">' . $product->name . '</span>';\n            if (!empty($additionalProductNameInfos)) {\n                $product->name = $product->name . ': ' . join(', ', $additionalProductNameInfos);\n            }\n\n            if (empty($product->tax)) {\n                $product->tax = (object) [\n                    'rate' => 0,\n                ];\n            }\n\n            if (Configure::read('appDb.FCS_PURCHASE_PRICE_ENABLED')) {\n\n                $product->purchase_price_is_zero = true;\n                $product->purchase_price_is_set = $this->PurchasePriceProducts->isPurchasePriceSet($product);\n\n                if (empty($product->purchase_price_product) || $product->purchase_price_product->tax_id === null) {\n                    $product->purchase_price_product = (object) [\n                        'tax_id' => null,\n                        'price' => null,\n                        'tax' => [\n                            'rate' => null,\n                        ],\n                    ];\n                }\n                if (!empty($product->purchase_price_product)) {\n\n                    $purchasePriceTaxRate = $product->purchase_price_product->tax->rate ?? 0;\n                    $purchasePrice = $product->purchase_price_product->price ?? null;\n                    if ($purchasePrice === null) {\n                        $product->purchase_gross_price = $purchasePrice;\n                    } else {\n                        $product->purchase_gross_price = $this->getGrossPrice($purchasePrice, $purchasePriceTaxRate);\n                        if ($product->purchase_gross_price > 0) {\n                            $product->purchase_price_is_zero = false;\n                        }\n                    }\n\n                    if (!empty($product->unit) && $product->unit->price_per_unit_enabled) {\n                        if (!is_null($product->unit->purchase_price_incl_per_unit)) {\n                            $product->surcharge_percent = $this->PurchasePriceProducts->calculateSurchargeBySellingPriceGross(\n                                Configure::read('app.pricePerUnitHelper')->getPricePerUnit($product->unit->price_incl_per_unit, $product->unit_product->quantity_in_units, $product->unit_product->amount),\n                                $taxRate,\n                                Configure::read('app.pricePerUnitHelper')->getPricePerUnit($product->unit->purchase_price_incl_per_unit, $product->unit_product->quantity_in_units, $product->unit_product->amount),\n                                $purchasePriceTaxRate,\n                            );\n                            $priceInclPerUnitAndAmount = $this->getNetPrice($product->unit->price_incl_per_unit, $taxRate) * $product->unit_product->quantity_in_units / $product->unit_product->amount;\n                            $purchasePriceInclPerUnitAndAmount = $this->getNetPrice($product->unit->purchase_price_incl_per_unit, $purchasePriceTaxRate) * $product->unit_product->quantity_in_units / $product->unit_product->amount;\n                            $product->surcharge_price = $priceInclPerUnitAndAmount - $purchasePriceInclPerUnitAndAmount;\n                            if ($purchasePriceInclPerUnitAndAmount > 0) {\n                                $product->purchase_price_is_zero = false;\n                            }\n                        }\n                    } else {\n                        $product->surcharge_percent = $this->PurchasePriceProducts->calculateSurchargeBySellingPriceGross(\n                            $product->gross_price,\n                            $taxRate,\n                            $product->purchase_gross_price,\n                            $purchasePriceTaxRate,\n                        );\n                        $product->surcharge_price = $product->price - $purchasePrice;\n                    }\n\n                }\n            }\n\n            $rowClass[] = 'main-product';\n            $rowIsOdd = false;\n            if ($i % 2 == 0) {\n                $rowIsOdd = true;\n                $rowClass[] = 'custom-odd';\n            }\n            $product->row_class = join(' ', $rowClass);\n\n            $preparedProducts[] = $product;\n            $i ++;\n\n            if (! empty($product->product_attributes)) {\n                $currentPreparedProduct = count($preparedProducts) - 1;\n                $preparedProducts[$currentPreparedProduct]['AttributesRemoved'] = 0;\n\n                foreach ($product->product_attributes as $attribute) {\n                    if (($quantityIsZeroFilterOn && empty($attribute->stock_available)) || ($priceIsZeroFilterOn && empty($attribute))) {\n                        $preparedProducts[$currentPreparedProduct]['AttributesRemoved'] ++;\n                        continue;\n                    }\n\n                    $grossPrice = 0;\n                    if (! empty($attribute->price)) {\n                        $grossPrice = $this->getGrossPrice($attribute->price, $taxRate);\n                    }\n\n                    $rowClass = [\n                        'sub-row'\n                    ];\n                    if (! $product->active) {\n                        $rowClass[] = 'deactivated';\n                    }\n\n                    if ($rowIsOdd) {\n                        $rowClass[] = 'custom-odd';\n                    }\n\n                    $priceIsZero = false;\n                    if ($grossPrice == 0) {\n                        $priceIsZero = true;\n                    }\n                    if (!empty($attribute->unit_product_attribute) && $attribute->unit_product_attribute->price_per_unit_enabled) {\n                        $productName = Configure::read('app.pricePerUnitHelper')->getQuantityInUnitsStringForAttributes(\n                            $attribute->product_attribute_combination->attribute->name,\n                            $attribute->product_attribute_combination->attribute->can_be_used_as_unit,\n                            $attribute->unit_product_attribute->price_per_unit_enabled,\n                            $attribute->unit_product_attribute->quantity_in_units,\n                            $attribute->unit_product_attribute->name\n                        );\n                        $priceIsZero = false;\n                    } else {\n                        $productName = $attribute->product_attribute_combination->attribute->name;\n                        if ($addProductNameToAttributes) {\n                            $productName = $product->name . ': ' . $productName;\n                        }\n                    }\n\n                    $preparedProduct = [\n                        'id_product' => $product->id_product . '-' . $attribute->id_product_attribute,\n                        'gross_price' => $grossPrice,\n                        'active' => - 1,\n                        'is_stock_product' => $product->is_stock_product,\n                        'price_is_zero' => $priceIsZero,\n                        'row_class' => join(' ', $rowClass),\n                        'unchanged_name' => $product->unchanged_name,\n                        'name' => $productName,\n                        'description_short' => '',\n                        'description' => '',\n                        'unity' => '',\n                        'manufacturer' => [\n                            'name' => (!empty($product->manufacturer) ? $product->manufacturer->name : ''),\n                            'stock_management_enabled' => (!empty($product->manufacturer) ? $product->manufacturer->stock_management_enabled : false),\n                        ],\n                        'default_on' => $attribute->default_on,\n                        'stock_available' => [\n                            'quantity' => $attribute->stock_available->quantity,\n                            'quantity_limit' => $attribute->stock_available->quantity_limit,\n                            'sold_out_limit' => $attribute->stock_available->sold_out_limit,\n                            'always_available' => $attribute->stock_available->always_available,\n                            'default_quantity_after_sending_order_lists' => $attribute->stock_available->default_quantity_after_sending_order_lists,\n                        ],\n                        'deposit' => !empty($attribute->deposit_product_attribute) ? $attribute->deposit_product_attribute->deposit : 0,\n                        'unit' => !empty($attribute->unit_product_attribute) ? $attribute->unit_product_attribute : [],\n                        'category' => [\n                            'names' => [],\n                            'all_products_found' => true\n                        ],\n                        'image' => null,\n                        'barcode_product' => $attribute->barcode_product_attribute,\n                    ];\n\n                    if (Configure::read('appDb.FCS_SELF_SERVICE_MODE_FOR_STOCK_PRODUCTS_ENABLED')) {\n                        $attributeId = $attribute->id_product_attribute ?? 0;\n                        $preparedProduct['system_bar_code'] = $product->system_bar_code . Configure::read('app.numberHelper')->addLeadingZerosToNumber((string) $attributeId, 4);\n                        $preparedProduct['image'] = $product->image;\n                        if (!empty($attribute->unit_product_attribute) && $attribute->unit_product_attribute->price_per_unit_enabled) {\n                            $preparedProduct['nameForBarcodePdf'] = $product->name . ': ' . $productName;\n                        }\n                    }\n\n                    if (Configure::read('appDb.FCS_PURCHASE_PRICE_ENABLED')) {\n\n                        $preparedProduct['purchase_price_is_set'] = $this->ProductAttributes->PurchasePriceProductAttributes->isPurchasePriceSet($attribute);\n                        $preparedProduct['purchase_price_is_zero'] = true;\n\n                        $purchasePrice = $attribute->purchase_price_product_attribute->price ?? null;\n                        if ($purchasePrice === null) {\n                            $preparedProduct['purchase_gross_price'] = $purchasePrice;\n                        } else {\n                            $preparedProduct['purchase_gross_price'] = $this->getGrossPrice($purchasePrice, $purchasePriceTaxRate);\n                            if ($preparedProduct['purchase_gross_price'] > 0) {\n                                $preparedProduct['purchase_price_is_zero'] = false;\n                            }\n                        }\n\n                        if (!empty($attribute->unit_product_attribute) && $attribute->unit_product_attribute->price_per_unit_enabled) {\n                            if (!is_null($attribute->unit_product_attribute->purchase_price_incl_per_unit)) {\n                                $preparedProduct['surcharge_percent'] = $this->PurchasePriceProducts->calculateSurchargeBySellingPriceGross(\n                                    Configure::read('app.pricePerUnitHelper')->getPricePerUnit($attribute->unit_product_attribute->price_incl_per_unit, $attribute->unit_product_attribute->quantity_in_units, $attribute->unit_product_attribute->amount),\n                                    $taxRate,\n                                    Configure::read('app.pricePerUnitHelper')->getPricePerUnit($attribute->unit_product_attribute->purchase_price_incl_per_unit, $attribute->unit_product_attribute->quantity_in_units, $attribute->unit_product_attribute->amount),\n                                    $purchasePriceTaxRate,\n                                );\n                                $priceInclPerUnitAndAmount = $this->getNetPrice($attribute->unit_product_attribute->price_incl_per_unit, $taxRate) * $attribute->unit_product_attribute->quantity_in_units / $attribute->unit_product_attribute->amount;\n                                $purchasePriceInclPerUnitAndAmount = $this->getNetPrice($attribute->unit_product_attribute->purchase_price_incl_per_unit, $purchasePriceTaxRate) * $attribute->unit_product_attribute->quantity_in_units / $attribute->unit_product_attribute->amount;\n                                $preparedProduct['surcharge_price'] = $priceInclPerUnitAndAmount - $purchasePriceInclPerUnitAndAmount;\n                                if ($purchasePriceInclPerUnitAndAmount > 0) {\n                                    $preparedProduct['purchase_price_is_zero'] = false;\n                                }\n                            }\n                        } else {\n                            $preparedProduct['surcharge_percent'] = $this->PurchasePriceProducts->calculateSurchargeBySellingPriceGross(\n                                $grossPrice,\n                                $taxRate,\n                                $preparedProduct['purchase_gross_price'],\n                                $purchasePriceTaxRate,\n                            );\n                            $preparedProduct['surcharge_price'] = $attribute->price - $purchasePrice;\n                        }\n\n\n                    }\n                    $preparedProducts[] = $preparedProduct;\n                }\n            }\n        }\n\n        // price zero filter is difficult to implement, because if there are attributes assigned to the product, the product's price is always 0\n        // which would lead to always showing the main product of attributes if price zero filter is set\n        // this is not the case for quantity zero filter, because the main product's quantity is the sum of the associated attribute quantities\n        if ($priceIsZeroFilterOn) {\n            foreach ($preparedProducts as $key => $preparedProduct) {\n                if (isset($preparedProducts[$key]['AttributesRemoved']) && $preparedProducts[$key]['AttributesRemoved'] == count($preparedProducts[$key]->product_attributes)) {\n                    unset($preparedProducts[$key]);\n                }\n            }\n        }\n        $preparedProducts = json_decode(json_encode($preparedProducts), false); // convert array recursively into object\n        return $preparedProducts;\n    }\n\n    public function getForDropdown($appAuth, $manufacturerId)\n    {\n        $conditions = [];\n\n        if ($appAuth->isManufacturer()) {\n            $manufacturerId = $appAuth->getManufacturerId();\n        }\n\n        if ($manufacturerId > 0) {\n            $conditions['Manufacturers.id_manufacturer'] = $manufacturerId;\n        }\n\n        // ->find('list') a does not return associated model data\n        $products = $this->find('all', [\n            'conditions' => $conditions,\n            'contain' => [\n                'Manufacturers',\n            ],\n            'order' => [\n                'Products.active' => 'DESC',\n                'Products.name' => 'ASC'\n            ]\n        ]);\n\n        $onlineProducts = [];\n        $offlineProducts = [];\n        $deletedProducts = [];\n        foreach ($products as $product) {\n            $productNameForDropdown = $product->name . (!empty($product->manufacturer) ? ' - ' . html_entity_decode($product->manufacturer->name) : '');\n            switch($product->active) {\n                case 1:\n                    $onlineProducts[$product->id_product] = $productNameForDropdown;\n                    break;\n                case 0:\n                    $offlineProducts[$product->id_product] = $productNameForDropdown;\n                    break;\n                case -1:\n                    $deletedProducts[$product->id_product] = $productNameForDropdown;\n                    break;\n            }\n        }\n\n        $productsForDropdown = [];\n        if (! empty($onlineProducts)) {\n            $onlineCount = count($onlineProducts);\n            $productsForDropdown[__('online') . '-' . $onlineCount] = $onlineProducts;\n        }\n\n        if (! empty($offlineProducts)) {\n            $offlineCount = count($offlineProducts);\n            $productsForDropdown[__('offline') . '-' . $offlineCount] = $offlineProducts;\n        }\n\n        if (! empty($deletedProducts)) {\n            $deletedCount = count($deletedProducts);\n            $productsForDropdown[__('deleted') . '-' . $deletedCount] = $deletedProducts;\n        }\n\n        return $productsForDropdown;\n    }\n\n    /**\n     * @param float $grossPrice (for all units)\n     * @param float $netPrice (for one unit)\n     * @param int $quantity\n     * @return float\n     */\n    public function getUnitTax($grossPrice, $netPrice, $quantity)\n    {\n        if ($quantity == 0) {\n            return 0;\n        }\n        return round(($grossPrice - ($netPrice * $quantity)) / $quantity, 2);\n    }\n\n    public function getGrossPrice($netPrice, $taxRate)\n    {\n        $grossPrice = $netPrice * (100 + $taxRate) / 100;\n        $grossPrice = round($grossPrice, 2);\n        return $grossPrice;\n    }\n\n    public function getNetPrice($grossPrice, $taxRate)\n    {\n        $netPrice = $grossPrice / (100 + $taxRate) * 100;\n        $netPrice = round($netPrice, 6);\n        return $netPrice;\n    }\n\n    public function getNetPriceForNewTaxRate($netPrice, $oldTaxRate, $newTaxRate) {\n        $netPrice = $netPrice / ((100 + $newTaxRate) / 100) * (1 + $oldTaxRate / 100);\n        $netPrice = round($netPrice, 6);\n        return $netPrice;\n    }\n\n    private function getIsQuantityMinFilterSetCondition()\n    {\n        return '(StockAvailables.quantity < 3 && (StockAvailables.always_available = 0 || (Products.is_stock_product = 1 && Manufacturers.stock_management_enabled = 1)))';\n    }\n\n    private function getIsPriceZeroCondition()\n    {\n        return 'Products.price = 0';\n    }\n\n    public function setDefaultAttributeId($productId, $productAttributeId)\n    {\n        $productAttributes = $this->ProductAttributes->find('all', [\n            'conditions' => [\n                'ProductAttributes.id_product' => $productId,\n            ]\n        ]);\n\n        $productAttributeIds = [];\n        foreach ($productAttributes as $attribute) {\n            $productAttributeIds[] = $attribute->id_product_attribute;\n        }\n\n        // first set all associated attributes to 0\n        $this->ProductAttributes->updateAll([\n            'default_on' => 0\n        ], [\n            'id_product_attribute IN (' . join(', ', $productAttributeIds) . ')',\n        ]);\n\n        // then set the new one\n        $productAttributeEntity = $productAttributes->where([\n            'ProductAttributes.id_product_attribute' => $productAttributeId,\n        ])->first();\n        $productAttributeEntity->default_on = APP_ON;\n        $this->ProductAttributes->save($productAttributeEntity);\n    }\n\n    public function changeImage($products)\n    {\n\n        foreach ($products as $product) {\n            $productId = key($product);\n            $imageFromRemoteServer = $product[$productId];\n            $imageFromRemoteServer = Configure::read('app.htmlHelper')->removeTimestampFromFile($imageFromRemoteServer);\n            if ($imageFromRemoteServer == 'no-image') {\n                continue;\n            }\n\n            if (filter_var($imageFromRemoteServer, FILTER_VALIDATE_URL)) {\n                if (!RemoteFile::exists($imageFromRemoteServer)) {\n                    throw new InvalidParameterException('remote image not existing: ' . $imageFromRemoteServer);\n                }\n            } else {\n                $remoteImage = file_exists($imageFromRemoteServer);\n                if (!$remoteImage) {\n                    throw new InvalidParameterException('local image not existing: ' . $imageFromRemoteServer);\n                }\n            }\n\n            $imageSize = getimagesize($imageFromRemoteServer);\n            if ($imageSize === false) {\n                throw new InvalidParameterException('file is not not an image: ' . $imageFromRemoteServer);\n            }\n        }\n\n        $success = false;\n        foreach ($products as $product) {\n\n            $productId = key($product);\n            $ids = $this->getProductIdAndAttributeId($productId);\n\n            if ($ids['attributeId'] > 0) {\n                continue;\n            }\n\n            $imageFromRemoteServer = $product[$productId];\n            $imageFromRemoteServer = Configure::read('app.htmlHelper')->removeTimestampFromFile($imageFromRemoteServer);\n            $extension = strtolower(pathinfo($imageFromRemoteServer, PATHINFO_EXTENSION));\n\n            $product = $this->find('all', [\n                'conditions' => [\n                    'Products.id_product' => $ids['productId']\n                ],\n                'contain' => [\n                    'Images'\n                ]\n            ])->first();\n\n            if (empty($product->image)) {\n                // product does not yet have image => create the necessary record\n                $image = $this->Images->save(\n                    $this->Images->newEntity(\n                        ['id_product' => $ids['productId']]\n                    )\n                );\n            } else {\n                $image = $product->image;\n            }\n\n            $imageIdAsPath = Configure::read('app.htmlHelper')->getProductImageIdAsPath($image->id_image);\n            $thumbsPath = Configure::read('app.htmlHelper')->getProductThumbsPath($imageIdAsPath);\n\n            if ($imageFromRemoteServer != 'no-image') {\n\n                Folder::nonRecursivelyRemoveAllFiles($thumbsPath);\n                if (!file_exists($thumbsPath)) {\n                    mkdir($thumbsPath, 0755, true);\n                }\n                foreach (Configure::read('app.productImageSizes') as $thumbSize => $options) {\n                    $thumbsFileName = $thumbsPath . DS . $image->id_image . $options['suffix'] . '.' . $extension;\n                    $remoteFileName = preg_replace('/-home_default/', $options['suffix'], $imageFromRemoteServer);\n                    copy($remoteFileName, $thumbsFileName);\n                }\n\n            } else {\n\n                // delete db records\n                $this->Images->deleteAll([\n                    'Images.id_image' => $image->id_image\n                ]);\n\n                Folder::nonRecursivelyRemoveAllFiles($thumbsPath);\n\n            }\n        }\n\n        return $success;\n    }\n\n    public function add($manufacturer, $productName, $descriptionShort, $description, $unity, $isDeclarationOk, $idStorageLocation, $barcode)\n    {\n        $defaultQuantity = 0;\n\n        $this->Manufacturer = FactoryLocator::get('Table')->get('Manufacturers');\n\n        $productEntity = $this->newEntity(\n            [\n                'id_manufacturer' => $manufacturer->id_manufacturer,\n                'id_tax' => $this->Manufacturer->getOptionDefaultTaxId($manufacturer->default_tax_id),\n                'name' => StringComponent::removeSpecialChars(strip_tags(trim($productName))),\n                'delivery_rhythm_send_order_list_weekday' => DeliveryRhythm::getSendOrderListsWeekday(),\n                'description_short' => StringComponent::prepareWysiwygEditorHtml($descriptionShort, self::ALLOWED_TAGS_DESCRIPTION_SHORT),\n                'description' => StringComponent::prepareWysiwygEditorHtml($description, self::ALLOWED_TAGS_DESCRIPTION),\n                'unity' => StringComponent::removeSpecialChars(strip_tags(trim($unity))),\n                'is_declaration_ok' => $isDeclarationOk,\n                'id_storage_location' => $idStorageLocation,\n            ],\n            [\n                'validate' => 'name'\n            ]\n        );\n\n        if ($productEntity->hasErrors()) {\n            return $productEntity;\n        }\n\n        if ($barcode != '') {\n            $barcode = StringComponent::removeSpecialChars(strip_tags(trim($barcode)));\n            $barcodeEntity2Save = $this->BarcodeProducts->newEntity([\n                'barcode' => $barcode,\n            ], ['validate' => true]);\n            if ($barcodeEntity2Save->hasErrors()) {\n                return $barcodeEntity2Save;\n            }\n        }\n\n        $newProduct = $this->save($productEntity);\n        $newProductId = $newProduct->id_product;\n\n        if ($barcode != '') {\n            $barcodeEntity2Save->product_id = $newProductId;\n            $this->BarcodeProducts->save($barcodeEntity2Save);\n        }\n\n        if (Configure::read('appDb.FCS_PURCHASE_PRICE_ENABLED')) {\n            $entity2Save = $this->PurchasePriceProducts->getEntityToSaveByProductId($newProductId);\n            $patchedEntity = $this->PurchasePriceProducts->patchEntity(\n                $entity2Save,\n                [\n                    'tax_id' => $this->Manufacturer->getOptionDefaultTaxId($manufacturer->default_tax_id_purchase_price),\n                ],\n            );\n            $this->PurchasePriceProducts->save($patchedEntity);\n        }\n\n        // INSERT CATEGORY_PRODUCTS\n        $this->CategoryProducts->save(\n            $this->CategoryProducts->newEntity(\n                [\n                    'id_category' => Configure::read('app.categoryAllProducts'),\n                    'id_product' => $newProductId\n                ]\n            )\n        );\n\n        // INSERT STOCK AVAILABLE\n        $this->StockAvailables->save(\n            $this->StockAvailables->newEntity(\n                [\n                    'id_product' => $newProductId,\n                    'quantity' => $defaultQuantity\n                ]\n            )\n        );\n\n        $newProduct = $this->find('all', [\n            'conditions' => [\n                'Products.id_product' => $newProductId\n            ]\n        ])->first();\n\n        return $productEntity;\n    }\n}\n"], "fixing_code": ["<h1 align=\"center\">\n  <a href=\"https://www.foodcoopshop.com\"><img src=\"https://raw.githubusercontent.com/foodcoopshop/foodcoopshop/develop/webroot/files/images/logo.png\" alt=\"FoodCoopShop\"></a>\n</h1>\n\n# Changelog v3.x\n\nDas Format basiert auf [keepachangelog.com](http://keepachangelog.com) und verwendet [Semantic Versioning](http://semver.org/).\n\n## v3.6.1\n\n### Security fix\n- Security-Fix f\u00fcr das Netzwerk-Modul [PR#972](https://github.com/foodcoopshop/foodcoopshop/pull/972)\n\nDatum: 02.11.2023 / [Alle \u00c4nderungen anzeigen](https://github.com/foodcoopshop/foodcoopshop/compare/v3.6.0...v3.6.1)\n\n## v3.6.0\n\n### Neue Datenschutz-Funktionen\n- Personenbezogene Mitglieder-Daten (Vorname, Nachname, E-Mail) k\u00f6nnen nun f\u00fcr bestimmte Hersteller systemweit **anonymisiert** werden. Im Sinne des Datenschutzes ist das f\u00fcr neu angelegte Hersteller auch die Standard-Einstellung. [I#767](https://github.com/foodcoopshop/foodcoopshop/issues/767) / [I#929](https://github.com/foodcoopshop/foodcoopshop/issues/929) / [PR#930](https://github.com/foodcoopshop/foodcoopshop/pull/930) / [PR#932](https://github.com/foodcoopshop/foodcoopshop/pull/932) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- E-Mail-Adressen, die \u00fcber den Editor eingegeben wurden (z.B. auf Seiten oder in Blog-Artikeln), werden jetzt automatisch verlinkt und spamgesch\u00fctzt angezeigt. [I#933](https://github.com/foodcoopshop/foodcoopshop/issues/933) / [PR#943](https://github.com/foodcoopshop/foodcoopshop/pull/934) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n\n### Neue Funktionen / Verbesserungen\n- Ab sofort kann auch ein **dunkles Design / Dark Mode** verwendet werden. Das schont die Augen und spart bei OLED-Bildschirmen auch Strom. Einfach auf den Mond neben dem Anmelde-Link klicken. [I#873](https://github.com/foodcoopshop/foodcoopshop/issues/873) / [PR#913](https://github.com/foodcoopshop/foodcoopshop/pull/913) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Beim Anpassen des Gewichts f\u00fcr Produkte, die mehrmals bestellt wurden, ist jetzt ein **eingebauter Taschenrechner** hilfreich. Man kann z.B. \"192+167\" eintippen und das Ergebnis wird automatisch \u00fcbernommen. Der Taschenrechner ist auch im Selbstbedienungs-Modus integriert. [PR#923](https://github.com/foodcoopshop/foodcoopshop/pull/923) / [Commit](https://github.com/foodcoopshop/foodcoopshop/commit/449aedc29269cd1d74322c3f2239a4953d6500a5) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Superadmins k\u00f6nnen Tag und Uhrzeit der **Cronjobs** (z.B. die automatische Bestell-Erinnerung, Rechnungsversand) jetzt selber im Admin-Bereich (Homepage-Verwaltung / Einstellungen / neuer Tab \"Cronjobs\") \u00e4ndern. [I#860](https://github.com/foodcoopshop/foodcoopshop/issues/860) / [PR#74](https://github.com/foodcoopshop/foodcoopshop/pull/874) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Die \u00dcberschriften aller Tabellen im Admin-Bereich bleiben jetzt beim Scrollen sichtbar (nicht in iOS). [PR#888](https://github.com/foodcoopshop/foodcoopshop/pull/888) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Im Produkt-Admin kann jetzt der Status (aktiviert, deaktiviert) von mehreren markierten Produkten auf einmal ge\u00e4ndert werden. [I#895](https://github.com/foodcoopshop/foodcoopshop/issues/895) / [PR#897](https://github.com/foodcoopshop/foodcoopshop/pull/897) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Hersteller k\u00f6nnen ihre Bestellungen \u00fcber [eine neue API](https://foodcoopshop.github.io/de/netzwerk-modul.html#6-api-zum-abrufen-von-bestellungen) abrufen und sie so im eigenen System weiterverarbeiten. [I#894](https://github.com/foodcoopshop/foodcoopshop/issues/894) / [PR#899](https://github.com/foodcoopshop/foodcoopshop/pull/899) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Bei der Umsatzstatistik kann jetzt auch nach \"letzte 12 bzw. 24 Monate\" gefiltert werden. [I#904](https://github.com/foodcoopshop/foodcoopshop/issues/904) / [PR#908](https://github.com/foodcoopshop/foodcoopshop/pull/908) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Bei allen Produkten kann jetzt die Anzahl der bestellten Einheiten f\u00fcr den n\u00e4chsten Abholtag angezeigt werden. Das hilft, wenn bestimmte Gebindegr\u00f6\u00dfen erreicht werden sollen. [I#909](https://github.com/foodcoopshop/foodcoopshop/issues/909) / [PR#910](https://github.com/foodcoopshop/foodcoopshop/pull/910) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Beim Umbuchen auf ein anderes Mitglied kann jetzt \u00fcber eine Checkbox ausgew\u00e4hlt werden, ob die betroffenen Mitglieder per Mail benachrichtigt werden sollen. [I#920](https://github.com/foodcoopshop/foodcoopshop/issues/920) / [PR#921](https://github.com/foodcoopshop/foodcoopshop/pull/921) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Bei einer herstellerbasierten Lieferpause sind Lagerprodukte jetzt weiterhin vorbestellbar. [PR#924](https://github.com/foodcoopshop/foodcoopshop/pull/924) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Alle Initiativen, die die Funktion \"Rechnung an Kunden\" aktiviert haben, werden jetzt mit einer E-Mail \u00fcber einen Bestell-Kommentar benachrichtigt. [PR#926](https://github.com/foodcoopshop/foodcoopshop/pull/926) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Die Konfiguration \"Freitag Bestellschluss / Samstag Bestelllisten-Versand / Donnerstag Abholtag\" ist jetzt m\u00f6glich. [I#866](https://github.com/foodcoopshop/foodcoopshop/issues/866) / [PR#867](https://github.com/foodcoopshop/foodcoopshop/pull/867) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n\n### For developers\n- New \ud83d\udc33 [Docker Dev Environment](https://foodcoopshop.github.io/en/docker-dev-environment.html) and [Gitpod-Integration](https://gitpod.io/#https://github.com/foodcoopshop/foodcoopshop).  [I#871](https://github.com/foodcoopshop/foodcoopshop/issues/871) / [PR#876](https://github.com/foodcoopshop/foodcoopshop/pull/876) / [PR#879](https://github.com/foodcoopshop/foodcoopshop/pull/879) / [PR#881](https://github.com/foodcoopshop/foodcoopshop/pull/881) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Enable strict typing in every php file to improve code quality. [I#872](https://github.com/foodcoopshop/foodcoopshop/issues/872) / [PR#893](https://github.com/foodcoopshop/foodcoopshop/pull/893) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Replace CakePHP's deprecated classes: File, Folder, Shell. [I#902](https://github.com/foodcoopshop/foodcoopshop/issues/902) [I#906](https://github.com/foodcoopshop/foodcoopshop/issues/906) / [PR#905](https://github.com/foodcoopshop/foodcoopshop/pull/905) / [PR#907](https://github.com/foodcoopshop/foodcoopshop/pull/907) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Die Software ist jetzt kompatibel mit PHP 8.2. [I#915](https://github.com/foodcoopshop/foodcoopshop/issues/915) / [PR#916](https://github.com/foodcoopshop/foodcoopshop/pull/916) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n\n### Bugfixes\n- Sofern Rechnungen an Kunden generiert wurden (Dorfladen) UND die Steuer f\u00fcr Pfand nicht auf 20% gesetzt war, wurde die Steuer von geliefertem Pfand trotzdem immer mit 20% berechnet. [I#940](https://github.com/foodcoopshop/foodcoopshop/issues/940) / [PR#941](https://github.com/foodcoopshop/foodcoopshop/pull/941) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Bei Sofort-Bestellungen ist es ab sofort nicht mehr m\u00f6glich, das erneute Laden von langsamen Seiten durch wiederholtes Klicken zu erzwingen. Diese Mehrfach-Requests haben n\u00e4mlich den eingeloggten User und den User, f\u00fcr den bestellt wird, durcheinandergewirbelt. [I#945](https://github.com/foodcoopshop/foodcoopshop/issues/945) / [PR#946](https://github.com/foodcoopshop/foodcoopshop/pull/946) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n\nDatum: 12.04.2023 / [Mehr Details zum Release](https://github.com/foodcoopshop/foodcoopshop/projects/18) / [Alle \u00c4nderungen anzeigen](https://github.com/foodcoopshop/foodcoopshop/compare/v3.5.1...v3.6.0)\n\n# v3.5.1\n\n### Herzlichen Dank an alle beteiligten Personen\n* <img src=\"https://github.com/mrothauer.png\" width=\"20\"> [mrothauer](https://github.com/mrothauer)\n* <img src=\"https://github.com/pabneukistl.png\" width=\"20\"> [pabneukistl](https://github.com/pabneukistl)\n* <img src=\"https://github.com/toblinga.png\" width=\"20\"> [toblinga](https://github.com/toblinga)\n\n### Bugfixes\n- Das mysteri\u00f6se Verschwinden von Produkt-Bildern ist gel\u00f6st. Ob deine Installation vom Bug betroffen ist, kannst du \u00fcber diese Route feststellen: /admin/products/detectMissingProductImages. [I#824](https://github.com/foodcoopshop/foodcoopshop/issues/824)\n- Die Umsatzsteuer wurde beim Abschlie\u00dfen des Warenkorb immer mit 0,00 \u20ac ausgewiesen. [Commit](https://github.com/foodcoopshop/foodcoopshop/commit/cb876b9ae7d384c576f7bf60649af94260564414)\n- Bei einer Barcode-Suche im Selbstbedienungs-Modus wurde immer nur die erste Variante direkt in den Warenkorb gelegt. [I#939](https://github.com/foodcoopshop/foodcoopshop/issues/939)\n- In seltenen F\u00e4llen wurden bei der Barcode-Suche falsche Produkte angezeigt. [I#938](https://github.com/foodcoopshop/foodcoopshop/issues/938)\n- Bei einer Sofort-Bestellung wurde bei Dorfl\u00e4den unter bestimmten Umst\u00e4nden Verkaufspreis und Einkaufspreis in der Anzeige verwechselt. Bestell- und Rechnungsdaten waren korrekt, es war \"lediglich\" ein Anzeigeproblem. [I#937](https://github.com/foodcoopshop/foodcoopshop/issues/937)\n- Anpassungen der Hello-Cash-API-Requests.\n\nDatum: 28.02.2023 / [Alle \u00c4nderungen anzeigen](https://github.com/foodcoopshop/foodcoopshop/compare/v3.5.0...v3.5.1)\n\n# v3.5.0\n\n### Herzlichen Dank an alle beteiligten Personen\n* <img src=\"https://github.com/MaxGitHubAccount.png\" width=\"20\"> [MaxGitHubAccount](https://github.com/MaxGitHubAccount)\n* <img src=\"https://github.com/mrothauer.png\" width=\"20\"> [mrothauer](https://github.com/mrothauer)\n\n### \u00c4nderung der Open-Source-Lizenz\n- Ab v3.5 wird der FoodCoopShop unter der GNU Affero General Public License v3.0 (AGPL) ver\u00f6ffentlicht. [I#837](https://github.com/foodcoopshop/foodcoopshop/issues/837) / [PR#845](https://github.com/foodcoopshop/foodcoopshop/pull/845)\n\n### Neue Funktionen / Verbesserungen\n- Das User-Men\u00fc rechts oben ist jetzt aufger\u00e4umter: Die Unterpunkte erscheinen bei Mouseover, bei Mitgliedern ist der verwirrende Button \"Admin-Bereich\" entfernt und die Admin-Men\u00fcstruktur ist bereits im Frontend abgebildet. [PR#836](https://github.com/foodcoopshop/foodcoopshop/pull/863) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Mitglieder und Hersteller k\u00f6nnen jetzt \u00fcber ein eigenes Formular Feedback verfassen, welches dann \u00f6ffentlich angezeigt wird. [Zur Online-Doku](https://foodcoopshop.github.io/de/user-feedback.html). [I#342](https://github.com/foodcoopshop/foodcoopshop/issues/342) / [PR#861](https://github.com/foodcoopshop/foodcoopshop/pull/861) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Verbesserte Darstellung der Blog-Artikel: Der Men\u00fcpunkt \"Aktuelles\" wandert in den Footer, hei\u00dft jetzt \"Blog-Archiv\"und zeigt nur noch jene Blog-Artikel an, die nicht auf der Startseite angezeigt werden. Im Blog-Archiv-Slider \u00fcber den Produkten werden nur noch die Blog-Artikel von der Startseite angezeigt. [I#790](https://github.com/foodcoopshop/foodcoopshop/issues/790) / [PR#795](https://github.com/foodcoopshop/foodcoopshop/pull/795) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Die Software beinhaltet jetzt eine Newsletter-Funktion. [Zur Online-Doku](https://foodcoopshop.github.io/de/mitglieder.html#newsletter-funktion). [I#818](https://github.com/foodcoopshop/foodcoopshop/issues/818) / [PR#823](https://github.com/foodcoopshop/foodcoopshop/pull/823) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Nach Klick auf \"Warenkorb anzeigen\" wird automatisch zum Button \"Zahlungspflichtig bestellen\" gescrollt. Dieser konnte - vor allem wenn viele Produkte im Warenkorb sind - leicht \u00fcbersehen werden. [PR#796](https://github.com/foodcoopshop/foodcoopshop/pull/796) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Schnellere Ladezeit des Produkt-Kataloges, speziell f\u00fcr Dorfladen-Online-Installationen. [I#763](https://github.com/foodcoopshop/foodcoopshop/issues/763) / [PR#813](https://github.com/foodcoopshop/foodcoopshop/pull/813) / [PR#815](https://github.com/foodcoopshop/foodcoopshop/pull/815) / [PR#822](https://github.com/foodcoopshop/foodcoopshop/pull/822) / [I#816](https://github.com/foodcoopshop/foodcoopshop/issues/816) / [PR#835](https://github.com/foodcoopshop/foodcoopshop/pull/835) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Der CSV-Upload f\u00fcr die Guthaben-Aufladungen unterst\u00fctzt jetzt auch die Sparkasse und die GLS-Bank. [C#1](https://github.com/foodcoopshop/foodcoopshop/commit/a3fc47e23d489efb545f57a33f43fecbebf65ed2) [C#2](https://github.com/foodcoopshop/foodcoopshop/commit/513021e6a7acc3e5e38a61489d45ecc813ce8a1d) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Da der E-Mail-Versand (z.B. Verschicken der Bestellbest\u00e4tigung) immer wieder komplizierte Probleme verursacht, werden ab sofort alle E-Mails in einer Queue gesammelt und \u00fcber einen Hintergrund-Prozess (Worker) versendet. [I#842](https://github.com/foodcoopshop/foodcoopshop/issues/842) / [PR#843](https://github.com/foodcoopshop/foodcoopshop/pull/843)\n- Bei der Produkt-Suche werden jetzt zuerst alle Produkte angezeigt, bei denen der Suchbegriff im Produktnamen vorkommt. Und dann jene mit dem Suchbegriff in der kurzen Beschreibung. [PR#852](https://github.com/foodcoopshop/foodcoopshop/pull/852)\n- Bei monatlichen Cronjobs kann jetzt mit dem Wert \"0\" auch der Monatsletzte als Ausf\u00fchrtag angegeben werden. [I#854](https://github.com/foodcoopshop/foodcoopshop/issues/854) / [PR#859](https://github.com/foodcoopshop/foodcoopshop/pull/859)\n- Die Umsatzsteuer in der Bestellbest\u00e4tigung kann nun mittels `app.showTaxInOrderConfirmationEmail => false` ausgeblendet werden. [PR#869](https://github.com/foodcoopshop/foodcoopshop/pull/869) <a href=\"https://github.com/MaxGitHubAccount\"><img src=\"https://github.com/MaxGitHubAccount.png\" width=\"20\"></a>\n\n### Neue Funktionen f\u00fcr den [Einzelhandels-Modus](https://foodcoopshop.github.io/de/dorfladen-online.html)\n- Kunden k\u00f6nnen sich jetzt auch als Firma (mit Firmennamen und optionaler Ansprechperson) registrieren. [I#819](https://github.com/foodcoopshop/foodcoopshop/issues/819) / [PR#821](https://github.com/foodcoopshop/foodcoopshop/pull/821) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- F\u00fcr Kunden-Rechnungen kann nun ein Pr\u00e4fix (max. 6 Zeichen) angegeben werden. Achtung: Nicht m\u00f6glich bei Verwendung der Hello-Cash-API! [I#809](https://github.com/foodcoopshop/foodcoopshop/issues/809) / [PR#810](https://github.com/foodcoopshop/foodcoopshop/pull/810) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Die Berechnung der Umsatzsteuer auf den Rechnungen kann jetzt so eingestellt werden, dass die Gesamt-Steuer auf Basis der Gesamt-Netto-Erl\u00f6se berechnet wird. Das ist f\u00fcr pauschalierte Betriebe sinnvoll, die die Software auch zur Verrechnung verwenden. Achtung: Nicht m\u00f6glich bei Verwendung der Hello-Cash-API! [I#807](https://github.com/foodcoopshop/foodcoopshop/issues/807) / [PR#812](https://github.com/foodcoopshop/foodcoopshop/pull/812) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Einkaufen zum Nullpreis ist jetzt auch f\u00fcr Dorfl\u00e4den ohne aktivierter Einkaufspreis-Funktion m\u00f6glich. So kann Lagerware, die erneut \u00fcber das System verkauft wird, bequem vorbestellt werden. [I#829](https://github.com/foodcoopshop/foodcoopshop/issues/829) / [PR#830](https://github.com/foodcoopshop/foodcoopshop/pull/830) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Die neue Umsatz- und Gewinnstatistik zeigt jetzt ausschlie\u00dflich Netto-Werte an (Netto-Einkaufpreis, Netto-Gewinn) und zus\u00e4tzulich den Gewinn-Aufschlag in %. [I#840](https://github.com/foodcoopshop/foodcoopshop/issues/840) / [PR#841](https://github.com/foodcoopshop/foodcoopshop/pull/841) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n\n### Bugfixes / Updates / Code cleaning\n- Ab und zu wurde man w\u00e4hrend bzw. nach Abschluss einer Sofort- oder Lagerprodukt-Bestellung ausgeloggt. [I#832](https://github.com/foodcoopshop/foodcoopshop/issues/832) / [PR#831](https://github.com/foodcoopshop/foodcoopshop/pull/831) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Produkt, das von Lieferrhythmus \"Sammelbestellung - mit abgelaufenem Bestellschlusss\" auf \"Lagerprodukt\" umgestellt wurde, war nicht bestellbar. [I#774](https://github.com/foodcoopshop/foodcoopshop/issues/774) / [PR#801](https://github.com/foodcoopshop/foodcoopshop/pull/801) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Beim Stornieren wird die Anzahl nicht mehr erh\u00f6ht, wenn das Produkt die Funktion \"Standard-Anzahl pro Lieferrhythmus\" verwendet. [I#838](https://github.com/foodcoopshop/foodcoopshop/issues/838) / [PR#839](https://github.com/foodcoopshop/foodcoopshop/pull/839) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Manchmal wurden \u00fcber den Editor Base64-codierte Bilder eingef\u00fcgt und gespeichert (z.B. Copy/Paste aus E-Mail-Client) und diese haben dann die Datenbank aufgebl\u00e4ht. Das ist jetzt systemweit unterbunden. [I#804](https://github.com/foodcoopshop/foodcoopshop/issues/804) / [PR#805](https://github.com/foodcoopshop/foodcoopshop/pull/805) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Support f\u00fcr MySQL 8.0 [I#803](https://github.com/foodcoopshop/foodcoopshop/issues/803) / [PR#806](https://github.com/foodcoopshop/foodcoopshop/pull/806) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Bootstrap v5 und Bootstrap Select v1.14 Updates. [I#679](https://github.com/foodcoopshop/foodcoopshop/issues/679) / [PR#828](https://github.com/foodcoopshop/foodcoopshop/pull/828) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- \u00dcberfl\u00fcssige Einstellung app.isDepositPaymentCashless wurde entfernt. [I#827](https://github.com/foodcoopshop/foodcoopshop/issues/827) / [PR#834](https://github.com/foodcoopshop/foodcoopshop/pull/834) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Das Stundenabrechnungs-Modul wurde schon lange nicht mehr verwendet und deswegen entfernt. [I#848](https://github.com/foodcoopshop/foodcoopshop/issues/848) / [PR#849](https://github.com/foodcoopshop/foodcoopshop/pull/849) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Die Software ist jetzt kompatibel mit PHP 8.1. [I#750](https://github.com/foodcoopshop/foodcoopshop/issues/750) / [PR#851](https://github.com/foodcoopshop/foodcoopshop/pull/851) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Doppelte Aufrufe von lang andauerenden Cronjobs sind jetzt nicht mehr m\u00f6glich. Das kam sehr selten vor, aber eben doch. [PR#853](https://github.com/foodcoopshop/foodcoopshop/pull/853) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Neuer CSS-Compressor: CssMin wurde durch CleanCss ersetzt. [PR#856](https://github.com/foodcoopshop/foodcoopshop/pull/856) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n- Fontawesome v6 Update. [PR#855](https://github.com/foodcoopshop/foodcoopshop/pull/855) <a href=\"https://github.com/mrothauer\"><img src=\"https://github.com/mrothauer.png\" width=\"20\"></a>\n\nDatum: 12.09.2022 / [Mehr Details zum Release](https://github.com/foodcoopshop/foodcoopshop/projects/17) / [Alle \u00c4nderungen anzeigen](https://github.com/foodcoopshop/foodcoopshop/compare/v3.4.2...v3.5.0)\n\n[Zum Changelog von FoodCoopShop v3.0-v3.4](devtools/CHANGELOG-v3.md)\n", "3.6.1", "<?php\ndeclare(strict_types=1);\n\nuse App\\Lib\\Error\\Exception\\InvalidParameterException;\nuse App\\Test\\TestCase\\AppCakeTestCase;\nuse Cake\\Core\\Configure;\nuse App\\Test\\TestCase\\Traits\\AppIntegrationTestTrait;\nuse App\\Test\\TestCase\\Traits\\LoginTrait;\n\n/**\n * FoodCoopShop - The open source software for your foodcoop\n *\n * Licensed under the GNU Affero General Public License version 3\n * For full copyright and license information, please see LICENSE\n * Redistributions of files must retain the above copyright notice.\n *\n * @since         FoodCoopShop 1.0.0\n * @license       https://opensource.org/licenses/AGPL-3.0\n * @author        Mario Rothauer <office@foodcoopshop.com>\n * @copyright     Copyright (c) Mario Rothauer, https://www.rothauer-it.com\n * @link          https://www.foodcoopshop.com\n */\nclass ProductsTableTest extends AppCakeTestCase\n{\n\n    use AppIntegrationTestTrait;\n    use LoginTrait;\n\n    public $Product;\n\n    public function setUp(): void\n    {\n        parent::setUp();\n        $this->Product = $this->getTableLocator()->get('Products');\n    }\n\n    public function testChangeImageValidImageAndDeleteImage()\n    {\n\n        // add image\n        $productId = 346;\n        $products = [\n            [$productId => WWW_ROOT . 'img/tests/test-image.jpg']\n        ];\n        $this->Product->changeImage($products);\n\n        $product = $this->Product->find('all', [\n            'conditions' => [\n                'Products.id_product' => $productId\n            ],\n            'contain' => [\n                'Images'\n            ]\n        ])->first();\n        $imageId = $product->image->id_image;\n\n        $imageIdAsPath = Configure::read('app.htmlHelper')->getProductImageIdAsPath($imageId);\n        $thumbsPath = Configure::read('app.htmlHelper')->getProductThumbsPath($imageIdAsPath);\n\n        foreach (Configure::read('app.productImageSizes') as $thumbSize => $options) {\n            $thumbsFileName = $thumbsPath . DS . $imageId . $options['suffix'] . '.' . 'jpg';\n            $this->assertTrue(file_exists($thumbsFileName), 'physical file not added');\n        }\n\n        // delete image\n        $products = [\n            [$productId => 'no-image']\n        ];\n        $this->Product->changeImage($products);\n\n        $product = $this->Product->find('all', [\n            'conditions' => [\n                'Products.id_product' => $productId\n            ],\n            'contain' => [\n                'Images'\n            ]\n        ])->first();\n\n        $this->assertTrue(empty($product->image));\n\n        foreach (Configure::read('app.productImageSizes') as $thumbSize => $options) {\n            $thumbsFileName = $thumbsPath . DS . $imageId . $options['suffix'] . '.' . 'jpg';\n            $this->assertFalse(file_exists($thumbsFileName), 'physical file not deleted');\n        }\n\n    }\n\n    public function testChangeImageInvalidImage()\n    {\n        $file = WWW_ROOT . '/css/global.css';\n        $productId = 346;\n        $products = [\n            [$productId => $file]\n        ];\n\n        try {\n            $this->Product->changeImage($products);\n        } catch (Exception $e) {\n            $this->assertEquals('file is not an image: ' . $file, $e->getMessage());\n        }\n    }\n\n    public function testChangeImageInvalidDomain()\n    {\n        $productId = 346;\n        $products = [\n            [$productId => 'https://localhost:8080/img/tests/test-image.jpg']\n        ];\n\n        try {\n            $this->Product->changeImage($products);\n        } catch (Exception $e) {\n            $this->assertEquals('invalid host', $e->getMessage());\n        }\n    }\n\n    public function testChangeImageNonExistingFile()\n    {\n        $productId = 346;\n        $products = [\n            [$productId => Configure::read('App.fullBaseUrl') . '/img/tests/non-existing-file.jpg']\n        ];\n        $exceptionThrown = false;\n\n        try {\n            $this->Product->changeImage($products);\n        } catch (Exception $e) {\n            $exceptionThrown = true;\n        }\n\n        $this->assertSame(true, $exceptionThrown);\n    }\n\n    public function testGetCompositeProductIdAndAttributeId()\n    {\n        $tests = [\n            [\n                'ids' => [\n                    'productId' => 5,\n                    'attributeId' => 0\n                ],\n                'result' => '5',\n            ],\n            [\n                'ids' => [\n                    'productId' => 8,\n                    'attributeId' => 0\n                ],\n                'result' => 8,\n            ],\n            [\n                'ids' => [\n                    'productId' => 80,\n                    'attributeId' => 9\n                ],\n                'result' => '80-9',\n            ]\n        ];\n\n        foreach ($tests as $test) {\n            $result = $this->Product->getCompositeProductIdAndAttributeId($test['ids']['productId'], $test['ids']['attributeId']);\n            $this->assertEquals($test['result'], $result);\n        }\n    }\n\n    public function testGetProductIdAndAttributeId()\n    {\n        $tests = [\n            [\n                'id' => '5',\n                'result' => [\n                    'productId' => 5,\n                    'attributeId' => 0\n                ]\n            ],\n            [\n                'id' => 8,\n                'result' => [\n                    'productId' => 8,\n                    'attributeId' => 0\n                ]\n            ],\n            [\n                'id' => '80-9',\n                'result' => [\n                    'productId' => 80,\n                    'attributeId' => 9\n                ]\n            ]\n        ];\n\n        foreach ($tests as $test) {\n            $result = $this->Product->getProductIdAndAttributeId($test['id']);\n            $this->assertEquals($test['result'], $result);\n        }\n    }\n\n    public function testAddProduct()\n    {\n        $manufacturerId = $this->Customer->getManufacturerIdByCustomerId(Configure::read('test.vegetableManufacturerId'));\n        $manufacturer = $this->Manufacturer->find('all', [\n            'conditions' => [\n                'Manufacturers.id_manufacturer' => $manufacturerId\n            ]\n        ])->first();\n\n        $name = 'New product <b>test</b>';\n        $descriptionShort = 'description short<img src=\"test.jpg\" />';\n        $description = 'description <img src=\"test.jpg\" />';\n        $unity = '<b>piece</b>';\n        $isDeclarationOk = 0;\n        $idStorageLocation = 1;\n        $barcode = '1234567890123';\n        $newProduct = $this->Product->add($manufacturer, $name, $descriptionShort, $description, $unity, $isDeclarationOk, $idStorageLocation, $barcode);\n\n        $product = $this->Product->find('all', [\n            'conditions' => [\n                'Products.id_product' => $newProduct->id_product\n            ],\n            'contain' => [\n                'CategoryProducts',\n                'StockAvailables',\n                'BarcodeProducts',\n            ]\n        ])->first();\n\n        $this->assertEquals($product->id_product, $newProduct->id_product);\n        $this->assertEquals($product->id_manufacturer, $manufacturerId);\n        $this->assertEquals($product->active, APP_OFF);\n        $this->assertEquals($product->category_products[0]->id_category, Configure::read('app.categoryAllProducts'));\n        $this->assertEquals($product->name, 'New product test');\n        $this->assertEquals($product->description_short, 'description short');\n        $this->assertEquals($product->description, $description);\n        $this->assertEquals($product->unity, 'piece');\n        $this->assertEquals($product->is_declaration_ok, $isDeclarationOk);\n        $this->assertEquals($product->id_tax, $this->Manufacturer->getOptionDefaultTaxId($manufacturer->default_tax_id));\n        $this->assertEquals($product->stock_available->quantity, 0);\n        $this->assertEquals($product->id_storage_location, $idStorageLocation);\n        $this->assertEquals($product->barcode_product->barcode, $barcode);\n    }\n\n    /**\n     * START tests change quantity\n     */\n    public function testChangeQuantityWithOneProductAndInvalidStringQuantity()\n    {\n        $products = [\n            [346 => [\n                'quantity' => 'invalid-quantity'\n            ]]\n        ];\n\n        $exceptionThrown = false;\n\n        try {\n            $this->Product->changeQuantity($products);\n        } catch (InvalidParameterException $e) {\n            $exceptionThrown = true;\n        }\n\n        $this->assertProductQuantity($products, '97');\n        $this->assertSame(true, $exceptionThrown);\n    }\n\n    public function testChangeQuantityWithOneProductAndNegativeQuantity()\n    {\n        $products = [\n            [346 => [\n                'quantity' => -50\n            ]]\n        ];\n        $this->Product->changeQuantity($products);\n        $this->assertProductQuantity($products, -50);\n    }\n\n    public function testChangeQuantityWithOneProduct()\n    {\n        $products = [\n            [102 => [\n                'quantity' => '5'\n            ]]\n        ];\n        $this->Product->changeQuantity($products);\n        $this->assertProductQuantity($products);\n    }\n\n    public function testChangeQuantityWithOneProductAttribute()\n    {\n        $products = [\n            ['60-10' => [\n                'quantity' => '5'\n            ]]\n        ];\n        $this->Product->changeQuantity($products);\n        $this->assertProductQuantity($products);\n    }\n\n    public function testChangeQuantityWithMultipleProductsAndAttributes()\n    {\n        $products = [\n            [102 => [\n                'quantity' => '5'\n            ]],\n            [346 => [\n                'quantity' => '1'\n            ]],\n            ['60-10' => [\n                'quantity' => '90'\n            ]]\n        ];\n        $this->Product->changeQuantity($products);\n        $this->assertProductQuantity($products);\n    }\n\n    /**\n     * START tests change price\n     */\n    public function testChangePriceWithOneProductAndInvalidNegativePrice()\n    {\n\n        $products = [\n            [346 => ['gross_price' => '-1']]\n        ];\n\n        $exceptionThrown = false;\n\n        try {\n            $this->Product->changePrice($products);\n        } catch (InvalidParameterException $e) {\n            $exceptionThrown = true;\n        }\n\n        $this->assertProductPrice($products, '1,82');\n        $this->assertSame(true, $exceptionThrown);\n    }\n\n    public function testChangePriceOneProductAndInvalidStringPrice()\n    {\n        $products = [\n            [346 => ['gross_price' => 'invalid-price']]\n        ];\n\n        $exceptionThrown = false;\n\n        try {\n            $this->Product->changePrice($products);\n        } catch (InvalidParameterException $e) {\n            $exceptionThrown = true;\n        }\n\n        $this->assertProductPrice($products, '1,82');\n        $this->assertSame(true, $exceptionThrown);\n    }\n\n    public function testChangePriceWithOneProduct()\n    {\n        $products = [\n            [102 => ['gross_price' => '5,22']]\n        ];\n        $success = $this->Product->changePrice($products);\n        $this->assertTrue($success);\n        $this->assertProductPrice($products);\n    }\n\n    public function testChangePriceWithOneProductAttribute()\n    {\n        $products = [\n            ['60-10' => ['gross_price' => '3,22']]\n        ];\n        $success = $this->Product->changePrice($products);\n        $this->assertTrue($success);\n        $this->assertProductPrice($products);\n    }\n\n    public function testChangePriceWithMultipleProductsAndAttributes()\n    {\n        $products = [\n            [102 => ['gross_price' => '5,22']],\n            [346 => ['gross_price' => '1,00']],\n            ['60-10' => ['gross_price' => '2,98']]\n        ];\n        $success = $this->Product->changePrice($products);\n        $this->assertTrue($success);\n        $this->assertProductPrice($products);\n    }\n\n    public function testChangePriceWithMultipleProductsAndOneWithInvalidNegativePrice()\n    {\n\n        // 1) change prices to same price to be able to test if the price has not changed\n        $samePrice = '2,55';\n        $products = [\n            [346 => ['gross_price' => $samePrice]],\n            [102 => ['gross_price' => $samePrice]],\n            [103 => ['gross_price' => $samePrice]]\n        ];\n        $success = $this->Product->changePrice($products);\n        $this->assertTrue($success);\n        $this->assertProductPrice($products);\n\n        // try to change prices, but include one invalid price\n        $products = [\n            [346 => ['gross_price' => '-1']], // invalid price\n            [102 => ['gross_price' => '2,58']],\n            [103 => ['gross_price' => '1,01']]\n        ];\n\n        $exceptionThrown = false;\n\n        try {\n            $this->Product->changePrice($products);\n        } catch (InvalidParameterException $e) {\n            $exceptionThrown = true;\n        }\n\n        $this->assertProductPrice($products, $samePrice);\n        $this->assertSame(true, $exceptionThrown);\n    }\n\n    /**\n     * START tests change deposit\n     */\n\n    public function testChangeDepositWithOneProduct()\n    {\n        $products = [\n            [102 => '1,00']\n        ];\n        $this->Product->changeDeposit($products);\n        $this->assertProductDeposit($products);\n    }\n\n    public function testChangeDepositWithOneProductAttribute()\n    {\n        $products = [\n            ['60-10' => '1,00']\n        ];\n        $this->Product->changeDeposit($products);\n        $this->assertProductDeposit($products);\n    }\n\n    public function testChangeDepositWithMultipleProductsAndOneWithInvalidNegativeDeposit()\n    {\n\n        // 1) change deposits to same deposit to be able to test if the price has not changed\n        $sameDeposit = '1,00';\n        $products = [\n            [346 => $sameDeposit],\n            [102 => $sameDeposit],\n            [103 => $sameDeposit]\n        ];\n        $this->Product->changeDeposit($products);\n        $this->assertProductDeposit($products);\n\n        // try to change deposits, but include one invalid deposit\n        $products = [\n            [346 => '-1'], // invalid deposit\n            [102 => '2,00'],\n            [103 => '1,00']\n        ];\n\n        $exceptionThrown = false;\n\n        try {\n            $this->Product->changeDeposit($products);\n        } catch (InvalidParameterException $e) {\n            $exceptionThrown = true;\n        }\n\n        $this->assertProductDeposit($products, $sameDeposit);\n        $this->assertSame(true, $exceptionThrown);\n    }\n\n    /**\n     * START tests change status\n     */\n\n    public function testChangeStatusWithStringStatus()\n    {\n        $products = [\n            [102 => 'invalid parameter']\n        ];\n        $this->expectException(InvalidParameterException::class);\n        $this->expectExceptionMessage('Products.active for product 102 needs to be 0 or 1');\n        $this->Product->changeStatus($products);\n    }\n\n    public function testChangeStatusWithInvalidIntegerStatus()\n    {\n        $products = [\n            [102 => 5] // invalid status\n        ];\n        $this->expectException(InvalidParameterException::class);\n        $this->expectExceptionMessage('Products.active for product 102 needs to be 0 or 1');\n        $this->Product->changeStatus($products);\n    }\n\n    public function testChangeStatusForProductAttribute()\n    {\n        $products = [\n            ['60-10' => 0]\n        ];\n        $this->expectException(InvalidParameterException::class);\n        $this->expectExceptionMessage('change status is not allowed for product attributes');\n        $this->Product->changeStatus($products);\n    }\n\n    public function testChangeStatusDisableWithOneProduct()\n    {\n        $products = [\n            [102 => 0]\n        ];\n        $response = $this->Product->changeStatus($products);\n        $this->assertEquals(true, $response);\n        $this->assertProductStatus($products);\n    }\n\n    public function testChangeStatusEnableWithOneProduct()\n    {\n        $products = [\n            [102 => 1]\n        ];\n        $response = $this->Product->changeStatus($products);\n        $this->assertEquals(true, $response);\n        $this->assertProductStatus($products);\n    }\n\n    public function testChangeStatusWithMultipleProductsAndDifferentStati()\n    {\n        $products = [\n            [102 => 1],\n            [340 => 1],\n            [346 => 0]\n        ];\n        $response = $this->Product->changeStatus($products);\n        $this->assertEquals(true, $response);\n        $this->assertProductStatus($products);\n    }\n\n    public function testChangeStatusWithOneProductAndInvalidStatus()\n    {\n        $products = [\n            [102 => 5] // invalid status\n        ];\n\n        $exceptionThrown = false;\n\n        try {\n            $this->Product->changeStatus($products);\n        } catch (InvalidParameterException $e) {\n            $exceptionThrown = true;\n        }\n\n        $this->assertProductStatus($products, APP_ON);\n        $this->assertSame(true, $exceptionThrown);\n    }\n\n    public function testChangeStatusWithMultipleProductsAndOneWithInvalidStatus()\n    {\n        $products = [\n            [346 => 0],  // pass correct but different to current status\n            [102 => -1], // invalid status\n            [103 => 0]   // pass correct but different to current status\n        ];\n\n        $exceptionThrown = false;\n\n        try {\n            $this->Product->changeStatus($products);\n        } catch (InvalidParameterException $e) {\n            $exceptionThrown = true;\n        }\n\n        $this->assertProductStatus($products, APP_ON);\n        $this->assertSame(true, $exceptionThrown);\n    }\n\n    public function testChangeNameWithOneProductAndInvalidStringName()\n    {\n        $products = [\n            [346 => [\n                'name' => 'a', // at least 2 chars needed\n                'unity' => '',\n                'description' => 'Beschreibung',\n                'description_short' => 'Kurze Beschreibung'\n            ]]\n        ];\n\n        $exceptionThrown = false;\n\n        try {\n            $this->Product->changeName($products);\n        } catch (InvalidParameterException $e) {\n            $exceptionThrown = true;\n        }\n\n        $expectedResult = ['name' => 'Artischocke', 'unity' => 'St\u00fcck', 'description' => '', 'description_short' => ''];\n        $this->assertProductName($products, $expectedResult);\n        $this->assertSame(true, $exceptionThrown);\n    }\n\n    public function testChangeNameForProductAttribute()\n    {\n        $products = [\n            ['60-10' => 0]\n        ];\n        $this->expectException(InvalidParameterException::class);\n        $this->expectExceptionMessage('change name is not allowed for product attributes');\n        $this->Product->changeName($products);\n    }\n\n    public function testChangeNameWithMultipleProducts()\n    {\n        $parameters = [\n            'name' => 'test <b>name</b>', // no tags allowed\n            'unity' => ' test unity ',    // trim and no tags allowed\n            'description' => '    <p>test <br /><strong><em>description</em></strong><img src=\"/test.jpg\" /><img src=\"data:image/png;base64,iVBORw0KGgoAAAANSUCYII=\" /></p>',\n            'description_short' => '<p>test description<br /> <em>short</em></p>    ',\n            'id_storage_location' => 2,\n            'barcode' => '1234567890123',\n        ];\n\n        $products = [\n            [102 => $parameters],\n            [346 => $parameters]\n        ];\n        $this->Product->changeName($products);\n\n        $expectedResults = [\n            'name' => 'test name',\n            'unity' => 'test unity',\n            'description' => '<p>test <br /><strong><em>description</em></strong><img src=\"/test.jpg\" /><img src=\"invalid-image\" /></p>',\n            'description_short' => '<p>test description<br /> <em>short</em></p>',\n            'id_storage_location' => 2,\n            'barcode' => '1234567890123',\n        ];\n        $this->assertProductName($products, $expectedResults);\n    }\n\n    private function assertProductName($products, $expectedResults)\n    {\n        foreach ($products as $product) {\n\n            $productId = key($product);\n            $changedProduct = $this->Product->find('all', [\n                'conditions' => [\n                    'Products.id_product' => $productId,\n                ],\n                'contain' => [\n                    'BarcodeProducts',\n                ]\n            ])->first();\n            $this->assertEquals($expectedResults['name'], $changedProduct->name);\n            $this->assertEquals($expectedResults['unity'], $changedProduct->unity);\n            $this->assertEquals($expectedResults['description'], $changedProduct->description);\n            $this->assertEquals($expectedResults['description_short'], $changedProduct->description_short);\n\n            if (isset($expectedResults['id_storage_location'])) {\n                $this->assertEquals($expectedResults['id_storage_location'], $changedProduct->id_storage_location);\n            }\n\n            if (isset($expectedResults['barcode'])) {\n                $this->assertEquals($expectedResults['barcode'], $changedProduct->barcode_product->barcode);\n            }\n\n        }\n    }\n\n    private function assertProductQuantity($products, $forceUseThisQuantity = null)\n    {\n        foreach ($products as $product) {\n            $originalProductId = key($product);\n            $productAndAttributeId = $this->Product->getProductIdAndAttributeId($originalProductId);\n            $productId = $productAndAttributeId['productId'];\n            $expectedQuantity = $product[$originalProductId]['quantity'];\n            if ($forceUseThisQuantity) {\n                $expectedQuantity = $forceUseThisQuantity;\n            }\n            if ($productAndAttributeId['attributeId'] == 0) {\n                $contain = ['StockAvailables'];\n            } else {\n                $this->Product->getAssociation('ProductAttributes')->setConditions(\n                    ['ProductAttributes.id_product_attribute' => $productAndAttributeId['attributeId']]\n                );\n                $contain = ['ProductAttributes.StockAvailables'];\n            }\n            $changedProduct = $this->Product->find('all', [\n                'conditions' => [\n                    'Products.id_product' => $productId\n                ],\n                'contain' => $contain\n            ])->first();\n            if ($productAndAttributeId['attributeId'] == 0) {\n                $result = $changedProduct->stock_available->quantity;\n            } else {\n                $result = $changedProduct->product_attributes[0]->stock_available->quantity;\n            }\n            $this->assertEquals($expectedQuantity, $result, 'changing the quantity flag did not work');\n        }\n    }\n\n    private function assertProductDeposit($products, $forceUseThisDeposit = null)\n    {\n        foreach ($products as $product) {\n            $originalProductId = key($product);\n            $productAndAttributeId = $this->Product->getProductIdAndAttributeId($originalProductId);\n            $productId = $productAndAttributeId['productId'];\n            $expectedDeposit = $product[$originalProductId];\n            if ($forceUseThisDeposit) {\n                $expectedDeposit = $forceUseThisDeposit;\n            }\n            $expectedDeposit = Configure::read('app.numberHelper')->parseFloatRespectingLocale($expectedDeposit);\n            if ($productAndAttributeId['attributeId'] == 0) {\n                $contain = ['DepositProducts'];\n            } else {\n                $contain = ['ProductAttributes', 'ProductAttributes.DepositProductAttributes'];\n                $this->Product->getAssociation('ProductAttributes')->setConditions(\n                    ['ProductAttributes.id_product_attribute' => $productAndAttributeId['attributeId']]\n                );\n            }\n\n            $changedProduct = $this->Product->find('all', [\n                'conditions' => [\n                    'Products.id_product' => $productId\n                ],\n                'contain' => $contain,\n            ])->first();\n\n            if ($productAndAttributeId['attributeId'] == 0) {\n                $resultEntity = $changedProduct->deposit_product;\n                ;\n            } else {\n                $resultEntity = $changedProduct->product_attributes[0]->deposit_product_attribute;\n            }\n            $this->assertEquals($expectedDeposit, $resultEntity->deposit, 'changing the deposit did not work');\n        }\n    }\n\n    private function assertProductPrice($products, $forceUseThisPrice = null)\n    {\n        foreach ($products as $product) {\n            $originalProductId = key($product);\n            $productAndAttributeId = $this->Product->getProductIdAndAttributeId($originalProductId);\n            $productId = $productAndAttributeId['productId'];\n            $expectedPrice = $product[$originalProductId]['gross_price'];\n            if ($forceUseThisPrice) {\n                $expectedPrice = $forceUseThisPrice;\n            }\n            $contain = ['Taxes'];\n            $expectedPrice = Configure::read('app.numberHelper')->parseFloatRespectingLocale($expectedPrice);\n            if ($productAndAttributeId['attributeId'] > 0) {\n                $this->Product->getAssociation('ProductAttributes')->setConditions(\n                    ['ProductAttributes.id_product_attribute' => $productAndAttributeId['attributeId']]\n                );\n                $contain[] = 'ProductAttributes';\n            }\n            $changedProduct = $this->Product->find('all', [\n                'conditions' => [\n                    'Products.id_product' => $productId\n                ],\n                'contain' => $contain,\n            ])->first();\n            if ($productAndAttributeId['attributeId'] == 0) {\n                $resultEntity = $changedProduct;\n            } else {\n                $resultEntity = $changedProduct->product_attributes[0];\n            }\n            $taxRate = $changedProduct->tax->rate ?? 0;\n            $this->assertEquals($expectedPrice, $this->Product->getGrossPrice($resultEntity->price, $taxRate));\n        }\n    }\n\n    private function assertProductStatus($products, $forceUseThisStatus = null)\n    {\n        foreach ($products as $product) {\n            $productId = key($product);\n            $expectedStatus = $product[$productId];\n            if ($forceUseThisStatus) {\n                $expectedStatus = $forceUseThisStatus;\n            }\n            $changedProduct = $this->Product->find('all', [\n                'conditions' => [\n                    'Products.id_product' => $productId,\n                ]\n            ])->first();\n            $this->assertEquals($expectedStatus, $changedProduct->active, 'changing the active flag did not work');\n        }\n    }\n}\n", "<?php\ndeclare(strict_types=1);\n\n/**\n * FoodCoopShop - The open source software for your foodcoop\n *\n * Licensed under the GNU Affero General Public License version 3\n * For full copyright and license information, please see LICENSE\n * Redistributions of files must retain the above copyright notice.\n *\n * @since         FoodCoopShop 3.2.0\n * @license       https://opensource.org/licenses/AGPL-3.0\n * @author        Mario Rothauer <office@foodcoopshop.com>\n * @copyright     Copyright (c) Mario Rothauer, https://www.rothauer-it.com\n * @link          https://www.foodcoopshop.com\n */\nnamespace App\\Lib\\RemoteFile;\n\nclass RemoteFile\n{\n    public static function exists(string $remoteFile, $allowedHosts = []): bool\n    {\n\n        self::verifyAllowedHosts($allowedHosts, $remoteFile);\n\n        $ch = curl_init($remoteFile);\n        curl_setopt($ch, CURLOPT_NOBODY, true);\n        curl_exec($ch);\n        $responseCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);\n        curl_close($ch);\n\n        if ($responseCode == 200){\n            return true;\n        }\n\n        return false;\n\n    }\n\n    private static function verifyAllowedHosts($allowedHosts, $remoteFile)\n    {\n        if (empty($allowedHosts)) {\n            throw new \\Exception('allowedHosts must be set');\n        } else {\n            $host = parse_url($remoteFile, PHP_URL_HOST);\n            if (!in_array($host, $allowedHosts)) {\n                throw new \\Exception('invalid host');\n             }\n        }\n    }\n\n}\n", "<?php\ndeclare(strict_types=1);\n\nnamespace App\\Model\\Table;\n\nuse Cake\\Log\\Log;\nuse Cake\\Utility\\Hash;\nuse Cake\\Core\\Configure;\nuse App\\Lib\\Folder\\Folder;\nuse App\\Lib\\Catalog\\Catalog;\nuse Cake\\Validation\\Validator;\nuse App\\Lib\\RemoteFile\\RemoteFile;\nuse Cake\\Datasource\\FactoryLocator;\nuse App\\Lib\\DeliveryRhythm\\DeliveryRhythm;\nuse App\\Controller\\Component\\StringComponent;\nuse App\\Lib\\Error\\Exception\\InvalidParameterException;\nuse App\\Model\\Traits\\ProductCacheClearAfterSaveAndDeleteTrait;\n\n/**\n * FoodCoopShop - The open source software for your foodcoop\n *\n * Licensed under the GNU Affero General Public License version 3\n * For full copyright and license information, please see LICENSE\n * Redistributions of files must retain the above copyright notice.\n *\n * @since         FoodCoopShop 1.0.0\n * @license       https://opensource.org/licenses/AGPL-3.0\n * @author        Mario Rothauer <office@foodcoopshop.com>\n * @copyright     Copyright (c) Mario Rothauer, https://www.rothauer-it.com\n * @link          https://www.foodcoopshop.com\n */\nclass ProductsTable extends AppTable\n{\n\n    use ProductCacheClearAfterSaveAndDeleteTrait;\n\n    public const ALLOWED_TAGS_DESCRIPTION_SHORT = '<p><b><strong><i><em><br>';\n    public const ALLOWED_TAGS_DESCRIPTION       = '<p><b><strong><i><em><br><img>';\n\n    private $Catalog;\n    private $Configuration;\n    private $Manufacturer;\n    private $Unit;\n\n    public function initialize(array $config): void\n    {\n        $this->setTable('product');\n        parent::initialize($config);\n        $this->setPrimaryKey('id_product');\n        $this->belongsTo('Manufacturers', [\n            'foreignKey' => 'id_manufacturer'\n        ]);\n        $this->belongsTo('StockAvailables', [\n            'foreignKey' => 'id_product'\n        ]);\n        $this->belongsTo('PurchasePriceProducts', [\n            'foreignKey' => 'id_product',\n            'conditions' => [\n                'PurchasePriceProducts.product_attribute_id = 0',\n            ],\n        ]);\n        $this->belongsTo('BarcodeProducts', [\n            'foreignKey' => 'id_product',\n            'conditions' => [\n                'BarcodeProducts.product_attribute_id = 0',\n            ],\n        ]);\n        $this->belongsTo('Taxes', [\n            'foreignKey' => 'id_tax'\n        ]);\n        $this->hasOne('DepositProducts', [\n            'foreignKey' => 'id_product'\n        ]);\n        $this->hasOne('Images', [\n            'foreignKey' => 'id_product',\n            'order' => [\n                'Images.id_image' => 'DESC'\n            ]\n        ]);\n        $this->hasOne('ProductAttribute', [\n            'foreignKey' => 'id_product'\n        ]);\n        $this->hasMany('ProductAttributes', [\n            'foreignKey' => 'id_product'\n        ]);\n        $this->hasMany('CategoryProducts', [\n            'foreignKey' => 'id_product'\n        ]);\n        $this->hasOne('UnitProducts', [\n            'foreignKey' => 'id_product'\n        ]);\n        $this->belongsTo('StorageLocations', [\n            'foreignKey' => 'id_storage_location',\n        ]);\n        $this->addBehavior('Timestamp');\n    }\n\n    public function __construct(array $config = [])\n    {\n        parent::__construct($config);\n        $this->Configuration = FactoryLocator::get('Table')->get('Configurations');\n    }\n\n    public function validationName(Validator $validator)\n    {\n        $validator->notEmptyString('name', __('Please_enter_a_name.'));\n        $validator->minLength('name', 2, __('The_name_of_the_product_needs_to_be_at_least_{0}_characters_long.', [2]));\n        return $validator;\n    }\n\n    public function validationDeliveryRhythm(Validator $validator)\n    {\n        $validator->add('delivery_rhythm_type', 'allowed-count-values', [\n            'rule' => function ($value, $context) {\n                if ($value == 'week') {\n                    return in_array($context['data']['delivery_rhythm_count'], [1,2,4]);\n                }\n                if ($value == 'month') {\n                    return in_array($context['data']['delivery_rhythm_count'], [0,1,2,3,4]);\n                }\n                if ($value == 'individual') {\n                    return in_array($context['data']['delivery_rhythm_count'], [0]);\n                }\n                return false;\n            },\n            'message' => __('The_delivery_ryhthm_is_not_valid.')\n        ]);\n        $validator->allowEmptyString('delivery_rhythm_first_delivery_day');\n        $validator->notEquals('delivery_rhythm_first_delivery_day', '1970-01-01', __('The_first_delivery_day_is_not_valid.'));\n        $validator->allowEmptyString('delivery_rhythm_order_possible_until');\n        $validator->notEquals('delivery_rhythm_order_possible_until', '1970-01-01', __('The_order_possible_until_field_is_not_valid.'));\n        $validator->add('delivery_rhythm_order_possible_until', 'allowed-only-smaller-than-first-delivery-day', [\n            'rule' => function ($value, $context) {\n                if ($context['data']['delivery_rhythm_type'] == 'individual') {\n                    return $context['data']['delivery_rhythm_first_delivery_day'] > $value;\n                }\n                return true;\n            },\n            'message' => __('The_order_possible_until_field_needs_to_be_smaller_than_the_delivery_date.')\n        ]);\n        $validator = $this->getCorrectDayOfMonthValidator($validator, 'delivery_rhythm_first_delivery_day');\n        $validator = $this->getCorrectDayOfMonthValidator($validator, 'delivery_rhythm_first_delivery_day');\n        $validator = $this->getAllowOnlyOneWeekdayValidator($validator, 'delivery_rhythm_first_delivery_day', __('The_first_delivery_day'));\n        $validator->range('delivery_rhythm_send_order_list_weekday', [0, 6], __('Please_enter_a_number_between_{0}_and_{1}.', [0, 6]));\n        $validator->allowEmptyString('delivery_rhythm_send_order_list_day');\n        $validator->notEquals('delivery_rhythm_send_order_list_day', '1970-01-01', __('The_send_order_list_day_field_is_not_valid.'));\n        $validator->add('delivery_rhythm_send_order_list_day', 'allowed-only-between-two-dates', [\n            'rule' => function ($value, $context) {\n                if ($context['data']['delivery_rhythm_type'] == 'individual') {\n                    return $context['data']['delivery_rhythm_first_delivery_day'] > $value && $context['data']['delivery_rhythm_order_possible_until'] < $value;\n                }\n                return true;\n            },\n            'message' => __('The_send_order_list_day_field_needs_to_be_between_order_possible_until_date_and_first_delivery_day.')\n        ]);\n\n        return $validator;\n    }\n\n    private function getCorrectDayOfMonthValidator(Validator $validator, $field)\n    {\n        $validator->add($field, 'allow-only-correct-weekday-of-month', [\n\n            'rule' => function ($value, $context) {\n\n                if ($context['data']['delivery_rhythm_type'] == 'month') {\n\n                    switch($context['data']['delivery_rhythm_count']) {\n                        case '1':\n                            $ordinal = 'first';\n                            $ordinalForWeekday = __('first_for_weekday');\n                            break;\n                        case '2':\n                            $ordinal = 'second';\n                            $ordinalForWeekday = __('second_for_weekday');\n                            break;\n                        case '3':\n                            $ordinal = 'third';\n                            $ordinalForWeekday = __('third_for_weekday');\n                            break;\n                        case '4':\n                            $ordinal = 'fourth';\n                            $ordinalForWeekday = __('fourth_for_weekday');\n                            break;\n                        case '0':\n                            $ordinal = 'last';\n                            $ordinalForWeekday = __('last_for_weekday');\n                            break;\n                    }\n\n                    $deliveryDayAsWeekdayInEnglish = strtolower(date('l', strtotime($context['data']['delivery_rhythm_first_delivery_day'])));\n                    $calculatedPickupDay = date(Configure::read('app.timeHelper')->getI18Format('DatabaseAlt'), strtotime($context['data']['delivery_rhythm_first_delivery_day'] . ' ' . $ordinal . ' ' . $deliveryDayAsWeekdayInEnglish . ' of this month'));\n\n                    $deliveryWeekdayName = Configure::read('app.timeHelper')->getWeekdayName(DeliveryRhythm::getDeliveryWeekday());\n                    $message = __('The_first_delivery_day_needs_to_be_a_{0}_{1}_of_the_month.', [\n                        $ordinalForWeekday,\n                        $deliveryWeekdayName,\n                    ]);\n\n                    if ($calculatedPickupDay != $value) {\n                        return $message;\n                    }\n\n                }\n\n                return true;\n\n            }\n\n        ]);\n        return $validator;\n    }\n\n    private function deliveryBreakEnabledBase(string|null $noDeliveryDaysAsString, string $deliveryDate): bool\n    {\n        return $noDeliveryDaysAsString != '' && preg_match('`' . $deliveryDate . '`', $noDeliveryDaysAsString);\n    }\n\n    public function deliveryBreakGlobalEnabled(string|null $noDeliveryDaysAsString, string $deliveryDate): bool\n    {\n        return $this->deliveryBreakEnabledBase($noDeliveryDaysAsString, $deliveryDate);\n    }\n\n    /**\n     * manufacturer based delivery break is never applied for stock products\n     */\n    public function deliveryBreakManufacturerEnabled(\n        string|null $noDeliveryDaysAsString,\n        string $deliveryDate,\n        bool|int $stockManagementEnabled,\n        bool|int $isStockProduct): bool\n    {\n        if ($stockManagementEnabled && $isStockProduct) {\n            return false;\n        }\n        return $this->deliveryBreakEnabledBase($noDeliveryDaysAsString, $deliveryDate);\n    }\n\n    /**\n     * @param int $productId\n     * @param int $manufacturerId\n     * @return boolean success\n     */\n    public function isOwner($productId, $manufacturerId)\n    {\n        $found = $this->find('all', [\n            'conditions' => [\n                'Products.id_product' => $productId,\n                'Products.id_manufacturer' => $manufacturerId\n            ]\n        ])->count();\n        return (bool) $found;\n    }\n\n    /**\n     * @param string|int $productId (eg. 4 or '4-10' or '4')\n     */\n    public function getProductIdAndAttributeId($productId): array\n    {\n        $attributeId = 0;\n        $explodedProductId = explode('-', (string) $productId);\n        if (count($explodedProductId) == 2) {\n            $productId = $explodedProductId[0];\n            $attributeId = $explodedProductId[1];\n        }\n        return [\n            'productId' => (int) $productId,\n            'attributeId' => (int) $attributeId,\n        ];\n    }\n\n    public function getCompositeProductIdAndAttributeId($productId, $attributeId = 0)\n    {\n        $compositeId = $productId;\n        if ($attributeId > 0) {\n            $compositeId .= '-'.$attributeId;\n        }\n        return $compositeId;\n    }\n\n    /**\n     * @param array $products\n     * Array\n     *   (\n     *       [0] => Array\n     *           (\n     *               [productId] => (int) status\n     *           )\n     *   )\n     * @throws InvalidParameterException\n     * @return boolean $success\n     */\n    public function changeStatus($products)\n    {\n\n        $products2save = [];\n\n        foreach ($products as $product) {\n            $productId = key($product);\n            $ids = $this->getProductIdAndAttributeId($productId);\n            if ($ids['attributeId'] > 0) {\n                throw new InvalidParameterException('change status is not allowed for product attributes');\n            }\n            $status = $product[$ids['productId']];\n            $allowed = [APP_OFF, APP_ON];\n            if (!in_array($status, $allowed, true)) { // last param for type check\n                throw new InvalidParameterException('Products.active for product ' .$ids['productId'] . ' needs to be ' .APP_OFF . ' or ' . APP_ON.'; was: ' . $status);\n            } else {\n                $products2save[] = [\n                    'id_product' => $ids['productId'],\n                    'active' => $status\n                ];\n            }\n        }\n\n        $success = false;\n        if (!empty($products2save)) {\n            $entities = $this->newEntities($products2save);\n            $result = $this->saveMany($entities);\n            $success = !empty($result);\n        }\n\n        return $success;\n    }\n\n    /**\n     * @param string $quantity\n     * @return boolean / int\n     */\n    public function getQuantityAsInteger($quantity)\n    {\n        $quantity = trim($quantity);\n\n        if (!is_numeric($quantity)) {\n            return -1; // do not return false, because 0 is a valid return value!\n        }\n        $quantity = (int) ($quantity);\n\n        return $quantity;\n    }\n\n    /**\n     * @param array $products\n     *  Array\n     *  (\n     *      [0] => Array\n     *          (\n     *              [productId] => (float) deposit\n     *          )\n     *  )\n     * @return boolean $success\n     */\n    public function changeDeposit($products)\n    {\n\n        foreach ($products as $product) {\n            $productId = key($product);\n            $deposit = $product[$productId];\n            if (is_string($deposit)) {\n                $deposit = Configure::read('app.numberHelper')->getStringAsFloat($product[$productId]);\n            }\n            if ($deposit < 0) {\n                throw new InvalidParameterException('input format not correct: '.$product[$productId]);\n            }\n        }\n\n        $success = false;\n        foreach ($products as $product) {\n\n            $productId = key($product);\n\n            $deposit = $product[$productId];\n            if (is_string($deposit)) {\n                $deposit = Configure::read('app.numberHelper')->getStringAsFloat($product[$productId]);\n            }\n\n            $ids = $this->getProductIdAndAttributeId($productId);\n\n            if ($ids['attributeId'] > 0) {\n                $oldDeposit = $this->DepositProducts->find('all', [\n                    'conditions' => [\n                        'id_product_attribute' => $ids['attributeId']\n                    ]\n                ])->first();\n\n                if (empty($oldDeposit)) {\n                    $entity = $this->DepositProducts->newEntity([]);\n                } else {\n                    $this->DepositProducts->setPrimaryKey('id_product_attribute');\n                    $entity = $this->DepositProducts->get($oldDeposit->id_product_attribute);\n                }\n\n                $deposit2save = [\n                    'id_product_attribute' => $ids['attributeId'],\n                    'deposit' => $deposit\n                ];\n            } else {\n                // deposit is set for productId\n                $oldDeposit = $this->DepositProducts->find('all', [\n                    'conditions' => [\n                        'id_product' => $productId\n                    ]\n                ])->first();\n\n                if (empty($oldDeposit)) {\n                    $entity = $this->DepositProducts->newEntity([]);\n                } else {\n                    $entity = $this->DepositProducts->get($oldDeposit->id_product);\n                }\n\n                $deposit2save = [\n                    'id_product' => $productId,\n                    'deposit' => $deposit\n                ];\n            }\n\n            $this->DepositProducts->setPrimaryKey('id');\n            $result = $this->DepositProducts->save(\n                $this->DepositProducts->patchEntity($entity, $deposit2save)\n            );\n            $this->DepositProducts->setPrimaryKey('id_product');\n            $success |= is_object($result);\n        }\n\n        return $success;\n    }\n\n    /**\n     * @param array $products\n     *  Array\n     *  (\n     *      [0] => Array\n     *          (\n     *              [\n     *                  productId] => [\n     *                      'gross_price' => (float) price\n     *                      'product unit fields'\n     *                  ]\n     *          )\n     *  )\n     * @return boolean $success\n     */\n    public function changePrice($products)\n    {\n\n        foreach ($products as $product) {\n            $productId = key($product);\n            $price = $product[$productId]['gross_price'];\n            if (is_string($price)) {\n                $price = Configure::read('app.numberHelper')->getStringAsFloat($product[$productId]['gross_price']);\n            }\n            if ($price < 0) {\n                throw new InvalidParameterException('input format not correct: '.$product[$productId]['gross_price']);\n            }\n        }\n\n        $success = false;\n        foreach ($products as $product) {\n\n            $productId = key($product);\n            $price = $product[$productId]['gross_price'];\n            if (is_string($price)) {\n                $price = Configure::read('app.numberHelper')->getStringAsFloat($price);\n            }\n\n            $ids = $this->getProductIdAndAttributeId($productId);\n            $productEntity = $this->find('all', [\n                'conditions' => [\n                    'Products.id_product' => $ids['productId'],\n                ],\n                'contain' => [\n                    'Taxes',\n                ]\n            ])->first();\n            $taxRate = $productEntity->tax->rate ?? 0;\n\n            $netPrice = $this->getNetPrice($price, $taxRate);\n\n            if ($ids['attributeId'] > 0) {\n                // update attribute - updateAll needed for multi conditions of update\n                $result = $this->ProductAttributes->updateAll([\n                    'price' => $netPrice\n                ], [\n                    'id_product_attribute' => $ids['attributeId']\n                ]);\n                // if results are not the returned row count would be 0, so always set to true;\n                $success |= true;\n            } else {\n                $product2update = [\n                    'price' => $netPrice\n                ];\n                $entity = $this->get($ids['productId']);\n                $result = $this->save(\n                    $this->patchEntity($entity, $product2update)\n                );\n                $success |= is_object($result);\n            }\n\n            if (isset($product[$productId]['unit_product_price_per_unit_enabled']) && isset($product[$productId]['unit_product_price_incl_per_unit'])) {\n\n                $this->Unit = FactoryLocator::get('Table')->get('Units');\n\n                $priceInclPerUnit = $product[$productId]['unit_product_price_incl_per_unit'];\n                if (is_string($priceInclPerUnit)) {\n                    $priceInclPerUnit = Configure::read('app.numberHelper')->getStringAsFloat($priceInclPerUnit);\n                }\n                $quantityInUnits = $product[$productId]['unit_product_quantity_in_units'];\n                if (is_string($quantityInUnits)) {\n                    $quantityInUnits = Configure::read('app.numberHelper')->getStringAsFloat($quantityInUnits);\n                }\n\n                $this->Unit->saveUnits(\n                    $ids['productId'],\n                    $ids['attributeId'],\n                    $product[$productId]['unit_product_price_per_unit_enabled'],\n                    $priceInclPerUnit == -1 ? 0 : $priceInclPerUnit,\n                    $product[$productId]['unit_product_name'],\n                    $product[$productId]['unit_product_amount'],\n                    $quantityInUnits == -1 ? 0 : $quantityInUnits\n                );\n            }\n        }\n\n        return (bool) $success;\n        \n    }\n\n    /**\n     * @param array $products\n     *  Array\n     *  (\n     *      [0] => Array\n     *          (\n     *              [productId] => [\n     *                  'quantity' => (int) quantity\n     *              ]\n     *          )\n     *  )\n     */\n    public function changeQuantity($products)\n    {\n\n        foreach ($products as $product) {\n            $productId = key($product);\n            $ids = $this->getProductIdAndAttributeId($productId);\n            $entity = $this->StockAvailables->newEntity($product[$productId]);\n            if ($entity->hasErrors()) {\n                throw new InvalidParameterException(join(' ', $this->StockAvailables->getAllValidationErrors($entity)));\n            }\n        }\n\n        foreach ($products as $product) {\n            $productId = key($product);\n            $ids = $this->getProductIdAndAttributeId($productId);\n            if ($ids['attributeId'] > 0) {\n                $entity = $this->StockAvailables->find('all', [\n                    'conditions' => [\n                        'id_product_attribute' => $ids['attributeId'],\n                        'id_product' => $ids['productId']\n                    ],\n                ])->first();\n                if (is_null($entity)) {\n                    Log::error('entity was empty: productId: ' . $ids['productId'] . ' / attributeId: ' . $ids['attributeId']);\n                    continue;\n                }\n                $originalPrimaryKey = $this->StockAvailables->getPrimaryKey();\n                $this->StockAvailables->setPrimaryKey('id_product_attribute');\n                $this->StockAvailables->save(\n                    $this->StockAvailables->patchEntity($entity, $product[$productId])\n                );\n                $this->StockAvailables->setPrimaryKey($originalPrimaryKey);\n                $this->StockAvailables->updateQuantityForMainProduct($ids['productId']);\n            } else {\n                $entity = $this->StockAvailables->get($ids['productId']);\n                $this->StockAvailables->save(\n                    $this->StockAvailables->patchEntity($entity, $product[$productId])\n                );\n            }\n        }\n    }\n\n    /**\n     * @param array $products\n     *  Array\n     *  (\n     *      [0] => Array\n     *          (\n     *              [productId] => (int) delivery_rhythm\n     *          )\n     *  )\n     * @return boolean $success\n     */\n    public function changeDeliveryRhythm($products)\n    {\n\n        $products2save = [];\n\n        foreach ($products as $product) {\n            $productId = key($product);\n            $ids = $this->getProductIdAndAttributeId($productId);\n            if ($ids['attributeId'] > 0) {\n                throw new InvalidParameterException('change delivery_rhythm is not allowed for product attributes');\n            }\n            $entity = $this->newEntity(\n                $product[$productId],\n                [\n                    'validate' => 'deliveryRhythm'\n                ]\n            );\n            if ($entity->hasErrors()) {\n                throw new InvalidParameterException(join(' ', $this->getAllValidationErrors($entity)));\n            } else {\n                $products2save[] = array_merge(\n                    ['id_product' => $ids['productId']], $product[$productId]\n                );\n            }\n        }\n\n        $success = false;\n        if (!empty($products2save)) {\n            $entities = $this->newEntities($products2save);\n            $result = $this->saveMany($entities);\n            $success = !empty($result);\n        }\n\n        return $success;\n    }\n\n    /**\n     * @param array $products\n     *  Array\n     *  (\n     *      [0] => Array\n     *          (\n     *              [productId] => (int) is_stock_product\n     *          )\n     *  )\n     * @return boolean $success\n     */\n    public function changeIsStockProduct($products)\n    {\n\n        $products2save = [];\n        foreach ($products as $product) {\n            $productId = key($product);\n            $ids = $this->getProductIdAndAttributeId($productId);\n            if ($ids['attributeId'] > 0) {\n                throw new InvalidParameterException('change is_stock_product is not allowed for product attributes');\n            }\n            $isStockProduct = (int) $product[$ids['productId']];\n            $allowed = [APP_OFF, APP_ON];\n            if (!in_array($isStockProduct, $allowed, true)) { // last param for type check\n                throw new InvalidParameterException('Products.is_stock_product for product ' .$ids['productId'] . ' needs to be ' .APP_OFF . ' or ' . APP_ON.'; was: ' . $isStockProduct);\n            } else {\n                $products2save[] = [\n                    'id_product' => $ids['productId'],\n                    'is_stock_product' => $isStockProduct\n                ];\n            }\n        }\n\n        $success = false;\n        if (!empty($products2save)) {\n            $entities = $this->newEntities($products2save);\n            $result = $this->saveMany($entities);\n            $success = !empty($result);\n        }\n\n        return $success;\n\n    }\n\n    /**\n     * @param array $products\n     *  Array\n     *  (\n     *      [0] => Array\n     *          (\n     *              [productId] => Array\n     *                  (\n     *                      [name] => Brokkoli-1\n     *                      [description] => gr\u00fcnes Gem\u00fcse: Strunk mit R\u00f6schen auch angeschwollenen Knospen-1\n     *                      [description_short] => kbA, vom Gem\u00fcsehof Wild-Obermayr-1\n     *                      [unity] => ca. 0,4 kg-1\n     *                      [is_declaration_ok] => 1\n     *                      [id_storage_location] => 1\n     *                      [barcode] => '1234567890123'\n     *                  )\n     *          )\n     *  )\n     * @return boolean $success\n     */\n    public function changeName($products)\n    {\n\n        $products2save = [];\n\n        foreach ($products as $product) {\n            $productId = key($product);\n            $name = $product[$productId];\n            $ids = $this->getProductIdAndAttributeId($productId);\n            if ($ids['attributeId'] > 0) {\n                throw new InvalidParameterException('change name is not allowed for product attributes');\n            }\n            $newName = StringComponent::removeSpecialChars(strip_tags(trim($name['name'])));\n\n            $productEntity = $this->newEntity(\n                [\n                    'name' => $newName,\n                ],\n                [\n                    'validate' => 'name',\n                ]\n            );\n            if ($productEntity->hasErrors()) {\n                throw new InvalidParameterException(join(' ', $this->getAllValidationErrors($productEntity)));\n            }\n\n            if (isset($name['barcode'])) {\n                $barcode = StringComponent::removeSpecialChars(strip_tags(trim($name['barcode'])));\n                $barcodeProductEntity = $this->BarcodeProducts->newEntity(\n                    [\n                        'barcode' => $barcode,\n                    ],\n                    [\n                        'validate' => true\n                    ]\n                );\n                if ($barcodeProductEntity->hasErrors()) {\n                    throw new InvalidParameterException(join(' ', $this->getAllValidationErrors($barcodeProductEntity)));\n                }\n            }\n\n            $tmpProduct2Save = [\n                'id_product' => $ids['productId'],\n                'name' => StringComponent::removeSpecialChars(strip_tags(trim($name['name']))),\n                'description_short' => StringComponent::prepareWysiwygEditorHtml($name['description_short'], self::ALLOWED_TAGS_DESCRIPTION_SHORT),\n                'description' => StringComponent::prepareWysiwygEditorHtml($name['description'], self::ALLOWED_TAGS_DESCRIPTION),\n                'unity' => StringComponent::removeSpecialChars(strip_tags(trim($name['unity']))),\n            ];\n            if (isset($name['is_declaration_ok'])) {\n                $tmpProduct2Save['is_declaration_ok'] = $name['is_declaration_ok'];\n            }\n            if (isset($name['id_storage_location']) && $name['id_storage_location'] > 0) {\n                $tmpProduct2Save['id_storage_location'] = $name['id_storage_location'];\n            }\n\n            if (isset($name['barcode'])) {\n                $tmpProduct2Save['barcode_product'] = [\n                    'product_id' => $ids['productId'],\n                    'barcode' => $barcode,\n                ];\n            }\n            $products2save[] = $tmpProduct2Save;\n\n        }\n\n        $success = false;\n\n        if (!empty($products2save)) {\n            $entities = $this->newEntities($products2save, [\n                'associated' => [\n                    'BarcodeProducts',\n                ],\n            ]);\n            $result = $this->saveMany($entities);\n            $success = !empty($result);\n        }\n\n        return $success;\n    }\n\n    public function isNew($date)\n    {\n        $showAsNewExpirationDate = date('Y-m-d', strtotime($date . ' + ' . Configure::read('appDb.FCS_DAYS_SHOW_PRODUCT_AS_NEW') . ' days'));\n        if (strtotime($showAsNewExpirationDate) > strtotime(date('Y-m-d'))) {\n            return true;\n        }\n        return false;\n    }\n\n    public function getProductsForBackend($appAuth, $productIds, $manufacturerId, $active, $categoryId = '', $isQuantityMinFilterSet = false, $isPriceZero = false, $addProductNameToAttributes = false, $controller = null)\n    {\n\n        $conditions = [];\n        if ($manufacturerId != 'all') {\n            $conditions['Products.id_manufacturer'] = $manufacturerId;\n        } else {\n            // do not show any non-associated products that might be found in database\n            $conditions[] = 'Products.id_manufacturer > 0';\n        }\n\n        if ($productIds != '') {\n            $conditions['Products.id_product IN'] = $productIds;\n        }\n\n        if ($active != 'all') {\n            $conditions['Products.active'] = $active;\n        } else {\n            $conditions['Products.active >'] = APP_DEL;\n        }\n\n        if ($isQuantityMinFilterSet) {\n            $conditions[] = $this->getIsQuantityMinFilterSetCondition();\n        }\n\n        if ($isPriceZero) {\n            $conditions[] = $this->getIsPriceZeroCondition();\n        }\n\n        $quantityIsZeroFilterOn = false;\n        $priceIsZeroFilterOn = false;\n        foreach ($conditions as $condition) {\n            if (is_int($condition) || !is_array($condition)) {\n                continue;\n            }\n            if (is_string($condition)) {\n                if (preg_match('/'.$this->getIsQuantityMinFilterSetCondition().'/', $condition)) {\n                    $this->getAssociation('ProductAttributes')->setConditions(\n                        [\n                            'StockAvailables.quantity < 3'\n                        ]\n                    );\n                    $quantityIsZeroFilterOn = true;\n                }\n                if (preg_match('/'.$this->getIsPriceZeroCondition().'/', $condition)) {\n                    $this->ProductAttributes->setConditions(\n                        [\n                            'ProductAttributes.price' => 0\n                        ]\n                    );\n                    $priceIsZeroFilterOn = true;\n                }\n            }\n        }\n        $contain = [\n            'CategoryProducts',\n            'CategoryProducts.Categories',\n            'DepositProducts',\n            'Images',\n            'Taxes',\n            'UnitProducts',\n            'Manufacturers',\n            'StockAvailables' => [\n                'conditions' => [\n                    'StockAvailables.id_product_attribute' => 0\n                ]\n            ],\n            'ProductAttributes',\n            'ProductAttributes.StockAvailables' => [\n                'conditions' => [\n                    'StockAvailables.id_product_attribute > 0'\n                ]\n            ],\n            'ProductAttributes.DepositProductAttributes',\n            'ProductAttributes.UnitProductAttributes',\n            'ProductAttributes.ProductAttributeCombinations.Attributes'\n        ];\n\n        if (Configure::read('appDb.FCS_PURCHASE_PRICE_ENABLED')) {\n            $contain[] = 'PurchasePriceProducts.Taxes';\n            $contain[] = 'ProductAttributes.PurchasePriceProductAttributes';\n        }\n\n        if (Configure::read('appDb.FCS_SELF_SERVICE_MODE_FOR_STOCK_PRODUCTS_ENABLED')) {\n            $contain[] = 'BarcodeProducts';\n            $contain[] = 'ProductAttributes.BarcodeProductAttributes';\n        }\n\n        $order = [\n            'Products.active' => 'DESC',\n            'Products.name' => 'ASC'\n        ];\n\n        $query = $this->find('all', [\n            'conditions' => $conditions,\n            'contain' => $contain,\n            'order' => ($controller === null ? $order : null)\n        ]);\n\n        if ($categoryId != '') {\n            $query->matching('CategoryProducts', function ($q) use ($categoryId) {\n                return $q->where(['id_category IN' => $categoryId]);\n            });\n        }\n\n        $query\n        ->select('Products.id_product')->distinct()\n        ->select($this) // Products\n        ->select($this->DepositProducts)\n        ->select('Images.id_image')\n        ->select($this->Taxes)\n        ->select($this->Manufacturers)\n        ->select($this->UnitProducts)\n        ->select($this->StockAvailables);\n\n        if (Configure::read('appDb.FCS_PURCHASE_PRICE_ENABLED')) {\n            $query->select($this->PurchasePriceProducts);\n        }\n\n        if (Configure::read('appDb.FCS_SELF_SERVICE_MODE_FOR_STOCK_PRODUCTS_ENABLED')) {\n            $this->Catalog = new Catalog();\n            $query->select(['system_bar_code' => $this->Catalog->getProductIdentifierField()]);\n            $query->select($this->BarcodeProducts);\n        }\n\n        if ($controller) {\n            $query = $controller->paginate($query, [\n                'sortableFields' => [\n                    'Images.id_image', 'Products.name', 'Products.is_declaration_ok', 'Taxes.rate', 'Products.active', 'Manufacturers.name', 'Products.is_stock_product'\n                ],\n                'order' => $order\n            ]);\n        }\n\n        $i = 0;\n        $preparedProducts = [];\n        foreach ($query as $product) {\n            $product->category = (object) [\n                'names' => [],\n                'all_products_found' => false\n            ];\n            foreach ($product->category_products as $category) {\n                // assignment to \"all products\" has to be checked... otherwise show error message\n                if ($category->id_category == Configure::read('app.categoryAllProducts')) {\n                    $product->category->all_products_found = true;\n                } else {\n                    // sometimes associated category does not exist any more...\n                    if (!empty($category->category)) {\n                        $product->category->names[] = $category->category->name;\n                    }\n                }\n            }\n            $product->selected_categories = Hash::extract($product->category_products, '{n}.id_category');\n\n            $product->is_new = true;\n            if ($product->created) {\n                $product->is_new = $this->isNew($product->created->i18nFormat(Configure::read('DateFormat.Database')));\n            }\n\n            $taxRate = is_null($product->tax) ? 0 : $product->tax->rate;\n            $product->gross_price = $this->getGrossPrice($product->price, $taxRate);\n\n            $product->delivery_rhythm_string = Configure::read('app.htmlHelper')->getDeliveryRhythmString(\n                $product->is_stock_product && $product->manufacturer->stock_management_enabled,\n                $product->delivery_rhythm_type,\n                $product->delivery_rhythm_count\n            );\n            $product->last_order_weekday = Configure::read('app.timeHelper')->getWeekdayName(\n                Configure::read('app.timeHelper')->getNthWeekdayBeforeWeekday(1, $product->delivery_rhythm_send_order_list_weekday)\n            );\n\n            $rowClass = [];\n            if (! $product->active) {\n                $rowClass[] = 'deactivated';\n            }\n\n            if (!empty($product->deposit_product)) {\n                $product->deposit = $product->deposit_product->deposit;\n            } else {\n                $product->deposit = 0;\n            }\n\n            if (!empty($product->image)) {\n                $imageSrc = Configure::read('app.htmlHelper')->getProductImageSrc($product->image->id_image, 'home');\n                $imageFile = str_replace('//', '/', $_SERVER['DOCUMENT_ROOT'] . $imageSrc);\n                $imageFile = Configure::read('app.htmlHelper')->removeTimestampFromFile($imageFile);\n                if ($imageFile != '' && !preg_match('/de-default-home/', $imageFile) && file_exists($imageFile)) {\n                    $product->image->hash = sha1_file($imageFile);\n                    $product->image->src = Configure::read('App.fullBaseUrl') . $imageSrc;\n                }\n            }\n\n            // show unity only for main products\n            $additionalProductNameInfos = [];\n            if (empty($product->product_attributes) && $product->unity != '') {\n                $additionalProductNameInfos[] = '<span class=\"unity-for-dialog\">' . $product->unity . '</span>';\n            }\n\n            $product->price_is_zero = false;\n            if (empty($product->product_attributes) && $product->gross_price == 0) {\n                $product->price_is_zero = true;\n            }\n            $product->unit = null;\n            if (empty($product->product_attributes) && !empty($product->unit_product)) {\n\n                $product->unit = $product->unit_product;\n\n                $quantityInUnitsString = Configure::read('app.pricePerUnitHelper')->getQuantityInUnitsWithWrapper($product->unit_product->price_per_unit_enabled, $product->unit_product->quantity_in_units, $product->unit_product->name);\n                if ($quantityInUnitsString != '') {\n                    $additionalProductNameInfos[] = $quantityInUnitsString;\n                }\n\n                if ($product->unit_product->price_per_unit_enabled) {\n                    $product->price_is_zero = false;\n                }\n\n            }\n\n            $product->unchanged_name = $product->name;\n            $product->name = '<span class=\"product-name\">' . $product->name . '</span>';\n            if (!empty($additionalProductNameInfos)) {\n                $product->name = $product->name . ': ' . join(', ', $additionalProductNameInfos);\n            }\n\n            if (empty($product->tax)) {\n                $product->tax = (object) [\n                    'rate' => 0,\n                ];\n            }\n\n            if (Configure::read('appDb.FCS_PURCHASE_PRICE_ENABLED')) {\n\n                $product->purchase_price_is_zero = true;\n                $product->purchase_price_is_set = $this->PurchasePriceProducts->isPurchasePriceSet($product);\n\n                if (empty($product->purchase_price_product) || $product->purchase_price_product->tax_id === null) {\n                    $product->purchase_price_product = (object) [\n                        'tax_id' => null,\n                        'price' => null,\n                        'tax' => [\n                            'rate' => null,\n                        ],\n                    ];\n                }\n                if (!empty($product->purchase_price_product)) {\n\n                    $purchasePriceTaxRate = $product->purchase_price_product->tax->rate ?? 0;\n                    $purchasePrice = $product->purchase_price_product->price ?? null;\n                    if ($purchasePrice === null) {\n                        $product->purchase_gross_price = $purchasePrice;\n                    } else {\n                        $product->purchase_gross_price = $this->getGrossPrice($purchasePrice, $purchasePriceTaxRate);\n                        if ($product->purchase_gross_price > 0) {\n                            $product->purchase_price_is_zero = false;\n                        }\n                    }\n\n                    if (!empty($product->unit) && $product->unit->price_per_unit_enabled) {\n                        if (!is_null($product->unit->purchase_price_incl_per_unit)) {\n                            $product->surcharge_percent = $this->PurchasePriceProducts->calculateSurchargeBySellingPriceGross(\n                                Configure::read('app.pricePerUnitHelper')->getPricePerUnit($product->unit->price_incl_per_unit, $product->unit_product->quantity_in_units, $product->unit_product->amount),\n                                $taxRate,\n                                Configure::read('app.pricePerUnitHelper')->getPricePerUnit($product->unit->purchase_price_incl_per_unit, $product->unit_product->quantity_in_units, $product->unit_product->amount),\n                                $purchasePriceTaxRate,\n                            );\n                            $priceInclPerUnitAndAmount = $this->getNetPrice($product->unit->price_incl_per_unit, $taxRate) * $product->unit_product->quantity_in_units / $product->unit_product->amount;\n                            $purchasePriceInclPerUnitAndAmount = $this->getNetPrice($product->unit->purchase_price_incl_per_unit, $purchasePriceTaxRate) * $product->unit_product->quantity_in_units / $product->unit_product->amount;\n                            $product->surcharge_price = $priceInclPerUnitAndAmount - $purchasePriceInclPerUnitAndAmount;\n                            if ($purchasePriceInclPerUnitAndAmount > 0) {\n                                $product->purchase_price_is_zero = false;\n                            }\n                        }\n                    } else {\n                        $product->surcharge_percent = $this->PurchasePriceProducts->calculateSurchargeBySellingPriceGross(\n                            $product->gross_price,\n                            $taxRate,\n                            $product->purchase_gross_price,\n                            $purchasePriceTaxRate,\n                        );\n                        $product->surcharge_price = $product->price - $purchasePrice;\n                    }\n\n                }\n            }\n\n            $rowClass[] = 'main-product';\n            $rowIsOdd = false;\n            if ($i % 2 == 0) {\n                $rowIsOdd = true;\n                $rowClass[] = 'custom-odd';\n            }\n            $product->row_class = join(' ', $rowClass);\n\n            $preparedProducts[] = $product;\n            $i ++;\n\n            if (! empty($product->product_attributes)) {\n                $currentPreparedProduct = count($preparedProducts) - 1;\n                $preparedProducts[$currentPreparedProduct]['AttributesRemoved'] = 0;\n\n                foreach ($product->product_attributes as $attribute) {\n                    if (($quantityIsZeroFilterOn && empty($attribute->stock_available)) || ($priceIsZeroFilterOn && empty($attribute))) {\n                        $preparedProducts[$currentPreparedProduct]['AttributesRemoved'] ++;\n                        continue;\n                    }\n\n                    $grossPrice = 0;\n                    if (! empty($attribute->price)) {\n                        $grossPrice = $this->getGrossPrice($attribute->price, $taxRate);\n                    }\n\n                    $rowClass = [\n                        'sub-row'\n                    ];\n                    if (! $product->active) {\n                        $rowClass[] = 'deactivated';\n                    }\n\n                    if ($rowIsOdd) {\n                        $rowClass[] = 'custom-odd';\n                    }\n\n                    $priceIsZero = false;\n                    if ($grossPrice == 0) {\n                        $priceIsZero = true;\n                    }\n                    if (!empty($attribute->unit_product_attribute) && $attribute->unit_product_attribute->price_per_unit_enabled) {\n                        $productName = Configure::read('app.pricePerUnitHelper')->getQuantityInUnitsStringForAttributes(\n                            $attribute->product_attribute_combination->attribute->name,\n                            $attribute->product_attribute_combination->attribute->can_be_used_as_unit,\n                            $attribute->unit_product_attribute->price_per_unit_enabled,\n                            $attribute->unit_product_attribute->quantity_in_units,\n                            $attribute->unit_product_attribute->name\n                        );\n                        $priceIsZero = false;\n                    } else {\n                        $productName = $attribute->product_attribute_combination->attribute->name;\n                        if ($addProductNameToAttributes) {\n                            $productName = $product->name . ': ' . $productName;\n                        }\n                    }\n\n                    $preparedProduct = [\n                        'id_product' => $product->id_product . '-' . $attribute->id_product_attribute,\n                        'gross_price' => $grossPrice,\n                        'active' => - 1,\n                        'is_stock_product' => $product->is_stock_product,\n                        'price_is_zero' => $priceIsZero,\n                        'row_class' => join(' ', $rowClass),\n                        'unchanged_name' => $product->unchanged_name,\n                        'name' => $productName,\n                        'description_short' => '',\n                        'description' => '',\n                        'unity' => '',\n                        'manufacturer' => [\n                            'name' => (!empty($product->manufacturer) ? $product->manufacturer->name : ''),\n                            'stock_management_enabled' => (!empty($product->manufacturer) ? $product->manufacturer->stock_management_enabled : false),\n                        ],\n                        'default_on' => $attribute->default_on,\n                        'stock_available' => [\n                            'quantity' => $attribute->stock_available->quantity,\n                            'quantity_limit' => $attribute->stock_available->quantity_limit,\n                            'sold_out_limit' => $attribute->stock_available->sold_out_limit,\n                            'always_available' => $attribute->stock_available->always_available,\n                            'default_quantity_after_sending_order_lists' => $attribute->stock_available->default_quantity_after_sending_order_lists,\n                        ],\n                        'deposit' => !empty($attribute->deposit_product_attribute) ? $attribute->deposit_product_attribute->deposit : 0,\n                        'unit' => !empty($attribute->unit_product_attribute) ? $attribute->unit_product_attribute : [],\n                        'category' => [\n                            'names' => [],\n                            'all_products_found' => true\n                        ],\n                        'image' => null,\n                        'barcode_product' => $attribute->barcode_product_attribute,\n                    ];\n\n                    if (Configure::read('appDb.FCS_SELF_SERVICE_MODE_FOR_STOCK_PRODUCTS_ENABLED')) {\n                        $attributeId = $attribute->id_product_attribute ?? 0;\n                        $preparedProduct['system_bar_code'] = $product->system_bar_code . Configure::read('app.numberHelper')->addLeadingZerosToNumber((string) $attributeId, 4);\n                        $preparedProduct['image'] = $product->image;\n                        if (!empty($attribute->unit_product_attribute) && $attribute->unit_product_attribute->price_per_unit_enabled) {\n                            $preparedProduct['nameForBarcodePdf'] = $product->name . ': ' . $productName;\n                        }\n                    }\n\n                    if (Configure::read('appDb.FCS_PURCHASE_PRICE_ENABLED')) {\n\n                        $preparedProduct['purchase_price_is_set'] = $this->ProductAttributes->PurchasePriceProductAttributes->isPurchasePriceSet($attribute);\n                        $preparedProduct['purchase_price_is_zero'] = true;\n\n                        $purchasePrice = $attribute->purchase_price_product_attribute->price ?? null;\n                        if ($purchasePrice === null) {\n                            $preparedProduct['purchase_gross_price'] = $purchasePrice;\n                        } else {\n                            $preparedProduct['purchase_gross_price'] = $this->getGrossPrice($purchasePrice, $purchasePriceTaxRate);\n                            if ($preparedProduct['purchase_gross_price'] > 0) {\n                                $preparedProduct['purchase_price_is_zero'] = false;\n                            }\n                        }\n\n                        if (!empty($attribute->unit_product_attribute) && $attribute->unit_product_attribute->price_per_unit_enabled) {\n                            if (!is_null($attribute->unit_product_attribute->purchase_price_incl_per_unit)) {\n                                $preparedProduct['surcharge_percent'] = $this->PurchasePriceProducts->calculateSurchargeBySellingPriceGross(\n                                    Configure::read('app.pricePerUnitHelper')->getPricePerUnit($attribute->unit_product_attribute->price_incl_per_unit, $attribute->unit_product_attribute->quantity_in_units, $attribute->unit_product_attribute->amount),\n                                    $taxRate,\n                                    Configure::read('app.pricePerUnitHelper')->getPricePerUnit($attribute->unit_product_attribute->purchase_price_incl_per_unit, $attribute->unit_product_attribute->quantity_in_units, $attribute->unit_product_attribute->amount),\n                                    $purchasePriceTaxRate,\n                                );\n                                $priceInclPerUnitAndAmount = $this->getNetPrice($attribute->unit_product_attribute->price_incl_per_unit, $taxRate) * $attribute->unit_product_attribute->quantity_in_units / $attribute->unit_product_attribute->amount;\n                                $purchasePriceInclPerUnitAndAmount = $this->getNetPrice($attribute->unit_product_attribute->purchase_price_incl_per_unit, $purchasePriceTaxRate) * $attribute->unit_product_attribute->quantity_in_units / $attribute->unit_product_attribute->amount;\n                                $preparedProduct['surcharge_price'] = $priceInclPerUnitAndAmount - $purchasePriceInclPerUnitAndAmount;\n                                if ($purchasePriceInclPerUnitAndAmount > 0) {\n                                    $preparedProduct['purchase_price_is_zero'] = false;\n                                }\n                            }\n                        } else {\n                            $preparedProduct['surcharge_percent'] = $this->PurchasePriceProducts->calculateSurchargeBySellingPriceGross(\n                                $grossPrice,\n                                $taxRate,\n                                $preparedProduct['purchase_gross_price'],\n                                $purchasePriceTaxRate,\n                            );\n                            $preparedProduct['surcharge_price'] = $attribute->price - $purchasePrice;\n                        }\n\n\n                    }\n                    $preparedProducts[] = $preparedProduct;\n                }\n            }\n        }\n\n        // price zero filter is difficult to implement, because if there are attributes assigned to the product, the product's price is always 0\n        // which would lead to always showing the main product of attributes if price zero filter is set\n        // this is not the case for quantity zero filter, because the main product's quantity is the sum of the associated attribute quantities\n        if ($priceIsZeroFilterOn) {\n            foreach ($preparedProducts as $key => $preparedProduct) {\n                if (isset($preparedProducts[$key]['AttributesRemoved']) && $preparedProducts[$key]['AttributesRemoved'] == count($preparedProducts[$key]->product_attributes)) {\n                    unset($preparedProducts[$key]);\n                }\n            }\n        }\n        $preparedProducts = json_decode(json_encode($preparedProducts), false); // convert array recursively into object\n        return $preparedProducts;\n    }\n\n    public function getForDropdown($appAuth, $manufacturerId)\n    {\n        $conditions = [];\n\n        if ($appAuth->isManufacturer()) {\n            $manufacturerId = $appAuth->getManufacturerId();\n        }\n\n        if ($manufacturerId > 0) {\n            $conditions['Manufacturers.id_manufacturer'] = $manufacturerId;\n        }\n\n        // ->find('list') a does not return associated model data\n        $products = $this->find('all', [\n            'conditions' => $conditions,\n            'contain' => [\n                'Manufacturers',\n            ],\n            'order' => [\n                'Products.active' => 'DESC',\n                'Products.name' => 'ASC'\n            ]\n        ]);\n\n        $onlineProducts = [];\n        $offlineProducts = [];\n        $deletedProducts = [];\n        foreach ($products as $product) {\n            $productNameForDropdown = $product->name . (!empty($product->manufacturer) ? ' - ' . html_entity_decode($product->manufacturer->name) : '');\n            switch($product->active) {\n                case 1:\n                    $onlineProducts[$product->id_product] = $productNameForDropdown;\n                    break;\n                case 0:\n                    $offlineProducts[$product->id_product] = $productNameForDropdown;\n                    break;\n                case -1:\n                    $deletedProducts[$product->id_product] = $productNameForDropdown;\n                    break;\n            }\n        }\n\n        $productsForDropdown = [];\n        if (! empty($onlineProducts)) {\n            $onlineCount = count($onlineProducts);\n            $productsForDropdown[__('online') . '-' . $onlineCount] = $onlineProducts;\n        }\n\n        if (! empty($offlineProducts)) {\n            $offlineCount = count($offlineProducts);\n            $productsForDropdown[__('offline') . '-' . $offlineCount] = $offlineProducts;\n        }\n\n        if (! empty($deletedProducts)) {\n            $deletedCount = count($deletedProducts);\n            $productsForDropdown[__('deleted') . '-' . $deletedCount] = $deletedProducts;\n        }\n\n        return $productsForDropdown;\n    }\n\n    /**\n     * @param float $grossPrice (for all units)\n     * @param float $netPrice (for one unit)\n     * @param int $quantity\n     * @return float\n     */\n    public function getUnitTax($grossPrice, $netPrice, $quantity)\n    {\n        if ($quantity == 0) {\n            return 0;\n        }\n        return round(($grossPrice - ($netPrice * $quantity)) / $quantity, 2);\n    }\n\n    public function getGrossPrice($netPrice, $taxRate)\n    {\n        $grossPrice = $netPrice * (100 + $taxRate) / 100;\n        $grossPrice = round($grossPrice, 2);\n        return $grossPrice;\n    }\n\n    public function getNetPrice($grossPrice, $taxRate)\n    {\n        $netPrice = $grossPrice / (100 + $taxRate) * 100;\n        $netPrice = round($netPrice, 6);\n        return $netPrice;\n    }\n\n    public function getNetPriceForNewTaxRate($netPrice, $oldTaxRate, $newTaxRate) {\n        $netPrice = $netPrice / ((100 + $newTaxRate) / 100) * (1 + $oldTaxRate / 100);\n        $netPrice = round($netPrice, 6);\n        return $netPrice;\n    }\n\n    private function getIsQuantityMinFilterSetCondition()\n    {\n        return '(StockAvailables.quantity < 3 && (StockAvailables.always_available = 0 || (Products.is_stock_product = 1 && Manufacturers.stock_management_enabled = 1)))';\n    }\n\n    private function getIsPriceZeroCondition()\n    {\n        return 'Products.price = 0';\n    }\n\n    public function setDefaultAttributeId($productId, $productAttributeId)\n    {\n        $productAttributes = $this->ProductAttributes->find('all', [\n            'conditions' => [\n                'ProductAttributes.id_product' => $productId,\n            ]\n        ]);\n\n        $productAttributeIds = [];\n        foreach ($productAttributes as $attribute) {\n            $productAttributeIds[] = $attribute->id_product_attribute;\n        }\n\n        // first set all associated attributes to 0\n        $this->ProductAttributes->updateAll([\n            'default_on' => 0\n        ], [\n            'id_product_attribute IN (' . join(', ', $productAttributeIds) . ')',\n        ]);\n\n        // then set the new one\n        $productAttributeEntity = $productAttributes->where([\n            'ProductAttributes.id_product_attribute' => $productAttributeId,\n        ])->first();\n        $productAttributeEntity->default_on = APP_ON;\n        $this->ProductAttributes->save($productAttributeEntity);\n    }\n\n    public function changeImage($products)\n    {\n\n        foreach ($products as $product) {\n            $productId = key($product);\n            $imageFromRemoteServer = $product[$productId];\n            $imageFromRemoteServer = Configure::read('app.htmlHelper')->removeTimestampFromFile($imageFromRemoteServer);\n            if ($imageFromRemoteServer == 'no-image') {\n                continue;\n            }\n\n            if (filter_var($imageFromRemoteServer, FILTER_VALIDATE_URL)) {\n                $syncDomainsTable = FactoryLocator::get('Table')->get('Network.SyncDomains');\n                $syncDomains = $syncDomainsTable->getActiveSyncDomains()->toArray();\n                $syncDomains = Hash::extract($syncDomains, '{n}.domain');\n                if (!RemoteFile::exists($imageFromRemoteServer, $syncDomains)) {\n                    throw new InvalidParameterException('remote image not existing: ' . $imageFromRemoteServer);\n                }\n            } else {\n                $remoteImage = file_exists($imageFromRemoteServer);\n                if (!$remoteImage) {\n                    throw new InvalidParameterException('local image not existing: ' . $imageFromRemoteServer);\n                }\n            }\n\n            $mimeContentType = mime_content_type($imageFromRemoteServer);\n            if (!in_array($mimeContentType, Configure::read('app.allowedImageMimeTypes'))) {\n                throw new InvalidParameterException('file is not an image: ' . $imageFromRemoteServer);\n            }\n        }\n\n        $success = false;\n        foreach ($products as $product) {\n\n            $productId = key($product);\n            $ids = $this->getProductIdAndAttributeId($productId);\n\n            if ($ids['attributeId'] > 0) {\n                continue;\n            }\n\n            $imageFromRemoteServer = $product[$productId];\n            $imageFromRemoteServer = Configure::read('app.htmlHelper')->removeTimestampFromFile($imageFromRemoteServer);\n            $extension = strtolower(pathinfo($imageFromRemoteServer, PATHINFO_EXTENSION));\n\n            $product = $this->find('all', [\n                'conditions' => [\n                    'Products.id_product' => $ids['productId']\n                ],\n                'contain' => [\n                    'Images'\n                ]\n            ])->first();\n\n            if (empty($product->image)) {\n                // product does not yet have image => create the necessary record\n                $image = $this->Images->save(\n                    $this->Images->newEntity(\n                        ['id_product' => $ids['productId']]\n                    )\n                );\n            } else {\n                $image = $product->image;\n            }\n\n            $imageIdAsPath = Configure::read('app.htmlHelper')->getProductImageIdAsPath($image->id_image);\n            $thumbsPath = Configure::read('app.htmlHelper')->getProductThumbsPath($imageIdAsPath);\n\n            if ($imageFromRemoteServer != 'no-image') {\n\n                Folder::nonRecursivelyRemoveAllFiles($thumbsPath);\n                if (!file_exists($thumbsPath)) {\n                    mkdir($thumbsPath, 0755, true);\n                }\n                foreach (Configure::read('app.productImageSizes') as $thumbSize => $options) {\n                    $thumbsFileName = $thumbsPath . DS . $image->id_image . $options['suffix'] . '.' . $extension;\n                    $remoteFileName = preg_replace('/-home_default/', $options['suffix'], $imageFromRemoteServer);\n                    copy($remoteFileName, $thumbsFileName);\n                }\n\n            } else {\n\n                // delete db records\n                $this->Images->deleteAll([\n                    'Images.id_image' => $image->id_image\n                ]);\n\n                Folder::nonRecursivelyRemoveAllFiles($thumbsPath);\n\n            }\n        }\n\n        return $success;\n    }\n\n    public function add($manufacturer, $productName, $descriptionShort, $description, $unity, $isDeclarationOk, $idStorageLocation, $barcode)\n    {\n        $defaultQuantity = 0;\n\n        $this->Manufacturer = FactoryLocator::get('Table')->get('Manufacturers');\n\n        $productEntity = $this->newEntity(\n            [\n                'id_manufacturer' => $manufacturer->id_manufacturer,\n                'id_tax' => $this->Manufacturer->getOptionDefaultTaxId($manufacturer->default_tax_id),\n                'name' => StringComponent::removeSpecialChars(strip_tags(trim($productName))),\n                'delivery_rhythm_send_order_list_weekday' => DeliveryRhythm::getSendOrderListsWeekday(),\n                'description_short' => StringComponent::prepareWysiwygEditorHtml($descriptionShort, self::ALLOWED_TAGS_DESCRIPTION_SHORT),\n                'description' => StringComponent::prepareWysiwygEditorHtml($description, self::ALLOWED_TAGS_DESCRIPTION),\n                'unity' => StringComponent::removeSpecialChars(strip_tags(trim($unity))),\n                'is_declaration_ok' => $isDeclarationOk,\n                'id_storage_location' => $idStorageLocation,\n            ],\n            [\n                'validate' => 'name'\n            ]\n        );\n\n        if ($productEntity->hasErrors()) {\n            return $productEntity;\n        }\n\n        if ($barcode != '') {\n            $barcode = StringComponent::removeSpecialChars(strip_tags(trim($barcode)));\n            $barcodeEntity2Save = $this->BarcodeProducts->newEntity([\n                'barcode' => $barcode,\n            ], ['validate' => true]);\n            if ($barcodeEntity2Save->hasErrors()) {\n                return $barcodeEntity2Save;\n            }\n        }\n\n        $newProduct = $this->save($productEntity);\n        $newProductId = $newProduct->id_product;\n\n        if ($barcode != '') {\n            $barcodeEntity2Save->product_id = $newProductId;\n            $this->BarcodeProducts->save($barcodeEntity2Save);\n        }\n\n        if (Configure::read('appDb.FCS_PURCHASE_PRICE_ENABLED')) {\n            $entity2Save = $this->PurchasePriceProducts->getEntityToSaveByProductId($newProductId);\n            $patchedEntity = $this->PurchasePriceProducts->patchEntity(\n                $entity2Save,\n                [\n                    'tax_id' => $this->Manufacturer->getOptionDefaultTaxId($manufacturer->default_tax_id_purchase_price),\n                ],\n            );\n            $this->PurchasePriceProducts->save($patchedEntity);\n        }\n\n        // INSERT CATEGORY_PRODUCTS\n        $this->CategoryProducts->save(\n            $this->CategoryProducts->newEntity(\n                [\n                    'id_category' => Configure::read('app.categoryAllProducts'),\n                    'id_product' => $newProductId\n                ]\n            )\n        );\n\n        // INSERT STOCK AVAILABLE\n        $this->StockAvailables->save(\n            $this->StockAvailables->newEntity(\n                [\n                    'id_product' => $newProductId,\n                    'quantity' => $defaultQuantity\n                ]\n            )\n        );\n\n        $newProduct = $this->find('all', [\n            'conditions' => [\n                'Products.id_product' => $newProductId\n            ]\n        ])->first();\n\n        return $productEntity;\n    }\n}\n"], "filenames": ["CHANGELOG.md", "VERSION.txt", "plugins/Admin/tests/TestCase/src/Model/Table/ProductsTableTest.php", "src/Lib/RemoteFile/RemoteFile.php", "src/Model/Table/ProductsTable.php"], "buggy_code_start_loc": [7, 1, 90, 21, 1373], "buggy_code_end_loc": [7, 2, 117, 37, 1386], "fixing_code_start_loc": [8, 1, 91, 21, 1373], "fixing_code_end_loc": [15, 2, 129, 52, 1389], "type": "CWE-367", "message": "FoodCoopShop is open source software for food coops and local shops. Versions starting with 3.2.0 prior to 3.6.1 are vulnerable to server-side request forgery. In the Network module, a manufacturer account can use the `/api/updateProducts.json` endpoint to make the server send a request to an arbitrary host. This means that the server can be used as a proxy into the internal network where the server is. Furthermore, the checks on a valid image are not adequate, leading to a time of check time of use issue. For example, by using a custom server that returns 200 on HEAD requests, then return a valid image on first GET request and then a 302 redirect to final target on second GET request, the server will copy whatever file is at the redirect destination, making this a full SSRF. Version 3.6.1 fixes this vulnerability.", "other": {"cve": {"id": "CVE-2023-46725", "sourceIdentifier": "security-advisories@github.com", "published": "2023-11-02T15:15:08.847", "lastModified": "2023-11-09T21:16:04.827", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "FoodCoopShop is open source software for food coops and local shops. Versions starting with 3.2.0 prior to 3.6.1 are vulnerable to server-side request forgery. In the Network module, a manufacturer account can use the `/api/updateProducts.json` endpoint to make the server send a request to an arbitrary host. This means that the server can be used as a proxy into the internal network where the server is. Furthermore, the checks on a valid image are not adequate, leading to a time of check time of use issue. For example, by using a custom server that returns 200 on HEAD requests, then return a valid image on first GET request and then a 302 redirect to final target on second GET request, the server will copy whatever file is at the redirect destination, making this a full SSRF. Version 3.6.1 fixes this vulnerability."}, {"lang": "es", "value": "FoodCoopShop es un software de c\u00f3digo abierto para cooperativas de alimentos y tiendas locales. Las versiones que comienzan con 3.2.0 anteriores a 3.6.1 son vulnerables a server-side request forgery. En el m\u00f3dulo de Network, una cuenta de fabricante puede usar el endpoint `/api/updateProducts.json` para hacer que el servidor env\u00ede una solicitud a un host arbitrario. Esto significa que el servidor se puede utilizar como proxy en la red interna donde se encuentra el servidor. Adem\u00e1s, las comprobaciones de una imagen v\u00e1lida no son adecuadas, lo que genera un problema de tiempo de verificaci\u00f3n de uso. Por ejemplo, al usar un servidor personalizado que devuelve 200 en solicitudes HEAD, luego devuelve una imagen v\u00e1lida en la primera solicitud GET y luego una redirecci\u00f3n 302 al destino final en la segunda solicitud GET, el servidor copiar\u00e1 cualquier archivo que est\u00e9 en el destino de la redirecci\u00f3n, haciendo Esta es una SSRF completa. La versi\u00f3n 3.6.1 corrige esta vulnerabilidad."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "HIGH", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 7.5, "baseSeverity": "HIGH"}, "exploitabilityScore": 1.6, "impactScore": 5.9}, {"source": "security-advisories@github.com", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "NONE", "baseScore": 8.1, "baseSeverity": "HIGH"}, "exploitabilityScore": 2.8, "impactScore": 5.2}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-367"}, {"lang": "en", "value": "CWE-918"}]}, {"source": "security-advisories@github.com", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-918"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:foodcoopshop:foodcoopshop:*:*:*:*:*:*:*:*", "versionStartIncluding": "3.2.0", "versionEndIncluding": "3.6.0", "matchCriteriaId": "3F749AE9-CD3D-408F-ADA7-47D384325618"}]}]}], "references": [{"url": "https://github.com/foodcoopshop/foodcoopshop/commit/0d5bec5c4c22e1affe7fd321a30e3f3a4d99e808", "source": "security-advisories@github.com", "tags": ["Patch"]}, {"url": "https://github.com/foodcoopshop/foodcoopshop/pull/972", "source": "security-advisories@github.com", "tags": ["Patch"]}, {"url": "https://github.com/foodcoopshop/foodcoopshop/security/advisories/GHSA-jhww-fx2j-3rf7", "source": "security-advisories@github.com", "tags": ["Vendor Advisory"]}, {"url": "https://pastebin.com/8K5Brwbq", "source": "security-advisories@github.com", "tags": ["Not Applicable"]}]}, "github_commit_url": "https://github.com/foodcoopshop/foodcoopshop/commit/0d5bec5c4c22e1affe7fd321a30e3f3a4d99e808"}}