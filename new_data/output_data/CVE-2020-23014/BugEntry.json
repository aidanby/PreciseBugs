{"buggy_code": ["from app import apfell, links, use_ssl\nfrom sanic import response\nfrom jinja2 import Environment, PackageLoader\nfrom sanic_jwt.decorators import scoped, inject_user\nfrom app.routes.routes import respect_pivot\nimport urllib.parse\n\nenv = Environment(loader=PackageLoader('app', 'templates'))\n\n\n@apfell.route(\"/apiui/command_help\")\n@inject_user()\n@scoped(['auth:user', 'auth:apitoken_user'], False)  # user or user-level api token are ok\nasync def apiui_command_help(request, user):\n    template = env.get_template('apiui_command_help.html')\n    if len(request.query_args) != 0:\n        data = urllib.parse.unquote(request.query_args[0][1])\n        print(data)\n    else:\n        data = \"\"\n    if use_ssl:\n        content = template.render(links=await respect_pivot(links, request), name=user['username'], http=\"https\",\n                                  ws=\"wss\", config=user['ui_config'], view_utc_time=user['view_utc_time'], agent=data)\n    else:\n        content = template.render(links=await respect_pivot(links, request), name=user['username'], http=\"http\",\n                                  ws=\"ws\", config=user['ui_config'], view_utc_time=user['view_utc_time'], agent=data)\n    return response.html(content)\n\n# add links to the routes in this file at the bottom\nlinks['apiui_command_help'] = apfell.url_for('apiui_command_help')\n"], "fixing_code": ["from app import apfell, links, use_ssl, db_objects\nfrom sanic import response\nfrom jinja2 import Environment, PackageLoader\nfrom sanic_jwt.decorators import scoped, inject_user\nfrom app.routes.routes import respect_pivot\nimport urllib.parse\nimport app.database_models.model as db_model\n\nenv = Environment(loader=PackageLoader('app', 'templates'))\n\n\n@apfell.route(\"/apiui/command_help\")\n@inject_user()\n@scoped(['auth:user', 'auth:apitoken_user'], False)  # user or user-level api token are ok\nasync def apiui_command_help(request, user):\n    template = env.get_template('apiui_command_help.html')\n    if len(request.query_args) != 0:\n        data = urllib.parse.unquote(request.query_args[0][1])\n        query = await db_model.payloadtype_query()\n        try:\n            payloadtype = await db_objects.get(query, ptype=data)\n        except Exception as e:\n            data = \"\"\n    else:\n        data = \"\"\n    if use_ssl:\n        content = template.render(links=await respect_pivot(links, request), name=user['username'], http=\"https\",\n                                  ws=\"wss\", config=user['ui_config'], view_utc_time=user['view_utc_time'], agent=data)\n    else:\n        content = template.render(links=await respect_pivot(links, request), name=user['username'], http=\"http\",\n                                  ws=\"ws\", config=user['ui_config'], view_utc_time=user['view_utc_time'], agent=data)\n    return response.html(content)\n\n# add links to the routes in this file at the bottom\nlinks['apiui_command_help'] = apfell.url_for('apiui_command_help')\n"], "filenames": ["apfell-docker/app/routes/api_routes.py"], "buggy_code_start_loc": [1], "buggy_code_end_loc": [19], "fixing_code_start_loc": [1], "fixing_code_end_loc": [24], "type": "CWE-79", "message": "APfell 1.4 is vulnerable to authenticated reflected cross-site scripting (XSS) in /apiui/command_ through the payloadtypes_callback function, which allows an attacker to steal remote admin/user session and/or adding new users to the administration panel.", "other": {"cve": {"id": "CVE-2020-23014", "sourceIdentifier": "cve@mitre.org", "published": "2021-01-26T18:15:42.257", "lastModified": "2021-01-29T22:44:40.257", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "APfell 1.4 is vulnerable to authenticated reflected cross-site scripting (XSS) in /apiui/command_ through the payloadtypes_callback function, which allows an attacker to steal remote admin/user session and/or adding new users to the administration panel."}, {"lang": "es", "value": "APfell versi\u00f3n 1.4, es vulnerable a un ataque de tipo cross site scripting (XSS) reflejado y autenticado en el archivo /apiui/command_ por medio de la funci\u00f3n payloadtypes_callback, que permite a un atacante robar una sesi\u00f3n de admin/user remoto y/o agregar nuevos usuarios al panel de administraci\u00f3n"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 5.4, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.3, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:S/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "SINGLE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 3.5}, "baseSeverity": "LOW", "exploitabilityScore": 6.8, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:apfell_project:apfell:*:*:*:*:*:*:*:*", "versionEndIncluding": "1.4", "matchCriteriaId": "B563C8EB-2A08-4F3C-A354-B26C81D39DA9"}]}]}], "references": [{"url": "https://github.com/its-a-feature/Apfell/commit/5fc64502bc008388514f2b5d1160b677e3b4a7f3", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://seekurity.com/blog/2020/04/19/admin/advisories/apfell-post-exploitation-red-team-framework-authenticated-cross-site-scripting-vulnerability", "source": "cve@mitre.org", "tags": ["Exploit", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/its-a-feature/Apfell/commit/5fc64502bc008388514f2b5d1160b677e3b4a7f3"}}