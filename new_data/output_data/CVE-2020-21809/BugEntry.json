{"buggy_code": ["<?php\n\n/**\n * @Project NUKEVIET 4.x\n * @Author VINADES.,JSC (contact@vinades.vn)\n * @Copyright (C) 2017 VINADES.,JSC. All rights reserved\n * @License GNU/GPL version 2 or any later version\n * @Createdate 04/18/2017 09:47\n */\n\nif (!defined('NV_IS_MOD_SHOPS')) {\n    die('Stop!!!');\n}\n\nif ($nv_Request->isset_request('check_quantity', 'post')) {\n    $id_pro = $nv_Request->get_int('id_pro', 'post', 0);\n    $unit = $nv_Request->get_string('pro_unit', 'post', '');\n    $listid = $nv_Request->get_string('listid', 'post');\n    $listid = explode(',', $listid);\n    asort($listid);\n    \n    $quantity = $db->query('SELECT quantity FROM ' . $db_config['prefix'] . '_' . $module_data . '_group_quantity WHERE pro_id = ' . $id_pro . ' AND listgroup=\"' . implode(',', $listid) . '\"')->fetchColumn();\n    if (empty($quantity)) {\n        $sum = 0;\n        $count = 0;\n        $listgroupid = GetGroupID($id_pro, 1);\n        if (!empty($listgroupid) and !empty($global_array_group)) {\n            foreach ($listgroupid as $gid => $subid) {\n                $parent_info = $global_array_group[$gid];\n                if ($parent_info['in_order']) {\n                    $count++;\n                }\n            }\n        }\n        \n        $result = $db->query('SELECT listgroup, quantity FROM ' . $db_config['prefix'] . '_' . $module_data . '_group_quantity WHERE pro_id = ' . $id_pro);\n        while (list ($listgroup, $quantity) = $result->fetch(3)) {\n            $listgroup = explode(',', $listgroup);\n            $_t = 0;\n            foreach ($listgroup as $_idgroup) {\n                if (in_array($_idgroup, $listid)) {\n                    $_t = $_t + 1;\n                }\n            }\n            if ($_t == sizeof($listid) or empty($listid)) {\n                $sum += $quantity;\n            }\n        }\n        \n        if ($sum == 0 or $count == sizeof($listid)) {\n            die('NO_0_' . $lang_module['product_empty']);\n        } else {\n            die('NO_0_' . $lang_module['detail_pro_number'] . ': ' . $sum . ' ' . $unit);\n        }\n    } else {\n        die('OK_' . $quantity . '_' . $lang_module['detail_pro_number'] . ': ' . $quantity . ' ' . $unit);\n    }\n}\n\n$compare_id = $nv_Request->get_string($module_data . '_compare_id', 'session', '');\n$compare_id = unserialize($compare_id);\n\n// Thiet lap quyen xem chi tiet\n$contents = '';\n$publtime = 0;\n\n$sql = $db->query('SELECT * FROM ' . $db_config['prefix'] . '_' . $module_data . '_rows WHERE ' . NV_LANG_DATA . '_alias = ' . $db->quote($alias_url) . ' AND status=1');\n$data_content = $sql->fetch();\nif (empty($data_content)) {\n    $nv_redirect = NV_BASE_SITEURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&amp;' . NV_NAME_VARIABLE . '=' . $module_name;\n    redict_link($lang_module['detail_do_not_view'], $lang_module['redirect_to_back_shops'], $nv_redirect);\n}\n$id = $data_content['id'];\n\n$data_content['array_custom'] = array();\n$data_content['array_custom_lang'] = array();\n$data_content['template'] = '';\n$idtemplate = 0;\n\nif ($global_array_shops_cat[$data_content['listcatid']]['form'] != '') {\n    $idtemplate = $db->query('SELECT id FROM ' . $db_config['prefix'] . '_' . $module_data . '_template where alias = \"' . preg_replace(\"/[\\_]/\", \"-\", $global_array_shops_cat[$data_content['listcatid']]['form']) . '\"')->fetchColumn();\n    if ($idtemplate) {\n        $listfield = array();\n        $array_tmp = array();\n        $result = $db->query('SELECT * FROM ' . $db_config['prefix'] . '_' . $module_data . '_field ORDER BY weight');\n        while ($row = $result->fetch()) {\n            $listtemplate = explode('|', $row['listtemplate']);\n            if (in_array($idtemplate, $listtemplate)) {\n                $listfield[] = $row['fid'];\n                $array_tmp[$row['field']] = unserialize($row['language']);\n            }\n        }\n        \n        if (!empty($listfield)) {\n            $result = $db->query('SELECT t1.field_value, t2.field FROM ' . $db_config['prefix'] . \"_\" . $module_data . \"_field_value_\" . NV_LANG_DATA . ' t1 INNER JOIN ' . $db_config['prefix'] . '_' . $module_data . '_field t2 WHERE t1.field_id=t2.fid AND t1.rows_id=' . $id);\n            $data_content['template'] = $global_array_shops_cat[$data_content['listcatid']]['form'];\n            while ($row = $result->fetch()) {\n                $data_content['array_custom'][$row['field']] = $row['field_value'];\n            }\n            \n            if (!empty($array_tmp)) {\n                foreach ($array_tmp as $f_key => $field) {\n                    foreach ($field as $key_lang => $lang_data) {\n                        if ($key_lang == NV_LANG_DATA) {\n                            $data_content['array_custom_lang'][$f_key] = $lang_data[0];\n                        }\n                    }\n                }\n                unset($array_tmp);\n            }\n        }\n    }\n}\n\n$page_title = !empty($data_content[NV_LANG_DATA . '_tag_title']) ? $data_content[NV_LANG_DATA . '_tag_title'] : $data_content[NV_LANG_DATA . '_title'];\n$description = !empty($data_content[NV_LANG_DATA . '_tag_description']) ? $data_content[NV_LANG_DATA . '_tag_description'] : $data_content[NV_LANG_DATA . '_hometext'];\n\nif (nv_user_in_groups($global_array_shops_cat[$catid]['groups_view'])) {\n    $popup = $nv_Request->get_int('popup', 'post,get', 0);\n    \n    $time_set = $nv_Request->get_int($module_data . '_' . $op . '_' . $id, 'session');\n    if (empty($time_set)) {\n        $nv_Request->set_Session($module_data . '_' . $op . '_' . $id, NV_CURRENTTIME);\n        $sql = 'UPDATE ' . $db_config['prefix'] . '_' . $module_data . '_rows SET hitstotal=hitstotal+1 WHERE id=' . $id;\n        $db->query($sql);\n    }\n    \n    $catid = $data_content['listcatid'];\n    $base_url_rewrite = nv_url_rewrite(NV_BASE_SITEURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&amp;' . NV_NAME_VARIABLE . '=' . $module_name . '&amp;' . NV_OP_VARIABLE . '=' . $global_array_shops_cat[$catid]['alias'] . '/' . $data_content[NV_LANG_DATA . '_alias'] . $global_config['rewrite_exturl'], true);\n    \n    if ($_SERVER['REQUEST_URI'] != $base_url_rewrite and !$popup) {\n        Header('Location: ' . $base_url_rewrite);\n        die();\n    }\n    \n    // Lay don vi san pham\n    $sql = $db->query('SELECT * FROM ' . $db_config['prefix'] . '_' . $module_data . '_units WHERE id = ' . $data_content['product_unit']);\n    $data_unit = $sql->fetch();\n    $data_unit['title'] = $data_unit[NV_LANG_DATA . '_title'];\n    \n    // Hien thi tabs\n    $sql = 'SELECT * FROM ' . $db_config['prefix'] . '_' . $module_data . '_tabs where active=1 ORDER BY weight ASC';\n    $data_content['tabs'] = $nv_Cache->db($sql, 'id', $module_name);\n    \n    $data_content['files'] = array();\n    if (!empty($data_content['tabs'])) {\n        // Download tai lieu san pham\n        if ($pro_config['download_active']) {\n            $result = $db->query('SELECT id, ' . NV_LANG_DATA . '_title title, ' . NV_LANG_DATA . '_description description, path, filesize, extension, download_groups FROM ' . $db_config['prefix'] . '_' . $module_data . '_files WHERE id IN (SELECT id_files FROM ' . $db_config['prefix'] . '_' . $module_data . '_files_rows WHERE id_rows=' . $data_content['id'] . ')');\n            while ($row = $result->fetch()) {\n                $row['filesize'] = !empty($row['filesize']) ? nv_convertfromBytes($row['filesize']) : $lang_module['download_file_unknown'];\n                $data_content['files'][] = $row;\n            }\n        }\n    }\n    \n    // Danh gia - Phan hoi\n    $rating_total = 0;\n    $result = $db->query('SELECT rating FROM ' . $db_config['prefix'] . '_' . $module_data . '_review WHERE product_id = ' . $data_content['id'] . ' AND status=1');\n    $rating_count = $result->rowCount();\n    if ($rating_count > 0) {\n        while (list ($rating) = $result->fetch(3)) {\n            $rating_total += $rating;\n        }\n    }\n    $data_content['rating_total'] = $rating_count;\n    $data_content['rating_point'] = $rating_total;\n    $data_content['rating_value'] = $rating_count > 0 ? round($rating_total / $rating_count) : 0;\n    \n    // Xac dinh anh lon\n    $homeimgfile = $data_content['homeimgfile'];\n    if ($data_content['homeimgthumb'] == 1) {\n        // image thumb\n        $data_content['homeimgthumb'] = NV_BASE_SITEURL . NV_FILES_DIR . '/' . $module_upload . '/' . $homeimgfile;\n        $data_content['homeimgfile'] = NV_BASE_SITEURL . NV_UPLOADS_DIR . '/' . $module_upload . '/' . $homeimgfile;\n    } elseif ($data_content['homeimgthumb'] == 2) {\n        // image file\n        $data_content['homeimgthumb'] = $data_content['homeimgfile'] = NV_BASE_SITEURL . NV_UPLOADS_DIR . '/' . $module_upload . '/' . $homeimgfile;\n    } elseif ($data_content['homeimgthumb'] == 3) {\n        // image url\n        $data_content['homeimgthumb'] = $data_content['homeimgfile'] = $homeimgfile;\n    } else {\n        // no image\n        $data_content['homeimgthumb'] = NV_BASE_SITEURL . 'themes/' . $module_info['template'] . '/images/' . $module_file . '/no-image.jpg';\n    }\n    \n    // Tu khoa\n    $array_keyword = array();\n    $key_words = array();\n    $_query = $db->query('SELECT a1.keyword keyword, a2.alias alias FROM ' . $db_config['prefix'] . '_' . $module_data . '_tags_id_' . NV_LANG_DATA . ' a1 INNER JOIN ' . $db_config['prefix'] . '_' . $module_data . '_tags_' . NV_LANG_DATA . ' a2 ON a1.tid=a2.tid WHERE a1.id=' . $data_content['id']);\n    while ($row = $_query->fetch()) {\n        $array_keyword[] = $row;\n        $key_words[] = $row['keyword'];\n    }\n    $key_words = !empty($key_words) ? implode(',', $key_words) : '';\n    \n    // metatag image facebook\n    $meta_property['og:image'] = NV_MY_DOMAIN . $data_content['homeimgfile'];\n    \n    // Fetch Limit\n    $db->sqlreset()\n        ->select(' id, listcatid, ' . NV_LANG_DATA . '_title, ' . NV_LANG_DATA . '_alias, homeimgfile, homeimgthumb, addtime, publtime, product_code, product_number, product_price, price_config, money_unit, discount_id, showprice, ' . NV_LANG_DATA . '_hometext,' . NV_LANG_DATA . '_gift_content, gift_from, gift_to')\n        ->from($db_config['prefix'] . '_' . $module_data . '_rows')\n        ->where('id!=' . $id . ' AND listcatid = ' . $data_content['listcatid'] . ' AND status=1')\n        ->order('ID DESC')\n        ->limit($pro_config['per_row'] * 2);\n    $result = $db->query($db->sql());\n    \n    $data_others = array();\n    while (list ($_id, $listcatid, $title, $alias, $homeimgfile, $homeimgthumb, $addtime, $publtime, $product_code, $product_number, $product_price, $price_config, $money_unit, $discount_id, $showprice, $hometext, $gift_content, $gift_from, $gift_to) = $result->fetch(3)) {\n        if ($homeimgthumb == 1) {\n            // image thumb\n            $thumb = NV_BASE_SITEURL . NV_FILES_DIR . '/' . $module_upload . '/' . $homeimgfile;\n        } elseif ($homeimgthumb == 2) {\n            // image file\n            $thumb = NV_BASE_SITEURL . NV_UPLOADS_DIR . '/' . $module_upload . '/' . $homeimgfile;\n        } elseif ($homeimgthumb == 3) {\n            // image url\n            $thumb = $homeimgfile;\n        } else {\n            // no image\n            $thumb = NV_BASE_SITEURL . 'themes/' . $module_info['template'] . '/images/' . $module_file . '/no-image.jpg';\n        }\n        \n        $data_others[] = array(\n            'id' => $_id,\n            'listcatid' => $listcatid,\n            'title' => $title,\n            'alias' => $alias,\n            'publtime' => $publtime,\n            'homeimgthumb' => $thumb,\n            'hometext' => $hometext,\n            'addtime' => $addtime,\n            'product_code' => $product_code,\n            'product_number' => $product_number,\n            'product_price' => $product_price,\n            'price_config' => $price_config,\n            'discount_id' => $discount_id,\n            'money_unit' => $money_unit,\n            'showprice' => $showprice,\n            'newday' => $global_array_shops_cat[$data_content['listcatid']]['newday'],\n            'gift_content' => $gift_content,\n            'gift_from' => $gift_from,\n            'gift_to' => $gift_to,\n            'link_pro' => NV_BASE_SITEURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&amp;' . NV_NAME_VARIABLE . '=' . $module_name . '&amp;' . NV_OP_VARIABLE . '=' . $global_array_shops_cat[$data_content['listcatid']]['alias'] . '/' . $alias . $global_config['rewrite_exturl'],\n            'link_order' => NV_BASE_SITEURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&amp;' . NV_NAME_VARIABLE . '=' . $module_name . '&amp;' . NV_OP_VARIABLE . '=setcart&amp;id=' . $_id\n        );\n    }\n    \n    $array_other_view = array();\n    if (!empty($_SESSION[$module_data . '_proview'])) {\n        $arrid = array();\n        foreach ($_SESSION[$module_data . '_proview'] as $id_i => $data_i) {\n            if ($id_i != $id) {\n                $arrid[] = $id_i;\n            }\n        }\n        $arrtempid = implode(',', $arrid);\n        if (!empty($arrtempid)) {\n            // Fetch Limit\n            $db->sqlreset()\n                ->select('id, listcatid, ' . NV_LANG_DATA . '_title, ' . NV_LANG_DATA . '_alias, homeimgfile, homeimgthumb, addtime, publtime, product_code, product_number, product_price, money_unit, discount_id, showprice, ' . NV_LANG_DATA . '_hometext,' . NV_LANG_DATA . '_gift_content, gift_from, gift_to')\n                ->from($db_config['prefix'] . '_' . $module_data . '_rows')\n                ->where('id IN ( ' . $arrtempid . ') AND status=1')\n                ->order('id DESC')\n                ->limit($pro_config['per_row'] * 2);\n            $result = $db->query($db->sql());\n            while (list ($_id, $listcatid, $title, $alias, $homeimgfile, $homeimgthumb, $addtime, $publtime, $product_code, $product_number, $product_price, $money_unit, $discount_id, $showprice, $hometext, $gift_content, $gift_from, $gift_to) = $result->fetch(3)) {\n                if ($homeimgthumb == 1) {\n                    // image thumb\n                    $thumb = NV_BASE_SITEURL . NV_FILES_DIR . '/' . $module_upload . '/' . $homeimgfile;\n                } elseif ($homeimgthumb == 2) {\n                    // image file\n                    $thumb = NV_BASE_SITEURL . NV_UPLOADS_DIR . '/' . $module_upload . '/' . $homeimgfile;\n                } elseif ($homeimgthumb == 3) {\n                    // image url\n                    $thumb = $homeimgfile;\n                } else {\n                    // no image\n                    $thumb = NV_BASE_SITEURL . 'themes/' . $module_info['template'] . '/images/' . $module_file . '/no-image.jpg';\n                }\n                \n                $array_other_view[] = array(\n                    'id' => $_id,\n                    'listcatid' => $listcatid,\n                    'title' => $title,\n                    'alias' => $alias,\n                    'publtime' => $publtime,\n                    'homeimgthumb' => $thumb,\n                    'hometext' => $hometext,\n                    'addtime' => $addtime,\n                    'product_code' => $product_code,\n                    'product_number' => $product_number,\n                    'product_price' => $product_price,\n                    'discount_id' => $discount_id,\n                    'money_unit' => $money_unit,\n                    'showprice' => $showprice,\n                    'newday' => $global_array_shops_cat[$data_content['listcatid']]['newday'],\n                    'gift_content' => $gift_content,\n                    'gift_from' => $gift_from,\n                    'gift_to' => $gift_to,\n                    'link_pro' => NV_BASE_SITEURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&amp;' . NV_NAME_VARIABLE . '=' . $module_name . '&amp;' . NV_OP_VARIABLE . '=' . $global_array_shops_cat[$data_content['listcatid']]['alias'] . '/' . $alias . $global_config['rewrite_exturl'],\n                    'link_order' => NV_BASE_SITEURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&amp;' . NV_NAME_VARIABLE . '=' . $module_name . '&amp;' . NV_OP_VARIABLE . '=setcart&amp;id=' . $_id\n                );\n            }\n        }\n    }\n    \n    SetSessionProView($data_content['id'], $data_content[NV_LANG_DATA . '_title'], $data_content[NV_LANG_DATA . '_alias'], $data_content['addtime'], NV_BASE_SITEURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&' . NV_NAME_VARIABLE . '=' . $module_name . '&' . NV_OP_VARIABLE . '=' . $global_array_shops_cat[$catid]['alias'] . '/' . $data_content[NV_LANG_DATA . '_alias'] . '-' . $data_content['id'], $data_content['homeimgthumb']);\n    \n    // comment\n    if (isset($site_mods['comment']) and isset($module_config[$module_name]['activecomm'])) {\n        define('NV_COMM_ID', $data_content['id']); // ID b\u00e0i vi\u1ebft ho\u1eb7c\n        define('NV_COMM_AREA', $module_info['funcs'][$op]['func_id']); // \u0111\u1ec3 \u0111\u00e1p \u1ee9ng comment \u1edf b\u1ea5t c\u1ee9 \u0111\u00e2u kh\u00f4ng c\u1ee9 l\u00e0 b\u00e0i vi\u1ebft\n        // check allow comemnt\n        $allowed = $module_config[$module_name]['allowed_comm']; // tuy v\u00e0o module \u0111\u1ec3 l\u1ea5y c\u1ea5u h\u00ecnh. N\u1ebfu l\u00e0 module news th\u00ec c\u00f3 c\u1ea5u h\u00ecnh theo b\u00e0i vi\u1ebft\n        if ($allowed == '-1') {\n            $allowed = $data_content['allowed_comm'];\n        }\n        define('NV_PER_PAGE_COMMENT', 5); // S\u1ed1 b\u1ea3n ghi hi\u1ec3n th\u1ecb b\u00ecnh lu\u1eadn\n        require_once NV_ROOTDIR . '/modules/comment/comment.php';\n        $area = (defined('NV_COMM_AREA')) ? NV_COMM_AREA : 0;\n        $checkss = md5($module_name . '-' . $area . '-' . NV_COMM_ID . '-' . $allowed . '-' . NV_CACHE_PREFIX);\n        \n        $content_comment = nv_comment_module($module_name, $checkss, $area, NV_COMM_ID, $allowed, 1);\n    } else {\n        $content_comment = '';\n    }\n    \n    $contents = detail_product($data_content, $data_unit, $data_others, $array_other_view, $content_comment, $compare_id, $popup, $idtemplate, $array_keyword);\n} else {\n    $nv_redirect = NV_BASE_SITEURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&amp;' . NV_NAME_VARIABLE . '=' . $module_name;\n    redict_link($lang_module['detail_no_permission'], $lang_module['redirect_to_back_shops'], $nv_redirect);\n}\n\nif ($popup) {\n    echo $contents;\n} else {\n    include NV_ROOTDIR . '/includes/header.php';\n    echo nv_site_theme($contents);\n    include NV_ROOTDIR . '/includes/footer.php';\n}", "<?php\n\n/**\n * @Project NUKEVIET 4.x\n * @Author VINADES.,JSC (contact@vinades.vn)\n * @Copyright (C) 2017 VINADES.,JSC. All rights reserved\n * @License GNU/GPL version 2 or any later version\n * @Createdate 04/18/2017 09:47\n */\n\nif (! defined('NV_IS_MOD_SHOPS')) {\n    die('Stop!!!');\n}\n\n$page_title = $module_info['custom_title'];\n$key_words = $module_info['keywords'];\n\n$bid = 1;\n// block host\n$num = $pro_config['per_page'];\n$data_content = array();\n$search = \"\";\n$url = '';\n\n$keyword = $nv_Request->get_string('keyword', 'get');\n$keyword = str_replace('+', ' ', $keyword);\n$kwhtml = nv_htmlspecialchars($keyword);\n$price1_temp = $nv_Request->get_string('price1', 'get', '');\n$price2_temp = $nv_Request->get_string('price2', 'get', '');\n$typemoney = $nv_Request->get_string('typemoney', 'get', '');\n$cataid = $nv_Request->get_int('cata', 'get', 0);\n$groupid = $nv_Request->get_string('filter', 'get', '');\n$group_price = $nv_Request->get_string('group_price', 'get', '');\nif (! empty($group_price)) {\n    $url .= '&group_price=' . $group_price;\n    $group_price = nv_base64_decode($group_price);\n    $group_price = unserialize($group_price);\n    if (!empty($group_price)) {\n        $search .= \" AND\";\n        foreach ($group_price as $i => $group_price_i) {\n            $group_price_i = explode('-', $group_price_i);\n            if ($group_price_i[0] <= $group_price_i[1]) {\n                $search .= ($i > 0 ? \" OR \" : \"\") . \" product_price BETWEEN \" . $group_price_i[0] . \" AND \" . $group_price_i[1] . \" \";\n            } else {\n                $search .= ($i > 0 ? \" OR \" : \"\") . \" product_price > \" . $group_price_i[0] . \" \";\n            }\n        }\n    }\n}\n\n$sid = $nv_Request->get_int('sid', 'get', 0);\n$page = $nv_Request->get_int('page', 'get', 1);\n$num_items = 0;\n\n$compare_id = $nv_Request->get_string($module_data . '_compare_id', 'session', '');\n$compare_id = unserialize($compare_id);\n\nif ($price1_temp == '') {\n    $price1 = - 1;\n} else {\n    $price1 = floatval($price1_temp);\n}\nif ($price2_temp == '') {\n    $price2 = - 1;\n} else {\n    $price2 = floatval($price2_temp);\n}\n\n// Set data form search\n$xtpl = new XTemplate(\"search_all.tpl\", NV_ROOTDIR . \"/themes/\" . $module_info['template'] . \"/modules/\" . $module_file);\n$xtpl->assign('LANG', $lang_module);\n$xtpl->assign('NV_BASE_SITEURL', NV_BASE_SITEURL);\nforeach ($global_array_shops_cat as $row) {\n    $xtitle_i = \"\";\n    if ($row['lev'] > 0) {\n        $xtitle_i .= \"&nbsp;&nbsp;&nbsp;\";\n        for ($i = 1; $i <= $row['lev']; $i++) {\n            $xtitle_i .= \"&nbsp;&nbsp;&nbsp;\";\n        }\n        $xtitle_i .= \"&nbsp;\";\n    }\n    $row['xtitle'] = $xtitle_i . $row['title'];\n    $row['selected'] = ($cataid == $row['catid']) ? \"selected=\\\"selected\\\"\" : \"\";\n    $xtpl->assign('ROW', $row);\n    $xtpl->parse('form.loopcata');\n}\n\n// Get money\n$sql = \"SELECT code,currency FROM \" . $db_config['prefix'] . \"_\" . $module_data . \"_money_\" . NV_LANG_DATA;\n$result = $db->query($sql);\n\nwhile ($row = $result->fetch()) {\n    $row['selected'] = ($typemoney == $row['code']) ? \"selected=\\\"selected\\\"\" : \"\";\n    $xtpl->assign('ROW', $row);\n    $xtpl->parse('form.typemoney');\n}\n\nif ($price1 == - 1) {\n    $price1_temp = \"\";\n}\nif ($price2 == - 1) {\n    $price2_temp = \"\";\n}\n\n$xtpl->assign('value_keyword', $keyword);\n$xtpl->assign('value_price1', $price1_temp);\n$xtpl->assign('value_price2', $price2_temp);\n\nif ($pro_config['active_price']) {\n    $xtpl->parse('form.price');\n}\n\n$xtpl->parse('form');\n$contents = $xtpl->text('form');\n\nif (! empty($groupid)) {\n    $url .= '&filter=' . $groupid;\n    $groupid = nv_base64_decode($groupid);\n    $groupid = unserialize($groupid);\n\n    $arr_id = array();\n    foreach ($groupid as $id_group) {\n        $group = $global_array_group[$id_group];\n        $arr_id[$group['parentid']][] = $id_group;\n    }\n\n    $_sql = 'SELECT DISTINCT pro_id FROM ' . $db_config['prefix'] . '_' . $module_data . '_group_items WHERE ';\n    $j = 1;\n    foreach ($arr_id as $listid) {\n        $a = sizeof($listid);\n        if ($a > 0) {\n            $arr_sql = array();\n            for ($i = 0; $i < $a; $i++) {\n                $arr_sql[]= ' pro_id IN (SELECT pro_id FROM ' . $db_config['prefix'] . '_' . $module_data . '_group_items WHERE group_id=' . $listid[$i] . ')';\n            }\n            $_sql .= ' ('. implode(' OR ', $arr_sql) . ')';\n        }\n        if ($j < count($arr_id)) {\n            $_sql .= ' AND ';\n        }\n        $j++;\n    }\n    if (!empty($_sql)) {\n        $search .= \" AND t1.id IN(\" . $_sql . \")\";\n    }\n}\n\nif ($keyword != \"\") {\n    $search .= \" AND (t1.\" . NV_LANG_DATA . \"_title LIKE '%\" . $db->dblikeescape($kwhtml) . \"%' OR product_code LIKE '%\" . $db->dblikeescape($keyword) . \"%')\";\n}\n\nif (($price1 >= 0 and $price2 > 0)) {\n    $search .= \" AND product_price BETWEEN \" . $price1 . \" AND \" . $price2 . \" \";\n} elseif ($price2 == - 1 and $price1 >= 0) {\n    $search .= \" AND product_price >= \" . $price1 . \" \";\n} elseif ($price1 == - 1 and $price2 > 0) {\n    $search .= \" AND product_price < \" . $price2 . \" \";\n}\n\nif (! empty($typemoney)) {\n    $search .= \" AND money_unit = \" . $db->quote($typemoney);\n}\n$sql_i = \", if(t1.money_unit ='\" . $pro_config['money_unit'] . \"', t1.product_price , t1.product_price * t2.exchange ) AS product_saleproduct \";\n$order_by = \" product_saleproduct DESC \";\n\nif (! empty($typemoney)) {\n    $search .= \" AND money_unit = \" . $db->quote($typemoney);\n}\nif ($cataid != 0) {\n    $array_cat = GetCatidInParent($cataid);\n    $search .= \" AND listcatid IN (\" . implode(\",\", $array_cat) . \") \";\n}\nif ($sid != 0) {\n    $search .= \" AND source_id =\" . $sid . \" \";\n}\n\nif (empty($search)) {\n    $contents = \"<div align =\\\"center\\\">\" . $lang_module['notresult'] . \"</div>\";\n    include NV_ROOTDIR . '/includes/header.php';\n    echo nv_site_theme($contents);\n    include NV_ROOTDIR . '/includes/footer.php';\n    exit();\n}\n\n$show_price = \"\";\nif ($pro_config['active_price']) {\n    if (! empty($price1_temp) or ! empty($price2_temp)) {\n        $show_price = \"AND showprice=1\";\n    }\n}\n\n$table_search = \"\" . $db_config['prefix'] . \"_\" . $module_data . \"_rows t1\";\n$table_exchange = \" LEFT JOIN \" . $db_config['prefix'] . \"_\" . $module_data . \"_money_\" . NV_LANG_DATA . \" t2 ON t1.money_unit=t2.code\";\n$table_exchange1 = \" INNER JOIN \" . $db_config['prefix'] . \"_\" . $module_data . \"_catalogs t3 ON t3.catid = t1.listcatid\";\n\n// Fetch Limit\n$db->sqlreset()->select('DISTINCT COUNT(*)')->from($table_search . \" \" . $table_exchange . \" \" . $table_exchange1)->where(\"t1.status =1 \" . $search . \" \" . $show_price);\n$sth = $db->prepare($db->sql());\n$sth->execute();\n\n$num_items = $sth->fetchColumn();\n\n$db->select(\"DISTINCT t1.id, t1.listcatid, t1.publtime, t1.\" . NV_LANG_DATA . \"_title, t1.\" . NV_LANG_DATA . \"_alias, t1.\" . NV_LANG_DATA . \"_hometext, t1.homeimgalt, t1.homeimgfile, t1.homeimgthumb, t1.product_number, t1.product_price, t1.discount_id, t1.money_unit, t1.showprice, t1.\" . NV_LANG_DATA . \"_gift_content, t1.gift_from, t1.gift_to, t3.newday, t2.exchange \" . $sql_i)\n    ->order($order_by)\n    ->limit($per_page)\n    ->offset(($page - 1) * $per_page);\n$result = $db->query($db->sql());\n\n$base_url = NV_BASE_SITEURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&' . NV_NAME_VARIABLE . '=' . $module_name . '&amp;' . NV_OP_VARIABLE . '=search_result&keyword=' . $keyword . '&price1=' . $price1 . '&price2=' . $price2 . '&typemoney=' . $typemoney . '&cata=' . $cataid . $url;\n$html_pages = nv_generate_page($base_url, $num_items, $per_page, $page);\n\n$link = NV_BASE_SITEURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&amp;' . NV_NAME_VARIABLE . '=' . $module_name . '&amp;' . NV_OP_VARIABLE . '=';\n\nwhile (list($id, $listcatid, $publtime, $title, $alias, $hometext, $homeimgalt, $homeimgfile, $homeimgthumb, $product_number, $product_price, $discount_id, $money_unit, $showprice, $gift_content, $gift_from, $gift_to, $newday) = $result->fetch(3)) {\n    if ($homeimgthumb == 1) {\n        //image thumb\n\n        $thumb = NV_BASE_SITEURL . NV_FILES_DIR . '/' . $module_upload . '/' . $homeimgfile;\n    } elseif ($homeimgthumb == 2) {\n        //image file\n\n        $thumb = NV_BASE_SITEURL . NV_UPLOADS_DIR . '/' . $module_upload . '/' . $homeimgfile;\n    } elseif ($homeimgthumb == 3) {\n        //image url\n\n        $thumb = $homeimgfile;\n    } else {\n        //no image\n\n        $thumb = NV_BASE_SITEURL . 'themes/' . $module_info['template'] . '/images/' . $module_file . '/no-image.jpg';\n    }\n\n    $data_content[] = array(\n        'id' => $id,\n        'listcatid' => $listcatid,\n        'publtime' => $publtime,\n        'title' => $title,\n        'alias' => $alias,\n        'hometext' => $hometext,\n        'homeimgalt' => $homeimgalt,\n        'homeimgthumb' => $thumb,\n        'product_number' => $product_number,\n        'product_price' => $product_price,\n        'discount_id' => $discount_id,\n        'money_unit' => $money_unit,\n        'showprice' => $showprice,\n        'gift_content' => $gift_content,\n        'gift_from' => $gift_from,\n        'gift_to' => $gift_to,\n        'newday' => $newday,\n        'link_pro' => $link . $global_array_shops_cat[$listcatid]['alias'] . '/' . $alias . $global_config['rewrite_exturl'],\n        'link_order' => $link . 'setcart&amp;id=' . $id\n    );\n}\n\nif (count($data_content) == 0) {\n    $contents .= \"<div align =\\\"center\\\">\" . $lang_module['notresult'] . \"</div>\";\n} else {\n    $contents .= view_search_all($data_content, $compare_id, $html_pages);\n}\n\ninclude NV_ROOTDIR . '/includes/header.php';\necho nv_site_theme($contents);\ninclude NV_ROOTDIR . '/includes/footer.php';\n"], "fixing_code": ["<?php\n\n/**\n * @Project NUKEVIET 4.x\n * @Author VINADES.,JSC (contact@vinades.vn)\n * @Copyright (C) 2017 VINADES.,JSC. All rights reserved\n * @License GNU/GPL version 2 or any later version\n * @Createdate 04/18/2017 09:47\n */\n\nif (!defined('NV_IS_MOD_SHOPS')) {\n    die('Stop!!!');\n}\n\nif ($nv_Request->isset_request('check_quantity', 'post')) {\n    $id_pro = $nv_Request->get_int('id_pro', 'post', 0);\n    $unit = $nv_Request->get_string('pro_unit', 'post', '');\n    $listid = $nv_Request->get_string('listid', 'post');\n    $listid = array_map('intval', explode(',', $listid));\n    asort($listid);\n\n    $quantity = $db->query('SELECT quantity FROM ' . $db_config['prefix'] . '_' . $module_data . '_group_quantity WHERE pro_id = ' . $id_pro . ' AND listgroup=\"' . implode(',', $listid) . '\"')->fetchColumn();\n    if (empty($quantity)) {\n        $sum = 0;\n        $count = 0;\n        $listgroupid = GetGroupID($id_pro, 1);\n        if (!empty($listgroupid) and !empty($global_array_group)) {\n            foreach ($listgroupid as $gid => $subid) {\n                $parent_info = $global_array_group[$gid];\n                if ($parent_info['in_order']) {\n                    $count++;\n                }\n            }\n        }\n\n        $result = $db->query('SELECT listgroup, quantity FROM ' . $db_config['prefix'] . '_' . $module_data . '_group_quantity WHERE pro_id = ' . $id_pro);\n        while (list ($listgroup, $quantity) = $result->fetch(3)) {\n            $listgroup = explode(',', $listgroup);\n            $_t = 0;\n            foreach ($listgroup as $_idgroup) {\n                if (in_array($_idgroup, $listid)) {\n                    $_t = $_t + 1;\n                }\n            }\n            if ($_t == sizeof($listid) or empty($listid)) {\n                $sum += $quantity;\n            }\n        }\n\n        if ($sum == 0 or $count == sizeof($listid)) {\n            die('NO_0_' . $lang_module['product_empty']);\n        } else {\n            die('NO_0_' . $lang_module['detail_pro_number'] . ': ' . $sum . ' ' . $unit);\n        }\n    } else {\n        die('OK_' . $quantity . '_' . $lang_module['detail_pro_number'] . ': ' . $quantity . ' ' . $unit);\n    }\n}\n\n$compare_id = $nv_Request->get_string($module_data . '_compare_id', 'session', '');\n$compare_id = unserialize($compare_id);\n\n// Thiet lap quyen xem chi tiet\n$contents = '';\n$publtime = 0;\n\n$sql = $db->query('SELECT * FROM ' . $db_config['prefix'] . '_' . $module_data . '_rows WHERE ' . NV_LANG_DATA . '_alias = ' . $db->quote($alias_url) . ' AND status=1');\n$data_content = $sql->fetch();\nif (empty($data_content)) {\n    $nv_redirect = NV_BASE_SITEURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&amp;' . NV_NAME_VARIABLE . '=' . $module_name;\n    redict_link($lang_module['detail_do_not_view'], $lang_module['redirect_to_back_shops'], $nv_redirect);\n}\n$id = $data_content['id'];\n\n$data_content['array_custom'] = array();\n$data_content['array_custom_lang'] = array();\n$data_content['template'] = '';\n$idtemplate = 0;\n\nif ($global_array_shops_cat[$data_content['listcatid']]['form'] != '') {\n    $idtemplate = $db->query('SELECT id FROM ' . $db_config['prefix'] . '_' . $module_data . '_template where alias = \"' . preg_replace(\"/[\\_]/\", \"-\", $global_array_shops_cat[$data_content['listcatid']]['form']) . '\"')->fetchColumn();\n    if ($idtemplate) {\n        $listfield = array();\n        $array_tmp = array();\n        $result = $db->query('SELECT * FROM ' . $db_config['prefix'] . '_' . $module_data . '_field ORDER BY weight');\n        while ($row = $result->fetch()) {\n            $listtemplate = explode('|', $row['listtemplate']);\n            if (in_array($idtemplate, $listtemplate)) {\n                $listfield[] = $row['fid'];\n                $array_tmp[$row['field']] = unserialize($row['language']);\n            }\n        }\n\n        if (!empty($listfield)) {\n            $result = $db->query('SELECT t1.field_value, t2.field FROM ' . $db_config['prefix'] . \"_\" . $module_data . \"_field_value_\" . NV_LANG_DATA . ' t1 INNER JOIN ' . $db_config['prefix'] . '_' . $module_data . '_field t2 WHERE t1.field_id=t2.fid AND t1.rows_id=' . $id);\n            $data_content['template'] = $global_array_shops_cat[$data_content['listcatid']]['form'];\n            while ($row = $result->fetch()) {\n                $data_content['array_custom'][$row['field']] = $row['field_value'];\n            }\n\n            if (!empty($array_tmp)) {\n                foreach ($array_tmp as $f_key => $field) {\n                    foreach ($field as $key_lang => $lang_data) {\n                        if ($key_lang == NV_LANG_DATA) {\n                            $data_content['array_custom_lang'][$f_key] = $lang_data[0];\n                        }\n                    }\n                }\n                unset($array_tmp);\n            }\n        }\n    }\n}\n\n$page_title = !empty($data_content[NV_LANG_DATA . '_tag_title']) ? $data_content[NV_LANG_DATA . '_tag_title'] : $data_content[NV_LANG_DATA . '_title'];\n$description = !empty($data_content[NV_LANG_DATA . '_tag_description']) ? $data_content[NV_LANG_DATA . '_tag_description'] : $data_content[NV_LANG_DATA . '_hometext'];\n\nif (nv_user_in_groups($global_array_shops_cat[$catid]['groups_view'])) {\n    $popup = $nv_Request->get_int('popup', 'post,get', 0);\n\n    $time_set = $nv_Request->get_int($module_data . '_' . $op . '_' . $id, 'session');\n    if (empty($time_set)) {\n        $nv_Request->set_Session($module_data . '_' . $op . '_' . $id, NV_CURRENTTIME);\n        $sql = 'UPDATE ' . $db_config['prefix'] . '_' . $module_data . '_rows SET hitstotal=hitstotal+1 WHERE id=' . $id;\n        $db->query($sql);\n    }\n\n    $catid = $data_content['listcatid'];\n    $base_url_rewrite = nv_url_rewrite(NV_BASE_SITEURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&amp;' . NV_NAME_VARIABLE . '=' . $module_name . '&amp;' . NV_OP_VARIABLE . '=' . $global_array_shops_cat[$catid]['alias'] . '/' . $data_content[NV_LANG_DATA . '_alias'] . $global_config['rewrite_exturl'], true);\n\n    if ($_SERVER['REQUEST_URI'] != $base_url_rewrite and !$popup) {\n        Header('Location: ' . $base_url_rewrite);\n        die();\n    }\n\n    // Lay don vi san pham\n    $sql = $db->query('SELECT * FROM ' . $db_config['prefix'] . '_' . $module_data . '_units WHERE id = ' . $data_content['product_unit']);\n    $data_unit = $sql->fetch();\n    $data_unit['title'] = $data_unit[NV_LANG_DATA . '_title'];\n\n    // Hien thi tabs\n    $sql = 'SELECT * FROM ' . $db_config['prefix'] . '_' . $module_data . '_tabs where active=1 ORDER BY weight ASC';\n    $data_content['tabs'] = $nv_Cache->db($sql, 'id', $module_name);\n\n    $data_content['files'] = array();\n    if (!empty($data_content['tabs'])) {\n        // Download tai lieu san pham\n        if ($pro_config['download_active']) {\n            $result = $db->query('SELECT id, ' . NV_LANG_DATA . '_title title, ' . NV_LANG_DATA . '_description description, path, filesize, extension, download_groups FROM ' . $db_config['prefix'] . '_' . $module_data . '_files WHERE id IN (SELECT id_files FROM ' . $db_config['prefix'] . '_' . $module_data . '_files_rows WHERE id_rows=' . $data_content['id'] . ')');\n            while ($row = $result->fetch()) {\n                $row['filesize'] = !empty($row['filesize']) ? nv_convertfromBytes($row['filesize']) : $lang_module['download_file_unknown'];\n                $data_content['files'][] = $row;\n            }\n        }\n    }\n\n    // Danh gia - Phan hoi\n    $rating_total = 0;\n    $result = $db->query('SELECT rating FROM ' . $db_config['prefix'] . '_' . $module_data . '_review WHERE product_id = ' . $data_content['id'] . ' AND status=1');\n    $rating_count = $result->rowCount();\n    if ($rating_count > 0) {\n        while (list ($rating) = $result->fetch(3)) {\n            $rating_total += $rating;\n        }\n    }\n    $data_content['rating_total'] = $rating_count;\n    $data_content['rating_point'] = $rating_total;\n    $data_content['rating_value'] = $rating_count > 0 ? round($rating_total / $rating_count) : 0;\n\n    // Xac dinh anh lon\n    $homeimgfile = $data_content['homeimgfile'];\n    if ($data_content['homeimgthumb'] == 1) {\n        // image thumb\n        $data_content['homeimgthumb'] = NV_BASE_SITEURL . NV_FILES_DIR . '/' . $module_upload . '/' . $homeimgfile;\n        $data_content['homeimgfile'] = NV_BASE_SITEURL . NV_UPLOADS_DIR . '/' . $module_upload . '/' . $homeimgfile;\n    } elseif ($data_content['homeimgthumb'] == 2) {\n        // image file\n        $data_content['homeimgthumb'] = $data_content['homeimgfile'] = NV_BASE_SITEURL . NV_UPLOADS_DIR . '/' . $module_upload . '/' . $homeimgfile;\n    } elseif ($data_content['homeimgthumb'] == 3) {\n        // image url\n        $data_content['homeimgthumb'] = $data_content['homeimgfile'] = $homeimgfile;\n    } else {\n        // no image\n        $data_content['homeimgthumb'] = NV_BASE_SITEURL . 'themes/' . $module_info['template'] . '/images/' . $module_file . '/no-image.jpg';\n    }\n\n    // Tu khoa\n    $array_keyword = array();\n    $key_words = array();\n    $_query = $db->query('SELECT a1.keyword keyword, a2.alias alias FROM ' . $db_config['prefix'] . '_' . $module_data . '_tags_id_' . NV_LANG_DATA . ' a1 INNER JOIN ' . $db_config['prefix'] . '_' . $module_data . '_tags_' . NV_LANG_DATA . ' a2 ON a1.tid=a2.tid WHERE a1.id=' . $data_content['id']);\n    while ($row = $_query->fetch()) {\n        $array_keyword[] = $row;\n        $key_words[] = $row['keyword'];\n    }\n    $key_words = !empty($key_words) ? implode(',', $key_words) : '';\n\n    // metatag image facebook\n    $meta_property['og:image'] = NV_MY_DOMAIN . $data_content['homeimgfile'];\n\n    // Fetch Limit\n    $db->sqlreset()\n        ->select(' id, listcatid, ' . NV_LANG_DATA . '_title, ' . NV_LANG_DATA . '_alias, homeimgfile, homeimgthumb, addtime, publtime, product_code, product_number, product_price, price_config, money_unit, discount_id, showprice, ' . NV_LANG_DATA . '_hometext,' . NV_LANG_DATA . '_gift_content, gift_from, gift_to')\n        ->from($db_config['prefix'] . '_' . $module_data . '_rows')\n        ->where('id!=' . $id . ' AND listcatid = ' . $data_content['listcatid'] . ' AND status=1')\n        ->order('ID DESC')\n        ->limit($pro_config['per_row'] * 2);\n    $result = $db->query($db->sql());\n\n    $data_others = array();\n    while (list ($_id, $listcatid, $title, $alias, $homeimgfile, $homeimgthumb, $addtime, $publtime, $product_code, $product_number, $product_price, $price_config, $money_unit, $discount_id, $showprice, $hometext, $gift_content, $gift_from, $gift_to) = $result->fetch(3)) {\n        if ($homeimgthumb == 1) {\n            // image thumb\n            $thumb = NV_BASE_SITEURL . NV_FILES_DIR . '/' . $module_upload . '/' . $homeimgfile;\n        } elseif ($homeimgthumb == 2) {\n            // image file\n            $thumb = NV_BASE_SITEURL . NV_UPLOADS_DIR . '/' . $module_upload . '/' . $homeimgfile;\n        } elseif ($homeimgthumb == 3) {\n            // image url\n            $thumb = $homeimgfile;\n        } else {\n            // no image\n            $thumb = NV_BASE_SITEURL . 'themes/' . $module_info['template'] . '/images/' . $module_file . '/no-image.jpg';\n        }\n\n        $data_others[] = array(\n            'id' => $_id,\n            'listcatid' => $listcatid,\n            'title' => $title,\n            'alias' => $alias,\n            'publtime' => $publtime,\n            'homeimgthumb' => $thumb,\n            'hometext' => $hometext,\n            'addtime' => $addtime,\n            'product_code' => $product_code,\n            'product_number' => $product_number,\n            'product_price' => $product_price,\n            'price_config' => $price_config,\n            'discount_id' => $discount_id,\n            'money_unit' => $money_unit,\n            'showprice' => $showprice,\n            'newday' => $global_array_shops_cat[$data_content['listcatid']]['newday'],\n            'gift_content' => $gift_content,\n            'gift_from' => $gift_from,\n            'gift_to' => $gift_to,\n            'link_pro' => NV_BASE_SITEURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&amp;' . NV_NAME_VARIABLE . '=' . $module_name . '&amp;' . NV_OP_VARIABLE . '=' . $global_array_shops_cat[$data_content['listcatid']]['alias'] . '/' . $alias . $global_config['rewrite_exturl'],\n            'link_order' => NV_BASE_SITEURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&amp;' . NV_NAME_VARIABLE . '=' . $module_name . '&amp;' . NV_OP_VARIABLE . '=setcart&amp;id=' . $_id\n        );\n    }\n\n    $array_other_view = array();\n    if (!empty($_SESSION[$module_data . '_proview'])) {\n        $arrid = array();\n        foreach ($_SESSION[$module_data . '_proview'] as $id_i => $data_i) {\n            if ($id_i != $id) {\n                $arrid[] = $id_i;\n            }\n        }\n        $arrtempid = implode(',', $arrid);\n        if (!empty($arrtempid)) {\n            // Fetch Limit\n            $db->sqlreset()\n                ->select('id, listcatid, ' . NV_LANG_DATA . '_title, ' . NV_LANG_DATA . '_alias, homeimgfile, homeimgthumb, addtime, publtime, product_code, product_number, product_price, money_unit, discount_id, showprice, ' . NV_LANG_DATA . '_hometext,' . NV_LANG_DATA . '_gift_content, gift_from, gift_to')\n                ->from($db_config['prefix'] . '_' . $module_data . '_rows')\n                ->where('id IN ( ' . $arrtempid . ') AND status=1')\n                ->order('id DESC')\n                ->limit($pro_config['per_row'] * 2);\n            $result = $db->query($db->sql());\n            while (list ($_id, $listcatid, $title, $alias, $homeimgfile, $homeimgthumb, $addtime, $publtime, $product_code, $product_number, $product_price, $money_unit, $discount_id, $showprice, $hometext, $gift_content, $gift_from, $gift_to) = $result->fetch(3)) {\n                if ($homeimgthumb == 1) {\n                    // image thumb\n                    $thumb = NV_BASE_SITEURL . NV_FILES_DIR . '/' . $module_upload . '/' . $homeimgfile;\n                } elseif ($homeimgthumb == 2) {\n                    // image file\n                    $thumb = NV_BASE_SITEURL . NV_UPLOADS_DIR . '/' . $module_upload . '/' . $homeimgfile;\n                } elseif ($homeimgthumb == 3) {\n                    // image url\n                    $thumb = $homeimgfile;\n                } else {\n                    // no image\n                    $thumb = NV_BASE_SITEURL . 'themes/' . $module_info['template'] . '/images/' . $module_file . '/no-image.jpg';\n                }\n\n                $array_other_view[] = array(\n                    'id' => $_id,\n                    'listcatid' => $listcatid,\n                    'title' => $title,\n                    'alias' => $alias,\n                    'publtime' => $publtime,\n                    'homeimgthumb' => $thumb,\n                    'hometext' => $hometext,\n                    'addtime' => $addtime,\n                    'product_code' => $product_code,\n                    'product_number' => $product_number,\n                    'product_price' => $product_price,\n                    'discount_id' => $discount_id,\n                    'money_unit' => $money_unit,\n                    'showprice' => $showprice,\n                    'newday' => $global_array_shops_cat[$data_content['listcatid']]['newday'],\n                    'gift_content' => $gift_content,\n                    'gift_from' => $gift_from,\n                    'gift_to' => $gift_to,\n                    'link_pro' => NV_BASE_SITEURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&amp;' . NV_NAME_VARIABLE . '=' . $module_name . '&amp;' . NV_OP_VARIABLE . '=' . $global_array_shops_cat[$data_content['listcatid']]['alias'] . '/' . $alias . $global_config['rewrite_exturl'],\n                    'link_order' => NV_BASE_SITEURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&amp;' . NV_NAME_VARIABLE . '=' . $module_name . '&amp;' . NV_OP_VARIABLE . '=setcart&amp;id=' . $_id\n                );\n            }\n        }\n    }\n\n    SetSessionProView($data_content['id'], $data_content[NV_LANG_DATA . '_title'], $data_content[NV_LANG_DATA . '_alias'], $data_content['addtime'], NV_BASE_SITEURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&' . NV_NAME_VARIABLE . '=' . $module_name . '&' . NV_OP_VARIABLE . '=' . $global_array_shops_cat[$catid]['alias'] . '/' . $data_content[NV_LANG_DATA . '_alias'] . '-' . $data_content['id'], $data_content['homeimgthumb']);\n\n    // comment\n    if (isset($site_mods['comment']) and isset($module_config[$module_name]['activecomm'])) {\n        define('NV_COMM_ID', $data_content['id']); // ID b\u00e0i vi\u1ebft ho\u1eb7c\n        define('NV_COMM_AREA', $module_info['funcs'][$op]['func_id']); // \u0111\u1ec3 \u0111\u00e1p \u1ee9ng comment \u1edf b\u1ea5t c\u1ee9 \u0111\u00e2u kh\u00f4ng c\u1ee9 l\u00e0 b\u00e0i vi\u1ebft\n        // check allow comemnt\n        $allowed = $module_config[$module_name]['allowed_comm']; // tuy v\u00e0o module \u0111\u1ec3 l\u1ea5y c\u1ea5u h\u00ecnh. N\u1ebfu l\u00e0 module news th\u00ec c\u00f3 c\u1ea5u h\u00ecnh theo b\u00e0i vi\u1ebft\n        if ($allowed == '-1') {\n            $allowed = $data_content['allowed_comm'];\n        }\n        define('NV_PER_PAGE_COMMENT', 5); // S\u1ed1 b\u1ea3n ghi hi\u1ec3n th\u1ecb b\u00ecnh lu\u1eadn\n        require_once NV_ROOTDIR . '/modules/comment/comment.php';\n        $area = (defined('NV_COMM_AREA')) ? NV_COMM_AREA : 0;\n        $checkss = md5($module_name . '-' . $area . '-' . NV_COMM_ID . '-' . $allowed . '-' . NV_CACHE_PREFIX);\n\n        $content_comment = nv_comment_module($module_name, $checkss, $area, NV_COMM_ID, $allowed, 1);\n    } else {\n        $content_comment = '';\n    }\n\n    $contents = detail_product($data_content, $data_unit, $data_others, $array_other_view, $content_comment, $compare_id, $popup, $idtemplate, $array_keyword);\n} else {\n    $nv_redirect = NV_BASE_SITEURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&amp;' . NV_NAME_VARIABLE . '=' . $module_name;\n    redict_link($lang_module['detail_no_permission'], $lang_module['redirect_to_back_shops'], $nv_redirect);\n}\n\nif ($popup) {\n    echo $contents;\n} else {\n    include NV_ROOTDIR . '/includes/header.php';\n    echo nv_site_theme($contents);\n    include NV_ROOTDIR . '/includes/footer.php';\n}\n", "<?php\n\n/**\n * @Project NUKEVIET 4.x\n * @Author VINADES.,JSC (contact@vinades.vn)\n * @Copyright (C) 2017 VINADES.,JSC. All rights reserved\n * @License GNU/GPL version 2 or any later version\n * @Createdate 04/18/2017 09:47\n */\n\nif (! defined('NV_IS_MOD_SHOPS')) {\n    die('Stop!!!');\n}\n\n$page_title = $module_info['custom_title'];\n$key_words = $module_info['keywords'];\n\n$bid = 1;\n// block host\n$num = $pro_config['per_page'];\n$data_content = array();\n$search = \"\";\n$url = '';\n\n$keyword = $nv_Request->get_string('keyword', 'get');\n$keyword = str_replace('+', ' ', $keyword);\n$kwhtml = nv_htmlspecialchars($keyword);\n$price1_temp = $nv_Request->get_string('price1', 'get', '');\n$price2_temp = $nv_Request->get_string('price2', 'get', '');\n$typemoney = $nv_Request->get_string('typemoney', 'get', '');\n$cataid = $nv_Request->get_int('cata', 'get', 0);\n$groupid = $nv_Request->get_string('filter', 'get', '');\n$group_price = $nv_Request->get_string('group_price', 'get', '');\nif (! empty($group_price)) {\n    $url .= '&group_price=' . $group_price;\n    $group_price = nv_base64_decode($group_price);\n    $group_price = unserialize($group_price);\n    if (!empty($group_price)) {\n        $search .= \" AND\";\n        foreach ($group_price as $i => $group_price_i) {\n            $group_price_i = array_map('intval', explode('-', $group_price_i));\n            if ($group_price_i[0] <= $group_price_i[1]) {\n                $search .= ($i > 0 ? \" OR \" : \"\") . \" product_price BETWEEN \" . $group_price_i[0] . \" AND \" . $group_price_i[1] . \" \";\n            } else {\n                $search .= ($i > 0 ? \" OR \" : \"\") . \" product_price > \" . $group_price_i[0] . \" \";\n            }\n        }\n    }\n}\n\n$sid = $nv_Request->get_int('sid', 'get', 0);\n$page = $nv_Request->get_int('page', 'get', 1);\n$num_items = 0;\n\n$compare_id = $nv_Request->get_string($module_data . '_compare_id', 'session', '');\n$compare_id = unserialize($compare_id);\n\nif ($price1_temp == '') {\n    $price1 = - 1;\n} else {\n    $price1 = floatval($price1_temp);\n}\nif ($price2_temp == '') {\n    $price2 = - 1;\n} else {\n    $price2 = floatval($price2_temp);\n}\n\n// Set data form search\n$xtpl = new XTemplate(\"search_all.tpl\", NV_ROOTDIR . \"/themes/\" . $module_info['template'] . \"/modules/\" . $module_file);\n$xtpl->assign('LANG', $lang_module);\n$xtpl->assign('NV_BASE_SITEURL', NV_BASE_SITEURL);\nforeach ($global_array_shops_cat as $row) {\n    $xtitle_i = \"\";\n    if ($row['lev'] > 0) {\n        $xtitle_i .= \"&nbsp;&nbsp;&nbsp;\";\n        for ($i = 1; $i <= $row['lev']; $i++) {\n            $xtitle_i .= \"&nbsp;&nbsp;&nbsp;\";\n        }\n        $xtitle_i .= \"&nbsp;\";\n    }\n    $row['xtitle'] = $xtitle_i . $row['title'];\n    $row['selected'] = ($cataid == $row['catid']) ? \"selected=\\\"selected\\\"\" : \"\";\n    $xtpl->assign('ROW', $row);\n    $xtpl->parse('form.loopcata');\n}\n\n// Get money\n$sql = \"SELECT code,currency FROM \" . $db_config['prefix'] . \"_\" . $module_data . \"_money_\" . NV_LANG_DATA;\n$result = $db->query($sql);\n\nwhile ($row = $result->fetch()) {\n    $row['selected'] = ($typemoney == $row['code']) ? \"selected=\\\"selected\\\"\" : \"\";\n    $xtpl->assign('ROW', $row);\n    $xtpl->parse('form.typemoney');\n}\n\nif ($price1 == - 1) {\n    $price1_temp = \"\";\n}\nif ($price2 == - 1) {\n    $price2_temp = \"\";\n}\n\n$xtpl->assign('value_keyword', $keyword);\n$xtpl->assign('value_price1', $price1_temp);\n$xtpl->assign('value_price2', $price2_temp);\n\nif ($pro_config['active_price']) {\n    $xtpl->parse('form.price');\n}\n\n$xtpl->parse('form');\n$contents = $xtpl->text('form');\n\nif (! empty($groupid)) {\n    $url .= '&filter=' . $groupid;\n    $groupid = nv_base64_decode($groupid);\n    $groupid = unserialize($groupid);\n\n    $arr_id = array();\n    foreach ($groupid as $id_group) {\n        $group = $global_array_group[$id_group];\n        $arr_id[$group['parentid']][] = $id_group;\n    }\n\n    $_sql = 'SELECT DISTINCT pro_id FROM ' . $db_config['prefix'] . '_' . $module_data . '_group_items WHERE ';\n    $j = 1;\n    foreach ($arr_id as $listid) {\n        $a = sizeof($listid);\n        if ($a > 0) {\n            $arr_sql = array();\n            for ($i = 0; $i < $a; $i++) {\n                $arr_sql[]= ' pro_id IN (SELECT pro_id FROM ' . $db_config['prefix'] . '_' . $module_data . '_group_items WHERE group_id=' . $listid[$i] . ')';\n            }\n            $_sql .= ' ('. implode(' OR ', $arr_sql) . ')';\n        }\n        if ($j < count($arr_id)) {\n            $_sql .= ' AND ';\n        }\n        $j++;\n    }\n    if (!empty($_sql)) {\n        $search .= \" AND t1.id IN(\" . $_sql . \")\";\n    }\n}\n\nif ($keyword != \"\") {\n    $search .= \" AND (t1.\" . NV_LANG_DATA . \"_title LIKE '%\" . $db->dblikeescape($kwhtml) . \"%' OR product_code LIKE '%\" . $db->dblikeescape($keyword) . \"%')\";\n}\n\nif (($price1 >= 0 and $price2 > 0)) {\n    $search .= \" AND product_price BETWEEN \" . $price1 . \" AND \" . $price2 . \" \";\n} elseif ($price2 == - 1 and $price1 >= 0) {\n    $search .= \" AND product_price >= \" . $price1 . \" \";\n} elseif ($price1 == - 1 and $price2 > 0) {\n    $search .= \" AND product_price < \" . $price2 . \" \";\n}\n\nif (! empty($typemoney)) {\n    $search .= \" AND money_unit = \" . $db->quote($typemoney);\n}\n$sql_i = \", if(t1.money_unit ='\" . $pro_config['money_unit'] . \"', t1.product_price , t1.product_price * t2.exchange ) AS product_saleproduct \";\n$order_by = \" product_saleproduct DESC \";\n\nif (! empty($typemoney)) {\n    $search .= \" AND money_unit = \" . $db->quote($typemoney);\n}\nif ($cataid != 0) {\n    $array_cat = GetCatidInParent($cataid);\n    $search .= \" AND listcatid IN (\" . implode(\",\", $array_cat) . \") \";\n}\nif ($sid != 0) {\n    $search .= \" AND source_id =\" . $sid . \" \";\n}\n\nif (empty($search)) {\n    $contents = \"<div align =\\\"center\\\">\" . $lang_module['notresult'] . \"</div>\";\n    include NV_ROOTDIR . '/includes/header.php';\n    echo nv_site_theme($contents);\n    include NV_ROOTDIR . '/includes/footer.php';\n    exit();\n}\n\n$show_price = \"\";\nif ($pro_config['active_price']) {\n    if (! empty($price1_temp) or ! empty($price2_temp)) {\n        $show_price = \"AND showprice=1\";\n    }\n}\n\n$table_search = \"\" . $db_config['prefix'] . \"_\" . $module_data . \"_rows t1\";\n$table_exchange = \" LEFT JOIN \" . $db_config['prefix'] . \"_\" . $module_data . \"_money_\" . NV_LANG_DATA . \" t2 ON t1.money_unit=t2.code\";\n$table_exchange1 = \" INNER JOIN \" . $db_config['prefix'] . \"_\" . $module_data . \"_catalogs t3 ON t3.catid = t1.listcatid\";\n\n// Fetch Limit\n$db->sqlreset()->select('DISTINCT COUNT(*)')->from($table_search . \" \" . $table_exchange . \" \" . $table_exchange1)->where(\"t1.status =1 \" . $search . \" \" . $show_price);\n$sth = $db->prepare($db->sql());\n$sth->execute();\n\n$num_items = $sth->fetchColumn();\n\n$db->select(\"DISTINCT t1.id, t1.listcatid, t1.publtime, t1.\" . NV_LANG_DATA . \"_title, t1.\" . NV_LANG_DATA . \"_alias, t1.\" . NV_LANG_DATA . \"_hometext, t1.homeimgalt, t1.homeimgfile, t1.homeimgthumb, t1.product_number, t1.product_price, t1.discount_id, t1.money_unit, t1.showprice, t1.\" . NV_LANG_DATA . \"_gift_content, t1.gift_from, t1.gift_to, t3.newday, t2.exchange \" . $sql_i)\n    ->order($order_by)\n    ->limit($per_page)\n    ->offset(($page - 1) * $per_page);\n$result = $db->query($db->sql());\n\n$base_url = NV_BASE_SITEURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&' . NV_NAME_VARIABLE . '=' . $module_name . '&amp;' . NV_OP_VARIABLE . '=search_result&keyword=' . $keyword . '&price1=' . $price1 . '&price2=' . $price2 . '&typemoney=' . $typemoney . '&cata=' . $cataid . $url;\n$html_pages = nv_generate_page($base_url, $num_items, $per_page, $page);\n\n$link = NV_BASE_SITEURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&amp;' . NV_NAME_VARIABLE . '=' . $module_name . '&amp;' . NV_OP_VARIABLE . '=';\n\nwhile (list($id, $listcatid, $publtime, $title, $alias, $hometext, $homeimgalt, $homeimgfile, $homeimgthumb, $product_number, $product_price, $discount_id, $money_unit, $showprice, $gift_content, $gift_from, $gift_to, $newday) = $result->fetch(3)) {\n    if ($homeimgthumb == 1) {\n        //image thumb\n\n        $thumb = NV_BASE_SITEURL . NV_FILES_DIR . '/' . $module_upload . '/' . $homeimgfile;\n    } elseif ($homeimgthumb == 2) {\n        //image file\n\n        $thumb = NV_BASE_SITEURL . NV_UPLOADS_DIR . '/' . $module_upload . '/' . $homeimgfile;\n    } elseif ($homeimgthumb == 3) {\n        //image url\n\n        $thumb = $homeimgfile;\n    } else {\n        //no image\n\n        $thumb = NV_BASE_SITEURL . 'themes/' . $module_info['template'] . '/images/' . $module_file . '/no-image.jpg';\n    }\n\n    $data_content[] = array(\n        'id' => $id,\n        'listcatid' => $listcatid,\n        'publtime' => $publtime,\n        'title' => $title,\n        'alias' => $alias,\n        'hometext' => $hometext,\n        'homeimgalt' => $homeimgalt,\n        'homeimgthumb' => $thumb,\n        'product_number' => $product_number,\n        'product_price' => $product_price,\n        'discount_id' => $discount_id,\n        'money_unit' => $money_unit,\n        'showprice' => $showprice,\n        'gift_content' => $gift_content,\n        'gift_from' => $gift_from,\n        'gift_to' => $gift_to,\n        'newday' => $newday,\n        'link_pro' => $link . $global_array_shops_cat[$listcatid]['alias'] . '/' . $alias . $global_config['rewrite_exturl'],\n        'link_order' => $link . 'setcart&amp;id=' . $id\n    );\n}\n\nif (count($data_content) == 0) {\n    $contents .= \"<div align =\\\"center\\\">\" . $lang_module['notresult'] . \"</div>\";\n} else {\n    $contents .= view_search_all($data_content, $compare_id, $html_pages);\n}\n\ninclude NV_ROOTDIR . '/includes/header.php';\necho nv_site_theme($contents);\ninclude NV_ROOTDIR . '/includes/footer.php';\n"], "filenames": ["modules/shops/funcs/detail.php", "modules/shops/funcs/search_result.php"], "buggy_code_start_loc": [19, 41], "buggy_code_end_loc": [343, 42], "fixing_code_start_loc": [19, 41], "fixing_code_end_loc": [343, 42], "type": "CWE-89", "message": "SQL Injection vulnerability in NukeViet CMS module Shops 4.0.29 and 4.3 via the (1) listid parameter in detail.php and the (2) group_price or groupid parameters in search_result.php.", "other": {"cve": {"id": "CVE-2020-21809", "sourceIdentifier": "cve@mitre.org", "published": "2021-07-30T14:15:13.703", "lastModified": "2021-08-03T23:48:10.010", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "SQL Injection vulnerability in NukeViet CMS module Shops 4.0.29 and 4.3 via the (1) listid parameter in detail.php and the (2) group_price or groupid parameters in search_result.php."}, {"lang": "es", "value": "Una vulnerabilidad de inyecci\u00f3n SQL en el m\u00f3dulo NukeViet CMS Shops versiones 4.0.29 y 4.3 por medio del (1) par\u00e1metro listid en el archivo detail.php y los (2) par\u00e1metros group_price o groupid en el archivo search_result.php"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 9.8, "baseSeverity": "CRITICAL"}, "exploitabilityScore": 3.9, "impactScore": 5.9}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:N/C:P/I:P/A:P", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "NONE", "confidentialityImpact": "PARTIAL", "integrityImpact": "PARTIAL", "availabilityImpact": "PARTIAL", "baseScore": 7.5}, "baseSeverity": "HIGH", "exploitabilityScore": 10.0, "impactScore": 6.4, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-89"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:nukeviet:nukeviet:*:*:*:*:*:*:*:*", "versionStartIncluding": "4.0.29", "versionEndIncluding": "4.3", "matchCriteriaId": "ABAADA46-C439-4740-BE15-E173929F3C6A"}]}]}], "references": [{"url": "https://github.com/nukeviet/module-shops/commit/742c0e0f74364f7250c2a69f0a957d4e6317be68", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://nukeviet.vn/vi/news/Tin-an-ninh/huong-dan-fix-loi-bao-mat-nukeviet-4-va-module-shops-612.html", "source": "cve@mitre.org", "tags": ["Patch", "Vendor Advisory"]}, {"url": "https://whitehub.net/submissions/1517", "source": "cve@mitre.org", "tags": ["Exploit", "Issue Tracking", "Third Party Advisory"]}, {"url": "https://whitehub.net/submissions/1518", "source": "cve@mitre.org", "tags": ["Exploit", "Issue Tracking", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/nukeviet/module-shops/commit/742c0e0f74364f7250c2a69f0a957d4e6317be68"}}