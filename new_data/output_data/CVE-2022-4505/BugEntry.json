{"buggy_code": ["<?php\n\n/*\n * Payments can be edited here whch includes deletion of an allocation, modifying the\n * same or adding a new allocation. Log is kept for the deleted ones.\n * The functions of this class support the billing process like the script billing_process.php.\n *\n * @package   OpenEMR\n * @link      http://www.open-emr.org\n * @author    Eldho Chacko <eldho@zhservices.com>\n * @author    Paul Simon K <paul@zhservices.com>\n * @author    Stephen Waite <stephen.waite@cmsvt.com>\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @author    Rod Roark <rod@sunsetsystems.com>\n * @copyright Copyright (c) 2010 Z&H Consultancy Services Private Limited <sam@zhservices.com>\n * @copyright Copyright (C) 2018-2020 Stephen Waite <stephen.waite@cmsvt.com>\n * @copyright Copyright (c) 2019-2020 Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) 2020 Rod Roark <rod@sunsetsystems.com>\n * @license https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\n\nrequire_once(\"../globals.php\");\nrequire_once(\"$srcdir/auth.inc\");\nrequire_once(\"../../custom/code_types.inc.php\");\nrequire_once(\"$srcdir/patient.inc\");\nrequire_once(\"$srcdir/options.inc.php\");\nrequire_once(\"$srcdir/payment.inc.php\");\n\nuse OpenEMR\\Common\\Acl\\AclMain;\nuse OpenEMR\\Common\\Twig\\TwigContainer;\nuse OpenEMR\\Core\\Header;\n\nif (!AclMain::aclCheckCore('acct', 'bill', '', 'write') && !AclMain::aclCheckCore('acct', 'eob', '', 'write')) {\n    echo (new TwigContainer(null, $GLOBALS['kernel']))->getTwig()->render('core/unauthorized.html.twig', ['pageTitle' => xl(\"Confirm Payment\")]);\n    exit;\n}\n\n$screen = 'edit_payment';\n\n// Deletion of payment distribution code\n\nif (isset($_POST[\"mode\"])) {\n    if ($_POST[\"mode\"] == \"DeletePaymentDistribution\") {\n        $DeletePaymentDistributionId = (isset($_POST['DeletePaymentDistributionId']) ? trim($_POST['DeletePaymentDistributionId']) : '');\n        $DeletePaymentDistributionIdArray = explode('_', $DeletePaymentDistributionId);\n        $payment_id = $DeletePaymentDistributionIdArray[0];\n        $PId = $DeletePaymentDistributionIdArray[1];\n        $Encounter = $DeletePaymentDistributionIdArray[2];\n        $Code = $DeletePaymentDistributionIdArray[3];\n        $Modifier = $DeletePaymentDistributionIdArray[4];\n        $Codetype = $DeletePaymentDistributionIdArray[5];\n        //delete and log that action\n        row_modify(\n            \"ar_activity\",\n            \"deleted = NOW()\",\n            \"session_id = '\" . add_escape_custom($payment_id) . \"' AND \" .\n            \"pid = '\" . add_escape_custom($PId) . \"' AND \" .\n            \"deleted IS NULL AND \" .\n            \"encounter = '\" . add_escape_custom($Encounter) . \"' AND \" .\n            \"code_type = '\" . add_escape_custom($Codetype) . \"' AND \" .\n            \"code = '\" . add_escape_custom($Code) . \"' AND \" .\n            \"modifier='\" . add_escape_custom($Modifier) . \"'\"\n        );\n        $Message = 'Delete';\n        //------------------\n        $_POST[\"mode\"] = \"searchdatabase\";\n    }\n}\n\n//===============================================================================\n//Modify Payment Code.\n//===============================================================================\n\nif (isset($_POST[\"mode\"])) {\n    if ($_POST[\"mode\"] == \"ModifyPayments\" || $_POST[\"mode\"] == \"FinishPayments\") {\n        $payment_id = $_REQUEST['payment_id'];\n        //ar_session Code\n        //===============================================================================\n        if (trim($_POST['type_name']) == 'insurance') {\n            $QueryPart = \"payer_id = '\" . trim(formData('hidden_type_code')) .\n                \"', patient_id = '\" . 0;\n        } elseif (trim($_POST['type_name']) == 'patient') {\n            $QueryPart = \"payer_id = '\" . 0 .\n                \"', patient_id = '\" . trim(formData('hidden_type_code'));\n        }\n\n        $user_id = $_SESSION['authUserID'];\n        $closed = 0;\n        $modified_time = date('Y-m-d H:i:s');\n        $check_date = DateToYYYYMMDD(formData('check_date'));\n        $deposit_date = DateToYYYYMMDD(formData('deposit_date'));\n        $post_to_date = DateToYYYYMMDD(formData('post_to_date'));\n        if ($post_to_date == '') {\n            $post_to_date = date('Y-m-d');\n        }\n\n        if ($_POST['deposit_date'] == '') {\n            $deposit_date = $post_to_date;\n        }\n\n        $global_account = \"\";\n        if (formData('global_reset') == '-0.00') {\n            $global_account = \"', global_amount = '\" . trim(formData('global_reset'));\n        }\n\n        sqlStatement(\"update ar_session set \" .\n            $QueryPart .\n            \"', user_id = '\" . trim(add_escape_custom($user_id)) .\n            \"', closed = '\" . trim(add_escape_custom($closed)) .\n            \"', reference = '\" . trim(formData('check_number')) .\n            \"', check_date = '\" . trim(add_escape_custom($check_date)) .\n            \"', deposit_date = '\" . trim(add_escape_custom($deposit_date)) .\n            \"', pay_total = '\" . trim(formData('payment_amount')) .\n            \"', modified_time = '\" . trim(add_escape_custom($modified_time)) .\n            $global_account .\n            \"', payment_type = '\" . trim(formData('type_name')) .\n            \"', description = '\" . trim(formData('description')) .\n            \"', adjustment_code = '\" . trim(formData('adjustment_code')) .\n            \"', post_to_date = '\" . trim(add_escape_custom($post_to_date)) .\n            \"', payment_method = '\" . trim(formData('payment_method')) .\n            \"'    where session_id='\" . add_escape_custom($payment_id) . \"'\");\n        //===============================================================================\n        $CountIndexAbove = $_REQUEST['CountIndexAbove'];\n        $CountIndexBelow = $_REQUEST['CountIndexBelow'];\n        $hidden_patient_code = $_REQUEST['hidden_patient_code'];\n        $user_id = $_SESSION['authUserID'];\n        $created_time = date('Y-m-d H:i:s');\n        //==================================================================\n        //UPDATION\n        //It is done with out deleting any old entries.\n        //==================================================================\n        for ($CountRow = 1; $CountRow <= $CountIndexAbove; $CountRow++) {\n            if (isset($_POST[\"HiddenEncounter$CountRow\"])) {\n                $where1 = \"WHERE deleted IS NULL AND session_id = '\" . add_escape_custom($payment_id) .\n                    \"' AND pid ='\" . trim(formData(\"HiddenPId$CountRow\")) .\n                    \"' AND encounter = '\" . trim(formData(\"HiddenEncounter$CountRow\")) .\n                    \"' AND code_type = '\" . trim(formData(\"HiddenCodetype$CountRow\")) .\n                    \"' AND code = '\" . trim(formData(\"HiddenCode$CountRow\")) .\n                    \"' AND modifier = '\" . trim(formData(\"HiddenModifier$CountRow\")) .\n                    \"'\";\n\n                $where = \"$where1 AND pay_amount > 0\";\n                if (isset($_POST[\"Payment$CountRow\"]) && $_POST[\"Payment$CountRow\"] * 1 > 0) {\n                    if (trim($_POST['type_name']) == 'insurance') {\n                        if (trim($_POST[\"HiddenIns$CountRow\"]) == 1) {\n                            $AccountCode = \"IPP\";\n                        }\n                        if (trim($_POST[\"HiddenIns$CountRow\"]) == 2) {\n                            $AccountCode = \"ISP\";\n                        }\n                        if (trim($_POST[\"HiddenIns$CountRow\"]) == 3) {\n                            $AccountCode = \"ITP\";\n                        }\n                    } elseif (trim($_POST['type_name']) == 'patient') {\n                        $AccountCode = \"PP\";\n                    }\n                    $resPayment = sqlStatement(\"SELECT * from ar_activity $where\");\n                    if (sqlNumRows($resPayment) > 0) {\n                        sqlStatement(\"UPDATE ar_activity SET deleted = NOW() $where\");\n                    }\n                    sqlBeginTrans();\n                    $sequence_no = sqlQuery(\"SELECT IFNULL(MAX(sequence_no),0) + 1 AS increment \" .\n                        \"FROM ar_activity WHERE pid = '\" . trim(formData(\"HiddenPId$CountRow\")) .\n                        \"' AND encounter = '\" . trim(formData(\"HiddenEncounter$CountRow\")) . \"'\");\n                    sqlStatement(\"insert into ar_activity set \" .\n                        \"pid = '\" . trim(formData(\"HiddenPId$CountRow\")) .\n                        \"', encounter = '\" . trim(formData(\"HiddenEncounter$CountRow\")) .\n                        \"', sequence_no = '\" . add_escape_custom($sequence_no['increment']) .\n                        \"', code_type = '\" . trim(formData(\"HiddenCodetype$CountRow\")) .\n                        \"', code = '\" . trim(formData(\"HiddenCode$CountRow\")) .\n                        \"', modifier = '\" . trim(formData(\"HiddenModifier$CountRow\")) .\n                        \"', payer_type = '\" . trim(formData(\"HiddenIns$CountRow\")) .\n                        \"', reason_code = '\" . trim(formData(\"ReasonCode$CountRow\")) .\n                        \"', post_time = '\" . trim(add_escape_custom($created_time)) .\n                        \"', post_user = '\" . trim(add_escape_custom($user_id)) .\n                        \"', session_id = '\" . trim(formData('payment_id')) .\n                        \"', modified_time = '\" . trim(add_escape_custom($created_time)) .\n                        \"', pay_amount = '\" . trim(formData(\"Payment$CountRow\")) .\n                        \"', adj_amount = '\" . 0 .\n                        \"', account_code = '\" . add_escape_custom($AccountCode) .\n                        \"'\");\n                    sqlCommitTrans();\n                } else {\n                    sqlStatement(\"UPDATE ar_activity SET deleted = NOW() $where\");\n                }\n\n                //==============================================================================================================================\n\n                $where = \"$where1 AND adj_amount != 0\";\n                if (isset($_POST[\"AdjAmount$CountRow\"]) && $_POST[\"AdjAmount$CountRow\"] * 1 !== 0) {\n                    if (trim($_POST['type_name']) == 'insurance') {\n                        $AdjustString = \"Ins adjust Ins\" . trim($_POST[\"HiddenIns$CountRow\"]);\n                        $AccountCode = \"IA\";\n                    } elseif (trim($_POST['type_name']) == 'patient') {\n                        $AdjustString = \"Pt adjust\";\n                        $AccountCode = \"PA\";\n                    }\n                    $resPayment = sqlStatement(\"SELECT  * from ar_activity $where\");\n                    if (sqlNumRows($resPayment) > 0) {\n                        sqlStatement(\"update ar_activity set deleted = NOW() $where\");\n                    }\n                    sqlBeginTrans();\n                    $sequence_no = sqlQuery(\"SELECT IFNULL(MAX(sequence_no),0) + 1 AS increment FROM ar_activity WHERE pid = '\" . trim(formData(\"HiddenPId$CountRow\")) . \"' AND encounter = '\" . trim(formData(\"HiddenEncounter$CountRow\")) . \"'\");\n                    sqlStatement(\"insert into ar_activity set \" .\n                        \"pid = '\" . trim(formData(\"HiddenPId$CountRow\")) .\n                        \"', encounter = '\" . trim(formData(\"HiddenEncounter$CountRow\")) .\n                        \"', sequence_no = '\" . add_escape_custom($sequence_no['increment']) .\n                        \"', code_type = '\" . trim(formData(\"HiddenCodetype$CountRow\")) .\n                        \"', code = '\" . trim(formData(\"HiddenCode$CountRow\")) .\n                        \"', modifier = '\" . trim(formData(\"HiddenModifier$CountRow\")) .\n                        \"', payer_type = '\" . trim(formData(\"HiddenIns$CountRow\")) .\n                        \"', post_time = '\" . trim(add_escape_custom($created_time)) .\n                        \"', post_user = '\" . trim(add_escape_custom($user_id)) .\n                        \"', session_id = '\" . trim(formData('payment_id')) .\n                        \"', modified_time = '\" . trim(add_escape_custom($created_time)) .\n                        \"', pay_amount = '\" . 0 .\n                        \"', adj_amount = '\" . trim(formData(\"AdjAmount$CountRow\")) .\n                        \"', memo = '\" . add_escape_custom($AdjustString) .\n                        \"', account_code = '\" . add_escape_custom($AccountCode) .\n                        \"'\");\n                    sqlCommitTrans();\n                } else {\n                    sqlStatement(\"update ar_activity set deleted = NOW() $where\");\n                }\n\n                //==============================================================================================================================\n\n                $where = \"$where1 AND (memo LIKE 'Deductable%' OR memo LIKE 'Deductible%')\";\n                if (isset($_POST[\"Deductible$CountRow\"]) && $_POST[\"Deductible$CountRow\"] * 1 > 0) {\n                    $resPayment = sqlStatement(\"SELECT  * from ar_activity $where\");\n                    if (sqlNumRows($resPayment) > 0) {\n                        sqlStatement(\"update ar_activity set deleted = NOW() $where\");\n                    }\n                    sqlBeginTrans();\n                    $sequence_no = sqlQuery(\"SELECT IFNULL(MAX(sequence_no),0) + 1 AS increment FROM ar_activity WHERE pid = '\" . trim(formData(\"HiddenPId$CountRow\")) . \"' AND encounter = '\" . trim(formData(\"HiddenEncounter$CountRow\")) . \"'\");\n                    sqlStatement(\"insert into ar_activity set \" .\n                        \"pid = '\" . trim(formData(\"HiddenPId$CountRow\")) .\n                        \"', encounter = '\" . trim(formData(\"HiddenEncounter$CountRow\")) .\n                        \"', sequence_no = '\" . add_escape_custom($sequence_no['increment']) .\n                        \"', code_type = '\" . trim(formData(\"HiddenCodetype$CountRow\")) .\n                        \"', code = '\" . trim(formData(\"HiddenCode$CountRow\")) .\n                        \"', modifier = '\" . trim(formData(\"HiddenModifier$CountRow\")) .\n                        \"', payer_type = '\" . trim(formData(\"HiddenIns$CountRow\")) .\n                        \"', post_time = '\" . trim(add_escape_custom($created_time)) .\n                        \"', post_user = '\" . trim(add_escape_custom($user_id)) .\n                        \"', session_id = '\" . trim(formData('payment_id')) .\n                        \"', modified_time = '\" . trim(add_escape_custom($created_time)) .\n                        \"', pay_amount = '\" . 0 .\n                        \"', adj_amount = '\" . 0 .\n                        \"', memo = '\" . \"Deductible $\" . trim(formData(\"Deductible$CountRow\")) .\n                        \"', account_code = '\" . \"Deduct\" .\n                        \"'\");\n                    sqlCommitTrans();\n                } else {\n                    sqlStatement(\"delete from ar_activity $where\");\n                }\n\n                //==============================================================================================================================\n\n                $where = \"$where1 AND pay_amount < 0\";\n                if (isset($_POST[\"Takeback$CountRow\"]) && $_POST[\"Takeback$CountRow\"] * 1 > 0) {\n                    $resPayment = sqlStatement(\"SELECT  * from ar_activity $where\");\n                    if (sqlNumRows($resPayment) > 0) {\n                        sqlStatement(\"update ar_activity set deleted = NOW() $where\");\n                    }\n                    sqlBeginTrans();\n                    $sequence_no = sqlQuery(\"SELECT IFNULL(MAX(sequence_no),0) + 1 AS increment FROM ar_activity WHERE pid = '\" . trim(formData(\"HiddenPId$CountRow\")) . \"' AND encounter = '\" . trim(formData(\"HiddenEncounter$CountRow\")) . \"'\");\n                    sqlStatement(\"insert into ar_activity set \" .\n                        \"pid = '\" . trim(formData(\"HiddenPId$CountRow\")) .\n                        \"', encounter = '\" . trim(formData(\"HiddenEncounter$CountRow\")) .\n                        \"', sequence_no = '\" . add_escape_custom($sequence_no['increment']) .\n                        \"', code_type = '\" . trim(formData(\"HiddenCodetype$CountRow\")) .\n                        \"', code = '\" . trim(formData(\"HiddenCode$CountRow\")) .\n                        \"', modifier = '\" . trim(formData(\"HiddenModifier$CountRow\")) .\n                        \"', payer_type = '\" . trim(formData(\"HiddenIns$CountRow\")) .\n                        \"', post_time = '\" . trim(add_escape_custom($created_time)) .\n                        \"', post_user = '\" . trim(add_escape_custom($user_id)) .\n                        \"', session_id = '\" . trim(formData('payment_id')) .\n                        \"', modified_time = '\" . trim(add_escape_custom($created_time)) .\n                        \"', pay_amount = '\" . trim(formData(\"Takeback$CountRow\")) * -1 .\n                        \"', adj_amount = '\" . 0 .\n                        \"', account_code = '\" . \"Takeback\" .\n                        \"'\");\n                    sqlCommitTrans();\n                } else {\n                    sqlStatement(\"delete from ar_activity $where\");\n                }\n\n                //==============================================================================================================================\n\n                $where = \"$where1 AND follow_up = 'y'\";\n                if (isset($_POST[\"FollowUp$CountRow\"]) && $_POST[\"FollowUp$CountRow\"] == 'y') {\n                    $resPayment = sqlStatement(\"SELECT  * from ar_activity $where\");\n                    if (sqlNumRows($resPayment) > 0) {\n                        sqlStatement(\"update ar_activity set deleted = NOW() $where\");\n                    }\n                    sqlBeginTrans();\n                    $sequence_no = sqlQuery(\"SELECT IFNULL(MAX(sequence_no),0) + 1 AS increment FROM ar_activity WHERE pid = '\" . trim(formData(\"HiddenPId$CountRow\")) . \"' AND encounter = '\" . trim(formData(\"HiddenEncounter$CountRow\")) . \"'\");\n                    sqlStatement(\"insert into ar_activity set \" .\n                        \"pid = '\" . trim(formData(\"HiddenPId$CountRow\")) .\n                        \"', encounter = '\" . trim(formData(\"HiddenEncounter$CountRow\")) .\n                        \"', sequence_no = '\" . add_escape_custom($sequence_no['increment']) .\n                        \"', code_type = '\" . trim(formData(\"HiddenCodetype$CountRow\")) .\n                        \"', code = '\" . trim(formData(\"HiddenCode$CountRow\")) .\n                        \"', modifier = '\" . trim(formData(\"HiddenModifier$CountRow\")) .\n                        \"', payer_type = '\" . trim(formData(\"HiddenIns$CountRow\")) .\n                        \"', post_time = '\" . trim(add_escape_custom($created_time)) .\n                        \"', post_user = '\" . trim(add_escape_custom($user_id)) .\n                        \"', session_id = '\" . trim(formData('payment_id')) .\n                        \"', modified_time = '\" . trim(add_escape_custom($created_time)) .\n                        \"', pay_amount = '\" . 0 .\n                        \"', adj_amount = '\" . 0 .\n                        \"', follow_up = '\" . \"y\" .\n                        \"', follow_up_note = '\" . trim(formData(\"FollowUpReason$CountRow\")) .\n                        \"'\");\n                    sqlCommitTrans();\n                } else {\n                    sqlStatement(\"delete from ar_activity $where\");\n                }\n\n                //==============================================================================================================================\n            } else {\n                break;\n            }\n        }\n\n        //=========\n        //INSERTION of new entries,continuation of modification.\n        //=========\n        for ($CountRow = $CountIndexAbove + 1; $CountRow <= $CountIndexAbove + $CountIndexBelow; $CountRow++) {\n            if (isset($_POST[\"HiddenEncounter$CountRow\"])) {\n                DistributionInsert($CountRow, $created_time, $user_id);\n            } else {\n                break;\n            }\n        }\n\n        if ($_REQUEST['global_amount'] == 'yes') {\n            sqlStatement(\"update ar_session set global_amount=? where session_id =?\", [(isset($_POST[\"HidUnappliedAmount\"]) ? trim($_POST[\"HidUnappliedAmount\"]) * 1 : ''), $payment_id]);\n        } elseif ($_REQUEST['global_reset'] == '-0.00') {\n            sqlStatement(\"update ar_session set global_amount=? where session_id =?\", [0, $payment_id]);\n        }\n\n        if ($_POST[\"mode\"] == \"FinishPayments\") {\n            $Message = 'Finish';\n        }\n\n        $_POST[\"mode\"] = \"searchdatabase\";\n        $Message = 'Modify';\n    }\n}\n\n//==============================================================================\n//Search Code\n//===============================================================================\n$payment_id = ($payment_id ?? null) * 1 > 0 ? $payment_id : $_REQUEST['payment_id'];\n$ResultSearchSub = sqlStatement(\n    \"SELECT DISTINCT encounter, code_type, code, modifier, pid \" .\n    \"FROM ar_activity WHERE deleted IS NULL AND session_id = ? \" .\n    \"ORDER BY pid, encounter, code, modifier\",\n    [$payment_id]\n);\n\n//==============================================================================\n\n//==============================================================================\n//===============================================================================\n?>\n<!DOCTYPE html>\n<html>\n<head>\n    <title><?php echo xlt('Confirm Payment'); ?></title>\n    <?php Header::setupHeader(['datetime-picker', 'common']); ?>\n\n    <script>\n    const mypcc = '1';\n    </script>\n    <?php include_once(\"{$GLOBALS['srcdir']}/payment_jav.inc.php\"); ?>\n    <?php include_once(\"{$GLOBALS['srcdir']}/ajax/payment_ajax_jav.inc.php\"); ?>\n    <script>\n        function ModifyPayments() {//Used while modifying the allocation\n            if (!FormValidations())//FormValidations contains the form checks\n            {\n                return false;\n            }\n            if (CompletlyBlankAbove())//The distribution rows already in the database are checked.\n            {\n                alert(<?php echo xlj('None of the Top Distribution Row Can be Completly Blank.'); ?> +\"\\n\" + <?php echo xlj('Use Delete Option to Remove.'); ?>);\n                return false;\n            }\n    if (!CheckPayingEntityAndDistributionPostFor()) {\n        //Ensures that Insurance payment is distributed under Ins1,Ins2,Ins3 and Patient paymentat under Pat.\n                return false;\n            }\n    if (CompletlyBlankBelow()) {\n        //The newly added distribution rows are checked.\n                alert(<?php echo xlj('Fill any of the Below Row.'); ?>);\n                return false;\n            }\n    let PostValue = CheckUnappliedAmount();//Decides TdUnappliedAmount >0, or <0 or =0\n            if (PostValue == 1) {\n                alert(<?php echo xlj('Cannot Modify Payments.Undistributed is Negative.'); ?>);\n                return false;\n            }\n            dialog.confirm(<?php echo xlj('Would you like to Modify Payments?'); ?>).then(returned => {\n                if (returned === true) {\n                    document.getElementById('mode').value = 'ModifyPayments';\n                    top.restoreSession();\n                    document.forms[0].submit();\n                } else {\n                    dialog.close();\n                    return false;\n                }\n            });\n        }\n\n        function FinishPayments() {\n            if (!FormValidations())//FormValidations contains the form checks\n            {\n                return false;\n            }\n            if (CompletlyBlankAbove())//The distribution rows already in the database are checked.\n            {\n                alert(<?php echo xlj('None of the Top Distribution Row Can be Completly Blank.'); ?> +\"\\n\" + <?php echo xlj('Use Delete Option to Remove.'); ?>);\n                return false;\n            }\n            if (!CheckPayingEntityAndDistributionPostFor())//Ensures that Insurance payment is distributed under Ins1,Ins2,Ins3 and Patient paymentat under Pat.\n            {\n                return false;\n            }\n            if (CompletlyBlankBelow())//The newly added distribution rows are checked.\n            {\n                alert(<?php echo xlj('Fill any of the Below Row.'); ?>);\n                return false;\n            }\n    let PostValue = CheckUnappliedAmount();//Decides TdUnappliedAmount >0, or <0 or =0\n            if (PostValue == 1) {\n                alert(<?php echo xlj('Cannot Modify Payments.Undistributed is Negative.'); ?>);\n                return false;\n            }\n            if (PostValue == 2) {\n                if (confirm(<?php echo xlj('Would you like to Modify and Finish Payments?'); ?>)) {\n                    UnappliedAmount = document.getElementById('TdUnappliedAmount').innerHTML * 1;\n                    if (confirm(<?php echo xlj('Undistributed is'); ?> +' ' + UnappliedAmount + '.' + '\\n' + <?php echo xlj('Would you like the balance amount to apply to Global Account?'); ?>)) {\n                        document.getElementById('mode').value = 'FinishPayments';\n                        document.getElementById('global_amount').value = 'yes';\n                        top.restoreSession();\n                        document.forms[0].submit();\n                    } else {\n                        document.getElementById('mode').value = 'FinishPayments';\n                        top.restoreSession();\n                        document.forms[0].submit();\n                    }\n                } else\n                    return false;\n            } else {\n                if (confirm(<?php echo xlj('Would you like to Modify and Finish Payments?'); ?>)) {\n                    document.getElementById('mode').value = 'FinishPayments';\n                    top.restoreSession();\n                    document.forms[0].submit();\n                } else\n                    return false;\n            }\n\n        }\n\n        function CompletlyBlankAbove() {//The distribution rows already in the database are checked.\n            //It is not allowed to be made completly empty.If needed delete option need to be used.\n    let CountIndexAbove = document.getElementById('CountIndexAbove').value * 1;\n            for (RowCount = 1; RowCount <= CountIndexAbove; RowCount++) {\n                if (document.getElementById('Allowed' + RowCount).value == '' && document.getElementById('Payment' + RowCount).value == '' && document.getElementById('AdjAmount' + RowCount).value == '' && document.getElementById('Deductible' + RowCount).value == '' && document.getElementById('Takeback' + RowCount).value == '' && document.getElementById('FollowUp' + RowCount).checked == false) {\n                    return true;\n                }\n            }\n            return false;\n        }\n\n        function CompletlyBlankBelow() {//The newly added distribution rows are checked.\n            //It is not allowed to be made completly empty.\n    let CountIndexAbove = document.getElementById('CountIndexAbove').value * 1;\n    let CountIndexBelow = document.getElementById('CountIndexBelow').value * 1;\n            if (CountIndexBelow == 0)\n                return false;\n            for (RowCount = CountIndexAbove + 1; RowCount <= CountIndexAbove + CountIndexBelow; RowCount++) {\n                if (document.getElementById('Allowed' + RowCount).value == '' && document.getElementById('Payment' + RowCount).value == '' && document.getElementById('AdjAmount' + RowCount).value == '' && document.getElementById('Deductible' + RowCount).value == '' && document.getElementById('Takeback' + RowCount).value == '' && document.getElementById('FollowUp' + RowCount).checked == false) {\n\n                } else\n                    return false;\n            }\n            return true;\n        }\n\n        function OnloadAction() {//Displays message while loading after some action.\n    let after_value = document.getElementById('ActionStatus').value;\n            if (after_value == 'Delete') {\n                alert(<?php echo xlj('Successfully Deleted'); ?>);\n                return true;\n            }\n            if (after_value == 'Modify' || after_value == 'Finish') {\n                alert(<?php echo xlj('Successfully Modified'); ?>);\n                return true;\n            }\n            after_value = document.getElementById('after_value').value;\n    let payment_id = document.getElementById('payment_id').value;\n            if (after_value == 'distribute') {\n            } else if (after_value == 'new_payment') {\n                if (document.getElementById('TablePatientPortion')) {\n                    document.getElementById('TablePatientPortion').style.display = 'none';\n                }\n                if (confirm(<?php echo xlj('Successfully Saved.Would you like to Distribute?'); ?>)) {\n                    if (document.getElementById('TablePatientPortion')) {\n                        document.getElementById('TablePatientPortion').style.display = '';\n                    }\n                }\n            }\n\n        }\n\n        function DeletePaymentDistribution(DeleteId) {//Confirms deletion of payment distribution.\n            if (confirm(<?php echo xlj('Would you like to Delete Payment Distribution?'); ?>)) {\n                document.getElementById('mode').value = 'DeletePaymentDistribution';\n                document.getElementById('DeletePaymentDistributionId').value = DeleteId;\n                top.restoreSession();\n                document.forms[0].submit();\n            } else\n                return false;\n        }\n\n        //========================================================================================\n\n        $(function () {\n            $('.datepicker').datetimepicker({\n                <?php $datetimepicker_timepicker = false; ?>\n                <?php $datetimepicker_showseconds = false; ?>\n                <?php $datetimepicker_formatInput = true; ?>\n                <?php require($GLOBALS['srcdir'] . '/js/xl/jquery-datetimepicker-2-5-4.js.php'); ?>\n                <?php // can add any additional javascript settings to datetimepicker here; need to prepend first setting with a comma ?>\n            });\n        });\n\n        document.onclick = HideTheAjaxDivs;\n    </script>\n    <style>\n        .amt_input {\n            max-width: 75px;\n        }\n        .bottom {\n            border-bottom: 1px solid var(--black);\n        }\n\n        .top {\n            border-top: 1px solid var(--black);\n        }\n\n        .left {\n            border-left: 1px solid var(--black);\n        }\n\n        .right {\n            border-right: 1px solid var(--black);\n        }\n\n        .form-group {\n            margin-bottom: 5px;\n        }\n\n        legend {\n            border-bottom: 2px solid #E5E5E5;\n            background: #E5E5E5;\n            padding-left: 10px;\n        }\n\n        .form-horizontal .control-label {\n            padding-top: 2px;\n        }\n\n        fieldset {\n            border-color: #68171A !important;\n            background-color: #f2f2f2;\n            margin-bottom: 10px;\n            padding-bottom: 15px;\n        }\n\n        @media only screen and (max-width: 768px) {\n            [class*=\"col-\"] {\n                width: 100%;\n                text-align: left !important;\n            }\n        }\n    </style>\n    <?php Header::setupHeader(['datetime-picker', 'common']); ?>\n</head>\n<body class=\"body_top\" onload=\"OnloadAction()\">\n    <div class=\"container-fluid\">\n        <?php\n        if ($_REQUEST['ParentPage'] ?? '' == 'new_payment') {\n            ?>\n            <div class=\"row\">\n                <div class=\"col-12\">\n                    <h2><?php echo xlt('Payments'); ?></h2>\n                </div>\n            </div>\n            <div class=\"row\">\n                <div class=\"col-sm-12\">\n                    <nav class=\"navbar navbar-nav navbar-expand-md navbar-light text-body bg-light static-top\">\n                        <button class=\"navbar-toggler icon-bar\" data-target=\"#myNavbar\" data-toggle=\"collapse\" type=\"button\"><span class=\"navbar-toggler-icon\"></span></button>\n                        <div class=\"collapse navbar-collapse\" id=\"myNavbar\">\n                            <ul class=\"navbar-nav mr-auto\">\n                                <li class=\"nav-item active\">\n                                    <a class=\"nav-link font-weight-bold\" href='new_payment.php'><?php echo xlt('New Payment'); ?></a>\n                                </li>\n                                <li class=\"nav-item\">\n                                    <a class=\"nav-link font-weight-bold\" href='search_payments.php'><?php echo xlt('Search Payment'); ?></a>\n                                </li>\n                                <li class=\"nav-item\">\n                                    <a class=\"nav-link font-weight-bold\" href='era_payments.php'><?php echo xlt('ERA Posting'); ?></a>\n                                </li>\n                            </ul>\n                        </div>\n                    </nav>\n                </div>\n            </div>\n            <?php\n        }\n        ?>\n        <?php\n        if ($payment_id * 1 == 0) {\n            $onclick = \"top.restoreSession();return SavePayment();\";\n        } else {\n            $onclick = \"return false;\";\n        }\n        ?>\n        <form class=\"form\" name='new_payment' method='post' action=\"edit_payment.php\" onsubmit='<?php echo $onclick; ?>'>\n            <?php\n            if ($payment_id * 1 > 0) { ?>\n            <fieldset>\n                <?php\n                require_once(\"payment_master.inc.php\");  //Check/cash details are entered here.\n                ?>\n                <?php }//End of if($payment_id*1>0) ?>\n                <?php\n                if ($payment_id * 1 > 0) {//Distribution rows already in the database are displayed.\n                    ?>\n                    <?php //\n                    $resCount = sqlStatement(\n                        \"SELECT DISTINCT encounter, code_type, code, modifier FROM ar_activity \" .\n                        \"WHERE deleted IS NULL AND session_id = ?\",\n                        [$payment_id]\n                    );\n                    $TotalRows = sqlNumRows($resCount);\n                    $CountPatient = 0;\n                    $CountIndex = 0;\n                    $CountIndexAbove = 0;\n                    $paymenttot = 0;\n                    $adjamttot = 0;\n                    $deductibletot = 0;\n                    $takebacktot = 0;\n                    $allowedtot = 0;\n                    if ($RowSearchSub = sqlFetchArray($ResultSearchSub)) {\n                        do {\n                            $CountPatient++;\n                            $PId = $RowSearchSub['pid'];\n                            $EncounterMaster = $RowSearchSub['encounter'];\n                            // Only use the code_type in the queries below if it is specified in the ar_activity table.\n                            // If it is not specified in the ar_activity table, also note it is not requested from the\n                            // billing table in below query, thus making it blank in all queries below in this script.\n                            $CodetypeMaster = $RowSearchSub['code_type'];\n                            $sql_select_part_codetype = \"\";\n                            $sql_where_part_codetype = \"\";\n                            if (!empty($CodetypeMaster)) {\n                                $sql_select_part_codetype = \"billing.code_type,\";\n                                $sql_where_part_codetype = \"and billing.code_type ='\" . add_escape_custom($CodetypeMaster) . \"'\";\n                            }\n                            $CodeMaster = $RowSearchSub['code'];\n                            $ModifierMaster = $RowSearchSub['modifier'];\n                            $res = sqlStatement(\"SELECT fname,lname,mname FROM patient_data where pid =?\", [$PId]);\n                            $row = sqlFetchArray($res);\n                            $fname = $row['fname'];\n                            $lname = $row['lname'];\n                            $mname = $row['mname'];\n                            $NameDB = $lname . ' ' . $fname . ' ' . $mname;\n                            $ResultSearch = sqlStatement(\"SELECT billing.id,last_level_closed,billing.encounter,form_encounter.`date`,$sql_select_part_codetype billing.code,billing.modifier,fee\n                             FROM billing ,form_encounter\n                             where billing.encounter=form_encounter.encounter and billing.pid=form_encounter.pid and\n                             code_type !='ICD9' and  code_type !='COPAY' and billing.activity !=0 and\n                             form_encounter.pid ='\" . add_escape_custom($PId) . \"' and billing.pid ='\" . add_escape_custom($PId) . \"' and billing.encounter ='\" . add_escape_custom($EncounterMaster) . \"'\n                             $sql_where_part_codetype\n                             and billing.code ='\" . add_escape_custom($CodeMaster) . \"'\n                             and billing.modifier ='\" . add_escape_custom($ModifierMaster) . \"'\n                             ORDER BY form_encounter.`date`,form_encounter.encounter,billing.code,billing.modifier\");\n                            if (sqlNumRows($ResultSearch) > 0) {\n                                if ($CountPatient === 1) {\n                                    $Table = 'yes';\n                                    ?>\n                                    <br /><br />\n                                    <div class=\"row\" id=\"tableRow\">\n                                    <legend><?php echo xlt(\"Distributed Edits\") ?></legend>\n                                    <div class=\"table-responsive-lg\">\n                                    <table class=\"table table-sm table-bordered table-light\" id=\"TableDistributedEdit\" >\n                                    <thead class=\"bg-dark text-light\">\n                                    <tr>\n                                        <th>&nbsp;</th>\n                                        <th><?php echo xlt('Patient Name'); ?></th>\n                                        <th><?php echo xlt('Post For'); ?></th>\n                                        <th><?php echo xlt('Service Date'); ?></th>\n                                        <th><?php echo xlt('Enc#'); ?></th>\n                                        <th><?php echo xlt('Code'); ?></th>\n                                        <th><?php echo xlt('Charge'); ?></th>\n                                        <th><?php echo xlt('Copay'); ?></th>\n                                        <th><?php echo xlt('Bal-Due'); ?></th>\n                                        <th><?php echo xlt('Allowed(c)'); ?></th><!-- (c) means it is calculated.Not stored one. -->\n                                        <th><?php echo xlt('Payment'); ?></th>\n                                        <th><?php echo xlt('Adj Amount'); ?></th>\n                                        <th><?php echo xlt('Deductible'); ?></th>\n                                        <th><?php echo xlt('Takeback'); ?></th>\n                                        <th><?php echo xlt('MSP'); ?></th>\n                                        <th><?php echo xlt('Resn'); ?></th>\n                                        <th><?php echo xlt('Follow Up Reason'); ?></th>\n                                    </tr>\n                                    </thead>\n                                <?php }\n                                while ($RowSearch = sqlFetchArray($ResultSearch)) {\n                                    $CountIndex++;\n                                    $CountIndexAbove++;\n                                    $ServiceDateArray = explode(' ', $RowSearch['date']);\n                                    $ServiceDate = oeFormatShortDate($ServiceDateArray[0]);\n                                    $Codetype = $RowSearch['code_type'];\n                                    $Code = $RowSearch['code'];\n                                    $Modifier = $RowSearch['modifier'];\n                                    if ($Modifier != '') {\n                                        $ModifierString = \", $Modifier\";\n                                    } else {\n                                        $ModifierString = \"\";\n                                    }\n                                    $Fee = $RowSearch['fee'];\n                                    $Encounter = $RowSearch['encounter'];\n\n                                    $resPayer = sqlStatement(\n                                        \"SELECT payer_type FROM ar_activity WHERE \" .\n                                        \"deleted IS NULL AND session_id = ? AND pid = ? AND encounter = ? \" .\n                                        \"AND code_type = ? AND code = ? AND modifier = ?\",\n                                        [$payment_id, $PId, $Encounter, $Codetype, $Code, $Modifier]\n                                    );\n                                    $rowPayer = sqlFetchArray($resPayer);\n                                    $Ins = $rowPayer['payer_type'];\n\n                                    //Always associating the copay to a particular charge.\n                                    $BillingId = $RowSearch['id'];\n                                    $resId = sqlStatement(\"SELECT id FROM billing where code_type != 'ICD9' and code_type != 'COPAY' and\n                                    pid =? and encounter =? and billing.activity!=0 order by id\", [$PId, $Encounter]);\n                                    $rowId = sqlFetchArray($resId);\n                                    $Id = $rowId['id'];\n\n                                    if ($BillingId != $Id) {//multiple cpt in single encounter\n                                        $Copay = 0.00;\n                                    } else {\n                                        $resCopay = sqlStatement(\"SELECT sum(fee) as copay FROM billing where\n                                    code_type='COPAY' and pid =? and encounter =? and billing.activity!=0\", [$PId, $Encounter]);\n                                        $rowCopay = sqlFetchArray($resCopay);\n                                        $Copay = $rowCopay['copay'] * -1;\n\n                                        $resMoneyGot = sqlStatement(\n                                            \"SELECT sum(pay_amount) AS PatientPay FROM ar_activity WHERE \" .\n                                            \"deleted IS NULL AND pid = ? and encounter = ? AND \" .\n                                            \"payer_type = 0 AND account_code = 'PCP'\",\n                                            [$PId, $Encounter]\n                                        ); //new fees screen copay gives account_code='PCP'\n                                        $rowMoneyGot = sqlFetchArray($resMoneyGot);\n                                        $PatientPay = $rowMoneyGot['PatientPay'];\n\n                                        $Copay = $Copay + $PatientPay;\n                                    }\n\n                                    //For calculating Remainder\n                                    if ($Ins == 0) {//Fetch all values\n                                        $resMoneyGot = sqlStatement(\n                                            \"SELECT sum(pay_amount) as MoneyGot FROM ar_activity WHERE \" .\n                                            \"deleted IS NULL AND pid = ? and code_type = ? AND code = ? AND \" .\n                                            \"modifier = ? AND encounter = ? AND \" .\n                                            \"!(payer_type = 0 AND account_code = 'PCP')\",\n                                            [$PId, $Codetype, $Code, $Modifier, $Encounter]\n                                        );\n                                        //new fees screen copay gives account_code='PCP'\n                                        $rowMoneyGot = sqlFetchArray($resMoneyGot);\n                                        $MoneyGot = $rowMoneyGot['MoneyGot'];\n\n                                        $resMoneyAdjusted = sqlStatement(\n                                            \"SELECT sum(adj_amount) AS MoneyAdjusted FROM ar_activity WHERE \" .\n                                            \"deleted IS NULL AND pid = ? and code_type = ? and code = ? AND \" .\n                                            \"modifier = ? AND encounter = ?\",\n                                            [$PId, $Codetype, $Code, $Modifier, $Encounter]\n                                        );\n                                        $rowMoneyAdjusted = sqlFetchArray($resMoneyAdjusted);\n                                        $MoneyAdjusted = $rowMoneyAdjusted['MoneyAdjusted'];\n                                    } else {\n                                        //Fetch till that much got\n                                        //Fetch the HIGHEST sequence_no till this session.\n                                        //Used maily in  the case if primary/others pays once more.\n                                        $resSequence = sqlStatement(\"SELECT sequence_no from ar_activity where session_id=? and\n                                    pid=? and encounter=? order by sequence_no desc \", [$payment_id, $PId, $Encounter]);\n                                        $rowSequence = sqlFetchArray($resSequence);\n                                        $Sequence = $rowSequence['sequence_no'];\n\n                                        $resMoneyGot = sqlStatement(\n                                            \"SELECT sum(pay_amount) as MoneyGot FROM ar_activity WHERE \" .\n                                            \"deleted IS NULL AND pid = ? and code_type = ? AND code = ? AND \" .\n                                            \"modifier = ? and encounter = ? AND \" .\n                                            \"payer_type > 0 and payer_type <= ? and sequence_no <= ?\",\n                                            [$PId, $Codetype, $Code, $Modifier, $Encounter, $Ins, $Sequence]\n                                        );\n                                        $rowMoneyGot = sqlFetchArray($resMoneyGot);\n                                        $MoneyGot = $rowMoneyGot['MoneyGot'];\n\n                                        $resMoneyAdjusted = sqlStatement(\n                                            \"SELECT sum(adj_amount) AS MoneyAdjusted FROM ar_activity WHERE \" .\n                                            \"deleted IS NULL AND pid = ? and code_type = ? and code = ? AND \" .\n                                            \"modifier = ? AND encounter = ? AND payer_type > 0 AND \" .\n                                            \"payer_type <= ? and sequence_no <= ?\",\n                                            [$PId, $Codetype, $Code, $Modifier, $Encounter, $Ins, $Sequence]\n                                        );\n                                        $rowMoneyAdjusted = sqlFetchArray($resMoneyAdjusted);\n                                        $MoneyAdjusted = $rowMoneyAdjusted['MoneyAdjusted'];\n                                    }\n                                    $Remainder = $Fee - $Copay - $MoneyGot - $MoneyAdjusted;\n                                    //For calculating RemainderJS.Used while restoring back the values.\n                                    if ($Ins == 0) {//Got just before Patient\n                                        $resMoneyGot = sqlStatement(\n                                            \"SELECT sum(pay_amount) AS MoneyGot FROM ar_activity WHERE \" .\n                                            \"deleted IS NULL AND pid = ? AND code_type = ? AND code = ? AND \" .\n                                            \"modifier = ? AND encounter = ? and payer_type != 0\",\n                                            [$PId, $Codetype, $Code, $Modifier, $Encounter]\n                                        );\n                                        $rowMoneyGot = sqlFetchArray($resMoneyGot);\n                                        $MoneyGot = $rowMoneyGot['MoneyGot'];\n\n                                        $resMoneyAdjusted = sqlStatement(\n                                            \"SELECT sum(adj_amount) AS MoneyAdjusted FROM ar_activity WHERE \" .\n                                            \"deleted IS NULL AND pid = ? AND code_type = ? AND code = ? AND \" .\n                                            \"modifier = ? and encounter = ? and payer_type != 0\",\n                                            [$PId, $Codetype, $Code, $Modifier, $Encounter]\n                                        );\n                                        $rowMoneyAdjusted = sqlFetchArray($resMoneyAdjusted);\n                                        $MoneyAdjusted = $rowMoneyAdjusted['MoneyAdjusted'];\n                                    } else {\n                                        //Got just before the previous\n                                        //Fetch the LOWEST sequence_no till this session.\n                                        //Used maily in  the case if primary/others pays once more.\n                                        $resSequence = sqlStatement(\n                                            \"SELECT sequence_no FROM ar_activity WHERE \" .\n                                            \"session_id = ? AND deleted IS NULL AND pid = ? AND encounter = ? \" .\n                                            \"order by sequence_no\",\n                                            [$payment_id, $PId, $Encounter]\n                                        );\n                                        $rowSequence = sqlFetchArray($resSequence);\n                                        $Sequence = $rowSequence['sequence_no'];\n\n                                        $resMoneyGot = sqlStatement(\n                                            \"SELECT sum(pay_amount) as MoneyGot FROM ar_activity WHERE \" .\n                                            \"deleted IS NULL AND pid = ? AND code_type = ? AND code = ? \" .\n                                            \"AND modifier = ? AND encounter = ? AND payer_type > 0 AND \" .\n                                            \"payer_type <= ? AND sequence_no < ?\",\n                                            [$PId, $Codetype, $Code, $Modifier, $Encounter, $Ins, $Sequence]\n                                        );\n                                        $rowMoneyGot = sqlFetchArray($resMoneyGot);\n                                        $MoneyGot = $rowMoneyGot['MoneyGot'];\n\n                                        $resMoneyAdjusted = sqlStatement(\n                                            \"SELECT sum(adj_amount) as MoneyAdjusted FROM ar_activity WHERE \" .\n                                            \"deleted IS NULL AND pid = ? and code_type = ? and code = ? AND \" .\n                                            \"modifier = ? AND encounter = ? AND payer_type <= ? AND sequence_no < ?\",\n                                            [$PId, $Codetype, $Code, $Modifier, $Encounter, $Ins, $Sequence]\n                                        );\n                                        $rowMoneyAdjusted = sqlFetchArray($resMoneyAdjusted);\n                                        $MoneyAdjusted = $rowMoneyAdjusted['MoneyAdjusted'];\n                                    }\n                                    //Stored in hidden so that can be used while restoring back the values.\n                                    $RemainderJS = $Fee - $Copay - $MoneyGot - $MoneyAdjusted;\n\n                                    $resPayment = sqlStatement(\n                                        \"SELECT pay_amount FROM ar_activity WHERE \" .\n                                        \"deleted IS NULL AND session_id=? AND pid = ? AND encounter = ? AND \" .\n                                        \"code_type = ? AND code = ? AND modifier = ? AND pay_amount > 0\",\n                                        [$payment_id, $PId, $Encounter, $Codetype, $Code, $Modifier]\n                                    );\n                                    $rowPayment = sqlFetchArray($resPayment);\n                                    $PaymentDB = $rowPayment['pay_amount'] ?? null * 1;\n                                    $PaymentDB = $PaymentDB == 0 ? '' : $PaymentDB;\n\n                                    $resPayment = sqlStatement(\n                                        \"SELECT pay_amount FROM ar_activity WHERE \" .\n                                        \"deleted IS NULL AND session_id = ? AND pid = ? AND encounter = ? AND \" .\n                                        \"code_type = ? AND code = ? AND modifier = ? AND pay_amount < 0\",\n                                        [$payment_id, $PId, $Encounter, $Codetype, $Code, $Modifier]\n                                    );\n                                    $rowPayment = sqlFetchArray($resPayment);\n                                    $TakebackDB = ($rowPayment['pay_amount'] ?? null) * -1;\n                                    $TakebackDB = $TakebackDB == 0 ? '' : $TakebackDB;\n\n                                    $resPayment = sqlStatement(\n                                        \"SELECT adj_amount FROM ar_activity WHERE \" .\n                                        \"deleted IS NULL AND session_id = ? AND pid = ? AND encounter = ? AND \" .\n                                        \"code_type = ? AND code = ? AND modifier = ? AND adj_amount != 0\",\n                                        [$payment_id, $PId, $Encounter, $Codetype, $Code, $Modifier]\n                                    );\n                                    $rowPayment = sqlFetchArray($resPayment);\n                                    $AdjAmountDB = $rowPayment['adj_amount'] * 1;\n                                    $AdjAmountDB = $AdjAmountDB == 0 ? '' : $AdjAmountDB;\n\n                                    $resPayment = sqlStatement(\n                                        \"SELECT memo FROM ar_activity WHERE \" .\n                                        \"deleted IS NULL AND session_id = ? AND pid = ? AND encounter = ? AND \" .\n                                        \"code_type = ? AND code = ? AND modifier = ? AND \" .\n                                        \"(memo LIKE 'Deductable%' OR memo LIKE 'Deductible%')\",\n                                        [$payment_id, $PId, $Encounter, $Codetype, $Code, $Modifier]\n                                    );\n                                    $rowPayment = sqlFetchArray($resPayment);\n                                    $DeductibleDB = $rowPayment['memo'] ?? '';\n                                    $DeductibleDB = str_replace('Deductable $', '', $DeductibleDB);\n                                    $DeductibleDB = str_replace('Deductible $', '', $DeductibleDB);\n\n                                    $resPayment = sqlStatement(\n                                        \"SELECT follow_up, follow_up_note FROM ar_activity WHERE \" .\n                                        \"deleted IS NULL AND session_id = ? AND pid = ? AND encounter = ? AND \" .\n                                        \"code_type = ? AND code = ? AND modifier = ? AND follow_up = 'y'\",\n                                        [$payment_id, $PId, $Encounter, $Codetype, $Code, $Modifier]\n                                    );\n                                    $rowPayment = sqlFetchArray($resPayment);\n                                    $FollowUpDB = $rowPayment['follow_up'] ?? '';\n                                    $FollowUpReasonDB = $rowPayment['follow_up_note'] ?? '';\n\n                                    $resPayment = sqlStatement(\n                                        \"SELECT reason_code FROM ar_activity WHERE \" .\n                                        \"deleted IS NULL AND session_id = ? AND pid = ? AND encounter = ? AND \" .\n                                        \"code_type = ? AND code = ? AND modifier = ?\",\n                                        [$payment_id, $PId, $Encounter, $Codetype, $Code, $Modifier]\n                                    );\n                                    $rowPayment = sqlFetchArray($resPayment);\n                                    $ReasonCodeDB = $rowPayment['reason_code'];\n\n                                    if ($Ins == 1) {\n                                        $AllowedDB = number_format($Fee - $AdjAmountDB, 2);\n                                    } else {\n                                        $AllowedDB = 0;\n                                    }\n                                    $AllowedDB = $AllowedDB === 0 ? '' : $AllowedDB;\n\n                                    if ($Ins == 1) {\n                                        $bgcolor = '#ddddff';\n                                    } elseif ($Ins == 2) {\n                                        $bgcolor = '#ffdddd';\n                                    } elseif ($Ins == 3) {\n                                        $bgcolor = '#F2F1BC';\n                                    } elseif ($Ins == 0) {\n                                        $bgcolor = '#AAFFFF';\n                                    }\n                                    $paymenttot = $paymenttot + floatval($PaymentDB);\n                                    $adjamttot = $adjamttot + floatval($AdjAmountDB);\n                                    $deductibletot = $deductibletot + floatval($DeductibleDB);\n                                    $takebacktot = $takebacktot + floatval($TakebackDB);\n                                    $allowedtot = $allowedtot + floatval($AllowedDB);\n                                    ?>\n\n                                <tr class=\"border-dark\" bgcolor='<?php echo attr($bgcolor); ?>' class=\"text\" id=\"trCharges<?php echo attr($CountIndex); ?>\">\n                                    <td align=\"left\">\n                                        <a href=\"#\" onclick=\"javascript:return DeletePaymentDistribution(<?php echo attr_js($payment_id . '_' . $PId . '_' . $Encounter . '_' . $Code . '_' . $Modifier . '_' . $Codetype); ?>);\"><img border=\"0\" src=\"../pic/Delete.gif\"></a>\n                                    </td>\n                                    <td align=\"left\">\n                                        <?php echo text($NameDB); ?><input name=\"HiddenPId<?php echo attr($CountIndex); ?>\" type=\"hidden\" value=\"<?php echo attr($PId); ?>\" />\n                                    </td>\n                                    <td align=\"left\">\n                                        <input id=\"HiddenIns<?php echo attr($CountIndex); ?>\" name=\"HiddenIns<?php echo attr($CountIndex); ?>\" type=\"hidden\" value=\"<?php echo attr($Ins); ?>\" /><?php echo generate_select_list(\"payment_ins$CountIndex\", \"payment_ins\", \"$Ins\", \"Insurance/Patient\", '', 'w-100', 'ActionOnInsPat(\"' . $CountIndex . '\")'); ?>\n                                    </td>\n                                    <td>\n                                        <?php echo text($ServiceDate); ?>\n                                    </td>\n                                    <td align=\"right\">\n                                        <input name=\"HiddenEncounter<?php echo attr($CountIndex); ?>\" type=\"hidden\" value=\"<?php echo attr($Encounter); ?>\" /><?php echo text($Encounter); ?>\n                                    </td>\n                                    <td>\n                                        <input name=\"HiddenCodetype<?php echo attr($CountIndex); ?>\" type=\"hidden\" value=\"<?php echo attr($Codetype); ?>\" />\n                                        <input name=\"HiddenCode<?php echo attr($CountIndex); ?>\" type=\"hidden\" value=\"<?php echo attr($Code); ?>\" /><?php echo text($Codetype . \"-\" . $Code . $ModifierString); ?>\n                                        <input name=\"HiddenModifier<?php echo attr($CountIndex); ?>\" type=\"hidden\" value=\"<?php echo attr($Modifier); ?>\" />\n                                    </td>\n                                    <td align=\"right\">\n                                        <input id=\"HiddenChargeAmount<?php echo attr($CountIndex); ?>\" name=\"HiddenChargeAmount<?php echo attr($CountIndex); ?>\" type=\"hidden\" value=\"<?php echo attr($Fee); ?>\" /><?php echo text($Fee); ?>\n                                    </td>\n                                    <td align=\"right\">\n                                        <input id=\"HiddenCopayAmount<?php echo attr($CountIndex); ?>\" name=\"HiddenCopayAmount<?php echo attr($CountIndex); ?>\" type=\"hidden\" value=\"<?php echo attr($Copay); ?>\"><?php echo text(number_format($Copay, 2)); ?>\n                                    </td>\n                                    <td align=\"right\" id=\"RemainderTd<?php echo attr($CountIndex); ?>\"> <?php echo text(round($Remainder, 2)); ?> </td>\n                                    <input name=\"HiddenRemainderTd<?php echo attr($CountIndex); ?>\" id=\"HiddenRemainderTd<?php echo attr($CountIndex); ?>\" value=\"<?php echo attr(round($Remainder, 2)); ?>\" type=\"hidden\" />\n                                    <td>\n                                        <input autocomplete=\"off\" id=\"Allowed<?php echo attr($CountIndex); ?>\" name=\"Allowed<?php echo attr($CountIndex); ?>\" onchange=\"ValidateNumeric(this);ScreenAdjustment(this,<?php echo attr_js($CountIndex); ?>);UpdateTotalValues(1,<?php echo attr_js($TotalRows); ?>,'Allowed','allowtotal');UpdateTotalValues(1,<?php echo attr_js($TotalRows); ?>,'Payment','paymenttotal');UpdateTotalValues(1,<?php echo attr_js($TotalRows); ?>,'AdjAmount','AdjAmounttotal');RestoreValues(<?php echo attr_js($CountIndex); ?>)\" onkeydown=\"PreventIt(event)\"  class=\"text-right input-sm w-100\" type=\"text\" value=\"<?php echo attr($AllowedDB); ?>\" />\n                                    </td>\n\n                                    <td>\n                                        <input autocomplete=\"off\" id=\"Payment<?php echo attr($CountIndex); ?>\" name=\"Payment<?php echo attr($CountIndex); ?>\" onchange=\"ValidateNumeric(this);ScreenAdjustment(this,<?php echo attr_js($CountIndex); ?>);UpdateTotalValues(1,<?php echo attr_js($TotalRows); ?>,'Payment','paymenttotal');RestoreValues(<?php echo attr_js($CountIndex); ?>)\" onkeydown=\"PreventIt(event)\"  class=\"text-right  input-sm w-100\" type=\"text\" value=\"<?php echo attr($PaymentDB); ?>\" />\n                                    </td>\n                                    <td>\n                                        <input autocomplete=\"off\" id=\"AdjAmount<?php echo attr($CountIndex); ?>\" name=\"AdjAmount<?php echo attr($CountIndex); ?>\" onchange=\"ValidateNumeric(this);ScreenAdjustment(this,<?php echo attr_js($CountIndex); ?>);UpdateTotalValues(1,<?php echo attr_js($TotalRows); ?>,'AdjAmount','AdjAmounttotal');RestoreValues(<?php echo attr_js($CountIndex); ?>)\" onkeydown=\"PreventIt(event)\"  class=\"text-right  input-sm w-100\" type=\"text\" value=\"<?php echo attr($AdjAmountDB); ?>\" />\n                                    </td>\n                                    <td>\n                                        <input autocomplete=\"off\" id=\"Deductible<?php echo attr($CountIndex); ?>\" name=\"Deductible<?php echo attr($CountIndex); ?>\" onchange=\"ValidateNumeric(this);UpdateTotalValues(1,<?php echo attr_js($TotalRows); ?>,'Deductible','deductibletotal');\" onkeydown=\"PreventIt(event)\"  class=\"text-right  input-sm w-100\" type=\"text\" value=\"<?php echo attr($DeductibleDB); ?>\" />\n                                    </td>\n                                    <td>\n                                        <input autocomplete=\"off\" id=\"Takeback<?php echo attr($CountIndex); ?>\" name=\"Takeback<?php echo attr($CountIndex); ?>\" onchange=\"ValidateNumeric(this);ScreenAdjustment(this,<?php echo attr_js($CountIndex); ?>);UpdateTotalValues(1,<?php echo attr_js($TotalRows); ?>,'Takeback','takebacktotal');RestoreValues(<?php echo attr_js($CountIndex); ?>)\" onkeydown=\"PreventIt(event)\"  class=\"text-right  input-sm w-100\" type=\"text\" value=\"<?php echo attr($TakebackDB); ?>\" />\n                                    </td>\n                                    <td align=\"left\">\n                                        <input id=\"HiddenReasonCode<?php echo attr($CountIndex); ?>\" name=\"HiddenReasonCode<?php echo attr($CountIndex); ?>\" type=\"hidden\" value=\"<?php echo attr($ReasonCodeDB); ?>\" /><?php echo generate_select_list(\"ReasonCode$CountIndex\", \"msp_remit_codes\", \"$ReasonCodeDB\", \"MSP\", '', 'w-100'); ?>\n                                    </td>\n                                    <td align=\"center\">\n                                        <input id=\"FollowUp<?php echo attr($CountIndex); ?>\" name=\"FollowUp<?php echo attr($CountIndex); ?>\" onclick=\"ActionFollowUp(<?php echo attr_js($CountIndex); ?>)\" type=\"checkbox\" value=\"y\" />\n                                    </td>\n                                    <td>\n                                        <input id=\"FollowUpReason<?php echo attr($CountIndex); ?>\" name=\"FollowUpReason<?php echo attr($CountIndex); ?>\" onkeydown=\"PreventIt(event)\" class=\" input-sm w-100\" type=\"text\" value=\"<?php echo attr($FollowUpReasonDB); ?>\" readonly>\n                                    </td>\n                                    </tr><?php\n                                }//End of while ($RowSearch = sqlFetchArray($ResultSearch))\n                                ?>\n                                <?php\n                            }//End of if(sqlNumRows($ResultSearch)>0)\n                        } while ($RowSearchSub = sqlFetchArray($ResultSearchSub));\n                        if ($Table == 'yes') { ?>\n                            <tr>\n                                <td class=\"text-right text-dark\" align=\"left\" colspan=\"9\"><b><?php echo (xlt(\"Totals\") . \": \") ?></b></td>\n                                <td class=\"bg-dark text-secondary\" align=\"center\" id=\"allowtotal\"><?php echo text(number_format($allowedtot, 2)); ?></td>\n                                <td class=\"bg-dark text-secondary\" align=\"center\" id=\"paymenttotal\"><?php echo text(number_format($paymenttot, 2)); ?></td>\n                                <td class=\"bg-dark text-secondary\" align=\"center\" id=\"AdjAmounttotal\"><?php echo text(number_format($adjamttot, 2)); ?></td>\n                                <td class=\"bg-dark text-secondary\" align=\"center\" id=\"deductibletotal\"><?php echo text(number_format($deductibletot, 2)); ?></td>\n                                <td class=\"bg-dark text-secondary\" align=\"center\" id=\"takebacktotal\"><?php echo text(number_format($takebacktot, 2)); ?></td>\n                                <td align=\"center\" colspan=\"2\">&nbsp;</td>\n                                <td align=\"right\">\n                                    <button type=\"button\" class=\"btn btn-sm btn-secondary btn-refresh pull-right\"\n                                        onclick=\"updateAllFormTotals(<?php echo attr_js($TotalRows); ?>);\"><?php echo xlt(\"Recalculate\"); ?></button>\n                                </td>\n                            </tr>\n                            </table>\n                            <?php\n                        }\n                        ?>\n                        <?php\n                        echo '<br/>';\n                    }//End of if($RowSearchSub = sqlFetchArray($ResultSearchSub))\n                    ?>\n                    </div>\n                    </div>\n                    <div>\n                        <?php\n                        require_once(\"payment_pat_sel.inc.php\"); //Patient ajax section and listing of charges.\n                        ?>\n                    </div>\n                    <?php\n                }//End of if($payment_id*1>0)\n                ?>\n                <?php //can change position of buttons by creating a class 'position-override' and adding rule text-align:center or right as the case may be in individual stylesheets ?>\n                <div class=\"form-group clearfix\">\n                    <div class=\"col-sm-12 text-left position-override\">\n                        <div class=\"btn-group\" role=\"group\">\n                            <a class=\"btn btn-secondary btn-save\" href=\"#\" onclick=\"return ModifyPayments();\"><span><?php echo xlt('Modify Payments'); ?></span></a>\n                            <a class=\"btn btn-secondary btn-save\" href=\"#\" onclick=\"return FinishPayments();\"><span><?php echo xlt('Finish Payments'); ?></span></a>\n                        </div>\n                    </div>\n                </div>\n                <div class=\"row\">\n                    <input type=\"hidden\" name=\"hidden_patient_code\" id=\"hidden_patient_code\" value=\"<?php echo attr($hidden_patient_code ?? ''); ?>\" />\n                    <input type='hidden' name='mode' id='mode' value='' />\n                    <input type='hidden' name='ajax_mode' id='ajax_mode' value='' />\n                    <input type=\"hidden\" name=\"after_value\" id=\"after_value\" value=\"<?php echo attr($_POST[\"mode\"] ?? ''); ?>\" />\n                    <input type=\"hidden\" name=\"payment_id\" id=\"payment_id\" value=\"<?php echo attr($payment_id); ?>\" />\n                    <input type=\"hidden\" name=\"hidden_type_code\" id=\"hidden_type_code\" value=\"<?php echo attr($TypeCode); ?>\" />\n                    <input type='hidden' name='global_amount' id='global_amount' value='' />\n                    <input type='hidden' name='DeletePaymentDistributionId' id='DeletePaymentDistributionId' value='' />\n                    <input type=\"hidden\" name=\"ActionStatus\" id=\"ActionStatus\" value=\"<?php echo attr($Message ?? ''); ?>\" />\n                    <input type='hidden' name='CountIndexAbove' id='CountIndexAbove' value='<?php echo attr($CountIndexAbove * 1); ?>' />\n                    <input type='hidden' name='CountIndexBelow' id='CountIndexBelow' value='<?php echo attr($CountIndexBelow * 1); ?>' />\n                    <input type=\"hidden\" name=\"ParentPage\" id=\"ParentPage\" value=\"<?php echo attr($_REQUEST['ParentPage'] ?? ''); ?>\" />\n                </div>\n        </form>\n    </div><!-- End of container div-->\n    <script>\n        function ResetForm() {//Resets form used in the 'Cancel Changes' button in the master screen.\n            document.forms[0].reset();\n            document.getElementById('TdUnappliedAmount').innerHTML = '0.00';\n            document.getElementById('div_insurance_or_patient').innerHTML = '&nbsp;';\n            CheckVisible('yes');//Payment Method is made 'Check Payment' and the Check box is made visible.\n            PayingEntityAction();//Paying Entity is made 'insurance' and Payment Category is 'Insurance Payment'\n        }\n\n        $(function () {\n            if (document.getElementById(\"TableDistributePortion\")) {\n                $(\"html\").animate({scrollTop: $(\"#TableDistributePortion\").offset().top}, 800);\n            } else if (document.getElementById(\"TableDistributedEdit\")) {\n                $(\"html\").animate({scrollTop: $(\"#TableDistributedEdit\").offset().top}, 800);\n            }\n        });\n    </script>\n</body>\n</html>\n", "<?php\n\n/**\n * Patient Tracker (Patient Flow Board)\n *\n * This program displays the information entered in the Calendar program ,\n * allowing the user to change status and view those changed here and in the Calendar\n * Will allow the collection of length of time spent in each status\n *\n * @package OpenEMR\n * @link    http://www.open-emr.org\n * @author  Terry Hill <terry@lilysystems.com>\n * @author  Brady Miller <brady.g.miller@gmail.com>\n * @author  Ray Magauran <magauran@medexbank.com>\n * @copyright Copyright (c) 2015-2017 Terry Hill <terry@lillysystems.com>\n * @copyright Copyright (c) 2017-2021 Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) 2017 Ray Magauran <magauran@medexbank.com>\n * @license https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\nrequire_once \"../globals.php\";\nrequire_once \"$srcdir/patient.inc\";\nrequire_once \"$srcdir/options.inc.php\";\nrequire_once \"$srcdir/patient_tracker.inc.php\";\nrequire_once \"$srcdir/user.inc\";\nrequire_once \"$srcdir/MedEx/API.php\";\n\nuse OpenEMR\\Common\\Csrf\\CsrfUtils;\nuse OpenEMR\\Core\\Header;\n\nif (!empty($_POST)) {\n    if (!CsrfUtils::verifyCsrfToken($_POST[\"csrf_token_form\"])) {\n        CsrfUtils::csrfNotVerified();\n    }\n}\n\n// These settings are sticky user preferences linked to a given page.\n// mdsupport - user_settings prefix\n$uspfx = substr(__FILE__, strlen($webserver_root)) . '.';\n$setting_new_window = prevSetting($uspfx, 'setting_new_window', 'setting_new_window', ' ');\n// flow board and recall board share bootstrap settings:\n$setting_bootstrap_submenu = prevSetting('', 'setting_bootstrap_submenu', 'setting_bootstrap_submenu', ' ');\n$setting_selectors = prevSetting($uspfx, 'setting_selectors', 'setting_selectors', 'block');\n$form_apptcat = prevSetting($uspfx, 'form_apptcat', 'form_apptcat', '');\n$form_apptstatus = prevSetting($uspfx, 'form_apptstatus', 'form_apptstatus', '');\n$facility = prevSetting($uspfx, 'form_facility', 'form_facility', '');\n$provider = prevSetting($uspfx, 'form_provider', 'form_provider', $_SESSION['authUserID']);\n\nif (\n    ($_POST['setting_new_window'] ?? '') ||\n    ($_POST['setting_bootstrap_submenu'] ?? '') ||\n    ($_POST['setting_selectors'] ?? '')\n) {\n    // These are not form elements. We only ever change them via ajax, so exit now.\n    exit();\n}\nif (($_POST['saveCALLback'] ?? '') == \"Save\") {\n    $sqlINSERT = \"INSERT INTO medex_outgoing (msg_pc_eid,msg_pid,campaign_uid,msg_type,msg_reply,msg_extra_text)\n                  VALUES\n                (?,?,?,'NOTES','CALLED',?)\";\n    sqlQuery($sqlINSERT, array($_POST['pc_eid'], $_POST['pc_pid'], $_POST['campaign_uid'], $_POST['txtCALLback']));\n}\n\n//set default start date of flow board to value based on globals\nif (!$GLOBALS['ptkr_date_range']) {\n    $from_date = date('Y-m-d');\n} elseif (!is_null($_REQUEST['form_from_date'])) {\n    $from_date = DateToYYYYMMDD($_REQUEST['form_from_date']);\n} elseif (($GLOBALS['ptkr_start_date']) == 'D0') {\n    $from_date = date('Y-m-d');\n} elseif (($GLOBALS['ptkr_start_date']) == 'B0') {\n    if (date(w) == GLOBALS['first_day_week']) {\n        //today is the first day of the week\n        $from_date = date('Y-m-d');\n    } elseif ($GLOBALS['first_day_week'] == 0) {\n        //Sunday\n        $from_date = date('Y-m-d', strtotime('previous sunday'));\n    } elseif ($GLOBALS['first_day_week'] == 1) {\n        //Monday\n        $from_date = date('Y-m-d', strtotime('previous monday'));\n    } elseif ($GLOBALS['first_day_week'] == 6) {\n        //Saturday\n        $from_date = date('Y-m-d', strtotime('previous saturday'));\n    }\n} else {\n    //shouldnt be able to get here...\n    $from_date = date('Y-m-d');\n}\n\n//set default end date of flow board to value based on globals\nif ($GLOBALS['ptkr_date_range']) {\n    if (substr($GLOBALS['ptkr_end_date'], 0, 1) == 'Y') {\n        $ptkr_time = substr($GLOBALS['ptkr_end_date'], 1, 1);\n        $ptkr_future_time = mktime(0, 0, 0, date('m'), date('d'), date('Y') + $ptkr_time);\n    } elseif (substr($GLOBALS['ptkr_end_date'], 0, 1) == 'M') {\n        $ptkr_time = substr($GLOBALS['ptkr_end_date'], 1, 1);\n        $ptkr_future_time = mktime(0, 0, 0, date('m') + $ptkr_time, date('d'), date('Y'));\n    } elseif (substr($GLOBALS['ptkr_end_date'], 0, 1) == 'D') {\n        $ptkr_time = substr($GLOBALS['ptkr_end_date'], 1, 1);\n        $ptkr_future_time = mktime(0, 0, 0, date('m'), date('d') + $ptkr_time, date('Y'));\n    }\n\n    $to_date = date('Y-m-d', $ptkr_future_time);\n    $to_date = !is_null($_REQUEST['form_to_date']) ? DateToYYYYMMDD($_REQUEST['form_to_date']) : $to_date;\n} else {\n    $to_date = date('Y-m-d');\n}\n\n$form_patient_name = !is_null($_POST['form_patient_name']) ? $_POST['form_patient_name'] : null;\n$form_patient_id = !is_null($_POST['form_patient_id']) ? $_POST['form_patient_id'] : null;\n\n\n$lres = sqlStatement(\"SELECT option_id, title FROM list_options WHERE list_id = ? AND activity=1\", array('apptstat'));\nwhile ($lrow = sqlFetchArray($lres)) {\n    // if exists, remove the legend character\n    if ($lrow['title'][1] == ' ') {\n        $splitTitle = explode(' ', $lrow['title']);\n        array_shift($splitTitle);\n        $title = implode(' ', $splitTitle);\n    } else {\n        $title = $lrow['title'];\n    }\n    $statuses_list[$lrow['option_id']] = $title;\n}\n\nif ($GLOBALS['medex_enable'] == '1') {\n    $query2 = \"SELECT * FROM medex_icons\";\n    $iconed = sqlStatement($query2);\n    while ($icon = sqlFetchArray($iconed)) {\n        $icons[$icon['msg_type']][$icon['msg_status']]['html'] = $icon['i_html'];\n    }\n    $MedEx = new MedExApi\\MedEx('MedExBank.com');\n    $sql = \"SELECT * FROM medex_prefs LIMIT 1\";\n    $preferences = sqlStatement($sql);\n    $prefs = sqlFetchArray($preferences);\n    $results = json_decode($prefs['status'], true);\n    $logged_in = $results;\n    $logged_in = $results;\n    if (!empty($logged_in['token'])) {\n        $current_events = xlt(\"On-line\");\n    } else {\n        $current_events = xlt(\"Currently off-line\");\n    }\n}\n\nif (!$_REQUEST['flb_table']) {\n    ?>\n<html>\n<head>\n    <meta name=\"author\" content=\"OpenEMR: MedExBank\" />\n    <?php Header::setupHeader(['datetime-picker', 'opener']); ?>\n    <title><?php echo xlt('Flow Board'); ?></title>\n    <script>\n        <?php require_once \"$srcdir/restoreSession.php\"; ?>\n    </script>\n\n    <?php if ($_SESSION['language_direction'] == \"rtl\") { ?>\n      <link rel=\"stylesheet\" href=\"<?php echo $GLOBALS['themes_static_relative']; ?>/misc/rtl_bootstrap_navbar.css?v=<?php echo $GLOBALS['v_js_includes']; ?>\" />\n    <?php } else { ?>\n      <link rel=\"stylesheet\" href=\"<?php echo $GLOBALS['themes_static_relative']; ?>/misc/bootstrap_navbar.css?v=<?php echo $GLOBALS['v_js_includes']; ?>\" />\n    <?php } ?>\n\n    <script src=\"<?php echo $GLOBALS['web_root']; ?>/interface/main/messages/js/reminder_appts.js?v=<?php echo $v_js_includes; ?>\"></script>\n</head>\n\n<body>\n    <?php\n    if (($GLOBALS['medex_enable'] == '1') && (empty($_REQUEST['nomenu']))) {\n        $logged_in = $MedEx->login();\n        $MedEx->display->navigation($logged_in);\n    }\n    ?>\n    <div class=\"container mt-3\">\n        <div id=\"flb_selectors\" style=\"display:<?php echo attr($setting_selectors); ?>;\">\n            <h2 class=\"text-center\"><?php echo xlt('Flow Board'); ?></h2>\n            <div class=\"jumbotron p-4\">\n                <div class=\"showRFlow text-center\" id=\"show_flows\" name=\"kiosk_hide\">\n                    <div name=\"div_response\" id=\"div_response\" class=\"nodisplay\"></div>\n                        <form name=\"flb\" id=\"flb\" method=\"post\">\n                        <div class=\"row\">\n                          <input type=\"hidden\" name=\"csrf_token_form\" value=\"<?php echo attr(CsrfUtils::collectCsrfToken()); ?>\" />\n                            <div class=\"text-center col-4 align-items-center\">\n                              <!-- Visit Categories Section -->\n                              <div class=\"col-sm\">\n                                <select id=\"form_apptcat\" name=\"form_apptcat\" class=\"form-control form-control-sm\" onchange=\"refineMe('apptcat');\">\n                                  <?php\n                                    $categories = fetchAppointmentCategories();\n                                    echo \"<option value=''>\" . xlt(\"Visit Categories\") . \"</option>\";\n                                    while ($cat = sqlFetchArray($categories)) {\n                                        echo \"<option value='\" . attr($cat['id']) . \"'\";\n                                        if ($cat['id'] == $_POST['form_apptcat']) {\n                                            echo \" selected='true' \";\n                                        }\n                                        echo \">\" . xlt($cat['category']) . \"</option>\";\n                                    }\n                                    ?>\n                                </select>\n                              </div>\n                              <!-- Visit Status Section -->\n                              <div class=\"col-sm\">\n                                <select id=\"form_apptstatus\" name=\"form_apptstatus\" class=\"form-control form-control-sm\" onchange=\"refineMe();\">\n                                  <option value=\"\"><?php echo xlt(\"Visit Status\"); ?></option>\n                                  <?php\n                                    $apptstats = sqlStatement(\"SELECT * FROM list_options WHERE list_id = 'apptstat' AND activity = 1 ORDER BY seq\");\n                                    while ($apptstat = sqlFetchArray($apptstats)) {\n                                        echo \"<option value='\" . attr($apptstat['option_id']) . \"'\";\n                                        if ($apptstat['option_id'] == $_POST['form_apptstatus']) {\n                                            echo \" selected='true' \";\n                                        }\n                                        echo \">\" . xlt($apptstat['title']) . \"</option>\";\n                                    }\n                                    ?>\n                                </select>\n                              </div>\n                              <!-- Facility Section -->\n                              <div class=\"col-sm\">\n                                  <select class=\"form-control form-control-sm\" id=\"form_facility\" name=\"form_facility\"\n                                      <?php\n                                        $fac_sql = sqlStatement(\"SELECT * FROM facility ORDER BY id\");\n                                        while ($fac = sqlFetchArray($fac_sql)) {\n                                            $true = ($fac['id'] == $_POST['form_facility']) ? \"selected=true\" : '';\n                                            $select_facs .= \"<option value=\" . attr($fac['id']) . \" \" . $true . \">\" . text($fac['name']) . \"</option>\\n\";\n                                            $count_facs++;\n                                        }\n                                        if ($count_facs < '1') {\n                                            echo \"disabled\";\n                                        }\n                                        ?> onchange=\"refineMe('facility');\">\n                                      <option value=\"\"><?php echo xlt('All Facilities'); ?></option>\n                                      <?php echo $select_facs; ?>\n                                  </select>\n                              </div>\n\n                              <?php\n                              // Build a drop-down list of ACTIVE providers.\n                                $query = \"SELECT id, lname, fname FROM users WHERE \" .\n                                  \"authorized = 1  AND active = 1 AND username > '' ORDER BY lname, fname\"; #(CHEMED) facility filter\n                                $ures = sqlStatement($query);\n                                while ($urow = sqlFetchArray($ures)) {\n                                    $provid = $urow['id'];\n                                    $select_provs .= \"    <option value='\" . attr($provid) . \"'\";\n                                    if (isset($_POST['form_provider']) && $provid == $_POST['form_provider']) {\n                                        $select_provs .= \" selected\";\n                                    } elseif (!isset($_POST['form_provider']) && $_SESSION['userauthorized'] && $provid == $_SESSION['authUserID']) {\n                                        $select_provs .= \" selected\";\n                                    }\n                                    $select_provs .= \">\" . text($urow['lname']) . \", \" . text($urow['fname']) . \"\\n\";\n                                    $count_provs++;\n                                }\n                                ?>\n                              <!-- Provider Section -->\n                              <div class=\"col-sm\">\n                                  <select class=\"form-control form-control-sm\" id=\"form_provider\" name=\"form_provider\" <?php\n                                    if ($count_provs < '2') {\n                                        echo \"disabled\";\n                                    }\n                                    ?> onchange=\"refineMe('provider');\">\n                                      <option value=\"\" selected><?php echo xlt('All Providers'); ?></option>\n\n                                      <?php\n                                        echo $select_provs;\n                                        ?>\n                                  </select>\n                              </div>\n                            </div>\n                              <?php\n                                if ($GLOBALS['ptkr_date_range'] == '1') {\n                                    $type = 'date';\n                                    $style = '';\n                                } else {\n                                    $type = 'hidden';\n                                    $style = 'display:none;';\n                                } ?>\n                            <div class=\"col-4 mt-3 nowrap row\" style=\"<?php echo $style; ?>\">\n\n                              <label class=\"col-form-label col-sm-3 text-right\" for=\"flow_from\"><?php echo xlt('From'); ?>:</label>\n                              <div class=\"col-sm-9\">\n                                <input type=\"text\" id=\"form_from_date\" name=\"form_from_date\" class=\"datepicker form-control form-control-sm text-center\" value=\"<?php echo attr(oeFormatShortDate($from_date)); ?>\"/>\n                              </div>\n                              <label class=\"col-form-label col-sm-3 text-right\" for=\"flow_to\"><?php echo xlt('To{{Range}}'); ?>:</label>\n                              <div class=\"col-sm-9\">\n                                  <input type=\"text\" id=\"form_to_date\" name=\"form_to_date\" class=\"datepicker form-control form-control-sm text-center\" value=\"<?php echo attr(oeFormatShortDate($to_date)); ?>\"/>\n                              </div>\n\n                              <div class=\"col-sm-12 mt-3 mx-auto\">\n                                  <button id=\"filter_submit\" class=\"btn btn-primary btn-sm btn-filter\"><?php echo xlt('Filter'); ?></button>\n                                  <input type=\"hidden\" id=\"kiosk\" name=\"kiosk\" value=\"<?php echo attr($_REQUEST['kiosk']); ?>\" />\n                              </div>\n                            </div>\n                            <div class=\"col-4 mt-3 row\">\n                                <div class=\"col-sm-12 text-center\">\n                                    <!-- Patient Name Section -->\n                                      <input type=\"text\" placeholder=\"<?php echo xla('Patient Name'); ?>\" class=\"form-control form-control-sm\" id=\"form_patient_name\" name=\"form_patient_name\" value=\"<?php echo ($form_patient_name) ? attr($form_patient_name) : \"\"; ?>\" onKeyUp=\"refineMe();\" />\n                                </div>\n                                <div class=\"col-sm-12 text-center\">\n                                        <!-- Patient ID Section -->\n                                            <input placeholder=\"<?php echo xla('Patient ID'); ?>\" class=\"form-control form-control-sm\" type=\"text\" id=\"form_patient_id\" name=\"form_patient_id\" value=\"<?php echo ($form_patient_id) ? attr($form_patient_id) : \"\"; ?>\" onKeyUp=\"refineMe();\" />\n                                </div>\n                                <div class=\"col-sm-12 mx-auto\">\n                                    <div class=\"text-center pt-3 mx-auto\">\n\n                                        <?php if ($GLOBALS['medex_enable'] == '1') { ?>\n                                          <b>MedEx:</b>\n                                                <a href=\"https://medexbank.com/cart/upload/index.php?route=information/campaigns&amp;g=rem\"\n                                                   target=\"_medex\">\n                                                    <?php echo $current_events; ?>\n                                                </a>\n                                          <?php } ?>\n                                    </div>\n                                </div>\n                            </div>\n                            <div id=\"message\" class=\"warning\"></div>\n                        </div>\n                    </form>\n                </div>\n            </div>\n        </div>\n    <div class=\"row-fluid\">\n        <div class=\"col-md-12\">\n            <div class=\"text-center row mx-auto divTable\">\n                <div class=\"col-sm-12\" id=\"loader\">\n                    <div class=\"spinner-border\" role=\"status\">\n                        <span class=\"sr-only\"><?php echo xlt('Loading data'); ?>...</span>\n                    </div>\n                    <h2><?php echo xlt('Loading data'); ?>...</h2>\n                </div>\n                <div id=\"flb_table\" name=\"flb_table\" class=\"w-100\">\n            <?php\n} else {\n    //end of if !$_REQUEST['flb_table'] - this is the table we fetch via ajax during a refreshMe() call\n    // get all appts for date range and refine view client side.  very fast...\n    $appointments = array();\n    $datetime = date(\"Y-m-d H:i:s\");\n    $appointments = fetch_Patient_Tracker_Events($from_date, $to_date, '', '', '', '', $form_patient_name, $form_patient_id);\n    $appointments = sortAppointments($appointments, 'date', 'time');\n    //grouping of the count of every status\n    $appointments_status = getApptStatus($appointments);\n\n    $chk_prov = array();  // list of providers with appointments\n    // Scan appointments for additional info\n    foreach ($appointments as $apt) {\n        $chk_prov[$apt['uprovider_id']] = $apt['ulname'] . ', ' . $apt['ufname'] . ' ' . $apt['umname'];\n    }\n    ?>\n                <div class=\"col-sm-12 text-center m-1\">\n                <div class=\" d-sm-block\">\n                    <span id=\"status_summary\">\n                        <?php\n                        $statuses_output = \"<span class='text badge badge-light'><em>\" . xlt('Total patients') . ':</em> ' . text($appointments_status['count_all']) . \"</span>\";\n                        unset($appointments_status['count_all']);\n                        foreach ($appointments_status as $status_symbol => $count) {\n                            $statuses_output .= \" | <span><em>\" . text(xl_list_label($statuses_list[$status_symbol])) . \":</em> <span class='badge badge-light'>\" . text($count) . \"</span></span>\";\n                        }\n                        echo $statuses_output;\n                        ?>\n                    </span>\n                </div>\n                <div id=\"pull_kiosk_right\" class=\"text-right\">\n                    <span class=\"fa-stack fa-lg\" id=\"flb_caret\" onclick=\"toggleSelectors();\" title=\"<?php echo xla('Show/Hide the Selection Area'); ?>\" style=\"color:<?php echo $color = ($setting_selectors == 'none') ? 'var(--danger)' : 'var(--black)'; ?>;\">\n                        <i class=\"far fa-square fa-stack-2x\"></i>\n                        <i id=\"print_caret\" class='fa fa-caret-<?php echo $caret = ($setting_selectors == 'none') ? 'down' : 'up'; ?> fa-stack-1x'></i>\n                    </span>\n\n                    <a class=\"btn btn-primary btn-setting\" data-toggle=\"collapse\" href=\"#collapseSetting\">\n                        <?php echo xlt('Setting'); ?>\n                    </a>\n                    <a class='btn btn-primary btn-refresh' id='refreshme'><?php echo xlt('Refresh'); ?></a>\n                    <a class='btn btn-primary btn-print' onclick=\"print_FLB();\"> <?php echo xlt('Print'); ?></a>\n                    <a class='btn btn-primary' onclick=\"kiosk_FLB();\"> <?php echo xlt('Kiosk'); ?></a>\n                    <div class=\"collapse mt-2 mb-2\" id=\"collapseSetting\">\n                        <input type='checkbox' name='setting_new_window' id='setting_new_window' value='<?php echo attr($setting_new_window); ?>' <?php echo attr($setting_new_window); ?> />\n                        <?php echo xlt('Open Patient in New Window'); ?>\n                    </div>\n                </div>\n            </div>\n\n                    <div class=\"table-responsive mt-3\">\n                    <table class=\"table table-bordered\">\n                    <thead class=\"table-primary\">\n                    <tr class=\"small font-weight-bold text-center\">\n                        <?php if ($GLOBALS['ptkr_show_pid']) { ?>\n                            <td class=\"dehead text-center text-ovr-dark\" name=\"kiosk_hide\">\n                                <?php echo xlt('PID'); ?>\n                            </td>\n                        <?php } ?>\n                        <td class=\"dehead text-center text-ovr-dark\" style=\"max-width: 150px;\">\n                            <?php echo xlt('Patient'); ?>\n                        </td>\n                        <?php if ($GLOBALS['ptkr_visit_reason'] == '1') { ?>\n                            <td class=\"dehead text-center text-ovr-dark\" name=\"kiosk_hide\">\n                                <?php echo xlt('Reason'); ?>\n                            </td>\n                        <?php } ?>\n                        <?php if ($GLOBALS['ptkr_show_encounter']) { ?>\n                            <td class=\"dehead text-center text-ovr-dark\" name=\"kiosk_hide\">\n                                <?php echo xlt('Encounter'); ?>\n                            </td>\n                        <?php } ?>\n\n                        <?php if ($GLOBALS['ptkr_date_range'] == '1') { ?>\n                            <td class=\"dehead text-center text-ovr-dark\" name=\"kiosk_hide\">\n                                <?php echo xlt('Appt Date'); ?>\n                            </td>\n                        <?php } ?>\n                        <td class=\"dehead text-center text-ovr-dark\">\n                            <?php echo xlt('Appt Time'); ?>\n                        </td>\n                        <td class=\"dehead text-center text-ovr-dark\">\n                            <?php echo xlt('Arrive Time'); ?>\n                        </td>\n                        <td class=\"dehead text-center d-block d-sm-none text-ovr-dark\">\n                            <?php echo xlt('Arrival'); ?>\n                        </td>\n                        <td class=\"dehead text-center  d-sm-table-cell text-ovr-dark\">\n                            <?php echo xlt('Appt Status'); ?>\n                        </td>\n                        <td class=\"dehead text-center  d-sm-table-cell text-ovr-dark\">\n                            <?php echo xlt('Current Status'); ?>\n                        </td>\n                        <td class=\"dehead text-center d-block d-table-cell d-sm-none text-ovr-dark\">\n                            <?php echo xlt('Current'); ?>\n                        </td>\n                        <td class=\"dehead text-center text-ovr-dark\" name=\"kiosk_hide\">\n                            <?php echo xlt('Visit Type'); ?>\n                        </td>\n                        <?php if (count($chk_prov) > 1) { ?>\n                            <td class=\"dehead text-center d-sm-table-cell text-ovr-dark\">\n                                <?php echo xlt('Provider'); ?>\n                            </td>\n                        <?php } ?>\n                        <td class=\"dehead text-center text-ovr-dark\">\n                            <?php echo xlt('Total Time'); ?>\n                        </td>\n                        <td class=\"dehead text-center  d-sm-table-cell text-ovr-dark\">\n                            <?php echo xlt('Check Out Time'); ?>\n                        </td>\n                        <td class=\"dehead text-center d-block d-table-cell d-sm-none text-ovr-dark\">\n                            <?php echo xlt('Out Time'); ?>\n                        </td>\n                        <?php\n                        if ($GLOBALS['ptkr_show_staff']) { ?>\n                            <td class=\"dehead text-center text-ovr-dark\" name=\"kiosk_hide\">\n                                <?php echo xlt('Updated By'); ?>\n                            </td>\n                            <?php\n                        }\n                        if ($_REQUEST['kiosk'] != '1') {\n                            if ($GLOBALS['drug_screen']) { ?>\n                                <td class=\"dehead center text-ovr-dark\" name=\"kiosk_hide\">\n                                    <?php echo xlt('Random Drug Screen'); ?>\n                                </td>\n                                <td class=\"dehead center text-ovr-dark\" name=\"kiosk_hide\">\n                                    <?php echo xlt('Drug Screen Completed'); ?>\n                                </td>\n                                <?php\n                            }\n                        } ?>\n                    </tr>\n                    </thead>\n                    <tbody>\n                    <?php\n                    $prev_appt_date_time = \"\";\n                    foreach ($appointments as $appointment) {\n                        // Collect appt date and set up squashed date for use below\n                        $date_appt = $appointment['pc_eventDate'];\n                        $date_squash = str_replace(\"-\", \"\", $date_appt);\n                        if (empty($appointment['room']) && ($logged_in) && ($setting_bootstrap_submenu != 'hide')) {\n                            //Patient has not arrived yet, display MedEx Reminder info\n                            //one icon per type of response.\n                            //If there was a SMS dialog, display it as a mouseover/title\n                            //Display date received also as mouseover title.\n                            $other_title = '';\n                            $title = '';\n                            $icon2_here = '';\n                            $icon_CALL = '';\n                            $icon_4_CALL = '';\n                            $appt['stage'] = '';\n                            $icon_here = array();\n                            $prog_text = '';\n                            $CALLED = '';\n                            $FINAL = '';\n                            $icon_CALL = '';\n\n                            $query = \"SELECT * FROM medex_outgoing WHERE msg_pc_eid =? ORDER BY medex_uid asc\";\n                            $myMedEx = sqlStatement($query, array($appointment['eid']));\n                            /**\n                             * Each row for this pc_eid in the medex_outgoing table represents an event.\n                             * Every event is recorded in $prog_text.\n                             * A modality is represented by an icon (eg mail icon, phone icon, text icon).\n                             * The state of the Modality is represented by the color of the icon:\n                             *      CONFIRMED       =   green\n                             *      READ            =   blue\n                             *      FAILED          =   pink\n                             *      SENT/in process =   yellow\n                             *      SCHEDULED       =   white\n                             * Icons are displayed in their highest state.\n                             */\n                            while ($row = sqlFetchArray($myMedEx)) {\n                                // Need to convert $row['msg_date'] to localtime (stored as GMT) & then oeFormatShortDate it.\n                                // I believe there is a new GLOBAL for server timezone???  If so, it will be easy.\n                                // If not we need to import it from Medex through medex_preferences.  It should really be in openEMR though.\n                                // Delete when we figure this out.\n                                $other_title = '';\n                                if (!empty($row['msg_extra_text'])) {\n                                    $local = attr($row['msg_extra_text']) . \" |\";\n                                }\n                                $prog_text .= attr(oeFormatShortDate($row['msg_date'])) . \" :: \" . attr($row['msg_type']) . \" : \" . attr($row['msg_reply']) . \" | \" . $local . \" |\";\n\n                                if ($row['msg_reply'] == 'Other') {\n                                    $other_title .= $row['msg_extra_text'] . \"\\n\";\n                                    $icon_extra .= str_replace(\n                                        \"EXTRA\",\n                                        attr(oeFormatShortDate($row['msg_date'])) . \"\\n\" . xla('Patient Message') . \":\\n\" . attr($row['msg_extra_text']) . \"\\n\",\n                                        $icons[$row['msg_type']]['EXTRA']['html']\n                                    );\n                                    continue;\n                                } elseif ($row['msg_reply'] == 'CANCELLED') {\n                                    $appointment[$row['msg_type']]['stage'] = \"CANCELLED\";\n                                    $icon_here[$row['msg_type']] = '';\n                                } elseif ($row['msg_reply'] == \"FAILED\") {\n                                    $appointment[$row['msg_type']]['stage'] = \"FAILED\";\n                                    $icon_here[$row['msg_type']] = $icons[$row['msg_type']]['FAILED']['html'];\n                                } elseif (($row['msg_reply'] == \"CONFIRMED\") || ($appointment[$row['msg_type']]['stage'] == \"CONFIRMED\")) {\n                                    $appointment[$row['msg_type']]['stage'] = \"CONFIRMED\";\n                                    $icon_here[$row['msg_type']]  = $icons[$row['msg_type']]['CONFIRMED']['html'];\n                                } elseif ($row['msg_type'] == \"NOTES\") {\n                                    $CALLED = \"1\";\n                                    $FINAL = $icons['NOTES']['CALLED']['html'];\n                                    $icon_CALL = str_replace(\"Call Back: COMPLETED\", attr(oeFormatShortDate($row['msg_date'])) . \" :: \" . xla('Callback Performed') . \" | \" . xla('NOTES') . \": \" . $row['msg_extra_text'] . \" | \", $FINAL);\n                                    continue;\n                                } elseif (($row['msg_reply'] == \"READ\") || ($appointment[$row['msg_type']]['stage'] == \"READ\")) {\n                                    $appointment[$row['msg_type']]['stage'] = \"READ\";\n                                    $icon_here[$row['msg_type']] = $icons[$row['msg_type']]['READ']['html'];\n                                } elseif (($row['msg_reply'] == \"SENT\") || ($appointment[$row['msg_type']]['stage'] == \"SENT\")) {\n                                    $appointment[$row['msg_type']]['stage'] = \"SENT\";\n                                    $icon_here[$row['msg_type']] = $icons[$row['msg_type']]['SENT']['html'];\n                                } elseif (($row['msg_reply'] == \"To Send\") || (empty($appointment['stage']))) {\n                                    if (\n                                        ($appointment[$row['msg_type']]['stage'] != \"CONFIRMED\") &&\n                                        ($appointment[$row['msg_type']]['stage'] != \"READ\") &&\n                                        ($appointment[$row['msg_type']]['stage'] != \"SENT\") &&\n                                        ($appointment[$row['msg_type']]['stage'] != \"FAILED\")\n                                    ) {\n                                        $appointment[$row['msg_type']]['stage'] = \"QUEUED\";\n                                        $icon_here[$row['msg_type']] = $icons[$row['msg_type']]['SCHEDULED']['html'];\n                                    }\n                                }\n                                //these are additional icons if present\n                                if (($row['msg_reply'] == \"CALL\") && (!$CALLED)) {\n                                    $icon_here = '';\n                                    $icon_4_CALL = $icons[$row['msg_type']]['CALL']['html'];\n                                    $icon_CALL = \"<span onclick=\\\"doCALLback(\" . attr_js($date_squash) . \",\" . attr_js($appointment['eid']) . \",\" . attr_js($appointment['pc_cattype']) . \")\\\">\" . $icon_4_CALL . \"</span>\n                                    <span class='hidden' name='progCALLback_\" . attr($appointment['eid']) . \"' id='progCALLback_\" . attr($appointment['eid']) . \"'>\n                                      <form id='notation_\" . attr($appointment['eid']) . \"' method='post'\n                                      action='#'>\n                                        <input type='hidden' name='csrf_token_form' value='\" . attr(CsrfUtils::collectCsrfToken()) . \"' />\n                                        <h4>\" . xlt('Call Back Notes') . \":</h4>\n                                        <input type='hidden' name='pc_eid' id='pc_eid' value='\" . attr($appointment['eid']) . \"'>\n                                        <input type='hidden' name='pc_pid' id='pc_pid' value='\" . attr($appointment['pc_pid']) . \"'>\n                                        <input type='hidden' name='campaign_uid' id='campaign_uid' value='\" . attr($row['campaign_uid']) . \"'>\n                                        <textarea name='txtCALLback' id='txtCALLback' rows=6 cols=20></textarea>\n                                        <input type='submit' name='saveCALLback' id='saveCALLback' value='\" . xla(\"Save\") . \"'>\n                                      </form>\n                                    </span>\n                                      \";\n                                } elseif ($row['msg_reply'] == \"STOP\") {\n                                    $icon2_here .= $icons[$row['msg_type']]['STOP']['html'];\n                                } elseif ($row['msg_reply'] == \"Other\") {\n                                    $icon2_here .= $icons[$row['msg_type']]['Other']['html'];\n                                } elseif ($row['msg_reply'] == \"CALLED\") {\n                                    $icon2_here .= $icons[$row['msg_type']]['CALLED']['html'];\n                                }\n                            }\n                            //if pc_apptstatus == '-', update it now to=status\n                            if (!empty($other_title)) {\n                                $appointment['messages'] = $icon2_here . $icon_extra;\n                            }\n                        }\n\n                        // Collect variables and do some processing\n                        $docname = $chk_prov[$appointment['uprovider_id']];\n                        if (strlen($docname) <= 3) {\n                            continue;\n                        }\n                        $ptname = $appointment['lname'] . ', ' . $appointment['fname'] . ' ' . $appointment['mname'];\n                        $ptname_short = $appointment['fname'][0] . \" \" . $appointment['lname'][0];\n                        $appt_enc = $appointment['encounter'];\n                        $appt_eid = (!empty($appointment['eid'])) ? $appointment['eid'] : $appointment['pc_eid'];\n                        $appt_pid = (!empty($appointment['pid'])) ? $appointment['pid'] : $appointment['pc_pid'];\n                        if ($appt_pid == 0) {\n                            continue; // skip when $appt_pid = 0, since this means it is not a patient specific appt slot\n                        }\n                        $status = (!empty($appointment['status']) && (!is_numeric($appointment['status']))) ? $appointment['status'] : $appointment['pc_apptstatus'];\n                        $appt_room = (!empty($appointment['room'])) ? $appointment['room'] : $appointment['pc_room'];\n                        $appt_time = (!empty($appointment['appttime'])) ? $appointment['appttime'] : $appointment['pc_startTime'];\n                        $tracker_id = $appointment['id'];\n                        // reason for visit\n                        if ($GLOBALS['ptkr_visit_reason']) {\n                            $reason_visit = $appointment['pc_hometext'];\n                        }\n                        $newarrive = collect_checkin($tracker_id);\n                        $newend = collect_checkout($tracker_id);\n                        $colorevents = (collectApptStatusSettings($status));\n                        $bgcolor = $colorevents['color'];\n                        $statalert = $colorevents['time_alert'];\n                        // process the time to allow items with a check out status to be displayed\n                        if (is_checkout($status) && (($GLOBALS['checkout_roll_off'] > 0) && strlen($form_apptstatus) != 1)) {\n                            $to_time = strtotime($newend);\n                            $from_time = strtotime($datetime);\n                            $display_check_out = round(abs($from_time - $to_time) / 60, 0);\n                            if ($display_check_out >= $GLOBALS['checkout_roll_off']) {\n                                continue;\n                            }\n                        }\n\n                        echo '<tr data-apptstatus=\"' . attr($appointment['pc_apptstatus']) . '\"\n                            data-apptcat=\"' . attr($appointment['pc_catid']) . '\"\n                            data-facility=\"' . attr($appointment['pc_facility']) . '\"\n                            data-provider=\"' . attr($appointment['uprovider_id']) . '\"\n                            data-pid=\"' . attr($appointment['pc_pid']) . '\"\n                            data-pname=\"' . attr($ptname) . '\"\n                            class=\"text-small\"\n                            style=\"background-color:' . attr($bgcolor) . ';\" >';\n\n                        if ($GLOBALS['ptkr_show_pid']) {\n                            ?>\n                            <td class=\"detail text-center\" name=\"kiosk_hide\">\n                                <?php echo text($appt_pid); ?>\n                            </td>\n                            <?php\n                        }\n\n                        ?>\n                        <td class=\"detail text-center\" name=\"kiosk_hide\">\n                            <a href=\"#\" onclick=\"return topatient(<?php echo attr_js($appt_pid); ?>,<?php echo attr_js($appt_enc); ?>)\">\n                                <?php echo text($ptname); ?></a>\n                        </td>\n\n                        <td class=\"detail text-center\" style=\"white-space: normal;\" name=\"kiosk_show\">\n                            <a href=\"#\" onclick=\"return topatient(<?php echo attr_js($appt_pid); ?>,<?php echo attr_js($appt_enc); ?>)\">\n                                <?php echo text($ptname_short); ?></a>\n                        </td>\n\n                        <!-- reason -->\n                        <?php if ($GLOBALS['ptkr_visit_reason']) { ?>\n                            <td class=\"detail text-center\" name=\"kiosk_hide\">\n                                <?php echo text($reason_visit) ?>\n                            </td>\n                        <?php } ?>\n                        <?php if ($GLOBALS['ptkr_show_encounter']) { ?>\n                            <td class=\"detail text-center\" name=\"kiosk_hide\">\n                                <?php\n                                if ($appt_enc != 0) {\n                                    echo text($appt_enc);\n                                }\n                                ?>\n                            </td>\n                        <?php } ?>\n                        <?php if ($GLOBALS['ptkr_date_range'] == '1') { ?>\n                            <td class=\"detail text-center\" name=\"kiosk_hide\">\n                                <?php echo text(oeFormatShortDate($appointment['pc_eventDate']));\n                                ?>\n                            </td>\n                        <?php } ?>\n                        <td class=\"detail text-center\">\n                            <?php echo text(oeFormatTime($appt_time)); ?>\n                        </td>\n                        <td class=\"detail text-center\">\n                            <?php\n                            if ($newarrive) {\n                                echo text(oeFormatTime($newarrive));\n                            }\n                            ?>\n                        </td>\n                        <td class=\"detail text-center \">\n                            <?php if (empty($tracker_id)) { //for appt not yet with tracker id and for recurring appt ?>\n                            <a class=\"btn btn-primary btn-sm\" onclick=\"return calendarpopup(<?php echo attr_js($appt_eid) . \",\" . attr_js($date_squash); // calls popup for add edit calendar event?>)\">\n                            <?php } else { ?>\n                                <a class=\"btn btn-primary btn-s\" onclick=\"return bpopup(<?php echo attr_js($tracker_id); // calls popup for patient tracker status?>)\">\n                            <?php } ?>\n                            <?php\n                            if ($appointment['room'] > '') {\n                                echo text(getListItemTitle('patient_flow_board_rooms', $appt_room));\n                            } else {\n                                echo text(getListItemTitle(\"apptstat\", $status)); // drop down list for appointment status\n                            }\n                            ?>\n                            </a>\n                        </td>\n\n                        <?php\n                        //time in current status\n                        $to_time = strtotime(date(\"Y-m-d H:i:s\"));\n                        $yestime = '0';\n                        if (strtotime($newend) != '') {\n                            $from_time = strtotime($newarrive);\n                            $to_time = strtotime($newend);\n                            $yestime = '0';\n                        } else {\n                            $from_time = strtotime($appointment['start_datetime']);\n                            $yestime = '1';\n                        }\n\n                        $timecheck = round(abs($to_time - $from_time) / 60, 0);\n                        if ($timecheck >= $statalert && ($statalert > '0')) { // Determine if the time in status limit has been reached.\n                            echo \"<td class='text-center  js-blink-infinite small' nowrap>  \"; // and if so blink\n                        } else {\n                            echo \"<td class='detail text-center' nowrap> \"; // and if not do not blink\n                        }\n                        if (($yestime == '1') && ($timecheck >= 1) && (strtotime($newarrive) != '')) {\n                            echo text($timecheck . ' ' . ($timecheck >= 2 ? xl('minutes') : xl('minute')));\n                        } elseif ($icon_here || $icon2_here || $icon_CALL) {\n                            echo \"<span style='font-size:0.7rem;' onclick='return calendarpopup(\" . attr_js($appt_eid) . \",\" . attr_js($date_squash) . \")'>\" . implode($icon_here) . $icon2_here . \"</span> \" . $icon_CALL;\n                        } elseif ($logged_in) {\n                            $pat = $MedEx->display->possibleModalities($appointment);\n                            echo \"<span style='font-size:0.7rem;' onclick='return calendarpopup(\" . attr_js($appt_eid) . \",\" . attr_js($date_squash) . \")'>\" . $pat['SMS'] . $pat['AVM'] . $pat['EMAIL'] . \"</span>\";\n                        }\n                        //end time in current status\n                        echo \"</td>\";\n                        ?>\n                        <td class=\"detail text-center\" name=\"kiosk_hide\">\n                            <?php echo xlt($appointment['pc_title']); ?>\n                        </td>\n                        <?php\n                        if (count($chk_prov) > 1) { ?>\n                            <td class=\"detail text-center  d-sm-table-cell\">\n                                <?php echo text($docname); ?>\n                            </td>\n                            <?php\n                        } ?>\n                        <td class=\"detail text-center\">\n                            <?php\n                            // total time in practice\n                            if (strtotime($newend) != '') {\n                                $from_time = strtotime($newarrive);\n                                $to_time = strtotime($newend);\n                            } else {\n                                $from_time = strtotime($newarrive);\n                                $to_time = strtotime(date(\"Y-m-d H:i:s\"));\n                            }\n                            $timecheck2 = round(abs($to_time - $from_time) / 60, 0);\n                            if (strtotime($newarrive) != '' && ($timecheck2 >= 1)) {\n                                echo text($timecheck2 . ' ' . ($timecheck2 >= 2 ? xl('minutes') : xl('minute')));\n                            }\n                            // end total time in practice\n                            echo text($appointment['pc_time']); ?>\n                        </td>\n                        <td class=\"detail text-center\">\n                            <?php\n                            if (strtotime($newend) != '') {\n                                echo text(oeFormatTime(substr($newend, 11))) ;\n                            }\n                            ?>\n                        </td>\n                        <?php\n                        if ($GLOBALS['ptkr_show_staff'] == '1') {\n                            ?>\n                                <td class=\"detail text-center\" name=\"kiosk_hide\">\n                                    <?php echo text($appointment['user']) ?>\n                                </td>\n                            <?php\n                        }\n                        if ($GLOBALS['drug_screen']) {\n                            if (strtotime($newarrive) != '') { ?>\n                                <td class=\"detail text-center\" name=\"kiosk_hide\">\n                                    <?php\n                                    if ($appointment['random_drug_test'] == '1') {\n                                        echo xlt('Yes');\n                                    } else {\n                                        echo xlt('No');\n                                    } ?>\n                                </td>\n                                <?php\n                            } else { ?>\n                                <td class=\"detail text-center\" name=\"kiosk_hide\"></td>\n                            <?php }\n                            if (strtotime($newarrive) != '' && $appointment['random_drug_test'] == '1') { ?>\n                                <td class=\"detail text-center\" name=\"kiosk_hide\">\n                                    <?php\n                                    if (strtotime($newend) != '') {\n                                        // the following block allows the check box for drug screens to be disabled once the status is check out ?>\n                                        <input type='checkbox' disabled='disable' class=\"drug_screen_completed\" id=\"<?php echo attr($appointment['pt_tracker_id']) ?>\" <?php echo ($appointment['drug_screen_completed'] == \"1\") ? \"checked\" : \"\"; ?> />\n                                        <?php\n                                    } else {\n                                        ?>\n                                        <input type='checkbox' class=\"drug_screen_completed\" id='<?php echo attr($appointment['pt_tracker_id']) ?>' name=\"drug_screen_completed\" <?php echo ($appointment['drug_screen_completed'] == \"1\") ? \"checked\" : \"\"; ?> />\n                                        <?php\n                                    } ?>\n                                </td>\n                                <?php\n                            } else { ?>\n                                <td class=\"detail text-center\" name=\"kiosk_hide\"></td>\n                            <?php }\n                        }\n                        ?>\n                        </tr>\n                        <?php\n                    } //end foreach\n                    ?>\n                    </tbody>\n                </table>\n                </div>\n\n    <?php\n}\nif (!$_REQUEST['flb_table']) { ?>\n                </div>\n            </div>\n        </div>\n    </div><?php //end container ?>\n    <!-- form used to open a new top level window when a patient row is clicked -->\n    <form name='fnew' method='post' target='_blank' action='../main/main_screen.php?auth=login&site=<?php echo attr_url($_SESSION['site_id']); ?>'>\n        <input type=\"hidden\" name=\"csrf_token_form\" value=\"<?php echo attr(CsrfUtils::collectCsrfToken()); ?>\" />\n        <input type='hidden' name='patientID' value='0' />\n        <input type='hidden' name='encounterID' value='0' />\n    </form>\n\n    <?php echo myLocalJS(); ?>\n</body>\n</html>\n    <?php\n} //end of second !$_REQUEST['flb_table']\n\n\nexit;\n\nfunction myLocalJS()\n{\n    ?>\n    <script>\n        var auto_refresh = null;\n        //this can be refined to redact HIPAA material using @media print options.\n        window.parent.$(\"[name='flb']\").attr('allowFullscreen', 'true');\n        $(\"[name='kiosk_hide']\").show();\n        $(\"[name='kiosk_show']\").hide();\n\n        function print_FLB() {\n            window.print();\n        }\n\n        function toggleSelectors() {\n            top.restoreSession();\n            if ($(\"#flb_selectors\").css('display') === 'none') {\n                $.post(\"<?php echo $GLOBALS['webroot'] . \"/interface/patient_tracker/patient_tracker.php\"; ?>\", {\n                    setting_selectors: 'block',\n                    csrf_token_form: <?php echo js_escape(CsrfUtils::collectCsrfToken()); ?>\n                }).done(\n                    function (data) {\n                        $(\"#flb_selectors\").slideToggle();\n                        if($(\"#flb_caret\").hasClass('text-danger')) {\n                          $(\"#flb_caret\").removeClass('text-danger');\n                        }\n                        $(\"#flb_caret\").addClass('text-body');\n                });\n            } else {\n                $.post(\"<?php echo $GLOBALS['webroot'] . \"/interface/patient_tracker/patient_tracker.php\"; ?>\", {\n                    setting_selectors: 'none',\n                    csrf_token_form: <?php echo js_escape(CsrfUtils::collectCsrfToken()); ?>\n                }).done(\n                    function (data) {\n                        $(\"#flb_selectors\").slideToggle();\n                        if($(\"#flb_caret\").hasClass('text-body')) {\n                          $(\"#flb_caret\").removeClass('text-body');\n                        }\n                        $(\"#flb_caret\").addClass('text-danger');\n                });\n            }\n            $(\"#print_caret\").toggleClass('fa-caret-up').toggleClass('fa-caret-down');\n        }\n\n        /**\n         * This function refreshes the whole flb_table according to our to/from dates.\n         */\n        function refreshMe(fromTimer) {\n\n            if (typeof fromTimer === 'undefined' || !fromTimer) {\n                //Show loader in the first loading or manual loading not by timer\n                $(\"#flb_table\").html('');\n                $('#loader').show();\n                skip_timeout_reset = 0;\n            } else {\n                skip_timeout_reset = 1;\n            }\n\n            var startRequestTime = Date.now();\n            top.restoreSession();\n            var posting = $.post('../patient_tracker/patient_tracker.php', {\n                flb_table: '1',\n                form_from_date: $(\"#form_from_date\").val(),\n                form_to_date: $(\"#form_to_date\").val(),\n                form_facility: $(\"#form_facility\").val(),\n                form_provider: $(\"#form_provider\").val(),\n                form_apptstatus: $(\"#form_apptstatus\").val(),\n                form_patient_name: $(\"#form_patient_name\").val(),\n                form_patient_id: $(\"#form_patient_id\").val(),\n                form_apptcat: $(\"#form_apptcat\").val(),\n                kiosk: $(\"#kiosk\").val(),\n                skip_timeout_reset: skip_timeout_reset,\n                csrf_token_form: <?php echo js_escape(CsrfUtils::collectCsrfToken()); ?>\n            }).done(\n                function (data) {\n                    //minimum 400 ms of loader (In the first loading or manual loading not by timer)\n                    if((typeof fromTimer === 'undefined' || !fromTimer) && Date.now() - startRequestTime < 400 ){\n                        setTimeout(drawTable, 500, data);\n                    } else {\n                        drawTable(data)\n                    }\n                });\n        }\n\n        function drawTable(data) {\n\n            $('#loader').hide();\n            $(\"#flb_table\").html(data);\n            if ($(\"#kiosk\").val() === '') {\n            $(\"[name='kiosk_hide']\").show();\n            $(\"[name='kiosk_show']\").hide();\n            } else {\n            $(\"[name='kiosk_hide']\").hide();\n            $(\"[name='kiosk_show']\").show();\n            }\n\n            refineMe();\n\n            initTableButtons();\n\n        }\n\n        function refreshme() {\n            // Just need this to support refreshme call from the popup used for recurrent appt\n            refreshMe();\n        }\n\n        /**\n         * This function hides all then shows only the flb_table rows that match our selection, client side.\n         * It is called on initial load, on refresh and 'onchange/onkeyup' of a flow board parameter.\n         */\n        function refineMe() {\n            var apptcatV = $(\"#form_apptcat\").val();\n            var apptstatV = $(\"#form_apptstatus\").val();\n            var facV = $(\"#form_facility\").val();\n            var provV = $(\"#form_provider\").val();\n            var pidV = String($(\"#form_patient_id\").val());\n            var pidRE = new RegExp(pidV, 'g');\n            var pnameV = $(\"#form_patient_name\").val();\n            var pnameRE = new RegExp(pnameV, 'ig');\n\n            //and hide what we don't want to show\n            $('#flb_table tbody tr').hide().filter(function () {\n                var d = $(this).data();\n                meets_cat = (apptcatV === '') || (apptcatV == d.apptcat);\n                meets_stat = (apptstatV === '') || (apptstatV == d.apptstatus);\n                meets_fac = (facV === '') || (facV == d.facility);\n                meets_prov = (provV === '') || (provV == d.provider);\n                meets_pid = (pidV === '');\n                if ((pidV > '') && pidRE.test(d.pid)) {\n                    meets_pid = true;\n                }\n                meets_pname = (pnameV === '');\n                if ((pnameV > '') && pnameRE.test(d.pname)) {\n                    meets_pname = true;\n                }\n                return meets_pname && meets_pid && meets_cat && meets_stat && meets_fac && meets_prov;\n            }).show();\n        }\n\n        // popup for patient tracker status\n        function bpopup(tkid) {\n            top.restoreSession();\n            dlgopen('../patient_tracker/patient_tracker_status.php?tracker_id=' + encodeURIComponent(tkid) + '&csrf_token_form=' + <?php echo js_url(CsrfUtils::collectCsrfToken()); ?>, '_blank', 500, 250);\n            return false;\n        }\n\n        // popup for calendar add edit\n        function calendarpopup(eid, date_squash) {\n            top.restoreSession();\n            dlgopen('../main/calendar/add_edit_event.php?eid=' + encodeURIComponent(eid) + '&date=' + encodeURIComponent(date_squash), '_blank', 775, 500);\n            return false;\n        }\n\n        // used to display the patient demographic and encounter screens\n        function topatient(newpid, enc) {\n            if ($('#setting_new_window').val() === 'checked') {\n                openNewTopWindow(newpid, enc);\n            }\n            else {\n                top.restoreSession();\n                if (enc > 0) {\n                    top.RTop.location = \"<?php echo $GLOBALS['webroot']; ?>/interface/patient_file/summary/demographics.php?set_pid=\" + encodeURIComponent(newpid) + \"&set_encounterid=\" + encodeURIComponent(enc);\n                }\n                else {\n                    top.RTop.location = \"<?php echo $GLOBALS['webroot']; ?>/interface/patient_file/summary/demographics.php?set_pid=\" + encodeURIComponent(newpid);\n                }\n            }\n        }\n\n        function doCALLback(eventdate, eid, pccattype) {\n            $(\"#progCALLback_\" + eid).parent().removeClass('js-blink-infinite').css('animation-name', 'none');\n            $(\"#progCALLback_\" + eid).removeClass(\"hidden\");\n            clearInterval(auto_refresh);\n        }\n\n        // opens the demographic and encounter screens in a new window\n        function openNewTopWindow(newpid, newencounterid) {\n            document.fnew.patientID.value = newpid;\n            document.fnew.encounterID.value = newencounterid;\n            top.restoreSession();\n            document.fnew.submit();\n        }\n\n        //opens the two-way SMS phone app\n        /**\n         * @return {boolean}\n         */\n        function SMS_bot(pid) {\n            top.restoreSession();\n            var from = <?php echo js_escape($from_date); ?>;\n            var to = <?php echo js_escape($to_date); ?>;\n            var oefrom = <?php echo js_escape(oeFormatShortDate($from_date)); ?>;\n            var oeto = <?php echo js_escape(oeFormatShortDate($to_date)); ?>;\n            window.open('../main/messages/messages.php?nomenu=1&go=SMS_bot&pid=' + encodeURIComponent(pid) + '&to=' + encodeURIComponent(to) + '&from=' + encodeURIComponent(from) + '&oeto=' + encodeURIComponent(oeto) + '&oefrom=' + encodeURIComponent(oefrom), 'SMS_bot', 'width=370,height=600,resizable=0');\n            return false;\n        }\n\n        function kiosk_FLB() {\n            $(\"#kiosk\").val('1');\n            $(\"[name='kiosk_hide']\").hide();\n            $(\"[name='kiosk_show']\").show();\n\n            var i = document.getElementById(\"flb_table\");\n            // go full-screen\n            if (i.requestFullscreen) {\n                i.requestFullscreen();\n            } else if (i.webkitRequestFullscreen) {\n                i.webkitRequestFullscreen();\n            } else if (i.mozRequestFullScreen) {\n                i.mozRequestFullScreen();\n            } else if (i.msRequestFullscreen) {\n                i.msRequestFullscreen();\n            }\n            // refreshMe();\n        }\n\n        function KioskUp() {\n            var kv = $(\"#kiosk\").val();\n            if (kv == '0') {\n                $(\"#kiosk\").val('1');\n                $(\"[name='kiosk_hide']\").show();\n                $(\"[name='kiosk_show']\").hide();\n            } else {\n                $(\"#kiosk\").val('0');\n                $(\"[name='kiosk_hide']\").hide();\n                $(\"[name='kiosk_show']\").show();\n            }\n        }\n\n        $(function () {\n            refreshMe();\n            $(\"#kiosk\").val('');\n            $(\"[name='kiosk_hide']\").show();\n            $(\"[name='kiosk_show']\").hide();\n\n            onresize = function () {\n                var state = 1 >= outerHeight - innerHeight ? \"fullscreen\" : \"windowed\";\n                if (window.state === state) return;\n                window.state = state;\n                var event = document.createEvent(\"Event\");\n                event.initEvent(state, true, true);\n                window.dispatchEvent(event);\n            };\n\n            [\"fullscreenchange\", \"webkitfullscreenchange\", \"mozfullscreenchange\", \"msfullscreenchange\"].forEach(\n                eventType => document.addEventListener(eventType, KioskUp, false)\n            );\n\n            <?php if ($GLOBALS['pat_trkr_timer'] != '0') { ?>\n                var reftime = <?php echo js_escape($GLOBALS['pat_trkr_timer']); ?>;\n                var parsetime = reftime.split(\":\");\n                parsetime = (parsetime[0] * 60) + (parsetime[1] * 1) * 1000;\n                if (auto_refresh) clearInteral(auto_refresh);\n                auto_refresh = setInterval(function () {\n                    refreshMe(true) // this will run after every parsetime seconds\n                }, parsetime);\n            <?php } ?>\n\n            $('.js-blink-infinite').each(function () {\n                // set up blinking text\n                var elem = $(this);\n                setInterval(function () {\n                    if (elem.css('visibility') === 'hidden') {\n                        elem.css('visibility', 'visible');\n                    } else {\n                        elem.css('visibility', 'hidden');\n                    }\n                }, 500);\n            });\n            // toggle of the check box status for drug screen completed and ajax call to update the database\n            $('body').on('click', '.drug_screen_completed', function () {\n                top.restoreSession();\n                if (this.checked) {\n                    testcomplete_toggle = \"true\";\n                } else {\n                    testcomplete_toggle = \"false\";\n                }\n                $.post(\"../../library/ajax/drug_screen_completed.php\", {\n                    trackerid: this.id,\n                    testcomplete: testcomplete_toggle,\n                    csrf_token_form: <?php echo js_escape(CsrfUtils::collectCsrfToken()); ?>\n                });\n            });\n\n            // mdsupport - Immediately post changes to setting_new_window\n            $('body').on('click', '#setting_new_window', function () {\n                $('#setting_new_window').val(this.checked ? 'checked' : ' ');\n                top.restoreSession();\n                $.post(\"<?php echo $GLOBALS['webroot'] . \"/interface/patient_tracker/patient_tracker.php\"; ?>\", {\n                    setting_new_window: $('#setting_new_window').val(),\n                    csrf_token_form: <?php echo js_escape(CsrfUtils::collectCsrfToken()); ?>\n                }).done(\n                    function (data) {\n                });\n            });\n\n            $('#filter_submit').click(function (e) {\n                e.preventDefault;\n                refreshMe();\n            });\n\n            $('[data-toggle=\"tooltip\"]').tooltip();\n\n            $('.datepicker').datetimepicker({\n                <?php $datetimepicker_timepicker = false; ?>\n                <?php $datetimepicker_showseconds = false; ?>\n                <?php $datetimepicker_formatInput = true; ?>\n                <?php require($GLOBALS['srcdir'] . '/js/xl/jquery-datetimepicker-2-5-4.js.php'); ?>\n                <?php // can add any additional javascript settings to datetimepicker here; need to prepend first setting with a comma ?>\n            });\n\n        });\n\n        function initTableButtons() {\n            $('#refreshme').click(function () {\n                refreshMe();\n                refineMe();\n            });\n        }\n\n        initTableButtons();\n\n    </script>\n<?php }\n?>\n", "<?php\n\n/**\n *\n * @package OpenEMR\n * @author Eldho Chacko <eldho@zhservices.com>\n * @author Paul Simon K <paul@zhservices.com>\n * @author Stephen Waite <stephen.waite@cmsvt.com>\n * @author Rod Roark <rod@sunsetsystems.com>\n * @copyright Copyright (c) 2010 Z&H Consultancy Services Private Limited <sam@zhservices.com>\n * @copyright Copyright (c) 2018 Stephen Waite <stephen.waite@cmsvt.com>\n * @copyright Copyright (c) 2020 Rod Roark <rod@sunsetsystems.com>\n * @link https://www.open-emr.org\n * @license https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\nuse OpenEMR\\Billing\\SLEOB;\nuse OpenEMR\\Common\\Logging\\EventAuditLogger;\n\n// Post a payment to the payments table.\n//\nfunction frontPayment($patient_id, $encounter, $method, $source, $amount1, $amount2, $timestamp, $auth = \"\")\n{\n\n    if (empty($auth)) {\n        $auth = $_SESSION['authUser'];\n    }\n\n    $tmprow = sqlQuery(\n        \"SELECT date FROM form_encounter WHERE \" .\n        \"encounter=? and pid=?\",\n        array($encounter,$patient_id)\n    );\n        //the manipulation is done to insert the amount paid into payments table in correct order to show in front receipts report,\n        //if the payment is for today's encounter it will be shown in the report under today field and otherwise shown as previous\n    $tmprowArray = explode(' ', $tmprow['date']);\n    if (date('Y-m-d') == $tmprowArray[0]) {\n        if ($amount1 == 0) {\n              $amount1 = $amount2;\n              $amount2 = 0;\n        }\n    } else {\n        if ($amount2 == 0) {\n              $amount2 = $amount1;\n              $amount1 = 0;\n        }\n    }\n\n    $payid = sqlInsert(\"INSERT INTO payments ( \" .\n    \"pid, encounter, dtime, user, method, source, amount1, amount2 \" .\n    \") VALUES ( ?, ?, ?, ?, ?, ?, ?, ?)\", array($patient_id,$encounter,$timestamp,$auth,$method,$source,$amount1,$amount2));\n    return $payid;\n}\n\n//===============================================================================\n//This section handles the common functins of payment screens.\n//===============================================================================\nfunction DistributionInsert($CountRow, $created_time, $user_id)\n{\n//Function inserts the distribution.Payment,Adjustment,Deductible,Takeback & Follow up reasons are inserted as seperate rows.\n //It automatically pushes to next insurance for billing.\n //In the screen a drop down of Ins1,Ins2,Ins3,Pat are given.The posting can be done for any level.\n    $Affected = 'no';\n    if (isset($_POST[\"Payment$CountRow\"]) && (int)$_POST[\"Payment$CountRow\"] > 0) {\n        if (trim(formData('type_name')) == 'insurance') {\n            if (trim(formData(\"HiddenIns$CountRow\")) == 1) {\n                $AccountCode = \"IPP\";\n            }\n\n            if (trim(formData(\"HiddenIns$CountRow\")) == 2) {\n                $AccountCode = \"ISP\";\n            }\n\n            if (trim(formData(\"HiddenIns$CountRow\")) == 3) {\n                $AccountCode = \"ITP\";\n            }\n        } elseif (trim(formData('type_name')) == 'patient') {\n            $AccountCode = \"PP\";\n        }\n\n        sqlBeginTrans();\n        $sequence_no = sqlQuery(\"SELECT IFNULL(MAX(sequence_no),0) + 1 AS increment FROM ar_activity WHERE pid = ? AND encounter = ?\", array(trim(formData('hidden_patient_code')), trim(formData(\"HiddenEncounter$CountRow\"))));\n        sqlStatement(\"insert into ar_activity set \"    .\n        \"pid = '\"       . trim(formData('hidden_patient_code')) .\n        \"', encounter = '\"     . trim(formData(\"HiddenEncounter$CountRow\"))  .\n        \"', sequence_no = '\" . $sequence_no['increment'] .\n                \"', code_type = '\"      . trim(formData(\"HiddenCodetype$CountRow\"))  .\n        \"', code = '\"      . trim(formData(\"HiddenCode$CountRow\"))  .\n        \"', modifier = '\"      . trim(formData(\"HiddenModifier$CountRow\"))  .\n        \"', payer_type = '\"   . trim(formData(\"HiddenIns$CountRow\")) .\n        \"', post_time = '\"  . trim($created_time) .\n        \"', post_user = '\" . trim($user_id)  .\n        \"', session_id = '\"    . trim(formData('payment_id')) .\n        \"', modified_time = '\"  . trim($created_time) .\n        \"', pay_amount = '\" . trim(formData(\"Payment$CountRow\"))  .\n        \"', adj_amount = '\"    . 0 .\n        \"', account_code = '\" . \"$AccountCode\"  .\n        \"'\");\n          sqlCommitTrans();\n          $Affected = 'yes';\n    }\n\n    if (!empty($_POST[\"AdjAmount$CountRow\"]) && (($_POST[\"AdjAmount$CountRow\"] ?? null) * 1 != 0)) {\n        if (trim(formData('type_name')) == 'insurance') {\n            $AdjustString = \"Ins adjust Ins\" . trim(formData(\"HiddenIns$CountRow\"));\n            $AccountCode = \"IA\";\n        } elseif (trim(formData('type_name')) == 'patient') {\n            $AdjustString = \"Pt adjust\";\n            $AccountCode = \"PA\";\n        }\n\n        sqlBeginTrans();\n        $sequence_no = sqlQuery(\"SELECT IFNULL(MAX(sequence_no),0) + 1 AS increment FROM ar_activity WHERE pid = ? AND encounter = ?\", array(trim(formData('hidden_patient_code')), trim(formData(\"HiddenEncounter$CountRow\"))));\n        sqlStatement(\"insert into ar_activity set \"    .\n        \"pid = '\"       . trim(formData('hidden_patient_code')) .\n        \"', encounter = '\"     . trim(formData(\"HiddenEncounter$CountRow\"))  .\n        \"', sequence_no = '\"     . $sequence_no['increment']  .\n                \"', code_type = '\"      . trim(formData(\"HiddenCodetype$CountRow\"))  .\n        \"', code = '\"      . trim(formData(\"HiddenCode$CountRow\"))  .\n        \"', modifier = '\"      . trim(formData(\"HiddenModifier$CountRow\"))  .\n        \"', payer_type = '\"   . trim(formData(\"HiddenIns$CountRow\")) .\n        \"', post_time = '\"  . trim($created_time) .\n        \"', post_user = '\" . trim($user_id)  .\n        \"', session_id = '\"    . trim(formData('payment_id')) .\n        \"', modified_time = '\"  . trim($created_time) .\n        \"', pay_amount = '\" . 0  .\n        \"', adj_amount = '\"    . trim(formData(\"AdjAmount$CountRow\")) .\n        \"', memo = '\" . \"$AdjustString\"  .\n        \"', account_code = '\" . \"$AccountCode\"  .\n        \"'\");\n           sqlCommitTrans();\n          $Affected = 'yes';\n    }\n\n    if (!empty($_POST[\"Deductible$CountRow\"]) && (($_POST[\"Deductible$CountRow\"] ?? null) * 1 > 0)) {\n         sqlBeginTrans();\n         $sequence_no = sqlQuery(\"SELECT IFNULL(MAX(sequence_no),0) + 1 AS increment FROM ar_activity WHERE pid = ? AND encounter = ?\", array(trim(formData('hidden_patient_code')), trim(formData(\"HiddenEncounter$CountRow\"))));\n        sqlStatement(\"insert into ar_activity set \"    .\n        \"pid = '\"       . trim(formData('hidden_patient_code')) .\n        \"', encounter = '\"     . trim(formData(\"HiddenEncounter$CountRow\"))  .\n        \"', sequence_no = '\"     . $sequence_no['increment']  .\n                \"', code_type = '\"      . trim(formData(\"HiddenCodetype$CountRow\"))  .\n        \"', code = '\"      . trim(formData(\"HiddenCode$CountRow\"))  .\n        \"', modifier = '\"      . trim(formData(\"HiddenModifier$CountRow\"))  .\n        \"', payer_type = '\"   . trim(formData(\"HiddenIns$CountRow\")) .\n        \"', post_time = '\"  . trim($created_time) .\n        \"', post_user = '\" . trim($user_id)  .\n        \"', session_id = '\"    . trim(formData('payment_id')) .\n        \"', modified_time = '\"  . trim($created_time) .\n        \"', pay_amount = '\" . 0  .\n        \"', adj_amount = '\"    . 0 .\n        \"', memo = '\"    . \"Deductible $\" . trim(formData(\"Deductible$CountRow\")) .\n        \"', account_code = '\" . \"Deduct\"  .\n        \"'\");\n           sqlCommitTrans();\n          $Affected = 'yes';\n    }\n\n    if (!empty($_POST[\"Takeback$CountRow\"]) && (($_POST[\"Takeback$CountRow\"] ?? null) * 1 > 0)) {\n         sqlBeginTrans();\n         $sequence_no = sqlQuery(\"SELECT IFNULL(MAX(sequence_no),0) + 1 AS increment FROM ar_activity WHERE pid = ? AND encounter = ?\", array(trim(formData('hidden_patient_code')), trim(formData(\"HiddenEncounter$CountRow\"))));\n        sqlStatement(\"insert into ar_activity set \"    .\n        \"pid = '\"       . trim(formData('hidden_patient_code')) .\n        \"', encounter = '\"     . trim(formData(\"HiddenEncounter$CountRow\"))  .\n        \"', sequence_no = '\"     . $sequence_no['increment']  .\n                \"', code_type = '\"      . trim(formData(\"HiddenCodetype$CountRow\"))  .\n        \"', code = '\"      . trim(formData(\"HiddenCode$CountRow\"))  .\n        \"', modifier = '\"      . trim(formData(\"HiddenModifier$CountRow\"))  .\n        \"', payer_type = '\"   . trim(formData(\"HiddenIns$CountRow\")) .\n        \"', post_time = '\"  . trim($created_time) .\n        \"', post_user = '\" . trim($user_id)  .\n        \"', session_id = '\"    . trim(formData('payment_id')) .\n        \"', modified_time = '\"  . trim($created_time) .\n        \"', pay_amount = '\" . trim(formData(\"Takeback$CountRow\")) * -1  .\n        \"', adj_amount = '\"    . 0 .\n        \"', account_code = '\" . \"Takeback\"  .\n        \"'\");\n           sqlCommitTrans();\n          $Affected = 'yes';\n    }\n\n    if (isset($_POST[\"FollowUp$CountRow\"]) && $_POST[\"FollowUp$CountRow\"] == 'y') {\n         sqlBeginTrans();\n         $sequence_no = sqlQuery(\"SELECT IFNULL(MAX(sequence_no),0) + 1 AS increment FROM ar_activity WHERE pid = ? AND encounter = ?\", array(trim(formData('hidden_patient_code')), trim(formData(\"HiddenEncounter$CountRow\"))));\n         sqlStatement(\"insert into ar_activity set \"    .\n        \"pid = '\"       . trim(formData('hidden_patient_code')) .\n        \"', encounter = '\"     . trim(formData(\"HiddenEncounter$CountRow\"))  .\n        \"', sequence_no = '\"     . $sequence_no['increment']  .\n                \"', code_type = '\"      . trim(formData(\"HiddenCodetype$CountRow\"))  .\n        \"', code = '\"      . trim(formData(\"HiddenCode$CountRow\"))  .\n        \"', modifier = '\"      . trim(formData(\"HiddenModifier$CountRow\"))  .\n        \"', payer_type = '\"   . trim(formData(\"HiddenIns$CountRow\")) .\n        \"', post_time = '\"  . trim($created_time) .\n        \"', post_user = '\" . trim($user_id)  .\n        \"', session_id = '\"    . trim(formData('payment_id')) .\n        \"', modified_time = '\"  . trim($created_time) .\n        \"', pay_amount = '\" . 0  .\n        \"', adj_amount = '\"    . 0 .\n        \"', follow_up = '\"    . \"y\" .\n        \"', follow_up_note = '\"    . trim(formData(\"FollowUpReason$CountRow\")) .\n        \"'\");\n           sqlCommitTrans();\n          $Affected = 'yes';\n    }\n\n    if ($Affected == 'yes') {\n        if (trim(formData('type_name')) != 'patient') {\n            $ferow = sqlQuery(\"select last_level_closed from form_encounter  where\n\t\tpid ='\" . trim(formData('hidden_patient_code')) . \"' and encounter='\" . trim(formData(\"HiddenEncounter$CountRow\")) . \"'\");\n              //multiple charges can come.\n            if ($ferow['last_level_closed'] < trim(formData(\"HiddenIns$CountRow\"))) {\n                //last_level_closed gets increased. unless a follow up is required.\n                // in which case we'll allow secondary to be re setup to current setup.\n                // just not advancing last closed.\n                $tmp = (((!empty($_POST[\"Payment$CountRow\"]) ? $_POST[\"Payment$CountRow\"] : null) * 1) + ((!empty($_POST[\"AdjAmount$CountRow\"]) ? $_POST[\"AdjAmount$CountRow\"] : null) * 1));\n                if ((empty($_POST[\"FollowUp$CountRow\"]) || ($_POST[\"FollowUp$CountRow\"] != 'y')) && $tmp !== 0) {\n                    sqlStatement(\"update form_encounter set last_level_closed='\" .\n                        trim(formData(\"HiddenIns$CountRow\")) .\n                        \"' where pid ='\" . trim(formData('hidden_patient_code')) .\n                        \"' and encounter='\" . trim(formData(\"HiddenEncounter$CountRow\")) . \"'\");\n                }\n                  //-----------------------------------\n                  // Determine the next insurance level to be billed.\n                  $ferow = sqlQuery(\"SELECT date, last_level_closed \" .\n                    \"FROM form_encounter WHERE \" .\n                    \"pid = '\" . trim(formData('hidden_patient_code')) . \"' AND encounter = '\" . trim(formData(\"HiddenEncounter$CountRow\")) . \"'\");\n                  $date_of_service = substr($ferow['date'], 0, 10);\n                  $new_payer_type = 0 + $ferow['last_level_closed'];\n                if ($new_payer_type <= 3 && !empty($ferow['last_level_closed']) || $new_payer_type == 0) {\n                    ++$new_payer_type;\n                }\n\n                  $new_payer_id = SLEOB::arGetPayerID(trim(formData('hidden_patient_code')), $date_of_service, $new_payer_type);\n                if ($new_payer_id > 0) {\n                        SLEOB::arSetupSecondary(trim(formData('hidden_patient_code')), trim(formData(\"HiddenEncounter$CountRow\")), 0);\n                }\n\n                    //-----------------------------------\n            }\n        }\n    }\n}\n//===============================================================================\n  // Delete rows, with logging, for the specified table using the\n  // specified WHERE clause.  Borrowed from deleter.php.\n  //\nfunction row_delete($table, $where)\n{\n    $tres = sqlStatement(\"SELECT * FROM \" . escape_table_name($table) . \" WHERE $where\");\n    $count = 0;\n    while ($trow = sqlFetchArray($tres)) {\n        $logstring = \"\";\n        foreach ($trow as $key => $value) {\n            if (! $value || $value == '0000-00-00 00:00:00') {\n                continue;\n            }\n\n            if ($logstring) {\n                $logstring .= \" \";\n            }\n\n            $logstring .= $key . \"='\" . addslashes($value) . \"'\";\n        }\n\n        EventAuditLogger::instance()->newEvent(\"delete\", $_SESSION['authUser'], $_SESSION['authProvider'], 1, \"$table: $logstring\");\n        ++$count;\n    }\n\n    if ($count) {\n        $query = \"DELETE FROM \" . escape_table_name($table) . \" WHERE $where\";\n        sqlStatement($query);\n    }\n}\n\n// Deactivate rows, with logging, for the specified table using the\n// specified SET and WHERE clauses.  Borrowed from deleter.php.\n//\nfunction row_modify($table, $set, $where)\n{\n    if (sqlQuery(\"SELECT * FROM \" . escape_table_name($table) . \" WHERE $where\")) {\n        EventAuditLogger::instance()->newEvent(\n            \"deactivate\",\n            $_SESSION['authUser'],\n            $_SESSION['authProvider'],\n            1,\n            \"$table: $where\"\n        );\n        $query = \"UPDATE $table SET $set WHERE $where\";\n        sqlStatement($query);\n    }\n}\n\n//===============================================================================\n", "<?php\n\n/**\n *\n * Modified from interface/main/calendar/add_edit_event.php for\n * the patient portal.\n *\n * @package   OpenEMR\n * @link      http://www.open-emr.org\n * @author    Rod Roark <rod@sunsetsystems.com>\n * @author    Jerry Padgett <sjpadgett@gmail.com>\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (C) 2005-2006 Rod Roark <rod@sunsetsystems.com>\n * @copyright Copyright (C) 2016-2021 Jerry Padgett <sjpadgett@gmail.com>\n * @copyright Copyright (c) 2019 Brady Miller <brady.g.miller@gmail.com>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\n// Will start the (patient) portal OpenEMR session/cookie.\nrequire_once(__DIR__ . \"/../src/Common/Session/SessionUtil.php\");\nOpenEMR\\Common\\Session\\SessionUtil::portalSessionStart();\n\nrequire_once(\"./../library/pnotes.inc\");\n\n//landing page definition -- where to go if something goes wrong\n$landingpage = \"index.php?site=\" . urlencode($_SESSION['site_id']);\n//\n\n// kick out if patient not authenticated\nif (isset($_SESSION['pid']) && isset($_SESSION['patient_portal_onsite_two'])) {\n    $pid = $_SESSION['pid'];\n} else {\n    OpenEMR\\Common\\Session\\SessionUtil::portalSessionCookieDestroy();\n    header('Location: ' . $landingpage . '&w');\n    exit;\n}\n\n$ignoreAuth_onsite_portal = true;\nglobal $ignoreAuth_onsite_portal;\n\nrequire_once(\"../interface/globals.php\");\nrequire_once(\"$srcdir/patient.inc\");\nrequire_once(\"$srcdir/forms.inc\");\n\nuse OpenEMR\\Core\\Header;\n\n// Things that might be passed by our opener.\n//\n$eid = $_GET['eid'];         // only for existing events\n$date = $_GET['date'];        // this and below only for new events\n$userid = $_GET['userid'];\n$default_catid = $_GET['catid'] ? $_GET['catid'] : '5';\n$patientid = $_GET['patid'];\n//\n\nif ($date) {\n    $date = substr($date, 0, 4) . '-' . substr($date, 4, 2) . '-' . substr($date, 6);\n} else {\n    $date = date(\"Y-m-d\");\n}\n\n//\n$starttimem = '00';\nif (isset($_GET['starttimem'])) {\n    $starttimem = substr('00' . $_GET['starttimem'], -2);\n}\n\n//\nif (isset($_GET['starttimeh'])) {\n    $starttimeh = $_GET['starttimeh'];\n    if (isset($_GET['startampm'])) {\n        if ($_GET['startampm'] == '2' && $starttimeh < 12) {\n            $starttimeh += 12;\n        }\n    }\n} else {\n    $starttimeh = date(\"G\");\n}\n\n$startampm = '';\n\n$info_msg = \"\";\n\n// EVENTS TO FACILITIES (lemonsoftware)\n//(CHEMED) get facility name\n// edit event case - if there is no association made, then insert one with the first facility\nif ($eid) {\n    $selfacil = '';\n    $facility = sqlQuery(\"SELECT pc_facility, pc_multiple, pc_aid, facility.name\n                        FROM openemr_postcalendar_events\n                          LEFT JOIN facility ON (openemr_postcalendar_events.pc_facility = facility.id)\n                          WHERE pc_eid = ?\", array($eid));\n    if (!$facility['pc_facility']) {\n        $qmin = sqlQuery(\"SELECT facility_id as minId, facility FROM users WHERE id = ?\", array($facility['pc_aid']));\n        $min = $qmin['minId'];\n        $min_name = $qmin['facility'];\n\n        // multiple providers case\n        if ($GLOBALS['select_multi_providers']) {\n            $mul = $facility['pc_multiple'];\n            sqlStatement(\"UPDATE openemr_postcalendar_events SET pc_facility = ? WHERE pc_multiple = ?\", array($min, $mul));\n        }\n\n        // EOS multiple\n\n        sqlStatement(\"UPDATE openemr_postcalendar_events SET pc_facility = ? WHERE pc_eid = ?\", array($min, $eid));\n        $e2f = $min;\n        $e2f_name = $min_name;\n    } else {\n        $e2f = $facility['pc_facility'];\n        $e2f_name = $facility['name'];\n    }\n}\n\n// EOS E2F\n// ===========================\n\n\n// If we are saving, then save and close the window.\n//\nif ($_POST['form_action'] == \"save\") {\n//print_r($_POST);\n//exit();\n    $event_date = fixDate($_POST['form_date']);\n\n// Compute start and end time strings to be saved.\n    if ($_POST['form_allday']) {\n        $tmph = 0;\n        $tmpm = 0;\n        $duration = 24 * 60;\n    } else {\n        $tmph = $_POST['form_hour'] + 0;\n        $tmpm = $_POST['form_minute'] + 0;\n        if ($_POST['form_ampm'] == '2' && $tmph < 12) {\n            $tmph += 12;\n        }\n\n        $duration = $_POST['form_duration'];\n    }\n\n    $starttime = \"$tmph:$tmpm:00\";\n//\n    $tmpm += $duration;\n    while ($tmpm >= 60) {\n        $tmpm -= 60;\n        ++$tmph;\n    }\n\n    $endtime = \"$tmph:$tmpm:00\";\n\n// Useless garbage that we must save.\n    $locationspec = 'a:6:{s:14:\"event_location\";N;s:13:\"event_street1\";N;' .\n        's:13:\"event_street2\";N;s:10:\"event_city\";N;s:11:\"event_state\";N;s:12:\"event_postal\";N;}';\n\n// More garbage, but this time 1 character of it is used to save the\n// repeat type.\n    if ($_POST['form_repeat']) {\n        $recurrspec = 'a:5:{' .\n            's:17:\"event_repeat_freq\";s:1:\"' . $_POST['form_repeat_freq'] . '\";' .\n            's:22:\"event_repeat_freq_type\";s:1:\"' . $_POST['form_repeat_type'] . '\";' .\n            's:19:\"event_repeat_on_num\";s:1:\"1\";' .\n            's:19:\"event_repeat_on_day\";s:1:\"0\";' .\n            's:20:\"event_repeat_on_freq\";s:1:\"0\";}';\n    } else {\n        $recurrspec = 'a:5:{' .\n            's:17:\"event_repeat_freq\";N;' .\n            's:22:\"event_repeat_freq_type\";s:1:\"0\";' .\n            's:19:\"event_repeat_on_num\";s:1:\"1\";' .\n            's:19:\"event_repeat_on_day\";s:1:\"0\";' .\n            's:20:\"event_repeat_on_freq\";s:1:\"1\";}';\n    }\n\n//The modification of the start date for events that take place on one day of the week\n//for example monday, or thursday. We set the start date on the first day of the week\n//that the event is scheduled. For example if you set the event to repeat on each monday\n//the start date of the event will be set on the first monday after the day the event is scheduled\n    if ($_POST['form_repeat_type'] == 5) {\n        $exploded_date = explode(\"-\", $event_date);\n        $edate = date(\"D\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2], $exploded_date[0]));\n        if ($edate == \"Tue\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 6, $exploded_date[0]));\n        } elseif ($edate == \"Wed\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 5, $exploded_date[0]));\n        } elseif ($edate == \"Thu\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 4, $exploded_date[0]));\n        } elseif ($edate == \"Fri\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 3, $exploded_date[0]));\n        } elseif ($edate == \"Sat\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 2, $exploded_date[0]));\n        } elseif ($edate == \"Sun\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 1, $exploded_date[0]));\n        }\n    } elseif ($_POST['form_repeat_type'] == 6) {\n        $exploded_date = explode(\"-\", $event_date);\n        $edate = date(\"D\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2], $exploded_date[0]));\n        if ($edate == \"Wed\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 6, $exploded_date[0]));\n        } elseif ($edate == \"Thu\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 5, $exploded_date[0]));\n        } elseif ($edate == \"Fri\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 4, $exploded_date[0]));\n        } elseif ($edate == \"Sat\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 3, $exploded_date[0]));\n        } elseif ($edate == \"Sun\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 2, $exploded_date[0]));\n        } elseif ($edate == \"Mon\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 1, $exploded_date[0]));\n        }\n    } elseif ($_POST['form_repeat_type'] == 7) {\n        $exploded_date = explode(\"-\", $event_date);\n        $edate = date(\"D\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2], $exploded_date[0]));\n        if ($edate == \"Thu\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 6, $exploded_date[0]));\n        } elseif ($edate == \"Fri\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 5, $exploded_date[0]));\n        } elseif ($edate == \"Sat\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 4, $exploded_date[0]));\n        } elseif ($edate == \"Sun\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 3, $exploded_date[0]));\n        } elseif ($edate == \"Mon\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 2, $exploded_date[0]));\n        } elseif ($edate == \"Tue\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 1, $exploded_date[0]));\n        }\n    } elseif ($_POST['form_repeat_type'] == 8) {\n        $exploded_date = explode(\"-\", $event_date);\n        $edate = date(\"D\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2], $exploded_date[0]));\n        if ($edate == \"Fri\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 6, $exploded_date[0]));\n        } elseif ($edate == \"Sat\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 5, $exploded_date[0]));\n        } elseif ($edate == \"Sun\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 4, $exploded_date[0]));\n        } elseif ($edate == \"Mon\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 3, $exploded_date[0]));\n        } elseif ($edate == \"Tue\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 2, $exploded_date[0]));\n        } elseif ($edate == \"Wed\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 1, $exploded_date[0]));\n        }\n    } elseif ($_POST['form_repeat_type'] == 9) {\n        $exploded_date = explode(\"-\", $event_date);\n        $edate = date(\"D\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2], $exploded_date[0]));\n        if ($edate == \"Sat\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 6, $exploded_date[0]));\n        } elseif ($edate == \"Sun\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 5, $exploded_date[0]));\n        } elseif ($edate == \"Mon\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 4, $exploded_date[0]));\n        } elseif ($edate == \"Tue\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 3, $exploded_date[0]));\n        } elseif ($edate == \"Wed\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 2, $exploded_date[0]));\n        } elseif ($edate == \"Thu\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 1, $exploded_date[0]));\n        }\n    }//if end\n    /* =======================================================\n    //                                  UPDATE EVENTS\n    ========================================================*/\n    if ($eid) {\n        // what is multiple key around this $eid?\n        $row = sqlQuery(\"SELECT pc_multiple FROM openemr_postcalendar_events WHERE pc_eid = ?\", array($eid));\n\n        if ($GLOBALS['select_multi_providers'] && $row['pc_multiple']) {\n            /* ==========================================\n            // multi providers BOS\n            ==========================================*/\n\n            // obtain current list of providers regarding the multiple key\n            $up = sqlStatement(\"SELECT pc_aid FROM openemr_postcalendar_events WHERE pc_multiple = ?\", array($row['pc_multiple']));\n            while ($current = sqlFetchArray($up)) {\n                $providers_current[] = $current['pc_aid'];\n            }\n\n            $providers_new = $_POST['form_provider_ae'];\n\n            // this difference means that some providers from current was UNCHECKED\n            // so we must delete this event for them\n            $r1 = array_diff($providers_current, $providers_new);\n            if (count($r1)) {\n                foreach ($r1 as $to_be_removed) {\n                    sqlQuery(\"DELETE FROM openemr_postcalendar_events WHERE pc_aid = ? AND pc_multiple = ?\", array($to_be_removed, $row['pc_multiple']));\n                }\n            }\n\n            // this difference means that some providers was added\n            // so we must insert this event for them\n            $r2 = array_diff($providers_new, $providers_current);\n            if (count($r2)) {\n                foreach ($r2 as $to_be_inserted) {\n                    sqlStatement(\"INSERT INTO openemr_postcalendar_events ( pc_catid, pc_multiple, pc_aid, pc_pid, pc_title, pc_time, pc_hometext, pc_informant, pc_eventDate, pc_endDate, pc_duration, pc_recurrtype, pc_recurrspec, pc_startTime, pc_endTime, pc_alldayevent, pc_apptstatus, pc_prefcatid, pc_location, pc_eventstatus, pc_sharing, pc_facility)\n            VALUES ( \" .\n                        \"'\" . add_escape_custom($_POST['form_category']) . \"', \" .\n                        \"'\" . add_escape_custom($row['pc_multiple']) . \"', \" .\n                        \"'\" . add_escape_custom($to_be_inserted) . \"', \" .\n                        \"'\" . add_escape_custom($_POST['form_pid']) . \"', \" .\n                        \"'\" . add_escape_custom($_POST['form_title']) . \"', \" .\n                        \"NOW(), \" .\n                        \"'\" . add_escape_custom($_POST['form_comments']) . \"', \" .\n                        \"'\" . add_escape_custom($_SESSION['providerId']) . \"', \" .\n                        \"'\" . add_escape_custom($event_date) . \"', \" .\n                        \"'\" . add_escape_custom(fixDate($_POST['form_enddate'])) . \"', \" .\n                        \"'\" . add_escape_custom(($duration * 60)) . \"', \" .\n                        \"'\" . ($_POST['form_repeat'] ? '1' : '0') . \"', \" .\n                        \"'\" . add_escape_custom($recurrspec) . \"', \" .\n                        \"'\" . add_escape_custom($starttime) . \"', \" .\n                        \"'\" . add_escape_custom($endtime) . \"', \" .\n                        \"'\" . add_escape_custom($_POST['form_allday']) . \"', \" .\n                        \"'\" . add_escape_custom($_POST['form_apptstatus']) . \"', \" .\n                        \"'\" . add_escape_custom($_POST['form_prefcat']) . \"', \" .\n                        \"'\" . add_escape_custom($locationspec) . \"', \" .\n                        \"1, \" .\n                        \"1, \" . (int)$_POST['facility'] . \" )\"); // FF stuff\n                } // foreach\n            } //if count\n\n\n            // after the two diffs above, we must update for remaining providers\n            // those who are intersected in $providers_current and $providers_new\n            foreach ($_POST['form_provider_ae'] as $provider) {\n                sqlStatement(\"UPDATE openemr_postcalendar_events SET \" .\n                    \"pc_catid = '\" . add_escape_custom($_POST['form_category']) . \"', \" .\n                    \"pc_pid = '\" . add_escape_custom($_POST['form_pid']) . \"', \" .\n                    \"pc_title = '\" . add_escape_custom($_POST['form_title']) . \"', \" .\n                    \"pc_time = NOW(), \" .\n                    \"pc_hometext = '\" . add_escape_custom($_POST['form_comments']) . \"', \" .\n                    \"pc_informant = '\" . add_escape_custom($_SESSION['providerId']) . \"', \" .\n                    \"pc_eventDate = '\" . add_escape_custom($event_date) . \"', \" .\n                    \"pc_endDate = '\" . add_escape_custom(fixDate($_POST['form_enddate'])) . \"', \" .\n                    \"pc_duration = '\" . add_escape_custom(($duration * 60)) . \"', \" .\n                    \"pc_recurrtype = '\" . ($_POST['form_repeat'] ? '1' : '0') . \"', \" .\n                    \"pc_recurrspec = '\" . add_escape_custom($recurrspec) . \"', \" .\n                    \"pc_startTime = '\" . add_escape_custom($starttime) . \"', \" .\n                    \"pc_endTime = '\" . add_escape_custom($endtime) . \"', \" .\n                    \"pc_alldayevent = '\" . add_escape_custom($_POST['form_allday']) . \"', \" .\n                    \"pc_apptstatus = '\" . add_escape_custom($_POST['form_apptstatus']) . \"', \" .\n                    \"pc_prefcatid = '\" . add_escape_custom($_POST['form_prefcat']) . \"', \" .\n                    \"pc_facility = '\" . (int)$_POST['facility'] . \"' \" . // FF stuff\n                    \"WHERE pc_aid = '\" . add_escape_custom($provider) . \"' AND pc_multiple='\" . add_escape_custom($row['pc_multiple']) . \"'\");\n            } // foreach\n\n            /* ==========================================\n          // multi providers EOS\n            ==========================================*/\n        } elseif (!$row['pc_multiple']) {\n            if ($GLOBALS['select_multi_providers']) {\n                $prov = $_POST['form_provider_ae'][0];\n            } else {\n                $prov = $_POST['form_provider_ae'];\n            }\n            $insert = false;\n            // simple provider case\n            sqlStatement(\"UPDATE openemr_postcalendar_events SET \" .\n                \"pc_catid = '\" . add_escape_custom($_POST['form_category']) . \"', \" .\n                \"pc_aid = '\" . add_escape_custom($prov) . \"', \" .\n                \"pc_pid = '\" . add_escape_custom($_POST['form_pid']) . \"', \" .\n                \"pc_title = '\" . add_escape_custom($_POST['form_title']) . \"', \" .\n                \"pc_time = NOW(), \" .\n                \"pc_hometext = '\" . add_escape_custom($_POST['form_comments']) . \"', \" .\n                \"pc_informant = '\" . add_escape_custom($_SESSION['providerId']) . \"', \" .\n                \"pc_eventDate = '\" . add_escape_custom($event_date) . \"', \" .\n                \"pc_endDate = '\" . add_escape_custom(fixDate($_POST['form_enddate'])) . \"', \" .\n                \"pc_duration = '\" . add_escape_custom(($duration * 60)) . \"', \" .\n                \"pc_recurrtype = '\" . ($_POST['form_repeat'] ? '1' : '0') . \"', \" .\n                \"pc_recurrspec = '\" . add_escape_custom($recurrspec) . \"', \" .\n                \"pc_startTime = '\" . add_escape_custom($starttime) . \"', \" .\n                \"pc_endTime = '\" . add_escape_custom($endtime) . \"', \" .\n                \"pc_alldayevent = '\" . add_escape_custom($_POST['form_allday']) . \"', \" .\n                \"pc_apptstatus = '\" . add_escape_custom($_POST['form_apptstatus']) . \"', \" .\n                \"pc_prefcatid = '\" . add_escape_custom($_POST['form_prefcat']) . \"', \" .\n                \"pc_facility = '\" . (int)$_POST['facility'] . \"' \" . // FF stuff\n                \"WHERE pc_eid = '\" . add_escape_custom($eid) . \"'\");\n        }\n\n        // =======================================\n        // EOS multi providers case\n        // =======================================\n\n        // EVENTS TO FACILITIES\n\n        $e2f = (int)$eid;\n\n        /* =======================================================\n      //                                  INSERT EVENTS\n        ========================================================*/\n    } else {\n        // =======================================\n        // multi providers case\n        // =======================================\n\n        if (is_array($_POST['form_provider_ae'])) {\n            // obtain the next available unique key to group multiple providers around some event\n            $q = sqlStatement(\"SELECT MAX(pc_multiple) as max FROM openemr_postcalendar_events\");\n            $max = sqlFetchArray($q);\n            $new_multiple_value = $max['max'] + 1;\n\n            foreach ($_POST['form_provider_ae'] as $provider) {\n                sqlStatement(\"INSERT INTO openemr_postcalendar_events ( \" .\n                    \"pc_catid, pc_multiple, pc_aid, pc_pid, pc_title, pc_time, pc_hometext, \" .\n                    \"pc_informant, pc_eventDate, pc_endDate, pc_duration, pc_recurrtype, \" .\n                    \"pc_recurrspec, pc_startTime, pc_endTime, pc_alldayevent, \" .\n                    \"pc_apptstatus, pc_prefcatid, pc_location, pc_eventstatus, pc_sharing, pc_facility \" .\n                    \") VALUES ( \" .\n                    \"'\" . add_escape_custom($_POST['form_category']) . \"', \" .\n                    \"'\" . add_escape_custom($new_multiple_value) . \"', \" .\n                    \"'\" . add_escape_custom($provider) . \"', \" .\n                    \"'\" . add_escape_custom($_POST['form_pid']) . \"', \" .\n                    \"'\" . add_escape_custom($_POST['form_title']) . \"', \" .\n                    \"NOW(), \" .\n                    \"'\" . add_escape_custom($_POST['form_comments']) . \"', \" .\n                    \"'\" . add_escape_custom($_SESSION['providerId']) . \"', \" .\n                    \"'\" . add_escape_custom($event_date) . \"', \" .\n                    \"'\" . add_escape_custom(fixDate($_POST['form_enddate'])) . \"', \" .\n                    \"'\" . add_escape_custom(($duration * 60)) . \"', \" .\n                    \"'\" . ($_POST['form_repeat'] ? '1' : '0') . \"', \" .\n                    \"'\" . add_escape_custom($recurrspec) . \"', \" .\n                    \"'\" . add_escape_custom($starttime) . \"', \" .\n                    \"'\" . add_escape_custom($endtime) . \"', \" .\n                    \"'\" . add_escape_custom($_POST['form_allday']) . \"', \" .\n                    \"'\" . add_escape_custom($_POST['form_apptstatus']) . \"', \" .\n                    \"'\" . add_escape_custom($_POST['form_prefcat']) . \"', \" .\n                    \"'\" . add_escape_custom($locationspec) . \"', \" .\n                    \"1, \" .\n                    \"1, \" . (int)$_POST['facility'] . \" )\"); // FF stuff\n            } // foreach\n        } else {\n            $_POST['form_apptstatus'] = '^';\n            $insert = true;\n            sqlStatement(\"INSERT INTO openemr_postcalendar_events ( \" .\n                \"pc_catid, pc_aid, pc_pid, pc_title, pc_time, pc_hometext, \" .\n                \"pc_informant, pc_eventDate, pc_endDate, pc_duration, pc_recurrtype, \" .\n                \"pc_recurrspec, pc_startTime, pc_endTime, pc_alldayevent, \" .\n                \"pc_apptstatus, pc_prefcatid, pc_location, pc_eventstatus, pc_sharing, pc_facility \" .\n                \") VALUES ( \" .\n                \"'\" . add_escape_custom($_POST['form_category']) . \"', \" .\n                \"'\" . add_escape_custom($_POST['form_provider_ae']) . \"', \" .\n                \"'\" . add_escape_custom($_POST['form_pid']) . \"', \" .\n                \"'\" . add_escape_custom($_POST['form_title']) . \"', \" .\n                \"NOW(), \" .\n                \"'\" . add_escape_custom($_POST['form_comments']) . \"', \" .\n                \"'\" . add_escape_custom($_SESSION['providerId']) . \"', \" .\n                \"'\" . add_escape_custom($event_date) . \"', \" .\n                \"'\" . add_escape_custom(fixDate($_POST['form_enddate'])) . \"', \" .\n                \"'\" . add_escape_custom(($duration * 60)) . \"', \" .\n                \"'\" . ($_POST['form_repeat'] ? '1' : '0') . \"', \" .\n                \"'\" . add_escape_custom($recurrspec) . \"', \" .\n                \"'\" . add_escape_custom($starttime) . \"', \" .\n                \"'\" . add_escape_custom($endtime) . \"', \" .\n                \"'\" . add_escape_custom($_POST['form_allday']) . \"', \" .\n                \"'\" . add_escape_custom($_POST['form_apptstatus']) . \"', \" .\n                \"'\" . add_escape_custom($_POST['form_prefcat']) . \"', \" .\n                \"'\" . add_escape_custom($locationspec) . \"', \" .\n                \"1, \" .\n                \"1, \" . (int)$_POST['facility'] . \")\"); // FF stuff\n        } // INSERT single\n    } // else - insert\n} elseif ($_POST['form_action'] == \"delete\") {\n// =======================================\n//  multi providers case\n// =======================================\n    if ($GLOBALS['select_multi_providers']) {\n        // what is multiple key around this $eid?\n        $row = sqlQuery(\"SELECT pc_multiple FROM openemr_postcalendar_events WHERE pc_eid = ?\", array($eid));\n        if ($row['pc_multiple']) {\n            sqlStatement(\"DELETE FROM openemr_postcalendar_events WHERE pc_multiple = ?\", array($row['pc_multiple']));\n        } else {\n            sqlStatement(\"DELETE FROM openemr_postcalendar_events WHERE pc_eid = ?\", array($eid));\n        }\n\n        // =======================================\n        //  EOS multi providers case\n        // =======================================\n    } else {\n        sqlStatement(\"DELETE FROM openemr_postcalendar_events WHERE pc_eid = ?\", array($eid));\n    }\n}\n\nif (!empty($_POST['form_action'])) {\n    // Leave\n    $type = $insert ? xl(\"A New Appointment\") : xl(\"An Updated Appointment\");\n    $note = $type . \" \" . xl(\"request was received from portal patient\") . \" \";\n    $note .= $_SESSION['ptName'] . \" \" . xl(\"regarding appointment dated\") . \" \" . $event_date . \" \" . $starttime . \". \";\n    $note .= !empty($_POST['form_comments']) ? (xl(\"Reason\") . \" \" . $_POST['form_comments']) : \"\";\n    $note .= \". \" . xl(\"Use Portal Dashboard to confirm with patient.\");\n    $title = xl(\"Patient Reminders\");\n    $user = sqlQueryNoLog(\"SELECT users.username FROM users WHERE authorized = 1 And id = ?\", array($_POST['form_provider_ae']));\n    $rtn = addPnote($_POST['form_pid'], $note, 1, 1, $title, $user['username'], '', 'New');\n\n    $_SESSION['whereto'] = '#appointmentcard';\n    header('Location:./home.php');\n    exit();\n}\n\n// If we get this far then we are displaying the form.\n\n$statuses = array(\n    '-' => '',\n    '*' => xl('* Reminder done'),\n    '+' => xl('+ Chart pulled'),\n    'x' => xl('x Cancelled'), // added Apr 2008 by JRM\n    '?' => xl('? No show'),\n    '@' => xl('@ Arrived'),\n    '~' => xl('~ Arrived late'),\n    '!' => xl('! Left w/o visit'),\n    '#' => xl('# Ins/fin issue'),\n    '<' => xl('< In exam room'),\n    '>' => xl('> Checked out'),\n    '$' => xl('$ Coding done'),\n    '^' => xl('^ Pending'),\n);\n\n$repeats = 0; // if the event repeats\n$repeattype = '0';\n$repeatfreq = '0';\n$patienttitle = \"\";\n$hometext = \"\";\n$row = array();\n\n// If we are editing an existing event, then get its data.\nif ($eid) {\n    $row = sqlQuery(\"SELECT * FROM openemr_postcalendar_events WHERE pc_eid = ?\", array($eid));\n    $date = $row['pc_eventDate'];\n    $userid = $row['pc_aid'];\n    $patientid = $row['pc_pid'];\n    $starttimeh = substr($row['pc_startTime'], 0, 2) + 0;\n    $starttimem = substr($row['pc_startTime'], 3, 2);\n    $repeats = $row['pc_recurrtype'];\n    $multiple_value = $row['pc_multiple'];\n\n    if (preg_match('/\"event_repeat_freq_type\";s:1:\"(\\d)\"/', $row['pc_recurrspec'], $matches)) {\n        $repeattype = $matches[1];\n    }\n\n    if (preg_match('/\"event_repeat_freq\";s:1:\"(\\d)\"/', $row['pc_recurrspec'], $matches)) {\n        $repeatfreq = $matches[1];\n    }\n\n    $hometext = $row['pc_hometext'];\n    if (substr($hometext, 0, 6) == ':text:') {\n        $hometext = substr($hometext, 6);\n    }\n} else {\n    $patientid = $_GET['pid'];\n}\n\n// If we have a patient ID, get the name and phone numbers to display.\nif ($patientid) {\n    $prow = sqlQuery(\"SELECT lname, fname, phone_home, phone_biz, DOB \" .\n        \"FROM patient_data WHERE pid = ?\", array($patientid));\n    $patientname = $prow['lname'] . \", \" . $prow['fname'];\n    if ($prow['phone_home']) {\n        $patienttitle .= \" H=\" . $prow['phone_home'];\n    }\n\n    if ($prow['phone_biz']) {\n        $patienttitle .= \" W=\" . $prow['phone_biz'];\n    }\n}\n\n// Get the providers list.\n$ures = sqlStatement(\"SELECT `id`, `username`, `fname`, `lname`, `mname` FROM `users` WHERE \" .\n    \"`authorized` != 0 AND `active` = 1 AND `username` > '' ORDER BY `lname`, `fname`\");\n\n//Set default facility for a new event based on the given 'userid'\nif ($userid) {\n    $pref_facility = sqlFetchArray(sqlStatement(\"SELECT facility_id, facility FROM users WHERE id = ?\", array($userid)));\n    $e2f = $pref_facility['facility_id'];\n    $e2f_name = $pref_facility['facility'];\n}\n?>\n<!DOCTYPE html>\n<html>\n<head>\n    <title><?php echo $eid ? xlt(\"Edit Event\") : xlt(\"Add New Event\"); ?></title>\n    <?php // no header necessary. scope is home.php ?>\n</head>\n<script>\n    var durations = Array();\n    <?php\n    // Read the event categories, generate their options list, and get\n    // the default event duration from them if this is a new event.\n    $cattype = 0;\n\n    // Get event categories.\n    $cres = sqlStatement(\"SELECT pc_catid, pc_cattype, pc_catname, \" .\n        \"pc_recurrtype, pc_duration, pc_end_all_day \" .\n        \"FROM openemr_postcalendar_categories where pc_active = 1 ORDER BY pc_seq\");\n    $catoptions = \"\";\n    $prefcat_options = \"    <option value='0'>-- \" . xlt(\"None{{Category}}\") . \" --</option>\\n\";\n    $thisduration = 0;\n    if ($eid) {\n        $thisduration = $row['pc_alldayevent'] ? 1440 : round($row['pc_duration'] / 60);\n    }\n    while ($crow = sqlFetchArray($cres)) {\n        $duration = round($crow['pc_duration'] / 60);\n        if ($crow['pc_end_all_day']) {\n            $duration = 1440;\n        }\n\n        // This section is to build the list of preferred categories:\n        if ($duration) {\n            $prefcat_options .= \" <option value='\" . attr($crow['pc_catid']) . \"'\";\n            if ($eid) {\n                if ($crow['pc_catid'] == $row['pc_prefcatid']) {\n                    $prefcat_options .= \" selected\";\n                }\n            }\n\n            $prefcat_options .= \">\" . text(xl_appt_category($crow['pc_catname'])) . \"</option>\\n\";\n        }\n\n        if ($crow['pc_cattype'] != $cattype) {\n            continue;\n        }\n\n        echo \" durations[\" . attr($crow['pc_catid']) . \"] = \" . attr($duration) . \";\\n\";\n        // echo \" rectypes[\" . $crow['pc_catid'] . \"] = \" . $crow['pc_recurrtype'] . \"\\n\";\n        $catoptions .= \"    <option value='\" . attr($crow['pc_catid']) . \"'\";\n        if ($eid) {\n            if ($crow['pc_catid'] == $row['pc_catid']) {\n                $catoptions .= \" selected\";\n            }\n        } else {\n            if ($crow['pc_catid'] == $default_catid) {\n                $catoptions .= \" selected\";\n                $thisduration = $duration;\n            }\n        }\n\n        $catoptions .= \">\" . text(xl_appt_category($crow['pc_catname'])) . \"</option>\\n\";\n    }\n    // Fix up the time format for AM/PM.\n    $startampm = '1';\n    if ($starttimeh >= 12) { // p.m. starts at noon and not 12:01\n        $startampm = '2';\n        if ($starttimeh > 12) {\n            $starttimeh -= 12;\n        }\n    }\n\n    ?>\n</script>\n<body class=\"skin-blue\">\n    <div class=\"container-fluid\">\n        <form method='post' name='theaddform' id='theaddform' action='add_edit_event_user.php?eid=<?php echo attr_url($eid); ?>'>\n            <div class=\"col-12\">\n                <input type=\"hidden\" name=\"form_action\" id=\"form_action\" value=\"\" />\n                <input type='hidden' name='form_title' id='form_title' value='<?php echo $row['pc_catid'] ? attr($row['pc_title']) : xla(\"Office Visit\"); ?>' />\n                <input type='hidden' name='form_apptstatus' id='form_apptstatus' value='<?php echo $row['pc_apptstatus'] ? attr($row['pc_apptstatus']) : \"^\" ?>' />\n                <div class=\"row form-group\">\n                    <div class=\"input-group col-12 col-md-6\">\n                        <label class=\"mr-2\" for=\"form_category\"><?php echo xlt('Visit'); ?>:</label>\n                        <select class=\"form-control mb-1\" onchange='set_category()' id='form_category' name='form_category' value='<?php echo ($row['pc_catid'] > \"\") ? attr($row['pc_catid']) : '5'; ?>'>\n                            <?php echo $catoptions ?>\n                        </select>\n                    </div>\n                    <div class=\"input-group col-12 col-md-6\">\n                        <label class=\"mr-2\" for=\"form_date\"><?php echo xlt('Date'); ?>:</label>\n                        <input class=\"form-control mb-1\" type='text' name='form_date' readonly id='form_date' value='<?php echo (isset($eid) && $eid) ? attr($row['pc_eventDate']) : attr($date); ?>' />\n                    </div>\n                </div>\n                <div class=\"row\">\n                    <div class=\"form-group form-inline col-12\">\n                        <div class=\"input-group mb-1\">\n                            <label class=\"mr-2\"><?php echo xlt('Time'); ?>:</label>\n                            <input class=\"form-control col-2 col-md-3\" type='text' name='form_hour' size='2' value='<?php echo (isset($eid)) ? $starttimeh : ''; ?>' title='<?php echo xla('Event start time'); ?>' readonly />\n                            <input class=\"form-control col-2 col-md-3\" type='text' name='form_minute' size='2' value='<?php echo (isset($eid)) ? $starttimem : ''; ?>' title='<?php echo xla('Event start time'); ?>' readonly />\n                            <select class=\"form-control col-3 col-md-4\" name='form_ampm' title='Note: 12:00 noon is PM, not AM' readonly>\n                                <option value='1'><?php echo xlt('AM'); ?></option>\n                                <option value='2'<?php echo ($startampm == '2') ? \" selected\" : \"\"; ?>><?php echo xlt('PM'); ?></option>\n                            </select>\n                        </div>\n                        <div class=\"input-group\">\n                            <label class=\"mr-2\" for=\"form_duration\"><?php echo xlt('Duration'); ?></label>\n                            <input class=\"form-control\" type='text' size='1' id='form_duration' name='form_duration' value='<?php echo $row['pc_duration'] ? ($row['pc_duration'] * 1 / 60) : attr($thisduration) ?>' readonly />\n                            <span class=\"input-group-append\">\n                            <span class=\"input-group-text\"><?php echo \"&nbsp;\" . xlt('minutes'); ?></span>\n                        </span>\n                        </div>\n                    </div>\n                </div>\n                <div class=\"row\">\n                    <div class=\"input-group col-12 mb-1\">\n                        <label class=\"mr-2\" for=\"form_patient\"><?php echo xlt('Patient'); ?>:</label>\n                        <input class=\"form-control\" type='text' id='form_patient' name='form_patient' value='<?php echo attr($patientname); ?>' title='Patient' readonly />\n                        <input type='hidden' name='form_pid' value='<?php echo attr($patientid); ?>' />\n                    </div>\n                </div>\n                <div class=\"row\">\n                    <div class=\"input-group col-12 mb-1\">\n                        <label class=\"mr-2\" for=\"form_provider_ae\"><?php echo xlt('Provider'); ?>:</label>\n                        <select class=\"form-control\" name='form_provider_ae' id='form_provider_ae' onchange='change_provider();'>\n                            <?php\n                            // present a list of providers to choose from\n                            // default to the currently logged-in user\n                            while ($urow = sqlFetchArray($ures)) {\n                                echo \"<option value='\" . attr($urow['id']) . \"'\";\n                                if (($urow['id'] == $_GET['userid']) || ($urow['id'] == $userid)) {\n                                    echo \" selected\";\n                                }\n                                echo \">\" . text($urow['lname']);\n                                if ($urow['fname']) {\n                                    echo \", \" . text($urow['fname']);\n                                }\n                                echo \"</option>\\n\";\n                            }\n                            ?>\n                        </select>\n                        <div class=\"text-right\">\n                            <input type='button' class='btn btn-success' value='<?php echo xla('Openings'); ?>' onclick='find_available()' />\n                        </div>\n                    </div>\n                </div>\n                <div class=\"row\">\n                    <div class=\"input-group col-12\">\n                        <label class=\"mr-2\"><?php echo xlt('Reason'); ?>:</label>\n                        <input class=\"form-control\" type='text' size='40' name='form_comments' value='<?php echo attr($hometext); ?>' title='<?php echo xla('Optional information about this event'); ?>' />\n                    </div>\n                </div>\n                <div class=\"row input-group my-1\">\n                    <?php if ($_GET['eid'] && $row['pc_apptstatus'] !== 'x') { ?>\n                        <input type='button' id='form_cancel' class='btn btn-danger' onsubmit='return false' value='<?php echo xla('Cancel Appointment'); ?>' onclick=\"cancel_appointment()\" />\n                    <?php } ?>\n                    <input type='button' name='form_save' class='btn btn-success' onsubmit='return false' value='<?php echo xla('Save'); ?>' onclick=\"validate()\" />\n                </div>\n            </div>\n        </form>\n        <script>\n            function change_provider() {\n                var f = document.forms.namedItem(\"theaddform\");\n                f.form_date.value = '';\n                f.form_hour.value = '';\n                f.form_minute.value = '';\n            }\n\n            function set_display() {\n                var f = document.forms.namedItem(\"theaddform\");\n                var si = document.getElementById('form_category');\n                if (si.selectedIndex >= 0) {\n                    var catid = si.options[si.selectedIndex].value;\n                    //var style_apptstatus = document.getElementById('title_apptstatus').style;\n                    //var style_prefcat = document.getElementById('title_prefcat').style;\n                    // will keep this for future. not needed now.\n                }\n            }\n\n            function cancel_appointment() {\n                let f = document.forms.namedItem(\"theaddform\");\n                let msg = <?php echo xlj(\"Click Okay if you are sure you want to cancel this appointment?\") . \"\\n\" .\n                    xlj(\"It is prudent to follow up with provider if not contacted.\") ?>;\n                let msg_reason = <?php echo xlj(\"You must enter a reason to cancel this appointment?\") . \"\\n\" .\n                    xlj(\"Reason must be at least 10 characters!\") ?>;\n                if (f.form_comments.value.length <= 10) {\n                    alert(msg_reason);\n                    return false;\n                }\n                let yn = confirm(msg);\n                if (!yn) {\n                    return false;\n                }\n                document.getElementById('form_apptstatus').value = \"x\";\n                validate();\n            }\n\n            // Do whatever is needed when a new event category is selected.\n            // For now this means changing the event title and duration.\n            function set_category() {\n                var f = document.forms.namedItem(\"theaddform\");\n                var s = f.form_category;\n                if (s.selectedIndex >= 0) {\n                    var catid = s.options[s.selectedIndex].value;\n                    f.form_title.value = s.options[s.selectedIndex].text;\n                    f.form_duration.value = durations[catid];\n                    set_display();\n                }\n            }\n\n            // This is for callback by the find-available popup.\n            function setappt(year, mon, mday, hours, minutes) {\n                var f = document.forms.namedItem(\"theaddform\");\n                f.form_date.value = '' + year + '-' +\n                    ('' + (mon + 100)).substring(1) + '-' +\n                    ('' + (mday + 100)).substring(1);\n                f.form_ampm.selectedIndex = (hours > 12) ? 1 : 0;\n                if (hours == 0) {\n                    f.form_hour.value = 12;\n                } else {\n                    f.form_hour.value = (hours >= 13) ? hours - 12 : hours;\n                }\n                f.form_minute.value = minutes;\n            }\n\n            function get_form_category_value() {\n                var catid = 0;\n                var f = document.forms.namedItem(\"theaddform\");\n                var s = f.form_category;\n                if (s.selectedIndex >= 0) {\n                    catid = s.options[s.selectedIndex].value;\n                }\n                return catid;\n            }\n\n            // Invoke the find-available popup.\n            function find_available() {\n                // when making an appointment for a specific provider\n                var catId = get_form_category_value() || 5;\n                var se = document.getElementById('form_provider_ae');\n                <?php if ($userid != 0) { ?>\n                s = se.value;\n                <?php } else {?>\n                s = se.options[se.selectedIndex].value;\n                <?php }?>\n                var formDate = document.getElementById('form_date');\n                var url = 'find_appt_popup_user.php?bypatient&providerid=' + encodeURIComponent(s) + '&catid=' + encodeURIComponent(catId)\n                    + '&startdate=' + encodeURIComponent(formDate.value);\n                var params = {\n                    buttons: [\n                        {text: <?php echo xlj('Cancel'); ?>, close: true, style: 'danger btn-sm'}\n\n                    ],\n                    allowResize: true,\n                    dialogId: 'apptDialog',\n                    type: 'iframe'\n                };\n                dlgopen(url, 'apptFind', 'modal-md', 300, '', 'Find Date', params);\n            }\n\n            // Check for errors when the form is submitted.\n            function validate() {\n                var f = document.getElementById('theaddform');\n                if (!f.form_date.value || !f.form_hour.value || !f.form_minute.value) {\n                    alert(<?php echo xlj('Please click on Openings to select a time.'); ?>);\n                    return false;\n                }\n\n                if (f.form_patient.value == '') {\n                    alert(<?php echo xlj('Your Id is missing. Cancel and try again.'); ?>);\n                    return false;\n                }\n\n                var form_action = document.getElementById('form_action');\n                form_action.value = \"save\";\n                f.submit();\n                return false;\n            }\n\n            <?php if ($eid) { ?>\n            set_display();\n            <?php } ?>\n            $(function () {\n\n            });\n        </script>\n    </div>\n</body>\n</html>\n", "<?php\n\n/**\n * PatientTrackerService Handles the select, create, and update of patient events that we are track.  This is used typically\n * in the patient flow board and for patient reporting.\n *\n * Much of this code was refactored from the patient_tracker.inc.php file.\n *\n * @package openemr\n * @link      http://www.open-emr.org\n * @author    Stephen Nielson <stephen@nielson.org>\n * @author    Terry Hill <terry@lillysystems.com>\n * @copyright Copyright (C) 2015 Terry Hill <terry@lillysystems.com>\n * @copyright Copyright (c) 2021 Stephen Nielson <stephen@nielson.org>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\nnamespace OpenEMR\\Services;\n\nuse OpenEMR\\Events\\Services\\ServiceSaveEvent;\n\nclass PatientTrackerService extends BaseService\n{\n    const TABLE_NAME = \"patient_tracker\";\n    const TABLE_NAME_TRACKER_ELEMENT = \"patient_tracker_element\";\n\n    public function __construct()\n    {\n        parent::__construct(self::TABLE_NAME);\n    }\n\n    /**\n     * @param $tracker_from_time\n     * @param $tracker_to_time\n     * @param bool $allow_sec\n     * @return string\n     */\n    public function get_Tracker_Time_Interval($tracker_from_time, $tracker_to_time, $allow_sec = false)\n    {\n\n        $tracker_time_calc = strtotime($tracker_to_time) - strtotime($tracker_from_time);\n\n        $tracker_time = \"\";\n        if ($tracker_time_calc > 60 * 60 * 24) {\n            $days = floor($tracker_time_calc / 60 / 60 / 24);\n            if ($days >= 2) {\n                $tracker_time .=  \"$days \" . xl('days');\n            } else {\n                $tracker_time .=  \"$days \" . xl('day');\n            }\n\n            $tracker_time_calc = $tracker_time_calc - ($days * (60 * 60 * 24));\n        }\n\n        if ($tracker_time_calc > 60 * 60) {\n            $hours = floor($tracker_time_calc / 60 / 60);\n            if (strlen($days != 0)) {\n                if ($hours >= 2) {\n                    $tracker_time .=  \", $hours \" . xl('hours');\n                } else {\n                    $tracker_time .=  \", $hours \" . xl('hour');\n                }\n            } else {\n                if ($hours >= 2) {\n                    $tracker_time .=  \"$hours \" . xl('hours');\n                } else {\n                    $tracker_time .=  \"$hours \" . xl('hour');\n                }\n            }\n\n            $tracker_time_calc = $tracker_time_calc - ($hours * (60 * 60));\n        }\n\n        if ($allow_sec) {\n            if ($tracker_time_calc > 60) {\n                $minutes = floor($tracker_time_calc / 60);\n                if (strlen($hours != 0)) {\n                    if ($minutes >= 2) {\n                        $tracker_time .=  \", $minutes \" . xl('minutes');\n                    } else {\n                        $tracker_time .=  \", $minutes \" . xl('minute');\n                    }\n                } else {\n                    if ($minutes >= 2) {\n                        $tracker_time .=  \"$minutes \" . xl('minutes');\n                    } else {\n                        $tracker_time .=  \"$minutes \" . xl('minute');\n                    }\n                }\n\n                $tracker_time_calc = $tracker_time_calc - ($minutes * 60);\n            }\n        } else {\n            $minutes = round($tracker_time_calc / 60);\n            if (!empty($hours) && strlen($hours != 0)) {\n                if ($minutes >= 2) {\n                    $tracker_time .=  \", $minutes \" . xl('minutes');\n                } else {\n                    $tracker_time .=  \", $minutes \" . xl('minute');\n                }\n            } else {\n                if ($minutes >= 2) {\n                    $tracker_time .=  \"$minutes \" . xl('minutes');\n                } else {\n                    if ($minutes > 0) {\n                        $tracker_time .=  \"$minutes \" . xl('minute');\n                    }\n                }\n            }\n\n            $tracker_time_calc = $tracker_time_calc - ($minutes * 60);\n        }\n\n        if ($allow_sec) {\n            if ($tracker_time_calc > 0) {\n                if (strlen($minutes != 0)) {\n                    if ($tracker_time_calc >= 2) {\n                        $tracker_time .= \", $tracker_time_calc \" . xl('seconds');\n                    } else {\n                        $tracker_time .= \", $tracker_time_calc \" . xl('second');\n                    }\n                } else {\n                    if ($tracker_time_calc >= 2) {\n                        $tracker_time .= \"$tracker_time_calc \" . xl('seconds');\n                    } else {\n                        $tracker_time .= \"$tracker_time_calc \" . xl('second');\n                    }\n                }\n            }\n        }\n\n        return $tracker_time ;\n    }\n\n    /**\n     * This function will return false for both below scenarios:\n     * 1. The tracker item does not exist\n     * 2. If the tracker item does exist, but the encounter has not been set\n     * @param $apptdate\n     * @param $appttime\n     * @param $pid\n     * @param $eid\n     * @return int\n     */\n    public function is_tracker_encounter_exist($apptdate, $appttime, $pid, $eid)\n    {\n        #Check to see if there is an encounter in the patient_tracker table.\n        $enc_yn = sqlQuery(\"SELECT encounter from patient_tracker WHERE `apptdate` = ? AND encounter > 0 \" .\n            \"AND `eid` = ? AND `pid` = ?\", array($apptdate, $eid, $pid));\n        if (empty($enc_yn['encounter']) || $enc_yn === false) {\n            return (0);\n        }\n\n        return ($enc_yn['encounter']);\n    }\n\n    /**\n     * this function will return the tracker id that is managed\n     * or will return false if no tracker id was managed (in the case of a recurrent appointment)\n     * @param $apptdate\n     * @param $appttime\n     * @param $eid\n     * @param $pid\n     * @param $user\n     * @param string $status\n     * @param string $room\n     * @param string $enc_id\n     * @return bool|int\n     */\n    public function manage_tracker_status($apptdate, $appttime, $eid, $pid, $user, $status = '', $room = '', $enc_id = '')\n    {\n        #First ensure the eid is not a recurrent appointment. If it is, then do not do anything and return false.\n        $pc_appt =  sqlQuery(\"SELECT `pc_recurrtype` FROM `openemr_postcalendar_events` WHERE `pc_eid` = ?\", array($eid));\n        if ($pc_appt['pc_recurrtype'] != 0) {\n            return false;\n        }\n\n        $datetime = date(\"Y-m-d H:i:s\");\n        if (is_null($room)) {\n            $room = '';\n        }\n\n        #Check to see if there is an entry in the patient_tracker table.\n        $tracker = sqlQuery(\"SELECT id, apptdate, appttime, eid, pid, original_user, encounter, lastseq,\" .\n            \"patient_tracker_element.room AS lastroom,patient_tracker_element.status AS laststatus \" .\n            \"from `patient_tracker`\" .\n            \"LEFT JOIN patient_tracker_element \" .\n            \"ON patient_tracker.id = patient_tracker_element.pt_tracker_id \" .\n            \"AND patient_tracker.lastseq = patient_tracker_element.seq \" .\n            \"WHERE `apptdate` = ? AND `appttime` = ? \" .\n            \"AND `eid` = ? AND `pid` = ?\", array($apptdate,$appttime,$eid,$pid));\n\n        if (empty($tracker)) {\n            #Add a new tracker.\n            $tracker_id = sqlInsert(\n                \"INSERT INTO `patient_tracker` \" .\n                \"(`date`, `apptdate`, `appttime`, `eid`, `pid`, `original_user`, `encounter`, `lastseq`) \" .\n                \"VALUES (?,?,?,?,?,?,?,'1')\",\n                array($datetime,$apptdate,$appttime,$eid,$pid,$user,$enc_id)\n            );\n            #If there is a status or a room, then add a tracker item.\n            if (!empty($status) || !empty($room)) {\n                sqlStatement(\n                    \"INSERT INTO `patient_tracker_element` \" .\n                    \"(`pt_tracker_id`, `start_datetime`, `user`, `status`, `room`, `seq`) \" .\n                    \"VALUES (?,?,?,?,?,'1')\",\n                    array($tracker_id,$datetime,$user,$status,$room)\n                );\n            }\n            $tracker = [\n                'id' => $tracker_id\n                ,'date' => $datetime\n                ,'apptdate' => $apptdate\n                ,'appttime' => $appttime\n                ,'eid' => $eid\n                ,'pid' => $pid\n                ,'original_user' => $user\n                ,'encounter' => $enc_id\n                ,'lastseq' => '1'\n                ,'element' => [\n                    'pt_tracker_id' => $tracker_id\n                    ,'start_datetime' => $datetime\n                    ,'user' => $user\n                    ,'status' => $status\n                    ,'room' => $room\n                    ,'seq' => '1'\n                ]\n            ];\n        } else {\n            #Tracker already exists.\n            $tracker_id = $tracker['id'];\n            if (($status != $tracker['laststatus']) || ($room != $tracker['lastroom'])) {\n                #Status or room has changed, so need to update tracker.\n                #Update lastseq in tracker.\n                sqlStatement(\n                    \"UPDATE `patient_tracker` SET  `lastseq` = ? WHERE `id` = ?\",\n                    array(($tracker['lastseq'] + 1),$tracker_id)\n                );\n                #Add a tracker item.\n                sqlStatement(\n                    \"INSERT INTO `patient_tracker_element` \" .\n                    \"(`pt_tracker_id`, `start_datetime`, `user`, `status`, `room`, `seq`) \" .\n                    \"VALUES (?,?,?,?,?,?)\",\n                    array($tracker_id,$datetime,$user,$status,$room,($tracker['lastseq'] + 1))\n                );\n            }\n\n            if (!empty($enc_id)) {\n                #enc_id (encounter number) is not blank, so update this in tracker.\n                sqlStatement(\"UPDATE `patient_tracker` SET `encounter` = ? WHERE `id` = ?\", array($enc_id,$tracker_id));\n            }\n            $tracker['lastseq'] = $tracker['lastseq'] + 1;\n            $tracker['element'] = [\n                    'pt_tracker_id' => $tracker_id\n                    ,'start_datetime' => $datetime\n                    ,'user' => $user\n                    ,'status' => $status\n                    ,'room' => $room\n                    ,'seq' => $tracker['lastseq']\n            ];\n        }\n\n        #Ensure the entry in calendar appt entry has been updated.\n        $pc_appt =  sqlQuery(\"SELECT `pc_apptstatus`, `pc_room` FROM `openemr_postcalendar_events` WHERE `pc_eid` = ?\", array($eid));\n        if ($status != $pc_appt['pc_apptstatus']) {\n            sqlStatement(\"UPDATE `openemr_postcalendar_events` SET `pc_apptstatus` = ? WHERE `pc_eid` = ?\", array($status,$eid));\n        }\n\n        if ($room != $pc_appt['pc_room']) {\n            sqlStatement(\"UPDATE `openemr_postcalendar_events` SET `pc_room` = ? WHERE `pc_eid` = ?\", array($room,$eid));\n        }\n\n        $GLOBALS['kernel']->getEventDispatcher()->dispatch(new ServiceSaveEvent($this, $tracker), ServiceSaveEvent::EVENT_POST_SAVE);\n\n        # Returning the tracker id that has been managed\n        return $tracker_id;\n    }\n\n    /**\n     * This is used to break apart the information contained in the notes field of\n     * list_options. Currently the color and alert time are the only items stored\n     * @param $option\n     * @return array\n     */\n    public function collectApptStatusSettings($option)\n    {\n        $color_settings = array();\n        $row = sqlQuery(\"SELECT notes FROM list_options WHERE \" .\n            \"list_id = 'apptstat' AND option_id = ? AND activity = 1\", array($option));\n        if (empty($row['notes'])) {\n            return $option;\n        }\n\n        list($color_settings['color'], $color_settings['time_alert']) = explode(\"|\", $row['notes']);\n        return $color_settings;\n    }\n\n    /**\n     * This is used to collect the tracker elements for the Patient Flow Board Report\n     * returns the elements in an array\n     * @param $trackerid\n     * @return mixed\n     */\n    public function collect_Tracker_Elements($trackerid)\n    {\n        $res = sqlStatement(\"SELECT * FROM patient_tracker_element WHERE pt_tracker_id = ? ORDER BY LENGTH(seq), seq \", array($trackerid));\n        for ($iter = 0; $row = sqlFetchArray($res); $iter++) {\n            $returnval[$iter] = $row;\n        }\n\n        return $returnval;\n    }\n\n    /**\n     * used to determine check in time\n     * @param $trackerid\n     * @return bool\n     */\n    public function collect_checkin($trackerid)\n    {\n        $tracker = sqlQuery(\n            \"SELECT patient_tracker_element.start_datetime \" .\n            \"FROM patient_tracker_element \" .\n            \"INNER JOIN list_options \" .\n            \"ON patient_tracker_element.status = list_options.option_id \" .\n            \"WHERE  list_options.list_id = 'apptstat' \" .\n            \"AND list_options.toggle_setting_1 = '1' AND list_options.activity = 1 \" .\n            \"AND patient_tracker_element.pt_tracker_id = ?\",\n            array($trackerid)\n        );\n        if (empty($tracker['start_datetime'])) {\n            return false;\n        } else {\n            return $tracker['start_datetime'];\n        }\n    }\n\n    /**\n     * used to determine check out time\n     * @param $trackerid\n     * @return bool\n     */\n    public function collect_checkout($trackerid)\n    {\n        $tracker = sqlQuery(\n            \"SELECT patient_tracker_element.start_datetime \" .\n            \"FROM patient_tracker_element \" .\n            \"INNER JOIN list_options \" .\n            \"ON patient_tracker_element.status = list_options.option_id \" .\n            \"WHERE  list_options.list_id = 'apptstat' \" .\n            \"AND list_options.toggle_setting_2 = '1' AND list_options.activity = 1 \" .\n            \"AND patient_tracker_element.pt_tracker_id = ?\",\n            array($trackerid)\n        );\n        if (empty($tracker['start_datetime'])) {\n            return false;\n        } else {\n            return $tracker['start_datetime'];\n        }\n    }\n\n    public function getApptStatus($appointments)\n    {\n        $astat = array();\n        $astat['count_all'] = count($appointments);\n        //group the appointment by status\n        foreach ($appointments as $appointment) {\n            $astat[$appointment['pc_apptstatus']] += 1;\n        }\n\n        return $astat;\n    }\n}\n"], "fixing_code": ["<?php\n\n/*\n * Payments can be edited here whch includes deletion of an allocation, modifying the\n * same or adding a new allocation. Log is kept for the deleted ones.\n * The functions of this class support the billing process like the script billing_process.php.\n *\n * @package   OpenEMR\n * @link      http://www.open-emr.org\n * @author    Eldho Chacko <eldho@zhservices.com>\n * @author    Paul Simon K <paul@zhservices.com>\n * @author    Stephen Waite <stephen.waite@cmsvt.com>\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @author    Rod Roark <rod@sunsetsystems.com>\n * @copyright Copyright (c) 2010 Z&H Consultancy Services Private Limited <sam@zhservices.com>\n * @copyright Copyright (C) 2018-2020 Stephen Waite <stephen.waite@cmsvt.com>\n * @copyright Copyright (c) 2019-2020 Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) 2020 Rod Roark <rod@sunsetsystems.com>\n * @license https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\n\nrequire_once(\"../globals.php\");\nrequire_once(\"$srcdir/auth.inc\");\nrequire_once(\"../../custom/code_types.inc.php\");\nrequire_once(\"$srcdir/patient.inc\");\nrequire_once(\"$srcdir/options.inc.php\");\nrequire_once(\"$srcdir/payment.inc.php\");\n\nuse OpenEMR\\Common\\Acl\\AclMain;\nuse OpenEMR\\Common\\Twig\\TwigContainer;\nuse OpenEMR\\Core\\Header;\n\nif (!AclMain::aclCheckCore('acct', 'bill', '', 'write') && !AclMain::aclCheckCore('acct', 'eob', '', 'write')) {\n    echo (new TwigContainer(null, $GLOBALS['kernel']))->getTwig()->render('core/unauthorized.html.twig', ['pageTitle' => xl(\"Confirm Payment\")]);\n    exit;\n}\n\n$screen = 'edit_payment';\n\n// Deletion of payment distribution code\n\nif (isset($_POST[\"mode\"])) {\n    if ($_POST[\"mode\"] == \"DeletePaymentDistribution\") {\n        $DeletePaymentDistributionId = (isset($_POST['DeletePaymentDistributionId']) ? trim($_POST['DeletePaymentDistributionId']) : '');\n        $DeletePaymentDistributionIdArray = explode('_', $DeletePaymentDistributionId);\n        $payment_id = $DeletePaymentDistributionIdArray[0];\n        $PId = $DeletePaymentDistributionIdArray[1];\n        $Encounter = $DeletePaymentDistributionIdArray[2];\n        $Code = $DeletePaymentDistributionIdArray[3];\n        $Modifier = $DeletePaymentDistributionIdArray[4];\n        $Codetype = $DeletePaymentDistributionIdArray[5];\n        //delete and log that action\n        row_modify(\n            \"ar_activity\",\n            \"deleted = NOW()\",\n            \"session_id = '\" . add_escape_custom($payment_id) . \"' AND \" .\n            \"pid = '\" . add_escape_custom($PId) . \"' AND \" .\n            \"deleted IS NULL AND \" .\n            \"encounter = '\" . add_escape_custom($Encounter) . \"' AND \" .\n            \"code_type = '\" . add_escape_custom($Codetype) . \"' AND \" .\n            \"code = '\" . add_escape_custom($Code) . \"' AND \" .\n            \"modifier='\" . add_escape_custom($Modifier) . \"'\"\n        );\n        $Message = 'Delete';\n        //------------------\n        $_POST[\"mode\"] = \"searchdatabase\";\n    }\n}\n\n//===============================================================================\n//Modify Payment Code.\n//===============================================================================\n\nif (isset($_POST[\"mode\"])) {\n    if ($_POST[\"mode\"] == \"ModifyPayments\" || $_POST[\"mode\"] == \"FinishPayments\") {\n        $payment_id = $_REQUEST['payment_id'];\n        //ar_session Code\n        //===============================================================================\n        if (trim($_POST['type_name']) == 'insurance') {\n            $QueryPart = \"payer_id = '\" . trim(formData('hidden_type_code')) .\n                \"', patient_id = '\" . 0;\n        } elseif (trim($_POST['type_name']) == 'patient') {\n            $QueryPart = \"payer_id = '\" . 0 .\n                \"', patient_id = '\" . trim(formData('hidden_type_code'));\n        }\n\n        $user_id = $_SESSION['authUserID'];\n        $closed = 0;\n        $modified_time = date('Y-m-d H:i:s');\n        $check_date = DateToYYYYMMDD(formData('check_date'));\n        $deposit_date = DateToYYYYMMDD(formData('deposit_date'));\n        $post_to_date = DateToYYYYMMDD(formData('post_to_date'));\n        if ($post_to_date == '') {\n            $post_to_date = date('Y-m-d');\n        }\n\n        if ($_POST['deposit_date'] == '') {\n            $deposit_date = $post_to_date;\n        }\n\n        $global_account = \"\";\n        if (formData('global_reset') == '-0.00') {\n            $global_account = \"', global_amount = '\" . trim(formData('global_reset'));\n        }\n\n        sqlStatement(\"update ar_session set \" .\n            $QueryPart .\n            \"', user_id = '\" . trim(add_escape_custom($user_id)) .\n            \"', closed = '\" . trim(add_escape_custom($closed)) .\n            \"', reference = '\" . trim(formData('check_number')) .\n            \"', check_date = '\" . trim(add_escape_custom($check_date)) .\n            \"', deposit_date = '\" . trim(add_escape_custom($deposit_date)) .\n            \"', pay_total = '\" . trim(formData('payment_amount')) .\n            \"', modified_time = '\" . trim(add_escape_custom($modified_time)) .\n            $global_account .\n            \"', payment_type = '\" . trim(formData('type_name')) .\n            \"', description = '\" . trim(formData('description')) .\n            \"', adjustment_code = '\" . trim(formData('adjustment_code')) .\n            \"', post_to_date = '\" . trim(add_escape_custom($post_to_date)) .\n            \"', payment_method = '\" . trim(formData('payment_method')) .\n            \"'    where session_id='\" . add_escape_custom($payment_id) . \"'\");\n        //===============================================================================\n        $CountIndexAbove = $_REQUEST['CountIndexAbove'];\n        $CountIndexBelow = $_REQUEST['CountIndexBelow'];\n        $hidden_patient_code = $_REQUEST['hidden_patient_code'];\n        $user_id = $_SESSION['authUserID'];\n        $created_time = date('Y-m-d H:i:s');\n        //==================================================================\n        //UPDATION\n        //It is done with out deleting any old entries.\n        //==================================================================\n        for ($CountRow = 1; $CountRow <= $CountIndexAbove; $CountRow++) {\n            if (isset($_POST[\"HiddenEncounter$CountRow\"])) {\n                $where1 = \"WHERE deleted IS NULL AND session_id = '\" . add_escape_custom($payment_id) .\n                    \"' AND pid ='\" . trim(formData(\"HiddenPId$CountRow\")) .\n                    \"' AND encounter = '\" . trim(formData(\"HiddenEncounter$CountRow\")) .\n                    \"' AND code_type = '\" . trim(formData(\"HiddenCodetype$CountRow\")) .\n                    \"' AND code = '\" . trim(formData(\"HiddenCode$CountRow\")) .\n                    \"' AND modifier = '\" . trim(formData(\"HiddenModifier$CountRow\")) .\n                    \"'\";\n\n                $where = \"$where1 AND pay_amount > 0\";\n                if (isset($_POST[\"Payment$CountRow\"]) && $_POST[\"Payment$CountRow\"] * 1 > 0) {\n                    if (trim($_POST['type_name']) == 'insurance') {\n                        if (trim($_POST[\"HiddenIns$CountRow\"]) == 1) {\n                            $AccountCode = \"IPP\";\n                        }\n                        if (trim($_POST[\"HiddenIns$CountRow\"]) == 2) {\n                            $AccountCode = \"ISP\";\n                        }\n                        if (trim($_POST[\"HiddenIns$CountRow\"]) == 3) {\n                            $AccountCode = \"ITP\";\n                        }\n                    } elseif (trim($_POST['type_name']) == 'patient') {\n                        $AccountCode = \"PP\";\n                    }\n                    $resPayment = sqlStatement(\"SELECT * from ar_activity $where\");\n                    if (sqlNumRows($resPayment) > 0) {\n                        sqlStatement(\"UPDATE ar_activity SET deleted = NOW() $where\");\n                    }\n                    sqlBeginTrans();\n                    $sequence_no = sqlQuery(\"SELECT IFNULL(MAX(sequence_no),0) + 1 AS increment \" .\n                        \"FROM ar_activity WHERE pid = '\" . trim(formData(\"HiddenPId$CountRow\")) .\n                        \"' AND encounter = '\" . trim(formData(\"HiddenEncounter$CountRow\")) . \"'\");\n                    sqlStatement(\"insert into ar_activity set \" .\n                        \"pid = '\" . trim(formData(\"HiddenPId$CountRow\")) .\n                        \"', encounter = '\" . trim(formData(\"HiddenEncounter$CountRow\")) .\n                        \"', sequence_no = '\" . add_escape_custom($sequence_no['increment']) .\n                        \"', code_type = '\" . trim(formData(\"HiddenCodetype$CountRow\")) .\n                        \"', code = '\" . trim(formData(\"HiddenCode$CountRow\")) .\n                        \"', modifier = '\" . trim(formData(\"HiddenModifier$CountRow\")) .\n                        \"', payer_type = '\" . trim(formData(\"HiddenIns$CountRow\")) .\n                        \"', reason_code = '\" . trim(formData(\"ReasonCode$CountRow\")) .\n                        \"', post_time = '\" . trim(add_escape_custom($created_time)) .\n                        \"', post_user = '\" . trim(add_escape_custom($user_id)) .\n                        \"', session_id = '\" . trim(formData('payment_id')) .\n                        \"', modified_time = '\" . trim(add_escape_custom($created_time)) .\n                        \"', pay_amount = '\" . trim(formData(\"Payment$CountRow\")) .\n                        \"', adj_amount = '\" . 0 .\n                        \"', account_code = '\" . add_escape_custom($AccountCode) .\n                        \"'\");\n                    sqlCommitTrans();\n                } else {\n                    sqlStatement(\"UPDATE ar_activity SET deleted = NOW() $where\");\n                }\n\n                //==============================================================================================================================\n\n                $where = \"$where1 AND adj_amount != 0\";\n                if (isset($_POST[\"AdjAmount$CountRow\"]) && floatval($_POST[\"AdjAmount$CountRow\"]) !== 0) {\n                    if (trim($_POST['type_name']) == 'insurance') {\n                        $AdjustString = \"Ins adjust Ins\" . trim($_POST[\"HiddenIns$CountRow\"]);\n                        $AccountCode = \"IA\";\n                    } elseif (trim($_POST['type_name']) == 'patient') {\n                        $AdjustString = \"Pt adjust\";\n                        $AccountCode = \"PA\";\n                    }\n                    $resPayment = sqlStatement(\"SELECT  * from ar_activity $where\");\n                    if (sqlNumRows($resPayment) > 0) {\n                        sqlStatement(\"update ar_activity set deleted = NOW() $where\");\n                    }\n                    sqlBeginTrans();\n                    $sequence_no = sqlQuery(\"SELECT IFNULL(MAX(sequence_no),0) + 1 AS increment FROM ar_activity WHERE pid = '\" . trim(formData(\"HiddenPId$CountRow\")) . \"' AND encounter = '\" . trim(formData(\"HiddenEncounter$CountRow\")) . \"'\");\n                    sqlStatement(\"insert into ar_activity set \" .\n                        \"pid = '\" . trim(formData(\"HiddenPId$CountRow\")) .\n                        \"', encounter = '\" . trim(formData(\"HiddenEncounter$CountRow\")) .\n                        \"', sequence_no = '\" . add_escape_custom($sequence_no['increment']) .\n                        \"', code_type = '\" . trim(formData(\"HiddenCodetype$CountRow\")) .\n                        \"', code = '\" . trim(formData(\"HiddenCode$CountRow\")) .\n                        \"', modifier = '\" . trim(formData(\"HiddenModifier$CountRow\")) .\n                        \"', payer_type = '\" . trim(formData(\"HiddenIns$CountRow\")) .\n                        \"', post_time = '\" . trim(add_escape_custom($created_time)) .\n                        \"', post_user = '\" . trim(add_escape_custom($user_id)) .\n                        \"', session_id = '\" . trim(formData('payment_id')) .\n                        \"', modified_time = '\" . trim(add_escape_custom($created_time)) .\n                        \"', pay_amount = '\" . 0 .\n                        \"', adj_amount = '\" . trim(formData(\"AdjAmount$CountRow\")) .\n                        \"', memo = '\" . add_escape_custom($AdjustString) .\n                        \"', account_code = '\" . add_escape_custom($AccountCode) .\n                        \"'\");\n                    sqlCommitTrans();\n                } else {\n                    sqlStatement(\"update ar_activity set deleted = NOW() $where\");\n                }\n\n                //==============================================================================================================================\n\n                $where = \"$where1 AND (memo LIKE 'Deductable%' OR memo LIKE 'Deductible%')\";\n                if (isset($_POST[\"Deductible$CountRow\"]) && $_POST[\"Deductible$CountRow\"] * 1 > 0) {\n                    $resPayment = sqlStatement(\"SELECT  * from ar_activity $where\");\n                    if (sqlNumRows($resPayment) > 0) {\n                        sqlStatement(\"update ar_activity set deleted = NOW() $where\");\n                    }\n                    sqlBeginTrans();\n                    $sequence_no = sqlQuery(\"SELECT IFNULL(MAX(sequence_no),0) + 1 AS increment FROM ar_activity WHERE pid = '\" . trim(formData(\"HiddenPId$CountRow\")) . \"' AND encounter = '\" . trim(formData(\"HiddenEncounter$CountRow\")) . \"'\");\n                    sqlStatement(\"insert into ar_activity set \" .\n                        \"pid = '\" . trim(formData(\"HiddenPId$CountRow\")) .\n                        \"', encounter = '\" . trim(formData(\"HiddenEncounter$CountRow\")) .\n                        \"', sequence_no = '\" . add_escape_custom($sequence_no['increment']) .\n                        \"', code_type = '\" . trim(formData(\"HiddenCodetype$CountRow\")) .\n                        \"', code = '\" . trim(formData(\"HiddenCode$CountRow\")) .\n                        \"', modifier = '\" . trim(formData(\"HiddenModifier$CountRow\")) .\n                        \"', payer_type = '\" . trim(formData(\"HiddenIns$CountRow\")) .\n                        \"', post_time = '\" . trim(add_escape_custom($created_time)) .\n                        \"', post_user = '\" . trim(add_escape_custom($user_id)) .\n                        \"', session_id = '\" . trim(formData('payment_id')) .\n                        \"', modified_time = '\" . trim(add_escape_custom($created_time)) .\n                        \"', pay_amount = '\" . 0 .\n                        \"', adj_amount = '\" . 0 .\n                        \"', memo = '\" . \"Deductible $\" . trim(formData(\"Deductible$CountRow\")) .\n                        \"', account_code = '\" . \"Deduct\" .\n                        \"'\");\n                    sqlCommitTrans();\n                } else {\n                    sqlStatement(\"delete from ar_activity $where\");\n                }\n\n                //==============================================================================================================================\n\n                $where = \"$where1 AND pay_amount < 0\";\n                if (isset($_POST[\"Takeback$CountRow\"]) && $_POST[\"Takeback$CountRow\"] * 1 > 0) {\n                    $resPayment = sqlStatement(\"SELECT  * from ar_activity $where\");\n                    if (sqlNumRows($resPayment) > 0) {\n                        sqlStatement(\"update ar_activity set deleted = NOW() $where\");\n                    }\n                    sqlBeginTrans();\n                    $sequence_no = sqlQuery(\"SELECT IFNULL(MAX(sequence_no),0) + 1 AS increment FROM ar_activity WHERE pid = '\" . trim(formData(\"HiddenPId$CountRow\")) . \"' AND encounter = '\" . trim(formData(\"HiddenEncounter$CountRow\")) . \"'\");\n                    sqlStatement(\"insert into ar_activity set \" .\n                        \"pid = '\" . trim(formData(\"HiddenPId$CountRow\")) .\n                        \"', encounter = '\" . trim(formData(\"HiddenEncounter$CountRow\")) .\n                        \"', sequence_no = '\" . add_escape_custom($sequence_no['increment']) .\n                        \"', code_type = '\" . trim(formData(\"HiddenCodetype$CountRow\")) .\n                        \"', code = '\" . trim(formData(\"HiddenCode$CountRow\")) .\n                        \"', modifier = '\" . trim(formData(\"HiddenModifier$CountRow\")) .\n                        \"', payer_type = '\" . trim(formData(\"HiddenIns$CountRow\")) .\n                        \"', post_time = '\" . trim(add_escape_custom($created_time)) .\n                        \"', post_user = '\" . trim(add_escape_custom($user_id)) .\n                        \"', session_id = '\" . trim(formData('payment_id')) .\n                        \"', modified_time = '\" . trim(add_escape_custom($created_time)) .\n                        \"', pay_amount = '\" . trim(formData(\"Takeback$CountRow\")) * -1 .\n                        \"', adj_amount = '\" . 0 .\n                        \"', account_code = '\" . \"Takeback\" .\n                        \"'\");\n                    sqlCommitTrans();\n                } else {\n                    sqlStatement(\"delete from ar_activity $where\");\n                }\n\n                //==============================================================================================================================\n\n                $where = \"$where1 AND follow_up = 'y'\";\n                if (isset($_POST[\"FollowUp$CountRow\"]) && $_POST[\"FollowUp$CountRow\"] == 'y') {\n                    $resPayment = sqlStatement(\"SELECT  * from ar_activity $where\");\n                    if (sqlNumRows($resPayment) > 0) {\n                        sqlStatement(\"update ar_activity set deleted = NOW() $where\");\n                    }\n                    sqlBeginTrans();\n                    $sequence_no = sqlQuery(\"SELECT IFNULL(MAX(sequence_no),0) + 1 AS increment FROM ar_activity WHERE pid = '\" . trim(formData(\"HiddenPId$CountRow\")) . \"' AND encounter = '\" . trim(formData(\"HiddenEncounter$CountRow\")) . \"'\");\n                    sqlStatement(\"insert into ar_activity set \" .\n                        \"pid = '\" . trim(formData(\"HiddenPId$CountRow\")) .\n                        \"', encounter = '\" . trim(formData(\"HiddenEncounter$CountRow\")) .\n                        \"', sequence_no = '\" . add_escape_custom($sequence_no['increment']) .\n                        \"', code_type = '\" . trim(formData(\"HiddenCodetype$CountRow\")) .\n                        \"', code = '\" . trim(formData(\"HiddenCode$CountRow\")) .\n                        \"', modifier = '\" . trim(formData(\"HiddenModifier$CountRow\")) .\n                        \"', payer_type = '\" . trim(formData(\"HiddenIns$CountRow\")) .\n                        \"', post_time = '\" . trim(add_escape_custom($created_time)) .\n                        \"', post_user = '\" . trim(add_escape_custom($user_id)) .\n                        \"', session_id = '\" . trim(formData('payment_id')) .\n                        \"', modified_time = '\" . trim(add_escape_custom($created_time)) .\n                        \"', pay_amount = '\" . 0 .\n                        \"', adj_amount = '\" . 0 .\n                        \"', follow_up = '\" . \"y\" .\n                        \"', follow_up_note = '\" . trim(formData(\"FollowUpReason$CountRow\")) .\n                        \"'\");\n                    sqlCommitTrans();\n                } else {\n                    sqlStatement(\"delete from ar_activity $where\");\n                }\n\n                //==============================================================================================================================\n            } else {\n                break;\n            }\n        }\n\n        //=========\n        //INSERTION of new entries,continuation of modification.\n        //=========\n        for ($CountRow = $CountIndexAbove + 1; $CountRow <= $CountIndexAbove + $CountIndexBelow; $CountRow++) {\n            if (isset($_POST[\"HiddenEncounter$CountRow\"])) {\n                DistributionInsert($CountRow, $created_time, $user_id);\n            } else {\n                break;\n            }\n        }\n\n        if ($_REQUEST['global_amount'] == 'yes') {\n            sqlStatement(\"update ar_session set global_amount=? where session_id =?\", [(isset($_POST[\"HidUnappliedAmount\"]) ? trim($_POST[\"HidUnappliedAmount\"]) * 1 : ''), $payment_id]);\n        } elseif ($_REQUEST['global_reset'] == '-0.00') {\n            sqlStatement(\"update ar_session set global_amount=? where session_id =?\", [0, $payment_id]);\n        }\n\n        if ($_POST[\"mode\"] == \"FinishPayments\") {\n            $Message = 'Finish';\n        }\n\n        $_POST[\"mode\"] = \"searchdatabase\";\n        $Message = 'Modify';\n    }\n}\n\n//==============================================================================\n//Search Code\n//===============================================================================\n$payment_id = ($payment_id ?? null) * 1 > 0 ? $payment_id : $_REQUEST['payment_id'];\n$ResultSearchSub = sqlStatement(\n    \"SELECT DISTINCT encounter, code_type, code, modifier, pid \" .\n    \"FROM ar_activity WHERE deleted IS NULL AND session_id = ? \" .\n    \"ORDER BY pid, encounter, code, modifier\",\n    [$payment_id]\n);\n\n//==============================================================================\n\n//==============================================================================\n//===============================================================================\n?>\n<!DOCTYPE html>\n<html>\n<head>\n    <title><?php echo xlt('Confirm Payment'); ?></title>\n    <?php Header::setupHeader(['datetime-picker', 'common']); ?>\n\n    <script>\n    const mypcc = '1';\n    </script>\n    <?php include_once(\"{$GLOBALS['srcdir']}/payment_jav.inc.php\"); ?>\n    <?php include_once(\"{$GLOBALS['srcdir']}/ajax/payment_ajax_jav.inc.php\"); ?>\n    <script>\n        function ModifyPayments() {//Used while modifying the allocation\n            if (!FormValidations())//FormValidations contains the form checks\n            {\n                return false;\n            }\n            if (CompletlyBlankAbove())//The distribution rows already in the database are checked.\n            {\n                alert(<?php echo xlj('None of the Top Distribution Row Can be Completly Blank.'); ?> +\"\\n\" + <?php echo xlj('Use Delete Option to Remove.'); ?>);\n                return false;\n            }\n    if (!CheckPayingEntityAndDistributionPostFor()) {\n        //Ensures that Insurance payment is distributed under Ins1,Ins2,Ins3 and Patient paymentat under Pat.\n                return false;\n            }\n    if (CompletlyBlankBelow()) {\n        //The newly added distribution rows are checked.\n                alert(<?php echo xlj('Fill any of the Below Row.'); ?>);\n                return false;\n            }\n    let PostValue = CheckUnappliedAmount();//Decides TdUnappliedAmount >0, or <0 or =0\n            if (PostValue == 1) {\n                alert(<?php echo xlj('Cannot Modify Payments.Undistributed is Negative.'); ?>);\n                return false;\n            }\n            dialog.confirm(<?php echo xlj('Would you like to Modify Payments?'); ?>).then(returned => {\n                if (returned === true) {\n                    document.getElementById('mode').value = 'ModifyPayments';\n                    top.restoreSession();\n                    document.forms[0].submit();\n                } else {\n                    dialog.close();\n                    return false;\n                }\n            });\n        }\n\n        function FinishPayments() {\n            if (!FormValidations())//FormValidations contains the form checks\n            {\n                return false;\n            }\n            if (CompletlyBlankAbove())//The distribution rows already in the database are checked.\n            {\n                alert(<?php echo xlj('None of the Top Distribution Row Can be Completly Blank.'); ?> +\"\\n\" + <?php echo xlj('Use Delete Option to Remove.'); ?>);\n                return false;\n            }\n            if (!CheckPayingEntityAndDistributionPostFor())//Ensures that Insurance payment is distributed under Ins1,Ins2,Ins3 and Patient paymentat under Pat.\n            {\n                return false;\n            }\n            if (CompletlyBlankBelow())//The newly added distribution rows are checked.\n            {\n                alert(<?php echo xlj('Fill any of the Below Row.'); ?>);\n                return false;\n            }\n    let PostValue = CheckUnappliedAmount();//Decides TdUnappliedAmount >0, or <0 or =0\n            if (PostValue == 1) {\n                alert(<?php echo xlj('Cannot Modify Payments.Undistributed is Negative.'); ?>);\n                return false;\n            }\n            if (PostValue == 2) {\n                if (confirm(<?php echo xlj('Would you like to Modify and Finish Payments?'); ?>)) {\n                    UnappliedAmount = document.getElementById('TdUnappliedAmount').innerHTML * 1;\n                    if (confirm(<?php echo xlj('Undistributed is'); ?> +' ' + UnappliedAmount + '.' + '\\n' + <?php echo xlj('Would you like the balance amount to apply to Global Account?'); ?>)) {\n                        document.getElementById('mode').value = 'FinishPayments';\n                        document.getElementById('global_amount').value = 'yes';\n                        top.restoreSession();\n                        document.forms[0].submit();\n                    } else {\n                        document.getElementById('mode').value = 'FinishPayments';\n                        top.restoreSession();\n                        document.forms[0].submit();\n                    }\n                } else\n                    return false;\n            } else {\n                if (confirm(<?php echo xlj('Would you like to Modify and Finish Payments?'); ?>)) {\n                    document.getElementById('mode').value = 'FinishPayments';\n                    top.restoreSession();\n                    document.forms[0].submit();\n                } else\n                    return false;\n            }\n\n        }\n\n        function CompletlyBlankAbove() {//The distribution rows already in the database are checked.\n            //It is not allowed to be made completly empty.If needed delete option need to be used.\n    let CountIndexAbove = document.getElementById('CountIndexAbove').value * 1;\n            for (RowCount = 1; RowCount <= CountIndexAbove; RowCount++) {\n                if (document.getElementById('Allowed' + RowCount).value == '' && document.getElementById('Payment' + RowCount).value == '' && document.getElementById('AdjAmount' + RowCount).value == '' && document.getElementById('Deductible' + RowCount).value == '' && document.getElementById('Takeback' + RowCount).value == '' && document.getElementById('FollowUp' + RowCount).checked == false) {\n                    return true;\n                }\n            }\n            return false;\n        }\n\n        function CompletlyBlankBelow() {//The newly added distribution rows are checked.\n            //It is not allowed to be made completly empty.\n    let CountIndexAbove = document.getElementById('CountIndexAbove').value * 1;\n    let CountIndexBelow = document.getElementById('CountIndexBelow').value * 1;\n            if (CountIndexBelow == 0)\n                return false;\n            for (RowCount = CountIndexAbove + 1; RowCount <= CountIndexAbove + CountIndexBelow; RowCount++) {\n                if (document.getElementById('Allowed' + RowCount).value == '' && document.getElementById('Payment' + RowCount).value == '' && document.getElementById('AdjAmount' + RowCount).value == '' && document.getElementById('Deductible' + RowCount).value == '' && document.getElementById('Takeback' + RowCount).value == '' && document.getElementById('FollowUp' + RowCount).checked == false) {\n\n                } else\n                    return false;\n            }\n            return true;\n        }\n\n        function OnloadAction() {//Displays message while loading after some action.\n    let after_value = document.getElementById('ActionStatus').value;\n            if (after_value == 'Delete') {\n                alert(<?php echo xlj('Successfully Deleted'); ?>);\n                return true;\n            }\n            if (after_value == 'Modify' || after_value == 'Finish') {\n                alert(<?php echo xlj('Successfully Modified'); ?>);\n                return true;\n            }\n            after_value = document.getElementById('after_value').value;\n    let payment_id = document.getElementById('payment_id').value;\n            if (after_value == 'distribute') {\n            } else if (after_value == 'new_payment') {\n                if (document.getElementById('TablePatientPortion')) {\n                    document.getElementById('TablePatientPortion').style.display = 'none';\n                }\n                if (confirm(<?php echo xlj('Successfully Saved.Would you like to Distribute?'); ?>)) {\n                    if (document.getElementById('TablePatientPortion')) {\n                        document.getElementById('TablePatientPortion').style.display = '';\n                    }\n                }\n            }\n\n        }\n\n        function DeletePaymentDistribution(DeleteId) {//Confirms deletion of payment distribution.\n            if (confirm(<?php echo xlj('Would you like to Delete Payment Distribution?'); ?>)) {\n                document.getElementById('mode').value = 'DeletePaymentDistribution';\n                document.getElementById('DeletePaymentDistributionId').value = DeleteId;\n                top.restoreSession();\n                document.forms[0].submit();\n            } else\n                return false;\n        }\n\n        //========================================================================================\n\n        $(function () {\n            $('.datepicker').datetimepicker({\n                <?php $datetimepicker_timepicker = false; ?>\n                <?php $datetimepicker_showseconds = false; ?>\n                <?php $datetimepicker_formatInput = true; ?>\n                <?php require($GLOBALS['srcdir'] . '/js/xl/jquery-datetimepicker-2-5-4.js.php'); ?>\n                <?php // can add any additional javascript settings to datetimepicker here; need to prepend first setting with a comma ?>\n            });\n        });\n\n        document.onclick = HideTheAjaxDivs;\n    </script>\n    <style>\n        .amt_input {\n            max-width: 75px;\n        }\n        .bottom {\n            border-bottom: 1px solid var(--black);\n        }\n\n        .top {\n            border-top: 1px solid var(--black);\n        }\n\n        .left {\n            border-left: 1px solid var(--black);\n        }\n\n        .right {\n            border-right: 1px solid var(--black);\n        }\n\n        .form-group {\n            margin-bottom: 5px;\n        }\n\n        legend {\n            border-bottom: 2px solid #E5E5E5;\n            background: #E5E5E5;\n            padding-left: 10px;\n        }\n\n        .form-horizontal .control-label {\n            padding-top: 2px;\n        }\n\n        fieldset {\n            border-color: #68171A !important;\n            background-color: #f2f2f2;\n            margin-bottom: 10px;\n            padding-bottom: 15px;\n        }\n\n        @media only screen and (max-width: 768px) {\n            [class*=\"col-\"] {\n                width: 100%;\n                text-align: left !important;\n            }\n        }\n    </style>\n    <?php Header::setupHeader(['datetime-picker', 'common']); ?>\n</head>\n<body class=\"body_top\" onload=\"OnloadAction()\">\n    <div class=\"container-fluid\">\n        <?php\n        if ($_REQUEST['ParentPage'] ?? '' == 'new_payment') {\n            ?>\n            <div class=\"row\">\n                <div class=\"col-12\">\n                    <h2><?php echo xlt('Payments'); ?></h2>\n                </div>\n            </div>\n            <div class=\"row\">\n                <div class=\"col-sm-12\">\n                    <nav class=\"navbar navbar-nav navbar-expand-md navbar-light text-body bg-light static-top\">\n                        <button class=\"navbar-toggler icon-bar\" data-target=\"#myNavbar\" data-toggle=\"collapse\" type=\"button\"><span class=\"navbar-toggler-icon\"></span></button>\n                        <div class=\"collapse navbar-collapse\" id=\"myNavbar\">\n                            <ul class=\"navbar-nav mr-auto\">\n                                <li class=\"nav-item active\">\n                                    <a class=\"nav-link font-weight-bold\" href='new_payment.php'><?php echo xlt('New Payment'); ?></a>\n                                </li>\n                                <li class=\"nav-item\">\n                                    <a class=\"nav-link font-weight-bold\" href='search_payments.php'><?php echo xlt('Search Payment'); ?></a>\n                                </li>\n                                <li class=\"nav-item\">\n                                    <a class=\"nav-link font-weight-bold\" href='era_payments.php'><?php echo xlt('ERA Posting'); ?></a>\n                                </li>\n                            </ul>\n                        </div>\n                    </nav>\n                </div>\n            </div>\n            <?php\n        }\n        ?>\n        <?php\n        if ($payment_id * 1 == 0) {\n            $onclick = \"top.restoreSession();return SavePayment();\";\n        } else {\n            $onclick = \"return false;\";\n        }\n        ?>\n        <form class=\"form\" name='new_payment' method='post' action=\"edit_payment.php\" onsubmit='<?php echo $onclick; ?>'>\n            <?php\n            if ($payment_id * 1 > 0) { ?>\n            <fieldset>\n                <?php\n                require_once(\"payment_master.inc.php\");  //Check/cash details are entered here.\n                ?>\n                <?php }//End of if($payment_id*1>0) ?>\n                <?php\n                if ($payment_id * 1 > 0) {//Distribution rows already in the database are displayed.\n                    ?>\n                    <?php //\n                    $resCount = sqlStatement(\n                        \"SELECT DISTINCT encounter, code_type, code, modifier FROM ar_activity \" .\n                        \"WHERE deleted IS NULL AND session_id = ?\",\n                        [$payment_id]\n                    );\n                    $TotalRows = sqlNumRows($resCount);\n                    $CountPatient = 0;\n                    $CountIndex = 0;\n                    $CountIndexAbove = 0;\n                    $paymenttot = 0;\n                    $adjamttot = 0;\n                    $deductibletot = 0;\n                    $takebacktot = 0;\n                    $allowedtot = 0;\n                    if ($RowSearchSub = sqlFetchArray($ResultSearchSub)) {\n                        do {\n                            $CountPatient++;\n                            $PId = $RowSearchSub['pid'];\n                            $EncounterMaster = $RowSearchSub['encounter'];\n                            // Only use the code_type in the queries below if it is specified in the ar_activity table.\n                            // If it is not specified in the ar_activity table, also note it is not requested from the\n                            // billing table in below query, thus making it blank in all queries below in this script.\n                            $CodetypeMaster = $RowSearchSub['code_type'];\n                            $sql_select_part_codetype = \"\";\n                            $sql_where_part_codetype = \"\";\n                            if (!empty($CodetypeMaster)) {\n                                $sql_select_part_codetype = \"billing.code_type,\";\n                                $sql_where_part_codetype = \"and billing.code_type ='\" . add_escape_custom($CodetypeMaster) . \"'\";\n                            }\n                            $CodeMaster = $RowSearchSub['code'];\n                            $ModifierMaster = $RowSearchSub['modifier'];\n                            $res = sqlStatement(\"SELECT fname,lname,mname FROM patient_data where pid =?\", [$PId]);\n                            $row = sqlFetchArray($res);\n                            $fname = $row['fname'];\n                            $lname = $row['lname'];\n                            $mname = $row['mname'];\n                            $NameDB = $lname . ' ' . $fname . ' ' . $mname;\n                            $ResultSearch = sqlStatement(\"SELECT billing.id,last_level_closed,billing.encounter,form_encounter.`date`,$sql_select_part_codetype billing.code,billing.modifier,fee\n                             FROM billing ,form_encounter\n                             where billing.encounter=form_encounter.encounter and billing.pid=form_encounter.pid and\n                             code_type !='ICD9' and  code_type !='COPAY' and billing.activity !=0 and\n                             form_encounter.pid ='\" . add_escape_custom($PId) . \"' and billing.pid ='\" . add_escape_custom($PId) . \"' and billing.encounter ='\" . add_escape_custom($EncounterMaster) . \"'\n                             $sql_where_part_codetype\n                             and billing.code ='\" . add_escape_custom($CodeMaster) . \"'\n                             and billing.modifier ='\" . add_escape_custom($ModifierMaster) . \"'\n                             ORDER BY form_encounter.`date`,form_encounter.encounter,billing.code,billing.modifier\");\n                            if (sqlNumRows($ResultSearch) > 0) {\n                                if ($CountPatient === 1) {\n                                    $Table = 'yes';\n                                    ?>\n                                    <br /><br />\n                                    <div class=\"row\" id=\"tableRow\">\n                                    <legend><?php echo xlt(\"Distributed Edits\") ?></legend>\n                                    <div class=\"table-responsive-lg\">\n                                    <table class=\"table table-sm table-bordered table-light\" id=\"TableDistributedEdit\" >\n                                    <thead class=\"bg-dark text-light\">\n                                    <tr>\n                                        <th>&nbsp;</th>\n                                        <th><?php echo xlt('Patient Name'); ?></th>\n                                        <th><?php echo xlt('Post For'); ?></th>\n                                        <th><?php echo xlt('Service Date'); ?></th>\n                                        <th><?php echo xlt('Enc#'); ?></th>\n                                        <th><?php echo xlt('Code'); ?></th>\n                                        <th><?php echo xlt('Charge'); ?></th>\n                                        <th><?php echo xlt('Copay'); ?></th>\n                                        <th><?php echo xlt('Bal-Due'); ?></th>\n                                        <th><?php echo xlt('Allowed(c)'); ?></th><!-- (c) means it is calculated.Not stored one. -->\n                                        <th><?php echo xlt('Payment'); ?></th>\n                                        <th><?php echo xlt('Adj Amount'); ?></th>\n                                        <th><?php echo xlt('Deductible'); ?></th>\n                                        <th><?php echo xlt('Takeback'); ?></th>\n                                        <th><?php echo xlt('MSP'); ?></th>\n                                        <th><?php echo xlt('Resn'); ?></th>\n                                        <th><?php echo xlt('Follow Up Reason'); ?></th>\n                                    </tr>\n                                    </thead>\n                                <?php }\n                                while ($RowSearch = sqlFetchArray($ResultSearch)) {\n                                    $CountIndex++;\n                                    $CountIndexAbove++;\n                                    $ServiceDateArray = explode(' ', $RowSearch['date']);\n                                    $ServiceDate = oeFormatShortDate($ServiceDateArray[0]);\n                                    $Codetype = $RowSearch['code_type'];\n                                    $Code = $RowSearch['code'];\n                                    $Modifier = $RowSearch['modifier'];\n                                    if ($Modifier != '') {\n                                        $ModifierString = \", $Modifier\";\n                                    } else {\n                                        $ModifierString = \"\";\n                                    }\n                                    $Fee = $RowSearch['fee'];\n                                    $Encounter = $RowSearch['encounter'];\n\n                                    $resPayer = sqlStatement(\n                                        \"SELECT payer_type FROM ar_activity WHERE \" .\n                                        \"deleted IS NULL AND session_id = ? AND pid = ? AND encounter = ? \" .\n                                        \"AND code_type = ? AND code = ? AND modifier = ?\",\n                                        [$payment_id, $PId, $Encounter, $Codetype, $Code, $Modifier]\n                                    );\n                                    $rowPayer = sqlFetchArray($resPayer);\n                                    $Ins = $rowPayer['payer_type'];\n\n                                    //Always associating the copay to a particular charge.\n                                    $BillingId = $RowSearch['id'];\n                                    $resId = sqlStatement(\"SELECT id FROM billing where code_type != 'ICD9' and code_type != 'COPAY' and\n                                    pid =? and encounter =? and billing.activity!=0 order by id\", [$PId, $Encounter]);\n                                    $rowId = sqlFetchArray($resId);\n                                    $Id = $rowId['id'];\n\n                                    if ($BillingId != $Id) {//multiple cpt in single encounter\n                                        $Copay = 0.00;\n                                    } else {\n                                        $resCopay = sqlStatement(\"SELECT sum(fee) as copay FROM billing where\n                                    code_type='COPAY' and pid =? and encounter =? and billing.activity!=0\", [$PId, $Encounter]);\n                                        $rowCopay = sqlFetchArray($resCopay);\n                                        $Copay = $rowCopay['copay'] * -1;\n\n                                        $resMoneyGot = sqlStatement(\n                                            \"SELECT sum(pay_amount) AS PatientPay FROM ar_activity WHERE \" .\n                                            \"deleted IS NULL AND pid = ? and encounter = ? AND \" .\n                                            \"payer_type = 0 AND account_code = 'PCP'\",\n                                            [$PId, $Encounter]\n                                        ); //new fees screen copay gives account_code='PCP'\n                                        $rowMoneyGot = sqlFetchArray($resMoneyGot);\n                                        $PatientPay = $rowMoneyGot['PatientPay'];\n\n                                        $Copay = $Copay + $PatientPay;\n                                    }\n\n                                    //For calculating Remainder\n                                    if ($Ins == 0) {//Fetch all values\n                                        $resMoneyGot = sqlStatement(\n                                            \"SELECT sum(pay_amount) as MoneyGot FROM ar_activity WHERE \" .\n                                            \"deleted IS NULL AND pid = ? and code_type = ? AND code = ? AND \" .\n                                            \"modifier = ? AND encounter = ? AND \" .\n                                            \"!(payer_type = 0 AND account_code = 'PCP')\",\n                                            [$PId, $Codetype, $Code, $Modifier, $Encounter]\n                                        );\n                                        //new fees screen copay gives account_code='PCP'\n                                        $rowMoneyGot = sqlFetchArray($resMoneyGot);\n                                        $MoneyGot = $rowMoneyGot['MoneyGot'];\n\n                                        $resMoneyAdjusted = sqlStatement(\n                                            \"SELECT sum(adj_amount) AS MoneyAdjusted FROM ar_activity WHERE \" .\n                                            \"deleted IS NULL AND pid = ? and code_type = ? and code = ? AND \" .\n                                            \"modifier = ? AND encounter = ?\",\n                                            [$PId, $Codetype, $Code, $Modifier, $Encounter]\n                                        );\n                                        $rowMoneyAdjusted = sqlFetchArray($resMoneyAdjusted);\n                                        $MoneyAdjusted = $rowMoneyAdjusted['MoneyAdjusted'];\n                                    } else {\n                                        //Fetch till that much got\n                                        //Fetch the HIGHEST sequence_no till this session.\n                                        //Used maily in  the case if primary/others pays once more.\n                                        $resSequence = sqlStatement(\"SELECT sequence_no from ar_activity where session_id=? and\n                                    pid=? and encounter=? order by sequence_no desc \", [$payment_id, $PId, $Encounter]);\n                                        $rowSequence = sqlFetchArray($resSequence);\n                                        $Sequence = $rowSequence['sequence_no'];\n\n                                        $resMoneyGot = sqlStatement(\n                                            \"SELECT sum(pay_amount) as MoneyGot FROM ar_activity WHERE \" .\n                                            \"deleted IS NULL AND pid = ? and code_type = ? AND code = ? AND \" .\n                                            \"modifier = ? and encounter = ? AND \" .\n                                            \"payer_type > 0 and payer_type <= ? and sequence_no <= ?\",\n                                            [$PId, $Codetype, $Code, $Modifier, $Encounter, $Ins, $Sequence]\n                                        );\n                                        $rowMoneyGot = sqlFetchArray($resMoneyGot);\n                                        $MoneyGot = $rowMoneyGot['MoneyGot'];\n\n                                        $resMoneyAdjusted = sqlStatement(\n                                            \"SELECT sum(adj_amount) AS MoneyAdjusted FROM ar_activity WHERE \" .\n                                            \"deleted IS NULL AND pid = ? and code_type = ? and code = ? AND \" .\n                                            \"modifier = ? AND encounter = ? AND payer_type > 0 AND \" .\n                                            \"payer_type <= ? and sequence_no <= ?\",\n                                            [$PId, $Codetype, $Code, $Modifier, $Encounter, $Ins, $Sequence]\n                                        );\n                                        $rowMoneyAdjusted = sqlFetchArray($resMoneyAdjusted);\n                                        $MoneyAdjusted = $rowMoneyAdjusted['MoneyAdjusted'];\n                                    }\n                                    $Remainder = $Fee - $Copay - $MoneyGot - $MoneyAdjusted;\n                                    //For calculating RemainderJS.Used while restoring back the values.\n                                    if ($Ins == 0) {//Got just before Patient\n                                        $resMoneyGot = sqlStatement(\n                                            \"SELECT sum(pay_amount) AS MoneyGot FROM ar_activity WHERE \" .\n                                            \"deleted IS NULL AND pid = ? AND code_type = ? AND code = ? AND \" .\n                                            \"modifier = ? AND encounter = ? and payer_type != 0\",\n                                            [$PId, $Codetype, $Code, $Modifier, $Encounter]\n                                        );\n                                        $rowMoneyGot = sqlFetchArray($resMoneyGot);\n                                        $MoneyGot = $rowMoneyGot['MoneyGot'];\n\n                                        $resMoneyAdjusted = sqlStatement(\n                                            \"SELECT sum(adj_amount) AS MoneyAdjusted FROM ar_activity WHERE \" .\n                                            \"deleted IS NULL AND pid = ? AND code_type = ? AND code = ? AND \" .\n                                            \"modifier = ? and encounter = ? and payer_type != 0\",\n                                            [$PId, $Codetype, $Code, $Modifier, $Encounter]\n                                        );\n                                        $rowMoneyAdjusted = sqlFetchArray($resMoneyAdjusted);\n                                        $MoneyAdjusted = $rowMoneyAdjusted['MoneyAdjusted'];\n                                    } else {\n                                        //Got just before the previous\n                                        //Fetch the LOWEST sequence_no till this session.\n                                        //Used maily in  the case if primary/others pays once more.\n                                        $resSequence = sqlStatement(\n                                            \"SELECT sequence_no FROM ar_activity WHERE \" .\n                                            \"session_id = ? AND deleted IS NULL AND pid = ? AND encounter = ? \" .\n                                            \"order by sequence_no\",\n                                            [$payment_id, $PId, $Encounter]\n                                        );\n                                        $rowSequence = sqlFetchArray($resSequence);\n                                        $Sequence = $rowSequence['sequence_no'];\n\n                                        $resMoneyGot = sqlStatement(\n                                            \"SELECT sum(pay_amount) as MoneyGot FROM ar_activity WHERE \" .\n                                            \"deleted IS NULL AND pid = ? AND code_type = ? AND code = ? \" .\n                                            \"AND modifier = ? AND encounter = ? AND payer_type > 0 AND \" .\n                                            \"payer_type <= ? AND sequence_no < ?\",\n                                            [$PId, $Codetype, $Code, $Modifier, $Encounter, $Ins, $Sequence]\n                                        );\n                                        $rowMoneyGot = sqlFetchArray($resMoneyGot);\n                                        $MoneyGot = $rowMoneyGot['MoneyGot'];\n\n                                        $resMoneyAdjusted = sqlStatement(\n                                            \"SELECT sum(adj_amount) as MoneyAdjusted FROM ar_activity WHERE \" .\n                                            \"deleted IS NULL AND pid = ? and code_type = ? and code = ? AND \" .\n                                            \"modifier = ? AND encounter = ? AND payer_type <= ? AND sequence_no < ?\",\n                                            [$PId, $Codetype, $Code, $Modifier, $Encounter, $Ins, $Sequence]\n                                        );\n                                        $rowMoneyAdjusted = sqlFetchArray($resMoneyAdjusted);\n                                        $MoneyAdjusted = $rowMoneyAdjusted['MoneyAdjusted'];\n                                    }\n                                    //Stored in hidden so that can be used while restoring back the values.\n                                    $RemainderJS = $Fee - $Copay - $MoneyGot - $MoneyAdjusted;\n\n                                    $resPayment = sqlStatement(\n                                        \"SELECT pay_amount FROM ar_activity WHERE \" .\n                                        \"deleted IS NULL AND session_id=? AND pid = ? AND encounter = ? AND \" .\n                                        \"code_type = ? AND code = ? AND modifier = ? AND pay_amount > 0\",\n                                        [$payment_id, $PId, $Encounter, $Codetype, $Code, $Modifier]\n                                    );\n                                    $rowPayment = sqlFetchArray($resPayment);\n                                    $PaymentDB = $rowPayment['pay_amount'] ?? null * 1;\n                                    $PaymentDB = $PaymentDB == 0 ? '' : $PaymentDB;\n\n                                    $resPayment = sqlStatement(\n                                        \"SELECT pay_amount FROM ar_activity WHERE \" .\n                                        \"deleted IS NULL AND session_id = ? AND pid = ? AND encounter = ? AND \" .\n                                        \"code_type = ? AND code = ? AND modifier = ? AND pay_amount < 0\",\n                                        [$payment_id, $PId, $Encounter, $Codetype, $Code, $Modifier]\n                                    );\n                                    $rowPayment = sqlFetchArray($resPayment);\n                                    $TakebackDB = ($rowPayment['pay_amount'] ?? null) * -1;\n                                    $TakebackDB = $TakebackDB == 0 ? '' : $TakebackDB;\n\n                                    $resPayment = sqlStatement(\n                                        \"SELECT adj_amount FROM ar_activity WHERE \" .\n                                        \"deleted IS NULL AND session_id = ? AND pid = ? AND encounter = ? AND \" .\n                                        \"code_type = ? AND code = ? AND modifier = ? AND adj_amount != 0\",\n                                        [$payment_id, $PId, $Encounter, $Codetype, $Code, $Modifier]\n                                    );\n                                    $rowPayment = sqlFetchArray($resPayment);\n                                    $AdjAmountDB = $rowPayment['adj_amount'] * 1;\n                                    $AdjAmountDB = $AdjAmountDB == 0 ? '' : $AdjAmountDB;\n\n                                    $resPayment = sqlStatement(\n                                        \"SELECT memo FROM ar_activity WHERE \" .\n                                        \"deleted IS NULL AND session_id = ? AND pid = ? AND encounter = ? AND \" .\n                                        \"code_type = ? AND code = ? AND modifier = ? AND \" .\n                                        \"(memo LIKE 'Deductable%' OR memo LIKE 'Deductible%')\",\n                                        [$payment_id, $PId, $Encounter, $Codetype, $Code, $Modifier]\n                                    );\n                                    $rowPayment = sqlFetchArray($resPayment);\n                                    $DeductibleDB = $rowPayment['memo'] ?? '';\n                                    $DeductibleDB = str_replace('Deductable $', '', $DeductibleDB);\n                                    $DeductibleDB = str_replace('Deductible $', '', $DeductibleDB);\n\n                                    $resPayment = sqlStatement(\n                                        \"SELECT follow_up, follow_up_note FROM ar_activity WHERE \" .\n                                        \"deleted IS NULL AND session_id = ? AND pid = ? AND encounter = ? AND \" .\n                                        \"code_type = ? AND code = ? AND modifier = ? AND follow_up = 'y'\",\n                                        [$payment_id, $PId, $Encounter, $Codetype, $Code, $Modifier]\n                                    );\n                                    $rowPayment = sqlFetchArray($resPayment);\n                                    $FollowUpDB = $rowPayment['follow_up'] ?? '';\n                                    $FollowUpReasonDB = $rowPayment['follow_up_note'] ?? '';\n\n                                    $resPayment = sqlStatement(\n                                        \"SELECT reason_code FROM ar_activity WHERE \" .\n                                        \"deleted IS NULL AND session_id = ? AND pid = ? AND encounter = ? AND \" .\n                                        \"code_type = ? AND code = ? AND modifier = ?\",\n                                        [$payment_id, $PId, $Encounter, $Codetype, $Code, $Modifier]\n                                    );\n                                    $rowPayment = sqlFetchArray($resPayment);\n                                    $ReasonCodeDB = $rowPayment['reason_code'];\n\n                                    if ($Ins == 1) {\n                                        $AllowedDB = number_format($Fee - floatval($AdjAmountDB), 2);\n                                    } else {\n                                        $AllowedDB = 0;\n                                    }\n                                    $AllowedDB = $AllowedDB === 0 ? '' : $AllowedDB;\n\n                                    if ($Ins == 1) {\n                                        $bgcolor = '#ddddff';\n                                    } elseif ($Ins == 2) {\n                                        $bgcolor = '#ffdddd';\n                                    } elseif ($Ins == 3) {\n                                        $bgcolor = '#F2F1BC';\n                                    } elseif ($Ins == 0) {\n                                        $bgcolor = '#AAFFFF';\n                                    }\n                                    $paymenttot = $paymenttot + floatval($PaymentDB);\n                                    $adjamttot = $adjamttot + floatval($AdjAmountDB);\n                                    $deductibletot = $deductibletot + floatval($DeductibleDB);\n                                    $takebacktot = $takebacktot + floatval($TakebackDB);\n                                    $allowedtot = $allowedtot + floatval($AllowedDB);\n                                    ?>\n\n                                <tr class=\"border-dark\" bgcolor='<?php echo attr($bgcolor); ?>' class=\"text\" id=\"trCharges<?php echo attr($CountIndex); ?>\">\n                                    <td align=\"left\">\n                                        <a href=\"#\" onclick=\"javascript:return DeletePaymentDistribution(<?php echo attr_js($payment_id . '_' . $PId . '_' . $Encounter . '_' . $Code . '_' . $Modifier . '_' . $Codetype); ?>);\"><img border=\"0\" src=\"../pic/Delete.gif\"></a>\n                                    </td>\n                                    <td align=\"left\">\n                                        <?php echo text($NameDB); ?><input name=\"HiddenPId<?php echo attr($CountIndex); ?>\" type=\"hidden\" value=\"<?php echo attr($PId); ?>\" />\n                                    </td>\n                                    <td align=\"left\">\n                                        <input id=\"HiddenIns<?php echo attr($CountIndex); ?>\" name=\"HiddenIns<?php echo attr($CountIndex); ?>\" type=\"hidden\" value=\"<?php echo attr($Ins); ?>\" /><?php echo generate_select_list(\"payment_ins$CountIndex\", \"payment_ins\", \"$Ins\", \"Insurance/Patient\", '', 'w-100', 'ActionOnInsPat(\"' . $CountIndex . '\")'); ?>\n                                    </td>\n                                    <td>\n                                        <?php echo text($ServiceDate); ?>\n                                    </td>\n                                    <td align=\"right\">\n                                        <input name=\"HiddenEncounter<?php echo attr($CountIndex); ?>\" type=\"hidden\" value=\"<?php echo attr($Encounter); ?>\" /><?php echo text($Encounter); ?>\n                                    </td>\n                                    <td>\n                                        <input name=\"HiddenCodetype<?php echo attr($CountIndex); ?>\" type=\"hidden\" value=\"<?php echo attr($Codetype); ?>\" />\n                                        <input name=\"HiddenCode<?php echo attr($CountIndex); ?>\" type=\"hidden\" value=\"<?php echo attr($Code); ?>\" /><?php echo text($Codetype . \"-\" . $Code . $ModifierString); ?>\n                                        <input name=\"HiddenModifier<?php echo attr($CountIndex); ?>\" type=\"hidden\" value=\"<?php echo attr($Modifier); ?>\" />\n                                    </td>\n                                    <td align=\"right\">\n                                        <input id=\"HiddenChargeAmount<?php echo attr($CountIndex); ?>\" name=\"HiddenChargeAmount<?php echo attr($CountIndex); ?>\" type=\"hidden\" value=\"<?php echo attr($Fee); ?>\" /><?php echo text($Fee); ?>\n                                    </td>\n                                    <td align=\"right\">\n                                        <input id=\"HiddenCopayAmount<?php echo attr($CountIndex); ?>\" name=\"HiddenCopayAmount<?php echo attr($CountIndex); ?>\" type=\"hidden\" value=\"<?php echo attr($Copay); ?>\"><?php echo text(number_format($Copay, 2)); ?>\n                                    </td>\n                                    <td align=\"right\" id=\"RemainderTd<?php echo attr($CountIndex); ?>\"> <?php echo text(round($Remainder, 2)); ?> </td>\n                                    <input name=\"HiddenRemainderTd<?php echo attr($CountIndex); ?>\" id=\"HiddenRemainderTd<?php echo attr($CountIndex); ?>\" value=\"<?php echo attr(round($Remainder, 2)); ?>\" type=\"hidden\" />\n                                    <td>\n                                        <input autocomplete=\"off\" id=\"Allowed<?php echo attr($CountIndex); ?>\" name=\"Allowed<?php echo attr($CountIndex); ?>\" onchange=\"ValidateNumeric(this);ScreenAdjustment(this,<?php echo attr_js($CountIndex); ?>);UpdateTotalValues(1,<?php echo attr_js($TotalRows); ?>,'Allowed','allowtotal');UpdateTotalValues(1,<?php echo attr_js($TotalRows); ?>,'Payment','paymenttotal');UpdateTotalValues(1,<?php echo attr_js($TotalRows); ?>,'AdjAmount','AdjAmounttotal');RestoreValues(<?php echo attr_js($CountIndex); ?>)\" onkeydown=\"PreventIt(event)\"  class=\"text-right input-sm w-100\" type=\"text\" value=\"<?php echo attr($AllowedDB); ?>\" />\n                                    </td>\n\n                                    <td>\n                                        <input autocomplete=\"off\" id=\"Payment<?php echo attr($CountIndex); ?>\" name=\"Payment<?php echo attr($CountIndex); ?>\" onchange=\"ValidateNumeric(this);ScreenAdjustment(this,<?php echo attr_js($CountIndex); ?>);UpdateTotalValues(1,<?php echo attr_js($TotalRows); ?>,'Payment','paymenttotal');RestoreValues(<?php echo attr_js($CountIndex); ?>)\" onkeydown=\"PreventIt(event)\"  class=\"text-right  input-sm w-100\" type=\"text\" value=\"<?php echo attr($PaymentDB); ?>\" />\n                                    </td>\n                                    <td>\n                                        <input autocomplete=\"off\" id=\"AdjAmount<?php echo attr($CountIndex); ?>\" name=\"AdjAmount<?php echo attr($CountIndex); ?>\" onchange=\"ValidateNumeric(this);ScreenAdjustment(this,<?php echo attr_js($CountIndex); ?>);UpdateTotalValues(1,<?php echo attr_js($TotalRows); ?>,'AdjAmount','AdjAmounttotal');RestoreValues(<?php echo attr_js($CountIndex); ?>)\" onkeydown=\"PreventIt(event)\"  class=\"text-right  input-sm w-100\" type=\"text\" value=\"<?php echo attr($AdjAmountDB); ?>\" />\n                                    </td>\n                                    <td>\n                                        <input autocomplete=\"off\" id=\"Deductible<?php echo attr($CountIndex); ?>\" name=\"Deductible<?php echo attr($CountIndex); ?>\" onchange=\"ValidateNumeric(this);UpdateTotalValues(1,<?php echo attr_js($TotalRows); ?>,'Deductible','deductibletotal');\" onkeydown=\"PreventIt(event)\"  class=\"text-right  input-sm w-100\" type=\"text\" value=\"<?php echo attr($DeductibleDB); ?>\" />\n                                    </td>\n                                    <td>\n                                        <input autocomplete=\"off\" id=\"Takeback<?php echo attr($CountIndex); ?>\" name=\"Takeback<?php echo attr($CountIndex); ?>\" onchange=\"ValidateNumeric(this);ScreenAdjustment(this,<?php echo attr_js($CountIndex); ?>);UpdateTotalValues(1,<?php echo attr_js($TotalRows); ?>,'Takeback','takebacktotal');RestoreValues(<?php echo attr_js($CountIndex); ?>)\" onkeydown=\"PreventIt(event)\"  class=\"text-right  input-sm w-100\" type=\"text\" value=\"<?php echo attr($TakebackDB); ?>\" />\n                                    </td>\n                                    <td align=\"left\">\n                                        <input id=\"HiddenReasonCode<?php echo attr($CountIndex); ?>\" name=\"HiddenReasonCode<?php echo attr($CountIndex); ?>\" type=\"hidden\" value=\"<?php echo attr($ReasonCodeDB); ?>\" /><?php echo generate_select_list(\"ReasonCode$CountIndex\", \"msp_remit_codes\", \"$ReasonCodeDB\", \"MSP\", '', 'w-100'); ?>\n                                    </td>\n                                    <td align=\"center\">\n                                        <input id=\"FollowUp<?php echo attr($CountIndex); ?>\" name=\"FollowUp<?php echo attr($CountIndex); ?>\" onclick=\"ActionFollowUp(<?php echo attr_js($CountIndex); ?>)\" type=\"checkbox\" value=\"y\" />\n                                    </td>\n                                    <td>\n                                        <input id=\"FollowUpReason<?php echo attr($CountIndex); ?>\" name=\"FollowUpReason<?php echo attr($CountIndex); ?>\" onkeydown=\"PreventIt(event)\" class=\" input-sm w-100\" type=\"text\" value=\"<?php echo attr($FollowUpReasonDB); ?>\" readonly>\n                                    </td>\n                                    </tr><?php\n                                }//End of while ($RowSearch = sqlFetchArray($ResultSearch))\n                                ?>\n                                <?php\n                            }//End of if(sqlNumRows($ResultSearch)>0)\n                        } while ($RowSearchSub = sqlFetchArray($ResultSearchSub));\n                        if ($Table == 'yes') { ?>\n                            <tr>\n                                <td class=\"text-right text-dark\" align=\"left\" colspan=\"9\"><b><?php echo (xlt(\"Totals\") . \": \") ?></b></td>\n                                <td class=\"bg-dark text-secondary\" align=\"center\" id=\"allowtotal\"><?php echo text(number_format($allowedtot, 2)); ?></td>\n                                <td class=\"bg-dark text-secondary\" align=\"center\" id=\"paymenttotal\"><?php echo text(number_format($paymenttot, 2)); ?></td>\n                                <td class=\"bg-dark text-secondary\" align=\"center\" id=\"AdjAmounttotal\"><?php echo text(number_format($adjamttot, 2)); ?></td>\n                                <td class=\"bg-dark text-secondary\" align=\"center\" id=\"deductibletotal\"><?php echo text(number_format($deductibletot, 2)); ?></td>\n                                <td class=\"bg-dark text-secondary\" align=\"center\" id=\"takebacktotal\"><?php echo text(number_format($takebacktot, 2)); ?></td>\n                                <td align=\"center\" colspan=\"2\">&nbsp;</td>\n                                <td align=\"right\">\n                                    <button type=\"button\" class=\"btn btn-sm btn-secondary btn-refresh pull-right\"\n                                        onclick=\"updateAllFormTotals(<?php echo attr_js($TotalRows); ?>);\"><?php echo xlt(\"Recalculate\"); ?></button>\n                                </td>\n                            </tr>\n                            </table>\n                            <?php\n                        }\n                        ?>\n                        <?php\n                        echo '<br/>';\n                    }//End of if($RowSearchSub = sqlFetchArray($ResultSearchSub))\n                    ?>\n                    </div>\n                    </div>\n                    <div>\n                        <?php\n                        require_once(\"payment_pat_sel.inc.php\"); //Patient ajax section and listing of charges.\n                        ?>\n                    </div>\n                    <?php\n                }//End of if($payment_id*1>0)\n                ?>\n                <?php //can change position of buttons by creating a class 'position-override' and adding rule text-align:center or right as the case may be in individual stylesheets ?>\n                <div class=\"form-group clearfix\">\n                    <div class=\"col-sm-12 text-left position-override\">\n                        <div class=\"btn-group\" role=\"group\">\n                            <a class=\"btn btn-secondary btn-save\" href=\"#\" onclick=\"return ModifyPayments();\"><span><?php echo xlt('Modify Payments'); ?></span></a>\n                            <a class=\"btn btn-secondary btn-save\" href=\"#\" onclick=\"return FinishPayments();\"><span><?php echo xlt('Finish Payments'); ?></span></a>\n                        </div>\n                    </div>\n                </div>\n                <div class=\"row\">\n                    <input type=\"hidden\" name=\"hidden_patient_code\" id=\"hidden_patient_code\" value=\"<?php echo attr($hidden_patient_code ?? ''); ?>\" />\n                    <input type='hidden' name='mode' id='mode' value='' />\n                    <input type='hidden' name='ajax_mode' id='ajax_mode' value='' />\n                    <input type=\"hidden\" name=\"after_value\" id=\"after_value\" value=\"<?php echo attr($_POST[\"mode\"] ?? ''); ?>\" />\n                    <input type=\"hidden\" name=\"payment_id\" id=\"payment_id\" value=\"<?php echo attr($payment_id); ?>\" />\n                    <input type=\"hidden\" name=\"hidden_type_code\" id=\"hidden_type_code\" value=\"<?php echo attr($TypeCode); ?>\" />\n                    <input type='hidden' name='global_amount' id='global_amount' value='' />\n                    <input type='hidden' name='DeletePaymentDistributionId' id='DeletePaymentDistributionId' value='' />\n                    <input type=\"hidden\" name=\"ActionStatus\" id=\"ActionStatus\" value=\"<?php echo attr($Message ?? ''); ?>\" />\n                    <input type='hidden' name='CountIndexAbove' id='CountIndexAbove' value='<?php echo attr($CountIndexAbove * 1); ?>' />\n                    <input type='hidden' name='CountIndexBelow' id='CountIndexBelow' value='<?php echo attr($CountIndexBelow * 1); ?>' />\n                    <input type=\"hidden\" name=\"ParentPage\" id=\"ParentPage\" value=\"<?php echo attr($_REQUEST['ParentPage'] ?? ''); ?>\" />\n                </div>\n        </form>\n    </div><!-- End of container div-->\n    <script>\n        function ResetForm() {//Resets form used in the 'Cancel Changes' button in the master screen.\n            document.forms[0].reset();\n            document.getElementById('TdUnappliedAmount').innerHTML = '0.00';\n            document.getElementById('div_insurance_or_patient').innerHTML = '&nbsp;';\n            CheckVisible('yes');//Payment Method is made 'Check Payment' and the Check box is made visible.\n            PayingEntityAction();//Paying Entity is made 'insurance' and Payment Category is 'Insurance Payment'\n        }\n\n        $(function () {\n            if (document.getElementById(\"TableDistributePortion\")) {\n                $(\"html\").animate({scrollTop: $(\"#TableDistributePortion\").offset().top}, 800);\n            } else if (document.getElementById(\"TableDistributedEdit\")) {\n                $(\"html\").animate({scrollTop: $(\"#TableDistributedEdit\").offset().top}, 800);\n            }\n        });\n    </script>\n</body>\n</html>\n", "<?php\n\n/**\n * Patient Tracker (Patient Flow Board)\n *\n * This program displays the information entered in the Calendar program ,\n * allowing the user to change status and view those changed here and in the Calendar\n * Will allow the collection of length of time spent in each status\n *\n * @package OpenEMR\n * @link    http://www.open-emr.org\n * @author  Terry Hill <terry@lilysystems.com>\n * @author  Brady Miller <brady.g.miller@gmail.com>\n * @author  Ray Magauran <magauran@medexbank.com>\n * @copyright Copyright (c) 2015-2017 Terry Hill <terry@lillysystems.com>\n * @copyright Copyright (c) 2017-2021 Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) 2017 Ray Magauran <magauran@medexbank.com>\n * @license https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\nrequire_once \"../globals.php\";\nrequire_once \"$srcdir/patient.inc\";\nrequire_once \"$srcdir/options.inc.php\";\nrequire_once \"$srcdir/patient_tracker.inc.php\";\nrequire_once \"$srcdir/user.inc\";\nrequire_once \"$srcdir/MedEx/API.php\";\n\nuse OpenEMR\\Common\\Csrf\\CsrfUtils;\nuse OpenEMR\\Core\\Header;\n\nif (!empty($_POST)) {\n    if (!CsrfUtils::verifyCsrfToken($_POST[\"csrf_token_form\"])) {\n        CsrfUtils::csrfNotVerified();\n    }\n}\n\n// These settings are sticky user preferences linked to a given page.\n// mdsupport - user_settings prefix\n$uspfx = substr(__FILE__, strlen($webserver_root)) . '.';\n$setting_new_window = prevSetting($uspfx, 'setting_new_window', 'setting_new_window', ' ');\n// flow board and recall board share bootstrap settings:\n$setting_bootstrap_submenu = prevSetting('', 'setting_bootstrap_submenu', 'setting_bootstrap_submenu', ' ');\n$setting_selectors = prevSetting($uspfx, 'setting_selectors', 'setting_selectors', 'block');\n$form_apptcat = prevSetting($uspfx, 'form_apptcat', 'form_apptcat', '');\n$form_apptstatus = prevSetting($uspfx, 'form_apptstatus', 'form_apptstatus', '');\n$facility = prevSetting($uspfx, 'form_facility', 'form_facility', '');\n$provider = prevSetting($uspfx, 'form_provider', 'form_provider', $_SESSION['authUserID']);\n\nif (\n    ($_POST['setting_new_window'] ?? '') ||\n    ($_POST['setting_bootstrap_submenu'] ?? '') ||\n    ($_POST['setting_selectors'] ?? '')\n) {\n    // These are not form elements. We only ever change them via ajax, so exit now.\n    exit();\n}\nif (($_POST['saveCALLback'] ?? '') == \"Save\") {\n    $sqlINSERT = \"INSERT INTO medex_outgoing (msg_pc_eid,msg_pid,campaign_uid,msg_type,msg_reply,msg_extra_text)\n                  VALUES\n                (?,?,?,'NOTES','CALLED',?)\";\n    sqlQuery($sqlINSERT, array($_POST['pc_eid'], $_POST['pc_pid'], $_POST['campaign_uid'], $_POST['txtCALLback']));\n}\n\n//set default start date of flow board to value based on globals\nif (!$GLOBALS['ptkr_date_range']) {\n    $from_date = date('Y-m-d');\n} elseif (!is_null($_REQUEST['form_from_date'] ?? null)) {\n    $from_date = DateToYYYYMMDD($_REQUEST['form_from_date']);\n} elseif (($GLOBALS['ptkr_start_date']) == 'D0') {\n    $from_date = date('Y-m-d');\n} elseif (($GLOBALS['ptkr_start_date']) == 'B0') {\n    if (date(w) == GLOBALS['first_day_week']) {\n        //today is the first day of the week\n        $from_date = date('Y-m-d');\n    } elseif ($GLOBALS['first_day_week'] == 0) {\n        //Sunday\n        $from_date = date('Y-m-d', strtotime('previous sunday'));\n    } elseif ($GLOBALS['first_day_week'] == 1) {\n        //Monday\n        $from_date = date('Y-m-d', strtotime('previous monday'));\n    } elseif ($GLOBALS['first_day_week'] == 6) {\n        //Saturday\n        $from_date = date('Y-m-d', strtotime('previous saturday'));\n    }\n} else {\n    //shouldnt be able to get here...\n    $from_date = date('Y-m-d');\n}\n\n//set default end date of flow board to value based on globals\nif ($GLOBALS['ptkr_date_range']) {\n    if (substr($GLOBALS['ptkr_end_date'], 0, 1) == 'Y') {\n        $ptkr_time = substr($GLOBALS['ptkr_end_date'], 1, 1);\n        $ptkr_future_time = mktime(0, 0, 0, date('m'), date('d'), date('Y') + $ptkr_time);\n    } elseif (substr($GLOBALS['ptkr_end_date'], 0, 1) == 'M') {\n        $ptkr_time = substr($GLOBALS['ptkr_end_date'], 1, 1);\n        $ptkr_future_time = mktime(0, 0, 0, date('m') + $ptkr_time, date('d'), date('Y'));\n    } elseif (substr($GLOBALS['ptkr_end_date'], 0, 1) == 'D') {\n        $ptkr_time = substr($GLOBALS['ptkr_end_date'], 1, 1);\n        $ptkr_future_time = mktime(0, 0, 0, date('m'), date('d') + $ptkr_time, date('Y'));\n    }\n\n    $to_date = date('Y-m-d', $ptkr_future_time);\n    $to_date = !is_null($_REQUEST['form_to_date'] ?? null) ? DateToYYYYMMDD($_REQUEST['form_to_date']) : $to_date;\n} else {\n    $to_date = date('Y-m-d');\n}\n\n$form_patient_name = !is_null($_POST['form_patient_name'] ?? null) ? $_POST['form_patient_name'] : null;\n$form_patient_id = !is_null($_POST['form_patient_id'] ?? null) ? $_POST['form_patient_id'] : null;\n\n\n$lres = sqlStatement(\"SELECT option_id, title FROM list_options WHERE list_id = ? AND activity=1\", array('apptstat'));\nwhile ($lrow = sqlFetchArray($lres)) {\n    // if exists, remove the legend character\n    if ($lrow['title'][1] == ' ') {\n        $splitTitle = explode(' ', $lrow['title']);\n        array_shift($splitTitle);\n        $title = implode(' ', $splitTitle);\n    } else {\n        $title = $lrow['title'];\n    }\n    $statuses_list[$lrow['option_id']] = $title;\n}\n\nif ($GLOBALS['medex_enable'] == '1') {\n    $query2 = \"SELECT * FROM medex_icons\";\n    $iconed = sqlStatement($query2);\n    while ($icon = sqlFetchArray($iconed)) {\n        $icons[$icon['msg_type']][$icon['msg_status']]['html'] = $icon['i_html'];\n    }\n    $MedEx = new MedExApi\\MedEx('MedExBank.com');\n    $sql = \"SELECT * FROM medex_prefs LIMIT 1\";\n    $preferences = sqlStatement($sql);\n    $prefs = sqlFetchArray($preferences);\n    $results = json_decode($prefs['status'], true);\n    $logged_in = $results;\n    $logged_in = $results;\n    if (!empty($logged_in['token'])) {\n        $current_events = xlt(\"On-line\");\n    } else {\n        $current_events = xlt(\"Currently off-line\");\n    }\n}\n\nif (!($_REQUEST['flb_table'] ?? null)) {\n    ?>\n<html>\n<head>\n    <meta name=\"author\" content=\"OpenEMR: MedExBank\" />\n    <?php Header::setupHeader(['datetime-picker', 'opener']); ?>\n    <title><?php echo xlt('Flow Board'); ?></title>\n    <script>\n        <?php require_once \"$srcdir/restoreSession.php\"; ?>\n    </script>\n\n    <?php if ($_SESSION['language_direction'] == \"rtl\") { ?>\n      <link rel=\"stylesheet\" href=\"<?php echo $GLOBALS['themes_static_relative']; ?>/misc/rtl_bootstrap_navbar.css?v=<?php echo $GLOBALS['v_js_includes']; ?>\" />\n    <?php } else { ?>\n      <link rel=\"stylesheet\" href=\"<?php echo $GLOBALS['themes_static_relative']; ?>/misc/bootstrap_navbar.css?v=<?php echo $GLOBALS['v_js_includes']; ?>\" />\n    <?php } ?>\n\n    <script src=\"<?php echo $GLOBALS['web_root']; ?>/interface/main/messages/js/reminder_appts.js?v=<?php echo $v_js_includes; ?>\"></script>\n</head>\n\n<body>\n    <?php\n    if (($GLOBALS['medex_enable'] == '1') && (empty($_REQUEST['nomenu']))) {\n        $logged_in = $MedEx->login();\n        $MedEx->display->navigation($logged_in);\n    }\n    ?>\n    <div class=\"container mt-3\">\n        <div id=\"flb_selectors\" style=\"display:<?php echo attr($setting_selectors); ?>;\">\n            <h2 class=\"text-center\"><?php echo xlt('Flow Board'); ?></h2>\n            <div class=\"jumbotron p-4\">\n                <div class=\"showRFlow text-center\" id=\"show_flows\" name=\"kiosk_hide\">\n                    <div name=\"div_response\" id=\"div_response\" class=\"nodisplay\"></div>\n                        <form name=\"flb\" id=\"flb\" method=\"post\">\n                        <div class=\"row\">\n                          <input type=\"hidden\" name=\"csrf_token_form\" value=\"<?php echo attr(CsrfUtils::collectCsrfToken()); ?>\" />\n                            <div class=\"text-center col-4 align-items-center\">\n                              <!-- Visit Categories Section -->\n                              <div class=\"col-sm\">\n                                <select id=\"form_apptcat\" name=\"form_apptcat\" class=\"form-control form-control-sm\" onchange=\"refineMe('apptcat');\">\n                                  <?php\n                                    $categories = fetchAppointmentCategories();\n                                    echo \"<option value=''>\" . xlt(\"Visit Categories\") . \"</option>\";\n                                    while ($cat = sqlFetchArray($categories)) {\n                                        echo \"<option value='\" . attr($cat['id']) . \"'\";\n                                        if ($cat['id'] == ($_POST['form_apptcat'] ?? null)) {\n                                            echo \" selected='true' \";\n                                        }\n                                        echo \">\" . xlt($cat['category']) . \"</option>\";\n                                    }\n                                    ?>\n                                </select>\n                              </div>\n                              <!-- Visit Status Section -->\n                              <div class=\"col-sm\">\n                                <select id=\"form_apptstatus\" name=\"form_apptstatus\" class=\"form-control form-control-sm\" onchange=\"refineMe();\">\n                                  <option value=\"\"><?php echo xlt(\"Visit Status\"); ?></option>\n                                  <?php\n                                    $apptstats = sqlStatement(\"SELECT * FROM list_options WHERE list_id = 'apptstat' AND activity = 1 ORDER BY seq\");\n                                    while ($apptstat = sqlFetchArray($apptstats)) {\n                                        echo \"<option value='\" . attr($apptstat['option_id']) . \"'\";\n                                        if ($apptstat['option_id'] == ($_POST['form_apptstatus'] ?? null)) {\n                                            echo \" selected='true' \";\n                                        }\n                                        echo \">\" . xlt($apptstat['title']) . \"</option>\";\n                                    }\n                                    ?>\n                                </select>\n                              </div>\n                              <!-- Facility Section -->\n                              <div class=\"col-sm\">\n                                  <select class=\"form-control form-control-sm\" id=\"form_facility\" name=\"form_facility\"\n                                      <?php\n                                        $fac_sql = sqlStatement(\"SELECT * FROM facility ORDER BY id\");\n                                        while ($fac = sqlFetchArray($fac_sql)) {\n                                            $true = ($fac['id'] == ($_POST['form_facility'] ?? null)) ? \"selected=true\" : '';\n                                            ($select_facs ?? null) ? $select_facs : $select_facs = '';\n                                            $select_facs .= \"<option value=\" . attr($fac['id']) . \" \" . $true . \">\" . text($fac['name']) . \"</option>\\n\";\n                                            ($count ?? null) ? $count_facs : $count_facs = 0;\n                                            $count_facs++;\n                                        }\n                                        if ($count_facs < '1') {\n                                            echo \"disabled\";\n                                        }\n                                        ?> onchange=\"refineMe('facility');\">\n                                      <option value=\"\"><?php echo xlt('All Facilities'); ?></option>\n                                      <?php echo $select_facs; ?>\n                                  </select>\n                              </div>\n\n                              <?php\n                              // Build a drop-down list of ACTIVE providers.\n                                $query = \"SELECT id, lname, fname FROM users WHERE \" .\n                                  \"authorized = 1  AND active = 1 AND username > '' ORDER BY lname, fname\"; #(CHEMED) facility filter\n                                $ures = sqlStatement($query);\n                                while ($urow = sqlFetchArray($ures)) {\n                                    $provid = $urow['id'];\n                                    ($select_provs ?? null) ? $select_provs : $select_provs = '';\n                                    $select_provs .= \"    <option value='\" . attr($provid) . \"'\";\n                                    if (isset($_POST['form_provider']) && $provid == $_POST['form_provider']) {\n                                        $select_provs .= \" selected\";\n                                    } elseif (!isset($_POST['form_provider']) && $_SESSION['userauthorized'] && $provid == $_SESSION['authUserID']) {\n                                        $select_provs .= \" selected\";\n                                    }\n                                    $select_provs .= \">\" . text($urow['lname']) . \", \" . text($urow['fname']) . \"\\n\";\n                                    ($count_provs ?? null) ? $count_provs : $count_provs = 0;\n                                    $count_provs++;\n                                }\n                                ?>\n                              <!-- Provider Section -->\n                              <div class=\"col-sm\">\n                                  <select class=\"form-control form-control-sm\" id=\"form_provider\" name=\"form_provider\" <?php\n                                    if ($count_provs < '2') {\n                                        echo \"disabled\";\n                                    }\n                                    ?> onchange=\"refineMe('provider');\">\n                                      <option value=\"\" selected><?php echo xlt('All Providers'); ?></option>\n\n                                      <?php\n                                        echo $select_provs;\n                                        ?>\n                                  </select>\n                              </div>\n                            </div>\n                              <?php\n                                if ($GLOBALS['ptkr_date_range'] == '1') {\n                                    $type = 'date';\n                                    $style = '';\n                                } else {\n                                    $type = 'hidden';\n                                    $style = 'display:none;';\n                                } ?>\n                            <div class=\"col-4 mt-3 nowrap row\" style=\"<?php echo $style; ?>\">\n\n                              <label class=\"col-form-label col-sm-3 text-right\" for=\"flow_from\"><?php echo xlt('From'); ?>:</label>\n                              <div class=\"col-sm-9\">\n                                <input type=\"text\" id=\"form_from_date\" name=\"form_from_date\" class=\"datepicker form-control form-control-sm text-center\" value=\"<?php echo attr(oeFormatShortDate($from_date)); ?>\"/>\n                              </div>\n                              <label class=\"col-form-label col-sm-3 text-right\" for=\"flow_to\"><?php echo xlt('To{{Range}}'); ?>:</label>\n                              <div class=\"col-sm-9\">\n                                  <input type=\"text\" id=\"form_to_date\" name=\"form_to_date\" class=\"datepicker form-control form-control-sm text-center\" value=\"<?php echo attr(oeFormatShortDate($to_date)); ?>\"/>\n                              </div>\n\n                              <div class=\"col-sm-12 mt-3 mx-auto\">\n                                  <button id=\"filter_submit\" class=\"btn btn-primary btn-sm btn-filter\"><?php echo xlt('Filter'); ?></button>\n                                  <input type=\"hidden\" id=\"kiosk\" name=\"kiosk\" value=\"<?php echo attr($_REQUEST['kiosk'] ?? ''); ?>\" />\n                              </div>\n                            </div>\n                            <div class=\"col-4 mt-3 row\">\n                                <div class=\"col-sm-12 text-center\">\n                                    <!-- Patient Name Section -->\n                                      <input type=\"text\" placeholder=\"<?php echo xla('Patient Name'); ?>\" class=\"form-control form-control-sm\" id=\"form_patient_name\" name=\"form_patient_name\" value=\"<?php echo ($form_patient_name) ? attr($form_patient_name) : \"\"; ?>\" onKeyUp=\"refineMe();\" />\n                                </div>\n                                <div class=\"col-sm-12 text-center\">\n                                        <!-- Patient ID Section -->\n                                            <input placeholder=\"<?php echo xla('Patient ID'); ?>\" class=\"form-control form-control-sm\" type=\"text\" id=\"form_patient_id\" name=\"form_patient_id\" value=\"<?php echo ($form_patient_id) ? attr($form_patient_id) : \"\"; ?>\" onKeyUp=\"refineMe();\" />\n                                </div>\n                                <div class=\"col-sm-12 mx-auto\">\n                                    <div class=\"text-center pt-3 mx-auto\">\n\n                                        <?php if ($GLOBALS['medex_enable'] == '1') { ?>\n                                          <b>MedEx:</b>\n                                                <a href=\"https://medexbank.com/cart/upload/index.php?route=information/campaigns&amp;g=rem\"\n                                                   target=\"_medex\">\n                                                    <?php echo $current_events; ?>\n                                                </a>\n                                          <?php } ?>\n                                    </div>\n                                </div>\n                            </div>\n                            <div id=\"message\" class=\"warning\"></div>\n                        </div>\n                    </form>\n                </div>\n            </div>\n        </div>\n    <div class=\"row-fluid\">\n        <div class=\"col-md-12\">\n            <div class=\"text-center row mx-auto divTable\">\n                <div class=\"col-sm-12\" id=\"loader\">\n                    <div class=\"spinner-border\" role=\"status\">\n                        <span class=\"sr-only\"><?php echo xlt('Loading data'); ?>...</span>\n                    </div>\n                    <h2><?php echo xlt('Loading data'); ?>...</h2>\n                </div>\n                <div id=\"flb_table\" name=\"flb_table\" class=\"w-100\">\n            <?php\n} else {\n    //end of if !$_REQUEST['flb_table'] - this is the table we fetch via ajax during a refreshMe() call\n    // get all appts for date range and refine view client side.  very fast...\n    $appointments = array();\n    $datetime = date(\"Y-m-d H:i:s\");\n    $appointments = fetch_Patient_Tracker_Events($from_date, $to_date, '', '', '', '', $form_patient_name, $form_patient_id);\n    $appointments = sortAppointments($appointments, 'date', 'time');\n    //grouping of the count of every status\n    $appointments_status = getApptStatus($appointments);\n\n    $chk_prov = array();  // list of providers with appointments\n    // Scan appointments for additional info\n    foreach ($appointments as $apt) {\n        $chk_prov[$apt['uprovider_id']] = $apt['ulname'] . ', ' . $apt['ufname'] . ' ' . $apt['umname'];\n    }\n    ?>\n                <div class=\"col-sm-12 text-center m-1\">\n                <div class=\" d-sm-block\">\n                    <span id=\"status_summary\">\n                        <?php\n                        $statuses_output = \"<span class='text badge badge-light'><em>\" . xlt('Total patients') . ':</em> ' . text($appointments_status['count_all']) . \"</span>\";\n                        unset($appointments_status['count_all']);\n                        foreach ($appointments_status as $status_symbol => $count) {\n                            $statuses_output .= \" | <span><em>\" . text(xl_list_label($statuses_list[$status_symbol])) . \":</em> <span class='badge badge-light'>\" . text($count) . \"</span></span>\";\n                        }\n                        echo $statuses_output;\n                        ?>\n                    </span>\n                </div>\n                <div id=\"pull_kiosk_right\" class=\"text-right\">\n                    <span class=\"fa-stack fa-lg\" id=\"flb_caret\" onclick=\"toggleSelectors();\" title=\"<?php echo xla('Show/Hide the Selection Area'); ?>\" style=\"color:<?php echo $color = ($setting_selectors == 'none') ? 'var(--danger)' : 'var(--black)'; ?>;\">\n                        <i class=\"far fa-square fa-stack-2x\"></i>\n                        <i id=\"print_caret\" class='fa fa-caret-<?php echo $caret = ($setting_selectors == 'none') ? 'down' : 'up'; ?> fa-stack-1x'></i>\n                    </span>\n\n                    <a class=\"btn btn-primary btn-setting\" data-toggle=\"collapse\" href=\"#collapseSetting\">\n                        <?php echo xlt('Setting'); ?>\n                    </a>\n                    <a class='btn btn-primary btn-refresh' id='refreshme'><?php echo xlt('Refresh'); ?></a>\n                    <a class='btn btn-primary btn-print' onclick=\"print_FLB();\"> <?php echo xlt('Print'); ?></a>\n                    <a class='btn btn-primary' onclick=\"kiosk_FLB();\"> <?php echo xlt('Kiosk'); ?></a>\n                    <div class=\"collapse mt-2 mb-2\" id=\"collapseSetting\">\n                        <input type='checkbox' name='setting_new_window' id='setting_new_window' value='<?php echo attr($setting_new_window); ?>' <?php echo attr($setting_new_window); ?> />\n                        <?php echo xlt('Open Patient in New Window'); ?>\n                    </div>\n                </div>\n            </div>\n\n                    <div class=\"table-responsive mt-3\">\n                    <table class=\"table table-bordered\">\n                    <thead class=\"table-primary\">\n                    <tr class=\"small font-weight-bold text-center\">\n                        <?php if ($GLOBALS['ptkr_show_pid']) { ?>\n                            <td class=\"dehead text-center text-ovr-dark\" name=\"kiosk_hide\">\n                                <?php echo xlt('PID'); ?>\n                            </td>\n                        <?php } ?>\n                        <td class=\"dehead text-center text-ovr-dark\" style=\"max-width: 150px;\">\n                            <?php echo xlt('Patient'); ?>\n                        </td>\n                        <?php if ($GLOBALS['ptkr_visit_reason'] == '1') { ?>\n                            <td class=\"dehead text-center text-ovr-dark\" name=\"kiosk_hide\">\n                                <?php echo xlt('Reason'); ?>\n                            </td>\n                        <?php } ?>\n                        <?php if ($GLOBALS['ptkr_show_encounter']) { ?>\n                            <td class=\"dehead text-center text-ovr-dark\" name=\"kiosk_hide\">\n                                <?php echo xlt('Encounter'); ?>\n                            </td>\n                        <?php } ?>\n\n                        <?php if ($GLOBALS['ptkr_date_range'] == '1') { ?>\n                            <td class=\"dehead text-center text-ovr-dark\" name=\"kiosk_hide\">\n                                <?php echo xlt('Appt Date'); ?>\n                            </td>\n                        <?php } ?>\n                        <td class=\"dehead text-center text-ovr-dark\">\n                            <?php echo xlt('Appt Time'); ?>\n                        </td>\n                        <td class=\"dehead text-center text-ovr-dark\">\n                            <?php echo xlt('Arrive Time'); ?>\n                        </td>\n                        <td class=\"dehead text-center d-block d-sm-none text-ovr-dark\">\n                            <?php echo xlt('Arrival'); ?>\n                        </td>\n                        <td class=\"dehead text-center  d-sm-table-cell text-ovr-dark\">\n                            <?php echo xlt('Appt Status'); ?>\n                        </td>\n                        <td class=\"dehead text-center  d-sm-table-cell text-ovr-dark\">\n                            <?php echo xlt('Current Status'); ?>\n                        </td>\n                        <td class=\"dehead text-center d-block d-table-cell d-sm-none text-ovr-dark\">\n                            <?php echo xlt('Current'); ?>\n                        </td>\n                        <td class=\"dehead text-center text-ovr-dark\" name=\"kiosk_hide\">\n                            <?php echo xlt('Visit Type'); ?>\n                        </td>\n                        <?php if (count($chk_prov) > 1) { ?>\n                            <td class=\"dehead text-center d-sm-table-cell text-ovr-dark\">\n                                <?php echo xlt('Provider'); ?>\n                            </td>\n                        <?php } ?>\n                        <td class=\"dehead text-center text-ovr-dark\">\n                            <?php echo xlt('Total Time'); ?>\n                        </td>\n                        <td class=\"dehead text-center  d-sm-table-cell text-ovr-dark\">\n                            <?php echo xlt('Check Out Time'); ?>\n                        </td>\n                        <td class=\"dehead text-center d-block d-table-cell d-sm-none text-ovr-dark\">\n                            <?php echo xlt('Out Time'); ?>\n                        </td>\n                        <?php\n                        if ($GLOBALS['ptkr_show_staff']) { ?>\n                            <td class=\"dehead text-center text-ovr-dark\" name=\"kiosk_hide\">\n                                <?php echo xlt('Updated By'); ?>\n                            </td>\n                            <?php\n                        }\n                        if ($_REQUEST['kiosk'] != '1') {\n                            if ($GLOBALS['drug_screen']) { ?>\n                                <td class=\"dehead center text-ovr-dark\" name=\"kiosk_hide\">\n                                    <?php echo xlt('Random Drug Screen'); ?>\n                                </td>\n                                <td class=\"dehead center text-ovr-dark\" name=\"kiosk_hide\">\n                                    <?php echo xlt('Drug Screen Completed'); ?>\n                                </td>\n                                <?php\n                            }\n                        } ?>\n                    </tr>\n                    </thead>\n                    <tbody>\n                    <?php\n                    $prev_appt_date_time = \"\";\n                    foreach ($appointments as $appointment) {\n                        // Collect appt date and set up squashed date for use below\n                        $date_appt = $appointment['pc_eventDate'];\n                        $date_squash = str_replace(\"-\", \"\", $date_appt);\n                        if (empty($appointment['room']) && ($logged_in ?? null) && ($setting_bootstrap_submenu != 'hide')) {\n                            //Patient has not arrived yet, display MedEx Reminder info\n                            //one icon per type of response.\n                            //If there was a SMS dialog, display it as a mouseover/title\n                            //Display date received also as mouseover title.\n                            $other_title = '';\n                            $title = '';\n                            $icon2_here = '';\n                            $icon_CALL = '';\n                            $icon_4_CALL = '';\n                            $appt['stage'] = '';\n                            $icon_here = array();\n                            $prog_text = '';\n                            $CALLED = '';\n                            $FINAL = '';\n                            $icon_CALL = '';\n\n                            $query = \"SELECT * FROM medex_outgoing WHERE msg_pc_eid =? ORDER BY medex_uid asc\";\n                            $myMedEx = sqlStatement($query, array($appointment['eid']));\n                            /**\n                             * Each row for this pc_eid in the medex_outgoing table represents an event.\n                             * Every event is recorded in $prog_text.\n                             * A modality is represented by an icon (eg mail icon, phone icon, text icon).\n                             * The state of the Modality is represented by the color of the icon:\n                             *      CONFIRMED       =   green\n                             *      READ            =   blue\n                             *      FAILED          =   pink\n                             *      SENT/in process =   yellow\n                             *      SCHEDULED       =   white\n                             * Icons are displayed in their highest state.\n                             */\n                            while ($row = sqlFetchArray($myMedEx)) {\n                                // Need to convert $row['msg_date'] to localtime (stored as GMT) & then oeFormatShortDate it.\n                                // I believe there is a new GLOBAL for server timezone???  If so, it will be easy.\n                                // If not we need to import it from Medex through medex_preferences.  It should really be in openEMR though.\n                                // Delete when we figure this out.\n                                $other_title = '';\n                                if (!empty($row['msg_extra_text'])) {\n                                    $local = attr($row['msg_extra_text']) . \" |\";\n                                }\n                                $prog_text .= attr(oeFormatShortDate($row['msg_date'])) . \" :: \" . attr($row['msg_type']) . \" : \" . attr($row['msg_reply']) . \" | \" . $local . \" |\";\n\n                                if ($row['msg_reply'] == 'Other') {\n                                    $other_title .= $row['msg_extra_text'] . \"\\n\";\n                                    $icon_extra .= str_replace(\n                                        \"EXTRA\",\n                                        attr(oeFormatShortDate($row['msg_date'])) . \"\\n\" . xla('Patient Message') . \":\\n\" . attr($row['msg_extra_text']) . \"\\n\",\n                                        $icons[$row['msg_type']]['EXTRA']['html']\n                                    );\n                                    continue;\n                                } elseif ($row['msg_reply'] == 'CANCELLED') {\n                                    $appointment[$row['msg_type']]['stage'] = \"CANCELLED\";\n                                    $icon_here[$row['msg_type']] = '';\n                                } elseif ($row['msg_reply'] == \"FAILED\") {\n                                    $appointment[$row['msg_type']]['stage'] = \"FAILED\";\n                                    $icon_here[$row['msg_type']] = $icons[$row['msg_type']]['FAILED']['html'];\n                                } elseif (($row['msg_reply'] == \"CONFIRMED\") || ($appointment[$row['msg_type']]['stage'] == \"CONFIRMED\")) {\n                                    $appointment[$row['msg_type']]['stage'] = \"CONFIRMED\";\n                                    $icon_here[$row['msg_type']]  = $icons[$row['msg_type']]['CONFIRMED']['html'];\n                                } elseif ($row['msg_type'] == \"NOTES\") {\n                                    $CALLED = \"1\";\n                                    $FINAL = $icons['NOTES']['CALLED']['html'];\n                                    $icon_CALL = str_replace(\"Call Back: COMPLETED\", attr(oeFormatShortDate($row['msg_date'])) . \" :: \" . xla('Callback Performed') . \" | \" . xla('NOTES') . \": \" . $row['msg_extra_text'] . \" | \", $FINAL);\n                                    continue;\n                                } elseif (($row['msg_reply'] == \"READ\") || ($appointment[$row['msg_type']]['stage'] == \"READ\")) {\n                                    $appointment[$row['msg_type']]['stage'] = \"READ\";\n                                    $icon_here[$row['msg_type']] = $icons[$row['msg_type']]['READ']['html'];\n                                } elseif (($row['msg_reply'] == \"SENT\") || ($appointment[$row['msg_type']]['stage'] == \"SENT\")) {\n                                    $appointment[$row['msg_type']]['stage'] = \"SENT\";\n                                    $icon_here[$row['msg_type']] = $icons[$row['msg_type']]['SENT']['html'];\n                                } elseif (($row['msg_reply'] == \"To Send\") || (empty($appointment['stage']))) {\n                                    if (\n                                        ($appointment[$row['msg_type']]['stage'] != \"CONFIRMED\") &&\n                                        ($appointment[$row['msg_type']]['stage'] != \"READ\") &&\n                                        ($appointment[$row['msg_type']]['stage'] != \"SENT\") &&\n                                        ($appointment[$row['msg_type']]['stage'] != \"FAILED\")\n                                    ) {\n                                        $appointment[$row['msg_type']]['stage'] = \"QUEUED\";\n                                        $icon_here[$row['msg_type']] = $icons[$row['msg_type']]['SCHEDULED']['html'];\n                                    }\n                                }\n                                //these are additional icons if present\n                                if (($row['msg_reply'] == \"CALL\") && (!$CALLED)) {\n                                    $icon_here = '';\n                                    $icon_4_CALL = $icons[$row['msg_type']]['CALL']['html'];\n                                    $icon_CALL = \"<span onclick=\\\"doCALLback(\" . attr_js($date_squash) . \",\" . attr_js($appointment['eid']) . \",\" . attr_js($appointment['pc_cattype']) . \")\\\">\" . $icon_4_CALL . \"</span>\n                                    <span class='hidden' name='progCALLback_\" . attr($appointment['eid']) . \"' id='progCALLback_\" . attr($appointment['eid']) . \"'>\n                                      <form id='notation_\" . attr($appointment['eid']) . \"' method='post'\n                                      action='#'>\n                                        <input type='hidden' name='csrf_token_form' value='\" . attr(CsrfUtils::collectCsrfToken()) . \"' />\n                                        <h4>\" . xlt('Call Back Notes') . \":</h4>\n                                        <input type='hidden' name='pc_eid' id='pc_eid' value='\" . attr($appointment['eid']) . \"'>\n                                        <input type='hidden' name='pc_pid' id='pc_pid' value='\" . attr($appointment['pc_pid']) . \"'>\n                                        <input type='hidden' name='campaign_uid' id='campaign_uid' value='\" . attr($row['campaign_uid']) . \"'>\n                                        <textarea name='txtCALLback' id='txtCALLback' rows=6 cols=20></textarea>\n                                        <input type='submit' name='saveCALLback' id='saveCALLback' value='\" . xla(\"Save\") . \"'>\n                                      </form>\n                                    </span>\n                                      \";\n                                } elseif ($row['msg_reply'] == \"STOP\") {\n                                    $icon2_here .= $icons[$row['msg_type']]['STOP']['html'];\n                                } elseif ($row['msg_reply'] == \"Other\") {\n                                    $icon2_here .= $icons[$row['msg_type']]['Other']['html'];\n                                } elseif ($row['msg_reply'] == \"CALLED\") {\n                                    $icon2_here .= $icons[$row['msg_type']]['CALLED']['html'];\n                                }\n                            }\n                            //if pc_apptstatus == '-', update it now to=status\n                            if (!empty($other_title)) {\n                                $appointment['messages'] = $icon2_here . $icon_extra;\n                            }\n                        }\n\n                        // Collect variables and do some processing\n                        $docname = $chk_prov[$appointment['uprovider_id']];\n                        if (strlen($docname) <= 3) {\n                            continue;\n                        }\n                        $ptname = $appointment['lname'] . ', ' . $appointment['fname'] . ' ' . $appointment['mname'];\n                        $ptname_short = $appointment['fname'][0] . \" \" . $appointment['lname'][0];\n                        $appt_enc = $appointment['encounter'];\n                        $appt_eid = (!empty($appointment['eid'])) ? $appointment['eid'] : $appointment['pc_eid'];\n                        $appt_pid = (!empty($appointment['pid'])) ? $appointment['pid'] : $appointment['pc_pid'];\n                        if ($appt_pid == 0) {\n                            continue; // skip when $appt_pid = 0, since this means it is not a patient specific appt slot\n                        }\n                        $status = (!empty($appointment['status']) && (!is_numeric($appointment['status']))) ? $appointment['status'] : $appointment['pc_apptstatus'];\n                        $appt_room = (!empty($appointment['room'])) ? $appointment['room'] : $appointment['pc_room'];\n                        $appt_time = (!empty($appointment['appttime'])) ? $appointment['appttime'] : $appointment['pc_startTime'];\n                        $tracker_id = $appointment['id'];\n                        // reason for visit\n                        if ($GLOBALS['ptkr_visit_reason']) {\n                            $reason_visit = $appointment['pc_hometext'];\n                        }\n                        $newarrive = collect_checkin($tracker_id);\n                        $newend = collect_checkout($tracker_id);\n                        $colorevents = (collectApptStatusSettings($status));\n                        $bgcolor = $colorevents['color'];\n                        $statalert = $colorevents['time_alert'];\n                        // process the time to allow items with a check out status to be displayed\n                        if (is_checkout($status) && (($GLOBALS['checkout_roll_off'] > 0) && strlen($form_apptstatus) != 1)) {\n                            $to_time = strtotime($newend);\n                            $from_time = strtotime($datetime);\n                            $display_check_out = round(abs($from_time - $to_time) / 60, 0);\n                            if ($display_check_out >= $GLOBALS['checkout_roll_off']) {\n                                continue;\n                            }\n                        }\n\n                        echo '<tr data-apptstatus=\"' . attr($appointment['pc_apptstatus']) . '\"\n                            data-apptcat=\"' . attr($appointment['pc_catid']) . '\"\n                            data-facility=\"' . attr($appointment['pc_facility']) . '\"\n                            data-provider=\"' . attr($appointment['uprovider_id']) . '\"\n                            data-pid=\"' . attr($appointment['pc_pid']) . '\"\n                            data-pname=\"' . attr($ptname) . '\"\n                            class=\"text-small\"\n                            style=\"background-color:' . attr($bgcolor) . ';\" >';\n\n                        if ($GLOBALS['ptkr_show_pid']) {\n                            ?>\n                            <td class=\"detail text-center\" name=\"kiosk_hide\">\n                                <?php echo text($appt_pid); ?>\n                            </td>\n                            <?php\n                        }\n\n                        ?>\n                        <td class=\"detail text-center\" name=\"kiosk_hide\">\n                            <a href=\"#\" onclick=\"return topatient(<?php echo attr_js($appt_pid); ?>,<?php echo attr_js($appt_enc); ?>)\">\n                                <?php echo text($ptname); ?></a>\n                        </td>\n\n                        <td class=\"detail text-center\" style=\"white-space: normal;\" name=\"kiosk_show\">\n                            <a href=\"#\" onclick=\"return topatient(<?php echo attr_js($appt_pid); ?>,<?php echo attr_js($appt_enc); ?>)\">\n                                <?php echo text($ptname_short); ?></a>\n                        </td>\n\n                        <!-- reason -->\n                        <?php if ($GLOBALS['ptkr_visit_reason']) { ?>\n                            <td class=\"detail text-center\" name=\"kiosk_hide\">\n                                <?php echo text($reason_visit) ?>\n                            </td>\n                        <?php } ?>\n                        <?php if ($GLOBALS['ptkr_show_encounter']) { ?>\n                            <td class=\"detail text-center\" name=\"kiosk_hide\">\n                                <?php\n                                if ($appt_enc != 0) {\n                                    echo text($appt_enc);\n                                }\n                                ?>\n                            </td>\n                        <?php } ?>\n                        <?php if ($GLOBALS['ptkr_date_range'] == '1') { ?>\n                            <td class=\"detail text-center\" name=\"kiosk_hide\">\n                                <?php echo text(oeFormatShortDate($appointment['pc_eventDate']));\n                                ?>\n                            </td>\n                        <?php } ?>\n                        <td class=\"detail text-center\">\n                            <?php echo text(oeFormatTime($appt_time)); ?>\n                        </td>\n                        <td class=\"detail text-center\">\n                            <?php\n                            if ($newarrive) {\n                                echo text(oeFormatTime($newarrive));\n                            }\n                            ?>\n                        </td>\n                        <td class=\"detail text-center \">\n                            <?php if (empty($tracker_id)) { //for appt not yet with tracker id and for recurring appt ?>\n                            <a class=\"btn btn-primary btn-sm\" onclick=\"return calendarpopup(<?php echo attr_js($appt_eid) . \",\" . attr_js($date_squash); // calls popup for add edit calendar event?>)\">\n                            <?php } else { ?>\n                                <a class=\"btn btn-primary btn-s\" onclick=\"return bpopup(<?php echo attr_js($tracker_id); // calls popup for patient tracker status?>)\">\n                            <?php } ?>\n                            <?php\n                            if ($appointment['room'] > '') {\n                                echo text(getListItemTitle('patient_flow_board_rooms', $appt_room));\n                            } else {\n                                echo text(getListItemTitle(\"apptstat\", $status)); // drop down list for appointment status\n                            }\n                            ?>\n                            </a>\n                        </td>\n\n                        <?php\n                        //time in current status\n                        $to_time = strtotime(date(\"Y-m-d H:i:s\"));\n                        $yestime = '0';\n                        if (strtotime($newend) != '') {\n                            $from_time = strtotime($newarrive);\n                            $to_time = strtotime($newend);\n                            $yestime = '0';\n                        } else {\n                            $from_time = (($appointment['start_datetime'] ?? null) ? strtotime($appointment['start_datetime']) : null);\n                            $yestime = '1';\n                        }\n\n                        $timecheck = round(abs($to_time - ($from_time ?? null)) / 60, 0);\n                        if ($timecheck >= $statalert && ($statalert > '0')) { // Determine if the time in status limit has been reached.\n                            echo \"<td class='text-center  js-blink-infinite small' nowrap>  \"; // and if so blink\n                        } else {\n                            echo \"<td class='detail text-center' nowrap> \"; // and if not do not blink\n                        }\n                        if (($yestime == '1') && ($timecheck >= 1) && (strtotime($newarrive) != '')) {\n                            echo text($timecheck . ' ' . ($timecheck >= 2 ? xl('minutes') : xl('minute')));\n                        } elseif (($icon_here ?? null) || ($icon2_here ?? null) || ($icon_CALL ?? null)) {\n                            echo \"<span style='font-size:0.7rem;' onclick='return calendarpopup(\" . attr_js($appt_eid) . \",\" . attr_js($date_squash) . \")'>\" . implode($icon_here) . $icon2_here . \"</span> \" . $icon_CALL;\n                        } elseif ($logged_in ?? null) {\n                            $pat = $MedEx->display->possibleModalities($appointment);\n                            echo \"<span style='font-size:0.7rem;' onclick='return calendarpopup(\" . attr_js($appt_eid) . \",\" . attr_js($date_squash) . \")'>\" . $pat['SMS'] . $pat['AVM'] . $pat['EMAIL'] . \"</span>\";\n                        }\n                        //end time in current status\n                        echo \"</td>\";\n                        ?>\n                        <td class=\"detail text-center\" name=\"kiosk_hide\">\n                            <?php echo xlt($appointment['pc_title']); ?>\n                        </td>\n                        <?php\n                        if (count($chk_prov) > 1) { ?>\n                            <td class=\"detail text-center  d-sm-table-cell\">\n                                <?php echo text($docname); ?>\n                            </td>\n                            <?php\n                        } ?>\n                        <td class=\"detail text-center\">\n                            <?php\n                            // total time in practice\n                            if (strtotime($newend) != '') {\n                                $from_time = strtotime($newarrive);\n                                $to_time = strtotime($newend);\n                            } else {\n                                $from_time = strtotime($newarrive);\n                                $to_time = strtotime(date(\"Y-m-d H:i:s\"));\n                            }\n                            $timecheck2 = round(abs($to_time - $from_time) / 60, 0);\n                            if (strtotime($newarrive) != '' && ($timecheck2 >= 1)) {\n                                echo text($timecheck2 . ' ' . ($timecheck2 >= 2 ? xl('minutes') : xl('minute')));\n                            }\n                            // end total time in practice\n                            echo text($appointment['pc_time'] ?? ''); ?>\n                        </td>\n                        <td class=\"detail text-center\">\n                            <?php\n                            if (strtotime($newend) != '') {\n                                echo text(oeFormatTime(substr($newend, 11))) ;\n                            }\n                            ?>\n                        </td>\n                        <?php\n                        if ($GLOBALS['ptkr_show_staff'] == '1') {\n                            ?>\n                                <td class=\"detail text-center\" name=\"kiosk_hide\">\n                                    <?php echo text($appointment['user']) ?>\n                                </td>\n                            <?php\n                        }\n                        if ($GLOBALS['drug_screen']) {\n                            if (strtotime($newarrive) != '') { ?>\n                                <td class=\"detail text-center\" name=\"kiosk_hide\">\n                                    <?php\n                                    if ($appointment['random_drug_test'] == '1') {\n                                        echo xlt('Yes');\n                                    } else {\n                                        echo xlt('No');\n                                    } ?>\n                                </td>\n                                <?php\n                            } else { ?>\n                                <td class=\"detail text-center\" name=\"kiosk_hide\"></td>\n                            <?php }\n                            if (strtotime($newarrive) != '' && $appointment['random_drug_test'] == '1') { ?>\n                                <td class=\"detail text-center\" name=\"kiosk_hide\">\n                                    <?php\n                                    if (strtotime($newend) != '') {\n                                        // the following block allows the check box for drug screens to be disabled once the status is check out ?>\n                                        <input type='checkbox' disabled='disable' class=\"drug_screen_completed\" id=\"<?php echo attr($appointment['pt_tracker_id']) ?>\" <?php echo ($appointment['drug_screen_completed'] == \"1\") ? \"checked\" : \"\"; ?> />\n                                        <?php\n                                    } else {\n                                        ?>\n                                        <input type='checkbox' class=\"drug_screen_completed\" id='<?php echo attr($appointment['pt_tracker_id']) ?>' name=\"drug_screen_completed\" <?php echo ($appointment['drug_screen_completed'] == \"1\") ? \"checked\" : \"\"; ?> />\n                                        <?php\n                                    } ?>\n                                </td>\n                                <?php\n                            } else { ?>\n                                <td class=\"detail text-center\" name=\"kiosk_hide\"></td>\n                            <?php }\n                        }\n                        ?>\n                        </tr>\n                        <?php\n                    } //end foreach\n                    ?>\n                    </tbody>\n                </table>\n                </div>\n\n    <?php\n}\nif (!($_REQUEST['flb_table'] ?? null)) { ?>\n                </div>\n            </div>\n        </div>\n    </div><?php //end container ?>\n    <!-- form used to open a new top level window when a patient row is clicked -->\n    <form name='fnew' method='post' target='_blank' action='../main/main_screen.php?auth=login&site=<?php echo attr_url($_SESSION['site_id']); ?>'>\n        <input type=\"hidden\" name=\"csrf_token_form\" value=\"<?php echo attr(CsrfUtils::collectCsrfToken()); ?>\" />\n        <input type='hidden' name='patientID' value='0' />\n        <input type='hidden' name='encounterID' value='0' />\n    </form>\n\n    <?php echo myLocalJS(); ?>\n</body>\n</html>\n    <?php\n} //end of second !$_REQUEST['flb_table']\n\n\nexit;\n\nfunction myLocalJS()\n{\n    ?>\n    <script>\n        var auto_refresh = null;\n        //this can be refined to redact HIPAA material using @media print options.\n        window.parent.$(\"[name='flb']\").attr('allowFullscreen', 'true');\n        $(\"[name='kiosk_hide']\").show();\n        $(\"[name='kiosk_show']\").hide();\n\n        function print_FLB() {\n            window.print();\n        }\n\n        function toggleSelectors() {\n            top.restoreSession();\n            if ($(\"#flb_selectors\").css('display') === 'none') {\n                $.post(\"<?php echo $GLOBALS['webroot'] . \"/interface/patient_tracker/patient_tracker.php\"; ?>\", {\n                    setting_selectors: 'block',\n                    csrf_token_form: <?php echo js_escape(CsrfUtils::collectCsrfToken()); ?>\n                }).done(\n                    function (data) {\n                        $(\"#flb_selectors\").slideToggle();\n                        if($(\"#flb_caret\").hasClass('text-danger')) {\n                          $(\"#flb_caret\").removeClass('text-danger');\n                        }\n                        $(\"#flb_caret\").addClass('text-body');\n                });\n            } else {\n                $.post(\"<?php echo $GLOBALS['webroot'] . \"/interface/patient_tracker/patient_tracker.php\"; ?>\", {\n                    setting_selectors: 'none',\n                    csrf_token_form: <?php echo js_escape(CsrfUtils::collectCsrfToken()); ?>\n                }).done(\n                    function (data) {\n                        $(\"#flb_selectors\").slideToggle();\n                        if($(\"#flb_caret\").hasClass('text-body')) {\n                          $(\"#flb_caret\").removeClass('text-body');\n                        }\n                        $(\"#flb_caret\").addClass('text-danger');\n                });\n            }\n            $(\"#print_caret\").toggleClass('fa-caret-up').toggleClass('fa-caret-down');\n        }\n\n        /**\n         * This function refreshes the whole flb_table according to our to/from dates.\n         */\n        function refreshMe(fromTimer) {\n\n            if (typeof fromTimer === 'undefined' || !fromTimer) {\n                //Show loader in the first loading or manual loading not by timer\n                $(\"#flb_table\").html('');\n                $('#loader').show();\n                skip_timeout_reset = 0;\n            } else {\n                skip_timeout_reset = 1;\n            }\n\n            var startRequestTime = Date.now();\n            top.restoreSession();\n            var posting = $.post('../patient_tracker/patient_tracker.php', {\n                flb_table: '1',\n                form_from_date: $(\"#form_from_date\").val(),\n                form_to_date: $(\"#form_to_date\").val(),\n                form_facility: $(\"#form_facility\").val(),\n                form_provider: $(\"#form_provider\").val(),\n                form_apptstatus: $(\"#form_apptstatus\").val(),\n                form_patient_name: $(\"#form_patient_name\").val(),\n                form_patient_id: $(\"#form_patient_id\").val(),\n                form_apptcat: $(\"#form_apptcat\").val(),\n                kiosk: $(\"#kiosk\").val(),\n                skip_timeout_reset: skip_timeout_reset,\n                csrf_token_form: <?php echo js_escape(CsrfUtils::collectCsrfToken()); ?>\n            }).done(\n                function (data) {\n                    //minimum 400 ms of loader (In the first loading or manual loading not by timer)\n                    if((typeof fromTimer === 'undefined' || !fromTimer) && Date.now() - startRequestTime < 400 ){\n                        setTimeout(drawTable, 500, data);\n                    } else {\n                        drawTable(data)\n                    }\n                });\n        }\n\n        function drawTable(data) {\n\n            $('#loader').hide();\n            $(\"#flb_table\").html(data);\n            if ($(\"#kiosk\").val() === '') {\n            $(\"[name='kiosk_hide']\").show();\n            $(\"[name='kiosk_show']\").hide();\n            } else {\n            $(\"[name='kiosk_hide']\").hide();\n            $(\"[name='kiosk_show']\").show();\n            }\n\n            refineMe();\n\n            initTableButtons();\n\n        }\n\n        function refreshme() {\n            // Just need this to support refreshme call from the popup used for recurrent appt\n            refreshMe();\n        }\n\n        /**\n         * This function hides all then shows only the flb_table rows that match our selection, client side.\n         * It is called on initial load, on refresh and 'onchange/onkeyup' of a flow board parameter.\n         */\n        function refineMe() {\n            var apptcatV = $(\"#form_apptcat\").val();\n            var apptstatV = $(\"#form_apptstatus\").val();\n            var facV = $(\"#form_facility\").val();\n            var provV = $(\"#form_provider\").val();\n            var pidV = String($(\"#form_patient_id\").val());\n            var pidRE = new RegExp(pidV, 'g');\n            var pnameV = $(\"#form_patient_name\").val();\n            var pnameRE = new RegExp(pnameV, 'ig');\n\n            //and hide what we don't want to show\n            $('#flb_table tbody tr').hide().filter(function () {\n                var d = $(this).data();\n                meets_cat = (apptcatV === '') || (apptcatV == d.apptcat);\n                meets_stat = (apptstatV === '') || (apptstatV == d.apptstatus);\n                meets_fac = (facV === '') || (facV == d.facility);\n                meets_prov = (provV === '') || (provV == d.provider);\n                meets_pid = (pidV === '');\n                if ((pidV > '') && pidRE.test(d.pid)) {\n                    meets_pid = true;\n                }\n                meets_pname = (pnameV === '');\n                if ((pnameV > '') && pnameRE.test(d.pname)) {\n                    meets_pname = true;\n                }\n                return meets_pname && meets_pid && meets_cat && meets_stat && meets_fac && meets_prov;\n            }).show();\n        }\n\n        // popup for patient tracker status\n        function bpopup(tkid) {\n            top.restoreSession();\n            dlgopen('../patient_tracker/patient_tracker_status.php?tracker_id=' + encodeURIComponent(tkid) + '&csrf_token_form=' + <?php echo js_url(CsrfUtils::collectCsrfToken()); ?>, '_blank', 500, 250);\n            return false;\n        }\n\n        // popup for calendar add edit\n        function calendarpopup(eid, date_squash) {\n            top.restoreSession();\n            dlgopen('../main/calendar/add_edit_event.php?eid=' + encodeURIComponent(eid) + '&date=' + encodeURIComponent(date_squash), '_blank', 775, 500);\n            return false;\n        }\n\n        // used to display the patient demographic and encounter screens\n        function topatient(newpid, enc) {\n            if ($('#setting_new_window').val() === 'checked') {\n                openNewTopWindow(newpid, enc);\n            }\n            else {\n                top.restoreSession();\n                if (enc > 0) {\n                    top.RTop.location = \"<?php echo $GLOBALS['webroot']; ?>/interface/patient_file/summary/demographics.php?set_pid=\" + encodeURIComponent(newpid) + \"&set_encounterid=\" + encodeURIComponent(enc);\n                }\n                else {\n                    top.RTop.location = \"<?php echo $GLOBALS['webroot']; ?>/interface/patient_file/summary/demographics.php?set_pid=\" + encodeURIComponent(newpid);\n                }\n            }\n        }\n\n        function doCALLback(eventdate, eid, pccattype) {\n            $(\"#progCALLback_\" + eid).parent().removeClass('js-blink-infinite').css('animation-name', 'none');\n            $(\"#progCALLback_\" + eid).removeClass(\"hidden\");\n            clearInterval(auto_refresh);\n        }\n\n        // opens the demographic and encounter screens in a new window\n        function openNewTopWindow(newpid, newencounterid) {\n            document.fnew.patientID.value = newpid;\n            document.fnew.encounterID.value = newencounterid;\n            top.restoreSession();\n            document.fnew.submit();\n        }\n\n        //opens the two-way SMS phone app\n        /**\n         * @return {boolean}\n         */\n        function SMS_bot(pid) {\n            top.restoreSession();\n            var from = <?php echo js_escape($from_date ?? ''); ?>;\n            var to = <?php echo js_escape($to_date ?? ''); ?>;\n            var oefrom = <?php echo js_escape(oeFormatShortDate($from_date ?? null)); ?>;\n            var oeto = <?php echo js_escape(oeFormatShortDate($to_date ?? null)); ?>;\n            window.open('../main/messages/messages.php?nomenu=1&go=SMS_bot&pid=' + encodeURIComponent(pid) + '&to=' + encodeURIComponent(to) + '&from=' + encodeURIComponent(from) + '&oeto=' + encodeURIComponent(oeto) + '&oefrom=' + encodeURIComponent(oefrom), 'SMS_bot', 'width=370,height=600,resizable=0');\n            return false;\n        }\n\n        function kiosk_FLB() {\n            $(\"#kiosk\").val('1');\n            $(\"[name='kiosk_hide']\").hide();\n            $(\"[name='kiosk_show']\").show();\n\n            var i = document.getElementById(\"flb_table\");\n            // go full-screen\n            if (i.requestFullscreen) {\n                i.requestFullscreen();\n            } else if (i.webkitRequestFullscreen) {\n                i.webkitRequestFullscreen();\n            } else if (i.mozRequestFullScreen) {\n                i.mozRequestFullScreen();\n            } else if (i.msRequestFullscreen) {\n                i.msRequestFullscreen();\n            }\n            // refreshMe();\n        }\n\n        function KioskUp() {\n            var kv = $(\"#kiosk\").val();\n            if (kv == '0') {\n                $(\"#kiosk\").val('1');\n                $(\"[name='kiosk_hide']\").show();\n                $(\"[name='kiosk_show']\").hide();\n            } else {\n                $(\"#kiosk\").val('0');\n                $(\"[name='kiosk_hide']\").hide();\n                $(\"[name='kiosk_show']\").show();\n            }\n        }\n\n        $(function () {\n            refreshMe();\n            $(\"#kiosk\").val('');\n            $(\"[name='kiosk_hide']\").show();\n            $(\"[name='kiosk_show']\").hide();\n\n            onresize = function () {\n                var state = 1 >= outerHeight - innerHeight ? \"fullscreen\" : \"windowed\";\n                if (window.state === state) return;\n                window.state = state;\n                var event = document.createEvent(\"Event\");\n                event.initEvent(state, true, true);\n                window.dispatchEvent(event);\n            };\n\n            [\"fullscreenchange\", \"webkitfullscreenchange\", \"mozfullscreenchange\", \"msfullscreenchange\"].forEach(\n                eventType => document.addEventListener(eventType, KioskUp, false)\n            );\n\n            <?php if ($GLOBALS['pat_trkr_timer'] != '0') { ?>\n                var reftime = <?php echo js_escape($GLOBALS['pat_trkr_timer']); ?>;\n                var parsetime = reftime.split(\":\");\n                parsetime = (parsetime[0] * 60) + (parsetime[1] * 1) * 1000;\n                if (auto_refresh) clearInteral(auto_refresh);\n                auto_refresh = setInterval(function () {\n                    refreshMe(true) // this will run after every parsetime seconds\n                }, parsetime);\n            <?php } ?>\n\n            $('.js-blink-infinite').each(function () {\n                // set up blinking text\n                var elem = $(this);\n                setInterval(function () {\n                    if (elem.css('visibility') === 'hidden') {\n                        elem.css('visibility', 'visible');\n                    } else {\n                        elem.css('visibility', 'hidden');\n                    }\n                }, 500);\n            });\n            // toggle of the check box status for drug screen completed and ajax call to update the database\n            $('body').on('click', '.drug_screen_completed', function () {\n                top.restoreSession();\n                if (this.checked) {\n                    testcomplete_toggle = \"true\";\n                } else {\n                    testcomplete_toggle = \"false\";\n                }\n                $.post(\"../../library/ajax/drug_screen_completed.php\", {\n                    trackerid: this.id,\n                    testcomplete: testcomplete_toggle,\n                    csrf_token_form: <?php echo js_escape(CsrfUtils::collectCsrfToken()); ?>\n                });\n            });\n\n            // mdsupport - Immediately post changes to setting_new_window\n            $('body').on('click', '#setting_new_window', function () {\n                $('#setting_new_window').val(this.checked ? 'checked' : ' ');\n                top.restoreSession();\n                $.post(\"<?php echo $GLOBALS['webroot'] . \"/interface/patient_tracker/patient_tracker.php\"; ?>\", {\n                    setting_new_window: $('#setting_new_window').val(),\n                    csrf_token_form: <?php echo js_escape(CsrfUtils::collectCsrfToken()); ?>\n                }).done(\n                    function (data) {\n                });\n            });\n\n            $('#filter_submit').click(function (e) {\n                e.preventDefault;\n                refreshMe();\n            });\n\n            $('[data-toggle=\"tooltip\"]').tooltip();\n\n            $('.datepicker').datetimepicker({\n                <?php $datetimepicker_timepicker = false; ?>\n                <?php $datetimepicker_showseconds = false; ?>\n                <?php $datetimepicker_formatInput = true; ?>\n                <?php require($GLOBALS['srcdir'] . '/js/xl/jquery-datetimepicker-2-5-4.js.php'); ?>\n                <?php // can add any additional javascript settings to datetimepicker here; need to prepend first setting with a comma ?>\n            });\n\n        });\n\n        function initTableButtons() {\n            $('#refreshme').click(function () {\n                refreshMe();\n                refineMe();\n            });\n        }\n\n        initTableButtons();\n\n    </script>\n<?php }\n?>\n", "<?php\n\n/**\n *\n * @package OpenEMR\n * @author Eldho Chacko <eldho@zhservices.com>\n * @author Paul Simon K <paul@zhservices.com>\n * @author Stephen Waite <stephen.waite@cmsvt.com>\n * @author Rod Roark <rod@sunsetsystems.com>\n * @copyright Copyright (c) 2010 Z&H Consultancy Services Private Limited <sam@zhservices.com>\n * @copyright Copyright (c) 2018 Stephen Waite <stephen.waite@cmsvt.com>\n * @copyright Copyright (c) 2020 Rod Roark <rod@sunsetsystems.com>\n * @link https://www.open-emr.org\n * @license https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\nuse OpenEMR\\Billing\\SLEOB;\nuse OpenEMR\\Common\\Logging\\EventAuditLogger;\n\n// Post a payment to the payments table.\n//\nfunction frontPayment($patient_id, $encounter, $method, $source, $amount1, $amount2, $timestamp, $auth = \"\")\n{\n\n    if (empty($auth)) {\n        $auth = $_SESSION['authUser'];\n    }\n\n    $tmprow = sqlQuery(\n        \"SELECT date FROM form_encounter WHERE \" .\n        \"encounter=? and pid=?\",\n        array($encounter,$patient_id)\n    );\n        //the manipulation is done to insert the amount paid into payments table in correct order to show in front receipts report,\n        //if the payment is for today's encounter it will be shown in the report under today field and otherwise shown as previous\n    $tmprowArray = explode(' ', $tmprow['date']);\n    if (date('Y-m-d') == $tmprowArray[0]) {\n        if ($amount1 == 0) {\n              $amount1 = $amount2;\n              $amount2 = 0;\n        }\n    } else {\n        if ($amount2 == 0) {\n              $amount2 = $amount1;\n              $amount1 = 0;\n        }\n    }\n\n    $payid = sqlInsert(\"INSERT INTO payments ( \" .\n    \"pid, encounter, dtime, user, method, source, amount1, amount2 \" .\n    \") VALUES ( ?, ?, ?, ?, ?, ?, ?, ?)\", array($patient_id,$encounter,$timestamp,$auth,$method,$source,$amount1,$amount2));\n    return $payid;\n}\n\n//===============================================================================\n//This section handles the common functins of payment screens.\n//===============================================================================\nfunction DistributionInsert($CountRow, $created_time, $user_id)\n{\n//Function inserts the distribution.Payment,Adjustment,Deductible,Takeback & Follow up reasons are inserted as seperate rows.\n //It automatically pushes to next insurance for billing.\n //In the screen a drop down of Ins1,Ins2,Ins3,Pat are given.The posting can be done for any level.\n    $Affected = 'no';\n    // watch for payments less than $1, thanks @snailwell\n    if (isset($_POST[\"Payment$CountRow\"]) && (floatval($_POST[\"Payment$CountRow\"]) > 0)) {\n        if (trim(formData('type_name')) == 'insurance') {\n            if (trim(formData(\"HiddenIns$CountRow\")) == 1) {\n                $AccountCode = \"IPP\";\n            }\n\n            if (trim(formData(\"HiddenIns$CountRow\")) == 2) {\n                $AccountCode = \"ISP\";\n            }\n\n            if (trim(formData(\"HiddenIns$CountRow\")) == 3) {\n                $AccountCode = \"ITP\";\n            }\n        } elseif (trim(formData('type_name')) == 'patient') {\n            $AccountCode = \"PP\";\n        }\n\n        sqlBeginTrans();\n        $sequence_no = sqlQuery(\"SELECT IFNULL(MAX(sequence_no),0) + 1 AS increment FROM ar_activity WHERE pid = ? AND encounter = ?\", array(trim(formData('hidden_patient_code')), trim(formData(\"HiddenEncounter$CountRow\"))));\n        sqlStatement(\"insert into ar_activity set \"    .\n        \"pid = '\"       . trim(formData('hidden_patient_code')) .\n        \"', encounter = '\"     . trim(formData(\"HiddenEncounter$CountRow\"))  .\n        \"', sequence_no = '\" . $sequence_no['increment'] .\n                \"', code_type = '\"      . trim(formData(\"HiddenCodetype$CountRow\"))  .\n        \"', code = '\"      . trim(formData(\"HiddenCode$CountRow\"))  .\n        \"', modifier = '\"      . trim(formData(\"HiddenModifier$CountRow\"))  .\n        \"', payer_type = '\"   . trim(formData(\"HiddenIns$CountRow\")) .\n        \"', post_time = '\"  . trim($created_time) .\n        \"', post_user = '\" . trim($user_id)  .\n        \"', session_id = '\"    . trim(formData('payment_id')) .\n        \"', modified_time = '\"  . trim($created_time) .\n        \"', pay_amount = '\" . trim(formData(\"Payment$CountRow\"))  .\n        \"', adj_amount = '\"    . 0 .\n        \"', account_code = '\" . \"$AccountCode\"  .\n        \"'\");\n          sqlCommitTrans();\n          $Affected = 'yes';\n    }\n\n    if (!empty($_POST[\"AdjAmount$CountRow\"]) && (floatval($_POST[\"AdjAmount$CountRow\"] ?? null)) != 0) {\n        if (trim(formData('type_name')) == 'insurance') {\n            $AdjustString = \"Ins adjust Ins\" . trim(formData(\"HiddenIns$CountRow\"));\n            $AccountCode = \"IA\";\n        } elseif (trim(formData('type_name')) == 'patient') {\n            $AdjustString = \"Pt adjust\";\n            $AccountCode = \"PA\";\n        }\n\n        sqlBeginTrans();\n        $sequence_no = sqlQuery(\"SELECT IFNULL(MAX(sequence_no),0) + 1 AS increment FROM ar_activity WHERE pid = ? AND encounter = ?\", array(trim(formData('hidden_patient_code')), trim(formData(\"HiddenEncounter$CountRow\"))));\n        sqlStatement(\"insert into ar_activity set \"    .\n        \"pid = '\"       . trim(formData('hidden_patient_code')) .\n        \"', encounter = '\"     . trim(formData(\"HiddenEncounter$CountRow\"))  .\n        \"', sequence_no = '\"     . $sequence_no['increment']  .\n                \"', code_type = '\"      . trim(formData(\"HiddenCodetype$CountRow\"))  .\n        \"', code = '\"      . trim(formData(\"HiddenCode$CountRow\"))  .\n        \"', modifier = '\"      . trim(formData(\"HiddenModifier$CountRow\"))  .\n        \"', payer_type = '\"   . trim(formData(\"HiddenIns$CountRow\")) .\n        \"', post_time = '\"  . trim($created_time) .\n        \"', post_user = '\" . trim($user_id)  .\n        \"', session_id = '\"    . trim(formData('payment_id')) .\n        \"', modified_time = '\"  . trim($created_time) .\n        \"', pay_amount = '\" . 0  .\n        \"', adj_amount = '\"    . trim(formData(\"AdjAmount$CountRow\")) .\n        \"', memo = '\" . \"$AdjustString\"  .\n        \"', account_code = '\" . \"$AccountCode\"  .\n        \"'\");\n           sqlCommitTrans();\n          $Affected = 'yes';\n    }\n\n    if (!empty($_POST[\"Deductible$CountRow\"]) && (floatval($_POST[\"Deductible$CountRow\"] ?? null)) > 0) {\n         sqlBeginTrans();\n         $sequence_no = sqlQuery(\"SELECT IFNULL(MAX(sequence_no),0) + 1 AS increment FROM ar_activity WHERE pid = ? AND encounter = ?\", array(trim(formData('hidden_patient_code')), trim(formData(\"HiddenEncounter$CountRow\"))));\n        sqlStatement(\"insert into ar_activity set \"    .\n        \"pid = '\"       . trim(formData('hidden_patient_code')) .\n        \"', encounter = '\"     . trim(formData(\"HiddenEncounter$CountRow\"))  .\n        \"', sequence_no = '\"     . $sequence_no['increment']  .\n                \"', code_type = '\"      . trim(formData(\"HiddenCodetype$CountRow\"))  .\n        \"', code = '\"      . trim(formData(\"HiddenCode$CountRow\"))  .\n        \"', modifier = '\"      . trim(formData(\"HiddenModifier$CountRow\"))  .\n        \"', payer_type = '\"   . trim(formData(\"HiddenIns$CountRow\")) .\n        \"', post_time = '\"  . trim($created_time) .\n        \"', post_user = '\" . trim($user_id)  .\n        \"', session_id = '\"    . trim(formData('payment_id')) .\n        \"', modified_time = '\"  . trim($created_time) .\n        \"', pay_amount = '\" . 0  .\n        \"', adj_amount = '\"    . 0 .\n        \"', memo = '\"    . \"Deductible $\" . trim(formData(\"Deductible$CountRow\")) .\n        \"', account_code = '\" . \"Deduct\"  .\n        \"'\");\n           sqlCommitTrans();\n          $Affected = 'yes';\n    }\n\n    if (!empty($_POST[\"Takeback$CountRow\"]) && (floatval($_POST[\"Takeback$CountRow\"] ?? null)) > 0) {\n         sqlBeginTrans();\n         $sequence_no = sqlQuery(\"SELECT IFNULL(MAX(sequence_no),0) + 1 AS increment FROM ar_activity WHERE pid = ? AND encounter = ?\", array(trim(formData('hidden_patient_code')), trim(formData(\"HiddenEncounter$CountRow\"))));\n        sqlStatement(\"insert into ar_activity set \"    .\n        \"pid = '\"       . trim(formData('hidden_patient_code')) .\n        \"', encounter = '\"     . trim(formData(\"HiddenEncounter$CountRow\"))  .\n        \"', sequence_no = '\"     . $sequence_no['increment']  .\n                \"', code_type = '\"      . trim(formData(\"HiddenCodetype$CountRow\"))  .\n        \"', code = '\"      . trim(formData(\"HiddenCode$CountRow\"))  .\n        \"', modifier = '\"      . trim(formData(\"HiddenModifier$CountRow\"))  .\n        \"', payer_type = '\"   . trim(formData(\"HiddenIns$CountRow\")) .\n        \"', post_time = '\"  . trim($created_time) .\n        \"', post_user = '\" . trim($user_id)  .\n        \"', session_id = '\"    . trim(formData('payment_id')) .\n        \"', modified_time = '\"  . trim($created_time) .\n        \"', pay_amount = '\" . trim(formData(\"Takeback$CountRow\")) * -1  .\n        \"', adj_amount = '\"    . 0 .\n        \"', account_code = '\" . \"Takeback\"  .\n        \"'\");\n           sqlCommitTrans();\n          $Affected = 'yes';\n    }\n\n    if (isset($_POST[\"FollowUp$CountRow\"]) && $_POST[\"FollowUp$CountRow\"] == 'y') {\n         sqlBeginTrans();\n         $sequence_no = sqlQuery(\"SELECT IFNULL(MAX(sequence_no),0) + 1 AS increment FROM ar_activity WHERE pid = ? AND encounter = ?\", array(trim(formData('hidden_patient_code')), trim(formData(\"HiddenEncounter$CountRow\"))));\n         sqlStatement(\"insert into ar_activity set \"    .\n        \"pid = '\"       . trim(formData('hidden_patient_code')) .\n        \"', encounter = '\"     . trim(formData(\"HiddenEncounter$CountRow\"))  .\n        \"', sequence_no = '\"     . $sequence_no['increment']  .\n                \"', code_type = '\"      . trim(formData(\"HiddenCodetype$CountRow\"))  .\n        \"', code = '\"      . trim(formData(\"HiddenCode$CountRow\"))  .\n        \"', modifier = '\"      . trim(formData(\"HiddenModifier$CountRow\"))  .\n        \"', payer_type = '\"   . trim(formData(\"HiddenIns$CountRow\")) .\n        \"', post_time = '\"  . trim($created_time) .\n        \"', post_user = '\" . trim($user_id)  .\n        \"', session_id = '\"    . trim(formData('payment_id')) .\n        \"', modified_time = '\"  . trim($created_time) .\n        \"', pay_amount = '\" . 0  .\n        \"', adj_amount = '\"    . 0 .\n        \"', follow_up = '\"    . \"y\" .\n        \"', follow_up_note = '\"    . trim(formData(\"FollowUpReason$CountRow\")) .\n        \"'\");\n           sqlCommitTrans();\n          $Affected = 'yes';\n    }\n\n    if ($Affected == 'yes') {\n        if (trim(formData('type_name')) != 'patient') {\n            $ferow = sqlQuery(\"select last_level_closed from form_encounter  where\n\t\tpid ='\" . trim(formData('hidden_patient_code')) . \"' and encounter='\" . trim(formData(\"HiddenEncounter$CountRow\")) . \"'\");\n              //multiple charges can come.\n            if ($ferow['last_level_closed'] < trim(formData(\"HiddenIns$CountRow\"))) {\n                //last_level_closed gets increased. unless a follow up is required.\n                // in which case we'll allow secondary to be re setup to current setup.\n                // just not advancing last closed.\n                $tmp = ((!empty($_POST[\"Payment$CountRow\"]) ? floatval($_POST[\"Payment$CountRow\"]) : null) + (!empty($_POST[\"AdjAmount$CountRow\"]) ? floatval($_POST[\"AdjAmount$CountRow\"]) : null));\n                if ((empty($_POST[\"FollowUp$CountRow\"]) || ($_POST[\"FollowUp$CountRow\"] != 'y')) && $tmp !== 0) {\n                    sqlStatement(\"update form_encounter set last_level_closed='\" .\n                        trim(formData(\"HiddenIns$CountRow\")) .\n                        \"' where pid ='\" . trim(formData('hidden_patient_code')) .\n                        \"' and encounter='\" . trim(formData(\"HiddenEncounter$CountRow\")) . \"'\");\n                }\n                  //-----------------------------------\n                  // Determine the next insurance level to be billed.\n                  $ferow = sqlQuery(\"SELECT date, last_level_closed \" .\n                    \"FROM form_encounter WHERE \" .\n                    \"pid = '\" . trim(formData('hidden_patient_code')) . \"' AND encounter = '\" . trim(formData(\"HiddenEncounter$CountRow\")) . \"'\");\n                  $date_of_service = substr($ferow['date'], 0, 10);\n                  $new_payer_type = 0 + $ferow['last_level_closed'];\n                if ($new_payer_type <= 3 && !empty($ferow['last_level_closed']) || $new_payer_type == 0) {\n                    ++$new_payer_type;\n                }\n\n                  $new_payer_id = SLEOB::arGetPayerID(trim(formData('hidden_patient_code')), $date_of_service, $new_payer_type);\n                if ($new_payer_id > 0) {\n                        SLEOB::arSetupSecondary(trim(formData('hidden_patient_code')), trim(formData(\"HiddenEncounter$CountRow\")), 0);\n                }\n\n                    //-----------------------------------\n            }\n        }\n    }\n}\n//===============================================================================\n  // Delete rows, with logging, for the specified table using the\n  // specified WHERE clause.  Borrowed from deleter.php.\n  //\nfunction row_delete($table, $where)\n{\n    $tres = sqlStatement(\"SELECT * FROM \" . escape_table_name($table) . \" WHERE $where\");\n    $count = 0;\n    while ($trow = sqlFetchArray($tres)) {\n        $logstring = \"\";\n        foreach ($trow as $key => $value) {\n            if (! $value || $value == '0000-00-00 00:00:00') {\n                continue;\n            }\n\n            if ($logstring) {\n                $logstring .= \" \";\n            }\n\n            $logstring .= $key . \"='\" . addslashes($value) . \"'\";\n        }\n\n        EventAuditLogger::instance()->newEvent(\"delete\", $_SESSION['authUser'], $_SESSION['authProvider'], 1, \"$table: $logstring\");\n        ++$count;\n    }\n\n    if ($count) {\n        $query = \"DELETE FROM \" . escape_table_name($table) . \" WHERE $where\";\n        sqlStatement($query);\n    }\n}\n\n// Deactivate rows, with logging, for the specified table using the\n// specified SET and WHERE clauses.  Borrowed from deleter.php.\n//\nfunction row_modify($table, $set, $where)\n{\n    if (sqlQuery(\"SELECT * FROM \" . escape_table_name($table) . \" WHERE $where\")) {\n        EventAuditLogger::instance()->newEvent(\n            \"deactivate\",\n            $_SESSION['authUser'],\n            $_SESSION['authProvider'],\n            1,\n            \"$table: $where\"\n        );\n        $query = \"UPDATE $table SET $set WHERE $where\";\n        sqlStatement($query);\n    }\n}\n\n//===============================================================================\n", "<?php\n\n/**\n *\n * Modified from interface/main/calendar/add_edit_event.php for\n * the patient portal.\n *\n * @package   OpenEMR\n * @link      http://www.open-emr.org\n * @author    Rod Roark <rod@sunsetsystems.com>\n * @author    Jerry Padgett <sjpadgett@gmail.com>\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (C) 2005-2006 Rod Roark <rod@sunsetsystems.com>\n * @copyright Copyright (C) 2016-2021 Jerry Padgett <sjpadgett@gmail.com>\n * @copyright Copyright (c) 2019 Brady Miller <brady.g.miller@gmail.com>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\n// Will start the (patient) portal OpenEMR session/cookie.\nrequire_once(__DIR__ . \"/../src/Common/Session/SessionUtil.php\");\nOpenEMR\\Common\\Session\\SessionUtil::portalSessionStart();\n\nrequire_once(\"./../library/pnotes.inc\");\n\n//landing page definition -- where to go if something goes wrong\n$landingpage = \"index.php?site=\" . urlencode($_SESSION['site_id']);\n//\n\n// kick out if patient not authenticated\nif (isset($_SESSION['pid']) && isset($_SESSION['patient_portal_onsite_two'])) {\n    $pid = $_SESSION['pid'];\n} else {\n    OpenEMR\\Common\\Session\\SessionUtil::portalSessionCookieDestroy();\n    header('Location: ' . $landingpage . '&w');\n    exit;\n}\n\n$ignoreAuth_onsite_portal = true;\nglobal $ignoreAuth_onsite_portal;\n\nrequire_once(\"../interface/globals.php\");\nrequire_once(\"$srcdir/patient.inc\");\nrequire_once(\"$srcdir/forms.inc\");\nrequire_once(\"$srcdir/appointments.inc.php\");\n\nuse OpenEMR\\Core\\Header;\n\n// Things that might be passed by our opener.\n//\n$eid = $_GET['eid'] ?? null;         // only for existing events\n$date = $_GET['date'] ?? null;        // this and below only for new events\n$userid = $_GET['userid'] ?? null;\n$default_catid = ($_GET['catid'] ?? null) ? $_GET['catid'] : '5';\n$patientid = $_GET['patid'] ?? null;\n//\n\n// did someone tamper with eid?\n$checkEidInAppt = false;\n$patient_appointments = fetchAppointments('1970-01-01', '2382-12-31', $_SESSION['pid']);\n$checkEidInAppt = array_search($eid, array_column($patient_appointments, 'pc_eid'));\n\nif (!empty($eid) && !$checkEidInAppt) {\n    echo js_escape(\"error\");\n    exit();\n}\n\nif ($date) {\n    $date = substr($date, 0, 4) . '-' . substr($date, 4, 2) . '-' . substr($date, 6);\n} else {\n    $date = date(\"Y-m-d\");\n}\n\n//\n$starttimem = '00';\nif (isset($_GET['starttimem'])) {\n    $starttimem = substr('00' . $_GET['starttimem'], -2);\n}\n\n//\nif (isset($_GET['starttimeh'])) {\n    $starttimeh = $_GET['starttimeh'];\n    if (isset($_GET['startampm'])) {\n        if ($_GET['startampm'] == '2' && $starttimeh < 12) {\n            $starttimeh += 12;\n        }\n    }\n} else {\n    $starttimeh = date(\"G\");\n}\n\n$startampm = '';\n\n$info_msg = \"\";\n\n// EVENTS TO FACILITIES (lemonsoftware)\n//(CHEMED) get facility name\n// edit event case - if there is no association made, then insert one with the first facility\nif ($eid) {\n    $selfacil = '';\n    $facility = sqlQuery(\"SELECT pc_facility, pc_multiple, pc_aid, facility.name\n                        FROM openemr_postcalendar_events\n                          LEFT JOIN facility ON (openemr_postcalendar_events.pc_facility = facility.id)\n                          WHERE pc_eid = ?\", array($eid));\n    if (!$facility['pc_facility']) {\n        $qmin = sqlQuery(\"SELECT facility_id as minId, facility FROM users WHERE id = ?\", array($facility['pc_aid']));\n        $min = $qmin['minId'];\n        $min_name = $qmin['facility'];\n\n        // multiple providers case\n        if ($GLOBALS['select_multi_providers']) {\n            $mul = $facility['pc_multiple'];\n            sqlStatement(\"UPDATE openemr_postcalendar_events SET pc_facility = ? WHERE pc_multiple = ?\", array($min, $mul));\n        }\n\n        // EOS multiple\n\n        sqlStatement(\"UPDATE openemr_postcalendar_events SET pc_facility = ? WHERE pc_eid = ?\", array($min, $eid));\n        $e2f = $min;\n        $e2f_name = $min_name;\n    } else {\n        $e2f = $facility['pc_facility'];\n        $e2f_name = $facility['name'];\n    }\n}\n\n// EOS E2F\n// ===========================\n\n\n// If we are saving, then save and close the window.\n//\nif (($_POST['form_action'] ?? null) == \"save\") {\n//print_r($_POST);\n//exit();\n    $event_date = fixDate($_POST['form_date']);\n\n// Compute start and end time strings to be saved.\n    if ($_POST['form_allday']) {\n        $tmph = 0;\n        $tmpm = 0;\n        $duration = 24 * 60;\n    } else {\n        $tmph = $_POST['form_hour'] + 0;\n        $tmpm = $_POST['form_minute'] + 0;\n        if ($_POST['form_ampm'] == '2' && $tmph < 12) {\n            $tmph += 12;\n        }\n\n        $duration = $_POST['form_duration'];\n    }\n\n    $starttime = \"$tmph:$tmpm:00\";\n//\n    $tmpm += $duration;\n    while ($tmpm >= 60) {\n        $tmpm -= 60;\n        ++$tmph;\n    }\n\n    $endtime = \"$tmph:$tmpm:00\";\n\n// Useless garbage that we must save.\n    $locationspec = 'a:6:{s:14:\"event_location\";N;s:13:\"event_street1\";N;' .\n        's:13:\"event_street2\";N;s:10:\"event_city\";N;s:11:\"event_state\";N;s:12:\"event_postal\";N;}';\n\n// More garbage, but this time 1 character of it is used to save the\n// repeat type.\n    if ($_POST['form_repeat']) {\n        $recurrspec = 'a:5:{' .\n            's:17:\"event_repeat_freq\";s:1:\"' . $_POST['form_repeat_freq'] . '\";' .\n            's:22:\"event_repeat_freq_type\";s:1:\"' . $_POST['form_repeat_type'] . '\";' .\n            's:19:\"event_repeat_on_num\";s:1:\"1\";' .\n            's:19:\"event_repeat_on_day\";s:1:\"0\";' .\n            's:20:\"event_repeat_on_freq\";s:1:\"0\";}';\n    } else {\n        $recurrspec = 'a:5:{' .\n            's:17:\"event_repeat_freq\";N;' .\n            's:22:\"event_repeat_freq_type\";s:1:\"0\";' .\n            's:19:\"event_repeat_on_num\";s:1:\"1\";' .\n            's:19:\"event_repeat_on_day\";s:1:\"0\";' .\n            's:20:\"event_repeat_on_freq\";s:1:\"1\";}';\n    }\n\n//The modification of the start date for events that take place on one day of the week\n//for example monday, or thursday. We set the start date on the first day of the week\n//that the event is scheduled. For example if you set the event to repeat on each monday\n//the start date of the event will be set on the first monday after the day the event is scheduled\n    if ($_POST['form_repeat_type'] == 5) {\n        $exploded_date = explode(\"-\", $event_date);\n        $edate = date(\"D\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2], $exploded_date[0]));\n        if ($edate == \"Tue\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 6, $exploded_date[0]));\n        } elseif ($edate == \"Wed\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 5, $exploded_date[0]));\n        } elseif ($edate == \"Thu\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 4, $exploded_date[0]));\n        } elseif ($edate == \"Fri\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 3, $exploded_date[0]));\n        } elseif ($edate == \"Sat\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 2, $exploded_date[0]));\n        } elseif ($edate == \"Sun\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 1, $exploded_date[0]));\n        }\n    } elseif ($_POST['form_repeat_type'] == 6) {\n        $exploded_date = explode(\"-\", $event_date);\n        $edate = date(\"D\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2], $exploded_date[0]));\n        if ($edate == \"Wed\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 6, $exploded_date[0]));\n        } elseif ($edate == \"Thu\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 5, $exploded_date[0]));\n        } elseif ($edate == \"Fri\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 4, $exploded_date[0]));\n        } elseif ($edate == \"Sat\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 3, $exploded_date[0]));\n        } elseif ($edate == \"Sun\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 2, $exploded_date[0]));\n        } elseif ($edate == \"Mon\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 1, $exploded_date[0]));\n        }\n    } elseif ($_POST['form_repeat_type'] == 7) {\n        $exploded_date = explode(\"-\", $event_date);\n        $edate = date(\"D\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2], $exploded_date[0]));\n        if ($edate == \"Thu\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 6, $exploded_date[0]));\n        } elseif ($edate == \"Fri\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 5, $exploded_date[0]));\n        } elseif ($edate == \"Sat\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 4, $exploded_date[0]));\n        } elseif ($edate == \"Sun\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 3, $exploded_date[0]));\n        } elseif ($edate == \"Mon\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 2, $exploded_date[0]));\n        } elseif ($edate == \"Tue\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 1, $exploded_date[0]));\n        }\n    } elseif ($_POST['form_repeat_type'] == 8) {\n        $exploded_date = explode(\"-\", $event_date);\n        $edate = date(\"D\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2], $exploded_date[0]));\n        if ($edate == \"Fri\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 6, $exploded_date[0]));\n        } elseif ($edate == \"Sat\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 5, $exploded_date[0]));\n        } elseif ($edate == \"Sun\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 4, $exploded_date[0]));\n        } elseif ($edate == \"Mon\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 3, $exploded_date[0]));\n        } elseif ($edate == \"Tue\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 2, $exploded_date[0]));\n        } elseif ($edate == \"Wed\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 1, $exploded_date[0]));\n        }\n    } elseif ($_POST['form_repeat_type'] == 9) {\n        $exploded_date = explode(\"-\", $event_date);\n        $edate = date(\"D\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2], $exploded_date[0]));\n        if ($edate == \"Sat\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 6, $exploded_date[0]));\n        } elseif ($edate == \"Sun\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 5, $exploded_date[0]));\n        } elseif ($edate == \"Mon\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 4, $exploded_date[0]));\n        } elseif ($edate == \"Tue\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 3, $exploded_date[0]));\n        } elseif ($edate == \"Wed\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 2, $exploded_date[0]));\n        } elseif ($edate == \"Thu\") {\n            $event_date = date(\"Y-m-d\", mktime(0, 0, 0, $exploded_date[1], $exploded_date[2] + 1, $exploded_date[0]));\n        }\n    }//if end\n    /* =======================================================\n    //                                  UPDATE EVENTS\n    ========================================================*/\n    if ($eid) {\n        // what is multiple key around this $eid?\n        $row = sqlQuery(\"SELECT pc_multiple FROM openemr_postcalendar_events WHERE pc_eid = ?\", array($eid));\n\n        if ($GLOBALS['select_multi_providers'] && $row['pc_multiple']) {\n            /* ==========================================\n            // multi providers BOS\n            ==========================================*/\n\n            // obtain current list of providers regarding the multiple key\n            $up = sqlStatement(\"SELECT pc_aid FROM openemr_postcalendar_events WHERE pc_multiple = ?\", array($row['pc_multiple']));\n            while ($current = sqlFetchArray($up)) {\n                $providers_current[] = $current['pc_aid'];\n            }\n\n            $providers_new = $_POST['form_provider_ae'];\n\n            // this difference means that some providers from current was UNCHECKED\n            // so we must delete this event for them\n            $r1 = array_diff($providers_current, $providers_new);\n            if (count($r1)) {\n                foreach ($r1 as $to_be_removed) {\n                    sqlQuery(\"DELETE FROM openemr_postcalendar_events WHERE pc_aid = ? AND pc_multiple = ?\", array($to_be_removed, $row['pc_multiple']));\n                }\n            }\n\n            // this difference means that some providers was added\n            // so we must insert this event for them\n            $r2 = array_diff($providers_new, $providers_current);\n            if (count($r2)) {\n                foreach ($r2 as $to_be_inserted) {\n                    sqlStatement(\"INSERT INTO openemr_postcalendar_events ( pc_catid, pc_multiple, pc_aid, pc_pid, pc_title, pc_time, pc_hometext, pc_informant, pc_eventDate, pc_endDate, pc_duration, pc_recurrtype, pc_recurrspec, pc_startTime, pc_endTime, pc_alldayevent, pc_apptstatus, pc_prefcatid, pc_location, pc_eventstatus, pc_sharing, pc_facility)\n            VALUES ( \" .\n                        \"'\" . add_escape_custom($_POST['form_category']) . \"', \" .\n                        \"'\" . add_escape_custom($row['pc_multiple']) . \"', \" .\n                        \"'\" . add_escape_custom($to_be_inserted) . \"', \" .\n                        \"'\" . add_escape_custom($_POST['form_pid']) . \"', \" .\n                        \"'\" . add_escape_custom($_POST['form_title']) . \"', \" .\n                        \"NOW(), \" .\n                        \"'\" . add_escape_custom($_POST['form_comments']) . \"', \" .\n                        \"'\" . add_escape_custom($_SESSION['providerId']) . \"', \" .\n                        \"'\" . add_escape_custom($event_date) . \"', \" .\n                        \"'\" . add_escape_custom(fixDate($_POST['form_enddate'])) . \"', \" .\n                        \"'\" . add_escape_custom(($duration * 60)) . \"', \" .\n                        \"'\" . ($_POST['form_repeat'] ? '1' : '0') . \"', \" .\n                        \"'\" . add_escape_custom($recurrspec) . \"', \" .\n                        \"'\" . add_escape_custom($starttime) . \"', \" .\n                        \"'\" . add_escape_custom($endtime) . \"', \" .\n                        \"'\" . add_escape_custom($_POST['form_allday']) . \"', \" .\n                        \"'\" . add_escape_custom($_POST['form_apptstatus']) . \"', \" .\n                        \"'\" . add_escape_custom($_POST['form_prefcat']) . \"', \" .\n                        \"'\" . add_escape_custom($locationspec) . \"', \" .\n                        \"1, \" .\n                        \"1, \" . (int)$_POST['facility'] . \" )\"); // FF stuff\n                } // foreach\n            } //if count\n\n\n            // after the two diffs above, we must update for remaining providers\n            // those who are intersected in $providers_current and $providers_new\n            foreach ($_POST['form_provider_ae'] as $provider) {\n                sqlStatement(\"UPDATE openemr_postcalendar_events SET \" .\n                    \"pc_catid = '\" . add_escape_custom($_POST['form_category']) . \"', \" .\n                    \"pc_pid = '\" . add_escape_custom($_POST['form_pid']) . \"', \" .\n                    \"pc_title = '\" . add_escape_custom($_POST['form_title']) . \"', \" .\n                    \"pc_time = NOW(), \" .\n                    \"pc_hometext = '\" . add_escape_custom($_POST['form_comments']) . \"', \" .\n                    \"pc_informant = '\" . add_escape_custom($_SESSION['providerId']) . \"', \" .\n                    \"pc_eventDate = '\" . add_escape_custom($event_date) . \"', \" .\n                    \"pc_endDate = '\" . add_escape_custom(fixDate($_POST['form_enddate'])) . \"', \" .\n                    \"pc_duration = '\" . add_escape_custom(($duration * 60)) . \"', \" .\n                    \"pc_recurrtype = '\" . ($_POST['form_repeat'] ? '1' : '0') . \"', \" .\n                    \"pc_recurrspec = '\" . add_escape_custom($recurrspec) . \"', \" .\n                    \"pc_startTime = '\" . add_escape_custom($starttime) . \"', \" .\n                    \"pc_endTime = '\" . add_escape_custom($endtime) . \"', \" .\n                    \"pc_alldayevent = '\" . add_escape_custom($_POST['form_allday']) . \"', \" .\n                    \"pc_apptstatus = '\" . add_escape_custom($_POST['form_apptstatus']) . \"', \" .\n                    \"pc_prefcatid = '\" . add_escape_custom($_POST['form_prefcat']) . \"', \" .\n                    \"pc_facility = '\" . (int)$_POST['facility'] . \"' \" . // FF stuff\n                    \"WHERE pc_aid = '\" . add_escape_custom($provider) . \"' AND pc_multiple='\" . add_escape_custom($row['pc_multiple']) . \"'\");\n            } // foreach\n\n            /* ==========================================\n          // multi providers EOS\n            ==========================================*/\n        } elseif (!$row['pc_multiple']) {\n            if ($GLOBALS['select_multi_providers']) {\n                $prov = $_POST['form_provider_ae'][0];\n            } else {\n                $prov = $_POST['form_provider_ae'];\n            }\n            $insert = false;\n            // simple provider case\n            sqlStatement(\"UPDATE openemr_postcalendar_events SET \" .\n                \"pc_catid = '\" . add_escape_custom($_POST['form_category']) . \"', \" .\n                \"pc_aid = '\" . add_escape_custom($prov) . \"', \" .\n                \"pc_pid = '\" . add_escape_custom($_POST['form_pid']) . \"', \" .\n                \"pc_title = '\" . add_escape_custom($_POST['form_title']) . \"', \" .\n                \"pc_time = NOW(), \" .\n                \"pc_hometext = '\" . add_escape_custom($_POST['form_comments']) . \"', \" .\n                \"pc_informant = '\" . add_escape_custom($_SESSION['providerId']) . \"', \" .\n                \"pc_eventDate = '\" . add_escape_custom($event_date) . \"', \" .\n                \"pc_endDate = '\" . add_escape_custom(fixDate($_POST['form_enddate'])) . \"', \" .\n                \"pc_duration = '\" . add_escape_custom(($duration * 60)) . \"', \" .\n                \"pc_recurrtype = '\" . ($_POST['form_repeat'] ? '1' : '0') . \"', \" .\n                \"pc_recurrspec = '\" . add_escape_custom($recurrspec) . \"', \" .\n                \"pc_startTime = '\" . add_escape_custom($starttime) . \"', \" .\n                \"pc_endTime = '\" . add_escape_custom($endtime) . \"', \" .\n                \"pc_alldayevent = '\" . add_escape_custom($_POST['form_allday']) . \"', \" .\n                \"pc_apptstatus = '\" . add_escape_custom($_POST['form_apptstatus']) . \"', \" .\n                \"pc_prefcatid = '\" . add_escape_custom($_POST['form_prefcat']) . \"', \" .\n                \"pc_facility = '\" . (int)$_POST['facility'] . \"' \" . // FF stuff\n                \"WHERE pc_eid = '\" . add_escape_custom($eid) . \"'\");\n        }\n\n        // =======================================\n        // EOS multi providers case\n        // =======================================\n\n        // EVENTS TO FACILITIES\n\n        $e2f = (int)$eid;\n\n        /* =======================================================\n      //                                  INSERT EVENTS\n        ========================================================*/\n    } else {\n        // =======================================\n        // multi providers case\n        // =======================================\n\n        if (is_array($_POST['form_provider_ae'])) {\n            // obtain the next available unique key to group multiple providers around some event\n            $q = sqlStatement(\"SELECT MAX(pc_multiple) as max FROM openemr_postcalendar_events\");\n            $max = sqlFetchArray($q);\n            $new_multiple_value = $max['max'] + 1;\n\n            foreach ($_POST['form_provider_ae'] as $provider) {\n                sqlStatement(\"INSERT INTO openemr_postcalendar_events ( \" .\n                    \"pc_catid, pc_multiple, pc_aid, pc_pid, pc_title, pc_time, pc_hometext, \" .\n                    \"pc_informant, pc_eventDate, pc_endDate, pc_duration, pc_recurrtype, \" .\n                    \"pc_recurrspec, pc_startTime, pc_endTime, pc_alldayevent, \" .\n                    \"pc_apptstatus, pc_prefcatid, pc_location, pc_eventstatus, pc_sharing, pc_facility \" .\n                    \") VALUES ( \" .\n                    \"'\" . add_escape_custom($_POST['form_category']) . \"', \" .\n                    \"'\" . add_escape_custom($new_multiple_value) . \"', \" .\n                    \"'\" . add_escape_custom($provider) . \"', \" .\n                    \"'\" . add_escape_custom($_POST['form_pid']) . \"', \" .\n                    \"'\" . add_escape_custom($_POST['form_title']) . \"', \" .\n                    \"NOW(), \" .\n                    \"'\" . add_escape_custom($_POST['form_comments']) . \"', \" .\n                    \"'\" . add_escape_custom($_SESSION['providerId']) . \"', \" .\n                    \"'\" . add_escape_custom($event_date) . \"', \" .\n                    \"'\" . add_escape_custom(fixDate($_POST['form_enddate'])) . \"', \" .\n                    \"'\" . add_escape_custom(($duration * 60)) . \"', \" .\n                    \"'\" . ($_POST['form_repeat'] ? '1' : '0') . \"', \" .\n                    \"'\" . add_escape_custom($recurrspec) . \"', \" .\n                    \"'\" . add_escape_custom($starttime) . \"', \" .\n                    \"'\" . add_escape_custom($endtime) . \"', \" .\n                    \"'\" . add_escape_custom($_POST['form_allday']) . \"', \" .\n                    \"'\" . add_escape_custom($_POST['form_apptstatus']) . \"', \" .\n                    \"'\" . add_escape_custom($_POST['form_prefcat']) . \"', \" .\n                    \"'\" . add_escape_custom($locationspec) . \"', \" .\n                    \"1, \" .\n                    \"1, \" . (int)$_POST['facility'] . \" )\"); // FF stuff\n            } // foreach\n        } else {\n            $_POST['form_apptstatus'] = '^';\n            $insert = true;\n            sqlStatement(\"INSERT INTO openemr_postcalendar_events ( \" .\n                \"pc_catid, pc_aid, pc_pid, pc_title, pc_time, pc_hometext, \" .\n                \"pc_informant, pc_eventDate, pc_endDate, pc_duration, pc_recurrtype, \" .\n                \"pc_recurrspec, pc_startTime, pc_endTime, pc_alldayevent, \" .\n                \"pc_apptstatus, pc_prefcatid, pc_location, pc_eventstatus, pc_sharing, pc_facility \" .\n                \") VALUES ( \" .\n                \"'\" . add_escape_custom($_POST['form_category']) . \"', \" .\n                \"'\" . add_escape_custom($_POST['form_provider_ae']) . \"', \" .\n                \"'\" . add_escape_custom($_POST['form_pid']) . \"', \" .\n                \"'\" . add_escape_custom($_POST['form_title']) . \"', \" .\n                \"NOW(), \" .\n                \"'\" . add_escape_custom($_POST['form_comments']) . \"', \" .\n                \"'\" . add_escape_custom($_SESSION['providerId']) . \"', \" .\n                \"'\" . add_escape_custom($event_date) . \"', \" .\n                \"'\" . add_escape_custom(fixDate($_POST['form_enddate'])) . \"', \" .\n                \"'\" . add_escape_custom(($duration * 60)) . \"', \" .\n                \"'\" . ($_POST['form_repeat'] ? '1' : '0') . \"', \" .\n                \"'\" . add_escape_custom($recurrspec) . \"', \" .\n                \"'\" . add_escape_custom($starttime) . \"', \" .\n                \"'\" . add_escape_custom($endtime) . \"', \" .\n                \"'\" . add_escape_custom($_POST['form_allday']) . \"', \" .\n                \"'\" . add_escape_custom($_POST['form_apptstatus']) . \"', \" .\n                \"'\" . add_escape_custom($_POST['form_prefcat']) . \"', \" .\n                \"'\" . add_escape_custom($locationspec) . \"', \" .\n                \"1, \" .\n                \"1, \" . (int)$_POST['facility'] . \")\"); // FF stuff\n        } // INSERT single\n    } // else - insert\n} elseif (($_POST['form_action'] ?? null) == \"delete\") {\n// =======================================\n//  multi providers case\n// =======================================\n    if ($GLOBALS['select_multi_providers']) {\n        // what is multiple key around this $eid?\n        $row = sqlQuery(\"SELECT pc_multiple FROM openemr_postcalendar_events WHERE pc_eid = ?\", array($eid));\n        if ($row['pc_multiple']) {\n            sqlStatement(\"DELETE FROM openemr_postcalendar_events WHERE pc_multiple = ?\", array($row['pc_multiple']));\n        } else {\n            sqlStatement(\"DELETE FROM openemr_postcalendar_events WHERE pc_eid = ?\", array($eid));\n        }\n\n        // =======================================\n        //  EOS multi providers case\n        // =======================================\n    } else {\n        sqlStatement(\"DELETE FROM openemr_postcalendar_events WHERE pc_eid = ?\", array($eid));\n    }\n}\n\nif (!empty($_POST['form_action'])) {\n    // Leave\n    $type = $insert ? xl(\"A New Appointment\") : xl(\"An Updated Appointment\");\n    $note = $type . \" \" . xl(\"request was received from portal patient\") . \" \";\n    $note .= $_SESSION['ptName'] . \" \" . xl(\"regarding appointment dated\") . \" \" . $event_date . \" \" . $starttime . \". \";\n    $note .= !empty($_POST['form_comments']) ? (xl(\"Reason\") . \" \" . $_POST['form_comments']) : \"\";\n    $note .= \". \" . xl(\"Use Portal Dashboard to confirm with patient.\");\n    $title = xl(\"Patient Reminders\");\n    $user = sqlQueryNoLog(\"SELECT users.username FROM users WHERE authorized = 1 And id = ?\", array($_POST['form_provider_ae']));\n    $rtn = addPnote($_POST['form_pid'], $note, 1, 1, $title, $user['username'], '', 'New');\n\n    $_SESSION['whereto'] = '#appointmentcard';\n    header('Location:./home.php');\n    exit();\n}\n\n// If we get this far then we are displaying the form.\n\n$statuses = array(\n    '-' => '',\n    '*' => xl('* Reminder done'),\n    '+' => xl('+ Chart pulled'),\n    'x' => xl('x Cancelled'), // added Apr 2008 by JRM\n    '?' => xl('? No show'),\n    '@' => xl('@ Arrived'),\n    '~' => xl('~ Arrived late'),\n    '!' => xl('! Left w/o visit'),\n    '#' => xl('# Ins/fin issue'),\n    '<' => xl('< In exam room'),\n    '>' => xl('> Checked out'),\n    '$' => xl('$ Coding done'),\n    '^' => xl('^ Pending'),\n);\n\n$repeats = 0; // if the event repeats\n$repeattype = '0';\n$repeatfreq = '0';\n$patienttitle = \"\";\n$hometext = \"\";\n$row = array();\n\n// If we are editing an existing event, then get its data.\nif ($eid) {\n    $row = sqlQuery(\"SELECT * FROM openemr_postcalendar_events WHERE pc_eid = ?\", array($eid));\n    $date = $row['pc_eventDate'];\n    $userid = $row['pc_aid'];\n    $patientid = $row['pc_pid'];\n    $starttimeh = substr($row['pc_startTime'], 0, 2) + 0;\n    $starttimem = substr($row['pc_startTime'], 3, 2);\n    $repeats = $row['pc_recurrtype'];\n    $multiple_value = $row['pc_multiple'];\n\n    if (preg_match('/\"event_repeat_freq_type\";s:1:\"(\\d)\"/', $row['pc_recurrspec'], $matches)) {\n        $repeattype = $matches[1];\n    }\n\n    if (preg_match('/\"event_repeat_freq\";s:1:\"(\\d)\"/', $row['pc_recurrspec'], $matches)) {\n        $repeatfreq = $matches[1];\n    }\n\n    $hometext = $row['pc_hometext'];\n    if (substr($hometext, 0, 6) == ':text:') {\n        $hometext = substr($hometext, 6);\n    }\n} else {\n    $patientid = $_GET['pid'];\n}\n\n// If we have a patient ID, get the name and phone numbers to display.\nif ($patientid) {\n    $prow = sqlQuery(\"SELECT lname, fname, phone_home, phone_biz, DOB \" .\n        \"FROM patient_data WHERE pid = ?\", array($patientid));\n    $patientname = $prow['lname'] . \", \" . $prow['fname'];\n    if ($prow['phone_home']) {\n        $patienttitle .= \" H=\" . $prow['phone_home'];\n    }\n\n    if ($prow['phone_biz']) {\n        $patienttitle .= \" W=\" . $prow['phone_biz'];\n    }\n}\n\n// Get the providers list.\n$ures = sqlStatement(\"SELECT `id`, `username`, `fname`, `lname`, `mname` FROM `users` WHERE \" .\n    \"`authorized` != 0 AND `active` = 1 AND `username` > '' ORDER BY `lname`, `fname`\");\n\n//Set default facility for a new event based on the given 'userid'\nif ($userid) {\n    $pref_facility = sqlFetchArray(sqlStatement(\"SELECT facility_id, facility FROM users WHERE id = ?\", array($userid)));\n    $e2f = $pref_facility['facility_id'];\n    $e2f_name = $pref_facility['facility'];\n}\n?>\n<!DOCTYPE html>\n<html>\n<head>\n    <title><?php echo $eid ? xlt(\"Edit Event\") : xlt(\"Add New Event\"); ?></title>\n    <?php // no header necessary. scope is home.php ?>\n</head>\n<script>\n    var durations = Array();\n    <?php\n    // Read the event categories, generate their options list, and get\n    // the default event duration from them if this is a new event.\n    $cattype = 0;\n\n    // Get event categories.\n    $cres = sqlStatement(\"SELECT pc_catid, pc_cattype, pc_catname, \" .\n        \"pc_recurrtype, pc_duration, pc_end_all_day \" .\n        \"FROM openemr_postcalendar_categories where pc_active = 1 ORDER BY pc_seq\");\n    $catoptions = \"\";\n    $prefcat_options = \"    <option value='0'>-- \" . xlt(\"None{{Category}}\") . \" --</option>\\n\";\n    $thisduration = 0;\n    if ($eid) {\n        $thisduration = $row['pc_alldayevent'] ? 1440 : round($row['pc_duration'] / 60);\n    }\n    while ($crow = sqlFetchArray($cres)) {\n        $duration = round($crow['pc_duration'] / 60);\n        if ($crow['pc_end_all_day']) {\n            $duration = 1440;\n        }\n\n        // This section is to build the list of preferred categories:\n        if ($duration) {\n            $prefcat_options .= \" <option value='\" . attr($crow['pc_catid']) . \"'\";\n            if ($eid) {\n                if ($crow['pc_catid'] == $row['pc_prefcatid']) {\n                    $prefcat_options .= \" selected\";\n                }\n            }\n\n            $prefcat_options .= \">\" . text(xl_appt_category($crow['pc_catname'])) . \"</option>\\n\";\n        }\n\n        if ($crow['pc_cattype'] != $cattype) {\n            continue;\n        }\n\n        echo \" durations[\" . attr($crow['pc_catid']) . \"] = \" . attr($duration) . \";\\n\";\n        // echo \" rectypes[\" . $crow['pc_catid'] . \"] = \" . $crow['pc_recurrtype'] . \"\\n\";\n        $catoptions .= \"    <option value='\" . attr($crow['pc_catid']) . \"'\";\n        if ($eid) {\n            if ($crow['pc_catid'] == $row['pc_catid']) {\n                $catoptions .= \" selected\";\n            }\n        } else {\n            if ($crow['pc_catid'] == $default_catid) {\n                $catoptions .= \" selected\";\n                $thisduration = $duration;\n            }\n        }\n\n        $catoptions .= \">\" . text(xl_appt_category($crow['pc_catname'])) . \"</option>\\n\";\n    }\n    // Fix up the time format for AM/PM.\n    $startampm = '1';\n    if ($starttimeh >= 12) { // p.m. starts at noon and not 12:01\n        $startampm = '2';\n        if ($starttimeh > 12) {\n            $starttimeh -= 12;\n        }\n    }\n\n    ?>\n</script>\n<body class=\"skin-blue\">\n    <div class=\"container-fluid\">\n        <form method='post' name='theaddform' id='theaddform' action='add_edit_event_user.php?eid=<?php echo attr_url($eid); ?>'>\n            <div class=\"col-12\">\n                <input type=\"hidden\" name=\"form_action\" id=\"form_action\" value=\"\" />\n                <input type='hidden' name='form_title' id='form_title' value='<?php echo $row['pc_catid'] ? attr($row['pc_title']) : xla(\"Office Visit\"); ?>' />\n                <input type='hidden' name='form_apptstatus' id='form_apptstatus' value='<?php echo $row['pc_apptstatus'] ? attr($row['pc_apptstatus']) : \"^\" ?>' />\n                <div class=\"row form-group\">\n                    <div class=\"input-group col-12 col-md-6\">\n                        <label class=\"mr-2\" for=\"form_category\"><?php echo xlt('Visit'); ?>:</label>\n                        <select class=\"form-control mb-1\" onchange='set_category()' id='form_category' name='form_category' value='<?php echo ($row['pc_catid'] > \"\") ? attr($row['pc_catid']) : '5'; ?>'>\n                            <?php echo $catoptions ?>\n                        </select>\n                    </div>\n                    <div class=\"input-group col-12 col-md-6\">\n                        <label class=\"mr-2\" for=\"form_date\"><?php echo xlt('Date'); ?>:</label>\n                        <input class=\"form-control mb-1\" type='text' name='form_date' readonly id='form_date' value='<?php echo (isset($eid) && $eid) ? attr($row['pc_eventDate']) : attr($date); ?>' />\n                    </div>\n                </div>\n                <div class=\"row\">\n                    <div class=\"form-group form-inline col-12\">\n                        <div class=\"input-group mb-1\">\n                            <label class=\"mr-2\"><?php echo xlt('Time'); ?>:</label>\n                            <input class=\"form-control col-2 col-md-3\" type='text' name='form_hour' size='2' value='<?php echo (isset($eid)) ? $starttimeh : ''; ?>' title='<?php echo xla('Event start time'); ?>' readonly />\n                            <input class=\"form-control col-2 col-md-3\" type='text' name='form_minute' size='2' value='<?php echo (isset($eid)) ? $starttimem : ''; ?>' title='<?php echo xla('Event start time'); ?>' readonly />\n                            <select class=\"form-control col-3 col-md-4\" name='form_ampm' title='Note: 12:00 noon is PM, not AM' readonly>\n                                <option value='1'><?php echo xlt('AM'); ?></option>\n                                <option value='2'<?php echo ($startampm == '2') ? \" selected\" : \"\"; ?>><?php echo xlt('PM'); ?></option>\n                            </select>\n                        </div>\n                        <div class=\"input-group\">\n                            <label class=\"mr-2\" for=\"form_duration\"><?php echo xlt('Duration'); ?></label>\n                            <input class=\"form-control\" type='text' size='1' id='form_duration' name='form_duration' value='<?php echo $row['pc_duration'] ? ($row['pc_duration'] * 1 / 60) : attr($thisduration) ?>' readonly />\n                            <span class=\"input-group-append\">\n                            <span class=\"input-group-text\"><?php echo \"&nbsp;\" . xlt('minutes'); ?></span>\n                        </span>\n                        </div>\n                    </div>\n                </div>\n                <div class=\"row\">\n                    <div class=\"input-group col-12 mb-1\">\n                        <label class=\"mr-2\" for=\"form_patient\"><?php echo xlt('Patient'); ?>:</label>\n                        <input class=\"form-control\" type='text' id='form_patient' name='form_patient' value='<?php echo attr($patientname); ?>' title='Patient' readonly />\n                        <input type='hidden' name='form_pid' value='<?php echo attr($patientid); ?>' />\n                    </div>\n                </div>\n                <div class=\"row\">\n                    <div class=\"input-group col-12 mb-1\">\n                        <label class=\"mr-2\" for=\"form_provider_ae\"><?php echo xlt('Provider'); ?>:</label>\n                        <select class=\"form-control\" name='form_provider_ae' id='form_provider_ae' onchange='change_provider();'>\n                            <?php\n                            // present a list of providers to choose from\n                            // default to the currently logged-in user\n                            while ($urow = sqlFetchArray($ures)) {\n                                echo \"<option value='\" . attr($urow['id']) . \"'\";\n                                if (($urow['id'] == ($_GET['userid'] ?? null)) || ($urow['id'] == $userid)) {\n                                    echo \" selected\";\n                                }\n                                echo \">\" . text($urow['lname']);\n                                if ($urow['fname']) {\n                                    echo \", \" . text($urow['fname']);\n                                }\n                                echo \"</option>\\n\";\n                            }\n                            ?>\n                        </select>\n                        <div class=\"text-right\">\n                            <input type='button' class='btn btn-success' value='<?php echo xla('Openings'); ?>' onclick='find_available()' />\n                        </div>\n                    </div>\n                </div>\n                <div class=\"row\">\n                    <div class=\"input-group col-12\">\n                        <label class=\"mr-2\"><?php echo xlt('Reason'); ?>:</label>\n                        <input class=\"form-control\" type='text' size='40' name='form_comments' value='<?php echo attr($hometext); ?>' title='<?php echo xla('Optional information about this event'); ?>' />\n                    </div>\n                </div>\n                <div class=\"row input-group my-1\">\n                    <?php if ($_GET['eid'] && $row['pc_apptstatus'] !== 'x') { ?>\n                        <input type='button' id='form_cancel' class='btn btn-danger' onsubmit='return false' value='<?php echo xla('Cancel Appointment'); ?>' onclick=\"cancel_appointment()\" />\n                    <?php } ?>\n                    <input type='button' name='form_save' class='btn btn-success' onsubmit='return false' value='<?php echo xla('Save'); ?>' onclick=\"validate()\" />\n                </div>\n            </div>\n        </form>\n        <script>\n            function change_provider() {\n                var f = document.forms.namedItem(\"theaddform\");\n                f.form_date.value = '';\n                f.form_hour.value = '';\n                f.form_minute.value = '';\n            }\n\n            function set_display() {\n                var f = document.forms.namedItem(\"theaddform\");\n                var si = document.getElementById('form_category');\n                if (si.selectedIndex >= 0) {\n                    var catid = si.options[si.selectedIndex].value;\n                    //var style_apptstatus = document.getElementById('title_apptstatus').style;\n                    //var style_prefcat = document.getElementById('title_prefcat').style;\n                    // will keep this for future. not needed now.\n                }\n            }\n\n            function cancel_appointment() {\n                let f = document.forms.namedItem(\"theaddform\");\n                let msg = <?php echo xlj(\"Click Okay if you are sure you want to cancel this appointment?\") . \"\\n\" .\n                    xlj(\"It is prudent to follow up with provider if not contacted.\") ?>;\n                let msg_reason = <?php echo xlj(\"You must enter a reason to cancel this appointment?\") . \"\\n\" .\n                    xlj(\"Reason must be at least 10 characters!\") ?>;\n                if (f.form_comments.value.length <= 10) {\n                    alert(msg_reason);\n                    return false;\n                }\n                let yn = confirm(msg);\n                if (!yn) {\n                    return false;\n                }\n                document.getElementById('form_apptstatus').value = \"x\";\n                validate();\n            }\n\n            // Do whatever is needed when a new event category is selected.\n            // For now this means changing the event title and duration.\n            function set_category() {\n                var f = document.forms.namedItem(\"theaddform\");\n                var s = f.form_category;\n                if (s.selectedIndex >= 0) {\n                    var catid = s.options[s.selectedIndex].value;\n                    f.form_title.value = s.options[s.selectedIndex].text;\n                    f.form_duration.value = durations[catid];\n                    set_display();\n                }\n            }\n\n            // This is for callback by the find-available popup.\n            function setappt(year, mon, mday, hours, minutes) {\n                var f = document.forms.namedItem(\"theaddform\");\n                f.form_date.value = '' + year + '-' +\n                    ('' + (mon + 100)).substring(1) + '-' +\n                    ('' + (mday + 100)).substring(1);\n                f.form_ampm.selectedIndex = (hours > 12) ? 1 : 0;\n                if (hours == 0) {\n                    f.form_hour.value = 12;\n                } else {\n                    f.form_hour.value = (hours >= 13) ? hours - 12 : hours;\n                }\n                f.form_minute.value = minutes;\n            }\n\n            function get_form_category_value() {\n                var catid = 0;\n                var f = document.forms.namedItem(\"theaddform\");\n                var s = f.form_category;\n                if (s.selectedIndex >= 0) {\n                    catid = s.options[s.selectedIndex].value;\n                }\n                return catid;\n            }\n\n            // Invoke the find-available popup.\n            function find_available() {\n                // when making an appointment for a specific provider\n                var catId = get_form_category_value() || 5;\n                var se = document.getElementById('form_provider_ae');\n                <?php if ($userid != 0) { ?>\n                s = se.value;\n                <?php } else {?>\n                s = se.options[se.selectedIndex].value;\n                <?php }?>\n                var formDate = document.getElementById('form_date');\n                var url = 'find_appt_popup_user.php?bypatient&providerid=' + encodeURIComponent(s) + '&catid=' + encodeURIComponent(catId)\n                    + '&startdate=' + encodeURIComponent(formDate.value);\n                var params = {\n                    buttons: [\n                        {text: <?php echo xlj('Cancel'); ?>, close: true, style: 'danger btn-sm'}\n\n                    ],\n                    allowResize: true,\n                    dialogId: 'apptDialog',\n                    type: 'iframe'\n                };\n                dlgopen(url, 'apptFind', 'modal-md', 300, '', 'Find Date', params);\n            }\n\n            // Check for errors when the form is submitted.\n            function validate() {\n                var f = document.getElementById('theaddform');\n                if (!f.form_date.value || !f.form_hour.value || !f.form_minute.value) {\n                    alert(<?php echo xlj('Please click on Openings to select a time.'); ?>);\n                    return false;\n                }\n\n                if (f.form_patient.value == '') {\n                    alert(<?php echo xlj('Your Id is missing. Cancel and try again.'); ?>);\n                    return false;\n                }\n\n                var form_action = document.getElementById('form_action');\n                form_action.value = \"save\";\n                f.submit();\n                return false;\n            }\n\n            <?php if ($eid) { ?>\n            set_display();\n            <?php } ?>\n            $(function () {\n\n            });\n        </script>\n    </div>\n</body>\n</html>\n", "<?php\n\n/**\n * PatientTrackerService Handles the select, create, and update of patient events that we are track.  This is used typically\n * in the patient flow board and for patient reporting.\n *\n * Much of this code was refactored from the patient_tracker.inc.php file.\n *\n * @package openemr\n * @link      http://www.open-emr.org\n * @author    Stephen Nielson <stephen@nielson.org>\n * @author    Terry Hill <terry@lillysystems.com>\n * @copyright Copyright (C) 2015 Terry Hill <terry@lillysystems.com>\n * @copyright Copyright (c) 2021 Stephen Nielson <stephen@nielson.org>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\nnamespace OpenEMR\\Services;\n\nuse OpenEMR\\Events\\Services\\ServiceSaveEvent;\n\nclass PatientTrackerService extends BaseService\n{\n    const TABLE_NAME = \"patient_tracker\";\n    const TABLE_NAME_TRACKER_ELEMENT = \"patient_tracker_element\";\n\n    public function __construct()\n    {\n        parent::__construct(self::TABLE_NAME);\n    }\n\n    /**\n     * @param $tracker_from_time\n     * @param $tracker_to_time\n     * @param bool $allow_sec\n     * @return string\n     */\n    public function get_Tracker_Time_Interval($tracker_from_time, $tracker_to_time, $allow_sec = false)\n    {\n\n        $tracker_time_calc = strtotime($tracker_to_time) - strtotime($tracker_from_time);\n\n        $tracker_time = \"\";\n        if ($tracker_time_calc > 60 * 60 * 24) {\n            $days = floor($tracker_time_calc / 60 / 60 / 24);\n            if ($days >= 2) {\n                $tracker_time .=  \"$days \" . xl('days');\n            } else {\n                $tracker_time .=  \"$days \" . xl('day');\n            }\n\n            $tracker_time_calc = $tracker_time_calc - ($days * (60 * 60 * 24));\n        }\n\n        if ($tracker_time_calc > 60 * 60) {\n            $hours = floor($tracker_time_calc / 60 / 60);\n            if (strlen($days != 0)) {\n                if ($hours >= 2) {\n                    $tracker_time .=  \", $hours \" . xl('hours');\n                } else {\n                    $tracker_time .=  \", $hours \" . xl('hour');\n                }\n            } else {\n                if ($hours >= 2) {\n                    $tracker_time .=  \"$hours \" . xl('hours');\n                } else {\n                    $tracker_time .=  \"$hours \" . xl('hour');\n                }\n            }\n\n            $tracker_time_calc = $tracker_time_calc - ($hours * (60 * 60));\n        }\n\n        if ($allow_sec) {\n            if ($tracker_time_calc > 60) {\n                $minutes = floor($tracker_time_calc / 60);\n                if (strlen($hours != 0)) {\n                    if ($minutes >= 2) {\n                        $tracker_time .=  \", $minutes \" . xl('minutes');\n                    } else {\n                        $tracker_time .=  \", $minutes \" . xl('minute');\n                    }\n                } else {\n                    if ($minutes >= 2) {\n                        $tracker_time .=  \"$minutes \" . xl('minutes');\n                    } else {\n                        $tracker_time .=  \"$minutes \" . xl('minute');\n                    }\n                }\n\n                $tracker_time_calc = $tracker_time_calc - ($minutes * 60);\n            }\n        } else {\n            $minutes = round($tracker_time_calc / 60);\n            if (!empty($hours) && strlen($hours != 0)) {\n                if ($minutes >= 2) {\n                    $tracker_time .=  \", $minutes \" . xl('minutes');\n                } else {\n                    $tracker_time .=  \", $minutes \" . xl('minute');\n                }\n            } else {\n                if ($minutes >= 2) {\n                    $tracker_time .=  \"$minutes \" . xl('minutes');\n                } else {\n                    if ($minutes > 0) {\n                        $tracker_time .=  \"$minutes \" . xl('minute');\n                    }\n                }\n            }\n\n            $tracker_time_calc = $tracker_time_calc - ($minutes * 60);\n        }\n\n        if ($allow_sec) {\n            if ($tracker_time_calc > 0) {\n                if (strlen($minutes != 0)) {\n                    if ($tracker_time_calc >= 2) {\n                        $tracker_time .= \", $tracker_time_calc \" . xl('seconds');\n                    } else {\n                        $tracker_time .= \", $tracker_time_calc \" . xl('second');\n                    }\n                } else {\n                    if ($tracker_time_calc >= 2) {\n                        $tracker_time .= \"$tracker_time_calc \" . xl('seconds');\n                    } else {\n                        $tracker_time .= \"$tracker_time_calc \" . xl('second');\n                    }\n                }\n            }\n        }\n\n        return $tracker_time ;\n    }\n\n    /**\n     * This function will return false for both below scenarios:\n     * 1. The tracker item does not exist\n     * 2. If the tracker item does exist, but the encounter has not been set\n     * @param $apptdate\n     * @param $appttime\n     * @param $pid\n     * @param $eid\n     * @return int\n     */\n    public function is_tracker_encounter_exist($apptdate, $appttime, $pid, $eid)\n    {\n        #Check to see if there is an encounter in the patient_tracker table.\n        $enc_yn = sqlQuery(\"SELECT encounter from patient_tracker WHERE `apptdate` = ? AND encounter > 0 \" .\n            \"AND `eid` = ? AND `pid` = ?\", array($apptdate, $eid, $pid));\n        if (empty($enc_yn['encounter']) || $enc_yn === false) {\n            return (0);\n        }\n\n        return ($enc_yn['encounter']);\n    }\n\n    /**\n     * this function will return the tracker id that is managed\n     * or will return false if no tracker id was managed (in the case of a recurrent appointment)\n     * @param $apptdate\n     * @param $appttime\n     * @param $eid\n     * @param $pid\n     * @param $user\n     * @param string $status\n     * @param string $room\n     * @param string $enc_id\n     * @return bool|int\n     */\n    public function manage_tracker_status($apptdate, $appttime, $eid, $pid, $user, $status = '', $room = '', $enc_id = '')\n    {\n        #First ensure the eid is not a recurrent appointment. If it is, then do not do anything and return false.\n        $pc_appt =  sqlQuery(\"SELECT `pc_recurrtype` FROM `openemr_postcalendar_events` WHERE `pc_eid` = ?\", array($eid));\n        if ($pc_appt['pc_recurrtype'] != 0) {\n            return false;\n        }\n\n        $datetime = date(\"Y-m-d H:i:s\");\n        if (is_null($room)) {\n            $room = '';\n        }\n\n        #Check to see if there is an entry in the patient_tracker table.\n        $tracker = sqlQuery(\"SELECT id, apptdate, appttime, eid, pid, original_user, encounter, lastseq,\" .\n            \"patient_tracker_element.room AS lastroom,patient_tracker_element.status AS laststatus \" .\n            \"from `patient_tracker`\" .\n            \"LEFT JOIN patient_tracker_element \" .\n            \"ON patient_tracker.id = patient_tracker_element.pt_tracker_id \" .\n            \"AND patient_tracker.lastseq = patient_tracker_element.seq \" .\n            \"WHERE `apptdate` = ? AND `appttime` = ? \" .\n            \"AND `eid` = ? AND `pid` = ?\", array($apptdate,$appttime,$eid,$pid));\n\n        if (empty($tracker)) {\n            #Add a new tracker.\n            $tracker_id = sqlInsert(\n                \"INSERT INTO `patient_tracker` \" .\n                \"(`date`, `apptdate`, `appttime`, `eid`, `pid`, `original_user`, `encounter`, `lastseq`) \" .\n                \"VALUES (?,?,?,?,?,?,?,'1')\",\n                array($datetime,$apptdate,$appttime,$eid,$pid,$user,$enc_id)\n            );\n            #If there is a status or a room, then add a tracker item.\n            if (!empty($status) || !empty($room)) {\n                sqlStatement(\n                    \"INSERT INTO `patient_tracker_element` \" .\n                    \"(`pt_tracker_id`, `start_datetime`, `user`, `status`, `room`, `seq`) \" .\n                    \"VALUES (?,?,?,?,?,'1')\",\n                    array($tracker_id,$datetime,$user,$status,$room)\n                );\n            }\n            $tracker = [\n                'id' => $tracker_id\n                ,'date' => $datetime\n                ,'apptdate' => $apptdate\n                ,'appttime' => $appttime\n                ,'eid' => $eid\n                ,'pid' => $pid\n                ,'original_user' => $user\n                ,'encounter' => $enc_id\n                ,'lastseq' => '1'\n                ,'element' => [\n                    'pt_tracker_id' => $tracker_id\n                    ,'start_datetime' => $datetime\n                    ,'user' => $user\n                    ,'status' => $status\n                    ,'room' => $room\n                    ,'seq' => '1'\n                ]\n            ];\n        } else {\n            #Tracker already exists.\n            $tracker_id = $tracker['id'];\n            if (($status != $tracker['laststatus']) || ($room != $tracker['lastroom'])) {\n                #Status or room has changed, so need to update tracker.\n                #Update lastseq in tracker.\n                sqlStatement(\n                    \"UPDATE `patient_tracker` SET  `lastseq` = ? WHERE `id` = ?\",\n                    array(($tracker['lastseq'] + 1),$tracker_id)\n                );\n                #Add a tracker item.\n                sqlStatement(\n                    \"INSERT INTO `patient_tracker_element` \" .\n                    \"(`pt_tracker_id`, `start_datetime`, `user`, `status`, `room`, `seq`) \" .\n                    \"VALUES (?,?,?,?,?,?)\",\n                    array($tracker_id,$datetime,$user,$status,$room,($tracker['lastseq'] + 1))\n                );\n            }\n\n            if (!empty($enc_id)) {\n                #enc_id (encounter number) is not blank, so update this in tracker.\n                sqlStatement(\"UPDATE `patient_tracker` SET `encounter` = ? WHERE `id` = ?\", array($enc_id,$tracker_id));\n            }\n            $tracker['lastseq'] = $tracker['lastseq'] + 1;\n            $tracker['element'] = [\n                    'pt_tracker_id' => $tracker_id\n                    ,'start_datetime' => $datetime\n                    ,'user' => $user\n                    ,'status' => $status\n                    ,'room' => $room\n                    ,'seq' => $tracker['lastseq']\n            ];\n        }\n\n        #Ensure the entry in calendar appt entry has been updated.\n        $pc_appt =  sqlQuery(\"SELECT `pc_apptstatus`, `pc_room` FROM `openemr_postcalendar_events` WHERE `pc_eid` = ?\", array($eid));\n        if ($status != $pc_appt['pc_apptstatus']) {\n            sqlStatement(\"UPDATE `openemr_postcalendar_events` SET `pc_apptstatus` = ? WHERE `pc_eid` = ?\", array($status,$eid));\n        }\n\n        if ($room != $pc_appt['pc_room']) {\n            sqlStatement(\"UPDATE `openemr_postcalendar_events` SET `pc_room` = ? WHERE `pc_eid` = ?\", array($room,$eid));\n        }\n\n        $GLOBALS['kernel']->getEventDispatcher()->dispatch(new ServiceSaveEvent($this, $tracker), ServiceSaveEvent::EVENT_POST_SAVE);\n\n        # Returning the tracker id that has been managed\n        return $tracker_id;\n    }\n\n    /**\n     * This is used to break apart the information contained in the notes field of\n     * list_options. Currently the color and alert time are the only items stored\n     * @param $option\n     * @return array\n     */\n    public function collectApptStatusSettings($option)\n    {\n        $color_settings = array();\n        $row = sqlQuery(\"SELECT notes FROM list_options WHERE \" .\n            \"list_id = 'apptstat' AND option_id = ? AND activity = 1\", array($option));\n        if (empty($row['notes'])) {\n            return $option;\n        }\n\n        list($color_settings['color'], $color_settings['time_alert']) = explode(\"|\", $row['notes']);\n        return $color_settings;\n    }\n\n    /**\n     * This is used to collect the tracker elements for the Patient Flow Board Report\n     * returns the elements in an array\n     * @param $trackerid\n     * @return mixed\n     */\n    public function collect_Tracker_Elements($trackerid)\n    {\n        $res = sqlStatement(\"SELECT * FROM patient_tracker_element WHERE pt_tracker_id = ? ORDER BY LENGTH(seq), seq \", array($trackerid));\n        for ($iter = 0; $row = sqlFetchArray($res); $iter++) {\n            $returnval[$iter] = $row;\n        }\n\n        return $returnval;\n    }\n\n    /**\n     * used to determine check in time\n     * @param $trackerid\n     * @return bool\n     */\n    public function collect_checkin($trackerid)\n    {\n        $tracker = sqlQuery(\n            \"SELECT patient_tracker_element.start_datetime \" .\n            \"FROM patient_tracker_element \" .\n            \"INNER JOIN list_options \" .\n            \"ON patient_tracker_element.status = list_options.option_id \" .\n            \"WHERE  list_options.list_id = 'apptstat' \" .\n            \"AND list_options.toggle_setting_1 = '1' AND list_options.activity = 1 \" .\n            \"AND patient_tracker_element.pt_tracker_id = ?\",\n            array($trackerid)\n        );\n        if (empty($tracker['start_datetime'])) {\n            return false;\n        } else {\n            return $tracker['start_datetime'];\n        }\n    }\n\n    /**\n     * used to determine check out time\n     * @param $trackerid\n     * @return bool\n     */\n    public function collect_checkout($trackerid)\n    {\n        $tracker = sqlQuery(\n            \"SELECT patient_tracker_element.start_datetime \" .\n            \"FROM patient_tracker_element \" .\n            \"INNER JOIN list_options \" .\n            \"ON patient_tracker_element.status = list_options.option_id \" .\n            \"WHERE  list_options.list_id = 'apptstat' \" .\n            \"AND list_options.toggle_setting_2 = '1' AND list_options.activity = 1 \" .\n            \"AND patient_tracker_element.pt_tracker_id = ?\",\n            array($trackerid)\n        );\n        if (empty($tracker['start_datetime'])) {\n            return false;\n        } else {\n            return $tracker['start_datetime'];\n        }\n    }\n\n    public function getApptStatus($appointments)\n    {\n        $astat = array();\n        $astat['count_all'] = count($appointments);\n        //group the appointment by status\n        foreach ($appointments as $appointment) {\n            ($astat[$appointment['pc_apptstatus']] ?? null) ? $astat[$appointment['pc_apptstatus']] : $astat[$appointment['pc_apptstatus']] = 0;\n            $astat[$appointment['pc_apptstatus']] += 1;\n        }\n\n        return $astat;\n    }\n}\n"], "filenames": ["interface/billing/edit_payment.php", "interface/patient_tracker/patient_tracker.php", "library/payment.inc.php", "portal/add_edit_event_user.php", "src/Services/PatientTrackerService.php"], "buggy_code_start_loc": [191, 67, 64, 43, 367], "buggy_code_end_loc": [943, 1021, 216, 700, 367], "fixing_code_start_loc": [191, 67, 64, 44, 368], "fixing_code_end_loc": [943, 1025, 217, 711, 369], "type": "CWE-284", "message": "Improper Access Control in GitHub repository openemr/openemr prior to 7.0.0.2.", "other": {"cve": {"id": "CVE-2022-4505", "sourceIdentifier": "security@huntr.dev", "published": "2022-12-15T01:15:11.117", "lastModified": "2022-12-16T15:10:15.400", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Improper Access Control in GitHub repository openemr/openemr prior to 7.0.0.2."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "LOW", "integrityImpact": "NONE", "availabilityImpact": "NONE", "baseScore": 4.3, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 1.4}], "cvssMetricV30": [{"source": "security@huntr.dev", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 8.8, "baseSeverity": "HIGH"}, "exploitabilityScore": 2.8, "impactScore": 5.9}]}, "weaknesses": [{"source": "security@huntr.dev", "type": "Primary", "description": [{"lang": "en", "value": "CWE-284"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:open-emr:openemr:*:*:*:*:*:*:*:*", "versionEndExcluding": "7.0.0.2", "matchCriteriaId": "C397DED6-5350-43A0-B65D-FB92E8587CED"}]}]}], "references": [{"url": "https://github.com/openemr/openemr/commit/235b1910ffe5296187667277d4e197a0c3a9ac33", "source": "security@huntr.dev", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://huntr.dev/bounties/e36ca754-bb9f-4686-ad72-7fb849e97d92", "source": "security@huntr.dev", "tags": ["Exploit", "Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/openemr/openemr/commit/235b1910ffe5296187667277d4e197a0c3a9ac33"}}