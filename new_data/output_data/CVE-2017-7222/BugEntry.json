{"buggy_code": ["<?php\n# MantisBT - A PHP based bugtracking system\n\n# MantisBT is free software: you can redistribute it and/or modify\n# it under the terms of the GNU General Public License as published by\n# the Free Software Foundation, either version 2 of the License, or\n# (at your option) any later version.\n#\n# MantisBT is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n# GNU General Public License for more details.\n#\n# You should have received a copy of the GNU General Public License\n# along with MantisBT.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Layout API\n *\n * UI functions to render layout elements in every page. The layout api layer sits above the html api and abstract\n * the lower level html markup into web components\n *\n * Here is the call order for the layout functions\n *\n * layout_page_header\n *      layout_page_header_begin\n *      layout_page_header_end\n * layout_page_begin\n *      ...Page content here...\n * layout_page_end\n *\n *\n *\n * @package CoreAPI\n * @subpackage LayoutAPI\n * @copyright Copyright 2014 MantisBT Team - mantisbt-dev@lists.sourceforge.net\n * @link http://www.mantisbt.org\n *\n * @uses access_api.php\n * @uses utility_api.php\n */\n\n\nrequire_api( 'access_api.php' );\nrequire_api( 'utility_api.php' );\n\n\n/**\n * Print the page header section\n * @param string $p_page_title   Html page title.\n * @param string $p_redirect_url URL to redirect to if necessary.\n * @param string $p_page_id      The page id.\n * @return void\n */\nfunction layout_page_header( $p_page_title = null, $p_redirect_url = null, $p_page_id = null ) {\n\tlayout_page_header_begin( $p_page_title );\n\tif( $p_redirect_url !== null ) {\n\t\thtml_meta_redirect( $p_redirect_url );\n\t}\n\n\tlayout_page_header_end( $p_page_id );\n}\n\n/**\n * Print the part of the page that comes before meta redirect tags should be inserted\n * @param string $p_page_title Page title.\n * @return void\n */\nfunction layout_page_header_begin( $p_page_title = null ) {\n\thtml_begin();\n\thtml_head_begin();\n\thtml_content_type();\n\n\tglobal $g_robots_meta;\n\tif( !is_blank( $g_robots_meta ) ) {\n\t\techo \"\\t\", '<meta name=\"robots\" content=\"', $g_robots_meta, '\" />', \"\\n\";\n\t}\n\n\thtml_title( $p_page_title );\n\tlayout_head_meta();\n\thtml_css();\n\tlayout_head_css();\n\thtml_rss_link();\n\n\t$t_favicon_image = config_get( 'favicon_image' );\n\tif( !is_blank( $t_favicon_image ) ) {\n\t\techo \"\\t\", '<link rel=\"shortcut icon\" href=\"', helper_mantis_url( $t_favicon_image ), '\" type=\"image/x-icon\" />', \"\\n\";\n\t}\n\n\t# Advertise the availability of the browser search plug-ins.\n\t$t_title = config_get( 'search_title' );\n\t$t_searches = array( 'text', 'id' );\n\tforeach( $t_searches as $t_type ) {\n\t\techo \"\\t\",\n\t\t\t'<link rel=\"search\" type=\"application/opensearchdescription+xml\" ',\n\t\t\t\t'title=\"' . sprintf( lang_get( \"opensearch_{$t_type}_description\" ), $t_title ) . '\" ',\n\t\t\t\t'href=\"' . string_sanitize_url( 'browser_search_plugin.php?type=' . $t_type, true ) .\n\t\t\t\t'\"/>',\n\t\t\t\"\\n\";\n\t}\n\n\thtml_head_javascript();\n}\n\n/**\n * Print the part of the page that comes after meta tags and before the\n *  actual page content, but without login info or menus.  This is used\n *  directly during the login process and other times when the user may\n *  not be authenticated\n *\n * @param string $p_page_id The id of the page.\n *\n * @return void\n */\nfunction layout_page_header_end( $p_page_id = null) {\n\tglobal $g_error_send_page_header;\n\n\tevent_signal( 'EVENT_LAYOUT_RESOURCES' );\n\thtml_head_end();\n\n\tif ( $p_page_id === null ) {\n\t\t$t_body_id = '';\n\t} else {\n\t\t$t_body_id = 'id=\"' . $p_page_id . '\" ';\n\t}\n\n\t# Add right-to-left css if needed\n\tif( layout_is_rtl() ) {\n\t\techo '<body ' . $t_body_id . 'class=\"skin-3 rtl\">', \"\\n\";\n\t} else {\n\t\techo '<body ' . $t_body_id . 'class=\"skin-3\">', \"\\n\";\n\t}\n\n\tevent_signal( 'EVENT_LAYOUT_BODY_BEGIN' );\n\n\t$g_error_send_page_header = false;\n}\n\n/**\n * Print page common elements including navbar, sidebar, info bar\n * @param string $p_active_sidebar_page sidebar page where the current page lives under\n * @return void\n */\nfunction layout_page_begin( $p_active_sidebar_page = null ) {\n\tlayout_navbar();\n\n\tif( !db_is_connected() ) {\n\t\treturn;\n\t}\n\n\tlayout_main_container_begin();\n\n\tlayout_print_sidebar( $p_active_sidebar_page );\n\n\tlayout_main_content_begin();\n\n\tlayout_breadcrumbs();\n\n\tlayout_page_content_begin();\n\n\tif( auth_is_user_authenticated() ) {\n\t\tif( ON == config_get( 'show_project_menu_bar' ) ) {\n\t\t\techo '<div class=\"row\">' , \"\\n\";\n\t\t\tprint_project_menu_bar();\n\t\t\techo '</div>' , \"\\n\";\n\t\t}\n\t}\n\techo '<div class=\"row\">' , \"\\n\";\n\n\tevent_signal( 'EVENT_LAYOUT_CONTENT_BEGIN' );\n}\n\n/**\n * Print elements at the end of each page\n * @return void\n */\nfunction layout_page_end() {\n\tif( !db_is_connected() ) {\n\t\treturn;\n\t}\n\n\tevent_signal( 'EVENT_LAYOUT_CONTENT_END' );\n\n\techo '</div>' , \"\\n\";\n\n\tlayout_page_content_end();\n\tlayout_main_content_end();\n\n\tlayout_footer();\n\tlayout_scroll_up_button();\n\n\tlayout_main_container_end();\n\tlayout_body_javascript();\n\n\thtml_body_end();\n\thtml_end();\n}\n\n/**\n * Print common elements for admin pages\n * @return void\n */\nfunction layout_admin_page_begin() {\n\tlayout_navbar();\n\n\tlayout_main_container_begin();\n}\n\n/**\n * Print elements at the end of each admin page\n * @return void\n */\nfunction layout_admin_page_end() {\n\tlayout_footer();\n\tlayout_scroll_up_button();\n\n\tlayout_main_container_end();\n\tlayout_body_javascript();\n\n\thtml_body_end();\n    html_end();\n}\n\n\n\n/**\n * Check if the layout is setup for right to left languages\n * @return bool\n */\nfunction layout_is_rtl() {\n\tif( lang_get( 'directionality' ) == 'rtl' ) {\n\t\treturn true;\n\t}\n\treturn false;\n}\n\n/**\n * Print meta tags for the page head\n * @return null\n */\nfunction layout_head_meta() {\n\t# use the following meta to force IE use its most up to date rendering engine\n\techo '<meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge,chrome=1\" />' . \"\\n\";\n\n\techo '<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0\" />' . \"\\n\";\n}\n\n/**\n * Print css link directives for the head section of the page\n * @return null\n */\nfunction layout_head_css() {\n\t# bootstrap & fontawesome\n\tif ( config_get_global( 'cdn_enabled' ) == ON ) {\n\t\thtml_css_cdn_link( 'https://maxcdn.bootstrapcdn.com/bootstrap/' . BOOTSTRAP_VERSION . '/css/bootstrap.min.css' );\n\t\thtml_css_cdn_link( 'https://maxcdn.bootstrapcdn.com/font-awesome/' . FONT_AWESOME_VERSION . '/css/font-awesome.min.css' );\n\n\t\t# theme text fonts\n\t\thtml_css_cdn_link( 'https://fonts.googleapis.com/css?family=Open+Sans:300,400' );\n\n\t\t# datetimepicker\n\t\thtml_css_cdn_link( 'https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/' . DATETIME_PICKER_VERSION . '/css/bootstrap-datetimepicker.min.css' );\n\t} else {\n\t\thtml_css_link( 'bootstrap-' . BOOTSTRAP_VERSION . '.min.css' );\n\t\thtml_css_link( 'font-awesome-' . FONT_AWESOME_VERSION . '.min.css' );\n\n\t\t# theme text fonts\n\t\thtml_css_link( 'open-sans.css' );\n\n\t\t# datetimepicker\n\t\thtml_css_link( 'bootstrap-datetimepicker-' . DATETIME_PICKER_VERSION . '.min.css' );\n\t}\n\n\t# page specific plugin styles\n\n\t# theme styles\n\thtml_css_link( 'ace.min.css' );\n\thtml_css_link( 'ace-mantis.css' );\n\n\t# handle IE separately\n\techo '<!--[if lte IE 9]>';\n\thtml_css_link( 'ace-part2.min.css' );\n\techo '<![endif]-->';\n\thtml_css_link( 'ace-skins.min.css' );\n\n\tif( layout_is_rtl() ) {\n\t\thtml_css_link( 'ace-rtl.min.css' );\n\t}\n\n\techo '<!--[if lte IE 9]>';\n\thtml_css_link( 'ace-ie.min.css' );\n\techo '<![endif]-->';\n\techo \"\\n\";\n}\n\n\n/**\n * Print javascript directives for the head section of the page\n * @return null\n */\nfunction layout_head_javascript() {\n\t# HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries\n\techo '<!--[if lte IE 8]>';\n\thtml_javascript_link( 'html5shiv.min.js' );\n\thtml_javascript_link( 'respond.min.js' );\n\techo '<![endif]-->';\n\techo \"\\n\";\n}\n\n\n/**\n * Print javascript directives before the closing of the page body element\n * @return null\n */\nfunction layout_body_javascript() {\n\tif ( config_get_global( 'cdn_enabled' ) == ON ) {\n\t\t# bootstrap\n\t\thtml_javascript_cdn_link( 'https://maxcdn.bootstrapcdn.com/bootstrap/' . BOOTSTRAP_VERSION . '/js/bootstrap.min.js', BOOTSTRAP_HASH );\n\n\t\t# moment & datetimepicker\n\t\thtml_javascript_cdn_link( 'https://cdnjs.cloudflare.com/ajax/libs/moment.js/' . MOMENT_VERSION . '/moment-with-locales.min.js', MOMENT_HASH );\n\t\thtml_javascript_cdn_link( 'https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/' . DATETIME_PICKER_VERSION . '/js/bootstrap-datetimepicker.min.js', DATETIME_PICKER_HASH );\n\t\t\n\t\t# listjs\n\t\thtml_javascript_cdn_link( 'https://cdnjs.cloudflare.com/ajax/libs/list.js/' . LISTJS_VERSION . '/list.min.js', LISTJS_HASH );\n\t} else {\n\t\t# bootstrap\n\t\thtml_javascript_link( 'bootstrap-' . BOOTSTRAP_VERSION . '.min.js' );\n\n\t\t# moment & datetimepicker\n\t\thtml_javascript_link( 'moment-with-locales-' . MOMENT_VERSION . '.min.js' );\n\t\thtml_javascript_link( 'bootstrap-datetimepicker-' . DATETIME_PICKER_VERSION . '.min.js' );\n\n\t\t# listjs\n\t\thtml_javascript_link( 'list-' . LISTJS_VERSION . '.min.js' );\n\t}\n\n\t# theme scripts\n\thtml_javascript_link( 'ace-extra.min.js' );\n\thtml_javascript_link( 'ace-elements.min.js' );\n\thtml_javascript_link( 'ace.min.js' );\n}\n\n\n/**\n * Print opening markup for login/signup/register pages\n * @return null\n */\nfunction layout_login_page_begin() {\n\thtml_begin();\n\thtml_head_begin();\n\thtml_content_type();\n\n\tglobal $g_robots_meta;\n\tif( !is_blank( $g_robots_meta ) ) {\n\t\techo \"\\t\", '<meta name=\"robots\" content=\"', $g_robots_meta, '\" />', \"\\n\";\n\t}\n\n\thtml_title();\n\tlayout_head_meta();\n\thtml_css();\n\tlayout_head_css();\n\thtml_rss_link();\n\n\t$t_favicon_image = config_get( 'favicon_image' );\n\tif( !is_blank( $t_favicon_image ) ) {\n\t\techo \"\\t\", '<link rel=\"shortcut icon\" href=\"', helper_mantis_url( $t_favicon_image ), '\" type=\"image/x-icon\" />', \"\\n\";\n\t}\n\n\t# Advertise the availability of the browser search plug-ins.\n\techo \"\\t\", '<link rel=\"search\" type=\"application/opensearchdescription+xml\" title=\"MantisBT: Text Search\" href=\"' . string_sanitize_url( 'browser_search_plugin.php?type=text', true) . '\" />' . \"\\n\";\n\techo \"\\t\", '<link rel=\"search\" type=\"application/opensearchdescription+xml\" title=\"MantisBT: Issue Id\" href=\"' . string_sanitize_url( 'browser_search_plugin.php?type=id', true) . '\" />' . \"\\n\";\n\t\n\thtml_head_javascript();\n\t\n\tevent_signal( 'EVENT_LAYOUT_RESOURCES' );\n\thtml_head_end();\n\n\techo '<body class=\"login-layout light-login\">';\n\tlayout_main_container_begin();\n\tlayout_main_content_begin();\n\techo '<div class=\"row\">';\n}\n\n/**\n * Print closing markup for login/signup/register pages\n * @return null\n */\nfunction layout_login_page_end() {\n\techo '</div>';\n\tlayout_main_content_end();\n\tlayout_main_container_end();\n\tlayout_body_javascript();\n\n\techo '</body>', \"\\n\";\n}\n\n/**\n * Render navbar at the top of the page\n * @return null\n */\nfunction layout_navbar() {\n\t$t_logo_url = config_get('logo_url');\n\n\techo '<div id=\"navbar\" class=\"navbar navbar-default navbar-collapse navbar-fixed-top noprint\">';\n\techo '<div id=\"navbar-container\" class=\"navbar-container\">';\n\n\techo '<button id=\"menu-toggler\" type=\"button\" class=\"navbar-toggle menu-toggler pull-left hidden-lg\" data-target=\"#sidebar\">';\n\techo '<span class=\"sr-only\">Toggle sidebar</span>';\n\techo '<span class=\"icon-bar\"></span>';\n\techo '<span class=\"icon-bar\"></span>';\n\techo '<span class=\"icon-bar\"></span>';\n\techo '</button>';\n\n\techo '<div class=\"navbar-header\">';\n\techo '<a href=\"' . $t_logo_url . '\" class=\"navbar-brand\">';\n\techo '<span class=\"smaller-75\"> ';\n\techo config_get('window_title');\n\techo ' </span>';\n\techo '</a>';\n\n\t$t_toggle_class = (OFF == config_get('show_avatar') ? 'navbar-toggle' : 'navbar-toggle-img');\n\techo '<button type=\"button\" class=\"navbar-toggle ' . $t_toggle_class . ' collapsed pull-right hidden-sm hidden-md hidden-lg\" data-toggle=\"collapse\" data-target=\".navbar-buttons,.navbar-menu\">';\n\techo '<span class=\"sr-only\">Toggle user menu</span>';\n\tif (auth_is_user_authenticated()) {\n\t\tlayout_navbar_user_avatar();\n\t}\n\techo '</button>';\n\n\techo '</div>';\n\n\techo '<div class=\"navbar-buttons navbar-header navbar-collapse collapse\">';\n\techo '<ul class=\"nav ace-nav\">';\n\tif (auth_is_user_authenticated()) {\n\t\t# shortcuts button bar\n\t\tlayout_navbar_button_bar();\n\t\t# projects dropdown menu\n\t\tlayout_navbar_projects_menu();\n\t\t# user buttons such as messages, notifications and user menu\n\t\tlayout_navbar_user_menu();\n\t}\n\techo '</ul>';\n\techo '</div>';\n\n\techo '</div>';\n\techo '</div>';\n}\n\n/**\n * Print navbar menu item\n * @param string $p_url destination url of the menu item\n * @param string $p_title menu item title\n * @param string $p_icon icon to use for this menu\n * @return null\n */\nfunction layout_navbar_menu_item( $p_url, $p_title, $p_icon ) {\n\techo '<li>';\n\techo '<a href=\"' . $p_url . '\">';\n\techo '<i class=\"ace-icon fa ' . $p_icon . '\"> </i> ' . $p_title;\n\techo '</a>';\n\techo '</li>';\n}\n\n/**\n * Print navbar user menu at the top right of the page\n * @param bool $p_show_avatar decide whether to show logged in user avatar\n * @return null\n */\nfunction layout_navbar_user_menu( $p_show_avatar = true ) {\n\tif( !auth_is_user_authenticated() ) {\n\t\treturn;\n\t}\n\n\t$t_username = current_user_get_field( 'username' );\n\n\techo '<li class=\"grey\">';\n\techo '<a data-toggle=\"dropdown\" href=\"#\" class=\"dropdown-toggle\">';\n\tif( $p_show_avatar ) {\n\t\tlayout_navbar_user_avatar( 'nav-user-photo' );\n\t\techo '<span class=\"user-info\">';\n\t\techo $t_username;\n\t\techo '</span>';\n\t\techo '<i class=\"ace-icon fa fa-angle-down\"></i>';\n\t} else {\n\t\techo '&#160;' . $t_username . '&#160;' . \"\\n\";\n\t\techo '<i class=\"ace-icon fa fa-angle-down bigger-110\"></i>';\n\t}\n\techo '</a>';\n\techo '<ul class=\"user-menu dropdown-menu dropdown-menu-right dropdown-yellow dropdown-caret dropdown-close\">';\n\n\t# My Account\n\tif( !current_user_is_protected() ) {\n\t\tlayout_navbar_menu_item( helper_mantis_url( 'account_page.php' ), lang_get( 'account_link' ), 'fa-user' );\n\t}\n\n\t# RSS Feed\n\tif( OFF != config_get( 'rss_enabled' ) ) {\n\t\tlayout_navbar_menu_item( htmlspecialchars( rss_get_issues_feed_url() ), lang_get( 'rss' ), 'fa-rss-square orange' );\n\t}\n\n\techo '<li class=\"divider\"></li>';\n\n\t# Logout\n\tlayout_navbar_menu_item( helper_mantis_url( 'logout_page.php' ), lang_get( 'logout_link' ), 'fa-sign-out' );\n\techo '</ul>';\n\techo '</li>';\n}\n\n\n/**\n * Print navbar projects menu at the top right of the page\n * @return null\n */\nfunction layout_navbar_projects_menu() {\n\tif( !auth_is_user_authenticated() ) {\n\t\treturn;\n\t}\n\n\t# Project Selector (hidden if only one project visible to user)\n\t$t_show_project_selector = true;\n\t$t_project_ids = current_user_get_accessible_projects();\n\tif( count( $t_project_ids ) == 1 ) {\n\t\t$t_project_id = (int) $t_project_ids[0];\n\t\tif( count( current_user_get_accessible_subprojects( $t_project_id ) ) == 0 ) {\n\t\t\t$t_show_project_selector = false;\n\t\t}\n\t}\n\n\tif( $t_show_project_selector ) {\n\t\techo '<li class=\"grey\">' . \"\\n\";\n\t\techo '<a data-toggle=\"dropdown\" href=\"#\" class=\"dropdown-toggle\">' . \"\\n\";\n\n\t\t$t_current_project_id = helper_get_current_project();\n\t\tif( ALL_PROJECTS == $t_current_project_id) {\n\t\t\techo '&#160;' . string_attribute( lang_get( 'all_projects' ) ) . '&#160;' . \"\\n\";\n\t\t} else {\n\t\t\techo '&#160;' . string_attribute( project_get_field( $t_current_project_id, 'name' ) ) . '&#160;' . \"\\n\";\n\t\t}\n\n\t\techo ' <i class=\"ace-icon fa fa-angle-down bigger-110\"></i>' . \"\\n\";\n\t\techo '</a>' . \"\\n\";\n\n\t\techo '<ul class=\"dropdown-menu dropdown-menu-right dropdown-yellow dropdown-caret dropdown-close scrollable-menu\">' . \"\\n\";\n\t\tlayout_navbar_projects_list( join( ';', helper_get_current_project_trace() ), true, null, true );\n\t\techo '</ul>' . \"\\n\";\n\t\techo '</li>' . \"\\n\";\n\t} else {\n\t\t# User has only one project, set it as both current and default\n\t\tif( ALL_PROJECTS == helper_get_current_project() ) {\n\t\t\thelper_set_current_project( $t_project_id );\n\n\t\t\tif( !current_user_is_protected() ) {\n\t\t\t\tcurrent_user_set_default_project( $t_project_id );\n\t\t\t}\n\n\t\t\t# Force reload of current page, except if we got here after\n\t\t\t# creating the first project\n\t\t\t$t_redirect_url = str_replace( config_get( 'short_path' ), '', $_SERVER['REQUEST_URI'] );\n\t\t\tif( 'manage_proj_create.php' != $t_redirect_url ) {\n\t\t\t\thtml_meta_redirect( $t_redirect_url, 0, false );\n\t\t\t}\n\t\t}\n\t}\n}\n\n/**\n * Print navbar bottons\n * @return null\n */\nfunction layout_navbar_button_bar() {\n\tif( !auth_is_user_authenticated() ) {\n\t\treturn;\n\t}\n\n\t$t_can_report_bug = access_has_any_project_level( 'report_bug_threshold' );\n\t$t_can_invite_user = current_user_is_administrator();\n\n\tif( !$t_can_report_bug && !$t_can_invite_user ) {\n\t\treturn;\n\t}\n\n\techo '<li class=\"hidden-sm hidden-xs\">';\n  \techo '<div class=\"btn-group btn-corner padding-right-8 padding-left-8\">';\n\n  \tif( $t_can_report_bug ) {\n\t\t$t_bug_url = string_get_bug_report_url();\n\t  \techo '<a class=\"btn btn-primary btn-sm\" href=\"' . $t_bug_url . '\">';\n\t\techo '<i class=\"fa fa-edit\"></i> ' . lang_get( 'report_bug_link' );\n\t\techo '</a>';\n  \t}\n\n\tif( $t_can_invite_user ) {\n\t\techo '<a class=\"btn btn-primary btn-sm\" href=\"manage_user_create_page.php\">';\n\t\techo '<i class=\"fa fa-user-plus\"></i> ' . lang_get( 'invite_users' );\n\t\techo '</a>';\n\t}\n\n\techo '</div>';\n  \techo '</li>';\n}\n\n/**\n * Print projects that the current user has access to.\n *\n * @param int $p_project_id \tThe current project id or null to use cookie.\n * @param bool $p_include_all_projects  true: include \"All Projects\", otherwise false.\n * @param int|null $p_filter_project_id  The id of a project to exclude or null.\n * @param string|bool $p_trace  The current project trace, identifies the sub-project via a path from top to bottom.\n * @param bool $p_can_report_only If true, disables projects in which user can't report issues; defaults to false (all projects enabled)\n */\nfunction layout_navbar_projects_list( $p_project_id = null, $p_include_all_projects = true, $p_filter_project_id = null, $p_trace = false, $p_can_report_only = false ) {\n\t$t_user_id = auth_get_current_user_id();\n\t$t_project_ids = user_get_accessible_projects( $t_user_id );\n\t$t_can_report = true;\n\tproject_cache_array_rows( $t_project_ids );\n\n\tif( $p_include_all_projects && $p_filter_project_id !== ALL_PROJECTS ) {\n\t\techo ALL_PROJECTS == $p_project_id ? '<li class=\"active\">' : '<li>';\n\t\techo '<a href=\"' . helper_mantis_url( 'set_project.php' ) . '?project_id=' . ALL_PROJECTS . '\"';\n\t\tif( $p_project_id !== null ) {\n\t\t\tcheck_selected( $p_project_id, ALL_PROJECTS, false );\n\t\t}\n\t\techo '> ' . lang_get( 'all_projects' ) . ' </a></li>' . \" \\n\";\n\t\techo '<li class=\"divider\"></li>' . \"\\n\";\n\t}\n\n\techo '<li>';\n\techo '<div id=\"projects-list\">';\n\techo '<div class=\"projects-searchbox\">';\n\techo '<input class=\"search form-control input-md\" placeholder=\"' . lang_get( 'search' ) . '\" />';\n\techo '</div>';\n\techo '<ul class=\"list dropdown-yellow no-margin\">';\n\n\tforeach( $t_project_ids as $t_id ) {\n\t\tif( $p_can_report_only ) {\n\t\t\t$t_report_bug_threshold = config_get( 'report_bug_threshold', null, $t_user_id, $t_id );\n\t\t\t$t_can_report = access_has_project_level( $t_report_bug_threshold, $t_id, $t_user_id );\n\t\t}\n\n\t\techo 0 == strcmp( $t_id, $p_project_id ) ? '<li class=\"active\">' : '<li>';\n\t\techo '<a href=\"' . helper_mantis_url( 'set_project.php' ) . '?project_id=' . $t_id . '\"';\n\t\tcheck_selected( $p_project_id, $t_id, false );\n\t\tcheck_disabled( $t_id == $p_filter_project_id || !$t_can_report );\n\t\techo ' class=\"project-link\"> ' . string_attribute( project_get_field( $t_id, 'name' ) ) . ' </a></li>' . \"\\n\";\n\t\tlayout_navbar_subproject_option_list( $t_id, $p_project_id, $p_filter_project_id, $p_trace, $p_can_report_only );\n\t}\n\n\techo '</ul>';\n\techo '</div>';\n\techo '</li>';\n}\n\n/**\n * List projects that the current user has access to\n *\n * @param integer $p_parent_id         A parent project identifier.\n * @param integer $p_project_id        A project identifier.\n * @param integer $p_filter_project_id A filter project identifier.\n * @param boolean $p_trace             Whether to trace parent projects.\n * @param boolean $p_can_report_only   If true, disables projects in which user can't report issues; defaults to false (all projects enabled).\n * @param array   $p_parents           Array of parent projects.\n * @return void\n */\nfunction layout_navbar_subproject_option_list( $p_parent_id, $p_project_id = null, $p_filter_project_id = null, $p_trace = false, $p_can_report_only = false, array $p_parents = array() ) {\n\tarray_push( $p_parents, $p_parent_id );\n\t$t_user_id = auth_get_current_user_id();\n\t$t_project_ids = user_get_accessible_subprojects( $t_user_id, $p_parent_id );\n\t$t_can_report = true;\n\n\tforeach( $t_project_ids as $t_id ) {\n\t\tif( $p_can_report_only ) {\n\t\t\t$t_report_bug_threshold = config_get( 'report_bug_threshold', null, $t_user_id, $t_id );\n\t\t\t$t_can_report = access_has_project_level( $t_report_bug_threshold, $t_id, $t_user_id );\n\t\t}\n\n\t\tif( $p_trace ) {\n\t\t\t$t_full_id = join( $p_parents, \";\" ) . ';' . $t_id;\n\t\t} else {\n\t\t\t$t_full_id = $t_id;\n\t\t}\n\n\t\techo 0 == strcmp( $p_project_id, $t_full_id ) ? '<li class=\"active\">' : '<li>';\n\t\techo '<a href=\"' . helper_mantis_url( 'set_project.php' ) . '?project_id=' . $t_full_id . '\"';\n\t\tcheck_selected( $p_project_id, $t_full_id, false );\n\t\tcheck_disabled( $t_id == $p_filter_project_id || !$t_can_report );\n\t\techo ' class=\"project-link\"> ' . str_repeat( '&#160;', count( $p_parents ) * 4 );\n\t\techo string_attribute( project_get_field( $t_id, 'name' ) ) . '</a></li>' . \"\\n\";\n\n\t\tlayout_navbar_subproject_option_list( $t_id, $p_project_id, $p_filter_project_id, $p_trace, $p_can_report_only, $p_parents );\n\t}\n}\n\n\n/**\n * Print user avatar in the navbar\n * @param string $p_img_class css class to use with the img tag\n * @return null\n */\nfunction layout_navbar_user_avatar( $p_img_class = '' ) {\n\t$t_default_avatar = '<i class=\"ace-icon fa fa-user fa-2x white\"></i> ';\n\n\tif( OFF === config_get( 'show_avatar' ) ) {\n\t\techo $t_default_avatar;\n\t\treturn;\n\t}\n\n\t$p_user_id = auth_get_current_user_id();\n\tif( !user_exists( $p_user_id ) ) {\n\t\techo $t_default_avatar;\n\t\treturn;\n\t}\n\n\tif( access_has_project_level( config_get( 'show_avatar_threshold' ), null, $p_user_id ) ) {\n\t\t$t_avatar = Avatar::get( $p_user_id, 32 );\n\t\tif( false !== $t_avatar ) {\n\t\t\t$t_image = htmlspecialchars( $t_avatar->image );\n\t\t\t$t_text = htmlspecialchars( $t_avatar->text );\n\n\t\t\techo '<img class=\"nav-user-photo\" src=\"' . $t_image . '\" alt=\"' . $t_text . '\" />';\n\t\t\treturn;\n\t\t}\n\t}\n\n\techo $t_default_avatar;\n}\n\n/**\n * Print sidebar\n * @param string $p_active_sidebar_page page where the displayed page lives under\n * @return void\n */\nfunction layout_print_sidebar( $p_active_sidebar_page = null ) {\n\tif( auth_is_user_authenticated() ) {\n\t\t$t_protected = current_user_get_field( 'protected' );\n\t\t$t_current_project = helper_get_current_project();\n\n\t\t# Starting sidebar markup\n\t\tlayout_sidebar_begin();\n\n\t\t# Plugin / Event added options\n\t\t$t_event_menu_options = event_signal( 'EVENT_MENU_MAIN_FRONT' );\n\t\tlayout_plugin_menu_options_for_sidebar( $t_event_menu_options, $p_active_sidebar_page );\n\n\t\t# Main Page\n\t\tif( config_get( 'news_enabled' ) == ON ) {\n\t\t\tlayout_sidebar_menu( 'main_page.php', 'main_link', 'fa-bullhorn', $p_active_sidebar_page  );\n\t\t}\n\n\t\t# My View\n\t\tlayout_sidebar_menu( 'my_view_page.php', 'my_view_link', 'fa-dashboard', $p_active_sidebar_page );\n\n\t\t# View Bugs\n\t\tlayout_sidebar_menu( 'view_all_bug_page.php', 'view_bugs_link', 'fa-list-alt', $p_active_sidebar_page );\n\n\t\t# Report Bugs\n\t\tif( access_has_any_project_level( 'report_bug_threshold' ) ) {\n\t\t\t$t_bug_url = string_get_bug_report_url();\n\t\t\tlayout_sidebar_menu( $t_bug_url, 'report_bug_link', 'fa-edit', $p_active_sidebar_page );\n\t\t}\n\n\t\t# Changelog Page\n\t\tif( access_has_project_level( config_get( 'view_changelog_threshold' ) ) ) {\n\t\t\tlayout_sidebar_menu( 'changelog_page.php', 'changelog_link', 'fa-retweet', $p_active_sidebar_page );\n\t\t}\n\n\t\t# Roadmap Page\n\t\tif( access_has_project_level( config_get( 'roadmap_view_threshold' ) ) ) {\n\t\t\tlayout_sidebar_menu( 'roadmap_page.php', 'roadmap_link', 'fa-road', $p_active_sidebar_page );\n\t\t}\n\n\t\t# Summary Page\n\t\tif( access_has_project_level( config_get( 'view_summary_threshold' ) ) ) {\n\t\t\tlayout_sidebar_menu( 'summary_page.php', 'summary_link', 'fa-bar-chart-o', $p_active_sidebar_page );\n\t\t}\n\n\t\t# Project Documentation Page\n\t\tif( ON == config_get( 'enable_project_documentation' ) ) {\n\t\t\tlayout_sidebar_menu( 'proj_doc_page.php', 'docs_link', 'fa-book', $p_active_sidebar_page );\n\t\t}\n\n\t\t# Project Wiki\n\t\tif( ON == config_get_global( 'wiki_enable' )  ) {\n\t\t\tlayout_sidebar_menu( 'wiki.php?type=project&amp;id=' . $t_current_project, 'wiki', 'fa-book', $p_active_sidebar_page );\n\t\t}\n\n\t\t# Manage Users (admins) or Manage Project (managers) or Manage Custom Fields\n\t\tif( access_has_global_level( config_get( 'manage_site_threshold' ) ) ) {\n\t\t\tlayout_sidebar_menu( 'manage_overview_page.php', 'manage_link', 'fa-gears', $p_active_sidebar_page );\n\t\t} else {\n\t\t\t$t_show_access = min( config_get( 'manage_user_threshold' ), config_get( 'manage_project_threshold' ), config_get( 'manage_custom_fields_threshold' ) );\n\t\t\tif( access_has_global_level( $t_show_access ) || access_has_any_project( $t_show_access ) ) {\n\t\t\t\t$t_current_project = helper_get_current_project();\n\t\t\t\tif( access_has_global_level( config_get( 'manage_user_threshold' ) ) ) {\n\t\t\t\t\t$t_link = 'manage_user_page.php';\n\t\t\t\t} else {\n\t\t\t\t\tif( access_has_project_level( config_get( 'manage_project_threshold' ), $t_current_project ) && ( $t_current_project <> ALL_PROJECTS ) ) {\n\t\t\t\t\t\t$t_link = 'manage_proj_edit_page.php?project_id=' . $t_current_project;\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$t_link = 'manage_proj_page.php';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tlayout_sidebar_menu( $t_link , 'manage_link', 'fa-gears' );\n\t\t\t}\n\t\t}\n\n\t\t# Time Tracking / Billing\n\t\tif( config_get( 'time_tracking_enabled' ) && access_has_global_level( config_get( 'time_tracking_reporting_threshold' ) ) ) {\n\t\t\tlayout_sidebar_menu( 'billing_page.php', 'time_tracking_billing_link', 'fa-clock-o', $p_active_sidebar_page );\n\t\t}\n\n\t\t# Plugin / Event added options\n\t\t$t_event_menu_options = event_signal( 'EVENT_MENU_MAIN' );\n\t\tlayout_plugin_menu_options_for_sidebar( $t_event_menu_options, $p_active_sidebar_page );\n\n\t\t# Config based custom options\n\t\tlayout_config_menu_options_for_sidebar( $p_active_sidebar_page );\n\n\t\t# Ending sidebar markup\n\t\tlayout_sidebar_end();\n\t}\n}\n\n/**\n * Process plugin menu options for sidebar\n * @param array $p_plugin_event_response The response from the plugin event signal.\n * @param string $p_active_sidebar_page The active page on the sidebar.\n * @return void\n */\nfunction layout_plugin_menu_options_for_sidebar( $p_plugin_event_response, $p_active_sidebar_page ) {\n\t$t_menu_options = array();\n\n\tforeach( $p_plugin_event_response as $t_plugin => $t_plugin_menu_options ) {\n\t\tforeach( $t_plugin_menu_options as $t_callback => $t_callback_menu_options ) {\n\t\t\tif( is_array( $t_callback_menu_options ) ) {\n\t\t\t\t$t_menu_options = array_merge( $t_menu_options, $t_callback_menu_options );\n\t\t\t} else {\n\t\t\t\tif( !is_null( $t_callback_menu_options ) ) {\n\t\t\t\t\t$t_menu_options[] = $t_callback_menu_options;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tlayout_options_for_sidebar( $t_menu_options, $p_active_sidebar_page );\n}\n\n/**\n * Process main menu options from config.\n * @param string $p_active_sidebar_page The active page on the sidebar.\n * @return void\n */\nfunction layout_config_menu_options_for_sidebar( $p_active_sidebar_page ) {\n\t$t_menu_options = array();\n\t$t_custom_options = config_get( 'main_menu_custom_options' );\n\n\tforeach( $t_custom_options as $t_custom_option ) {\n\t\tif( isset( $t_custom_option['url'] ) ) {\n\t\t\t$t_menu_option = $t_custom_option;\n\t\t} else {\n\t\t\t# Support < 2.0.0 custom menu options config format\n\t\t\t$t_menu_option = array();\n\t\t\t$t_menu_option['title'] = $t_custom_option[0];\n\t\t\t$t_menu_option['access_level'] = $t_custom_option[1];\n\t\t\t$t_menu_option['url'] = $t_custom_option[2];\n\t\t}\n\n\t\t$t_menu_options[] = $t_menu_option;\n\t}\n\n\tlayout_options_for_sidebar( $t_menu_options, $p_active_sidebar_page );\n}\n\n/**\n * Process main menu options\n * @param array $p_menu_options Array of menu options to output.\n * @param string $p_active_sidebar_page The active page on the sidebar.\n * @return void\n */\nfunction layout_options_for_sidebar( $p_menu_options, $p_active_sidebar_page ) {\n\tforeach( $p_menu_options as $t_menu_option ) {\n\t\t$t_icon = isset( $t_menu_option['icon'] ) ? $t_menu_option['icon'] : 'fa-plug';\n\t\tif( !isset( $t_menu_option['url'] ) || !isset( $t_menu_option['title'] ) ) {\n\t\t\tcontinue;\n\t\t}\n\n\t\tif( isset( $t_menu_option['access_level'] ) ) {\n\t\t\tif( !access_has_project_level( $t_menu_option['access_level'] ) ) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t}\n\n\t\tlayout_sidebar_menu( $t_menu_option['url'], $t_menu_option['title'], $t_icon, $p_active_sidebar_page );\n\t}\n}\n\n/**\n * Print sidebar opening elements\n * @return null\n */\nfunction layout_sidebar_begin() {\n\t$t_collapse_block = is_collapsed( 'sidebar' );\n\t$t_block_css = $t_collapse_block ? 'menu-min' : '';\n\n\techo '<div id=\"sidebar\" class=\"sidebar sidebar-fixed responsive compact ' . $t_block_css . '\">';\n\n\techo '<ul class=\"nav nav-list\">';\n}\n\n\n/**\n * Print sidebar menu item\n * @param string $p_page page name\n * @param string $p_title menu title in english\n * @param string $p_icon icon to use for this menu\n * @param string $p_active_sidebar_page page name to set as active\n * @return null\n */\nfunction layout_sidebar_menu( $p_page, $p_title, $p_icon, $p_active_sidebar_page = null ) {\n\tif( $p_page == $p_active_sidebar_page ||\n\t\t$p_page == basename( $_SERVER['SCRIPT_NAME'] ) ) {\n\t\techo '<li class=\"active\">' . \"\\n\";\n\t} else {\n\t\techo '<li>' . \"\\n\";\n\t}\n\n\t# Handle relative / absolute urls\n\tif ( stripos( $p_page, 'https:' ) === 0 || stripos( $p_page, 'http:' ) === 0 ) {\n\t\t$t_url = $p_page;\n\t} else {\n\t\t$t_url = helper_mantis_url( $p_page );\n\t}\n\n\techo '<a href=\"' . $t_url . '\">' . \"\\n\";\n\techo '<i class=\"menu-icon fa ' . $p_icon . '\"></i> ' . \"\\n\";\n\techo '<span class=\"menu-text\"> ' . lang_get_defaulted( $p_title ) . ' </span>' . \"\\n\";\n\techo '</a>' . \"\\n\";\n\techo '<b class=\"arrow\"></b>' . \"\\n\";\n\techo '</li>' . \"\\n\";\n}\n\n\n/**\n * Print sidebar closing elements\n * @return null\n */\nfunction layout_sidebar_end() {\n\techo '</ul>';\n\n\t$t_collapse_block = is_collapsed( 'sidebar' );\n\n\techo '<div id=\"sidebar\" class=\"sidebar-toggle sidebar-collapse\">';\n\tif( layout_is_rtl() ) {\n\t\t$t_block_icon = $t_collapse_block ? 'fa-angle-double-left' : 'fa-angle-double-right';\n\t\techo '<i data-icon2=\"ace-icon fa fa-angle-double-left\" data-icon1=\"ace-icon fa fa-angle-double-right\"\n\t\tclass=\"ace-icon fa ' . $t_block_icon . '\"></i>';\n\t} else {\n\t\t$t_block_icon = $t_collapse_block ? 'fa-angle-double-right' : 'fa-angle-double-left';\n\t\techo '<i data-icon2=\"ace-icon fa fa-angle-double-right\" data-icon1=\"ace-icon fa fa-angle-double-left\"\n\t\tclass=\"ace-icon fa ' . $t_block_icon . '\"></i>';\n\t}\n\techo '</div>';\n\techo '</div>';\n}\n\n/**\n * Render opening markup for main container\n * @return null\n */\nfunction layout_main_container_begin() {\n\techo '<div class=\"main-container\" id=\"main-container\">', \"\\n\";\n}\n\n/**\n * Render closing markup for main container\n * @return null\n */\nfunction layout_main_container_end() {\n\techo '</div>' , \"\\n\";\n}\n\n/**\n * Render opening markup for main content\n * @return null\n */\nfunction layout_main_content_begin() {\n\techo '<div class=\"main-content\">' , \"\\n\";\n}\n\n/**\n * Render closing markup for main content\n * @return null\n */\nfunction layout_main_content_end() {\n\techo '</div>' , \"\\n\";\n}\n\n/**\n * Render opening markup for main page content\n * @return null\n */\nfunction layout_page_content_begin() {\n\techo '  <div class=\"page-content\">' , \"\\n\";\n}\n\n/**\n * Render closing markup for main page content\n * @return null\n */\nfunction layout_page_content_end() {\n\techo '</div>' , \"\\n\";\n}\n\n\n/**\n * Render breadcrumbs bar.\n * @return null\n */\nfunction layout_breadcrumbs() {\n\techo '<div id=\"breadcrumbs\" class=\"breadcrumbs noprint\">' , \"\\n\";\n\n\t# Login information\n\techo '<ul class=\"breadcrumb\">' , \"\\n\";\n\tif( current_user_is_anonymous() ) {\n\t\t$t_return_page = $_SERVER['SCRIPT_NAME'];\n\t\tif( isset( $_SERVER['QUERY_STRING'] ) ) {\n\t\t\t$t_return_page .= '?' . $_SERVER['QUERY_STRING'];\n\t\t}\n\n\t\t$t_return_page = string_url( $t_return_page );\n\n\t\techo ' <li><i class=\"fa fa-user home-icon active\"></i> ' . lang_get( 'anonymous' ) . ' </li>' . \"\\n\";\n\n\t\techo '<div class=\"btn-group btn-corner\">' . \"\\n\";\n\t\techo '\t<a href=\"' . helper_mantis_url( 'login_page.php?return=' . $t_return_page ) .\n\t\t\t'\" class=\"btn btn-primary btn-xs\">' . lang_get( 'login_link' ) . '</a>' . \"\\n\";\n\t\tif( config_get_global( 'allow_signup' ) == ON ) {\n\t\t\techo '\t<a href=\"' . helper_mantis_url( 'signup_page.php' ) . '\" class=\"btn btn-primary btn-xs\">' .\n\t\t\t\tlang_get( 'signup_link' ) . '</a>' . \"\\n\";\n\t\t}\n\t\techo '</div>' . \"\\n\";\n\n\t} else {\n\t\t$t_protected = current_user_get_field( 'protected' );\n\t\t$t_access_level = get_enum_element( 'access_levels', current_user_get_access_level() );\n\t\t$t_display_username = string_html_specialchars( current_user_get_field( 'username' ) );\n\t\t$t_realname = current_user_get_field( 'realname' );\n\t\t$t_display_realname = is_blank( $t_realname ) ? '' : ' ( ' . string_html_specialchars( $t_realname ) . ' ) ';\n\n\t\techo '  <li><i class=\"fa fa-user home-icon active\"></i>';\n\t\t$t_page = ( OFF == $t_protected ) ? 'account_page.php' : 'my_view_page.php';\n\t\techo '  <a href=\"' . helper_mantis_url( $t_page ) . '\">' .\n\t\t\t$t_display_username . $t_display_realname . '</a>' . \"\\n\";\n\n\t\t$t_label = layout_is_rtl() ? 'arrowed-right' : 'arrowed';\n\t\techo '  <span class=\"label hidden-xs label-default ' . $t_label . '\">' . $t_access_level . '</span></li>' . \"\\n\";\n\t}\n\techo '</ul>' , \"\\n\";\n\n\t# Recently visited\n\tif( last_visited_enabled() ) {\n\t\t$t_ids = last_visited_get_array();\n\n\t\tif( count( $t_ids ) > 0 ) {\n\t\t\techo '<div class=\"nav-recent hidden-xs\">' . lang_get( 'recently_visited' ) . ': ';\n\t\t\t$t_first = true;\n\n\t\t\tforeach( $t_ids as $t_id ) {\n\t\t\t\tif( !$t_first ) {\n\t\t\t\t\techo ', ';\n\t\t\t\t} else {\n\t\t\t\t\t$t_first = false;\n\t\t\t\t}\n\n\t\t\t\techo string_get_bug_view_link( $t_id );\n\t\t\t}\n\t\t\techo '</div>';\n\t\t}\n\t}\n\n\t# Bug Jump form\n\t# CSRF protection not required here - form does not result in modifications\n\techo '<div id=\"nav-search\" class=\"nav-search\">';\n\techo '<form class=\"form-search\" method=\"post\" action=\"' . helper_mantis_url( 'jump_to_bug.php' ) . '\">';\n\techo '<span class=\"input-icon\">';\n\techo '<input type=\"text\" name=\"bug_id\" autocomplete=\"off\" class=\"nav-search-input\" placeholder=\"' . lang_get( 'issue_id' ) . '\">';\n\techo '<i class=\"ace-icon fa fa-search nav-search-icon\"></i>';\n\techo '</span>';\n\techo '</form>';\n\techo '</div>';\n\techo PHP_EOL;\n\n\techo '</div>';\n\techo PHP_EOL;\n}\n\n/**\n * Print the page footer information\n * @return void\n */\nfunction layout_footer() {\n\tglobal $g_queries_array, $g_request_time;\n\n\t# If a user is logged in, update their last visit time.\n\t# We do this at the end of the page so that:\n\t#  1) we can display the user's last visit time on a page before updating it\n\t#  2) we don't invalidate the user cache immediately after fetching it\n\t#  3) don't do this on the password verification or update page, as it causes the\n\t#    verification comparison to fail\n\tif( auth_is_user_authenticated() && !current_user_is_anonymous() && !( is_page_name( 'verify.php' ) || is_page_name( 'account_update.php' ) ) ) {\n\t\t$t_user_id = auth_get_current_user_id();\n\t\tuser_update_last_visit( $t_user_id );\n\t}\n\n\tlayout_footer_begin();\n\n\t# Show MantisBT version and copyright statement\n\t$t_version_suffix = '';\n\t$t_copyright_years = ' 2000 - ' . date( 'Y' );\n\tif( config_get( 'show_version' ) == ON ) {\n\t\t$t_version_suffix = ' ' . htmlentities( MANTIS_VERSION . config_get_global( 'version_suffix' ) );\n\t}\n\techo '<div class=\"col-md-6 col-xs-12 no-padding\">' . \"\\n\";\n\techo '<address>' . \"\\n\";\n\techo '<strong>Powered by <a href=\"https://www.mantisbt.org\" title=\"bug tracking software\">MantisBT ' . $t_version_suffix . '</a></strong> <br>' . \"\\n\";\n\techo \"<small>Copyright &copy;$t_copyright_years MantisBT Team</small>\" . '<br>';\n\n\t# Show optional user-specified custom copyright statement\n\t$t_copyright_statement = config_get( 'copyright_statement' );\n\tif( $t_copyright_statement ) {\n\t\techo '<small>' . $t_copyright_statement . '</small>' . \"\\n\";\n\t}\n\n\t# Show contact information\n\tif( !is_page_name( 'login_page' ) ) {\n\t\t$t_webmaster_contact_information = sprintf( lang_get( 'webmaster_contact_information' ), string_html_specialchars( config_get( 'webmaster_email' ) ) );\n\t\techo '<small>' . $t_webmaster_contact_information . '</small>' . '<br>' . \"\\n\";\n\t}\n\n\techo '</address>' . \"\\n\";\n\techo '</div>' . \"\\n\";\n\n\n\t# We don't have a button anymore, so for now we will only show the resized\n\t# version of the logo when not on login page.\n\tif( !is_page_name( 'login_page' ) ) {\n\t\techo '<div class=\"col-md-6 col-xs-12\">' . \"\\n\";\n\t\techo '<div class=\"pull-right\" id=\"powered-by-mantisbt-logo\">' . \"\\n\";\n\t\t$t_mantisbt_logo_url = helper_mantis_url( 'images/mantis_logo.png' );\n\t\techo '<a href=\"https://www.mantisbt.org\" '.\n\t\t\t'title=\"Mantis Bug Tracker: a free and open source web based bug tracking system.\">' .\n\t\t\t'<img src=\"' . $t_mantisbt_logo_url . '\" width=\"102\" height=\"35\" ' .\n\t\t\t'alt=\"Powered by Mantis Bug Tracker: a free and open source web based bug tracking system.\" />' .\n\t\t\t'</a>' . \"\\n\";\n\t\techo '</div>' . \"\\n\";\n\t\techo '</div>' . \"\\n\";\n\t}\n\n\tevent_signal( 'EVENT_LAYOUT_PAGE_FOOTER' );\n\n\tif( config_get( 'show_timer' ) || config_get( 'show_memory_usage' ) || config_get( 'show_queries_count' ) ) {\n\t\techo '<div class=\"col-xs-12 no-padding grey\">' . \"\\n\";\n\t\techo '<address class=\"no-margin pull-right\">' . \"\\n\";\n\t}\n\n\n\t# Print the page execution time\n\tif( config_get( 'show_timer' ) ) {\n\t\t$t_page_execution_time = sprintf( lang_get( 'page_execution_time' ), number_format( microtime( true ) - $g_request_time, 4 ) );\n\t\techo '<small><i class=\"fa fa-clock-o\"></i> ' . $t_page_execution_time . '</small>&#160;&#160;&#160;&#160;' . \"\\n\";\n\t}\n\n\t# Print the page memory usage\n\tif( config_get( 'show_memory_usage' ) ) {\n\t\t$t_page_memory_usage = sprintf( lang_get( 'memory_usage_in_kb' ), number_format( memory_get_peak_usage() / 1024 ) );\n\t\techo '<small><i class=\"fa fa-bolt\"></i> ' . $t_page_memory_usage . '</small>&#160;&#160;&#160;&#160;' . \"\\n\";\n\t}\n\n\t# Determine number of unique queries executed\n\tif( config_get( 'show_queries_count' ) ) {\n\t\t$t_total_queries_count = count( $g_queries_array );\n\t\t$t_unique_queries_count = 0;\n\t\t$t_total_query_execution_time = 0;\n\t\t$t_unique_queries = array();\n\t\tfor ( $i = 0; $i < $t_total_queries_count; $i++ ) {\n\t\t\tif( !in_array( $g_queries_array[$i][0], $t_unique_queries ) ) {\n\t\t\t\t$t_unique_queries_count++;\n\t\t\t\t$g_queries_array[$i][3] = false;\n\t\t\t\tarray_push( $t_unique_queries, $g_queries_array[$i][0] );\n\t\t\t} else {\n\t\t\t\t$g_queries_array[$i][3] = true;\n\t\t\t}\n\t\t\t$t_total_query_execution_time += $g_queries_array[$i][1];\n\t\t}\n\n\t\t$t_total_queries_executed = sprintf( lang_get( 'total_queries_executed' ), $t_total_queries_count );\n\t\techo '<small><i class=\"fa fa-database\"></i> ' . $t_total_queries_executed . '</small>&#160;&#160;&#160;&#160;' . \"\\n\";\n\t\tif( config_get_global( 'db_log_queries' ) ) {\n\t\t\t$t_unique_queries_executed = sprintf( lang_get( 'unique_queries_executed' ), $t_unique_queries_count );\n\t\t\techo '<small><i class=\"fa fa-database\"></i> ' . $t_unique_queries_executed . '</small>&#160;&#160;&#160;&#160;' . \"\\n\";\n\t\t}\n\t\t$t_total_query_time = sprintf( lang_get( 'total_query_execution_time' ), $t_total_query_execution_time );\n\t\techo '<small><i class=\"fa fa-clock-o\"></i> ' . $t_total_query_time . '</small>&#160;&#160;&#160;&#160;' . \"\\n\";\n\t}\n\n\tif( config_get( 'show_timer' ) || config_get( 'show_memory_usage' ) || config_get( 'show_queries_count' ) ) {\n\t\techo '</address>' . \"\\n\";\n\t\techo '</div>' . \"\\n\";\n\t}\n\n\t# Print table of log events\n\tlog_print_to_page();\n\n\tlayout_footer_end();\n}\n\n/**\n * Render opening markup for footer section\n * @return null\n */\nfunction layout_footer_begin() {\n\techo '<div class=\"clearfix\"></div>' . \"\\n\";\n\techo '<div class=\"space-20\"></div>' . \"\\n\";\n\techo '<div class=\"footer noprint\">' . \"\\n\";\n\techo '<div class=\"footer-inner\">' . \"\\n\";\n\techo '<div class=\"footer-content\">' . \"\\n\";\n}\n\n/**\n * Render closing markup for footer section\n * @return null\n */\nfunction layout_footer_end() {\n\techo '</div>' . \"\\n\";\n\techo '</div>' . \"\\n\";\n\techo '</div>' . \"\\n\";\n}\n\n/**\n * Render scroll up link to go at the bottom of the page\n * @return null\n */\nfunction layout_scroll_up_button() {\n\techo '<a class=\"btn-scroll-up btn btn-sm btn-inverse display\" id=\"btn-scroll-up\" href=\"#\">' . \"\\n\";\n\techo '<i class=\"ace-icon fa fa-angle-double-up icon-only bigger-110\"></i>' . \"\\n\";\n\techo '</a>' . \"\\n\";\n}\n"], "fixing_code": ["<?php\n# MantisBT - A PHP based bugtracking system\n\n# MantisBT is free software: you can redistribute it and/or modify\n# it under the terms of the GNU General Public License as published by\n# the Free Software Foundation, either version 2 of the License, or\n# (at your option) any later version.\n#\n# MantisBT is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n# GNU General Public License for more details.\n#\n# You should have received a copy of the GNU General Public License\n# along with MantisBT.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Layout API\n *\n * UI functions to render layout elements in every page. The layout api layer sits above the html api and abstract\n * the lower level html markup into web components\n *\n * Here is the call order for the layout functions\n *\n * layout_page_header\n *      layout_page_header_begin\n *      layout_page_header_end\n * layout_page_begin\n *      ...Page content here...\n * layout_page_end\n *\n *\n *\n * @package CoreAPI\n * @subpackage LayoutAPI\n * @copyright Copyright 2014 MantisBT Team - mantisbt-dev@lists.sourceforge.net\n * @link http://www.mantisbt.org\n *\n * @uses access_api.php\n * @uses utility_api.php\n */\n\n\nrequire_api( 'access_api.php' );\nrequire_api( 'utility_api.php' );\n\n\n/**\n * Print the page header section\n * @param string $p_page_title   Html page title.\n * @param string $p_redirect_url URL to redirect to if necessary.\n * @param string $p_page_id      The page id.\n * @return void\n */\nfunction layout_page_header( $p_page_title = null, $p_redirect_url = null, $p_page_id = null ) {\n\tlayout_page_header_begin( $p_page_title );\n\tif( $p_redirect_url !== null ) {\n\t\thtml_meta_redirect( $p_redirect_url );\n\t}\n\n\tlayout_page_header_end( $p_page_id );\n}\n\n/**\n * Print the part of the page that comes before meta redirect tags should be inserted\n * @param string $p_page_title Page title.\n * @return void\n */\nfunction layout_page_header_begin( $p_page_title = null ) {\n\thtml_begin();\n\thtml_head_begin();\n\thtml_content_type();\n\n\tglobal $g_robots_meta;\n\tif( !is_blank( $g_robots_meta ) ) {\n\t\techo \"\\t\", '<meta name=\"robots\" content=\"', $g_robots_meta, '\" />', \"\\n\";\n\t}\n\n\thtml_title( $p_page_title );\n\tlayout_head_meta();\n\thtml_css();\n\tlayout_head_css();\n\thtml_rss_link();\n\n\t$t_favicon_image = config_get( 'favicon_image' );\n\tif( !is_blank( $t_favicon_image ) ) {\n\t\techo \"\\t\", '<link rel=\"shortcut icon\" href=\"', helper_mantis_url( $t_favicon_image ), '\" type=\"image/x-icon\" />', \"\\n\";\n\t}\n\n\t# Advertise the availability of the browser search plug-ins.\n\t$t_title = config_get( 'search_title' );\n\t$t_searches = array( 'text', 'id' );\n\tforeach( $t_searches as $t_type ) {\n\t\techo \"\\t\",\n\t\t\t'<link rel=\"search\" type=\"application/opensearchdescription+xml\" ',\n\t\t\t\t'title=\"' . sprintf( lang_get( \"opensearch_{$t_type}_description\" ), $t_title ) . '\" ',\n\t\t\t\t'href=\"' . string_sanitize_url( 'browser_search_plugin.php?type=' . $t_type, true ) .\n\t\t\t\t'\"/>',\n\t\t\t\"\\n\";\n\t}\n\n\thtml_head_javascript();\n}\n\n/**\n * Print the part of the page that comes after meta tags and before the\n *  actual page content, but without login info or menus.  This is used\n *  directly during the login process and other times when the user may\n *  not be authenticated\n *\n * @param string $p_page_id The id of the page.\n *\n * @return void\n */\nfunction layout_page_header_end( $p_page_id = null) {\n\tglobal $g_error_send_page_header;\n\n\tevent_signal( 'EVENT_LAYOUT_RESOURCES' );\n\thtml_head_end();\n\n\tif ( $p_page_id === null ) {\n\t\t$t_body_id = '';\n\t} else {\n\t\t$t_body_id = 'id=\"' . $p_page_id . '\" ';\n\t}\n\n\t# Add right-to-left css if needed\n\tif( layout_is_rtl() ) {\n\t\techo '<body ' . $t_body_id . 'class=\"skin-3 rtl\">', \"\\n\";\n\t} else {\n\t\techo '<body ' . $t_body_id . 'class=\"skin-3\">', \"\\n\";\n\t}\n\n\tevent_signal( 'EVENT_LAYOUT_BODY_BEGIN' );\n\n\t$g_error_send_page_header = false;\n}\n\n/**\n * Print page common elements including navbar, sidebar, info bar\n * @param string $p_active_sidebar_page sidebar page where the current page lives under\n * @return void\n */\nfunction layout_page_begin( $p_active_sidebar_page = null ) {\n\tlayout_navbar();\n\n\tif( !db_is_connected() ) {\n\t\treturn;\n\t}\n\n\tlayout_main_container_begin();\n\n\tlayout_print_sidebar( $p_active_sidebar_page );\n\n\tlayout_main_content_begin();\n\n\tlayout_breadcrumbs();\n\n\tlayout_page_content_begin();\n\n\tif( auth_is_user_authenticated() ) {\n\t\tif( ON == config_get( 'show_project_menu_bar' ) ) {\n\t\t\techo '<div class=\"row\">' , \"\\n\";\n\t\t\tprint_project_menu_bar();\n\t\t\techo '</div>' , \"\\n\";\n\t\t}\n\t}\n\techo '<div class=\"row\">' , \"\\n\";\n\n\tevent_signal( 'EVENT_LAYOUT_CONTENT_BEGIN' );\n}\n\n/**\n * Print elements at the end of each page\n * @return void\n */\nfunction layout_page_end() {\n\tif( !db_is_connected() ) {\n\t\treturn;\n\t}\n\n\tevent_signal( 'EVENT_LAYOUT_CONTENT_END' );\n\n\techo '</div>' , \"\\n\";\n\n\tlayout_page_content_end();\n\tlayout_main_content_end();\n\n\tlayout_footer();\n\tlayout_scroll_up_button();\n\n\tlayout_main_container_end();\n\tlayout_body_javascript();\n\n\thtml_body_end();\n\thtml_end();\n}\n\n/**\n * Print common elements for admin pages\n * @return void\n */\nfunction layout_admin_page_begin() {\n\tlayout_navbar();\n\n\tlayout_main_container_begin();\n}\n\n/**\n * Print elements at the end of each admin page\n * @return void\n */\nfunction layout_admin_page_end() {\n\tlayout_footer();\n\tlayout_scroll_up_button();\n\n\tlayout_main_container_end();\n\tlayout_body_javascript();\n\n\thtml_body_end();\n    html_end();\n}\n\n\n\n/**\n * Check if the layout is setup for right to left languages\n * @return bool\n */\nfunction layout_is_rtl() {\n\tif( lang_get( 'directionality' ) == 'rtl' ) {\n\t\treturn true;\n\t}\n\treturn false;\n}\n\n/**\n * Print meta tags for the page head\n * @return null\n */\nfunction layout_head_meta() {\n\t# use the following meta to force IE use its most up to date rendering engine\n\techo '<meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge,chrome=1\" />' . \"\\n\";\n\n\techo '<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0\" />' . \"\\n\";\n}\n\n/**\n * Print css link directives for the head section of the page\n * @return null\n */\nfunction layout_head_css() {\n\t# bootstrap & fontawesome\n\tif ( config_get_global( 'cdn_enabled' ) == ON ) {\n\t\thtml_css_cdn_link( 'https://maxcdn.bootstrapcdn.com/bootstrap/' . BOOTSTRAP_VERSION . '/css/bootstrap.min.css' );\n\t\thtml_css_cdn_link( 'https://maxcdn.bootstrapcdn.com/font-awesome/' . FONT_AWESOME_VERSION . '/css/font-awesome.min.css' );\n\n\t\t# theme text fonts\n\t\thtml_css_cdn_link( 'https://fonts.googleapis.com/css?family=Open+Sans:300,400' );\n\n\t\t# datetimepicker\n\t\thtml_css_cdn_link( 'https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/' . DATETIME_PICKER_VERSION . '/css/bootstrap-datetimepicker.min.css' );\n\t} else {\n\t\thtml_css_link( 'bootstrap-' . BOOTSTRAP_VERSION . '.min.css' );\n\t\thtml_css_link( 'font-awesome-' . FONT_AWESOME_VERSION . '.min.css' );\n\n\t\t# theme text fonts\n\t\thtml_css_link( 'open-sans.css' );\n\n\t\t# datetimepicker\n\t\thtml_css_link( 'bootstrap-datetimepicker-' . DATETIME_PICKER_VERSION . '.min.css' );\n\t}\n\n\t# page specific plugin styles\n\n\t# theme styles\n\thtml_css_link( 'ace.min.css' );\n\thtml_css_link( 'ace-mantis.css' );\n\n\t# handle IE separately\n\techo '<!--[if lte IE 9]>';\n\thtml_css_link( 'ace-part2.min.css' );\n\techo '<![endif]-->';\n\thtml_css_link( 'ace-skins.min.css' );\n\n\tif( layout_is_rtl() ) {\n\t\thtml_css_link( 'ace-rtl.min.css' );\n\t}\n\n\techo '<!--[if lte IE 9]>';\n\thtml_css_link( 'ace-ie.min.css' );\n\techo '<![endif]-->';\n\techo \"\\n\";\n}\n\n\n/**\n * Print javascript directives for the head section of the page\n * @return null\n */\nfunction layout_head_javascript() {\n\t# HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries\n\techo '<!--[if lte IE 8]>';\n\thtml_javascript_link( 'html5shiv.min.js' );\n\thtml_javascript_link( 'respond.min.js' );\n\techo '<![endif]-->';\n\techo \"\\n\";\n}\n\n\n/**\n * Print javascript directives before the closing of the page body element\n * @return null\n */\nfunction layout_body_javascript() {\n\tif ( config_get_global( 'cdn_enabled' ) == ON ) {\n\t\t# bootstrap\n\t\thtml_javascript_cdn_link( 'https://maxcdn.bootstrapcdn.com/bootstrap/' . BOOTSTRAP_VERSION . '/js/bootstrap.min.js', BOOTSTRAP_HASH );\n\n\t\t# moment & datetimepicker\n\t\thtml_javascript_cdn_link( 'https://cdnjs.cloudflare.com/ajax/libs/moment.js/' . MOMENT_VERSION . '/moment-with-locales.min.js', MOMENT_HASH );\n\t\thtml_javascript_cdn_link( 'https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/' . DATETIME_PICKER_VERSION . '/js/bootstrap-datetimepicker.min.js', DATETIME_PICKER_HASH );\n\t\t\n\t\t# listjs\n\t\thtml_javascript_cdn_link( 'https://cdnjs.cloudflare.com/ajax/libs/list.js/' . LISTJS_VERSION . '/list.min.js', LISTJS_HASH );\n\t} else {\n\t\t# bootstrap\n\t\thtml_javascript_link( 'bootstrap-' . BOOTSTRAP_VERSION . '.min.js' );\n\n\t\t# moment & datetimepicker\n\t\thtml_javascript_link( 'moment-with-locales-' . MOMENT_VERSION . '.min.js' );\n\t\thtml_javascript_link( 'bootstrap-datetimepicker-' . DATETIME_PICKER_VERSION . '.min.js' );\n\n\t\t# listjs\n\t\thtml_javascript_link( 'list-' . LISTJS_VERSION . '.min.js' );\n\t}\n\n\t# theme scripts\n\thtml_javascript_link( 'ace-extra.min.js' );\n\thtml_javascript_link( 'ace-elements.min.js' );\n\thtml_javascript_link( 'ace.min.js' );\n}\n\n\n/**\n * Print opening markup for login/signup/register pages\n * @return null\n */\nfunction layout_login_page_begin() {\n\thtml_begin();\n\thtml_head_begin();\n\thtml_content_type();\n\n\tglobal $g_robots_meta;\n\tif( !is_blank( $g_robots_meta ) ) {\n\t\techo \"\\t\", '<meta name=\"robots\" content=\"', $g_robots_meta, '\" />', \"\\n\";\n\t}\n\n\thtml_title();\n\tlayout_head_meta();\n\thtml_css();\n\tlayout_head_css();\n\thtml_rss_link();\n\n\t$t_favicon_image = config_get( 'favicon_image' );\n\tif( !is_blank( $t_favicon_image ) ) {\n\t\techo \"\\t\", '<link rel=\"shortcut icon\" href=\"', helper_mantis_url( $t_favicon_image ), '\" type=\"image/x-icon\" />', \"\\n\";\n\t}\n\n\t# Advertise the availability of the browser search plug-ins.\n\techo \"\\t\", '<link rel=\"search\" type=\"application/opensearchdescription+xml\" title=\"MantisBT: Text Search\" href=\"' . string_sanitize_url( 'browser_search_plugin.php?type=text', true) . '\" />' . \"\\n\";\n\techo \"\\t\", '<link rel=\"search\" type=\"application/opensearchdescription+xml\" title=\"MantisBT: Issue Id\" href=\"' . string_sanitize_url( 'browser_search_plugin.php?type=id', true) . '\" />' . \"\\n\";\n\t\n\thtml_head_javascript();\n\t\n\tevent_signal( 'EVENT_LAYOUT_RESOURCES' );\n\thtml_head_end();\n\n\techo '<body class=\"login-layout light-login\">';\n\tlayout_main_container_begin();\n\tlayout_main_content_begin();\n\techo '<div class=\"row\">';\n}\n\n/**\n * Print closing markup for login/signup/register pages\n * @return null\n */\nfunction layout_login_page_end() {\n\techo '</div>';\n\tlayout_main_content_end();\n\tlayout_main_container_end();\n\tlayout_body_javascript();\n\n\techo '</body>', \"\\n\";\n}\n\n/**\n * Render navbar at the top of the page\n * @return null\n */\nfunction layout_navbar() {\n\t$t_logo_url = config_get('logo_url');\n\n\techo '<div id=\"navbar\" class=\"navbar navbar-default navbar-collapse navbar-fixed-top noprint\">';\n\techo '<div id=\"navbar-container\" class=\"navbar-container\">';\n\n\techo '<button id=\"menu-toggler\" type=\"button\" class=\"navbar-toggle menu-toggler pull-left hidden-lg\" data-target=\"#sidebar\">';\n\techo '<span class=\"sr-only\">Toggle sidebar</span>';\n\techo '<span class=\"icon-bar\"></span>';\n\techo '<span class=\"icon-bar\"></span>';\n\techo '<span class=\"icon-bar\"></span>';\n\techo '</button>';\n\n\techo '<div class=\"navbar-header\">';\n\techo '<a href=\"' . $t_logo_url . '\" class=\"navbar-brand\">';\n\techo '<span class=\"smaller-75\"> ';\n\techo string_display_line( config_get('window_title') );\n\techo ' </span>';\n\techo '</a>';\n\n\t$t_toggle_class = (OFF == config_get('show_avatar') ? 'navbar-toggle' : 'navbar-toggle-img');\n\techo '<button type=\"button\" class=\"navbar-toggle ' . $t_toggle_class . ' collapsed pull-right hidden-sm hidden-md hidden-lg\" data-toggle=\"collapse\" data-target=\".navbar-buttons,.navbar-menu\">';\n\techo '<span class=\"sr-only\">Toggle user menu</span>';\n\tif (auth_is_user_authenticated()) {\n\t\tlayout_navbar_user_avatar();\n\t}\n\techo '</button>';\n\n\techo '</div>';\n\n\techo '<div class=\"navbar-buttons navbar-header navbar-collapse collapse\">';\n\techo '<ul class=\"nav ace-nav\">';\n\tif (auth_is_user_authenticated()) {\n\t\t# shortcuts button bar\n\t\tlayout_navbar_button_bar();\n\t\t# projects dropdown menu\n\t\tlayout_navbar_projects_menu();\n\t\t# user buttons such as messages, notifications and user menu\n\t\tlayout_navbar_user_menu();\n\t}\n\techo '</ul>';\n\techo '</div>';\n\n\techo '</div>';\n\techo '</div>';\n}\n\n/**\n * Print navbar menu item\n * @param string $p_url destination url of the menu item\n * @param string $p_title menu item title\n * @param string $p_icon icon to use for this menu\n * @return null\n */\nfunction layout_navbar_menu_item( $p_url, $p_title, $p_icon ) {\n\techo '<li>';\n\techo '<a href=\"' . $p_url . '\">';\n\techo '<i class=\"ace-icon fa ' . $p_icon . '\"> </i> ' . $p_title;\n\techo '</a>';\n\techo '</li>';\n}\n\n/**\n * Print navbar user menu at the top right of the page\n * @param bool $p_show_avatar decide whether to show logged in user avatar\n * @return null\n */\nfunction layout_navbar_user_menu( $p_show_avatar = true ) {\n\tif( !auth_is_user_authenticated() ) {\n\t\treturn;\n\t}\n\n\t$t_username = current_user_get_field( 'username' );\n\n\techo '<li class=\"grey\">';\n\techo '<a data-toggle=\"dropdown\" href=\"#\" class=\"dropdown-toggle\">';\n\tif( $p_show_avatar ) {\n\t\tlayout_navbar_user_avatar( 'nav-user-photo' );\n\t\techo '<span class=\"user-info\">';\n\t\techo $t_username;\n\t\techo '</span>';\n\t\techo '<i class=\"ace-icon fa fa-angle-down\"></i>';\n\t} else {\n\t\techo '&#160;' . $t_username . '&#160;' . \"\\n\";\n\t\techo '<i class=\"ace-icon fa fa-angle-down bigger-110\"></i>';\n\t}\n\techo '</a>';\n\techo '<ul class=\"user-menu dropdown-menu dropdown-menu-right dropdown-yellow dropdown-caret dropdown-close\">';\n\n\t# My Account\n\tif( !current_user_is_protected() ) {\n\t\tlayout_navbar_menu_item( helper_mantis_url( 'account_page.php' ), lang_get( 'account_link' ), 'fa-user' );\n\t}\n\n\t# RSS Feed\n\tif( OFF != config_get( 'rss_enabled' ) ) {\n\t\tlayout_navbar_menu_item( htmlspecialchars( rss_get_issues_feed_url() ), lang_get( 'rss' ), 'fa-rss-square orange' );\n\t}\n\n\techo '<li class=\"divider\"></li>';\n\n\t# Logout\n\tlayout_navbar_menu_item( helper_mantis_url( 'logout_page.php' ), lang_get( 'logout_link' ), 'fa-sign-out' );\n\techo '</ul>';\n\techo '</li>';\n}\n\n\n/**\n * Print navbar projects menu at the top right of the page\n * @return null\n */\nfunction layout_navbar_projects_menu() {\n\tif( !auth_is_user_authenticated() ) {\n\t\treturn;\n\t}\n\n\t# Project Selector (hidden if only one project visible to user)\n\t$t_show_project_selector = true;\n\t$t_project_ids = current_user_get_accessible_projects();\n\tif( count( $t_project_ids ) == 1 ) {\n\t\t$t_project_id = (int) $t_project_ids[0];\n\t\tif( count( current_user_get_accessible_subprojects( $t_project_id ) ) == 0 ) {\n\t\t\t$t_show_project_selector = false;\n\t\t}\n\t}\n\n\tif( $t_show_project_selector ) {\n\t\techo '<li class=\"grey\">' . \"\\n\";\n\t\techo '<a data-toggle=\"dropdown\" href=\"#\" class=\"dropdown-toggle\">' . \"\\n\";\n\n\t\t$t_current_project_id = helper_get_current_project();\n\t\tif( ALL_PROJECTS == $t_current_project_id) {\n\t\t\techo '&#160;' . string_attribute( lang_get( 'all_projects' ) ) . '&#160;' . \"\\n\";\n\t\t} else {\n\t\t\techo '&#160;' . string_attribute( project_get_field( $t_current_project_id, 'name' ) ) . '&#160;' . \"\\n\";\n\t\t}\n\n\t\techo ' <i class=\"ace-icon fa fa-angle-down bigger-110\"></i>' . \"\\n\";\n\t\techo '</a>' . \"\\n\";\n\n\t\techo '<ul class=\"dropdown-menu dropdown-menu-right dropdown-yellow dropdown-caret dropdown-close scrollable-menu\">' . \"\\n\";\n\t\tlayout_navbar_projects_list( join( ';', helper_get_current_project_trace() ), true, null, true );\n\t\techo '</ul>' . \"\\n\";\n\t\techo '</li>' . \"\\n\";\n\t} else {\n\t\t# User has only one project, set it as both current and default\n\t\tif( ALL_PROJECTS == helper_get_current_project() ) {\n\t\t\thelper_set_current_project( $t_project_id );\n\n\t\t\tif( !current_user_is_protected() ) {\n\t\t\t\tcurrent_user_set_default_project( $t_project_id );\n\t\t\t}\n\n\t\t\t# Force reload of current page, except if we got here after\n\t\t\t# creating the first project\n\t\t\t$t_redirect_url = str_replace( config_get( 'short_path' ), '', $_SERVER['REQUEST_URI'] );\n\t\t\tif( 'manage_proj_create.php' != $t_redirect_url ) {\n\t\t\t\thtml_meta_redirect( $t_redirect_url, 0, false );\n\t\t\t}\n\t\t}\n\t}\n}\n\n/**\n * Print navbar bottons\n * @return null\n */\nfunction layout_navbar_button_bar() {\n\tif( !auth_is_user_authenticated() ) {\n\t\treturn;\n\t}\n\n\t$t_can_report_bug = access_has_any_project_level( 'report_bug_threshold' );\n\t$t_can_invite_user = current_user_is_administrator();\n\n\tif( !$t_can_report_bug && !$t_can_invite_user ) {\n\t\treturn;\n\t}\n\n\techo '<li class=\"hidden-sm hidden-xs\">';\n  \techo '<div class=\"btn-group btn-corner padding-right-8 padding-left-8\">';\n\n  \tif( $t_can_report_bug ) {\n\t\t$t_bug_url = string_get_bug_report_url();\n\t  \techo '<a class=\"btn btn-primary btn-sm\" href=\"' . $t_bug_url . '\">';\n\t\techo '<i class=\"fa fa-edit\"></i> ' . lang_get( 'report_bug_link' );\n\t\techo '</a>';\n  \t}\n\n\tif( $t_can_invite_user ) {\n\t\techo '<a class=\"btn btn-primary btn-sm\" href=\"manage_user_create_page.php\">';\n\t\techo '<i class=\"fa fa-user-plus\"></i> ' . lang_get( 'invite_users' );\n\t\techo '</a>';\n\t}\n\n\techo '</div>';\n  \techo '</li>';\n}\n\n/**\n * Print projects that the current user has access to.\n *\n * @param int $p_project_id \tThe current project id or null to use cookie.\n * @param bool $p_include_all_projects  true: include \"All Projects\", otherwise false.\n * @param int|null $p_filter_project_id  The id of a project to exclude or null.\n * @param string|bool $p_trace  The current project trace, identifies the sub-project via a path from top to bottom.\n * @param bool $p_can_report_only If true, disables projects in which user can't report issues; defaults to false (all projects enabled)\n */\nfunction layout_navbar_projects_list( $p_project_id = null, $p_include_all_projects = true, $p_filter_project_id = null, $p_trace = false, $p_can_report_only = false ) {\n\t$t_user_id = auth_get_current_user_id();\n\t$t_project_ids = user_get_accessible_projects( $t_user_id );\n\t$t_can_report = true;\n\tproject_cache_array_rows( $t_project_ids );\n\n\tif( $p_include_all_projects && $p_filter_project_id !== ALL_PROJECTS ) {\n\t\techo ALL_PROJECTS == $p_project_id ? '<li class=\"active\">' : '<li>';\n\t\techo '<a href=\"' . helper_mantis_url( 'set_project.php' ) . '?project_id=' . ALL_PROJECTS . '\"';\n\t\tif( $p_project_id !== null ) {\n\t\t\tcheck_selected( $p_project_id, ALL_PROJECTS, false );\n\t\t}\n\t\techo '> ' . lang_get( 'all_projects' ) . ' </a></li>' . \" \\n\";\n\t\techo '<li class=\"divider\"></li>' . \"\\n\";\n\t}\n\n\techo '<li>';\n\techo '<div id=\"projects-list\">';\n\techo '<div class=\"projects-searchbox\">';\n\techo '<input class=\"search form-control input-md\" placeholder=\"' . lang_get( 'search' ) . '\" />';\n\techo '</div>';\n\techo '<ul class=\"list dropdown-yellow no-margin\">';\n\n\tforeach( $t_project_ids as $t_id ) {\n\t\tif( $p_can_report_only ) {\n\t\t\t$t_report_bug_threshold = config_get( 'report_bug_threshold', null, $t_user_id, $t_id );\n\t\t\t$t_can_report = access_has_project_level( $t_report_bug_threshold, $t_id, $t_user_id );\n\t\t}\n\n\t\techo 0 == strcmp( $t_id, $p_project_id ) ? '<li class=\"active\">' : '<li>';\n\t\techo '<a href=\"' . helper_mantis_url( 'set_project.php' ) . '?project_id=' . $t_id . '\"';\n\t\tcheck_selected( $p_project_id, $t_id, false );\n\t\tcheck_disabled( $t_id == $p_filter_project_id || !$t_can_report );\n\t\techo ' class=\"project-link\"> ' . string_attribute( project_get_field( $t_id, 'name' ) ) . ' </a></li>' . \"\\n\";\n\t\tlayout_navbar_subproject_option_list( $t_id, $p_project_id, $p_filter_project_id, $p_trace, $p_can_report_only );\n\t}\n\n\techo '</ul>';\n\techo '</div>';\n\techo '</li>';\n}\n\n/**\n * List projects that the current user has access to\n *\n * @param integer $p_parent_id         A parent project identifier.\n * @param integer $p_project_id        A project identifier.\n * @param integer $p_filter_project_id A filter project identifier.\n * @param boolean $p_trace             Whether to trace parent projects.\n * @param boolean $p_can_report_only   If true, disables projects in which user can't report issues; defaults to false (all projects enabled).\n * @param array   $p_parents           Array of parent projects.\n * @return void\n */\nfunction layout_navbar_subproject_option_list( $p_parent_id, $p_project_id = null, $p_filter_project_id = null, $p_trace = false, $p_can_report_only = false, array $p_parents = array() ) {\n\tarray_push( $p_parents, $p_parent_id );\n\t$t_user_id = auth_get_current_user_id();\n\t$t_project_ids = user_get_accessible_subprojects( $t_user_id, $p_parent_id );\n\t$t_can_report = true;\n\n\tforeach( $t_project_ids as $t_id ) {\n\t\tif( $p_can_report_only ) {\n\t\t\t$t_report_bug_threshold = config_get( 'report_bug_threshold', null, $t_user_id, $t_id );\n\t\t\t$t_can_report = access_has_project_level( $t_report_bug_threshold, $t_id, $t_user_id );\n\t\t}\n\n\t\tif( $p_trace ) {\n\t\t\t$t_full_id = join( $p_parents, \";\" ) . ';' . $t_id;\n\t\t} else {\n\t\t\t$t_full_id = $t_id;\n\t\t}\n\n\t\techo 0 == strcmp( $p_project_id, $t_full_id ) ? '<li class=\"active\">' : '<li>';\n\t\techo '<a href=\"' . helper_mantis_url( 'set_project.php' ) . '?project_id=' . $t_full_id . '\"';\n\t\tcheck_selected( $p_project_id, $t_full_id, false );\n\t\tcheck_disabled( $t_id == $p_filter_project_id || !$t_can_report );\n\t\techo ' class=\"project-link\"> ' . str_repeat( '&#160;', count( $p_parents ) * 4 );\n\t\techo string_attribute( project_get_field( $t_id, 'name' ) ) . '</a></li>' . \"\\n\";\n\n\t\tlayout_navbar_subproject_option_list( $t_id, $p_project_id, $p_filter_project_id, $p_trace, $p_can_report_only, $p_parents );\n\t}\n}\n\n\n/**\n * Print user avatar in the navbar\n * @param string $p_img_class css class to use with the img tag\n * @return null\n */\nfunction layout_navbar_user_avatar( $p_img_class = '' ) {\n\t$t_default_avatar = '<i class=\"ace-icon fa fa-user fa-2x white\"></i> ';\n\n\tif( OFF === config_get( 'show_avatar' ) ) {\n\t\techo $t_default_avatar;\n\t\treturn;\n\t}\n\n\t$p_user_id = auth_get_current_user_id();\n\tif( !user_exists( $p_user_id ) ) {\n\t\techo $t_default_avatar;\n\t\treturn;\n\t}\n\n\tif( access_has_project_level( config_get( 'show_avatar_threshold' ), null, $p_user_id ) ) {\n\t\t$t_avatar = Avatar::get( $p_user_id, 32 );\n\t\tif( false !== $t_avatar ) {\n\t\t\t$t_image = htmlspecialchars( $t_avatar->image );\n\t\t\t$t_text = htmlspecialchars( $t_avatar->text );\n\n\t\t\techo '<img class=\"nav-user-photo\" src=\"' . $t_image . '\" alt=\"' . $t_text . '\" />';\n\t\t\treturn;\n\t\t}\n\t}\n\n\techo $t_default_avatar;\n}\n\n/**\n * Print sidebar\n * @param string $p_active_sidebar_page page where the displayed page lives under\n * @return void\n */\nfunction layout_print_sidebar( $p_active_sidebar_page = null ) {\n\tif( auth_is_user_authenticated() ) {\n\t\t$t_protected = current_user_get_field( 'protected' );\n\t\t$t_current_project = helper_get_current_project();\n\n\t\t# Starting sidebar markup\n\t\tlayout_sidebar_begin();\n\n\t\t# Plugin / Event added options\n\t\t$t_event_menu_options = event_signal( 'EVENT_MENU_MAIN_FRONT' );\n\t\tlayout_plugin_menu_options_for_sidebar( $t_event_menu_options, $p_active_sidebar_page );\n\n\t\t# Main Page\n\t\tif( config_get( 'news_enabled' ) == ON ) {\n\t\t\tlayout_sidebar_menu( 'main_page.php', 'main_link', 'fa-bullhorn', $p_active_sidebar_page  );\n\t\t}\n\n\t\t# My View\n\t\tlayout_sidebar_menu( 'my_view_page.php', 'my_view_link', 'fa-dashboard', $p_active_sidebar_page );\n\n\t\t# View Bugs\n\t\tlayout_sidebar_menu( 'view_all_bug_page.php', 'view_bugs_link', 'fa-list-alt', $p_active_sidebar_page );\n\n\t\t# Report Bugs\n\t\tif( access_has_any_project_level( 'report_bug_threshold' ) ) {\n\t\t\t$t_bug_url = string_get_bug_report_url();\n\t\t\tlayout_sidebar_menu( $t_bug_url, 'report_bug_link', 'fa-edit', $p_active_sidebar_page );\n\t\t}\n\n\t\t# Changelog Page\n\t\tif( access_has_project_level( config_get( 'view_changelog_threshold' ) ) ) {\n\t\t\tlayout_sidebar_menu( 'changelog_page.php', 'changelog_link', 'fa-retweet', $p_active_sidebar_page );\n\t\t}\n\n\t\t# Roadmap Page\n\t\tif( access_has_project_level( config_get( 'roadmap_view_threshold' ) ) ) {\n\t\t\tlayout_sidebar_menu( 'roadmap_page.php', 'roadmap_link', 'fa-road', $p_active_sidebar_page );\n\t\t}\n\n\t\t# Summary Page\n\t\tif( access_has_project_level( config_get( 'view_summary_threshold' ) ) ) {\n\t\t\tlayout_sidebar_menu( 'summary_page.php', 'summary_link', 'fa-bar-chart-o', $p_active_sidebar_page );\n\t\t}\n\n\t\t# Project Documentation Page\n\t\tif( ON == config_get( 'enable_project_documentation' ) ) {\n\t\t\tlayout_sidebar_menu( 'proj_doc_page.php', 'docs_link', 'fa-book', $p_active_sidebar_page );\n\t\t}\n\n\t\t# Project Wiki\n\t\tif( ON == config_get_global( 'wiki_enable' )  ) {\n\t\t\tlayout_sidebar_menu( 'wiki.php?type=project&amp;id=' . $t_current_project, 'wiki', 'fa-book', $p_active_sidebar_page );\n\t\t}\n\n\t\t# Manage Users (admins) or Manage Project (managers) or Manage Custom Fields\n\t\tif( access_has_global_level( config_get( 'manage_site_threshold' ) ) ) {\n\t\t\tlayout_sidebar_menu( 'manage_overview_page.php', 'manage_link', 'fa-gears', $p_active_sidebar_page );\n\t\t} else {\n\t\t\t$t_show_access = min( config_get( 'manage_user_threshold' ), config_get( 'manage_project_threshold' ), config_get( 'manage_custom_fields_threshold' ) );\n\t\t\tif( access_has_global_level( $t_show_access ) || access_has_any_project( $t_show_access ) ) {\n\t\t\t\t$t_current_project = helper_get_current_project();\n\t\t\t\tif( access_has_global_level( config_get( 'manage_user_threshold' ) ) ) {\n\t\t\t\t\t$t_link = 'manage_user_page.php';\n\t\t\t\t} else {\n\t\t\t\t\tif( access_has_project_level( config_get( 'manage_project_threshold' ), $t_current_project ) && ( $t_current_project <> ALL_PROJECTS ) ) {\n\t\t\t\t\t\t$t_link = 'manage_proj_edit_page.php?project_id=' . $t_current_project;\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$t_link = 'manage_proj_page.php';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tlayout_sidebar_menu( $t_link , 'manage_link', 'fa-gears' );\n\t\t\t}\n\t\t}\n\n\t\t# Time Tracking / Billing\n\t\tif( config_get( 'time_tracking_enabled' ) && access_has_global_level( config_get( 'time_tracking_reporting_threshold' ) ) ) {\n\t\t\tlayout_sidebar_menu( 'billing_page.php', 'time_tracking_billing_link', 'fa-clock-o', $p_active_sidebar_page );\n\t\t}\n\n\t\t# Plugin / Event added options\n\t\t$t_event_menu_options = event_signal( 'EVENT_MENU_MAIN' );\n\t\tlayout_plugin_menu_options_for_sidebar( $t_event_menu_options, $p_active_sidebar_page );\n\n\t\t# Config based custom options\n\t\tlayout_config_menu_options_for_sidebar( $p_active_sidebar_page );\n\n\t\t# Ending sidebar markup\n\t\tlayout_sidebar_end();\n\t}\n}\n\n/**\n * Process plugin menu options for sidebar\n * @param array $p_plugin_event_response The response from the plugin event signal.\n * @param string $p_active_sidebar_page The active page on the sidebar.\n * @return void\n */\nfunction layout_plugin_menu_options_for_sidebar( $p_plugin_event_response, $p_active_sidebar_page ) {\n\t$t_menu_options = array();\n\n\tforeach( $p_plugin_event_response as $t_plugin => $t_plugin_menu_options ) {\n\t\tforeach( $t_plugin_menu_options as $t_callback => $t_callback_menu_options ) {\n\t\t\tif( is_array( $t_callback_menu_options ) ) {\n\t\t\t\t$t_menu_options = array_merge( $t_menu_options, $t_callback_menu_options );\n\t\t\t} else {\n\t\t\t\tif( !is_null( $t_callback_menu_options ) ) {\n\t\t\t\t\t$t_menu_options[] = $t_callback_menu_options;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tlayout_options_for_sidebar( $t_menu_options, $p_active_sidebar_page );\n}\n\n/**\n * Process main menu options from config.\n * @param string $p_active_sidebar_page The active page on the sidebar.\n * @return void\n */\nfunction layout_config_menu_options_for_sidebar( $p_active_sidebar_page ) {\n\t$t_menu_options = array();\n\t$t_custom_options = config_get( 'main_menu_custom_options' );\n\n\tforeach( $t_custom_options as $t_custom_option ) {\n\t\tif( isset( $t_custom_option['url'] ) ) {\n\t\t\t$t_menu_option = $t_custom_option;\n\t\t} else {\n\t\t\t# Support < 2.0.0 custom menu options config format\n\t\t\t$t_menu_option = array();\n\t\t\t$t_menu_option['title'] = $t_custom_option[0];\n\t\t\t$t_menu_option['access_level'] = $t_custom_option[1];\n\t\t\t$t_menu_option['url'] = $t_custom_option[2];\n\t\t}\n\n\t\t$t_menu_options[] = $t_menu_option;\n\t}\n\n\tlayout_options_for_sidebar( $t_menu_options, $p_active_sidebar_page );\n}\n\n/**\n * Process main menu options\n * @param array $p_menu_options Array of menu options to output.\n * @param string $p_active_sidebar_page The active page on the sidebar.\n * @return void\n */\nfunction layout_options_for_sidebar( $p_menu_options, $p_active_sidebar_page ) {\n\tforeach( $p_menu_options as $t_menu_option ) {\n\t\t$t_icon = isset( $t_menu_option['icon'] ) ? $t_menu_option['icon'] : 'fa-plug';\n\t\tif( !isset( $t_menu_option['url'] ) || !isset( $t_menu_option['title'] ) ) {\n\t\t\tcontinue;\n\t\t}\n\n\t\tif( isset( $t_menu_option['access_level'] ) ) {\n\t\t\tif( !access_has_project_level( $t_menu_option['access_level'] ) ) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t}\n\n\t\tlayout_sidebar_menu( $t_menu_option['url'], $t_menu_option['title'], $t_icon, $p_active_sidebar_page );\n\t}\n}\n\n/**\n * Print sidebar opening elements\n * @return null\n */\nfunction layout_sidebar_begin() {\n\t$t_collapse_block = is_collapsed( 'sidebar' );\n\t$t_block_css = $t_collapse_block ? 'menu-min' : '';\n\n\techo '<div id=\"sidebar\" class=\"sidebar sidebar-fixed responsive compact ' . $t_block_css . '\">';\n\n\techo '<ul class=\"nav nav-list\">';\n}\n\n\n/**\n * Print sidebar menu item\n * @param string $p_page page name\n * @param string $p_title menu title in english\n * @param string $p_icon icon to use for this menu\n * @param string $p_active_sidebar_page page name to set as active\n * @return null\n */\nfunction layout_sidebar_menu( $p_page, $p_title, $p_icon, $p_active_sidebar_page = null ) {\n\tif( $p_page == $p_active_sidebar_page ||\n\t\t$p_page == basename( $_SERVER['SCRIPT_NAME'] ) ) {\n\t\techo '<li class=\"active\">' . \"\\n\";\n\t} else {\n\t\techo '<li>' . \"\\n\";\n\t}\n\n\t# Handle relative / absolute urls\n\tif ( stripos( $p_page, 'https:' ) === 0 || stripos( $p_page, 'http:' ) === 0 ) {\n\t\t$t_url = $p_page;\n\t} else {\n\t\t$t_url = helper_mantis_url( $p_page );\n\t}\n\n\techo '<a href=\"' . $t_url . '\">' . \"\\n\";\n\techo '<i class=\"menu-icon fa ' . $p_icon . '\"></i> ' . \"\\n\";\n\techo '<span class=\"menu-text\"> ' . lang_get_defaulted( $p_title ) . ' </span>' . \"\\n\";\n\techo '</a>' . \"\\n\";\n\techo '<b class=\"arrow\"></b>' . \"\\n\";\n\techo '</li>' . \"\\n\";\n}\n\n\n/**\n * Print sidebar closing elements\n * @return null\n */\nfunction layout_sidebar_end() {\n\techo '</ul>';\n\n\t$t_collapse_block = is_collapsed( 'sidebar' );\n\n\techo '<div id=\"sidebar\" class=\"sidebar-toggle sidebar-collapse\">';\n\tif( layout_is_rtl() ) {\n\t\t$t_block_icon = $t_collapse_block ? 'fa-angle-double-left' : 'fa-angle-double-right';\n\t\techo '<i data-icon2=\"ace-icon fa fa-angle-double-left\" data-icon1=\"ace-icon fa fa-angle-double-right\"\n\t\tclass=\"ace-icon fa ' . $t_block_icon . '\"></i>';\n\t} else {\n\t\t$t_block_icon = $t_collapse_block ? 'fa-angle-double-right' : 'fa-angle-double-left';\n\t\techo '<i data-icon2=\"ace-icon fa fa-angle-double-right\" data-icon1=\"ace-icon fa fa-angle-double-left\"\n\t\tclass=\"ace-icon fa ' . $t_block_icon . '\"></i>';\n\t}\n\techo '</div>';\n\techo '</div>';\n}\n\n/**\n * Render opening markup for main container\n * @return null\n */\nfunction layout_main_container_begin() {\n\techo '<div class=\"main-container\" id=\"main-container\">', \"\\n\";\n}\n\n/**\n * Render closing markup for main container\n * @return null\n */\nfunction layout_main_container_end() {\n\techo '</div>' , \"\\n\";\n}\n\n/**\n * Render opening markup for main content\n * @return null\n */\nfunction layout_main_content_begin() {\n\techo '<div class=\"main-content\">' , \"\\n\";\n}\n\n/**\n * Render closing markup for main content\n * @return null\n */\nfunction layout_main_content_end() {\n\techo '</div>' , \"\\n\";\n}\n\n/**\n * Render opening markup for main page content\n * @return null\n */\nfunction layout_page_content_begin() {\n\techo '  <div class=\"page-content\">' , \"\\n\";\n}\n\n/**\n * Render closing markup for main page content\n * @return null\n */\nfunction layout_page_content_end() {\n\techo '</div>' , \"\\n\";\n}\n\n\n/**\n * Render breadcrumbs bar.\n * @return null\n */\nfunction layout_breadcrumbs() {\n\techo '<div id=\"breadcrumbs\" class=\"breadcrumbs noprint\">' , \"\\n\";\n\n\t# Login information\n\techo '<ul class=\"breadcrumb\">' , \"\\n\";\n\tif( current_user_is_anonymous() ) {\n\t\t$t_return_page = $_SERVER['SCRIPT_NAME'];\n\t\tif( isset( $_SERVER['QUERY_STRING'] ) ) {\n\t\t\t$t_return_page .= '?' . $_SERVER['QUERY_STRING'];\n\t\t}\n\n\t\t$t_return_page = string_url( $t_return_page );\n\n\t\techo ' <li><i class=\"fa fa-user home-icon active\"></i> ' . lang_get( 'anonymous' ) . ' </li>' . \"\\n\";\n\n\t\techo '<div class=\"btn-group btn-corner\">' . \"\\n\";\n\t\techo '\t<a href=\"' . helper_mantis_url( 'login_page.php?return=' . $t_return_page ) .\n\t\t\t'\" class=\"btn btn-primary btn-xs\">' . lang_get( 'login_link' ) . '</a>' . \"\\n\";\n\t\tif( config_get_global( 'allow_signup' ) == ON ) {\n\t\t\techo '\t<a href=\"' . helper_mantis_url( 'signup_page.php' ) . '\" class=\"btn btn-primary btn-xs\">' .\n\t\t\t\tlang_get( 'signup_link' ) . '</a>' . \"\\n\";\n\t\t}\n\t\techo '</div>' . \"\\n\";\n\n\t} else {\n\t\t$t_protected = current_user_get_field( 'protected' );\n\t\t$t_access_level = get_enum_element( 'access_levels', current_user_get_access_level() );\n\t\t$t_display_username = string_html_specialchars( current_user_get_field( 'username' ) );\n\t\t$t_realname = current_user_get_field( 'realname' );\n\t\t$t_display_realname = is_blank( $t_realname ) ? '' : ' ( ' . string_html_specialchars( $t_realname ) . ' ) ';\n\n\t\techo '  <li><i class=\"fa fa-user home-icon active\"></i>';\n\t\t$t_page = ( OFF == $t_protected ) ? 'account_page.php' : 'my_view_page.php';\n\t\techo '  <a href=\"' . helper_mantis_url( $t_page ) . '\">' .\n\t\t\t$t_display_username . $t_display_realname . '</a>' . \"\\n\";\n\n\t\t$t_label = layout_is_rtl() ? 'arrowed-right' : 'arrowed';\n\t\techo '  <span class=\"label hidden-xs label-default ' . $t_label . '\">' . $t_access_level . '</span></li>' . \"\\n\";\n\t}\n\techo '</ul>' , \"\\n\";\n\n\t# Recently visited\n\tif( last_visited_enabled() ) {\n\t\t$t_ids = last_visited_get_array();\n\n\t\tif( count( $t_ids ) > 0 ) {\n\t\t\techo '<div class=\"nav-recent hidden-xs\">' . lang_get( 'recently_visited' ) . ': ';\n\t\t\t$t_first = true;\n\n\t\t\tforeach( $t_ids as $t_id ) {\n\t\t\t\tif( !$t_first ) {\n\t\t\t\t\techo ', ';\n\t\t\t\t} else {\n\t\t\t\t\t$t_first = false;\n\t\t\t\t}\n\n\t\t\t\techo string_get_bug_view_link( $t_id );\n\t\t\t}\n\t\t\techo '</div>';\n\t\t}\n\t}\n\n\t# Bug Jump form\n\t# CSRF protection not required here - form does not result in modifications\n\techo '<div id=\"nav-search\" class=\"nav-search\">';\n\techo '<form class=\"form-search\" method=\"post\" action=\"' . helper_mantis_url( 'jump_to_bug.php' ) . '\">';\n\techo '<span class=\"input-icon\">';\n\techo '<input type=\"text\" name=\"bug_id\" autocomplete=\"off\" class=\"nav-search-input\" placeholder=\"' . lang_get( 'issue_id' ) . '\">';\n\techo '<i class=\"ace-icon fa fa-search nav-search-icon\"></i>';\n\techo '</span>';\n\techo '</form>';\n\techo '</div>';\n\techo PHP_EOL;\n\n\techo '</div>';\n\techo PHP_EOL;\n}\n\n/**\n * Print the page footer information\n * @return void\n */\nfunction layout_footer() {\n\tglobal $g_queries_array, $g_request_time;\n\n\t# If a user is logged in, update their last visit time.\n\t# We do this at the end of the page so that:\n\t#  1) we can display the user's last visit time on a page before updating it\n\t#  2) we don't invalidate the user cache immediately after fetching it\n\t#  3) don't do this on the password verification or update page, as it causes the\n\t#    verification comparison to fail\n\tif( auth_is_user_authenticated() && !current_user_is_anonymous() && !( is_page_name( 'verify.php' ) || is_page_name( 'account_update.php' ) ) ) {\n\t\t$t_user_id = auth_get_current_user_id();\n\t\tuser_update_last_visit( $t_user_id );\n\t}\n\n\tlayout_footer_begin();\n\n\t# Show MantisBT version and copyright statement\n\t$t_version_suffix = '';\n\t$t_copyright_years = ' 2000 - ' . date( 'Y' );\n\tif( config_get( 'show_version' ) == ON ) {\n\t\t$t_version_suffix = ' ' . htmlentities( MANTIS_VERSION . config_get_global( 'version_suffix' ) );\n\t}\n\techo '<div class=\"col-md-6 col-xs-12 no-padding\">' . \"\\n\";\n\techo '<address>' . \"\\n\";\n\techo '<strong>Powered by <a href=\"https://www.mantisbt.org\" title=\"bug tracking software\">MantisBT ' . $t_version_suffix . '</a></strong> <br>' . \"\\n\";\n\techo \"<small>Copyright &copy;$t_copyright_years MantisBT Team</small>\" . '<br>';\n\n\t# Show optional user-specified custom copyright statement\n\t$t_copyright_statement = config_get( 'copyright_statement' );\n\tif( $t_copyright_statement ) {\n\t\techo '<small>' . $t_copyright_statement . '</small>' . \"\\n\";\n\t}\n\n\t# Show contact information\n\tif( !is_page_name( 'login_page' ) ) {\n\t\t$t_webmaster_contact_information = sprintf( lang_get( 'webmaster_contact_information' ), string_html_specialchars( config_get( 'webmaster_email' ) ) );\n\t\techo '<small>' . $t_webmaster_contact_information . '</small>' . '<br>' . \"\\n\";\n\t}\n\n\techo '</address>' . \"\\n\";\n\techo '</div>' . \"\\n\";\n\n\n\t# We don't have a button anymore, so for now we will only show the resized\n\t# version of the logo when not on login page.\n\tif( !is_page_name( 'login_page' ) ) {\n\t\techo '<div class=\"col-md-6 col-xs-12\">' . \"\\n\";\n\t\techo '<div class=\"pull-right\" id=\"powered-by-mantisbt-logo\">' . \"\\n\";\n\t\t$t_mantisbt_logo_url = helper_mantis_url( 'images/mantis_logo.png' );\n\t\techo '<a href=\"https://www.mantisbt.org\" '.\n\t\t\t'title=\"Mantis Bug Tracker: a free and open source web based bug tracking system.\">' .\n\t\t\t'<img src=\"' . $t_mantisbt_logo_url . '\" width=\"102\" height=\"35\" ' .\n\t\t\t'alt=\"Powered by Mantis Bug Tracker: a free and open source web based bug tracking system.\" />' .\n\t\t\t'</a>' . \"\\n\";\n\t\techo '</div>' . \"\\n\";\n\t\techo '</div>' . \"\\n\";\n\t}\n\n\tevent_signal( 'EVENT_LAYOUT_PAGE_FOOTER' );\n\n\tif( config_get( 'show_timer' ) || config_get( 'show_memory_usage' ) || config_get( 'show_queries_count' ) ) {\n\t\techo '<div class=\"col-xs-12 no-padding grey\">' . \"\\n\";\n\t\techo '<address class=\"no-margin pull-right\">' . \"\\n\";\n\t}\n\n\n\t# Print the page execution time\n\tif( config_get( 'show_timer' ) ) {\n\t\t$t_page_execution_time = sprintf( lang_get( 'page_execution_time' ), number_format( microtime( true ) - $g_request_time, 4 ) );\n\t\techo '<small><i class=\"fa fa-clock-o\"></i> ' . $t_page_execution_time . '</small>&#160;&#160;&#160;&#160;' . \"\\n\";\n\t}\n\n\t# Print the page memory usage\n\tif( config_get( 'show_memory_usage' ) ) {\n\t\t$t_page_memory_usage = sprintf( lang_get( 'memory_usage_in_kb' ), number_format( memory_get_peak_usage() / 1024 ) );\n\t\techo '<small><i class=\"fa fa-bolt\"></i> ' . $t_page_memory_usage . '</small>&#160;&#160;&#160;&#160;' . \"\\n\";\n\t}\n\n\t# Determine number of unique queries executed\n\tif( config_get( 'show_queries_count' ) ) {\n\t\t$t_total_queries_count = count( $g_queries_array );\n\t\t$t_unique_queries_count = 0;\n\t\t$t_total_query_execution_time = 0;\n\t\t$t_unique_queries = array();\n\t\tfor ( $i = 0; $i < $t_total_queries_count; $i++ ) {\n\t\t\tif( !in_array( $g_queries_array[$i][0], $t_unique_queries ) ) {\n\t\t\t\t$t_unique_queries_count++;\n\t\t\t\t$g_queries_array[$i][3] = false;\n\t\t\t\tarray_push( $t_unique_queries, $g_queries_array[$i][0] );\n\t\t\t} else {\n\t\t\t\t$g_queries_array[$i][3] = true;\n\t\t\t}\n\t\t\t$t_total_query_execution_time += $g_queries_array[$i][1];\n\t\t}\n\n\t\t$t_total_queries_executed = sprintf( lang_get( 'total_queries_executed' ), $t_total_queries_count );\n\t\techo '<small><i class=\"fa fa-database\"></i> ' . $t_total_queries_executed . '</small>&#160;&#160;&#160;&#160;' . \"\\n\";\n\t\tif( config_get_global( 'db_log_queries' ) ) {\n\t\t\t$t_unique_queries_executed = sprintf( lang_get( 'unique_queries_executed' ), $t_unique_queries_count );\n\t\t\techo '<small><i class=\"fa fa-database\"></i> ' . $t_unique_queries_executed . '</small>&#160;&#160;&#160;&#160;' . \"\\n\";\n\t\t}\n\t\t$t_total_query_time = sprintf( lang_get( 'total_query_execution_time' ), $t_total_query_execution_time );\n\t\techo '<small><i class=\"fa fa-clock-o\"></i> ' . $t_total_query_time . '</small>&#160;&#160;&#160;&#160;' . \"\\n\";\n\t}\n\n\tif( config_get( 'show_timer' ) || config_get( 'show_memory_usage' ) || config_get( 'show_queries_count' ) ) {\n\t\techo '</address>' . \"\\n\";\n\t\techo '</div>' . \"\\n\";\n\t}\n\n\t# Print table of log events\n\tlog_print_to_page();\n\n\tlayout_footer_end();\n}\n\n/**\n * Render opening markup for footer section\n * @return null\n */\nfunction layout_footer_begin() {\n\techo '<div class=\"clearfix\"></div>' . \"\\n\";\n\techo '<div class=\"space-20\"></div>' . \"\\n\";\n\techo '<div class=\"footer noprint\">' . \"\\n\";\n\techo '<div class=\"footer-inner\">' . \"\\n\";\n\techo '<div class=\"footer-content\">' . \"\\n\";\n}\n\n/**\n * Render closing markup for footer section\n * @return null\n */\nfunction layout_footer_end() {\n\techo '</div>' . \"\\n\";\n\techo '</div>' . \"\\n\";\n\techo '</div>' . \"\\n\";\n}\n\n/**\n * Render scroll up link to go at the bottom of the page\n * @return null\n */\nfunction layout_scroll_up_button() {\n\techo '<a class=\"btn-scroll-up btn btn-sm btn-inverse display\" id=\"btn-scroll-up\" href=\"#\">' . \"\\n\";\n\techo '<i class=\"ace-icon fa fa-angle-double-up icon-only bigger-110\"></i>' . \"\\n\";\n\techo '</a>' . \"\\n\";\n}\n"], "filenames": ["core/layout_api.php"], "buggy_code_start_loc": [418], "buggy_code_end_loc": [419], "fixing_code_start_loc": [418], "fixing_code_end_loc": [419], "type": "CWE-79", "message": "A cross-site scripting (XSS) vulnerability in MantisBT before 2.1.1 allows remote attackers to inject arbitrary HTML or JavaScript (if MantisBT's CSP settings permit it) by modifying 'window_title' in the application configuration. This requires privileged access to MantisBT configuration management pages (i.e., administrator access rights) or altering the system configuration file (config_inc.php).", "other": {"cve": {"id": "CVE-2017-7222", "sourceIdentifier": "cve@mitre.org", "published": "2017-03-22T05:59:00.190", "lastModified": "2017-03-23T13:55:37.323", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "A cross-site scripting (XSS) vulnerability in MantisBT before 2.1.1 allows remote attackers to inject arbitrary HTML or JavaScript (if MantisBT's CSP settings permit it) by modifying 'window_title' in the application configuration. This requires privileged access to MantisBT configuration management pages (i.e., administrator access rights) or altering the system configuration file (config_inc.php)."}, {"lang": "es", "value": "Vulnerabilidad de XSS en MantisBT en versiones anteriores a 2.1.1 permite a atacantes remotos inyectar c\u00f3digo HTML arbitrario o JavaScript (si los ajustes MantisBT's CSP lo permiten) modificando 'window_title' en la configuraci\u00f3n de la aplicaci\u00f3n. Esto requiere un acceso privilegiado a las p\u00e1ginas de gesti\u00f3n de configuraci\u00f3n de MantisBT (es decir, derechos de acceso de administrador) o alterar el archivo de configuraci\u00f3n del sistema (config_inc.php)."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:mantisbt:mantisbt:*:*:*:*:*:*:*:*", "versionEndIncluding": "2.1.0", "matchCriteriaId": "FA2146F9-1E6B-4EA0-AFCD-467312D36F5B"}]}]}], "references": [{"url": "http://github.com/mantisbt/mantisbt/commit/a85b0b96c8ebe3e010d0d016cf88ab3c8bfc196a", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://mantisbt.org/bugs/view.php?id=22266", "source": "cve@mitre.org", "tags": ["Patch", "Vendor Advisory"]}]}, "github_commit_url": "http://github.com/mantisbt/mantisbt/commit/a85b0b96c8ebe3e010d0d016cf88ab3c8bfc196a"}}