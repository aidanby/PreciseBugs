{"buggy_code": ["<?php\n\ndeclare(strict_types=1);\n\n/**\n * Teampass - a collaborative passwords manager.\n * ---\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n * ---\n *\n * @project   Teampass\n * @version   \n * @file      error.php\n * ---\n *\n * @author    Nils Laumaill\u00e9 (nils@teampass.net)\n *\n * @copyright 2009-2023 Teampass.net\n *\n * @license   https://spdx.org/licenses/GPL-3.0-only.html#licenseText GPL-3.0\n * ---\n *\n * @see       https://www.teampass.net\n */\n\nif (file_exists('../sources/SecureHandler.php')) {\n    include_once '../sources/SecureHandler.php';\n} elseif (file_exists('./sources/SecureHandler.php')) {\n    include_once './sources/SecureHandler.php';\n} else {\n    throw new Exception(\"Error file '/sources/SecureHandler.php' not exists\", 1);\n}\nif (isset($_SESSION) === false) {\n    session_name('teampass_session');\n    session_start();\n}\nif (isset($_SESSION['CPM']) === false || $_SESSION['CPM'] !== 1) {\n    die('Hacking attempt...');\n}\n\n// Load config\nif (file_exists('../includes/config/tp.config.php')) {\n    include_once '../includes/config/tp.config.php';\n} elseif (file_exists('./includes/config/tp.config.php')) {\n    include_once './includes/config/tp.config.php';\n} else {\n    throw new Exception(\"Error file '/includes/config/tp.config.php' not exists\", 1);\n}\n\nif (\n    filter_input(INPUT_POST, 'session', FILTER_SANITIZE_STRING) !== null\n    && filter_input(INPUT_POST, 'session', FILTER_SANITIZE_STRING) === 'expired'\n) {\n    //Include files\n    require_once $SETTINGS['cpassman_dir'] . '/includes/config/settings.php';\n    require_once $SETTINGS['cpassman_dir'] . '/includes/config/include.php';\n    require_once $SETTINGS['cpassman_dir'] . '/sources/SplClassLoader.php';\n    require_once $SETTINGS['cpassman_dir'] . '/sources/main.functions.php';\n    // connect to DB\n    require_once $SETTINGS['cpassman_dir'] . '/includes/libraries/Database/Meekrodb/db.class.php';\n    if (defined('DB_PASSWD_CLEAR') === false) {\n        define('DB_PASSWD_CLEAR', defuseReturnDecrypted(DB_PASSWD, $SETTINGS));\n    }\n\n    // Include main functions used by TeamPass\n    require_once 'sources/main.functions.php';\n    // Update table by deleting ID\n    if (isset($_SESSION['user_id'])) {\n        DB::update(\n            DB_PREFIX . 'users',\n            [\n                'key_tempo' => '',\n            ],\n            'id=%i',\n            $_SESSION['user_id']\n        );\n    }\n\n    //Log into DB the user's disconnection\n    if (isset($SETTINGS['log_connections']) && (int) $SETTINGS['log_connections'] === 1) {\n        logEvents($SETTINGS, 'user_connection', 'disconnect', (string) $_SESSION['user_id'], $_SESSION['login']);\n    }\n} else {\n    require_once $SETTINGS['cpassman_dir'] . '/sources/main.queries.php';\n    $errorCode = '';\n    if (@$_SESSION['error']['code'] === ERR_NOT_ALLOWED) {\n        $errorCode = 'ERROR NOT ALLOWED';\n    } elseif (@$_SESSION['error']['code'] === ERR_NOT_EXIST) {\n        $errorCode = 'ERROR NOT EXISTS';\n    } elseif (@$_SESSION['error']['code'] === ERR_SESS_EXPIRED) {\n        $errorCode = 'ERROR SESSION EXPIRED';\n    } elseif (@$_SESSION['error']['code'] === ERR_VALID_SESSION) {\n        $errorCode = 'ERROR NOT ALLOWED';\n    } ?>\n    <!-- Main content -->\n    <section class=\"content\">\n        <div class=\"error-page\" style=\"width:100%;\">\n            <h2 class=\"headline text-danger\">500</h2>\n\n            <div class=\"error-content\">\n                <h3><i class=\"fa fa-warning text-danger\"></i> Oops! <?php echo $errorCode; ?>.</h3>\n\n                <p>\n                    For security reason, you have been disconnected. Click to <a href=\"./includes/core/logout.php?user_id=\" + <?php echo isset($_SESSION['user_id']) === true ? $_SESSION['user_id'] : ''; ?>>log in</a>.\n                </p>\n\n            </div>\n            <!-- /.error-content -->\n        </div>\n        <!-- /.error-page -->\n    </section>\n    <!-- /.content -->\n<?php\n}\n\n// erase session table\n$_SESSION = [];\n// Kill session\nsession_destroy();\ndie;\n?>\n", "<?php\n\ndeclare(strict_types=1);\n\n/**\n * Teampass - a collaborative passwords manager.\n * ---\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n * ---\n *\n * @project   Teampass\n * @version   3.0.0.23\n * @file      load.js.php\n * ---\n *\n * @author    Nils Laumaill\u00e9 (nils@teampass.net)\n *\n * @copyright 2009-2023 Teampass.net\n *\n * @license   https://spdx.org/licenses/GPL-3.0-only.html#licenseText GPL-3.0\n * ---\n *\n * @see       https://www.teampass.net\n */\n\nif (isset($_SESSION['CPM']) === false || (int) $_SESSION['CPM'] !== 1) {\n    die('Hacking attempt...');\n}\n\n// Is maintenance on-going?\nif (\n    isset($SETTINGS['maintenance_mode']) === true\n    && (int) $SETTINGS['maintenance_mode'] === 1\n    && ($session_user_admin === null\n        || (int) $session_user_admin === 1)\n) {\n    ?>\n    <script type=\"text/javascript\">\n        toastr.remove();\n        toastr.info(\n            '<?php echo langHdl('index_maintenance_mode_admin'); ?>',\n            '<?php echo langHdl('information'); ?>', {\n                timeOut: 0\n            }\n        );\n    </script>\n<?php\n}\n?>\n\n<script type=\"text/javascript\">\n    var userScrollPosition = 0,\n        debugJavascript = true;\n    let hourInMinutes = 60;\n\n    /**\n    *   Add 1 hour to session duration\n    **/\n    function IncreaseSessionTime(duration)\n    {\n        duration = duration || hourInMinutes;\n        $.post(\n            'sources/main.queries.php',\n            {\n                type     : 'increase_session_time',\n                type_category: 'action_user',\n                duration : parseInt(duration, 10) * hourInMinutes,\n                key: \"<?php echo $_SESSION['key']; ?>\"\n            },\n            function(data) {\n                if (data[0].new_value !== 'expired') {\n                    $('#temps_restant').val(data[0].new_value);\n                    $('#date_end_session').val(data[0].new_value);\n                    $('#countdown').css('color', 'white');\n                } else {\n                    $(location).attr('href', 'index.php?session=expired');\n                }\n            },\n            'json'\n        );\n    }\n\n    // Start real time\n    // get list of last items\n    if (store.get('teampassUser') !== undefined && parseInt(store.get('teampassUser').user_id) > 0\n        && String('<?php echo $_SESSION['key']; ?>') === store.get('teampassUser').sessionKey\n        && (Date.now() - store.get('teampassUser').sessionStartTimestamp) < (store.get('teampassUser').sessionDuration * 1000)\n    ) {\n        $.when(\n            // Load teampass settings\n            loadSettings()\n        ).then(function() {\n            $.when(\n                // Refresh list of last items shopwn\n                refreshListLastSeenItems()\n            ).then(function() {\n                // Check if new privatekey needs to be adapted\n                var data = {\n                    'user_id': store.get('teampassUser').user_id,\n                    'fields' : 'special, auth_type',\n                }\n                $.post(\n                    \"sources/main.queries.php\", {\n                        type: \"get_user_info\",\n                        type_category: 'action_user',\n                        data: prepareExchangedData(JSON.stringify(data), 'encode', '<?php echo $_SESSION['key']; ?>'),\n                        key: \"<?php echo $_SESSION['key']; ?>\"\n                    },\n                    function(data) {\n                        //decrypt data\n                        data = decodeQueryReturn(data, '<?php echo $_SESSION['key']; ?>');\n                        if (debugJavascript === true) {\n                            console.info('Get user info results:');\n                            console.log(data);\n                        }\n\n                        // update local storage\n                        store.update(\n                            'teampassUser', {},\n                            function(teampassUser) {\n                                teampassUser.special = data.queryResults.special;\n                                teampassUser.auth_type = data.queryResults.auth_type;\n                            }\n                        );\n\n                        if (data.error === false && data.queryResults.special === 'generate-keys') {\n                            // Now we need to perform re-encryption due to LDAP password change\n                            if (debugJavascript === true) console.log('User has to regenerate keys')\n                            // HIde\n                            $('.content-header, .content').addClass('hidden');\n                            $('#dialog-user-temporary-code-info').html('<i class=\"icon fas fa-info mr-2\"></i><?php echo langHdl('renecyption_expected');?>');\n\n                            // Show passwords inputs and form\n                            $('#dialog-user-temporary-code').removeClass('hidden');\n\n                            // ----\n                        } else if (data.error === false && data.queryResults.special === 'auth-pwd-change' && data.queryResults.auth_type === 'local') {\n                            // USer's password has been reseted, he shall change it\n                            if (debugJavascript === true) console.log('User has to change his auth password')\n                            // HIde\n                            $('.content-header, .content').addClass('hidden');\n\n                            // Show passwords inputs and form\n                            $('#dialog-user-change-password-info')\n                                .html('<i class=\"icon fas fa-info mr-2\"></i><?php echo langHdl('user_has_to_change_password_info');?>')\n                                .removeClass('hidden');\n                            $('#dialog-user-change-password').removeClass('hidden');\n\n                        // ----\n                        } else if (data.error === false && data.queryResults.special === 'auth-pwd-change' && data.queryResults.auth_type === 'ldap') {\n                            // USer's password has been reseted, he shall change it\n                            if (debugJavascript === true) console.log('LDAP user password has to change his auth password')\n                            // HIde\n                            $('.content-header, .content').addClass('hidden');\n\n                            // Show passwords inputs and form\n                            $('#dialog-ldap-user-change-password-info')\n                                .html('<i class=\"icon fas fa-info mr-2\"></i><?php echo langHdl('ldap_user_has_changed_his_password');?>')\n                                .removeClass('hidden');\n                            $('#dialog-ldap-user-change-password').removeClass('hidden');\n                            \n                            // ----\n                        } else if (\n                            (data.error === false && data.queryResults.special === 'user_added_from_ldap' && data.queryResults.auth_type === 'ldap')\n                            || (typeof data.queryResults !== 'undefined' && data.queryResults.special === 'otc_is_required_on_next_login')\n                        ) {\n                            // USer's password has been reseted, he shall change it\n                            if (debugJavascript === true) console.log('NEW LDAP user password - we need to encrypt items')\n                            // HIde\n                            $('.content-header, .content').addClass('hidden');\n\n                            // Show form\n                            $('#dialog-ldap-user-build-keys-database').removeClass('hidden');\n                        } else if (typeof data.queryResults !== 'undefined' && data.queryResults.special === 'recrypt-private-key') {\n                            // USer's password has been reseted, he shall change it\n                            if (debugJavascript === true) console.log('NEW LDAP - we need to encrypt private key')\n                            // HIde\n                            $('.content-header, .content').addClass('hidden');\n\n                            // Show form\n                            $('#dialog-ldap-user-change-password').removeClass('hidden');\n                        }\n                    }\n                );\n            }).then(function() {\n                if (store.get('teampassSettings') === undefined || parseInt(store.get('teampassSettings').enable_tasks_manager) === 0) {\n                    console.log('Now sending emails')\n                    setTimeout(\n                        function() {\n                            $.when(\n                                // send email\n                                $.post(\n                                    \"sources/main.queries.php\", {\n                                        type: \"send_waiting_emails\",\n                                        type_category: 'action_mail',\n                                        key: \"<?php echo $_SESSION['key']; ?>\"\n                                    }\n                                )\n                            ).then(function() {\n                                // send statistics\n                                $.post(\n                                    \"sources/main.queries.php\", {\n                                        type: \"sending_statistics\",\n                                        type_category: 'action_system',\n                                        key: \"<?php echo $_SESSION['key']; ?>\"\n                                    }\n                                );\n                            });\n                        },\n                        3000\n                    );\n                }\n\n                // Save user location\n                //console.info(\"DEBUG - Save user location -\"+store.get('teampassUser').location_stored)\n                if (store.get('teampassUser').location_stored !== 1) {\n                // Save user location\n                    $.post(\n                        \"sources/users.queries.php\", {\n                            type: 'save_user_location',\n                            step: \"perform\",\n                            key: \"<?php echo $_SESSION['key']; ?>\"\n                        },\n                        function(data) {\n                            // update local storage\n                            store.update(\n                                'teampassUser', {},\n                                function(teampassUser) {\n                                    teampassUser.location_stored = 1;\n                                }\n                            );\n                        }\n                    );\n                }\n            });\n        });\n    }\n    //-- end\n\n\n    // Countdown\n    countdown();\n\n    $(\".show_hide_password a\").on('click', function(event) {\n        event.preventDefault();\n        if($('.how_hide_password input').attr(\"type\") === \"text\"){\n            $('.show_hide_password input').attr('type', 'password');\n            $('.show_hide_password i').addClass( \"fa-eye-slash\" );\n            $('.show_hide_password i').removeClass( \"fa-eye\" );\n        }else if($('#show_hide_password input').attr(\"type\") === \"password\"){\n            $('.show_hide_password input').attr('type', 'text');\n            $('.show_hide_password i').removeClass( \"fa-eye-slash\" );\n            $('.show_hide_password i').addClass( \"fa-eye\" );\n        }\n    });\n    \n    if (store.get('teampassUser') !== undefined &&\n        store.get('teampassUser').special === 'generate-keys'\n    ) {\n        // Now we need to perform re-encryption due to LDAP password change\n        console.log('User has to regenerate keys')\n        // HIde\n        $('.content-header, .content').addClass('hidden');\n        $('#dialog-user-temporary-code-info').html('<i class=\"icon fas fa-info mr-2\"></i><?php echo langHdl('renecyption_expected');?>');\n\n        // Show passwords inputs and form\n        $('#dialog-user-temporary-code').removeClass('hidden');\n        \n        // ---\n    } else if (store.get('teampassUser') !== undefined &&\n        store.get('teampassUser').special === 'ldap_password_has_changed_do_reencryption'\n    ) {\n        // Now we need to perform re-encryption due to LDAP password change\n        console.log('show password change')\n        // HIde\n        $('.content-header, .content, #button_do_sharekeys_reencryption').addClass('hidden');\n        $('#warning-text-reencryption').html('<i class=\"icon fas fa-info mr-2\"></i>'.langHdl('ldap_password_change_warning'));\n\n        // Show passwords inputs and form\n        $('#dialog-encryption-keys, .ask-for-previous-password').removeClass('hidden');\n\n        $('#sharekeys_reencryption_target_user').val(store.get('teampassUser').user_id);\n\n        $('#button_do_sharekeys_reencryption').removeClass('hidden');\n        \n        // ---\n    } else if (store.get('teampassUser') !== undefined &&\n        store.get('teampassUser').shown_warning_unsuccessful_login === false\n    ) {\n        // If login attempts experimented\n        // Prepare modal\n        showModalDialogBox(\n            '#warningModal',\n            '<i class=\"fas fa-user-shield fa-lg warning mr-2\"></i><?php echo langHdl('caution'); ?>',\n            '<?php echo langHdl('login_attempts_identified_since_last_connection'); ?>',\n            '<?php echo langHdl('see_detail'); ?>',\n            '<?php echo langHdl('cancel'); ?>'\n        );\n\n        // Actions on modal buttons\n        $(document).on('click', '#warningModalButtonClose', function() {\n            store.update(\n                'teampassUser', {},\n                function(teampassUser) {\n                    teampassUser.shown_warning_unsuccessful_login = true;\n                }\n            );\n        });\n        $(document).on('click', '#warningModalButtonAction', function() {\n            // SHow user\n            toastr.remove();\n            toastr.info('<?php echo langHdl('in_progress'); ?><i class=\"fas fa-circle-notch fa-spin fa-2x ml-3\"></i>');\n\n            // Action\n            store.update(\n                'teampassUser', {},\n                function(teampassUser) {\n                    teampassUser.shown_warning_unsuccessful_login = true;\n                }\n            );\n            document.location.href = \"index.php?page=profile&tab=timeline\";\n        });\n    } else if (store.get('teampassUser') !== undefined &&\n        store.get('teampassUser').special === 'private_items_to_encrypt'\n    ) {\n        // If user has to re-encrypt his personal item passwords\n        $('#dialog-encryption-personal-items-after-upgrade').removeClass('hidden');\n        $('.content, .content-header').addClass('hidden');\n        \n        // Actions on modal buttons\n        $(document).on('click', '#button_do_personal_items_reencryption', function() {\n            // SHow user\n            toastr.remove();\n            toastr.info('<?php echo langHdl('in_progress'); ?><i class=\"fas fa-circle-notch fa-spin fa-2x ml-3\"></i>');\n\n            defusePskRemoval(store.get('teampassUser').user_id, 'psk', 0);\n            \n            function defusePskRemoval(userId, step, start)\n            {\n                if (step === 'psk') {\n                    // Inform user\n                    $(\"#user-current-defuse-psk-progress\").html('<b><?php echo langHdl('encryption_keys'); ?> </b> [' + start + ' - ' + (parseInt(start) + <?php echo NUMBER_ITEMS_IN_BATCH;?>) + '] ' +\n                        '... <?php echo langHdl('please_wait'); ?><i class=\"fas fa-spinner fa-pulse ml-3 text-primary\"></i>');\n\n                    var data = {\n                        'userPsk' : $('#user-current-defuse-psk').val(),\n                            'start': start,\n                            'length': <?php echo NUMBER_ITEMS_IN_BATCH;?>,\n                            'user_id': userId,\n                    };\n                    // Do query\n                    $.post(\n                        \"sources/main.queries.php\", {\n                            'type': \"user_psk_reencryption\",\n                            'type_category': 'action_key',\n                            'data': prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                            'key': '<?php echo $_SESSION['key']; ?>'\n                        },\n                        function(data) {\n                            data = prepareExchangedData(data, \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n                            if (debugJavascript === true) console.log(data)\n                            if (data.error === true) {\n                                // error\n                                toastr.remove();\n                                toastr.error(\n                                    data.message,\n                                    '<?php echo langHdl('caution'); ?>', {\n                                        timeOut: 5000,\n                                        progressBar: true\n                                    }\n                                );\n\n                                // Enable buttons\n                                $(\"#user-current-defuse-psk-progress\").html('<?php echo langHdl('provide_current_psk_and_click_launch'); ?>');\n                                $('#button_do_sharekeys_reencryption, #button_close_sharekeys_reencryption').removeAttr('disabled');\n                                return false;\n                            } else {\n                                // Start looping on all steps of re-encryption\n                                defusePskRemoval(data.userId, data.step, data.start);\n                            }\n                        }\n                    );\n                } else {\n                    // Finished\n                    $(\"#user-current-defuse-psk-progress\").html('<i class=\"fas fa-check text-success mr-3\"></i><?php echo langHdl('done'); ?>');\n\n                    toastr.remove();\n                }\n            }\n\n        });\n        $(document).on('click', '#button_close_personal_items_reencryption', function() {\n            $('#dialog-encryption-personal-items-after-upgrade').addClass('hidden');\n            $('.content, .content-header').removeClass('hidden');\n        });\n    }\n\n\n    // Show tooltips\n    $('.infotip').tooltip();\n\n    // Sidebar redirection\n    $('.nav-link').click(function() {\n        if ($(this).data('name') !== undefined) {\n            //NProgress.start();\n            document.location.href = \"index.php?page=\" + $(this).data('name');\n        }\n    });\n\n    // User menu action\n    $('.user-menu').click(function() {\n        if ($(this).data('name') !== undefined) {\n            if ($(this).data('name') === 'increase_session') {\n                showExtendSession();\n            } else if ($(this).data('name') === 'sync-new-ldap-password') {\n                // This case permits to handle a case where user has changed his password in LDAP\n                console.log('show sync-new-ldap-password')\n                \n                if (debugJavascript === true) console.log('LDAP user password has to change his auth password')\n                // HIde\n                $('.content-header, .content').addClass('hidden');\n\n                // Show passwords inputs and form\n                $('#dialog-ldap-user-change-password-info')\n                    .html('<i class=\"icon fas fa-info mr-2\"></i><?php echo langHdl('ldap_user_has_changed_his_password');?>')\n                    .removeClass('hidden');\n                $('#dialog-ldap-user-change-password').removeClass('hidden');\n\n                // ----\n            } else if ($(this).data('name') === 'password-change') {\n                console.log('show password change')\n                // HIde\n                $('.content-header, .content, #button_do_user_change_password').addClass('hidden');\n\n                // Add DoCheck button\n                $('#button_do_user_change_password').after('<button class=\"btn btn-primary\" id=\"button_do_pwds_checks\"><?php echo langHdl('perform_checks'); ?></button>');\n\n                // Show passwords inputs and form\n                $('#dialog-user-change-password-progress').html('<i class=\"icon fas fa-info mr-2\"></i><?php echo langHdl('change_your_password_info_message'); ?>');\n                $('#dialog-user-change-password').removeClass('hidden');\n\n                // Actions\n                $('#button_do_pwds_checks').click(function() {\n                    if ($('#profile-password').val() !== $('#profile-password-confirm').val()) {\n                        $('#button_do_user_change_password').addClass('hidden');\n                        toastr.remove();\n                        toastr.error(\n                            '<?php echo langHdl('passwords_not_the_same'); ?>',\n                            '<?php echo langHdl('caution'); ?>', {\n                                timeOut: 3000,\n                                progressBar: true\n                            }\n                        );\n                    } else if (parseInt($('#profile-password-complex').val()) >= parseInt(store.get('teampassSettings').personal_saltkey_security_level)) {\n                        $('#button_do_user_change_password').removeClass('hidden');\n                        $('#button_do_pwds_checks').remove();\n                        toastr.remove();\n                        toastr.info(\n                            '<?php echo langHdl('hit_launch_to_start'); ?>',\n                            '<?php echo langHdl('ready_to_go'); ?>', {\n                                timeOut: 3000,\n                                progressBar: true\n                            }\n                        );\n                    } else {\n                        $('#button_do_user_change_password').addClass('hidden');\n                        toastr.remove();\n                        toastr.error(\n                            '<?php echo langHdl('complexity_level_not_reached'); ?>',\n                            '<?php echo langHdl('caution'); ?>', {\n                                timeOut: 5000,\n                                progressBar: true\n                            }\n                        );\n                    }\n                });\n                // ----\n            } else if ($(this).data('name') === 'profile') {\n                // Show profile page\n                document.location.href = \"index.php?page=profile\";\n            } else if ($(this).data('name') === 'logout') {\n                // Logout directly to login form\n                window.location.href = \"./includes/core/logout.php?user_id=\" + <?php echo $_SESSION['user_id']; ?>\n            }\n        }\n    });\n\n    $('.close-element').click(function() {\n        $(this).closest('.card').addClass('hidden');\n\n        $('.content-header, .content').removeClass('hidden');\n    });\n\n    /**\n     * When clicking save Personal saltkey\n     */\n    /*\n    $('#button_save_user_psk').click(function() {\n        toastr.remove();\n        toastr.info(\n            '<?php echo langHdl('in_progress'); ?><i class=\"fas fa-circle-notch fa-spin fa-2x ml-3\"></i>'\n        );\n\n        // Prepare data\n        var data = {\n            \"psk\": sanitizeString($(\"#user_personal_saltkey\").val()),\n            \"complexity\": $(\"#psk_strength_value\").val()\n        };\n\n        //\n        $.post(\n            \"sources/main.queries.php\", {\n                type: \"store_personal_saltkey\",\n                data: prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                key: '<?php echo $_SESSION['key']; ?>'\n            },\n            function(data) {\n                data = prepareExchangedData(data, '<?php echo $_SESSION['key']; ?>');\n\n                // Is there an error?\n                if (data.error === true) {\n                    toastr.remove();\n                    toastr.error(\n                        '<?php echo langHdl('warning'); ?>',\n                        '<?php echo langHdl('caution'); ?>', {\n                            timeOut: 5000,\n                            progressBar: true\n                        }\n                    );\n                } else {\n                    store.update(\n                        'teampassUser',\n                        function(teampassUser) {\n                            teampassUser.pskDefinedInDatabase = 1;\n                        }\n                    )\n\n                    store.update(\n                        'teampassUser',\n                        function(teampassUser) {\n                            teampassUser.pskSetForSession = data.encrypted_psk;\n                        }\n                    )\n\n                    toastr.remove();\n                    toastr.success(\n                        '<?php echo langHdl('alert_page_will_reload'); ?>'\n                    );\n\n                    location.reload();\n                }\n            }\n        );\n    });\n    */\n\n    // For Personal Saltkey\n    $(\"#profile-password\").simplePassMeter({\n        \"requirements\": {},\n        \"container\": \"#profile-password-strength\",\n        \"defaultText\": \"<?php echo langHdl('index_pw_level_txt'); ?>\",\n        \"ratings\": [{\n                \"minScore\": 0,\n                \"className\": \"meterFail\",\n                \"text\": \"<?php echo langHdl('complex_level0'); ?>\"\n            },\n            {\n                \"minScore\": 25,\n                \"className\": \"meterWarn\",\n                \"text\": \"<?php echo langHdl('complex_level1'); ?>\"\n            },\n            {\n                \"minScore\": 50,\n                \"className\": \"meterWarn\",\n                \"text\": \"<?php echo langHdl('complex_level2'); ?>\"\n            },\n            {\n                \"minScore\": 60,\n                \"className\": \"meterGood\",\n                \"text\": \"<?php echo langHdl('complex_level3'); ?>\"\n            },\n            {\n                \"minScore\": 70,\n                \"className\": \"meterGood\",\n                \"text\": \"<?php echo langHdl('complex_level4'); ?>\"\n            },\n            {\n                \"minScore\": 80,\n                \"className\": \"meterExcel\",\n                \"text\": \"<?php echo langHdl('complex_level5'); ?>\"\n            },\n            {\n                \"minScore\": 90,\n                \"className\": \"meterExcel\",\n                \"text\": \"<?php echo langHdl('complex_level6'); ?>\"\n            }\n        ]\n    });\n    $(\"#profile-password\").bind({\n        \"score.simplePassMeter\": function(jQEvent, score) {\n            $(\"#profile-password-complex\").val(score);\n        }\n    }).change({\n        \"score.simplePassMeter\": function(jQEvent, score) {\n            $(\"#profile-password-complex\").val(score);\n        }\n    });\n\n    // Hide sidebar footer icons when reducing sidebar\n    $('a[data-widget=\"pushmenu\"]').click(function(event) {\n        if ($('#sidebar-footer').hasClass('hidden') === true) {\n            setTimeout(function() {\n                $('#sidebar-footer').removeClass('hidden');\n            }, 300);\n        } else {\n            $('#sidebar-footer').addClass('hidden');\n        }\n    });\n\n\n    var clipboardCopy = new ClipboardJS(\".clipboard-copy\", {\n        text: function(trigger) {\n            var elementId = $(trigger).data('clipboard-text');\n            if (debugJavascript === true) console.log($('#' + elementId).val())\n            return String($('#' + elementId).val());\n        }\n    });\n\n    clipboardCopy.on('success', function(e) {\n        toastr.remove();\n        toastr.info(\n            '<?php echo langHdl('copy_to_clipboard'); ?>',\n            '<?php echo langHdl('information'); ?>', {\n                timeOut: 2000\n            }\n        );\n    });\n\n    // Progress bar\n    setTimeout(\n        function() {\n            $(\".fade\").removeClass(\"out\");\n        },\n        1000\n    );\n\n\n    /**\n    * USER HAS DECIDED TO CHANGE HIS AUTH PASSWORD\n     */\n    $(document).on('click', '#dialog-user-change-password-do', function() {\n        // Start by changing the user password and send it by email\n        if ($('#profile-password-confirm').val() !== $('#profile-password').val()) {\n            // Show error\n            toastr.remove();\n            toastr.error(\n                '<?php echo langHdl('index_pw_error_identical'); ?>',\n                '<?php echo langHdl('caution'); ?>', {\n                    timeOut: 5000,\n                    progressBar: true\n                }\n            );\n            return false;\n        }\n        if ($('#profile-current-password').val() !== \"\" && $('#profile-password').val() !== \"\" && $('#profile-password-confirm').val() !== \"\") {\n            // Case where a user is changing his authentication password\n            console.log('Reencryption based upon user decision to change his auth password');\n\n            // Show progress\n            $('#dialog-user-change-password-progress').html('<b><?php echo langHdl('please_wait'); ?></b><i class=\"fas fa-spinner fa-pulse ml-3 text-primary\"></i>');\n            toastr.remove();\n            toastr.info(\n                '<?php echo langHdl('in_progress'); ?><i class=\"fas fa-circle-notch fa-spin fa-2x ml-3\"></i>'\n            );\n            \n            // Disable buttons\n            $('#dialog-user-change-password-do, #dialog-user-change-password-close').attr('disabled', 'disabled');\n            \n            data = {\n                'user_id': store.get('teampassUser').user_id,\n                'old_password': $('#profile-current-password').val(),\n                'new_password': $('#profile-password').val(),\n            }\n            if (debugJavascript === true) console.log(data);\n\n            // Check user current password\n            // and change the password\n            // and use the password to re-encrypt the privatekey\n            $.post(\n                'sources/main.queries.php', {\n                    type: 'change_user_auth_password',\n                    type_category: 'action_password',\n                    data: prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                    key: \"<?php echo $_SESSION['key']; ?>\"\n                },\n                function(data) {\n                    data = prepareExchangedData(data, 'decode', '<?php echo $_SESSION['key']; ?>');\n                    if (debugJavascript === true) console.log(data);\n\n                    if (data.error !== false) {\n                        // Show error\n                        toastr.remove();\n                        toastr.error(\n                            data.message,\n                            '<?php echo langHdl('caution'); ?>', {\n                                timeOut: 5000,\n                                progressBar: true\n                            }\n                        );\n\n                        $(\"#dialog-user-change-password-progress\").html('<?php echo langHdl('fill_in_fields_and_hit_launch'); ?>');\n\n                        // Enable buttons\n                        $('#dialog-user-change-password-do, #dialog-user-change-password-close').removeAttr('disabled');\n                    } else {\n                        // SUCCESS\n                        $('#dialog-user-change-password-close').removeAttr('disabled');\n                        toastr.remove();\n                        toastr.success(\n                            data.message,\n                            '<?php echo langHdl('success'); ?>', {\n                                timeOut: 5000,\n                                progressBar: true\n                            }\n                        );\n                        $(\"#dialog-user-change-password-progress\").html('');\n                        $('#dialog-user-change-password').addClass('hidden');\n                        $('.content-header, .content').removeClass('hidden');\n                    }\n                }\n            );\n        } else {\n            // Show error\n            toastr.remove();\n            toastr.error(\n                '<?php echo langHdl('password_cannot_be_empty'); ?>',\n                '<?php echo langHdl('caution'); ?>', {\n                    timeOut: 5000,\n                    progressBar: true\n                }\n            );\n        }\n    });\n    $(document).on('click', '#dialog-user-change-password-close', function() {\n        // HIde\n        $('.content-header, .content').removeClass('hidden');\n\n        // SHow form\n        $('#dialog-user-change-password, #dialog-user-change-password-info').addClass('hidden');\n    });\n    \n\n    /**\n    * ADMIN HAS DECIDED TO CHANGE THE USER'S AUTH PASSWORD\n     */\n    $(document).on('click', '#dialog-admin-change-user-password-do', function() {\n        // When an admin changes the user auth password\n        console.log('Reencryption based upon admin decision to change user auth password');\n\n        // Show progress\n        $('#dialog-admin-change-user-password-progress').html('<b><?php echo langHdl('please_wait'); ?></b><i class=\"fas fa-spinner fa-pulse ml-3 text-primary\"></i>');\n        toastr.remove();\n        toastr.info(\n            '<?php echo langHdl('in_progress'); ?><i class=\"fas fa-circle-notch fa-spin fa-2x ml-3\"></i>'\n        );\n        \n        // Disable buttons\n        $('#dialog-admin-change-user-password-do, #dialog-admin-change-user-password-close').attr('disabled', 'disabled');            \n        \n        // ENsure we have a user id\n        if ($('#admin_change_user_password_target_user').val() !== '') {\n            // Case where change is for user's account\n            data = {\n                'user_id': $('#admin_change_user_password_target_user').val(),\n                'special': 'auth-pwd-change',\n                'password': '',\n                'self_change': false,\n            }\n            //console.log(data);\n            \n            $.post(\n                'sources/main.queries.php', {\n                    type: 'initialize_user_password',\n                    type_category: 'action_password',\n                    data: prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                    key: \"<?php echo $_SESSION['key']; ?>\"\n                },\n                function(data) {\n                    data = prepareExchangedData(data, 'decode', '<?php echo $_SESSION['key']; ?>');\n                    if (debugJavascript === true) console.log(data)\n                    store.set(\n                        'teampassUser', {\n                            admin_user_password: data.user_pwd,\n                            admin_user_email: data.user_email,\n                        }\n                    );\n\n                    if (data.error !== false) {\n                        // Show error\n                        toastr.remove();\n                        toastr.error(\n                            data.message,\n                            '<?php echo langHdl('caution'); ?>', {\n                                timeOut: 5000,\n                                progressBar: true\n                            }\n                        );\n\n                        // Enable buttons\n                        $('#dialog-admin-change-user-password-do, #dialog-admin-change-user-password-close').removeAttr('disabled');\n                    } else {\n                        // Inform user\n                        userShareKeysReencryption(\n                            $('#admin_change_user_password_target_user').val(),\n                            false,\n                            'dialog-admin-change-user-password'\n                        );\n                    }\n                }\n            );\n        }\n    });\n    $(document).on('click', '#dialog-admin-change-user-password-close', function() {\n        // HIde\n        $('.content-header, .content').removeClass('hidden');\n\n        // SHow form\n        $('#dialog-admin-change-user-password').addClass('hidden');\n    });\n    \n    $(document).on('click', '.temp-button', function() {\n        \n        if ($(this).data('action') === \"show-user-pwd\") {\n            // show password\n            $('#temp-user-pwd').attr('type', 'text');\n            $(this).prop( \"disabled\", true );\n            setTimeout(\n                () => {\n                    $('#temp-user-pwd').attr('type', 'hidden');\n                    $(this).prop( \"disabled\", false );\n                },\n                5000\n            );\n        } else if ($(this).data('action') === \"send-user-pwd\") {\n            // Send email\n            console.log('Preparing for email sending');\n            \n            // Prepare data\n            var data = {\n                'receipt': $('#temp-user-email').val(),\n                'subject': '[Teampass] <?php echo langHdl('your_new_password');?>',\n                'body': '<?php echo langHdl('email_body_temporary_login_password');?>',\n                'pre_replace' : {\n                    '#enc_code#' : $('#temp-user-pwd').val(),\n                }\n            }\n            if (debugJavascript === true) console.log(data);\n            // Prepare form\n            $('#dialog-admin-change-user-password-info').html('<?php echo langHdl('sending_email_message');?>');\n            toastr.remove();\n            toastr.info(\n                '<?php echo langHdl('in_progress'); ?><i class=\"fas fa-circle-notch fa-spin fa-2x ml-3\"></i>'\n            );\n\n            // Launch action\n            $.post(\n                'sources/main.queries.php', {\n                    type: 'mail_me',\n                    type_category: 'action_mail',\n                    data: prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                    key: '<?php echo $_SESSION['key']; ?>'\n                },\n                function(data) {\n                    data = prepareExchangedData(data, 'decode', '<?php echo $_SESSION['key']; ?>');\n                    if (debugJavascript === true) console.log(data);\n                    if (data.error !== false) {\n                        // Show error\n                        toastr.remove();\n                        toastr.error(\n                            data.message,\n                            '', {\n                                timeOut: 5000,\n                                progressBar: true\n                            }\n                        );\n                    } else {\n                        // Fianlize UI\n\n                        $('#dialog-admin-change-user-password-info').html('');\n                        $('#dialog-admin-change-user-password-do, #dialog-admin-change-user-password-close').removeAttr('disabled');\n\n                        // HIde\n                        $('.content-header, .content').removeClass('hidden');\n\n                        // SHow form\n                        $('#dialog-admin-change-user-password').addClass('hidden');\n\n                        store.set(\n                            'teampassUser', {\n                                admin_user_password: '',\n                                admin_user_email: '',\n                            }\n                        );\n                        \n                        // Inform user\n                        toastr.remove();\n                        toastr.success(\n                            '<?php echo langHdl('done'); ?>',\n                            '', {\n                                timeOut: 1000\n                            }\n                        );\n                    }\n                }\n            );\n        }        \n    });\n    \n\n    /**\n    * USER PROVIDES HIS TEMPORARY CODE TO\n     */\n    $(document).on('click', '#dialog-user-temporary-code-do', function() {\n        // Perform a renecryption based upon a temporary code\n        console.log('Reencryption based upon users temporary code');\n\n        // Show progress\n        $('#dialog-user-temporary-code-progress').html('<b><?php echo langHdl('please_wait'); ?></b><i class=\"fas fa-spinner fa-pulse ml-3 text-primary\"></i>');\n        toastr.remove();\n        toastr.info(\n            '<?php echo langHdl('in_progress'); ?><i class=\"fas fa-circle-notch fa-spin fa-2x ml-3\"></i>'\n        );\n        \n        // Disable buttons\n        $('#dialog-user-temporary-code-do, #dialog-user-temporary-code-close').attr('disabled', 'disabled');            \n        \n        // Start by testing if the temporary code is correct to decrypt an item\n        data = {\n            'user_id': store.get('teampassUser').user_id,\n            'password': $('#dialog-user-temporary-code-value').val(),\n        }\n        if (debugJavascript === true) console.log(data);\n        $.post(\n            'sources/main.queries.php', {\n                type: 'test_current_user_password_is_correct',\n                type_category: 'action_password',\n                data: prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                key: \"<?php echo $_SESSION['key']; ?>\"\n            },\n            function(data) {\n                data = prepareExchangedData(data, 'decode', '<?php echo $_SESSION['key']; ?>');\n                if (debugJavascript === true) console.log(data);\n\n                if (data.error !== false) {\n                    // Show error\n                    toastr.remove();\n                    toastr.error(\n                        data.message,\n                        '<?php echo langHdl('caution'); ?>', {\n                            timeOut: 5000,\n                            progressBar: true\n                        }\n                    );\n\n                    $(\"#dialog-user-temporary-code-progress\").html('<?php echo langHdl('fill_in_fields_and_hit_launch'); ?>');\n\n                    // Enable buttons\n                    $('#dialog-user-temporary-code-do, #dialog-user-temporary-code-close').removeAttr('disabled');\n                } else {\n                    // Change privatekey encryption with user-s password\n                    data = {\n                        'user_id': store.get('teampassUser').user_id,\n                        'current_code': $('#dialog-user-temporary-code-current-password').val(),\n                        'new_code': $('#dialog-user-temporary-code-value').val(),\n                        'action_type' : 'encrypt_privkey_with_user_password',\n                    }\n                    if (debugJavascript === true) console.log(data);\n                    \n                    $.post(\n                        'sources/main.queries.php', {\n                            type: 'change_private_key_encryption_password',\n                            type_category: 'action_key',\n                            data: prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                            key: \"<?php echo $_SESSION['key']; ?>\"\n                        },\n                        function(data) {\n                            data = prepareExchangedData(data, 'decode', '<?php echo $_SESSION['key']; ?>');\n                            if (debugJavascript === true) console.log(data);\n\n                            if (data.error !== false) {\n                                // Show error\n                                toastr.remove();\n                                toastr.error(\n                                    data.message,\n                                    '<?php echo langHdl('caution'); ?>', {\n                                        timeOut: 5000,\n                                        progressBar: true\n                                    }\n                                );\n\n                                // Enable buttons\n                                $('#dialog-user-temporary-code-do, #dialog-user-temporary-code-close').removeAttr('disabled');\n                            } else {\n                                // Inform user\n                                // Enable close button\n                                $('#dialog-user-temporary-code-close').removeAttr('disabled');\n                                $('#dialog-user-temporary-code-do').attr('disabled', 'disabled');\n\n                                // Finished\n                                $(\"#dialog-user-temporary-code-progress\").html('<i class=\"fas fa-check text-success mr-3\"></i><?php echo langHdl('done'); ?>');\n                                toastr.remove();\n\n                                store.update(\n                                    'teampassUser', {},\n                                    function(teampassUser) {\n                                        teampassUser.special = 'none';\n                                    }\n                                );\n                            }\n                        }\n                    );\n                }\n            }\n        );\n    });\n    $(document).on('click', '#dialog-user-temporary-code-close', function() {\n        // HIde\n        $('.content-header, .content').removeClass('hidden');\n\n        // SHow form\n        $('#dialog-user-temporary-code').addClass('hidden');\n    });\n\n\n    /**\n    * NEW LDAP USER HAS TO BUILD THE ITEMS DATABASE\n     */\n    $(document).on('click', '#dialog-ldap-user-build-keys-database-do', function() {\n        if ($('#dialog-ldap-user-build-keys-database-code').val() === '') {\n\n            return false;\n        }\n        // Perform a renecryption based upon a temporary code\n        console.log('Building items keys database for new LDAP user');\n\n        // Show progress\n        $('#dialog-ldap-user-build-keys-database-progress').html('<b><?php echo langHdl('please_wait'); ?></b><i class=\"fas fa-spinner fa-pulse ml-3 text-primary\"></i>');\n        toastr.remove();\n        toastr.info(\n            '<?php echo langHdl('in_progress'); ?><i class=\"fas fa-circle-notch fa-spin fa-2x ml-3\"></i>'\n        );\n        \n        // Disable buttons\n        $('#dialog-ldap-user-build-keys-database-do, #dialog-ldap-user-build-keys-database-close').attr('disabled', 'disabled');            \n        \n        // Start by testing if the temporary code is correct to decrypt an item\n        data = {\n            'user_id': store.get('teampassUser').user_id,\n            'password' : $('#dialog-ldap-user-build-keys-database-code').val(),\n        }\n        if (debugJavascript === true) console.log(data);\n\n        $.post(\n            'sources/main.queries.php', {\n                type: 'test_current_user_password_is_correct',\n                type_category: 'action_password',\n                data: prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                key: \"<?php echo $_SESSION['key']; ?>\"\n            },\n            function(data) {\n                data = prepareExchangedData(data, 'decode', '<?php echo $_SESSION['key']; ?>');\n                if (debugJavascript === true) console.log(data);\n\n                if (data.error !== false) {\n                    // Show error\n                    toastr.remove();\n                    toastr.error(\n                        data.message,\n                        '<?php echo langHdl('caution'); ?>', {\n                            timeOut: 5000,\n                            progressBar: true\n                        }\n                    );\n\n                    $(\"#dialog-ldap-user-build-keys-database-progress\").html('<?php echo langHdl('bad_code'); ?>');\n\n                    // Enable buttons\n                    $('#dialog-ldap-user-build-keys-database-do, #dialog-ldap-user-build-keys-database-close').removeAttr('disabled');\n                } else {\n                    // Change privatekey encryption with user-s password\n                    data = {\n                        'user_id': store.get('teampassUser').user_id,\n                        'current_code': $('#dialog-ldap-user-build-keys-database-code').val(),\n                        'new_code': '',\n                        'action_type' : '',\n                    }\n                    if (debugJavascript === true) console.log(data);\n                    \n                    $.post(\n                        'sources/main.queries.php', {\n                            type: 'change_private_key_encryption_password',\n                            type_category: 'action_key',\n                            data: prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                            key: \"<?php echo $_SESSION['key']; ?>\"\n                        },\n                        function(data) {\n                            data = prepareExchangedData(data, 'decode', '<?php echo $_SESSION['key']; ?>');\n                            if (debugJavascript === true) console.log(data);\n\n                            if (data.error !== false) {\n                                // Show error\n                                toastr.remove();\n                                toastr.error(\n                                    data.message,\n                                    '<?php echo langHdl('caution'); ?>', {\n                                        timeOut: 5000,\n                                        progressBar: true\n                                    }\n                                );\n\n                                \n                                $(\"#dialog-ldap-user-build-keys-database-progress\").html('<i class=\"fas fa-exclamation-circle text-danger mr-3\"></i><?php echo langHdl('bad_code'); ?>');\n\n                                // Enable buttons\n                                $('#dialog-ldap-user-build-keys-database-do, #dialog-ldap-user-build-keys-database-close').removeAttr('disabled');\n                            } else {\n                                // Inform user\n                                // Enable close button\n                                $('#dialog-ldap-user-build-keys-database-close').removeAttr('disabled');\n                                $('#dialog-ldap-user-build-keys-database-do').attr('disabled', 'disabled');\n\n                                // Finished\n                                $(\"#dialog-ldap-user-build-keys-database-progress\").html('<i class=\"fas fa-check text-success mr-3\"></i><?php echo langHdl('done'); ?>');\n                                toastr.remove();\n\n                                store.update(\n                                    'teampassUser', {},\n                                    function(teampassUser) {\n                                        teampassUser.special = 'none';\n                                    }\n                                );\n\n                                // refresh the page\n                                window.location.href = 'index.php?page=items';\n                            }\n                        }\n                    );\n                }\n            }\n        );\n\n\n\n\n        /*\n        // Inform user\n        userShareKeysReencryption(\n            store.get('teampassUser').user_id,\n            true,\n            'dialog-ldap-user-build-keys-database'\n        );*/\n    });\n    $(document).on('click', '#dialog-user-temporary-code-close', function() {\n        // HIde\n        $('.content-header, .content').removeClass('hidden');\n\n        // SHow form\n        $('#dialog-user-temporary-code').addClass('hidden');\n    });\n\n\n    /**\n    * USER PASSWORD IN LDAP HAS CHANGED\n    */\n    $(document).on('click', '#dialog-ldap-user-change-password-do', function() {\n        // Start by changing the user password and send it by email\n        if ($('#dialog-ldap-user-change-password-old').val() !== \"\" && $('#dialog-ldap-user-change-password-current').val() !== \"\") {\n            // Case where a user is changing his authentication password\n            console.log('Reencryption based upon user auth password changed in LDAP');\n\n            // Show progress\n            $('#dialog-ldap-user-change-password-progress').html('<b><?php echo langHdl('please_wait'); ?></b><i class=\"fas fa-spinner fa-pulse ml-3 text-primary\"></i>');\n            toastr.remove();\n            toastr.info(\n                '<?php echo langHdl('in_progress'); ?><i class=\"fas fa-circle-notch fa-spin fa-2x ml-3\"></i>'\n            );\n            \n            // Disable buttons\n            $('#dialog-ldap-user-change-password-do, #dialog-ldap-user-change-password-close').attr('disabled', 'disabled');\n            \n            data = {\n                'user_id': store.get('teampassUser').user_id,\n                'previous_password': $('#dialog-ldap-user-change-password-old').val(),\n                'current_password': $('#dialog-ldap-user-change-password-current').val(),\n            }\n            if (debugJavascript === true) console.log(data);\n\n            // Check user current password\n            // and change the password\n            // and use the password to re-encrypt the privatekey\n            $.post(\n                'sources/main.queries.php', {\n                    type: 'change_user_ldap_auth_password',\n                    type_category: 'action_password',\n                    data: prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                    key: \"<?php echo $_SESSION['key']; ?>\"\n                },\n                function(data) {\n                    data = prepareExchangedData(data, 'decode', '<?php echo $_SESSION['key']; ?>');\n                    if (debugJavascript === true) console.log(data);\n\n                    if (data.error !== false) {\n                        // Show error\n                        toastr.remove();\n                        toastr.error(\n                            data.message,\n                            '<?php echo langHdl('caution'); ?>', {\n                                timeOut: 5000,\n                                progressBar: true\n                            }\n                        );\n\n                        $(\"#dialog-ldap-user-change-password-progress\").html('<?php echo langHdl('fill_in_fields_and_hit_launch'); ?>');\n\n                        // Enable buttons\n                        $('#dialog-ldap-user-change-password-do, #dialog-ldap-user-change-password-close').removeAttr('disabled');\n                    } else {\n                        // SUCCESS\n                        $('#dialog-ldap-user-change-password-close').removeAttr('disabled');\n                        toastr.remove();\n                        toastr.success(\n                            data.message,\n                            '<?php echo langHdl('success'); ?>', {\n                                timeOut: 5000,\n                                progressBar: true\n                            }\n                        );\n                        $(\"#dialog-ldap-user-change-password-progress\").html('');\n                    }\n                }\n            );\n        } else {\n            // Show error\n            toastr.remove();\n            toastr.error(\n                '<?php echo langHdl('password_cannot_be_empty'); ?>',\n                '<?php echo langHdl('caution'); ?>', {\n                    timeOut: 5000,\n                    progressBar: true\n                }\n            );\n        }\n    });\n    $(document).on('click', '#dialog-ldap-user-change-password-close', function() {\n        // HIde\n        $('.content-header, .content').removeClass('hidden');\n\n        // SHow form\n        $('#dialog-ldap-user-change-password, #dialog-ldap-user-change-password-info').addClass('hidden');\n    });\n    // --- END ---\n\n\n    function loadSettings() {\n        return $.post(\n            \"sources/main.queries.php\", {\n                type: \"get_teampass_settings\",\n                type_category: 'action_system',\n                key: '<?php echo $_SESSION['key']; ?>'\n            },\n            function(data) {\n                try {\n                    data = prepareExchangedData(\n                        data,\n                        \"decode\",\n                        \"<?php echo $_SESSION['key']; ?>\"\n                    );\n                } catch (e) {\n                    // error\n                    toastr.remove();\n                    toastr.error(\n                        '<?php echo langHdl('server_answer_error'); ?>',\n                        '<?php echo langHdl('caution'); ?>', {\n                            timeOut: 5000,\n                            progressBar: true,\n                            positionClass: \"toast-top-right\"\n                        }\n                    );\n                    return false;\n                }\n                if (debugJavascript === true) {\n                    console.log('Loading settings result:');\n                    console.log(data);\n                }\n\n                // Test if JSON object\n                if (typeof data === 'object') {\n                    // Store settings in localstorage\n                    // except sensitive data\n                    var sensitiveData = ['ldap_hosts','ldap_username','ldap_password','ldap_bdn', 'email','bck_script_passkey'];\n\n                    store.remove(\"teampassSettings\");\n\n                    store.update(\n                        'teampassSettings', {},\n                        function(teampassSettings) {\n                            $.each(data, function(key, value) {\n                                const containsKey = sensitiveData.some(element => {\n                                    if (key.includes(element)) {\n                                        return true;\n                                    }\n                                    return false;\n                                });\n\n                                if (containsKey === false) {\n                                    teampassSettings[key] = value;\n                                }\n                            });\n                        }\n                    );\n\n                    // Store some User info\n                    store.update(\n                        'teampassUser', {},\n                        function(teampassUser) {\n                            teampassUser['user_admin'] = <?php echo isset($_SESSION['user_admin']) === true ? (int) $_SESSION['user_admin'] : 0; ?>;\n                            teampassUser['user_id'] = <?php echo isset($_SESSION['user_id']) === true ? (int) $_SESSION['user_id'] : 0; ?>;\n                            teampassUser['user_manager'] = <?php echo isset($_SESSION['user_manager']) === true ? (int) $_SESSION['user_manager'] : 0; ?>;\n                            teampassUser['user_can_manage_all_users'] = <?php echo isset($_SESSION['user_can_manage_all_users']) === true ? (int) $_SESSION['user_can_manage_all_users'] : 0; ?>;\n                            teampassUser['user_read_only'] = <?php echo isset($_SESSION['user_admin']) === true ? (int) $_SESSION['user_read_only'] : 1; ?>;\n                            teampassUser['key'] = '<?php echo isset($_SESSION['key']) === true ? $_SESSION['key'] : 0; ?>';\n                            teampassUser['login'] = \"<?php echo isset($_SESSION['login']) === true ? $_SESSION['login'] : 0; ?>\";\n                            teampassUser['lastname'] = \"<?php echo isset($_SESSION['lastname']) === true ? $_SESSION['lastname'] : 0; ?>\";\n                            teampassUser['name'] = \"<?php echo isset($_SESSION['name']) === true ? $_SESSION['name'] : 0; ?>\";\n                            teampassUser['pskDefinedInDatabase'] = <?php echo isset($_SESSION['user']['encrypted_psk']) === true ? 1 : 0; ?>;\n                            teampassUser['can_create_root_folder'] = <?php echo isset($_SESSION['can_create_root_folder']) === true ? (int) $_SESSION['can_create_root_folder'] : 0; ?>;\n                            teampassUser['pskDefinedInDatabase'] = <?php echo isset($_SESSION['user']['encrypted_psk']) === true ? 1 : 0; ?>;\n                            teampassUser['special'] = '<?php echo isset($_SESSION['user']['special']) === true ? $_SESSION['user']['special'] : 'none'; ?>';\n                        }\n                    );\n                }\n            }\n        );\n    }\n\n    /**\n     * Undocumented function\n     *\n     * @return void\n     */\n    function showExtendSession() {\n        // Prepare modal\n        showModalDialogBox(\n            '#warningModal',\n            '<i class=\"fas fa-clock fa-lg warning mr-2\"></i><?php echo langHdl('index_add_one_hour'); ?>',\n            '<div class=\"form-group\">' +\n            '<label for=\"warningModal-input\" class=\"col-form-label\"><?php echo langHdl('index_session_duration') . ' (' . langHdl('minutes') . ')'; ?>:</label>' +\n            '<input type=\"text\" class=\"form-control\" id=\"warningModal-input\" value=\"<?php echo isset($_SESSION['user']['session_duration']) === true ? (int) $_SESSION['user']['session_duration'] / 60 : 60; ?>\">' +\n            '</div>',\n            '<?php echo langHdl('confirm'); ?>',\n            '<?php echo langHdl('cancel'); ?>'\n        );\n\n        // Actions on modal buttons\n        $(document).on('click', '#warningModalButtonAction', function() {\n            // SHow user\n            toastr.remove();\n            toastr.info(\n                '<?php echo langHdl('in_progress'); ?><i class=\"fas fa-circle-notch fa-spin fa-2x ml-3\"></i>'\n            );\n\n            // Perform action\n            $.when(\n                IncreaseSessionTime(\n                    $('#warningModal-input').val()\n                )\n            ).then(function() {\n                toastr.remove();\n                toastr.success(\n                    '<?php echo langHdl('done'); ?>',\n                    '', {\n                        timeOut: 1000\n                    }\n                );\n                $('#warningModal').modal('hide');\n            });\n        });\n    }\n\n    /**\n     * Undocumented function\n     *\n     * @return void\n     */\n    function showPersonalSKDialog() {\n        $('#dialog-request-psk').removeClass('hidden');\n\n        // Hide other\n        $('.content-header, .content').addClass('hidden');\n\n        $('#user_personal_saltkey').focus();\n\n        toastr.remove();\n    }\n\n    /**\n     * Loads the last seen items\n     *\n     * @return void\n     */\n    function refreshListLastSeenItems() {\n        $.post(\n            \"sources/main.queries.php\", {\n                type: 'refresh_list_items_seen',\n                type_category: 'action_user',\n                key: '<?php echo $_SESSION['key']; ?>'\n            },\n            function(data) {\n                try {\n                    data = $.parseJSON(data)\n                } catch (e) {\n                    return false;\n                }\n                if (debugJavascript === true) {\n                    console.log('Refresh last item seen result');\n                    console.log(data);\n                }\n                //check if format error\n                if (data.error === '') {\n                    if (data.html_json === null || data.html_json === '') {\n                        $('#index-last-pwds').html('<li><?php echo langHdl('none'); ?></li>');\n                    } else {\n                        // Prepare HTML\n                        var html_list = '';\n                        $.each(data.html_json, function(i, value) {\n                            html_list += '<li onclick=\"showItemCard($(this).closest(\\'li\\'))\" class=\"pointer\" data-item-edition=\"0\" data-item-id=\"' + value.id + '\" data-item-sk=\"' + value.perso + '\" data-item-expired=\"0\" data-item-restricted=\"' + value.restricted + '\" data-item-display=\"1\" data-item-open-edit=\"0\" data-item-reload=\"0\" data-item-tree-id=\"' + value.tree_id + '\" data-is-search-result=\"0\">' +\n                                '<i class=\"fa fa-caret-right mr-2\"></i>' + value.label + '</li>';\n                        });\n                        $('#index-last-pwds').html(html_list);\n                    }\n\n                    // show notification\n                    if (data.existing_suggestions !== 0) {\n                        blink('#menu_button_suggestion', -1, 500, 'ui-state-error');\n                    }\n                } else {\n                    toastr.remove();\n                    toastr.error(\n                        data.error,\n                        '<?php echo langHdl('caution'); ?>', {\n                            timeOut: 5000,\n                            progressBar: true\n                        }\n                    );\n                }\n            }\n        );\n    }\n\n    /**\n     * Show an item\n     *\n     * @return void\n     */\n    function showItemCard(itemDefinition) {\n        // Show circle-notch\n        toastr.remove();\n        toastr.info(\n            '<?php echo langHdl('in_progress'); ?><i class=\"fas fa-circle-notch fa-spin fa-2x ml-3\"></i>'\n        );\n\n        if (window.location.href.indexOf('page=items') === -1) {\n            location.replace('<?php echo $SETTINGS['cpassman_url']; ?>/index.php?page=items&group=' + itemDefinition.data().itemTreeId + '&id=' + itemDefinition.data().itemId);\n        } else {\n            $('#items_list').html('<ul class=\"liste_items\" id=\"full_items_list\"></ul>');\n            Details(itemDefinition, 'show');\n            if (itemDefinition.data().itemTreeId !== $('#open_folder').val()) {\n                ListerItems(itemDefinition.data().itemTreeId, '', 0);\n            }\n\n            // Hide sidebar-mini\n            $('body')\n                .removeClass('control-sidebar-slide-open');\n        }\n    }\n\n    /**\n     * Open defect report page\n     *\n     * @return void\n     */\n    function generateBugReport() {\n        $('#dialog-bug-report-text').html('');\n        $('#dialog-bug-report').removeClass('hidden');\n\n        // Scroll to top\n        $(window).scrollTop(0);\n\n        var data = {\n            'browser_name': platform.name,\n            'browser_version': platform.version,\n            'os': platform.os.family,\n            'os_archi': platform.os.architecture,\n            'current_page': window.location.href.substring(window.location.href.lastIndexOf(\"/\")+1),\n        }\n        \n        $.post(\n            \"sources/main.queries.php\", {\n                type: 'generate_bug_report',\n                type_category: 'action_system',\n                data: prepareExchangedData(JSON.stringify(data), 'encode', '<?php echo $_SESSION['key']; ?>'),\n                key: '<?php echo $_SESSION['key']; ?>'\n            },\n            function(data) {\n                data = prepareExchangedData(data, 'decode', '<?php echo $_SESSION['key']; ?>');\n\n                // Show data\n                $('#dialog-bug-report-text').html(data.html);\n\n                // Open Github\n                $('#dialog-bug-report-github-button').click(function() {\n                    window.open('https://github.com/nilsteampassnet/TeamPass/issues/new', '_blank');\n                    return false;\n                });\n            }\n        );\n    }\n\n\n\n    function userShareKeysReencryption(\n        userId = null,\n        erase_existing_keys = false,\n        divIdDialog = '',\n        to_be_continued = false\n    ) {\n        console.log('USER SHAREKEYS RE-ENCRYPTION START');\n\n        $('#'+divIdDialog+'-progress').html('<b><?php echo langHdl('clearing_old_sharekeys'); ?></b><i class=\"fas fa-spinner fa-pulse ml-3 text-primary\"></i>');\n\n        toastr.remove();\n        toastr.info(\n            '<?php echo langHdl('in_progress'); ?><i class=\"fas fa-circle-notch fa-spin fa-2x ml-3\"></i>'\n        );\n\n        var data = {\n            'user_id': userId,\n            'self_change': erase_existing_keys,\n        }\n        if (debugJavascript === true) console.log(data)\n        $.post(\n            \"sources/main.queries.php\", {\n                type: \"user_sharekeys_reencryption_start\",\n                type_category: 'action_key',\n                data: prepareExchangedData(JSON.stringify(data), 'encode', '<?php echo $_SESSION['key']; ?>'),\n                key: '<?php echo $_SESSION['key']; ?>'\n            },\n            function(data) {\n                data = prepareExchangedData(data, \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n                if (debugJavascript === true) console.log(data)\n                if (data.error === true) {\n                    // error\n                    toastr.remove();\n                    toastr.error(\n                        data.message,\n                        '<?php echo langHdl('caution'); ?>', {\n                            timeOut: 5000,\n                            progressBar: true\n                        }\n                    );\n\n                    $(\"#\"+divIdDialog+'-progress').html('<?php echo langHdl('fill_in_fields_and_hit_launch'); ?>');\n\n                    // Enable buttons\n                    $('#'+divIdDialog+'-do, #'+divIdDialog+'-close').removeAttr('disabled');\n                    return false;\n                } else {\n                    // Start looping on all steps of re-encryption\n                    userShareKeysReencryptionNext(data.userId, data.step, data.start, erase_existing_keys, divIdDialog, to_be_continued);\n                }\n            }\n        );\n    }\n\n    function userShareKeysReencryptionNext(\n        userId,\n        step,\n        start,\n        erase_existing_keys = false,\n        divIdDialog,\n        to_be_continued\n    ) {\n        var stepText = '';\n        console.log('Performing '+step)\n\n        // Prepare progress string\n        if (step === 'step0') {\n            stepText = '<?php echo langHdl('inititialization'); ?>';\n        } else if (step === 'step1') {\n            stepText = '<?php echo langHdl('items'); ?>';\n        } else if (step === 'step2') {\n            stepText = '<?php echo langHdl('logs'); ?>';\n        } else if (step === 'step3') {\n            stepText = '<?php echo langHdl('suggestions'); ?>';\n        } else if (step === 'step4') {\n            stepText = '<?php echo langHdl('fields'); ?>';\n        } else if (step === 'step5') {\n            stepText = '<?php echo langHdl('files'); ?>';\n        } else if (step === 'step6') {\n            stepText = '<?php echo langHdl('personal_items'); ?>';\n        }\n\n        if (step !== 'finished') {\n            // Inform user\n            $(\"#\"+divIdDialog+'-progress').html('<b><?php echo langHdl('encryption_keys'); ?> - ' +\n                stepText + '</b> [' + start + ' - ' + (parseInt(start) + <?php echo NUMBER_ITEMS_IN_BATCH;?>) + '] ' +\n                '... <?php echo langHdl('please_wait'); ?><i class=\"fas fa-spinner fa-pulse ml-3 text-primary\"></i>');\n\n            var data = {\n                'action': step,\n                'start': start,\n                'length': <?php echo NUMBER_ITEMS_IN_BATCH;?>,\n                'user_id': userId,\n            }\n            // Do query\n            $.post(\n                \"sources/main.queries.php\", {\n                    type: \"user_sharekeys_reencryption_next\",\n                    type_category: 'action_key',\n                    data: prepareExchangedData(JSON.stringify(data), 'encode', '<?php echo $_SESSION['key']; ?>'),\n                    key: '<?php echo $_SESSION['key']; ?>'\n                },\n                function(data) {\n                    data = prepareExchangedData(data, \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n                    if (debugJavascript === true) console.log(data);\n                    \n                    if (data.error === true) {\n                        // error\n                        toastr.remove();\n                        toastr.error(\n                            data.message,\n                            '<?php echo langHdl('caution'); ?>', {\n                                timeOut: 5000,\n                                progressBar: true\n                            }\n                        );\n\n                        // Enable buttons\n                        $('#'+divIdDialog+'-do, #'+divIdDialog+'-close').removeAttr('disabled');\n                        return false;\n                    } else {\n                        // Start looping on all steps of re-encryption\n                        userShareKeysReencryptionNext(data.userId, data.step, data.start, erase_existing_keys, divIdDialog, to_be_continued);\n                    }\n                }\n            );\n        } else {console.log(\"Finishing : \"+to_be_continued)\n            if (to_be_continued !== true) {\n                // Enable close button\n                $('#'+divIdDialog+'-close').removeAttr('disabled');\n\n                // Finished\n                $(\"#\"+divIdDialog+'-progress').html('<i class=\"fas fa-check text-success mr-3\"></i><?php echo langHdl('done'); ?>');\n                toastr.remove();\n\n                // Unlog if same user\n                if (userId === <?php echo $_SESSION['user_id']; ?>) {\n                    toastr.success(\n                        '<?php echo langHdl('logout_on_going'); ?><i class=\"fas fa-circle-notch fa-spin fa-2x ml-3\"></i>',\n                        '', {\n                            timeOut: 4000\n                        }\n                    );\n\n                    window.location.href = \"./includes/core/logout.php?user_id=\" + <?php echo $_SESSION['user_id']; ?>\n                } else if (store.get('teampassUser').admin_user_password) {\n                    // now select if sending by email\n                    $('#dialog-admin-change-user-password-info').html('<i class=\"fas fa-envelope-open-text fa-lg warning mr-2\"></i><?php echo langHdl('information'); ?><br><br>'+\n                    '<i class=\"fas fa-info-circle mr-2\"></i><?php echo langHdl('send_user_password_by_email'); ?>'+\n                    '<div class=\"row\">'+\n                        '<div class=\"col-lg-2\"><button type=\"button\" class=\"btn btn-block btn-secondary mr-2 temp-button\"  data-action=\"show-user-pwd\"><?php echo langHdl('show_user_password'); ?></button></div>'+\n                        '<div class=\"col-lg-2\"><input class=\"form-control form-item-control\" type=\"hidden\" id=\"temp-user-pwd\" value=\"'+store.get('teampassUser').admin_user_password+'\"></div>'+\n                        '<div class=\"col-lg-2\"><button type=\"button\" class=\"btn btn-block btn-secondary mr-2 temp-button\"  data-action=\"send-user-pwd\"><?php echo langHdl('send_by_email'); ?></button>'+\n                        '<input class=\"form-control form-item-control\" type=\"hidden\" id=\"temp-user-email\" value=\"'+store.get('teampassUser').admin_user_email+'\"></div>'+\n                    '</div>');\n\n\n                    $(\"#dialog-admin-change-user-password-progress\").html('<?php echo langHdl('done'); ?>');\n                    $(\"#dialog-admin-change-user-password-do\").removeAttr('disabled');\n                }\n            }\n        }\n    }\n\n    // This permits to manage the column width of tree/items\n    $(document).on('click', '.columns-position', function() {\n        var colLeft = $('#folders-tree-card').find('.column-left'),\n            colRight = $('#folders-tree-card').find('.column-right'),\n            counterLeft = $(colLeft).attr(\"class\").match(/col-md-[\\w-]*\\b/)[0].split('-')[2],\n            counterRight = $(colRight).attr(\"class\").match(/col-md-[\\w-]*\\b/)[0].split('-')[2];\n\n        // Toogle class\n        if ($('#folders-tree-card').hasClass('hidden') === false) {\n            if ($(this).hasClass('tree-decrease') === true && counterRight < 9) {\n                $(colLeft).toggleClass('col-md-' + counterLeft + ' col-md-' + (parseInt(counterLeft) - 1));\n                $(colRight).toggleClass('col-md-' + counterRight + ' col-md-' + (parseInt(counterRight) + 1));\n            } else if ($(this).hasClass('tree-increase') === true && counterLeft < 9) {\n                $(colLeft).toggleClass('col-md-' + counterLeft + ' col-md-' + (parseInt(counterLeft) + 1));\n                $(colRight).toggleClass('col-md-' + counterRight + ' col-md-' + (parseInt(counterRight) - 1));\n            }\n        }\n    })\n\n    $(function() {\n        // In case that session was expired and login form was reloaded\n        // Force the launchIdentify as if the user has clicked the button\n        if ($(\"#auto_log\").length > 0) {\n            $(\"#but_identify_user\").click();\n        }\n    });\n\n    // Prevent usage of browser back button\n    history.pushState(null, null, location.href);\n    window.onpopstate = function () {\n        const queryString = window.location.search\n        const urlParams = new URLSearchParams(queryString);\n        if (urlParams.get('page') === 'items') {\n            // go back to list\n            // Play with show and hide classes\n            $('.form-item, .form-item-action, .form-folder-action, .item-details-card, .columns-position, #item-details-card-categories, #form-item-upload-pickfilesList, #card-item-expired')\n                .addClass('hidden');\n            $('#folders-tree-card').removeClass('hidden');\n\n            history.go(1);\n        }\n    };\n\n\n\n    /**\n     * \n     * @param {integer} duration\n     * \n     */\n    function clearClipboardTimeout(duration) {\n        // Wait for duration\n        $(this).delay(duration * 1000).queue(function() {\n            navigator.clipboard.writeText(\"Cleared by Teampass\").then(function() {\n                // clipboard successfully set\n            }, function() {\n                // clipboard write failed\n            });\n\n            $(this).dequeue();\n        });\n    }\n</script>\n", "<?php\n\ndeclare(strict_types=1);\n\n/**\n * Teampass - a collaborative passwords manager.\n * ---\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n * ---\n *\n * @project   Teampass\n * @version   3.0.0.23\n * @file      logout.php\n * ---\n *\n * @author    Nils Laumaill\u00e9 (nils@teampass.net)\n *\n * @copyright 2009-2023 Teampass.net\n *\n * @license   https://spdx.org/licenses/GPL-3.0-only.html#licenseText GPL-3.0\n * ---\n *\n * @see       https://www.teampass.net\n */\n\nrequire_once '../../sources/SecureHandler.php';\nsession_name('teampass_session');\nsession_start();\n\n// Load superglobal library\nrequire_once '../../includes/libraries/protect/SuperGlobal/SuperGlobal.php';\n$superGlobal = new protect\\SuperGlobal\\SuperGlobal();\n$get = [];\n$get['user_id'] = $superGlobal->get('user_id', 'GET');\n\n// Update table by deleting ID\nif (isset($_SESSION['user_id']) === true && empty($_SESSION['user_id']) === false) {\n    $user_id = $_SESSION['user_id'];\n} elseif (isset($get['user_id']) === true && empty($get['user_id']) === false) {\n    $user_id = $get['user_id'];\n} else {\n    $user_id = '';\n}\n\nif (empty($user_id) === false && isset($_SESSION['CPM']) === true) {\n    // connect to the server\n    include_once '../../sources/main.functions.php';\n    include_once '../../includes/config/settings.php';\n    include_once '../../includes/libraries/Database/Meekrodb/db.class.php';\n    DB::$host = DB_HOST;\n    DB::$user = DB_USER;\n    DB::$password = defuseReturnDecrypted(DB_PASSWD, $SETTINGS);\n    DB::$dbName = DB_NAME;\n    DB::$port = DB_PORT;\n    DB::$encoding = DB_ENCODING;\n    DB::$ssl = DB_SSL;\n    DB::$connect_options = DB_CONNECT_OPTIONS;\n    // clear in db\n    DB::update(\n        DB_PREFIX.'users',\n        [\n            'key_tempo' => '',\n            'timestamp' => '',\n            'session_end' => '',\n        ],\n        'id=%i',\n        $user_id\n    );\n    //Log into DB the user's disconnection\n    if (isset($SETTINGS['log_connections']) === true\n        && (int) $SETTINGS['log_connections'] === 1\n    ) {\n        include_once '../../sources/main.functions.php';\n        logEvents($SETTINGS, 'user_connection', 'disconnect', (string) $user_id, isset($_SESSION['login']) === true ? $_SESSION['login'] : '');\n    }\n}\n\n// erase session table\nsession_destroy();\n$_SESSION = [];\nrequire_once '../../sources/SecureHandler.php';\nsession_name('teampass_session');\nsession_start();\n$_SESSION['CPM'] = 1;\necho '\n    <script type=\"text/javascript\" src=\"../../plugins/store.js/dist/store.everything.min.js\"></script>\n    <script language=\"javascript\" type=\"text/javascript\">\n    <!--\n        // Clear localstorage\n        store.remove(\"teampassApplication\");\n        store.remove(\"teampassSettings\");\n        store.remove(\"teampassUser\");\n        store.remove(\"teampassItem\");\n        sessionStorage.clear();\n        \n        setTimeout(function() {\n            document.location.href=\"../../index.php\"\n        }, 1);\n    -->\n    </script>';\n", "body{\n    width: 1000px;\n    margin-left: auto;\n    margin-right: auto;\n    background-image: url(../../includes/images/install_background.jpg);\n\t-webkit-background-size: cover;\n\tbackground-size: cover;\n    font-family: sans-serif;\n}\n\n#top{\n\twidth: 1000px;\n\tmargin-left: auto;\n\tmargin-right: auto;\n\tpadding: 10px;\n\tfont-family: sans-serif;\n\tdisplay:block;\n\tcolor: #404d63;\n}\n\n.lcol {\n\tvertical-align:middle;\n\tdisplay:inline-block;\n\tmargin-bottom: 15px;\n}\n\n.header-title{\n\tfont-size: 42px;\n\tletter-spacing: 10px;\n\tcolor: #84AAB7;\n}\n\n.header-title-small{\n\tfont-size: 16px;\n\tletter-spacing: 2px;\n}\n\n#title {\n  font: bold 270%/100% \"Lucida Grande\";\n  color: #464646;\n  float:left;\n  margin-top:3px;\n}\n\n#main {\n\twidth: 1000px;\n\tmargin-top:15px;\n\tmargin-left: auto;\n\tmargin-right: auto;\n\tbackground-color:white;\n\tcolor:#464646;\n\theight:90%;\n\toverflow:hidden;\n\tpadding:10px;\n\tdisplay:block;\n\theight:100%;\n}\n\n#menu {\n\tfloat:  left;\n\twidth:  25%;\n\tmargin-left:-20px;\n\theight:100%;\n}\n\n#menu li {\n\tmargin-top:5px;\n}\n\n.li_inprogress {\n\tfont-weight:    bold;\n\tcolor:          #5283BB;\n}\n\n.li_done {\n\tfont-weight:    normal;\n\tcolor:          #464646;\n}\n\n#content {\n\t/*float:left;\n\twidth:  75%;\n\theight:100%;*/\n}\n\n#step_name {\n\tfont-weight:    bold;\n\ttext-align:     center;\n\tfont-size:      15px;\n}\n\n#step_content {\n\tmargin-top: 10px;\n}\n\n#action_buttons {\n\twidth: 1000px;\n\tpadding:    10px;\n\tmargin:0 auto 0 auto;\n\tbackground-color:white;\n\tcolor:#464646;\n\theight:     30px;\n\ttext-align: right;\n}\nh5 {\n\tmargin-bottom: 10px;\n}\n\n.label_block {\n\tdisplay: inline-block;\n\twidth:  200px;\n\tmargin-bottom: 2px;\n}\n\n.label_block_big {\n\tdisplay: inline-block;\n\twidth:  270px;\n\tmargin-bottom: 2px;\n}\n\n.hidden {\n  display: none;\n}\n\n.center-screen {\n\tposition:absolute;\n\ttop:50%;\n\tleft: 50%;\n\tmargin-right: -50%;\n\ttransform: translate(-50%, -50%);\n}", "<?php\n/**\n * Teampass - a collaborative passwords manager.\n * ---\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n * ---\n * @project   Teampass\n * @version   3.0.0.23\n * @file      upgrade.php\n * ---\n * @author    Nils Laumaill\u00e9 (nils@teampass.net)\n * @copyright 2009-2023 Teampass.net\n * @license   https://spdx.org/licenses/GPL-3.0-only.html#licenseText GPL-3.0\n * ---\n * @see       https://www.teampass.net\n */\n\n\nheader('X-XSS-Protection: 1; mode=block');\nheader('X-Frame-Options: SameOrigin');\n\n// **PREVENTING SESSION HIJACKING**\n// Prevents javascript XSS attacks aimed to steal the session ID\nini_set('session.cookie_httponly', 1);\n\n// **PREVENTING SESSION FIXATION**\n// Session ID cannot be passed through URLs\nini_set('session.use_only_cookies', 1);\n\n// Uses a secure connection (HTTPS) if possible\nini_set('session.cookie_secure', 0);\n\nrequire_once '../sources/SecureHandler.php';\nsession_name('teampass_session');\nsession_start();\n//Session teampass tag\n$_SESSION['CPM'] = 1;\ndefine('MIN_PHP_VERSION', 7.4);\ndefine('MIN_MYSQL_VERSION', '8.0.13');\ndefine('MIN_MARIADB_VERSION', '10.2.1');\n\n// Prepare POST variables\n$post_root_url = filter_input(INPUT_POST, 'root_url', FILTER_SANITIZE_STRING);\n$post_step = filter_input(INPUT_POST, 'step', FILTER_SANITIZE_NUMBER_INT);\n$post_actual_cpm_version = filter_input(INPUT_POST, 'actual_cpm_version', FILTER_SANITIZE_STRING);\n$post_cpm_isUTF8 = filter_input(INPUT_POST, 'cpm_isUTF8', FILTER_SANITIZE_STRING);\n$post_user_granted = filter_input(INPUT_POST, 'user_granted', FILTER_SANITIZE_STRING);\n$post_session_salt = filter_input(INPUT_POST, 'session_salt', FILTER_SANITIZE_STRING);\n$post_url_path = filter_input(INPUT_POST, 'url_path', FILTER_SANITIZE_STRING);\n$post_infotmp = filter_input(INPUT_POST, 'infotmp', FILTER_SANITIZE_STRING);\n\n//###############\n//# Function permits to get the value from a line\n//###############\n/**\n * @param string $val\n */\nfunction getSettingValue($val)\n{\n    $val = trim(strstr($val, '='));\n\n    return trim(str_replace('\"', '', substr($val, 1, strpos($val, ';') - 1)));\n}\n\n//get infos from SETTINGS.PHP file\n$filename = '../includes/config/settings.php';\n$events = '';\nif (file_exists($filename)) {\n    include_once $filename;\n}\n\n?>\n<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n    <head>\n        <title>TeamPass Upgrade</title>\n        \n        <meta http-equiv='Content-Type' content='text/html;charset=utf-8' />\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\"/>\n        <meta http-equiv=\"x-ua-compatible\" content=\"ie=edge\"/>\n\n        <link rel=\"stylesheet\" href=\"css/install.css\" type=\"text/css\" />\n        <link rel=\"stylesheet\" href=\"../plugins/fontawesome-free-6/css/all.css\">\n        \n        <!-- Theme style -->\n        <link rel=\"stylesheet\" href=\"../plugins/adminlte/css/adminlte.min.css\">\n        <link rel=\"stylesheet\" href=\"../plugins/alertifyjs/css/alertify.min.css\"/>\n        <link rel=\"stylesheet\" href=\"../plugins/alertifyjs/css/themes/bootstrap.min.css\"/>\n        \n        \n    </head>\n    \n    <body>\n<?php\nrequire_once '../includes/language/english.php';\nrequire_once '../includes/config/include.php';\n\nif (empty($post_root_url) === false) {\n    $_SESSION['fullurl'] = $post_root_url;\n}\n\n//define root path\n$abs_path = rtrim(\n    filter_var($_SERVER['DOCUMENT_ROOT'], FILTER_SANITIZE_STRING),\n    '/'\n).substr(\n    filter_var($_SERVER['PHP_SELF'], FILTER_SANITIZE_STRING),\n    0,\n    strlen(filter_var($_SERVER['PHP_SELF'], FILTER_SANITIZE_STRING)) - 20\n);\nif (isset($_SERVER['HTTPS'])) {\n    $protocol = 'https://';\n} else {\n    $protocol = 'http://';\n}\n\n\n// HEADER\necho '\n    <div id=\"top\" class=\"center-screen\">\n        <div id=\"logo\" class=\"lcol\"><img src=\"../includes/images/teampass-logo2-home.png\" /></div>\n        <div class=\"lcol\">\n            <span class=\"header-title\">'.strtoupper(TP_TOOL_NAME).'</span>\n            <!--<span class=\"header-title-small\"> v'.TP_VERSION_FULL.'</span>-->\n        </div>\n    <div id=\"content\">\n        <form name=\"install\" method=\"post\" action=\"\">\n        <div class=\"card card-default color-palette-box\">\n            <div class=\"card-header\">\n                <h3 class=\"card-title\">\n                    <i class=\"fas fa-people-carry mr-2\"></i>Teampass upgrade\n                </h3>\n            </div>\n            <div class=\"card-body\">';\n\n//HIDDEN THINGS\necho '\n                <input type=\"hidden\" id=\"step\" name=\"step\" value=\"', isset($post_step) ? $post_step : '', '\" />\n                <input type=\"hidden\" id=\"actual_cpm_version\" name=\"actual_cpm_version\" value=\"', isset($post_actual_cpm_version) ? $post_actual_cpm_version : '', '\" />\n                <input type=\"hidden\" id=\"cpm_isUTF8\" name=\"cpm_isUTF8\" value=\"', isset($post_cpm_isUTF8) ? $post_cpm_isUTF8 : '', '\" />\n                <input type=\"hidden\" name=\"menu_action\" id=\"menu_action\" value=\"\" />\n                <input type=\"hidden\" name=\"user_granted\" id=\"user_granted\" value=\"\" />\n                <input type=\"hidden\" name=\"infotmp\" id=\"infotmp\" value=\"', isset($post_infotmp) ? $post_infotmp : '', '\" />\n                <input type=\"hidden\" name=\"url_path\" id=\"url_path\" value=\"'.$protocol.$_SERVER['HTTP_HOST'].substr($_SERVER['PHP_SELF'], 0, strrpos($_SERVER['PHP_SELF'], '/') - 8).'\" />\n                <input type=\"hidden\" name=\"session_salt\" id=\"session_salt\" value=\"', (isset($post_session_salt) && !empty($post_session_salt)) ? $post_session_salt : @$_SESSION['encrypt_key'], '\" />';\n\nif (!isset($_GET['step']) && !isset($post_step)) {\n    //ETAPE O\n    echo '\n                <div class=\"row\">\n                    <div class=\"callout callout-warning col-12\">\n                        <h5>Information</h5>\n    \n                        <p>Upgrade process is about to start. This will upgrade Teampass database to version '.TP_VERSION_FULL.'.</p>\n                        <p>Version 3 comes with a new secured encryption strategy getting rid of any Saltkey. It relies on public and private keys generated for each user. As an impact, this upgrade will automatically generate a One-Time-Code for each user and send by email. It will be requested on first login. Please ensure your users have filled in their email with a valid value.</p>\n                    </div>\n\n                    <div class=\"callout callout-info col-12\">\n                        <h5>Before starting, take a couple of minutes to perform backup of current Teampass instance:</h5>\n    \n                        <p>\n                        <ul>\n                            <li><i class=\"fas fa-exclamation-circle mr-2 text-danger\"></i>Ensure to clear your browser cache (keyboard: <i>CTRL + F5</i>)</li>\n                            <li><i class=\"fas fa-exclamation-triangle mr-2 text-warning\"></i>Create a dump of your database</li>\n                            <li><i class=\"fas fa-exclamation-triangle mr-2 text-warning\"></i>Perform a zip of the current Teampass folder</li>\n                            <li><i class=\"fas fa-info-circle mr-2 text-success\"></i>Refer to <a href=\"https://teampass.readthedocs.io/en/latest/install/upgrade/\" target=\"_blank\" class=\"text-info\">upgrade documentation</a>.</li>\n                        </ul>\n                        </p>\n                    </div>\n                </div>\n\n                <div class=\"row card card-primary\">\n                    <div class=\"card-body col-12\">\n                        <div class=\"form-group\">\n                            <label>Administrator Login</label>\n                            <input type=\"text\" class=\"form-control\" id=\"user_login\" placeholder=\"Enter admin login\">\n                        </div>\n                        <div class=\"form-group\">\n                            <label>Password</label>\n                            <input type=\"password\" class=\"form-control\" id=\"user_pwd\" placeholder=\"Enter admin password\">\n                        </div>\n                        <div class=\"alert alert-warning hidden\" id=\"res_step0\"></div>\n                    </div>\n                </div>\n\n\n                <input type=\"hidden\" id=\"step0\" name=\"step0\" value=\"\" />\n\n            </div>';\n// STEP1\n} elseif ((isset($post_step) && $post_step == 1)\n    || (isset($_GET['step']) && $_GET['step'] == 1)\n    && $post_user_granted === '1'\n) {\n    //ETAPE 1\n    $_SESSION['user_granted'] = $post_user_granted;\n    echo '\n            <div class=\"row\">\n                <div class=\"col-12\">\n                    <div class=\"card card-primary\">\n                        <div class=\"card-header\">\n                            <h5>Server information</h5>\n                        </div>\n                        <div class=\"card-body\">\n                            <div class=\"form-group\">\n                                <label>Absolute path to TeamPass folder</label>\n                                <input type=\"text\" class=\"form-control\" id=\"root_path\" value=\"'.$abs_path.'\">\n                            </div>\n                            <div class=\"form-group\">\n                                <label>Full URL to TeamPass</label>\n                                <input type=\"text\" class=\"form-control\" id=\"root_url\" value=\"'.$protocol.$_SERVER['HTTP_HOST'].substr($_SERVER['PHP_SELF'], 0, strrpos($_SERVER['PHP_SELF'], '/') - 8).'\">\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <div class=\"row\">\n                <div class=\"col-12\">\n                    <div class=\"card card-primary\">\n                        <div class=\"card-header\">\n                            <h5>Next elements will be checked</h5>\n                        </div>\n                        <div class=\"card-body\">\n\n                            <div id=\"res_step1\">\n                            <span>File \"settings.php\" is writable</span><br />\n                            <span>Directory \"/install/\" is writable</span><br />\n                            <span>Directory \"/includes/\" is writable</span><br />\n                            <span>Directory \"/includes/config/\" is writable</span><br />\n                            <span>Directory \"/includes/avatars/\" is writable</span><br />\n                            <span>Directory \"/files/\" is writable</span><br />\n                            <span>Directory \"/upload/\" is writable</span><br />\n                            <span>PHP extension \"openssl\" is loaded</span><br />\n                            <span>PHP extension \"gd\" is loaded</span><br />\n                            <span>PHP extension \"mbstring\" is loaded</span><br />\n                            <span>PHP extension \"bcmath\" is loaded</span><br />\n                            <span>PHP extension \"iconv\" is loaded</span><br />\n                            <span>PHP extension \"xml\" is loaded</span><br />\n                            <span>PHP extension \"curl\" is loaded</span><br />\n                            <span>PHP extension \"gmp\" is loaded</span><br />\n                            <span>PHP extension \"mcrypt\" is loaded</span><br />\n                            <span>PHP version is greater or equal to '.MIN_PHP_VERSION.'</span><br />\n                            <span>SQL version is greater or equal to MySQL '.MIN_MYSQL_VERSION.' or MariaDB '.MIN_MARIADB_VERSION.'</span><br />\n                            </div>\n                        \n                        </div>\n                    </div>\n                </div>\n            </div>\n            <input type=\"hidden\" id=\"step1\" name=\"step1\" value=\"\" />';\n// STEP2\n} elseif ((isset($post_step) && $post_step == 2)\n    || (isset($_GET['step']) && $_GET['step'] == 2)\n    && $_SESSION['user_granted'] === '1'\n) {\n    // Do we have all database settings\n    if (null !== DB_HOST\n        && null !== DB_USER\n        && null !== DB_PASSWD\n        && null !== DB_NAME\n        && null !== DB_PREFIX\n        && null !== DB_PORT\n    ) {\n        $dbSettings = true;\n    } else {\n        $dbSettings = false;\n    }\n    //ETAPE 2\n    echo '\n        <div class=\"row\">\n            <div class=\"col-12\">\n                <div class=\"card card-',$dbSettings === true ? 'primary' : 'warning','\">\n                    <div class=\"card-header\">\n                        <h5>DataBase Informations</h5>\n                    </div>\n                    <div class=\"card-body\">';\n\n    // check if all database  info are available\n    if ($dbSettings === true) {\n        echo '\n                        <div>\n                        Database settings has been retreived.<br>\n                        If you need to change them, please edit file `/includes/config/settings.php` and relaunch the upgrade process.\n                        </div>';\n    } else {\n        echo '\n                        <div>\n                        The database information has not been retreived from the settings file.<br>\n                        You need to adapt the file `/includes/config/settings.php` and relaunch the upgrade process.\n                        </div>';\n    }\n\n    echo '\n                        <a href=\"'.$protocol.$_SERVER['HTTP_HOST'].substr($_SERVER['PHP_SELF'], 0, strrpos($_SERVER['PHP_SELF'], '/') - 8).'/install/upgrade.php\">Restart upgrade process</a>\n                    </div>\n                </div>\n\n                <div class=\"card card-primary\">\n                    <div class=\"card-header\">\n                        <h5>Maintenance Mode</h5>\n                    </div>\n                    <div class=\"card-body\">\n                        <div>\n                            <input type=\"checkbox\" class=\"mr-2\" id=\"no_maintenance_mode\">\n                            <label for=\"no_maintenance_mode\">Don\\'t activate the Maintenance mode</label>\n                        </div>\n                        <small class=\"form-text text-muted\">\n                            By default, the maintenance mode is enabled when an Update is performed. This prevents the use of TeamPass while the scripts are running.<br />\n                            However, some administrators may prefer to warn the users in another way. Nevertheless, keep in mind that the update process may fail or even be corrupted due to parallel queries.\n                        </small>\n                    </div>\n                </div>\n\n                <div class=\"card card-primary\">\n                    <div class=\"card-header\">\n                        <h5>Database dump</h5>\n                    </div>\n                    <div class=\"card-body\">\n                        <div>\n                            If you have NOT performed a dump of your database, please considere to create one now.\n                        </div>\n                        <div>\n                            <a href=\"#\" onclick=\"launch_database_dump(); return false;\">Launch a new database dump</a>\n                        </div>\n                        <div>\n                            <span id=\"dump_result\" style=\"margin-top:4px;\" class=\"card card-info\"></span>\n                        </div>\n                    </div>\n                </div>\n\n                <!-- teampass_version = 2.1.27 and no encrypt_key in db -->\n                <div class=\"callout card-warning hidden\" id=\"no_encrypt_key\">\n                    <div class=\"card-header\">\n                        <h5>Database Origine</h5>\n                    </div>\n                    <div class=\"card-body\">\n                        <div>\n                            Please select:&nbsp;<select id=\"no_key_selection\">\n                            <option value=\"false\">-- select --</option>\n                            <option value=\"no_previous_sk_sel\">We have never used Teampass in an older version than 2.1.27(.x)</option>\n                            <option value=\"previous_sk_sel\">We have used Teampass in an older version (example: 2.1.26)</option>\n                        </select>\n                        <div id=\"previous_sk_div\" style=\"display:none;\">\n                            <p>Please use the next field to enter the saltkey you used in previous version of Teampass. It can be retrieved by editing sk.php file (in case you are upgrading from a version older than 2.1.27) or a sk.php backup file (in case you are upgrading from 2.1.27).<br>\n                            </p>\n                            <label for=\"previous_sk\">Previous SaltKey:&nbsp</label>\n                            <input type=\"text\" id=\"previous_sk\" size=\"100px\" value=\"'.@$_SESSION['encrypt_key'].'\" />\n                        </div>\n                        </div>\n                    </div>\n                </div>\n\n                <div style=\"margin-top:20px;font-weight:bold;text-align:center;height:27px;\" id=\"res_step2\"></div>\n                <input type=\"hidden\" id=\"step2\" name=\"step2\" value=\"\">\n\n            </div>\n        </div>';\n\n\n// STEP3\n} elseif ((isset($post_step) && $post_step == 3 || isset($_GET['step']) && $_GET['step'] == 3)\n    && isset($post_actual_cpm_version)\n    && intVal($_SESSION['user_granted']) === 1\n) {\n    if (version_compare($post_actual_cpm_version, '2.1.26', '<')) {\n        $conversion_utf8 = true;\n    } else {\n        $conversion_utf8 = false;\n    }\n    echo '\n        <div class=\"card card-primary\">\n            <div class=\"card-header\">\n                <h5>Converting database to UTF-8</h5>\n            </div>\n            <div class=\"card-body\">\n                <div>\n                ', $conversion_utf8 === true ?\n                'Notice that TeamPass is now only using UTF-8 charset.\n                This step will convert the database to this charset.\n                <div>\n                <input type=\"checkbox\" id=\"prefix_before_convert\" class=\"mr-2\"><label for=\"prefix_before_convert\">Save previous tables before converting (prefix \"old_\" will be used)</label>\n                </div>' :\n                'The database is currently using UTF-8 charset <i class=\"fas fa-check-circle fa-lg text-success ml-3\"></i>', '\n                </div>\n            </div>\n        </div>';\n// STEP4\n} elseif ((isset($post_step) && $post_step == 4) || (isset($_GET['step'])\n    && $_GET['step'] == 4)\n    && $_SESSION['user_granted'] === '1'\n) {\n    echo '\n        <div class=\"card card-primary\">\n            <div class=\"card-header\">\n                <h5>Database updates</h5>\n            </div>\n            <div class=\"card-body\">\n                <small class=\"form-text text-muted\">\n                    The database needs to be adapted. This step can take a very long time depending on the data volume and server performance.\n                </small>\n                <div class=\"row card card-primary mt-2\">\n                    <div class=\"card-body col-12 font-weight-light\" id=\"step4_progress\" style=\"overflow-y: scroll; height:400px;\">\n                        Please click the button START.\n                    </div>\n                </div>\n\n                <div class=\"hidden\" id=\"change_pw_encryption\">\n                    <br />\n                    <p><b>Encryption protocol of existing passwords now has to be started. It may take a very long time depending on the data volume and server performance.</b></p>\n                    <p>\n                        <div style=\"display:none;\" id=\"change_pw_encryption_progress\"></div>\n                    </p>\n                    <input type=\"button\" value=\"Click to continue\" id=\"but_encrypt_continu\" onclick=\"newEncryptPw(0);\" />\n                    <input type=\"hidden\" id=\"change_pw_encryption_start\" value=\"\" />\n                    <input type=\"hidden\" id=\"change_pw_encryption_total\" value=\"\" />\n                </div>\n\n                <div style=\"margin-top:20px;font-weight:bold;text-align:center;height:27px;\" id=\"res_step4\"></div>\n                <input type=\"hidden\" id=\"step4\" name=\"step4\" value=\"\">\n            </div>\n        </div>';\n// STEP5\n} elseif ((isset($post_step) && $post_step == 5)\n    || (isset($_GET['step']) && $_GET['step'] == 5)\n    && $_SESSION['user_granted'] === '1'\n) {\n    //ETAPE 5\n    echo '\n        <h4>Finalization</h4>\n        <div>\n            <ul>\n            <li>Regenerate settings.php file <span id=\"step5_settingFile\"></span></li>\n            <li>Anonymize saltkey file <span id=\"step5_saltkeyFile\"></span></li>\n            <li>Generate config file <span id=\"step5_configFile\"></span></li>\n            <li>Generate CSRFP config file <span id=\"step5_csrfpFile\"></span></li>\n            </ul>\n        </div>';\n\n    echo '\n        <div class=\"card card-primary\">\n            <div class=\"card-header\">\n                <h5>Absolute path to SaltKey</h5>\n            </div>\n            <div class=\"card-body\">\n                <small class=\"form-text text-muted\">\n                The SaltKey is stored in a file stored in a folder outside the www folder of your server.\n                </small>\n                <div class=\"mt-4\">\n                    <input type=\"text\" class=\"form-control\" id=\"sk_path\" value=\"', defined('SECUREPATH') === true ? SECUREPATH : '', '\" placeholder=\"Path to folder\">\n                </div>\n            </div>\n        </div>';\n\n    echo '\n        <div class=\"alert alert-info mt-4 hidden\" id=\"res_step5\"></div>';\n} elseif ((isset($post_step) && $post_step == 6)\n    || (isset($_GET['step']) && $_GET['step'] == 6)\n    && $_SESSION['user_granted'] === '1'\n) {\n    //ETAPE 5\n    echo '\n        <h4>Upgrade is now completed</h4>\n        <div class=\"callout callout-info mt-4\">\n            <div>\n                For news, help and information, visit <a href=\"https://teampass.net\" target=\"_blank\" class=\"text-info\">TeamPass website</a>\n            </div>\n        </div>\n        <div class=\"alert alert-primary mt-4\">\n            <i class=\"far fa-lightbulb text-warning mr-2 fa-lg\"></i>It is recommended to clean the cache of your Web Browser before trying to log in.\n        </div>';\n\n    if (version_compare($post_actual_cpm_version, '2.1.27', '<=')) {\n        echo '\n        <div class=\"alert alert-warning mt-4\">\n            <i class=\"fa fa-exclamation-circle text-danger mr-2 fa-lg\"></i>This upgrade was a heavy one. Indeed we have changed the encryption of your data to make them safer now as they don\\'t rely anymore on a key.<br>\n            This forced us to encode your users data with a One-Time-Code that they did receive by email. For any reason, they did not received it, you as an admin, can change it from the users management page.\n        </div>';\n    }\n\n    echo '\n        <div class=\"mt-5\">\n        <a href=\"#\" class=\"btn btn-primary\" onclick=\"javascript:window.location.href=\\'', (isset($_SERVER['HTTPS']) && ($_SERVER['HTTPS'] == 'on' || $_SERVER['HTTPS'] == 1) || isset($_SERVER['HTTP_X_FORWARDED_PROTO']) && $_SERVER['HTTP_X_FORWARDED_PROTO'] == 'https') ? 'https' : 'http', '://'.$_SERVER['HTTP_HOST'].substr($_SERVER['PHP_SELF'], 0, strrpos($_SERVER['PHP_SELF'], '/') - 8).'\\';\"><b>Open TeamPass</b></a>\n        </div>';\n}\n\necho '\n            <div class=\"card-footer\">';\n//buttons\nif (!isset($post_step)) {\n    echo '\n            <input type=\"button\" id=\"but_launch\" data-step=\"step0\" class=\"btn btn-primary\" value=\"START\">\n            <input type=\"button\" id=\"but_next\" data-target=\"1\" style=\"\" class=\"btn btn-primary\" value=\"NEXT\" disabled=\"disabled\">';\n} elseif (intVal($post_step) === 3 && $conversion_utf8 === false && $_SESSION['user_granted'] === '1') {\n    echo '\n            <input type=\"button\" id=\"but_next\" target_id=\"'.(intval($post_step) + 1).'\" class=\"btn btn-primary\" value=\"NEXT\">';\n} elseif (intVal($post_step) === 3 && $conversion_utf8 === true && $_SESSION['user_granted'] === '1') {\n    echo '\n            <input type=\"button\" id=\"but_launch\" data-step=\"step'.$post_step.'\" class=\"btn btn-primary\" value=\"START\">\n            <input type=\"button\" id=\"but_next\" data-target=\"'.(intval($post_step) + 1).'\" class=\"btn btn-primary\" value=\"NEXT\" disabled=\"disabled\">';\n} elseif (intVal($post_step) === 6 && $_SESSION['user_granted'] === '1') {\n    // Nothong to do\n} else {\n    echo '\n            <input type=\"button\" id=\"but_launch\" data-step=\"step'.$post_step.'\" class=\"btn btn-primary\" value=\"START\" />\n            <input type=\"button\" id=\"but_next\" data-target=\"'.(intval($post_step) + 1).'\" class=\"btn btn-primary\" value=\"NEXT\" disabled=\"disabled\">';\n}\n\necho '\n            </div>\n        </div>\n        </form>\n    </div>';\n//FOOTER\necho '\n    <div id=\"footer\">\n        <div style=\"width:500px; font-size:16px;\">\n            '.TP_TOOL_NAME.' '.TP_VERSION_FULL.' &#169; copyright 2009-'.date(\"Y\").'\n        </div>\n        <div style=\"float:right;margin-top:-15px;\">\n        </div>\n    </div>';\n?>\n    </div>\n\n</body>\n</html>\n\n\n<script type=\"text/javascript\" src=\"js/aes.min.js\"></script>\n<!-- jQuery -->\n<script src=\"../plugins/jquery/jquery.min.js\"></script>\n<!-- jQuery -->\n<script src=\"../plugins/jqueryUI/jquery-ui.min.js\"></script>\n<!-- Popper -->\n<script src=\"../plugins/popper/umd/popper.min.js\"></script>\n<!-- Bootstrap -->\n<script src=\"../plugins/bootstrap/js/bootstrap.bundle.min.js\"></script>\n<!-- AdminLTE -->\n<script src=\"../plugins/adminlte/js/adminlte.min.js\"></script>\n<!-- Altertify -->\n<script type=\"text/javascript\" src=\"../plugins/alertifyjs/alertify.min.js\"></script>\n\n\n\n\n<script type=\"text/javascript\">\nvar timeTaken = '';\n\n\n$(function(){\n    // click on button NEXT\n    $(\"#but_next\").click(function(event) {\n        $(\"#step\").val($(this).data(\"target\"));\n        document.install.submit();\n    });\n\n    $(\"#dump_done\").click(function(event) {\n        if($(\"#dump_done\").is(':checked')) {\n            $(\"#but_next\").prop(\"disabled\", false);\n        } else {\n            $(\"#but_next\").prop(\"disabled\", true);\n        }\n    });\n\n    $(\"#no_key_selection\").change(function() {\n        if ($(\"#no_key_selection\").val() === \"no_previous_sk_sel\") {\n            $(\"#previous_sk_div\").hide();\n            $(\"#previous_sk\").val(\"\");\n        } else if ($(\"#no_key_selection\").val() === \"previous_sk_sel\") {\n            $(\"#previous_sk_div\").show();\n        }\n    });\n\n    // click on button START\n    $('#but_launch').click(function(event) {\n        var currentStep = $(this).data('step'),\n            postData = '';\n        // STEP 0\n        if (currentStep === 'step0') {\n            if ($(\"#user_login\").val() === \"\" || $(\"#user_pwd\").val() === \"\") {\n                alertify\n                    .error('<i class=\"fas fa-ban mr-2\">[ERROR] You must provide credentials</i>', 10)\n                    .dismissOthers();\n                return false;\n            }\n\n            postData = {\n                type : currentStep,\n                login : $(\"#user_login\").val(),\n                pwd : window.btoa(aesEncrypt($(\"#user_pwd\").val()))\n            }\n            \n        } else if (currentStep === 'step1') {\n            postData = {\n                type : currentStep,\n                abspath : $(\"#root_path\").val(),\n                fullurl : $(\"#root_url\").val()\n            }\n        } else if (currentStep === 'step2') {\n            postData = {\n                type : currentStep,\n                abspath : $(\"#root_path\").val(),\n                fullurl : $(\"#root_url\").val()\n            }\n        } else if (currentStep === 'step3') {\n            postData = {\n                type : currentStep,\n                abspath : $(\"#root_path\").val(),\n                fullurl : $(\"#root_url\").val(),\n                prefix_before_convert : $('#prefix_before_convert').prop(\"checked\")\n            }\n\n        } else if (currentStep === \"step4\") {\n            upgrade_file = \"\";\n            timeTaken = getTime();\n            manageUpgradeScripts(\"0\");\n            return false;\n\n        } else if (currentStep === \"step5\") {\n            postData = {\n                type : currentStep,\n                url_path : $(\"#url_path\").val()\n            }\n        }\n\n        alertify\n            .message('<i class=\"fas fa-cog fa-spin fa-2x\"></i>', 0)\n            .dismissOthers();\n        $(\"#res_\"+currentStep).html(\"\").addClass(\"hidden\");\n\n        // EXECUTE AJAX REQUEST\n        return $.ajax({\n            url: \"upgrade_ajax.php\",\n            type : \"POST\",\n            dataType : \"json\",\n            async: false,\n            data : postData,\n            complete : function(result, status){\n                //console.log(result.responseText)\n                data = $.parseJSON(result.responseText)[0];\n                console.log(data)\n                // manage error\n                if (data.error !== \"\") {\n                    $(\"#user_granted\").val(\"0\");\n                    $('#but_next').attr('disabled');\n\n                    if (data.info !== \"\") {\n                        $('#res_'+currentStep).html(data.info).removeClass(\"hidden\");\n                    }\n                    alertify\n                        .error('<i class=\"fas fa-exclamation-triangle mr-2\"></i>  '+data.error+'</i>', 5)\n                        .dismissOthers();\n                } else {\n                    $(\"#step\").val(data.index);\n                    $(\"#user_granted\").val(\"1\");\n                    $('#but_next').removeAttr('disabled');\n\n                    // Special\n                    if (currentStep === 'step0') {\n                        $(\"#infotmp\").val(data.info);\n                    } else if (currentStep === 'step1') {\n                        $('#res_step1').html(data.info).removeClass('hidden');\n                    } else if (currentStep === 'step2') {\n                        \n                        $('#res_step2').html(data.info).removeClass('hidden');\n                        $('#cpm_isUTF8').val(data.isUtf8);\n                        if (parseInt(data.isUtf8) === 1) {\n                            $('#step').val(4);\n                            $('#but_next').data('target', \"4\");\n                        }\n                    } else if (currentStep === 'step5') {\n                        $(\"#res_step5\").html(\"Operations are successfully completed.\").removeClass(\"hidden\");\n                        var res = $.parseJSON(atob(data.info));\n                        \n                        $.each(res, function(index, value) {\n                            $('#'+value.id).html(value.html);\n                        });\n                    }\n\n                    // Display\n                    alertify\n                        .success('<i class=\"fas fa-thumbs-up mr-2\">  Done</i>', 5)\n                        .dismissOthers();\n                }\n            }\n        });\n    });\n\n});\n\nfunction aesEncrypt(text)\n{\n    return Aes.Ctr.encrypt(text, \"cpm\", 128);\n}\n\n\nfunction manageUpgradeScripts(file_number)\n{\n    var start_at = 0;\n    var noitems_by_loop = 100;\n    var loop_number = 0;\n\n    if (file_number == 0) {\n        $(\"#step4_progress\").html(\"\");\n        alertify\n            .success('Done', 1)\n            .dismissOthers();\n    }\n\n    request = $.post(\"upgrade_scripts_manager.php\",\n        {\n            file_number : parseInt(file_number)\n        },\n        function(data) {\n            console.log(data[0])\n            // work not finished\n            if (data[0].finish !== \"1\") {\n                // loop\n                runUpdate(data[0].scriptname, data[0].parameter, start_at, noitems_by_loop, loop_number, file_number);\n            }\n            // work finished\n            else {\n                // refresh categories cache\n                rand_number = createRandomId();\n                $(\"#step4_progress\")\n                    .html(\n                        \"<div>\" + getTime() + \" - <span id='user_\"+rand_number+\"'>Performing database update operations ... <i class=\\\"fas fa-cog fa-spin\\\" style=\\\"color:orange\\\"></i></span></div>\"+ \n                        $(\"#step4_progress\").html()\n                    );\n                $.ajax({\n                    url: \"upgrade_ajax.php\",\n                    type : \"POST\",\n                    dataType : \"json\",\n                    async: false,\n                    data : {\n                        type : \"perform_nestedtree_categories_population_3.0.0.18\"\n                    },\n                    complete : function(result, status) {\n                        console.log(\"Tash perform_nestedtree_categories_population_3.0.0.18 DONE\");\n                        $(\"#user_\"+rand_number)\n                            .html('Database update operations done <i class=\"fas fa-thumbs-up\" style=\"color:green\"></i>'); \n                        migrateUsersToV3('step1', '', 'init', createRandomId(), 0, false, false);\n\n                        alertify\n                            .success('Done with initialization phase', 3)\n                            .dismissOthers();\n                    }\n                });\n            }\n        },\n        \"json\"\n    );\n}\n\nvar usersList = [],\n    previousStep = '',\n    usersRestList = [];\n/**\n    * We need to migrate all users\n    * This will change the users encryption and generate a OTC\n    *\n    * @return void\n    */\nfunction migrateUsersToV3(step, data, number, rand_number, loop_start, loop_finished)\n{\n    //console.log(\"> \"+step+\" - Number: \"+number + \" - Previous step: \"+previousStep);\n    //console.log(usersList);\n    var d = new Date(),\n        count_in_loop = <?php echo (int) NUMBER_ITEMS_IN_BATCH;?>,\n        userSteps = {};\n\n\n    // Decode data\n    var newData = '';\n    if (data !== '' && step === 'step1') {\n        newData = JSON.parse(window.atob(data));\n    }\n    //console.log(\"TO DO : \"+step+\" -- \"+number+\" -- \"+loop_start+\" -- \"+loop_finished+\" -- \"+newData.id)\n\n    if (step === 'step1') {\n        userInfo = '';\n        // Show progress to user\n        $(\"#user_\"+rand_number).html(\"User id \" + newData.id + \" done <i class=\\\"fas fa-thumbs-up\\\" style=\\\"color:green\\\"></i>\");\n\n        if (newData !== '') {\n            usersList.push(newData);\n        }\n        //console.log('List of users');\n        //console.log(JSON.stringify(usersList))\n        \n        if (usersRestList.length > 0) {\n            number = usersRestList[0];\n            usersRestList.shift();\n        } else if (number !== 'init') {\n            number = 'end';\n        }\n        //console.log('List of next users');\n        //console.log(JSON.stringify(usersRestList) + \" ; Number = \"+number)\n        \n        rand_number = createRandomId();\n        $(\"#step4_progress\").html(\"<div>\" + getTime() + \" - <span id='user_\"+rand_number+\"'>Treating User account ... <i class=\\\"fas fa-cog fa-spin\\\" style=\\\"color:orange\\\"></i></span></div>\"+ $(\"#step4_progress\").html());\n        // --\n        // --\n    } else {\n        // Prepare array                \n        if (usersList[number] !== undefined) {\n            userSteps = {\n                'step1' : {\n                    'text' : 'Users public / private keys were generated if needed',\n                    'number' : 0,\n                    'start' : 0\n                },\n                'step2' : {\n                    'text' : 'User '+usersList[number].id+' - All ITEMS keys generated',\n                    'number' : 0,\n                    'start' : 0\n                },\n                'step3' : {\n                    'text' : 'User '+usersList[number].id+' - All LOGS keys generated',\n                    'number' : number,\n                    'start' : 0\n                },\n                'step4' : {\n                    'text' : 'User '+usersList[number].id+' - All FIELDS keys generated',\n                    'number' : number,\n                    'start' : 0\n                },\n                'step5' : {\n                    'text' : 'User '+usersList[number].id+' - All SUGGESTIONS keys generated',\n                    'number' : number,\n                    'start' : 0\n                },\n                'step6' : {\n                    'text' : 'User '+usersList[number].id+' - All FILES keys generated',\n                    'number' : number,\n                    'start' : 0\n                },\n                'nextUser' : {\n                    'number' : parseInt(number) + 1,\n                    'start' : 0\n                }\n            };\n        }\n\n        // What strategy to have for next treatment\n        if (previousStep === 'step1') {\n            $(\"#user_\"+rand_number).html(\"Users public / private keys were generated if needed <i class=\\\"fas fa-thumbs-up\\\" style=\\\"color:green\\\"></i>\");\n\n            number = 0;\n            loop_start = 0;\n            // --\n        } else if (previousStep === step) {\n            // IF we are in the same step and we continue\n            $(\"#user_\"+rand_number).html(userSteps[previousStep].text + \" until \" + (loop_start + count_in_loop) + \" done <i class=\\\"fas fa-thumbs-up\\\" style=\\\"color:green\\\"></i>\");\n\n            loop_start += count_in_loop;\n            // --\n        } else if (step !== 'nextUser' && loop_finished === \"true\") {\n            // The loop on current topic is finished but still with same user\n            $(\"#user_\"+rand_number).html(userSteps[previousStep].text + \" <i class=\\\"fas fa-thumbs-up\\\" style=\\\"color:green\\\"></i>\");\n\n            number = userSteps[step].number;\n            loop_start = userSteps[step].start;\n            // --\n        } else if (step === 'nextUser') {\n            // The treatment of current user is finished\n            // Select next user\n            $(\"#user_\"+rand_number)\n                .html(userSteps[previousStep].text + \" <i class=\\\"fas fa-thumbs-up\\\" style=\\\"color:green\\\"></i>\");\n\n            $(\"#user_\"+rand_number).parent()\n                .prepend('<div>' + getTime() +' - User ' + usersList[number].id + ' fully treated <i class=\"fas fa-thumbs-up\" style=\"color:green\"></i></div>');                    \n\n            // Have we handled all users\n            // If not then restart at step2 for next user\n            if ((parseInt(number)+1) < usersList.length) {\n                number = userSteps[step].number;\n                loop_start = userSteps[step].start;\n                step = 'step2';\n            } else {\n                // Prepare list of users to be displayed\n                var htmlUsersList = '<i class=\"fas fa-info-circle mr-2\"></i>You could provide those unique codes to users by your own.<br>'+\n                    '<ul>';\n                $.each(usersList, function(index, user) {\n                    htmlUsersList += '<li>User: '+user.name+' '+user.lastname+' (login: '+user.login+') ; OneTime code: '+user.otp+'</li>'\n                });\n                htmlUsersList += '</ul>';\n\n                // Done\n                $(\"#user_\"+rand_number).parent()\n\t\t\t\t\t.prepend(\n\t\t\t\t\t\t'<div>' + getTime() +' - All keys have been generated for users <i class=\"fas fa-thumbs-up\" style=\"color:green\"></i>'+\n\t\t\t\t\t\t'<br>'+\n\t\t\t\t\t\t'<div type=\"button\" class=\"btn btn-primary btn-sm\" id=\"buttonListOfUsers\">Show/Hide list of users</div>'+\n\t\t\t\t\t\t'<div class=\"hidden alert alert-secondary mt-2\" id=\"htmlListOfUsers\" role=\"alert\">'+htmlUsersList+'</div>'+\n\t\t\t\t\t\t'</div>'\n\t\t\t\t\t);\n\n\t\t\t\t// Act on button click\n\t\t\t\t$(document).on('click', '#buttonListOfUsers', function() { \n\t\t\t\t\tif ($('#htmlListOfUsers').hasClass('hidden') === true) {\n\t\t\t\t\t\t$('#htmlListOfUsers').removeClass('hidden');\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$('#htmlListOfUsers').addClass('hidden');\n\t\t\t\t\t}\n\t\t\t\t});\n\n                console.log(usersList);\n                // Now send passwords\n                console.log(\"Send emails to users from now\");\n                sendPwdToUsers(usersList, true, 0, usersList.length);\n\n                return;\n            }\n        }\n        \n        if (usersList.length === 0 && step === 'step2' && loop_finished === 'true' && number === 0 && loop_start === 0) {\n            /* Unlock this step */\n            document.getElementById(\"but_next\").disabled = \"\";\n            document.getElementById(\"but_launch\").disabled = \"disabled\";\n            \n            $(\"#user_\"+rand_number).parent()\n                .prepend('<div>' + getTime() +' - All steps have been successfully performed <i class=\"fas fa-thumbs-up\" style=\"color:green\"></i></div>'); \n            return;\n        } else {\n            // Show progress\n            rand_number = createRandomId();\n            $(\"#step4_progress\").html(\"<div>\" + getTime() +\" - <span id='user_\"+rand_number+\"'>User \"+usersList[number].id+\" - Creating keys until \"+(loop_start + count_in_loop)+\" ... <i class=\\\"fas fa-cog fa-spin\\\" style=\\\"color:orange\\\"></i></span></div>\"+ $(\"#step4_progress\").html());\n\n            // Prepare user information                \n            userInfo = {\n                'id' : usersList[number].id,\n                'otp' : usersList[number].otp,\n                'public_key' : usersList[number].public_key,\n                'private_key' : usersList[number].private_key,\n                'login' : usersList[number].login,\n                'name' : encode_utf8(usersList[number].name),\n                'lastname' : encode_utf8(usersList[number].lastname),\n            };\n        }\n    }\n    // Migrate if needed all account to new AES encryption\n    //console.log('Posting number = '+number);\n    $.post(\n        \"upgrade_run_3.0.0_users.php\",\n        {\n            step : step,\n            number : number === 'init' ? '' : number,\n            userInfo : window.btoa(unescape(encodeURIComponent(JSON.stringify(userInfo)))),\n            start : loop_start,\n            count_in_loop : count_in_loop,\n            info : $('#infotmp').val(),\n            extra : number === 'end' ? 'all_users_created' : '',\n        },\n        function(data) {\n            //console.log(data[0]);\n            //console.log(JSON.parse(window.atob(data[0].rest)));\n            //console.log(JSON.parse(window.atob(data[0].data)));\n            previousStep = step;\n\n            if (data[0].finish !== \"1\") {\n                // Manage list of users that is provide on number = 0\n                if ((number) === 'init' && step === 'step1') {\n                    if (data[0].rest !== '') {\n                        usersRestList = JSON.parse(window.atob(data[0].rest));\n                    }else {\n                        usersRestList = '';\n                    }\n                    console.log(\"USERLIST = \"+usersRestList);\n                }\n\n                // loop\n                migrateUsersToV3(\n                    data[0].next,\n                    data[0].data,\n                    data[0].number,\n                    rand_number,\n                    loop_start,\n                    data[0].loop_finished\n                );\n            } else {\n                // Done\n                /* Unlock this step */\n                document.getElementById(\"but_next\").disabled = \"\";\n                document.getElementById(\"but_launch\").disabled = \"disabled\";\n            }\n        },\n        \"json\"\n    );\n}\n\n/**\n* \n */\nfunction sendPwdToUsers(usersList, init, cpt, total)\n{\n    var d = new Date();\n\n    // Inform\n    if (init === true) {\n        rand_number = createRandomId();\n        $(\"#step4_progress\").html(\"<div>\" + getTime() +\" - <span id='user_\"+rand_number+\"'>Now sending new users password by email ... \" +\n            \"<i class=\\\"fas fa-cog fa-spin\\\" style=\\\"color:orange\\\"></i><span id='sending_emails_pct' class='ml-3'>0%</span></div>\"+ $(\"#step4_progress\").html());\n    }\n    \n    // Prepare user data to be sent\n    userInfo = {\n        'id' : usersList[0].id,\n        'otp' : usersList[0].otp,\n    };\n    //console.log('Envoi email pour : ');\n    //console.log(userInfo);\n\n    // Remove user from list\n    usersList.shift();\n\n    // Send email for each user\n    $.post(\n        \"upgrade_run_3.0.0_users.php\",\n        {\n            step : 'send_pwd_by_email',\n            userInfo : window.btoa(JSON.stringify(userInfo))\n        },\n        function(data) {\n            //console.log(data);\n            //console.log('----');\n            // Done with sending the user email\n            if (usersList.length === 0) {\n                // all users have received their email\n                $(\"#user_\"+rand_number)\n                    .html(\"Emails were sent <i class=\\\"fas fa-thumbs-up\\\" style=\\\"color:green\\\"></i>\");\n\n                /* Unlock this step */\n                document.getElementById(\"but_next\").disabled = \"\";\n                document.getElementById(\"but_launch\").disabled = \"disabled\";\n                \n                $(\"#user_\"+rand_number).parent()\n                .prepend('<div>' + getTime() +' - All steps have been successfully performed <i class=\"fas fa-thumbs-up\" style=\"color:green\"></i></div>'); \n                \n            } else {\n                // current user received his email\n                // Send to the next one\n                $(\"#sending_emails_pct\").text(Math.round((cpt / total) * 100) + \"%\");\n\n                sendPwdToUsers(usersList, false, cpt++, total);\n            }\n        },\n        \"json\"\n    );\n}\n\nfunction runUpdate (script_file, type_parameter, start_at, noitems_by_loop, loop_number, file_number)\n{\n    var d = new Date(),\n        info = '';\n    loop_number ++;\n    var rand_number = createRandomId();\n\n    $(\"#step4_progress\").html(\"<div>\" + getTime() +\" - <i>\"+script_file+\"</i> - Loop #\"+loop_number+\" <span id='span_\"+rand_number+\"'>is now running ... <i class=\\\"fas fa-cog fa-spin\\\" style=\\\"color:orange\\\"></i></span></div>\"+ $(\"#step4_progress\").html());\n\n    if (type_parameter === 'user_id') {\n        info = $(\"#infotmp\").val();\n    }\n\n    request = $.post(\n        script_file,\n        {\n            type        : type_parameter,\n            start       : start_at,\n            total       : start_at,\n            nb          : noitems_by_loop,\n            session_salt: $(\"#session_salt\").val(),\n            info        : info,\n        },\n        function(data) {\n            console.info(type_parameter)\n            console.log(data)\n            // work not finished\n            if (data[0].finish !== \"1\") {\n                $(\"#span_\"+rand_number).html(\"<i class=\\\"fas fa-thumbs-up\\\" style=\\\"color:green\\\"></i>\")\n                // loop\n                runUpdate(script_file, type_parameter, data[0].next, noitems_by_loop, loop_number, file_number);\n            // is there an error\n            } else if (data[0].finish === \"1\" && data[0].error !== \"\") {\n                $(\"#span_\"+rand_number).html(\"<i class=\\\"fas fa-thumbs-down\\\" style=\\\"color:red\\\"></i>\");\n                $(\"#step4_progress\").html(\"<div style=\\\"margin:15px 0 15px 0; font-style:italic;\\\">\"+getTime() +\" - <b>ERROR</b>: \"+data[0].error+\"</div>\"+ $(\"#step4_progress\").html());\n                $(\"#step4_progress\").html(\"<div>An error occurred. Please check and relaunch.</div>\"+ $(\"#step4_progress\").html());\n            // work finished\n            } else {\n                $(\"#span_\"+rand_number).html(\"<i class=\\\"fas fa-thumbs-up\\\" style=\\\"color:green\\\"></i>\")\n                // continue with next script file\n                file_number ++;\n                manageUpgradeScripts(file_number);\n            }\n        },\n        \"json\"\n    );\n}\n\nfunction newEncryptPw(suggestion)\n{\n    var nb = 20;\n    var start = 0;\n\n    if ($(\"#change_pw_encryption_start\").val() != \"\") {\n        start = $(\"#change_pw_encryption_start\").val();\n    } else {\n        $(\"#change_pw_encryption_progress\").html('Progress: 0% <i class=\"fas fa-cog fa-spin fa-2x\"></i>');\n    }\n    var request = $.post(\"upgrade_ajax.php\",\n        {\n            type        : \"new_encryption_of_pw\",\n            start       : start,\n            total       : $(\"#change_pw_encryption_total\").val(),\n            suggestion  : suggestion,\n            nb          : nb\n        },\n        function(data) {\n            if (data[0].finish != 1 && data[0].finish != \"suggestion\") {\n                // handle re-encryption of passwords in Items table\n                $(\"#change_pw_encryption_start\").val(data[0].next);\n                $(\"#change_pw_encryption_progress\").html('Progress: '+data[0].progress+'% <i class=\"fas fa-cog fa-spin fa-2x\"></i>');\n                if (parseInt(start) < parseInt($(\"#change_pw_encryption_total\").val())) {\n                    newEncryptPw(\"0\");\n                }\n            } else if (data[0].finish == \"suggestion\") {\n                // handle the re-encryption of passwords in suggestion table\n                newEncryptPw(\"1\");\n            } else {\n                // handle finishing\n                $(\"#change_pw_encryption_progress\").html(\"Done\");\n                $(\"#but_encrypt_continu\").hide();\n                /* Unlock this step */\n                document.getElementById(\"but_next\").disabled = \"\";\n                document.getElementById(\"but_launch\").disabled = \"disabled\";\n                document.getElementById(\"res_step4\").innerHTML = \"dataBase has been populated\";\n                document.getElementById(\"loader\").style.display = \"none\";\n            }\n        },\n        \"json\"\n    );\n\n}\n\nfunction launch_database_dump() {\n    alertify\n        .message('<i class=\"fas fa-cog fa-spin fa-2x\"></i>', 0)\n        .dismissOthers();\n\n    request = $.post(\n        \"upgrade_ajax.php\",\n        {\n            type      : \"perform_database_dump\"\n        },\n        function(data) {\n            console.log(data)\n            if (data[0].error !== \"\") {\n                // ERROR\n                $(\"#dump_result\").html(data[0].error);\n\n                alertify\n                    .Error('Error', 1)\n                    .dismissOthers();\n            } else {\n                // DONE\n                $(\"#dump_result\").html('<div class=\"alert alert-info mt-2\">Dump is successfull. File stored in file <b>' + data[0].filename + '</b></div>');\n                $('#but_next').attr(\"disabled\", false);\n                alertify\n                    .success('Success', 1)\n                    .dismissOthers();\n            }\n        },\n        \"json\"\n    );\n}\n\nfunction createRandomId()\n{\n    var randLetter = String.fromCharCode(65 + Math.floor(Math.random() * 26));\n    return randLetter + Date.now();\n}\n\nfunction getTime()\n{\n    var d = new Date();\n    return (\"0\" +d.getHours()).slice(-2)+\":\"+(\"0\" + d.getMinutes()).slice(-2)+\":\"+(\"0\" + d.getSeconds()).slice(-2)\n}\n\nfunction encode_utf8( s )\n{\n  return unescape( encodeURIComponent( s ) );\n}\n\n</script>\n\n"], "fixing_code": ["<?php\n\ndeclare(strict_types=1);\n\n/**\n * Teampass - a collaborative passwords manager.\n * ---\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n * ---\n *\n * @project   Teampass\n * @version   \n * @file      error.php\n * ---\n *\n * @author    Nils Laumaill\u00e9 (nils@teampass.net)\n *\n * @copyright 2009-2023 Teampass.net\n *\n * @license   https://spdx.org/licenses/GPL-3.0-only.html#licenseText GPL-3.0\n * ---\n *\n * @see       https://www.teampass.net\n */\n\nif (file_exists('../sources/SecureHandler.php')) {\n    include_once '../sources/SecureHandler.php';\n} elseif (file_exists('./sources/SecureHandler.php')) {\n    include_once './sources/SecureHandler.php';\n} else {\n    throw new Exception(\"Error file '/sources/SecureHandler.php' not exists\", 1);\n}\nif (isset($_SESSION) === false) {\n    session_name('teampass_session');\n    session_start();\n}\nif (isset($_SESSION['CPM']) === false || $_SESSION['CPM'] !== 1) {\n    die('Hacking attempt...');\n}\n\n// Load config\nif (file_exists('../includes/config/tp.config.php')) {\n    include_once '../includes/config/tp.config.php';\n} elseif (file_exists('./includes/config/tp.config.php')) {\n    include_once './includes/config/tp.config.php';\n} else {\n    throw new Exception(\"Error file '/includes/config/tp.config.php' not exists\", 1);\n}\n\nif (\n    filter_input(INPUT_POST, 'session', FILTER_SANITIZE_STRING) !== null\n    && filter_input(INPUT_POST, 'session', FILTER_SANITIZE_STRING) === 'expired'\n) {\n    //Include files\n    require_once $SETTINGS['cpassman_dir'] . '/includes/config/settings.php';\n    require_once $SETTINGS['cpassman_dir'] . '/includes/config/include.php';\n    require_once $SETTINGS['cpassman_dir'] . '/sources/SplClassLoader.php';\n    require_once $SETTINGS['cpassman_dir'] . '/sources/main.functions.php';\n    // connect to DB\n    require_once $SETTINGS['cpassman_dir'] . '/includes/libraries/Database/Meekrodb/db.class.php';\n    if (defined('DB_PASSWD_CLEAR') === false) {\n        define('DB_PASSWD_CLEAR', defuseReturnDecrypted(DB_PASSWD, $SETTINGS));\n    }\n\n    // Include main functions used by TeamPass\n    require_once 'sources/main.functions.php';\n    // Update table by deleting ID\n    if (isset($_SESSION['user_id'])) {\n        DB::update(\n            DB_PREFIX . 'users',\n            [\n                'key_tempo' => '',\n            ],\n            'id=%i',\n            $_SESSION['user_id']\n        );\n    }\n\n    //Log into DB the user's disconnection\n    if (isset($SETTINGS['log_connections']) && (int) $SETTINGS['log_connections'] === 1) {\n        logEvents($SETTINGS, 'user_connection', 'disconnect', (string) $_SESSION['user_id'], $_SESSION['login']);\n    }\n} else {\n    require_once $SETTINGS['cpassman_dir'] . '/sources/main.queries.php';\n    $errorCode = '';\n    if (@$_SESSION['error']['code'] === ERR_NOT_ALLOWED) {\n        $errorCode = 'ERROR NOT ALLOWED';\n    } elseif (@$_SESSION['error']['code'] === ERR_NOT_EXIST) {\n        $errorCode = 'ERROR NOT EXISTS';\n    } elseif (@$_SESSION['error']['code'] === ERR_SESS_EXPIRED) {\n        $errorCode = 'ERROR SESSION EXPIRED';\n    } elseif (@$_SESSION['error']['code'] === ERR_VALID_SESSION) {\n        $errorCode = 'ERROR NOT ALLOWED';\n    } ?>\n    <!-- Main content -->\n    <section class=\"content\">\n        <div class=\"error-page\" style=\"width:100%;\">\n            <h2 class=\"headline text-danger\">500</h2>\n\n            <div class=\"error-content\">\n                <h3><i class=\"fa fa-warning text-danger\"></i> Oops! <?php echo $errorCode; ?>.</h3>\n\n                <p>\n                    For security reason, you have been disconnected. Click to <a href=\"./includes/core/logout.php?token=\" + <?php echo isset($_SESSION['key']) === true ? $_SESSION['key'] : ''; ?>>log in</a>.\n                </p>\n\n            </div>\n            <!-- /.error-content -->\n        </div>\n        <!-- /.error-page -->\n    </section>\n    <!-- /.content -->\n<?php\n}\n\n// erase session table\n$_SESSION = [];\n// Kill session\nsession_destroy();\ndie;\n?>\n", "<?php\n\ndeclare(strict_types=1);\n\n/**\n * Teampass - a collaborative passwords manager.\n * ---\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n * ---\n *\n * @project   Teampass\n * @version   3.0.0.23\n * @file      load.js.php\n * ---\n *\n * @author    Nils Laumaill\u00e9 (nils@teampass.net)\n *\n * @copyright 2009-2023 Teampass.net\n *\n * @license   https://spdx.org/licenses/GPL-3.0-only.html#licenseText GPL-3.0\n * ---\n *\n * @see       https://www.teampass.net\n */\n\nif (isset($_SESSION['CPM']) === false || (int) $_SESSION['CPM'] !== 1) {\n    die('Hacking attempt...');\n}\n\n// Is maintenance on-going?\nif (\n    isset($SETTINGS['maintenance_mode']) === true\n    && (int) $SETTINGS['maintenance_mode'] === 1\n    && ($session_user_admin === null\n        || (int) $session_user_admin === 1)\n) {\n    ?>\n    <script type=\"text/javascript\">\n        toastr.remove();\n        toastr.info(\n            '<?php echo langHdl('index_maintenance_mode_admin'); ?>',\n            '<?php echo langHdl('information'); ?>', {\n                timeOut: 0\n            }\n        );\n    </script>\n<?php\n}\n?>\n\n<script type=\"text/javascript\">\n    var userScrollPosition = 0,\n        debugJavascript = true;\n    let hourInMinutes = 60;\n\n    /**\n    *   Add 1 hour to session duration\n    **/\n    function IncreaseSessionTime(duration)\n    {\n        duration = duration || hourInMinutes;\n        $.post(\n            'sources/main.queries.php',\n            {\n                type     : 'increase_session_time',\n                type_category: 'action_user',\n                duration : parseInt(duration, 10) * hourInMinutes,\n                key: \"<?php echo $_SESSION['key']; ?>\"\n            },\n            function(data) {\n                if (data[0].new_value !== 'expired') {\n                    $('#temps_restant').val(data[0].new_value);\n                    $('#date_end_session').val(data[0].new_value);\n                    $('#countdown').css('color', 'white');\n                } else {\n                    $(location).attr('href', 'index.php?session=expired');\n                }\n            },\n            'json'\n        );\n    }\n\n    // Start real time\n    // get list of last items\n    if (store.get('teampassUser') !== undefined && parseInt(store.get('teampassUser').user_id) > 0\n        && String('<?php echo $_SESSION['key']; ?>') === store.get('teampassUser').sessionKey\n        && (Date.now() - store.get('teampassUser').sessionStartTimestamp) < (store.get('teampassUser').sessionDuration * 1000)\n    ) {\n        $.when(\n            // Load teampass settings\n            loadSettings()\n        ).then(function() {\n            $.when(\n                // Refresh list of last items shopwn\n                refreshListLastSeenItems()\n            ).then(function() {\n                // Check if new privatekey needs to be adapted\n                var data = {\n                    'user_id': store.get('teampassUser').user_id,\n                    'fields' : 'special, auth_type',\n                }\n                $.post(\n                    \"sources/main.queries.php\", {\n                        type: \"get_user_info\",\n                        type_category: 'action_user',\n                        data: prepareExchangedData(JSON.stringify(data), 'encode', '<?php echo $_SESSION['key']; ?>'),\n                        key: \"<?php echo $_SESSION['key']; ?>\"\n                    },\n                    function(data) {\n                        //decrypt data\n                        data = decodeQueryReturn(data, '<?php echo $_SESSION['key']; ?>');\n                        if (debugJavascript === true) {\n                            console.info('Get user info results:');\n                            console.log(data);\n                        }\n\n                        // update local storage\n                        store.update(\n                            'teampassUser', {},\n                            function(teampassUser) {\n                                teampassUser.special = data.queryResults.special;\n                                teampassUser.auth_type = data.queryResults.auth_type;\n                            }\n                        );\n\n                        if (data.error === false && data.queryResults.special === 'generate-keys') {\n                            // Now we need to perform re-encryption due to LDAP password change\n                            if (debugJavascript === true) console.log('User has to regenerate keys')\n                            // HIde\n                            $('.content-header, .content').addClass('hidden');\n                            $('#dialog-user-temporary-code-info').html('<i class=\"icon fas fa-info mr-2\"></i><?php echo langHdl('renecyption_expected');?>');\n\n                            // Show passwords inputs and form\n                            $('#dialog-user-temporary-code').removeClass('hidden');\n\n                            // ----\n                        } else if (data.error === false && data.queryResults.special === 'auth-pwd-change' && data.queryResults.auth_type === 'local') {\n                            // USer's password has been reseted, he shall change it\n                            if (debugJavascript === true) console.log('User has to change his auth password')\n                            // HIde\n                            $('.content-header, .content').addClass('hidden');\n\n                            // Show passwords inputs and form\n                            $('#dialog-user-change-password-info')\n                                .html('<i class=\"icon fas fa-info mr-2\"></i><?php echo langHdl('user_has_to_change_password_info');?>')\n                                .removeClass('hidden');\n                            $('#dialog-user-change-password').removeClass('hidden');\n\n                        // ----\n                        } else if (data.error === false && data.queryResults.special === 'auth-pwd-change' && data.queryResults.auth_type === 'ldap') {\n                            // USer's password has been reseted, he shall change it\n                            if (debugJavascript === true) console.log('LDAP user password has to change his auth password')\n                            // HIde\n                            $('.content-header, .content').addClass('hidden');\n\n                            // Show passwords inputs and form\n                            $('#dialog-ldap-user-change-password-info')\n                                .html('<i class=\"icon fas fa-info mr-2\"></i><?php echo langHdl('ldap_user_has_changed_his_password');?>')\n                                .removeClass('hidden');\n                            $('#dialog-ldap-user-change-password').removeClass('hidden');\n                            \n                            // ----\n                        } else if (\n                            (data.error === false && data.queryResults.special === 'user_added_from_ldap' && data.queryResults.auth_type === 'ldap')\n                            || (typeof data.queryResults !== 'undefined' && data.queryResults.special === 'otc_is_required_on_next_login')\n                        ) {\n                            // USer's password has been reseted, he shall change it\n                            if (debugJavascript === true) console.log('NEW LDAP user password - we need to encrypt items')\n                            // HIde\n                            $('.content-header, .content').addClass('hidden');\n\n                            // Show form\n                            $('#dialog-ldap-user-build-keys-database').removeClass('hidden');\n                        } else if (typeof data.queryResults !== 'undefined' && data.queryResults.special === 'recrypt-private-key') {\n                            // USer's password has been reseted, he shall change it\n                            if (debugJavascript === true) console.log('NEW LDAP - we need to encrypt private key')\n                            // HIde\n                            $('.content-header, .content').addClass('hidden');\n\n                            // Show form\n                            $('#dialog-ldap-user-change-password').removeClass('hidden');\n                        }\n                    }\n                );\n            }).then(function() {\n                if (store.get('teampassSettings') === undefined || parseInt(store.get('teampassSettings').enable_tasks_manager) === 0) {\n                    console.log('Now sending emails')\n                    setTimeout(\n                        function() {\n                            $.when(\n                                // send email\n                                $.post(\n                                    \"sources/main.queries.php\", {\n                                        type: \"send_waiting_emails\",\n                                        type_category: 'action_mail',\n                                        key: \"<?php echo $_SESSION['key']; ?>\"\n                                    }\n                                )\n                            ).then(function() {\n                                // send statistics\n                                $.post(\n                                    \"sources/main.queries.php\", {\n                                        type: \"sending_statistics\",\n                                        type_category: 'action_system',\n                                        key: \"<?php echo $_SESSION['key']; ?>\"\n                                    }\n                                );\n                            });\n                        },\n                        3000\n                    );\n                }\n\n                // Save user location\n                //console.info(\"DEBUG - Save user location -\"+store.get('teampassUser').location_stored)\n                if (store.get('teampassUser').location_stored !== 1) {\n                // Save user location\n                    $.post(\n                        \"sources/users.queries.php\", {\n                            type: 'save_user_location',\n                            step: \"perform\",\n                            key: \"<?php echo $_SESSION['key']; ?>\"\n                        },\n                        function(data) {\n                            // update local storage\n                            store.update(\n                                'teampassUser', {},\n                                function(teampassUser) {\n                                    teampassUser.location_stored = 1;\n                                }\n                            );\n                        }\n                    );\n                }\n            });\n        });\n    }\n    //-- end\n\n\n    // Countdown\n    countdown();\n\n    $(\".show_hide_password a\").on('click', function(event) {\n        event.preventDefault();\n        if($('.how_hide_password input').attr(\"type\") === \"text\"){\n            $('.show_hide_password input').attr('type', 'password');\n            $('.show_hide_password i').addClass( \"fa-eye-slash\" );\n            $('.show_hide_password i').removeClass( \"fa-eye\" );\n        }else if($('#show_hide_password input').attr(\"type\") === \"password\"){\n            $('.show_hide_password input').attr('type', 'text');\n            $('.show_hide_password i').removeClass( \"fa-eye-slash\" );\n            $('.show_hide_password i').addClass( \"fa-eye\" );\n        }\n    });\n    \n    if (store.get('teampassUser') !== undefined &&\n        store.get('teampassUser').special === 'generate-keys'\n    ) {\n        // Now we need to perform re-encryption due to LDAP password change\n        console.log('User has to regenerate keys')\n        // HIde\n        $('.content-header, .content').addClass('hidden');\n        $('#dialog-user-temporary-code-info').html('<i class=\"icon fas fa-info mr-2\"></i><?php echo langHdl('renecyption_expected');?>');\n\n        // Show passwords inputs and form\n        $('#dialog-user-temporary-code').removeClass('hidden');\n        \n        // ---\n    } else if (store.get('teampassUser') !== undefined &&\n        store.get('teampassUser').special === 'ldap_password_has_changed_do_reencryption'\n    ) {\n        // Now we need to perform re-encryption due to LDAP password change\n        console.log('show password change')\n        // HIde\n        $('.content-header, .content, #button_do_sharekeys_reencryption').addClass('hidden');\n        $('#warning-text-reencryption').html('<i class=\"icon fas fa-info mr-2\"></i>'.langHdl('ldap_password_change_warning'));\n\n        // Show passwords inputs and form\n        $('#dialog-encryption-keys, .ask-for-previous-password').removeClass('hidden');\n\n        $('#sharekeys_reencryption_target_user').val(store.get('teampassUser').user_id);\n\n        $('#button_do_sharekeys_reencryption').removeClass('hidden');\n        \n        // ---\n    } else if (store.get('teampassUser') !== undefined &&\n        store.get('teampassUser').shown_warning_unsuccessful_login === false\n    ) {\n        // If login attempts experimented\n        // Prepare modal\n        showModalDialogBox(\n            '#warningModal',\n            '<i class=\"fas fa-user-shield fa-lg warning mr-2\"></i><?php echo langHdl('caution'); ?>',\n            '<?php echo langHdl('login_attempts_identified_since_last_connection'); ?>',\n            '<?php echo langHdl('see_detail'); ?>',\n            '<?php echo langHdl('cancel'); ?>'\n        );\n\n        // Actions on modal buttons\n        $(document).on('click', '#warningModalButtonClose', function() {\n            store.update(\n                'teampassUser', {},\n                function(teampassUser) {\n                    teampassUser.shown_warning_unsuccessful_login = true;\n                }\n            );\n        });\n        $(document).on('click', '#warningModalButtonAction', function() {\n            // SHow user\n            toastr.remove();\n            toastr.info('<?php echo langHdl('in_progress'); ?><i class=\"fas fa-circle-notch fa-spin fa-2x ml-3\"></i>');\n\n            // Action\n            store.update(\n                'teampassUser', {},\n                function(teampassUser) {\n                    teampassUser.shown_warning_unsuccessful_login = true;\n                }\n            );\n            document.location.href = \"index.php?page=profile&tab=timeline\";\n        });\n    } else if (store.get('teampassUser') !== undefined &&\n        store.get('teampassUser').special === 'private_items_to_encrypt'\n    ) {\n        // If user has to re-encrypt his personal item passwords\n        $('#dialog-encryption-personal-items-after-upgrade').removeClass('hidden');\n        $('.content, .content-header').addClass('hidden');\n        \n        // Actions on modal buttons\n        $(document).on('click', '#button_do_personal_items_reencryption', function() {\n            // SHow user\n            toastr.remove();\n            toastr.info('<?php echo langHdl('in_progress'); ?><i class=\"fas fa-circle-notch fa-spin fa-2x ml-3\"></i>');\n\n            defusePskRemoval(store.get('teampassUser').user_id, 'psk', 0);\n            \n            function defusePskRemoval(userId, step, start)\n            {\n                if (step === 'psk') {\n                    // Inform user\n                    $(\"#user-current-defuse-psk-progress\").html('<b><?php echo langHdl('encryption_keys'); ?> </b> [' + start + ' - ' + (parseInt(start) + <?php echo NUMBER_ITEMS_IN_BATCH;?>) + '] ' +\n                        '... <?php echo langHdl('please_wait'); ?><i class=\"fas fa-spinner fa-pulse ml-3 text-primary\"></i>');\n\n                    var data = {\n                        'userPsk' : $('#user-current-defuse-psk').val(),\n                            'start': start,\n                            'length': <?php echo NUMBER_ITEMS_IN_BATCH;?>,\n                            'user_id': userId,\n                    };\n                    // Do query\n                    $.post(\n                        \"sources/main.queries.php\", {\n                            'type': \"user_psk_reencryption\",\n                            'type_category': 'action_key',\n                            'data': prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                            'key': '<?php echo $_SESSION['key']; ?>'\n                        },\n                        function(data) {\n                            data = prepareExchangedData(data, \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n                            if (debugJavascript === true) console.log(data)\n                            if (data.error === true) {\n                                // error\n                                toastr.remove();\n                                toastr.error(\n                                    data.message,\n                                    '<?php echo langHdl('caution'); ?>', {\n                                        timeOut: 5000,\n                                        progressBar: true\n                                    }\n                                );\n\n                                // Enable buttons\n                                $(\"#user-current-defuse-psk-progress\").html('<?php echo langHdl('provide_current_psk_and_click_launch'); ?>');\n                                $('#button_do_sharekeys_reencryption, #button_close_sharekeys_reencryption').removeAttr('disabled');\n                                return false;\n                            } else {\n                                // Start looping on all steps of re-encryption\n                                defusePskRemoval(data.userId, data.step, data.start);\n                            }\n                        }\n                    );\n                } else {\n                    // Finished\n                    $(\"#user-current-defuse-psk-progress\").html('<i class=\"fas fa-check text-success mr-3\"></i><?php echo langHdl('done'); ?>');\n\n                    toastr.remove();\n                }\n            }\n\n        });\n        $(document).on('click', '#button_close_personal_items_reencryption', function() {\n            $('#dialog-encryption-personal-items-after-upgrade').addClass('hidden');\n            $('.content, .content-header').removeClass('hidden');\n        });\n    }\n\n\n    // Show tooltips\n    $('.infotip').tooltip();\n\n    // Sidebar redirection\n    $('.nav-link').click(function() {\n        if ($(this).data('name') !== undefined) {\n            //NProgress.start();\n            document.location.href = \"index.php?page=\" + $(this).data('name');\n        }\n    });\n\n    // User menu action\n    $('.user-menu').click(function() {\n        if ($(this).data('name') !== undefined) {\n            if ($(this).data('name') === 'increase_session') {\n                showExtendSession();\n            } else if ($(this).data('name') === 'sync-new-ldap-password') {\n                // This case permits to handle a case where user has changed his password in LDAP\n                console.log('show sync-new-ldap-password')\n                \n                if (debugJavascript === true) console.log('LDAP user password has to change his auth password')\n                // HIde\n                $('.content-header, .content').addClass('hidden');\n\n                // Show passwords inputs and form\n                $('#dialog-ldap-user-change-password-info')\n                    .html('<i class=\"icon fas fa-info mr-2\"></i><?php echo langHdl('ldap_user_has_changed_his_password');?>')\n                    .removeClass('hidden');\n                $('#dialog-ldap-user-change-password').removeClass('hidden');\n\n                // ----\n            } else if ($(this).data('name') === 'password-change') {\n                console.log('show password change')\n                // HIde\n                $('.content-header, .content, #button_do_user_change_password').addClass('hidden');\n\n                // Add DoCheck button\n                $('#button_do_user_change_password').after('<button class=\"btn btn-primary\" id=\"button_do_pwds_checks\"><?php echo langHdl('perform_checks'); ?></button>');\n\n                // Show passwords inputs and form\n                $('#dialog-user-change-password-progress').html('<i class=\"icon fas fa-info mr-2\"></i><?php echo langHdl('change_your_password_info_message'); ?>');\n                $('#dialog-user-change-password').removeClass('hidden');\n\n                // Actions\n                $('#button_do_pwds_checks').click(function() {\n                    if ($('#profile-password').val() !== $('#profile-password-confirm').val()) {\n                        $('#button_do_user_change_password').addClass('hidden');\n                        toastr.remove();\n                        toastr.error(\n                            '<?php echo langHdl('passwords_not_the_same'); ?>',\n                            '<?php echo langHdl('caution'); ?>', {\n                                timeOut: 3000,\n                                progressBar: true\n                            }\n                        );\n                    } else if (parseInt($('#profile-password-complex').val()) >= parseInt(store.get('teampassSettings').personal_saltkey_security_level)) {\n                        $('#button_do_user_change_password').removeClass('hidden');\n                        $('#button_do_pwds_checks').remove();\n                        toastr.remove();\n                        toastr.info(\n                            '<?php echo langHdl('hit_launch_to_start'); ?>',\n                            '<?php echo langHdl('ready_to_go'); ?>', {\n                                timeOut: 3000,\n                                progressBar: true\n                            }\n                        );\n                    } else {\n                        $('#button_do_user_change_password').addClass('hidden');\n                        toastr.remove();\n                        toastr.error(\n                            '<?php echo langHdl('complexity_level_not_reached'); ?>',\n                            '<?php echo langHdl('caution'); ?>', {\n                                timeOut: 5000,\n                                progressBar: true\n                            }\n                        );\n                    }\n                });\n                // ----\n            } else if ($(this).data('name') === 'profile') {\n                // Show profile page\n                document.location.href = \"index.php?page=profile\";\n            } else if ($(this).data('name') === 'logout') {\n                // Logout directly to login form\n                window.location.href = \"./includes/core/logout.php?token=<?php echo $_SESSION['key']; ?>\";\n            }\n        }\n    });\n\n    $('.close-element').click(function() {\n        $(this).closest('.card').addClass('hidden');\n\n        $('.content-header, .content').removeClass('hidden');\n    });\n\n    /**\n     * When clicking save Personal saltkey\n     */\n    /*\n    $('#button_save_user_psk').click(function() {\n        toastr.remove();\n        toastr.info(\n            '<?php echo langHdl('in_progress'); ?><i class=\"fas fa-circle-notch fa-spin fa-2x ml-3\"></i>'\n        );\n\n        // Prepare data\n        var data = {\n            \"psk\": sanitizeString($(\"#user_personal_saltkey\").val()),\n            \"complexity\": $(\"#psk_strength_value\").val()\n        };\n\n        //\n        $.post(\n            \"sources/main.queries.php\", {\n                type: \"store_personal_saltkey\",\n                data: prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                key: '<?php echo $_SESSION['key']; ?>'\n            },\n            function(data) {\n                data = prepareExchangedData(data, '<?php echo $_SESSION['key']; ?>');\n\n                // Is there an error?\n                if (data.error === true) {\n                    toastr.remove();\n                    toastr.error(\n                        '<?php echo langHdl('warning'); ?>',\n                        '<?php echo langHdl('caution'); ?>', {\n                            timeOut: 5000,\n                            progressBar: true\n                        }\n                    );\n                } else {\n                    store.update(\n                        'teampassUser',\n                        function(teampassUser) {\n                            teampassUser.pskDefinedInDatabase = 1;\n                        }\n                    )\n\n                    store.update(\n                        'teampassUser',\n                        function(teampassUser) {\n                            teampassUser.pskSetForSession = data.encrypted_psk;\n                        }\n                    )\n\n                    toastr.remove();\n                    toastr.success(\n                        '<?php echo langHdl('alert_page_will_reload'); ?>'\n                    );\n\n                    location.reload();\n                }\n            }\n        );\n    });\n    */\n\n    // For Personal Saltkey\n    $(\"#profile-password\").simplePassMeter({\n        \"requirements\": {},\n        \"container\": \"#profile-password-strength\",\n        \"defaultText\": \"<?php echo langHdl('index_pw_level_txt'); ?>\",\n        \"ratings\": [{\n                \"minScore\": 0,\n                \"className\": \"meterFail\",\n                \"text\": \"<?php echo langHdl('complex_level0'); ?>\"\n            },\n            {\n                \"minScore\": 25,\n                \"className\": \"meterWarn\",\n                \"text\": \"<?php echo langHdl('complex_level1'); ?>\"\n            },\n            {\n                \"minScore\": 50,\n                \"className\": \"meterWarn\",\n                \"text\": \"<?php echo langHdl('complex_level2'); ?>\"\n            },\n            {\n                \"minScore\": 60,\n                \"className\": \"meterGood\",\n                \"text\": \"<?php echo langHdl('complex_level3'); ?>\"\n            },\n            {\n                \"minScore\": 70,\n                \"className\": \"meterGood\",\n                \"text\": \"<?php echo langHdl('complex_level4'); ?>\"\n            },\n            {\n                \"minScore\": 80,\n                \"className\": \"meterExcel\",\n                \"text\": \"<?php echo langHdl('complex_level5'); ?>\"\n            },\n            {\n                \"minScore\": 90,\n                \"className\": \"meterExcel\",\n                \"text\": \"<?php echo langHdl('complex_level6'); ?>\"\n            }\n        ]\n    });\n    $(\"#profile-password\").bind({\n        \"score.simplePassMeter\": function(jQEvent, score) {\n            $(\"#profile-password-complex\").val(score);\n        }\n    }).change({\n        \"score.simplePassMeter\": function(jQEvent, score) {\n            $(\"#profile-password-complex\").val(score);\n        }\n    });\n\n    // Hide sidebar footer icons when reducing sidebar\n    $('a[data-widget=\"pushmenu\"]').click(function(event) {\n        if ($('#sidebar-footer').hasClass('hidden') === true) {\n            setTimeout(function() {\n                $('#sidebar-footer').removeClass('hidden');\n            }, 300);\n        } else {\n            $('#sidebar-footer').addClass('hidden');\n        }\n    });\n\n\n    var clipboardCopy = new ClipboardJS(\".clipboard-copy\", {\n        text: function(trigger) {\n            var elementId = $(trigger).data('clipboard-text');\n            if (debugJavascript === true) console.log($('#' + elementId).val())\n            return String($('#' + elementId).val());\n        }\n    });\n\n    clipboardCopy.on('success', function(e) {\n        toastr.remove();\n        toastr.info(\n            '<?php echo langHdl('copy_to_clipboard'); ?>',\n            '<?php echo langHdl('information'); ?>', {\n                timeOut: 2000\n            }\n        );\n    });\n\n    // Progress bar\n    setTimeout(\n        function() {\n            $(\".fade\").removeClass(\"out\");\n        },\n        1000\n    );\n\n\n    /**\n    * USER HAS DECIDED TO CHANGE HIS AUTH PASSWORD\n     */\n    $(document).on('click', '#dialog-user-change-password-do', function() {\n        // Start by changing the user password and send it by email\n        if ($('#profile-password-confirm').val() !== $('#profile-password').val()) {\n            // Show error\n            toastr.remove();\n            toastr.error(\n                '<?php echo langHdl('index_pw_error_identical'); ?>',\n                '<?php echo langHdl('caution'); ?>', {\n                    timeOut: 5000,\n                    progressBar: true\n                }\n            );\n            return false;\n        }\n        if ($('#profile-current-password').val() !== \"\" && $('#profile-password').val() !== \"\" && $('#profile-password-confirm').val() !== \"\") {\n            // Case where a user is changing his authentication password\n            console.log('Reencryption based upon user decision to change his auth password');\n\n            // Show progress\n            $('#dialog-user-change-password-progress').html('<b><?php echo langHdl('please_wait'); ?></b><i class=\"fas fa-spinner fa-pulse ml-3 text-primary\"></i>');\n            toastr.remove();\n            toastr.info(\n                '<?php echo langHdl('in_progress'); ?><i class=\"fas fa-circle-notch fa-spin fa-2x ml-3\"></i>'\n            );\n            \n            // Disable buttons\n            $('#dialog-user-change-password-do, #dialog-user-change-password-close').attr('disabled', 'disabled');\n            \n            data = {\n                'user_id': store.get('teampassUser').user_id,\n                'old_password': $('#profile-current-password').val(),\n                'new_password': $('#profile-password').val(),\n            }\n            if (debugJavascript === true) console.log(data);\n\n            // Check user current password\n            // and change the password\n            // and use the password to re-encrypt the privatekey\n            $.post(\n                'sources/main.queries.php', {\n                    type: 'change_user_auth_password',\n                    type_category: 'action_password',\n                    data: prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                    key: \"<?php echo $_SESSION['key']; ?>\"\n                },\n                function(data) {\n                    data = prepareExchangedData(data, 'decode', '<?php echo $_SESSION['key']; ?>');\n                    if (debugJavascript === true) console.log(data);\n\n                    if (data.error !== false) {\n                        // Show error\n                        toastr.remove();\n                        toastr.error(\n                            data.message,\n                            '<?php echo langHdl('caution'); ?>', {\n                                timeOut: 5000,\n                                progressBar: true\n                            }\n                        );\n\n                        $(\"#dialog-user-change-password-progress\").html('<?php echo langHdl('fill_in_fields_and_hit_launch'); ?>');\n\n                        // Enable buttons\n                        $('#dialog-user-change-password-do, #dialog-user-change-password-close').removeAttr('disabled');\n                    } else {\n                        // SUCCESS\n                        $('#dialog-user-change-password-close').removeAttr('disabled');\n                        toastr.remove();\n                        toastr.success(\n                            data.message,\n                            '<?php echo langHdl('success'); ?>', {\n                                timeOut: 5000,\n                                progressBar: true\n                            }\n                        );\n                        $(\"#dialog-user-change-password-progress\").html('');\n                        $('#dialog-user-change-password').addClass('hidden');\n                        $('.content-header, .content').removeClass('hidden');\n                    }\n                }\n            );\n        } else {\n            // Show error\n            toastr.remove();\n            toastr.error(\n                '<?php echo langHdl('password_cannot_be_empty'); ?>',\n                '<?php echo langHdl('caution'); ?>', {\n                    timeOut: 5000,\n                    progressBar: true\n                }\n            );\n        }\n    });\n    $(document).on('click', '#dialog-user-change-password-close', function() {\n        // HIde\n        $('.content-header, .content').removeClass('hidden');\n\n        // SHow form\n        $('#dialog-user-change-password, #dialog-user-change-password-info').addClass('hidden');\n    });\n    \n\n    /**\n    * ADMIN HAS DECIDED TO CHANGE THE USER'S AUTH PASSWORD\n     */\n    $(document).on('click', '#dialog-admin-change-user-password-do', function() {\n        // When an admin changes the user auth password\n        console.log('Reencryption based upon admin decision to change user auth password');\n\n        // Show progress\n        $('#dialog-admin-change-user-password-progress').html('<b><?php echo langHdl('please_wait'); ?></b><i class=\"fas fa-spinner fa-pulse ml-3 text-primary\"></i>');\n        toastr.remove();\n        toastr.info(\n            '<?php echo langHdl('in_progress'); ?><i class=\"fas fa-circle-notch fa-spin fa-2x ml-3\"></i>'\n        );\n        \n        // Disable buttons\n        $('#dialog-admin-change-user-password-do, #dialog-admin-change-user-password-close').attr('disabled', 'disabled');            \n        \n        // ENsure we have a user id\n        if ($('#admin_change_user_password_target_user').val() !== '') {\n            // Case where change is for user's account\n            data = {\n                'user_id': $('#admin_change_user_password_target_user').val(),\n                'special': 'auth-pwd-change',\n                'password': '',\n                'self_change': false,\n            }\n            //console.log(data);\n            \n            $.post(\n                'sources/main.queries.php', {\n                    type: 'initialize_user_password',\n                    type_category: 'action_password',\n                    data: prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                    key: \"<?php echo $_SESSION['key']; ?>\"\n                },\n                function(data) {\n                    data = prepareExchangedData(data, 'decode', '<?php echo $_SESSION['key']; ?>');\n                    if (debugJavascript === true) console.log(data)\n                    store.set(\n                        'teampassUser', {\n                            admin_user_password: data.user_pwd,\n                            admin_user_email: data.user_email,\n                        }\n                    );\n\n                    if (data.error !== false) {\n                        // Show error\n                        toastr.remove();\n                        toastr.error(\n                            data.message,\n                            '<?php echo langHdl('caution'); ?>', {\n                                timeOut: 5000,\n                                progressBar: true\n                            }\n                        );\n\n                        // Enable buttons\n                        $('#dialog-admin-change-user-password-do, #dialog-admin-change-user-password-close').removeAttr('disabled');\n                    } else {\n                        // Inform user\n                        userShareKeysReencryption(\n                            $('#admin_change_user_password_target_user').val(),\n                            false,\n                            'dialog-admin-change-user-password'\n                        );\n                    }\n                }\n            );\n        }\n    });\n    $(document).on('click', '#dialog-admin-change-user-password-close', function() {\n        // HIde\n        $('.content-header, .content').removeClass('hidden');\n\n        // SHow form\n        $('#dialog-admin-change-user-password').addClass('hidden');\n    });\n    \n    $(document).on('click', '.temp-button', function() {\n        \n        if ($(this).data('action') === \"show-user-pwd\") {\n            // show password\n            $('#temp-user-pwd').attr('type', 'text');\n            $(this).prop( \"disabled\", true );\n            setTimeout(\n                () => {\n                    $('#temp-user-pwd').attr('type', 'hidden');\n                    $(this).prop( \"disabled\", false );\n                },\n                5000\n            );\n        } else if ($(this).data('action') === \"send-user-pwd\") {\n            // Send email\n            console.log('Preparing for email sending');\n            \n            // Prepare data\n            var data = {\n                'receipt': $('#temp-user-email').val(),\n                'subject': '[Teampass] <?php echo langHdl('your_new_password');?>',\n                'body': '<?php echo langHdl('email_body_temporary_login_password');?>',\n                'pre_replace' : {\n                    '#enc_code#' : $('#temp-user-pwd').val(),\n                }\n            }\n            if (debugJavascript === true) console.log(data);\n            // Prepare form\n            $('#dialog-admin-change-user-password-info').html('<?php echo langHdl('sending_email_message');?>');\n            toastr.remove();\n            toastr.info(\n                '<?php echo langHdl('in_progress'); ?><i class=\"fas fa-circle-notch fa-spin fa-2x ml-3\"></i>'\n            );\n\n            // Launch action\n            $.post(\n                'sources/main.queries.php', {\n                    type: 'mail_me',\n                    type_category: 'action_mail',\n                    data: prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                    key: '<?php echo $_SESSION['key']; ?>'\n                },\n                function(data) {\n                    data = prepareExchangedData(data, 'decode', '<?php echo $_SESSION['key']; ?>');\n                    if (debugJavascript === true) console.log(data);\n                    if (data.error !== false) {\n                        // Show error\n                        toastr.remove();\n                        toastr.error(\n                            data.message,\n                            '', {\n                                timeOut: 5000,\n                                progressBar: true\n                            }\n                        );\n                    } else {\n                        // Fianlize UI\n\n                        $('#dialog-admin-change-user-password-info').html('');\n                        $('#dialog-admin-change-user-password-do, #dialog-admin-change-user-password-close').removeAttr('disabled');\n\n                        // HIde\n                        $('.content-header, .content').removeClass('hidden');\n\n                        // SHow form\n                        $('#dialog-admin-change-user-password').addClass('hidden');\n\n                        store.set(\n                            'teampassUser', {\n                                admin_user_password: '',\n                                admin_user_email: '',\n                            }\n                        );\n                        \n                        // Inform user\n                        toastr.remove();\n                        toastr.success(\n                            '<?php echo langHdl('done'); ?>',\n                            '', {\n                                timeOut: 1000\n                            }\n                        );\n                    }\n                }\n            );\n        }        \n    });\n    \n\n    /**\n    * USER PROVIDES HIS TEMPORARY CODE TO\n     */\n    $(document).on('click', '#dialog-user-temporary-code-do', function() {\n        // Perform a renecryption based upon a temporary code\n        console.log('Reencryption based upon users temporary code');\n\n        // Show progress\n        $('#dialog-user-temporary-code-progress').html('<b><?php echo langHdl('please_wait'); ?></b><i class=\"fas fa-spinner fa-pulse ml-3 text-primary\"></i>');\n        toastr.remove();\n        toastr.info(\n            '<?php echo langHdl('in_progress'); ?><i class=\"fas fa-circle-notch fa-spin fa-2x ml-3\"></i>'\n        );\n        \n        // Disable buttons\n        $('#dialog-user-temporary-code-do, #dialog-user-temporary-code-close').attr('disabled', 'disabled');            \n        \n        // Start by testing if the temporary code is correct to decrypt an item\n        data = {\n            'user_id': store.get('teampassUser').user_id,\n            'password': $('#dialog-user-temporary-code-value').val(),\n        }\n        if (debugJavascript === true) console.log(data);\n        $.post(\n            'sources/main.queries.php', {\n                type: 'test_current_user_password_is_correct',\n                type_category: 'action_password',\n                data: prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                key: \"<?php echo $_SESSION['key']; ?>\"\n            },\n            function(data) {\n                data = prepareExchangedData(data, 'decode', '<?php echo $_SESSION['key']; ?>');\n                if (debugJavascript === true) console.log(data);\n\n                if (data.error !== false) {\n                    // Show error\n                    toastr.remove();\n                    toastr.error(\n                        data.message,\n                        '<?php echo langHdl('caution'); ?>', {\n                            timeOut: 5000,\n                            progressBar: true\n                        }\n                    );\n\n                    $(\"#dialog-user-temporary-code-progress\").html('<?php echo langHdl('fill_in_fields_and_hit_launch'); ?>');\n\n                    // Enable buttons\n                    $('#dialog-user-temporary-code-do, #dialog-user-temporary-code-close').removeAttr('disabled');\n                } else {\n                    // Change privatekey encryption with user-s password\n                    data = {\n                        'user_id': store.get('teampassUser').user_id,\n                        'current_code': $('#dialog-user-temporary-code-current-password').val(),\n                        'new_code': $('#dialog-user-temporary-code-value').val(),\n                        'action_type' : 'encrypt_privkey_with_user_password',\n                    }\n                    if (debugJavascript === true) console.log(data);\n                    \n                    $.post(\n                        'sources/main.queries.php', {\n                            type: 'change_private_key_encryption_password',\n                            type_category: 'action_key',\n                            data: prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                            key: \"<?php echo $_SESSION['key']; ?>\"\n                        },\n                        function(data) {\n                            data = prepareExchangedData(data, 'decode', '<?php echo $_SESSION['key']; ?>');\n                            if (debugJavascript === true) console.log(data);\n\n                            if (data.error !== false) {\n                                // Show error\n                                toastr.remove();\n                                toastr.error(\n                                    data.message,\n                                    '<?php echo langHdl('caution'); ?>', {\n                                        timeOut: 5000,\n                                        progressBar: true\n                                    }\n                                );\n\n                                // Enable buttons\n                                $('#dialog-user-temporary-code-do, #dialog-user-temporary-code-close').removeAttr('disabled');\n                            } else {\n                                // Inform user\n                                // Enable close button\n                                $('#dialog-user-temporary-code-close').removeAttr('disabled');\n                                $('#dialog-user-temporary-code-do').attr('disabled', 'disabled');\n\n                                // Finished\n                                $(\"#dialog-user-temporary-code-progress\").html('<i class=\"fas fa-check text-success mr-3\"></i><?php echo langHdl('done'); ?>');\n                                toastr.remove();\n\n                                store.update(\n                                    'teampassUser', {},\n                                    function(teampassUser) {\n                                        teampassUser.special = 'none';\n                                    }\n                                );\n                            }\n                        }\n                    );\n                }\n            }\n        );\n    });\n    $(document).on('click', '#dialog-user-temporary-code-close', function() {\n        // HIde\n        $('.content-header, .content').removeClass('hidden');\n\n        // SHow form\n        $('#dialog-user-temporary-code').addClass('hidden');\n    });\n\n\n    /**\n    * NEW LDAP USER HAS TO BUILD THE ITEMS DATABASE\n     */\n    $(document).on('click', '#dialog-ldap-user-build-keys-database-do', function() {\n        if ($('#dialog-ldap-user-build-keys-database-code').val() === '') {\n\n            return false;\n        }\n        // Perform a renecryption based upon a temporary code\n        console.log('Building items keys database for new LDAP user');\n\n        // Show progress\n        $('#dialog-ldap-user-build-keys-database-progress').html('<b><?php echo langHdl('please_wait'); ?></b><i class=\"fas fa-spinner fa-pulse ml-3 text-primary\"></i>');\n        toastr.remove();\n        toastr.info(\n            '<?php echo langHdl('in_progress'); ?><i class=\"fas fa-circle-notch fa-spin fa-2x ml-3\"></i>'\n        );\n        \n        // Disable buttons\n        $('#dialog-ldap-user-build-keys-database-do, #dialog-ldap-user-build-keys-database-close').attr('disabled', 'disabled');            \n        \n        // Start by testing if the temporary code is correct to decrypt an item\n        data = {\n            'user_id': store.get('teampassUser').user_id,\n            'password' : $('#dialog-ldap-user-build-keys-database-code').val(),\n        }\n        if (debugJavascript === true) console.log(data);\n\n        $.post(\n            'sources/main.queries.php', {\n                type: 'test_current_user_password_is_correct',\n                type_category: 'action_password',\n                data: prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                key: \"<?php echo $_SESSION['key']; ?>\"\n            },\n            function(data) {\n                data = prepareExchangedData(data, 'decode', '<?php echo $_SESSION['key']; ?>');\n                if (debugJavascript === true) console.log(data);\n\n                if (data.error !== false) {\n                    // Show error\n                    toastr.remove();\n                    toastr.error(\n                        data.message,\n                        '<?php echo langHdl('caution'); ?>', {\n                            timeOut: 5000,\n                            progressBar: true\n                        }\n                    );\n\n                    $(\"#dialog-ldap-user-build-keys-database-progress\").html('<?php echo langHdl('bad_code'); ?>');\n\n                    // Enable buttons\n                    $('#dialog-ldap-user-build-keys-database-do, #dialog-ldap-user-build-keys-database-close').removeAttr('disabled');\n                } else {\n                    // Change privatekey encryption with user-s password\n                    data = {\n                        'user_id': store.get('teampassUser').user_id,\n                        'current_code': $('#dialog-ldap-user-build-keys-database-code').val(),\n                        'new_code': '',\n                        'action_type' : '',\n                    }\n                    if (debugJavascript === true) console.log(data);\n                    \n                    $.post(\n                        'sources/main.queries.php', {\n                            type: 'change_private_key_encryption_password',\n                            type_category: 'action_key',\n                            data: prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                            key: \"<?php echo $_SESSION['key']; ?>\"\n                        },\n                        function(data) {\n                            data = prepareExchangedData(data, 'decode', '<?php echo $_SESSION['key']; ?>');\n                            if (debugJavascript === true) console.log(data);\n\n                            if (data.error !== false) {\n                                // Show error\n                                toastr.remove();\n                                toastr.error(\n                                    data.message,\n                                    '<?php echo langHdl('caution'); ?>', {\n                                        timeOut: 5000,\n                                        progressBar: true\n                                    }\n                                );\n\n                                \n                                $(\"#dialog-ldap-user-build-keys-database-progress\").html('<i class=\"fas fa-exclamation-circle text-danger mr-3\"></i><?php echo langHdl('bad_code'); ?>');\n\n                                // Enable buttons\n                                $('#dialog-ldap-user-build-keys-database-do, #dialog-ldap-user-build-keys-database-close').removeAttr('disabled');\n                            } else {\n                                // Inform user\n                                // Enable close button\n                                $('#dialog-ldap-user-build-keys-database-close').removeAttr('disabled');\n                                $('#dialog-ldap-user-build-keys-database-do').attr('disabled', 'disabled');\n\n                                // Finished\n                                $(\"#dialog-ldap-user-build-keys-database-progress\").html('<i class=\"fas fa-check text-success mr-3\"></i><?php echo langHdl('done'); ?>');\n                                toastr.remove();\n\n                                store.update(\n                                    'teampassUser', {},\n                                    function(teampassUser) {\n                                        teampassUser.special = 'none';\n                                    }\n                                );\n\n                                // refresh the page\n                                window.location.href = 'index.php?page=items';\n                            }\n                        }\n                    );\n                }\n            }\n        );\n\n\n\n\n        /*\n        // Inform user\n        userShareKeysReencryption(\n            store.get('teampassUser').user_id,\n            true,\n            'dialog-ldap-user-build-keys-database'\n        );*/\n    });\n    $(document).on('click', '#dialog-user-temporary-code-close', function() {\n        // HIde\n        $('.content-header, .content').removeClass('hidden');\n\n        // SHow form\n        $('#dialog-user-temporary-code').addClass('hidden');\n    });\n\n\n    /**\n    * USER PASSWORD IN LDAP HAS CHANGED\n    */\n    $(document).on('click', '#dialog-ldap-user-change-password-do', function() {\n        // Start by changing the user password and send it by email\n        if ($('#dialog-ldap-user-change-password-old').val() !== \"\" && $('#dialog-ldap-user-change-password-current').val() !== \"\") {\n            // Case where a user is changing his authentication password\n            console.log('Reencryption based upon user auth password changed in LDAP');\n\n            // Show progress\n            $('#dialog-ldap-user-change-password-progress').html('<b><?php echo langHdl('please_wait'); ?></b><i class=\"fas fa-spinner fa-pulse ml-3 text-primary\"></i>');\n            toastr.remove();\n            toastr.info(\n                '<?php echo langHdl('in_progress'); ?><i class=\"fas fa-circle-notch fa-spin fa-2x ml-3\"></i>'\n            );\n            \n            // Disable buttons\n            $('#dialog-ldap-user-change-password-do, #dialog-ldap-user-change-password-close').attr('disabled', 'disabled');\n            \n            data = {\n                'user_id': store.get('teampassUser').user_id,\n                'previous_password': $('#dialog-ldap-user-change-password-old').val(),\n                'current_password': $('#dialog-ldap-user-change-password-current').val(),\n            }\n            if (debugJavascript === true) console.log(data);\n\n            // Check user current password\n            // and change the password\n            // and use the password to re-encrypt the privatekey\n            $.post(\n                'sources/main.queries.php', {\n                    type: 'change_user_ldap_auth_password',\n                    type_category: 'action_password',\n                    data: prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                    key: \"<?php echo $_SESSION['key']; ?>\"\n                },\n                function(data) {\n                    data = prepareExchangedData(data, 'decode', '<?php echo $_SESSION['key']; ?>');\n                    if (debugJavascript === true) console.log(data);\n\n                    if (data.error !== false) {\n                        // Show error\n                        toastr.remove();\n                        toastr.error(\n                            data.message,\n                            '<?php echo langHdl('caution'); ?>', {\n                                timeOut: 5000,\n                                progressBar: true\n                            }\n                        );\n\n                        $(\"#dialog-ldap-user-change-password-progress\").html('<?php echo langHdl('fill_in_fields_and_hit_launch'); ?>');\n\n                        // Enable buttons\n                        $('#dialog-ldap-user-change-password-do, #dialog-ldap-user-change-password-close').removeAttr('disabled');\n                    } else {\n                        // SUCCESS\n                        $('#dialog-ldap-user-change-password-close').removeAttr('disabled');\n                        toastr.remove();\n                        toastr.success(\n                            data.message,\n                            '<?php echo langHdl('success'); ?>', {\n                                timeOut: 5000,\n                                progressBar: true\n                            }\n                        );\n                        $(\"#dialog-ldap-user-change-password-progress\").html('');\n                    }\n                }\n            );\n        } else {\n            // Show error\n            toastr.remove();\n            toastr.error(\n                '<?php echo langHdl('password_cannot_be_empty'); ?>',\n                '<?php echo langHdl('caution'); ?>', {\n                    timeOut: 5000,\n                    progressBar: true\n                }\n            );\n        }\n    });\n    $(document).on('click', '#dialog-ldap-user-change-password-close', function() {\n        // HIde\n        $('.content-header, .content').removeClass('hidden');\n\n        // SHow form\n        $('#dialog-ldap-user-change-password, #dialog-ldap-user-change-password-info').addClass('hidden');\n    });\n    // --- END ---\n\n\n    function loadSettings() {\n        return $.post(\n            \"sources/main.queries.php\", {\n                type: \"get_teampass_settings\",\n                type_category: 'action_system',\n                key: '<?php echo $_SESSION['key']; ?>'\n            },\n            function(data) {\n                try {\n                    data = prepareExchangedData(\n                        data,\n                        \"decode\",\n                        \"<?php echo $_SESSION['key']; ?>\"\n                    );\n                } catch (e) {\n                    // error\n                    toastr.remove();\n                    toastr.error(\n                        '<?php echo langHdl('server_answer_error'); ?>',\n                        '<?php echo langHdl('caution'); ?>', {\n                            timeOut: 5000,\n                            progressBar: true,\n                            positionClass: \"toast-top-right\"\n                        }\n                    );\n                    return false;\n                }\n                if (debugJavascript === true) {\n                    console.log('Loading settings result:');\n                    console.log(data);\n                }\n\n                // Test if JSON object\n                if (typeof data === 'object') {\n                    // Store settings in localstorage\n                    // except sensitive data\n                    var sensitiveData = ['ldap_hosts','ldap_username','ldap_password','ldap_bdn', 'email','bck_script_passkey'];\n\n                    store.remove(\"teampassSettings\");\n\n                    store.update(\n                        'teampassSettings', {},\n                        function(teampassSettings) {\n                            $.each(data, function(key, value) {\n                                const containsKey = sensitiveData.some(element => {\n                                    if (key.includes(element)) {\n                                        return true;\n                                    }\n                                    return false;\n                                });\n\n                                if (containsKey === false) {\n                                    teampassSettings[key] = value;\n                                }\n                            });\n                        }\n                    );\n\n                    // Store some User info\n                    store.update(\n                        'teampassUser', {},\n                        function(teampassUser) {\n                            teampassUser['user_admin'] = <?php echo isset($_SESSION['user_admin']) === true ? (int) $_SESSION['user_admin'] : 0; ?>;\n                            teampassUser['user_id'] = <?php echo isset($_SESSION['user_id']) === true ? (int) $_SESSION['user_id'] : 0; ?>;\n                            teampassUser['user_manager'] = <?php echo isset($_SESSION['user_manager']) === true ? (int) $_SESSION['user_manager'] : 0; ?>;\n                            teampassUser['user_can_manage_all_users'] = <?php echo isset($_SESSION['user_can_manage_all_users']) === true ? (int) $_SESSION['user_can_manage_all_users'] : 0; ?>;\n                            teampassUser['user_read_only'] = <?php echo isset($_SESSION['user_admin']) === true ? (int) $_SESSION['user_read_only'] : 1; ?>;\n                            teampassUser['key'] = '<?php echo isset($_SESSION['key']) === true ? $_SESSION['key'] : 0; ?>';\n                            teampassUser['login'] = \"<?php echo isset($_SESSION['login']) === true ? $_SESSION['login'] : 0; ?>\";\n                            teampassUser['lastname'] = \"<?php echo isset($_SESSION['lastname']) === true ? $_SESSION['lastname'] : 0; ?>\";\n                            teampassUser['name'] = \"<?php echo isset($_SESSION['name']) === true ? $_SESSION['name'] : 0; ?>\";\n                            teampassUser['pskDefinedInDatabase'] = <?php echo isset($_SESSION['user']['encrypted_psk']) === true ? 1 : 0; ?>;\n                            teampassUser['can_create_root_folder'] = <?php echo isset($_SESSION['can_create_root_folder']) === true ? (int) $_SESSION['can_create_root_folder'] : 0; ?>;\n                            teampassUser['pskDefinedInDatabase'] = <?php echo isset($_SESSION['user']['encrypted_psk']) === true ? 1 : 0; ?>;\n                            teampassUser['special'] = '<?php echo isset($_SESSION['user']['special']) === true ? $_SESSION['user']['special'] : 'none'; ?>';\n                        }\n                    );\n                }\n            }\n        );\n    }\n\n    /**\n     * Undocumented function\n     *\n     * @return void\n     */\n    function showExtendSession() {\n        // Prepare modal\n        showModalDialogBox(\n            '#warningModal',\n            '<i class=\"fas fa-clock fa-lg warning mr-2\"></i><?php echo langHdl('index_add_one_hour'); ?>',\n            '<div class=\"form-group\">' +\n            '<label for=\"warningModal-input\" class=\"col-form-label\"><?php echo langHdl('index_session_duration') . ' (' . langHdl('minutes') . ')'; ?>:</label>' +\n            '<input type=\"text\" class=\"form-control\" id=\"warningModal-input\" value=\"<?php echo isset($_SESSION['user']['session_duration']) === true ? (int) $_SESSION['user']['session_duration'] / 60 : 60; ?>\">' +\n            '</div>',\n            '<?php echo langHdl('confirm'); ?>',\n            '<?php echo langHdl('cancel'); ?>'\n        );\n\n        // Actions on modal buttons\n        $(document).on('click', '#warningModalButtonAction', function() {\n            // SHow user\n            toastr.remove();\n            toastr.info(\n                '<?php echo langHdl('in_progress'); ?><i class=\"fas fa-circle-notch fa-spin fa-2x ml-3\"></i>'\n            );\n\n            // Perform action\n            $.when(\n                IncreaseSessionTime(\n                    $('#warningModal-input').val()\n                )\n            ).then(function() {\n                toastr.remove();\n                toastr.success(\n                    '<?php echo langHdl('done'); ?>',\n                    '', {\n                        timeOut: 1000\n                    }\n                );\n                $('#warningModal').modal('hide');\n            });\n        });\n    }\n\n    /**\n     * Undocumented function\n     *\n     * @return void\n     */\n    function showPersonalSKDialog() {\n        $('#dialog-request-psk').removeClass('hidden');\n\n        // Hide other\n        $('.content-header, .content').addClass('hidden');\n\n        $('#user_personal_saltkey').focus();\n\n        toastr.remove();\n    }\n\n    /**\n     * Loads the last seen items\n     *\n     * @return void\n     */\n    function refreshListLastSeenItems() {\n        $.post(\n            \"sources/main.queries.php\", {\n                type: 'refresh_list_items_seen',\n                type_category: 'action_user',\n                key: '<?php echo $_SESSION['key']; ?>'\n            },\n            function(data) {\n                try {\n                    data = $.parseJSON(data)\n                } catch (e) {\n                    return false;\n                }\n                if (debugJavascript === true) {\n                    console.log('Refresh last item seen result');\n                    console.log(data);\n                }\n                //check if format error\n                if (data.error === '') {\n                    if (data.html_json === null || data.html_json === '') {\n                        $('#index-last-pwds').html('<li><?php echo langHdl('none'); ?></li>');\n                    } else {\n                        // Prepare HTML\n                        var html_list = '';\n                        $.each(data.html_json, function(i, value) {\n                            html_list += '<li onclick=\"showItemCard($(this).closest(\\'li\\'))\" class=\"pointer\" data-item-edition=\"0\" data-item-id=\"' + value.id + '\" data-item-sk=\"' + value.perso + '\" data-item-expired=\"0\" data-item-restricted=\"' + value.restricted + '\" data-item-display=\"1\" data-item-open-edit=\"0\" data-item-reload=\"0\" data-item-tree-id=\"' + value.tree_id + '\" data-is-search-result=\"0\">' +\n                                '<i class=\"fa fa-caret-right mr-2\"></i>' + value.label + '</li>';\n                        });\n                        $('#index-last-pwds').html(html_list);\n                    }\n\n                    // show notification\n                    if (data.existing_suggestions !== 0) {\n                        blink('#menu_button_suggestion', -1, 500, 'ui-state-error');\n                    }\n                } else {\n                    toastr.remove();\n                    toastr.error(\n                        data.error,\n                        '<?php echo langHdl('caution'); ?>', {\n                            timeOut: 5000,\n                            progressBar: true\n                        }\n                    );\n                }\n            }\n        );\n    }\n\n    /**\n     * Show an item\n     *\n     * @return void\n     */\n    function showItemCard(itemDefinition) {\n        // Show circle-notch\n        toastr.remove();\n        toastr.info(\n            '<?php echo langHdl('in_progress'); ?><i class=\"fas fa-circle-notch fa-spin fa-2x ml-3\"></i>'\n        );\n\n        if (window.location.href.indexOf('page=items') === -1) {\n            location.replace('<?php echo $SETTINGS['cpassman_url']; ?>/index.php?page=items&group=' + itemDefinition.data().itemTreeId + '&id=' + itemDefinition.data().itemId);\n        } else {\n            $('#items_list').html('<ul class=\"liste_items\" id=\"full_items_list\"></ul>');\n            Details(itemDefinition, 'show');\n            if (itemDefinition.data().itemTreeId !== $('#open_folder').val()) {\n                ListerItems(itemDefinition.data().itemTreeId, '', 0);\n            }\n\n            // Hide sidebar-mini\n            $('body')\n                .removeClass('control-sidebar-slide-open');\n        }\n    }\n\n    /**\n     * Open defect report page\n     *\n     * @return void\n     */\n    function generateBugReport() {\n        $('#dialog-bug-report-text').html('');\n        $('#dialog-bug-report').removeClass('hidden');\n\n        // Scroll to top\n        $(window).scrollTop(0);\n\n        var data = {\n            'browser_name': platform.name,\n            'browser_version': platform.version,\n            'os': platform.os.family,\n            'os_archi': platform.os.architecture,\n            'current_page': window.location.href.substring(window.location.href.lastIndexOf(\"/\")+1),\n        }\n        \n        $.post(\n            \"sources/main.queries.php\", {\n                type: 'generate_bug_report',\n                type_category: 'action_system',\n                data: prepareExchangedData(JSON.stringify(data), 'encode', '<?php echo $_SESSION['key']; ?>'),\n                key: '<?php echo $_SESSION['key']; ?>'\n            },\n            function(data) {\n                data = prepareExchangedData(data, 'decode', '<?php echo $_SESSION['key']; ?>');\n\n                // Show data\n                $('#dialog-bug-report-text').html(data.html);\n\n                // Open Github\n                $('#dialog-bug-report-github-button').click(function() {\n                    window.open('https://github.com/nilsteampassnet/TeamPass/issues/new', '_blank');\n                    return false;\n                });\n            }\n        );\n    }\n\n\n\n    function userShareKeysReencryption(\n        userId = null,\n        erase_existing_keys = false,\n        divIdDialog = '',\n        to_be_continued = false\n    ) {\n        console.log('USER SHAREKEYS RE-ENCRYPTION START');\n\n        $('#'+divIdDialog+'-progress').html('<b><?php echo langHdl('clearing_old_sharekeys'); ?></b><i class=\"fas fa-spinner fa-pulse ml-3 text-primary\"></i>');\n\n        toastr.remove();\n        toastr.info(\n            '<?php echo langHdl('in_progress'); ?><i class=\"fas fa-circle-notch fa-spin fa-2x ml-3\"></i>'\n        );\n\n        var data = {\n            'user_id': userId,\n            'self_change': erase_existing_keys,\n        }\n        if (debugJavascript === true) console.log(data)\n        $.post(\n            \"sources/main.queries.php\", {\n                type: \"user_sharekeys_reencryption_start\",\n                type_category: 'action_key',\n                data: prepareExchangedData(JSON.stringify(data), 'encode', '<?php echo $_SESSION['key']; ?>'),\n                key: '<?php echo $_SESSION['key']; ?>'\n            },\n            function(data) {\n                data = prepareExchangedData(data, \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n                if (debugJavascript === true) console.log(data)\n                if (data.error === true) {\n                    // error\n                    toastr.remove();\n                    toastr.error(\n                        data.message,\n                        '<?php echo langHdl('caution'); ?>', {\n                            timeOut: 5000,\n                            progressBar: true\n                        }\n                    );\n\n                    $(\"#\"+divIdDialog+'-progress').html('<?php echo langHdl('fill_in_fields_and_hit_launch'); ?>');\n\n                    // Enable buttons\n                    $('#'+divIdDialog+'-do, #'+divIdDialog+'-close').removeAttr('disabled');\n                    return false;\n                } else {\n                    // Start looping on all steps of re-encryption\n                    userShareKeysReencryptionNext(data.userId, data.step, data.start, erase_existing_keys, divIdDialog, to_be_continued);\n                }\n            }\n        );\n    }\n\n    function userShareKeysReencryptionNext(\n        userId,\n        step,\n        start,\n        erase_existing_keys = false,\n        divIdDialog,\n        to_be_continued\n    ) {\n        var stepText = '';\n        console.log('Performing '+step)\n\n        // Prepare progress string\n        if (step === 'step0') {\n            stepText = '<?php echo langHdl('inititialization'); ?>';\n        } else if (step === 'step1') {\n            stepText = '<?php echo langHdl('items'); ?>';\n        } else if (step === 'step2') {\n            stepText = '<?php echo langHdl('logs'); ?>';\n        } else if (step === 'step3') {\n            stepText = '<?php echo langHdl('suggestions'); ?>';\n        } else if (step === 'step4') {\n            stepText = '<?php echo langHdl('fields'); ?>';\n        } else if (step === 'step5') {\n            stepText = '<?php echo langHdl('files'); ?>';\n        } else if (step === 'step6') {\n            stepText = '<?php echo langHdl('personal_items'); ?>';\n        }\n\n        if (step !== 'finished') {\n            // Inform user\n            $(\"#\"+divIdDialog+'-progress').html('<b><?php echo langHdl('encryption_keys'); ?> - ' +\n                stepText + '</b> [' + start + ' - ' + (parseInt(start) + <?php echo NUMBER_ITEMS_IN_BATCH;?>) + '] ' +\n                '... <?php echo langHdl('please_wait'); ?><i class=\"fas fa-spinner fa-pulse ml-3 text-primary\"></i>');\n\n            var data = {\n                'action': step,\n                'start': start,\n                'length': <?php echo NUMBER_ITEMS_IN_BATCH;?>,\n                'user_id': userId,\n            }\n            // Do query\n            $.post(\n                \"sources/main.queries.php\", {\n                    type: \"user_sharekeys_reencryption_next\",\n                    type_category: 'action_key',\n                    data: prepareExchangedData(JSON.stringify(data), 'encode', '<?php echo $_SESSION['key']; ?>'),\n                    key: '<?php echo $_SESSION['key']; ?>'\n                },\n                function(data) {\n                    data = prepareExchangedData(data, \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n                    if (debugJavascript === true) console.log(data);\n                    \n                    if (data.error === true) {\n                        // error\n                        toastr.remove();\n                        toastr.error(\n                            data.message,\n                            '<?php echo langHdl('caution'); ?>', {\n                                timeOut: 5000,\n                                progressBar: true\n                            }\n                        );\n\n                        // Enable buttons\n                        $('#'+divIdDialog+'-do, #'+divIdDialog+'-close').removeAttr('disabled');\n                        return false;\n                    } else {\n                        // Start looping on all steps of re-encryption\n                        userShareKeysReencryptionNext(data.userId, data.step, data.start, erase_existing_keys, divIdDialog, to_be_continued);\n                    }\n                }\n            );\n        } else {console.log(\"Finishing : \"+to_be_continued)\n            if (to_be_continued !== true) {\n                // Enable close button\n                $('#'+divIdDialog+'-close').removeAttr('disabled');\n\n                // Finished\n                $(\"#\"+divIdDialog+'-progress').html('<i class=\"fas fa-check text-success mr-3\"></i><?php echo langHdl('done'); ?>');\n                toastr.remove();\n\n                // Unlog if same user\n                if (userId === <?php echo $_SESSION['user_id']; ?>) {\n                    toastr.success(\n                        '<?php echo langHdl('logout_on_going'); ?><i class=\"fas fa-circle-notch fa-spin fa-2x ml-3\"></i>',\n                        '', {\n                            timeOut: 4000\n                        }\n                    );\n\n                    window.location.href = \"./includes/core/logout.php?token=\" + <?php echo $_SESSION['key']; ?>\n                } else if (store.get('teampassUser').admin_user_password) {\n                    // now select if sending by email\n                    $('#dialog-admin-change-user-password-info').html('<i class=\"fas fa-envelope-open-text fa-lg warning mr-2\"></i><?php echo langHdl('information'); ?><br><br>'+\n                    '<i class=\"fas fa-info-circle mr-2\"></i><?php echo langHdl('send_user_password_by_email'); ?>'+\n                    '<div class=\"row\">'+\n                        '<div class=\"col-lg-2\"><button type=\"button\" class=\"btn btn-block btn-secondary mr-2 temp-button\"  data-action=\"show-user-pwd\"><?php echo langHdl('show_user_password'); ?></button></div>'+\n                        '<div class=\"col-lg-2\"><input class=\"form-control form-item-control\" type=\"hidden\" id=\"temp-user-pwd\" value=\"'+store.get('teampassUser').admin_user_password+'\"></div>'+\n                        '<div class=\"col-lg-2\"><button type=\"button\" class=\"btn btn-block btn-secondary mr-2 temp-button\"  data-action=\"send-user-pwd\"><?php echo langHdl('send_by_email'); ?></button>'+\n                        '<input class=\"form-control form-item-control\" type=\"hidden\" id=\"temp-user-email\" value=\"'+store.get('teampassUser').admin_user_email+'\"></div>'+\n                    '</div>');\n\n\n                    $(\"#dialog-admin-change-user-password-progress\").html('<?php echo langHdl('done'); ?>');\n                    $(\"#dialog-admin-change-user-password-do\").removeAttr('disabled');\n                }\n            }\n        }\n    }\n\n    // This permits to manage the column width of tree/items\n    $(document).on('click', '.columns-position', function() {\n        var colLeft = $('#folders-tree-card').find('.column-left'),\n            colRight = $('#folders-tree-card').find('.column-right'),\n            counterLeft = $(colLeft).attr(\"class\").match(/col-md-[\\w-]*\\b/)[0].split('-')[2],\n            counterRight = $(colRight).attr(\"class\").match(/col-md-[\\w-]*\\b/)[0].split('-')[2];\n\n        // Toogle class\n        if ($('#folders-tree-card').hasClass('hidden') === false) {\n            if ($(this).hasClass('tree-decrease') === true && counterRight < 9) {\n                $(colLeft).toggleClass('col-md-' + counterLeft + ' col-md-' + (parseInt(counterLeft) - 1));\n                $(colRight).toggleClass('col-md-' + counterRight + ' col-md-' + (parseInt(counterRight) + 1));\n            } else if ($(this).hasClass('tree-increase') === true && counterLeft < 9) {\n                $(colLeft).toggleClass('col-md-' + counterLeft + ' col-md-' + (parseInt(counterLeft) + 1));\n                $(colRight).toggleClass('col-md-' + counterRight + ' col-md-' + (parseInt(counterRight) - 1));\n            }\n        }\n    })\n\n    $(function() {\n        // In case that session was expired and login form was reloaded\n        // Force the launchIdentify as if the user has clicked the button\n        if ($(\"#auto_log\").length > 0) {\n            $(\"#but_identify_user\").click();\n        }\n    });\n\n    // Prevent usage of browser back button\n    history.pushState(null, null, location.href);\n    window.onpopstate = function () {\n        const queryString = window.location.search\n        const urlParams = new URLSearchParams(queryString);\n        if (urlParams.get('page') === 'items') {\n            // go back to list\n            // Play with show and hide classes\n            $('.form-item, .form-item-action, .form-folder-action, .item-details-card, .columns-position, #item-details-card-categories, #form-item-upload-pickfilesList, #card-item-expired')\n                .addClass('hidden');\n            $('#folders-tree-card').removeClass('hidden');\n\n            history.go(1);\n        }\n    };\n\n\n\n    /**\n     * \n     * @param {integer} duration\n     * \n     */\n    function clearClipboardTimeout(duration) {\n        // Wait for duration\n        $(this).delay(duration * 1000).queue(function() {\n            navigator.clipboard.writeText(\"Cleared by Teampass\").then(function() {\n                // clipboard successfully set\n            }, function() {\n                // clipboard write failed\n            });\n\n            $(this).dequeue();\n        });\n    }\n</script>\n", "<?php\n\ndeclare(strict_types=1);\n\n/**\n * Teampass - a collaborative passwords manager.\n * ---\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n * ---\n *\n * @project   Teampass\n * @version   3.0.0.23\n * @file      logout.php\n * ---\n *\n * @author    Nils Laumaill\u00e9 (nils@teampass.net)\n *\n * @copyright 2009-2023 Teampass.net\n *\n * @license   https://spdx.org/licenses/GPL-3.0-only.html#licenseText GPL-3.0\n * ---\n *\n * @see       https://www.teampass.net\n */\n\nrequire_once '../../sources/SecureHandler.php';\nsession_name('teampass_session');\nsession_start();\n\n// Load superglobal library\nrequire_once '../../includes/libraries/protect/SuperGlobal/SuperGlobal.php';\n$superGlobal = new protect\\SuperGlobal\\SuperGlobal();\n$get = [];\n$get['user_id'] = $superGlobal->get('user_id', 'GET');\n\n// Update table by deleting ID\nif (isset($_SESSION['user_id']) === true && empty($_SESSION['user_id']) === false) {\n    $user_id = $_SESSION['user_id'];\n} elseif (isset($get['token']) === true && empty($get['token']) === false) {\n    $user_token = $get['token'];\n} else {\n    $user_id = '';\n    $user_token = '';\n}\n\nif (empty($user_id) === false && isset($_SESSION['CPM']) === true) {\n    // connect to the server\n    include_once '../../sources/main.functions.php';\n    include_once '../../includes/config/settings.php';\n    include_once '../../includes/libraries/Database/Meekrodb/db.class.php';\n    DB::$host = DB_HOST;\n    DB::$user = DB_USER;\n    DB::$password = defuseReturnDecrypted(DB_PASSWD, $SETTINGS);\n    DB::$dbName = DB_NAME;\n    DB::$port = DB_PORT;\n    DB::$encoding = DB_ENCODING;\n    DB::$ssl = DB_SSL;\n    DB::$connect_options = DB_CONNECT_OPTIONS;\n    // clear in db\n    DB::update(\n        DB_PREFIX.'users',\n        [\n            'key_tempo' => '',\n            'timestamp' => '',\n            'session_end' => '',\n        ],\n        'id=%i || key_tempo=%s',\n        $user_id,\n        $user_token\n    );\n    //Log into DB the user's disconnection\n    if (isset($SETTINGS['log_connections']) === true\n        && (int) $SETTINGS['log_connections'] === 1\n    ) {\n        include_once '../../sources/main.functions.php';\n        logEvents($SETTINGS, 'user_connection', 'disconnect', (string) $user_id, isset($_SESSION['login']) === true ? $_SESSION['login'] : '');\n    }\n}\n\n// erase session table\nsession_destroy();\n$_SESSION = [];\nrequire_once '../../sources/SecureHandler.php';\nsession_name('teampass_session');\nsession_start();\n$_SESSION['CPM'] = 1;\necho '\n    <script type=\"text/javascript\" src=\"../../plugins/store.js/dist/store.everything.min.js\"></script>\n    <script language=\"javascript\" type=\"text/javascript\">\n    <!--\n        // Clear localstorage\n        store.remove(\"teampassApplication\");\n        store.remove(\"teampassSettings\");\n        store.remove(\"teampassUser\");\n        store.remove(\"teampassItem\");\n        sessionStorage.clear();\n        \n        setTimeout(function() {\n            document.location.href=\"../../index.php\"\n        }, 1);\n    -->\n    </script>';\n", "body{\n    width: 1000px;\n    margin-left: auto;\n    margin-right: auto;\n    background-image: url(../../includes/images/install_background.jpg);\n\t-webkit-background-size: cover;\n\tbackground-size: cover;\n    font-family: sans-serif;\n}\n\n#top{\n\twidth: 1000px;\n\tmargin-left: auto;\n\tmargin-right: auto;\n\tpadding: 10px;\n\tfont-family: sans-serif;\n\tdisplay:block;\n\tcolor: #404d63;\n}\n\n.lcol {\n\tvertical-align:middle;\n\tdisplay:inline-block;\n\tmargin-bottom: 15px;\n}\n\n.header-title{\n\tfont-size: 42px;\n\tletter-spacing: 10px;\n\tcolor: #84AAB7;\n}\n\n.header-title-small{\n\tfont-size: 16px;\n\tletter-spacing: 2px;\n}\n\n#title {\n  font: bold 270%/100% \"Lucida Grande\";\n  color: #464646;\n  float:left;\n  margin-top:3px;\n}\n\n#main {\n\twidth: 1000px;\n\tmargin-top:15px;\n\tmargin-left: auto;\n\tmargin-right: auto;\n\tbackground-color:white;\n\tcolor:#464646;\n\theight:90%;\n\toverflow:hidden;\n\tpadding:10px;\n\tdisplay:block;\n\theight:100%;\n}\n\n#menu {\n\tfloat:  left;\n\twidth:  25%;\n\tmargin-left:-20px;\n\theight:100%;\n}\n\n#menu li {\n\tmargin-top:5px;\n}\n\n.li_inprogress {\n\tfont-weight:    bold;\n\tcolor:          #5283BB;\n}\n\n.li_done {\n\tfont-weight:    normal;\n\tcolor:          #464646;\n}\n\n#content {\n\t/*float:left;\n\twidth:  75%;\n\theight:100%;*/\n}\n\n#step_name {\n\tfont-weight:    bold;\n\ttext-align:     center;\n\tfont-size:      15px;\n}\n\n#step_content {\n\tmargin-top: 10px;\n}\n\n#action_buttons {\n\twidth: 1000px;\n\tpadding:    10px;\n\tmargin:0 auto 0 auto;\n\tbackground-color:white;\n\tcolor:#464646;\n\theight:     30px;\n\ttext-align: right;\n}\nh5 {\n\tmargin-bottom: 10px;\n}\n\n.label_block {\n\tdisplay: inline-block;\n\twidth:  200px;\n\tmargin-bottom: 2px;\n}\n\n.label_block_big {\n\tdisplay: inline-block;\n\twidth:  270px;\n\tmargin-bottom: 2px;\n}\n\n.hidden {\n  display: none;\n}\n", "<?php\n/**\n * Teampass - a collaborative passwords manager.\n * ---\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n * ---\n * @project   Teampass\n * @version   3.0.0.23\n * @file      upgrade.php\n * ---\n * @author    Nils Laumaill\u00e9 (nils@teampass.net)\n * @copyright 2009-2023 Teampass.net\n * @license   https://spdx.org/licenses/GPL-3.0-only.html#licenseText GPL-3.0\n * ---\n * @see       https://www.teampass.net\n */\n\n\nheader('X-XSS-Protection: 1; mode=block');\nheader('X-Frame-Options: SameOrigin');\n\n// **PREVENTING SESSION HIJACKING**\n// Prevents javascript XSS attacks aimed to steal the session ID\nini_set('session.cookie_httponly', 1);\n\n// **PREVENTING SESSION FIXATION**\n// Session ID cannot be passed through URLs\nini_set('session.use_only_cookies', 1);\n\n// Uses a secure connection (HTTPS) if possible\nini_set('session.cookie_secure', 0);\n\nrequire_once '../sources/SecureHandler.php';\nsession_name('teampass_session');\nsession_start();\n//Session teampass tag\n$_SESSION['CPM'] = 1;\ndefine('MIN_PHP_VERSION', 7.4);\ndefine('MIN_MYSQL_VERSION', '8.0.13');\ndefine('MIN_MARIADB_VERSION', '10.2.1');\n\n// Prepare POST variables\n$post_root_url = filter_input(INPUT_POST, 'root_url', FILTER_SANITIZE_STRING);\n$post_step = filter_input(INPUT_POST, 'step', FILTER_SANITIZE_NUMBER_INT);\n$post_actual_cpm_version = filter_input(INPUT_POST, 'actual_cpm_version', FILTER_SANITIZE_STRING);\n$post_cpm_isUTF8 = filter_input(INPUT_POST, 'cpm_isUTF8', FILTER_SANITIZE_STRING);\n$post_user_granted = filter_input(INPUT_POST, 'user_granted', FILTER_SANITIZE_STRING);\n$post_session_salt = filter_input(INPUT_POST, 'session_salt', FILTER_SANITIZE_STRING);\n$post_url_path = filter_input(INPUT_POST, 'url_path', FILTER_SANITIZE_STRING);\n$post_infotmp = filter_input(INPUT_POST, 'infotmp', FILTER_SANITIZE_STRING);\n\n//###############\n//# Function permits to get the value from a line\n//###############\n/**\n * @param string $val\n */\nfunction getSettingValue($val)\n{\n    $val = trim(strstr($val, '='));\n\n    return trim(str_replace('\"', '', substr($val, 1, strpos($val, ';') - 1)));\n}\n\n//get infos from SETTINGS.PHP file\n$filename = '../includes/config/settings.php';\n$events = '';\nif (file_exists($filename)) {\n    include_once $filename;\n}\n\n?>\n<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n    <head>\n        <title>TeamPass Upgrade</title>\n        \n        <meta http-equiv='Content-Type' content='text/html;charset=utf-8' />\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\"/>\n        <meta http-equiv=\"x-ua-compatible\" content=\"ie=edge\"/>\n\n        <link rel=\"stylesheet\" href=\"css/install.css\" type=\"text/css\" />\n        <link rel=\"stylesheet\" href=\"../plugins/fontawesome-free-6/css/all.css\">\n        \n        <!-- Theme style -->\n        <link rel=\"stylesheet\" href=\"../plugins/adminlte/css/adminlte.min.css\">\n        <link rel=\"stylesheet\" href=\"../plugins/alertifyjs/css/alertify.min.css\"/>\n        <link rel=\"stylesheet\" href=\"../plugins/alertifyjs/css/themes/bootstrap.min.css\"/>\n        \n        \n    </head>\n    \n    <body>\n<?php\nrequire_once '../includes/language/english.php';\nrequire_once '../includes/config/include.php';\n\nif (empty($post_root_url) === false) {\n    $_SESSION['fullurl'] = $post_root_url;\n}\n\n//define root path\n$abs_path = rtrim(\n    filter_var($_SERVER['DOCUMENT_ROOT'], FILTER_SANITIZE_STRING),\n    '/'\n).substr(\n    filter_var($_SERVER['PHP_SELF'], FILTER_SANITIZE_STRING),\n    0,\n    strlen(filter_var($_SERVER['PHP_SELF'], FILTER_SANITIZE_STRING)) - 20\n);\nif (isset($_SERVER['HTTPS'])) {\n    $protocol = 'https://';\n} else {\n    $protocol = 'http://';\n}\n\n\n// HEADER\necho '\n    <div id=\"top\" class=\"center-screen\">\n        <div id=\"logo\" class=\"lcol\"><img src=\"../includes/images/teampass-logo2-home.png\" /></div>\n        <div class=\"lcol\">\n            <span class=\"header-title\">'.strtoupper(TP_TOOL_NAME).'</span>\n            <!--<span class=\"header-title-small\"> v'.TP_VERSION_FULL.'</span>-->\n        </div>\n    <div id=\"content\">\n        <form name=\"install\" method=\"post\" action=\"\">\n        <div class=\"card card-default color-palette-box\">\n            <div class=\"card-header\">\n                <h3 class=\"card-title\">\n                    <i class=\"fas fa-people-carry mr-2\"></i>Teampass upgrade\n                </h3>\n            </div>\n            <div class=\"card-body\">';\n\n//HIDDEN THINGS\necho '\n                <input type=\"hidden\" id=\"step\" name=\"step\" value=\"', isset($post_step) ? $post_step : '', '\" />\n                <input type=\"hidden\" id=\"actual_cpm_version\" name=\"actual_cpm_version\" value=\"', isset($post_actual_cpm_version) ? $post_actual_cpm_version : '', '\" />\n                <input type=\"hidden\" id=\"cpm_isUTF8\" name=\"cpm_isUTF8\" value=\"', isset($post_cpm_isUTF8) ? $post_cpm_isUTF8 : '', '\" />\n                <input type=\"hidden\" name=\"menu_action\" id=\"menu_action\" value=\"\" />\n                <input type=\"hidden\" name=\"user_granted\" id=\"user_granted\" value=\"\" />\n                <input type=\"hidden\" name=\"infotmp\" id=\"infotmp\" value=\"', isset($post_infotmp) ? $post_infotmp : '', '\" />\n                <input type=\"hidden\" name=\"url_path\" id=\"url_path\" value=\"'.$protocol.$_SERVER['HTTP_HOST'].substr($_SERVER['PHP_SELF'], 0, strrpos($_SERVER['PHP_SELF'], '/') - 8).'\" />\n                <input type=\"hidden\" name=\"session_salt\" id=\"session_salt\" value=\"', (isset($post_session_salt) && !empty($post_session_salt)) ? $post_session_salt : @$_SESSION['encrypt_key'], '\" />';\n\nif (!isset($_GET['step']) && !isset($post_step)) {\n    //ETAPE O\n    echo '\n                <div class=\"row\">\n                    <div class=\"callout callout-warning col-12\">\n                        <h5>Information</h5>\n    \n                        <p>Upgrade process is about to start. This will upgrade Teampass database to version '.TP_VERSION_FULL.'.</p>\n                        <p>Version 3 comes with a new secured encryption strategy getting rid of any Saltkey. It relies on public and private keys generated for each user. As an impact, this upgrade will automatically generate a One-Time-Code for each user and send by email. It will be requested on first login. Please ensure your users have filled in their email with a valid value.</p>\n                    </div>\n\n                    <div class=\"callout callout-info col-12\">\n                        <h5>Before starting, take a couple of minutes to perform backup of current Teampass instance:</h5>\n    \n                        <p>\n                        <ul>\n                            <li><i class=\"fas fa-exclamation-circle mr-2 text-danger\"></i>Ensure to clear your browser cache (keyboard: <i>CTRL + F5</i>)</li>\n                            <li><i class=\"fas fa-exclamation-triangle mr-2 text-warning\"></i>Create a dump of your database</li>\n                            <li><i class=\"fas fa-exclamation-triangle mr-2 text-warning\"></i>Perform a zip of the current Teampass folder</li>\n                            <li><i class=\"fas fa-info-circle mr-2 text-success\"></i>Refer to <a href=\"https://teampass.readthedocs.io/en/latest/install/upgrade/\" target=\"_blank\" class=\"text-info\">upgrade documentation</a>.</li>\n                        </ul>\n                        </p>\n                    </div>\n                </div>\n\n                <div class=\"row card card-primary\">\n                    <div class=\"card-body col-12\">\n                        <div class=\"form-group\">\n                            <label>Administrator Login</label>\n                            <input type=\"text\" class=\"form-control\" id=\"user_login\" placeholder=\"Enter admin login\">\n                        </div>\n                        <div class=\"form-group\">\n                            <label>Password</label>\n                            <input type=\"password\" class=\"form-control\" id=\"user_pwd\" placeholder=\"Enter admin password\">\n                        </div>\n                        <div class=\"alert alert-warning hidden\" id=\"res_step0\"></div>\n                    </div>\n                </div>\n\n\n                <input type=\"hidden\" id=\"step0\" name=\"step0\" value=\"\" />\n\n            </div>';\n// STEP1\n} elseif ((isset($post_step) && $post_step == 1)\n    || (isset($_GET['step']) && $_GET['step'] == 1)\n    && $post_user_granted === '1'\n) {\n    //ETAPE 1\n    $_SESSION['user_granted'] = $post_user_granted;\n    echo '\n            <div class=\"row\">\n                <div class=\"col-12\">\n                    <div class=\"card card-primary\">\n                        <div class=\"card-header\">\n                            <h5>Server information</h5>\n                        </div>\n                        <div class=\"card-body\">\n                            <div class=\"form-group\">\n                                <label>Absolute path to TeamPass folder</label>\n                                <input type=\"text\" class=\"form-control\" id=\"root_path\" value=\"'.$abs_path.'\">\n                            </div>\n                            <div class=\"form-group\">\n                                <label>Full URL to TeamPass</label>\n                                <input type=\"text\" class=\"form-control\" id=\"root_url\" value=\"'.$protocol.$_SERVER['HTTP_HOST'].substr($_SERVER['PHP_SELF'], 0, strrpos($_SERVER['PHP_SELF'], '/') - 8).'\">\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <div class=\"row\">\n                <div class=\"col-12\">\n                    <div class=\"card card-primary\">\n                        <div class=\"card-header\">\n                            <h5>Next elements will be checked</h5>\n                        </div>\n                        <div class=\"card-body\">\n\n                            <div id=\"res_step1\">\n                            <span>File \"settings.php\" is writable</span><br />\n                            <span>Directory \"/install/\" is writable</span><br />\n                            <span>Directory \"/includes/\" is writable</span><br />\n                            <span>Directory \"/includes/config/\" is writable</span><br />\n                            <span>Directory \"/includes/avatars/\" is writable</span><br />\n                            <span>Directory \"/files/\" is writable</span><br />\n                            <span>Directory \"/upload/\" is writable</span><br />\n                            <span>PHP extension \"openssl\" is loaded</span><br />\n                            <span>PHP extension \"gd\" is loaded</span><br />\n                            <span>PHP extension \"mbstring\" is loaded</span><br />\n                            <span>PHP extension \"bcmath\" is loaded</span><br />\n                            <span>PHP extension \"iconv\" is loaded</span><br />\n                            <span>PHP extension \"xml\" is loaded</span><br />\n                            <span>PHP extension \"curl\" is loaded</span><br />\n                            <span>PHP extension \"gmp\" is loaded</span><br />\n                            <span>PHP extension \"mcrypt\" is loaded</span><br />\n                            <span>PHP version is greater or equal to '.MIN_PHP_VERSION.'</span><br />\n                            <span>SQL version is greater or equal to MySQL '.MIN_MYSQL_VERSION.' or MariaDB '.MIN_MARIADB_VERSION.'</span><br />\n                            </div>\n                        \n                        </div>\n                    </div>\n                </div>\n            </div>\n            <input type=\"hidden\" id=\"step1\" name=\"step1\" value=\"\" />';\n// STEP2\n} elseif ((isset($post_step) && $post_step == 2)\n    || (isset($_GET['step']) && $_GET['step'] == 2)\n    && $_SESSION['user_granted'] === '1'\n) {\n    // Do we have all database settings\n    if (null !== DB_HOST\n        && null !== DB_USER\n        && null !== DB_PASSWD\n        && null !== DB_NAME\n        && null !== DB_PREFIX\n        && null !== DB_PORT\n    ) {\n        $dbSettings = true;\n    } else {\n        $dbSettings = false;\n    }\n    //ETAPE 2\n    echo '\n        <div class=\"row\">\n            <div class=\"col-12\">\n                <div class=\"card card-',$dbSettings === true ? 'primary' : 'warning','\">\n                    <div class=\"card-header\">\n                        <h5>DataBase Informations</h5>\n                    </div>\n                    <div class=\"card-body\">\n                        <!--<div class=\"form-group\">\n                            <label>Host</label>\n                            <input type=\"text\" class=\"form-control\" name=\"db_host\" id=\"db_host\" class=\"ui-widget\" value=\"'.DB_HOST.'\">\n                        </div>\n                        \n                        <div class=\"form-group\">\n                            <label>Database name</label>\n                            <input type=\"text\" class=\"form-control\" name=\"db_name\" id=\"db_name\" class=\"ui-widget\" value=\"'.DB_NAME.'\">\n                        </div>\n                        \n                        <div class=\"form-group\">\n                            <label>Login</label>\n                            <input type=\"text\" class=\"form-control\" name=\"db_user\" id=\"db_user\" class=\"ui-widget\" value=\"'.DB_USER.'\">\n                        </div>\n                        \n                        <div class=\"form-group\">\n                            <label>Password</label>\n                            <input type=\"text\" class=\"form-control\" name=\"db_pw\" id=\"db_pw\" class=\"ui-widget\" value=\"'.$visible_pwd.'\">\n                        </div>\n                        \n                        <div class=\"form-group\">\n                            <label>Prefix</label>\n                            <input type=\"text\" class=\"form-control\" name=\"db_prefix\" id=\"db_prefix\" class=\"ui-widget\" value=\"'.DB_PREFIX.'\">\n                        </div>\n                        \n                        <div class=\"form-group\">\n                            <label>Port</label>\n                            <input type=\"text\" class=\"form-control\" name=\"db_port\" id=\"db_port\" class=\"ui-widget\" value=\"'.DB_PORT.'\">\n                        </div>-->';\n\n    // check if all database  info are available\n    if ($dbSettings === true) {\n        echo '\n                        <div>\n                        Database settings has been retreived.<br>\n                        If you need to change them, please edit file `/includes/config/settings.php` and relaunch the upgrade process.\n                        </div>';\n    } else {\n        echo '\n                        <div>\n                        The database information has not been retreived from the settings file.<br>\n                        You need to adapt the file `/includes/config/settings.php` and relaunch the upgrade process.\n                        </div>';\n    }\n\n    echo '\n                        <a href=\"'.$protocol.$_SERVER['HTTP_HOST'].substr($_SERVER['PHP_SELF'], 0, strrpos($_SERVER['PHP_SELF'], '/') - 8).'/install/upgrade.php\">Restart upgrade process</a>\n                    </div>\n                </div>\n\n                <div class=\"card card-primary\">\n                    <div class=\"card-header\">\n                        <h5>Maintenance Mode</h5>\n                    </div>\n                    <div class=\"card-body\">\n                        <div>\n                            <input type=\"checkbox\" class=\"mr-2\" id=\"no_maintenance_mode\">\n                            <label for=\"no_maintenance_mode\">Don\\'t activate the Maintenance mode</label>\n                        </div>\n                        <small class=\"form-text text-muted\">\n                            By default, the maintenance mode is enabled when an Update is performed. This prevents the use of TeamPass while the scripts are running.<br />\n                            However, some administrators may prefer to warn the users in another way. Nevertheless, keep in mind that the update process may fail or even be corrupted due to parallel queries.\n                        </small>\n                    </div>\n                </div>\n\n                <div class=\"card card-primary\">\n                    <div class=\"card-header\">\n                        <h5>Database dump</h5>\n                    </div>\n                    <div class=\"card-body\">\n                        <div>\n                            If you have NOT performed a dump of your database, please considere to create one now.\n                        </div>\n                        <div>\n                            <a href=\"#\" onclick=\"launch_database_dump(); return false;\">Launch a new database dump</a>\n                        </div>\n                        <div>\n                            <span id=\"dump_result\" style=\"margin-top:4px;\" class=\"card card-info\"></span>\n                        </div>\n                    </div>\n                </div>\n\n                <!-- teampass_version = 2.1.27 and no encrypt_key in db -->\n                <div class=\"callout card-warning hidden\" id=\"no_encrypt_key\">\n                    <div class=\"card-header\">\n                        <h5>Database Origine</h5>\n                    </div>\n                    <div class=\"card-body\">\n                        <div>\n                            Please select:&nbsp;<select id=\"no_key_selection\">\n                            <option value=\"false\">-- select --</option>\n                            <option value=\"no_previous_sk_sel\">We have never used Teampass in an older version than 2.1.27(.x)</option>\n                            <option value=\"previous_sk_sel\">We have used Teampass in an older version (example: 2.1.26)</option>\n                        </select>\n                        <div id=\"previous_sk_div\" style=\"display:none;\">\n                            <p>Please use the next field to enter the saltkey you used in previous version of Teampass. It can be retrieved by editing sk.php file (in case you are upgrading from a version older than 2.1.27) or a sk.php backup file (in case you are upgrading from 2.1.27).<br>\n                            </p>\n                            <label for=\"previous_sk\">Previous SaltKey:&nbsp</label>\n                            <input type=\"text\" id=\"previous_sk\" size=\"100px\" value=\"'.@$_SESSION['encrypt_key'].'\" />\n                        </div>\n                        </div>\n                    </div>\n                </div>\n\n                <div style=\"margin-top:20px;font-weight:bold;text-align:center;height:27px;\" id=\"res_step2\"></div>\n                <input type=\"hidden\" id=\"step2\" name=\"step2\" value=\"\">\n\n            </div>\n        </div>';\n\n\n// STEP3\n} elseif ((isset($post_step) && $post_step == 3 || isset($_GET['step']) && $_GET['step'] == 3)\n    && isset($post_actual_cpm_version)\n    && intVal($_SESSION['user_granted']) === 1\n) {\n    if (version_compare($post_actual_cpm_version, '2.1.26', '<')) {\n        $conversion_utf8 = true;\n    } else {\n        $conversion_utf8 = false;\n    }\n    echo '\n        <div class=\"card card-primary\">\n            <div class=\"card-header\">\n                <h5>Converting database to UTF-8</h5>\n            </div>\n            <div class=\"card-body\">\n                <div>\n                ', $conversion_utf8 === true ?\n                'Notice that TeamPass is now only using UTF-8 charset.\n                This step will convert the database to this charset.\n                <div>\n                <input type=\"checkbox\" id=\"prefix_before_convert\" class=\"mr-2\"><label for=\"prefix_before_convert\">Save previous tables before converting (prefix \"old_\" will be used)</label>\n                </div>' :\n                'The database is currently using UTF-8 charset <i class=\"fas fa-check-circle fa-lg text-success ml-3\"></i>', '\n                </div>\n            </div>\n        </div>';\n// STEP4\n} elseif ((isset($post_step) && $post_step == 4) || (isset($_GET['step'])\n    && $_GET['step'] == 4)\n    && $_SESSION['user_granted'] === '1'\n) {\n    echo '\n        <div class=\"card card-primary\">\n            <div class=\"card-header\">\n                <h5>Database updates</h5>\n            </div>\n            <div class=\"card-body\">\n                <small class=\"form-text text-muted\">\n                    The database needs to be adapted. This step can take a very long time depending on the data volume and server performance.\n                </small>\n                <div class=\"row card card-primary mt-2\">\n                    <div class=\"card-body col-12 font-weight-light\" id=\"step4_progress\" style=\"overflow-y: scroll; height:400px;\">\n                        Please click the button START.\n                    </div>\n                </div>\n\n                <div class=\"hidden\" id=\"change_pw_encryption\">\n                    <br />\n                    <p><b>Encryption protocol of existing passwords now has to be started. It may take a very long time depending on the data volume and server performance.</b></p>\n                    <p>\n                        <div style=\"display:none;\" id=\"change_pw_encryption_progress\"></div>\n                    </p>\n                    <input type=\"button\" value=\"Click to continue\" id=\"but_encrypt_continu\" onclick=\"newEncryptPw(0);\" />\n                    <input type=\"hidden\" id=\"change_pw_encryption_start\" value=\"\" />\n                    <input type=\"hidden\" id=\"change_pw_encryption_total\" value=\"\" />\n                </div>\n\n                <div style=\"margin-top:20px;font-weight:bold;text-align:center;height:27px;\" id=\"res_step4\"></div>\n                <input type=\"hidden\" id=\"step4\" name=\"step4\" value=\"\">\n            </div>\n        </div>';\n// STEP5\n} elseif ((isset($post_step) && $post_step == 5)\n    || (isset($_GET['step']) && $_GET['step'] == 5)\n    && $_SESSION['user_granted'] === '1'\n) {\n    //ETAPE 5\n    echo '\n        <h4>Finalization</h4>\n        <div>\n            <ul>\n            <li>Regenerate settings.php file <span id=\"step5_settingFile\"></span></li>\n            <li>Anonymize saltkey file <span id=\"step5_saltkeyFile\"></span></li>\n            <li>Generate config file <span id=\"step5_configFile\"></span></li>\n            <li>Generate CSRFP config file <span id=\"step5_csrfpFile\"></span></li>\n            </ul>\n        </div>';\n\n    echo '\n        <div class=\"card card-primary\">\n            <div class=\"card-header\">\n                <h5>Absolute path to SaltKey</h5>\n            </div>\n            <div class=\"card-body\">\n                <small class=\"form-text text-muted\">\n                The SaltKey is stored in a file stored in a folder outside the www folder of your server.\n                </small>\n                <div class=\"mt-4\">\n                    <input type=\"text\" class=\"form-control\" id=\"sk_path\" value=\"', defined('SECUREPATH') === true ? SECUREPATH : '', '\" placeholder=\"Path to folder\">\n                </div>\n            </div>\n        </div>';\n\n    echo '\n        <div class=\"alert alert-info mt-4 hidden\" id=\"res_step5\"></div>';\n} elseif ((isset($post_step) && $post_step == 6)\n    || (isset($_GET['step']) && $_GET['step'] == 6)\n    && $_SESSION['user_granted'] === '1'\n) {\n    //ETAPE 5\n    echo '\n        <h4>Upgrade is now completed</h4>\n        <div class=\"callout callout-info mt-4\">\n            <div>\n                For news, help and information, visit <a href=\"https://teampass.net\" target=\"_blank\" class=\"text-info\">TeamPass website</a>\n            </div>\n        </div>\n        <div class=\"alert alert-primary mt-4\">\n            <i class=\"far fa-lightbulb text-warning mr-2 fa-lg\"></i>It is recommended to clean the cache of your Web Browser before trying to log in.\n        </div>';\n\n    if (version_compare($post_actual_cpm_version, '2.1.27', '<=')) {\n        echo '\n        <div class=\"alert alert-warning mt-4\">\n            <i class=\"fa fa-exclamation-circle text-danger mr-2 fa-lg\"></i>This upgrade was a heavy one. Indeed we have changed the encryption of your data to make them safer now as they don\\'t rely anymore on a key.<br>\n            This forced us to encode your users data with a One-Time-Code that they did receive by email. For any reason, they did not received it, you as an admin, can change it from the users management page.\n        </div>';\n    }\n\n    echo '\n        <div class=\"mt-5\">\n        <a href=\"#\" class=\"btn btn-primary\" onclick=\"javascript:window.location.href=\\'', (isset($_SERVER['HTTPS']) && ($_SERVER['HTTPS'] == 'on' || $_SERVER['HTTPS'] == 1) || isset($_SERVER['HTTP_X_FORWARDED_PROTO']) && $_SERVER['HTTP_X_FORWARDED_PROTO'] == 'https') ? 'https' : 'http', '://'.$_SERVER['HTTP_HOST'].substr($_SERVER['PHP_SELF'], 0, strrpos($_SERVER['PHP_SELF'], '/') - 8).'\\';\"><b>Open TeamPass</b></a>\n        </div>';\n}\n\necho '\n            <div class=\"card-footer\">';\n//buttons\nif (!isset($post_step)) {\n    echo '\n            <input type=\"button\" id=\"but_launch\" data-step=\"step0\" class=\"btn btn-primary\" value=\"START\">\n            <input type=\"button\" id=\"but_next\" data-target=\"1\" style=\"\" class=\"btn btn-primary\" value=\"NEXT\" disabled=\"disabled\">';\n} elseif (intVal($post_step) === 3 && $conversion_utf8 === false && $_SESSION['user_granted'] === '1') {\n    echo '\n            <input type=\"button\" id=\"but_next\" target_id=\"'.(intval($post_step) + 1).'\" class=\"btn btn-primary\" value=\"NEXT\">';\n} elseif (intVal($post_step) === 3 && $conversion_utf8 === true && $_SESSION['user_granted'] === '1') {\n    echo '\n            <input type=\"button\" id=\"but_launch\" data-step=\"step'.$post_step.'\" class=\"btn btn-primary\" value=\"START\">\n            <input type=\"button\" id=\"but_next\" data-target=\"'.(intval($post_step) + 1).'\" class=\"btn btn-primary\" value=\"NEXT\" disabled=\"disabled\">';\n} elseif (intVal($post_step) === 6 && $_SESSION['user_granted'] === '1') {\n    // Nothong to do\n} else {\n    echo '\n            <input type=\"button\" id=\"but_launch\" data-step=\"step'.$post_step.'\" class=\"btn btn-primary\" value=\"START\" />\n            <input type=\"button\" id=\"but_next\" data-target=\"'.(intval($post_step) + 1).'\" class=\"btn btn-primary\" value=\"NEXT\" disabled=\"disabled\">';\n}\n\necho '\n            </div>\n        </div>\n        </form>\n    </div>';\n//FOOTER\necho '\n    <div id=\"footer\">\n        <div style=\"width:500px; font-size:16px;\">\n            '.TP_TOOL_NAME.' '.TP_VERSION_FULL.' &#169; copyright 2009-'.date(\"Y\").'\n        </div>\n        <div style=\"float:right;margin-top:-15px;\">\n        </div>\n    </div>';\n?>\n    </div>\n\n</body>\n</html>\n\n\n<script type=\"text/javascript\" src=\"js/aes.min.js\"></script>\n<!-- jQuery -->\n<script src=\"../plugins/jquery/jquery.min.js\"></script>\n<!-- jQuery -->\n<script src=\"../plugins/jqueryUI/jquery-ui.min.js\"></script>\n<!-- Popper -->\n<script src=\"../plugins/popper/umd/popper.min.js\"></script>\n<!-- Bootstrap -->\n<script src=\"../plugins/bootstrap/js/bootstrap.bundle.min.js\"></script>\n<!-- AdminLTE -->\n<script src=\"../plugins/adminlte/js/adminlte.min.js\"></script>\n<!-- Altertify -->\n<script type=\"text/javascript\" src=\"../plugins/alertifyjs/alertify.min.js\"></script>\n\n\n\n\n<script type=\"text/javascript\">\nvar timeTaken = '';\n\n\n$(function(){\n    // click on button NEXT\n    $(\"#but_next\").click(function(event) {\n        $(\"#step\").val($(this).data(\"target\"));\n        document.install.submit();\n    });\n\n    $(\"#dump_done\").click(function(event) {\n        if($(\"#dump_done\").is(':checked')) {\n            $(\"#but_next\").prop(\"disabled\", false);\n        } else {\n            $(\"#but_next\").prop(\"disabled\", true);\n        }\n    });\n\n    $(\"#no_key_selection\").change(function() {\n        if ($(\"#no_key_selection\").val() === \"no_previous_sk_sel\") {\n            $(\"#previous_sk_div\").hide();\n            $(\"#previous_sk\").val(\"\");\n        } else if ($(\"#no_key_selection\").val() === \"previous_sk_sel\") {\n            $(\"#previous_sk_div\").show();\n        }\n    });\n\n    // click on button START\n    $('#but_launch').click(function(event) {\n        var currentStep = $(this).data('step'),\n            postData = '';\n        // STEP 0\n        if (currentStep === 'step0') {\n            if ($(\"#user_login\").val() === \"\" || $(\"#user_pwd\").val() === \"\") {\n                alertify\n                    .error('<i class=\"fas fa-ban mr-2\">[ERROR] You must provide credentials</i>', 10)\n                    .dismissOthers();\n                return false;\n            }\n\n            postData = {\n                type : currentStep,\n                login : $(\"#user_login\").val(),\n                pwd : window.btoa(aesEncrypt($(\"#user_pwd\").val()))\n            }\n            \n        } else if (currentStep === 'step1') {\n            postData = {\n                type : currentStep,\n                abspath : $(\"#root_path\").val(),\n                fullurl : $(\"#root_url\").val()\n            }\n        } else if (currentStep === 'step2') {\n            postData = {\n                type : currentStep,\n                abspath : $(\"#root_path\").val(),\n                fullurl : $(\"#root_url\").val()\n            }\n        } else if (currentStep === 'step3') {\n            postData = {\n                type : currentStep,\n                abspath : $(\"#root_path\").val(),\n                fullurl : $(\"#root_url\").val(),\n                prefix_before_convert : $('#prefix_before_convert').prop(\"checked\")\n            }\n\n        } else if (currentStep === \"step4\") {\n            upgrade_file = \"\";\n            timeTaken = getTime();\n            manageUpgradeScripts(\"0\");\n            return false;\n\n        } else if (currentStep === \"step5\") {\n            postData = {\n                type : currentStep,\n                url_path : $(\"#url_path\").val()\n            }\n        }\n\n        alertify\n            .message('<i class=\"fas fa-cog fa-spin fa-2x\"></i>', 0)\n            .dismissOthers();\n        $(\"#res_\"+currentStep).html(\"\").addClass(\"hidden\");\n\n        // EXECUTE AJAX REQUEST\n        return $.ajax({\n            url: \"upgrade_ajax.php\",\n            type : \"POST\",\n            dataType : \"json\",\n            async: false,\n            data : postData,\n            complete : function(result, status){\n                //console.log(result.responseText)\n                data = $.parseJSON(result.responseText)[0];\n                console.log(data)\n                // manage error\n                if (data.error !== \"\") {\n                    $(\"#user_granted\").val(\"0\");\n                    $('#but_next').attr('disabled');\n\n                    if (data.info !== \"\") {\n                        $('#res_'+currentStep).html(data.info).removeClass(\"hidden\");\n                    }\n                    alertify\n                        .error('<i class=\"fas fa-exclamation-triangle mr-2\"></i>  '+data.error+'</i>', 5)\n                        .dismissOthers();\n                } else {\n                    $(\"#step\").val(data.index);\n                    $(\"#user_granted\").val(\"1\");\n                    $('#but_next').removeAttr('disabled');\n\n                    // Special\n                    if (currentStep === 'step0') {\n                        $(\"#infotmp\").val(data.info);\n                    } else if (currentStep === 'step1') {\n                        $('#res_step1').html(data.info).removeClass('hidden');\n                    } else if (currentStep === 'step2') {\n                        \n                        $('#res_step2').html(data.info).removeClass('hidden');\n                        $('#cpm_isUTF8').val(data.isUtf8);\n                        if (parseInt(data.isUtf8) === 1) {\n                            $('#step').val(4);\n                            $('#but_next').data('target', \"4\");\n                        }\n                    } else if (currentStep === 'step5') {\n                        $(\"#res_step5\").html(\"Operations are successfully completed.\").removeClass(\"hidden\");\n                        var res = $.parseJSON(atob(data.info));\n                        \n                        $.each(res, function(index, value) {\n                            $('#'+value.id).html(value.html);\n                        });\n                    }\n\n                    // Display\n                    alertify\n                        .success('<i class=\"fas fa-thumbs-up mr-2\">  Done</i>', 5)\n                        .dismissOthers();\n                }\n            }\n        });\n    });\n\n});\n\nfunction aesEncrypt(text)\n{\n    return Aes.Ctr.encrypt(text, \"cpm\", 128);\n}\n\n\nfunction manageUpgradeScripts(file_number)\n{\n    var start_at = 0;\n    var noitems_by_loop = 100;\n    var loop_number = 0;\n\n    if (file_number == 0) {\n        $(\"#step4_progress\").html(\"\");\n        alertify\n            .success('Done', 1)\n            .dismissOthers();\n    }\n\n    request = $.post(\"upgrade_scripts_manager.php\",\n        {\n            file_number : parseInt(file_number)\n        },\n        function(data) {\n            console.log(data[0])\n            // work not finished\n            if (data[0].finish !== \"1\") {\n                // loop\n                runUpdate(data[0].scriptname, data[0].parameter, start_at, noitems_by_loop, loop_number, file_number);\n            }\n            // work finished\n            else {\n                // refresh categories cache\n                rand_number = createRandomId();\n                $(\"#step4_progress\")\n                    .html(\n                        \"<div>\" + getTime() + \" - <span id='user_\"+rand_number+\"'>Performing database update operations ... <i class=\\\"fas fa-cog fa-spin\\\" style=\\\"color:orange\\\"></i></span></div>\"+ \n                        $(\"#step4_progress\").html()\n                    );\n                $.ajax({\n                    url: \"upgrade_ajax.php\",\n                    type : \"POST\",\n                    dataType : \"json\",\n                    async: false,\n                    data : {\n                        type : \"perform_nestedtree_categories_population_3.0.0.18\"\n                    },\n                    complete : function(result, status) {\n                        console.log(\"Tash perform_nestedtree_categories_population_3.0.0.18 DONE\");\n                        $(\"#user_\"+rand_number)\n                            .html('Database update operations done <i class=\"fas fa-thumbs-up\" style=\"color:green\"></i>'); \n                        migrateUsersToV3('step1', '', 'init', createRandomId(), 0, false, false);\n\n                        alertify\n                            .success('Done with initialization phase', 3)\n                            .dismissOthers();\n                    }\n                });\n            }\n        },\n        \"json\"\n    );\n}\n\nvar usersList = [],\n    previousStep = '',\n    usersRestList = [];\n/**\n    * We need to migrate all users\n    * This will change the users encryption and generate a OTC\n    *\n    * @return void\n    */\nfunction migrateUsersToV3(step, data, number, rand_number, loop_start, loop_finished)\n{\n    //console.log(\"> \"+step+\" - Number: \"+number + \" - Previous step: \"+previousStep);\n    //console.log(usersList);\n    var d = new Date(),\n        count_in_loop = <?php echo (int) NUMBER_ITEMS_IN_BATCH;?>,\n        userSteps = {};\n\n\n    // Decode data\n    var newData = '';\n    if (data !== '' && step === 'step1') {\n        newData = JSON.parse(window.atob(data));\n    }\n    //console.log(\"TO DO : \"+step+\" -- \"+number+\" -- \"+loop_start+\" -- \"+loop_finished+\" -- \"+newData.id)\n\n    if (step === 'step1') {\n        userInfo = '';\n        // Show progress to user\n        $(\"#user_\"+rand_number).html(\"User id \" + newData.id + \" done <i class=\\\"fas fa-thumbs-up\\\" style=\\\"color:green\\\"></i>\");\n\n        if (newData !== '') {\n            usersList.push(newData);\n        }\n        //console.log('List of users');\n        //console.log(JSON.stringify(usersList))\n        \n        if (usersRestList.length > 0) {\n            number = usersRestList[0];\n            usersRestList.shift();\n        } else if (number !== 'init') {\n            number = 'end';\n        }\n        //console.log('List of next users');\n        //console.log(JSON.stringify(usersRestList) + \" ; Number = \"+number)\n        \n        rand_number = createRandomId();\n        $(\"#step4_progress\").html(\"<div>\" + getTime() + \" - <span id='user_\"+rand_number+\"'>Treating User account ... <i class=\\\"fas fa-cog fa-spin\\\" style=\\\"color:orange\\\"></i></span></div>\"+ $(\"#step4_progress\").html());\n        // --\n        // --\n    } else {\n        // Prepare array                \n        if (usersList[number] !== undefined) {\n            userSteps = {\n                'step1' : {\n                    'text' : 'Users public / private keys were generated if needed',\n                    'number' : 0,\n                    'start' : 0\n                },\n                'step2' : {\n                    'text' : 'User '+usersList[number].id+' - All ITEMS keys generated',\n                    'number' : 0,\n                    'start' : 0\n                },\n                'step3' : {\n                    'text' : 'User '+usersList[number].id+' - All LOGS keys generated',\n                    'number' : number,\n                    'start' : 0\n                },\n                'step4' : {\n                    'text' : 'User '+usersList[number].id+' - All FIELDS keys generated',\n                    'number' : number,\n                    'start' : 0\n                },\n                'step5' : {\n                    'text' : 'User '+usersList[number].id+' - All SUGGESTIONS keys generated',\n                    'number' : number,\n                    'start' : 0\n                },\n                'step6' : {\n                    'text' : 'User '+usersList[number].id+' - All FILES keys generated',\n                    'number' : number,\n                    'start' : 0\n                },\n                'nextUser' : {\n                    'number' : parseInt(number) + 1,\n                    'start' : 0\n                }\n            };\n        }\n\n        // What strategy to have for next treatment\n        if (previousStep === 'step1') {\n            $(\"#user_\"+rand_number).html(\"Users public / private keys were generated if needed <i class=\\\"fas fa-thumbs-up\\\" style=\\\"color:green\\\"></i>\");\n\n            number = 0;\n            loop_start = 0;\n            // --\n        } else if (previousStep === step) {\n            // IF we are in the same step and we continue\n            $(\"#user_\"+rand_number).html(userSteps[previousStep].text + \" until \" + (loop_start + count_in_loop) + \" done <i class=\\\"fas fa-thumbs-up\\\" style=\\\"color:green\\\"></i>\");\n\n            loop_start += count_in_loop;\n            // --\n        } else if (step !== 'nextUser' && loop_finished === \"true\") {\n            // The loop on current topic is finished but still with same user\n            $(\"#user_\"+rand_number).html(userSteps[previousStep].text + \" <i class=\\\"fas fa-thumbs-up\\\" style=\\\"color:green\\\"></i>\");\n\n            number = userSteps[step].number;\n            loop_start = userSteps[step].start;\n            // --\n        } else if (step === 'nextUser') {\n            // The treatment of current user is finished\n            // Select next user\n            $(\"#user_\"+rand_number)\n                .html(userSteps[previousStep].text + \" <i class=\\\"fas fa-thumbs-up\\\" style=\\\"color:green\\\"></i>\");\n\n            $(\"#user_\"+rand_number).parent()\n                .prepend('<div>' + getTime() +' - User ' + usersList[number].id + ' fully treated <i class=\"fas fa-thumbs-up\" style=\"color:green\"></i></div>');                    \n\n            // Have we handled all users\n            // If not then restart at step2 for next user\n            if ((parseInt(number)+1) < usersList.length) {\n                number = userSteps[step].number;\n                loop_start = userSteps[step].start;\n                step = 'step2';\n            } else {\n                // Prepare list of users to be displayed\n                var htmlUsersList = '<i class=\"fas fa-info-circle mr-2\"></i>You could provide those unique codes to users by your own.<br>'+\n                    '<ul>';\n                $.each(usersList, function(index, user) {\n                    htmlUsersList += '<li>User: '+user.name+' '+user.lastname+' (login: '+user.login+') ; OneTime code: '+user.otp+'</li>'\n                });\n                htmlUsersList += '</ul>';\n\n                // Done\n                $(\"#user_\"+rand_number).parent()\n\t\t\t\t\t.prepend(\n\t\t\t\t\t\t'<div>' + getTime() +' - All keys have been generated for users <i class=\"fas fa-thumbs-up\" style=\"color:green\"></i>'+\n\t\t\t\t\t\t'<br>'+\n\t\t\t\t\t\t'<div type=\"button\" class=\"btn btn-primary btn-sm\" id=\"buttonListOfUsers\">Show/Hide list of users</div>'+\n\t\t\t\t\t\t'<div class=\"hidden alert alert-secondary mt-2\" id=\"htmlListOfUsers\" role=\"alert\">'+htmlUsersList+'</div>'+\n\t\t\t\t\t\t'</div>'\n\t\t\t\t\t);\n\n\t\t\t\t// Act on button click\n\t\t\t\t$(document).on('click', '#buttonListOfUsers', function() { \n\t\t\t\t\tif ($('#htmlListOfUsers').hasClass('hidden') === true) {\n\t\t\t\t\t\t$('#htmlListOfUsers').removeClass('hidden');\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$('#htmlListOfUsers').addClass('hidden');\n\t\t\t\t\t}\n\t\t\t\t});\n\n                console.log(usersList);\n                // Now send passwords\n                console.log(\"Send emails to users from now\");\n                sendPwdToUsers(usersList, true, 0, usersList.length);\n\n                return;\n            }\n        }\n        \n        if (usersList.length === 0 && step === 'step2' && loop_finished === 'true' && number === 0 && loop_start === 0) {\n            /* Unlock this step */\n            document.getElementById(\"but_next\").disabled = \"\";\n            document.getElementById(\"but_launch\").disabled = \"disabled\";\n            \n            $(\"#user_\"+rand_number).parent()\n                .prepend('<div>' + getTime() +' - All steps have been successfully performed <i class=\"fas fa-thumbs-up\" style=\"color:green\"></i></div>'); \n            return;\n        } else {\n            // Show progress\n            rand_number = createRandomId();\n            $(\"#step4_progress\").html(\"<div>\" + getTime() +\" - <span id='user_\"+rand_number+\"'>User \"+usersList[number].id+\" - Creating keys until \"+(loop_start + count_in_loop)+\" ... <i class=\\\"fas fa-cog fa-spin\\\" style=\\\"color:orange\\\"></i></span></div>\"+ $(\"#step4_progress\").html());\n\n            // Prepare user information                \n            userInfo = {\n                'id' : usersList[number].id,\n                'otp' : usersList[number].otp,\n                'public_key' : usersList[number].public_key,\n                'private_key' : usersList[number].private_key,\n                'login' : usersList[number].login,\n                'name' : encode_utf8(usersList[number].name),\n                'lastname' : encode_utf8(usersList[number].lastname),\n            };\n        }\n    }\n    // Migrate if needed all account to new AES encryption\n    //console.log('Posting number = '+number);\n    $.post(\n        \"upgrade_run_3.0.0_users.php\",\n        {\n            step : step,\n            number : number === 'init' ? '' : number,\n            userInfo : window.btoa(unescape(encodeURIComponent(JSON.stringify(userInfo)))),\n            start : loop_start,\n            count_in_loop : count_in_loop,\n            info : $('#infotmp').val(),\n            extra : number === 'end' ? 'all_users_created' : '',\n        },\n        function(data) {\n            //console.log(data[0]);\n            //console.log(JSON.parse(window.atob(data[0].rest)));\n            //console.log(JSON.parse(window.atob(data[0].data)));\n            previousStep = step;\n\n            if (data[0].finish !== \"1\") {\n                // Manage list of users that is provide on number = 0\n                if ((number) === 'init' && step === 'step1') {\n                    if (data[0].rest !== '') {\n                        usersRestList = JSON.parse(window.atob(data[0].rest));\n                    }else {\n                        usersRestList = '';\n                    }\n                    console.log(\"USERLIST = \"+usersRestList);\n                }\n\n                // loop\n                migrateUsersToV3(\n                    data[0].next,\n                    data[0].data,\n                    data[0].number,\n                    rand_number,\n                    loop_start,\n                    data[0].loop_finished\n                );\n            } else {\n                // Done\n                /* Unlock this step */\n                document.getElementById(\"but_next\").disabled = \"\";\n                document.getElementById(\"but_launch\").disabled = \"disabled\";\n            }\n        },\n        \"json\"\n    );\n}\n\n/**\n* \n */\nfunction sendPwdToUsers(usersList, init, cpt, total)\n{\n    var d = new Date();\n\n    // Inform\n    if (init === true) {\n        rand_number = createRandomId();\n        $(\"#step4_progress\").html(\"<div>\" + getTime() +\" - <span id='user_\"+rand_number+\"'>Now sending new users password by email ... \" +\n            \"<i class=\\\"fas fa-cog fa-spin\\\" style=\\\"color:orange\\\"></i><span id='sending_emails_pct' class='ml-3'>0%</span></div>\"+ $(\"#step4_progress\").html());\n    }\n    \n    // Prepare user data to be sent\n    userInfo = {\n        'id' : usersList[0].id,\n        'otp' : usersList[0].otp,\n    };\n    //console.log('Envoi email pour : ');\n    //console.log(userInfo);\n\n    // Remove user from list\n    usersList.shift();\n\n    // Send email for each user\n    $.post(\n        \"upgrade_run_3.0.0_users.php\",\n        {\n            step : 'send_pwd_by_email',\n            userInfo : window.btoa(JSON.stringify(userInfo))\n        },\n        function(data) {\n            //console.log(data);\n            //console.log('----');\n            // Done with sending the user email\n            if (usersList.length === 0) {\n                // all users have received their email\n                $(\"#user_\"+rand_number)\n                    .html(\"Emails were sent <i class=\\\"fas fa-thumbs-up\\\" style=\\\"color:green\\\"></i>\");\n\n                /* Unlock this step */\n                document.getElementById(\"but_next\").disabled = \"\";\n                document.getElementById(\"but_launch\").disabled = \"disabled\";\n                \n                $(\"#user_\"+rand_number).parent()\n                .prepend('<div>' + getTime() +' - All steps have been successfully performed <i class=\"fas fa-thumbs-up\" style=\"color:green\"></i></div>'); \n                \n            } else {\n                // current user received his email\n                // Send to the next one\n                $(\"#sending_emails_pct\").text(Math.round((cpt / total) * 100) + \"%\");\n\n                sendPwdToUsers(usersList, false, cpt++, total);\n            }\n        },\n        \"json\"\n    );\n}\n\nfunction runUpdate (script_file, type_parameter, start_at, noitems_by_loop, loop_number, file_number)\n{\n    var d = new Date(),\n        info = '';\n    loop_number ++;\n    var rand_number = createRandomId();\n\n    $(\"#step4_progress\").html(\"<div>\" + getTime() +\" - <i>\"+script_file+\"</i> - Loop #\"+loop_number+\" <span id='span_\"+rand_number+\"'>is now running ... <i class=\\\"fas fa-cog fa-spin\\\" style=\\\"color:orange\\\"></i></span></div>\"+ $(\"#step4_progress\").html());\n\n    if (type_parameter === 'user_id') {\n        info = $(\"#infotmp\").val();\n    }\n\n    request = $.post(\n        script_file,\n        {\n            type        : type_parameter,\n            start       : start_at,\n            total       : start_at,\n            nb          : noitems_by_loop,\n            session_salt: $(\"#session_salt\").val(),\n            info        : info,\n        },\n        function(data) {\n            console.info(type_parameter)\n            console.log(data)\n            // work not finished\n            if (data[0].finish !== \"1\") {\n                $(\"#span_\"+rand_number).html(\"<i class=\\\"fas fa-thumbs-up\\\" style=\\\"color:green\\\"></i>\")\n                // loop\n                runUpdate(script_file, type_parameter, data[0].next, noitems_by_loop, loop_number, file_number);\n            // is there an error\n            } else if (data[0].finish === \"1\" && data[0].error !== \"\") {\n                $(\"#span_\"+rand_number).html(\"<i class=\\\"fas fa-thumbs-down\\\" style=\\\"color:red\\\"></i>\");\n                $(\"#step4_progress\").html(\"<div style=\\\"margin:15px 0 15px 0; font-style:italic;\\\">\"+getTime() +\" - <b>ERROR</b>: \"+data[0].error+\"</div>\"+ $(\"#step4_progress\").html());\n                $(\"#step4_progress\").html(\"<div>An error occurred. Please check and relaunch.</div>\"+ $(\"#step4_progress\").html());\n            // work finished\n            } else {\n                $(\"#span_\"+rand_number).html(\"<i class=\\\"fas fa-thumbs-up\\\" style=\\\"color:green\\\"></i>\")\n                // continue with next script file\n                file_number ++;\n                manageUpgradeScripts(file_number);\n            }\n        },\n        \"json\"\n    );\n}\n\nfunction newEncryptPw(suggestion)\n{\n    var nb = 20;\n    var start = 0;\n\n    if ($(\"#change_pw_encryption_start\").val() != \"\") {\n        start = $(\"#change_pw_encryption_start\").val();\n    } else {\n        $(\"#change_pw_encryption_progress\").html('Progress: 0% <i class=\"fas fa-cog fa-spin fa-2x\"></i>');\n    }\n    var request = $.post(\"upgrade_ajax.php\",\n        {\n            type        : \"new_encryption_of_pw\",\n            start       : start,\n            total       : $(\"#change_pw_encryption_total\").val(),\n            suggestion  : suggestion,\n            nb          : nb\n        },\n        function(data) {\n            if (data[0].finish != 1 && data[0].finish != \"suggestion\") {\n                // handle re-encryption of passwords in Items table\n                $(\"#change_pw_encryption_start\").val(data[0].next);\n                $(\"#change_pw_encryption_progress\").html('Progress: '+data[0].progress+'% <i class=\"fas fa-cog fa-spin fa-2x\"></i>');\n                if (parseInt(start) < parseInt($(\"#change_pw_encryption_total\").val())) {\n                    newEncryptPw(\"0\");\n                }\n            } else if (data[0].finish == \"suggestion\") {\n                // handle the re-encryption of passwords in suggestion table\n                newEncryptPw(\"1\");\n            } else {\n                // handle finishing\n                $(\"#change_pw_encryption_progress\").html(\"Done\");\n                $(\"#but_encrypt_continu\").hide();\n                /* Unlock this step */\n                document.getElementById(\"but_next\").disabled = \"\";\n                document.getElementById(\"but_launch\").disabled = \"disabled\";\n                document.getElementById(\"res_step4\").innerHTML = \"dataBase has been populated\";\n                document.getElementById(\"loader\").style.display = \"none\";\n            }\n        },\n        \"json\"\n    );\n\n}\n\nfunction launch_database_dump() {\n    alertify\n        .message('<i class=\"fas fa-cog fa-spin fa-2x\"></i>', 0)\n        .dismissOthers();\n\n    request = $.post(\n        \"upgrade_ajax.php\",\n        {\n            type      : \"perform_database_dump\"\n        },\n        function(data) {\n            console.log(data)\n            if (data[0].error !== \"\") {\n                // ERROR\n                $(\"#dump_result\").html(data[0].error);\n\n                alertify\n                    .Error('Error', 1)\n                    .dismissOthers();\n            } else {\n                // DONE\n                $(\"#dump_result\").html('<div class=\"alert alert-info mt-2\">Dump is successfull. File stored in file <b>' + data[0].filename + '</b></div>');\n                $('#but_next').attr(\"disabled\", false);\n                alertify\n                    .success('Success', 1)\n                    .dismissOthers();\n            }\n        },\n        \"json\"\n    );\n}\n\nfunction createRandomId()\n{\n    var randLetter = String.fromCharCode(65 + Math.floor(Math.random() * 26));\n    return randLetter + Date.now();\n}\n\nfunction getTime()\n{\n    var d = new Date();\n    return (\"0\" +d.getHours()).slice(-2)+\":\"+(\"0\" + d.getMinutes()).slice(-2)+\":\"+(\"0\" + d.getSeconds()).slice(-2)\n}\n\nfunction encode_utf8( s )\n{\n  return unescape( encodeURIComponent( s ) );\n}\n\n</script>\n\n"], "filenames": ["error.php", "includes/core/load.js.php", "includes/core/logout.php", "install/css/install.css", "install/upgrade.php"], "buggy_code_start_loc": [106, 485, 41, 124, 279], "buggy_code_end_loc": [107, 1678, 70, 132, 280], "fixing_code_start_loc": [106, 485, 41, 123, 279], "fixing_code_end_loc": [107, 1678, 72, 123, 309], "type": "CWE-639", "message": "Authorization Bypass Through User-Controlled Key in GitHub repository nilsteampassnet/teampass prior to 3.0.0.23.", "other": {"cve": {"id": "CVE-2023-1463", "sourceIdentifier": "security@huntr.dev", "published": "2023-03-17T12:15:11.907", "lastModified": "2023-04-26T16:15:09.637", "vulnStatus": "Modified", "descriptions": [{"lang": "en", "value": "Authorization Bypass Through User-Controlled Key in GitHub repository nilsteampassnet/teampass prior to 3.0.0.23."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:L", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "NONE", "integrityImpact": "LOW", "availabilityImpact": "LOW", "baseScore": 5.4, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.5}], "cvssMetricV30": [{"source": "security@huntr.dev", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "LOW", "baseScore": 6.3, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 3.4}]}, "weaknesses": [{"source": "security@huntr.dev", "type": "Primary", "description": [{"lang": "en", "value": "CWE-639"}]}, {"source": "nvd@nist.gov", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-639"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:teampass:teampass:*:*:*:*:*:*:*:*", "versionEndExcluding": "3.0.0.23", "matchCriteriaId": "764C6217-B0DC-46BE-8785-63C62947781F"}]}]}], "references": [{"url": "https://github.com/nilsteampassnet/teampass/commit/4e06fbaf2b78c3615d0599855a72ba7e31157516", "source": "security@huntr.dev", "tags": ["Patch"]}, {"url": "https://huntr.dev/bounties/f6683c3b-a0f2-4615-b639-1920c8ae12e6", "source": "security@huntr.dev", "tags": ["Exploit", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/nilsteampassnet/teampass/commit/4e06fbaf2b78c3615d0599855a72ba7e31157516"}}