{"buggy_code": ["<?php\n    include_once(\"procStrategies.php\");\n\n\tsession_start();\n\t\n\t// \u0434\u043b\u044f \u0434\u0438\u043d\u0430\u043c\u0438\u0447\u0435\u0441\u043a\u043e\u0439 \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0438 \u0432 div'\u044b \u0442\u0443\u0440\u043d\u0438\u0440\u043e\u0432\n\t\n\t$nonUpdatableTournamentChuncks = array\n\t\t\t\t\t\t\t\t\t(\n\t\t\t\t\t\t\t\t\t\t'tournament', 'getSource', 'getLog', 'startRound', \n\t\t\t\t\t\t\t\t\t\t'jqueryUserStrategyDownloadStrategy', 'jqueryUserStrategySetActStatus',\n\t\t\t\t\t\t\t\t\t\t'visualize', 'jqueryResetTournamentState'\n\t\t\t\t\t\t\t\t\t);\n\t$unsetTournamentState = true;\n\t\n\tforeach ($nonUpdatableTournamentChuncks as $script)\n\t\t$unsetTournamentState = $unsetTournamentState & !stripos($_SERVER['PHP_SELF'], $script);\n\t\n\tif ($unsetTournamentState)\n\t{\n\t\tunset($_SESSION['tournamentState']);\n\t\tunset($_SESSION['tournamentDuel']);\n\t\tunset($_SESSION['roundResultsRoundId']);\n\t\tunset($_SESSION['roundTableRoundId']);\n\t}\n\t\n\t// \u0434\u043b\u044f \u0434\u0438\u043d\u0430\u043c\u0438\u0447\u0435\u0441\u043a\u043e\u0439 \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0438 \u0430\u0434\u043c\u0438\u043d\u043a\u0438\n\t\n\t$nonUpdatableAdminPanelChuncks = array\n\t\t\t\t\t\t\t\t\t\t(\n\t\t\t\t\t\t\t\t\t\t\t'adminPanel', 'jqueryGetRoundUsers', 'jqueryChecker', \n\t\t\t\t\t\t\t\t\t\t\t'jqueryAttachment', 'jqueryNews', 'jqueryTournament', \n\t\t\t\t\t\t\t\t\t\t\t'jqueryGetCheckerList', 'startRound', 'jqueryGame',\n\t\t\t\t\t\t\t\t\t\t\t'getChecker', 'jqueryGetNewRoundId', 'visualize', \n\t\t\t\t\t\t\t\t\t\t\t'jqueryFaq'\n\t\t\t\t\t\t\t\t\t\t);\n\t$unsetAdminPanelState = true;\n\t\n\tforeach ($nonUpdatableAdminPanelChuncks as $script)\n\t{\n\t\t$unsetAdminPanelState = $unsetAdminPanelState & !stripos($_SERVER['PHP_SELF'], $script);\n\t}\n\t\t\n\tif ($unsetAdminPanelState)\n\t{\n\t\t// \u0443\u0434\u0430\u043b\u044f\u0442\u044c\n\t\tunset($_SESSION['adminPanelState']);\n\t\tunset($_SESSION['adminGameId']);\n\t\tunset($_SESSION['adminAttachmentId']);\n\t\tunset($_SESSION['adminCheckerId']);\n\t\tunset($_SESSION['adminQuestionStatusId']);\n\t\tunset($_SESSION['adminQuestionId']);\n\t\tunset($_SESSION['adminNewsId']);\n\t\tunset($_SESSION['adminTournamentId']);\n\t\tunset($_SESSION['adminRoundId']);\n\t\tunset($_SESSION['adminImgTypeId']);\n\t\tunset($_SESSION['adminImgGameId']);\n\t}\n\n    function rusStatus($status)\n    {\n        if ($status == \"WIN 1\")\n            return \"\u0412\u044b\u0438\u0433\u0440\u0430\u043b \u043f\u0435\u0440\u0432\u044b\u0439 \u0438\u0433\u0440\u043e\u043a\";\n        if ($status == \"WIN 2\")\n            return \"\u0412\u044b\u0438\u0433\u0440\u0430\u043b \u0432\u0442\u043e\u0440\u043e\u0439 \u0438\u0433\u0440\u043e\u043a\";\n        if ($status == \"TIE\")\n            return \"\u041d\u0438\u0447\u044c\u044f\";\n        if ($status == \"IM 1\")\n            return \"\u041d\u0435\u0432\u0435\u0440\u043d\u044b\u0439 \u0445\u043e\u0434 \u043f\u0435\u0440\u0432\u043e\u0433\u043e \u0438\u0433\u0440\u043e\u043a\u0430\";\n        if ($status == \"IM 2\")\n            return \"\u041d\u0435\u0432\u0435\u0440\u043d\u044b\u0439 \u0445\u043e\u0434 \u0432\u0442\u043e\u0440\u043e\u0433\u043e \u0438\u0433\u0440\u043e\u043a\u0430\";\n        if ($status == \"RE 1\")\n            return \"\u041e\u0448\u0438\u0431\u043a\u0430 \u0432\u044b\u043f\u043e\u043b\u043d\u0435\u043d\u0438\u044f \u0443 \u043f\u0435\u0440\u0432\u043e\u0433\u043e \u0438\u0433\u0440\u043e\u043a\u0430\";\n        if ($status == \"RE 2\")\n            return \"\u041e\u0448\u0438\u0431\u043a\u0430 \u0432\u044b\u043f\u043e\u043b\u043d\u0435\u043d\u0438\u044f \u0443 \u0432\u0442\u043e\u0440\u043e\u0433\u043e \u0438\u0433\u0440\u043e\u043a\u0430\";\n         if ($status == \"TL 1\")\n            return \"\u041f\u0440\u0435\u0432\u044b\u0448\u0435\u043d \u043b\u0438\u043c\u0438\u0442 \u043f\u043e \u0432\u0440\u0435\u043c\u0435\u043d\u0438 \u0443 \u043f\u0435\u0440\u0432\u043e\u0433\u043e \u0438\u0433\u0440\u043e\u043a\u0430\";\n         if ($status == \"TL 2\")\n            return \"\u041f\u0440\u0435\u0432\u044b\u0448\u0435\u043d \u043b\u0438\u043c\u0438\u0442 \u043f\u043e \u0432\u0440\u0435\u043c\u0435\u043d\u0438 \u0443 \u0432\u0442\u043e\u0440\u043e\u0433\u043e \u0438\u0433\u0440\u043e\u043a\u0430\";\n         if ($status == \"ML 1\")\n            return \"\u041f\u0440\u0435\u0432\u044b\u0448\u0435\u043d \u043b\u0438\u043c\u0438\u0442 \u043f\u043e \u043f\u0430\u043c\u044f\u0442\u0438 \u0443 \u043f\u0435\u0440\u0432\u043e\u0433\u043e \u0438\u0433\u0440\u043e\u043a\u0430\";\n         if ($status == \"ML 2\")\n            return \"\u041f\u0440\u0435\u0432\u044b\u0448\u0435\u043d \u043b\u0438\u043c\u0438\u0442 \u043f\u043e \u043f\u0430\u043c\u044f\u0442\u0438 \u0443 \u0432\u0442\u043e\u0440\u043e\u0433\u043e \u0438\u0433\u0440\u043e\u043a\u0430\";\n        if ($status == \"IE\")\n            return \"\u0412\u043d\u0443\u0442\u0440\u0435\u043d\u043d\u044f\u044f \u043e\u0448\u0438\u0431\u043a\u0430\";\n        return $status;\n    }\n\t\n\tfunction clearTournamentState()\n\t{\n\t\tunset($_SESSION['tournamentState']);\n\t\tunset($_SESSION['tournamentDuel']);\n\t\tunset($_SESSION['roundResultsRoundId']);\n\t\tunset($_SESSION['roundTableRoundId']);\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u043b\u0438\u043d\u043a\u0430 \u0441\u043e\u0435\u0434\u0438\u043d\u0435\u043d\u0438\u044f \u0441 \u0411\u0414\n\tfunction getDBConnection()\n\t{\n\t\t$file = @file('authData.txt') or die(\"Can't find data file! <a href=install.php>Install system</a>\"); // 0 - login, 1 - password, 2 - DB's name\n\t\t\n\t\t$login = $file[0];\n\t\t$password = $file[1];\n\t\t// \u0423\u0434\u0430\u043b\u044f\u0435\u043c \u043b\u0438\u0448\u043d\u0438\u0435 \u043f\u0440\u043e\u0431\u0435\u043b\u044b\n\t\t$login = trim($login);\n\t\t$password = trim($password);\n\t\t$link = mysqli_connect('localhost', $login, $password) or die(\"Can't connect to DB: \".mysqli_error());\n\t\treturn $link;\n\t}\n\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u043d\u0430\u0437\u0432\u0430\u043d\u0438\u044f \u0411\u0414\n\tfunction getDBName()\n\t{\t\n\t\t$file = @file('authData.txt') or die(\"Can't find data file! <a href=install.php>Install system</a>\");\n\t\treturn trim($file[2]);\n\t}\n\t\n\t// \u0430\u043d\u0430\u043b\u043e\u0433 mysql_query\n\t// $query - \u0437\u0430\u043f\u0440\u043e\u0441, $row - \u0441\u0442\u0440\u043e\u043a\u0430 \u0432 \u0437\u0430\u043f\u0440\u043e\u0441\u0435, $field - \u043d\u043e\u043c\u0435\u0440 \u043f\u043e\u043b\u044f\n\tfunction mysqli_result($query, $row, $field = 0) \n\t{\n\t\tmysqli_data_seek($query, $row);\n\t\t$data = mysqli_fetch_array($query);\n\t\treturn $data[$field];\n\t} \n\t\n\t// \u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f (\u0435\u0441\u0442\u044c \u043b\u0438 \u043e\u043d \u043d\u0430 \u0441\u0430\u0439\u0442\u0435)\n\tfunction isActiveUser()\n\t{\n\t\treturn isset($_SESSION['SBUserid']) and isset($_SESSION['SBUserhash']);\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 ID \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f\n\tfunction getActiveUserID()\n\t{\n\t\tif (!isActiveUser())\n\t\t\treturn -1;\n\t\treturn $_SESSION['SBUserid'];\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u043d\u0438\u043a\u0430 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f\n\tfunction getActiveUserNickname()\n\t{\n\t\t$link = getDBConnection();\n\t\t\n\t\tif (isActiveUser() && mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$userId = intval($_SESSION['SBUserid']);\n\t\t\t$nickname = mysqli_query($link, \"SELECT login FROM users WHERE id=\".$userId.\" LIMIT 1\");\n\t\t\treturn mysqli_result($nickname, 0);\n\t\t}\n\t\telse return \"Anonymous\";\n\t}\n\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u0438\u043c\u0435\u043d\u0438 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f\n\tfunction getNicknameById($id = -1)\n\t{\n\t\t$link = getDBConnection();\n\t\tif ($id == -1) \n\t\t\t$id = getActiveUserID();\n\t\tif ($id != -1 && mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$id = intval($id);\n\t\t\t$userName = mysqli_query($link, \"SELECT login FROM users WHERE id = $id\");\n\t\t\treturn mysqli_result($userName, 0);\n\t\t} \n\t\telse \n\t\t\treturn \"Anonymous\";\t\n\t}\n\t\n    // \u041e\u0442\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u0435 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f\n    function logOff()\n    {\n        session_start();\n        session_unset();\n        session_destroy();\n        session_commit();\n        setcookie(session_name(), '', 0, '/');\n        session_regenerate_id(true);\n    }\n\t\n    // \u041f\u0440\u0438\u043d\u0430\u0434\u043b\u0435\u0436\u043d\u043e\u0441\u0442\u044c \u043a \u0433\u0440\u0443\u043f\u043f\u0435 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0435\u0439\n    function isUserInGroup($group, $id=\"\")\n    {\n        if (isset($_SESSION['SBUserid']))\n        {\n            $id = ($id == \"\") ? $_SESSION['SBUserid'] : intval($id);\n\t\t\t$link = getDBConnection();\n\t\t\tif (mysqli_select_db($link, getDBName()))\n\t\t\t{\n\t\t\t\t$groupExisting = false;\n\t\t\t\t$group = mysqli_real_escape_string($link, $group);\n\t\t\t\t$groupQuery = mysqli_query($link, \"SELECT `id` FROM `users` WHERE `group` = '$group'\");\n\t\t\t\twhile ($adminData = @mysqli_fetch_assoc($groupQuery))\n\t\t\t\t{\n\t\t\t\t\tif ($id === intval($adminData['id'])) \n\t\t\t\t\t{\t\n\t\t\t\t\t\t$groupExisting = true;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn $groupExisting;\n\t\t\t} else return false;\n\t\t} else return false;\n\t}\n\t\n\t// \u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f \u043d\u0430 \u043f\u0440\u0438\u043d\u0430\u0434\u043b\u0435\u0436\u043d\u043e\u0441\u0442\u044c \u043a\u0430\u0441\u0442\u0435 \u0430\u0434\u043c\u0438\u043d\u0438\u0441\u0442\u0440\u0430\u0442\u043e\u0440\u043e\u0432\n\tfunction isAdmin()\n\t{\n\t\treturn isUserInGroup('admin');\n\t}\n\t\n\t// \u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f \u043d\u0430 \u043f\u0440\u0438\u043d\u0430\u0434\u043b\u0435\u0436\u043d\u043e\u0441\u0442\u044c \u043a \u0441\u043e\u0437\u0434\u0430\u0442\u0435\u043b\u044f\u043c \u043d\u043e\u0432\u043e\u0441\u0442\u0435\u0439\n\tfunction isNewsMaker()\n\t{\n\t\treturn isUserInGroup('news');\n\t}\n\t\n\t// \u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f \u043d\u0430 \u043f\u0440\u0438\u043d\u0430\u0434\u043b\u0435\u0436\u043d\u043e\u0441\u0442\u044c \u043a \u043c\u043e\u0434\u0435\u0440\u0430\u0442\u043e\u0440\u0430\u043c\n\tfunction isModerator()\n\t{\n\t\treturn isUserInGroup('moder');\n    }\n\n    function isBanned()\n    {\n        return isUserInGroup('banned');\n    }\n\t\n\t// \u0413\u0435\u043d\u0435\u0440\u0430\u0446\u0438\u044f \u0443\u043d\u0438\u043a\u0430\u043b\u044c\u043d\u043e\u0433\u043e \u043a\u043e\u0434\u0430\n\tfunction generateUniqueCode($length=6) \n\t{\n\t\t$chars = \"abcdefghijklmnopqrstuvwxyzABCDEFGHI JKLMNOPRQSTUVWXYZ0123456789\";\n\t\t$code = \"\";\n\t\t$clen = strlen($chars) - 1;  \n\t\t\n\t\twhile (strlen($code) < $length) $code .= $chars[mt_rand(0, $clen)];  \n\t\treturn $code;\n\t}\n\t\n\t// \u0421\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0438\u0435 \u0444\u0430\u0439\u043b\u0430 \u043d\u0430 \u0434\u0438\u0441\u043a\n\tfunction saveFileOnDisc($path, $source, $fileTypes = NULL)\n\t{\n\t\tif (is_uploaded_file($_FILES[$source][\"tmp_name\"]))\n\t\t{\n\t\t\tif (!$fileTypes || ($fileTypes && in_array(pathinfo($_FILES[$source]['name'], PATHINFO_EXTENSION), $fileTypes)))\n\t\t\t{\n\t\t\t\tmove_uploaded_file($_FILES[$source]['tmp_name'], $path.$_FILES[$source]['name']);\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\telse if ($fileTypes != NULL) return \"\u041d\u0435 \u0442\u043e\u0442 \u0444\u043e\u0440\u043c\u0430\u0442 \u0437\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043c\u043e\u0433\u043e \u0444\u0430\u0439\u043b\u0430!\";\n\t\t} else return \"\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044c \u0444\u0430\u0439\u043b!\";\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u0440\u0430\u0441\u0448\u0438\u0440\u0435\u043d\u0438\u044f \u0444\u0430\u0439\u043b\u0430\n\tfunction getFileExtension($source)\n\t{\n\t\treturn pathinfo($_FILES[$source]['name'], PATHINFO_EXTENSION);\n\t}\n\n\t// \u0421\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0438\u0435 \u0444\u0430\u0439\u043b\u0430 \u043d\u0430 \u0434\u0438\u0441\u043a\n\tfunction saveFileOnDisc2($path, $source)\n\t{\n\t\treturn move_uploaded_file($_FILES[$source]['tmp_name'], $path);\n\t}\n\t\n\t// \u0420\u0435\u043a\u0443\u0440\u0441\u0438\u0432\u043d\u043e\u0435 \u0443\u0434\u0430\u043b\u0435\u043d\u0438\u0435 \u043f\u0430\u043f\u043a\u0438 \u0432\u043c\u0435\u0441\u0442\u0435 \u0441 \u0444\u0430\u0439\u043b\u0430\u043c\u0438\n\tfunction removeDir($path)\n\t{\n\t\tif (is_dir($path))\n\t\t{\n\t\t\t$handle = opendir($path);\n\t\t\twhile (($subfile = readdir($handle)) !== FALSE) \n\t\t\t{\n\t\t\t\tif ($subfile == '.' || $subfile == '..') continue;\n\t\t\t\tif (is_file($subfile)) \n\t\t\t\t\tunlink(\"$path/$subfile\");\n\t\t\t\telse \n\t\t\t\t\tremoveDir(\"$path/$subfile\");\n\t\t\t}\n\t\t\tclosedir($handle);\n\t\t\trmdir($path);\n\t\t} else unlink($path);\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u043e\u0447\u043a\u043e\u0432 \u0438\u0433\u0440\u043e\u043a\u0430 \u0432 \u0440\u0430\u0443\u043d\u0434\u0435\n\tfunction getPlayerScore($round, $strategy)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$round \t\t= intval($round);\n\t\t\t$strategy \t= intval($strategy);\n\t\t\t$query = mysqli_query($link, \"SELECT score FROM scores WHERE round = $round AND strategy = $strategy\");\n\t\t\treturn mysqli_result($query, 0);\n\t\t}\n\t}\n\t\n\t// \u0418\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u0435 \u043e\u0447\u043a\u043e\u0432 \u0438\u0433\u0440\u043e\u043a\u0430 \u0432 \u0440\u0430\u0443\u043d\u0434\u0435\n\tfunction setPlayerScore($round, $strategy, $value)\n\t{\n\t\t$score = intval(getPlayerScore($round, $strategy)) + $value;\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$round \t\t= intval($round);\n\t\t\t$strategy \t= intval($strategy);\n\t\t\tmysqli_query($link, \"UPDATE scores SET score = $score WHERE round = $round AND strategy = $strategy\");\n\t\t}\n\t}\n\t\n\tfunction getGameByDuel($duel)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$duel = intval($duel);\n\t\t\t$gameId = mysqli_query($link, \"SELECT games.id FROM games INNER JOIN strategies s ON games.id = s.game INNER JOIN duels ON duels.strategy1 = s.id WHERE duels.id = $duel\");\n\t\t\treturn mysqli_result($gameId, 0);\n\t\t}\n\t\treturn -1;\n\t}\n\n\tfunction getVisualizerByGame($gameId)\n\t{\n\t\tif ($gameId == -1)\n\t\t\treturn false;\n\t\telse\n\t\t{\n\t\t\t$link = getDBConnection();\n\t\t\tif (mysqli_select_db($link, getDBName()))\n\t\t\t{\n\t\t\t\t$gameId = intval($gameId);\n\t\t\t\treturn mysqli_result(mysqli_query($link, \"SELECT hasVisualizer FROM games WHERE id = $gameId\"), 0);\n\t\t\t}\n\t\t\telse return -1;\n\t\t}\n\t}\n\n    function isActiveUserHasAccessToDuel($duel)\n    {\n    \t$link = getDBConnection();\n        if (!mysqli_select_db($link, getDBName()))\n            return false;\n        \n        if (isAdmin())\n    \t    return true;\n        $userId = intval(getActiveUserID());\n        $duel = intval($duel);\n        $duelParams = mysqli_query($link, \"SELECT round, strategy1, strategy2 FROM duels WHERE id = $duel\");\n        $round = mysqli_result($duelParams, 0, 0);\n        $s1 = mysqli_result($duelParams, 0, 1);\n        $s2 = mysqli_result($duelParams, 0, 2);\n        if ($round != -1)\n        {\n            if (mysqli_result(mysqli_query($link, \"SELECT visible FROM rounds WHERE id=$round\"), 0) != true)\n                return false;\n            else\n                return true;\n        }\n        if (getUserIdByStrategy($s1) == $userId\n            || getUserIdByStrategy($s2) == $userId)\n        {\n            return true;\n        }\n\n    \treturn false;\n    }\n\n\t// \u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u043d\u0430\u0437\u0432\u0430\u043d\u0438\u0435 \u0438\u0433\u0440\u044b\n\tfunction getGameName($id = -1)\n\t{\n\t\t$link = getDBConnection();\n\t\t$id = intval($id);\n\t\tif ($id != -1 && mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$game = mysqli_query($link, \"SELECT name FROM games WHERE id = $id\");\n\t\t\treturn @mysqli_result($game, 0);\n\t\t} \n\t\telse \n\t\t\treturn \"Unknown\";\t\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u043c\u0430\u0441\u0441\u0438\u0432 \u0441 \u043d\u0430\u0437\u0432\u0430\u043d\u0438\u044f\u043c\u0438 \u0438\u0433\u0440\n\tfunction getGameArray()\n\t{\n\t\t$link = getDBConnection();\n\t\t$names = array();\n\t\t\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$query = mysqli_query($link, \"SELECT id, name FROM games\");\n\t\t\twhile ($data = mysqli_fetch_assoc($query))\n\t\t\t\t$names[$data['id']] = $data['name'];\n\t\t}\n\t\t\n\t\treturn $names;\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0432\u0441\u0435 \u0442\u0435\u043a\u0443\u0449\u0438\u0435 \u0442\u0443\u0440\u043d\u0438\u0440\u044b\n\tfunction getRunningAndClosedTournaments()\n\t{\n\t\t$link = getDBConnection();\n\t\t$tournaments = array();\n\t\t\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$query = mysqli_query($link, \"SELECT id, name FROM tournaments WHERE state = 'running' OR state = 'closed'\");\n\t\t\twhile ($data = mysqli_fetch_assoc($query))\n\t\t\t\t$tournaments[$data['id']] = $data['name'];\n\t\t}\n\t\t\n\t\treturn $tournaments;\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440 \u0438\u0433\u0440\u044b\n\tfunction getGameParameter($id, $parameter)\n\t{\n\t\t$link = getDBConnection();\n\t\t$id = intval($id);\n\t\tif ($id == -1 || $parameter == \"\" || !mysqli_select_db($link, getDBName()))\n\t\t\treturn \"Unknown\";\n\t\telse\n\t\t{\n\t\t\t$parameter = mysqli_real_escape_string($link, $parameter);\n\t\t\t$value = mysqli_query($link, \"SELECT {$parameter} FROM games WHERE id = $id\");\n\t\t\tif (mysqli_num_rows($value))\n\t\t\t\treturn @mysqli_result($value, 0);\n\t\t\telse return \"Unknown\";\n\t\t}\n\t}\n\t\n\t// \u0421\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0438\u0435 \u0442\u0435\u0441\u0442\u0435\u0440\u0430 \u0434\u043b\u044f \u0432\u044b\u0431\u0440\u0430\u043d\u043d\u043e\u0439 \u0438\u0433\u0440\u044b\n\tfunction saveTester($id, $source)\n\t{\n\t\t$path = addslashes(\"./testers/\").$id;\n\t\t$result = saveFileOnDisc2($path, $source);\n\t\t\n\t\tif ($result == false)\n\t\t\treturn -1;\n\t\telse\n\t\t{\n\t\t\t$output = array();\n            $answer = 0;\n            if (strtoupper(substr(PHP_OS, 0, 3)) === 'WIN')\n                $execResult = exec(\"clChecker.bat $id\", $output, $answer);\n            else\n                $execResult = exec(\"./gccChecker.sh $id\", $output, $answer);\n\t\t\treturn $answer;\n\t\t}\n\t\t\n\t}\n\n\t// \u0421\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0438\u0435 \u0432\u0438\u0437\u0443\u0430\u043b\u0438\u0437\u0430\u0442\u043e\u0440\u0430 \u0434\u043b\u044f \u0432\u044b\u0431\u0440\u0430\u043d\u043d\u043e\u0439 \u0438\u0433\u0440\u044b\n\tfunction saveVisualizer($id, $source)\n\t{\n\t\tif (isset($source) && $_FILES[$source][\"error\"] == 0)\n\t\t{\n\t\t\t$link = getDBConnection();\n\t\t\tif (mysqli_select_db($link, getDBName()))\n\t\t\t{\n\t\t\t\t$id = intval($id);\n\t\t\t\tmysqli_query($link, \"UPDATE Games SET hasVisualizer=1 WHERE id=\".$id.\";\");\n\t\t\t\t$path = addslashes(\"./visualizers/\").$id;\n\t\t\t\treturn saveFileOnDisc2($path, $source);\n\t\t\t}\n\t\t\telse return false;\n\t\t}\n\t\telse return false;\n\t}\n\t\n\t// \u0421\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0438\u0435 \u0430\u0442\u0442\u0430\u0447\u043c\u0435\u043d\u0442\u0430\n\tfunction saveAttachment($id, $source)\n\t{\n\t\tif ($_FILES[$source][\"error\"] == 0)\n\t\t{\n\t\t\t$path = addslashes(\"./attachments/\").$id;\n\t\t\treturn saveFileOnDisc2($path, $source);\n\t\t}\n\t}\n\t\n    // \u0420\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u044f\n    function registerUser($postLogin, $postPassword)\n    {\n        // $_POST['login']\n        // $_POST['password']\n        $link = getDBConnection();\n        $reason = \"\";\n        if (mysqli_select_db($link, getDBName()))\n        {\n            $err = array();\n\n            $login = strip_tags($postLogin);\n            if ($login != $postLogin)\n                $err[] = \"\u041b\u043e\u0433\u0438\u043d \u0441\u043e\u0434\u0435\u0440\u0436\u0438\u0442 \u043d\u0435\u043a\u043e\u0440\u0440\u0435\u043a\u0442\u043d\u044b\u0435 \u0441\u0438\u043c\u0432\u043e\u043b\u044b\";\n            $postLogin = mysqli_real_escape_string($link, $postLogin);\n            if (strlen($postLogin) < 3 or strlen($postLogin > 30))\n                $err[] = \"\u041b\u043e\u0433\u0438\u043d \u0434\u043e\u043b\u0436\u0435\u043d \u0431\u044b\u0442\u044c \u043d\u0435 \u043c\u0435\u043d\u044c\u0448\u0435 3-\u0445 \u0441\u0438\u043c\u0432\u043e\u043b\u043e\u0432 \u0438 \u043d\u0435 \u0431\u043e\u043b\u044c\u0448\u0435 30\";\n\n            $query = mysqli_query($link, \"SELECT COUNT(id) FROM users WHERE login='{$login}'\");\n\n            if (@mysqli_result($query, 0) > 0)\n                $err[] = \"\u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u0441 \u0442\u0430\u043a\u0438\u043c \u043b\u043e\u0433\u0438\u043d\u043e\u043c \u0443\u0436\u0435 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u0435\u0442 \u0432 \u0431\u0430\u0437\u0435 \u0434\u0430\u043d\u043d\u044b\u0445\";\n\n            if (count($err) == 0)\n            {\n                $password = md5(md5(trim($postPassword)));\n                mysqli_query($link, \"INSERT INTO users SET login='\".$postLogin.\"', password='$password'\");\n                $reason = \"\u0412\u044b \u0437\u0430\u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0438\u0440\u043e\u0432\u0430\u043d\u044b \u0432 \u0441\u0438\u0441\u0442\u0435\u043c\u0435!\";\n            }\n            else\n            {\n                $reason = \"<b>\u041f\u0440\u0438 \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438 \u043f\u0440\u043e\u0438\u0437\u043e\u0448\u043b\u0438 \u0441\u043b\u0435\u0434\u0443\u044e\u0449\u0438\u0435 \u043e\u0448\u0438\u0431\u043a\u0438:</b><br>\";\n                foreach($err as $error)\n                    $reason = $reason.$error.\"<br>\";\n            }\n        }\n        else\n        {\n            $reason = \"\u041d\u0435\u0442 \u0432\u043e\u0437\u043c\u043e\u0436\u043d\u043e\u0441\u0442\u0438 \u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0438\u0442\u044c\u0441\u044f \u043a \u0411\u0414!\";\n        }\n\n        return $reason;\n    }\n\n// \u0410\u0432\u0442\u043e\u0440\u0438\u0437\u0430\u0446\u0438\u044f\n\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u0434\u0430\u043d\u043d\u044b\u0445 \u043e \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0435 \u043f\u0440\u0438 \u0430\u0432\u0442\u043e\u0440\u0438\u0437\u0430\u0446\u0438\u0438\n\tfunction getAuthorizationData()\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t\t$query = mysqli_query($link, \"SELECT * FROM users WHERE login='\".mysqli_real_escape_string($link, $_POST['login']).\"' LIMIT 1\");\n\t\t$data = mysqli_fetch_assoc($query);\n\t\treturn $data;\n\t}\n\t\n\t// \u0417\u0430\u043f\u0438\u0441\u044c \u0434\u0430\u043d\u043d\u044b\u0445 \u043f\u0440\u0438 \u0430\u0432\u0442\u043e\u0440\u0438\u0437\u0430\u0446\u0438\u0438\n\tfunction LogIn($hash, $id)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$id = intval($id);\n\t\t\tmysqli_query($link, \"UPDATE users SET hash='\".$hash.\"' WHERE id='\".$id.\"'\");\n\t\t\t/*\n\t\t\tsetcookie(\"SBUserid\", $id, time()+60*60*24*30);\n\t\t\tsetcookie(\"SBUserhash\", $hash, time()+60*60*24*30);\n\t\t\t*/\n\t\t\t$_SESSION['SBUserid'] = $id;\n\t\t\t$_SESSION['SBUserhash'] = $hash;\n\t\t}\n\t}\n\t\n\t// \u0414\u0438\u0437\u0430\u0439\u043d\n\t\n\t// \u0412\u044b\u0432\u043e\u0434 \u0437\u0430\u0433\u043e\u043b\u043e\u0432\u043a\u0430 \u043d\u0430 \u044d\u043a\u0440\u0430\u043d\n\tfunction getPageHeaderByScriptName($scriptName)\n\t{\n\t\t//\n\t\t$headers = array\n\t\t(\n\t\t\t\"index.php\" \t\t\t\t=> \"AI Battle - \u0413\u043b\u0430\u0432\u043d\u0430\u044f\",\n\t\t\t\"userAuthorization.php\" \t=> \"AI Battle - \u0412\u0445\u043e\u0434\",\n\t\t\t\"userRegistration.php\" \t\t=> \"AI Battle - \u0420\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u044f\"\n\t\t);\n\t\t\n\t\tforeach ($headers as $script => $header)\n\t\t\tif (strpos($scriptName, $script))\n\t\t\t\treturn $header;\n\t}\n\t\n\t// \u0412\u044b\u0434\u0435\u043b\u0435\u043d\u0438\u0435 \u0430\u043a\u0442\u0438\u0432\u043d\u043e\u0439 \u0432\u043a\u043b\u0430\u0434\u043a\u0438\n\tfunction getActiveNavbarElement($role, $scriptName)\n\t{\n\t\t$elements = array\n\t\t(\n\t\t\t\"news\" => \"index.php\", \n\t\t\t\"tournament\" => \"tournament.php\", \n\t\t\t\"game\" => \"game.php\", \n\t\t\t\"users\" => \"users.php\", \n\t\t\t\"faq\" => \"faq.php\",\n\t\t\t\"adminPanel\" => \"adminPanel.php\"\n\t\t);\n\t\t\n\t\tforeach ($elements as $key => $element)\n\t\t{\n\t\t\tif ($role == $key && strpos($scriptName, $element))\n\t\t\t{\n\t\t\t\treturn \"active\";\n\t\t\t}\n\t\t}\n\t\t\t\t\n\t\treturn \"\";\n\t}\n\t\n\t// \u0422\u0443\u0440\u043d\u0438\u0440\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u0438 \u043e \u0442\u0443\u0440\u043d\u0438\u0440\u0435\n\tfunction getTournamentData($tournamentId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$tournamentId = intval($tournamentId);\n\t\t\t$query = mysqli_query($link, \"SELECT * FROM tournaments WHERE id = $tournamentId LIMIT 1\");\n\t\t\t$data = mysqli_fetch_assoc($query);\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\t\n\t\treturn $data; \n\t}\n\t\n\t// \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u0438\u0433\u0440\u044b \u043f\u043e \u0442\u0443\u0440\u043d\u0438\u0440\u0443\n\tfunction getGameByTournament($tournamentId)\n\t{\n\t\tif ($tournamentId == -1)\n\t\t\treturn -1;\n\t\telse \n\t\t{\n\t\t\t$data = getTournamentData($tournamentId);\n\t\t\treturn $data['game'];\n\t\t}\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u043e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 \u0438\u0433\u0440\u044b\n\tfunction getGameDescription($gameId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$gameDescription = \"none\";\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$gameId = intval($gameId);\n\t\t\t$query = mysqli_query($link, \"SELECT description FROM games WHERE id = $gameId LIMIT 1\");\n\t\t\t$data = mysqli_fetch_assoc($query);\n\t\t\t$gameDescription = $data['description'];\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $gameDescription;\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u043e\u043f\u0438\u0441\u0430\u043d\u0438\u044f \u0442\u0443\u0440\u043d\u0438\u0440\u0430\n\tfunction getTournamentDescriptionByTournamentId($tournamentId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$tournamentDescription = \"none\";\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$tournamentId = intval($tournamentId);\n\t\t\t$query = mysqli_query($link, \"SELECT description FROM tournaments WHERE id = $tournamentId LIMIT 1\");\n\t\t\t$data = mysqli_fetch_assoc($query);\n\t\t\t$tournamentDescription = $data['description'];\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $tournamentDescription;\n\t}\n\t\n\t// \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u043c\u0430\u0441\u0441\u0438\u0432\u0430 attachment'\u043e\u0432\n\tfunction getGameAttachments($gameId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$attachments = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$gameId = intval($gameId);\n\t\t\t$query = mysqli_query($link, \"SELECT * FROM attachments WHERE game = $gameId\");\n\t\t\twhile ($data = mysqli_fetch_assoc($query))\n\t\t\t\t$attachments[$data['id']] = array('originalName' => $data['originalName'], 'description' => $data['description']);\n\t\t}\n\t\treturn $attachments;\n\t}\n\t\n    // \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u0441\u0442\u0440\u0430\u0442\u0435\u0433\u0438\u0439 \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0435\u043d\u043d\u043e\u0433\u043e \u044e\u0437\u0435\u0440\u0430\n    function getUserStrategies($gameId, $userId, $tournamentId, $ok, $first=0, $size=-1)\n    {\n        $link = getDBConnection();\n        $strategies = array();\n        if (mysqli_select_db($link, getDBName()))\n        {\n            $gameId = intval($gameId);\n            $userId = intval($userId);\n            $tournamentId = intval($tournamentId);\n            $sql = \"SELECT id, user, status FROM strategies WHERE game = $gameId AND user = $userId AND tournament = $tournamentId \";\n            if ($ok)\n                $sql .= \" AND (status = 'OK' OR status = 'ACT') \";\n            $query = mysqli_query($link, $sql . \" ORDER BY id DESC\".(($size != -1) ? \" LIMIT $first, $size\" : \" \"));\n            while ($data = mysqli_fetch_assoc($query))\n                $strategies[] = $data;\n        }\n        return $strategies;\n    }\n\n\tfunction getUserMessages($first=0, $size=-1, $id = 0, $notreaded = false)\n    {\n        if (!isActiveUser())\n            return false;\n\t\t$link = getDBConnection();\n        $messages = array();\n\t\tmysqli_select_db($link, getDBName());\n        $userId = intval(getActiveUserID());\n\t\t$query = mysqli_query($link, \"SELECT * FROM `privateMessages` WHERE (`sender` = $userId OR `recevier` = $userId) \".($id != 0 ? \" AND id=\".$id : \"\").($notreaded ? \" AND viewed=0\" : \"\").\" ORDER BY id DESC\".(($size != -1) ? \" LIMIT $first, $size\" : \" \"));\n\t    while ($data = mysqli_fetch_assoc($query))\n            $messages[$data['id']] = array(\n                'sender' => $data['sender'],\n                'recevier' => $data['recevier'],\n                'title' => $data['title'],\n                'text' => $data['text'],\n                'date' => $data['date'],\n                'viewed' => (($data['sender'] == $userId) ? 1 : $data['viewed'])\n            );\n\t\treturn $messages;\n    }\n\n    function postMessage($recevier, $title, $text)\n    {\n        if (!isActiveUser())\n            return false;\n        $link = getDBConnection();\n        $messages = array();\n        mysqli_select_db($link, getDBName());\n        $userId = intval(getActiveUserID());\n        $recevier = intval($recevier);\n        $title = mysqli_real_escape_string($link, $title);\n        $text = mysqli_real_escape_string($link, $text);\n        $query = mysqli_query($link, \"INSERT INTO `privateMessages` VALUES (NULL, $userId, $recevier, '$title', '$text', 0, 0)\");\n        if ($query)\n            return true;\n        return false;\n    }\n\n    function markMessageAsViewed($id)\n    {\n        if (!isActiveUser())\n            return false;\n        $userId = intval(getActiveUserID());\n        $id = intval($id);\n        $messages = getUserMessages(0, -1, $id);\n        if (!isset($messages[$id]))\n            return false;\n        $link = getDBConnection();\n        mysqli_select_db($link, getDBName());\n        if (mysqli_query($link, \"UPDATE `privateMessages` SET `viewed`=1 WHERE `id`=$id\"))\n            return true;\n        return false;\n    }\n\n    function getNotViewedMessages()\n    {\n        if (!isActiveUser())\n            return 0;\n        $userId = intval(getActiveUserID());\n        $link = getDBConnection();\n        mysqli_select_db($link, getDBName());\n        $query = mysqli_query($link, \"SELECT COUNT(*) FROM `privateMessages` WHERE viewed=0 AND recevier = $userId\");\n        $res = mysqli_fetch_array($query);\n        return $res[0];      \n    }\n\n\t\n\t// \u043f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 \u043d\u0430 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u043e\u0432\u0430\u043d\u0438\u0435 \u0438\u0433\u0440\u044b \u0441 \u0432\u044b\u0431\u0440\u0430\u043d\u043d\u044b\u043c ID\n\tfunction isGameExists($gameID)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t\treturn mysqli_num_rows(mysqli_query($link, \"SELECT * FROM `games` WHERE id = \". intval($gameID))) > 0;\n\t\t\n\t}\n\t\n\t// \u0414\u0443\u044d\u043b\u0438\n\tfunction getUserStrategy($gameId, $tournamentId)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$gameId = intval($gameId);\n\t\t\t$tournamentId = intval($tournamentId);\n\t\t\treturn mysqli_query($link, \"SELECT id FROM strategies WHERE tournament = $tournamentId AND game = $gameId AND status = 'ACT' AND user=\".intval(getActiveUserID()));\n\t\t}\n    }\n\t\n\tfunction getDuels($roundId, $gameId, $userId, $tournamentId = -1, $start = 0, $limit = -1)\n\t{\n\t\n\t\t$roundId \t\t= intval($roundId);\n\t\t$gameId \t\t= intval($gameId);\n\t\t$userId\t\t\t= intval($userId);\n\t\t$tournamentId \t= intval($tournamentId);\n\t\t\n\t\t$query = \"SELECT duels.id AS id, duels.status AS status, strategy1, strategy2, s1.user AS user1, s2.user AS user2 FROM duels\";\n\t\t$query .= \" INNER JOIN strategies s1 ON duels.strategy1 = s1.id INNER JOIN strategies s2 ON duels.strategy2 = s2.id\";\n\t\t$query .= \" INNER JOIN games ON games.id = s1.game AND games.id = s2.game\";\n\t\tif (!isAdmin() && $roundId != -1)\n\t\t\t$query .= \" INNER JOIN rounds ON rounds.id = duels.round\";\n\t\t$query .= \" WHERE duels.round = $roundId AND games.id = $gameId\";\n\t\tif (!isAdmin() && $roundId != -1)\n\t\t\t$query .= \" AND rounds.visible = true\";\n\t\tif (!isAdmin())\n\t\t\t$query .= \" AND (s1.user = $userId OR s2.user = $userId)\";\n\t\t\n\t\tif ($tournamentId != -1)\n\t\t\t$query .= \" AND (s1.tournament = $tournamentId AND s2.tournament = $tournamentId)\";\n\t\t\t\t\t\n        $query .= \" ORDER BY id DESC\";\n        if ($limit != -1)\n            $query.= \" LIMIT $start, $limit\";\n\t\t\n\t\t//echo $query;\n\t\t\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$duels = mysqli_query($link, $query);\n\t\t\t\n\t\t\t$data = array();\n\t\t\twhile ($row = mysqli_fetch_assoc($duels))\n\t\t\t\t$data[] = $row;\n\t\t\t\t\n\t\t\tmysqli_free_result($duels);\n\t\t\n\t\t\treturn $data;\n\t\t}\n\t\telse return array();\n    }\n\n    function getDuelsCount($roundId, $gameId, $userId, $tournamentId = -1)\n\t{\n\t\n\t\t$roundId \t\t= intval($roundId);\n\t\t$gameId \t\t= intval($gameId);\n\t\t$userId\t\t\t= intval($userId);\n\t\t$tournamentId \t= intval($tournamentId);\n\t\t\n\t\t$query = \"SELECT COUNT(*) FROM duels\";\n\t\t$query .= \" INNER JOIN strategies s1 ON duels.strategy1 = s1.id INNER JOIN strategies s2 ON duels.strategy2 = s2.id\";\n\t\t$query .= \" INNER JOIN games ON games.id = s1.game AND games.id = s2.game\";\n\t\tif (!isAdmin() && $roundId != -1)\n\t\t\t$query .= \" INNER JOIN rounds ON rounds.id = duels.round\";\n\t\t$query .= \" WHERE duels.round = $roundId AND games.id = $gameId\";\n\t\tif (!isAdmin() && $roundId != -1)\n\t\t\t$query .= \" AND rounds.visible = true\";\n\t\tif (!isAdmin())\n\t\t\t$query .= \" AND (s1.user = $userId OR s2.user = $userId)\";\n\t\t\n\t\tif ($tournamentId != -1)\n\t\t\t$query .= \" AND (s1.tournament = $tournamentId AND s2.tournament = $tournamentId)\";\n\t\t\t\t\t\n\t\t\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$duels = mysqli_query($link, $query);\n\t\t\t\n\t\t\t$data = mysqli_fetch_array($duels);\n\t\t\t\t\n\t\t\tmysqli_free_result($duels);\n\t\t\n\t\t\treturn $data[0];\n\t\t}\n\t\telse return 0;\n\t}\n\t\n\tfunction getDuelHeader($roundId, $gameId)\n\t{\n\t\t$header = \"\";\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$gameId \t= intval($gameId);\n\t\t\t$roundId \t= intval($roundId);\n\t\t\t$gameName \t= mysqli_result(mysqli_query($link, \"SELECT name FROM games WHERE id = $gameId\"), 0);\n\t\t\tif ($roundId == -1)\n\t\t\t\t$header = \"\u0422\u0440\u0435\u043d\u0438\u0440\u043e\u0432\u043a\u0430\";\n\t\t\telse\n\t\t\t{\n\t\t\t\t$roundName \t= mysqli_result(mysqli_query($link, \"SELECT name FROM rounds WHERE id = $roundId\"), 0);\n\t\t\t\t$header = \"\u041f\u0430\u0440\u0442\u0438\u0438 \u0440\u0430\u0443\u043d\u0434\u0430 \".$roundName;\n\t\t\t}\n\t\t\t\n\t\t\t$header = $header . \" \u0438\u0433\u0440\u044b \".$gameName;\n\t\t}\n\t\treturn $header;\n\t}\n\t\n\t// \u0440\u0430\u0443\u043d\u0434\u044b\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0440\u0430\u0443\u043d\u0434\u044b \u0442\u0443\u0440\u043d\u0438\u0440\u0430\n\tfunction getTournamentRounds($tournamentId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$tournamentId = intval($tournamentId);\n\t\t\t$query = mysqli_query($link, \"SELECT * FROM rounds WHERE tournament = $tournamentId\");\n\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t$data[] = $row;\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\t// \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0442\u0435\u043a\u0443\u0449\u0443\u044e \u0441\u0442\u0440\u0430\u0442\u0435\u0433\u0438\u044e\n\tfunction getCurrentStrategy($userId, $tournamentId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$strategyId = -1;\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$userId \t\t= intval($userId);\n\t\t\t$tournamentId \t= intval($tournamentId);\n\t\t\t$query = mysqli_query($link, \"SELECT id FROM strategies WHERE user = $userId AND tournament = $tournamentId AND status = 'ACT'\");\n\t\t\t$data = mysqli_fetch_assoc($query);\n\t\t\t$strategyId = $data['id'];\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $strategyId;\n\t}\n\t\n\t// \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0442\u0435\u043a\u0443\u0449\u0438\u0445 \u0438\u0433\u0440\u043e\u043a\u043e\u0432 \u0440\u0430\u0443\u043d\u0434\u0430\n\tfunction getRoundPlayers($roundId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$roundId = intval($roundId);\n\t\t\t$query = mysqli_query($link, \"SELECT user FROM roundActivity WHERE round = $roundId AND state = 'ACT'\");\n\t\t\t\n\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t$data[] = getCurrentStrategy($row['user'], mysqli_result(mysqli_query($link, \"SELECT tournament FROM rounds WHERE id = $roundId\"), 0));\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\t// \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u044e \u043e \u0440\u0430\u0443\u043d\u0434\u0435\n\tfunction getRoundData($roundId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$roundId = intval($roundId);\n\t\t\t$query = mysqli_query($link, \"SELECT * FROM rounds WHERE id = $roundId\");\n\t\t\t\n\t\t\tif ($row = mysqli_fetch_assoc($query))\n\t\t\t{\n\t\t\t\t$data['id'] \t\t= $row['game'];\n\t\t\t\t$data['tournament']\t= $row['tournament'];\n\t\t\t\t$data['game']\t\t= $row['game'];\n\t\t\t\t$data['name'] \t\t= $row['name'];\n\t\t\t\t$data['date'] \t\t= $row['date'];\n\t\t\t\t$data['visible'] \t= $row['visible'];\n\t\t\t}\n\t\t\tif (!$row || (!isAdmin() && !$data['visible']))\n            {\n\t\t\t\t$data['id'] \t\t= -1;\n\t\t\t\t$data['tournament']\t= \"Unknown\";\n\t\t\t\t$data['game']\t\t= \"Unknown\";\n\t\t\t\t$data['name'] \t\t= \"Unknown\";\n\t\t\t\t$data['date'] \t\t= \"Unknown\";\n\t\t\t\t$data['visible'] \t= false;\n\t\t\t}\n\t\t\t\n\t\t\tmysqli_free_result($query);\n\t\t\t\n\t\t\t$query = mysqli_query($link, \"SELECT * FROM games WHERE id = {$data['id']}\");\n\t\t\tif ($row = mysqli_fetch_assoc($query))\n\t\t\t\t$data['gameName'] = $row['name'];\n\t\t\telse\n\t\t\t\t$data['gameName'] = \"Unknown\";\n\t\t\t\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0442\u0443\u0440\u043d\u0438\u0440 \u043f\u043e \u0440\u0430\u0443\u043d\u0434\u0443\n\tfunction getTournamentByRound($roundId)\n\t{\n\t\t$roundData = getRoundData($roundId);\n\t\treturn $roundData['tournament'];\n\t}\n\t\n\t// \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u044e\u0437\u0435\u0440\u043e\u0432 \u0438 \u043e\u0447\u043a\u0438 \u0432 \u0440\u0430\u0443\u043d\u0434\u0435\n\tfunction getUsersRoundScores($roundId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$roundId = intval($roundId);\n\t\t\t$query = mysqli_query($link, \"SELECT users.login AS name, users.id AS id, score FROM scores INNER JOIN strategies ON scores.strategy = strategies.id INNER JOIN users ON strategies.user = users.id WHERE scores.round = $roundId ORDER BY score DESC\");\n\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t$data[] = $row;\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n    \n    // \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u044e\u0437\u0435\u0440\u043e\u0432 \u0438 \u043e\u0447\u043a\u0438 \u0432 \u0440\u0430\u0443\u043d\u0434\u0435 \u0431\u0435\u0437 \u0441\u043e\u0440\u0442\u0438\u0440\u043e\u0432\u043a\u0438\n\tfunction getUsersRoundScoresNoSort($roundId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$roundId = intval($roundId);\n\t\t\t$query = mysqli_query($link, \"SELECT users.login AS name, users.id AS id, score FROM scores INNER JOIN strategies ON scores.strategy = strategies.id INNER JOIN users ON strategies.user = users.id WHERE scores.round = $roundId\");\n\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t$data[] = $row;\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\t// \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u044e \u043f\u043e \u0442\u0430\u0431\u043b\u0438\u0446\u0435 \u0440\u0430\u0443\u043d\u0434\u0430\n\tfunction getRoundTable($roundId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$roundId = intval($roundId);\n\t\t\t$query = mysqli_query($link, \"SELECT users.id AS id, users.login AS name, score FROM scores INNER JOIN strategies ON scores.strategy = strategies.id INNER JOIN users ON strategies.user = users.id WHERE scores.round = $roundId ORDER BY score DESC\");\n\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t$data[] = $row;\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\t// \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0441\u0442\u0430\u0442\u0443\u0441 \u0434\u0443\u044d\u043b\u0438\n\tfunction getDuelStatus($roundId, $user1, $user2)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = \"\";\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$roundId \t= intval($roundId);\n\t\t\t$user1 \t\t= intval($user1);\n\t\t\t$user2 \t\t= intval($user2);\n\t\t\t$query = mysqli_query($link, \"SELECT duels.status AS status, duels.id AS id FROM duels INNER JOIN strategies s1 ON duels.strategy1 = s1.id INNER JOIN strategies s2 ON duels.strategy2 = s2.id WHERE duels.round = $roundId AND s1.user = $user1 AND s2.user = $user2\");\n\t\t\t$data = mysqli_fetch_assoc($query);\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\t// Admin Panel\n\t\n\t// \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0434\u0430\u043d\u043d\u044b\u0435 \u043f\u043e \u0438\u0433\u0440\u0430\u043c\n\tfunction getTournamentList($tournamentId = -1)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$tournamentId = intval($tournamentId);\n\t\t\tif ($tournamentId == -1)\n\t\t\t\t$query = mysqli_query($link, \"SELECT id, name FROM tournaments\");\n\t\t\telse\n\t\t\t\t$query = mysqli_query($link, \"SELECT * FROM tournaments WHERE id = $tournamentId\");\n\t\t\t\t\n\t\t\tif ($tournamentId == -1)\n\t\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t\t$data[] = $row;\n\t\t\telse\n\t\t\t\t$data = mysqli_fetch_assoc($query);\n\t\t\t\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\t// \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0441\u043f\u0438\u0441\u043e\u043a \u0438\u0433\u0440\n\tfunction getGameList($gameId = -1)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$gameId = intval($gameId);\n\t\t\tif ($gameId == -1)\n\t\t\t\t$query = mysqli_query($link, \"SELECT * FROM games\");\n\t\t\telse\n\t\t\t\t$query = mysqli_query($link, \"SELECT * FROM games WHERE id = $gameId\");\n\t\t\t\n\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t$data[] = $row;\n\t\t\t\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\t// \u0441\u043e\u0437\u0434\u0430\u0442\u044c \u0442\u0443\u0440\u043d\u0438\u0440\n\tfunction createNewTournament($name, $game, $description, $state, $checker)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$name \t\t\t= mysqli_real_escape_string($link, $name);\n\t\t\t$description \t= mysqli_real_escape_string($link, $description);\n\t\t\t$state\t\t\t= mysqli_real_escape_string($link, $state);\n\t\t\t$game\t\t\t= intval($game);\n\t\t\t$checker\t\t= intval($checker);\n\t\t\t\n\t\t\tif (mysqli_query($link, \"INSERT INTO tournaments SET name = '$name', game = $game, description = '$description', state = '$state', defaultChecker = $checker\"))\n\t\t\t\treturn 0;\n\t\t\telse\n\t\t\t\treturn 1;\n\t\t}\n\t\telse return 2;\n\t}\n\t\n\t// \u043e\u0431\u043d\u043e\u0432\u0438\u0442\u044c \u0442\u0443\u0440\u043d\u0438\u0440\n\tfunction updateTournament($id, $name, $game, $description, $state, $checker)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$id \t\t\t= intval($id);\n\t\t\t$game \t\t\t= intval($game);\n\t\t\t$checker \t\t= intval($checker);\n\t\t\t$name\t\t\t= mysqli_real_escape_string($link, $name);\n\t\t\t$description \t= mysqli_real_escape_string($link, $description);\n\t\t\t$state\t\t\t= mysqli_real_escape_string($link, $state);\n\t\t\t\n\t\t\tif (mysqli_query($link, \"UPDATE tournaments SET name = '$name', game = $game, description = '$description', state = '$state', defaultChecker = $checker WHERE id = $id\"))\n\t\t\t\treturn 0;\n\t\t\telse\n\t\t\t\treturn 1;\n\t\t}\n\t\telse return 2;\n\t}\n\t\n\t// \u0443\u0434\u0430\u043b\u0438\u0442\u044c \u0442\u0443\u0440\u043d\u0438\u0440\n\tfunction deleteTournament($id)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$id = intval($id);\n\t\t\tif (mysqli_query($link, \"DELETE FROM tournaments WHERE id = $id\"))\n\t\t\t\treturn 0;\n\t\t\telse\n\t\t\t\treturn 1;\n\t\t}\n\t\telse return 2;\n\t}\n\t\n\t// \u0441\u043e\u0437\u0434\u0430\u0442\u044c \u0438\u0433\u0440\u0443\n\tfunction createGame($name, $description, $visualizer, $timeLimit, $memoryLimit)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$name \t\t\t= mysqli_real_escape_string($link, $name);\n\t\t\t$description \t= mysqli_real_escape_string($link, $description);\n\t\t\t$timeLimit \t\t= intval($timeLimit);\n\t\t\t$memoryLimit \t= intval($memoryLimit);\n\t\t\t\n\t\t\t$queryText = \"INSERT INTO games SET name = '$name', description = '$description'\";\n\t\t\tif ($timeLimit != \"\")\n\t\t\t\t$queryText .= \", timeLimit = $timeLimit\";\n\t\t\tif ($memoryLimit != \"\")\n\t\t\t\t$queryText .= \", memoryLimit = $memoryLimit\";\n\t\t\t\t\n\t\t\tif (mysqli_query($link, $queryText))\n\t\t\t{\n\t\t\t\t$gameId = mysqli_insert_id($link);\n\t\t\t\n\t\t\t\tif ($_FILES[$visualizer][\"error\"] == 0)\n\t\t\t\t{\n\t\t\t\t\t$result = saveVisualizer($gameId, $visualizer);\n\t\t\t\t\tif ($result == true)\n\t\t\t\t\t\treturn 0;\n\t\t\t\t\telse\n\t\t\t\t\t\treturn -1;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tmysqli_query($link, \"DELETE FROM games WHERE id = $gameId\");\n\t\t\t\t\treturn 1;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse return 2;\n\t\t}\n\t\telse return 3;\n\t}\n\t\n\t// \u043e\u0431\u043d\u043e\u0432\u0438\u0442\u044c \u0438\u0433\u0440\u0443\n\tfunction updateGame($id, $name, $description, $visualizer, $timeLimit, $memoryLimit)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$id \t\t\t= intval($id);\n\t\t\t$name \t\t\t= mysqli_real_escape_string($link, $name);\n\t\t\t$description \t= mysqli_real_escape_string($link, $description);\n\t\t\t$timeLimit \t\t= intval($timeLimit);\n\t\t\t$memoryLimit \t= intval($memoryLimit);\n\t\t\t\n\t\t\tif (mysqli_query($link, \"UPDATE games SET name = '$name', description = '$description', timeLimit = $timeLimit, memoryLimit = $memoryLimit WHERE id = $id\"))\n\t\t\t{\n\t\t\t\tif ($_FILES[$visualizer][\"error\"] == 0)\n\t\t\t\t{\n\t\t\t\t\t$result = saveVisualizer($id, $visualizer);\n\t\t\t\t\tif ($result == true)\n\t\t\t\t\t\treturn 0;\n\t\t\t\t\telse\n\t\t\t\t\t\treturn -1;\n\t\t\t\t}\n\t\t\t\telse return 1;\n\t\t\t}\n\t\t\telse return 2;\n\t\t}\n\t\telse return 3;\n\t}\n\t\n\t// \u0443\u0434\u0430\u043b\u0438\u0442\u044c \u0438\u0433\u0440\u0443\n\tfunction deleteGame($gameId)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$gameId = intval($gameId);\n\t\t\tif (mysqli_query($link, \"DELETE FROM games WHERE id = $gameId\"))\n\t\t\t\treturn 0;\n\t\t\telse\n\t\t\t\treturn 1;\n\t\t}\n\t\telse return 2;\n\t}\n\t\n\t// \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u043f\u0443\u0442\u044c \u043a \u0432\u0438\u0437\u0443\u0430\u043b\u0438\u0437\u0430\u0442\u043e\u0440\u0443\n\tfunction getVisualizerPath($id)\n\t{\n\t\treturn addslashes(\"./visualizers/\").$id;\n\t}\n\t\n\t// \u0443\u0434\u0430\u043b\u0438\u0442\u044c \u0432\u0438\u0437\u0443\u0430\u043b\u0438\u0437\u0430\u0442\u043e\u0440\n\tfunction deleteVizualizer($gameId)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$gameId = intval($gameId);\n\t\t\tif (mysqli_query($link, \"UPDATE games SET hasVisualizer = 0 WHERE id = $gameId\"))\n\t\t\t{\n\t\t\t\tremoveDir(getVisualizerPath($gameId));\n\t\t\t\tif (!file_exists(getVisualizerPath($gameId)))\n\t\t\t\t\treturn 0;\n\t\t\t\telse\n\t\t\t\t\treturn -1;\n\t\t\t}\n\t\t\telse return 1;\n\t\t}\n\t\telse return 2;\n\t}\n\t\n\t// \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0441\u043f\u0438\u0441\u043e\u043a \u0440\u0430\u0443\u043d\u0434\u043e\u0432 \u0442\u0443\u0440\u043d\u0438\u0440\u0430\n\tfunction getRoundList($tournamentId, $roundId = -1)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$tournamentId \t= intval($tournamentId);\n\t\t\t$roundId\t\t= intval($roundId);\n\t\t\t$text = \"SELECT * FROM rounds WHERE tournament = $tournamentId\";\n\t\t\tif ($roundId != -1)\n\t\t\t\t$text .= \" AND id = $roundId\";\n\t\t\t$text .= \" ORDER BY id\";\n\t\t\t$query = mysqli_query($link, $text);\n\t\t\t\n\t\t\tif ($roundId == -1)\t\n\t\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t\t$data[] = $row;\n\t\t\telse\n\t\t\t\t$data = mysqli_fetch_assoc($query);\n\t\t\t\t\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\t/*\n\t\t\u0435\u0449\u0435\n\t*/\n\t\n\t// checkers\n\tfunction getCheckerList($checkerId = -1)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$checkerId = intval($checkerId);\n\t\t\t$text = \"SELECT * FROM checkers\";\n\t\t\tif ($checkerId != -1)\n\t\t\t\t$text .= \" WHERE id = $checkerId\";\n\t\t\t$query = mysqli_query($link, $text);\n\t\t\t\n\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t$data[] = $row;\n\t\t\t\t\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\t\n\t// \u0421\u043e\u0445\u0440\u0430\u043d\u0438\u0442\u044c checker\n\tfunction saveChecker($name, $game, $checker, $hasSeed)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$name = mysqli_real_escape_string($link, $name);\n\t\t\t$game = intval($game);\n\t\t\t$hasSeed = intval($hasSeed);\n\t\t\t\n\t\t\tif (mysqli_query($link, \"INSERT INTO checkers SET name = '$name', game = $game, hasSeed = $hasSeed\") == true)\n\t\t\t{\n\t\t\t\tif ($_FILES[$checker][\"error\"] == 0)\n\t\t\t\t{\n\t\t\t\t\t$checkerId = mysqli_insert_id($link);\n\t\t\t\t\t$result = saveTester($checkerId, $checker);\n\t\t\t\t\tif ($result != 0)\n\t\t\t\t\t\tmysqli_query($link, \"DELETE FROM checkers WHERE id = $checkerId\");\n\t\t\t\t\t\t\n\t\t\t\t\tif ($result == 0 || $result == -1)\n\t\t\t\t\t\treturn $result;\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tmysqli_query($link, \"DELETE FROM checkers WHERE id = $checkerId\");\n\t\t\t\t\t\tremoveDir(getCheckerById($checkerId));\n\t\t\t\t\t\treturn 'e' . $result;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse \n\t\t\t\t{\n\t\t\t\t\tmysqli_query($link, \"DELETE FROM checkers WHERE id = $checkerId\");\n\t\t\t\t\treturn 1;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse return 2;\n\t\t}\n\t\telse return 3;\n\t}\n\t\n\t// \u041e\u0431\u043d\u043e\u0432\u0438\u0442\u044c checker\n\tfunction updateChecker($id, $name, $game, $checker, $hasSeed)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$id \t= intval($id);\n\t\t\t$name \t= mysqli_real_escape_string($link, $name);\n\t\t\t$game \t= intval($game);\n\t\t\t$hasSeed = intval($hasSeed);\n\t\t\t\n\t\t\tif (mysqli_query($link, \"UPDATE checkers SET name = '$name', game = $game, hasSeed = $hasSeed WHERE id = $id\") == true)\n\t\t\t{\n\t\t\t\tif ($_FILES[$checker][\"error\"] == 0)\n\t\t\t\t{\n\t\t\t\t\t$result = saveTester($id, $checker);\n\t\t\t\t\tif ($result == 0 || $result == -1)\n\t\t\t\t\t\treturn $result;\n\t\t\t\t\telse\n\t\t\t\t\t\treturn 'e' . $result;\n\t\t\t\t}\n\t\t\t\telse return 1;\n\t\t\t}\n\t\t\telse return 2;\n\t\t}\n\t\telse return 3;\n\t}\n\t\n\tfunction getCheckerById($checkerId)\n\t{\n\t\treturn addslashes(\"./testers/\").$checkerId;\n\t}\n\t\n\tfunction getCheckerExeById($checkerId)\n\t{\n\t\treturn addslashes(\"./testers_bin/\").$checkerId.\".exe\";\n\t}\n\t\n\tfunction deleteChecker($checkerId)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$checkerId = intval($checkerId);\n\t\t\tif (mysqli_query($link, \"DELETE FROM checkers WHERE id = $checkerId\") == true)\n\t\t\t{\n\t\t\t\t\n\t\t\t\tremoveDir(getCheckerById($checkerId));\n\t\t\t\tremoveDir(getCheckerExeById($checkerId));\n\t\t\t\t\n\t\t\t\tif (!file_exists(getCheckerById($checkerId)) && !file_exists(getCheckerExeById($checkerId)))\n\t\t\t\t\treturn 0;\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tif (file_exists(getCheckerById($checkerId)) && file_exists(getCheckerExeById($checkerId)))\n\t\t\t\t\t\treturn 1;\n\t\t\t\t\telse if (file_exists(getCheckerById($checkerId)))\n\t\t\t\t\t\treturn 2;\n\t\t\t\t\telse\n\t\t\t\t\t\treturn 3;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse return 4;\n\t\t}\n\t\telse return 5;\n\t}\n\t\n\t// \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u043b\u0438\u0441\u0442 \u0447\u0435\u043a\u0435\u0440\u043e\u0432 \u043f\u043e \u0438\u0433\u0440\u0430\u043c\n\tfunction getCheckerListByGameId($gameId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$gameId = intval($gameId);\n\t\t\t\n\t\t\t$query = mysqli_query($link, \"SELECT * FROM checkers WHERE game = $gameId\");\n\t\t\t\n\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t$data[] = $row;\n\t\t\t\t\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\t// \u0421\u043e\u0437\u0434\u0430\u0442\u044c \u0440\u0430\u0443\u043d\u0434\n\tfunction createRound($tournamentId, $roundName, $checker, $previousRound, $seed)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$tournament = getTournamentList($tournamentId);\n\t\t\t$gameId = $tournament['game'];\n\t\t\t$roundName = mysqli_real_escape_string($link, $roundName);\n\t\t\t$checker = mysqli_real_escape_string($link, $checker);\n\t\t\t$previousRound \t= mysqli_real_escape_string($link, $previousRound);\n\t\t\t\n\t\t\tif (mysqli_query($link, \"INSERT INTO rounds SET tournament = $tournamentId, name = '$roundName', game = $gameId, checker = $checker, previousRound = $previousRound, seed = $seed\"))\n\t\t\t\treturn 0;\n\t\t\telse\n\t\t\t\treturn 1;\n\t\t}\n\t\telse return 2;\n\t}\n\t\n\t// \u041e\u0431\u043d\u043e\u0432\u0438\u0442\u044c \u0440\u0430\u0443\u043d\u0434\n\tfunction updateRound($tournamentId, $roundId, $roundName, $checker, $previousRound, $seed)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$tournament = getTournamentList($tournamentId);\n\t\t\t$gameId\t= $tournament['game'];\n\t\t\t\n\t\t\t$roundName = mysqli_real_escape_string($link, $roundName);\n\t\t\t$checker = intval($checker);\n\t\t\t$previousRound = intval($previousRound);\n\t\t\t\n\t\t\tif (mysqli_query($link, \"UPDATE rounds SET tournament = $tournamentId, name = '$roundName', game = $gameId, checker = $checker, previousRound = $previousRound, seed = $seed WHERE id = $roundId\"))\n\t\t\t\treturn 0;\n\t\t\telse\n\t\t\t\treturn 1;\n\t\t}\n\t\telse return 2;\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u043f\u0440\u0435\u0434\u044b\u0434\u0443\u0449\u0438\u0439 \u0440\u0430\u0443\u043d\u0434\n\tfunction getPreviousRound($roundId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$previousRound = -1;\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$roundId = intval($roundId);\n\t\t\t$query = mysqli_query($link, \"SELECT previousRound FROM rounds WHERE id = $roundId\");\n\t\t\t$data = mysqli_fetch_assoc($query);\n\t\t\t$previousRound = $data['previousRound'];\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $previousRound;\n\t}\n\t\n\t// \u041e\u0431\u043d\u043e\u0432\u0438\u0442\u044c \u0434\u043e\u043f\u0443\u0449\u0435\u043d\u043d\u044b\u0445 \u043a \u0440\u0430\u0443\u043d\u0434\u0443 \u0438\u0433\u0440\u043e\u043a\u043e\u0432\n\tfunction updateActiveUsers($tournament, $roundId, $activeStrategies)\n\t{\n\t\t// \u0434\u043e\u0434\u0435\u043b\u0430\u0442\u044c\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$roundId = intval($roundId);\n\t\t\tmysqli_query($link, \"DELETE FROM roundActivity WHERE round = $roundId\");\n\t\t\tforeach ($activeStrategies as $stategyId)\n\t\t\t{\n\t\t\t\t$stategyId = intval($stategyId);\n\t\t\t\t$userId = mysqli_result(mysqli_query($link, \"SELECT user FROM strategies WHERE id = $stategyId\"), 0, \"user\");\n\t\t\t\tmysqli_query($link, \"INSERT INTO roundActivity SET round = $roundId, user = $userId, state = 'ACT'\");\n\t\t\t}\n\t\t}\n\t}\n\t\n\t// \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u043a\u043e\u043b\u0438\u0447\u0435\u0441\u0442\u0432\u043e \u0438\u0433\u0440\u043e\u043a\u043e\u0432, \u0434\u043e\u043f\u0443\u0449\u0435\u043d\u043d\u044b\u0445 \u0432 \u0442\u0435\u043a\u0443\u0449\u0438\u0439 \u0440\u0430\u0443\u043d\u0434\n\tfunction getAcceptedRoundUsers($roundId)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$roundId = intval($roundId);\n\t\t\treturn mysqli_num_rows(mysqli_query($link, \"SELECT * FROM roundActivity WHERE round = $roundId AND state = 'ACT'\"));\n\t\t}\n\t\telse return 0;\n\t}\n\t\n\t/*\n\t// \u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0432\u0441\u0435\u0445 \u044e\u0437\u0435\u0440\u043e\u0432 \u0441 \u0430\u043a\u0442\u0438\u0432\u043d\u044b\u043c\u0438 \u0441\u0442\u0430\u0442\u0435\u0433\u0438\u044f\u043c\u0438\n\tfunction getActiveStrategiesFromTournament($tournamentId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$query = mysqli_query($link, \"SELECT str.id, usr.login FROM strategies AS str INNER JOIN users AS usr ON usr.id = str.user WHERE str.tournament = $tournamentId AND str.status = 'ACT'\");\n\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t$data[] = $row;\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t*/\n\t\n\t// \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0430\u043a\u0442\u0438\u0432\u043d\u044b\u0445 \u044e\u0437\u0435\u0440\u043e\u0432 \u0432 \u044d\u0442\u043e\u043c \u0440\u0430\u0443\u043d\u0434\u0435\n\tfunction getAcceptedUsers($roundId, $previousRoundId, $tournamentId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$roundId \t\t\t= intval($roundId);\n\t\t\t$previousRoundId \t= intval($previousRoundId);\n\t\t\t$tournamentId \t\t= intval($tournamentId);\n\t\t\t$queryText \t\t\t= \"\";\n\t\t\t\n\t\t\tif ($previousRoundId == -1)\n\t\t\t{\n\t\t\t\t$queryText = \"SELECT str.id, usr.login FROM strategies AS str INNER JOIN users AS usr ON usr.id = str.user INNER JOIN roundActivity AS rndAct ON usr.id = rndAct.user WHERE rndAct.round = $roundId AND str.tournament = $tournamentId AND str.status = 'ACT' ORDER BY usr.login\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$queryText = \"SELECT str.id, usr.login, scr.score FROM strategies AS str INNER JOIN users AS usr ON usr.id = str.user INNER JOIN scores AS scr ON scr.round = $previousRoundId AND scr.strategy = str.id INNER JOIN roundActivity AS rndAct ON usr.id = rndAct.user WHERE rndAct.round = $roundId AND str.tournament = $tournamentId AND str.status = 'ACT' ORDER BY scr.score DESC\";\n\t\t\t}\n\t\t\t\n\t\t\t//echo \"acceptedUsers: \" . $queryText . '\\n';\n\t\t\t\n\t\t\t$query = mysqli_query($link, $queryText);\n\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t$data[] = $row;\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\n    // \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0432\u043e\u0437\u043c\u043e\u0436\u043d\u044b\u0445 \u044e\u0437\u0435\u0440\u043e\u0432 \u0432 \u0440\u0430\u0443\u043d\u0434\u0435\n    function getPossibleUsers($roundId, $previousRoundId, $tournamentId)\n    {\n        $link = getDBConnection();\n        $data = array();\n        if (mysqli_select_db($link, getDBName()))\n        {\n            $roundId = intval($roundId);\n            $previousRoundId = intval($previousRoundId);\n            $tournamentId = intval($tournamentId);\n            $queryText = \"\";\n        \n            if ($previousRoundId != -1)\n            {\n                $queryText = \"SELECT str.id, usr.login, scr.score FROM strategies AS str INNER JOIN users AS usr ON usr.id = str.user AND usr.group != 'banned' INNER JOIN scores AS scr ON scr.round = $previousRoundId AND scr.strategy = str.id INNER JOIN roundActivity AS rndAct ON usr.id = rndAct.user WHERE rndAct.round = $previousRoundId AND str.tournament = $tournamentId AND str.status = 'ACT' AND usr.id NOT IN (SELECT user FROM roundActivity WHERE round = $roundId AND state = 'ACT') ORDER BY scr.score DESC\";\n            }\n            else\n            {\n                $queryText = \"SELECT str.id, usr.login FROM strategies AS str INNER JOIN users AS usr ON usr.id = str.user AND usr.group != 'banned' WHERE str.tournament = $tournamentId AND str.status = 'ACT' AND usr.id NOT IN (SELECT user FROM roundActivity WHERE round = $roundId AND state = 'ACT')\";\n                $queryText .= \" ORDER BY usr.login\";\n            }\n            \t\t\t\n            $query = mysqli_query($link, $queryText);\n            while ($row = mysqli_fetch_assoc($query))\n                $data[] = $row;\n            mysqli_free_result($query);\n        }\n        return $data;\n    }\n\t\n\t// \u0415\u0441\u043b\u0438 \u0432 \u0434\u0443\u044d\u043b\u044f\u0445 \u0440\u0430\u0443\u043d\u0434 \u043f\u0440\u043e\u0432\u0435\u0434\u0435\u043d, \u0442\u043e \u043f\u043e\u0432\u0442\u043e\u0440\u043d\u044b\u0439 \u0440\u0430\u0437 \u043c\u043e\u0436\u043d\u043e \u043d\u0435 \u0434\u0435\u043b\u0430\u0442\u044c\n\tfunction checkRoundInDuels($roundId)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$roundId = intval($roundId);\n\t\t\treturn mysqli_result(mysqli_query($link, \"SELECT COUNT(*) FROM duels WHERE round = $roundId\"), 0);\n\t\t}\n\t}\n\t\n\tfunction isRoundVisible($roundId)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$roundId = intval($roundId);\n\t\t\treturn mysqli_result(mysqli_query($link, \"SELECT COUNT(*) FROM rounds WHERE id = $roundId AND visible = true\"), 0);\n\t\t}\n\t}\n\t\n\tfunction setRoundVisible($roundId, $visibility = true)\n    {\n        if ($visibility)\n            $visibility = \"true\";\n        else\n            $visibility = \"false\";\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$roundId = intval($roundId);\n\t\t\tif (mysqli_query($link, \"UPDATE rounds SET visible = $visibility WHERE id = $roundId\"))\n\t\t\t\treturn 0;\n\t\t\telse\n\t\t\t\treturn 1;\n\t\t}\n\t\telse return 2;\n\t}\n\t\n\t// \u041a\u043e\u043b\u0438\u0447\u0435\u0441\u0442\u0432\u043e \u043f\u0440\u043e\u0432\u0435\u0440\u0435\u043d\u043d\u044b\u0445 \u0434\u0443\u044d\u043b\u0435\u0439\n\tfunction getCheckedDuels($roundId)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$roundId = intval($roundId);\n\t\t\treturn mysqli_result(mysqli_query($link, \"SELECT COUNT(*) FROM duels WHERE round = $roundId AND status <> 'W'\"), 0);\n\t\t}\n\t}\n\t\n\t// \u043f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 \u0437\u0430\u0432\u0435\u0440\u0448\u0435\u043d\u0438\u044f \u043f\u0440\u043e\u0432\u0435\u0440\u0435\u043a \u0440\u0430\u0443\u043d\u0434\u0430\n\tfunction checkRoundEnding($roundId)\n\t{\t\n\t\tif ($roundId == -1)\n\t\t\treturn false;\n\t\t$roundCount = getCheckedDuels($roundId);\n\t\tif ($roundCount == 0)\n\t\t\treturn false;\n\t\telse\n\t\t\treturn $roundCount == checkRoundInDuels($roundId);\n\t}\n\t\n\t// \u041d\u043e\u0432\u043e\u0441\u0442\u0438\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0432\u0441\u0435 \u043d\u043e\u0432\u043e\u0441\u0442\u0438\n\tfunction getNewsData($newsId = -1)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$newsId = intval($newsId);\n\t\t\t$queryText = \"SELECT * FROM news\";\n\t\t\t\n\t\t\tif ($newsId != -1)\n\t\t\t{\n\t\t\t\t$queryText .= \" WHERE id = $newsId\";\n\t\t\t}\n\t\t\t\n\t\t\t$queryText .= \" ORDER BY date DESC, id DESC\";\n\t\t\t\n\t\t\t$query = mysqli_query($link, $queryText);\n\t\t\tif ($newsId == -1)\n\t\t\t{\n\t\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t\t$data[] = $row;\n\t\t\t} \n\t\t\telse\n\t\t\t{\n\t\t\t\t$data = mysqli_fetch_assoc($query);\n\t\t\t}\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\t// \u0441\u043e\u0437\u0434\u0430\u0442\u044c \u043d\u043e\u0432\u043e\u0441\u0442\u044c\n\tfunction createNews($header, $text, $date)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$header = mysqli_real_escape_string($link, $header);\n\t\t\t$text \t= mysqli_real_escape_string($link, $text);\n\t\t\t$date\t= mysqli_real_escape_string($link, $date);\n\t\t\tif (mysqli_query($link, \"INSERT INTO news SET header = '$header', text = '$text', date = '$date'\"))\n\t\t\t\treturn 0;\n\t\t\telse\n\t\t\t\treturn 1;\n\t\t}\n\t\telse return 2;\n\t}\n\t\n\t// \u043e\u0431\u043d\u043e\u0432\u0438\u0442\u044c \u043d\u043e\u0432\u043e\u0441\u0442\u044c\n\tfunction updateNews($newsId, $header, $text, $date)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$newsId = intval($newsId);\n\t\t\t$header = mysqli_real_escape_string($link, $header);\n\t\t\t$text \t= mysqli_real_escape_string($link, $text);\n\t\t\t$date\t= mysqli_real_escape_string($link, $date);\n\t\t\tif (mysqli_query($link, \"UPDATE news SET header = '$header', text = '$text', date = '$date' WHERE id = $newsId\"))\n\t\t\t\treturn 0;\n\t\t\telse\n\t\t\t\treturn 1;\n\t\t}\n\t\telse return 2;\n\t}\n\t\n\t// \u0443\u0434\u0430\u043b\u0438\u0442\u044c \u043d\u043e\u0432\u043e\u0441\u0442\u044c\n\tfunction deleteNews($newsId)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$newsId = intval($newsId);\n\t\t\tif (mysqli_query($link, \"DELETE FROM news WHERE id = $newsId\"))\n\t\t\t\treturn 0;\n\t\t\telse\n\t\t\t\treturn 1;\n\t\t}\n\t\telse return 2;\n\t}\n\t\n\t// reverse date\n\tfunction reverseDate($oldDate, $delimiter)\n\t{\n\t\t$postDate = explode($delimiter, $oldDate);\n\t\treturn $postDate[2].\"-\".$postDate[1].\"-\".$postDate[0];\n\t}\n\t\n\t// \u041a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u0438\n\t\n\t// \u041a\u043e\u043b\u0438\u0447\u0435\u0441\u0442\u0432\u043e \u043a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u0435\u0432 \u043a \u043d\u043e\u0432\u043e\u0441\u0442\u044f\u043c\n\tfunction getCommentsCount($newsId)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$newsId = intval($newsId);\n\t\t\treturn mysqli_result(mysqli_query($link, \"SELECT COUNT(*) FROM newsComments WHERE news = $newsId\"), 0);\n\t\t}\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u043a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u0438\n\tfunction getComments($newsId)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$newsId = intval($newsId);\n\t\t\t$data \t= array();\n\t\t\t\n\t\t\t$query = mysqli_query($link, \"SELECT * from newsComments WHERE news = $newsId ORDER BY date ASC\");\n\t\t\t\n\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t$data[] = $row;\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\tfunction getComment($commentId)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$newsId = intval($newsId);\n\t\t\t$data \t= array();\n\t\t\t\n\t\t\t$query = mysqli_query($link, \"SELECT * from newsComments WHERE id = $commentId ORDER BY date ASC\");\n\t\t\t\n\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t$data[] = $row;\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\t// \u041e\u0442\u043f\u0440\u0430\u0432\u0438\u0442\u044c \u043a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u0439\n\tfunction sendComments($newsId, $text)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$newsId \t\t= intval($newsId);\n\t\t\t$currentUserId \t= intval(getActiveUserID());\n\t\t\tif ($currentUserId != -1)\n\t\t\t{\n\t\t\t\t$query = mysqli_query($link, \"INSERT INTO newsComments SET news = $newsId, user = $currentUserId, text = '$text', date = NOW()\");\n\t\t\t}\n\t\t}\n\t}\n\t\n\t// \u0418\u0437\u043c\u0435\u043d\u0438\u0442\u044c \u043a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u0439\n\tfunction updateComment($commentId, $text)\n\t{\n\t\t$cData = getComment($commentId);\n\t\tif ($cData[0]['user'] == getActiveUserID() || isAdmin() || isModerator())\n\t\t{\n\t\t\t$link = getDBConnection();\n\t\t\tif (mysqli_select_db($link, getDBName()))\n\t\t\t{\n\t\t\t\t$commentId \t= intval($commentId);\n\t\t\t\t$text \t\t= mysqli_real_escape_string($link, $text);\n\t\t\t\n\t\t\t\tmysqli_query($link, \"UPDATE newsComments SET text = '$text' WHERE id = $commentId\");\n\t\t\t}\n\t\t}\n\t}\n\t\n\t// \u0423\u0434\u0430\u043b\u0438\u0442\u044c \u043a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u0439\n\tfunction deleteComment($commentId)\n\t{\n\t\t$cData = getComment($commentId);\n\t\tif ($cData[0]['user'] == getActiveUserID() || isAdmin() || isModerator())\n\t\t{\n\t\t\t$link = getDBConnection();\n\t\t\tif (mysqli_select_db($link, getDBName()))\n\t\t\t{\n\t\t\t\t$commentId = intval($commentId);\n\t\t\t\tmysqli_query($link, \"DELETE FROM newsComments WHERE id = $commentId\");\n\t\t\t}\n\t\t}\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0442\u0435\u043a\u0441\u0442 \u043a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u044f\n\tfunction getCommentText($commentId)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$commentId = intval($commentId);\n\t\t\treturn mysqli_result(mysqli_query($link, \"SELECT text FROM newsComments WHERE id = $commentId\"), 0);\n\t\t}\n\t}\n\t\n\t// FAQ\n\t\n\t// \u041e\u0442\u043f\u0440\u0430\u0432\u043a\u0430 \u0432\u043e\u043f\u0440\u043e\u0441\u0430\n\tfunction sendQuestion($text)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$currentUserId \t= intval(getActiveUserID());\n\t\t\t$text \t\t\t= mysqli_real_escape_string($link, $text);\n\t\t\t\n\t\t\tif (mysqli_query($link, \"INSERT INTO userQuestions SET user = $currentUserId, question = '$text', status = 'opened'\"))\n\t\t\t\treturn 0;\n\t\t\telse\n\t\t\t\treturn 1;\n\t\t}\n\t\telse return 2;\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u0432\u043e\u043f\u0440\u043e\u0441\u043e\u0432 \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0435\u043d\u043d\u043e\u0433\u043e \u0441\u0442\u0430\u0442\u0443\u0441\u0430\n\tfunction getQuestions($state)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$state = mysqli_real_escape_string($link, $state);\n\t\t\t$query = mysqli_query($link, \"SELECT * FROM userQuestions WHERE status = '$state'\");\n\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t$data[] = $row;\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u043a\u043e\u043b\u0438\u0447\u0435\u0441\u0442\u0432\u0430 \u043e\u0442\u043a\u0440\u044b\u0442\u044b\u0445 \u0432\u043e\u043f\u0440\u043e\u0441\n\tfunction getOpenedQuestionCount()\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\treturn mysqli_result(mysqli_query($link, \"SELECT COUNT(*) FROM userQuestions WHERE status = 'opened'\"), 0);\n\t\t}\n\t\telse return 0;\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0441\u0442\u0430\u0442\u0443\u0441 \u043f\u043e id\n\tfunction getQuestionStatusById($statusId)\n\t{\n\t\t$data = array(\"opened\", \"answered\", \"closed\");\n\t\treturn $data[$statusId];\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0432\u043e\u043f\u0440\u043e\u0441\u044b\n\tfunction getQuestionData($statusId)\n\t{\n\t\treturn getQuestions(getQuestionStatusById($statusId));\n\t}\n\t\n\t// \u0412\u044b\u0431\u0440\u0430\u043d\u043d\u044b\u0439 \u0432\u043e\u043f\u0440\u043e\u0441\n\tfunction getQuestionById($questionId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$questionId = intval($questionId);\n\t\t\treturn mysqli_fetch_assoc(mysqli_query($link, \"SELECT * FROM userQuestions WHERE id = $questionId\"));\n\t\t}\n\t}\n\t\n\t// \u0421\u043e\u0437\u0434\u0430\u0442\u044c \u0432\u043e\u043f\u0440\u043e\u0441\n\tfunction createAnswer($question, $answer)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$answer \t\t= mysqli_real_escape_string($link, $answer);\n\t\t\t$question \t\t= mysqli_real_escape_string($link, $question);\n\t\t\t$currentUserId \t= intval(getActiveUserID());\n\t\t\t\n\t\t\tif (mysqli_query($link, \"INSERT INTO userQuestions SET user = $currentUserId, question = '$question', answer = '$answer', status = 'answered'\"))\n\t\t\t\treturn 0;\n\t\t\telse\n\t\t\t\treturn 1;\n\t\t}\n\t\telse return 2;\n\t}\n\t\n\t// \u041e\u0442\u0440\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0432\u043e\u043f\u0440\u043e\u0441\n\tfunction updateAnswer($postQuestionId, $question, $answer)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$postQuestionId = intval($postQuestionId);\n\t\t\t$answer \t\t= mysqli_real_escape_string($link, $answer);\n\t\t\t$question \t\t= mysqli_real_escape_string($link, $question);\n\t\t\t\n\t\t\tif (mysqli_query($link, \"UPDATE userQuestions SET question = '$question', answer = '$answer', status = 'answered' WHERE id = $postQuestionId\"))\n\t\t\t\treturn 0;\n\t\t\telse\n\t\t\t\treturn 1;\n\t\t}\n\t\telse return 2;\n\t}\n\t\n\t// \u0417\u0430\u043a\u0440\u044b\u0442\u044c \u0432\u043e\u043f\u0440\u043e\u0441\n\tfunction closeAnswer($questionId)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$questionId = intval($questionId);\n\t\t\tif (mysqli_query($link, \"UPDATE userQuestions SET status = 'closed' WHERE id = $questionId\"))\n\t\t\t\treturn 0;\n\t\t\telse\n\t\t\t\treturn 1;\n\t\t}\n\t\telse return 2;\n\t}\n\t\n\t// \u0410ttachments\n\tfunction getAttachments($gameId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$gameId = intval($gameId);\n\t\t\t\n\t\t\t$queryText = \"SELECT * FROM attachments WHERE game = $gameId\";\n\t\t\n\t\t\t$query = mysqli_query($link, $queryText);\n\t\t\t\n\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t$data[] = $row;\n\t\t\t\t\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\tfunction getAttachmentById($attachmentId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$attachmentId = intval($attachmentId);\n\t\t\t\n\t\t\t$query = mysqli_query($link, \"SELECT * FROM attachments WHERE id = $attachmentId\");\n\t\t\t$data = mysqli_fetch_assoc($query);\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\tfunction getAttachmentPath($id)\n\t{\n\t\treturn addslashes(\"./attachments/\").$id;\n\t}\n\t\n\tfunction createAttachment($gameId, $originalName, $description, $attachment)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$gameId\t\t\t= intval($gameId);\n\t\t\t$originalName \t= mysqli_real_escape_string($link, $originalName);\n\t\t\t$description \t= mysqli_real_escape_string($link, $description);\n\t\t\tif (mysqli_query($link, \"INSERT INTO attachments SET game = $gameId, originalName = '$originalName', description = '$description'\") == true)\n\t\t\t{\n\t\t\t\t$attachmentId = mysqli_insert_id($link);\n\t\t\t\n\t\t\t\tif ($_FILES[$attachment][\"error\"] == 0)\n\t\t\t\t{\n\t\t\t\t\t$result = saveAttachment($attachmentId, $attachment);\n\t\t\t\t\tif ($result == true)\n\t\t\t\t\t\treturn 0;\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tmysqli_query($link, \"DELETE FROM attachments WHERE id = $attachmentId\");\n\t\t\t\t\t\treturn -1;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tmysqli_query($link, \"DELETE FROM attachments WHERE id = $attachmentId\");\n\t\t\t\t\treturn 1;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse return 2;\n\t\t}\n\t\telse return 3;\n\t}\n\t\n\tfunction updateAttachment($attachmentId, $gameId, $originalName, $description, $attachment)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$attachmentId\t\t\t= intval($attachmentId);\n\t\t\t$gameId\t\t\t\t\t= intval($gameId);\n\t\t\t$originalName \t\t\t= mysqli_real_escape_string($link, $originalName);\n\t\t\t$description \t\t\t= mysqli_real_escape_string($link, $description);\n\t\t\tif (mysqli_query($link, \"UPDATE attachments SET game = $gameId, originalName = '$originalName', description = '$description' WHERE id = $attachmentId\"))\n\t\t\t{\n\t\t\t\tif ($_FILES[$attachment][\"error\"] == 0)\n\t\t\t\t{\n\t\t\t\t\t$result = saveAttachment($attachmentId, $attachment);\n\t\t\t\t\tif ($result == true)\n\t\t\t\t\t\treturn 0;\n\t\t\t\t\telse\n\t\t\t\t\t\treturn -1;\n\t\t\t\t}\n\t\t\t\telse return 1;\n\t\t\t}\n\t\t\telse return 2;\n\t\t}\n\t\telse return 3;\n\t}\n\t\n\tfunction deleteAttachment($attachmentId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$attachmentId = intval($attachmentId);\n\t\t\tif (mysqli_query($link, \"DELETE FROM attachments WHERE id = $attachmentId\"))\n\t\t\t{\n\t\t\t\tremoveDir(getAttachmentPath($attachmentId));\n\t\t\t\t\n\t\t\t\tif (!file_exists(getAttachmentPath($attachmentId)))\n\t\t\t\t\treturn 0;\n\t\t\t\telse\n\t\t\t\t\treturn 1;\n\t\t\t}\n\t\t\telse return 2;\n\t\t}\n\t\telse return 3;\n\t}\n\t\n\t// Ap duels\n\tfunction getGameByRound($roundId)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$roundId = intval($roundId);\n\t\t\treturn mysqli_result(mysqli_query($link, \"SELECT game FROM rounds WHERE id = $roundId\"), 0);\n\t\t}\n\t}\n\t\n\t// Ap images\n\t\n\t// \u0417\u0430\u0433\u0440\u0443\u0437\u043a\u0430 \u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u044f \u043d\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\n\tfunction loadImage($imagePath, $imageType, $imageDescription, $gameId = -1)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$fileName \t\t\t= mysqli_real_escape_string($link, $_FILES[$imagePath]['name']);\n\t\t\t$imageType \t\t\t= mysqli_real_escape_string($link, $imageType);\n\t\t\t$imageDescription \t= mysqli_real_escape_string($link, $imageDescription);\n\t\t\t$gameId\t\t\t\t= intval($gameId);\n\t\t\tmysqli_query($link, \"INSERT INTO images SET type = '$imageType', description = '$imageDescription', game = $gameId, originalName = '$fileName'\");\n\t\t\t$fileId = mysqli_insert_id($link);\n\t\t\t\t\t\t\n\t\t\tif (isset($imagePath) && $_FILES[$imagePath][\"error\"] == 0)\n\t\t\t\tsaveImageOnDisc($fileId, $imagePath);\n\t\t}\n\t}\n\t\n\t\n\t// \u0412\u0441\u043f\u043e\u043c\u043e\u0433\u0430\u0442\u0435\u043b\u044c\u043d\u0430\u044f \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0438\n\tfunction saveImageOnDisc($id, $source)\n\t{\n\t\t$path = addslashes(\"./img/\").$id;\n\t\tsaveFileOnDisc2($path, $source);\n\t}\n\t\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u043f\u0443\u0442\u0438 \u043a \u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u044e \u043f\u043e id\n\tfunction getImageById($imageId)\n\t{\n\t\treturn addslashes(\"./img/\").$imageId;\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u0438 \u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u044f \u043f\u043e id\n\tfunction getImageDataById($imageId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$imageId = intval($imageId);\n\t\t\t$query = mysqli_query($link, \"SELECT * FROM images WHERE id = $imageId\");\n\t\t\t$data = mysqli_fetch_assoc($query);\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u043f\u0443\u0442\u0438 \u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u044f \u043f\u043e \u043e\u043f\u0438\u0441\u0430\u043d\u0438\u044e\n\tfunction getImageByDescription($description)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$description = mysqli_real_escape_string($link, $description);\n\t\t\t$query = mysqli_query($link, \"SELECT id FROM images WHERE description = '$description'\");\n\t\t\tif (mysqli_num_rows($query))\n\t\t\t\treturn getImageById(mysqli_result($query, 0));\n\t\t\telse\n\t\t\t\treturn \"null\";\n\t\t}\n\t}\n\t\n\t/*\n\t\n\tnot used yet\n\t\n\tfunction resizedImageExist($imageId)\n\t{\n\t\treturn file_exists(addslashes(\"./img/\").$imageId.'r');\n\t}\n\t\n\tfunction createResizeImage($imageId)\n\t{\n\t\t$path = addslashes(\"./img/\").$imageId;\n\t\tif (file_exists($path))\n\t\t{\n\t\t\t$imageInfo = getimagesize($path);\n\t\t\t$imageType = $imageInfo[2];\n\t\t\t$image = null;\n\t\t\tif ($imageType == IMAGETYPE_JPEG)\n\t\t\t\t$image = imagecreatefromjpeg($path);\n\t\t\telse if ($imageType == IMAGETYPE_PNG)\n\t\t\t\t$image = imagecreatefrompng($path);\n\t\t\t\t\n\t\t\t$newImage = imagecreatetruecolor(200, 200); // width, height\n\t\t\t\n\t\t\timagecopyresampled($newImage, $image, 0, 0, 0, 0, 200, 200, imagesx($image), imagesy($image));\n\t\t\t\n\t\t\tif ($imageType == IMAGETYPE_JPEG)\n\t\t\t\timagejpeg($newImage, $path.'r');\n\t\t\telse if($imageType == IMAGETYPE_PNG)\n\t\t\t\timagepng($newImage, $path.'r');\n\t\t}\n\t}\n\t*/\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u0438 \u043e \u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u0438\n\tfunction getImageData($typeId, $gameId = -1)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$typeId = intval($typeId);\n\t\t\t$gameId = intval($gameId);\n\t\t\t$queryText = \"SELECT * FROM images WHERE type = $typeId\";\n\t\t\tif ($gameId != -1)\n\t\t\t\t$queryText .= \" AND game = $gameId\";\n\t\t\t\t\n\t\t\t$query = mysqli_query($link, $queryText);\n\t\t\t\n\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t$data[] = $row;\n\t\t\t\t\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\tfunction deleteImage($imageId)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$imageId = intval($imageId);\n\t\t\tmysqli_query($link, \"DELETE FROM images WHERE id = $imageId\");\n\t\t\tremoveDir(getImageById($imageId));\n\t\t}\n\t}\n\t\n\t// userProfile\n\t\n\tfunction changePassword($newPassword, $id=\"\")\n\t{\n\t\tif ($newPassword == \"\" || !isActiveUser()) return 4;\n\t\t\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$newPassword = md5(md5(trim(mysqli_real_escape_string($link, $newPassword))));\n\t\t\tif (isAdmin() && ($id != \"\"))\n        \t\t\t$currentId = intval($id);\n     \t\t\telse\n        \t\t\t$currentId = intval(getActiveUserID());\n\t\t\tif (mysqli_query($link, \"UPDATE users SET password = '$newPassword' WHERE id = $currentId\"))\n\t\t\t{\n\t\t\t\t//logOff();\n\t\t\t\tLogIn(md5(generateUniqueCode(10)), getActiveUserID());\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t\treturn 1;\n\t\t}\n\t\telse return 2;\n  }\n  function setUserGroup($newGroup, $id)\n  {\n        if (!isAdmin()) return 4;\n        if ($id == getActiveUserID()) return 4;\n        $link = getDBConnection();\n        if (($newGroup != \"user\") && ($newGroup != \"moder\") && ($newGroup != \"news\") && ($newGroup != \"admin\") && ($newGroup != \"banned\"))\n            return 4;\n        if (mysqli_select_db($link, getDBName()))\n        {\n            $currentId = intval($id);\n            if (mysqli_query($link, \"UPDATE `users` SET `group` = '$newGroup' WHERE id = $currentId\"))\n                return 0;\n            return 1;\n        };\n        return 2;\n    }\n  function setUserRealName($newName, $id=\"\")\n  {\n        if (!isActiveUser()) return 4;\n        $newName = htmlspecialchars($newName);\n        $link = getDBConnection();\n        if (mysqli_select_db($link, getDBName()))\n        {\n            $newName = mysqli_real_escape_string($link, $newName);\n            if (isAdmin() && ($id != \"\"))\n                $currentId = intval($id);\n            else\n                $currentId = intval(getActiveUserID());\n\n            if (mysqli_query($link, \"UPDATE users SET name = '$newName' WHERE id = $currentId\"))\n                return 0;\n            return 1;\n        };\n        return 2;\n    }\n\n    function setUserSurname($newName, $id=\"\")\n    {\n        if (!isActiveUser()) return 4;\n        $newName = htmlspecialchars($newName);\n        $link = getDBConnection();\n        if (mysqli_select_db($link, getDBName()))\n        {\n            $newName = mysqli_real_escape_string($link, $newName);\n            if (isAdmin() && ($id != \"\"))\n                $currentId = intval($id);\n            else\n                $currentId = intval(getActiveUserID());\n\n            if (mysqli_query($link, \"UPDATE users SET surname = '$newName' WHERE id = $currentId\"))\n                return 0;\n            return 1;\n        };\n        return 2;\n    }\n\n    function setUserPatronymic($newName, $id=\"\")\n    {\n        if (!isActiveUser()) return 4;\n        $newSurname = htmlspecialchars($newSurname);\n        $link = getDBConnection();\n        if (mysqli_select_db($link, getDBName()))\n        {\n            $newName = mysqli_real_escape_string($link, $newName);\n            if (isAdmin() && ($id != \"\"))\n                $currentId = intval($id);\n            else\n                $currentId = intval(getActiveUserID());\n\n            if (mysqli_query($link, \"UPDATE users SET patronymic = '$newName' WHERE id = $currentId\"))\n                return 0;\n            return 1;\n        };\n        return 2;\n    }\n\n    function getUserRealName($id = \"\")\n    {\n        if (!isActiveUser()) return \"Anonymous\";\n        $link = getDBConnection();\n        if (mysqli_select_db($link, getDBName()))\n        {\n            if (isAdmin() && ($id != \"\"))\n                $currentId = intval($id);\n            else\n                $currentId = intval(getActiveUserID());\n            $query = mysqli_query($link, \"SELECT name FROM users WHERE id = $currentId\");\n            $res = mysqli_fetch_assoc($query);\n            return $res['name'];\n        }\n    }\n    function getUserSurname($id = \"\")\n    {\n        if (!isActiveUser()) return \"Anonymous\";\n        $link = getDBConnection();\n        if (mysqli_select_db($link, getDBName()))\n        {\n            if (isAdmin() && ($id != \"\"))\n                $currentId = intval($id);\n            else\n                $currentId = intval(getActiveUserID());\n            $query = mysqli_query($link, \"SELECT surname FROM users WHERE id = $currentId\");\n            $res = mysqli_fetch_assoc($query);\n            return $res['surname'];\n        }\n    }\n    function getUserPatronymic($id = \"\")\n    {\n        if (!isActiveUser()) return \"Anonymous\";\n        $link = getDBConnection();\n        if (mysqli_select_db($link, getDBName()))\n        {\n            if (isAdmin() && ($id != \"\"))\n                $currentId = intval($id);\n            else\n                $currentId = intval(getActiveUserID());\n\n            $query = mysqli_query($link, \"SELECT patronymic FROM users WHERE id = $currentId\");\n            $res = mysqli_fetch_assoc($query);\n            return $res['patronymic'];\n        }\n    }\n\n    function getUsersList($ordered = false)\n    {\n        $link = getDBConnection();\n        mysqli_select_db($link, getDBName());\n        $q = \"SELECT * FROM `users` WHERE `group` != 'banned'\";\n        if ($ordered)\n            $q .= \" ORDER BY login\";\n        $data = array();\n        if ($query = mysqli_query($link, $q))\n        {\n            while ($row = mysqli_fetch_assoc($query))\n                $data[] = $row;\n            mysqli_free_result($query);\n        }\n        return $data;\n    }\n\n    function getFromDB($table, $where = \"1\", $limit = -1)\n    {\n        $link = getDBConnection();\n        mysqli_select_db($link, getDBName());\n        if ($limit = -1)\n            $limit = \"\";\n        else\n            $limit = \"LIMIT $limit\";\n        $q = \"SELECT * FROM `$table` WHERE ($where) $limit\";\n        $data = array();\n        if ($query = mysqli_query($link, $q))\n        {\n            while ($row = mysqli_fetch_assoc($query))\n                $data[] = $row;\n            mysqli_free_result($query);\n        }\n        mysqli_close($link);\n        return $data;\n    }\n\n    function createGameZip($gameId, $filename)\n    {\n        $gameId = intval($gameId);\n        $z = new ZipArchive();\n        $z->open($filename, ZIPARCHIVE::CREATE);\n        $checkers = getCheckerListByGameId($gameId);\n        $game = getFromDB(\"games\", \"id=$gameId\");\n        $meta = \"NAME=\" . getGameName($gameId) \n                        . \"\\nDESCRIPTION=\" \n                        . getGameDescription($gameId) \n                        . \"\\nTL=\" \n                        . $game[0][\"timeLimit\"] \n                        . \"\\nML=\" \n                        . $game[0][\"memoryLimit\"]\n        ;\n        $i = 0;\n        foreach ($checkers as $a)\n        {\n            $z->addFile(getcwd().\"./testers/\".$a[\"id\"], ++$i . \".checker\");\n            $z->addFromString($i . \".checkermeta\", \"LANG=cpp\\nname=\" . $a[\"name\"] . \"\\nSEED=\" . $a[\"hasSeed\"]);\n        };\n        $attachments = getAttachments($gameId);\n        $i = 0;\n        foreach ($attachments as $b)\n        {\n            $z->addFile(\"./attachments/\" . $b[\"id\"], ++$i . \".attachment\");\n            $z->addFromString($i . \".attachmentmeta\", \"NAME=\" . $b[\"originalName\"] . \"\\nDESCRIPTION=\".$b[\"description\"]);\n        };\n        $z->addFromString(\"META\", $meta);\n        $z->close();\n    }\n?>\n"], "fixing_code": ["<?php\n    include_once(\"procStrategies.php\");\n\n\tsession_start();\n\t\n\t// \u0434\u043b\u044f \u0434\u0438\u043d\u0430\u043c\u0438\u0447\u0435\u0441\u043a\u043e\u0439 \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0438 \u0432 div'\u044b \u0442\u0443\u0440\u043d\u0438\u0440\u043e\u0432\n\t\n\t$nonUpdatableTournamentChuncks = array\n\t\t\t\t\t\t\t\t\t(\n\t\t\t\t\t\t\t\t\t\t'tournament', 'getSource', 'getLog', 'startRound', \n\t\t\t\t\t\t\t\t\t\t'jqueryUserStrategyDownloadStrategy', 'jqueryUserStrategySetActStatus',\n\t\t\t\t\t\t\t\t\t\t'visualize', 'jqueryResetTournamentState'\n\t\t\t\t\t\t\t\t\t);\n\t$unsetTournamentState = true;\n\t\n\tforeach ($nonUpdatableTournamentChuncks as $script)\n\t\t$unsetTournamentState = $unsetTournamentState & !stripos($_SERVER['PHP_SELF'], $script);\n\t\n\tif ($unsetTournamentState)\n\t{\n\t\tunset($_SESSION['tournamentState']);\n\t\tunset($_SESSION['tournamentDuel']);\n\t\tunset($_SESSION['roundResultsRoundId']);\n\t\tunset($_SESSION['roundTableRoundId']);\n\t}\n\t\n\t// \u0434\u043b\u044f \u0434\u0438\u043d\u0430\u043c\u0438\u0447\u0435\u0441\u043a\u043e\u0439 \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0438 \u0430\u0434\u043c\u0438\u043d\u043a\u0438\n\t\n\t$nonUpdatableAdminPanelChuncks = array\n\t\t\t\t\t\t\t\t\t\t(\n\t\t\t\t\t\t\t\t\t\t\t'adminPanel', 'jqueryGetRoundUsers', 'jqueryChecker', \n\t\t\t\t\t\t\t\t\t\t\t'jqueryAttachment', 'jqueryNews', 'jqueryTournament', \n\t\t\t\t\t\t\t\t\t\t\t'jqueryGetCheckerList', 'startRound', 'jqueryGame',\n\t\t\t\t\t\t\t\t\t\t\t'getChecker', 'jqueryGetNewRoundId', 'visualize', \n\t\t\t\t\t\t\t\t\t\t\t'jqueryFaq'\n\t\t\t\t\t\t\t\t\t\t);\n\t$unsetAdminPanelState = true;\n\t\n\tforeach ($nonUpdatableAdminPanelChuncks as $script)\n\t{\n\t\t$unsetAdminPanelState = $unsetAdminPanelState & !stripos($_SERVER['PHP_SELF'], $script);\n\t}\n\t\t\n\tif ($unsetAdminPanelState)\n\t{\n\t\t// \u0443\u0434\u0430\u043b\u044f\u0442\u044c\n\t\tunset($_SESSION['adminPanelState']);\n\t\tunset($_SESSION['adminGameId']);\n\t\tunset($_SESSION['adminAttachmentId']);\n\t\tunset($_SESSION['adminCheckerId']);\n\t\tunset($_SESSION['adminQuestionStatusId']);\n\t\tunset($_SESSION['adminQuestionId']);\n\t\tunset($_SESSION['adminNewsId']);\n\t\tunset($_SESSION['adminTournamentId']);\n\t\tunset($_SESSION['adminRoundId']);\n\t\tunset($_SESSION['adminImgTypeId']);\n\t\tunset($_SESSION['adminImgGameId']);\n\t}\n\n    function rusStatus($status)\n    {\n        if ($status == \"WIN 1\")\n            return \"\u0412\u044b\u0438\u0433\u0440\u0430\u043b \u043f\u0435\u0440\u0432\u044b\u0439 \u0438\u0433\u0440\u043e\u043a\";\n        if ($status == \"WIN 2\")\n            return \"\u0412\u044b\u0438\u0433\u0440\u0430\u043b \u0432\u0442\u043e\u0440\u043e\u0439 \u0438\u0433\u0440\u043e\u043a\";\n        if ($status == \"TIE\")\n            return \"\u041d\u0438\u0447\u044c\u044f\";\n        if ($status == \"IM 1\")\n            return \"\u041d\u0435\u0432\u0435\u0440\u043d\u044b\u0439 \u0445\u043e\u0434 \u043f\u0435\u0440\u0432\u043e\u0433\u043e \u0438\u0433\u0440\u043e\u043a\u0430\";\n        if ($status == \"IM 2\")\n            return \"\u041d\u0435\u0432\u0435\u0440\u043d\u044b\u0439 \u0445\u043e\u0434 \u0432\u0442\u043e\u0440\u043e\u0433\u043e \u0438\u0433\u0440\u043e\u043a\u0430\";\n        if ($status == \"RE 1\")\n            return \"\u041e\u0448\u0438\u0431\u043a\u0430 \u0432\u044b\u043f\u043e\u043b\u043d\u0435\u043d\u0438\u044f \u0443 \u043f\u0435\u0440\u0432\u043e\u0433\u043e \u0438\u0433\u0440\u043e\u043a\u0430\";\n        if ($status == \"RE 2\")\n            return \"\u041e\u0448\u0438\u0431\u043a\u0430 \u0432\u044b\u043f\u043e\u043b\u043d\u0435\u043d\u0438\u044f \u0443 \u0432\u0442\u043e\u0440\u043e\u0433\u043e \u0438\u0433\u0440\u043e\u043a\u0430\";\n         if ($status == \"TL 1\")\n            return \"\u041f\u0440\u0435\u0432\u044b\u0448\u0435\u043d \u043b\u0438\u043c\u0438\u0442 \u043f\u043e \u0432\u0440\u0435\u043c\u0435\u043d\u0438 \u0443 \u043f\u0435\u0440\u0432\u043e\u0433\u043e \u0438\u0433\u0440\u043e\u043a\u0430\";\n         if ($status == \"TL 2\")\n            return \"\u041f\u0440\u0435\u0432\u044b\u0448\u0435\u043d \u043b\u0438\u043c\u0438\u0442 \u043f\u043e \u0432\u0440\u0435\u043c\u0435\u043d\u0438 \u0443 \u0432\u0442\u043e\u0440\u043e\u0433\u043e \u0438\u0433\u0440\u043e\u043a\u0430\";\n         if ($status == \"ML 1\")\n            return \"\u041f\u0440\u0435\u0432\u044b\u0448\u0435\u043d \u043b\u0438\u043c\u0438\u0442 \u043f\u043e \u043f\u0430\u043c\u044f\u0442\u0438 \u0443 \u043f\u0435\u0440\u0432\u043e\u0433\u043e \u0438\u0433\u0440\u043e\u043a\u0430\";\n         if ($status == \"ML 2\")\n            return \"\u041f\u0440\u0435\u0432\u044b\u0448\u0435\u043d \u043b\u0438\u043c\u0438\u0442 \u043f\u043e \u043f\u0430\u043c\u044f\u0442\u0438 \u0443 \u0432\u0442\u043e\u0440\u043e\u0433\u043e \u0438\u0433\u0440\u043e\u043a\u0430\";\n        if ($status == \"IE\")\n            return \"\u0412\u043d\u0443\u0442\u0440\u0435\u043d\u043d\u044f\u044f \u043e\u0448\u0438\u0431\u043a\u0430\";\n        return $status;\n    }\n\t\n\tfunction clearTournamentState()\n\t{\n\t\tunset($_SESSION['tournamentState']);\n\t\tunset($_SESSION['tournamentDuel']);\n\t\tunset($_SESSION['roundResultsRoundId']);\n\t\tunset($_SESSION['roundTableRoundId']);\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u043b\u0438\u043d\u043a\u0430 \u0441\u043e\u0435\u0434\u0438\u043d\u0435\u043d\u0438\u044f \u0441 \u0411\u0414\n\tfunction getDBConnection()\n\t{\n\t\t$file = @file('authData.txt') or die(\"Can't find data file! <a href=install.php>Install system</a>\"); // 0 - login, 1 - password, 2 - DB's name\n\t\t\n\t\t$login = $file[0];\n\t\t$password = $file[1];\n\t\t// \u0423\u0434\u0430\u043b\u044f\u0435\u043c \u043b\u0438\u0448\u043d\u0438\u0435 \u043f\u0440\u043e\u0431\u0435\u043b\u044b\n\t\t$login = trim($login);\n\t\t$password = trim($password);\n\t\t$link = mysqli_connect('localhost', $login, $password) or die(\"Can't connect to DB: \".mysqli_error());\n\t\treturn $link;\n\t}\n\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u043d\u0430\u0437\u0432\u0430\u043d\u0438\u044f \u0411\u0414\n\tfunction getDBName()\n\t{\t\n\t\t$file = @file('authData.txt') or die(\"Can't find data file! <a href=install.php>Install system</a>\");\n\t\treturn trim($file[2]);\n\t}\n\t\n\t// \u0430\u043d\u0430\u043b\u043e\u0433 mysql_query\n\t// $query - \u0437\u0430\u043f\u0440\u043e\u0441, $row - \u0441\u0442\u0440\u043e\u043a\u0430 \u0432 \u0437\u0430\u043f\u0440\u043e\u0441\u0435, $field - \u043d\u043e\u043c\u0435\u0440 \u043f\u043e\u043b\u044f\n\tfunction mysqli_result($query, $row, $field = 0) \n\t{\n\t\tmysqli_data_seek($query, $row);\n\t\t$data = mysqli_fetch_array($query);\n\t\treturn $data[$field];\n\t} \n\t\n\t// \u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f (\u0435\u0441\u0442\u044c \u043b\u0438 \u043e\u043d \u043d\u0430 \u0441\u0430\u0439\u0442\u0435)\n\tfunction isActiveUser()\n\t{\n\t\treturn isset($_SESSION['SBUserid']) and isset($_SESSION['SBUserhash']);\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 ID \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f\n\tfunction getActiveUserID()\n\t{\n\t\tif (!isActiveUser())\n\t\t\treturn -1;\n\t\treturn $_SESSION['SBUserid'];\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u043d\u0438\u043a\u0430 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f\n\tfunction getActiveUserNickname()\n\t{\n\t\t$link = getDBConnection();\n\t\t\n\t\tif (isActiveUser() && mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$userId = intval($_SESSION['SBUserid']);\n\t\t\t$nickname = mysqli_query($link, \"SELECT login FROM users WHERE id=\".$userId.\" LIMIT 1\");\n\t\t\treturn mysqli_result($nickname, 0);\n\t\t}\n\t\telse return \"Anonymous\";\n\t}\n\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u0438\u043c\u0435\u043d\u0438 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f\n\tfunction getNicknameById($id = -1)\n\t{\n\t\t$link = getDBConnection();\n\t\tif ($id == -1) \n\t\t\t$id = getActiveUserID();\n\t\tif ($id != -1 && mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$id = intval($id);\n\t\t\t$userName = mysqli_query($link, \"SELECT login FROM users WHERE id = $id\");\n\t\t\treturn mysqli_result($userName, 0);\n\t\t} \n\t\telse \n\t\t\treturn \"Anonymous\";\t\n\t}\n\t\n    // \u041e\u0442\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u0435 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f\n    function logOff()\n    {\n        session_start();\n        session_unset();\n        session_destroy();\n        session_commit();\n        setcookie(session_name(), '', 0, '/');\n        session_regenerate_id(true);\n    }\n\t\n    // \u041f\u0440\u0438\u043d\u0430\u0434\u043b\u0435\u0436\u043d\u043e\u0441\u0442\u044c \u043a \u0433\u0440\u0443\u043f\u043f\u0435 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0435\u0439\n    function isUserInGroup($group, $id=\"\")\n    {\n        if (isset($_SESSION['SBUserid']))\n        {\n            $id = ($id == \"\") ? $_SESSION['SBUserid'] : intval($id);\n\t\t\t$link = getDBConnection();\n\t\t\tif (mysqli_select_db($link, getDBName()))\n\t\t\t{\n\t\t\t\t$groupExisting = false;\n\t\t\t\t$group = mysqli_real_escape_string($link, $group);\n\t\t\t\t$groupQuery = mysqli_query($link, \"SELECT `id` FROM `users` WHERE `group` = '$group'\");\n\t\t\t\twhile ($adminData = @mysqli_fetch_assoc($groupQuery))\n\t\t\t\t{\n\t\t\t\t\tif ($id === intval($adminData['id'])) \n\t\t\t\t\t{\t\n\t\t\t\t\t\t$groupExisting = true;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn $groupExisting;\n\t\t\t} else return false;\n\t\t} else return false;\n\t}\n\t\n\t// \u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f \u043d\u0430 \u043f\u0440\u0438\u043d\u0430\u0434\u043b\u0435\u0436\u043d\u043e\u0441\u0442\u044c \u043a\u0430\u0441\u0442\u0435 \u0430\u0434\u043c\u0438\u043d\u0438\u0441\u0442\u0440\u0430\u0442\u043e\u0440\u043e\u0432\n\tfunction isAdmin()\n\t{\n\t\treturn isUserInGroup('admin');\n\t}\n\t\n\t// \u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f \u043d\u0430 \u043f\u0440\u0438\u043d\u0430\u0434\u043b\u0435\u0436\u043d\u043e\u0441\u0442\u044c \u043a \u0441\u043e\u0437\u0434\u0430\u0442\u0435\u043b\u044f\u043c \u043d\u043e\u0432\u043e\u0441\u0442\u0435\u0439\n\tfunction isNewsMaker()\n\t{\n\t\treturn isUserInGroup('news');\n\t}\n\t\n\t// \u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f \u043d\u0430 \u043f\u0440\u0438\u043d\u0430\u0434\u043b\u0435\u0436\u043d\u043e\u0441\u0442\u044c \u043a \u043c\u043e\u0434\u0435\u0440\u0430\u0442\u043e\u0440\u0430\u043c\n\tfunction isModerator()\n\t{\n\t\treturn isUserInGroup('moder');\n    }\n\n    function isBanned()\n    {\n        return isUserInGroup('banned');\n    }\n\t\n\t// \u0413\u0435\u043d\u0435\u0440\u0430\u0446\u0438\u044f \u0443\u043d\u0438\u043a\u0430\u043b\u044c\u043d\u043e\u0433\u043e \u043a\u043e\u0434\u0430\n\tfunction generateUniqueCode($length=6) \n\t{\n\t\t$chars = \"abcdefghijklmnopqrstuvwxyzABCDEFGHI JKLMNOPRQSTUVWXYZ0123456789\";\n\t\t$code = \"\";\n\t\t$clen = strlen($chars) - 1;  \n\t\t\n\t\twhile (strlen($code) < $length) $code .= $chars[mt_rand(0, $clen)];  \n\t\treturn $code;\n\t}\n\t\n\t// \u0421\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0438\u0435 \u0444\u0430\u0439\u043b\u0430 \u043d\u0430 \u0434\u0438\u0441\u043a\n\tfunction saveFileOnDisc($path, $source, $fileTypes = NULL)\n\t{\n\t\tif (is_uploaded_file($_FILES[$source][\"tmp_name\"]))\n\t\t{\n\t\t\tif (!$fileTypes || ($fileTypes && in_array(pathinfo($_FILES[$source]['name'], PATHINFO_EXTENSION), $fileTypes)))\n\t\t\t{\n\t\t\t\tmove_uploaded_file($_FILES[$source]['tmp_name'], $path.$_FILES[$source]['name']);\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\telse if ($fileTypes != NULL) return \"\u041d\u0435 \u0442\u043e\u0442 \u0444\u043e\u0440\u043c\u0430\u0442 \u0437\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043c\u043e\u0433\u043e \u0444\u0430\u0439\u043b\u0430!\";\n\t\t} else return \"\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044c \u0444\u0430\u0439\u043b!\";\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u0440\u0430\u0441\u0448\u0438\u0440\u0435\u043d\u0438\u044f \u0444\u0430\u0439\u043b\u0430\n\tfunction getFileExtension($source)\n\t{\n\t\treturn pathinfo($_FILES[$source]['name'], PATHINFO_EXTENSION);\n\t}\n\n\t// \u0421\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0438\u0435 \u0444\u0430\u0439\u043b\u0430 \u043d\u0430 \u0434\u0438\u0441\u043a\n\tfunction saveFileOnDisc2($path, $source)\n\t{\n\t\treturn move_uploaded_file($_FILES[$source]['tmp_name'], $path);\n\t}\n\t\n\t// \u0420\u0435\u043a\u0443\u0440\u0441\u0438\u0432\u043d\u043e\u0435 \u0443\u0434\u0430\u043b\u0435\u043d\u0438\u0435 \u043f\u0430\u043f\u043a\u0438 \u0432\u043c\u0435\u0441\u0442\u0435 \u0441 \u0444\u0430\u0439\u043b\u0430\u043c\u0438\n\tfunction removeDir($path)\n\t{\n\t\tif (is_dir($path))\n\t\t{\n\t\t\t$handle = opendir($path);\n\t\t\twhile (($subfile = readdir($handle)) !== FALSE) \n\t\t\t{\n\t\t\t\tif ($subfile == '.' || $subfile == '..') continue;\n\t\t\t\tif (is_file($subfile)) \n\t\t\t\t\tunlink(\"$path/$subfile\");\n\t\t\t\telse \n\t\t\t\t\tremoveDir(\"$path/$subfile\");\n\t\t\t}\n\t\t\tclosedir($handle);\n\t\t\trmdir($path);\n\t\t} else unlink($path);\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u043e\u0447\u043a\u043e\u0432 \u0438\u0433\u0440\u043e\u043a\u0430 \u0432 \u0440\u0430\u0443\u043d\u0434\u0435\n\tfunction getPlayerScore($round, $strategy)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$round \t\t= intval($round);\n\t\t\t$strategy \t= intval($strategy);\n\t\t\t$query = mysqli_query($link, \"SELECT score FROM scores WHERE round = $round AND strategy = $strategy\");\n\t\t\treturn mysqli_result($query, 0);\n\t\t}\n\t}\n\t\n\t// \u0418\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u0435 \u043e\u0447\u043a\u043e\u0432 \u0438\u0433\u0440\u043e\u043a\u0430 \u0432 \u0440\u0430\u0443\u043d\u0434\u0435\n\tfunction setPlayerScore($round, $strategy, $value)\n\t{\n\t\t$score = intval(getPlayerScore($round, $strategy)) + $value;\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$round \t\t= intval($round);\n\t\t\t$strategy \t= intval($strategy);\n\t\t\tmysqli_query($link, \"UPDATE scores SET score = $score WHERE round = $round AND strategy = $strategy\");\n\t\t}\n\t}\n\t\n\tfunction getGameByDuel($duel)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$duel = intval($duel);\n\t\t\t$gameId = mysqli_query($link, \"SELECT games.id FROM games INNER JOIN strategies s ON games.id = s.game INNER JOIN duels ON duels.strategy1 = s.id WHERE duels.id = $duel\");\n\t\t\treturn mysqli_result($gameId, 0);\n\t\t}\n\t\treturn -1;\n\t}\n\n\tfunction getVisualizerByGame($gameId)\n\t{\n\t\tif ($gameId == -1)\n\t\t\treturn false;\n\t\telse\n\t\t{\n\t\t\t$link = getDBConnection();\n\t\t\tif (mysqli_select_db($link, getDBName()))\n\t\t\t{\n\t\t\t\t$gameId = intval($gameId);\n\t\t\t\treturn mysqli_result(mysqli_query($link, \"SELECT hasVisualizer FROM games WHERE id = $gameId\"), 0);\n\t\t\t}\n\t\t\telse return -1;\n\t\t}\n\t}\n\n    function isActiveUserHasAccessToDuel($duel)\n    {\n    \t$link = getDBConnection();\n        if (!mysqli_select_db($link, getDBName()))\n            return false;\n        \n        if (isAdmin())\n    \t    return true;\n        $userId = intval(getActiveUserID());\n        $duel = intval($duel);\n        $duelParams = mysqli_query($link, \"SELECT round, strategy1, strategy2 FROM duels WHERE id = $duel\");\n        $round = mysqli_result($duelParams, 0, 0);\n        $s1 = mysqli_result($duelParams, 0, 1);\n        $s2 = mysqli_result($duelParams, 0, 2);\n        if ($round != -1)\n        {\n            if (mysqli_result(mysqli_query($link, \"SELECT visible FROM rounds WHERE id=$round\"), 0) != true)\n                return false;\n            else\n                return true;\n        }\n        if (getUserIdByStrategy($s1) == $userId\n            || getUserIdByStrategy($s2) == $userId)\n        {\n            return true;\n        }\n\n    \treturn false;\n    }\n\n\t// \u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u043d\u0430\u0437\u0432\u0430\u043d\u0438\u0435 \u0438\u0433\u0440\u044b\n\tfunction getGameName($id = -1)\n\t{\n\t\t$link = getDBConnection();\n\t\t$id = intval($id);\n\t\tif ($id != -1 && mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$game = mysqli_query($link, \"SELECT name FROM games WHERE id = $id\");\n\t\t\treturn @mysqli_result($game, 0);\n\t\t} \n\t\telse \n\t\t\treturn \"Unknown\";\t\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u043c\u0430\u0441\u0441\u0438\u0432 \u0441 \u043d\u0430\u0437\u0432\u0430\u043d\u0438\u044f\u043c\u0438 \u0438\u0433\u0440\n\tfunction getGameArray()\n\t{\n\t\t$link = getDBConnection();\n\t\t$names = array();\n\t\t\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$query = mysqli_query($link, \"SELECT id, name FROM games\");\n\t\t\twhile ($data = mysqli_fetch_assoc($query))\n\t\t\t\t$names[$data['id']] = $data['name'];\n\t\t}\n\t\t\n\t\treturn $names;\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0432\u0441\u0435 \u0442\u0435\u043a\u0443\u0449\u0438\u0435 \u0442\u0443\u0440\u043d\u0438\u0440\u044b\n\tfunction getRunningAndClosedTournaments()\n\t{\n\t\t$link = getDBConnection();\n\t\t$tournaments = array();\n\t\t\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$query = mysqli_query($link, \"SELECT id, name FROM tournaments WHERE state = 'running' OR state = 'closed'\");\n\t\t\twhile ($data = mysqli_fetch_assoc($query))\n\t\t\t\t$tournaments[$data['id']] = $data['name'];\n\t\t}\n\t\t\n\t\treturn $tournaments;\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440 \u0438\u0433\u0440\u044b\n\tfunction getGameParameter($id, $parameter)\n\t{\n\t\t$link = getDBConnection();\n\t\t$id = intval($id);\n\t\tif ($id == -1 || $parameter == \"\" || !mysqli_select_db($link, getDBName()))\n\t\t\treturn \"Unknown\";\n\t\telse\n\t\t{\n\t\t\t$parameter = mysqli_real_escape_string($link, $parameter);\n\t\t\t$value = mysqli_query($link, \"SELECT {$parameter} FROM games WHERE id = $id\");\n\t\t\tif (mysqli_num_rows($value))\n\t\t\t\treturn @mysqli_result($value, 0);\n\t\t\telse return \"Unknown\";\n\t\t}\n\t}\n\t\n\t// \u0421\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0438\u0435 \u0442\u0435\u0441\u0442\u0435\u0440\u0430 \u0434\u043b\u044f \u0432\u044b\u0431\u0440\u0430\u043d\u043d\u043e\u0439 \u0438\u0433\u0440\u044b\n\tfunction saveTester($id, $source)\n\t{\n\t\t$path = addslashes(\"./testers/\").$id;\n\t\t$result = saveFileOnDisc2($path, $source);\n\t\t\n\t\tif ($result == false)\n\t\t\treturn -1;\n\t\telse\n\t\t{\n\t\t\t$output = array();\n            $answer = 0;\n            if (strtoupper(substr(PHP_OS, 0, 3)) === 'WIN')\n                $execResult = exec(\"clChecker.bat $id\", $output, $answer);\n            else\n                $execResult = exec(\"./gccChecker.sh $id\", $output, $answer);\n\t\t\treturn $answer;\n\t\t}\n\t\t\n\t}\n\n\t// \u0421\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0438\u0435 \u0432\u0438\u0437\u0443\u0430\u043b\u0438\u0437\u0430\u0442\u043e\u0440\u0430 \u0434\u043b\u044f \u0432\u044b\u0431\u0440\u0430\u043d\u043d\u043e\u0439 \u0438\u0433\u0440\u044b\n\tfunction saveVisualizer($id, $source)\n\t{\n\t\tif (isset($source) && $_FILES[$source][\"error\"] == 0)\n\t\t{\n\t\t\t$link = getDBConnection();\n\t\t\tif (mysqli_select_db($link, getDBName()))\n\t\t\t{\n\t\t\t\t$id = intval($id);\n\t\t\t\tmysqli_query($link, \"UPDATE Games SET hasVisualizer=1 WHERE id=\".$id.\";\");\n\t\t\t\t$path = addslashes(\"./visualizers/\").$id;\n\t\t\t\treturn saveFileOnDisc2($path, $source);\n\t\t\t}\n\t\t\telse return false;\n\t\t}\n\t\telse return false;\n\t}\n\t\n\t// \u0421\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0438\u0435 \u0430\u0442\u0442\u0430\u0447\u043c\u0435\u043d\u0442\u0430\n\tfunction saveAttachment($id, $source)\n\t{\n\t\tif ($_FILES[$source][\"error\"] == 0)\n\t\t{\n\t\t\t$path = addslashes(\"./attachments/\").$id;\n\t\t\treturn saveFileOnDisc2($path, $source);\n\t\t}\n\t}\n\t\n    // \u0420\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u044f\n    function registerUser($postLogin, $postPassword)\n    {\n        // $_POST['login']\n        // $_POST['password']\n        $link = getDBConnection();\n        $reason = \"\";\n        if (mysqli_select_db($link, getDBName()))\n        {\n            $err = array();\n\n            $login = strip_tags($postLogin);\n            if ($login != $postLogin)\n                $err[] = \"\u041b\u043e\u0433\u0438\u043d \u0441\u043e\u0434\u0435\u0440\u0436\u0438\u0442 \u043d\u0435\u043a\u043e\u0440\u0440\u0435\u043a\u0442\u043d\u044b\u0435 \u0441\u0438\u043c\u0432\u043e\u043b\u044b\";\n            $postLogin = mysqli_real_escape_string($link, $postLogin);\n            if (strlen($postLogin) < 3 or strlen($postLogin > 30))\n                $err[] = \"\u041b\u043e\u0433\u0438\u043d \u0434\u043e\u043b\u0436\u0435\u043d \u0431\u044b\u0442\u044c \u043d\u0435 \u043c\u0435\u043d\u044c\u0448\u0435 3-\u0445 \u0441\u0438\u043c\u0432\u043e\u043b\u043e\u0432 \u0438 \u043d\u0435 \u0431\u043e\u043b\u044c\u0448\u0435 30\";\n\n            $query = mysqli_query($link, \"SELECT COUNT(id) FROM users WHERE login='{$login}'\");\n\n            if (@mysqli_result($query, 0) > 0)\n                $err[] = \"\u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u0441 \u0442\u0430\u043a\u0438\u043c \u043b\u043e\u0433\u0438\u043d\u043e\u043c \u0443\u0436\u0435 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u0435\u0442 \u0432 \u0431\u0430\u0437\u0435 \u0434\u0430\u043d\u043d\u044b\u0445\";\n\n            if (count($err) == 0)\n            {\n                $password = md5(md5(trim($postPassword)));\n                mysqli_query($link, \"INSERT INTO users SET login='\".$postLogin.\"', password='$password'\");\n                $reason = \"\u0412\u044b \u0437\u0430\u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0438\u0440\u043e\u0432\u0430\u043d\u044b \u0432 \u0441\u0438\u0441\u0442\u0435\u043c\u0435!\";\n            }\n            else\n            {\n                $reason = \"<b>\u041f\u0440\u0438 \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438 \u043f\u0440\u043e\u0438\u0437\u043e\u0448\u043b\u0438 \u0441\u043b\u0435\u0434\u0443\u044e\u0449\u0438\u0435 \u043e\u0448\u0438\u0431\u043a\u0438:</b><br>\";\n                foreach($err as $error)\n                    $reason = $reason.$error.\"<br>\";\n            }\n        }\n        else\n        {\n            $reason = \"\u041d\u0435\u0442 \u0432\u043e\u0437\u043c\u043e\u0436\u043d\u043e\u0441\u0442\u0438 \u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0438\u0442\u044c\u0441\u044f \u043a \u0411\u0414!\";\n        }\n\n        return $reason;\n    }\n\n// \u0410\u0432\u0442\u043e\u0440\u0438\u0437\u0430\u0446\u0438\u044f\n\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u0434\u0430\u043d\u043d\u044b\u0445 \u043e \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0435 \u043f\u0440\u0438 \u0430\u0432\u0442\u043e\u0440\u0438\u0437\u0430\u0446\u0438\u0438\n\tfunction getAuthorizationData()\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t\t$query = mysqli_query($link, \"SELECT * FROM users WHERE login='\".mysqli_real_escape_string($link, $_POST['login']).\"' LIMIT 1\");\n\t\t$data = mysqli_fetch_assoc($query);\n\t\treturn $data;\n\t}\n\t\n\t// \u0417\u0430\u043f\u0438\u0441\u044c \u0434\u0430\u043d\u043d\u044b\u0445 \u043f\u0440\u0438 \u0430\u0432\u0442\u043e\u0440\u0438\u0437\u0430\u0446\u0438\u0438\n\tfunction LogIn($hash, $id)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$id = intval($id);\n\t\t\tmysqli_query($link, \"UPDATE users SET hash='\".$hash.\"' WHERE id='\".$id.\"'\");\n\t\t\t/*\n\t\t\tsetcookie(\"SBUserid\", $id, time()+60*60*24*30);\n\t\t\tsetcookie(\"SBUserhash\", $hash, time()+60*60*24*30);\n\t\t\t*/\n\t\t\t$_SESSION['SBUserid'] = $id;\n\t\t\t$_SESSION['SBUserhash'] = $hash;\n\t\t}\n\t}\n\t\n\t// \u0414\u0438\u0437\u0430\u0439\u043d\n\t\n\t// \u0412\u044b\u0432\u043e\u0434 \u0437\u0430\u0433\u043e\u043b\u043e\u0432\u043a\u0430 \u043d\u0430 \u044d\u043a\u0440\u0430\u043d\n\tfunction getPageHeaderByScriptName($scriptName)\n\t{\n\t\t//\n\t\t$headers = array\n\t\t(\n\t\t\t\"index.php\" \t\t\t\t=> \"AI Battle - \u0413\u043b\u0430\u0432\u043d\u0430\u044f\",\n\t\t\t\"userAuthorization.php\" \t=> \"AI Battle - \u0412\u0445\u043e\u0434\",\n\t\t\t\"userRegistration.php\" \t\t=> \"AI Battle - \u0420\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u044f\"\n\t\t);\n\t\t\n\t\tforeach ($headers as $script => $header)\n\t\t\tif (strpos($scriptName, $script))\n\t\t\t\treturn $header;\n\t}\n\t\n\t// \u0412\u044b\u0434\u0435\u043b\u0435\u043d\u0438\u0435 \u0430\u043a\u0442\u0438\u0432\u043d\u043e\u0439 \u0432\u043a\u043b\u0430\u0434\u043a\u0438\n\tfunction getActiveNavbarElement($role, $scriptName)\n\t{\n\t\t$elements = array\n\t\t(\n\t\t\t\"news\" => \"index.php\", \n\t\t\t\"tournament\" => \"tournament.php\", \n\t\t\t\"game\" => \"game.php\", \n\t\t\t\"users\" => \"users.php\", \n\t\t\t\"faq\" => \"faq.php\",\n\t\t\t\"adminPanel\" => \"adminPanel.php\"\n\t\t);\n\t\t\n\t\tforeach ($elements as $key => $element)\n\t\t{\n\t\t\tif ($role == $key && strpos($scriptName, $element))\n\t\t\t{\n\t\t\t\treturn \"active\";\n\t\t\t}\n\t\t}\n\t\t\t\t\n\t\treturn \"\";\n\t}\n\t\n\t// \u0422\u0443\u0440\u043d\u0438\u0440\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u0438 \u043e \u0442\u0443\u0440\u043d\u0438\u0440\u0435\n\tfunction getTournamentData($tournamentId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$tournamentId = intval($tournamentId);\n\t\t\t$query = mysqli_query($link, \"SELECT * FROM tournaments WHERE id = $tournamentId LIMIT 1\");\n\t\t\t$data = mysqli_fetch_assoc($query);\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\t\n\t\treturn $data; \n\t}\n\t\n\t// \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u0438\u0433\u0440\u044b \u043f\u043e \u0442\u0443\u0440\u043d\u0438\u0440\u0443\n\tfunction getGameByTournament($tournamentId)\n\t{\n\t\tif ($tournamentId == -1)\n\t\t\treturn -1;\n\t\telse \n\t\t{\n\t\t\t$data = getTournamentData($tournamentId);\n\t\t\treturn $data['game'];\n\t\t}\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u043e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 \u0438\u0433\u0440\u044b\n\tfunction getGameDescription($gameId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$gameDescription = \"none\";\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$gameId = intval($gameId);\n\t\t\t$query = mysqli_query($link, \"SELECT description FROM games WHERE id = $gameId LIMIT 1\");\n\t\t\t$data = mysqli_fetch_assoc($query);\n\t\t\t$gameDescription = $data['description'];\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $gameDescription;\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u043e\u043f\u0438\u0441\u0430\u043d\u0438\u044f \u0442\u0443\u0440\u043d\u0438\u0440\u0430\n\tfunction getTournamentDescriptionByTournamentId($tournamentId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$tournamentDescription = \"none\";\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$tournamentId = intval($tournamentId);\n\t\t\t$query = mysqli_query($link, \"SELECT description FROM tournaments WHERE id = $tournamentId LIMIT 1\");\n\t\t\t$data = mysqli_fetch_assoc($query);\n\t\t\t$tournamentDescription = $data['description'];\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $tournamentDescription;\n\t}\n\t\n\t// \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u043c\u0430\u0441\u0441\u0438\u0432\u0430 attachment'\u043e\u0432\n\tfunction getGameAttachments($gameId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$attachments = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$gameId = intval($gameId);\n\t\t\t$query = mysqli_query($link, \"SELECT * FROM attachments WHERE game = $gameId\");\n\t\t\twhile ($data = mysqli_fetch_assoc($query))\n\t\t\t\t$attachments[$data['id']] = array('originalName' => $data['originalName'], 'description' => $data['description']);\n\t\t}\n\t\treturn $attachments;\n\t}\n\t\n    // \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u0441\u0442\u0440\u0430\u0442\u0435\u0433\u0438\u0439 \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0435\u043d\u043d\u043e\u0433\u043e \u044e\u0437\u0435\u0440\u0430\n    function getUserStrategies($gameId, $userId, $tournamentId, $ok, $first=0, $size=-1)\n    {\n        $link = getDBConnection();\n        $strategies = array();\n        if (mysqli_select_db($link, getDBName()))\n        {\n            $gameId = intval($gameId);\n            $userId = intval($userId);\n            $tournamentId = intval($tournamentId);\n            $sql = \"SELECT id, user, status FROM strategies WHERE game = $gameId AND user = $userId AND tournament = $tournamentId \";\n            if ($ok)\n                $sql .= \" AND (status = 'OK' OR status = 'ACT') \";\n            $query = mysqli_query($link, $sql . \" ORDER BY id DESC\".(($size != -1) ? \" LIMIT $first, $size\" : \" \"));\n            while ($data = mysqli_fetch_assoc($query))\n                $strategies[] = $data;\n        }\n        return $strategies;\n    }\n\n\tfunction getUserMessages($first=0, $size=-1, $id = 0, $notreaded = false)\n    {\n        if (!isActiveUser())\n            return false;\n\t\t$link = getDBConnection();\n        $messages = array();\n\t\tmysqli_select_db($link, getDBName());\n        $userId = intval(getActiveUserID());\n\t\t$query = mysqli_query($link, \"SELECT * FROM `privateMessages` WHERE (`sender` = $userId OR `recevier` = $userId) \".($id != 0 ? \" AND id=\".$id : \"\").($notreaded ? \" AND viewed=0\" : \"\").\" ORDER BY id DESC\".(($size != -1) ? \" LIMIT $first, $size\" : \" \"));\n\t    while ($data = mysqli_fetch_assoc($query))\n            $messages[$data['id']] = array(\n                'sender' => $data['sender'],\n                'recevier' => $data['recevier'],\n                'title' => $data['title'],\n                'text' => $data['text'],\n                'date' => $data['date'],\n                'viewed' => (($data['sender'] == $userId) ? 1 : $data['viewed'])\n            );\n\t\treturn $messages;\n    }\n\n    function postMessage($recevier, $title, $text)\n    {\n        if (!isActiveUser())\n            return false;\n        $link = getDBConnection();\n        $messages = array();\n        mysqli_select_db($link, getDBName());\n        $userId = intval(getActiveUserID());\n        $recevier = intval($recevier);\n        $title = mysqli_real_escape_string($link, $title);\n        $text = mysqli_real_escape_string($link, $text);\n        $query = mysqli_query($link, \"INSERT INTO `privateMessages` VALUES (NULL, $userId, $recevier, '$title', '$text', 0, 0)\");\n        if ($query)\n            return true;\n        return false;\n    }\n\n    function markMessageAsViewed($id)\n    {\n        if (!isActiveUser())\n            return false;\n        $userId = intval(getActiveUserID());\n        $id = intval($id);\n        $messages = getUserMessages(0, -1, $id);\n        if (!isset($messages[$id]))\n            return false;\n        $link = getDBConnection();\n        mysqli_select_db($link, getDBName());\n        if (mysqli_query($link, \"UPDATE `privateMessages` SET `viewed`=1 WHERE `id`=$id\"))\n            return true;\n        return false;\n    }\n\n    function getNotViewedMessages()\n    {\n        if (!isActiveUser())\n            return 0;\n        $userId = intval(getActiveUserID());\n        $link = getDBConnection();\n        mysqli_select_db($link, getDBName());\n        $query = mysqli_query($link, \"SELECT COUNT(*) FROM `privateMessages` WHERE viewed=0 AND recevier = $userId\");\n        $res = mysqli_fetch_array($query);\n        return $res[0];      \n    }\n\n\t\n\t// \u043f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 \u043d\u0430 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u043e\u0432\u0430\u043d\u0438\u0435 \u0438\u0433\u0440\u044b \u0441 \u0432\u044b\u0431\u0440\u0430\u043d\u043d\u044b\u043c ID\n\tfunction isGameExists($gameID)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t\treturn mysqli_num_rows(mysqli_query($link, \"SELECT * FROM `games` WHERE id = \". intval($gameID))) > 0;\n\t\t\n\t}\n\t\n\t// \u0414\u0443\u044d\u043b\u0438\n\tfunction getUserStrategy($gameId, $tournamentId)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$gameId = intval($gameId);\n\t\t\t$tournamentId = intval($tournamentId);\n\t\t\treturn mysqli_query($link, \"SELECT id FROM strategies WHERE tournament = $tournamentId AND game = $gameId AND status = 'ACT' AND user=\".intval(getActiveUserID()));\n\t\t}\n    }\n\t\n\tfunction getDuels($roundId, $gameId, $userId, $tournamentId = -1, $start = 0, $limit = -1)\n\t{\n\t\n\t\t$roundId \t\t= intval($roundId);\n\t\t$gameId \t\t= intval($gameId);\n\t\t$userId\t\t\t= intval($userId);\n\t\t$tournamentId \t= intval($tournamentId);\n\t\t\n\t\t$query = \"SELECT duels.id AS id, duels.status AS status, strategy1, strategy2, s1.user AS user1, s2.user AS user2 FROM duels\";\n\t\t$query .= \" INNER JOIN strategies s1 ON duels.strategy1 = s1.id INNER JOIN strategies s2 ON duels.strategy2 = s2.id\";\n\t\t$query .= \" INNER JOIN games ON games.id = s1.game AND games.id = s2.game\";\n\t\tif (!isAdmin() && $roundId != -1)\n\t\t\t$query .= \" INNER JOIN rounds ON rounds.id = duels.round\";\n\t\t$query .= \" WHERE duels.round = $roundId AND games.id = $gameId\";\n\t\tif (!isAdmin() && $roundId != -1)\n\t\t\t$query .= \" AND rounds.visible = true\";\n\t\tif (!isAdmin())\n\t\t\t$query .= \" AND (s1.user = $userId OR s2.user = $userId)\";\n\t\t\n\t\tif ($tournamentId != -1)\n\t\t\t$query .= \" AND (s1.tournament = $tournamentId AND s2.tournament = $tournamentId)\";\n\t\t\t\t\t\n        $query .= \" ORDER BY id DESC\";\n        if ($limit != -1)\n            $query.= \" LIMIT $start, $limit\";\n\t\t\n\t\t//echo $query;\n\t\t\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$duels = mysqli_query($link, $query);\n\t\t\t\n\t\t\t$data = array();\n\t\t\twhile ($row = mysqli_fetch_assoc($duels))\n\t\t\t\t$data[] = $row;\n\t\t\t\t\n\t\t\tmysqli_free_result($duels);\n\t\t\n\t\t\treturn $data;\n\t\t}\n\t\telse return array();\n    }\n\n    function getDuelsCount($roundId, $gameId, $userId, $tournamentId = -1)\n\t{\n\t\n\t\t$roundId \t\t= intval($roundId);\n\t\t$gameId \t\t= intval($gameId);\n\t\t$userId\t\t\t= intval($userId);\n\t\t$tournamentId \t= intval($tournamentId);\n\t\t\n\t\t$query = \"SELECT COUNT(*) FROM duels\";\n\t\t$query .= \" INNER JOIN strategies s1 ON duels.strategy1 = s1.id INNER JOIN strategies s2 ON duels.strategy2 = s2.id\";\n\t\t$query .= \" INNER JOIN games ON games.id = s1.game AND games.id = s2.game\";\n\t\tif (!isAdmin() && $roundId != -1)\n\t\t\t$query .= \" INNER JOIN rounds ON rounds.id = duels.round\";\n\t\t$query .= \" WHERE duels.round = $roundId AND games.id = $gameId\";\n\t\tif (!isAdmin() && $roundId != -1)\n\t\t\t$query .= \" AND rounds.visible = true\";\n\t\tif (!isAdmin())\n\t\t\t$query .= \" AND (s1.user = $userId OR s2.user = $userId)\";\n\t\t\n\t\tif ($tournamentId != -1)\n\t\t\t$query .= \" AND (s1.tournament = $tournamentId AND s2.tournament = $tournamentId)\";\n\t\t\t\t\t\n\t\t\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$duels = mysqli_query($link, $query);\n\t\t\t\n\t\t\t$data = mysqli_fetch_array($duels);\n\t\t\t\t\n\t\t\tmysqli_free_result($duels);\n\t\t\n\t\t\treturn $data[0];\n\t\t}\n\t\telse return 0;\n\t}\n\t\n\tfunction getDuelHeader($roundId, $gameId)\n\t{\n\t\t$header = \"\";\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$gameId \t= intval($gameId);\n\t\t\t$roundId \t= intval($roundId);\n\t\t\t$gameName \t= mysqli_result(mysqli_query($link, \"SELECT name FROM games WHERE id = $gameId\"), 0);\n\t\t\tif ($roundId == -1)\n\t\t\t\t$header = \"\u0422\u0440\u0435\u043d\u0438\u0440\u043e\u0432\u043a\u0430\";\n\t\t\telse\n\t\t\t{\n\t\t\t\t$roundName \t= mysqli_result(mysqli_query($link, \"SELECT name FROM rounds WHERE id = $roundId\"), 0);\n\t\t\t\t$header = \"\u041f\u0430\u0440\u0442\u0438\u0438 \u0440\u0430\u0443\u043d\u0434\u0430 \".$roundName;\n\t\t\t}\n\t\t\t\n\t\t\t$header = $header . \" \u0438\u0433\u0440\u044b \".$gameName;\n\t\t}\n\t\treturn $header;\n\t}\n\t\n\t// \u0440\u0430\u0443\u043d\u0434\u044b\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0440\u0430\u0443\u043d\u0434\u044b \u0442\u0443\u0440\u043d\u0438\u0440\u0430\n\tfunction getTournamentRounds($tournamentId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$tournamentId = intval($tournamentId);\n\t\t\t$query = mysqli_query($link, \"SELECT * FROM rounds WHERE tournament = $tournamentId\");\n\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t$data[] = $row;\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\t// \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0442\u0435\u043a\u0443\u0449\u0443\u044e \u0441\u0442\u0440\u0430\u0442\u0435\u0433\u0438\u044e\n\tfunction getCurrentStrategy($userId, $tournamentId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$strategyId = -1;\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$userId \t\t= intval($userId);\n\t\t\t$tournamentId \t= intval($tournamentId);\n\t\t\t$query = mysqli_query($link, \"SELECT id FROM strategies WHERE user = $userId AND tournament = $tournamentId AND status = 'ACT'\");\n\t\t\t$data = mysqli_fetch_assoc($query);\n\t\t\t$strategyId = $data['id'];\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $strategyId;\n\t}\n\t\n\t// \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0442\u0435\u043a\u0443\u0449\u0438\u0445 \u0438\u0433\u0440\u043e\u043a\u043e\u0432 \u0440\u0430\u0443\u043d\u0434\u0430\n\tfunction getRoundPlayers($roundId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$roundId = intval($roundId);\n\t\t\t$query = mysqli_query($link, \"SELECT user FROM roundActivity WHERE round = $roundId AND state = 'ACT'\");\n\t\t\t\n\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t$data[] = getCurrentStrategy($row['user'], mysqli_result(mysqli_query($link, \"SELECT tournament FROM rounds WHERE id = $roundId\"), 0));\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\t// \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u044e \u043e \u0440\u0430\u0443\u043d\u0434\u0435\n\tfunction getRoundData($roundId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$roundId = intval($roundId);\n\t\t\t$query = mysqli_query($link, \"SELECT * FROM rounds WHERE id = $roundId\");\n\t\t\t\n\t\t\tif ($row = mysqli_fetch_assoc($query))\n\t\t\t{\n\t\t\t\t$data['id'] \t\t= $row['game'];\n\t\t\t\t$data['tournament']\t= $row['tournament'];\n\t\t\t\t$data['game']\t\t= $row['game'];\n\t\t\t\t$data['name'] \t\t= $row['name'];\n\t\t\t\t$data['date'] \t\t= $row['date'];\n\t\t\t\t$data['visible'] \t= $row['visible'];\n\t\t\t}\n\t\t\tif (!$row || (!isAdmin() && !$data['visible']))\n            {\n\t\t\t\t$data['id'] \t\t= -1;\n\t\t\t\t$data['tournament']\t= \"Unknown\";\n\t\t\t\t$data['game']\t\t= \"Unknown\";\n\t\t\t\t$data['name'] \t\t= \"Unknown\";\n\t\t\t\t$data['date'] \t\t= \"Unknown\";\n\t\t\t\t$data['visible'] \t= false;\n\t\t\t}\n\t\t\t\n\t\t\tmysqli_free_result($query);\n\t\t\t\n\t\t\t$query = mysqli_query($link, \"SELECT * FROM games WHERE id = {$data['id']}\");\n\t\t\tif ($row = mysqli_fetch_assoc($query))\n\t\t\t\t$data['gameName'] = $row['name'];\n\t\t\telse\n\t\t\t\t$data['gameName'] = \"Unknown\";\n\t\t\t\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0442\u0443\u0440\u043d\u0438\u0440 \u043f\u043e \u0440\u0430\u0443\u043d\u0434\u0443\n\tfunction getTournamentByRound($roundId)\n\t{\n\t\t$roundData = getRoundData($roundId);\n\t\treturn $roundData['tournament'];\n\t}\n\t\n\t// \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u044e\u0437\u0435\u0440\u043e\u0432 \u0438 \u043e\u0447\u043a\u0438 \u0432 \u0440\u0430\u0443\u043d\u0434\u0435\n\tfunction getUsersRoundScores($roundId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$roundId = intval($roundId);\n\t\t\t$query = mysqli_query($link, \"SELECT users.login AS name, users.id AS id, score FROM scores INNER JOIN strategies ON scores.strategy = strategies.id INNER JOIN users ON strategies.user = users.id WHERE scores.round = $roundId ORDER BY score DESC\");\n\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t$data[] = $row;\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n    \n    // \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u044e\u0437\u0435\u0440\u043e\u0432 \u0438 \u043e\u0447\u043a\u0438 \u0432 \u0440\u0430\u0443\u043d\u0434\u0435 \u0431\u0435\u0437 \u0441\u043e\u0440\u0442\u0438\u0440\u043e\u0432\u043a\u0438\n\tfunction getUsersRoundScoresNoSort($roundId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$roundId = intval($roundId);\n\t\t\t$query = mysqli_query($link, \"SELECT users.login AS name, users.id AS id, score FROM scores INNER JOIN strategies ON scores.strategy = strategies.id INNER JOIN users ON strategies.user = users.id WHERE scores.round = $roundId\");\n\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t$data[] = $row;\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\t// \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u044e \u043f\u043e \u0442\u0430\u0431\u043b\u0438\u0446\u0435 \u0440\u0430\u0443\u043d\u0434\u0430\n\tfunction getRoundTable($roundId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$roundId = intval($roundId);\n\t\t\t$query = mysqli_query($link, \"SELECT users.id AS id, users.login AS name, score FROM scores INNER JOIN strategies ON scores.strategy = strategies.id INNER JOIN users ON strategies.user = users.id WHERE scores.round = $roundId ORDER BY score DESC\");\n\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t$data[] = $row;\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\t// \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0441\u0442\u0430\u0442\u0443\u0441 \u0434\u0443\u044d\u043b\u0438\n\tfunction getDuelStatus($roundId, $user1, $user2)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = \"\";\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$roundId \t= intval($roundId);\n\t\t\t$user1 \t\t= intval($user1);\n\t\t\t$user2 \t\t= intval($user2);\n\t\t\t$query = mysqli_query($link, \"SELECT duels.status AS status, duels.id AS id FROM duels INNER JOIN strategies s1 ON duels.strategy1 = s1.id INNER JOIN strategies s2 ON duels.strategy2 = s2.id WHERE duels.round = $roundId AND s1.user = $user1 AND s2.user = $user2\");\n\t\t\t$data = mysqli_fetch_assoc($query);\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\t// Admin Panel\n\t\n\t// \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0434\u0430\u043d\u043d\u044b\u0435 \u043f\u043e \u0438\u0433\u0440\u0430\u043c\n\tfunction getTournamentList($tournamentId = -1)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$tournamentId = intval($tournamentId);\n\t\t\tif ($tournamentId == -1)\n\t\t\t\t$query = mysqli_query($link, \"SELECT id, name FROM tournaments\");\n\t\t\telse\n\t\t\t\t$query = mysqli_query($link, \"SELECT * FROM tournaments WHERE id = $tournamentId\");\n\t\t\t\t\n\t\t\tif ($tournamentId == -1)\n\t\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t\t$data[] = $row;\n\t\t\telse\n\t\t\t\t$data = mysqli_fetch_assoc($query);\n\t\t\t\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\t// \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0441\u043f\u0438\u0441\u043e\u043a \u0438\u0433\u0440\n\tfunction getGameList($gameId = -1)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$gameId = intval($gameId);\n\t\t\tif ($gameId == -1)\n\t\t\t\t$query = mysqli_query($link, \"SELECT * FROM games\");\n\t\t\telse\n\t\t\t\t$query = mysqli_query($link, \"SELECT * FROM games WHERE id = $gameId\");\n\t\t\t\n\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t$data[] = $row;\n\t\t\t\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\t// \u0441\u043e\u0437\u0434\u0430\u0442\u044c \u0442\u0443\u0440\u043d\u0438\u0440\n\tfunction createNewTournament($name, $game, $description, $state, $checker)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$name \t\t\t= mysqli_real_escape_string($link, $name);\n\t\t\t$description \t= mysqli_real_escape_string($link, $description);\n\t\t\t$state\t\t\t= mysqli_real_escape_string($link, $state);\n\t\t\t$game\t\t\t= intval($game);\n\t\t\t$checker\t\t= intval($checker);\n\t\t\t\n\t\t\tif (mysqli_query($link, \"INSERT INTO tournaments SET name = '$name', game = $game, description = '$description', state = '$state', defaultChecker = $checker\"))\n\t\t\t\treturn 0;\n\t\t\telse\n\t\t\t\treturn 1;\n\t\t}\n\t\telse return 2;\n\t}\n\t\n\t// \u043e\u0431\u043d\u043e\u0432\u0438\u0442\u044c \u0442\u0443\u0440\u043d\u0438\u0440\n\tfunction updateTournament($id, $name, $game, $description, $state, $checker)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$id \t\t\t= intval($id);\n\t\t\t$game \t\t\t= intval($game);\n\t\t\t$checker \t\t= intval($checker);\n\t\t\t$name\t\t\t= mysqli_real_escape_string($link, $name);\n\t\t\t$description \t= mysqli_real_escape_string($link, $description);\n\t\t\t$state\t\t\t= mysqli_real_escape_string($link, $state);\n\t\t\t\n\t\t\tif (mysqli_query($link, \"UPDATE tournaments SET name = '$name', game = $game, description = '$description', state = '$state', defaultChecker = $checker WHERE id = $id\"))\n\t\t\t\treturn 0;\n\t\t\telse\n\t\t\t\treturn 1;\n\t\t}\n\t\telse return 2;\n\t}\n\t\n\t// \u0443\u0434\u0430\u043b\u0438\u0442\u044c \u0442\u0443\u0440\u043d\u0438\u0440\n\tfunction deleteTournament($id)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$id = intval($id);\n\t\t\tif (mysqli_query($link, \"DELETE FROM tournaments WHERE id = $id\"))\n\t\t\t\treturn 0;\n\t\t\telse\n\t\t\t\treturn 1;\n\t\t}\n\t\telse return 2;\n\t}\n\t\n\t// \u0441\u043e\u0437\u0434\u0430\u0442\u044c \u0438\u0433\u0440\u0443\n\tfunction createGame($name, $description, $visualizer, $timeLimit, $memoryLimit)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$name \t\t\t= mysqli_real_escape_string($link, $name);\n\t\t\t$description \t= mysqli_real_escape_string($link, $description);\n\t\t\t$timeLimit \t\t= intval($timeLimit);\n\t\t\t$memoryLimit \t= intval($memoryLimit);\n\t\t\t\n\t\t\t$queryText = \"INSERT INTO games SET name = '$name', description = '$description'\";\n\t\t\tif ($timeLimit != \"\")\n\t\t\t\t$queryText .= \", timeLimit = $timeLimit\";\n\t\t\tif ($memoryLimit != \"\")\n\t\t\t\t$queryText .= \", memoryLimit = $memoryLimit\";\n\t\t\t\t\n\t\t\tif (mysqli_query($link, $queryText))\n\t\t\t{\n\t\t\t\t$gameId = mysqli_insert_id($link);\n\t\t\t\n\t\t\t\tif ($_FILES[$visualizer][\"error\"] == 0)\n\t\t\t\t{\n\t\t\t\t\t$result = saveVisualizer($gameId, $visualizer);\n\t\t\t\t\tif ($result == true)\n\t\t\t\t\t\treturn 0;\n\t\t\t\t\telse\n\t\t\t\t\t\treturn -1;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tmysqli_query($link, \"DELETE FROM games WHERE id = $gameId\");\n\t\t\t\t\treturn 1;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse return 2;\n\t\t}\n\t\telse return 3;\n\t}\n\t\n\t// \u043e\u0431\u043d\u043e\u0432\u0438\u0442\u044c \u0438\u0433\u0440\u0443\n\tfunction updateGame($id, $name, $description, $visualizer, $timeLimit, $memoryLimit)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$id \t\t\t= intval($id);\n\t\t\t$name \t\t\t= mysqli_real_escape_string($link, $name);\n\t\t\t$description \t= mysqli_real_escape_string($link, $description);\n\t\t\t$timeLimit \t\t= intval($timeLimit);\n\t\t\t$memoryLimit \t= intval($memoryLimit);\n\t\t\t\n\t\t\tif (mysqli_query($link, \"UPDATE games SET name = '$name', description = '$description', timeLimit = $timeLimit, memoryLimit = $memoryLimit WHERE id = $id\"))\n\t\t\t{\n\t\t\t\tif ($_FILES[$visualizer][\"error\"] == 0)\n\t\t\t\t{\n\t\t\t\t\t$result = saveVisualizer($id, $visualizer);\n\t\t\t\t\tif ($result == true)\n\t\t\t\t\t\treturn 0;\n\t\t\t\t\telse\n\t\t\t\t\t\treturn -1;\n\t\t\t\t}\n\t\t\t\telse return 1;\n\t\t\t}\n\t\t\telse return 2;\n\t\t}\n\t\telse return 3;\n\t}\n\t\n\t// \u0443\u0434\u0430\u043b\u0438\u0442\u044c \u0438\u0433\u0440\u0443\n\tfunction deleteGame($gameId)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$gameId = intval($gameId);\n\t\t\tif (mysqli_query($link, \"DELETE FROM games WHERE id = $gameId\"))\n\t\t\t\treturn 0;\n\t\t\telse\n\t\t\t\treturn 1;\n\t\t}\n\t\telse return 2;\n\t}\n\t\n\t// \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u043f\u0443\u0442\u044c \u043a \u0432\u0438\u0437\u0443\u0430\u043b\u0438\u0437\u0430\u0442\u043e\u0440\u0443\n\tfunction getVisualizerPath($id)\n\t{\n\t\treturn addslashes(\"./visualizers/\").$id;\n\t}\n\t\n\t// \u0443\u0434\u0430\u043b\u0438\u0442\u044c \u0432\u0438\u0437\u0443\u0430\u043b\u0438\u0437\u0430\u0442\u043e\u0440\n\tfunction deleteVizualizer($gameId)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$gameId = intval($gameId);\n\t\t\tif (mysqli_query($link, \"UPDATE games SET hasVisualizer = 0 WHERE id = $gameId\"))\n\t\t\t{\n\t\t\t\tremoveDir(getVisualizerPath($gameId));\n\t\t\t\tif (!file_exists(getVisualizerPath($gameId)))\n\t\t\t\t\treturn 0;\n\t\t\t\telse\n\t\t\t\t\treturn -1;\n\t\t\t}\n\t\t\telse return 1;\n\t\t}\n\t\telse return 2;\n\t}\n\t\n\t// \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0441\u043f\u0438\u0441\u043e\u043a \u0440\u0430\u0443\u043d\u0434\u043e\u0432 \u0442\u0443\u0440\u043d\u0438\u0440\u0430\n\tfunction getRoundList($tournamentId, $roundId = -1)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$tournamentId \t= intval($tournamentId);\n\t\t\t$roundId\t\t= intval($roundId);\n\t\t\t$text = \"SELECT * FROM rounds WHERE tournament = $tournamentId\";\n\t\t\tif ($roundId != -1)\n\t\t\t\t$text .= \" AND id = $roundId\";\n\t\t\t$text .= \" ORDER BY id\";\n\t\t\t$query = mysqli_query($link, $text);\n\t\t\t\n\t\t\tif ($roundId == -1)\t\n\t\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t\t$data[] = $row;\n\t\t\telse\n\t\t\t\t$data = mysqli_fetch_assoc($query);\n\t\t\t\t\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\t/*\n\t\t\u0435\u0449\u0435\n\t*/\n\t\n\t// checkers\n\tfunction getCheckerList($checkerId = -1)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$checkerId = intval($checkerId);\n\t\t\t$text = \"SELECT * FROM checkers\";\n\t\t\tif ($checkerId != -1)\n\t\t\t\t$text .= \" WHERE id = $checkerId\";\n\t\t\t$query = mysqli_query($link, $text);\n\t\t\t\n\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t$data[] = $row;\n\t\t\t\t\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\t\n\t// \u0421\u043e\u0445\u0440\u0430\u043d\u0438\u0442\u044c checker\n\tfunction saveChecker($name, $game, $checker, $hasSeed)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$name = mysqli_real_escape_string($link, $name);\n\t\t\t$game = intval($game);\n\t\t\t$hasSeed = intval($hasSeed);\n\t\t\t\n\t\t\tif (mysqli_query($link, \"INSERT INTO checkers SET name = '$name', game = $game, hasSeed = $hasSeed\") == true)\n\t\t\t{\n\t\t\t\tif ($_FILES[$checker][\"error\"] == 0)\n\t\t\t\t{\n\t\t\t\t\t$checkerId = mysqli_insert_id($link);\n\t\t\t\t\t$result = saveTester($checkerId, $checker);\n\t\t\t\t\tif ($result != 0)\n\t\t\t\t\t\tmysqli_query($link, \"DELETE FROM checkers WHERE id = $checkerId\");\n\t\t\t\t\t\t\n\t\t\t\t\tif ($result == 0 || $result == -1)\n\t\t\t\t\t\treturn $result;\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tmysqli_query($link, \"DELETE FROM checkers WHERE id = $checkerId\");\n\t\t\t\t\t\tremoveDir(getCheckerById($checkerId));\n\t\t\t\t\t\treturn 'e' . $result;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse \n\t\t\t\t{\n\t\t\t\t\tmysqli_query($link, \"DELETE FROM checkers WHERE id = $checkerId\");\n\t\t\t\t\treturn 1;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse return 2;\n\t\t}\n\t\telse return 3;\n\t}\n\t\n\t// \u041e\u0431\u043d\u043e\u0432\u0438\u0442\u044c checker\n\tfunction updateChecker($id, $name, $game, $checker, $hasSeed)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$id \t= intval($id);\n\t\t\t$name \t= mysqli_real_escape_string($link, $name);\n\t\t\t$game \t= intval($game);\n\t\t\t$hasSeed = intval($hasSeed);\n\t\t\t\n\t\t\tif (mysqli_query($link, \"UPDATE checkers SET name = '$name', game = $game, hasSeed = $hasSeed WHERE id = $id\") == true)\n\t\t\t{\n\t\t\t\tif ($_FILES[$checker][\"error\"] == 0)\n\t\t\t\t{\n\t\t\t\t\t$result = saveTester($id, $checker);\n\t\t\t\t\tif ($result == 0 || $result == -1)\n\t\t\t\t\t\treturn $result;\n\t\t\t\t\telse\n\t\t\t\t\t\treturn 'e' . $result;\n\t\t\t\t}\n\t\t\t\telse return 1;\n\t\t\t}\n\t\t\telse return 2;\n\t\t}\n\t\telse return 3;\n\t}\n\t\n\tfunction getCheckerById($checkerId)\n\t{\n\t\treturn addslashes(\"./testers/\").$checkerId;\n\t}\n\t\n\tfunction getCheckerExeById($checkerId)\n\t{\n\t\treturn addslashes(\"./testers_bin/\").$checkerId.\".exe\";\n\t}\n\t\n\tfunction deleteChecker($checkerId)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$checkerId = intval($checkerId);\n\t\t\tif (mysqli_query($link, \"DELETE FROM checkers WHERE id = $checkerId\") == true)\n\t\t\t{\n\t\t\t\t\n\t\t\t\tremoveDir(getCheckerById($checkerId));\n\t\t\t\tremoveDir(getCheckerExeById($checkerId));\n\t\t\t\t\n\t\t\t\tif (!file_exists(getCheckerById($checkerId)) && !file_exists(getCheckerExeById($checkerId)))\n\t\t\t\t\treturn 0;\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tif (file_exists(getCheckerById($checkerId)) && file_exists(getCheckerExeById($checkerId)))\n\t\t\t\t\t\treturn 1;\n\t\t\t\t\telse if (file_exists(getCheckerById($checkerId)))\n\t\t\t\t\t\treturn 2;\n\t\t\t\t\telse\n\t\t\t\t\t\treturn 3;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse return 4;\n\t\t}\n\t\telse return 5;\n\t}\n\t\n\t// \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u043b\u0438\u0441\u0442 \u0447\u0435\u043a\u0435\u0440\u043e\u0432 \u043f\u043e \u0438\u0433\u0440\u0430\u043c\n\tfunction getCheckerListByGameId($gameId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$gameId = intval($gameId);\n\t\t\t\n\t\t\t$query = mysqli_query($link, \"SELECT * FROM checkers WHERE game = $gameId\");\n\t\t\t\n\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t$data[] = $row;\n\t\t\t\t\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\t// \u0421\u043e\u0437\u0434\u0430\u0442\u044c \u0440\u0430\u0443\u043d\u0434\n\tfunction createRound($tournamentId, $roundName, $checker, $previousRound, $seed)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$tournament = getTournamentList($tournamentId);\n\t\t\t$gameId = $tournament['game'];\n\t\t\t$roundName = mysqli_real_escape_string($link, $roundName);\n\t\t\t$checker = mysqli_real_escape_string($link, $checker);\n\t\t\t$previousRound \t= mysqli_real_escape_string($link, $previousRound);\n\t\t\t\n\t\t\tif (mysqli_query($link, \"INSERT INTO rounds SET tournament = $tournamentId, name = '$roundName', game = $gameId, checker = $checker, previousRound = $previousRound, seed = $seed\"))\n\t\t\t\treturn 0;\n\t\t\telse\n\t\t\t\treturn 1;\n\t\t}\n\t\telse return 2;\n\t}\n\t\n\t// \u041e\u0431\u043d\u043e\u0432\u0438\u0442\u044c \u0440\u0430\u0443\u043d\u0434\n\tfunction updateRound($tournamentId, $roundId, $roundName, $checker, $previousRound, $seed)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$tournament = getTournamentList($tournamentId);\n\t\t\t$gameId\t= $tournament['game'];\n\t\t\t\n\t\t\t$roundName = mysqli_real_escape_string($link, $roundName);\n\t\t\t$checker = intval($checker);\n\t\t\t$previousRound = intval($previousRound);\n\t\t\t\n\t\t\tif (mysqli_query($link, \"UPDATE rounds SET tournament = $tournamentId, name = '$roundName', game = $gameId, checker = $checker, previousRound = $previousRound, seed = $seed WHERE id = $roundId\"))\n\t\t\t\treturn 0;\n\t\t\telse\n\t\t\t\treturn 1;\n\t\t}\n\t\telse return 2;\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u043f\u0440\u0435\u0434\u044b\u0434\u0443\u0449\u0438\u0439 \u0440\u0430\u0443\u043d\u0434\n\tfunction getPreviousRound($roundId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$previousRound = -1;\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$roundId = intval($roundId);\n\t\t\t$query = mysqli_query($link, \"SELECT previousRound FROM rounds WHERE id = $roundId\");\n\t\t\t$data = mysqli_fetch_assoc($query);\n\t\t\t$previousRound = $data['previousRound'];\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $previousRound;\n\t}\n\t\n\t// \u041e\u0431\u043d\u043e\u0432\u0438\u0442\u044c \u0434\u043e\u043f\u0443\u0449\u0435\u043d\u043d\u044b\u0445 \u043a \u0440\u0430\u0443\u043d\u0434\u0443 \u0438\u0433\u0440\u043e\u043a\u043e\u0432\n\tfunction updateActiveUsers($tournament, $roundId, $activeStrategies)\n\t{\n\t\t// \u0434\u043e\u0434\u0435\u043b\u0430\u0442\u044c\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$roundId = intval($roundId);\n\t\t\tmysqli_query($link, \"DELETE FROM roundActivity WHERE round = $roundId\");\n\t\t\tforeach ($activeStrategies as $stategyId)\n\t\t\t{\n\t\t\t\t$stategyId = intval($stategyId);\n\t\t\t\t$userId = mysqli_result(mysqli_query($link, \"SELECT user FROM strategies WHERE id = $stategyId\"), 0, \"user\");\n\t\t\t\tmysqli_query($link, \"INSERT INTO roundActivity SET round = $roundId, user = $userId, state = 'ACT'\");\n\t\t\t}\n\t\t}\n\t}\n\t\n\t// \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u043a\u043e\u043b\u0438\u0447\u0435\u0441\u0442\u0432\u043e \u0438\u0433\u0440\u043e\u043a\u043e\u0432, \u0434\u043e\u043f\u0443\u0449\u0435\u043d\u043d\u044b\u0445 \u0432 \u0442\u0435\u043a\u0443\u0449\u0438\u0439 \u0440\u0430\u0443\u043d\u0434\n\tfunction getAcceptedRoundUsers($roundId)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$roundId = intval($roundId);\n\t\t\treturn mysqli_num_rows(mysqli_query($link, \"SELECT * FROM roundActivity WHERE round = $roundId AND state = 'ACT'\"));\n\t\t}\n\t\telse return 0;\n\t}\n\t\n\t/*\n\t// \u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0432\u0441\u0435\u0445 \u044e\u0437\u0435\u0440\u043e\u0432 \u0441 \u0430\u043a\u0442\u0438\u0432\u043d\u044b\u043c\u0438 \u0441\u0442\u0430\u0442\u0435\u0433\u0438\u044f\u043c\u0438\n\tfunction getActiveStrategiesFromTournament($tournamentId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$query = mysqli_query($link, \"SELECT str.id, usr.login FROM strategies AS str INNER JOIN users AS usr ON usr.id = str.user WHERE str.tournament = $tournamentId AND str.status = 'ACT'\");\n\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t$data[] = $row;\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t*/\n\t\n\t// \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0430\u043a\u0442\u0438\u0432\u043d\u044b\u0445 \u044e\u0437\u0435\u0440\u043e\u0432 \u0432 \u044d\u0442\u043e\u043c \u0440\u0430\u0443\u043d\u0434\u0435\n\tfunction getAcceptedUsers($roundId, $previousRoundId, $tournamentId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$roundId \t\t\t= intval($roundId);\n\t\t\t$previousRoundId \t= intval($previousRoundId);\n\t\t\t$tournamentId \t\t= intval($tournamentId);\n\t\t\t$queryText \t\t\t= \"\";\n\t\t\t\n\t\t\tif ($previousRoundId == -1)\n\t\t\t{\n\t\t\t\t$queryText = \"SELECT str.id, usr.login FROM strategies AS str INNER JOIN users AS usr ON usr.id = str.user INNER JOIN roundActivity AS rndAct ON usr.id = rndAct.user WHERE rndAct.round = $roundId AND str.tournament = $tournamentId AND str.status = 'ACT' ORDER BY usr.login\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$queryText = \"SELECT str.id, usr.login, scr.score FROM strategies AS str INNER JOIN users AS usr ON usr.id = str.user INNER JOIN scores AS scr ON scr.round = $previousRoundId AND scr.strategy = str.id INNER JOIN roundActivity AS rndAct ON usr.id = rndAct.user WHERE rndAct.round = $roundId AND str.tournament = $tournamentId AND str.status = 'ACT' ORDER BY scr.score DESC\";\n\t\t\t}\n\t\t\t\n\t\t\t//echo \"acceptedUsers: \" . $queryText . '\\n';\n\t\t\t\n\t\t\t$query = mysqli_query($link, $queryText);\n\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t$data[] = $row;\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\n    // \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0432\u043e\u0437\u043c\u043e\u0436\u043d\u044b\u0445 \u044e\u0437\u0435\u0440\u043e\u0432 \u0432 \u0440\u0430\u0443\u043d\u0434\u0435\n    function getPossibleUsers($roundId, $previousRoundId, $tournamentId)\n    {\n        $link = getDBConnection();\n        $data = array();\n        if (mysqli_select_db($link, getDBName()))\n        {\n            $roundId = intval($roundId);\n            $previousRoundId = intval($previousRoundId);\n            $tournamentId = intval($tournamentId);\n            $queryText = \"\";\n        \n            if ($previousRoundId != -1)\n            {\n                $queryText = \"SELECT str.id, usr.login, scr.score FROM strategies AS str INNER JOIN users AS usr ON usr.id = str.user AND usr.group != 'banned' INNER JOIN scores AS scr ON scr.round = $previousRoundId AND scr.strategy = str.id INNER JOIN roundActivity AS rndAct ON usr.id = rndAct.user WHERE rndAct.round = $previousRoundId AND str.tournament = $tournamentId AND str.status = 'ACT' AND usr.id NOT IN (SELECT user FROM roundActivity WHERE round = $roundId AND state = 'ACT') ORDER BY scr.score DESC\";\n            }\n            else\n            {\n                $queryText = \"SELECT str.id, usr.login FROM strategies AS str INNER JOIN users AS usr ON usr.id = str.user AND usr.group != 'banned' WHERE str.tournament = $tournamentId AND str.status = 'ACT' AND usr.id NOT IN (SELECT user FROM roundActivity WHERE round = $roundId AND state = 'ACT')\";\n                $queryText .= \" ORDER BY usr.login\";\n            }\n            \t\t\t\n            $query = mysqli_query($link, $queryText);\n            while ($row = mysqli_fetch_assoc($query))\n                $data[] = $row;\n            mysqli_free_result($query);\n        }\n        return $data;\n    }\n\t\n\t// \u0415\u0441\u043b\u0438 \u0432 \u0434\u0443\u044d\u043b\u044f\u0445 \u0440\u0430\u0443\u043d\u0434 \u043f\u0440\u043e\u0432\u0435\u0434\u0435\u043d, \u0442\u043e \u043f\u043e\u0432\u0442\u043e\u0440\u043d\u044b\u0439 \u0440\u0430\u0437 \u043c\u043e\u0436\u043d\u043e \u043d\u0435 \u0434\u0435\u043b\u0430\u0442\u044c\n\tfunction checkRoundInDuels($roundId)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$roundId = intval($roundId);\n\t\t\treturn mysqli_result(mysqli_query($link, \"SELECT COUNT(*) FROM duels WHERE round = $roundId\"), 0);\n\t\t}\n\t}\n\t\n\tfunction isRoundVisible($roundId)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$roundId = intval($roundId);\n\t\t\treturn mysqli_result(mysqli_query($link, \"SELECT COUNT(*) FROM rounds WHERE id = $roundId AND visible = true\"), 0);\n\t\t}\n\t}\n\t\n\tfunction setRoundVisible($roundId, $visibility = true)\n    {\n        if ($visibility)\n            $visibility = \"true\";\n        else\n            $visibility = \"false\";\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$roundId = intval($roundId);\n\t\t\tif (mysqli_query($link, \"UPDATE rounds SET visible = $visibility WHERE id = $roundId\"))\n\t\t\t\treturn 0;\n\t\t\telse\n\t\t\t\treturn 1;\n\t\t}\n\t\telse return 2;\n\t}\n\t\n\t// \u041a\u043e\u043b\u0438\u0447\u0435\u0441\u0442\u0432\u043e \u043f\u0440\u043e\u0432\u0435\u0440\u0435\u043d\u043d\u044b\u0445 \u0434\u0443\u044d\u043b\u0435\u0439\n\tfunction getCheckedDuels($roundId)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$roundId = intval($roundId);\n\t\t\treturn mysqli_result(mysqli_query($link, \"SELECT COUNT(*) FROM duels WHERE round = $roundId AND status <> 'W'\"), 0);\n\t\t}\n\t}\n\t\n\t// \u043f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 \u0437\u0430\u0432\u0435\u0440\u0448\u0435\u043d\u0438\u044f \u043f\u0440\u043e\u0432\u0435\u0440\u0435\u043a \u0440\u0430\u0443\u043d\u0434\u0430\n\tfunction checkRoundEnding($roundId)\n\t{\t\n\t\tif ($roundId == -1)\n\t\t\treturn false;\n\t\t$roundCount = getCheckedDuels($roundId);\n\t\tif ($roundCount == 0)\n\t\t\treturn false;\n\t\telse\n\t\t\treturn $roundCount == checkRoundInDuels($roundId);\n\t}\n\t\n\t// \u041d\u043e\u0432\u043e\u0441\u0442\u0438\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0432\u0441\u0435 \u043d\u043e\u0432\u043e\u0441\u0442\u0438\n\tfunction getNewsData($newsId = -1)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$newsId = intval($newsId);\n\t\t\t$queryText = \"SELECT * FROM news\";\n\t\t\t\n\t\t\tif ($newsId != -1)\n\t\t\t{\n\t\t\t\t$queryText .= \" WHERE id = $newsId\";\n\t\t\t}\n\t\t\t\n\t\t\t$queryText .= \" ORDER BY date DESC, id DESC\";\n\t\t\t\n\t\t\t$query = mysqli_query($link, $queryText);\n\t\t\tif ($newsId == -1)\n\t\t\t{\n\t\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t\t$data[] = $row;\n\t\t\t} \n\t\t\telse\n\t\t\t{\n\t\t\t\t$data = mysqli_fetch_assoc($query);\n\t\t\t}\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\t// \u0441\u043e\u0437\u0434\u0430\u0442\u044c \u043d\u043e\u0432\u043e\u0441\u0442\u044c\n\tfunction createNews($header, $text, $date)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$header = mysqli_real_escape_string($link, $header);\n\t\t\t$text \t= mysqli_real_escape_string($link, $text);\n\t\t\t$date\t= mysqli_real_escape_string($link, $date);\n\t\t\tif (mysqli_query($link, \"INSERT INTO news SET header = '$header', text = '$text', date = '$date'\"))\n\t\t\t\treturn 0;\n\t\t\telse\n\t\t\t\treturn 1;\n\t\t}\n\t\telse return 2;\n\t}\n\t\n\t// \u043e\u0431\u043d\u043e\u0432\u0438\u0442\u044c \u043d\u043e\u0432\u043e\u0441\u0442\u044c\n\tfunction updateNews($newsId, $header, $text, $date)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$newsId = intval($newsId);\n\t\t\t$header = mysqli_real_escape_string($link, $header);\n\t\t\t$text \t= mysqli_real_escape_string($link, $text);\n\t\t\t$date\t= mysqli_real_escape_string($link, $date);\n\t\t\tif (mysqli_query($link, \"UPDATE news SET header = '$header', text = '$text', date = '$date' WHERE id = $newsId\"))\n\t\t\t\treturn 0;\n\t\t\telse\n\t\t\t\treturn 1;\n\t\t}\n\t\telse return 2;\n\t}\n\t\n\t// \u0443\u0434\u0430\u043b\u0438\u0442\u044c \u043d\u043e\u0432\u043e\u0441\u0442\u044c\n\tfunction deleteNews($newsId)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$newsId = intval($newsId);\n\t\t\tif (mysqli_query($link, \"DELETE FROM news WHERE id = $newsId\"))\n\t\t\t\treturn 0;\n\t\t\telse\n\t\t\t\treturn 1;\n\t\t}\n\t\telse return 2;\n\t}\n\t\n\t// reverse date\n\tfunction reverseDate($oldDate, $delimiter)\n\t{\n\t\t$postDate = explode($delimiter, $oldDate);\n\t\treturn $postDate[2].\"-\".$postDate[1].\"-\".$postDate[0];\n\t}\n\t\n\t// \u041a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u0438\n\t\n\t// \u041a\u043e\u043b\u0438\u0447\u0435\u0441\u0442\u0432\u043e \u043a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u0435\u0432 \u043a \u043d\u043e\u0432\u043e\u0441\u0442\u044f\u043c\n\tfunction getCommentsCount($newsId)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$newsId = intval($newsId);\n\t\t\treturn mysqli_result(mysqli_query($link, \"SELECT COUNT(*) FROM newsComments WHERE news = $newsId\"), 0);\n\t\t}\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u043a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u0438\n\tfunction getComments($newsId)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$newsId = intval($newsId);\n\t\t\t$data \t= array();\n\t\t\t\n\t\t\t$query = mysqli_query($link, \"SELECT * from newsComments WHERE news = $newsId ORDER BY date ASC\");\n\t\t\t\n\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t$data[] = $row;\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\tfunction getComment($commentId)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$newsId = intval($newsId);\n\t\t\t$data \t= array();\n\t\t\t\n\t\t\t$query = mysqli_query($link, \"SELECT * from newsComments WHERE id = $commentId ORDER BY date ASC\");\n\t\t\t\n\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t$data[] = $row;\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\t// \u041e\u0442\u043f\u0440\u0430\u0432\u0438\u0442\u044c \u043a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u0439\n\tfunction sendComments($newsId, $text)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$newsId \t\t= intval($newsId);\n\t\t\t$currentUserId \t= intval(getActiveUserID());\n\t\t\t$text = mysqli_real_escape_string($link, $text);\n\t\t\tif ($currentUserId != -1)\n\t\t\t{\n\t\t\t\t$query = mysqli_query($link, \"INSERT INTO newsComments SET news = $newsId, user = $currentUserId, text = '$text', date = NOW()\");\n\t\t\t}\n\t\t}\n\t}\n\t\n\t// \u0418\u0437\u043c\u0435\u043d\u0438\u0442\u044c \u043a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u0439\n\tfunction updateComment($commentId, $text)\n\t{\n\t\t$cData = getComment($commentId);\n\t\tif ($cData[0]['user'] == getActiveUserID() || isAdmin() || isModerator())\n\t\t{\n\t\t\t$link = getDBConnection();\n\t\t\tif (mysqli_select_db($link, getDBName()))\n\t\t\t{\n\t\t\t\t$commentId \t= intval($commentId);\n\t\t\t\t$text \t\t= mysqli_real_escape_string($link, $text);\n\t\t\t\n\t\t\t\tmysqli_query($link, \"UPDATE newsComments SET text = '$text' WHERE id = $commentId\");\n\t\t\t}\n\t\t}\n\t}\n\t\n\t// \u0423\u0434\u0430\u043b\u0438\u0442\u044c \u043a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u0439\n\tfunction deleteComment($commentId)\n\t{\n\t\t$cData = getComment($commentId);\n\t\tif ($cData[0]['user'] == getActiveUserID() || isAdmin() || isModerator())\n\t\t{\n\t\t\t$link = getDBConnection();\n\t\t\tif (mysqli_select_db($link, getDBName()))\n\t\t\t{\n\t\t\t\t$commentId = intval($commentId);\n\t\t\t\tmysqli_query($link, \"DELETE FROM newsComments WHERE id = $commentId\");\n\t\t\t}\n\t\t}\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0442\u0435\u043a\u0441\u0442 \u043a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u044f\n\tfunction getCommentText($commentId)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$commentId = intval($commentId);\n\t\t\treturn mysqli_result(mysqli_query($link, \"SELECT text FROM newsComments WHERE id = $commentId\"), 0);\n\t\t}\n\t}\n\t\n\t// FAQ\n\t\n\t// \u041e\u0442\u043f\u0440\u0430\u0432\u043a\u0430 \u0432\u043e\u043f\u0440\u043e\u0441\u0430\n\tfunction sendQuestion($text)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$currentUserId \t= intval(getActiveUserID());\n\t\t\t$text \t\t\t= mysqli_real_escape_string($link, $text);\n\t\t\t\n\t\t\tif (mysqli_query($link, \"INSERT INTO userQuestions SET user = $currentUserId, question = '$text', status = 'opened'\"))\n\t\t\t\treturn 0;\n\t\t\telse\n\t\t\t\treturn 1;\n\t\t}\n\t\telse return 2;\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u0432\u043e\u043f\u0440\u043e\u0441\u043e\u0432 \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0435\u043d\u043d\u043e\u0433\u043e \u0441\u0442\u0430\u0442\u0443\u0441\u0430\n\tfunction getQuestions($state)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$state = mysqli_real_escape_string($link, $state);\n\t\t\t$query = mysqli_query($link, \"SELECT * FROM userQuestions WHERE status = '$state'\");\n\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t$data[] = $row;\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u043a\u043e\u043b\u0438\u0447\u0435\u0441\u0442\u0432\u0430 \u043e\u0442\u043a\u0440\u044b\u0442\u044b\u0445 \u0432\u043e\u043f\u0440\u043e\u0441\n\tfunction getOpenedQuestionCount()\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\treturn mysqli_result(mysqli_query($link, \"SELECT COUNT(*) FROM userQuestions WHERE status = 'opened'\"), 0);\n\t\t}\n\t\telse return 0;\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0441\u0442\u0430\u0442\u0443\u0441 \u043f\u043e id\n\tfunction getQuestionStatusById($statusId)\n\t{\n\t\t$data = array(\"opened\", \"answered\", \"closed\");\n\t\treturn $data[$statusId];\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0432\u043e\u043f\u0440\u043e\u0441\u044b\n\tfunction getQuestionData($statusId)\n\t{\n\t\treturn getQuestions(getQuestionStatusById($statusId));\n\t}\n\t\n\t// \u0412\u044b\u0431\u0440\u0430\u043d\u043d\u044b\u0439 \u0432\u043e\u043f\u0440\u043e\u0441\n\tfunction getQuestionById($questionId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$questionId = intval($questionId);\n\t\t\treturn mysqli_fetch_assoc(mysqli_query($link, \"SELECT * FROM userQuestions WHERE id = $questionId\"));\n\t\t}\n\t}\n\t\n\t// \u0421\u043e\u0437\u0434\u0430\u0442\u044c \u0432\u043e\u043f\u0440\u043e\u0441\n\tfunction createAnswer($question, $answer)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$answer \t\t= mysqli_real_escape_string($link, $answer);\n\t\t\t$question \t\t= mysqli_real_escape_string($link, $question);\n\t\t\t$currentUserId \t= intval(getActiveUserID());\n\t\t\t\n\t\t\tif (mysqli_query($link, \"INSERT INTO userQuestions SET user = $currentUserId, question = '$question', answer = '$answer', status = 'answered'\"))\n\t\t\t\treturn 0;\n\t\t\telse\n\t\t\t\treturn 1;\n\t\t}\n\t\telse return 2;\n\t}\n\t\n\t// \u041e\u0442\u0440\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0432\u043e\u043f\u0440\u043e\u0441\n\tfunction updateAnswer($postQuestionId, $question, $answer)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$postQuestionId = intval($postQuestionId);\n\t\t\t$answer \t\t= mysqli_real_escape_string($link, $answer);\n\t\t\t$question \t\t= mysqli_real_escape_string($link, $question);\n\t\t\t\n\t\t\tif (mysqli_query($link, \"UPDATE userQuestions SET question = '$question', answer = '$answer', status = 'answered' WHERE id = $postQuestionId\"))\n\t\t\t\treturn 0;\n\t\t\telse\n\t\t\t\treturn 1;\n\t\t}\n\t\telse return 2;\n\t}\n\t\n\t// \u0417\u0430\u043a\u0440\u044b\u0442\u044c \u0432\u043e\u043f\u0440\u043e\u0441\n\tfunction closeAnswer($questionId)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$questionId = intval($questionId);\n\t\t\tif (mysqli_query($link, \"UPDATE userQuestions SET status = 'closed' WHERE id = $questionId\"))\n\t\t\t\treturn 0;\n\t\t\telse\n\t\t\t\treturn 1;\n\t\t}\n\t\telse return 2;\n\t}\n\t\n\t// \u0410ttachments\n\tfunction getAttachments($gameId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$gameId = intval($gameId);\n\t\t\t\n\t\t\t$queryText = \"SELECT * FROM attachments WHERE game = $gameId\";\n\t\t\n\t\t\t$query = mysqli_query($link, $queryText);\n\t\t\t\n\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t$data[] = $row;\n\t\t\t\t\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\tfunction getAttachmentById($attachmentId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$attachmentId = intval($attachmentId);\n\t\t\t\n\t\t\t$query = mysqli_query($link, \"SELECT * FROM attachments WHERE id = $attachmentId\");\n\t\t\t$data = mysqli_fetch_assoc($query);\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\tfunction getAttachmentPath($id)\n\t{\n\t\treturn addslashes(\"./attachments/\").$id;\n\t}\n\t\n\tfunction createAttachment($gameId, $originalName, $description, $attachment)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$gameId\t\t\t= intval($gameId);\n\t\t\t$originalName \t= mysqli_real_escape_string($link, $originalName);\n\t\t\t$description \t= mysqli_real_escape_string($link, $description);\n\t\t\tif (mysqli_query($link, \"INSERT INTO attachments SET game = $gameId, originalName = '$originalName', description = '$description'\") == true)\n\t\t\t{\n\t\t\t\t$attachmentId = mysqli_insert_id($link);\n\t\t\t\n\t\t\t\tif ($_FILES[$attachment][\"error\"] == 0)\n\t\t\t\t{\n\t\t\t\t\t$result = saveAttachment($attachmentId, $attachment);\n\t\t\t\t\tif ($result == true)\n\t\t\t\t\t\treturn 0;\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tmysqli_query($link, \"DELETE FROM attachments WHERE id = $attachmentId\");\n\t\t\t\t\t\treturn -1;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tmysqli_query($link, \"DELETE FROM attachments WHERE id = $attachmentId\");\n\t\t\t\t\treturn 1;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse return 2;\n\t\t}\n\t\telse return 3;\n\t}\n\t\n\tfunction updateAttachment($attachmentId, $gameId, $originalName, $description, $attachment)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$attachmentId\t\t\t= intval($attachmentId);\n\t\t\t$gameId\t\t\t\t\t= intval($gameId);\n\t\t\t$originalName \t\t\t= mysqli_real_escape_string($link, $originalName);\n\t\t\t$description \t\t\t= mysqli_real_escape_string($link, $description);\n\t\t\tif (mysqli_query($link, \"UPDATE attachments SET game = $gameId, originalName = '$originalName', description = '$description' WHERE id = $attachmentId\"))\n\t\t\t{\n\t\t\t\tif ($_FILES[$attachment][\"error\"] == 0)\n\t\t\t\t{\n\t\t\t\t\t$result = saveAttachment($attachmentId, $attachment);\n\t\t\t\t\tif ($result == true)\n\t\t\t\t\t\treturn 0;\n\t\t\t\t\telse\n\t\t\t\t\t\treturn -1;\n\t\t\t\t}\n\t\t\t\telse return 1;\n\t\t\t}\n\t\t\telse return 2;\n\t\t}\n\t\telse return 3;\n\t}\n\t\n\tfunction deleteAttachment($attachmentId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$attachmentId = intval($attachmentId);\n\t\t\tif (mysqli_query($link, \"DELETE FROM attachments WHERE id = $attachmentId\"))\n\t\t\t{\n\t\t\t\tremoveDir(getAttachmentPath($attachmentId));\n\t\t\t\t\n\t\t\t\tif (!file_exists(getAttachmentPath($attachmentId)))\n\t\t\t\t\treturn 0;\n\t\t\t\telse\n\t\t\t\t\treturn 1;\n\t\t\t}\n\t\t\telse return 2;\n\t\t}\n\t\telse return 3;\n\t}\n\t\n\t// Ap duels\n\tfunction getGameByRound($roundId)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$roundId = intval($roundId);\n\t\t\treturn mysqli_result(mysqli_query($link, \"SELECT game FROM rounds WHERE id = $roundId\"), 0);\n\t\t}\n\t}\n\t\n\t// Ap images\n\t\n\t// \u0417\u0430\u0433\u0440\u0443\u0437\u043a\u0430 \u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u044f \u043d\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\n\tfunction loadImage($imagePath, $imageType, $imageDescription, $gameId = -1)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$fileName \t\t\t= mysqli_real_escape_string($link, $_FILES[$imagePath]['name']);\n\t\t\t$imageType \t\t\t= mysqli_real_escape_string($link, $imageType);\n\t\t\t$imageDescription \t= mysqli_real_escape_string($link, $imageDescription);\n\t\t\t$gameId\t\t\t\t= intval($gameId);\n\t\t\tmysqli_query($link, \"INSERT INTO images SET type = '$imageType', description = '$imageDescription', game = $gameId, originalName = '$fileName'\");\n\t\t\t$fileId = mysqli_insert_id($link);\n\t\t\t\t\t\t\n\t\t\tif (isset($imagePath) && $_FILES[$imagePath][\"error\"] == 0)\n\t\t\t\tsaveImageOnDisc($fileId, $imagePath);\n\t\t}\n\t}\n\t\n\t\n\t// \u0412\u0441\u043f\u043e\u043c\u043e\u0433\u0430\u0442\u0435\u043b\u044c\u043d\u0430\u044f \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0438\n\tfunction saveImageOnDisc($id, $source)\n\t{\n\t\t$path = addslashes(\"./img/\").$id;\n\t\tsaveFileOnDisc2($path, $source);\n\t}\n\t\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u043f\u0443\u0442\u0438 \u043a \u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u044e \u043f\u043e id\n\tfunction getImageById($imageId)\n\t{\n\t\treturn addslashes(\"./img/\").$imageId;\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u0438 \u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u044f \u043f\u043e id\n\tfunction getImageDataById($imageId)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$imageId = intval($imageId);\n\t\t\t$query = mysqli_query($link, \"SELECT * FROM images WHERE id = $imageId\");\n\t\t\t$data = mysqli_fetch_assoc($query);\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u043f\u0443\u0442\u0438 \u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u044f \u043f\u043e \u043e\u043f\u0438\u0441\u0430\u043d\u0438\u044e\n\tfunction getImageByDescription($description)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$description = mysqli_real_escape_string($link, $description);\n\t\t\t$query = mysqli_query($link, \"SELECT id FROM images WHERE description = '$description'\");\n\t\t\tif (mysqli_num_rows($query))\n\t\t\t\treturn getImageById(mysqli_result($query, 0));\n\t\t\telse\n\t\t\t\treturn \"null\";\n\t\t}\n\t}\n\t\n\t/*\n\t\n\tnot used yet\n\t\n\tfunction resizedImageExist($imageId)\n\t{\n\t\treturn file_exists(addslashes(\"./img/\").$imageId.'r');\n\t}\n\t\n\tfunction createResizeImage($imageId)\n\t{\n\t\t$path = addslashes(\"./img/\").$imageId;\n\t\tif (file_exists($path))\n\t\t{\n\t\t\t$imageInfo = getimagesize($path);\n\t\t\t$imageType = $imageInfo[2];\n\t\t\t$image = null;\n\t\t\tif ($imageType == IMAGETYPE_JPEG)\n\t\t\t\t$image = imagecreatefromjpeg($path);\n\t\t\telse if ($imageType == IMAGETYPE_PNG)\n\t\t\t\t$image = imagecreatefrompng($path);\n\t\t\t\t\n\t\t\t$newImage = imagecreatetruecolor(200, 200); // width, height\n\t\t\t\n\t\t\timagecopyresampled($newImage, $image, 0, 0, 0, 0, 200, 200, imagesx($image), imagesy($image));\n\t\t\t\n\t\t\tif ($imageType == IMAGETYPE_JPEG)\n\t\t\t\timagejpeg($newImage, $path.'r');\n\t\t\telse if($imageType == IMAGETYPE_PNG)\n\t\t\t\timagepng($newImage, $path.'r');\n\t\t}\n\t}\n\t*/\n\t\n\t// \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u0438 \u043e \u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u0438\n\tfunction getImageData($typeId, $gameId = -1)\n\t{\n\t\t$link = getDBConnection();\n\t\t$data = array();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$typeId = intval($typeId);\n\t\t\t$gameId = intval($gameId);\n\t\t\t$queryText = \"SELECT * FROM images WHERE type = $typeId\";\n\t\t\tif ($gameId != -1)\n\t\t\t\t$queryText .= \" AND game = $gameId\";\n\t\t\t\t\n\t\t\t$query = mysqli_query($link, $queryText);\n\t\t\t\n\t\t\twhile ($row = mysqli_fetch_assoc($query))\n\t\t\t\t$data[] = $row;\n\t\t\t\t\n\t\t\tmysqli_free_result($query);\n\t\t}\n\t\treturn $data;\n\t}\n\t\n\tfunction deleteImage($imageId)\n\t{\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$imageId = intval($imageId);\n\t\t\tmysqli_query($link, \"DELETE FROM images WHERE id = $imageId\");\n\t\t\tremoveDir(getImageById($imageId));\n\t\t}\n\t}\n\t\n\t// userProfile\n\t\n\tfunction changePassword($newPassword, $id=\"\")\n\t{\n\t\tif ($newPassword == \"\" || !isActiveUser()) return 4;\n\t\t\n\t\t$link = getDBConnection();\n\t\tif (mysqli_select_db($link, getDBName()))\n\t\t{\n\t\t\t$newPassword = md5(md5(trim(mysqli_real_escape_string($link, $newPassword))));\n\t\t\tif (isAdmin() && ($id != \"\"))\n        \t\t\t$currentId = intval($id);\n     \t\t\telse\n        \t\t\t$currentId = intval(getActiveUserID());\n\t\t\tif (mysqli_query($link, \"UPDATE users SET password = '$newPassword' WHERE id = $currentId\"))\n\t\t\t{\n\t\t\t\t//logOff();\n\t\t\t\tLogIn(md5(generateUniqueCode(10)), getActiveUserID());\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t\treturn 1;\n\t\t}\n\t\telse return 2;\n  }\n  function setUserGroup($newGroup, $id)\n  {\n        if (!isAdmin()) return 4;\n        if ($id == getActiveUserID()) return 4;\n        $link = getDBConnection();\n        if (($newGroup != \"user\") && ($newGroup != \"moder\") && ($newGroup != \"news\") && ($newGroup != \"admin\") && ($newGroup != \"banned\"))\n            return 4;\n        if (mysqli_select_db($link, getDBName()))\n        {\n            $currentId = intval($id);\n            if (mysqli_query($link, \"UPDATE `users` SET `group` = '$newGroup' WHERE id = $currentId\"))\n                return 0;\n            return 1;\n        };\n        return 2;\n    }\n  function setUserRealName($newName, $id=\"\")\n  {\n        if (!isActiveUser()) return 4;\n        $newName = htmlspecialchars($newName);\n        $link = getDBConnection();\n        if (mysqli_select_db($link, getDBName()))\n        {\n            $newName = mysqli_real_escape_string($link, $newName);\n            if (isAdmin() && ($id != \"\"))\n                $currentId = intval($id);\n            else\n                $currentId = intval(getActiveUserID());\n\n            if (mysqli_query($link, \"UPDATE users SET name = '$newName' WHERE id = $currentId\"))\n                return 0;\n            return 1;\n        };\n        return 2;\n    }\n\n    function setUserSurname($newName, $id=\"\")\n    {\n        if (!isActiveUser()) return 4;\n        $newName = htmlspecialchars($newName);\n        $link = getDBConnection();\n        if (mysqli_select_db($link, getDBName()))\n        {\n            $newName = mysqli_real_escape_string($link, $newName);\n            if (isAdmin() && ($id != \"\"))\n                $currentId = intval($id);\n            else\n                $currentId = intval(getActiveUserID());\n\n            if (mysqli_query($link, \"UPDATE users SET surname = '$newName' WHERE id = $currentId\"))\n                return 0;\n            return 1;\n        };\n        return 2;\n    }\n\n    function setUserPatronymic($newName, $id=\"\")\n    {\n        if (!isActiveUser()) return 4;\n        $newSurname = htmlspecialchars($newSurname);\n        $link = getDBConnection();\n        if (mysqli_select_db($link, getDBName()))\n        {\n            $newName = mysqli_real_escape_string($link, $newName);\n            if (isAdmin() && ($id != \"\"))\n                $currentId = intval($id);\n            else\n                $currentId = intval(getActiveUserID());\n\n            if (mysqli_query($link, \"UPDATE users SET patronymic = '$newName' WHERE id = $currentId\"))\n                return 0;\n            return 1;\n        };\n        return 2;\n    }\n\n    function getUserRealName($id = \"\")\n    {\n        if (!isActiveUser()) return \"Anonymous\";\n        $link = getDBConnection();\n        if (mysqli_select_db($link, getDBName()))\n        {\n            if (isAdmin() && ($id != \"\"))\n                $currentId = intval($id);\n            else\n                $currentId = intval(getActiveUserID());\n            $query = mysqli_query($link, \"SELECT name FROM users WHERE id = $currentId\");\n            $res = mysqli_fetch_assoc($query);\n            return $res['name'];\n        }\n    }\n    function getUserSurname($id = \"\")\n    {\n        if (!isActiveUser()) return \"Anonymous\";\n        $link = getDBConnection();\n        if (mysqli_select_db($link, getDBName()))\n        {\n            if (isAdmin() && ($id != \"\"))\n                $currentId = intval($id);\n            else\n                $currentId = intval(getActiveUserID());\n            $query = mysqli_query($link, \"SELECT surname FROM users WHERE id = $currentId\");\n            $res = mysqli_fetch_assoc($query);\n            return $res['surname'];\n        }\n    }\n    function getUserPatronymic($id = \"\")\n    {\n        if (!isActiveUser()) return \"Anonymous\";\n        $link = getDBConnection();\n        if (mysqli_select_db($link, getDBName()))\n        {\n            if (isAdmin() && ($id != \"\"))\n                $currentId = intval($id);\n            else\n                $currentId = intval(getActiveUserID());\n\n            $query = mysqli_query($link, \"SELECT patronymic FROM users WHERE id = $currentId\");\n            $res = mysqli_fetch_assoc($query);\n            return $res['patronymic'];\n        }\n    }\n\n    function getUsersList($ordered = false)\n    {\n        $link = getDBConnection();\n        mysqli_select_db($link, getDBName());\n        $q = \"SELECT * FROM `users` WHERE `group` != 'banned'\";\n        if ($ordered)\n            $q .= \" ORDER BY login\";\n        $data = array();\n        if ($query = mysqli_query($link, $q))\n        {\n            while ($row = mysqli_fetch_assoc($query))\n                $data[] = $row;\n            mysqli_free_result($query);\n        }\n        return $data;\n    }\n\n    function getFromDB($table, $where = \"1\", $limit = -1)\n    {\n        $link = getDBConnection();\n        mysqli_select_db($link, getDBName());\n        if ($limit = -1)\n            $limit = \"\";\n        else\n            $limit = \"LIMIT $limit\";\n        $q = \"SELECT * FROM `$table` WHERE ($where) $limit\";\n        $data = array();\n        if ($query = mysqli_query($link, $q))\n        {\n            while ($row = mysqli_fetch_assoc($query))\n                $data[] = $row;\n            mysqli_free_result($query);\n        }\n        mysqli_close($link);\n        return $data;\n    }\n\n    function createGameZip($gameId, $filename)\n    {\n        $gameId = intval($gameId);\n        $z = new ZipArchive();\n        $z->open($filename, ZIPARCHIVE::CREATE);\n        $checkers = getCheckerListByGameId($gameId);\n        $game = getFromDB(\"games\", \"id=$gameId\");\n        $meta = \"NAME=\" . getGameName($gameId) \n                        . \"\\nDESCRIPTION=\" \n                        . getGameDescription($gameId) \n                        . \"\\nTL=\" \n                        . $game[0][\"timeLimit\"] \n                        . \"\\nML=\" \n                        . $game[0][\"memoryLimit\"]\n        ;\n        $i = 0;\n        foreach ($checkers as $a)\n        {\n            $z->addFile(getcwd().\"./testers/\".$a[\"id\"], ++$i . \".checker\");\n            $z->addFromString($i . \".checkermeta\", \"LANG=cpp\\nname=\" . $a[\"name\"] . \"\\nSEED=\" . $a[\"hasSeed\"]);\n        };\n        $attachments = getAttachments($gameId);\n        $i = 0;\n        foreach ($attachments as $b)\n        {\n            $z->addFile(\"./attachments/\" . $b[\"id\"], ++$i . \".attachment\");\n            $z->addFromString($i . \".attachmentmeta\", \"NAME=\" . $b[\"originalName\"] . \"\\nDESCRIPTION=\".$b[\"description\"]);\n        };\n        $z->addFromString(\"META\", $meta);\n        $z->close();\n    }\n?>\n"], "filenames": ["site/procedures.php"], "buggy_code_start_loc": [1813], "buggy_code_end_loc": [1813], "fixing_code_start_loc": [1814], "fixing_code_end_loc": [1815], "type": "CWE-89", "message": "** UNSUPPPORTED WHEN ASSIGNED **** UNSUPPORTED WHEN ASSIGNED ** A vulnerability classified as critical has been found in Dovgalyuk AIBattle. Affected is the function sendComments of the file site/procedures.php. The manipulation of the argument text leads to sql injection. The name of the patch is e3aa4d0900167641d41cbccf53909229f00381c9. It is recommended to apply a patch to fix this issue. The identifier of this vulnerability is VDB-218304. NOTE: This vulnerability only affects products that are no longer supported by the maintainer.", "other": {"cve": {"id": "CVE-2015-10041", "sourceIdentifier": "cna@vuldb.com", "published": "2023-01-13T20:15:09.837", "lastModified": "2023-01-23T18:06:51.353", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "** UNSUPPPORTED WHEN ASSIGNED **** UNSUPPORTED WHEN ASSIGNED ** A vulnerability classified as critical has been found in Dovgalyuk AIBattle. Affected is the function sendComments of the file site/procedures.php. The manipulation of the argument text leads to sql injection. The name of the patch is e3aa4d0900167641d41cbccf53909229f00381c9. It is recommended to apply a patch to fix this issue. The identifier of this vulnerability is VDB-218304. NOTE: This vulnerability only affects products that are no longer supported by the maintainer."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 9.8, "baseSeverity": "CRITICAL"}, "exploitabilityScore": 3.9, "impactScore": 5.9}], "cvssMetricV30": [{"source": "cna@vuldb.com", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:A/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L", "attackVector": "ADJACENT_NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "LOW", "baseScore": 5.5, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.1, "impactScore": 3.4}], "cvssMetricV2": [{"source": "cna@vuldb.com", "type": "Secondary", "cvssData": {"version": "2.0", "vectorString": "AV:A/AC:L/Au:S/C:P/I:P/A:P", "accessVector": "ADJACENT_NETWORK", "accessComplexity": "LOW", "authentication": "SINGLE", "confidentialityImpact": "PARTIAL", "integrityImpact": "PARTIAL", "availabilityImpact": "PARTIAL", "baseScore": 5.2}, "baseSeverity": "MEDIUM", "exploitabilityScore": 5.1, "impactScore": 6.4, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "cna@vuldb.com", "type": "Primary", "description": [{"lang": "en", "value": "CWE-89"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:aibattle_project:aibattle:*:*:*:*:*:*:*:*", "versionEndExcluding": "2015-08-11", "matchCriteriaId": "447C300D-8EB9-446F-98BD-BF635E103AF4"}]}]}], "references": [{"url": "https://github.com/Dovgalyuk/AIBattle-disabled-/commit/e3aa4d0900167641d41cbccf53909229f00381c9", "source": "cna@vuldb.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://vuldb.com/?ctiid.218304", "source": "cna@vuldb.com", "tags": ["Third Party Advisory"]}, {"url": "https://vuldb.com/?id.218304", "source": "cna@vuldb.com", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/Dovgalyuk/AIBattle-disabled-/commit/e3aa4d0900167641d41cbccf53909229f00381c9"}}