{"buggy_code": ["<?php\n/**\n * Overview of actions in the admin section.\n *\n * PHP Version 5.5\n *\n *  http://www.mozilla.org/MPL/\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @category  phpMyFAQ\n *\n * @author    Thorsten Rinne <thorsten@phpmyfaq.de>\n * @copyright 2003-2017 phpMyFAQ Team\n * @license   http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n *\n * @link      http://www.phpmyfaq.de\n * @since     2003-02-23\n */\nif (!defined('IS_VALID_PHPMYFAQ')) {\n    $protocol = 'http';\n    if (isset($_SERVER['HTTPS']) && strtoupper($_SERVER['HTTPS']) === 'ON') {\n        $protocol = 'https';\n    }\n    header('Location: '.$protocol.'://'.$_SERVER['HTTP_HOST'].dirname($_SERVER['SCRIPT_NAME']));\n    exit();\n}\n\n$logging = new PMF_Logging($faqConfig);\n\nif ($user->perm->checkRight($user->getUserId(), 'adminlog') && 'adminlog' == $action) {\n    $date = new PMF_Date($faqConfig);\n    $perpage = 15;\n    $pages = PMF_Filter::filterInput(INPUT_GET, 'pages', FILTER_VALIDATE_INT);\n    $page = PMF_Filter::filterInput(INPUT_GET, 'page', FILTER_VALIDATE_INT, 1);\n\n    if (is_null($pages)) {\n        $pages = round(($logging->getNumberOfEntries() + ($perpage / 3)) / $perpage, 0);\n    }\n\n    $start = ($page - 1) * $perpage;\n    $ende = $start + $perpage;\n\n    $baseUrl = sprintf(\n        '%s?action=adminlog&amp;page=%d',\n        PMF_Link::getSystemRelativeUri(),\n        $page\n    );\n\n    // Pagination options\n    $options = array(\n        'baseUrl' => $baseUrl,\n        'total' => $logging->getNumberOfEntries(),\n        'perPage' => $perpage,\n        'pageParamName' => 'page',\n    );\n    $pagination = new PMF_Pagination($faqConfig, $options);\n\n    $loggingData = $logging->getAll();\n    ?>\n    <header class=\"row\">\n        <div class=\"col-lg-12\">\n            <h2 class=\"page-header\">\n                <i aria-hidden=\"true\" class=\"fa fa-tasks\"></i> <?php echo $PMF_LANG['ad_menu_adminlog'];\n    ?>\n                <div class=\"pull-right\">\n                    <a class=\"btn btn-danger\" href=\"?action=deleteadminlog\">\n                        <i aria-hidden=\"true\" class=\"fa fa-trash\"></i> <?php echo $PMF_LANG['ad_adminlog_del_older_30d'] ?>\n                    </a>\n                </div>\n            </h2>\n        </div>\n    </header>\n\n    <table class=\"table table-striped\">\n    <thead>\n        <tr>\n            <th><?php echo $PMF_LANG['ad_categ_id'];\n    ?></th>\n            <th><?php echo $PMF_LANG['ad_adminlog_date'];\n    ?></th>\n            <th><?php echo $PMF_LANG['ad_adminlog_user'];\n    ?></th>\n            <th colspan=\"2\"><?php echo $PMF_LANG['ad_adminlog_ip'];\n    ?></th>\n        </tr>\n    </thead>\n    <tfoot>\n        <tr>\n            <td colspan=\"5\"><?php echo $pagination->render();\n    ?></td>\n        </tr>\n    </tfoot>\n    <tbody>\n<?php\n    $counter = $displayedCounter = 0;\n\n    foreach ($loggingData as $logging_id => $logging_value) {\n        if ($displayedCounter >= $perpage) {\n            ++$displayedCounter;\n            continue;\n        }\n\n        ++$counter;\n        if ($counter <= $start) {\n            continue;\n        }\n        ++$displayedCounter;\n\n        $user->getUserById($logging_value['usr'], true);\n        ?>\n        <tr>\n            <td><?php echo $logging_id;\n        ?></td>\n            <td><?php echo $date->format(date('Y-m-d H:i', $logging_value['time']));\n        ?></td>\n            <td><?php echo $user->getLogin();\n        ?></td>\n            <td><?php echo $logging_value['ip'];\n        ?></td>\n            <td><small><?php\n            $text = $logging_value['text'];\n        $text = str_replace('Loginerror', $PMF_LANG['ad_log_lger'], $text);\n        $text = str_replace('Session expired', $PMF_LANG['ad_log_sess'], $text);\n        $text = str_replace('Useredit, ', $PMF_LANG['ad_log_edit'], $text);\n        $text = str_replace('Beitragcreatesave', $PMF_LANG['ad_log_crsa'], $text);\n        $text = str_replace('Beitragcreate', $PMF_LANG['ad_log_crea'], $text);\n        $text = str_replace('Usersave, ', $PMF_LANG['ad_log_ussa'], $text);\n        $text = str_replace('Userdel, ', $PMF_LANG['ad_log_usde'], $text);\n        $text = str_replace('Beitragedit, ', $PMF_LANG['ad_log_beed'], $text);\n        $text = str_replace('Beitragdel, ', $PMF_LANG['ad_log_bede'], $text);\n        echo $text;\n        ?></small>\n            </td>\n        </tr>\n<?php\n\n    }\n    ?>\n    </tbody>\n    </table>\n\n<?php\n\n} elseif ($user->perm->checkRight($user->getUserId(), 'adminlog') && 'deleteadminlog' == $action) {\n    if ($logging->delete()) {\n        printf('<p class=\"alert alert-success\">%s</p>', $PMF_LANG['ad_adminlog_delete_success']);\n    } else {\n        printf('<p class=\"alert alert-danger\">%s</p>', $PMF_LANG['ad_adminlog_delete_failure']);\n    }\n} else {\n    echo $PMF_LANG['err_NotAuth'];\n}\n"], "fixing_code": ["<?php\n/**\n * Overview of actions in the admin section.\n *\n * PHP Version 5.5\n *\n *  http://www.mozilla.org/MPL/\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @category  phpMyFAQ\n *\n * @author    Thorsten Rinne <thorsten@phpmyfaq.de>\n * @copyright 2003-2017 phpMyFAQ Team\n * @license   http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n *\n * @link      http://www.phpmyfaq.de\n * @since     2003-02-23\n */\nif (!defined('IS_VALID_PHPMYFAQ')) {\n    $protocol = 'http';\n    if (isset($_SERVER['HTTPS']) && strtoupper($_SERVER['HTTPS']) === 'ON') {\n        $protocol = 'https';\n    }\n    header('Location: '.$protocol.'://'.$_SERVER['HTTP_HOST'].dirname($_SERVER['SCRIPT_NAME']));\n    exit();\n}\n\n$logging = new PMF_Logging($faqConfig);\n\nif ($user->perm->checkRight($user->getUserId(), 'adminlog') && 'adminlog' == $action) {\n    $date = new PMF_Date($faqConfig);\n    $perpage = 15;\n    $pages = PMF_Filter::filterInput(INPUT_GET, 'pages', FILTER_VALIDATE_INT);\n    $page = PMF_Filter::filterInput(INPUT_GET, 'page', FILTER_VALIDATE_INT, 1);\n    $csrfToken = PMF_Filter::filterInput(INPUT_GET, 'csrf', FILTER_SANITIZE_STRING);\n\n    if (is_null($pages)) {\n        $pages = round(($logging->getNumberOfEntries() + ($perpage / 3)) / $perpage, 0);\n    }\n\n    if (!isset($_SESSION['phpmyfaq_csrf_token']) || $_SESSION['phpmyfaq_csrf_token'] !== $csrfToken) {\n        $deleteLog = false;\n    } else {\n        $deleteLog = true;\n    }\n\n    $start = ($page - 1) * $perpage;\n    $ende = $start + $perpage;\n\n    $baseUrl = sprintf(\n        '%s?action=adminlog&amp;page=%d',\n        PMF_Link::getSystemRelativeUri(),\n        $page\n    );\n\n    // Pagination options\n    $options = array(\n        'baseUrl' => $baseUrl,\n        'total' => $logging->getNumberOfEntries(),\n        'perPage' => $perpage,\n        'pageParamName' => 'page',\n    );\n    $pagination = new PMF_Pagination($faqConfig, $options);\n\n    $loggingData = $logging->getAll();\n    ?>\n    <header class=\"row\">\n        <div class=\"col-lg-12\">\n            <h2 class=\"page-header\">\n                <i aria-hidden=\"true\" class=\"fa fa-tasks\"></i> <?php echo $PMF_LANG['ad_menu_adminlog'];\n    ?>\n                <div class=\"pull-right\">\n                    <a class=\"btn btn-danger\"\n                       href=\"?action=deleteadminlog&csrf=<?php echo $user->getCsrfTokenFromSession() ?>\">\n                        <i aria-hidden=\"true\" class=\"fa fa-trash\"></i> <?php echo $PMF_LANG['ad_adminlog_del_older_30d'] ?>\n                    </a>\n                </div>\n            </h2>\n        </div>\n    </header>\n\n    <table class=\"table table-striped\">\n    <thead>\n        <tr>\n            <th><?php echo $PMF_LANG['ad_categ_id'];\n    ?></th>\n            <th><?php echo $PMF_LANG['ad_adminlog_date'];\n    ?></th>\n            <th><?php echo $PMF_LANG['ad_adminlog_user'];\n    ?></th>\n            <th colspan=\"2\"><?php echo $PMF_LANG['ad_adminlog_ip'];\n    ?></th>\n        </tr>\n    </thead>\n    <tfoot>\n        <tr>\n            <td colspan=\"5\"><?php echo $pagination->render();\n    ?></td>\n        </tr>\n    </tfoot>\n    <tbody>\n<?php\n    $counter = $displayedCounter = 0;\n\n    foreach ($loggingData as $logging_id => $logging_value) {\n        if ($displayedCounter >= $perpage) {\n            ++$displayedCounter;\n            continue;\n        }\n\n        ++$counter;\n        if ($counter <= $start) {\n            continue;\n        }\n        ++$displayedCounter;\n\n        $user->getUserById($logging_value['usr'], true);\n        ?>\n        <tr>\n            <td><?php echo $logging_id;\n        ?></td>\n            <td><?php echo $date->format(date('Y-m-d H:i', $logging_value['time']));\n        ?></td>\n            <td><?php echo $user->getLogin();\n        ?></td>\n            <td><?php echo $logging_value['ip'];\n        ?></td>\n            <td><small><?php\n            $text = $logging_value['text'];\n            $text = str_replace('Loginerror', $PMF_LANG['ad_log_lger'], $text);\n            $text = str_replace('Session expired', $PMF_LANG['ad_log_sess'], $text);\n            $text = str_replace('Useredit, ', $PMF_LANG['ad_log_edit'], $text);\n            $text = str_replace('Beitragcreatesave', $PMF_LANG['ad_log_crsa'], $text);\n            $text = str_replace('Beitragcreate', $PMF_LANG['ad_log_crea'], $text);\n            $text = str_replace('Usersave, ', $PMF_LANG['ad_log_ussa'], $text);\n            $text = str_replace('Userdel, ', $PMF_LANG['ad_log_usde'], $text);\n            $text = str_replace('Beitragedit, ', $PMF_LANG['ad_log_beed'], $text);\n            $text = str_replace('Beitragdel, ', $PMF_LANG['ad_log_bede'], $text);\n            echo $text;\n            ?></small>\n            </td>\n        </tr>\n<?php\n\n    }\n    ?>\n    </tbody>\n    </table>\n\n<?php\n\n} elseif ($user->perm->checkRight($user->getUserId(), 'adminlog') && 'deleteadminlog' == $action && $deleteLog) {\n    if ($logging->delete()) {\n        printf('<p class=\"alert alert-success\">%s</p>', $PMF_LANG['ad_adminlog_delete_success']);\n    } else {\n        printf('<p class=\"alert alert-danger\">%s</p>', $PMF_LANG['ad_adminlog_delete_failure']);\n    }\n} else {\n    echo $PMF_LANG['err_NotAuth'];\n}\n"], "filenames": ["phpmyfaq/admin/stat.adminlog.php"], "buggy_code_start_loc": [37], "buggy_code_end_loc": [148], "fixing_code_start_loc": [38], "fixing_code_end_loc": [156], "type": "CWE-352", "message": "In phpMyFAQ before 2.9.9, there is Cross-Site Request Forgery (CSRF) in admin/stat.adminlog.php.", "other": {"cve": {"id": "CVE-2017-15731", "sourceIdentifier": "cve@mitre.org", "published": "2017-10-22T18:29:00.467", "lastModified": "2017-10-24T15:09:14.737", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "In phpMyFAQ before 2.9.9, there is Cross-Site Request Forgery (CSRF) in admin/stat.adminlog.php."}, {"lang": "es", "value": "En phpMyFAQ en versiones anteriores a la 2.9.9 hay Cross-Site Request Forgery (CSRF) en admin/stat.adminlog.php."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 8.8, "baseSeverity": "HIGH"}, "exploitabilityScore": 2.8, "impactScore": 5.9}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:P/I:P/A:P", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "PARTIAL", "integrityImpact": "PARTIAL", "availabilityImpact": "PARTIAL", "baseScore": 6.8}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 6.4, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-352"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:phpmyfaq:phpmyfaq:*:*:*:*:*:*:*:*", "versionEndIncluding": "2.9.8", "matchCriteriaId": "1D0B1C07-83F7-4DB0-976C-51483D7DF516"}]}]}], "references": [{"url": "https://github.com/thorsten/phpMyFAQ/commit/fadb9a70b5f7624a6926b8834d5c6001c210f09c", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/thorsten/phpMyFAQ/commit/fadb9a70b5f7624a6926b8834d5c6001c210f09c"}}