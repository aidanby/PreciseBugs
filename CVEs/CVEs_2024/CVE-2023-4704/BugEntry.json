{"buggy_code": ["<?php\n\nclass actionMessagesWrite extends cmsAction {\n\n    public function run($contact_id) {\n\n        if (!is_numeric($contact_id)) {\n            return cmsCore::error404();\n        }\n\n        if (empty($this->options['is_enable_pm'])) {\n            return cmsCore::error404();\n        }\n\n        $contact_exists_id = $this->model->isContactExists($this->cms_user->id, $contact_id);\n\n        if (!$contact_exists_id) {\n            $contact_exists_id = $contact_id;\n            $this->model->addContact($this->cms_user->id, $contact_id);\n        }\n\n        // \u041a\u0430\u043a\u043e\u0439 \u043a\u043e\u043d\u0442\u0430\u043a\u0442 \u0432\u044b\u0431\u0438\u0440\u0430\u0435\u043c\n        $this->request->set('select_contact_id', $contact_exists_id);\n\n        $this->executeAction('index');\n    }\n\n}\n", "<?php\n/**\n * @property \\modelMessages $model\n * @property \\modelUsers $model_users\n */\nclass messages extends cmsFrontend {\n\n    protected $useOptions = true;\n\n    private $sender_id;\n    private $recipients = [];\n    private $is_ignore_options = false;\n\n    /**\n     * \u0412\u0441\u0435 \u0437\u0430\u043f\u0440\u043e\u0441\u044b \u043c\u043e\u0433\u0443\u0442 \u0431\u044b\u0442\u044c \u0432\u044b\u043f\u043e\u043b\u043d\u0435\u043d\u044b \u0442\u043e\u043b\u044c\u043a\u043e \u0430\u0432\u0442\u043e\u0440\u0438\u0437\u043e\u0432\u0430\u043d\u043d\u044b\u043c\u0438 \u0438 \u0442\u043e\u043b\u044c\u043a\u043e \u043f\u043e \u0430\u044f\u043a\u0441\n     *\n     * @param string $action_name\n     */\n    public function before($action_name) {\n\n        parent::before($action_name);\n\n        if (!$this->request->isInternal()) {\n\n            if (!$this->request->isAjax() && $action_name !== 'index') {\n                return cmsCore::error404();\n            }\n\n            if (!cmsUser::isLogged()) {\n                return cmsCore::error404();\n            }\n\n            // \u0417\u0434\u0435\u0441\u044c \u0432\u0438\u0434\u0436\u0435\u0442\u044b \u043d\u0435 \u043d\u0443\u0436\u043d\u044b\n            if ($action_name !== 'index') {\n                $this->cms_template->widgets_rendered = true;\n            }\n        }\n\n        return true;\n    }\n\n    /**\n     * \u0423\u0441\u0442\u0430\u043d\u0430\u0432\u043b\u0438\u0432\u0430\u0435\u0442 \u043e\u0442\u043f\u0440\u0430\u0432\u0438\u0442\u0435\u043b\u044f \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f\n     *\n     * @param integer $user_id\n     * @return \\messages\n     */\n    public function setSender($user_id) {\n\n        $this->sender_id = $user_id;\n\n        return $this;\n    }\n\n    /**\n     * \u0414\u043e\u0431\u0430\u0432\u043b\u044f\u0435\u0442 \u043f\u043e\u043b\u0443\u0447\u0430\u0442\u0435\u043b\u044f \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f\n     *\n     * @param integer $user_id\n     * @return \\messages\n     */\n    public function addRecipient($user_id) {\n\n        $this->recipients[] = $user_id;\n\n        return $this;\n    }\n\n    /**\n     * \u0414\u043e\u0431\u0430\u0432\u043b\u044f\u0435\u0442 \u0441\u043f\u0438\u0441\u043e\u043a \u043f\u043e\u043b\u0443\u0447\u0430\u0442\u0435\u043b\u0435\u0439 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f\n     *\n     * @param array $list\n     * @return \\messages\n     */\n    public function addRecipients($list) {\n\n        $this->recipients = array_merge($this->recipients, $list);\n\n        return $this;\n    }\n\n    /**\n     * \u041e\u0447\u0438\u0449\u0430\u0435\u0442 \u0441\u043f\u0438\u0441\u043e\u043a \u043f\u043e\u043b\u0443\u0447\u0430\u0442\u0435\u043b\u0435\u0439 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f\n     *\n     * @return \\messages\n     */\n    public function clearRecipients() {\n\n        $this->recipients = [];\n\n        return $this;\n    }\n\n    /**\n     * \u041e\u0442\u043f\u0440\u0430\u0432\u043b\u044f\u0435\u0442 \u043b\u0438\u0447\u043d\u043e\u0435 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435\n     *\n     * @param string $content\n     * @return integer | false\n     */\n    public function sendMessage($content) {\n\n        // \u0421\u043e\u0437\u0434\u0430\u0435\u043c \u043a\u043e\u043d\u0442\u0430\u043a\u0442\u044b \u043f\u043e\u043b\u0443\u0447\u0430\u0442\u0435\u043b\u044f\u043c\n        foreach ($this->recipients as $contact_id) {\n            if (!$this->model->isContactExists($contact_id, $this->sender_id)) {\n                $this->model->addContact($contact_id, $this->sender_id);\n            }\n        }\n\n        // \u0421\u043e\u0445\u0440\u0430\u043d\u044f\u0435\u043c \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435\n        $message_id = $this->model->addMessage($this->sender_id, $this->recipients, $content);\n\n        if ($message_id) {\n\n            $message_id = cmsEventsManager::hook('messages_after_send', $message_id);\n\n            // \u041e\u0431\u043d\u043e\u0432\u043b\u044f\u0435\u043c \u0434\u0430\u0442\u044b \u043f\u043e\u0441\u043b\u0435\u0434\u043d\u0438\u0445 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0439 \u0432 \u043a\u043e\u043d\u0442\u0430\u043a\u0442\u0430\u0445\n            foreach ($this->recipients as $contact_id) {\n                $this->model->updateContactsDateLastMsg($this->sender_id, $contact_id);\n            }\n\n            cmsEventsManager::hook('send_user_message', [$this->sender_id, $this->recipients, $content]);\n        }\n\n        return $message_id ? $message_id : false;\n    }\n\n    /**\n     * \u0423\u0441\u0442\u0430\u043d\u0430\u0432\u043b\u0438\u0432\u0430\u0435\u0442 \u0444\u043b\u0430\u0433 \u0438\u0433\u043d\u043e\u0440\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f \u043e\u043f\u0446\u0438\u0439 \u0443\u0432\u0435\u0434\u043e\u043c\u043b\u0435\u043d\u0438\u0439 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f\n     *\n     * @return \\messages\n     */\n    public function ignoreNotifyOptions() {\n\n        $this->is_ignore_options = true;\n\n        return $this;\n    }\n\n    /**\n     * \u041e\u0442\u043f\u0440\u0430\u0432\u043b\u044f\u0435\u0442 \u0443\u0432\u0435\u0434\u043e\u043c\u043b\u0435\u043d\u0438\u0435 \u0447\u0435\u0440\u0435\u0437 \u043b\u0438\u0447\u043d\u044b\u0435 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f\n     *\n     * @param array $notice\n     * @param string $notice_type\n     * @return int | false\n     */\n    public function sendNoticePM($notice, $notice_type = false) {\n\n        if (!$notice_type) {\n\n            $recipients = $this->recipients;\n\n        } else {\n\n            $options_only = $this->is_ignore_options ? false : ['pm', 'both'];\n\n            $recipients = $this->model_users->getNotifiedUsers($notice_type, $this->recipients, $options_only);\n\n            $this->is_ignore_options = false;\n        }\n\n        if (!$recipients) {\n            return false;\n        }\n\n        list($recipients, $notice, $notice_type) = cmsEventsManager::hook('send_user_notice_before', [$recipients, $notice, $notice_type]);\n\n        $notice_id = $this->model->addNotice($recipients, $notice);\n\n        cmsEventsManager::hook('send_user_notice', [$recipients, $notice]);\n\n        return $notice_id;\n    }\n\n    /**\n     * \u041e\u0442\u043f\u0440\u0430\u0432\u043b\u044f\u0435\u0442 email-\u0443\u0432\u0435\u0434\u043e\u043c\u043b\u0435\u043d\u0438\u044f \u0443\u043a\u0430\u0437\u0430\u043d\u043d\u043e\u0433\u043e \u0442\u0438\u043f\u0430 \u0432\u0441\u0435\u043c\n     * \u043f\u043e\u0434\u043f\u0438\u0441\u0430\u043d\u043d\u044b\u043c \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f\u043c\n     *\n     * @param string $letter_name\n     * @param string $notice \u041c\u0430\u0441\u0441\u0438\u0432 \u043a\u043b\u044e\u0447\u0435\u0439 \u0438 \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u0439 \u0434\u043b\u044f \u0437\u0430\u043c\u0435\u043d\u044b \u0432 \u0442\u0435\u043a\u0441\u0442\u0435 \u043f\u0438\u0441\u044c\u043c\u0430\n     * @param string $notice_type\n     * @return boolean\n     */\n    public function sendNoticeEmail($letter_name, $notice = [], $notice_type = false) {\n\n        if (!$this->recipients) {\n            return;\n        }\n\n        $letter_text = cmsCore::getLanguageTextFile(\"letters/{$letter_name}\");\n        if (!$letter_text) {\n            return false;\n        }\n\n        if (!$notice_type) {\n            $notice_type = $letter_name;\n        }\n\n        $options_only = $this->is_ignore_options ? false : ['email', 'both'];\n\n        $recipients = $this->model_users->getNotifiedUsers($notice_type, $this->recipients, $options_only);\n        if (!$recipients) {\n            return false;\n        }\n\n        $this->is_ignore_options = false;\n\n        $letter_text = string_replace_keys_values($letter_text, $notice);\n\n        list(\n            $recipients,\n            $letter_name,\n            $notice,\n            $notice_type,\n            $letter_text\n        ) = cmsEventsManager::hook('messages_send_notice_email', [\n            $recipients,\n            $letter_name,\n            $notice,\n            $notice_type,\n            $letter_text\n        ]);\n\n        foreach ($recipients as $recipient) {\n\n            $to = [\n                'name'  => $recipient['nickname'],\n                'email' => $recipient['email']\n            ];\n\n            $letter = [\n                'text' => string_replace_keys_values($letter_text, $recipient)\n            ];\n\n            $this->sendEmail($to, $letter);\n        }\n\n        return true;\n    }\n\n    /**\n     * \u041f\u043e\u0434\u0433\u043e\u0442\u043e\u0432\u0430\u043b\u0438\u0432\u0430\u0435\u0442 Email \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435\n     * \u0421\u0442\u0430\u0432\u0438\u0442 \u0432 \u043e\u0447\u0435\u0440\u0435\u0434\u044c \u0438\u043b\u0438 \u0441\u0440\u0430\u0437\u0443 \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u044f\u0435\u0442\n     *\n     * @param array|string $to       \u041a\u043e\u043c\u0443 \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u044f\u0442\u044c \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435\n     * @param array|string $letter   \u0422\u0435\u043a\u0441\u0442 \u043f\u0438\u0441\u044c\u043c\u0430\n     * @param array $data            \u041c\u0430\u0441\u0441\u0438\u0432 \u0434\u0430\u043d\u043d\u044b\u0445, \u043a\u043e\u0442\u043e\u0440\u044b\u043c\u0438 \u043d\u0443\u0436\u043d\u043e \u0437\u0430\u043c\u0435\u043d\u0438\u0442\u044c \u0432\u044b\u0440\u0430\u0436\u0435\u043d\u0438\u044f \u0432 \u043f\u0438\u0441\u044c\u043c\u0435\n     * @param boolean $is_nl2br_text \u0420\u0430\u0441\u0441\u0442\u0430\u0432\u043b\u044f\u0442\u044c \u043f\u0435\u0440\u0435\u043d\u043e\u0441\u044b \u0442\u0435\u0433\u0430\u043c\u0438 <br>\n     *\n     * @return boolean\n     */\n    public function sendEmail($to, $letter, $data = [], $is_nl2br_text = true) {\n\n        if (!is_array($to)) {\n            $to = ['email' => $to];\n        }\n\n        $to = array_merge([\n            'email'          => false,\n            'name'           => false,\n            'email_reply_to' => false,\n            'name_reply_to'  => false,\n            'custom_headers' => []\n        ], $to);\n\n        if (empty($to['email'])) {\n            return false;\n        }\n\n        if (is_array($letter)) {\n            if (empty($letter['text'])) {\n                $letter['text'] = cmsCore::getLanguageTextFile(\"letters/{$letter['name']}\");\n            }\n        } else {\n            $letter = ['text' => cmsCore::getLanguageTextFile(\"letters/{$letter}\")];\n        }\n\n        if (!$letter['text']) {\n            return false;\n        }\n\n        $data = array_merge([\n            'site' => $this->cms_config->sitename,\n            'ip'   => cmsUser::getIp(),\n            'date' => html_date(),\n            'time' => html_time()\n        ], $data);\n\n        list(\n            $to,\n            $letter,\n            $data,\n            $is_nl2br_text\n        ) = cmsEventsManager::hook('before_send_email_prepare', [\n            $to,\n            $letter,\n            $data,\n            $is_nl2br_text\n        ]);\n\n        $letter['text'] = string_replace_keys_values_extended($letter['text'], $data);\n\n        $before_send = cmsEventsManager::hook('before_send_email', [\n            'send_email' => true,\n            'success'    => false,\n            'to'         => $to,\n            'letter'     => $letter\n        ]);\n\n        if (!$before_send['send_email']) {\n            return $before_send['success'];\n        }\n\n        // \u0435\u0441\u043b\u0438 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0435\u043c \u043e\u0447\u0435\u0440\u0435\u0434\u044c\n        if (!empty($this->options['use_queue'])) {\n\n            cmsQueue::pushOn('email', [\n                'controller' => $this->name,\n                'hook'       => 'queue_send_email',\n                'params'     => [\n                    $to, $letter, $is_nl2br_text\n                ]\n            ]);\n\n            return true;\n        }\n\n        return $this->sendEmailRaw($to, $letter, $is_nl2br_text) === true ? true : false;\n    }\n\n    /**\n     * \u0412\u044b\u043f\u043e\u043b\u043d\u044f\u0435\u0442 \u043e\u0442\u043f\u0440\u0430\u0432\u043a\u0443 email \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f\n     *\n     * @param array|string $to       \u041a\u043e\u043c\u0443 \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u044f\u0442\u044c \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435\n     * @param array|string $letter   \u0422\u0435\u043a\u0441\u0442 \u043f\u0438\u0441\u044c\u043c\u0430\n     * @param boolean $is_nl2br_text \u0420\u0430\u0441\u0441\u0442\u0430\u0432\u043b\u044f\u0442\u044c \u043f\u0435\u0440\u0435\u043d\u043e\u0441\u044b \u0442\u0435\u0433\u0430\u043c\u0438 <br>\n     *\n     * @return boolean|string true \u0438\u043b\u0438 \u0442\u0435\u043a\u0441\u0442 \u043e\u0448\u0438\u0431\u043a\u0438\n     */\n    public function sendEmailRaw($to, $letter, $is_nl2br_text = null) {\n\n        // URL \u0434\u043b\u044f \u043e\u0442\u043f\u0438\u0441\u043a\u0438 \u043e\u0442 \u0440\u0430\u0441\u0441\u044b\u043b\u043a\u0438\n        $unsubscribe_url = $to['custom_headers']['List-Unsubscribe'] ?? $this->cms_config->host;\n\n        if(empty($to['custom_headers']['List-Unsubscribe'])){\n            $to['custom_headers']['List-Unsubscribe'] = $unsubscribe_url;\n        }\n\n        $mailer = new cmsMailer();\n\n        list($letter, $is_nl2br_text, $to) = cmsEventsManager::hook('process_email_letter', [$letter, $is_nl2br_text, $to]);\n\n        $mailer->addTo($to['email'], $to['name']);\n\n        if (!empty($to['email_reply_to'])) {\n            $mailer->setReplyTo($to['email_reply_to'], $to['name_reply_to']);\n        }\n\n        if (!empty($to['custom_headers'])) {\n            foreach ($to['custom_headers'] as $name => $value) {\n                $mailer->addCustomHeader($name, $value);\n            }\n        }\n\n        if (!empty($to['attachments'])) {\n            foreach ($to['attachments'] as $attach_name => $attach) {\n                $mailer->addAttachment($attach, (is_numeric($attach_name) ? '' : $attach_name));\n            }\n        }\n\n        $letter['text'] = $mailer->parseSubject($letter['text']);\n        $letter['text'] = $mailer->parseAttachments($letter['text']);\n\n        // \u0415\u0441\u043b\u0438 \u0435\u0441\u0442\u044c \u043e\u0431\u0449\u0438\u0439 \u0448\u0430\u0431\u043b\u043e\u043d \u043f\u0438\u0441\u0435\u043c\n        if (!empty($this->options['email_template'])) {\n\n            if($is_nl2br_text){\n\n                $letter['text'] = nl2br($letter['text']);\n\n                $is_nl2br_text = false;\n            }\n\n            $data_template = [\n                'body'            => $letter['text'],\n                'year'            => date('Y'),\n                'site'            => $this->cms_config->sitename,\n                'unsubscribe_url' => $unsubscribe_url\n            ];\n\n            $letter['text'] = string_replace_keys_values($this->options['email_template'], $data_template);\n        }\n\n        $mailer->setBodyHTML(($is_nl2br_text ? nl2br($letter['text']) : $letter['text']));\n\n        $result = $mailer->send();\n\n        $mailer->clearTo()->clearAttachments();\n\n        return $result ? true : $mailer->getErrorInfo();\n    }\n\n}\n", "/*\n\tRedactor v9.2.6\n\tUpdated: Jul 19, 2014\n\thttp://imperavi.com/redactor/\n\tCopyright (c) 2009-2014, Imperavi LLC.\n\tLicense: http://imperavi.com/redactor/license/\n\tUsage: $('#content').redactor();\n*/\n(function($)\n{\n\tvar uuid = 0;\n\n\t\"use strict\";\n\n\tvar Range = function(range)\n\t{\n\t\tthis[0] = range.startOffset;\n\t\tthis[1] = range.endOffset;\n\n\t\tthis.range = range;\n\n\t\treturn this;\n\t};\n\n\tRange.prototype.equals = function()\n\t{\n\t\treturn this[0] === this[1];\n\t};\n\n\tvar reUrlYoutube = /https?:\\/\\/(?:[0-9A-Z-]+\\.)?(?:youtu\\.be\\/|youtube\\.com\\S*[^\\w\\-\\s])([\\w\\-]{11})(?=[^\\w\\-]|$)(?![?=&+%\\w.-]*(?:['\"][^<>]*>|<\\/a>))[?=&+%\\w.-]*/ig;\n\tvar reUrlVimeo = /https?:\\/\\/(www\\.)?vimeo.com\\/(\\d+)($|\\/)/;\n    var reUrlFacebook = /^(?:(?:https|http)?:\\/\\/)?(?:www\\.)?(?:facebook\\.com(?:\\/[^\\/]+\\/videos\\/|\\/video\\.php\\?v=))([0-9]+)(?:.+)?$/;\n\tvar reUrlRutube = /^(?:(?:https|http)?:\\/\\/)?(?:www\\.)?(?:rutube\\.ru\\/video\\/)([a-z0-9]+)(?:.+)?$/;\n\n\t$.fn.redactor = function(options)\n\t{\n\t\tvar val = [];\n\t\tvar args = Array.prototype.slice.call(arguments, 1);\n\n\t\tif (typeof options === 'string')\n\t\t{\n\t\t\tthis.each(function()\n\t\t\t{\n\t\t\t\tvar instance = $.data(this, 'redactor');\n\t\t\t\tif (typeof instance !== 'undefined' && $.isFunction(instance[options]))\n\t\t\t\t{\n\t\t\t\t\tvar methodVal = instance[options].apply(instance, args);\n\t\t\t\t\tif (methodVal !== undefined && methodVal !== instance) val.push(methodVal);\n\t\t\t\t}\n\t\t\t\telse return $.error('No such method \"' + options + '\" for Redactor');\n\t\t\t});\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.each(function()\n\t\t\t{\n\t\t\t\tif (!$.data(this, 'redactor')) $.data(this, 'redactor', Redactor(this, options));\n\t\t\t});\n\t\t}\n\n\t\tif (val.length === 0) return this;\n\t\telse if (val.length === 1) return val[0];\n\t\telse return val;\n\n\t};\n\n\tfunction Redactor(el, options)\n\t{\n\t\treturn new Redactor.prototype.init(el, options);\n\t}\n\n\t$.Redactor = Redactor;\n\t$.Redactor.VERSION = '9.2.6';\n\t$.Redactor.opts = {\n\n\t\t\trangy: false,\n\n\t\t\tiframe: false,\n\t\t\tfullpage: false,\n\t\t\tcss: false,\n\n\t\t\tlang: 'en',\n\t\t\tdirection: 'ltr',\n\n\t\t\tplaceholder: false,\n\n\t\t\ttypewriter: false,\n\t\t\twym: false,\n\t\t\tmobile: true,\n\t\t\tcleanup: true,\n\t\t\ttidyHtml: true,\n\t\t\tpastePlainText: false,\n\t\t\tremoveEmptyTags: true,\n\t\t\tcleanSpaces: true,\n\t\t\tcleanFontTag: true,\n\t\t\ttemplateVars: false,\n\t\t\txhtml: false,\n\n\t\t\tvisual: true,\n\t\t\tfocus: false,\n\t\t\ttabindex: false,\n\t\t\tautoresize: true,\n\t\t\tminHeight: false,\n\t\t\tmaxHeight: false,\n\t\t\tshortcuts: {\n\t\t\t\t'ctrl+m, meta+m': \"this.execCommand('removeFormat', false)\",\n\t\t\t\t'ctrl+b, meta+b': \"this.execCommand('bold', false)\",\n\t\t\t\t'ctrl+i, meta+i': \"this.execCommand('italic', false)\",\n\t\t\t\t'ctrl+h, meta+h': \"this.execCommand('superscript', false)\",\n\t\t\t\t'ctrl+l, meta+l': \"this.execCommand('subscript', false)\",\n\t\t\t\t'ctrl+k, meta+k': \"this.linkShow()\",\n\t\t\t\t'ctrl+shift+7': \"this.execCommand('insertorderedlist', false)\",\n\t\t\t\t'ctrl+shift+8': \"this.execCommand('insertunorderedlist', false)\"\n\t\t\t},\n\t\t\tshortcutsAdd: false,\n\n\t\t\tautosave: false,\n\t\t\tautosaveInterval: 60,\n\n\t\t\tplugins: false,\n\n\t\t\tlinkProtocol: 'http://',\n\t\t\tlinkNofollow: false,\n\t\t\tlinkSize: 50,\n\t\t\tpredefinedLinks: false,\n\n\t\t\timageFloatMargin: '10px',\n\t\t\timageGetJson: false,\n\n\t\t\tdragUpload: true,\n\t\t\timageTabLink: true,\n\t\t\timageUpload: false,\n\t\t\timageUploadParam: 'file',\n\t\t\timageResizable: true,\n\n\t\t\tfileUpload: false,\n\t\t\tfileUploadParam: 'file',\n\t\t\tclipboardUpload: true,\n\t\t\tclipboardUploadUrl: false,\n\n\t\t\tsmilesUrl: '',\n\n\t\t\tdnbImageTypes: ['image/png', 'image/jpeg', 'image/gif'],\n\n\t\t\ts3: false,\n\t\t\tuploadFields: false,\n\n\t\t\tobserveImages: true,\n\t\t\tobserveLinks: true,\n\n\t\t\tmodalOverlay: true,\n\n\t\t\ttabSpaces: false,\n\t\t\ttabFocus: true,\n\n\t\t\tair: false,\n\t\t\tairButtons: ['formatting', 'bold', 'italic', 'deleted', 'unorderedlist', 'orderedlist', 'outdent', 'indent'],\n\n\t\t\ttoolbar: true,\n\t\t\ttoolbarFixed: false,\n\t\t\ttoolbarFixedTarget: document,\n\t\t\ttoolbarFixedTopOffset: 0,\n\t\t\ttoolbarFixedBox: false,\n\t\t\ttoolbarExternal: false,\n\t\t\ttoolbarOverflow: false,\n\t\t\tbuttonSource: true,\n\n\t\t\tbuttons: ['html', 'undo', 'redo', 'formatting', 'bold', 'italic', 'deleted', 'unorderedlist', 'orderedlist',\n\t\t\t\t\t  'outdent', 'indent', 'image', 'video', 'file', 'table', 'link', 'alignment', '|',\n\t\t\t\t\t  'horizontalrule'], /**'underline', 'alignleft', 'aligncenter', 'alignright', 'justify'**/\n\t\t\tbuttonsHideOnMobile: [],\n\n\t\t\tactiveButtons: ['deleted', 'italic', 'bold', 'underline', 'unorderedlist', 'orderedlist',\n\t\t\t\t\t\t\t'alignleft', 'aligncenter', 'alignright', 'justify', 'table'],\n\t\t\tactiveButtonsStates: {\n\t\t\t\tb: 'bold',\n\t\t\t\tstrong: 'bold',\n\t\t\t\ti: 'italic',\n\t\t\t\tem: 'italic',\n\t\t\t\tdel: 'deleted',\n\t\t\t\tstrike: 'deleted',\n\t\t\t\tul: 'unorderedlist',\n\t\t\t\tol: 'orderedlist',\n\t\t\t\tu: 'underline',\n\t\t\t\ttr: 'table',\n\t\t\t\ttd: 'table',\n\t\t\t\ttable: 'table'\n\t\t\t},\n\n\t\t\tformattingTags: ['p', 'blockquote', 'code', 'h2', 'h3', 'h4', 'h5', 'h6'],\n\n\t\t\tlinebreaks: false,\n\t\t\tparagraphy: true,\n\t\t\tconvertDivs: true,\n\t\t\tconvertLinks: true,\n\t\t\tconvertImageLinks: false,\n\t\t\tconvertVideoLinks: false,\n\t\t\tformattingPre: false,\n\t\t\tphpTags: false,\n\n\t\t\tallowedTags: false,\n\t\t\tdeniedTags: ['html', 'head', 'link', 'body', 'meta', 'script', 'style', 'applet'],\n\n\t\t\tboldTag: 'strong',\n\t\t\titalicTag: 'em',\n\n\t\t\tindentValue: 20,\n\t\t\tbuffer: [],\n\t\t\trebuffer: [],\n\t\t\ttextareamode: false,\n\t\t\temptyHtml: '<p>&#x200b;</p>',\n\t\t\tinvisibleSpace: '&#x200b;',\n\t\t\trBlockTest: /^(P|H[1-6]|LI|ADDRESS|SECTION|HEADER|FOOTER|ASIDE|ARTICLE)$/i,\n\t\t\talignmentTags: ['P', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'DD', 'DL', 'DT', 'DIV', 'TD',\n\t\t\t\t\t\t\t\t'BLOCKQUOTE', 'OUTPUT', 'FIGCAPTION', 'ADDRESS', 'SECTION',\n\t\t\t\t\t\t\t\t'HEADER', 'FOOTER', 'ASIDE', 'ARTICLE'],\n\t\t\townLine: ['area', 'body', 'head', 'hr', 'i?frame', 'link', 'meta', 'noscript', 'style', 'script', 'table', 'tbody', 'thead', 'tfoot'],\n\t\t\tcontOwnLine: ['li', 'dt', 'dt', 'h[1-6]', 'option', 'script'],\n\t\t\tnewLevel: ['blockquote', 'div', 'dl', 'fieldset', 'form', 'frameset', 'map', 'ol', 'p', 'code', 'select', 'td', 'th', 'tr', 'ul'],\n\t\t\tblockLevelElements: ['P', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'DD', 'DL', 'DT', 'DIV', 'LI',\n\t\t\t\t\t\t\t\t'BLOCKQUOTE', 'OUTPUT', 'FIGCAPTION', 'CODE', 'ADDRESS', 'SECTION',\n\t\t\t\t\t\t\t\t'HEADER', 'FOOTER', 'ASIDE', 'ARTICLE', 'TD'],\n\t\t\tlangs: {\n\t\t\t\ten: {\n\t\t\t\t\thtml: 'HTML',\n\t\t\t\t\tvideo: 'Insert Video',\n\t\t\t\t\timage: 'Insert Image',\n\t\t\t\t\ttable: 'Table',\n\t\t\t\t\tlink: 'Link',\n\t\t\t\t\tlink_insert: 'Insert link',\n\t\t\t\t\tlink_edit: 'Edit link',\n\t\t\t\t\tunlink: 'Unlink',\n\t\t\t\t\tformatting: 'Formatting',\n\t\t\t\t\tparagraph: 'Normal text',\n\t\t\t\t\tquote: 'Quote',\n\t\t\t\t\tcode: 'Code',\n\t\t\t\t\theader1: 'Header 1',\n\t\t\t\t\theader2: 'Header 2',\n\t\t\t\t\theader3: 'Header 3',\n\t\t\t\t\theader4: 'Header 4',\n\t\t\t\t\theader5: 'Header 5',\n\t\t\t\t\tbold: 'Bold',\n\t\t\t\t\titalic: 'Italic',\n\t\t\t\t\tfontcolor: 'Font Color',\n\t\t\t\t\tbackcolor: 'Back Color',\n\t\t\t\t\tunorderedlist: 'Unordered List',\n\t\t\t\t\torderedlist: 'Ordered List',\n\t\t\t\t\toutdent: 'Outdent',\n\t\t\t\t\tindent: 'Indent',\n\t\t\t\t\tcancel: 'Cancel',\n\t\t\t\t\tinsert: 'Insert',\n\t\t\t\t\tsave: 'Save',\n\t\t\t\t\t_delete: 'Delete',\n\t\t\t\t\tinsert_table: 'Insert Table',\n\t\t\t\t\tinsert_row_above: 'Add Row Above',\n\t\t\t\t\tinsert_row_below: 'Add Row Below',\n\t\t\t\t\tinsert_column_left: 'Add Column Left',\n\t\t\t\t\tinsert_column_right: 'Add Column Right',\n\t\t\t\t\tdelete_column: 'Delete Column',\n\t\t\t\t\tdelete_row: 'Delete Row',\n\t\t\t\t\tdelete_table: 'Delete Table',\n\t\t\t\t\trows: 'Rows',\n\t\t\t\t\tcolumns: 'Columns',\n\t\t\t\t\tadd_head: 'Add Head',\n\t\t\t\t\tdelete_head: 'Delete Head',\n\t\t\t\t\ttitle: 'Title',\n\t\t\t\t\timage_position: 'Position',\n\t\t\t\t\tnone: 'None',\n\t\t\t\t\tleft: 'Left',\n\t\t\t\t\tright: 'Right',\n\t\t\t\t\tcenter: 'Center',\n\t\t\t\t\timage_web_link: 'Image Web Link',\n\t\t\t\t\ttext: 'Text',\n\t\t\t\t\tmailto: 'Email',\n\t\t\t\t\tweb: 'URL',\n\t\t\t\t\tvideo_html_code: 'Video Embed Code',\n\t\t\t\t\tfile: 'Insert File',\n\t\t\t\t\tupload: 'Upload',\n\t\t\t\t\tdownload: 'Download',\n\t\t\t\t\tchoose: 'Choose',\n\t\t\t\t\tempty_img_list: 'You have no images',\n\t\t\t\t\tor_choose: 'Or choose',\n\t\t\t\t\tdrop_file_here: 'Drop file here',\n\t\t\t\t\talign_left: 'Align text to the left',\n\t\t\t\t\talign_center: 'Center text',\n\t\t\t\t\talign_right: 'Align text to the right',\n\t\t\t\t\talign_justify: 'Justify text',\n\t\t\t\t\thorizontalrule: 'Insert Horizontal Rule',\n                    fullscreen: 'Full screen',\n                    fontsize: 'Font size',\n                    fontfamily: 'Font',\n                    remove_font: 'Clear Font',\n                    image_save_toserver: 'Save to the server?',\n\t\t\t\t\tdeleted: 'Deleted',\n\t\t\t\t\tanchor: 'Anchor',\n\t\t\t\t\tlink_new_tab: 'Open link in new tab',\n\t\t\t\t\tunderline: 'Underline',\n\t\t\t\t\talignment: 'Alignment',\n\t\t\t\t\tfilename: 'Name (optional)',\n\t\t\t\t\tedit: 'Edit',\n                    spoiler: 'Spoiler',\n                    spoiler_name: 'Spoiler name',\n                    spoiler_text: 'Spoiler text',\n                    smiles: 'Smiles',\n                    undo: 'Undo',\n                    redo: 'Redo',\n                    formalize: 'Formalize'\n\t\t\t\t}\n\t\t\t}\n\t};\n\n\tRedactor.fn = $.Redactor.prototype = {\n\n\t\tkeyCode: {\n\t\t\tBACKSPACE: 8,\n\t\t\tDELETE: 46,\n\t\t\tDOWN: 40,\n\t\t\tENTER: 13,\n\t\t\tESC: 27,\n\t\t\tTAB: 9,\n\t\t\tCTRL: 17,\n\t\t\tMETA: 91,\n\t\t\tLEFT: 37,\n\t\t\tLEFT_WIN: 91\n\t\t},\n\n\t\tinit: function(el, options)\n\t\t{\n\t\t\tthis.rtePaste = false;\n\t\t\tthis.$element = this.$source = $(el);\n\t\t\tthis.uuid = uuid++;\n\n\t\t\tvar opts = $.extend(true, {}, $.Redactor.opts);\n\n\t\t\tthis.opts = $.extend(\n\t\t\t\t{},\n\t\t\t\topts,\n\t\t\t\tthis.$element.data(),\n\t\t\t\toptions\n\t\t\t);\n\n\t\t\tthis.start = true;\n\t\t\tthis.dropdowns = [];\n\n\t\t\tthis.sourceHeight = this.$source.css('height');\n\t\t\tthis.sourceWidth = this.$source.css('width');\n\n\t\t\tif (this.opts.fullpage) this.opts.iframe = true;\n\t\t\tif (this.opts.linebreaks) this.opts.paragraphy = false;\n\t\t\tif (this.opts.paragraphy) this.opts.linebreaks = false;\n\t\t\tif (this.opts.toolbarFixedBox) this.opts.toolbarFixed = true;\n\n\t\t\tthis.document = document;\n\t\t\tthis.window = window;\n\n\t\t\tthis.savedSel = false;\n\n\t\t\tthis.cleanlineBefore = new RegExp('^<(/?' + this.opts.ownLine.join('|/?' ) + '|' + this.opts.contOwnLine.join('|') + ')[ >]');\n\t\t\tthis.cleanlineAfter = new RegExp('^<(br|/?' + this.opts.ownLine.join('|/?' ) + '|/' + this.opts.contOwnLine.join('|/') + ')[ >]');\n\t\t\tthis.cleannewLevel = new RegExp('^</?(' + this.opts.newLevel.join('|' ) + ')[ >]');\n\n\t\t\tthis.rTestBlock = new RegExp('^(' + this.opts.blockLevelElements.join('|' ) + ')$', 'i');\n\n\t\t\tif (this.opts.linebreaks === false)\n\t\t\t{\n\t\t\t\tif (this.opts.allowedTags !== false)\n\t\t\t\t{\n\t\t\t\t\tvar arrSearch = ['strong', 'em', 'del'];\n\t\t\t\t\tvar arrAdd = ['b', 'i', 'strike'];\n\n\t\t\t\t\tif ($.inArray('p', this.opts.allowedTags) === '-1') this.opts.allowedTags.push('p');\n\n\t\t\t\t\tfor (i in arrSearch)\n\t\t\t\t\t{\n\t\t\t\t\t\tif ($.inArray(arrSearch[i], this.opts.allowedTags) != '-1') this.opts.allowedTags.push(arrAdd[i]);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (this.opts.deniedTags !== false)\n\t\t\t\t{\n\t\t\t\t\tvar pos = $.inArray('p', this.opts.deniedTags);\n\t\t\t\t\tif (pos !== '-1') this.opts.deniedTags.splice(pos, pos);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (this.browser('msie') || this.browser('opera'))\n\t\t\t{\n\t\t\t\tthis.opts.buttons = this.removeFromArrayByValue(this.opts.buttons, 'horizontalrule');\n\t\t\t}\n\n\t\t\tthis.opts.curLang = this.opts.langs[this.opts.lang];\n\n\t\t\t$.extend(this.opts.shortcuts, this.opts.shortcutsAdd);\n\n\t\t\tthis.placeholderInit();\n\n\t\t\tthis.buildStart();\n\n\t\t},\n\t\ttoolbarInit: function(lang)\n\t\t{\n\t\t\treturn {\n\t\t\t\thtml:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.html,\n\t\t\t\t\tfunc: 'toggle'\n\t\t\t\t},\n\t\t\t\tundo:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.undo,\n\t\t\t\t\tfunc: 'bufferUndo'\n\t\t\t\t},\n\t\t\t\tredo:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.redo,\n\t\t\t\t\tfunc: 'bufferRedo'\n\t\t\t\t},\n\t\t\t\tformatting:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.formatting,\n\t\t\t\t\tfunc: 'show',\n\t\t\t\t\tdropdown:\n\t\t\t\t\t{\n\t\t\t\t\t\tp:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.paragraph,\n\t\t\t\t\t\t\tfunc: 'formatBlocks'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tblockquote:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.quote,\n\t\t\t\t\t\t\tfunc: 'formatQuote',\n\t\t\t\t\t\t\tclassName: 'redactor_format_blockquote'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tcode:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.code,\n\t\t\t\t\t\t\tfunc: 'formatBlocks',\n\t\t\t\t\t\t\tclassName: 'redactor_format_code'\n\t\t\t\t\t\t},\n\t\t\t\t\t\th1:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.header1,\n\t\t\t\t\t\t\tfunc: 'formatBlocks',\n\t\t\t\t\t\t\tclassName: 'redactor_format_h1'\n\t\t\t\t\t\t},\n\t\t\t\t\t\th2:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.header2,\n\t\t\t\t\t\t\tfunc: 'formatBlocks',\n\t\t\t\t\t\t\tclassName: 'redactor_format_h2'\n\t\t\t\t\t\t},\n\t\t\t\t\t\th3:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.header3,\n\t\t\t\t\t\t\tfunc: 'formatBlocks',\n\t\t\t\t\t\t\tclassName: 'redactor_format_h3'\n\t\t\t\t\t\t},\n\t\t\t\t\t\th4:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.header4,\n\t\t\t\t\t\t\tfunc: 'formatBlocks',\n\t\t\t\t\t\t\tclassName: 'redactor_format_h4'\n\t\t\t\t\t\t},\n\t\t\t\t\t\th5:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.header5,\n\t\t\t\t\t\t\tfunc: 'formatBlocks',\n\t\t\t\t\t\t\tclassName: 'redactor_format_h5'\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tbold:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.bold,\n\t\t\t\t\texec: 'bold'\n\t\t\t\t},\n\t\t\t\titalic:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.italic,\n\t\t\t\t\texec: 'italic'\n\t\t\t\t},\n\t\t\t\tdeleted:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.deleted,\n\t\t\t\t\texec: 'strikethrough'\n\t\t\t\t},\n\t\t\t\tunderline:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.underline,\n\t\t\t\t\texec: 'underline'\n\t\t\t\t},\n\t\t\t\tunorderedlist:\n\t\t\t\t{\n\t\t\t\t\ttitle: '&bull; ' + lang.unorderedlist,\n\t\t\t\t\texec: 'insertunorderedlist'\n\t\t\t\t},\n\t\t\t\torderedlist:\n\t\t\t\t{\n\t\t\t\t\ttitle: '1. ' + lang.orderedlist,\n\t\t\t\t\texec: 'insertorderedlist'\n\t\t\t\t},\n\t\t\t\toutdent:\n\t\t\t\t{\n\t\t\t\t\ttitle: '< ' + lang.outdent,\n\t\t\t\t\tfunc: 'indentingOutdent'\n\t\t\t\t},\n\t\t\t\tindent:\n\t\t\t\t{\n\t\t\t\t\ttitle: '> ' + lang.indent,\n\t\t\t\t\tfunc: 'indentingIndent'\n\t\t\t\t},\n\t\t\t\timage:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.image,\n\t\t\t\t\tfunc: 'imageShow'\n\t\t\t\t},\n\t\t\t\tvideo:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.video,\n\t\t\t\t\tfunc: 'videoShow'\n\t\t\t\t},\n\t\t\t\tfile:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.file,\n\t\t\t\t\tfunc: 'fileShow'\n\t\t\t\t},\n\t\t\t\ttable:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.table,\n\t\t\t\t\tfunc: 'show',\n\t\t\t\t\tdropdown:\n\t\t\t\t\t{\n\t\t\t\t\t\tinsert_table:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.insert_table,\n\t\t\t\t\t\t\tfunc: 'tableShow'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tseparator_drop1:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tname: 'separator'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tinsert_row_above:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.insert_row_above,\n\t\t\t\t\t\t\tfunc: 'tableAddRowAbove'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tinsert_row_below:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.insert_row_below,\n\t\t\t\t\t\t\tfunc: 'tableAddRowBelow'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tinsert_column_left:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.insert_column_left,\n\t\t\t\t\t\t\tfunc: 'tableAddColumnLeft'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tinsert_column_right:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.insert_column_right,\n\t\t\t\t\t\t\tfunc: 'tableAddColumnRight'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tseparator_drop2:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tname: 'separator'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tadd_head:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.add_head,\n\t\t\t\t\t\t\tfunc: 'tableAddHead'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tdelete_head:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.delete_head,\n\t\t\t\t\t\t\tfunc: 'tableDeleteHead'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tseparator_drop3:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tname: 'separator'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tdelete_column:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.delete_column,\n\t\t\t\t\t\t\tfunc: 'tableDeleteColumn'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tdelete_row:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.delete_row,\n\t\t\t\t\t\t\tfunc: 'tableDeleteRow'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tdelete_table:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.delete_table,\n\t\t\t\t\t\t\tfunc: 'tableDeleteTable'\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tlink: {\n\t\t\t\t\ttitle: lang.link,\n\t\t\t\t\tfunc: 'show',\n\t\t\t\t\tdropdown:\n\t\t\t\t\t{\n\t\t\t\t\t\tlink:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.link_insert,\n\t\t\t\t\t\t\tfunc: 'linkShow'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tunlink:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.unlink,\n\t\t\t\t\t\t\texec: 'unlink'\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\talignment:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.alignment,\n\t\t\t\t\tfunc: 'show',\n\t\t\t\t\tdropdown:\n\t\t\t\t\t{\n\t\t\t\t\t\talignleft:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.align_left,\n\t\t\t\t\t\t\tfunc: 'alignmentLeft'\n\t\t\t\t\t\t},\n\t\t\t\t\t\taligncenter:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.align_center,\n\t\t\t\t\t\t\tfunc: 'alignmentCenter'\n\t\t\t\t\t\t},\n\t\t\t\t\t\talignright:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.align_right,\n\t\t\t\t\t\t\tfunc: 'alignmentRight'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tjustify:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.align_justify,\n\t\t\t\t\t\t\tfunc: 'alignmentJustify'\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\talignleft:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.align_left,\n\t\t\t\t\tfunc: 'alignmentLeft'\n\t\t\t\t},\n\t\t\t\taligncenter:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.align_center,\n\t\t\t\t\tfunc: 'alignmentCenter'\n\t\t\t\t},\n\t\t\t\talignright:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.align_right,\n\t\t\t\t\tfunc: 'alignmentRight'\n\t\t\t\t},\n\t\t\t\talignjustify:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.align_justify,\n\t\t\t\t\tfunc: 'alignmentJustify'\n\t\t\t\t},\n\t\t\t\thorizontalrule:\n\t\t\t\t{\n\t\t\t\t\texec: 'inserthorizontalrule',\n\t\t\t\t\ttitle: lang.horizontalrule\n\t\t\t\t}\n\n\t\t\t}\n\t\t},\n\n\t\tcallback: function(type, event, data)\n\t\t{\n\t\t\tvar callback = this.opts[ type + 'Callback' ];\n\t\t\tif ($.isFunction(callback))\n\t\t\t{\n\t\t\t\tif (event === false) return callback.call(this, data);\n\t\t\t\telse return callback.call(this, event, data);\n\t\t\t}\n\t\t\telse return data;\n\t\t},\n\n\t\tdestroy: function()\n\t\t{\n\t\t\tclearInterval(this.autosaveInterval);\n\n\t\t\t$(window).off('.redactor');\n\t\t\tthis.$source.off('redactor-textarea');\n\t\t\tthis.$element.off('.redactor').removeData('redactor');\n\n\t\t\tvar html = this.get();\n\n\t\t\tif (this.opts.textareamode)\n\t\t\t{\n\t\t\t\tthis.$box.after(this.$source);\n\t\t\t\tthis.$box.remove();\n\t\t\t\tthis.$source.val(html).show();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tvar $elem = this.$editor;\n\t\t\t\tif (this.opts.iframe) $elem = this.$element;\n\n\t\t\t\tthis.$box.after($elem);\n\t\t\t\tthis.$box.remove();\n\n\t\t\t\t$elem.removeClass('redactor_editor').removeClass('redactor_editor_wym').removeAttr('contenteditable').html(html).show();\n\t\t\t}\n\n\t\t\tif (this.opts.toolbarExternal)\n\t\t\t{\n\t\t\t\t$(this.opts.toolbarExternal).html('');\n\t\t\t}\n\n\t\t\tif (this.opts.air)\n\t\t\t{\n\t\t\t\t$('#redactor_air_' + this.uuid).remove();\n\t\t\t}\n\t\t},\n\n\t\tgetObject: function()\n\t\t{\n\t\t\treturn $.extend({}, this);\n\t\t},\n\t\tgetEditor: function()\n\t\t{\n\t\t\treturn this.$editor;\n\t\t},\n\t\tgetBox: function()\n\t\t{\n\t\t\treturn this.$box;\n\t\t},\n\t\tgetIframe: function()\n\t\t{\n\t\t\treturn (this.opts.iframe) ? this.$frame : false;\n\t\t},\n\t\tgetToolbar: function()\n\t\t{\n\t\t\treturn (this.$toolbar) ? this.$toolbar : false;\n\t\t},\n\n\t\tget: function()\n\t\t{\n\t\t\treturn this.$source.val();\n\t\t},\n\t\tgetCodeIframe: function()\n\t\t{\n\t\t\tthis.$editor.removeAttr('contenteditable').removeAttr('dir');\n\t\t\tvar html = this.outerHtml(this.$frame.contents().children());\n\t\t\tthis.$editor.attr({ 'contenteditable': true, 'dir': this.opts.direction });\n\n\t\t\treturn html;\n\t\t},\n\t\tset: function(html, strip, placeholderRemove)\n\t\t{\n\t\t\thtml = html.toString();\n\t\t\thtml = html.replace(/\\$/g, '&#36;');\n\n\t\t\tif (this.opts.fullpage) this.setCodeIframe(html);\n\t\t\telse this.setEditor(html, strip);\n\n\t\t\tif (html == '') placeholderRemove = false;\n\t\t\tif (placeholderRemove !== false) this.placeholderRemoveFromEditor();\n\t\t},\n\t\tsetEditor: function(html, strip)\n\t\t{\n\n\t\t\tif (strip !== false)\n\t\t\t{\n\t\t\t\thtml = this.cleanSavePreCode(html);\n\n\t\t\t\thtml = this.cleanStripTags(html);\n\t\t\t\thtml = this.cleanConvertProtected(html);\n\t\t\t\thtml = this.cleanConvertInlineTags(html, true);\n\n\t\t\t\tif (this.opts.linebreaks === false)\thtml = this.cleanConverters(html);\n\t\t\t\telse html = html.replace(/<p(.*?)>([\\w\\W]*?)<\\/p>/gi, '$2<br>');\n\t\t\t}\n\n\t\t\thtml = html.replace(/&amp;#36;/g, '$');\n\n\t\t\thtml = this.cleanEmpty(html);\n\t\t\thtml = this.sanitizeHTML(html);\n\n\t\t\tthis.$editor.html(html);\n\n\t\t\tthis.setNonEditable();\n\t\t\tthis.setSpansVerified();\n\n\t\t\tthis.sync();\n\t\t},\n        sanitizeHTML:  function(htmlStr)\n\t\t{\n            function stringToHTML () {\n                let parser = new DOMParser();\n                let doc = parser.parseFromString(htmlStr, 'text/html');\n                return doc.body;\n            }\n            function clean (html) {\n                let nodes = html.children;\n                for (let node of nodes) {\n                    removeAttributes(node);\n                    clean(node);\n                }\n            }\n            function removeAttributes (elem) {\n                let atts = elem.attributes;\n                for (let {name, value} of atts) {\n                    if (!isPossiblyDangerous(name, value)) { continue };\n                    elem.removeAttribute(name);\n                }\n\n            }\n            function isPossiblyDangerous (name, value) {\n                let val = value.replace(/\\s+/g, '').toLowerCase();\n                if (['src', 'href', 'xlink:href'].includes(name)) {\n                    if (val.includes('javascript:') || val.includes('data:text/html')) { return true; }\n                }\n                if (name.startsWith('on')) { return true; }\n            }\n            let html = stringToHTML();\n\n            clean(html);\n\n            return html.innerHTML;\n        },\n\t\tsetCodeIframe: function(html)\n\t\t{\n\t\t\tvar doc = this.iframePage();\n\t\t\tthis.$frame[0].src = \"about:blank\";\n\n\t\t\thtml = this.cleanConvertProtected(html);\n\t\t\thtml = this.cleanConvertInlineTags(html);\n\t\t\thtml = this.cleanRemoveSpaces(html);\n\n\t\t\tdoc.open();\n\t\t\tdoc.write(html);\n\t\t\tdoc.close();\n\n\t\t\tif (this.opts.fullpage)\n\t\t\t{\n\t\t\t\tthis.$editor = this.$frame.contents().find('body').attr({ 'contenteditable': true, 'dir': this.opts.direction });\n\t\t\t}\n\n\t\t\tthis.setNonEditable();\n\t\t\tthis.setSpansVerified();\n\t\t\tthis.sync();\n\n\t\t},\n\t\tsetFullpageOnInit: function(html)\n\t\t{\n\t\t\tthis.fullpageDoctype = html.match(/^<\\!doctype[^>]*>/i);\n\t\t\tif (this.fullpageDoctype && this.fullpageDoctype.length == 1)\n\t\t\t{\n\t\t\t\thtml = html.replace(/^<\\!doctype[^>]*>/i, '');\n\t\t\t}\n\n\t\t\thtml = this.cleanSavePreCode(html, true);\n\t\t\thtml = this.cleanConverters(html);\n\t\t\thtml = this.cleanEmpty(html);\n            html = this.sanitizeHTML(html);\n\n\t\t\tthis.$editor.html(html);\n\n\t\t\tthis.setNonEditable();\n\t\t\tthis.setSpansVerified();\n\t\t\tthis.sync();\n\t\t},\n\t\tsetFullpageDoctype: function()\n\t\t{\n\t\t\tif (this.fullpageDoctype && this.fullpageDoctype.length == 1)\n\t\t\t{\n\t\t\t\tvar source = this.fullpageDoctype[0] + '\\n' + this.$source.val();\n\t\t\t\tthis.$source.val(source);\n\t\t\t}\n\t\t},\n\t\tsetSpansVerified: function()\n\t\t{\n\t\t\tvar spans = this.$editor.find('span');\n\t\t\tvar replacementTag = 'inline';\n\n\t\t\t$.each(spans, function() {\n\t\t\t\tvar outer = this.outerHTML;\n\n\t\t\t\tvar regex = new RegExp('<' + this.tagName, 'gi');\n\t\t\t\tvar newTag = outer.replace(regex, '<' + replacementTag);\n\n\t\t\t\tregex = new RegExp('</' + this.tagName, 'gi');\n\t\t\t\tnewTag = newTag.replace(regex, '</' + replacementTag);\n\n\t\t\t\t$(this).replaceWith(newTag);\n\t\t\t});\n\n\t\t},\n\t\tsetSpansVerifiedHtml: function(html)\n\t\t{\n\t\t\thtml = html.replace(/<span(.*?)>/, '<inline$1>');\n\t\t\treturn html.replace(/<\\/span>/, '</inline>');\n\t\t},\n\t\tsetNonEditable: function()\n\t\t{\n\t\t\tthis.$editor.find('.noneditable').attr('contenteditable', false);\n\t\t},\n\n\t\tsync: function(e)\n\t\t{\n\t\t\tvar html = '';\n\n\t\t\tthis.cleanUnverified();\n\n\t\t\tif (this.opts.fullpage) html = this.getCodeIframe();\n\t\t\telse html = this.$editor.html();\n\n\t\t\thtml = this.syncClean(html);\n\t\t\thtml = this.cleanRemoveEmptyTags(html);\n\n\t\t\tvar source = this.cleanRemoveSpaces(this.$source.val(), false);\n\t\t\tvar editor = this.cleanRemoveSpaces(html, false);\n\n\t\t\tif (source == editor)\n\t\t\t{\n\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\thtml = html.replace(/<\\/li><(ul|ol)>([\\w\\W]*?)<\\/(ul|ol)>/gi, '<$1>$2</$1></li>');\n\n\t\t\tif ($.trim(html) === '<br>') html = '';\n\t\t\tif (this.opts.xhtml)\n\t\t\t{\n\t\t\t\tvar xhtmlTags = ['br', 'hr', 'img', 'link', 'input', 'meta'];\n\t\t\t\t$.each(xhtmlTags, function(i,s)\n\t\t\t\t{\n\t\t\t\t\thtml = html.replace(new RegExp('<' + s + '(.*?[^\\/$]?)>', 'gi'), '<' + s + '$1 />');\n\t\t\t\t});\n\n\t\t\t}\n\t\t\thtml = this.callback('syncBefore', false, html);\n\n\t\t\tthis.$source.val(html);\n\t\t\tthis.setFullpageDoctype();\n\t\t\tthis.callback('syncAfter', false, html);\n\n\t\t\tif (this.start === false)\n\t\t\t{\n\n\t\t\t\tif (typeof e != 'undefined')\n\t\t\t\t{\n\t\t\t\t\tswitch(e.which)\n\t\t\t\t\t{\n\t\t\t\t        case 37:\n\t\t\t\t        break;\n\t\t\t\t        case 38:\n\t\t\t\t        break;\n\t\t\t\t        case 39:\n\t\t\t\t        break;\n\t\t\t\t        case 40:\n\t\t\t\t        break;\n\n\t\t\t\t\t\tdefault: this.callback('change', false, html);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.callback('change', false, html);\n\t\t\t\t}\n\t\t\t}\n\n\t\t},\n\t\tsyncClean: function(html)\n\t\t{\n\t\t\tif (!this.opts.fullpage) html = this.cleanStripTags(html);\n\t\t\thtml = $.trim(html);\n\t\t\thtml = this.placeholderRemoveFromCode(html);\n\t\t\thtml = html.replace(/&#x200b;/gi, '');\n\t\t\thtml = html.replace(/&#8203;/gi, '');\n\t\t\thtml = html.replace(/<\\/a>&nbsp;/gi, '<\\/a> ');\n\t\t\thtml = html.replace(/\\u200B/g, '');\n\n\t\t\tif (html == '<p></p>' || html == '<p> </p>' || html == '<p>&nbsp;</p>')\n\t\t\t{\n\t\t\t\thtml = '';\n\t\t\t}\n\t\t\tif (this.opts.linkNofollow)\n\t\t\t{\n\t\t\t\thtml = html.replace(/<a(.*?)rel=\"nofollow\"(.*?)>/gi, '<a$1$2>');\n\t\t\t\thtml = html.replace(/<a(.*?)>/gi, '<a$1 rel=\"nofollow\">');\n\t\t\t}\n\t\t\thtml = html.replace('<!--?php', '<?php');\n\t\t\thtml = html.replace('?-->', '?>');\n\t\t\thtml = html.replace(/<(.*?)class=\"noeditable\"(.*?) contenteditable=\"false\"(.*?)>/gi, '<$1class=\"noeditable\"$2$3>');\n\n\t\t\thtml = html.replace(/ data-tagblock=\"\"/gi, '');\n\t\t\thtml = html.replace(/<br\\s?\\/?>\\n?<\\/(P|H[1-6]|LI|ADDRESS|SECTION|HEADER|FOOTER|ASIDE|ARTICLE)>/gi, '</$1>');\n\t\t\thtml = html.replace(/<span(.*?)id=\"redactor-image-box\"(.*?)>([\\w\\W]*?)<img(.*?)><\\/span>/gi, '$3<img$4>');\n\t\t\thtml = html.replace(/<span(.*?)id=\"redactor-image-resizer\"(.*?)>(.*?)<\\/span>/gi, '');\n\t\t\thtml = html.replace(/<span(.*?)id=\"redactor-image-editter\"(.*?)>(.*?)<\\/span>/gi, '');\n\t\t\thtml = html.replace(/<(ul|ol)>\\s*\\t*\\n*<\\/(ul|ol)>/gi, '');\n\t\t\tif (this.opts.cleanFontTag)\n\t\t\t{\n\t\t\t\thtml = html.replace(/<font(.*?)>([\\w\\W]*?)<\\/font>/gi, '$2');\n\t\t\t}\n\t\t\thtml = html.replace(/<span(.*?)>([\\w\\W]*?)<\\/span>/gi, '$2');\n\t\t\thtml = html.replace(/<inline>([\\w\\W]*?)<\\/inline>/gi, '$1');\n\t\t\thtml = html.replace(/<inline>/gi, '<span>');\n\t\t\thtml = html.replace(/<inline /gi, '<span ');\n\t\t\thtml = html.replace(/<\\/inline>/gi, '</span>');\n\n\t\t\tif (this.opts.removeEmptyTags)\n\t\t\t{\n\t\t\t\thtml = html.replace(/<span>([\\w\\W]*?)<\\/span>/gi, '$1');\n\t\t\t}\n\n\t\t\thtml = html.replace(/<span(.*?)class=\"redactor_placeholder\"(.*?)>([\\w\\W]*?)<\\/span>/gi, '');\n\t\t\thtml = html.replace(/<img(.*?)contenteditable=\"false\"(.*?)>/gi, '<img$1$2>');\n\t\t\thtml = html.replace(/&/gi, '&');\n\t\t\thtml = html.replace(/\\u2122/gi, '&trade;');\n\t\t\thtml = html.replace(/\\u00a9/gi, '&copy;');\n\t\t\thtml = html.replace(/\\u2026/gi, '&hellip;');\n\t\t\thtml = html.replace(/\\u2014/gi, '&mdash;');\n\t\t\thtml = html.replace(/\\u2010/gi, '&dash;');\n\n\t\t\thtml = this.cleanReConvertProtected(html);\n\n\t\t\treturn html;\n\t\t},\n\n\t\tbuildStart: function()\n\t\t{\n\n\t\t\tthis.content = '';\n\t\t\tthis.$box = $('<div class=\"redactor_box\" />');\n\t\t\tif (this.$source[0].tagName === 'TEXTAREA') this.opts.textareamode = true;\n\t\t\tif (this.opts.mobile === false && this.isMobile())\n\t\t\t{\n\t\t\t\tthis.buildMobile();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\n\t\t\t\tthis.buildContent();\n\n\t\t\t\tif (this.opts.iframe)\n\t\t\t\t{\n\n\t\t\t\t\tthis.opts.autoresize = false;\n\t\t\t\t\tthis.iframeStart();\n\t\t\t\t}\n\t\t\t\telse if (this.opts.textareamode) this.buildFromTextarea();\n\t\t\t\telse this.buildFromElement();\n\t\t\t\tif (!this.opts.iframe)\n\t\t\t\t{\n\t\t\t\t\tthis.buildOptions();\n\t\t\t\t\tthis.buildAfter();\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\tbuildMobile: function()\n\t\t{\n\t\t\tif (!this.opts.textareamode)\n\t\t\t{\n\t\t\t\tthis.$editor = this.$source;\n\t\t\t\tthis.$editor.hide();\n\t\t\t\tthis.$source = this.buildCodearea(this.$editor);\n\t\t\t\tthis.$source.val(this.content);\n\t\t\t}\n\n\t\t\tthis.$box.insertAfter(this.$source).append(this.$source);\n\t\t},\n\t\tbuildContent: function()\n\t\t{\n\t\t\tif (this.opts.textareamode) this.content = $.trim(this.$source.val());\n\t\t\telse this.content = $.trim(this.$source.html());\n\t\t},\n\t\tbuildFromTextarea: function()\n\t\t{\n\t\t\tthis.$editor = $('<div />');\n\t\t\tthis.$box.insertAfter(this.$source).append(this.$editor).append(this.$source);\n\t\t\tthis.buildAddClasses(this.$editor);\n\t\t\tthis.buildEnable();\n\t\t},\n\t\tbuildFromElement: function()\n\t\t{\n\t\t\tthis.$editor = this.$source;\n\t\t\tthis.$source = this.buildCodearea(this.$editor);\n\t\t\tthis.$box.insertAfter(this.$editor).append(this.$editor).append(this.$source);\n\t\t\tthis.buildEnable();\n\t\t},\n\t\tbuildCodearea: function($source)\n\t\t{\n\t\t\treturn $('<textarea />').attr('name', $source.attr('id')).css('height', this.sourceHeight);\n\t\t},\n\t\tbuildAddClasses: function(el)\n\t\t{\n\n\t\t\t$.each(this.$source.get(0).className.split(/\\s+/), function(i,s)\n\t\t\t{\n\t\t\t\tel.addClass('redactor_' + s);\n\t\t\t});\n\t\t},\n\t\tbuildEnable: function()\n\t\t{\n\t\t\tthis.$editor.addClass('redactor_editor').attr({ 'contenteditable': true, 'dir': this.opts.direction });\n\t\t\tthis.$source.attr('dir', this.opts.direction).hide();\n\t\t\tthis.set(this.content, true, false);\n\t\t},\n\t\tbuildOptions: function()\n\t\t{\n\t\t\tvar $source = this.$editor;\n\t\t\tif (this.opts.iframe) $source = this.$frame;\n\t\t\tif (this.opts.tabindex) $source.attr('tabindex', this.opts.tabindex);\n\n\t\t\tif (this.opts.minHeight) $source.css('min-height', this.opts.minHeight + 'px');\n\n\t\t\telse if (this.browser('mozilla') && this.opts.linebreaks)\n\t\t\t{\n\t\t\t\tthis.$editor.css('min-height', '45px');\n\t\t\t}\n\n\t\t\tif (this.browser('mozilla') && this.opts.linebreaks)\n\t\t\t{\n\t\t\t\tthis.$editor.css('padding-bottom', '10px');\n\t\t\t}\n\t\t\tif (this.opts.maxHeight)\n\t\t\t{\n\t\t\t\tthis.opts.autoresize = false;\n\t\t\t\tthis.sourceHeight = this.opts.maxHeight;\n\t\t\t}\n\t\t\tif (this.opts.wym) this.$editor.addClass('redactor_editor_wym');\n\t\t\tif (this.opts.typewriter) this.$editor.addClass('redactor-editor-typewriter');\n\t\t\tif (!this.opts.autoresize) $source.css('height', this.sourceHeight);\n\n\t\t},\n\t\tbuildAfter: function()\n\t\t{\n\t\t\tthis.start = false;\n\t\t\tif (this.opts.toolbar)\n\t\t\t{\n\t\t\t\tthis.opts.toolbar = this.toolbarInit(this.opts.curLang);\n\t\t\t\tthis.toolbarBuild();\n\t\t\t}\n\t\t\tthis.modalTemplatesInit();\n\t\t\tthis.buildPlugins();\n\t\t\tthis.buildBindKeyboard();\n\t\t\tif (this.opts.autosave) this.autosave();\n\t\t\tsetTimeout($.proxy(this.observeStart, this), 4);\n\t\t\tif (this.browser('mozilla'))\n\t\t\t{\n\t\t\t\ttry {\n\t\t\t\t\tthis.document.execCommand('enableObjectResizing', false, false);\n\t\t\t\t\tthis.document.execCommand('enableInlineTableEditing', false, false);\n\t\t\t\t} catch (e) {}\n\t\t\t}\n\t\t\tif (this.opts.focus) setTimeout($.proxy(this.focus, this), 100);\n\t\t\tif (!this.opts.visual)\n\t\t\t{\n\t\t\t\tsetTimeout($.proxy(function()\n\t\t\t\t{\n\t\t\t\t\tthis.opts.visual = true;\n\t\t\t\t\tthis.toggle(false);\n\n\t\t\t\t}, this), 200);\n\t\t\t}\n\t\t\tthis.callback('init');\n\t\t},\n\t\tbuildBindKeyboard: function()\n\t\t{\n\t\t\tthis.dblEnter = 0;\n\n\t\t\tif (this.opts.dragUpload && (this.opts.imageUpload !== false || this.opts.s3 !== false))\n\t\t\t{\n\t\t\t\tthis.$editor.on('drop.redactor', $.proxy(this.buildEventDrop, this));\n\t\t\t}\n\n\t\t\tthis.$editor.on('click.redactor', $.proxy(function()\n\t\t\t{\n\t\t\t\tthis.selectall = false;\n\n\t\t\t}, this));\n\n\t\t\tthis.$editor.on('input.redactor', $.proxy(this.sync, this));\n\t\t\tthis.$editor.on('paste.redactor', $.proxy(this.buildEventPaste, this));\n\t\t\tthis.$editor.on('keydown.redactor', $.proxy(this.buildEventKeydown, this));\n\t\t\tthis.$editor.on('keyup.redactor', $.proxy(this.buildEventKeyup, this));\n\t\t\tif ($.isFunction(this.opts.textareaKeydownCallback))\n\t\t\t{\n\t\t\t\tthis.$source.on('keydown.redactor-textarea', $.proxy(this.opts.textareaKeydownCallback, this));\n\t\t\t}\n\t\t\tif ($.isFunction(this.opts.focusCallback))\n\t\t\t{\n\t\t\t\tthis.$editor.on('focus.redactor', $.proxy(this.opts.focusCallback, this));\n\t\t\t}\n\n\t\t\tvar clickedElement;\n\t\t\t$(document).mousedown(function(e) {\n\t\t\t\tclickedElement = $(e.target);\n\t\t\t});\n\t\t\tthis.$editor.on('blur.redactor', $.proxy(function(e)\n\t\t\t{\n\t\t\t\tif (!$(clickedElement).hasClass('redactor_toolbar') && $(clickedElement).parents('.redactor_toolbar').length == 0)\n\t\t\t\t{\n\t\t\t\t\tthis.selectall = false;\n\t\t\t\t\tif ($.isFunction(this.opts.blurCallback)) this.callback('blur', e);\n\t\t\t\t}\n\t\t\t}, this));\n\n\t\t},\n\t\tbuildEventDrop: function(e)\n\t\t{\n\t\t\te = e.originalEvent || e;\n\n\t\t\tif (window.FormData === undefined || !e.dataTransfer) return true;\n\n\t\t    var length = e.dataTransfer.files.length;\n\t\t    if (length == 0) return true;\n\n\t\t    e.preventDefault();\n\n\t        var file = e.dataTransfer.files[0];\n\n\t        if (this.opts.dnbImageTypes !== false && this.opts.dnbImageTypes.indexOf(file.type) == -1)\n\t        {\n\t\t        return true;\n\t        }\n\n\t\t\tthis.bufferSet();\n\n\t\t\tthis.showProgressBar();\n\n\t\t\tif (this.opts.s3 === false)\n\t\t\t{\n\t\t\t\tthis.dragUploadAjax(this.opts.imageUpload, file, true, e, this.opts.imageUploadParam);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.s3uploadFile(file);\n\t\t\t}\n\t\t},\n\t\tbuildEventPaste: function(e)\n\t\t{\n\t\t\tvar oldsafari = false;\n\t\t\tif (this.browser('webkit') && navigator.userAgent.indexOf('Chrome') === -1)\n\t\t\t{\n\t\t\t\tvar arr = this.browser('version').split('.');\n\t\t\t\tif (arr[0] < 536) oldsafari = true;\n\t\t\t}\n\n\t\t\tif (oldsafari) return true;\n\t\t\tif (this.browser('opera')) return true;\n\t\t\tif (this.opts.clipboardUpload && this.buildEventClipboardUpload(e)) return true;\n\n\t\t\tif (this.opts.cleanup)\n\t\t\t{\n\t\t\t\tthis.rtePaste = true;\n\n\t\t\t\tthis.selectionSave();\n\n\t\t\t\tif (!this.selectall)\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.autoresize === true && this.fullscreen !== true)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.$editor.height(this.$editor.height());\n\t\t\t\t\t\tthis.saveScroll = this.document.body.scrollTop;\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.saveScroll = this.$editor.scrollTop();\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tvar frag = this.extractContent();\n\n\t\t\t\tsetTimeout($.proxy(function()\n\t\t\t\t{\n\t\t\t\t\tvar pastedFrag = this.extractContent();\n\t\t\t\t\tthis.$editor.append(frag);\n\n\t\t\t\t\tthis.selectionRestore();\n\n\t\t\t\t\tvar html = this.getFragmentHtml(pastedFrag);\n\t\t\t\t\tthis.pasteClean(html);\n\n\t\t\t\t\tif (this.opts.autoresize === true && this.fullscreen !== true) this.$editor.css('height', 'auto');\n\n\t\t\t\t}, this), 1);\n\t\t\t}\n\t\t},\n\t\tbuildEventClipboardUpload: function(e)\n\t\t{\n\t\t\tvar event = e.originalEvent || e;\n\t\t\tthis.clipboardFilePaste = false;\n\t\t\tif (typeof(event.clipboardData) === 'undefined') { return false; }\n            var clipboard = event.clipboardData;\n\t\t\tif (clipboard.items)\n\t\t\t{\n\t\t\t\tvar file = event.clipboardData.items[0].getAsFile();\n\t\t\t\tif (file !== null)\n\t\t\t\t{\n\t\t\t\t\tthis.bufferSet();\n\t\t\t\t\tthis.clipboardFilePaste = true;\n\n\t\t\t\t\tvar reader = new FileReader();\n\t\t\t\t\treader.onload = $.proxy(this.pasteClipboardUpload, this);\n\t\t\t        reader.readAsDataURL(file);\n\n\t\t\t        return true;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn false;\n\n\t\t},\n\t\tbuildEventKeydown: function(e)\n\t\t{\n\t\t\tif (this.rtePaste) return false;\n\n\t\t\tvar key = e.which;\n\t\t\tvar ctrl = e.ctrlKey || e.metaKey;\n\t\t\tvar parent = this.getParent();\n\t\t\tvar current = this.getCurrent();\n\t\t\tvar block = this.getBlock();\n\t\t\tvar pre = false;\n\n\t\t\tthis.callback('keydown', e);\n\n\t\t\t/*\n\t\t\t\tfirefox cmd+left/Cmd+right browser back/forward fix -\n\t\t\t\thttp://joshrhoderick.wordpress.com/2010/05/05/how-firefoxs-command-key-bug-kills-usability-on-the-mac/\n\t\t\t*/\n\t\t\tif (this.browser('mozilla') && \"modify\" in window.getSelection())\n\t\t\t{\n\t\t\t\tif ((ctrl) && (e.keyCode===37 || e.keyCode===39))\n\t\t\t\t{\n\t\t\t\t\tvar selection = this.getSelection();\n\t\t\t\t\tvar lineOrWord = (e.metaKey ? \"line\" : \"word\");\n\t\t\t\t\tif (e.keyCode===37)\n\t\t\t\t\t{\n\t\t\t\t\t\tselection.modify(\"extend\",\"left\",lineOrWord);\n\t\t\t\t\t\tif (!e.shiftKey)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tselection.collapseToStart();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (e.keyCode===39)\n\t\t\t\t\t{\n\t\t\t\t\t\tselection.modify(\"extend\",\"right\",lineOrWord);\n\t\t\t\t\t\tif (!e.shiftKey)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tselection.collapseToEnd();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\te.preventDefault();\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis.imageResizeHide(false);\n\t\t\tif ((parent && $(parent).get(0).tagName === 'CODE') || (current && $(current).get(0).tagName === 'CODE'))\n\t\t\t{\n\t\t\t\tpre = true;\n\t\t\t\tif (key === this.keyCode.DOWN) this.insertAfterLastElement(block);\n\t\t\t}\n\t\t\tif (key === this.keyCode.DOWN)\n\t\t\t{\n\t\t\t\tif (parent && $(parent)[0].tagName === 'BLOCKQUOTE') this.insertAfterLastElement(parent);\n\t\t\t\tif (current && $(current)[0].tagName === 'BLOCKQUOTE') this.insertAfterLastElement(current);\n\n\t\t\t\tif (parent && $(parent)[0].tagName === 'P' && $(parent).parent()[0].tagName == 'BLOCKQUOTE')\n\t\t\t\t{\n\t\t\t\t\tthis.insertAfterLastElement(parent, $(parent).parent()[0]);\n\t\t\t\t}\n\t\t\t\tif (current && $(current)[0].tagName === 'P' && parent && $(parent)[0].tagName == 'BLOCKQUOTE')\n\t\t\t\t{\n\t\t\t\t\tthis.insertAfterLastElement(current, parent);\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis.shortcuts(e, key);\n\t\t\tif (ctrl && key === 90 && !e.shiftKey && !e.altKey)\n\t\t\t{\n\t\t\t\te.preventDefault();\n\t\t\t\tif (this.opts.buffer.length) this.bufferUndo();\n\t\t\t\telse this.document.execCommand('undo', false, false);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\telse if (ctrl && key === 90 && e.shiftKey && !e.altKey)\n\t\t\t{\n\t\t\t\te.preventDefault();\n\t\t\t\tif (this.opts.rebuffer.length != 0) this.bufferRedo();\n\t\t\t\telse this.document.execCommand('redo', false, false);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (key == 32)\n\t\t\t{\n\t\t\t\tthis.bufferSet();\n\t\t\t}\n\t\t\tif (ctrl && key === 65)\n\t\t\t{\n\t\t\t\tthis.bufferSet();\n\t\t\t\tthis.selectall = true;\n\t\t\t}\n\t\t\telse if (key != this.keyCode.LEFT_WIN && !ctrl)\n\t\t\t{\n\t\t\t\tthis.selectall = false;\n\t\t\t}\n\t\t\tif (key == this.keyCode.ENTER && !e.shiftKey && !e.ctrlKey && !e.metaKey)\n\t\t\t{\n\n\t\t\t\tvar range = this.getRange();\n\t\t\t\tif (range && range.collapsed === false)\n\t\t\t\t{\n\t\t\t\t\tsel = this.getSelection();\n\t\t\t\t\tif (sel.rangeCount)\n\t\t\t\t\t{\n\t\t\t\t\t\trange.deleteContents();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (this.browser('msie') && (parent.nodeType == 1 && (parent.tagName == 'TD' || parent.tagName == 'TH')))\n\t\t\t\t{\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\tthis.bufferSet();\n\t\t\t\t\tthis.insertNode(document.createElement('br'));\n\t\t\t\t\tthis.callback('enter', e);\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t\tif (block && (block.tagName == 'BLOCKQUOTE' || $(block).parent()[0].tagName == 'BLOCKQUOTE'))\n\t\t\t\t{\n\t\t\t\t\tif (this.isEndOfElement())\n\t\t\t\t\t{\n\t\t\t\t\t\tif (this.dblEnter == 1)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar element;\n\t\t\t\t\t\t\tvar last;\n\t\t\t\t\t\t\tif (block.tagName == 'BLOCKQUOTE')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tlast = 'br';\n\t\t\t\t\t\t\t\telement = block;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tlast = 'p';\n\t\t\t\t\t\t\t\telement = $(block).parent()[0];\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t\tthis.insertingAfterLastElement(element);\n\t\t\t\t\t\t\tthis.dblEnter = 0;\n\n\t\t\t\t\t\t\tif (last == 'p')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$(block).parent().find('p').last().remove();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tvar tmp = $.trim($(block).html());\n\t\t\t\t\t\t\t\t$(block).html(tmp.replace(/<br\\s?\\/?>$/i, ''));\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse this.dblEnter++;\n\t\t\t\t\t}\n\t\t\t\t\telse this.dblEnter++;\n\t\t\t\t}\n\t\t\t\tif (pre === true)\n\t\t\t\t{\n\t\t\t\t\treturn this.buildEventKeydownPre(e, current);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tif (!this.opts.linebreaks)\n\t\t\t\t\t{\n\n\t\t\t\t\t\tif (block && block.tagName == 'LI')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar listCurrent = this.getBlock();\n\t\t\t\t\t\t\tif (listCurrent !== false || listCurrent.tagName === 'LI')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tvar listText = $.trim($(block).text());\n\t\t\t\t\t\t\t\tvar listCurrentText = $.trim($(listCurrent).text());\n\t\t\t\t\t\t\t\tif (listText == ''\n\t\t\t\t\t\t\t\t\t&& listCurrentText == ''\n\t\t\t\t\t\t\t\t\t&& $(listCurrent).next('li').length == 0\n\t\t\t\t\t\t\t\t\t&& $(listCurrent).parents('li').length == 0)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tthis.bufferSet();\n\n\t\t\t\t\t\t\t\t\tvar $list = $(listCurrent).closest('ol, ul');\n\t\t\t\t\t\t\t\t\t$(listCurrent).remove();\n\t\t\t\t\t\t\t\t\tvar node = $('<p>' + this.opts.invisibleSpace + '</p>');\n\t\t\t\t\t\t\t\t\t$list.after(node);\n\t\t\t\t\t\t\t\t\tthis.selectionStart(node);\n\n\t\t\t\t\t\t\t\t\tthis.sync();\n\t\t\t\t\t\t\t\t\tthis.callback('enter', e);\n\t\t\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (block && this.opts.rBlockTest.test(block.tagName))\n\t\t\t\t\t\t{\n\n\t\t\t\t\t\t\tthis.bufferSet();\n\n\t\t\t\t\t\t\tsetTimeout($.proxy(function()\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tvar blockElem = this.getBlock();\n\t\t\t\t\t\t\t\tif (blockElem.tagName === 'DIV' && !$(blockElem).hasClass('redactor_editor'))\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tvar node = $('<p>' + this.opts.invisibleSpace + '</p>');\n\t\t\t\t\t\t\t\t\t$(blockElem).replaceWith(node);\n\t\t\t\t\t\t\t\t\tthis.selectionStart(node);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t}, this), 1);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (block === false)\n\t\t\t\t\t\t{\n\n\t\t\t\t\t\t\tthis.bufferSet();\n\t\t\t\t\t\t\tvar node = $('<p>' + this.opts.invisibleSpace + '</p>');\n\t\t\t\t\t\t\tthis.insertNode(node[0]);\n\t\t\t\t\t\t\tthis.selectionStart(node);\n\t\t\t\t\t\t\tthis.callback('enter', e);\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.opts.linebreaks)\n\t\t\t\t\t{\n\n\t\t\t\t\t\tif (block && this.opts.rBlockTest.test(block.tagName))\n\t\t\t\t\t\t{\n\n\t\t\t\t\t\t\tthis.bufferSet();\n\n\t\t\t\t\t\t\tsetTimeout($.proxy(function()\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tvar blockElem = this.getBlock();\n\t\t\t\t\t\t\t\tif ((blockElem.tagName === 'DIV' || blockElem.tagName === 'P') && !$(blockElem).hasClass('redactor_editor'))\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tthis.replaceLineBreak(blockElem);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t}, this), 1);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn this.buildEventKeydownInsertLineBreak(e);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (block.tagName == 'BLOCKQUOTE' || block.tagName == 'FIGCAPTION')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn this.buildEventKeydownInsertLineBreak(e);\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t\tthis.callback('enter', e);\n\t\t\t}\n\t\t\telse if (key === this.keyCode.ENTER && (e.ctrlKey || e.shiftKey))\n\t\t\t{\n\t\t\t\tthis.bufferSet();\n\n\t\t\t\te.preventDefault();\n\t\t\t\tthis.insertLineBreak();\n\t\t\t}\n\t\t\tif ((key === this.keyCode.TAB || e.metaKey && key === 219) && this.opts.shortcuts)\n\t\t\t{\n\t\t\t\treturn this.buildEventKeydownTab(e, pre, key);\n\t\t\t}\n\t\t\tif (key === this.keyCode.BACKSPACE) this.buildEventKeydownBackspace(e, current, parent);\n\n\t\t},\n\t\tbuildEventKeydownPre: function(e, current)\n\t\t{\n\t\t\te.preventDefault();\n\t\t\tthis.bufferSet();\n\t\t\tvar html = $(current).parent().text();\n\t\t\tthis.insertNode(document.createTextNode('\\n'));\n\t\t\tif (html.search(/\\s$/) == -1)\n\t\t\t{\n\t\t\t\tthis.insertNode(document.createTextNode('\\n'));\n\t\t\t}\n\n\t\t\tthis.sync();\n\t\t\tthis.callback('enter', e);\n\t\t\treturn false;\n\t\t},\n\t\tbuildEventKeydownTab: function(e, pre, key)\n\t\t{\n\t\t\tif (!this.opts.tabFocus) return true;\n\t\t\tif (this.isEmpty(this.get()) && this.opts.tabSpaces === false) return true;\n\n\t\t\te.preventDefault();\n\n\t\t\tif (pre === true && !e.shiftKey)\n\t\t\t{\n\t\t\t\tthis.bufferSet();\n\t\t\t\tthis.insertNode(document.createTextNode('\\t'));\n\t\t\t\tthis.sync();\n\t\t\t\treturn false;\n\n\t\t\t}\n\t\t\telse if (this.opts.tabSpaces !== false)\n\t\t\t{\n\t\t\t\tthis.bufferSet();\n\t\t\t\tthis.insertNode(document.createTextNode(Array(this.opts.tabSpaces + 1).join('\\u00a0')));\n\t\t\t\tthis.sync();\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tif (!e.shiftKey) this.indentingIndent();\n\t\t\t\telse this.indentingOutdent();\n\t\t\t}\n\n\t\t\treturn false;\n\t\t},\n\t\tbuildEventKeydownBackspace: function(e, current, parent)\n\t\t{\n\n\t\t\tif (parent && current && parent.parentNode.tagName == 'TD'\n\t\t\t\t&& parent.tagName == 'UL' && current.tagName == 'LI' && $(parent).children('li').length == 1)\n\t\t\t{\n\t\t\t\tvar text = $(current).text().replace(/[\\u200B-\\u200D\\uFEFF]/g, '');\n\t\t\t\tif (text == '')\n\t\t\t\t{\n\t\t\t\t\tvar node = parent.parentNode;\n\t\t\t\t\t$(parent).remove();\n\t\t\t\t\tthis.selectionStart(node);\n\t\t\t\t\tthis.sync();\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (typeof current.tagName !== 'undefined' && /^(H[1-6])$/i.test(current.tagName))\n\t\t\t{\n\t\t\t\tvar node;\n\t\t\t\tif (this.opts.linebreaks === false) node = $('<p>' + this.opts.invisibleSpace + '</p>');\n\t\t\t\telse node = $('<br>' + this.opts.invisibleSpace);\n\n\t\t\t\t$(current).replaceWith(node);\n\t\t\t\tthis.selectionStart(node);\n\t\t\t\tthis.sync();\n\t\t\t}\n\n\t\t\tif (typeof current.nodeValue !== 'undefined' && current.nodeValue !== null)\n\t\t\t{\n\t\t\t\tif (current.remove && current.nodeType === 3 && current.nodeValue.match(/[^\\u200B]/g) == null)\n\t\t\t\t{\n\t\t\t\t\t$(current).prev().remove();\n\t\t\t\t\tthis.sync();\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\tbuildEventKeydownInsertLineBreak: function(e)\n\t\t{\n\t\t\tthis.bufferSet();\n\t\t\te.preventDefault();\n\t\t\tthis.insertLineBreak();\n\t\t\tthis.callback('enter', e);\n\t\t\treturn;\n\t\t},\n\t\tbuildEventKeyup: function(e)\n\t\t{\n\t\t\tif (this.rtePaste) return false;\n\n\t\t\tvar key = e.which;\n\t\t\tvar parent = this.getParent();\n\t\t\tvar current = this.getCurrent();\n\t\t\tif (!this.opts.linebreaks && current.nodeType == 3 && (parent == false || parent.tagName == 'BODY'))\n\t\t\t{\n\t\t\t\tvar node = $('<p>').append($(current).clone());\n\t\t\t\t$(current).replaceWith(node);\n\t\t\t\tvar next = $(node).next();\n\t\t\t\tif (typeof(next[0]) !== 'undefined' && next[0].tagName == 'BR')\n\t\t\t\t{\n\t\t\t\t\tnext.remove();\n\t\t\t\t}\n\n\t\t\t\tthis.selectionEnd(node);\n\t\t\t}\n\t\t\tif ((this.opts.convertLinks || this.opts.convertImageLinks || this.opts.convertVideoLinks) && key === this.keyCode.ENTER)\n\t\t\t{\n\t\t\t\tthis.buildEventKeyupConverters();\n\t\t\t}\n\t\t\tif (key === this.keyCode.DELETE || key === this.keyCode.BACKSPACE)\n\t\t\t{\n\t\t\t\treturn this.formatEmpty(e);\n\t\t\t}\n\n\t\t\tthis.callback('keyup', e);\n\t\t\tthis.sync(e);\n\t\t},\n\t\tbuildEventKeyupConverters: function()\n\t\t{\n\t\t\tthis.formatLinkify(this.opts.linkProtocol, this.opts.convertLinks, this.opts.convertImageLinks, this.opts.convertVideoLinks, this.opts.linkSize);\n\n\t\t\tsetTimeout($.proxy(function()\n\t\t\t{\n\t\t\t\tif (this.opts.convertImageLinks) this.observeImages();\n\t\t\t\tif (this.opts.observeLinks) this.observeLinks();\n\t\t\t}, this), 5);\n\t\t},\n\t\tbuildPlugins: function()\n\t\t{\n\t\t\tif (!this.opts.plugins ) return;\n\n\t\t\t$.each(this.opts.plugins, $.proxy(function(i, s)\n\t\t\t{\n\t\t\t\tif (RedactorPlugins[s])\n\t\t\t\t{\n\t\t\t\t\t$.extend(this, RedactorPlugins[s]);\n\t\t\t\t\tif ($.isFunction( RedactorPlugins[ s ].init)) this.init();\n\t\t\t\t}\n\n\t\t\t}, this ));\n\t\t},\n\t\tiframeStart: function()\n\t\t{\n\t\t\tthis.iframeCreate();\n\n\t\t\tif (this.opts.textareamode) this.iframeAppend(this.$source);\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.$sourceOld = this.$source.hide();\n\t\t\t\tthis.$source = this.buildCodearea(this.$sourceOld);\n\t\t\t\tthis.iframeAppend(this.$sourceOld);\n\t\t\t}\n\t\t},\n\t\tiframeAppend: function(el)\n\t\t{\n\t\t\tthis.$source.attr('dir', this.opts.direction).hide();\n\t\t\tthis.$box.insertAfter(el).append(this.$frame).append(this.$source);\n\t\t},\n\t\tiframeCreate: function()\n\t\t{\n\t\t\tthis.$frame = $('<iframe style=\"width: 100%;\" frameborder=\"0\" />').one('load', $.proxy(function()\n\t\t\t{\n\t\t\t\tif (this.opts.fullpage)\n\t\t\t\t{\n\t\t\t\t\tthis.iframePage();\n\n\t\t\t\t\tif (this.content === '') this.content = this.opts.invisibleSpace;\n\n\t\t\t\t\tthis.$frame.contents()[0].write(this.content);\n\t\t\t\t\tthis.$frame.contents()[0].close();\n\n\t\t\t\t\tvar timer = setInterval($.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tif (this.$frame.contents().find('body').html())\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tclearInterval(timer);\n\t\t\t\t\t\t\tthis.iframeLoad();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}, this), 0);\n\t\t\t\t}\n\t\t\t\telse this.iframeLoad();\n\n\t\t\t}, this));\n\t\t},\n\t\tiframeDoc: function()\n\t\t{\n\t\t\treturn this.$frame[0].contentWindow.document;\n\t\t},\n\t\tiframePage: function()\n\t\t{\n\t\t\tvar doc = this.iframeDoc();\n\t\t\tif (doc.documentElement) doc.removeChild(doc.documentElement);\n\n\t\t\treturn doc;\n\t\t},\n\t\tiframeAddCss: function(css)\n\t\t{\n\t\t\tcss = css || this.opts.css;\n\n\t\t\tif (this.isString(css))\n\t\t\t{\n\t\t\t\tthis.$frame.contents().find('head').append('<link rel=\"stylesheet\" href=\"' + css + '\" />');\n\t\t\t}\n\n\t\t\tif ($.isArray(css))\n\t\t\t{\n\t\t\t\t$.each(css, $.proxy(function(i, url)\n\t\t\t\t{\n\t\t\t\t\tthis.iframeAddCss(url);\n\n\t\t\t\t}, this));\n\t\t\t}\n\t\t},\n\t\tiframeLoad: function()\n\t\t{\n\t\t\tthis.$editor = this.$frame.contents().find('body').attr({ 'contenteditable': true, 'dir': this.opts.direction });\n\t\t\tif (this.$editor[0])\n\t\t\t{\n\t\t\t\tthis.document = this.$editor[0].ownerDocument;\n\t\t\t\tthis.window = this.document.defaultView || window;\n\t\t\t}\n\t\t\tthis.iframeAddCss();\n\n\t\t\tif (this.opts.fullpage)\n\t\t\t{\n\t\t\t\tthis.setFullpageOnInit(this.$source.val());\n\t\t\t}\n\t\t\telse this.set(this.content, true, false);\n\n\t\t\tthis.buildOptions();\n\t\t\tthis.buildAfter();\n\t\t},\n\t\tplaceholderInit: function()\n\t\t{\n\t\t\tif (this.opts.placeholder !== false)\n\t\t\t{\n\t\t\t\tthis.placeholderText = this.opts.placeholder;\n\t\t\t\tthis.opts.placeholder = true;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tif (typeof this.$element.attr('placeholder') == 'undefined' || this.$element.attr('placeholder') == '')\n\t\t\t\t{\n\t\t\t\t\tthis.opts.placeholder = false;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.placeholderText = this.$element.attr('placeholder');\n\t\t\t\t\tthis.opts.placeholder = true;\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\tplaceholderStart: function(html)\n\t\t{\n\t\t\tif (this.opts.placeholder === false)\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tif (this.isEmpty(html))\n\t\t\t{\n\t\t\t\tthis.opts.focus = false;\n\t\t\t\tthis.placeholderOnFocus();\n\t\t\t\tthis.placeholderOnBlur();\n\n\t\t\t\treturn this.placeholderGet();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.placeholderOnBlur();\n\t\t\t}\n\n\t\t\treturn false;\n\t\t},\n\t\tplaceholderOnFocus: function()\n\t\t{\n\t\t\tthis.$editor.on('focus.redactor_placeholder', $.proxy(this.placeholderFocus, this));\n\t\t},\n\t\tplaceholderOnBlur: function()\n\t\t{\n\t\t\tthis.$editor.on('blur.redactor_placeholder', $.proxy(this.placeholderBlur, this));\n\t\t},\n\t\tplaceholderGet: function()\n\t\t{\n\t\t\tvar ph = $('<span class=\"redactor_placeholder\">').data('redactor', 'verified')\n\t\t\t.attr('contenteditable', false).text(this.placeholderText);\n\n\t\t\tif (this.opts.linebreaks === false)\n\t\t\t{\n\t\t\t\treturn $('<p>').append(ph);\n\t\t\t}\n\t\t\telse return ph;\n\t\t},\n\t\tplaceholderBlur: function()\n\t\t{\n\t\t\tvar html = this.get();\n\t\t\tif (this.isEmpty(html))\n\t\t\t{\n\t\t\t\tthis.placeholderOnFocus();\n\t\t\t\tthis.$editor.html(this.placeholderGet());\n\t\t\t}\n\t\t},\n\t\tplaceholderFocus: function()\n\t\t{\n\t\t\tthis.$editor.find('span.redactor_placeholder').remove();\n\n\t\t\tvar html = '';\n\t\t\tif (this.opts.linebreaks === false)\n\t\t\t{\n\t\t\t\thtml = this.opts.emptyHtml;\n\t\t\t}\n\n\t\t\tthis.$editor.off('focus.redactor_placeholder');\n\t\t\tthis.$editor.html(html);\n\n\t\t\tif (this.opts.linebreaks === false)\n\t\t\t{\n\n\t\t\t\tthis.selectionStart(this.$editor.children()[0]);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.focus();\n\t\t\t}\n\n\t\t\tthis.sync();\n\t\t},\n\t\tplaceholderRemoveFromEditor: function()\n\t\t{\n\t\t\tthis.$editor.find('span.redactor_placeholder').remove();\n\t\t\tthis.$editor.off('focus.redactor_placeholder');\n\t\t},\n\t\tplaceholderRemoveFromCode: function(html)\n\t\t{\n\t\t\treturn html.replace(/<span class=\"redactor_placeholder\"(.*?)>(.*?)<\\/span>/i, '');\n\t\t},\n\t\tshortcuts: function(e, key)\n\t\t{\n\t\t\tif (!this.opts.shortcuts)\n\t\t\t{\n\t\t\t\tif ((e.ctrlKey || e.metaKey) && (key === 66 || key === 73))\n\t\t\t\t{\n\t\t\t\t\te.preventDefault();\n\t\t\t\t}\n\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t$.each(this.opts.shortcuts, $.proxy(function(str, command)\n\t\t\t{\n\t\t\t\tvar keys = str.split(',');\n\t\t\t\tfor (var i in keys)\n\t\t\t\t{\n\t\t\t\t\tif (typeof keys[i] === 'string')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.shortcutsHandler(e, $.trim(keys[i]), $.proxy(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\teval(command);\n\t\t\t\t\t\t}, this));\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t}, this));\n\t\t},\n\t\tshortcutsHandler: function(e, keys, origHandler)\n\t\t{\n\n\t\t\tvar hotkeysSpecialKeys =\n\t\t\t{\n\t\t\t\t8: \"backspace\", 9: \"tab\", 10: \"return\", 13: \"return\", 16: \"shift\", 17: \"ctrl\", 18: \"alt\", 19: \"pause\",\n\t\t\t\t20: \"capslock\", 27: \"esc\", 32: \"space\", 33: \"pageup\", 34: \"pagedown\", 35: \"end\", 36: \"home\",\n\t\t\t\t37: \"left\", 38: \"up\", 39: \"right\", 40: \"down\", 45: \"insert\", 46: \"del\", 59: \";\", 61: \"=\",\n\t\t\t\t96: \"0\", 97: \"1\", 98: \"2\", 99: \"3\", 100: \"4\", 101: \"5\", 102: \"6\", 103: \"7\",\n\t\t\t\t104: \"8\", 105: \"9\", 106: \"*\", 107: \"+\", 109: \"-\", 110: \".\", 111 : \"/\",\n\t\t\t\t112: \"f1\", 113: \"f2\", 114: \"f3\", 115: \"f4\", 116: \"f5\", 117: \"f6\", 118: \"f7\", 119: \"f8\",\n\t\t\t\t120: \"f9\", 121: \"f10\", 122: \"f11\", 123: \"f12\", 144: \"numlock\", 145: \"scroll\", 173: \"-\", 186: \";\", 187: \"=\",\n\t\t\t\t188: \",\", 189: \"-\", 190: \".\", 191: \"/\", 192: \"`\", 219: \"[\", 220: \"\\\\\", 221: \"]\", 222: \"'\"\n\t\t\t};\n\t\t\tvar hotkeysShiftNums =\n\t\t\t{\n\t\t\t\t\"`\": \"~\", \"1\": \"!\", \"2\": \"@\", \"3\": \"#\", \"4\": \"$\", \"5\": \"%\", \"6\": \"^\", \"7\": \"&\",\n\t\t\t\t\"8\": \"*\", \"9\": \"(\", \"0\": \")\", \"-\": \"_\", \"=\": \"+\", \";\": \": \", \"'\": \"\\\"\", \",\": \"<\",\n\t\t\t\t\".\": \">\",  \"/\": \"?\",  \"\\\\\": \"|\"\n\t\t\t};\n\n\t\t\tkeys = keys.toLowerCase().split(\" \");\n\t\t\tvar special = hotkeysSpecialKeys[e.keyCode],\n\t\t\t\tcharacter = String.fromCharCode( e.which ).toLowerCase(),\n\t\t\t\tmodif = \"\", possible = {};\n\n\t\t\t$.each([ \"alt\", \"ctrl\", \"meta\", \"shift\"], function(index, specialKey)\n\t\t\t{\n\t\t\t\tif (e[specialKey + 'Key'] && special !== specialKey)\n\t\t\t\t{\n\t\t\t\t\tmodif += specialKey + '+';\n\t\t\t\t}\n\t\t\t});\n\t\t\tif (special)\n\t\t\t{\n\t\t\t\tpossible[modif + special] = true;\n\t\t\t}\n\n\t\t\tif (character)\n\t\t\t{\n\t\t\t\tpossible[modif + character] = true;\n\t\t\t\tpossible[modif + hotkeysShiftNums[character]] = true;\n\n\t\t\t\tif (modif === \"shift+\")\n\t\t\t\t{\n\t\t\t\t\tpossible[hotkeysShiftNums[character]] = true;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfor (var i = 0, l = keys.length; i < l; i++)\n\t\t\t{\n\t\t\t\tif (possible[keys[i]])\n\t\t\t\t{\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\treturn origHandler.apply(this, arguments);\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\tfocus: function()\n\t\t{\n\t\t\tif (!this.browser('opera'))\n\t\t\t{\n\t\t\t\tthis.window.setTimeout($.proxy(this.focusSet, this, true), 1);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.$editor.focus();\n\t\t\t}\n\t\t},\n\t\tfocusWithSaveScroll: function()\n\t\t{\n\t\t\tif (this.browser('msie'))\n\t\t\t{\n\t\t\t\tvar top = this.document.documentElement.scrollTop;\n\t\t\t}\n\n\t\t\tthis.$editor.focus();\n\n\t\t\tif (this.browser('msie'))\n\t\t\t{\n\t\t\t\tthis.document.documentElement.scrollTop = top;\n\t\t\t}\n\t\t},\n\t\tfocusEnd: function()\n\t\t{\n\t\t\tif (!this.browser('mozilla'))\n\t\t\t{\n\t\t\t\tthis.focusSet();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tif (this.opts.linebreaks === false)\n\t\t\t\t{\n\t\t\t\t\tvar last = this.$editor.children().last();\n\n\t\t\t\t\tthis.$editor.focus();\n\t\t\t\t\tthis.selectionEnd(last);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.focusSet();\n\t\t\t\t}\n\t\t\t}\n       \t},\n\t\tfocusSet: function(collapse, element)\n\t\t{\n\t\t\tthis.$editor.focus();\n\n\t\t\tif (typeof element == 'undefined')\n\t\t\t{\n\t\t\t\telement = this.$editor[0];\n\t\t\t}\n\n\t\t\tvar range = this.getRange();\n\t\t\trange.selectNodeContents(element);\n\t\t\trange.collapse(collapse || false);\n\n\t\t\tvar sel = this.getSelection();\n\t\t\tsel.removeAllRanges();\n\t\t\tsel.addRange(range);\n\t\t},\n\t\ttoggle: function(direct)\n\t\t{\n\t\t\tif (this.opts.visual) this.toggleCode(direct);\n\t\t\telse this.toggleVisual();\n\t\t},\n\t\ttoggleVisual: function()\n\t\t{\n\t\t\tvar html = this.$source.hide().val();\n\t\t\tif (typeof this.modified !== 'undefined')\n\t\t\t{\n\t\t\t\tvar modified = this.modified.replace(/\\n/g, '');\n\n\t\t\t\tvar thtml = html.replace(/\\n/g, '');\n\t\t\t\tthtml = this.cleanRemoveSpaces(thtml, false);\n\n\t\t\t\tthis.modified = this.cleanRemoveSpaces(modified, false) !== thtml;\n\t\t\t}\n\n\t\t\tif (this.modified)\n\t\t\t{\n\n\t\t\t\tif (this.opts.fullpage && html === '')\n\t\t\t\t{\n\t\t\t\t\tthis.setFullpageOnInit(html);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.set(html);\n\t\t\t\t\tif (this.opts.fullpage)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.buildBindKeyboard();\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tthis.callback('change', false, html);\n\t\t\t}\n\n\t\t\tif (this.opts.iframe) this.$frame.show();\n\t\t\telse this.$editor.show();\n\n\t\t\tif (this.opts.fullpage) this.$editor.attr('contenteditable', true );\n\n\t\t\tthis.$source.off('keydown.redactor-textarea-indenting');\n\n\t\t\tthis.$editor.focus();\n\t\t\tthis.selectionRestore();\n\n\t\t\tthis.observeStart();\n\t\t\tthis.buttonActiveVisual();\n\t\t\tthis.buttonInactive('html');\n\t\t\tthis.opts.visual = true;\n\t\t},\n\t\ttoggleCode: function(direct)\n\t\t{\n\t\t\tif (direct !== false) this.selectionSave();\n\n\t\t\tvar height = null;\n\t\t\tif (this.opts.iframe)\n\t\t\t{\n\t\t\t\theight = this.$frame.height();\n\t\t\t\tif (this.opts.fullpage) this.$editor.removeAttr('contenteditable');\n\t\t\t\tthis.$frame.hide();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\theight = this.$editor.innerHeight();\n\t\t\t\tthis.$editor.hide();\n\t\t\t}\n\n\t\t\tvar html = this.$source.val();\n\t\t\tif (html !== '' && this.opts.tidyHtml)\n\t\t\t{\n\t\t\t\tthis.$source.val(this.cleanHtml(html));\n\t\t\t}\n\n\t\t\tthis.modified = html;\n\n\t\t\tthis.$source.height(height).show().focus();\n\t\t\tthis.$source.on('keydown.redactor-textarea-indenting', this.textareaIndenting);\n\n\t\t\tthis.buttonInactiveVisual();\n\t\t\tthis.buttonActive('html');\n\t\t\tthis.opts.visual = false;\n\t\t},\n\t\ttextareaIndenting: function(e)\n\t\t{\n\t\t\tif (e.keyCode === 9)\n\t\t\t{\n\t\t\t\tvar $el = $(this);\n\t\t\t\tvar start = $el.get(0).selectionStart;\n\t\t\t\t$el.val($el.val().substring(0, start) + \"\\t\" + $el.val().substring($el.get(0).selectionEnd));\n\t\t\t\t$el.get(0).selectionStart = $el.get(0).selectionEnd = start + 1;\n\t\t\t\treturn false;\n\t\t\t}\n\t\t},\n\t\tautosave: function()\n\t\t{\n\t\t\tvar savedHtml = false;\n\t\t\tthis.autosaveInterval = setInterval($.proxy(function()\n\t\t\t{\n\t\t\t\tvar html = this.get();\n\t\t\t\tif (savedHtml !== html)\n\t\t\t\t{\n\t\t\t\t\tvar name = this.$source.attr('name');\n\t\t\t\t\t$.ajax({\n\t\t\t\t\t\turl: this.opts.autosave,\n\t\t\t\t\t\ttype: 'post',\n\t\t\t\t\t\tdata: 'name=' + name + '&' + name + '=' + escape(encodeURIComponent(html)),\n\t\t\t\t\t\tsuccess: $.proxy(function(data)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar json = $.parseJSON(data);\n\t\t\t\t\t\t\tif (typeof json.error == 'undefined')\n\t\t\t\t\t\t\t{\n\n\t\t\t\t\t\t\t\tthis.callback('autosave', false, json);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\n\t\t\t\t\t\t\t\tthis.callback('autosaveError', false, json);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tsavedHtml = html;\n\n\t\t\t\t\t\t}, this)\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}, this), this.opts.autosaveInterval*1000);\n\t\t},\n\t\ttoolbarBuild: function()\n\t\t{\n\n\t\t\tif (this.isMobile() && this.opts.buttonsHideOnMobile.length > 0)\n\t\t\t{\n\t\t\t\t$.each(this.opts.buttonsHideOnMobile, $.proxy(function(i, s)\n\t\t\t\t{\n\t\t\t\t\tvar index = this.opts.buttons.indexOf(s);\n\t\t\t\t\tthis.opts.buttons.splice(index, 1);\n\n\t\t\t\t}, this));\n\t\t\t}\n\t\t\tif (this.opts.air)\n\t\t\t{\n\t\t\t\tthis.opts.buttons = this.opts.airButtons;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tif (!this.opts.buttonSource)\n\t\t\t\t{\n\t\t\t\t\tvar index = this.opts.buttons.indexOf('html');\n\t\t\t\t\tthis.opts.buttons.splice(index, 1);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (this.opts.toolbar)\n\t\t\t{\n\t\t\t\t$.each(this.opts.toolbar.formatting.dropdown, $.proxy(function (i, s)\n\t\t\t\t{\n\t\t\t\t\tif ($.inArray(i, this.opts.formattingTags ) == '-1') delete this.opts.toolbar.formatting.dropdown[i];\n\n\t\t\t\t}, this));\n\t\t\t}\n\t\t\tif (this.opts.buttons.length === 0) return false;\n\t\t\tthis.airEnable();\n\t\t\tthis.$toolbar = $('<ul>').addClass('redactor_toolbar').attr('id', 'redactor_toolbar_' + this.uuid);\n\n\t\t\tif (this.opts.typewriter)\n\t\t\t{\n\t\t\t\tthis.$toolbar.addClass('redactor-toolbar-typewriter');\n\t\t\t}\n\n\t\t\tif (this.opts.toolbarOverflow && this.isMobile())\n\t\t\t{\n\t\t\t\tthis.$toolbar.addClass('redactor-toolbar-overflow');\n\t\t\t}\n\n\t\t\tif (this.opts.air)\n\t\t\t{\n\n\t\t\t\tthis.$air = $('<div class=\"redactor_air\">').attr('id', 'redactor_air_' + this.uuid).hide();\n\t\t\t\tthis.$air.append(this.$toolbar);\n\t\t\t\t$('body').append(this.$air);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tif (this.opts.toolbarExternal)\n\t\t\t\t{\n\t\t\t\t\tthis.$toolbar.addClass('redactor-toolbar-external');\n\t\t\t\t\t$(this.opts.toolbarExternal).html(this.$toolbar);\n\t\t\t\t}\n\t\t\t\telse this.$box.prepend(this.$toolbar);\n\t\t\t}\n\n\t\t\t$.each(this.opts.buttons, $.proxy(function(i, btnName)\n\t\t\t{\n\t\t\t\tif (this.opts.toolbar[btnName])\n\t\t\t\t{\n\t\t\t\t\tvar btnObject = this.opts.toolbar[btnName];\n\t\t\t\t\tif (this.opts.fileUpload === false && btnName === 'file') return true;\n\t\t\t\t\tthis.$toolbar.append( $('<li>').append(this.buttonBuild(btnName, btnObject)));\n\t\t\t\t}\n\n\t\t\t}, this));\n\n\t\t\tthis.$toolbar.find('a').attr('tabindex', '-1');\n\t\t\tif (this.opts.toolbarFixed)\n\t\t\t{\n\t\t\t\tthis.toolbarObserveScroll();\n\t\t\t\t$(this.opts.toolbarFixedTarget).on('scroll.redactor', $.proxy(this.toolbarObserveScroll, this));\n\t\t\t}\n\t\t\tif (this.opts.activeButtons)\n\t\t\t{\n\t\t\t\tthis.$editor.on('mouseup.redactor keyup.redactor', $.proxy(this.buttonActiveObserver, this));\n\t\t\t}\n\t\t},\n\t\ttoolbarObserveScroll: function()\n\t\t{\n\t\t\tvar scrollTop = $(this.opts.toolbarFixedTarget).scrollTop();\n\n\t\t\tvar boxTop = 0;\n\t\t\tvar left = 0;\n\t\t\tvar end = 0;\n\n\t\t\tif (this.opts.toolbarFixedTarget === document)\n\t\t\t{\n\t\t\t\tboxTop = this.$box.offset().top;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tboxTop = 1;\n\t\t\t}\n\n\t\t\tend = boxTop + this.$box.height() + 40;\n\n\t\t\tif (scrollTop > boxTop)\n\t\t\t{\n\t\t\t\tvar width = '100%';\n\t\t\t\tif (this.opts.toolbarFixedBox)\n\t\t\t\t{\n\t\t\t\t\tleft = this.$box.offset().left;\n\t\t\t\t\twidth = this.$box.innerWidth();\n\t\t\t\t\tthis.$toolbar.addClass('toolbar_fixed_box');\n\t\t\t\t}\n\n\t\t\t\tthis.toolbarFixed = true;\n\n\t\t\t\tif (this.opts.toolbarFixedTarget === document)\n\t\t\t\t{\n\t\t\t\t\tthis.$toolbar.css({\n\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\twidth: width,\n\t\t\t\t\t\tzIndex: 10005,\n\t\t\t\t\t\ttop: this.opts.toolbarFixedTopOffset + 'px',\n\t\t\t\t\t\tleft: left\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.$toolbar.css({\n\t\t\t\t\t\tposition: 'absolute',\n\t\t\t\t\t\twidth: width,\n\t\t\t\t\t\tzIndex: 10005,\n\t\t\t\t\t\ttop: (this.opts.toolbarFixedTopOffset + scrollTop) + 'px',\n\t\t\t\t\t\tleft: 0\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tif (scrollTop < end) this.$toolbar.css('visibility', 'visible');\n\t\t\t\telse this.$toolbar.css('visibility', 'hidden');\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.toolbarFixed = false;\n\t\t\t\tthis.$toolbar.css({\n\t\t\t\t\tposition: 'relative',\n\t\t\t\t\twidth: 'auto',\n\t\t\t\t\ttop: 0,\n\t\t\t\t\tleft: left\n\t\t\t\t});\n\n\t\t\t\tif (this.opts.toolbarFixedBox) this.$toolbar.removeClass('toolbar_fixed_box');\n\t\t\t}\n\t\t},\n\t\tairEnable: function()\n\t\t{\n\t\t\tif (!this.opts.air) return;\n\n\t\t\tthis.$editor.on('mouseup.redactor keyup.redactor', this, $.proxy(function(e)\n\t\t\t{\n\t\t\t\tvar text = this.getSelectionText();\n\n\t\t\t\tif (e.type === 'mouseup' && text != '') this.airShow(e);\n\t\t\t\tif (e.type === 'keyup' && e.shiftKey && text != '')\n\t\t\t\t{\n\t\t\t\t\tvar $focusElem = $(this.getElement(this.getSelection().focusNode)), offset = $focusElem.offset();\n\t\t\t\t\toffset.height = $focusElem.height();\n\t\t\t\t\tthis.airShow(offset, true);\n\t\t\t\t}\n\n\t\t\t}, this));\n\t\t},\n\t\tairShow: function (e, keyboard)\n\t\t{\n\t\t\tif (!this.opts.air) return;\n\n\t\t\tthis.selectionSave();\n\n\t\t\tvar left, top;\n\t\t\t$('.redactor_air').hide();\n\n\t\t\tif (keyboard)\n\t\t\t{\n\t\t\t\tleft = e.left;\n\t\t\t\ttop = e.top + e.height + 14;\n\n\t\t\t\tif (this.opts.iframe)\n\t\t\t\t{\n\t\t\t\t\ttop += this.$box.position().top - $(this.document).scrollTop();\n\t\t\t\t\tleft += this.$box.position().left;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tvar width = this.$air.innerWidth();\n\n\t\t\t\tleft = e.clientX;\n\t\t\t\tif ($(this.document).width() < (left + width)) left -= width;\n\n\t\t\t\ttop = e.clientY + 14;\n\t\t\t\tif (this.opts.iframe)\n\t\t\t\t{\n\t\t\t\t\ttop += this.$box.position().top;\n\t\t\t\t\tleft += this.$box.position().left;\n\t\t\t\t}\n\t\t\t\telse top += $( this.document ).scrollTop();\n\t\t\t}\n\n\t\t\tthis.$air.css({\n\t\t\t\tleft: left + 'px',\n\t\t\t\ttop: top + 'px'\n\t\t\t}).show();\n\n\t\t\tthis.airBindHide();\n\t\t},\n\t\tairBindHide: function()\n\t\t{\n\t\t\tif (!this.opts.air) return;\n\n\t\t\tvar hideHandler = $.proxy(function(doc)\n\t\t\t{\n\t\t\t\t$(doc).on('mousedown.redactor', $.proxy(function(e)\n\t\t\t\t{\n\t\t\t\t\tif ($( e.target ).closest(this.$toolbar).length === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.$air.fadeOut(100);\n\t\t\t\t\t\tthis.selectionRemove();\n\t\t\t\t\t\t$(doc).off(e);\n\t\t\t\t\t}\n\n\t\t\t\t}, this)).on('keydown.redactor', $.proxy(function(e)\n\t\t\t\t{\n\t\t\t\t\tif (e.which === this.keyCode.ESC)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.getSelection().collapseToStart();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.$air.fadeOut(100);\n\t\t\t\t\t$(doc).off(e);\n\n\t\t\t\t}, this));\n\t\t\t}, this);\n\t\t\thideHandler(document);\n\t\t\tif (this.opts.iframe) hideHandler(this.document);\n\t\t},\n\t\tairBindMousemoveHide: function()\n\t\t{\n\t\t\tif (!this.opts.air) return;\n\n\t\t\tvar hideHandler = $.proxy(function(doc)\n\t\t\t{\n\t\t\t\t$(doc).on('mousemove.redactor', $.proxy(function(e)\n\t\t\t\t{\n\t\t\t\t\tif ($( e.target ).closest(this.$toolbar).length === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.$air.fadeOut(100);\n\t\t\t\t\t\t$(doc).off(e);\n\t\t\t\t\t}\n\n\t\t\t\t}, this));\n\t\t\t}, this);\n\t\t\thideHandler(document);\n\t\t\tif (this.opts.iframe) hideHandler(this.document);\n\t\t},\n\t\tdropdownBuild: function($dropdown, dropdownObject)\n\t\t{\n\t\t\t$.each(dropdownObject, $.proxy(function(btnName, btnObject)\n\t\t\t{\n\t\t\t\tif (!btnObject.className) btnObject.className = '';\n\n\t\t\t\tvar $item;\n\t\t\t\tif (btnObject.name === 'separator') $item = $('<a class=\"redactor_separator_drop\">');\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$item = $('<a href=\"#\" class=\"' + btnObject.className + ' redactor_dropdown_' + btnName + '\">' + btnObject.title + '</a>');\n\t\t\t\t\t$item.on('click', $.proxy(function(e)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (this.opts.air)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.selectionRestore();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (e.preventDefault) e.preventDefault();\n\t\t\t\t\t\tif (this.browser('msie')) e.returnValue = false;\n\n\t\t\t\t\t\tif (btnObject.callback) btnObject.callback.call(this, btnName, $item, btnObject, e);\n\t\t\t\t\t\tif (btnObject.exec) this.execCommand(btnObject.exec, btnName);\n\t\t\t\t\t\tif (btnObject.func) this[btnObject.func](btnName);\n\n\t\t\t\t\t\tthis.buttonActiveObserver();\n\t\t\t\t\t\tif (this.opts.air) this.$air.fadeOut(100);\n\t\t\t\t\t}, this));\n\t\t\t\t}\n\n\t\t\t\t$dropdown.append($item);\n\n\t\t\t}, this));\n\t\t},\n\t\tdropdownShow: function(e, key)\n\t\t{\n\t\t\tif (!this.opts.visual)\n\t\t\t{\n\t\t\t\te.preventDefault();\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tvar $button = this.buttonGet(key);\n\t\t\tvar $dropdown  = $button.data('dropdown').appendTo(document.body);\n\n\t\t\tif ($button.hasClass('dropact')) this.dropdownHideAll();\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.dropdownHideAll();\n\t\t\t\tthis.callback('dropdownShow', { dropdown: $dropdown, key: key, button: $button });\n\n\t\t\t\tthis.buttonActive(key);\n\t\t\t\t$button.addClass('dropact');\n\n\t\t\t\tvar keyPosition = $button.offset();\n\t\t\t\tvar dropdownWidth = $dropdown.width();\n\t\t\t\tif ((keyPosition.left + dropdownWidth) > $(document).width())\n\t\t\t\t{\n\t\t\t\t\tkeyPosition.left -= dropdownWidth;\n\t\t\t\t}\n\n\t\t\t\tvar left = keyPosition.left + 'px';\n\t\t\t\tvar btnHeight = $button.innerHeight();\n\n\t\t\t\tvar position = 'absolute';\n\t\t\t\tvar top = (btnHeight + this.opts.toolbarFixedTopOffset) + 'px';\n\n\t\t\t\tif (this.opts.toolbarFixed && this.toolbarFixed) position = 'fixed';\n\t\t\t\telse top = keyPosition.top + btnHeight + 'px';\n\n\t\t\t\t$dropdown.css({ position: position, left: left, top: top }).show();\n\t\t\t\tthis.callback('dropdownShown', { dropdown: $dropdown, key: key, button: $button });\n\t\t\t}\n\t\t\tvar hdlHideDropDown = $.proxy(function(e)\n\t\t\t{\n\t\t\t\tthis.dropdownHide(e, $dropdown);\n\n\t\t\t}, this);\n\n\t\t\t$(document).one('click', hdlHideDropDown);\n\t\t\tthis.$editor.one('click', hdlHideDropDown);\n\t\t\tthis.$editor.one('touchstart', hdlHideDropDown);\n\t\t\te.stopPropagation();\n\t\t\tthis.focusWithSaveScroll();\n\t\t},\n\t\tdropdownHideAll: function()\n\t\t{\n\t\t\tthis.$toolbar.find('a.dropact').removeClass('redactor_act').removeClass('dropact');\n\t\t\t$('.redactor_dropdown').hide();\n\t\t\tthis.callback('dropdownHide');\n\t\t},\n\t\tdropdownHide: function (e, $dropdown)\n\t\t{\n\t\t\tif (!$(e.target).hasClass('dropact'))\n\t\t\t{\n\t\t\t\t$dropdown.removeClass('dropact');\n\t\t\t\tthis.dropdownHideAll();\n\t\t\t}\n\t\t},\n\t\tbuttonBuild: function(btnName, btnObject, buttonImage)\n\t\t{\n\t\t\tvar $button = $('<a href=\"javascript:;\" title=\"' + btnObject.title + '\" tabindex=\"-1\" class=\"re-icon re-' + btnName + '\"></a>');\n\n\t\t\tif (typeof buttonImage != 'undefined')\n\t\t\t{\n\t\t\t\t$button.addClass('redactor-btn-image');\n\t\t\t}\n\n\t\t\t$button.on('click', $.proxy(function(e)\n\t\t\t{\n\t\t\t\tif (e.preventDefault) e.preventDefault();\n\t\t\t\tif (this.browser('msie')) e.returnValue = false;\n\n\t\t\t\tif ($button.hasClass('redactor_button_disabled')) return false;\n\n\t\t\t\tif (this.isFocused() === false && !btnObject.exec)\n\t\t\t\t{\n\t\t\t\t\tthis.focusWithSaveScroll();\n\t\t\t\t}\n\n\t\t\t\tif (btnObject.exec)\n\t\t\t\t{\n\t\t\t\t\tthis.focusWithSaveScroll();\n\n\t\t\t\t\tthis.execCommand(btnObject.exec, btnName);\n\t\t\t\t\tthis.airBindMousemoveHide();\n\n\t\t\t\t}\n\t\t\t\telse if (btnObject.func && btnObject.func !== 'show')\n\t\t\t\t{\n\t\t\t\t\tthis[btnObject.func](btnName);\n\t\t\t\t\tthis.airBindMousemoveHide();\n\n\t\t\t\t}\n\t\t\t\telse if (btnObject.callback)\n\t\t\t\t{\n\t\t\t\t\tbtnObject.callback.call(this, btnName, $button, btnObject, e);\n\t\t\t\t\tthis.airBindMousemoveHide();\n\n\t\t\t\t}\n\t\t\t\telse if (btnObject.dropdown)\n\t\t\t\t{\n\t\t\t\t\tthis.dropdownShow(e, btnName);\n\t\t\t\t}\n\n\t\t\t\tthis.buttonActiveObserver(false, btnName);\n\n\t\t\t}, this));\n\t\t\tif (btnObject.dropdown)\n\t\t\t{\n\t\t\t\tvar $dropdown = $('<div class=\"redactor_dropdown redactor_dropdown_box_' + btnName + '\" style=\"display: none;\">');\n\t\t\t\t$button.data('dropdown', $dropdown);\n\t\t\t\tthis.dropdownBuild($dropdown, btnObject.dropdown);\n\t\t\t}\n\n\t\t\treturn $button;\n\t\t},\n\t\tbuttonGet: function(key)\n\t\t{\n\t\t\tif (!this.opts.toolbar) return false;\n\t\t\treturn $(this.$toolbar.find('a.re-' + key));\n\t\t},\n\t\tbuttonTagToActiveState: function(buttonName, tagName)\n\t\t{\n\t\t\tthis.opts.activeButtons.push(buttonName);\n\t\t\tthis.opts.activeButtonsStates[tagName] = buttonName;\n\t\t},\n\t\tbuttonActiveToggle: function(key)\n\t\t{\n\t\t\tvar btn = this.buttonGet(key);\n\n\t\t\tif (btn.hasClass('redactor_act'))\n\t\t\t{\n\t\t\t\tthis.buttonInactive(key);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.buttonActive(key);\n\t\t\t}\n\t\t},\n\t\tbuttonActive: function(key)\n\t\t{\n\t\t\tvar btn = this.buttonGet(key);\n\t\t\tbtn.addClass('redactor_act');\n\t\t},\n\t\tbuttonInactive: function(key)\n\t\t{\n\t\t\tvar btn = this.buttonGet(key);\n\t\t\tbtn.removeClass('redactor_act');\n\t\t},\n\t\tbuttonInactiveAll: function(btnName)\n\t\t{\n\t\t\tthis.$toolbar.find('a.re-icon').not('.re-' + btnName).removeClass('redactor_act');\n\t\t},\n\t\tbuttonActiveVisual: function()\n\t\t{\n\t\t\tthis.$toolbar.find('a.re-icon').not('a.re-html').removeClass('redactor_button_disabled');\n\t\t},\n\t\tbuttonInactiveVisual: function()\n\t\t{\n\t\t\tthis.$toolbar.find('a.re-icon').not('a.re-html').addClass('redactor_button_disabled');\n\t\t},\n\t\tbuttonChangeIcon: function (key, classname)\n\t\t{\n\t\t\tthis.buttonGet(key).addClass('re-' + classname);\n\t\t},\n\t\tbuttonRemoveIcon: function(key, classname)\n\t\t{\n\t\t\tthis.buttonGet(key).removeClass('re-' + classname);\n\t\t},\n\t\tbuttonAwesome: function(key, name)\n\t\t{\n\t\t\tvar button = this.buttonGet(key);\n\t\t\tbutton.removeClass('redactor-btn-image');\n\t\t\tbutton.addClass('fa-redactor-btn');\n\t\t\tbutton.html('<i class=\"fa ' + name + '\"></i>');\n\t\t},\n\t\tbuttonAdd: function(key, title, callback, dropdown)\n\t\t{\n\t\t\tif (!this.opts.toolbar) return;\n\t\t\tvar btn = this.buttonBuild(key, { title: title, callback: callback, dropdown: dropdown }, true);\n\n\t\t\tthis.$toolbar.append($('<li>').append(btn));\n\n\t\t\treturn btn;\n\t\t},\n\t\tbuttonAddFirst: function(key, title, callback, dropdown)\n\t\t{\n\t\t\tif (!this.opts.toolbar) return;\n\t\t\tvar btn = this.buttonBuild(key, { title: title, callback: callback, dropdown: dropdown }, true);\n\t\t\tthis.$toolbar.prepend($('<li>').append(btn));\n\t\t},\n\t\tbuttonAddAfter: function(afterkey, key, title, callback, dropdown)\n\t\t{\n\t\t\tif (!this.opts.toolbar) return;\n\t\t\tvar btn = this.buttonBuild(key, { title: title, callback: callback, dropdown: dropdown }, true);\n\t\t\tvar $btn = this.buttonGet(afterkey);\n\n\t\t\tif ($btn.length !== 0) $btn.parent().after($('<li>').append(btn));\n\t\t\telse this.$toolbar.append($('<li>').append(btn));\n\n\t\t\treturn btn;\n\t\t},\n\t\tbuttonAddBefore: function(beforekey, key, title, callback, dropdown)\n\t\t{\n\t\t\tif (!this.opts.toolbar) return;\n\t\t\tvar btn = this.buttonBuild(key, { title: title, callback: callback, dropdown: dropdown }, true);\n\t\t\tvar $btn = this.buttonGet(beforekey);\n\n\t\t\tif ($btn.length !== 0) $btn.parent().before($('<li>').append(btn));\n\t\t\telse this.$toolbar.append($('<li>').append(btn));\n\n\t\t\treturn btn;\n\t\t},\n\t\tbuttonRemove: function (key)\n\t\t{\n\t\t\tvar $btn = this.buttonGet(key);\n\t\t\t$btn.remove();\n\t\t},\n\t\tbuttonActiveObserver: function(e, btnName)\n\t\t{\n\t\t\tvar parent = this.getParent();\n\t\t\tthis.buttonInactiveAll(btnName);\n\n\t\t\tif (e === false && btnName !== 'html')\n\t\t\t{\n\t\t\t\tif ($.inArray(btnName, this.opts.activeButtons) != -1)\n\t\t\t\t{\n\t\t\t\t\tthis.buttonActiveToggle(btnName);\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (parent && parent.tagName === 'A') this.$toolbar.find('a.redactor_dropdown_link').text(this.opts.curLang.link_edit);\n\t\t\telse this.$toolbar.find('a.redactor_dropdown_link').text(this.opts.curLang.link_insert);\n\n\t\t\t$.each(this.opts.activeButtonsStates, $.proxy(function(key, value)\n\t\t\t{\n\t\t\t\tif ($(parent).closest(key, this.$editor.get()[0]).length != 0)\n\t\t\t\t{\n\t\t\t\t\tthis.buttonActive(value);\n\t\t\t\t}\n\n\t\t\t}, this));\n\n\t\t\tvar $parent = $(parent).closest(this.opts.alignmentTags.toString().toLowerCase(), this.$editor[0]);\n\t\t\tif ($parent.length)\n\t\t\t{\n\t\t\t\tvar align = $parent.css('text-align');\n\t\t\t\tif (align == '')\n\t\t\t\t{\n\t\t\t\t\talign = 'left';\n\t\t\t\t}\n\n\t\t\t\tthis.buttonActive('align' + align);\n\t\t\t}\n\t\t},\n\t\texecPasteFrag: function(html)\n\t\t{\n\t\t\tvar sel = this.getSelection();\n\t\t\tif (sel.getRangeAt && sel.rangeCount)\n\t\t\t{\n\t\t\t\tvar range = this.getRange();\n\t\t\t\trange.deleteContents();\n\n\t\t\t\tvar el = this.document.createElement(\"div\");\n\t\t\t\tel.innerHTML = html;\n\n\t\t\t\tvar frag = this.document.createDocumentFragment(), node, lastNode;\n\t\t\t\twhile ((node = el.firstChild))\n\t\t\t\t{\n\t\t\t\t\tlastNode = frag.appendChild(node);\n\t\t\t\t}\n\n\t\t\t\tvar firstNode = frag.firstChild;\n\t\t\t\trange.insertNode(frag);\n\n\t\t\t\tif (lastNode)\n\t\t\t\t{\n\t\t\t\t\trange = range.cloneRange();\n\t\t\t\t\trange.setStartAfter(lastNode);\n\t\t\t\t\trange.collapse(true);\n\t\t\t\t}\n\t\t\t\tsel.removeAllRanges();\n\t\t\t\tsel.addRange(range);\n\t\t\t}\n\t\t},\n\t\texec: function(cmd, param, sync)\n\t\t{\n\t\t\tif (cmd === 'formatblock' && this.browser('msie'))\n\t\t\t{\n\t\t\t\tparam = '<' + param + '>';\n\t\t\t}\n\n\t\t\tif (cmd === 'inserthtml' && this.browser('msie'))\n\t\t\t{\n\t\t\t\tif (!this.isIe11())\n\t\t\t\t{\n\t\t\t\t\tthis.focusWithSaveScroll();\n\t\t\t\t\tthis.document.selection.createRange().pasteHTML(param);\n\t\t\t\t}\n\t\t\t\telse this.execPasteFrag(param);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.document.execCommand(cmd, false, param);\n\t\t\t}\n\n\t\t\tif (sync !== false) this.sync();\n\t\t\tthis.callback('execCommand', cmd, param);\n\t\t},\n\t\texecCommand: function(cmd, param, sync)\n\t\t{\n\t\t\tif (!this.opts.visual)\n\t\t\t{\n\t\t\t\tthis.$source.focus();\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tif (   cmd === 'bold'\n\t\t\t\t|| cmd === 'italic'\n\t\t\t\t|| cmd === 'underline'\n\t\t\t\t|| cmd === 'strikethrough')\n\t\t\t{\n\t\t\t\tthis.bufferSet();\n\t\t\t}\n\t\t\tif (cmd === 'superscript' || cmd === 'subscript')\n\t\t\t{\n\t\t\t\tvar parent = this.getParent();\n\t\t\t\tif (parent.tagName === 'SUP' || parent.tagName === 'SUB')\n\t\t\t\t{\n\t\t\t\t\tthis.inlineRemoveFormatReplace(parent);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (cmd === 'inserthtml')\n\t\t\t{\n\t\t\t\tthis.insertHtml(param, sync);\n\t\t\t\tthis.callback('execCommand', cmd, param);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (this.currentOrParentIs('CODE') && !this.opts.formattingPre) return false;\n\t\t\tif (cmd === 'insertunorderedlist' || cmd === 'insertorderedlist') return this.execLists(cmd, param);\n\t\t\tif (cmd === 'unlink') return this.execUnlink(cmd, param);\n\t\t\tthis.exec(cmd, param, sync);\n\t\t\tif (cmd === 'inserthorizontalrule') this.$editor.find('hr').removeAttr('id');\n\n\t\t},\n\t\texecUnlink: function(cmd, param)\n\t\t{\n\t\t\tthis.bufferSet();\n\n\t\t\tvar link = this.currentOrParentIs('A');\n\t\t\tif (link)\n\t\t\t{\n\t\t\t\t$(link).replaceWith($(link).text());\n\n\t\t\t\tthis.sync();\n\t\t\t\tthis.callback('execCommand', cmd, param);\n\t\t\t\treturn;\n\t\t\t}\n\t\t},\n\t\texecLists: function(cmd, param)\n\t\t{\n\t\t\tthis.bufferSet();\n\n\t\t\tvar parent = this.getParent();\n\t\t\tvar $list = $(parent).closest('ol, ul');\n\n\t\t\tif (!this.isParentRedactor($list) && $list.length != 0)\n\t\t\t{\n\t\t\t\t$list = false;\n\t\t\t}\n\n\t\t\tvar remove = false;\n\n\t\t\tif ($list && $list.length)\n\t\t\t{\n\t\t\t\tremove = true;\n\t\t\t\tvar listTag = $list[0].tagName;\n\t\t\t \tif ((cmd === 'insertunorderedlist' && listTag === 'OL')\n\t\t\t \t|| (cmd === 'insertorderedlist' && listTag === 'UL'))\n\t\t\t \t{\n\t\t\t\t \tremove = false;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.selectionSave();\n\t\t\tif (remove)\n\t\t\t{\n\n\t\t\t\tvar nodes = this.getNodes();\n\t\t\t\tvar elems = this.getBlocks(nodes);\n\n\t\t\t\tif (typeof nodes[0] != 'undefined' && nodes.length > 1 && nodes[0].nodeType == 3)\n\t\t\t\t{\n\n\t\t\t\t\telems.unshift(this.getBlock());\n\t\t\t\t}\n\n\t\t\t\tvar data = '', replaced = '';\n\t\t\t\t$.each(elems, $.proxy(function(i,s)\n\t\t\t\t{\n\t\t\t\t\tif (s.tagName == 'LI')\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $s = $(s);\n\t\t\t\t\t\tvar cloned = $s.clone();\n\t\t\t\t\t\tcloned.find('ul', 'ol').remove();\n\n\t\t\t\t\t\tif (this.opts.linebreaks === false)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tdata += this.outerHtml($('<p>').append(cloned.contents()));\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar clonedHtml = cloned.html().replace(/<br\\s?\\/?>$/i, '');\n\t\t\t\t\t\t\tdata += clonedHtml + '<br>';\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (i == 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$s.addClass('redactor-replaced').empty();\n\t\t\t\t\t\t\treplaced = this.outerHtml($s);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse $s.remove();\n\t\t\t\t\t}\n\n\t\t\t\t}, this));\n\t\t\t\thtml = this.$editor.html().replace(replaced, '</' + listTag + '>' + data + '<' + listTag + '>');\n\n\t\t\t\tthis.$editor.html(html);\n\t\t\t\tthis.$editor.find(listTag + ':empty').remove();\n\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tvar firstParent = $(this.getParent()).closest('td');\n\n\t\t\t\tif (this.browser('msie') && !this.isIe11() && this.opts.linebreaks)\n\t\t\t\t{\n\t\t\t\t\tvar wrapper = this.selectionWrap('div');\n\t\t\t\t\tvar wrapperHtml = $(wrapper).html();\n\t\t\t\t\tvar tmpList = $('<ul>');\n\t\t\t\t\tif (cmd == 'insertorderedlist')\n\t\t\t\t\t{\n\t\t\t\t\t\ttmpList = $('<ol>');\n\t\t\t\t\t}\n\n\t\t\t\t\tvar tmpLi = $('<li>');\n\n\t\t\t\t\tif ($.trim(wrapperHtml) == '')\n\t\t\t\t\t{\n\t\t\t\t\t\ttmpLi.append(wrapperHtml + '<span id=\"selection-marker-1\">' + this.opts.invisibleSpace + '</span>');\n\t\t\t\t\t\ttmpList.append(tmpLi);\n\t\t\t\t\t\tthis.$editor.find('#selection-marker-1').replaceWith(tmpList);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\ttmpLi.append(wrapperHtml);\n\t\t\t\t\t\ttmpList.append(tmpLi);\n\t\t\t\t\t\t$(wrapper).replaceWith(tmpList);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.document.execCommand(cmd);\n\t\t\t\t}\n\n\t\t\t\tvar parent = this.getParent();\n\t\t\t\tvar $list = $(parent).closest('ol, ul');\n\n\t\t\t\tif (this.opts.linebreaks === false)\n\t\t\t\t{\n\t\t\t\t\tvar listText = $.trim($list.text());\n\t\t\t\t\tif (listText == '')\n\t\t\t\t\t{\n\t\t\t\t\t\t$list.children('li').find('br').remove();\n\t\t\t\t\t\t$list.children('li').append('<span id=\"selection-marker-1\">' + this.opts.invisibleSpace + '</span>');\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (firstParent.length != 0)\n\t\t\t\t{\n\t\t\t\t\t$list.wrapAll('<td>');\n\t\t\t\t}\n\n\t\t\t\tif ($list.length)\n\t\t\t\t{\n\n\t\t\t\t\tvar $listParent = $list.parent();\n\t\t\t\t\tif (this.isParentRedactor($listParent) && $listParent[0].tagName != 'LI' && this.nodeTestBlocks($listParent[0]))\n\t\t\t\t\t{\n\t\t\t\t\t\t$listParent.replaceWith($listParent.contents());\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (this.browser('mozilla'))\n\t\t\t\t{\n\t\t\t\t\tthis.$editor.focus();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.selectionRestore();\n\t\t\tthis.$editor.find('#selection-marker-1').removeAttr('id');\n\t\t\tthis.sync();\n\t\t\tthis.callback('execCommand', cmd, param);\n\t\t\treturn;\n\t\t},\n\t\tindentingIndent: function()\n\t\t{\n\t\t\tthis.indentingStart('indent');\n\t\t},\n\t\tindentingOutdent: function()\n\t\t{\n\t\t\tthis.indentingStart('outdent');\n\t\t},\n\t\tindentingStart: function(cmd)\n\t\t{\n\t\t\tthis.bufferSet();\n\n\t\t\tif (cmd === 'indent')\n\t\t\t{\n\t\t\t\tvar block = this.getBlock();\n\n\t\t\t\tthis.selectionSave();\n\n\t\t\t\tif (block && block.tagName == 'LI')\n\t\t\t\t{\n\n\t\t\t\t\tvar parent = this.getParent();\n\n\t\t\t\t\tvar $list = $(parent).closest('ol, ul');\n\t\t\t\t\tvar listTag = $list[0].tagName;\n\n\t\t\t\t\tvar elems = this.getBlocks();\n\n\t\t\t\t\t$.each(elems, function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (s.tagName == 'LI')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar $prev = $(s).prev();\n\t\t\t\t\t\t\tif ($prev.length != 0 && $prev[0].tagName == 'LI')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tvar $childList = $prev.children('ul, ol');\n\t\t\t\t\t\t\t\tif ($childList.length == 0)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t$prev.append($('<' + listTag + '>').append(s));\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse $childList.append(s);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\telse if (block === false && this.opts.linebreaks === true)\n\t\t\t\t{\n\t\t\t\t\tthis.exec('formatBlock', 'blockquote');\n\t\t\t\t\tvar newblock = this.getBlock();\n\t\t\t\t\tvar block = $('<div data-tagblock=\"\">').html($(newblock).html());\n\t\t\t\t\t$(newblock).replaceWith(block);\n\n\t\t\t\t\tvar left = this.normalize($(block).css('margin-left')) + this.opts.indentValue;\n\t\t\t\t\t$(block).css('margin-left', left + 'px');\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\n\t\t\t\t\tvar elements = this.getBlocks();\n\t\t\t\t\t$.each(elements, $.proxy(function(i, elem)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $el = false;\n\n\t\t\t\t\t\tif (elem.tagName === 'TD') return;\n\n\t\t\t\t\t\tif ($.inArray(elem.tagName, this.opts.alignmentTags) !== -1)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$el = $(elem);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$el = $(elem).closest(this.opts.alignmentTags.toString().toLowerCase(), this.$editor[0]);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tvar left = this.normalize($el.css('margin-left')) + this.opts.indentValue;\n\t\t\t\t\t\t$el.css('margin-left', left + 'px');\n\n\t\t\t\t\t}, this));\n\t\t\t\t}\n\n\t\t\t\tthis.selectionRestore();\n\n\t\t\t}\n\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.selectionSave();\n\n\t\t\t\tvar block = this.getBlock();\n\t\t\t\tif (block && block.tagName == 'LI')\n\t\t\t\t{\n\n\t\t\t\t\tvar elems = this.getBlocks();\n\t\t\t\t\tvar index = 0;\n\n\t\t\t\t\tthis.insideOutdent(block, index, elems);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\n\t\t\t\t\tvar elements = this.getBlocks();\n\t\t\t\t\t$.each(elements, $.proxy(function(i, elem)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $el = false;\n\n\t\t\t\t\t\tif ($.inArray(elem.tagName, this.opts.alignmentTags) !== -1)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$el = $(elem);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$el = $(elem).closest(this.opts.alignmentTags.toString().toLowerCase(), this.$editor[0]);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tvar left = this.normalize($el.css('margin-left')) - this.opts.indentValue;\n\t\t\t\t\t\tif (left <= 0)\n\t\t\t\t\t\t{\n\n\t\t\t\t\t\t\tif (this.opts.linebreaks === true && typeof($el.data('tagblock')) !== 'undefined')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$el.replaceWith($el.html() + '<br>');\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$el.css('margin-left', '');\n\t\t\t\t\t\t\t\tthis.removeEmptyAttr($el, 'style');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$el.css('margin-left', left + 'px');\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}, this));\n\t\t\t\t}\n\t\t\t\tthis.selectionRestore();\n\t\t\t}\n\n\t\t\tthis.sync();\n\n\t\t},\n\t\tinsideOutdent: function (li, index, elems)\n\t\t{\n\t\t\tif (li && li.tagName == 'LI')\n\t\t\t{\n\t\t\t\tvar $parent = $(li).parent().parent();\n\t\t\t\tif ($parent.length != 0 && $parent[0].tagName == 'LI')\n\t\t\t\t{\n\t\t\t\t\t$parent.after(li);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tif (typeof elems[index] != 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\tli = elems[index];\n\t\t\t\t\t\tindex++;\n\n\t\t\t\t\t\tthis.insideOutdent(li, index, elems);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.execCommand('insertunorderedlist');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\talignmentLeft: function()\n\t\t{\n\t\t\tthis.alignmentSet('', 'JustifyLeft');\n\t\t},\n\t\talignmentRight: function()\n\t\t{\n\t\t\tthis.alignmentSet('right', 'JustifyRight');\n\t\t},\n\t\talignmentCenter: function()\n\t\t{\n\t\t\tthis.alignmentSet('center', 'JustifyCenter');\n\t\t},\n\t\talignmentJustify: function()\n\t\t{\n\t\t\tthis.alignmentSet('justify', 'JustifyFull');\n\t\t},\n\t\talignmentSet: function(type, cmd)\n\t\t{\n\t\t\tthis.bufferSet();\n\n\t\t\tif (this.oldIE())\n\t\t\t{\n\t\t\t\tthis.document.execCommand(cmd, false, false);\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\tthis.selectionSave();\n\n\t\t\tvar block = this.getBlock();\n\t\t\tif (!block && this.opts.linebreaks)\n\t\t\t{\n\n\t\t\t\tthis.exec('formatblock', 'div');\n\n\t\t\t\tvar newblock = this.getBlock();\n\t\t\t\tvar block = $('<div data-tagblock=\"\">').html($(newblock).html());\n\t\t\t\t$(newblock).replaceWith(block);\n\n\t\t\t\t$(block).css('text-align', type);\n\t\t\t\tthis.removeEmptyAttr(block, 'style');\n\n\t\t\t\tif (type == '' && typeof($(block).data('tagblock')) !== 'undefined')\n\t\t\t\t{\n\t\t\t\t\t$(block).replaceWith($(block).html());\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tvar elements = this.getBlocks();\n\t\t\t\t$.each(elements, $.proxy(function(i, elem)\n\t\t\t\t{\n\t\t\t\t\tvar $el = false;\n\n\t\t\t\t\tif ($.inArray(elem.tagName, this.opts.alignmentTags) !== -1)\n\t\t\t\t\t{\n\t\t\t\t\t\t$el = $(elem);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t$el = $(elem).closest(this.opts.alignmentTags.toString().toLowerCase(), this.$editor[0]);\n\t\t\t\t\t}\n\n\t\t\t\t\tif ($el)\n\t\t\t\t\t{\n\t\t\t\t\t\t$el.css('text-align', type);\n\t\t\t\t\t\tthis.removeEmptyAttr($el, 'style');\n\t\t\t\t\t}\n\n\t\t\t\t}, this));\n\t\t\t}\n\n\t\t\tthis.selectionRestore();\n\t\t\tthis.sync();\n\t\t},\n\t\tcleanEmpty: function(html)\n\t\t{\n\t\t\tvar ph = this.placeholderStart(html);\n\t\t\tif (ph !== false) return ph;\n\n\t\t\tif (this.opts.linebreaks === false)\n\t\t\t{\n\t\t\t\tif (html === '') html = this.opts.emptyHtml;\n\t\t\t\telse if (html.search(/^<hr\\s?\\/?>$/gi) !== -1) html = '<hr>' + this.opts.emptyHtml;\n\t\t\t}\n\n\t\t\treturn html;\n\t\t},\n\t\tcleanConverters: function(html)\n\t\t{\n\n\t\t\tif (this.opts.convertDivs && !this.opts.gallery)\n\t\t\t{\n\t\t\t\thtml = html.replace(/<div(.*?)>([\\w\\W]*?)<\\/div>/gi, '<p$1>$2</p>');\n\t\t\t}\n\n\t\t\tif (this.opts.paragraphy) html = this.cleanParagraphy(html);\n\n\t\t\treturn html;\n\t\t},\n\t\tcleanConvertProtected: function(html)\n\t\t{\n\t\t\tif (this.opts.templateVars)\n\t\t\t{\n\t\t\t\thtml = html.replace(/\\{\\{(.*?)\\}\\}/gi, '<!-- template double $1 -->');\n\t\t\t\thtml = html.replace(/\\{(.*?)\\}/gi, '<!-- template $1 -->');\n\t\t\t}\n\n\t\t\thtml = html.replace(/<script(.*?)>([\\w\\W]*?)<\\/script>/gi, '<title type=\"text/javascript\" style=\"display: none;\" class=\"redactor-script-tag\"$1>$2</title>');\n\t\t\thtml = html.replace(/<style(.*?)>([\\w\\W]*?)<\\/style>/gi, '<section$1 style=\"display: none;\" rel=\"redactor-style-tag\">$2</section>');\n\t\t\thtml = html.replace(/<form(.*?)>([\\w\\W]*?)<\\/form>/gi, '<section$1 rel=\"redactor-form-tag\">$2</section>');\n\t\t\tif (this.opts.phpTags) html = html.replace(/<\\?php([\\w\\W]*?)\\?>/gi, '<section style=\"display: none;\" rel=\"redactor-php-tag\">$1</section>');\n\t\t\telse html = html.replace(/<\\?php([\\w\\W]*?)\\?>/gi, '');\n\n\t\t\treturn html;\n\t\t},\n\t\tcleanReConvertProtected: function(html)\n\t\t{\n\t\t\tif (this.opts.templateVars)\n\t\t\t{\n\t\t\t\thtml = html.replace(/<!-- template double (.*?) -->/gi, '{{$1}}');\n\t\t\t\thtml = html.replace(/<!-- template (.*?) -->/gi, '{$1}');\n\t\t\t}\n\n\t\t\thtml = html.replace(/<title type=\"text\\/javascript\" style=\"display: none;\" class=\"redactor-script-tag\"(.*?)>([\\w\\W]*?)<\\/title>/gi, '<script$1 type=\"text/javascript\">$2</script>');\n\t\t\thtml = html.replace(/<section(.*?) style=\"display: none;\" rel=\"redactor-style-tag\">([\\w\\W]*?)<\\/section>/gi, '<style$1>$2</style>');\n\t\t\thtml = html.replace(/<section(.*?)rel=\"redactor-form-tag\"(.*?)>([\\w\\W]*?)<\\/section>/gi, '<form$1$2>$3</form>');\n\t\t\tif (this.opts.phpTags) html = html.replace(/<section style=\"display: none;\" rel=\"redactor-php-tag\">([\\w\\W]*?)<\\/section>/gi, '<?php\\r\\n$1\\r\\n?>');\n\n\t\t\treturn html;\n\t\t},\n\t\tcleanRemoveSpaces: function(html, buffer)\n\t\t{\n\t\t\tif (buffer !== false)\n\t\t\t{\n\t\t\t\tvar buffer = []\n\t\t\t\tvar matches = html.match(/<(code|style|script|title)(.*?)>([\\w\\W]*?)<\\/(code|style|script|title)>/gi);\n\t\t\t\tif (matches === null) matches = [];\n\n\t\t\t\tif (this.opts.phpTags)\n\t\t\t\t{\n\t\t\t\t\tvar phpMatches = html.match(/<\\?php([\\w\\W]*?)\\?>/gi);\n\t\t\t\t\tif (phpMatches) matches = $.merge(matches, phpMatches);\n\t\t\t\t}\n\n\t\t\t\tif (matches)\n\t\t\t\t{\n\t\t\t\t\t$.each(matches, function(i, s)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(s, 'buffer_' + i);\n\t\t\t\t\t\tbuffer.push(s);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\thtml = html.replace(/\\n/g, ' ');\n\t\t\thtml = html.replace(/[\\t]*/g, '');\n\t\t\thtml = html.replace(/\\n\\s*\\n/g, \"\\n\");\n\t\t\thtml = html.replace(/^[\\s\\n]*/g, ' ');\n\t\t\thtml = html.replace(/[\\s\\n]*$/g, ' ');\n\t\t\thtml = html.replace( />\\s{2,}</g, '> <');\n\n\t\t\thtml = this.cleanReplacer(html, buffer);\n\n\t\t\thtml = html.replace(/\\n\\n/g, \"\\n\");\n\n\t\t\treturn html;\n\t\t},\n\t\tcleanReplacer: function(html, buffer)\n\t\t{\n\t\t\tif (buffer === false) return html;\n\n\t\t\t$.each(buffer, function(i,s)\n\t\t\t{\n\t\t\t\thtml = html.replace('buffer_' + i, s);\n\t\t\t});\n\n\t\t\treturn html;\n\t\t},\n\t\tcleanRemoveEmptyTags: function(html)\n\t\t{\n\n\t\t\thtml = html.replace(/[\\u200B-\\u200D\\uFEFF]/g, '');\n\n\t\t\tvar etagsInline = [\"<b>\\\\s*</b>\", \"<b>&nbsp;</b>\", \"<em>\\\\s*</em>\"]\n\t\t\tvar etags = [\"<code></code>\", \"<blockquote>\\\\s*</blockquote>\", \"<dd></dd>\", \"<dt></dt>\", \"<ul></ul>\", \"<ol></ol>\", \"<li></li>\", \"<table></table>\", \"<tr></tr>\", \"<span>\\\\s*<span>\", \"<span>&nbsp;<span>\", \"<p>\\\\s*</p>\", \"<p></p>\", \"<p>&nbsp;</p>\",  \"<p>\\\\s*<br>\\\\s*</p>\", \"<div>\\\\s*</div>\", \"<div>\\\\s*<br>\\\\s*</div>\"];\n\n\t\t\tif (this.opts.removeEmptyTags)\n\t\t\t{\n\t\t\t\tetags = etags.concat(etagsInline);\n\t\t\t}\n\t\t\telse etags = etagsInline;\n\n\t\t\tvar len = etags.length;\n\t\t\tfor (var i = 0; i < len; ++i)\n\t\t\t{\n\t\t\t\thtml = html.replace(new RegExp(etags[i], 'gi'), \"\");\n\t\t\t}\n\n\t\t\treturn html;\n\t\t},\n\t\tcleanParagraphy: function(html)\n\t\t{\n\t\t\thtml = $.trim(html);\n\n\t\t\tif (this.opts.linebreaks === true) return html;\n\t\t\tif (html === '' || html === '<p></p>') return this.opts.emptyHtml;\n\n\t\t\thtml = html + \"\\n\";\n\n\t\t\tif (this.opts.removeEmptyTags === false)\n\t\t\t{\n\t\t\t\treturn html;\n\t\t\t}\n\n\t\t\tvar safes = [];\n\t\t\tvar matches = html.match(/<(table|div|code|object)(.*?)>([\\w\\W]*?)<\\/(table|div|code|object)>/gi);\n\t\t\tif (!matches) matches = [];\n\n\t\t\tvar commentsMatches = html.match(/<!--([\\w\\W]*?)-->/gi);\n\t\t\tif (commentsMatches) matches = $.merge(matches, commentsMatches);\n\n\t\t\tif (this.opts.phpTags)\n\t\t\t{\n\t\t\t\tvar phpMatches = html.match(/<section(.*?)rel=\"redactor-php-tag\">([\\w\\W]*?)<\\/section>/gi);\n\t\t\t\tif (phpMatches) matches = $.merge(matches, phpMatches);\n\t\t\t}\n\n\t\t\tif (matches)\n\t\t\t{\n\t\t\t\t$.each(matches, function(i,s)\n\t\t\t\t{\n\t\t\t\t\tsafes[i] = s;\n\t\t\t\t\thtml = html.replace(s, '{replace' + i + '}\\n');\n\t\t\t\t});\n\t\t\t}\n\n\t\t\thtml = html.replace(/<br \\/>\\s*<br \\/>/gi, \"\\n\\n\");\n\t\t\thtml = html.replace(/<br><br>/gi, \"\\n\\n\");\n\n\t\t\tfunction R(str, mod, r)\n\t\t\t{\n\t\t\t\treturn html.replace(new RegExp(str, mod), r);\n\t\t\t}\n\n\t\t\tvar blocks = '(comment|html|body|head|title|meta|style|script|link|iframe|table|thead|tfoot|caption|col|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|code|select|option|form|map|area|blockquote|address|math|style|p|h[1-6]|hr|fieldset|legend|section|article|aside|hgroup|header|footer|nav|figure|figcaption|details|menu|summary)';\n\n\t\t\thtml = R('(<' + blocks + '[^>]*>)', 'gi', \"\\n$1\");\n\t\t\thtml = R('(</' + blocks + '>)', 'gi', \"$1\\n\\n\");\n\t\t\thtml = R(\"\\r\\n\", 'g', \"\\n\");\n\t\t\thtml = R(\"\\r\", 'g', \"\\n\");\n\t\t\thtml = R(\"/\\n\\n+/\", 'g', \"\\n\\n\");\n\n\t\t\tvar htmls = html.split(new RegExp('\\n\\s*\\n', 'g'), -1);\n\n\t\t\thtml = '';\n\t\t\tfor (var i in htmls)\n\t\t\t{\n\t\t\t\tif (htmls.hasOwnProperty(i))\n                {\n\t\t\t\t\tif (htmls[i].search('{replace') == -1)\n\t\t\t\t\t{\n\t\t\t\t\t\thtmls[i] = htmls[i].replace(/<p>\\n\\t?<\\/p>/gi, '');\n\t\t\t\t\t\thtmls[i] = htmls[i].replace(/<p><\\/p>/gi, '');\n\n\t\t\t\t\t\tif (htmls[i] != '')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\thtml += '<p>' +  htmls[i].replace(/^\\n+|\\n+$/g, \"\") + \"</p>\";\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse html += htmls[i];\n\t\t\t\t}\n\t\t\t}\n\n\t\t\thtml = R('<p><p>', 'gi', '<p>');\n\t\t\thtml = R('</p></p>', 'gi', '</p>');\n\n\t\t\thtml = R('<p>\\s?</p>', 'gi', '');\n\n\t\t\thtml = R('<p>([^<]+)</(div|address|form)>', 'gi', \"<p>$1</p></$2>\");\n\n\t\t\thtml = R('<p>(</?' + blocks + '[^>]*>)</p>', 'gi', \"$1\");\n\t\t\thtml = R(\"<p>(<li.+?)</p>\", 'gi', \"$1\");\n\t\t\thtml = R('<p>\\s?(</?' + blocks + '[^>]*>)', 'gi', \"$1\");\n\n\t\t\thtml = R('(</?' + blocks + '[^>]*>)\\s?</p>', 'gi', \"$1\");\n\t\t\thtml = R('(</?' + blocks + '[^>]*>)\\s?<br />', 'gi', \"$1\");\n\t\t\thtml = R('<br />(\\s*</?(?:p|li|div|dl|dd|dt|th|code|td|ul|ol)[^>]*>)', 'gi', '$1');\n\t\t\thtml = R(\"\\n</p>\", 'gi', '</p>');\n\n\t\t\thtml = R('<li><p>', 'gi', '<li>');\n\t\t\thtml = R('</p></li>', 'gi', '</li>');\n\t\t\thtml = R('</li><p>', 'gi', '</li>');\n\t\t\thtml = R('<p>\\t?\\n?<p>', 'gi', '<p>');\n\t\t\thtml = R('</dt><p>', 'gi', '</dt>');\n\t\t\thtml = R('</dd><p>', 'gi', '</dd>');\n\t\t\thtml = R('<br></p></blockquote>', 'gi', '</blockquote>');\n\t\t\thtml = R('<p>\\t*</p>', 'gi', '');\n\t\t\t$.each(safes, function(i,s)\n\t\t\t{\n\t\t\t\thtml = html.replace('{replace' + i + '}', s);\n\t\t\t});\n\n\t\t\treturn $.trim(html);\n\t\t},\n\t\tcleanConvertInlineTags: function(html, set)\n\t\t{\n\t\t\tvar boldTag = 'strong';\n\t\t\tif (this.opts.boldTag === 'b') boldTag = 'b';\n\n\t\t\tvar italicTag = 'em';\n\t\t\tif (this.opts.italicTag === 'i') italicTag = 'i';\n\n\t\t\thtml = html.replace(/<span style=\"font-style: italic;\">([\\w\\W]*?)<\\/span>/gi, '<' + italicTag + '>$1</' + italicTag + '>');\n\t\t\thtml = html.replace(/<span style=\"font-weight: bold;\">([\\w\\W]*?)<\\/span>/gi, '<' + boldTag + '>$1</' + boldTag + '>');\n\t\t\tif (this.opts.boldTag === 'strong') html = html.replace(/<b>([\\w\\W]*?)<\\/b>/gi, '<strong>$1</strong>');\n\t\t\telse html = html.replace(/<strong>([\\w\\W]*?)<\\/strong>/gi, '<b>$1</b>');\n\n\t\t\tif (this.opts.italicTag === 'em') html = html.replace(/<i>([\\w\\W]*?)<\\/i>/gi, '<em>$1</em>');\n\t\t\telse html = html.replace(/<em>([\\w\\W]*?)<\\/em>/gi, '<i>$1</i>');\n\n\t\t\thtml = html.replace(/<span style=\"text-decoration: underline;\">([\\w\\W]*?)<\\/span>/gi, '<u>$1</u>');\n\n\t\t\tif (set !== true) html = html.replace(/<strike>([\\w\\W]*?)<\\/strike>/gi, '<del>$1</del>');\n\t\t\telse html = html.replace(/<del>([\\w\\W]*?)<\\/del>/gi, '<strike>$1</strike>');\n\n\t\t\treturn html;\n\t\t},\n\t\tcleanStripTags: function(html)\n\t\t{\n\t\t\tif (html == '' || typeof html == 'undefined') return html;\n\n\t\t\tvar allowed = false;\n\t\t\tif (this.opts.allowedTags !== false) allowed = true;\n\n\t\t\tvar arr = allowed === true ? this.opts.allowedTags : this.opts.deniedTags;\n\n\t\t\tvar tags = /<\\/?([a-z][a-z0-9]*)\\b[^>]*>/gi;\n\t\t\thtml = html.replace(tags, function ($0, $1)\n\t\t\t{\n\t\t\t\tif (allowed === true) return $.inArray($1.toLowerCase(), arr) > '-1' ? $0 : '';\n\t\t\t\telse return $.inArray($1.toLowerCase(), arr) > '-1' ? '' : $0;\n\t\t\t});\n\n\t\t\thtml = this.cleanConvertInlineTags(html);\n\n\t\t\treturn html;\n\n\t\t},\n\t\tcleanSavePreCode: function(html, encode)\n\t\t{\n\t\t\tvar pre = html.match(/<(pre|code)(.*?)>([\\w\\W]*?)<\\/(pre|code)>/gi);\n\t\t\tif (pre !== null)\n\t\t\t{\n\t\t\t\t$.each(pre, $.proxy(function(i,s)\n\t\t\t\t{\n\t\t\t\t\tvar arr = s.match(/<(pre|code)(.*?)>([\\w\\W]*?)<\\/(pre|code)>/i);\n\n\t\t\t\t\tarr[3] = arr[3].replace(/&nbsp;/g, ' ');\n\n\t\t\t\t\tif (encode !== false) arr[3] = this.cleanEncodeEntities(arr[3]);\n\n\t\t\t\t\tarr[3] = arr[3].replace(/\\$/g, '&#36;');\n\n\t\t\t\t\thtml = html.replace(s, '<' + arr[1] + arr[2] + '>' + arr[3] + '</' + arr[1] + '>');\n\n\t\t\t\t}, this));\n\t\t\t}\n\n\t\t\treturn html;\n\t\t},\n\t\tcleanEncodeEntities: function(str)\n\t\t{\n\t\t\tstr = String(str).replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '\"');\n\t\t\treturn str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;');\n\t\t},\n\t\tcleanUnverified: function()\n\t\t{\n\n\t\t\tvar $elem = this.$editor.find('li, img, a, b, strong, sub, sup, i, em, u, small, strike, del, span, cite');\n\n\t\t\t$elem.filter('[style*=\"background-color: transparent;\"][style*=\"line-height\"]')\n\t\t\t.css('background-color', '')\n\t\t\t.css('line-height', '');\n\n\t\t\t$elem.filter('[style*=\"background-color: transparent;\"]')\n\t\t\t.css('background-color', '');\n\n\t\t\t$elem.css('line-height', '');\n\n\t\t\t$.each($elem, $.proxy(function(i,s)\n\t\t\t{\n\t\t\t\tthis.removeEmptyAttr(s, 'style');\n\t\t\t}, this));\n\n\t\t\tvar $elem2 = this.$editor.find('b, strong, i, em, u, strike, del');\n\t\t\t$elem2.css('font-size', '');\n\n\t\t\t$.each($elem2, $.proxy(function(i,s)\n\t\t\t{\n\t\t\t\tthis.removeEmptyAttr(s, 'style');\n\t\t\t}, this));\n\t\t\tthis.$editor.find('div[style=\"text-align: -webkit-auto;\"]').contents().unwrap();\n\t\t\tthis.$editor.find('ul, ol, li').removeAttr('style');\n\t\t},\n\n\t\tcleanHtml: function(code)\n\t\t{\n\t\t\tvar i = 0,\n\t\t\tcodeLength = code.length,\n\t\t\tpoint = 0,\n\t\t\tstart = null,\n\t\t\tend = null,\n\t\t\ttag = '',\n\t\t\tout = '',\n\t\t\tcont = '';\n\n\t\t\tthis.cleanlevel = 0;\n\n\t\t\tfor (; i < codeLength; i++)\n\t\t\t{\n\t\t\t\tpoint = i;\n\t\t\t\tif (-1 == code.substr(i).indexOf( '<' ))\n\t\t\t\t{\n\t\t\t\t\tout += code.substr(i);\n\n\t\t\t\t\treturn this.cleanFinish(out);\n\t\t\t\t}\n\t\t\t\twhile (point < codeLength && code.charAt(point) != '<')\n\t\t\t\t{\n\t\t\t\t\tpoint++;\n\t\t\t\t}\n\n\t\t\t\tif (i != point)\n\t\t\t\t{\n\t\t\t\t\tcont = code.substr(i, point - i);\n\t\t\t\t\tif (!cont.match(/^\\s{2,}$/g))\n\t\t\t\t\t{\n\t\t\t\t\t\tif ('\\n' == out.charAt(out.length - 1)) out += this.cleanGetTabs();\n\t\t\t\t\t\telse if ('\\n' == cont.charAt(0))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tout += '\\n' + this.cleanGetTabs();\n\t\t\t\t\t\t\tcont = cont.replace(/^\\s+/, '');\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tout += cont;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (cont.match(/\\n/)) out += '\\n' + this.cleanGetTabs();\n\t\t\t\t}\n\n\t\t\t\tstart = point;\n\t\t\t\twhile (point < codeLength && '>' != code.charAt(point))\n\t\t\t\t{\n\t\t\t\t\tpoint++;\n\t\t\t\t}\n\n\t\t\t\ttag = code.substr(start, point - start);\n\t\t\t\ti = point;\n\n\t\t\t\tvar t;\n\n\t\t\t\tif ('!--' == tag.substr(1, 3))\n\t\t\t\t{\n\t\t\t\t\tif (!tag.match(/--$/))\n\t\t\t\t\t{\n\t\t\t\t\t\twhile ('-->' != code.substr(point, 3))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tpoint++;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tpoint += 2;\n\t\t\t\t\t\ttag = code.substr(start, point - start);\n\t\t\t\t\t\ti = point;\n\t\t\t\t\t}\n\n\t\t\t\t\tif ('\\n' != out.charAt(out.length - 1)) out += '\\n';\n\n\t\t\t\t\tout += this.cleanGetTabs();\n\t\t\t\t\tout += tag + '>\\n';\n\t\t\t\t}\n\t\t\t\telse if ('!' == tag[1])\n\t\t\t\t{\n\t\t\t\t\tout = this.placeTag(tag + '>', out);\n\t\t\t\t}\n\t\t\t\telse if ('?' == tag[1])\n\t\t\t\t{\n\t\t\t\t\tout += tag + '>\\n';\n\t\t\t\t}\n\t\t\t\telse if (t = tag.match(/^<(script|style|pre|code)/i))\n\t\t\t\t{\n\t\t\t\t\tt[1] = t[1].toLowerCase();\n\t\t\t\t\ttag = this.cleanTag(tag);\n\t\t\t\t\tout = this.placeTag(tag, out);\n\t\t\t\t\tend = String(code.substr(i + 1)).toLowerCase().indexOf('</' + t[1]);\n\n\t\t\t\t\tif (end)\n\t\t\t\t\t{\n\t\t\t\t\t\tcont = code.substr(i + 1, end);\n\t\t\t\t\t\ti += end;\n\t\t\t\t\t\tout += cont;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\ttag = this.cleanTag(tag);\n\t\t\t\t\tout = this.placeTag(tag, out);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn this.cleanFinish(out);\n\t\t},\n\t\tcleanGetTabs: function()\n\t\t{\n\t\t\tvar s = '';\n\t\t\tfor ( var j = 0; j < this.cleanlevel; j++ )\n\t\t\t{\n\t\t\t\ts += '\\t';\n\t\t\t}\n\n\t\t\treturn s;\n\t\t},\n\t\tcleanFinish: function(code)\n\t\t{\n\t\t\tcode = code.replace(/\\n\\s*\\n/g, '\\n');\n\t\t\tcode = code.replace(/^[\\s\\n]*/, '');\n\t\t\tcode = code.replace(/[\\s\\n]*$/, '');\n\t\t\tcode = code.replace(/<script(.*?)>\\n<\\/script>/gi, '<script$1></script>');\n\n\t\t\tthis.cleanlevel = 0;\n\n\t\t\treturn code;\n\t\t},\n\t\tcleanTag: function (tag)\n\t\t{\n\t\t\tvar tagout = '';\n\t\t\ttag = tag.replace(/\\n/g, ' ');\n\t\t\ttag = tag.replace(/\\s{2,}/g, ' ');\n\t\t\ttag = tag.replace(/^\\s+|\\s+$/g, ' ');\n\n\t\t\tvar suffix = '';\n\t\t\tif (tag.match(/\\/$/))\n\t\t\t{\n\t\t\t\tsuffix = '/';\n\t\t\t\ttag = tag.replace(/\\/+$/, '');\n\t\t\t}\n\n\t\t\tvar m;\n\t\t\twhile (m = /\\s*([^= ]+)(?:=((['\"']).*?\\3|[^ ]+))?/.exec(tag))\n\t\t\t{\n\t\t\t\tif (m[2]) tagout += m[1].toLowerCase() + '=' + m[2];\n\t\t\t\telse if (m[1]) tagout += m[1].toLowerCase();\n\n\t\t\t\ttagout += ' ';\n\t\t\t\ttag = tag.substr(m[0].length);\n\t\t\t}\n\n\t\t\treturn tagout.replace(/\\s*$/, '') + suffix + '>';\n\t\t},\n\t\tplaceTag: function (tag, out)\n\t\t{\n\t\t\tvar nl = tag.match(this.cleannewLevel);\n\t\t\tif (tag.match(this.cleanlineBefore) || nl)\n\t\t\t{\n\t\t\t\tout = out.replace(/\\s*$/, '');\n\t\t\t\tout += '\\n';\n\t\t\t}\n\n\t\t\tif (nl && '/' == tag.charAt(1)) this.cleanlevel--;\n\t\t\tif ('\\n' == out.charAt(out.length - 1)) out += this.cleanGetTabs();\n\t\t\tif (nl && '/' != tag.charAt(1)) this.cleanlevel++;\n\n\t\t\tout += tag;\n\n\t\t\tif (tag.match(this.cleanlineAfter) || tag.match(this.cleannewLevel))\n\t\t\t{\n\t\t\t\tout = out.replace(/ *$/, '');\n\t\t\t\tout += '\\n';\n\t\t\t}\n\n\t\t\treturn out;\n\t\t},\n\t\tformatEmpty: function(e)\n\t\t{\n\t\t\tvar html = $.trim(this.$editor.html());\n\n\t\t\tif (this.opts.linebreaks)\n\t\t\t{\n\t\t\t\tif (html == '')\n\t\t\t\t{\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\tthis.$editor.html('');\n\t\t\t\t\tthis.focus();\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\thtml = html.replace(/<br\\s?\\/?>/i, '');\n\t\t\t\tvar thtml = html.replace(/<p>\\s?<\\/p>/gi, '');\n\n\t\t\t\tif (html === '' || thtml === '')\n\t\t\t\t{\n\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\tvar node = $(this.opts.emptyHtml).get(0);\n\t\t\t\t\tthis.$editor.html(node);\n\t\t\t\t\tthis.focus();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.sync();\n\t\t},\n\t\tformatBlocks: function(tag)\n\t\t{\n\t\t\tif (this.browser('mozilla') && this.isFocused())\n\t\t\t{\n\t\t\t\tthis.$editor.focus();\n\t\t\t}\n\n\t\t\tthis.bufferSet();\n\n\t\t\tvar nodes = this.getBlocks();\n\t\t\tthis.selectionSave();\n\n\t\t\t$.each(nodes, $.proxy(function(i, node)\n\t\t\t{\n\t\t\t\tif (node.tagName !== 'LI')\n\t\t\t\t{\n\t\t\t\t\tvar parent = $(node).parent();\n\n\t\t\t\t\tif (tag === 'p')\n\t\t\t\t\t{\n\t\t\t\t\t\tif ((node.tagName === 'P'\n\t\t\t\t\t\t&& parent.length != 0\n\t\t\t\t\t\t&& parent[0].tagName === 'BLOCKQUOTE')\n\t\t\t\t\t\t||\n\t\t\t\t\t\tnode.tagName === 'BLOCKQUOTE')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.formatQuote();\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (this.opts.linebreaks)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif (node && node.tagName.search(/H[1-6]/) == 0)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$(node).replaceWith(node.innerHTML + '<br>');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse return;\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.formatBlock(tag, node);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.formatBlock(tag, node);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t}, this));\n\n\t\t\tthis.selectionRestore();\n\t\t\tthis.sync();\n\t\t},\n\t\tformatBlock: function(tag, block)\n\t\t{\n\t\t\tif (block === false) block = this.getBlock();\n\t\t\tif (block === false && this.opts.linebreaks === true)\n\t\t\t{\n\t\t\t\tthis.execCommand('formatblock', tag);\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\tvar contents = '';\n\t\t\tif (tag !== 'code')\n\t\t\t{\n\t\t\t\tcontents = $(block).contents();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\n\t\t\t\tcontents = $(block).html();\n\t\t\t\tif ($.trim(contents) === '')\n\t\t\t\t{\n\t\t\t\t\tcontents = '<span id=\"selection-marker-1\"></span>';\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (block.tagName === 'CODE') tag = 'p';\n\n\t\t\tif (this.opts.linebreaks === true && tag === 'p')\n\t\t\t{\n\t\t\t\t$(block).replaceWith($('<div>').append(contents).html() + '<br>');\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tvar parent = this.getParent();\n\n\t\t\t\tvar node = $('<' + tag + '>').append(contents);\n\t\t\t\t$(block).replaceWith(node);\n\n\t\t\t\tif (parent && parent.tagName == 'TD')\n\t\t\t\t{\n\t\t\t\t\t$(node).wrapAll('<td>');\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\tformatChangeTag: function(fromElement, toTagName, save)\n\t\t{\n\t\t\tif (save !== false) this.selectionSave();\n\n\t\t\tvar newElement = $('<' + toTagName + '/>');\n\t\t\t$(fromElement).replaceWith(function() { return newElement.append($(this).contents()); });\n\n\t\t\tif (save !== false) this.selectionRestore();\n\n\t\t\treturn newElement;\n\t\t},\n\t\tformatQuote: function()\n\t\t{\n\t\t\tif (this.browser('mozilla') && this.isFocused())\n\t\t\t{\n\t\t\t\tthis.$editor.focus();\n\t\t\t}\n\n\t\t\tthis.bufferSet();\n\t\t\tif (this.opts.linebreaks === false)\n\t\t\t{\n\t\t\t\tthis.selectionSave();\n\n\t\t\t\tvar blocks = this.getBlocks();\n\n\t\t\t\tvar blockquote = false;\n\t\t\t\tvar blocksLen = blocks.length;\n\t\t\t\tif (blocks)\n\t\t\t\t{\n\t\t\t\t\tvar data = '';\n\t\t\t\t\tvar replaced = '';\n\t\t\t\t\tvar replace = false;\n\t\t\t\t\tvar paragraphsOnly = true;\n\n\t\t\t\t\t$.each(blocks, function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (s.tagName !== 'P') paragraphsOnly = false;\n\t\t\t\t\t});\n\n\t\t\t\t\t$.each(blocks, $.proxy(function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (s.tagName === 'BLOCKQUOTE')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.formatBlock('p', s, false);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (s.tagName === 'P')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tblockquote = $(s).parent();\n\n\t\t\t\t\t\t\tif (blockquote[0].tagName == 'BLOCKQUOTE')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tvar count = $(blockquote).children('p').length;\n\t\t\t\t\t\t\t\tif (count == 1)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t$(blockquote).replaceWith(s);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\telse if (count == blocksLen)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\treplace = 'blockquote';\n\t\t\t\t\t\t\t\t\tdata += this.outerHtml(s);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\treplace = 'html';\n\t\t\t\t\t\t\t\t\tdata += this.outerHtml(s);\n\n\t\t\t\t\t\t\t\t\tif (i == 0)\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t$(s).addClass('redactor-replaced').empty();\n\t\t\t\t\t\t\t\t\t\treplaced = this.outerHtml(s);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\telse $(s).remove();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tif (paragraphsOnly === false || blocks.length == 1)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tthis.formatBlock('blockquote', s, false);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\treplace = 'paragraphs';\n\t\t\t\t\t\t\t\t\tdata += this.outerHtml(s);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (s.tagName !== 'LI')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.formatBlock('blockquote', s, false);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t\tif (replace)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (replace == 'paragraphs')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$(blocks[0]).replaceWith('<blockquote>' + data + '</blockquote>');\n\t\t\t\t\t\t\t$(blocks).remove();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (replace == 'blockquote')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$(blockquote).replaceWith(data);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (replace == 'html')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar html = this.$editor.html().replace(replaced, '</blockquote>' + data + '<blockquote>');\n\n\t\t\t\t\t\t\tthis.$editor.html(html);\n\t\t\t\t\t\t\tthis.$editor.find('blockquote').each(function()\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tif ($.trim($(this).html()) == '') $(this).remove();\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tthis.selectionRestore();\n\t\t\t}\n\n\t\t\telse\n\t\t\t{\n\t\t\t\tvar block = this.getBlock();\n\t\t\t\tif (block.tagName === 'BLOCKQUOTE')\n\t\t\t\t{\n\t\t\t\t\tthis.selectionSave();\n\n\t\t\t\t\tvar html = $.trim($(block).html());\n\t\t\t\t\tvar selection = $.trim(this.getSelectionHtml());\n\n\t\t\t\t\thtml = html.replace(/<span(.*?)id=\"selection-marker(.*?)<\\/span>/gi, '');\n\n\t\t\t\t\tif (html == selection)\n\t\t\t\t\t{\n\t\t\t\t\t\t$(block).replaceWith($(block).html() + '<br>');\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\n\t\t\t\t\t\tthis.inlineFormat('tmp');\n\t\t\t\t\t\tvar tmp = this.$editor.find('tmp');\n\t\t\t\t\t\ttmp.empty();\n\n\t\t\t\t\t\tvar newhtml = this.$editor.html().replace('<tmp></tmp>', '</blockquote><span id=\"selection-marker-1\">' + this.opts.invisibleSpace + '</span>' + selection + '<blockquote>');\n\n\t\t\t\t\t\tthis.$editor.html(newhtml);\n\t\t\t\t\t\ttmp.remove();\n\t\t\t\t\t\tthis.$editor.find('blockquote').each(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif ($.trim($(this).html()) == '') $(this).remove();\n\t\t\t\t\t\t})\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.selectionRestore();\n\t\t\t\t\tthis.$editor.find('span#selection-marker-1').attr('id', false);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tvar wrapper = this.selectionWrap('blockquote');\n\t\t\t\t\tvar html = $(wrapper).html();\n\n\t\t\t\t\tvar blocksElemsRemove = ['ul', 'ol', 'table', 'tr', 'tbody', 'thead', 'tfoot', 'dl'];\n\t\t\t\t\t$.each(blocksElemsRemove, function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(new RegExp('<' + s + '(.*?)>', 'gi'), '');\n\t\t\t\t\t\thtml = html.replace(new RegExp('</' + s + '>', 'gi'), '');\n\t\t\t\t\t});\n\n\t\t\t\t\tvar blocksElems = this.opts.blockLevelElements;\n\t\t\t\t\t$.each(blocksElems, function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(new RegExp('<' + s + '(.*?)>', 'gi'), '');\n\t\t\t\t\t\thtml = html.replace(new RegExp('</' + s + '>', 'gi'), '<br>');\n\t\t\t\t\t});\n\n\t\t\t\t\t$(wrapper).html(html);\n\t\t\t\t\tthis.selectionElement(wrapper);\n\t\t\t\t\tvar next = $(wrapper).next();\n\t\t\t\t\tif (next.length != 0 && next[0].tagName === 'BR')\n\t\t\t\t\t{\n\t\t\t\t\t\tnext.remove();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.sync();\n\t\t},\n\t\tblockRemoveAttr: function(attr, value)\n\t\t{\n\t\t\tvar nodes = this.getBlocks();\n\t\t\t$(nodes).removeAttr(attr);\n\n\t\t\tthis.sync();\n\t\t},\n\t\tblockSetAttr: function(attr, value)\n\t\t{\n\t\t\tvar nodes = this.getBlocks();\n\t\t\t$(nodes).attr(attr, value);\n\n\t\t\tthis.sync();\n\t\t},\n\t\tblockRemoveStyle: function(rule)\n\t\t{\n\t\t\tvar nodes = this.getBlocks();\n\t\t\t$(nodes).css(rule, '');\n\t\t\tthis.removeEmptyAttr(nodes, 'style');\n\n\t\t\tthis.sync();\n\t\t},\n\t\tblockSetStyle: function (rule, value)\n\t\t{\n\t\t\tvar nodes = this.getBlocks();\n\t\t\t$(nodes).css(rule, value);\n\n\t\t\tthis.sync();\n\t\t},\n\t\tblockRemoveClass: function(className)\n\t\t{\n\t\t\tvar nodes = this.getBlocks();\n\t\t\t$(nodes).removeClass(className);\n\t\t\tthis.removeEmptyAttr(nodes, 'class');\n\n\t\t\tthis.sync();\n\t\t},\n\t\tblockSetClass: function(className)\n\t\t{\n\t\t\tvar nodes = this.getBlocks();\n\t\t\t$(nodes).addClass(className);\n\n\t\t\tthis.sync();\n\t\t},\n\t\tinlineRemoveClass: function(className)\n\t\t{\n\t\t\tthis.selectionSave();\n\n\t\t\tthis.inlineEachNodes(function(node)\n\t\t\t{\n\t\t\t\t$(node).removeClass(className);\n\t\t\t\tthis.removeEmptyAttr(node, 'class');\n\t\t\t});\n\n\t\t\tthis.selectionRestore();\n\t\t\tthis.sync();\n\t\t},\n\t\tinlineSetClass: function(className)\n\t\t{\n\t\t\tvar current = this.getCurrent();\n\t\t\tif (!$(current).hasClass(className)) this.inlineMethods('addClass', className);\n\t\t},\n\t\tinlineRemoveStyle: function (rule)\n\t\t{\n\t\t\tthis.selectionSave();\n\n\t\t\tthis.inlineEachNodes(function(node)\n\t\t\t{\n\t\t\t\t$(node).css(rule, '');\n\t\t\t\tthis.removeEmptyAttr(node, 'style');\n\t\t\t});\n\n\t\t\tthis.selectionRestore();\n\t\t\tthis.sync();\n\t\t},\n\t\tinlineSetStyle: function(rule, value)\n\t\t{\n\t\t\tthis.inlineMethods('css', rule, value);\n\t\t},\n\t\tinlineRemoveAttr: function (attr)\n\t\t{\n\t\t\tthis.selectionSave();\n\n\t\t\tvar range = this.getRange(), node = this.getElement(), nodes = this.getNodes();\n\n\t\t\tif (range.collapsed || range.startContainer === range.endContainer && node)\n\t\t\t{\n\t\t\t\tnodes = $( node );\n\t\t\t}\n\n\t\t\t$(nodes).removeAttr(attr);\n\n\t\t\tthis.inlineUnwrapSpan();\n\n\t\t\tthis.selectionRestore();\n\t\t\tthis.sync();\n\t\t},\n\t\tinlineSetAttr: function(attr, value)\n\t\t{\n\t\t\tthis.inlineMethods('attr', attr, value );\n\t\t},\n\t\tinlineMethods: function(type, attr, value)\n\t\t{\n\t\t\tthis.bufferSet();\n\t\t\tthis.selectionSave();\n\n\t\t\tvar range = this.getRange()\n\t\t\tvar el = this.getElement();\n\n\t\t\tif ((range.collapsed || range.startContainer === range.endContainer) && el && !this.nodeTestBlocks(el))\n\t\t\t{\n\t\t\t\t$(el)[type](attr, value);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tvar cmd, arg = value;\n\t\t\t\tswitch (attr)\n\t\t\t\t{\n\t\t\t\t\tcase 'font-size':\n\t\t\t\t\t\tcmd = 'fontSize';\n\t\t\t\t\t\targ = 4;\n\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'font-family':\n\t\t\t\t\t\tcmd = 'fontName';\n\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'color':\n\t\t\t\t\t\tcmd = 'foreColor';\n\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'background-color':\n\t\t\t\t\t\tcmd = 'backColor';\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\tthis.document.execCommand(cmd, false, arg);\n\n\t\t\t\tvar fonts = this.$editor.find('font');\n\t\t\t\t$.each(fonts, $.proxy(function(i, s)\n\t\t\t\t{\n\t\t\t\t\tthis.inlineSetMethods(type, s, attr, value);\n\n\t\t\t\t}, this));\n\n\t\t\t}\n\n\t\t\tthis.selectionRestore();\n\t\t\tthis.sync();\n\t\t},\n\t\tinlineSetMethods: function(type, s, attr, value)\n\t\t{\n\t\t\tvar parent = $(s).parent(), el;\n\n\t\t\tvar selectionHtml = this.getSelectionText();\n\t\t\tvar parentHtml = $(parent).text();\n\t\t\tvar selected = selectionHtml == parentHtml;\n\n\t\t\tif (selected && parent && parent[0].tagName === 'INLINE' && parent[0].attributes.length != 0)\n\t\t\t{\n\t\t\t\tel = parent;\n\t\t\t\t$(s).replaceWith($(s).html());\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tel = $('<inline>').append($(s).contents());\n\t\t\t\t$(s).replaceWith(el);\n\t\t\t}\n\t\t\t$(el)[type](attr, value);\n\n\t\t\treturn el;\n\t\t},\n\n\t\tinlineEachNodes: function(callback)\n\t\t{\n\t\t\tvar range = this.getRange(),\n\t\t\t\tnode = this.getElement(),\n\t\t\t\tnodes = this.getNodes(),\n\t\t\t\tcollapsed;\n\n\t\t\tif (range.collapsed || range.startContainer === range.endContainer && node)\n\t\t\t{\n\t\t\t\tnodes = $(node);\n\t\t\t\tcollapsed = true;\n\t\t\t}\n\n\t\t\t$.each(nodes, $.proxy(function(i, node)\n\t\t\t{\n\t\t\t\tif (!collapsed && node.tagName !== 'INLINE')\n\t\t\t\t{\n\t\t\t\t\tvar selectionHtml = this.getSelectionText();\n\t\t\t\t\tvar parentHtml = $(node).parent().text();\n\t\t\t\t\tvar selected = selectionHtml == parentHtml;\n\n\t\t\t\t\tif (selected && node.parentNode.tagName === 'INLINE' && !$(node.parentNode).hasClass('redactor_editor'))\n\t\t\t\t\t{\n\t\t\t\t\t\tnode = node.parentNode;\n\t\t\t\t\t}\n\t\t\t\t\telse return;\n\t\t\t\t}\n\t\t\t\tcallback.call(this, node);\n\n\t\t\t}, this ) );\n\t\t},\n\t\tinlineUnwrapSpan: function()\n\t\t{\n\t\t\tvar $spans = this.$editor.find('inline');\n\n\t\t\t$.each($spans, $.proxy(function(i, span)\n\t\t\t{\n\t\t\t\tvar $span = $(span);\n\n\t\t\t\tif ($span.attr('class') === undefined && $span.attr('style') === undefined)\n\t\t\t\t{\n\t\t\t\t\t$span.contents().unwrap();\n\t\t\t\t}\n\n\t\t\t}, this));\n\t\t},\n\t\tinlineFormat: function(tag)\n\t\t{\n\t\t\tthis.selectionSave();\n\n\t\t\tthis.document.execCommand('fontSize', false, 4 );\n\n\t\t\tvar fonts = this.$editor.find('font');\n\t\t\tvar last;\n\t\t\t$.each(fonts, function(i, s)\n\t\t\t{\n\t\t\t\tvar el = $('<' + tag + '/>').append($(s).contents());\n\t\t\t\t$(s).replaceWith(el);\n\t\t\t\tlast = el;\n\t\t\t});\n\n\t\t\tthis.selectionRestore();\n\n\t\t\tthis.sync();\n\t\t},\n\t\tinlineRemoveFormat: function(tag)\n\t\t{\n\t\t\tthis.selectionSave();\n\n\t\t\tvar utag = tag.toUpperCase();\n\t\t\tvar nodes = this.getNodes();\n\t\t\tvar parent = $(this.getParent()).parent();\n\n\t\t\t$.each(nodes, function(i, s)\n\t\t\t{\n\t\t\t\tif (s.tagName === utag) this.inlineRemoveFormatReplace(s);\n\t\t\t});\n\n\t\t\tif (parent && parent[0].tagName === utag) this.inlineRemoveFormatReplace(parent);\n\n\t\t\tthis.selectionRestore();\n\t\t\tthis.sync();\n\t\t},\n\t\tinlineRemoveFormatReplace: function(el)\n\t\t{\n\t\t\t$(el).replaceWith($(el).contents());\n\t\t},\n\n\t\tinsertHtml: function (html, sync)\n\t\t{\n\t\t\tvar current = this.getCurrent();\n\t\t\tvar parent = current.parentNode;\n\n\t\t\tthis.focusWithSaveScroll();\n\n\t\t\tthis.bufferSet();\n\n\t\t\tvar $html = $('<div>').append($.parseHTML(html));\n\t\t\thtml = $html.html();\n\n\t\t\thtml = this.cleanRemoveEmptyTags(html);\n\t\t\t$html = $('<div>').append($.parseHTML(html));\n\t\t\tvar currBlock = this.getBlock();\n\n\t\t\tif ($html.contents().length == 1)\n\t\t\t{\n\t\t\t\tvar htmlTagName = $html.contents()[0].tagName;\n\t\t\t\tif (htmlTagName != 'P' && htmlTagName == currBlock.tagName || htmlTagName == 'CODE')\n\t\t\t\t{\n\n\t\t\t\t\t$html = $('<div>').append(html);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (this.opts.linebreaks)\n\t\t\t{\n\t\t\t\thtml = html.replace(/<p(.*?)>([\\w\\W]*?)<\\/p>/gi, '$2<br>');\n\t\t\t}\n\t\t\tif (!this.opts.linebreaks && $html.contents().length == 1 && $html.contents()[0].nodeType == 3\n\t\t\t\t&& (this.getRangeSelectedNodes().length > 2 || (!current || current.tagName == 'BODY' && !parent || parent.tagName == 'HTML')))\n\t\t\t{\n\t\t\t\thtml = '<p>' + html + '</p>';\n\t\t\t}\n\n\t\t\thtml = this.setSpansVerifiedHtml(html);\n\n\t\t\tif ($html.contents().length > 1 && currBlock\n\t\t\t|| $html.contents().is('p, :header, ul, ol, li, div, table, td, blockquote, code, address, section, header, footer, aside, article'))\n\t\t\t{\n\t\t\t\tif (this.browser('msie'))\n\t\t\t\t{\n\t\t\t\t\tif (!this.isIe11())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.document.selection.createRange().pasteHTML(html);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.execPasteFrag(html);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.document.execCommand('inserthtml', false, html);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse this.insertHtmlAdvanced(html, false);\n\n\t\t\tif (this.selectall)\n\t\t\t{\n\t\t\t\tthis.window.setTimeout($.proxy(function()\n\t\t\t\t{\n\t\t\t\t\tif (!this.opts.linebreaks) this.selectionEnd(this.$editor.contents().last());\n\t\t\t\t\telse this.focusEnd();\n\n\t\t\t\t}, this), 1);\n\t\t\t}\n\n\t\t\tthis.observeStart();\n\t\t\tthis.setNonEditable();\n\n\t\t\tif (sync !== false) this.sync();\n\t\t},\n\t\tinsertHtmlAdvanced: function(html, sync)\n\t\t{\n\t\t\thtml = this.setSpansVerifiedHtml(html);\n\n\t\t\tvar sel = this.getSelection();\n\n\t\t\tif (sel.getRangeAt && sel.rangeCount)\n\t\t\t{\n\t\t\t\tvar range = sel.getRangeAt(0);\n\t\t\t\trange.deleteContents();\n\n\t\t\t\tvar el = document.createElement('div');\n\t\t\t\tel.innerHTML = html;\n\t\t\t\tvar frag = document.createDocumentFragment(), node, lastNode;\n\t\t\t\twhile ((node = el.firstChild))\n\t\t\t\t{\n\t\t\t\t\tlastNode = frag.appendChild(node);\n\t\t\t\t}\n\n\t\t\t\trange.insertNode(frag);\n\n\t\t\t\tif (lastNode)\n\t\t\t\t{\n\t\t\t\t\trange = range.cloneRange();\n\t\t\t\t\trange.setStartAfter(lastNode);\n\t\t\t\t\trange.collapse(true);\n\t\t\t\t\tsel.removeAllRanges();\n\t\t\t\t\tsel.addRange(range);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (sync !== false)\n\t\t\t{\n\t\t\t\tthis.sync();\n\t\t\t}\n\n\t\t},\n\t\tinsertBeforeCursor: function(html)\n\t\t{\n\t\t\thtml = this.setSpansVerifiedHtml(html);\n\n\t\t\tvar node = $(html);\n\n\t\t\tvar space = document.createElement(\"span\");\n\t\t\tspace.innerHTML = \"\\u200B\";\n\n\t\t\tvar range = this.getRange();\n\t\t\trange.insertNode(space);\n\t\t\trange.insertNode(node[0]);\n\t\t\trange.collapse(false);\n\n\t\t\tvar sel = this.getSelection();\n\t\t\tsel.removeAllRanges();\n\t\t\tsel.addRange(range);\n\n\t\t\tthis.sync();\n\t\t},\n\t\tinsertText: function(html)\n\t\t{\n\t\t\tvar $html = $($.parseHTML(html));\n\n\t\t\tif ($html.length) html = $html.text();\n\n\t\t\tthis.focusWithSaveScroll();\n\n\t\t\tif (this.browser('msie'))\n\t\t\t{\n\t\t\t\tif (!this.isIe11())\n\t\t\t\t{\n\t\t\t\t\tthis.document.selection.createRange().pasteHTML(html);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.execPasteFrag(html);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.document.execCommand('inserthtml', false, html);\n\t\t\t}\n\n\t\t\tthis.sync();\n\t\t},\n\t\tinsertNode: function(node)\n\t\t{\n\t\t\tnode = node[0] || node;\n\n\t\t\tif (node.tagName == 'SPAN')\n\t\t\t{\n\t\t\t\tvar replacementTag = 'inline';\n\n\t\t\t    var outer = node.outerHTML;\n\t\t\t    var regex = new RegExp('<' + node.tagName, 'i');\n\t\t\t    var newTag = outer.replace(regex, '<' + replacementTag);\n\t\t\t    regex = new RegExp('</' + node.tagName, 'i');\n\t\t\t    newTag = newTag.replace(regex, '</' + replacementTag);\n\t\t\t    node = $(newTag)[0];\n\t\t\t}\n\n\t\t\tvar sel = this.getSelection();\n\t\t\tif (sel.getRangeAt && sel.rangeCount)\n\t\t\t{\n\n\t\t\t\trange = sel.getRangeAt(0);\n\t\t\t\trange.deleteContents();\n\t\t\t\trange.insertNode(node);\n\t\t\t\trange.setEndAfter(node);\n\t\t\t\trange.setStartAfter(node);\n\t\t\t\tsel.removeAllRanges();\n\t\t\t\tsel.addRange(range);\n\t\t\t}\n\n\t\t\treturn node;\n\t\t},\n\t\tinsertNodeToCaretPositionFromPoint: function(e, node)\n\t\t{\n\t\t\tvar range;\n\t\t\tvar x = e.clientX, y = e.clientY;\n\t\t\tif (this.document.caretPositionFromPoint)\n\t\t\t{\n\t\t\t    var pos = this.document.caretPositionFromPoint(x, y);\n\t\t\t    range = this.getRange();\n\t\t\t    range.setStart(pos.offsetNode, pos.offset);\n\t\t\t    range.collapse(true);\n\t\t\t    range.insertNode(node);\n\t\t\t}\n\t\t\telse if (this.document.caretRangeFromPoint)\n\t\t\t{\n\t\t\t    range = this.document.caretRangeFromPoint(x, y);\n\t\t\t    range.insertNode(node);\n\t\t\t}\n\t\t\telse if (typeof document.body.createTextRange != \"undefined\")\n\t\t\t{\n\t\t        range = this.document.body.createTextRange();\n\t\t        range.moveToPoint(x, y);\n\t\t        var endRange = range.duplicate();\n\t\t        endRange.moveToPoint(x, y);\n\t\t        range.setEndPoint(\"EndToEnd\", endRange);\n\t\t        range.select();\n\t\t\t}\n\n\t\t},\n\t\tinsertAfterLastElement: function(element, parent)\n\t\t{\n\t\t\tif (typeof(parent) != 'undefined') element = parent;\n\n\t\t\tif (this.isEndOfElement())\n\t\t\t{\n\t\t\t\tif (this.opts.linebreaks)\n\t\t\t\t{\n\t\t\t\t\tvar contents = $('<div>').append($.trim(this.$editor.html())).contents();\n\t\t\t\t\tvar last = contents.last()[0];\n\t\t\t\t\tif (last.tagName == 'SPAN' && last.innerHTML == '')\n\t\t\t\t\t{\n\t\t\t\t\t\tlast = contents.prev()[0];\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.outerHtml(last) != this.outerHtml(element))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tif (this.$editor.contents().last()[0] !== element)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tthis.insertingAfterLastElement(element);\n\t\t\t}\n\t\t},\n\t\tinsertingAfterLastElement: function(element)\n\t\t{\n\t\t\tthis.bufferSet();\n\n\t\t\tif (this.opts.linebreaks === false)\n\t\t\t{\n\t\t\t\tvar node = $(this.opts.emptyHtml);\n\t\t\t\t$(element).after(node);\n\t\t\t\tthis.selectionStart(node);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tvar node = $('<span id=\"selection-marker-1\">' + this.opts.invisibleSpace + '</span>', this.document)[0];\n\t\t\t\t$(element).after(node);\n\t\t\t\t$(node).after(this.opts.invisibleSpace);\n\t\t\t\tthis.selectionRestore();\n\t\t\t\tthis.$editor.find('span#selection-marker-1').removeAttr('id');\n\t\t\t}\n\t\t},\n\t\tinsertLineBreak: function(twice)\n\t\t{\n\t\t\tthis.selectionSave();\n\n\t\t\tvar br = '<br>';\n\t\t\tif (twice == true)\n\t\t\t{\n\t\t\t\tbr = '<br><br>';\n\t\t\t}\n\n\t\t\tif (this.browser('mozilla'))\n\t\t\t{\n\t\t\t\tvar span = $('<span>').html(this.opts.invisibleSpace);\n\t\t\t\tthis.$editor.find('#selection-marker-1').before(br).before(span).before(this.opts.invisibleSpace);\n\n\t\t\t\tthis.setCaretAfter(span[0]);\n\t\t\t\tspan.remove();\n\n\t\t\t\tthis.selectionRemoveMarkers();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tvar parent = this.getParent();\n\t\t\t\tif (parent && parent.tagName === 'A')\n\t\t\t\t{\n\t\t\t\t\tvar offset = this.getCaretOffset(parent);\n\n\t\t\t\t\tvar text = $.trim($(parent).text()).replace(/\\n\\r\\n/g, '');\n\t\t\t\t\tvar len = text.length;\n\n\t\t\t\t\tif (offset == len)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.selectionRemoveMarkers();\n\n\t\t\t\t\t\tvar node = $('<span id=\"selection-marker-1\">' + this.opts.invisibleSpace + '</span>', this.document)[0];\n\t\t\t\t\t\t$(parent).after(node);\n\t\t\t\t\t\t$(node).before(br + (this.browser('webkit') ? this.opts.invisibleSpace : ''));\n\t\t\t\t\t\tthis.selectionRestore();\n\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t\tthis.$editor.find('#selection-marker-1').before(br + (this.browser('webkit') ? this.opts.invisibleSpace : ''));\n\t\t\t\tthis.selectionRestore();\n\t\t\t}\n\t\t},\n\t\tinsertDoubleLineBreak: function()\n\t\t{\n\t\t\tthis.insertLineBreak(true);\n\t\t},\n\t\treplaceLineBreak: function(element)\n\t\t{\n\t\t\tvar node = $('<br>' + this.opts.invisibleSpace);\n\t\t\t$(element).replaceWith(node);\n\t\t\tthis.selectionStart(node);\n\t\t},\n\t\tpasteClean: function(html)\n\t\t{\n\t\t\thtml = this.callback('pasteBefore', false, html);\n\t\t\tif (this.browser('msie'))\n\t\t\t{\n\t\t\t\tvar tmp = $.trim(html);\n\t\t\t\tif (tmp.search(/^<a(.*?)>(.*?)<\\/a>$/i) == 0)\n\t\t\t\t{\n\t\t\t\t\thtml = html.replace(/^<a(.*?)>(.*?)<\\/a>$/i, \"$2\");\n\t\t\t\t}\n\t\t\t}\n            html = html.replace(/on([a-z]+)=|javascript\\:/gi, '');\n\t\t\tif (this.opts.pastePlainText)\n\t\t\t{\n\t\t\t\tvar tmp = this.document.createElement('div');\n\n\t\t\t\thtml = html.replace(/<br>|<\\/H[1-6]>|<\\/p>|<\\/div>/gi, '\\n');\n\n\t\t\t\ttmp.innerHTML = html;\n\t\t\t\thtml = tmp.textContent || tmp.innerText;\n\n\t\t\t\thtml = $.trim(html);\n\t\t\t\thtml = html.replace('\\n', '<br>');\n\t\t\t\thtml = this.cleanParagraphy(html);\n\n\t\t\t\tthis.pasteInsert(html);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tvar tablePaste = false;\n\t\t\tif (this.currentOrParentIs('TD'))\n\t\t\t{\n\t\t\t\ttablePaste = true;\n\t\t\t\tvar blocksElems = this.opts.blockLevelElements;\n\t\t\t\tblocksElems.push('tr');\n\t\t\t\tblocksElems.push('table');\n\t\t\t\t$.each(blocksElems, function(i,s)\n\t\t\t\t{\n\t\t\t\t\thtml = html.replace(new RegExp('<' + s + '(.*?)>', 'gi'), '');\n\t\t\t\t\thtml = html.replace(new RegExp('</' + s + '>', 'gi'), '<br>');\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (this.currentOrParentIs('CODE'))\n\t\t\t{\n\t\t\t\thtml = this.pastePre(html);\n\t\t\t\tthis.pasteInsert(html);\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\thtml = html.replace(/<img(.*?)v:shapes=(.*?)>/gi, '');\n\t\t\thtml = html.replace(/<p(.*?)class=\"MsoListParagraphCxSpFirst\"([\\w\\W]*?)<\\/p>/gi, '<ul><li$2</li>');\n\t\t\thtml = html.replace(/<p(.*?)class=\"MsoListParagraphCxSpMiddle\"([\\w\\W]*?)<\\/p>/gi, '<li$2</li>');\n\t\t\thtml = html.replace(/<p(.*?)class=\"MsoListParagraphCxSpLast\"([\\w\\W]*?)<\\/p>/gi, '<li$2</li></ul>');\n\n\t\t\thtml = html.replace(/<p(.*?)class=\"MsoListParagraph\"([\\w\\W]*?)<\\/p>/gi, '<ul><li$2</li></ul>');\n\n\t\t\thtml = html.replace(/\u00b7/g, '');\n\t\t\thtml = html.replace(/<!--[\\s\\S]*?-->|<\\?(?:php)?[\\s\\S]*?\\?>/gi, '');\n\t\t\tif (this.opts.cleanSpaces === true)\n\t\t\t{\n\t\t\t\thtml = html.replace(/(&nbsp;){2,}/gi, '&nbsp;');\n\t\t\t\thtml = html.replace(/&nbsp;/gi, ' ');\n\t\t\t}\n\t\t\thtml = html.replace(/<b\\sid=\"internal-source-marker(.*?)\">([\\w\\W]*?)<\\/b>/gi, \"$2\");\n\t\t\thtml = html.replace(/<b(.*?)id=\"docs-internal-guid(.*?)\">([\\w\\W]*?)<\\/b>/gi, \"$3\");\n\t \t\thtml = html.replace(/<span[^>]*(font-style: italic; font-weight: bold|font-weight: bold; font-style: italic)[^>]*>/gi, '<span style=\"font-weight: bold;\"><span style=\"font-style: italic;\">');\n\t \t\thtml = html.replace(/<span[^>]*font-style: italic[^>]*>/gi, '<span style=\"font-style: italic;\">');\n\t\t\thtml = html.replace(/<span[^>]*font-weight: bold[^>]*>/gi, '<span style=\"font-weight: bold;\">');\n\t\t\thtml = html.replace(/<span[^>]*text-decoration: underline[^>]*>/gi, '<span style=\"text-decoration: underline;\">');\n\t\t\thtml = html.replace(/<td>\\u200b*<\\/td>/gi, '[td]');\n\t\t\thtml = html.replace(/<td>&nbsp;<\\/td>/gi, '[td]');\n\t\t\thtml = html.replace(/<td><br><\\/td>/gi, '[td]');\n\t\t\thtml = html.replace(/<td(.*?)colspan=\"(.*?)\"(.*?)>([\\w\\W]*?)<\\/td>/gi, '[td colspan=\"$2\"]$4[/td]');\n\t\t\thtml = html.replace(/<td(.*?)rowspan=\"(.*?)\"(.*?)>([\\w\\W]*?)<\\/td>/gi, '[td rowspan=\"$2\"]$4[/td]');\n\t\t\thtml = html.replace(/<a(.*?)href=\"(.*?)\"(.*?)>([\\w\\W]*?)<\\/a>/gi, '[a href=\"$2\"]$4[/a]');\n\t\t\thtml = html.replace(/<iframe(.*?)>([\\w\\W]*?)<\\/iframe>/gi, '[iframe$1]$2[/iframe]');\n\t\t\thtml = html.replace(/<video(.*?)>([\\w\\W]*?)<\\/video>/gi, '[video$1]$2[/video]');\n\t\t\thtml = html.replace(/<audio(.*?)>([\\w\\W]*?)<\\/audio>/gi, '[audio$1]$2[/audio]');\n\t\t\thtml = html.replace(/<embed(.*?)>([\\w\\W]*?)<\\/embed>/gi, '[embed$1]$2[/embed]');\n\t\t\thtml = html.replace(/<object(.*?)>([\\w\\W]*?)<\\/object>/gi, '[object$1]$2[/object]');\n\t\t\thtml = html.replace(/<param(.*?)>/gi, '[param$1]');\n\n\t\t\thtml = html.replace(/<img(.*?)>/gi, '[img$1]');\n\t\t\thtml = html.replace(/ class=\"(.*?)\"/gi, '');\n\t\t\thtml = html.replace(/<(\\w+)([\\w\\W]*?)>/gi, '<$1>');\n\t\t\tif (this.opts.linebreaks)\n\t\t\t{\n\n\t\t\t\thtml = html.replace(/<strong><\\/strong>/gi, '');\n\t\t\t\thtml = html.replace(/<u><\\/u>/gi, '');\n\n\t\t\t\tif (this.opts.cleanFontTag)\n\t\t\t\t{\n\t\t\t\t\thtml = html.replace(/<font(.*?)>([\\w\\W]*?)<\\/font>/gi, '$2');\n\t\t\t\t}\n\n\t\t\t\thtml = html.replace(/<[^\\/>][^>]*>(\\s*|\\t*|\\n*|&nbsp;|<br>)<\\/[^>]+>/gi, '<br>');\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\thtml = html.replace(/<[^\\/>][^>]*>(\\s*|\\t*|\\n*|&nbsp;|<br>)<\\/[^>]+>/gi, '');\n\t\t\t}\n\n\t\t\thtml = html.replace(/<div>\\s*?\\t*?\\n*?(<ul>|<ol>|<p>)/gi, '$1');\n\t\t\thtml = html.replace(/\\[td colspan=\"(.*?)\"\\]([\\w\\W]*?)\\[\\/td\\]/gi, '<td colspan=\"$1\">$2</td>');\n\t\t\thtml = html.replace(/\\[td rowspan=\"(.*?)\"\\]([\\w\\W]*?)\\[\\/td\\]/gi, '<td rowspan=\"$1\">$2</td>');\n\t\t\thtml = html.replace(/\\[td\\]/gi, '<td>&nbsp;</td>');\n\t\t\thtml = html.replace(/\\[a href=\"(.*?)\"\\]([\\w\\W]*?)\\[\\/a\\]/gi, '<a href=\"$1\">$2</a>');\n\t\t\thtml = html.replace(/\\[iframe(.*?)\\]([\\w\\W]*?)\\[\\/iframe\\]/gi, '<iframe$1>$2</iframe>');\n\t\t\thtml = html.replace(/\\[video(.*?)\\]([\\w\\W]*?)\\[\\/video\\]/gi, '<video$1>$2</video>');\n\t\t\thtml = html.replace(/\\[audio(.*?)\\]([\\w\\W]*?)\\[\\/audio\\]/gi, '<audio$1>$2</audio>');\n\t\t\thtml = html.replace(/\\[embed(.*?)\\]([\\w\\W]*?)\\[\\/embed\\]/gi, '<embed$1>$2</embed>');\n\t\t\thtml = html.replace(/\\[object(.*?)\\]([\\w\\W]*?)\\[\\/object\\]/gi, '<object$1>$2</object>');\n\t\t\thtml = html.replace(/\\[param(.*?)\\]/gi, '<param$1>');\n\t\t\thtml = html.replace(/\\[img(.*?)\\]/gi, '<img$1>');\n\t\t\tif (this.opts.convertDivs)\n\t\t\t{\n\t\t\t\thtml = html.replace(/<div(.*?)>([\\w\\W]*?)<\\/div>/gi, '<p>$2</p>');\n\t\t\t\thtml = html.replace(/<\\/div><p>/gi, '<p>');\n\t\t\t\thtml = html.replace(/<\\/p><\\/div>/gi, '</p>');\n\t\t\t\thtml = html.replace(/<p><\\/p>/gi, '<br />');\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\thtml = html.replace(/<div><\\/div>/gi, '<br />');\n\t\t\t}\n\t\t\thtml = this.cleanStripTags(html);\n\n\t\t\tif (this.currentOrParentIs('LI'))\n\t\t\t{\n\t\t\t\thtml = html.replace(/<p>([\\w\\W]*?)<\\/p>/gi, '$1<br>');\n\t\t\t}\n\t\t\telse if (tablePaste === false)\n\t\t\t{\n\t\t\t\thtml = this.cleanParagraphy(html);\n\t\t\t}\n\t\t\thtml = html.replace(/<span(.*?)>([\\w\\W]*?)<\\/span>/gi, '$2');\n\t\t\thtml = html.replace(/<img>/gi, '');\n\t\t\thtml = html.replace(/<[^\\/>][^>][^img|param|source|td][^<]*>(\\s*|\\t*|\\n*| |<br>)<\\/[^>]+>/gi, '');\n\n\t\t\thtml = html.replace(/\\n{3,}/gi, '\\n');\n\t\t\thtml = html.replace(/<p><p>/gi, '<p>');\n\t\t\thtml = html.replace(/<\\/p><\\/p>/gi, '</p>');\n\n\t\t\thtml = html.replace(/<li>(\\s*|\\t*|\\n*)<p>/gi, '<li>');\n\t\t\thtml = html.replace(/<\\/p>(\\s*|\\t*|\\n*)<\\/li>/gi, '</li>');\n\n\t\t\tif (this.opts.linebreaks === true)\n\t\t\t{\n\t\t\t\thtml = html.replace(/<p(.*?)>([\\w\\W]*?)<\\/p>/gi, '$2<br>');\n\t\t\t}\n\t\t\thtml = html.replace(/<[^\\/>][^>][^img|param|source|td][^<]*>(\\s*|\\t*|\\n*| |<br>)<\\/[^>]+>/gi, '');\n\t\t\thtml = html.replace(/<img src=\"webkit-fake-url\\:\\/\\/(.*?)\"(.*?)>/gi, '');\n\t\t\thtml = html.replace(/<td(.*?)>(\\s*|\\t*|\\n*)<p>([\\w\\W]*?)<\\/p>(\\s*|\\t*|\\n*)<\\/td>/gi, '<td$1>$3</td>');\n\t\t\tif (this.opts.convertDivs)\n\t\t\t{\n\t\t\t\thtml = html.replace(/<div(.*?)>([\\w\\W]*?)<\\/div>/gi, '$2');\n\t\t\t\thtml = html.replace(/<div(.*?)>([\\w\\W]*?)<\\/div>/gi, '$2');\n\t\t\t}\n\t\t\tthis.pasteClipboardMozilla = false;\n\t\t\tif (this.browser('mozilla'))\n\t\t\t{\n\t\t\t\tif (this.opts.clipboardUpload)\n\t\t\t\t{\n\t\t\t\t\tvar matches = html.match(/<img src=\"data:image(.*?)\"(.*?)>/gi);\n\t\t\t\t\tif (matches !== null)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.pasteClipboardMozilla = matches;\n\t\t\t\t\t\tfor (var k in matches)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar img = matches[k].replace('<img', '<img data-mozilla-paste-image=\"' + k + '\" ');\n\t\t\t\t\t\t\thtml = html.replace(matches[k], img);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\twhile (/<br>$/gi.test(html))\n\t\t\t\t{\n\t\t\t\t\thtml = html.replace(/<br>$/gi, '');\n\t\t\t\t}\n\t\t\t}\n\t\t\thtml = html.replace(/<p>\u2022([\\w\\W]*?)<\\/p>/gi, '<li>$1</li>');\n\t\t\tif (this.browser('msie'))\n\t\t\t{\n\t\t\t\twhile (/<font>([\\w\\W]*?)<\\/font>/gi.test(html))\n\t\t\t\t{\n\t\t\t\t\thtml = html.replace(/<font>([\\w\\W]*?)<\\/font>/gi, '$1');\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (tablePaste === false)\n\t\t\t{\n\t\t\t\thtml = html.replace(/<td(.*?)>([\\w\\W]*?)<p(.*?)>([\\w\\W]*?)<\\/td>/gi, '<td$1>$2$4</td>');\n\t\t\t\thtml = html.replace(/<td(.*?)>([\\w\\W]*?)<\\/p>([\\w\\W]*?)<\\/td>/gi, '<td$1>$2$3</td>');\n\t\t\t\thtml = html.replace(/<td(.*?)>([\\w\\W]*?)<p(.*?)>([\\w\\W]*?)<\\/td>/gi, '<td$1>$2$4</td>');\n\t\t\t\thtml = html.replace(/<td(.*?)>([\\w\\W]*?)<\\/p>([\\w\\W]*?)<\\/td>/gi, '<td$1>$2$3</td>');\n\t\t\t}\n\t\t\thtml = html.replace(/\\n/g, ' ');\n\t\t\thtml = html.replace(/<p>\\n?<li>/gi, '<li>');\n\n\t\t\tthis.pasteInsert(html);\n\n\t\t},\n\t\tpastePre: function(s)\n\t\t{\n\t\t\ts = s.replace(/<br>|<\\/H[1-6]>|<\\/p>|<\\/div>/gi, '\\n');\n\n\t\t\tvar tmp = this.document.createElement('div');\n\t\t\ttmp.innerHTML = s;\n\t\t\treturn this.cleanEncodeEntities(tmp.textContent || tmp.innerText);\n\t\t},\n\t\tpasteInsert: function(html)\n\t\t{\n\t\t\thtml = this.callback('pasteAfter', false, html);\n\n\t\t\tif (this.selectall)\n\t\t\t{\n\t\t\t\tthis.$editor.html(html);\n\t\t\t\tthis.selectionRemove();\n\t\t\t\tthis.focusEnd();\n\t\t\t\tthis.sync();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.insertHtml(html);\n\t\t\t}\n\n\t\t\tthis.selectall = false;\n\n\t\t\tsetTimeout($.proxy(function()\n\t\t\t{\n\t\t\t\tthis.rtePaste = false;\n\t\t\t\tif (this.browser('mozilla'))\n\t\t\t\t{\n\t\t\t\t\tthis.$editor.find('p:empty').remove();\n\t\t\t\t}\n\t\t\t\tif (this.pasteClipboardMozilla !== false)\n\t\t\t\t{\n\t\t\t\t\tthis.pasteClipboardUploadMozilla();\n\t\t\t\t}\n\n\t\t\t}, this), 100);\n\n\t\t\tif (this.opts.autoresize && this.fullscreen !== true)\n\t\t\t{\n\t\t\t\t$(this.document.body).scrollTop(this.saveScroll);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.$editor.scrollTop(this.saveScroll);\n\t\t\t}\n\t\t},\n\t\tpasteClipboardAppendFields: function(postData)\n\t\t{\n\n\t\t\tif (this.opts.uploadFields !== false && typeof this.opts.uploadFields === 'object')\n\t\t\t{\n\t\t\t\t$.each(this.opts.uploadFields, $.proxy(function(k, v)\n\t\t\t\t{\n\t\t\t\t\tif (v != null && v.toString().indexOf('#') === 0) v = $(v).val();\n\t\t\t\t\tpostData[k] = v;\n\n\t\t\t\t}, this));\n\t\t\t}\n\n\t\t\treturn postData;\n\t\t},\n\t\tpasteClipboardUploadMozilla: function()\n\t\t{\n\t\t\tvar imgs = this.$editor.find('img[data-mozilla-paste-image]');\n\t\t\t$.each(imgs, $.proxy(function(i,s)\n\t\t\t{\n\t\t\t\tvar $s = $(s);\n\t\t\t\tvar arr = s.src.split(\",\");\n\t\t\t\tvar postData = {\n\t\t\t\t\t'contentType': arr[0].split(\";\")[0].split(\":\")[1],\n\t\t\t\t\t'data': arr[1]\n\t\t\t\t};\n\t\t\t\tpostData = this.pasteClipboardAppendFields(postData);\n\n\t\t\t\t$.post(this.opts.clipboardUploadUrl, postData,\n\t\t\t\t$.proxy(function(data)\n\t\t\t\t{\n\t\t\t\t\tvar json = (typeof data === 'string' ? $.parseJSON(data) : data);\n\t\t        \t$s.attr('src', json.image.url);\n\t\t        \t$s.removeAttr('data-mozilla-paste-image');\n\n\t\t        \tthis.sync();\n\t\t\t\t\tthis.callback('imageUpload', $s, json);\n\n\t\t\t\t}, this));\n\n\t\t\t}, this));\n\t\t},\n\t\tpasteClipboardUpload: function(e)\n\t\t{\n\t        var result = e.target.result;\n\t\t\tvar arr = result.split(\",\");\n\t\t\tvar postData = {\n\t\t\t\t'contentType': arr[0].split(\";\")[0].split(\":\")[1],\n\t\t\t\t'data': arr[1]\n\t\t\t};\n\t\t\tif (this.opts.clipboardUpload)\n\t\t\t{\n\n\t\t\t\tpostData = this.pasteClipboardAppendFields(postData);\n\n\t\t\t\t$.post(this.opts.clipboardUploadUrl, postData,\n\t\t\t\t$.proxy(function(data)\n\t\t\t\t{\n\t\t\t\t\tvar json = (typeof data === 'string' ? $.parseJSON(data) : data);\n\n\t\t\t\t\tvar html = '<img src=\"' + json.image.url + '\" id=\"clipboard-image-marker\" />';\n\t\t\t\t\tthis.execCommand('inserthtml', html, false);\n\n\t\t\t\t\tvar image = $(this.$editor.find('img#clipboard-image-marker'));\n\n\t\t\t\t\tif (image.length) image.removeAttr('id');\n\t\t\t\t\telse image = false;\n\n\t\t\t\t\tthis.sync();\n\t\t\t\t\tif (image)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.callback('imageUpload', image, json);\n\t\t\t\t\t}\n\t\t\t\t}, this));\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t        \tthis.insertHtml('<img src=\"' + result + '\" />');\n        \t}\n\t\t},\n\t\tbufferSet: function(selectionSave)\n\t\t{\n\t\t\tif (selectionSave !== false)\n\t\t\t{\n\t\t\t\tthis.selectionSave();\n\t\t\t}\n\n\t\t\tthis.opts.buffer.push(this.$editor.html());\n\n\t\t\tif (selectionSave !== false)\n\t\t\t{\n\t\t\t\tthis.selectionRemoveMarkers('buffer');\n\t\t\t}\n\n\t\t},\n\t\tbufferUndo: function()\n\t\t{\n\t\t\tif (this.opts.buffer.length === 0)\n\t\t\t{\n\t\t\t\tthis.focusWithSaveScroll();\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.selectionSave();\n\t\t\tthis.opts.rebuffer.push(this.$editor.html());\n\t\t\tthis.selectionRestore(false, true);\n\n\t\t\tthis.$editor.html(this.opts.buffer.pop());\n\n\t\t\tthis.selectionRestore();\n\t\t\tsetTimeout($.proxy(this.observeStart, this), 100);\n\t\t},\n\t\tbufferRedo: function()\n\t\t{\n\t\t\tif (this.opts.rebuffer.length === 0)\n\t\t\t{\n\t\t\t\tthis.focusWithSaveScroll();\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tthis.selectionSave();\n\t\t\tthis.opts.buffer.push(this.$editor.html());\n\t\t\tthis.selectionRestore(false, true);\n\n\t\t\tthis.$editor.html(this.opts.rebuffer.pop());\n\t\t\tthis.selectionRestore(true);\n\t\t\tsetTimeout($.proxy(this.observeStart, this), 4);\n\t\t},\n\t\tobserveStart: function()\n\t\t{\n\t\t\tthis.observeImages();\n\n\t\t\tif (this.opts.observeLinks) this.observeLinks();\n\t\t},\n\t\tobserveLinks: function()\n\t\t{\n\t\t\tthis.$editor.find('a').on('click', $.proxy(this.linkObserver, this));\n\n\t\t\tthis.$editor.on('click.redactor', $.proxy(function(e)\n\t\t\t{\n\t\t\t\tthis.linkObserverTooltipClose(e);\n\n\t\t\t}, this));\n\n\t\t\t$(document).on('click.redactor', $.proxy(function(e)\n\t\t\t{\n\t\t\t\tthis.linkObserverTooltipClose(e);\n\n\t\t\t}, this));\n\t\t},\n\t\tobserveImages: function()\n\t\t{\n\t\t\tif (this.opts.observeImages === false) return false;\n\n\t\t\tthis.$editor.find('img').each($.proxy(function(i, elem)\n\t\t\t{\n\t\t\t\tif (this.browser('msie')) $(elem).attr('unselectable', 'on');\n\n\t\t\t\tvar parent = $(elem).parent();\n\t\t\t\tif (!parent.hasClass('royalSlider') && !parent.hasClass('fotorama'))\n\t\t\t\t{\n\t\t\t\t\tthis.imageResize(elem);\n\t\t\t\t}\n\n\t\t\t}, this));\n\t\t\tthis.$editor.find('.fotorama, .royalSlider').on('click', $.proxy(this.editGallery, this));\n\n\t\t},\n\t\tlinkObserver: function(e)\n\t\t{\n\t\t\tvar $link = $(e.target);\n\n\t\t\tvar parent = $(e.target).parent();\n\t\t\tif (parent.hasClass('royalSlider') || parent.hasClass('fotorama'))\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif ($link.length == 0 || $link[0].tagName !== 'A') return;\n\n\t\t\tvar pos = $link.offset();\n\t\t\tif (this.opts.iframe)\n\t\t\t{\n\t\t\t\tvar posFrame = this.$frame.offset();\n\t\t\t\tpos.top = posFrame.top + (pos.top - $(this.document).scrollTop());\n\t\t\t\tpos.left += posFrame.left;\n\t\t\t}\n\n\t\t\tvar tooltip = $('<span class=\"redactor-link-tooltip\"></span>');\n\n\t\t\tvar href = $link.attr('href');\n\t\t\tif (href === undefined)\n\t\t\t{\n\t\t\t\thref = '';\n\t\t\t}\n\n\t\t\tif (href.length > 24) href = href.substring(0, 24) + '...';\n\n\t\t\tvar aLink = $('<a href=\"' + $link.attr('href') + '\" target=\"_blank\">' + href + '</a>').on('click', $.proxy(function(e)\n\t\t\t{\n\t\t\t\tthis.linkObserverTooltipClose(false);\n\t\t\t}, this));\n\n\t\t\tvar aEdit = $('<a href=\"#\">' + this.opts.curLang.edit + '</a>').on('click', $.proxy(function(e)\n\t\t\t{\n\t\t\t\te.preventDefault();\n\t\t\t\tthis.linkShow();\n\t\t\t\tthis.linkObserverTooltipClose(false);\n\n\t\t\t}, this));\n\n\t\t\tvar aUnlink = $('<a href=\"#\">' + this.opts.curLang.unlink + '</a>').on('click', $.proxy(function(e)\n\t\t\t{\n\t\t\t\te.preventDefault();\n\t\t\t\tthis.execCommand('unlink');\n\t\t\t\tthis.linkObserverTooltipClose(false);\n\n\t\t\t}, this));\n\t\t\ttooltip.append(aLink);\n\t\t\ttooltip.append(' | ');\n\t\t\ttooltip.append(aEdit);\n\t\t\ttooltip.append(' | ');\n\t\t\ttooltip.append(aUnlink);\n\t\t\ttooltip.css({\n\t\t\t\ttop: (pos.top + 20) + 'px',\n\t\t\t\tleft: pos.left + 'px'\n\t\t\t});\n\n\t\t\t$('.redactor-link-tooltip').remove();\n\t\t\t$('body').append(tooltip);\n\t\t},\n\t\tlinkObserverTooltipClose: function(e)\n\t\t{\n\t\t\tif (e !== false && e.target.tagName == 'A') return false;\n\t\t\t$('.redactor-link-tooltip').remove();\n\t\t},\n\t\tgetSelection: function()\n\t\t{\n\t\t\tif (!this.opts.rangy) return this.document.getSelection();\n\t\t\telse\n\t\t\t{\n\t\t\t\tif (!this.opts.iframe) return rangy.getSelection();\n\t\t\t\telse return rangy.getSelection(this.$frame[0]);\n\t\t\t}\n\t\t},\n\t\tgetRange: function()\n\t\t{\n\t\t\tif (!this.opts.rangy)\n\t\t\t{\n\t\t\t\tif (this.document.getSelection)\n\t\t\t\t{\n\t\t\t\t\tvar sel = this.getSelection();\n\t\t\t\t\tif (sel.getRangeAt && sel.rangeCount) return sel.getRangeAt(0);\n\t\t\t\t}\n\n\t\t\t\treturn this.document.createRange();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tif (!this.opts.iframe) return rangy.createRange();\n\t\t\t\telse return rangy.createRange(this.iframeDoc());\n\t\t\t}\n\t\t},\n\t\tselectionElement: function(node)\n\t\t{\n\t\t\tthis.setCaret(node);\n\t\t},\n\t\tselectionStart: function(node)\n\t\t{\n\t\t\tthis.selectionSet(node[0] || node, 0, null, 0);\n\t\t},\n\t\tselectionEnd: function(node)\n\t\t{\n\t\t\tthis.selectionSet(node[0] || node, 1, null, 1);\n\t\t},\n\t\tselectionSet: function(orgn, orgo, focn, foco)\n\t\t{\n\t\t\tif (focn == null) focn = orgn;\n\t\t\tif (foco == null) foco = orgo;\n\n\t\t\tvar sel = this.getSelection();\n\t\t\tif (!sel) return;\n\n\t\t\tif (orgn.tagName == 'P' && orgn.innerHTML == '')\n\t\t\t{\n\t\t\t\torgn.innerHTML = this.opts.invisibleSpace;\n\t\t\t}\n\n\t\t\tif (orgn.tagName == 'BR' && this.opts.linebreaks === false)\n\t\t\t{\n\t\t\t\tvar par = $(this.opts.emptyHtml)[0];\n\t\t\t\t$(orgn).replaceWith(par);\n\t\t\t\torgn = par;\n\t\t\t\tfocn = orgn;\n\t\t\t}\n\n\t\t\tvar range = this.getRange();\n\t\t\trange.setStart(orgn, orgo);\n\t\t\trange.setEnd(focn, foco );\n\n\t\t\ttry {\n\t\t\t\tsel.removeAllRanges();\n\t\t\t} catch (e) {}\n\n\t\t\tsel.addRange(range);\n\t\t},\n\t\tselectionWrap: function(tag)\n\t\t{\n\t\t\ttag = tag.toLowerCase();\n\n\t\t\tvar block = this.getBlock();\n\t\t\tif (block)\n\t\t\t{\n\t\t\t\tvar wrapper = this.formatChangeTag(block, tag);\n\t\t\t\tthis.sync();\n\t\t\t\treturn wrapper;\n\t\t\t}\n\n\t\t\tvar sel = this.getSelection();\n\t\t\tvar range = sel.getRangeAt(0);\n\t\t\tvar wrapper = document.createElement(tag);\n\t\t\twrapper.appendChild(range.extractContents());\n\t\t\trange.insertNode(wrapper);\n\n\t\t\tthis.selectionElement(wrapper);\n\n\t\t\treturn wrapper;\n\t\t},\n\t\tselectionAll: function()\n\t\t{\n\t\t\tvar range = this.getRange();\n\t\t\trange.selectNodeContents(this.$editor[0]);\n\n\t\t\tvar sel = this.getSelection();\n\t\t\tsel.removeAllRanges();\n\t\t\tsel.addRange(range);\n\t\t},\n\t\tselectionRemove: function()\n\t\t{\n\t\t\tthis.getSelection().removeAllRanges();\n\t\t},\n\t\tgetCaretOffset: function (element)\n\t\t{\n\t\t\tvar caretOffset = 0;\n\n\t\t\tvar range = this.getRange();\n\t\t\tvar preCaretRange = range.cloneRange();\n\t\t\tpreCaretRange.selectNodeContents(element);\n\t\t\tpreCaretRange.setEnd(range.endContainer, range.endOffset);\n\t\t\tcaretOffset = $.trim(preCaretRange.toString()).length;\n\n\t\t\treturn caretOffset;\n\t\t},\n\t\tgetCaretOffsetRange: function()\n\t\t{\n\t\t\treturn new Range(this.getSelection().getRangeAt(0));\n\t\t},\n\t\tsetCaret: function (el, start, end)\n\t\t{\n\t\t\tif (typeof end === 'undefined') end = start;\n\t\t\tel = el[0] || el;\n\n\t\t\tvar range = this.getRange();\n\t\t\trange.selectNodeContents(el);\n\n\t\t\tvar textNodes = this.getTextNodesIn(el);\n\t\t\tvar foundStart = false;\n\t\t\tvar charCount = 0, endCharCount;\n\n\t\t\tif (textNodes.length == 1 && start)\n\t\t\t{\n\t\t\t\trange.setStart(textNodes[0], start);\n\t\t\t\trange.setEnd(textNodes[0], end);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tfor (var i = 0, textNode; textNode = textNodes[i++];)\n\t\t\t\t{\n\t\t\t\t\tendCharCount = charCount + textNode.length;\n\t\t\t\t\tif (!foundStart && start >= charCount && (start < endCharCount || (start == endCharCount && i < textNodes.length)))\n\t\t\t\t\t{\n\t\t\t\t\t\trange.setStart(textNode, start - charCount);\n\t\t\t\t\t\tfoundStart = true;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (foundStart && end <= endCharCount)\n\t\t\t\t\t{\n\t\t\t\t\t\trange.setEnd( textNode, end - charCount );\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\n\t\t\t\t\tcharCount = endCharCount;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tvar sel = this.getSelection();\n\t\t\tsel.removeAllRanges();\n\t\t\tsel.addRange( range );\n\t\t},\n\t\tsetCaretAfter: function(node)\n\t\t{\n\t\t\tthis.$editor.focus();\n\n\t\t\tnode = node[0] || node;\n\n\t\t\tvar range = this.document.createRange()\n\n\t\t\tvar start = 1;\n\t\t\tvar end = -1;\n\n\t\t\trange.setStart(node, start)\n\t\t\trange.setEnd(node, end + 2)\n\t\t\tvar selection = this.window.getSelection()\n\t\t\tvar cursorRange = this.document.createRange()\n\n\t\t\tvar emptyElement = this.document.createTextNode('\\u200B')\n\t\t\t$(node).after(emptyElement)\n\n\t\t\tcursorRange.setStartAfter(emptyElement)\n\n\t\t\tselection.removeAllRanges()\n\t\t\tselection.addRange(cursorRange)\n\t\t\t$(emptyElement).remove();\n\t\t},\n\t\tgetTextNodesIn: function (node)\n\t\t{\n\t\t\tvar textNodes = [];\n\n\t\t\tif (node.nodeType == 3) textNodes.push(node);\n\t\t\telse\n\t\t\t{\n\t\t\t\tvar children = node.childNodes;\n\t\t\t\tfor (var i = 0, len = children.length; i < len; ++i)\n\t\t\t\t{\n\t\t\t\t\ttextNodes.push.apply(textNodes, this.getTextNodesIn(children[i]));\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn textNodes;\n\t\t},\n\t\tgetCurrent: function()\n\t\t{\n\t\t\tvar el = false;\n\t\t\tvar sel = this.getSelection();\n\n\t\t\tif (sel && sel.rangeCount > 0)\n\t\t\t{\n\t\t\t\tel = sel.getRangeAt(0).startContainer;\n\n\t\t\t}\n\n\t\t\treturn this.isParentRedactor(el);\n\t\t},\n\t\tgetParent: function(elem)\n\t\t{\n\t\t\telem = elem || this.getCurrent();\n\t\t\tif (elem) return this.isParentRedactor( $( elem ).parent()[0] );\n\t\t\telse return false;\n\t\t},\n\t\tgetBlock: function(node)\n\t\t{\n\t\t\tif (typeof node === 'undefined') node = this.getCurrent();\n\n\t\t\twhile (node)\n\t\t\t{\n\t\t\t\tif (this.nodeTestBlocks(node))\n\t\t\t\t{\n\t\t\t\t\tif ($(node).hasClass('redactor_editor')) return false;\n\t\t\t\t\treturn node;\n\t\t\t\t}\n\n\t\t\t\tnode = node.parentNode;\n\t\t\t}\n\n\t\t\treturn false;\n\t\t},\n\t\tgetBlocks: function(nodes)\n\t\t{\n\t\t\tvar newnodes = [];\n\t\t\tif (typeof nodes == 'undefined')\n\t\t\t{\n\t\t\t\tvar range = this.getRange();\n\t\t\t\tif (range && range.collapsed === true) return [this.getBlock()];\n\t\t\t\tvar nodes = this.getNodes(range);\n\t\t\t}\n\n\t\t\t$.each(nodes, $.proxy(function(i,node)\n\t\t\t{\n\t\t\t\tif (this.opts.iframe === false && $(node).parents('div.redactor_editor').length == 0) return false;\n\t\t\t\tif (this.nodeTestBlocks(node)) newnodes.push(node);\n\n\t\t\t}, this));\n\n\t\t\tif (newnodes.length === 0) newnodes = [this.getBlock()];\n\n\t\t\treturn newnodes;\n\t\t},\n\t\tisInlineNode: function(node)\n\t\t{\n\t\t\tif (node.nodeType != 1) return false;\n\n\t\t\treturn !this.rTestBlock.test(node.nodeName);\n\t\t},\n\t\tnodeTestBlocks: function(node)\n\t\t{\n\t\t\treturn node.nodeType == 1 && this.rTestBlock.test(node.nodeName);\n\t\t},\n\t\ttagTestBlock: function(tag)\n\t\t{\n\t\t\treturn this.rTestBlock.test(tag);\n\t\t},\n\t\tgetNodes: function(range, tag)\n\t\t{\n\t\t\tif (typeof range == 'undefined' || range == false) var range = this.getRange();\n\t\t\tif (range && range.collapsed === true)\n\t\t\t{\n\t\t\t\tif (typeof tag === 'undefined' && this.tagTestBlock(tag))\n\t\t\t\t{\n\t\t\t\t\tvar block = this.getBlock();\n\t\t\t\t\tif (block.tagName == tag) return [block];\n\t\t\t\t\telse return [];\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\treturn [this.getCurrent()];\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tvar nodes = [], finalnodes = [];\n\n\t\t\tvar sel = this.document.getSelection();\n\t\t\tif (!sel.isCollapsed) nodes = this.getRangeSelectedNodes(sel.getRangeAt(0));\n\n\t\t\t$.each(nodes, $.proxy(function(i,node)\n\t\t\t{\n\t\t\t\tif (this.opts.iframe === false && $(node).parents('div.redactor_editor').length == 0) return false;\n\n\t\t\t\tif (typeof tag === 'undefined')\n\t\t\t\t{\n\t\t\t\t\tif ($.trim(node.textContent) != '')\n\t\t\t\t\t{\n\t\t\t\t\t\tfinalnodes.push(node);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse if (node.tagName == tag)\n\t\t\t\t{\n\t\t\t\t\tfinalnodes.push(node);\n\t\t\t\t}\n\n\t\t\t}, this));\n\n\t\t\tif (finalnodes.length == 0)\n\t\t\t{\n\t\t\t\tif (typeof tag === 'undefined' && this.tagTestBlock(tag))\n\t\t\t\t{\n\t\t\t\t\tvar block = this.getBlock();\n\t\t\t\t\tif (block.tagName == tag) return finalnodes.push(block);\n\t\t\t\t\telse return [];\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tfinalnodes.push(this.getCurrent());\n\t\t\t\t}\n\t\t\t}\n\t\t\tvar last = finalnodes[finalnodes.length-1];\n\t\t\tif (this.nodeTestBlocks(last))\n\t\t\t{\n\t\t\t\tfinalnodes = finalnodes.slice(0, -1);\n\t\t\t}\n\n\t\t\treturn finalnodes;\n\t\t},\n\t\tgetElement: function(node)\n\t\t{\n\t\t\tif (!node) node = this.getCurrent();\n\t\t\twhile (node)\n\t\t\t{\n\t\t\t\tif (node.nodeType == 1)\n\t\t\t\t{\n\t\t\t\t\tif ($(node).hasClass('redactor_editor')) return false;\n\t\t\t\t\treturn node;\n\t\t\t\t}\n\n\t\t\t\tnode = node.parentNode;\n\t\t\t}\n\n\t\t\treturn false;\n\t\t},\n\t\tgetRangeSelectedNodes: function(range)\n\t\t{\n\t\t\trange = range || this.getRange();\n\t\t\tvar node = range.startContainer;\n\t\t\tvar endNode = range.endContainer;\n\n\t\t\tif (node == endNode) return [node];\n\n\t\t\tvar rangeNodes = [];\n\t\t\twhile (node && node != endNode)\n\t\t\t{\n\t\t\t\trangeNodes.push(node = this.nextNode(node));\n\t\t\t}\n\n\t\t\tnode = range.startContainer;\n\t\t\twhile (node && node != range.commonAncestorContainer)\n\t\t\t{\n\t\t\t\trangeNodes.unshift(node);\n\t\t\t\tnode = node.parentNode;\n\t\t\t}\n\n\t\t\treturn rangeNodes;\n\t\t},\n\t\tnextNode: function(node)\n\t\t{\n\t\t\tif (node.hasChildNodes()) return node.firstChild;\n\t\t\telse\n\t\t\t{\n\t\t\t\twhile (node && !node.nextSibling)\n\t\t\t\t{\n\t\t\t\t\tnode = node.parentNode;\n\t\t\t\t}\n\n\t\t\t\tif (!node) return null;\n\t\t\t\treturn node.nextSibling;\n\t\t\t}\n\t\t},\n\t\tgetSelectionText: function()\n\t\t{\n\t\t\treturn this.getSelection().toString();\n\t\t},\n\t\tgetSelectionHtml: function()\n\t\t{\n\t\t\tvar html = '';\n\n\t\t\tvar sel = this.getSelection();\n\t\t\tif (sel.rangeCount)\n\t\t\t{\n\t\t\t\tvar container = this.document.createElement( \"div\" );\n\t\t\t\tvar len = sel.rangeCount;\n\t\t\t\tfor (var i = 0; i < len; ++i)\n\t\t\t\t{\n\t\t\t\t\tcontainer.appendChild(sel.getRangeAt(i).cloneContents());\n\t\t\t\t}\n\n\t\t\t\thtml = container.innerHTML;\n\t\t\t}\n\n\t\t\treturn this.syncClean(html);\n\t\t},\n\t\tselectionSave: function()\n\t\t{\n\t\t\tif (!this.isFocused())\n\t\t\t{\n\t\t\t\tthis.focusWithSaveScroll();\n\t\t\t}\n\n\t\t\tif (!this.opts.rangy)\n\t\t\t{\n\t\t\t\tthis.selectionCreateMarker(this.getRange());\n\t\t\t}\n\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.savedSel = rangy.saveSelection();\n\t\t\t}\n\t\t},\n\t\tselectionCreateMarker: function(range, remove)\n\t\t{\n\t\t\tif (!range) return;\n\n\t\t\tvar node1 = $('<span id=\"selection-marker-1\" class=\"redactor-selection-marker\">' + this.opts.invisibleSpace + '</span>', this.document)[0];\n\t\t\tvar node2 = $('<span id=\"selection-marker-2\" class=\"redactor-selection-marker\">' + this.opts.invisibleSpace + '</span>', this.document)[0];\n\n\t\t\tif (range.collapsed === true)\n\t\t\t{\n\t\t\t\tthis.selectionSetMarker(range, node1, true);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.selectionSetMarker(range, node1, true);\n\t\t\t\tthis.selectionSetMarker(range, node2, false);\n\t\t\t}\n\n\t\t\tthis.savedSel = this.$editor.html();\n\n\t\t\tthis.selectionRestore(false, false);\n\t\t},\n\t\tselectionSetMarker: function(range, node, type)\n\t\t{\n\t\t\tvar boundaryRange = range.cloneRange();\n\n\t\t\ttry {\n\t\t\t\tboundaryRange.collapse(type);\n\t\t\t\tboundaryRange.insertNode(node);\n\t\t\t\tboundaryRange.detach();\n\t\t\t}\n\t\t\tcatch (e)\n\t\t\t{\n\t\t\t\tvar html = this.opts.emptyHtml;\n\t\t\t\tif (this.opts.linebreaks) html = '<br>';\n\n\t\t\t\tthis.$editor.prepend(html);\n\t\t\t\tthis.focus();\n\t\t\t}\n\t\t},\n\t\tselectionRestore: function(replace, remove)\n\t\t{\n\t\t\tif (!this.opts.rangy)\n\t\t\t{\n\t\t\t\tif (replace === true && this.savedSel)\n\t\t\t\t{\n\t\t\t\t\tthis.$editor.html(this.savedSel);\n\t\t\t\t}\n\n\t\t\t\tvar node1 = this.$editor.find('span#selection-marker-1');\n\t\t\t\tvar node2 = this.$editor.find('span#selection-marker-2');\n\n\t\t\t\tif (this.browser('mozilla'))\n\t\t\t\t{\n\t\t\t\t\tthis.$editor.focus();\n\t\t\t\t}\n\t\t\t\telse if (!this.isFocused())\n\t\t\t\t{\n\t\t\t\t\tthis.focusWithSaveScroll();\n\t\t\t\t}\n\n\t\t\t\tif (node1.length != 0 && node2.length != 0)\n\t\t\t\t{\n\n\t\t\t\t\tthis.selectionSet(node1[0], 0, node2[0], 0);\n\t\t\t\t}\n\t\t\t\telse if (node1.length != 0)\n\t\t\t\t{\n\t\t\t\t\tthis.selectionSet(node1[0], 0, null, 0);\n\t\t\t\t}\n\n\t\t\t\tif (remove !== false)\n\t\t\t\t{\n\t\t\t\t\tthis.selectionRemoveMarkers();\n\t\t\t\t\tthis.savedSel = false;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\telse\n\t\t\t{\n\t\t\t\trangy.restoreSelection(this.savedSel);\n\t\t\t}\n\t\t},\n\t\tselectionRemoveMarkers: function(type)\n\t\t{\n\t\t\tif (!this.opts.rangy)\n\t\t\t{\n\t\t\t\t$.each(this.$editor.find('span.redactor-selection-marker'), function()\n\t\t\t\t{\n\t\t\t\t\tvar html = $.trim($(this).html().replace(/[^\\u0000-\\u1C7F]/g, ''));\n\t\t\t\t\tif (html == '')\n\t\t\t\t\t{\n\t\t\t\t\t\t$(this).remove();\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t$(this).removeAttr('class').removeAttr('id');\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\telse\n\t\t\t{\n\t\t\t\trangy.removeMarkers(this.savedSel);\n\t\t\t}\n\t\t},\n\t\ttableShow: function()\n\t\t{\n\t\t\tthis.selectionSave();\n\n\t\t\tthis.modalInit(this.opts.curLang.table, this.opts.modal_table, 300, $.proxy(function()\n\t\t\t{\n\t\t\t\t$('#redactor_insert_table_btn').on('click', $.proxy(this.tableInsert, this));\n\n\t\t\t\tsetTimeout(function()\n\t\t\t\t{\n\t\t\t\t\t$('#redactor_table_rows').focus();\n\n\t\t\t\t}, 200);\n\n\t\t\t}, this));\n\t\t},\n\t\ttableInsert: function()\n\t\t{\n\t\t\tthis.bufferSet(false);\n\n\t\t\tvar rows = $('#redactor_table_rows').val(),\n\t\t\t\tcolumns = $('#redactor_table_columns').val(),\n\t\t\t\t$table_box = $('<div></div>'),\n\t\t\t\ttableId = Math.floor(Math.random() * 99999),\n\t\t\t\t$table = $('<table id=\"table' + tableId + '\"><tbody></tbody></table>'),\n\t\t\t\ti, $row, z, $column;\n\n\t\t\tfor (i = 0; i < rows; i++)\n\t\t\t{\n\t\t\t\t$row = $('<tr></tr>');\n\n\t\t\t\tfor (z = 0; z < columns; z++)\n\t\t\t\t{\n\t\t\t\t\t$column = $('<td>' + this.opts.invisibleSpace + '</td>');\n\t\t\t\t\tif (i === 0 && z === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\t$column.append('<span id=\"selection-marker-1\">' + this.opts.invisibleSpace + '</span>');\n\t\t\t\t\t}\n\n\t\t\t\t\t$($row).append($column);\n\t\t\t\t}\n\n\t\t\t\t$table.append($row);\n\t\t\t}\n\n\t\t\t$table_box.append($table);\n\t\t\tvar html = $table_box.html();\n\n\t\t\tif (this.opts.linebreaks === false && this.browser('mozilla'))\n\t\t\t{\n\t\t\t\thtml += '<p>' + this.opts.invisibleSpace + '</p>';\n\t\t\t}\n\n\t\t\tthis.modalClose();\n\t\t\tthis.selectionRestore();\n\n\t\t\tvar current = this.getBlock() || this.getCurrent();\n\n\t\t\tif (current && current.tagName != 'BODY')\n\t\t\t{\n\t\t\t\tif (current.tagName == 'LI')\n\t\t\t\t{\n\t\t\t\t\tvar current = $(current).closest('ul, ol');\n\t\t\t\t}\n\n\t\t\t\t$(current).after(html)\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\n\t\t\t\tthis.insertHtmlAdvanced(html, false);\n\t\t\t}\n\n\t\t\tthis.selectionRestore();\n\n\t\t\tvar table = this.$editor.find('#table' + tableId);\n\t\t\tthis.buttonActiveObserver();\n\n\t\t\ttable.find('span#selection-marker-1, inline#selection-marker-1').remove();\n\t\t\ttable.removeAttr('id');\n\n\t\t\tthis.sync();\n\t\t},\n\t\ttableDeleteTable: function()\n\t\t{\n\t\t\tvar $table = $(this.getParent()).closest('table');\n\t\t\tif (!this.isParentRedactor($table)) return false;\n\t\t\tif ($table.length == 0) return false;\n\n\t\t\tthis.bufferSet();\n\n\t\t\t$table.remove();\n\t\t\tthis.sync();\n\t\t},\n\t\ttableDeleteRow: function()\n\t\t{\n\t\t\tvar parent = this.getParent();\n\t\t\tvar $table = $(parent).closest('table');\n\t\t\tif (!this.isParentRedactor($table)) return false;\n\t\t\tif ($table.length == 0) return false;\n\n\t\t\tthis.bufferSet();\n\n\t\t\tvar $current_tr = $(parent).closest('tr');\n\t\t\tvar $focus_tr = $current_tr.prev().length ? $current_tr.prev() : $current_tr.next();\n\t\t\tif ($focus_tr.length)\n\t\t\t{\n\t\t\t\tvar $focus_td = $focus_tr.children('td' ).first();\n\t\t\t\tif ($focus_td.length)\n\t\t\t\t{\n\t\t\t\t\t$focus_td.prepend('<span id=\"selection-marker-1\">' + this.opts.invisibleSpace + '</span>');\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t$current_tr.remove();\n\t\t\tthis.selectionRestore();\n\t\t\t$table.find('span#selection-marker-1').remove();\n\t\t\tthis.sync();\n\t\t},\n\t\ttableDeleteColumn: function()\n\t\t{\n\t\t\tvar parent = this.getParent();\n\t\t\tvar $table = $(parent).closest('table');\n\n\t\t\tif (!this.isParentRedactor($table)) return false;\n\t\t\tif ($table.length == 0) return false;\n\n\t\t\tthis.bufferSet();\n\n\t\t\tvar $current_td = $(parent).closest('td');\n\t\t\tif (!($current_td.is('td')))\n\t\t\t{\n\t\t\t\t$current_td = $current_td.closest('td');\n\t\t\t}\n\n\t\t\tvar index = $current_td.get(0).cellIndex;\n\t\t\t$table.find('tr').each($.proxy(function(i, elem)\n\t\t\t{\n\t\t\t\tvar focusIndex = index - 1 < 0 ? index + 1 : index - 1;\n\t\t\t\tif (i === 0)\n\t\t\t\t{\n\t\t\t\t\t$(elem).find('td').eq(focusIndex).prepend('<span id=\"selection-marker-1\">' + this.opts.invisibleSpace + '</span>');\n\t\t\t\t}\n\n\t\t\t\t$(elem).find('td').eq(index).remove();\n\n\t\t\t}, this));\n\n\t\t\tthis.selectionRestore();\n\t\t\t$table.find('span#selection-marker-1').remove();\n\t\t\tthis.sync();\n\t\t},\n\t\ttableAddHead: function()\n\t\t{\n\t\t\tvar $table = $(this.getParent()).closest('table');\n\t\t\tif (!this.isParentRedactor($table)) return false;\n\t\t\tif ($table.length == 0) return false;\n\n\t\t\tthis.bufferSet();\n\n\t\t\tif ($table.find('thead').length !== 0) this.tableDeleteHead();\n\t\t\telse\n\t\t\t{\n\t\t\t\tvar tr = $table.find('tr').first().clone();\n\t\t\t\ttr.find('td').replaceWith('<th></th>').html(this.opts.invisibleSpace);\n\t\t\t\t$thead = $('<thead></thead>');\n\t\t\t\t$thead.append(tr);\n\t\t\t\t$table.prepend($thead);\n\n\t\t\t\tthis.sync();\n\t\t\t}\n\t\t},\n\t\ttableDeleteHead: function()\n\t\t{\n\t\t\tvar $table = $(this.getParent()).closest('table');\n\t\t\tif (!this.isParentRedactor($table)) return false;\n\t\t\tvar $thead = $table.find('thead');\n\n\t\t\tif ($thead.length == 0) return false;\n\n\t\t\tthis.bufferSet();\n\n\t\t\t$thead.remove();\n\t\t\tthis.sync();\n\t\t},\n\t\ttableAddRowAbove: function()\n\t\t{\n\t\t\tthis.tableAddRow('before');\n\t\t},\n\t\ttableAddRowBelow: function()\n\t\t{\n\t\t\tthis.tableAddRow('after');\n\t\t},\n\t\ttableAddColumnLeft: function()\n\t\t{\n\t\t\tthis.tableAddColumn('before');\n\t\t},\n\t\ttableAddColumnRight: function()\n\t\t{\n\t\t\tthis.tableAddColumn('after');\n\t\t},\n\t\ttableAddRow: function(type)\n\t\t{\n\t\t\tvar $table = $(this.getParent()).closest('table');\n\t\t\tif (!this.isParentRedactor($table)) return false;\n\t\t\tif ($table.length == 0) return false;\n\n\t\t\tthis.bufferSet();\n\n\t\t\tvar $current_tr = $(this.getParent()).closest('tr');\n\t\t\tvar new_tr = $current_tr.clone();\n\t\t\tnew_tr.find('td').html(this.opts.invisibleSpace);\n\n\t\t\tif (type === 'after') $current_tr.after(new_tr);\n\t\t\telse $current_tr.before(new_tr);\n\n\t\t\tthis.sync();\n\t\t},\n\t\ttableAddColumn: function (type)\n\t\t{\n\t\t\tvar parent = this.getParent();\n\t\t\tvar $table = $(parent).closest('table');\n\n\t\t\tif (!this.isParentRedactor($table)) return false;\n\t\t\tif ($table.length == 0) return false;\n\n\t\t\tthis.bufferSet();\n\n\t\t\tvar index = 0;\n\n\t\t\tvar current = this.getCurrent();\n\t\t\tvar $current_tr = $(current).closest('tr');\n\t\t\tvar $current_td =  $(current).closest('td');\n\n\t\t\t$current_tr.find('td').each($.proxy(function(i, elem)\n\t\t\t{\n\t\t\t\tif ($(elem)[0] === $current_td[0]) index = i;\n\n\t\t\t}, this));\n\n\t\t\t$table.find('tr').each($.proxy(function(i, elem)\n\t\t\t{\n\t\t\t\tvar $current = $(elem).find('td').eq(index);\n\n\t\t\t\tvar td = $current.clone();\n\t\t\t\ttd.html(this.opts.invisibleSpace);\n\n\t\t\t\ttype === 'after' ? $current.after(td) : $current.before(td);\n\n\t\t\t}, this));\n\n\t\t\tthis.sync();\n\t\t},\n\t\tvideoShow: function()\n\t\t{\n\t\t\tthis.selectionSave();\n\n\t\t\tthis.modalInit(this.opts.curLang.video, this.opts.modal_video, 600, $.proxy(function()\n\t\t\t{\n\t\t\t\t$('#redactor_insert_video_btn').on('click', $.proxy(this.videoInsert, this));\n\n\t\t\t\tsetTimeout(function()\n\t\t\t\t{\n\t\t\t\t\t$('#redactor_insert_video_area').focus();\n\n\t\t\t\t}, 200);\n\n\t\t\t}, this));\n\t\t},\n\t\tvideoInsert: function ()\n\t\t{\n\t\t\tvar data = $('#redactor_insert_video_area').val();\n\t\t\tdata = this.cleanStripTags(data);\n\t\t\tvar iframeStart = '<iframe width=\"500\" height=\"281\" src=\"',\n\t\t\t\tiframeEnd = '\" frameborder=\"0\" allowfullscreen></iframe>';\n\n\t\t\tif (data.match(reUrlYoutube))\n\t\t\t{\n\t\t\t\tdata = data.replace(reUrlYoutube, iframeStart + '//www.youtube.com/embed/$1' + iframeEnd);\n\t\t\t}\n\t\t\telse if (data.match(reUrlVimeo))\n\t\t\t{\n\t\t\t\tdata = data.replace(reUrlVimeo, iframeStart + '//player.vimeo.com/video/$2' + iframeEnd);\n\t\t\t}\n            else if (data.match(reUrlFacebook))\n            {\n                data = data.replace(reUrlFacebook, iframeStart + 'https://www.facebook.com/video/embed?video_id=$1' + iframeEnd);\n            }\n\t\t\telse if (data.match(reUrlRutube))\n            {\n                data = data.replace(reUrlRutube, iframeStart + '//rutube.ru/play/embed/$1' + iframeEnd);\n            }\n\n\t\t\tthis.selectionRestore();\n\n\t\t\tvar current = this.getBlock() || this.getCurrent();\n\n\t\t\tif (current) $(current).after(data)\n\t\t\telse this.insertHtmlAdvanced(data, false);\n\n\t\t\tthis.sync();\n\t\t\tthis.modalClose();\n\t\t},\n\n\t\tlinkShow: function()\n\t\t{\n\t\t\tthis.selectionSave();\n\n\t\t\tvar callback = $.proxy(function()\n\t\t\t{\n\n\t\t\t\tif (this.opts.predefinedLinks !== false)\n\t\t\t\t{\n\t\t\t\t\tthis.predefinedLinksStorage = {};\n\t\t\t\t\tvar that = this;\n\t\t\t\t\t$.getJSON(this.opts.predefinedLinks, function(data)\n\t\t\t\t\t{\n                        if(Object.keys(data).length === 0){ return; }\n\t\t\t\t\t\tvar $select = $('#redactor-predefined-links');\n\t\t\t\t\t\t$select .html('');\n\t\t\t\t\t\t$.each(data, function(key, val)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthat.predefinedLinksStorage[key] = val;\n\t\t\t\t\t\t\t$select.append($('<option>').val(key).html(val.name));\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\t$select.on('change', function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar key = $(this).val();\n\t\t\t\t\t\t\tvar name = '', url = '';\n\t\t\t\t\t\t\tif (key != 0)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tname = that.predefinedLinksStorage[key].name;\n\t\t\t\t\t\t\t\turl = that.predefinedLinksStorage[key].url;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t$('#redactor_link_url').val(url);\n                            if($('#redactor_link_url_text').data('is_selected_text') != 1){\n                                $('#redactor_link_url_text').val(name);\n                            }\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\t$select.show();\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tthis.insert_link_node = false;\n\n\t\t\t\tvar sel = this.getSelection();\n\t\t\t\tvar url = '', text = '', target = '';\n\n\t\t\t\tvar elem = this.getParent();\n\t\t\t\tvar par = $(elem).parent().get(0);\n\t\t\t\tif (par && par.tagName === 'A')\n\t\t\t\t{\n\t\t\t\t\telem = par;\n\t\t\t\t}\n\n\t\t\t\tif (elem && elem.tagName === 'A')\n\t\t\t\t{\n\t\t\t\t\turl = elem.href;\n\t\t\t\t\ttext = $(elem).text();\n\t\t\t\t\ttarget = elem.target;\n\n\t\t\t\t\tthis.insert_link_node = elem;\n\t\t\t\t}\n\t\t\t\telse text = sel.toString();\n\n\t\t\t\t$('#redactor_link_url_text').val(text);\n                if(text.length > 0){\n                    $('#redactor_link_url_text').data('is_selected_text', 1);\n                }\n\n\t\t\t\tvar thref = self.location.href.replace(/\\/$/i, '');\n\t\t\t\turl = url.replace(thref, '');\n\t\t\t\turl = url.replace(/^\\/#/, '#');\n\t\t\t\turl = url.replace('mailto:', '');\n\t\t\t\tif (this.opts.linkProtocol === false)\n\t\t\t\t{\n\t\t\t\t\tvar re = new RegExp('^(http|ftp|https)://' + self.location.host, 'i');\n\t\t\t\t\turl = url.replace(re, '');\n\t\t\t\t}\n\t\t\t\t$('#redactor_link_url').val(url);\n\n\t\t\t\tif (target === '_blank')\n\t\t\t\t{\n\t\t\t\t\t$('#redactor_link_blank').prop('checked', true);\n\t\t\t\t}\n\n\t\t\t\tthis.linkInsertPressed = false;\n\t\t\t\t$('#redactor_insert_link_btn').on('click', $.proxy(this.linkProcess, this));\n\t\t\t\tsetTimeout(function()\n\t\t\t\t{\n\t\t\t\t\t$('#redactor_link_url').focus();\n\n\t\t\t\t}, 200);\n\n\t\t\t}, this);\n\n\t\t\tthis.modalInit(this.opts.curLang.link, this.opts.modal_link, 460, callback);\n\n\t\t},\n\t\tlinkProcess: function()\n\t\t{\n\t\t\tif (this.linkInsertPressed)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.linkInsertPressed = true;\n\t\t\tvar target = '', targetBlank = '';\n\n\t\t\tvar link = $('#redactor_link_url').val();\n\t\t\tvar text = $('#redactor_link_url_text').val();\n\t\t\tif (link.search('@') != -1 && /(http|ftp|https):\\/\\//i.test(link) === false)\n\t\t\t{\n\t\t\t\tlink = 'mailto:' + link;\n\t\t\t}\n\n\t\t\telse if (link.search('#') != 0)\n\t\t\t{\n\t\t\t\tif ($('#redactor_link_blank').prop('checked'))\n\t\t\t\t{\n\t\t\t\t\ttarget = ' target=\"_blank\"';\n\t\t\t\t\ttargetBlank = '_blank';\n\t\t\t\t}\n\t\t\t\tvar pattern = '((xn--)?[a-z0-9]+(-[a-z0-9]+)*\\.)+[a-z]{2,}';\n\t\t\t\tvar re = new RegExp('^(http|ftp|https)://' + pattern, 'i');\n\t\t\t\tvar re2 = new RegExp('^' + pattern, 'i');\n\n\t\t\t\tif (link.search(re) == -1 && link.search(re2) == 0 && this.opts.linkProtocol)\n\t\t\t\t{\n\t\t\t\t\tlink = this.opts.linkProtocol + link;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\ttext = text.replace(/<|>/g, '');\n\t\t\tvar extra = '&nbsp;';\n\t\t\tif (this.browser('mozilla'))\n\t\t\t{\n\t\t\t\textra = '&nbsp;';\n\t\t\t}\n\n\t\t\tthis.linkInsert('<a href=\"' + link + '\"' + target + '>' + text + '</a>' + extra, $.trim(text), link, targetBlank);\n\n\t\t},\n\t\tlinkInsert: function (a, text, link, target)\n\t\t{\n\t\t\tthis.selectionRestore();\n\n\t\t\tif (text !== '')\n\t\t\t{\n\t\t\t\tif (this.insert_link_node)\n\t\t\t\t{\n\t\t\t\t\tthis.bufferSet();\n\n\t\t\t\t\t$(this.insert_link_node).text(text).attr('href', link);\n\n\t\t\t\t\tif (target !== '')\n\t\t\t\t\t{\n\t\t\t\t\t\t$(this.insert_link_node).attr('target', target);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t$(this.insert_link_node).removeAttr('target');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tvar $a = $(a).addClass('redactor-added-link');\n\t\t\t\t\tthis.exec('inserthtml', this.outerHtml($a), false);\n\n\t\t\t\t\tvar link = this.$editor.find('a.redactor-added-link');\n\n\t\t\t\t\tlink.removeAttr('style').removeClass('redactor-added-link').each(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tif (this.className == '') $(this).removeAttr('class');\n\t\t\t\t\t});\n\n\t\t\t\t}\n\n\t\t\t\tthis.sync();\n\t\t\t}\n\t\t\tsetTimeout($.proxy(function()\n\t\t\t{\n\t\t\t\tif (this.opts.observeLinks) this.observeLinks();\n\n\t\t\t}, this), 5);\n\n\t\t\tthis.modalClose();\n\t\t},\n\t\tfileShow: function ()\n\t\t{\n\n\t\t\tthis.selectionSave();\n\n\t\t\tvar callback = $.proxy(function()\n\t\t\t{\n\t\t\t\tvar sel = this.getSelection();\n\n\t\t\t\tvar text = '';\n\t\t\t\tif (this.oldIE()) text = sel.text;\n\t\t\t\telse text = sel.toString();\n\n\t\t\t\t$('#redactor_filename').val(text);\n\t\t\t\tif (!this.isMobile() && !this.isIPad())\n\t\t\t\t{\n\t\t\t\t\tthis.draguploadInit('#redactor_file', {\n\t\t\t\t\t\turl: this.opts.fileUpload,\n\t\t\t\t\t\tuploadFields: this.opts.uploadFields,\n\t\t\t\t\t\tsuccess: $.proxy(this.fileCallback, this),\n\t\t\t\t\t\terror: $.proxy( function(obj, json)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.callback('fileUploadError', json);\n\n\t\t\t\t\t\t}, this),\n\t\t\t\t\t\tuploadParam: this.opts.fileUploadParam\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tthis.uploadInit('redactor_file', {\n\t\t\t\t\tauto: true,\n\t\t\t\t\turl: this.opts.fileUpload,\n\t\t\t\t\tsuccess: $.proxy(this.fileCallback, this),\n\t\t\t\t\terror: $.proxy(function(obj, json)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.callback('fileUploadError', json);\n\n\t\t\t\t\t}, this)\n\t\t\t\t});\n\n\t\t\t}, this);\n\n\t\t\tthis.modalInit(this.opts.curLang.file, this.opts.modal_file, 500, callback);\n\t\t},\n\t\tfileCallback: function(json)\n\t\t{\n\n\t\t\tthis.selectionRestore();\n\n\t\t\tif (json !== false)\n\t\t\t{\n\n\t\t\t\tvar text = $('#redactor_filename').val();\n\t\t\t\tif (text === '') text = json.filename;\n\n\t\t\t\tvar link = '<a href=\"' + json.filelink + '\" id=\"filelink-marker\">' + text + '</a>';\n\t\t\t\tif (this.browser('webkit') && !!this.window.chrome)\n\t\t\t\t{\n\t\t\t\t\tlink = link + '&nbsp;';\n\t\t\t\t}\n\n\t\t\t\tthis.execCommand('inserthtml', link, false);\n\n\t\t\t\tvar linkmarker = $(this.$editor.find('a#filelink-marker'));\n\t\t\t\tif (linkmarker.length != 0) linkmarker.removeAttr('id');\n\t\t\t\telse linkmarker = false;\n\n\t\t\t\tthis.sync();\n\t\t\t\tthis.callback('fileUpload', linkmarker, json);\n\t\t\t}\n\n\t\t\tthis.modalClose();\n\t\t},\n\t\timageShow: function()\n\t\t{\n\n\t\t\tthis.selectionSave();\n\n\t\t\tvar callback = $.proxy(function()\n\t\t\t{\n\n\t\t\t\tif (this.opts.imageGetJson)\n\t\t\t\t{\n\n\t\t\t\t\t$.getJSON(this.opts.imageGetJson, $.proxy(function(data)\n\t\t\t\t\t{\n                        if(data.error){\n                            alert(data.message); return;\n                        }\n\t\t\t\t\t\tvar folders = {}, count = 0;\n\t\t\t\t\t\t$.each(data, $.proxy(function(key, val)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif (typeof val.folder !== 'undefined')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tcount++;\n\t\t\t\t\t\t\t\tfolders[val.folder] = count;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t}, this));\n\n                        $('#redactor_image_box .empty_list').show();\n\t\t\t\t\t\tvar folderclass = false;\n\t\t\t\t\t\t$.each(data, $.proxy(function(key, val)\n\t\t\t\t\t\t{\n\n\t\t\t\t\t\t\tvar thumbtitle = '';\n\t\t\t\t\t\t\tif (typeof val.title !== 'undefined') thumbtitle = val.title;\n\n\t\t\t\t\t\t\tvar folderkey = 0;\n\t\t\t\t\t\t\tif (!$.isEmptyObject(folders) && typeof val.folder !== 'undefined')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tfolderkey = folders[val.folder];\n\t\t\t\t\t\t\t\tif (folderclass === false) folderclass = '.redactorfolder' + folderkey;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tvar img = $('<img src=\"' + val.thumb + '\" class=\"redactorfolder redactorfolder' + folderkey + '\" rel=\"' + val.image + '\" title=\"' + thumbtitle + '\" />');\n\t\t\t\t\t\t\t$('#redactor_image_box').append(img);\n\t\t\t\t\t\t\t$(img).on('click', $.proxy(this.imageThumbClick, this));\n                            $('#redactor_image_box .empty_list').hide();\n\t\t\t\t\t\t}, this));\n\t\t\t\t\t\tif (!$.isEmptyObject(folders))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$('.redactorfolder').hide();\n\t\t\t\t\t\t\t$(folderclass).show();\n\n\t\t\t\t\t\t\tvar onchangeFunc = function(e)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$('.redactorfolder').hide();\n\t\t\t\t\t\t\t\t$('.redactorfolder' + $(e.target).val()).show();\n\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\tvar select = $('<select id=\"redactor_image_box_select\">');\n\t\t\t\t\t\t\t$.each( folders, function(k, v)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tselect.append( $('<option value=\"' + v + '\">' + k + '</option>'));\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t$('#redactor_image_box').before(select);\n\t\t\t\t\t\t\tselect.change(onchangeFunc);\n\t\t\t\t\t\t}\n\t\t\t\t\t}, this));\n\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$('#redactor-tab-control-2').remove();\n\t\t\t\t}\n\n\t\t\t\tif (this.opts.imageUpload || this.opts.s3)\n\t\t\t\t{\n\n\t\t\t\t\tif (!this.isMobile()  && !this.isIPad() && this.opts.s3 === false)\n\t\t\t\t\t{\n\t\t\t\t\t\tif ($('#redactor_file' ).length)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.draguploadInit('#redactor_file', {\n\t\t\t\t\t\t\t\turl: this.opts.imageUpload,\n\t\t\t\t\t\t\t\tuploadFields: this.opts.uploadFields,\n\t\t\t\t\t\t\t\tsuccess: $.proxy(this.imageCallback, this),\n\t\t\t\t\t\t\t\terror: $.proxy(function(obj, json)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tthis.callback('imageUploadError', json);\n\n\t\t\t\t\t\t\t\t}, this),\n\t\t\t\t\t\t\t\tuploadParam: this.opts.imageUploadParam\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.opts.s3 === false)\n\t\t\t\t\t{\n\n\t\t\t\t\t\tthis.uploadInit('redactor_file', {\n\t\t\t\t\t\t\tauto: true,\n\t\t\t\t\t\t\turl: this.opts.imageUpload,\n\t\t\t\t\t\t\tsuccess: $.proxy(this.imageCallback, this),\n\t\t\t\t\t\t\terror: $.proxy(function(obj, json)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tthis.callback('imageUploadError', json);\n\n\t\t\t\t\t\t\t}, this)\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t$('#redactor_file').on('change.redactor', $.proxy(this.s3handleFileSelect, this));\n\t\t\t\t\t}\n\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$('.redactor_tab').hide();\n\t\t\t\t\tif (!this.opts.imageGetJson)\n\t\t\t\t\t{\n\t\t\t\t\t\t$('#redactor_tabs').remove();\n\t\t\t\t\t\t$('#redactor_tab3').show();\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t$('#redactor-tab-control-1').remove();\n\t\t\t\t\t\t$('#redactor-tab-control-2').addClass('redactor_tabs_act');\n\t\t\t\t\t\t$('#redactor_tab2').show();\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (!this.opts.imageTabLink && (this.opts.imageUpload || this.opts.imageGetJson))\n\t\t\t\t{\n\t\t\t\t\t$('#redactor-tab-control-3').hide();\n\t\t\t\t}\n\n\t\t\t\t$('#redactor_upload_btn').on('click', $.proxy(this.imageCallbackLink, this));\n\n\t\t\t\tif (!this.opts.imageUpload && !this.opts.imageGetJson)\n\t\t\t\t{\n\t\t\t\t\tsetTimeout(function()\n\t\t\t\t\t{\n\t\t\t\t\t\t$('#redactor_file_link').focus();\n\n\t\t\t\t\t}, 200);\n\t\t\t\t}\n\n\t\t\t}, this);\n\n\t\t\tthis.modalInit(this.opts.curLang.image, this.opts.modal_image, 610, callback);\n\n\t\t},\n\t\timageEdit: function(image)\n\t\t{\n\t\t\tvar $el = image;\n\t\t\tvar parent = $el.parent().parent();\n\n\t\t\tvar callback = $.proxy(function()\n\t\t\t{\n\t\t\t\t$('#redactor_file_alt').val($el.attr('alt'));\n\t\t\t\t$('#redactor_image_edit_src').attr('href', $el.attr('src'));\n\n\t\t\t\tif ($el.css('display') == 'block' && $el.css('float') == 'none')\n\t\t\t\t{\n\t\t\t\t\t$('#redactor_form_image_align').val('center');\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$('#redactor_form_image_align').val($el.css('float'));\n\t\t\t\t}\n\n\t\t\t\tif ($(parent).get(0).tagName === 'A')\n\t\t\t\t{\n\t\t\t\t\t$('#redactor_file_link').val($(parent).attr('href'));\n\n\t\t\t\t\tif ($(parent).attr('target') == '_blank')\n\t\t\t\t\t{\n\t\t\t\t\t\t$('#redactor_link_blank').prop('checked', true);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t$('#redactor_image_delete_btn').on('click', $.proxy(function()\n\t\t\t\t{\n\t\t\t\t\tthis.imageRemove($el);\n\n\t\t\t\t}, this));\n\n\t\t\t\t$('#redactorSaveBtn').on('click', $.proxy(function()\n\t\t\t\t{\n\t\t\t\t\tthis.imageSave($el);\n\n\t\t\t\t}, this));\n\n\t\t\t}, this);\n\n\t\t\tthis.modalInit(this.opts.curLang.edit, this.opts.modal_image_edit, 380, callback);\n\n\t\t},\n\t\timageRemove: function(el)\n\t\t{\n\t\t\tvar parentLink = $(el).parent().parent();\n\t\t\tvar parent = $(el).parent();\n\t\t\tvar parentEl = false;\n\n\t\t\tif (parentLink.length && parentLink[0].tagName === 'A')\n\t\t\t{\n\t\t\t\tparentEl = true;\n\t\t\t\t$(parentLink).remove();\n\t\t\t}\n\t\t\telse if (parent.length && parent[0].tagName === 'A')\n\t\t\t{\n\t\t\t\tparentEl = true;\n\t\t\t\t$(parent).remove();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$(el).remove();\n\t\t\t}\n\n\t\t\tif (parent.length && parent[0].tagName === 'P')\n\t\t\t{\n\t\t\t\tthis.focusWithSaveScroll();\n\n\t\t\t\tif (parentEl === false) this.selectionStart(parent);\n\t\t\t}\n\t\t\tthis.callback('imageDelete', el);\n\n\t\t\tthis.modalClose();\n\t\t\tthis.sync();\n\t\t},\n\t\timageSave: function(el)\n\t\t{\n\t\t\tthis.imageResizeHide(false);\n\n\t\t\tvar $el = $(el);\n\t\t\tvar parent = $el.parent();\n\n\t\t\t$el.attr('alt', $('#redactor_file_alt').val());\n\n\t\t\tvar floating = $('#redactor_form_image_align').val();\n\t\t\tvar margin = '';\n\n\t\t\tif (floating === 'left')\n\t\t\t{\n\t\t\t\tmargin = '0 ' + this.opts.imageFloatMargin + ' ' + this.opts.imageFloatMargin + ' 0';\n\t\t\t\t$el.css({ 'float': 'left', 'margin': margin });\n\t\t\t}\n\t\t\telse if (floating === 'right')\n\t\t\t{\n\t\t\t\tmargin = '0 0 ' + this.opts.imageFloatMargin + ' ' + this.opts.imageFloatMargin + '';\n\t\t\t\t$el.css({ 'float': 'right', 'margin': margin });\n\t\t\t}\n\t\t\telse if (floating === 'center')\n\t\t\t{\n\t\t\t\t$el.css({ 'float': '', 'display': 'block', 'margin': 'auto' });\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$el.css({ 'float': '', 'display': '', 'margin': '' });\n\t\t\t}\n\t\t\tvar link = $.trim($('#redactor_file_link').val());\n\t\t\tif (link !== '')\n\t\t\t{\n\t\t\t\tvar target = false;\n\t\t\t\tif ($('#redactor_link_blank').prop('checked'))\n\t\t\t\t{\n\t\t\t\t\ttarget = true;\n\t\t\t\t}\n\n\t\t\t\tif (parent.get(0).tagName !== 'A')\n\t\t\t\t{\n\t\t\t\t\tvar a = $('<a href=\"' + link + '\">' + this.outerHtml(el) + '</a>');\n\n\t\t\t\t\tif (target)\n\t\t\t\t\t{\n\t\t\t\t\t\ta.attr('target', '_blank');\n\t\t\t\t\t}\n\n\t\t\t\t\t$el.replaceWith(a);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tparent.attr('href', link);\n\t\t\t\t\tif (target)\n\t\t\t\t\t{\n\t\t\t\t\t\tparent.attr('target', '_blank');\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tparent.removeAttr('target');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tif (parent.get(0).tagName === 'A')\n\t\t\t\t{\n\t\t\t\t\tparent.replaceWith(this.outerHtml(el));\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.modalClose();\n\t\t\tthis.observeImages();\n\t\t\tthis.sync();\n\n\t\t},\n\t\timageResizeHide: function(e)\n\t\t{\n\t\t\tif (e !== false && $(e.target).parent().length != 0 && $(e.target).parent()[0].id === 'redactor-image-box')\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tvar imageBox = this.$editor.find('#redactor-image-box');\n\t\t\tif (imageBox.length == 0)\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tthis.$editor.find('#redactor-image-editter, #redactor-image-resizer').remove();\n\n\t\t\timageBox.find('img').css({\n\t\t\t\tmarginTop: imageBox[0].style.marginTop,\n\t\t\t\tmarginBottom: imageBox[0].style.marginBottom,\n\t\t\t\tmarginLeft: imageBox[0].style.marginLeft,\n\t\t\t\tmarginRight: imageBox[0].style.marginRight\n\t\t\t});\n\n\t\t\timageBox.css('margin', '');\n\t\t\timageBox.find('img').css('opacity', '');\n\t\t\timageBox.replaceWith(function()\n\t\t\t{\n\t\t\t\treturn $(this).contents();\n\t\t\t});\n\n\t\t\t$(document).off('click.redactor-image-resize-hide');\n\t\t\tthis.$editor.off('click.redactor-image-resize-hide');\n\t\t\tthis.$editor.off('keydown.redactor-image-delete');\n\n\t\t\tthis.sync()\n\n\t\t},\n\t\timageResize: function(image)\n\t\t{\n\t\t\tvar $image = $(image);\n\n\t\t\t$image.on('mousedown', $.proxy(function()\n\t\t\t{\n\t\t\t\tthis.imageResizeHide(false);\n\t\t\t}, this));\n\n\t\t\t$image.on('dragstart', $.proxy(function()\n\t\t\t{\n\t\t\t\tthis.$editor.on('drop.redactor-image-inside-drop', $.proxy(function()\n\t\t\t\t{\n\t\t\t\t\tsetTimeout($.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.observeImages();\n\t\t\t\t\t\tthis.$editor.off('drop.redactor-image-inside-drop');\n\t\t\t\t\t\tthis.sync();\n\n\t\t\t\t\t}, this), 1);\n\n\t\t\t\t},this));\n\t\t\t}, this));\n\n\t\t\t$image.on('click', $.proxy(function(e)\n\t\t\t{\n\t\t\t\tif (this.$editor.find('#redactor-image-box').length != 0)\n\t\t\t\t{\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tvar clicked = false,\n\t\t\t\tstart_x,\n\t\t\t\tstart_y,\n\t\t\t\tratio = $image.width() / $image.height(),\n\t\t\t\tmin_w = 20,\n\t\t\t\tmin_h = 10;\n\n\t\t\t\tvar imageResizer = this.imageResizeControls($image);\n\t\t\t\tvar isResizing = false;\n\t\t\t\tif (imageResizer !== false)\n\t\t\t\t{\n\t\t\t\t\timageResizer.on('mousedown', function(e)\n\t\t\t\t\t{\n\t\t\t\t\t\tisResizing = true;\n\t\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t\tratio = $image.width() / $image.height();\n\n\t\t\t\t\t\tstart_x = Math.round(e.pageX - $image.eq(0).offset().left);\n\t\t\t\t\t\tstart_y = Math.round(e.pageY - $image.eq(0).offset().top);\n\n\t\t\t\t\t});\n\n\t\t\t\t\t$(this.document.body).on('mousemove', $.proxy(function(e)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (isResizing)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar mouse_x = Math.round(e.pageX - $image.eq(0).offset().left) - start_x;\n\t\t\t\t\t\t\tvar mouse_y = Math.round(e.pageY - $image.eq(0).offset().top) - start_y;\n\n\t\t\t\t\t\t\tvar div_h = $image.height();\n\n\t\t\t\t\t\t\tvar new_h = parseInt(div_h, 10) + mouse_y;\n\t\t\t\t\t\t\tvar new_w = Math.round(new_h * ratio);\n\n\t\t\t\t\t\t\tif (new_w > min_w)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$image.width(new_w);\n\n\t\t\t\t\t\t\t\tif (new_w < 100)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tthis.imageEditter.css({\n\t\t\t\t\t\t\t\t\t\tmarginTop: '-7px',\n\t\t\t\t\t\t\t\t\t\tmarginLeft: '-13px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '9px',\n\t\t\t\t\t\t\t\t\t\tpadding: '3px 5px'\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tthis.imageEditter.css({\n\t\t\t\t\t\t\t\t\t\tmarginTop: '-11px',\n\t\t\t\t\t\t\t\t\t\tmarginLeft: '-18px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\tpadding: '7px 10px'\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tstart_x = Math.round(e.pageX - $image.eq(0).offset().left);\n\t\t\t\t\t\t\tstart_y = Math.round(e.pageY - $image.eq(0).offset().top);\n\n\t\t\t\t\t\t\tthis.sync()\n\t\t\t\t\t\t}\n\t\t\t\t\t}, this)).on('mouseup', function()\n\t\t\t\t\t{\n\t\t\t\t\t\tisResizing = false;\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tthis.$editor.on('keydown.redactor-image-delete', $.proxy(function(e)\n\t\t\t\t{\n\t\t\t\t\tvar key = e.which;\n\n\t\t\t\t\tif (this.keyCode.BACKSPACE == key || this.keyCode.DELETE == key)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.bufferSet(false);\n\t\t\t\t\t\tthis.imageResizeHide(false);\n\t\t\t\t\t\tthis.imageRemove($image);\n\t\t\t\t\t}\n\n\t\t\t\t}, this));\n\n\t\t\t\t$(document).on('click.redactor-image-resize-hide', $.proxy(this.imageResizeHide, this));\n\t\t\t\tthis.$editor.on('click.redactor-image-resize-hide', $.proxy(this.imageResizeHide, this));\n\t\t\t}, this));\n\t\t},\n\t\timageResizeControls: function($image)\n\t\t{\n\t\t\tvar imageBox = $('<span id=\"redactor-image-box\" data-redactor=\"verified\">');\n\t\t\timageBox.css({\n\t\t\t\tposition: 'relative',\n\t\t\t\tdisplay: 'inline-block',\n\t\t\t\tlineHeight: 0,\n\t\t\t\toutline: '1px dashed rgba(0, 0, 0, .6)',\n\t\t\t\t'float': $image.css('float')\n\t\t\t});\n\t\t\timageBox.attr('contenteditable', false);\n\n\t\t\tif ($image[0].style.margin != 'auto')\n\t\t\t{\n\t\t\t\timageBox.css({\n\t\t\t\t\tmarginTop: $image[0].style.marginTop,\n\t\t\t\t\tmarginBottom: $image[0].style.marginBottom,\n\t\t\t\t\tmarginLeft: $image[0].style.marginLeft,\n\t\t\t\t\tmarginRight: $image[0].style.marginRight\n\t\t\t\t});\n\n\t\t\t\t$image.css('margin', '');\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\timageBox.css({ 'display': 'block', 'margin': 'auto' });\n\t\t\t}\n\n\t\t\t$image.css('opacity', .5).after(imageBox);\n\t\t\tthis.imageEditter = $('<span id=\"redactor-image-editter\" data-redactor=\"verified\">' + this.opts.curLang.edit + '</span>');\n\t\t\tthis.imageEditter.css({\n\t\t\t\tposition: 'absolute',\n\t\t\t\tzIndex: 5,\n\t\t\t\ttop: '50%',\n\t\t\t\tleft: '50%',\n\t\t\t\tmarginTop: '-11px',\n\t\t\t\tmarginLeft: '-18px',\n\t\t\t\tlineHeight: 1,\n\t\t\t\tbackgroundColor: '#000',\n\t\t\t\tcolor: '#fff',\n\t\t\t\tfontSize: '11px',\n\t\t\t\tpadding: '7px 10px',\n\t\t\t\tcursor: 'pointer'\n\t\t\t});\n\t\t\tthis.imageEditter.attr('contenteditable', false);\n\t\t\tthis.imageEditter.on('click', $.proxy(function()\n\t\t\t{\n\t\t\t\tthis.imageEdit($image);\n\t\t\t}, this));\n\t\t\timageBox.append(this.imageEditter);\n\t\t\tif (this.opts.imageResizable)\n\t\t\t{\n\t\t\t\tvar imageResizer = $('<span id=\"redactor-image-resizer\" data-redactor=\"verified\"></span>');\n\t\t\t\timageResizer.css({\n\t\t\t\t\tposition: 'absolute',\n\t\t\t\t\tzIndex: 2,\n\t\t\t\t\tlineHeight: 1,\n\t\t\t\t\tcursor: 'nw-resize',\n\t\t\t\t\tbottom: '-4px',\n\t\t\t\t\tright: '-5px',\n\t\t\t\t\tborder: '1px solid #fff',\n\t\t\t\t\tbackgroundColor: '#000',\n\t\t\t\t\twidth: '8px',\n\t\t\t\t\theight: '8px'\n\t\t\t\t});\n\t\t\t\timageResizer.attr('contenteditable', false);\n\t\t\t\timageBox.append(imageResizer);\n\n\t\t\t\timageBox.append($image);\n\n\t\t\t\treturn imageResizer;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\timageBox.append($image);\n\n\t\t\t\treturn false;\n\t\t\t}\n\t\t},\n\t\timageThumbClick: function(e)\n\t\t{\n\t\t\tvar img = '<img id=\"image-marker\" src=\"' + $(e.target).attr('rel') + '\" alt=\"' + $(e.target).attr('title') + '\" />';\n\n\t\t\tvar parent = this.getParent();\n\t\t\tif (this.opts.paragraphy && $(parent).closest('li').length == 0) img = '<p>' + img + '</p>';\n\n\t\t\tthis.imageInsert(img, true);\n\t\t},\n\t\timageCallbackLink: function()\n\t\t{\n\t\t\tvar val = $('#redactor_file_link').val();\n\n\t\t\tif (val !== '')\n\t\t\t{\n\t\t\t\tvar data = '<img id=\"image-marker\" src=\"' + val + '\" />';\n\t\t\t\tif (this.opts.linebreaks === false) data = '<p>' + data + '</p>';\n\n\t\t\t\tthis.imageInsert(data, true);\n\n\t\t\t}\n\t\t\telse this.modalClose();\n\t\t},\n\t\timageCallback: function(data)\n\t\t{\n\t\t\tthis.imageInsert(data);\n\t\t},\n\t\timageInsert: function(json, link)\n\t\t{\n\t\t\tthis.selectionRestore();\n\n\t\t\tif (json !== false)\n\t\t\t{\n\t\t\t\tvar html = '';\n\t\t\t\tif (link !== true)\n\t\t\t\t{\n\t\t\t\t\thtml = '<img id=\"image-marker\" src=\"' + json.image.url + '\" />';\n\n\t\t\t\t\tvar parent = this.getParent();\n\t\t\t\t\tif (this.opts.paragraphy && $(parent).closest('li').length == 0)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = '<p>' + html + '</p>';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\thtml = json;\n\t\t\t\t}\n\n\t\t\t\tthis.execCommand('inserthtml', html, false);\n\n\t\t\t\tvar image = $(this.$editor.find('img#image-marker'));\n\n\t\t\t\tif (image.length) image.removeAttr('id');\n\t\t\t\telse image = false;\n\n\t\t\t\tthis.sync();\n\t\t\t\tlink !== true && this.callback('imageUpload', image, json);\n\t\t\t}\n\n\t\t\tthis.modalClose();\n\t\t\tthis.observeImages();\n\t\t},\n\t\tbuildProgressBar: function()\n\t\t{\n\t\t\tif ($('#redactor-progress').length != 0) return;\n\n\t\t\tthis.$progressBar = $('<div id=\"redactor-progress\"><span></span></div>');\n\t\t\t$(document.body).append(this.$progressBar);\n\t\t},\n\t\tshowProgressBar: function()\n\t\t{\n\t\t\tthis.buildProgressBar();\n\t\t\t$('#redactor-progress').fadeIn();\n\t\t},\n\t\thideProgressBar: function()\n\t\t{\n\t\t\t$('#redactor-progress').fadeOut(1500);\n\t\t},\n\t\tmodalTemplatesInit: function()\n\t\t{\n\t\t\t$.extend( this.opts,\n\t\t\t{\n\t\t\t\tmodal_file: String()\n\t\t\t\t+ '<section id=\"redactor-modal-file-insert\">'\n\t\t\t\t\t+ '<form id=\"redactorUploadFileForm\" method=\"post\" action=\"\" enctype=\"multipart/form-data\">'\n\t\t\t\t\t\t+ '<label>' + this.opts.curLang.filename + '</label>'\n\t\t\t\t\t\t+ '<input type=\"text\" id=\"redactor_filename\" class=\"redactor_input\" />'\n\t\t\t\t\t\t+ '<div style=\"margin-top: 7px;\">'\n\t\t\t\t\t\t\t+ '<input type=\"file\" id=\"redactor_file\" name=\"' + this.opts.fileUploadParam + '\" />'\n\t\t\t\t\t\t+ '</div>'\n\t\t\t\t\t+ '</form>'\n\t\t\t\t+ '</section>',\n\n\t\t\t\tmodal_image_edit: String()\n\t\t\t\t+ '<section id=\"redactor-modal-image-edit\">'\n\t\t\t\t\t+ '<label>' + this.opts.curLang.title + '</label>'\n\t\t\t\t\t+ '<input type=\"text\" id=\"redactor_file_alt\" class=\"redactor_input\" />'\n\t\t\t\t\t+ '<label>' + this.opts.curLang.link + '</label>'\n\t\t\t\t\t+ '<input type=\"text\" id=\"redactor_file_link\" class=\"redactor_input\" />'\n\t\t\t\t\t+ '<label><input type=\"checkbox\" id=\"redactor_link_blank\"> ' + this.opts.curLang.link_new_tab + '</label>'\n\t\t\t\t\t+ '<label>' + this.opts.curLang.image_position + '</label>'\n\t\t\t\t\t+ '<select id=\"redactor_form_image_align\">'\n\t\t\t\t\t\t+ '<option value=\"none\">' + this.opts.curLang.none + '</option>'\n\t\t\t\t\t\t+ '<option value=\"left\">' + this.opts.curLang.left + '</option>'\n\t\t\t\t\t\t+ '<option value=\"center\">' + this.opts.curLang.center + '</option>'\n\t\t\t\t\t\t+ '<option value=\"right\">' + this.opts.curLang.right + '</option>'\n\t\t\t\t\t+ '</select>'\n\t\t\t\t+ '</section>'\n\t\t\t\t+ '<footer>'\n\t\t\t\t\t+ '<button id=\"redactor_image_delete_btn\" class=\"redactor_modal_btn redactor_modal_delete_btn\">' + this.opts.curLang._delete + '</button>'\n\t\t\t\t\t+ '<button class=\"redactor_modal_btn redactor_btn_modal_close\">' + this.opts.curLang.cancel + '</button>'\n\t\t\t\t\t+ '<button id=\"redactorSaveBtn\" class=\"redactor_modal_btn redactor_modal_action_btn\">' + this.opts.curLang.save + '</button>'\n\t\t\t\t+ '</footer>',\n\n\t\t\t\tmodal_image: String()\n\t\t\t\t+ '<section id=\"redactor-modal-image-insert\">'\n\t\t\t\t\t+ '<div id=\"redactor_tabs\">'\n\t\t\t\t\t\t+ '<a href=\"#\" id=\"redactor-tab-control-1\" class=\"redactor_tabs_act\">' + this.opts.curLang.upload + '</a>'\n\t\t\t\t\t\t+ '<a href=\"#\" id=\"redactor-tab-control-2\">' + this.opts.curLang.choose + '</a>'\n\t\t\t\t\t\t+ '<a href=\"#\" id=\"redactor-tab-control-3\">' + this.opts.curLang.link + '</a>'\n\t\t\t\t\t+ '</div>'\n\t\t\t\t\t+ '<form id=\"redactorInsertImageForm\" method=\"post\" action=\"\" enctype=\"multipart/form-data\">'\n\t\t\t\t\t\t+ '<div id=\"redactor_tab1\" class=\"redactor_tab\">'\n\t\t\t\t\t\t\t+ '<input type=\"file\" id=\"redactor_file\" name=\"' + this.opts.imageUploadParam + '\" />'\n\t\t\t\t\t\t+ '</div>'\n\t\t\t\t\t\t+ '<div id=\"redactor_tab2\" class=\"redactor_tab\" style=\"display: none;\">'\n\t\t\t\t\t\t\t+ '<div id=\"redactor_image_box\"><span class=\"empty_list\">' + this.opts.curLang.empty_img_list + '</span></div>'\n\t\t\t\t\t\t+ '</div>'\n\t\t\t\t\t+ '</form>'\n\t\t\t\t\t+ '<div id=\"redactor_tab3\" class=\"redactor_tab\" style=\"display: none;\">'\n\t\t\t\t\t\t+ '<label>' + this.opts.curLang.image_web_link + '</label>'\n\t\t\t\t\t\t+ '<input type=\"text\" name=\"redactor_file_link\" id=\"redactor_file_link\" class=\"redactor_input\"  /><br><br>'\n\t\t\t\t\t+ '</div>'\n\t\t\t\t+ '</section>'\n\t\t\t\t+ '<footer>'\n\t\t\t\t\t+ '<button class=\"redactor_modal_btn redactor_btn_modal_close\">' + this.opts.curLang.cancel + '</button>'\n\t\t\t\t\t+ '<button class=\"redactor_modal_btn redactor_modal_action_btn\" id=\"redactor_upload_btn\">' + this.opts.curLang.insert + '</button>'\n\t\t\t\t+ '</footer>',\n\n\t\t\t\tmodal_link: String()\n\t\t\t\t+ '<section id=\"redactor-modal-link-insert\">'\n\t\t\t\t\t+ '<select id=\"redactor-predefined-links\" style=\"width: 99.5%; display: none;\"></select>'\n\t\t\t\t\t+ '<label>URL</label>'\n\t\t\t\t\t+ '<input type=\"text\" class=\"redactor_input\" id=\"redactor_link_url\" />'\n\t\t\t\t\t+ '<label>' + this.opts.curLang.text + '</label>'\n\t\t\t\t\t+ '<input type=\"text\" class=\"redactor_input\" id=\"redactor_link_url_text\" />'\n\t\t\t\t\t+ '<label><input type=\"checkbox\" id=\"redactor_link_blank\"> ' + this.opts.curLang.link_new_tab + '</label>'\n\t\t\t\t+ '</section>'\n\t\t\t\t+ '<footer>'\n\t\t\t\t\t+ '<button class=\"redactor_modal_btn redactor_btn_modal_close\">' + this.opts.curLang.cancel + '</button>'\n\t\t\t\t\t+ '<button id=\"redactor_insert_link_btn\" class=\"redactor_modal_btn redactor_modal_action_btn\">' + this.opts.curLang.insert + '</button>'\n\t\t\t\t+ '</footer>',\n\n\t\t\t\tmodal_table: String()\n\t\t\t\t+ '<section id=\"redactor-modal-table-insert\">'\n\t\t\t\t\t+ '<label>' + this.opts.curLang.rows + '</label>'\n\t\t\t\t\t+ '<input type=\"text\" size=\"5\" value=\"2\" id=\"redactor_table_rows\" />'\n\t\t\t\t\t+ '<label>' + this.opts.curLang.columns + '</label>'\n\t\t\t\t\t+ '<input type=\"text\" size=\"5\" value=\"3\" id=\"redactor_table_columns\" />'\n\t\t\t\t+ '</section>'\n\t\t\t\t+ '<footer>'\n\t\t\t\t\t+ '<button class=\"redactor_modal_btn redactor_btn_modal_close\">' + this.opts.curLang.cancel + '</button>'\n\t\t\t\t\t+ '<button id=\"redactor_insert_table_btn\" class=\"redactor_modal_btn redactor_modal_action_btn\">' + this.opts.curLang.insert + '</button>'\n\t\t\t\t+ '</footer>',\n\n\t\t\t\tmodal_video: String()\n\t\t\t\t+ '<section id=\"redactor-modal-video-insert\">'\n\t\t\t\t\t+ '<form id=\"redactorInsertVideoForm\">'\n\t\t\t\t\t\t+ '<label>' + this.opts.curLang.video_html_code + '</label>'\n\t\t\t\t\t\t+ '<textarea id=\"redactor_insert_video_area\" style=\"width: 99%; height: 160px;\"></textarea>'\n\t\t\t\t\t+ '</form>'\n\t\t\t\t+ '</section>'\n\t\t\t\t+ '<footer>'\n\t\t\t\t\t+ '<button class=\"redactor_modal_btn redactor_btn_modal_close\">' + this.opts.curLang.cancel + '</button>'\n\t\t\t\t\t+ '<button id=\"redactor_insert_video_btn\" class=\"redactor_modal_btn redactor_modal_action_btn\">' + this.opts.curLang.insert + '</button>'\n\t\t\t\t+ '</footer>'\n\n\t\t\t});\n\t\t},\n\t\tmodalInit: function(title, content, width, callback)\n\t\t{\n\t\t\tthis.modalSetOverlay();\n\n\t\t\tthis.$redactorModalWidth = width;\n\t\t\tthis.$redactorModal = $('#redactor_modal');\n\n\t\t\tif (!this.$redactorModal.length)\n\t\t\t{\n\t\t\t\tthis.$redactorModal = $('<div id=\"redactor_modal\" style=\"display: none;\" />');\n\t\t\t\tthis.$redactorModal.append($('<div id=\"redactor_modal_close\">&times;</div>'));\n\t\t\t\tthis.$redactorModal.append($('<header id=\"redactor_modal_header\" />'));\n\t\t\t\tthis.$redactorModal.append($('<div id=\"redactor_modal_inner\" />'));\n\t\t\t\tthis.$redactorModal.appendTo(document.body);\n\t\t\t}\n\n\t\t\t$('#redactor_modal_close').on('click', $.proxy(this.modalClose, this));\n\t\t\t$(document).on('keyup', $.proxy(this.modalCloseHandler, this));\n\t\t\tthis.$editor.on('keyup', $.proxy(this.modalCloseHandler, this));\n\n\t\t\tthis.modalSetContent(content);\n\t\t\tthis.modalSetTitle(title);\n\t\t\tthis.modalSetDraggable();\n\t\t\tthis.modalLoadTabs();\n\t\t\tthis.modalOnCloseButton();\n\t\t\tthis.modalSetButtonsWidth();\n\n\t\t\tthis.saveModalScroll = this.document.body.scrollTop;\n\t\t\tif (this.opts.autoresize === false)\n\t\t\t{\n\t\t\t\tthis.saveModalScroll = this.$editor.scrollTop();\n\t\t\t}\n\n\t\t\tif (this.isMobile() === false) this.modalShowOnDesktop();\n\t\t\telse this.modalShowOnMobile();\n\t\t\tif (typeof callback === 'function')\n\t\t\t{\n\t\t\t\tcallback();\n\t\t\t}\n\t\t\tsetTimeout($.proxy(function()\n\t\t\t{\n\t\t\t\tthis.callback('modalOpened', this.$redactorModal);\n\n\t\t\t}, this), 11);\n\t\t\t$(document).off('focusin.modal');\n\t\t\tthis.$redactorModal.find('input[type=text]').on('keypress', $.proxy(function(e)\n\t\t\t{\n\t\t\t\tif (e.which === 13)\n\t\t\t\t{\n\t\t\t\t\tthis.$redactorModal.find('.redactor_modal_action_btn').trigger('click');\n\t\t\t\t\te.preventDefault();\n\t\t\t\t}\n\t\t\t}, this));\n\n\t\t\treturn this.$redactorModal;\n\n\t\t},\n\t\tmodalShowOnDesktop: function()\n\t\t{\n\t\t\tthis.$redactorModal.css({\n\t\t\t\tposition: 'fixed',\n\t\t\t\ttop: '-2000px',\n\t\t\t\tleft: '50%',\n\t\t\t\twidth: this.$redactorModalWidth + 'px',\n\t\t\t\tmarginLeft: '-' + (this.$redactorModalWidth / 2) + 'px'\n\t\t\t}).show();\n\n\t\t\tthis.modalSaveBodyOveflow = $(document.body).css('overflow');\n\t\t\t$(document.body).css('overflow', 'hidden');\n\n\t\t\tsetTimeout($.proxy(function()\n\t\t\t{\n\t\t\t\tvar height = this.$redactorModal.outerHeight();\n\t\t\t\tthis.$redactorModal.css({\n\t\t\t\t\ttop: '50%',\n\t\t\t\t\theight: 'auto',\n\t\t\t\t\tminHeight: 'auto',\n\t\t\t\t\tmarginTop: '-' + (height + 10) / 2 + 'px'\n\t\t\t\t});\n\t\t\t}, this), 15);\n\t\t},\n\t\tmodalShowOnMobile: function()\n\t\t{\n\t\t\tthis.$redactorModal.css({\n\t\t\t\tposition: 'fixed',\n\t\t\t\twidth: '100%',\n\t\t\t\theight: '100%',\n\t\t\t\ttop: '0',\n\t\t\t\tleft: '0',\n\t\t\t\tmargin: '0',\n\t\t\t\tminHeight: '300px'\n\t\t\t}).show();\n\t\t},\n\t\tmodalSetContent: function(content)\n\t\t{\n\t\t\tthis.modalcontent = false;\n\t\t\tif (content.indexOf('#') == 0)\n\t\t\t{\n\t\t\t\tthis.modalcontent = $(content);\n\t\t\t\t$('#redactor_modal_inner').empty().append(this.modalcontent.html());\n\t\t\t\tthis.modalcontent.html('');\n\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$('#redactor_modal_inner').empty().append(content);\n\t\t\t}\n\t\t},\n\t\tmodalSetTitle: function(title)\n\t\t{\n\t\t\tthis.$redactorModal.find('#redactor_modal_header').html(title);\n\t\t},\n\t\tmodalSetButtonsWidth: function(){},\n\t\tmodalOnCloseButton: function()\n\t\t{\n\t\t\tthis.$redactorModal.find('.redactor_btn_modal_close').on('click', $.proxy(this.modalClose, this));\n\t\t},\n\t\tmodalSetOverlay: function()\n\t\t{\n\t\t\tif (this.opts.modalOverlay)\n\t\t\t{\n\t\t\t\tthis.$redactorModalOverlay = $('#redactor_modal_overlay');\n\t\t\t\tif (!this.$redactorModalOverlay.length)\n\t\t\t\t{\n\t\t\t\t\tthis.$redactorModalOverlay = $('<div id=\"redactor_modal_overlay\" style=\"display: none;\"></div>');\n\t\t\t\t\t$('body').prepend(this.$redactorModalOverlay);\n\t\t\t\t}\n\n\t\t\t\tthis.$redactorModalOverlay.show().on('click', $.proxy(this.modalClose, this));\n\t\t\t}\n\t\t},\n\t\tmodalSetDraggable: function()\n\t\t{\n\t\t\tif (typeof $.fn.draggable !== 'undefined')\n\t\t\t{\n\t\t\t\tthis.$redactorModal.draggable({ handle: '#redactor_modal_header' });\n\t\t\t\tthis.$redactorModal.find('#redactor_modal_header').css('cursor', 'move');\n\t\t\t}\n\t\t},\n\t\tmodalLoadTabs: function()\n\t\t{\n\t\t\tvar $redactor_tabs = $('#redactor_tabs');\n\t\t\tif (!$redactor_tabs.length) return false;\n\n\t\t\tvar that = this;\n\t\t\t$redactor_tabs.find('a').each(function(i, s)\n\t\t\t{\n\t\t\t\ti++;\n\t\t\t\t$(s).on('click', function(e)\n\t\t\t\t{\n\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t$redactor_tabs.find('a').removeClass('redactor_tabs_act');\n\t\t\t\t\t$(this).addClass('redactor_tabs_act');\n\t\t\t\t\t$('.redactor_tab').hide();\n\t\t\t\t\t$('#redactor_tab' + i ).show();\n\t\t\t\t\t$('#redactor_tab_selected').val(i);\n\n\t\t\t\t\tif (that.isMobile() === false)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar height = that.$redactorModal.outerHeight();\n\t\t\t\t\t\tthat.$redactorModal.css('margin-top', '-' + (height + 10) / 2 + 'px');\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\n\t\t},\n\t\tmodalCloseHandler: function(e)\n\t\t{\n\t\t\tif (e.keyCode === this.keyCode.ESC)\n\t\t\t{\n\t\t\t\tthis.modalClose();\n\t\t\t\treturn false;\n\t\t\t}\n\t\t},\n\t\tmodalClose: function()\n\t\t{\n\t\t\t$('#redactor_modal_close').off('click', this.modalClose);\n\t\t\t$('#redactor_modal').fadeOut('fast', $.proxy(function()\n\t\t\t{\n\t\t\t\tvar redactorModalInner = $('#redactor_modal_inner');\n\n\t\t\t\tif (this.modalcontent !== false)\n\t\t\t\t{\n\t\t\t\t\tthis.modalcontent.html(redactorModalInner.html());\n\t\t\t\t\tthis.modalcontent = false;\n\t\t\t\t}\n\n\t\t\t\tredactorModalInner.html('');\n\n\t\t\t\tif (this.opts.modalOverlay)\n\t\t\t\t{\n\t\t\t\t\t$('#redactor_modal_overlay').hide().off('click', this.modalClose);\n\t\t\t\t}\n\n\t\t\t\t$(document).off('keyup', this.modalCloseHandler);\n\t\t\t\tthis.$editor.off('keyup', this.modalCloseHandler);\n\n\t\t\t\tthis.selectionRestore();\n\t\t\t\tif (this.opts.autoresize && this.saveModalScroll)\n\t\t\t\t{\n\t\t\t\t\t$(this.document.body).scrollTop(this.saveModalScroll);\n\t\t\t\t}\n\t\t\t\telse if (this.opts.autoresize === false && this.saveModalScroll)\n\t\t\t\t{\n\t\t\t\t\tthis.$editor.scrollTop(this.saveModalScroll);\n\t\t\t\t}\n\n\t\t\t\tthis.callback('modalClosed');\n\n\t\t\t}, this));\n\t\t\tif (this.isMobile() === false)\n\t\t\t{\n\t\t\t\t$(document.body).css('overflow', this.modalSaveBodyOveflow ? this.modalSaveBodyOveflow : 'visible');\n\t\t\t}\n\n\t\t\treturn false;\n\t\t},\n\t\tmodalSetTab: function(num)\n\t\t{\n\t\t\t$('.redactor_tab').hide();\n\t\t\t$('#redactor_tabs').find('a').removeClass('redactor_tabs_act').eq(num - 1).addClass('redactor_tabs_act');\n\t\t\t$('#redactor_tab' + num).show();\n\t\t},\n\t\ts3handleFileSelect: function(e)\n\t\t{\n\t\t\tvar files = e.target.files;\n\n\t\t\tfor (var i = 0, f; f = files[i]; i++)\n\t\t\t{\n\t\t\t\tthis.s3uploadFile(f);\n\t\t\t}\n\t\t},\n\t\ts3uploadFile: function(file)\n\t\t{\n\t\t\tthis.s3executeOnSignedUrl(file, $.proxy(function(signedURL)\n\t\t\t{\n\t\t\t\tthis.s3uploadToS3(file, signedURL);\n\t\t\t}, this));\n\t\t},\n\t\ts3executeOnSignedUrl: function(file, callback)\n\t\t{\n\t\t\tvar xhr = new XMLHttpRequest();\n\n\t\t\tvar mark = '?';\n\t\t\tif (this.opts.s3.search(/\\?/) != '-1') mark = '&';\n\n\t\t\txhr.open('GET', this.opts.s3 + mark + 'name=' + file.name + '&type=' + file.type, true);\n\t\t\tif (xhr.overrideMimeType) xhr.overrideMimeType('text/plain; charset=x-user-defined');\n\n\t\t\tvar that = this;\n\t\t\txhr.onreadystatechange = function(e)\n\t\t\t{\n\t\t\t\tif (this.readyState == 4 && this.status == 200)\n\t\t\t\t{\n\t\t\t\t\tthat.showProgressBar();\n\t\t\t\t\tcallback(decodeURIComponent(this.responseText));\n\t\t\t\t}\n\t\t\t\telse if(this.readyState == 4 && this.status != 200)\n\t\t\t\t{\n\n\t\t\t\t}\n\t\t\t};\n\n\t\t\txhr.send();\n\t\t},\n\t\ts3createCORSRequest: function(method, url)\n\t\t{\n\t\t\tvar xhr = new XMLHttpRequest();\n\t\t\tif (\"withCredentials\" in xhr)\n\t\t\t{\n\t\t\t\txhr.open(method, url, true);\n\t\t\t}\n\t\t\telse if (typeof XDomainRequest != \"undefined\")\n\t\t\t{\n\t\t\t\txhr = new XDomainRequest();\n\t\t\t\txhr.open(method, url);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\txhr = null;\n\t\t\t}\n\n\t\t\treturn xhr;\n\t\t},\n\t\ts3uploadToS3: function(file, url)\n\t\t{\n\t\t\tvar xhr = this.s3createCORSRequest('PUT', url);\n\t\t\tif (!xhr)\n\t\t\t{\n\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\txhr.onload = $.proxy(function()\n\t\t\t\t{\n\t\t\t\t\tif (xhr.status == 200)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.hideProgressBar();\n\n\t\t\t\t\t\tvar s3image = url.split('?');\n\n\t\t\t\t\t\tif (!s3image[0])\n\t\t\t\t\t\t{\n\n\t\t\t\t\t\t\t return false;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.selectionRestore();\n\n\t\t\t\t\t\tvar html = '';\n\t\t\t\t\t\thtml = '<img id=\"image-marker\" src=\"' + s3image[0] + '\" />';\n\t\t\t\t\t\tif (this.opts.paragraphy) html = '<p>' + html + '</p>';\n\n\t\t\t\t\t\tthis.execCommand('inserthtml', html, false);\n\n\t\t\t\t\t\tvar image = $(this.$editor.find('img#image-marker'));\n\n\t\t\t\t\t\tif (image.length) image.removeAttr('id');\n\t\t\t\t\t\telse image = false;\n\n\t\t\t\t\t\tthis.sync();\n\t\t\t\t\t\tthis.callback('imageUpload', image, false);\n\n\t\t\t\t\t\tthis.modalClose();\n\t\t\t\t\t\tthis.observeImages();\n\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\n\t\t\t\t\t}\n\t\t\t\t}, this);\n\n\t\t\t\txhr.onerror = function()\n\t\t\t\t{\n\n\t\t\t\t};\n\n\t\t\t\txhr.upload.onprogress = function(e)\n\t\t\t\t{\n\t\t\t\t\t/*\n\t\t\t\t\tif (e.lengthComputable)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar percentLoaded = Math.round((e.loaded / e.total) * 100);\n\t\t\t\t\t\tsetProgress(percentLoaded, percentLoaded == 100 ? 'Finalizing.' : 'Uploading.');\n\t\t\t\t\t}\n\t\t\t\t\t*/\n\t\t\t\t};\n\n\t\t\t\txhr.setRequestHeader('Content-Type', file.type);\n\t\t\t\txhr.setRequestHeader('x-amz-acl', 'public-read');\n\n\t\t\t\txhr.send(file);\n\t\t\t}\n\t\t},\n\t\tuploadInit: function(el, options)\n\t\t{\n\t\t\tthis.uploadOptions = {\n\t\t\t\turl: false,\n\t\t\t\tsuccess: false,\n\t\t\t\terror: false,\n\t\t\t\tstart: false,\n\t\t\t\ttrigger: false,\n\t\t\t\tauto: false,\n\t\t\t\tinput: false\n\t\t\t};\n\n\t\t\t$.extend(this.uploadOptions, options);\n\n\t\t\tvar $el = $('#' + el);\n\t\t\tif ($el.length && $el[0].tagName === 'INPUT')\n\t\t\t{\n\t\t\t\tthis.uploadOptions.input = $el;\n\t\t\t\tthis.el = $($el[0].form);\n\t\t\t}\n\t\t\telse this.el = $el;\n\n\t\t\tthis.element_action = this.el.attr('action');\n\t\t\tif (this.uploadOptions.auto)\n\t\t\t{\n\t\t\t\t$(this.uploadOptions.input).change($.proxy(function(e)\n\t\t\t\t{\n\t\t\t\t\tthis.el.submit(function(e)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t});\n\n\t\t\t\t\tthis.uploadSubmit(e);\n\n\t\t\t\t}, this));\n\n\t\t\t}\n\t\t\telse if (this.uploadOptions.trigger)\n\t\t\t{\n\t\t\t\t$('#' + this.uploadOptions.trigger).on('click', $.proxy(this.uploadSubmit, this));\n\t\t\t}\n\t\t},\n\t\tuploadSubmit: function(e)\n\t\t{\n\t\t\tthis.showProgressBar();\n\t\t\tthis.uploadForm(this.element, this.uploadFrame());\n\t\t},\n\t\tuploadFrame: function()\n\t\t{\n\t\t\tthis.id = 'f' + Math.floor(Math.random() * 99999);\n\n\t\t\tvar d = this.document.createElement('div');\n\t\t\tvar iframe = '<iframe style=\"display:none\" id=\"' + this.id + '\" name=\"' + this.id + '\"></iframe>';\n\n\t\t\td.innerHTML = iframe;\n\t\t\t$(d).appendTo(\"body\");\n\t\t\tif (this.uploadOptions.start) this.uploadOptions.start();\n\n\t\t\t$( '#' + this.id ).one('load', $.proxy(this.uploadLoaded, this));\n\n\t\t\treturn this.id;\n\t\t},\n\t\tuploadForm: function(f, name)\n\t\t{\n\t\t\tif (this.uploadOptions.input)\n\t\t\t{\n\t\t\t\tvar formId = 'redactorUploadForm' + this.id,\n\t\t\t\t\tfileId = 'redactorUploadFile' + this.id;\n\n\t\t\t\tthis.form = $('<form  action=\"' + this.uploadOptions.url + '\" method=\"POST\" target=\"' + name + '\" name=\"' + formId + '\" id=\"' + formId + '\" enctype=\"multipart/form-data\" />');\n\t\t\t\tif (this.opts.uploadFields !== false && typeof this.opts.uploadFields === 'object')\n\t\t\t\t{\n\t\t\t\t\t$.each(this.opts.uploadFields, $.proxy(function(k, v)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (v != null && v.toString().indexOf('#') === 0) v = $(v).val();\n\n\t\t\t\t\t\tvar hidden = $('<input/>', {\n\t\t\t\t\t\t\t'type': \"hidden\",\n\t\t\t\t\t\t\t'name': k,\n\t\t\t\t\t\t\t'value': v\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\t$(this.form).append(hidden);\n\n\t\t\t\t\t}, this));\n\t\t\t\t}\n\n\t\t\t\tvar oldElement = this.uploadOptions.input;\n\t\t\t\tvar newElement = $(oldElement).clone();\n\n\t\t\t\t$(oldElement).attr('id', fileId).before(newElement).appendTo(this.form);\n\n\t\t\t\t$(this.form).css('position', 'absolute')\n\t\t\t\t\t\t.css('top', '-2000px')\n\t\t\t\t\t\t.css('left', '-2000px')\n\t\t\t\t\t\t.appendTo('body');\n\n\t\t\t\tthis.form.submit();\n\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tf.attr('target', name)\n\t\t\t\t\t.attr('method', 'POST')\n\t\t\t\t\t.attr('enctype', 'multipart/form-data')\n\t\t\t\t\t.attr('action', this.uploadOptions.url);\n\n\t\t\t\tthis.element.submit();\n\t\t\t}\n\t\t},\n\t\tuploadLoaded: function()\n\t\t{\n\t\t\tvar i = $( '#' + this.id)[0], d;\n\n\t\t\tif (i.contentDocument) d = i.contentDocument;\n\t\t\telse if (i.contentWindow) d = i.contentWindow.document;\n\t\t\telse d = window.frames[this.id].document;\n\t\t\tif (this.uploadOptions.success)\n\t\t\t{\n\t\t\t\tthis.hideProgressBar();\n\n\t\t\t\tif (typeof d !== 'undefined')\n\t\t\t\t{\n\n\t\t\t\t\tvar rawString = d.body.innerHTML;\n\t\t\t\t\tvar jsonString = rawString.match(/\\{(.|\\n)*\\}/)[0];\n\n\t\t\t\t\tjsonString = jsonString.replace(/^\\[/, '');\n\t\t\t\t\tjsonString = jsonString.replace(/\\]$/, '');\n\n\t\t\t\t\tvar json = $.parseJSON(jsonString);\n\n\t\t\t\t\tif (typeof json.error == 'undefined') { this.uploadOptions.success(json); }\n\t\t\t\t\telse\n\t\t\t\t\t{\n                        console.log(json);\n\t\t\t\t\t\tthis.uploadOptions.error(this, json);\n\t\t\t\t\t\tthis.modalClose();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.modalClose();\n\t\t\t\t\talert('Upload failed!');\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.el.attr('action', this.element_action);\n\t\t\tthis.el.attr('target', '');\n\t\t},\n\t\tdraguploadInit: function (el, options)\n\t\t{\n\t\t\tthis.draguploadOptions = $.extend({\n\t\t\t\turl: false,\n\t\t\t\tsuccess: false,\n\t\t\t\terror: false,\n\t\t\t\tpreview: false,\n\t\t\t\tuploadFields: false,\n\t\t\t\ttext: this.opts.curLang.drop_file_here,\n\t\t\t\tatext: this.opts.curLang.or_choose,\n\t\t\t\tuploadParam: false\n\t\t\t}, options);\n\n\t\t\tif (window.FormData === undefined) return false;\n\n\t\t\tthis.droparea = $('<div class=\"redactor_droparea\"></div>');\n\t\t\tthis.dropareabox = $('<div class=\"redactor_dropareabox\">' + this.draguploadOptions.text + '</div>');\n\t\t\tthis.dropalternative = $('<div class=\"redactor_dropalternative\">' + this.draguploadOptions.atext + '</div>');\n\n\t\t\tthis.droparea.append(this.dropareabox);\n\n\t\t\t$(el).before(this.droparea);\n\t\t\t$(el).before(this.dropalternative);\n\t\t\tthis.dropareabox.on('dragover', $.proxy(function()\n\t\t\t{\n\t\t\t\treturn this.draguploadOndrag();\n\n\t\t\t}, this));\n\t\t\tthis.dropareabox.on('dragleave', $.proxy(function()\n\t\t\t{\n\t\t\t\treturn this.draguploadOndragleave();\n\n\t\t\t}, this));\n\t\t\tthis.dropareabox.get(0).ondrop = $.proxy(function(e)\n\t\t\t{\n\t\t\t\te.preventDefault();\n\n\t\t\t\tthis.dropareabox.removeClass('hover').addClass('drop');\n\t\t\t\tthis.showProgressBar();\n                                for(var nmb in e.dataTransfer.files){\n                                    if(!e.dataTransfer.files.hasOwnProperty(nmb))continue;\n                                    this.dragUploadAjax(this.draguploadOptions.url, e.dataTransfer.files[nmb], false, e, this.draguploadOptions.uploadParam);\n                                }\n\n\t\t\t}, this );\n\t\t},\n\t\tdragUploadAjax: function(url, file, directupload, e, uploadParam)\n\t\t{\n\t\t\tif (!directupload)\n\t\t\t{\n\t\t\t\tvar xhr = $.ajaxSettings.xhr();\n\t\t\t\tif (xhr.upload)\n\t\t\t\t{\n\t\t\t\t\txhr.upload.addEventListener('progress', $.proxy(this.uploadProgress, this), false);\n\t\t\t\t}\n\n\t\t\t\t$.ajaxSetup({\n\t\t\t\t  xhr: function () { return xhr; }\n\t\t\t\t});\n\t\t\t}\n\t\t\tthis.callback('drop', e);\n\n\t\t\tvar fd = new FormData();\n\t\t\tif (uploadParam !== false)\n\t\t\t{\n\t\t\t\tfd.append(uploadParam, file);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tfd.append('file', file);\n\t\t\t}\n\t\t\tif (this.opts.uploadFields !== false && typeof this.opts.uploadFields === 'object')\n\t\t\t{\n\t\t\t\t$.each(this.opts.uploadFields, $.proxy(function(k, v)\n\t\t\t\t{\n\t\t\t\t\tif (v != null && v.toString().indexOf('#') === 0) v = $(v).val();\n\t\t\t\t\tfd.append(k, v);\n\n\t\t\t\t}, this));\n\t\t\t}\n\n\t\t\t$.ajax({\n\t\t\t\turl: url,\n\t\t\t\tdataType: 'html',\n                                async: false,\n\t\t\t\tdata: fd,\n\t\t\t\tcache: false,\n\t\t\t\tcontentType: false,\n\t\t\t\tprocessData: false,\n\t\t\t\ttype: 'POST',\n\t\t\t\tsuccess: $.proxy(function(data)\n\t\t\t\t{\n\t\t\t\t\tdata = data.replace(/^\\[/, '');\n\t\t\t\t\tdata = data.replace(/\\]$/, '');\n\n\t\t\t\t\tvar json = (typeof data === 'string' ? $.parseJSON(data) : data);\n\n\t\t\t\t\tthis.hideProgressBar();\n\n\t\t\t\t\tif (directupload)\n\t\t\t\t\t{\n\t\t\t\t\t    var $img = $('<img>');\n\t\t\t\t\t\t$img.attr('src', json.image.url).attr('id', 'drag-image-marker');\n\n\t\t\t\t\t\tthis.insertNodeToCaretPositionFromPoint(e, $img[0]);\n\n\t\t\t\t\t\tvar image = $(this.$editor.find('img#drag-image-marker'));\n\t\t\t\t\t\tif (image.length) image.removeAttr('id');\n\t\t\t\t\t\telse image = false;\n\n\t\t\t\t\t\tthis.sync();\n\t\t\t\t\t\tthis.observeImages();\n\t\t\t\t\t\tif (image) this.callback('imageUpload', image, json);\n\t\t\t\t\t\tif (typeof json.error !== 'undefined') this.callback('imageUploadError', json);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tif (typeof json.error == 'undefined')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.draguploadOptions.success(json);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.draguploadOptions.error(this, json);\n\t\t\t\t\t\t\tthis.draguploadOptions.success(false);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t}, this)\n\t\t\t});\n\t\t},\n\t\tdraguploadOndrag: function()\n\t\t{\n\t\t\tthis.dropareabox.addClass('hover');\n\t\t\treturn false;\n\t\t},\n\t\tdraguploadOndragleave: function()\n\t\t{\n\t\t\tthis.dropareabox.removeClass('hover');\n\t\t\treturn false;\n\t\t},\n\t\tuploadProgress: function(e, text)\n\t\t{\n\t\t\tvar percent = e.loaded ? parseInt(e.loaded / e.total * 100, 10) : e;\n\t\t\tthis.dropareabox.text('Loading ' + percent + '% ' + (text || ''));\n\t\t},\n\t\tisMobile: function()\n\t\t{\n\t\t\treturn /(iPhone|iPod|BlackBerry|Android)/.test(navigator.userAgent);\n\t\t},\n\t\tisIPad: function()\n\t\t{\n\t\t\treturn /iPad/.test(navigator.userAgent);\n\t\t},\n\t\tnormalize: function(str)\n\t\t{\n\t\t\tif (typeof(str) === 'undefined') return 0;\n\t\t\treturn parseInt(str.replace('px',''), 10);\n\t\t},\n\t\touterHtml: function(el)\n\t\t{\n\t\t\treturn $('<div>').append($(el).eq(0).clone()).html();\n\t\t},\n\t\tstripHtml: function(html)\n\t\t{\n\t\t\tvar tmp = document.createElement(\"DIV\");\n\t\t\ttmp.innerHTML = html;\n\t\t\treturn tmp.textContent || tmp.innerText || \"\";\n\t\t},\n\t\tisString: function(obj)\n\t\t{\n\t\t\treturn Object.prototype.toString.call(obj) == '[object String]';\n\t\t},\n\t\tisEmpty: function(html)\n\t\t{\n\t\t\thtml = html.replace(/&#x200b;|<br>|<br\\/>|&nbsp;/gi, '');\n\t\t\thtml = html.replace(/\\s/g, '');\n\t\t\thtml = html.replace(/^<p>[^\\W\\w\\D\\d]*?<\\/p>$/i, '');\n\n\t\t\treturn html == '';\n\t\t},\n\t\tgetInternetExplorerVersion: function()\n\t\t{\n\t\t\tvar rv = false;\n\t\t\tif (navigator.appName == 'Microsoft Internet Explorer')\n\t\t\t{\n\t\t\t\tvar ua = navigator.userAgent;\n\t\t\t\tvar re  = new RegExp(\"MSIE ([0-9]{1,}[\\.0-9]{0,})\");\n\t\t\t\tif (re.exec(ua) != null)\n\t\t\t\t{\n\t\t\t\t\trv = parseFloat(RegExp.$1);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn rv;\n\t\t},\n\t\tisIe11: function()\n\t\t{\n\t\t\treturn !!navigator.userAgent.match(/Trident\\/7\\./);\n\t\t},\n\t\tbrowser: function(browser)\n\t\t{\n\t\t\tvar ua = navigator.userAgent.toLowerCase();\n\t\t\tvar match = /(opr)[\\/]([\\w.]+)/.exec( ua ) ||\n            /(chrome)[ \\/]([\\w.]+)/.exec( ua ) ||\n            /(webkit)[ \\/]([\\w.]+).*(safari)[ \\/]([\\w.]+)/.exec(ua) ||\n            /(webkit)[ \\/]([\\w.]+)/.exec( ua ) ||\n            /(opera)(?:.*version|)[ \\/]([\\w.]+)/.exec( ua ) ||\n            /(msie) ([\\w.]+)/.exec( ua ) ||\n            ua.indexOf(\"trident\") >= 0 && /(rv)(?::| )([\\w.]+)/.exec( ua ) ||\n            ua.indexOf(\"compatible\") < 0 && /(mozilla)(?:.*? rv:([\\w.]+)|)/.exec( ua ) ||\n            [];\n\n\t\t\tif (browser == 'version') return match[2];\n\t\t\tif (browser == 'webkit') return (match[1] == 'chrome' || match[1] == 'webkit');\n\t\t\tif (match[1] == 'rv') return browser == 'msie';\n\t\t\tif (match[1] == 'opr') return browser == 'webkit';\n\n\t\t\treturn browser == match[1];\n\n\t\t},\n\t\toldIE: function()\n\t\t{\n\t\t\tif (this.browser('msie') && parseInt(this.browser('version'), 10) < 9) return true;\n\t\t\treturn false;\n\t\t},\n\t\tgetFragmentHtml: function (fragment)\n\t\t{\n\t\t\tvar cloned = fragment.cloneNode(true);\n\t\t\tvar div = this.document.createElement('div');\n\n\t\t\tdiv.appendChild(cloned);\n\t\t\treturn div.innerHTML;\n\t\t},\n\t\textractContent: function()\n\t\t{\n\t\t\tvar node = this.$editor[0];\n\t\t\tvar frag = this.document.createDocumentFragment();\n\t\t\tvar child;\n\n\t\t\twhile ((child = node.firstChild))\n\t\t\t{\n\t\t\t\tfrag.appendChild(child);\n\t\t\t}\n\n\t\t\treturn frag;\n\t\t},\n\t\tisParentRedactor: function(el)\n\t\t{\n\t\t\tif (!el) return false;\n\t\t\tif (this.opts.iframe) return el;\n\n\t\t\tif ($(el).parents('div.redactor_editor').length == 0 || $(el).hasClass('redactor_editor')) return false;\n\t\t\telse return el;\n\t\t},\n\t\tcurrentOrParentIs: function(tagName)\n\t\t{\n\t\t\tvar parent = this.getParent(), current = this.getCurrent();\n\t\t\treturn parent && parent.tagName === tagName ? parent : current && current.tagName === tagName ? current : false;\n\t\t},\n\t\tisEndOfElement: function()\n\t\t{\n\t\t\tvar current = this.getBlock();\n\t\t\tvar offset = this.getCaretOffset(current);\n\n\t\t\tvar text = $.trim($(current).text()).replace(/\\n\\r\\n/g, '');\n\n\t\t\tvar len = text.length;\n\n\t\t\tif (offset == len) return true;\n\t\t\telse return false;\n\t\t},\n\t\tisFocused: function()\n\t\t{\n\t\t\tvar el, sel = this.getSelection();\n\n\t\t\tif (sel && sel.rangeCount && sel.rangeCount > 0) el = sel.getRangeAt(0).startContainer;\n\t\t\tif (!el) return false;\n\t\t\tif (this.opts.iframe)\n\t\t\t{\n\t\t\t\tif (this.getCaretOffsetRange().equals()) return !this.$editor.is(el);\n\t\t\t\telse return true;\n\t\t\t}\n\n\t\t\treturn $(el).closest('div.redactor_editor').length != 0;\n\t\t},\n\t\tremoveEmptyAttr: function (el, attr)\n\t\t{\n\t\t\tif ($(el).attr(attr) == '') $(el).removeAttr(attr);\n\t\t},\n\t\tremoveFromArrayByValue: function(array, value)\n\t\t{\n\t\t\tvar index = null;\n\n\t\t\twhile ((index = array.indexOf(value)) !== -1)\n\t\t\t{\n\t\t\t\tarray.splice(index, 1);\n\t\t\t}\n\n\t\t\treturn array;\n\t\t}\n\n\t};\n\tRedactor.prototype.init.prototype = Redactor.prototype;\n\t$.Redactor.fn.formatLinkify = function(protocol, convertLinks, convertImageLinks, convertVideoLinks, linkSize)\n\t{\n\t\tvar url = /(((https?|ftps?):\\/\\/)|www[.][^\\s])(.+?\\..+?)([.),]?)(\\s|\\.\\s+|\\)|$)/gi,\n\t\t\trProtocol = /(https?|ftp):\\/\\//i,\n\t\t\turlImage = /(https?:\\/\\/.*\\.(?:png|jpg|jpeg|gif))/gi;\n\n\t\tvar childNodes = (this.$editor ? this.$editor.get(0) : this).childNodes, i = childNodes.length;\n\t\twhile (i--)\n\t\t{\n\t\t\tvar n = childNodes[i];\n\t\t\tif (n.nodeType === 3)\n\t\t\t{\n\t\t\t\tvar html = n.nodeValue;\n\t\t\t\tif (convertVideoLinks && html)\n\t\t\t\t{\n\t\t\t\t\tvar iframeStart = '<iframe width=\"500\" height=\"281\" src=\"',\n\t\t\t\t\t\tiframeEnd = '\" frameborder=\"0\" allowfullscreen></iframe>';\n\n\t\t\t\t\tif (html.match(reUrlYoutube))\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(reUrlYoutube, iframeStart + '//www.youtube.com/embed/$1' + iframeEnd);\n\t\t\t\t\t\t$(n).after(html).remove();\n\t\t\t\t\t}\n\t\t\t\t\telse if (html.match(reUrlVimeo))\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(reUrlVimeo, iframeStart + '//player.vimeo.com/video/$2' + iframeEnd);\n\t\t\t\t\t\t$(n).after(html).remove();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (convertImageLinks && html && html.match(urlImage))\n\t\t\t\t{\n\t\t\t\t\thtml = html.replace(urlImage, '<img src=\"$1\">');\n\n\t\t\t\t\t$(n).after(html).remove();\n\t\t\t\t}\n\t\t\t\tif (convertLinks && html && html.match(url))\n\t\t\t\t{\n\t\t\t\t\tvar matches = html.match(url);\n\n\t\t\t\t\tfor (var i in matches)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar href = matches[i];\n\t\t\t\t\t\tvar text = href;\n\n\t\t\t\t\t\tvar space = '';\n\t\t\t\t\t\tif (href.match(/\\s$/) !== null) space = ' ';\n\n\t\t\t\t\t\tvar addProtocol = protocol;\n\t\t\t\t\t\tif (href.match(rProtocol) !== null) addProtocol = '';\n\n\t\t\t\t\t\tif (text.length > linkSize) text = text.substring(0, linkSize) + '...';\n\n\t\t\t\t\t\ttext = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')\n\n\t\t\t\t\t\t/*\n\t\t\t\t\t\t\tTo handle URLs which may have $ characters in them, need to escape $ -> $$ to prevent $1 from getting treated as a backreference.\n\t\t\t\t\t\t\tSee http://gotofritz.net/blog/code-snippets/escaping-in-replace-strings-in-javascript/\n\t\t\t\t\t\t*/\n\t\t\t\t\t\tvar escapedBackReferences = text.replace('$', '$$$');\n\n\t\t\t\t\t\thtml = html.replace(href, '<a href=\\\"' + addProtocol + $.trim(href) + '\\\">' + $.trim(escapedBackReferences) + '</a>' + space);\n\t\t\t\t\t}\n\n\t\t\t\t\t$(n).after(html).remove();\n\t\t\t\t}\n\t\t\t}\n\t\t\telse if (n.nodeType === 1 && !/^(a|button|textarea)$/i.test(n.tagName))\n\t\t\t{\n\t\t\t\t$.Redactor.fn.formatLinkify.call(n, protocol, convertLinks, convertImageLinks, convertVideoLinks, linkSize);\n\t\t\t}\n\t\t}\n\t};\n\n})(jQuery);\n", "!function($){var uuid=0;\"use strict\";var Range=function(t){return this[0]=t.startOffset,this[1]=t.endOffset,this.range=t,this};Range.prototype.equals=function(){return this[0]===this[1]};var reUrlYoutube=/https?:\\/\\/(?:[0-9A-Z-]+\\.)?(?:youtu\\.be\\/|youtube\\.com\\S*[^\\w\\-\\s])([\\w\\-]{11})(?=[^\\w\\-]|$)(?![?=&+%\\w.-]*(?:['\"][^<>]*>|<\\/a>))[?=&+%\\w.-]*/ig,reUrlVimeo=/https?:\\/\\/(www\\.)?vimeo.com\\/(\\d+)($|\\/)/,reUrlFacebook=/^(?:(?:https|http)?:\\/\\/)?(?:www\\.)?(?:facebook\\.com(?:\\/[^\\/]+\\/videos\\/|\\/video\\.php\\?v=))([0-9]+)(?:.+)?$/,reUrlRutube=/^(?:(?:https|http)?:\\/\\/)?(?:www\\.)?(?:rutube\\.ru\\/video\\/)([a-z0-9]+)(?:.+)?$/;function Redactor(t,e){return new Redactor.prototype.init(t,e)}$.fn.redactor=function(t){var e=[],s=Array.prototype.slice.call(arguments,1);return(\"string\"==typeof t?this.each(function(){var o=$.data(this,\"redactor\");if(!(void 0!==o&&$.isFunction(o[t])))return $.error('No such method \"'+t+'\" for Redactor');var r=o[t].apply(o,s);void 0!==r&&r!==o&&e.push(r)}):this.each(function(){$.data(this,\"redactor\")||$.data(this,\"redactor\",Redactor(this,t))}),0===e.length)?this:1===e.length?e[0]:e},$.Redactor=Redactor,$.Redactor.VERSION=\"9.2.6\",$.Redactor.opts={rangy:!1,iframe:!1,fullpage:!1,css:!1,lang:\"en\",direction:\"ltr\",placeholder:!1,typewriter:!1,wym:!1,mobile:!0,cleanup:!0,tidyHtml:!0,pastePlainText:!1,removeEmptyTags:!0,cleanSpaces:!0,cleanFontTag:!0,templateVars:!1,xhtml:!1,visual:!0,focus:!1,tabindex:!1,autoresize:!0,minHeight:!1,maxHeight:!1,shortcuts:{\"ctrl+m, meta+m\":\"this.execCommand('removeFormat', false)\",\"ctrl+b, meta+b\":\"this.execCommand('bold', false)\",\"ctrl+i, meta+i\":\"this.execCommand('italic', false)\",\"ctrl+h, meta+h\":\"this.execCommand('superscript', false)\",\"ctrl+l, meta+l\":\"this.execCommand('subscript', false)\",\"ctrl+k, meta+k\":\"this.linkShow()\",\"ctrl+shift+7\":\"this.execCommand('insertorderedlist', false)\",\"ctrl+shift+8\":\"this.execCommand('insertunorderedlist', false)\"},shortcutsAdd:!1,autosave:!1,autosaveInterval:60,plugins:!1,linkProtocol:\"http://\",linkNofollow:!1,linkSize:50,predefinedLinks:!1,imageFloatMargin:\"10px\",imageGetJson:!1,dragUpload:!0,imageTabLink:!0,imageUpload:!1,imageUploadParam:\"file\",imageResizable:!0,fileUpload:!1,fileUploadParam:\"file\",clipboardUpload:!0,clipboardUploadUrl:!1,smilesUrl:\"\",dnbImageTypes:[\"image/png\",\"image/jpeg\",\"image/gif\"],s3:!1,uploadFields:!1,observeImages:!0,observeLinks:!0,modalOverlay:!0,tabSpaces:!1,tabFocus:!0,air:!1,airButtons:[\"formatting\",\"bold\",\"italic\",\"deleted\",\"unorderedlist\",\"orderedlist\",\"outdent\",\"indent\"],toolbar:!0,toolbarFixed:!1,toolbarFixedTarget:document,toolbarFixedTopOffset:0,toolbarFixedBox:!1,toolbarExternal:!1,toolbarOverflow:!1,buttonSource:!0,buttons:[\"html\",\"undo\",\"redo\",\"formatting\",\"bold\",\"italic\",\"deleted\",\"unorderedlist\",\"orderedlist\",\"outdent\",\"indent\",\"image\",\"video\",\"file\",\"table\",\"link\",\"alignment\",\"|\",\"horizontalrule\"],buttonsHideOnMobile:[],activeButtons:[\"deleted\",\"italic\",\"bold\",\"underline\",\"unorderedlist\",\"orderedlist\",\"alignleft\",\"aligncenter\",\"alignright\",\"justify\",\"table\"],activeButtonsStates:{b:\"bold\",strong:\"bold\",i:\"italic\",em:\"italic\",del:\"deleted\",strike:\"deleted\",ul:\"unorderedlist\",ol:\"orderedlist\",u:\"underline\",tr:\"table\",td:\"table\",table:\"table\"},formattingTags:[\"p\",\"blockquote\",\"code\",\"h2\",\"h3\",\"h4\",\"h5\",\"h6\"],linebreaks:!1,paragraphy:!0,convertDivs:!0,convertLinks:!0,convertImageLinks:!1,convertVideoLinks:!1,formattingPre:!1,phpTags:!1,allowedTags:!1,deniedTags:[\"html\",\"head\",\"link\",\"body\",\"meta\",\"script\",\"style\",\"applet\"],boldTag:\"strong\",italicTag:\"em\",indentValue:20,buffer:[],rebuffer:[],textareamode:!1,emptyHtml:\"<p>&#x200b;</p>\",invisibleSpace:\"&#x200b;\",rBlockTest:/^(P|H[1-6]|LI|ADDRESS|SECTION|HEADER|FOOTER|ASIDE|ARTICLE)$/i,alignmentTags:[\"P\",\"H1\",\"H2\",\"H3\",\"H4\",\"H5\",\"H6\",\"DD\",\"DL\",\"DT\",\"DIV\",\"TD\",\"BLOCKQUOTE\",\"OUTPUT\",\"FIGCAPTION\",\"ADDRESS\",\"SECTION\",\"HEADER\",\"FOOTER\",\"ASIDE\",\"ARTICLE\"],ownLine:[\"area\",\"body\",\"head\",\"hr\",\"i?frame\",\"link\",\"meta\",\"noscript\",\"style\",\"script\",\"table\",\"tbody\",\"thead\",\"tfoot\"],contOwnLine:[\"li\",\"dt\",\"dt\",\"h[1-6]\",\"option\",\"script\"],newLevel:[\"blockquote\",\"div\",\"dl\",\"fieldset\",\"form\",\"frameset\",\"map\",\"ol\",\"p\",\"code\",\"select\",\"td\",\"th\",\"tr\",\"ul\"],blockLevelElements:[\"P\",\"H1\",\"H2\",\"H3\",\"H4\",\"H5\",\"H6\",\"DD\",\"DL\",\"DT\",\"DIV\",\"LI\",\"BLOCKQUOTE\",\"OUTPUT\",\"FIGCAPTION\",\"CODE\",\"ADDRESS\",\"SECTION\",\"HEADER\",\"FOOTER\",\"ASIDE\",\"ARTICLE\",\"TD\"],langs:{en:{html:\"HTML\",video:\"Insert Video\",image:\"Insert Image\",table:\"Table\",link:\"Link\",link_insert:\"Insert link\",link_edit:\"Edit link\",unlink:\"Unlink\",formatting:\"Formatting\",paragraph:\"Normal text\",quote:\"Quote\",code:\"Code\",header1:\"Header 1\",header2:\"Header 2\",header3:\"Header 3\",header4:\"Header 4\",header5:\"Header 5\",bold:\"Bold\",italic:\"Italic\",fontcolor:\"Font Color\",backcolor:\"Back Color\",unorderedlist:\"Unordered List\",orderedlist:\"Ordered List\",outdent:\"Outdent\",indent:\"Indent\",cancel:\"Cancel\",insert:\"Insert\",save:\"Save\",_delete:\"Delete\",insert_table:\"Insert Table\",insert_row_above:\"Add Row Above\",insert_row_below:\"Add Row Below\",insert_column_left:\"Add Column Left\",insert_column_right:\"Add Column Right\",delete_column:\"Delete Column\",delete_row:\"Delete Row\",delete_table:\"Delete Table\",rows:\"Rows\",columns:\"Columns\",add_head:\"Add Head\",delete_head:\"Delete Head\",title:\"Title\",image_position:\"Position\",none:\"None\",left:\"Left\",right:\"Right\",center:\"Center\",image_web_link:\"Image Web Link\",text:\"Text\",mailto:\"Email\",web:\"URL\",video_html_code:\"Video Embed Code\",file:\"Insert File\",upload:\"Upload\",download:\"Download\",choose:\"Choose\",empty_img_list:\"You have no images\",or_choose:\"Or choose\",drop_file_here:\"Drop file here\",align_left:\"Align text to the left\",align_center:\"Center text\",align_right:\"Align text to the right\",align_justify:\"Justify text\",horizontalrule:\"Insert Horizontal Rule\",fullscreen:\"Full screen\",fontsize:\"Font size\",fontfamily:\"Font\",remove_font:\"Clear Font\",image_save_toserver:\"Save to the server?\",deleted:\"Deleted\",anchor:\"Anchor\",link_new_tab:\"Open link in new tab\",underline:\"Underline\",alignment:\"Alignment\",filename:\"Name (optional)\",edit:\"Edit\",spoiler:\"Spoiler\",spoiler_name:\"Spoiler name\",spoiler_text:\"Spoiler text\",smiles:\"Smiles\",undo:\"Undo\",redo:\"Redo\",formalize:\"Formalize\"}}},Redactor.fn=$.Redactor.prototype={keyCode:{BACKSPACE:8,DELETE:46,DOWN:40,ENTER:13,ESC:27,TAB:9,CTRL:17,META:91,LEFT:37,LEFT_WIN:91},init:function(t,e){this.rtePaste=!1,this.$element=this.$source=$(t),this.uuid=uuid++;var s=$.extend(!0,{},$.Redactor.opts);if(this.opts=$.extend({},s,this.$element.data(),e),this.start=!0,this.dropdowns=[],this.sourceHeight=this.$source.css(\"height\"),this.sourceWidth=this.$source.css(\"width\"),this.opts.fullpage&&(this.opts.iframe=!0),this.opts.linebreaks&&(this.opts.paragraphy=!1),this.opts.paragraphy&&(this.opts.linebreaks=!1),this.opts.toolbarFixedBox&&(this.opts.toolbarFixed=!0),this.document=document,this.window=window,this.savedSel=!1,this.cleanlineBefore=RegExp(\"^<(/?\"+this.opts.ownLine.join(\"|/?\")+\"|\"+this.opts.contOwnLine.join(\"|\")+\")[ >]\"),this.cleanlineAfter=RegExp(\"^<(br|/?\"+this.opts.ownLine.join(\"|/?\")+\"|/\"+this.opts.contOwnLine.join(\"|/\")+\")[ >]\"),this.cleannewLevel=RegExp(\"^</?(\"+this.opts.newLevel.join(\"|\")+\")[ >]\"),this.rTestBlock=RegExp(\"^(\"+this.opts.blockLevelElements.join(\"|\")+\")$\",\"i\"),!1===this.opts.linebreaks){if(!1!==this.opts.allowedTags){var o=[\"strong\",\"em\",\"del\"],r=[\"b\",\"i\",\"strike\"];for(i in\"-1\"===$.inArray(\"p\",this.opts.allowedTags)&&this.opts.allowedTags.push(\"p\"),o)\"-1\"!=$.inArray(o[i],this.opts.allowedTags)&&this.opts.allowedTags.push(r[i])}if(!1!==this.opts.deniedTags){var a=$.inArray(\"p\",this.opts.deniedTags);\"-1\"!==a&&this.opts.deniedTags.splice(a,a)}}(this.browser(\"msie\")||this.browser(\"opera\"))&&(this.opts.buttons=this.removeFromArrayByValue(this.opts.buttons,\"horizontalrule\")),this.opts.curLang=this.opts.langs[this.opts.lang],$.extend(this.opts.shortcuts,this.opts.shortcutsAdd),this.placeholderInit(),this.buildStart()},toolbarInit:function(t){return{html:{title:t.html,func:\"toggle\"},undo:{title:t.undo,func:\"bufferUndo\"},redo:{title:t.redo,func:\"bufferRedo\"},formatting:{title:t.formatting,func:\"show\",dropdown:{p:{title:t.paragraph,func:\"formatBlocks\"},blockquote:{title:t.quote,func:\"formatQuote\",className:\"redactor_format_blockquote\"},code:{title:t.code,func:\"formatBlocks\",className:\"redactor_format_code\"},h1:{title:t.header1,func:\"formatBlocks\",className:\"redactor_format_h1\"},h2:{title:t.header2,func:\"formatBlocks\",className:\"redactor_format_h2\"},h3:{title:t.header3,func:\"formatBlocks\",className:\"redactor_format_h3\"},h4:{title:t.header4,func:\"formatBlocks\",className:\"redactor_format_h4\"},h5:{title:t.header5,func:\"formatBlocks\",className:\"redactor_format_h5\"}}},bold:{title:t.bold,exec:\"bold\"},italic:{title:t.italic,exec:\"italic\"},deleted:{title:t.deleted,exec:\"strikethrough\"},underline:{title:t.underline,exec:\"underline\"},unorderedlist:{title:\"&bull; \"+t.unorderedlist,exec:\"insertunorderedlist\"},orderedlist:{title:\"1. \"+t.orderedlist,exec:\"insertorderedlist\"},outdent:{title:\"< \"+t.outdent,func:\"indentingOutdent\"},indent:{title:\"> \"+t.indent,func:\"indentingIndent\"},image:{title:t.image,func:\"imageShow\"},video:{title:t.video,func:\"videoShow\"},file:{title:t.file,func:\"fileShow\"},table:{title:t.table,func:\"show\",dropdown:{insert_table:{title:t.insert_table,func:\"tableShow\"},separator_drop1:{name:\"separator\"},insert_row_above:{title:t.insert_row_above,func:\"tableAddRowAbove\"},insert_row_below:{title:t.insert_row_below,func:\"tableAddRowBelow\"},insert_column_left:{title:t.insert_column_left,func:\"tableAddColumnLeft\"},insert_column_right:{title:t.insert_column_right,func:\"tableAddColumnRight\"},separator_drop2:{name:\"separator\"},add_head:{title:t.add_head,func:\"tableAddHead\"},delete_head:{title:t.delete_head,func:\"tableDeleteHead\"},separator_drop3:{name:\"separator\"},delete_column:{title:t.delete_column,func:\"tableDeleteColumn\"},delete_row:{title:t.delete_row,func:\"tableDeleteRow\"},delete_table:{title:t.delete_table,func:\"tableDeleteTable\"}}},link:{title:t.link,func:\"show\",dropdown:{link:{title:t.link_insert,func:\"linkShow\"},unlink:{title:t.unlink,exec:\"unlink\"}}},alignment:{title:t.alignment,func:\"show\",dropdown:{alignleft:{title:t.align_left,func:\"alignmentLeft\"},aligncenter:{title:t.align_center,func:\"alignmentCenter\"},alignright:{title:t.align_right,func:\"alignmentRight\"},justify:{title:t.align_justify,func:\"alignmentJustify\"}}},alignleft:{title:t.align_left,func:\"alignmentLeft\"},aligncenter:{title:t.align_center,func:\"alignmentCenter\"},alignright:{title:t.align_right,func:\"alignmentRight\"},alignjustify:{title:t.align_justify,func:\"alignmentJustify\"},horizontalrule:{exec:\"inserthorizontalrule\",title:t.horizontalrule}}},callback:function(t,e,s){var o=this.opts[t+\"Callback\"];return $.isFunction(o)?!1===e?o.call(this,s):o.call(this,e,s):s},destroy:function(){clearInterval(this.autosaveInterval),$(window).off(\".redactor\"),this.$source.off(\"redactor-textarea\"),this.$element.off(\".redactor\").removeData(\"redactor\");var t=this.get();if(this.opts.textareamode)this.$box.after(this.$source),this.$box.remove(),this.$source.val(t).show();else{var e=this.$editor;this.opts.iframe&&(e=this.$element),this.$box.after(e),this.$box.remove(),e.removeClass(\"redactor_editor\").removeClass(\"redactor_editor_wym\").removeAttr(\"contenteditable\").html(t).show()}this.opts.toolbarExternal&&$(this.opts.toolbarExternal).html(\"\"),this.opts.air&&$(\"#redactor_air_\"+this.uuid).remove()},getObject:function(){return $.extend({},this)},getEditor:function(){return this.$editor},getBox:function(){return this.$box},getIframe:function(){return!!this.opts.iframe&&this.$frame},getToolbar:function(){return!!this.$toolbar&&this.$toolbar},get:function(){return this.$source.val()},getCodeIframe:function(){this.$editor.removeAttr(\"contenteditable\").removeAttr(\"dir\");var t=this.outerHtml(this.$frame.contents().children());return this.$editor.attr({contenteditable:!0,dir:this.opts.direction}),t},set:function(t,e,s){t=(t=t.toString()).replace(/\\$/g,\"&#36;\"),this.opts.fullpage?this.setCodeIframe(t):this.setEditor(t,e),\"\"==t&&(s=!1),!1!==s&&this.placeholderRemoveFromEditor()},setEditor:function(t,e){!1!==e&&(t=this.cleanSavePreCode(t),t=this.cleanStripTags(t),t=this.cleanConvertProtected(t),t=this.cleanConvertInlineTags(t,!0),t=!1===this.opts.linebreaks?this.cleanConverters(t):t.replace(/<p(.*?)>([\\w\\W]*?)<\\/p>/gi,\"$2<br>\")),t=t.replace(/&amp;#36;/g,\"$\"),t=this.cleanEmpty(t),t=this.sanitizeHTML(t),this.$editor.html(t),this.setNonEditable(),this.setSpansVerified(),this.sync()},sanitizeHTML:function(t){function e(){return new DOMParser().parseFromString(t,\"text/html\").body}function s(t){let e=t.children;for(let r of e)o(r),s(r)}function o(t){let e=t.attributes;for(let{name:s,value:o}of e)r(s,o)&&t.removeAttribute(s)}function r(t,e){let s=e.replace(/\\s+/g,\"\").toLowerCase();if([\"src\",\"href\",\"xlink:href\"].includes(t)&&(s.includes(\"javascript:\")||s.includes(\"data:text/html\"))||t.startsWith(\"on\"))return!0}let a=e();return s(a),a.innerHTML},setCodeIframe:function(t){var e=this.iframePage();this.$frame[0].src=\"about:blank\",t=this.cleanConvertProtected(t),t=this.cleanConvertInlineTags(t),t=this.cleanRemoveSpaces(t),e.open(),e.write(t),e.close(),this.opts.fullpage&&(this.$editor=this.$frame.contents().find(\"body\").attr({contenteditable:!0,dir:this.opts.direction})),this.setNonEditable(),this.setSpansVerified(),this.sync()},setFullpageOnInit:function(t){this.fullpageDoctype=t.match(/^<\\!doctype[^>]*>/i),this.fullpageDoctype&&1==this.fullpageDoctype.length&&(t=t.replace(/^<\\!doctype[^>]*>/i,\"\")),t=this.cleanSavePreCode(t,!0),t=this.cleanConverters(t),t=this.cleanEmpty(t),t=this.sanitizeHTML(t),this.$editor.html(t),this.setNonEditable(),this.setSpansVerified(),this.sync()},setFullpageDoctype:function(){if(this.fullpageDoctype&&1==this.fullpageDoctype.length){var t=this.fullpageDoctype[0]+\"\\n\"+this.$source.val();this.$source.val(t)}},setSpansVerified:function(){var t=this.$editor.find(\"span\"),e=\"inline\";$.each(t,function(){var t=this.outerHTML,s=RegExp(\"<\"+this.tagName,\"gi\"),o=t.replace(s,\"<\"+e);s=RegExp(\"</\"+this.tagName,\"gi\"),o=o.replace(s,\"</\"+e),$(this).replaceWith(o)})},setSpansVerifiedHtml:function(t){return(t=t.replace(/<span(.*?)>/,\"<inline$1>\")).replace(/<\\/span>/,\"</inline>\")},setNonEditable:function(){this.$editor.find(\".noneditable\").attr(\"contenteditable\",!1)},sync:function(t){var e,s=\"\";if(this.cleanUnverified(),s=this.opts.fullpage?this.getCodeIframe():this.$editor.html(),s=this.syncClean(s),s=this.cleanRemoveEmptyTags(s),this.cleanRemoveSpaces(this.$source.val(),!1)==this.cleanRemoveSpaces(s,!1))return!1;if(s=s.replace(/<\\/li><(ul|ol)>([\\w\\W]*?)<\\/(ul|ol)>/gi,\"<$1>$2</$1></li>\"),\"<br>\"===$.trim(s)&&(s=\"\"),this.opts.xhtml){var o=[\"br\",\"hr\",\"img\",\"link\",\"input\",\"meta\"];$.each(o,function(t,e){s=s.replace(RegExp(\"<\"+e+\"(.*?[^/$]?)>\",\"gi\"),\"<\"+e+\"$1 />\")})}if(s=this.callback(\"syncBefore\",!1,s),this.$source.val(s),this.setFullpageDoctype(),this.callback(\"syncAfter\",!1,s),!1===this.start){if(void 0!==t)switch(t.which){case 37:case 38:case 39:case 40:break;default:this.callback(\"change\",!1,s)}else this.callback(\"change\",!1,s)}},syncClean:function(t){return this.opts.fullpage||(t=this.cleanStripTags(t)),t=$.trim(t),(\"<p></p>\"==(t=(t=(t=(t=(t=this.placeholderRemoveFromCode(t)).replace(/&#x200b;/gi,\"\")).replace(/&#8203;/gi,\"\")).replace(/<\\/a>&nbsp;/gi,\"</a> \")).replace(/\\u200B/g,\"\"))||\"<p> </p>\"==t||\"<p>&nbsp;</p>\"==t)&&(t=\"\"),this.opts.linkNofollow&&(t=(t=t.replace(/<a(.*?)rel=\"nofollow\"(.*?)>/gi,\"<a$1$2>\")).replace(/<a(.*?)>/gi,'<a$1 rel=\"nofollow\">')),t=(t=(t=(t=(t=(t=(t=(t=(t=t.replace(\"<!--?php\",\"<?php\")).replace(\"?-->\",\"?>\")).replace(/<(.*?)class=\"noeditable\"(.*?) contenteditable=\"false\"(.*?)>/gi,'<$1class=\"noeditable\"$2$3>')).replace(/ data-tagblock=\"\"/gi,\"\")).replace(/<br\\s?\\/?>\\n?<\\/(P|H[1-6]|LI|ADDRESS|SECTION|HEADER|FOOTER|ASIDE|ARTICLE)>/gi,\"</$1>\")).replace(/<span(.*?)id=\"redactor-image-box\"(.*?)>([\\w\\W]*?)<img(.*?)><\\/span>/gi,\"$3<img$4>\")).replace(/<span(.*?)id=\"redactor-image-resizer\"(.*?)>(.*?)<\\/span>/gi,\"\")).replace(/<span(.*?)id=\"redactor-image-editter\"(.*?)>(.*?)<\\/span>/gi,\"\")).replace(/<(ul|ol)>\\s*\\t*\\n*<\\/(ul|ol)>/gi,\"\"),this.opts.cleanFontTag&&(t=t.replace(/<font(.*?)>([\\w\\W]*?)<\\/font>/gi,\"$2\")),t=(t=(t=(t=(t=t.replace(/<span(.*?)>([\\w\\W]*?)<\\/span>/gi,\"$2\")).replace(/<inline>([\\w\\W]*?)<\\/inline>/gi,\"$1\")).replace(/<inline>/gi,\"<span>\")).replace(/<inline /gi,\"<span \")).replace(/<\\/inline>/gi,\"</span>\"),this.opts.removeEmptyTags&&(t=t.replace(/<span>([\\w\\W]*?)<\\/span>/gi,\"$1\")),t=(t=(t=(t=(t=(t=(t=(t=t.replace(/<span(.*?)class=\"redactor_placeholder\"(.*?)>([\\w\\W]*?)<\\/span>/gi,\"\")).replace(/<img(.*?)contenteditable=\"false\"(.*?)>/gi,\"<img$1$2>\")).replace(/&/gi,\"&\")).replace(/\\u2122/gi,\"&trade;\")).replace(/\\u00a9/gi,\"&copy;\")).replace(/\\u2026/gi,\"&hellip;\")).replace(/\\u2014/gi,\"&mdash;\")).replace(/\\u2010/gi,\"&dash;\"),t=this.cleanReConvertProtected(t)},buildStart:function(){this.content=\"\",this.$box=$('<div class=\"redactor_box\" />'),\"TEXTAREA\"===this.$source[0].tagName&&(this.opts.textareamode=!0),!1===this.opts.mobile&&this.isMobile()?this.buildMobile():(this.buildContent(),this.opts.iframe?(this.opts.autoresize=!1,this.iframeStart()):this.opts.textareamode?this.buildFromTextarea():this.buildFromElement(),this.opts.iframe||(this.buildOptions(),this.buildAfter()))},buildMobile:function(){this.opts.textareamode||(this.$editor=this.$source,this.$editor.hide(),this.$source=this.buildCodearea(this.$editor),this.$source.val(this.content)),this.$box.insertAfter(this.$source).append(this.$source)},buildContent:function(){this.opts.textareamode?this.content=$.trim(this.$source.val()):this.content=$.trim(this.$source.html())},buildFromTextarea:function(){this.$editor=$(\"<div />\"),this.$box.insertAfter(this.$source).append(this.$editor).append(this.$source),this.buildAddClasses(this.$editor),this.buildEnable()},buildFromElement:function(){this.$editor=this.$source,this.$source=this.buildCodearea(this.$editor),this.$box.insertAfter(this.$editor).append(this.$editor).append(this.$source),this.buildEnable()},buildCodearea:function(t){return $(\"<textarea />\").attr(\"name\",t.attr(\"id\")).css(\"height\",this.sourceHeight)},buildAddClasses:function(t){$.each(this.$source.get(0).className.split(/\\s+/),function(e,s){t.addClass(\"redactor_\"+s)})},buildEnable:function(){this.$editor.addClass(\"redactor_editor\").attr({contenteditable:!0,dir:this.opts.direction}),this.$source.attr(\"dir\",this.opts.direction).hide(),this.set(this.content,!0,!1)},buildOptions:function(){var t=this.$editor;this.opts.iframe&&(t=this.$frame),this.opts.tabindex&&t.attr(\"tabindex\",this.opts.tabindex),this.opts.minHeight?t.css(\"min-height\",this.opts.minHeight+\"px\"):this.browser(\"mozilla\")&&this.opts.linebreaks&&this.$editor.css(\"min-height\",\"45px\"),this.browser(\"mozilla\")&&this.opts.linebreaks&&this.$editor.css(\"padding-bottom\",\"10px\"),this.opts.maxHeight&&(this.opts.autoresize=!1,this.sourceHeight=this.opts.maxHeight),this.opts.wym&&this.$editor.addClass(\"redactor_editor_wym\"),this.opts.typewriter&&this.$editor.addClass(\"redactor-editor-typewriter\"),this.opts.autoresize||t.css(\"height\",this.sourceHeight)},buildAfter:function(){if(this.start=!1,this.opts.toolbar&&(this.opts.toolbar=this.toolbarInit(this.opts.curLang),this.toolbarBuild()),this.modalTemplatesInit(),this.buildPlugins(),this.buildBindKeyboard(),this.opts.autosave&&this.autosave(),setTimeout($.proxy(this.observeStart,this),4),this.browser(\"mozilla\"))try{this.document.execCommand(\"enableObjectResizing\",!1,!1),this.document.execCommand(\"enableInlineTableEditing\",!1,!1)}catch(t){}this.opts.focus&&setTimeout($.proxy(this.focus,this),100),this.opts.visual||setTimeout($.proxy(function(){this.opts.visual=!0,this.toggle(!1)},this),200),this.callback(\"init\")},buildBindKeyboard:function(){var t;this.dblEnter=0,this.opts.dragUpload&&(!1!==this.opts.imageUpload||!1!==this.opts.s3)&&this.$editor.on(\"drop.redactor\",$.proxy(this.buildEventDrop,this)),this.$editor.on(\"click.redactor\",$.proxy(function(){this.selectall=!1},this)),this.$editor.on(\"input.redactor\",$.proxy(this.sync,this)),this.$editor.on(\"paste.redactor\",$.proxy(this.buildEventPaste,this)),this.$editor.on(\"keydown.redactor\",$.proxy(this.buildEventKeydown,this)),this.$editor.on(\"keyup.redactor\",$.proxy(this.buildEventKeyup,this)),$.isFunction(this.opts.textareaKeydownCallback)&&this.$source.on(\"keydown.redactor-textarea\",$.proxy(this.opts.textareaKeydownCallback,this)),$.isFunction(this.opts.focusCallback)&&this.$editor.on(\"focus.redactor\",$.proxy(this.opts.focusCallback,this)),$(document).mousedown(function(e){t=$(e.target)}),this.$editor.on(\"blur.redactor\",$.proxy(function(e){!$(t).hasClass(\"redactor_toolbar\")&&0==$(t).parents(\".redactor_toolbar\").length&&(this.selectall=!1,$.isFunction(this.opts.blurCallback)&&this.callback(\"blur\",e))},this))},buildEventDrop:function(t){if(t=t.originalEvent||t,void 0===window.FormData||!t.dataTransfer||0==t.dataTransfer.files.length)return!0;t.preventDefault();var e=t.dataTransfer.files[0];if(!1!==this.opts.dnbImageTypes&&-1==this.opts.dnbImageTypes.indexOf(e.type))return!0;this.bufferSet(),this.showProgressBar(),!1===this.opts.s3?this.dragUploadAjax(this.opts.imageUpload,e,!0,t,this.opts.imageUploadParam):this.s3uploadFile(e)},buildEventPaste:function(t){var e=!1;if(this.browser(\"webkit\")&&-1===navigator.userAgent.indexOf(\"Chrome\")&&this.browser(\"version\").split(\".\")[0]<536&&(e=!0),e||this.browser(\"opera\")||this.opts.clipboardUpload&&this.buildEventClipboardUpload(t))return!0;if(this.opts.cleanup){this.rtePaste=!0,this.selectionSave(),this.selectall||(!0===this.opts.autoresize&&!0!==this.fullscreen?(this.$editor.height(this.$editor.height()),this.saveScroll=this.document.body.scrollTop):this.saveScroll=this.$editor.scrollTop());var s=this.extractContent();setTimeout($.proxy(function(){var t=this.extractContent();this.$editor.append(s),this.selectionRestore();var e=this.getFragmentHtml(t);this.pasteClean(e),!0===this.opts.autoresize&&!0!==this.fullscreen&&this.$editor.css(\"height\",\"auto\")},this),1)}},buildEventClipboardUpload:function(t){var e=t.originalEvent||t;if(this.clipboardFilePaste=!1,void 0===e.clipboardData)return!1;if(e.clipboardData.items){var s=e.clipboardData.items[0].getAsFile();if(null!==s){this.bufferSet(),this.clipboardFilePaste=!0;var o=new FileReader;return o.onload=$.proxy(this.pasteClipboardUpload,this),o.readAsDataURL(s),!0}}return!1},buildEventKeydown:function(t){if(this.rtePaste)return!1;var e=t.which,s=t.ctrlKey||t.metaKey,o=this.getParent(),r=this.getCurrent(),a=this.getBlock(),n=!1;if(this.callback(\"keydown\",t),this.browser(\"mozilla\")&&\"modify\"in window.getSelection()&&s&&(37===t.keyCode||39===t.keyCode)){var l=this.getSelection(),c=t.metaKey?\"line\":\"word\";37!==t.keyCode||(l.modify(\"extend\",\"left\",c),t.shiftKey||l.collapseToStart()),39!==t.keyCode||(l.modify(\"extend\",\"right\",c),t.shiftKey||l.collapseToEnd()),t.preventDefault()}if(this.imageResizeHide(!1),(o&&\"CODE\"===$(o).get(0).tagName||r&&\"CODE\"===$(r).get(0).tagName)&&(n=!0,e===this.keyCode.DOWN&&this.insertAfterLastElement(a)),e===this.keyCode.DOWN&&(o&&\"BLOCKQUOTE\"===$(o)[0].tagName&&this.insertAfterLastElement(o),r&&\"BLOCKQUOTE\"===$(r)[0].tagName&&this.insertAfterLastElement(r),o&&\"P\"===$(o)[0].tagName&&\"BLOCKQUOTE\"==$(o).parent()[0].tagName&&this.insertAfterLastElement(o,$(o).parent()[0]),r&&\"P\"===$(r)[0].tagName&&o&&\"BLOCKQUOTE\"==$(o)[0].tagName&&this.insertAfterLastElement(r,o)),this.shortcuts(t,e),!s||90!==e||t.shiftKey||t.altKey){if(s&&90===e&&t.shiftKey&&!t.altKey){t.preventDefault(),0!=this.opts.rebuffer.length?this.bufferRedo():this.document.execCommand(\"redo\",!1,!1);return}}else{t.preventDefault(),this.opts.buffer.length?this.bufferUndo():this.document.execCommand(\"undo\",!1,!1);return}if(32==e&&this.bufferSet(),s&&65===e?(this.bufferSet(),this.selectall=!0):e==this.keyCode.LEFT_WIN||s||(this.selectall=!1),e!=this.keyCode.ENTER||t.shiftKey||t.ctrlKey||t.metaKey)e===this.keyCode.ENTER&&(t.ctrlKey||t.shiftKey)&&(this.bufferSet(),t.preventDefault(),this.insertLineBreak());else{var h=this.getRange();if(h&&!1===h.collapsed&&(sel=this.getSelection()).rangeCount&&h.deleteContents(),this.browser(\"msie\")&&1==o.nodeType&&(\"TD\"==o.tagName||\"TH\"==o.tagName))return t.preventDefault(),this.bufferSet(),this.insertNode(document.createElement(\"br\")),this.callback(\"enter\",t),!1;if(a&&(\"BLOCKQUOTE\"==a.tagName||\"BLOCKQUOTE\"==$(a).parent()[0].tagName)){if(this.isEndOfElement()){if(1==this.dblEnter){if(\"BLOCKQUOTE\"==a.tagName?(p=\"br\",d=a):(p=\"p\",d=$(a).parent()[0]),t.preventDefault(),this.insertingAfterLastElement(d),this.dblEnter=0,\"p\"==p)$(a).parent().find(\"p\").last().remove();else{var d,p,u=$.trim($(a).html());$(a).html(u.replace(/<br\\s?\\/?>$/i,\"\"))}return}this.dblEnter++}else this.dblEnter++}if(!0===n)return this.buildEventKeydownPre(t,r);if(!this.opts.linebreaks){if(a&&\"LI\"==a.tagName){var f=this.getBlock();if(!1!==f||\"LI\"===f.tagName){var m=$.trim($(a).text()),g=$.trim($(f).text());if(\"\"==m&&\"\"==g&&0==$(f).next(\"li\").length&&0==$(f).parents(\"li\").length){this.bufferSet();var b=$(f).closest(\"ol, ul\");$(f).remove();var v=$(\"<p>\"+this.opts.invisibleSpace+\"</p>\");return b.after(v),this.selectionStart(v),this.sync(),this.callback(\"enter\",t),!1}}}if(a&&this.opts.rBlockTest.test(a.tagName))this.bufferSet(),setTimeout($.proxy(function(){var t=this.getBlock();if(\"DIV\"===t.tagName&&!$(t).hasClass(\"redactor_editor\")){var e=$(\"<p>\"+this.opts.invisibleSpace+\"</p>\");$(t).replaceWith(e),this.selectionStart(e)}},this),1);else if(!1===a){this.bufferSet();var v=$(\"<p>\"+this.opts.invisibleSpace+\"</p>\");return this.insertNode(v[0]),this.selectionStart(v),this.callback(\"enter\",t),!1}}if(this.opts.linebreaks){if(!(a&&this.opts.rBlockTest.test(a.tagName)))return this.buildEventKeydownInsertLineBreak(t);this.bufferSet(),setTimeout($.proxy(function(){var t=this.getBlock();\"DIV\"!==t.tagName&&\"P\"!==t.tagName||$(t).hasClass(\"redactor_editor\")||this.replaceLineBreak(t)},this),1)}if(\"BLOCKQUOTE\"==a.tagName||\"FIGCAPTION\"==a.tagName)return this.buildEventKeydownInsertLineBreak(t);this.callback(\"enter\",t)}if((e===this.keyCode.TAB||t.metaKey&&219===e)&&this.opts.shortcuts)return this.buildEventKeydownTab(t,n,e);e===this.keyCode.BACKSPACE&&this.buildEventKeydownBackspace(t,r,o)},buildEventKeydownPre:function(t,e){t.preventDefault(),this.bufferSet();var s=$(e).parent().text();return this.insertNode(document.createTextNode(\"\\n\")),-1==s.search(/\\s$/)&&this.insertNode(document.createTextNode(\"\\n\")),this.sync(),this.callback(\"enter\",t),!1},buildEventKeydownTab:function(t,e,s){return!!(!this.opts.tabFocus||this.isEmpty(this.get())&&!1===this.opts.tabSpaces)||(t.preventDefault(),!0!==e||t.shiftKey?!1!==this.opts.tabSpaces?(this.bufferSet(),this.insertNode(document.createTextNode(Array(this.opts.tabSpaces+1).join(\"\\xa0\"))),this.sync()):t.shiftKey?this.indentingOutdent():this.indentingIndent():(this.bufferSet(),this.insertNode(document.createTextNode(\"\t\")),this.sync()),!1)},buildEventKeydownBackspace:function(t,e,s){if(s&&e&&\"TD\"==s.parentNode.tagName&&\"UL\"==s.tagName&&\"LI\"==e.tagName&&1==$(s).children(\"li\").length){var o;if(\"\"==$(e).text().replace(/[\\u200B-\\u200D\\uFEFF]/g,\"\")){var o=s.parentNode;return $(s).remove(),this.selectionStart(o),this.sync(),!1}}void 0!==e.tagName&&/^(H[1-6])$/i.test(e.tagName)&&(o=!1===this.opts.linebreaks?$(\"<p>\"+this.opts.invisibleSpace+\"</p>\"):$(\"<br>\"+this.opts.invisibleSpace),$(e).replaceWith(o),this.selectionStart(o),this.sync()),void 0!==e.nodeValue&&null!==e.nodeValue&&e.remove&&3===e.nodeType&&null==e.nodeValue.match(/[^\\u200B]/g)&&($(e).prev().remove(),this.sync())},buildEventKeydownInsertLineBreak:function(t){this.bufferSet(),t.preventDefault(),this.insertLineBreak(),this.callback(\"enter\",t)},buildEventKeyup:function(t){if(this.rtePaste)return!1;var e=t.which,s=this.getParent(),o=this.getCurrent();if(!this.opts.linebreaks&&3==o.nodeType&&(!1==s||\"BODY\"==s.tagName)){var r=$(\"<p>\").append($(o).clone());$(o).replaceWith(r);var a=$(r).next();void 0!==a[0]&&\"BR\"==a[0].tagName&&a.remove(),this.selectionEnd(r)}if((this.opts.convertLinks||this.opts.convertImageLinks||this.opts.convertVideoLinks)&&e===this.keyCode.ENTER&&this.buildEventKeyupConverters(),e===this.keyCode.DELETE||e===this.keyCode.BACKSPACE)return this.formatEmpty(t);this.callback(\"keyup\",t),this.sync(t)},buildEventKeyupConverters:function(){this.formatLinkify(this.opts.linkProtocol,this.opts.convertLinks,this.opts.convertImageLinks,this.opts.convertVideoLinks,this.opts.linkSize),setTimeout($.proxy(function(){this.opts.convertImageLinks&&this.observeImages(),this.opts.observeLinks&&this.observeLinks()},this),5)},buildPlugins:function(){this.opts.plugins&&$.each(this.opts.plugins,$.proxy(function(t,e){RedactorPlugins[e]&&($.extend(this,RedactorPlugins[e]),$.isFunction(RedactorPlugins[e].init)&&this.init())},this))},iframeStart:function(){this.iframeCreate(),this.opts.textareamode?this.iframeAppend(this.$source):(this.$sourceOld=this.$source.hide(),this.$source=this.buildCodearea(this.$sourceOld),this.iframeAppend(this.$sourceOld))},iframeAppend:function(t){this.$source.attr(\"dir\",this.opts.direction).hide(),this.$box.insertAfter(t).append(this.$frame).append(this.$source)},iframeCreate:function(){this.$frame=$('<iframe style=\"width: 100%;\" frameborder=\"0\" />').one(\"load\",$.proxy(function(){if(this.opts.fullpage){this.iframePage(),\"\"===this.content&&(this.content=this.opts.invisibleSpace),this.$frame.contents()[0].write(this.content),this.$frame.contents()[0].close();var t=setInterval($.proxy(function(){this.$frame.contents().find(\"body\").html()&&(clearInterval(t),this.iframeLoad())},this),0)}else this.iframeLoad()},this))},iframeDoc:function(){return this.$frame[0].contentWindow.document},iframePage:function(){var t=this.iframeDoc();return t.documentElement&&t.removeChild(t.documentElement),t},iframeAddCss:function(t){t=t||this.opts.css,this.isString(t)&&this.$frame.contents().find(\"head\").append('<link rel=\"stylesheet\" href=\"'+t+'\" />'),$.isArray(t)&&$.each(t,$.proxy(function(t,e){this.iframeAddCss(e)},this))},iframeLoad:function(){this.$editor=this.$frame.contents().find(\"body\").attr({contenteditable:!0,dir:this.opts.direction}),this.$editor[0]&&(this.document=this.$editor[0].ownerDocument,this.window=this.document.defaultView||window),this.iframeAddCss(),this.opts.fullpage?this.setFullpageOnInit(this.$source.val()):this.set(this.content,!0,!1),this.buildOptions(),this.buildAfter()},placeholderInit:function(){!1!==this.opts.placeholder?(this.placeholderText=this.opts.placeholder,this.opts.placeholder=!0):void 0===this.$element.attr(\"placeholder\")||\"\"==this.$element.attr(\"placeholder\")?this.opts.placeholder=!1:(this.placeholderText=this.$element.attr(\"placeholder\"),this.opts.placeholder=!0)},placeholderStart:function(t){return!1!==this.opts.placeholder&&(this.isEmpty(t)?(this.opts.focus=!1,this.placeholderOnFocus(),this.placeholderOnBlur(),this.placeholderGet()):(this.placeholderOnBlur(),!1))},placeholderOnFocus:function(){this.$editor.on(\"focus.redactor_placeholder\",$.proxy(this.placeholderFocus,this))},placeholderOnBlur:function(){this.$editor.on(\"blur.redactor_placeholder\",$.proxy(this.placeholderBlur,this))},placeholderGet:function(){var t=$('<span class=\"redactor_placeholder\">').data(\"redactor\",\"verified\").attr(\"contenteditable\",!1).text(this.placeholderText);return!1===this.opts.linebreaks?$(\"<p>\").append(t):t},placeholderBlur:function(){var t=this.get();this.isEmpty(t)&&(this.placeholderOnFocus(),this.$editor.html(this.placeholderGet()))},placeholderFocus:function(){this.$editor.find(\"span.redactor_placeholder\").remove();var t=\"\";!1===this.opts.linebreaks&&(t=this.opts.emptyHtml),this.$editor.off(\"focus.redactor_placeholder\"),this.$editor.html(t),!1===this.opts.linebreaks?this.selectionStart(this.$editor.children()[0]):this.focus(),this.sync()},placeholderRemoveFromEditor:function(){this.$editor.find(\"span.redactor_placeholder\").remove(),this.$editor.off(\"focus.redactor_placeholder\")},placeholderRemoveFromCode:function(t){return t.replace(/<span class=\"redactor_placeholder\"(.*?)>(.*?)<\\/span>/i,\"\")},shortcuts:function(e,key){if(!this.opts.shortcuts)return(e.ctrlKey||e.metaKey)&&(66===key||73===key)&&e.preventDefault(),!1;$.each(this.opts.shortcuts,$.proxy(function(str,command){var keys=str.split(\",\");for(var i in keys)\"string\"==typeof keys[i]&&this.shortcutsHandler(e,$.trim(keys[i]),$.proxy(function(){eval(command)},this))},this))},shortcutsHandler:function(t,e,s){var o={8:\"backspace\",9:\"tab\",10:\"return\",13:\"return\",16:\"shift\",17:\"ctrl\",18:\"alt\",19:\"pause\",20:\"capslock\",27:\"esc\",32:\"space\",33:\"pageup\",34:\"pagedown\",35:\"end\",36:\"home\",37:\"left\",38:\"up\",39:\"right\",40:\"down\",45:\"insert\",46:\"del\",59:\";\",61:\"=\",96:\"0\",97:\"1\",98:\"2\",99:\"3\",100:\"4\",101:\"5\",102:\"6\",103:\"7\",104:\"8\",105:\"9\",106:\"*\",107:\"+\",109:\"-\",110:\".\",111:\"/\",112:\"f1\",113:\"f2\",114:\"f3\",115:\"f4\",116:\"f5\",117:\"f6\",118:\"f7\",119:\"f8\",120:\"f9\",121:\"f10\",122:\"f11\",123:\"f12\",144:\"numlock\",145:\"scroll\",173:\"-\",186:\";\",187:\"=\",188:\",\",189:\"-\",190:\".\",191:\"/\",192:\"`\",219:\"[\",220:\"\\\\\",221:\"]\",222:\"'\"},r={\"`\":\"~\",1:\"!\",2:\"@\",3:\"#\",4:\"$\",5:\"%\",6:\"^\",7:\"&\",8:\"*\",9:\"(\",0:\")\",\"-\":\"_\",\"=\":\"+\",\";\":\": \",\"'\":'\"',\",\":\"<\",\".\":\">\",\"/\":\"?\",\"\\\\\":\"|\"};e=e.toLowerCase().split(\" \");var a=o[t.keyCode],n=String.fromCharCode(t.which).toLowerCase(),l=\"\",c={};$.each([\"alt\",\"ctrl\",\"meta\",\"shift\"],function(e,s){t[s+\"Key\"]&&a!==s&&(l+=s+\"+\")}),a&&(c[l+a]=!0),n&&(c[l+n]=!0,c[l+r[n]]=!0,\"shift+\"===l&&(c[r[n]]=!0));for(var h=0,d=e.length;h<d;h++)if(c[e[h]])return t.preventDefault(),s.apply(this,arguments)},focus:function(){this.browser(\"opera\")?this.$editor.focus():this.window.setTimeout($.proxy(this.focusSet,this,!0),1)},focusWithSaveScroll:function(){if(this.browser(\"msie\"))var t=this.document.documentElement.scrollTop;this.$editor.focus(),this.browser(\"msie\")&&(this.document.documentElement.scrollTop=t)},focusEnd:function(){if(this.browser(\"mozilla\")){if(!1===this.opts.linebreaks){var t=this.$editor.children().last();this.$editor.focus(),this.selectionEnd(t)}else this.focusSet()}else this.focusSet()},focusSet:function(t,e){this.$editor.focus(),void 0===e&&(e=this.$editor[0]);var s=this.getRange();s.selectNodeContents(e),s.collapse(t||!1);var o=this.getSelection();o.removeAllRanges(),o.addRange(s)},toggle:function(t){this.opts.visual?this.toggleCode(t):this.toggleVisual()},toggleVisual:function(){var t=this.$source.hide().val();if(void 0!==this.modified){var e=this.modified.replace(/\\n/g,\"\"),s=t.replace(/\\n/g,\"\");s=this.cleanRemoveSpaces(s,!1),this.modified=this.cleanRemoveSpaces(e,!1)!==s}this.modified&&(this.opts.fullpage&&\"\"===t?this.setFullpageOnInit(t):(this.set(t),this.opts.fullpage&&this.buildBindKeyboard()),this.callback(\"change\",!1,t)),this.opts.iframe?this.$frame.show():this.$editor.show(),this.opts.fullpage&&this.$editor.attr(\"contenteditable\",!0),this.$source.off(\"keydown.redactor-textarea-indenting\"),this.$editor.focus(),this.selectionRestore(),this.observeStart(),this.buttonActiveVisual(),this.buttonInactive(\"html\"),this.opts.visual=!0},toggleCode:function(t){!1!==t&&this.selectionSave();var e=null;this.opts.iframe?(e=this.$frame.height(),this.opts.fullpage&&this.$editor.removeAttr(\"contenteditable\"),this.$frame.hide()):(e=this.$editor.innerHeight(),this.$editor.hide());var s=this.$source.val();\"\"!==s&&this.opts.tidyHtml&&this.$source.val(this.cleanHtml(s)),this.modified=s,this.$source.height(e).show().focus(),this.$source.on(\"keydown.redactor-textarea-indenting\",this.textareaIndenting),this.buttonInactiveVisual(),this.buttonActive(\"html\"),this.opts.visual=!1},textareaIndenting:function(t){if(9===t.keyCode){var e=$(this),s=e.get(0).selectionStart;return e.val(e.val().substring(0,s)+\"\t\"+e.val().substring(e.get(0).selectionEnd)),e.get(0).selectionStart=e.get(0).selectionEnd=s+1,!1}},autosave:function(){var t=!1;this.autosaveInterval=setInterval($.proxy(function(){var e=this.get();if(t!==e){var s=this.$source.attr(\"name\");$.ajax({url:this.opts.autosave,type:\"post\",data:\"name=\"+s+\"&\"+s+\"=\"+escape(encodeURIComponent(e)),success:$.proxy(function(s){var o=$.parseJSON(s);void 0===o.error?this.callback(\"autosave\",!1,o):this.callback(\"autosaveError\",!1,o),t=e},this)})}},this),1e3*this.opts.autosaveInterval)},toolbarBuild:function(){if(this.isMobile()&&this.opts.buttonsHideOnMobile.length>0&&$.each(this.opts.buttonsHideOnMobile,$.proxy(function(t,e){var s=this.opts.buttons.indexOf(e);this.opts.buttons.splice(s,1)},this)),this.opts.air)this.opts.buttons=this.opts.airButtons;else if(!this.opts.buttonSource){var t=this.opts.buttons.indexOf(\"html\");this.opts.buttons.splice(t,1)}if(this.opts.toolbar&&$.each(this.opts.toolbar.formatting.dropdown,$.proxy(function(t,e){\"-1\"==$.inArray(t,this.opts.formattingTags)&&delete this.opts.toolbar.formatting.dropdown[t]},this)),0===this.opts.buttons.length)return!1;this.airEnable(),this.$toolbar=$(\"<ul>\").addClass(\"redactor_toolbar\").attr(\"id\",\"redactor_toolbar_\"+this.uuid),this.opts.typewriter&&this.$toolbar.addClass(\"redactor-toolbar-typewriter\"),this.opts.toolbarOverflow&&this.isMobile()&&this.$toolbar.addClass(\"redactor-toolbar-overflow\"),this.opts.air?(this.$air=$('<div class=\"redactor_air\">').attr(\"id\",\"redactor_air_\"+this.uuid).hide(),this.$air.append(this.$toolbar),$(\"body\").append(this.$air)):this.opts.toolbarExternal?(this.$toolbar.addClass(\"redactor-toolbar-external\"),$(this.opts.toolbarExternal).html(this.$toolbar)):this.$box.prepend(this.$toolbar),$.each(this.opts.buttons,$.proxy(function(t,e){if(this.opts.toolbar[e]){var s=this.opts.toolbar[e];if(!1===this.opts.fileUpload&&\"file\"===e)return!0;this.$toolbar.append($(\"<li>\").append(this.buttonBuild(e,s)))}},this)),this.$toolbar.find(\"a\").attr(\"tabindex\",\"-1\"),this.opts.toolbarFixed&&(this.toolbarObserveScroll(),$(this.opts.toolbarFixedTarget).on(\"scroll.redactor\",$.proxy(this.toolbarObserveScroll,this))),this.opts.activeButtons&&this.$editor.on(\"mouseup.redactor keyup.redactor\",$.proxy(this.buttonActiveObserver,this))},toolbarObserveScroll:function(){var t=$(this.opts.toolbarFixedTarget).scrollTop(),e=0,s=0,o=0;if(o=(e=this.opts.toolbarFixedTarget===document?this.$box.offset().top:1)+this.$box.height()+40,t>e){var r=\"100%\";this.opts.toolbarFixedBox&&(s=this.$box.offset().left,r=this.$box.innerWidth(),this.$toolbar.addClass(\"toolbar_fixed_box\")),this.toolbarFixed=!0,this.opts.toolbarFixedTarget===document?this.$toolbar.css({position:\"fixed\",width:r,zIndex:10005,top:this.opts.toolbarFixedTopOffset+\"px\",left:s}):this.$toolbar.css({position:\"absolute\",width:r,zIndex:10005,top:this.opts.toolbarFixedTopOffset+t+\"px\",left:0}),t<o?this.$toolbar.css(\"visibility\",\"visible\"):this.$toolbar.css(\"visibility\",\"hidden\")}else this.toolbarFixed=!1,this.$toolbar.css({position:\"relative\",width:\"auto\",top:0,left:s}),this.opts.toolbarFixedBox&&this.$toolbar.removeClass(\"toolbar_fixed_box\")},airEnable:function(){this.opts.air&&this.$editor.on(\"mouseup.redactor keyup.redactor\",this,$.proxy(function(t){var e=this.getSelectionText();if(\"mouseup\"===t.type&&\"\"!=e&&this.airShow(t),\"keyup\"===t.type&&t.shiftKey&&\"\"!=e){var s=$(this.getElement(this.getSelection().focusNode)),o=s.offset();o.height=s.height(),this.airShow(o,!0)}},this))},airShow:function(t,e){if(this.opts.air){if(this.selectionSave(),$(\".redactor_air\").hide(),e)s=t.left,o=t.top+t.height+14,this.opts.iframe&&(o+=this.$box.position().top-$(this.document).scrollTop(),s+=this.$box.position().left);else{var s,o,r=this.$air.innerWidth();s=t.clientX,$(this.document).width()<s+r&&(s-=r),o=t.clientY+14,this.opts.iframe?(o+=this.$box.position().top,s+=this.$box.position().left):o+=$(this.document).scrollTop()}this.$air.css({left:s+\"px\",top:o+\"px\"}).show(),this.airBindHide()}},airBindHide:function(){if(this.opts.air){var t=$.proxy(function(t){$(t).on(\"mousedown.redactor\",$.proxy(function(e){0===$(e.target).closest(this.$toolbar).length&&(this.$air.fadeOut(100),this.selectionRemove(),$(t).off(e))},this)).on(\"keydown.redactor\",$.proxy(function(e){e.which===this.keyCode.ESC&&this.getSelection().collapseToStart(),this.$air.fadeOut(100),$(t).off(e)},this))},this);t(document),this.opts.iframe&&t(this.document)}},airBindMousemoveHide:function(){if(this.opts.air){var t=$.proxy(function(t){$(t).on(\"mousemove.redactor\",$.proxy(function(e){0===$(e.target).closest(this.$toolbar).length&&(this.$air.fadeOut(100),$(t).off(e))},this))},this);t(document),this.opts.iframe&&t(this.document)}},dropdownBuild:function(t,e){$.each(e,$.proxy(function(e,s){var o;s.className||(s.className=\"\"),\"separator\"===s.name?o=$('<a class=\"redactor_separator_drop\">'):(o=$('<a href=\"#\" class=\"'+s.className+\" redactor_dropdown_\"+e+'\">'+s.title+\"</a>\")).on(\"click\",$.proxy(function(t){this.opts.air&&this.selectionRestore(),t.preventDefault&&t.preventDefault(),this.browser(\"msie\")&&(t.returnValue=!1),s.callback&&s.callback.call(this,e,o,s,t),s.exec&&this.execCommand(s.exec,e),s.func&&this[s.func](e),this.buttonActiveObserver(),this.opts.air&&this.$air.fadeOut(100)},this)),t.append(o)},this))},dropdownShow:function(t,e){if(!this.opts.visual)return t.preventDefault(),!1;var s=this.buttonGet(e),o=s.data(\"dropdown\").appendTo(document.body);if(s.hasClass(\"dropact\"))this.dropdownHideAll();else{this.dropdownHideAll(),this.callback(\"dropdownShow\",{dropdown:o,key:e,button:s}),this.buttonActive(e),s.addClass(\"dropact\");var r=s.offset(),a=o.width();r.left+a>$(document).width()&&(r.left-=a);var n=r.left+\"px\",l=s.innerHeight(),c=\"absolute\",h=l+this.opts.toolbarFixedTopOffset+\"px\";this.opts.toolbarFixed&&this.toolbarFixed?c=\"fixed\":h=r.top+l+\"px\",o.css({position:c,left:n,top:h}).show(),this.callback(\"dropdownShown\",{dropdown:o,key:e,button:s})}var d=$.proxy(function(t){this.dropdownHide(t,o)},this);$(document).one(\"click\",d),this.$editor.one(\"click\",d),this.$editor.one(\"touchstart\",d),t.stopPropagation(),this.focusWithSaveScroll()},dropdownHideAll:function(){this.$toolbar.find(\"a.dropact\").removeClass(\"redactor_act\").removeClass(\"dropact\"),$(\".redactor_dropdown\").hide(),this.callback(\"dropdownHide\")},dropdownHide:function(t,e){$(t.target).hasClass(\"dropact\")||(e.removeClass(\"dropact\"),this.dropdownHideAll())},buttonBuild:function(t,e,s){var o=$('<a href=\"javascript:;\" title=\"'+e.title+'\" tabindex=\"-1\" class=\"re-icon re-'+t+'\"></a>');if(void 0!==s&&o.addClass(\"redactor-btn-image\"),o.on(\"click\",$.proxy(function(s){if(s.preventDefault&&s.preventDefault(),this.browser(\"msie\")&&(s.returnValue=!1),o.hasClass(\"redactor_button_disabled\"))return!1;!1!==this.isFocused()||e.exec||this.focusWithSaveScroll(),e.exec?(this.focusWithSaveScroll(),this.execCommand(e.exec,t),this.airBindMousemoveHide()):e.func&&\"show\"!==e.func?(this[e.func](t),this.airBindMousemoveHide()):e.callback?(e.callback.call(this,t,o,e,s),this.airBindMousemoveHide()):e.dropdown&&this.dropdownShow(s,t),this.buttonActiveObserver(!1,t)},this)),e.dropdown){var r=$('<div class=\"redactor_dropdown redactor_dropdown_box_'+t+'\" style=\"display: none;\">');o.data(\"dropdown\",r),this.dropdownBuild(r,e.dropdown)}return o},buttonGet:function(t){return!!this.opts.toolbar&&$(this.$toolbar.find(\"a.re-\"+t))},buttonTagToActiveState:function(t,e){this.opts.activeButtons.push(t),this.opts.activeButtonsStates[e]=t},buttonActiveToggle:function(t){this.buttonGet(t).hasClass(\"redactor_act\")?this.buttonInactive(t):this.buttonActive(t)},buttonActive:function(t){this.buttonGet(t).addClass(\"redactor_act\")},buttonInactive:function(t){this.buttonGet(t).removeClass(\"redactor_act\")},buttonInactiveAll:function(t){this.$toolbar.find(\"a.re-icon\").not(\".re-\"+t).removeClass(\"redactor_act\")},buttonActiveVisual:function(){this.$toolbar.find(\"a.re-icon\").not(\"a.re-html\").removeClass(\"redactor_button_disabled\")},buttonInactiveVisual:function(){this.$toolbar.find(\"a.re-icon\").not(\"a.re-html\").addClass(\"redactor_button_disabled\")},buttonChangeIcon:function(t,e){this.buttonGet(t).addClass(\"re-\"+e)},buttonRemoveIcon:function(t,e){this.buttonGet(t).removeClass(\"re-\"+e)},buttonAwesome:function(t,e){var s=this.buttonGet(t);s.removeClass(\"redactor-btn-image\"),s.addClass(\"fa-redactor-btn\"),s.html('<i class=\"fa '+e+'\"></i>')},buttonAdd:function(t,e,s,o){if(this.opts.toolbar){var r=this.buttonBuild(t,{title:e,callback:s,dropdown:o},!0);return this.$toolbar.append($(\"<li>\").append(r)),r}},buttonAddFirst:function(t,e,s,o){if(this.opts.toolbar){var r=this.buttonBuild(t,{title:e,callback:s,dropdown:o},!0);this.$toolbar.prepend($(\"<li>\").append(r))}},buttonAddAfter:function(t,e,s,o,r){if(this.opts.toolbar){var a=this.buttonBuild(e,{title:s,callback:o,dropdown:r},!0),n=this.buttonGet(t);return 0!==n.length?n.parent().after($(\"<li>\").append(a)):this.$toolbar.append($(\"<li>\").append(a)),a}},buttonAddBefore:function(t,e,s,o,r){if(this.opts.toolbar){var a=this.buttonBuild(e,{title:s,callback:o,dropdown:r},!0),n=this.buttonGet(t);return 0!==n.length?n.parent().before($(\"<li>\").append(a)):this.$toolbar.append($(\"<li>\").append(a)),a}},buttonRemove:function(t){this.buttonGet(t).remove()},buttonActiveObserver:function(t,e){var s=this.getParent();if(this.buttonInactiveAll(e),!1===t&&\"html\"!==e){-1!=$.inArray(e,this.opts.activeButtons)&&this.buttonActiveToggle(e);return}s&&\"A\"===s.tagName?this.$toolbar.find(\"a.redactor_dropdown_link\").text(this.opts.curLang.link_edit):this.$toolbar.find(\"a.redactor_dropdown_link\").text(this.opts.curLang.link_insert),$.each(this.opts.activeButtonsStates,$.proxy(function(t,e){0!=$(s).closest(t,this.$editor.get()[0]).length&&this.buttonActive(e)},this));var o=$(s).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0]);if(o.length){var r=o.css(\"text-align\");\"\"==r&&(r=\"left\"),this.buttonActive(\"align\"+r)}},execPasteFrag:function(t){var e=this.getSelection();if(e.getRangeAt&&e.rangeCount){var s=this.getRange();s.deleteContents();var o=this.document.createElement(\"div\");o.innerHTML=t;for(var r,a,n=this.document.createDocumentFragment();r=o.firstChild;)a=n.appendChild(r);n.firstChild,s.insertNode(n),a&&((s=s.cloneRange()).setStartAfter(a),s.collapse(!0)),e.removeAllRanges(),e.addRange(s)}},exec:function(t,e,s){\"formatblock\"===t&&this.browser(\"msie\")&&(e=\"<\"+e+\">\"),\"inserthtml\"===t&&this.browser(\"msie\")?this.isIe11()?this.execPasteFrag(e):(this.focusWithSaveScroll(),this.document.selection.createRange().pasteHTML(e)):this.document.execCommand(t,!1,e),!1!==s&&this.sync(),this.callback(\"execCommand\",t,e)},execCommand:function(t,e,s){if(!this.opts.visual)return this.$source.focus(),!1;if((\"bold\"===t||\"italic\"===t||\"underline\"===t||\"strikethrough\"===t)&&this.bufferSet(),\"superscript\"===t||\"subscript\"===t){var o=this.getParent();(\"SUP\"===o.tagName||\"SUB\"===o.tagName)&&this.inlineRemoveFormatReplace(o)}if(\"inserthtml\"===t){this.insertHtml(e,s),this.callback(\"execCommand\",t,e);return}return(!this.currentOrParentIs(\"CODE\")||!!this.opts.formattingPre)&&(\"insertunorderedlist\"===t||\"insertorderedlist\"===t?this.execLists(t,e):\"unlink\"===t?this.execUnlink(t,e):void(this.exec(t,e,s),\"inserthorizontalrule\"===t&&this.$editor.find(\"hr\").removeAttr(\"id\")))},execUnlink:function(t,e){this.bufferSet();var s=this.currentOrParentIs(\"A\");if(s){$(s).replaceWith($(s).text()),this.sync(),this.callback(\"execCommand\",t,e);return}},execLists:function(t,e){this.bufferSet();var s=this.getParent(),o=$(s).closest(\"ol, ul\");this.isParentRedactor(o)||0==o.length||(o=!1);var r=!1;if(o&&o.length){r=!0;var a=o[0].tagName;(\"insertunorderedlist\"===t&&\"OL\"===a||\"insertorderedlist\"===t&&\"UL\"===a)&&(r=!1)}if(this.selectionSave(),r){var n=this.getNodes(),l=this.getBlocks(n);void 0!==n[0]&&n.length>1&&3==n[0].nodeType&&l.unshift(this.getBlock());var c=\"\",h=\"\";$.each(l,$.proxy(function(t,e){if(\"LI\"==e.tagName){var s=$(e),o=s.clone();(o.find(\"ul\",\"ol\").remove(),!1===this.opts.linebreaks)?c+=this.outerHtml($(\"<p>\").append(o.contents())):c+=o.html().replace(/<br\\s?\\/?>$/i,\"\")+\"<br>\",0==t?(s.addClass(\"redactor-replaced\").empty(),h=this.outerHtml(s)):s.remove()}},this)),html=this.$editor.html().replace(h,\"</\"+a+\">\"+c+\"<\"+a+\">\"),this.$editor.html(html),this.$editor.find(a+\":empty\").remove()}else{var d=$(this.getParent()).closest(\"td\");if(this.browser(\"msie\")&&!this.isIe11()&&this.opts.linebreaks){var p=this.selectionWrap(\"div\"),u=$(p).html(),f=$(\"<ul>\");\"insertorderedlist\"==t&&(f=$(\"<ol>\"));var m=$(\"<li>\");\"\"==$.trim(u)?(m.append(u+'<span id=\"selection-marker-1\">'+this.opts.invisibleSpace+\"</span>\"),f.append(m),this.$editor.find(\"#selection-marker-1\").replaceWith(f)):(m.append(u),f.append(m),$(p).replaceWith(f))}else this.document.execCommand(t);var s=this.getParent(),o=$(s).closest(\"ol, ul\");if(!1===this.opts.linebreaks&&\"\"==$.trim(o.text())&&(o.children(\"li\").find(\"br\").remove(),o.children(\"li\").append('<span id=\"selection-marker-1\">'+this.opts.invisibleSpace+\"</span>\")),0!=d.length&&o.wrapAll(\"<td>\"),o.length){var g=o.parent();this.isParentRedactor(g)&&\"LI\"!=g[0].tagName&&this.nodeTestBlocks(g[0])&&g.replaceWith(g.contents())}this.browser(\"mozilla\")&&this.$editor.focus()}this.selectionRestore(),this.$editor.find(\"#selection-marker-1\").removeAttr(\"id\"),this.sync(),this.callback(\"execCommand\",t,e)},indentingIndent:function(){this.indentingStart(\"indent\")},indentingOutdent:function(){this.indentingStart(\"outdent\")},indentingStart:function(t){if(this.bufferSet(),\"indent\"===t){var e=this.getBlock();if(this.selectionSave(),e&&\"LI\"==e.tagName){var s=$(this.getParent()).closest(\"ol, ul\")[0].tagName,o=this.getBlocks();$.each(o,function(t,e){if(\"LI\"==e.tagName){var o=$(e).prev();if(0!=o.length&&\"LI\"==o[0].tagName){var r=o.children(\"ul, ol\");0==r.length?o.append($(\"<\"+s+\">\").append(e)):r.append(e)}}})}else if(!1===e&&!0===this.opts.linebreaks){this.exec(\"formatBlock\",\"blockquote\");var r=this.getBlock(),e=$('<div data-tagblock=\"\">').html($(r).html());$(r).replaceWith(e);var a=this.normalize($(e).css(\"margin-left\"))+this.opts.indentValue;$(e).css(\"margin-left\",a+\"px\")}else{var n=this.getBlocks();$.each(n,$.proxy(function(t,e){var s=!1;if(\"TD\"!==e.tagName){s=-1!==$.inArray(e.tagName,this.opts.alignmentTags)?$(e):$(e).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0]);var o=this.normalize(s.css(\"margin-left\"))+this.opts.indentValue;s.css(\"margin-left\",o+\"px\")}},this))}this.selectionRestore()}else{this.selectionSave();var e=this.getBlock();if(e&&\"LI\"==e.tagName){var o=this.getBlocks(),l=0;this.insideOutdent(e,l,o)}else{var n=this.getBlocks();$.each(n,$.proxy(function(t,e){var s=!1;s=-1!==$.inArray(e.tagName,this.opts.alignmentTags)?$(e):$(e).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0]);var o=this.normalize(s.css(\"margin-left\"))-this.opts.indentValue;o<=0?!0===this.opts.linebreaks&&void 0!==s.data(\"tagblock\")?s.replaceWith(s.html()+\"<br>\"):(s.css(\"margin-left\",\"\"),this.removeEmptyAttr(s,\"style\")):s.css(\"margin-left\",o+\"px\")},this))}this.selectionRestore()}this.sync()},insideOutdent:function(t,e,s){if(t&&\"LI\"==t.tagName){var o=$(t).parent().parent();0!=o.length&&\"LI\"==o[0].tagName?o.after(t):void 0!==s[e]?(t=s[e],e++,this.insideOutdent(t,e,s)):this.execCommand(\"insertunorderedlist\")}},alignmentLeft:function(){this.alignmentSet(\"\",\"JustifyLeft\")},alignmentRight:function(){this.alignmentSet(\"right\",\"JustifyRight\")},alignmentCenter:function(){this.alignmentSet(\"center\",\"JustifyCenter\")},alignmentJustify:function(){this.alignmentSet(\"justify\",\"JustifyFull\")},alignmentSet:function(t,e){if(this.bufferSet(),this.oldIE())return this.document.execCommand(e,!1,!1),!0;this.selectionSave();var s=this.getBlock();if(!s&&this.opts.linebreaks){this.exec(\"formatblock\",\"div\");var o=this.getBlock(),s=$('<div data-tagblock=\"\">').html($(o).html());$(o).replaceWith(s),$(s).css(\"text-align\",t),this.removeEmptyAttr(s,\"style\"),\"\"==t&&void 0!==$(s).data(\"tagblock\")&&$(s).replaceWith($(s).html())}else{var r=this.getBlocks();$.each(r,$.proxy(function(e,s){var o=!1;(o=-1!==$.inArray(s.tagName,this.opts.alignmentTags)?$(s):$(s).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0]))&&(o.css(\"text-align\",t),this.removeEmptyAttr(o,\"style\"))},this))}this.selectionRestore(),this.sync()},cleanEmpty:function(t){var e=this.placeholderStart(t);return!1!==e?e:(!1===this.opts.linebreaks&&(\"\"===t?t=this.opts.emptyHtml:-1!==t.search(/^<hr\\s?\\/?>$/gi)&&(t=\"<hr>\"+this.opts.emptyHtml)),t)},cleanConverters:function(t){return this.opts.convertDivs&&!this.opts.gallery&&(t=t.replace(/<div(.*?)>([\\w\\W]*?)<\\/div>/gi,\"<p$1>$2</p>\")),this.opts.paragraphy&&(t=this.cleanParagraphy(t)),t},cleanConvertProtected:function(t){return this.opts.templateVars&&(t=(t=t.replace(/\\{\\{(.*?)\\}\\}/gi,\"<!-- template double $1 -->\")).replace(/\\{(.*?)\\}/gi,\"<!-- template $1 -->\")),t=(t=(t=t.replace(/<script(.*?)>([\\w\\W]*?)<\\/script>/gi,'<title type=\"text/javascript\" style=\"display: none;\" class=\"redactor-script-tag\"$1>$2</title>')).replace(/<style(.*?)>([\\w\\W]*?)<\\/style>/gi,'<section$1 style=\"display: none;\" rel=\"redactor-style-tag\">$2</section>')).replace(/<form(.*?)>([\\w\\W]*?)<\\/form>/gi,'<section$1 rel=\"redactor-form-tag\">$2</section>'),t=this.opts.phpTags?t.replace(/<\\?php([\\w\\W]*?)\\?>/gi,'<section style=\"display: none;\" rel=\"redactor-php-tag\">$1</section>'):t.replace(/<\\?php([\\w\\W]*?)\\?>/gi,\"\")},cleanReConvertProtected:function(t){return this.opts.templateVars&&(t=(t=t.replace(/<!-- template double (.*?) -->/gi,\"{{$1}}\")).replace(/<!-- template (.*?) -->/gi,\"{$1}\")),t=(t=(t=t.replace(/<title type=\"text\\/javascript\" style=\"display: none;\" class=\"redactor-script-tag\"(.*?)>([\\w\\W]*?)<\\/title>/gi,'<script$1 type=\"text/javascript\">$2</script>')).replace(/<section(.*?) style=\"display: none;\" rel=\"redactor-style-tag\">([\\w\\W]*?)<\\/section>/gi,\"<style$1>$2</style>\")).replace(/<section(.*?)rel=\"redactor-form-tag\"(.*?)>([\\w\\W]*?)<\\/section>/gi,\"<form$1$2>$3</form>\"),this.opts.phpTags&&(t=t.replace(/<section style=\"display: none;\" rel=\"redactor-php-tag\">([\\w\\W]*?)<\\/section>/gi,\"<?php\\r\\n$1\\r\\n?>\")),t},cleanRemoveSpaces:function(t,e){if(!1!==e){var e=[],s=t.match(/<(code|style|script|title)(.*?)>([\\w\\W]*?)<\\/(code|style|script|title)>/gi);if(null===s&&(s=[]),this.opts.phpTags){var o=t.match(/<\\?php([\\w\\W]*?)\\?>/gi);o&&(s=$.merge(s,o))}s&&$.each(s,function(s,o){t=t.replace(o,\"buffer_\"+s),e.push(o)})}return t=(t=(t=(t=(t=(t=t.replace(/\\n/g,\" \")).replace(/[\\t]*/g,\"\")).replace(/\\n\\s*\\n/g,\"\\n\")).replace(/^[\\s\\n]*/g,\" \")).replace(/[\\s\\n]*$/g,\" \")).replace(/>\\s{2,}</g,\"> <\"),t=(t=this.cleanReplacer(t,e)).replace(/\\n\\n/g,\"\\n\")},cleanReplacer:function(t,e){return!1===e||$.each(e,function(e,s){t=t.replace(\"buffer_\"+e,s)}),t},cleanRemoveEmptyTags:function(t){t=t.replace(/[\\u200B-\\u200D\\uFEFF]/g,\"\");for(var e=[\"<b>\\\\s*</b>\",\"<b>&nbsp;</b>\",\"<em>\\\\s*</em>\"],s=[\"<code></code>\",\"<blockquote>\\\\s*</blockquote>\",\"<dd></dd>\",\"<dt></dt>\",\"<ul></ul>\",\"<ol></ol>\",\"<li></li>\",\"<table></table>\",\"<tr></tr>\",\"<span>\\\\s*<span>\",\"<span>&nbsp;<span>\",\"<p>\\\\s*</p>\",\"<p></p>\",\"<p>&nbsp;</p>\",\"<p>\\\\s*<br>\\\\s*</p>\",\"<div>\\\\s*</div>\",\"<div>\\\\s*<br>\\\\s*</div>\"],o=(s=this.opts.removeEmptyTags?s.concat(e):e).length,r=0;r<o;++r)t=t.replace(RegExp(s[r],\"gi\"),\"\");return t},cleanParagraphy:function(t){if(t=$.trim(t),!0===this.opts.linebreaks)return t;if(\"\"===t||\"<p></p>\"===t)return this.opts.emptyHtml;if(t+=\"\\n\",!1===this.opts.removeEmptyTags)return t;var e=[],s=t.match(/<(table|div|code|object)(.*?)>([\\w\\W]*?)<\\/(table|div|code|object)>/gi);s||(s=[]);var o=t.match(/<!--([\\w\\W]*?)-->/gi);if(o&&(s=$.merge(s,o)),this.opts.phpTags){var r=t.match(/<section(.*?)rel=\"redactor-php-tag\">([\\w\\W]*?)<\\/section>/gi);r&&(s=$.merge(s,r))}function a(e,s,o){return t.replace(RegExp(e,s),o)}s&&$.each(s,function(s,o){e[s]=o,t=t.replace(o,\"{replace\"+s+\"}\\n\")}),t=(t=t.replace(/<br \\/>\\s*<br \\/>/gi,\"\\n\\n\")).replace(/<br><br>/gi,\"\\n\\n\");var n=\"(comment|html|body|head|title|meta|style|script|link|iframe|table|thead|tfoot|caption|col|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|code|select|option|form|map|area|blockquote|address|math|style|p|h[1-6]|hr|fieldset|legend|section|article|aside|hgroup|header|footer|nav|figure|figcaption|details|menu|summary)\";t=a(\"(<\"+n+\"[^>]*>)\",\"gi\",\"\\n$1\"),t=a(\"(</\"+n+\">)\",\"gi\",\"$1\\n\\n\"),t=a(\"\\r\\n\",\"g\",\"\\n\"),t=a(\"\\r\",\"g\",\"\\n\");var l=(t=a(\"/\\n\\n+/\",\"g\",\"\\n\\n\")).split(RegExp(\"\\ns*\\n\",\"g\"),-1);for(var c in t=\"\",l)l.hasOwnProperty(c)&&(-1==l[c].search(\"{replace\")?(l[c]=l[c].replace(/<p>\\n\\t?<\\/p>/gi,\"\"),l[c]=l[c].replace(/<p><\\/p>/gi,\"\"),\"\"!=l[c]&&(t+=\"<p>\"+l[c].replace(/^\\n+|\\n+$/g,\"\")+\"</p>\")):t+=l[c]);return t=a(\"<p><p>\",\"gi\",\"<p>\"),t=a(\"</p></p>\",\"gi\",\"</p>\"),t=a(\"<p>s?</p>\",\"gi\",\"\"),t=a(\"<p>([^<]+)</(div|address|form)>\",\"gi\",\"<p>$1</p></$2>\"),t=a(\"<p>(</?\"+n+\"[^>]*>)</p>\",\"gi\",\"$1\"),t=a(\"<p>(<li.+?)</p>\",\"gi\",\"$1\"),t=a(\"<p>s?(</?\"+n+\"[^>]*>)\",\"gi\",\"$1\"),t=a(\"(</?\"+n+\"[^>]*>)s?</p>\",\"gi\",\"$1\"),t=a(\"(</?\"+n+\"[^>]*>)s?<br />\",\"gi\",\"$1\"),t=a(\"<br />(s*</?(?:p|li|div|dl|dd|dt|th|code|td|ul|ol)[^>]*>)\",\"gi\",\"$1\"),t=a(\"\\n</p>\",\"gi\",\"</p>\"),t=a(\"<li><p>\",\"gi\",\"<li>\"),t=a(\"</p></li>\",\"gi\",\"</li>\"),t=a(\"</li><p>\",\"gi\",\"</li>\"),t=a(\"<p>\t?\\n?<p>\",\"gi\",\"<p>\"),t=a(\"</dt><p>\",\"gi\",\"</dt>\"),t=a(\"</dd><p>\",\"gi\",\"</dd>\"),t=a(\"<br></p></blockquote>\",\"gi\",\"</blockquote>\"),t=a(\"<p>\t*</p>\",\"gi\",\"\"),$.each(e,function(e,s){t=t.replace(\"{replace\"+e+\"}\",s)}),$.trim(t)},cleanConvertInlineTags:function(t,e){var s=\"strong\";\"b\"===this.opts.boldTag&&(s=\"b\");var o=\"em\";return\"i\"===this.opts.italicTag&&(o=\"i\"),t=(t=t.replace(/<span style=\"font-style: italic;\">([\\w\\W]*?)<\\/span>/gi,\"<\"+o+\">$1</\"+o+\">\")).replace(/<span style=\"font-weight: bold;\">([\\w\\W]*?)<\\/span>/gi,\"<\"+s+\">$1</\"+s+\">\"),t=\"strong\"===this.opts.boldTag?t.replace(/<b>([\\w\\W]*?)<\\/b>/gi,\"<strong>$1</strong>\"):t.replace(/<strong>([\\w\\W]*?)<\\/strong>/gi,\"<b>$1</b>\"),t=(t=\"em\"===this.opts.italicTag?t.replace(/<i>([\\w\\W]*?)<\\/i>/gi,\"<em>$1</em>\"):t.replace(/<em>([\\w\\W]*?)<\\/em>/gi,\"<i>$1</i>\")).replace(/<span style=\"text-decoration: underline;\">([\\w\\W]*?)<\\/span>/gi,\"<u>$1</u>\"),t=!0!==e?t.replace(/<strike>([\\w\\W]*?)<\\/strike>/gi,\"<del>$1</del>\"):t.replace(/<del>([\\w\\W]*?)<\\/del>/gi,\"<strike>$1</strike>\")},cleanStripTags:function(t){if(\"\"==t||void 0===t)return t;var e=!1;!1!==this.opts.allowedTags&&(e=!0);var s=!0===e?this.opts.allowedTags:this.opts.deniedTags,o=/<\\/?([a-z][a-z0-9]*)\\b[^>]*>/gi;return t=t.replace(o,function(t,o){return!0===e?$.inArray(o.toLowerCase(),s)>\"-1\"?t:\"\":$.inArray(o.toLowerCase(),s)>\"-1\"?\"\":t}),t=this.cleanConvertInlineTags(t)},cleanSavePreCode:function(t,e){var s=t.match(/<(pre|code)(.*?)>([\\w\\W]*?)<\\/(pre|code)>/gi);return null!==s&&$.each(s,$.proxy(function(s,o){var r=o.match(/<(pre|code)(.*?)>([\\w\\W]*?)<\\/(pre|code)>/i);r[3]=r[3].replace(/&nbsp;/g,\" \"),!1!==e&&(r[3]=this.cleanEncodeEntities(r[3])),r[3]=r[3].replace(/\\$/g,\"&#36;\"),t=t.replace(o,\"<\"+r[1]+r[2]+\">\"+r[3]+\"</\"+r[1]+\">\")},this)),t},cleanEncodeEntities:function(t){return(t=String(t).replace(/&amp;/g,\"&\").replace(/&lt;/g,\"<\").replace(/&gt;/g,\">\").replace(/&quot;/g,'\"')).replace(/&/g,\"&amp;\").replace(/</g,\"&lt;\").replace(/>/g,\"&gt;\").replace(/\"/g,\"&quot;\")},cleanUnverified:function(){var t=this.$editor.find(\"li, img, a, b, strong, sub, sup, i, em, u, small, strike, del, span, cite\");t.filter('[style*=\"background-color: transparent;\"][style*=\"line-height\"]').css(\"background-color\",\"\").css(\"line-height\",\"\"),t.filter('[style*=\"background-color: transparent;\"]').css(\"background-color\",\"\"),t.css(\"line-height\",\"\"),$.each(t,$.proxy(function(t,e){this.removeEmptyAttr(e,\"style\")},this));var e=this.$editor.find(\"b, strong, i, em, u, strike, del\");e.css(\"font-size\",\"\"),$.each(e,$.proxy(function(t,e){this.removeEmptyAttr(e,\"style\")},this)),this.$editor.find('div[style=\"text-align: -webkit-auto;\"]').contents().unwrap(),this.$editor.find(\"ul, ol, li\").removeAttr(\"style\")},cleanHtml:function(t){var e,s=0,o=t.length,r=0,a=null,n=null,l=\"\",c=\"\",h=\"\";for(this.cleanlevel=0;s<o;s++){if(r=s,-1==t.substr(s).indexOf(\"<\")){c+=t.substr(s);break}for(;r<o&&\"<\"!=t.charAt(r);)r++;for(s!=r&&((h=t.substr(s,r-s)).match(/^\\s{2,}$/g)||(\"\\n\"==c.charAt(c.length-1)?c+=this.cleanGetTabs():\"\\n\"==h.charAt(0)&&(c+=\"\\n\"+this.cleanGetTabs(),h=h.replace(/^\\s+/,\"\")),c+=h),h.match(/\\n/)&&(c+=\"\\n\"+this.cleanGetTabs())),a=r;r<o&&\">\"!=t.charAt(r);)r++;if(l=t.substr(a,r-a),s=r,\"!--\"==l.substr(1,3)){if(!l.match(/--$/)){for(;\"-->\"!=t.substr(r,3);)r++;r+=2,l=t.substr(a,r-a),s=r}\"\\n\"!=c.charAt(c.length-1)&&(c+=\"\\n\"),c+=this.cleanGetTabs(),c+=l+\">\\n\"}else\"!\"==l[1]?c=this.placeTag(l+\">\",c):\"?\"==l[1]?c+=l+\">\\n\":(e=l.match(/^<(script|style|pre|code)/i))?(e[1]=e[1].toLowerCase(),l=this.cleanTag(l),c=this.placeTag(l,c),(n=String(t.substr(s+1)).toLowerCase().indexOf(\"</\"+e[1]))&&(h=t.substr(s+1,n),s+=n,c+=h)):(l=this.cleanTag(l),c=this.placeTag(l,c))}return this.cleanFinish(c)},cleanGetTabs:function(){for(var t=\"\",e=0;e<this.cleanlevel;e++)t+=\"\t\";return t},cleanFinish:function(t){return t=(t=(t=(t=t.replace(/\\n\\s*\\n/g,\"\\n\")).replace(/^[\\s\\n]*/,\"\")).replace(/[\\s\\n]*$/,\"\")).replace(/<script(.*?)>\\n<\\/script>/gi,\"<script$1></script>\"),this.cleanlevel=0,t},cleanTag:function(t){var e,s=\"\";t=(t=(t=t.replace(/\\n/g,\" \")).replace(/\\s{2,}/g,\" \")).replace(/^\\s+|\\s+$/g,\" \");var o=\"\";for(t.match(/\\/$/)&&(o=\"/\",t=t.replace(/\\/+$/,\"\"));e=/\\s*([^= ]+)(?:=((['\"']).*?\\3|[^ ]+))?/.exec(t);)e[2]?s+=e[1].toLowerCase()+\"=\"+e[2]:e[1]&&(s+=e[1].toLowerCase()),s+=\" \",t=t.substr(e[0].length);return s.replace(/\\s*$/,\"\")+o+\">\"},placeTag:function(t,e){var s=t.match(this.cleannewLevel);return(t.match(this.cleanlineBefore)||s)&&(e=e.replace(/\\s*$/,\"\"),e+=\"\\n\"),s&&\"/\"==t.charAt(1)&&this.cleanlevel--,\"\\n\"==e.charAt(e.length-1)&&(e+=this.cleanGetTabs()),s&&\"/\"!=t.charAt(1)&&this.cleanlevel++,e+=t,(t.match(this.cleanlineAfter)||t.match(this.cleannewLevel))&&(e=e.replace(/ *$/,\"\"),e+=\"\\n\"),e},formatEmpty:function(t){var e=$.trim(this.$editor.html());if(this.opts.linebreaks)\"\"==e&&(t.preventDefault(),this.$editor.html(\"\"),this.focus());else{var s=(e=e.replace(/<br\\s?\\/?>/i,\"\")).replace(/<p>\\s?<\\/p>/gi,\"\");if(\"\"===e||\"\"===s){t.preventDefault();var o=$(this.opts.emptyHtml).get(0);this.$editor.html(o),this.focus()}}this.sync()},formatBlocks:function(t){this.browser(\"mozilla\")&&this.isFocused()&&this.$editor.focus(),this.bufferSet();var e=this.getBlocks();this.selectionSave(),$.each(e,$.proxy(function(e,s){if(\"LI\"!==s.tagName){var o=$(s).parent();if(\"p\"===t){if(\"P\"===s.tagName&&0!=o.length&&\"BLOCKQUOTE\"===o[0].tagName||\"BLOCKQUOTE\"===s.tagName){this.formatQuote();return}if(this.opts.linebreaks){if(!s||0!=s.tagName.search(/H[1-6]/))return;$(s).replaceWith(s.innerHTML+\"<br>\")}else this.formatBlock(t,s)}else this.formatBlock(t,s)}},this)),this.selectionRestore(),this.sync()},formatBlock:function(t,e){if(!1===e&&(e=this.getBlock()),!1===e&&!0===this.opts.linebreaks)return this.execCommand(\"formatblock\",t),!0;var s=\"\";if(\"code\"!==t?s=$(e).contents():(s=$(e).html(),\"\"===$.trim(s)&&(s='<span id=\"selection-marker-1\"></span>')),\"CODE\"===e.tagName&&(t=\"p\"),!0===this.opts.linebreaks&&\"p\"===t)$(e).replaceWith($(\"<div>\").append(s).html()+\"<br>\");else{var o=this.getParent(),r=$(\"<\"+t+\">\").append(s);$(e).replaceWith(r),o&&\"TD\"==o.tagName&&$(r).wrapAll(\"<td>\")}},formatChangeTag:function(t,e,s){!1!==s&&this.selectionSave();var o=$(\"<\"+e+\"/>\");return $(t).replaceWith(function(){return o.append($(this).contents())}),!1!==s&&this.selectionRestore(),o},formatQuote:function(){if(this.browser(\"mozilla\")&&this.isFocused()&&this.$editor.focus(),this.bufferSet(),!1===this.opts.linebreaks){this.selectionSave();var t=this.getBlocks(),e=!1,s=t.length;if(t){var o=\"\",r=\"\",a=!1,n=!0;if($.each(t,function(t,e){\"P\"!==e.tagName&&(n=!1)}),$.each(t,$.proxy(function(l,c){if(\"BLOCKQUOTE\"===c.tagName)this.formatBlock(\"p\",c,!1);else if(\"P\"===c.tagName){if(\"BLOCKQUOTE\"==(e=$(c).parent())[0].tagName){var h=$(e).children(\"p\").length;1==h?$(e).replaceWith(c):h==s?(a=\"blockquote\",o+=this.outerHtml(c)):(a=\"html\",o+=this.outerHtml(c),0==l?($(c).addClass(\"redactor-replaced\").empty(),r=this.outerHtml(c)):$(c).remove())}else!1===n||1==t.length?this.formatBlock(\"blockquote\",c,!1):(a=\"paragraphs\",o+=this.outerHtml(c))}else\"LI\"!==c.tagName&&this.formatBlock(\"blockquote\",c,!1)},this)),a){if(\"paragraphs\"==a)$(t[0]).replaceWith(\"<blockquote>\"+o+\"</blockquote>\"),$(t).remove();else if(\"blockquote\"==a)$(e).replaceWith(o);else if(\"html\"==a){var l=this.$editor.html().replace(r,\"</blockquote>\"+o+\"<blockquote>\");this.$editor.html(l),this.$editor.find(\"blockquote\").each(function(){\"\"==$.trim($(this).html())&&$(this).remove()})}}}this.selectionRestore()}else{var c=this.getBlock();if(\"BLOCKQUOTE\"===c.tagName){this.selectionSave();var l=$.trim($(c).html()),h=$.trim(this.getSelectionHtml());if((l=l.replace(/<span(.*?)id=\"selection-marker(.*?)<\\/span>/gi,\"\"))==h)$(c).replaceWith($(c).html()+\"<br>\");else{this.inlineFormat(\"tmp\");var d=this.$editor.find(\"tmp\");d.empty();var p=this.$editor.html().replace(\"<tmp></tmp>\",'</blockquote><span id=\"selection-marker-1\">'+this.opts.invisibleSpace+\"</span>\"+h+\"<blockquote>\");this.$editor.html(p),d.remove(),this.$editor.find(\"blockquote\").each(function(){\"\"==$.trim($(this).html())&&$(this).remove()})}this.selectionRestore(),this.$editor.find(\"span#selection-marker-1\").attr(\"id\",!1)}else{var u=this.selectionWrap(\"blockquote\"),l=$(u).html(),f=[\"ul\",\"ol\",\"table\",\"tr\",\"tbody\",\"thead\",\"tfoot\",\"dl\"];$.each(f,function(t,e){l=(l=l.replace(RegExp(\"<\"+e+\"(.*?)>\",\"gi\"),\"\")).replace(RegExp(\"</\"+e+\">\",\"gi\"),\"\")});var m=this.opts.blockLevelElements;$.each(m,function(t,e){l=(l=l.replace(RegExp(\"<\"+e+\"(.*?)>\",\"gi\"),\"\")).replace(RegExp(\"</\"+e+\">\",\"gi\"),\"<br>\")}),$(u).html(l),this.selectionElement(u);var g=$(u).next();0!=g.length&&\"BR\"===g[0].tagName&&g.remove()}}this.sync()},blockRemoveAttr:function(t,e){$(this.getBlocks()).removeAttr(t),this.sync()},blockSetAttr:function(t,e){$(this.getBlocks()).attr(t,e),this.sync()},blockRemoveStyle:function(t){var e=this.getBlocks();$(e).css(t,\"\"),this.removeEmptyAttr(e,\"style\"),this.sync()},blockSetStyle:function(t,e){$(this.getBlocks()).css(t,e),this.sync()},blockRemoveClass:function(t){var e=this.getBlocks();$(e).removeClass(t),this.removeEmptyAttr(e,\"class\"),this.sync()},blockSetClass:function(t){$(this.getBlocks()).addClass(t),this.sync()},inlineRemoveClass:function(t){this.selectionSave(),this.inlineEachNodes(function(e){$(e).removeClass(t),this.removeEmptyAttr(e,\"class\")}),this.selectionRestore(),this.sync()},inlineSetClass:function(t){$(this.getCurrent()).hasClass(t)||this.inlineMethods(\"addClass\",t)},inlineRemoveStyle:function(t){this.selectionSave(),this.inlineEachNodes(function(e){$(e).css(t,\"\"),this.removeEmptyAttr(e,\"style\")}),this.selectionRestore(),this.sync()},inlineSetStyle:function(t,e){this.inlineMethods(\"css\",t,e)},inlineRemoveAttr:function(t){this.selectionSave();var e=this.getRange(),s=this.getElement(),o=this.getNodes();(e.collapsed||e.startContainer===e.endContainer&&s)&&(o=$(s)),$(o).removeAttr(t),this.inlineUnwrapSpan(),this.selectionRestore(),this.sync()},inlineSetAttr:function(t,e){this.inlineMethods(\"attr\",t,e)},inlineMethods:function(t,e,s){this.bufferSet(),this.selectionSave();var o=this.getRange(),r=this.getElement();if((o.collapsed||o.startContainer===o.endContainer)&&r&&!this.nodeTestBlocks(r))$(r)[t](e,s);else{var a,n=s;switch(e){case\"font-size\":a=\"fontSize\",n=4;break;case\"font-family\":a=\"fontName\";break;case\"color\":a=\"foreColor\";break;case\"background-color\":a=\"backColor\"}this.document.execCommand(a,!1,n);var l=this.$editor.find(\"font\");$.each(l,$.proxy(function(o,r){this.inlineSetMethods(t,r,e,s)},this))}this.selectionRestore(),this.sync()},inlineSetMethods:function(t,e,s,o){var r,a=$(e).parent(),n=this.getSelectionText(),l=$(a).text();return n==l&&a&&\"INLINE\"===a[0].tagName&&0!=a[0].attributes.length?(r=a,$(e).replaceWith($(e).html())):(r=$(\"<inline>\").append($(e).contents()),$(e).replaceWith(r)),$(r)[t](s,o),r},inlineEachNodes:function(t){var e,s=this.getRange(),o=this.getElement(),r=this.getNodes();(s.collapsed||s.startContainer===s.endContainer&&o)&&(r=$(o),e=!0),$.each(r,$.proxy(function(s,o){if(!e&&\"INLINE\"!==o.tagName){var r=this.getSelectionText(),a=$(o).parent().text();if(r!=a||\"INLINE\"!==o.parentNode.tagName||$(o.parentNode).hasClass(\"redactor_editor\"))return;o=o.parentNode}t.call(this,o)},this))},inlineUnwrapSpan:function(){var t=this.$editor.find(\"inline\");$.each(t,$.proxy(function(t,e){var s=$(e);void 0===s.attr(\"class\")&&void 0===s.attr(\"style\")&&s.contents().unwrap()},this))},inlineFormat:function(t){this.selectionSave(),this.document.execCommand(\"fontSize\",!1,4);var e,s=this.$editor.find(\"font\");$.each(s,function(s,o){var r=$(\"<\"+t+\"/>\").append($(o).contents());$(o).replaceWith(r),e=r}),this.selectionRestore(),this.sync()},inlineRemoveFormat:function(t){this.selectionSave();var e=t.toUpperCase(),s=this.getNodes(),o=$(this.getParent()).parent();$.each(s,function(t,s){s.tagName===e&&this.inlineRemoveFormatReplace(s)}),o&&o[0].tagName===e&&this.inlineRemoveFormatReplace(o),this.selectionRestore(),this.sync()},inlineRemoveFormatReplace:function(t){$(t).replaceWith($(t).contents())},insertHtml:function(t,e){var s=this.getCurrent(),o=s.parentNode;this.focusWithSaveScroll(),this.bufferSet();var r=$(\"<div>\").append($.parseHTML(t));t=r.html(),t=this.cleanRemoveEmptyTags(t),r=$(\"<div>\").append($.parseHTML(t));var a=this.getBlock();if(1==r.contents().length){var n=r.contents()[0].tagName;(\"P\"!=n&&n==a.tagName||\"CODE\"==n)&&(r=$(\"<div>\").append(t))}this.opts.linebreaks&&(t=t.replace(/<p(.*?)>([\\w\\W]*?)<\\/p>/gi,\"$2<br>\")),this.opts.linebreaks||1!=r.contents().length||3!=r.contents()[0].nodeType||!(this.getRangeSelectedNodes().length>2)&&s&&(\"BODY\"!=s.tagName||o)&&\"HTML\"!=o.tagName||(t=\"<p>\"+t+\"</p>\"),t=this.setSpansVerifiedHtml(t),r.contents().length>1&&a||r.contents().is(\"p, :header, ul, ol, li, div, table, td, blockquote, code, address, section, header, footer, aside, article\")?this.browser(\"msie\")?this.isIe11()?this.execPasteFrag(t):this.document.selection.createRange().pasteHTML(t):this.document.execCommand(\"inserthtml\",!1,t):this.insertHtmlAdvanced(t,!1),this.selectall&&this.window.setTimeout($.proxy(function(){this.opts.linebreaks?this.focusEnd():this.selectionEnd(this.$editor.contents().last())},this),1),this.observeStart(),this.setNonEditable(),!1!==e&&this.sync()},insertHtmlAdvanced:function(t,e){t=this.setSpansVerifiedHtml(t);var s=this.getSelection();if(s.getRangeAt&&s.rangeCount){var o=s.getRangeAt(0);o.deleteContents();var r=document.createElement(\"div\");r.innerHTML=t;for(var a,n,l=document.createDocumentFragment();a=r.firstChild;)n=l.appendChild(a);o.insertNode(l),n&&((o=o.cloneRange()).setStartAfter(n),o.collapse(!0),s.removeAllRanges(),s.addRange(o))}!1!==e&&this.sync()},insertBeforeCursor:function(t){t=this.setSpansVerifiedHtml(t);var e=$(t),s=document.createElement(\"span\");s.innerHTML=\"\u200b\";var o=this.getRange();o.insertNode(s),o.insertNode(e[0]),o.collapse(!1);var r=this.getSelection();r.removeAllRanges(),r.addRange(o),this.sync()},insertText:function(t){var e=$($.parseHTML(t));e.length&&(t=e.text()),this.focusWithSaveScroll(),this.browser(\"msie\")?this.isIe11()?this.execPasteFrag(t):this.document.selection.createRange().pasteHTML(t):this.document.execCommand(\"inserthtml\",!1,t),this.sync()},insertNode:function(t){if(\"SPAN\"==(t=t[0]||t).tagName){var e=\"inline\",s=t.outerHTML,o=RegExp(\"<\"+t.tagName,\"i\"),r=s.replace(o,\"<\"+e);o=RegExp(\"</\"+t.tagName,\"i\"),r=r.replace(o,\"</\"+e),t=$(r)[0]}var a=this.getSelection();return a.getRangeAt&&a.rangeCount&&((range=a.getRangeAt(0)).deleteContents(),range.insertNode(t),range.setEndAfter(t),range.setStartAfter(t),a.removeAllRanges(),a.addRange(range)),t},insertNodeToCaretPositionFromPoint:function(t,e){var s,o=t.clientX,r=t.clientY;if(this.document.caretPositionFromPoint){var a=this.document.caretPositionFromPoint(o,r);(s=this.getRange()).setStart(a.offsetNode,a.offset),s.collapse(!0),s.insertNode(e)}else if(this.document.caretRangeFromPoint)(s=this.document.caretRangeFromPoint(o,r)).insertNode(e);else if(void 0!==document.body.createTextRange){(s=this.document.body.createTextRange()).moveToPoint(o,r);var n=s.duplicate();n.moveToPoint(o,r),s.setEndPoint(\"EndToEnd\",n),s.select()}},insertAfterLastElement:function(t,e){if(void 0!==e&&(t=e),this.isEndOfElement()){if(this.opts.linebreaks){var s=$(\"<div>\").append($.trim(this.$editor.html())).contents(),o=s.last()[0];if(\"SPAN\"==o.tagName&&\"\"==o.innerHTML&&(o=s.prev()[0]),this.outerHtml(o)!=this.outerHtml(t))return!1}else if(this.$editor.contents().last()[0]!==t)return!1;this.insertingAfterLastElement(t)}},insertingAfterLastElement:function(t){if(this.bufferSet(),!1===this.opts.linebreaks){var e=$(this.opts.emptyHtml);$(t).after(e),this.selectionStart(e)}else{var e=$('<span id=\"selection-marker-1\">'+this.opts.invisibleSpace+\"</span>\",this.document)[0];$(t).after(e),$(e).after(this.opts.invisibleSpace),this.selectionRestore(),this.$editor.find(\"span#selection-marker-1\").removeAttr(\"id\")}},insertLineBreak:function(t){this.selectionSave();var e=\"<br>\";if(!0==t&&(e=\"<br><br>\"),this.browser(\"mozilla\")){var s=$(\"<span>\").html(this.opts.invisibleSpace);this.$editor.find(\"#selection-marker-1\").before(e).before(s).before(this.opts.invisibleSpace),this.setCaretAfter(s[0]),s.remove(),this.selectionRemoveMarkers()}else{var o=this.getParent();if(o&&\"A\"===o.tagName){var r=this.getCaretOffset(o),a=$.trim($(o).text()).replace(/\\n\\r\\n/g,\"\").length;if(r==a){this.selectionRemoveMarkers();var n=$('<span id=\"selection-marker-1\">'+this.opts.invisibleSpace+\"</span>\",this.document)[0];return $(o).after(n),$(n).before(e+(this.browser(\"webkit\")?this.opts.invisibleSpace:\"\")),this.selectionRestore(),!0}}this.$editor.find(\"#selection-marker-1\").before(e+(this.browser(\"webkit\")?this.opts.invisibleSpace:\"\")),this.selectionRestore()}},insertDoubleLineBreak:function(){this.insertLineBreak(!0)},replaceLineBreak:function(t){var e=$(\"<br>\"+this.opts.invisibleSpace);$(t).replaceWith(e),this.selectionStart(e)},pasteClean:function(t){if(t=this.callback(\"pasteBefore\",!1,t),this.browser(\"msie\")){var e=$.trim(t);0==e.search(/^<a(.*?)>(.*?)<\\/a>$/i)&&(t=t.replace(/^<a(.*?)>(.*?)<\\/a>$/i,\"$2\"))}if(t=t.replace(/on([a-z]+)=|javascript\\:/gi,\"\"),this.opts.pastePlainText){var e=this.document.createElement(\"div\");return t=t.replace(/<br>|<\\/H[1-6]>|<\\/p>|<\\/div>/gi,\"\\n\"),e.innerHTML=t,t=e.textContent||e.innerText,t=(t=$.trim(t)).replace(\"\\n\",\"<br>\"),t=this.cleanParagraphy(t),this.pasteInsert(t),!1}var s=!1;if(this.currentOrParentIs(\"TD\")){s=!0;var o=this.opts.blockLevelElements;o.push(\"tr\"),o.push(\"table\"),$.each(o,function(e,s){t=(t=t.replace(RegExp(\"<\"+s+\"(.*?)>\",\"gi\"),\"\")).replace(RegExp(\"</\"+s+\">\",\"gi\"),\"<br>\")})}if(this.currentOrParentIs(\"CODE\"))return t=this.pastePre(t),this.pasteInsert(t),!0;if(t=(t=(t=(t=(t=(t=(t=t.replace(/<img(.*?)v:shapes=(.*?)>/gi,\"\")).replace(/<p(.*?)class=\"MsoListParagraphCxSpFirst\"([\\w\\W]*?)<\\/p>/gi,\"<ul><li$2</li>\")).replace(/<p(.*?)class=\"MsoListParagraphCxSpMiddle\"([\\w\\W]*?)<\\/p>/gi,\"<li$2</li>\")).replace(/<p(.*?)class=\"MsoListParagraphCxSpLast\"([\\w\\W]*?)<\\/p>/gi,\"<li$2</li></ul>\")).replace(/<p(.*?)class=\"MsoListParagraph\"([\\w\\W]*?)<\\/p>/gi,\"<ul><li$2</li></ul>\")).replace(/\u00b7/g,\"\")).replace(/<!--[\\s\\S]*?-->|<\\?(?:php)?[\\s\\S]*?\\?>/gi,\"\"),!0===this.opts.cleanSpaces&&(t=(t=t.replace(/(&nbsp;){2,}/gi,\"&nbsp;\")).replace(/&nbsp;/gi,\" \")),t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=t.replace(/<b\\sid=\"internal-source-marker(.*?)\">([\\w\\W]*?)<\\/b>/gi,\"$2\")).replace(/<b(.*?)id=\"docs-internal-guid(.*?)\">([\\w\\W]*?)<\\/b>/gi,\"$3\")).replace(/<span[^>]*(font-style: italic; font-weight: bold|font-weight: bold; font-style: italic)[^>]*>/gi,'<span style=\"font-weight: bold;\"><span style=\"font-style: italic;\">')).replace(/<span[^>]*font-style: italic[^>]*>/gi,'<span style=\"font-style: italic;\">')).replace(/<span[^>]*font-weight: bold[^>]*>/gi,'<span style=\"font-weight: bold;\">')).replace(/<span[^>]*text-decoration: underline[^>]*>/gi,'<span style=\"text-decoration: underline;\">')).replace(/<td>\\u200b*<\\/td>/gi,\"[td]\")).replace(/<td>&nbsp;<\\/td>/gi,\"[td]\")).replace(/<td><br><\\/td>/gi,\"[td]\")).replace(/<td(.*?)colspan=\"(.*?)\"(.*?)>([\\w\\W]*?)<\\/td>/gi,'[td colspan=\"$2\"]$4[/td]')).replace(/<td(.*?)rowspan=\"(.*?)\"(.*?)>([\\w\\W]*?)<\\/td>/gi,'[td rowspan=\"$2\"]$4[/td]')).replace(/<a(.*?)href=\"(.*?)\"(.*?)>([\\w\\W]*?)<\\/a>/gi,'[a href=\"$2\"]$4[/a]')).replace(/<iframe(.*?)>([\\w\\W]*?)<\\/iframe>/gi,\"[iframe$1]$2[/iframe]\")).replace(/<video(.*?)>([\\w\\W]*?)<\\/video>/gi,\"[video$1]$2[/video]\")).replace(/<audio(.*?)>([\\w\\W]*?)<\\/audio>/gi,\"[audio$1]$2[/audio]\")).replace(/<embed(.*?)>([\\w\\W]*?)<\\/embed>/gi,\"[embed$1]$2[/embed]\")).replace(/<object(.*?)>([\\w\\W]*?)<\\/object>/gi,\"[object$1]$2[/object]\")).replace(/<param(.*?)>/gi,\"[param$1]\")).replace(/<img(.*?)>/gi,\"[img$1]\")).replace(/ class=\"(.*?)\"/gi,\"\")).replace(/<(\\w+)([\\w\\W]*?)>/gi,\"<$1>\"),this.opts.linebreaks?(t=(t=t.replace(/<strong><\\/strong>/gi,\"\")).replace(/<u><\\/u>/gi,\"\"),this.opts.cleanFontTag&&(t=t.replace(/<font(.*?)>([\\w\\W]*?)<\\/font>/gi,\"$2\")),t=t.replace(/<[^\\/>][^>]*>(\\s*|\\t*|\\n*|&nbsp;|<br>)<\\/[^>]+>/gi,\"<br>\")):t=t.replace(/<[^\\/>][^>]*>(\\s*|\\t*|\\n*|&nbsp;|<br>)<\\/[^>]+>/gi,\"\"),t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=t.replace(/<div>\\s*?\\t*?\\n*?(<ul>|<ol>|<p>)/gi,\"$1\")).replace(/\\[td colspan=\"(.*?)\"\\]([\\w\\W]*?)\\[\\/td\\]/gi,'<td colspan=\"$1\">$2</td>')).replace(/\\[td rowspan=\"(.*?)\"\\]([\\w\\W]*?)\\[\\/td\\]/gi,'<td rowspan=\"$1\">$2</td>')).replace(/\\[td\\]/gi,\"<td>&nbsp;</td>\")).replace(/\\[a href=\"(.*?)\"\\]([\\w\\W]*?)\\[\\/a\\]/gi,'<a href=\"$1\">$2</a>')).replace(/\\[iframe(.*?)\\]([\\w\\W]*?)\\[\\/iframe\\]/gi,\"<iframe$1>$2</iframe>\")).replace(/\\[video(.*?)\\]([\\w\\W]*?)\\[\\/video\\]/gi,\"<video$1>$2</video>\")).replace(/\\[audio(.*?)\\]([\\w\\W]*?)\\[\\/audio\\]/gi,\"<audio$1>$2</audio>\")).replace(/\\[embed(.*?)\\]([\\w\\W]*?)\\[\\/embed\\]/gi,\"<embed$1>$2</embed>\")).replace(/\\[object(.*?)\\]([\\w\\W]*?)\\[\\/object\\]/gi,\"<object$1>$2</object>\")).replace(/\\[param(.*?)\\]/gi,\"<param$1>\")).replace(/\\[img(.*?)\\]/gi,\"<img$1>\"),t=this.opts.convertDivs?(t=(t=(t=t.replace(/<div(.*?)>([\\w\\W]*?)<\\/div>/gi,\"<p>$2</p>\")).replace(/<\\/div><p>/gi,\"<p>\")).replace(/<\\/p><\\/div>/gi,\"</p>\")).replace(/<p><\\/p>/gi,\"<br />\"):t.replace(/<div><\\/div>/gi,\"<br />\"),t=this.cleanStripTags(t),this.currentOrParentIs(\"LI\")?t=t.replace(/<p>([\\w\\W]*?)<\\/p>/gi,\"$1<br>\"):!1===s&&(t=this.cleanParagraphy(t)),t=(t=(t=(t=(t=(t=(t=(t=t.replace(/<span(.*?)>([\\w\\W]*?)<\\/span>/gi,\"$2\")).replace(/<img>/gi,\"\")).replace(/<[^\\/>][^>][^img|param|source|td][^<]*>(\\s*|\\t*|\\n*| |<br>)<\\/[^>]+>/gi,\"\")).replace(/\\n{3,}/gi,\"\\n\")).replace(/<p><p>/gi,\"<p>\")).replace(/<\\/p><\\/p>/gi,\"</p>\")).replace(/<li>(\\s*|\\t*|\\n*)<p>/gi,\"<li>\")).replace(/<\\/p>(\\s*|\\t*|\\n*)<\\/li>/gi,\"</li>\"),!0===this.opts.linebreaks&&(t=t.replace(/<p(.*?)>([\\w\\W]*?)<\\/p>/gi,\"$2<br>\")),t=(t=(t=t.replace(/<[^\\/>][^>][^img|param|source|td][^<]*>(\\s*|\\t*|\\n*| |<br>)<\\/[^>]+>/gi,\"\")).replace(/<img src=\"webkit-fake-url\\:\\/\\/(.*?)\"(.*?)>/gi,\"\")).replace(/<td(.*?)>(\\s*|\\t*|\\n*)<p>([\\w\\W]*?)<\\/p>(\\s*|\\t*|\\n*)<\\/td>/gi,\"<td$1>$3</td>\"),this.opts.convertDivs&&(t=(t=t.replace(/<div(.*?)>([\\w\\W]*?)<\\/div>/gi,\"$2\")).replace(/<div(.*?)>([\\w\\W]*?)<\\/div>/gi,\"$2\")),this.pasteClipboardMozilla=!1,this.browser(\"mozilla\")){if(this.opts.clipboardUpload){var r=t.match(/<img src=\"data:image(.*?)\"(.*?)>/gi);if(null!==r)for(var a in this.pasteClipboardMozilla=r,r){var n=r[a].replace(\"<img\",'<img data-mozilla-paste-image=\"'+a+'\" ');t=t.replace(r[a],n)}}for(;/<br>$/gi.test(t);)t=t.replace(/<br>$/gi,\"\")}if(t=t.replace(/<p>\u2022([\\w\\W]*?)<\\/p>/gi,\"<li>$1</li>\"),this.browser(\"msie\"))for(;/<font>([\\w\\W]*?)<\\/font>/gi.test(t);)t=t.replace(/<font>([\\w\\W]*?)<\\/font>/gi,\"$1\");!1===s&&(t=(t=(t=(t=t.replace(/<td(.*?)>([\\w\\W]*?)<p(.*?)>([\\w\\W]*?)<\\/td>/gi,\"<td$1>$2$4</td>\")).replace(/<td(.*?)>([\\w\\W]*?)<\\/p>([\\w\\W]*?)<\\/td>/gi,\"<td$1>$2$3</td>\")).replace(/<td(.*?)>([\\w\\W]*?)<p(.*?)>([\\w\\W]*?)<\\/td>/gi,\"<td$1>$2$4</td>\")).replace(/<td(.*?)>([\\w\\W]*?)<\\/p>([\\w\\W]*?)<\\/td>/gi,\"<td$1>$2$3</td>\")),t=(t=t.replace(/\\n/g,\" \")).replace(/<p>\\n?<li>/gi,\"<li>\"),this.pasteInsert(t)},pastePre:function(t){t=t.replace(/<br>|<\\/H[1-6]>|<\\/p>|<\\/div>/gi,\"\\n\");var e=this.document.createElement(\"div\");return e.innerHTML=t,this.cleanEncodeEntities(e.textContent||e.innerText)},pasteInsert:function(t){t=this.callback(\"pasteAfter\",!1,t),this.selectall?(this.$editor.html(t),this.selectionRemove(),this.focusEnd(),this.sync()):this.insertHtml(t),this.selectall=!1,setTimeout($.proxy(function(){this.rtePaste=!1,this.browser(\"mozilla\")&&this.$editor.find(\"p:empty\").remove(),!1!==this.pasteClipboardMozilla&&this.pasteClipboardUploadMozilla()},this),100),this.opts.autoresize&&!0!==this.fullscreen?$(this.document.body).scrollTop(this.saveScroll):this.$editor.scrollTop(this.saveScroll)},pasteClipboardAppendFields:function(t){return!1!==this.opts.uploadFields&&\"object\"==typeof this.opts.uploadFields&&$.each(this.opts.uploadFields,$.proxy(function(e,s){null!=s&&0===s.toString().indexOf(\"#\")&&(s=$(s).val()),t[e]=s},this)),t},pasteClipboardUploadMozilla:function(){var t=this.$editor.find(\"img[data-mozilla-paste-image]\");$.each(t,$.proxy(function(t,e){var s=$(e),o=e.src.split(\",\"),r={contentType:o[0].split(\";\")[0].split(\":\")[1],data:o[1]};r=this.pasteClipboardAppendFields(r),$.post(this.opts.clipboardUploadUrl,r,$.proxy(function(t){var e=\"string\"==typeof t?$.parseJSON(t):t;s.attr(\"src\",e.image.url),s.removeAttr(\"data-mozilla-paste-image\"),this.sync(),this.callback(\"imageUpload\",s,e)},this))},this))},pasteClipboardUpload:function(t){var e=t.target.result,s=e.split(\",\"),o={contentType:s[0].split(\";\")[0].split(\":\")[1],data:s[1]};this.opts.clipboardUpload?(o=this.pasteClipboardAppendFields(o),$.post(this.opts.clipboardUploadUrl,o,$.proxy(function(t){var e=\"string\"==typeof t?$.parseJSON(t):t,s='<img src=\"'+e.image.url+'\" id=\"clipboard-image-marker\" />';this.execCommand(\"inserthtml\",s,!1);var o=$(this.$editor.find(\"img#clipboard-image-marker\"));o.length?o.removeAttr(\"id\"):o=!1,this.sync(),o&&this.callback(\"imageUpload\",o,e)},this))):this.insertHtml('<img src=\"'+e+'\" />')},bufferSet:function(t){!1!==t&&this.selectionSave(),this.opts.buffer.push(this.$editor.html()),!1!==t&&this.selectionRemoveMarkers(\"buffer\")},bufferUndo:function(){if(0===this.opts.buffer.length){this.focusWithSaveScroll();return}this.selectionSave(),this.opts.rebuffer.push(this.$editor.html()),this.selectionRestore(!1,!0),this.$editor.html(this.opts.buffer.pop()),this.selectionRestore(),setTimeout($.proxy(this.observeStart,this),100)},bufferRedo:function(){if(0===this.opts.rebuffer.length)return this.focusWithSaveScroll(),!1;this.selectionSave(),this.opts.buffer.push(this.$editor.html()),this.selectionRestore(!1,!0),this.$editor.html(this.opts.rebuffer.pop()),this.selectionRestore(!0),setTimeout($.proxy(this.observeStart,this),4)},observeStart:function(){this.observeImages(),this.opts.observeLinks&&this.observeLinks()},observeLinks:function(){this.$editor.find(\"a\").on(\"click\",$.proxy(this.linkObserver,this)),this.$editor.on(\"click.redactor\",$.proxy(function(t){this.linkObserverTooltipClose(t)},this)),$(document).on(\"click.redactor\",$.proxy(function(t){this.linkObserverTooltipClose(t)},this))},observeImages:function(){if(!1===this.opts.observeImages)return!1;this.$editor.find(\"img\").each($.proxy(function(t,e){this.browser(\"msie\")&&$(e).attr(\"unselectable\",\"on\");var s=$(e).parent();s.hasClass(\"royalSlider\")||s.hasClass(\"fotorama\")||this.imageResize(e)},this)),this.$editor.find(\".fotorama, .royalSlider\").on(\"click\",$.proxy(this.editGallery,this))},linkObserver:function(t){var e=$(t.target),s=$(t.target).parent();if(!(s.hasClass(\"royalSlider\")||s.hasClass(\"fotorama\"))&&0!=e.length&&\"A\"===e[0].tagName){var o=e.offset();if(this.opts.iframe){var r=this.$frame.offset();o.top=r.top+(o.top-$(this.document).scrollTop()),o.left+=r.left}var a=$('<span class=\"redactor-link-tooltip\"></span>'),n=e.attr(\"href\");void 0===n&&(n=\"\"),n.length>24&&(n=n.substring(0,24)+\"...\");var l=$('<a href=\"'+e.attr(\"href\")+'\" target=\"_blank\">'+n+\"</a>\").on(\"click\",$.proxy(function(t){this.linkObserverTooltipClose(!1)},this)),c=$('<a href=\"#\">'+this.opts.curLang.edit+\"</a>\").on(\"click\",$.proxy(function(t){t.preventDefault(),this.linkShow(),this.linkObserverTooltipClose(!1)},this)),h=$('<a href=\"#\">'+this.opts.curLang.unlink+\"</a>\").on(\"click\",$.proxy(function(t){t.preventDefault(),this.execCommand(\"unlink\"),this.linkObserverTooltipClose(!1)},this));a.append(l),a.append(\" | \"),a.append(c),a.append(\" | \"),a.append(h),a.css({top:o.top+20+\"px\",left:o.left+\"px\"}),$(\".redactor-link-tooltip\").remove(),$(\"body\").append(a)}},linkObserverTooltipClose:function(t){if(!1!==t&&\"A\"==t.target.tagName)return!1;$(\".redactor-link-tooltip\").remove()},getSelection:function(){return this.opts.rangy?this.opts.iframe?rangy.getSelection(this.$frame[0]):rangy.getSelection():this.document.getSelection()},getRange:function(){if(this.opts.rangy)return this.opts.iframe?rangy.createRange(this.iframeDoc()):rangy.createRange();if(this.document.getSelection){var t=this.getSelection();if(t.getRangeAt&&t.rangeCount)return t.getRangeAt(0)}return this.document.createRange()},selectionElement:function(t){this.setCaret(t)},selectionStart:function(t){this.selectionSet(t[0]||t,0,null,0)},selectionEnd:function(t){this.selectionSet(t[0]||t,1,null,1)},selectionSet:function(t,e,s,o){null==s&&(s=t),null==o&&(o=e);var r=this.getSelection();if(r){if(\"P\"==t.tagName&&\"\"==t.innerHTML&&(t.innerHTML=this.opts.invisibleSpace),\"BR\"==t.tagName&&!1===this.opts.linebreaks){var a=$(this.opts.emptyHtml)[0];$(t).replaceWith(a),s=t=a}var n=this.getRange();n.setStart(t,e),n.setEnd(s,o);try{r.removeAllRanges()}catch(l){}r.addRange(n)}},selectionWrap:function(t){t=t.toLowerCase();var e=this.getBlock();if(e){var s=this.formatChangeTag(e,t);return this.sync(),s}var o=this.getSelection().getRangeAt(0),s=document.createElement(t);return s.appendChild(o.extractContents()),o.insertNode(s),this.selectionElement(s),s},selectionAll:function(){var t=this.getRange();t.selectNodeContents(this.$editor[0]);var e=this.getSelection();e.removeAllRanges(),e.addRange(t)},selectionRemove:function(){this.getSelection().removeAllRanges()},getCaretOffset:function(t){var e=0,s=this.getRange(),o=s.cloneRange();return o.selectNodeContents(t),o.setEnd(s.endContainer,s.endOffset),e=$.trim(o.toString()).length},getCaretOffsetRange:function(){return new Range(this.getSelection().getRangeAt(0))},setCaret:function(t,e,s){void 0===s&&(s=e),t=t[0]||t;var o=this.getRange();o.selectNodeContents(t);var r,a=this.getTextNodesIn(t),n=!1,l=0;if(1==a.length&&e)o.setStart(a[0],e),o.setEnd(a[0],s);else for(var c,h=0;c=a[h++];){if(r=l+c.length,!n&&e>=l&&(e<r||e==r&&h<a.length)&&(o.setStart(c,e-l),n=!0),n&&s<=r){o.setEnd(c,s-l);break}l=r}var d=this.getSelection();d.removeAllRanges(),d.addRange(o)},setCaretAfter:function(t){this.$editor.focus(),t=t[0]||t;var e=this.document.createRange(),s=1,o=-1;e.setStart(t,s),e.setEnd(t,o+2);var r=this.window.getSelection(),a=this.document.createRange(),n=this.document.createTextNode(\"\u200b\");$(t).after(n),a.setStartAfter(n),r.removeAllRanges(),r.addRange(a),$(n).remove()},getTextNodesIn:function(t){var e=[];if(3==t.nodeType)e.push(t);else for(var s=t.childNodes,o=0,r=s.length;o<r;++o)e.push.apply(e,this.getTextNodesIn(s[o]));return e},getCurrent:function(){var t=!1,e=this.getSelection();return e&&e.rangeCount>0&&(t=e.getRangeAt(0).startContainer),this.isParentRedactor(t)},getParent:function(t){return!!(t=t||this.getCurrent())&&this.isParentRedactor($(t).parent()[0])},getBlock:function(t){for(void 0===t&&(t=this.getCurrent());t;){if(this.nodeTestBlocks(t)){if($(t).hasClass(\"redactor_editor\"))return!1;return t}t=t.parentNode}return!1},getBlocks:function(t){var e=[];if(void 0===t){var s=this.getRange();if(s&&!0===s.collapsed)return[this.getBlock()];var t=this.getNodes(s)}return $.each(t,$.proxy(function(t,s){if(!1===this.opts.iframe&&0==$(s).parents(\"div.redactor_editor\").length)return!1;this.nodeTestBlocks(s)&&e.push(s)},this)),0===e.length&&(e=[this.getBlock()]),e},isInlineNode:function(t){return 1==t.nodeType&&!this.rTestBlock.test(t.nodeName)},nodeTestBlocks:function(t){return 1==t.nodeType&&this.rTestBlock.test(t.nodeName)},tagTestBlock:function(t){return this.rTestBlock.test(t)},getNodes:function(t,e){if(void 0===t||!1==t)var t=this.getRange();if(t&&!0===t.collapsed){if(!(void 0===e&&this.tagTestBlock(e)))return[this.getCurrent()];var s=this.getBlock();return s.tagName==e?[s]:[]}var o=[],r=[],a=this.document.getSelection();if(a.isCollapsed||(o=this.getRangeSelectedNodes(a.getRangeAt(0))),$.each(o,$.proxy(function(t,s){if(!1===this.opts.iframe&&0==$(s).parents(\"div.redactor_editor\").length)return!1;void 0===e?\"\"!=$.trim(s.textContent)&&r.push(s):s.tagName==e&&r.push(s)},this)),0==r.length){if(void 0===e&&this.tagTestBlock(e)){var s=this.getBlock();return s.tagName==e?r.push(s):[]}r.push(this.getCurrent())}var n=r[r.length-1];return this.nodeTestBlocks(n)&&(r=r.slice(0,-1)),r},getElement:function(t){for(t||(t=this.getCurrent());t;){if(1==t.nodeType){if($(t).hasClass(\"redactor_editor\"))return!1;return t}t=t.parentNode}return!1},getRangeSelectedNodes:function(t){var e=(t=t||this.getRange()).startContainer,s=t.endContainer;if(e==s)return[e];for(var o=[];e&&e!=s;)o.push(e=this.nextNode(e));for(e=t.startContainer;e&&e!=t.commonAncestorContainer;)o.unshift(e),e=e.parentNode;return o},nextNode:function(t){if(t.hasChildNodes())return t.firstChild;for(;t&&!t.nextSibling;)t=t.parentNode;return t?t.nextSibling:null},getSelectionText:function(){return this.getSelection().toString()},getSelectionHtml:function(){var t=\"\",e=this.getSelection();if(e.rangeCount){for(var s=this.document.createElement(\"div\"),o=e.rangeCount,r=0;r<o;++r)s.appendChild(e.getRangeAt(r).cloneContents());t=s.innerHTML}return this.syncClean(t)},selectionSave:function(){this.isFocused()||this.focusWithSaveScroll(),this.opts.rangy?this.savedSel=rangy.saveSelection():this.selectionCreateMarker(this.getRange())},selectionCreateMarker:function(t,e){if(t){var s=$('<span id=\"selection-marker-1\" class=\"redactor-selection-marker\">'+this.opts.invisibleSpace+\"</span>\",this.document)[0],o=$('<span id=\"selection-marker-2\" class=\"redactor-selection-marker\">'+this.opts.invisibleSpace+\"</span>\",this.document)[0];!0===t.collapsed?this.selectionSetMarker(t,s,!0):(this.selectionSetMarker(t,s,!0),this.selectionSetMarker(t,o,!1)),this.savedSel=this.$editor.html(),this.selectionRestore(!1,!1)}},selectionSetMarker:function(t,e,s){var o=t.cloneRange();try{o.collapse(s),o.insertNode(e),o.detach()}catch(r){var a=this.opts.emptyHtml;this.opts.linebreaks&&(a=\"<br>\"),this.$editor.prepend(a),this.focus()}},selectionRestore:function(t,e){if(this.opts.rangy)rangy.restoreSelection(this.savedSel);else{!0===t&&this.savedSel&&this.$editor.html(this.savedSel);var s=this.$editor.find(\"span#selection-marker-1\"),o=this.$editor.find(\"span#selection-marker-2\");this.browser(\"mozilla\")?this.$editor.focus():this.isFocused()||this.focusWithSaveScroll(),0!=s.length&&0!=o.length?this.selectionSet(s[0],0,o[0],0):0!=s.length&&this.selectionSet(s[0],0,null,0),!1!==e&&(this.selectionRemoveMarkers(),this.savedSel=!1)}},selectionRemoveMarkers:function(t){this.opts.rangy?rangy.removeMarkers(this.savedSel):$.each(this.$editor.find(\"span.redactor-selection-marker\"),function(){\"\"==$.trim($(this).html().replace(/[^\\u0000-\\u1C7F]/g,\"\"))?$(this).remove():$(this).removeAttr(\"class\").removeAttr(\"id\")})},tableShow:function(){this.selectionSave(),this.modalInit(this.opts.curLang.table,this.opts.modal_table,300,$.proxy(function(){$(\"#redactor_insert_table_btn\").on(\"click\",$.proxy(this.tableInsert,this)),setTimeout(function(){$(\"#redactor_table_rows\").focus()},200)},this))},tableInsert:function(){this.bufferSet(!1);var t,e,s,o,r=$(\"#redactor_table_rows\").val(),a=$(\"#redactor_table_columns\").val(),n=$(\"<div></div>\"),l=Math.floor(99999*Math.random()),c=$('<table id=\"table'+l+'\"><tbody></tbody></table>');for(t=0;t<r;t++){for(s=0,e=$(\"<tr></tr>\");s<a;s++)o=$(\"<td>\"+this.opts.invisibleSpace+\"</td>\"),0===t&&0===s&&o.append('<span id=\"selection-marker-1\">'+this.opts.invisibleSpace+\"</span>\"),$(e).append(o);c.append(e)}n.append(c);var h=n.html();!1===this.opts.linebreaks&&this.browser(\"mozilla\")&&(h+=\"<p>\"+this.opts.invisibleSpace+\"</p>\"),this.modalClose(),this.selectionRestore();var d=this.getBlock()||this.getCurrent();if(d&&\"BODY\"!=d.tagName){if(\"LI\"==d.tagName)var d=$(d).closest(\"ul, ol\");$(d).after(h)}else this.insertHtmlAdvanced(h,!1);this.selectionRestore();var p=this.$editor.find(\"#table\"+l);this.buttonActiveObserver(),p.find(\"span#selection-marker-1, inline#selection-marker-1\").remove(),p.removeAttr(\"id\"),this.sync()},tableDeleteTable:function(){var t=$(this.getParent()).closest(\"table\");if(!this.isParentRedactor(t)||0==t.length)return!1;this.bufferSet(),t.remove(),this.sync()},tableDeleteRow:function(){var t=this.getParent(),e=$(t).closest(\"table\");if(!this.isParentRedactor(e)||0==e.length)return!1;this.bufferSet();var s=$(t).closest(\"tr\"),o=s.prev().length?s.prev():s.next();if(o.length){var r=o.children(\"td\").first();r.length&&r.prepend('<span id=\"selection-marker-1\">'+this.opts.invisibleSpace+\"</span>\")}s.remove(),this.selectionRestore(),e.find(\"span#selection-marker-1\").remove(),this.sync()},tableDeleteColumn:function(){var t=this.getParent(),e=$(t).closest(\"table\");if(!this.isParentRedactor(e)||0==e.length)return!1;this.bufferSet();var s=$(t).closest(\"td\");s.is(\"td\")||(s=s.closest(\"td\"));var o=s.get(0).cellIndex;e.find(\"tr\").each($.proxy(function(t,e){var s=o-1<0?o+1:o-1;0===t&&$(e).find(\"td\").eq(s).prepend('<span id=\"selection-marker-1\">'+this.opts.invisibleSpace+\"</span>\"),$(e).find(\"td\").eq(o).remove()},this)),this.selectionRestore(),e.find(\"span#selection-marker-1\").remove(),this.sync()},tableAddHead:function(){var t=$(this.getParent()).closest(\"table\");if(!this.isParentRedactor(t)||0==t.length)return!1;if(this.bufferSet(),0!==t.find(\"thead\").length)this.tableDeleteHead();else{var e=t.find(\"tr\").first().clone();e.find(\"td\").replaceWith(\"<th></th>\").html(this.opts.invisibleSpace),($thead=$(\"<thead></thead>\")).append(e),t.prepend($thead),this.sync()}},tableDeleteHead:function(){var t=$(this.getParent()).closest(\"table\");if(!this.isParentRedactor(t))return!1;var e=t.find(\"thead\");if(0==e.length)return!1;this.bufferSet(),e.remove(),this.sync()},tableAddRowAbove:function(){this.tableAddRow(\"before\")},tableAddRowBelow:function(){this.tableAddRow(\"after\")},tableAddColumnLeft:function(){this.tableAddColumn(\"before\")},tableAddColumnRight:function(){this.tableAddColumn(\"after\")},tableAddRow:function(t){var e=$(this.getParent()).closest(\"table\");if(!this.isParentRedactor(e)||0==e.length)return!1;this.bufferSet();var s=$(this.getParent()).closest(\"tr\"),o=s.clone();o.find(\"td\").html(this.opts.invisibleSpace),\"after\"===t?s.after(o):s.before(o),this.sync()},tableAddColumn:function(t){var e=$(this.getParent()).closest(\"table\");if(!this.isParentRedactor(e)||0==e.length)return!1;this.bufferSet();var s=0,o=this.getCurrent(),r=$(o).closest(\"tr\"),a=$(o).closest(\"td\");r.find(\"td\").each($.proxy(function(t,e){$(e)[0]===a[0]&&(s=t)},this)),e.find(\"tr\").each($.proxy(function(e,o){var r=$(o).find(\"td\").eq(s),a=r.clone();a.html(this.opts.invisibleSpace),\"after\"===t?r.after(a):r.before(a)},this)),this.sync()},videoShow:function(){this.selectionSave(),this.modalInit(this.opts.curLang.video,this.opts.modal_video,600,$.proxy(function(){$(\"#redactor_insert_video_btn\").on(\"click\",$.proxy(this.videoInsert,this)),setTimeout(function(){$(\"#redactor_insert_video_area\").focus()},200)},this))},videoInsert:function(){var t=$(\"#redactor_insert_video_area\").val();t=this.cleanStripTags(t);var e='<iframe width=\"500\" height=\"281\" src=\"',s='\" frameborder=\"0\" allowfullscreen></iframe>';t.match(reUrlYoutube)?t=t.replace(reUrlYoutube,e+\"//www.youtube.com/embed/$1\"+s):t.match(reUrlVimeo)?t=t.replace(reUrlVimeo,e+\"//player.vimeo.com/video/$2\"+s):t.match(reUrlFacebook)?t=t.replace(reUrlFacebook,e+\"https://www.facebook.com/video/embed?video_id=$1\"+s):t.match(reUrlRutube)&&(t=t.replace(reUrlRutube,e+\"//rutube.ru/play/embed/$1\"+s)),this.selectionRestore();var o=this.getBlock()||this.getCurrent();o?$(o).after(t):this.insertHtmlAdvanced(t,!1),this.sync(),this.modalClose()},linkShow:function(){this.selectionSave();var t=$.proxy(function(){if(!1!==this.opts.predefinedLinks){this.predefinedLinksStorage={};var t=this;$.getJSON(this.opts.predefinedLinks,function(e){if(0!==Object.keys(e).length){var s=$(\"#redactor-predefined-links\");s.html(\"\"),$.each(e,function(e,o){t.predefinedLinksStorage[e]=o,s.append($(\"<option>\").val(e).html(o.name))}),s.on(\"change\",function(){var e=$(this).val(),s=\"\",o=\"\";0!=e&&(s=t.predefinedLinksStorage[e].name,o=t.predefinedLinksStorage[e].url),$(\"#redactor_link_url\").val(o),1!=$(\"#redactor_link_url_text\").data(\"is_selected_text\")&&$(\"#redactor_link_url_text\").val(s)}),s.show()}})}this.insert_link_node=!1;var e=this.getSelection(),s=\"\",o=\"\",r=\"\",a=this.getParent(),n=$(a).parent().get(0);n&&\"A\"===n.tagName&&(a=n),a&&\"A\"===a.tagName?(s=a.href,o=$(a).text(),r=a.target,this.insert_link_node=a):o=e.toString(),$(\"#redactor_link_url_text\").val(o),o.length>0&&$(\"#redactor_link_url_text\").data(\"is_selected_text\",1);var l=self.location.href.replace(/\\/$/i,\"\");if(s=(s=(s=s.replace(l,\"\")).replace(/^\\/#/,\"#\")).replace(\"mailto:\",\"\"),!1===this.opts.linkProtocol){var c=RegExp(\"^(http|ftp|https)://\"+self.location.host,\"i\");s=s.replace(c,\"\")}$(\"#redactor_link_url\").val(s),\"_blank\"===r&&$(\"#redactor_link_blank\").prop(\"checked\",!0),this.linkInsertPressed=!1,$(\"#redactor_insert_link_btn\").on(\"click\",$.proxy(this.linkProcess,this)),setTimeout(function(){$(\"#redactor_link_url\").focus()},200)},this);this.modalInit(this.opts.curLang.link,this.opts.modal_link,460,t)},linkProcess:function(){if(!this.linkInsertPressed){this.linkInsertPressed=!0;var t=\"\",e=\"\",s=$(\"#redactor_link_url\").val(),o=$(\"#redactor_link_url_text\").val();if(-1!=s.search(\"@\")&&!1===/(http|ftp|https):\\/\\//i.test(s))s=\"mailto:\"+s;else if(0!=s.search(\"#\")){$(\"#redactor_link_blank\").prop(\"checked\")&&(t=' target=\"_blank\"',e=\"_blank\");var r=\"((xn--)?[a-z0-9]+(-[a-z0-9]+)*.)+[a-z]{2,}\",a=RegExp(\"^(http|ftp|https)://\"+r,\"i\"),n=RegExp(\"^\"+r,\"i\");-1==s.search(a)&&0==s.search(n)&&this.opts.linkProtocol&&(s=this.opts.linkProtocol+s)}o=o.replace(/<|>/g,\"\");var l=\"&nbsp;\";this.browser(\"mozilla\")&&(l=\"&nbsp;\"),this.linkInsert('<a href=\"'+s+'\"'+t+\">\"+o+\"</a>\"+l,$.trim(o),s,e)}},linkInsert:function(t,e,s,o){if(this.selectionRestore(),\"\"!==e){if(this.insert_link_node)this.bufferSet(),$(this.insert_link_node).text(e).attr(\"href\",s),\"\"!==o?$(this.insert_link_node).attr(\"target\",o):$(this.insert_link_node).removeAttr(\"target\");else{var r=$(t).addClass(\"redactor-added-link\");this.exec(\"inserthtml\",this.outerHtml(r),!1);var s=this.$editor.find(\"a.redactor-added-link\");s.removeAttr(\"style\").removeClass(\"redactor-added-link\").each(function(){\"\"==this.className&&$(this).removeAttr(\"class\")})}this.sync()}setTimeout($.proxy(function(){this.opts.observeLinks&&this.observeLinks()},this),5),this.modalClose()},fileShow:function(){this.selectionSave();var t=$.proxy(function(){var t=this.getSelection(),e=\"\";e=this.oldIE()?t.text:t.toString(),$(\"#redactor_filename\").val(e),this.isMobile()||this.isIPad()||this.draguploadInit(\"#redactor_file\",{url:this.opts.fileUpload,uploadFields:this.opts.uploadFields,success:$.proxy(this.fileCallback,this),error:$.proxy(function(t,e){this.callback(\"fileUploadError\",e)},this),uploadParam:this.opts.fileUploadParam}),this.uploadInit(\"redactor_file\",{auto:!0,url:this.opts.fileUpload,success:$.proxy(this.fileCallback,this),error:$.proxy(function(t,e){this.callback(\"fileUploadError\",e)},this)})},this);this.modalInit(this.opts.curLang.file,this.opts.modal_file,500,t)},fileCallback:function(t){if(this.selectionRestore(),!1!==t){var e=$(\"#redactor_filename\").val();\"\"===e&&(e=t.filename);var s='<a href=\"'+t.filelink+'\" id=\"filelink-marker\">'+e+\"</a>\";this.browser(\"webkit\")&&this.window.chrome&&(s+=\"&nbsp;\"),this.execCommand(\"inserthtml\",s,!1);var o=$(this.$editor.find(\"a#filelink-marker\"));0!=o.length?o.removeAttr(\"id\"):o=!1,this.sync(),this.callback(\"fileUpload\",o,t)}this.modalClose()},imageShow:function(){this.selectionSave();var t=$.proxy(function(){this.opts.imageGetJson?$.getJSON(this.opts.imageGetJson,$.proxy(function(t){if(t.error){alert(t.message);return}var e={},s=0;$.each(t,$.proxy(function(t,o){void 0!==o.folder&&(s++,e[o.folder]=s)},this)),$(\"#redactor_image_box .empty_list\").show();var o=!1;if($.each(t,$.proxy(function(t,s){var r=\"\";void 0!==s.title&&(r=s.title);var a=0;$.isEmptyObject(e)||void 0===s.folder||(a=e[s.folder],!1!==o||(o=\".redactorfolder\"+a));var n=$('<img src=\"'+s.thumb+'\" class=\"redactorfolder redactorfolder'+a+'\" rel=\"'+s.image+'\" title=\"'+r+'\" />');$(\"#redactor_image_box\").append(n),$(n).on(\"click\",$.proxy(this.imageThumbClick,this)),$(\"#redactor_image_box .empty_list\").hide()},this)),!$.isEmptyObject(e)){$(\".redactorfolder\").hide(),$(o).show();var r=function(t){$(\".redactorfolder\").hide(),$(\".redactorfolder\"+$(t.target).val()).show()},a=$('<select id=\"redactor_image_box_select\">');$.each(e,function(t,e){a.append($('<option value=\"'+e+'\">'+t+\"</option>\"))}),$(\"#redactor_image_box\").before(a),a.change(r)}},this)):$(\"#redactor-tab-control-2\").remove(),this.opts.imageUpload||this.opts.s3?(this.isMobile()||this.isIPad()||!1!==this.opts.s3||!$(\"#redactor_file\").length||this.draguploadInit(\"#redactor_file\",{url:this.opts.imageUpload,uploadFields:this.opts.uploadFields,success:$.proxy(this.imageCallback,this),error:$.proxy(function(t,e){this.callback(\"imageUploadError\",e)},this),uploadParam:this.opts.imageUploadParam}),!1===this.opts.s3?this.uploadInit(\"redactor_file\",{auto:!0,url:this.opts.imageUpload,success:$.proxy(this.imageCallback,this),error:$.proxy(function(t,e){this.callback(\"imageUploadError\",e)},this)}):$(\"#redactor_file\").on(\"change.redactor\",$.proxy(this.s3handleFileSelect,this))):($(\".redactor_tab\").hide(),this.opts.imageGetJson?($(\"#redactor-tab-control-1\").remove(),$(\"#redactor-tab-control-2\").addClass(\"redactor_tabs_act\"),$(\"#redactor_tab2\").show()):($(\"#redactor_tabs\").remove(),$(\"#redactor_tab3\").show())),!this.opts.imageTabLink&&(this.opts.imageUpload||this.opts.imageGetJson)&&$(\"#redactor-tab-control-3\").hide(),$(\"#redactor_upload_btn\").on(\"click\",$.proxy(this.imageCallbackLink,this)),this.opts.imageUpload||this.opts.imageGetJson||setTimeout(function(){$(\"#redactor_file_link\").focus()},200)},this);this.modalInit(this.opts.curLang.image,this.opts.modal_image,610,t)},imageEdit:function(t){var e=t,s=e.parent().parent(),o=$.proxy(function(){$(\"#redactor_file_alt\").val(e.attr(\"alt\")),$(\"#redactor_image_edit_src\").attr(\"href\",e.attr(\"src\")),\"block\"==e.css(\"display\")&&\"none\"==e.css(\"float\")?$(\"#redactor_form_image_align\").val(\"center\"):$(\"#redactor_form_image_align\").val(e.css(\"float\")),\"A\"===$(s).get(0).tagName&&($(\"#redactor_file_link\").val($(s).attr(\"href\")),\"_blank\"==$(s).attr(\"target\")&&$(\"#redactor_link_blank\").prop(\"checked\",!0)),$(\"#redactor_image_delete_btn\").on(\"click\",$.proxy(function(){this.imageRemove(e)},this)),$(\"#redactorSaveBtn\").on(\"click\",$.proxy(function(){this.imageSave(e)},this))},this);this.modalInit(this.opts.curLang.edit,this.opts.modal_image_edit,380,o)},imageRemove:function(t){var e=$(t).parent().parent(),s=$(t).parent(),o=!1;e.length&&\"A\"===e[0].tagName?(o=!0,$(e).remove()):s.length&&\"A\"===s[0].tagName?(o=!0,$(s).remove()):$(t).remove(),s.length&&\"P\"===s[0].tagName&&(this.focusWithSaveScroll(),!1===o&&this.selectionStart(s)),this.callback(\"imageDelete\",t),this.modalClose(),this.sync()},imageSave:function(t){this.imageResizeHide(!1);var e=$(t),s=e.parent();e.attr(\"alt\",$(\"#redactor_file_alt\").val());var o=$(\"#redactor_form_image_align\").val(),r=\"\";\"left\"===o?(r=\"0 \"+this.opts.imageFloatMargin+\" \"+this.opts.imageFloatMargin+\" 0\",e.css({float:\"left\",margin:r})):\"right\"===o?(r=\"0 0 \"+this.opts.imageFloatMargin+\" \"+this.opts.imageFloatMargin,e.css({float:\"right\",margin:r})):\"center\"===o?e.css({float:\"\",display:\"block\",margin:\"auto\"}):e.css({float:\"\",display:\"\",margin:\"\"});var a=$.trim($(\"#redactor_file_link\").val());if(\"\"!==a){var n=!1;if($(\"#redactor_link_blank\").prop(\"checked\")&&(n=!0),\"A\"!==s.get(0).tagName){var l=$('<a href=\"'+a+'\">'+this.outerHtml(t)+\"</a>\");n&&l.attr(\"target\",\"_blank\"),e.replaceWith(l)}else s.attr(\"href\",a),n?s.attr(\"target\",\"_blank\"):s.removeAttr(\"target\")}else\"A\"===s.get(0).tagName&&s.replaceWith(this.outerHtml(t));this.modalClose(),this.observeImages(),this.sync()},imageResizeHide:function(t){if(!1!==t&&0!=$(t.target).parent().length&&\"redactor-image-box\"===$(t.target).parent()[0].id)return!1;var e=this.$editor.find(\"#redactor-image-box\");if(0==e.length)return!1;this.$editor.find(\"#redactor-image-editter, #redactor-image-resizer\").remove(),e.find(\"img\").css({marginTop:e[0].style.marginTop,marginBottom:e[0].style.marginBottom,marginLeft:e[0].style.marginLeft,marginRight:e[0].style.marginRight}),e.css(\"margin\",\"\"),e.find(\"img\").css(\"opacity\",\"\"),e.replaceWith(function(){return $(this).contents()}),$(document).off(\"click.redactor-image-resize-hide\"),this.$editor.off(\"click.redactor-image-resize-hide\"),this.$editor.off(\"keydown.redactor-image-delete\"),this.sync()},imageResize:function(t){var e=$(t);e.on(\"mousedown\",$.proxy(function(){this.imageResizeHide(!1)},this)),e.on(\"dragstart\",$.proxy(function(){this.$editor.on(\"drop.redactor-image-inside-drop\",$.proxy(function(){setTimeout($.proxy(function(){this.observeImages(),this.$editor.off(\"drop.redactor-image-inside-drop\"),this.sync()},this),1)},this))},this)),e.on(\"click\",$.proxy(function(t){if(0!=this.$editor.find(\"#redactor-image-box\").length)return!1;var s,o,r=e.width()/e.height(),a=20,n=this.imageResizeControls(e),l=!1;!1!==n&&(n.on(\"mousedown\",function(t){l=!0,t.preventDefault(),r=e.width()/e.height(),s=Math.round(t.pageX-e.eq(0).offset().left),o=Math.round(t.pageY-e.eq(0).offset().top)}),$(this.document.body).on(\"mousemove\",$.proxy(function(t){if(l){t.pageX,e.eq(0).offset().left;var n=Math.round(t.pageY-e.eq(0).offset().top)-o,c=Math.round((parseInt(e.height(),10)+n)*r);c>a&&(e.width(c),c<100?this.imageEditter.css({marginTop:\"-7px\",marginLeft:\"-13px\",fontSize:\"9px\",padding:\"3px 5px\"}):this.imageEditter.css({marginTop:\"-11px\",marginLeft:\"-18px\",fontSize:\"11px\",padding:\"7px 10px\"})),s=Math.round(t.pageX-e.eq(0).offset().left),o=Math.round(t.pageY-e.eq(0).offset().top),this.sync()}},this)).on(\"mouseup\",function(){l=!1})),this.$editor.on(\"keydown.redactor-image-delete\",$.proxy(function(t){var s=t.which;(this.keyCode.BACKSPACE==s||this.keyCode.DELETE==s)&&(this.bufferSet(!1),this.imageResizeHide(!1),this.imageRemove(e))},this)),$(document).on(\"click.redactor-image-resize-hide\",$.proxy(this.imageResizeHide,this)),this.$editor.on(\"click.redactor-image-resize-hide\",$.proxy(this.imageResizeHide,this))},this))},imageResizeControls:function(t){var e=$('<span id=\"redactor-image-box\" data-redactor=\"verified\">');if(e.css({position:\"relative\",display:\"inline-block\",lineHeight:0,outline:\"1px dashed rgba(0, 0, 0, .6)\",float:t.css(\"float\")}),e.attr(\"contenteditable\",!1),\"auto\"!=t[0].style.margin?(e.css({marginTop:t[0].style.marginTop,marginBottom:t[0].style.marginBottom,marginLeft:t[0].style.marginLeft,marginRight:t[0].style.marginRight}),t.css(\"margin\",\"\")):e.css({display:\"block\",margin:\"auto\"}),t.css(\"opacity\",.5).after(e),this.imageEditter=$('<span id=\"redactor-image-editter\" data-redactor=\"verified\">'+this.opts.curLang.edit+\"</span>\"),this.imageEditter.css({position:\"absolute\",zIndex:5,top:\"50%\",left:\"50%\",marginTop:\"-11px\",marginLeft:\"-18px\",lineHeight:1,backgroundColor:\"#000\",color:\"#fff\",fontSize:\"11px\",padding:\"7px 10px\",cursor:\"pointer\"}),this.imageEditter.attr(\"contenteditable\",!1),this.imageEditter.on(\"click\",$.proxy(function(){this.imageEdit(t)},this)),e.append(this.imageEditter),!this.opts.imageResizable)return e.append(t),!1;var s=$('<span id=\"redactor-image-resizer\" data-redactor=\"verified\"></span>');return s.css({position:\"absolute\",zIndex:2,lineHeight:1,cursor:\"nw-resize\",bottom:\"-4px\",right:\"-5px\",border:\"1px solid #fff\",backgroundColor:\"#000\",width:\"8px\",height:\"8px\"}),s.attr(\"contenteditable\",!1),e.append(s),e.append(t),s},imageThumbClick:function(t){var e='<img id=\"image-marker\" src=\"'+$(t.target).attr(\"rel\")+'\" alt=\"'+$(t.target).attr(\"title\")+'\" />',s=this.getParent();this.opts.paragraphy&&0==$(s).closest(\"li\").length&&(e=\"<p>\"+e+\"</p>\"),this.imageInsert(e,!0)},imageCallbackLink:function(){var t=$(\"#redactor_file_link\").val();if(\"\"!==t){var e='<img id=\"image-marker\" src=\"'+t+'\" />';!1===this.opts.linebreaks&&(e=\"<p>\"+e+\"</p>\"),this.imageInsert(e,!0)}else this.modalClose()},imageCallback:function(t){this.imageInsert(t)},imageInsert:function(t,e){if(this.selectionRestore(),!1!==t){var s=\"\";if(!0!==e){s='<img id=\"image-marker\" src=\"'+t.image.url+'\" />';var o=this.getParent();this.opts.paragraphy&&0==$(o).closest(\"li\").length&&(s=\"<p>\"+s+\"</p>\")}else s=t;this.execCommand(\"inserthtml\",s,!1);var r=$(this.$editor.find(\"img#image-marker\"));r.length?r.removeAttr(\"id\"):r=!1,this.sync(),!0!==e&&this.callback(\"imageUpload\",r,t)}this.modalClose(),this.observeImages()},buildProgressBar:function(){0==$(\"#redactor-progress\").length&&(this.$progressBar=$('<div id=\"redactor-progress\"><span></span></div>'),$(document.body).append(this.$progressBar))},showProgressBar:function(){this.buildProgressBar(),$(\"#redactor-progress\").fadeIn()},hideProgressBar:function(){$(\"#redactor-progress\").fadeOut(1500)},modalTemplatesInit:function(){$.extend(this.opts,{modal_file:String()+'<section id=\"redactor-modal-file-insert\"><form id=\"redactorUploadFileForm\" method=\"post\" action=\"\" enctype=\"multipart/form-data\"><label>'+this.opts.curLang.filename+'</label><input type=\"text\" id=\"redactor_filename\" class=\"redactor_input\" /><div style=\"margin-top: 7px;\"><input type=\"file\" id=\"redactor_file\" name=\"'+this.opts.fileUploadParam+'\" /></div></form></section>',modal_image_edit:String()+'<section id=\"redactor-modal-image-edit\"><label>'+this.opts.curLang.title+'</label><input type=\"text\" id=\"redactor_file_alt\" class=\"redactor_input\" /><label>'+this.opts.curLang.link+'</label><input type=\"text\" id=\"redactor_file_link\" class=\"redactor_input\" /><label><input type=\"checkbox\" id=\"redactor_link_blank\"> '+this.opts.curLang.link_new_tab+\"</label><label>\"+this.opts.curLang.image_position+'</label><select id=\"redactor_form_image_align\"><option value=\"none\">'+this.opts.curLang.none+'</option><option value=\"left\">'+this.opts.curLang.left+'</option><option value=\"center\">'+this.opts.curLang.center+'</option><option value=\"right\">'+this.opts.curLang.right+'</option></select></section><footer><button id=\"redactor_image_delete_btn\" class=\"redactor_modal_btn redactor_modal_delete_btn\">'+this.opts.curLang._delete+'</button><button class=\"redactor_modal_btn redactor_btn_modal_close\">'+this.opts.curLang.cancel+'</button><button id=\"redactorSaveBtn\" class=\"redactor_modal_btn redactor_modal_action_btn\">'+this.opts.curLang.save+\"</button></footer>\",modal_image:String()+'<section id=\"redactor-modal-image-insert\"><div id=\"redactor_tabs\"><a href=\"#\" id=\"redactor-tab-control-1\" class=\"redactor_tabs_act\">'+this.opts.curLang.upload+'</a><a href=\"#\" id=\"redactor-tab-control-2\">'+this.opts.curLang.choose+'</a><a href=\"#\" id=\"redactor-tab-control-3\">'+this.opts.curLang.link+'</a></div><form id=\"redactorInsertImageForm\" method=\"post\" action=\"\" enctype=\"multipart/form-data\"><div id=\"redactor_tab1\" class=\"redactor_tab\"><input type=\"file\" id=\"redactor_file\" name=\"'+this.opts.imageUploadParam+'\" /></div><div id=\"redactor_tab2\" class=\"redactor_tab\" style=\"display: none;\"><div id=\"redactor_image_box\"><span class=\"empty_list\">'+this.opts.curLang.empty_img_list+'</span></div></div></form><div id=\"redactor_tab3\" class=\"redactor_tab\" style=\"display: none;\"><label>'+this.opts.curLang.image_web_link+'</label><input type=\"text\" name=\"redactor_file_link\" id=\"redactor_file_link\" class=\"redactor_input\"  /><br><br></div></section><footer><button class=\"redactor_modal_btn redactor_btn_modal_close\">'+this.opts.curLang.cancel+'</button><button class=\"redactor_modal_btn redactor_modal_action_btn\" id=\"redactor_upload_btn\">'+this.opts.curLang.insert+\"</button></footer>\",modal_link:String()+'<section id=\"redactor-modal-link-insert\"><select id=\"redactor-predefined-links\" style=\"width: 99.5%; display: none;\"></select><label>URL</label><input type=\"text\" class=\"redactor_input\" id=\"redactor_link_url\" /><label>'+this.opts.curLang.text+'</label><input type=\"text\" class=\"redactor_input\" id=\"redactor_link_url_text\" /><label><input type=\"checkbox\" id=\"redactor_link_blank\"> '+this.opts.curLang.link_new_tab+'</label></section><footer><button class=\"redactor_modal_btn redactor_btn_modal_close\">'+this.opts.curLang.cancel+'</button><button id=\"redactor_insert_link_btn\" class=\"redactor_modal_btn redactor_modal_action_btn\">'+this.opts.curLang.insert+\"</button></footer>\",modal_table:String()+'<section id=\"redactor-modal-table-insert\"><label>'+this.opts.curLang.rows+'</label><input type=\"text\" size=\"5\" value=\"2\" id=\"redactor_table_rows\" /><label>'+this.opts.curLang.columns+'</label><input type=\"text\" size=\"5\" value=\"3\" id=\"redactor_table_columns\" /></section><footer><button class=\"redactor_modal_btn redactor_btn_modal_close\">'+this.opts.curLang.cancel+'</button><button id=\"redactor_insert_table_btn\" class=\"redactor_modal_btn redactor_modal_action_btn\">'+this.opts.curLang.insert+\"</button></footer>\",modal_video:String()+'<section id=\"redactor-modal-video-insert\"><form id=\"redactorInsertVideoForm\"><label>'+this.opts.curLang.video_html_code+'</label><textarea id=\"redactor_insert_video_area\" style=\"width: 99%; height: 160px;\"></textarea></form></section><footer><button class=\"redactor_modal_btn redactor_btn_modal_close\">'+this.opts.curLang.cancel+'</button><button id=\"redactor_insert_video_btn\" class=\"redactor_modal_btn redactor_modal_action_btn\">'+this.opts.curLang.insert+\"</button></footer>\"})},modalInit:function(t,e,s,o){return this.modalSetOverlay(),this.$redactorModalWidth=s,this.$redactorModal=$(\"#redactor_modal\"),this.$redactorModal.length||(this.$redactorModal=$('<div id=\"redactor_modal\" style=\"display: none;\" />'),this.$redactorModal.append($('<div id=\"redactor_modal_close\">&times;</div>')),this.$redactorModal.append($('<header id=\"redactor_modal_header\" />')),this.$redactorModal.append($('<div id=\"redactor_modal_inner\" />')),this.$redactorModal.appendTo(document.body)),$(\"#redactor_modal_close\").on(\"click\",$.proxy(this.modalClose,this)),$(document).on(\"keyup\",$.proxy(this.modalCloseHandler,this)),this.$editor.on(\"keyup\",$.proxy(this.modalCloseHandler,this)),this.modalSetContent(e),this.modalSetTitle(t),this.modalSetDraggable(),this.modalLoadTabs(),this.modalOnCloseButton(),this.modalSetButtonsWidth(),this.saveModalScroll=this.document.body.scrollTop,!1===this.opts.autoresize&&(this.saveModalScroll=this.$editor.scrollTop()),!1===this.isMobile()?this.modalShowOnDesktop():this.modalShowOnMobile(),\"function\"==typeof o&&o(),setTimeout($.proxy(function(){this.callback(\"modalOpened\",this.$redactorModal)},this),11),$(document).off(\"focusin.modal\"),this.$redactorModal.find(\"input[type=text]\").on(\"keypress\",$.proxy(function(t){13===t.which&&(this.$redactorModal.find(\".redactor_modal_action_btn\").trigger(\"click\"),t.preventDefault())},this)),this.$redactorModal},modalShowOnDesktop:function(){this.$redactorModal.css({position:\"fixed\",top:\"-2000px\",left:\"50%\",width:this.$redactorModalWidth+\"px\",marginLeft:\"-\"+this.$redactorModalWidth/2+\"px\"}).show(),this.modalSaveBodyOveflow=$(document.body).css(\"overflow\"),$(document.body).css(\"overflow\",\"hidden\"),setTimeout($.proxy(function(){var t=this.$redactorModal.outerHeight();this.$redactorModal.css({top:\"50%\",height:\"auto\",minHeight:\"auto\",marginTop:\"-\"+(t+10)/2+\"px\"})},this),15)},modalShowOnMobile:function(){this.$redactorModal.css({position:\"fixed\",width:\"100%\",height:\"100%\",top:\"0\",left:\"0\",margin:\"0\",minHeight:\"300px\"}).show()},modalSetContent:function(t){this.modalcontent=!1,0==t.indexOf(\"#\")?(this.modalcontent=$(t),$(\"#redactor_modal_inner\").empty().append(this.modalcontent.html()),this.modalcontent.html(\"\")):$(\"#redactor_modal_inner\").empty().append(t)},modalSetTitle:function(t){this.$redactorModal.find(\"#redactor_modal_header\").html(t)},modalSetButtonsWidth:function(){},modalOnCloseButton:function(){this.$redactorModal.find(\".redactor_btn_modal_close\").on(\"click\",$.proxy(this.modalClose,this))},modalSetOverlay:function(){this.opts.modalOverlay&&(this.$redactorModalOverlay=$(\"#redactor_modal_overlay\"),this.$redactorModalOverlay.length||(this.$redactorModalOverlay=$('<div id=\"redactor_modal_overlay\" style=\"display: none;\"></div>'),$(\"body\").prepend(this.$redactorModalOverlay)),this.$redactorModalOverlay.show().on(\"click\",$.proxy(this.modalClose,this)))},modalSetDraggable:function(){void 0!==$.fn.draggable&&(this.$redactorModal.draggable({handle:\"#redactor_modal_header\"}),this.$redactorModal.find(\"#redactor_modal_header\").css(\"cursor\",\"move\"))},modalLoadTabs:function(){var t=$(\"#redactor_tabs\");if(!t.length)return!1;var e=this;t.find(\"a\").each(function(s,o){s++,$(o).on(\"click\",function(o){if(o.preventDefault(),t.find(\"a\").removeClass(\"redactor_tabs_act\"),$(this).addClass(\"redactor_tabs_act\"),$(\".redactor_tab\").hide(),$(\"#redactor_tab\"+s).show(),$(\"#redactor_tab_selected\").val(s),!1===e.isMobile()){var r=e.$redactorModal.outerHeight();e.$redactorModal.css(\"margin-top\",\"-\"+(r+10)/2+\"px\")}})})},modalCloseHandler:function(t){if(t.keyCode===this.keyCode.ESC)return this.modalClose(),!1},modalClose:function(){return $(\"#redactor_modal_close\").off(\"click\",this.modalClose),$(\"#redactor_modal\").fadeOut(\"fast\",$.proxy(function(){var t=$(\"#redactor_modal_inner\");!1!==this.modalcontent&&(this.modalcontent.html(t.html()),this.modalcontent=!1),t.html(\"\"),this.opts.modalOverlay&&$(\"#redactor_modal_overlay\").hide().off(\"click\",this.modalClose),$(document).off(\"keyup\",this.modalCloseHandler),this.$editor.off(\"keyup\",this.modalCloseHandler),this.selectionRestore(),this.opts.autoresize&&this.saveModalScroll?$(this.document.body).scrollTop(this.saveModalScroll):!1===this.opts.autoresize&&this.saveModalScroll&&this.$editor.scrollTop(this.saveModalScroll),this.callback(\"modalClosed\")},this)),!1===this.isMobile()&&$(document.body).css(\"overflow\",this.modalSaveBodyOveflow?this.modalSaveBodyOveflow:\"visible\"),!1},modalSetTab:function(t){$(\".redactor_tab\").hide(),$(\"#redactor_tabs\").find(\"a\").removeClass(\"redactor_tabs_act\").eq(t-1).addClass(\"redactor_tabs_act\"),$(\"#redactor_tab\"+t).show()},s3handleFileSelect:function(t){for(var e,s=t.target.files,o=0;e=s[o];o++)this.s3uploadFile(e)},s3uploadFile:function(t){this.s3executeOnSignedUrl(t,$.proxy(function(e){this.s3uploadToS3(t,e)},this))},s3executeOnSignedUrl:function(t,e){var s=new XMLHttpRequest,o=\"?\";\"-1\"!=this.opts.s3.search(/\\?/)&&(o=\"&\"),s.open(\"GET\",this.opts.s3+o+\"name=\"+t.name+\"&type=\"+t.type,!0),s.overrideMimeType&&s.overrideMimeType(\"text/plain; charset=x-user-defined\");var r=this;s.onreadystatechange=function(t){4==this.readyState&&200==this.status?(r.showProgressBar(),e(decodeURIComponent(this.responseText))):4==this.readyState&&this.status},s.send()},s3createCORSRequest:function(t,e){var s=new XMLHttpRequest;return\"withCredentials\"in s?s.open(t,e,!0):\"undefined\"!=typeof XDomainRequest?(s=new XDomainRequest).open(t,e):s=null,s},s3uploadToS3:function(t,e){var s=this.s3createCORSRequest(\"PUT\",e);s&&(s.onload=$.proxy(function(){if(200==s.status){this.hideProgressBar();var t=e.split(\"?\");if(!t[0])return!1;this.selectionRestore();var o=\"\";o='<img id=\"image-marker\" src=\"'+t[0]+'\" />',this.opts.paragraphy&&(o=\"<p>\"+o+\"</p>\"),this.execCommand(\"inserthtml\",o,!1);var r=$(this.$editor.find(\"img#image-marker\"));r.length?r.removeAttr(\"id\"):r=!1,this.sync(),this.callback(\"imageUpload\",r,!1),this.modalClose(),this.observeImages()}},this),s.onerror=function(){},s.upload.onprogress=function(t){},s.setRequestHeader(\"Content-Type\",t.type),s.setRequestHeader(\"x-amz-acl\",\"public-read\"),s.send(t))},uploadInit:function(t,e){this.uploadOptions={url:!1,success:!1,error:!1,start:!1,trigger:!1,auto:!1,input:!1},$.extend(this.uploadOptions,e);var s=$(\"#\"+t);s.length&&\"INPUT\"===s[0].tagName?(this.uploadOptions.input=s,this.el=$(s[0].form)):this.el=s,this.element_action=this.el.attr(\"action\"),this.uploadOptions.auto?$(this.uploadOptions.input).change($.proxy(function(t){this.el.submit(function(t){return!1}),this.uploadSubmit(t)},this)):this.uploadOptions.trigger&&$(\"#\"+this.uploadOptions.trigger).on(\"click\",$.proxy(this.uploadSubmit,this))},uploadSubmit:function(t){this.showProgressBar(),this.uploadForm(this.element,this.uploadFrame())},uploadFrame:function(){this.id=\"f\"+Math.floor(99999*Math.random());var t=this.document.createElement(\"div\"),e='<iframe style=\"display:none\" id=\"'+this.id+'\" name=\"'+this.id+'\"></iframe>';return t.innerHTML=e,$(t).appendTo(\"body\"),this.uploadOptions.start&&this.uploadOptions.start(),$(\"#\"+this.id).one(\"load\",$.proxy(this.uploadLoaded,this)),this.id},uploadForm:function(t,e){if(this.uploadOptions.input){var s=\"redactorUploadForm\"+this.id,o=\"redactorUploadFile\"+this.id;this.form=$('<form  action=\"'+this.uploadOptions.url+'\" method=\"POST\" target=\"'+e+'\" name=\"'+s+'\" id=\"'+s+'\" enctype=\"multipart/form-data\" />'),!1!==this.opts.uploadFields&&\"object\"==typeof this.opts.uploadFields&&$.each(this.opts.uploadFields,$.proxy(function(t,e){null!=e&&0===e.toString().indexOf(\"#\")&&(e=$(e).val());var s=$(\"<input/>\",{type:\"hidden\",name:t,value:e});$(this.form).append(s)},this));var r=this.uploadOptions.input,a=$(r).clone();$(r).attr(\"id\",o).before(a).appendTo(this.form),$(this.form).css(\"position\",\"absolute\").css(\"top\",\"-2000px\").css(\"left\",\"-2000px\").appendTo(\"body\"),this.form.submit()}else t.attr(\"target\",e).attr(\"method\",\"POST\").attr(\"enctype\",\"multipart/form-data\").attr(\"action\",this.uploadOptions.url),this.element.submit()},uploadLoaded:function(){var t,e=$(\"#\"+this.id)[0];if(t=e.contentDocument?e.contentDocument:e.contentWindow?e.contentWindow.document:window.frames[this.id].document,this.uploadOptions.success){if(this.hideProgressBar(),void 0!==t){var s=t.body.innerHTML.match(/\\{(.|\\n)*\\}/)[0];s=(s=s.replace(/^\\[/,\"\")).replace(/\\]$/,\"\");var o=$.parseJSON(s);void 0===o.error?this.uploadOptions.success(o):(console.log(o),this.uploadOptions.error(this,o),this.modalClose())}else this.modalClose(),alert(\"Upload failed!\")}this.el.attr(\"action\",this.element_action),this.el.attr(\"target\",\"\")},draguploadInit:function(t,e){if(this.draguploadOptions=$.extend({url:!1,success:!1,error:!1,preview:!1,uploadFields:!1,text:this.opts.curLang.drop_file_here,atext:this.opts.curLang.or_choose,uploadParam:!1},e),void 0===window.FormData)return!1;this.droparea=$('<div class=\"redactor_droparea\"></div>'),this.dropareabox=$('<div class=\"redactor_dropareabox\">'+this.draguploadOptions.text+\"</div>\"),this.dropalternative=$('<div class=\"redactor_dropalternative\">'+this.draguploadOptions.atext+\"</div>\"),this.droparea.append(this.dropareabox),$(t).before(this.droparea),$(t).before(this.dropalternative),this.dropareabox.on(\"dragover\",$.proxy(function(){return this.draguploadOndrag()},this)),this.dropareabox.on(\"dragleave\",$.proxy(function(){return this.draguploadOndragleave()},this)),this.dropareabox.get(0).ondrop=$.proxy(function(t){for(var e in t.preventDefault(),this.dropareabox.removeClass(\"hover\").addClass(\"drop\"),this.showProgressBar(),t.dataTransfer.files)t.dataTransfer.files.hasOwnProperty(e)&&this.dragUploadAjax(this.draguploadOptions.url,t.dataTransfer.files[e],!1,t,this.draguploadOptions.uploadParam)},this)},dragUploadAjax:function(t,e,s,o,r){if(!s){var a=$.ajaxSettings.xhr();a.upload&&a.upload.addEventListener(\"progress\",$.proxy(this.uploadProgress,this),!1),$.ajaxSetup({xhr:function(){return a}})}this.callback(\"drop\",o);var n=new FormData;!1!==r?n.append(r,e):n.append(\"file\",e),!1!==this.opts.uploadFields&&\"object\"==typeof this.opts.uploadFields&&$.each(this.opts.uploadFields,$.proxy(function(t,e){null!=e&&0===e.toString().indexOf(\"#\")&&(e=$(e).val()),n.append(t,e)},this)),$.ajax({url:t,dataType:\"html\",async:!1,data:n,cache:!1,contentType:!1,processData:!1,type:\"POST\",success:$.proxy(function(t){var e=\"string\"==typeof(t=(t=t.replace(/^\\[/,\"\")).replace(/\\]$/,\"\"))?$.parseJSON(t):t;if(this.hideProgressBar(),s){var r=$(\"<img>\");r.attr(\"src\",e.image.url).attr(\"id\",\"drag-image-marker\"),this.insertNodeToCaretPositionFromPoint(o,r[0]);var a=$(this.$editor.find(\"img#drag-image-marker\"));a.length?a.removeAttr(\"id\"):a=!1,this.sync(),this.observeImages(),a&&this.callback(\"imageUpload\",a,e),void 0!==e.error&&this.callback(\"imageUploadError\",e)}else void 0===e.error?this.draguploadOptions.success(e):(this.draguploadOptions.error(this,e),this.draguploadOptions.success(!1))},this)})},draguploadOndrag:function(){return this.dropareabox.addClass(\"hover\"),!1},draguploadOndragleave:function(){return this.dropareabox.removeClass(\"hover\"),!1},uploadProgress:function(t,e){var s=t.loaded?parseInt(t.loaded/t.total*100,10):t;this.dropareabox.text(\"Loading \"+s+\"% \"+(e||\"\"))},isMobile:function(){return/(iPhone|iPod|BlackBerry|Android)/.test(navigator.userAgent)},isIPad:function(){return/iPad/.test(navigator.userAgent)},normalize:function(t){return void 0===t?0:parseInt(t.replace(\"px\",\"\"),10)},outerHtml:function(t){return $(\"<div>\").append($(t).eq(0).clone()).html()},stripHtml:function(t){var e=document.createElement(\"DIV\");return e.innerHTML=t,e.textContent||e.innerText||\"\"},isString:function(t){return\"[object String]\"==Object.prototype.toString.call(t)},isEmpty:function(t){return\"\"==(t=(t=(t=t.replace(/&#x200b;|<br>|<br\\/>|&nbsp;/gi,\"\")).replace(/\\s/g,\"\")).replace(/^<p>[^\\W\\w\\D\\d]*?<\\/p>$/i,\"\"))},getInternetExplorerVersion:function(){var t=!1;if(\"Microsoft Internet Explorer\"==navigator.appName){var e=navigator.userAgent;null!=RegExp(\"MSIE ([0-9]{1,}[.0-9]{0,})\").exec(e)&&(t=parseFloat(RegExp.$1))}return t},isIe11:function(){return!!navigator.userAgent.match(/Trident\\/7\\./)},browser:function(t){var e=navigator.userAgent.toLowerCase(),s=/(opr)[\\/]([\\w.]+)/.exec(e)||/(chrome)[ \\/]([\\w.]+)/.exec(e)||/(webkit)[ \\/]([\\w.]+).*(safari)[ \\/]([\\w.]+)/.exec(e)||/(webkit)[ \\/]([\\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \\/]([\\w.]+)/.exec(e)||/(msie) ([\\w.]+)/.exec(e)||e.indexOf(\"trident\")>=0&&/(rv)(?::| )([\\w.]+)/.exec(e)||0>e.indexOf(\"compatible\")&&/(mozilla)(?:.*? rv:([\\w.]+)|)/.exec(e)||[];return\"version\"==t?s[2]:\"webkit\"==t?\"chrome\"==s[1]||\"webkit\"==s[1]:\"rv\"==s[1]?\"msie\"==t:\"opr\"==s[1]?\"webkit\"==t:t==s[1]},oldIE:function(){return!!(this.browser(\"msie\")&&9>parseInt(this.browser(\"version\"),10))},getFragmentHtml:function(t){var e=t.cloneNode(!0),s=this.document.createElement(\"div\");return s.appendChild(e),s.innerHTML},extractContent:function(){for(var t,e=this.$editor[0],s=this.document.createDocumentFragment();t=e.firstChild;)s.appendChild(t);return s},isParentRedactor:function(t){return!!t&&(this.opts.iframe?t:!(0==$(t).parents(\"div.redactor_editor\").length||$(t).hasClass(\"redactor_editor\"))&&t)},currentOrParentIs:function(t){var e=this.getParent(),s=this.getCurrent();return e&&e.tagName===t?e:!!s&&s.tagName===t&&s},isEndOfElement:function(){var t=this.getBlock(),e=this.getCaretOffset(t),s=$.trim($(t).text()).replace(/\\n\\r\\n/g,\"\").length;return e==s},isFocused:function(){var t,e=this.getSelection();return e&&e.rangeCount&&e.rangeCount>0&&(t=e.getRangeAt(0).startContainer),!!t&&(this.opts.iframe?!this.getCaretOffsetRange().equals()||!this.$editor.is(t):0!=$(t).closest(\"div.redactor_editor\").length)},removeEmptyAttr:function(t,e){\"\"==$(t).attr(e)&&$(t).removeAttr(e)},removeFromArrayByValue:function(t,e){for(var s=null;-1!==(s=t.indexOf(e));)t.splice(s,1);return t}},Redactor.prototype.init.prototype=Redactor.prototype,$.Redactor.fn.formatLinkify=function(t,e,s,o,r){for(var a=/(((https?|ftps?):\\/\\/)|www[.][^\\s])(.+?\\..+?)([.),]?)(\\s|\\.\\s+|\\)|$)/gi,n=/(https?|ftp):\\/\\//i,l=/(https?:\\/\\/.*\\.(?:png|jpg|jpeg|gif))/gi,c=(this.$editor?this.$editor.get(0):this).childNodes,h=c.length;h--;){var d=c[h];if(3===d.nodeType){var p=d.nodeValue;if(o&&p){var u='<iframe width=\"500\" height=\"281\" src=\"',f='\" frameborder=\"0\" allowfullscreen></iframe>';p.match(reUrlYoutube)?(p=p.replace(reUrlYoutube,u+\"//www.youtube.com/embed/$1\"+f),$(d).after(p).remove()):p.match(reUrlVimeo)&&(p=p.replace(reUrlVimeo,u+\"//player.vimeo.com/video/$2\"+f),$(d).after(p).remove())}if(s&&p&&p.match(l)&&(p=p.replace(l,'<img src=\"$1\">'),$(d).after(p).remove()),e&&p&&p.match(a)){var m=p.match(a);for(var h in m){var g=m[h],b=g,v=\"\";null!==g.match(/\\s$/)&&(v=\" \");var _=t;null!==g.match(n)&&(_=\"\"),b.length>r&&(b=b.substring(0,r)+\"...\");var y=(b=b.replace(/&/g,\"&amp;\").replace(/</g,\"&lt;\").replace(/>/g,\"&gt;\")).replace(\"$\",\"$$$\");p=p.replace(g,'<a href=\"'+_+$.trim(g)+'\">'+$.trim(y)+\"</a>\"+v)}$(d).after(p).remove()}}else 1!==d.nodeType||/^(a|button|textarea)$/i.test(d.tagName)||$.Redactor.fn.formatLinkify.call(d,t,e,s,o,r)}}}(jQuery);"], "fixing_code": ["<?php\n\nclass actionMessagesWrite extends cmsAction {\n\n    public function run($contact_id) {\n\n        if (!is_numeric($contact_id)) {\n            return cmsCore::error404();\n        }\n\n        if (empty($this->options['is_enable_pm'])) {\n            return cmsCore::error404();\n        }\n\n        // \u0421\u0430\u043c\u043e\u043c\u0443 \u0441\u0435\u0431\u0435 \u043d\u0435\u043b\u044c\u0437\u044f\n        if ($this->cms_user->id == $contact_id) {\n            return cmsCore::error404();\n        }\n\n        $contact_exists_id = $this->model->isContactExists($this->cms_user->id, $contact_id);\n\n        if (!$contact_exists_id) {\n            $contact_exists_id = $contact_id;\n            $this->model->addContact($this->cms_user->id, $contact_id);\n        }\n\n        // \u041a\u0430\u043a\u043e\u0439 \u043a\u043e\u043d\u0442\u0430\u043a\u0442 \u0432\u044b\u0431\u0438\u0440\u0430\u0435\u043c\n        $this->request->set('select_contact_id', $contact_exists_id);\n\n        $this->executeAction('index');\n    }\n\n}\n", "<?php\n/**\n * @property \\modelMessages $model\n * @property \\modelUsers $model_users\n */\nclass messages extends cmsFrontend {\n\n    protected $useOptions = true;\n\n    private $sender_id;\n    private $recipients = [];\n    private $is_ignore_options = false;\n\n    /**\n     * \u0412\u0441\u0435 \u0437\u0430\u043f\u0440\u043e\u0441\u044b \u043c\u043e\u0433\u0443\u0442 \u0431\u044b\u0442\u044c \u0432\u044b\u043f\u043e\u043b\u043d\u0435\u043d\u044b \u0442\u043e\u043b\u044c\u043a\u043e \u0430\u0432\u0442\u043e\u0440\u0438\u0437\u043e\u0432\u0430\u043d\u043d\u044b\u043c\u0438 \u0438 \u0442\u043e\u043b\u044c\u043a\u043e \u043f\u043e \u0430\u044f\u043a\u0441\n     *\n     * @param string $action_name\n     */\n    public function before($action_name) {\n\n        parent::before($action_name);\n\n        if (!$this->request->isInternal()) {\n\n            if (!$this->request->isAjax() && $action_name !== 'index') {\n                return cmsCore::error404();\n            }\n\n            if (!cmsUser::isLogged()) {\n                return cmsCore::error404();\n            }\n\n            // \u0417\u0434\u0435\u0441\u044c \u0432\u0438\u0434\u0436\u0435\u0442\u044b \u043d\u0435 \u043d\u0443\u0436\u043d\u044b\n            if ($action_name !== 'index') {\n                $this->cms_template->widgets_rendered = true;\n            }\n        }\n\n        return true;\n    }\n\n    /**\n     * \u0423\u0441\u0442\u0430\u043d\u0430\u0432\u043b\u0438\u0432\u0430\u0435\u0442 \u043e\u0442\u043f\u0440\u0430\u0432\u0438\u0442\u0435\u043b\u044f \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f\n     *\n     * @param integer $user_id\n     * @return \\messages\n     */\n    public function setSender($user_id) {\n\n        $this->sender_id = $user_id;\n\n        return $this;\n    }\n\n    /**\n     * \u0414\u043e\u0431\u0430\u0432\u043b\u044f\u0435\u0442 \u043f\u043e\u043b\u0443\u0447\u0430\u0442\u0435\u043b\u044f \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f\n     *\n     * @param integer $user_id\n     * @return \\messages\n     */\n    public function addRecipient($user_id) {\n\n        $this->recipients[] = $user_id;\n\n        return $this;\n    }\n\n    /**\n     * \u0414\u043e\u0431\u0430\u0432\u043b\u044f\u0435\u0442 \u0441\u043f\u0438\u0441\u043e\u043a \u043f\u043e\u043b\u0443\u0447\u0430\u0442\u0435\u043b\u0435\u0439 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f\n     *\n     * @param array $list\n     * @return \\messages\n     */\n    public function addRecipients($list) {\n\n        $this->recipients = array_merge($this->recipients, $list);\n\n        return $this;\n    }\n\n    /**\n     * \u041e\u0447\u0438\u0449\u0430\u0435\u0442 \u0441\u043f\u0438\u0441\u043e\u043a \u043f\u043e\u043b\u0443\u0447\u0430\u0442\u0435\u043b\u0435\u0439 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f\n     *\n     * @return \\messages\n     */\n    public function clearRecipients() {\n\n        $this->recipients = [];\n\n        return $this;\n    }\n\n    /**\n     * \u041e\u0442\u043f\u0440\u0430\u0432\u043b\u044f\u0435\u0442 \u043b\u0438\u0447\u043d\u043e\u0435 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435\n     *\n     * @param string $content\n     * @return integer | false\n     */\n    public function sendMessage($content) {\n\n        // \u0421\u043e\u0437\u0434\u0430\u0435\u043c \u043a\u043e\u043d\u0442\u0430\u043a\u0442\u044b \u043f\u043e\u043b\u0443\u0447\u0430\u0442\u0435\u043b\u044f\u043c\n        foreach ($this->recipients as $key => $contact_id) {\n\n            // \u041a\u043e\u043d\u0442\u0430\u043a\u0442 \u0441\u0430\u043c \u0441 \u0441\u043e\u0431\u043e\u0439 \u043d\u0435\u0432\u043e\u0437\u043c\u043e\u0436\u0435\u043d\n            if ($contact_id == $this->sender_id) {\n\n                unset($this->recipients[$key]);\n\n                continue;\n            }\n\n            if (!$this->model->isContactExists($contact_id, $this->sender_id)) {\n                $this->model->addContact($contact_id, $this->sender_id);\n            }\n        }\n\n        // \u0421\u043e\u0445\u0440\u0430\u043d\u044f\u0435\u043c \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435\n        $message_id = $this->model->addMessage($this->sender_id, $this->recipients, $content);\n\n        if ($message_id) {\n\n            $message_id = cmsEventsManager::hook('messages_after_send', $message_id);\n\n            // \u041e\u0431\u043d\u043e\u0432\u043b\u044f\u0435\u043c \u0434\u0430\u0442\u044b \u043f\u043e\u0441\u043b\u0435\u0434\u043d\u0438\u0445 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0439 \u0432 \u043a\u043e\u043d\u0442\u0430\u043a\u0442\u0430\u0445\n            foreach ($this->recipients as $contact_id) {\n                $this->model->updateContactsDateLastMsg($this->sender_id, $contact_id);\n            }\n\n            cmsEventsManager::hook('send_user_message', [$this->sender_id, $this->recipients, $content]);\n        }\n\n        return $message_id ? $message_id : false;\n    }\n\n    /**\n     * \u0423\u0441\u0442\u0430\u043d\u0430\u0432\u043b\u0438\u0432\u0430\u0435\u0442 \u0444\u043b\u0430\u0433 \u0438\u0433\u043d\u043e\u0440\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f \u043e\u043f\u0446\u0438\u0439 \u0443\u0432\u0435\u0434\u043e\u043c\u043b\u0435\u043d\u0438\u0439 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f\n     *\n     * @return \\messages\n     */\n    public function ignoreNotifyOptions() {\n\n        $this->is_ignore_options = true;\n\n        return $this;\n    }\n\n    /**\n     * \u041e\u0442\u043f\u0440\u0430\u0432\u043b\u044f\u0435\u0442 \u0443\u0432\u0435\u0434\u043e\u043c\u043b\u0435\u043d\u0438\u0435 \u0447\u0435\u0440\u0435\u0437 \u043b\u0438\u0447\u043d\u044b\u0435 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f\n     *\n     * @param array $notice\n     * @param string $notice_type\n     * @return int | false\n     */\n    public function sendNoticePM($notice, $notice_type = false) {\n\n        if (!$notice_type) {\n\n            $recipients = $this->recipients;\n\n        } else {\n\n            $options_only = $this->is_ignore_options ? false : ['pm', 'both'];\n\n            $recipients = $this->model_users->getNotifiedUsers($notice_type, $this->recipients, $options_only);\n\n            $this->is_ignore_options = false;\n        }\n\n        if (!$recipients) {\n            return false;\n        }\n\n        list($recipients, $notice, $notice_type) = cmsEventsManager::hook('send_user_notice_before', [$recipients, $notice, $notice_type]);\n\n        $notice_id = $this->model->addNotice($recipients, $notice);\n\n        cmsEventsManager::hook('send_user_notice', [$recipients, $notice]);\n\n        return $notice_id;\n    }\n\n    /**\n     * \u041e\u0442\u043f\u0440\u0430\u0432\u043b\u044f\u0435\u0442 email-\u0443\u0432\u0435\u0434\u043e\u043c\u043b\u0435\u043d\u0438\u044f \u0443\u043a\u0430\u0437\u0430\u043d\u043d\u043e\u0433\u043e \u0442\u0438\u043f\u0430 \u0432\u0441\u0435\u043c\n     * \u043f\u043e\u0434\u043f\u0438\u0441\u0430\u043d\u043d\u044b\u043c \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f\u043c\n     *\n     * @param string $letter_name\n     * @param string $notice \u041c\u0430\u0441\u0441\u0438\u0432 \u043a\u043b\u044e\u0447\u0435\u0439 \u0438 \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u0439 \u0434\u043b\u044f \u0437\u0430\u043c\u0435\u043d\u044b \u0432 \u0442\u0435\u043a\u0441\u0442\u0435 \u043f\u0438\u0441\u044c\u043c\u0430\n     * @param string $notice_type\n     * @return boolean\n     */\n    public function sendNoticeEmail($letter_name, $notice = [], $notice_type = false) {\n\n        if (!$this->recipients) {\n            return;\n        }\n\n        $letter_text = cmsCore::getLanguageTextFile(\"letters/{$letter_name}\");\n        if (!$letter_text) {\n            return false;\n        }\n\n        if (!$notice_type) {\n            $notice_type = $letter_name;\n        }\n\n        $options_only = $this->is_ignore_options ? false : ['email', 'both'];\n\n        $recipients = $this->model_users->getNotifiedUsers($notice_type, $this->recipients, $options_only);\n        if (!$recipients) {\n            return false;\n        }\n\n        $this->is_ignore_options = false;\n\n        $letter_text = string_replace_keys_values($letter_text, $notice);\n\n        list(\n            $recipients,\n            $letter_name,\n            $notice,\n            $notice_type,\n            $letter_text\n        ) = cmsEventsManager::hook('messages_send_notice_email', [\n            $recipients,\n            $letter_name,\n            $notice,\n            $notice_type,\n            $letter_text\n        ]);\n\n        foreach ($recipients as $recipient) {\n\n            $to = [\n                'name'  => $recipient['nickname'],\n                'email' => $recipient['email']\n            ];\n\n            $letter = [\n                'text' => string_replace_keys_values($letter_text, $recipient)\n            ];\n\n            $this->sendEmail($to, $letter);\n        }\n\n        return true;\n    }\n\n    /**\n     * \u041f\u043e\u0434\u0433\u043e\u0442\u043e\u0432\u0430\u043b\u0438\u0432\u0430\u0435\u0442 Email \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435\n     * \u0421\u0442\u0430\u0432\u0438\u0442 \u0432 \u043e\u0447\u0435\u0440\u0435\u0434\u044c \u0438\u043b\u0438 \u0441\u0440\u0430\u0437\u0443 \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u044f\u0435\u0442\n     *\n     * @param array|string $to       \u041a\u043e\u043c\u0443 \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u044f\u0442\u044c \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435\n     * @param array|string $letter   \u0422\u0435\u043a\u0441\u0442 \u043f\u0438\u0441\u044c\u043c\u0430\n     * @param array $data            \u041c\u0430\u0441\u0441\u0438\u0432 \u0434\u0430\u043d\u043d\u044b\u0445, \u043a\u043e\u0442\u043e\u0440\u044b\u043c\u0438 \u043d\u0443\u0436\u043d\u043e \u0437\u0430\u043c\u0435\u043d\u0438\u0442\u044c \u0432\u044b\u0440\u0430\u0436\u0435\u043d\u0438\u044f \u0432 \u043f\u0438\u0441\u044c\u043c\u0435\n     * @param boolean $is_nl2br_text \u0420\u0430\u0441\u0441\u0442\u0430\u0432\u043b\u044f\u0442\u044c \u043f\u0435\u0440\u0435\u043d\u043e\u0441\u044b \u0442\u0435\u0433\u0430\u043c\u0438 <br>\n     *\n     * @return boolean\n     */\n    public function sendEmail($to, $letter, $data = [], $is_nl2br_text = true) {\n\n        if (!is_array($to)) {\n            $to = ['email' => $to];\n        }\n\n        $to = array_merge([\n            'email'          => false,\n            'name'           => false,\n            'email_reply_to' => false,\n            'name_reply_to'  => false,\n            'custom_headers' => []\n        ], $to);\n\n        if (empty($to['email'])) {\n            return false;\n        }\n\n        if (is_array($letter)) {\n            if (empty($letter['text'])) {\n                $letter['text'] = cmsCore::getLanguageTextFile(\"letters/{$letter['name']}\");\n            }\n        } else {\n            $letter = ['text' => cmsCore::getLanguageTextFile(\"letters/{$letter}\")];\n        }\n\n        if (!$letter['text']) {\n            return false;\n        }\n\n        $data = array_merge([\n            'site' => $this->cms_config->sitename,\n            'ip'   => cmsUser::getIp(),\n            'date' => html_date(),\n            'time' => html_time()\n        ], $data);\n\n        list(\n            $to,\n            $letter,\n            $data,\n            $is_nl2br_text\n        ) = cmsEventsManager::hook('before_send_email_prepare', [\n            $to,\n            $letter,\n            $data,\n            $is_nl2br_text\n        ]);\n\n        $letter['text'] = string_replace_keys_values_extended($letter['text'], $data);\n\n        $before_send = cmsEventsManager::hook('before_send_email', [\n            'send_email' => true,\n            'success'    => false,\n            'to'         => $to,\n            'letter'     => $letter\n        ]);\n\n        if (!$before_send['send_email']) {\n            return $before_send['success'];\n        }\n\n        // \u0435\u0441\u043b\u0438 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0435\u043c \u043e\u0447\u0435\u0440\u0435\u0434\u044c\n        if (!empty($this->options['use_queue'])) {\n\n            cmsQueue::pushOn('email', [\n                'controller' => $this->name,\n                'hook'       => 'queue_send_email',\n                'params'     => [\n                    $to, $letter, $is_nl2br_text\n                ]\n            ]);\n\n            return true;\n        }\n\n        return $this->sendEmailRaw($to, $letter, $is_nl2br_text) === true ? true : false;\n    }\n\n    /**\n     * \u0412\u044b\u043f\u043e\u043b\u043d\u044f\u0435\u0442 \u043e\u0442\u043f\u0440\u0430\u0432\u043a\u0443 email \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f\n     *\n     * @param array|string $to       \u041a\u043e\u043c\u0443 \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u044f\u0442\u044c \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435\n     * @param array|string $letter   \u0422\u0435\u043a\u0441\u0442 \u043f\u0438\u0441\u044c\u043c\u0430\n     * @param boolean $is_nl2br_text \u0420\u0430\u0441\u0441\u0442\u0430\u0432\u043b\u044f\u0442\u044c \u043f\u0435\u0440\u0435\u043d\u043e\u0441\u044b \u0442\u0435\u0433\u0430\u043c\u0438 <br>\n     *\n     * @return boolean|string true \u0438\u043b\u0438 \u0442\u0435\u043a\u0441\u0442 \u043e\u0448\u0438\u0431\u043a\u0438\n     */\n    public function sendEmailRaw($to, $letter, $is_nl2br_text = null) {\n\n        // URL \u0434\u043b\u044f \u043e\u0442\u043f\u0438\u0441\u043a\u0438 \u043e\u0442 \u0440\u0430\u0441\u0441\u044b\u043b\u043a\u0438\n        $unsubscribe_url = $to['custom_headers']['List-Unsubscribe'] ?? $this->cms_config->host;\n\n        if(empty($to['custom_headers']['List-Unsubscribe'])){\n            $to['custom_headers']['List-Unsubscribe'] = $unsubscribe_url;\n        }\n\n        $mailer = new cmsMailer();\n\n        list($letter, $is_nl2br_text, $to) = cmsEventsManager::hook('process_email_letter', [$letter, $is_nl2br_text, $to]);\n\n        $mailer->addTo($to['email'], $to['name']);\n\n        if (!empty($to['email_reply_to'])) {\n            $mailer->setReplyTo($to['email_reply_to'], $to['name_reply_to']);\n        }\n\n        if (!empty($to['custom_headers'])) {\n            foreach ($to['custom_headers'] as $name => $value) {\n                $mailer->addCustomHeader($name, $value);\n            }\n        }\n\n        if (!empty($to['attachments'])) {\n            foreach ($to['attachments'] as $attach_name => $attach) {\n                $mailer->addAttachment($attach, (is_numeric($attach_name) ? '' : $attach_name));\n            }\n        }\n\n        $letter['text'] = $mailer->parseSubject($letter['text']);\n        $letter['text'] = $mailer->parseAttachments($letter['text']);\n\n        // \u0415\u0441\u043b\u0438 \u0435\u0441\u0442\u044c \u043e\u0431\u0449\u0438\u0439 \u0448\u0430\u0431\u043b\u043e\u043d \u043f\u0438\u0441\u0435\u043c\n        if (!empty($this->options['email_template'])) {\n\n            if($is_nl2br_text){\n\n                $letter['text'] = nl2br($letter['text']);\n\n                $is_nl2br_text = false;\n            }\n\n            $data_template = [\n                'body'            => $letter['text'],\n                'year'            => date('Y'),\n                'site'            => $this->cms_config->sitename,\n                'unsubscribe_url' => $unsubscribe_url\n            ];\n\n            $letter['text'] = string_replace_keys_values($this->options['email_template'], $data_template);\n        }\n\n        $mailer->setBodyHTML(($is_nl2br_text ? nl2br($letter['text']) : $letter['text']));\n\n        $result = $mailer->send();\n\n        $mailer->clearTo()->clearAttachments();\n\n        return $result ? true : $mailer->getErrorInfo();\n    }\n\n}\n", "/*\n\tRedactor v9.2.6\n\tUpdated: Jul 19, 2014\n\thttp://imperavi.com/redactor/\n\tCopyright (c) 2009-2014, Imperavi LLC.\n\tLicense: http://imperavi.com/redactor/license/\n\tUsage: $('#content').redactor();\n*/\n(function($)\n{\n\tvar uuid = 0;\n\n\t\"use strict\";\n\n\tvar Range = function(range)\n\t{\n\t\tthis[0] = range.startOffset;\n\t\tthis[1] = range.endOffset;\n\n\t\tthis.range = range;\n\n\t\treturn this;\n\t};\n\n\tRange.prototype.equals = function()\n\t{\n\t\treturn this[0] === this[1];\n\t};\n\n\tvar reUrlYoutube = /https?:\\/\\/(?:[0-9A-Z-]+\\.)?(?:youtu\\.be\\/|youtube\\.com\\S*[^\\w\\-\\s])([\\w\\-]{11})(?=[^\\w\\-]|$)(?![?=&+%\\w.-]*(?:['\"][^<>]*>|<\\/a>))[?=&+%\\w.-]*/ig;\n\tvar reUrlVimeo = /https?:\\/\\/(www\\.)?vimeo.com\\/(\\d+)($|\\/)/;\n    var reUrlFacebook = /^(?:(?:https|http)?:\\/\\/)?(?:www\\.)?(?:facebook\\.com(?:\\/[^\\/]+\\/videos\\/|\\/video\\.php\\?v=))([0-9]+)(?:.+)?$/;\n\tvar reUrlRutube = /^(?:(?:https|http)?:\\/\\/)?(?:www\\.)?(?:rutube\\.ru\\/video\\/)([a-z0-9]+)(?:.+)?$/;\n\n\t$.fn.redactor = function(options)\n\t{\n\t\tvar val = [];\n\t\tvar args = Array.prototype.slice.call(arguments, 1);\n\n\t\tif (typeof options === 'string')\n\t\t{\n\t\t\tthis.each(function()\n\t\t\t{\n\t\t\t\tvar instance = $.data(this, 'redactor');\n\t\t\t\tif (typeof instance !== 'undefined' && $.isFunction(instance[options]))\n\t\t\t\t{\n\t\t\t\t\tvar methodVal = instance[options].apply(instance, args);\n\t\t\t\t\tif (methodVal !== undefined && methodVal !== instance) val.push(methodVal);\n\t\t\t\t}\n\t\t\t\telse return $.error('No such method \"' + options + '\" for Redactor');\n\t\t\t});\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.each(function()\n\t\t\t{\n\t\t\t\tif (!$.data(this, 'redactor')) $.data(this, 'redactor', Redactor(this, options));\n\t\t\t});\n\t\t}\n\n\t\tif (val.length === 0) return this;\n\t\telse if (val.length === 1) return val[0];\n\t\telse return val;\n\n\t};\n\n\tfunction Redactor(el, options)\n\t{\n\t\treturn new Redactor.prototype.init(el, options);\n\t}\n\n\t$.Redactor = Redactor;\n\t$.Redactor.VERSION = '9.2.6';\n\t$.Redactor.opts = {\n\n\t\t\trangy: false,\n\n\t\t\tiframe: false,\n\t\t\tfullpage: false,\n\t\t\tcss: false,\n\n\t\t\tlang: 'en',\n\t\t\tdirection: 'ltr',\n\n\t\t\tplaceholder: false,\n\n\t\t\ttypewriter: false,\n\t\t\twym: false,\n\t\t\tmobile: true,\n\t\t\tcleanup: true,\n\t\t\ttidyHtml: true,\n\t\t\tpastePlainText: false,\n\t\t\tremoveEmptyTags: true,\n\t\t\tcleanSpaces: true,\n\t\t\tcleanFontTag: true,\n\t\t\ttemplateVars: false,\n\t\t\txhtml: false,\n\n\t\t\tvisual: true,\n\t\t\tfocus: false,\n\t\t\ttabindex: false,\n\t\t\tautoresize: true,\n\t\t\tminHeight: false,\n\t\t\tmaxHeight: false,\n\t\t\tshortcuts: {\n\t\t\t\t'ctrl+m, meta+m': \"this.execCommand('removeFormat', false)\",\n\t\t\t\t'ctrl+b, meta+b': \"this.execCommand('bold', false)\",\n\t\t\t\t'ctrl+i, meta+i': \"this.execCommand('italic', false)\",\n\t\t\t\t'ctrl+h, meta+h': \"this.execCommand('superscript', false)\",\n\t\t\t\t'ctrl+l, meta+l': \"this.execCommand('subscript', false)\",\n\t\t\t\t'ctrl+k, meta+k': \"this.linkShow()\",\n\t\t\t\t'ctrl+shift+7': \"this.execCommand('insertorderedlist', false)\",\n\t\t\t\t'ctrl+shift+8': \"this.execCommand('insertunorderedlist', false)\"\n\t\t\t},\n\t\t\tshortcutsAdd: false,\n\n\t\t\tautosave: false,\n\t\t\tautosaveInterval: 60,\n\n\t\t\tplugins: false,\n\n\t\t\tlinkProtocol: 'http://',\n\t\t\tlinkNofollow: false,\n\t\t\tlinkSize: 50,\n\t\t\tpredefinedLinks: false,\n\n\t\t\timageFloatMargin: '10px',\n\t\t\timageGetJson: false,\n\n\t\t\tdragUpload: true,\n\t\t\timageTabLink: true,\n\t\t\timageUpload: false,\n\t\t\timageUploadParam: 'file',\n\t\t\timageResizable: true,\n\n\t\t\tfileUpload: false,\n\t\t\tfileUploadParam: 'file',\n\t\t\tclipboardUpload: true,\n\t\t\tclipboardUploadUrl: false,\n\n\t\t\tsmilesUrl: '',\n\n\t\t\tdnbImageTypes: ['image/png', 'image/jpeg', 'image/gif'],\n\n\t\t\ts3: false,\n\t\t\tuploadFields: false,\n\n\t\t\tobserveImages: true,\n\t\t\tobserveLinks: true,\n\n\t\t\tmodalOverlay: true,\n\n\t\t\ttabSpaces: false,\n\t\t\ttabFocus: true,\n\n\t\t\tair: false,\n\t\t\tairButtons: ['formatting', 'bold', 'italic', 'deleted', 'unorderedlist', 'orderedlist', 'outdent', 'indent'],\n\n\t\t\ttoolbar: true,\n\t\t\ttoolbarFixed: false,\n\t\t\ttoolbarFixedTarget: document,\n\t\t\ttoolbarFixedTopOffset: 0,\n\t\t\ttoolbarFixedBox: false,\n\t\t\ttoolbarExternal: false,\n\t\t\ttoolbarOverflow: false,\n\t\t\tbuttonSource: true,\n\n\t\t\tbuttons: ['html', 'undo', 'redo', 'formatting', 'bold', 'italic', 'deleted', 'unorderedlist', 'orderedlist',\n\t\t\t\t\t  'outdent', 'indent', 'image', 'video', 'file', 'table', 'link', 'alignment', '|',\n\t\t\t\t\t  'horizontalrule'], /**'underline', 'alignleft', 'aligncenter', 'alignright', 'justify'**/\n\t\t\tbuttonsHideOnMobile: [],\n\n\t\t\tactiveButtons: ['deleted', 'italic', 'bold', 'underline', 'unorderedlist', 'orderedlist',\n\t\t\t\t\t\t\t'alignleft', 'aligncenter', 'alignright', 'justify', 'table'],\n\t\t\tactiveButtonsStates: {\n\t\t\t\tb: 'bold',\n\t\t\t\tstrong: 'bold',\n\t\t\t\ti: 'italic',\n\t\t\t\tem: 'italic',\n\t\t\t\tdel: 'deleted',\n\t\t\t\tstrike: 'deleted',\n\t\t\t\tul: 'unorderedlist',\n\t\t\t\tol: 'orderedlist',\n\t\t\t\tu: 'underline',\n\t\t\t\ttr: 'table',\n\t\t\t\ttd: 'table',\n\t\t\t\ttable: 'table'\n\t\t\t},\n\n\t\t\tformattingTags: ['p', 'blockquote', 'code', 'h2', 'h3', 'h4', 'h5', 'h6'],\n\n\t\t\tlinebreaks: false,\n\t\t\tparagraphy: true,\n\t\t\tconvertDivs: true,\n\t\t\tconvertLinks: true,\n\t\t\tconvertImageLinks: false,\n\t\t\tconvertVideoLinks: false,\n\t\t\tformattingPre: false,\n\t\t\tphpTags: false,\n\n\t\t\tallowedTags: false,\n\t\t\tdeniedTags: ['html', 'head', 'link', 'body', 'meta', 'script', 'style', 'applet'],\n\n\t\t\tboldTag: 'strong',\n\t\t\titalicTag: 'em',\n\n\t\t\tindentValue: 20,\n\t\t\tbuffer: [],\n\t\t\trebuffer: [],\n\t\t\ttextareamode: false,\n\t\t\temptyHtml: '<p>&#x200b;</p>',\n\t\t\tinvisibleSpace: '&#x200b;',\n\t\t\trBlockTest: /^(P|H[1-6]|LI|ADDRESS|SECTION|HEADER|FOOTER|ASIDE|ARTICLE)$/i,\n\t\t\talignmentTags: ['P', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'DD', 'DL', 'DT', 'DIV', 'TD',\n\t\t\t\t\t\t\t\t'BLOCKQUOTE', 'OUTPUT', 'FIGCAPTION', 'ADDRESS', 'SECTION',\n\t\t\t\t\t\t\t\t'HEADER', 'FOOTER', 'ASIDE', 'ARTICLE'],\n\t\t\townLine: ['area', 'body', 'head', 'hr', 'i?frame', 'link', 'meta', 'noscript', 'style', 'script', 'table', 'tbody', 'thead', 'tfoot'],\n\t\t\tcontOwnLine: ['li', 'dt', 'dt', 'h[1-6]', 'option', 'script'],\n\t\t\tnewLevel: ['blockquote', 'div', 'dl', 'fieldset', 'form', 'frameset', 'map', 'ol', 'p', 'code', 'select', 'td', 'th', 'tr', 'ul'],\n\t\t\tblockLevelElements: ['P', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'DD', 'DL', 'DT', 'DIV', 'LI',\n\t\t\t\t\t\t\t\t'BLOCKQUOTE', 'OUTPUT', 'FIGCAPTION', 'CODE', 'ADDRESS', 'SECTION',\n\t\t\t\t\t\t\t\t'HEADER', 'FOOTER', 'ASIDE', 'ARTICLE', 'TD'],\n\t\t\tlangs: {\n\t\t\t\ten: {\n\t\t\t\t\thtml: 'HTML',\n\t\t\t\t\tvideo: 'Insert Video',\n\t\t\t\t\timage: 'Insert Image',\n\t\t\t\t\ttable: 'Table',\n\t\t\t\t\tlink: 'Link',\n\t\t\t\t\tlink_insert: 'Insert link',\n\t\t\t\t\tlink_edit: 'Edit link',\n\t\t\t\t\tunlink: 'Unlink',\n\t\t\t\t\tformatting: 'Formatting',\n\t\t\t\t\tparagraph: 'Normal text',\n\t\t\t\t\tquote: 'Quote',\n\t\t\t\t\tcode: 'Code',\n\t\t\t\t\theader1: 'Header 1',\n\t\t\t\t\theader2: 'Header 2',\n\t\t\t\t\theader3: 'Header 3',\n\t\t\t\t\theader4: 'Header 4',\n\t\t\t\t\theader5: 'Header 5',\n\t\t\t\t\tbold: 'Bold',\n\t\t\t\t\titalic: 'Italic',\n\t\t\t\t\tfontcolor: 'Font Color',\n\t\t\t\t\tbackcolor: 'Back Color',\n\t\t\t\t\tunorderedlist: 'Unordered List',\n\t\t\t\t\torderedlist: 'Ordered List',\n\t\t\t\t\toutdent: 'Outdent',\n\t\t\t\t\tindent: 'Indent',\n\t\t\t\t\tcancel: 'Cancel',\n\t\t\t\t\tinsert: 'Insert',\n\t\t\t\t\tsave: 'Save',\n\t\t\t\t\t_delete: 'Delete',\n\t\t\t\t\tinsert_table: 'Insert Table',\n\t\t\t\t\tinsert_row_above: 'Add Row Above',\n\t\t\t\t\tinsert_row_below: 'Add Row Below',\n\t\t\t\t\tinsert_column_left: 'Add Column Left',\n\t\t\t\t\tinsert_column_right: 'Add Column Right',\n\t\t\t\t\tdelete_column: 'Delete Column',\n\t\t\t\t\tdelete_row: 'Delete Row',\n\t\t\t\t\tdelete_table: 'Delete Table',\n\t\t\t\t\trows: 'Rows',\n\t\t\t\t\tcolumns: 'Columns',\n\t\t\t\t\tadd_head: 'Add Head',\n\t\t\t\t\tdelete_head: 'Delete Head',\n\t\t\t\t\ttitle: 'Title',\n\t\t\t\t\timage_position: 'Position',\n\t\t\t\t\tnone: 'None',\n\t\t\t\t\tleft: 'Left',\n\t\t\t\t\tright: 'Right',\n\t\t\t\t\tcenter: 'Center',\n\t\t\t\t\timage_web_link: 'Image Web Link',\n\t\t\t\t\ttext: 'Text',\n\t\t\t\t\tmailto: 'Email',\n\t\t\t\t\tweb: 'URL',\n\t\t\t\t\tvideo_html_code: 'Video Embed Code',\n\t\t\t\t\tfile: 'Insert File',\n\t\t\t\t\tupload: 'Upload',\n\t\t\t\t\tdownload: 'Download',\n\t\t\t\t\tchoose: 'Choose',\n\t\t\t\t\tempty_img_list: 'You have no images',\n\t\t\t\t\tor_choose: 'Or choose',\n\t\t\t\t\tdrop_file_here: 'Drop file here',\n\t\t\t\t\talign_left: 'Align text to the left',\n\t\t\t\t\talign_center: 'Center text',\n\t\t\t\t\talign_right: 'Align text to the right',\n\t\t\t\t\talign_justify: 'Justify text',\n\t\t\t\t\thorizontalrule: 'Insert Horizontal Rule',\n                    fullscreen: 'Full screen',\n                    fontsize: 'Font size',\n                    fontfamily: 'Font',\n                    remove_font: 'Clear Font',\n                    image_save_toserver: 'Save to the server?',\n\t\t\t\t\tdeleted: 'Deleted',\n\t\t\t\t\tanchor: 'Anchor',\n\t\t\t\t\tlink_new_tab: 'Open link in new tab',\n\t\t\t\t\tunderline: 'Underline',\n\t\t\t\t\talignment: 'Alignment',\n\t\t\t\t\tfilename: 'Name (optional)',\n\t\t\t\t\tedit: 'Edit',\n                    spoiler: 'Spoiler',\n                    spoiler_name: 'Spoiler name',\n                    spoiler_text: 'Spoiler text',\n                    smiles: 'Smiles',\n                    undo: 'Undo',\n                    redo: 'Redo',\n                    formalize: 'Formalize'\n\t\t\t\t}\n\t\t\t}\n\t};\n\n\tRedactor.fn = $.Redactor.prototype = {\n\n\t\tkeyCode: {\n\t\t\tBACKSPACE: 8,\n\t\t\tDELETE: 46,\n\t\t\tDOWN: 40,\n\t\t\tENTER: 13,\n\t\t\tESC: 27,\n\t\t\tTAB: 9,\n\t\t\tCTRL: 17,\n\t\t\tMETA: 91,\n\t\t\tLEFT: 37,\n\t\t\tLEFT_WIN: 91\n\t\t},\n\n\t\tinit: function(el, options)\n\t\t{\n\t\t\tthis.rtePaste = false;\n\t\t\tthis.$element = this.$source = $(el);\n\t\t\tthis.uuid = uuid++;\n\n\t\t\tvar opts = $.extend(true, {}, $.Redactor.opts);\n\n\t\t\tthis.opts = $.extend(\n\t\t\t\t{},\n\t\t\t\topts,\n\t\t\t\tthis.$element.data(),\n\t\t\t\toptions\n\t\t\t);\n\n\t\t\tthis.start = true;\n\t\t\tthis.dropdowns = [];\n\n\t\t\tthis.sourceHeight = this.$source.css('height');\n\t\t\tthis.sourceWidth = this.$source.css('width');\n\n\t\t\tif (this.opts.fullpage) this.opts.iframe = true;\n\t\t\tif (this.opts.linebreaks) this.opts.paragraphy = false;\n\t\t\tif (this.opts.paragraphy) this.opts.linebreaks = false;\n\t\t\tif (this.opts.toolbarFixedBox) this.opts.toolbarFixed = true;\n\n\t\t\tthis.document = document;\n\t\t\tthis.window = window;\n\n\t\t\tthis.savedSel = false;\n\n\t\t\tthis.cleanlineBefore = new RegExp('^<(/?' + this.opts.ownLine.join('|/?' ) + '|' + this.opts.contOwnLine.join('|') + ')[ >]');\n\t\t\tthis.cleanlineAfter = new RegExp('^<(br|/?' + this.opts.ownLine.join('|/?' ) + '|/' + this.opts.contOwnLine.join('|/') + ')[ >]');\n\t\t\tthis.cleannewLevel = new RegExp('^</?(' + this.opts.newLevel.join('|' ) + ')[ >]');\n\n\t\t\tthis.rTestBlock = new RegExp('^(' + this.opts.blockLevelElements.join('|' ) + ')$', 'i');\n\n\t\t\tif (this.opts.linebreaks === false)\n\t\t\t{\n\t\t\t\tif (this.opts.allowedTags !== false)\n\t\t\t\t{\n\t\t\t\t\tvar arrSearch = ['strong', 'em', 'del'];\n\t\t\t\t\tvar arrAdd = ['b', 'i', 'strike'];\n\n\t\t\t\t\tif ($.inArray('p', this.opts.allowedTags) === '-1') this.opts.allowedTags.push('p');\n\n\t\t\t\t\tfor (i in arrSearch)\n\t\t\t\t\t{\n\t\t\t\t\t\tif ($.inArray(arrSearch[i], this.opts.allowedTags) != '-1') this.opts.allowedTags.push(arrAdd[i]);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (this.opts.deniedTags !== false)\n\t\t\t\t{\n\t\t\t\t\tvar pos = $.inArray('p', this.opts.deniedTags);\n\t\t\t\t\tif (pos !== '-1') this.opts.deniedTags.splice(pos, pos);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (this.browser('msie') || this.browser('opera'))\n\t\t\t{\n\t\t\t\tthis.opts.buttons = this.removeFromArrayByValue(this.opts.buttons, 'horizontalrule');\n\t\t\t}\n\n\t\t\tthis.opts.curLang = this.opts.langs[this.opts.lang];\n\n\t\t\t$.extend(this.opts.shortcuts, this.opts.shortcutsAdd);\n\n\t\t\tthis.placeholderInit();\n\n\t\t\tthis.buildStart();\n\n\t\t},\n\t\ttoolbarInit: function(lang)\n\t\t{\n\t\t\treturn {\n\t\t\t\thtml:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.html,\n\t\t\t\t\tfunc: 'toggle'\n\t\t\t\t},\n\t\t\t\tundo:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.undo,\n\t\t\t\t\tfunc: 'bufferUndo'\n\t\t\t\t},\n\t\t\t\tredo:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.redo,\n\t\t\t\t\tfunc: 'bufferRedo'\n\t\t\t\t},\n\t\t\t\tformatting:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.formatting,\n\t\t\t\t\tfunc: 'show',\n\t\t\t\t\tdropdown:\n\t\t\t\t\t{\n\t\t\t\t\t\tp:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.paragraph,\n\t\t\t\t\t\t\tfunc: 'formatBlocks'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tblockquote:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.quote,\n\t\t\t\t\t\t\tfunc: 'formatQuote',\n\t\t\t\t\t\t\tclassName: 'redactor_format_blockquote'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tcode:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.code,\n\t\t\t\t\t\t\tfunc: 'formatBlocks',\n\t\t\t\t\t\t\tclassName: 'redactor_format_code'\n\t\t\t\t\t\t},\n\t\t\t\t\t\th1:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.header1,\n\t\t\t\t\t\t\tfunc: 'formatBlocks',\n\t\t\t\t\t\t\tclassName: 'redactor_format_h1'\n\t\t\t\t\t\t},\n\t\t\t\t\t\th2:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.header2,\n\t\t\t\t\t\t\tfunc: 'formatBlocks',\n\t\t\t\t\t\t\tclassName: 'redactor_format_h2'\n\t\t\t\t\t\t},\n\t\t\t\t\t\th3:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.header3,\n\t\t\t\t\t\t\tfunc: 'formatBlocks',\n\t\t\t\t\t\t\tclassName: 'redactor_format_h3'\n\t\t\t\t\t\t},\n\t\t\t\t\t\th4:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.header4,\n\t\t\t\t\t\t\tfunc: 'formatBlocks',\n\t\t\t\t\t\t\tclassName: 'redactor_format_h4'\n\t\t\t\t\t\t},\n\t\t\t\t\t\th5:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.header5,\n\t\t\t\t\t\t\tfunc: 'formatBlocks',\n\t\t\t\t\t\t\tclassName: 'redactor_format_h5'\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tbold:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.bold,\n\t\t\t\t\texec: 'bold'\n\t\t\t\t},\n\t\t\t\titalic:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.italic,\n\t\t\t\t\texec: 'italic'\n\t\t\t\t},\n\t\t\t\tdeleted:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.deleted,\n\t\t\t\t\texec: 'strikethrough'\n\t\t\t\t},\n\t\t\t\tunderline:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.underline,\n\t\t\t\t\texec: 'underline'\n\t\t\t\t},\n\t\t\t\tunorderedlist:\n\t\t\t\t{\n\t\t\t\t\ttitle: '&bull; ' + lang.unorderedlist,\n\t\t\t\t\texec: 'insertunorderedlist'\n\t\t\t\t},\n\t\t\t\torderedlist:\n\t\t\t\t{\n\t\t\t\t\ttitle: '1. ' + lang.orderedlist,\n\t\t\t\t\texec: 'insertorderedlist'\n\t\t\t\t},\n\t\t\t\toutdent:\n\t\t\t\t{\n\t\t\t\t\ttitle: '< ' + lang.outdent,\n\t\t\t\t\tfunc: 'indentingOutdent'\n\t\t\t\t},\n\t\t\t\tindent:\n\t\t\t\t{\n\t\t\t\t\ttitle: '> ' + lang.indent,\n\t\t\t\t\tfunc: 'indentingIndent'\n\t\t\t\t},\n\t\t\t\timage:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.image,\n\t\t\t\t\tfunc: 'imageShow'\n\t\t\t\t},\n\t\t\t\tvideo:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.video,\n\t\t\t\t\tfunc: 'videoShow'\n\t\t\t\t},\n\t\t\t\tfile:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.file,\n\t\t\t\t\tfunc: 'fileShow'\n\t\t\t\t},\n\t\t\t\ttable:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.table,\n\t\t\t\t\tfunc: 'show',\n\t\t\t\t\tdropdown:\n\t\t\t\t\t{\n\t\t\t\t\t\tinsert_table:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.insert_table,\n\t\t\t\t\t\t\tfunc: 'tableShow'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tseparator_drop1:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tname: 'separator'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tinsert_row_above:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.insert_row_above,\n\t\t\t\t\t\t\tfunc: 'tableAddRowAbove'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tinsert_row_below:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.insert_row_below,\n\t\t\t\t\t\t\tfunc: 'tableAddRowBelow'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tinsert_column_left:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.insert_column_left,\n\t\t\t\t\t\t\tfunc: 'tableAddColumnLeft'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tinsert_column_right:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.insert_column_right,\n\t\t\t\t\t\t\tfunc: 'tableAddColumnRight'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tseparator_drop2:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tname: 'separator'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tadd_head:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.add_head,\n\t\t\t\t\t\t\tfunc: 'tableAddHead'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tdelete_head:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.delete_head,\n\t\t\t\t\t\t\tfunc: 'tableDeleteHead'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tseparator_drop3:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tname: 'separator'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tdelete_column:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.delete_column,\n\t\t\t\t\t\t\tfunc: 'tableDeleteColumn'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tdelete_row:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.delete_row,\n\t\t\t\t\t\t\tfunc: 'tableDeleteRow'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tdelete_table:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.delete_table,\n\t\t\t\t\t\t\tfunc: 'tableDeleteTable'\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tlink: {\n\t\t\t\t\ttitle: lang.link,\n\t\t\t\t\tfunc: 'show',\n\t\t\t\t\tdropdown:\n\t\t\t\t\t{\n\t\t\t\t\t\tlink:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.link_insert,\n\t\t\t\t\t\t\tfunc: 'linkShow'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tunlink:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.unlink,\n\t\t\t\t\t\t\texec: 'unlink'\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\talignment:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.alignment,\n\t\t\t\t\tfunc: 'show',\n\t\t\t\t\tdropdown:\n\t\t\t\t\t{\n\t\t\t\t\t\talignleft:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.align_left,\n\t\t\t\t\t\t\tfunc: 'alignmentLeft'\n\t\t\t\t\t\t},\n\t\t\t\t\t\taligncenter:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.align_center,\n\t\t\t\t\t\t\tfunc: 'alignmentCenter'\n\t\t\t\t\t\t},\n\t\t\t\t\t\talignright:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.align_right,\n\t\t\t\t\t\t\tfunc: 'alignmentRight'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tjustify:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: lang.align_justify,\n\t\t\t\t\t\t\tfunc: 'alignmentJustify'\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\talignleft:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.align_left,\n\t\t\t\t\tfunc: 'alignmentLeft'\n\t\t\t\t},\n\t\t\t\taligncenter:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.align_center,\n\t\t\t\t\tfunc: 'alignmentCenter'\n\t\t\t\t},\n\t\t\t\talignright:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.align_right,\n\t\t\t\t\tfunc: 'alignmentRight'\n\t\t\t\t},\n\t\t\t\talignjustify:\n\t\t\t\t{\n\t\t\t\t\ttitle: lang.align_justify,\n\t\t\t\t\tfunc: 'alignmentJustify'\n\t\t\t\t},\n\t\t\t\thorizontalrule:\n\t\t\t\t{\n\t\t\t\t\texec: 'inserthorizontalrule',\n\t\t\t\t\ttitle: lang.horizontalrule\n\t\t\t\t}\n\n\t\t\t}\n\t\t},\n\n\t\tcallback: function(type, event, data)\n\t\t{\n\t\t\tvar callback = this.opts[ type + 'Callback' ];\n\t\t\tif ($.isFunction(callback))\n\t\t\t{\n\t\t\t\tif (event === false) return callback.call(this, data);\n\t\t\t\telse return callback.call(this, event, data);\n\t\t\t}\n\t\t\telse return data;\n\t\t},\n\n\t\tdestroy: function()\n\t\t{\n\t\t\tclearInterval(this.autosaveInterval);\n\n\t\t\t$(window).off('.redactor');\n\t\t\tthis.$source.off('redactor-textarea');\n\t\t\tthis.$element.off('.redactor').removeData('redactor');\n\n\t\t\tvar html = this.get();\n\n\t\t\tif (this.opts.textareamode)\n\t\t\t{\n\t\t\t\tthis.$box.after(this.$source);\n\t\t\t\tthis.$box.remove();\n\t\t\t\tthis.$source.val(html).show();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tvar $elem = this.$editor;\n\t\t\t\tif (this.opts.iframe) $elem = this.$element;\n\n\t\t\t\tthis.$box.after($elem);\n\t\t\t\tthis.$box.remove();\n\n\t\t\t\t$elem.removeClass('redactor_editor').removeClass('redactor_editor_wym').removeAttr('contenteditable').html(html).show();\n\t\t\t}\n\n\t\t\tif (this.opts.toolbarExternal)\n\t\t\t{\n\t\t\t\t$(this.opts.toolbarExternal).html('');\n\t\t\t}\n\n\t\t\tif (this.opts.air)\n\t\t\t{\n\t\t\t\t$('#redactor_air_' + this.uuid).remove();\n\t\t\t}\n\t\t},\n\n\t\tgetObject: function()\n\t\t{\n\t\t\treturn $.extend({}, this);\n\t\t},\n\t\tgetEditor: function()\n\t\t{\n\t\t\treturn this.$editor;\n\t\t},\n\t\tgetBox: function()\n\t\t{\n\t\t\treturn this.$box;\n\t\t},\n\t\tgetIframe: function()\n\t\t{\n\t\t\treturn (this.opts.iframe) ? this.$frame : false;\n\t\t},\n\t\tgetToolbar: function()\n\t\t{\n\t\t\treturn (this.$toolbar) ? this.$toolbar : false;\n\t\t},\n\n\t\tget: function()\n\t\t{\n\t\t\treturn this.$source.val();\n\t\t},\n\t\tgetCodeIframe: function()\n\t\t{\n\t\t\tthis.$editor.removeAttr('contenteditable').removeAttr('dir');\n\t\t\tvar html = this.outerHtml(this.$frame.contents().children());\n\t\t\tthis.$editor.attr({ 'contenteditable': true, 'dir': this.opts.direction });\n\n\t\t\treturn html;\n\t\t},\n\t\tset: function(html, strip, placeholderRemove)\n\t\t{\n\t\t\thtml = html.toString();\n\t\t\thtml = html.replace(/\\$/g, '&#36;');\n\n\t\t\tif (this.opts.fullpage) this.setCodeIframe(html);\n\t\t\telse this.setEditor(html, strip);\n\n\t\t\tif (html == '') placeholderRemove = false;\n\t\t\tif (placeholderRemove !== false) this.placeholderRemoveFromEditor();\n\t\t},\n\t\tsetEditor: function(html, strip)\n\t\t{\n\n            html = this.sanitizeHTML(html);\n\n\t\t\tif (strip !== false)\n\t\t\t{\n\t\t\t\thtml = this.cleanSavePreCode(html);\n\n\t\t\t\thtml = this.cleanStripTags(html);\n\t\t\t\thtml = this.cleanConvertProtected(html);\n\t\t\t\thtml = this.cleanConvertInlineTags(html, true);\n\n\t\t\t\tif (this.opts.linebreaks === false)\thtml = this.cleanConverters(html);\n\t\t\t\telse html = html.replace(/<p(.*?)>([\\w\\W]*?)<\\/p>/gi, '$2<br>');\n\t\t\t}\n\n\t\t\thtml = html.replace(/&amp;#36;/g, '$');\n            html = this.cleanEmpty(html);\n\n\t\t\tthis.$editor.html(html);\n\n\t\t\tthis.setNonEditable();\n\t\t\tthis.setSpansVerified();\n\n\t\t\tthis.sync();\n\t\t},\n        sanitizeHTML:  function(htmlStr)\n\t\t{\n            if(htmlStr.length === 0){\n                return htmlStr;\n            }\n            function stringToHTML () {\n                let parser = new DOMParser();\n                let doc = parser.parseFromString(htmlStr, 'text/html');\n                return doc.body;\n            }\n            function clean (html) {\n                let nodes = html.children;\n                for (let node of nodes) {\n                    removeAttributes(node);\n                    clean(node);\n                }\n            }\n            function removeAttributes (elem) {\n                let atts = elem.attributes;\n                for (let {name, value} of atts) {\n                    if (!isPossiblyDangerous(name, value)) { continue };\n                    elem.removeAttribute(name);\n                }\n\n            }\n            function isPossiblyDangerous (name, value) {\n                let val = value.replace(/\\s+/g, '').toLowerCase();\n                if (['src', 'href', 'xlink:href'].includes(name)) {\n                    if (val.includes('javascript:') || val.includes('data:text/html')) { return true; }\n                }\n                if (name.startsWith('on')) { return true; }\n            }\n            let html = stringToHTML();\n\n            clean(html);\n\n            return html.innerHTML;\n        },\n\t\tsetCodeIframe: function(html)\n\t\t{\n\t\t\tvar doc = this.iframePage();\n\t\t\tthis.$frame[0].src = \"about:blank\";\n\n\t\t\thtml = this.cleanConvertProtected(html);\n\t\t\thtml = this.cleanConvertInlineTags(html);\n\t\t\thtml = this.cleanRemoveSpaces(html);\n\n\t\t\tdoc.open();\n\t\t\tdoc.write(html);\n\t\t\tdoc.close();\n\n\t\t\tif (this.opts.fullpage)\n\t\t\t{\n\t\t\t\tthis.$editor = this.$frame.contents().find('body').attr({ 'contenteditable': true, 'dir': this.opts.direction });\n\t\t\t}\n\n\t\t\tthis.setNonEditable();\n\t\t\tthis.setSpansVerified();\n\t\t\tthis.sync();\n\n\t\t},\n\t\tsetFullpageOnInit: function(html)\n\t\t{\n            html = this.sanitizeHTML(html);\n\t\t\tthis.fullpageDoctype = html.match(/^<\\!doctype[^>]*>/i);\n\t\t\tif (this.fullpageDoctype && this.fullpageDoctype.length == 1)\n\t\t\t{\n\t\t\t\thtml = html.replace(/^<\\!doctype[^>]*>/i, '');\n\t\t\t}\n\n\t\t\thtml = this.cleanSavePreCode(html, true);\n\t\t\thtml = this.cleanConverters(html);\n\t\t\thtml = this.cleanEmpty(html);\n\n\t\t\tthis.$editor.html(html);\n\n\t\t\tthis.setNonEditable();\n\t\t\tthis.setSpansVerified();\n\t\t\tthis.sync();\n\t\t},\n\t\tsetFullpageDoctype: function()\n\t\t{\n\t\t\tif (this.fullpageDoctype && this.fullpageDoctype.length == 1)\n\t\t\t{\n\t\t\t\tvar source = this.fullpageDoctype[0] + '\\n' + this.$source.val();\n\t\t\t\tthis.$source.val(source);\n\t\t\t}\n\t\t},\n\t\tsetSpansVerified: function()\n\t\t{\n\t\t\tvar spans = this.$editor.find('span');\n\t\t\tvar replacementTag = 'inline';\n\n\t\t\t$.each(spans, function() {\n\t\t\t\tvar outer = this.outerHTML;\n\n\t\t\t\tvar regex = new RegExp('<' + this.tagName, 'gi');\n\t\t\t\tvar newTag = outer.replace(regex, '<' + replacementTag);\n\n\t\t\t\tregex = new RegExp('</' + this.tagName, 'gi');\n\t\t\t\tnewTag = newTag.replace(regex, '</' + replacementTag);\n\n\t\t\t\t$(this).replaceWith(newTag);\n\t\t\t});\n\n\t\t},\n\t\tsetSpansVerifiedHtml: function(html)\n\t\t{\n\t\t\thtml = html.replace(/<span(.*?)>/, '<inline$1>');\n\t\t\treturn html.replace(/<\\/span>/, '</inline>');\n\t\t},\n\t\tsetNonEditable: function()\n\t\t{\n\t\t\tthis.$editor.find('.noneditable').attr('contenteditable', false);\n\t\t},\n\n\t\tsync: function(e)\n\t\t{\n\t\t\tvar html = '';\n\n\t\t\tthis.cleanUnverified();\n\n\t\t\tif (this.opts.fullpage) html = this.getCodeIframe();\n\t\t\telse html = this.$editor.html();\n\n\t\t\thtml = this.syncClean(html);\n\t\t\thtml = this.cleanRemoveEmptyTags(html);\n\n\t\t\tvar source = this.cleanRemoveSpaces(this.$source.val(), false);\n\t\t\tvar editor = this.cleanRemoveSpaces(html, false);\n\n\t\t\tif (source == editor)\n\t\t\t{\n\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\thtml = html.replace(/<\\/li><(ul|ol)>([\\w\\W]*?)<\\/(ul|ol)>/gi, '<$1>$2</$1></li>');\n\n\t\t\tif ($.trim(html) === '<br>') html = '';\n\t\t\tif (this.opts.xhtml)\n\t\t\t{\n\t\t\t\tvar xhtmlTags = ['br', 'hr', 'img', 'link', 'input', 'meta'];\n\t\t\t\t$.each(xhtmlTags, function(i,s)\n\t\t\t\t{\n\t\t\t\t\thtml = html.replace(new RegExp('<' + s + '(.*?[^\\/$]?)>', 'gi'), '<' + s + '$1 />');\n\t\t\t\t});\n\n\t\t\t}\n\t\t\thtml = this.callback('syncBefore', false, html);\n\n\t\t\tthis.$source.val(html);\n\t\t\tthis.setFullpageDoctype();\n\t\t\tthis.callback('syncAfter', false, html);\n\n\t\t\tif (this.start === false)\n\t\t\t{\n\n\t\t\t\tif (typeof e != 'undefined')\n\t\t\t\t{\n\t\t\t\t\tswitch(e.which)\n\t\t\t\t\t{\n\t\t\t\t        case 37:\n\t\t\t\t        break;\n\t\t\t\t        case 38:\n\t\t\t\t        break;\n\t\t\t\t        case 39:\n\t\t\t\t        break;\n\t\t\t\t        case 40:\n\t\t\t\t        break;\n\n\t\t\t\t\t\tdefault: this.callback('change', false, html);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.callback('change', false, html);\n\t\t\t\t}\n\t\t\t}\n\n\t\t},\n\t\tsyncClean: function(html)\n\t\t{\n\t\t\tif (!this.opts.fullpage) html = this.cleanStripTags(html);\n\t\t\thtml = $.trim(html);\n\t\t\thtml = this.placeholderRemoveFromCode(html);\n\t\t\thtml = html.replace(/&#x200b;/gi, '');\n\t\t\thtml = html.replace(/&#8203;/gi, '');\n\t\t\thtml = html.replace(/<\\/a>&nbsp;/gi, '<\\/a> ');\n\t\t\thtml = html.replace(/\\u200B/g, '');\n\n\t\t\tif (html == '<p></p>' || html == '<p> </p>' || html == '<p>&nbsp;</p>')\n\t\t\t{\n\t\t\t\thtml = '';\n\t\t\t}\n\t\t\tif (this.opts.linkNofollow)\n\t\t\t{\n\t\t\t\thtml = html.replace(/<a(.*?)rel=\"nofollow\"(.*?)>/gi, '<a$1$2>');\n\t\t\t\thtml = html.replace(/<a(.*?)>/gi, '<a$1 rel=\"nofollow\">');\n\t\t\t}\n\t\t\thtml = html.replace('<!--?php', '<?php');\n\t\t\thtml = html.replace('?-->', '?>');\n\t\t\thtml = html.replace(/<(.*?)class=\"noeditable\"(.*?) contenteditable=\"false\"(.*?)>/gi, '<$1class=\"noeditable\"$2$3>');\n\n\t\t\thtml = html.replace(/ data-tagblock=\"\"/gi, '');\n\t\t\thtml = html.replace(/<br\\s?\\/?>\\n?<\\/(P|H[1-6]|LI|ADDRESS|SECTION|HEADER|FOOTER|ASIDE|ARTICLE)>/gi, '</$1>');\n\t\t\thtml = html.replace(/<span(.*?)id=\"redactor-image-box\"(.*?)>([\\w\\W]*?)<img(.*?)><\\/span>/gi, '$3<img$4>');\n\t\t\thtml = html.replace(/<span(.*?)id=\"redactor-image-resizer\"(.*?)>(.*?)<\\/span>/gi, '');\n\t\t\thtml = html.replace(/<span(.*?)id=\"redactor-image-editter\"(.*?)>(.*?)<\\/span>/gi, '');\n\t\t\thtml = html.replace(/<(ul|ol)>\\s*\\t*\\n*<\\/(ul|ol)>/gi, '');\n\t\t\tif (this.opts.cleanFontTag)\n\t\t\t{\n\t\t\t\thtml = html.replace(/<font(.*?)>([\\w\\W]*?)<\\/font>/gi, '$2');\n\t\t\t}\n\t\t\thtml = html.replace(/<span(.*?)>([\\w\\W]*?)<\\/span>/gi, '$2');\n\t\t\thtml = html.replace(/<inline>([\\w\\W]*?)<\\/inline>/gi, '$1');\n\t\t\thtml = html.replace(/<inline>/gi, '<span>');\n\t\t\thtml = html.replace(/<inline /gi, '<span ');\n\t\t\thtml = html.replace(/<\\/inline>/gi, '</span>');\n\n\t\t\tif (this.opts.removeEmptyTags)\n\t\t\t{\n\t\t\t\thtml = html.replace(/<span>([\\w\\W]*?)<\\/span>/gi, '$1');\n\t\t\t}\n\n\t\t\thtml = html.replace(/<span(.*?)class=\"redactor_placeholder\"(.*?)>([\\w\\W]*?)<\\/span>/gi, '');\n\t\t\thtml = html.replace(/<img(.*?)contenteditable=\"false\"(.*?)>/gi, '<img$1$2>');\n\t\t\thtml = html.replace(/&/gi, '&');\n\t\t\thtml = html.replace(/\\u2122/gi, '&trade;');\n\t\t\thtml = html.replace(/\\u00a9/gi, '&copy;');\n\t\t\thtml = html.replace(/\\u2026/gi, '&hellip;');\n\t\t\thtml = html.replace(/\\u2014/gi, '&mdash;');\n\t\t\thtml = html.replace(/\\u2010/gi, '&dash;');\n\n\t\t\thtml = this.cleanReConvertProtected(html);\n\n\t\t\treturn html;\n\t\t},\n\n\t\tbuildStart: function()\n\t\t{\n\n\t\t\tthis.content = '';\n\t\t\tthis.$box = $('<div class=\"redactor_box\" />');\n\t\t\tif (this.$source[0].tagName === 'TEXTAREA') this.opts.textareamode = true;\n\t\t\tif (this.opts.mobile === false && this.isMobile())\n\t\t\t{\n\t\t\t\tthis.buildMobile();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\n\t\t\t\tthis.buildContent();\n\n\t\t\t\tif (this.opts.iframe)\n\t\t\t\t{\n\n\t\t\t\t\tthis.opts.autoresize = false;\n\t\t\t\t\tthis.iframeStart();\n\t\t\t\t}\n\t\t\t\telse if (this.opts.textareamode) this.buildFromTextarea();\n\t\t\t\telse this.buildFromElement();\n\t\t\t\tif (!this.opts.iframe)\n\t\t\t\t{\n\t\t\t\t\tthis.buildOptions();\n\t\t\t\t\tthis.buildAfter();\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\tbuildMobile: function()\n\t\t{\n\t\t\tif (!this.opts.textareamode)\n\t\t\t{\n\t\t\t\tthis.$editor = this.$source;\n\t\t\t\tthis.$editor.hide();\n\t\t\t\tthis.$source = this.buildCodearea(this.$editor);\n\t\t\t\tthis.$source.val(this.content);\n\t\t\t}\n\n\t\t\tthis.$box.insertAfter(this.$source).append(this.$source);\n\t\t},\n\t\tbuildContent: function()\n\t\t{\n\t\t\tif (this.opts.textareamode) this.content = $.trim(this.$source.val());\n\t\t\telse this.content = $.trim(this.$source.html());\n\t\t},\n\t\tbuildFromTextarea: function()\n\t\t{\n\t\t\tthis.$editor = $('<div />');\n\t\t\tthis.$box.insertAfter(this.$source).append(this.$editor).append(this.$source);\n\t\t\tthis.buildAddClasses(this.$editor);\n\t\t\tthis.buildEnable();\n\t\t},\n\t\tbuildFromElement: function()\n\t\t{\n\t\t\tthis.$editor = this.$source;\n\t\t\tthis.$source = this.buildCodearea(this.$editor);\n\t\t\tthis.$box.insertAfter(this.$editor).append(this.$editor).append(this.$source);\n\t\t\tthis.buildEnable();\n\t\t},\n\t\tbuildCodearea: function($source)\n\t\t{\n\t\t\treturn $('<textarea />').attr('name', $source.attr('id')).css('height', this.sourceHeight);\n\t\t},\n\t\tbuildAddClasses: function(el)\n\t\t{\n\n\t\t\t$.each(this.$source.get(0).className.split(/\\s+/), function(i,s)\n\t\t\t{\n\t\t\t\tel.addClass('redactor_' + s);\n\t\t\t});\n\t\t},\n\t\tbuildEnable: function()\n\t\t{\n\t\t\tthis.$editor.addClass('redactor_editor').attr({ 'contenteditable': true, 'dir': this.opts.direction });\n\t\t\tthis.$source.attr('dir', this.opts.direction).hide();\n\t\t\tthis.set(this.content, true, false);\n\t\t},\n\t\tbuildOptions: function()\n\t\t{\n\t\t\tvar $source = this.$editor;\n\t\t\tif (this.opts.iframe) $source = this.$frame;\n\t\t\tif (this.opts.tabindex) $source.attr('tabindex', this.opts.tabindex);\n\n\t\t\tif (this.opts.minHeight) $source.css('min-height', this.opts.minHeight + 'px');\n\n\t\t\telse if (this.browser('mozilla') && this.opts.linebreaks)\n\t\t\t{\n\t\t\t\tthis.$editor.css('min-height', '45px');\n\t\t\t}\n\n\t\t\tif (this.browser('mozilla') && this.opts.linebreaks)\n\t\t\t{\n\t\t\t\tthis.$editor.css('padding-bottom', '10px');\n\t\t\t}\n\t\t\tif (this.opts.maxHeight)\n\t\t\t{\n\t\t\t\tthis.opts.autoresize = false;\n\t\t\t\tthis.sourceHeight = this.opts.maxHeight;\n\t\t\t}\n\t\t\tif (this.opts.wym) this.$editor.addClass('redactor_editor_wym');\n\t\t\tif (this.opts.typewriter) this.$editor.addClass('redactor-editor-typewriter');\n\t\t\tif (!this.opts.autoresize) $source.css('height', this.sourceHeight);\n\n\t\t},\n\t\tbuildAfter: function()\n\t\t{\n\t\t\tthis.start = false;\n\t\t\tif (this.opts.toolbar)\n\t\t\t{\n\t\t\t\tthis.opts.toolbar = this.toolbarInit(this.opts.curLang);\n\t\t\t\tthis.toolbarBuild();\n\t\t\t}\n\t\t\tthis.modalTemplatesInit();\n\t\t\tthis.buildPlugins();\n\t\t\tthis.buildBindKeyboard();\n\t\t\tif (this.opts.autosave) this.autosave();\n\t\t\tsetTimeout($.proxy(this.observeStart, this), 4);\n\t\t\tif (this.browser('mozilla'))\n\t\t\t{\n\t\t\t\ttry {\n\t\t\t\t\tthis.document.execCommand('enableObjectResizing', false, false);\n\t\t\t\t\tthis.document.execCommand('enableInlineTableEditing', false, false);\n\t\t\t\t} catch (e) {}\n\t\t\t}\n\t\t\tif (this.opts.focus) setTimeout($.proxy(this.focus, this), 100);\n\t\t\tif (!this.opts.visual)\n\t\t\t{\n\t\t\t\tsetTimeout($.proxy(function()\n\t\t\t\t{\n\t\t\t\t\tthis.opts.visual = true;\n\t\t\t\t\tthis.toggle(false);\n\n\t\t\t\t}, this), 200);\n\t\t\t}\n\t\t\tthis.callback('init');\n\t\t},\n\t\tbuildBindKeyboard: function()\n\t\t{\n\t\t\tthis.dblEnter = 0;\n\n\t\t\tif (this.opts.dragUpload && (this.opts.imageUpload !== false || this.opts.s3 !== false))\n\t\t\t{\n\t\t\t\tthis.$editor.on('drop.redactor', $.proxy(this.buildEventDrop, this));\n\t\t\t}\n\n\t\t\tthis.$editor.on('click.redactor', $.proxy(function()\n\t\t\t{\n\t\t\t\tthis.selectall = false;\n\n\t\t\t}, this));\n\n\t\t\tthis.$editor.on('input.redactor', $.proxy(this.sync, this));\n\t\t\tthis.$editor.on('paste.redactor', $.proxy(this.buildEventPaste, this));\n\t\t\tthis.$editor.on('keydown.redactor', $.proxy(this.buildEventKeydown, this));\n\t\t\tthis.$editor.on('keyup.redactor', $.proxy(this.buildEventKeyup, this));\n\t\t\tif ($.isFunction(this.opts.textareaKeydownCallback))\n\t\t\t{\n\t\t\t\tthis.$source.on('keydown.redactor-textarea', $.proxy(this.opts.textareaKeydownCallback, this));\n\t\t\t}\n\t\t\tif ($.isFunction(this.opts.focusCallback))\n\t\t\t{\n\t\t\t\tthis.$editor.on('focus.redactor', $.proxy(this.opts.focusCallback, this));\n\t\t\t}\n\n\t\t\tvar clickedElement;\n\t\t\t$(document).mousedown(function(e) {\n\t\t\t\tclickedElement = $(e.target);\n\t\t\t});\n\t\t\tthis.$editor.on('blur.redactor', $.proxy(function(e)\n\t\t\t{\n\t\t\t\tif (!$(clickedElement).hasClass('redactor_toolbar') && $(clickedElement).parents('.redactor_toolbar').length == 0)\n\t\t\t\t{\n\t\t\t\t\tthis.selectall = false;\n\t\t\t\t\tif ($.isFunction(this.opts.blurCallback)) this.callback('blur', e);\n\t\t\t\t}\n\t\t\t}, this));\n\n\t\t},\n\t\tbuildEventDrop: function(e)\n\t\t{\n\t\t\te = e.originalEvent || e;\n\n\t\t\tif (window.FormData === undefined || !e.dataTransfer) return true;\n\n\t\t    var length = e.dataTransfer.files.length;\n\t\t    if (length == 0) return true;\n\n\t\t    e.preventDefault();\n\n\t        var file = e.dataTransfer.files[0];\n\n\t        if (this.opts.dnbImageTypes !== false && this.opts.dnbImageTypes.indexOf(file.type) == -1)\n\t        {\n\t\t        return true;\n\t        }\n\n\t\t\tthis.bufferSet();\n\n\t\t\tthis.showProgressBar();\n\n\t\t\tif (this.opts.s3 === false)\n\t\t\t{\n\t\t\t\tthis.dragUploadAjax(this.opts.imageUpload, file, true, e, this.opts.imageUploadParam);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.s3uploadFile(file);\n\t\t\t}\n\t\t},\n\t\tbuildEventPaste: function(e)\n\t\t{\n\t\t\tvar oldsafari = false;\n\t\t\tif (this.browser('webkit') && navigator.userAgent.indexOf('Chrome') === -1)\n\t\t\t{\n\t\t\t\tvar arr = this.browser('version').split('.');\n\t\t\t\tif (arr[0] < 536) oldsafari = true;\n\t\t\t}\n\n\t\t\tif (oldsafari) return true;\n\t\t\tif (this.browser('opera')) return true;\n\t\t\tif (this.opts.clipboardUpload && this.buildEventClipboardUpload(e)) return true;\n\n\t\t\tif (this.opts.cleanup)\n\t\t\t{\n\t\t\t\tthis.rtePaste = true;\n\n\t\t\t\tthis.selectionSave();\n\n\t\t\t\tif (!this.selectall)\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.autoresize === true && this.fullscreen !== true)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.$editor.height(this.$editor.height());\n\t\t\t\t\t\tthis.saveScroll = this.document.body.scrollTop;\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.saveScroll = this.$editor.scrollTop();\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tvar frag = this.extractContent();\n\n\t\t\t\tsetTimeout($.proxy(function()\n\t\t\t\t{\n\t\t\t\t\tvar pastedFrag = this.extractContent();\n\t\t\t\t\tthis.$editor.append(frag);\n\n\t\t\t\t\tthis.selectionRestore();\n\n\t\t\t\t\tvar html = this.getFragmentHtml(pastedFrag);\n\t\t\t\t\tthis.pasteClean(html);\n\n\t\t\t\t\tif (this.opts.autoresize === true && this.fullscreen !== true) this.$editor.css('height', 'auto');\n\n\t\t\t\t}, this), 1);\n\t\t\t}\n\t\t},\n\t\tbuildEventClipboardUpload: function(e)\n\t\t{\n\t\t\tvar event = e.originalEvent || e;\n\t\t\tthis.clipboardFilePaste = false;\n\t\t\tif (typeof(event.clipboardData) === 'undefined') { return false; }\n            var clipboard = event.clipboardData;\n\t\t\tif (clipboard.items)\n\t\t\t{\n\t\t\t\tvar file = event.clipboardData.items[0].getAsFile();\n\t\t\t\tif (file !== null)\n\t\t\t\t{\n\t\t\t\t\tthis.bufferSet();\n\t\t\t\t\tthis.clipboardFilePaste = true;\n\n\t\t\t\t\tvar reader = new FileReader();\n\t\t\t\t\treader.onload = $.proxy(this.pasteClipboardUpload, this);\n\t\t\t        reader.readAsDataURL(file);\n\n\t\t\t        return true;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn false;\n\n\t\t},\n\t\tbuildEventKeydown: function(e)\n\t\t{\n\t\t\tif (this.rtePaste) return false;\n\n\t\t\tvar key = e.which;\n\t\t\tvar ctrl = e.ctrlKey || e.metaKey;\n\t\t\tvar parent = this.getParent();\n\t\t\tvar current = this.getCurrent();\n\t\t\tvar block = this.getBlock();\n\t\t\tvar pre = false;\n\n\t\t\tthis.callback('keydown', e);\n\n\t\t\t/*\n\t\t\t\tfirefox cmd+left/Cmd+right browser back/forward fix -\n\t\t\t\thttp://joshrhoderick.wordpress.com/2010/05/05/how-firefoxs-command-key-bug-kills-usability-on-the-mac/\n\t\t\t*/\n\t\t\tif (this.browser('mozilla') && \"modify\" in window.getSelection())\n\t\t\t{\n\t\t\t\tif ((ctrl) && (e.keyCode===37 || e.keyCode===39))\n\t\t\t\t{\n\t\t\t\t\tvar selection = this.getSelection();\n\t\t\t\t\tvar lineOrWord = (e.metaKey ? \"line\" : \"word\");\n\t\t\t\t\tif (e.keyCode===37)\n\t\t\t\t\t{\n\t\t\t\t\t\tselection.modify(\"extend\",\"left\",lineOrWord);\n\t\t\t\t\t\tif (!e.shiftKey)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tselection.collapseToStart();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (e.keyCode===39)\n\t\t\t\t\t{\n\t\t\t\t\t\tselection.modify(\"extend\",\"right\",lineOrWord);\n\t\t\t\t\t\tif (!e.shiftKey)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tselection.collapseToEnd();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\te.preventDefault();\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis.imageResizeHide(false);\n\t\t\tif ((parent && $(parent).get(0).tagName === 'CODE') || (current && $(current).get(0).tagName === 'CODE'))\n\t\t\t{\n\t\t\t\tpre = true;\n\t\t\t\tif (key === this.keyCode.DOWN) this.insertAfterLastElement(block);\n\t\t\t}\n\t\t\tif (key === this.keyCode.DOWN)\n\t\t\t{\n\t\t\t\tif (parent && $(parent)[0].tagName === 'BLOCKQUOTE') this.insertAfterLastElement(parent);\n\t\t\t\tif (current && $(current)[0].tagName === 'BLOCKQUOTE') this.insertAfterLastElement(current);\n\n\t\t\t\tif (parent && $(parent)[0].tagName === 'P' && $(parent).parent()[0].tagName == 'BLOCKQUOTE')\n\t\t\t\t{\n\t\t\t\t\tthis.insertAfterLastElement(parent, $(parent).parent()[0]);\n\t\t\t\t}\n\t\t\t\tif (current && $(current)[0].tagName === 'P' && parent && $(parent)[0].tagName == 'BLOCKQUOTE')\n\t\t\t\t{\n\t\t\t\t\tthis.insertAfterLastElement(current, parent);\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis.shortcuts(e, key);\n\t\t\tif (ctrl && key === 90 && !e.shiftKey && !e.altKey)\n\t\t\t{\n\t\t\t\te.preventDefault();\n\t\t\t\tif (this.opts.buffer.length) this.bufferUndo();\n\t\t\t\telse this.document.execCommand('undo', false, false);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\telse if (ctrl && key === 90 && e.shiftKey && !e.altKey)\n\t\t\t{\n\t\t\t\te.preventDefault();\n\t\t\t\tif (this.opts.rebuffer.length != 0) this.bufferRedo();\n\t\t\t\telse this.document.execCommand('redo', false, false);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (key == 32)\n\t\t\t{\n\t\t\t\tthis.bufferSet();\n\t\t\t}\n\t\t\tif (ctrl && key === 65)\n\t\t\t{\n\t\t\t\tthis.bufferSet();\n\t\t\t\tthis.selectall = true;\n\t\t\t}\n\t\t\telse if (key != this.keyCode.LEFT_WIN && !ctrl)\n\t\t\t{\n\t\t\t\tthis.selectall = false;\n\t\t\t}\n\t\t\tif (key == this.keyCode.ENTER && !e.shiftKey && !e.ctrlKey && !e.metaKey)\n\t\t\t{\n\n\t\t\t\tvar range = this.getRange();\n\t\t\t\tif (range && range.collapsed === false)\n\t\t\t\t{\n\t\t\t\t\tsel = this.getSelection();\n\t\t\t\t\tif (sel.rangeCount)\n\t\t\t\t\t{\n\t\t\t\t\t\trange.deleteContents();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (this.browser('msie') && (parent.nodeType == 1 && (parent.tagName == 'TD' || parent.tagName == 'TH')))\n\t\t\t\t{\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\tthis.bufferSet();\n\t\t\t\t\tthis.insertNode(document.createElement('br'));\n\t\t\t\t\tthis.callback('enter', e);\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t\tif (block && (block.tagName == 'BLOCKQUOTE' || $(block).parent()[0].tagName == 'BLOCKQUOTE'))\n\t\t\t\t{\n\t\t\t\t\tif (this.isEndOfElement())\n\t\t\t\t\t{\n\t\t\t\t\t\tif (this.dblEnter == 1)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar element;\n\t\t\t\t\t\t\tvar last;\n\t\t\t\t\t\t\tif (block.tagName == 'BLOCKQUOTE')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tlast = 'br';\n\t\t\t\t\t\t\t\telement = block;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tlast = 'p';\n\t\t\t\t\t\t\t\telement = $(block).parent()[0];\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t\tthis.insertingAfterLastElement(element);\n\t\t\t\t\t\t\tthis.dblEnter = 0;\n\n\t\t\t\t\t\t\tif (last == 'p')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$(block).parent().find('p').last().remove();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tvar tmp = $.trim($(block).html());\n\t\t\t\t\t\t\t\t$(block).html(tmp.replace(/<br\\s?\\/?>$/i, ''));\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse this.dblEnter++;\n\t\t\t\t\t}\n\t\t\t\t\telse this.dblEnter++;\n\t\t\t\t}\n\t\t\t\tif (pre === true)\n\t\t\t\t{\n\t\t\t\t\treturn this.buildEventKeydownPre(e, current);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tif (!this.opts.linebreaks)\n\t\t\t\t\t{\n\n\t\t\t\t\t\tif (block && block.tagName == 'LI')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar listCurrent = this.getBlock();\n\t\t\t\t\t\t\tif (listCurrent !== false || listCurrent.tagName === 'LI')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tvar listText = $.trim($(block).text());\n\t\t\t\t\t\t\t\tvar listCurrentText = $.trim($(listCurrent).text());\n\t\t\t\t\t\t\t\tif (listText == ''\n\t\t\t\t\t\t\t\t\t&& listCurrentText == ''\n\t\t\t\t\t\t\t\t\t&& $(listCurrent).next('li').length == 0\n\t\t\t\t\t\t\t\t\t&& $(listCurrent).parents('li').length == 0)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tthis.bufferSet();\n\n\t\t\t\t\t\t\t\t\tvar $list = $(listCurrent).closest('ol, ul');\n\t\t\t\t\t\t\t\t\t$(listCurrent).remove();\n\t\t\t\t\t\t\t\t\tvar node = $('<p>' + this.opts.invisibleSpace + '</p>');\n\t\t\t\t\t\t\t\t\t$list.after(node);\n\t\t\t\t\t\t\t\t\tthis.selectionStart(node);\n\n\t\t\t\t\t\t\t\t\tthis.sync();\n\t\t\t\t\t\t\t\t\tthis.callback('enter', e);\n\t\t\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (block && this.opts.rBlockTest.test(block.tagName))\n\t\t\t\t\t\t{\n\n\t\t\t\t\t\t\tthis.bufferSet();\n\n\t\t\t\t\t\t\tsetTimeout($.proxy(function()\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tvar blockElem = this.getBlock();\n\t\t\t\t\t\t\t\tif (blockElem.tagName === 'DIV' && !$(blockElem).hasClass('redactor_editor'))\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tvar node = $('<p>' + this.opts.invisibleSpace + '</p>');\n\t\t\t\t\t\t\t\t\t$(blockElem).replaceWith(node);\n\t\t\t\t\t\t\t\t\tthis.selectionStart(node);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t}, this), 1);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (block === false)\n\t\t\t\t\t\t{\n\n\t\t\t\t\t\t\tthis.bufferSet();\n\t\t\t\t\t\t\tvar node = $('<p>' + this.opts.invisibleSpace + '</p>');\n\t\t\t\t\t\t\tthis.insertNode(node[0]);\n\t\t\t\t\t\t\tthis.selectionStart(node);\n\t\t\t\t\t\t\tthis.callback('enter', e);\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.opts.linebreaks)\n\t\t\t\t\t{\n\n\t\t\t\t\t\tif (block && this.opts.rBlockTest.test(block.tagName))\n\t\t\t\t\t\t{\n\n\t\t\t\t\t\t\tthis.bufferSet();\n\n\t\t\t\t\t\t\tsetTimeout($.proxy(function()\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tvar blockElem = this.getBlock();\n\t\t\t\t\t\t\t\tif ((blockElem.tagName === 'DIV' || blockElem.tagName === 'P') && !$(blockElem).hasClass('redactor_editor'))\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tthis.replaceLineBreak(blockElem);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t}, this), 1);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn this.buildEventKeydownInsertLineBreak(e);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (block.tagName == 'BLOCKQUOTE' || block.tagName == 'FIGCAPTION')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn this.buildEventKeydownInsertLineBreak(e);\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t\tthis.callback('enter', e);\n\t\t\t}\n\t\t\telse if (key === this.keyCode.ENTER && (e.ctrlKey || e.shiftKey))\n\t\t\t{\n\t\t\t\tthis.bufferSet();\n\n\t\t\t\te.preventDefault();\n\t\t\t\tthis.insertLineBreak();\n\t\t\t}\n\t\t\tif ((key === this.keyCode.TAB || e.metaKey && key === 219) && this.opts.shortcuts)\n\t\t\t{\n\t\t\t\treturn this.buildEventKeydownTab(e, pre, key);\n\t\t\t}\n\t\t\tif (key === this.keyCode.BACKSPACE) this.buildEventKeydownBackspace(e, current, parent);\n\n\t\t},\n\t\tbuildEventKeydownPre: function(e, current)\n\t\t{\n\t\t\te.preventDefault();\n\t\t\tthis.bufferSet();\n\t\t\tvar html = $(current).parent().text();\n\t\t\tthis.insertNode(document.createTextNode('\\n'));\n\t\t\tif (html.search(/\\s$/) == -1)\n\t\t\t{\n\t\t\t\tthis.insertNode(document.createTextNode('\\n'));\n\t\t\t}\n\n\t\t\tthis.sync();\n\t\t\tthis.callback('enter', e);\n\t\t\treturn false;\n\t\t},\n\t\tbuildEventKeydownTab: function(e, pre, key)\n\t\t{\n\t\t\tif (!this.opts.tabFocus) return true;\n\t\t\tif (this.isEmpty(this.get()) && this.opts.tabSpaces === false) return true;\n\n\t\t\te.preventDefault();\n\n\t\t\tif (pre === true && !e.shiftKey)\n\t\t\t{\n\t\t\t\tthis.bufferSet();\n\t\t\t\tthis.insertNode(document.createTextNode('\\t'));\n\t\t\t\tthis.sync();\n\t\t\t\treturn false;\n\n\t\t\t}\n\t\t\telse if (this.opts.tabSpaces !== false)\n\t\t\t{\n\t\t\t\tthis.bufferSet();\n\t\t\t\tthis.insertNode(document.createTextNode(Array(this.opts.tabSpaces + 1).join('\\u00a0')));\n\t\t\t\tthis.sync();\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tif (!e.shiftKey) this.indentingIndent();\n\t\t\t\telse this.indentingOutdent();\n\t\t\t}\n\n\t\t\treturn false;\n\t\t},\n\t\tbuildEventKeydownBackspace: function(e, current, parent)\n\t\t{\n\n\t\t\tif (parent && current && parent.parentNode.tagName == 'TD'\n\t\t\t\t&& parent.tagName == 'UL' && current.tagName == 'LI' && $(parent).children('li').length == 1)\n\t\t\t{\n\t\t\t\tvar text = $(current).text().replace(/[\\u200B-\\u200D\\uFEFF]/g, '');\n\t\t\t\tif (text == '')\n\t\t\t\t{\n\t\t\t\t\tvar node = parent.parentNode;\n\t\t\t\t\t$(parent).remove();\n\t\t\t\t\tthis.selectionStart(node);\n\t\t\t\t\tthis.sync();\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (typeof current.tagName !== 'undefined' && /^(H[1-6])$/i.test(current.tagName))\n\t\t\t{\n\t\t\t\tvar node;\n\t\t\t\tif (this.opts.linebreaks === false) node = $('<p>' + this.opts.invisibleSpace + '</p>');\n\t\t\t\telse node = $('<br>' + this.opts.invisibleSpace);\n\n\t\t\t\t$(current).replaceWith(node);\n\t\t\t\tthis.selectionStart(node);\n\t\t\t\tthis.sync();\n\t\t\t}\n\n\t\t\tif (typeof current.nodeValue !== 'undefined' && current.nodeValue !== null)\n\t\t\t{\n\t\t\t\tif (current.remove && current.nodeType === 3 && current.nodeValue.match(/[^\\u200B]/g) == null)\n\t\t\t\t{\n\t\t\t\t\t$(current).prev().remove();\n\t\t\t\t\tthis.sync();\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\tbuildEventKeydownInsertLineBreak: function(e)\n\t\t{\n\t\t\tthis.bufferSet();\n\t\t\te.preventDefault();\n\t\t\tthis.insertLineBreak();\n\t\t\tthis.callback('enter', e);\n\t\t\treturn;\n\t\t},\n\t\tbuildEventKeyup: function(e)\n\t\t{\n\t\t\tif (this.rtePaste) return false;\n\n\t\t\tvar key = e.which;\n\t\t\tvar parent = this.getParent();\n\t\t\tvar current = this.getCurrent();\n\t\t\tif (!this.opts.linebreaks && current.nodeType == 3 && (parent == false || parent.tagName == 'BODY'))\n\t\t\t{\n\t\t\t\tvar node = $('<p>').append($(current).clone());\n\t\t\t\t$(current).replaceWith(node);\n\t\t\t\tvar next = $(node).next();\n\t\t\t\tif (typeof(next[0]) !== 'undefined' && next[0].tagName == 'BR')\n\t\t\t\t{\n\t\t\t\t\tnext.remove();\n\t\t\t\t}\n\n\t\t\t\tthis.selectionEnd(node);\n\t\t\t}\n\t\t\tif ((this.opts.convertLinks || this.opts.convertImageLinks || this.opts.convertVideoLinks) && key === this.keyCode.ENTER)\n\t\t\t{\n\t\t\t\tthis.buildEventKeyupConverters();\n\t\t\t}\n\t\t\tif (key === this.keyCode.DELETE || key === this.keyCode.BACKSPACE)\n\t\t\t{\n\t\t\t\treturn this.formatEmpty(e);\n\t\t\t}\n\n\t\t\tthis.callback('keyup', e);\n\t\t\tthis.sync(e);\n\t\t},\n\t\tbuildEventKeyupConverters: function()\n\t\t{\n\t\t\tthis.formatLinkify(this.opts.linkProtocol, this.opts.convertLinks, this.opts.convertImageLinks, this.opts.convertVideoLinks, this.opts.linkSize);\n\n\t\t\tsetTimeout($.proxy(function()\n\t\t\t{\n\t\t\t\tif (this.opts.convertImageLinks) this.observeImages();\n\t\t\t\tif (this.opts.observeLinks) this.observeLinks();\n\t\t\t}, this), 5);\n\t\t},\n\t\tbuildPlugins: function()\n\t\t{\n\t\t\tif (!this.opts.plugins ) return;\n\n\t\t\t$.each(this.opts.plugins, $.proxy(function(i, s)\n\t\t\t{\n\t\t\t\tif (RedactorPlugins[s])\n\t\t\t\t{\n\t\t\t\t\t$.extend(this, RedactorPlugins[s]);\n\t\t\t\t\tif ($.isFunction( RedactorPlugins[ s ].init)) this.init();\n\t\t\t\t}\n\n\t\t\t}, this ));\n\t\t},\n\t\tiframeStart: function()\n\t\t{\n\t\t\tthis.iframeCreate();\n\n\t\t\tif (this.opts.textareamode) this.iframeAppend(this.$source);\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.$sourceOld = this.$source.hide();\n\t\t\t\tthis.$source = this.buildCodearea(this.$sourceOld);\n\t\t\t\tthis.iframeAppend(this.$sourceOld);\n\t\t\t}\n\t\t},\n\t\tiframeAppend: function(el)\n\t\t{\n\t\t\tthis.$source.attr('dir', this.opts.direction).hide();\n\t\t\tthis.$box.insertAfter(el).append(this.$frame).append(this.$source);\n\t\t},\n\t\tiframeCreate: function()\n\t\t{\n\t\t\tthis.$frame = $('<iframe style=\"width: 100%;\" frameborder=\"0\" />').one('load', $.proxy(function()\n\t\t\t{\n\t\t\t\tif (this.opts.fullpage)\n\t\t\t\t{\n\t\t\t\t\tthis.iframePage();\n\n\t\t\t\t\tif (this.content === '') this.content = this.opts.invisibleSpace;\n\n\t\t\t\t\tthis.$frame.contents()[0].write(this.content);\n\t\t\t\t\tthis.$frame.contents()[0].close();\n\n\t\t\t\t\tvar timer = setInterval($.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tif (this.$frame.contents().find('body').html())\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tclearInterval(timer);\n\t\t\t\t\t\t\tthis.iframeLoad();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}, this), 0);\n\t\t\t\t}\n\t\t\t\telse this.iframeLoad();\n\n\t\t\t}, this));\n\t\t},\n\t\tiframeDoc: function()\n\t\t{\n\t\t\treturn this.$frame[0].contentWindow.document;\n\t\t},\n\t\tiframePage: function()\n\t\t{\n\t\t\tvar doc = this.iframeDoc();\n\t\t\tif (doc.documentElement) doc.removeChild(doc.documentElement);\n\n\t\t\treturn doc;\n\t\t},\n\t\tiframeAddCss: function(css)\n\t\t{\n\t\t\tcss = css || this.opts.css;\n\n\t\t\tif (this.isString(css))\n\t\t\t{\n\t\t\t\tthis.$frame.contents().find('head').append('<link rel=\"stylesheet\" href=\"' + css + '\" />');\n\t\t\t}\n\n\t\t\tif ($.isArray(css))\n\t\t\t{\n\t\t\t\t$.each(css, $.proxy(function(i, url)\n\t\t\t\t{\n\t\t\t\t\tthis.iframeAddCss(url);\n\n\t\t\t\t}, this));\n\t\t\t}\n\t\t},\n\t\tiframeLoad: function()\n\t\t{\n\t\t\tthis.$editor = this.$frame.contents().find('body').attr({ 'contenteditable': true, 'dir': this.opts.direction });\n\t\t\tif (this.$editor[0])\n\t\t\t{\n\t\t\t\tthis.document = this.$editor[0].ownerDocument;\n\t\t\t\tthis.window = this.document.defaultView || window;\n\t\t\t}\n\t\t\tthis.iframeAddCss();\n\n\t\t\tif (this.opts.fullpage)\n\t\t\t{\n\t\t\t\tthis.setFullpageOnInit(this.$source.val());\n\t\t\t}\n\t\t\telse this.set(this.content, true, false);\n\n\t\t\tthis.buildOptions();\n\t\t\tthis.buildAfter();\n\t\t},\n\t\tplaceholderInit: function()\n\t\t{\n\t\t\tif (this.opts.placeholder !== false)\n\t\t\t{\n\t\t\t\tthis.placeholderText = this.opts.placeholder;\n\t\t\t\tthis.opts.placeholder = true;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tif (typeof this.$element.attr('placeholder') == 'undefined' || this.$element.attr('placeholder') == '')\n\t\t\t\t{\n\t\t\t\t\tthis.opts.placeholder = false;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.placeholderText = this.$element.attr('placeholder');\n\t\t\t\t\tthis.opts.placeholder = true;\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\tplaceholderStart: function(html)\n\t\t{\n\t\t\tif (this.opts.placeholder === false)\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tif (this.isEmpty(html))\n\t\t\t{\n\t\t\t\tthis.opts.focus = false;\n\t\t\t\tthis.placeholderOnFocus();\n\t\t\t\tthis.placeholderOnBlur();\n\n\t\t\t\treturn this.placeholderGet();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.placeholderOnBlur();\n\t\t\t}\n\n\t\t\treturn false;\n\t\t},\n\t\tplaceholderOnFocus: function()\n\t\t{\n\t\t\tthis.$editor.on('focus.redactor_placeholder', $.proxy(this.placeholderFocus, this));\n\t\t},\n\t\tplaceholderOnBlur: function()\n\t\t{\n\t\t\tthis.$editor.on('blur.redactor_placeholder', $.proxy(this.placeholderBlur, this));\n\t\t},\n\t\tplaceholderGet: function()\n\t\t{\n\t\t\tvar ph = $('<span class=\"redactor_placeholder\">').data('redactor', 'verified')\n\t\t\t.attr('contenteditable', false).text(this.placeholderText);\n\n\t\t\tif (this.opts.linebreaks === false)\n\t\t\t{\n\t\t\t\treturn $('<p>').append(ph);\n\t\t\t}\n\t\t\telse return ph;\n\t\t},\n\t\tplaceholderBlur: function()\n\t\t{\n\t\t\tvar html = this.get();\n\t\t\tif (this.isEmpty(html))\n\t\t\t{\n\t\t\t\tthis.placeholderOnFocus();\n\t\t\t\tthis.$editor.html(this.placeholderGet());\n\t\t\t}\n\t\t},\n\t\tplaceholderFocus: function()\n\t\t{\n\t\t\tthis.$editor.find('span.redactor_placeholder').remove();\n\n\t\t\tvar html = '';\n\t\t\tif (this.opts.linebreaks === false)\n\t\t\t{\n\t\t\t\thtml = this.opts.emptyHtml;\n\t\t\t}\n\n\t\t\tthis.$editor.off('focus.redactor_placeholder');\n\t\t\tthis.$editor.html(html);\n\n\t\t\tif (this.opts.linebreaks === false)\n\t\t\t{\n\n\t\t\t\tthis.selectionStart(this.$editor.children()[0]);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.focus();\n\t\t\t}\n\n\t\t\tthis.sync();\n\t\t},\n\t\tplaceholderRemoveFromEditor: function()\n\t\t{\n\t\t\tthis.$editor.find('span.redactor_placeholder').remove();\n\t\t\tthis.$editor.off('focus.redactor_placeholder');\n\t\t},\n\t\tplaceholderRemoveFromCode: function(html)\n\t\t{\n\t\t\treturn html.replace(/<span class=\"redactor_placeholder\"(.*?)>(.*?)<\\/span>/i, '');\n\t\t},\n\t\tshortcuts: function(e, key)\n\t\t{\n\t\t\tif (!this.opts.shortcuts)\n\t\t\t{\n\t\t\t\tif ((e.ctrlKey || e.metaKey) && (key === 66 || key === 73))\n\t\t\t\t{\n\t\t\t\t\te.preventDefault();\n\t\t\t\t}\n\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t$.each(this.opts.shortcuts, $.proxy(function(str, command)\n\t\t\t{\n\t\t\t\tvar keys = str.split(',');\n\t\t\t\tfor (var i in keys)\n\t\t\t\t{\n\t\t\t\t\tif (typeof keys[i] === 'string')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.shortcutsHandler(e, $.trim(keys[i]), $.proxy(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\teval(command);\n\t\t\t\t\t\t}, this));\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t}, this));\n\t\t},\n\t\tshortcutsHandler: function(e, keys, origHandler)\n\t\t{\n\n\t\t\tvar hotkeysSpecialKeys =\n\t\t\t{\n\t\t\t\t8: \"backspace\", 9: \"tab\", 10: \"return\", 13: \"return\", 16: \"shift\", 17: \"ctrl\", 18: \"alt\", 19: \"pause\",\n\t\t\t\t20: \"capslock\", 27: \"esc\", 32: \"space\", 33: \"pageup\", 34: \"pagedown\", 35: \"end\", 36: \"home\",\n\t\t\t\t37: \"left\", 38: \"up\", 39: \"right\", 40: \"down\", 45: \"insert\", 46: \"del\", 59: \";\", 61: \"=\",\n\t\t\t\t96: \"0\", 97: \"1\", 98: \"2\", 99: \"3\", 100: \"4\", 101: \"5\", 102: \"6\", 103: \"7\",\n\t\t\t\t104: \"8\", 105: \"9\", 106: \"*\", 107: \"+\", 109: \"-\", 110: \".\", 111 : \"/\",\n\t\t\t\t112: \"f1\", 113: \"f2\", 114: \"f3\", 115: \"f4\", 116: \"f5\", 117: \"f6\", 118: \"f7\", 119: \"f8\",\n\t\t\t\t120: \"f9\", 121: \"f10\", 122: \"f11\", 123: \"f12\", 144: \"numlock\", 145: \"scroll\", 173: \"-\", 186: \";\", 187: \"=\",\n\t\t\t\t188: \",\", 189: \"-\", 190: \".\", 191: \"/\", 192: \"`\", 219: \"[\", 220: \"\\\\\", 221: \"]\", 222: \"'\"\n\t\t\t};\n\t\t\tvar hotkeysShiftNums =\n\t\t\t{\n\t\t\t\t\"`\": \"~\", \"1\": \"!\", \"2\": \"@\", \"3\": \"#\", \"4\": \"$\", \"5\": \"%\", \"6\": \"^\", \"7\": \"&\",\n\t\t\t\t\"8\": \"*\", \"9\": \"(\", \"0\": \")\", \"-\": \"_\", \"=\": \"+\", \";\": \": \", \"'\": \"\\\"\", \",\": \"<\",\n\t\t\t\t\".\": \">\",  \"/\": \"?\",  \"\\\\\": \"|\"\n\t\t\t};\n\n\t\t\tkeys = keys.toLowerCase().split(\" \");\n\t\t\tvar special = hotkeysSpecialKeys[e.keyCode],\n\t\t\t\tcharacter = String.fromCharCode( e.which ).toLowerCase(),\n\t\t\t\tmodif = \"\", possible = {};\n\n\t\t\t$.each([ \"alt\", \"ctrl\", \"meta\", \"shift\"], function(index, specialKey)\n\t\t\t{\n\t\t\t\tif (e[specialKey + 'Key'] && special !== specialKey)\n\t\t\t\t{\n\t\t\t\t\tmodif += specialKey + '+';\n\t\t\t\t}\n\t\t\t});\n\t\t\tif (special)\n\t\t\t{\n\t\t\t\tpossible[modif + special] = true;\n\t\t\t}\n\n\t\t\tif (character)\n\t\t\t{\n\t\t\t\tpossible[modif + character] = true;\n\t\t\t\tpossible[modif + hotkeysShiftNums[character]] = true;\n\n\t\t\t\tif (modif === \"shift+\")\n\t\t\t\t{\n\t\t\t\t\tpossible[hotkeysShiftNums[character]] = true;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfor (var i = 0, l = keys.length; i < l; i++)\n\t\t\t{\n\t\t\t\tif (possible[keys[i]])\n\t\t\t\t{\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\treturn origHandler.apply(this, arguments);\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\tfocus: function()\n\t\t{\n\t\t\tif (!this.browser('opera'))\n\t\t\t{\n\t\t\t\tthis.window.setTimeout($.proxy(this.focusSet, this, true), 1);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.$editor.focus();\n\t\t\t}\n\t\t},\n\t\tfocusWithSaveScroll: function()\n\t\t{\n\t\t\tif (this.browser('msie'))\n\t\t\t{\n\t\t\t\tvar top = this.document.documentElement.scrollTop;\n\t\t\t}\n\n\t\t\tthis.$editor.focus();\n\n\t\t\tif (this.browser('msie'))\n\t\t\t{\n\t\t\t\tthis.document.documentElement.scrollTop = top;\n\t\t\t}\n\t\t},\n\t\tfocusEnd: function()\n\t\t{\n\t\t\tif (!this.browser('mozilla'))\n\t\t\t{\n\t\t\t\tthis.focusSet();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tif (this.opts.linebreaks === false)\n\t\t\t\t{\n\t\t\t\t\tvar last = this.$editor.children().last();\n\n\t\t\t\t\tthis.$editor.focus();\n\t\t\t\t\tthis.selectionEnd(last);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.focusSet();\n\t\t\t\t}\n\t\t\t}\n       \t},\n\t\tfocusSet: function(collapse, element)\n\t\t{\n\t\t\tthis.$editor.focus();\n\n\t\t\tif (typeof element == 'undefined')\n\t\t\t{\n\t\t\t\telement = this.$editor[0];\n\t\t\t}\n\n\t\t\tvar range = this.getRange();\n\t\t\trange.selectNodeContents(element);\n\t\t\trange.collapse(collapse || false);\n\n\t\t\tvar sel = this.getSelection();\n\t\t\tsel.removeAllRanges();\n\t\t\tsel.addRange(range);\n\t\t},\n\t\ttoggle: function(direct)\n\t\t{\n\t\t\tif (this.opts.visual) this.toggleCode(direct);\n\t\t\telse this.toggleVisual();\n\t\t},\n\t\ttoggleVisual: function()\n\t\t{\n\t\t\tvar html = this.$source.hide().val();\n\t\t\tif (typeof this.modified !== 'undefined')\n\t\t\t{\n\t\t\t\tvar modified = this.modified.replace(/\\n/g, '');\n\n\t\t\t\tvar thtml = html.replace(/\\n/g, '');\n\t\t\t\tthtml = this.cleanRemoveSpaces(thtml, false);\n\n\t\t\t\tthis.modified = this.cleanRemoveSpaces(modified, false) !== thtml;\n\t\t\t}\n\n\t\t\tif (this.modified)\n\t\t\t{\n\n\t\t\t\tif (this.opts.fullpage && html === '')\n\t\t\t\t{\n\t\t\t\t\tthis.setFullpageOnInit(html);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.set(html);\n\t\t\t\t\tif (this.opts.fullpage)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.buildBindKeyboard();\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tthis.callback('change', false, html);\n\t\t\t}\n\n\t\t\tif (this.opts.iframe) this.$frame.show();\n\t\t\telse this.$editor.show();\n\n\t\t\tif (this.opts.fullpage) this.$editor.attr('contenteditable', true );\n\n\t\t\tthis.$source.off('keydown.redactor-textarea-indenting');\n\n\t\t\tthis.$editor.focus();\n\t\t\tthis.selectionRestore();\n\n\t\t\tthis.observeStart();\n\t\t\tthis.buttonActiveVisual();\n\t\t\tthis.buttonInactive('html');\n\t\t\tthis.opts.visual = true;\n\t\t},\n\t\ttoggleCode: function(direct)\n\t\t{\n\t\t\tif (direct !== false) this.selectionSave();\n\n\t\t\tvar height = null;\n\t\t\tif (this.opts.iframe)\n\t\t\t{\n\t\t\t\theight = this.$frame.height();\n\t\t\t\tif (this.opts.fullpage) this.$editor.removeAttr('contenteditable');\n\t\t\t\tthis.$frame.hide();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\theight = this.$editor.innerHeight();\n\t\t\t\tthis.$editor.hide();\n\t\t\t}\n\n\t\t\tvar html = this.$source.val();\n\t\t\tif (html !== '' && this.opts.tidyHtml)\n\t\t\t{\n\t\t\t\tthis.$source.val(this.cleanHtml(html));\n\t\t\t}\n\n\t\t\tthis.modified = html;\n\n\t\t\tthis.$source.height(height).show().focus();\n\t\t\tthis.$source.on('keydown.redactor-textarea-indenting', this.textareaIndenting);\n\n\t\t\tthis.buttonInactiveVisual();\n\t\t\tthis.buttonActive('html');\n\t\t\tthis.opts.visual = false;\n\t\t},\n\t\ttextareaIndenting: function(e)\n\t\t{\n\t\t\tif (e.keyCode === 9)\n\t\t\t{\n\t\t\t\tvar $el = $(this);\n\t\t\t\tvar start = $el.get(0).selectionStart;\n\t\t\t\t$el.val($el.val().substring(0, start) + \"\\t\" + $el.val().substring($el.get(0).selectionEnd));\n\t\t\t\t$el.get(0).selectionStart = $el.get(0).selectionEnd = start + 1;\n\t\t\t\treturn false;\n\t\t\t}\n\t\t},\n\t\tautosave: function()\n\t\t{\n\t\t\tvar savedHtml = false;\n\t\t\tthis.autosaveInterval = setInterval($.proxy(function()\n\t\t\t{\n\t\t\t\tvar html = this.get();\n\t\t\t\tif (savedHtml !== html)\n\t\t\t\t{\n\t\t\t\t\tvar name = this.$source.attr('name');\n\t\t\t\t\t$.ajax({\n\t\t\t\t\t\turl: this.opts.autosave,\n\t\t\t\t\t\ttype: 'post',\n\t\t\t\t\t\tdata: 'name=' + name + '&' + name + '=' + escape(encodeURIComponent(html)),\n\t\t\t\t\t\tsuccess: $.proxy(function(data)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar json = $.parseJSON(data);\n\t\t\t\t\t\t\tif (typeof json.error == 'undefined')\n\t\t\t\t\t\t\t{\n\n\t\t\t\t\t\t\t\tthis.callback('autosave', false, json);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\n\t\t\t\t\t\t\t\tthis.callback('autosaveError', false, json);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tsavedHtml = html;\n\n\t\t\t\t\t\t}, this)\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}, this), this.opts.autosaveInterval*1000);\n\t\t},\n\t\ttoolbarBuild: function()\n\t\t{\n\n\t\t\tif (this.isMobile() && this.opts.buttonsHideOnMobile.length > 0)\n\t\t\t{\n\t\t\t\t$.each(this.opts.buttonsHideOnMobile, $.proxy(function(i, s)\n\t\t\t\t{\n\t\t\t\t\tvar index = this.opts.buttons.indexOf(s);\n\t\t\t\t\tthis.opts.buttons.splice(index, 1);\n\n\t\t\t\t}, this));\n\t\t\t}\n\t\t\tif (this.opts.air)\n\t\t\t{\n\t\t\t\tthis.opts.buttons = this.opts.airButtons;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tif (!this.opts.buttonSource)\n\t\t\t\t{\n\t\t\t\t\tvar index = this.opts.buttons.indexOf('html');\n\t\t\t\t\tthis.opts.buttons.splice(index, 1);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (this.opts.toolbar)\n\t\t\t{\n\t\t\t\t$.each(this.opts.toolbar.formatting.dropdown, $.proxy(function (i, s)\n\t\t\t\t{\n\t\t\t\t\tif ($.inArray(i, this.opts.formattingTags ) == '-1') delete this.opts.toolbar.formatting.dropdown[i];\n\n\t\t\t\t}, this));\n\t\t\t}\n\t\t\tif (this.opts.buttons.length === 0) return false;\n\t\t\tthis.airEnable();\n\t\t\tthis.$toolbar = $('<ul>').addClass('redactor_toolbar').attr('id', 'redactor_toolbar_' + this.uuid);\n\n\t\t\tif (this.opts.typewriter)\n\t\t\t{\n\t\t\t\tthis.$toolbar.addClass('redactor-toolbar-typewriter');\n\t\t\t}\n\n\t\t\tif (this.opts.toolbarOverflow && this.isMobile())\n\t\t\t{\n\t\t\t\tthis.$toolbar.addClass('redactor-toolbar-overflow');\n\t\t\t}\n\n\t\t\tif (this.opts.air)\n\t\t\t{\n\n\t\t\t\tthis.$air = $('<div class=\"redactor_air\">').attr('id', 'redactor_air_' + this.uuid).hide();\n\t\t\t\tthis.$air.append(this.$toolbar);\n\t\t\t\t$('body').append(this.$air);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tif (this.opts.toolbarExternal)\n\t\t\t\t{\n\t\t\t\t\tthis.$toolbar.addClass('redactor-toolbar-external');\n\t\t\t\t\t$(this.opts.toolbarExternal).html(this.$toolbar);\n\t\t\t\t}\n\t\t\t\telse this.$box.prepend(this.$toolbar);\n\t\t\t}\n\n\t\t\t$.each(this.opts.buttons, $.proxy(function(i, btnName)\n\t\t\t{\n\t\t\t\tif (this.opts.toolbar[btnName])\n\t\t\t\t{\n\t\t\t\t\tvar btnObject = this.opts.toolbar[btnName];\n\t\t\t\t\tif (this.opts.fileUpload === false && btnName === 'file') return true;\n\t\t\t\t\tthis.$toolbar.append( $('<li>').append(this.buttonBuild(btnName, btnObject)));\n\t\t\t\t}\n\n\t\t\t}, this));\n\n\t\t\tthis.$toolbar.find('a').attr('tabindex', '-1');\n\t\t\tif (this.opts.toolbarFixed)\n\t\t\t{\n\t\t\t\tthis.toolbarObserveScroll();\n\t\t\t\t$(this.opts.toolbarFixedTarget).on('scroll.redactor', $.proxy(this.toolbarObserveScroll, this));\n\t\t\t}\n\t\t\tif (this.opts.activeButtons)\n\t\t\t{\n\t\t\t\tthis.$editor.on('mouseup.redactor keyup.redactor', $.proxy(this.buttonActiveObserver, this));\n\t\t\t}\n\t\t},\n\t\ttoolbarObserveScroll: function()\n\t\t{\n\t\t\tvar scrollTop = $(this.opts.toolbarFixedTarget).scrollTop();\n\n\t\t\tvar boxTop = 0;\n\t\t\tvar left = 0;\n\t\t\tvar end = 0;\n\n\t\t\tif (this.opts.toolbarFixedTarget === document)\n\t\t\t{\n\t\t\t\tboxTop = this.$box.offset().top;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tboxTop = 1;\n\t\t\t}\n\n\t\t\tend = boxTop + this.$box.height() + 40;\n\n\t\t\tif (scrollTop > boxTop)\n\t\t\t{\n\t\t\t\tvar width = '100%';\n\t\t\t\tif (this.opts.toolbarFixedBox)\n\t\t\t\t{\n\t\t\t\t\tleft = this.$box.offset().left;\n\t\t\t\t\twidth = this.$box.innerWidth();\n\t\t\t\t\tthis.$toolbar.addClass('toolbar_fixed_box');\n\t\t\t\t}\n\n\t\t\t\tthis.toolbarFixed = true;\n\n\t\t\t\tif (this.opts.toolbarFixedTarget === document)\n\t\t\t\t{\n\t\t\t\t\tthis.$toolbar.css({\n\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\twidth: width,\n\t\t\t\t\t\tzIndex: 10005,\n\t\t\t\t\t\ttop: this.opts.toolbarFixedTopOffset + 'px',\n\t\t\t\t\t\tleft: left\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.$toolbar.css({\n\t\t\t\t\t\tposition: 'absolute',\n\t\t\t\t\t\twidth: width,\n\t\t\t\t\t\tzIndex: 10005,\n\t\t\t\t\t\ttop: (this.opts.toolbarFixedTopOffset + scrollTop) + 'px',\n\t\t\t\t\t\tleft: 0\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tif (scrollTop < end) this.$toolbar.css('visibility', 'visible');\n\t\t\t\telse this.$toolbar.css('visibility', 'hidden');\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.toolbarFixed = false;\n\t\t\t\tthis.$toolbar.css({\n\t\t\t\t\tposition: 'relative',\n\t\t\t\t\twidth: 'auto',\n\t\t\t\t\ttop: 0,\n\t\t\t\t\tleft: left\n\t\t\t\t});\n\n\t\t\t\tif (this.opts.toolbarFixedBox) this.$toolbar.removeClass('toolbar_fixed_box');\n\t\t\t}\n\t\t},\n\t\tairEnable: function()\n\t\t{\n\t\t\tif (!this.opts.air) return;\n\n\t\t\tthis.$editor.on('mouseup.redactor keyup.redactor', this, $.proxy(function(e)\n\t\t\t{\n\t\t\t\tvar text = this.getSelectionText();\n\n\t\t\t\tif (e.type === 'mouseup' && text != '') this.airShow(e);\n\t\t\t\tif (e.type === 'keyup' && e.shiftKey && text != '')\n\t\t\t\t{\n\t\t\t\t\tvar $focusElem = $(this.getElement(this.getSelection().focusNode)), offset = $focusElem.offset();\n\t\t\t\t\toffset.height = $focusElem.height();\n\t\t\t\t\tthis.airShow(offset, true);\n\t\t\t\t}\n\n\t\t\t}, this));\n\t\t},\n\t\tairShow: function (e, keyboard)\n\t\t{\n\t\t\tif (!this.opts.air) return;\n\n\t\t\tthis.selectionSave();\n\n\t\t\tvar left, top;\n\t\t\t$('.redactor_air').hide();\n\n\t\t\tif (keyboard)\n\t\t\t{\n\t\t\t\tleft = e.left;\n\t\t\t\ttop = e.top + e.height + 14;\n\n\t\t\t\tif (this.opts.iframe)\n\t\t\t\t{\n\t\t\t\t\ttop += this.$box.position().top - $(this.document).scrollTop();\n\t\t\t\t\tleft += this.$box.position().left;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tvar width = this.$air.innerWidth();\n\n\t\t\t\tleft = e.clientX;\n\t\t\t\tif ($(this.document).width() < (left + width)) left -= width;\n\n\t\t\t\ttop = e.clientY + 14;\n\t\t\t\tif (this.opts.iframe)\n\t\t\t\t{\n\t\t\t\t\ttop += this.$box.position().top;\n\t\t\t\t\tleft += this.$box.position().left;\n\t\t\t\t}\n\t\t\t\telse top += $( this.document ).scrollTop();\n\t\t\t}\n\n\t\t\tthis.$air.css({\n\t\t\t\tleft: left + 'px',\n\t\t\t\ttop: top + 'px'\n\t\t\t}).show();\n\n\t\t\tthis.airBindHide();\n\t\t},\n\t\tairBindHide: function()\n\t\t{\n\t\t\tif (!this.opts.air) return;\n\n\t\t\tvar hideHandler = $.proxy(function(doc)\n\t\t\t{\n\t\t\t\t$(doc).on('mousedown.redactor', $.proxy(function(e)\n\t\t\t\t{\n\t\t\t\t\tif ($( e.target ).closest(this.$toolbar).length === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.$air.fadeOut(100);\n\t\t\t\t\t\tthis.selectionRemove();\n\t\t\t\t\t\t$(doc).off(e);\n\t\t\t\t\t}\n\n\t\t\t\t}, this)).on('keydown.redactor', $.proxy(function(e)\n\t\t\t\t{\n\t\t\t\t\tif (e.which === this.keyCode.ESC)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.getSelection().collapseToStart();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.$air.fadeOut(100);\n\t\t\t\t\t$(doc).off(e);\n\n\t\t\t\t}, this));\n\t\t\t}, this);\n\t\t\thideHandler(document);\n\t\t\tif (this.opts.iframe) hideHandler(this.document);\n\t\t},\n\t\tairBindMousemoveHide: function()\n\t\t{\n\t\t\tif (!this.opts.air) return;\n\n\t\t\tvar hideHandler = $.proxy(function(doc)\n\t\t\t{\n\t\t\t\t$(doc).on('mousemove.redactor', $.proxy(function(e)\n\t\t\t\t{\n\t\t\t\t\tif ($( e.target ).closest(this.$toolbar).length === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.$air.fadeOut(100);\n\t\t\t\t\t\t$(doc).off(e);\n\t\t\t\t\t}\n\n\t\t\t\t}, this));\n\t\t\t}, this);\n\t\t\thideHandler(document);\n\t\t\tif (this.opts.iframe) hideHandler(this.document);\n\t\t},\n\t\tdropdownBuild: function($dropdown, dropdownObject)\n\t\t{\n\t\t\t$.each(dropdownObject, $.proxy(function(btnName, btnObject)\n\t\t\t{\n\t\t\t\tif (!btnObject.className) btnObject.className = '';\n\n\t\t\t\tvar $item;\n\t\t\t\tif (btnObject.name === 'separator') $item = $('<a class=\"redactor_separator_drop\">');\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$item = $('<a href=\"#\" class=\"' + btnObject.className + ' redactor_dropdown_' + btnName + '\">' + btnObject.title + '</a>');\n\t\t\t\t\t$item.on('click', $.proxy(function(e)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (this.opts.air)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.selectionRestore();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (e.preventDefault) e.preventDefault();\n\t\t\t\t\t\tif (this.browser('msie')) e.returnValue = false;\n\n\t\t\t\t\t\tif (btnObject.callback) btnObject.callback.call(this, btnName, $item, btnObject, e);\n\t\t\t\t\t\tif (btnObject.exec) this.execCommand(btnObject.exec, btnName);\n\t\t\t\t\t\tif (btnObject.func) this[btnObject.func](btnName);\n\n\t\t\t\t\t\tthis.buttonActiveObserver();\n\t\t\t\t\t\tif (this.opts.air) this.$air.fadeOut(100);\n\t\t\t\t\t}, this));\n\t\t\t\t}\n\n\t\t\t\t$dropdown.append($item);\n\n\t\t\t}, this));\n\t\t},\n\t\tdropdownShow: function(e, key)\n\t\t{\n\t\t\tif (!this.opts.visual)\n\t\t\t{\n\t\t\t\te.preventDefault();\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tvar $button = this.buttonGet(key);\n\t\t\tvar $dropdown  = $button.data('dropdown').appendTo(document.body);\n\n\t\t\tif ($button.hasClass('dropact')) this.dropdownHideAll();\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.dropdownHideAll();\n\t\t\t\tthis.callback('dropdownShow', { dropdown: $dropdown, key: key, button: $button });\n\n\t\t\t\tthis.buttonActive(key);\n\t\t\t\t$button.addClass('dropact');\n\n\t\t\t\tvar keyPosition = $button.offset();\n\t\t\t\tvar dropdownWidth = $dropdown.width();\n\t\t\t\tif ((keyPosition.left + dropdownWidth) > $(document).width())\n\t\t\t\t{\n\t\t\t\t\tkeyPosition.left -= dropdownWidth;\n\t\t\t\t}\n\n\t\t\t\tvar left = keyPosition.left + 'px';\n\t\t\t\tvar btnHeight = $button.innerHeight();\n\n\t\t\t\tvar position = 'absolute';\n\t\t\t\tvar top = (btnHeight + this.opts.toolbarFixedTopOffset) + 'px';\n\n\t\t\t\tif (this.opts.toolbarFixed && this.toolbarFixed) position = 'fixed';\n\t\t\t\telse top = keyPosition.top + btnHeight + 'px';\n\n\t\t\t\t$dropdown.css({ position: position, left: left, top: top }).show();\n\t\t\t\tthis.callback('dropdownShown', { dropdown: $dropdown, key: key, button: $button });\n\t\t\t}\n\t\t\tvar hdlHideDropDown = $.proxy(function(e)\n\t\t\t{\n\t\t\t\tthis.dropdownHide(e, $dropdown);\n\n\t\t\t}, this);\n\n\t\t\t$(document).one('click', hdlHideDropDown);\n\t\t\tthis.$editor.one('click', hdlHideDropDown);\n\t\t\tthis.$editor.one('touchstart', hdlHideDropDown);\n\t\t\te.stopPropagation();\n\t\t\tthis.focusWithSaveScroll();\n\t\t},\n\t\tdropdownHideAll: function()\n\t\t{\n\t\t\tthis.$toolbar.find('a.dropact').removeClass('redactor_act').removeClass('dropact');\n\t\t\t$('.redactor_dropdown').hide();\n\t\t\tthis.callback('dropdownHide');\n\t\t},\n\t\tdropdownHide: function (e, $dropdown)\n\t\t{\n\t\t\tif (!$(e.target).hasClass('dropact'))\n\t\t\t{\n\t\t\t\t$dropdown.removeClass('dropact');\n\t\t\t\tthis.dropdownHideAll();\n\t\t\t}\n\t\t},\n\t\tbuttonBuild: function(btnName, btnObject, buttonImage)\n\t\t{\n\t\t\tvar $button = $('<a href=\"javascript:;\" title=\"' + btnObject.title + '\" tabindex=\"-1\" class=\"re-icon re-' + btnName + '\"></a>');\n\n\t\t\tif (typeof buttonImage != 'undefined')\n\t\t\t{\n\t\t\t\t$button.addClass('redactor-btn-image');\n\t\t\t}\n\n\t\t\t$button.on('click', $.proxy(function(e)\n\t\t\t{\n\t\t\t\tif (e.preventDefault) e.preventDefault();\n\t\t\t\tif (this.browser('msie')) e.returnValue = false;\n\n\t\t\t\tif ($button.hasClass('redactor_button_disabled')) return false;\n\n\t\t\t\tif (this.isFocused() === false && !btnObject.exec)\n\t\t\t\t{\n\t\t\t\t\tthis.focusWithSaveScroll();\n\t\t\t\t}\n\n\t\t\t\tif (btnObject.exec)\n\t\t\t\t{\n\t\t\t\t\tthis.focusWithSaveScroll();\n\n\t\t\t\t\tthis.execCommand(btnObject.exec, btnName);\n\t\t\t\t\tthis.airBindMousemoveHide();\n\n\t\t\t\t}\n\t\t\t\telse if (btnObject.func && btnObject.func !== 'show')\n\t\t\t\t{\n\t\t\t\t\tthis[btnObject.func](btnName);\n\t\t\t\t\tthis.airBindMousemoveHide();\n\n\t\t\t\t}\n\t\t\t\telse if (btnObject.callback)\n\t\t\t\t{\n\t\t\t\t\tbtnObject.callback.call(this, btnName, $button, btnObject, e);\n\t\t\t\t\tthis.airBindMousemoveHide();\n\n\t\t\t\t}\n\t\t\t\telse if (btnObject.dropdown)\n\t\t\t\t{\n\t\t\t\t\tthis.dropdownShow(e, btnName);\n\t\t\t\t}\n\n\t\t\t\tthis.buttonActiveObserver(false, btnName);\n\n\t\t\t}, this));\n\t\t\tif (btnObject.dropdown)\n\t\t\t{\n\t\t\t\tvar $dropdown = $('<div class=\"redactor_dropdown redactor_dropdown_box_' + btnName + '\" style=\"display: none;\">');\n\t\t\t\t$button.data('dropdown', $dropdown);\n\t\t\t\tthis.dropdownBuild($dropdown, btnObject.dropdown);\n\t\t\t}\n\n\t\t\treturn $button;\n\t\t},\n\t\tbuttonGet: function(key)\n\t\t{\n\t\t\tif (!this.opts.toolbar) return false;\n\t\t\treturn $(this.$toolbar.find('a.re-' + key));\n\t\t},\n\t\tbuttonTagToActiveState: function(buttonName, tagName)\n\t\t{\n\t\t\tthis.opts.activeButtons.push(buttonName);\n\t\t\tthis.opts.activeButtonsStates[tagName] = buttonName;\n\t\t},\n\t\tbuttonActiveToggle: function(key)\n\t\t{\n\t\t\tvar btn = this.buttonGet(key);\n\n\t\t\tif (btn.hasClass('redactor_act'))\n\t\t\t{\n\t\t\t\tthis.buttonInactive(key);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.buttonActive(key);\n\t\t\t}\n\t\t},\n\t\tbuttonActive: function(key)\n\t\t{\n\t\t\tvar btn = this.buttonGet(key);\n\t\t\tbtn.addClass('redactor_act');\n\t\t},\n\t\tbuttonInactive: function(key)\n\t\t{\n\t\t\tvar btn = this.buttonGet(key);\n\t\t\tbtn.removeClass('redactor_act');\n\t\t},\n\t\tbuttonInactiveAll: function(btnName)\n\t\t{\n\t\t\tthis.$toolbar.find('a.re-icon').not('.re-' + btnName).removeClass('redactor_act');\n\t\t},\n\t\tbuttonActiveVisual: function()\n\t\t{\n\t\t\tthis.$toolbar.find('a.re-icon').not('a.re-html').removeClass('redactor_button_disabled');\n\t\t},\n\t\tbuttonInactiveVisual: function()\n\t\t{\n\t\t\tthis.$toolbar.find('a.re-icon').not('a.re-html').addClass('redactor_button_disabled');\n\t\t},\n\t\tbuttonChangeIcon: function (key, classname)\n\t\t{\n\t\t\tthis.buttonGet(key).addClass('re-' + classname);\n\t\t},\n\t\tbuttonRemoveIcon: function(key, classname)\n\t\t{\n\t\t\tthis.buttonGet(key).removeClass('re-' + classname);\n\t\t},\n\t\tbuttonAwesome: function(key, name)\n\t\t{\n\t\t\tvar button = this.buttonGet(key);\n\t\t\tbutton.removeClass('redactor-btn-image');\n\t\t\tbutton.addClass('fa-redactor-btn');\n\t\t\tbutton.html('<i class=\"fa ' + name + '\"></i>');\n\t\t},\n\t\tbuttonAdd: function(key, title, callback, dropdown)\n\t\t{\n\t\t\tif (!this.opts.toolbar) return;\n\t\t\tvar btn = this.buttonBuild(key, { title: title, callback: callback, dropdown: dropdown }, true);\n\n\t\t\tthis.$toolbar.append($('<li>').append(btn));\n\n\t\t\treturn btn;\n\t\t},\n\t\tbuttonAddFirst: function(key, title, callback, dropdown)\n\t\t{\n\t\t\tif (!this.opts.toolbar) return;\n\t\t\tvar btn = this.buttonBuild(key, { title: title, callback: callback, dropdown: dropdown }, true);\n\t\t\tthis.$toolbar.prepend($('<li>').append(btn));\n\t\t},\n\t\tbuttonAddAfter: function(afterkey, key, title, callback, dropdown)\n\t\t{\n\t\t\tif (!this.opts.toolbar) return;\n\t\t\tvar btn = this.buttonBuild(key, { title: title, callback: callback, dropdown: dropdown }, true);\n\t\t\tvar $btn = this.buttonGet(afterkey);\n\n\t\t\tif ($btn.length !== 0) $btn.parent().after($('<li>').append(btn));\n\t\t\telse this.$toolbar.append($('<li>').append(btn));\n\n\t\t\treturn btn;\n\t\t},\n\t\tbuttonAddBefore: function(beforekey, key, title, callback, dropdown)\n\t\t{\n\t\t\tif (!this.opts.toolbar) return;\n\t\t\tvar btn = this.buttonBuild(key, { title: title, callback: callback, dropdown: dropdown }, true);\n\t\t\tvar $btn = this.buttonGet(beforekey);\n\n\t\t\tif ($btn.length !== 0) $btn.parent().before($('<li>').append(btn));\n\t\t\telse this.$toolbar.append($('<li>').append(btn));\n\n\t\t\treturn btn;\n\t\t},\n\t\tbuttonRemove: function (key)\n\t\t{\n\t\t\tvar $btn = this.buttonGet(key);\n\t\t\t$btn.remove();\n\t\t},\n\t\tbuttonActiveObserver: function(e, btnName)\n\t\t{\n\t\t\tvar parent = this.getParent();\n\t\t\tthis.buttonInactiveAll(btnName);\n\n\t\t\tif (e === false && btnName !== 'html')\n\t\t\t{\n\t\t\t\tif ($.inArray(btnName, this.opts.activeButtons) != -1)\n\t\t\t\t{\n\t\t\t\t\tthis.buttonActiveToggle(btnName);\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (parent && parent.tagName === 'A') this.$toolbar.find('a.redactor_dropdown_link').text(this.opts.curLang.link_edit);\n\t\t\telse this.$toolbar.find('a.redactor_dropdown_link').text(this.opts.curLang.link_insert);\n\n\t\t\t$.each(this.opts.activeButtonsStates, $.proxy(function(key, value)\n\t\t\t{\n\t\t\t\tif ($(parent).closest(key, this.$editor.get()[0]).length != 0)\n\t\t\t\t{\n\t\t\t\t\tthis.buttonActive(value);\n\t\t\t\t}\n\n\t\t\t}, this));\n\n\t\t\tvar $parent = $(parent).closest(this.opts.alignmentTags.toString().toLowerCase(), this.$editor[0]);\n\t\t\tif ($parent.length)\n\t\t\t{\n\t\t\t\tvar align = $parent.css('text-align');\n\t\t\t\tif (align == '')\n\t\t\t\t{\n\t\t\t\t\talign = 'left';\n\t\t\t\t}\n\n\t\t\t\tthis.buttonActive('align' + align);\n\t\t\t}\n\t\t},\n\t\texecPasteFrag: function(html)\n\t\t{\n\t\t\tvar sel = this.getSelection();\n\t\t\tif (sel.getRangeAt && sel.rangeCount)\n\t\t\t{\n\t\t\t\tvar range = this.getRange();\n\t\t\t\trange.deleteContents();\n\n\t\t\t\tvar el = this.document.createElement(\"div\");\n\t\t\t\tel.innerHTML = html;\n\n\t\t\t\tvar frag = this.document.createDocumentFragment(), node, lastNode;\n\t\t\t\twhile ((node = el.firstChild))\n\t\t\t\t{\n\t\t\t\t\tlastNode = frag.appendChild(node);\n\t\t\t\t}\n\n\t\t\t\tvar firstNode = frag.firstChild;\n\t\t\t\trange.insertNode(frag);\n\n\t\t\t\tif (lastNode)\n\t\t\t\t{\n\t\t\t\t\trange = range.cloneRange();\n\t\t\t\t\trange.setStartAfter(lastNode);\n\t\t\t\t\trange.collapse(true);\n\t\t\t\t}\n\t\t\t\tsel.removeAllRanges();\n\t\t\t\tsel.addRange(range);\n\t\t\t}\n\t\t},\n\t\texec: function(cmd, param, sync)\n\t\t{\n\t\t\tif (cmd === 'formatblock' && this.browser('msie'))\n\t\t\t{\n\t\t\t\tparam = '<' + param + '>';\n\t\t\t}\n\n\t\t\tif (cmd === 'inserthtml' && this.browser('msie'))\n\t\t\t{\n\t\t\t\tif (!this.isIe11())\n\t\t\t\t{\n\t\t\t\t\tthis.focusWithSaveScroll();\n\t\t\t\t\tthis.document.selection.createRange().pasteHTML(param);\n\t\t\t\t}\n\t\t\t\telse this.execPasteFrag(param);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.document.execCommand(cmd, false, param);\n\t\t\t}\n\n\t\t\tif (sync !== false) this.sync();\n\t\t\tthis.callback('execCommand', cmd, param);\n\t\t},\n\t\texecCommand: function(cmd, param, sync)\n\t\t{\n\t\t\tif (!this.opts.visual)\n\t\t\t{\n\t\t\t\tthis.$source.focus();\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tif (   cmd === 'bold'\n\t\t\t\t|| cmd === 'italic'\n\t\t\t\t|| cmd === 'underline'\n\t\t\t\t|| cmd === 'strikethrough')\n\t\t\t{\n\t\t\t\tthis.bufferSet();\n\t\t\t}\n\t\t\tif (cmd === 'superscript' || cmd === 'subscript')\n\t\t\t{\n\t\t\t\tvar parent = this.getParent();\n\t\t\t\tif (parent.tagName === 'SUP' || parent.tagName === 'SUB')\n\t\t\t\t{\n\t\t\t\t\tthis.inlineRemoveFormatReplace(parent);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (cmd === 'inserthtml')\n\t\t\t{\n\t\t\t\tthis.insertHtml(param, sync);\n\t\t\t\tthis.callback('execCommand', cmd, param);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (this.currentOrParentIs('CODE') && !this.opts.formattingPre) return false;\n\t\t\tif (cmd === 'insertunorderedlist' || cmd === 'insertorderedlist') return this.execLists(cmd, param);\n\t\t\tif (cmd === 'unlink') return this.execUnlink(cmd, param);\n\t\t\tthis.exec(cmd, param, sync);\n\t\t\tif (cmd === 'inserthorizontalrule') this.$editor.find('hr').removeAttr('id');\n\n\t\t},\n\t\texecUnlink: function(cmd, param)\n\t\t{\n\t\t\tthis.bufferSet();\n\n\t\t\tvar link = this.currentOrParentIs('A');\n\t\t\tif (link)\n\t\t\t{\n\t\t\t\t$(link).replaceWith($(link).text());\n\n\t\t\t\tthis.sync();\n\t\t\t\tthis.callback('execCommand', cmd, param);\n\t\t\t\treturn;\n\t\t\t}\n\t\t},\n\t\texecLists: function(cmd, param)\n\t\t{\n\t\t\tthis.bufferSet();\n\n\t\t\tvar parent = this.getParent();\n\t\t\tvar $list = $(parent).closest('ol, ul');\n\n\t\t\tif (!this.isParentRedactor($list) && $list.length != 0)\n\t\t\t{\n\t\t\t\t$list = false;\n\t\t\t}\n\n\t\t\tvar remove = false;\n\n\t\t\tif ($list && $list.length)\n\t\t\t{\n\t\t\t\tremove = true;\n\t\t\t\tvar listTag = $list[0].tagName;\n\t\t\t \tif ((cmd === 'insertunorderedlist' && listTag === 'OL')\n\t\t\t \t|| (cmd === 'insertorderedlist' && listTag === 'UL'))\n\t\t\t \t{\n\t\t\t\t \tremove = false;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.selectionSave();\n\t\t\tif (remove)\n\t\t\t{\n\n\t\t\t\tvar nodes = this.getNodes();\n\t\t\t\tvar elems = this.getBlocks(nodes);\n\n\t\t\t\tif (typeof nodes[0] != 'undefined' && nodes.length > 1 && nodes[0].nodeType == 3)\n\t\t\t\t{\n\n\t\t\t\t\telems.unshift(this.getBlock());\n\t\t\t\t}\n\n\t\t\t\tvar data = '', replaced = '';\n\t\t\t\t$.each(elems, $.proxy(function(i,s)\n\t\t\t\t{\n\t\t\t\t\tif (s.tagName == 'LI')\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $s = $(s);\n\t\t\t\t\t\tvar cloned = $s.clone();\n\t\t\t\t\t\tcloned.find('ul', 'ol').remove();\n\n\t\t\t\t\t\tif (this.opts.linebreaks === false)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tdata += this.outerHtml($('<p>').append(cloned.contents()));\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar clonedHtml = cloned.html().replace(/<br\\s?\\/?>$/i, '');\n\t\t\t\t\t\t\tdata += clonedHtml + '<br>';\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (i == 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$s.addClass('redactor-replaced').empty();\n\t\t\t\t\t\t\treplaced = this.outerHtml($s);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse $s.remove();\n\t\t\t\t\t}\n\n\t\t\t\t}, this));\n\t\t\t\thtml = this.$editor.html().replace(replaced, '</' + listTag + '>' + data + '<' + listTag + '>');\n\n\t\t\t\tthis.$editor.html(html);\n\t\t\t\tthis.$editor.find(listTag + ':empty').remove();\n\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tvar firstParent = $(this.getParent()).closest('td');\n\n\t\t\t\tif (this.browser('msie') && !this.isIe11() && this.opts.linebreaks)\n\t\t\t\t{\n\t\t\t\t\tvar wrapper = this.selectionWrap('div');\n\t\t\t\t\tvar wrapperHtml = $(wrapper).html();\n\t\t\t\t\tvar tmpList = $('<ul>');\n\t\t\t\t\tif (cmd == 'insertorderedlist')\n\t\t\t\t\t{\n\t\t\t\t\t\ttmpList = $('<ol>');\n\t\t\t\t\t}\n\n\t\t\t\t\tvar tmpLi = $('<li>');\n\n\t\t\t\t\tif ($.trim(wrapperHtml) == '')\n\t\t\t\t\t{\n\t\t\t\t\t\ttmpLi.append(wrapperHtml + '<span id=\"selection-marker-1\">' + this.opts.invisibleSpace + '</span>');\n\t\t\t\t\t\ttmpList.append(tmpLi);\n\t\t\t\t\t\tthis.$editor.find('#selection-marker-1').replaceWith(tmpList);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\ttmpLi.append(wrapperHtml);\n\t\t\t\t\t\ttmpList.append(tmpLi);\n\t\t\t\t\t\t$(wrapper).replaceWith(tmpList);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.document.execCommand(cmd);\n\t\t\t\t}\n\n\t\t\t\tvar parent = this.getParent();\n\t\t\t\tvar $list = $(parent).closest('ol, ul');\n\n\t\t\t\tif (this.opts.linebreaks === false)\n\t\t\t\t{\n\t\t\t\t\tvar listText = $.trim($list.text());\n\t\t\t\t\tif (listText == '')\n\t\t\t\t\t{\n\t\t\t\t\t\t$list.children('li').find('br').remove();\n\t\t\t\t\t\t$list.children('li').append('<span id=\"selection-marker-1\">' + this.opts.invisibleSpace + '</span>');\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (firstParent.length != 0)\n\t\t\t\t{\n\t\t\t\t\t$list.wrapAll('<td>');\n\t\t\t\t}\n\n\t\t\t\tif ($list.length)\n\t\t\t\t{\n\n\t\t\t\t\tvar $listParent = $list.parent();\n\t\t\t\t\tif (this.isParentRedactor($listParent) && $listParent[0].tagName != 'LI' && this.nodeTestBlocks($listParent[0]))\n\t\t\t\t\t{\n\t\t\t\t\t\t$listParent.replaceWith($listParent.contents());\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (this.browser('mozilla'))\n\t\t\t\t{\n\t\t\t\t\tthis.$editor.focus();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.selectionRestore();\n\t\t\tthis.$editor.find('#selection-marker-1').removeAttr('id');\n\t\t\tthis.sync();\n\t\t\tthis.callback('execCommand', cmd, param);\n\t\t\treturn;\n\t\t},\n\t\tindentingIndent: function()\n\t\t{\n\t\t\tthis.indentingStart('indent');\n\t\t},\n\t\tindentingOutdent: function()\n\t\t{\n\t\t\tthis.indentingStart('outdent');\n\t\t},\n\t\tindentingStart: function(cmd)\n\t\t{\n\t\t\tthis.bufferSet();\n\n\t\t\tif (cmd === 'indent')\n\t\t\t{\n\t\t\t\tvar block = this.getBlock();\n\n\t\t\t\tthis.selectionSave();\n\n\t\t\t\tif (block && block.tagName == 'LI')\n\t\t\t\t{\n\n\t\t\t\t\tvar parent = this.getParent();\n\n\t\t\t\t\tvar $list = $(parent).closest('ol, ul');\n\t\t\t\t\tvar listTag = $list[0].tagName;\n\n\t\t\t\t\tvar elems = this.getBlocks();\n\n\t\t\t\t\t$.each(elems, function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (s.tagName == 'LI')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar $prev = $(s).prev();\n\t\t\t\t\t\t\tif ($prev.length != 0 && $prev[0].tagName == 'LI')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tvar $childList = $prev.children('ul, ol');\n\t\t\t\t\t\t\t\tif ($childList.length == 0)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t$prev.append($('<' + listTag + '>').append(s));\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse $childList.append(s);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\telse if (block === false && this.opts.linebreaks === true)\n\t\t\t\t{\n\t\t\t\t\tthis.exec('formatBlock', 'blockquote');\n\t\t\t\t\tvar newblock = this.getBlock();\n\t\t\t\t\tvar block = $('<div data-tagblock=\"\">').html($(newblock).html());\n\t\t\t\t\t$(newblock).replaceWith(block);\n\n\t\t\t\t\tvar left = this.normalize($(block).css('margin-left')) + this.opts.indentValue;\n\t\t\t\t\t$(block).css('margin-left', left + 'px');\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\n\t\t\t\t\tvar elements = this.getBlocks();\n\t\t\t\t\t$.each(elements, $.proxy(function(i, elem)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $el = false;\n\n\t\t\t\t\t\tif (elem.tagName === 'TD') return;\n\n\t\t\t\t\t\tif ($.inArray(elem.tagName, this.opts.alignmentTags) !== -1)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$el = $(elem);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$el = $(elem).closest(this.opts.alignmentTags.toString().toLowerCase(), this.$editor[0]);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tvar left = this.normalize($el.css('margin-left')) + this.opts.indentValue;\n\t\t\t\t\t\t$el.css('margin-left', left + 'px');\n\n\t\t\t\t\t}, this));\n\t\t\t\t}\n\n\t\t\t\tthis.selectionRestore();\n\n\t\t\t}\n\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.selectionSave();\n\n\t\t\t\tvar block = this.getBlock();\n\t\t\t\tif (block && block.tagName == 'LI')\n\t\t\t\t{\n\n\t\t\t\t\tvar elems = this.getBlocks();\n\t\t\t\t\tvar index = 0;\n\n\t\t\t\t\tthis.insideOutdent(block, index, elems);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\n\t\t\t\t\tvar elements = this.getBlocks();\n\t\t\t\t\t$.each(elements, $.proxy(function(i, elem)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $el = false;\n\n\t\t\t\t\t\tif ($.inArray(elem.tagName, this.opts.alignmentTags) !== -1)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$el = $(elem);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$el = $(elem).closest(this.opts.alignmentTags.toString().toLowerCase(), this.$editor[0]);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tvar left = this.normalize($el.css('margin-left')) - this.opts.indentValue;\n\t\t\t\t\t\tif (left <= 0)\n\t\t\t\t\t\t{\n\n\t\t\t\t\t\t\tif (this.opts.linebreaks === true && typeof($el.data('tagblock')) !== 'undefined')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$el.replaceWith($el.html() + '<br>');\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$el.css('margin-left', '');\n\t\t\t\t\t\t\t\tthis.removeEmptyAttr($el, 'style');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$el.css('margin-left', left + 'px');\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}, this));\n\t\t\t\t}\n\t\t\t\tthis.selectionRestore();\n\t\t\t}\n\n\t\t\tthis.sync();\n\n\t\t},\n\t\tinsideOutdent: function (li, index, elems)\n\t\t{\n\t\t\tif (li && li.tagName == 'LI')\n\t\t\t{\n\t\t\t\tvar $parent = $(li).parent().parent();\n\t\t\t\tif ($parent.length != 0 && $parent[0].tagName == 'LI')\n\t\t\t\t{\n\t\t\t\t\t$parent.after(li);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tif (typeof elems[index] != 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\tli = elems[index];\n\t\t\t\t\t\tindex++;\n\n\t\t\t\t\t\tthis.insideOutdent(li, index, elems);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.execCommand('insertunorderedlist');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\talignmentLeft: function()\n\t\t{\n\t\t\tthis.alignmentSet('', 'JustifyLeft');\n\t\t},\n\t\talignmentRight: function()\n\t\t{\n\t\t\tthis.alignmentSet('right', 'JustifyRight');\n\t\t},\n\t\talignmentCenter: function()\n\t\t{\n\t\t\tthis.alignmentSet('center', 'JustifyCenter');\n\t\t},\n\t\talignmentJustify: function()\n\t\t{\n\t\t\tthis.alignmentSet('justify', 'JustifyFull');\n\t\t},\n\t\talignmentSet: function(type, cmd)\n\t\t{\n\t\t\tthis.bufferSet();\n\n\t\t\tif (this.oldIE())\n\t\t\t{\n\t\t\t\tthis.document.execCommand(cmd, false, false);\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\tthis.selectionSave();\n\n\t\t\tvar block = this.getBlock();\n\t\t\tif (!block && this.opts.linebreaks)\n\t\t\t{\n\n\t\t\t\tthis.exec('formatblock', 'div');\n\n\t\t\t\tvar newblock = this.getBlock();\n\t\t\t\tvar block = $('<div data-tagblock=\"\">').html($(newblock).html());\n\t\t\t\t$(newblock).replaceWith(block);\n\n\t\t\t\t$(block).css('text-align', type);\n\t\t\t\tthis.removeEmptyAttr(block, 'style');\n\n\t\t\t\tif (type == '' && typeof($(block).data('tagblock')) !== 'undefined')\n\t\t\t\t{\n\t\t\t\t\t$(block).replaceWith($(block).html());\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tvar elements = this.getBlocks();\n\t\t\t\t$.each(elements, $.proxy(function(i, elem)\n\t\t\t\t{\n\t\t\t\t\tvar $el = false;\n\n\t\t\t\t\tif ($.inArray(elem.tagName, this.opts.alignmentTags) !== -1)\n\t\t\t\t\t{\n\t\t\t\t\t\t$el = $(elem);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t$el = $(elem).closest(this.opts.alignmentTags.toString().toLowerCase(), this.$editor[0]);\n\t\t\t\t\t}\n\n\t\t\t\t\tif ($el)\n\t\t\t\t\t{\n\t\t\t\t\t\t$el.css('text-align', type);\n\t\t\t\t\t\tthis.removeEmptyAttr($el, 'style');\n\t\t\t\t\t}\n\n\t\t\t\t}, this));\n\t\t\t}\n\n\t\t\tthis.selectionRestore();\n\t\t\tthis.sync();\n\t\t},\n\t\tcleanEmpty: function(html)\n\t\t{\n\t\t\tvar ph = this.placeholderStart(html);\n\t\t\tif (ph !== false) return ph;\n\n\t\t\tif (this.opts.linebreaks === false)\n\t\t\t{\n\t\t\t\tif (html === '') html = this.opts.emptyHtml;\n\t\t\t\telse if (html.search(/^<hr\\s?\\/?>$/gi) !== -1) html = '<hr>' + this.opts.emptyHtml;\n\t\t\t}\n\n\t\t\treturn html;\n\t\t},\n\t\tcleanConverters: function(html)\n\t\t{\n\n\t\t\tif (this.opts.convertDivs && !this.opts.gallery)\n\t\t\t{\n\t\t\t\thtml = html.replace(/<div(.*?)>([\\w\\W]*?)<\\/div>/gi, '<p$1>$2</p>');\n\t\t\t}\n\n\t\t\tif (this.opts.paragraphy) html = this.cleanParagraphy(html);\n\n\t\t\treturn html;\n\t\t},\n\t\tcleanConvertProtected: function(html)\n\t\t{\n\t\t\tif (this.opts.templateVars)\n\t\t\t{\n\t\t\t\thtml = html.replace(/\\{\\{(.*?)\\}\\}/gi, '<!-- template double $1 -->');\n\t\t\t\thtml = html.replace(/\\{(.*?)\\}/gi, '<!-- template $1 -->');\n\t\t\t}\n\n\t\t\thtml = html.replace(/<script(.*?)>([\\w\\W]*?)<\\/script>/gi, '<title type=\"text/javascript\" style=\"display: none;\" class=\"redactor-script-tag\"$1>$2</title>');\n\t\t\thtml = html.replace(/<style(.*?)>([\\w\\W]*?)<\\/style>/gi, '<section$1 style=\"display: none;\" rel=\"redactor-style-tag\">$2</section>');\n\t\t\thtml = html.replace(/<form(.*?)>([\\w\\W]*?)<\\/form>/gi, '<section$1 rel=\"redactor-form-tag\">$2</section>');\n\t\t\tif (this.opts.phpTags) html = html.replace(/<\\?php([\\w\\W]*?)\\?>/gi, '<section style=\"display: none;\" rel=\"redactor-php-tag\">$1</section>');\n\t\t\telse html = html.replace(/<\\?php([\\w\\W]*?)\\?>/gi, '');\n\n\t\t\treturn html;\n\t\t},\n\t\tcleanReConvertProtected: function(html)\n\t\t{\n\t\t\tif (this.opts.templateVars)\n\t\t\t{\n\t\t\t\thtml = html.replace(/<!-- template double (.*?) -->/gi, '{{$1}}');\n\t\t\t\thtml = html.replace(/<!-- template (.*?) -->/gi, '{$1}');\n\t\t\t}\n\n\t\t\thtml = html.replace(/<title type=\"text\\/javascript\" style=\"display: none;\" class=\"redactor-script-tag\"(.*?)>([\\w\\W]*?)<\\/title>/gi, '<script$1 type=\"text/javascript\">$2</script>');\n\t\t\thtml = html.replace(/<section(.*?) style=\"display: none;\" rel=\"redactor-style-tag\">([\\w\\W]*?)<\\/section>/gi, '<style$1>$2</style>');\n\t\t\thtml = html.replace(/<section(.*?)rel=\"redactor-form-tag\"(.*?)>([\\w\\W]*?)<\\/section>/gi, '<form$1$2>$3</form>');\n\t\t\tif (this.opts.phpTags) html = html.replace(/<section style=\"display: none;\" rel=\"redactor-php-tag\">([\\w\\W]*?)<\\/section>/gi, '<?php\\r\\n$1\\r\\n?>');\n\n\t\t\treturn html;\n\t\t},\n\t\tcleanRemoveSpaces: function(html, buffer)\n\t\t{\n\t\t\tif (buffer !== false)\n\t\t\t{\n\t\t\t\tvar buffer = []\n\t\t\t\tvar matches = html.match(/<(code|style|script|title)(.*?)>([\\w\\W]*?)<\\/(code|style|script|title)>/gi);\n\t\t\t\tif (matches === null) matches = [];\n\n\t\t\t\tif (this.opts.phpTags)\n\t\t\t\t{\n\t\t\t\t\tvar phpMatches = html.match(/<\\?php([\\w\\W]*?)\\?>/gi);\n\t\t\t\t\tif (phpMatches) matches = $.merge(matches, phpMatches);\n\t\t\t\t}\n\n\t\t\t\tif (matches)\n\t\t\t\t{\n\t\t\t\t\t$.each(matches, function(i, s)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(s, 'buffer_' + i);\n\t\t\t\t\t\tbuffer.push(s);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\thtml = html.replace(/\\n/g, ' ');\n\t\t\thtml = html.replace(/[\\t]*/g, '');\n\t\t\thtml = html.replace(/\\n\\s*\\n/g, \"\\n\");\n\t\t\thtml = html.replace(/^[\\s\\n]*/g, ' ');\n\t\t\thtml = html.replace(/[\\s\\n]*$/g, ' ');\n\t\t\thtml = html.replace( />\\s{2,}</g, '> <');\n\n\t\t\thtml = this.cleanReplacer(html, buffer);\n\n\t\t\thtml = html.replace(/\\n\\n/g, \"\\n\");\n\n\t\t\treturn html;\n\t\t},\n\t\tcleanReplacer: function(html, buffer)\n\t\t{\n\t\t\tif (buffer === false) return html;\n\n\t\t\t$.each(buffer, function(i,s)\n\t\t\t{\n\t\t\t\thtml = html.replace('buffer_' + i, s);\n\t\t\t});\n\n\t\t\treturn html;\n\t\t},\n\t\tcleanRemoveEmptyTags: function(html)\n\t\t{\n\n\t\t\thtml = html.replace(/[\\u200B-\\u200D\\uFEFF]/g, '');\n\n\t\t\tvar etagsInline = [\"<b>\\\\s*</b>\", \"<b>&nbsp;</b>\", \"<em>\\\\s*</em>\"]\n\t\t\tvar etags = [\"<code></code>\", \"<blockquote>\\\\s*</blockquote>\", \"<dd></dd>\", \"<dt></dt>\", \"<ul></ul>\", \"<ol></ol>\", \"<li></li>\", \"<table></table>\", \"<tr></tr>\", \"<span>\\\\s*<span>\", \"<span>&nbsp;<span>\", \"<p>\\\\s*</p>\", \"<p></p>\", \"<p>&nbsp;</p>\",  \"<p>\\\\s*<br>\\\\s*</p>\", \"<div>\\\\s*</div>\", \"<div>\\\\s*<br>\\\\s*</div>\"];\n\n\t\t\tif (this.opts.removeEmptyTags)\n\t\t\t{\n\t\t\t\tetags = etags.concat(etagsInline);\n\t\t\t}\n\t\t\telse etags = etagsInline;\n\n\t\t\tvar len = etags.length;\n\t\t\tfor (var i = 0; i < len; ++i)\n\t\t\t{\n\t\t\t\thtml = html.replace(new RegExp(etags[i], 'gi'), \"\");\n\t\t\t}\n\n\t\t\treturn html;\n\t\t},\n\t\tcleanParagraphy: function(html)\n\t\t{\n\t\t\thtml = $.trim(html);\n\n\t\t\tif (this.opts.linebreaks === true) return html;\n\t\t\tif (html === '' || html === '<p></p>') return this.opts.emptyHtml;\n\n\t\t\thtml = html + \"\\n\";\n\n\t\t\tif (this.opts.removeEmptyTags === false)\n\t\t\t{\n\t\t\t\treturn html;\n\t\t\t}\n\n\t\t\tvar safes = [];\n\t\t\tvar matches = html.match(/<(table|div|code|object)(.*?)>([\\w\\W]*?)<\\/(table|div|code|object)>/gi);\n\t\t\tif (!matches) matches = [];\n\n\t\t\tvar commentsMatches = html.match(/<!--([\\w\\W]*?)-->/gi);\n\t\t\tif (commentsMatches) matches = $.merge(matches, commentsMatches);\n\n\t\t\tif (this.opts.phpTags)\n\t\t\t{\n\t\t\t\tvar phpMatches = html.match(/<section(.*?)rel=\"redactor-php-tag\">([\\w\\W]*?)<\\/section>/gi);\n\t\t\t\tif (phpMatches) matches = $.merge(matches, phpMatches);\n\t\t\t}\n\n\t\t\tif (matches)\n\t\t\t{\n\t\t\t\t$.each(matches, function(i,s)\n\t\t\t\t{\n\t\t\t\t\tsafes[i] = s;\n\t\t\t\t\thtml = html.replace(s, '{replace' + i + '}\\n');\n\t\t\t\t});\n\t\t\t}\n\n\t\t\thtml = html.replace(/<br \\/>\\s*<br \\/>/gi, \"\\n\\n\");\n\t\t\thtml = html.replace(/<br><br>/gi, \"\\n\\n\");\n\n\t\t\tfunction R(str, mod, r)\n\t\t\t{\n\t\t\t\treturn html.replace(new RegExp(str, mod), r);\n\t\t\t}\n\n\t\t\tvar blocks = '(comment|html|body|head|title|meta|style|script|link|iframe|table|thead|tfoot|caption|col|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|code|select|option|form|map|area|blockquote|address|math|style|p|h[1-6]|hr|fieldset|legend|section|article|aside|hgroup|header|footer|nav|figure|figcaption|details|menu|summary)';\n\n\t\t\thtml = R('(<' + blocks + '[^>]*>)', 'gi', \"\\n$1\");\n\t\t\thtml = R('(</' + blocks + '>)', 'gi', \"$1\\n\\n\");\n\t\t\thtml = R(\"\\r\\n\", 'g', \"\\n\");\n\t\t\thtml = R(\"\\r\", 'g', \"\\n\");\n\t\t\thtml = R(\"/\\n\\n+/\", 'g', \"\\n\\n\");\n\n\t\t\tvar htmls = html.split(new RegExp('\\n\\s*\\n', 'g'), -1);\n\n\t\t\thtml = '';\n\t\t\tfor (var i in htmls)\n\t\t\t{\n\t\t\t\tif (htmls.hasOwnProperty(i))\n                {\n\t\t\t\t\tif (htmls[i].search('{replace') == -1)\n\t\t\t\t\t{\n\t\t\t\t\t\thtmls[i] = htmls[i].replace(/<p>\\n\\t?<\\/p>/gi, '');\n\t\t\t\t\t\thtmls[i] = htmls[i].replace(/<p><\\/p>/gi, '');\n\n\t\t\t\t\t\tif (htmls[i] != '')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\thtml += '<p>' +  htmls[i].replace(/^\\n+|\\n+$/g, \"\") + \"</p>\";\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse html += htmls[i];\n\t\t\t\t}\n\t\t\t}\n\n\t\t\thtml = R('<p><p>', 'gi', '<p>');\n\t\t\thtml = R('</p></p>', 'gi', '</p>');\n\n\t\t\thtml = R('<p>\\s?</p>', 'gi', '');\n\n\t\t\thtml = R('<p>([^<]+)</(div|address|form)>', 'gi', \"<p>$1</p></$2>\");\n\n\t\t\thtml = R('<p>(</?' + blocks + '[^>]*>)</p>', 'gi', \"$1\");\n\t\t\thtml = R(\"<p>(<li.+?)</p>\", 'gi', \"$1\");\n\t\t\thtml = R('<p>\\s?(</?' + blocks + '[^>]*>)', 'gi', \"$1\");\n\n\t\t\thtml = R('(</?' + blocks + '[^>]*>)\\s?</p>', 'gi', \"$1\");\n\t\t\thtml = R('(</?' + blocks + '[^>]*>)\\s?<br />', 'gi', \"$1\");\n\t\t\thtml = R('<br />(\\s*</?(?:p|li|div|dl|dd|dt|th|code|td|ul|ol)[^>]*>)', 'gi', '$1');\n\t\t\thtml = R(\"\\n</p>\", 'gi', '</p>');\n\n\t\t\thtml = R('<li><p>', 'gi', '<li>');\n\t\t\thtml = R('</p></li>', 'gi', '</li>');\n\t\t\thtml = R('</li><p>', 'gi', '</li>');\n\t\t\thtml = R('<p>\\t?\\n?<p>', 'gi', '<p>');\n\t\t\thtml = R('</dt><p>', 'gi', '</dt>');\n\t\t\thtml = R('</dd><p>', 'gi', '</dd>');\n\t\t\thtml = R('<br></p></blockquote>', 'gi', '</blockquote>');\n\t\t\thtml = R('<p>\\t*</p>', 'gi', '');\n\t\t\t$.each(safes, function(i,s)\n\t\t\t{\n\t\t\t\thtml = html.replace('{replace' + i + '}', s);\n\t\t\t});\n\n\t\t\treturn $.trim(html);\n\t\t},\n\t\tcleanConvertInlineTags: function(html, set)\n\t\t{\n\t\t\tvar boldTag = 'strong';\n\t\t\tif (this.opts.boldTag === 'b') boldTag = 'b';\n\n\t\t\tvar italicTag = 'em';\n\t\t\tif (this.opts.italicTag === 'i') italicTag = 'i';\n\n\t\t\thtml = html.replace(/<span style=\"font-style: italic;\">([\\w\\W]*?)<\\/span>/gi, '<' + italicTag + '>$1</' + italicTag + '>');\n\t\t\thtml = html.replace(/<span style=\"font-weight: bold;\">([\\w\\W]*?)<\\/span>/gi, '<' + boldTag + '>$1</' + boldTag + '>');\n\t\t\tif (this.opts.boldTag === 'strong') html = html.replace(/<b>([\\w\\W]*?)<\\/b>/gi, '<strong>$1</strong>');\n\t\t\telse html = html.replace(/<strong>([\\w\\W]*?)<\\/strong>/gi, '<b>$1</b>');\n\n\t\t\tif (this.opts.italicTag === 'em') html = html.replace(/<i>([\\w\\W]*?)<\\/i>/gi, '<em>$1</em>');\n\t\t\telse html = html.replace(/<em>([\\w\\W]*?)<\\/em>/gi, '<i>$1</i>');\n\n\t\t\thtml = html.replace(/<span style=\"text-decoration: underline;\">([\\w\\W]*?)<\\/span>/gi, '<u>$1</u>');\n\n\t\t\tif (set !== true) html = html.replace(/<strike>([\\w\\W]*?)<\\/strike>/gi, '<del>$1</del>');\n\t\t\telse html = html.replace(/<del>([\\w\\W]*?)<\\/del>/gi, '<strike>$1</strike>');\n\n\t\t\treturn html;\n\t\t},\n\t\tcleanStripTags: function(html)\n\t\t{\n\t\t\tif (html == '' || typeof html == 'undefined') return html;\n\n\t\t\tvar allowed = false;\n\t\t\tif (this.opts.allowedTags !== false) allowed = true;\n\n\t\t\tvar arr = allowed === true ? this.opts.allowedTags : this.opts.deniedTags;\n\n\t\t\tvar tags = /<\\/?([a-z][a-z0-9]*)\\b[^>]*>/gi;\n\t\t\thtml = html.replace(tags, function ($0, $1)\n\t\t\t{\n\t\t\t\tif (allowed === true) return $.inArray($1.toLowerCase(), arr) > '-1' ? $0 : '';\n\t\t\t\telse return $.inArray($1.toLowerCase(), arr) > '-1' ? '' : $0;\n\t\t\t});\n\n\t\t\thtml = this.cleanConvertInlineTags(html);\n\n\t\t\treturn html;\n\n\t\t},\n\t\tcleanSavePreCode: function(html, encode)\n\t\t{\n\t\t\tvar pre = html.match(/<(pre|code)(.*?)>([\\w\\W]*?)<\\/(pre|code)>/gi);\n\t\t\tif (pre !== null)\n\t\t\t{\n\t\t\t\t$.each(pre, $.proxy(function(i,s)\n\t\t\t\t{\n\t\t\t\t\tvar arr = s.match(/<(pre|code)(.*?)>([\\w\\W]*?)<\\/(pre|code)>/i);\n\n\t\t\t\t\tarr[3] = arr[3].replace(/&nbsp;/g, ' ');\n\n\t\t\t\t\tif (encode !== false) arr[3] = this.cleanEncodeEntities(arr[3]);\n\n\t\t\t\t\tarr[3] = arr[3].replace(/\\$/g, '&#36;');\n\n\t\t\t\t\thtml = html.replace(s, '<' + arr[1] + arr[2] + '>' + arr[3] + '</' + arr[1] + '>');\n\n\t\t\t\t}, this));\n\t\t\t}\n\n\t\t\treturn html;\n\t\t},\n\t\tcleanEncodeEntities: function(str)\n\t\t{\n\t\t\tstr = String(str).replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '\"');\n\t\t\treturn str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;');\n\t\t},\n\t\tcleanUnverified: function()\n\t\t{\n\n\t\t\tvar $elem = this.$editor.find('li, img, a, b, strong, sub, sup, i, em, u, small, strike, del, span, cite');\n\n\t\t\t$elem.filter('[style*=\"background-color: transparent;\"][style*=\"line-height\"]')\n\t\t\t.css('background-color', '')\n\t\t\t.css('line-height', '');\n\n\t\t\t$elem.filter('[style*=\"background-color: transparent;\"]')\n\t\t\t.css('background-color', '');\n\n\t\t\t$elem.css('line-height', '');\n\n\t\t\t$.each($elem, $.proxy(function(i,s)\n\t\t\t{\n\t\t\t\tthis.removeEmptyAttr(s, 'style');\n\t\t\t}, this));\n\n\t\t\tvar $elem2 = this.$editor.find('b, strong, i, em, u, strike, del');\n\t\t\t$elem2.css('font-size', '');\n\n\t\t\t$.each($elem2, $.proxy(function(i,s)\n\t\t\t{\n\t\t\t\tthis.removeEmptyAttr(s, 'style');\n\t\t\t}, this));\n\t\t\tthis.$editor.find('div[style=\"text-align: -webkit-auto;\"]').contents().unwrap();\n\t\t\tthis.$editor.find('ul, ol, li').removeAttr('style');\n\t\t},\n\n\t\tcleanHtml: function(code)\n\t\t{\n\t\t\tvar i = 0,\n\t\t\tcodeLength = code.length,\n\t\t\tpoint = 0,\n\t\t\tstart = null,\n\t\t\tend = null,\n\t\t\ttag = '',\n\t\t\tout = '',\n\t\t\tcont = '';\n\n\t\t\tthis.cleanlevel = 0;\n\n\t\t\tfor (; i < codeLength; i++)\n\t\t\t{\n\t\t\t\tpoint = i;\n\t\t\t\tif (-1 == code.substr(i).indexOf( '<' ))\n\t\t\t\t{\n\t\t\t\t\tout += code.substr(i);\n\n\t\t\t\t\treturn this.cleanFinish(out);\n\t\t\t\t}\n\t\t\t\twhile (point < codeLength && code.charAt(point) != '<')\n\t\t\t\t{\n\t\t\t\t\tpoint++;\n\t\t\t\t}\n\n\t\t\t\tif (i != point)\n\t\t\t\t{\n\t\t\t\t\tcont = code.substr(i, point - i);\n\t\t\t\t\tif (!cont.match(/^\\s{2,}$/g))\n\t\t\t\t\t{\n\t\t\t\t\t\tif ('\\n' == out.charAt(out.length - 1)) out += this.cleanGetTabs();\n\t\t\t\t\t\telse if ('\\n' == cont.charAt(0))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tout += '\\n' + this.cleanGetTabs();\n\t\t\t\t\t\t\tcont = cont.replace(/^\\s+/, '');\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tout += cont;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (cont.match(/\\n/)) out += '\\n' + this.cleanGetTabs();\n\t\t\t\t}\n\n\t\t\t\tstart = point;\n\t\t\t\twhile (point < codeLength && '>' != code.charAt(point))\n\t\t\t\t{\n\t\t\t\t\tpoint++;\n\t\t\t\t}\n\n\t\t\t\ttag = code.substr(start, point - start);\n\t\t\t\ti = point;\n\n\t\t\t\tvar t;\n\n\t\t\t\tif ('!--' == tag.substr(1, 3))\n\t\t\t\t{\n\t\t\t\t\tif (!tag.match(/--$/))\n\t\t\t\t\t{\n\t\t\t\t\t\twhile ('-->' != code.substr(point, 3))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tpoint++;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tpoint += 2;\n\t\t\t\t\t\ttag = code.substr(start, point - start);\n\t\t\t\t\t\ti = point;\n\t\t\t\t\t}\n\n\t\t\t\t\tif ('\\n' != out.charAt(out.length - 1)) out += '\\n';\n\n\t\t\t\t\tout += this.cleanGetTabs();\n\t\t\t\t\tout += tag + '>\\n';\n\t\t\t\t}\n\t\t\t\telse if ('!' == tag[1])\n\t\t\t\t{\n\t\t\t\t\tout = this.placeTag(tag + '>', out);\n\t\t\t\t}\n\t\t\t\telse if ('?' == tag[1])\n\t\t\t\t{\n\t\t\t\t\tout += tag + '>\\n';\n\t\t\t\t}\n\t\t\t\telse if (t = tag.match(/^<(script|style|pre|code)/i))\n\t\t\t\t{\n\t\t\t\t\tt[1] = t[1].toLowerCase();\n\t\t\t\t\ttag = this.cleanTag(tag);\n\t\t\t\t\tout = this.placeTag(tag, out);\n\t\t\t\t\tend = String(code.substr(i + 1)).toLowerCase().indexOf('</' + t[1]);\n\n\t\t\t\t\tif (end)\n\t\t\t\t\t{\n\t\t\t\t\t\tcont = code.substr(i + 1, end);\n\t\t\t\t\t\ti += end;\n\t\t\t\t\t\tout += cont;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\ttag = this.cleanTag(tag);\n\t\t\t\t\tout = this.placeTag(tag, out);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn this.cleanFinish(out);\n\t\t},\n\t\tcleanGetTabs: function()\n\t\t{\n\t\t\tvar s = '';\n\t\t\tfor ( var j = 0; j < this.cleanlevel; j++ )\n\t\t\t{\n\t\t\t\ts += '\\t';\n\t\t\t}\n\n\t\t\treturn s;\n\t\t},\n\t\tcleanFinish: function(code)\n\t\t{\n\t\t\tcode = code.replace(/\\n\\s*\\n/g, '\\n');\n\t\t\tcode = code.replace(/^[\\s\\n]*/, '');\n\t\t\tcode = code.replace(/[\\s\\n]*$/, '');\n\t\t\tcode = code.replace(/<script(.*?)>\\n<\\/script>/gi, '<script$1></script>');\n\n\t\t\tthis.cleanlevel = 0;\n\n\t\t\treturn code;\n\t\t},\n\t\tcleanTag: function (tag)\n\t\t{\n\t\t\tvar tagout = '';\n\t\t\ttag = tag.replace(/\\n/g, ' ');\n\t\t\ttag = tag.replace(/\\s{2,}/g, ' ');\n\t\t\ttag = tag.replace(/^\\s+|\\s+$/g, ' ');\n\n\t\t\tvar suffix = '';\n\t\t\tif (tag.match(/\\/$/))\n\t\t\t{\n\t\t\t\tsuffix = '/';\n\t\t\t\ttag = tag.replace(/\\/+$/, '');\n\t\t\t}\n\n\t\t\tvar m;\n\t\t\twhile (m = /\\s*([^= ]+)(?:=((['\"']).*?\\3|[^ ]+))?/.exec(tag))\n\t\t\t{\n\t\t\t\tif (m[2]) tagout += m[1].toLowerCase() + '=' + m[2];\n\t\t\t\telse if (m[1]) tagout += m[1].toLowerCase();\n\n\t\t\t\ttagout += ' ';\n\t\t\t\ttag = tag.substr(m[0].length);\n\t\t\t}\n\n\t\t\treturn tagout.replace(/\\s*$/, '') + suffix + '>';\n\t\t},\n\t\tplaceTag: function (tag, out)\n\t\t{\n\t\t\tvar nl = tag.match(this.cleannewLevel);\n\t\t\tif (tag.match(this.cleanlineBefore) || nl)\n\t\t\t{\n\t\t\t\tout = out.replace(/\\s*$/, '');\n\t\t\t\tout += '\\n';\n\t\t\t}\n\n\t\t\tif (nl && '/' == tag.charAt(1)) this.cleanlevel--;\n\t\t\tif ('\\n' == out.charAt(out.length - 1)) out += this.cleanGetTabs();\n\t\t\tif (nl && '/' != tag.charAt(1)) this.cleanlevel++;\n\n\t\t\tout += tag;\n\n\t\t\tif (tag.match(this.cleanlineAfter) || tag.match(this.cleannewLevel))\n\t\t\t{\n\t\t\t\tout = out.replace(/ *$/, '');\n\t\t\t\tout += '\\n';\n\t\t\t}\n\n\t\t\treturn out;\n\t\t},\n\t\tformatEmpty: function(e)\n\t\t{\n\t\t\tvar html = $.trim(this.$editor.html());\n\n\t\t\tif (this.opts.linebreaks)\n\t\t\t{\n\t\t\t\tif (html == '')\n\t\t\t\t{\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\tthis.$editor.html('');\n\t\t\t\t\tthis.focus();\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\thtml = html.replace(/<br\\s?\\/?>/i, '');\n\t\t\t\tvar thtml = html.replace(/<p>\\s?<\\/p>/gi, '');\n\n\t\t\t\tif (html === '' || thtml === '')\n\t\t\t\t{\n\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\tvar node = $(this.opts.emptyHtml).get(0);\n\t\t\t\t\tthis.$editor.html(node);\n\t\t\t\t\tthis.focus();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.sync();\n\t\t},\n\t\tformatBlocks: function(tag)\n\t\t{\n\t\t\tif (this.browser('mozilla') && this.isFocused())\n\t\t\t{\n\t\t\t\tthis.$editor.focus();\n\t\t\t}\n\n\t\t\tthis.bufferSet();\n\n\t\t\tvar nodes = this.getBlocks();\n\t\t\tthis.selectionSave();\n\n\t\t\t$.each(nodes, $.proxy(function(i, node)\n\t\t\t{\n\t\t\t\tif (node.tagName !== 'LI')\n\t\t\t\t{\n\t\t\t\t\tvar parent = $(node).parent();\n\n\t\t\t\t\tif (tag === 'p')\n\t\t\t\t\t{\n\t\t\t\t\t\tif ((node.tagName === 'P'\n\t\t\t\t\t\t&& parent.length != 0\n\t\t\t\t\t\t&& parent[0].tagName === 'BLOCKQUOTE')\n\t\t\t\t\t\t||\n\t\t\t\t\t\tnode.tagName === 'BLOCKQUOTE')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.formatQuote();\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (this.opts.linebreaks)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif (node && node.tagName.search(/H[1-6]/) == 0)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$(node).replaceWith(node.innerHTML + '<br>');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse return;\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.formatBlock(tag, node);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.formatBlock(tag, node);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t}, this));\n\n\t\t\tthis.selectionRestore();\n\t\t\tthis.sync();\n\t\t},\n\t\tformatBlock: function(tag, block)\n\t\t{\n\t\t\tif (block === false) block = this.getBlock();\n\t\t\tif (block === false && this.opts.linebreaks === true)\n\t\t\t{\n\t\t\t\tthis.execCommand('formatblock', tag);\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\tvar contents = '';\n\t\t\tif (tag !== 'code')\n\t\t\t{\n\t\t\t\tcontents = $(block).contents();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\n\t\t\t\tcontents = $(block).html();\n\t\t\t\tif ($.trim(contents) === '')\n\t\t\t\t{\n\t\t\t\t\tcontents = '<span id=\"selection-marker-1\"></span>';\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (block.tagName === 'CODE') tag = 'p';\n\n\t\t\tif (this.opts.linebreaks === true && tag === 'p')\n\t\t\t{\n\t\t\t\t$(block).replaceWith($('<div>').append(contents).html() + '<br>');\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tvar parent = this.getParent();\n\n\t\t\t\tvar node = $('<' + tag + '>').append(contents);\n\t\t\t\t$(block).replaceWith(node);\n\n\t\t\t\tif (parent && parent.tagName == 'TD')\n\t\t\t\t{\n\t\t\t\t\t$(node).wrapAll('<td>');\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\tformatChangeTag: function(fromElement, toTagName, save)\n\t\t{\n\t\t\tif (save !== false) this.selectionSave();\n\n\t\t\tvar newElement = $('<' + toTagName + '/>');\n\t\t\t$(fromElement).replaceWith(function() { return newElement.append($(this).contents()); });\n\n\t\t\tif (save !== false) this.selectionRestore();\n\n\t\t\treturn newElement;\n\t\t},\n\t\tformatQuote: function()\n\t\t{\n\t\t\tif (this.browser('mozilla') && this.isFocused())\n\t\t\t{\n\t\t\t\tthis.$editor.focus();\n\t\t\t}\n\n\t\t\tthis.bufferSet();\n\t\t\tif (this.opts.linebreaks === false)\n\t\t\t{\n\t\t\t\tthis.selectionSave();\n\n\t\t\t\tvar blocks = this.getBlocks();\n\n\t\t\t\tvar blockquote = false;\n\t\t\t\tvar blocksLen = blocks.length;\n\t\t\t\tif (blocks)\n\t\t\t\t{\n\t\t\t\t\tvar data = '';\n\t\t\t\t\tvar replaced = '';\n\t\t\t\t\tvar replace = false;\n\t\t\t\t\tvar paragraphsOnly = true;\n\n\t\t\t\t\t$.each(blocks, function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (s.tagName !== 'P') paragraphsOnly = false;\n\t\t\t\t\t});\n\n\t\t\t\t\t$.each(blocks, $.proxy(function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (s.tagName === 'BLOCKQUOTE')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.formatBlock('p', s, false);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (s.tagName === 'P')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tblockquote = $(s).parent();\n\n\t\t\t\t\t\t\tif (blockquote[0].tagName == 'BLOCKQUOTE')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tvar count = $(blockquote).children('p').length;\n\t\t\t\t\t\t\t\tif (count == 1)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t$(blockquote).replaceWith(s);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\telse if (count == blocksLen)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\treplace = 'blockquote';\n\t\t\t\t\t\t\t\t\tdata += this.outerHtml(s);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\treplace = 'html';\n\t\t\t\t\t\t\t\t\tdata += this.outerHtml(s);\n\n\t\t\t\t\t\t\t\t\tif (i == 0)\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t$(s).addClass('redactor-replaced').empty();\n\t\t\t\t\t\t\t\t\t\treplaced = this.outerHtml(s);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\telse $(s).remove();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tif (paragraphsOnly === false || blocks.length == 1)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tthis.formatBlock('blockquote', s, false);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\treplace = 'paragraphs';\n\t\t\t\t\t\t\t\t\tdata += this.outerHtml(s);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (s.tagName !== 'LI')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.formatBlock('blockquote', s, false);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t\tif (replace)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (replace == 'paragraphs')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$(blocks[0]).replaceWith('<blockquote>' + data + '</blockquote>');\n\t\t\t\t\t\t\t$(blocks).remove();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (replace == 'blockquote')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$(blockquote).replaceWith(data);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (replace == 'html')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar html = this.$editor.html().replace(replaced, '</blockquote>' + data + '<blockquote>');\n\n\t\t\t\t\t\t\tthis.$editor.html(html);\n\t\t\t\t\t\t\tthis.$editor.find('blockquote').each(function()\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tif ($.trim($(this).html()) == '') $(this).remove();\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tthis.selectionRestore();\n\t\t\t}\n\n\t\t\telse\n\t\t\t{\n\t\t\t\tvar block = this.getBlock();\n\t\t\t\tif (block.tagName === 'BLOCKQUOTE')\n\t\t\t\t{\n\t\t\t\t\tthis.selectionSave();\n\n\t\t\t\t\tvar html = $.trim($(block).html());\n\t\t\t\t\tvar selection = $.trim(this.getSelectionHtml());\n\n\t\t\t\t\thtml = html.replace(/<span(.*?)id=\"selection-marker(.*?)<\\/span>/gi, '');\n\n\t\t\t\t\tif (html == selection)\n\t\t\t\t\t{\n\t\t\t\t\t\t$(block).replaceWith($(block).html() + '<br>');\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\n\t\t\t\t\t\tthis.inlineFormat('tmp');\n\t\t\t\t\t\tvar tmp = this.$editor.find('tmp');\n\t\t\t\t\t\ttmp.empty();\n\n\t\t\t\t\t\tvar newhtml = this.$editor.html().replace('<tmp></tmp>', '</blockquote><span id=\"selection-marker-1\">' + this.opts.invisibleSpace + '</span>' + selection + '<blockquote>');\n\n\t\t\t\t\t\tthis.$editor.html(newhtml);\n\t\t\t\t\t\ttmp.remove();\n\t\t\t\t\t\tthis.$editor.find('blockquote').each(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif ($.trim($(this).html()) == '') $(this).remove();\n\t\t\t\t\t\t})\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.selectionRestore();\n\t\t\t\t\tthis.$editor.find('span#selection-marker-1').attr('id', false);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tvar wrapper = this.selectionWrap('blockquote');\n\t\t\t\t\tvar html = $(wrapper).html();\n\n\t\t\t\t\tvar blocksElemsRemove = ['ul', 'ol', 'table', 'tr', 'tbody', 'thead', 'tfoot', 'dl'];\n\t\t\t\t\t$.each(blocksElemsRemove, function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(new RegExp('<' + s + '(.*?)>', 'gi'), '');\n\t\t\t\t\t\thtml = html.replace(new RegExp('</' + s + '>', 'gi'), '');\n\t\t\t\t\t});\n\n\t\t\t\t\tvar blocksElems = this.opts.blockLevelElements;\n\t\t\t\t\t$.each(blocksElems, function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(new RegExp('<' + s + '(.*?)>', 'gi'), '');\n\t\t\t\t\t\thtml = html.replace(new RegExp('</' + s + '>', 'gi'), '<br>');\n\t\t\t\t\t});\n\n\t\t\t\t\t$(wrapper).html(html);\n\t\t\t\t\tthis.selectionElement(wrapper);\n\t\t\t\t\tvar next = $(wrapper).next();\n\t\t\t\t\tif (next.length != 0 && next[0].tagName === 'BR')\n\t\t\t\t\t{\n\t\t\t\t\t\tnext.remove();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.sync();\n\t\t},\n\t\tblockRemoveAttr: function(attr, value)\n\t\t{\n\t\t\tvar nodes = this.getBlocks();\n\t\t\t$(nodes).removeAttr(attr);\n\n\t\t\tthis.sync();\n\t\t},\n\t\tblockSetAttr: function(attr, value)\n\t\t{\n\t\t\tvar nodes = this.getBlocks();\n\t\t\t$(nodes).attr(attr, value);\n\n\t\t\tthis.sync();\n\t\t},\n\t\tblockRemoveStyle: function(rule)\n\t\t{\n\t\t\tvar nodes = this.getBlocks();\n\t\t\t$(nodes).css(rule, '');\n\t\t\tthis.removeEmptyAttr(nodes, 'style');\n\n\t\t\tthis.sync();\n\t\t},\n\t\tblockSetStyle: function (rule, value)\n\t\t{\n\t\t\tvar nodes = this.getBlocks();\n\t\t\t$(nodes).css(rule, value);\n\n\t\t\tthis.sync();\n\t\t},\n\t\tblockRemoveClass: function(className)\n\t\t{\n\t\t\tvar nodes = this.getBlocks();\n\t\t\t$(nodes).removeClass(className);\n\t\t\tthis.removeEmptyAttr(nodes, 'class');\n\n\t\t\tthis.sync();\n\t\t},\n\t\tblockSetClass: function(className)\n\t\t{\n\t\t\tvar nodes = this.getBlocks();\n\t\t\t$(nodes).addClass(className);\n\n\t\t\tthis.sync();\n\t\t},\n\t\tinlineRemoveClass: function(className)\n\t\t{\n\t\t\tthis.selectionSave();\n\n\t\t\tthis.inlineEachNodes(function(node)\n\t\t\t{\n\t\t\t\t$(node).removeClass(className);\n\t\t\t\tthis.removeEmptyAttr(node, 'class');\n\t\t\t});\n\n\t\t\tthis.selectionRestore();\n\t\t\tthis.sync();\n\t\t},\n\t\tinlineSetClass: function(className)\n\t\t{\n\t\t\tvar current = this.getCurrent();\n\t\t\tif (!$(current).hasClass(className)) this.inlineMethods('addClass', className);\n\t\t},\n\t\tinlineRemoveStyle: function (rule)\n\t\t{\n\t\t\tthis.selectionSave();\n\n\t\t\tthis.inlineEachNodes(function(node)\n\t\t\t{\n\t\t\t\t$(node).css(rule, '');\n\t\t\t\tthis.removeEmptyAttr(node, 'style');\n\t\t\t});\n\n\t\t\tthis.selectionRestore();\n\t\t\tthis.sync();\n\t\t},\n\t\tinlineSetStyle: function(rule, value)\n\t\t{\n\t\t\tthis.inlineMethods('css', rule, value);\n\t\t},\n\t\tinlineRemoveAttr: function (attr)\n\t\t{\n\t\t\tthis.selectionSave();\n\n\t\t\tvar range = this.getRange(), node = this.getElement(), nodes = this.getNodes();\n\n\t\t\tif (range.collapsed || range.startContainer === range.endContainer && node)\n\t\t\t{\n\t\t\t\tnodes = $( node );\n\t\t\t}\n\n\t\t\t$(nodes).removeAttr(attr);\n\n\t\t\tthis.inlineUnwrapSpan();\n\n\t\t\tthis.selectionRestore();\n\t\t\tthis.sync();\n\t\t},\n\t\tinlineSetAttr: function(attr, value)\n\t\t{\n\t\t\tthis.inlineMethods('attr', attr, value );\n\t\t},\n\t\tinlineMethods: function(type, attr, value)\n\t\t{\n\t\t\tthis.bufferSet();\n\t\t\tthis.selectionSave();\n\n\t\t\tvar range = this.getRange()\n\t\t\tvar el = this.getElement();\n\n\t\t\tif ((range.collapsed || range.startContainer === range.endContainer) && el && !this.nodeTestBlocks(el))\n\t\t\t{\n\t\t\t\t$(el)[type](attr, value);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tvar cmd, arg = value;\n\t\t\t\tswitch (attr)\n\t\t\t\t{\n\t\t\t\t\tcase 'font-size':\n\t\t\t\t\t\tcmd = 'fontSize';\n\t\t\t\t\t\targ = 4;\n\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'font-family':\n\t\t\t\t\t\tcmd = 'fontName';\n\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'color':\n\t\t\t\t\t\tcmd = 'foreColor';\n\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'background-color':\n\t\t\t\t\t\tcmd = 'backColor';\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\tthis.document.execCommand(cmd, false, arg);\n\n\t\t\t\tvar fonts = this.$editor.find('font');\n\t\t\t\t$.each(fonts, $.proxy(function(i, s)\n\t\t\t\t{\n\t\t\t\t\tthis.inlineSetMethods(type, s, attr, value);\n\n\t\t\t\t}, this));\n\n\t\t\t}\n\n\t\t\tthis.selectionRestore();\n\t\t\tthis.sync();\n\t\t},\n\t\tinlineSetMethods: function(type, s, attr, value)\n\t\t{\n\t\t\tvar parent = $(s).parent(), el;\n\n\t\t\tvar selectionHtml = this.getSelectionText();\n\t\t\tvar parentHtml = $(parent).text();\n\t\t\tvar selected = selectionHtml == parentHtml;\n\n\t\t\tif (selected && parent && parent[0].tagName === 'INLINE' && parent[0].attributes.length != 0)\n\t\t\t{\n\t\t\t\tel = parent;\n\t\t\t\t$(s).replaceWith($(s).html());\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tel = $('<inline>').append($(s).contents());\n\t\t\t\t$(s).replaceWith(el);\n\t\t\t}\n\t\t\t$(el)[type](attr, value);\n\n\t\t\treturn el;\n\t\t},\n\n\t\tinlineEachNodes: function(callback)\n\t\t{\n\t\t\tvar range = this.getRange(),\n\t\t\t\tnode = this.getElement(),\n\t\t\t\tnodes = this.getNodes(),\n\t\t\t\tcollapsed;\n\n\t\t\tif (range.collapsed || range.startContainer === range.endContainer && node)\n\t\t\t{\n\t\t\t\tnodes = $(node);\n\t\t\t\tcollapsed = true;\n\t\t\t}\n\n\t\t\t$.each(nodes, $.proxy(function(i, node)\n\t\t\t{\n\t\t\t\tif (!collapsed && node.tagName !== 'INLINE')\n\t\t\t\t{\n\t\t\t\t\tvar selectionHtml = this.getSelectionText();\n\t\t\t\t\tvar parentHtml = $(node).parent().text();\n\t\t\t\t\tvar selected = selectionHtml == parentHtml;\n\n\t\t\t\t\tif (selected && node.parentNode.tagName === 'INLINE' && !$(node.parentNode).hasClass('redactor_editor'))\n\t\t\t\t\t{\n\t\t\t\t\t\tnode = node.parentNode;\n\t\t\t\t\t}\n\t\t\t\t\telse return;\n\t\t\t\t}\n\t\t\t\tcallback.call(this, node);\n\n\t\t\t}, this ) );\n\t\t},\n\t\tinlineUnwrapSpan: function()\n\t\t{\n\t\t\tvar $spans = this.$editor.find('inline');\n\n\t\t\t$.each($spans, $.proxy(function(i, span)\n\t\t\t{\n\t\t\t\tvar $span = $(span);\n\n\t\t\t\tif ($span.attr('class') === undefined && $span.attr('style') === undefined)\n\t\t\t\t{\n\t\t\t\t\t$span.contents().unwrap();\n\t\t\t\t}\n\n\t\t\t}, this));\n\t\t},\n\t\tinlineFormat: function(tag)\n\t\t{\n\t\t\tthis.selectionSave();\n\n\t\t\tthis.document.execCommand('fontSize', false, 4 );\n\n\t\t\tvar fonts = this.$editor.find('font');\n\t\t\tvar last;\n\t\t\t$.each(fonts, function(i, s)\n\t\t\t{\n\t\t\t\tvar el = $('<' + tag + '/>').append($(s).contents());\n\t\t\t\t$(s).replaceWith(el);\n\t\t\t\tlast = el;\n\t\t\t});\n\n\t\t\tthis.selectionRestore();\n\n\t\t\tthis.sync();\n\t\t},\n\t\tinlineRemoveFormat: function(tag)\n\t\t{\n\t\t\tthis.selectionSave();\n\n\t\t\tvar utag = tag.toUpperCase();\n\t\t\tvar nodes = this.getNodes();\n\t\t\tvar parent = $(this.getParent()).parent();\n\n\t\t\t$.each(nodes, function(i, s)\n\t\t\t{\n\t\t\t\tif (s.tagName === utag) this.inlineRemoveFormatReplace(s);\n\t\t\t});\n\n\t\t\tif (parent && parent[0].tagName === utag) this.inlineRemoveFormatReplace(parent);\n\n\t\t\tthis.selectionRestore();\n\t\t\tthis.sync();\n\t\t},\n\t\tinlineRemoveFormatReplace: function(el)\n\t\t{\n\t\t\t$(el).replaceWith($(el).contents());\n\t\t},\n\n\t\tinsertHtml: function (html, sync)\n\t\t{\n\t\t\tvar current = this.getCurrent();\n\t\t\tvar parent = current.parentNode;\n\n\t\t\tthis.focusWithSaveScroll();\n\n\t\t\tthis.bufferSet();\n\n\t\t\tvar $html = $('<div>').append($.parseHTML(html));\n\t\t\thtml = $html.html();\n\n\t\t\thtml = this.cleanRemoveEmptyTags(html);\n\t\t\t$html = $('<div>').append($.parseHTML(html));\n\t\t\tvar currBlock = this.getBlock();\n\n\t\t\tif ($html.contents().length == 1)\n\t\t\t{\n\t\t\t\tvar htmlTagName = $html.contents()[0].tagName;\n\t\t\t\tif (htmlTagName != 'P' && htmlTagName == currBlock.tagName || htmlTagName == 'CODE')\n\t\t\t\t{\n\n\t\t\t\t\t$html = $('<div>').append(html);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (this.opts.linebreaks)\n\t\t\t{\n\t\t\t\thtml = html.replace(/<p(.*?)>([\\w\\W]*?)<\\/p>/gi, '$2<br>');\n\t\t\t}\n\t\t\tif (!this.opts.linebreaks && $html.contents().length == 1 && $html.contents()[0].nodeType == 3\n\t\t\t\t&& (this.getRangeSelectedNodes().length > 2 || (!current || current.tagName == 'BODY' && !parent || parent.tagName == 'HTML')))\n\t\t\t{\n\t\t\t\thtml = '<p>' + html + '</p>';\n\t\t\t}\n\n\t\t\thtml = this.setSpansVerifiedHtml(html);\n\n\t\t\tif ($html.contents().length > 1 && currBlock\n\t\t\t|| $html.contents().is('p, :header, ul, ol, li, div, table, td, blockquote, code, address, section, header, footer, aside, article'))\n\t\t\t{\n\t\t\t\tif (this.browser('msie'))\n\t\t\t\t{\n\t\t\t\t\tif (!this.isIe11())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.document.selection.createRange().pasteHTML(html);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.execPasteFrag(html);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.document.execCommand('inserthtml', false, html);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse this.insertHtmlAdvanced(html, false);\n\n\t\t\tif (this.selectall)\n\t\t\t{\n\t\t\t\tthis.window.setTimeout($.proxy(function()\n\t\t\t\t{\n\t\t\t\t\tif (!this.opts.linebreaks) this.selectionEnd(this.$editor.contents().last());\n\t\t\t\t\telse this.focusEnd();\n\n\t\t\t\t}, this), 1);\n\t\t\t}\n\n\t\t\tthis.observeStart();\n\t\t\tthis.setNonEditable();\n\n\t\t\tif (sync !== false) this.sync();\n\t\t},\n\t\tinsertHtmlAdvanced: function(html, sync)\n\t\t{\n\t\t\thtml = this.setSpansVerifiedHtml(html);\n\n\t\t\tvar sel = this.getSelection();\n\n\t\t\tif (sel.getRangeAt && sel.rangeCount)\n\t\t\t{\n\t\t\t\tvar range = sel.getRangeAt(0);\n\t\t\t\trange.deleteContents();\n\n\t\t\t\tvar el = document.createElement('div');\n\t\t\t\tel.innerHTML = html;\n\t\t\t\tvar frag = document.createDocumentFragment(), node, lastNode;\n\t\t\t\twhile ((node = el.firstChild))\n\t\t\t\t{\n\t\t\t\t\tlastNode = frag.appendChild(node);\n\t\t\t\t}\n\n\t\t\t\trange.insertNode(frag);\n\n\t\t\t\tif (lastNode)\n\t\t\t\t{\n\t\t\t\t\trange = range.cloneRange();\n\t\t\t\t\trange.setStartAfter(lastNode);\n\t\t\t\t\trange.collapse(true);\n\t\t\t\t\tsel.removeAllRanges();\n\t\t\t\t\tsel.addRange(range);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (sync !== false)\n\t\t\t{\n\t\t\t\tthis.sync();\n\t\t\t}\n\n\t\t},\n\t\tinsertBeforeCursor: function(html)\n\t\t{\n\t\t\thtml = this.setSpansVerifiedHtml(html);\n\n\t\t\tvar node = $(html);\n\n\t\t\tvar space = document.createElement(\"span\");\n\t\t\tspace.innerHTML = \"\\u200B\";\n\n\t\t\tvar range = this.getRange();\n\t\t\trange.insertNode(space);\n\t\t\trange.insertNode(node[0]);\n\t\t\trange.collapse(false);\n\n\t\t\tvar sel = this.getSelection();\n\t\t\tsel.removeAllRanges();\n\t\t\tsel.addRange(range);\n\n\t\t\tthis.sync();\n\t\t},\n\t\tinsertText: function(html)\n\t\t{\n\t\t\tvar $html = $($.parseHTML(html));\n\n\t\t\tif ($html.length) html = $html.text();\n\n\t\t\tthis.focusWithSaveScroll();\n\n\t\t\tif (this.browser('msie'))\n\t\t\t{\n\t\t\t\tif (!this.isIe11())\n\t\t\t\t{\n\t\t\t\t\tthis.document.selection.createRange().pasteHTML(html);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.execPasteFrag(html);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.document.execCommand('inserthtml', false, html);\n\t\t\t}\n\n\t\t\tthis.sync();\n\t\t},\n\t\tinsertNode: function(node)\n\t\t{\n\t\t\tnode = node[0] || node;\n\n\t\t\tif (node.tagName == 'SPAN')\n\t\t\t{\n\t\t\t\tvar replacementTag = 'inline';\n\n\t\t\t    var outer = node.outerHTML;\n\t\t\t    var regex = new RegExp('<' + node.tagName, 'i');\n\t\t\t    var newTag = outer.replace(regex, '<' + replacementTag);\n\t\t\t    regex = new RegExp('</' + node.tagName, 'i');\n\t\t\t    newTag = newTag.replace(regex, '</' + replacementTag);\n\t\t\t    node = $(newTag)[0];\n\t\t\t}\n\n\t\t\tvar sel = this.getSelection();\n\t\t\tif (sel.getRangeAt && sel.rangeCount)\n\t\t\t{\n\n\t\t\t\trange = sel.getRangeAt(0);\n\t\t\t\trange.deleteContents();\n\t\t\t\trange.insertNode(node);\n\t\t\t\trange.setEndAfter(node);\n\t\t\t\trange.setStartAfter(node);\n\t\t\t\tsel.removeAllRanges();\n\t\t\t\tsel.addRange(range);\n\t\t\t}\n\n\t\t\treturn node;\n\t\t},\n\t\tinsertNodeToCaretPositionFromPoint: function(e, node)\n\t\t{\n\t\t\tvar range;\n\t\t\tvar x = e.clientX, y = e.clientY;\n\t\t\tif (this.document.caretPositionFromPoint)\n\t\t\t{\n\t\t\t    var pos = this.document.caretPositionFromPoint(x, y);\n\t\t\t    range = this.getRange();\n\t\t\t    range.setStart(pos.offsetNode, pos.offset);\n\t\t\t    range.collapse(true);\n\t\t\t    range.insertNode(node);\n\t\t\t}\n\t\t\telse if (this.document.caretRangeFromPoint)\n\t\t\t{\n\t\t\t    range = this.document.caretRangeFromPoint(x, y);\n\t\t\t    range.insertNode(node);\n\t\t\t}\n\t\t\telse if (typeof document.body.createTextRange != \"undefined\")\n\t\t\t{\n\t\t        range = this.document.body.createTextRange();\n\t\t        range.moveToPoint(x, y);\n\t\t        var endRange = range.duplicate();\n\t\t        endRange.moveToPoint(x, y);\n\t\t        range.setEndPoint(\"EndToEnd\", endRange);\n\t\t        range.select();\n\t\t\t}\n\n\t\t},\n\t\tinsertAfterLastElement: function(element, parent)\n\t\t{\n\t\t\tif (typeof(parent) != 'undefined') element = parent;\n\n\t\t\tif (this.isEndOfElement())\n\t\t\t{\n\t\t\t\tif (this.opts.linebreaks)\n\t\t\t\t{\n\t\t\t\t\tvar contents = $('<div>').append($.trim(this.$editor.html())).contents();\n\t\t\t\t\tvar last = contents.last()[0];\n\t\t\t\t\tif (last.tagName == 'SPAN' && last.innerHTML == '')\n\t\t\t\t\t{\n\t\t\t\t\t\tlast = contents.prev()[0];\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.outerHtml(last) != this.outerHtml(element))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tif (this.$editor.contents().last()[0] !== element)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tthis.insertingAfterLastElement(element);\n\t\t\t}\n\t\t},\n\t\tinsertingAfterLastElement: function(element)\n\t\t{\n\t\t\tthis.bufferSet();\n\n\t\t\tif (this.opts.linebreaks === false)\n\t\t\t{\n\t\t\t\tvar node = $(this.opts.emptyHtml);\n\t\t\t\t$(element).after(node);\n\t\t\t\tthis.selectionStart(node);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tvar node = $('<span id=\"selection-marker-1\">' + this.opts.invisibleSpace + '</span>', this.document)[0];\n\t\t\t\t$(element).after(node);\n\t\t\t\t$(node).after(this.opts.invisibleSpace);\n\t\t\t\tthis.selectionRestore();\n\t\t\t\tthis.$editor.find('span#selection-marker-1').removeAttr('id');\n\t\t\t}\n\t\t},\n\t\tinsertLineBreak: function(twice)\n\t\t{\n\t\t\tthis.selectionSave();\n\n\t\t\tvar br = '<br>';\n\t\t\tif (twice == true)\n\t\t\t{\n\t\t\t\tbr = '<br><br>';\n\t\t\t}\n\n\t\t\tif (this.browser('mozilla'))\n\t\t\t{\n\t\t\t\tvar span = $('<span>').html(this.opts.invisibleSpace);\n\t\t\t\tthis.$editor.find('#selection-marker-1').before(br).before(span).before(this.opts.invisibleSpace);\n\n\t\t\t\tthis.setCaretAfter(span[0]);\n\t\t\t\tspan.remove();\n\n\t\t\t\tthis.selectionRemoveMarkers();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tvar parent = this.getParent();\n\t\t\t\tif (parent && parent.tagName === 'A')\n\t\t\t\t{\n\t\t\t\t\tvar offset = this.getCaretOffset(parent);\n\n\t\t\t\t\tvar text = $.trim($(parent).text()).replace(/\\n\\r\\n/g, '');\n\t\t\t\t\tvar len = text.length;\n\n\t\t\t\t\tif (offset == len)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.selectionRemoveMarkers();\n\n\t\t\t\t\t\tvar node = $('<span id=\"selection-marker-1\">' + this.opts.invisibleSpace + '</span>', this.document)[0];\n\t\t\t\t\t\t$(parent).after(node);\n\t\t\t\t\t\t$(node).before(br + (this.browser('webkit') ? this.opts.invisibleSpace : ''));\n\t\t\t\t\t\tthis.selectionRestore();\n\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t\tthis.$editor.find('#selection-marker-1').before(br + (this.browser('webkit') ? this.opts.invisibleSpace : ''));\n\t\t\t\tthis.selectionRestore();\n\t\t\t}\n\t\t},\n\t\tinsertDoubleLineBreak: function()\n\t\t{\n\t\t\tthis.insertLineBreak(true);\n\t\t},\n\t\treplaceLineBreak: function(element)\n\t\t{\n\t\t\tvar node = $('<br>' + this.opts.invisibleSpace);\n\t\t\t$(element).replaceWith(node);\n\t\t\tthis.selectionStart(node);\n\t\t},\n\t\tpasteClean: function(html)\n\t\t{\n\t\t\thtml = this.callback('pasteBefore', false, html);\n\t\t\tif (this.browser('msie'))\n\t\t\t{\n\t\t\t\tvar tmp = $.trim(html);\n\t\t\t\tif (tmp.search(/^<a(.*?)>(.*?)<\\/a>$/i) == 0)\n\t\t\t\t{\n\t\t\t\t\thtml = html.replace(/^<a(.*?)>(.*?)<\\/a>$/i, \"$2\");\n\t\t\t\t}\n\t\t\t}\n            html = html.replace(/on([a-z]+)=|javascript\\:/gi, '');\n\t\t\tif (this.opts.pastePlainText)\n\t\t\t{\n\t\t\t\tvar tmp = this.document.createElement('div');\n\n\t\t\t\thtml = html.replace(/<br>|<\\/H[1-6]>|<\\/p>|<\\/div>/gi, '\\n');\n\n\t\t\t\ttmp.innerHTML = html;\n\t\t\t\thtml = tmp.textContent || tmp.innerText;\n\n\t\t\t\thtml = $.trim(html);\n\t\t\t\thtml = html.replace('\\n', '<br>');\n\t\t\t\thtml = this.cleanParagraphy(html);\n\n\t\t\t\tthis.pasteInsert(html);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tvar tablePaste = false;\n\t\t\tif (this.currentOrParentIs('TD'))\n\t\t\t{\n\t\t\t\ttablePaste = true;\n\t\t\t\tvar blocksElems = this.opts.blockLevelElements;\n\t\t\t\tblocksElems.push('tr');\n\t\t\t\tblocksElems.push('table');\n\t\t\t\t$.each(blocksElems, function(i,s)\n\t\t\t\t{\n\t\t\t\t\thtml = html.replace(new RegExp('<' + s + '(.*?)>', 'gi'), '');\n\t\t\t\t\thtml = html.replace(new RegExp('</' + s + '>', 'gi'), '<br>');\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (this.currentOrParentIs('CODE'))\n\t\t\t{\n\t\t\t\thtml = this.pastePre(html);\n\t\t\t\tthis.pasteInsert(html);\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\thtml = html.replace(/<img(.*?)v:shapes=(.*?)>/gi, '');\n\t\t\thtml = html.replace(/<p(.*?)class=\"MsoListParagraphCxSpFirst\"([\\w\\W]*?)<\\/p>/gi, '<ul><li$2</li>');\n\t\t\thtml = html.replace(/<p(.*?)class=\"MsoListParagraphCxSpMiddle\"([\\w\\W]*?)<\\/p>/gi, '<li$2</li>');\n\t\t\thtml = html.replace(/<p(.*?)class=\"MsoListParagraphCxSpLast\"([\\w\\W]*?)<\\/p>/gi, '<li$2</li></ul>');\n\n\t\t\thtml = html.replace(/<p(.*?)class=\"MsoListParagraph\"([\\w\\W]*?)<\\/p>/gi, '<ul><li$2</li></ul>');\n\n\t\t\thtml = html.replace(/\u00b7/g, '');\n\t\t\thtml = html.replace(/<!--[\\s\\S]*?-->|<\\?(?:php)?[\\s\\S]*?\\?>/gi, '');\n\t\t\tif (this.opts.cleanSpaces === true)\n\t\t\t{\n\t\t\t\thtml = html.replace(/(&nbsp;){2,}/gi, '&nbsp;');\n\t\t\t\thtml = html.replace(/&nbsp;/gi, ' ');\n\t\t\t}\n\t\t\thtml = html.replace(/<b\\sid=\"internal-source-marker(.*?)\">([\\w\\W]*?)<\\/b>/gi, \"$2\");\n\t\t\thtml = html.replace(/<b(.*?)id=\"docs-internal-guid(.*?)\">([\\w\\W]*?)<\\/b>/gi, \"$3\");\n\t \t\thtml = html.replace(/<span[^>]*(font-style: italic; font-weight: bold|font-weight: bold; font-style: italic)[^>]*>/gi, '<span style=\"font-weight: bold;\"><span style=\"font-style: italic;\">');\n\t \t\thtml = html.replace(/<span[^>]*font-style: italic[^>]*>/gi, '<span style=\"font-style: italic;\">');\n\t\t\thtml = html.replace(/<span[^>]*font-weight: bold[^>]*>/gi, '<span style=\"font-weight: bold;\">');\n\t\t\thtml = html.replace(/<span[^>]*text-decoration: underline[^>]*>/gi, '<span style=\"text-decoration: underline;\">');\n\t\t\thtml = html.replace(/<td>\\u200b*<\\/td>/gi, '[td]');\n\t\t\thtml = html.replace(/<td>&nbsp;<\\/td>/gi, '[td]');\n\t\t\thtml = html.replace(/<td><br><\\/td>/gi, '[td]');\n\t\t\thtml = html.replace(/<td(.*?)colspan=\"(.*?)\"(.*?)>([\\w\\W]*?)<\\/td>/gi, '[td colspan=\"$2\"]$4[/td]');\n\t\t\thtml = html.replace(/<td(.*?)rowspan=\"(.*?)\"(.*?)>([\\w\\W]*?)<\\/td>/gi, '[td rowspan=\"$2\"]$4[/td]');\n\t\t\thtml = html.replace(/<a(.*?)href=\"(.*?)\"(.*?)>([\\w\\W]*?)<\\/a>/gi, '[a href=\"$2\"]$4[/a]');\n\t\t\thtml = html.replace(/<iframe(.*?)>([\\w\\W]*?)<\\/iframe>/gi, '[iframe$1]$2[/iframe]');\n\t\t\thtml = html.replace(/<video(.*?)>([\\w\\W]*?)<\\/video>/gi, '[video$1]$2[/video]');\n\t\t\thtml = html.replace(/<audio(.*?)>([\\w\\W]*?)<\\/audio>/gi, '[audio$1]$2[/audio]');\n\t\t\thtml = html.replace(/<embed(.*?)>([\\w\\W]*?)<\\/embed>/gi, '[embed$1]$2[/embed]');\n\t\t\thtml = html.replace(/<object(.*?)>([\\w\\W]*?)<\\/object>/gi, '[object$1]$2[/object]');\n\t\t\thtml = html.replace(/<param(.*?)>/gi, '[param$1]');\n\n\t\t\thtml = html.replace(/<img(.*?)>/gi, '[img$1]');\n\t\t\thtml = html.replace(/ class=\"(.*?)\"/gi, '');\n\t\t\thtml = html.replace(/<(\\w+)([\\w\\W]*?)>/gi, '<$1>');\n\t\t\tif (this.opts.linebreaks)\n\t\t\t{\n\n\t\t\t\thtml = html.replace(/<strong><\\/strong>/gi, '');\n\t\t\t\thtml = html.replace(/<u><\\/u>/gi, '');\n\n\t\t\t\tif (this.opts.cleanFontTag)\n\t\t\t\t{\n\t\t\t\t\thtml = html.replace(/<font(.*?)>([\\w\\W]*?)<\\/font>/gi, '$2');\n\t\t\t\t}\n\n\t\t\t\thtml = html.replace(/<[^\\/>][^>]*>(\\s*|\\t*|\\n*|&nbsp;|<br>)<\\/[^>]+>/gi, '<br>');\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\thtml = html.replace(/<[^\\/>][^>]*>(\\s*|\\t*|\\n*|&nbsp;|<br>)<\\/[^>]+>/gi, '');\n\t\t\t}\n\n\t\t\thtml = html.replace(/<div>\\s*?\\t*?\\n*?(<ul>|<ol>|<p>)/gi, '$1');\n\t\t\thtml = html.replace(/\\[td colspan=\"(.*?)\"\\]([\\w\\W]*?)\\[\\/td\\]/gi, '<td colspan=\"$1\">$2</td>');\n\t\t\thtml = html.replace(/\\[td rowspan=\"(.*?)\"\\]([\\w\\W]*?)\\[\\/td\\]/gi, '<td rowspan=\"$1\">$2</td>');\n\t\t\thtml = html.replace(/\\[td\\]/gi, '<td>&nbsp;</td>');\n\t\t\thtml = html.replace(/\\[a href=\"(.*?)\"\\]([\\w\\W]*?)\\[\\/a\\]/gi, '<a href=\"$1\">$2</a>');\n\t\t\thtml = html.replace(/\\[iframe(.*?)\\]([\\w\\W]*?)\\[\\/iframe\\]/gi, '<iframe$1>$2</iframe>');\n\t\t\thtml = html.replace(/\\[video(.*?)\\]([\\w\\W]*?)\\[\\/video\\]/gi, '<video$1>$2</video>');\n\t\t\thtml = html.replace(/\\[audio(.*?)\\]([\\w\\W]*?)\\[\\/audio\\]/gi, '<audio$1>$2</audio>');\n\t\t\thtml = html.replace(/\\[embed(.*?)\\]([\\w\\W]*?)\\[\\/embed\\]/gi, '<embed$1>$2</embed>');\n\t\t\thtml = html.replace(/\\[object(.*?)\\]([\\w\\W]*?)\\[\\/object\\]/gi, '<object$1>$2</object>');\n\t\t\thtml = html.replace(/\\[param(.*?)\\]/gi, '<param$1>');\n\t\t\thtml = html.replace(/\\[img(.*?)\\]/gi, '<img$1>');\n\t\t\tif (this.opts.convertDivs)\n\t\t\t{\n\t\t\t\thtml = html.replace(/<div(.*?)>([\\w\\W]*?)<\\/div>/gi, '<p>$2</p>');\n\t\t\t\thtml = html.replace(/<\\/div><p>/gi, '<p>');\n\t\t\t\thtml = html.replace(/<\\/p><\\/div>/gi, '</p>');\n\t\t\t\thtml = html.replace(/<p><\\/p>/gi, '<br />');\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\thtml = html.replace(/<div><\\/div>/gi, '<br />');\n\t\t\t}\n\t\t\thtml = this.cleanStripTags(html);\n\n\t\t\tif (this.currentOrParentIs('LI'))\n\t\t\t{\n\t\t\t\thtml = html.replace(/<p>([\\w\\W]*?)<\\/p>/gi, '$1<br>');\n\t\t\t}\n\t\t\telse if (tablePaste === false)\n\t\t\t{\n\t\t\t\thtml = this.cleanParagraphy(html);\n\t\t\t}\n\t\t\thtml = html.replace(/<span(.*?)>([\\w\\W]*?)<\\/span>/gi, '$2');\n\t\t\thtml = html.replace(/<img>/gi, '');\n\t\t\thtml = html.replace(/<[^\\/>][^>][^img|param|source|td][^<]*>(\\s*|\\t*|\\n*| |<br>)<\\/[^>]+>/gi, '');\n\n\t\t\thtml = html.replace(/\\n{3,}/gi, '\\n');\n\t\t\thtml = html.replace(/<p><p>/gi, '<p>');\n\t\t\thtml = html.replace(/<\\/p><\\/p>/gi, '</p>');\n\n\t\t\thtml = html.replace(/<li>(\\s*|\\t*|\\n*)<p>/gi, '<li>');\n\t\t\thtml = html.replace(/<\\/p>(\\s*|\\t*|\\n*)<\\/li>/gi, '</li>');\n\n\t\t\tif (this.opts.linebreaks === true)\n\t\t\t{\n\t\t\t\thtml = html.replace(/<p(.*?)>([\\w\\W]*?)<\\/p>/gi, '$2<br>');\n\t\t\t}\n\t\t\thtml = html.replace(/<[^\\/>][^>][^img|param|source|td][^<]*>(\\s*|\\t*|\\n*| |<br>)<\\/[^>]+>/gi, '');\n\t\t\thtml = html.replace(/<img src=\"webkit-fake-url\\:\\/\\/(.*?)\"(.*?)>/gi, '');\n\t\t\thtml = html.replace(/<td(.*?)>(\\s*|\\t*|\\n*)<p>([\\w\\W]*?)<\\/p>(\\s*|\\t*|\\n*)<\\/td>/gi, '<td$1>$3</td>');\n\t\t\tif (this.opts.convertDivs)\n\t\t\t{\n\t\t\t\thtml = html.replace(/<div(.*?)>([\\w\\W]*?)<\\/div>/gi, '$2');\n\t\t\t\thtml = html.replace(/<div(.*?)>([\\w\\W]*?)<\\/div>/gi, '$2');\n\t\t\t}\n\t\t\tthis.pasteClipboardMozilla = false;\n\t\t\tif (this.browser('mozilla'))\n\t\t\t{\n\t\t\t\tif (this.opts.clipboardUpload)\n\t\t\t\t{\n\t\t\t\t\tvar matches = html.match(/<img src=\"data:image(.*?)\"(.*?)>/gi);\n\t\t\t\t\tif (matches !== null)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.pasteClipboardMozilla = matches;\n\t\t\t\t\t\tfor (var k in matches)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar img = matches[k].replace('<img', '<img data-mozilla-paste-image=\"' + k + '\" ');\n\t\t\t\t\t\t\thtml = html.replace(matches[k], img);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\twhile (/<br>$/gi.test(html))\n\t\t\t\t{\n\t\t\t\t\thtml = html.replace(/<br>$/gi, '');\n\t\t\t\t}\n\t\t\t}\n\t\t\thtml = html.replace(/<p>\u2022([\\w\\W]*?)<\\/p>/gi, '<li>$1</li>');\n\t\t\tif (this.browser('msie'))\n\t\t\t{\n\t\t\t\twhile (/<font>([\\w\\W]*?)<\\/font>/gi.test(html))\n\t\t\t\t{\n\t\t\t\t\thtml = html.replace(/<font>([\\w\\W]*?)<\\/font>/gi, '$1');\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (tablePaste === false)\n\t\t\t{\n\t\t\t\thtml = html.replace(/<td(.*?)>([\\w\\W]*?)<p(.*?)>([\\w\\W]*?)<\\/td>/gi, '<td$1>$2$4</td>');\n\t\t\t\thtml = html.replace(/<td(.*?)>([\\w\\W]*?)<\\/p>([\\w\\W]*?)<\\/td>/gi, '<td$1>$2$3</td>');\n\t\t\t\thtml = html.replace(/<td(.*?)>([\\w\\W]*?)<p(.*?)>([\\w\\W]*?)<\\/td>/gi, '<td$1>$2$4</td>');\n\t\t\t\thtml = html.replace(/<td(.*?)>([\\w\\W]*?)<\\/p>([\\w\\W]*?)<\\/td>/gi, '<td$1>$2$3</td>');\n\t\t\t}\n\t\t\thtml = html.replace(/\\n/g, ' ');\n\t\t\thtml = html.replace(/<p>\\n?<li>/gi, '<li>');\n\n\t\t\tthis.pasteInsert(html);\n\n\t\t},\n\t\tpastePre: function(s)\n\t\t{\n\t\t\ts = s.replace(/<br>|<\\/H[1-6]>|<\\/p>|<\\/div>/gi, '\\n');\n\n\t\t\tvar tmp = this.document.createElement('div');\n\t\t\ttmp.innerHTML = s;\n\t\t\treturn this.cleanEncodeEntities(tmp.textContent || tmp.innerText);\n\t\t},\n\t\tpasteInsert: function(html)\n\t\t{\n\t\t\thtml = this.callback('pasteAfter', false, html);\n\n\t\t\tif (this.selectall)\n\t\t\t{\n\t\t\t\tthis.$editor.html(html);\n\t\t\t\tthis.selectionRemove();\n\t\t\t\tthis.focusEnd();\n\t\t\t\tthis.sync();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.insertHtml(html);\n\t\t\t}\n\n\t\t\tthis.selectall = false;\n\n\t\t\tsetTimeout($.proxy(function()\n\t\t\t{\n\t\t\t\tthis.rtePaste = false;\n\t\t\t\tif (this.browser('mozilla'))\n\t\t\t\t{\n\t\t\t\t\tthis.$editor.find('p:empty').remove();\n\t\t\t\t}\n\t\t\t\tif (this.pasteClipboardMozilla !== false)\n\t\t\t\t{\n\t\t\t\t\tthis.pasteClipboardUploadMozilla();\n\t\t\t\t}\n\n\t\t\t}, this), 100);\n\n\t\t\tif (this.opts.autoresize && this.fullscreen !== true)\n\t\t\t{\n\t\t\t\t$(this.document.body).scrollTop(this.saveScroll);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.$editor.scrollTop(this.saveScroll);\n\t\t\t}\n\t\t},\n\t\tpasteClipboardAppendFields: function(postData)\n\t\t{\n\n\t\t\tif (this.opts.uploadFields !== false && typeof this.opts.uploadFields === 'object')\n\t\t\t{\n\t\t\t\t$.each(this.opts.uploadFields, $.proxy(function(k, v)\n\t\t\t\t{\n\t\t\t\t\tif (v != null && v.toString().indexOf('#') === 0) v = $(v).val();\n\t\t\t\t\tpostData[k] = v;\n\n\t\t\t\t}, this));\n\t\t\t}\n\n\t\t\treturn postData;\n\t\t},\n\t\tpasteClipboardUploadMozilla: function()\n\t\t{\n\t\t\tvar imgs = this.$editor.find('img[data-mozilla-paste-image]');\n\t\t\t$.each(imgs, $.proxy(function(i,s)\n\t\t\t{\n\t\t\t\tvar $s = $(s);\n\t\t\t\tvar arr = s.src.split(\",\");\n\t\t\t\tvar postData = {\n\t\t\t\t\t'contentType': arr[0].split(\";\")[0].split(\":\")[1],\n\t\t\t\t\t'data': arr[1]\n\t\t\t\t};\n\t\t\t\tpostData = this.pasteClipboardAppendFields(postData);\n\n\t\t\t\t$.post(this.opts.clipboardUploadUrl, postData,\n\t\t\t\t$.proxy(function(data)\n\t\t\t\t{\n\t\t\t\t\tvar json = (typeof data === 'string' ? $.parseJSON(data) : data);\n\t\t        \t$s.attr('src', json.image.url);\n\t\t        \t$s.removeAttr('data-mozilla-paste-image');\n\n\t\t        \tthis.sync();\n\t\t\t\t\tthis.callback('imageUpload', $s, json);\n\n\t\t\t\t}, this));\n\n\t\t\t}, this));\n\t\t},\n\t\tpasteClipboardUpload: function(e)\n\t\t{\n\t        var result = e.target.result;\n\t\t\tvar arr = result.split(\",\");\n\t\t\tvar postData = {\n\t\t\t\t'contentType': arr[0].split(\";\")[0].split(\":\")[1],\n\t\t\t\t'data': arr[1]\n\t\t\t};\n\t\t\tif (this.opts.clipboardUpload)\n\t\t\t{\n\n\t\t\t\tpostData = this.pasteClipboardAppendFields(postData);\n\n\t\t\t\t$.post(this.opts.clipboardUploadUrl, postData,\n\t\t\t\t$.proxy(function(data)\n\t\t\t\t{\n\t\t\t\t\tvar json = (typeof data === 'string' ? $.parseJSON(data) : data);\n\n\t\t\t\t\tvar html = '<img src=\"' + json.image.url + '\" id=\"clipboard-image-marker\" />';\n\t\t\t\t\tthis.execCommand('inserthtml', html, false);\n\n\t\t\t\t\tvar image = $(this.$editor.find('img#clipboard-image-marker'));\n\n\t\t\t\t\tif (image.length) image.removeAttr('id');\n\t\t\t\t\telse image = false;\n\n\t\t\t\t\tthis.sync();\n\t\t\t\t\tif (image)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.callback('imageUpload', image, json);\n\t\t\t\t\t}\n\t\t\t\t}, this));\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t        \tthis.insertHtml('<img src=\"' + result + '\" />');\n        \t}\n\t\t},\n\t\tbufferSet: function(selectionSave)\n\t\t{\n\t\t\tif (selectionSave !== false)\n\t\t\t{\n\t\t\t\tthis.selectionSave();\n\t\t\t}\n\n\t\t\tthis.opts.buffer.push(this.$editor.html());\n\n\t\t\tif (selectionSave !== false)\n\t\t\t{\n\t\t\t\tthis.selectionRemoveMarkers('buffer');\n\t\t\t}\n\n\t\t},\n\t\tbufferUndo: function()\n\t\t{\n\t\t\tif (this.opts.buffer.length === 0)\n\t\t\t{\n\t\t\t\tthis.focusWithSaveScroll();\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.selectionSave();\n\t\t\tthis.opts.rebuffer.push(this.$editor.html());\n\t\t\tthis.selectionRestore(false, true);\n\n\t\t\tthis.$editor.html(this.opts.buffer.pop());\n\n\t\t\tthis.selectionRestore();\n\t\t\tsetTimeout($.proxy(this.observeStart, this), 100);\n\t\t},\n\t\tbufferRedo: function()\n\t\t{\n\t\t\tif (this.opts.rebuffer.length === 0)\n\t\t\t{\n\t\t\t\tthis.focusWithSaveScroll();\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tthis.selectionSave();\n\t\t\tthis.opts.buffer.push(this.$editor.html());\n\t\t\tthis.selectionRestore(false, true);\n\n\t\t\tthis.$editor.html(this.opts.rebuffer.pop());\n\t\t\tthis.selectionRestore(true);\n\t\t\tsetTimeout($.proxy(this.observeStart, this), 4);\n\t\t},\n\t\tobserveStart: function()\n\t\t{\n\t\t\tthis.observeImages();\n\n\t\t\tif (this.opts.observeLinks) this.observeLinks();\n\t\t},\n\t\tobserveLinks: function()\n\t\t{\n\t\t\tthis.$editor.find('a').on('click', $.proxy(this.linkObserver, this));\n\n\t\t\tthis.$editor.on('click.redactor', $.proxy(function(e)\n\t\t\t{\n\t\t\t\tthis.linkObserverTooltipClose(e);\n\n\t\t\t}, this));\n\n\t\t\t$(document).on('click.redactor', $.proxy(function(e)\n\t\t\t{\n\t\t\t\tthis.linkObserverTooltipClose(e);\n\n\t\t\t}, this));\n\t\t},\n\t\tobserveImages: function()\n\t\t{\n\t\t\tif (this.opts.observeImages === false) return false;\n\n\t\t\tthis.$editor.find('img').each($.proxy(function(i, elem)\n\t\t\t{\n\t\t\t\tif (this.browser('msie')) $(elem).attr('unselectable', 'on');\n\n\t\t\t\tvar parent = $(elem).parent();\n\t\t\t\tif (!parent.hasClass('royalSlider') && !parent.hasClass('fotorama'))\n\t\t\t\t{\n\t\t\t\t\tthis.imageResize(elem);\n\t\t\t\t}\n\n\t\t\t}, this));\n\t\t\tthis.$editor.find('.fotorama, .royalSlider').on('click', $.proxy(this.editGallery, this));\n\n\t\t},\n\t\tlinkObserver: function(e)\n\t\t{\n\t\t\tvar $link = $(e.target);\n\n\t\t\tvar parent = $(e.target).parent();\n\t\t\tif (parent.hasClass('royalSlider') || parent.hasClass('fotorama'))\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif ($link.length == 0 || $link[0].tagName !== 'A') return;\n\n\t\t\tvar pos = $link.offset();\n\t\t\tif (this.opts.iframe)\n\t\t\t{\n\t\t\t\tvar posFrame = this.$frame.offset();\n\t\t\t\tpos.top = posFrame.top + (pos.top - $(this.document).scrollTop());\n\t\t\t\tpos.left += posFrame.left;\n\t\t\t}\n\n\t\t\tvar tooltip = $('<span class=\"redactor-link-tooltip\"></span>');\n\n\t\t\tvar href = $link.attr('href');\n\t\t\tif (href === undefined)\n\t\t\t{\n\t\t\t\thref = '';\n\t\t\t}\n\n\t\t\tif (href.length > 24) href = href.substring(0, 24) + '...';\n\n\t\t\tvar aLink = $('<a href=\"' + $link.attr('href') + '\" target=\"_blank\">' + href + '</a>').on('click', $.proxy(function(e)\n\t\t\t{\n\t\t\t\tthis.linkObserverTooltipClose(false);\n\t\t\t}, this));\n\n\t\t\tvar aEdit = $('<a href=\"#\">' + this.opts.curLang.edit + '</a>').on('click', $.proxy(function(e)\n\t\t\t{\n\t\t\t\te.preventDefault();\n\t\t\t\tthis.linkShow();\n\t\t\t\tthis.linkObserverTooltipClose(false);\n\n\t\t\t}, this));\n\n\t\t\tvar aUnlink = $('<a href=\"#\">' + this.opts.curLang.unlink + '</a>').on('click', $.proxy(function(e)\n\t\t\t{\n\t\t\t\te.preventDefault();\n\t\t\t\tthis.execCommand('unlink');\n\t\t\t\tthis.linkObserverTooltipClose(false);\n\n\t\t\t}, this));\n\t\t\ttooltip.append(aLink);\n\t\t\ttooltip.append(' | ');\n\t\t\ttooltip.append(aEdit);\n\t\t\ttooltip.append(' | ');\n\t\t\ttooltip.append(aUnlink);\n\t\t\ttooltip.css({\n\t\t\t\ttop: (pos.top + 20) + 'px',\n\t\t\t\tleft: pos.left + 'px'\n\t\t\t});\n\n\t\t\t$('.redactor-link-tooltip').remove();\n\t\t\t$('body').append(tooltip);\n\t\t},\n\t\tlinkObserverTooltipClose: function(e)\n\t\t{\n\t\t\tif (e !== false && e.target.tagName == 'A') return false;\n\t\t\t$('.redactor-link-tooltip').remove();\n\t\t},\n\t\tgetSelection: function()\n\t\t{\n\t\t\tif (!this.opts.rangy) return this.document.getSelection();\n\t\t\telse\n\t\t\t{\n\t\t\t\tif (!this.opts.iframe) return rangy.getSelection();\n\t\t\t\telse return rangy.getSelection(this.$frame[0]);\n\t\t\t}\n\t\t},\n\t\tgetRange: function()\n\t\t{\n\t\t\tif (!this.opts.rangy)\n\t\t\t{\n\t\t\t\tif (this.document.getSelection)\n\t\t\t\t{\n\t\t\t\t\tvar sel = this.getSelection();\n\t\t\t\t\tif (sel.getRangeAt && sel.rangeCount) return sel.getRangeAt(0);\n\t\t\t\t}\n\n\t\t\t\treturn this.document.createRange();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tif (!this.opts.iframe) return rangy.createRange();\n\t\t\t\telse return rangy.createRange(this.iframeDoc());\n\t\t\t}\n\t\t},\n\t\tselectionElement: function(node)\n\t\t{\n\t\t\tthis.setCaret(node);\n\t\t},\n\t\tselectionStart: function(node)\n\t\t{\n\t\t\tthis.selectionSet(node[0] || node, 0, null, 0);\n\t\t},\n\t\tselectionEnd: function(node)\n\t\t{\n\t\t\tthis.selectionSet(node[0] || node, 1, null, 1);\n\t\t},\n\t\tselectionSet: function(orgn, orgo, focn, foco)\n\t\t{\n\t\t\tif (focn == null) focn = orgn;\n\t\t\tif (foco == null) foco = orgo;\n\n\t\t\tvar sel = this.getSelection();\n\t\t\tif (!sel) return;\n\n\t\t\tif (orgn.tagName == 'P' && orgn.innerHTML == '')\n\t\t\t{\n\t\t\t\torgn.innerHTML = this.opts.invisibleSpace;\n\t\t\t}\n\n\t\t\tif (orgn.tagName == 'BR' && this.opts.linebreaks === false)\n\t\t\t{\n\t\t\t\tvar par = $(this.opts.emptyHtml)[0];\n\t\t\t\t$(orgn).replaceWith(par);\n\t\t\t\torgn = par;\n\t\t\t\tfocn = orgn;\n\t\t\t}\n\n\t\t\tvar range = this.getRange();\n\t\t\trange.setStart(orgn, orgo);\n\t\t\trange.setEnd(focn, foco );\n\n\t\t\ttry {\n\t\t\t\tsel.removeAllRanges();\n\t\t\t} catch (e) {}\n\n\t\t\tsel.addRange(range);\n\t\t},\n\t\tselectionWrap: function(tag)\n\t\t{\n\t\t\ttag = tag.toLowerCase();\n\n\t\t\tvar block = this.getBlock();\n\t\t\tif (block)\n\t\t\t{\n\t\t\t\tvar wrapper = this.formatChangeTag(block, tag);\n\t\t\t\tthis.sync();\n\t\t\t\treturn wrapper;\n\t\t\t}\n\n\t\t\tvar sel = this.getSelection();\n\t\t\tvar range = sel.getRangeAt(0);\n\t\t\tvar wrapper = document.createElement(tag);\n\t\t\twrapper.appendChild(range.extractContents());\n\t\t\trange.insertNode(wrapper);\n\n\t\t\tthis.selectionElement(wrapper);\n\n\t\t\treturn wrapper;\n\t\t},\n\t\tselectionAll: function()\n\t\t{\n\t\t\tvar range = this.getRange();\n\t\t\trange.selectNodeContents(this.$editor[0]);\n\n\t\t\tvar sel = this.getSelection();\n\t\t\tsel.removeAllRanges();\n\t\t\tsel.addRange(range);\n\t\t},\n\t\tselectionRemove: function()\n\t\t{\n\t\t\tthis.getSelection().removeAllRanges();\n\t\t},\n\t\tgetCaretOffset: function (element)\n\t\t{\n\t\t\tvar caretOffset = 0;\n\n\t\t\tvar range = this.getRange();\n\t\t\tvar preCaretRange = range.cloneRange();\n\t\t\tpreCaretRange.selectNodeContents(element);\n\t\t\tpreCaretRange.setEnd(range.endContainer, range.endOffset);\n\t\t\tcaretOffset = $.trim(preCaretRange.toString()).length;\n\n\t\t\treturn caretOffset;\n\t\t},\n\t\tgetCaretOffsetRange: function()\n\t\t{\n\t\t\treturn new Range(this.getSelection().getRangeAt(0));\n\t\t},\n\t\tsetCaret: function (el, start, end)\n\t\t{\n\t\t\tif (typeof end === 'undefined') end = start;\n\t\t\tel = el[0] || el;\n\n\t\t\tvar range = this.getRange();\n\t\t\trange.selectNodeContents(el);\n\n\t\t\tvar textNodes = this.getTextNodesIn(el);\n\t\t\tvar foundStart = false;\n\t\t\tvar charCount = 0, endCharCount;\n\n\t\t\tif (textNodes.length == 1 && start)\n\t\t\t{\n\t\t\t\trange.setStart(textNodes[0], start);\n\t\t\t\trange.setEnd(textNodes[0], end);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tfor (var i = 0, textNode; textNode = textNodes[i++];)\n\t\t\t\t{\n\t\t\t\t\tendCharCount = charCount + textNode.length;\n\t\t\t\t\tif (!foundStart && start >= charCount && (start < endCharCount || (start == endCharCount && i < textNodes.length)))\n\t\t\t\t\t{\n\t\t\t\t\t\trange.setStart(textNode, start - charCount);\n\t\t\t\t\t\tfoundStart = true;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (foundStart && end <= endCharCount)\n\t\t\t\t\t{\n\t\t\t\t\t\trange.setEnd( textNode, end - charCount );\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\n\t\t\t\t\tcharCount = endCharCount;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tvar sel = this.getSelection();\n\t\t\tsel.removeAllRanges();\n\t\t\tsel.addRange( range );\n\t\t},\n\t\tsetCaretAfter: function(node)\n\t\t{\n\t\t\tthis.$editor.focus();\n\n\t\t\tnode = node[0] || node;\n\n\t\t\tvar range = this.document.createRange()\n\n\t\t\tvar start = 1;\n\t\t\tvar end = -1;\n\n\t\t\trange.setStart(node, start)\n\t\t\trange.setEnd(node, end + 2)\n\t\t\tvar selection = this.window.getSelection()\n\t\t\tvar cursorRange = this.document.createRange()\n\n\t\t\tvar emptyElement = this.document.createTextNode('\\u200B')\n\t\t\t$(node).after(emptyElement)\n\n\t\t\tcursorRange.setStartAfter(emptyElement)\n\n\t\t\tselection.removeAllRanges()\n\t\t\tselection.addRange(cursorRange)\n\t\t\t$(emptyElement).remove();\n\t\t},\n\t\tgetTextNodesIn: function (node)\n\t\t{\n\t\t\tvar textNodes = [];\n\n\t\t\tif (node.nodeType == 3) textNodes.push(node);\n\t\t\telse\n\t\t\t{\n\t\t\t\tvar children = node.childNodes;\n\t\t\t\tfor (var i = 0, len = children.length; i < len; ++i)\n\t\t\t\t{\n\t\t\t\t\ttextNodes.push.apply(textNodes, this.getTextNodesIn(children[i]));\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn textNodes;\n\t\t},\n\t\tgetCurrent: function()\n\t\t{\n\t\t\tvar el = false;\n\t\t\tvar sel = this.getSelection();\n\n\t\t\tif (sel && sel.rangeCount > 0)\n\t\t\t{\n\t\t\t\tel = sel.getRangeAt(0).startContainer;\n\n\t\t\t}\n\n\t\t\treturn this.isParentRedactor(el);\n\t\t},\n\t\tgetParent: function(elem)\n\t\t{\n\t\t\telem = elem || this.getCurrent();\n\t\t\tif (elem) return this.isParentRedactor( $( elem ).parent()[0] );\n\t\t\telse return false;\n\t\t},\n\t\tgetBlock: function(node)\n\t\t{\n\t\t\tif (typeof node === 'undefined') node = this.getCurrent();\n\n\t\t\twhile (node)\n\t\t\t{\n\t\t\t\tif (this.nodeTestBlocks(node))\n\t\t\t\t{\n\t\t\t\t\tif ($(node).hasClass('redactor_editor')) return false;\n\t\t\t\t\treturn node;\n\t\t\t\t}\n\n\t\t\t\tnode = node.parentNode;\n\t\t\t}\n\n\t\t\treturn false;\n\t\t},\n\t\tgetBlocks: function(nodes)\n\t\t{\n\t\t\tvar newnodes = [];\n\t\t\tif (typeof nodes == 'undefined')\n\t\t\t{\n\t\t\t\tvar range = this.getRange();\n\t\t\t\tif (range && range.collapsed === true) return [this.getBlock()];\n\t\t\t\tvar nodes = this.getNodes(range);\n\t\t\t}\n\n\t\t\t$.each(nodes, $.proxy(function(i,node)\n\t\t\t{\n\t\t\t\tif (this.opts.iframe === false && $(node).parents('div.redactor_editor').length == 0) return false;\n\t\t\t\tif (this.nodeTestBlocks(node)) newnodes.push(node);\n\n\t\t\t}, this));\n\n\t\t\tif (newnodes.length === 0) newnodes = [this.getBlock()];\n\n\t\t\treturn newnodes;\n\t\t},\n\t\tisInlineNode: function(node)\n\t\t{\n\t\t\tif (node.nodeType != 1) return false;\n\n\t\t\treturn !this.rTestBlock.test(node.nodeName);\n\t\t},\n\t\tnodeTestBlocks: function(node)\n\t\t{\n\t\t\treturn node.nodeType == 1 && this.rTestBlock.test(node.nodeName);\n\t\t},\n\t\ttagTestBlock: function(tag)\n\t\t{\n\t\t\treturn this.rTestBlock.test(tag);\n\t\t},\n\t\tgetNodes: function(range, tag)\n\t\t{\n\t\t\tif (typeof range == 'undefined' || range == false) var range = this.getRange();\n\t\t\tif (range && range.collapsed === true)\n\t\t\t{\n\t\t\t\tif (typeof tag === 'undefined' && this.tagTestBlock(tag))\n\t\t\t\t{\n\t\t\t\t\tvar block = this.getBlock();\n\t\t\t\t\tif (block.tagName == tag) return [block];\n\t\t\t\t\telse return [];\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\treturn [this.getCurrent()];\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tvar nodes = [], finalnodes = [];\n\n\t\t\tvar sel = this.document.getSelection();\n\t\t\tif (!sel.isCollapsed) nodes = this.getRangeSelectedNodes(sel.getRangeAt(0));\n\n\t\t\t$.each(nodes, $.proxy(function(i,node)\n\t\t\t{\n\t\t\t\tif (this.opts.iframe === false && $(node).parents('div.redactor_editor').length == 0) return false;\n\n\t\t\t\tif (typeof tag === 'undefined')\n\t\t\t\t{\n\t\t\t\t\tif ($.trim(node.textContent) != '')\n\t\t\t\t\t{\n\t\t\t\t\t\tfinalnodes.push(node);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse if (node.tagName == tag)\n\t\t\t\t{\n\t\t\t\t\tfinalnodes.push(node);\n\t\t\t\t}\n\n\t\t\t}, this));\n\n\t\t\tif (finalnodes.length == 0)\n\t\t\t{\n\t\t\t\tif (typeof tag === 'undefined' && this.tagTestBlock(tag))\n\t\t\t\t{\n\t\t\t\t\tvar block = this.getBlock();\n\t\t\t\t\tif (block.tagName == tag) return finalnodes.push(block);\n\t\t\t\t\telse return [];\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tfinalnodes.push(this.getCurrent());\n\t\t\t\t}\n\t\t\t}\n\t\t\tvar last = finalnodes[finalnodes.length-1];\n\t\t\tif (this.nodeTestBlocks(last))\n\t\t\t{\n\t\t\t\tfinalnodes = finalnodes.slice(0, -1);\n\t\t\t}\n\n\t\t\treturn finalnodes;\n\t\t},\n\t\tgetElement: function(node)\n\t\t{\n\t\t\tif (!node) node = this.getCurrent();\n\t\t\twhile (node)\n\t\t\t{\n\t\t\t\tif (node.nodeType == 1)\n\t\t\t\t{\n\t\t\t\t\tif ($(node).hasClass('redactor_editor')) return false;\n\t\t\t\t\treturn node;\n\t\t\t\t}\n\n\t\t\t\tnode = node.parentNode;\n\t\t\t}\n\n\t\t\treturn false;\n\t\t},\n\t\tgetRangeSelectedNodes: function(range)\n\t\t{\n\t\t\trange = range || this.getRange();\n\t\t\tvar node = range.startContainer;\n\t\t\tvar endNode = range.endContainer;\n\n\t\t\tif (node == endNode) return [node];\n\n\t\t\tvar rangeNodes = [];\n\t\t\twhile (node && node != endNode)\n\t\t\t{\n\t\t\t\trangeNodes.push(node = this.nextNode(node));\n\t\t\t}\n\n\t\t\tnode = range.startContainer;\n\t\t\twhile (node && node != range.commonAncestorContainer)\n\t\t\t{\n\t\t\t\trangeNodes.unshift(node);\n\t\t\t\tnode = node.parentNode;\n\t\t\t}\n\n\t\t\treturn rangeNodes;\n\t\t},\n\t\tnextNode: function(node)\n\t\t{\n\t\t\tif (node.hasChildNodes()) return node.firstChild;\n\t\t\telse\n\t\t\t{\n\t\t\t\twhile (node && !node.nextSibling)\n\t\t\t\t{\n\t\t\t\t\tnode = node.parentNode;\n\t\t\t\t}\n\n\t\t\t\tif (!node) return null;\n\t\t\t\treturn node.nextSibling;\n\t\t\t}\n\t\t},\n\t\tgetSelectionText: function()\n\t\t{\n\t\t\treturn this.getSelection().toString();\n\t\t},\n\t\tgetSelectionHtml: function()\n\t\t{\n\t\t\tvar html = '';\n\n\t\t\tvar sel = this.getSelection();\n\t\t\tif (sel.rangeCount)\n\t\t\t{\n\t\t\t\tvar container = this.document.createElement( \"div\" );\n\t\t\t\tvar len = sel.rangeCount;\n\t\t\t\tfor (var i = 0; i < len; ++i)\n\t\t\t\t{\n\t\t\t\t\tcontainer.appendChild(sel.getRangeAt(i).cloneContents());\n\t\t\t\t}\n\n\t\t\t\thtml = container.innerHTML;\n\t\t\t}\n\n\t\t\treturn this.syncClean(html);\n\t\t},\n\t\tselectionSave: function()\n\t\t{\n\t\t\tif (!this.isFocused())\n\t\t\t{\n\t\t\t\tthis.focusWithSaveScroll();\n\t\t\t}\n\n\t\t\tif (!this.opts.rangy)\n\t\t\t{\n\t\t\t\tthis.selectionCreateMarker(this.getRange());\n\t\t\t}\n\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.savedSel = rangy.saveSelection();\n\t\t\t}\n\t\t},\n\t\tselectionCreateMarker: function(range, remove)\n\t\t{\n\t\t\tif (!range) return;\n\n\t\t\tvar node1 = $('<span id=\"selection-marker-1\" class=\"redactor-selection-marker\">' + this.opts.invisibleSpace + '</span>', this.document)[0];\n\t\t\tvar node2 = $('<span id=\"selection-marker-2\" class=\"redactor-selection-marker\">' + this.opts.invisibleSpace + '</span>', this.document)[0];\n\n\t\t\tif (range.collapsed === true)\n\t\t\t{\n\t\t\t\tthis.selectionSetMarker(range, node1, true);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.selectionSetMarker(range, node1, true);\n\t\t\t\tthis.selectionSetMarker(range, node2, false);\n\t\t\t}\n\n\t\t\tthis.savedSel = this.$editor.html();\n\n\t\t\tthis.selectionRestore(false, false);\n\t\t},\n\t\tselectionSetMarker: function(range, node, type)\n\t\t{\n\t\t\tvar boundaryRange = range.cloneRange();\n\n\t\t\ttry {\n\t\t\t\tboundaryRange.collapse(type);\n\t\t\t\tboundaryRange.insertNode(node);\n\t\t\t\tboundaryRange.detach();\n\t\t\t}\n\t\t\tcatch (e)\n\t\t\t{\n\t\t\t\tvar html = this.opts.emptyHtml;\n\t\t\t\tif (this.opts.linebreaks) html = '<br>';\n\n\t\t\t\tthis.$editor.prepend(html);\n\t\t\t\tthis.focus();\n\t\t\t}\n\t\t},\n\t\tselectionRestore: function(replace, remove)\n\t\t{\n\t\t\tif (!this.opts.rangy)\n\t\t\t{\n\t\t\t\tif (replace === true && this.savedSel)\n\t\t\t\t{\n\t\t\t\t\tthis.$editor.html(this.savedSel);\n\t\t\t\t}\n\n\t\t\t\tvar node1 = this.$editor.find('span#selection-marker-1');\n\t\t\t\tvar node2 = this.$editor.find('span#selection-marker-2');\n\n\t\t\t\tif (this.browser('mozilla'))\n\t\t\t\t{\n\t\t\t\t\tthis.$editor.focus();\n\t\t\t\t}\n\t\t\t\telse if (!this.isFocused())\n\t\t\t\t{\n\t\t\t\t\tthis.focusWithSaveScroll();\n\t\t\t\t}\n\n\t\t\t\tif (node1.length != 0 && node2.length != 0)\n\t\t\t\t{\n\n\t\t\t\t\tthis.selectionSet(node1[0], 0, node2[0], 0);\n\t\t\t\t}\n\t\t\t\telse if (node1.length != 0)\n\t\t\t\t{\n\t\t\t\t\tthis.selectionSet(node1[0], 0, null, 0);\n\t\t\t\t}\n\n\t\t\t\tif (remove !== false)\n\t\t\t\t{\n\t\t\t\t\tthis.selectionRemoveMarkers();\n\t\t\t\t\tthis.savedSel = false;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\telse\n\t\t\t{\n\t\t\t\trangy.restoreSelection(this.savedSel);\n\t\t\t}\n\t\t},\n\t\tselectionRemoveMarkers: function(type)\n\t\t{\n\t\t\tif (!this.opts.rangy)\n\t\t\t{\n\t\t\t\t$.each(this.$editor.find('span.redactor-selection-marker'), function()\n\t\t\t\t{\n\t\t\t\t\tvar html = $.trim($(this).html().replace(/[^\\u0000-\\u1C7F]/g, ''));\n\t\t\t\t\tif (html == '')\n\t\t\t\t\t{\n\t\t\t\t\t\t$(this).remove();\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t$(this).removeAttr('class').removeAttr('id');\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\telse\n\t\t\t{\n\t\t\t\trangy.removeMarkers(this.savedSel);\n\t\t\t}\n\t\t},\n\t\ttableShow: function()\n\t\t{\n\t\t\tthis.selectionSave();\n\n\t\t\tthis.modalInit(this.opts.curLang.table, this.opts.modal_table, 300, $.proxy(function()\n\t\t\t{\n\t\t\t\t$('#redactor_insert_table_btn').on('click', $.proxy(this.tableInsert, this));\n\n\t\t\t\tsetTimeout(function()\n\t\t\t\t{\n\t\t\t\t\t$('#redactor_table_rows').focus();\n\n\t\t\t\t}, 200);\n\n\t\t\t}, this));\n\t\t},\n\t\ttableInsert: function()\n\t\t{\n\t\t\tthis.bufferSet(false);\n\n\t\t\tvar rows = $('#redactor_table_rows').val(),\n\t\t\t\tcolumns = $('#redactor_table_columns').val(),\n\t\t\t\t$table_box = $('<div></div>'),\n\t\t\t\ttableId = Math.floor(Math.random() * 99999),\n\t\t\t\t$table = $('<table id=\"table' + tableId + '\"><tbody></tbody></table>'),\n\t\t\t\ti, $row, z, $column;\n\n\t\t\tfor (i = 0; i < rows; i++)\n\t\t\t{\n\t\t\t\t$row = $('<tr></tr>');\n\n\t\t\t\tfor (z = 0; z < columns; z++)\n\t\t\t\t{\n\t\t\t\t\t$column = $('<td>' + this.opts.invisibleSpace + '</td>');\n\t\t\t\t\tif (i === 0 && z === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\t$column.append('<span id=\"selection-marker-1\">' + this.opts.invisibleSpace + '</span>');\n\t\t\t\t\t}\n\n\t\t\t\t\t$($row).append($column);\n\t\t\t\t}\n\n\t\t\t\t$table.append($row);\n\t\t\t}\n\n\t\t\t$table_box.append($table);\n\t\t\tvar html = $table_box.html();\n\n\t\t\tif (this.opts.linebreaks === false && this.browser('mozilla'))\n\t\t\t{\n\t\t\t\thtml += '<p>' + this.opts.invisibleSpace + '</p>';\n\t\t\t}\n\n\t\t\tthis.modalClose();\n\t\t\tthis.selectionRestore();\n\n\t\t\tvar current = this.getBlock() || this.getCurrent();\n\n\t\t\tif (current && current.tagName != 'BODY')\n\t\t\t{\n\t\t\t\tif (current.tagName == 'LI')\n\t\t\t\t{\n\t\t\t\t\tvar current = $(current).closest('ul, ol');\n\t\t\t\t}\n\n\t\t\t\t$(current).after(html)\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\n\t\t\t\tthis.insertHtmlAdvanced(html, false);\n\t\t\t}\n\n\t\t\tthis.selectionRestore();\n\n\t\t\tvar table = this.$editor.find('#table' + tableId);\n\t\t\tthis.buttonActiveObserver();\n\n\t\t\ttable.find('span#selection-marker-1, inline#selection-marker-1').remove();\n\t\t\ttable.removeAttr('id');\n\n\t\t\tthis.sync();\n\t\t},\n\t\ttableDeleteTable: function()\n\t\t{\n\t\t\tvar $table = $(this.getParent()).closest('table');\n\t\t\tif (!this.isParentRedactor($table)) return false;\n\t\t\tif ($table.length == 0) return false;\n\n\t\t\tthis.bufferSet();\n\n\t\t\t$table.remove();\n\t\t\tthis.sync();\n\t\t},\n\t\ttableDeleteRow: function()\n\t\t{\n\t\t\tvar parent = this.getParent();\n\t\t\tvar $table = $(parent).closest('table');\n\t\t\tif (!this.isParentRedactor($table)) return false;\n\t\t\tif ($table.length == 0) return false;\n\n\t\t\tthis.bufferSet();\n\n\t\t\tvar $current_tr = $(parent).closest('tr');\n\t\t\tvar $focus_tr = $current_tr.prev().length ? $current_tr.prev() : $current_tr.next();\n\t\t\tif ($focus_tr.length)\n\t\t\t{\n\t\t\t\tvar $focus_td = $focus_tr.children('td' ).first();\n\t\t\t\tif ($focus_td.length)\n\t\t\t\t{\n\t\t\t\t\t$focus_td.prepend('<span id=\"selection-marker-1\">' + this.opts.invisibleSpace + '</span>');\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t$current_tr.remove();\n\t\t\tthis.selectionRestore();\n\t\t\t$table.find('span#selection-marker-1').remove();\n\t\t\tthis.sync();\n\t\t},\n\t\ttableDeleteColumn: function()\n\t\t{\n\t\t\tvar parent = this.getParent();\n\t\t\tvar $table = $(parent).closest('table');\n\n\t\t\tif (!this.isParentRedactor($table)) return false;\n\t\t\tif ($table.length == 0) return false;\n\n\t\t\tthis.bufferSet();\n\n\t\t\tvar $current_td = $(parent).closest('td');\n\t\t\tif (!($current_td.is('td')))\n\t\t\t{\n\t\t\t\t$current_td = $current_td.closest('td');\n\t\t\t}\n\n\t\t\tvar index = $current_td.get(0).cellIndex;\n\t\t\t$table.find('tr').each($.proxy(function(i, elem)\n\t\t\t{\n\t\t\t\tvar focusIndex = index - 1 < 0 ? index + 1 : index - 1;\n\t\t\t\tif (i === 0)\n\t\t\t\t{\n\t\t\t\t\t$(elem).find('td').eq(focusIndex).prepend('<span id=\"selection-marker-1\">' + this.opts.invisibleSpace + '</span>');\n\t\t\t\t}\n\n\t\t\t\t$(elem).find('td').eq(index).remove();\n\n\t\t\t}, this));\n\n\t\t\tthis.selectionRestore();\n\t\t\t$table.find('span#selection-marker-1').remove();\n\t\t\tthis.sync();\n\t\t},\n\t\ttableAddHead: function()\n\t\t{\n\t\t\tvar $table = $(this.getParent()).closest('table');\n\t\t\tif (!this.isParentRedactor($table)) return false;\n\t\t\tif ($table.length == 0) return false;\n\n\t\t\tthis.bufferSet();\n\n\t\t\tif ($table.find('thead').length !== 0) this.tableDeleteHead();\n\t\t\telse\n\t\t\t{\n\t\t\t\tvar tr = $table.find('tr').first().clone();\n\t\t\t\ttr.find('td').replaceWith('<th></th>').html(this.opts.invisibleSpace);\n\t\t\t\t$thead = $('<thead></thead>');\n\t\t\t\t$thead.append(tr);\n\t\t\t\t$table.prepend($thead);\n\n\t\t\t\tthis.sync();\n\t\t\t}\n\t\t},\n\t\ttableDeleteHead: function()\n\t\t{\n\t\t\tvar $table = $(this.getParent()).closest('table');\n\t\t\tif (!this.isParentRedactor($table)) return false;\n\t\t\tvar $thead = $table.find('thead');\n\n\t\t\tif ($thead.length == 0) return false;\n\n\t\t\tthis.bufferSet();\n\n\t\t\t$thead.remove();\n\t\t\tthis.sync();\n\t\t},\n\t\ttableAddRowAbove: function()\n\t\t{\n\t\t\tthis.tableAddRow('before');\n\t\t},\n\t\ttableAddRowBelow: function()\n\t\t{\n\t\t\tthis.tableAddRow('after');\n\t\t},\n\t\ttableAddColumnLeft: function()\n\t\t{\n\t\t\tthis.tableAddColumn('before');\n\t\t},\n\t\ttableAddColumnRight: function()\n\t\t{\n\t\t\tthis.tableAddColumn('after');\n\t\t},\n\t\ttableAddRow: function(type)\n\t\t{\n\t\t\tvar $table = $(this.getParent()).closest('table');\n\t\t\tif (!this.isParentRedactor($table)) return false;\n\t\t\tif ($table.length == 0) return false;\n\n\t\t\tthis.bufferSet();\n\n\t\t\tvar $current_tr = $(this.getParent()).closest('tr');\n\t\t\tvar new_tr = $current_tr.clone();\n\t\t\tnew_tr.find('td').html(this.opts.invisibleSpace);\n\n\t\t\tif (type === 'after') $current_tr.after(new_tr);\n\t\t\telse $current_tr.before(new_tr);\n\n\t\t\tthis.sync();\n\t\t},\n\t\ttableAddColumn: function (type)\n\t\t{\n\t\t\tvar parent = this.getParent();\n\t\t\tvar $table = $(parent).closest('table');\n\n\t\t\tif (!this.isParentRedactor($table)) return false;\n\t\t\tif ($table.length == 0) return false;\n\n\t\t\tthis.bufferSet();\n\n\t\t\tvar index = 0;\n\n\t\t\tvar current = this.getCurrent();\n\t\t\tvar $current_tr = $(current).closest('tr');\n\t\t\tvar $current_td =  $(current).closest('td');\n\n\t\t\t$current_tr.find('td').each($.proxy(function(i, elem)\n\t\t\t{\n\t\t\t\tif ($(elem)[0] === $current_td[0]) index = i;\n\n\t\t\t}, this));\n\n\t\t\t$table.find('tr').each($.proxy(function(i, elem)\n\t\t\t{\n\t\t\t\tvar $current = $(elem).find('td').eq(index);\n\n\t\t\t\tvar td = $current.clone();\n\t\t\t\ttd.html(this.opts.invisibleSpace);\n\n\t\t\t\ttype === 'after' ? $current.after(td) : $current.before(td);\n\n\t\t\t}, this));\n\n\t\t\tthis.sync();\n\t\t},\n\t\tvideoShow: function()\n\t\t{\n\t\t\tthis.selectionSave();\n\n\t\t\tthis.modalInit(this.opts.curLang.video, this.opts.modal_video, 600, $.proxy(function()\n\t\t\t{\n\t\t\t\t$('#redactor_insert_video_btn').on('click', $.proxy(this.videoInsert, this));\n\n\t\t\t\tsetTimeout(function()\n\t\t\t\t{\n\t\t\t\t\t$('#redactor_insert_video_area').focus();\n\n\t\t\t\t}, 200);\n\n\t\t\t}, this));\n\t\t},\n\t\tvideoInsert: function ()\n\t\t{\n\t\t\tvar data = $('#redactor_insert_video_area').val();\n\t\t\tdata = this.cleanStripTags(data);\n\t\t\tvar iframeStart = '<iframe width=\"500\" height=\"281\" src=\"',\n\t\t\t\tiframeEnd = '\" frameborder=\"0\" allowfullscreen></iframe>';\n\n\t\t\tif (data.match(reUrlYoutube))\n\t\t\t{\n\t\t\t\tdata = data.replace(reUrlYoutube, iframeStart + '//www.youtube.com/embed/$1' + iframeEnd);\n\t\t\t}\n\t\t\telse if (data.match(reUrlVimeo))\n\t\t\t{\n\t\t\t\tdata = data.replace(reUrlVimeo, iframeStart + '//player.vimeo.com/video/$2' + iframeEnd);\n\t\t\t}\n            else if (data.match(reUrlFacebook))\n            {\n                data = data.replace(reUrlFacebook, iframeStart + 'https://www.facebook.com/video/embed?video_id=$1' + iframeEnd);\n            }\n\t\t\telse if (data.match(reUrlRutube))\n            {\n                data = data.replace(reUrlRutube, iframeStart + '//rutube.ru/play/embed/$1' + iframeEnd);\n            }\n\n\t\t\tthis.selectionRestore();\n\n\t\t\tvar current = this.getBlock() || this.getCurrent();\n\n\t\t\tif (current) $(current).after(data)\n\t\t\telse this.insertHtmlAdvanced(data, false);\n\n\t\t\tthis.sync();\n\t\t\tthis.modalClose();\n\t\t},\n\n\t\tlinkShow: function()\n\t\t{\n\t\t\tthis.selectionSave();\n\n\t\t\tvar callback = $.proxy(function()\n\t\t\t{\n\n\t\t\t\tif (this.opts.predefinedLinks !== false)\n\t\t\t\t{\n\t\t\t\t\tthis.predefinedLinksStorage = {};\n\t\t\t\t\tvar that = this;\n\t\t\t\t\t$.getJSON(this.opts.predefinedLinks, function(data)\n\t\t\t\t\t{\n                        if(Object.keys(data).length === 0){ return; }\n\t\t\t\t\t\tvar $select = $('#redactor-predefined-links');\n\t\t\t\t\t\t$select .html('');\n\t\t\t\t\t\t$.each(data, function(key, val)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthat.predefinedLinksStorage[key] = val;\n\t\t\t\t\t\t\t$select.append($('<option>').val(key).html(val.name));\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\t$select.on('change', function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar key = $(this).val();\n\t\t\t\t\t\t\tvar name = '', url = '';\n\t\t\t\t\t\t\tif (key != 0)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tname = that.predefinedLinksStorage[key].name;\n\t\t\t\t\t\t\t\turl = that.predefinedLinksStorage[key].url;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t$('#redactor_link_url').val(url);\n                            if($('#redactor_link_url_text').data('is_selected_text') != 1){\n                                $('#redactor_link_url_text').val(name);\n                            }\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\t$select.show();\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tthis.insert_link_node = false;\n\n\t\t\t\tvar sel = this.getSelection();\n\t\t\t\tvar url = '', text = '', target = '';\n\n\t\t\t\tvar elem = this.getParent();\n\t\t\t\tvar par = $(elem).parent().get(0);\n\t\t\t\tif (par && par.tagName === 'A')\n\t\t\t\t{\n\t\t\t\t\telem = par;\n\t\t\t\t}\n\n\t\t\t\tif (elem && elem.tagName === 'A')\n\t\t\t\t{\n\t\t\t\t\turl = elem.href;\n\t\t\t\t\ttext = $(elem).text();\n\t\t\t\t\ttarget = elem.target;\n\n\t\t\t\t\tthis.insert_link_node = elem;\n\t\t\t\t}\n\t\t\t\telse text = sel.toString();\n\n\t\t\t\t$('#redactor_link_url_text').val(text);\n                if(text.length > 0){\n                    $('#redactor_link_url_text').data('is_selected_text', 1);\n                }\n\n\t\t\t\tvar thref = self.location.href.replace(/\\/$/i, '');\n\t\t\t\turl = url.replace(thref, '');\n\t\t\t\turl = url.replace(/^\\/#/, '#');\n\t\t\t\turl = url.replace('mailto:', '');\n\t\t\t\tif (this.opts.linkProtocol === false)\n\t\t\t\t{\n\t\t\t\t\tvar re = new RegExp('^(http|ftp|https)://' + self.location.host, 'i');\n\t\t\t\t\turl = url.replace(re, '');\n\t\t\t\t}\n\t\t\t\t$('#redactor_link_url').val(url);\n\n\t\t\t\tif (target === '_blank')\n\t\t\t\t{\n\t\t\t\t\t$('#redactor_link_blank').prop('checked', true);\n\t\t\t\t}\n\n\t\t\t\tthis.linkInsertPressed = false;\n\t\t\t\t$('#redactor_insert_link_btn').on('click', $.proxy(this.linkProcess, this));\n\t\t\t\tsetTimeout(function()\n\t\t\t\t{\n\t\t\t\t\t$('#redactor_link_url').focus();\n\n\t\t\t\t}, 200);\n\n\t\t\t}, this);\n\n\t\t\tthis.modalInit(this.opts.curLang.link, this.opts.modal_link, 460, callback);\n\n\t\t},\n\t\tlinkProcess: function()\n\t\t{\n\t\t\tif (this.linkInsertPressed)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.linkInsertPressed = true;\n\t\t\tvar target = '', targetBlank = '';\n\n\t\t\tvar link = $('#redactor_link_url').val();\n\t\t\tvar text = $('#redactor_link_url_text').val();\n\t\t\tif (link.search('@') != -1 && /(http|ftp|https):\\/\\//i.test(link) === false)\n\t\t\t{\n\t\t\t\tlink = 'mailto:' + link;\n\t\t\t}\n\n\t\t\telse if (link.search('#') != 0)\n\t\t\t{\n\t\t\t\tif ($('#redactor_link_blank').prop('checked'))\n\t\t\t\t{\n\t\t\t\t\ttarget = ' target=\"_blank\"';\n\t\t\t\t\ttargetBlank = '_blank';\n\t\t\t\t}\n\t\t\t\tvar pattern = '((xn--)?[a-z0-9]+(-[a-z0-9]+)*\\.)+[a-z]{2,}';\n\t\t\t\tvar re = new RegExp('^(http|ftp|https)://' + pattern, 'i');\n\t\t\t\tvar re2 = new RegExp('^' + pattern, 'i');\n\n\t\t\t\tif (link.search(re) == -1 && link.search(re2) == 0 && this.opts.linkProtocol)\n\t\t\t\t{\n\t\t\t\t\tlink = this.opts.linkProtocol + link;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\ttext = text.replace(/<|>/g, '');\n\t\t\tvar extra = '&nbsp;';\n\t\t\tif (this.browser('mozilla'))\n\t\t\t{\n\t\t\t\textra = '&nbsp;';\n\t\t\t}\n\n\t\t\tthis.linkInsert('<a href=\"' + link + '\"' + target + '>' + text + '</a>' + extra, $.trim(text), link, targetBlank);\n\n\t\t},\n\t\tlinkInsert: function (a, text, link, target)\n\t\t{\n\t\t\tthis.selectionRestore();\n\n\t\t\tif (text !== '')\n\t\t\t{\n\t\t\t\tif (this.insert_link_node)\n\t\t\t\t{\n\t\t\t\t\tthis.bufferSet();\n\n\t\t\t\t\t$(this.insert_link_node).text(text).attr('href', link);\n\n\t\t\t\t\tif (target !== '')\n\t\t\t\t\t{\n\t\t\t\t\t\t$(this.insert_link_node).attr('target', target);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t$(this.insert_link_node).removeAttr('target');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tvar $a = $(a).addClass('redactor-added-link');\n\t\t\t\t\tthis.exec('inserthtml', this.outerHtml($a), false);\n\n\t\t\t\t\tvar link = this.$editor.find('a.redactor-added-link');\n\n\t\t\t\t\tlink.removeAttr('style').removeClass('redactor-added-link').each(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tif (this.className == '') $(this).removeAttr('class');\n\t\t\t\t\t});\n\n\t\t\t\t}\n\n\t\t\t\tthis.sync();\n\t\t\t}\n\t\t\tsetTimeout($.proxy(function()\n\t\t\t{\n\t\t\t\tif (this.opts.observeLinks) this.observeLinks();\n\n\t\t\t}, this), 5);\n\n\t\t\tthis.modalClose();\n\t\t},\n\t\tfileShow: function ()\n\t\t{\n\n\t\t\tthis.selectionSave();\n\n\t\t\tvar callback = $.proxy(function()\n\t\t\t{\n\t\t\t\tvar sel = this.getSelection();\n\n\t\t\t\tvar text = '';\n\t\t\t\tif (this.oldIE()) text = sel.text;\n\t\t\t\telse text = sel.toString();\n\n\t\t\t\t$('#redactor_filename').val(text);\n\t\t\t\tif (!this.isMobile() && !this.isIPad())\n\t\t\t\t{\n\t\t\t\t\tthis.draguploadInit('#redactor_file', {\n\t\t\t\t\t\turl: this.opts.fileUpload,\n\t\t\t\t\t\tuploadFields: this.opts.uploadFields,\n\t\t\t\t\t\tsuccess: $.proxy(this.fileCallback, this),\n\t\t\t\t\t\terror: $.proxy( function(obj, json)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.callback('fileUploadError', json);\n\n\t\t\t\t\t\t}, this),\n\t\t\t\t\t\tuploadParam: this.opts.fileUploadParam\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tthis.uploadInit('redactor_file', {\n\t\t\t\t\tauto: true,\n\t\t\t\t\turl: this.opts.fileUpload,\n\t\t\t\t\tsuccess: $.proxy(this.fileCallback, this),\n\t\t\t\t\terror: $.proxy(function(obj, json)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.callback('fileUploadError', json);\n\n\t\t\t\t\t}, this)\n\t\t\t\t});\n\n\t\t\t}, this);\n\n\t\t\tthis.modalInit(this.opts.curLang.file, this.opts.modal_file, 500, callback);\n\t\t},\n\t\tfileCallback: function(json)\n\t\t{\n\n\t\t\tthis.selectionRestore();\n\n\t\t\tif (json !== false)\n\t\t\t{\n\n\t\t\t\tvar text = $('#redactor_filename').val();\n\t\t\t\tif (text === '') text = json.filename;\n\n\t\t\t\tvar link = '<a href=\"' + json.filelink + '\" id=\"filelink-marker\">' + text + '</a>';\n\t\t\t\tif (this.browser('webkit') && !!this.window.chrome)\n\t\t\t\t{\n\t\t\t\t\tlink = link + '&nbsp;';\n\t\t\t\t}\n\n\t\t\t\tthis.execCommand('inserthtml', link, false);\n\n\t\t\t\tvar linkmarker = $(this.$editor.find('a#filelink-marker'));\n\t\t\t\tif (linkmarker.length != 0) linkmarker.removeAttr('id');\n\t\t\t\telse linkmarker = false;\n\n\t\t\t\tthis.sync();\n\t\t\t\tthis.callback('fileUpload', linkmarker, json);\n\t\t\t}\n\n\t\t\tthis.modalClose();\n\t\t},\n\t\timageShow: function()\n\t\t{\n\n\t\t\tthis.selectionSave();\n\n\t\t\tvar callback = $.proxy(function()\n\t\t\t{\n\n\t\t\t\tif (this.opts.imageGetJson)\n\t\t\t\t{\n\n\t\t\t\t\t$.getJSON(this.opts.imageGetJson, $.proxy(function(data)\n\t\t\t\t\t{\n                        if(data.error){\n                            alert(data.message); return;\n                        }\n\t\t\t\t\t\tvar folders = {}, count = 0;\n\t\t\t\t\t\t$.each(data, $.proxy(function(key, val)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif (typeof val.folder !== 'undefined')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tcount++;\n\t\t\t\t\t\t\t\tfolders[val.folder] = count;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t}, this));\n\n                        $('#redactor_image_box .empty_list').show();\n\t\t\t\t\t\tvar folderclass = false;\n\t\t\t\t\t\t$.each(data, $.proxy(function(key, val)\n\t\t\t\t\t\t{\n\n\t\t\t\t\t\t\tvar thumbtitle = '';\n\t\t\t\t\t\t\tif (typeof val.title !== 'undefined') thumbtitle = val.title;\n\n\t\t\t\t\t\t\tvar folderkey = 0;\n\t\t\t\t\t\t\tif (!$.isEmptyObject(folders) && typeof val.folder !== 'undefined')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tfolderkey = folders[val.folder];\n\t\t\t\t\t\t\t\tif (folderclass === false) folderclass = '.redactorfolder' + folderkey;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tvar img = $('<img src=\"' + val.thumb + '\" class=\"redactorfolder redactorfolder' + folderkey + '\" rel=\"' + val.image + '\" title=\"' + thumbtitle + '\" />');\n\t\t\t\t\t\t\t$('#redactor_image_box').append(img);\n\t\t\t\t\t\t\t$(img).on('click', $.proxy(this.imageThumbClick, this));\n                            $('#redactor_image_box .empty_list').hide();\n\t\t\t\t\t\t}, this));\n\t\t\t\t\t\tif (!$.isEmptyObject(folders))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$('.redactorfolder').hide();\n\t\t\t\t\t\t\t$(folderclass).show();\n\n\t\t\t\t\t\t\tvar onchangeFunc = function(e)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$('.redactorfolder').hide();\n\t\t\t\t\t\t\t\t$('.redactorfolder' + $(e.target).val()).show();\n\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\tvar select = $('<select id=\"redactor_image_box_select\">');\n\t\t\t\t\t\t\t$.each( folders, function(k, v)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tselect.append( $('<option value=\"' + v + '\">' + k + '</option>'));\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t$('#redactor_image_box').before(select);\n\t\t\t\t\t\t\tselect.change(onchangeFunc);\n\t\t\t\t\t\t}\n\t\t\t\t\t}, this));\n\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$('#redactor-tab-control-2').remove();\n\t\t\t\t}\n\n\t\t\t\tif (this.opts.imageUpload || this.opts.s3)\n\t\t\t\t{\n\n\t\t\t\t\tif (!this.isMobile()  && !this.isIPad() && this.opts.s3 === false)\n\t\t\t\t\t{\n\t\t\t\t\t\tif ($('#redactor_file' ).length)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.draguploadInit('#redactor_file', {\n\t\t\t\t\t\t\t\turl: this.opts.imageUpload,\n\t\t\t\t\t\t\t\tuploadFields: this.opts.uploadFields,\n\t\t\t\t\t\t\t\tsuccess: $.proxy(this.imageCallback, this),\n\t\t\t\t\t\t\t\terror: $.proxy(function(obj, json)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tthis.callback('imageUploadError', json);\n\n\t\t\t\t\t\t\t\t}, this),\n\t\t\t\t\t\t\t\tuploadParam: this.opts.imageUploadParam\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.opts.s3 === false)\n\t\t\t\t\t{\n\n\t\t\t\t\t\tthis.uploadInit('redactor_file', {\n\t\t\t\t\t\t\tauto: true,\n\t\t\t\t\t\t\turl: this.opts.imageUpload,\n\t\t\t\t\t\t\tsuccess: $.proxy(this.imageCallback, this),\n\t\t\t\t\t\t\terror: $.proxy(function(obj, json)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tthis.callback('imageUploadError', json);\n\n\t\t\t\t\t\t\t}, this)\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t$('#redactor_file').on('change.redactor', $.proxy(this.s3handleFileSelect, this));\n\t\t\t\t\t}\n\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$('.redactor_tab').hide();\n\t\t\t\t\tif (!this.opts.imageGetJson)\n\t\t\t\t\t{\n\t\t\t\t\t\t$('#redactor_tabs').remove();\n\t\t\t\t\t\t$('#redactor_tab3').show();\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t$('#redactor-tab-control-1').remove();\n\t\t\t\t\t\t$('#redactor-tab-control-2').addClass('redactor_tabs_act');\n\t\t\t\t\t\t$('#redactor_tab2').show();\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (!this.opts.imageTabLink && (this.opts.imageUpload || this.opts.imageGetJson))\n\t\t\t\t{\n\t\t\t\t\t$('#redactor-tab-control-3').hide();\n\t\t\t\t}\n\n\t\t\t\t$('#redactor_upload_btn').on('click', $.proxy(this.imageCallbackLink, this));\n\n\t\t\t\tif (!this.opts.imageUpload && !this.opts.imageGetJson)\n\t\t\t\t{\n\t\t\t\t\tsetTimeout(function()\n\t\t\t\t\t{\n\t\t\t\t\t\t$('#redactor_file_link').focus();\n\n\t\t\t\t\t}, 200);\n\t\t\t\t}\n\n\t\t\t}, this);\n\n\t\t\tthis.modalInit(this.opts.curLang.image, this.opts.modal_image, 610, callback);\n\n\t\t},\n\t\timageEdit: function(image)\n\t\t{\n\t\t\tvar $el = image;\n\t\t\tvar parent = $el.parent().parent();\n\n\t\t\tvar callback = $.proxy(function()\n\t\t\t{\n\t\t\t\t$('#redactor_file_alt').val($el.attr('alt'));\n\t\t\t\t$('#redactor_image_edit_src').attr('href', $el.attr('src'));\n\n\t\t\t\tif ($el.css('display') == 'block' && $el.css('float') == 'none')\n\t\t\t\t{\n\t\t\t\t\t$('#redactor_form_image_align').val('center');\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$('#redactor_form_image_align').val($el.css('float'));\n\t\t\t\t}\n\n\t\t\t\tif ($(parent).get(0).tagName === 'A')\n\t\t\t\t{\n\t\t\t\t\t$('#redactor_file_link').val($(parent).attr('href'));\n\n\t\t\t\t\tif ($(parent).attr('target') == '_blank')\n\t\t\t\t\t{\n\t\t\t\t\t\t$('#redactor_link_blank').prop('checked', true);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t$('#redactor_image_delete_btn').on('click', $.proxy(function()\n\t\t\t\t{\n\t\t\t\t\tthis.imageRemove($el);\n\n\t\t\t\t}, this));\n\n\t\t\t\t$('#redactorSaveBtn').on('click', $.proxy(function()\n\t\t\t\t{\n\t\t\t\t\tthis.imageSave($el);\n\n\t\t\t\t}, this));\n\n\t\t\t}, this);\n\n\t\t\tthis.modalInit(this.opts.curLang.edit, this.opts.modal_image_edit, 380, callback);\n\n\t\t},\n\t\timageRemove: function(el)\n\t\t{\n\t\t\tvar parentLink = $(el).parent().parent();\n\t\t\tvar parent = $(el).parent();\n\t\t\tvar parentEl = false;\n\n\t\t\tif (parentLink.length && parentLink[0].tagName === 'A')\n\t\t\t{\n\t\t\t\tparentEl = true;\n\t\t\t\t$(parentLink).remove();\n\t\t\t}\n\t\t\telse if (parent.length && parent[0].tagName === 'A')\n\t\t\t{\n\t\t\t\tparentEl = true;\n\t\t\t\t$(parent).remove();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$(el).remove();\n\t\t\t}\n\n\t\t\tif (parent.length && parent[0].tagName === 'P')\n\t\t\t{\n\t\t\t\tthis.focusWithSaveScroll();\n\n\t\t\t\tif (parentEl === false) this.selectionStart(parent);\n\t\t\t}\n\t\t\tthis.callback('imageDelete', el);\n\n\t\t\tthis.modalClose();\n\t\t\tthis.sync();\n\t\t},\n\t\timageSave: function(el)\n\t\t{\n\t\t\tthis.imageResizeHide(false);\n\n\t\t\tvar $el = $(el);\n\t\t\tvar parent = $el.parent();\n\n\t\t\t$el.attr('alt', $('#redactor_file_alt').val());\n\n\t\t\tvar floating = $('#redactor_form_image_align').val();\n\t\t\tvar margin = '';\n\n\t\t\tif (floating === 'left')\n\t\t\t{\n\t\t\t\tmargin = '0 ' + this.opts.imageFloatMargin + ' ' + this.opts.imageFloatMargin + ' 0';\n\t\t\t\t$el.css({ 'float': 'left', 'margin': margin });\n\t\t\t}\n\t\t\telse if (floating === 'right')\n\t\t\t{\n\t\t\t\tmargin = '0 0 ' + this.opts.imageFloatMargin + ' ' + this.opts.imageFloatMargin + '';\n\t\t\t\t$el.css({ 'float': 'right', 'margin': margin });\n\t\t\t}\n\t\t\telse if (floating === 'center')\n\t\t\t{\n\t\t\t\t$el.css({ 'float': '', 'display': 'block', 'margin': 'auto' });\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$el.css({ 'float': '', 'display': '', 'margin': '' });\n\t\t\t}\n\t\t\tvar link = $.trim($('#redactor_file_link').val());\n\t\t\tif (link !== '')\n\t\t\t{\n\t\t\t\tvar target = false;\n\t\t\t\tif ($('#redactor_link_blank').prop('checked'))\n\t\t\t\t{\n\t\t\t\t\ttarget = true;\n\t\t\t\t}\n\n\t\t\t\tif (parent.get(0).tagName !== 'A')\n\t\t\t\t{\n\t\t\t\t\tvar a = $('<a href=\"' + link + '\">' + this.outerHtml(el) + '</a>');\n\n\t\t\t\t\tif (target)\n\t\t\t\t\t{\n\t\t\t\t\t\ta.attr('target', '_blank');\n\t\t\t\t\t}\n\n\t\t\t\t\t$el.replaceWith(a);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tparent.attr('href', link);\n\t\t\t\t\tif (target)\n\t\t\t\t\t{\n\t\t\t\t\t\tparent.attr('target', '_blank');\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tparent.removeAttr('target');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tif (parent.get(0).tagName === 'A')\n\t\t\t\t{\n\t\t\t\t\tparent.replaceWith(this.outerHtml(el));\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.modalClose();\n\t\t\tthis.observeImages();\n\t\t\tthis.sync();\n\n\t\t},\n\t\timageResizeHide: function(e)\n\t\t{\n\t\t\tif (e !== false && $(e.target).parent().length != 0 && $(e.target).parent()[0].id === 'redactor-image-box')\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tvar imageBox = this.$editor.find('#redactor-image-box');\n\t\t\tif (imageBox.length == 0)\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tthis.$editor.find('#redactor-image-editter, #redactor-image-resizer').remove();\n\n\t\t\timageBox.find('img').css({\n\t\t\t\tmarginTop: imageBox[0].style.marginTop,\n\t\t\t\tmarginBottom: imageBox[0].style.marginBottom,\n\t\t\t\tmarginLeft: imageBox[0].style.marginLeft,\n\t\t\t\tmarginRight: imageBox[0].style.marginRight\n\t\t\t});\n\n\t\t\timageBox.css('margin', '');\n\t\t\timageBox.find('img').css('opacity', '');\n\t\t\timageBox.replaceWith(function()\n\t\t\t{\n\t\t\t\treturn $(this).contents();\n\t\t\t});\n\n\t\t\t$(document).off('click.redactor-image-resize-hide');\n\t\t\tthis.$editor.off('click.redactor-image-resize-hide');\n\t\t\tthis.$editor.off('keydown.redactor-image-delete');\n\n\t\t\tthis.sync()\n\n\t\t},\n\t\timageResize: function(image)\n\t\t{\n\t\t\tvar $image = $(image);\n\n\t\t\t$image.on('mousedown', $.proxy(function()\n\t\t\t{\n\t\t\t\tthis.imageResizeHide(false);\n\t\t\t}, this));\n\n\t\t\t$image.on('dragstart', $.proxy(function()\n\t\t\t{\n\t\t\t\tthis.$editor.on('drop.redactor-image-inside-drop', $.proxy(function()\n\t\t\t\t{\n\t\t\t\t\tsetTimeout($.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.observeImages();\n\t\t\t\t\t\tthis.$editor.off('drop.redactor-image-inside-drop');\n\t\t\t\t\t\tthis.sync();\n\n\t\t\t\t\t}, this), 1);\n\n\t\t\t\t},this));\n\t\t\t}, this));\n\n\t\t\t$image.on('click', $.proxy(function(e)\n\t\t\t{\n\t\t\t\tif (this.$editor.find('#redactor-image-box').length != 0)\n\t\t\t\t{\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tvar clicked = false,\n\t\t\t\tstart_x,\n\t\t\t\tstart_y,\n\t\t\t\tratio = $image.width() / $image.height(),\n\t\t\t\tmin_w = 20,\n\t\t\t\tmin_h = 10;\n\n\t\t\t\tvar imageResizer = this.imageResizeControls($image);\n\t\t\t\tvar isResizing = false;\n\t\t\t\tif (imageResizer !== false)\n\t\t\t\t{\n\t\t\t\t\timageResizer.on('mousedown', function(e)\n\t\t\t\t\t{\n\t\t\t\t\t\tisResizing = true;\n\t\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t\tratio = $image.width() / $image.height();\n\n\t\t\t\t\t\tstart_x = Math.round(e.pageX - $image.eq(0).offset().left);\n\t\t\t\t\t\tstart_y = Math.round(e.pageY - $image.eq(0).offset().top);\n\n\t\t\t\t\t});\n\n\t\t\t\t\t$(this.document.body).on('mousemove', $.proxy(function(e)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (isResizing)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar mouse_x = Math.round(e.pageX - $image.eq(0).offset().left) - start_x;\n\t\t\t\t\t\t\tvar mouse_y = Math.round(e.pageY - $image.eq(0).offset().top) - start_y;\n\n\t\t\t\t\t\t\tvar div_h = $image.height();\n\n\t\t\t\t\t\t\tvar new_h = parseInt(div_h, 10) + mouse_y;\n\t\t\t\t\t\t\tvar new_w = Math.round(new_h * ratio);\n\n\t\t\t\t\t\t\tif (new_w > min_w)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$image.width(new_w);\n\n\t\t\t\t\t\t\t\tif (new_w < 100)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tthis.imageEditter.css({\n\t\t\t\t\t\t\t\t\t\tmarginTop: '-7px',\n\t\t\t\t\t\t\t\t\t\tmarginLeft: '-13px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '9px',\n\t\t\t\t\t\t\t\t\t\tpadding: '3px 5px'\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tthis.imageEditter.css({\n\t\t\t\t\t\t\t\t\t\tmarginTop: '-11px',\n\t\t\t\t\t\t\t\t\t\tmarginLeft: '-18px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\tpadding: '7px 10px'\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tstart_x = Math.round(e.pageX - $image.eq(0).offset().left);\n\t\t\t\t\t\t\tstart_y = Math.round(e.pageY - $image.eq(0).offset().top);\n\n\t\t\t\t\t\t\tthis.sync()\n\t\t\t\t\t\t}\n\t\t\t\t\t}, this)).on('mouseup', function()\n\t\t\t\t\t{\n\t\t\t\t\t\tisResizing = false;\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tthis.$editor.on('keydown.redactor-image-delete', $.proxy(function(e)\n\t\t\t\t{\n\t\t\t\t\tvar key = e.which;\n\n\t\t\t\t\tif (this.keyCode.BACKSPACE == key || this.keyCode.DELETE == key)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.bufferSet(false);\n\t\t\t\t\t\tthis.imageResizeHide(false);\n\t\t\t\t\t\tthis.imageRemove($image);\n\t\t\t\t\t}\n\n\t\t\t\t}, this));\n\n\t\t\t\t$(document).on('click.redactor-image-resize-hide', $.proxy(this.imageResizeHide, this));\n\t\t\t\tthis.$editor.on('click.redactor-image-resize-hide', $.proxy(this.imageResizeHide, this));\n\t\t\t}, this));\n\t\t},\n\t\timageResizeControls: function($image)\n\t\t{\n\t\t\tvar imageBox = $('<span id=\"redactor-image-box\" data-redactor=\"verified\">');\n\t\t\timageBox.css({\n\t\t\t\tposition: 'relative',\n\t\t\t\tdisplay: 'inline-block',\n\t\t\t\tlineHeight: 0,\n\t\t\t\toutline: '1px dashed rgba(0, 0, 0, .6)',\n\t\t\t\t'float': $image.css('float')\n\t\t\t});\n\t\t\timageBox.attr('contenteditable', false);\n\n\t\t\tif ($image[0].style.margin != 'auto')\n\t\t\t{\n\t\t\t\timageBox.css({\n\t\t\t\t\tmarginTop: $image[0].style.marginTop,\n\t\t\t\t\tmarginBottom: $image[0].style.marginBottom,\n\t\t\t\t\tmarginLeft: $image[0].style.marginLeft,\n\t\t\t\t\tmarginRight: $image[0].style.marginRight\n\t\t\t\t});\n\n\t\t\t\t$image.css('margin', '');\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\timageBox.css({ 'display': 'block', 'margin': 'auto' });\n\t\t\t}\n\n\t\t\t$image.css('opacity', .5).after(imageBox);\n\t\t\tthis.imageEditter = $('<span id=\"redactor-image-editter\" data-redactor=\"verified\">' + this.opts.curLang.edit + '</span>');\n\t\t\tthis.imageEditter.css({\n\t\t\t\tposition: 'absolute',\n\t\t\t\tzIndex: 5,\n\t\t\t\ttop: '50%',\n\t\t\t\tleft: '50%',\n\t\t\t\tmarginTop: '-11px',\n\t\t\t\tmarginLeft: '-18px',\n\t\t\t\tlineHeight: 1,\n\t\t\t\tbackgroundColor: '#000',\n\t\t\t\tcolor: '#fff',\n\t\t\t\tfontSize: '11px',\n\t\t\t\tpadding: '7px 10px',\n\t\t\t\tcursor: 'pointer'\n\t\t\t});\n\t\t\tthis.imageEditter.attr('contenteditable', false);\n\t\t\tthis.imageEditter.on('click', $.proxy(function()\n\t\t\t{\n\t\t\t\tthis.imageEdit($image);\n\t\t\t}, this));\n\t\t\timageBox.append(this.imageEditter);\n\t\t\tif (this.opts.imageResizable)\n\t\t\t{\n\t\t\t\tvar imageResizer = $('<span id=\"redactor-image-resizer\" data-redactor=\"verified\"></span>');\n\t\t\t\timageResizer.css({\n\t\t\t\t\tposition: 'absolute',\n\t\t\t\t\tzIndex: 2,\n\t\t\t\t\tlineHeight: 1,\n\t\t\t\t\tcursor: 'nw-resize',\n\t\t\t\t\tbottom: '-4px',\n\t\t\t\t\tright: '-5px',\n\t\t\t\t\tborder: '1px solid #fff',\n\t\t\t\t\tbackgroundColor: '#000',\n\t\t\t\t\twidth: '8px',\n\t\t\t\t\theight: '8px'\n\t\t\t\t});\n\t\t\t\timageResizer.attr('contenteditable', false);\n\t\t\t\timageBox.append(imageResizer);\n\n\t\t\t\timageBox.append($image);\n\n\t\t\t\treturn imageResizer;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\timageBox.append($image);\n\n\t\t\t\treturn false;\n\t\t\t}\n\t\t},\n\t\timageThumbClick: function(e)\n\t\t{\n\t\t\tvar img = '<img id=\"image-marker\" src=\"' + $(e.target).attr('rel') + '\" alt=\"' + $(e.target).attr('title') + '\" />';\n\n\t\t\tvar parent = this.getParent();\n\t\t\tif (this.opts.paragraphy && $(parent).closest('li').length == 0) img = '<p>' + img + '</p>';\n\n\t\t\tthis.imageInsert(img, true);\n\t\t},\n\t\timageCallbackLink: function()\n\t\t{\n\t\t\tvar val = $('#redactor_file_link').val();\n\n\t\t\tif (val !== '')\n\t\t\t{\n\t\t\t\tvar data = '<img id=\"image-marker\" src=\"' + val + '\" />';\n\t\t\t\tif (this.opts.linebreaks === false) data = '<p>' + data + '</p>';\n\n\t\t\t\tthis.imageInsert(data, true);\n\n\t\t\t}\n\t\t\telse this.modalClose();\n\t\t},\n\t\timageCallback: function(data)\n\t\t{\n\t\t\tthis.imageInsert(data);\n\t\t},\n\t\timageInsert: function(json, link)\n\t\t{\n\t\t\tthis.selectionRestore();\n\n\t\t\tif (json !== false)\n\t\t\t{\n\t\t\t\tvar html = '';\n\t\t\t\tif (link !== true)\n\t\t\t\t{\n\t\t\t\t\thtml = '<img id=\"image-marker\" src=\"' + json.image.url + '\" />';\n\n\t\t\t\t\tvar parent = this.getParent();\n\t\t\t\t\tif (this.opts.paragraphy && $(parent).closest('li').length == 0)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = '<p>' + html + '</p>';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\thtml = json;\n\t\t\t\t}\n\n\t\t\t\tthis.execCommand('inserthtml', html, false);\n\n\t\t\t\tvar image = $(this.$editor.find('img#image-marker'));\n\n\t\t\t\tif (image.length) image.removeAttr('id');\n\t\t\t\telse image = false;\n\n\t\t\t\tthis.sync();\n\t\t\t\tlink !== true && this.callback('imageUpload', image, json);\n\t\t\t}\n\n\t\t\tthis.modalClose();\n\t\t\tthis.observeImages();\n\t\t},\n\t\tbuildProgressBar: function()\n\t\t{\n\t\t\tif ($('#redactor-progress').length != 0) return;\n\n\t\t\tthis.$progressBar = $('<div id=\"redactor-progress\"><span></span></div>');\n\t\t\t$(document.body).append(this.$progressBar);\n\t\t},\n\t\tshowProgressBar: function()\n\t\t{\n\t\t\tthis.buildProgressBar();\n\t\t\t$('#redactor-progress').fadeIn();\n\t\t},\n\t\thideProgressBar: function()\n\t\t{\n\t\t\t$('#redactor-progress').fadeOut(1500);\n\t\t},\n\t\tmodalTemplatesInit: function()\n\t\t{\n\t\t\t$.extend( this.opts,\n\t\t\t{\n\t\t\t\tmodal_file: String()\n\t\t\t\t+ '<section id=\"redactor-modal-file-insert\">'\n\t\t\t\t\t+ '<form id=\"redactorUploadFileForm\" method=\"post\" action=\"\" enctype=\"multipart/form-data\">'\n\t\t\t\t\t\t+ '<label>' + this.opts.curLang.filename + '</label>'\n\t\t\t\t\t\t+ '<input type=\"text\" id=\"redactor_filename\" class=\"redactor_input\" />'\n\t\t\t\t\t\t+ '<div style=\"margin-top: 7px;\">'\n\t\t\t\t\t\t\t+ '<input type=\"file\" id=\"redactor_file\" name=\"' + this.opts.fileUploadParam + '\" />'\n\t\t\t\t\t\t+ '</div>'\n\t\t\t\t\t+ '</form>'\n\t\t\t\t+ '</section>',\n\n\t\t\t\tmodal_image_edit: String()\n\t\t\t\t+ '<section id=\"redactor-modal-image-edit\">'\n\t\t\t\t\t+ '<label>' + this.opts.curLang.title + '</label>'\n\t\t\t\t\t+ '<input type=\"text\" id=\"redactor_file_alt\" class=\"redactor_input\" />'\n\t\t\t\t\t+ '<label>' + this.opts.curLang.link + '</label>'\n\t\t\t\t\t+ '<input type=\"text\" id=\"redactor_file_link\" class=\"redactor_input\" />'\n\t\t\t\t\t+ '<label><input type=\"checkbox\" id=\"redactor_link_blank\"> ' + this.opts.curLang.link_new_tab + '</label>'\n\t\t\t\t\t+ '<label>' + this.opts.curLang.image_position + '</label>'\n\t\t\t\t\t+ '<select id=\"redactor_form_image_align\">'\n\t\t\t\t\t\t+ '<option value=\"none\">' + this.opts.curLang.none + '</option>'\n\t\t\t\t\t\t+ '<option value=\"left\">' + this.opts.curLang.left + '</option>'\n\t\t\t\t\t\t+ '<option value=\"center\">' + this.opts.curLang.center + '</option>'\n\t\t\t\t\t\t+ '<option value=\"right\">' + this.opts.curLang.right + '</option>'\n\t\t\t\t\t+ '</select>'\n\t\t\t\t+ '</section>'\n\t\t\t\t+ '<footer>'\n\t\t\t\t\t+ '<button id=\"redactor_image_delete_btn\" class=\"redactor_modal_btn redactor_modal_delete_btn\">' + this.opts.curLang._delete + '</button>'\n\t\t\t\t\t+ '<button class=\"redactor_modal_btn redactor_btn_modal_close\">' + this.opts.curLang.cancel + '</button>'\n\t\t\t\t\t+ '<button id=\"redactorSaveBtn\" class=\"redactor_modal_btn redactor_modal_action_btn\">' + this.opts.curLang.save + '</button>'\n\t\t\t\t+ '</footer>',\n\n\t\t\t\tmodal_image: String()\n\t\t\t\t+ '<section id=\"redactor-modal-image-insert\">'\n\t\t\t\t\t+ '<div id=\"redactor_tabs\">'\n\t\t\t\t\t\t+ '<a href=\"#\" id=\"redactor-tab-control-1\" class=\"redactor_tabs_act\">' + this.opts.curLang.upload + '</a>'\n\t\t\t\t\t\t+ '<a href=\"#\" id=\"redactor-tab-control-2\">' + this.opts.curLang.choose + '</a>'\n\t\t\t\t\t\t+ '<a href=\"#\" id=\"redactor-tab-control-3\">' + this.opts.curLang.link + '</a>'\n\t\t\t\t\t+ '</div>'\n\t\t\t\t\t+ '<form id=\"redactorInsertImageForm\" method=\"post\" action=\"\" enctype=\"multipart/form-data\">'\n\t\t\t\t\t\t+ '<div id=\"redactor_tab1\" class=\"redactor_tab\">'\n\t\t\t\t\t\t\t+ '<input type=\"file\" id=\"redactor_file\" name=\"' + this.opts.imageUploadParam + '\" />'\n\t\t\t\t\t\t+ '</div>'\n\t\t\t\t\t\t+ '<div id=\"redactor_tab2\" class=\"redactor_tab\" style=\"display: none;\">'\n\t\t\t\t\t\t\t+ '<div id=\"redactor_image_box\"><span class=\"empty_list\">' + this.opts.curLang.empty_img_list + '</span></div>'\n\t\t\t\t\t\t+ '</div>'\n\t\t\t\t\t+ '</form>'\n\t\t\t\t\t+ '<div id=\"redactor_tab3\" class=\"redactor_tab\" style=\"display: none;\">'\n\t\t\t\t\t\t+ '<label>' + this.opts.curLang.image_web_link + '</label>'\n\t\t\t\t\t\t+ '<input type=\"text\" name=\"redactor_file_link\" id=\"redactor_file_link\" class=\"redactor_input\"  /><br><br>'\n\t\t\t\t\t+ '</div>'\n\t\t\t\t+ '</section>'\n\t\t\t\t+ '<footer>'\n\t\t\t\t\t+ '<button class=\"redactor_modal_btn redactor_btn_modal_close\">' + this.opts.curLang.cancel + '</button>'\n\t\t\t\t\t+ '<button class=\"redactor_modal_btn redactor_modal_action_btn\" id=\"redactor_upload_btn\">' + this.opts.curLang.insert + '</button>'\n\t\t\t\t+ '</footer>',\n\n\t\t\t\tmodal_link: String()\n\t\t\t\t+ '<section id=\"redactor-modal-link-insert\">'\n\t\t\t\t\t+ '<select id=\"redactor-predefined-links\" style=\"width: 99.5%; display: none;\"></select>'\n\t\t\t\t\t+ '<label>URL</label>'\n\t\t\t\t\t+ '<input type=\"text\" class=\"redactor_input\" id=\"redactor_link_url\" />'\n\t\t\t\t\t+ '<label>' + this.opts.curLang.text + '</label>'\n\t\t\t\t\t+ '<input type=\"text\" class=\"redactor_input\" id=\"redactor_link_url_text\" />'\n\t\t\t\t\t+ '<label><input type=\"checkbox\" id=\"redactor_link_blank\"> ' + this.opts.curLang.link_new_tab + '</label>'\n\t\t\t\t+ '</section>'\n\t\t\t\t+ '<footer>'\n\t\t\t\t\t+ '<button class=\"redactor_modal_btn redactor_btn_modal_close\">' + this.opts.curLang.cancel + '</button>'\n\t\t\t\t\t+ '<button id=\"redactor_insert_link_btn\" class=\"redactor_modal_btn redactor_modal_action_btn\">' + this.opts.curLang.insert + '</button>'\n\t\t\t\t+ '</footer>',\n\n\t\t\t\tmodal_table: String()\n\t\t\t\t+ '<section id=\"redactor-modal-table-insert\">'\n\t\t\t\t\t+ '<label>' + this.opts.curLang.rows + '</label>'\n\t\t\t\t\t+ '<input type=\"text\" size=\"5\" value=\"2\" id=\"redactor_table_rows\" />'\n\t\t\t\t\t+ '<label>' + this.opts.curLang.columns + '</label>'\n\t\t\t\t\t+ '<input type=\"text\" size=\"5\" value=\"3\" id=\"redactor_table_columns\" />'\n\t\t\t\t+ '</section>'\n\t\t\t\t+ '<footer>'\n\t\t\t\t\t+ '<button class=\"redactor_modal_btn redactor_btn_modal_close\">' + this.opts.curLang.cancel + '</button>'\n\t\t\t\t\t+ '<button id=\"redactor_insert_table_btn\" class=\"redactor_modal_btn redactor_modal_action_btn\">' + this.opts.curLang.insert + '</button>'\n\t\t\t\t+ '</footer>',\n\n\t\t\t\tmodal_video: String()\n\t\t\t\t+ '<section id=\"redactor-modal-video-insert\">'\n\t\t\t\t\t+ '<form id=\"redactorInsertVideoForm\">'\n\t\t\t\t\t\t+ '<label>' + this.opts.curLang.video_html_code + '</label>'\n\t\t\t\t\t\t+ '<textarea id=\"redactor_insert_video_area\" style=\"width: 99%; height: 160px;\"></textarea>'\n\t\t\t\t\t+ '</form>'\n\t\t\t\t+ '</section>'\n\t\t\t\t+ '<footer>'\n\t\t\t\t\t+ '<button class=\"redactor_modal_btn redactor_btn_modal_close\">' + this.opts.curLang.cancel + '</button>'\n\t\t\t\t\t+ '<button id=\"redactor_insert_video_btn\" class=\"redactor_modal_btn redactor_modal_action_btn\">' + this.opts.curLang.insert + '</button>'\n\t\t\t\t+ '</footer>'\n\n\t\t\t});\n\t\t},\n\t\tmodalInit: function(title, content, width, callback)\n\t\t{\n\t\t\tthis.modalSetOverlay();\n\n\t\t\tthis.$redactorModalWidth = width;\n\t\t\tthis.$redactorModal = $('#redactor_modal');\n\n\t\t\tif (!this.$redactorModal.length)\n\t\t\t{\n\t\t\t\tthis.$redactorModal = $('<div id=\"redactor_modal\" style=\"display: none;\" />');\n\t\t\t\tthis.$redactorModal.append($('<div id=\"redactor_modal_close\">&times;</div>'));\n\t\t\t\tthis.$redactorModal.append($('<header id=\"redactor_modal_header\" />'));\n\t\t\t\tthis.$redactorModal.append($('<div id=\"redactor_modal_inner\" />'));\n\t\t\t\tthis.$redactorModal.appendTo(document.body);\n\t\t\t}\n\n\t\t\t$('#redactor_modal_close').on('click', $.proxy(this.modalClose, this));\n\t\t\t$(document).on('keyup', $.proxy(this.modalCloseHandler, this));\n\t\t\tthis.$editor.on('keyup', $.proxy(this.modalCloseHandler, this));\n\n\t\t\tthis.modalSetContent(content);\n\t\t\tthis.modalSetTitle(title);\n\t\t\tthis.modalSetDraggable();\n\t\t\tthis.modalLoadTabs();\n\t\t\tthis.modalOnCloseButton();\n\t\t\tthis.modalSetButtonsWidth();\n\n\t\t\tthis.saveModalScroll = this.document.body.scrollTop;\n\t\t\tif (this.opts.autoresize === false)\n\t\t\t{\n\t\t\t\tthis.saveModalScroll = this.$editor.scrollTop();\n\t\t\t}\n\n\t\t\tif (this.isMobile() === false) this.modalShowOnDesktop();\n\t\t\telse this.modalShowOnMobile();\n\t\t\tif (typeof callback === 'function')\n\t\t\t{\n\t\t\t\tcallback();\n\t\t\t}\n\t\t\tsetTimeout($.proxy(function()\n\t\t\t{\n\t\t\t\tthis.callback('modalOpened', this.$redactorModal);\n\n\t\t\t}, this), 11);\n\t\t\t$(document).off('focusin.modal');\n\t\t\tthis.$redactorModal.find('input[type=text]').on('keypress', $.proxy(function(e)\n\t\t\t{\n\t\t\t\tif (e.which === 13)\n\t\t\t\t{\n\t\t\t\t\tthis.$redactorModal.find('.redactor_modal_action_btn').trigger('click');\n\t\t\t\t\te.preventDefault();\n\t\t\t\t}\n\t\t\t}, this));\n\n\t\t\treturn this.$redactorModal;\n\n\t\t},\n\t\tmodalShowOnDesktop: function()\n\t\t{\n\t\t\tthis.$redactorModal.css({\n\t\t\t\tposition: 'fixed',\n\t\t\t\ttop: '-2000px',\n\t\t\t\tleft: '50%',\n\t\t\t\twidth: this.$redactorModalWidth + 'px',\n\t\t\t\tmarginLeft: '-' + (this.$redactorModalWidth / 2) + 'px'\n\t\t\t}).show();\n\n\t\t\tthis.modalSaveBodyOveflow = $(document.body).css('overflow');\n\t\t\t$(document.body).css('overflow', 'hidden');\n\n\t\t\tsetTimeout($.proxy(function()\n\t\t\t{\n\t\t\t\tvar height = this.$redactorModal.outerHeight();\n\t\t\t\tthis.$redactorModal.css({\n\t\t\t\t\ttop: '50%',\n\t\t\t\t\theight: 'auto',\n\t\t\t\t\tminHeight: 'auto',\n\t\t\t\t\tmarginTop: '-' + (height + 10) / 2 + 'px'\n\t\t\t\t});\n\t\t\t}, this), 15);\n\t\t},\n\t\tmodalShowOnMobile: function()\n\t\t{\n\t\t\tthis.$redactorModal.css({\n\t\t\t\tposition: 'fixed',\n\t\t\t\twidth: '100%',\n\t\t\t\theight: '100%',\n\t\t\t\ttop: '0',\n\t\t\t\tleft: '0',\n\t\t\t\tmargin: '0',\n\t\t\t\tminHeight: '300px'\n\t\t\t}).show();\n\t\t},\n\t\tmodalSetContent: function(content)\n\t\t{\n\t\t\tthis.modalcontent = false;\n\t\t\tif (content.indexOf('#') == 0)\n\t\t\t{\n\t\t\t\tthis.modalcontent = $(content);\n\t\t\t\t$('#redactor_modal_inner').empty().append(this.modalcontent.html());\n\t\t\t\tthis.modalcontent.html('');\n\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$('#redactor_modal_inner').empty().append(content);\n\t\t\t}\n\t\t},\n\t\tmodalSetTitle: function(title)\n\t\t{\n\t\t\tthis.$redactorModal.find('#redactor_modal_header').html(title);\n\t\t},\n\t\tmodalSetButtonsWidth: function(){},\n\t\tmodalOnCloseButton: function()\n\t\t{\n\t\t\tthis.$redactorModal.find('.redactor_btn_modal_close').on('click', $.proxy(this.modalClose, this));\n\t\t},\n\t\tmodalSetOverlay: function()\n\t\t{\n\t\t\tif (this.opts.modalOverlay)\n\t\t\t{\n\t\t\t\tthis.$redactorModalOverlay = $('#redactor_modal_overlay');\n\t\t\t\tif (!this.$redactorModalOverlay.length)\n\t\t\t\t{\n\t\t\t\t\tthis.$redactorModalOverlay = $('<div id=\"redactor_modal_overlay\" style=\"display: none;\"></div>');\n\t\t\t\t\t$('body').prepend(this.$redactorModalOverlay);\n\t\t\t\t}\n\n\t\t\t\tthis.$redactorModalOverlay.show().on('click', $.proxy(this.modalClose, this));\n\t\t\t}\n\t\t},\n\t\tmodalSetDraggable: function()\n\t\t{\n\t\t\tif (typeof $.fn.draggable !== 'undefined')\n\t\t\t{\n\t\t\t\tthis.$redactorModal.draggable({ handle: '#redactor_modal_header' });\n\t\t\t\tthis.$redactorModal.find('#redactor_modal_header').css('cursor', 'move');\n\t\t\t}\n\t\t},\n\t\tmodalLoadTabs: function()\n\t\t{\n\t\t\tvar $redactor_tabs = $('#redactor_tabs');\n\t\t\tif (!$redactor_tabs.length) return false;\n\n\t\t\tvar that = this;\n\t\t\t$redactor_tabs.find('a').each(function(i, s)\n\t\t\t{\n\t\t\t\ti++;\n\t\t\t\t$(s).on('click', function(e)\n\t\t\t\t{\n\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t$redactor_tabs.find('a').removeClass('redactor_tabs_act');\n\t\t\t\t\t$(this).addClass('redactor_tabs_act');\n\t\t\t\t\t$('.redactor_tab').hide();\n\t\t\t\t\t$('#redactor_tab' + i ).show();\n\t\t\t\t\t$('#redactor_tab_selected').val(i);\n\n\t\t\t\t\tif (that.isMobile() === false)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar height = that.$redactorModal.outerHeight();\n\t\t\t\t\t\tthat.$redactorModal.css('margin-top', '-' + (height + 10) / 2 + 'px');\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\n\t\t},\n\t\tmodalCloseHandler: function(e)\n\t\t{\n\t\t\tif (e.keyCode === this.keyCode.ESC)\n\t\t\t{\n\t\t\t\tthis.modalClose();\n\t\t\t\treturn false;\n\t\t\t}\n\t\t},\n\t\tmodalClose: function()\n\t\t{\n\t\t\t$('#redactor_modal_close').off('click', this.modalClose);\n\t\t\t$('#redactor_modal').fadeOut('fast', $.proxy(function()\n\t\t\t{\n\t\t\t\tvar redactorModalInner = $('#redactor_modal_inner');\n\n\t\t\t\tif (this.modalcontent !== false)\n\t\t\t\t{\n\t\t\t\t\tthis.modalcontent.html(redactorModalInner.html());\n\t\t\t\t\tthis.modalcontent = false;\n\t\t\t\t}\n\n\t\t\t\tredactorModalInner.html('');\n\n\t\t\t\tif (this.opts.modalOverlay)\n\t\t\t\t{\n\t\t\t\t\t$('#redactor_modal_overlay').hide().off('click', this.modalClose);\n\t\t\t\t}\n\n\t\t\t\t$(document).off('keyup', this.modalCloseHandler);\n\t\t\t\tthis.$editor.off('keyup', this.modalCloseHandler);\n\n\t\t\t\tthis.selectionRestore();\n\t\t\t\tif (this.opts.autoresize && this.saveModalScroll)\n\t\t\t\t{\n\t\t\t\t\t$(this.document.body).scrollTop(this.saveModalScroll);\n\t\t\t\t}\n\t\t\t\telse if (this.opts.autoresize === false && this.saveModalScroll)\n\t\t\t\t{\n\t\t\t\t\tthis.$editor.scrollTop(this.saveModalScroll);\n\t\t\t\t}\n\n\t\t\t\tthis.callback('modalClosed');\n\n\t\t\t}, this));\n\t\t\tif (this.isMobile() === false)\n\t\t\t{\n\t\t\t\t$(document.body).css('overflow', this.modalSaveBodyOveflow ? this.modalSaveBodyOveflow : 'visible');\n\t\t\t}\n\n\t\t\treturn false;\n\t\t},\n\t\tmodalSetTab: function(num)\n\t\t{\n\t\t\t$('.redactor_tab').hide();\n\t\t\t$('#redactor_tabs').find('a').removeClass('redactor_tabs_act').eq(num - 1).addClass('redactor_tabs_act');\n\t\t\t$('#redactor_tab' + num).show();\n\t\t},\n\t\ts3handleFileSelect: function(e)\n\t\t{\n\t\t\tvar files = e.target.files;\n\n\t\t\tfor (var i = 0, f; f = files[i]; i++)\n\t\t\t{\n\t\t\t\tthis.s3uploadFile(f);\n\t\t\t}\n\t\t},\n\t\ts3uploadFile: function(file)\n\t\t{\n\t\t\tthis.s3executeOnSignedUrl(file, $.proxy(function(signedURL)\n\t\t\t{\n\t\t\t\tthis.s3uploadToS3(file, signedURL);\n\t\t\t}, this));\n\t\t},\n\t\ts3executeOnSignedUrl: function(file, callback)\n\t\t{\n\t\t\tvar xhr = new XMLHttpRequest();\n\n\t\t\tvar mark = '?';\n\t\t\tif (this.opts.s3.search(/\\?/) != '-1') mark = '&';\n\n\t\t\txhr.open('GET', this.opts.s3 + mark + 'name=' + file.name + '&type=' + file.type, true);\n\t\t\tif (xhr.overrideMimeType) xhr.overrideMimeType('text/plain; charset=x-user-defined');\n\n\t\t\tvar that = this;\n\t\t\txhr.onreadystatechange = function(e)\n\t\t\t{\n\t\t\t\tif (this.readyState == 4 && this.status == 200)\n\t\t\t\t{\n\t\t\t\t\tthat.showProgressBar();\n\t\t\t\t\tcallback(decodeURIComponent(this.responseText));\n\t\t\t\t}\n\t\t\t\telse if(this.readyState == 4 && this.status != 200)\n\t\t\t\t{\n\n\t\t\t\t}\n\t\t\t};\n\n\t\t\txhr.send();\n\t\t},\n\t\ts3createCORSRequest: function(method, url)\n\t\t{\n\t\t\tvar xhr = new XMLHttpRequest();\n\t\t\tif (\"withCredentials\" in xhr)\n\t\t\t{\n\t\t\t\txhr.open(method, url, true);\n\t\t\t}\n\t\t\telse if (typeof XDomainRequest != \"undefined\")\n\t\t\t{\n\t\t\t\txhr = new XDomainRequest();\n\t\t\t\txhr.open(method, url);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\txhr = null;\n\t\t\t}\n\n\t\t\treturn xhr;\n\t\t},\n\t\ts3uploadToS3: function(file, url)\n\t\t{\n\t\t\tvar xhr = this.s3createCORSRequest('PUT', url);\n\t\t\tif (!xhr)\n\t\t\t{\n\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\txhr.onload = $.proxy(function()\n\t\t\t\t{\n\t\t\t\t\tif (xhr.status == 200)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.hideProgressBar();\n\n\t\t\t\t\t\tvar s3image = url.split('?');\n\n\t\t\t\t\t\tif (!s3image[0])\n\t\t\t\t\t\t{\n\n\t\t\t\t\t\t\t return false;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.selectionRestore();\n\n\t\t\t\t\t\tvar html = '';\n\t\t\t\t\t\thtml = '<img id=\"image-marker\" src=\"' + s3image[0] + '\" />';\n\t\t\t\t\t\tif (this.opts.paragraphy) html = '<p>' + html + '</p>';\n\n\t\t\t\t\t\tthis.execCommand('inserthtml', html, false);\n\n\t\t\t\t\t\tvar image = $(this.$editor.find('img#image-marker'));\n\n\t\t\t\t\t\tif (image.length) image.removeAttr('id');\n\t\t\t\t\t\telse image = false;\n\n\t\t\t\t\t\tthis.sync();\n\t\t\t\t\t\tthis.callback('imageUpload', image, false);\n\n\t\t\t\t\t\tthis.modalClose();\n\t\t\t\t\t\tthis.observeImages();\n\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\n\t\t\t\t\t}\n\t\t\t\t}, this);\n\n\t\t\t\txhr.onerror = function()\n\t\t\t\t{\n\n\t\t\t\t};\n\n\t\t\t\txhr.upload.onprogress = function(e)\n\t\t\t\t{\n\t\t\t\t\t/*\n\t\t\t\t\tif (e.lengthComputable)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar percentLoaded = Math.round((e.loaded / e.total) * 100);\n\t\t\t\t\t\tsetProgress(percentLoaded, percentLoaded == 100 ? 'Finalizing.' : 'Uploading.');\n\t\t\t\t\t}\n\t\t\t\t\t*/\n\t\t\t\t};\n\n\t\t\t\txhr.setRequestHeader('Content-Type', file.type);\n\t\t\t\txhr.setRequestHeader('x-amz-acl', 'public-read');\n\n\t\t\t\txhr.send(file);\n\t\t\t}\n\t\t},\n\t\tuploadInit: function(el, options)\n\t\t{\n\t\t\tthis.uploadOptions = {\n\t\t\t\turl: false,\n\t\t\t\tsuccess: false,\n\t\t\t\terror: false,\n\t\t\t\tstart: false,\n\t\t\t\ttrigger: false,\n\t\t\t\tauto: false,\n\t\t\t\tinput: false\n\t\t\t};\n\n\t\t\t$.extend(this.uploadOptions, options);\n\n\t\t\tvar $el = $('#' + el);\n\t\t\tif ($el.length && $el[0].tagName === 'INPUT')\n\t\t\t{\n\t\t\t\tthis.uploadOptions.input = $el;\n\t\t\t\tthis.el = $($el[0].form);\n\t\t\t}\n\t\t\telse this.el = $el;\n\n\t\t\tthis.element_action = this.el.attr('action');\n\t\t\tif (this.uploadOptions.auto)\n\t\t\t{\n\t\t\t\t$(this.uploadOptions.input).change($.proxy(function(e)\n\t\t\t\t{\n\t\t\t\t\tthis.el.submit(function(e)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t});\n\n\t\t\t\t\tthis.uploadSubmit(e);\n\n\t\t\t\t}, this));\n\n\t\t\t}\n\t\t\telse if (this.uploadOptions.trigger)\n\t\t\t{\n\t\t\t\t$('#' + this.uploadOptions.trigger).on('click', $.proxy(this.uploadSubmit, this));\n\t\t\t}\n\t\t},\n\t\tuploadSubmit: function(e)\n\t\t{\n\t\t\tthis.showProgressBar();\n\t\t\tthis.uploadForm(this.element, this.uploadFrame());\n\t\t},\n\t\tuploadFrame: function()\n\t\t{\n\t\t\tthis.id = 'f' + Math.floor(Math.random() * 99999);\n\n\t\t\tvar d = this.document.createElement('div');\n\t\t\tvar iframe = '<iframe style=\"display:none\" id=\"' + this.id + '\" name=\"' + this.id + '\"></iframe>';\n\n\t\t\td.innerHTML = iframe;\n\t\t\t$(d).appendTo(\"body\");\n\t\t\tif (this.uploadOptions.start) this.uploadOptions.start();\n\n\t\t\t$( '#' + this.id ).one('load', $.proxy(this.uploadLoaded, this));\n\n\t\t\treturn this.id;\n\t\t},\n\t\tuploadForm: function(f, name)\n\t\t{\n\t\t\tif (this.uploadOptions.input)\n\t\t\t{\n\t\t\t\tvar formId = 'redactorUploadForm' + this.id,\n\t\t\t\t\tfileId = 'redactorUploadFile' + this.id;\n\n\t\t\t\tthis.form = $('<form  action=\"' + this.uploadOptions.url + '\" method=\"POST\" target=\"' + name + '\" name=\"' + formId + '\" id=\"' + formId + '\" enctype=\"multipart/form-data\" />');\n\t\t\t\tif (this.opts.uploadFields !== false && typeof this.opts.uploadFields === 'object')\n\t\t\t\t{\n\t\t\t\t\t$.each(this.opts.uploadFields, $.proxy(function(k, v)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (v != null && v.toString().indexOf('#') === 0) v = $(v).val();\n\n\t\t\t\t\t\tvar hidden = $('<input/>', {\n\t\t\t\t\t\t\t'type': \"hidden\",\n\t\t\t\t\t\t\t'name': k,\n\t\t\t\t\t\t\t'value': v\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\t$(this.form).append(hidden);\n\n\t\t\t\t\t}, this));\n\t\t\t\t}\n\n\t\t\t\tvar oldElement = this.uploadOptions.input;\n\t\t\t\tvar newElement = $(oldElement).clone();\n\n\t\t\t\t$(oldElement).attr('id', fileId).before(newElement).appendTo(this.form);\n\n\t\t\t\t$(this.form).css('position', 'absolute')\n\t\t\t\t\t\t.css('top', '-2000px')\n\t\t\t\t\t\t.css('left', '-2000px')\n\t\t\t\t\t\t.appendTo('body');\n\n\t\t\t\tthis.form.submit();\n\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tf.attr('target', name)\n\t\t\t\t\t.attr('method', 'POST')\n\t\t\t\t\t.attr('enctype', 'multipart/form-data')\n\t\t\t\t\t.attr('action', this.uploadOptions.url);\n\n\t\t\t\tthis.element.submit();\n\t\t\t}\n\t\t},\n\t\tuploadLoaded: function()\n\t\t{\n\t\t\tvar i = $( '#' + this.id)[0], d;\n\n\t\t\tif (i.contentDocument) d = i.contentDocument;\n\t\t\telse if (i.contentWindow) d = i.contentWindow.document;\n\t\t\telse d = window.frames[this.id].document;\n\t\t\tif (this.uploadOptions.success)\n\t\t\t{\n\t\t\t\tthis.hideProgressBar();\n\n\t\t\t\tif (typeof d !== 'undefined')\n\t\t\t\t{\n\n\t\t\t\t\tvar rawString = d.body.innerHTML;\n\t\t\t\t\tvar jsonString = rawString.match(/\\{(.|\\n)*\\}/)[0];\n\n\t\t\t\t\tjsonString = jsonString.replace(/^\\[/, '');\n\t\t\t\t\tjsonString = jsonString.replace(/\\]$/, '');\n\n\t\t\t\t\tvar json = $.parseJSON(jsonString);\n\n\t\t\t\t\tif (typeof json.error == 'undefined') { this.uploadOptions.success(json); }\n\t\t\t\t\telse\n\t\t\t\t\t{\n                        console.log(json);\n\t\t\t\t\t\tthis.uploadOptions.error(this, json);\n\t\t\t\t\t\tthis.modalClose();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.modalClose();\n\t\t\t\t\talert('Upload failed!');\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.el.attr('action', this.element_action);\n\t\t\tthis.el.attr('target', '');\n\t\t},\n\t\tdraguploadInit: function (el, options)\n\t\t{\n\t\t\tthis.draguploadOptions = $.extend({\n\t\t\t\turl: false,\n\t\t\t\tsuccess: false,\n\t\t\t\terror: false,\n\t\t\t\tpreview: false,\n\t\t\t\tuploadFields: false,\n\t\t\t\ttext: this.opts.curLang.drop_file_here,\n\t\t\t\tatext: this.opts.curLang.or_choose,\n\t\t\t\tuploadParam: false\n\t\t\t}, options);\n\n\t\t\tif (window.FormData === undefined) return false;\n\n\t\t\tthis.droparea = $('<div class=\"redactor_droparea\"></div>');\n\t\t\tthis.dropareabox = $('<div class=\"redactor_dropareabox\">' + this.draguploadOptions.text + '</div>');\n\t\t\tthis.dropalternative = $('<div class=\"redactor_dropalternative\">' + this.draguploadOptions.atext + '</div>');\n\n\t\t\tthis.droparea.append(this.dropareabox);\n\n\t\t\t$(el).before(this.droparea);\n\t\t\t$(el).before(this.dropalternative);\n\t\t\tthis.dropareabox.on('dragover', $.proxy(function()\n\t\t\t{\n\t\t\t\treturn this.draguploadOndrag();\n\n\t\t\t}, this));\n\t\t\tthis.dropareabox.on('dragleave', $.proxy(function()\n\t\t\t{\n\t\t\t\treturn this.draguploadOndragleave();\n\n\t\t\t}, this));\n\t\t\tthis.dropareabox.get(0).ondrop = $.proxy(function(e)\n\t\t\t{\n\t\t\t\te.preventDefault();\n\n\t\t\t\tthis.dropareabox.removeClass('hover').addClass('drop');\n\t\t\t\tthis.showProgressBar();\n                                for(var nmb in e.dataTransfer.files){\n                                    if(!e.dataTransfer.files.hasOwnProperty(nmb))continue;\n                                    this.dragUploadAjax(this.draguploadOptions.url, e.dataTransfer.files[nmb], false, e, this.draguploadOptions.uploadParam);\n                                }\n\n\t\t\t}, this );\n\t\t},\n\t\tdragUploadAjax: function(url, file, directupload, e, uploadParam)\n\t\t{\n\t\t\tif (!directupload)\n\t\t\t{\n\t\t\t\tvar xhr = $.ajaxSettings.xhr();\n\t\t\t\tif (xhr.upload)\n\t\t\t\t{\n\t\t\t\t\txhr.upload.addEventListener('progress', $.proxy(this.uploadProgress, this), false);\n\t\t\t\t}\n\n\t\t\t\t$.ajaxSetup({\n\t\t\t\t  xhr: function () { return xhr; }\n\t\t\t\t});\n\t\t\t}\n\t\t\tthis.callback('drop', e);\n\n\t\t\tvar fd = new FormData();\n\t\t\tif (uploadParam !== false)\n\t\t\t{\n\t\t\t\tfd.append(uploadParam, file);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tfd.append('file', file);\n\t\t\t}\n\t\t\tif (this.opts.uploadFields !== false && typeof this.opts.uploadFields === 'object')\n\t\t\t{\n\t\t\t\t$.each(this.opts.uploadFields, $.proxy(function(k, v)\n\t\t\t\t{\n\t\t\t\t\tif (v != null && v.toString().indexOf('#') === 0) v = $(v).val();\n\t\t\t\t\tfd.append(k, v);\n\n\t\t\t\t}, this));\n\t\t\t}\n\n\t\t\t$.ajax({\n\t\t\t\turl: url,\n\t\t\t\tdataType: 'html',\n                                async: false,\n\t\t\t\tdata: fd,\n\t\t\t\tcache: false,\n\t\t\t\tcontentType: false,\n\t\t\t\tprocessData: false,\n\t\t\t\ttype: 'POST',\n\t\t\t\tsuccess: $.proxy(function(data)\n\t\t\t\t{\n\t\t\t\t\tdata = data.replace(/^\\[/, '');\n\t\t\t\t\tdata = data.replace(/\\]$/, '');\n\n\t\t\t\t\tvar json = (typeof data === 'string' ? $.parseJSON(data) : data);\n\n\t\t\t\t\tthis.hideProgressBar();\n\n\t\t\t\t\tif (directupload)\n\t\t\t\t\t{\n\t\t\t\t\t    var $img = $('<img>');\n\t\t\t\t\t\t$img.attr('src', json.image.url).attr('id', 'drag-image-marker');\n\n\t\t\t\t\t\tthis.insertNodeToCaretPositionFromPoint(e, $img[0]);\n\n\t\t\t\t\t\tvar image = $(this.$editor.find('img#drag-image-marker'));\n\t\t\t\t\t\tif (image.length) image.removeAttr('id');\n\t\t\t\t\t\telse image = false;\n\n\t\t\t\t\t\tthis.sync();\n\t\t\t\t\t\tthis.observeImages();\n\t\t\t\t\t\tif (image) this.callback('imageUpload', image, json);\n\t\t\t\t\t\tif (typeof json.error !== 'undefined') this.callback('imageUploadError', json);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tif (typeof json.error == 'undefined')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.draguploadOptions.success(json);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.draguploadOptions.error(this, json);\n\t\t\t\t\t\t\tthis.draguploadOptions.success(false);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t}, this)\n\t\t\t});\n\t\t},\n\t\tdraguploadOndrag: function()\n\t\t{\n\t\t\tthis.dropareabox.addClass('hover');\n\t\t\treturn false;\n\t\t},\n\t\tdraguploadOndragleave: function()\n\t\t{\n\t\t\tthis.dropareabox.removeClass('hover');\n\t\t\treturn false;\n\t\t},\n\t\tuploadProgress: function(e, text)\n\t\t{\n\t\t\tvar percent = e.loaded ? parseInt(e.loaded / e.total * 100, 10) : e;\n\t\t\tthis.dropareabox.text('Loading ' + percent + '% ' + (text || ''));\n\t\t},\n\t\tisMobile: function()\n\t\t{\n\t\t\treturn /(iPhone|iPod|BlackBerry|Android)/.test(navigator.userAgent);\n\t\t},\n\t\tisIPad: function()\n\t\t{\n\t\t\treturn /iPad/.test(navigator.userAgent);\n\t\t},\n\t\tnormalize: function(str)\n\t\t{\n\t\t\tif (typeof(str) === 'undefined') return 0;\n\t\t\treturn parseInt(str.replace('px',''), 10);\n\t\t},\n\t\touterHtml: function(el)\n\t\t{\n\t\t\treturn $('<div>').append($(el).eq(0).clone()).html();\n\t\t},\n\t\tstripHtml: function(html)\n\t\t{\n\t\t\tvar tmp = document.createElement(\"DIV\");\n\t\t\ttmp.innerHTML = html;\n\t\t\treturn tmp.textContent || tmp.innerText || \"\";\n\t\t},\n\t\tisString: function(obj)\n\t\t{\n\t\t\treturn Object.prototype.toString.call(obj) == '[object String]';\n\t\t},\n\t\tisEmpty: function(html)\n\t\t{\n\t\t\thtml = html.replace(/&#x200b;|<br>|<br\\/>|&nbsp;/gi, '');\n\t\t\thtml = html.replace(/\\s/g, '');\n\t\t\thtml = html.replace(/^<p>[^\\W\\w\\D\\d]*?<\\/p>$/i, '');\n\n\t\t\treturn html == '';\n\t\t},\n\t\tgetInternetExplorerVersion: function()\n\t\t{\n\t\t\tvar rv = false;\n\t\t\tif (navigator.appName == 'Microsoft Internet Explorer')\n\t\t\t{\n\t\t\t\tvar ua = navigator.userAgent;\n\t\t\t\tvar re  = new RegExp(\"MSIE ([0-9]{1,}[\\.0-9]{0,})\");\n\t\t\t\tif (re.exec(ua) != null)\n\t\t\t\t{\n\t\t\t\t\trv = parseFloat(RegExp.$1);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn rv;\n\t\t},\n\t\tisIe11: function()\n\t\t{\n\t\t\treturn !!navigator.userAgent.match(/Trident\\/7\\./);\n\t\t},\n\t\tbrowser: function(browser)\n\t\t{\n\t\t\tvar ua = navigator.userAgent.toLowerCase();\n\t\t\tvar match = /(opr)[\\/]([\\w.]+)/.exec( ua ) ||\n            /(chrome)[ \\/]([\\w.]+)/.exec( ua ) ||\n            /(webkit)[ \\/]([\\w.]+).*(safari)[ \\/]([\\w.]+)/.exec(ua) ||\n            /(webkit)[ \\/]([\\w.]+)/.exec( ua ) ||\n            /(opera)(?:.*version|)[ \\/]([\\w.]+)/.exec( ua ) ||\n            /(msie) ([\\w.]+)/.exec( ua ) ||\n            ua.indexOf(\"trident\") >= 0 && /(rv)(?::| )([\\w.]+)/.exec( ua ) ||\n            ua.indexOf(\"compatible\") < 0 && /(mozilla)(?:.*? rv:([\\w.]+)|)/.exec( ua ) ||\n            [];\n\n\t\t\tif (browser == 'version') return match[2];\n\t\t\tif (browser == 'webkit') return (match[1] == 'chrome' || match[1] == 'webkit');\n\t\t\tif (match[1] == 'rv') return browser == 'msie';\n\t\t\tif (match[1] == 'opr') return browser == 'webkit';\n\n\t\t\treturn browser == match[1];\n\n\t\t},\n\t\toldIE: function()\n\t\t{\n\t\t\tif (this.browser('msie') && parseInt(this.browser('version'), 10) < 9) return true;\n\t\t\treturn false;\n\t\t},\n\t\tgetFragmentHtml: function (fragment)\n\t\t{\n\t\t\tvar cloned = fragment.cloneNode(true);\n\t\t\tvar div = this.document.createElement('div');\n\n\t\t\tdiv.appendChild(cloned);\n\t\t\treturn div.innerHTML;\n\t\t},\n\t\textractContent: function()\n\t\t{\n\t\t\tvar node = this.$editor[0];\n\t\t\tvar frag = this.document.createDocumentFragment();\n\t\t\tvar child;\n\n\t\t\twhile ((child = node.firstChild))\n\t\t\t{\n\t\t\t\tfrag.appendChild(child);\n\t\t\t}\n\n\t\t\treturn frag;\n\t\t},\n\t\tisParentRedactor: function(el)\n\t\t{\n\t\t\tif (!el) return false;\n\t\t\tif (this.opts.iframe) return el;\n\n\t\t\tif ($(el).parents('div.redactor_editor').length == 0 || $(el).hasClass('redactor_editor')) return false;\n\t\t\telse return el;\n\t\t},\n\t\tcurrentOrParentIs: function(tagName)\n\t\t{\n\t\t\tvar parent = this.getParent(), current = this.getCurrent();\n\t\t\treturn parent && parent.tagName === tagName ? parent : current && current.tagName === tagName ? current : false;\n\t\t},\n\t\tisEndOfElement: function()\n\t\t{\n\t\t\tvar current = this.getBlock();\n\t\t\tvar offset = this.getCaretOffset(current);\n\n\t\t\tvar text = $.trim($(current).text()).replace(/\\n\\r\\n/g, '');\n\n\t\t\tvar len = text.length;\n\n\t\t\tif (offset == len) return true;\n\t\t\telse return false;\n\t\t},\n\t\tisFocused: function()\n\t\t{\n\t\t\tvar el, sel = this.getSelection();\n\n\t\t\tif (sel && sel.rangeCount && sel.rangeCount > 0) el = sel.getRangeAt(0).startContainer;\n\t\t\tif (!el) return false;\n\t\t\tif (this.opts.iframe)\n\t\t\t{\n\t\t\t\tif (this.getCaretOffsetRange().equals()) return !this.$editor.is(el);\n\t\t\t\telse return true;\n\t\t\t}\n\n\t\t\treturn $(el).closest('div.redactor_editor').length != 0;\n\t\t},\n\t\tremoveEmptyAttr: function (el, attr)\n\t\t{\n\t\t\tif ($(el).attr(attr) == '') $(el).removeAttr(attr);\n\t\t},\n\t\tremoveFromArrayByValue: function(array, value)\n\t\t{\n\t\t\tvar index = null;\n\n\t\t\twhile ((index = array.indexOf(value)) !== -1)\n\t\t\t{\n\t\t\t\tarray.splice(index, 1);\n\t\t\t}\n\n\t\t\treturn array;\n\t\t}\n\n\t};\n\tRedactor.prototype.init.prototype = Redactor.prototype;\n\t$.Redactor.fn.formatLinkify = function(protocol, convertLinks, convertImageLinks, convertVideoLinks, linkSize)\n\t{\n\t\tvar url = /(((https?|ftps?):\\/\\/)|www[.][^\\s])(.+?\\..+?)([.),]?)(\\s|\\.\\s+|\\)|$)/gi,\n\t\t\trProtocol = /(https?|ftp):\\/\\//i,\n\t\t\turlImage = /(https?:\\/\\/.*\\.(?:png|jpg|jpeg|gif))/gi;\n\n\t\tvar childNodes = (this.$editor ? this.$editor.get(0) : this).childNodes, i = childNodes.length;\n\t\twhile (i--)\n\t\t{\n\t\t\tvar n = childNodes[i];\n\t\t\tif (n.nodeType === 3)\n\t\t\t{\n\t\t\t\tvar html = n.nodeValue;\n\t\t\t\tif (convertVideoLinks && html)\n\t\t\t\t{\n\t\t\t\t\tvar iframeStart = '<iframe width=\"500\" height=\"281\" src=\"',\n\t\t\t\t\t\tiframeEnd = '\" frameborder=\"0\" allowfullscreen></iframe>';\n\n\t\t\t\t\tif (html.match(reUrlYoutube))\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(reUrlYoutube, iframeStart + '//www.youtube.com/embed/$1' + iframeEnd);\n\t\t\t\t\t\t$(n).after(html).remove();\n\t\t\t\t\t}\n\t\t\t\t\telse if (html.match(reUrlVimeo))\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(reUrlVimeo, iframeStart + '//player.vimeo.com/video/$2' + iframeEnd);\n\t\t\t\t\t\t$(n).after(html).remove();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (convertImageLinks && html && html.match(urlImage))\n\t\t\t\t{\n\t\t\t\t\thtml = html.replace(urlImage, '<img src=\"$1\">');\n\n\t\t\t\t\t$(n).after(html).remove();\n\t\t\t\t}\n\t\t\t\tif (convertLinks && html && html.match(url))\n\t\t\t\t{\n\t\t\t\t\tvar matches = html.match(url);\n\n\t\t\t\t\tfor (var i in matches)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar href = matches[i];\n\t\t\t\t\t\tvar text = href;\n\n\t\t\t\t\t\tvar space = '';\n\t\t\t\t\t\tif (href.match(/\\s$/) !== null) space = ' ';\n\n\t\t\t\t\t\tvar addProtocol = protocol;\n\t\t\t\t\t\tif (href.match(rProtocol) !== null) addProtocol = '';\n\n\t\t\t\t\t\tif (text.length > linkSize) text = text.substring(0, linkSize) + '...';\n\n\t\t\t\t\t\ttext = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')\n\n\t\t\t\t\t\t/*\n\t\t\t\t\t\t\tTo handle URLs which may have $ characters in them, need to escape $ -> $$ to prevent $1 from getting treated as a backreference.\n\t\t\t\t\t\t\tSee http://gotofritz.net/blog/code-snippets/escaping-in-replace-strings-in-javascript/\n\t\t\t\t\t\t*/\n\t\t\t\t\t\tvar escapedBackReferences = text.replace('$', '$$$');\n\n\t\t\t\t\t\thtml = html.replace(href, '<a href=\\\"' + addProtocol + $.trim(href) + '\\\">' + $.trim(escapedBackReferences) + '</a>' + space);\n\t\t\t\t\t}\n\n\t\t\t\t\t$(n).after(html).remove();\n\t\t\t\t}\n\t\t\t}\n\t\t\telse if (n.nodeType === 1 && !/^(a|button|textarea)$/i.test(n.tagName))\n\t\t\t{\n\t\t\t\t$.Redactor.fn.formatLinkify.call(n, protocol, convertLinks, convertImageLinks, convertVideoLinks, linkSize);\n\t\t\t}\n\t\t}\n\t};\n\n})(jQuery);", "!function($){var uuid=0;\"use strict\";var Range=function(t){return this[0]=t.startOffset,this[1]=t.endOffset,this.range=t,this};Range.prototype.equals=function(){return this[0]===this[1]};var reUrlYoutube=/https?:\\/\\/(?:[0-9A-Z-]+\\.)?(?:youtu\\.be\\/|youtube\\.com\\S*[^\\w\\-\\s])([\\w\\-]{11})(?=[^\\w\\-]|$)(?![?=&+%\\w.-]*(?:['\"][^<>]*>|<\\/a>))[?=&+%\\w.-]*/ig,reUrlVimeo=/https?:\\/\\/(www\\.)?vimeo.com\\/(\\d+)($|\\/)/,reUrlFacebook=/^(?:(?:https|http)?:\\/\\/)?(?:www\\.)?(?:facebook\\.com(?:\\/[^\\/]+\\/videos\\/|\\/video\\.php\\?v=))([0-9]+)(?:.+)?$/,reUrlRutube=/^(?:(?:https|http)?:\\/\\/)?(?:www\\.)?(?:rutube\\.ru\\/video\\/)([a-z0-9]+)(?:.+)?$/;function Redactor(t,e){return new Redactor.prototype.init(t,e)}$.fn.redactor=function(t){var e=[],s=Array.prototype.slice.call(arguments,1);return(\"string\"==typeof t?this.each(function(){var o=$.data(this,\"redactor\");if(!(void 0!==o&&$.isFunction(o[t])))return $.error('No such method \"'+t+'\" for Redactor');var r=o[t].apply(o,s);void 0!==r&&r!==o&&e.push(r)}):this.each(function(){$.data(this,\"redactor\")||$.data(this,\"redactor\",Redactor(this,t))}),0===e.length)?this:1===e.length?e[0]:e},$.Redactor=Redactor,$.Redactor.VERSION=\"9.2.6\",$.Redactor.opts={rangy:!1,iframe:!1,fullpage:!1,css:!1,lang:\"en\",direction:\"ltr\",placeholder:!1,typewriter:!1,wym:!1,mobile:!0,cleanup:!0,tidyHtml:!0,pastePlainText:!1,removeEmptyTags:!0,cleanSpaces:!0,cleanFontTag:!0,templateVars:!1,xhtml:!1,visual:!0,focus:!1,tabindex:!1,autoresize:!0,minHeight:!1,maxHeight:!1,shortcuts:{\"ctrl+m, meta+m\":\"this.execCommand('removeFormat', false)\",\"ctrl+b, meta+b\":\"this.execCommand('bold', false)\",\"ctrl+i, meta+i\":\"this.execCommand('italic', false)\",\"ctrl+h, meta+h\":\"this.execCommand('superscript', false)\",\"ctrl+l, meta+l\":\"this.execCommand('subscript', false)\",\"ctrl+k, meta+k\":\"this.linkShow()\",\"ctrl+shift+7\":\"this.execCommand('insertorderedlist', false)\",\"ctrl+shift+8\":\"this.execCommand('insertunorderedlist', false)\"},shortcutsAdd:!1,autosave:!1,autosaveInterval:60,plugins:!1,linkProtocol:\"http://\",linkNofollow:!1,linkSize:50,predefinedLinks:!1,imageFloatMargin:\"10px\",imageGetJson:!1,dragUpload:!0,imageTabLink:!0,imageUpload:!1,imageUploadParam:\"file\",imageResizable:!0,fileUpload:!1,fileUploadParam:\"file\",clipboardUpload:!0,clipboardUploadUrl:!1,smilesUrl:\"\",dnbImageTypes:[\"image/png\",\"image/jpeg\",\"image/gif\"],s3:!1,uploadFields:!1,observeImages:!0,observeLinks:!0,modalOverlay:!0,tabSpaces:!1,tabFocus:!0,air:!1,airButtons:[\"formatting\",\"bold\",\"italic\",\"deleted\",\"unorderedlist\",\"orderedlist\",\"outdent\",\"indent\"],toolbar:!0,toolbarFixed:!1,toolbarFixedTarget:document,toolbarFixedTopOffset:0,toolbarFixedBox:!1,toolbarExternal:!1,toolbarOverflow:!1,buttonSource:!0,buttons:[\"html\",\"undo\",\"redo\",\"formatting\",\"bold\",\"italic\",\"deleted\",\"unorderedlist\",\"orderedlist\",\"outdent\",\"indent\",\"image\",\"video\",\"file\",\"table\",\"link\",\"alignment\",\"|\",\"horizontalrule\"],buttonsHideOnMobile:[],activeButtons:[\"deleted\",\"italic\",\"bold\",\"underline\",\"unorderedlist\",\"orderedlist\",\"alignleft\",\"aligncenter\",\"alignright\",\"justify\",\"table\"],activeButtonsStates:{b:\"bold\",strong:\"bold\",i:\"italic\",em:\"italic\",del:\"deleted\",strike:\"deleted\",ul:\"unorderedlist\",ol:\"orderedlist\",u:\"underline\",tr:\"table\",td:\"table\",table:\"table\"},formattingTags:[\"p\",\"blockquote\",\"code\",\"h2\",\"h3\",\"h4\",\"h5\",\"h6\"],linebreaks:!1,paragraphy:!0,convertDivs:!0,convertLinks:!0,convertImageLinks:!1,convertVideoLinks:!1,formattingPre:!1,phpTags:!1,allowedTags:!1,deniedTags:[\"html\",\"head\",\"link\",\"body\",\"meta\",\"script\",\"style\",\"applet\"],boldTag:\"strong\",italicTag:\"em\",indentValue:20,buffer:[],rebuffer:[],textareamode:!1,emptyHtml:\"<p>&#x200b;</p>\",invisibleSpace:\"&#x200b;\",rBlockTest:/^(P|H[1-6]|LI|ADDRESS|SECTION|HEADER|FOOTER|ASIDE|ARTICLE)$/i,alignmentTags:[\"P\",\"H1\",\"H2\",\"H3\",\"H4\",\"H5\",\"H6\",\"DD\",\"DL\",\"DT\",\"DIV\",\"TD\",\"BLOCKQUOTE\",\"OUTPUT\",\"FIGCAPTION\",\"ADDRESS\",\"SECTION\",\"HEADER\",\"FOOTER\",\"ASIDE\",\"ARTICLE\"],ownLine:[\"area\",\"body\",\"head\",\"hr\",\"i?frame\",\"link\",\"meta\",\"noscript\",\"style\",\"script\",\"table\",\"tbody\",\"thead\",\"tfoot\"],contOwnLine:[\"li\",\"dt\",\"dt\",\"h[1-6]\",\"option\",\"script\"],newLevel:[\"blockquote\",\"div\",\"dl\",\"fieldset\",\"form\",\"frameset\",\"map\",\"ol\",\"p\",\"code\",\"select\",\"td\",\"th\",\"tr\",\"ul\"],blockLevelElements:[\"P\",\"H1\",\"H2\",\"H3\",\"H4\",\"H5\",\"H6\",\"DD\",\"DL\",\"DT\",\"DIV\",\"LI\",\"BLOCKQUOTE\",\"OUTPUT\",\"FIGCAPTION\",\"CODE\",\"ADDRESS\",\"SECTION\",\"HEADER\",\"FOOTER\",\"ASIDE\",\"ARTICLE\",\"TD\"],langs:{en:{html:\"HTML\",video:\"Insert Video\",image:\"Insert Image\",table:\"Table\",link:\"Link\",link_insert:\"Insert link\",link_edit:\"Edit link\",unlink:\"Unlink\",formatting:\"Formatting\",paragraph:\"Normal text\",quote:\"Quote\",code:\"Code\",header1:\"Header 1\",header2:\"Header 2\",header3:\"Header 3\",header4:\"Header 4\",header5:\"Header 5\",bold:\"Bold\",italic:\"Italic\",fontcolor:\"Font Color\",backcolor:\"Back Color\",unorderedlist:\"Unordered List\",orderedlist:\"Ordered List\",outdent:\"Outdent\",indent:\"Indent\",cancel:\"Cancel\",insert:\"Insert\",save:\"Save\",_delete:\"Delete\",insert_table:\"Insert Table\",insert_row_above:\"Add Row Above\",insert_row_below:\"Add Row Below\",insert_column_left:\"Add Column Left\",insert_column_right:\"Add Column Right\",delete_column:\"Delete Column\",delete_row:\"Delete Row\",delete_table:\"Delete Table\",rows:\"Rows\",columns:\"Columns\",add_head:\"Add Head\",delete_head:\"Delete Head\",title:\"Title\",image_position:\"Position\",none:\"None\",left:\"Left\",right:\"Right\",center:\"Center\",image_web_link:\"Image Web Link\",text:\"Text\",mailto:\"Email\",web:\"URL\",video_html_code:\"Video Embed Code\",file:\"Insert File\",upload:\"Upload\",download:\"Download\",choose:\"Choose\",empty_img_list:\"You have no images\",or_choose:\"Or choose\",drop_file_here:\"Drop file here\",align_left:\"Align text to the left\",align_center:\"Center text\",align_right:\"Align text to the right\",align_justify:\"Justify text\",horizontalrule:\"Insert Horizontal Rule\",fullscreen:\"Full screen\",fontsize:\"Font size\",fontfamily:\"Font\",remove_font:\"Clear Font\",image_save_toserver:\"Save to the server?\",deleted:\"Deleted\",anchor:\"Anchor\",link_new_tab:\"Open link in new tab\",underline:\"Underline\",alignment:\"Alignment\",filename:\"Name (optional)\",edit:\"Edit\",spoiler:\"Spoiler\",spoiler_name:\"Spoiler name\",spoiler_text:\"Spoiler text\",smiles:\"Smiles\",undo:\"Undo\",redo:\"Redo\",formalize:\"Formalize\"}}},Redactor.fn=$.Redactor.prototype={keyCode:{BACKSPACE:8,DELETE:46,DOWN:40,ENTER:13,ESC:27,TAB:9,CTRL:17,META:91,LEFT:37,LEFT_WIN:91},init:function(t,e){this.rtePaste=!1,this.$element=this.$source=$(t),this.uuid=uuid++;var s=$.extend(!0,{},$.Redactor.opts);if(this.opts=$.extend({},s,this.$element.data(),e),this.start=!0,this.dropdowns=[],this.sourceHeight=this.$source.css(\"height\"),this.sourceWidth=this.$source.css(\"width\"),this.opts.fullpage&&(this.opts.iframe=!0),this.opts.linebreaks&&(this.opts.paragraphy=!1),this.opts.paragraphy&&(this.opts.linebreaks=!1),this.opts.toolbarFixedBox&&(this.opts.toolbarFixed=!0),this.document=document,this.window=window,this.savedSel=!1,this.cleanlineBefore=RegExp(\"^<(/?\"+this.opts.ownLine.join(\"|/?\")+\"|\"+this.opts.contOwnLine.join(\"|\")+\")[ >]\"),this.cleanlineAfter=RegExp(\"^<(br|/?\"+this.opts.ownLine.join(\"|/?\")+\"|/\"+this.opts.contOwnLine.join(\"|/\")+\")[ >]\"),this.cleannewLevel=RegExp(\"^</?(\"+this.opts.newLevel.join(\"|\")+\")[ >]\"),this.rTestBlock=RegExp(\"^(\"+this.opts.blockLevelElements.join(\"|\")+\")$\",\"i\"),!1===this.opts.linebreaks){if(!1!==this.opts.allowedTags){var o=[\"strong\",\"em\",\"del\"],r=[\"b\",\"i\",\"strike\"];for(i in\"-1\"===$.inArray(\"p\",this.opts.allowedTags)&&this.opts.allowedTags.push(\"p\"),o)\"-1\"!=$.inArray(o[i],this.opts.allowedTags)&&this.opts.allowedTags.push(r[i])}if(!1!==this.opts.deniedTags){var a=$.inArray(\"p\",this.opts.deniedTags);\"-1\"!==a&&this.opts.deniedTags.splice(a,a)}}(this.browser(\"msie\")||this.browser(\"opera\"))&&(this.opts.buttons=this.removeFromArrayByValue(this.opts.buttons,\"horizontalrule\")),this.opts.curLang=this.opts.langs[this.opts.lang],$.extend(this.opts.shortcuts,this.opts.shortcutsAdd),this.placeholderInit(),this.buildStart()},toolbarInit:function(t){return{html:{title:t.html,func:\"toggle\"},undo:{title:t.undo,func:\"bufferUndo\"},redo:{title:t.redo,func:\"bufferRedo\"},formatting:{title:t.formatting,func:\"show\",dropdown:{p:{title:t.paragraph,func:\"formatBlocks\"},blockquote:{title:t.quote,func:\"formatQuote\",className:\"redactor_format_blockquote\"},code:{title:t.code,func:\"formatBlocks\",className:\"redactor_format_code\"},h1:{title:t.header1,func:\"formatBlocks\",className:\"redactor_format_h1\"},h2:{title:t.header2,func:\"formatBlocks\",className:\"redactor_format_h2\"},h3:{title:t.header3,func:\"formatBlocks\",className:\"redactor_format_h3\"},h4:{title:t.header4,func:\"formatBlocks\",className:\"redactor_format_h4\"},h5:{title:t.header5,func:\"formatBlocks\",className:\"redactor_format_h5\"}}},bold:{title:t.bold,exec:\"bold\"},italic:{title:t.italic,exec:\"italic\"},deleted:{title:t.deleted,exec:\"strikethrough\"},underline:{title:t.underline,exec:\"underline\"},unorderedlist:{title:\"&bull; \"+t.unorderedlist,exec:\"insertunorderedlist\"},orderedlist:{title:\"1. \"+t.orderedlist,exec:\"insertorderedlist\"},outdent:{title:\"< \"+t.outdent,func:\"indentingOutdent\"},indent:{title:\"> \"+t.indent,func:\"indentingIndent\"},image:{title:t.image,func:\"imageShow\"},video:{title:t.video,func:\"videoShow\"},file:{title:t.file,func:\"fileShow\"},table:{title:t.table,func:\"show\",dropdown:{insert_table:{title:t.insert_table,func:\"tableShow\"},separator_drop1:{name:\"separator\"},insert_row_above:{title:t.insert_row_above,func:\"tableAddRowAbove\"},insert_row_below:{title:t.insert_row_below,func:\"tableAddRowBelow\"},insert_column_left:{title:t.insert_column_left,func:\"tableAddColumnLeft\"},insert_column_right:{title:t.insert_column_right,func:\"tableAddColumnRight\"},separator_drop2:{name:\"separator\"},add_head:{title:t.add_head,func:\"tableAddHead\"},delete_head:{title:t.delete_head,func:\"tableDeleteHead\"},separator_drop3:{name:\"separator\"},delete_column:{title:t.delete_column,func:\"tableDeleteColumn\"},delete_row:{title:t.delete_row,func:\"tableDeleteRow\"},delete_table:{title:t.delete_table,func:\"tableDeleteTable\"}}},link:{title:t.link,func:\"show\",dropdown:{link:{title:t.link_insert,func:\"linkShow\"},unlink:{title:t.unlink,exec:\"unlink\"}}},alignment:{title:t.alignment,func:\"show\",dropdown:{alignleft:{title:t.align_left,func:\"alignmentLeft\"},aligncenter:{title:t.align_center,func:\"alignmentCenter\"},alignright:{title:t.align_right,func:\"alignmentRight\"},justify:{title:t.align_justify,func:\"alignmentJustify\"}}},alignleft:{title:t.align_left,func:\"alignmentLeft\"},aligncenter:{title:t.align_center,func:\"alignmentCenter\"},alignright:{title:t.align_right,func:\"alignmentRight\"},alignjustify:{title:t.align_justify,func:\"alignmentJustify\"},horizontalrule:{exec:\"inserthorizontalrule\",title:t.horizontalrule}}},callback:function(t,e,s){var o=this.opts[t+\"Callback\"];return $.isFunction(o)?!1===e?o.call(this,s):o.call(this,e,s):s},destroy:function(){clearInterval(this.autosaveInterval),$(window).off(\".redactor\"),this.$source.off(\"redactor-textarea\"),this.$element.off(\".redactor\").removeData(\"redactor\");var t=this.get();if(this.opts.textareamode)this.$box.after(this.$source),this.$box.remove(),this.$source.val(t).show();else{var e=this.$editor;this.opts.iframe&&(e=this.$element),this.$box.after(e),this.$box.remove(),e.removeClass(\"redactor_editor\").removeClass(\"redactor_editor_wym\").removeAttr(\"contenteditable\").html(t).show()}this.opts.toolbarExternal&&$(this.opts.toolbarExternal).html(\"\"),this.opts.air&&$(\"#redactor_air_\"+this.uuid).remove()},getObject:function(){return $.extend({},this)},getEditor:function(){return this.$editor},getBox:function(){return this.$box},getIframe:function(){return!!this.opts.iframe&&this.$frame},getToolbar:function(){return!!this.$toolbar&&this.$toolbar},get:function(){return this.$source.val()},getCodeIframe:function(){this.$editor.removeAttr(\"contenteditable\").removeAttr(\"dir\");var t=this.outerHtml(this.$frame.contents().children());return this.$editor.attr({contenteditable:!0,dir:this.opts.direction}),t},set:function(t,e,s){t=(t=t.toString()).replace(/\\$/g,\"&#36;\"),this.opts.fullpage?this.setCodeIframe(t):this.setEditor(t,e),\"\"==t&&(s=!1),!1!==s&&this.placeholderRemoveFromEditor()},setEditor:function(t,e){t=this.sanitizeHTML(t),!1!==e&&(t=this.cleanSavePreCode(t),t=this.cleanStripTags(t),t=this.cleanConvertProtected(t),t=this.cleanConvertInlineTags(t,!0),t=!1===this.opts.linebreaks?this.cleanConverters(t):t.replace(/<p(.*?)>([\\w\\W]*?)<\\/p>/gi,\"$2<br>\")),t=t.replace(/&amp;#36;/g,\"$\"),t=this.cleanEmpty(t),this.$editor.html(t),this.setNonEditable(),this.setSpansVerified(),this.sync()},sanitizeHTML:function(t){if(0===t.length)return t;function e(){return new DOMParser().parseFromString(t,\"text/html\").body}function s(t){let e=t.children;for(let r of e)o(r),s(r)}function o(t){let e=t.attributes;for(let{name:s,value:o}of e)r(s,o)&&t.removeAttribute(s)}function r(t,e){let s=e.replace(/\\s+/g,\"\").toLowerCase();if([\"src\",\"href\",\"xlink:href\"].includes(t)&&(s.includes(\"javascript:\")||s.includes(\"data:text/html\"))||t.startsWith(\"on\"))return!0}let a=e();return s(a),a.innerHTML},setCodeIframe:function(t){var e=this.iframePage();this.$frame[0].src=\"about:blank\",t=this.cleanConvertProtected(t),t=this.cleanConvertInlineTags(t),t=this.cleanRemoveSpaces(t),e.open(),e.write(t),e.close(),this.opts.fullpage&&(this.$editor=this.$frame.contents().find(\"body\").attr({contenteditable:!0,dir:this.opts.direction})),this.setNonEditable(),this.setSpansVerified(),this.sync()},setFullpageOnInit:function(t){t=this.sanitizeHTML(t),this.fullpageDoctype=t.match(/^<\\!doctype[^>]*>/i),this.fullpageDoctype&&1==this.fullpageDoctype.length&&(t=t.replace(/^<\\!doctype[^>]*>/i,\"\")),t=this.cleanSavePreCode(t,!0),t=this.cleanConverters(t),t=this.cleanEmpty(t),this.$editor.html(t),this.setNonEditable(),this.setSpansVerified(),this.sync()},setFullpageDoctype:function(){if(this.fullpageDoctype&&1==this.fullpageDoctype.length){var t=this.fullpageDoctype[0]+\"\\n\"+this.$source.val();this.$source.val(t)}},setSpansVerified:function(){var t=this.$editor.find(\"span\"),e=\"inline\";$.each(t,function(){var t=this.outerHTML,s=RegExp(\"<\"+this.tagName,\"gi\"),o=t.replace(s,\"<\"+e);s=RegExp(\"</\"+this.tagName,\"gi\"),o=o.replace(s,\"</\"+e),$(this).replaceWith(o)})},setSpansVerifiedHtml:function(t){return(t=t.replace(/<span(.*?)>/,\"<inline$1>\")).replace(/<\\/span>/,\"</inline>\")},setNonEditable:function(){this.$editor.find(\".noneditable\").attr(\"contenteditable\",!1)},sync:function(t){var e,s=\"\";if(this.cleanUnverified(),s=this.opts.fullpage?this.getCodeIframe():this.$editor.html(),s=this.syncClean(s),s=this.cleanRemoveEmptyTags(s),this.cleanRemoveSpaces(this.$source.val(),!1)==this.cleanRemoveSpaces(s,!1))return!1;if(s=s.replace(/<\\/li><(ul|ol)>([\\w\\W]*?)<\\/(ul|ol)>/gi,\"<$1>$2</$1></li>\"),\"<br>\"===$.trim(s)&&(s=\"\"),this.opts.xhtml){var o=[\"br\",\"hr\",\"img\",\"link\",\"input\",\"meta\"];$.each(o,function(t,e){s=s.replace(RegExp(\"<\"+e+\"(.*?[^/$]?)>\",\"gi\"),\"<\"+e+\"$1 />\")})}if(s=this.callback(\"syncBefore\",!1,s),this.$source.val(s),this.setFullpageDoctype(),this.callback(\"syncAfter\",!1,s),!1===this.start){if(void 0!==t)switch(t.which){case 37:case 38:case 39:case 40:break;default:this.callback(\"change\",!1,s)}else this.callback(\"change\",!1,s)}},syncClean:function(t){return this.opts.fullpage||(t=this.cleanStripTags(t)),t=$.trim(t),(\"<p></p>\"==(t=(t=(t=(t=(t=this.placeholderRemoveFromCode(t)).replace(/&#x200b;/gi,\"\")).replace(/&#8203;/gi,\"\")).replace(/<\\/a>&nbsp;/gi,\"</a> \")).replace(/\\u200B/g,\"\"))||\"<p> </p>\"==t||\"<p>&nbsp;</p>\"==t)&&(t=\"\"),this.opts.linkNofollow&&(t=(t=t.replace(/<a(.*?)rel=\"nofollow\"(.*?)>/gi,\"<a$1$2>\")).replace(/<a(.*?)>/gi,'<a$1 rel=\"nofollow\">')),t=(t=(t=(t=(t=(t=(t=(t=(t=t.replace(\"<!--?php\",\"<?php\")).replace(\"?-->\",\"?>\")).replace(/<(.*?)class=\"noeditable\"(.*?) contenteditable=\"false\"(.*?)>/gi,'<$1class=\"noeditable\"$2$3>')).replace(/ data-tagblock=\"\"/gi,\"\")).replace(/<br\\s?\\/?>\\n?<\\/(P|H[1-6]|LI|ADDRESS|SECTION|HEADER|FOOTER|ASIDE|ARTICLE)>/gi,\"</$1>\")).replace(/<span(.*?)id=\"redactor-image-box\"(.*?)>([\\w\\W]*?)<img(.*?)><\\/span>/gi,\"$3<img$4>\")).replace(/<span(.*?)id=\"redactor-image-resizer\"(.*?)>(.*?)<\\/span>/gi,\"\")).replace(/<span(.*?)id=\"redactor-image-editter\"(.*?)>(.*?)<\\/span>/gi,\"\")).replace(/<(ul|ol)>\\s*\\t*\\n*<\\/(ul|ol)>/gi,\"\"),this.opts.cleanFontTag&&(t=t.replace(/<font(.*?)>([\\w\\W]*?)<\\/font>/gi,\"$2\")),t=(t=(t=(t=(t=t.replace(/<span(.*?)>([\\w\\W]*?)<\\/span>/gi,\"$2\")).replace(/<inline>([\\w\\W]*?)<\\/inline>/gi,\"$1\")).replace(/<inline>/gi,\"<span>\")).replace(/<inline /gi,\"<span \")).replace(/<\\/inline>/gi,\"</span>\"),this.opts.removeEmptyTags&&(t=t.replace(/<span>([\\w\\W]*?)<\\/span>/gi,\"$1\")),t=(t=(t=(t=(t=(t=(t=(t=t.replace(/<span(.*?)class=\"redactor_placeholder\"(.*?)>([\\w\\W]*?)<\\/span>/gi,\"\")).replace(/<img(.*?)contenteditable=\"false\"(.*?)>/gi,\"<img$1$2>\")).replace(/&/gi,\"&\")).replace(/\\u2122/gi,\"&trade;\")).replace(/\\u00a9/gi,\"&copy;\")).replace(/\\u2026/gi,\"&hellip;\")).replace(/\\u2014/gi,\"&mdash;\")).replace(/\\u2010/gi,\"&dash;\"),t=this.cleanReConvertProtected(t)},buildStart:function(){this.content=\"\",this.$box=$('<div class=\"redactor_box\" />'),\"TEXTAREA\"===this.$source[0].tagName&&(this.opts.textareamode=!0),!1===this.opts.mobile&&this.isMobile()?this.buildMobile():(this.buildContent(),this.opts.iframe?(this.opts.autoresize=!1,this.iframeStart()):this.opts.textareamode?this.buildFromTextarea():this.buildFromElement(),this.opts.iframe||(this.buildOptions(),this.buildAfter()))},buildMobile:function(){this.opts.textareamode||(this.$editor=this.$source,this.$editor.hide(),this.$source=this.buildCodearea(this.$editor),this.$source.val(this.content)),this.$box.insertAfter(this.$source).append(this.$source)},buildContent:function(){this.opts.textareamode?this.content=$.trim(this.$source.val()):this.content=$.trim(this.$source.html())},buildFromTextarea:function(){this.$editor=$(\"<div />\"),this.$box.insertAfter(this.$source).append(this.$editor).append(this.$source),this.buildAddClasses(this.$editor),this.buildEnable()},buildFromElement:function(){this.$editor=this.$source,this.$source=this.buildCodearea(this.$editor),this.$box.insertAfter(this.$editor).append(this.$editor).append(this.$source),this.buildEnable()},buildCodearea:function(t){return $(\"<textarea />\").attr(\"name\",t.attr(\"id\")).css(\"height\",this.sourceHeight)},buildAddClasses:function(t){$.each(this.$source.get(0).className.split(/\\s+/),function(e,s){t.addClass(\"redactor_\"+s)})},buildEnable:function(){this.$editor.addClass(\"redactor_editor\").attr({contenteditable:!0,dir:this.opts.direction}),this.$source.attr(\"dir\",this.opts.direction).hide(),this.set(this.content,!0,!1)},buildOptions:function(){var t=this.$editor;this.opts.iframe&&(t=this.$frame),this.opts.tabindex&&t.attr(\"tabindex\",this.opts.tabindex),this.opts.minHeight?t.css(\"min-height\",this.opts.minHeight+\"px\"):this.browser(\"mozilla\")&&this.opts.linebreaks&&this.$editor.css(\"min-height\",\"45px\"),this.browser(\"mozilla\")&&this.opts.linebreaks&&this.$editor.css(\"padding-bottom\",\"10px\"),this.opts.maxHeight&&(this.opts.autoresize=!1,this.sourceHeight=this.opts.maxHeight),this.opts.wym&&this.$editor.addClass(\"redactor_editor_wym\"),this.opts.typewriter&&this.$editor.addClass(\"redactor-editor-typewriter\"),this.opts.autoresize||t.css(\"height\",this.sourceHeight)},buildAfter:function(){if(this.start=!1,this.opts.toolbar&&(this.opts.toolbar=this.toolbarInit(this.opts.curLang),this.toolbarBuild()),this.modalTemplatesInit(),this.buildPlugins(),this.buildBindKeyboard(),this.opts.autosave&&this.autosave(),setTimeout($.proxy(this.observeStart,this),4),this.browser(\"mozilla\"))try{this.document.execCommand(\"enableObjectResizing\",!1,!1),this.document.execCommand(\"enableInlineTableEditing\",!1,!1)}catch(t){}this.opts.focus&&setTimeout($.proxy(this.focus,this),100),this.opts.visual||setTimeout($.proxy(function(){this.opts.visual=!0,this.toggle(!1)},this),200),this.callback(\"init\")},buildBindKeyboard:function(){var t;this.dblEnter=0,this.opts.dragUpload&&(!1!==this.opts.imageUpload||!1!==this.opts.s3)&&this.$editor.on(\"drop.redactor\",$.proxy(this.buildEventDrop,this)),this.$editor.on(\"click.redactor\",$.proxy(function(){this.selectall=!1},this)),this.$editor.on(\"input.redactor\",$.proxy(this.sync,this)),this.$editor.on(\"paste.redactor\",$.proxy(this.buildEventPaste,this)),this.$editor.on(\"keydown.redactor\",$.proxy(this.buildEventKeydown,this)),this.$editor.on(\"keyup.redactor\",$.proxy(this.buildEventKeyup,this)),$.isFunction(this.opts.textareaKeydownCallback)&&this.$source.on(\"keydown.redactor-textarea\",$.proxy(this.opts.textareaKeydownCallback,this)),$.isFunction(this.opts.focusCallback)&&this.$editor.on(\"focus.redactor\",$.proxy(this.opts.focusCallback,this)),$(document).mousedown(function(e){t=$(e.target)}),this.$editor.on(\"blur.redactor\",$.proxy(function(e){!$(t).hasClass(\"redactor_toolbar\")&&0==$(t).parents(\".redactor_toolbar\").length&&(this.selectall=!1,$.isFunction(this.opts.blurCallback)&&this.callback(\"blur\",e))},this))},buildEventDrop:function(t){if(t=t.originalEvent||t,void 0===window.FormData||!t.dataTransfer||0==t.dataTransfer.files.length)return!0;t.preventDefault();var e=t.dataTransfer.files[0];if(!1!==this.opts.dnbImageTypes&&-1==this.opts.dnbImageTypes.indexOf(e.type))return!0;this.bufferSet(),this.showProgressBar(),!1===this.opts.s3?this.dragUploadAjax(this.opts.imageUpload,e,!0,t,this.opts.imageUploadParam):this.s3uploadFile(e)},buildEventPaste:function(t){var e=!1;if(this.browser(\"webkit\")&&-1===navigator.userAgent.indexOf(\"Chrome\")&&this.browser(\"version\").split(\".\")[0]<536&&(e=!0),e||this.browser(\"opera\")||this.opts.clipboardUpload&&this.buildEventClipboardUpload(t))return!0;if(this.opts.cleanup){this.rtePaste=!0,this.selectionSave(),this.selectall||(!0===this.opts.autoresize&&!0!==this.fullscreen?(this.$editor.height(this.$editor.height()),this.saveScroll=this.document.body.scrollTop):this.saveScroll=this.$editor.scrollTop());var s=this.extractContent();setTimeout($.proxy(function(){var t=this.extractContent();this.$editor.append(s),this.selectionRestore();var e=this.getFragmentHtml(t);this.pasteClean(e),!0===this.opts.autoresize&&!0!==this.fullscreen&&this.$editor.css(\"height\",\"auto\")},this),1)}},buildEventClipboardUpload:function(t){var e=t.originalEvent||t;if(this.clipboardFilePaste=!1,void 0===e.clipboardData)return!1;if(e.clipboardData.items){var s=e.clipboardData.items[0].getAsFile();if(null!==s){this.bufferSet(),this.clipboardFilePaste=!0;var o=new FileReader;return o.onload=$.proxy(this.pasteClipboardUpload,this),o.readAsDataURL(s),!0}}return!1},buildEventKeydown:function(t){if(this.rtePaste)return!1;var e=t.which,s=t.ctrlKey||t.metaKey,o=this.getParent(),r=this.getCurrent(),a=this.getBlock(),n=!1;if(this.callback(\"keydown\",t),this.browser(\"mozilla\")&&\"modify\"in window.getSelection()&&s&&(37===t.keyCode||39===t.keyCode)){var l=this.getSelection(),c=t.metaKey?\"line\":\"word\";37!==t.keyCode||(l.modify(\"extend\",\"left\",c),t.shiftKey||l.collapseToStart()),39!==t.keyCode||(l.modify(\"extend\",\"right\",c),t.shiftKey||l.collapseToEnd()),t.preventDefault()}if(this.imageResizeHide(!1),(o&&\"CODE\"===$(o).get(0).tagName||r&&\"CODE\"===$(r).get(0).tagName)&&(n=!0,e===this.keyCode.DOWN&&this.insertAfterLastElement(a)),e===this.keyCode.DOWN&&(o&&\"BLOCKQUOTE\"===$(o)[0].tagName&&this.insertAfterLastElement(o),r&&\"BLOCKQUOTE\"===$(r)[0].tagName&&this.insertAfterLastElement(r),o&&\"P\"===$(o)[0].tagName&&\"BLOCKQUOTE\"==$(o).parent()[0].tagName&&this.insertAfterLastElement(o,$(o).parent()[0]),r&&\"P\"===$(r)[0].tagName&&o&&\"BLOCKQUOTE\"==$(o)[0].tagName&&this.insertAfterLastElement(r,o)),this.shortcuts(t,e),!s||90!==e||t.shiftKey||t.altKey){if(s&&90===e&&t.shiftKey&&!t.altKey){t.preventDefault(),0!=this.opts.rebuffer.length?this.bufferRedo():this.document.execCommand(\"redo\",!1,!1);return}}else{t.preventDefault(),this.opts.buffer.length?this.bufferUndo():this.document.execCommand(\"undo\",!1,!1);return}if(32==e&&this.bufferSet(),s&&65===e?(this.bufferSet(),this.selectall=!0):e==this.keyCode.LEFT_WIN||s||(this.selectall=!1),e!=this.keyCode.ENTER||t.shiftKey||t.ctrlKey||t.metaKey)e===this.keyCode.ENTER&&(t.ctrlKey||t.shiftKey)&&(this.bufferSet(),t.preventDefault(),this.insertLineBreak());else{var h=this.getRange();if(h&&!1===h.collapsed&&(sel=this.getSelection()).rangeCount&&h.deleteContents(),this.browser(\"msie\")&&1==o.nodeType&&(\"TD\"==o.tagName||\"TH\"==o.tagName))return t.preventDefault(),this.bufferSet(),this.insertNode(document.createElement(\"br\")),this.callback(\"enter\",t),!1;if(a&&(\"BLOCKQUOTE\"==a.tagName||\"BLOCKQUOTE\"==$(a).parent()[0].tagName)){if(this.isEndOfElement()){if(1==this.dblEnter){if(\"BLOCKQUOTE\"==a.tagName?(p=\"br\",d=a):(p=\"p\",d=$(a).parent()[0]),t.preventDefault(),this.insertingAfterLastElement(d),this.dblEnter=0,\"p\"==p)$(a).parent().find(\"p\").last().remove();else{var d,p,u=$.trim($(a).html());$(a).html(u.replace(/<br\\s?\\/?>$/i,\"\"))}return}this.dblEnter++}else this.dblEnter++}if(!0===n)return this.buildEventKeydownPre(t,r);if(!this.opts.linebreaks){if(a&&\"LI\"==a.tagName){var f=this.getBlock();if(!1!==f||\"LI\"===f.tagName){var m=$.trim($(a).text()),g=$.trim($(f).text());if(\"\"==m&&\"\"==g&&0==$(f).next(\"li\").length&&0==$(f).parents(\"li\").length){this.bufferSet();var b=$(f).closest(\"ol, ul\");$(f).remove();var v=$(\"<p>\"+this.opts.invisibleSpace+\"</p>\");return b.after(v),this.selectionStart(v),this.sync(),this.callback(\"enter\",t),!1}}}if(a&&this.opts.rBlockTest.test(a.tagName))this.bufferSet(),setTimeout($.proxy(function(){var t=this.getBlock();if(\"DIV\"===t.tagName&&!$(t).hasClass(\"redactor_editor\")){var e=$(\"<p>\"+this.opts.invisibleSpace+\"</p>\");$(t).replaceWith(e),this.selectionStart(e)}},this),1);else if(!1===a){this.bufferSet();var v=$(\"<p>\"+this.opts.invisibleSpace+\"</p>\");return this.insertNode(v[0]),this.selectionStart(v),this.callback(\"enter\",t),!1}}if(this.opts.linebreaks){if(!(a&&this.opts.rBlockTest.test(a.tagName)))return this.buildEventKeydownInsertLineBreak(t);this.bufferSet(),setTimeout($.proxy(function(){var t=this.getBlock();\"DIV\"!==t.tagName&&\"P\"!==t.tagName||$(t).hasClass(\"redactor_editor\")||this.replaceLineBreak(t)},this),1)}if(\"BLOCKQUOTE\"==a.tagName||\"FIGCAPTION\"==a.tagName)return this.buildEventKeydownInsertLineBreak(t);this.callback(\"enter\",t)}if((e===this.keyCode.TAB||t.metaKey&&219===e)&&this.opts.shortcuts)return this.buildEventKeydownTab(t,n,e);e===this.keyCode.BACKSPACE&&this.buildEventKeydownBackspace(t,r,o)},buildEventKeydownPre:function(t,e){t.preventDefault(),this.bufferSet();var s=$(e).parent().text();return this.insertNode(document.createTextNode(\"\\n\")),-1==s.search(/\\s$/)&&this.insertNode(document.createTextNode(\"\\n\")),this.sync(),this.callback(\"enter\",t),!1},buildEventKeydownTab:function(t,e,s){return!!(!this.opts.tabFocus||this.isEmpty(this.get())&&!1===this.opts.tabSpaces)||(t.preventDefault(),!0!==e||t.shiftKey?!1!==this.opts.tabSpaces?(this.bufferSet(),this.insertNode(document.createTextNode(Array(this.opts.tabSpaces+1).join(\"\\xa0\"))),this.sync()):t.shiftKey?this.indentingOutdent():this.indentingIndent():(this.bufferSet(),this.insertNode(document.createTextNode(\"\t\")),this.sync()),!1)},buildEventKeydownBackspace:function(t,e,s){if(s&&e&&\"TD\"==s.parentNode.tagName&&\"UL\"==s.tagName&&\"LI\"==e.tagName&&1==$(s).children(\"li\").length){var o;if(\"\"==$(e).text().replace(/[\\u200B-\\u200D\\uFEFF]/g,\"\")){var o=s.parentNode;return $(s).remove(),this.selectionStart(o),this.sync(),!1}}void 0!==e.tagName&&/^(H[1-6])$/i.test(e.tagName)&&(o=!1===this.opts.linebreaks?$(\"<p>\"+this.opts.invisibleSpace+\"</p>\"):$(\"<br>\"+this.opts.invisibleSpace),$(e).replaceWith(o),this.selectionStart(o),this.sync()),void 0!==e.nodeValue&&null!==e.nodeValue&&e.remove&&3===e.nodeType&&null==e.nodeValue.match(/[^\\u200B]/g)&&($(e).prev().remove(),this.sync())},buildEventKeydownInsertLineBreak:function(t){this.bufferSet(),t.preventDefault(),this.insertLineBreak(),this.callback(\"enter\",t)},buildEventKeyup:function(t){if(this.rtePaste)return!1;var e=t.which,s=this.getParent(),o=this.getCurrent();if(!this.opts.linebreaks&&3==o.nodeType&&(!1==s||\"BODY\"==s.tagName)){var r=$(\"<p>\").append($(o).clone());$(o).replaceWith(r);var a=$(r).next();void 0!==a[0]&&\"BR\"==a[0].tagName&&a.remove(),this.selectionEnd(r)}if((this.opts.convertLinks||this.opts.convertImageLinks||this.opts.convertVideoLinks)&&e===this.keyCode.ENTER&&this.buildEventKeyupConverters(),e===this.keyCode.DELETE||e===this.keyCode.BACKSPACE)return this.formatEmpty(t);this.callback(\"keyup\",t),this.sync(t)},buildEventKeyupConverters:function(){this.formatLinkify(this.opts.linkProtocol,this.opts.convertLinks,this.opts.convertImageLinks,this.opts.convertVideoLinks,this.opts.linkSize),setTimeout($.proxy(function(){this.opts.convertImageLinks&&this.observeImages(),this.opts.observeLinks&&this.observeLinks()},this),5)},buildPlugins:function(){this.opts.plugins&&$.each(this.opts.plugins,$.proxy(function(t,e){RedactorPlugins[e]&&($.extend(this,RedactorPlugins[e]),$.isFunction(RedactorPlugins[e].init)&&this.init())},this))},iframeStart:function(){this.iframeCreate(),this.opts.textareamode?this.iframeAppend(this.$source):(this.$sourceOld=this.$source.hide(),this.$source=this.buildCodearea(this.$sourceOld),this.iframeAppend(this.$sourceOld))},iframeAppend:function(t){this.$source.attr(\"dir\",this.opts.direction).hide(),this.$box.insertAfter(t).append(this.$frame).append(this.$source)},iframeCreate:function(){this.$frame=$('<iframe style=\"width: 100%;\" frameborder=\"0\" />').one(\"load\",$.proxy(function(){if(this.opts.fullpage){this.iframePage(),\"\"===this.content&&(this.content=this.opts.invisibleSpace),this.$frame.contents()[0].write(this.content),this.$frame.contents()[0].close();var t=setInterval($.proxy(function(){this.$frame.contents().find(\"body\").html()&&(clearInterval(t),this.iframeLoad())},this),0)}else this.iframeLoad()},this))},iframeDoc:function(){return this.$frame[0].contentWindow.document},iframePage:function(){var t=this.iframeDoc();return t.documentElement&&t.removeChild(t.documentElement),t},iframeAddCss:function(t){t=t||this.opts.css,this.isString(t)&&this.$frame.contents().find(\"head\").append('<link rel=\"stylesheet\" href=\"'+t+'\" />'),$.isArray(t)&&$.each(t,$.proxy(function(t,e){this.iframeAddCss(e)},this))},iframeLoad:function(){this.$editor=this.$frame.contents().find(\"body\").attr({contenteditable:!0,dir:this.opts.direction}),this.$editor[0]&&(this.document=this.$editor[0].ownerDocument,this.window=this.document.defaultView||window),this.iframeAddCss(),this.opts.fullpage?this.setFullpageOnInit(this.$source.val()):this.set(this.content,!0,!1),this.buildOptions(),this.buildAfter()},placeholderInit:function(){!1!==this.opts.placeholder?(this.placeholderText=this.opts.placeholder,this.opts.placeholder=!0):void 0===this.$element.attr(\"placeholder\")||\"\"==this.$element.attr(\"placeholder\")?this.opts.placeholder=!1:(this.placeholderText=this.$element.attr(\"placeholder\"),this.opts.placeholder=!0)},placeholderStart:function(t){return!1!==this.opts.placeholder&&(this.isEmpty(t)?(this.opts.focus=!1,this.placeholderOnFocus(),this.placeholderOnBlur(),this.placeholderGet()):(this.placeholderOnBlur(),!1))},placeholderOnFocus:function(){this.$editor.on(\"focus.redactor_placeholder\",$.proxy(this.placeholderFocus,this))},placeholderOnBlur:function(){this.$editor.on(\"blur.redactor_placeholder\",$.proxy(this.placeholderBlur,this))},placeholderGet:function(){var t=$('<span class=\"redactor_placeholder\">').data(\"redactor\",\"verified\").attr(\"contenteditable\",!1).text(this.placeholderText);return!1===this.opts.linebreaks?$(\"<p>\").append(t):t},placeholderBlur:function(){var t=this.get();this.isEmpty(t)&&(this.placeholderOnFocus(),this.$editor.html(this.placeholderGet()))},placeholderFocus:function(){this.$editor.find(\"span.redactor_placeholder\").remove();var t=\"\";!1===this.opts.linebreaks&&(t=this.opts.emptyHtml),this.$editor.off(\"focus.redactor_placeholder\"),this.$editor.html(t),!1===this.opts.linebreaks?this.selectionStart(this.$editor.children()[0]):this.focus(),this.sync()},placeholderRemoveFromEditor:function(){this.$editor.find(\"span.redactor_placeholder\").remove(),this.$editor.off(\"focus.redactor_placeholder\")},placeholderRemoveFromCode:function(t){return t.replace(/<span class=\"redactor_placeholder\"(.*?)>(.*?)<\\/span>/i,\"\")},shortcuts:function(e,key){if(!this.opts.shortcuts)return(e.ctrlKey||e.metaKey)&&(66===key||73===key)&&e.preventDefault(),!1;$.each(this.opts.shortcuts,$.proxy(function(str,command){var keys=str.split(\",\");for(var i in keys)\"string\"==typeof keys[i]&&this.shortcutsHandler(e,$.trim(keys[i]),$.proxy(function(){eval(command)},this))},this))},shortcutsHandler:function(t,e,s){var o={8:\"backspace\",9:\"tab\",10:\"return\",13:\"return\",16:\"shift\",17:\"ctrl\",18:\"alt\",19:\"pause\",20:\"capslock\",27:\"esc\",32:\"space\",33:\"pageup\",34:\"pagedown\",35:\"end\",36:\"home\",37:\"left\",38:\"up\",39:\"right\",40:\"down\",45:\"insert\",46:\"del\",59:\";\",61:\"=\",96:\"0\",97:\"1\",98:\"2\",99:\"3\",100:\"4\",101:\"5\",102:\"6\",103:\"7\",104:\"8\",105:\"9\",106:\"*\",107:\"+\",109:\"-\",110:\".\",111:\"/\",112:\"f1\",113:\"f2\",114:\"f3\",115:\"f4\",116:\"f5\",117:\"f6\",118:\"f7\",119:\"f8\",120:\"f9\",121:\"f10\",122:\"f11\",123:\"f12\",144:\"numlock\",145:\"scroll\",173:\"-\",186:\";\",187:\"=\",188:\",\",189:\"-\",190:\".\",191:\"/\",192:\"`\",219:\"[\",220:\"\\\\\",221:\"]\",222:\"'\"},r={\"`\":\"~\",1:\"!\",2:\"@\",3:\"#\",4:\"$\",5:\"%\",6:\"^\",7:\"&\",8:\"*\",9:\"(\",0:\")\",\"-\":\"_\",\"=\":\"+\",\";\":\": \",\"'\":'\"',\",\":\"<\",\".\":\">\",\"/\":\"?\",\"\\\\\":\"|\"};e=e.toLowerCase().split(\" \");var a=o[t.keyCode],n=String.fromCharCode(t.which).toLowerCase(),l=\"\",c={};$.each([\"alt\",\"ctrl\",\"meta\",\"shift\"],function(e,s){t[s+\"Key\"]&&a!==s&&(l+=s+\"+\")}),a&&(c[l+a]=!0),n&&(c[l+n]=!0,c[l+r[n]]=!0,\"shift+\"===l&&(c[r[n]]=!0));for(var h=0,d=e.length;h<d;h++)if(c[e[h]])return t.preventDefault(),s.apply(this,arguments)},focus:function(){this.browser(\"opera\")?this.$editor.focus():this.window.setTimeout($.proxy(this.focusSet,this,!0),1)},focusWithSaveScroll:function(){if(this.browser(\"msie\"))var t=this.document.documentElement.scrollTop;this.$editor.focus(),this.browser(\"msie\")&&(this.document.documentElement.scrollTop=t)},focusEnd:function(){if(this.browser(\"mozilla\")){if(!1===this.opts.linebreaks){var t=this.$editor.children().last();this.$editor.focus(),this.selectionEnd(t)}else this.focusSet()}else this.focusSet()},focusSet:function(t,e){this.$editor.focus(),void 0===e&&(e=this.$editor[0]);var s=this.getRange();s.selectNodeContents(e),s.collapse(t||!1);var o=this.getSelection();o.removeAllRanges(),o.addRange(s)},toggle:function(t){this.opts.visual?this.toggleCode(t):this.toggleVisual()},toggleVisual:function(){var t=this.$source.hide().val();if(void 0!==this.modified){var e=this.modified.replace(/\\n/g,\"\"),s=t.replace(/\\n/g,\"\");s=this.cleanRemoveSpaces(s,!1),this.modified=this.cleanRemoveSpaces(e,!1)!==s}this.modified&&(this.opts.fullpage&&\"\"===t?this.setFullpageOnInit(t):(this.set(t),this.opts.fullpage&&this.buildBindKeyboard()),this.callback(\"change\",!1,t)),this.opts.iframe?this.$frame.show():this.$editor.show(),this.opts.fullpage&&this.$editor.attr(\"contenteditable\",!0),this.$source.off(\"keydown.redactor-textarea-indenting\"),this.$editor.focus(),this.selectionRestore(),this.observeStart(),this.buttonActiveVisual(),this.buttonInactive(\"html\"),this.opts.visual=!0},toggleCode:function(t){!1!==t&&this.selectionSave();var e=null;this.opts.iframe?(e=this.$frame.height(),this.opts.fullpage&&this.$editor.removeAttr(\"contenteditable\"),this.$frame.hide()):(e=this.$editor.innerHeight(),this.$editor.hide());var s=this.$source.val();\"\"!==s&&this.opts.tidyHtml&&this.$source.val(this.cleanHtml(s)),this.modified=s,this.$source.height(e).show().focus(),this.$source.on(\"keydown.redactor-textarea-indenting\",this.textareaIndenting),this.buttonInactiveVisual(),this.buttonActive(\"html\"),this.opts.visual=!1},textareaIndenting:function(t){if(9===t.keyCode){var e=$(this),s=e.get(0).selectionStart;return e.val(e.val().substring(0,s)+\"\t\"+e.val().substring(e.get(0).selectionEnd)),e.get(0).selectionStart=e.get(0).selectionEnd=s+1,!1}},autosave:function(){var t=!1;this.autosaveInterval=setInterval($.proxy(function(){var e=this.get();if(t!==e){var s=this.$source.attr(\"name\");$.ajax({url:this.opts.autosave,type:\"post\",data:\"name=\"+s+\"&\"+s+\"=\"+escape(encodeURIComponent(e)),success:$.proxy(function(s){var o=$.parseJSON(s);void 0===o.error?this.callback(\"autosave\",!1,o):this.callback(\"autosaveError\",!1,o),t=e},this)})}},this),1e3*this.opts.autosaveInterval)},toolbarBuild:function(){if(this.isMobile()&&this.opts.buttonsHideOnMobile.length>0&&$.each(this.opts.buttonsHideOnMobile,$.proxy(function(t,e){var s=this.opts.buttons.indexOf(e);this.opts.buttons.splice(s,1)},this)),this.opts.air)this.opts.buttons=this.opts.airButtons;else if(!this.opts.buttonSource){var t=this.opts.buttons.indexOf(\"html\");this.opts.buttons.splice(t,1)}if(this.opts.toolbar&&$.each(this.opts.toolbar.formatting.dropdown,$.proxy(function(t,e){\"-1\"==$.inArray(t,this.opts.formattingTags)&&delete this.opts.toolbar.formatting.dropdown[t]},this)),0===this.opts.buttons.length)return!1;this.airEnable(),this.$toolbar=$(\"<ul>\").addClass(\"redactor_toolbar\").attr(\"id\",\"redactor_toolbar_\"+this.uuid),this.opts.typewriter&&this.$toolbar.addClass(\"redactor-toolbar-typewriter\"),this.opts.toolbarOverflow&&this.isMobile()&&this.$toolbar.addClass(\"redactor-toolbar-overflow\"),this.opts.air?(this.$air=$('<div class=\"redactor_air\">').attr(\"id\",\"redactor_air_\"+this.uuid).hide(),this.$air.append(this.$toolbar),$(\"body\").append(this.$air)):this.opts.toolbarExternal?(this.$toolbar.addClass(\"redactor-toolbar-external\"),$(this.opts.toolbarExternal).html(this.$toolbar)):this.$box.prepend(this.$toolbar),$.each(this.opts.buttons,$.proxy(function(t,e){if(this.opts.toolbar[e]){var s=this.opts.toolbar[e];if(!1===this.opts.fileUpload&&\"file\"===e)return!0;this.$toolbar.append($(\"<li>\").append(this.buttonBuild(e,s)))}},this)),this.$toolbar.find(\"a\").attr(\"tabindex\",\"-1\"),this.opts.toolbarFixed&&(this.toolbarObserveScroll(),$(this.opts.toolbarFixedTarget).on(\"scroll.redactor\",$.proxy(this.toolbarObserveScroll,this))),this.opts.activeButtons&&this.$editor.on(\"mouseup.redactor keyup.redactor\",$.proxy(this.buttonActiveObserver,this))},toolbarObserveScroll:function(){var t=$(this.opts.toolbarFixedTarget).scrollTop(),e=0,s=0,o=0;if(o=(e=this.opts.toolbarFixedTarget===document?this.$box.offset().top:1)+this.$box.height()+40,t>e){var r=\"100%\";this.opts.toolbarFixedBox&&(s=this.$box.offset().left,r=this.$box.innerWidth(),this.$toolbar.addClass(\"toolbar_fixed_box\")),this.toolbarFixed=!0,this.opts.toolbarFixedTarget===document?this.$toolbar.css({position:\"fixed\",width:r,zIndex:10005,top:this.opts.toolbarFixedTopOffset+\"px\",left:s}):this.$toolbar.css({position:\"absolute\",width:r,zIndex:10005,top:this.opts.toolbarFixedTopOffset+t+\"px\",left:0}),t<o?this.$toolbar.css(\"visibility\",\"visible\"):this.$toolbar.css(\"visibility\",\"hidden\")}else this.toolbarFixed=!1,this.$toolbar.css({position:\"relative\",width:\"auto\",top:0,left:s}),this.opts.toolbarFixedBox&&this.$toolbar.removeClass(\"toolbar_fixed_box\")},airEnable:function(){this.opts.air&&this.$editor.on(\"mouseup.redactor keyup.redactor\",this,$.proxy(function(t){var e=this.getSelectionText();if(\"mouseup\"===t.type&&\"\"!=e&&this.airShow(t),\"keyup\"===t.type&&t.shiftKey&&\"\"!=e){var s=$(this.getElement(this.getSelection().focusNode)),o=s.offset();o.height=s.height(),this.airShow(o,!0)}},this))},airShow:function(t,e){if(this.opts.air){if(this.selectionSave(),$(\".redactor_air\").hide(),e)s=t.left,o=t.top+t.height+14,this.opts.iframe&&(o+=this.$box.position().top-$(this.document).scrollTop(),s+=this.$box.position().left);else{var s,o,r=this.$air.innerWidth();s=t.clientX,$(this.document).width()<s+r&&(s-=r),o=t.clientY+14,this.opts.iframe?(o+=this.$box.position().top,s+=this.$box.position().left):o+=$(this.document).scrollTop()}this.$air.css({left:s+\"px\",top:o+\"px\"}).show(),this.airBindHide()}},airBindHide:function(){if(this.opts.air){var t=$.proxy(function(t){$(t).on(\"mousedown.redactor\",$.proxy(function(e){0===$(e.target).closest(this.$toolbar).length&&(this.$air.fadeOut(100),this.selectionRemove(),$(t).off(e))},this)).on(\"keydown.redactor\",$.proxy(function(e){e.which===this.keyCode.ESC&&this.getSelection().collapseToStart(),this.$air.fadeOut(100),$(t).off(e)},this))},this);t(document),this.opts.iframe&&t(this.document)}},airBindMousemoveHide:function(){if(this.opts.air){var t=$.proxy(function(t){$(t).on(\"mousemove.redactor\",$.proxy(function(e){0===$(e.target).closest(this.$toolbar).length&&(this.$air.fadeOut(100),$(t).off(e))},this))},this);t(document),this.opts.iframe&&t(this.document)}},dropdownBuild:function(t,e){$.each(e,$.proxy(function(e,s){var o;s.className||(s.className=\"\"),\"separator\"===s.name?o=$('<a class=\"redactor_separator_drop\">'):(o=$('<a href=\"#\" class=\"'+s.className+\" redactor_dropdown_\"+e+'\">'+s.title+\"</a>\")).on(\"click\",$.proxy(function(t){this.opts.air&&this.selectionRestore(),t.preventDefault&&t.preventDefault(),this.browser(\"msie\")&&(t.returnValue=!1),s.callback&&s.callback.call(this,e,o,s,t),s.exec&&this.execCommand(s.exec,e),s.func&&this[s.func](e),this.buttonActiveObserver(),this.opts.air&&this.$air.fadeOut(100)},this)),t.append(o)},this))},dropdownShow:function(t,e){if(!this.opts.visual)return t.preventDefault(),!1;var s=this.buttonGet(e),o=s.data(\"dropdown\").appendTo(document.body);if(s.hasClass(\"dropact\"))this.dropdownHideAll();else{this.dropdownHideAll(),this.callback(\"dropdownShow\",{dropdown:o,key:e,button:s}),this.buttonActive(e),s.addClass(\"dropact\");var r=s.offset(),a=o.width();r.left+a>$(document).width()&&(r.left-=a);var n=r.left+\"px\",l=s.innerHeight(),c=\"absolute\",h=l+this.opts.toolbarFixedTopOffset+\"px\";this.opts.toolbarFixed&&this.toolbarFixed?c=\"fixed\":h=r.top+l+\"px\",o.css({position:c,left:n,top:h}).show(),this.callback(\"dropdownShown\",{dropdown:o,key:e,button:s})}var d=$.proxy(function(t){this.dropdownHide(t,o)},this);$(document).one(\"click\",d),this.$editor.one(\"click\",d),this.$editor.one(\"touchstart\",d),t.stopPropagation(),this.focusWithSaveScroll()},dropdownHideAll:function(){this.$toolbar.find(\"a.dropact\").removeClass(\"redactor_act\").removeClass(\"dropact\"),$(\".redactor_dropdown\").hide(),this.callback(\"dropdownHide\")},dropdownHide:function(t,e){$(t.target).hasClass(\"dropact\")||(e.removeClass(\"dropact\"),this.dropdownHideAll())},buttonBuild:function(t,e,s){var o=$('<a href=\"javascript:;\" title=\"'+e.title+'\" tabindex=\"-1\" class=\"re-icon re-'+t+'\"></a>');if(void 0!==s&&o.addClass(\"redactor-btn-image\"),o.on(\"click\",$.proxy(function(s){if(s.preventDefault&&s.preventDefault(),this.browser(\"msie\")&&(s.returnValue=!1),o.hasClass(\"redactor_button_disabled\"))return!1;!1!==this.isFocused()||e.exec||this.focusWithSaveScroll(),e.exec?(this.focusWithSaveScroll(),this.execCommand(e.exec,t),this.airBindMousemoveHide()):e.func&&\"show\"!==e.func?(this[e.func](t),this.airBindMousemoveHide()):e.callback?(e.callback.call(this,t,o,e,s),this.airBindMousemoveHide()):e.dropdown&&this.dropdownShow(s,t),this.buttonActiveObserver(!1,t)},this)),e.dropdown){var r=$('<div class=\"redactor_dropdown redactor_dropdown_box_'+t+'\" style=\"display: none;\">');o.data(\"dropdown\",r),this.dropdownBuild(r,e.dropdown)}return o},buttonGet:function(t){return!!this.opts.toolbar&&$(this.$toolbar.find(\"a.re-\"+t))},buttonTagToActiveState:function(t,e){this.opts.activeButtons.push(t),this.opts.activeButtonsStates[e]=t},buttonActiveToggle:function(t){this.buttonGet(t).hasClass(\"redactor_act\")?this.buttonInactive(t):this.buttonActive(t)},buttonActive:function(t){this.buttonGet(t).addClass(\"redactor_act\")},buttonInactive:function(t){this.buttonGet(t).removeClass(\"redactor_act\")},buttonInactiveAll:function(t){this.$toolbar.find(\"a.re-icon\").not(\".re-\"+t).removeClass(\"redactor_act\")},buttonActiveVisual:function(){this.$toolbar.find(\"a.re-icon\").not(\"a.re-html\").removeClass(\"redactor_button_disabled\")},buttonInactiveVisual:function(){this.$toolbar.find(\"a.re-icon\").not(\"a.re-html\").addClass(\"redactor_button_disabled\")},buttonChangeIcon:function(t,e){this.buttonGet(t).addClass(\"re-\"+e)},buttonRemoveIcon:function(t,e){this.buttonGet(t).removeClass(\"re-\"+e)},buttonAwesome:function(t,e){var s=this.buttonGet(t);s.removeClass(\"redactor-btn-image\"),s.addClass(\"fa-redactor-btn\"),s.html('<i class=\"fa '+e+'\"></i>')},buttonAdd:function(t,e,s,o){if(this.opts.toolbar){var r=this.buttonBuild(t,{title:e,callback:s,dropdown:o},!0);return this.$toolbar.append($(\"<li>\").append(r)),r}},buttonAddFirst:function(t,e,s,o){if(this.opts.toolbar){var r=this.buttonBuild(t,{title:e,callback:s,dropdown:o},!0);this.$toolbar.prepend($(\"<li>\").append(r))}},buttonAddAfter:function(t,e,s,o,r){if(this.opts.toolbar){var a=this.buttonBuild(e,{title:s,callback:o,dropdown:r},!0),n=this.buttonGet(t);return 0!==n.length?n.parent().after($(\"<li>\").append(a)):this.$toolbar.append($(\"<li>\").append(a)),a}},buttonAddBefore:function(t,e,s,o,r){if(this.opts.toolbar){var a=this.buttonBuild(e,{title:s,callback:o,dropdown:r},!0),n=this.buttonGet(t);return 0!==n.length?n.parent().before($(\"<li>\").append(a)):this.$toolbar.append($(\"<li>\").append(a)),a}},buttonRemove:function(t){this.buttonGet(t).remove()},buttonActiveObserver:function(t,e){var s=this.getParent();if(this.buttonInactiveAll(e),!1===t&&\"html\"!==e){-1!=$.inArray(e,this.opts.activeButtons)&&this.buttonActiveToggle(e);return}s&&\"A\"===s.tagName?this.$toolbar.find(\"a.redactor_dropdown_link\").text(this.opts.curLang.link_edit):this.$toolbar.find(\"a.redactor_dropdown_link\").text(this.opts.curLang.link_insert),$.each(this.opts.activeButtonsStates,$.proxy(function(t,e){0!=$(s).closest(t,this.$editor.get()[0]).length&&this.buttonActive(e)},this));var o=$(s).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0]);if(o.length){var r=o.css(\"text-align\");\"\"==r&&(r=\"left\"),this.buttonActive(\"align\"+r)}},execPasteFrag:function(t){var e=this.getSelection();if(e.getRangeAt&&e.rangeCount){var s=this.getRange();s.deleteContents();var o=this.document.createElement(\"div\");o.innerHTML=t;for(var r,a,n=this.document.createDocumentFragment();r=o.firstChild;)a=n.appendChild(r);n.firstChild,s.insertNode(n),a&&((s=s.cloneRange()).setStartAfter(a),s.collapse(!0)),e.removeAllRanges(),e.addRange(s)}},exec:function(t,e,s){\"formatblock\"===t&&this.browser(\"msie\")&&(e=\"<\"+e+\">\"),\"inserthtml\"===t&&this.browser(\"msie\")?this.isIe11()?this.execPasteFrag(e):(this.focusWithSaveScroll(),this.document.selection.createRange().pasteHTML(e)):this.document.execCommand(t,!1,e),!1!==s&&this.sync(),this.callback(\"execCommand\",t,e)},execCommand:function(t,e,s){if(!this.opts.visual)return this.$source.focus(),!1;if((\"bold\"===t||\"italic\"===t||\"underline\"===t||\"strikethrough\"===t)&&this.bufferSet(),\"superscript\"===t||\"subscript\"===t){var o=this.getParent();(\"SUP\"===o.tagName||\"SUB\"===o.tagName)&&this.inlineRemoveFormatReplace(o)}if(\"inserthtml\"===t){this.insertHtml(e,s),this.callback(\"execCommand\",t,e);return}return(!this.currentOrParentIs(\"CODE\")||!!this.opts.formattingPre)&&(\"insertunorderedlist\"===t||\"insertorderedlist\"===t?this.execLists(t,e):\"unlink\"===t?this.execUnlink(t,e):void(this.exec(t,e,s),\"inserthorizontalrule\"===t&&this.$editor.find(\"hr\").removeAttr(\"id\")))},execUnlink:function(t,e){this.bufferSet();var s=this.currentOrParentIs(\"A\");if(s){$(s).replaceWith($(s).text()),this.sync(),this.callback(\"execCommand\",t,e);return}},execLists:function(t,e){this.bufferSet();var s=this.getParent(),o=$(s).closest(\"ol, ul\");this.isParentRedactor(o)||0==o.length||(o=!1);var r=!1;if(o&&o.length){r=!0;var a=o[0].tagName;(\"insertunorderedlist\"===t&&\"OL\"===a||\"insertorderedlist\"===t&&\"UL\"===a)&&(r=!1)}if(this.selectionSave(),r){var n=this.getNodes(),l=this.getBlocks(n);void 0!==n[0]&&n.length>1&&3==n[0].nodeType&&l.unshift(this.getBlock());var c=\"\",h=\"\";$.each(l,$.proxy(function(t,e){if(\"LI\"==e.tagName){var s=$(e),o=s.clone();(o.find(\"ul\",\"ol\").remove(),!1===this.opts.linebreaks)?c+=this.outerHtml($(\"<p>\").append(o.contents())):c+=o.html().replace(/<br\\s?\\/?>$/i,\"\")+\"<br>\",0==t?(s.addClass(\"redactor-replaced\").empty(),h=this.outerHtml(s)):s.remove()}},this)),html=this.$editor.html().replace(h,\"</\"+a+\">\"+c+\"<\"+a+\">\"),this.$editor.html(html),this.$editor.find(a+\":empty\").remove()}else{var d=$(this.getParent()).closest(\"td\");if(this.browser(\"msie\")&&!this.isIe11()&&this.opts.linebreaks){var p=this.selectionWrap(\"div\"),u=$(p).html(),f=$(\"<ul>\");\"insertorderedlist\"==t&&(f=$(\"<ol>\"));var m=$(\"<li>\");\"\"==$.trim(u)?(m.append(u+'<span id=\"selection-marker-1\">'+this.opts.invisibleSpace+\"</span>\"),f.append(m),this.$editor.find(\"#selection-marker-1\").replaceWith(f)):(m.append(u),f.append(m),$(p).replaceWith(f))}else this.document.execCommand(t);var s=this.getParent(),o=$(s).closest(\"ol, ul\");if(!1===this.opts.linebreaks&&\"\"==$.trim(o.text())&&(o.children(\"li\").find(\"br\").remove(),o.children(\"li\").append('<span id=\"selection-marker-1\">'+this.opts.invisibleSpace+\"</span>\")),0!=d.length&&o.wrapAll(\"<td>\"),o.length){var g=o.parent();this.isParentRedactor(g)&&\"LI\"!=g[0].tagName&&this.nodeTestBlocks(g[0])&&g.replaceWith(g.contents())}this.browser(\"mozilla\")&&this.$editor.focus()}this.selectionRestore(),this.$editor.find(\"#selection-marker-1\").removeAttr(\"id\"),this.sync(),this.callback(\"execCommand\",t,e)},indentingIndent:function(){this.indentingStart(\"indent\")},indentingOutdent:function(){this.indentingStart(\"outdent\")},indentingStart:function(t){if(this.bufferSet(),\"indent\"===t){var e=this.getBlock();if(this.selectionSave(),e&&\"LI\"==e.tagName){var s=$(this.getParent()).closest(\"ol, ul\")[0].tagName,o=this.getBlocks();$.each(o,function(t,e){if(\"LI\"==e.tagName){var o=$(e).prev();if(0!=o.length&&\"LI\"==o[0].tagName){var r=o.children(\"ul, ol\");0==r.length?o.append($(\"<\"+s+\">\").append(e)):r.append(e)}}})}else if(!1===e&&!0===this.opts.linebreaks){this.exec(\"formatBlock\",\"blockquote\");var r=this.getBlock(),e=$('<div data-tagblock=\"\">').html($(r).html());$(r).replaceWith(e);var a=this.normalize($(e).css(\"margin-left\"))+this.opts.indentValue;$(e).css(\"margin-left\",a+\"px\")}else{var n=this.getBlocks();$.each(n,$.proxy(function(t,e){var s=!1;if(\"TD\"!==e.tagName){s=-1!==$.inArray(e.tagName,this.opts.alignmentTags)?$(e):$(e).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0]);var o=this.normalize(s.css(\"margin-left\"))+this.opts.indentValue;s.css(\"margin-left\",o+\"px\")}},this))}this.selectionRestore()}else{this.selectionSave();var e=this.getBlock();if(e&&\"LI\"==e.tagName){var o=this.getBlocks(),l=0;this.insideOutdent(e,l,o)}else{var n=this.getBlocks();$.each(n,$.proxy(function(t,e){var s=!1;s=-1!==$.inArray(e.tagName,this.opts.alignmentTags)?$(e):$(e).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0]);var o=this.normalize(s.css(\"margin-left\"))-this.opts.indentValue;o<=0?!0===this.opts.linebreaks&&void 0!==s.data(\"tagblock\")?s.replaceWith(s.html()+\"<br>\"):(s.css(\"margin-left\",\"\"),this.removeEmptyAttr(s,\"style\")):s.css(\"margin-left\",o+\"px\")},this))}this.selectionRestore()}this.sync()},insideOutdent:function(t,e,s){if(t&&\"LI\"==t.tagName){var o=$(t).parent().parent();0!=o.length&&\"LI\"==o[0].tagName?o.after(t):void 0!==s[e]?(t=s[e],e++,this.insideOutdent(t,e,s)):this.execCommand(\"insertunorderedlist\")}},alignmentLeft:function(){this.alignmentSet(\"\",\"JustifyLeft\")},alignmentRight:function(){this.alignmentSet(\"right\",\"JustifyRight\")},alignmentCenter:function(){this.alignmentSet(\"center\",\"JustifyCenter\")},alignmentJustify:function(){this.alignmentSet(\"justify\",\"JustifyFull\")},alignmentSet:function(t,e){if(this.bufferSet(),this.oldIE())return this.document.execCommand(e,!1,!1),!0;this.selectionSave();var s=this.getBlock();if(!s&&this.opts.linebreaks){this.exec(\"formatblock\",\"div\");var o=this.getBlock(),s=$('<div data-tagblock=\"\">').html($(o).html());$(o).replaceWith(s),$(s).css(\"text-align\",t),this.removeEmptyAttr(s,\"style\"),\"\"==t&&void 0!==$(s).data(\"tagblock\")&&$(s).replaceWith($(s).html())}else{var r=this.getBlocks();$.each(r,$.proxy(function(e,s){var o=!1;(o=-1!==$.inArray(s.tagName,this.opts.alignmentTags)?$(s):$(s).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0]))&&(o.css(\"text-align\",t),this.removeEmptyAttr(o,\"style\"))},this))}this.selectionRestore(),this.sync()},cleanEmpty:function(t){var e=this.placeholderStart(t);return!1!==e?e:(!1===this.opts.linebreaks&&(\"\"===t?t=this.opts.emptyHtml:-1!==t.search(/^<hr\\s?\\/?>$/gi)&&(t=\"<hr>\"+this.opts.emptyHtml)),t)},cleanConverters:function(t){return this.opts.convertDivs&&!this.opts.gallery&&(t=t.replace(/<div(.*?)>([\\w\\W]*?)<\\/div>/gi,\"<p$1>$2</p>\")),this.opts.paragraphy&&(t=this.cleanParagraphy(t)),t},cleanConvertProtected:function(t){return this.opts.templateVars&&(t=(t=t.replace(/\\{\\{(.*?)\\}\\}/gi,\"<!-- template double $1 -->\")).replace(/\\{(.*?)\\}/gi,\"<!-- template $1 -->\")),t=(t=(t=t.replace(/<script(.*?)>([\\w\\W]*?)<\\/script>/gi,'<title type=\"text/javascript\" style=\"display: none;\" class=\"redactor-script-tag\"$1>$2</title>')).replace(/<style(.*?)>([\\w\\W]*?)<\\/style>/gi,'<section$1 style=\"display: none;\" rel=\"redactor-style-tag\">$2</section>')).replace(/<form(.*?)>([\\w\\W]*?)<\\/form>/gi,'<section$1 rel=\"redactor-form-tag\">$2</section>'),t=this.opts.phpTags?t.replace(/<\\?php([\\w\\W]*?)\\?>/gi,'<section style=\"display: none;\" rel=\"redactor-php-tag\">$1</section>'):t.replace(/<\\?php([\\w\\W]*?)\\?>/gi,\"\")},cleanReConvertProtected:function(t){return this.opts.templateVars&&(t=(t=t.replace(/<!-- template double (.*?) -->/gi,\"{{$1}}\")).replace(/<!-- template (.*?) -->/gi,\"{$1}\")),t=(t=(t=t.replace(/<title type=\"text\\/javascript\" style=\"display: none;\" class=\"redactor-script-tag\"(.*?)>([\\w\\W]*?)<\\/title>/gi,'<script$1 type=\"text/javascript\">$2</script>')).replace(/<section(.*?) style=\"display: none;\" rel=\"redactor-style-tag\">([\\w\\W]*?)<\\/section>/gi,\"<style$1>$2</style>\")).replace(/<section(.*?)rel=\"redactor-form-tag\"(.*?)>([\\w\\W]*?)<\\/section>/gi,\"<form$1$2>$3</form>\"),this.opts.phpTags&&(t=t.replace(/<section style=\"display: none;\" rel=\"redactor-php-tag\">([\\w\\W]*?)<\\/section>/gi,\"<?php\\r\\n$1\\r\\n?>\")),t},cleanRemoveSpaces:function(t,e){if(!1!==e){var e=[],s=t.match(/<(code|style|script|title)(.*?)>([\\w\\W]*?)<\\/(code|style|script|title)>/gi);if(null===s&&(s=[]),this.opts.phpTags){var o=t.match(/<\\?php([\\w\\W]*?)\\?>/gi);o&&(s=$.merge(s,o))}s&&$.each(s,function(s,o){t=t.replace(o,\"buffer_\"+s),e.push(o)})}return t=(t=(t=(t=(t=(t=t.replace(/\\n/g,\" \")).replace(/[\\t]*/g,\"\")).replace(/\\n\\s*\\n/g,\"\\n\")).replace(/^[\\s\\n]*/g,\" \")).replace(/[\\s\\n]*$/g,\" \")).replace(/>\\s{2,}</g,\"> <\"),t=(t=this.cleanReplacer(t,e)).replace(/\\n\\n/g,\"\\n\")},cleanReplacer:function(t,e){return!1===e||$.each(e,function(e,s){t=t.replace(\"buffer_\"+e,s)}),t},cleanRemoveEmptyTags:function(t){t=t.replace(/[\\u200B-\\u200D\\uFEFF]/g,\"\");for(var e=[\"<b>\\\\s*</b>\",\"<b>&nbsp;</b>\",\"<em>\\\\s*</em>\"],s=[\"<code></code>\",\"<blockquote>\\\\s*</blockquote>\",\"<dd></dd>\",\"<dt></dt>\",\"<ul></ul>\",\"<ol></ol>\",\"<li></li>\",\"<table></table>\",\"<tr></tr>\",\"<span>\\\\s*<span>\",\"<span>&nbsp;<span>\",\"<p>\\\\s*</p>\",\"<p></p>\",\"<p>&nbsp;</p>\",\"<p>\\\\s*<br>\\\\s*</p>\",\"<div>\\\\s*</div>\",\"<div>\\\\s*<br>\\\\s*</div>\"],o=(s=this.opts.removeEmptyTags?s.concat(e):e).length,r=0;r<o;++r)t=t.replace(RegExp(s[r],\"gi\"),\"\");return t},cleanParagraphy:function(t){if(t=$.trim(t),!0===this.opts.linebreaks)return t;if(\"\"===t||\"<p></p>\"===t)return this.opts.emptyHtml;if(t+=\"\\n\",!1===this.opts.removeEmptyTags)return t;var e=[],s=t.match(/<(table|div|code|object)(.*?)>([\\w\\W]*?)<\\/(table|div|code|object)>/gi);s||(s=[]);var o=t.match(/<!--([\\w\\W]*?)-->/gi);if(o&&(s=$.merge(s,o)),this.opts.phpTags){var r=t.match(/<section(.*?)rel=\"redactor-php-tag\">([\\w\\W]*?)<\\/section>/gi);r&&(s=$.merge(s,r))}function a(e,s,o){return t.replace(RegExp(e,s),o)}s&&$.each(s,function(s,o){e[s]=o,t=t.replace(o,\"{replace\"+s+\"}\\n\")}),t=(t=t.replace(/<br \\/>\\s*<br \\/>/gi,\"\\n\\n\")).replace(/<br><br>/gi,\"\\n\\n\");var n=\"(comment|html|body|head|title|meta|style|script|link|iframe|table|thead|tfoot|caption|col|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|code|select|option|form|map|area|blockquote|address|math|style|p|h[1-6]|hr|fieldset|legend|section|article|aside|hgroup|header|footer|nav|figure|figcaption|details|menu|summary)\";t=a(\"(<\"+n+\"[^>]*>)\",\"gi\",\"\\n$1\"),t=a(\"(</\"+n+\">)\",\"gi\",\"$1\\n\\n\"),t=a(\"\\r\\n\",\"g\",\"\\n\"),t=a(\"\\r\",\"g\",\"\\n\");var l=(t=a(\"/\\n\\n+/\",\"g\",\"\\n\\n\")).split(RegExp(\"\\ns*\\n\",\"g\"),-1);for(var c in t=\"\",l)l.hasOwnProperty(c)&&(-1==l[c].search(\"{replace\")?(l[c]=l[c].replace(/<p>\\n\\t?<\\/p>/gi,\"\"),l[c]=l[c].replace(/<p><\\/p>/gi,\"\"),\"\"!=l[c]&&(t+=\"<p>\"+l[c].replace(/^\\n+|\\n+$/g,\"\")+\"</p>\")):t+=l[c]);return t=a(\"<p><p>\",\"gi\",\"<p>\"),t=a(\"</p></p>\",\"gi\",\"</p>\"),t=a(\"<p>s?</p>\",\"gi\",\"\"),t=a(\"<p>([^<]+)</(div|address|form)>\",\"gi\",\"<p>$1</p></$2>\"),t=a(\"<p>(</?\"+n+\"[^>]*>)</p>\",\"gi\",\"$1\"),t=a(\"<p>(<li.+?)</p>\",\"gi\",\"$1\"),t=a(\"<p>s?(</?\"+n+\"[^>]*>)\",\"gi\",\"$1\"),t=a(\"(</?\"+n+\"[^>]*>)s?</p>\",\"gi\",\"$1\"),t=a(\"(</?\"+n+\"[^>]*>)s?<br />\",\"gi\",\"$1\"),t=a(\"<br />(s*</?(?:p|li|div|dl|dd|dt|th|code|td|ul|ol)[^>]*>)\",\"gi\",\"$1\"),t=a(\"\\n</p>\",\"gi\",\"</p>\"),t=a(\"<li><p>\",\"gi\",\"<li>\"),t=a(\"</p></li>\",\"gi\",\"</li>\"),t=a(\"</li><p>\",\"gi\",\"</li>\"),t=a(\"<p>\t?\\n?<p>\",\"gi\",\"<p>\"),t=a(\"</dt><p>\",\"gi\",\"</dt>\"),t=a(\"</dd><p>\",\"gi\",\"</dd>\"),t=a(\"<br></p></blockquote>\",\"gi\",\"</blockquote>\"),t=a(\"<p>\t*</p>\",\"gi\",\"\"),$.each(e,function(e,s){t=t.replace(\"{replace\"+e+\"}\",s)}),$.trim(t)},cleanConvertInlineTags:function(t,e){var s=\"strong\";\"b\"===this.opts.boldTag&&(s=\"b\");var o=\"em\";return\"i\"===this.opts.italicTag&&(o=\"i\"),t=(t=t.replace(/<span style=\"font-style: italic;\">([\\w\\W]*?)<\\/span>/gi,\"<\"+o+\">$1</\"+o+\">\")).replace(/<span style=\"font-weight: bold;\">([\\w\\W]*?)<\\/span>/gi,\"<\"+s+\">$1</\"+s+\">\"),t=\"strong\"===this.opts.boldTag?t.replace(/<b>([\\w\\W]*?)<\\/b>/gi,\"<strong>$1</strong>\"):t.replace(/<strong>([\\w\\W]*?)<\\/strong>/gi,\"<b>$1</b>\"),t=(t=\"em\"===this.opts.italicTag?t.replace(/<i>([\\w\\W]*?)<\\/i>/gi,\"<em>$1</em>\"):t.replace(/<em>([\\w\\W]*?)<\\/em>/gi,\"<i>$1</i>\")).replace(/<span style=\"text-decoration: underline;\">([\\w\\W]*?)<\\/span>/gi,\"<u>$1</u>\"),t=!0!==e?t.replace(/<strike>([\\w\\W]*?)<\\/strike>/gi,\"<del>$1</del>\"):t.replace(/<del>([\\w\\W]*?)<\\/del>/gi,\"<strike>$1</strike>\")},cleanStripTags:function(t){if(\"\"==t||void 0===t)return t;var e=!1;!1!==this.opts.allowedTags&&(e=!0);var s=!0===e?this.opts.allowedTags:this.opts.deniedTags,o=/<\\/?([a-z][a-z0-9]*)\\b[^>]*>/gi;return t=t.replace(o,function(t,o){return!0===e?$.inArray(o.toLowerCase(),s)>\"-1\"?t:\"\":$.inArray(o.toLowerCase(),s)>\"-1\"?\"\":t}),t=this.cleanConvertInlineTags(t)},cleanSavePreCode:function(t,e){var s=t.match(/<(pre|code)(.*?)>([\\w\\W]*?)<\\/(pre|code)>/gi);return null!==s&&$.each(s,$.proxy(function(s,o){var r=o.match(/<(pre|code)(.*?)>([\\w\\W]*?)<\\/(pre|code)>/i);r[3]=r[3].replace(/&nbsp;/g,\" \"),!1!==e&&(r[3]=this.cleanEncodeEntities(r[3])),r[3]=r[3].replace(/\\$/g,\"&#36;\"),t=t.replace(o,\"<\"+r[1]+r[2]+\">\"+r[3]+\"</\"+r[1]+\">\")},this)),t},cleanEncodeEntities:function(t){return(t=String(t).replace(/&amp;/g,\"&\").replace(/&lt;/g,\"<\").replace(/&gt;/g,\">\").replace(/&quot;/g,'\"')).replace(/&/g,\"&amp;\").replace(/</g,\"&lt;\").replace(/>/g,\"&gt;\").replace(/\"/g,\"&quot;\")},cleanUnverified:function(){var t=this.$editor.find(\"li, img, a, b, strong, sub, sup, i, em, u, small, strike, del, span, cite\");t.filter('[style*=\"background-color: transparent;\"][style*=\"line-height\"]').css(\"background-color\",\"\").css(\"line-height\",\"\"),t.filter('[style*=\"background-color: transparent;\"]').css(\"background-color\",\"\"),t.css(\"line-height\",\"\"),$.each(t,$.proxy(function(t,e){this.removeEmptyAttr(e,\"style\")},this));var e=this.$editor.find(\"b, strong, i, em, u, strike, del\");e.css(\"font-size\",\"\"),$.each(e,$.proxy(function(t,e){this.removeEmptyAttr(e,\"style\")},this)),this.$editor.find('div[style=\"text-align: -webkit-auto;\"]').contents().unwrap(),this.$editor.find(\"ul, ol, li\").removeAttr(\"style\")},cleanHtml:function(t){var e,s=0,o=t.length,r=0,a=null,n=null,l=\"\",c=\"\",h=\"\";for(this.cleanlevel=0;s<o;s++){if(r=s,-1==t.substr(s).indexOf(\"<\")){c+=t.substr(s);break}for(;r<o&&\"<\"!=t.charAt(r);)r++;for(s!=r&&((h=t.substr(s,r-s)).match(/^\\s{2,}$/g)||(\"\\n\"==c.charAt(c.length-1)?c+=this.cleanGetTabs():\"\\n\"==h.charAt(0)&&(c+=\"\\n\"+this.cleanGetTabs(),h=h.replace(/^\\s+/,\"\")),c+=h),h.match(/\\n/)&&(c+=\"\\n\"+this.cleanGetTabs())),a=r;r<o&&\">\"!=t.charAt(r);)r++;if(l=t.substr(a,r-a),s=r,\"!--\"==l.substr(1,3)){if(!l.match(/--$/)){for(;\"-->\"!=t.substr(r,3);)r++;r+=2,l=t.substr(a,r-a),s=r}\"\\n\"!=c.charAt(c.length-1)&&(c+=\"\\n\"),c+=this.cleanGetTabs(),c+=l+\">\\n\"}else\"!\"==l[1]?c=this.placeTag(l+\">\",c):\"?\"==l[1]?c+=l+\">\\n\":(e=l.match(/^<(script|style|pre|code)/i))?(e[1]=e[1].toLowerCase(),l=this.cleanTag(l),c=this.placeTag(l,c),(n=String(t.substr(s+1)).toLowerCase().indexOf(\"</\"+e[1]))&&(h=t.substr(s+1,n),s+=n,c+=h)):(l=this.cleanTag(l),c=this.placeTag(l,c))}return this.cleanFinish(c)},cleanGetTabs:function(){for(var t=\"\",e=0;e<this.cleanlevel;e++)t+=\"\t\";return t},cleanFinish:function(t){return t=(t=(t=(t=t.replace(/\\n\\s*\\n/g,\"\\n\")).replace(/^[\\s\\n]*/,\"\")).replace(/[\\s\\n]*$/,\"\")).replace(/<script(.*?)>\\n<\\/script>/gi,\"<script$1></script>\"),this.cleanlevel=0,t},cleanTag:function(t){var e,s=\"\";t=(t=(t=t.replace(/\\n/g,\" \")).replace(/\\s{2,}/g,\" \")).replace(/^\\s+|\\s+$/g,\" \");var o=\"\";for(t.match(/\\/$/)&&(o=\"/\",t=t.replace(/\\/+$/,\"\"));e=/\\s*([^= ]+)(?:=((['\"']).*?\\3|[^ ]+))?/.exec(t);)e[2]?s+=e[1].toLowerCase()+\"=\"+e[2]:e[1]&&(s+=e[1].toLowerCase()),s+=\" \",t=t.substr(e[0].length);return s.replace(/\\s*$/,\"\")+o+\">\"},placeTag:function(t,e){var s=t.match(this.cleannewLevel);return(t.match(this.cleanlineBefore)||s)&&(e=e.replace(/\\s*$/,\"\"),e+=\"\\n\"),s&&\"/\"==t.charAt(1)&&this.cleanlevel--,\"\\n\"==e.charAt(e.length-1)&&(e+=this.cleanGetTabs()),s&&\"/\"!=t.charAt(1)&&this.cleanlevel++,e+=t,(t.match(this.cleanlineAfter)||t.match(this.cleannewLevel))&&(e=e.replace(/ *$/,\"\"),e+=\"\\n\"),e},formatEmpty:function(t){var e=$.trim(this.$editor.html());if(this.opts.linebreaks)\"\"==e&&(t.preventDefault(),this.$editor.html(\"\"),this.focus());else{var s=(e=e.replace(/<br\\s?\\/?>/i,\"\")).replace(/<p>\\s?<\\/p>/gi,\"\");if(\"\"===e||\"\"===s){t.preventDefault();var o=$(this.opts.emptyHtml).get(0);this.$editor.html(o),this.focus()}}this.sync()},formatBlocks:function(t){this.browser(\"mozilla\")&&this.isFocused()&&this.$editor.focus(),this.bufferSet();var e=this.getBlocks();this.selectionSave(),$.each(e,$.proxy(function(e,s){if(\"LI\"!==s.tagName){var o=$(s).parent();if(\"p\"===t){if(\"P\"===s.tagName&&0!=o.length&&\"BLOCKQUOTE\"===o[0].tagName||\"BLOCKQUOTE\"===s.tagName){this.formatQuote();return}if(this.opts.linebreaks){if(!s||0!=s.tagName.search(/H[1-6]/))return;$(s).replaceWith(s.innerHTML+\"<br>\")}else this.formatBlock(t,s)}else this.formatBlock(t,s)}},this)),this.selectionRestore(),this.sync()},formatBlock:function(t,e){if(!1===e&&(e=this.getBlock()),!1===e&&!0===this.opts.linebreaks)return this.execCommand(\"formatblock\",t),!0;var s=\"\";if(\"code\"!==t?s=$(e).contents():(s=$(e).html(),\"\"===$.trim(s)&&(s='<span id=\"selection-marker-1\"></span>')),\"CODE\"===e.tagName&&(t=\"p\"),!0===this.opts.linebreaks&&\"p\"===t)$(e).replaceWith($(\"<div>\").append(s).html()+\"<br>\");else{var o=this.getParent(),r=$(\"<\"+t+\">\").append(s);$(e).replaceWith(r),o&&\"TD\"==o.tagName&&$(r).wrapAll(\"<td>\")}},formatChangeTag:function(t,e,s){!1!==s&&this.selectionSave();var o=$(\"<\"+e+\"/>\");return $(t).replaceWith(function(){return o.append($(this).contents())}),!1!==s&&this.selectionRestore(),o},formatQuote:function(){if(this.browser(\"mozilla\")&&this.isFocused()&&this.$editor.focus(),this.bufferSet(),!1===this.opts.linebreaks){this.selectionSave();var t=this.getBlocks(),e=!1,s=t.length;if(t){var o=\"\",r=\"\",a=!1,n=!0;if($.each(t,function(t,e){\"P\"!==e.tagName&&(n=!1)}),$.each(t,$.proxy(function(l,c){if(\"BLOCKQUOTE\"===c.tagName)this.formatBlock(\"p\",c,!1);else if(\"P\"===c.tagName){if(\"BLOCKQUOTE\"==(e=$(c).parent())[0].tagName){var h=$(e).children(\"p\").length;1==h?$(e).replaceWith(c):h==s?(a=\"blockquote\",o+=this.outerHtml(c)):(a=\"html\",o+=this.outerHtml(c),0==l?($(c).addClass(\"redactor-replaced\").empty(),r=this.outerHtml(c)):$(c).remove())}else!1===n||1==t.length?this.formatBlock(\"blockquote\",c,!1):(a=\"paragraphs\",o+=this.outerHtml(c))}else\"LI\"!==c.tagName&&this.formatBlock(\"blockquote\",c,!1)},this)),a){if(\"paragraphs\"==a)$(t[0]).replaceWith(\"<blockquote>\"+o+\"</blockquote>\"),$(t).remove();else if(\"blockquote\"==a)$(e).replaceWith(o);else if(\"html\"==a){var l=this.$editor.html().replace(r,\"</blockquote>\"+o+\"<blockquote>\");this.$editor.html(l),this.$editor.find(\"blockquote\").each(function(){\"\"==$.trim($(this).html())&&$(this).remove()})}}}this.selectionRestore()}else{var c=this.getBlock();if(\"BLOCKQUOTE\"===c.tagName){this.selectionSave();var l=$.trim($(c).html()),h=$.trim(this.getSelectionHtml());if((l=l.replace(/<span(.*?)id=\"selection-marker(.*?)<\\/span>/gi,\"\"))==h)$(c).replaceWith($(c).html()+\"<br>\");else{this.inlineFormat(\"tmp\");var d=this.$editor.find(\"tmp\");d.empty();var p=this.$editor.html().replace(\"<tmp></tmp>\",'</blockquote><span id=\"selection-marker-1\">'+this.opts.invisibleSpace+\"</span>\"+h+\"<blockquote>\");this.$editor.html(p),d.remove(),this.$editor.find(\"blockquote\").each(function(){\"\"==$.trim($(this).html())&&$(this).remove()})}this.selectionRestore(),this.$editor.find(\"span#selection-marker-1\").attr(\"id\",!1)}else{var u=this.selectionWrap(\"blockquote\"),l=$(u).html(),f=[\"ul\",\"ol\",\"table\",\"tr\",\"tbody\",\"thead\",\"tfoot\",\"dl\"];$.each(f,function(t,e){l=(l=l.replace(RegExp(\"<\"+e+\"(.*?)>\",\"gi\"),\"\")).replace(RegExp(\"</\"+e+\">\",\"gi\"),\"\")});var m=this.opts.blockLevelElements;$.each(m,function(t,e){l=(l=l.replace(RegExp(\"<\"+e+\"(.*?)>\",\"gi\"),\"\")).replace(RegExp(\"</\"+e+\">\",\"gi\"),\"<br>\")}),$(u).html(l),this.selectionElement(u);var g=$(u).next();0!=g.length&&\"BR\"===g[0].tagName&&g.remove()}}this.sync()},blockRemoveAttr:function(t,e){$(this.getBlocks()).removeAttr(t),this.sync()},blockSetAttr:function(t,e){$(this.getBlocks()).attr(t,e),this.sync()},blockRemoveStyle:function(t){var e=this.getBlocks();$(e).css(t,\"\"),this.removeEmptyAttr(e,\"style\"),this.sync()},blockSetStyle:function(t,e){$(this.getBlocks()).css(t,e),this.sync()},blockRemoveClass:function(t){var e=this.getBlocks();$(e).removeClass(t),this.removeEmptyAttr(e,\"class\"),this.sync()},blockSetClass:function(t){$(this.getBlocks()).addClass(t),this.sync()},inlineRemoveClass:function(t){this.selectionSave(),this.inlineEachNodes(function(e){$(e).removeClass(t),this.removeEmptyAttr(e,\"class\")}),this.selectionRestore(),this.sync()},inlineSetClass:function(t){$(this.getCurrent()).hasClass(t)||this.inlineMethods(\"addClass\",t)},inlineRemoveStyle:function(t){this.selectionSave(),this.inlineEachNodes(function(e){$(e).css(t,\"\"),this.removeEmptyAttr(e,\"style\")}),this.selectionRestore(),this.sync()},inlineSetStyle:function(t,e){this.inlineMethods(\"css\",t,e)},inlineRemoveAttr:function(t){this.selectionSave();var e=this.getRange(),s=this.getElement(),o=this.getNodes();(e.collapsed||e.startContainer===e.endContainer&&s)&&(o=$(s)),$(o).removeAttr(t),this.inlineUnwrapSpan(),this.selectionRestore(),this.sync()},inlineSetAttr:function(t,e){this.inlineMethods(\"attr\",t,e)},inlineMethods:function(t,e,s){this.bufferSet(),this.selectionSave();var o=this.getRange(),r=this.getElement();if((o.collapsed||o.startContainer===o.endContainer)&&r&&!this.nodeTestBlocks(r))$(r)[t](e,s);else{var a,n=s;switch(e){case\"font-size\":a=\"fontSize\",n=4;break;case\"font-family\":a=\"fontName\";break;case\"color\":a=\"foreColor\";break;case\"background-color\":a=\"backColor\"}this.document.execCommand(a,!1,n);var l=this.$editor.find(\"font\");$.each(l,$.proxy(function(o,r){this.inlineSetMethods(t,r,e,s)},this))}this.selectionRestore(),this.sync()},inlineSetMethods:function(t,e,s,o){var r,a=$(e).parent(),n=this.getSelectionText(),l=$(a).text();return n==l&&a&&\"INLINE\"===a[0].tagName&&0!=a[0].attributes.length?(r=a,$(e).replaceWith($(e).html())):(r=$(\"<inline>\").append($(e).contents()),$(e).replaceWith(r)),$(r)[t](s,o),r},inlineEachNodes:function(t){var e,s=this.getRange(),o=this.getElement(),r=this.getNodes();(s.collapsed||s.startContainer===s.endContainer&&o)&&(r=$(o),e=!0),$.each(r,$.proxy(function(s,o){if(!e&&\"INLINE\"!==o.tagName){var r=this.getSelectionText(),a=$(o).parent().text();if(r!=a||\"INLINE\"!==o.parentNode.tagName||$(o.parentNode).hasClass(\"redactor_editor\"))return;o=o.parentNode}t.call(this,o)},this))},inlineUnwrapSpan:function(){var t=this.$editor.find(\"inline\");$.each(t,$.proxy(function(t,e){var s=$(e);void 0===s.attr(\"class\")&&void 0===s.attr(\"style\")&&s.contents().unwrap()},this))},inlineFormat:function(t){this.selectionSave(),this.document.execCommand(\"fontSize\",!1,4);var e,s=this.$editor.find(\"font\");$.each(s,function(s,o){var r=$(\"<\"+t+\"/>\").append($(o).contents());$(o).replaceWith(r),e=r}),this.selectionRestore(),this.sync()},inlineRemoveFormat:function(t){this.selectionSave();var e=t.toUpperCase(),s=this.getNodes(),o=$(this.getParent()).parent();$.each(s,function(t,s){s.tagName===e&&this.inlineRemoveFormatReplace(s)}),o&&o[0].tagName===e&&this.inlineRemoveFormatReplace(o),this.selectionRestore(),this.sync()},inlineRemoveFormatReplace:function(t){$(t).replaceWith($(t).contents())},insertHtml:function(t,e){var s=this.getCurrent(),o=s.parentNode;this.focusWithSaveScroll(),this.bufferSet();var r=$(\"<div>\").append($.parseHTML(t));t=r.html(),t=this.cleanRemoveEmptyTags(t),r=$(\"<div>\").append($.parseHTML(t));var a=this.getBlock();if(1==r.contents().length){var n=r.contents()[0].tagName;(\"P\"!=n&&n==a.tagName||\"CODE\"==n)&&(r=$(\"<div>\").append(t))}this.opts.linebreaks&&(t=t.replace(/<p(.*?)>([\\w\\W]*?)<\\/p>/gi,\"$2<br>\")),this.opts.linebreaks||1!=r.contents().length||3!=r.contents()[0].nodeType||!(this.getRangeSelectedNodes().length>2)&&s&&(\"BODY\"!=s.tagName||o)&&\"HTML\"!=o.tagName||(t=\"<p>\"+t+\"</p>\"),t=this.setSpansVerifiedHtml(t),r.contents().length>1&&a||r.contents().is(\"p, :header, ul, ol, li, div, table, td, blockquote, code, address, section, header, footer, aside, article\")?this.browser(\"msie\")?this.isIe11()?this.execPasteFrag(t):this.document.selection.createRange().pasteHTML(t):this.document.execCommand(\"inserthtml\",!1,t):this.insertHtmlAdvanced(t,!1),this.selectall&&this.window.setTimeout($.proxy(function(){this.opts.linebreaks?this.focusEnd():this.selectionEnd(this.$editor.contents().last())},this),1),this.observeStart(),this.setNonEditable(),!1!==e&&this.sync()},insertHtmlAdvanced:function(t,e){t=this.setSpansVerifiedHtml(t);var s=this.getSelection();if(s.getRangeAt&&s.rangeCount){var o=s.getRangeAt(0);o.deleteContents();var r=document.createElement(\"div\");r.innerHTML=t;for(var a,n,l=document.createDocumentFragment();a=r.firstChild;)n=l.appendChild(a);o.insertNode(l),n&&((o=o.cloneRange()).setStartAfter(n),o.collapse(!0),s.removeAllRanges(),s.addRange(o))}!1!==e&&this.sync()},insertBeforeCursor:function(t){t=this.setSpansVerifiedHtml(t);var e=$(t),s=document.createElement(\"span\");s.innerHTML=\"\u200b\";var o=this.getRange();o.insertNode(s),o.insertNode(e[0]),o.collapse(!1);var r=this.getSelection();r.removeAllRanges(),r.addRange(o),this.sync()},insertText:function(t){var e=$($.parseHTML(t));e.length&&(t=e.text()),this.focusWithSaveScroll(),this.browser(\"msie\")?this.isIe11()?this.execPasteFrag(t):this.document.selection.createRange().pasteHTML(t):this.document.execCommand(\"inserthtml\",!1,t),this.sync()},insertNode:function(t){if(\"SPAN\"==(t=t[0]||t).tagName){var e=\"inline\",s=t.outerHTML,o=RegExp(\"<\"+t.tagName,\"i\"),r=s.replace(o,\"<\"+e);o=RegExp(\"</\"+t.tagName,\"i\"),r=r.replace(o,\"</\"+e),t=$(r)[0]}var a=this.getSelection();return a.getRangeAt&&a.rangeCount&&((range=a.getRangeAt(0)).deleteContents(),range.insertNode(t),range.setEndAfter(t),range.setStartAfter(t),a.removeAllRanges(),a.addRange(range)),t},insertNodeToCaretPositionFromPoint:function(t,e){var s,o=t.clientX,r=t.clientY;if(this.document.caretPositionFromPoint){var a=this.document.caretPositionFromPoint(o,r);(s=this.getRange()).setStart(a.offsetNode,a.offset),s.collapse(!0),s.insertNode(e)}else if(this.document.caretRangeFromPoint)(s=this.document.caretRangeFromPoint(o,r)).insertNode(e);else if(void 0!==document.body.createTextRange){(s=this.document.body.createTextRange()).moveToPoint(o,r);var n=s.duplicate();n.moveToPoint(o,r),s.setEndPoint(\"EndToEnd\",n),s.select()}},insertAfterLastElement:function(t,e){if(void 0!==e&&(t=e),this.isEndOfElement()){if(this.opts.linebreaks){var s=$(\"<div>\").append($.trim(this.$editor.html())).contents(),o=s.last()[0];if(\"SPAN\"==o.tagName&&\"\"==o.innerHTML&&(o=s.prev()[0]),this.outerHtml(o)!=this.outerHtml(t))return!1}else if(this.$editor.contents().last()[0]!==t)return!1;this.insertingAfterLastElement(t)}},insertingAfterLastElement:function(t){if(this.bufferSet(),!1===this.opts.linebreaks){var e=$(this.opts.emptyHtml);$(t).after(e),this.selectionStart(e)}else{var e=$('<span id=\"selection-marker-1\">'+this.opts.invisibleSpace+\"</span>\",this.document)[0];$(t).after(e),$(e).after(this.opts.invisibleSpace),this.selectionRestore(),this.$editor.find(\"span#selection-marker-1\").removeAttr(\"id\")}},insertLineBreak:function(t){this.selectionSave();var e=\"<br>\";if(!0==t&&(e=\"<br><br>\"),this.browser(\"mozilla\")){var s=$(\"<span>\").html(this.opts.invisibleSpace);this.$editor.find(\"#selection-marker-1\").before(e).before(s).before(this.opts.invisibleSpace),this.setCaretAfter(s[0]),s.remove(),this.selectionRemoveMarkers()}else{var o=this.getParent();if(o&&\"A\"===o.tagName){var r=this.getCaretOffset(o),a=$.trim($(o).text()).replace(/\\n\\r\\n/g,\"\").length;if(r==a){this.selectionRemoveMarkers();var n=$('<span id=\"selection-marker-1\">'+this.opts.invisibleSpace+\"</span>\",this.document)[0];return $(o).after(n),$(n).before(e+(this.browser(\"webkit\")?this.opts.invisibleSpace:\"\")),this.selectionRestore(),!0}}this.$editor.find(\"#selection-marker-1\").before(e+(this.browser(\"webkit\")?this.opts.invisibleSpace:\"\")),this.selectionRestore()}},insertDoubleLineBreak:function(){this.insertLineBreak(!0)},replaceLineBreak:function(t){var e=$(\"<br>\"+this.opts.invisibleSpace);$(t).replaceWith(e),this.selectionStart(e)},pasteClean:function(t){if(t=this.callback(\"pasteBefore\",!1,t),this.browser(\"msie\")){var e=$.trim(t);0==e.search(/^<a(.*?)>(.*?)<\\/a>$/i)&&(t=t.replace(/^<a(.*?)>(.*?)<\\/a>$/i,\"$2\"))}if(t=t.replace(/on([a-z]+)=|javascript\\:/gi,\"\"),this.opts.pastePlainText){var e=this.document.createElement(\"div\");return t=t.replace(/<br>|<\\/H[1-6]>|<\\/p>|<\\/div>/gi,\"\\n\"),e.innerHTML=t,t=e.textContent||e.innerText,t=(t=$.trim(t)).replace(\"\\n\",\"<br>\"),t=this.cleanParagraphy(t),this.pasteInsert(t),!1}var s=!1;if(this.currentOrParentIs(\"TD\")){s=!0;var o=this.opts.blockLevelElements;o.push(\"tr\"),o.push(\"table\"),$.each(o,function(e,s){t=(t=t.replace(RegExp(\"<\"+s+\"(.*?)>\",\"gi\"),\"\")).replace(RegExp(\"</\"+s+\">\",\"gi\"),\"<br>\")})}if(this.currentOrParentIs(\"CODE\"))return t=this.pastePre(t),this.pasteInsert(t),!0;if(t=(t=(t=(t=(t=(t=(t=t.replace(/<img(.*?)v:shapes=(.*?)>/gi,\"\")).replace(/<p(.*?)class=\"MsoListParagraphCxSpFirst\"([\\w\\W]*?)<\\/p>/gi,\"<ul><li$2</li>\")).replace(/<p(.*?)class=\"MsoListParagraphCxSpMiddle\"([\\w\\W]*?)<\\/p>/gi,\"<li$2</li>\")).replace(/<p(.*?)class=\"MsoListParagraphCxSpLast\"([\\w\\W]*?)<\\/p>/gi,\"<li$2</li></ul>\")).replace(/<p(.*?)class=\"MsoListParagraph\"([\\w\\W]*?)<\\/p>/gi,\"<ul><li$2</li></ul>\")).replace(/\u00b7/g,\"\")).replace(/<!--[\\s\\S]*?-->|<\\?(?:php)?[\\s\\S]*?\\?>/gi,\"\"),!0===this.opts.cleanSpaces&&(t=(t=t.replace(/(&nbsp;){2,}/gi,\"&nbsp;\")).replace(/&nbsp;/gi,\" \")),t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=t.replace(/<b\\sid=\"internal-source-marker(.*?)\">([\\w\\W]*?)<\\/b>/gi,\"$2\")).replace(/<b(.*?)id=\"docs-internal-guid(.*?)\">([\\w\\W]*?)<\\/b>/gi,\"$3\")).replace(/<span[^>]*(font-style: italic; font-weight: bold|font-weight: bold; font-style: italic)[^>]*>/gi,'<span style=\"font-weight: bold;\"><span style=\"font-style: italic;\">')).replace(/<span[^>]*font-style: italic[^>]*>/gi,'<span style=\"font-style: italic;\">')).replace(/<span[^>]*font-weight: bold[^>]*>/gi,'<span style=\"font-weight: bold;\">')).replace(/<span[^>]*text-decoration: underline[^>]*>/gi,'<span style=\"text-decoration: underline;\">')).replace(/<td>\\u200b*<\\/td>/gi,\"[td]\")).replace(/<td>&nbsp;<\\/td>/gi,\"[td]\")).replace(/<td><br><\\/td>/gi,\"[td]\")).replace(/<td(.*?)colspan=\"(.*?)\"(.*?)>([\\w\\W]*?)<\\/td>/gi,'[td colspan=\"$2\"]$4[/td]')).replace(/<td(.*?)rowspan=\"(.*?)\"(.*?)>([\\w\\W]*?)<\\/td>/gi,'[td rowspan=\"$2\"]$4[/td]')).replace(/<a(.*?)href=\"(.*?)\"(.*?)>([\\w\\W]*?)<\\/a>/gi,'[a href=\"$2\"]$4[/a]')).replace(/<iframe(.*?)>([\\w\\W]*?)<\\/iframe>/gi,\"[iframe$1]$2[/iframe]\")).replace(/<video(.*?)>([\\w\\W]*?)<\\/video>/gi,\"[video$1]$2[/video]\")).replace(/<audio(.*?)>([\\w\\W]*?)<\\/audio>/gi,\"[audio$1]$2[/audio]\")).replace(/<embed(.*?)>([\\w\\W]*?)<\\/embed>/gi,\"[embed$1]$2[/embed]\")).replace(/<object(.*?)>([\\w\\W]*?)<\\/object>/gi,\"[object$1]$2[/object]\")).replace(/<param(.*?)>/gi,\"[param$1]\")).replace(/<img(.*?)>/gi,\"[img$1]\")).replace(/ class=\"(.*?)\"/gi,\"\")).replace(/<(\\w+)([\\w\\W]*?)>/gi,\"<$1>\"),this.opts.linebreaks?(t=(t=t.replace(/<strong><\\/strong>/gi,\"\")).replace(/<u><\\/u>/gi,\"\"),this.opts.cleanFontTag&&(t=t.replace(/<font(.*?)>([\\w\\W]*?)<\\/font>/gi,\"$2\")),t=t.replace(/<[^\\/>][^>]*>(\\s*|\\t*|\\n*|&nbsp;|<br>)<\\/[^>]+>/gi,\"<br>\")):t=t.replace(/<[^\\/>][^>]*>(\\s*|\\t*|\\n*|&nbsp;|<br>)<\\/[^>]+>/gi,\"\"),t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=t.replace(/<div>\\s*?\\t*?\\n*?(<ul>|<ol>|<p>)/gi,\"$1\")).replace(/\\[td colspan=\"(.*?)\"\\]([\\w\\W]*?)\\[\\/td\\]/gi,'<td colspan=\"$1\">$2</td>')).replace(/\\[td rowspan=\"(.*?)\"\\]([\\w\\W]*?)\\[\\/td\\]/gi,'<td rowspan=\"$1\">$2</td>')).replace(/\\[td\\]/gi,\"<td>&nbsp;</td>\")).replace(/\\[a href=\"(.*?)\"\\]([\\w\\W]*?)\\[\\/a\\]/gi,'<a href=\"$1\">$2</a>')).replace(/\\[iframe(.*?)\\]([\\w\\W]*?)\\[\\/iframe\\]/gi,\"<iframe$1>$2</iframe>\")).replace(/\\[video(.*?)\\]([\\w\\W]*?)\\[\\/video\\]/gi,\"<video$1>$2</video>\")).replace(/\\[audio(.*?)\\]([\\w\\W]*?)\\[\\/audio\\]/gi,\"<audio$1>$2</audio>\")).replace(/\\[embed(.*?)\\]([\\w\\W]*?)\\[\\/embed\\]/gi,\"<embed$1>$2</embed>\")).replace(/\\[object(.*?)\\]([\\w\\W]*?)\\[\\/object\\]/gi,\"<object$1>$2</object>\")).replace(/\\[param(.*?)\\]/gi,\"<param$1>\")).replace(/\\[img(.*?)\\]/gi,\"<img$1>\"),t=this.opts.convertDivs?(t=(t=(t=t.replace(/<div(.*?)>([\\w\\W]*?)<\\/div>/gi,\"<p>$2</p>\")).replace(/<\\/div><p>/gi,\"<p>\")).replace(/<\\/p><\\/div>/gi,\"</p>\")).replace(/<p><\\/p>/gi,\"<br />\"):t.replace(/<div><\\/div>/gi,\"<br />\"),t=this.cleanStripTags(t),this.currentOrParentIs(\"LI\")?t=t.replace(/<p>([\\w\\W]*?)<\\/p>/gi,\"$1<br>\"):!1===s&&(t=this.cleanParagraphy(t)),t=(t=(t=(t=(t=(t=(t=(t=t.replace(/<span(.*?)>([\\w\\W]*?)<\\/span>/gi,\"$2\")).replace(/<img>/gi,\"\")).replace(/<[^\\/>][^>][^img|param|source|td][^<]*>(\\s*|\\t*|\\n*| |<br>)<\\/[^>]+>/gi,\"\")).replace(/\\n{3,}/gi,\"\\n\")).replace(/<p><p>/gi,\"<p>\")).replace(/<\\/p><\\/p>/gi,\"</p>\")).replace(/<li>(\\s*|\\t*|\\n*)<p>/gi,\"<li>\")).replace(/<\\/p>(\\s*|\\t*|\\n*)<\\/li>/gi,\"</li>\"),!0===this.opts.linebreaks&&(t=t.replace(/<p(.*?)>([\\w\\W]*?)<\\/p>/gi,\"$2<br>\")),t=(t=(t=t.replace(/<[^\\/>][^>][^img|param|source|td][^<]*>(\\s*|\\t*|\\n*| |<br>)<\\/[^>]+>/gi,\"\")).replace(/<img src=\"webkit-fake-url\\:\\/\\/(.*?)\"(.*?)>/gi,\"\")).replace(/<td(.*?)>(\\s*|\\t*|\\n*)<p>([\\w\\W]*?)<\\/p>(\\s*|\\t*|\\n*)<\\/td>/gi,\"<td$1>$3</td>\"),this.opts.convertDivs&&(t=(t=t.replace(/<div(.*?)>([\\w\\W]*?)<\\/div>/gi,\"$2\")).replace(/<div(.*?)>([\\w\\W]*?)<\\/div>/gi,\"$2\")),this.pasteClipboardMozilla=!1,this.browser(\"mozilla\")){if(this.opts.clipboardUpload){var r=t.match(/<img src=\"data:image(.*?)\"(.*?)>/gi);if(null!==r)for(var a in this.pasteClipboardMozilla=r,r){var n=r[a].replace(\"<img\",'<img data-mozilla-paste-image=\"'+a+'\" ');t=t.replace(r[a],n)}}for(;/<br>$/gi.test(t);)t=t.replace(/<br>$/gi,\"\")}if(t=t.replace(/<p>\u2022([\\w\\W]*?)<\\/p>/gi,\"<li>$1</li>\"),this.browser(\"msie\"))for(;/<font>([\\w\\W]*?)<\\/font>/gi.test(t);)t=t.replace(/<font>([\\w\\W]*?)<\\/font>/gi,\"$1\");!1===s&&(t=(t=(t=(t=t.replace(/<td(.*?)>([\\w\\W]*?)<p(.*?)>([\\w\\W]*?)<\\/td>/gi,\"<td$1>$2$4</td>\")).replace(/<td(.*?)>([\\w\\W]*?)<\\/p>([\\w\\W]*?)<\\/td>/gi,\"<td$1>$2$3</td>\")).replace(/<td(.*?)>([\\w\\W]*?)<p(.*?)>([\\w\\W]*?)<\\/td>/gi,\"<td$1>$2$4</td>\")).replace(/<td(.*?)>([\\w\\W]*?)<\\/p>([\\w\\W]*?)<\\/td>/gi,\"<td$1>$2$3</td>\")),t=(t=t.replace(/\\n/g,\" \")).replace(/<p>\\n?<li>/gi,\"<li>\"),this.pasteInsert(t)},pastePre:function(t){t=t.replace(/<br>|<\\/H[1-6]>|<\\/p>|<\\/div>/gi,\"\\n\");var e=this.document.createElement(\"div\");return e.innerHTML=t,this.cleanEncodeEntities(e.textContent||e.innerText)},pasteInsert:function(t){t=this.callback(\"pasteAfter\",!1,t),this.selectall?(this.$editor.html(t),this.selectionRemove(),this.focusEnd(),this.sync()):this.insertHtml(t),this.selectall=!1,setTimeout($.proxy(function(){this.rtePaste=!1,this.browser(\"mozilla\")&&this.$editor.find(\"p:empty\").remove(),!1!==this.pasteClipboardMozilla&&this.pasteClipboardUploadMozilla()},this),100),this.opts.autoresize&&!0!==this.fullscreen?$(this.document.body).scrollTop(this.saveScroll):this.$editor.scrollTop(this.saveScroll)},pasteClipboardAppendFields:function(t){return!1!==this.opts.uploadFields&&\"object\"==typeof this.opts.uploadFields&&$.each(this.opts.uploadFields,$.proxy(function(e,s){null!=s&&0===s.toString().indexOf(\"#\")&&(s=$(s).val()),t[e]=s},this)),t},pasteClipboardUploadMozilla:function(){var t=this.$editor.find(\"img[data-mozilla-paste-image]\");$.each(t,$.proxy(function(t,e){var s=$(e),o=e.src.split(\",\"),r={contentType:o[0].split(\";\")[0].split(\":\")[1],data:o[1]};r=this.pasteClipboardAppendFields(r),$.post(this.opts.clipboardUploadUrl,r,$.proxy(function(t){var e=\"string\"==typeof t?$.parseJSON(t):t;s.attr(\"src\",e.image.url),s.removeAttr(\"data-mozilla-paste-image\"),this.sync(),this.callback(\"imageUpload\",s,e)},this))},this))},pasteClipboardUpload:function(t){var e=t.target.result,s=e.split(\",\"),o={contentType:s[0].split(\";\")[0].split(\":\")[1],data:s[1]};this.opts.clipboardUpload?(o=this.pasteClipboardAppendFields(o),$.post(this.opts.clipboardUploadUrl,o,$.proxy(function(t){var e=\"string\"==typeof t?$.parseJSON(t):t,s='<img src=\"'+e.image.url+'\" id=\"clipboard-image-marker\" />';this.execCommand(\"inserthtml\",s,!1);var o=$(this.$editor.find(\"img#clipboard-image-marker\"));o.length?o.removeAttr(\"id\"):o=!1,this.sync(),o&&this.callback(\"imageUpload\",o,e)},this))):this.insertHtml('<img src=\"'+e+'\" />')},bufferSet:function(t){!1!==t&&this.selectionSave(),this.opts.buffer.push(this.$editor.html()),!1!==t&&this.selectionRemoveMarkers(\"buffer\")},bufferUndo:function(){if(0===this.opts.buffer.length){this.focusWithSaveScroll();return}this.selectionSave(),this.opts.rebuffer.push(this.$editor.html()),this.selectionRestore(!1,!0),this.$editor.html(this.opts.buffer.pop()),this.selectionRestore(),setTimeout($.proxy(this.observeStart,this),100)},bufferRedo:function(){if(0===this.opts.rebuffer.length)return this.focusWithSaveScroll(),!1;this.selectionSave(),this.opts.buffer.push(this.$editor.html()),this.selectionRestore(!1,!0),this.$editor.html(this.opts.rebuffer.pop()),this.selectionRestore(!0),setTimeout($.proxy(this.observeStart,this),4)},observeStart:function(){this.observeImages(),this.opts.observeLinks&&this.observeLinks()},observeLinks:function(){this.$editor.find(\"a\").on(\"click\",$.proxy(this.linkObserver,this)),this.$editor.on(\"click.redactor\",$.proxy(function(t){this.linkObserverTooltipClose(t)},this)),$(document).on(\"click.redactor\",$.proxy(function(t){this.linkObserverTooltipClose(t)},this))},observeImages:function(){if(!1===this.opts.observeImages)return!1;this.$editor.find(\"img\").each($.proxy(function(t,e){this.browser(\"msie\")&&$(e).attr(\"unselectable\",\"on\");var s=$(e).parent();s.hasClass(\"royalSlider\")||s.hasClass(\"fotorama\")||this.imageResize(e)},this)),this.$editor.find(\".fotorama, .royalSlider\").on(\"click\",$.proxy(this.editGallery,this))},linkObserver:function(t){var e=$(t.target),s=$(t.target).parent();if(!(s.hasClass(\"royalSlider\")||s.hasClass(\"fotorama\"))&&0!=e.length&&\"A\"===e[0].tagName){var o=e.offset();if(this.opts.iframe){var r=this.$frame.offset();o.top=r.top+(o.top-$(this.document).scrollTop()),o.left+=r.left}var a=$('<span class=\"redactor-link-tooltip\"></span>'),n=e.attr(\"href\");void 0===n&&(n=\"\"),n.length>24&&(n=n.substring(0,24)+\"...\");var l=$('<a href=\"'+e.attr(\"href\")+'\" target=\"_blank\">'+n+\"</a>\").on(\"click\",$.proxy(function(t){this.linkObserverTooltipClose(!1)},this)),c=$('<a href=\"#\">'+this.opts.curLang.edit+\"</a>\").on(\"click\",$.proxy(function(t){t.preventDefault(),this.linkShow(),this.linkObserverTooltipClose(!1)},this)),h=$('<a href=\"#\">'+this.opts.curLang.unlink+\"</a>\").on(\"click\",$.proxy(function(t){t.preventDefault(),this.execCommand(\"unlink\"),this.linkObserverTooltipClose(!1)},this));a.append(l),a.append(\" | \"),a.append(c),a.append(\" | \"),a.append(h),a.css({top:o.top+20+\"px\",left:o.left+\"px\"}),$(\".redactor-link-tooltip\").remove(),$(\"body\").append(a)}},linkObserverTooltipClose:function(t){if(!1!==t&&\"A\"==t.target.tagName)return!1;$(\".redactor-link-tooltip\").remove()},getSelection:function(){return this.opts.rangy?this.opts.iframe?rangy.getSelection(this.$frame[0]):rangy.getSelection():this.document.getSelection()},getRange:function(){if(this.opts.rangy)return this.opts.iframe?rangy.createRange(this.iframeDoc()):rangy.createRange();if(this.document.getSelection){var t=this.getSelection();if(t.getRangeAt&&t.rangeCount)return t.getRangeAt(0)}return this.document.createRange()},selectionElement:function(t){this.setCaret(t)},selectionStart:function(t){this.selectionSet(t[0]||t,0,null,0)},selectionEnd:function(t){this.selectionSet(t[0]||t,1,null,1)},selectionSet:function(t,e,s,o){null==s&&(s=t),null==o&&(o=e);var r=this.getSelection();if(r){if(\"P\"==t.tagName&&\"\"==t.innerHTML&&(t.innerHTML=this.opts.invisibleSpace),\"BR\"==t.tagName&&!1===this.opts.linebreaks){var a=$(this.opts.emptyHtml)[0];$(t).replaceWith(a),s=t=a}var n=this.getRange();n.setStart(t,e),n.setEnd(s,o);try{r.removeAllRanges()}catch(l){}r.addRange(n)}},selectionWrap:function(t){t=t.toLowerCase();var e=this.getBlock();if(e){var s=this.formatChangeTag(e,t);return this.sync(),s}var o=this.getSelection().getRangeAt(0),s=document.createElement(t);return s.appendChild(o.extractContents()),o.insertNode(s),this.selectionElement(s),s},selectionAll:function(){var t=this.getRange();t.selectNodeContents(this.$editor[0]);var e=this.getSelection();e.removeAllRanges(),e.addRange(t)},selectionRemove:function(){this.getSelection().removeAllRanges()},getCaretOffset:function(t){var e=0,s=this.getRange(),o=s.cloneRange();return o.selectNodeContents(t),o.setEnd(s.endContainer,s.endOffset),e=$.trim(o.toString()).length},getCaretOffsetRange:function(){return new Range(this.getSelection().getRangeAt(0))},setCaret:function(t,e,s){void 0===s&&(s=e),t=t[0]||t;var o=this.getRange();o.selectNodeContents(t);var r,a=this.getTextNodesIn(t),n=!1,l=0;if(1==a.length&&e)o.setStart(a[0],e),o.setEnd(a[0],s);else for(var c,h=0;c=a[h++];){if(r=l+c.length,!n&&e>=l&&(e<r||e==r&&h<a.length)&&(o.setStart(c,e-l),n=!0),n&&s<=r){o.setEnd(c,s-l);break}l=r}var d=this.getSelection();d.removeAllRanges(),d.addRange(o)},setCaretAfter:function(t){this.$editor.focus(),t=t[0]||t;var e=this.document.createRange(),s=1,o=-1;e.setStart(t,s),e.setEnd(t,o+2);var r=this.window.getSelection(),a=this.document.createRange(),n=this.document.createTextNode(\"\u200b\");$(t).after(n),a.setStartAfter(n),r.removeAllRanges(),r.addRange(a),$(n).remove()},getTextNodesIn:function(t){var e=[];if(3==t.nodeType)e.push(t);else for(var s=t.childNodes,o=0,r=s.length;o<r;++o)e.push.apply(e,this.getTextNodesIn(s[o]));return e},getCurrent:function(){var t=!1,e=this.getSelection();return e&&e.rangeCount>0&&(t=e.getRangeAt(0).startContainer),this.isParentRedactor(t)},getParent:function(t){return!!(t=t||this.getCurrent())&&this.isParentRedactor($(t).parent()[0])},getBlock:function(t){for(void 0===t&&(t=this.getCurrent());t;){if(this.nodeTestBlocks(t)){if($(t).hasClass(\"redactor_editor\"))return!1;return t}t=t.parentNode}return!1},getBlocks:function(t){var e=[];if(void 0===t){var s=this.getRange();if(s&&!0===s.collapsed)return[this.getBlock()];var t=this.getNodes(s)}return $.each(t,$.proxy(function(t,s){if(!1===this.opts.iframe&&0==$(s).parents(\"div.redactor_editor\").length)return!1;this.nodeTestBlocks(s)&&e.push(s)},this)),0===e.length&&(e=[this.getBlock()]),e},isInlineNode:function(t){return 1==t.nodeType&&!this.rTestBlock.test(t.nodeName)},nodeTestBlocks:function(t){return 1==t.nodeType&&this.rTestBlock.test(t.nodeName)},tagTestBlock:function(t){return this.rTestBlock.test(t)},getNodes:function(t,e){if(void 0===t||!1==t)var t=this.getRange();if(t&&!0===t.collapsed){if(!(void 0===e&&this.tagTestBlock(e)))return[this.getCurrent()];var s=this.getBlock();return s.tagName==e?[s]:[]}var o=[],r=[],a=this.document.getSelection();if(a.isCollapsed||(o=this.getRangeSelectedNodes(a.getRangeAt(0))),$.each(o,$.proxy(function(t,s){if(!1===this.opts.iframe&&0==$(s).parents(\"div.redactor_editor\").length)return!1;void 0===e?\"\"!=$.trim(s.textContent)&&r.push(s):s.tagName==e&&r.push(s)},this)),0==r.length){if(void 0===e&&this.tagTestBlock(e)){var s=this.getBlock();return s.tagName==e?r.push(s):[]}r.push(this.getCurrent())}var n=r[r.length-1];return this.nodeTestBlocks(n)&&(r=r.slice(0,-1)),r},getElement:function(t){for(t||(t=this.getCurrent());t;){if(1==t.nodeType){if($(t).hasClass(\"redactor_editor\"))return!1;return t}t=t.parentNode}return!1},getRangeSelectedNodes:function(t){var e=(t=t||this.getRange()).startContainer,s=t.endContainer;if(e==s)return[e];for(var o=[];e&&e!=s;)o.push(e=this.nextNode(e));for(e=t.startContainer;e&&e!=t.commonAncestorContainer;)o.unshift(e),e=e.parentNode;return o},nextNode:function(t){if(t.hasChildNodes())return t.firstChild;for(;t&&!t.nextSibling;)t=t.parentNode;return t?t.nextSibling:null},getSelectionText:function(){return this.getSelection().toString()},getSelectionHtml:function(){var t=\"\",e=this.getSelection();if(e.rangeCount){for(var s=this.document.createElement(\"div\"),o=e.rangeCount,r=0;r<o;++r)s.appendChild(e.getRangeAt(r).cloneContents());t=s.innerHTML}return this.syncClean(t)},selectionSave:function(){this.isFocused()||this.focusWithSaveScroll(),this.opts.rangy?this.savedSel=rangy.saveSelection():this.selectionCreateMarker(this.getRange())},selectionCreateMarker:function(t,e){if(t){var s=$('<span id=\"selection-marker-1\" class=\"redactor-selection-marker\">'+this.opts.invisibleSpace+\"</span>\",this.document)[0],o=$('<span id=\"selection-marker-2\" class=\"redactor-selection-marker\">'+this.opts.invisibleSpace+\"</span>\",this.document)[0];!0===t.collapsed?this.selectionSetMarker(t,s,!0):(this.selectionSetMarker(t,s,!0),this.selectionSetMarker(t,o,!1)),this.savedSel=this.$editor.html(),this.selectionRestore(!1,!1)}},selectionSetMarker:function(t,e,s){var o=t.cloneRange();try{o.collapse(s),o.insertNode(e),o.detach()}catch(r){var a=this.opts.emptyHtml;this.opts.linebreaks&&(a=\"<br>\"),this.$editor.prepend(a),this.focus()}},selectionRestore:function(t,e){if(this.opts.rangy)rangy.restoreSelection(this.savedSel);else{!0===t&&this.savedSel&&this.$editor.html(this.savedSel);var s=this.$editor.find(\"span#selection-marker-1\"),o=this.$editor.find(\"span#selection-marker-2\");this.browser(\"mozilla\")?this.$editor.focus():this.isFocused()||this.focusWithSaveScroll(),0!=s.length&&0!=o.length?this.selectionSet(s[0],0,o[0],0):0!=s.length&&this.selectionSet(s[0],0,null,0),!1!==e&&(this.selectionRemoveMarkers(),this.savedSel=!1)}},selectionRemoveMarkers:function(t){this.opts.rangy?rangy.removeMarkers(this.savedSel):$.each(this.$editor.find(\"span.redactor-selection-marker\"),function(){\"\"==$.trim($(this).html().replace(/[^\\u0000-\\u1C7F]/g,\"\"))?$(this).remove():$(this).removeAttr(\"class\").removeAttr(\"id\")})},tableShow:function(){this.selectionSave(),this.modalInit(this.opts.curLang.table,this.opts.modal_table,300,$.proxy(function(){$(\"#redactor_insert_table_btn\").on(\"click\",$.proxy(this.tableInsert,this)),setTimeout(function(){$(\"#redactor_table_rows\").focus()},200)},this))},tableInsert:function(){this.bufferSet(!1);var t,e,s,o,r=$(\"#redactor_table_rows\").val(),a=$(\"#redactor_table_columns\").val(),n=$(\"<div></div>\"),l=Math.floor(99999*Math.random()),c=$('<table id=\"table'+l+'\"><tbody></tbody></table>');for(t=0;t<r;t++){for(s=0,e=$(\"<tr></tr>\");s<a;s++)o=$(\"<td>\"+this.opts.invisibleSpace+\"</td>\"),0===t&&0===s&&o.append('<span id=\"selection-marker-1\">'+this.opts.invisibleSpace+\"</span>\"),$(e).append(o);c.append(e)}n.append(c);var h=n.html();!1===this.opts.linebreaks&&this.browser(\"mozilla\")&&(h+=\"<p>\"+this.opts.invisibleSpace+\"</p>\"),this.modalClose(),this.selectionRestore();var d=this.getBlock()||this.getCurrent();if(d&&\"BODY\"!=d.tagName){if(\"LI\"==d.tagName)var d=$(d).closest(\"ul, ol\");$(d).after(h)}else this.insertHtmlAdvanced(h,!1);this.selectionRestore();var p=this.$editor.find(\"#table\"+l);this.buttonActiveObserver(),p.find(\"span#selection-marker-1, inline#selection-marker-1\").remove(),p.removeAttr(\"id\"),this.sync()},tableDeleteTable:function(){var t=$(this.getParent()).closest(\"table\");if(!this.isParentRedactor(t)||0==t.length)return!1;this.bufferSet(),t.remove(),this.sync()},tableDeleteRow:function(){var t=this.getParent(),e=$(t).closest(\"table\");if(!this.isParentRedactor(e)||0==e.length)return!1;this.bufferSet();var s=$(t).closest(\"tr\"),o=s.prev().length?s.prev():s.next();if(o.length){var r=o.children(\"td\").first();r.length&&r.prepend('<span id=\"selection-marker-1\">'+this.opts.invisibleSpace+\"</span>\")}s.remove(),this.selectionRestore(),e.find(\"span#selection-marker-1\").remove(),this.sync()},tableDeleteColumn:function(){var t=this.getParent(),e=$(t).closest(\"table\");if(!this.isParentRedactor(e)||0==e.length)return!1;this.bufferSet();var s=$(t).closest(\"td\");s.is(\"td\")||(s=s.closest(\"td\"));var o=s.get(0).cellIndex;e.find(\"tr\").each($.proxy(function(t,e){var s=o-1<0?o+1:o-1;0===t&&$(e).find(\"td\").eq(s).prepend('<span id=\"selection-marker-1\">'+this.opts.invisibleSpace+\"</span>\"),$(e).find(\"td\").eq(o).remove()},this)),this.selectionRestore(),e.find(\"span#selection-marker-1\").remove(),this.sync()},tableAddHead:function(){var t=$(this.getParent()).closest(\"table\");if(!this.isParentRedactor(t)||0==t.length)return!1;if(this.bufferSet(),0!==t.find(\"thead\").length)this.tableDeleteHead();else{var e=t.find(\"tr\").first().clone();e.find(\"td\").replaceWith(\"<th></th>\").html(this.opts.invisibleSpace),($thead=$(\"<thead></thead>\")).append(e),t.prepend($thead),this.sync()}},tableDeleteHead:function(){var t=$(this.getParent()).closest(\"table\");if(!this.isParentRedactor(t))return!1;var e=t.find(\"thead\");if(0==e.length)return!1;this.bufferSet(),e.remove(),this.sync()},tableAddRowAbove:function(){this.tableAddRow(\"before\")},tableAddRowBelow:function(){this.tableAddRow(\"after\")},tableAddColumnLeft:function(){this.tableAddColumn(\"before\")},tableAddColumnRight:function(){this.tableAddColumn(\"after\")},tableAddRow:function(t){var e=$(this.getParent()).closest(\"table\");if(!this.isParentRedactor(e)||0==e.length)return!1;this.bufferSet();var s=$(this.getParent()).closest(\"tr\"),o=s.clone();o.find(\"td\").html(this.opts.invisibleSpace),\"after\"===t?s.after(o):s.before(o),this.sync()},tableAddColumn:function(t){var e=$(this.getParent()).closest(\"table\");if(!this.isParentRedactor(e)||0==e.length)return!1;this.bufferSet();var s=0,o=this.getCurrent(),r=$(o).closest(\"tr\"),a=$(o).closest(\"td\");r.find(\"td\").each($.proxy(function(t,e){$(e)[0]===a[0]&&(s=t)},this)),e.find(\"tr\").each($.proxy(function(e,o){var r=$(o).find(\"td\").eq(s),a=r.clone();a.html(this.opts.invisibleSpace),\"after\"===t?r.after(a):r.before(a)},this)),this.sync()},videoShow:function(){this.selectionSave(),this.modalInit(this.opts.curLang.video,this.opts.modal_video,600,$.proxy(function(){$(\"#redactor_insert_video_btn\").on(\"click\",$.proxy(this.videoInsert,this)),setTimeout(function(){$(\"#redactor_insert_video_area\").focus()},200)},this))},videoInsert:function(){var t=$(\"#redactor_insert_video_area\").val();t=this.cleanStripTags(t);var e='<iframe width=\"500\" height=\"281\" src=\"',s='\" frameborder=\"0\" allowfullscreen></iframe>';t.match(reUrlYoutube)?t=t.replace(reUrlYoutube,e+\"//www.youtube.com/embed/$1\"+s):t.match(reUrlVimeo)?t=t.replace(reUrlVimeo,e+\"//player.vimeo.com/video/$2\"+s):t.match(reUrlFacebook)?t=t.replace(reUrlFacebook,e+\"https://www.facebook.com/video/embed?video_id=$1\"+s):t.match(reUrlRutube)&&(t=t.replace(reUrlRutube,e+\"//rutube.ru/play/embed/$1\"+s)),this.selectionRestore();var o=this.getBlock()||this.getCurrent();o?$(o).after(t):this.insertHtmlAdvanced(t,!1),this.sync(),this.modalClose()},linkShow:function(){this.selectionSave();var t=$.proxy(function(){if(!1!==this.opts.predefinedLinks){this.predefinedLinksStorage={};var t=this;$.getJSON(this.opts.predefinedLinks,function(e){if(0!==Object.keys(e).length){var s=$(\"#redactor-predefined-links\");s.html(\"\"),$.each(e,function(e,o){t.predefinedLinksStorage[e]=o,s.append($(\"<option>\").val(e).html(o.name))}),s.on(\"change\",function(){var e=$(this).val(),s=\"\",o=\"\";0!=e&&(s=t.predefinedLinksStorage[e].name,o=t.predefinedLinksStorage[e].url),$(\"#redactor_link_url\").val(o),1!=$(\"#redactor_link_url_text\").data(\"is_selected_text\")&&$(\"#redactor_link_url_text\").val(s)}),s.show()}})}this.insert_link_node=!1;var e=this.getSelection(),s=\"\",o=\"\",r=\"\",a=this.getParent(),n=$(a).parent().get(0);n&&\"A\"===n.tagName&&(a=n),a&&\"A\"===a.tagName?(s=a.href,o=$(a).text(),r=a.target,this.insert_link_node=a):o=e.toString(),$(\"#redactor_link_url_text\").val(o),o.length>0&&$(\"#redactor_link_url_text\").data(\"is_selected_text\",1);var l=self.location.href.replace(/\\/$/i,\"\");if(s=(s=(s=s.replace(l,\"\")).replace(/^\\/#/,\"#\")).replace(\"mailto:\",\"\"),!1===this.opts.linkProtocol){var c=RegExp(\"^(http|ftp|https)://\"+self.location.host,\"i\");s=s.replace(c,\"\")}$(\"#redactor_link_url\").val(s),\"_blank\"===r&&$(\"#redactor_link_blank\").prop(\"checked\",!0),this.linkInsertPressed=!1,$(\"#redactor_insert_link_btn\").on(\"click\",$.proxy(this.linkProcess,this)),setTimeout(function(){$(\"#redactor_link_url\").focus()},200)},this);this.modalInit(this.opts.curLang.link,this.opts.modal_link,460,t)},linkProcess:function(){if(!this.linkInsertPressed){this.linkInsertPressed=!0;var t=\"\",e=\"\",s=$(\"#redactor_link_url\").val(),o=$(\"#redactor_link_url_text\").val();if(-1!=s.search(\"@\")&&!1===/(http|ftp|https):\\/\\//i.test(s))s=\"mailto:\"+s;else if(0!=s.search(\"#\")){$(\"#redactor_link_blank\").prop(\"checked\")&&(t=' target=\"_blank\"',e=\"_blank\");var r=\"((xn--)?[a-z0-9]+(-[a-z0-9]+)*.)+[a-z]{2,}\",a=RegExp(\"^(http|ftp|https)://\"+r,\"i\"),n=RegExp(\"^\"+r,\"i\");-1==s.search(a)&&0==s.search(n)&&this.opts.linkProtocol&&(s=this.opts.linkProtocol+s)}o=o.replace(/<|>/g,\"\");var l=\"&nbsp;\";this.browser(\"mozilla\")&&(l=\"&nbsp;\"),this.linkInsert('<a href=\"'+s+'\"'+t+\">\"+o+\"</a>\"+l,$.trim(o),s,e)}},linkInsert:function(t,e,s,o){if(this.selectionRestore(),\"\"!==e){if(this.insert_link_node)this.bufferSet(),$(this.insert_link_node).text(e).attr(\"href\",s),\"\"!==o?$(this.insert_link_node).attr(\"target\",o):$(this.insert_link_node).removeAttr(\"target\");else{var r=$(t).addClass(\"redactor-added-link\");this.exec(\"inserthtml\",this.outerHtml(r),!1);var s=this.$editor.find(\"a.redactor-added-link\");s.removeAttr(\"style\").removeClass(\"redactor-added-link\").each(function(){\"\"==this.className&&$(this).removeAttr(\"class\")})}this.sync()}setTimeout($.proxy(function(){this.opts.observeLinks&&this.observeLinks()},this),5),this.modalClose()},fileShow:function(){this.selectionSave();var t=$.proxy(function(){var t=this.getSelection(),e=\"\";e=this.oldIE()?t.text:t.toString(),$(\"#redactor_filename\").val(e),this.isMobile()||this.isIPad()||this.draguploadInit(\"#redactor_file\",{url:this.opts.fileUpload,uploadFields:this.opts.uploadFields,success:$.proxy(this.fileCallback,this),error:$.proxy(function(t,e){this.callback(\"fileUploadError\",e)},this),uploadParam:this.opts.fileUploadParam}),this.uploadInit(\"redactor_file\",{auto:!0,url:this.opts.fileUpload,success:$.proxy(this.fileCallback,this),error:$.proxy(function(t,e){this.callback(\"fileUploadError\",e)},this)})},this);this.modalInit(this.opts.curLang.file,this.opts.modal_file,500,t)},fileCallback:function(t){if(this.selectionRestore(),!1!==t){var e=$(\"#redactor_filename\").val();\"\"===e&&(e=t.filename);var s='<a href=\"'+t.filelink+'\" id=\"filelink-marker\">'+e+\"</a>\";this.browser(\"webkit\")&&this.window.chrome&&(s+=\"&nbsp;\"),this.execCommand(\"inserthtml\",s,!1);var o=$(this.$editor.find(\"a#filelink-marker\"));0!=o.length?o.removeAttr(\"id\"):o=!1,this.sync(),this.callback(\"fileUpload\",o,t)}this.modalClose()},imageShow:function(){this.selectionSave();var t=$.proxy(function(){this.opts.imageGetJson?$.getJSON(this.opts.imageGetJson,$.proxy(function(t){if(t.error){alert(t.message);return}var e={},s=0;$.each(t,$.proxy(function(t,o){void 0!==o.folder&&(s++,e[o.folder]=s)},this)),$(\"#redactor_image_box .empty_list\").show();var o=!1;if($.each(t,$.proxy(function(t,s){var r=\"\";void 0!==s.title&&(r=s.title);var a=0;$.isEmptyObject(e)||void 0===s.folder||(a=e[s.folder],!1!==o||(o=\".redactorfolder\"+a));var n=$('<img src=\"'+s.thumb+'\" class=\"redactorfolder redactorfolder'+a+'\" rel=\"'+s.image+'\" title=\"'+r+'\" />');$(\"#redactor_image_box\").append(n),$(n).on(\"click\",$.proxy(this.imageThumbClick,this)),$(\"#redactor_image_box .empty_list\").hide()},this)),!$.isEmptyObject(e)){$(\".redactorfolder\").hide(),$(o).show();var r=function(t){$(\".redactorfolder\").hide(),$(\".redactorfolder\"+$(t.target).val()).show()},a=$('<select id=\"redactor_image_box_select\">');$.each(e,function(t,e){a.append($('<option value=\"'+e+'\">'+t+\"</option>\"))}),$(\"#redactor_image_box\").before(a),a.change(r)}},this)):$(\"#redactor-tab-control-2\").remove(),this.opts.imageUpload||this.opts.s3?(this.isMobile()||this.isIPad()||!1!==this.opts.s3||!$(\"#redactor_file\").length||this.draguploadInit(\"#redactor_file\",{url:this.opts.imageUpload,uploadFields:this.opts.uploadFields,success:$.proxy(this.imageCallback,this),error:$.proxy(function(t,e){this.callback(\"imageUploadError\",e)},this),uploadParam:this.opts.imageUploadParam}),!1===this.opts.s3?this.uploadInit(\"redactor_file\",{auto:!0,url:this.opts.imageUpload,success:$.proxy(this.imageCallback,this),error:$.proxy(function(t,e){this.callback(\"imageUploadError\",e)},this)}):$(\"#redactor_file\").on(\"change.redactor\",$.proxy(this.s3handleFileSelect,this))):($(\".redactor_tab\").hide(),this.opts.imageGetJson?($(\"#redactor-tab-control-1\").remove(),$(\"#redactor-tab-control-2\").addClass(\"redactor_tabs_act\"),$(\"#redactor_tab2\").show()):($(\"#redactor_tabs\").remove(),$(\"#redactor_tab3\").show())),!this.opts.imageTabLink&&(this.opts.imageUpload||this.opts.imageGetJson)&&$(\"#redactor-tab-control-3\").hide(),$(\"#redactor_upload_btn\").on(\"click\",$.proxy(this.imageCallbackLink,this)),this.opts.imageUpload||this.opts.imageGetJson||setTimeout(function(){$(\"#redactor_file_link\").focus()},200)},this);this.modalInit(this.opts.curLang.image,this.opts.modal_image,610,t)},imageEdit:function(t){var e=t,s=e.parent().parent(),o=$.proxy(function(){$(\"#redactor_file_alt\").val(e.attr(\"alt\")),$(\"#redactor_image_edit_src\").attr(\"href\",e.attr(\"src\")),\"block\"==e.css(\"display\")&&\"none\"==e.css(\"float\")?$(\"#redactor_form_image_align\").val(\"center\"):$(\"#redactor_form_image_align\").val(e.css(\"float\")),\"A\"===$(s).get(0).tagName&&($(\"#redactor_file_link\").val($(s).attr(\"href\")),\"_blank\"==$(s).attr(\"target\")&&$(\"#redactor_link_blank\").prop(\"checked\",!0)),$(\"#redactor_image_delete_btn\").on(\"click\",$.proxy(function(){this.imageRemove(e)},this)),$(\"#redactorSaveBtn\").on(\"click\",$.proxy(function(){this.imageSave(e)},this))},this);this.modalInit(this.opts.curLang.edit,this.opts.modal_image_edit,380,o)},imageRemove:function(t){var e=$(t).parent().parent(),s=$(t).parent(),o=!1;e.length&&\"A\"===e[0].tagName?(o=!0,$(e).remove()):s.length&&\"A\"===s[0].tagName?(o=!0,$(s).remove()):$(t).remove(),s.length&&\"P\"===s[0].tagName&&(this.focusWithSaveScroll(),!1===o&&this.selectionStart(s)),this.callback(\"imageDelete\",t),this.modalClose(),this.sync()},imageSave:function(t){this.imageResizeHide(!1);var e=$(t),s=e.parent();e.attr(\"alt\",$(\"#redactor_file_alt\").val());var o=$(\"#redactor_form_image_align\").val(),r=\"\";\"left\"===o?(r=\"0 \"+this.opts.imageFloatMargin+\" \"+this.opts.imageFloatMargin+\" 0\",e.css({float:\"left\",margin:r})):\"right\"===o?(r=\"0 0 \"+this.opts.imageFloatMargin+\" \"+this.opts.imageFloatMargin,e.css({float:\"right\",margin:r})):\"center\"===o?e.css({float:\"\",display:\"block\",margin:\"auto\"}):e.css({float:\"\",display:\"\",margin:\"\"});var a=$.trim($(\"#redactor_file_link\").val());if(\"\"!==a){var n=!1;if($(\"#redactor_link_blank\").prop(\"checked\")&&(n=!0),\"A\"!==s.get(0).tagName){var l=$('<a href=\"'+a+'\">'+this.outerHtml(t)+\"</a>\");n&&l.attr(\"target\",\"_blank\"),e.replaceWith(l)}else s.attr(\"href\",a),n?s.attr(\"target\",\"_blank\"):s.removeAttr(\"target\")}else\"A\"===s.get(0).tagName&&s.replaceWith(this.outerHtml(t));this.modalClose(),this.observeImages(),this.sync()},imageResizeHide:function(t){if(!1!==t&&0!=$(t.target).parent().length&&\"redactor-image-box\"===$(t.target).parent()[0].id)return!1;var e=this.$editor.find(\"#redactor-image-box\");if(0==e.length)return!1;this.$editor.find(\"#redactor-image-editter, #redactor-image-resizer\").remove(),e.find(\"img\").css({marginTop:e[0].style.marginTop,marginBottom:e[0].style.marginBottom,marginLeft:e[0].style.marginLeft,marginRight:e[0].style.marginRight}),e.css(\"margin\",\"\"),e.find(\"img\").css(\"opacity\",\"\"),e.replaceWith(function(){return $(this).contents()}),$(document).off(\"click.redactor-image-resize-hide\"),this.$editor.off(\"click.redactor-image-resize-hide\"),this.$editor.off(\"keydown.redactor-image-delete\"),this.sync()},imageResize:function(t){var e=$(t);e.on(\"mousedown\",$.proxy(function(){this.imageResizeHide(!1)},this)),e.on(\"dragstart\",$.proxy(function(){this.$editor.on(\"drop.redactor-image-inside-drop\",$.proxy(function(){setTimeout($.proxy(function(){this.observeImages(),this.$editor.off(\"drop.redactor-image-inside-drop\"),this.sync()},this),1)},this))},this)),e.on(\"click\",$.proxy(function(t){if(0!=this.$editor.find(\"#redactor-image-box\").length)return!1;var s,o,r=e.width()/e.height(),a=20,n=this.imageResizeControls(e),l=!1;!1!==n&&(n.on(\"mousedown\",function(t){l=!0,t.preventDefault(),r=e.width()/e.height(),s=Math.round(t.pageX-e.eq(0).offset().left),o=Math.round(t.pageY-e.eq(0).offset().top)}),$(this.document.body).on(\"mousemove\",$.proxy(function(t){if(l){t.pageX,e.eq(0).offset().left;var n=Math.round(t.pageY-e.eq(0).offset().top)-o,c=Math.round((parseInt(e.height(),10)+n)*r);c>a&&(e.width(c),c<100?this.imageEditter.css({marginTop:\"-7px\",marginLeft:\"-13px\",fontSize:\"9px\",padding:\"3px 5px\"}):this.imageEditter.css({marginTop:\"-11px\",marginLeft:\"-18px\",fontSize:\"11px\",padding:\"7px 10px\"})),s=Math.round(t.pageX-e.eq(0).offset().left),o=Math.round(t.pageY-e.eq(0).offset().top),this.sync()}},this)).on(\"mouseup\",function(){l=!1})),this.$editor.on(\"keydown.redactor-image-delete\",$.proxy(function(t){var s=t.which;(this.keyCode.BACKSPACE==s||this.keyCode.DELETE==s)&&(this.bufferSet(!1),this.imageResizeHide(!1),this.imageRemove(e))},this)),$(document).on(\"click.redactor-image-resize-hide\",$.proxy(this.imageResizeHide,this)),this.$editor.on(\"click.redactor-image-resize-hide\",$.proxy(this.imageResizeHide,this))},this))},imageResizeControls:function(t){var e=$('<span id=\"redactor-image-box\" data-redactor=\"verified\">');if(e.css({position:\"relative\",display:\"inline-block\",lineHeight:0,outline:\"1px dashed rgba(0, 0, 0, .6)\",float:t.css(\"float\")}),e.attr(\"contenteditable\",!1),\"auto\"!=t[0].style.margin?(e.css({marginTop:t[0].style.marginTop,marginBottom:t[0].style.marginBottom,marginLeft:t[0].style.marginLeft,marginRight:t[0].style.marginRight}),t.css(\"margin\",\"\")):e.css({display:\"block\",margin:\"auto\"}),t.css(\"opacity\",.5).after(e),this.imageEditter=$('<span id=\"redactor-image-editter\" data-redactor=\"verified\">'+this.opts.curLang.edit+\"</span>\"),this.imageEditter.css({position:\"absolute\",zIndex:5,top:\"50%\",left:\"50%\",marginTop:\"-11px\",marginLeft:\"-18px\",lineHeight:1,backgroundColor:\"#000\",color:\"#fff\",fontSize:\"11px\",padding:\"7px 10px\",cursor:\"pointer\"}),this.imageEditter.attr(\"contenteditable\",!1),this.imageEditter.on(\"click\",$.proxy(function(){this.imageEdit(t)},this)),e.append(this.imageEditter),!this.opts.imageResizable)return e.append(t),!1;var s=$('<span id=\"redactor-image-resizer\" data-redactor=\"verified\"></span>');return s.css({position:\"absolute\",zIndex:2,lineHeight:1,cursor:\"nw-resize\",bottom:\"-4px\",right:\"-5px\",border:\"1px solid #fff\",backgroundColor:\"#000\",width:\"8px\",height:\"8px\"}),s.attr(\"contenteditable\",!1),e.append(s),e.append(t),s},imageThumbClick:function(t){var e='<img id=\"image-marker\" src=\"'+$(t.target).attr(\"rel\")+'\" alt=\"'+$(t.target).attr(\"title\")+'\" />',s=this.getParent();this.opts.paragraphy&&0==$(s).closest(\"li\").length&&(e=\"<p>\"+e+\"</p>\"),this.imageInsert(e,!0)},imageCallbackLink:function(){var t=$(\"#redactor_file_link\").val();if(\"\"!==t){var e='<img id=\"image-marker\" src=\"'+t+'\" />';!1===this.opts.linebreaks&&(e=\"<p>\"+e+\"</p>\"),this.imageInsert(e,!0)}else this.modalClose()},imageCallback:function(t){this.imageInsert(t)},imageInsert:function(t,e){if(this.selectionRestore(),!1!==t){var s=\"\";if(!0!==e){s='<img id=\"image-marker\" src=\"'+t.image.url+'\" />';var o=this.getParent();this.opts.paragraphy&&0==$(o).closest(\"li\").length&&(s=\"<p>\"+s+\"</p>\")}else s=t;this.execCommand(\"inserthtml\",s,!1);var r=$(this.$editor.find(\"img#image-marker\"));r.length?r.removeAttr(\"id\"):r=!1,this.sync(),!0!==e&&this.callback(\"imageUpload\",r,t)}this.modalClose(),this.observeImages()},buildProgressBar:function(){0==$(\"#redactor-progress\").length&&(this.$progressBar=$('<div id=\"redactor-progress\"><span></span></div>'),$(document.body).append(this.$progressBar))},showProgressBar:function(){this.buildProgressBar(),$(\"#redactor-progress\").fadeIn()},hideProgressBar:function(){$(\"#redactor-progress\").fadeOut(1500)},modalTemplatesInit:function(){$.extend(this.opts,{modal_file:String()+'<section id=\"redactor-modal-file-insert\"><form id=\"redactorUploadFileForm\" method=\"post\" action=\"\" enctype=\"multipart/form-data\"><label>'+this.opts.curLang.filename+'</label><input type=\"text\" id=\"redactor_filename\" class=\"redactor_input\" /><div style=\"margin-top: 7px;\"><input type=\"file\" id=\"redactor_file\" name=\"'+this.opts.fileUploadParam+'\" /></div></form></section>',modal_image_edit:String()+'<section id=\"redactor-modal-image-edit\"><label>'+this.opts.curLang.title+'</label><input type=\"text\" id=\"redactor_file_alt\" class=\"redactor_input\" /><label>'+this.opts.curLang.link+'</label><input type=\"text\" id=\"redactor_file_link\" class=\"redactor_input\" /><label><input type=\"checkbox\" id=\"redactor_link_blank\"> '+this.opts.curLang.link_new_tab+\"</label><label>\"+this.opts.curLang.image_position+'</label><select id=\"redactor_form_image_align\"><option value=\"none\">'+this.opts.curLang.none+'</option><option value=\"left\">'+this.opts.curLang.left+'</option><option value=\"center\">'+this.opts.curLang.center+'</option><option value=\"right\">'+this.opts.curLang.right+'</option></select></section><footer><button id=\"redactor_image_delete_btn\" class=\"redactor_modal_btn redactor_modal_delete_btn\">'+this.opts.curLang._delete+'</button><button class=\"redactor_modal_btn redactor_btn_modal_close\">'+this.opts.curLang.cancel+'</button><button id=\"redactorSaveBtn\" class=\"redactor_modal_btn redactor_modal_action_btn\">'+this.opts.curLang.save+\"</button></footer>\",modal_image:String()+'<section id=\"redactor-modal-image-insert\"><div id=\"redactor_tabs\"><a href=\"#\" id=\"redactor-tab-control-1\" class=\"redactor_tabs_act\">'+this.opts.curLang.upload+'</a><a href=\"#\" id=\"redactor-tab-control-2\">'+this.opts.curLang.choose+'</a><a href=\"#\" id=\"redactor-tab-control-3\">'+this.opts.curLang.link+'</a></div><form id=\"redactorInsertImageForm\" method=\"post\" action=\"\" enctype=\"multipart/form-data\"><div id=\"redactor_tab1\" class=\"redactor_tab\"><input type=\"file\" id=\"redactor_file\" name=\"'+this.opts.imageUploadParam+'\" /></div><div id=\"redactor_tab2\" class=\"redactor_tab\" style=\"display: none;\"><div id=\"redactor_image_box\"><span class=\"empty_list\">'+this.opts.curLang.empty_img_list+'</span></div></div></form><div id=\"redactor_tab3\" class=\"redactor_tab\" style=\"display: none;\"><label>'+this.opts.curLang.image_web_link+'</label><input type=\"text\" name=\"redactor_file_link\" id=\"redactor_file_link\" class=\"redactor_input\"  /><br><br></div></section><footer><button class=\"redactor_modal_btn redactor_btn_modal_close\">'+this.opts.curLang.cancel+'</button><button class=\"redactor_modal_btn redactor_modal_action_btn\" id=\"redactor_upload_btn\">'+this.opts.curLang.insert+\"</button></footer>\",modal_link:String()+'<section id=\"redactor-modal-link-insert\"><select id=\"redactor-predefined-links\" style=\"width: 99.5%; display: none;\"></select><label>URL</label><input type=\"text\" class=\"redactor_input\" id=\"redactor_link_url\" /><label>'+this.opts.curLang.text+'</label><input type=\"text\" class=\"redactor_input\" id=\"redactor_link_url_text\" /><label><input type=\"checkbox\" id=\"redactor_link_blank\"> '+this.opts.curLang.link_new_tab+'</label></section><footer><button class=\"redactor_modal_btn redactor_btn_modal_close\">'+this.opts.curLang.cancel+'</button><button id=\"redactor_insert_link_btn\" class=\"redactor_modal_btn redactor_modal_action_btn\">'+this.opts.curLang.insert+\"</button></footer>\",modal_table:String()+'<section id=\"redactor-modal-table-insert\"><label>'+this.opts.curLang.rows+'</label><input type=\"text\" size=\"5\" value=\"2\" id=\"redactor_table_rows\" /><label>'+this.opts.curLang.columns+'</label><input type=\"text\" size=\"5\" value=\"3\" id=\"redactor_table_columns\" /></section><footer><button class=\"redactor_modal_btn redactor_btn_modal_close\">'+this.opts.curLang.cancel+'</button><button id=\"redactor_insert_table_btn\" class=\"redactor_modal_btn redactor_modal_action_btn\">'+this.opts.curLang.insert+\"</button></footer>\",modal_video:String()+'<section id=\"redactor-modal-video-insert\"><form id=\"redactorInsertVideoForm\"><label>'+this.opts.curLang.video_html_code+'</label><textarea id=\"redactor_insert_video_area\" style=\"width: 99%; height: 160px;\"></textarea></form></section><footer><button class=\"redactor_modal_btn redactor_btn_modal_close\">'+this.opts.curLang.cancel+'</button><button id=\"redactor_insert_video_btn\" class=\"redactor_modal_btn redactor_modal_action_btn\">'+this.opts.curLang.insert+\"</button></footer>\"})},modalInit:function(t,e,s,o){return this.modalSetOverlay(),this.$redactorModalWidth=s,this.$redactorModal=$(\"#redactor_modal\"),this.$redactorModal.length||(this.$redactorModal=$('<div id=\"redactor_modal\" style=\"display: none;\" />'),this.$redactorModal.append($('<div id=\"redactor_modal_close\">&times;</div>')),this.$redactorModal.append($('<header id=\"redactor_modal_header\" />')),this.$redactorModal.append($('<div id=\"redactor_modal_inner\" />')),this.$redactorModal.appendTo(document.body)),$(\"#redactor_modal_close\").on(\"click\",$.proxy(this.modalClose,this)),$(document).on(\"keyup\",$.proxy(this.modalCloseHandler,this)),this.$editor.on(\"keyup\",$.proxy(this.modalCloseHandler,this)),this.modalSetContent(e),this.modalSetTitle(t),this.modalSetDraggable(),this.modalLoadTabs(),this.modalOnCloseButton(),this.modalSetButtonsWidth(),this.saveModalScroll=this.document.body.scrollTop,!1===this.opts.autoresize&&(this.saveModalScroll=this.$editor.scrollTop()),!1===this.isMobile()?this.modalShowOnDesktop():this.modalShowOnMobile(),\"function\"==typeof o&&o(),setTimeout($.proxy(function(){this.callback(\"modalOpened\",this.$redactorModal)},this),11),$(document).off(\"focusin.modal\"),this.$redactorModal.find(\"input[type=text]\").on(\"keypress\",$.proxy(function(t){13===t.which&&(this.$redactorModal.find(\".redactor_modal_action_btn\").trigger(\"click\"),t.preventDefault())},this)),this.$redactorModal},modalShowOnDesktop:function(){this.$redactorModal.css({position:\"fixed\",top:\"-2000px\",left:\"50%\",width:this.$redactorModalWidth+\"px\",marginLeft:\"-\"+this.$redactorModalWidth/2+\"px\"}).show(),this.modalSaveBodyOveflow=$(document.body).css(\"overflow\"),$(document.body).css(\"overflow\",\"hidden\"),setTimeout($.proxy(function(){var t=this.$redactorModal.outerHeight();this.$redactorModal.css({top:\"50%\",height:\"auto\",minHeight:\"auto\",marginTop:\"-\"+(t+10)/2+\"px\"})},this),15)},modalShowOnMobile:function(){this.$redactorModal.css({position:\"fixed\",width:\"100%\",height:\"100%\",top:\"0\",left:\"0\",margin:\"0\",minHeight:\"300px\"}).show()},modalSetContent:function(t){this.modalcontent=!1,0==t.indexOf(\"#\")?(this.modalcontent=$(t),$(\"#redactor_modal_inner\").empty().append(this.modalcontent.html()),this.modalcontent.html(\"\")):$(\"#redactor_modal_inner\").empty().append(t)},modalSetTitle:function(t){this.$redactorModal.find(\"#redactor_modal_header\").html(t)},modalSetButtonsWidth:function(){},modalOnCloseButton:function(){this.$redactorModal.find(\".redactor_btn_modal_close\").on(\"click\",$.proxy(this.modalClose,this))},modalSetOverlay:function(){this.opts.modalOverlay&&(this.$redactorModalOverlay=$(\"#redactor_modal_overlay\"),this.$redactorModalOverlay.length||(this.$redactorModalOverlay=$('<div id=\"redactor_modal_overlay\" style=\"display: none;\"></div>'),$(\"body\").prepend(this.$redactorModalOverlay)),this.$redactorModalOverlay.show().on(\"click\",$.proxy(this.modalClose,this)))},modalSetDraggable:function(){void 0!==$.fn.draggable&&(this.$redactorModal.draggable({handle:\"#redactor_modal_header\"}),this.$redactorModal.find(\"#redactor_modal_header\").css(\"cursor\",\"move\"))},modalLoadTabs:function(){var t=$(\"#redactor_tabs\");if(!t.length)return!1;var e=this;t.find(\"a\").each(function(s,o){s++,$(o).on(\"click\",function(o){if(o.preventDefault(),t.find(\"a\").removeClass(\"redactor_tabs_act\"),$(this).addClass(\"redactor_tabs_act\"),$(\".redactor_tab\").hide(),$(\"#redactor_tab\"+s).show(),$(\"#redactor_tab_selected\").val(s),!1===e.isMobile()){var r=e.$redactorModal.outerHeight();e.$redactorModal.css(\"margin-top\",\"-\"+(r+10)/2+\"px\")}})})},modalCloseHandler:function(t){if(t.keyCode===this.keyCode.ESC)return this.modalClose(),!1},modalClose:function(){return $(\"#redactor_modal_close\").off(\"click\",this.modalClose),$(\"#redactor_modal\").fadeOut(\"fast\",$.proxy(function(){var t=$(\"#redactor_modal_inner\");!1!==this.modalcontent&&(this.modalcontent.html(t.html()),this.modalcontent=!1),t.html(\"\"),this.opts.modalOverlay&&$(\"#redactor_modal_overlay\").hide().off(\"click\",this.modalClose),$(document).off(\"keyup\",this.modalCloseHandler),this.$editor.off(\"keyup\",this.modalCloseHandler),this.selectionRestore(),this.opts.autoresize&&this.saveModalScroll?$(this.document.body).scrollTop(this.saveModalScroll):!1===this.opts.autoresize&&this.saveModalScroll&&this.$editor.scrollTop(this.saveModalScroll),this.callback(\"modalClosed\")},this)),!1===this.isMobile()&&$(document.body).css(\"overflow\",this.modalSaveBodyOveflow?this.modalSaveBodyOveflow:\"visible\"),!1},modalSetTab:function(t){$(\".redactor_tab\").hide(),$(\"#redactor_tabs\").find(\"a\").removeClass(\"redactor_tabs_act\").eq(t-1).addClass(\"redactor_tabs_act\"),$(\"#redactor_tab\"+t).show()},s3handleFileSelect:function(t){for(var e,s=t.target.files,o=0;e=s[o];o++)this.s3uploadFile(e)},s3uploadFile:function(t){this.s3executeOnSignedUrl(t,$.proxy(function(e){this.s3uploadToS3(t,e)},this))},s3executeOnSignedUrl:function(t,e){var s=new XMLHttpRequest,o=\"?\";\"-1\"!=this.opts.s3.search(/\\?/)&&(o=\"&\"),s.open(\"GET\",this.opts.s3+o+\"name=\"+t.name+\"&type=\"+t.type,!0),s.overrideMimeType&&s.overrideMimeType(\"text/plain; charset=x-user-defined\");var r=this;s.onreadystatechange=function(t){4==this.readyState&&200==this.status?(r.showProgressBar(),e(decodeURIComponent(this.responseText))):4==this.readyState&&this.status},s.send()},s3createCORSRequest:function(t,e){var s=new XMLHttpRequest;return\"withCredentials\"in s?s.open(t,e,!0):\"undefined\"!=typeof XDomainRequest?(s=new XDomainRequest).open(t,e):s=null,s},s3uploadToS3:function(t,e){var s=this.s3createCORSRequest(\"PUT\",e);s&&(s.onload=$.proxy(function(){if(200==s.status){this.hideProgressBar();var t=e.split(\"?\");if(!t[0])return!1;this.selectionRestore();var o=\"\";o='<img id=\"image-marker\" src=\"'+t[0]+'\" />',this.opts.paragraphy&&(o=\"<p>\"+o+\"</p>\"),this.execCommand(\"inserthtml\",o,!1);var r=$(this.$editor.find(\"img#image-marker\"));r.length?r.removeAttr(\"id\"):r=!1,this.sync(),this.callback(\"imageUpload\",r,!1),this.modalClose(),this.observeImages()}},this),s.onerror=function(){},s.upload.onprogress=function(t){},s.setRequestHeader(\"Content-Type\",t.type),s.setRequestHeader(\"x-amz-acl\",\"public-read\"),s.send(t))},uploadInit:function(t,e){this.uploadOptions={url:!1,success:!1,error:!1,start:!1,trigger:!1,auto:!1,input:!1},$.extend(this.uploadOptions,e);var s=$(\"#\"+t);s.length&&\"INPUT\"===s[0].tagName?(this.uploadOptions.input=s,this.el=$(s[0].form)):this.el=s,this.element_action=this.el.attr(\"action\"),this.uploadOptions.auto?$(this.uploadOptions.input).change($.proxy(function(t){this.el.submit(function(t){return!1}),this.uploadSubmit(t)},this)):this.uploadOptions.trigger&&$(\"#\"+this.uploadOptions.trigger).on(\"click\",$.proxy(this.uploadSubmit,this))},uploadSubmit:function(t){this.showProgressBar(),this.uploadForm(this.element,this.uploadFrame())},uploadFrame:function(){this.id=\"f\"+Math.floor(99999*Math.random());var t=this.document.createElement(\"div\"),e='<iframe style=\"display:none\" id=\"'+this.id+'\" name=\"'+this.id+'\"></iframe>';return t.innerHTML=e,$(t).appendTo(\"body\"),this.uploadOptions.start&&this.uploadOptions.start(),$(\"#\"+this.id).one(\"load\",$.proxy(this.uploadLoaded,this)),this.id},uploadForm:function(t,e){if(this.uploadOptions.input){var s=\"redactorUploadForm\"+this.id,o=\"redactorUploadFile\"+this.id;this.form=$('<form  action=\"'+this.uploadOptions.url+'\" method=\"POST\" target=\"'+e+'\" name=\"'+s+'\" id=\"'+s+'\" enctype=\"multipart/form-data\" />'),!1!==this.opts.uploadFields&&\"object\"==typeof this.opts.uploadFields&&$.each(this.opts.uploadFields,$.proxy(function(t,e){null!=e&&0===e.toString().indexOf(\"#\")&&(e=$(e).val());var s=$(\"<input/>\",{type:\"hidden\",name:t,value:e});$(this.form).append(s)},this));var r=this.uploadOptions.input,a=$(r).clone();$(r).attr(\"id\",o).before(a).appendTo(this.form),$(this.form).css(\"position\",\"absolute\").css(\"top\",\"-2000px\").css(\"left\",\"-2000px\").appendTo(\"body\"),this.form.submit()}else t.attr(\"target\",e).attr(\"method\",\"POST\").attr(\"enctype\",\"multipart/form-data\").attr(\"action\",this.uploadOptions.url),this.element.submit()},uploadLoaded:function(){var t,e=$(\"#\"+this.id)[0];if(t=e.contentDocument?e.contentDocument:e.contentWindow?e.contentWindow.document:window.frames[this.id].document,this.uploadOptions.success){if(this.hideProgressBar(),void 0!==t){var s=t.body.innerHTML.match(/\\{(.|\\n)*\\}/)[0];s=(s=s.replace(/^\\[/,\"\")).replace(/\\]$/,\"\");var o=$.parseJSON(s);void 0===o.error?this.uploadOptions.success(o):(console.log(o),this.uploadOptions.error(this,o),this.modalClose())}else this.modalClose(),alert(\"Upload failed!\")}this.el.attr(\"action\",this.element_action),this.el.attr(\"target\",\"\")},draguploadInit:function(t,e){if(this.draguploadOptions=$.extend({url:!1,success:!1,error:!1,preview:!1,uploadFields:!1,text:this.opts.curLang.drop_file_here,atext:this.opts.curLang.or_choose,uploadParam:!1},e),void 0===window.FormData)return!1;this.droparea=$('<div class=\"redactor_droparea\"></div>'),this.dropareabox=$('<div class=\"redactor_dropareabox\">'+this.draguploadOptions.text+\"</div>\"),this.dropalternative=$('<div class=\"redactor_dropalternative\">'+this.draguploadOptions.atext+\"</div>\"),this.droparea.append(this.dropareabox),$(t).before(this.droparea),$(t).before(this.dropalternative),this.dropareabox.on(\"dragover\",$.proxy(function(){return this.draguploadOndrag()},this)),this.dropareabox.on(\"dragleave\",$.proxy(function(){return this.draguploadOndragleave()},this)),this.dropareabox.get(0).ondrop=$.proxy(function(t){for(var e in t.preventDefault(),this.dropareabox.removeClass(\"hover\").addClass(\"drop\"),this.showProgressBar(),t.dataTransfer.files)t.dataTransfer.files.hasOwnProperty(e)&&this.dragUploadAjax(this.draguploadOptions.url,t.dataTransfer.files[e],!1,t,this.draguploadOptions.uploadParam)},this)},dragUploadAjax:function(t,e,s,o,r){if(!s){var a=$.ajaxSettings.xhr();a.upload&&a.upload.addEventListener(\"progress\",$.proxy(this.uploadProgress,this),!1),$.ajaxSetup({xhr:function(){return a}})}this.callback(\"drop\",o);var n=new FormData;!1!==r?n.append(r,e):n.append(\"file\",e),!1!==this.opts.uploadFields&&\"object\"==typeof this.opts.uploadFields&&$.each(this.opts.uploadFields,$.proxy(function(t,e){null!=e&&0===e.toString().indexOf(\"#\")&&(e=$(e).val()),n.append(t,e)},this)),$.ajax({url:t,dataType:\"html\",async:!1,data:n,cache:!1,contentType:!1,processData:!1,type:\"POST\",success:$.proxy(function(t){var e=\"string\"==typeof(t=(t=t.replace(/^\\[/,\"\")).replace(/\\]$/,\"\"))?$.parseJSON(t):t;if(this.hideProgressBar(),s){var r=$(\"<img>\");r.attr(\"src\",e.image.url).attr(\"id\",\"drag-image-marker\"),this.insertNodeToCaretPositionFromPoint(o,r[0]);var a=$(this.$editor.find(\"img#drag-image-marker\"));a.length?a.removeAttr(\"id\"):a=!1,this.sync(),this.observeImages(),a&&this.callback(\"imageUpload\",a,e),void 0!==e.error&&this.callback(\"imageUploadError\",e)}else void 0===e.error?this.draguploadOptions.success(e):(this.draguploadOptions.error(this,e),this.draguploadOptions.success(!1))},this)})},draguploadOndrag:function(){return this.dropareabox.addClass(\"hover\"),!1},draguploadOndragleave:function(){return this.dropareabox.removeClass(\"hover\"),!1},uploadProgress:function(t,e){var s=t.loaded?parseInt(t.loaded/t.total*100,10):t;this.dropareabox.text(\"Loading \"+s+\"% \"+(e||\"\"))},isMobile:function(){return/(iPhone|iPod|BlackBerry|Android)/.test(navigator.userAgent)},isIPad:function(){return/iPad/.test(navigator.userAgent)},normalize:function(t){return void 0===t?0:parseInt(t.replace(\"px\",\"\"),10)},outerHtml:function(t){return $(\"<div>\").append($(t).eq(0).clone()).html()},stripHtml:function(t){var e=document.createElement(\"DIV\");return e.innerHTML=t,e.textContent||e.innerText||\"\"},isString:function(t){return\"[object String]\"==Object.prototype.toString.call(t)},isEmpty:function(t){return\"\"==(t=(t=(t=t.replace(/&#x200b;|<br>|<br\\/>|&nbsp;/gi,\"\")).replace(/\\s/g,\"\")).replace(/^<p>[^\\W\\w\\D\\d]*?<\\/p>$/i,\"\"))},getInternetExplorerVersion:function(){var t=!1;if(\"Microsoft Internet Explorer\"==navigator.appName){var e=navigator.userAgent;null!=RegExp(\"MSIE ([0-9]{1,}[.0-9]{0,})\").exec(e)&&(t=parseFloat(RegExp.$1))}return t},isIe11:function(){return!!navigator.userAgent.match(/Trident\\/7\\./)},browser:function(t){var e=navigator.userAgent.toLowerCase(),s=/(opr)[\\/]([\\w.]+)/.exec(e)||/(chrome)[ \\/]([\\w.]+)/.exec(e)||/(webkit)[ \\/]([\\w.]+).*(safari)[ \\/]([\\w.]+)/.exec(e)||/(webkit)[ \\/]([\\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \\/]([\\w.]+)/.exec(e)||/(msie) ([\\w.]+)/.exec(e)||e.indexOf(\"trident\")>=0&&/(rv)(?::| )([\\w.]+)/.exec(e)||0>e.indexOf(\"compatible\")&&/(mozilla)(?:.*? rv:([\\w.]+)|)/.exec(e)||[];return\"version\"==t?s[2]:\"webkit\"==t?\"chrome\"==s[1]||\"webkit\"==s[1]:\"rv\"==s[1]?\"msie\"==t:\"opr\"==s[1]?\"webkit\"==t:t==s[1]},oldIE:function(){return!!(this.browser(\"msie\")&&9>parseInt(this.browser(\"version\"),10))},getFragmentHtml:function(t){var e=t.cloneNode(!0),s=this.document.createElement(\"div\");return s.appendChild(e),s.innerHTML},extractContent:function(){for(var t,e=this.$editor[0],s=this.document.createDocumentFragment();t=e.firstChild;)s.appendChild(t);return s},isParentRedactor:function(t){return!!t&&(this.opts.iframe?t:!(0==$(t).parents(\"div.redactor_editor\").length||$(t).hasClass(\"redactor_editor\"))&&t)},currentOrParentIs:function(t){var e=this.getParent(),s=this.getCurrent();return e&&e.tagName===t?e:!!s&&s.tagName===t&&s},isEndOfElement:function(){var t=this.getBlock(),e=this.getCaretOffset(t),s=$.trim($(t).text()).replace(/\\n\\r\\n/g,\"\").length;return e==s},isFocused:function(){var t,e=this.getSelection();return e&&e.rangeCount&&e.rangeCount>0&&(t=e.getRangeAt(0).startContainer),!!t&&(this.opts.iframe?!this.getCaretOffsetRange().equals()||!this.$editor.is(t):0!=$(t).closest(\"div.redactor_editor\").length)},removeEmptyAttr:function(t,e){\"\"==$(t).attr(e)&&$(t).removeAttr(e)},removeFromArrayByValue:function(t,e){for(var s=null;-1!==(s=t.indexOf(e));)t.splice(s,1);return t}},Redactor.prototype.init.prototype=Redactor.prototype,$.Redactor.fn.formatLinkify=function(t,e,s,o,r){for(var a=/(((https?|ftps?):\\/\\/)|www[.][^\\s])(.+?\\..+?)([.),]?)(\\s|\\.\\s+|\\)|$)/gi,n=/(https?|ftp):\\/\\//i,l=/(https?:\\/\\/.*\\.(?:png|jpg|jpeg|gif))/gi,c=(this.$editor?this.$editor.get(0):this).childNodes,h=c.length;h--;){var d=c[h];if(3===d.nodeType){var p=d.nodeValue;if(o&&p){var u='<iframe width=\"500\" height=\"281\" src=\"',f='\" frameborder=\"0\" allowfullscreen></iframe>';p.match(reUrlYoutube)?(p=p.replace(reUrlYoutube,u+\"//www.youtube.com/embed/$1\"+f),$(d).after(p).remove()):p.match(reUrlVimeo)&&(p=p.replace(reUrlVimeo,u+\"//player.vimeo.com/video/$2\"+f),$(d).after(p).remove())}if(s&&p&&p.match(l)&&(p=p.replace(l,'<img src=\"$1\">'),$(d).after(p).remove()),e&&p&&p.match(a)){var m=p.match(a);for(var h in m){var g=m[h],b=g,v=\"\";null!==g.match(/\\s$/)&&(v=\" \");var _=t;null!==g.match(n)&&(_=\"\"),b.length>r&&(b=b.substring(0,r)+\"...\");var y=(b=b.replace(/&/g,\"&amp;\").replace(/</g,\"&lt;\").replace(/>/g,\"&gt;\")).replace(\"$\",\"$$$\");p=p.replace(g,'<a href=\"'+_+$.trim(g)+'\">'+$.trim(y)+\"</a>\"+v)}$(d).after(p).remove()}}else 1!==d.nodeType||/^(a|button|textarea)$/i.test(d.tagName)||$.Redactor.fn.formatLinkify.call(d,t,e,s,o,r)}}}(jQuery);"], "filenames": ["system/controllers/messages/actions/write.php", "system/controllers/messages/frontend.php", "wysiwyg/redactor/files/redactor.js", "wysiwyg/redactor/files/redactor.min.js"], "buggy_code_start_loc": [11, 102, 767, 1], "buggy_code_end_loc": [11, 103, 7839, 2], "fixing_code_start_loc": [12, 102, 768, 1], "fixing_code_end_loc": [17, 112, 7842, 2], "type": "CWE-610", "message": "External Control of System or Configuration Setting in GitHub repository instantsoft/icms2 prior to 2.16.1-git.", "other": {"cve": {"id": "CVE-2023-4704", "sourceIdentifier": "security@huntr.dev", "published": "2023-09-01T10:15:08.587", "lastModified": "2023-09-07T17:36:22.737", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "External Control of System or Configuration Setting in GitHub repository instantsoft/icms2 prior to 2.16.1-git."}, {"lang": "es", "value": "El Control Externo del Sistema o los Ajustes de Configuraci\u00f3n en GitHub en el repositorio instantsoft/icms2 anterior a 2.16.1-git"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:N/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "HIGH", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "NONE", "availabilityImpact": "NONE", "baseScore": 4.9, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 1.2, "impactScore": 3.6}], "cvssMetricV30": [{"source": "security@huntr.dev", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 8.8, "baseSeverity": "HIGH"}, "exploitabilityScore": 2.8, "impactScore": 5.9}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-610"}]}, {"source": "security@huntr.dev", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-15"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:instantcms:instantcms:*:*:*:*:*:*:*:*", "versionEndExcluding": "2.16.1", "matchCriteriaId": "56EF3F9B-6CDB-4568-AF80-EEF6D72B72F6"}]}]}], "references": [{"url": "https://github.com/instantsoft/icms2/commit/bc22d89691fdaf38055eba13dda8d959b16fa731", "source": "security@huntr.dev", "tags": ["Patch"]}, {"url": "https://huntr.dev/bounties/4a54134d-df1f-43d4-9b14-45f023cd654a", "source": "security@huntr.dev", "tags": ["Exploit"]}]}, "github_commit_url": "https://github.com/instantsoft/icms2/commit/bc22d89691fdaf38055eba13dda8d959b16fa731"}}