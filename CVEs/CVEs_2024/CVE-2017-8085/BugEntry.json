{"buggy_code": ["<?php\n\n##################################################\n#\n# Copyright (c) 2004-2017 OIC Group, Inc.\n#\n# This file is part of Exponent\n#\n# Exponent is free software; you can redistribute\n# it and/or modify it under the terms of the GNU\n# General Public License as published by the Free\n# Software Foundation; either version 2 of the\n# License, or (at your option) any later version.\n#\n# GPL: http://www.gnu.org/licenses/gpl.txt\n#\n##################################################\n\n/**\n * Implements elFinder as the 'connector' referenced by 'url' param in elfinder.tpl\n */\n\nrequire_once(\"../../../../exponent.php\");\nif (empty($user->id))\n    exit();\n\nif (DEVELOPMENT) {\n    set_time_limit(0);\n} // just in case it too long, not recommended for production\n\nini_set('max_file_uploads', FM_SIMLIMIT); // allow uploading up to FM_SIMLIMIT files at once\n\n// needed for case insensitive search to work, due to broken UTF-8 support in PHP\n//ini_set('mbstring.internal_encoding', 'UTF-8');\n//ini_set('mbstring.func_overload', 2);\n\ninclude BASE . 'external/elFinder/php/elFinderConnector.class.php';\ninclude BASE . 'external/elFinder/php/elFinder.class.php';\n\ninclude BASE . 'external/elFinder/php/elFinderPlugin.php';\n//include BASE . 'external/elFinder/php/libs/GdBmp.php';  // will also autoload if needed\n//include BASE . 'external/elFinder/php/plugins/AutoResize/plugin.php'; // will also autoload if needed\n//include BASE . 'external/elFinder/php/plugins/AutoRotate/plugin.php';\n//include BASE . 'external/elFinder/php/plugins/Normalizer/plugin.php';\n//include BASE . 'external/elFinder/php/plugins/Sanitizer/plugin.php';\n//include BASE . 'external/elFinder/php/plugins/Watermark/plugin.php';\n//include BASE . 'external/elFinder/php/elFinderSessionInterface.php'; // will also autoload if needed\n//include BASE . 'external/elFinder/php/elFinderSession.php'; // will also autoload if needed\n\ninclude BASE . 'framework/modules/file/connector/elFinderExponent.class.php'; // our custom elFinder object\n\ninclude BASE . 'external/elFinder/php/elFinderVolumeDriver.class.php';\ninclude BASE . 'external/elFinder/php/elFinderVolumeLocalFileSystem.class.php';\n//include BASE . 'external/elFinder/php/elFinderVolumeMySQL.class.php';\n//include BASE . 'external/elFinder/php/elFinderVolumeFTP.class.php';\n//include BASE . 'external/elFinder/php/elFinderVolumeS3.class.php';\ninclude BASE . 'framework/modules/file/connector/elFinderVolumeExponent.class.php'; // our custom elFinder volume driver\n\ndefine('ELFINDER_IMG_PARENT_URL', PATH_RELATIVE . 'external/elFinder/');\n\n/**\n * # Dropbox volume driver need \"dropbox-php's Dropbox\" and \"PHP OAuth extension\" or \"PEAR's HTTP_OAUTH package\"\n * * dropbox-php: http://www.dropbox-php.com/\n * * PHP OAuth extension: http://pecl.php.net/package/oauth\n * * PEAR's HTTP_OAUTH package: http://pear.php.net/package/http_oauth\n *  * HTTP_OAUTH package require HTTP_Request2 and Net_URL2\n */\n// Required for Dropbox.com connector support\n//include BASE . 'external/elFinder/php/elFinderVolumeDropbox.class.php';\n\n// Dropbox driver need next two settings. You can get at https://www.dropbox.com/developers\n// define('ELFINDER_DROPBOX_CONSUMERKEY',    '');\n// define('ELFINDER_DROPBOX_CONSUMERSECRET', '');\n// define('ELFINDER_DROPBOX_META_CACHE_PATH',''); // optional for `options['metaCachePath']`\n\nfunction debug($o)\n{\n    echo '<pre>';\n    print_r($o);\n}\n\n/**\n * example logger function\n * Demonstrate how to work with elFinder event api\n *\n * @param  string   $cmd      command name\n * @param  array    $result   command result\n * @param  array    $args     command arguments from client\n * @param  elFinder $elfinder elFinder instance\n *\n * @return void|true\n * @author Troex Nevelin\n **/\nfunction logger($cmd, $result, $args, $elfinder)\n{\n    if (DEVELOPMENT && LOGGER) {\n        $log = sprintf(\"[%s] %s: %s \\n\", date('r'), strtoupper($cmd), var_export($result, true));\n        $logfile = BASE . 'tmp/elfinder.log';\n        $dir = dirname($logfile);\n        if (!is_dir($dir) && !mkdir($dir, octdec(DIR_DEFAULT_MODE_STR + 0))) {\n            return;\n        }\n        if (($fp = fopen($logfile, 'a'))) {\n            fwrite($fp, $log);\n            fclose($fp);\n        }\n        return;\n\n//        // alternative logging method\n//        foreach ($result as $key => $value) {\n//            if (empty($value)) {\n//                continue;\n//            }\n//            $data = array();\n//            if (in_array($key, array('error', 'warning'))) {\n//                array_push($data, implode(' ', $value));\n//            } else {\n//                if (is_array($value)) { // changes made to files\n//                    foreach ($value as $file) {\n//                        $filepath = (isset($file['realpath']) ? $file['realpath'] : $elfinder->realpath($file['hash']));\n//                        array_push($data, $filepath);\n//                    }\n//                } else { // other value (ex. header)\n//                    array_push($data, $value);\n//                }\n//            }\n//            $log .= sprintf(' %s(%s)', $key, implode(', ', $data));\n//        }\n//        $log .= \"\\n\";\n//\n//        $logfile = BASE . 'tmp/elfinder.log';\n//        $dir = dirname($logfile);\n//        if (!is_dir($dir) && !mkdir($dir)) {\n//            return;\n//        }\n//        if (($fp = fopen($logfile, 'a'))) {\n//            fwrite($fp, $log);\n//            fclose($fp);\n//        }\n    }\n}\n\n/**\n * example logger class\n * Demonstrate how to work with elFinder event api.\n *\n * @package elFinder\n * @author  Dmitry (dio) Levashov\n **/\nclass elFinderSimpleLogger\n{\n\n    /**\n     * Log file path\n     *\n     * @var string\n     **/\n    protected $file = '';\n\n    /**\n     * constructor\n     *\n     * @param $path\n     *\n     * @return \\elFinderSimpleLogger\n     * @author Dmitry (dio) Levashov\n     */\n    public function __construct($path)\n    {\n        $this->file = $path;\n        $dir = dirname($path);\n        if (!is_dir($dir)) {\n            mkdir($dir, octdec(DIR_DEFAULT_MODE_STR + 0));\n        }\n    }\n\n    /**\n     * Create log record\n     *\n     * @param  string   $cmd      command name\n     * @param  array    $result   command result\n     * @param  array    $args     command arguments from client\n     * @param  elFinder $elfinder elFinder instance\n     *\n     * @return void|true\n     * @author Dmitry (dio) Levashov\n     **/\n    public function log($cmd, $result, $args, $elfinder)\n    {\n        if (DEVELOPMENT && LOGGER) {\n            $log = $cmd . ' [' . date('d.m H:s') . \"]\\n\";\n\n            if (!empty($result['error'])) {\n                $log .= \"\\tERROR: \" . implode(' ', $result['error']) . \"\\n\";\n            }\n\n            if (!empty($result['warning'])) {\n                $log .= \"\\tWARNING: \" . implode(' ', $result['warning']) . \"\\n\";\n            }\n\n            if (!empty($result['removed'])) {\n                foreach ($result['removed'] as $file) {\n                    // removed file contain additional field \"realpath\"\n                    $log .= \"\\tREMOVED: \" . $file['realpath'] . \"\\n\";\n                }\n            }\n\n            if (!empty($result['added'])) {\n                foreach ($result['added'] as $file) {\n                    $log .= \"\\tADDED: \" . $elfinder->realpath($file['hash']) . \"\\n\";\n                }\n            }\n\n            if (!empty($result['changed'])) {\n                foreach ($result['changed'] as $file) {\n                    $log .= \"\\tCHANGED: \" . $elfinder->realpath($file['hash']) . \"\\n\";\n                }\n            }\n\n            $this->write($log);\n            $this->write(var_export($result, true), true);\n        }\n    }\n\n    /**\n     * Write log into file\n     *\n     * @param  string $log log record\n     *\n     * @return void\n     * @author Dmitry (dio) Levashov\n     **/\n    protected function write($log, $eol=false)\n    {\n        if ($eol)\n            $eol = \"\\n\";\n        if (($fp = @fopen($this->file, 'a'))) {\n            fwrite($fp, $log . $eol);\n            fclose($fp);\n        }\n    }\n\n} // END class\n//$logger = new elFinderSimpleLogger(BASE.'tmp/elfinder.log');\n\n/**\n * example accessControl function\n * to demonstrate how to control file access using \"accessControl\" callback.\n * This method will disable accessing files/folders starting from  '.' (dot)\n *\n * @param  string    $attr   attribute name (read|write|locked|hidden)\n * @param  string    $path   file path relative to volume root directory started with directory separator\n * @param            $data\n * @param  object    $volume elFinder volume driver object\n * @param  bool|null $isDir  path is directory (true: directory, false: file, null: unknown)\n *\n * @return bool|null\n */\nfunction access($attr, $path, $data, $volume, $isDir) {\n\treturn strpos(basename($path), '.') === 0       // if file/folder begins with '.' (dot)\n\t\t? !($attr == 'read' || $attr == 'write')    // set read+write to false, other (locked+hidden) set to true\n\t\t:  null;                                    // else elFinder decide it itself\n}\n\n/**\n * example accessControl class\n *\n * @author Dmitry (dio) Levashov\n **/\nclass elFinderTestACL\n{\n\n    /**\n     * make dotfiles not readable, not writable, hidden and locked\n     *\n     * @param  string               $attr   attribute name (read|write|locked|hidden)\n     * @param  string               $path   file path. Attention! This is path relative to volume root directory started with directory separator.\n     * @param  mixed                $data   data which seted in 'accessControlData' elFinder option\n     * @param  elFinderVolumeDriver $volume volume driver\n     *\n     * @return bool\n     * @author Dmitry (dio) Levashov\n     **/\n    public function fsAccess($attr, $path, $data, $volume)\n    {\n\n        if ($volume->name() == 'localfilesystem') {\n            return strpos(basename($path), '.') === 0\n                ? !($attr == 'read' || $attr == 'write')\n                : $attr == 'read' || $attr == 'write';\n        }\n\n        return true;\n    }\n\n} // END class\n//$acl = new elFinderTestACL();\n\n/**\n * example acceptedName function\n */\nfunction validName($name)\n{\n    return strpos($name, '.') !== 0;\n}\n\n$opts = array(\n    'locale' => LOCALE . '.' . LANG_CHARSET,\n    'bind'   => array(\n        // '*' => 'logger',\n        'mkdir mkfile rename duplicate upload rm paste' => 'logger', // use function style logger\n//        'mkdir mkfile rename duplicate upload rm paste' => array($logger, 'log'), // use class style logger\n//        'upload.pre mkdir.pre mkfile.pre rename.pre archive.pre ls.pre' => array(\n//            'Plugin.Normalizer.cmdPreprocess',\n//            'Plugin.Sanitizer.cmdPreprocess',\n//        ),\n//        'ls' => array(\n//            'Plugin.Normalizer.cmdPostprocess',\n//            'Plugin.Sanitizer.cmdPostprocess',\n//        ),\n        'upload.presave'                                => array(\n            'Plugin.AutoResize.onUpLoadPreSave',\n//            'Plugin.Watermark.onUpLoadPreSave',\n//            'Plugin.Normalizer.onUpLoadPreSave',\n//            'Plugin.Sanitizer.onUpLoadPreSave',\n//            'Plugin.AutoRotate.onUpLoadPreSave',\n        ),\n    ),\n    // global plugin configure (optional)\n    'plugin' => array(\n        'AutoResize' => array(\n            'enable'     => UPLOAD_WIDTH, // For control by volume driver\n            'maxWidth'   => UPLOAD_WIDTH,\n            'maxHeight'  => UPLOAD_WIDTH,\n            'quality'    => THUMB_QUALITY, // JPEG image save quality\n            'targetType' => IMG_GIF | IMG_JPG | IMG_PNG | IMG_WBMP, // Target image formats ( bit-field )\n//            'forceEffect'    => false,      // For change quality of small images\n//            'preserveExif'   => false,      // Preserve EXIF data (Imagick only)\n        ),\n//        'Watermark' => array(\n//            'enable'         => true,       // For control by volume driver\n//            'source'         => 'logo.png', // Path to Water mark image\n//            'marginRight'    => 5,          // Margin right pixel\n//            'marginBottom'   => 5,          // Margin bottom pixel\n//            'quality'        => THUMB_QUALITY,         // JPEG image save quality\n//            'transparency'   => 70,         // Water mark image transparency ( other than PNG )\n//            'targetType'     => IMG_GIF|IMG_JPG|IMG_PNG|IMG_WBMP, // Target image formats ( bit-field )\n//            'targetMinPixel' => 200         // Target image minimum pixel size\n//        ),\n//        'Normalizer' => array(\n//            'enable' => true,\n//            'nfc'    => true,\n//            'nfkc'   => true,\n//            'lowercase' => false,\n//            'convmap'   => array()\n//        ),\n//       'Sanitizer' => array(\n//           'enable' => true,\n//           'targets'  => array('\\\\','/',':','*','?','\"','<','>','|'), // target chars\n//           'replace'  => '_'    // replace to this\n//        ),\n//        'AutoRotate' => array(\n//            'enable'         => true,       // For control by volume driver\n//            'quality'        => 95          // JPEG image save quality\n//        )\n    ),\n    'debug'  => DEVELOPMENT,\n//\t'netVolumesSessionKey' => 'netVolumes',\n    'callbackWindowURL' => makeLink(array('controller'=>'file','action'=>'picker','ajax_action'=>1)),\n\n    'roots'  => array(\n        array(\n            // 'id' => 'x5',\n            'driver'          => 'Exponent',\n            'path'            => BASE . 'files/',\n            'URL'             => URL_FULL . 'files/',\n            'dirMode'         => octdec(DIR_DEFAULT_MODE_STR + 0),    // new dirs mode (default 0755)\n            'fileMode'        => octdec(FILE_DEFAULT_MODE_STR + 0),   // new files mode (default 0644)\n            'detectDirIcon'   => '.foldericon.png',       // File to be detected as a folder icon image (elFinder >= 2.1.10) e.g. '.favicon.png'\n            'keepTimestamp'   => array('copy', 'move'),   // Keep timestamp at inner filesystem (elFinder >= 2.1.12) It allowed 'copy', 'move' and 'upload'.\n            // 'treeDeep'        => 3,\n            'alias'           => 'files',\n            'disabled'        => array('netmount'),\n//            'maxArcFilesSize' => 100,\n            'accessControl'   => 'access',\n            // 'accessControl' => array($acl, 'fsAccess'),\n            // 'accessControlData' => array('uid' => 1),\n            'uploadAllow'     => array(\n                'application/arj',\n                'application/excel',\n                'application/gnutar',\n                'application/mspowerpoint',\n                'application/msword',\n                'application/octet-stream',\n                'application/onenote',\n                'application/pdf',\n                'application/plain',\n                'application/postscript',\n                'application/powerpoint',\n                'application/rar',\n                'application/rtf',\n                'application/vnd.ms-excel',\n                'application/vnd.ms-excel.addin.macroEnabled.12',\n                'application/vnd.ms-excel.sheet.binary.macroEnabled.12',\n                'application/vnd.ms-excel.sheet.macroEnabled.12',\n                'application/vnd.ms-excel.template.macroEnabled.12',\n                'application/vnd.ms-office',\n                'application/vnd.ms-officetheme',\n                'application/vnd.ms-powerpoint',\n                'application/vnd.ms-powerpoint.addin.macroEnabled.12',\n                'application/vnd.ms-powerpoint.presentation.macroEnabled.12',\n                'application/vnd.ms-powerpoint.slide.macroEnabled.12',\n                'application/vnd.ms-powerpoint.slideshow.macroEnabled.12',\n                'application/vnd.ms-powerpoint.template.macroEnabled.12',\n                'application/vnd.ms-word',\n                'application/vnd.ms-word.document.macroEnabled.12',\n                'application/vnd.ms-word.template.macroEnabled.12',\n                'application/vnd.oasis.opendocument.chart',\n                'application/vnd.oasis.opendocument.database',\n                'application/vnd.oasis.opendocument.formula',\n                'application/vnd.oasis.opendocument.graphics',\n                'application/vnd.oasis.opendocument.graphics-template',\n                'application/vnd.oasis.opendocument.image',\n                'application/vnd.oasis.opendocument.presentation',\n                'application/vnd.oasis.opendocument.presentation-template',\n                'application/vnd.oasis.opendocument.spreadsheet',\n                'application/vnd.oasis.opendocument.spreadsheet-template',\n                'application/vnd.oasis.opendocument.text',\n                'application/vnd.oasis.opendocument.text-master',\n                'application/vnd.oasis.opendocument.text-template',\n                'application/vnd.oasis.opendocument.text-web',\n                'application/vnd.openofficeorg.extension',\n                'application/vnd.openxmlformats-officedocument.presentationml.presentation',\n                'application/vnd.openxmlformats-officedocument.presentationml.slide',\n                'application/vnd.openxmlformats-officedocument.presentationml.slideshow',\n                'application/vnd.openxmlformats-officedocument.presentationml.template',\n                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\n                'application/vnd.openxmlformats-officedocument.spreadsheetml.template',\n                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n                'application/vnd.openxmlformats-officedocument.wordprocessingml.template',\n                'application/vocaltec-media-file',\n                'application/wordperfect',\n                'application/x-bittorrent',\n                'application/x-bzip',\n                'application/x-bzip2',\n                'application/x-compressed',\n                'application/x-excel',\n                'application/x-gzip',\n                'application/x-latex',\n                'application/x-midi',\n                'application/xml',\n                'application/x-msexcel',\n                'application/x-rar',\n                'application/x-rar-compressed',\n                'application/x-rtf',\n                'application/x-shockwave-flash',\n                'application/x-sit',\n                'application/x-stuffit',\n                'application/x-troff-msvideo',\n                'application/x-zip',\n                'application/x-zip-compressed',\n                'application/zip',\n                'audio',\n                'image',\n                'multipart/x-gzip',\n                'multipart/x-zip',\n                'text/plain',\n                'text/rtf',\n                'text/richtext',\n                'text/xml',\n                'video',\n                'text/csv'\n            ),\n            'uploadDeny'      => array(\n                'application/x-shockwave-flash'\n            ),\n            'uploadOrder'     => 'allow,deny',\n            'uploadOverwrite' => true,\n//            'uploadMaxSize'   => '128m',\n            // 'copyOverwrite' => false,\n            'copyJoin'        => true,\n//            'mimeDetect'      => 'internal',\n//            'tmpPath'         => BASE . 'tmp',\n            'tmbCrop'         => false,\n//            'imgLib'          => 'gd',  // 'auto' doesn't seem to work on some servers\n            'tmbPath'         => BASE . 'tmp' . DIRECTORY_SEPARATOR . 'elfinder',\n            'tmbURL'          => URL_FULL . 'tmp/elfinder/',\n            'tmbPathMode'     => octdec(DIR_DEFAULT_MODE_STR + 0),\n            'tmbBgColor'      => 'transparent',\n            'tmbSize'         => FM_THUMB_SIZE,\n            'quarantine'      => '..' . DIRECTORY_SEPARATOR . 'tmp' . DIRECTORY_SEPARATOR . 'elfinder' . DIRECTORY_SEPARATOR . '.quarantine',\n            'acceptedName'    => '/^[^\\.].*$/',\n            // 'acceptedName'    => '/^[\\W]*$/',\n            // 'acceptedName'    => 'validName',\n            'utf8fix'         => false,\n//            'statOwner'       => true,\n            'attributes'      => array(\n                array(\n                    'pattern' => '/^\\/\\./', // dot files are hidden\n                    'read'    => false,\n                    'write'   => false,\n                    'hidden'  => true,\n                    'locked'  => true\n                )\n            )\n        )\n    )\n);\n\n//header('Access-Control-Allow-Origin: *');\n$connector = new elFinderConnector(new elFinderExponent($opts), true);\n$connector->run();\n"], "fixing_code": ["<?php\n\n##################################################\n#\n# Copyright (c) 2004-2017 OIC Group, Inc.\n#\n# This file is part of Exponent\n#\n# Exponent is free software; you can redistribute\n# it and/or modify it under the terms of the GNU\n# General Public License as published by the Free\n# Software Foundation; either version 2 of the\n# License, or (at your option) any later version.\n#\n# GPL: http://www.gnu.org/licenses/gpl.txt\n#\n##################################################\n\n/**\n * Implements elFinder as the 'connector' referenced by 'url' param in elfinder.tpl\n */\n\nrequire_once(\"../../../../exponent.php\");\nif (empty($user->id))\n    exit();\n\nif (DEVELOPMENT) {\n    set_time_limit(0);\n} // just in case it too long, not recommended for production\n\nini_set('max_file_uploads', FM_SIMLIMIT); // allow uploading up to FM_SIMLIMIT files at once\n\n// needed for case insensitive search to work, due to broken UTF-8 support in PHP\n//ini_set('mbstring.internal_encoding', 'UTF-8');\n//ini_set('mbstring.func_overload', 2);\n\ninclude BASE . 'external/elFinder/php/elFinderConnector.class.php';\ninclude BASE . 'external/elFinder/php/elFinder.class.php';\n\ninclude BASE . 'external/elFinder/php/elFinderPlugin.php';\n//include BASE . 'external/elFinder/php/libs/GdBmp.php';  // will also autoload if needed\n//include BASE . 'external/elFinder/php/plugins/AutoResize/plugin.php'; // will also autoload if needed\n//include BASE . 'external/elFinder/php/plugins/AutoRotate/plugin.php';\n//include BASE . 'external/elFinder/php/plugins/Normalizer/plugin.php';\n//include BASE . 'external/elFinder/php/plugins/Sanitizer/plugin.php';\n//include BASE . 'external/elFinder/php/plugins/Watermark/plugin.php';\n//include BASE . 'external/elFinder/php/elFinderSessionInterface.php'; // will also autoload if needed\n//include BASE . 'external/elFinder/php/elFinderSession.php'; // will also autoload if needed\n\ninclude BASE . 'framework/modules/file/connector/elFinderExponent.class.php'; // our custom elFinder object\n\ninclude BASE . 'external/elFinder/php/elFinderVolumeDriver.class.php';\ninclude BASE . 'external/elFinder/php/elFinderVolumeLocalFileSystem.class.php';\n//include BASE . 'external/elFinder/php/elFinderVolumeMySQL.class.php';\n//include BASE . 'external/elFinder/php/elFinderVolumeFTP.class.php';\n//include BASE . 'external/elFinder/php/elFinderVolumeS3.class.php';\ninclude BASE . 'framework/modules/file/connector/elFinderVolumeExponent.class.php'; // our custom elFinder volume driver\n\ndefine('ELFINDER_IMG_PARENT_URL', PATH_RELATIVE . 'external/elFinder/');\n\n/**\n * # Dropbox volume driver need \"dropbox-php's Dropbox\" and \"PHP OAuth extension\" or \"PEAR's HTTP_OAUTH package\"\n * * dropbox-php: http://www.dropbox-php.com/\n * * PHP OAuth extension: http://pecl.php.net/package/oauth\n * * PEAR's HTTP_OAUTH package: http://pear.php.net/package/http_oauth\n *  * HTTP_OAUTH package require HTTP_Request2 and Net_URL2\n */\n// Required for Dropbox.com connector support\n//include BASE . 'external/elFinder/php/elFinderVolumeDropbox.class.php';\n\n// Dropbox driver need next two settings. You can get at https://www.dropbox.com/developers\n// define('ELFINDER_DROPBOX_CONSUMERKEY',    '');\n// define('ELFINDER_DROPBOX_CONSUMERSECRET', '');\n// define('ELFINDER_DROPBOX_META_CACHE_PATH',''); // optional for `options['metaCachePath']`\n\nfunction debug($o)\n{\n    echo '<pre>';\n    print_r($o);\n}\n\n/**\n * example logger function\n * Demonstrate how to work with elFinder event api\n *\n * @param  string   $cmd      command name\n * @param  array    $result   command result\n * @param  array    $args     command arguments from client\n * @param  elFinder $elfinder elFinder instance\n *\n * @return void|true\n * @author Troex Nevelin\n **/\nfunction logger($cmd, $result, $args, $elfinder)\n{\n    if (DEVELOPMENT && LOGGER) {\n        $log = sprintf(\"[%s] %s: %s \\n\", date('r'), strtoupper($cmd), var_export($result, true));\n        $logfile = BASE . 'tmp/elfinder.log';\n        $dir = dirname($logfile);\n        if (!is_dir($dir) && !mkdir($dir, octdec(DIR_DEFAULT_MODE_STR + 0))) {\n            return;\n        }\n        if (($fp = fopen($logfile, 'a'))) {\n            fwrite($fp, $log);\n            fclose($fp);\n        }\n        return;\n\n//        // alternative logging method\n//        foreach ($result as $key => $value) {\n//            if (empty($value)) {\n//                continue;\n//            }\n//            $data = array();\n//            if (in_array($key, array('error', 'warning'))) {\n//                array_push($data, implode(' ', $value));\n//            } else {\n//                if (is_array($value)) { // changes made to files\n//                    foreach ($value as $file) {\n//                        $filepath = (isset($file['realpath']) ? $file['realpath'] : $elfinder->realpath($file['hash']));\n//                        array_push($data, $filepath);\n//                    }\n//                } else { // other value (ex. header)\n//                    array_push($data, $value);\n//                }\n//            }\n//            $log .= sprintf(' %s(%s)', $key, implode(', ', $data));\n//        }\n//        $log .= \"\\n\";\n//\n//        $logfile = BASE . 'tmp/elfinder.log';\n//        $dir = dirname($logfile);\n//        if (!is_dir($dir) && !mkdir($dir)) {\n//            return;\n//        }\n//        if (($fp = fopen($logfile, 'a'))) {\n//            fwrite($fp, $log);\n//            fclose($fp);\n//        }\n    }\n}\n\n/**\n * example logger class\n * Demonstrate how to work with elFinder event api.\n *\n * @package elFinder\n * @author  Dmitry (dio) Levashov\n **/\nclass elFinderSimpleLogger\n{\n\n    /**\n     * Log file path\n     *\n     * @var string\n     **/\n    protected $file = '';\n\n    /**\n     * constructor\n     *\n     * @param $path\n     *\n     * @return \\elFinderSimpleLogger\n     * @author Dmitry (dio) Levashov\n     */\n    public function __construct($path)\n    {\n        $this->file = $path;\n        $dir = dirname($path);\n        if (!is_dir($dir)) {\n            mkdir($dir, octdec(DIR_DEFAULT_MODE_STR + 0));\n        }\n    }\n\n    /**\n     * Create log record\n     *\n     * @param  string   $cmd      command name\n     * @param  array    $result   command result\n     * @param  array    $args     command arguments from client\n     * @param  elFinder $elfinder elFinder instance\n     *\n     * @return void|true\n     * @author Dmitry (dio) Levashov\n     **/\n    public function log($cmd, $result, $args, $elfinder)\n    {\n        if (DEVELOPMENT && LOGGER) {\n            $log = $cmd . ' [' . date('d.m H:s') . \"]\\n\";\n\n            if (!empty($result['error'])) {\n                $log .= \"\\tERROR: \" . implode(' ', $result['error']) . \"\\n\";\n            }\n\n            if (!empty($result['warning'])) {\n                $log .= \"\\tWARNING: \" . implode(' ', $result['warning']) . \"\\n\";\n            }\n\n            if (!empty($result['removed'])) {\n                foreach ($result['removed'] as $file) {\n                    // removed file contain additional field \"realpath\"\n                    $log .= \"\\tREMOVED: \" . $file['realpath'] . \"\\n\";\n                }\n            }\n\n            if (!empty($result['added'])) {\n                foreach ($result['added'] as $file) {\n                    $log .= \"\\tADDED: \" . $elfinder->realpath($file['hash']) . \"\\n\";\n                }\n            }\n\n            if (!empty($result['changed'])) {\n                foreach ($result['changed'] as $file) {\n                    $log .= \"\\tCHANGED: \" . $elfinder->realpath($file['hash']) . \"\\n\";\n                }\n            }\n\n            $this->write($log);\n            $this->write(var_export($result, true), true);\n        }\n    }\n\n    /**\n     * Write log into file\n     *\n     * @param  string $log log record\n     *\n     * @return void\n     * @author Dmitry (dio) Levashov\n     **/\n    protected function write($log, $eol=false)\n    {\n        if ($eol)\n            $eol = \"\\n\";\n        if (($fp = @fopen($this->file, 'a'))) {\n            fwrite($fp, $log . $eol);\n            fclose($fp);\n        }\n    }\n\n} // END class\n//$logger = new elFinderSimpleLogger(BASE.'tmp/elfinder.log');\n\n/**\n * example accessControl function\n * to demonstrate how to control file access using \"accessControl\" callback.\n * This method will disable accessing files/folders starting from  '.' (dot)\n *\n * @param  string    $attr   attribute name (read|write|locked|hidden)\n * @param  string    $path   file path relative to volume root directory started with directory separator\n * @param            $data\n * @param  object    $volume elFinder volume driver object\n * @param  bool|null $isDir  path is directory (true: directory, false: file, null: unknown)\n *\n * @return bool|null\n */\nfunction access($attr, $path, $data, $volume, $isDir) {\n\treturn strpos(basename($path), '.') === 0       // if file/folder begins with '.' (dot)\n\t\t? !($attr == 'read' || $attr == 'write')    // set read+write to false, other (locked+hidden) set to true\n\t\t:  null;                                    // else elFinder decide it itself\n}\n\n/**\n * example accessControl class\n *\n * @author Dmitry (dio) Levashov\n **/\nclass elFinderTestACL\n{\n\n    /**\n     * make dotfiles not readable, not writable, hidden and locked\n     *\n     * @param  string               $attr   attribute name (read|write|locked|hidden)\n     * @param  string               $path   file path. Attention! This is path relative to volume root directory started with directory separator.\n     * @param  mixed                $data   data which seted in 'accessControlData' elFinder option\n     * @param  elFinderVolumeDriver $volume volume driver\n     *\n     * @return bool\n     * @author Dmitry (dio) Levashov\n     **/\n    public function fsAccess($attr, $path, $data, $volume)\n    {\n\n        if ($volume->name() == 'localfilesystem') {\n            return strpos(basename($path), '.') === 0\n                ? !($attr == 'read' || $attr == 'write')\n                : $attr == 'read' || $attr == 'write';\n        }\n\n        return true;\n    }\n\n} // END class\n//$acl = new elFinderTestACL();\n\n/**\n * example acceptedName function\n */\nfunction validName($name)\n{\n    return strpos($name, '.') !== 0;\n}\n\n$opts = array(\n    'locale' => LOCALE . '.' . LANG_CHARSET,\n    'bind'   => array(\n        // '*' => 'logger',\n        'mkdir mkfile rename duplicate upload rm paste' => 'logger', // use function style logger\n//        'mkdir mkfile rename duplicate upload rm paste' => array($logger, 'log'), // use class style logger\n//        'upload.pre mkdir.pre mkfile.pre rename.pre archive.pre ls.pre' => array(\n//            'Plugin.Normalizer.cmdPreprocess',\n//            'Plugin.Sanitizer.cmdPreprocess',\n//        ),\n//        'ls' => array(\n//            'Plugin.Normalizer.cmdPostprocess',\n//            'Plugin.Sanitizer.cmdPostprocess',\n//        ),\n        'upload.presave'                                => array(\n            'Plugin.AutoResize.onUpLoadPreSave',\n//            'Plugin.Watermark.onUpLoadPreSave',\n//            'Plugin.Normalizer.onUpLoadPreSave',\n//            'Plugin.Sanitizer.onUpLoadPreSave',\n//            'Plugin.AutoRotate.onUpLoadPreSave',\n        ),\n    ),\n    // global plugin configure (optional)\n    'plugin' => array(\n        'AutoResize' => array(\n            'enable'     => UPLOAD_WIDTH, // For control by volume driver\n            'maxWidth'   => UPLOAD_WIDTH,\n            'maxHeight'  => UPLOAD_WIDTH,\n            'quality'    => THUMB_QUALITY, // JPEG image save quality\n            'targetType' => IMG_GIF | IMG_JPG | IMG_PNG | IMG_WBMP, // Target image formats ( bit-field )\n//            'forceEffect'    => false,      // For change quality of small images\n//            'preserveExif'   => false,      // Preserve EXIF data (Imagick only)\n        ),\n//        'Watermark' => array(\n//            'enable'         => true,       // For control by volume driver\n//            'source'         => 'logo.png', // Path to Water mark image\n//            'marginRight'    => 5,          // Margin right pixel\n//            'marginBottom'   => 5,          // Margin bottom pixel\n//            'quality'        => THUMB_QUALITY,         // JPEG image save quality\n//            'transparency'   => 70,         // Water mark image transparency ( other than PNG )\n//            'targetType'     => IMG_GIF|IMG_JPG|IMG_PNG|IMG_WBMP, // Target image formats ( bit-field )\n//            'targetMinPixel' => 200         // Target image minimum pixel size\n//        ),\n//        'Normalizer' => array(\n//            'enable' => true,\n//            'nfc'    => true,\n//            'nfkc'   => true,\n//            'lowercase' => false,\n//            'convmap'   => array()\n//        ),\n//       'Sanitizer' => array(\n//           'enable' => true,\n//           'targets'  => array('\\\\','/',':','*','?','\"','<','>','|'), // target chars\n//           'replace'  => '_'    // replace to this\n//        ),\n//        'AutoRotate' => array(\n//            'enable'         => true,       // For control by volume driver\n//            'quality'        => 95          // JPEG image save quality\n//        )\n    ),\n    'debug'  => DEVELOPMENT,\n//\t'netVolumesSessionKey' => 'netVolumes',\n    'callbackWindowURL' => makeLink(array('controller'=>'file','action'=>'picker','ajax_action'=>1)),\n\n    'roots'  => array(\n        array(\n            // 'id' => 'x5',\n            'driver'          => 'Exponent',\n            'path'            => BASE . 'files/',\n            'URL'             => URL_FULL . 'files/',\n            'dirMode'         => octdec(DIR_DEFAULT_MODE_STR + 0),    // new dirs mode (default 0755)\n            'fileMode'        => octdec(FILE_DEFAULT_MODE_STR + 0),   // new files mode (default 0644)\n            'detectDirIcon'   => '.foldericon.png',       // File to be detected as a folder icon image (elFinder >= 2.1.10) e.g. '.favicon.png'\n            'keepTimestamp'   => array('copy', 'move'),   // Keep timestamp at inner filesystem (elFinder >= 2.1.12) It allowed 'copy', 'move' and 'upload'.\n            // 'treeDeep'        => 3,\n            'alias'           => 'files',\n            'disabled'        => array('netmount'),\n//            'maxArcFilesSize' => 100,\n            'accessControl'   => 'access',\n            // 'accessControl' => array($acl, 'fsAccess'),\n            // 'accessControlData' => array('uid' => 1),\n            'uploadAllow'     => array(\n                'application/arj',\n                'application/excel',\n                'application/gnutar',\n                'application/mspowerpoint',\n                'application/msword',\n                'application/octet-stream',\n                'application/onenote',\n                'application/pdf',\n                'application/plain',\n                'application/postscript',\n                'application/powerpoint',\n                'application/rar',\n                'application/rtf',\n                'application/vnd.ms-excel',\n                'application/vnd.ms-excel.addin.macroEnabled.12',\n                'application/vnd.ms-excel.sheet.binary.macroEnabled.12',\n                'application/vnd.ms-excel.sheet.macroEnabled.12',\n                'application/vnd.ms-excel.template.macroEnabled.12',\n                'application/vnd.ms-office',\n                'application/vnd.ms-officetheme',\n                'application/vnd.ms-powerpoint',\n                'application/vnd.ms-powerpoint.addin.macroEnabled.12',\n                'application/vnd.ms-powerpoint.presentation.macroEnabled.12',\n                'application/vnd.ms-powerpoint.slide.macroEnabled.12',\n                'application/vnd.ms-powerpoint.slideshow.macroEnabled.12',\n                'application/vnd.ms-powerpoint.template.macroEnabled.12',\n                'application/vnd.ms-word',\n                'application/vnd.ms-word.document.macroEnabled.12',\n                'application/vnd.ms-word.template.macroEnabled.12',\n                'application/vnd.oasis.opendocument.chart',\n                'application/vnd.oasis.opendocument.database',\n                'application/vnd.oasis.opendocument.formula',\n                'application/vnd.oasis.opendocument.graphics',\n                'application/vnd.oasis.opendocument.graphics-template',\n                'application/vnd.oasis.opendocument.image',\n                'application/vnd.oasis.opendocument.presentation',\n                'application/vnd.oasis.opendocument.presentation-template',\n                'application/vnd.oasis.opendocument.spreadsheet',\n                'application/vnd.oasis.opendocument.spreadsheet-template',\n                'application/vnd.oasis.opendocument.text',\n                'application/vnd.oasis.opendocument.text-master',\n                'application/vnd.oasis.opendocument.text-template',\n                'application/vnd.oasis.opendocument.text-web',\n                'application/vnd.openofficeorg.extension',\n                'application/vnd.openxmlformats-officedocument.presentationml.presentation',\n                'application/vnd.openxmlformats-officedocument.presentationml.slide',\n                'application/vnd.openxmlformats-officedocument.presentationml.slideshow',\n                'application/vnd.openxmlformats-officedocument.presentationml.template',\n                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\n                'application/vnd.openxmlformats-officedocument.spreadsheetml.template',\n                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n                'application/vnd.openxmlformats-officedocument.wordprocessingml.template',\n                'application/vocaltec-media-file',\n                'application/wordperfect',\n                'application/x-bittorrent',\n                'application/x-bzip',\n                'application/x-bzip2',\n                'application/x-compressed',\n                'application/x-excel',\n                'application/x-gzip',\n                'application/x-latex',\n                'application/x-midi',\n                'application/xml',\n                'application/x-msexcel',\n                'application/x-rar',\n                'application/x-rar-compressed',\n                'application/x-rtf',\n                'application/x-shockwave-flash',\n                'application/x-sit',\n                'application/x-stuffit',\n                'application/x-troff-msvideo',\n                'application/x-zip',\n                'application/x-zip-compressed',\n                'application/zip',\n                'audio',\n                'image',\n                'multipart/x-gzip',\n                'multipart/x-zip',\n                'text/plain',\n                'text/rtf',\n                'text/richtext',\n                'text/xml',\n                'video',\n                'text/csv'\n            ),\n            'uploadDeny'      => array(\n                'application/x-shockwave-flash'\n            ),\n            'uploadOrder'     => 'allow,deny',\n            'uploadOverwrite' => true,\n//            'uploadMaxSize'   => '128m',\n            // 'copyOverwrite' => false,\n            'copyJoin'        => true,\n//            'mimeDetect'      => 'internal',\n//            'tmpPath'         => BASE . 'tmp',\n            'tmbCrop'         => false,\n//            'imgLib'          => 'gd',  // 'auto' doesn't seem to work on some servers\n            'tmbPath'         => BASE . 'tmp' . DIRECTORY_SEPARATOR . 'elfinder',\n            'tmbURL'          => URL_FULL . 'tmp/elfinder/',\n            'tmbPathMode'     => octdec(DIR_DEFAULT_MODE_STR + 0),\n            'tmbBgColor'      => 'transparent',\n            'tmbSize'         => FM_THUMB_SIZE,\n            'quarantine'      => '..' . DIRECTORY_SEPARATOR . 'tmp' . DIRECTORY_SEPARATOR . 'elfinder' . DIRECTORY_SEPARATOR . '.quarantine',\n            'acceptedName'    => '/^[^\\.].*$/',\n            // 'acceptedName'    => '/^[\\W]*$/',\n            // 'acceptedName'    => 'validName',\n            'utf8fix'         => false,\n//            'statOwner'       => true,\n            'attributes'      => array(\n                array(\n                    'pattern' => '/^\\/\\./', // dot files are hidden\n                    'read'    => false,\n                    'write'   => false,\n                    'hidden'  => true,\n                    'locked'  => true\n                )\n            )\n        )\n    )\n);\n\n//header('Access-Control-Allow-Origin: *');\n$connector = new elFinderConnector(new elFinderExponent($opts));\n$connector->run();\n"], "filenames": ["framework/modules/file/connector/elfinder.php"], "buggy_code_start_loc": [512], "buggy_code_end_loc": [513], "fixing_code_start_loc": [512], "fixing_code_end_loc": [513], "type": "CWE-79", "message": "In Exponent CMS before 2.4.1 Patch #5, XSS in elFinder is possible in framework/modules/file/connector/elfinder.php.", "other": {"cve": {"id": "CVE-2017-8085", "sourceIdentifier": "cve@mitre.org", "published": "2017-04-24T14:59:00.183", "lastModified": "2017-04-29T01:59:02.130", "vulnStatus": "Modified", "descriptions": [{"lang": "en", "value": "In Exponent CMS before 2.4.1 Patch #5, XSS in elFinder is possible in framework/modules/file/connector/elfinder.php."}, {"lang": "es", "value": "En Exponent CMS en versiones anteriores a 2.4.1 Patch #5, XSS en elFinder es posible en framework/modules/file/connector/elfinder.php."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:exponentcms:exponent_cms:*:p4:*:*:*:*:*:*", "versionEndIncluding": "2.4.0", "matchCriteriaId": "BFC75474-A888-413E-B7EF-E76FE79504B9"}]}]}], "references": [{"url": "http://www.exponentcms.org/news/patch-5-released-for-v2-4-1-to-fix-a-few-critical-issues", "source": "cve@mitre.org", "tags": ["Patch", "Vendor Advisory"]}, {"url": "http://www.securityfocus.com/bid/98043", "source": "cve@mitre.org"}, {"url": "https://github.com/exponentcms/exponent-cms/commit/0b2241ff1c7d86376fa260c5d4c1714f6cef9c0f", "source": "cve@mitre.org", "tags": ["Patch"]}, {"url": "https://github.com/exponentcms/exponent-cms/releases/tag/v2.4.1patch5", "source": "cve@mitre.org", "tags": ["Patch", "Vendor Advisory"]}]}, "github_commit_url": "https://github.com/exponentcms/exponent-cms/commit/0b2241ff1c7d86376fa260c5d4c1714f6cef9c0f"}}