{"buggy_code": ["<?php\n/* Icinga Web 2 | (c) 2015 Icinga Development Team | GPLv2+ */\n\nnamespace Icinga\\Forms\\Config\\Resource;\n\nuse Icinga\\Application\\Icinga;\nuse Icinga\\Data\\ConfigObject;\nuse Icinga\\Forms\\Config\\ResourceConfigForm;\nuse Icinga\\Web\\Form;\nuse Icinga\\Util\\File;\nuse Zend_Validate_Callback;\n\n/**\n * Form class for adding/modifying ssh identity resources\n */\nclass SshResourceForm extends Form\n{\n    /**\n     * Initialize this form\n     */\n    public function init()\n    {\n        $this->setName('form_config_resource_ssh');\n    }\n\n    /**\n     * @see Form::createElements()\n     */\n    public function createElements(array $formData)\n    {\n        $this->addElement(\n            'text',\n            'name',\n            array(\n                'required'      => true,\n                'label'         => $this->translate('Resource Name'),\n                'description'   => $this->translate('The unique name of this resource')\n            )\n        );\n        $this->addElement(\n            'text',\n            'user',\n            array(\n                'required'      => true,\n                'label'         => $this->translate('User'),\n                'description'   => $this->translate(\n                    'User to log in as on the remote Icinga instance. Please note that key-based SSH login must be'\n                    . ' possible for this user'\n                )\n            )\n        );\n\n        if ($this->getRequest()->getActionName() != 'editresource') {\n            $callbackValidator = new Zend_Validate_Callback(function ($value) {\n                if (openssl_pkey_get_private($value) === false) {\n                    return false;\n                }\n                return true;\n            });\n            $callbackValidator->setMessage(\n                $this->translate('The given SSH key is invalid'),\n                Zend_Validate_Callback::INVALID_VALUE\n            );\n\n            $this->addElement(\n                'textarea',\n                'private_key',\n                array(\n                    'required'      => true,\n                    'label'         => $this->translate('Private Key'),\n                    'description'   => $this->translate('The private key which will be used for the SSH connections'),\n                    'class'         => 'resource ssh-identity',\n                    'validators'    => array($callbackValidator)\n                )\n            );\n        } else {\n            $resourceName = $formData['name'];\n            $this->addElement(\n                'note',\n                'private_key_note',\n                array(\n                    'escape'        => false,\n                    'label'         => $this->translate('Private Key'),\n                    'value'         => sprintf(\n                        '<a href=\"%1$s\" data-base-target=\"_next\" title=\"%2$s\" aria-label=\"%2$s\">%3$s</a>',\n                        $this->getView()->url('config/removeresource', array('resource' => $resourceName)),\n                        sprintf($this->translate(\n                            'Remove the %s resource'\n                        ), $resourceName),\n                        $this->translate('To modify the private key you must recreate this resource.')\n                    )\n                )\n            );\n        }\n\n        return $this;\n    }\n\n    /**\n     * Remove the assigned key to the resource\n     *\n     * @param ConfigObject $config\n     *\n     * @return bool\n     */\n    public static function beforeRemove(ConfigObject $config)\n    {\n        $file = $config->private_key;\n\n        if (file_exists($file)) {\n            unlink($file);\n            return true;\n        }\n        return false;\n    }\n\n    /**\n     * Creates the assigned key to the resource\n     *\n     * @param ResourceConfigForm $form\n     *\n     * @return bool\n     */\n    public static function beforeAdd(ResourceConfigForm $form)\n    {\n        $configDir = Icinga::app()->getConfigDir();\n        $user = $form->getElement('user')->getValue();\n\n        $filePath = $configDir . '/ssh/' . $user;\n\n        if (! file_exists($filePath)) {\n            $file = File::create($filePath, 0600);\n        } else {\n            $form->error(\n                sprintf($form->translate('The private key for the user \"%s\" is already exists.'), $user)\n            );\n            return false;\n        }\n\n        $file->fwrite($form->getElement('private_key')->getValue());\n\n        $form->getElement('private_key')->setValue($configDir . '/ssh/' . $user);\n\n        return true;\n    }\n}\n"], "fixing_code": ["<?php\n/* Icinga Web 2 | (c) 2015 Icinga Development Team | GPLv2+ */\n\nnamespace Icinga\\Forms\\Config\\Resource;\n\nuse Icinga\\Application\\Icinga;\nuse Icinga\\Data\\ConfigObject;\nuse Icinga\\Forms\\Config\\ResourceConfigForm;\nuse Icinga\\Web\\Form;\nuse Icinga\\Util\\File;\nuse Zend_Validate_Callback;\n\n/**\n * Form class for adding/modifying ssh identity resources\n */\nclass SshResourceForm extends Form\n{\n    /**\n     * Initialize this form\n     */\n    public function init()\n    {\n        $this->setName('form_config_resource_ssh');\n    }\n\n    /**\n     * @see Form::createElements()\n     */\n    public function createElements(array $formData)\n    {\n        $this->addElement(\n            'text',\n            'name',\n            array(\n                'required'      => true,\n                'label'         => $this->translate('Resource Name'),\n                'description'   => $this->translate('The unique name of this resource')\n            )\n        );\n        $this->addElement(\n            'text',\n            'user',\n            array(\n                'required'      => true,\n                'label'         => $this->translate('User'),\n                'description'   => $this->translate(\n                    'User to log in as on the remote Icinga instance. Please note that key-based SSH login must be'\n                    . ' possible for this user'\n                )\n            )\n        );\n\n        if ($this->getRequest()->getActionName() != 'editresource') {\n            $callbackValidator = new Zend_Validate_Callback(function ($value) {\n                if (\n                    substr(ltrim($value), 0, 7) === 'file://'\n                    || openssl_pkey_get_private($value) === false\n                ) {\n                    return false;\n                }\n\n                return true;\n            });\n            $callbackValidator->setMessage(\n                $this->translate('The given SSH key is invalid'),\n                Zend_Validate_Callback::INVALID_VALUE\n            );\n\n            $this->addElement(\n                'textarea',\n                'private_key',\n                array(\n                    'required'      => true,\n                    'label'         => $this->translate('Private Key'),\n                    'description'   => $this->translate('The private key which will be used for the SSH connections'),\n                    'class'         => 'resource ssh-identity',\n                    'validators'    => array($callbackValidator)\n                )\n            );\n        } else {\n            $resourceName = $formData['name'];\n            $this->addElement(\n                'note',\n                'private_key_note',\n                array(\n                    'escape'        => false,\n                    'label'         => $this->translate('Private Key'),\n                    'value'         => sprintf(\n                        '<a href=\"%1$s\" data-base-target=\"_next\" title=\"%2$s\" aria-label=\"%2$s\">%3$s</a>',\n                        $this->getView()->url('config/removeresource', array('resource' => $resourceName)),\n                        sprintf($this->translate(\n                            'Remove the %s resource'\n                        ), $resourceName),\n                        $this->translate('To modify the private key you must recreate this resource.')\n                    )\n                )\n            );\n        }\n\n        return $this;\n    }\n\n    /**\n     * Remove the assigned key to the resource\n     *\n     * @param ConfigObject $config\n     *\n     * @return bool\n     */\n    public static function beforeRemove(ConfigObject $config)\n    {\n        $file = $config->private_key;\n\n        if (file_exists($file)) {\n            unlink($file);\n            return true;\n        }\n        return false;\n    }\n\n    /**\n     * Creates the assigned key to the resource\n     *\n     * @param ResourceConfigForm $form\n     *\n     * @return bool\n     */\n    public static function beforeAdd(ResourceConfigForm $form)\n    {\n        $configDir = Icinga::app()->getConfigDir();\n        $user = $form->getElement('user')->getValue();\n\n        $filePath = join(DIRECTORY_SEPARATOR, [$configDir, 'ssh', sha1($user)]);\n        if (! file_exists($filePath)) {\n            $file = File::create($filePath, 0600);\n        } else {\n            $form->error(\n                sprintf($form->translate('The private key for the user \"%s\" already exists.'), $user)\n            );\n            return false;\n        }\n\n        $file->fwrite($form->getElement('private_key')->getValue());\n\n        $form->getElement('private_key')->setValue($filePath);\n\n        return true;\n    }\n}\n"], "filenames": ["application/forms/Config/Resource/SshResourceForm.php"], "buggy_code_start_loc": [55], "buggy_code_end_loc": [143], "fixing_code_start_loc": [55], "fixing_code_end_loc": [146], "type": "CWE-22", "message": "Icinga Web 2 is an open source monitoring web interface, framework and command-line interface. Authenticated users, with access to the configuration, can create SSH resource files in unintended directories, leading to the execution of arbitrary code. This issue has been resolved in versions 2.8.6, 2.9.6 and 2.10 of Icinga Web 2. Users unable to upgrade should limit access to the Icinga Web 2 configuration.", "other": {"cve": {"id": "CVE-2022-24715", "sourceIdentifier": "security-advisories@github.com", "published": "2022-03-08T20:15:07.777", "lastModified": "2022-11-09T21:26:01.197", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Icinga Web 2 is an open source monitoring web interface, framework and command-line interface. Authenticated users, with access to the configuration, can create SSH resource files in unintended directories, leading to the execution of arbitrary code. This issue has been resolved in versions 2.8.6, 2.9.6 and 2.10 of Icinga Web 2. Users unable to upgrade should limit access to the Icinga Web 2 configuration."}, {"lang": "es", "value": "Icinga Web 2 es una interfaz web de monitorizaci\u00f3n de c\u00f3digo abierto, un framework y una interfaz de l\u00ednea de comandos. Los usuarios autenticados, con acceso a la configuraci\u00f3n, pueden crear archivos de recursos SSH en directorios no deseados, conllevando a una ejecuci\u00f3n de c\u00f3digo arbitrario. Este problema ha sido resuelto en las versiones 2.8.6, 2.9.6 y 2.10 de Icinga Web 2. Los usuarios que no puedan actualizarse deber\u00e1n limitar el acceso a la configuraci\u00f3n de Icinga Web 2"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 8.8, "baseSeverity": "HIGH"}, "exploitabilityScore": 2.8, "impactScore": 5.9}, {"source": "security-advisories@github.com", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:C/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "HIGH", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "CHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 8.5, "baseSeverity": "HIGH"}, "exploitabilityScore": 1.8, "impactScore": 6.0}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:S/C:P/I:P/A:P", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "SINGLE", "confidentialityImpact": "PARTIAL", "integrityImpact": "PARTIAL", "availabilityImpact": "PARTIAL", "baseScore": 6.0}, "baseSeverity": "MEDIUM", "exploitabilityScore": 6.8, "impactScore": 6.4, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "security-advisories@github.com", "type": "Primary", "description": [{"lang": "en", "value": "CWE-22"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:icinga:icinga_web_2:*:*:*:*:*:*:*:*", "versionEndExcluding": "2.8.6", "matchCriteriaId": "31515B3D-01CA-4B3C-AF94-AD63FDE7F8B7"}, {"vulnerable": true, "criteria": "cpe:2.3:a:icinga:icinga_web_2:*:*:*:*:*:*:*:*", "versionStartIncluding": "2.9.0", "versionEndExcluding": "2.9.6", "matchCriteriaId": "CE7D185F-C8C8-4401-B8F5-580DF83D5D79"}]}]}], "references": [{"url": "https://github.com/Icinga/icingaweb2/commit/a06d915467ca943a4b406eb9587764b8ec34cafb", "source": "security-advisories@github.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/Icinga/icingaweb2/security/advisories/GHSA-v9mv-h52f-7g63", "source": "security-advisories@github.com", "tags": ["Third Party Advisory"]}, {"url": "https://security.gentoo.org/glsa/202208-05", "source": "security-advisories@github.com", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/Icinga/icingaweb2/commit/a06d915467ca943a4b406eb9587764b8ec34cafb"}}