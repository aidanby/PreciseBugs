{"buggy_code": ["<?php\n/*\n\tFusionPBX\n\tVersion: MPL 1.1\n\n\tThe contents of this file are subject to the Mozilla Public License Version\n\t1.1 (the \"License\"); you may not use this file except in compliance with\n\tthe License. You may obtain a copy of the License at\n\thttp://www.mozilla.org/MPL/\n\n\tSoftware distributed under the License is distributed on an \"AS IS\" basis,\n\tWITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n\tfor the specific language governing rights and limitations under the\n\tLicense.\n\n\tThe Original Code is FusionPBX\n\n\tThe Initial Developer of the Original Code is\n\tMark J Crane <markjcrane@fusionpbx.com>\n\tPortions created by the Initial Developer are Copyright (C) 2008-2019\n\tthe Initial Developer. All Rights Reserved.\n\n\tContributor(s):\n\tMark J Crane <markjcrane@fusionpbx.com>\n*/\n\n//includes\n\tinclude \"root.php\";\n\trequire_once \"resources/require.php\";\n\trequire_once \"resources/check_auth.php\";\n\trequire_once \"resources/paging.php\";\n\n//check permissions\n\tif (permission_exists('dialplan_view')) {\n\t\t//access granted\n\t}\n\telse {\n\t\techo \"access denied\";\n\t\texit;\n\t}\n\n//add multi-lingual support\n\t$language = new text;\n\t$text = $language->get();\n\n//get posted data\n\tif (is_array($_POST['dialplans'])) {\n\t\t$app_uuid = $_POST['app_uuid'];\n\t\t$action = $_POST['action'];\n\t\t$dialplans = $_POST['dialplans'];\n\t\t$search = $_POST['search'];\n\t\t$order_by = $_POST['order_by'];\n\t\t$order = $_POST['order'];\n\t}\n\n//process action\n\tif ($action && is_array($dialplans) && @sizeof($dialplans) != 0) {\n\n\t\t//define redirect parameters and url\n\t\t\tif (is_uuid($app_uuid)) { $params[] = \"app_uuid=\".urlencode($app_uuid); }\n\t\t\tif ($search) { $params[] = \"search=\".urlencode($search); }\n\t\t\tif ($order_by) { $params[] = \"order_by=\".urlencode($order_by); }\n\t\t\tif ($order) { $params[] = \"order=\".urlencode($order); }\n\t\t\t$redirect_url = 'dialplans.php'.($params ? '?'.implode('&', $params) : null);\n\t\t\tunset($params);\n\n\t\t//copy the dialplans\n\t\t\tif ($action == 'copy') {\n\t\t\t\t$obj = new dialplan;\n\t\t\t\t$obj->app_uuid = $app_uuid;\n\t\t\t\t$obj->list_page = $redirect_url;\n\t\t\t\t$obj->copy($dialplans);\n\t\t\t}\n\n\t\t//toggle the dialplans\n\t\t\tif ($action == 'toggle') {\n\t\t\t\t$obj = new dialplan;\n\t\t\t\t$obj->app_uuid = $app_uuid;\n\t\t\t\t$obj->list_page = $redirect_url;\n\t\t\t\t$obj->toggle($dialplans);\n\t\t\t}\n\n\t\t//delete the dialplans\n\t\t\tif ($action == 'delete') {\n\t\t\t\t$obj = new dialplan;\n\t\t\t\t$obj->app_uuid = $app_uuid;\n\t\t\t\t$obj->list_page = $redirect_url;\n\t\t\t\t$obj->delete($dialplans);\n\t\t\t}\n\n\t\t//redirect\n\t\t\theader('Location: '.$redirect_url);\n\t\t\texit;\n\n\t}\n\n//get order and order by and sanatize the values\n\t$order_by = $_GET[\"order_by\"];\n\t$order = $_GET[\"order\"];\n\n//get the app uuid\n\t$app_uuid = $_GET[\"app_uuid\"];\n\n//make sure all dialplans with context of public have the inbound route app_uuid\n\tif ($app_uuid == 'c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4') {\n\t\t$sql = \"update v_dialplans set \";\n\t\t$sql .= \"app_uuid = 'c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4' \";\n\t\t$sql .= \"where dialplan_context = 'public' \";\n\t\t$sql .= \"and app_uuid is null; \";\n\t\t$database = new database;\n\t\t$database->execute($sql);\n\t\tunset($sql);\n\t}\n\n//add the search term\n\t$search = strtolower($_GET[\"search\"]);\n\tif (strlen($search) > 0) {\n\t\t$sql_search = \"and (\";\n\t\t$sql_search .= \" \tlower(dialplan_context) like :search \";\n\t\t$sql_search .= \" \tor lower(dialplan_name) like :search \";\n\t\t$sql_search .= \" \tor lower(dialplan_number) like :search \";\n\t\t$sql_search .= \" \tor lower(dialplan_continue) like :search \";\n\t\t$sql_search .= \" \tor lower(dialplan_enabled) like :search \";\n\t\t$sql_search .= \" \tor lower(dialplan_description) like :search \";\n\t\tif (is_numeric($search)) {\n\t\t\t$sql_search .= \" \tor dialplan_order = :search_numeric \";\n\t\t\t$parameters['search_numeric'] = $search;\n\t\t}\n\t\t$sql_search .= \") \";\n\t\t$parameters['search'] = '%'.$search.'%';\n\t}\n\n//get the number of rows in the dialplan\n\t$sql = \"select count(*) from v_dialplans \";\n\tif ($_GET['show'] == \"all\" && permission_exists('dialplan_all')) {\n\t\t$sql .= \"where true \";\n\t}\n\telse {\n\t\t$sql .= \"where (domain_uuid = :domain_uuid or domain_uuid is null) \";\n\t\t$parameters['domain_uuid'] = $domain_uuid;\n\t}\n\tif (!is_uuid($app_uuid)) {\n\t\t//hide inbound routes\n\t\t\t$sql .= \"and app_uuid <> 'c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4' \";\n\t\t\t$sql .= \"and dialplan_context <> 'public' \";\n\t\t//hide outbound routes\n\t\t\t$sql .= \"and app_uuid <> '8c914ec3-9fc0-8ab5-4cda-6c9288bdc9a3' \";\n\t}\n\telse {\n\t\tif ($app_uuid == 'c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4') {\n\t\t\t$sql .= \"and (app_uuid = :app_uuid or dialplan_context = 'public') \";\n\t\t}\n\t\telse {\n\t\t\t$sql .= \"and app_uuid = :app_uuid \";\n\t\t}\n\t\t$parameters['app_uuid'] = $app_uuid;\n\t}\n\t$sql .= $sql_search;\n\t$database = new database;\n\t$num_rows = $database->select($sql, $parameters, 'column');\n\n//prepare the paging\n\t$rows_per_page = ($_SESSION['domain']['paging']['numeric'] != '') ? $_SESSION['domain']['paging']['numeric'] : 50;\n\tif (is_uuid($app_uuid)) { $params[] = \"app_uuid=\".$app_uuid; }\n\tif ($search) { $params[] = \"search=\".$search; }\n\tif ($order_by) { $params[] = \"order_by=\".$order_by; }\n\tif ($order) { $params[] = \"order=\".$order; }\n\tif ($_GET['show'] == \"all\" && permission_exists('dialplan_all')) {\n\t\t$params[] .= \"show=all\";\n\t}\n\t$param = $params ? implode('&', $params) : null;\n\tunset($params);\n\t$page = $_GET['page'];\n\tif (strlen($page) == 0) { $page = 0; $_GET['page'] = 0; }\n\tlist($paging_controls, $rows_per_page) = paging($num_rows, $param, $rows_per_page);\n\tlist($paging_controls_mini, $rows_per_page) = paging($num_rows, $param, $rows_per_page, true);\n\t$offset = $rows_per_page * $page;\n\n//get the list of dialplans\n\t$sql = str_replace('count(*)', '*', $sql);\n\tif ($order_by != '') {\n\t\tif ($order_by == 'dialplan_name' || $order_by == 'dialplan_description') {\n\t\t\t$sql .= 'order by lower('.$order_by.') '.$order.' ';\n\t\t}\n\t\telse {\n\t\t\t$sql .= order_by($order_by, $order);\n\t\t}\n\t}\n\telse {\n\t\t$sql .= \"order by dialplan_order asc, lower(dialplan_name) asc \";\n\t}\n\t$sql .= limit_offset($rows_per_page, $offset);\n\t$database = new database;\n\t$dialplans = $database->select($sql, $parameters, 'all');\n\tunset($sql, $parameters);\n\n//create token\n\t$object = new token;\n\t$token = $object->create($_SERVER['PHP_SELF']);\n\n//include the header\n\tswitch ($app_uuid) {\n\t\tcase \"c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4\": $document['title'] = $text['title-inbound_routes']; break;\n\t\tcase \"8c914ec3-9fc0-8ab5-4cda-6c9288bdc9a3\": $document['title'] = $text['title-outbound_routes']; break;\n\t\tcase \"16589224-c876-aeb3-f59f-523a1c0801f7\": $document['title'] = $text['title-queues']; break;\n\t\tcase \"4b821450-926b-175a-af93-a03c441818b1\": $document['title'] = $text['title-time_conditions']; break;\n\t\tdefault: $document['title'] = $text['title-dialplan_manager'];\n\t}\n\trequire_once \"resources/header.php\";\n\n//show the content\n\techo \"<div class='action_bar' id='action_bar'>\\n\";\n\techo \"\t<div class='heading'><b>\";\n\tswitch ($app_uuid) {\n\t\tcase \"c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4\": echo $text['header-inbound_routes']; break;\n\t\tcase \"8c914ec3-9fc0-8ab5-4cda-6c9288bdc9a3\": echo $text['header-outbound_routes']; break;\n\t\tcase \"16589224-c876-aeb3-f59f-523a1c0801f7\": echo $text['header-queues']; break;\n\t\tcase \"4b821450-926b-175a-af93-a03c441818b1\": echo $text['header-time_conditions']; break;\n\t\tdefault: echo $text['header-dialplan_manager'];\n\t}\n\techo \" (\".$num_rows.\")</b>\";\n\techo \t\"</div>\\n\";\n\techo \"\t<div class='actions'>\\n\";\n\tif ($app_uuid == \"c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4\" && permission_exists('inbound_route_add')) { $button_add_url = PROJECT_PATH.\"/app/dialplan_inbound/dialplan_inbound_add.php\"; }\n\telse if ($app_uuid == \"8c914ec3-9fc0-8ab5-4cda-6c9288bdc9a3\" && permission_exists('outbound_route_add')) { $button_add_url = PROJECT_PATH.\"/app/dialplan_outbound/dialplan_outbound_add.php\"; }\n\telse if ($app_uuid == \"16589224-c876-aeb3-f59f-523a1c0801f7\" && permission_exists('fifo_add')) { $button_add_url = PROJECT_PATH.\"/app/fifo/fifo_add.php\"; }\n\telse if ($app_uuid == \"4b821450-926b-175a-af93-a03c441818b1\" && permission_exists('time_condition_add')) { $button_add_url = PROJECT_PATH.\"/app/time_conditions/time_condition_edit.php\"; }\n\telse if (permission_exists('dialplan_add')) { $button_add_url = PROJECT_PATH.\"/app/dialplans/dialplan_add.php\"; }\n\tif ($button_add_url) {\n\t\techo button::create(['type'=>'button','label'=>$text['button-add'],'icon'=>$_SESSION['theme']['button_icon_add'],'link'=>$button_add_url]);\n\t}\n\tif ($dialplans) {\n\t\tif (\n\t\t\t($app_uuid == \"c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4\" && permission_exists('inbound_route_copy')) ||\n\t\t\t($app_uuid == \"8c914ec3-9fc0-8ab5-4cda-6c9288bdc9a3\" && permission_exists('outbound_route_copy')) ||\n\t\t\t($app_uuid == \"16589224-c876-aeb3-f59f-523a1c0801f7\" && permission_exists('fifo_add')) ||\n\t\t\t($app_uuid == \"4b821450-926b-175a-af93-a03c441818b1\" && permission_exists('time_condition_add')) ||\n\t\t\tpermission_exists('dialplan_add')\n\t\t\t) {\n\t\t\techo button::create(['type'=>'button','label'=>$text['button-copy'],'icon'=>$_SESSION['theme']['button_icon_copy'],'onclick'=>\"if (confirm('\".$text['confirm-copy'].\"')) { list_action_set('copy'); list_form_submit('form_list'); } else { this.blur(); return false; }\"]);\n\t\t}\n\t\tif (\n\t\t\t($app_uuid == \"c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4\" && permission_exists('inbound_route_edit')) ||\n\t\t\t($app_uuid == \"8c914ec3-9fc0-8ab5-4cda-6c9288bdc9a3\" && permission_exists('outbound_route_edit')) ||\n\t\t\t($app_uuid == \"16589224-c876-aeb3-f59f-523a1c0801f7\" && permission_exists('fifo_edit')) ||\n\t\t\t($app_uuid == \"4b821450-926b-175a-af93-a03c441818b1\" && permission_exists('time_condition_edit')) ||\n\t\t\tpermission_exists('dialplan_edit')\n\t\t\t) {\n\t\t\techo button::create(['type'=>'button','label'=>$text['button-toggle'],'icon'=>$_SESSION['theme']['button_icon_toggle'],'onclick'=>\"if (confirm('\".$text['confirm-toggle'].\"')) { list_action_set('toggle'); list_form_submit('form_list'); } else { this.blur(); return false; }\"]);\n\t\t}\n\t\tif (\n\t\t\t($app_uuid == \"c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4\" && permission_exists('inbound_route_delete')) ||\n\t\t\t($app_uuid == \"8c914ec3-9fc0-8ab5-4cda-6c9288bdc9a3\" && permission_exists('outbound_route_delete')) ||\n\t\t\t($app_uuid == \"16589224-c876-aeb3-f59f-523a1c0801f7\" && permission_exists('fifo_delete')) ||\n\t\t\t($app_uuid == \"4b821450-926b-175a-af93-a03c441818b1\" && permission_exists('time_condition_delete')) ||\n\t\t\tpermission_exists('dialplan_delete')\n\t\t\t) {\n\t\t\techo button::create(['type'=>'button','label'=>$text['button-delete'],'icon'=>$_SESSION['theme']['button_icon_delete'],'onclick'=>\"if (confirm('\".$text['confirm-delete'].\"')) { list_action_set('delete'); list_form_submit('form_list'); } else { this.blur(); return false; }\"]);\n\t\t}\n\t}\n\techo \t\t\"<form id='form_search' class='inline' method='get'>\\n\";\n\tif (permission_exists('dialplan_all')) {\n\t\tif ($_GET['show'] == 'all' && permission_exists('dialplan_all')) {\n\t\t\techo \"\t\t<input type='hidden' name='show' value='all'>\";\n\t\t}\n\t\telse {\n\t\t\tif (is_uuid($app_uuid)) { $params[] = \"app_uuid=\".urlencode($app_uuid); }\n\t\t\tif ($search) { $params[] = \"search=\".urlencode($search); }\n\t\t\tif ($order_by) { $params[] = \"order_by=\".urlencode($order_by); }\n\t\t\tif ($order) { $params[] = \"order=\".urlencode($order); }\n\t\t\techo button::create(['type'=>'button','label'=>$text['button-show_all'],'icon'=>$_SESSION['theme']['button_icon_all'],'link'=>'?show=all'.($params ? '&'.implode('&', $params) : null)]);\n\t\t\tunset($params);\n\t\t}\n\t}\n\tif (is_uuid($app_uuid)) {\n\t\techo \t\"<input type='hidden' name='app_uuid' value='\".escape($app_uuid).\"'>\";\n\t}\n\tif ($order_by) {\n\t\techo \t\"<input type='hidden' name='order_by' value='\".escape($order_by).\"'>\";\n\t}\n\tif ($order) {\n\t\techo \t\"<input type='hidden' name='order' value='\".escape($order).\"'>\";\n\t}\n\techo \t\t\"<input type='text' class='txt list-search' name='search' id='search' value=\\\"\".escape($search).\"\\\" placeholder=\\\"\".$text['label-search'].\"\\\" onkeydown='list_search_reset();'>\";\n\techo button::create(['label'=>$text['button-search'],'icon'=>$_SESSION['theme']['button_icon_search'],'type'=>'submit','id'=>'btn_search','style'=>($search != '' ? 'display: none;' : null)]);\n\tif (is_uuid($app_uuid)) { $params[] = \"app_uuid=\".urlencode($app_uuid); }\n\tif ($order_by) { $params[] = \"order_by=\".urlencode($order_by); }\n\tif ($order) { $params[] = \"order=\".urlencode($order); }\n\tif ($_GET['show'] && permission_exists('dialplan_all')) { $params[] = \"show=\".urlencode($_GET['show']); }\n\techo button::create(['label'=>$text['button-reset'],'icon'=>$_SESSION['theme']['button_icon_reset'],'type'=>'button','id'=>'btn_reset','link'=>'dialplans.php'.($params ? '?'.implode('&', $params) : null),'style'=>($search == '' ? 'display: none;' : null)]);\n\tunset($params);\n\tif ($paging_controls_mini != '') {\n\t\techo \t\"<span style='margin-left: 15px;'>\".$paging_controls_mini.\"</span>\";\n\t}\n\techo \"\t\t</form>\\n\";\n\techo \"\t</div>\\n\";\n\techo \"\t<div style='clear: both;'></div>\\n\";\n\techo \"</div>\\n\";\n\n\tswitch ($app_uuid) {\n\t\tcase \"c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4\": echo $text['description-inbound_routes']; break;\n\t\tcase \"8c914ec3-9fc0-8ab5-4cda-6c9288bdc9a3\": echo $text['description-outbound_routes']; break;\n\t\tcase \"16589224-c876-aeb3-f59f-523a1c0801f7\": echo $text['description-queues']; break;\n\t\tcase \"4b821450-926b-175a-af93-a03c441818b1\": echo $text['description-time_conditions']; break;\n\t\tdefault: echo $text['description-dialplan_manager'.(if_group(\"superadmin\") ? '-superadmin' : null)];\n\t}\n\techo \"\\n<br /><br />\\n\";\n\n\techo \"<form id='form_list' method='post'>\\n\";\n\techo \"<input type='hidden' id='app_uuid' name='app_uuid' value='\".escape($app_uuid).\"'>\\n\";\n\techo \"<input type='hidden' id='action' name='action' value=''>\\n\";\n\techo \"<input type='hidden' name='search' value=\\\"\".escape($search).\"\\\">\\n\";\n\techo \"<input type='hidden' name='order_by' value=\\\"\".escape($order_by).\"\\\">\\n\";\n\techo \"<input type='hidden' name='order' value=\\\"\".escape($order).\"\\\">\\n\";\n\n\techo \"<table class='list'>\\n\";\n\techo \"<tr class='list-header'>\\n\";\n\tif (\n\t\t($app_uuid == \"c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4\" && (permission_exists('inbound_route_copy') || permission_exists('inbound_route_edit') || permission_exists('inbound_route_delete'))) ||\n\t\t($app_uuid == \"8c914ec3-9fc0-8ab5-4cda-6c9288bdc9a3\" && (permission_exists('outbound_route_copy') || permission_exists('outbound_route_edit') || permission_exists('outbound_route_delete'))) ||\n\t\t($app_uuid == \"16589224-c876-aeb3-f59f-523a1c0801f7\" && (permission_exists('fifo_add') || permission_exists('fifo_edit') || permission_exists('fifo_delete'))) ||\n\t\t($app_uuid == \"4b821450-926b-175a-af93-a03c441818b1\" && (permission_exists('time_condition_add') || permission_exists('time_condition_edit') || permission_exists('time_condition_delete'))) ||\n\t\tpermission_exists('dialplan_add') || permission_exists('dialplan_edit') || permission_exists('dialplan_delete')\n\t\t) {\n\t\techo \"\t<th class='checkbox'>\\n\";\n\t\techo \"\t\t<input type='checkbox' id='checkbox_all' name='checkbox_all' onclick='list_all_toggle();' \".($dialplans ?: \"style='visibility: hidden;'\").\">\\n\";\n\t\techo \"\t</th>\\n\";\n\t}\n\tif ($_GET['show'] == \"all\" && permission_exists('dialplan_all')) {\n\t\techo \"<th>\".$text['label-domain'].\"</th>\\n\";\n\t}\n\tif ($search) { $params[] = \"search=\".urlencode($search); }\n\tif ($_GET['show'] == 'all' && permission_exists('dialplan_all')) { $params[] = \"show=all\"; }\n\techo th_order_by('dialplan_name', $text['label-name'], $order_by, $order, $app_uuid, null, ($params ? implode('&', $params) : null));\n\techo th_order_by('dialplan_number', $text['label-number'], $order_by, $order, $app_uuid, null, ($params ? implode('&', $params) : null));\n\tif (permission_exists('dialplan_context')) {\n\t\techo th_order_by('dialplan_context', $text['label-context'], $order_by, $order, $app_uuid, null, ($params ? implode('&', $params) : null));\n\t}\n\techo th_order_by('dialplan_order', $text['label-order'], $order_by, $order, $app_uuid, \"class='center shrink'\", ($params ? implode('&', $params) : null));\n\techo th_order_by('dialplan_enabled', $text['label-enabled'], $order_by, $order, $app_uuid, \"class='center'\", ($params ? implode('&', $params) : null));\n\techo th_order_by('dialplan_description', $text['label-description'], $order_by, $order, $app_uuid, \"class='hide-sm-dn' style='min-width: 100px;'\", ($params ? implode('&', $params) : null));\n\tunset($params);\n\tif ((\n\t\t($app_uuid == \"c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4\" && permission_exists('inbound_route_edit')) ||\n\t\t($app_uuid == \"8c914ec3-9fc0-8ab5-4cda-6c9288bdc9a3\" && permission_exists('outbound_route_edit')) ||\n\t\t($app_uuid == \"16589224-c876-aeb3-f59f-523a1c0801f7\" && permission_exists('fifo_edit')) ||\n\t\t($app_uuid == \"4b821450-926b-175a-af93-a03c441818b1\" && permission_exists('time_condition_edit')) ||\n\t\tpermission_exists('dialplan_edit')) && $_SESSION['theme']['list_row_edit_button']['boolean'] == 'true'\n\t\t) {\n\t\techo \"\t<td class='action-button'>&nbsp;</td>\\n\";\n\t}\n\techo \"</tr>\\n\";\n\n\tif (is_array($dialplans) && @sizeof($dialplans) != 0) {\n\t\t$x = 0;\n\t\tforeach ($dialplans as $row) {\n\n\t\t\t//get the application id\n\t\t\t$app_uuid = $row['app_uuid'];\n\n\t\t\t// blank app id if doesn't match others, so will return to dialplan manager\n\t\t\tswitch ($app_uuid) {\n\t\t\t\tcase \"c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4\": // inbound route\n\t\t\t\tcase \"8c914ec3-9fc0-8ab5-4cda-6c9288bdc9a3\": // outbound route\n\t\t\t\tcase \"16589224-c876-aeb3-f59f-523a1c0801f7\": // fifo\n\t\t\t\tcase \"4b821450-926b-175a-af93-a03c441818b1\": // time condition\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tunset($app_uuid);\n\t\t\t}\n\n\t\t\tif ($app_uuid == \"4b821450-926b-175a-af93-a03c441818b1\" && permission_exists('time_condition_edit')) {\n\t\t\t\t$list_row_url = PROJECT_PATH.\"/app/time_conditions/time_condition_edit.php?id=\".urlencode($row['dialplan_uuid']).(is_uuid($app_uuid) ? \"&app_uuid=\".urlencode($app_uuid) : null);\n\t\t\t}\n\t\t\telse if (\n\t\t\t\t($app_uuid == \"c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4\" && permission_exists('inbound_route_edit')) ||\n\t\t\t\t($app_uuid == \"8c914ec3-9fc0-8ab5-4cda-6c9288bdc9a3\" && permission_exists('outbound_route_edit')) ||\n\t\t\t\t($app_uuid == \"16589224-c876-aeb3-f59f-523a1c0801f7\" && permission_exists('fifo_edit')) ||\n\t\t\t\tpermission_exists('dialplan_edit')\n\t\t\t\t) {\n\t\t\t\t$list_row_url = \"dialplan_edit.php?id=\".urlencode($row['dialplan_uuid']).(is_uuid($app_uuid) ? \"&app_uuid=\".urlencode($app_uuid) : null);\n\t\t\t}\n\t\t\techo \"<tr class='list-row' href='\".$list_row_url.\"'>\\n\";\n\t\t\tif (\n\t\t\t\t($app_uuid == \"c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4\" && (permission_exists('inbound_route_copy') || permission_exists('inbound_route_edit') || permission_exists('inbound_route_delete'))) ||\n\t\t\t\t($app_uuid == \"8c914ec3-9fc0-8ab5-4cda-6c9288bdc9a3\" && (permission_exists('outbound_route_copy') || permission_exists('outbound_route_edit') || permission_exists('outbound_route_delete'))) ||\n\t\t\t\t($app_uuid == \"16589224-c876-aeb3-f59f-523a1c0801f7\" && (permission_exists('fifo_add') || permission_exists('fifo_edit') || permission_exists('fifo_delete'))) ||\n\t\t\t\t($app_uuid == \"4b821450-926b-175a-af93-a03c441818b1\" && (permission_exists('time_condition_add') || permission_exists('time_condition_edit') || permission_exists('time_condition_delete'))) ||\n\t\t\t\tpermission_exists('dialplan_add') || permission_exists('dialplan_edit') || permission_exists('dialplan_delete')\n\t\t\t\t) {\n\t\t\t\techo \"\t<td class='checkbox'>\\n\";\n\t\t\t\techo \"\t\t<input type='checkbox' name='dialplans[$x][checked]' id='checkbox_\".$x.\"' value='true' onclick=\\\"if (!this.checked) { document.getElementById('checkbox_all').checked = false; }\\\">\\n\";\n\t\t\t\techo \"\t\t<input type='hidden' name='dialplans[$x][uuid]' value='\".escape($row['dialplan_uuid']).\"' />\\n\";\n\t\t\t\techo \"\t</td>\\n\";\n\t\t\t}\n\t\t\tif ($_GET['show'] == \"all\" && permission_exists('dialplan_all')) {\n\t\t\t\tif (strlen($_SESSION['domains'][$row['domain_uuid']]['domain_name']) > 0) {\n\t\t\t\t\t$domain = $_SESSION['domains'][$row['domain_uuid']]['domain_name'];\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t$domain = $text['label-global'];\n\t\t\t\t}\n\t\t\t\techo \"\t<td>\".escape($domain).\"</td>\\n\";\n\t\t\t}\n\t\t\techo \"\t<td>\";\n\t\t\tif ($list_row_url) {\n\t\t\t\techo \"<a href='\".$list_row_url.\"'>\".escape($row['dialplan_name']).\"</a>\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\techo escape($row['dialplan_name']);\n\t\t\t}\n\t\t\techo \"\t</td>\\n\";\n\t\t\techo \"\t<td>\".((strlen($row['dialplan_number']) > 0) ? escape(format_phone($row['dialplan_number'])) : \"&nbsp;\").\"</td>\\n\";\n\t\t\tif (permission_exists('dialplan_context')) {\n\t\t\t\techo \"\t<td>\".escape($row['dialplan_context']).\"</td>\\n\";\n\t\t\t}\n\t\t\techo \"\t<td class='center'>\".escape($row['dialplan_order']).\"</td>\\n\";\n\t\t\tif (\n\t\t\t\t($app_uuid == \"c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4\" && permission_exists('inbound_route_edit')) ||\n\t\t\t\t($app_uuid == \"8c914ec3-9fc0-8ab5-4cda-6c9288bdc9a3\" && permission_exists('outbound_route_edit')) ||\n\t\t\t\t($app_uuid == \"16589224-c876-aeb3-f59f-523a1c0801f7\" && permission_exists('fifo_edit')) ||\n\t\t\t\t($app_uuid == \"4b821450-926b-175a-af93-a03c441818b1\" && permission_exists('time_condition_edit')) ||\n\t\t\t\tpermission_exists('dialplan_edit')\n\t\t\t\t) {\n\t\t\t\techo \"\t<td class='no-link center'>\";\n\t\t\t\techo button::create(['type'=>'submit','class'=>'link','label'=>$text['label-'.$row['dialplan_enabled']],'title'=>$text['button-toggle'],'onclick'=>\"list_self_check('checkbox_\".$x.\"'); list_action_set('toggle'); list_form_submit('form_list')\"]);\n\t\t\t}\n\t\t\telse {\n\t\t\t\techo \"\t<td class='center'>\";\n\t\t\t\techo $text['label-'.$row['dialplan_enabled']];\n\t\t\t}\n\t\t\techo \"\t</td>\\n\";\n\t\t\techo \"\t<td class='description overflow hide-sm-dn'>\".escape($row['dialplan_description']).\"&nbsp;</td>\\n\";\n\t\t\tif ((\n\t\t\t\t($app_uuid == \"c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4\" && permission_exists('inbound_route_edit')) ||\n\t\t\t\t($app_uuid == \"8c914ec3-9fc0-8ab5-4cda-6c9288bdc9a3\" && permission_exists('outbound_route_edit')) ||\n\t\t\t\t($app_uuid == \"16589224-c876-aeb3-f59f-523a1c0801f7\" && permission_exists('fifo_edit')) ||\n\t\t\t\t($app_uuid == \"4b821450-926b-175a-af93-a03c441818b1\" && permission_exists('time_condition_edit')) ||\n\t\t\t\tpermission_exists('dialplan_edit')) && $_SESSION['theme']['list_row_edit_button']['boolean'] == 'true'\n\t\t\t\t) {\n\t\t\t\techo \"\t<td class='action-button'>\";\n\t\t\t\techo button::create(['type'=>'button','title'=>$text['button-edit'],'icon'=>$_SESSION['theme']['button_icon_edit'],'link'=>$list_row_url]);\n\t\t\t\techo \"\t</td>\\n\";\n\t\t\t}\n\t\t\techo \"</tr>\\n\";\n\t\t\t$x++;\n\t\t}\n\t\tunset($dialplans);\n\t}\n\n\techo \"</table>\\n\";\n\techo \"<br />\\n\";\n\techo \"<div align='center'>\".$paging_controls.\"</div>\\n\";\n\n\techo \"<input type='hidden' name='\".$token['name'].\"' value='\".$token['hash'].\"'>\\n\";\n\n\techo \"</form>\\n\";\n\n//include the footer\n\trequire_once \"resources/footer.php\";\n\n?>"], "fixing_code": ["<?php\n/*\n\tFusionPBX\n\tVersion: MPL 1.1\n\n\tThe contents of this file are subject to the Mozilla Public License Version\n\t1.1 (the \"License\"); you may not use this file except in compliance with\n\tthe License. You may obtain a copy of the License at\n\thttp://www.mozilla.org/MPL/\n\n\tSoftware distributed under the License is distributed on an \"AS IS\" basis,\n\tWITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n\tfor the specific language governing rights and limitations under the\n\tLicense.\n\n\tThe Original Code is FusionPBX\n\n\tThe Initial Developer of the Original Code is\n\tMark J Crane <markjcrane@fusionpbx.com>\n\tPortions created by the Initial Developer are Copyright (C) 2008-2019\n\tthe Initial Developer. All Rights Reserved.\n\n\tContributor(s):\n\tMark J Crane <markjcrane@fusionpbx.com>\n*/\n\n//includes\n\tinclude \"root.php\";\n\trequire_once \"resources/require.php\";\n\trequire_once \"resources/check_auth.php\";\n\trequire_once \"resources/paging.php\";\n\n//check permissions\n\tif (permission_exists('dialplan_view')) {\n\t\t//access granted\n\t}\n\telse {\n\t\techo \"access denied\";\n\t\texit;\n\t}\n\n//add multi-lingual support\n\t$language = new text;\n\t$text = $language->get();\n\n//get posted data\n\tif (is_array($_POST['dialplans'])) {\n\t\t$action = $_POST['action'];\n\t\t$dialplans = $_POST['dialplans'];\n\t\t$search = $_POST['search'];\n\t\t$order_by = $_POST['order_by'];\n\t\t$order = $_POST['order'];\n\t}\n\n//get the app uuid\n\tif (is_uuid($_REQUEST[\"app_uuid\"])) {\n\t\t$app_uuid = $_REQUEST[\"app_uuid\"];\n\t}\n\n//process action\n\tif ($action && is_array($dialplans) && @sizeof($dialplans) != 0) {\n\n\t\t//define redirect parameters and url\n\t\t\tif (is_uuid($app_uuid)) { $params[] = \"app_uuid=\".urlencode($app_uuid); }\n\t\t\tif ($search) { $params[] = \"search=\".urlencode($search); }\n\t\t\tif ($order_by) { $params[] = \"order_by=\".urlencode($order_by); }\n\t\t\tif ($order) { $params[] = \"order=\".urlencode($order); }\n\t\t\t$redirect_url = 'dialplans.php'.($params ? '?'.implode('&', $params) : null);\n\t\t\tunset($params);\n\n\t\t//copy the dialplans\n\t\t\tif ($action == 'copy') {\n\t\t\t\t$obj = new dialplan;\n\t\t\t\t$obj->app_uuid = $app_uuid;\n\t\t\t\t$obj->list_page = $redirect_url;\n\t\t\t\t$obj->copy($dialplans);\n\t\t\t}\n\n\t\t//toggle the dialplans\n\t\t\tif ($action == 'toggle') {\n\t\t\t\t$obj = new dialplan;\n\t\t\t\t$obj->app_uuid = $app_uuid;\n\t\t\t\t$obj->list_page = $redirect_url;\n\t\t\t\t$obj->toggle($dialplans);\n\t\t\t}\n\n\t\t//delete the dialplans\n\t\t\tif ($action == 'delete') {\n\t\t\t\t$obj = new dialplan;\n\t\t\t\t$obj->app_uuid = $app_uuid;\n\t\t\t\t$obj->list_page = $redirect_url;\n\t\t\t\t$obj->delete($dialplans);\n\t\t\t}\n\n\t\t//redirect\n\t\t\theader('Location: '.$redirect_url);\n\t\t\texit;\n\n\t}\n\n//get order and order by and sanatize the values\n\t$order_by = $_GET[\"order_by\"];\n\t$order = $_GET[\"order\"];\n\n//make sure all dialplans with context of public have the inbound route app_uuid\n\tif ($app_uuid == 'c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4') {\n\t\t$sql = \"update v_dialplans set \";\n\t\t$sql .= \"app_uuid = 'c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4' \";\n\t\t$sql .= \"where dialplan_context = 'public' \";\n\t\t$sql .= \"and app_uuid is null; \";\n\t\t$database = new database;\n\t\t$database->execute($sql);\n\t\tunset($sql);\n\t}\n\n//add the search term\n\t$search = strtolower($_GET[\"search\"]);\n\tif (strlen($search) > 0) {\n\t\t$sql_search = \"and (\";\n\t\t$sql_search .= \" \tlower(dialplan_context) like :search \";\n\t\t$sql_search .= \" \tor lower(dialplan_name) like :search \";\n\t\t$sql_search .= \" \tor lower(dialplan_number) like :search \";\n\t\t$sql_search .= \" \tor lower(dialplan_continue) like :search \";\n\t\t$sql_search .= \" \tor lower(dialplan_enabled) like :search \";\n\t\t$sql_search .= \" \tor lower(dialplan_description) like :search \";\n\t\tif (is_numeric($search)) {\n\t\t\t$sql_search .= \" \tor dialplan_order = :search_numeric \";\n\t\t\t$parameters['search_numeric'] = $search;\n\t\t}\n\t\t$sql_search .= \") \";\n\t\t$parameters['search'] = '%'.$search.'%';\n\t}\n\n//get the number of rows in the dialplan\n\t$sql = \"select count(*) from v_dialplans \";\n\tif ($_GET['show'] == \"all\" && permission_exists('dialplan_all')) {\n\t\t$sql .= \"where true \";\n\t}\n\telse {\n\t\t$sql .= \"where (domain_uuid = :domain_uuid or domain_uuid is null) \";\n\t\t$parameters['domain_uuid'] = $domain_uuid;\n\t}\n\tif (!is_uuid($app_uuid)) {\n\t\t//hide inbound routes\n\t\t\t$sql .= \"and app_uuid <> 'c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4' \";\n\t\t\t$sql .= \"and dialplan_context <> 'public' \";\n\t\t//hide outbound routes\n\t\t\t$sql .= \"and app_uuid <> '8c914ec3-9fc0-8ab5-4cda-6c9288bdc9a3' \";\n\t}\n\telse {\n\t\tif ($app_uuid == 'c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4') {\n\t\t\t$sql .= \"and (app_uuid = :app_uuid or dialplan_context = 'public') \";\n\t\t}\n\t\telse {\n\t\t\t$sql .= \"and app_uuid = :app_uuid \";\n\t\t}\n\t\t$parameters['app_uuid'] = $app_uuid;\n\t}\n\t$sql .= $sql_search;\n\t$database = new database;\n\t$num_rows = $database->select($sql, $parameters, 'column');\n\n//prepare the paging\n\t$rows_per_page = ($_SESSION['domain']['paging']['numeric'] != '') ? $_SESSION['domain']['paging']['numeric'] : 50;\n\t$params[] = \"app_uuid=\".$app_uuid;\n\tif ($search) { $params[] = \"search=\".$search; }\n\tif ($order_by) { $params[] = \"order_by=\".$order_by; }\n\tif ($order) { $params[] = \"order=\".$order; }\n\tif ($_GET['show'] == \"all\" && permission_exists('dialplan_all')) {\n\t\t$params[] .= \"show=all\";\n\t}\n\t$param = $params ? implode('&', $params) : null;\n\tunset($params);\n\t$page = $_GET['page'];\n\tif (strlen($page) == 0) { $page = 0; $_GET['page'] = 0; }\n\tlist($paging_controls, $rows_per_page) = paging($num_rows, $param, $rows_per_page);\n\tlist($paging_controls_mini, $rows_per_page) = paging($num_rows, $param, $rows_per_page, true);\n\t$offset = $rows_per_page * $page;\n\n//get the list of dialplans\n\t$sql = str_replace('count(*)', '*', $sql);\n\tif ($order_by != '') {\n\t\tif ($order_by == 'dialplan_name' || $order_by == 'dialplan_description') {\n\t\t\t$sql .= 'order by lower('.$order_by.') '.$order.' ';\n\t\t}\n\t\telse {\n\t\t\t$sql .= order_by($order_by, $order);\n\t\t}\n\t}\n\telse {\n\t\t$sql .= \"order by dialplan_order asc, lower(dialplan_name) asc \";\n\t}\n\t$sql .= limit_offset($rows_per_page, $offset);\n\t$database = new database;\n\t$dialplans = $database->select($sql, $parameters, 'all');\n\tunset($sql, $parameters);\n\n//create token\n\t$object = new token;\n\t$token = $object->create($_SERVER['PHP_SELF']);\n\n//include the header\n\tswitch ($app_uuid) {\n\t\tcase \"c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4\": $document['title'] = $text['title-inbound_routes']; break;\n\t\tcase \"8c914ec3-9fc0-8ab5-4cda-6c9288bdc9a3\": $document['title'] = $text['title-outbound_routes']; break;\n\t\tcase \"16589224-c876-aeb3-f59f-523a1c0801f7\": $document['title'] = $text['title-queues']; break;\n\t\tcase \"4b821450-926b-175a-af93-a03c441818b1\": $document['title'] = $text['title-time_conditions']; break;\n\t\tdefault: $document['title'] = $text['title-dialplan_manager'];\n\t}\n\trequire_once \"resources/header.php\";\n\n//show the content\n\techo \"<div class='action_bar' id='action_bar'>\\n\";\n\techo \"\t<div class='heading'><b>\";\n\tswitch ($app_uuid) {\n\t\tcase \"c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4\": echo $text['header-inbound_routes']; break;\n\t\tcase \"8c914ec3-9fc0-8ab5-4cda-6c9288bdc9a3\": echo $text['header-outbound_routes']; break;\n\t\tcase \"16589224-c876-aeb3-f59f-523a1c0801f7\": echo $text['header-queues']; break;\n\t\tcase \"4b821450-926b-175a-af93-a03c441818b1\": echo $text['header-time_conditions']; break;\n\t\tdefault: echo $text['header-dialplan_manager'];\n\t}\n\techo \" (\".$num_rows.\")</b>\";\n\techo \t\"</div>\\n\";\n\techo \"\t<div class='actions'>\\n\";\n\tif ($app_uuid == \"c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4\" && permission_exists('inbound_route_add')) { $button_add_url = PROJECT_PATH.\"/app/dialplan_inbound/dialplan_inbound_add.php\"; }\n\telse if ($app_uuid == \"8c914ec3-9fc0-8ab5-4cda-6c9288bdc9a3\" && permission_exists('outbound_route_add')) { $button_add_url = PROJECT_PATH.\"/app/dialplan_outbound/dialplan_outbound_add.php\"; }\n\telse if ($app_uuid == \"16589224-c876-aeb3-f59f-523a1c0801f7\" && permission_exists('fifo_add')) { $button_add_url = PROJECT_PATH.\"/app/fifo/fifo_add.php\"; }\n\telse if ($app_uuid == \"4b821450-926b-175a-af93-a03c441818b1\" && permission_exists('time_condition_add')) { $button_add_url = PROJECT_PATH.\"/app/time_conditions/time_condition_edit.php\"; }\n\telse if (permission_exists('dialplan_add')) { $button_add_url = PROJECT_PATH.\"/app/dialplans/dialplan_add.php\"; }\n\tif ($button_add_url) {\n\t\techo button::create(['type'=>'button','label'=>$text['button-add'],'icon'=>$_SESSION['theme']['button_icon_add'],'link'=>$button_add_url]);\n\t}\n\tif ($dialplans) {\n\t\tif (\n\t\t\t($app_uuid == \"c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4\" && permission_exists('inbound_route_copy')) ||\n\t\t\t($app_uuid == \"8c914ec3-9fc0-8ab5-4cda-6c9288bdc9a3\" && permission_exists('outbound_route_copy')) ||\n\t\t\t($app_uuid == \"16589224-c876-aeb3-f59f-523a1c0801f7\" && permission_exists('fifo_add')) ||\n\t\t\t($app_uuid == \"4b821450-926b-175a-af93-a03c441818b1\" && permission_exists('time_condition_add')) ||\n\t\t\tpermission_exists('dialplan_add')\n\t\t\t) {\n\t\t\techo button::create(['type'=>'button','label'=>$text['button-copy'],'icon'=>$_SESSION['theme']['button_icon_copy'],'onclick'=>\"if (confirm('\".$text['confirm-copy'].\"')) { list_action_set('copy'); list_form_submit('form_list'); } else { this.blur(); return false; }\"]);\n\t\t}\n\t\tif (\n\t\t\t($app_uuid == \"c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4\" && permission_exists('inbound_route_edit')) ||\n\t\t\t($app_uuid == \"8c914ec3-9fc0-8ab5-4cda-6c9288bdc9a3\" && permission_exists('outbound_route_edit')) ||\n\t\t\t($app_uuid == \"16589224-c876-aeb3-f59f-523a1c0801f7\" && permission_exists('fifo_edit')) ||\n\t\t\t($app_uuid == \"4b821450-926b-175a-af93-a03c441818b1\" && permission_exists('time_condition_edit')) ||\n\t\t\tpermission_exists('dialplan_edit')\n\t\t\t) {\n\t\t\techo button::create(['type'=>'button','label'=>$text['button-toggle'],'icon'=>$_SESSION['theme']['button_icon_toggle'],'onclick'=>\"if (confirm('\".$text['confirm-toggle'].\"')) { list_action_set('toggle'); list_form_submit('form_list'); } else { this.blur(); return false; }\"]);\n\t\t}\n\t\tif (\n\t\t\t($app_uuid == \"c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4\" && permission_exists('inbound_route_delete')) ||\n\t\t\t($app_uuid == \"8c914ec3-9fc0-8ab5-4cda-6c9288bdc9a3\" && permission_exists('outbound_route_delete')) ||\n\t\t\t($app_uuid == \"16589224-c876-aeb3-f59f-523a1c0801f7\" && permission_exists('fifo_delete')) ||\n\t\t\t($app_uuid == \"4b821450-926b-175a-af93-a03c441818b1\" && permission_exists('time_condition_delete')) ||\n\t\t\tpermission_exists('dialplan_delete')\n\t\t\t) {\n\t\t\techo button::create(['type'=>'button','label'=>$text['button-delete'],'icon'=>$_SESSION['theme']['button_icon_delete'],'onclick'=>\"if (confirm('\".$text['confirm-delete'].\"')) { list_action_set('delete'); list_form_submit('form_list'); } else { this.blur(); return false; }\"]);\n\t\t}\n\t}\n\techo \t\t\"<form id='form_search' class='inline' method='get'>\\n\";\n\tif (permission_exists('dialplan_all')) {\n\t\tif ($_GET['show'] == 'all' && permission_exists('dialplan_all')) {\n\t\t\techo \"\t\t<input type='hidden' name='show' value='all'>\";\n\t\t}\n\t\telse {\n\t\t\tif (is_uuid($app_uuid)) { $params[] = \"app_uuid=\".urlencode($app_uuid); }\n\t\t\tif ($search) { $params[] = \"search=\".urlencode($search); }\n\t\t\tif ($order_by) { $params[] = \"order_by=\".urlencode($order_by); }\n\t\t\tif ($order) { $params[] = \"order=\".urlencode($order); }\n\t\t\techo button::create(['type'=>'button','label'=>$text['button-show_all'],'icon'=>$_SESSION['theme']['button_icon_all'],'link'=>'?show=all'.($params ? '&'.implode('&', $params) : null)]);\n\t\t\tunset($params);\n\t\t}\n\t}\n\tif (is_uuid($app_uuid)) {\n\t\techo \t\"<input type='hidden' name='app_uuid' value='\".escape($app_uuid).\"'>\";\n\t}\n\tif ($order_by) {\n\t\techo \t\"<input type='hidden' name='order_by' value='\".escape($order_by).\"'>\";\n\t}\n\tif ($order) {\n\t\techo \t\"<input type='hidden' name='order' value='\".escape($order).\"'>\";\n\t}\n\techo \t\t\"<input type='text' class='txt list-search' name='search' id='search' value=\\\"\".escape($search).\"\\\" placeholder=\\\"\".$text['label-search'].\"\\\" onkeydown='list_search_reset();'>\";\n\techo button::create(['label'=>$text['button-search'],'icon'=>$_SESSION['theme']['button_icon_search'],'type'=>'submit','id'=>'btn_search','style'=>($search != '' ? 'display: none;' : null)]);\n\t$params[] = \"app_uuid=\".urlencode($app_uuid);\n\tif ($order_by) { $params[] = \"order_by=\".urlencode($order_by); }\n\tif ($order) { $params[] = \"order=\".urlencode($order); }\n\tif ($_GET['show'] && permission_exists('dialplan_all')) { $params[] = \"show=\".urlencode($_GET['show']); }\n\techo button::create(['label'=>$text['button-reset'],'icon'=>$_SESSION['theme']['button_icon_reset'],'type'=>'button','id'=>'btn_reset','link'=>'dialplans.php'.($params ? '?'.implode('&', $params) : null),'style'=>($search == '' ? 'display: none;' : null)]);\n\tunset($params);\n\tif ($paging_controls_mini != '') {\n\t\techo \t\"<span style='margin-left: 15px;'>\".$paging_controls_mini.\"</span>\";\n\t}\n\techo \"\t\t</form>\\n\";\n\techo \"\t</div>\\n\";\n\techo \"\t<div style='clear: both;'></div>\\n\";\n\techo \"</div>\\n\";\n\n\tswitch ($app_uuid) {\n\t\tcase \"c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4\": echo $text['description-inbound_routes']; break;\n\t\tcase \"8c914ec3-9fc0-8ab5-4cda-6c9288bdc9a3\": echo $text['description-outbound_routes']; break;\n\t\tcase \"16589224-c876-aeb3-f59f-523a1c0801f7\": echo $text['description-queues']; break;\n\t\tcase \"4b821450-926b-175a-af93-a03c441818b1\": echo $text['description-time_conditions']; break;\n\t\tdefault: echo $text['description-dialplan_manager'.(if_group(\"superadmin\") ? '-superadmin' : null)];\n\t}\n\techo \"\\n<br /><br />\\n\";\n\n\techo \"<form id='form_list' method='post'>\\n\";\n\techo \"<input type='hidden' id='app_uuid' name='app_uuid' value='\".escape($app_uuid).\"'>\\n\";\n\techo \"<input type='hidden' id='action' name='action' value=''>\\n\";\n\techo \"<input type='hidden' name='search' value=\\\"\".escape($search).\"\\\">\\n\";\n\techo \"<input type='hidden' name='order_by' value=\\\"\".escape($order_by).\"\\\">\\n\";\n\techo \"<input type='hidden' name='order' value=\\\"\".escape($order).\"\\\">\\n\";\n\n\techo \"<table class='list'>\\n\";\n\techo \"<tr class='list-header'>\\n\";\n\tif (\n\t\t($app_uuid == \"c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4\" && (permission_exists('inbound_route_copy') || permission_exists('inbound_route_edit') || permission_exists('inbound_route_delete'))) ||\n\t\t($app_uuid == \"8c914ec3-9fc0-8ab5-4cda-6c9288bdc9a3\" && (permission_exists('outbound_route_copy') || permission_exists('outbound_route_edit') || permission_exists('outbound_route_delete'))) ||\n\t\t($app_uuid == \"16589224-c876-aeb3-f59f-523a1c0801f7\" && (permission_exists('fifo_add') || permission_exists('fifo_edit') || permission_exists('fifo_delete'))) ||\n\t\t($app_uuid == \"4b821450-926b-175a-af93-a03c441818b1\" && (permission_exists('time_condition_add') || permission_exists('time_condition_edit') || permission_exists('time_condition_delete'))) ||\n\t\tpermission_exists('dialplan_add') || permission_exists('dialplan_edit') || permission_exists('dialplan_delete')\n\t\t) {\n\t\techo \"\t<th class='checkbox'>\\n\";\n\t\techo \"\t\t<input type='checkbox' id='checkbox_all' name='checkbox_all' onclick='list_all_toggle();' \".($dialplans ?: \"style='visibility: hidden;'\").\">\\n\";\n\t\techo \"\t</th>\\n\";\n\t}\n\tif ($_GET['show'] == \"all\" && permission_exists('dialplan_all')) {\n\t\techo \"<th>\".$text['label-domain'].\"</th>\\n\";\n\t}\n\tif ($search) { $params[] = \"search=\".urlencode($search); }\n\tif ($_GET['show'] == 'all' && permission_exists('dialplan_all')) { $params[] = \"show=all\"; }\n\techo th_order_by('dialplan_name', $text['label-name'], $order_by, $order, $app_uuid, null, ($params ? implode('&', $params) : null));\n\techo th_order_by('dialplan_number', $text['label-number'], $order_by, $order, $app_uuid, null, ($params ? implode('&', $params) : null));\n\tif (permission_exists('dialplan_context')) {\n\t\techo th_order_by('dialplan_context', $text['label-context'], $order_by, $order, $app_uuid, null, ($params ? implode('&', $params) : null));\n\t}\n\techo th_order_by('dialplan_order', $text['label-order'], $order_by, $order, $app_uuid, \"class='center shrink'\", ($params ? implode('&', $params) : null));\n\techo th_order_by('dialplan_enabled', $text['label-enabled'], $order_by, $order, $app_uuid, \"class='center'\", ($params ? implode('&', $params) : null));\n\techo th_order_by('dialplan_description', $text['label-description'], $order_by, $order, $app_uuid, \"class='hide-sm-dn' style='min-width: 100px;'\", ($params ? implode('&', $params) : null));\n\tunset($params);\n\tif ((\n\t\t($app_uuid == \"c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4\" && permission_exists('inbound_route_edit')) ||\n\t\t($app_uuid == \"8c914ec3-9fc0-8ab5-4cda-6c9288bdc9a3\" && permission_exists('outbound_route_edit')) ||\n\t\t($app_uuid == \"16589224-c876-aeb3-f59f-523a1c0801f7\" && permission_exists('fifo_edit')) ||\n\t\t($app_uuid == \"4b821450-926b-175a-af93-a03c441818b1\" && permission_exists('time_condition_edit')) ||\n\t\tpermission_exists('dialplan_edit')) && $_SESSION['theme']['list_row_edit_button']['boolean'] == 'true'\n\t\t) {\n\t\techo \"\t<td class='action-button'>&nbsp;</td>\\n\";\n\t}\n\techo \"</tr>\\n\";\n\n\tif (is_array($dialplans) && @sizeof($dialplans) != 0) {\n\t\t$x = 0;\n\t\tforeach ($dialplans as $row) {\n\n\t\t\t//get the application id\n\t\t\tif (is_uuid($row['app_uuid'])) {\n\t\t\t\t$app_uuid = $row['app_uuid'];\n\t\t\t}\n\n\t\t\t// blank app id if doesn't match others, so will return to dialplan manager\n\t\t\tswitch ($app_uuid) {\n\t\t\t\tcase \"c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4\": // inbound route\n\t\t\t\tcase \"8c914ec3-9fc0-8ab5-4cda-6c9288bdc9a3\": // outbound route\n\t\t\t\tcase \"16589224-c876-aeb3-f59f-523a1c0801f7\": // fifo\n\t\t\t\tcase \"4b821450-926b-175a-af93-a03c441818b1\": // time condition\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tunset($app_uuid);\n\t\t\t}\n\n\t\t\tif ($app_uuid == \"4b821450-926b-175a-af93-a03c441818b1\" && permission_exists('time_condition_edit')) {\n\t\t\t\t$list_row_url = PROJECT_PATH.\"/app/time_conditions/time_condition_edit.php?id=\".urlencode($row['dialplan_uuid']).(is_uuid($app_uuid) ? \"&app_uuid=\".urlencode($app_uuid) : null);\n\t\t\t}\n\t\t\telse if (\n\t\t\t\t($app_uuid == \"c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4\" && permission_exists('inbound_route_edit')) ||\n\t\t\t\t($app_uuid == \"8c914ec3-9fc0-8ab5-4cda-6c9288bdc9a3\" && permission_exists('outbound_route_edit')) ||\n\t\t\t\t($app_uuid == \"16589224-c876-aeb3-f59f-523a1c0801f7\" && permission_exists('fifo_edit')) ||\n\t\t\t\tpermission_exists('dialplan_edit')\n\t\t\t\t) {\n\t\t\t\t$list_row_url = \"dialplan_edit.php?id=\".urlencode($row['dialplan_uuid']).(is_uuid($app_uuid) ? \"&app_uuid=\".urlencode($app_uuid) : null);\n\t\t\t}\n\t\t\techo \"<tr class='list-row' href='\".$list_row_url.\"'>\\n\";\n\t\t\tif (\n\t\t\t\t($app_uuid == \"c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4\" && (permission_exists('inbound_route_copy') || permission_exists('inbound_route_edit') || permission_exists('inbound_route_delete'))) ||\n\t\t\t\t($app_uuid == \"8c914ec3-9fc0-8ab5-4cda-6c9288bdc9a3\" && (permission_exists('outbound_route_copy') || permission_exists('outbound_route_edit') || permission_exists('outbound_route_delete'))) ||\n\t\t\t\t($app_uuid == \"16589224-c876-aeb3-f59f-523a1c0801f7\" && (permission_exists('fifo_add') || permission_exists('fifo_edit') || permission_exists('fifo_delete'))) ||\n\t\t\t\t($app_uuid == \"4b821450-926b-175a-af93-a03c441818b1\" && (permission_exists('time_condition_add') || permission_exists('time_condition_edit') || permission_exists('time_condition_delete'))) ||\n\t\t\t\tpermission_exists('dialplan_add') || permission_exists('dialplan_edit') || permission_exists('dialplan_delete')\n\t\t\t\t) {\n\t\t\t\techo \"\t<td class='checkbox'>\\n\";\n\t\t\t\techo \"\t\t<input type='checkbox' name='dialplans[$x][checked]' id='checkbox_\".$x.\"' value='true' onclick=\\\"if (!this.checked) { document.getElementById('checkbox_all').checked = false; }\\\">\\n\";\n\t\t\t\techo \"\t\t<input type='hidden' name='dialplans[$x][uuid]' value='\".escape($row['dialplan_uuid']).\"' />\\n\";\n\t\t\t\techo \"\t</td>\\n\";\n\t\t\t}\n\t\t\tif ($_GET['show'] == \"all\" && permission_exists('dialplan_all')) {\n\t\t\t\tif (strlen($_SESSION['domains'][$row['domain_uuid']]['domain_name']) > 0) {\n\t\t\t\t\t$domain = $_SESSION['domains'][$row['domain_uuid']]['domain_name'];\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t$domain = $text['label-global'];\n\t\t\t\t}\n\t\t\t\techo \"\t<td>\".escape($domain).\"</td>\\n\";\n\t\t\t}\n\t\t\techo \"\t<td>\";\n\t\t\tif ($list_row_url) {\n\t\t\t\techo \"<a href='\".$list_row_url.\"'>\".escape($row['dialplan_name']).\"</a>\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\techo escape($row['dialplan_name']);\n\t\t\t}\n\t\t\techo \"\t</td>\\n\";\n\t\t\techo \"\t<td>\".((strlen($row['dialplan_number']) > 0) ? escape(format_phone($row['dialplan_number'])) : \"&nbsp;\").\"</td>\\n\";\n\t\t\tif (permission_exists('dialplan_context')) {\n\t\t\t\techo \"\t<td>\".escape($row['dialplan_context']).\"</td>\\n\";\n\t\t\t}\n\t\t\techo \"\t<td class='center'>\".escape($row['dialplan_order']).\"</td>\\n\";\n\t\t\tif (\n\t\t\t\t($app_uuid == \"c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4\" && permission_exists('inbound_route_edit')) ||\n\t\t\t\t($app_uuid == \"8c914ec3-9fc0-8ab5-4cda-6c9288bdc9a3\" && permission_exists('outbound_route_edit')) ||\n\t\t\t\t($app_uuid == \"16589224-c876-aeb3-f59f-523a1c0801f7\" && permission_exists('fifo_edit')) ||\n\t\t\t\t($app_uuid == \"4b821450-926b-175a-af93-a03c441818b1\" && permission_exists('time_condition_edit')) ||\n\t\t\t\tpermission_exists('dialplan_edit')\n\t\t\t\t) {\n\t\t\t\techo \"\t<td class='no-link center'>\";\n\t\t\t\techo button::create(['type'=>'submit','class'=>'link','label'=>$text['label-'.$row['dialplan_enabled']],'title'=>$text['button-toggle'],'onclick'=>\"list_self_check('checkbox_\".$x.\"'); list_action_set('toggle'); list_form_submit('form_list')\"]);\n\t\t\t}\n\t\t\telse {\n\t\t\t\techo \"\t<td class='center'>\";\n\t\t\t\techo $text['label-'.$row['dialplan_enabled']];\n\t\t\t}\n\t\t\techo \"\t</td>\\n\";\n\t\t\techo \"\t<td class='description overflow hide-sm-dn'>\".escape($row['dialplan_description']).\"&nbsp;</td>\\n\";\n\t\t\tif ((\n\t\t\t\t($app_uuid == \"c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4\" && permission_exists('inbound_route_edit')) ||\n\t\t\t\t($app_uuid == \"8c914ec3-9fc0-8ab5-4cda-6c9288bdc9a3\" && permission_exists('outbound_route_edit')) ||\n\t\t\t\t($app_uuid == \"16589224-c876-aeb3-f59f-523a1c0801f7\" && permission_exists('fifo_edit')) ||\n\t\t\t\t($app_uuid == \"4b821450-926b-175a-af93-a03c441818b1\" && permission_exists('time_condition_edit')) ||\n\t\t\t\tpermission_exists('dialplan_edit')) && $_SESSION['theme']['list_row_edit_button']['boolean'] == 'true'\n\t\t\t\t) {\n\t\t\t\techo \"\t<td class='action-button'>\";\n\t\t\t\techo button::create(['type'=>'button','title'=>$text['button-edit'],'icon'=>$_SESSION['theme']['button_icon_edit'],'link'=>$list_row_url]);\n\t\t\t\techo \"\t</td>\\n\";\n\t\t\t}\n\t\t\techo \"</tr>\\n\";\n\t\t\t$x++;\n\t\t}\n\t\tunset($dialplans);\n\t}\n\n\techo \"</table>\\n\";\n\techo \"<br />\\n\";\n\techo \"<div align='center'>\".$paging_controls.\"</div>\\n\";\n\n\techo \"<input type='hidden' name='\".$token['name'].\"' value='\".$token['hash'].\"'>\\n\";\n\n\techo \"</form>\\n\";\n\n//include the footer\n\trequire_once \"resources/footer.php\";\n\n?>\n"], "filenames": ["app/dialplans/dialplans.php"], "buggy_code_start_loc": [48], "buggy_code_end_loc": [463], "fixing_code_start_loc": [47], "fixing_code_end_loc": [466], "type": "CWE-79", "message": "A cross-site scripting (XSS) vulnerability in app/dialplans/dialplans.php in FusionPBX 4.4.1 allows remote attackers to inject arbitrary web script or HTML via the app_uuid parameter.", "other": {"cve": {"id": "CVE-2019-19385", "sourceIdentifier": "cve@mitre.org", "published": "2019-11-29T00:15:11.463", "lastModified": "2019-12-02T19:56:44.530", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "A cross-site scripting (XSS) vulnerability in app/dialplans/dialplans.php in FusionPBX 4.4.1 allows remote attackers to inject arbitrary web script or HTML via the app_uuid parameter."}, {"lang": "es", "value": "Una vulnerabilidad de tipo cross-site scripting (XSS) en el archivo app/dialplans/dialplans.php en FusionPBX versi\u00f3n 4.4.1, permite a atacantes remotos inyectar script web o HTML arbitrario por medio del par\u00e1metro app_uuid."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:fusionpbx:fusionpbx:4.4.1:*:*:*:*:*:*:*", "matchCriteriaId": "954E2072-AC03-4E55-8A7F-640534279042"}]}]}], "references": [{"url": "https://gist.github.com/xax007/28e7326acfae677be0b351216888e522", "source": "cve@mitre.org", "tags": ["Exploit", "Patch", "Third Party Advisory"]}, {"url": "https://github.com/fusionpbx/fusionpbx/commit/fe504b83db80ebae30c982770f0f0b200b88cbe9", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/fusionpbx/fusionpbx/commit/fe504b83db80ebae30c982770f0f0b200b88cbe9"}}