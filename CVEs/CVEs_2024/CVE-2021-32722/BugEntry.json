{"buggy_code": ["{\n\t\"name\": \"GlobalNewFiles\",\n\t\"author\": [\n\t\t\"John Lewis\",\n\t\t\"Paladox\",\n\t\t\"Southparkfan\",\n\t\t\"Universal Omega\"\n\t],\n\t\"url\": \"//github.com/miraheze/GlobalNewFiles\",\n\t\"descriptionmsg\": \"globalnewfiles-description\",\n\t\"license-name\": \"GPL-3.0-or-later\",\n\t\"type\": \"specialpage\",\n\t\"requires\": {\n\t\t\"MediaWiki\": \">= 1.36.0\",\n\t\t\"extensions\": {\n\t\t\t\"CreateWiki\": \"*\"\n\t\t}\n\t},\n\t\"MessagesDirs\": {\n\t\t\"GlobalNewFiles\": [\n\t\t\t\"i18n\"\n\t\t]\n\t},\n\t\"ExtensionMessagesFiles\": {\n\t\t\"GlobalNewFilesAliases\": \"includes/GlobalNewFilesAliases.php\"\n\t},\n\t\"AvailableRights\": [\n\t\t\"viewglobalprivatefiles\"\n\t],\n\t\"AutoloadClasses\": {\n\t\t\"GlobalNewFilesHooks\": \"includes/GlobalNewFilesHooks.php\",\n\t\t\"GlobalNewFilesPager\": \"includes/GlobalNewFilesPager.php\",\n\t\t\"SpecialGlobalNewFiles\": \"includes/SpecialGlobalNewFiles.php\",\n\t\t\"GlobalNewFilesInsertJob\": \"includes/jobs/GlobalNewFilesInsertJob.php\",\n\t\t\"GlobalNewFilesDeleteJob\": \"includes/jobs/GlobalNewFilesDeleteJob.php\",\n\t\t\"GlobalNewFilesMoveJob\": \"includes/jobs/GlobalNewFilesMoveJob.php\"\n\t},\n\t\"JobClasses\": {\n\t\t\"GlobalNewFilesInsertJob\": \"GlobalNewFilesInsertJob\",\n\t\t\"GlobalNewFilesDeleteJob\": \"GlobalNewFilesDeleteJob\",\n\t\t\"GlobalNewFilesMoveJob\": \"GlobalNewFilesMoveJob\"\n\t},\n\t\"SpecialPages\": {\n\t\t\"GlobalNewFiles\": \"SpecialGlobalNewFiles\"\n\t},\n\t\"Hooks\": {\n\t\t\"CreateWikiTables\": [\n\t\t\t\"GlobalNewFilesHooks::onCreateWikiTables\"\n\t\t],\n\t\t\"LoadExtensionSchemaUpdates\": [\n\t\t\t\"GlobalNewFilesHooks::onLoadExtensionSchemaUpdates\"\n\t\t],\n\t\t\"FileDeleteComplete\": [\n\t\t\t\"GlobalNewFilesHooks::onFileDeleteComplete\"\n\t\t],\n\t\t\"TitleMoveComplete\": [\n\t\t\t\"GlobalNewFilesHooks::onTitleMoveComplete\"\n\t\t],\n\t\t\"UploadComplete\": [\n\t\t\t\"GlobalNewFilesHooks::onUploadComplete\"\n\t\t]\n\t},\n\t\"ConfigRegistry\": {\n\t\t\"globalnewfiles\": \"GlobalVarConfig::newInstance\"\n\t},\n\t\"manifest_version\": 2\n}\n", "<?php\n\nuse MediaWiki\\MediaWikiServices;\n\nclass GlobalNewFilesHooks {\n\tpublic static function onCreateWikiTables( &$tables ) {\n\t\t$tables['gnf_files'] = 'files_dbname';\n\t}\n\n\tpublic static function onUploadComplete( $uploadBase ) {\n\t\tJobQueueGroup::singleton()->push(\n\t\t\tnew GlobalNewFilesInsertJob( $uploadBase->getTitle(), [] )\n\t\t);\n\t}\n\n\tpublic static function onFileDeleteComplete( $file, $oldimage, $article, $user, $reason ) {\n\t\tJobQueueGroup::singleton()->push(\n\t\t\tnew GlobalNewFilesDeleteJob( $file->getTitle(), [] )\n\t\t);\n\t}\n\n\tpublic static function onTitleMoveComplete( $title, $newTitle, $user, $oldid, $newid, $reason, $revision ) {\n\t\tif ( $title->inNamespace( NS_FILE ) ) {\n\t\t\tJobQueueGroup::singleton()->push(\n\t\t\t\tnew GlobalNewFilesMoveJob( [ 'oldtitle' => $title, 'newtitle' => $newTitle ] )\n\t\t\t);\n\t\t}\n\t}\n\n\tpublic static function onLoadExtensionSchemaUpdates( DatabaseUpdater $updater ) {\n\t\t$config = MediaWikiServices::getInstance()->getConfigFactory()->makeConfig( 'globalnewfiles' );\n\n\t\tif ( $config->get( 'CreateWikiDatabase' ) === $config->get( 'DBname' ) ) {\n\t\t\t$updater->addExtensionTable(\n\t\t\t\t'gnf_files',\n\t\t\t\t__DIR__ . '/../sql/gnf_files.sql'\n\t\t\t);\n\n\t\t\t$updater->modifyExtensionField(\n\t\t\t\t'gnf_files',\n\t\t\t\t'files_timestamp',\n\t\t\t\t__DIR__ . '/../sql/patches/patch-gnf_files-binary.sql' \n\t\t\t);\n\n\t\t\t$updater->modifyTable(\n \t\t\t\t'gnf_files',\n  \t\t\t\t__DIR__ . '/../sql/patches/patch-gnf_files-add-indexes.sql',\n\t\t\t\ttrue\n \t\t\t);\n\t\t}\n\n\t\treturn true;\n\t}\n\n\t/**\n\t * @param int $index DB_PRIMARY/DB_REPLICA\n\t * @param array|string $groups\n\t * @return IDatabase\n\t */\n\tpublic static function getGlobalDB( $index, $groups = [] ) {\n\t\t$config = MediaWikiServices::getInstance()->getConfigFactory()->makeConfig( 'globalnewfiles' );\n\n\t\t$lbFactory = MediaWikiServices::getInstance()->getDBLoadBalancerFactory();\n\t\t$lb = $lbFactory->getMainLB( $config->get( 'CreateWikiDatabase' ) );\n\n\t\treturn $lb->getConnectionRef( $index, $groups, $config->get( 'CreateWikiDatabase' ) );\n\t}\n}\n"], "fixing_code": ["{\n\t\"name\": \"GlobalNewFiles\",\n\t\"author\": [\n\t\t\"John Lewis\",\n\t\t\"Paladox\",\n\t\t\"Southparkfan\",\n\t\t\"Universal Omega\"\n\t],\n\t\"url\": \"//github.com/miraheze/GlobalNewFiles\",\n\t\"descriptionmsg\": \"globalnewfiles-description\",\n\t\"license-name\": \"GPL-3.0-or-later\",\n\t\"type\": \"specialpage\",\n\t\"requires\": {\n\t\t\"MediaWiki\": \">= 1.36.0\",\n\t\t\"extensions\": {\n\t\t\t\"CreateWiki\": \"*\"\n\t\t}\n\t},\n\t\"MessagesDirs\": {\n\t\t\"GlobalNewFiles\": [\n\t\t\t\"i18n\"\n\t\t]\n\t},\n\t\"ExtensionMessagesFiles\": {\n\t\t\"GlobalNewFilesAliases\": \"includes/GlobalNewFilesAliases.php\"\n\t},\n\t\"AvailableRights\": [\n\t\t\"viewglobalprivatefiles\"\n\t],\n\t\"AutoloadClasses\": {\n\t\t\"GlobalNewFilesHooks\": \"includes/GlobalNewFilesHooks.php\",\n\t\t\"GlobalNewFilesPager\": \"includes/GlobalNewFilesPager.php\",\n\t\t\"SpecialGlobalNewFiles\": \"includes/SpecialGlobalNewFiles.php\",\n\t\t\"GlobalNewFilesInsertJob\": \"includes/jobs/GlobalNewFilesInsertJob.php\",\n\t\t\"GlobalNewFilesDeleteJob\": \"includes/jobs/GlobalNewFilesDeleteJob.php\",\n\t\t\"GlobalNewFilesMoveJob\": \"includes/jobs/GlobalNewFilesMoveJob.php\"\n\t},\n\t\"JobClasses\": {\n\t\t\"GlobalNewFilesInsertJob\": \"GlobalNewFilesInsertJob\",\n\t\t\"GlobalNewFilesDeleteJob\": \"GlobalNewFilesDeleteJob\",\n\t\t\"GlobalNewFilesMoveJob\": \"GlobalNewFilesMoveJob\"\n\t},\n\t\"SpecialPages\": {\n\t\t\"GlobalNewFiles\": \"SpecialGlobalNewFiles\"\n\t},\n\t\"Hooks\": {\n\t\t\"CreateWikiTables\": [\n\t\t\t\"GlobalNewFilesHooks::onCreateWikiTables\"\n\t\t],\n\t\t\"LoadExtensionSchemaUpdates\": [\n\t\t\t\"GlobalNewFilesHooks::onLoadExtensionSchemaUpdates\"\n\t\t],\n\t\t\"FileDeleteComplete\": [\n\t\t\t\"GlobalNewFilesHooks::onFileDeleteComplete\"\n\t\t],\n\t\t\"PageMoveComplete\": [\n\t\t\t\"GlobalNewFilesHooks::onPageMoveComplete\"\n\t\t],\n\t\t\"UploadComplete\": [\n\t\t\t\"GlobalNewFilesHooks::onUploadComplete\"\n\t\t]\n\t},\n\t\"ConfigRegistry\": {\n\t\t\"globalnewfiles\": \"GlobalVarConfig::newInstance\"\n\t},\n\t\"manifest_version\": 2\n}\n", "<?php\n\nuse MediaWiki\\MediaWikiServices;\n\nclass GlobalNewFilesHooks {\n\tpublic static function onCreateWikiTables( &$tables ) {\n\t\t$tables['gnf_files'] = 'files_dbname';\n\t}\n\n\tpublic static function onUploadComplete( $uploadBase ) {\n\t\tJobQueueGroup::singleton()->push(\n\t\t\tnew GlobalNewFilesInsertJob( $uploadBase->getTitle(), [] )\n\t\t);\n\t}\n\n\tpublic static function onFileDeleteComplete( $file, $oldimage, $article, $user, $reason ) {\n\t\tJobQueueGroup::singleton()->push(\n\t\t\tnew GlobalNewFilesDeleteJob( $file->getTitle(), [] )\n\t\t);\n\t}\n\n\tpublic static function onPageMoveComplete( $old, $new, $userIdentity, $pageid, $redirid, $reason, $revision ) {\n\t\t$oldTitle = Title::newFromLinkTarget( $old );\n\t\t$newTitle = Title::newFromLinkTarget( $new );\n\n\t\tif ( $oldTitle->inNamespace( NS_FILE ) ) {\n\t\t\tJobQueueGroup::singleton()->push(\n\t\t\t\tnew GlobalNewFilesMoveJob( [ 'oldtitle' => $oldTitle, 'newtitle' => $newTitle ] )\n\t\t\t);\n\t\t}\n\t}\n\n\tpublic static function onLoadExtensionSchemaUpdates( DatabaseUpdater $updater ) {\n\t\t$config = MediaWikiServices::getInstance()->getConfigFactory()->makeConfig( 'globalnewfiles' );\n\n\t\tif ( $config->get( 'CreateWikiDatabase' ) === $config->get( 'DBname' ) ) {\n\t\t\t$updater->addExtensionTable(\n\t\t\t\t'gnf_files',\n\t\t\t\t__DIR__ . '/../sql/gnf_files.sql'\n\t\t\t);\n\n\t\t\t$updater->modifyExtensionField(\n\t\t\t\t'gnf_files',\n\t\t\t\t'files_timestamp',\n\t\t\t\t__DIR__ . '/../sql/patches/patch-gnf_files-binary.sql' \n\t\t\t);\n\n\t\t\t$updater->modifyTable(\n \t\t\t\t'gnf_files',\n  \t\t\t\t__DIR__ . '/../sql/patches/patch-gnf_files-add-indexes.sql',\n\t\t\t\ttrue\n \t\t\t);\n\t\t}\n\n\t\treturn true;\n\t}\n\n\t/**\n\t * @param int $index DB_PRIMARY/DB_REPLICA\n\t * @param array|string $groups\n\t * @return IDatabase\n\t */\n\tpublic static function getGlobalDB( $index, $groups = [] ) {\n\t\t$config = MediaWikiServices::getInstance()->getConfigFactory()->makeConfig( 'globalnewfiles' );\n\n\t\t$lbFactory = MediaWikiServices::getInstance()->getDBLoadBalancerFactory();\n\t\t$lb = $lbFactory->getMainLB( $config->get( 'CreateWikiDatabase' ) );\n\n\t\treturn $lb->getConnectionRef( $index, $groups, $config->get( 'CreateWikiDatabase' ) );\n\t}\n}\n"], "filenames": ["extension.json", "includes/GlobalNewFilesHooks.php"], "buggy_code_start_loc": [56, 22], "buggy_code_end_loc": [58, 26], "fixing_code_start_loc": [56, 22], "fixing_code_end_loc": [58, 29], "type": "CWE-400", "message": "GlobalNewFiles is a mediawiki extension. Versions prior to 48be7adb70568e20e961ea1cb70904454a671b1d are affected by an uncontrolled resource consumption vulnerability. A large amount of page moves within a short space of time could overwhelm Database servers due to improper handling of load balancing and a lack of an appropriate index. As a workaround, one may avoid use of the extension unless additional rate limit at the MediaWiki level or via PoolCounter / MySQL is enabled. A patch is available in version 48be7adb70568e20e961ea1cb70904454a671b1d.", "other": {"cve": {"id": "CVE-2021-32722", "sourceIdentifier": "security-advisories@github.com", "published": "2021-06-28T20:15:07.773", "lastModified": "2021-09-20T18:52:26.380", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "GlobalNewFiles is a mediawiki extension. Versions prior to 48be7adb70568e20e961ea1cb70904454a671b1d are affected by an uncontrolled resource consumption vulnerability. A large amount of page moves within a short space of time could overwhelm Database servers due to improper handling of load balancing and a lack of an appropriate index. As a workaround, one may avoid use of the extension unless additional rate limit at the MediaWiki level or via PoolCounter / MySQL is enabled. A patch is available in version 48be7adb70568e20e961ea1cb70904454a671b1d."}, {"lang": "es", "value": "GlobalNewFiles es una extensi\u00f3n de mediawiki. Las versiones anteriores a la 48be7adb70568e20e961ea1cb70904454a671b1d est\u00e1n afectadas por una vulnerabilidad de consumo incontrolado de recursos. Una gran cantidad de movimientos de p\u00e1ginas en un corto espacio de tiempo podr\u00eda saturar los servidores de la Base de Datos debido a un manejo inadecuado del balanceo de carga y a la falta de un \u00edndice apropiado. Como soluci\u00f3n, se puede evitar el uso de la extensi\u00f3n a menos que se habilite un l\u00edmite de velocidad adicional a nivel de MediaWiki o a trav\u00e9s de PoolCounter / MySQL. Hay un parche disponible en la versi\u00f3n 48be7adb70568e20e961ea1cb70904454a671b1d"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "NONE", "integrityImpact": "NONE", "availabilityImpact": "HIGH", "baseScore": 6.5, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 3.6}, {"source": "security-advisories@github.com", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "NONE", "integrityImpact": "NONE", "availabilityImpact": "HIGH", "baseScore": 6.5, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 3.6}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:S/C:N/I:N/A:P", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "SINGLE", "confidentialityImpact": "NONE", "integrityImpact": "NONE", "availabilityImpact": "PARTIAL", "baseScore": 4.0}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.0, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-400"}]}, {"source": "security-advisories@github.com", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-400"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:miraheze:globalnewfiles:*:*:*:*:*:mediawiki:*:*", "matchCriteriaId": "F0F9FCDD-C850-45C4-A58F-C24664B53F62"}]}]}], "references": [{"url": "https://github.com/miraheze/GlobalNewFiles/commit/48be7adb70568e20e961ea1cb70904454a671b1d", "source": "security-advisories@github.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/miraheze/GlobalNewFiles/pull/17", "source": "security-advisories@github.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/miraheze/GlobalNewFiles/security/advisories/GHSA-cwv5-c938-5h5h", "source": "security-advisories@github.com", "tags": ["Third Party Advisory"]}, {"url": "https://phabricator.miraheze.org/T7532", "source": "security-advisories@github.com", "tags": ["Issue Tracking", "Vendor Advisory"]}]}, "github_commit_url": "https://github.com/miraheze/GlobalNewFiles/commit/48be7adb70568e20e961ea1cb70904454a671b1d"}}