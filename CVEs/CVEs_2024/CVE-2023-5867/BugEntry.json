{"buggy_code": ["<?php\n\n/**\n * The FAQ record editor.\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at https://mozilla.org/MPL/2.0/.\n *\n * @package   phpMyFAQ\n * @author    Thorsten Rinne <thorsten@phpmyfaq.de>\n * @copyright 2003-2023 phpMyFAQ Team\n * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n * @link      https://www.phpmyfaq.de\n * @since     2003-02-23\n */\n\nuse phpMyFAQ\\Attachment\\AttachmentFactory;\nuse phpMyFAQ\\Category;\nuse phpMyFAQ\\Category\\CategoryRelation;\nuse phpMyFAQ\\Changelog;\nuse phpMyFAQ\\Configuration;\nuse phpMyFAQ\\Database;\nuse phpMyFAQ\\Date;\nuse phpMyFAQ\\Faq;\nuse phpMyFAQ\\Faq\\FaqPermission;\nuse phpMyFAQ\\Filter;\nuse phpMyFAQ\\Helper\\CategoryHelper;\nuse phpMyFAQ\\Helper\\LanguageHelper;\nuse phpMyFAQ\\Helper\\UserHelper;\nuse phpMyFAQ\\Link;\nuse phpMyFAQ\\AdminLog;\nuse phpMyFAQ\\Question;\nuse phpMyFAQ\\Revision;\nuse phpMyFAQ\\Session\\Token;\nuse phpMyFAQ\\Strings;\nuse phpMyFAQ\\Tags;\nuse phpMyFAQ\\Translation;\nuse phpMyFAQ\\User;\nuse phpMyFAQ\\User\\CurrentUser;\nuse phpMyFAQ\\Utils;\n\nif (!defined('IS_VALID_PHPMYFAQ')) {\n    http_response_code(400);\n    exit();\n}\n\n$faqConfig = Configuration::getConfigurationInstance();\n$currentUserId = CurrentUser::getCurrentUser($faqConfig)->getUserId();\n\nif (\n    ($user->perm->hasPermission($currentUserId, 'edit_faq') ||\n     $user->perm->hasPermission($currentUserId, 'add_faq')) && !Database::checkOnEmptyTable('faqcategories')\n) {\n    $category = new Category($faqConfig, [], false);\n\n    if ($faqConfig->get('main.enableCategoryRestrictions')) {\n        $category = new Category($faqConfig, $currentAdminGroups, true);\n    }\n\n    $category->setUser($currentAdminUser);\n    $category->setGroups($currentAdminGroups);\n    $category->buildCategoryTree();\n\n    $categoryRelation = new CategoryRelation($faqConfig, $category);\n\n    $categoryHelper = new CategoryHelper();\n    $categoryHelper->setCategory($category);\n\n    $faq = new Faq($faqConfig);\n\n    $faqPermission = new FaqPermission($faqConfig);\n\n    $questionObject = new Question($faqConfig);\n\n    $changelog = new Changelog($faqConfig);\n\n    $userHelper = new UserHelper($user);\n\n    $selectedCategory = '';\n    $categories = [];\n    $faqData = [\n        'id' => 0,\n        'lang' => $faqLangCode,\n        'revision_id' => 0,\n        'title' => '',\n        'dateStart' => '',\n        'dateEnd' => '',\n    ];\n\n    $tagging = new Tags($faqConfig);\n    $date = new Date($faqConfig);\n\n    if ('takequestion' === $action) {\n        $questionId = Filter::filterInput(INPUT_GET, 'id', FILTER_VALIDATE_INT);\n        $question = $questionObject->getQuestion($questionId);\n        $selectedCategory = $question['category_id'];\n        $faqData['title'] = $question['question'];\n        $notifyUser = $question['username'];\n        $notifyEmail = $question['email'];\n        $categories = [\n            'category_id' => $selectedCategory,\n            'category_lang' => $faqData['lang'],\n        ];\n    } else {\n        $questionId = 0;\n        $notifyUser = '';\n        $notifyEmail = '';\n    }\n\n    if ('editpreview' === $action) {\n        $faqData['id'] = Filter::filterInput(INPUT_POST, 'id', FILTER_VALIDATE_INT);\n        if (!is_null($faqData['id'])) {\n            $queryString = 'saveentry&id=' . $faqData['id'];\n        } else {\n            $queryString = 'insertentry';\n        }\n\n        $faqData['lang'] = Filter::filterInput(INPUT_POST, 'lang', FILTER_SANITIZE_SPECIAL_CHARS);\n        $selectedCategory = Filter::filterInputArray(\n            INPUT_POST,\n            [\n                'rubrik' => [\n                    'filter' => FILTER_VALIDATE_INT,\n                    'flags' => FILTER_REQUIRE_ARRAY,\n                ],\n            ]\n        );\n        if (is_array($selectedCategory)) {\n            foreach ($selectedCategory as $cats) {\n                $categories[] = ['category_id' => $cats, 'category_lang' => $faqData['lang']];\n            }\n        }\n        $faqData['active'] = Filter::filterInput(INPUT_POST, 'active', FILTER_SANITIZE_SPECIAL_CHARS);\n        $faqData['keywords'] = Filter::filterInput(INPUT_POST, 'keywords', FILTER_SANITIZE_SPECIAL_CHARS);\n        $faqData['title'] = Filter::filterInput(INPUT_POST, 'thema', FILTER_SANITIZE_SPECIAL_CHARS);\n        $faqData['content'] = Filter::filterInput(INPUT_POST, 'content', FILTER_SANITIZE_SPECIAL_CHARS);\n        $faqData['author'] = Filter::filterInput(INPUT_POST, 'author', FILTER_SANITIZE_SPECIAL_CHARS);\n        $faqData['email'] = Filter::filterInput(INPUT_POST, 'email', FILTER_VALIDATE_EMAIL);\n        $faqData['comment'] = Filter::filterInput(INPUT_POST, 'comment', FILTER_SANITIZE_SPECIAL_CHARS);\n        $faqData['solution_id'] = Filter::filterInput(INPUT_POST, 'solution_id', FILTER_VALIDATE_INT);\n        $faqData['revision_id'] = Filter::filterInput(INPUT_POST, 'revision_id', FILTER_VALIDATE_INT, 0);\n        $faqData['sticky'] = Filter::filterInput(INPUT_POST, 'sticky', FILTER_VALIDATE_INT);\n        $faqData['tags'] = Filter::filterInput(INPUT_POST, 'tags', FILTER_SANITIZE_SPECIAL_CHARS);\n        $faqData['changed'] = Filter::filterInput(INPUT_POST, 'changed', FILTER_SANITIZE_SPECIAL_CHARS);\n        $faqData['dateStart'] = Filter::filterInput(INPUT_POST, 'dateStart', FILTER_SANITIZE_SPECIAL_CHARS);\n        $faqData['dateEnd'] = Filter::filterInput(INPUT_POST, 'dateEnd', FILTER_SANITIZE_SPECIAL_CHARS);\n        $faqData['content'] = html_entity_decode((string) $faqData['content']);\n    } elseif ('editentry' === $action) {\n        $id = Filter::filterInput(INPUT_GET, 'id', FILTER_VALIDATE_INT);\n        $lang = Filter::filterInput(INPUT_GET, 'lang', FILTER_SANITIZE_SPECIAL_CHARS);\n        $translateTo = Filter::filterInput(INPUT_GET, 'translateTo', FILTER_SANITIZE_SPECIAL_CHARS);\n        $categoryId = Filter::filterInput(INPUT_GET, 'cat', FILTER_VALIDATE_INT);\n\n        if (!is_null($translateTo)) {\n            $faqData['lang'] = $lang = $translateTo;\n            $selectedCategory = $categoryId;\n        }\n\n        if ((!isset($selectedCategory) && !isset($faqData['title'])) || !is_null($id)) {\n            $logging = new AdminLog($faqConfig);\n            $logging->log($user, 'admin-edit-faq ' . $id);\n\n            $categories = $categoryRelation->getCategories($id, $lang);\n            if (count($categories) === 0) {\n                $categories = [\n                    'category_id' => $selectedCategory,\n                    'category_lang' => $faqData['lang'],\n                ];\n            }\n\n            $faq->getRecord($id, null, true);\n            $faqData = $faq->faqRecord;\n            if (!is_null($translateTo)) {\n                $faqData['lang'] = $translateTo; // once again\n            }\n            $faqData['tags'] = implode(', ', $tagging->getAllTagsById($faqData['id']));\n\n            $queryString = 'saveentry&amp;id=' . $faqData['id'];\n        } else {\n            $queryString = 'insertentry';\n            if (isset($categoryId)) {\n                $categories = ['category_id' => $categoryId, 'category_lang' => $lang];\n            }\n        }\n    } elseif ('copyentry' === $action) {\n        $faqData['id'] = Filter::filterInput(INPUT_GET, 'id', FILTER_VALIDATE_INT);\n        $faqData['lang'] = Filter::filterInput(INPUT_GET, 'lang', FILTER_SANITIZE_SPECIAL_CHARS);\n        $categories = $categoryRelation->getCategories($faqData['id'], $faqData['lang']);\n\n        $faq->getRecord($faqData['id'], null, true);\n\n        $faqData = $faq->faqRecord;\n        $faqData['tags'] = implode(', ', $tagging->getAllTagsById($faqData['id']));\n        $queryString = 'insertentry';\n    } else {\n        $logging = new AdminLog($faqConfig);\n        $logging->log($user, 'admin-add-faq');\n        $queryString = 'insertentry';\n        if (!is_array($categories)) {\n            $categories = [];\n        }\n    }\n\n    // Revisions\n    $selectedRevisionId = Filter::filterInput(INPUT_POST, 'revisionid_selected', FILTER_VALIDATE_INT);\n    if (is_null($selectedRevisionId)) {\n        $selectedRevisionId = $faqData['revision_id'];\n    }\n\n    // User permissions\n    $userPermission = $faqPermission->get(FaqPermission::USER, $faqData['id']);\n    if (count($userPermission) == 0 || $userPermission[0] == -1) {\n        $allUsers = true;\n        $restrictedUsers = false;\n        $userPermission[0] = -1;\n    } else {\n        $allUsers = false;\n        $restrictedUsers = true;\n    }\n\n    // Group permissions\n    $groupPermission = $faqPermission->get(FaqPermission::GROUP, $faqData['id']);\n    if (count($groupPermission) == 0 || $groupPermission[0] == -1) {\n        $allGroups = true;\n        $restrictedGroups = false;\n        $groupPermission[0] = -1;\n    } else {\n        $allGroups = false;\n        $restrictedGroups = true;\n    }\n\n    // Set data for forms\n    $faqData['title'] = (isset($faqData['title']) ? Strings::htmlentities($faqData['title'], ENT_HTML5 | ENT_COMPAT) : '');\n    $faqData['content'] =\n        (isset($faqData['content']) ? trim(Strings::htmlentities($faqData['content'], ENT_COMPAT, 'utf-8', true)) : '');\n    $faqData['tags'] = (isset($faqData['tags']) ? Strings::htmlentities($faqData['tags']) : '');\n    $faqData['keywords'] = (isset($faqData['keywords']) ? Strings::htmlentities($faqData['keywords']) : '');\n    $faqData['author'] = (isset($faqData['author']) ? Strings::htmlentities(\n        $faqData['author']\n    ) : $user->getUserData('display_name'));\n    $faqData['email'] = (isset($faqData['email']) ? Strings::htmlentities($faqData['email']) : $user->getUserData(\n        'email'\n    ));\n    $faqData['isoDate'] = ($faqData['date'] ?? date('Y-m-d H:i'));\n    $faqData['date'] = (isset($faqData['date']) ? $date->format($faqData['date']) : $date->format(date('Y-m-d H:i')));\n    $faqData['changed'] ??= '';\n\n    if (isset($faqData['comment']) && $faqData['comment'] == 'y') {\n        $faqData['comment'] = ' checked';\n    } elseif ($faqConfig->get('records.defaultAllowComments')) {\n        $faqData['comment'] = ' checked';\n    } else {\n        $faqData['comment'] = '';\n    }\n\n    // Header\n    if (0 !== $faqData['id'] && 'copyentry' !== $action) {\n        $currentRevision = sprintf('%s 1.%d', Translation::get('ad_entry_revision'), $selectedRevisionId);\n\n        $faqUrl = sprintf(\n            '%sindex.php?action=faq&cat=%s&id=%d&artlang=%s',\n            $faqConfig->getDefaultUrl(),\n            $category->getCategoryIdFromFaq($faqData['id']),\n            $faqData['id'],\n            $faqData['lang']\n        );\n\n        $link = new Link($faqUrl, $faqConfig);\n        $link->itemTitle = $faqData['title'];\n\n        ?>\n        <div class=\"d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom\">\n            <h1 class=\"h2\">\n                <i aria-hidden=\"true\" class=\"fa fa-edit\"></i>\n                <?= Translation::get('ad_entry_edit_1') ?>\n                <?= Translation::get('ad_entry_edit_2') ?>\n            </h1>\n            <div class=\"btn-toolbar mb-2 mb-md-0\">\n                <div class=\"btn-group mr-2\">\n              <span class=\"btn btn-sm btn-info\">\n                <i class=\"fa fa-hashtag\" aria-hidden=\"true\"></i>\n                <?= $currentRevision ?>\n              </span>\n                    <a href=\"<?= $link->toString() ?>\" class=\"btn btn-sm btn-success\">\n                        <i class=\"fa fa-arrow-alt-circle-right\" aria-hidden=\"true\"></i>\n                        <?= Translation::get('ad_view_faq') ?>\n                    </a>\n                </div>\n            </div>\n        </div>\n\n    <?php } else { ?>\n        <div class=\"d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom\">\n            <h1 class=\"h2\">\n                <i aria-hidden=\"true\" class=\"fa fa-edit\"></i>\n                <?= Translation::get('ad_entry_add') ?>\n            </h1>\n        </div>\n\n    <?php } ?>\n\n        <div class=\"row\">\n            <div class=\"col-lg-9\">\n                <div class=\"card mb-4\">\n                    <div class=\"card-header\">\n                        <ul class=\"nav nav-tabs card-header-tabs\" id=\"nav-tab\" role=\"tablist\">\n                            <li class=\"nav-item\">\n                                <a class=\"nav-link active\" data-bs-toggle=\"tab\" href=\"#tab-question-answer\" role=\"tab\">\n                                    <i class=\"fa fa-pencil-square-o\"></i> <?= Translation::get('ad_record_faq') ?>\n                                </a>\n                            </li>\n                            <li class=\"nav-item\">\n                                <a class=\"nav-link\" data-bs-toggle=\"tab\" href=\"#tab-meta-data\" role=\"tab\">\n                                    <i class=\"fa fa-database\"></i> <?= Translation::get('ad_menu_faq_meta') ?>\n                                </a>\n                            </li>\n                            <li class=\"nav-item\">\n                                <a class=\"nav-link\" data-bs-toggle=\"tab\" href=\"#tab-permissions\" role=\"tab\">\n                                    <i class=\"fa fa-unlock-alt\"></i> <?= Translation::get('ad_record_permissions') ?>\n                                </a>\n                            </li>\n                            <li class=\"nav-item\">\n                                <a class=\"nav-link\" data-bs-toggle=\"tab\" href=\"#tab-notes-changelog\" role=\"tab\">\n                                    <i class=\"fa fa-sticky-note-o\"></i>\n                                    <?= Translation::get('ad_admin_notes') . ' / ' . Translation::get('ad_entry_changelog') ?>\n                                </a>\n                            </li>\n                        </ul>\n                    </div>\n                    <div class=\"card-body\">\n                        <div class=\"tab-content\">\n                            <div class=\"tab-pane active\" id=\"tab-question-answer\">\n                                <!-- Revision -->\n                                <?php\n                                if ($user->perm->hasPermission($currentUserId, 'changebtrevs') && $action === 'editentry') {\n                                    $faqRevision = new Revision($faqConfig);\n                                    $revisions = $faqRevision->get($faqData['id'], $faqData['lang'], $faqData['author']);\n                                    if (count($revisions)) { ?>\n                                        <div class=\"form-group mb-2\">\n                                            <form id=\"selectRevision\" name=\"selectRevision\" method=\"post\"\n                                                  action=\"?action=editentry&amp;id=<?= $faqData['id'] ?>&amp;lang=<?= $faqData['lang'] ?>\">\n                                                <select name=\"revisionid_selected\" onchange=\"this.form.submit();\"\n                                                        class=\"form-select\">\n                                                    <option value=\"<?= $faqData['revision_id'] ?>\">\n                                                        <?= Translation::get('ad_changerev') ?>\n                                                    </option>\n                                                    <?php foreach ($revisions as $revisionData) { ?>\n                                                        <option value=\"<?= $revisionData['revision_id'] ?>\" <?php if ($selectedRevisionId == $revisionData['revision_id']) {\n                                                            echo 'selected';\n                                                                       }\n                                                                        ?>>\n                                                            <?php printf(\n                                                                '%s 1.%d: %s - %s',\n                                                                Translation::get('ad_entry_revision'),\n                                                                $revisionData['revision_id'],\n                                                                Date::createIsoDate($revisionData['updated']),\n                                                                $revisionData['author']\n                                                            );\n                                                            ?>\n                                                        </option>\n                                                        <?php\n                                                    }\n                                                    ?>\n                                                </select>\n                                            </form>\n                                        </div>\n                                    <?php }\n                                    if (\n                                        isset($selectedRevisionId) &&\n                                        isset($faqData['revision_id']) &&\n                                        $selectedRevisionId !== $faqData['revision_id']\n                                    ) {\n                                        $faq->language = $faqData['lang'];\n                                        $faq->getRecord($faqData['id'], $selectedRevisionId, true);\n                                        $faqData = $faq->faqRecord;\n                                        $faqData['tags'] = implode(', ', $tagging->getAllTagsById($faqData['id']));\n                                        $faqData['revision_id'] = $selectedRevisionId;\n                                    }\n                                }\n                                ?>\n\n                              <form id=\"faqEditor\" action=\"?action=<?= $queryString ?>\" method=\"post\"\n                                    data-pmf-enable-editor=\"<?= $faqConfig->get('main.enableWysiwygEditor') ?>\"\n                                    data-pmf-editor-language=\"en\"\n                                    data-pmf-default-url=\"<?= $faqConfig->getDefaultUrl() ?>\">\n                                <input type=\"hidden\" name=\"revision_id\" id=\"revision_id\" value=\"<?= $faqData['revision_id'] ?>\">\n                                <input type=\"hidden\" name=\"record_id\" id=\"record_id\" value=\"<?= $faqData['id'] ?>\">\n                                <input type=\"hidden\" name=\"openQuestionId\" id=\"openQuestionId\" value=\"<?= $questionId ?>\">\n                                  <input type=\"hidden\" name=\"notifyUser\" id=\"notifyUser\"\n                                         value=\"<?= Strings::htmlentities($notifyUser) ?>\">\n                                  <input type=\"hidden\" name=\"notifyEmail\" id=\"notifyEmail\"\n                                         value=\"<?= Strings::htmlentities($notifyEmail) ?>\">\n                                <?= Token::getInstance()->getTokenInput('edit-faq') ?>\n\n\n                                <!-- Question -->\n                                <div class=\"form-group mb-2\">\n                                    <input type=\"text\" name=\"question\" id=\"question\"\n                                           class=\"form-control form-control-lg\"\n                                           placeholder=\"<?= Translation::get('ad_entry_theme') ?>\"\n                                           value=\"<?= $faqData['title'] ?>\">\n                                </div>\n\n                                <!-- Answer -->\n                                <?php if ($faqConfig->get('main.enableWysiwygEditor')): ?>\n                                    <div class=\"row\">\n                                        <div class=\"col-lg-12\">\n                                            <noscript>Please enable JavaScript to use the WYSIWYG editor!</noscript>\n                                            <textarea id=\"editor\" name=\"answer\" class=\"form-control\" rows=\"7\"\n                                                      placeholder=\"<?= Translation::get('ad_entry_content') ?>\"\n                                            ><?= $faqData['content'] ?></textarea>\n                                        </div>\n                                    </div>\n                                <?php endif; ?>\n\n                                <?php if ($faqConfig->get('main.enableMarkdownEditor')) : ?>\n                                    <div class=\"row\">\n                                      <div class=\"col-lg-12\">\n                                        <ul class=\"nav nav-tabs mb-2\" id=\"markdown-tabs\">\n                                          <li class=\"nav-item\">\n                                            <a class=\"nav-link active\" data-bs-toggle=\"tab\" href=\"#text\">Text</a>\n                                          </li>\n                                          <li class=\"nav-item\">\n                                            <a class=\"nav-link\" data-bs-toggle=\"tab\" href=\"#preview\" data-markdown-tab=\"preview\">Preview</a>\n                                          </li>\n                                        </ul>\n                                        <div class=\"tab-content\">\n                                          <div class=\"tab-pane active\" id=\"text\">\n                                            <div class=\"row\">\n                                              <div class=\"col-lg-12\">\n                                                <textarea id=\"answer-markdown\" name=\"answer\" class=\"form-control\"\n                                                          rows=\"7\" placeholder=\"<?= Translation::get('ad_entry_content') ?>\"\n                                                ><?= $faqData['content'] ?></textarea>\n                                              </div>\n                                            </div>\n                                          </div>\n                                          <div class=\"tab-pane\" id=\"preview\">\n                                            <article id=\"markdown-preview\"></article>\n                                          </div>\n                                        </div>\n                                      </div>\n                                    </div>\n                                <?php endif; ?>\n                            </div>\n                            <div class=\"tab-pane\" id=\"tab-meta-data\">\n                                <!-- Categories -->\n                                <div class=\"row mb-2\">\n                                    <label class=\"col-lg-2 col-form-label\" for=\"phpmyfaq-categories\">\n                                        <?= Translation::get('ad_entry_category') ?>\n                                    </label>\n                                    <div class=\"col-lg-10\">\n                                        <select name=\"rubrik[]\" id=\"phpmyfaq-categories\" size=\"5\" multiple\n                                                class=\"form-control\">\n                                            <?= $categoryHelper->renderOptions($categories) ?>\n                                        </select>\n                                    </div>\n                                </div>\n\n                                <!-- Language -->\n                                <div class=\"row mb-2\">\n                                    <label class=\"col-lg-2 col-form-label\" for=\"lang\">\n                                        <?= Translation::get('ad_entry_locale') ?>:\n                                    </label>\n                                    <div class=\"col-lg-10\">\n                                        <?= LanguageHelper::renderSelectLanguage($faqData['lang'], false, [], 'lang') ?>\n                                    </div>\n                                </div>\n\n                                <!-- Attachments -->\n                                <?php if ($user->perm->hasPermission($currentUserId, 'addattachment')) : ?>\n                                    <div class=\"row mb-2\">\n                                        <label class=\"col-lg-2 col-form-label\">\n                                            <?= Translation::get('ad_menu_attachments') ?>:\n                                        </label>\n                                        <div class=\"col-lg-10\">\n                                            <ul class=\"list-unstyled adminAttachments\">\n                                                <?php\n                                                $attList = AttachmentFactory::fetchByRecordId(\n                                                    $faqConfig,\n                                                    $faqData['id']\n                                                );\n                                                foreach ($attList as $att) {\n                                                    printf(\n                                                        '<li><a href=\"../%s\">%s</a> ',\n                                                        $att->buildUrl(),\n                                                        $att->getFilename()\n                                                    );\n                                                    if ($user->perm->hasPermission($currentUserId, 'delattachment')) {\n                                                        printf(\n                                                            '<a class=\"badge bg-danger\" href=\"?action=delatt&amp;record_id=%d&amp;id=%d&amp;lang=%s\"><i aria-hidden=\"true\" class=\"fa fa-trash\"></i></a>',\n                                                            $faqData['id'],\n                                                            $att->getId(),\n                                                            $faqData['lang']\n                                                        );\n                                                    }\n                                                    echo \"</li>\\n\";\n                                                }\n                                                ?>\n                                            </ul>\n                                            <?php\n                                            printf(\n                                                '<button type=\"button\" class=\"btn btn-primary mt-2\" data-bs-toggle=\"modal\" data-bs-target=\"#attachmentModal\">%s</button>',\n                                                Translation::get('ad_att_add')\n                                            );\n                                            ?>\n                                        </div>\n                                    </div>\n                                <?php endif; ?>\n\n                                <!-- Tags -->\n                                <div class=\"row mb-2\">\n                                    <label class=\"col-lg-2 col-form-label\" for=\"tags\">\n                                        <?= Translation::get('ad_entry_tags') ?>:\n                                    </label>\n                                    <div class=\"col-lg-10\">\n                                        <input type=\"text\" name=\"tags\" id=\"tags\" value=\"<?= $faqData['tags'] ?>\"\n                                               autocomplete=\"off\"\n                                               class=\"form-control pmf-tags-autocomplete\">\n                                        <small id=\"tagsHelp\"\n                                               class=\"form-text visually-hidden\"><?= Translation::get('msgShowHelp') ?></small>\n                                    </div>\n                                </div>\n\n                                <!-- Keywords -->\n                                <div class=\"row mb-2\">\n                                    <label class=\"col-lg-2 col-form-label\" for=\"keywords\">\n                                        <?= Translation::get('ad_entry_keywords') ?>:\n                                    </label>\n                                    <div class=\"col-lg-10\">\n                                        <input type=\"text\" name=\"keywords\" id=\"keywords\" maxlength=\"255\"\n                                               class=\"form-control\" autocomplete=\"off\"\n                                               value=\"<?= $faqData['keywords'] ?>\">\n                                        <small id=\"keywordsHelp\"\n                                               class=\"form-text visually-hidden\"><?= Translation::get('msgShowHelp') ?></small>\n                                    </div>\n                                </div>\n\n                                <!-- Author -->\n                                <div class=\"row mb-2\">\n                                    <label class=\"col-lg-2 col-form-label\" for=\"author\">\n                                        <?= Translation::get('ad_entry_author') ?>\n                                    </label>\n                                    <div class=\"col-lg-10\">\n                                        <input type=\"text\" name=\"author\" id=\"author\" value=\"<?= $faqData['author'] ?>\"\n                                               class=\"form-control\">\n                                    </div>\n                                </div>\n\n                                <!-- E-Mail -->\n                                <div class=\"row mb-2\">\n                                    <label class=\"col-lg-2 col-form-label\" for=\"email\">\n                                        <?= Translation::get('ad_entry_email') ?>\n                                    </label>\n                                    <div class=\"col-lg-10\">\n                                        <input type=\"email\" name=\"email\" id=\"email\" value=\"<?= $faqData['email'] ?>\"\n                                               class=\"form-control\">\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div class=\"tab-pane\" id=\"tab-permissions\">\n                                <!-- Permissions -->\n                                <?php if ($faqConfig->get('security.permLevel') !== 'basic') : ?>\n                                    <fieldset class=\"form-group\">\n                                        <div class=\"row\">\n                                            <legend class=\"col-lg-2 col-form-label pt-0\">\n                                              <?= Translation::get('ad_entry_grouppermission') ?>\n                                            </legend>\n                                            <div class=\"col-lg-10\">\n                                              <div class=\"form-check\">\n                                                <input type=\"radio\" id=\"allgroups\" name=\"grouppermission\"\n                                                       value=\"all\" class=\"form-check-input\"\n                                                  <?php echo($allGroups ? 'checked' : ''); ?>>\n                                                <label class=\"form-check-label\" for=\"allgroups\">\n                                                  <?= Translation::get('ad_entry_all_groups') ?>\n                                                </label>\n                                              </div>\n                                              <div class=\"form-check\">\n                                                <input type=\"radio\" id=\"restrictedgroups\" name=\"grouppermission\"\n                                                       class=\"form-check-input\"\n                                                       value=\"restricted\" <?php echo($restrictedGroups ? 'checked' : ''); ?>>\n                                                <label for=\"selected-groups\" class=\"form-check-label\"\n                                                       for=\"restrictedgroups\">\n                                                  <?= Translation::get('ad_entry_restricted_groups') ?>\n                                                </label>\n                                                <select id=\"selected-groups\" name=\"restricted_groups[]\" size=\"3\"\n                                                        class=\"form-control\" multiple>\n                                                    <?= $user->perm->getAllGroupsOptions($groupPermission, $user) ?>\n                                                </select>\n                                              </div>\n                                            </div>\n                                        </div>\n                                    </fieldset>\n                                <?php else : ?>\n                                    <input type=\"hidden\" name=\"grouppermission\" value=\"all\">\n                                <?php endif; ?>\n\n                                <fieldset class=\"form-group\">\n                                    <div class=\"row\">\n                                        <legend class=\"col-lg-2 col-form-label pt-0\">\n                                            <?= Translation::get('ad_entry_userpermission') ?>\n                                        </legend>\n                                        <div class=\"col-lg-10\">\n                                            <div class=\"form-check\">\n                                                <input type=\"radio\" id=\"allusers\" name=\"userpermission\" value=\"all\"\n                                                       class=\"form-check-input\"\n                                                       <?= $allUsers ? 'checked' : '' ?>>\n                                                <label class=\"form-check-label\" for=\"allusers\">\n                                                    <?= Translation::get('ad_entry_all_users') ?>\n                                                </label>\n                                            </div>\n                                            <div class=\"form-check\">\n                                                <input type=\"radio\" id=\"restrictedusers\" name=\"userpermission\"\n                                                       class=\"form-check-input\"\n                                                       value=\"restricted\" <?= $restrictedUsers ? 'checked' : '' ?>>\n                                                <label class=\"form-check-label\" for=\"restrictedusers\">\n                                                    <?= Translation::get('ad_entry_restricted_users') ?>\n                                                </label>\n                                                <select name=\"restricted_users\" id=\"selected-user\" class=\"form-select\">\n                                                    <?= $userHelper->getAllUserOptions($userPermission[0], false) ?>\n                                                </select>\n                                            </div>\n                                        </div>\n                                    </div>\n                                </fieldset>\n\n                            </div>\n\n                            <div class=\"tab-pane\" id=\"tab-notes-changelog\">\n                                <h6 class=\"card-title sr-only\">\n                                    <?= Translation::get('ad_entry_changelog') ?>\n                                </h6>\n                                <div class=\"row mb-2\">\n                                    <label class=\"col-lg-2 col-form-label\" for=\"changelog-date\">\n                                        <?= Translation::get('ad_entry_date') ?>\n                                    </label>\n                                    <div class=\"col-lg-10\">\n                                        <input type=\"text\" readonly class=\"form-control-plaintext\" id=\"changelog-date\"\n                                               value=\"<?= $faqData['date'] ?>\">\n                                    </div>\n                                </div>\n                                <div class=\"row mb-2\">\n                                    <label class=\"col-lg-2 col-form-label\" for=\"changed\">\n                                        <?= Translation::get('ad_entry_changed') ?>\n                                    </label>\n                                    <div class=\"col-lg-10\">\n                                        <textarea name=\"changed\" id=\"changed\" rows=\"3\" class=\"form-control\"\n                                        ><?= $faqData['changed'] ?></textarea>\n                                    </div>\n                                </div>\n\n                                <h6 class=\"card-title\">\n                                    <label for=\"notes\">\n                                        <?php printf(Translation::get('ad_admin_notes_hint'), Translation::get('ad_admin_notes')) ?>\n                                    </label>\n                                </h6>\n                                <div class=\"row mb-2\">\n                                    <div class=\"col-lg-10 offset-lg-2\">\n                                        <textarea id=\"notes\" name=\"notes\" class=\"form-control\" rows=\"3\"\n                                        ><?= $faqData['notes'] ?? '' ?></textarea>\n                                    </div>\n                                </div>\n\n                                <div class=\"row mb-2\">\n                                    <div class=\"col-lg-2\">\n                                        <h6 class=\"card-title\">\n                                            <?= Translation::get('ad_entry_changelog_history') ?>\n                                        </h6>\n                                    </div>\n                                    <div class=\"col-lg-10\">\n                                        <ul>\n                                            <?php foreach ($changelog->getByFaqId($faqData['id']) as $entry) {\n                                                $entryUser = new User($faqConfig);\n                                                $entryUser->getUserById($entry['user']);\n                                                ?>\n                                                <li class=\"small pt-0\">\n                                                    <?php printf(\n                                                        '<i class=\"fa fa-hand-o-right\"></i> %s  1.%d <i class=\"fa fa-calendar\"></i> %s <i class=\"fa fa-user\"></i> %s',\n                                                        Translation::get('ad_entry_revision'),\n                                                        $entry['revision_id'],\n                                                        $date->format(date('Y-m-d H:i', $entry['date'])),\n                                                        $entryUser->getUserData('display_name')\n                                                    );\n                                                    ?>\n                                                    <br>\n                                                    <?= Strings::htmlentities($entry['changelog'] ?? '') ?>\n                                                </li>\n                                            <?php } ?>\n                                        </ul>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <!-- Sidebar -->\n            <div class=\"col-lg-3\">\n                <div id=\"accordion\" role=\"tablist\">\n                    <div class=\"card mb-4\">\n                        <div class=\"card-header text-center\" role=\"tab\" id=\"pmf-heading-date\">\n                            <?php if ($selectedRevisionId === $faqData['revision_id']) : ?>\n                                <button class=\"btn btn-lg btn-info\" type=\"reset\">\n                                    <?= Translation::get('ad_gen_reset') ?>\n                                </button>\n\n                                <button class=\"btn btn-lg btn-primary\" type=\"submit\">\n                                    <?= Translation::get('ad_entry_save') ?>\n                                </button>\n\n                            <?php endif ?>\n\n                        </div>\n                        <div class=\"card-body\">\n                            <h5 class=\"mb-0\">\n                                <?= Translation::get('ad_entry_date') ?>\n                            </h5>\n                            <div class=\"form-group\">\n                                <div class=\"form-check\">\n                                    <input type=\"radio\" id=\"updateDate\" checked name=\"recordDateHandling\"\n                                           class=\"form-check-input\"\n                                           onchange=\"setRecordDate(this.id);\">\n                                    <label class=\"form-check-label\" for=\"updateDate\">\n                                        <?= Translation::get('msgUpdateFaqDate') ?>\n                                    </label>\n                                </div>\n                                <div class=\"form-check\">\n                                    <input type=\"radio\" id=\"keepDate\" name=\"recordDateHandling\" class=\"form-check-input\"\n                                           onchange=\"setRecordDate(this.id);\">\n                                    <label class=\"form-check-label\" for=\"keepDate\">\n                                        <?= Translation::get('msgKeepFaqDate') ?>\n                                    </label>\n                                </div>\n                                <div class=\"form-check\">\n                                    <input type=\"radio\" id=\"manualDate\" name=\"recordDateHandling\"\n                                           class=\"form-check-input\"\n                                           onchange=\"setRecordDate(this.id);\">\n                                    <label class=\"form-check-label\" for=\"manualDate\">\n                                        <?= Translation::get('msgEditFaqDat') ?>\n                                    </label>\n                                </div>\n                                <div id=\"recordDateInputContainer\" class=\"invisible mb-2\">\n                                    <input type=\"datetime-local\" name=\"date\" id=\"date\" class=\"form-control\"\n                                           placeholder=\"<?= $faqData['date'] ?>\">\n                                </div>\n                            </div>\n                            <h5 class=\"mb-0\">\n                                <?= Translation::get('ad_entry_status') ?>\n                            </h5>\n                            <div class=\"form-group\">\n                                <!-- active or not -->\n                                <?php if ($user->perm->hasPermission($currentUserId, 'approverec')) :\n                                    if (isset($faqData['active']) && $faqData['active'] === 'yes') {\n                                        $isActive = ' checked';\n                                        $isInActive = null;\n                                    } else {\n                                        $isActive = null;\n                                        $isInActive = ' checked';\n                                    }\n\n                                    // Override value, if FAQs activated by default\n                                    if ($faqConfig->get('records.defaultActivation') && $queryString === 'insertentry') {\n                                        $isActive = ' checked';\n                                        $isInActive = null;\n                                    }\n                                    ?>\n                                    <div class=\"form-check\">\n                                        <input type=\"radio\" id=\"active\" name=\"active\" value=\"yes\"\n                                               class=\"form-check-input\"\n                                            <?php if (isset($isActive)) {\n                                                echo $isActive;\n                                            } ?>>\n                                        <label class=\"form-check-label\" for=\"active\">\n                                            <?= Translation::get('ad_entry_visibility') ?>\n                                        </label>\n                                    </div>\n                                    <div class=\"form-check\">\n                                        <input type=\"radio\" id=\"inactive\" name=\"active\" value=\"no\"\n                                               class=\"form-check-input\"\n                                            <?php if (isset($isInActive)) {\n                                                echo $isInActive;\n                                            } ?>>\n                                        <label class=\"form-check-label\" for=\"inactive\">\n                                          <?= Translation::get('ad_entry_not_visibility') ?>\n                                        </label>\n                                    </div>\n                                <?php else : ?>\n                                    <div class=\"form-check\">\n                                        <input type=\"radio\" id=\"inactive\" name=\"active\" value=\"no\"\n                                               class=\"form-check-input\" checked>\n                                        <label class=\"form-check-label\" for=\"inactive\">\n                                            <?= Translation::get('ad_entry_not_visibility') ?>\n                                        </label>\n                                    </div>\n                                <?php endif; ?>\n                            </div>\n\n                            <?php if ($queryString != 'insertentry' && !$faqConfig->get('records.enableAutoRevisions')) : ?>\n                              <h5 class=\"mb-0\">\n                                  <?= Translation::get('ad_entry_new_revision') ?>\n                              </h5>\n                              <div class=\"form-group\">\n                                <div class=\"form-check\">\n                                  <input type=\"radio\" name=\"revision\" id=\"revision\" value=\"yes\"\n                                         class=\"form-check-input\">\n                                  <label class=\"form-check-label\"\n                                         for=\"revision\"><?= Translation::get('ad_gen_yes') ?></label>\n                                </div>\n                                <div class=\"form-check\">\n                                  <input type=\"radio\" name=\"revision\" id=\"no-revision\" value=\"no\"\n                                         checked class=\"form-check-input\">\n                                  <label class=\"form-check-label\"\n                                         for=\"no-revision\"><?= Translation::get('ad_gen_no') ?></label>\n                                </div>\n                              </div>\n                            <?php endif ?>\n\n                            <div class=\"form-group\">\n                                <!-- sticky or not -->\n                                <div class=\"form-check\">\n                                    <input type=\"checkbox\" id=\"sticky\" name=\"sticky\" class=\"form-check-input\"\n                                        <?php echo(isset($faqData['sticky']) && $faqData['sticky'] ? 'checked' : '') ?>>\n                                    <label class=\"form-check-label\"\n                                           for=\"sticky\"><?= Translation::get('ad_entry_sticky') ?></label>\n                                </div>\n\n                                <!-- comments allowed or not -->\n                                <div class=\"form-check\">\n                                    <input type=\"checkbox\" name=\"comment\" id=\"comment\" value=\"y\"\n                                           class=\"form-check-input\"\n                                           <?= $faqData['comment'] ?>>\n                                    <label class=\"form-check-label\"\n                                           for=\"comment\"><?= Translation::get('ad_entry_allowComments') ?></label>\n                                </div>\n                            </div>\n\n                            <div class=\"form-group\">\n                                <!-- solution id -->\n                                <label class=\"col-form-label\" for=\"solution_id\">\n                                    <?= Translation::get('ad_entry_solution_id') ?>:\n                                </label>\n                                <input type=\"number\" name=\"solution_id\" id=\"solution_id\" size=\"5\" class=\"form-control\"\n                                       readonly\n                                       value=\"<?= $faqData['solution_id'] ?? $faq->getNextSolutionId() ?>\">\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n\n    </form>\n\n    <!-- Attachment Upload Dialog -->\n    <?php\n    if (0 === $faqData['id']) {\n        $faqData['id'] = $faqConfig->getDb()->nextId(\n            Database::getTablePrefix() . 'faqdata',\n            'id'\n        );\n    }\n    ?>\n  <div class=\"modal fade\" id=\"attachmentModal\" tabindex=\"-1\" role=\"dialog\" aria-labelledby=\"attachmentModalLabel\"\n       aria-hidden=\"true\">\n    <div class=\"modal-dialog\" role=\"document\">\n      <div class=\"modal-content\">\n        <div class=\"modal-header\">\n          <h5 class=\"modal-title\" id=\"attachmentModalLabel\">\n              <?= Translation::get('ad_att_addto') . ' ' . Translation::get('ad_att_addto_2') ?>\n            (max <?= Utils::formatBytes($faqConfig->get('records.maxAttachmentSize')) ?>)\n          </h5>\n            <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\" aria-label=\"Close\"></button>\n        </div>\n        <div class=\"modal-body\">\n          <form action=\"api/attachment.php?action=upload\" enctype=\"multipart/form-data\" method=\"post\"\n                id=\"attachmentForm\" novalidate>\n            <fieldset>\n              <input type=\"hidden\" name=\"MAX_FILE_SIZE\" value=\"<?= $faqConfig->get('records.maxAttachmentSize') ?>\">\n              <input type=\"hidden\" name=\"record_id\" id=\"attachment_record_id\" value=\"<?= $faqData['id'] ?>\">\n              <input type=\"hidden\" name=\"record_lang\" id=\"attachment_record_lang\" value=\"<?= $faqData['lang'] ?>\">\n              <input type=\"hidden\" name=\"save\" value=\"true\">\n              <?= Token::getInstance()->getTokenInput('upload-attachment') ?>\n\n              <div class=\"mb-2\">\n                <label class=\"form-label\" for=\"filesToUpload\">\n                  <?= Translation::get('ad_att_att') ?>\n                </label>\n                <input type=\"file\" class=\"form-control\" name=\"filesToUpload[]\" id=\"filesToUpload\" multiple>\n                <div class=\"invalid-feedback\">\n                  The file is too big.\n                </div>\n              </div>\n\n              <div class=\"pmf-attachment-upload-files invisible mb-2\">\n                <?= Translation::get('msgAttachmentsFilesize') ?>:\n                <output id=\"filesize\"></output>\n              </div>\n            </fieldset>\n          </form>\n        </div>\n        <div class=\"modal-footer\">\n          <button type=\"button\" class=\"btn btn-primary\" id=\"pmf-attachment-modal-upload\">\n              <?= Translation::get('ad_att_butt') ?>\n          </button>\n        </div>\n      </div>\n    </div>\n  </div>\n\n    <script>\n      function setRecordDate(how) {\n        if ('updateDate' === how) {\n          document.getElementById('date').value = '';\n        } else if ('keepDate' === how) {\n          document.getElementById('date').value = '<?= $faqData['isoDate'] ?>';\n        } else if ('manualDate' === how) {\n          document.getElementById('recordDateInputContainer').classList.remove('invisible');\n          document.getElementById('date').value = '';\n        }\n      }\n    </script>\n    <?php\n} elseif ($user->perm->hasPermission($currentUserId, 'edit_faq') && !Database::checkOnEmptyTable('faqcategories')) {\n    echo Translation::get('err_NotAuth');\n} elseif ($user->perm->hasPermission($currentUserId, 'edit_faq') && Database::checkOnEmptyTable('faqcategories')) {\n    echo Translation::get('no_cats');\n}\n", "<?php\n\n/**\n * Attachment helper class for phpMyFAQ.\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at https://mozilla.org/MPL/2.0/.\n *\n * @package   phpMyFAQ\\Helper\n * @author    Thorsten Rinne <thorsten@phpmyfaq.de>\n * @copyright 2019-2023 phpMyFAQ Team\n * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n * @link      https://www.phpmyfaq.de\n * @since     2019-12-30\n */\n\nnamespace phpMyFAQ\\Helper;\n\nuse phpMyFAQ\\Attachment\\AttachmentAbstract;\nuse phpMyFAQ\\Translation;\n\n/**\n * Class AttachmentHelper\n * @package phpMyFAQ\\Helper\n */\nclass AttachmentHelper\n{\n    /**\n     * Returns an HTML list of attached files.\n     *\n     * @param AttachmentAbstract[] $attachmentList\n     * @return string\n     */\n    public function renderAttachmentList(array $attachmentList): string\n    {\n        if (count($attachmentList) === 0) {\n            return '';\n        }\n\n        $html = sprintf('<p>%s:</p><ul>', Translation::get('msgAttachedFiles'));\n\n        foreach ($attachmentList as $attachment) {\n            $html .= sprintf(\n                '<li><i class=\"fa fa-%s\" aria-hidden=\"true\"></i> <a href=\"%s\">%s</a></li>',\n                $this->mapMimeTypeToIcon($attachment->getMimeType()),\n                $attachment->buildUrl(),\n                $attachment->getFilename()\n            );\n        }\n\n        return $html . '</ul>';\n    }\n\n    private function mapMimeTypeToIcon(string $mimeType): string\n    {\n        return match ($mimeType) {\n            'application/zip' => 'file-archive-o',\n            'audio/basic', 'audio/midi', 'audio/mpeg', 'audio/x-aiff', 'audio/x-mpegurl', 'audio/x-pn-realaudio',\n            'audio/x-pn-realaudio-plugin', 'audio/x-realaudio', 'audio/x-wav' => 'file-audio-o',\n            'application/xhtml+xml', 'text/xml' => 'file-code-o',\n            'application/vnd.ms-excel',\n            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' => 'file-excel-o',\n            'image/bmp', 'image/gif', 'image/ief', 'image/jpeg', 'image/png', 'image/tiff', 'image/vnd.djvu',\n            'image/vnd.wap.wbmp', 'image/x-cmu-raster', 'image/x-portable-anymap', 'image/x-portable-bitmap',\n            'image/x-portable-graymap', 'image/x-portable-pixmap', 'image/x-rgb', 'image/x-xbitmap', 'image/x-xpixmap',\n            'image/x-xwindowdump' => 'file-image-o',\n            'application/vnd.ms-powerpoint',\n            'application/vnd.openxmlformats-officedocument.presentationml.presentation' => 'file-powerpoint-o',\n            'application/pdf' => 'file-pdf-o',\n            'text/plain', 'text/richtext', 'text/rtf' => 'file-text-o',\n            'application/msword',\n            'application/vnd.openxmlformats-officedocument.wordprocessingml.document' => 'file-word-o',\n            'video/mpeg', 'video/quicktime', 'video/vnd.mpegurl', 'video/x-msvideo',\n            'video/x-sgi-movie' => 'file-video-o',\n            default => 'file-o',\n        };\n    }\n}\n"], "fixing_code": ["<?php\n\n/**\n * The FAQ record editor.\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at https://mozilla.org/MPL/2.0/.\n *\n * @package   phpMyFAQ\n * @author    Thorsten Rinne <thorsten@phpmyfaq.de>\n * @copyright 2003-2023 phpMyFAQ Team\n * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n * @link      https://www.phpmyfaq.de\n * @since     2003-02-23\n */\n\nuse phpMyFAQ\\Attachment\\AttachmentFactory;\nuse phpMyFAQ\\Category;\nuse phpMyFAQ\\Category\\CategoryRelation;\nuse phpMyFAQ\\Changelog;\nuse phpMyFAQ\\Configuration;\nuse phpMyFAQ\\Database;\nuse phpMyFAQ\\Date;\nuse phpMyFAQ\\Faq;\nuse phpMyFAQ\\Faq\\FaqPermission;\nuse phpMyFAQ\\Filter;\nuse phpMyFAQ\\Helper\\CategoryHelper;\nuse phpMyFAQ\\Helper\\LanguageHelper;\nuse phpMyFAQ\\Helper\\UserHelper;\nuse phpMyFAQ\\Link;\nuse phpMyFAQ\\AdminLog;\nuse phpMyFAQ\\Question;\nuse phpMyFAQ\\Revision;\nuse phpMyFAQ\\Session\\Token;\nuse phpMyFAQ\\Strings;\nuse phpMyFAQ\\Tags;\nuse phpMyFAQ\\Translation;\nuse phpMyFAQ\\User;\nuse phpMyFAQ\\User\\CurrentUser;\nuse phpMyFAQ\\Utils;\n\nif (!defined('IS_VALID_PHPMYFAQ')) {\n    http_response_code(400);\n    exit();\n}\n\n$faqConfig = Configuration::getConfigurationInstance();\n$currentUserId = CurrentUser::getCurrentUser($faqConfig)->getUserId();\n\nif (\n    ($user->perm->hasPermission($currentUserId, 'edit_faq') ||\n     $user->perm->hasPermission($currentUserId, 'add_faq')) && !Database::checkOnEmptyTable('faqcategories')\n) {\n    $category = new Category($faqConfig, [], false);\n\n    if ($faqConfig->get('main.enableCategoryRestrictions')) {\n        $category = new Category($faqConfig, $currentAdminGroups, true);\n    }\n\n    $category->setUser($currentAdminUser);\n    $category->setGroups($currentAdminGroups);\n    $category->buildCategoryTree();\n\n    $categoryRelation = new CategoryRelation($faqConfig, $category);\n\n    $categoryHelper = new CategoryHelper();\n    $categoryHelper->setCategory($category);\n\n    $faq = new Faq($faqConfig);\n\n    $faqPermission = new FaqPermission($faqConfig);\n\n    $questionObject = new Question($faqConfig);\n\n    $changelog = new Changelog($faqConfig);\n\n    $userHelper = new UserHelper($user);\n\n    $selectedCategory = '';\n    $categories = [];\n    $faqData = [\n        'id' => 0,\n        'lang' => $faqLangCode,\n        'revision_id' => 0,\n        'title' => '',\n        'dateStart' => '',\n        'dateEnd' => '',\n    ];\n\n    $tagging = new Tags($faqConfig);\n    $date = new Date($faqConfig);\n\n    if ('takequestion' === $action) {\n        $questionId = Filter::filterInput(INPUT_GET, 'id', FILTER_VALIDATE_INT);\n        $question = $questionObject->getQuestion($questionId);\n        $selectedCategory = $question['category_id'];\n        $faqData['title'] = $question['question'];\n        $notifyUser = $question['username'];\n        $notifyEmail = $question['email'];\n        $categories = [\n            'category_id' => $selectedCategory,\n            'category_lang' => $faqData['lang'],\n        ];\n    } else {\n        $questionId = 0;\n        $notifyUser = '';\n        $notifyEmail = '';\n    }\n\n    if ('editpreview' === $action) {\n        $faqData['id'] = Filter::filterInput(INPUT_POST, 'id', FILTER_VALIDATE_INT);\n        if (!is_null($faqData['id'])) {\n            $queryString = 'saveentry&id=' . $faqData['id'];\n        } else {\n            $queryString = 'insertentry';\n        }\n\n        $faqData['lang'] = Filter::filterInput(INPUT_POST, 'lang', FILTER_SANITIZE_SPECIAL_CHARS);\n        $selectedCategory = Filter::filterInputArray(\n            INPUT_POST,\n            [\n                'rubrik' => [\n                    'filter' => FILTER_VALIDATE_INT,\n                    'flags' => FILTER_REQUIRE_ARRAY,\n                ],\n            ]\n        );\n        if (is_array($selectedCategory)) {\n            foreach ($selectedCategory as $cats) {\n                $categories[] = ['category_id' => $cats, 'category_lang' => $faqData['lang']];\n            }\n        }\n        $faqData['active'] = Filter::filterInput(INPUT_POST, 'active', FILTER_SANITIZE_SPECIAL_CHARS);\n        $faqData['keywords'] = Filter::filterInput(INPUT_POST, 'keywords', FILTER_SANITIZE_SPECIAL_CHARS);\n        $faqData['title'] = Filter::filterInput(INPUT_POST, 'thema', FILTER_SANITIZE_SPECIAL_CHARS);\n        $faqData['content'] = Filter::filterInput(INPUT_POST, 'content', FILTER_SANITIZE_SPECIAL_CHARS);\n        $faqData['author'] = Filter::filterInput(INPUT_POST, 'author', FILTER_SANITIZE_SPECIAL_CHARS);\n        $faqData['email'] = Filter::filterInput(INPUT_POST, 'email', FILTER_VALIDATE_EMAIL);\n        $faqData['comment'] = Filter::filterInput(INPUT_POST, 'comment', FILTER_SANITIZE_SPECIAL_CHARS);\n        $faqData['solution_id'] = Filter::filterInput(INPUT_POST, 'solution_id', FILTER_VALIDATE_INT);\n        $faqData['revision_id'] = Filter::filterInput(INPUT_POST, 'revision_id', FILTER_VALIDATE_INT, 0);\n        $faqData['sticky'] = Filter::filterInput(INPUT_POST, 'sticky', FILTER_VALIDATE_INT);\n        $faqData['tags'] = Filter::filterInput(INPUT_POST, 'tags', FILTER_SANITIZE_SPECIAL_CHARS);\n        $faqData['changed'] = Filter::filterInput(INPUT_POST, 'changed', FILTER_SANITIZE_SPECIAL_CHARS);\n        $faqData['dateStart'] = Filter::filterInput(INPUT_POST, 'dateStart', FILTER_SANITIZE_SPECIAL_CHARS);\n        $faqData['dateEnd'] = Filter::filterInput(INPUT_POST, 'dateEnd', FILTER_SANITIZE_SPECIAL_CHARS);\n        $faqData['content'] = html_entity_decode((string) $faqData['content']);\n    } elseif ('editentry' === $action) {\n        $id = Filter::filterInput(INPUT_GET, 'id', FILTER_VALIDATE_INT);\n        $lang = Filter::filterInput(INPUT_GET, 'lang', FILTER_SANITIZE_SPECIAL_CHARS);\n        $translateTo = Filter::filterInput(INPUT_GET, 'translateTo', FILTER_SANITIZE_SPECIAL_CHARS);\n        $categoryId = Filter::filterInput(INPUT_GET, 'cat', FILTER_VALIDATE_INT);\n\n        if (!is_null($translateTo)) {\n            $faqData['lang'] = $lang = $translateTo;\n            $selectedCategory = $categoryId;\n        }\n\n        if ((!isset($selectedCategory) && !isset($faqData['title'])) || !is_null($id)) {\n            $logging = new AdminLog($faqConfig);\n            $logging->log($user, 'admin-edit-faq ' . $id);\n\n            $categories = $categoryRelation->getCategories($id, $lang);\n            if (count($categories) === 0) {\n                $categories = [\n                    'category_id' => $selectedCategory,\n                    'category_lang' => $faqData['lang'],\n                ];\n            }\n\n            $faq->getRecord($id, null, true);\n            $faqData = $faq->faqRecord;\n            if (!is_null($translateTo)) {\n                $faqData['lang'] = $translateTo; // once again\n            }\n            $faqData['tags'] = implode(', ', $tagging->getAllTagsById($faqData['id']));\n\n            $queryString = 'saveentry&amp;id=' . $faqData['id'];\n        } else {\n            $queryString = 'insertentry';\n            if (isset($categoryId)) {\n                $categories = ['category_id' => $categoryId, 'category_lang' => $lang];\n            }\n        }\n    } elseif ('copyentry' === $action) {\n        $faqData['id'] = Filter::filterInput(INPUT_GET, 'id', FILTER_VALIDATE_INT);\n        $faqData['lang'] = Filter::filterInput(INPUT_GET, 'lang', FILTER_SANITIZE_SPECIAL_CHARS);\n        $categories = $categoryRelation->getCategories($faqData['id'], $faqData['lang']);\n\n        $faq->getRecord($faqData['id'], null, true);\n\n        $faqData = $faq->faqRecord;\n        $faqData['tags'] = implode(', ', $tagging->getAllTagsById($faqData['id']));\n        $queryString = 'insertentry';\n    } else {\n        $logging = new AdminLog($faqConfig);\n        $logging->log($user, 'admin-add-faq');\n        $queryString = 'insertentry';\n        if (!is_array($categories)) {\n            $categories = [];\n        }\n    }\n\n    // Revisions\n    $selectedRevisionId = Filter::filterInput(INPUT_POST, 'revisionid_selected', FILTER_VALIDATE_INT);\n    if (is_null($selectedRevisionId)) {\n        $selectedRevisionId = $faqData['revision_id'];\n    }\n\n    // User permissions\n    $userPermission = $faqPermission->get(FaqPermission::USER, $faqData['id']);\n    if (count($userPermission) == 0 || $userPermission[0] == -1) {\n        $allUsers = true;\n        $restrictedUsers = false;\n        $userPermission[0] = -1;\n    } else {\n        $allUsers = false;\n        $restrictedUsers = true;\n    }\n\n    // Group permissions\n    $groupPermission = $faqPermission->get(FaqPermission::GROUP, $faqData['id']);\n    if (count($groupPermission) == 0 || $groupPermission[0] == -1) {\n        $allGroups = true;\n        $restrictedGroups = false;\n        $groupPermission[0] = -1;\n    } else {\n        $allGroups = false;\n        $restrictedGroups = true;\n    }\n\n    // Set data for forms\n    $faqData['title'] = (isset($faqData['title']) ? Strings::htmlentities($faqData['title'], ENT_HTML5 | ENT_COMPAT) : '');\n    $faqData['content'] =\n        (isset($faqData['content']) ? trim(Strings::htmlentities($faqData['content'], ENT_COMPAT, 'utf-8', true)) : '');\n    $faqData['tags'] = (isset($faqData['tags']) ? Strings::htmlentities($faqData['tags']) : '');\n    $faqData['keywords'] = (isset($faqData['keywords']) ? Strings::htmlentities($faqData['keywords']) : '');\n    $faqData['author'] = (isset($faqData['author']) ? Strings::htmlentities(\n        $faqData['author']\n    ) : $user->getUserData('display_name'));\n    $faqData['email'] = (isset($faqData['email']) ? Strings::htmlentities($faqData['email']) : $user->getUserData(\n        'email'\n    ));\n    $faqData['isoDate'] = ($faqData['date'] ?? date('Y-m-d H:i'));\n    $faqData['date'] = (isset($faqData['date']) ? $date->format($faqData['date']) : $date->format(date('Y-m-d H:i')));\n    $faqData['changed'] ??= '';\n\n    if (isset($faqData['comment']) && $faqData['comment'] == 'y') {\n        $faqData['comment'] = ' checked';\n    } elseif ($faqConfig->get('records.defaultAllowComments')) {\n        $faqData['comment'] = ' checked';\n    } else {\n        $faqData['comment'] = '';\n    }\n\n    // Header\n    if (0 !== $faqData['id'] && 'copyentry' !== $action) {\n        $currentRevision = sprintf('%s 1.%d', Translation::get('ad_entry_revision'), $selectedRevisionId);\n\n        $faqUrl = sprintf(\n            '%sindex.php?action=faq&cat=%s&id=%d&artlang=%s',\n            $faqConfig->getDefaultUrl(),\n            $category->getCategoryIdFromFaq($faqData['id']),\n            $faqData['id'],\n            $faqData['lang']\n        );\n\n        $link = new Link($faqUrl, $faqConfig);\n        $link->itemTitle = $faqData['title'];\n\n        ?>\n        <div class=\"d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom\">\n            <h1 class=\"h2\">\n                <i aria-hidden=\"true\" class=\"fa fa-edit\"></i>\n                <?= Translation::get('ad_entry_edit_1') ?>\n                <?= Translation::get('ad_entry_edit_2') ?>\n            </h1>\n            <div class=\"btn-toolbar mb-2 mb-md-0\">\n                <div class=\"btn-group mr-2\">\n              <span class=\"btn btn-sm btn-info\">\n                <i class=\"fa fa-hashtag\" aria-hidden=\"true\"></i>\n                <?= $currentRevision ?>\n              </span>\n                    <a href=\"<?= $link->toString() ?>\" class=\"btn btn-sm btn-success\">\n                        <i class=\"fa fa-arrow-alt-circle-right\" aria-hidden=\"true\"></i>\n                        <?= Translation::get('ad_view_faq') ?>\n                    </a>\n                </div>\n            </div>\n        </div>\n\n    <?php } else { ?>\n        <div class=\"d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom\">\n            <h1 class=\"h2\">\n                <i aria-hidden=\"true\" class=\"fa fa-edit\"></i>\n                <?= Translation::get('ad_entry_add') ?>\n            </h1>\n        </div>\n\n    <?php } ?>\n\n        <div class=\"row\">\n            <div class=\"col-lg-9\">\n                <div class=\"card mb-4\">\n                    <div class=\"card-header\">\n                        <ul class=\"nav nav-tabs card-header-tabs\" id=\"nav-tab\" role=\"tablist\">\n                            <li class=\"nav-item\">\n                                <a class=\"nav-link active\" data-bs-toggle=\"tab\" href=\"#tab-question-answer\" role=\"tab\">\n                                    <i class=\"fa fa-pencil-square-o\"></i> <?= Translation::get('ad_record_faq') ?>\n                                </a>\n                            </li>\n                            <li class=\"nav-item\">\n                                <a class=\"nav-link\" data-bs-toggle=\"tab\" href=\"#tab-meta-data\" role=\"tab\">\n                                    <i class=\"fa fa-database\"></i> <?= Translation::get('ad_menu_faq_meta') ?>\n                                </a>\n                            </li>\n                            <li class=\"nav-item\">\n                                <a class=\"nav-link\" data-bs-toggle=\"tab\" href=\"#tab-permissions\" role=\"tab\">\n                                    <i class=\"fa fa-unlock-alt\"></i> <?= Translation::get('ad_record_permissions') ?>\n                                </a>\n                            </li>\n                            <li class=\"nav-item\">\n                                <a class=\"nav-link\" data-bs-toggle=\"tab\" href=\"#tab-notes-changelog\" role=\"tab\">\n                                    <i class=\"fa fa-sticky-note-o\"></i>\n                                    <?= Translation::get('ad_admin_notes') . ' / ' . Translation::get('ad_entry_changelog') ?>\n                                </a>\n                            </li>\n                        </ul>\n                    </div>\n                    <div class=\"card-body\">\n                        <div class=\"tab-content\">\n                            <div class=\"tab-pane active\" id=\"tab-question-answer\">\n                                <!-- Revision -->\n                                <?php\n                                if ($user->perm->hasPermission($currentUserId, 'changebtrevs') && $action === 'editentry') {\n                                    $faqRevision = new Revision($faqConfig);\n                                    $revisions = $faqRevision->get($faqData['id'], $faqData['lang'], $faqData['author']);\n                                    if (count($revisions)) { ?>\n                                        <div class=\"form-group mb-2\">\n                                            <form id=\"selectRevision\" name=\"selectRevision\" method=\"post\"\n                                                  action=\"?action=editentry&amp;id=<?= $faqData['id'] ?>&amp;lang=<?= $faqData['lang'] ?>\">\n                                                <select name=\"revisionid_selected\" onchange=\"this.form.submit();\"\n                                                        class=\"form-select\">\n                                                    <option value=\"<?= $faqData['revision_id'] ?>\">\n                                                        <?= Translation::get('ad_changerev') ?>\n                                                    </option>\n                                                    <?php foreach ($revisions as $revisionData) { ?>\n                                                        <option value=\"<?= $revisionData['revision_id'] ?>\" <?php if ($selectedRevisionId == $revisionData['revision_id']) {\n                                                            echo 'selected';\n                                                                       }\n                                                                        ?>>\n                                                            <?php printf(\n                                                                '%s 1.%d: %s - %s',\n                                                                Translation::get('ad_entry_revision'),\n                                                                $revisionData['revision_id'],\n                                                                Date::createIsoDate($revisionData['updated']),\n                                                                $revisionData['author']\n                                                            );\n                                                            ?>\n                                                        </option>\n                                                        <?php\n                                                    }\n                                                    ?>\n                                                </select>\n                                            </form>\n                                        </div>\n                                    <?php }\n                                    if (\n                                        isset($selectedRevisionId) &&\n                                        isset($faqData['revision_id']) &&\n                                        $selectedRevisionId !== $faqData['revision_id']\n                                    ) {\n                                        $faq->language = $faqData['lang'];\n                                        $faq->getRecord($faqData['id'], $selectedRevisionId, true);\n                                        $faqData = $faq->faqRecord;\n                                        $faqData['tags'] = implode(', ', $tagging->getAllTagsById($faqData['id']));\n                                        $faqData['revision_id'] = $selectedRevisionId;\n                                    }\n                                }\n                                ?>\n\n                              <form id=\"faqEditor\" action=\"?action=<?= $queryString ?>\" method=\"post\"\n                                    data-pmf-enable-editor=\"<?= $faqConfig->get('main.enableWysiwygEditor') ?>\"\n                                    data-pmf-editor-language=\"en\"\n                                    data-pmf-default-url=\"<?= $faqConfig->getDefaultUrl() ?>\">\n                                <input type=\"hidden\" name=\"revision_id\" id=\"revision_id\" value=\"<?= $faqData['revision_id'] ?>\">\n                                <input type=\"hidden\" name=\"record_id\" id=\"record_id\" value=\"<?= $faqData['id'] ?>\">\n                                <input type=\"hidden\" name=\"openQuestionId\" id=\"openQuestionId\" value=\"<?= $questionId ?>\">\n                                  <input type=\"hidden\" name=\"notifyUser\" id=\"notifyUser\"\n                                         value=\"<?= Strings::htmlentities($notifyUser) ?>\">\n                                  <input type=\"hidden\" name=\"notifyEmail\" id=\"notifyEmail\"\n                                         value=\"<?= Strings::htmlentities($notifyEmail) ?>\">\n                                <?= Token::getInstance()->getTokenInput('edit-faq') ?>\n\n\n                                <!-- Question -->\n                                <div class=\"form-group mb-2\">\n                                    <input type=\"text\" name=\"question\" id=\"question\"\n                                           class=\"form-control form-control-lg\"\n                                           placeholder=\"<?= Translation::get('ad_entry_theme') ?>\"\n                                           value=\"<?= $faqData['title'] ?>\">\n                                </div>\n\n                                <!-- Answer -->\n                                <?php if ($faqConfig->get('main.enableWysiwygEditor')): ?>\n                                    <div class=\"row\">\n                                        <div class=\"col-lg-12\">\n                                            <noscript>Please enable JavaScript to use the WYSIWYG editor!</noscript>\n                                            <textarea id=\"editor\" name=\"answer\" class=\"form-control\" rows=\"7\"\n                                                      placeholder=\"<?= Translation::get('ad_entry_content') ?>\"\n                                            ><?= $faqData['content'] ?></textarea>\n                                        </div>\n                                    </div>\n                                <?php endif; ?>\n\n                                <?php if ($faqConfig->get('main.enableMarkdownEditor')) : ?>\n                                    <div class=\"row\">\n                                      <div class=\"col-lg-12\">\n                                        <ul class=\"nav nav-tabs mb-2\" id=\"markdown-tabs\">\n                                          <li class=\"nav-item\">\n                                            <a class=\"nav-link active\" data-bs-toggle=\"tab\" href=\"#text\">Text</a>\n                                          </li>\n                                          <li class=\"nav-item\">\n                                            <a class=\"nav-link\" data-bs-toggle=\"tab\" href=\"#preview\" data-markdown-tab=\"preview\">Preview</a>\n                                          </li>\n                                        </ul>\n                                        <div class=\"tab-content\">\n                                          <div class=\"tab-pane active\" id=\"text\">\n                                            <div class=\"row\">\n                                              <div class=\"col-lg-12\">\n                                                <textarea id=\"answer-markdown\" name=\"answer\" class=\"form-control\"\n                                                          rows=\"7\" placeholder=\"<?= Translation::get('ad_entry_content') ?>\"\n                                                ><?= $faqData['content'] ?></textarea>\n                                              </div>\n                                            </div>\n                                          </div>\n                                          <div class=\"tab-pane\" id=\"preview\">\n                                            <article id=\"markdown-preview\"></article>\n                                          </div>\n                                        </div>\n                                      </div>\n                                    </div>\n                                <?php endif; ?>\n                            </div>\n                            <div class=\"tab-pane\" id=\"tab-meta-data\">\n                                <!-- Categories -->\n                                <div class=\"row mb-2\">\n                                    <label class=\"col-lg-2 col-form-label\" for=\"phpmyfaq-categories\">\n                                        <?= Translation::get('ad_entry_category') ?>\n                                    </label>\n                                    <div class=\"col-lg-10\">\n                                        <select name=\"rubrik[]\" id=\"phpmyfaq-categories\" size=\"5\" multiple\n                                                class=\"form-control\">\n                                            <?= $categoryHelper->renderOptions($categories) ?>\n                                        </select>\n                                    </div>\n                                </div>\n\n                                <!-- Language -->\n                                <div class=\"row mb-2\">\n                                    <label class=\"col-lg-2 col-form-label\" for=\"lang\">\n                                        <?= Translation::get('ad_entry_locale') ?>:\n                                    </label>\n                                    <div class=\"col-lg-10\">\n                                        <?= LanguageHelper::renderSelectLanguage($faqData['lang'], false, [], 'lang') ?>\n                                    </div>\n                                </div>\n\n                                <!-- Attachments -->\n                                <?php if ($user->perm->hasPermission($currentUserId, 'addattachment')) : ?>\n                                    <div class=\"row mb-2\">\n                                        <label class=\"col-lg-2 col-form-label\">\n                                            <?= Translation::get('ad_menu_attachments') ?>:\n                                        </label>\n                                        <div class=\"col-lg-10\">\n                                            <ul class=\"list-unstyled adminAttachments\">\n                                                <?php\n                                                $attList = AttachmentFactory::fetchByRecordId(\n                                                    $faqConfig,\n                                                    $faqData['id']\n                                                );\n                                                foreach ($attList as $att) {\n                                                    printf(\n                                                        '<li><a href=\"../%s\">%s</a> ',\n                                                        $att->buildUrl(),\n                                                        Strings::htmlentities($att->getFilename())\n                                                    );\n                                                    if ($user->perm->hasPermission($currentUserId, 'delattachment')) {\n                                                        printf(\n                                                            '<a class=\"badge bg-danger\" href=\"?action=delatt&amp;record_id=%d&amp;id=%d&amp;lang=%s\"><i aria-hidden=\"true\" class=\"fa fa-trash\"></i></a>',\n                                                            $faqData['id'],\n                                                            $att->getId(),\n                                                            $faqData['lang']\n                                                        );\n                                                    }\n                                                    echo \"</li>\\n\";\n                                                }\n                                                ?>\n                                            </ul>\n                                            <?php\n                                            printf(\n                                                '<button type=\"button\" class=\"btn btn-primary mt-2\" data-bs-toggle=\"modal\" data-bs-target=\"#attachmentModal\">%s</button>',\n                                                Translation::get('ad_att_add')\n                                            );\n                                            ?>\n                                        </div>\n                                    </div>\n                                <?php endif; ?>\n\n                                <!-- Tags -->\n                                <div class=\"row mb-2\">\n                                    <label class=\"col-lg-2 col-form-label\" for=\"tags\">\n                                        <?= Translation::get('ad_entry_tags') ?>:\n                                    </label>\n                                    <div class=\"col-lg-10\">\n                                        <input type=\"text\" name=\"tags\" id=\"tags\" value=\"<?= $faqData['tags'] ?>\"\n                                               autocomplete=\"off\"\n                                               class=\"form-control pmf-tags-autocomplete\">\n                                        <small id=\"tagsHelp\"\n                                               class=\"form-text visually-hidden\"><?= Translation::get('msgShowHelp') ?></small>\n                                    </div>\n                                </div>\n\n                                <!-- Keywords -->\n                                <div class=\"row mb-2\">\n                                    <label class=\"col-lg-2 col-form-label\" for=\"keywords\">\n                                        <?= Translation::get('ad_entry_keywords') ?>:\n                                    </label>\n                                    <div class=\"col-lg-10\">\n                                        <input type=\"text\" name=\"keywords\" id=\"keywords\" maxlength=\"255\"\n                                               class=\"form-control\" autocomplete=\"off\"\n                                               value=\"<?= $faqData['keywords'] ?>\">\n                                        <small id=\"keywordsHelp\"\n                                               class=\"form-text visually-hidden\"><?= Translation::get('msgShowHelp') ?></small>\n                                    </div>\n                                </div>\n\n                                <!-- Author -->\n                                <div class=\"row mb-2\">\n                                    <label class=\"col-lg-2 col-form-label\" for=\"author\">\n                                        <?= Translation::get('ad_entry_author') ?>\n                                    </label>\n                                    <div class=\"col-lg-10\">\n                                        <input type=\"text\" name=\"author\" id=\"author\" value=\"<?= $faqData['author'] ?>\"\n                                               class=\"form-control\">\n                                    </div>\n                                </div>\n\n                                <!-- E-Mail -->\n                                <div class=\"row mb-2\">\n                                    <label class=\"col-lg-2 col-form-label\" for=\"email\">\n                                        <?= Translation::get('ad_entry_email') ?>\n                                    </label>\n                                    <div class=\"col-lg-10\">\n                                        <input type=\"email\" name=\"email\" id=\"email\" value=\"<?= $faqData['email'] ?>\"\n                                               class=\"form-control\">\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div class=\"tab-pane\" id=\"tab-permissions\">\n                                <!-- Permissions -->\n                                <?php if ($faqConfig->get('security.permLevel') !== 'basic') : ?>\n                                    <fieldset class=\"form-group\">\n                                        <div class=\"row\">\n                                            <legend class=\"col-lg-2 col-form-label pt-0\">\n                                              <?= Translation::get('ad_entry_grouppermission') ?>\n                                            </legend>\n                                            <div class=\"col-lg-10\">\n                                              <div class=\"form-check\">\n                                                <input type=\"radio\" id=\"allgroups\" name=\"grouppermission\"\n                                                       value=\"all\" class=\"form-check-input\"\n                                                  <?php echo($allGroups ? 'checked' : ''); ?>>\n                                                <label class=\"form-check-label\" for=\"allgroups\">\n                                                  <?= Translation::get('ad_entry_all_groups') ?>\n                                                </label>\n                                              </div>\n                                              <div class=\"form-check\">\n                                                <input type=\"radio\" id=\"restrictedgroups\" name=\"grouppermission\"\n                                                       class=\"form-check-input\"\n                                                       value=\"restricted\" <?php echo($restrictedGroups ? 'checked' : ''); ?>>\n                                                <label for=\"selected-groups\" class=\"form-check-label\"\n                                                       for=\"restrictedgroups\">\n                                                  <?= Translation::get('ad_entry_restricted_groups') ?>\n                                                </label>\n                                                <select id=\"selected-groups\" name=\"restricted_groups[]\" size=\"3\"\n                                                        class=\"form-control\" multiple>\n                                                    <?= $user->perm->getAllGroupsOptions($groupPermission, $user) ?>\n                                                </select>\n                                              </div>\n                                            </div>\n                                        </div>\n                                    </fieldset>\n                                <?php else : ?>\n                                    <input type=\"hidden\" name=\"grouppermission\" value=\"all\">\n                                <?php endif; ?>\n\n                                <fieldset class=\"form-group\">\n                                    <div class=\"row\">\n                                        <legend class=\"col-lg-2 col-form-label pt-0\">\n                                            <?= Translation::get('ad_entry_userpermission') ?>\n                                        </legend>\n                                        <div class=\"col-lg-10\">\n                                            <div class=\"form-check\">\n                                                <input type=\"radio\" id=\"allusers\" name=\"userpermission\" value=\"all\"\n                                                       class=\"form-check-input\"\n                                                       <?= $allUsers ? 'checked' : '' ?>>\n                                                <label class=\"form-check-label\" for=\"allusers\">\n                                                    <?= Translation::get('ad_entry_all_users') ?>\n                                                </label>\n                                            </div>\n                                            <div class=\"form-check\">\n                                                <input type=\"radio\" id=\"restrictedusers\" name=\"userpermission\"\n                                                       class=\"form-check-input\"\n                                                       value=\"restricted\" <?= $restrictedUsers ? 'checked' : '' ?>>\n                                                <label class=\"form-check-label\" for=\"restrictedusers\">\n                                                    <?= Translation::get('ad_entry_restricted_users') ?>\n                                                </label>\n                                                <select name=\"restricted_users\" id=\"selected-user\" class=\"form-select\">\n                                                    <?= $userHelper->getAllUserOptions($userPermission[0], false) ?>\n                                                </select>\n                                            </div>\n                                        </div>\n                                    </div>\n                                </fieldset>\n\n                            </div>\n\n                            <div class=\"tab-pane\" id=\"tab-notes-changelog\">\n                                <h6 class=\"card-title sr-only\">\n                                    <?= Translation::get('ad_entry_changelog') ?>\n                                </h6>\n                                <div class=\"row mb-2\">\n                                    <label class=\"col-lg-2 col-form-label\" for=\"changelog-date\">\n                                        <?= Translation::get('ad_entry_date') ?>\n                                    </label>\n                                    <div class=\"col-lg-10\">\n                                        <input type=\"text\" readonly class=\"form-control-plaintext\" id=\"changelog-date\"\n                                               value=\"<?= $faqData['date'] ?>\">\n                                    </div>\n                                </div>\n                                <div class=\"row mb-2\">\n                                    <label class=\"col-lg-2 col-form-label\" for=\"changed\">\n                                        <?= Translation::get('ad_entry_changed') ?>\n                                    </label>\n                                    <div class=\"col-lg-10\">\n                                        <textarea name=\"changed\" id=\"changed\" rows=\"3\" class=\"form-control\"\n                                        ><?= $faqData['changed'] ?></textarea>\n                                    </div>\n                                </div>\n\n                                <h6 class=\"card-title\">\n                                    <label for=\"notes\">\n                                        <?php printf(Translation::get('ad_admin_notes_hint'), Translation::get('ad_admin_notes')) ?>\n                                    </label>\n                                </h6>\n                                <div class=\"row mb-2\">\n                                    <div class=\"col-lg-10 offset-lg-2\">\n                                        <textarea id=\"notes\" name=\"notes\" class=\"form-control\" rows=\"3\"\n                                        ><?= $faqData['notes'] ?? '' ?></textarea>\n                                    </div>\n                                </div>\n\n                                <div class=\"row mb-2\">\n                                    <div class=\"col-lg-2\">\n                                        <h6 class=\"card-title\">\n                                            <?= Translation::get('ad_entry_changelog_history') ?>\n                                        </h6>\n                                    </div>\n                                    <div class=\"col-lg-10\">\n                                        <ul>\n                                            <?php foreach ($changelog->getByFaqId($faqData['id']) as $entry) {\n                                                $entryUser = new User($faqConfig);\n                                                $entryUser->getUserById($entry['user']);\n                                                ?>\n                                                <li class=\"small pt-0\">\n                                                    <?php printf(\n                                                        '<i class=\"fa fa-hand-o-right\"></i> %s  1.%d <i class=\"fa fa-calendar\"></i> %s <i class=\"fa fa-user\"></i> %s',\n                                                        Translation::get('ad_entry_revision'),\n                                                        $entry['revision_id'],\n                                                        $date->format(date('Y-m-d H:i', $entry['date'])),\n                                                        $entryUser->getUserData('display_name')\n                                                    );\n                                                    ?>\n                                                    <br>\n                                                    <?= Strings::htmlentities($entry['changelog'] ?? '') ?>\n                                                </li>\n                                            <?php } ?>\n                                        </ul>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <!-- Sidebar -->\n            <div class=\"col-lg-3\">\n                <div id=\"accordion\" role=\"tablist\">\n                    <div class=\"card mb-4\">\n                        <div class=\"card-header text-center\" role=\"tab\" id=\"pmf-heading-date\">\n                            <?php if ($selectedRevisionId === $faqData['revision_id']) : ?>\n                                <button class=\"btn btn-lg btn-info\" type=\"reset\">\n                                    <?= Translation::get('ad_gen_reset') ?>\n                                </button>\n\n                                <button class=\"btn btn-lg btn-primary\" type=\"submit\">\n                                    <?= Translation::get('ad_entry_save') ?>\n                                </button>\n\n                            <?php endif ?>\n\n                        </div>\n                        <div class=\"card-body\">\n                            <h5 class=\"mb-0\">\n                                <?= Translation::get('ad_entry_date') ?>\n                            </h5>\n                            <div class=\"form-group\">\n                                <div class=\"form-check\">\n                                    <input type=\"radio\" id=\"updateDate\" checked name=\"recordDateHandling\"\n                                           class=\"form-check-input\"\n                                           onchange=\"setRecordDate(this.id);\">\n                                    <label class=\"form-check-label\" for=\"updateDate\">\n                                        <?= Translation::get('msgUpdateFaqDate') ?>\n                                    </label>\n                                </div>\n                                <div class=\"form-check\">\n                                    <input type=\"radio\" id=\"keepDate\" name=\"recordDateHandling\" class=\"form-check-input\"\n                                           onchange=\"setRecordDate(this.id);\">\n                                    <label class=\"form-check-label\" for=\"keepDate\">\n                                        <?= Translation::get('msgKeepFaqDate') ?>\n                                    </label>\n                                </div>\n                                <div class=\"form-check\">\n                                    <input type=\"radio\" id=\"manualDate\" name=\"recordDateHandling\"\n                                           class=\"form-check-input\"\n                                           onchange=\"setRecordDate(this.id);\">\n                                    <label class=\"form-check-label\" for=\"manualDate\">\n                                        <?= Translation::get('msgEditFaqDat') ?>\n                                    </label>\n                                </div>\n                                <div id=\"recordDateInputContainer\" class=\"invisible mb-2\">\n                                    <input type=\"datetime-local\" name=\"date\" id=\"date\" class=\"form-control\"\n                                           placeholder=\"<?= $faqData['date'] ?>\">\n                                </div>\n                            </div>\n                            <h5 class=\"mb-0\">\n                                <?= Translation::get('ad_entry_status') ?>\n                            </h5>\n                            <div class=\"form-group\">\n                                <!-- active or not -->\n                                <?php if ($user->perm->hasPermission($currentUserId, 'approverec')) :\n                                    if (isset($faqData['active']) && $faqData['active'] === 'yes') {\n                                        $isActive = ' checked';\n                                        $isInActive = null;\n                                    } else {\n                                        $isActive = null;\n                                        $isInActive = ' checked';\n                                    }\n\n                                    // Override value, if FAQs activated by default\n                                    if ($faqConfig->get('records.defaultActivation') && $queryString === 'insertentry') {\n                                        $isActive = ' checked';\n                                        $isInActive = null;\n                                    }\n                                    ?>\n                                    <div class=\"form-check\">\n                                        <input type=\"radio\" id=\"active\" name=\"active\" value=\"yes\"\n                                               class=\"form-check-input\"\n                                            <?php if (isset($isActive)) {\n                                                echo $isActive;\n                                            } ?>>\n                                        <label class=\"form-check-label\" for=\"active\">\n                                            <?= Translation::get('ad_entry_visibility') ?>\n                                        </label>\n                                    </div>\n                                    <div class=\"form-check\">\n                                        <input type=\"radio\" id=\"inactive\" name=\"active\" value=\"no\"\n                                               class=\"form-check-input\"\n                                            <?php if (isset($isInActive)) {\n                                                echo $isInActive;\n                                            } ?>>\n                                        <label class=\"form-check-label\" for=\"inactive\">\n                                          <?= Translation::get('ad_entry_not_visibility') ?>\n                                        </label>\n                                    </div>\n                                <?php else : ?>\n                                    <div class=\"form-check\">\n                                        <input type=\"radio\" id=\"inactive\" name=\"active\" value=\"no\"\n                                               class=\"form-check-input\" checked>\n                                        <label class=\"form-check-label\" for=\"inactive\">\n                                            <?= Translation::get('ad_entry_not_visibility') ?>\n                                        </label>\n                                    </div>\n                                <?php endif; ?>\n                            </div>\n\n                            <?php if ($queryString != 'insertentry' && !$faqConfig->get('records.enableAutoRevisions')) : ?>\n                              <h5 class=\"mb-0\">\n                                  <?= Translation::get('ad_entry_new_revision') ?>\n                              </h5>\n                              <div class=\"form-group\">\n                                <div class=\"form-check\">\n                                  <input type=\"radio\" name=\"revision\" id=\"revision\" value=\"yes\"\n                                         class=\"form-check-input\">\n                                  <label class=\"form-check-label\"\n                                         for=\"revision\"><?= Translation::get('ad_gen_yes') ?></label>\n                                </div>\n                                <div class=\"form-check\">\n                                  <input type=\"radio\" name=\"revision\" id=\"no-revision\" value=\"no\"\n                                         checked class=\"form-check-input\">\n                                  <label class=\"form-check-label\"\n                                         for=\"no-revision\"><?= Translation::get('ad_gen_no') ?></label>\n                                </div>\n                              </div>\n                            <?php endif ?>\n\n                            <div class=\"form-group\">\n                                <!-- sticky or not -->\n                                <div class=\"form-check\">\n                                    <input type=\"checkbox\" id=\"sticky\" name=\"sticky\" class=\"form-check-input\"\n                                        <?php echo(isset($faqData['sticky']) && $faqData['sticky'] ? 'checked' : '') ?>>\n                                    <label class=\"form-check-label\"\n                                           for=\"sticky\"><?= Translation::get('ad_entry_sticky') ?></label>\n                                </div>\n\n                                <!-- comments allowed or not -->\n                                <div class=\"form-check\">\n                                    <input type=\"checkbox\" name=\"comment\" id=\"comment\" value=\"y\"\n                                           class=\"form-check-input\"\n                                           <?= $faqData['comment'] ?>>\n                                    <label class=\"form-check-label\"\n                                           for=\"comment\"><?= Translation::get('ad_entry_allowComments') ?></label>\n                                </div>\n                            </div>\n\n                            <div class=\"form-group\">\n                                <!-- solution id -->\n                                <label class=\"col-form-label\" for=\"solution_id\">\n                                    <?= Translation::get('ad_entry_solution_id') ?>:\n                                </label>\n                                <input type=\"number\" name=\"solution_id\" id=\"solution_id\" size=\"5\" class=\"form-control\"\n                                       readonly\n                                       value=\"<?= $faqData['solution_id'] ?? $faq->getNextSolutionId() ?>\">\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n\n    </form>\n\n    <!-- Attachment Upload Dialog -->\n    <?php\n    if (0 === $faqData['id']) {\n        $faqData['id'] = $faqConfig->getDb()->nextId(\n            Database::getTablePrefix() . 'faqdata',\n            'id'\n        );\n    }\n    ?>\n  <div class=\"modal fade\" id=\"attachmentModal\" tabindex=\"-1\" role=\"dialog\" aria-labelledby=\"attachmentModalLabel\"\n       aria-hidden=\"true\">\n    <div class=\"modal-dialog\" role=\"document\">\n      <div class=\"modal-content\">\n        <div class=\"modal-header\">\n          <h5 class=\"modal-title\" id=\"attachmentModalLabel\">\n              <?= Translation::get('ad_att_addto') . ' ' . Translation::get('ad_att_addto_2') ?>\n            (max <?= Utils::formatBytes($faqConfig->get('records.maxAttachmentSize')) ?>)\n          </h5>\n            <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\" aria-label=\"Close\"></button>\n        </div>\n        <div class=\"modal-body\">\n          <form action=\"api/attachment.php?action=upload\" enctype=\"multipart/form-data\" method=\"post\"\n                id=\"attachmentForm\" novalidate>\n            <fieldset>\n              <input type=\"hidden\" name=\"MAX_FILE_SIZE\" value=\"<?= $faqConfig->get('records.maxAttachmentSize') ?>\">\n              <input type=\"hidden\" name=\"record_id\" id=\"attachment_record_id\" value=\"<?= $faqData['id'] ?>\">\n              <input type=\"hidden\" name=\"record_lang\" id=\"attachment_record_lang\" value=\"<?= $faqData['lang'] ?>\">\n              <input type=\"hidden\" name=\"save\" value=\"true\">\n              <?= Token::getInstance()->getTokenInput('upload-attachment') ?>\n\n              <div class=\"mb-2\">\n                <label class=\"form-label\" for=\"filesToUpload\">\n                  <?= Translation::get('ad_att_att') ?>\n                </label>\n                <input type=\"file\" class=\"form-control\" name=\"filesToUpload[]\" id=\"filesToUpload\" multiple>\n                <div class=\"invalid-feedback\">\n                  The file is too big.\n                </div>\n              </div>\n\n              <div class=\"pmf-attachment-upload-files invisible mb-2\">\n                <?= Translation::get('msgAttachmentsFilesize') ?>:\n                <output id=\"filesize\"></output>\n              </div>\n            </fieldset>\n          </form>\n        </div>\n        <div class=\"modal-footer\">\n          <button type=\"button\" class=\"btn btn-primary\" id=\"pmf-attachment-modal-upload\">\n              <?= Translation::get('ad_att_butt') ?>\n          </button>\n        </div>\n      </div>\n    </div>\n  </div>\n\n    <script>\n      function setRecordDate(how) {\n        if ('updateDate' === how) {\n          document.getElementById('date').value = '';\n        } else if ('keepDate' === how) {\n          document.getElementById('date').value = '<?= $faqData['isoDate'] ?>';\n        } else if ('manualDate' === how) {\n          document.getElementById('recordDateInputContainer').classList.remove('invisible');\n          document.getElementById('date').value = '';\n        }\n      }\n    </script>\n    <?php\n} elseif ($user->perm->hasPermission($currentUserId, 'edit_faq') && !Database::checkOnEmptyTable('faqcategories')) {\n    echo Translation::get('err_NotAuth');\n} elseif ($user->perm->hasPermission($currentUserId, 'edit_faq') && Database::checkOnEmptyTable('faqcategories')) {\n    echo Translation::get('no_cats');\n}\n", "<?php\n\n/**\n * Attachment helper class for phpMyFAQ.\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at https://mozilla.org/MPL/2.0/.\n *\n * @package   phpMyFAQ\\Helper\n * @author    Thorsten Rinne <thorsten@phpmyfaq.de>\n * @copyright 2019-2023 phpMyFAQ Team\n * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n * @link      https://www.phpmyfaq.de\n * @since     2019-12-30\n */\n\nnamespace phpMyFAQ\\Helper;\n\nuse phpMyFAQ\\Attachment\\AttachmentAbstract;\nuse phpMyFAQ\\Strings;\nuse phpMyFAQ\\Translation;\n\n/**\n * Class AttachmentHelper\n * @package phpMyFAQ\\Helper\n */\nclass AttachmentHelper\n{\n    /**\n     * Returns an HTML list of attached files.\n     *\n     * @param AttachmentAbstract[] $attachmentList\n     * @return string\n     */\n    public function renderAttachmentList(array $attachmentList): string\n    {\n        if (count($attachmentList) === 0) {\n            return '';\n        }\n\n        $html = sprintf('<p>%s:</p><ul>', Translation::get('msgAttachedFiles'));\n\n        foreach ($attachmentList as $attachment) {\n            $html .= sprintf(\n                '<li><i class=\"fa fa-%s\" aria-hidden=\"true\"></i> <a href=\"%s\">%s</a></li>',\n                $this->mapMimeTypeToIcon($attachment->getMimeType()),\n                $attachment->buildUrl(),\n                Strings::htmlentities($attachment->getFilename())\n            );\n        }\n\n        return $html . '</ul>';\n    }\n\n    private function mapMimeTypeToIcon(string $mimeType): string\n    {\n        return match ($mimeType) {\n            'application/zip' => 'file-archive-o',\n            'audio/basic', 'audio/midi', 'audio/mpeg', 'audio/x-aiff', 'audio/x-mpegurl', 'audio/x-pn-realaudio',\n            'audio/x-pn-realaudio-plugin', 'audio/x-realaudio', 'audio/x-wav' => 'file-audio-o',\n            'application/xhtml+xml', 'text/xml' => 'file-code-o',\n            'application/vnd.ms-excel',\n            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' => 'file-excel-o',\n            'image/bmp', 'image/gif', 'image/ief', 'image/jpeg', 'image/png', 'image/tiff', 'image/vnd.djvu',\n            'image/vnd.wap.wbmp', 'image/x-cmu-raster', 'image/x-portable-anymap', 'image/x-portable-bitmap',\n            'image/x-portable-graymap', 'image/x-portable-pixmap', 'image/x-rgb', 'image/x-xbitmap', 'image/x-xpixmap',\n            'image/x-xwindowdump' => 'file-image-o',\n            'application/vnd.ms-powerpoint',\n            'application/vnd.openxmlformats-officedocument.presentationml.presentation' => 'file-powerpoint-o',\n            'application/pdf' => 'file-pdf-o',\n            'text/plain', 'text/richtext', 'text/rtf' => 'file-text-o',\n            'application/msword',\n            'application/vnd.openxmlformats-officedocument.wordprocessingml.document' => 'file-word-o',\n            'video/mpeg', 'video/quicktime', 'video/vnd.mpegurl', 'video/x-msvideo',\n            'video/x-sgi-movie' => 'file-video-o',\n            default => 'file-o',\n        };\n    }\n}\n"], "filenames": ["phpmyfaq/admin/record.edit.php", "phpmyfaq/src/phpMyFAQ/Helper/AttachmentHelper.php"], "buggy_code_start_loc": [487, 20], "buggy_code_end_loc": [488, 49], "fixing_code_start_loc": [487, 21], "fixing_code_end_loc": [488, 50], "type": "CWE-79", "message": "Cross-site Scripting (XSS) - Stored in GitHub repository thorsten/phpmyfaq prior to 3.2.2.", "other": {"cve": {"id": "CVE-2023-5867", "sourceIdentifier": "security@huntr.dev", "published": "2023-10-31T01:15:08.020", "lastModified": "2023-11-08T02:09:51.573", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Cross-site Scripting (XSS) - Stored in GitHub repository thorsten/phpmyfaq prior to 3.2.2."}, {"lang": "es", "value": "Cross-site Scripting (XSS): almacenadas en el repositorio de GitHub thorsten/phpmyfaq antes de 3.2.2."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 5.4, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.3, "impactScore": 2.7}], "cvssMetricV30": [{"source": "security@huntr.dev", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:L/UI:R/S:U/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "UNCHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 4.6, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.1, "impactScore": 2.5}]}, "weaknesses": [{"source": "security@huntr.dev", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:phpmyfaq:phpmyfaq:*:*:*:*:*:*:*:*", "versionEndExcluding": "3.2.2", "matchCriteriaId": "ABD3B984-C15B-43BF-ADE8-2AF970E88C8C"}]}]}], "references": [{"url": "https://github.com/thorsten/phpmyfaq/commit/5310cb8c37dc3a5c5aead0898690b14705c433d3", "source": "security@huntr.dev", "tags": ["Patch"]}, {"url": "https://huntr.com/bounties/5c09b32e-a041-4a1e-a277-eb3e80967df0", "source": "security@huntr.dev", "tags": ["Exploit", "Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/thorsten/phpmyfaq/commit/5310cb8c37dc3a5c5aead0898690b14705c433d3"}}