{"buggy_code": ["<?php\n    if($U->userHasPermission(\"Backend\", \"User\",\"Search\")){\n?>\n    <!DOCTYPE html>\n    <html lang=\"<?php echo $U->getSetting(\"site.lang\"); ?>\" dir=\"ltr\">\n        <head>\n            <style>\n                tbody > tr > th {\n                    font-weight: normal;\n                }\n            </style>\n            <meta charset=\"utf-8\">\n            <title><?php echo $U->getLang(\"admin\") ?> - <?php echo $U->getLang(\"admin.user.search\"); ?></title>\n        </head>\n        <body>\n            <a href=\"javascript:window.close()\"><?php echo $U->getLang(\"admin.exit\"); ?></a>\n            <p><?php echo $U->getLang(\"admin.user.search.intro\"); ?></p>\n            <form>\n                <label for=\"Name\"><?php echo $U->getLang(\"admin.user.field.username\"); ?>:</label><br />\n                <input type=\"text\" name=\"Name\" /><br />\n                <label for=\"Mail\"><?php echo $U->getLang(\"admin.user.field.mail\"); ?>:</label><br />\n                <input type=\"mail\" name=\"Mail\" /><br />\n                <input type=\"hidden\" name=\"URL\" value=\"usersearch\" />\n                <input type=\"submit\" value=\"<?php echo $U->getLang(\"admin.user.search.action\"); ?>\" />\n            </form>\n            <?php\n                if(isset($_GET[\"Name\"])){\n                    if($_GET[\"Name\"] !== \"\"){\n                        $sql = \"SELECT * FROM User WHERE Username='\".mysqli::real_escape_string($_GET[\"Name\"]).\"';\";\n                        $dbRes = mysqli_query($U->db_link, $sql);\n                    }\n                }\n                if(isset($_GET[\"Mail\"])){\n                    if($_GET[\"Mail\"] !== \"\"){\n                        $sql = \"SELECT * FROM User WHERE Mail='\".mysqli::real_escape_string($_GET[\"Mail\"]).\"';\";\n                        $dbRes = mysqli_query($U->db_link, $sql);\n                    }\n                }\n                if(isset($_GET[\"Id\"])){\n                    if($_GET[\"Id\"] !== \"\"){\n                        $sql = \"SELECT * FROM User WHERE Id='\".mysqli::real_escape_string($_GET[\"Id\"]).\"';\";\n                        $dbRes = mysqli_query($U->db_link, $sql);\n                    }\n                }\n                if(isset($_GET[\"Mail\"]) || isset($_GET[\"Name\"]) || isset($_GET[\"Id\"])){\n                    $userhere = False;\n                    while($row = mysqli_fetch_array($dbRes, MYSQLI_ASSOC)){\n                        $userhere = True;\n            ?>\n                        <h4><?php echo str_replace(\"%a\",$row[\"Username\"],$U->getLang(\"admin.user.search.title\")); ?></h4>\n                        <table>\n                            <tbody>\n                                <tr>\n                                    <th>\n                                        Id:\n                                    </th>\n                                    <th>\n                                        <?php echo $row[\"Id\"]; ?>\n                                    </th>\n                                </tr>\n                                <tr>\n                                    <th>\n                                        <?php echo $U->getLang(\"admin.user.field.mail\"); ?>:\n                                    </th>\n                                    <th>\n                                        <?php echo $row[\"Mail\"]; ?>\n                                    </th>\n                                </tr>\n                                <tr>\n                                    <th>\n                                        <?php echo $U->getLang(\"admin.user.field.permissionlevel\"); ?>\n                                    </th>\n                                    <th>\n                                        <?php echo $U->getPermissionName($row[\"Type\"]); ?>\n                                    </th>\n                                </tr>\n                                <tr>\n                                    <th>\n                                        <?php echo $U->getLang(\"admin.user.field.blocked\"); ?>\n                                    </th>\n                                    <th>\n                                        <?php echo $row[\"blocked\"]==0?$U->getLang(\"admin.no\"):$U->getLang(\"admin.yes\"); ?>\n                                    </th>\n                                </tr>\n                            </tbody>\n                        </table>\n            <?php\n                    }\n                    if(!$userhere&&isset($_GET[\"Mail\"])&&$_GET[\"Mail\"]!==\"\"){\n                        echo str_replace(\"%a\", $U->getLang(\"admin.user.field.mail\"), str_replace(\"%b\", $_GET[\"Mail\"], $U->getLang(\"admin.user.notFound.property\")));\n                    }\n                    if(!$userhere&&isset($_GET[\"Name\"])&&$_GET[\"Name\"]!==\"\"){\n                        echo str_replace(\"%a\", $U->getLang(\"admin.user.field.username\"), str_replace(\"%b\", $_GET[\"Name\"], $U->getLang(\"admin.user.notFound.property\")));\n                    }\n                    if(!$userhere&&isset($_GET[\"Id\"])){\n                        echo str_replace(\"%a\", $U->getLang(\"admin.user.field.id\"), str_replace(\"%b\", $_GET[\"Id\"], $U->getLang(\"admin.user.notFound.property\")));\n                    }\n                }\n            ?>\n        </body>\n    </html>\n<?php\n  }else{\n?>\n  <!DOCTYPE html>\n  <html lang=\"<?php echo $U->getSetting(\"site.lang\"); ?>\" dir=\"ltr\">\n    <head>\n      <meta charset=\"utf-8\">\n      <title><?php echo $U->getLang(\"admin\") ?> - <?php echo $U->getLang(\"admin.settings\"); ?></title>\n    </head>\n    <body>\n        <a href=\"javascript:window.close()\"><?php echo $U->getLang(\"admin.exit\"); ?></a>\n      <p><?php echo $U->getLang(\"rights.error\"); ?></p>\n    </body>\n  </html>\n<?php\n  }\n?>\n"], "fixing_code": ["<?php\n  if($U->userHasPermission(\"Backend\", \"User\")){\n?>\n  <!DOCTYPE html>\n  <html lang=\"<?php echo $U->getSetting(\"site.lang\"); ?>\" dir=\"ltr\">\n    <head>\n      <meta charset=\"utf-8\">\n      <title><?php echo $U->getLang(\"admin\") ?> - <?php echo $U->getLang(\"admin.user.edit\"); ?></title>\n    </head>\n    <body>\n      <a href=\"<?php echo $_SERVER['PHP_SELF']; ?>?URL=mainpage\"><?php echo $U->getLang(\"admin.back\"); ?></a>\n      <?php\n        if(isset($_POST[\"N\"])&& !isset($_POST[\"Submit\"])){\n          $sql = \"SELECT * FROM user WHERE id='\".mysqli::real_escape_string($_POST[\"N\"]).\"';\";\n          $dbRes = mysqli_query($U->db_link, $sql);\n          $userhere = False;\n          while($row = mysqli_fetch_array($dbRes, MYSQLI_ASSOC)){\n            $user_Type = $row[\"Type\"];\n            $user_Blocked = $row[\"blocked\"];\n            $userhere = True;\n          }\n          if($userhere){\n            if($_SESSION[\"User_ID\"] !== md5($_POST[\"N\"])){\n    ?>\n              <form action=\"<?php echo $_SERVER['PHP_SELF']; ?>?URL=useredit\" method=\"post\">\n                <?php\n                  if($U->userHasPermission(\"Backend\", \"User\",\"Permission\")){\n                ?>\n                  <label for=\"A\"><?php echo $U->getLang(\"admin.user.permissionLevel\"); ?></label>\n                  <select name=\"A\" type=\"checkbox\" value=\"<?php echo $user_Type; ?>\">\n                    <?php\n                      // Creates a select list with all permission levels\n                      foreach($U->getPermissionName(-1) as $key => $value){\n                        echo \"<option name='\".$key.\"'\".($key==$user_Type?\" selected\":\"\").\">\".$value.\"</option>\";\n                      }\n                    ?>\n                  </select>\n                  <br />\n                <?php\n                  }\n                  if($U->userHasPermission(\"Backend\", \"User\",\"Block\")){\n                ?>\n                    <label for=\"G\"><?php echo $U->getLang(\"admin.user.block\"); ?></label>\n                    <input name=\"G\" type=\"checkbox\" <?php echo $user_Blocked==\"1\"?\"checked\":\"\"; ?> /><br />\n                <?php\n                  }\n                  if($U->userHasPermission(\"Backend\", \"User\",\"Permission\")||$U->userHasPermission(\"Backend\", \"User\",\"Block\")){\n                ?>\n                    <input type=\"submit\" name=\"Submit\"/>\n                    <input type='hidden' name='N' value='<?php echo $_POST[\"N\"]; ?>' />\n                <?php\n                  }\n                ?>\n              </form>\n              <?php\n                if($U->userHasPermission(\"Backend\", \"User\",\"Search\")){\n              ?>\n                <!-- Link to user search page (Opens in a pop-up) --> \n                <a href=\"javascript:window.open('index.php?URL=usersearch&Id=<?php echo $_POST[\"N\"]; ?>', 'Search user', 'width=500,height=500,status=no,titlebar=no,location=no,toolbar=no,left=300');\"><?php echo $U->getLang(\"admin.user.moreInformation\"); ?></a>\n              <?php\n                }\n              ?>\n    <?php            \n            }else{\n              echo \"<br />\".$U->getLang(\"admin.user.yourself\");\n            }\n          }else{\n            echo \"<br />\".str_replace(\"%a\", $_POST[\"N\"], $U->getLang(\"admin.user.notFound\"));\n          }\n        }elseif(isset($_POST[\"Submit\"])){\n          if(isset($_POST[\"A\"])&&$U->userHasPermission(\"Backend\", \"User\",\"Permission\")){\n            $permissionLevel = $_POST[\"A\"];\n          }elseif(!$U->userHasPermission(\"Backend\", \"User\",\"Permission\")){\n            $permissionLevel = false;\n          }\n          if(isset($_POST[\"G\"])&&$U->userHasPermission(\"Backend\", \"User\",\"Block\")){\n            $b = 1;\n          }elseif($U->userHasPermission(\"Backend\", \"User\",\"Block\")){\n            $b = 0;\n          }else{\n            $b = false;\n          }\n          if($_SESSION[\"User_ID\"] !== md5($_POST[\"N\"])){\n            $sql = \"UPDATE User \".($permissionLevel === false?\"\":\"SET Type='\".$permissionLevel.\"'\".($b==false?\"\":\", \")).($b==false?\"\":\"blocked ='\".$b.\"' \").\"WHERE Id='\".mysqli::real_escape_string($_POST[\"N\"]).\"';\";\n            $dbRes = mysqli_query($U->db_link, $sql);\n            echo \"<br />\".$U->getLang(\"admin.user.changed\");\n          }else{\n            // When the user tries to edit himself\n            echo \"<br />\".$U->getLang(\"admin.user.yourself\");\n          }\n        }else{\n          $sql = \"SELECT * FROM User;\";\n          $dbRes = mysqli_query($U->db_link, $sql);\n          // Allow only values in the range from the lowest Id to the highest id\n          $highestId = 0;\n          // BUG: #54 Lowest ID don't work if over 10000000000000000000000000 accounts are created\n          $lowestId = 10000000000000000000000000;\n          while($row = mysqli_fetch_array($dbRes, MYSQLI_ASSOC)){\n            if($row[\"Id\"] > $highestId){\n              $highestId = $row[\"Id\"];\n            }\n            if($row[\"Id\"] < $lowestId){\n              $lowestId = $row[\"Id\"];\n            }\n          }\n          $text = <<<'HEREDOC'\n          <form action=\"$_SERVER[\"PHP_SELF\"]?URL=useredit\" method=\"post\">\n            <label for=\"N\">ID:</label><input name=\"N\" type=\"number\" min=\"%b\" max=\"%a\" />\n            <input type=\"submit\" />\n          </form>\n          HEREDOC;\n          $text = str_replace('$_SERVER[\"PHP_SELF\"]', $_SERVER['PHP_SELF'], $text);\n          $text = str_replace('%a', $highestId, $text);\n          $text = str_replace('%b', $lowestId, $text);\n          echo $text;\n          if($U->userHasPermission(\"Backend\", \"User\",\"Search\")){\n      ?>\n            <!-- Link to user search page (Opens in a pop-up) -->\n            <a href=\"javascript:window.open('index.php?URL=usersearch', 'Search user', 'width=500,height=500,status=no,titlebar=no,location=no,toolbar=no,left=300');\"><?php echo $U->getLang(\"admin.user.search\"); ?></a>\n      <?php\n          }\n        }\n      ?>\n    </body>\n  </html>\n<?php\n  }else{\n?>\n  <!DOCTYPE html>\n  <html lang=\"<?php echo $U->getSetting(\"site.lang\"); ?>\" dir=\"ltr\">\n    <head>\n      <meta charset=\"utf-8\">\n      <title><?php echo $U->getLang(\"admin\") ?> - <?php echo $U->getLang(\"admin.user\"); ?></title>\n    </head>\n    <body>\n      <a href=\"<?php echo $_SERVER['PHP_SELF']; ?>?URL=mainpage\"><?php echo $U->getLang(\"admin.back\"); ?></a>\n      <p><?php echo $U->getLang(\"rights.error\"); ?></p>\n    </body>\n  </html>\n<?php\n  }\n?>\n"], "filenames": ["admin/pages/usersearch.php"], "buggy_code_start_loc": [2], "buggy_code_end_loc": [113], "fixing_code_start_loc": [2], "fixing_code_end_loc": [137], "type": "CWE-89", "message": "Useful Simple Open-Source CMS (USOC) is a content management system (CMS) for programmers. Versions prior to Pb2.4Bfx3 allowed Sql injection in usersearch.php only for users with administrative privileges. Users should replace the file `admin/pages/useredit.php` with a newer version. USOC version Pb2.4Bfx3 contains a fixed version of `admin/pages/useredit.php`.", "other": {"cve": {"id": "CVE-2022-21666", "sourceIdentifier": "security-advisories@github.com", "published": "2022-01-10T20:15:08.247", "lastModified": "2022-01-19T13:16:20.343", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Useful Simple Open-Source CMS (USOC) is a content management system (CMS) for programmers. Versions prior to Pb2.4Bfx3 allowed Sql injection in usersearch.php only for users with administrative privileges. Users should replace the file `admin/pages/useredit.php` with a newer version. USOC version Pb2.4Bfx3 contains a fixed version of `admin/pages/useredit.php`."}, {"lang": "es", "value": "Useful Simple Open-Source CMS (USOC) es un sistema de administraci\u00f3n de contenidos (CMS) para programadores. Las versiones anteriores a Pb2.4Bfx3, permit\u00edan una inyecci\u00f3n de Sql en el archivo usersearch.php s\u00f3lo para usuarios con privilegios administrativos. Los usuarios deben sustituir el archivo \"admin/pages/useredit.php\" por una versi\u00f3n m\u00e1s reciente. La versi\u00f3n Pb2.4Bfx3 de USOC contiene una versi\u00f3n corregida de \"admin/pages/useredit.php\""}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "HIGH", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 7.2, "baseSeverity": "HIGH"}, "exploitabilityScore": 1.2, "impactScore": 5.9}, {"source": "security-advisories@github.com", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "HIGH", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 7.2, "baseSeverity": "HIGH"}, "exploitabilityScore": 1.2, "impactScore": 5.9}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:S/C:P/I:P/A:P", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "SINGLE", "confidentialityImpact": "PARTIAL", "integrityImpact": "PARTIAL", "availabilityImpact": "PARTIAL", "baseScore": 6.5}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.0, "impactScore": 6.4, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-89"}]}, {"source": "security-advisories@github.com", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-89"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:useful_simple_open-source_cms_project:useful_simple_open-source_cms:*:*:*:*:*:*:*:*", "versionEndExcluding": "pb2.4bfx3", "matchCriteriaId": "2C502D7C-5600-4007-AEA6-18665F44F6D4"}]}]}], "references": [{"url": "https://github.com/Aaron-Junker/USOC/commit/c331d26aaab41a7e9e8c1c1a990132dca9d01e10", "source": "security-advisories@github.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/Aaron-Junker/USOC/releases/tag/Pb2.4Bfx3", "source": "security-advisories@github.com", "tags": ["Release Notes", "Third Party Advisory"]}, {"url": "https://github.com/Aaron-Junker/USOC/security/advisories/GHSA-557p-hhpc-4wrx", "source": "security-advisories@github.com", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/Aaron-Junker/USOC/commit/c331d26aaab41a7e9e8c1c1a990132dca9d01e10"}}