{"buggy_code": ["<?php\n# MantisBT - a php based bugtracking system\n\n# MantisBT is free software: you can redistribute it and/or modify\n# it under the terms of the GNU General Public License as published by\n# the Free Software Foundation, either version 2 of the License, or\n# (at your option) any later version.\n#\n# MantisBT is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n# GNU General Public License for more details.\n#\n# You should have received a copy of the GNU General Public License\n# along with MantisBT.  If not, see <http://www.gnu.org/licenses/>.\n\nrequire_once( 'core.php' );\nrequire_api( 'timeline_api.php' );\n\ndefine( 'MAX_EVENTS', 50 );\n\n# Variables that are defined in parent script:\n#\n# $g_timeline_filter\tFilter array to be used to get timeline event\n#\t\t\t\t\t\tIf undefined, it's initialized as null.\n# $g_timeline_user\t\tUser id to limit timeline scope.\n#\t\t\t\t\t\tIf undefined, it's initialized as null.\n#\n\nif( !isset( $g_timeline_filter ) ) {\n\t$g_timeline_filter = null;\n}\nif( !isset( $g_timeline_user ) ) {\n\t$g_timeline_user = null;\n}\n\n$f_days = gpc_get_int( 'days', 0 );\n$f_all = gpc_get_int( 'all', 0 );\n$t_max_events = $f_all ? 0 : MAX_EVENTS + 1;\n\n$t_end_time = time() - ( $f_days * SECONDS_PER_DAY );\n$t_start_time = $t_end_time - ( 7 * SECONDS_PER_DAY );\n$t_events = timeline_events( $t_start_time, $t_end_time, $t_max_events, $g_timeline_filter, $g_timeline_user );\n\n$t_collapse_block = is_collapsed( 'timeline' );\n$t_block_css = $t_collapse_block ? 'collapsed' : '';\n$t_block_icon = $t_collapse_block ? 'fa-chevron-down' : 'fa-chevron-up';\n\n$t_url_page = $_SERVER[\"PHP_SELF\"];\n$t_url_params = $_GET;\nif( isset( $t_url_params['all'] ) ) {\n\tunset( $t_url_params['all'] );\n}\n?>\n\n<div id=\"timeline\" class=\"widget-box widget-color-blue2 <?php echo $t_block_css ?>\">\n\t<div class=\"widget-header widget-header-small\">\n\t\t<h4 class=\"widget-title lighter\">\n\t\t\t<i class=\"ace-icon fa fa-clock-o\"></i>\n\t\t\t<?php echo lang_get( 'timeline_title' ) ?>\n\t\t</h4>\n\t\t<div class=\"widget-toolbar\">\n\t\t\t<a data-action=\"collapse\" href=\"#\">\n\t\t\t\t<i class=\"1 ace-icon fa <?php echo $t_block_icon ?> bigger-125\"></i>\n\t\t\t</a>\n\t\t</div>\n\t</div>\n\n\t<div class=\"widget-body\">\n\t\t<div class=\"widget-toolbox\">\n\t\t\t<div class=\"btn-toolbar\">\n<?php\n\t\t\t\t$t_short_date_format = config_get( 'short_date_format' );\n\t\t\t\techo '&#160;&#160;';\n\t\t\t\techo '<span class=\"label label-grey\"> ' . date( $t_short_date_format, $t_start_time ) . ' </span>';\n\t\t\t\techo  ' .. ';\n\t\t\t\techo '<span class=\"label label-grey\"> ' . date( $t_short_date_format, $t_end_time ) . ' </span>';\n\t\t\t\techo '&#160;&#160;';\n\n\t\t\t\techo '<div class=\"btn-group\">';\n\t\t\t\t$t_url_params['days'] = $f_days + 7;\n\t\t\t\t$t_href = $t_url_page . '?' . http_build_query( $t_url_params );\n\t\t\t\techo ' <a class=\"btn btn-primary btn-xs btn-white btn-round\" href=\"' . $t_href . '\">' . lang_get( 'prev' ) . '</a>';\n\n\t\t\t\t$t_next_days = ( $f_days - 7 ) > 0 ? $f_days - 7 : 0;\n\n\t\t\t\tif( $t_next_days != $f_days ) {\n\t\t\t\t\t$t_url_params['days'] = $t_next_days;\n\t\t\t\t\t$t_href = $t_url_page . '?' . http_build_query( $t_url_params );\n\t\t\t\t\techo ' <a class=\"btn btn-primary btn-xs btn-white btn-round\" href=\"' . $t_href . '\">' . lang_get( 'next' ) . '</a>';\n\t\t\t\t}\n\t\t\t\techo '</div>';\n?>\n\t\t\t</div>\n\t\t</div>\n\n\t\t<div class=\"widget-main no-padding\">\n\t\t\t<div class=\"profile-feed\">\n\t\t\t</div>\n\t\t</div>\n\n<?php\n\tif( !$f_all && count( $t_events ) > MAX_EVENTS ) {\n\t\t$t_events = array_slice( $t_events, 0, MAX_EVENTS );\n\t\ttimeline_print_events( $t_events );\n\t\techo '<div class=\"widget-toolbox\">';\n\t\techo '<div class=\"btn-toolbar\">';\n\t\t$t_url_params['all'] = 1;\n\t\t$t_href = $t_url_page . '?' . http_build_query( $t_url_params );\n\t\techo '<a class=\"btn btn-primary btn-sm btn-white btn-round\" href=\"' . $t_href . '\">' . lang_get( 'timeline_more' ) . '</a>';\n\t\techo '</div>';\n\t\techo '</div>';\n\t} else {\n\t\ttimeline_print_events( $t_events );\n\t}\n?>\n\n\t</div>\n</div>\n"], "fixing_code": ["<?php\n# MantisBT - a php based bugtracking system\n\n# MantisBT is free software: you can redistribute it and/or modify\n# it under the terms of the GNU General Public License as published by\n# the Free Software Foundation, either version 2 of the License, or\n# (at your option) any later version.\n#\n# MantisBT is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n# GNU General Public License for more details.\n#\n# You should have received a copy of the GNU General Public License\n# along with MantisBT.  If not, see <http://www.gnu.org/licenses/>.\n\nrequire_once( 'core.php' );\nrequire_api( 'timeline_api.php' );\n\ndefine( 'MAX_EVENTS', 50 );\n\n# Variables that are defined in parent script:\n#\n# $g_timeline_filter\tFilter array to be used to get timeline event\n#\t\t\t\t\t\tIf undefined, it's initialized as null.\n# $g_timeline_user\t\tUser id to limit timeline scope.\n#\t\t\t\t\t\tIf undefined, it's initialized as null.\n#\n\nif( !isset( $g_timeline_filter ) ) {\n\t$g_timeline_filter = null;\n}\nif( !isset( $g_timeline_user ) ) {\n\t$g_timeline_user = null;\n}\n\n$f_days = gpc_get_int( 'days', 0 );\n$f_all = gpc_get_int( 'all', 0 );\n$t_max_events = $f_all ? 0 : MAX_EVENTS + 1;\n\n$t_end_time = time() - ( $f_days * SECONDS_PER_DAY );\n$t_start_time = $t_end_time - ( 7 * SECONDS_PER_DAY );\n$t_events = timeline_events( $t_start_time, $t_end_time, $t_max_events, $g_timeline_filter, $g_timeline_user );\n\n$t_collapse_block = is_collapsed( 'timeline' );\n$t_block_css = $t_collapse_block ? 'collapsed' : '';\n$t_block_icon = $t_collapse_block ? 'fa-chevron-down' : 'fa-chevron-up';\n\n$t_url_page = string_sanitize_url( basename( $_SERVER['SCRIPT_NAME'] ) );\n$t_url_params = $_GET;\nif( isset( $t_url_params['all'] ) ) {\n\tunset( $t_url_params['all'] );\n}\n?>\n\n<div id=\"timeline\" class=\"widget-box widget-color-blue2 <?php echo $t_block_css ?>\">\n\t<div class=\"widget-header widget-header-small\">\n\t\t<h4 class=\"widget-title lighter\">\n\t\t\t<i class=\"ace-icon fa fa-clock-o\"></i>\n\t\t\t<?php echo lang_get( 'timeline_title' ) ?>\n\t\t</h4>\n\t\t<div class=\"widget-toolbar\">\n\t\t\t<a data-action=\"collapse\" href=\"#\">\n\t\t\t\t<i class=\"1 ace-icon fa <?php echo $t_block_icon ?> bigger-125\"></i>\n\t\t\t</a>\n\t\t</div>\n\t</div>\n\n\t<div class=\"widget-body\">\n\t\t<div class=\"widget-toolbox\">\n\t\t\t<div class=\"btn-toolbar\">\n<?php\n\t\t\t\t$t_short_date_format = config_get( 'short_date_format' );\n\t\t\t\techo '&#160;&#160;';\n\t\t\t\techo '<span class=\"label label-grey\"> ' . date( $t_short_date_format, $t_start_time ) . ' </span>';\n\t\t\t\techo  ' .. ';\n\t\t\t\techo '<span class=\"label label-grey\"> ' . date( $t_short_date_format, $t_end_time ) . ' </span>';\n\t\t\t\techo '&#160;&#160;';\n\n\t\t\t\techo '<div class=\"btn-group\">';\n\t\t\t\t$t_url_params['days'] = $f_days + 7;\n\t\t\t\t$t_href = $t_url_page . '?' . http_build_query( $t_url_params );\n\t\t\t\techo ' <a class=\"btn btn-primary btn-xs btn-white btn-round\" href=\"' . $t_href . '\">' . lang_get( 'prev' ) . '</a>';\n\n\t\t\t\t$t_next_days = ( $f_days - 7 ) > 0 ? $f_days - 7 : 0;\n\n\t\t\t\tif( $t_next_days != $f_days ) {\n\t\t\t\t\t$t_url_params['days'] = $t_next_days;\n\t\t\t\t\t$t_href = $t_url_page . '?' . http_build_query( $t_url_params );\n\t\t\t\t\techo ' <a class=\"btn btn-primary btn-xs btn-white btn-round\" href=\"' . $t_href . '\">' . lang_get( 'next' ) . '</a>';\n\t\t\t\t}\n\t\t\t\techo '</div>';\n?>\n\t\t\t</div>\n\t\t</div>\n\n\t\t<div class=\"widget-main no-padding\">\n\t\t\t<div class=\"profile-feed\">\n\t\t\t</div>\n\t\t</div>\n\n<?php\n\tif( !$f_all && count( $t_events ) > MAX_EVENTS ) {\n\t\t$t_events = array_slice( $t_events, 0, MAX_EVENTS );\n\t\ttimeline_print_events( $t_events );\n\t\techo '<div class=\"widget-toolbox\">';\n\t\techo '<div class=\"btn-toolbar\">';\n\t\t$t_url_params['all'] = 1;\n\t\t$t_href = $t_url_page . '?' . http_build_query( $t_url_params );\n\t\techo '<a class=\"btn btn-primary btn-sm btn-white btn-round\" href=\"' . $t_href . '\">' . lang_get( 'timeline_more' ) . '</a>';\n\t\techo '</div>';\n\t\techo '</div>';\n\t} else {\n\t\ttimeline_print_events( $t_events );\n\t}\n?>\n\n\t</div>\n</div>\n"], "filenames": ["core/timeline_inc.php"], "buggy_code_start_loc": [49], "buggy_code_end_loc": [50], "fixing_code_start_loc": [49], "fixing_code_end_loc": [50], "type": "CWE-79", "message": "A cross-site scripting (XSS) vulnerability in the MantisBT (2.3.x before 2.3.2) Timeline include page, used in My View (my_view_page.php) and User Information (view_user_page.php) pages, allows remote attackers to inject arbitrary code (if CSP settings permit it) through crafted PATH_INFO in a URL, due to use of unsanitized $_SERVER['PHP_SELF'] to generate URLs.", "other": {"cve": {"id": "CVE-2017-7897", "sourceIdentifier": "cve@mitre.org", "published": "2017-04-18T17:59:00.163", "lastModified": "2017-07-11T01:33:48.003", "vulnStatus": "Modified", "descriptions": [{"lang": "en", "value": "A cross-site scripting (XSS) vulnerability in the MantisBT (2.3.x before 2.3.2) Timeline include page, used in My View (my_view_page.php) and User Information (view_user_page.php) pages, allows remote attackers to inject arbitrary code (if CSP settings permit it) through crafted PATH_INFO in a URL, due to use of unsanitized $_SERVER['PHP_SELF'] to generate URLs."}, {"lang": "es", "value": "Una vulnerabilidad XSS en el MantisBT (2.3.x en versiones anteriores a 2.3.2) Timeline incluye p\u00e1gina, utilizada en My View (my_view_page.php) y p\u00e1ginas User Information (view_user_page.php), permite a atacantes remotos inyectar c\u00f3digo arbitrario (si los ajustes CSP lo permiten) a trav\u00e9s de PATH_INFO manipulado en una URL, debido al uso de $_SERVER['PHP_SELF'] no desinfectado para generar URLs."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:mantisbt:mantisbt:2.3.0:*:*:*:*:*:*:*", "matchCriteriaId": "83C79C70-F6BE-485D-952A-44E5E9F16D39"}, {"vulnerable": true, "criteria": "cpe:2.3:a:mantisbt:mantisbt:2.3.1:*:*:*:*:*:*:*", "matchCriteriaId": "2B5AE145-E1B4-40EF-A3B8-A13C114D3D3B"}]}]}], "references": [{"url": "http://www.mantisbt.org/bugs/view.php?id=22742", "source": "cve@mitre.org", "tags": ["Exploit", "Issue Tracking"]}, {"url": "http://www.securitytracker.com/id/1038278", "source": "cve@mitre.org"}, {"url": "https://github.com/mantisbt/mantisbt/commit/a1c719313d61b07bbe8700005807b8195fdc32f1", "source": "cve@mitre.org", "tags": ["Patch"]}, {"url": "https://github.com/mantisbt/mantisbt/pull/1094", "source": "cve@mitre.org", "tags": ["Exploit", "Patch", "Vendor Advisory"]}]}, "github_commit_url": "https://github.com/mantisbt/mantisbt/commit/a1c719313d61b07bbe8700005807b8195fdc32f1"}}