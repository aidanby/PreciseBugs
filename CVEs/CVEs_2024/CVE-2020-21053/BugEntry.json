{"buggy_code": ["<?php\r\n/*\r\n\tFusionPBX\r\n\tVersion: MPL 1.1\r\n\r\n\tThe contents of this file are subject to the Mozilla Public License Version\r\n\t1.1 (the \"License\"); you may not use this file except in compliance with\r\n\tthe License. You may obtain a copy of the License at\r\n\thttp://www.mozilla.org/MPL/\r\n\r\n\tSoftware distributed under the License is distributed on an \"AS IS\" basis,\r\n\tWITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\r\n\tfor the specific language governing rights and limitations under the\r\n\tLicense.\r\n\r\n\tThe Original Code is FusionPBX\r\n\r\n\tThe Initial Developer of the Original Code is\r\n\tMark J Crane <markjcrane@fusionpbx.com>\r\n\tPortions created by the Initial Developer are Copyright (C) 2018\r\n\tthe Initial Developer. All Rights Reserved.\r\n\r\n\tContributor(s):\r\n\tMark J Crane <markjcrane@fusionpbx.com>\r\n*/\r\n\r\n//includes\r\n\tinclude \"root.php\";\r\n\trequire_once \"resources/require.php\";\r\n\trequire_once \"resources/check_auth.php\";\r\n\r\n//check permissions\r\n\tif (permission_exists('device_add')) {\r\n\t\t//access granted\r\n\t}\r\n\telse {\r\n\t\techo \"access denied\";\r\n\t\texit;\r\n\t}\r\n\r\n//add multi-lingual support\r\n\t$language = new text;\r\n\t$text = $language->get();\r\n\r\n//built in str_getcsv requires PHP 5.3 or higher, this function can be used to reproduct the functionality but requirs PHP 5.1.0 or higher\r\n\tif(!function_exists('str_getcsv')) {\r\n\t\tfunction str_getcsv($input, $delimiter = \",\", $enclosure = '\"', $escape = \"\\\\\") {\r\n\t\t\t$fp = fopen(\"php://memory\", 'r+');\r\n\t\t\tfputs($fp, $input);\r\n\t\t\trewind($fp);\r\n\t\t\t$data = fgetcsv($fp, null, $delimiter, $enclosure); // $escape only got added in 5.3.0\r\n\t\t\tfclose($fp);\r\n\t\t\treturn $data;\r\n\t\t}\r\n\t}\r\n\r\n//set the max php execution time\r\n\tini_set(max_execution_time,7200);\r\n\r\n//get the http get values and set them as php variables\r\n\t$action = check_str($_POST[\"action\"]);\r\n\t$from_row = check_str($_POST[\"from_row\"]);\r\n\t$order_by = check_str($_POST[\"order_by\"]);\r\n\t$order = check_str($_POST[\"order\"]);\r\n\t$delimiter = check_str($_POST[\"data_delimiter\"]);\r\n\t$enclosure = check_str($_POST[\"data_enclosure\"]);\r\n\r\n//save the data to the csv file\r\n\tif (isset($_POST['data'])) {\r\n\t\t$file = $_SESSION['server']['temp']['dir'].\"/devices-\".$_SESSION['domain_name'].\".csv\";\r\n\t\tfile_put_contents($file, $_POST['data']);\r\n\t\t$_SESSION['file'] = $file;\r\n\t}\r\n\r\n//copy the csv file\r\n\t//$_POST['submit'] == \"Upload\" &&\r\n\tif ( is_uploaded_file($_FILES['ulfile']['tmp_name']) && permission_exists('device_imports')) {\r\n\t\tif (check_str($_POST['type']) == 'csv') {\r\n\t\t\tmove_uploaded_file($_FILES['ulfile']['tmp_name'], $_SESSION['server']['temp']['dir'].'/'.$_FILES['ulfile']['name']);\r\n\t\t\t$save_msg = \"Uploaded file to \".$_SESSION['server']['temp']['dir'].\"/\". htmlentities($_FILES['ulfile']['name']);\r\n\t\t\t//system('chmod -R 744 '.$_SESSION['server']['temp']['dir'].'*');\r\n\t\t\tunset($_POST['txtCommand']);\r\n\t\t\t$file = $_SESSION['server']['temp']['dir'].'/'.$_FILES['ulfile']['name'];\r\n\t\t\t$_SESSION['file'] = $file;\r\n\t\t}\r\n\t}\r\n\r\n//get the schema\r\n\tif (strlen($delimiter) > 0) {\r\n\t\t//get the first line\r\n\t\t\t$line = fgets(fopen($_SESSION['file'], 'r'));\r\n\t\t\t$line_fields = explode($delimiter, $line);\r\n\r\n\t\t//get the schema\r\n\t\t\t$x = 0;\r\n\t\t\tinclude (\"app/devices/app_config.php\");\r\n\t\t\t$i = 0;\r\n\t\t\tforeach($apps[0]['db'] as $table) {\r\n\t\t\t\t//get the table name and parent name\r\n\t\t\t\t$table_name = $table[\"table\"]['name'];\r\n\t\t\t\t$parent_name = $table[\"table\"]['parent'];\r\n\r\n\t\t\t\t//remove the v_ table prefix\r\n\t\t\t\tif (substr($table_name, 0, 2) == 'v_') {\r\n\t\t\t\t\t\t$table_name = substr($table_name, 2);\r\n\t\t\t\t}\r\n\t\t\t\tif (substr($parent_name, 0, 2) == 'v_') {\r\n\t\t\t\t\t\t$parent_name = substr($parent_name, 2);\r\n\t\t\t\t}\r\n\r\n\t\t\t\t//filter for specific tables and build the schema array\r\n\t\t\t\tif ($table_name == \"devices\" || $table_name == \"device_lines\" || \r\n\t\t\t\t\t$table_name == \"device_keys\" || $table_name == \"device_settings\") {\r\n\t\t\t\t\t$schema[$i]['table'] = $table_name;\r\n\t\t\t\t\t$schema[$i]['parent'] = $parent_name;\r\n\t\t\t\t\tforeach($table['fields'] as $row) {\r\n\t\t\t\t\t\tif ($row['deprecated'] !== 'true') {\r\n\t\t\t\t\t\t\tif (is_array($row['name'])) {\r\n\t\t\t\t\t\t\t\t$field_name = $row['name']['text'];\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\t$field_name = $row['name'];\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t$schema[$i]['fields'][] = $field_name;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t$i++;\t\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t$i++;\r\n\t\t\t$schema[$i]['table'] = 'devices';\r\n\t\t\t$schema[$i]['parent'] = '';\r\n\t\t\t$schema[$i]['fields'][] = 'username';\r\n\t}\r\n\r\n//match the column names to the field names\r\n\tif (strlen($delimiter) > 0 && file_exists($_SESSION['file']) && $action != 'import') {\r\n\r\n\t\t//form to match the fields to the column names\r\n\t\t\trequire_once \"resources/header.php\";\r\n\r\n\t\t\techo \"<form action='device_imports.php' method='POST' enctype='multipart/form-data' name='frmUpload' onSubmit=''>\\n\";\r\n\t\t\techo \"<table width='100%' border='0' cellpadding='0' cellspacing='0'>\\n\";\r\n\r\n\t\t\techo \"\t<tr>\\n\";\r\n\t\t\techo \"\t<td valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\t\t\techo \"\t\t<b>\".$text['header-import'].\"</b><br />\\n\";\r\n\t\t\techo \"\t</td>\\n\";\r\n\t\t\techo \"\t<td valign='top' align='right'>\\n\";\r\n\t\t\techo \"\t\t<input type='button' class='btn' name='' alt='\".$text['button-back'].\"' onclick=\\\"window.location='devices.php'\\\" value='\".$text['button-back'].\"'>\\n\";\r\n\t\t\techo \"\t\t<input name='submit' type='submit' class='btn' id='import' value=\\\"\".$text['button-import'].\"\\\">\\n\";\r\n\t\t\techo \"\t</td>\\n\";\r\n\t\t\techo \"\t</tr>\\n\";\r\n\t\t\techo \"\t<tr>\\n\";\r\n\t\t\techo \"\t<td colspan='2' align='left'>\\n\";\r\n\t\t\techo \"\t\t\".$text['description-import'].\"\\n\";\r\n\t\t\techo \"\t</td>\\n\";\r\n\t\t\techo \"\t</tr>\\n\";\r\n\r\n\t\t\t//echo \"<tr>\\n\";\r\n\t\t\t//echo \"<td align='left' width='30%' nowrap='nowrap'><b>\".$text['header-import'].\"</b></td>\\n\";\r\n\t\t\t//echo \"<td width='70%' align='right'>\\n\";\r\n\t\t\t//echo \"\t<input type='button' class='btn' name='' alt='\".$text['button-back'].\"' onclick=\\\"window.location='devices.php'\\\" value='\".$text['button-back'].\"'>\\n\";\r\n\t\t\t//echo \"</td>\\n\";\r\n\t\t\t//echo \"</tr>\\n\";\r\n\r\n\t\t\t//loop through user columns\r\n\t\t\t$x = 0;\r\n\t\t\tforeach ($line_fields as $line_field) {\r\n\t\t\t\t$line_field = trim(trim($line_field), $enclosure);\r\n\t\t\t\techo \"<tr>\\n\";\r\n\t\t\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\t\t\t\t//echo \"    \".$text['label-zzz'].\"\\n\";\r\n\t\t\t\techo $line_field;\r\n\t\t\t\techo \"</td>\\n\";\r\n\t\t\t\techo \"<td class='vtable' align='left'>\\n\";\r\n\t\t\t\techo \"    \t\t\t<select class='formfld' style='' name='fields[$x]'>\\n\";\r\n\t\t\t\techo \"    \t\t\t<option value=''></option>\\n\";\r\n\t\t\t\tforeach($schema as $row) {\r\n\t\t\t\t\techo \"\t\t\t<optgroup label='\".$row['table'].\"'>\\n\";\r\n\t\t\t\t\tforeach($row['fields'] as $field) {\r\n\t\t\t\t\t\t$selected = '';\r\n\t\t\t\t\t\tif ($field == $line_field) {\r\n\t\t\t\t\t\t\t$selected = \"selected='selected'\";\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif ($field !== 'domain_uuid') {\r\n\t\t\t\t\t\t\techo \"    \t\t\t<option value='\".$row['table'].\".\".$field.\"' \".$selected.\">\".$field.\"</option>\\n\";\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\techo \"\t\t\t</optgroup>\\n\";\r\n\t\t\t\t}\r\n\t\t\t\techo \"    \t\t\t</select>\\n\";\r\n\t\t\t\t//echo \"<br />\\n\";\r\n\t\t\t\t//echo $text['description-zzz'].\"\\n\";\r\n\t\t\t\techo \"\t\t\t</td>\\n\";\r\n\t\t\t\techo \"\t\t</tr>\\n\";\r\n\t\t\t\t$x++;\r\n\t\t\t}\r\n\r\n\t\t\techo \"\t\t<tr>\\n\";\r\n\t\t\techo \"\t\t\t<td colspan='2' valign='top' align='right' nowrap='nowrap'>\\n\";\r\n\t\t\techo \"\t\t\t\t<input name='action' type='hidden' value='import'>\\n\";\r\n\t\t\techo \"\t\t\t\t<input name='from_row' type='hidden' value='$from_row'>\\n\";\r\n\t\t\techo \"\t\t\t\t<input name='data_delimiter' type='hidden' value='$delimiter'>\\n\";\r\n\t\t\techo \"\t\t\t\t<input name='data_enclosure' type='hidden' value='$enclosure'>\\n\";\r\n\t\t\techo \"\t\t\t\t<input type='submit' class='btn' id='import' value=\\\"\".$text['button-import'].\"\\\">\\n\";\r\n\t\t\techo \"\t\t\t</td>\\n\";\r\n\t\t\techo \"\t\t</tr>\\n\";\r\n\r\n\t\t\techo \"\t</table>\\n\";\r\n\t\t\techo \"</form>\\n\";\r\n\t\t\trequire_once \"resources/footer.php\";\r\n\r\n\t\t//normalize the column names\r\n\t\t\t//$line = strtolower($line);\r\n\t\t\t//$line = str_replace(\"-\", \"_\", $line);\r\n\t\t\t//$line = str_replace($delimiter.\"title\".$delimiter, $delimiter.\"contact_title\".$delimiter, $line);\r\n\t\t\t//$line = str_replace(\"firstname\", \"name_given\", $line);\r\n\t\t\t//$line = str_replace(\"lastname\", \"name_family\", $line);\r\n\t\t\t//$line = str_replace(\"company\", \"organization\", $line);\r\n\t\t\t//$line = str_replace(\"company\", \"contact_email\", $line);\r\n\r\n\t\t//end the script\r\n\t\t\texit;\r\n\t}\r\n\r\n//get the parent table\r\n\tfunction get_parent($schema,$table_name) {\r\n\t\tforeach ($schema as $row) {\r\n\t\t\tif ($row['table'] == $table_name) {\r\n\t\t\t\treturn $row['parent'];\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n//upload the csv\r\n\tif (file_exists($_SESSION['file']) && $action == 'import') {\r\n\r\n\t\t//form to match the fields to the column names\r\n\t\t\t//require_once \"resources/header.php\";\r\n\r\n\t\t//user selected fields\r\n\t\t\t$fields = $_POST['fields'];\r\n\t\t\t\r\n\t\t//set the domain_uuid\r\n\t\t\t$domain_uuid = $_SESSION['domain_uuid'];\r\n\r\n\t\t//get the users\r\n\t\t\t$sql = \"select * from v_users where domain_uuid = :domain_uuid \";\r\n\t\t\t$parameters['domain_uuid'] = $domain_uuid;\r\n\t\t\t$database = new database;\r\n\t\t\t$users = $database->select($sql, $parameters, 'all');\r\n\t\t\tunset($sql, $parameters);\r\n\r\n\t\t//get the contents of the csv file and convert them into an array\r\n\t\t\t$handle = @fopen($_SESSION['file'], \"r\");\r\n\t\t\tif ($handle) {\r\n\t\t\t\t//set the starting identifiers\r\n\t\t\t\t\t$row_id = 0;\r\n\t\t\t\t\t$row_number = 1;\r\n\r\n\t\t\t\t//loop through the array\r\n\t\t\t\t\twhile (($line = fgets($handle, 4096)) !== false) {\r\n\t\t\t\t\t\tif ($from_row <= $row_number) {\r\n\t\t\t\t\t\t\t//format the data\r\n\t\t\t\t\t\t\t\t$y = 0;\r\n\t\t\t\t\t\t\t\tforeach ($fields as $key => $value) {\r\n\t\t\t\t\t\t\t\t\t//get the line\r\n\t\t\t\t\t\t\t\t\t$result = str_getcsv($line, $delimiter, $enclosure);\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t//get the table and field name\r\n\t\t\t\t\t\t\t\t\t$field_array = explode(\".\",$value);\r\n\t\t\t\t\t\t\t\t\t$table_name = $field_array[0];\r\n\t\t\t\t\t\t\t\t\t$field_name = $field_array[1];\r\n\t\t\t\t\t\t\t\t\t//echo \"value: $value<br />\\n\";\r\n\t\t\t\t\t\t\t\t\t//echo \"table_name: $table_name<br />\\n\";\r\n\t\t\t\t\t\t\t\t\t//echo \"field_name: $field_name<br />\\n\";\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t//get the parent table name\r\n\t\t\t\t\t\t\t\t\t$parent = get_parent($schema, $table_name);\r\n\r\n\t\t\t\t\t\t\t\t\t//remove formatting from the phone number\r\n\t\t\t\t\t\t\t\t\tif ($field_name == \"phone_number\") {\r\n\t\t\t\t\t\t\t\t\t\t$result[$key] = preg_replace('{\\D}', '', $result[$key]);\r\n\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t//build the data array\r\n\t\t\t\t\t\t\t\t\tif (strlen($table_name) > 0) {\r\n\t\t\t\t\t\t\t\t\t\tif (strlen($parent) == 0) {\r\n\t\t\t\t\t\t\t\t\t\t\tif ($field_name != \"username\") {\r\n\t\t\t\t\t\t\t\t\t\t\t\t$array[$table_name][$row_id]['domain_uuid'] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t\t$array[$table_name][$row_id][$field_name] = $result[$key];\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\t\t\t\t$array[$parent][$row_id][$table_name][$y]['domain_uuid'] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t$array[$parent][$row_id][$table_name][$y][$field_name] = $result[$key];\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t\tif ($field_name == \"username\") {\r\n\t\t\t\t\t\t\t\t\t\t\tforeach ($users as $field) {\r\n\t\t\t\t\t\t\t\t\t\t\t\tif ($field['username'] == $result[$key]) {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[$table_name][$row_id]['device_user_uuid'] = $field['user_uuid'];\r\n\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t//process a chunk of the array\r\n\t\t\t\t\t\t\t\tif ($row_id === 1000) {\r\n\r\n\t\t\t\t\t\t\t\t\t//save to the data\r\n\t\t\t\t\t\t\t\t\t\t$database = new database;\r\n\t\t\t\t\t\t\t\t\t\t$database->app_name = 'devices';\r\n\t\t\t\t\t\t\t\t\t\t$database->app_uuid = '4efa1a1a-32e7-bf83-534b-6c8299958a8e';\r\n\t\t\t\t\t\t\t\t\t\t$database->save($array);\r\n\t\t\t\t\t\t\t\t\t\t//$message = $database->message;\r\n\r\n\t\t\t\t\t\t\t\t\t//clear the array\r\n\t\t\t\t\t\t\t\t\t\tunset($array);\r\n\r\n\t\t\t\t\t\t\t\t\t//set the row id back to 0\r\n\t\t\t\t\t\t\t\t\t\t$row_id = 0;\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t} //if ($from_row <= $row_id)\r\n\t\t\t\t\t\t$row_number++;\r\n\t\t\t\t\t\t$row_id++;\r\n\t\t\t\t\t} //end while\r\n\t\t\t\t\tfclose($handle);\r\n\r\n\t\t\t\t//debug info\r\n\t\t\t\t\t//echo \"<pre>\\n\";\r\n\t\t\t\t\t//print_r($array);\r\n\t\t\t\t\t//echo \"</pre>\\n\";\r\n\t\t\t\t\t//exit;\r\n\r\n\t\t\t\t//save to the data\r\n\t\t\t\t\tif (is_array($array)) {\r\n\t\t\t\t\t\t$database = new database;\r\n\t\t\t\t\t\t$database->app_name = 'devices';\r\n\t\t\t\t\t\t$database->app_uuid = '4efa1a1a-32e7-bf83-534b-6c8299958a8e';\r\n\t\t\t\t\t\t$database->save($array);\r\n\t\t\t\t\t\t//$message = $database->message;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t//send the redirect header\r\n\t\t\t\t\theader(\"Location: devices.php\");\r\n\t\t\t\t\treturn;\r\n\t\t\t}\r\n\t}\r\n\r\n//include the header\r\n\trequire_once \"resources/header.php\";\r\n\r\n//begin the content\r\n\techo \"<table width='100%' border='0' cellpadding='0' cellspacing='0'>\\n\";\r\n\techo \"\t<tr>\\n\";\r\n\techo \"\t<td valign='top' align='left' width='30%' nowrap='nowrap'>\\n\";\r\n\techo \"\t\t<b>\".$text['header-import'].\"</b><br />\\n\";\r\n\techo \"\t\t\".$text['description-import'].\"\\n\";\r\n\techo \"\t</td>\\n\";\r\n\techo \"\t<td valign='top' width='70%' align='right'>\\n\";\r\n\techo \"\t\t<input type='button' class='btn' name='' alt='\".$text['button-back'].\"' onclick=\\\"window.location='devices.php?\".$_GET[\"query_string\"].\"'\\\" value='\".$text['button-back'].\"'>\\n\";\r\n\t//echo \"\t\t<input name='submit' type='submit' class='btn' id='import' value=\\\"\".$text['button-import'].\"\\\">\\n\";\r\n\techo \"\t</td>\\n\";\r\n\techo \"\t</tr>\\n\";\r\n\techo \"</table>\";\r\n\r\n\techo \"<br />\\n\";\r\n\r\n\techo \"<form action='' method='POST' enctype='multipart/form-data' name='frmUpload' onSubmit=''>\\n\";\r\n\techo \"\t<table border='0' cellpadding='0' cellspacing='0' width='100%'>\\n\";\r\n\r\n\techo \"<tr>\\n\";\r\n\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\techo \"    \".$text['label-import_data'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"<td class='vtable' align='left'>\\n\";\r\n\techo \"    <textarea name='data' id='data' rows='7' class='formfld' style='width: 100%;' wrap='off'>$data</textarea>\\n\";\r\n\techo \"<br />\\n\";\r\n\techo $text['description-import_data'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"</tr>\\n\";\r\n\r\n\techo \"<tr>\\n\";\r\n\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\techo \"    \".$text['label-from_row'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"<td class='vtable' align='left'>\\n\";\r\n\techo \"\t\t<select class='formfld' name='from_row'>\\n\";\r\n\t$i=1;\r\n\twhile($i<=99) {\r\n\t\t$selected = ($i == $from_row) ? \"selected\" : null;\r\n\t\techo \"\t\t\t<option value='$i' \".$selected.\">$i</option>\\n\";\r\n\t\t$i++;\r\n\t}\r\n\techo \"\t\t</select>\\n\";\r\n\techo \"<br />\\n\";\r\n\techo $text['description-from_row'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"</tr>\\n\";\r\n\r\n\techo \"<tr>\\n\";\r\n\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\techo \"    \".$text['label-import_delimiter'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"<td class='vtable' align='left'>\\n\";\r\n\techo \"    <select class='formfld' style='width:40px;' name='data_delimiter'>\\n\";\r\n\techo \"    <option value=','>,</option>\\n\";\r\n\techo \"    <option value='|'>|</option>\\n\";\r\n\techo \"    </select>\\n\";\r\n\techo \"<br />\\n\";\r\n\techo $text['description-import_delimiter'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"</tr>\\n\";\r\n\r\n\techo \"<tr>\\n\";\r\n\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\techo \"    \".$text['label-import_enclosure'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"<td class='vtable' align='left'>\\n\";\r\n\techo \"    <select class='formfld' style='width:40px;' name='data_enclosure'>\\n\";\r\n\techo \"    <option value='\\\"'>\\\"</option>\\n\";\r\n\techo \"    <option value=''></option>\\n\";\r\n\techo \"    </select>\\n\";\r\n\techo \"<br />\\n\";\r\n\techo $text['description-import_enclosure'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"</tr>\\n\";\r\n\r\n\techo \"<tr>\\n\";\r\n\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\techo \"\t\t\t\".$text['label-import_file_upload'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"<td class='vtable' align='left'>\\n\";\r\n\techo \"\t\t\t<input name='ulfile' type='file' class='formfld fileinput' id='ulfile'>\\n\";\r\n\techo \"<br />\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"</tr>\\n\";\r\n\r\n\techo \"\t<tr>\\n\";\r\n\techo \"\t\t<td valign='bottom'>\\n\";\r\n\techo \"\t\t\t&nbsp;\\n\";\r\n\techo \"\t\t</td>\\n\";\r\n\techo \"\t\t<td valign='bottom' align='right' nowrap>\\n\";\r\n\techo \"\t\t\t<input name='type' type='hidden' value='csv'>\\n\";\r\n\techo \"\t\t\t<br />\\n\";\r\n\techo \"\t\t\t<input name='submit' type='submit' class='btn' id='import' value=\\\"\".$text['button-import'].\"\\\">\\n\";\r\n\techo \"\t\t</td>\\n\";\r\n\techo \"\t</tr>\\n\";\r\n\techo \"\t</table>\\n\";\r\n\techo \"<br><br>\";\r\n\techo \"</form>\";\r\n\r\n//include the footer\r\n\trequire_once \"resources/footer.php\";\r\n\r\n?>\r\n"], "fixing_code": ["<?php\r\n/*\r\n\tFusionPBX\r\n\tVersion: MPL 1.1\r\n\r\n\tThe contents of this file are subject to the Mozilla Public License Version\r\n\t1.1 (the \"License\"); you may not use this file except in compliance with\r\n\tthe License. You may obtain a copy of the License at\r\n\thttp://www.mozilla.org/MPL/\r\n\r\n\tSoftware distributed under the License is distributed on an \"AS IS\" basis,\r\n\tWITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\r\n\tfor the specific language governing rights and limitations under the\r\n\tLicense.\r\n\r\n\tThe Original Code is FusionPBX\r\n\r\n\tThe Initial Developer of the Original Code is\r\n\tMark J Crane <markjcrane@fusionpbx.com>\r\n\tPortions created by the Initial Developer are Copyright (C) 2018\r\n\tthe Initial Developer. All Rights Reserved.\r\n\r\n\tContributor(s):\r\n\tMark J Crane <markjcrane@fusionpbx.com>\r\n*/\r\n\r\n//includes\r\n\tinclude \"root.php\";\r\n\trequire_once \"resources/require.php\";\r\n\trequire_once \"resources/check_auth.php\";\r\n\r\n//check permissions\r\n\tif (permission_exists('device_add')) {\r\n\t\t//access granted\r\n\t}\r\n\telse {\r\n\t\techo \"access denied\";\r\n\t\texit;\r\n\t}\r\n\r\n//add multi-lingual support\r\n\t$language = new text;\r\n\t$text = $language->get();\r\n\r\n//built in str_getcsv requires PHP 5.3 or higher, this function can be used to reproduct the functionality but requirs PHP 5.1.0 or higher\r\n\tif(!function_exists('str_getcsv')) {\r\n\t\tfunction str_getcsv($input, $delimiter = \",\", $enclosure = '\"', $escape = \"\\\\\") {\r\n\t\t\t$fp = fopen(\"php://memory\", 'r+');\r\n\t\t\tfputs($fp, $input);\r\n\t\t\trewind($fp);\r\n\t\t\t$data = fgetcsv($fp, null, $delimiter, $enclosure); // $escape only got added in 5.3.0\r\n\t\t\tfclose($fp);\r\n\t\t\treturn $data;\r\n\t\t}\r\n\t}\r\n\r\n//set the max php execution time\r\n\tini_set(max_execution_time,7200);\r\n\r\n//get the http get values and set them as php variables\r\n\t$action = check_str($_POST[\"action\"]);\r\n\t$from_row = check_str($_POST[\"from_row\"]);\r\n\t$order_by = check_str($_POST[\"order_by\"]);\r\n\t$order = check_str($_POST[\"order\"]);\r\n\t$delimiter = check_str($_POST[\"data_delimiter\"]);\r\n\t$enclosure = check_str($_POST[\"data_enclosure\"]);\r\n\r\n//save the data to the csv file\r\n\tif (isset($_POST['data'])) {\r\n\t\t$file = $_SESSION['server']['temp']['dir'].\"/devices-\".$_SESSION['domain_name'].\".csv\";\r\n\t\tfile_put_contents($file, $_POST['data']);\r\n\t\t$_SESSION['file'] = $file;\r\n\t}\r\n\r\n//copy the csv file\r\n\t//$_POST['submit'] == \"Upload\" &&\r\n\tif ( is_uploaded_file($_FILES['ulfile']['tmp_name']) && permission_exists('device_imports')) {\r\n\t\tif (check_str($_POST['type']) == 'csv') {\r\n\t\t\tmove_uploaded_file($_FILES['ulfile']['tmp_name'], $_SESSION['server']['temp']['dir'].'/'.$_FILES['ulfile']['name']);\r\n\t\t\t$save_msg = \"Uploaded file to \".$_SESSION['server']['temp']['dir'].\"/\". htmlentities($_FILES['ulfile']['name']);\r\n\t\t\t//system('chmod -R 744 '.$_SESSION['server']['temp']['dir'].'*');\r\n\t\t\tunset($_POST['txtCommand']);\r\n\t\t\t$file = $_SESSION['server']['temp']['dir'].'/'.$_FILES['ulfile']['name'];\r\n\t\t\t$_SESSION['file'] = $file;\r\n\t\t}\r\n\t}\r\n\r\n//get the schema\r\n\tif (strlen($delimiter) > 0) {\r\n\t\t//get the first line\r\n\t\t\t$line = fgets(fopen($_SESSION['file'], 'r'));\r\n\t\t\t$line_fields = explode($delimiter, $line);\r\n\r\n\t\t//get the schema\r\n\t\t\t$x = 0;\r\n\t\t\tinclude (\"app/devices/app_config.php\");\r\n\t\t\t$i = 0;\r\n\t\t\tforeach($apps[0]['db'] as $table) {\r\n\t\t\t\t//get the table name and parent name\r\n\t\t\t\t$table_name = $table[\"table\"]['name'];\r\n\t\t\t\t$parent_name = $table[\"table\"]['parent'];\r\n\r\n\t\t\t\t//remove the v_ table prefix\r\n\t\t\t\tif (substr($table_name, 0, 2) == 'v_') {\r\n\t\t\t\t\t\t$table_name = substr($table_name, 2);\r\n\t\t\t\t}\r\n\t\t\t\tif (substr($parent_name, 0, 2) == 'v_') {\r\n\t\t\t\t\t\t$parent_name = substr($parent_name, 2);\r\n\t\t\t\t}\r\n\r\n\t\t\t\t//filter for specific tables and build the schema array\r\n\t\t\t\tif ($table_name == \"devices\" || $table_name == \"device_lines\" || \r\n\t\t\t\t\t$table_name == \"device_keys\" || $table_name == \"device_settings\") {\r\n\t\t\t\t\t$schema[$i]['table'] = $table_name;\r\n\t\t\t\t\t$schema[$i]['parent'] = $parent_name;\r\n\t\t\t\t\tforeach($table['fields'] as $row) {\r\n\t\t\t\t\t\tif ($row['deprecated'] !== 'true') {\r\n\t\t\t\t\t\t\tif (is_array($row['name'])) {\r\n\t\t\t\t\t\t\t\t$field_name = $row['name']['text'];\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\t$field_name = $row['name'];\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t$schema[$i]['fields'][] = $field_name;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t$i++;\t\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t$i++;\r\n\t\t\t$schema[$i]['table'] = 'devices';\r\n\t\t\t$schema[$i]['parent'] = '';\r\n\t\t\t$schema[$i]['fields'][] = 'username';\r\n\t}\r\n\r\n//match the column names to the field names\r\n\tif (strlen($delimiter) > 0 && file_exists($_SESSION['file']) && $action != 'import') {\r\n\r\n\t\t//form to match the fields to the column names\r\n\t\t\trequire_once \"resources/header.php\";\r\n\r\n\t\t\techo \"<form action='device_imports.php' method='POST' enctype='multipart/form-data' name='frmUpload' onSubmit=''>\\n\";\r\n\t\t\techo \"<table width='100%' border='0' cellpadding='0' cellspacing='0'>\\n\";\r\n\r\n\t\t\techo \"\t<tr>\\n\";\r\n\t\t\techo \"\t<td valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\t\t\techo \"\t\t<b>\".$text['header-import'].\"</b><br />\\n\";\r\n\t\t\techo \"\t</td>\\n\";\r\n\t\t\techo \"\t<td valign='top' align='right'>\\n\";\r\n\t\t\techo \"\t\t<input type='button' class='btn' name='' alt='\".$text['button-back'].\"' onclick=\\\"window.location='devices.php'\\\" value='\".$text['button-back'].\"'>\\n\";\r\n\t\t\techo \"\t\t<input name='submit' type='submit' class='btn' id='import' value=\\\"\".$text['button-import'].\"\\\">\\n\";\r\n\t\t\techo \"\t</td>\\n\";\r\n\t\t\techo \"\t</tr>\\n\";\r\n\t\t\techo \"\t<tr>\\n\";\r\n\t\t\techo \"\t<td colspan='2' align='left'>\\n\";\r\n\t\t\techo \"\t\t\".$text['description-import'].\"\\n\";\r\n\t\t\techo \"\t</td>\\n\";\r\n\t\t\techo \"\t</tr>\\n\";\r\n\r\n\t\t\t//echo \"<tr>\\n\";\r\n\t\t\t//echo \"<td align='left' width='30%' nowrap='nowrap'><b>\".$text['header-import'].\"</b></td>\\n\";\r\n\t\t\t//echo \"<td width='70%' align='right'>\\n\";\r\n\t\t\t//echo \"\t<input type='button' class='btn' name='' alt='\".$text['button-back'].\"' onclick=\\\"window.location='devices.php'\\\" value='\".$text['button-back'].\"'>\\n\";\r\n\t\t\t//echo \"</td>\\n\";\r\n\t\t\t//echo \"</tr>\\n\";\r\n\r\n\t\t\t//loop through user columns\r\n\t\t\t$x = 0;\r\n\t\t\tforeach ($line_fields as $line_field) {\r\n\t\t\t\t$line_field = trim(trim($line_field), $enclosure);\r\n\t\t\t\techo \"<tr>\\n\";\r\n\t\t\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\t\t\t\t//echo \"    \".$text['label-zzz'].\"\\n\";\r\n\t\t\t\techo $line_field;\r\n\t\t\t\techo \"</td>\\n\";\r\n\t\t\t\techo \"<td class='vtable' align='left'>\\n\";\r\n\t\t\t\techo \"    \t\t\t<select class='formfld' style='' name='fields[$x]'>\\n\";\r\n\t\t\t\techo \"    \t\t\t<option value=''></option>\\n\";\r\n\t\t\t\tforeach($schema as $row) {\r\n\t\t\t\t\techo \"\t\t\t<optgroup label='\".$row['table'].\"'>\\n\";\r\n\t\t\t\t\tforeach($row['fields'] as $field) {\r\n\t\t\t\t\t\t$selected = '';\r\n\t\t\t\t\t\tif ($field == $line_field) {\r\n\t\t\t\t\t\t\t$selected = \"selected='selected'\";\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif ($field !== 'domain_uuid') {\r\n\t\t\t\t\t\t\techo \"    \t\t\t<option value='\".$row['table'].\".\".$field.\"' \".$selected.\">\".$field.\"</option>\\n\";\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\techo \"\t\t\t</optgroup>\\n\";\r\n\t\t\t\t}\r\n\t\t\t\techo \"    \t\t\t</select>\\n\";\r\n\t\t\t\t//echo \"<br />\\n\";\r\n\t\t\t\t//echo $text['description-zzz'].\"\\n\";\r\n\t\t\t\techo \"\t\t\t</td>\\n\";\r\n\t\t\t\techo \"\t\t</tr>\\n\";\r\n\t\t\t\t$x++;\r\n\t\t\t}\r\n\r\n\t\t\techo \"\t\t<tr>\\n\";\r\n\t\t\techo \"\t\t\t<td colspan='2' valign='top' align='right' nowrap='nowrap'>\\n\";\r\n\t\t\techo \"\t\t\t\t<input name='action' type='hidden' value='import'>\\n\";\r\n\t\t\techo \"\t\t\t\t<input name='from_row' type='hidden' value='$from_row'>\\n\";\r\n\t\t\techo \"\t\t\t\t<input name='data_delimiter' type='hidden' value='$delimiter'>\\n\";\r\n\t\t\techo \"\t\t\t\t<input name='data_enclosure' type='hidden' value='$enclosure'>\\n\";\r\n\t\t\techo \"\t\t\t\t<input type='submit' class='btn' id='import' value=\\\"\".$text['button-import'].\"\\\">\\n\";\r\n\t\t\techo \"\t\t\t</td>\\n\";\r\n\t\t\techo \"\t\t</tr>\\n\";\r\n\r\n\t\t\techo \"\t</table>\\n\";\r\n\t\t\techo \"</form>\\n\";\r\n\t\t\trequire_once \"resources/footer.php\";\r\n\r\n\t\t//normalize the column names\r\n\t\t\t//$line = strtolower($line);\r\n\t\t\t//$line = str_replace(\"-\", \"_\", $line);\r\n\t\t\t//$line = str_replace($delimiter.\"title\".$delimiter, $delimiter.\"contact_title\".$delimiter, $line);\r\n\t\t\t//$line = str_replace(\"firstname\", \"name_given\", $line);\r\n\t\t\t//$line = str_replace(\"lastname\", \"name_family\", $line);\r\n\t\t\t//$line = str_replace(\"company\", \"organization\", $line);\r\n\t\t\t//$line = str_replace(\"company\", \"contact_email\", $line);\r\n\r\n\t\t//end the script\r\n\t\t\texit;\r\n\t}\r\n\r\n//get the parent table\r\n\tfunction get_parent($schema,$table_name) {\r\n\t\tforeach ($schema as $row) {\r\n\t\t\tif ($row['table'] == $table_name) {\r\n\t\t\t\treturn $row['parent'];\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n//upload the csv\r\n\tif (file_exists($_SESSION['file']) && $action == 'import') {\r\n\r\n\t\t//form to match the fields to the column names\r\n\t\t\t//require_once \"resources/header.php\";\r\n\r\n\t\t//user selected fields\r\n\t\t\t$fields = $_POST['fields'];\r\n\t\t\t\r\n\t\t//set the domain_uuid\r\n\t\t\t$domain_uuid = $_SESSION['domain_uuid'];\r\n\r\n\t\t//get the users\r\n\t\t\t$sql = \"select * from v_users where domain_uuid = :domain_uuid \";\r\n\t\t\t$parameters['domain_uuid'] = $domain_uuid;\r\n\t\t\t$database = new database;\r\n\t\t\t$users = $database->select($sql, $parameters, 'all');\r\n\t\t\tunset($sql, $parameters);\r\n\r\n\t\t//get the contents of the csv file and convert them into an array\r\n\t\t\t$handle = @fopen($_SESSION['file'], \"r\");\r\n\t\t\tif ($handle) {\r\n\t\t\t\t//set the starting identifiers\r\n\t\t\t\t\t$row_id = 0;\r\n\t\t\t\t\t$row_number = 1;\r\n\r\n\t\t\t\t//loop through the array\r\n\t\t\t\t\twhile (($line = fgets($handle, 4096)) !== false) {\r\n\t\t\t\t\t\tif ($from_row <= $row_number) {\r\n\t\t\t\t\t\t\t//format the data\r\n\t\t\t\t\t\t\t\t$y = 0;\r\n\t\t\t\t\t\t\t\tforeach ($fields as $key => $value) {\r\n\t\t\t\t\t\t\t\t\t//get the line\r\n\t\t\t\t\t\t\t\t\t$result = str_getcsv($line, $delimiter, $enclosure);\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t//get the table and field name\r\n\t\t\t\t\t\t\t\t\t$field_array = explode(\".\",$value);\r\n\t\t\t\t\t\t\t\t\t$table_name = $field_array[0];\r\n\t\t\t\t\t\t\t\t\t$field_name = $field_array[1];\r\n\t\t\t\t\t\t\t\t\t//echo \"value: $value<br />\\n\";\r\n\t\t\t\t\t\t\t\t\t//echo \"table_name: $table_name<br />\\n\";\r\n\t\t\t\t\t\t\t\t\t//echo \"field_name: $field_name<br />\\n\";\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t//get the parent table name\r\n\t\t\t\t\t\t\t\t\t$parent = get_parent($schema, $table_name);\r\n\r\n\t\t\t\t\t\t\t\t\t//remove formatting from the phone number\r\n\t\t\t\t\t\t\t\t\tif ($field_name == \"phone_number\") {\r\n\t\t\t\t\t\t\t\t\t\t$result[$key] = preg_replace('{\\D}', '', $result[$key]);\r\n\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t//build the data array\r\n\t\t\t\t\t\t\t\t\tif (strlen($table_name) > 0) {\r\n\t\t\t\t\t\t\t\t\t\tif (strlen($parent) == 0) {\r\n\t\t\t\t\t\t\t\t\t\t\tif ($field_name != \"username\") {\r\n\t\t\t\t\t\t\t\t\t\t\t\t$array[$table_name][$row_id]['domain_uuid'] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t\t$array[$table_name][$row_id][$field_name] = $result[$key];\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\t\t\t\t$array[$parent][$row_id][$table_name][$y]['domain_uuid'] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t$array[$parent][$row_id][$table_name][$y][$field_name] = $result[$key];\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t\tif ($field_name == \"username\") {\r\n\t\t\t\t\t\t\t\t\t\t\tforeach ($users as $field) {\r\n\t\t\t\t\t\t\t\t\t\t\t\tif ($field['username'] == $result[$key]) {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[$table_name][$row_id]['device_user_uuid'] = $field['user_uuid'];\r\n\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t//process a chunk of the array\r\n\t\t\t\t\t\t\t\tif ($row_id === 1000) {\r\n\r\n\t\t\t\t\t\t\t\t\t//save to the data\r\n\t\t\t\t\t\t\t\t\t\t$database = new database;\r\n\t\t\t\t\t\t\t\t\t\t$database->app_name = 'devices';\r\n\t\t\t\t\t\t\t\t\t\t$database->app_uuid = '4efa1a1a-32e7-bf83-534b-6c8299958a8e';\r\n\t\t\t\t\t\t\t\t\t\t$database->save($array);\r\n\t\t\t\t\t\t\t\t\t\t//$message = $database->message;\r\n\r\n\t\t\t\t\t\t\t\t\t//clear the array\r\n\t\t\t\t\t\t\t\t\t\tunset($array);\r\n\r\n\t\t\t\t\t\t\t\t\t//set the row id back to 0\r\n\t\t\t\t\t\t\t\t\t\t$row_id = 0;\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t} //if ($from_row <= $row_id)\r\n\t\t\t\t\t\t$row_number++;\r\n\t\t\t\t\t\t$row_id++;\r\n\t\t\t\t\t} //end while\r\n\t\t\t\t\tfclose($handle);\r\n\r\n\t\t\t\t//debug info\r\n\t\t\t\t\t//echo \"<pre>\\n\";\r\n\t\t\t\t\t//print_r($array);\r\n\t\t\t\t\t//echo \"</pre>\\n\";\r\n\t\t\t\t\t//exit;\r\n\r\n\t\t\t\t//save to the data\r\n\t\t\t\t\tif (is_array($array)) {\r\n\t\t\t\t\t\t$database = new database;\r\n\t\t\t\t\t\t$database->app_name = 'devices';\r\n\t\t\t\t\t\t$database->app_uuid = '4efa1a1a-32e7-bf83-534b-6c8299958a8e';\r\n\t\t\t\t\t\t$database->save($array);\r\n\t\t\t\t\t\t//$message = $database->message;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t//send the redirect header\r\n\t\t\t\t\theader(\"Location: devices.php\");\r\n\t\t\t\t\treturn;\r\n\t\t\t}\r\n\t}\r\n\r\n//include the header\r\n\trequire_once \"resources/header.php\";\r\n\r\n//begin the content\r\n\techo \"<table width='100%' border='0' cellpadding='0' cellspacing='0'>\\n\";\r\n\techo \"\t<tr>\\n\";\r\n\techo \"\t<td valign='top' align='left' width='30%' nowrap='nowrap'>\\n\";\r\n\techo \"\t\t<b>\".$text['header-import'].\"</b><br />\\n\";\r\n\techo \"\t\t\".$text['description-import'].\"\\n\";\r\n\techo \"\t</td>\\n\";\r\n\techo \"\t<td valign='top' width='70%' align='right'>\\n\";\r\n\techo \"\t\t<input type='button' class='btn' name='' alt='\".$text['button-back'].\"' onclick=\\\"window.location='devices.php'\\\" value='\".$text['button-back'].\"'>\\n\";\r\n\t//echo \"\t\t<input name='submit' type='submit' class='btn' id='import' value=\\\"\".$text['button-import'].\"\\\">\\n\";\r\n\techo \"\t</td>\\n\";\r\n\techo \"\t</tr>\\n\";\r\n\techo \"</table>\";\r\n\r\n\techo \"<br />\\n\";\r\n\r\n\techo \"<form action='' method='POST' enctype='multipart/form-data' name='frmUpload' onSubmit=''>\\n\";\r\n\techo \"\t<table border='0' cellpadding='0' cellspacing='0' width='100%'>\\n\";\r\n\r\n\techo \"<tr>\\n\";\r\n\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\techo \"    \".$text['label-import_data'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"<td class='vtable' align='left'>\\n\";\r\n\techo \"    <textarea name='data' id='data' rows='7' class='formfld' style='width: 100%;' wrap='off'>$data</textarea>\\n\";\r\n\techo \"<br />\\n\";\r\n\techo $text['description-import_data'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"</tr>\\n\";\r\n\r\n\techo \"<tr>\\n\";\r\n\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\techo \"    \".$text['label-from_row'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"<td class='vtable' align='left'>\\n\";\r\n\techo \"\t\t<select class='formfld' name='from_row'>\\n\";\r\n\t$i=1;\r\n\twhile($i<=99) {\r\n\t\t$selected = ($i == $from_row) ? \"selected\" : null;\r\n\t\techo \"\t\t\t<option value='$i' \".$selected.\">$i</option>\\n\";\r\n\t\t$i++;\r\n\t}\r\n\techo \"\t\t</select>\\n\";\r\n\techo \"<br />\\n\";\r\n\techo $text['description-from_row'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"</tr>\\n\";\r\n\r\n\techo \"<tr>\\n\";\r\n\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\techo \"    \".$text['label-import_delimiter'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"<td class='vtable' align='left'>\\n\";\r\n\techo \"    <select class='formfld' style='width:40px;' name='data_delimiter'>\\n\";\r\n\techo \"    <option value=','>,</option>\\n\";\r\n\techo \"    <option value='|'>|</option>\\n\";\r\n\techo \"    </select>\\n\";\r\n\techo \"<br />\\n\";\r\n\techo $text['description-import_delimiter'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"</tr>\\n\";\r\n\r\n\techo \"<tr>\\n\";\r\n\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\techo \"    \".$text['label-import_enclosure'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"<td class='vtable' align='left'>\\n\";\r\n\techo \"    <select class='formfld' style='width:40px;' name='data_enclosure'>\\n\";\r\n\techo \"    <option value='\\\"'>\\\"</option>\\n\";\r\n\techo \"    <option value=''></option>\\n\";\r\n\techo \"    </select>\\n\";\r\n\techo \"<br />\\n\";\r\n\techo $text['description-import_enclosure'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"</tr>\\n\";\r\n\r\n\techo \"<tr>\\n\";\r\n\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\techo \"\t\t\t\".$text['label-import_file_upload'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"<td class='vtable' align='left'>\\n\";\r\n\techo \"\t\t\t<input name='ulfile' type='file' class='formfld fileinput' id='ulfile'>\\n\";\r\n\techo \"<br />\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"</tr>\\n\";\r\n\r\n\techo \"\t<tr>\\n\";\r\n\techo \"\t\t<td valign='bottom'>\\n\";\r\n\techo \"\t\t\t&nbsp;\\n\";\r\n\techo \"\t\t</td>\\n\";\r\n\techo \"\t\t<td valign='bottom' align='right' nowrap>\\n\";\r\n\techo \"\t\t\t<input name='type' type='hidden' value='csv'>\\n\";\r\n\techo \"\t\t\t<br />\\n\";\r\n\techo \"\t\t\t<input name='submit' type='submit' class='btn' id='import' value=\\\"\".$text['button-import'].\"\\\">\\n\";\r\n\techo \"\t\t</td>\\n\";\r\n\techo \"\t</tr>\\n\";\r\n\techo \"\t</table>\\n\";\r\n\techo \"<br><br>\";\r\n\techo \"</form>\";\r\n\r\n//include the footer\r\n\trequire_once \"resources/footer.php\";\r\n\r\n?>\r\n"], "filenames": ["app/devices/device_imports.php"], "buggy_code_start_loc": [366], "buggy_code_end_loc": [367], "fixing_code_start_loc": [366], "fixing_code_end_loc": [367], "type": "CWE-79", "message": "Cross Site Scriptiong (XSS) vulnerability exists in FusionPBX 4.5.7 allows remote malicious users to inject arbitrary web script or HTML via an unsanitized \"query_string\" variable in app\\devices\\device_imports.php.", "other": {"cve": {"id": "CVE-2020-21053", "sourceIdentifier": "cve@mitre.org", "published": "2021-05-20T15:15:07.517", "lastModified": "2021-05-25T20:03:03.863", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Cross Site Scriptiong (XSS) vulnerability exists in FusionPBX 4.5.7 allows remote malicious users to inject arbitrary web script or HTML via an unsanitized \"query_string\" variable in app\\devices\\device_imports.php."}, {"lang": "es", "value": "Una vulnerabilidad de tipo Cross Site Scripting (XSS) se presenta en FusionPBX versi\u00f3n 4.5.7, permite a usuarios maliciosos remotos inyectar un script web o HTML arbitrario por medio de una variable \"query_string\" no saneada en el archivo app\\devices\\device_imports.php"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:fusionpbx:fusionpbx:4.5.7:*:*:*:*:*:*:*", "matchCriteriaId": "3E46AEC6-69F7-4145-A334-FA97401DCE71"}]}]}], "references": [{"url": "https://github.com/fusionpbx/fusionpbx/commit/2ce613f1e9fe8ffab7a4cb9d1384444622285335", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://resp3ctblog.wordpress.com/2019/10/28/fusionpbx-xss-22/", "source": "cve@mitre.org", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/fusionpbx/fusionpbx/commit/2ce613f1e9fe8ffab7a4cb9d1384444622285335"}}