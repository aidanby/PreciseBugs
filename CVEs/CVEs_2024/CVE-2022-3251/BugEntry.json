{"buggy_code": ["![Minarca Logo](minarca-client/doc/_static/banner.png)\n\n<p align=\"center\">\n  <strong>\n    <a href=\"https://www.ikus-soft.com/en/minarca/\">website</a>\n    \u2022\n    <a href=\"https://www.ikus-soft.com/en/minarca/doc\">docs</a>\n    \u2022\n    <a href=\"https://groups.google.com/forum/#!forum/rdiffweb\">community</a>\n  </strong>\n</p>\n\n<p align=\"center\">\n  <a href=\"LICENSE\"><img alt=\"License\" src=\"https://img.shields.io/github/license/ikus060/minarca\"></a>\n  <a href=\"https://gitlab.com/ikus-soft/minarca/pipelines\"><img alt=\"Build\" src=\"https://gitlab.com/ikus-soft/minarca/badges/master/pipeline.svg\"></a>\n  <a href=\"https://sonar.ikus-soft.com/dashboard?id=minarca\"><img alt=\"Quality Gate Minarca\" src=\"https://sonar.ikus-soft.com/api/project_badges/measure?project=minarca&metric=alert_status\"></a>\n  <a href=\"https://sonar.ikus-soft.com/dashboard?id=minarca\"><img alt=\"Coverage\" src=\"https://sonar.ikus-soft.com/api/project_badges/measure?project=minarca&metric=coverage\"></a>\n</p>\n\n<h1 align=\"center\">\n  Welcome to Minarca Backup Software!\n</h1>\n\nMinarca is a **free and open-source** backup software providing end-to-end integration to put you in control of your backup strategy. This **Self-Hosted** software may suit the needs of service providers or small business. \n\n**Simple** to install, to configure and to manage, Minarca will not waste your time. Minarca makes user data easily accessible by providing a rich **web interface** to recover the files.\n\n**Minarca client** may be used to simplify the integration of new computers running **Windows or Linux Debian**. It's user interface and command line interface allow simple usage for **desktop users or headless servers**. Minarca also keep interoperability with legacy installation of [rdiff-backup](https://rdiff-backup.net/).\n\nBased on [rdiffweb](https://www.ikus-soft.com/en/rdiffweb/), **Minarca Server** may be used to browse, **restore your data easily** with a convenient web interface accessible from everywhere.\n\n## Getting started\n\nCheck how Minarca is working without installing the server. We have setup a testing environment for you. You may login to https://test.minarca.net/ using the default username / password: admin / admin123\n\nThen start a backup in few minutes by installing minarca client for [Windows](https://www.ikus-soft.com/archive/minarca/minarca-client_latest.exe) or [Linux/Debian](https://www.ikus-soft.com/archive/minarca/minarca-client_latest_all.deb).\n\n## Download & Install\n\n[Minarca Download Page](https://www.ikus-soft.com/en/minarca/download/)\n\n[Minarca Server Installation steps](https://www.ikus-soft.com/archive/minarca/doc/installation.html)\n\n[Minarca Agent Installation steps](https://www.ikus-soft.com/archive/minarca/doc/minarca-client.html#installation)\n\n# Support\n\n## Bug Reports\n\nBug reports should be reported on the Minarca development web site at https://github.com/ikus060/minarca/issues\n\n## Professional support\n\nProfessional support for Minarca is available by contacting [IKUS Software inc.](https://www.ikus-soft.com/en/support/#form).\n\n# About Minarca\n\nMinarca Server is written in Python and is released as open source project under the \nGNU AFFERO GENERAL PUBLIC LICENSE (AGPLv3). All source code and documentation are\nCopyright IKUS Software inc. <support@ikus-soft.com>\n\nMinarca Server is actively developed by [IKU Software inc.](https://ikus-soft.com)\nsince April 2015.\n\nThe Minarca Server source code is hosted on [Gitlab](https://gitlab.com/ikus-soft/minarca)\nand mirrored to [Github](https://github.com/ikus060/minarca).\n\nThe Minarca website is https://www.ikus-soft.com/en/minarca/.\n\n# Changelog\n\n## Next Release\n\n* Add Ubuntu Jammy support\n* Add Debian Bookworm support\n* Adjust `librsync` dependencies for release upgrade\n* Remove dependencies to unmaintained `snakeoil` library\n* Drop Ubuntu Hirsute & Impish (End-of-life)\n\n## 4.2.0 (2022-07-05)\n\n* Upgrade Rdiffweb to [v2.4.0](https://rdiffweb.org/blog/rdiffweb-s-blog-6/new-security-features-and-continuous-improvement-53)\n* Add support for Ubuntu Impish\n* Upgrade pyinstaller to 4.8 to improve command line usage and fixing issues with UTF8 #175\n* Allow usage of `--force` to force link event if client is already linked\n* Update French translation #178\n* Update Minarca documentation\n* Improve code quality with `black` and `isort`\n\n## 4.1.1 (2021-01-26)\n\n* Create apt configuration file only when file doesn't exists to avoid overwriting user's config\n\n## 4.1.0 (2022-01-18)\n\n* Server: Upgrade to Rdiffweb v2.3.9\n  * Fix `Chart.js` loading on Debian bullseye rdiffweb#164\n  * Improve LDAP authentication to lookup entire directory\n  * Fix usage of `--ldap-add-user-default-userroot` to avoid error related to wrong encoding\n  * Improve authentication mechanics\n  * Avoid raising an HTTP error 500 when login form receive invalid payload\n  * Mitigate open redirect vulnerability in login form\n  * Improve date parsing for `backup.log` to avoid printing exception in logs #170\n  * Return HTTP error 403 for invalid symlink to avoid returning a misleading HTTP 500 Server Error #168\n  * Show a user friendly error message when trying to create a new user with an existing username #169\n  * Handle repository without last-backup date during the notification process to ensure notifications are sent #171\n  * Replace CherryPy `storage_type` by `storage_class` to avoid warning in logs\n  * Update code to avoid deprecation warning where applicable\n  * Add Flake8 validation to improve code quality\n* Fix Windows application startup cause by stdout redirection #161\n* Upgrade OpenSSH to v8 to mitigate SSH error message #69 #65\n* Add a help button to redirect user to custom help form #145\n* Avoid printing `password:` twice during linking process with cli #162\n* Update user interface to enhance user experience #163\n* Check if a newer version is available on the startup #43\n* Adding Debian APT repository when installing from `.deb` package to automate upgrade #159\n* Avoid launching Minarca client from installers for Windows to mitigate permission issues while deleting Schedule Tasks #167\n* Improve `rdiff-backup` error handling to provide more guidance when SSH connection fail #158\n* Clear previous backup status when linking Minarca to a new server to better reflect the real status #168\n* Fix translation loading on MacOS and Windows #171\n* Upgrade pyinstaller to 4.7 to improve operating system integration #174\n* Remove Ubuntu Groovy support\n\n## v4.0.6\n\n* Make output log quiet when minarca is launch within a cronjob to avoid receiving email for successful execution\n\n## v4.0.5\n\n* Add python3-distutil as dependencies for Debian package to avoid exception when starting `minarca` without it\n\n## v4.0.4\n\n* Improve stderr redirection when rdiff-backup is launch to avoid leaking threads\n* Improve user interface testing\n\n## v4.0.1\n\n* Server: Upgrade to Rdiffweb v2.3.7\n  * Mitigate CSRF vulnerability using cookies with `SameSite=Lax`\n  * Mitigate CSRF vulnerability by validating the `Origin` header when a form is submited\n  * Improve usage of WTForm for all form validation\n* Generate docuemntation using Sphinx\n* Remove usage of PySimpleGUI library to create user interface #160 #147\n* Use ttkbootstrap to generate Tkinter Theme\n* Display current version in Minarca user interface\n\n## v4.0.0 (2021-09-20)\n\nThis new version include a new Minarca client with better integration with the operating system. This new version also include support for MacOS !\n\n * Server: Upgrade to Rdiffweb v2.3.4\n   * Skip email notification if `email-host` configuration is not provided rdiffweb#157\n   * Skip email notification when the new attribute value has the same value rdiffweb#159\n   * USE LDAP `mail` attribute when creating new user from LDAP directory rdiffweb#156\n   * Provide a new theme `blue` to match IKUS Soft colors rdiffweb#158\n   * Automatically update user's repository list based on user's home directory\n   * Update default `session-dir` location to `/var/lib/rdiffweb/session` to avoid using `/var/run` rdiffweb#148\n   * Improve timezone handling to display date with local timezone using javascript rdiffweb#143\n   * Improve charts by replacing d3js by chartkick rdiffweb#122\n   * Replace the status view by something meaningful with chartkick rdiffweb#122\n   * Provide Docker image with Rdiffweb `docker pull ikus060/rdiffweb` rdiffweb#55\n   * Fix file and folder sorting rdiffweb#143\n * Server: Improve creation of SSH Chroot jail by creating `/dev/null` in the jail \n * Server: Use new `blue` theme by default\n * Server: Fix installation stability on Debian Bullseye\n * Server: Update default minarca favicon\n * Server: Update french translatiom\n * Client: Re-implement minarca-client in python #87\n * Client: Sign MacOS Application Bundle #149\n * Client: Provide french translation\n\n## v3.9.0 (2021-05-17)\n\nThis new version include alot of changes from Rdiffweb release (https://www.ikus-soft.com/en/blog/2021-05-11-rdiffweb-v220/)\n\n * Server: Upgrade to Rdiffweb v2.2.0\n   * Use ConfigArgPare for configuration to support configuration file, environment variables and arguments to configure rdiffweb (rdiffweb#114)\n   * Fix cache in localization module\n   * Add `ldap-add-default-role` and `ldap-add-default-userroot` option to define default value for role and user root when creating user from LDAP (rdiffweb#125)\n   * Support PostgreSQL database by replacing our storage layer by SQLAlchemy rdiffweb#126\n   * Fix to retrieve user quota only for valid user_root (rdiffweb#135)\n   * Add option `disable-ssh-keys` to disable SSH Key management\n   * Use absolute URL everywhere\n   * Add support for `X-Forward-For`, `X-Forward-proto` and other reverse proxy header when generating absolute URL\n   * Drop Debian Strech support\n   * Implement a new background scheduler using apscheduler rdiffweb#82\n   * Use background job to send email notification to avoid blocking web page loading (rdiffweb#47)\n   * Use background job to delete repository to avoid blocking web page loading (rdiffweb#48)\n   * Allow deleting a specific file or folder from the history using `rdiff-backup-delete` (rdiffweb#128)\n   * Improve support for `session-dir` (rdiffweb#131)\n   * Add option `admin-password` to define administrator password for better security\n   * Improve performance of repository browsing \n   * Add a new view to display logs of a specific repository\n   * Allow downloading the log\n   * Define a default limit to graph statistics to make it display faster\n   * Fix `get-quota-cmd` option to properly return a value\n * Server: Migrate APT repository to `https://nexus.ikus-soft.com/repository/apt-release-buster`\n * Server: Transparently support `rdiff-backup` v1.2.8 and v2.0.5 (#134)\n * Server: Update `authorization_keys` file on restart\n * Server: Drop Debian Stretch support\n * Server: Add support for Debian Bullseye\n * Server: Provide default `session-dir` to persist user session between restart\n * Server: Upgrade Debian packaging\n * Server: Fix timezone detection in minarca-shell causing all date to be displayed as UTC in web interface.\n * Client: Support `rdiff-backup` v1.2.8 or v2.0.5\n * Client: Improve command line help\n * Client: Improve detection of already running process to avoid exeution of multiple minarca client instance\n * Client: Support repository name starting with number\n\n## v3.8.0 (2021-02-17)\n\nThis new version bring two major features Minarca: A user quota management ready for production and a more secure minarca-shell to handle incoming SSH connection.\n\n * Server: Upgrade to rdiffweb v2.1.0\n    * Re-implement logic to update repositories views to remove duplicates and avoid nesting repo. #107\n    * Handle elapsed time of days in the graph. Thanks [Nathaniel van Diepen](https://github.com/Eeems) contributions.\n    * Rebrand all link to ikus-soft.com\n    * Update documentation to install rdiffweb\n    * Remove obsolete minify dependency\n    * Drop support for python2\n    * Provide null translation if translation catalogues are not found\n    * Pass a LANG environment variable to rdiff-backup restore process to fix encoding issue #112\n    * Remove obsolete python shebang\n    * Remove execution bit (+x) on python modules\n    * Provide `--help` and `--version` on `rdiffweb` executable\n    * Improve cherrypy version detection\n    * Do not update translation files (.mo) during build\n    * Debian package: Remove dh-systemd from Debian build dependencies (https://bugs.debian.org/871312we)\n    * Improve Quota management:\n      * `QuotaSetCmd`, `QuotaGetCmd` and `QuotaUsedCmd` options could be used to customize how to set the quota for your environment.\n      * Display user's quota in User View\n      * Display user's quota in Admin View\n      * Allow admin to update user quota from Admin View when `QuotaSetCmd` is defined.\n      * Allow admin to define user quota using human readable value (e.g.: GiB, TiB, etc.)\n      * Improve logging around quota management\n    * Improve robustness when service is starting\n    * Improve robustness when repository has wrong permission defined (e.g.: when some files not readable)\n    * Add user id in Admin view\n    * Replace `UserObject(1)` by the actual username in log file to improve debugging\n * Server: Drops support for python 2.7\n * Server: Improve ZFS Quota Management to use project quota. #95\n * Server: Add minarca-quota-api and minarca-shell logs to admin view #126\n * Server: Adjust the logging format to be similar in all components\n * Server: Re-impleent minarca-shell in pure python to be more integrated with rdiffweb/minarca\n * Server: Update authorized_keys when server get restarted to reflect any config or database change #127\n * Server: Increase security of SSH connexion by user user namespace to create chroot jail #121\n * Server: Define `$HOME` when creating user namespace to work arround python calling `getpwuid()`\n * Client: Improve error message when Scheduled Task refused to be created in Windows\n * Client: Fix `minarca` command line parsing for include|exclude #125 #120\n * Client: Adjust the logging format to be similar to server log\n * Client: Create log file to /var/log/minarca.log when the `uid` is root\n * Doc: Update installation steps rdiffweb/#109\n * Doc: Provide mode architectural details #70\n\n## v3.7.0 (2020-06-24)\n\nThis new release officially adds the installation of Minarca using an APT repository for Debian Stretch and Debian Buster.\nTake a look at the updated [installation steps](doc/installation.md). Quickly, the installation become easy as `curl https://www.ikus-soft.com/archive/minarca/get-minarca.sh | sh -`.\n\n * Server: Upgrade to rdiffweb v1.5.0\n     * Change formatting of Last Backup date for \"Updated 3 weeks ago\" to ease the readability\n     * Add support for Debian Bullseye\n     * Add support for Python 3.8 (rdiffweb#104)\n     * Add warning in the users list view when a root directory is invalid (rdiffweb#30)\n     * Add options to control search depthness (rdiffweb#1)\n     * Print a warning in the log when the \"DefaultTheme\" value is not valid (rdiffweb#90)\n * Client: Upgrade to NSIS v3 installers to provide a better integration for Windows 10 \n * Client: Icons are up to date with better resolutions\n * Client: Provide more details about the error when the first backup is failing during linking\n * Doc: Replace PDSL by IKUS Software Inc. in licensing and documentation\n\n## v3.6.0 (2020-05-20)\n\n * Server: Upgrade to rdiffweb v1.4.0\n     * Fix lookup of executable rdiff-backup and rdiffweb-restore to search in current virtualenv first\n     * Fix repository view when multiple repo paths are conflicting\n     * Fix logging of rdiffweb-restore subprocess\n     * Fix single repository discovery when a user's home is a rdiff-backup repository\n     * [SPONSORED] Add a new setting at the user level to define the user's role. Admin,\n       Maintainer and User. Admin are allowed to do everything. Maintainer are\n       allowed to browse and delete repo. Users are only allowed to browse. #94\n     * Add \"Powered by\" in the web interface footer #91\n     * Display a nice error message when trying to delete admin user #93\n     * Introduce usage of wtforms and flash in admin users for better form validation. #96 #97\n * Server: Fix default permission during installation on Debian for /etc/minarca, /var/log/minarca, /backups/ to define the proper owner and restrict permission.\n * Client: Clarify the application purpose for the user by renaming the link to \"Minarca Backup\"\n * Start publishing DEB into [APT repositories](https://nexus.ikus-soft.com/#browse/search/apt=format%3Dapt%20AND%20version%3D3.6.0*)\n * [SPONSORED] Server: Allow redirection of http://localhost:8080/help to a custom help page for your business\n * [SPONSORED] Client: Redirect the help button (?) to your business custom help page\n * Client: Minor changes to the layout to improve user's usability\n * Update French translation\n\n## v3.5.0 (2020-04-08)\n\nThis release focus mostly on providing a Debian Buster compatible packages. A good effort was made to provide an easy-to-use package for Debian and making sure it's well tested in an automated way to avoid regression and speedup further release.\n\n * Server: Upgrade the rdiffweb v1.3.1\n     * Restore file and folder in a subprocess to make the download start faster\n     * Fix encoding of archive on Python3.6 (CentOS 7) by using PAX format\n     * Add support to restore files and folders using rdiff-backup2\n     * Remove obsolete dependencies `pysqlite2`\n     * Fix issue creating duplicate entries of repository in database\n     * Enforce password encryption by using {SSHA} scheme\n * Server: Remove `python-pysqlite2` from debian package dependencies\n * Server: Fix to make sure the `minarca-server` service unit is enabled and started after installation.\n * Server: Force owner and group recursively on Minarca's folder during installation\n * Client: Add username and hostname in the status info to ease debugging\n * Documentation: Add information about [how to run minarca-client when users are not logged](doc/minarca-client.md#why-is-my-backup-not-running-)\n * Documentation: Provide default user and password to login after [installation](doc/installation.md#install-minarca-server)\n\n## v3.4.3 (2020-03-08)\n\nContinue to stabilize the previous release with little bug fixes and minor improvement for the end user.\n\n * Server: Upgrade the rdiffweb v1.2.2\n     * Enhance the repository to invite users to refresh the repository when the view is empty.\n     * Deprecate support for cherrypy 4, 5, 6 and 7\n     * Improve loading of repository data (cache status and entries)\n     * Restore compatibility with SQLite 3.7 (CentOS7)\n * Client: Linux - Raise an error when the patterns don't match any files instead of silently succeeding without backuping anything.\n * Client: Linux - Move logs to /var/log when running as root.\n * Client: Linux - Silently ignore error when failing to inhibit on Linux when d-bus is not available.\n * Client: Linux - From command line adds a \"continue logging...\" to help the user know where to look for logs.\n * Client: Linux - When running from cron do not print \"continue logging...\" to avoid sending email to root user.\n * Client: Windows - Install Java 8 Update 241 when Java is not available.\n * Client: Windows - Enable TLS1.2 during installation to allow download and installation of Java\n * Client: When linking for the first time, make sure to create a scheduled task even when the repository already exists.\n\n## v3.4.1 (2020-02-08)\n\nLittle bug fixes following the previous release.\n\n * Server: Upgrade the rdiffweb v1.2.1\n     * Fix 404 error when trying to access other users repo as admin\n     * Fix logging format for cherrypy logs to matches rdiffweb format\n     * Add log rotation by default\n * Server: Enforce permissions on `/etc/minarca` and `/var/log/minarca` to reduce visibility to only minarca user\n * Client: Fix cryptic character installation due to bad encoding for French locale\n * Client: Fix year in about dialog for French locale\n * Client: Document the `--force` command line option for `link` operation\n * Client: Relocate the configuration under `/etc/minarca` when ran as root\n * Client: Add default symlink to `minarca` in `/usr/sbin/` to make is part of PATH for root user\n\n## v3.4.0 (2020-01-30)\n\n * Server: Upgrade to rdiffweb v1.2.0\n     * Add explicit testing for Debian Stretch & Buster\n     * Change the persistence layers\n       * Minimize number of SQL queries\n       * Add object lazy loading\n       * Add object data caching\n     * Fix bugs with SQLite <= 3.16 (Debian Stretch)\n * Server: Add port to EmailHost` by default\n * Client: Windows - To avoid unexpected interruption inhibits computers from sleep during backup.\n * Client: Windows - Replace usage of `tasklist.exe` by JNA calls to improve portability and responsiveness\n * Client: Windows - Allow the installer to be silent using `minarca-client-install.exe /S`\n * Client: Windows - For portability downgrade OpenSSH client to 32-bit version\n * Client: Windows - To reduce package footprints, remove unused text files from Windows installation.\n * Client: Linux- To avoid unexpected interruption inhibits computers from sleep during backup on Gnome Desktop using D-Bus calls.\n * Client: to improve SSH handshake, enforce client to use public key authentication \n * Automate testing of Windows \n * Update documentation\n\n## v3.3.0 (2019-11-06)\n\n * Server: Upgrade to rdiffweb v1.1.0\n\t * Change repository URL to username/repo-name - in preparation to add ACL in future release\n\t * Add repository view to allow administrator to browse, restore, edit other user repositories\n\t * Add system information (version, configuration, operating system info, etc.) to the admin area\n\t * Add server logs to admin area (rdiff-backup.log & rdiff-backup-access.log)\n\t * Improve the user's view layout\n\t * Check local database credentials before LDAP credentials\n\t * Reduce footprint of confirmation dialog box\n\t * Reduce code smells reported by Sonarqube\n\t * Improve main menu structure\n\t * Change default login page headline\n\t * Support Jinja2 version >= 2.10 (add integration test for 2.6 to 2.10)\n\t * Update documentation\n * Server: Add `tail` packages as a dependency\n * Server: Replace headline on the login page, adding link to website, documentation and community\n * Client: Re-create scheduled task on startup if it was removed by the user\n * Client: Upgrade apache client version to v4.3.6 mitigate security risk repported by Github vulnerability scan\n * Client: Fix default minarca launcher to call `minarcaui` instead or `minarca`\n * Client & Server: Allow backup over non-default SSH port (22)\n \n## Server v3.0.1 - Bug fixes (2019-10-04)\n\n * Upgrade to rdiffweb v1.0.3.\n * Update the authorized_keys when user's home directory get updated.\n * Force user's home directory owner and group. Allow minarca web interface to run as root.\n * Minarca-shell: Fix repository name validation.\n * Minarca-shell: Add SUDO_OWNERSHIP to sets the owner and group. Allow better quota management.\n * Pipeline: Add integration testing with server and client linking.\n\n## Client v3.2.4 (2019-10-01)\n\n* Client: Update french translation\n\n## Client v3.2.3 (2019-09-25)\n\n* Client: Add \"cron\" as dependencies in debian package\n\n## Client v3.2.2 (2019-09-15)\n\n* Client: Add \"java-headless\" and ssh-client as dependencies in debian package\n* Client: Remove dependencies to AWT (to work in headless mode)\n* Client: Bump JRE version to 1.8 in Windows installer\n\n## Server v3.0.0 / Client v3.2.1 - First public version (2019-09-14)\n\n * Support cherrypy v16\n * Provide debian packages\n * Manage SSH Keys for minarca user\n * Provide minarca-shell as an SSH entrypoint\n * Improve SSH server security\n * Add /api/ to be used by minarca-client\n * Update Minarca icon\n * Client: Fix pid verification to avoid multiple instance to be running\n \n## Client v3.2.0 - First public release (2019-09-12)\n\n* Client: Provide debian packages\n* Client: Replace Form request by API calls\n* Client: Make it work with minarca-shell\n* Client: Use patches version of rdiff-backup 1.2.8\n* Client: Replace proprietary licence by GPLv3\n* Client: Replace Minarca icon\n* Client: Improve configuration UI\n* Client: Improve linking UI\n* Client: Update default ignored patterns\n* Client: Update french translation\n* Client: Add command line interface \n* Client: Verify if process is running using pid file on all platform\n\n# Related projects\n\n* [rdiffweb](https://www.ikus-soft.com/en/rdiffweb/): web interface \n* [rdiff-backup](https://rdiff-backup.net/): core engine used to run the backup\n\n", "# -*- coding: utf-8 -*-\n#\n# Minarca server\n#\n# Copyright (C) 2020 IKUS Software inc. All rights reserved.\n# IKUS Software inc. PROPRIETARY/CONFIDENTIAL.\n# Use is subject to license terms.\n\"\"\"\nCreated on Jan 23, 2016\n\n@author: Patrik Dufresne <patrik@ikus-soft.com>\n\"\"\"\n\nimport grp\nimport os\nimport pwd\nimport unittest\nfrom io import open\nfrom unittest.mock import ANY\n\nimport cherrypy\nimport pkg_resources\nimport responses\nfrom rdiffweb.core.store import ADMIN_ROLE\n\nimport minarca_server\nimport minarca_server.tests\n\n\nclass MinarcaPluginTest(minarca_server.tests.AbstractMinarcaTest):\n\n    login = True\n\n    def _add_user(self, username=None, email=None, password=None, user_root=None, is_admin=None):\n        b = {}\n        b['action'] = 'add'\n        if username is not None:\n            b['username'] = username\n        if email is not None:\n            b['email'] = email\n        if password is not None:\n            b['password'] = password\n        if user_root is not None:\n            b['user_root'] = user_root\n        if is_admin is not None:\n            b['role'] = str(ADMIN_ROLE)\n        self.getPage(\"/admin/users/\", method='POST', body=b)\n\n    def test_add_user_without_user_root(self):\n        # Given a minarca base dir\n        self.assertIsNotNone(self.app.cfg.minarca_user_base_dir)\n        # When adding a new user without specific user_root\n        self._add_user(\"mtest1\", None, \"mtest1\", None, False)\n        self.assertInBody(\"User added successfully.\")\n        # Then user root directory is defined within the base dir\n        user = self.app.store.get_user('mtest1')\n        self.assertEqual(os.path.join(self.base_dir, 'mtest1'), user.user_root)\n\n    def test_add_user_with_user_root(self):\n        # Given a minarca base dir\n        self.assertIsNotNone(self.app.cfg.minarca_user_base_dir)\n        # When adding a new user with a specific user_root\n        self._add_user(\"mtest2\", None, \"mtest2\", \"/home/mtest2\", False)\n        self.assertInBody(\"User added successfully.\")\n        # Then user root is updated to be within the base dir\n        user = self.app.store.get_user('mtest2')\n        self.assertEqual(os.path.join(self.base_dir, 'mtest2'), user.user_root)\n\n    def test_default_config(self):\n        self.assertEqual(\"blue\", self.app.cfg.default_theme)\n        self.assertIn(\"minarca.ico\", self.app.cfg.favicon)\n        self.assertEqual(\"Minarca\", self.app.cfg.footer_name)\n        self.assertEqual(\"Minarca\", self.app.cfg.header_name)\n        self.assertIn(\"minarca_22.png\", self.app.cfg.header_logo)\n        self.assertEqual(\"/var/log/minarca/access.log\", self.app.cfg.log_access_file)\n        # log_file get overriden by testcase. So dont validate it.\n        self.assertIsNotNone(self.app.cfg.log_file)\n        self.assertIn('minarca', self.app.cfg.welcome_msg[''])\n        self.assertIn('minarca', self.app.cfg.welcome_msg['fr'])\n\n    def test_get_api_minarca(self):\n        self.getPage(\"/api/minarca\")\n        # Check version\n        self.assertInBody('version')\n        # Check remoteHost\n        self.assertInBody('remotehost')\n        self.assertInBody('127.0.0.1')\n        # Check identity\n        self.assertInBody('identity')\n\n    def test_get_api_minarca_with_reverse_proxy(self):\n\n        # When behind an apache reverse proxy, minarca server should make use\n        # of the Header to determine the public hostname provided.\n        headers = [\n            ('X-Forwarded-For', '10.255.1.106'),\n            ('X-Forwarded-Host', 'sestican.patrikdufresne.com'),\n            ('X-Forwarded-Server', '10.255.1.106'),\n        ]\n\n        self.getPage(\"/api/minarca\", headers=headers)\n        self.assertInBody('remotehost')\n        self.assertInBody('sestican.patrikdufresne.com')\n\n    def test_get_location(self):\n        \"\"\"\n        Given an empty minarca_quota_api_url\n        When location page get request\n        Then the disk usage is repported using the default behaviour.\n        \"\"\"\n        # Make sure disk usage fall back to default behaviour.\n        self.getPage('/')\n        self.assertStatus(200)\n        self.assertInBody('Usage')\n\n    def test_get_disk_usage(self):\n        # Given an empty minarca_quota_api_url\n        # When disk usage get requested\n        userobj = self.app.store.add_user('bob')\n        # Then the disk usage is repported using the default behaviour.\n        self.assertIsNotNone(userobj.disk_quota)\n        self.assertIsNotNone(userobj.disk_usage)\n\n    def test_set_disk_quota(self):\n        # Given an empty minarca_quota_api_url\n        # When trying to set disk quota\n        userobj = self.app.store.add_user('bob')\n        # Then setting disk_quota does nothing\n        userobj.disk_quota = 12345\n\n\nclass MinarcaAdminLogView(minarca_server.tests.AbstractMinarcaTest):\n\n    default_config = {\n        'minarca-quota-api-url': 'http://localhost:8081',\n    }\n\n    login = True\n\n    @classmethod\n    def setup_class(cls):\n        super().setup_class()\n        with open(os.path.join(cls.base_dir, 'server.log'), 'w') as f:\n            f.write('data')\n        with open(os.path.join(cls.base_dir, 'shell.log'), 'w') as f:\n            f.write('data')\n        with open(os.path.join(cls.base_dir, 'quota-api.log'), 'w') as f:\n            f.write('data')\n\n    def test_adminview(self):\n        self.getPage('/admin/logs')\n        self.assertStatus(200)\n        self.assertInBody('server.log', 'server log should be in admin view')\n        self.assertInBody('shell.log', 'minarca-shell log should be in admin view')\n        self.assertInBody('quota-api.log', 'minarca-quota-api log should be in admin view')\n        self.assertNotInBody('Error getting file content')\n\n\nclass MinarcaPluginTestWithQuotaAPI(minarca_server.tests.AbstractMinarcaTest):\n\n    default_config = {\n        'minarca-quota-api-url': 'http://minarca:secret@localhost:8081/',\n    }\n\n    @responses.activate\n    @unittest.mock.patch('minarca_server.plugins.minarca.subprocess.check_output')\n    def test_set_disk_quota(self, mock_check_output):\n        # Given a valid use from database\n        userobj = self.app.store.add_user('bob')\n        # Given a mock quota-api\n        responses.add(\n            responses.POST,\n            \"http://minarca:secret@localhost:8081/quota/\" + str(userobj.userid),\n            json={\"avail\": 2147483648, \"used\": 0, \"size\": 2147483648},\n        )\n        # When setting a new user quota\n        quota = cherrypy.engine.publish('set_disk_quota', userobj, quota=1234567)\n        self.assertEqual([1234567], quota)\n        # Then webservice was called\n        self.assertEqual(1, len(responses.calls))\n        # Then subprocess get called twice\n        self.assertEqual(2, mock_check_output.call_count, \"subprocess.check_output should be called\")\n        mock_check_output.assert_any_call(['/usr/bin/chattr', '-R', '+P', ANY], stderr=-2)\n        mock_check_output.assert_any_call(['/usr/bin/chattr', '-R', '-p', str(userobj.userid), ANY], stderr=-2)\n\n    @responses.activate\n    def test_update_userquota_401(self):\n        userobj = self.app.store.add_user('bob')\n        # Checks if exception is raised when authentication is failing.\n        responses.add(responses.POST, \"http://minarca:secret@localhost:8081/quota/\" + str(userobj.userid), status=401)\n        # Make sure an exception is raised.\n        quota = cherrypy.engine.publish('set_disk_quota', userobj, quota=1234567)\n        self.assertEqual([0], quota)\n\n    @responses.activate\n    def test_get_disk_quota(self):\n        \"\"\"\n        Check if value is available.\n        \"\"\"\n        # Make sure an exception is raised.\n        userobj = self.app.store.add_user('bob')\n        # Checks if exception is raised when authentication is failing.\n        responses.add(\n            responses.GET,\n            \"http://minarca:secret@localhost:8081/quota/\" + str(userobj.userid),\n            body='{\"used\": 1234, \"size\": 2147483648}',\n        )\n        # When querying the disk quota\n        quota = cherrypy.engine.publish('get_disk_quota', userobj)\n        # Then the quota is returned\n        self.assertEqual([2147483648], quota)\n\n    @responses.activate\n    def test_get_disk_usage(self):\n        \"\"\"\n        Check if value is available.\n        \"\"\"\n        # Make sure an exception is raised.\n        userobj = self.app.store.add_user('bob')\n        # Checks if exception is raised when authentication is failing.\n        responses.add(\n            responses.GET,\n            \"http://minarca:secret@localhost:8081/quota/\" + str(userobj.userid),\n            body='{\"used\": 1234, \"size\": 2147483648}',\n        )\n        # When querying the disk quota\n        quota = cherrypy.engine.publish('get_disk_usage', userobj)\n        # Then the quota is returned\n        self.assertEqual([1234], quota)\n\n\nclass MinarcaPluginTestWithOwnerAndGroup(minarca_server.tests.AbstractMinarcaTest):\n\n    default_config = {\n        'MinarcaUserDirOwner': pwd.getpwuid(os.getuid()).pw_name,\n        'MinarcaUserDirGroup': grp.getgrgid(os.getgid()).gr_name,\n    }\n\n    def assertAuthorizedKeys(self, expected):\n        filename = os.path.join(self.base_dir, '.ssh', 'authorized_keys')\n        with open(filename, 'r', encoding='utf-8') as f:\n            data = f.read()\n        self.assertEqual(data, expected)\n\n    def test_update_authorized_keys(self):\n        cherrypy.minarca._update_authorized_keys()\n\n    def test_add_key(self):\n        # Read the key from a file\n        filename = pkg_resources.resource_filename(__name__, 'test_publickey_ssh_rsa.pub')\n        with open(filename, 'r', encoding='utf8') as f:\n            key = f.readline()\n\n        # Add the key to the user.\n        userobj = self.app.store.add_user('testuser')\n        userobj.add_authorizedkey(key)\n        user_root = userobj.user_root\n\n        # Validate\n        self.assertAuthorizedKeys(\n            '''command=\"export MINARCA_USERNAME='testuser' MINARCA_USER_ROOT='%s';/opt/minarca-server/bin/minarca-shell\",no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDDYeMPTCnRLFaLeSzsn++RD5jwuuez65GXrt9g7RYUqJka66cn7zHUhjDWx15fyEM3ikHGbmmWEP2csq11YCtvaTaz2GAnwcFNdt2NF0KGHMbE56Xq0eCkj1FCait/UyRBqkaFItYAoBdj4War9Xt+S5sV8qc5/TqTeku4Kg6ZBJRFCDHy6nR8Xf+tXiBrlfCnXvxamDI5kFP0B+npuBv+M4TjKFvwn5W8zYPPTEznilWnGvJFS71XwsOD/yHBGQb/Jz87aazNAeCznZRAJxfecJhgeChGZcGnXRAAdEeMbRyilYWaNquIpwrbNFElFlVf41EoDBk6woB8TeG0XFfz ikus060@ikus060-t530\\n'''\n            % user_root\n        )\n\n        # Update user's home\n        user_root = os.path.join(self.base_dir, 'testing')\n        userobj.user_root = user_root\n\n        # Validate\n        self.assertAuthorizedKeys(\n            '''command=\"export MINARCA_USERNAME='testuser' MINARCA_USER_ROOT='%s';/opt/minarca-server/bin/minarca-shell\",no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDDYeMPTCnRLFaLeSzsn++RD5jwuuez65GXrt9g7RYUqJka66cn7zHUhjDWx15fyEM3ikHGbmmWEP2csq11YCtvaTaz2GAnwcFNdt2NF0KGHMbE56Xq0eCkj1FCait/UyRBqkaFItYAoBdj4War9Xt+S5sV8qc5/TqTeku4Kg6ZBJRFCDHy6nR8Xf+tXiBrlfCnXvxamDI5kFP0B+npuBv+M4TjKFvwn5W8zYPPTEznilWnGvJFS71XwsOD/yHBGQb/Jz87aazNAeCznZRAJxfecJhgeChGZcGnXRAAdEeMbRyilYWaNquIpwrbNFElFlVf41EoDBk6woB8TeG0XFfz ikus060@ikus060-t530\\n'''\n            % user_root\n        )\n\n        # Deleting the user should delete it's keys\n        userobj.delete()\n\n        # Validate\n        self.assertAuthorizedKeys('')\n", "#!/usr/bin/env python\n# -*- coding: utf-8 -*-\n#\n# Minarca Server\n#\n# Copyright (C) 2020 IKUS Software inc. All rights reserved.\n# IKUS Software inc. PROPRIETARY/CONFIDENTIAL.\n# Use is subject to license terms.\n\n\nimport setuptools\n\nsetuptools.setup(\n    name=\"minarca_server\",\n    use_scm_version={\"root\": \"..\", \"relative_to\": __file__},\n    description=\"Minarca Web Server\",\n    long_description=\"Minarca is a self-hosted open source data backup software that allows you to manage your computer and server backups for free from a direct online accessible centralized view of your data with easy retrieval in case of displacement, loss or breakage.\",\n    author=\"IKUS Software inc.\",\n    author_email=\"support@ikus-soft.com\",\n    maintainer=\"IKUS Software inc.\",\n    maintainer_email=\"support@ikus-soft.com\",\n    url=\"https://www.ikus-soft.com/en/minarca/\",\n    include_package_data=True,\n    python_requires=\">=3.5\",\n    packages=[\"minarca_server\", \"minarca_server.plugins\", \"minarca_server.core\"],\n    setup_requires=[\n        \"setuptools_scm>=5.0.1\",\n    ],\n    install_requires=[\n        \"rdiffweb==2.4.0\",\n        \"cherrypy>=18.0.0\",\n        \"requests\",\n        \"tzlocal~=2.0\",\n    ],\n    # required packages for build process\n    extras_require={\n        \"test\": [\n            \"responses\",\n            \"pytest\",\n        ]\n    },\n    # Declare entry point\n    entry_points={\n        \"console_scripts\": [\n            \"minarca-server = minarca_server.main:main\",\n            \"minarca-shell = minarca_server.shell:main\",\n        ]\n    },\n)\n"], "fixing_code": ["![Minarca Logo](minarca-client/doc/_static/banner.png)\n\n<p align=\"center\">\n  <strong>\n    <a href=\"https://www.ikus-soft.com/en/minarca/\">website</a>\n    \u2022\n    <a href=\"https://www.ikus-soft.com/en/minarca/doc\">docs</a>\n    \u2022\n    <a href=\"https://groups.google.com/forum/#!forum/rdiffweb\">community</a>\n  </strong>\n</p>\n\n<p align=\"center\">\n  <a href=\"LICENSE\"><img alt=\"License\" src=\"https://img.shields.io/github/license/ikus060/minarca\"></a>\n  <a href=\"https://gitlab.com/ikus-soft/minarca/pipelines\"><img alt=\"Build\" src=\"https://gitlab.com/ikus-soft/minarca/badges/master/pipeline.svg\"></a>\n  <a href=\"https://sonar.ikus-soft.com/dashboard?id=minarca\"><img alt=\"Quality Gate Minarca\" src=\"https://sonar.ikus-soft.com/api/project_badges/measure?project=minarca&metric=alert_status\"></a>\n  <a href=\"https://sonar.ikus-soft.com/dashboard?id=minarca\"><img alt=\"Coverage\" src=\"https://sonar.ikus-soft.com/api/project_badges/measure?project=minarca&metric=coverage\"></a>\n</p>\n\n<h1 align=\"center\">\n  Welcome to Minarca Backup Software!\n</h1>\n\nMinarca is a **free and open-source** backup software providing end-to-end integration to put you in control of your backup strategy. This **Self-Hosted** software may suit the needs of service providers or small business. \n\n**Simple** to install, to configure and to manage, Minarca will not waste your time. Minarca makes user data easily accessible by providing a rich **web interface** to recover the files.\n\n**Minarca client** may be used to simplify the integration of new computers running **Windows or Linux Debian**. It's user interface and command line interface allow simple usage for **desktop users or headless servers**. Minarca also keep interoperability with legacy installation of [rdiff-backup](https://rdiff-backup.net/).\n\nBased on [rdiffweb](https://www.ikus-soft.com/en/rdiffweb/), **Minarca Server** may be used to browse, **restore your data easily** with a convenient web interface accessible from everywhere.\n\n## Getting started\n\nCheck how Minarca is working without installing the server. We have setup a testing environment for you. You may login to https://test.minarca.net/ using the default username / password: admin / admin123\n\nThen start a backup in few minutes by installing minarca client for [Windows](https://www.ikus-soft.com/archive/minarca/minarca-client_latest.exe) or [Linux/Debian](https://www.ikus-soft.com/archive/minarca/minarca-client_latest_all.deb).\n\n## Download & Install\n\n[Minarca Download Page](https://www.ikus-soft.com/en/minarca/download/)\n\n[Minarca Server Installation steps](https://www.ikus-soft.com/archive/minarca/doc/installation.html)\n\n[Minarca Agent Installation steps](https://www.ikus-soft.com/archive/minarca/doc/minarca-client.html#installation)\n\n# Support\n\n## Bug Reports\n\nBug reports should be reported on the Minarca development web site at https://github.com/ikus060/minarca/issues\n\n## Professional support\n\nProfessional support for Minarca is available by contacting [IKUS Software inc.](https://www.ikus-soft.com/en/support/#form).\n\n# About Minarca\n\nMinarca Server is written in Python and is released as open source project under the \nGNU AFFERO GENERAL PUBLIC LICENSE (AGPLv3). All source code and documentation are\nCopyright IKUS Software inc. <support@ikus-soft.com>\n\nMinarca Server is actively developed by [IKU Software inc.](https://ikus-soft.com)\nsince April 2015.\n\nThe Minarca Server source code is hosted on [Gitlab](https://gitlab.com/ikus-soft/minarca)\nand mirrored to [Github](https://github.com/ikus060/minarca).\n\nThe Minarca website is https://www.ikus-soft.com/en/minarca/.\n\n# Changelog\n\n## 4.2.2 (2022-09-16)\n\nThis releases include a security fix. If you are using an earlier version, you should upgrade to this release immediately.\n\n* Upgrade Rdiffweb to 2.4.5\n  * Mitigate CSRF on repository deletion and user deletion. [CVE-2022-3232](https://nvd.nist.gov/vuln/detail/CVE-2022-3232)\n  * Use `X-Real-IP` to identify client IP address to mitigate Brute-Force attack\n  * Mitigate CSRF in profile's SSH Keys [CVE-2022-3221](https://nvd.nist.gov/vuln/detail/CVE-2022-3221)\n  * Use 'Secure' Attribute with Sensitive Cookie in HTTPS Session. [CVE-2022-3174](https://nvd.nist.gov/vuln/detail/CVE-2022-3174)\n  * Avoid leakage of the stack trace in the default error page. [CVE-2022-3175](https://nvd.nist.gov/vuln/detail/CVE-2022-3175)\n  * Enforce minimum and maximum password length [CVE-2022-3175](https://nvd.nist.gov/vuln/detail/CVE-2022-3179)\n  * Add Clickjacking Defense [CVE-2022-3167](https://nvd.nist.gov/vuln/detail/CVE-2022-3167)\n\n## 4.2.1 (2022-07-15)\n\n* Add Ubuntu Jammy support\n* Add Debian Bookworm support\n* Adjust `librsync` dependencies for release upgrade\n* Remove dependencies to unmaintained `snakeoil` library\n* Drop Ubuntu Hirsute & Impish (End-of-life)\n\n## 4.2.0 (2022-07-05)\n\n* Upgrade Rdiffweb to [v2.4.0](https://rdiffweb.org/blog/rdiffweb-s-blog-6/new-security-features-and-continuous-improvement-53)\n* Add support for Ubuntu Impish\n* Upgrade pyinstaller to 4.8 to improve command line usage and fixing issues with UTF8 #175\n* Allow usage of `--force` to force link event if client is already linked\n* Update French translation #178\n* Update Minarca documentation\n* Improve code quality with `black` and `isort`\n\n## 4.1.1 (2021-01-26)\n\n* Create apt configuration file only when file doesn't exists to avoid overwriting user's config\n\n## 4.1.0 (2022-01-18)\n\n* Server: Upgrade to Rdiffweb v2.3.9\n  * Fix `Chart.js` loading on Debian bullseye rdiffweb#164\n  * Improve LDAP authentication to lookup entire directory\n  * Fix usage of `--ldap-add-user-default-userroot` to avoid error related to wrong encoding\n  * Improve authentication mechanics\n  * Avoid raising an HTTP error 500 when login form receive invalid payload\n  * Mitigate open redirect vulnerability in login form\n  * Improve date parsing for `backup.log` to avoid printing exception in logs #170\n  * Return HTTP error 403 for invalid symlink to avoid returning a misleading HTTP 500 Server Error #168\n  * Show a user friendly error message when trying to create a new user with an existing username #169\n  * Handle repository without last-backup date during the notification process to ensure notifications are sent #171\n  * Replace CherryPy `storage_type` by `storage_class` to avoid warning in logs\n  * Update code to avoid deprecation warning where applicable\n  * Add Flake8 validation to improve code quality\n* Fix Windows application startup cause by stdout redirection #161\n* Upgrade OpenSSH to v8 to mitigate SSH error message #69 #65\n* Add a help button to redirect user to custom help form #145\n* Avoid printing `password:` twice during linking process with cli #162\n* Update user interface to enhance user experience #163\n* Check if a newer version is available on the startup #43\n* Adding Debian APT repository when installing from `.deb` package to automate upgrade #159\n* Avoid launching Minarca client from installers for Windows to mitigate permission issues while deleting Schedule Tasks #167\n* Improve `rdiff-backup` error handling to provide more guidance when SSH connection fail #158\n* Clear previous backup status when linking Minarca to a new server to better reflect the real status #168\n* Fix translation loading on MacOS and Windows #171\n* Upgrade pyinstaller to 4.7 to improve operating system integration #174\n* Remove Ubuntu Groovy support\n\n## v4.0.6\n\n* Make output log quiet when minarca is launch within a cronjob to avoid receiving email for successful execution\n\n## v4.0.5\n\n* Add python3-distutil as dependencies for Debian package to avoid exception when starting `minarca` without it\n\n## v4.0.4\n\n* Improve stderr redirection when rdiff-backup is launch to avoid leaking threads\n* Improve user interface testing\n\n## v4.0.1\n\n* Server: Upgrade to Rdiffweb v2.3.7\n  * Mitigate CSRF vulnerability using cookies with `SameSite=Lax`\n  * Mitigate CSRF vulnerability by validating the `Origin` header when a form is submited\n  * Improve usage of WTForm for all form validation\n* Generate docuemntation using Sphinx\n* Remove usage of PySimpleGUI library to create user interface #160 #147\n* Use ttkbootstrap to generate Tkinter Theme\n* Display current version in Minarca user interface\n\n## v4.0.0 (2021-09-20)\n\nThis new version include a new Minarca client with better integration with the operating system. This new version also include support for MacOS !\n\n * Server: Upgrade to Rdiffweb v2.3.4\n   * Skip email notification if `email-host` configuration is not provided rdiffweb#157\n   * Skip email notification when the new attribute value has the same value rdiffweb#159\n   * USE LDAP `mail` attribute when creating new user from LDAP directory rdiffweb#156\n   * Provide a new theme `blue` to match IKUS Soft colors rdiffweb#158\n   * Automatically update user's repository list based on user's home directory\n   * Update default `session-dir` location to `/var/lib/rdiffweb/session` to avoid using `/var/run` rdiffweb#148\n   * Improve timezone handling to display date with local timezone using javascript rdiffweb#143\n   * Improve charts by replacing d3js by chartkick rdiffweb#122\n   * Replace the status view by something meaningful with chartkick rdiffweb#122\n   * Provide Docker image with Rdiffweb `docker pull ikus060/rdiffweb` rdiffweb#55\n   * Fix file and folder sorting rdiffweb#143\n * Server: Improve creation of SSH Chroot jail by creating `/dev/null` in the jail \n * Server: Use new `blue` theme by default\n * Server: Fix installation stability on Debian Bullseye\n * Server: Update default minarca favicon\n * Server: Update french translatiom\n * Client: Re-implement minarca-client in python #87\n * Client: Sign MacOS Application Bundle #149\n * Client: Provide french translation\n\n## v3.9.0 (2021-05-17)\n\nThis new version include alot of changes from Rdiffweb release (https://www.ikus-soft.com/en/blog/2021-05-11-rdiffweb-v220/)\n\n * Server: Upgrade to Rdiffweb v2.2.0\n   * Use ConfigArgPare for configuration to support configuration file, environment variables and arguments to configure rdiffweb (rdiffweb#114)\n   * Fix cache in localization module\n   * Add `ldap-add-default-role` and `ldap-add-default-userroot` option to define default value for role and user root when creating user from LDAP (rdiffweb#125)\n   * Support PostgreSQL database by replacing our storage layer by SQLAlchemy rdiffweb#126\n   * Fix to retrieve user quota only for valid user_root (rdiffweb#135)\n   * Add option `disable-ssh-keys` to disable SSH Key management\n   * Use absolute URL everywhere\n   * Add support for `X-Forward-For`, `X-Forward-proto` and other reverse proxy header when generating absolute URL\n   * Drop Debian Strech support\n   * Implement a new background scheduler using apscheduler rdiffweb#82\n   * Use background job to send email notification to avoid blocking web page loading (rdiffweb#47)\n   * Use background job to delete repository to avoid blocking web page loading (rdiffweb#48)\n   * Allow deleting a specific file or folder from the history using `rdiff-backup-delete` (rdiffweb#128)\n   * Improve support for `session-dir` (rdiffweb#131)\n   * Add option `admin-password` to define administrator password for better security\n   * Improve performance of repository browsing \n   * Add a new view to display logs of a specific repository\n   * Allow downloading the log\n   * Define a default limit to graph statistics to make it display faster\n   * Fix `get-quota-cmd` option to properly return a value\n * Server: Migrate APT repository to `https://nexus.ikus-soft.com/repository/apt-release-buster`\n * Server: Transparently support `rdiff-backup` v1.2.8 and v2.0.5 (#134)\n * Server: Update `authorization_keys` file on restart\n * Server: Drop Debian Stretch support\n * Server: Add support for Debian Bullseye\n * Server: Provide default `session-dir` to persist user session between restart\n * Server: Upgrade Debian packaging\n * Server: Fix timezone detection in minarca-shell causing all date to be displayed as UTC in web interface.\n * Client: Support `rdiff-backup` v1.2.8 or v2.0.5\n * Client: Improve command line help\n * Client: Improve detection of already running process to avoid exeution of multiple minarca client instance\n * Client: Support repository name starting with number\n\n## v3.8.0 (2021-02-17)\n\nThis new version bring two major features Minarca: A user quota management ready for production and a more secure minarca-shell to handle incoming SSH connection.\n\n * Server: Upgrade to rdiffweb v2.1.0\n    * Re-implement logic to update repositories views to remove duplicates and avoid nesting repo. #107\n    * Handle elapsed time of days in the graph. Thanks [Nathaniel van Diepen](https://github.com/Eeems) contributions.\n    * Rebrand all link to ikus-soft.com\n    * Update documentation to install rdiffweb\n    * Remove obsolete minify dependency\n    * Drop support for python2\n    * Provide null translation if translation catalogues are not found\n    * Pass a LANG environment variable to rdiff-backup restore process to fix encoding issue #112\n    * Remove obsolete python shebang\n    * Remove execution bit (+x) on python modules\n    * Provide `--help` and `--version` on `rdiffweb` executable\n    * Improve cherrypy version detection\n    * Do not update translation files (.mo) during build\n    * Debian package: Remove dh-systemd from Debian build dependencies (https://bugs.debian.org/871312we)\n    * Improve Quota management:\n      * `QuotaSetCmd`, `QuotaGetCmd` and `QuotaUsedCmd` options could be used to customize how to set the quota for your environment.\n      * Display user's quota in User View\n      * Display user's quota in Admin View\n      * Allow admin to update user quota from Admin View when `QuotaSetCmd` is defined.\n      * Allow admin to define user quota using human readable value (e.g.: GiB, TiB, etc.)\n      * Improve logging around quota management\n    * Improve robustness when service is starting\n    * Improve robustness when repository has wrong permission defined (e.g.: when some files not readable)\n    * Add user id in Admin view\n    * Replace `UserObject(1)` by the actual username in log file to improve debugging\n * Server: Drops support for python 2.7\n * Server: Improve ZFS Quota Management to use project quota. #95\n * Server: Add minarca-quota-api and minarca-shell logs to admin view #126\n * Server: Adjust the logging format to be similar in all components\n * Server: Re-impleent minarca-shell in pure python to be more integrated with rdiffweb/minarca\n * Server: Update authorized_keys when server get restarted to reflect any config or database change #127\n * Server: Increase security of SSH connexion by user user namespace to create chroot jail #121\n * Server: Define `$HOME` when creating user namespace to work arround python calling `getpwuid()`\n * Client: Improve error message when Scheduled Task refused to be created in Windows\n * Client: Fix `minarca` command line parsing for include|exclude #125 #120\n * Client: Adjust the logging format to be similar to server log\n * Client: Create log file to /var/log/minarca.log when the `uid` is root\n * Doc: Update installation steps rdiffweb/#109\n * Doc: Provide mode architectural details #70\n\n## v3.7.0 (2020-06-24)\n\nThis new release officially adds the installation of Minarca using an APT repository for Debian Stretch and Debian Buster.\nTake a look at the updated [installation steps](doc/installation.md). Quickly, the installation become easy as `curl https://www.ikus-soft.com/archive/minarca/get-minarca.sh | sh -`.\n\n * Server: Upgrade to rdiffweb v1.5.0\n     * Change formatting of Last Backup date for \"Updated 3 weeks ago\" to ease the readability\n     * Add support for Debian Bullseye\n     * Add support for Python 3.8 (rdiffweb#104)\n     * Add warning in the users list view when a root directory is invalid (rdiffweb#30)\n     * Add options to control search depthness (rdiffweb#1)\n     * Print a warning in the log when the \"DefaultTheme\" value is not valid (rdiffweb#90)\n * Client: Upgrade to NSIS v3 installers to provide a better integration for Windows 10 \n * Client: Icons are up to date with better resolutions\n * Client: Provide more details about the error when the first backup is failing during linking\n * Doc: Replace PDSL by IKUS Software Inc. in licensing and documentation\n\n## v3.6.0 (2020-05-20)\n\n * Server: Upgrade to rdiffweb v1.4.0\n     * Fix lookup of executable rdiff-backup and rdiffweb-restore to search in current virtualenv first\n     * Fix repository view when multiple repo paths are conflicting\n     * Fix logging of rdiffweb-restore subprocess\n     * Fix single repository discovery when a user's home is a rdiff-backup repository\n     * [SPONSORED] Add a new setting at the user level to define the user's role. Admin,\n       Maintainer and User. Admin are allowed to do everything. Maintainer are\n       allowed to browse and delete repo. Users are only allowed to browse. #94\n     * Add \"Powered by\" in the web interface footer #91\n     * Display a nice error message when trying to delete admin user #93\n     * Introduce usage of wtforms and flash in admin users for better form validation. #96 #97\n * Server: Fix default permission during installation on Debian for /etc/minarca, /var/log/minarca, /backups/ to define the proper owner and restrict permission.\n * Client: Clarify the application purpose for the user by renaming the link to \"Minarca Backup\"\n * Start publishing DEB into [APT repositories](https://nexus.ikus-soft.com/#browse/search/apt=format%3Dapt%20AND%20version%3D3.6.0*)\n * [SPONSORED] Server: Allow redirection of http://localhost:8080/help to a custom help page for your business\n * [SPONSORED] Client: Redirect the help button (?) to your business custom help page\n * Client: Minor changes to the layout to improve user's usability\n * Update French translation\n\n## v3.5.0 (2020-04-08)\n\nThis release focus mostly on providing a Debian Buster compatible packages. A good effort was made to provide an easy-to-use package for Debian and making sure it's well tested in an automated way to avoid regression and speedup further release.\n\n * Server: Upgrade the rdiffweb v1.3.1\n     * Restore file and folder in a subprocess to make the download start faster\n     * Fix encoding of archive on Python3.6 (CentOS 7) by using PAX format\n     * Add support to restore files and folders using rdiff-backup2\n     * Remove obsolete dependencies `pysqlite2`\n     * Fix issue creating duplicate entries of repository in database\n     * Enforce password encryption by using {SSHA} scheme\n * Server: Remove `python-pysqlite2` from debian package dependencies\n * Server: Fix to make sure the `minarca-server` service unit is enabled and started after installation.\n * Server: Force owner and group recursively on Minarca's folder during installation\n * Client: Add username and hostname in the status info to ease debugging\n * Documentation: Add information about [how to run minarca-client when users are not logged](doc/minarca-client.md#why-is-my-backup-not-running-)\n * Documentation: Provide default user and password to login after [installation](doc/installation.md#install-minarca-server)\n\n## v3.4.3 (2020-03-08)\n\nContinue to stabilize the previous release with little bug fixes and minor improvement for the end user.\n\n * Server: Upgrade the rdiffweb v1.2.2\n     * Enhance the repository to invite users to refresh the repository when the view is empty.\n     * Deprecate support for cherrypy 4, 5, 6 and 7\n     * Improve loading of repository data (cache status and entries)\n     * Restore compatibility with SQLite 3.7 (CentOS7)\n * Client: Linux - Raise an error when the patterns don't match any files instead of silently succeeding without backuping anything.\n * Client: Linux - Move logs to /var/log when running as root.\n * Client: Linux - Silently ignore error when failing to inhibit on Linux when d-bus is not available.\n * Client: Linux - From command line adds a \"continue logging...\" to help the user know where to look for logs.\n * Client: Linux - When running from cron do not print \"continue logging...\" to avoid sending email to root user.\n * Client: Windows - Install Java 8 Update 241 when Java is not available.\n * Client: Windows - Enable TLS1.2 during installation to allow download and installation of Java\n * Client: When linking for the first time, make sure to create a scheduled task even when the repository already exists.\n\n## v3.4.1 (2020-02-08)\n\nLittle bug fixes following the previous release.\n\n * Server: Upgrade the rdiffweb v1.2.1\n     * Fix 404 error when trying to access other users repo as admin\n     * Fix logging format for cherrypy logs to matches rdiffweb format\n     * Add log rotation by default\n * Server: Enforce permissions on `/etc/minarca` and `/var/log/minarca` to reduce visibility to only minarca user\n * Client: Fix cryptic character installation due to bad encoding for French locale\n * Client: Fix year in about dialog for French locale\n * Client: Document the `--force` command line option for `link` operation\n * Client: Relocate the configuration under `/etc/minarca` when ran as root\n * Client: Add default symlink to `minarca` in `/usr/sbin/` to make is part of PATH for root user\n\n## v3.4.0 (2020-01-30)\n\n * Server: Upgrade to rdiffweb v1.2.0\n     * Add explicit testing for Debian Stretch & Buster\n     * Change the persistence layers\n       * Minimize number of SQL queries\n       * Add object lazy loading\n       * Add object data caching\n     * Fix bugs with SQLite <= 3.16 (Debian Stretch)\n * Server: Add port to EmailHost` by default\n * Client: Windows - To avoid unexpected interruption inhibits computers from sleep during backup.\n * Client: Windows - Replace usage of `tasklist.exe` by JNA calls to improve portability and responsiveness\n * Client: Windows - Allow the installer to be silent using `minarca-client-install.exe /S`\n * Client: Windows - For portability downgrade OpenSSH client to 32-bit version\n * Client: Windows - To reduce package footprints, remove unused text files from Windows installation.\n * Client: Linux- To avoid unexpected interruption inhibits computers from sleep during backup on Gnome Desktop using D-Bus calls.\n * Client: to improve SSH handshake, enforce client to use public key authentication \n * Automate testing of Windows \n * Update documentation\n\n## v3.3.0 (2019-11-06)\n\n * Server: Upgrade to rdiffweb v1.1.0\n\t * Change repository URL to username/repo-name - in preparation to add ACL in future release\n\t * Add repository view to allow administrator to browse, restore, edit other user repositories\n\t * Add system information (version, configuration, operating system info, etc.) to the admin area\n\t * Add server logs to admin area (rdiff-backup.log & rdiff-backup-access.log)\n\t * Improve the user's view layout\n\t * Check local database credentials before LDAP credentials\n\t * Reduce footprint of confirmation dialog box\n\t * Reduce code smells reported by Sonarqube\n\t * Improve main menu structure\n\t * Change default login page headline\n\t * Support Jinja2 version >= 2.10 (add integration test for 2.6 to 2.10)\n\t * Update documentation\n * Server: Add `tail` packages as a dependency\n * Server: Replace headline on the login page, adding link to website, documentation and community\n * Client: Re-create scheduled task on startup if it was removed by the user\n * Client: Upgrade apache client version to v4.3.6 mitigate security risk repported by Github vulnerability scan\n * Client: Fix default minarca launcher to call `minarcaui` instead or `minarca`\n * Client & Server: Allow backup over non-default SSH port (22)\n \n## Server v3.0.1 - Bug fixes (2019-10-04)\n\n * Upgrade to rdiffweb v1.0.3.\n * Update the authorized_keys when user's home directory get updated.\n * Force user's home directory owner and group. Allow minarca web interface to run as root.\n * Minarca-shell: Fix repository name validation.\n * Minarca-shell: Add SUDO_OWNERSHIP to sets the owner and group. Allow better quota management.\n * Pipeline: Add integration testing with server and client linking.\n\n## Client v3.2.4 (2019-10-01)\n\n* Client: Update french translation\n\n## Client v3.2.3 (2019-09-25)\n\n* Client: Add \"cron\" as dependencies in debian package\n\n## Client v3.2.2 (2019-09-15)\n\n* Client: Add \"java-headless\" and ssh-client as dependencies in debian package\n* Client: Remove dependencies to AWT (to work in headless mode)\n* Client: Bump JRE version to 1.8 in Windows installer\n\n## Server v3.0.0 / Client v3.2.1 - First public version (2019-09-14)\n\n * Support cherrypy v16\n * Provide debian packages\n * Manage SSH Keys for minarca user\n * Provide minarca-shell as an SSH entrypoint\n * Improve SSH server security\n * Add /api/ to be used by minarca-client\n * Update Minarca icon\n * Client: Fix pid verification to avoid multiple instance to be running\n \n## Client v3.2.0 - First public release (2019-09-12)\n\n* Client: Provide debian packages\n* Client: Replace Form request by API calls\n* Client: Make it work with minarca-shell\n* Client: Use patches version of rdiff-backup 1.2.8\n* Client: Replace proprietary licence by GPLv3\n* Client: Replace Minarca icon\n* Client: Improve configuration UI\n* Client: Improve linking UI\n* Client: Update default ignored patterns\n* Client: Update french translation\n* Client: Add command line interface \n* Client: Verify if process is running using pid file on all platform\n\n# Related projects\n\n* [rdiffweb](https://www.ikus-soft.com/en/rdiffweb/): web interface \n* [rdiff-backup](https://rdiff-backup.net/): core engine used to run the backup\n\n", "# -*- coding: utf-8 -*-\n#\n# Minarca server\n#\n# Copyright (C) 2020 IKUS Software inc. All rights reserved.\n# IKUS Software inc. PROPRIETARY/CONFIDENTIAL.\n# Use is subject to license terms.\n\"\"\"\nCreated on Jan 23, 2016\n\n@author: Patrik Dufresne <patrik@ikus-soft.com>\n\"\"\"\n\nimport grp\nimport os\nimport pwd\nimport unittest\nfrom io import open\nfrom unittest.mock import ANY\n\nimport cherrypy\nimport pkg_resources\nimport responses\nfrom rdiffweb.core.store import ADMIN_ROLE\n\nimport minarca_server\nimport minarca_server.tests\n\n\nclass MinarcaPluginTest(minarca_server.tests.AbstractMinarcaTest):\n\n    login = True\n\n    def _add_user(self, username=None, email=None, password=None, user_root=None, is_admin=None):\n        b = {}\n        b['action'] = 'add'\n        if username is not None:\n            b['username'] = username\n        if email is not None:\n            b['email'] = email\n        if password is not None:\n            b['password'] = password\n        if user_root is not None:\n            b['user_root'] = user_root\n        if is_admin is not None:\n            b['role'] = str(ADMIN_ROLE)\n        self.getPage(\"/admin/users/\", method='POST', body=b)\n\n    def test_add_user_without_user_root(self):\n        # Given a minarca base dir\n        self.assertIsNotNone(self.app.cfg.minarca_user_base_dir)\n        # When adding a new user without specific user_root\n        self._add_user(\"mtest1\", None, \"password\", None, False)\n        self.assertInBody(\"User added successfully.\")\n        # Then user root directory is defined within the base dir\n        user = self.app.store.get_user('mtest1')\n        self.assertEqual(os.path.join(self.base_dir, 'mtest1'), user.user_root)\n\n    def test_add_user_with_user_root(self):\n        # Given a minarca base dir\n        self.assertIsNotNone(self.app.cfg.minarca_user_base_dir)\n        # When adding a new user with a specific user_root\n        self._add_user(\"mtest2\", None, \"password\", \"/home/mtest2\", False)\n        self.assertInBody(\"User added successfully.\")\n        # Then user root is updated to be within the base dir\n        user = self.app.store.get_user('mtest2')\n        self.assertEqual(os.path.join(self.base_dir, 'mtest2'), user.user_root)\n\n    def test_default_config(self):\n        self.assertEqual(\"blue\", self.app.cfg.default_theme)\n        self.assertIn(\"minarca.ico\", self.app.cfg.favicon)\n        self.assertEqual(\"Minarca\", self.app.cfg.footer_name)\n        self.assertEqual(\"Minarca\", self.app.cfg.header_name)\n        self.assertIn(\"minarca_22.png\", self.app.cfg.header_logo)\n        self.assertEqual(\"/var/log/minarca/access.log\", self.app.cfg.log_access_file)\n        # log_file get overriden by testcase. So dont validate it.\n        self.assertIsNotNone(self.app.cfg.log_file)\n        self.assertIn('minarca', self.app.cfg.welcome_msg[''])\n        self.assertIn('minarca', self.app.cfg.welcome_msg['fr'])\n\n    def test_get_api_minarca(self):\n        self.getPage(\"/api/minarca\")\n        # Check version\n        self.assertInBody('version')\n        # Check remoteHost\n        self.assertInBody('remotehost')\n        self.assertInBody('127.0.0.1')\n        # Check identity\n        self.assertInBody('identity')\n\n    def test_get_api_minarca_with_reverse_proxy(self):\n\n        # When behind an apache reverse proxy, minarca server should make use\n        # of the Header to determine the public hostname provided.\n        headers = [\n            ('X-Forwarded-For', '10.255.1.106'),\n            ('X-Forwarded-Host', 'sestican.patrikdufresne.com'),\n            ('X-Forwarded-Server', '10.255.1.106'),\n        ]\n\n        self.getPage(\"/api/minarca\", headers=headers)\n        self.assertInBody('remotehost')\n        self.assertInBody('sestican.patrikdufresne.com')\n\n    def test_get_location(self):\n        \"\"\"\n        Given an empty minarca_quota_api_url\n        When location page get request\n        Then the disk usage is repported using the default behaviour.\n        \"\"\"\n        # Make sure disk usage fall back to default behaviour.\n        self.getPage('/')\n        self.assertStatus(200)\n        self.assertInBody('Usage')\n\n    def test_get_disk_usage(self):\n        # Given an empty minarca_quota_api_url\n        # When disk usage get requested\n        userobj = self.app.store.add_user('bob')\n        # Then the disk usage is repported using the default behaviour.\n        self.assertIsNotNone(userobj.disk_quota)\n        self.assertIsNotNone(userobj.disk_usage)\n\n    def test_set_disk_quota(self):\n        # Given an empty minarca_quota_api_url\n        # When trying to set disk quota\n        userobj = self.app.store.add_user('bob')\n        # Then setting disk_quota does nothing\n        userobj.disk_quota = 12345\n\n\nclass MinarcaAdminLogView(minarca_server.tests.AbstractMinarcaTest):\n\n    default_config = {\n        'minarca-quota-api-url': 'http://localhost:8081',\n    }\n\n    login = True\n\n    @classmethod\n    def setup_class(cls):\n        super().setup_class()\n        with open(os.path.join(cls.base_dir, 'server.log'), 'w') as f:\n            f.write('data')\n        with open(os.path.join(cls.base_dir, 'shell.log'), 'w') as f:\n            f.write('data')\n        with open(os.path.join(cls.base_dir, 'quota-api.log'), 'w') as f:\n            f.write('data')\n\n    def test_adminview(self):\n        self.getPage('/admin/logs')\n        self.assertStatus(200)\n        self.assertInBody('server.log', 'server log should be in admin view')\n        self.assertInBody('shell.log', 'minarca-shell log should be in admin view')\n        self.assertInBody('quota-api.log', 'minarca-quota-api log should be in admin view')\n        self.assertNotInBody('Error getting file content')\n\n\nclass MinarcaPluginTestWithQuotaAPI(minarca_server.tests.AbstractMinarcaTest):\n\n    default_config = {\n        'minarca-quota-api-url': 'http://minarca:secret@localhost:8081/',\n    }\n\n    @responses.activate\n    @unittest.mock.patch('minarca_server.plugins.minarca.subprocess.check_output')\n    def test_set_disk_quota(self, mock_check_output):\n        # Given a valid use from database\n        userobj = self.app.store.add_user('bob')\n        # Given a mock quota-api\n        responses.add(\n            responses.POST,\n            \"http://minarca:secret@localhost:8081/quota/\" + str(userobj.userid),\n            json={\"avail\": 2147483648, \"used\": 0, \"size\": 2147483648},\n        )\n        # When setting a new user quota\n        quota = cherrypy.engine.publish('set_disk_quota', userobj, quota=1234567)\n        self.assertEqual([1234567], quota)\n        # Then webservice was called\n        self.assertEqual(1, len(responses.calls))\n        # Then subprocess get called twice\n        self.assertEqual(2, mock_check_output.call_count, \"subprocess.check_output should be called\")\n        mock_check_output.assert_any_call(['/usr/bin/chattr', '-R', '+P', ANY], stderr=-2)\n        mock_check_output.assert_any_call(['/usr/bin/chattr', '-R', '-p', str(userobj.userid), ANY], stderr=-2)\n\n    @responses.activate\n    def test_update_userquota_401(self):\n        userobj = self.app.store.add_user('bob')\n        # Checks if exception is raised when authentication is failing.\n        responses.add(responses.POST, \"http://minarca:secret@localhost:8081/quota/\" + str(userobj.userid), status=401)\n        # Make sure an exception is raised.\n        quota = cherrypy.engine.publish('set_disk_quota', userobj, quota=1234567)\n        self.assertEqual([0], quota)\n\n    @responses.activate\n    def test_get_disk_quota(self):\n        \"\"\"\n        Check if value is available.\n        \"\"\"\n        # Make sure an exception is raised.\n        userobj = self.app.store.add_user('bob')\n        # Checks if exception is raised when authentication is failing.\n        responses.add(\n            responses.GET,\n            \"http://minarca:secret@localhost:8081/quota/\" + str(userobj.userid),\n            body='{\"used\": 1234, \"size\": 2147483648}',\n        )\n        # When querying the disk quota\n        quota = cherrypy.engine.publish('get_disk_quota', userobj)\n        # Then the quota is returned\n        self.assertEqual([2147483648], quota)\n\n    @responses.activate\n    def test_get_disk_usage(self):\n        \"\"\"\n        Check if value is available.\n        \"\"\"\n        # Make sure an exception is raised.\n        userobj = self.app.store.add_user('bob')\n        # Checks if exception is raised when authentication is failing.\n        responses.add(\n            responses.GET,\n            \"http://minarca:secret@localhost:8081/quota/\" + str(userobj.userid),\n            body='{\"used\": 1234, \"size\": 2147483648}',\n        )\n        # When querying the disk quota\n        quota = cherrypy.engine.publish('get_disk_usage', userobj)\n        # Then the quota is returned\n        self.assertEqual([1234], quota)\n\n\nclass MinarcaPluginTestWithOwnerAndGroup(minarca_server.tests.AbstractMinarcaTest):\n\n    default_config = {\n        'MinarcaUserDirOwner': pwd.getpwuid(os.getuid()).pw_name,\n        'MinarcaUserDirGroup': grp.getgrgid(os.getgid()).gr_name,\n    }\n\n    def assertAuthorizedKeys(self, expected):\n        filename = os.path.join(self.base_dir, '.ssh', 'authorized_keys')\n        with open(filename, 'r', encoding='utf-8') as f:\n            data = f.read()\n        self.assertEqual(data, expected)\n\n    def test_update_authorized_keys(self):\n        cherrypy.minarca._update_authorized_keys()\n\n    def test_add_key(self):\n        # Read the key from a file\n        filename = pkg_resources.resource_filename(__name__, 'test_publickey_ssh_rsa.pub')\n        with open(filename, 'r', encoding='utf8') as f:\n            key = f.readline()\n\n        # Add the key to the user.\n        userobj = self.app.store.add_user('testuser')\n        userobj.add_authorizedkey(key)\n        user_root = userobj.user_root\n\n        # Validate\n        self.assertAuthorizedKeys(\n            '''command=\"export MINARCA_USERNAME='testuser' MINARCA_USER_ROOT='%s';/opt/minarca-server/bin/minarca-shell\",no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDDYeMPTCnRLFaLeSzsn++RD5jwuuez65GXrt9g7RYUqJka66cn7zHUhjDWx15fyEM3ikHGbmmWEP2csq11YCtvaTaz2GAnwcFNdt2NF0KGHMbE56Xq0eCkj1FCait/UyRBqkaFItYAoBdj4War9Xt+S5sV8qc5/TqTeku4Kg6ZBJRFCDHy6nR8Xf+tXiBrlfCnXvxamDI5kFP0B+npuBv+M4TjKFvwn5W8zYPPTEznilWnGvJFS71XwsOD/yHBGQb/Jz87aazNAeCznZRAJxfecJhgeChGZcGnXRAAdEeMbRyilYWaNquIpwrbNFElFlVf41EoDBk6woB8TeG0XFfz ikus060@ikus060-t530\\n'''\n            % user_root\n        )\n\n        # Update user's home\n        user_root = os.path.join(self.base_dir, 'testing')\n        userobj.user_root = user_root\n\n        # Validate\n        self.assertAuthorizedKeys(\n            '''command=\"export MINARCA_USERNAME='testuser' MINARCA_USER_ROOT='%s';/opt/minarca-server/bin/minarca-shell\",no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDDYeMPTCnRLFaLeSzsn++RD5jwuuez65GXrt9g7RYUqJka66cn7zHUhjDWx15fyEM3ikHGbmmWEP2csq11YCtvaTaz2GAnwcFNdt2NF0KGHMbE56Xq0eCkj1FCait/UyRBqkaFItYAoBdj4War9Xt+S5sV8qc5/TqTeku4Kg6ZBJRFCDHy6nR8Xf+tXiBrlfCnXvxamDI5kFP0B+npuBv+M4TjKFvwn5W8zYPPTEznilWnGvJFS71XwsOD/yHBGQb/Jz87aazNAeCznZRAJxfecJhgeChGZcGnXRAAdEeMbRyilYWaNquIpwrbNFElFlVf41EoDBk6woB8TeG0XFfz ikus060@ikus060-t530\\n'''\n            % user_root\n        )\n\n        # Deleting the user should delete it's keys\n        userobj.delete()\n\n        # Validate\n        self.assertAuthorizedKeys('')\n", "#!/usr/bin/env python\n# -*- coding: utf-8 -*-\n#\n# Minarca Server\n#\n# Copyright (C) 2020 IKUS Software inc. All rights reserved.\n# IKUS Software inc. PROPRIETARY/CONFIDENTIAL.\n# Use is subject to license terms.\n\n\nimport setuptools\n\nsetuptools.setup(\n    name=\"minarca_server\",\n    use_scm_version={\"root\": \"..\", \"relative_to\": __file__},\n    description=\"Minarca Web Server\",\n    long_description=\"Minarca is a self-hosted open source data backup software that allows you to manage your computer and server backups for free from a direct online accessible centralized view of your data with easy retrieval in case of displacement, loss or breakage.\",\n    author=\"IKUS Software inc.\",\n    author_email=\"support@ikus-soft.com\",\n    maintainer=\"IKUS Software inc.\",\n    maintainer_email=\"support@ikus-soft.com\",\n    url=\"https://www.ikus-soft.com/en/minarca/\",\n    include_package_data=True,\n    python_requires=\">=3.5\",\n    packages=[\"minarca_server\", \"minarca_server.plugins\", \"minarca_server.core\"],\n    setup_requires=[\n        \"setuptools_scm>=5.0.1\",\n    ],\n    install_requires=[\n        \"rdiffweb==2.4.5\",\n        \"cherrypy>=18.0.0\",\n        \"requests\",\n        \"tzlocal~=2.0\",\n    ],\n    # required packages for build process\n    extras_require={\n        \"test\": [\n            \"responses\",\n            \"pytest\",\n        ]\n    },\n    # Declare entry point\n    entry_points={\n        \"console_scripts\": [\n            \"minarca-server = minarca_server.main:main\",\n            \"minarca-shell = minarca_server.shell:main\",\n        ]\n    },\n)\n"], "filenames": ["README.md", "minarca-server/minarca_server/plugins/tests/test_minarca.py", "minarca-server/setup.py"], "buggy_code_start_loc": [72, 53, 30], "buggy_code_end_loc": [73, 64, 31], "fixing_code_start_loc": [72, 53, 30], "fixing_code_end_loc": [86, 64, 31], "type": "CWE-311", "message": "Sensitive Cookie in HTTPS Session Without 'Secure' Attribute in GitHub repository ikus060/minarca prior to 4.2.2.", "other": {"cve": {"id": "CVE-2022-3251", "sourceIdentifier": "security@huntr.dev", "published": "2022-09-21T17:15:09.630", "lastModified": "2022-09-23T16:56:54.663", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Sensitive Cookie in HTTPS Session Without 'Secure' Attribute in GitHub repository ikus060/minarca prior to 4.2.2."}, {"lang": "es", "value": "Una Cookie Confidencial en la sesi\u00f3n HTTPS sin el atributo \"Secure\" en el repositorio de GitHub ikus060/minarca versiones anteriores a 4.2.2"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "LOW", "integrityImpact": "NONE", "availabilityImpact": "NONE", "baseScore": 5.3, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 3.9, "impactScore": 1.4}], "cvssMetricV30": [{"source": "security@huntr.dev", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "HIGH", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 7.5, "baseSeverity": "HIGH"}, "exploitabilityScore": 1.6, "impactScore": 5.9}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-311"}]}, {"source": "security@huntr.dev", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-614"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:ikus-soft:minarca:*:*:*:*:*:*:*:*", "versionEndExcluding": "4.2.2", "matchCriteriaId": "5120F0F2-3042-4078-B0FB-338385CA85D3"}]}]}], "references": [{"url": "https://github.com/ikus060/minarca/commit/7b5c7e6cbd59268d5cd4f1b5f42e721db116f71a", "source": "security@huntr.dev", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://huntr.dev/bounties/b9a1b411-060b-4235-9426-e39bd0a1d6d9", "source": "security@huntr.dev", "tags": ["Exploit", "Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/ikus060/minarca/commit/7b5c7e6cbd59268d5cd4f1b5f42e721db116f71a"}}