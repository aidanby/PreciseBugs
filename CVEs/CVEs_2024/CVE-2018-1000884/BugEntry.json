{"buggy_code": ["<?php\nsession_start();\ndefine('NO_AUTH_REQUIRED',true);\n$TAB = 'RESET PASSWORD';\n\nif (isset($_SESSION['user'])) {\n    header(\"Location: /list/user\");\n}\n\n// Main include\ninclude($_SERVER['DOCUMENT_ROOT'].\"/inc/main.php\");\n\nif ((!empty($_POST['user'])) && (empty($_POST['code']))) {\n    $v_user = escapeshellarg($_POST['user']);\n    $user = $_POST['user'];\n    $cmd=\"/usr/bin/sudo /usr/local/vesta/bin/v-list-user\";\n    exec ($cmd.\" \".$v_user.\" json\", $output, $return_var);\n    if ( $return_var == 0 ) {\n        $data = json_decode(implode('', $output), true);\n        $rkey = $data[$user]['RKEY'];\n        $fname = $data[$user]['FNAME'];\n        $lname = $data[$user]['LNAME'];\n        $contact = $data[$user]['CONTACT'];\n        $to = $data[$user]['CONTACT'];\n        $subject = __('MAIL_RESET_SUBJECT',date(\"Y-m-d H:i:s\"));\n        $hostname = exec('hostname');\n        $from = __('MAIL_FROM',$hostname);\n        if (!empty($fname)) {\n            $mailtext = __('GREETINGS_GORDON_FREEMAN',$fname,$lname);\n        } else {\n            $mailtext = __('GREETINGS');\n        }\n        $mailtext .= __('PASSWORD_RESET_REQUEST',$_SERVER['HTTP_HOST'],$user,$rkey,$_SERVER['HTTP_HOST'],$user,$rkey);\n        if (!empty($rkey)) send_email($to, $subject, $mailtext, $from);\n        unset($output);\n    }\n\n    header(\"Location: /reset/?action=code&user=\".$_POST['user']);\n    exit;\n}\n\nif ((!empty($_POST['user'])) && (!empty($_POST['code'])) && (!empty($_POST['password'])) ) {\n    if ( $_POST['password'] == $_POST['password_confirm'] ) {\n        $v_user = escapeshellarg($_POST['user']);\n        $user = $_POST['user'];\n        $cmd=\"/usr/bin/sudo /usr/local/vesta/bin/v-list-user\";\n        exec ($cmd.\" \".$v_user.\" json\", $output, $return_var);\n        if ( $return_var == 0 ) {\n            $data = json_decode(implode('', $output), true);\n            $rkey = $data[$user]['RKEY'];\n            if ($rkey == $_POST['code']) {\n                $v_password = tempnam(\"/tmp\",\"vst\");\n                $fp = fopen($v_password, \"w\");\n                fwrite($fp, $_POST['password'].\"\\n\");\n                fclose($fp);\n                $cmd=\"/usr/bin/sudo /usr/local/vesta/bin/v-change-user-password\";\n                exec ($cmd.\" \".$v_user.\" \".$v_password, $output, $return_var);\n                unlink($v_password);\n                if ( $return_var > 0 ) {\n                    $ERROR = \"<a class=\\\"error\\\">\".__('An internal error occurred').\"</a>\";\n                } else {\n                    $_SESSION['user'] = $_POST['user'];\n                    header(\"Location: /\");\n                    exit;\n                }\n            } else {\n                $ERROR = \"<a class=\\\"error\\\">\".__('Invalid username or code').\"</a>\";\n            }\n        } else {\n            $ERROR = \"<a class=\\\"error\\\">\".__('Invalid username or code').\"</a>\";\n        }\n    } else {\n        $ERROR = \"<a class=\\\"error\\\">\".__('Passwords not match').\"</a>\";\n    }\n}\n\n// Detect language\nif (empty($_SESSION['language'])) $_SESSION['language'] = detect_user_language();\n\nif (empty($_GET['action'])) {\n    require_once '../templates/header.html';\n    require_once '../templates/reset_1.html';\n} else {\n    require_once '../templates/header.html';\n    if ($_GET['action'] == 'code' ) {\n        require_once '../templates/reset_2.html';\n    }\n    if (($_GET['action'] == 'confirm' ) && (!empty($_GET['code']))) {\n        require_once '../templates/reset_3.html';\n    }\n}\n\n?>\n"], "fixing_code": ["<?php\nsession_start();\ndefine('NO_AUTH_REQUIRED',true);\n$TAB = 'RESET PASSWORD';\n\nif (isset($_SESSION['user'])) {\n    header(\"Location: /list/user\");\n}\n\n// Main include\ninclude($_SERVER['DOCUMENT_ROOT'].\"/inc/main.php\");\n\nif ((!empty($_POST['user'])) && (empty($_POST['code']))) {\n    $v_user = escapeshellarg($_POST['user']);\n    $user = $_POST['user'];\n    $cmd=\"/usr/bin/sudo /usr/local/vesta/bin/v-list-user\";\n    exec ($cmd.\" \".$v_user.\" json\", $output, $return_var);\n    if ( $return_var == 0 ) {\n        $data = json_decode(implode('', $output), true);\n        $rkey = $data[$user]['RKEY'];\n        $fname = $data[$user]['FNAME'];\n        $lname = $data[$user]['LNAME'];\n        $contact = $data[$user]['CONTACT'];\n        $to = $data[$user]['CONTACT'];\n        $subject = __('MAIL_RESET_SUBJECT',date(\"Y-m-d H:i:s\"));\n        $hostname = exec('hostname');\n        $from = __('MAIL_FROM',$hostname);\n        if (!empty($fname)) {\n            $mailtext = __('GREETINGS_GORDON_FREEMAN',$fname,$lname);\n        } else {\n            $mailtext = __('GREETINGS');\n        }\n        $mailtext .= __('PASSWORD_RESET_REQUEST',$_SERVER['HTTP_HOST'],$user,$rkey,$_SERVER['HTTP_HOST'],$user,$rkey);\n        if (!empty($rkey)) send_email($to, $subject, $mailtext, $from);\n        unset($output);\n    }\n\n    header(\"Location: /reset/?action=code&user=\".$_POST['user']);\n    exit;\n}\n\nif ((!empty($_POST['user'])) && (!empty($_POST['code'])) && (!empty($_POST['password'])) ) {\n    if ( $_POST['password'] == $_POST['password_confirm'] ) {\n        $v_user = escapeshellarg($_POST['user']);\n        $user = $_POST['user'];\n        $cmd=\"/usr/bin/sudo /usr/local/vesta/bin/v-list-user\";\n        exec ($cmd.\" \".$v_user.\" json\", $output, $return_var);\n        if ( $return_var == 0 ) {\n            $data = json_decode(implode('', $output), true);\n            $rkey = $data[$user]['RKEY'];\n            if (hash_equals($rkey, $POST[\u2018code\u2019])) {\n                $v_password = tempnam(\"/tmp\",\"vst\");\n                $fp = fopen($v_password, \"w\");\n                fwrite($fp, $_POST['password'].\"\\n\");\n                fclose($fp);\n                $cmd=\"/usr/bin/sudo /usr/local/vesta/bin/v-change-user-password\";\n                exec ($cmd.\" \".$v_user.\" \".$v_password, $output, $return_var);\n                unlink($v_password);\n                if ( $return_var > 0 ) {\n                    $ERROR = \"<a class=\\\"error\\\">\".__('An internal error occurred').\"</a>\";\n                } else {\n                    $_SESSION['user'] = $_POST['user'];\n                    header(\"Location: /\");\n                    exit;\n                }\n            } else {\n                $ERROR = \"<a class=\\\"error\\\">\".__('Invalid username or code').\"</a>\";\n            }\n        } else {\n            $ERROR = \"<a class=\\\"error\\\">\".__('Invalid username or code').\"</a>\";\n        }\n    } else {\n        $ERROR = \"<a class=\\\"error\\\">\".__('Passwords not match').\"</a>\";\n    }\n}\n\n// Detect language\nif (empty($_SESSION['language'])) $_SESSION['language'] = detect_user_language();\n\nif (empty($_GET['action'])) {\n    require_once '../templates/header.html';\n    require_once '../templates/reset_1.html';\n} else {\n    require_once '../templates/header.html';\n    if ($_GET['action'] == 'code' ) {\n        require_once '../templates/reset_2.html';\n    }\n    if (($_GET['action'] == 'confirm' ) && (!empty($_GET['code']))) {\n        require_once '../templates/reset_3.html';\n    }\n}\n\n?>\n"], "filenames": ["web/reset/index.php"], "buggy_code_start_loc": [51], "buggy_code_end_loc": [52], "fixing_code_start_loc": [51], "fixing_code_end_loc": [52], "type": "CWE-203", "message": "Vesta CP version Prior to commit f6f6f9cfbbf2979e301956d1c6ab5c44386822c0 -- any release prior to 0.9.8-18 contains a CWE-208 / Information Exposure Through Timing Discrepancy vulnerability in Password reset code -- web/reset/index.php, line 51 that can result in Possible to determine password reset codes, attacker is able to change administrator password. This attack appear to be exploitable via Unauthenticated network connectivity. This vulnerability appears to have been fixed in After commit f6f6f9cfbbf2979e301956d1c6ab5c44386822c0 -- release version 0.9.8-19.", "other": {"cve": {"id": "CVE-2018-1000884", "sourceIdentifier": "cve@mitre.org", "published": "2018-12-20T21:29:00.370", "lastModified": "2020-08-24T17:37:01.140", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Vesta CP version Prior to commit f6f6f9cfbbf2979e301956d1c6ab5c44386822c0 -- any release prior to 0.9.8-18 contains a CWE-208 / Information Exposure Through Timing Discrepancy vulnerability in Password reset code -- web/reset/index.php, line 51 that can result in Possible to determine password reset codes, attacker is able to change administrator password. This attack appear to be exploitable via Unauthenticated network connectivity. This vulnerability appears to have been fixed in After commit f6f6f9cfbbf2979e301956d1c6ab5c44386822c0 -- release version 0.9.8-19."}, {"lang": "es", "value": "Vesta CP, en versiones anteriores al commit con ID f6f6f9cfbbf2979e301956d1c6ab5c44386822c0, en cualquier versi\u00f3n anterior a la 0.9.8-18, contiene una vulnerabilidad CWE-208 / Exposici\u00f3n de informaci\u00f3n mediante una discrepancia en la temporizaci\u00f3n en el c\u00f3digo de restablecimiento de la contrase\u00f1a (web/reset/index.php, l\u00ednea 51) que puede resultar en la posibilidad de determinar c\u00f3digos de restablecimiento de contrase\u00f1as, haciendo que un atacante pueda cambiar la contrase\u00f1a del administrador. Este ataque parece ser explotable mediante conectividad a una red no autenticada. La vulnerabilidad parece haber sido solucionada tras el commit con ID f6f6f9cfbbf2979e301956d1c6ab5c44386822c0 en la versi\u00f3n 0.9.8-19."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 9.8, "baseSeverity": "CRITICAL"}, "exploitabilityScore": 3.9, "impactScore": 5.9}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 5.0}, "baseSeverity": "MEDIUM", "exploitabilityScore": 10.0, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-203"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:vestacp:vesta_control_panel:*:*:*:*:*:*:*:*", "versionEndExcluding": "0.9.8-18", "matchCriteriaId": "ABAD4151-A43C-4793-917F-12152F993363"}]}]}], "references": [{"url": "https://github.com/serghey-rodin/vesta/commit/5f68c1b634abec2d5a4f83156bfd223d3a792f77#diff-4d7863e8c24a5e6102073acc2fb0f227", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/serghey-rodin/vesta/commit/5f68c1b634abec2d5a4f83156bfd223d3a792f77#diff-4d7863e8c24a5e6102073acc2fb0f227"}}