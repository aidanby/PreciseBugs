{"buggy_code": ["<?php\n/* vim: set expandtab sw=4 ts=4 sts=4: */\n/**\n * Configuration handling.\n *\n * @package PhpMyAdmin\n */\n\nif (! defined('PHPMYADMIN')) {\n    exit;\n}\n\n/**\n * Load vendor configuration.\n */\nrequire_once './libraries/vendor_config.php';\n\n/**\n * Indication for error handler (see end of this file).\n */\n$GLOBALS['pma_config_loading'] = false;\n\n/**\n * Configuration class\n *\n * @package PhpMyAdmin\n */\nclass PMA_Config\n{\n    /**\n     * @var string  default config source\n     */\n    var $default_source = './libraries/config.default.php';\n\n    /**\n     * @var array   default configuration settings\n     */\n    var $default = array();\n\n    /**\n     * @var array   configuration settings, without user preferences applied\n     */\n    var $base_settings = array();\n\n    /**\n     * @var array   configuration settings\n     */\n    var $settings = array();\n\n    /**\n     * @var string  config source\n     */\n    var $source = '';\n\n    /**\n     * @var int     source modification time\n     */\n    var $source_mtime = 0;\n    var $default_source_mtime = 0;\n    var $set_mtime = 0;\n\n    /**\n     * @var boolean\n     */\n    var $error_config_file = false;\n\n    /**\n     * @var boolean\n     */\n    var $error_config_default_file = false;\n\n    /**\n     * @var boolean\n     */\n    var $error_pma_uri = false;\n\n    /**\n     * @var array\n     */\n    var $default_server = array();\n\n    /**\n     * @var boolean whether init is done or not\n     * set this to false to force some initial checks\n     * like checking for required functions\n     */\n    var $done = false;\n\n    /**\n     * constructor\n     *\n     * @param string $source source to read config from\n     */\n    public function __construct($source = null)\n    {\n        $this->settings = array();\n\n        // functions need to refresh in case of config file changed goes in\n        // PMA_Config::load()\n        $this->load($source);\n\n        // other settings, independent from config file, comes in\n        $this->checkSystem();\n\n        $this->isHttps();\n\n        $this->base_settings = $this->settings;\n    }\n\n    /**\n     * sets system and application settings\n     *\n     * @return void\n     */\n    public function checkSystem()\n    {\n        $this->set('PMA_VERSION', '4.5.5');\n        /**\n         * @deprecated\n         */\n        $this->set('PMA_THEME_VERSION', 2);\n        /**\n         * @deprecated\n         */\n        $this->set('PMA_THEME_GENERATION', 2);\n\n        $this->checkPhpVersion();\n        $this->checkWebServerOs();\n        $this->checkWebServer();\n        $this->checkGd2();\n        $this->checkClient();\n        $this->checkUpload();\n        $this->checkUploadSize();\n        $this->checkOutputCompression();\n    }\n\n    /**\n     * whether to use gzip output compression or not\n     *\n     * @return void\n     */\n    public function checkOutputCompression()\n    {\n        // If zlib output compression is set in the php configuration file, no\n        // output buffering should be run\n        if (@ini_get('zlib.output_compression')) {\n            $this->set('OBGzip', false);\n        }\n\n        // disable output-buffering (if set to 'auto') for IE6, else enable it.\n        if (strtolower($this->get('OBGzip')) == 'auto') {\n            if ($this->get('PMA_USR_BROWSER_AGENT') == 'IE'\n                && $this->get('PMA_USR_BROWSER_VER') >= 6\n                && $this->get('PMA_USR_BROWSER_VER') < 7\n            ) {\n                $this->set('OBGzip', false);\n            } else {\n                $this->set('OBGzip', true);\n            }\n        }\n    }\n\n    /**\n     * Sets the client platform based on user agent\n     *\n     * @param string $user_agent the user agent\n     *\n     * @return void\n     */\n    private function _setClientPlatform($user_agent)\n    {\n        if (/*overload*/mb_strstr($user_agent, 'Win')) {\n            $this->set('PMA_USR_OS', 'Win');\n        } elseif (/*overload*/mb_strstr($user_agent, 'Mac')) {\n            $this->set('PMA_USR_OS', 'Mac');\n        } elseif (/*overload*/mb_strstr($user_agent, 'Linux')) {\n            $this->set('PMA_USR_OS', 'Linux');\n        } elseif (/*overload*/mb_strstr($user_agent, 'Unix')) {\n            $this->set('PMA_USR_OS', 'Unix');\n        } elseif (/*overload*/mb_strstr($user_agent, 'OS/2')) {\n            $this->set('PMA_USR_OS', 'OS/2');\n        } else {\n            $this->set('PMA_USR_OS', 'Other');\n        }\n    }\n\n    /**\n     * Determines platform (OS), browser and version of the user\n     * Based on a phpBuilder article:\n     *\n     * @see http://www.phpbuilder.net/columns/tim20000821.php\n     *\n     * @return void\n     */\n    public function checkClient()\n    {\n        if (PMA_getenv('HTTP_USER_AGENT')) {\n            $HTTP_USER_AGENT = PMA_getenv('HTTP_USER_AGENT');\n        } else {\n            $HTTP_USER_AGENT = '';\n        }\n\n        // 1. Platform\n        $this->_setClientPlatform($HTTP_USER_AGENT);\n\n        // 2. browser and version\n        // (must check everything else before Mozilla)\n\n        $is_mozilla = preg_match(\n            '@Mozilla/([0-9].[0-9]{1,2})@',\n            $HTTP_USER_AGENT,\n            $mozilla_version\n        );\n\n        if (preg_match(\n            '@Opera(/| )([0-9].[0-9]{1,2})@',\n            $HTTP_USER_AGENT,\n            $log_version\n        )) {\n            $this->set('PMA_USR_BROWSER_VER', $log_version[2]);\n            $this->set('PMA_USR_BROWSER_AGENT', 'OPERA');\n        } elseif (preg_match(\n            '@(MS)?IE ([0-9]{1,2}.[0-9]{1,2})@',\n            $HTTP_USER_AGENT,\n            $log_version\n        )) {\n            $this->set('PMA_USR_BROWSER_VER', $log_version[2]);\n            $this->set('PMA_USR_BROWSER_AGENT', 'IE');\n        } elseif (preg_match(\n            '@Trident/(7)\\.0@',\n            $HTTP_USER_AGENT,\n            $log_version\n        )) {\n            $this->set('PMA_USR_BROWSER_VER', intval($log_version[1]) + 4);\n            $this->set('PMA_USR_BROWSER_AGENT', 'IE');\n        } elseif (preg_match(\n            '@OmniWeb/([0-9].[0-9]{1,2})@',\n            $HTTP_USER_AGENT,\n            $log_version\n        )) {\n            $this->set('PMA_USR_BROWSER_VER', $log_version[1]);\n            $this->set('PMA_USR_BROWSER_AGENT', 'OMNIWEB');\n            // Konqueror 2.2.2 says Konqueror/2.2.2\n            // Konqueror 3.0.3 says Konqueror/3\n        } elseif (preg_match(\n            '@(Konqueror/)(.*)(;)@',\n            $HTTP_USER_AGENT,\n            $log_version\n        )) {\n            $this->set('PMA_USR_BROWSER_VER', $log_version[2]);\n            $this->set('PMA_USR_BROWSER_AGENT', 'KONQUEROR');\n            // must check Chrome before Safari\n        } elseif ($is_mozilla\n            && preg_match('@Chrome/([0-9.]*)@', $HTTP_USER_AGENT, $log_version)\n        ) {\n            $this->set('PMA_USR_BROWSER_VER', $log_version[1]);\n            $this->set('PMA_USR_BROWSER_AGENT', 'CHROME');\n            // newer Safari\n        } elseif ($is_mozilla\n            && preg_match('@Version/(.*) Safari@', $HTTP_USER_AGENT, $log_version)\n        ) {\n            $this->set(\n                'PMA_USR_BROWSER_VER', $log_version[1]\n            );\n            $this->set('PMA_USR_BROWSER_AGENT', 'SAFARI');\n            // older Safari\n        } elseif ($is_mozilla\n            && preg_match('@Safari/([0-9]*)@', $HTTP_USER_AGENT, $log_version)\n        ) {\n            $this->set(\n                'PMA_USR_BROWSER_VER', $mozilla_version[1] . '.' . $log_version[1]\n            );\n            $this->set('PMA_USR_BROWSER_AGENT', 'SAFARI');\n            // Firefox\n        } elseif (! /*overload*/mb_strstr($HTTP_USER_AGENT, 'compatible')\n            && preg_match('@Firefox/([\\w.]+)@', $HTTP_USER_AGENT, $log_version)\n        ) {\n            $this->set(\n                'PMA_USR_BROWSER_VER', $log_version[1]\n            );\n            $this->set('PMA_USR_BROWSER_AGENT', 'FIREFOX');\n        } elseif (preg_match('@rv:1.9(.*)Gecko@', $HTTP_USER_AGENT)) {\n            $this->set('PMA_USR_BROWSER_VER', '1.9');\n            $this->set('PMA_USR_BROWSER_AGENT', 'GECKO');\n        } elseif ($is_mozilla) {\n            $this->set('PMA_USR_BROWSER_VER', $mozilla_version[1]);\n            $this->set('PMA_USR_BROWSER_AGENT', 'MOZILLA');\n        } else {\n            $this->set('PMA_USR_BROWSER_VER', 0);\n            $this->set('PMA_USR_BROWSER_AGENT', 'OTHER');\n        }\n    }\n\n    /**\n     * Whether GD2 is present\n     *\n     * @return void\n     */\n    public function checkGd2()\n    {\n        if ($this->get('GD2Available') == 'yes') {\n            $this->set('PMA_IS_GD2', 1);\n            return;\n        }\n\n        if ($this->get('GD2Available') == 'no') {\n            $this->set('PMA_IS_GD2', 0);\n            return;\n        }\n\n        if (!@function_exists('imagecreatetruecolor')) {\n            $this->set('PMA_IS_GD2', 0);\n            return;\n        }\n\n        if (@function_exists('gd_info')) {\n            $gd_nfo = gd_info();\n            if (/*overload*/mb_strstr($gd_nfo[\"GD Version\"], '2.')) {\n                $this->set('PMA_IS_GD2', 1);\n            } else {\n                $this->set('PMA_IS_GD2', 0);\n            }\n        } else {\n            $this->set('PMA_IS_GD2', 0);\n        }\n    }\n\n    /**\n     * Whether the Web server php is running on is IIS\n     *\n     * @return void\n     */\n    public function checkWebServer()\n    {\n        // some versions return Microsoft-IIS, some Microsoft/IIS\n        // we could use a preg_match() but it's slower\n        if (PMA_getenv('SERVER_SOFTWARE')\n            && stristr(PMA_getenv('SERVER_SOFTWARE'), 'Microsoft')\n            && stristr(PMA_getenv('SERVER_SOFTWARE'), 'IIS')\n        ) {\n            $this->set('PMA_IS_IIS', 1);\n        } else {\n            $this->set('PMA_IS_IIS', 0);\n        }\n    }\n\n    /**\n     * Whether the os php is running on is windows or not\n     *\n     * @return void\n     */\n    public function checkWebServerOs()\n    {\n        // Default to Unix or Equiv\n        $this->set('PMA_IS_WINDOWS', 0);\n        // If PHP_OS is defined then continue\n        if (defined('PHP_OS')) {\n            if (stristr(PHP_OS, 'win') && !stristr(PHP_OS, 'darwin')) {\n                // Is it some version of Windows\n                $this->set('PMA_IS_WINDOWS', 1);\n            } elseif (stristr(PHP_OS, 'OS/2')) {\n                // Is it OS/2 (No file permissions like Windows)\n                $this->set('PMA_IS_WINDOWS', 1);\n            }\n        }\n    }\n\n    /**\n     * detects PHP version\n     *\n     * @return void\n     */\n    public function checkPhpVersion()\n    {\n        $match = array();\n        if (! preg_match(\n            '@([0-9]{1,2}).([0-9]{1,2}).([0-9]{1,2})@',\n            phpversion(),\n            $match\n        )) {\n            preg_match(\n                '@([0-9]{1,2}).([0-9]{1,2})@',\n                phpversion(),\n                $match\n            );\n        }\n        if (isset($match) && ! empty($match[1])) {\n            if (! isset($match[2])) {\n                $match[2] = 0;\n            }\n            if (! isset($match[3])) {\n                $match[3] = 0;\n            }\n            $this->set(\n                'PMA_PHP_INT_VERSION',\n                (int) sprintf('%d%02d%02d', $match[1], $match[2], $match[3])\n            );\n        } else {\n            $this->set('PMA_PHP_INT_VERSION', 0);\n        }\n        $this->set('PMA_PHP_STR_VERSION', phpversion());\n    }\n\n    /**\n     * detects if Git revision\n     *\n     * @return boolean\n     */\n    public function isGitRevision()\n    {\n        if (!$this->get('ShowGitRevision')) {\n            return false;\n        }\n\n        // caching\n        if (isset($_SESSION['is_git_revision'])) {\n            if ($_SESSION['is_git_revision']) {\n                $this->set('PMA_VERSION_GIT', 1);\n            }\n            return $_SESSION['is_git_revision'];\n        }\n        // find out if there is a .git folder\n        $git_folder = '.git';\n        if (! @file_exists($git_folder)\n            || ! @file_exists($git_folder . '/config')\n        ) {\n            $_SESSION['is_git_revision'] = false;\n            return false;\n        }\n        $_SESSION['is_git_revision'] = true;\n        return true;\n    }\n\n    /**\n     * detects Git revision, if running inside repo\n     *\n     * @return void\n     */\n    public function checkGitRevision()\n    {\n        // find out if there is a .git folder\n        $git_folder = '.git';\n        if (! $this->isGitRevision()) {\n            return;\n        }\n\n        if (! $ref_head = @file_get_contents($git_folder . '/HEAD')) {\n            return;\n        }\n\n        $branch = false;\n        // are we on any branch?\n        if (/*overload*/mb_strstr($ref_head, '/')) {\n            $ref_head = /*overload*/mb_substr(trim($ref_head), 5);\n            if (substr($ref_head, 0, 11) === 'refs/heads/') {\n                $branch = /*overload*/mb_substr($ref_head, 11);\n            } else {\n                $branch = basename($ref_head);\n            }\n\n            $ref_file = $git_folder . '/' . $ref_head;\n            if (@file_exists($ref_file)) {\n                $hash = @file_get_contents($ref_file);\n                if (! $hash) {\n                    return;\n                }\n                $hash = trim($hash);\n            } else {\n                // deal with packed refs\n                $packed_refs = @file_get_contents($git_folder . '/packed-refs');\n                if (! $packed_refs) {\n                    return;\n                }\n                // split file to lines\n                $ref_lines = explode(\"\\n\", $packed_refs);\n                foreach ($ref_lines as $line) {\n                    // skip comments\n                    if ($line[0] == '#') {\n                        continue;\n                    }\n                    // parse line\n                    $parts = explode(' ', $line);\n                    // care only about named refs\n                    if (count($parts) != 2) {\n                        continue;\n                    }\n                    // have found our ref?\n                    if ($parts[1] == $ref_head) {\n                        $hash = $parts[0];\n                        break;\n                    }\n                }\n                if (! isset($hash)) {\n                    // Could not find ref\n                    return;\n                }\n            }\n        } else {\n            $hash = trim($ref_head);\n        }\n\n        $commit = false;\n        if (isset($_SESSION['PMA_VERSION_COMMITDATA_' . $hash])) {\n            $commit = $_SESSION['PMA_VERSION_COMMITDATA_' . $hash];\n        } elseif (function_exists('gzuncompress')) {\n            $git_file_name = $git_folder . '/objects/'\n                . substr($hash, 0, 2) . '/' . substr($hash, 2);\n            if (file_exists($git_file_name) ) {\n                if (! $commit = @file_get_contents($git_file_name)) {\n                    return;\n                }\n                $commit = explode(\"\\0\", gzuncompress($commit), 2);\n                $commit = explode(\"\\n\", $commit[1]);\n                $_SESSION['PMA_VERSION_COMMITDATA_' . $hash] = $commit;\n            } else {\n                $pack_names = array();\n                // work with packed data\n                $packs_file = $git_folder . '/objects/info/packs';\n                if (file_exists($packs_file)\n                    && $packs = @file_get_contents($packs_file)\n                ) {\n                    // File exists. Read it, parse the file to get the names of the\n                    // packs. (to look for them in .git/object/pack directory later)\n                    foreach (explode(\"\\n\", $packs) as $line) {\n                        // skip blank lines\n                        if (strlen(trim($line)) == 0) {\n                            continue;\n                        }\n                        // skip non pack lines\n                        if ($line[0] != 'P') {\n                            continue;\n                        }\n                        // parse names\n                        $pack_names[] = substr($line, 2);\n                    }\n                } else {\n                    // '.git/objects/info/packs' file can be missing\n                    // (atlease in mysGit)\n                    // File missing. May be we can look in the .git/object/pack\n                    // directory for all the .pack files and use that list of\n                    // files instead\n                    $dirIterator = new DirectoryIterator(\n                        $git_folder . '/objects/pack'\n                    );\n                    foreach ($dirIterator as $file_info) {\n                        $file_name = $file_info->getFilename();\n                        // if this is a .pack file\n                        if ($file_info->isFile() && substr($file_name, -5) == '.pack'\n                        ) {\n                            $pack_names[] = $file_name;\n                        }\n                    }\n                }\n                $hash = strtolower($hash);\n                foreach ($pack_names as $pack_name) {\n                    $index_name = str_replace('.pack', '.idx', $pack_name);\n\n                    // load index\n                    $index_data = @file_get_contents(\n                        $git_folder . '/objects/pack/' . $index_name\n                    );\n                    if (! $index_data) {\n                        continue;\n                    }\n                    // check format\n                    if (substr($index_data, 0, 4) != \"\\377tOc\") {\n                        continue;\n                    }\n                    // check version\n                    $version = unpack('N', substr($index_data, 4, 4));\n                    if ($version[1] != 2) {\n                        continue;\n                    }\n                    // parse fanout table\n                    $fanout = unpack(\n                        \"N*\",\n                        substr($index_data, 8, 256 * 4)\n                    );\n\n                    // find where we should search\n                    $firstbyte = intval(substr($hash, 0, 2), 16);\n                    // array is indexed from 1 and we need to get\n                    // previous entry for start\n                    if ($firstbyte == 0) {\n                        $start = 0;\n                    } else {\n                        $start = $fanout[$firstbyte];\n                    }\n                    $end = $fanout[$firstbyte + 1];\n\n                    // stupid linear search for our sha\n                    $found = false;\n                    $offset = 8 + (256 * 4);\n                    for ($position = $start; $position < $end; $position++) {\n                        $sha = strtolower(\n                            bin2hex(\n                                substr($index_data, $offset + ($position * 20), 20)\n                            )\n                        );\n                        if ($sha == $hash) {\n                            $found = true;\n                            break;\n                        }\n                    }\n                    if (! $found) {\n                        continue;\n                    }\n                    // read pack offset\n                    $offset = 8 + (256 * 4) + (24 * $fanout[256]);\n                    $pack_offset = unpack(\n                        'N',\n                        substr($index_data, $offset + ($position * 4), 4)\n                    );\n                    $pack_offset = $pack_offset[1];\n\n                    // open pack file\n                    $pack_file = fopen(\n                        $git_folder . '/objects/pack/' . $pack_name, 'rb'\n                    );\n                    if ($pack_file === false) {\n                        continue;\n                    }\n                    // seek to start\n                    fseek($pack_file, $pack_offset);\n\n                    // parse header\n                    $header = ord(fread($pack_file, 1));\n                    $type = ($header >> 4) & 7;\n                    $hasnext = ($header & 128) >> 7;\n                    $size = $header & 0xf;\n                    $offset = 4;\n\n                    while ($hasnext) {\n                        $byte = ord(fread($pack_file, 1));\n                        $size |= ($byte & 0x7f) << $offset;\n                        $hasnext = ($byte & 128) >> 7;\n                        $offset += 7;\n                    }\n\n                    // we care only about commit objects\n                    if ($type != 1) {\n                        continue;\n                    }\n\n                    // read data\n                    $commit = fread($pack_file, $size);\n                    $commit = gzuncompress($commit);\n                    $commit = explode(\"\\n\", $commit);\n                    $_SESSION['PMA_VERSION_COMMITDATA_' . $hash] = $commit;\n                    fclose($pack_file);\n                }\n            }\n        }\n\n        // check if commit exists in Github\n        if ($commit !== false\n            && isset($_SESSION['PMA_VERSION_REMOTECOMMIT_' . $hash])\n        ) {\n            $is_remote_commit = $_SESSION['PMA_VERSION_REMOTECOMMIT_' . $hash];\n        } else {\n            $link = 'https://api.github.com/repos/phpmyadmin/phpmyadmin/git/commits/'\n                . $hash;\n            $is_found = $this->checkHTTP($link, ! $commit);\n            switch($is_found) {\n            case false:\n                $is_remote_commit = false;\n                $_SESSION['PMA_VERSION_REMOTECOMMIT_' . $hash] = false;\n                break;\n            case null:\n                // no remote link for now, but don't cache this as Github is down\n                $is_remote_commit = false;\n                break;\n            default:\n                $is_remote_commit = true;\n                $_SESSION['PMA_VERSION_REMOTECOMMIT_' . $hash] = true;\n                if ($commit === false) {\n                    // if no local commit data, try loading from Github\n                    $commit_json = json_decode($is_found);\n                }\n                break;\n            }\n        }\n\n        $is_remote_branch = false;\n        if ($is_remote_commit && $branch !== false) {\n            // check if branch exists in Github\n            if (isset($_SESSION['PMA_VERSION_REMOTEBRANCH_' . $hash])) {\n                $is_remote_branch = $_SESSION['PMA_VERSION_REMOTEBRANCH_' . $hash];\n            } else {\n                $link = 'https://api.github.com/repos/phpmyadmin/phpmyadmin'\n                    . '/git/trees/' . $branch;\n                $is_found = $this->checkHTTP($link);\n                switch($is_found) {\n                case true:\n                    $is_remote_branch = true;\n                    $_SESSION['PMA_VERSION_REMOTEBRANCH_' . $hash] = true;\n                    break;\n                case false:\n                    $is_remote_branch = false;\n                    $_SESSION['PMA_VERSION_REMOTEBRANCH_' . $hash] = false;\n                    break;\n                case null:\n                    // no remote link for now, but don't cache this as Github is down\n                    $is_remote_branch = false;\n                    break;\n                }\n            }\n        }\n\n        if ($commit !== false) {\n            $author = array('name' => '', 'email' => '', 'date' => '');\n            $committer = array('name' => '', 'email' => '', 'date' => '');\n\n            do {\n                $dataline = array_shift($commit);\n                $datalinearr = explode(' ', $dataline, 2);\n                $linetype = $datalinearr[0];\n                if (in_array($linetype, array('author', 'committer'))) {\n                    $user = $datalinearr[1];\n                    preg_match('/([^<]+)<([^>]+)> ([0-9]+)( [^ ]+)?/', $user, $user);\n                    $user2 = array(\n                        'name' => trim($user[1]),\n                        'email' => trim($user[2]),\n                        'date' => date('Y-m-d H:i:s', $user[3]));\n                    if (isset($user[4])) {\n                        $user2['date'] .= $user[4];\n                    }\n                    $$linetype = $user2;\n                }\n            } while ($dataline != '');\n            $message = trim(implode(' ', $commit));\n\n        } elseif (isset($commit_json)) {\n            $author = array(\n                'name' => $commit_json->author->name,\n                'email' => $commit_json->author->email,\n                'date' => $commit_json->author->date);\n            $committer = array(\n                'name' => $commit_json->committer->name,\n                'email' => $commit_json->committer->email,\n                'date' => $commit_json->committer->date);\n            $message = trim($commit_json->message);\n        } else {\n            return;\n        }\n\n        $this->set('PMA_VERSION_GIT', 1);\n        $this->set('PMA_VERSION_GIT_COMMITHASH', $hash);\n        $this->set('PMA_VERSION_GIT_BRANCH', $branch);\n        $this->set('PMA_VERSION_GIT_MESSAGE', $message);\n        $this->set('PMA_VERSION_GIT_AUTHOR', $author);\n        $this->set('PMA_VERSION_GIT_COMMITTER', $committer);\n        $this->set('PMA_VERSION_GIT_ISREMOTECOMMIT', $is_remote_commit);\n        $this->set('PMA_VERSION_GIT_ISREMOTEBRANCH', $is_remote_branch);\n    }\n\n    /**\n     * Checks if given URL is 200 or 404, optionally returns data\n     *\n     * @param string  $link     the URL to check\n     * @param boolean $get_body whether to retrieve body of document\n     *\n     * @return string|boolean test result or data\n     */\n    public function checkHTTP($link, $get_body = false)\n    {\n        if (! function_exists('curl_init')) {\n            return null;\n        }\n        $handle = curl_init($link);\n        if ($handle === false) {\n            return null;\n        }\n        PMA_Util::configureCurl($handle);\n        curl_setopt($handle, CURLOPT_FOLLOWLOCATION, 0);\n        curl_setopt($handle, CURLOPT_RETURNTRANSFER, 1);\n        curl_setopt($handle, CURLOPT_SSL_VERIFYHOST, 0);\n        curl_setopt($handle, CURLOPT_SSL_VERIFYPEER, 0);\n        curl_setopt($handle, CURLOPT_CONNECTTIMEOUT, 5);\n        curl_setopt($handle, CURLOPT_TIMEOUT, 5);\n        curl_setopt($handle, CURLOPT_IPRESOLVE, CURL_IPRESOLVE_V4);\n        if (! defined('TESTSUITE')) {\n            session_write_close();\n        }\n        $data = @curl_exec($handle);\n        if (! defined('TESTSUITE')) {\n            ini_set('session.use_only_cookies', '0');\n            ini_set('session.use_cookies', '0');\n            ini_set('session.use_trans_sid', '0');\n            ini_set('session.cache_limiter', 'nocache');\n            session_start();\n        }\n        if ($data === false) {\n            return null;\n        }\n        $http_status = curl_getinfo($handle, CURLINFO_HTTP_CODE);\n\n        if ($http_status == 200) {\n            return $get_body ? $data : true;\n        }\n\n        if ($http_status == 404) {\n            return false;\n        }\n        return null;\n    }\n\n    /**\n     * loads default values from default source\n     *\n     * @return boolean     success\n     */\n    public function loadDefaults()\n    {\n        $cfg = array();\n        if (! @file_exists($this->default_source)) {\n            $this->error_config_default_file = true;\n            return false;\n        }\n        include $this->default_source;\n\n        $this->default_source_mtime = filemtime($this->default_source);\n\n        $this->default_server = $cfg['Servers'][1];\n        unset($cfg['Servers']);\n\n        $this->default = $cfg;\n        $this->settings = PMA_arrayMergeRecursive($this->settings, $cfg);\n\n        $this->error_config_default_file = false;\n\n        return true;\n    }\n\n    /**\n     * loads configuration from $source, usually the config file\n     * should be called on object creation\n     *\n     * @param string $source config file\n     *\n     * @return bool\n     */\n    public function load($source = null)\n    {\n        $this->loadDefaults();\n\n        if (null !== $source) {\n            $this->setSource($source);\n        }\n\n        /**\n         * We check and set the font size at this point, to make the font size\n         * selector work also for users without a config.inc.php\n         */\n        $this->checkFontsize();\n\n        if (! $this->checkConfigSource()) {\n            // even if no config file, set collation_connection\n            $this->checkCollationConnection();\n            return false;\n        }\n\n        $cfg = array();\n\n        /**\n         * Parses the configuration file, we throw away any errors or\n         * output.\n         */\n        $old_error_reporting = error_reporting(0);\n        ob_start();\n        $GLOBALS['pma_config_loading'] = true;\n        $eval_result = include $this->getSource();\n        $GLOBALS['pma_config_loading'] = false;\n        ob_end_clean();\n        error_reporting($old_error_reporting);\n\n        if ($eval_result === false) {\n            $this->error_config_file = true;\n        } else {\n            $this->error_config_file = false;\n            $this->source_mtime = filemtime($this->getSource());\n        }\n\n        /**\n         * Backward compatibility code\n         */\n        if (!empty($cfg['DefaultTabTable'])) {\n            $cfg['DefaultTabTable'] = str_replace(\n                '_properties',\n                '',\n                str_replace(\n                    'tbl_properties.php',\n                    'tbl_sql.php',\n                    $cfg['DefaultTabTable']\n                )\n            );\n        }\n        if (!empty($cfg['DefaultTabDatabase'])) {\n            $cfg['DefaultTabDatabase'] = str_replace(\n                '_details',\n                '',\n                str_replace(\n                    'db_details.php',\n                    'db_sql.php',\n                    $cfg['DefaultTabDatabase']\n                )\n            );\n        }\n\n        $this->settings = PMA_arrayMergeRecursive($this->settings, $cfg);\n        $this->checkPmaAbsoluteUri();\n\n        // Handling of the collation must be done after merging of $cfg\n        // (from config.inc.php) so that $cfg['DefaultConnectionCollation']\n        // can have an effect.\n        $this->checkCollationConnection();\n\n        return true;\n    }\n\n    /**\n     * Saves the connection collation\n     *\n     * @param array $config_data configuration data from user preferences\n     *\n     * @return void\n     */\n    private function _saveConnectionCollation($config_data)\n    {\n        if (!PMA_DRIZZLE) {\n            // just to shorten the lines\n            $collation = 'collation_connection';\n            if (isset($GLOBALS[$collation])\n                && (isset($_COOKIE['pma_collation_connection'])\n                || isset($_POST[$collation]))\n            ) {\n                if ((! isset($config_data[$collation])\n                    && $GLOBALS[$collation] != 'utf8_general_ci')\n                    || isset($config_data[$collation])\n                    && $GLOBALS[$collation] != $config_data[$collation]\n                ) {\n                    $this->setUserValue(\n                        null,\n                        $collation,\n                        $GLOBALS[$collation],\n                        'utf8_general_ci'\n                    );\n                }\n            } else {\n                // read collation from settings\n                if (isset($config_data[$collation])) {\n                    $GLOBALS[$collation]\n                        = $config_data[$collation];\n                    $this->setCookie(\n                        'pma_collation_connection',\n                        $GLOBALS[$collation]\n                    );\n                }\n            }\n        }\n    }\n\n    /**\n     * Loads user preferences and merges them with current config\n     * must be called after control connection has been established\n     *\n     * @return void\n     */\n    public function loadUserPreferences()\n    {\n        // index.php should load these settings, so that phpmyadmin.css.php\n        // will have everything available in session cache\n        $server = isset($GLOBALS['server'])\n            ? $GLOBALS['server']\n            : (!empty($GLOBALS['cfg']['ServerDefault'])\n                ? $GLOBALS['cfg']['ServerDefault']\n                : 0);\n        $cache_key = 'server_' . $server;\n        if ($server > 0 && !defined('PMA_MINIMUM_COMMON')) {\n            $config_mtime = max($this->default_source_mtime, $this->source_mtime);\n            // cache user preferences, use database only when needed\n            if (! isset($_SESSION['cache'][$cache_key]['userprefs'])\n                || $_SESSION['cache'][$cache_key]['config_mtime'] < $config_mtime\n            ) {\n                // load required libraries\n                include_once './libraries/user_preferences.lib.php';\n                $prefs = PMA_loadUserprefs();\n                $_SESSION['cache'][$cache_key]['userprefs']\n                    = PMA_applyUserprefs($prefs['config_data']);\n                $_SESSION['cache'][$cache_key]['userprefs_mtime'] = $prefs['mtime'];\n                $_SESSION['cache'][$cache_key]['userprefs_type'] = $prefs['type'];\n                $_SESSION['cache'][$cache_key]['config_mtime'] = $config_mtime;\n            }\n        } elseif ($server == 0\n            || ! isset($_SESSION['cache'][$cache_key]['userprefs'])\n        ) {\n            $this->set('user_preferences', false);\n            return;\n        }\n        $config_data = $_SESSION['cache'][$cache_key]['userprefs'];\n        // type is 'db' or 'session'\n        $this->set(\n            'user_preferences',\n            $_SESSION['cache'][$cache_key]['userprefs_type']\n        );\n        $this->set(\n            'user_preferences_mtime',\n            $_SESSION['cache'][$cache_key]['userprefs_mtime']\n        );\n\n        // backup some settings\n        $org_fontsize = '';\n        if (isset($this->settings['fontsize'])) {\n            $org_fontsize = $this->settings['fontsize'];\n        }\n        // load config array\n        $this->settings = PMA_arrayMergeRecursive($this->settings, $config_data);\n        $GLOBALS['cfg'] = PMA_arrayMergeRecursive($GLOBALS['cfg'], $config_data);\n        if (defined('PMA_MINIMUM_COMMON')) {\n            return;\n        }\n\n        // settings below start really working on next page load, but\n        // changes are made only in index.php so everything is set when\n        // in frames\n\n        // save theme\n        /** @var PMA_Theme_Manager $tmanager */\n        $tmanager = $_SESSION['PMA_Theme_Manager'];\n        if ($tmanager->getThemeCookie() || isset($_REQUEST['set_theme'])) {\n            if ((! isset($config_data['ThemeDefault'])\n                && $tmanager->theme->getId() != 'original')\n                || isset($config_data['ThemeDefault'])\n                && $config_data['ThemeDefault'] != $tmanager->theme->getId()\n            ) {\n                // new theme was set in common.inc.php\n                $this->setUserValue(\n                    null,\n                    'ThemeDefault',\n                    $tmanager->theme->getId(),\n                    'original'\n                );\n            }\n        } else {\n            // no cookie - read default from settings\n            if ($this->settings['ThemeDefault'] != $tmanager->theme->getId()\n                && $tmanager->checkTheme($this->settings['ThemeDefault'])\n            ) {\n                $tmanager->setActiveTheme($this->settings['ThemeDefault']);\n                $tmanager->setThemeCookie();\n            }\n        }\n\n        // save font size\n        if ((! isset($config_data['fontsize'])\n            && $org_fontsize != '82%')\n            || isset($config_data['fontsize'])\n            && $org_fontsize != $config_data['fontsize']\n        ) {\n            $this->setUserValue(null, 'fontsize', $org_fontsize, '82%');\n        }\n\n        // save language\n        if (isset($_COOKIE['pma_lang']) || isset($_POST['lang'])) {\n            if ((! isset($config_data['lang'])\n                && $GLOBALS['lang'] != 'en')\n                || isset($config_data['lang'])\n                && $GLOBALS['lang'] != $config_data['lang']\n            ) {\n                $this->setUserValue(null, 'lang', $GLOBALS['lang'], 'en');\n            }\n        } else {\n            // read language from settings\n            if (isset($config_data['lang']) && PMA_langSet($config_data['lang'])) {\n                $this->setCookie('pma_lang', $GLOBALS['lang']);\n            }\n        }\n\n        // save connection collation\n        $this->_saveConnectionCollation($config_data);\n    }\n\n    /**\n     * Sets config value which is stored in user preferences (if available)\n     * or in a cookie.\n     *\n     * If user preferences are not yet initialized, option is applied to\n     * global config and added to a update queue, which is processed\n     * by {@link loadUserPreferences()}\n     *\n     * @param string $cookie_name   can be null\n     * @param string $cfg_path      configuration path\n     * @param mixed  $new_cfg_value new value\n     * @param mixed  $default_value default value\n     *\n     * @return void\n     */\n    public function setUserValue($cookie_name, $cfg_path, $new_cfg_value,\n        $default_value = null\n    ) {\n        // use permanent user preferences if possible\n        $prefs_type = $this->get('user_preferences');\n        if ($prefs_type) {\n            include_once './libraries/user_preferences.lib.php';\n            if ($default_value === null) {\n                $default_value = PMA_arrayRead($cfg_path, $this->default);\n            }\n            PMA_persistOption($cfg_path, $new_cfg_value, $default_value);\n        }\n        if ($prefs_type != 'db' && $cookie_name) {\n            // fall back to cookies\n            if ($default_value === null) {\n                $default_value = PMA_arrayRead($cfg_path, $this->settings);\n            }\n            $this->setCookie($cookie_name, $new_cfg_value, $default_value);\n        }\n        PMA_arrayWrite($cfg_path, $GLOBALS['cfg'], $new_cfg_value);\n        PMA_arrayWrite($cfg_path, $this->settings, $new_cfg_value);\n    }\n\n    /**\n     * Reads value stored by {@link setUserValue()}\n     *\n     * @param string $cookie_name cookie name\n     * @param mixed  $cfg_value   config value\n     *\n     * @return mixed\n     */\n    public function getUserValue($cookie_name, $cfg_value)\n    {\n        $cookie_exists = isset($_COOKIE) && !empty($_COOKIE[$cookie_name]);\n        $prefs_type = $this->get('user_preferences');\n        if ($prefs_type == 'db') {\n            // permanent user preferences value exists, remove cookie\n            if ($cookie_exists) {\n                $this->removeCookie($cookie_name);\n            }\n        } else if ($cookie_exists) {\n            return $_COOKIE[$cookie_name];\n        }\n        // return value from $cfg array\n        return $cfg_value;\n    }\n\n    /**\n     * set source\n     *\n     * @param string $source source\n     *\n     * @return void\n     */\n    public function setSource($source)\n    {\n        $this->source = trim($source);\n    }\n\n    /**\n     * check config source\n     *\n     * @return boolean whether source is valid or not\n     */\n    public function checkConfigSource()\n    {\n        if (! $this->getSource()) {\n            // no configuration file set at all\n            return false;\n        }\n\n        if (! @file_exists($this->getSource())) {\n            $this->source_mtime = 0;\n            return false;\n        }\n\n        if (! @is_readable($this->getSource())) {\n            // manually check if file is readable\n            // might be bug #3059806 Supporting running from CIFS/Samba shares\n\n            $contents = false;\n            $handle = @fopen($this->getSource(), 'r');\n            if ($handle !== false) {\n                $contents = @fread($handle, 1); // reading 1 byte is enough to test\n                @fclose($handle);\n            }\n            if ($contents === false) {\n                $this->source_mtime = 0;\n                PMA_fatalError(\n                    sprintf(\n                        function_exists('__')\n                        ? __('Existing configuration file (%s) is not readable.')\n                        : 'Existing configuration file (%s) is not readable.',\n                        $this->getSource()\n                    )\n                );\n                return false;\n            }\n        }\n\n        return true;\n    }\n\n    /**\n     * verifies the permissions on config file (if asked by configuration)\n     * (must be called after config.inc.php has been merged)\n     *\n     * @return void\n     */\n    public function checkPermissions()\n    {\n        // Check for permissions (on platforms that support it):\n        if ($this->get('CheckConfigurationPermissions')) {\n            $perms = @fileperms($this->getSource());\n            if (!($perms === false) && ($perms & 2)) {\n                // This check is normally done after loading configuration\n                $this->checkWebServerOs();\n                if ($this->get('PMA_IS_WINDOWS') == 0) {\n                    $this->source_mtime = 0;\n                    PMA_fatalError(\n                        __(\n                            'Wrong permissions on configuration file, '\n                            . 'should not be world writable!'\n                        )\n                    );\n                }\n            }\n        }\n    }\n\n    /**\n     * returns specific config setting\n     *\n     * @param string $setting config setting\n     *\n     * @return mixed value\n     */\n    public function get($setting)\n    {\n        if (isset($this->settings[$setting])) {\n            return $this->settings[$setting];\n        }\n        return null;\n    }\n\n    /**\n     * sets configuration variable\n     *\n     * @param string $setting configuration option\n     * @param mixed  $value   new value for configuration option\n     *\n     * @return void\n     */\n    public function set($setting, $value)\n    {\n        if (! isset($this->settings[$setting])\n            || $this->settings[$setting] !== $value\n        ) {\n            $this->settings[$setting] = $value;\n            $this->set_mtime = time();\n        }\n    }\n\n    /**\n     * returns source for current config\n     *\n     * @return string  config source\n     */\n    public function getSource()\n    {\n        return $this->source;\n    }\n\n    /**\n     * returns a unique value to force a CSS reload if either the config\n     * or the theme changes\n     * must also check the pma_fontsize cookie in case there is no\n     * config file\n     *\n     * @return int Summary of unix timestamps and fontsize,\n     * to be unique on theme parameters change\n     */\n    public function getThemeUniqueValue()\n    {\n        if (null !== $this->get('fontsize')) {\n            $fontsize = intval($this->get('fontsize'));\n        } elseif (isset($_COOKIE['pma_fontsize'])) {\n            $fontsize = intval($_COOKIE['pma_fontsize']);\n        } else {\n            $fontsize = 0;\n        }\n        return (\n            $fontsize +\n            $this->source_mtime +\n            $this->default_source_mtime +\n            $this->get('user_preferences_mtime') +\n            $_SESSION['PMA_Theme']->mtime_info +\n            $_SESSION['PMA_Theme']->filesize_info);\n    }\n\n    /**\n     * $cfg['PmaAbsoluteUri'] is a required directive else cookies won't be\n     * set properly and, depending on browsers, inserting or updating a\n     * record might fail\n     *\n     * @return void\n     */\n    public function checkPmaAbsoluteUri()\n    {\n        // Setup a default value to let the people and lazy sysadmins work anyway,\n        // they'll get an error if the autodetect code doesn't work\n        $pma_absolute_uri = $this->get('PmaAbsoluteUri');\n        $is_https = $this->detectHttps();\n\n        if (/*overload*/mb_strlen($pma_absolute_uri) < 5) {\n            $url = array();\n\n            // If we don't have scheme, we didn't have full URL so we need to\n            // dig deeper\n            if (empty($url['scheme'])) {\n                // Scheme\n                if ($is_https) {\n                    $url['scheme'] = 'https';\n                } else {\n                    $url['scheme'] = 'http';\n                }\n\n                // Host and port\n                if (PMA_getenv('HTTP_HOST')) {\n                    // Prepend the scheme before using parse_url() since this\n                    // is not part of the RFC2616 Host request-header\n                    $parsed_url = parse_url(\n                        $url['scheme'] . '://' . PMA_getenv('HTTP_HOST')\n                    );\n                    if (!empty($parsed_url['host'])) {\n                        $url = $parsed_url;\n                    } else {\n                        $url['host'] = PMA_getenv('HTTP_HOST');\n                    }\n                } elseif (PMA_getenv('SERVER_NAME')) {\n                    $url['host'] = PMA_getenv('SERVER_NAME');\n                } else {\n                    $this->error_pma_uri = true;\n                    return;\n                }\n\n                // If we didn't set port yet...\n                if (empty($url['port']) && PMA_getenv('SERVER_PORT')) {\n                    $url['port'] = PMA_getenv('SERVER_PORT');\n                }\n\n                // And finally the path could be already set from REQUEST_URI\n                if (empty($url['path'])) {\n                    // we got a case with nginx + php-fpm where PHP_SELF\n                    // was not set, so PMA_PHP_SELF was not set as well\n                    if (isset($GLOBALS['PMA_PHP_SELF'])) {\n                        $path = parse_url($GLOBALS['PMA_PHP_SELF']);\n                    } else {\n                        $path = parse_url(PMA_getenv('REQUEST_URI'));\n                    }\n                    $url['path'] = $path['path'];\n                }\n            }\n\n            // Make url from parts we have\n            $pma_absolute_uri = $url['scheme'] . '://';\n            // Was there user information?\n            if (!empty($url['user'])) {\n                $pma_absolute_uri .= $url['user'];\n                if (!empty($url['pass'])) {\n                    $pma_absolute_uri .= ':' . $url['pass'];\n                }\n                $pma_absolute_uri .= '@';\n            }\n            // Add hostname\n            $pma_absolute_uri .= $url['host'];\n            // Add port, if it not the default one\n            // (or 80 for https which is most likely a bug)\n            if (! empty($url['port'])\n                && (($url['scheme'] == 'http' && $url['port'] != 80)\n                || ($url['scheme'] == 'https' && $url['port'] != 80)\n                || ($url['scheme'] == 'https' && $url['port'] != 443))\n            ) {\n                $pma_absolute_uri .= ':' . $url['port'];\n            }\n            // And finally path, without script name, the 'a' is there not to\n            // strip our directory, when path is only /pmadir/ without filename.\n            // Backslashes returned by Windows have to be changed.\n            // Only replace backslashes by forward slashes if on Windows,\n            // as the backslash could be valid on a non-Windows system.\n            $this->checkWebServerOs();\n            if ($this->get('PMA_IS_WINDOWS') == 1) {\n                $path = str_replace(\"\\\\\", \"/\", dirname($url['path'] . 'a'));\n            } else {\n                $path = dirname($url['path'] . 'a');\n            }\n\n            // To work correctly within javascript\n            if (defined('PMA_PATH_TO_BASEDIR') && PMA_PATH_TO_BASEDIR == '../') {\n                if ($this->get('PMA_IS_WINDOWS') == 1) {\n                    $path = str_replace(\"\\\\\", \"/\", dirname($path));\n                } else {\n                    $path = dirname($path);\n                }\n            }\n\n            // PHP's dirname function would have returned a dot\n            // when $path contains no slash\n            if ($path == '.') {\n                $path = '';\n            }\n            // in vhost situations, there could be already an ending slash\n            if (/*overload*/mb_substr($path, -1) != '/') {\n                $path .= '/';\n            }\n            $pma_absolute_uri .= $path;\n\n            // This is to handle the case of a reverse proxy\n            if ($this->get('ForceSSL')) {\n                $this->set('PmaAbsoluteUri', $pma_absolute_uri);\n                $pma_absolute_uri = $this->getSSLUri();\n                $this->isHttps();\n            }\n\n            // We used to display a warning if PmaAbsoluteUri wasn't set, but now\n            // the autodetect code works well enough that we don't display the\n            // warning at all. The user can still set PmaAbsoluteUri manually.\n\n        } else {\n            // The URI is specified, however users do often specify this\n            // wrongly, so we try to fix this.\n\n            // Adds a trailing slash et the end of the phpMyAdmin uri if it\n            // does not exist.\n            if (/*overload*/mb_substr($pma_absolute_uri, -1) != '/') {\n                $pma_absolute_uri .= '/';\n            }\n\n            // If URI doesn't start with http:// or https://, we will add\n            // this.\n            if (/*overload*/mb_substr($pma_absolute_uri, 0, 7) != 'http://'\n                && /*overload*/mb_substr($pma_absolute_uri, 0, 8) != 'https://'\n            ) {\n                $pma_absolute_uri\n                    = ($is_https ? 'https' : 'http')\n                    . ':'\n                    . (\n                        /*overload*/mb_substr($pma_absolute_uri, 0, 2) == '//'\n                        ? ''\n                        : '//'\n                    )\n                    . $pma_absolute_uri;\n            }\n        }\n        $this->set('PmaAbsoluteUri', $pma_absolute_uri);\n    }\n\n    /**\n     * Converts currently used PmaAbsoluteUri to SSL based variant.\n     *\n     * @return String witch adjusted URI\n     */\n    public function getSSLUri()\n    {\n        // grab current URL\n        $url = $this->get('PmaAbsoluteUri');\n        // Parse current URL\n        $parsed = parse_url($url);\n        // In case parsing has failed do stupid string replacement\n        if ($parsed === false) {\n            // Replace http protocol\n            return preg_replace('@^http:@', 'https:', $url);\n        }\n\n        // Reconstruct URL using parsed parts\n        return 'https://' . $parsed['host'] . ':443' . $parsed['path'];\n    }\n\n    /**\n     * Sets collation_connection based on user preference. First is checked\n     * value from request, then cookies with fallback to default.\n     *\n     * After setting it here, cookie is set in common.inc.php to persist\n     * the selection.\n     *\n     * @todo check validity of collation string\n     *\n     * @return void\n     */\n    public function checkCollationConnection()\n    {\n        if (! empty($_REQUEST['collation_connection'])) {\n            $collation = strip_tags($_REQUEST['collation_connection']);\n        } elseif (! empty($_COOKIE['pma_collation_connection'])) {\n            $collation = strip_tags($_COOKIE['pma_collation_connection']);\n        } else {\n            $collation = $this->get('DefaultConnectionCollation');\n        }\n        $this->set('collation_connection', $collation);\n    }\n\n    /**\n     * checks for font size configuration, and sets font size as requested by user\n     *\n     * @return void\n     */\n    public function checkFontsize()\n    {\n        $new_fontsize = '';\n\n        if (isset($_GET['set_fontsize'])) {\n            $new_fontsize = $_GET['set_fontsize'];\n        } elseif (isset($_POST['set_fontsize'])) {\n            $new_fontsize = $_POST['set_fontsize'];\n        } elseif (isset($_COOKIE['pma_fontsize'])) {\n            $new_fontsize = $_COOKIE['pma_fontsize'];\n        }\n\n        if (preg_match('/^[0-9.]+(px|em|pt|\\%)$/', $new_fontsize)) {\n            $this->set('fontsize', $new_fontsize);\n        } elseif (! $this->get('fontsize')) {\n            // 80% would correspond to the default browser font size\n            // of 16, but use 82% to help read the monoface font\n            $this->set('fontsize', '82%');\n        }\n\n        $this->setCookie('pma_fontsize', $this->get('fontsize'), '82%');\n    }\n\n    /**\n     * checks if upload is enabled\n     *\n     * @return void\n     */\n    public function checkUpload()\n    {\n        if (!ini_get('file_uploads')) {\n            $this->set('enable_upload', false);\n            return;\n        }\n\n        $this->set('enable_upload', true);\n        // if set \"php_admin_value file_uploads Off\" in httpd.conf\n        // ini_get() also returns the string \"Off\" in this case:\n        if ('off' == strtolower(ini_get('file_uploads'))) {\n            $this->set('enable_upload', false);\n        }\n    }\n\n    /**\n     * Maximum upload size as limited by PHP\n     * Used with permission from Moodle (http://moodle.org) by Martin Dougiamas\n     *\n     * this section generates $max_upload_size in bytes\n     *\n     * @return void\n     */\n    public function checkUploadSize()\n    {\n        if (! $filesize = ini_get('upload_max_filesize')) {\n            $filesize = \"5M\";\n        }\n\n        if ($postsize = ini_get('post_max_size')) {\n            $this->set(\n                'max_upload_size',\n                min(PMA_getRealSize($filesize), PMA_getRealSize($postsize))\n            );\n        } else {\n            $this->set('max_upload_size', PMA_getRealSize($filesize));\n        }\n    }\n\n    /**\n     * Checks if protocol is https\n     *\n     * This function checks if the https protocol is used in the PmaAbsoluteUri\n     * configuration setting, as opposed to detectHttps() which checks if the\n     * https protocol is used on the active connection.\n     *\n     * @return bool\n     */\n    public function isHttps()\n    {\n\n        if (null !== $this->get('is_https')) {\n            return $this->get('is_https');\n        }\n\n        $url = parse_url($this->get('PmaAbsoluteUri'));\n\n        $is_https = (isset($url['scheme']) && $url['scheme'] == 'https');\n\n        $this->set('is_https', $is_https);\n\n        return $is_https;\n    }\n\n    /**\n     * Detects whether https appears to be used.\n     *\n     * This function checks if the https protocol is used in the current connection\n     * with the webserver, based on environment variables.\n     * Please note that this just detects what we see, so\n     * it completely ignores things like reverse proxies.\n     *\n     * @return bool\n     */\n    public function detectHttps()\n    {\n        $url = array();\n\n        // At first we try to parse REQUEST_URI, it might contain full URL,\n        if (PMA_getenv('REQUEST_URI')) {\n            // produces E_WARNING if it cannot get parsed, e.g. '/foobar:/'\n            $url = @parse_url(PMA_getenv('REQUEST_URI'));\n            if ($url === false) {\n                $url = array();\n            }\n        }\n\n        // If we don't have scheme, we didn't have full URL so we need to\n        // dig deeper\n        if (empty($url['scheme'])) {\n            // Scheme\n            if (PMA_getenv('HTTP_SCHEME')) {\n                $url['scheme'] = PMA_getenv('HTTP_SCHEME');\n            } elseif (PMA_getenv('HTTPS')\n                && strtolower(PMA_getenv('HTTPS')) == 'on'\n            ) {\n                $url['scheme'] = 'https';\n                // A10 Networks load balancer:\n            } elseif (PMA_getenv('HTTP_HTTPS_FROM_LB')\n                && strtolower(PMA_getenv('HTTP_HTTPS_FROM_LB')) == 'on'\n            ) {\n                $url['scheme'] = 'https';\n            } elseif (PMA_getenv('HTTP_X_FORWARDED_PROTO')) {\n                $url['scheme'] = /*overload*/mb_strtolower(\n                    PMA_getenv('HTTP_X_FORWARDED_PROTO')\n                );\n            } elseif (PMA_getenv('HTTP_FRONT_END_HTTPS')\n                && strtolower(PMA_getenv('HTTP_FRONT_END_HTTPS')) == 'on'\n            ) {\n                $url['scheme'] = 'https';\n            } else {\n                $url['scheme'] = 'http';\n            }\n        }\n\n        if (isset($url['scheme']) && $url['scheme'] == 'https') {\n            $is_https = true;\n        } else {\n            $is_https = false;\n        }\n\n        return $is_https;\n    }\n\n    /**\n     * detect correct cookie path\n     *\n     * @return void\n     */\n    public function checkCookiePath()\n    {\n        $this->set('cookie_path', $this->getCookiePath());\n    }\n\n    /**\n     * Get cookie path\n     *\n     * @return string\n     */\n    public function getCookiePath()\n    {\n        static $cookie_path = null;\n\n        if (null !== $cookie_path && !defined('TESTSUITE')) {\n            return $cookie_path;\n        }\n\n        $parsed_url = parse_url($this->get('PmaAbsoluteUri'));\n\n        $cookie_path   = $parsed_url['path'];\n\n        return $cookie_path;\n    }\n\n    /**\n     * enables backward compatibility\n     *\n     * @return void\n     */\n    public function enableBc()\n    {\n        $GLOBALS['cfg']             = $this->settings;\n        $GLOBALS['default_server']  = $this->default_server;\n        unset($this->default_server);\n        $GLOBALS['collation_connection'] = $this->get('collation_connection');\n        $GLOBALS['is_upload']       = $this->get('enable_upload');\n        $GLOBALS['max_upload_size'] = $this->get('max_upload_size');\n        $GLOBALS['cookie_path']     = $this->get('cookie_path');\n        $GLOBALS['is_https']        = $this->get('is_https');\n\n        $defines = array(\n            'PMA_VERSION',\n            'PMA_THEME_VERSION',\n            'PMA_THEME_GENERATION',\n            'PMA_PHP_STR_VERSION',\n            'PMA_PHP_INT_VERSION',\n            'PMA_IS_WINDOWS',\n            'PMA_IS_IIS',\n            'PMA_IS_GD2',\n            'PMA_USR_OS',\n            'PMA_USR_BROWSER_VER',\n            'PMA_USR_BROWSER_AGENT'\n            );\n\n        foreach ($defines as $define) {\n            if (! defined($define)) {\n                define($define, $this->get($define));\n            }\n        }\n    }\n\n    /**\n     * returns options for font size selection\n     *\n     * @param string $current_size current selected font size with unit\n     *\n     * @return array selectable font sizes\n     */\n    protected static function getFontsizeOptions($current_size = '82%')\n    {\n        $unit = preg_replace('/[0-9.]*/', '', $current_size);\n        $value = preg_replace('/[^0-9.]*/', '', $current_size);\n\n        $factors = array();\n        $options = array();\n        $options[\"$value\"] = $value . $unit;\n\n        if ($unit === '%') {\n            $factors[] = 1;\n            $factors[] = 5;\n            $factors[] = 10;\n        } elseif ($unit === 'em') {\n            $factors[] = 0.05;\n            $factors[] = 0.2;\n            $factors[] = 1;\n        } elseif ($unit === 'pt') {\n            $factors[] = 0.5;\n            $factors[] = 2;\n        } elseif ($unit === 'px') {\n            $factors[] = 1;\n            $factors[] = 5;\n            $factors[] = 10;\n        } else {\n            //unknown font size unit\n            $factors[] = 0.05;\n            $factors[] = 0.2;\n            $factors[] = 1;\n            $factors[] = 5;\n            $factors[] = 10;\n        }\n\n        foreach ($factors as $key => $factor) {\n            $option_inc = $value + $factor;\n            $option_dec = $value - $factor;\n            while (count($options) < 21) {\n                $options[\"$option_inc\"] = $option_inc . $unit;\n                if ($option_dec > $factors[0]) {\n                    $options[\"$option_dec\"] = $option_dec . $unit;\n                }\n                $option_inc += $factor;\n                $option_dec -= $factor;\n                if (isset($factors[$key + 1])\n                    && $option_inc >= $value + $factors[$key + 1]\n                ) {\n                    break;\n                }\n            }\n        }\n        ksort($options);\n        return $options;\n    }\n\n    /**\n     * returns html selectbox for font sizes\n     *\n     * @return string html selectbox\n     */\n    protected static function getFontsizeSelection()\n    {\n        $current_size = $GLOBALS['PMA_Config']->get('fontsize');\n        // for the case when there is no config file (this is supported)\n        if (empty($current_size)) {\n            if (isset($_COOKIE['pma_fontsize'])) {\n                $current_size = htmlspecialchars($_COOKIE['pma_fontsize']);\n            } else {\n                $current_size = '82%';\n            }\n        }\n        $options = PMA_Config::getFontsizeOptions($current_size);\n\n        $return = '<label for=\"select_fontsize\">' . __('Font size')\n            . ':</label>' . \"\\n\"\n            . '<select name=\"set_fontsize\" id=\"select_fontsize\"'\n            . ' class=\"autosubmit\">' . \"\\n\";\n        foreach ($options as $option) {\n            $return .= '<option value=\"' . $option . '\"';\n            if ($option == $current_size) {\n                $return .= ' selected=\"selected\"';\n            }\n            $return .= '>' . $option . '</option>' . \"\\n\";\n        }\n        $return .= '</select>';\n\n        return $return;\n    }\n\n    /**\n     * return complete font size selection form\n     *\n     * @return string html selectbox\n     */\n    public static function getFontsizeForm()\n    {\n        return '<form name=\"form_fontsize_selection\" id=\"form_fontsize_selection\"'\n            . ' method=\"get\" action=\"index.php\" class=\"disableAjax\">' . \"\\n\"\n            . PMA_URL_getHiddenInputs() . \"\\n\"\n            . PMA_Config::getFontsizeSelection() . \"\\n\"\n            . '</form>';\n    }\n\n    /**\n     * removes cookie\n     *\n     * @param string $cookie name of cookie to remove\n     *\n     * @return boolean result of setcookie()\n     */\n    public function removeCookie($cookie)\n    {\n        if (defined('TESTSUITE')) {\n            if (isset($_COOKIE[$cookie])) {\n                unset($_COOKIE[$cookie]);\n            }\n            return true;\n        }\n        return setcookie(\n            $cookie,\n            '',\n            time() - 3600,\n            $this->getCookiePath(),\n            '',\n            $this->isHttps()\n        );\n    }\n\n    /**\n     * sets cookie if value is different from current cookie value,\n     * or removes if value is equal to default\n     *\n     * @param string $cookie   name of cookie to remove\n     * @param mixed  $value    new cookie value\n     * @param string $default  default value\n     * @param int    $validity validity of cookie in seconds (default is one month)\n     * @param bool   $httponly whether cookie is only for HTTP (and not for scripts)\n     *\n     * @return boolean result of setcookie()\n     */\n    public function setCookie($cookie, $value, $default = null,\n        $validity = null, $httponly = true\n    ) {\n        if (/*overload*/mb_strlen($value) && null !== $default && $value === $default\n        ) {\n            // default value is used\n            if (isset($_COOKIE[$cookie])) {\n                // remove cookie\n                return $this->removeCookie($cookie);\n            }\n            return false;\n        }\n\n        if (!/*overload*/mb_strlen($value) && isset($_COOKIE[$cookie])) {\n            // remove cookie, value is empty\n            return $this->removeCookie($cookie);\n        }\n\n        if (! isset($_COOKIE[$cookie]) || $_COOKIE[$cookie] !== $value) {\n            // set cookie with new value\n            /* Calculate cookie validity */\n            if ($validity === null) {\n                $validity = time() + 2592000;\n            } elseif ($validity == 0) {\n                $validity = 0;\n            } else {\n                $validity = time() + $validity;\n            }\n            if (defined('TESTSUITE')) {\n                $_COOKIE[$cookie] = $value;\n                return true;\n            }\n            return setcookie(\n                $cookie,\n                $value,\n                $validity,\n                $this->getCookiePath(),\n                '',\n                $this->isHttps(),\n                $httponly\n            );\n        }\n\n        // cookie has already $value as value\n        return true;\n    }\n}\n\n\n/**\n * Error handler to catch fatal errors when loading configuration\n * file\n *\n * @return void\n */\nfunction PMA_Config_fatalErrorHandler()\n{\n    if (isset($GLOBALS['pma_config_loading']) && $GLOBALS['pma_config_loading']) {\n        $error = error_get_last();\n        if ($error !== null) {\n            PMA_fatalError(\n                sprintf(\n                    'Failed to load phpMyAdmin configuration (%s:%s): %s',\n                    PMA_Error::relPath($error['file']),\n                    $error['line'],\n                    $error['message']\n                )\n            );\n        }\n    }\n}\n\nif (!defined('TESTSUITE')) {\n    register_shutdown_function('PMA_Config_fatalErrorHandler');\n}\n", "<?php\n/* vim: set expandtab sw=4 ts=4 sts=4: */\n/**\n * Test for PMA_Config class\n *\n * @package PhpMyAdmin-test\n * @group current\n */\n\n/*\n * Include to test.\n */\nrequire_once 'libraries/core.lib.php';\nrequire_once 'libraries/Util.class.php';\nrequire_once 'libraries/Config.class.php';\nrequire_once 'libraries/relation.lib.php';\nrequire_once 'libraries/Theme.class.php';\nrequire_once 'libraries/vendor_config.php';\nrequire_once 'libraries/url_generating.lib.php';\nrequire_once 'libraries/php-gettext/gettext.inc';\n\n/**\n * Tests behaviour of PMA_Config class\n *\n * @package PhpMyAdmin-test\n */\nclass PMA_ConfigTest extends PHPUnit_Framework_TestCase\n{\n    /**\n     * Turn off backup globals\n     */\n    protected $backupGlobals = false;\n\n    /**\n     * @var PMA_Config\n     */\n    protected $object;\n\n    /**\n     * @var object to test file permission\n     */\n    protected $permTestObj;\n\n    /**\n     * Sets up the fixture, for example, opens a network connection.\n     * This method is called before a test is executed.\n     *\n     * @return void\n     */\n    protected function setUp()\n    {\n        $this->object = new PMA_Config;\n        $GLOBALS['server'] = 0;\n        $_SESSION['is_git_revision'] = true;\n        $GLOBALS['PMA_Config'] = new PMA_Config(CONFIG_FILE);\n\n        //for testing file permissions\n        $this->permTestObj = new PMA_Config(\"./config.sample.inc.php\");\n    }\n\n    /**\n     * Tears down the fixture, for example, closes a network connection.\n     * This method is called after a test is executed.\n     *\n     * @return void\n     */\n    protected function tearDown()\n    {\n        unset($this->object);\n        unset($this->permTestObj);\n    }\n\n    /**\n     * Test for CheckSystem\n     *\n     * @return void\n     * @group medium\n     */\n    public function testCheckSystem()\n    {\n        $this->object->checkSystem();\n\n        $this->assertNotNull($this->object->get('PMA_VERSION'));\n        $this->assertNotEmpty($this->object->get('PMA_THEME_VERSION'));\n        $this->assertNotEmpty($this->object->get('PMA_THEME_GENERATION'));\n    }\n\n    /**\n     * Test for GetFontsizeForm\n     *\n     * @return void\n     */\n    public function testGetFontsizeForm()\n    {\n        $this->assertContains(\n            '<form name=\"form_fontsize_selection\" id=\"form_fontsize_selection\"',\n            PMA_Config::getFontsizeForm()\n        );\n\n        $this->assertContains(\n            '<label for=\"select_fontsize\">',\n            PMA_Config::getFontsizeForm()\n        );\n\n        //test getFontsizeOptions for \"em\" unit\n        $fontsize = $GLOBALS['PMA_Config']->get('fontsize');\n        $GLOBALS['PMA_Config']->set('fontsize', '');\n        $_COOKIE['pma_fontsize'] = \"10em\";\n        $this->assertContains(\n            '<option value=\"7em\"',\n            PMA_Config::getFontsizeForm()\n        );\n        $this->assertContains(\n            '<option value=\"8em\"',\n            PMA_Config::getFontsizeForm()\n        );\n\n        //test getFontsizeOptions for \"pt\" unit\n        $_COOKIE['pma_fontsize'] = \"10pt\";\n        $this->assertContains(\n            '<option value=\"2pt\"',\n            PMA_Config::getFontsizeForm()\n        );\n        $this->assertContains(\n            '<option value=\"4pt\"',\n            PMA_Config::getFontsizeForm()\n        );\n\n        //test getFontsizeOptions for \"px\" unit\n        $_COOKIE['pma_fontsize'] = \"10px\";\n        $this->assertContains(\n            '<option value=\"5px\"',\n            PMA_Config::getFontsizeForm()\n        );\n        $this->assertContains(\n            '<option value=\"6px\"',\n            PMA_Config::getFontsizeForm()\n        );\n\n        //test getFontsizeOptions for unknown unit\n        $_COOKIE['pma_fontsize'] = \"10abc\";\n        $this->assertContains(\n            '<option value=\"7abc\"',\n            PMA_Config::getFontsizeForm()\n        );\n        $this->assertContains(\n            '<option value=\"8abc\"',\n            PMA_Config::getFontsizeForm()\n        );\n        unset($_COOKIE['pma_fontsize']);\n        //rollback the fontsize setting\n        $GLOBALS['PMA_Config']->set('fontsize', $fontsize);\n    }\n\n    /**\n     * Test for checkOutputCompression\n     *\n     * @return void\n     */\n    public function testCheckOutputCompression()\n    {\n\n        $this->object->set('OBGzip', 'auto');\n\n        $this->object->set('PMA_USR_BROWSER_AGENT', 'IE');\n        $this->object->set('PMA_USR_BROWSER_VER', 6);\n        $this->object->checkOutputCompression();\n        $this->assertFalse($this->object->get(\"OBGzip\"));\n\n        $this->object->set('OBGzip', 'auto');\n        $this->object->set('PMA_USR_BROWSER_AGENT', 'MOZILLA');\n        $this->object->set('PMA_USR_BROWSER_VER', 5);\n        $this->object->checkOutputCompression();\n        $this->assertTrue($this->object->get(\"OBGzip\"));\n    }\n\n    /**\n     * Tests client parsing code.\n     *\n     * @param string $agent   User agent string\n     * @param string $os      Expected parsed OS (or null if none)\n     * @param string $browser Expected parsed browser (or null if none)\n     * @param string $version Expected browser version (or null if none)\n     *\n     * @return void\n     *\n     * @dataProvider userAgentProvider\n     */\n    public function testCheckClient($agent, $os, $browser = null, $version = null)\n    {\n        $_SERVER['HTTP_USER_AGENT'] = $agent;\n        $this->object->checkClient();\n        $this->assertEquals($os, $this->object->get('PMA_USR_OS'));\n        if ($os != null) {\n            $this->assertEquals(\n                $browser,\n                $this->object->get('PMA_USR_BROWSER_AGENT')\n            );\n        }\n        if ($version != null) {\n            $this->assertEquals(\n                $version,\n                $this->object->get('PMA_USR_BROWSER_VER')\n            );\n        }\n    }\n\n    /**\n     * user Agent Provider\n     *\n     * @return array\n     */\n    public function userAgentProvider()\n    {\n        return array(\n            array(\n                'Opera/9.80 (X11; Linux x86_64; U; pl) Presto/2.7.62 Version/11.00',\n                'Linux',\n                'OPERA',\n                '9.80',\n            ),\n            array(\n                'Mozilla/5.0 (Macintosh; U; Intel Mac OS X; en-US) AppleWebKit/'\n                . '528.16 OmniWeb/622.8.0.112941',\n                'Mac',\n                'OMNIWEB',\n                '622',\n            ),\n            array(\n                'Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1)',\n                'Win',\n                'IE',\n                '8.0',\n            ),\n            array(\n                'Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Trident/5.0)',\n                'Win',\n                'IE',\n                '9.0',\n            ),\n            array(\n                'Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; Win64; x64; '\n                . 'Trident/6.0)',\n                'Win',\n                'IE',\n                '10.0',\n            ),\n            array(\n                'Mozilla/5.0 (IE 11.0; Windows NT 6.3; Trident/7.0; .NET4.0E; '\n                . '.NET4.0C; rv:11.0) like Gecko',\n                'Win',\n                'IE',\n                '11.0',\n            ),\n            array(\n                'Mozilla/5.0 (Windows NT 6.3; WOW64; Trident/7.0; .NET4.0E; '\n                . '.NET4.0C; .NET CLR 3.5.30729; .NET CLR 2.0.50727; '\n                . '.NET CLR 3.0.30729; InfoPath.3; rv:11.0) like Gecko',\n                'Win',\n                'IE',\n                '11.0',\n            ),\n            array(\n                'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.22 (KHTML, '\n                . 'like Gecko) Chrome/25.0.1364.172 Safari/537.22',\n                'Win',\n                'CHROME',\n                '25.0.1364.172',\n            ),\n            array(\n                'Mozilla/5.0 (Unknown; U; Unix BSD/SYSV system; C -) '\n                . 'AppleWebKit/527+ (KHTML, like Gecko, Safari/419.3) Arora/0.10.2',\n                'Unix',\n                'SAFARI',\n                '5.0.419',\n            ),\n            array(\n                'Mozilla/5.0 (Windows; U; Win95; en-US; rv:1.9b) Gecko/20031208',\n                'Win',\n                'GECKO',\n                '1.9',\n            ),\n            array(\n                'Mozilla/5.0 (compatible; Konqueror/4.5; NetBSD 5.0.2; X11; '\n                . 'amd64; en_US) KHTML/4.5.4 (like Gecko)',\n                'Other',\n                'KONQUEROR',\n            ),\n            array(\n                'Mozilla/5.0 (X11; Linux x86_64; rv:5.0) Gecko/20100101 Firefox/5.0',\n                'Linux',\n                'FIREFOX',\n                '5.0',\n            ),\n            array(\n                'Mozilla/5.0 (X11; Linux x86_64; rv:12.0) Gecko/20100101 '\n                . 'Firefox/12.0',\n                'Linux',\n                'FIREFOX',\n                '12.0',\n            ),\n            /**\n             * @todo Is this version really expected?\n             */\n            array(\n                'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/535.4+ (KHTML, like G'\n                . 'ecko) Version/5.0 Safari/535.4+ SUSE/12.1 (3.2.1) Epiphany/3.2.1',\n                'Linux',\n                'SAFARI',\n                '5.0',\n            ),\n        );\n\n    }\n\n\n    /**\n     * test for CheckGd2\n     *\n     * @return array\n     */\n    public function testCheckGd2()\n    {\n        $prevIsGb2Val = $this->object->get('PMA_IS_GD2');\n\n        $this->object->set('GD2Available', 'yes');\n        $this->object->checkGd2();\n        $this->assertEquals(1, $this->object->get('PMA_IS_GD2'));\n\n        $this->object->set('GD2Available', 'no');\n        $this->object->checkGd2();\n        $this->assertEquals(0, $this->object->get('PMA_IS_GD2'));\n\n        $this->object->set('GD2Available', $prevIsGb2Val);\n\n        if (!@function_exists('imagecreatetruecolor')) {\n            $this->object->checkGd2();\n            $this->assertEquals(\n                0,\n                $this->object->get('PMA_IS_GD2'),\n                'imagecreatetruecolor does not exist, PMA_IS_GD2 should be 0'\n            );\n        }\n\n        if (@function_exists('gd_info')) {\n            $this->object->checkGd2();\n            $gd_nfo = gd_info();\n            if (/*overload*/mb_strstr($gd_nfo[\"GD Version\"], '2.')) {\n                $this->assertEquals(\n                    1,\n                    $this->object->get('PMA_IS_GD2'),\n                    'GD Version >= 2, PMA_IS_GD2 should be 1'\n                );\n            } else {\n                $this->assertEquals(\n                    0,\n                    $this->object->get('PMA_IS_GD2'),\n                    'GD Version < 2, PMA_IS_GD2 should be 0'\n                );\n            }\n        }\n\n        /* Get GD version string from phpinfo output */\n        ob_start();\n        phpinfo(INFO_MODULES); /* Only modules */\n        $a = strip_tags(ob_get_contents());\n        ob_end_clean();\n\n        if (preg_match('@GD Version[[:space:]]*\\(.*\\)@', $a, $v)) {\n            if (/*overload*/mb_strstr($v, '2.')) {\n                $this->assertEquals(\n                    1,\n                    $this->object->get('PMA_IS_GD2'),\n                    'PMA_IS_GD2 should be 1'\n                );\n            } else {\n                $this->assertEquals(\n                    0,\n                    $this->object->get('PMA_IS_GD2'),\n                    'PMA_IS_GD2 should be 0'\n                );\n            }\n        }\n    }\n\n    /**\n     * Web server detection test\n     *\n     * @param string  $server Server identification\n     * @param boolean $iis    Whether server should be detected as IIS\n     *\n     * @return void\n     *\n     * @dataProvider serverNames\n     */\n    public function testCheckWebServer($server, $iis)\n    {\n        $_SERVER['SERVER_SOFTWARE'] = $server;\n        $this->object->checkWebServer();\n        $this->assertEquals($iis, $this->object->get('PMA_IS_IIS'));\n        unset($_SERVER['SERVER_SOFTWARE']);\n    }\n\n\n    /**\n     * return server names\n     *\n     * @return array\n     */\n    public function serverNames()\n    {\n        return array(\n            array(\n                \"Microsoft-IIS 7.0\",\n                1,\n            ),\n            array(\n                \"Apache/2.2.17\",\n                0,\n            ),\n        );\n    }\n\n\n    /**\n     * test for CheckWebServerOs\n     *\n     * @return array\n     */\n    public function testCheckWebServerOs()\n    {\n        $this->object->checkWebServerOs();\n\n        if (defined('PHP_OS')) {\n            if (stristr(PHP_OS, 'darwin')) {\n                $this->assertEquals(0, $this->object->get('PMA_IS_WINDOWS'));\n            } elseif (stristr(PHP_OS, 'win')) {\n                $this->assertEquals(1, $this->object->get('PMA_IS_WINDOWS'));\n            } elseif (stristr(PHP_OS, 'OS/2')) {\n                $this->assertEquals(1, $this->object->get('PMA_IS_WINDOWS'));\n            } elseif (stristr(PHP_OS, 'Linux')) {\n                $this->assertEquals(0, $this->object->get('PMA_IS_WINDOWS'));\n            } else {\n                $this->markTestIncomplete('Not known PHP_OS: ' . PHP_OS);\n            }\n        } else {\n            $this->assertEquals(0, $this->object->get('PMA_IS_WINDOWS'));\n\n            define('PHP_OS', 'Windows');\n            $this->assertEquals(1, $this->object->get('PMA_IS_WINDOWS'));\n        }\n    }\n\n    /**\n     * test for CheckPhpVersion\n     *\n     * @return array\n     */\n    public function testCheckPhpVersion()\n    {\n        $this->object->checkPhpVersion();\n\n        $php_int_ver = 0;\n        $php_str_ver = phpversion();\n\n        $match = array();\n        preg_match(\n            '@([0-9]{1,2}).([0-9]{1,2}).([0-9]{1,2})@',\n            phpversion(),\n            $match\n        );\n        if (isset($match) && ! empty($match[1])) {\n            if (! isset($match[2])) {\n                $match[2] = 0;\n            }\n            if (! isset($match[3])) {\n                $match[3] = 0;\n            }\n            $php_int_ver = (int) sprintf(\n                '%d%02d%02d',\n                $match[1],\n                $match[2],\n                $match[3]\n            );\n        } else {\n            $php_int_ver = 0;\n        }\n\n        $this->assertEquals(\n            $php_str_ver,\n            $this->object->get('PMA_PHP_STR_VERSION')\n        );\n        $this->assertEquals(\n            $php_int_ver,\n            $this->object->get('PMA_PHP_INT_VERSION')\n        );\n    }\n\n    /**\n     * Tests loading of default values\n     *\n     * @return void\n     *\n     * @group large\n     */\n    public function testLoadDefaults()\n    {\n        $prevDefaultSource = $this->object->default_source;\n\n        $this->object->default_source = 'unexisted.file.php';\n        $this->assertFalse($this->object->loadDefaults());\n\n        $this->object->default_source = $prevDefaultSource;\n\n        include $this->object->default_source;\n\n        $loadedConf = $cfg;\n        unset($cfg);\n\n        $this->assertTrue($this->object->loadDefaults());\n\n        $this->assertEquals(\n            $this->object->default_source_mtime,\n            filemtime($prevDefaultSource)\n        );\n        $this->assertEquals(\n            $loadedConf['Servers'][1],\n            $this->object->default_server\n        );\n\n        unset($loadedConf['Servers']);\n\n        $this->assertEquals($loadedConf, $this->object->default);\n\n        $expectedSettings = PMA_arrayMergeRecursive(\n            $this->object->settings,\n            $loadedConf\n        );\n\n        $this->assertEquals(\n            $expectedSettings,\n            $this->object->settings,\n            'Settings loaded wrong'\n        );\n\n        $this->assertFalse($this->object->error_config_default_file);\n    }\n\n    /**\n     * test for CheckConfigSource\n     *\n     * @return array\n     */\n    public function testCheckConfigSource()\n    {\n        $this->object->setSource('unexisted.config.php');\n        $this->assertFalse($this->object->checkConfigSource());\n        $this->assertEquals(0, $this->object->source_mtime);\n\n        $this->object->setSource('libraries/config.default.php');\n\n        $this->assertNotEmpty($this->object->getSource());\n        $this->assertTrue($this->object->checkConfigSource());\n    }\n\n    /**\n     * Test getting and setting config values\n     *\n     * @return void\n     */\n    public function testGetAndSet()\n    {\n        $this->assertNull($this->object->get(\"unresisting_setting\"));\n\n        $this->object->set('test_setting', 'test_value');\n\n        $this->assertEquals('test_value', $this->object->get('test_setting'));\n    }\n\n    /**\n     * Tests setting configuration source\n     *\n     * @return void\n     */\n    public function testGetSetSource()\n    {\n        echo $this->object->getSource();\n\n        $this->assertEmpty($this->object->getSource(), \"Source is null by default\");\n\n        $this->object->setSource(\"config.sample.inc.php\");\n\n        $this->assertEquals(\n            \"config.sample.inc.php\",\n            $this->object->getSource(),\n            \"Cant set new source\"\n        );\n    }\n\n\n    /**\n     * test for CheckPmaAbsoluteUriEmpty\n     *\n     * @return array\n     */\n    public function testCheckPmaAbsoluteUriEmpty()\n    {\n        $this->object->set('PmaAbsoluteUri', '');\n        $this->assertNull(\n            $this->object->checkPmaAbsoluteUri(),\n            'PmaAbsoluteUri is not set and should be error'\n        );\n        $this->assertTrue(\n            $this->object->error_pma_uri,\n            'PmaAbsoluteUri is not set and should be error'\n        );\n    }\n\n    /**\n     * Checks correcting of absolute URI\n     *\n     * @param string $real     Real URI received\n     * @param string $expected Expected corrected URI\n     *\n     * @return void\n     *\n     * @depends testCheckPmaAbsoluteUriEmpty\n     * @dataProvider absoluteUris\n     */\n    public function testCheckPmaAbsoluteUri($real, $expected)\n    {\n        $this->object->set('PmaAbsoluteUri', $real);\n        $this->object->checkPmaAbsoluteUri();\n        $this->assertEquals($expected, $this->object->get('PmaAbsoluteUri'));\n    }\n\n    /**\n     * return absolute Uris\n     *\n     * @return array\n     */\n    public function absoluteUris()\n    {\n        return array(\n            array(\n                'http://localhost/phpmyadmin/',\n                'http://localhost/phpmyadmin/',\n            ),\n            array(\n                'http://localhost/phpmyadmin',\n                'http://localhost/phpmyadmin/',\n            ),\n            array(\n                'localhost/phpmyadmin/',\n                'http://localhost/phpmyadmin/',\n            ),\n            array(\n                'http://user:pwd@localhost/phpmyadmin/index.php',\n                \"http://user:pwd@localhost/phpmyadmin/index.php/\",\n            ),\n            array(\n                'https://user:pwd@localhost/phpmyadmin/index.php',\n                \"https://user:pwd@localhost/phpmyadmin/index.php/\",\n            ),\n        );\n    }\n\n    /**\n     * Test for absolute URI composition\n     *\n     * @return void\n     *\n     * @depends testCheckPmaAbsoluteUri\n     */\n    public function testCheckPmaAbsoluteUriScheme()\n    {\n        $_SERVER['HTTP_HOST'] = 'localhost';\n        $_SERVER['HTTP_SCHEME'] = 'http';\n        $_SERVER['HTTPS'] = 'off';\n        $GLOBALS['PMA_PHP_SELF'] = 'index.php';\n\n        $this->object->set('PmaAbsoluteUri', '');\n\n        $this->object->checkPmaAbsoluteUri();\n        $this->assertEquals(\n            \"http://localhost/\",\n            $this->object->get('PmaAbsoluteUri')\n        );\n    }\n\n    /**\n     * test for CheckCollationConnection\n     *\n     * @return array\n     */\n    public function testCheckCollationConnection()\n    {\n        $_REQUEST['collation_connection'] = 'utf-8';\n        $this->object->checkCollationConnection();\n\n        $this->assertEquals(\n            $_REQUEST['collation_connection'],\n            $this->object->get('collation_connection')\n        );\n    }\n\n    /**\n     * test for IsHttp\n     *\n     * @return array\n     */\n    public function testIsHttps()\n    {\n        $this->object->set('is_https', null);\n        $this->object->set('PmaAbsoluteUri', 'http://some_host.com/phpMyAdmin');\n        $this->assertFalse($this->object->isHttps());\n\n        $this->object->set('is_https', null);\n        $this->object->set('PmaAbsoluteUri', 'https://some_host.com/phpMyAdmin');\n        $this->assertTrue($this->object->isHttps());\n    }\n\n    /**\n     * test for DetectHttps\n     *\n     * @return array\n     */\n    public function testDetectHttps()\n    {\n        unset($_SERVER['REQUEST_URI']);\n        unset($_SERVER['HTTP_SCHEME']);\n        unset($_SERVER['HTTPS']);\n\n        $this->assertFalse($this->object->detectHttps());\n\n        $_SERVER['REQUEST_URI'] = '/url:\\this_is_not_url';\n        $this->assertFalse($this->object->detectHttps());\n\n        $_SERVER['REQUEST_URI'] = 'file://localhost/phpmyadmin/index.php';\n        $this->assertFalse($this->object->detectHttps());\n\n        $_ENV['REQUEST_URI'] = 'http://localhost/phpmyadmin/index.php';\n        $this->assertFalse($this->object->detectHttps());\n\n        $_SERVER['REQUEST_URI'] = 'https://localhost/phpmyadmin/index.php';\n        $this->assertTrue($this->object->detectHttps());\n\n        $_SERVER['REQUEST_URI'] = 'localhost/phpmyadmin/index.php';\n        $_SERVER['HTTP_SCHEME'] = 'https';\n        $_SERVER['HTTPS'] = 'on';\n        $this->assertTrue($this->object->detectHttps());\n    }\n\n    /**\n     * Test for checking cookie path\n     *\n     * @return void\n     *\n     * @depends testDetectHttps\n     */\n    public function testCheckCookiePath()\n    {\n        $this->object->checkCookiePath();\n        echo $this->object->get('cookie_path');\n        $this->assertEquals('', $this->object->get('cookie_path'));\n    }\n\n    /**\n     * Test for backward compatibility globals\n     *\n     * @return void\n     *\n     * @depends testCheckSystem\n     * @depends testCheckWebServer\n     * @depends testLoadDefaults\n     *\n     * @group large\n     */\n    public function testEnableBc()\n    {\n        $this->object->enableBc();\n\n        $defines = array(\n            'PMA_VERSION',\n            'PMA_THEME_VERSION',\n            'PMA_THEME_GENERATION',\n            'PMA_PHP_STR_VERSION',\n            'PMA_PHP_INT_VERSION',\n            'PMA_IS_WINDOWS',\n            'PMA_IS_IIS',\n            'PMA_IS_GD2',\n            'PMA_USR_OS',\n            'PMA_USR_BROWSER_VER',\n            'PMA_USR_BROWSER_AGENT'\n            );\n\n        foreach ($defines as $define) {\n            $this->assertTrue(defined($define));\n            $this->assertEquals(constant($define), $this->object->get($define));\n        }\n    }\n\n    /**\n     * Test for getting cookie path\n     *\n     * @param string $absolute The absolute URL used for phpMyAdmin\n     * @param string $expected Expected cookie path\n     *\n     * @return void\n     *\n     * @dataProvider cookieUris\n     */\n    public function testGetCookiePath($absolute, $expected)\n    {\n        $this->object->set('PmaAbsoluteUri', $absolute);\n        $this->assertEquals($expected, $this->object->getCookiePath());\n    }\n\n    /**\n     * Data provider for testGetCookiePath\n     *\n     * @return array data for testGetCookiePath\n     */\n    public function cookieUris()\n    {\n        return array(\n            array(\n                'http://example.net/phpmyadmin/',\n                '/phpmyadmin/',\n            ),\n            array(\n                'http://example.net/',\n                '/',\n            ),\n        );\n    }\n\n    /**\n     * Tests loading of config file\n     *\n     * @param string  $source File name of config to load\n     * @param boolean $result Expected result of loading\n     *\n     * @return void\n     *\n     * @dataProvider configPaths\n     */\n    public function testLoad($source, $result)\n    {\n        if ($result) {\n            $this->assertTrue($this->object->load($source));\n        } else {\n            $this->assertFalse($this->object->load($source));\n        }\n    }\n\n    /**\n     * return of config Paths\n     *\n     * @return array\n     */\n    public function configPaths()\n    {\n        return array(\n            array(\n                './test/test_data/config.inc.php',\n                true,\n            ),\n            array(\n                './test/test_data/config-nonexisting.inc.php',\n                false,\n            ),\n            array(\n                './libraries/config.default.php',\n                true,\n            ),\n        );\n    }\n\n    /**\n     * Test for loading user preferences\n     *\n     * @return void\n     * @todo Test actually preferences loading\n     */\n    public function testLoadUserPreferences()\n    {\n        $this->assertNull($this->object->loadUserPreferences());\n    }\n\n    /**\n     * Test for setting user config value\n     *\n     * @return void\n     */\n    public function testSetUserValue()\n    {\n        $this->object->setUserValue(null, 'lang', 'cs', 'en');\n        $this->object->setUserValue(\"TEST_COOKIE_USER_VAL\", '', 'cfg_val_1');\n        $this->assertEquals(\n            $this->object->getUserValue(\"TEST_COOKIE_USER_VAL\", 'fail'),\n            'cfg_val_1'\n        );\n    }\n\n    /**\n     * Test for getting user config value\n     *\n     * @return void\n     */\n    public function testGetUserValue()\n    {\n        $this->assertEquals($this->object->getUserValue('test_val', 'val'), 'val');\n    }\n\n    /**\n     * Should test getting unique value for theme\n     *\n     * @return void\n     */\n    public function testGetThemeUniqueValue()\n    {\n\n        $_SESSION['PMA_Theme'] = PMA_Theme::load('./themes/pmahomme');\n\n        $partial_sum = (\n            PHPUnit_Framework_Assert::readAttribute($this->object, 'source_mtime') +\n            PHPUnit_Framework_Assert::readAttribute(\n                $this->object,\n                'default_source_mtime'\n            ) +\n            $this->object->get('user_preferences_mtime') +\n            $_SESSION['PMA_Theme']->mtime_info +\n            $_SESSION['PMA_Theme']->filesize_info\n        );\n\n        $this->object->set('fontsize', 10);\n        $this->assertEquals(10 + $partial_sum, $this->object->getThemeUniqueValue());\n        $this->object->set('fontsize', null);\n\n        $_COOKIE['pma_fontsize'] = 20;\n        $this->assertEquals(20 + $partial_sum, $this->object->getThemeUniqueValue());\n        unset($_COOKIE['pma_fontsize']);\n\n        $this->assertEquals($partial_sum, $this->object->getThemeUniqueValue());\n\n    }\n\n    /**\n     * Should test checking of config permissions\n     *\n     * @return void\n     */\n    public function testCheckPermissions()\n    {\n        //load file permissions for the current permissions file\n        $perms = @fileperms($this->object->getSource());\n        //testing for permissions for no configuration file\n        $this->assertFalse(!($perms === false) && ($perms & 2));\n\n        //load file permissions for the current permissions file\n        $perms = @fileperms($this->permTestObj->getSource());\n        //testing for permissions\n        $this->assertFalse(!($perms === false) && ($perms & 2));\n\n        //if the above assertion is false then applying further assertions\n        if (!($perms === false) && ($perms & 2)) {\n            $this->assertFalse($this->permTestObj->get('PMA_IS_WINDOWS') == 0);\n        }\n    }\n\n\n    /**\n     * Test for setting cookies\n     *\n     * @return void\n     */\n    public function testSetCookie()\n    {\n        $this->assertFalse(\n            $this->object->setCookie(\n                'TEST_DEF_COOKIE',\n                'test_def_123',\n                'test_def_123'\n            )\n        );\n\n        $this->assertTrue(\n            $this->object->setCookie(\n                'TEST_CONFIG_COOKIE',\n                'test_val_123',\n                null,\n                3600\n            )\n        );\n\n        $this->assertTrue(\n            $this->object->setCookie(\n                'TEST_CONFIG_COOKIE',\n                '',\n                'default_val'\n            )\n        );\n\n        $_COOKIE['TEST_MANUAL_COOKIE'] = 'some_test_val';\n        $this->assertTrue(\n            $this->object->setCookie(\n                'TEST_MANUAL_COOKIE',\n                'other',\n                'other'\n            )\n        );\n\n    }\n\n    /**\n     * Test for isGitRevision\n     *\n     * @return void\n     */\n    public function testIsGitRevision()\n    {\n        $this->assertTrue(\n            $this->object->isGitRevision()\n        );\n    }\n\n    /**\n     * Test for Check HTTP\n     *\n     * @group medium\n     *\n     * @return void\n     */\n    public function testCheckHTTP()\n    {\n        if (! function_exists('curl_init')) {\n            $this->markTestSkipped('Missing curl extension!');\n        }\n        $this->assertTrue(\n            $this->object->checkHTTP(\"http://www.phpmyadmin.net/test/data\")\n        );\n        $this->assertContains(\n            \"TEST DATA\",\n            $this->object->checkHTTP(\"http://www.phpmyadmin.net/test/data\", true)\n        );\n        $this->assertFalse(\n            $this->object->checkHTTP(\"http://www.phpmyadmin.net/test/nothing\")\n        );\n    }\n\n    /**\n     * Tests for rewriting URL to SSL variant\n     *\n     * @param string $original Original URL\n     * @param string $expected Expected URL rewritten to SSL\n     *\n     * @return void\n     *\n     * @dataProvider sslUris\n     */\n    public function testSSLUri($original, $expected)\n    {\n        $this->object->set('PmaAbsoluteUri', $original);\n        $this->assertEquals($expected, $this->object->getSSLUri());\n    }\n\n\n    /**\n     * return of ssl Uris\n     *\n     * @return array\n     */\n    public function sslUris()\n    {\n        return array(\n            array(\n                'http://server.foo/path/',\n                'https://server.foo:443/path/'\n            ),\n            array(\n                'http://server.foo:80/path/',\n                'https://server.foo:443/path/'\n            ),\n            array(\n                'http://server.foo.bar:123/path/',\n                'https://server.foo.bar:443/path/'\n            ),\n            array(\n                'http://[FEDC:BA98:7654:3210:FEDC:BA98:7654:3210]:80/',\n                'https://[FEDC:BA98:7654:3210:FEDC:BA98:7654:3210]:443/'\n            ),\n            );\n    }\n}\n"], "fixing_code": ["<?php\n/* vim: set expandtab sw=4 ts=4 sts=4: */\n/**\n * Configuration handling.\n *\n * @package PhpMyAdmin\n */\n\nif (! defined('PHPMYADMIN')) {\n    exit;\n}\n\n/**\n * Load vendor configuration.\n */\nrequire_once './libraries/vendor_config.php';\n\n/**\n * Indication for error handler (see end of this file).\n */\n$GLOBALS['pma_config_loading'] = false;\n\n/**\n * Configuration class\n *\n * @package PhpMyAdmin\n */\nclass PMA_Config\n{\n    /**\n     * @var string  default config source\n     */\n    var $default_source = './libraries/config.default.php';\n\n    /**\n     * @var array   default configuration settings\n     */\n    var $default = array();\n\n    /**\n     * @var array   configuration settings, without user preferences applied\n     */\n    var $base_settings = array();\n\n    /**\n     * @var array   configuration settings\n     */\n    var $settings = array();\n\n    /**\n     * @var string  config source\n     */\n    var $source = '';\n\n    /**\n     * @var int     source modification time\n     */\n    var $source_mtime = 0;\n    var $default_source_mtime = 0;\n    var $set_mtime = 0;\n\n    /**\n     * @var boolean\n     */\n    var $error_config_file = false;\n\n    /**\n     * @var boolean\n     */\n    var $error_config_default_file = false;\n\n    /**\n     * @var boolean\n     */\n    var $error_pma_uri = false;\n\n    /**\n     * @var array\n     */\n    var $default_server = array();\n\n    /**\n     * @var boolean whether init is done or not\n     * set this to false to force some initial checks\n     * like checking for required functions\n     */\n    var $done = false;\n\n    /**\n     * constructor\n     *\n     * @param string $source source to read config from\n     */\n    public function __construct($source = null)\n    {\n        $this->settings = array();\n\n        // functions need to refresh in case of config file changed goes in\n        // PMA_Config::load()\n        $this->load($source);\n\n        // other settings, independent from config file, comes in\n        $this->checkSystem();\n\n        $this->isHttps();\n\n        $this->base_settings = $this->settings;\n    }\n\n    /**\n     * sets system and application settings\n     *\n     * @return void\n     */\n    public function checkSystem()\n    {\n        $this->set('PMA_VERSION', '4.5.5');\n        /**\n         * @deprecated\n         */\n        $this->set('PMA_THEME_VERSION', 2);\n        /**\n         * @deprecated\n         */\n        $this->set('PMA_THEME_GENERATION', 2);\n\n        $this->checkPhpVersion();\n        $this->checkWebServerOs();\n        $this->checkWebServer();\n        $this->checkGd2();\n        $this->checkClient();\n        $this->checkUpload();\n        $this->checkUploadSize();\n        $this->checkOutputCompression();\n    }\n\n    /**\n     * whether to use gzip output compression or not\n     *\n     * @return void\n     */\n    public function checkOutputCompression()\n    {\n        // If zlib output compression is set in the php configuration file, no\n        // output buffering should be run\n        if (@ini_get('zlib.output_compression')) {\n            $this->set('OBGzip', false);\n        }\n\n        // disable output-buffering (if set to 'auto') for IE6, else enable it.\n        if (strtolower($this->get('OBGzip')) == 'auto') {\n            if ($this->get('PMA_USR_BROWSER_AGENT') == 'IE'\n                && $this->get('PMA_USR_BROWSER_VER') >= 6\n                && $this->get('PMA_USR_BROWSER_VER') < 7\n            ) {\n                $this->set('OBGzip', false);\n            } else {\n                $this->set('OBGzip', true);\n            }\n        }\n    }\n\n    /**\n     * Sets the client platform based on user agent\n     *\n     * @param string $user_agent the user agent\n     *\n     * @return void\n     */\n    private function _setClientPlatform($user_agent)\n    {\n        if (/*overload*/mb_strstr($user_agent, 'Win')) {\n            $this->set('PMA_USR_OS', 'Win');\n        } elseif (/*overload*/mb_strstr($user_agent, 'Mac')) {\n            $this->set('PMA_USR_OS', 'Mac');\n        } elseif (/*overload*/mb_strstr($user_agent, 'Linux')) {\n            $this->set('PMA_USR_OS', 'Linux');\n        } elseif (/*overload*/mb_strstr($user_agent, 'Unix')) {\n            $this->set('PMA_USR_OS', 'Unix');\n        } elseif (/*overload*/mb_strstr($user_agent, 'OS/2')) {\n            $this->set('PMA_USR_OS', 'OS/2');\n        } else {\n            $this->set('PMA_USR_OS', 'Other');\n        }\n    }\n\n    /**\n     * Determines platform (OS), browser and version of the user\n     * Based on a phpBuilder article:\n     *\n     * @see http://www.phpbuilder.net/columns/tim20000821.php\n     *\n     * @return void\n     */\n    public function checkClient()\n    {\n        if (PMA_getenv('HTTP_USER_AGENT')) {\n            $HTTP_USER_AGENT = PMA_getenv('HTTP_USER_AGENT');\n        } else {\n            $HTTP_USER_AGENT = '';\n        }\n\n        // 1. Platform\n        $this->_setClientPlatform($HTTP_USER_AGENT);\n\n        // 2. browser and version\n        // (must check everything else before Mozilla)\n\n        $is_mozilla = preg_match(\n            '@Mozilla/([0-9].[0-9]{1,2})@',\n            $HTTP_USER_AGENT,\n            $mozilla_version\n        );\n\n        if (preg_match(\n            '@Opera(/| )([0-9].[0-9]{1,2})@',\n            $HTTP_USER_AGENT,\n            $log_version\n        )) {\n            $this->set('PMA_USR_BROWSER_VER', $log_version[2]);\n            $this->set('PMA_USR_BROWSER_AGENT', 'OPERA');\n        } elseif (preg_match(\n            '@(MS)?IE ([0-9]{1,2}.[0-9]{1,2})@',\n            $HTTP_USER_AGENT,\n            $log_version\n        )) {\n            $this->set('PMA_USR_BROWSER_VER', $log_version[2]);\n            $this->set('PMA_USR_BROWSER_AGENT', 'IE');\n        } elseif (preg_match(\n            '@Trident/(7)\\.0@',\n            $HTTP_USER_AGENT,\n            $log_version\n        )) {\n            $this->set('PMA_USR_BROWSER_VER', intval($log_version[1]) + 4);\n            $this->set('PMA_USR_BROWSER_AGENT', 'IE');\n        } elseif (preg_match(\n            '@OmniWeb/([0-9].[0-9]{1,2})@',\n            $HTTP_USER_AGENT,\n            $log_version\n        )) {\n            $this->set('PMA_USR_BROWSER_VER', $log_version[1]);\n            $this->set('PMA_USR_BROWSER_AGENT', 'OMNIWEB');\n            // Konqueror 2.2.2 says Konqueror/2.2.2\n            // Konqueror 3.0.3 says Konqueror/3\n        } elseif (preg_match(\n            '@(Konqueror/)(.*)(;)@',\n            $HTTP_USER_AGENT,\n            $log_version\n        )) {\n            $this->set('PMA_USR_BROWSER_VER', $log_version[2]);\n            $this->set('PMA_USR_BROWSER_AGENT', 'KONQUEROR');\n            // must check Chrome before Safari\n        } elseif ($is_mozilla\n            && preg_match('@Chrome/([0-9.]*)@', $HTTP_USER_AGENT, $log_version)\n        ) {\n            $this->set('PMA_USR_BROWSER_VER', $log_version[1]);\n            $this->set('PMA_USR_BROWSER_AGENT', 'CHROME');\n            // newer Safari\n        } elseif ($is_mozilla\n            && preg_match('@Version/(.*) Safari@', $HTTP_USER_AGENT, $log_version)\n        ) {\n            $this->set(\n                'PMA_USR_BROWSER_VER', $log_version[1]\n            );\n            $this->set('PMA_USR_BROWSER_AGENT', 'SAFARI');\n            // older Safari\n        } elseif ($is_mozilla\n            && preg_match('@Safari/([0-9]*)@', $HTTP_USER_AGENT, $log_version)\n        ) {\n            $this->set(\n                'PMA_USR_BROWSER_VER', $mozilla_version[1] . '.' . $log_version[1]\n            );\n            $this->set('PMA_USR_BROWSER_AGENT', 'SAFARI');\n            // Firefox\n        } elseif (! /*overload*/mb_strstr($HTTP_USER_AGENT, 'compatible')\n            && preg_match('@Firefox/([\\w.]+)@', $HTTP_USER_AGENT, $log_version)\n        ) {\n            $this->set(\n                'PMA_USR_BROWSER_VER', $log_version[1]\n            );\n            $this->set('PMA_USR_BROWSER_AGENT', 'FIREFOX');\n        } elseif (preg_match('@rv:1.9(.*)Gecko@', $HTTP_USER_AGENT)) {\n            $this->set('PMA_USR_BROWSER_VER', '1.9');\n            $this->set('PMA_USR_BROWSER_AGENT', 'GECKO');\n        } elseif ($is_mozilla) {\n            $this->set('PMA_USR_BROWSER_VER', $mozilla_version[1]);\n            $this->set('PMA_USR_BROWSER_AGENT', 'MOZILLA');\n        } else {\n            $this->set('PMA_USR_BROWSER_VER', 0);\n            $this->set('PMA_USR_BROWSER_AGENT', 'OTHER');\n        }\n    }\n\n    /**\n     * Whether GD2 is present\n     *\n     * @return void\n     */\n    public function checkGd2()\n    {\n        if ($this->get('GD2Available') == 'yes') {\n            $this->set('PMA_IS_GD2', 1);\n            return;\n        }\n\n        if ($this->get('GD2Available') == 'no') {\n            $this->set('PMA_IS_GD2', 0);\n            return;\n        }\n\n        if (!@function_exists('imagecreatetruecolor')) {\n            $this->set('PMA_IS_GD2', 0);\n            return;\n        }\n\n        if (@function_exists('gd_info')) {\n            $gd_nfo = gd_info();\n            if (/*overload*/mb_strstr($gd_nfo[\"GD Version\"], '2.')) {\n                $this->set('PMA_IS_GD2', 1);\n            } else {\n                $this->set('PMA_IS_GD2', 0);\n            }\n        } else {\n            $this->set('PMA_IS_GD2', 0);\n        }\n    }\n\n    /**\n     * Whether the Web server php is running on is IIS\n     *\n     * @return void\n     */\n    public function checkWebServer()\n    {\n        // some versions return Microsoft-IIS, some Microsoft/IIS\n        // we could use a preg_match() but it's slower\n        if (PMA_getenv('SERVER_SOFTWARE')\n            && stristr(PMA_getenv('SERVER_SOFTWARE'), 'Microsoft')\n            && stristr(PMA_getenv('SERVER_SOFTWARE'), 'IIS')\n        ) {\n            $this->set('PMA_IS_IIS', 1);\n        } else {\n            $this->set('PMA_IS_IIS', 0);\n        }\n    }\n\n    /**\n     * Whether the os php is running on is windows or not\n     *\n     * @return void\n     */\n    public function checkWebServerOs()\n    {\n        // Default to Unix or Equiv\n        $this->set('PMA_IS_WINDOWS', 0);\n        // If PHP_OS is defined then continue\n        if (defined('PHP_OS')) {\n            if (stristr(PHP_OS, 'win') && !stristr(PHP_OS, 'darwin')) {\n                // Is it some version of Windows\n                $this->set('PMA_IS_WINDOWS', 1);\n            } elseif (stristr(PHP_OS, 'OS/2')) {\n                // Is it OS/2 (No file permissions like Windows)\n                $this->set('PMA_IS_WINDOWS', 1);\n            }\n        }\n    }\n\n    /**\n     * detects PHP version\n     *\n     * @return void\n     */\n    public function checkPhpVersion()\n    {\n        $match = array();\n        if (! preg_match(\n            '@([0-9]{1,2}).([0-9]{1,2}).([0-9]{1,2})@',\n            phpversion(),\n            $match\n        )) {\n            preg_match(\n                '@([0-9]{1,2}).([0-9]{1,2})@',\n                phpversion(),\n                $match\n            );\n        }\n        if (isset($match) && ! empty($match[1])) {\n            if (! isset($match[2])) {\n                $match[2] = 0;\n            }\n            if (! isset($match[3])) {\n                $match[3] = 0;\n            }\n            $this->set(\n                'PMA_PHP_INT_VERSION',\n                (int) sprintf('%d%02d%02d', $match[1], $match[2], $match[3])\n            );\n        } else {\n            $this->set('PMA_PHP_INT_VERSION', 0);\n        }\n        $this->set('PMA_PHP_STR_VERSION', phpversion());\n    }\n\n    /**\n     * detects if Git revision\n     *\n     * @return boolean\n     */\n    public function isGitRevision()\n    {\n        if (!$this->get('ShowGitRevision')) {\n            return false;\n        }\n\n        // caching\n        if (isset($_SESSION['is_git_revision'])) {\n            if ($_SESSION['is_git_revision']) {\n                $this->set('PMA_VERSION_GIT', 1);\n            }\n            return $_SESSION['is_git_revision'];\n        }\n        // find out if there is a .git folder\n        $git_folder = '.git';\n        if (! @file_exists($git_folder)\n            || ! @file_exists($git_folder . '/config')\n        ) {\n            $_SESSION['is_git_revision'] = false;\n            return false;\n        }\n        $_SESSION['is_git_revision'] = true;\n        return true;\n    }\n\n    /**\n     * detects Git revision, if running inside repo\n     *\n     * @return void\n     */\n    public function checkGitRevision()\n    {\n        // find out if there is a .git folder\n        $git_folder = '.git';\n        if (! $this->isGitRevision()) {\n            return;\n        }\n\n        if (! $ref_head = @file_get_contents($git_folder . '/HEAD')) {\n            return;\n        }\n\n        $branch = false;\n        // are we on any branch?\n        if (/*overload*/mb_strstr($ref_head, '/')) {\n            $ref_head = /*overload*/mb_substr(trim($ref_head), 5);\n            if (substr($ref_head, 0, 11) === 'refs/heads/') {\n                $branch = /*overload*/mb_substr($ref_head, 11);\n            } else {\n                $branch = basename($ref_head);\n            }\n\n            $ref_file = $git_folder . '/' . $ref_head;\n            if (@file_exists($ref_file)) {\n                $hash = @file_get_contents($ref_file);\n                if (! $hash) {\n                    return;\n                }\n                $hash = trim($hash);\n            } else {\n                // deal with packed refs\n                $packed_refs = @file_get_contents($git_folder . '/packed-refs');\n                if (! $packed_refs) {\n                    return;\n                }\n                // split file to lines\n                $ref_lines = explode(\"\\n\", $packed_refs);\n                foreach ($ref_lines as $line) {\n                    // skip comments\n                    if ($line[0] == '#') {\n                        continue;\n                    }\n                    // parse line\n                    $parts = explode(' ', $line);\n                    // care only about named refs\n                    if (count($parts) != 2) {\n                        continue;\n                    }\n                    // have found our ref?\n                    if ($parts[1] == $ref_head) {\n                        $hash = $parts[0];\n                        break;\n                    }\n                }\n                if (! isset($hash)) {\n                    // Could not find ref\n                    return;\n                }\n            }\n        } else {\n            $hash = trim($ref_head);\n        }\n\n        $commit = false;\n        if (isset($_SESSION['PMA_VERSION_COMMITDATA_' . $hash])) {\n            $commit = $_SESSION['PMA_VERSION_COMMITDATA_' . $hash];\n        } elseif (function_exists('gzuncompress')) {\n            $git_file_name = $git_folder . '/objects/'\n                . substr($hash, 0, 2) . '/' . substr($hash, 2);\n            if (file_exists($git_file_name) ) {\n                if (! $commit = @file_get_contents($git_file_name)) {\n                    return;\n                }\n                $commit = explode(\"\\0\", gzuncompress($commit), 2);\n                $commit = explode(\"\\n\", $commit[1]);\n                $_SESSION['PMA_VERSION_COMMITDATA_' . $hash] = $commit;\n            } else {\n                $pack_names = array();\n                // work with packed data\n                $packs_file = $git_folder . '/objects/info/packs';\n                if (file_exists($packs_file)\n                    && $packs = @file_get_contents($packs_file)\n                ) {\n                    // File exists. Read it, parse the file to get the names of the\n                    // packs. (to look for them in .git/object/pack directory later)\n                    foreach (explode(\"\\n\", $packs) as $line) {\n                        // skip blank lines\n                        if (strlen(trim($line)) == 0) {\n                            continue;\n                        }\n                        // skip non pack lines\n                        if ($line[0] != 'P') {\n                            continue;\n                        }\n                        // parse names\n                        $pack_names[] = substr($line, 2);\n                    }\n                } else {\n                    // '.git/objects/info/packs' file can be missing\n                    // (atlease in mysGit)\n                    // File missing. May be we can look in the .git/object/pack\n                    // directory for all the .pack files and use that list of\n                    // files instead\n                    $dirIterator = new DirectoryIterator(\n                        $git_folder . '/objects/pack'\n                    );\n                    foreach ($dirIterator as $file_info) {\n                        $file_name = $file_info->getFilename();\n                        // if this is a .pack file\n                        if ($file_info->isFile() && substr($file_name, -5) == '.pack'\n                        ) {\n                            $pack_names[] = $file_name;\n                        }\n                    }\n                }\n                $hash = strtolower($hash);\n                foreach ($pack_names as $pack_name) {\n                    $index_name = str_replace('.pack', '.idx', $pack_name);\n\n                    // load index\n                    $index_data = @file_get_contents(\n                        $git_folder . '/objects/pack/' . $index_name\n                    );\n                    if (! $index_data) {\n                        continue;\n                    }\n                    // check format\n                    if (substr($index_data, 0, 4) != \"\\377tOc\") {\n                        continue;\n                    }\n                    // check version\n                    $version = unpack('N', substr($index_data, 4, 4));\n                    if ($version[1] != 2) {\n                        continue;\n                    }\n                    // parse fanout table\n                    $fanout = unpack(\n                        \"N*\",\n                        substr($index_data, 8, 256 * 4)\n                    );\n\n                    // find where we should search\n                    $firstbyte = intval(substr($hash, 0, 2), 16);\n                    // array is indexed from 1 and we need to get\n                    // previous entry for start\n                    if ($firstbyte == 0) {\n                        $start = 0;\n                    } else {\n                        $start = $fanout[$firstbyte];\n                    }\n                    $end = $fanout[$firstbyte + 1];\n\n                    // stupid linear search for our sha\n                    $found = false;\n                    $offset = 8 + (256 * 4);\n                    for ($position = $start; $position < $end; $position++) {\n                        $sha = strtolower(\n                            bin2hex(\n                                substr($index_data, $offset + ($position * 20), 20)\n                            )\n                        );\n                        if ($sha == $hash) {\n                            $found = true;\n                            break;\n                        }\n                    }\n                    if (! $found) {\n                        continue;\n                    }\n                    // read pack offset\n                    $offset = 8 + (256 * 4) + (24 * $fanout[256]);\n                    $pack_offset = unpack(\n                        'N',\n                        substr($index_data, $offset + ($position * 4), 4)\n                    );\n                    $pack_offset = $pack_offset[1];\n\n                    // open pack file\n                    $pack_file = fopen(\n                        $git_folder . '/objects/pack/' . $pack_name, 'rb'\n                    );\n                    if ($pack_file === false) {\n                        continue;\n                    }\n                    // seek to start\n                    fseek($pack_file, $pack_offset);\n\n                    // parse header\n                    $header = ord(fread($pack_file, 1));\n                    $type = ($header >> 4) & 7;\n                    $hasnext = ($header & 128) >> 7;\n                    $size = $header & 0xf;\n                    $offset = 4;\n\n                    while ($hasnext) {\n                        $byte = ord(fread($pack_file, 1));\n                        $size |= ($byte & 0x7f) << $offset;\n                        $hasnext = ($byte & 128) >> 7;\n                        $offset += 7;\n                    }\n\n                    // we care only about commit objects\n                    if ($type != 1) {\n                        continue;\n                    }\n\n                    // read data\n                    $commit = fread($pack_file, $size);\n                    $commit = gzuncompress($commit);\n                    $commit = explode(\"\\n\", $commit);\n                    $_SESSION['PMA_VERSION_COMMITDATA_' . $hash] = $commit;\n                    fclose($pack_file);\n                }\n            }\n        }\n\n        // check if commit exists in Github\n        if ($commit !== false\n            && isset($_SESSION['PMA_VERSION_REMOTECOMMIT_' . $hash])\n        ) {\n            $is_remote_commit = $_SESSION['PMA_VERSION_REMOTECOMMIT_' . $hash];\n        } else {\n            $link = 'https://api.github.com/repos/phpmyadmin/phpmyadmin/git/commits/'\n                . $hash;\n            $is_found = $this->checkHTTP($link, ! $commit);\n            switch($is_found) {\n            case false:\n                $is_remote_commit = false;\n                $_SESSION['PMA_VERSION_REMOTECOMMIT_' . $hash] = false;\n                break;\n            case null:\n                // no remote link for now, but don't cache this as Github is down\n                $is_remote_commit = false;\n                break;\n            default:\n                $is_remote_commit = true;\n                $_SESSION['PMA_VERSION_REMOTECOMMIT_' . $hash] = true;\n                if ($commit === false) {\n                    // if no local commit data, try loading from Github\n                    $commit_json = json_decode($is_found);\n                }\n                break;\n            }\n        }\n\n        $is_remote_branch = false;\n        if ($is_remote_commit && $branch !== false) {\n            // check if branch exists in Github\n            if (isset($_SESSION['PMA_VERSION_REMOTEBRANCH_' . $hash])) {\n                $is_remote_branch = $_SESSION['PMA_VERSION_REMOTEBRANCH_' . $hash];\n            } else {\n                $link = 'https://api.github.com/repos/phpmyadmin/phpmyadmin'\n                    . '/git/trees/' . $branch;\n                $is_found = $this->checkHTTP($link);\n                switch($is_found) {\n                case true:\n                    $is_remote_branch = true;\n                    $_SESSION['PMA_VERSION_REMOTEBRANCH_' . $hash] = true;\n                    break;\n                case false:\n                    $is_remote_branch = false;\n                    $_SESSION['PMA_VERSION_REMOTEBRANCH_' . $hash] = false;\n                    break;\n                case null:\n                    // no remote link for now, but don't cache this as Github is down\n                    $is_remote_branch = false;\n                    break;\n                }\n            }\n        }\n\n        if ($commit !== false) {\n            $author = array('name' => '', 'email' => '', 'date' => '');\n            $committer = array('name' => '', 'email' => '', 'date' => '');\n\n            do {\n                $dataline = array_shift($commit);\n                $datalinearr = explode(' ', $dataline, 2);\n                $linetype = $datalinearr[0];\n                if (in_array($linetype, array('author', 'committer'))) {\n                    $user = $datalinearr[1];\n                    preg_match('/([^<]+)<([^>]+)> ([0-9]+)( [^ ]+)?/', $user, $user);\n                    $user2 = array(\n                        'name' => trim($user[1]),\n                        'email' => trim($user[2]),\n                        'date' => date('Y-m-d H:i:s', $user[3]));\n                    if (isset($user[4])) {\n                        $user2['date'] .= $user[4];\n                    }\n                    $$linetype = $user2;\n                }\n            } while ($dataline != '');\n            $message = trim(implode(' ', $commit));\n\n        } elseif (isset($commit_json)) {\n            $author = array(\n                'name' => $commit_json->author->name,\n                'email' => $commit_json->author->email,\n                'date' => $commit_json->author->date);\n            $committer = array(\n                'name' => $commit_json->committer->name,\n                'email' => $commit_json->committer->email,\n                'date' => $commit_json->committer->date);\n            $message = trim($commit_json->message);\n        } else {\n            return;\n        }\n\n        $this->set('PMA_VERSION_GIT', 1);\n        $this->set('PMA_VERSION_GIT_COMMITHASH', $hash);\n        $this->set('PMA_VERSION_GIT_BRANCH', $branch);\n        $this->set('PMA_VERSION_GIT_MESSAGE', $message);\n        $this->set('PMA_VERSION_GIT_AUTHOR', $author);\n        $this->set('PMA_VERSION_GIT_COMMITTER', $committer);\n        $this->set('PMA_VERSION_GIT_ISREMOTECOMMIT', $is_remote_commit);\n        $this->set('PMA_VERSION_GIT_ISREMOTEBRANCH', $is_remote_branch);\n    }\n\n    /**\n     * Checks if given URL is 200 or 404, optionally returns data\n     *\n     * @param string  $link     the URL to check\n     * @param boolean $get_body whether to retrieve body of document\n     *\n     * @return string|boolean test result or data\n     */\n    public function checkHTTP($link, $get_body = false)\n    {\n        if (! function_exists('curl_init')) {\n            return null;\n        }\n        $handle = curl_init($link);\n        if ($handle === false) {\n            return null;\n        }\n        PMA_Util::configureCurl($handle);\n        curl_setopt($handle, CURLOPT_FOLLOWLOCATION, 0);\n        curl_setopt($handle, CURLOPT_RETURNTRANSFER, 1);\n        curl_setopt($handle, CURLOPT_SSL_VERIFYHOST, '2');\n        curl_setopt($handle, CURLOPT_SSL_VERIFYPEER, '1');\n        curl_setopt($handle, CURLOPT_CONNECTTIMEOUT, 5);\n        curl_setopt($handle, CURLOPT_TIMEOUT, 5);\n        curl_setopt($handle, CURLOPT_IPRESOLVE, CURL_IPRESOLVE_V4);\n        if (! defined('TESTSUITE')) {\n            session_write_close();\n        }\n        $data = @curl_exec($handle);\n        if (! defined('TESTSUITE')) {\n            ini_set('session.use_only_cookies', '0');\n            ini_set('session.use_cookies', '0');\n            ini_set('session.use_trans_sid', '0');\n            ini_set('session.cache_limiter', 'nocache');\n            session_start();\n        }\n        if ($data === false) {\n            return null;\n        }\n        $http_status = curl_getinfo($handle, CURLINFO_HTTP_CODE);\n\n        if ($http_status == 200) {\n            return $get_body ? $data : true;\n        }\n\n        if ($http_status == 404) {\n            return false;\n        }\n        return null;\n    }\n\n    /**\n     * loads default values from default source\n     *\n     * @return boolean     success\n     */\n    public function loadDefaults()\n    {\n        $cfg = array();\n        if (! @file_exists($this->default_source)) {\n            $this->error_config_default_file = true;\n            return false;\n        }\n        include $this->default_source;\n\n        $this->default_source_mtime = filemtime($this->default_source);\n\n        $this->default_server = $cfg['Servers'][1];\n        unset($cfg['Servers']);\n\n        $this->default = $cfg;\n        $this->settings = PMA_arrayMergeRecursive($this->settings, $cfg);\n\n        $this->error_config_default_file = false;\n\n        return true;\n    }\n\n    /**\n     * loads configuration from $source, usually the config file\n     * should be called on object creation\n     *\n     * @param string $source config file\n     *\n     * @return bool\n     */\n    public function load($source = null)\n    {\n        $this->loadDefaults();\n\n        if (null !== $source) {\n            $this->setSource($source);\n        }\n\n        /**\n         * We check and set the font size at this point, to make the font size\n         * selector work also for users without a config.inc.php\n         */\n        $this->checkFontsize();\n\n        if (! $this->checkConfigSource()) {\n            // even if no config file, set collation_connection\n            $this->checkCollationConnection();\n            return false;\n        }\n\n        $cfg = array();\n\n        /**\n         * Parses the configuration file, we throw away any errors or\n         * output.\n         */\n        $old_error_reporting = error_reporting(0);\n        ob_start();\n        $GLOBALS['pma_config_loading'] = true;\n        $eval_result = include $this->getSource();\n        $GLOBALS['pma_config_loading'] = false;\n        ob_end_clean();\n        error_reporting($old_error_reporting);\n\n        if ($eval_result === false) {\n            $this->error_config_file = true;\n        } else {\n            $this->error_config_file = false;\n            $this->source_mtime = filemtime($this->getSource());\n        }\n\n        /**\n         * Backward compatibility code\n         */\n        if (!empty($cfg['DefaultTabTable'])) {\n            $cfg['DefaultTabTable'] = str_replace(\n                '_properties',\n                '',\n                str_replace(\n                    'tbl_properties.php',\n                    'tbl_sql.php',\n                    $cfg['DefaultTabTable']\n                )\n            );\n        }\n        if (!empty($cfg['DefaultTabDatabase'])) {\n            $cfg['DefaultTabDatabase'] = str_replace(\n                '_details',\n                '',\n                str_replace(\n                    'db_details.php',\n                    'db_sql.php',\n                    $cfg['DefaultTabDatabase']\n                )\n            );\n        }\n\n        $this->settings = PMA_arrayMergeRecursive($this->settings, $cfg);\n        $this->checkPmaAbsoluteUri();\n\n        // Handling of the collation must be done after merging of $cfg\n        // (from config.inc.php) so that $cfg['DefaultConnectionCollation']\n        // can have an effect.\n        $this->checkCollationConnection();\n\n        return true;\n    }\n\n    /**\n     * Saves the connection collation\n     *\n     * @param array $config_data configuration data from user preferences\n     *\n     * @return void\n     */\n    private function _saveConnectionCollation($config_data)\n    {\n        if (!PMA_DRIZZLE) {\n            // just to shorten the lines\n            $collation = 'collation_connection';\n            if (isset($GLOBALS[$collation])\n                && (isset($_COOKIE['pma_collation_connection'])\n                || isset($_POST[$collation]))\n            ) {\n                if ((! isset($config_data[$collation])\n                    && $GLOBALS[$collation] != 'utf8_general_ci')\n                    || isset($config_data[$collation])\n                    && $GLOBALS[$collation] != $config_data[$collation]\n                ) {\n                    $this->setUserValue(\n                        null,\n                        $collation,\n                        $GLOBALS[$collation],\n                        'utf8_general_ci'\n                    );\n                }\n            } else {\n                // read collation from settings\n                if (isset($config_data[$collation])) {\n                    $GLOBALS[$collation]\n                        = $config_data[$collation];\n                    $this->setCookie(\n                        'pma_collation_connection',\n                        $GLOBALS[$collation]\n                    );\n                }\n            }\n        }\n    }\n\n    /**\n     * Loads user preferences and merges them with current config\n     * must be called after control connection has been established\n     *\n     * @return void\n     */\n    public function loadUserPreferences()\n    {\n        // index.php should load these settings, so that phpmyadmin.css.php\n        // will have everything available in session cache\n        $server = isset($GLOBALS['server'])\n            ? $GLOBALS['server']\n            : (!empty($GLOBALS['cfg']['ServerDefault'])\n                ? $GLOBALS['cfg']['ServerDefault']\n                : 0);\n        $cache_key = 'server_' . $server;\n        if ($server > 0 && !defined('PMA_MINIMUM_COMMON')) {\n            $config_mtime = max($this->default_source_mtime, $this->source_mtime);\n            // cache user preferences, use database only when needed\n            if (! isset($_SESSION['cache'][$cache_key]['userprefs'])\n                || $_SESSION['cache'][$cache_key]['config_mtime'] < $config_mtime\n            ) {\n                // load required libraries\n                include_once './libraries/user_preferences.lib.php';\n                $prefs = PMA_loadUserprefs();\n                $_SESSION['cache'][$cache_key]['userprefs']\n                    = PMA_applyUserprefs($prefs['config_data']);\n                $_SESSION['cache'][$cache_key]['userprefs_mtime'] = $prefs['mtime'];\n                $_SESSION['cache'][$cache_key]['userprefs_type'] = $prefs['type'];\n                $_SESSION['cache'][$cache_key]['config_mtime'] = $config_mtime;\n            }\n        } elseif ($server == 0\n            || ! isset($_SESSION['cache'][$cache_key]['userprefs'])\n        ) {\n            $this->set('user_preferences', false);\n            return;\n        }\n        $config_data = $_SESSION['cache'][$cache_key]['userprefs'];\n        // type is 'db' or 'session'\n        $this->set(\n            'user_preferences',\n            $_SESSION['cache'][$cache_key]['userprefs_type']\n        );\n        $this->set(\n            'user_preferences_mtime',\n            $_SESSION['cache'][$cache_key]['userprefs_mtime']\n        );\n\n        // backup some settings\n        $org_fontsize = '';\n        if (isset($this->settings['fontsize'])) {\n            $org_fontsize = $this->settings['fontsize'];\n        }\n        // load config array\n        $this->settings = PMA_arrayMergeRecursive($this->settings, $config_data);\n        $GLOBALS['cfg'] = PMA_arrayMergeRecursive($GLOBALS['cfg'], $config_data);\n        if (defined('PMA_MINIMUM_COMMON')) {\n            return;\n        }\n\n        // settings below start really working on next page load, but\n        // changes are made only in index.php so everything is set when\n        // in frames\n\n        // save theme\n        /** @var PMA_Theme_Manager $tmanager */\n        $tmanager = $_SESSION['PMA_Theme_Manager'];\n        if ($tmanager->getThemeCookie() || isset($_REQUEST['set_theme'])) {\n            if ((! isset($config_data['ThemeDefault'])\n                && $tmanager->theme->getId() != 'original')\n                || isset($config_data['ThemeDefault'])\n                && $config_data['ThemeDefault'] != $tmanager->theme->getId()\n            ) {\n                // new theme was set in common.inc.php\n                $this->setUserValue(\n                    null,\n                    'ThemeDefault',\n                    $tmanager->theme->getId(),\n                    'original'\n                );\n            }\n        } else {\n            // no cookie - read default from settings\n            if ($this->settings['ThemeDefault'] != $tmanager->theme->getId()\n                && $tmanager->checkTheme($this->settings['ThemeDefault'])\n            ) {\n                $tmanager->setActiveTheme($this->settings['ThemeDefault']);\n                $tmanager->setThemeCookie();\n            }\n        }\n\n        // save font size\n        if ((! isset($config_data['fontsize'])\n            && $org_fontsize != '82%')\n            || isset($config_data['fontsize'])\n            && $org_fontsize != $config_data['fontsize']\n        ) {\n            $this->setUserValue(null, 'fontsize', $org_fontsize, '82%');\n        }\n\n        // save language\n        if (isset($_COOKIE['pma_lang']) || isset($_POST['lang'])) {\n            if ((! isset($config_data['lang'])\n                && $GLOBALS['lang'] != 'en')\n                || isset($config_data['lang'])\n                && $GLOBALS['lang'] != $config_data['lang']\n            ) {\n                $this->setUserValue(null, 'lang', $GLOBALS['lang'], 'en');\n            }\n        } else {\n            // read language from settings\n            if (isset($config_data['lang']) && PMA_langSet($config_data['lang'])) {\n                $this->setCookie('pma_lang', $GLOBALS['lang']);\n            }\n        }\n\n        // save connection collation\n        $this->_saveConnectionCollation($config_data);\n    }\n\n    /**\n     * Sets config value which is stored in user preferences (if available)\n     * or in a cookie.\n     *\n     * If user preferences are not yet initialized, option is applied to\n     * global config and added to a update queue, which is processed\n     * by {@link loadUserPreferences()}\n     *\n     * @param string $cookie_name   can be null\n     * @param string $cfg_path      configuration path\n     * @param mixed  $new_cfg_value new value\n     * @param mixed  $default_value default value\n     *\n     * @return void\n     */\n    public function setUserValue($cookie_name, $cfg_path, $new_cfg_value,\n        $default_value = null\n    ) {\n        // use permanent user preferences if possible\n        $prefs_type = $this->get('user_preferences');\n        if ($prefs_type) {\n            include_once './libraries/user_preferences.lib.php';\n            if ($default_value === null) {\n                $default_value = PMA_arrayRead($cfg_path, $this->default);\n            }\n            PMA_persistOption($cfg_path, $new_cfg_value, $default_value);\n        }\n        if ($prefs_type != 'db' && $cookie_name) {\n            // fall back to cookies\n            if ($default_value === null) {\n                $default_value = PMA_arrayRead($cfg_path, $this->settings);\n            }\n            $this->setCookie($cookie_name, $new_cfg_value, $default_value);\n        }\n        PMA_arrayWrite($cfg_path, $GLOBALS['cfg'], $new_cfg_value);\n        PMA_arrayWrite($cfg_path, $this->settings, $new_cfg_value);\n    }\n\n    /**\n     * Reads value stored by {@link setUserValue()}\n     *\n     * @param string $cookie_name cookie name\n     * @param mixed  $cfg_value   config value\n     *\n     * @return mixed\n     */\n    public function getUserValue($cookie_name, $cfg_value)\n    {\n        $cookie_exists = isset($_COOKIE) && !empty($_COOKIE[$cookie_name]);\n        $prefs_type = $this->get('user_preferences');\n        if ($prefs_type == 'db') {\n            // permanent user preferences value exists, remove cookie\n            if ($cookie_exists) {\n                $this->removeCookie($cookie_name);\n            }\n        } else if ($cookie_exists) {\n            return $_COOKIE[$cookie_name];\n        }\n        // return value from $cfg array\n        return $cfg_value;\n    }\n\n    /**\n     * set source\n     *\n     * @param string $source source\n     *\n     * @return void\n     */\n    public function setSource($source)\n    {\n        $this->source = trim($source);\n    }\n\n    /**\n     * check config source\n     *\n     * @return boolean whether source is valid or not\n     */\n    public function checkConfigSource()\n    {\n        if (! $this->getSource()) {\n            // no configuration file set at all\n            return false;\n        }\n\n        if (! @file_exists($this->getSource())) {\n            $this->source_mtime = 0;\n            return false;\n        }\n\n        if (! @is_readable($this->getSource())) {\n            // manually check if file is readable\n            // might be bug #3059806 Supporting running from CIFS/Samba shares\n\n            $contents = false;\n            $handle = @fopen($this->getSource(), 'r');\n            if ($handle !== false) {\n                $contents = @fread($handle, 1); // reading 1 byte is enough to test\n                @fclose($handle);\n            }\n            if ($contents === false) {\n                $this->source_mtime = 0;\n                PMA_fatalError(\n                    sprintf(\n                        function_exists('__')\n                        ? __('Existing configuration file (%s) is not readable.')\n                        : 'Existing configuration file (%s) is not readable.',\n                        $this->getSource()\n                    )\n                );\n                return false;\n            }\n        }\n\n        return true;\n    }\n\n    /**\n     * verifies the permissions on config file (if asked by configuration)\n     * (must be called after config.inc.php has been merged)\n     *\n     * @return void\n     */\n    public function checkPermissions()\n    {\n        // Check for permissions (on platforms that support it):\n        if ($this->get('CheckConfigurationPermissions')) {\n            $perms = @fileperms($this->getSource());\n            if (!($perms === false) && ($perms & 2)) {\n                // This check is normally done after loading configuration\n                $this->checkWebServerOs();\n                if ($this->get('PMA_IS_WINDOWS') == 0) {\n                    $this->source_mtime = 0;\n                    PMA_fatalError(\n                        __(\n                            'Wrong permissions on configuration file, '\n                            . 'should not be world writable!'\n                        )\n                    );\n                }\n            }\n        }\n    }\n\n    /**\n     * returns specific config setting\n     *\n     * @param string $setting config setting\n     *\n     * @return mixed value\n     */\n    public function get($setting)\n    {\n        if (isset($this->settings[$setting])) {\n            return $this->settings[$setting];\n        }\n        return null;\n    }\n\n    /**\n     * sets configuration variable\n     *\n     * @param string $setting configuration option\n     * @param mixed  $value   new value for configuration option\n     *\n     * @return void\n     */\n    public function set($setting, $value)\n    {\n        if (! isset($this->settings[$setting])\n            || $this->settings[$setting] !== $value\n        ) {\n            $this->settings[$setting] = $value;\n            $this->set_mtime = time();\n        }\n    }\n\n    /**\n     * returns source for current config\n     *\n     * @return string  config source\n     */\n    public function getSource()\n    {\n        return $this->source;\n    }\n\n    /**\n     * returns a unique value to force a CSS reload if either the config\n     * or the theme changes\n     * must also check the pma_fontsize cookie in case there is no\n     * config file\n     *\n     * @return int Summary of unix timestamps and fontsize,\n     * to be unique on theme parameters change\n     */\n    public function getThemeUniqueValue()\n    {\n        if (null !== $this->get('fontsize')) {\n            $fontsize = intval($this->get('fontsize'));\n        } elseif (isset($_COOKIE['pma_fontsize'])) {\n            $fontsize = intval($_COOKIE['pma_fontsize']);\n        } else {\n            $fontsize = 0;\n        }\n        return (\n            $fontsize +\n            $this->source_mtime +\n            $this->default_source_mtime +\n            $this->get('user_preferences_mtime') +\n            $_SESSION['PMA_Theme']->mtime_info +\n            $_SESSION['PMA_Theme']->filesize_info);\n    }\n\n    /**\n     * $cfg['PmaAbsoluteUri'] is a required directive else cookies won't be\n     * set properly and, depending on browsers, inserting or updating a\n     * record might fail\n     *\n     * @return void\n     */\n    public function checkPmaAbsoluteUri()\n    {\n        // Setup a default value to let the people and lazy sysadmins work anyway,\n        // they'll get an error if the autodetect code doesn't work\n        $pma_absolute_uri = $this->get('PmaAbsoluteUri');\n        $is_https = $this->detectHttps();\n\n        if (/*overload*/mb_strlen($pma_absolute_uri) < 5) {\n            $url = array();\n\n            // If we don't have scheme, we didn't have full URL so we need to\n            // dig deeper\n            if (empty($url['scheme'])) {\n                // Scheme\n                if ($is_https) {\n                    $url['scheme'] = 'https';\n                } else {\n                    $url['scheme'] = 'http';\n                }\n\n                // Host and port\n                if (PMA_getenv('HTTP_HOST')) {\n                    // Prepend the scheme before using parse_url() since this\n                    // is not part of the RFC2616 Host request-header\n                    $parsed_url = parse_url(\n                        $url['scheme'] . '://' . PMA_getenv('HTTP_HOST')\n                    );\n                    if (!empty($parsed_url['host'])) {\n                        $url = $parsed_url;\n                    } else {\n                        $url['host'] = PMA_getenv('HTTP_HOST');\n                    }\n                } elseif (PMA_getenv('SERVER_NAME')) {\n                    $url['host'] = PMA_getenv('SERVER_NAME');\n                } else {\n                    $this->error_pma_uri = true;\n                    return;\n                }\n\n                // If we didn't set port yet...\n                if (empty($url['port']) && PMA_getenv('SERVER_PORT')) {\n                    $url['port'] = PMA_getenv('SERVER_PORT');\n                }\n\n                // And finally the path could be already set from REQUEST_URI\n                if (empty($url['path'])) {\n                    // we got a case with nginx + php-fpm where PHP_SELF\n                    // was not set, so PMA_PHP_SELF was not set as well\n                    if (isset($GLOBALS['PMA_PHP_SELF'])) {\n                        $path = parse_url($GLOBALS['PMA_PHP_SELF']);\n                    } else {\n                        $path = parse_url(PMA_getenv('REQUEST_URI'));\n                    }\n                    $url['path'] = $path['path'];\n                }\n            }\n\n            // Make url from parts we have\n            $pma_absolute_uri = $url['scheme'] . '://';\n            // Was there user information?\n            if (!empty($url['user'])) {\n                $pma_absolute_uri .= $url['user'];\n                if (!empty($url['pass'])) {\n                    $pma_absolute_uri .= ':' . $url['pass'];\n                }\n                $pma_absolute_uri .= '@';\n            }\n            // Add hostname\n            $pma_absolute_uri .= $url['host'];\n            // Add port, if it not the default one\n            // (or 80 for https which is most likely a bug)\n            if (! empty($url['port'])\n                && (($url['scheme'] == 'http' && $url['port'] != 80)\n                || ($url['scheme'] == 'https' && $url['port'] != 80)\n                || ($url['scheme'] == 'https' && $url['port'] != 443))\n            ) {\n                $pma_absolute_uri .= ':' . $url['port'];\n            }\n            // And finally path, without script name, the 'a' is there not to\n            // strip our directory, when path is only /pmadir/ without filename.\n            // Backslashes returned by Windows have to be changed.\n            // Only replace backslashes by forward slashes if on Windows,\n            // as the backslash could be valid on a non-Windows system.\n            $this->checkWebServerOs();\n            if ($this->get('PMA_IS_WINDOWS') == 1) {\n                $path = str_replace(\"\\\\\", \"/\", dirname($url['path'] . 'a'));\n            } else {\n                $path = dirname($url['path'] . 'a');\n            }\n\n            // To work correctly within javascript\n            if (defined('PMA_PATH_TO_BASEDIR') && PMA_PATH_TO_BASEDIR == '../') {\n                if ($this->get('PMA_IS_WINDOWS') == 1) {\n                    $path = str_replace(\"\\\\\", \"/\", dirname($path));\n                } else {\n                    $path = dirname($path);\n                }\n            }\n\n            // PHP's dirname function would have returned a dot\n            // when $path contains no slash\n            if ($path == '.') {\n                $path = '';\n            }\n            // in vhost situations, there could be already an ending slash\n            if (/*overload*/mb_substr($path, -1) != '/') {\n                $path .= '/';\n            }\n            $pma_absolute_uri .= $path;\n\n            // This is to handle the case of a reverse proxy\n            if ($this->get('ForceSSL')) {\n                $this->set('PmaAbsoluteUri', $pma_absolute_uri);\n                $pma_absolute_uri = $this->getSSLUri();\n                $this->isHttps();\n            }\n\n            // We used to display a warning if PmaAbsoluteUri wasn't set, but now\n            // the autodetect code works well enough that we don't display the\n            // warning at all. The user can still set PmaAbsoluteUri manually.\n\n        } else {\n            // The URI is specified, however users do often specify this\n            // wrongly, so we try to fix this.\n\n            // Adds a trailing slash et the end of the phpMyAdmin uri if it\n            // does not exist.\n            if (/*overload*/mb_substr($pma_absolute_uri, -1) != '/') {\n                $pma_absolute_uri .= '/';\n            }\n\n            // If URI doesn't start with http:// or https://, we will add\n            // this.\n            if (/*overload*/mb_substr($pma_absolute_uri, 0, 7) != 'http://'\n                && /*overload*/mb_substr($pma_absolute_uri, 0, 8) != 'https://'\n            ) {\n                $pma_absolute_uri\n                    = ($is_https ? 'https' : 'http')\n                    . ':'\n                    . (\n                        /*overload*/mb_substr($pma_absolute_uri, 0, 2) == '//'\n                        ? ''\n                        : '//'\n                    )\n                    . $pma_absolute_uri;\n            }\n        }\n        $this->set('PmaAbsoluteUri', $pma_absolute_uri);\n    }\n\n    /**\n     * Converts currently used PmaAbsoluteUri to SSL based variant.\n     *\n     * @return String witch adjusted URI\n     */\n    public function getSSLUri()\n    {\n        // grab current URL\n        $url = $this->get('PmaAbsoluteUri');\n        // Parse current URL\n        $parsed = parse_url($url);\n        // In case parsing has failed do stupid string replacement\n        if ($parsed === false) {\n            // Replace http protocol\n            return preg_replace('@^http:@', 'https:', $url);\n        }\n\n        // Reconstruct URL using parsed parts\n        return 'https://' . $parsed['host'] . ':443' . $parsed['path'];\n    }\n\n    /**\n     * Sets collation_connection based on user preference. First is checked\n     * value from request, then cookies with fallback to default.\n     *\n     * After setting it here, cookie is set in common.inc.php to persist\n     * the selection.\n     *\n     * @todo check validity of collation string\n     *\n     * @return void\n     */\n    public function checkCollationConnection()\n    {\n        if (! empty($_REQUEST['collation_connection'])) {\n            $collation = strip_tags($_REQUEST['collation_connection']);\n        } elseif (! empty($_COOKIE['pma_collation_connection'])) {\n            $collation = strip_tags($_COOKIE['pma_collation_connection']);\n        } else {\n            $collation = $this->get('DefaultConnectionCollation');\n        }\n        $this->set('collation_connection', $collation);\n    }\n\n    /**\n     * checks for font size configuration, and sets font size as requested by user\n     *\n     * @return void\n     */\n    public function checkFontsize()\n    {\n        $new_fontsize = '';\n\n        if (isset($_GET['set_fontsize'])) {\n            $new_fontsize = $_GET['set_fontsize'];\n        } elseif (isset($_POST['set_fontsize'])) {\n            $new_fontsize = $_POST['set_fontsize'];\n        } elseif (isset($_COOKIE['pma_fontsize'])) {\n            $new_fontsize = $_COOKIE['pma_fontsize'];\n        }\n\n        if (preg_match('/^[0-9.]+(px|em|pt|\\%)$/', $new_fontsize)) {\n            $this->set('fontsize', $new_fontsize);\n        } elseif (! $this->get('fontsize')) {\n            // 80% would correspond to the default browser font size\n            // of 16, but use 82% to help read the monoface font\n            $this->set('fontsize', '82%');\n        }\n\n        $this->setCookie('pma_fontsize', $this->get('fontsize'), '82%');\n    }\n\n    /**\n     * checks if upload is enabled\n     *\n     * @return void\n     */\n    public function checkUpload()\n    {\n        if (!ini_get('file_uploads')) {\n            $this->set('enable_upload', false);\n            return;\n        }\n\n        $this->set('enable_upload', true);\n        // if set \"php_admin_value file_uploads Off\" in httpd.conf\n        // ini_get() also returns the string \"Off\" in this case:\n        if ('off' == strtolower(ini_get('file_uploads'))) {\n            $this->set('enable_upload', false);\n        }\n    }\n\n    /**\n     * Maximum upload size as limited by PHP\n     * Used with permission from Moodle (http://moodle.org) by Martin Dougiamas\n     *\n     * this section generates $max_upload_size in bytes\n     *\n     * @return void\n     */\n    public function checkUploadSize()\n    {\n        if (! $filesize = ini_get('upload_max_filesize')) {\n            $filesize = \"5M\";\n        }\n\n        if ($postsize = ini_get('post_max_size')) {\n            $this->set(\n                'max_upload_size',\n                min(PMA_getRealSize($filesize), PMA_getRealSize($postsize))\n            );\n        } else {\n            $this->set('max_upload_size', PMA_getRealSize($filesize));\n        }\n    }\n\n    /**\n     * Checks if protocol is https\n     *\n     * This function checks if the https protocol is used in the PmaAbsoluteUri\n     * configuration setting, as opposed to detectHttps() which checks if the\n     * https protocol is used on the active connection.\n     *\n     * @return bool\n     */\n    public function isHttps()\n    {\n\n        if (null !== $this->get('is_https')) {\n            return $this->get('is_https');\n        }\n\n        $url = parse_url($this->get('PmaAbsoluteUri'));\n\n        $is_https = (isset($url['scheme']) && $url['scheme'] == 'https');\n\n        $this->set('is_https', $is_https);\n\n        return $is_https;\n    }\n\n    /**\n     * Detects whether https appears to be used.\n     *\n     * This function checks if the https protocol is used in the current connection\n     * with the webserver, based on environment variables.\n     * Please note that this just detects what we see, so\n     * it completely ignores things like reverse proxies.\n     *\n     * @return bool\n     */\n    public function detectHttps()\n    {\n        $url = array();\n\n        // At first we try to parse REQUEST_URI, it might contain full URL,\n        if (PMA_getenv('REQUEST_URI')) {\n            // produces E_WARNING if it cannot get parsed, e.g. '/foobar:/'\n            $url = @parse_url(PMA_getenv('REQUEST_URI'));\n            if ($url === false) {\n                $url = array();\n            }\n        }\n\n        // If we don't have scheme, we didn't have full URL so we need to\n        // dig deeper\n        if (empty($url['scheme'])) {\n            // Scheme\n            if (PMA_getenv('HTTP_SCHEME')) {\n                $url['scheme'] = PMA_getenv('HTTP_SCHEME');\n            } elseif (PMA_getenv('HTTPS')\n                && strtolower(PMA_getenv('HTTPS')) == 'on'\n            ) {\n                $url['scheme'] = 'https';\n                // A10 Networks load balancer:\n            } elseif (PMA_getenv('HTTP_HTTPS_FROM_LB')\n                && strtolower(PMA_getenv('HTTP_HTTPS_FROM_LB')) == 'on'\n            ) {\n                $url['scheme'] = 'https';\n            } elseif (PMA_getenv('HTTP_X_FORWARDED_PROTO')) {\n                $url['scheme'] = /*overload*/mb_strtolower(\n                    PMA_getenv('HTTP_X_FORWARDED_PROTO')\n                );\n            } elseif (PMA_getenv('HTTP_FRONT_END_HTTPS')\n                && strtolower(PMA_getenv('HTTP_FRONT_END_HTTPS')) == 'on'\n            ) {\n                $url['scheme'] = 'https';\n            } else {\n                $url['scheme'] = 'http';\n            }\n        }\n\n        if (isset($url['scheme']) && $url['scheme'] == 'https') {\n            $is_https = true;\n        } else {\n            $is_https = false;\n        }\n\n        return $is_https;\n    }\n\n    /**\n     * detect correct cookie path\n     *\n     * @return void\n     */\n    public function checkCookiePath()\n    {\n        $this->set('cookie_path', $this->getCookiePath());\n    }\n\n    /**\n     * Get cookie path\n     *\n     * @return string\n     */\n    public function getCookiePath()\n    {\n        static $cookie_path = null;\n\n        if (null !== $cookie_path && !defined('TESTSUITE')) {\n            return $cookie_path;\n        }\n\n        $parsed_url = parse_url($this->get('PmaAbsoluteUri'));\n\n        $cookie_path   = $parsed_url['path'];\n\n        return $cookie_path;\n    }\n\n    /**\n     * enables backward compatibility\n     *\n     * @return void\n     */\n    public function enableBc()\n    {\n        $GLOBALS['cfg']             = $this->settings;\n        $GLOBALS['default_server']  = $this->default_server;\n        unset($this->default_server);\n        $GLOBALS['collation_connection'] = $this->get('collation_connection');\n        $GLOBALS['is_upload']       = $this->get('enable_upload');\n        $GLOBALS['max_upload_size'] = $this->get('max_upload_size');\n        $GLOBALS['cookie_path']     = $this->get('cookie_path');\n        $GLOBALS['is_https']        = $this->get('is_https');\n\n        $defines = array(\n            'PMA_VERSION',\n            'PMA_THEME_VERSION',\n            'PMA_THEME_GENERATION',\n            'PMA_PHP_STR_VERSION',\n            'PMA_PHP_INT_VERSION',\n            'PMA_IS_WINDOWS',\n            'PMA_IS_IIS',\n            'PMA_IS_GD2',\n            'PMA_USR_OS',\n            'PMA_USR_BROWSER_VER',\n            'PMA_USR_BROWSER_AGENT'\n            );\n\n        foreach ($defines as $define) {\n            if (! defined($define)) {\n                define($define, $this->get($define));\n            }\n        }\n    }\n\n    /**\n     * returns options for font size selection\n     *\n     * @param string $current_size current selected font size with unit\n     *\n     * @return array selectable font sizes\n     */\n    protected static function getFontsizeOptions($current_size = '82%')\n    {\n        $unit = preg_replace('/[0-9.]*/', '', $current_size);\n        $value = preg_replace('/[^0-9.]*/', '', $current_size);\n\n        $factors = array();\n        $options = array();\n        $options[\"$value\"] = $value . $unit;\n\n        if ($unit === '%') {\n            $factors[] = 1;\n            $factors[] = 5;\n            $factors[] = 10;\n        } elseif ($unit === 'em') {\n            $factors[] = 0.05;\n            $factors[] = 0.2;\n            $factors[] = 1;\n        } elseif ($unit === 'pt') {\n            $factors[] = 0.5;\n            $factors[] = 2;\n        } elseif ($unit === 'px') {\n            $factors[] = 1;\n            $factors[] = 5;\n            $factors[] = 10;\n        } else {\n            //unknown font size unit\n            $factors[] = 0.05;\n            $factors[] = 0.2;\n            $factors[] = 1;\n            $factors[] = 5;\n            $factors[] = 10;\n        }\n\n        foreach ($factors as $key => $factor) {\n            $option_inc = $value + $factor;\n            $option_dec = $value - $factor;\n            while (count($options) < 21) {\n                $options[\"$option_inc\"] = $option_inc . $unit;\n                if ($option_dec > $factors[0]) {\n                    $options[\"$option_dec\"] = $option_dec . $unit;\n                }\n                $option_inc += $factor;\n                $option_dec -= $factor;\n                if (isset($factors[$key + 1])\n                    && $option_inc >= $value + $factors[$key + 1]\n                ) {\n                    break;\n                }\n            }\n        }\n        ksort($options);\n        return $options;\n    }\n\n    /**\n     * returns html selectbox for font sizes\n     *\n     * @return string html selectbox\n     */\n    protected static function getFontsizeSelection()\n    {\n        $current_size = $GLOBALS['PMA_Config']->get('fontsize');\n        // for the case when there is no config file (this is supported)\n        if (empty($current_size)) {\n            if (isset($_COOKIE['pma_fontsize'])) {\n                $current_size = htmlspecialchars($_COOKIE['pma_fontsize']);\n            } else {\n                $current_size = '82%';\n            }\n        }\n        $options = PMA_Config::getFontsizeOptions($current_size);\n\n        $return = '<label for=\"select_fontsize\">' . __('Font size')\n            . ':</label>' . \"\\n\"\n            . '<select name=\"set_fontsize\" id=\"select_fontsize\"'\n            . ' class=\"autosubmit\">' . \"\\n\";\n        foreach ($options as $option) {\n            $return .= '<option value=\"' . $option . '\"';\n            if ($option == $current_size) {\n                $return .= ' selected=\"selected\"';\n            }\n            $return .= '>' . $option . '</option>' . \"\\n\";\n        }\n        $return .= '</select>';\n\n        return $return;\n    }\n\n    /**\n     * return complete font size selection form\n     *\n     * @return string html selectbox\n     */\n    public static function getFontsizeForm()\n    {\n        return '<form name=\"form_fontsize_selection\" id=\"form_fontsize_selection\"'\n            . ' method=\"get\" action=\"index.php\" class=\"disableAjax\">' . \"\\n\"\n            . PMA_URL_getHiddenInputs() . \"\\n\"\n            . PMA_Config::getFontsizeSelection() . \"\\n\"\n            . '</form>';\n    }\n\n    /**\n     * removes cookie\n     *\n     * @param string $cookie name of cookie to remove\n     *\n     * @return boolean result of setcookie()\n     */\n    public function removeCookie($cookie)\n    {\n        if (defined('TESTSUITE')) {\n            if (isset($_COOKIE[$cookie])) {\n                unset($_COOKIE[$cookie]);\n            }\n            return true;\n        }\n        return setcookie(\n            $cookie,\n            '',\n            time() - 3600,\n            $this->getCookiePath(),\n            '',\n            $this->isHttps()\n        );\n    }\n\n    /**\n     * sets cookie if value is different from current cookie value,\n     * or removes if value is equal to default\n     *\n     * @param string $cookie   name of cookie to remove\n     * @param mixed  $value    new cookie value\n     * @param string $default  default value\n     * @param int    $validity validity of cookie in seconds (default is one month)\n     * @param bool   $httponly whether cookie is only for HTTP (and not for scripts)\n     *\n     * @return boolean result of setcookie()\n     */\n    public function setCookie($cookie, $value, $default = null,\n        $validity = null, $httponly = true\n    ) {\n        if (/*overload*/mb_strlen($value) && null !== $default && $value === $default\n        ) {\n            // default value is used\n            if (isset($_COOKIE[$cookie])) {\n                // remove cookie\n                return $this->removeCookie($cookie);\n            }\n            return false;\n        }\n\n        if (!/*overload*/mb_strlen($value) && isset($_COOKIE[$cookie])) {\n            // remove cookie, value is empty\n            return $this->removeCookie($cookie);\n        }\n\n        if (! isset($_COOKIE[$cookie]) || $_COOKIE[$cookie] !== $value) {\n            // set cookie with new value\n            /* Calculate cookie validity */\n            if ($validity === null) {\n                $validity = time() + 2592000;\n            } elseif ($validity == 0) {\n                $validity = 0;\n            } else {\n                $validity = time() + $validity;\n            }\n            if (defined('TESTSUITE')) {\n                $_COOKIE[$cookie] = $value;\n                return true;\n            }\n            return setcookie(\n                $cookie,\n                $value,\n                $validity,\n                $this->getCookiePath(),\n                '',\n                $this->isHttps(),\n                $httponly\n            );\n        }\n\n        // cookie has already $value as value\n        return true;\n    }\n}\n\n\n/**\n * Error handler to catch fatal errors when loading configuration\n * file\n *\n * @return void\n */\nfunction PMA_Config_fatalErrorHandler()\n{\n    if (isset($GLOBALS['pma_config_loading']) && $GLOBALS['pma_config_loading']) {\n        $error = error_get_last();\n        if ($error !== null) {\n            PMA_fatalError(\n                sprintf(\n                    'Failed to load phpMyAdmin configuration (%s:%s): %s',\n                    PMA_Error::relPath($error['file']),\n                    $error['line'],\n                    $error['message']\n                )\n            );\n        }\n    }\n}\n\nif (!defined('TESTSUITE')) {\n    register_shutdown_function('PMA_Config_fatalErrorHandler');\n}\n", "<?php\n/* vim: set expandtab sw=4 ts=4 sts=4: */\n/**\n * Test for PMA_Config class\n *\n * @package PhpMyAdmin-test\n * @group current\n */\n\n/*\n * Include to test.\n */\nrequire_once 'libraries/core.lib.php';\nrequire_once 'libraries/Util.class.php';\nrequire_once 'libraries/Config.class.php';\nrequire_once 'libraries/relation.lib.php';\nrequire_once 'libraries/Theme.class.php';\nrequire_once 'libraries/vendor_config.php';\nrequire_once 'libraries/url_generating.lib.php';\nrequire_once 'libraries/php-gettext/gettext.inc';\n\n/**\n * Tests behaviour of PMA_Config class\n *\n * @package PhpMyAdmin-test\n */\nclass PMA_ConfigTest extends PHPUnit_Framework_TestCase\n{\n    /**\n     * Turn off backup globals\n     */\n    protected $backupGlobals = false;\n\n    /**\n     * @var PMA_Config\n     */\n    protected $object;\n\n    /**\n     * @var object to test file permission\n     */\n    protected $permTestObj;\n\n    /**\n     * Sets up the fixture, for example, opens a network connection.\n     * This method is called before a test is executed.\n     *\n     * @return void\n     */\n    protected function setUp()\n    {\n        $this->object = new PMA_Config;\n        $GLOBALS['server'] = 0;\n        $_SESSION['is_git_revision'] = true;\n        $GLOBALS['PMA_Config'] = new PMA_Config(CONFIG_FILE);\n        $GLOBALS['cfg']['ProxyUrl'] = '';\n\n        //for testing file permissions\n        $this->permTestObj = new PMA_Config(\"./config.sample.inc.php\");\n    }\n\n    /**\n     * Tears down the fixture, for example, closes a network connection.\n     * This method is called after a test is executed.\n     *\n     * @return void\n     */\n    protected function tearDown()\n    {\n        unset($this->object);\n        unset($this->permTestObj);\n    }\n\n    /**\n     * Test for CheckSystem\n     *\n     * @return void\n     * @group medium\n     */\n    public function testCheckSystem()\n    {\n        $this->object->checkSystem();\n\n        $this->assertNotNull($this->object->get('PMA_VERSION'));\n        $this->assertNotEmpty($this->object->get('PMA_THEME_VERSION'));\n        $this->assertNotEmpty($this->object->get('PMA_THEME_GENERATION'));\n    }\n\n    /**\n     * Test for GetFontsizeForm\n     *\n     * @return void\n     */\n    public function testGetFontsizeForm()\n    {\n        $this->assertContains(\n            '<form name=\"form_fontsize_selection\" id=\"form_fontsize_selection\"',\n            PMA_Config::getFontsizeForm()\n        );\n\n        $this->assertContains(\n            '<label for=\"select_fontsize\">',\n            PMA_Config::getFontsizeForm()\n        );\n\n        //test getFontsizeOptions for \"em\" unit\n        $fontsize = $GLOBALS['PMA_Config']->get('fontsize');\n        $GLOBALS['PMA_Config']->set('fontsize', '');\n        $_COOKIE['pma_fontsize'] = \"10em\";\n        $this->assertContains(\n            '<option value=\"7em\"',\n            PMA_Config::getFontsizeForm()\n        );\n        $this->assertContains(\n            '<option value=\"8em\"',\n            PMA_Config::getFontsizeForm()\n        );\n\n        //test getFontsizeOptions for \"pt\" unit\n        $_COOKIE['pma_fontsize'] = \"10pt\";\n        $this->assertContains(\n            '<option value=\"2pt\"',\n            PMA_Config::getFontsizeForm()\n        );\n        $this->assertContains(\n            '<option value=\"4pt\"',\n            PMA_Config::getFontsizeForm()\n        );\n\n        //test getFontsizeOptions for \"px\" unit\n        $_COOKIE['pma_fontsize'] = \"10px\";\n        $this->assertContains(\n            '<option value=\"5px\"',\n            PMA_Config::getFontsizeForm()\n        );\n        $this->assertContains(\n            '<option value=\"6px\"',\n            PMA_Config::getFontsizeForm()\n        );\n\n        //test getFontsizeOptions for unknown unit\n        $_COOKIE['pma_fontsize'] = \"10abc\";\n        $this->assertContains(\n            '<option value=\"7abc\"',\n            PMA_Config::getFontsizeForm()\n        );\n        $this->assertContains(\n            '<option value=\"8abc\"',\n            PMA_Config::getFontsizeForm()\n        );\n        unset($_COOKIE['pma_fontsize']);\n        //rollback the fontsize setting\n        $GLOBALS['PMA_Config']->set('fontsize', $fontsize);\n    }\n\n    /**\n     * Test for checkOutputCompression\n     *\n     * @return void\n     */\n    public function testCheckOutputCompression()\n    {\n\n        $this->object->set('OBGzip', 'auto');\n\n        $this->object->set('PMA_USR_BROWSER_AGENT', 'IE');\n        $this->object->set('PMA_USR_BROWSER_VER', 6);\n        $this->object->checkOutputCompression();\n        $this->assertFalse($this->object->get(\"OBGzip\"));\n\n        $this->object->set('OBGzip', 'auto');\n        $this->object->set('PMA_USR_BROWSER_AGENT', 'MOZILLA');\n        $this->object->set('PMA_USR_BROWSER_VER', 5);\n        $this->object->checkOutputCompression();\n        $this->assertTrue($this->object->get(\"OBGzip\"));\n    }\n\n    /**\n     * Tests client parsing code.\n     *\n     * @param string $agent   User agent string\n     * @param string $os      Expected parsed OS (or null if none)\n     * @param string $browser Expected parsed browser (or null if none)\n     * @param string $version Expected browser version (or null if none)\n     *\n     * @return void\n     *\n     * @dataProvider userAgentProvider\n     */\n    public function testCheckClient($agent, $os, $browser = null, $version = null)\n    {\n        $_SERVER['HTTP_USER_AGENT'] = $agent;\n        $this->object->checkClient();\n        $this->assertEquals($os, $this->object->get('PMA_USR_OS'));\n        if ($os != null) {\n            $this->assertEquals(\n                $browser,\n                $this->object->get('PMA_USR_BROWSER_AGENT')\n            );\n        }\n        if ($version != null) {\n            $this->assertEquals(\n                $version,\n                $this->object->get('PMA_USR_BROWSER_VER')\n            );\n        }\n    }\n\n    /**\n     * user Agent Provider\n     *\n     * @return array\n     */\n    public function userAgentProvider()\n    {\n        return array(\n            array(\n                'Opera/9.80 (X11; Linux x86_64; U; pl) Presto/2.7.62 Version/11.00',\n                'Linux',\n                'OPERA',\n                '9.80',\n            ),\n            array(\n                'Mozilla/5.0 (Macintosh; U; Intel Mac OS X; en-US) AppleWebKit/'\n                . '528.16 OmniWeb/622.8.0.112941',\n                'Mac',\n                'OMNIWEB',\n                '622',\n            ),\n            array(\n                'Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1)',\n                'Win',\n                'IE',\n                '8.0',\n            ),\n            array(\n                'Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Trident/5.0)',\n                'Win',\n                'IE',\n                '9.0',\n            ),\n            array(\n                'Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; Win64; x64; '\n                . 'Trident/6.0)',\n                'Win',\n                'IE',\n                '10.0',\n            ),\n            array(\n                'Mozilla/5.0 (IE 11.0; Windows NT 6.3; Trident/7.0; .NET4.0E; '\n                . '.NET4.0C; rv:11.0) like Gecko',\n                'Win',\n                'IE',\n                '11.0',\n            ),\n            array(\n                'Mozilla/5.0 (Windows NT 6.3; WOW64; Trident/7.0; .NET4.0E; '\n                . '.NET4.0C; .NET CLR 3.5.30729; .NET CLR 2.0.50727; '\n                . '.NET CLR 3.0.30729; InfoPath.3; rv:11.0) like Gecko',\n                'Win',\n                'IE',\n                '11.0',\n            ),\n            array(\n                'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.22 (KHTML, '\n                . 'like Gecko) Chrome/25.0.1364.172 Safari/537.22',\n                'Win',\n                'CHROME',\n                '25.0.1364.172',\n            ),\n            array(\n                'Mozilla/5.0 (Unknown; U; Unix BSD/SYSV system; C -) '\n                . 'AppleWebKit/527+ (KHTML, like Gecko, Safari/419.3) Arora/0.10.2',\n                'Unix',\n                'SAFARI',\n                '5.0.419',\n            ),\n            array(\n                'Mozilla/5.0 (Windows; U; Win95; en-US; rv:1.9b) Gecko/20031208',\n                'Win',\n                'GECKO',\n                '1.9',\n            ),\n            array(\n                'Mozilla/5.0 (compatible; Konqueror/4.5; NetBSD 5.0.2; X11; '\n                . 'amd64; en_US) KHTML/4.5.4 (like Gecko)',\n                'Other',\n                'KONQUEROR',\n            ),\n            array(\n                'Mozilla/5.0 (X11; Linux x86_64; rv:5.0) Gecko/20100101 Firefox/5.0',\n                'Linux',\n                'FIREFOX',\n                '5.0',\n            ),\n            array(\n                'Mozilla/5.0 (X11; Linux x86_64; rv:12.0) Gecko/20100101 '\n                . 'Firefox/12.0',\n                'Linux',\n                'FIREFOX',\n                '12.0',\n            ),\n            /**\n             * @todo Is this version really expected?\n             */\n            array(\n                'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/535.4+ (KHTML, like G'\n                . 'ecko) Version/5.0 Safari/535.4+ SUSE/12.1 (3.2.1) Epiphany/3.2.1',\n                'Linux',\n                'SAFARI',\n                '5.0',\n            ),\n        );\n\n    }\n\n\n    /**\n     * test for CheckGd2\n     *\n     * @return array\n     */\n    public function testCheckGd2()\n    {\n        $prevIsGb2Val = $this->object->get('PMA_IS_GD2');\n\n        $this->object->set('GD2Available', 'yes');\n        $this->object->checkGd2();\n        $this->assertEquals(1, $this->object->get('PMA_IS_GD2'));\n\n        $this->object->set('GD2Available', 'no');\n        $this->object->checkGd2();\n        $this->assertEquals(0, $this->object->get('PMA_IS_GD2'));\n\n        $this->object->set('GD2Available', $prevIsGb2Val);\n\n        if (!@function_exists('imagecreatetruecolor')) {\n            $this->object->checkGd2();\n            $this->assertEquals(\n                0,\n                $this->object->get('PMA_IS_GD2'),\n                'imagecreatetruecolor does not exist, PMA_IS_GD2 should be 0'\n            );\n        }\n\n        if (@function_exists('gd_info')) {\n            $this->object->checkGd2();\n            $gd_nfo = gd_info();\n            if (/*overload*/mb_strstr($gd_nfo[\"GD Version\"], '2.')) {\n                $this->assertEquals(\n                    1,\n                    $this->object->get('PMA_IS_GD2'),\n                    'GD Version >= 2, PMA_IS_GD2 should be 1'\n                );\n            } else {\n                $this->assertEquals(\n                    0,\n                    $this->object->get('PMA_IS_GD2'),\n                    'GD Version < 2, PMA_IS_GD2 should be 0'\n                );\n            }\n        }\n\n        /* Get GD version string from phpinfo output */\n        ob_start();\n        phpinfo(INFO_MODULES); /* Only modules */\n        $a = strip_tags(ob_get_contents());\n        ob_end_clean();\n\n        if (preg_match('@GD Version[[:space:]]*\\(.*\\)@', $a, $v)) {\n            if (/*overload*/mb_strstr($v, '2.')) {\n                $this->assertEquals(\n                    1,\n                    $this->object->get('PMA_IS_GD2'),\n                    'PMA_IS_GD2 should be 1'\n                );\n            } else {\n                $this->assertEquals(\n                    0,\n                    $this->object->get('PMA_IS_GD2'),\n                    'PMA_IS_GD2 should be 0'\n                );\n            }\n        }\n    }\n\n    /**\n     * Web server detection test\n     *\n     * @param string  $server Server identification\n     * @param boolean $iis    Whether server should be detected as IIS\n     *\n     * @return void\n     *\n     * @dataProvider serverNames\n     */\n    public function testCheckWebServer($server, $iis)\n    {\n        $_SERVER['SERVER_SOFTWARE'] = $server;\n        $this->object->checkWebServer();\n        $this->assertEquals($iis, $this->object->get('PMA_IS_IIS'));\n        unset($_SERVER['SERVER_SOFTWARE']);\n    }\n\n\n    /**\n     * return server names\n     *\n     * @return array\n     */\n    public function serverNames()\n    {\n        return array(\n            array(\n                \"Microsoft-IIS 7.0\",\n                1,\n            ),\n            array(\n                \"Apache/2.2.17\",\n                0,\n            ),\n        );\n    }\n\n\n    /**\n     * test for CheckWebServerOs\n     *\n     * @return array\n     */\n    public function testCheckWebServerOs()\n    {\n        $this->object->checkWebServerOs();\n\n        if (defined('PHP_OS')) {\n            if (stristr(PHP_OS, 'darwin')) {\n                $this->assertEquals(0, $this->object->get('PMA_IS_WINDOWS'));\n            } elseif (stristr(PHP_OS, 'win')) {\n                $this->assertEquals(1, $this->object->get('PMA_IS_WINDOWS'));\n            } elseif (stristr(PHP_OS, 'OS/2')) {\n                $this->assertEquals(1, $this->object->get('PMA_IS_WINDOWS'));\n            } elseif (stristr(PHP_OS, 'Linux')) {\n                $this->assertEquals(0, $this->object->get('PMA_IS_WINDOWS'));\n            } else {\n                $this->markTestIncomplete('Not known PHP_OS: ' . PHP_OS);\n            }\n        } else {\n            $this->assertEquals(0, $this->object->get('PMA_IS_WINDOWS'));\n\n            define('PHP_OS', 'Windows');\n            $this->assertEquals(1, $this->object->get('PMA_IS_WINDOWS'));\n        }\n    }\n\n    /**\n     * test for CheckPhpVersion\n     *\n     * @return array\n     */\n    public function testCheckPhpVersion()\n    {\n        $this->object->checkPhpVersion();\n\n        $php_int_ver = 0;\n        $php_str_ver = phpversion();\n\n        $match = array();\n        preg_match(\n            '@([0-9]{1,2}).([0-9]{1,2}).([0-9]{1,2})@',\n            phpversion(),\n            $match\n        );\n        if (isset($match) && ! empty($match[1])) {\n            if (! isset($match[2])) {\n                $match[2] = 0;\n            }\n            if (! isset($match[3])) {\n                $match[3] = 0;\n            }\n            $php_int_ver = (int) sprintf(\n                '%d%02d%02d',\n                $match[1],\n                $match[2],\n                $match[3]\n            );\n        } else {\n            $php_int_ver = 0;\n        }\n\n        $this->assertEquals(\n            $php_str_ver,\n            $this->object->get('PMA_PHP_STR_VERSION')\n        );\n        $this->assertEquals(\n            $php_int_ver,\n            $this->object->get('PMA_PHP_INT_VERSION')\n        );\n    }\n\n    /**\n     * Tests loading of default values\n     *\n     * @return void\n     *\n     * @group large\n     */\n    public function testLoadDefaults()\n    {\n        $prevDefaultSource = $this->object->default_source;\n\n        $this->object->default_source = 'unexisted.file.php';\n        $this->assertFalse($this->object->loadDefaults());\n\n        $this->object->default_source = $prevDefaultSource;\n\n        include $this->object->default_source;\n\n        $loadedConf = $cfg;\n        unset($cfg);\n\n        $this->assertTrue($this->object->loadDefaults());\n\n        $this->assertEquals(\n            $this->object->default_source_mtime,\n            filemtime($prevDefaultSource)\n        );\n        $this->assertEquals(\n            $loadedConf['Servers'][1],\n            $this->object->default_server\n        );\n\n        unset($loadedConf['Servers']);\n\n        $this->assertEquals($loadedConf, $this->object->default);\n\n        $expectedSettings = PMA_arrayMergeRecursive(\n            $this->object->settings,\n            $loadedConf\n        );\n\n        $this->assertEquals(\n            $expectedSettings,\n            $this->object->settings,\n            'Settings loaded wrong'\n        );\n\n        $this->assertFalse($this->object->error_config_default_file);\n    }\n\n    /**\n     * test for CheckConfigSource\n     *\n     * @return array\n     */\n    public function testCheckConfigSource()\n    {\n        $this->object->setSource('unexisted.config.php');\n        $this->assertFalse($this->object->checkConfigSource());\n        $this->assertEquals(0, $this->object->source_mtime);\n\n        $this->object->setSource('libraries/config.default.php');\n\n        $this->assertNotEmpty($this->object->getSource());\n        $this->assertTrue($this->object->checkConfigSource());\n    }\n\n    /**\n     * Test getting and setting config values\n     *\n     * @return void\n     */\n    public function testGetAndSet()\n    {\n        $this->assertNull($this->object->get(\"unresisting_setting\"));\n\n        $this->object->set('test_setting', 'test_value');\n\n        $this->assertEquals('test_value', $this->object->get('test_setting'));\n    }\n\n    /**\n     * Tests setting configuration source\n     *\n     * @return void\n     */\n    public function testGetSetSource()\n    {\n        echo $this->object->getSource();\n\n        $this->assertEmpty($this->object->getSource(), \"Source is null by default\");\n\n        $this->object->setSource(\"config.sample.inc.php\");\n\n        $this->assertEquals(\n            \"config.sample.inc.php\",\n            $this->object->getSource(),\n            \"Cant set new source\"\n        );\n    }\n\n\n    /**\n     * test for CheckPmaAbsoluteUriEmpty\n     *\n     * @return array\n     */\n    public function testCheckPmaAbsoluteUriEmpty()\n    {\n        $this->object->set('PmaAbsoluteUri', '');\n        $this->assertNull(\n            $this->object->checkPmaAbsoluteUri(),\n            'PmaAbsoluteUri is not set and should be error'\n        );\n        $this->assertTrue(\n            $this->object->error_pma_uri,\n            'PmaAbsoluteUri is not set and should be error'\n        );\n    }\n\n    /**\n     * Checks correcting of absolute URI\n     *\n     * @param string $real     Real URI received\n     * @param string $expected Expected corrected URI\n     *\n     * @return void\n     *\n     * @depends testCheckPmaAbsoluteUriEmpty\n     * @dataProvider absoluteUris\n     */\n    public function testCheckPmaAbsoluteUri($real, $expected)\n    {\n        $this->object->set('PmaAbsoluteUri', $real);\n        $this->object->checkPmaAbsoluteUri();\n        $this->assertEquals($expected, $this->object->get('PmaAbsoluteUri'));\n    }\n\n    /**\n     * return absolute Uris\n     *\n     * @return array\n     */\n    public function absoluteUris()\n    {\n        return array(\n            array(\n                'http://localhost/phpmyadmin/',\n                'http://localhost/phpmyadmin/',\n            ),\n            array(\n                'http://localhost/phpmyadmin',\n                'http://localhost/phpmyadmin/',\n            ),\n            array(\n                'localhost/phpmyadmin/',\n                'http://localhost/phpmyadmin/',\n            ),\n            array(\n                'http://user:pwd@localhost/phpmyadmin/index.php',\n                \"http://user:pwd@localhost/phpmyadmin/index.php/\",\n            ),\n            array(\n                'https://user:pwd@localhost/phpmyadmin/index.php',\n                \"https://user:pwd@localhost/phpmyadmin/index.php/\",\n            ),\n        );\n    }\n\n    /**\n     * Test for absolute URI composition\n     *\n     * @return void\n     *\n     * @depends testCheckPmaAbsoluteUri\n     */\n    public function testCheckPmaAbsoluteUriScheme()\n    {\n        $_SERVER['HTTP_HOST'] = 'localhost';\n        $_SERVER['HTTP_SCHEME'] = 'http';\n        $_SERVER['HTTPS'] = 'off';\n        $GLOBALS['PMA_PHP_SELF'] = 'index.php';\n\n        $this->object->set('PmaAbsoluteUri', '');\n\n        $this->object->checkPmaAbsoluteUri();\n        $this->assertEquals(\n            \"http://localhost/\",\n            $this->object->get('PmaAbsoluteUri')\n        );\n    }\n\n    /**\n     * test for CheckCollationConnection\n     *\n     * @return array\n     */\n    public function testCheckCollationConnection()\n    {\n        $_REQUEST['collation_connection'] = 'utf-8';\n        $this->object->checkCollationConnection();\n\n        $this->assertEquals(\n            $_REQUEST['collation_connection'],\n            $this->object->get('collation_connection')\n        );\n    }\n\n    /**\n     * test for IsHttp\n     *\n     * @return array\n     */\n    public function testIsHttps()\n    {\n        $this->object->set('is_https', null);\n        $this->object->set('PmaAbsoluteUri', 'http://some_host.com/phpMyAdmin');\n        $this->assertFalse($this->object->isHttps());\n\n        $this->object->set('is_https', null);\n        $this->object->set('PmaAbsoluteUri', 'https://some_host.com/phpMyAdmin');\n        $this->assertTrue($this->object->isHttps());\n    }\n\n    /**\n     * test for DetectHttps\n     *\n     * @return array\n     */\n    public function testDetectHttps()\n    {\n        unset($_SERVER['REQUEST_URI']);\n        unset($_SERVER['HTTP_SCHEME']);\n        unset($_SERVER['HTTPS']);\n\n        $this->assertFalse($this->object->detectHttps());\n\n        $_SERVER['REQUEST_URI'] = '/url:\\this_is_not_url';\n        $this->assertFalse($this->object->detectHttps());\n\n        $_SERVER['REQUEST_URI'] = 'file://localhost/phpmyadmin/index.php';\n        $this->assertFalse($this->object->detectHttps());\n\n        $_ENV['REQUEST_URI'] = 'http://localhost/phpmyadmin/index.php';\n        $this->assertFalse($this->object->detectHttps());\n\n        $_SERVER['REQUEST_URI'] = 'https://localhost/phpmyadmin/index.php';\n        $this->assertTrue($this->object->detectHttps());\n\n        $_SERVER['REQUEST_URI'] = 'localhost/phpmyadmin/index.php';\n        $_SERVER['HTTP_SCHEME'] = 'https';\n        $_SERVER['HTTPS'] = 'on';\n        $this->assertTrue($this->object->detectHttps());\n    }\n\n    /**\n     * Test for checking cookie path\n     *\n     * @return void\n     *\n     * @depends testDetectHttps\n     */\n    public function testCheckCookiePath()\n    {\n        $this->object->checkCookiePath();\n        echo $this->object->get('cookie_path');\n        $this->assertEquals('', $this->object->get('cookie_path'));\n    }\n\n    /**\n     * Test for backward compatibility globals\n     *\n     * @return void\n     *\n     * @depends testCheckSystem\n     * @depends testCheckWebServer\n     * @depends testLoadDefaults\n     *\n     * @group large\n     */\n    public function testEnableBc()\n    {\n        $this->object->enableBc();\n\n        $defines = array(\n            'PMA_VERSION',\n            'PMA_THEME_VERSION',\n            'PMA_THEME_GENERATION',\n            'PMA_PHP_STR_VERSION',\n            'PMA_PHP_INT_VERSION',\n            'PMA_IS_WINDOWS',\n            'PMA_IS_IIS',\n            'PMA_IS_GD2',\n            'PMA_USR_OS',\n            'PMA_USR_BROWSER_VER',\n            'PMA_USR_BROWSER_AGENT'\n            );\n\n        foreach ($defines as $define) {\n            $this->assertTrue(defined($define));\n            $this->assertEquals(constant($define), $this->object->get($define));\n        }\n    }\n\n    /**\n     * Test for getting cookie path\n     *\n     * @param string $absolute The absolute URL used for phpMyAdmin\n     * @param string $expected Expected cookie path\n     *\n     * @return void\n     *\n     * @dataProvider cookieUris\n     */\n    public function testGetCookiePath($absolute, $expected)\n    {\n        $this->object->set('PmaAbsoluteUri', $absolute);\n        $this->assertEquals($expected, $this->object->getCookiePath());\n    }\n\n    /**\n     * Data provider for testGetCookiePath\n     *\n     * @return array data for testGetCookiePath\n     */\n    public function cookieUris()\n    {\n        return array(\n            array(\n                'http://example.net/phpmyadmin/',\n                '/phpmyadmin/',\n            ),\n            array(\n                'http://example.net/',\n                '/',\n            ),\n        );\n    }\n\n    /**\n     * Tests loading of config file\n     *\n     * @param string  $source File name of config to load\n     * @param boolean $result Expected result of loading\n     *\n     * @return void\n     *\n     * @dataProvider configPaths\n     */\n    public function testLoad($source, $result)\n    {\n        if ($result) {\n            $this->assertTrue($this->object->load($source));\n        } else {\n            $this->assertFalse($this->object->load($source));\n        }\n    }\n\n    /**\n     * return of config Paths\n     *\n     * @return array\n     */\n    public function configPaths()\n    {\n        return array(\n            array(\n                './test/test_data/config.inc.php',\n                true,\n            ),\n            array(\n                './test/test_data/config-nonexisting.inc.php',\n                false,\n            ),\n            array(\n                './libraries/config.default.php',\n                true,\n            ),\n        );\n    }\n\n    /**\n     * Test for loading user preferences\n     *\n     * @return void\n     * @todo Test actually preferences loading\n     */\n    public function testLoadUserPreferences()\n    {\n        $this->assertNull($this->object->loadUserPreferences());\n    }\n\n    /**\n     * Test for setting user config value\n     *\n     * @return void\n     */\n    public function testSetUserValue()\n    {\n        $this->object->setUserValue(null, 'lang', 'cs', 'en');\n        $this->object->setUserValue(\"TEST_COOKIE_USER_VAL\", '', 'cfg_val_1');\n        $this->assertEquals(\n            $this->object->getUserValue(\"TEST_COOKIE_USER_VAL\", 'fail'),\n            'cfg_val_1'\n        );\n    }\n\n    /**\n     * Test for getting user config value\n     *\n     * @return void\n     */\n    public function testGetUserValue()\n    {\n        $this->assertEquals($this->object->getUserValue('test_val', 'val'), 'val');\n    }\n\n    /**\n     * Should test getting unique value for theme\n     *\n     * @return void\n     */\n    public function testGetThemeUniqueValue()\n    {\n\n        $_SESSION['PMA_Theme'] = PMA_Theme::load('./themes/pmahomme');\n\n        $partial_sum = (\n            PHPUnit_Framework_Assert::readAttribute($this->object, 'source_mtime') +\n            PHPUnit_Framework_Assert::readAttribute(\n                $this->object,\n                'default_source_mtime'\n            ) +\n            $this->object->get('user_preferences_mtime') +\n            $_SESSION['PMA_Theme']->mtime_info +\n            $_SESSION['PMA_Theme']->filesize_info\n        );\n\n        $this->object->set('fontsize', 10);\n        $this->assertEquals(10 + $partial_sum, $this->object->getThemeUniqueValue());\n        $this->object->set('fontsize', null);\n\n        $_COOKIE['pma_fontsize'] = 20;\n        $this->assertEquals(20 + $partial_sum, $this->object->getThemeUniqueValue());\n        unset($_COOKIE['pma_fontsize']);\n\n        $this->assertEquals($partial_sum, $this->object->getThemeUniqueValue());\n\n    }\n\n    /**\n     * Should test checking of config permissions\n     *\n     * @return void\n     */\n    public function testCheckPermissions()\n    {\n        //load file permissions for the current permissions file\n        $perms = @fileperms($this->object->getSource());\n        //testing for permissions for no configuration file\n        $this->assertFalse(!($perms === false) && ($perms & 2));\n\n        //load file permissions for the current permissions file\n        $perms = @fileperms($this->permTestObj->getSource());\n        //testing for permissions\n        $this->assertFalse(!($perms === false) && ($perms & 2));\n\n        //if the above assertion is false then applying further assertions\n        if (!($perms === false) && ($perms & 2)) {\n            $this->assertFalse($this->permTestObj->get('PMA_IS_WINDOWS') == 0);\n        }\n    }\n\n\n    /**\n     * Test for setting cookies\n     *\n     * @return void\n     */\n    public function testSetCookie()\n    {\n        $this->assertFalse(\n            $this->object->setCookie(\n                'TEST_DEF_COOKIE',\n                'test_def_123',\n                'test_def_123'\n            )\n        );\n\n        $this->assertTrue(\n            $this->object->setCookie(\n                'TEST_CONFIG_COOKIE',\n                'test_val_123',\n                null,\n                3600\n            )\n        );\n\n        $this->assertTrue(\n            $this->object->setCookie(\n                'TEST_CONFIG_COOKIE',\n                '',\n                'default_val'\n            )\n        );\n\n        $_COOKIE['TEST_MANUAL_COOKIE'] = 'some_test_val';\n        $this->assertTrue(\n            $this->object->setCookie(\n                'TEST_MANUAL_COOKIE',\n                'other',\n                'other'\n            )\n        );\n\n    }\n\n    /**\n     * Test for isGitRevision\n     *\n     * @return void\n     */\n    public function testIsGitRevision()\n    {\n        $this->assertTrue(\n            $this->object->isGitRevision()\n        );\n    }\n\n    /**\n     * Test for Check HTTP\n     *\n     * @group medium\n     *\n     * @return void\n     */\n    public function testCheckHTTP()\n    {\n        if (! function_exists('curl_init')) {\n            $this->markTestSkipped('Missing curl extension!');\n        }\n        $this->assertTrue(\n            $this->object->checkHTTP(\"https://www.phpmyadmin.net/test/data\")\n        );\n        $this->assertContains(\n            \"TEST DATA\",\n            $this->object->checkHTTP(\"https://www.phpmyadmin.net/test/data\", true)\n        );\n        $this->assertFalse(\n            $this->object->checkHTTP(\"https://www.phpmyadmin.net/test/nothing\")\n        );\n        // Use rate limit API as it's not subject to rate limiting\n        $this->assertContains(\n            '\"resources\"',\n            $this->object->checkHTTP(\"https://api.github.com/rate_limit\", true)\n        );\n    }\n\n    /**\n     * Tests for rewriting URL to SSL variant\n     *\n     * @param string $original Original URL\n     * @param string $expected Expected URL rewritten to SSL\n     *\n     * @return void\n     *\n     * @dataProvider sslUris\n     */\n    public function testSSLUri($original, $expected)\n    {\n        $this->object->set('PmaAbsoluteUri', $original);\n        $this->assertEquals($expected, $this->object->getSSLUri());\n    }\n\n\n    /**\n     * return of ssl Uris\n     *\n     * @return array\n     */\n    public function sslUris()\n    {\n        return array(\n            array(\n                'http://server.foo/path/',\n                'https://server.foo:443/path/'\n            ),\n            array(\n                'http://server.foo:80/path/',\n                'https://server.foo:443/path/'\n            ),\n            array(\n                'http://server.foo.bar:123/path/',\n                'https://server.foo.bar:443/path/'\n            ),\n            array(\n                'http://[FEDC:BA98:7654:3210:FEDC:BA98:7654:3210]:80/',\n                'https://[FEDC:BA98:7654:3210:FEDC:BA98:7654:3210]:443/'\n            ),\n            );\n    }\n}\n"], "filenames": ["libraries/Config.class.php", "test/classes/PMA_Config_test.php"], "buggy_code_start_loc": [777, 55], "buggy_code_end_loc": [779, 1049], "fixing_code_start_loc": [777, 56], "fixing_code_end_loc": [779, 1055], "type": "CWE-20", "message": "The checkHTTP function in libraries/Config.class.php in phpMyAdmin 4.5.x before 4.5.5.1 does not verify X.509 certificates from api.github.com SSL servers, which allows man-in-the-middle attackers to spoof these servers and obtain sensitive information via a crafted certificate.", "other": {"cve": {"id": "CVE-2016-2562", "sourceIdentifier": "cve@mitre.org", "published": "2016-03-01T11:59:04.643", "lastModified": "2016-12-03T03:25:39.467", "vulnStatus": "Modified", "descriptions": [{"lang": "en", "value": "The checkHTTP function in libraries/Config.class.php in phpMyAdmin 4.5.x before 4.5.5.1 does not verify X.509 certificates from api.github.com SSL servers, which allows man-in-the-middle attackers to spoof these servers and obtain sensitive information via a crafted certificate."}, {"lang": "es", "value": "La funci\u00f3n checkHTTP en libraries/Config.class.php en phpMyAdmin 4.5.x en versiones anteriores a 4.5.5.1 no verifica certificados X.509 desde los servidores SSL de api.github.com, lo que permite a atacantes man-in-the-middle suplantar estos servidores y obtener informaci\u00f3n sensible a trav\u00e9s de un certificado manipulado."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:H/PR:N/UI:N/S:C/C:N/I:H/A:N", "attackVector": "NETWORK", "attackComplexity": "HIGH", "privilegesRequired": "NONE", "userInteraction": "NONE", "scope": "CHANGED", "confidentialityImpact": "NONE", "integrityImpact": "HIGH", "availabilityImpact": "NONE", "baseScore": 6.8, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.2, "impactScore": 4.0}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:P/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "PARTIAL", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 5.8}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 4.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-20"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:phpmyadmin:phpmyadmin:4.5.0:*:*:*:*:*:*:*", "matchCriteriaId": "A4D7AAF1-64FF-40C9-90B2-DEC814157372"}, {"vulnerable": true, "criteria": "cpe:2.3:a:phpmyadmin:phpmyadmin:4.5.0:beta1:*:*:*:*:*:*", "matchCriteriaId": "F90283AD-A616-403C-BE69-BCB2FD58A2CC"}, {"vulnerable": true, "criteria": "cpe:2.3:a:phpmyadmin:phpmyadmin:4.5.0:beta2:*:*:*:*:*:*", "matchCriteriaId": "043B846F-4CDF-402A-B14A-B4949B1D403E"}, {"vulnerable": true, "criteria": "cpe:2.3:a:phpmyadmin:phpmyadmin:4.5.0:rc1:*:*:*:*:*:*", "matchCriteriaId": "C7B52D3D-C5F0-4793-AFA3-C518400DB71C"}, {"vulnerable": true, "criteria": "cpe:2.3:a:phpmyadmin:phpmyadmin:4.5.0.1:*:*:*:*:*:*:*", "matchCriteriaId": "96D529F5-8870-4934-BCD8-E49095D21224"}, {"vulnerable": true, "criteria": "cpe:2.3:a:phpmyadmin:phpmyadmin:4.5.0.2:*:*:*:*:*:*:*", "matchCriteriaId": "296EB2FA-FCAD-4BD5-A015-62765407AFE5"}, {"vulnerable": true, "criteria": "cpe:2.3:a:phpmyadmin:phpmyadmin:4.5.1:*:*:*:*:*:*:*", "matchCriteriaId": "4DBD0DC7-64D0-42B1-8EEE-73A0214680F5"}, {"vulnerable": true, "criteria": "cpe:2.3:a:phpmyadmin:phpmyadmin:4.5.2:*:*:*:*:*:*:*", "matchCriteriaId": "A6A15D1E-83ED-47EC-B17C-E6BCC49DE83D"}, {"vulnerable": true, "criteria": "cpe:2.3:a:phpmyadmin:phpmyadmin:4.5.3:*:*:*:*:*:*:*", "matchCriteriaId": "4112ACFF-D40E-45BE-9307-F710E7B41ECD"}, {"vulnerable": true, "criteria": "cpe:2.3:a:phpmyadmin:phpmyadmin:4.5.3.1:*:*:*:*:*:*:*", "matchCriteriaId": "5B476503-1A1B-408B-9E66-1E4940090AA2"}, {"vulnerable": true, "criteria": "cpe:2.3:a:phpmyadmin:phpmyadmin:4.5.4:*:*:*:*:*:*:*", "matchCriteriaId": "7123D6E6-3AE7-4413-AD6E-0D68D44C6F94"}, {"vulnerable": true, "criteria": "cpe:2.3:a:phpmyadmin:phpmyadmin:4.5.4.1:*:*:*:*:*:*:*", "matchCriteriaId": "05A2EBE2-E55C-45DF-A74C-1B5F7E6EEC25"}, {"vulnerable": true, "criteria": "cpe:2.3:a:phpmyadmin:phpmyadmin:4.5.5:*:*:*:*:*:*:*", "matchCriteriaId": "909DFCAB-A44B-4EB8-B54D-066699AE760B"}]}]}], "references": [{"url": "http://lists.fedoraproject.org/pipermail/package-announce/2016-March/178562.html", "source": "cve@mitre.org"}, {"url": "http://lists.fedoraproject.org/pipermail/package-announce/2016-March/178869.html", "source": "cve@mitre.org"}, {"url": "https://github.com/phpmyadmin/phpmyadmin/commit/e42b7e3aedd29dd0f7a48575f20bfc5aca0ff976", "source": "cve@mitre.org", "tags": ["Patch"]}, {"url": "https://www.phpmyadmin.net/security/PMASA-2016-13/", "source": "cve@mitre.org", "tags": ["Patch", "Vendor Advisory"]}]}, "github_commit_url": "https://github.com/phpmyadmin/phpmyadmin/commit/e42b7e3aedd29dd0f7a48575f20bfc5aca0ff976"}}