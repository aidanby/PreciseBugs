{"buggy_code": ["[% IF task %]\n    [% IF task.id %]\n        <h3>[% task.name %]</h3>\n    [% ELSE %]\n        <h3>Create new service item</h3>\n    [% END %]\n    <form role=\"form\" method=\"post\">\n        <input type=\"hidden\" name=\"csrf_token\" value=\"[% csrf_token %]\">\n        <div class=\"form-group\">\n            <label for=\"name\">Title</label>\n            <input type=\"text\" name=\"name\" class=\"form-control\" id=\"name\" value=\"[% task.name | html %]\">\n        </div>\n        <div class=\"form-group\">\n            <label for=\"description\">Description</label>\n            <input type=\"text\" name=\"description\" class=\"form-control\" id=\"description\" value=\"[% task.description | html %]\">\n        </div>\n        [% IF login.is_admin %]\n            <div class=\"form-group\">\n                <label for=\"tasktype_id\">Type (<a data-toggle=\"modal\" data-target=\"#modalnewtasktype\" href=\"\">add</a>)</label>\n                <select class=\"form-control\" id=\"tasktype_id\" name=\"tasktype_id\">\n                    <option value=\"\" [% UNLESS task.tasktype_id %]selected[% END %]></option>\n                    [% FOREACH tasktype IN tasktypes %]\n                        <option value=\"[% tasktype.id %]\"\n                            [% IF task.tasktype_id == tasktype.id %]selected[% END %]>[% tasktype.name | html %]\n                        </option>\n                    [% END %]\n                </select>\n            </div>\n            <div class=\"form-group\">\n                <label for=\"contractor_requirements\">Contractor requirements</label>\n                <textarea name=\"contractor_requirements\" class=\"form-control\" id=\"contractor_requirements\"\n                    rows=\"3\">[% task.contractor_requirements | html %]</textarea>\n            </div>\n            <div class=\"form-group\">\n                <label for=\"evidence_required\">Evidence required</label>\n                <textarea name=\"evidence_required\" class=\"form-control\" id=\"evidence_required\"\n                    rows=\"3\">[% task.evidence_required | html %]</textarea>\n            </div>\n            <div class=\"form-group\">\n                <label for=\"statutory\">Statutory/regulatory notes</label>\n                <textarea name=\"statutory\" class=\"form-control\" id=\"statutory\"\n                    rows=\"3\">[% task.statutory | html %]</textarea>\n            </div>\n        [% END %]\n        <div class=\"form-group\">\n            <label>Frequency</label>\n            <div class=\"row\">\n                <div class=\"col-xs-2\">\n                    <input type=\"text\" name=\"period_qty\" class=\"form-control\"\n                        id=\"period_qty\" placeholder=\"Quantity\" value=\"[% task.period_qty %]\">\n                </div>\n                <div class=\"col-xs-2\">\n                    <select class=\"form-control\" id=\"period_unit\" name=\"period_unit\">\n                        [% FOREACH period_unit IN [ 'day' 'week' 'month' 'year' ] %]\n                        <option value=\"[% period_unit %]\"\n                        [% IF task.period_unit == period_unit %]selected[% END %]>[% period_unit FILTER ucfirst %]\n                        </option>\n                        [% END %]\n                    </select>\n                </div>\n            </div>\n        </div>\n        [% UNLESS login.is_admin %]\n        <div class=\"form-group\">\n            <div class=\"row\">\n                <div class=\"col-xs-4\">\n                    <label for=\"site_id\">Site</label>\n                    [% site_id = task.site_id || site.id %]\n                    <select class=\"form-control\" id=\"site_id\" name=\"site_id\" [% readonly %]>\n                        [% FOR site IN login.sites %]\n                        <option value=\"[% site.id %]\" [% IF site.id == site_id %]selected[% END %]>[% site.org.name %] ([% site.name %])</option>\n                        [% END %]\n                    </select>\n                </div>\n            </div>\n        </div>\n        [% END %]\n        <div class=\"form-group\">\n            <button type=\"submit\" name=\"submit\" value=\"submit\" class=\"btn btn-primary\">\n                [% IF task.id %]Update[% ELSE %]Create[% END %]\n            </button>\n            [% IF task.id %]\n                <button type=\"submit\" name=\"delete\" value=\"submit\" class=\"btn btn-default\">Delete</button>\n            [% END %]\n            <a href=\"/task\" role=\"button\" class=\"btn btn-default\">Cancel</a>\n        </div>\n    </form>\n\n[% ELSE %]\n    [% IF site.id OR login.is_admin %]\n        <h3>Service items\n\t[% IF site.id %]\n            ([% site.org.name %] - [% site.name %])\n        [% ELSE %]\n            (All sites)\n        [% END %]\n\t</h3>\n        <div class=\"row\">\n            <div class=\"col-md-8\">\n                <div class=\"btn-toolbar\">\n                    [% IF login.is_admin %]\n                        <div class=\"btn-group\">\n                            <a href=\"\" class=\"btn btn-default\" data-toggle=\"modal\" data-target=\"#modal_add_task\">Add service item to site...</a>\n                        </div>\n                        <div class=\"btn-group\">\n                            <a href=\"/task/0\" class=\"btn btn-default\" role=\"button\">Create new service item</a>\n                        </div>\n                    [% END %]\n                    <div class=\"btn-group dropdown\">\n                        <a class=\"btn btn-default dropdown-toggle\" role=\"button\" data-toggle=\"dropdown\" href=\"#\">Download <b class=\"caret\"></b></a>\n                        <ul class=\"dropdown-menu\" role=\"menu\" aria-labelledby=\"drop4\">\n                            <li role=\"presentation\"><a role=\"menuitem\" tabindex=\"-1\" href=\"?csv=service\">As CSV</a></li>\n                            [% IF login.is_admin %]\n                                <li role=\"presentation\"><a role=\"menuitem\" tabindex=\"-1\" href=\"?sla=pdf\">Download SLA</a></li>\n                                <li role=\"presentation\"><a role=\"menuitem\" tabindex=\"-1\" href=\"?finsum=pdf\">Download Financial Summary</a></li>\n                            [% END %]\n                        </ul>\n                    </div>\n                    [% IF login.is_admin AND show_populate %]\n                        <div class=\"btn-group\">\n                            <a class=\"btn btn-default\" data-toggle=\"modal\" data-target=\"#modal_populate\" href=\"\">Populate...</a>\n                        </div>\n                    [% END %]\n                </div>\n            </div>\n            <div class=\"col-md-4\">\n                [% IF site.id %]\n                <form method=\"get\">\n                    <input type=\"hidden\" name=\"csrf_token\" value=\"[% csrf_token %]\">\n                    <select class=\"form-control\" name=\"fy\" onchange=\"this.form.submit()\">\n                        [% FOR fy IN site.fys %]\n                            <option value=\"[% fy.year %]\" [% IF session.fy == fy.year %]selected[% END %]>Show costs for [% fy.name %]</option>\n                        [% END %]\n                    </select>\n                </form>\n                [% END %]\n            </div>\n        </div>\n        <p></p>\n\n        [% IF login.is_admin %]\n            <form method=\"post\">\n                <input type=\"hidden\" name=\"csrf_token\" value=\"[% csrf_token %]\">\n        [% END %]\n        [% IF session.fy == site.fys.last.year # Don't show out of date planned/completed dates %]\n            [% show_dates = 1 %]\n        [% END %]\n        <table class=\"table table-striped\">\n            <tr>\n                <th>Type</th>\n                <th>Task</th>\n                [% IF site.id %]\n                    <th>Contractor</th>\n                [% END %]\n                <th>Frequency</th>\n                [% IF site.id %]\n                    [% IF show_dates %]\n                        <th>Last done</th>\n                    [% END %]\n                    <th>Cost (planned)</th>\n                    <th>Cost (actual[% IF show_dates %] to date[% END %])</th>\n                [% END %]\n            </tr>\n\n            [% cost_planned_total = 0 %][% cost_actual_total = 0 %]\n            [% FOR task IN tasks %]\n                    <tr>\n                        <td>[% task.tasktype.name | html %]</td>\n                        <td>\n                            [% IF site.id %]\n                                <a href=\"/tickets?task_id=[% task.id %]\" title=\"View tickets related to this task\">[% task.name | html %]</a>\n                                [% IF login.is_admin %]\n                                (<a href=\"/ticket/0?task_id=[% task.id %]\" title=\"Create new ticket related to this task\">Create ticket</a> | <a href=\"/task/[% task.id %]\">Edit task</a> | <a href=\"javascript:;\" data-toggle=\"modal\" data-target=\"#modal_rm_task\" data-task-id=\"[% task.id %]\">Remove</a>)\n                                [% END %]\n                            [% ELSE %]\n                                <a href=\"/task/[% task.id %]\">[% task.name | html %]</a>\n                            [% END %]\n                        </td>\n                        [% IF site.id %]\n                            <td>[% task.contractor_name | html %]</td>\n                        [% END %]\n                        <td>[% task.period_qty %] [% task.period_unit %][% IF task.period_qty > 1 %]s[% END %]</td>\n                        [% IF site.id %]\n                            [% IF show_dates %]\n                                <td style=\"white-space:nowrap\">\n                                    [% task_id = task.id %]\n                                    [% IF task.last_completed %]\n                                        [% task.last_completed.strftime(dateformat) %]\n                                    [% ELSE %]\n                                        (never)\n                                    [% END %]\n                                </td>\n                            [% END %]\n                            <td>[% task.cost_planned %]</td>\n                            <td>[% task.cost_actual %]</td>\n                        [% END %]\n                    </tr>\n                [% IF site.id AND task.cost_planned %][% cost_planned_total = cost_planned_total + task.cost_planned %][% END %]\n                [% IF site.id AND task.cost_actual %][% cost_actual_total = cost_actual_total + task.cost_actual %][% END %]\n            [% END %]\n            [% IF site.id %]\n                <tr>\n                    <th>Totals</th>\n                    <th></th>\n                    <th></th>\n                    <th></th>\n                    [% IF show_dates %]\n                        <th></th>\n                    [% END %]\n                    <th>[% FILTER format('%.2f') %][% cost_planned_total %][% END %]</th>\n                    <th>[% FILTER format('%.2f') %][% cost_actual_total %][% END %]</th>\n                </tr>\n            [% END %]\n        </table>\n        [% IF login.is_admin %]\n        </form>\n        [% END %]\n\n        [% IF site.id %]\n            <h3>Site Manager Checks ([% site.org.name %] - [% site.name %])\n                <small>\n                    <a data-toggle=\"modal\" data-target=\"#modal_download\" href=\"\">Download</a>\n                </small>\n            </h3>\n            <p>\n                <a href=\"/check_edit/0\" class=\"btn btn-default\" role=\"button\">Create new site check</a>\n            </p>\n            [% IF site_checks.size %]\n                <table class=\"table table-striped\">\n                    <tr>\n                        <th>Check</th>\n                        <th>Frequency</th>\n                        <th>Last done</th>\n                    </tr>\n\n                    [% FOR check IN site_checks %]\n                        <tr>\n                            <td><a href=\"/check_edit/[% check.id %]\">[% check.name %]</a></td>\n                            <td>[% check.period_qty %] [% check.period_unit %][% IF check.period_qty > 1 %]s[% END %]</td>\n                            [% IF site.id %]\n                                <td>[% check.last_completed.strftime(dateformat) %]</td>\n                            [% END %]\n                        </tr>\n                    [% END %]\n                </table>\n            [% END %]\n        [% END %]\n    [% END %]\n\n    [% IF site.id %]\n\n        <h3>Reactive maintenance and quotes\n            <small><a href=\"?csv=reactive\">Download</a></small>\n        </h3>\n        <table class=\"table table-striped\">\n            [% cost_planned_total = 0 %][% cost_actual_total = 0 %]\n            <tr>\n                <th>Title</th>\n                <th>Cost (planned)</th>\n                <th>Cost (actual to date)</th>\n            </tr>\n\n            [% FOR adhoc IN adhocs %]\n                <tr>\n                    <td><a href=\"/ticket/[% adhoc.id %]\">[% adhoc.name %]</a></td>\n                    <td>[% adhoc.cost_planned %]</td>\n                    <td>[% adhoc.cost_actual %]</td>\n                </tr>\n                [% IF adhoc.cost_planned %][% cost_planned_total = cost_planned_total + adhoc.cost_planned %][% END %]\n                [% IF adhoc.cost_actual %][% cost_actual_total = cost_actual_total + adhoc.cost_actual %][% END %]\n            [% END %]\n            <tr>\n                <th>Totals</th>\n                <th>[% FILTER format('%.2f') %][% cost_planned_total %][% END %]</th>\n                <th>[% FILTER format('%.2f') %][% cost_actual_total %][% END %]</th>\n            </tr>\n        </table>\n\n        <h3>Local items</h3>\n\n        [% UNLESS login.is_admin %]\n            <p>\n                <a href=\"/task/0\" class=\"btn btn-default\" role=\"button\">Create new service item</a>\n            </p>\n        [% END %]\n        [% IF tasks_local.size %]\n        <table class=\"table table-striped\">\n            <tr>\n                <th>Task</th>\n                <th>Frequency</th>\n                <th>Planned</th>\n                <th>Last done</th>\n            </tr>\n\n                [% FOR task IN tasks_local %]\n                <tr>\n                    <td><a href=\"/task/[% task.id %]\">[% task.name %]</a></td>\n                    <td>[% task.period_qty %] [% task.period_unit %][% IF task.period_qty > 1 %]s[% END %]</td>\n                    [% IF site.id %]\n                        <td>[% task.planned.strftime(dateformat) %]</td>\n                        <td>\n                            [% IF task.tickets.first.completed %]\n                            [% task.tickets.first.completed.strftime(dateformat) %]\n                            [% ELSE %]\n                            (never)\n                            [% END %]\n                        </td>\n                    [% END %]\n                </tr>\n                [% END %]\n        </table>\n        [% ELSE %]\n            <p>No local items created</p>\n        [% END %]\n    [% END %]\n[% END %]\n\n<!-- Modal -->\n<div class=\"modal fade\" id=\"modalnewtasktype\" tabindex=\"-1\" role=\"dialog\" aria-labelledby=\"myModalLabel\" aria-hidden=\"true\">\n    <div class=\"modal-dialog\">\n        <form role=\"form\" method=\"post\">\n        <input type=\"hidden\" name=\"csrf_token\" value=\"[% csrf_token %]\">\n        <div class=\"modal-content\">\n            <div class=\"modal-header\">\n                <button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-hidden=\"true\">&times;</button>\n                <h4 class=\"modal-title\" id=\"myModalLabel\">Add task type</h4>\n            </div>\n            <div class=\"modal-body\">\n                <p>Please enter the name of a new task type:</p>\n                <div class=\"form-group\">\n                    <input type=\"text\" class=\"form-control\" id=\"tasktype_name\" name=\"tasktype_name\" placeholder=\"New task type\">\n                </div>\n            </div>\n            <div class=\"modal-footer\">\n                <button type=\"submit\" value=\"submit\" class=\"btn btn-primary\" name=\"tasktype_add\">Add</button>\n            </div>\n        </div><!-- /.modal-content -->\n        </form>\n    </div><!-- /.modal-dialog -->\n</div><!-- /.modal -->\n\n<!-- Modal -->\n<div class=\"modal fade\" id=\"modal_download\" tabindex=\"-1\" role=\"dialog\" aria-labelledby=\"myModalLabel\" aria-hidden=\"true\">\n    <div class=\"modal-dialog\">\n        <div class=\"modal-content\">\n            <form role=\"form\" method=\"post\">\n            <input type=\"hidden\" name=\"csrf_token\" value=\"[% csrf_token %]\">\n            <div class=\"modal-header\">\n                <button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-hidden=\"true\">&times;</button>\n                <h4 class=\"modal-title\" id=\"myModalLabel\">Download site checks</h4>\n            </div>\n            <div class=\"modal-body\">\n                <div class=\"form-group\">\n                    <label for=\"download_from\" class=\"control-label\">From</label>\n                    <input type=\"text\" name=\"download_from\" id=\"download_from\" value=\"[% download.default_from.ymd %]\"\n                        class=\"form-control datepicker\">\n                </div>\n                <div class=\"form-group\">\n                    <label for=\"download_to\" class=\"control-label\">To</label>\n                    <input type=\"text\" name=\"download_to\" id=\"download_to\" value=\"[% download.default_to.ymd %]\"\n                        class=\"form-control datepicker\">\n                </div>\n            </div>\n            <div class=\"modal-footer\">\n                <button type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\">Cancel</button>\n                <button type=\"submit\" name=\"download_site_checks\" value=\"download\" class=\"btn btn-primary\">Download</button>\n            </div>\n            </form>\n        </div><!-- /.modal-content -->\n    </div><!-- /.modal-dialog -->\n</div><!-- /.modal -->\n\n<!-- Modal -->\n<div class=\"modal fade\" id=\"modal_populate\" tabindex=\"-1\" role=\"dialog\" aria-labelledby=\"modal_populate_label\" aria-hidden=\"true\">\n    <div class=\"modal-dialog\">\n        <div class=\"modal-content\">\n            <form role=\"form\" method=\"post\">\n            <input type=\"hidden\" name=\"csrf_token\" value=\"[% csrf_token %]\">\n            <div class=\"modal-header\">\n                <button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-hidden=\"true\">&times;</button>\n                <h4 class=\"modal-title\" id=\"modal_populate_label\">Populate tickets from previous year</h4>\n            </div>\n            <div class=\"modal-body\">\n                <div class=\"form-group\">\n                    <label for=\"populate_from\" class=\"control-label\">From</label>\n                    <select class=\"form-control\" name=\"populate_from\">\n                        [% FOR fy IN site.fys %]\n                            <option value=\"[% fy.year %]\">Copy tickets from [% fy.name %]</option>\n                        [% END %]\n                    </select>\n                </div>\n            </div>\n            <div class=\"modal-footer\">\n                <button type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\">Cancel</button>\n                <button type=\"submit\" name=\"populate\" value=\"download\" class=\"btn btn-primary\">Populate</button>\n            </div>\n            </form>\n        </div><!-- /.modal-content -->\n    </div><!-- /.modal-dialog -->\n</div><!-- /.modal -->\n\n<!-- Modal -->\n<div class=\"modal fade\" id=\"modal_add_task\" tabindex=\"-1\" role=\"dialog\" aria-labelledby=\"myModalLabel\" aria-hidden=\"true\">\n    <div class=\"modal-dialog\">\n\t<div class=\"modal-content\">\n\t    <form role=\"form\" method=\"post\">\n            <input type=\"hidden\" name=\"csrf_token\" value=\"[% csrf_token %]\">\n\t    <div class=\"modal-header\">\n\t\t<button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-hidden=\"true\">&times;</button>\n\t\t<h4 class=\"modal-title\" id=\"myModalLabel\">Add service item to this site</h4>\n\t    </div>\n\t    <div class=\"modal-body\">\n                <div class=\"form-group\">\n                    <label for=\"taskadd\" class=\"control-label\">Service item to add</label>\n                    <select class=\"form-control\" id=\"taskadd\" name=\"taskadd\">\n                        [% FOREACH t IN all_tasks %]\n                            <option value=\"[% t.id %]\">[% t.name | html %]</option>\n                        [% END %]\n                    </select>\n                </div>\n\t    </div>\n\t    <div class=\"modal-footer\">\n\t\t<button type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\">Cancel</button>\n\t\t<button type=\"submit\" name=\"add_task\" value=\"submit\" class=\"btn btn-primary\">Add</button>\n\t    </div>\n\t    </form>\n\t</div><!-- /.modal-content -->\n    </div><!-- /.modal-dialog -->\n</div><!-- /.modal -->\n\n<!-- Modal -->\n<div class=\"modal fade\" id=\"modal_rm_task\" tabindex=\"-1\" role=\"dialog\" aria-labelledby=\"myModalLabel\" aria-hidden=\"true\">\n    <div class=\"modal-dialog\">\n\t<div class=\"modal-content\">\n\t    <form role=\"form\" method=\"post\">\n            <input type=\"hidden\" name=\"csrf_token\" value=\"[% csrf_token %]\">\n\t    <div class=\"modal-header\">\n\t\t<button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-hidden=\"true\">&times;</button>\n\t\t<h4 class=\"modal-title\" id=\"myModalLabel\">Add service item to this site</h4>\n\t    </div>\n\t    <div class=\"modal-body\">\n                <input type=\"hidden\" name=\"taskrm\" id=\"taskrm\" value=\"\">\n                <p>Are you sure you want to remove this task from the site?</p>\n\t    </div>\n\t    <div class=\"modal-footer\">\n\t\t<button type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\">Cancel</button>\n\t\t<button type=\"submit\" name=\"rm_task\" value=\"submit\" class=\"btn btn-primary\">Remove</button>\n\t    </div>\n\t    </form>\n\t</div><!-- /.modal-content -->\n    </div><!-- /.modal-dialog -->\n</div><!-- /.modal -->\n"], "fixing_code": ["[% IF task %]\n    [% IF task.id %]\n        <h3>[% task.name %]</h3>\n    [% ELSE %]\n        <h3>Create new service item</h3>\n    [% END %]\n    <form role=\"form\" method=\"post\">\n        <input type=\"hidden\" name=\"csrf_token\" value=\"[% csrf_token %]\">\n        <div class=\"form-group\">\n            <label for=\"name\">Title</label>\n            <input type=\"text\" name=\"name\" class=\"form-control\" id=\"name\" value=\"[% task.name | html %]\">\n        </div>\n        <div class=\"form-group\">\n            <label for=\"description\">Description</label>\n            <input type=\"text\" name=\"description\" class=\"form-control\" id=\"description\" value=\"[% task.description | html %]\">\n        </div>\n        [% IF login.is_admin %]\n            <div class=\"form-group\">\n                <label for=\"tasktype_id\">Type (<a data-toggle=\"modal\" data-target=\"#modalnewtasktype\" href=\"\">add</a>)</label>\n                <select class=\"form-control\" id=\"tasktype_id\" name=\"tasktype_id\">\n                    <option value=\"\" [% UNLESS task.tasktype_id %]selected[% END %]></option>\n                    [% FOREACH tasktype IN tasktypes %]\n                        <option value=\"[% tasktype.id %]\"\n                            [% IF task.tasktype_id == tasktype.id %]selected[% END %]>[% tasktype.name | html %]\n                        </option>\n                    [% END %]\n                </select>\n            </div>\n            <div class=\"form-group\">\n                <label for=\"contractor_requirements\">Contractor requirements</label>\n                <textarea name=\"contractor_requirements\" class=\"form-control\" id=\"contractor_requirements\"\n                    rows=\"3\">[% task.contractor_requirements | html %]</textarea>\n            </div>\n            <div class=\"form-group\">\n                <label for=\"evidence_required\">Evidence required</label>\n                <textarea name=\"evidence_required\" class=\"form-control\" id=\"evidence_required\"\n                    rows=\"3\">[% task.evidence_required | html %]</textarea>\n            </div>\n            <div class=\"form-group\">\n                <label for=\"statutory\">Statutory/regulatory notes</label>\n                <textarea name=\"statutory\" class=\"form-control\" id=\"statutory\"\n                    rows=\"3\">[% task.statutory | html %]</textarea>\n            </div>\n        [% END %]\n        <div class=\"form-group\">\n            <label>Frequency</label>\n            <div class=\"row\">\n                <div class=\"col-xs-2\">\n                    <input type=\"text\" name=\"period_qty\" class=\"form-control\"\n                        id=\"period_qty\" placeholder=\"Quantity\" value=\"[% task.period_qty %]\">\n                </div>\n                <div class=\"col-xs-2\">\n                    <select class=\"form-control\" id=\"period_unit\" name=\"period_unit\">\n                        [% FOREACH period_unit IN [ 'day' 'week' 'month' 'year' ] %]\n                        <option value=\"[% period_unit %]\"\n                        [% IF task.period_unit == period_unit %]selected[% END %]>[% period_unit FILTER ucfirst %]\n                        </option>\n                        [% END %]\n                    </select>\n                </div>\n            </div>\n        </div>\n        [% UNLESS login.is_admin %]\n        <div class=\"form-group\">\n            <div class=\"row\">\n                <div class=\"col-xs-4\">\n                    <label for=\"site_id\">Site</label>\n                    [% site_id = task.site_id || site.id %]\n                    <select class=\"form-control\" id=\"site_id\" name=\"site_id\" [% readonly %]>\n                        [% FOR site IN login.sites %]\n                        <option value=\"[% site.id %]\" [% IF site.id == site_id %]selected[% END %]>[% site.org.name %] ([% site.name %])</option>\n                        [% END %]\n                    </select>\n                </div>\n            </div>\n        </div>\n        [% END %]\n        <div class=\"form-group\">\n            <button type=\"submit\" name=\"submit\" value=\"submit\" class=\"btn btn-primary\">\n                [% IF task.id %]Update[% ELSE %]Create[% END %]\n            </button>\n            [% IF task.id %]\n                <button type=\"submit\" name=\"delete\" value=\"submit\" class=\"btn btn-default\">Delete</button>\n            [% END %]\n            <a href=\"/task\" role=\"button\" class=\"btn btn-default\">Cancel</a>\n        </div>\n    </form>\n\n[% ELSE %]\n    [% IF site.id OR login.is_admin %]\n        <h3>Service items\n\t[% IF site.id %]\n            ([% site.org.name %] - [% site.name %])\n        [% ELSE %]\n            (All sites)\n        [% END %]\n\t</h3>\n        <div class=\"row\">\n            <div class=\"col-md-8\">\n                <div class=\"btn-toolbar\">\n                    [% IF login.is_admin %]\n                        <div class=\"btn-group\">\n                            <a href=\"\" class=\"btn btn-default\" data-toggle=\"modal\" data-target=\"#modal_add_task\">Add service item to site...</a>\n                        </div>\n                        <div class=\"btn-group\">\n                            <a href=\"/task/0\" class=\"btn btn-default\" role=\"button\">Create new service item</a>\n                        </div>\n                    [% END %]\n                    <div class=\"btn-group dropdown\">\n                        <a class=\"btn btn-default dropdown-toggle\" role=\"button\" data-toggle=\"dropdown\" href=\"#\">Download <b class=\"caret\"></b></a>\n                        <ul class=\"dropdown-menu\" role=\"menu\" aria-labelledby=\"drop4\">\n                            <li role=\"presentation\"><a role=\"menuitem\" tabindex=\"-1\" href=\"?csv=service\">As CSV</a></li>\n                            [% IF login.is_admin %]\n                                <li role=\"presentation\"><a role=\"menuitem\" tabindex=\"-1\" href=\"?sla=pdf\">Download SLA</a></li>\n                                <li role=\"presentation\"><a role=\"menuitem\" tabindex=\"-1\" href=\"?finsum=pdf\">Download Financial Summary</a></li>\n                            [% END %]\n                        </ul>\n                    </div>\n                    [% IF login.is_admin AND show_populate %]\n                        <div class=\"btn-group\">\n                            <a class=\"btn btn-default\" data-toggle=\"modal\" data-target=\"#modal_populate\" href=\"\">Populate...</a>\n                        </div>\n                    [% END %]\n                </div>\n            </div>\n            <div class=\"col-md-4\">\n                [% IF site.id %]\n                <form method=\"get\">\n                    <input type=\"hidden\" name=\"csrf_token\" value=\"[% csrf_token %]\">\n                    <select class=\"form-control\" name=\"fy\" onchange=\"this.form.submit()\">\n                        [% FOR fy IN site.fys %]\n                            <option value=\"[% fy.year %]\" [% IF session.fy == fy.year %]selected[% END %]>Show costs for [% fy.name %]</option>\n                        [% END %]\n                    </select>\n                </form>\n                [% END %]\n            </div>\n        </div>\n        <p></p>\n\n        [% IF login.is_admin %]\n            <form method=\"post\">\n                <input type=\"hidden\" name=\"csrf_token\" value=\"[% csrf_token %]\">\n        [% END %]\n        [% IF session.fy == site.fys.last.year # Don't show out of date planned/completed dates %]\n            [% show_dates = 1 %]\n        [% END %]\n        <table class=\"table table-striped\">\n            <tr>\n                <th>Type</th>\n                <th>Task</th>\n                [% IF site.id %]\n                    <th>Contractor</th>\n                [% END %]\n                <th>Frequency</th>\n                [% IF site.id %]\n                    [% IF show_dates %]\n                        <th>Last done</th>\n                    [% END %]\n                    <th>Cost (planned)</th>\n                    <th>Cost (actual[% IF show_dates %] to date[% END %])</th>\n                [% END %]\n            </tr>\n\n            [% cost_planned_total = 0 %][% cost_actual_total = 0 %]\n            [% FOR task IN tasks %]\n                    <tr>\n                        <td>[% task.tasktype.name | html %]</td>\n                        <td>\n                            [% IF site.id %]\n                                <a href=\"/tickets?task_id=[% task.id %]\" title=\"View tickets related to this task\">[% task.name | html %]</a>\n                                [% IF login.is_admin %]\n                                (<a href=\"/ticket/0?task_id=[% task.id %]\" title=\"Create new ticket related to this task\">Create ticket</a> | <a href=\"/task/[% task.id %]\">Edit task</a> | <a href=\"javascript:;\" data-toggle=\"modal\" data-target=\"#modal_rm_task\" data-task-id=\"[% task.id %]\">Remove</a>)\n                                [% END %]\n                            [% ELSE %]\n                                <a href=\"/task/[% task.id %]\">[% task.name | html %]</a>\n                            [% END %]\n                        </td>\n                        [% IF site.id %]\n                            <td>[% task.contractor_name | html %]</td>\n                        [% END %]\n                        <td>[% task.period_qty %] [% task.period_unit %][% IF task.period_qty > 1 %]s[% END %]</td>\n                        [% IF site.id %]\n                            [% IF show_dates %]\n                                <td style=\"white-space:nowrap\">\n                                    [% task_id = task.id %]\n                                    [% IF task.last_completed %]\n                                        [% task.last_completed.strftime(dateformat) %]\n                                    [% ELSE %]\n                                        (never)\n                                    [% END %]\n                                </td>\n                            [% END %]\n                            <td>[% task.cost_planned %]</td>\n                            <td>[% task.cost_actual %]</td>\n                        [% END %]\n                    </tr>\n                [% IF site.id AND task.cost_planned %][% cost_planned_total = cost_planned_total + task.cost_planned %][% END %]\n                [% IF site.id AND task.cost_actual %][% cost_actual_total = cost_actual_total + task.cost_actual %][% END %]\n            [% END %]\n            [% IF site.id %]\n                <tr>\n                    <th>Totals</th>\n                    <th></th>\n                    <th></th>\n                    <th></th>\n                    [% IF show_dates %]\n                        <th></th>\n                    [% END %]\n                    <th>[% FILTER format('%.2f') %][% cost_planned_total %][% END %]</th>\n                    <th>[% FILTER format('%.2f') %][% cost_actual_total %][% END %]</th>\n                </tr>\n            [% END %]\n        </table>\n        [% IF login.is_admin %]\n        </form>\n        [% END %]\n\n        [% IF site.id %]\n            <h3>Site Manager Checks ([% site.org.name | html %] - [% site.name | html %])\n                <small>\n                    <a data-toggle=\"modal\" data-target=\"#modal_download\" href=\"\">Download</a>\n                </small>\n            </h3>\n            <p>\n                <a href=\"/check_edit/0\" class=\"btn btn-default\" role=\"button\">Create new site check</a>\n            </p>\n            [% IF site_checks.size %]\n                <table class=\"table table-striped\">\n                    <tr>\n                        <th>Check</th>\n                        <th>Frequency</th>\n                        <th>Last done</th>\n                    </tr>\n\n                    [% FOR check IN site_checks %]\n                        <tr>\n                            <td><a href=\"/check_edit/[% check.id %]\">[% check.name | html %]</a></td>\n                            <td>[% check.period_qty %] [% check.period_unit %][% IF check.period_qty > 1 %]s[% END %]</td>\n                            [% IF site.id %]\n                                <td>[% check.last_completed.strftime(dateformat) %]</td>\n                            [% END %]\n                        </tr>\n                    [% END %]\n                </table>\n            [% END %]\n        [% END %]\n    [% END %]\n\n    [% IF site.id %]\n\n        <h3>Reactive maintenance and quotes\n            <small><a href=\"?csv=reactive\">Download</a></small>\n        </h3>\n        <table class=\"table table-striped\">\n            [% cost_planned_total = 0 %][% cost_actual_total = 0 %]\n            <tr>\n                <th>Title</th>\n                <th>Cost (planned)</th>\n                <th>Cost (actual to date)</th>\n            </tr>\n\n            [% FOR adhoc IN adhocs %]\n                <tr>\n                    <td><a href=\"/ticket/[% adhoc.id %]\">[% adhoc.name %]</a></td>\n                    <td>[% adhoc.cost_planned %]</td>\n                    <td>[% adhoc.cost_actual %]</td>\n                </tr>\n                [% IF adhoc.cost_planned %][% cost_planned_total = cost_planned_total + adhoc.cost_planned %][% END %]\n                [% IF adhoc.cost_actual %][% cost_actual_total = cost_actual_total + adhoc.cost_actual %][% END %]\n            [% END %]\n            <tr>\n                <th>Totals</th>\n                <th>[% FILTER format('%.2f') %][% cost_planned_total %][% END %]</th>\n                <th>[% FILTER format('%.2f') %][% cost_actual_total %][% END %]</th>\n            </tr>\n        </table>\n\n        <h3>Local items</h3>\n\n        [% UNLESS login.is_admin %]\n            <p>\n                <a href=\"/task/0\" class=\"btn btn-default\" role=\"button\">Create new service item</a>\n            </p>\n        [% END %]\n        [% IF tasks_local.size %]\n        <table class=\"table table-striped\">\n            <tr>\n                <th>Task</th>\n                <th>Frequency</th>\n                <th>Planned</th>\n                <th>Last done</th>\n            </tr>\n\n                [% FOR task IN tasks_local %]\n                <tr>\n                    <td><a href=\"/task/[% task.id %]\">[% task.name %]</a></td>\n                    <td>[% task.period_qty %] [% task.period_unit %][% IF task.period_qty > 1 %]s[% END %]</td>\n                    [% IF site.id %]\n                        <td>[% task.planned.strftime(dateformat) %]</td>\n                        <td>\n                            [% IF task.tickets.first.completed %]\n                            [% task.tickets.first.completed.strftime(dateformat) %]\n                            [% ELSE %]\n                            (never)\n                            [% END %]\n                        </td>\n                    [% END %]\n                </tr>\n                [% END %]\n        </table>\n        [% ELSE %]\n            <p>No local items created</p>\n        [% END %]\n    [% END %]\n[% END %]\n\n<!-- Modal -->\n<div class=\"modal fade\" id=\"modalnewtasktype\" tabindex=\"-1\" role=\"dialog\" aria-labelledby=\"myModalLabel\" aria-hidden=\"true\">\n    <div class=\"modal-dialog\">\n        <form role=\"form\" method=\"post\">\n        <input type=\"hidden\" name=\"csrf_token\" value=\"[% csrf_token %]\">\n        <div class=\"modal-content\">\n            <div class=\"modal-header\">\n                <button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-hidden=\"true\">&times;</button>\n                <h4 class=\"modal-title\" id=\"myModalLabel\">Add task type</h4>\n            </div>\n            <div class=\"modal-body\">\n                <p>Please enter the name of a new task type:</p>\n                <div class=\"form-group\">\n                    <input type=\"text\" class=\"form-control\" id=\"tasktype_name\" name=\"tasktype_name\" placeholder=\"New task type\">\n                </div>\n            </div>\n            <div class=\"modal-footer\">\n                <button type=\"submit\" value=\"submit\" class=\"btn btn-primary\" name=\"tasktype_add\">Add</button>\n            </div>\n        </div><!-- /.modal-content -->\n        </form>\n    </div><!-- /.modal-dialog -->\n</div><!-- /.modal -->\n\n<!-- Modal -->\n<div class=\"modal fade\" id=\"modal_download\" tabindex=\"-1\" role=\"dialog\" aria-labelledby=\"myModalLabel\" aria-hidden=\"true\">\n    <div class=\"modal-dialog\">\n        <div class=\"modal-content\">\n            <form role=\"form\" method=\"post\">\n            <input type=\"hidden\" name=\"csrf_token\" value=\"[% csrf_token %]\">\n            <div class=\"modal-header\">\n                <button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-hidden=\"true\">&times;</button>\n                <h4 class=\"modal-title\" id=\"myModalLabel\">Download site checks</h4>\n            </div>\n            <div class=\"modal-body\">\n                <div class=\"form-group\">\n                    <label for=\"download_from\" class=\"control-label\">From</label>\n                    <input type=\"text\" name=\"download_from\" id=\"download_from\" value=\"[% download.default_from.ymd %]\"\n                        class=\"form-control datepicker\">\n                </div>\n                <div class=\"form-group\">\n                    <label for=\"download_to\" class=\"control-label\">To</label>\n                    <input type=\"text\" name=\"download_to\" id=\"download_to\" value=\"[% download.default_to.ymd %]\"\n                        class=\"form-control datepicker\">\n                </div>\n            </div>\n            <div class=\"modal-footer\">\n                <button type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\">Cancel</button>\n                <button type=\"submit\" name=\"download_site_checks\" value=\"download\" class=\"btn btn-primary\">Download</button>\n            </div>\n            </form>\n        </div><!-- /.modal-content -->\n    </div><!-- /.modal-dialog -->\n</div><!-- /.modal -->\n\n<!-- Modal -->\n<div class=\"modal fade\" id=\"modal_populate\" tabindex=\"-1\" role=\"dialog\" aria-labelledby=\"modal_populate_label\" aria-hidden=\"true\">\n    <div class=\"modal-dialog\">\n        <div class=\"modal-content\">\n            <form role=\"form\" method=\"post\">\n            <input type=\"hidden\" name=\"csrf_token\" value=\"[% csrf_token %]\">\n            <div class=\"modal-header\">\n                <button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-hidden=\"true\">&times;</button>\n                <h4 class=\"modal-title\" id=\"modal_populate_label\">Populate tickets from previous year</h4>\n            </div>\n            <div class=\"modal-body\">\n                <div class=\"form-group\">\n                    <label for=\"populate_from\" class=\"control-label\">From</label>\n                    <select class=\"form-control\" name=\"populate_from\">\n                        [% FOR fy IN site.fys %]\n                            <option value=\"[% fy.year %]\">Copy tickets from [% fy.name %]</option>\n                        [% END %]\n                    </select>\n                </div>\n            </div>\n            <div class=\"modal-footer\">\n                <button type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\">Cancel</button>\n                <button type=\"submit\" name=\"populate\" value=\"download\" class=\"btn btn-primary\">Populate</button>\n            </div>\n            </form>\n        </div><!-- /.modal-content -->\n    </div><!-- /.modal-dialog -->\n</div><!-- /.modal -->\n\n<!-- Modal -->\n<div class=\"modal fade\" id=\"modal_add_task\" tabindex=\"-1\" role=\"dialog\" aria-labelledby=\"myModalLabel\" aria-hidden=\"true\">\n    <div class=\"modal-dialog\">\n\t<div class=\"modal-content\">\n\t    <form role=\"form\" method=\"post\">\n            <input type=\"hidden\" name=\"csrf_token\" value=\"[% csrf_token %]\">\n\t    <div class=\"modal-header\">\n\t\t<button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-hidden=\"true\">&times;</button>\n\t\t<h4 class=\"modal-title\" id=\"myModalLabel\">Add service item to this site</h4>\n\t    </div>\n\t    <div class=\"modal-body\">\n                <div class=\"form-group\">\n                    <label for=\"taskadd\" class=\"control-label\">Service item to add</label>\n                    <select class=\"form-control\" id=\"taskadd\" name=\"taskadd\">\n                        [% FOREACH t IN all_tasks %]\n                            <option value=\"[% t.id %]\">[% t.name | html %]</option>\n                        [% END %]\n                    </select>\n                </div>\n\t    </div>\n\t    <div class=\"modal-footer\">\n\t\t<button type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\">Cancel</button>\n\t\t<button type=\"submit\" name=\"add_task\" value=\"submit\" class=\"btn btn-primary\">Add</button>\n\t    </div>\n\t    </form>\n\t</div><!-- /.modal-content -->\n    </div><!-- /.modal-dialog -->\n</div><!-- /.modal -->\n\n<!-- Modal -->\n<div class=\"modal fade\" id=\"modal_rm_task\" tabindex=\"-1\" role=\"dialog\" aria-labelledby=\"myModalLabel\" aria-hidden=\"true\">\n    <div class=\"modal-dialog\">\n\t<div class=\"modal-content\">\n\t    <form role=\"form\" method=\"post\">\n            <input type=\"hidden\" name=\"csrf_token\" value=\"[% csrf_token %]\">\n\t    <div class=\"modal-header\">\n\t\t<button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-hidden=\"true\">&times;</button>\n\t\t<h4 class=\"modal-title\" id=\"myModalLabel\">Add service item to this site</h4>\n\t    </div>\n\t    <div class=\"modal-body\">\n                <input type=\"hidden\" name=\"taskrm\" id=\"taskrm\" value=\"\">\n                <p>Are you sure you want to remove this task from the site?</p>\n\t    </div>\n\t    <div class=\"modal-footer\">\n\t\t<button type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\">Cancel</button>\n\t\t<button type=\"submit\" name=\"rm_task\" value=\"submit\" class=\"btn btn-primary\">Remove</button>\n\t    </div>\n\t    </form>\n\t</div><!-- /.modal-content -->\n    </div><!-- /.modal-dialog -->\n</div><!-- /.modal -->\n"], "filenames": ["views/task.tt"], "buggy_code_start_loc": [220], "buggy_code_end_loc": [239], "fixing_code_start_loc": [220], "fixing_code_end_loc": [239], "type": "CWE-707", "message": "A vulnerability was found in ctrlo lenio. It has been declared as problematic. This vulnerability affects unknown code of the file views/task.tt of the component Task Handler. The manipulation of the argument site.org.name/check.name/task.tasktype.name/task.name leads to cross site scripting. The attack can be initiated remotely. The name of the patch is 698c5fa465169d6f23c6a41ca4b1fc9a7869013a. It is recommended to apply a patch to fix this issue. VDB-216214 is the identifier assigned to this vulnerability.", "other": {"cve": {"id": "CVE-2021-4257", "sourceIdentifier": "cna@vuldb.com", "published": "2022-12-18T22:15:10.623", "lastModified": "2022-12-22T19:37:45.573", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "A vulnerability was found in ctrlo lenio. It has been declared as problematic. This vulnerability affects unknown code of the file views/task.tt of the component Task Handler. The manipulation of the argument site.org.name/check.name/task.tasktype.name/task.name leads to cross site scripting. The attack can be initiated remotely. The name of the patch is 698c5fa465169d6f23c6a41ca4b1fc9a7869013a. It is recommended to apply a patch to fix this issue. VDB-216214 is the identifier assigned to this vulnerability."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}, {"source": "cna@vuldb.com", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:U/C:N/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "UNCHANGED", "confidentialityImpact": "NONE", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 3.5, "baseSeverity": "LOW"}, "exploitabilityScore": 2.1, "impactScore": 1.4}]}, "weaknesses": [{"source": "cna@vuldb.com", "type": "Primary", "description": [{"lang": "en", "value": "CWE-707"}, {"lang": "en", "value": "CWE-74"}, {"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:ctrlo:lenio:*:*:*:*:*:*:*:*", "versionEndExcluding": "2021-02-08", "matchCriteriaId": "059A0EE5-ACE2-4EBB-8121-057C780461A6"}]}]}], "references": [{"url": "https://github.com/ctrlo/lenio/commit/698c5fa465169d6f23c6a41ca4b1fc9a7869013a", "source": "cna@vuldb.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://vuldb.com/?id.216214", "source": "cna@vuldb.com", "tags": ["Permissions Required", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/ctrlo/lenio/commit/698c5fa465169d6f23c6a41ca4b1fc9a7869013a"}}