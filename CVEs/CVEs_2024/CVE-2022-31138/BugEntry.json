{"buggy_code": ["<?php\r\nfunction init_db_schema() {\r\n  try {\r\n    global $pdo;\r\n\r\n    $db_version = \"20052022_0938\";\r\n\r\n    $stmt = $pdo->query(\"SHOW TABLES LIKE 'versions'\");\r\n    $num_results = count($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n    if ($num_results != 0) {\r\n      $stmt = $pdo->query(\"SELECT `version` FROM `versions` WHERE `application` = 'db_schema'\");\r\n      if ($stmt->fetch(PDO::FETCH_ASSOC)['version'] == $db_version) {\r\n        return true;\r\n      }\r\n      if (!preg_match('/y|yes/i', getenv('MASTER'))) {\r\n        $_SESSION['return'][] = array(\r\n          'type' => 'warning',\r\n          'log' => array(__FUNCTION__),\r\n          'msg' => 'Database not initialized: not running db_init on slave.'\r\n        );\r\n        return true;\r\n      }\r\n    }\r\n\r\n    $views = array(\r\n      \"grouped_mail_aliases\" => \"CREATE VIEW grouped_mail_aliases (username, aliases) AS\r\n        SELECT goto, IFNULL(GROUP_CONCAT(address ORDER BY address SEPARATOR ' '), '') AS address FROM alias\r\n        WHERE address!=goto\r\n        AND active = '1'\r\n        AND sogo_visible = '1'\r\n        AND address NOT LIKE '@%'\r\n        GROUP BY goto;\",\r\n      // START\r\n      // Unused at the moment - we cannot allow to show a foreign mailbox as sender address in SOGo, as SOGo does not like this\r\n      // We need to create delegation in SOGo AND set a sender_acl in mailcow to allow to send as user X\r\n      \"grouped_sender_acl\" => \"CREATE VIEW grouped_sender_acl (username, send_as_acl) AS\r\n        SELECT logged_in_as, IFNULL(GROUP_CONCAT(send_as SEPARATOR ' '), '') AS send_as_acl FROM sender_acl\r\n        WHERE send_as NOT LIKE '@%'\r\n        GROUP BY logged_in_as;\",\r\n      // END \r\n      \"grouped_sender_acl_external\" => \"CREATE VIEW grouped_sender_acl_external (username, send_as_acl) AS\r\n        SELECT logged_in_as, IFNULL(GROUP_CONCAT(send_as SEPARATOR ' '), '') AS send_as_acl FROM sender_acl\r\n        WHERE send_as NOT LIKE '@%' AND external = '1'\r\n        GROUP BY logged_in_as;\",\r\n      \"grouped_domain_alias_address\" => \"CREATE VIEW grouped_domain_alias_address (username, ad_alias) AS\r\n        SELECT username, IFNULL(GROUP_CONCAT(local_part, '@', alias_domain SEPARATOR ' '), '') AS ad_alias FROM mailbox\r\n        LEFT OUTER JOIN alias_domain ON target_domain=domain\r\n        GROUP BY username;\",\r\n      \"sieve_before\" => \"CREATE VIEW sieve_before (id, username, script_name, script_data) AS\r\n        SELECT md5(script_data), username, script_name, script_data FROM sieve_filters\r\n        WHERE filter_type = 'prefilter';\",\r\n      \"sieve_after\" => \"CREATE VIEW sieve_after (id, username, script_name, script_data) AS\r\n        SELECT md5(script_data), username, script_name, script_data FROM sieve_filters\r\n        WHERE filter_type = 'postfilter';\"\r\n    );\r\n\r\n    $tables = array(\r\n      \"versions\" => array(\r\n        \"cols\" => array(\r\n          \"application\" => \"VARCHAR(255) NOT NULL\",\r\n          \"version\" => \"VARCHAR(100) NOT NULL\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"application\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"admin\" => array(\r\n        \"cols\" => array(\r\n          \"username\" => \"VARCHAR(255) NOT NULL\",\r\n          \"password\" => \"VARCHAR(255) NOT NULL\",\r\n          \"superadmin\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"modified\" => \"DATETIME ON UPDATE NOW(0)\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '1'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"username\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"fido2\" => array(\r\n        \"cols\" => array(\r\n          \"username\" => \"VARCHAR(255) NOT NULL\",\r\n          \"friendlyName\" => \"VARCHAR(255)\",\r\n          \"rpId\" => \"VARCHAR(255) NOT NULL\",\r\n          \"credentialPublicKey\" => \"TEXT NOT NULL\",\r\n          \"certificateChain\" => \"TEXT\",\r\n          // Can be null for format \"none\"\r\n          \"certificate\" => \"TEXT\",\r\n          \"certificateIssuer\" => \"VARCHAR(255)\",\r\n          \"certificateSubject\" => \"VARCHAR(255)\",\r\n          \"signatureCounter\" => \"INT\",\r\n          \"AAGUID\" => \"BLOB\",\r\n          \"credentialId\" => \"BLOB NOT NULL\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"modified\" => \"DATETIME ON UPDATE NOW(0)\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '1'\"\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"_sogo_static_view\" => array(\r\n        \"cols\" => array(\r\n          \"c_uid\" => \"VARCHAR(255) NOT NULL\",\r\n          \"domain\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_name\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_password\" => \"VARCHAR(255) NOT NULL DEFAULT ''\",\r\n          \"c_cn\" => \"VARCHAR(255)\",\r\n          \"mail\" => \"VARCHAR(255) NOT NULL\",\r\n          // TODO -> use TEXT and check if SOGo login breaks on empty aliases\r\n          \"aliases\" => \"TEXT NOT NULL\",\r\n          \"ad_aliases\" => \"VARCHAR(6144) NOT NULL DEFAULT ''\",\r\n          \"ext_acl\" => \"VARCHAR(6144) NOT NULL DEFAULT ''\",\r\n          \"kind\" => \"VARCHAR(100) NOT NULL DEFAULT ''\",\r\n          \"multiple_bookings\" => \"INT NOT NULL DEFAULT -1\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"c_uid\")\r\n          ),\r\n          \"key\" => array(\r\n            \"domain\" => array(\"domain\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"relayhosts\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"hostname\" => \"VARCHAR(255) NOT NULL\",\r\n          \"username\" => \"VARCHAR(255) NOT NULL\",\r\n          \"password\" => \"VARCHAR(255) NOT NULL\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '1'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          ),\r\n          \"key\" => array(\r\n            \"hostname\" => array(\"hostname\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"transports\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"destination\" => \"VARCHAR(255) NOT NULL\",\r\n          \"nexthop\" => \"VARCHAR(255) NOT NULL\",\r\n          \"username\" => \"VARCHAR(255) NOT NULL DEFAULT ''\",\r\n          \"password\" => \"VARCHAR(255) NOT NULL DEFAULT ''\",\r\n          \"is_mx_based\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '1'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          ),\r\n          \"key\" => array(\r\n            \"destination\" => array(\"destination\"),\r\n            \"nexthop\" => array(\"nexthop\"),\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"alias\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"address\" => \"VARCHAR(255) NOT NULL\",\r\n          \"goto\" => \"TEXT NOT NULL\",\r\n          \"domain\" => \"VARCHAR(255) NOT NULL\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"modified\" => \"DATETIME ON UPDATE CURRENT_TIMESTAMP\",\r\n          \"private_comment\" => \"TEXT\",\r\n          \"public_comment\" => \"TEXT\",\r\n          \"sogo_visible\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '1'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          ),\r\n          \"unique\" => array(\r\n            \"address\" => array(\"address\")\r\n          ),\r\n          \"key\" => array(\r\n            \"domain\" => array(\"domain\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"api\" => array(\r\n        \"cols\" => array(\r\n          \"api_key\" => \"VARCHAR(255) NOT NULL\",\r\n          \"allow_from\" => \"VARCHAR(512) NOT NULL\",\r\n          \"skip_ip_check\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"modified\" => \"DATETIME ON UPDATE NOW(0)\",\r\n          \"access\" => \"ENUM('ro', 'rw') NOT NULL DEFAULT 'rw'\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '1'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"api_key\")\r\n          ),\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"sender_acl\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"logged_in_as\" => \"VARCHAR(255) NOT NULL\",\r\n          \"send_as\" => \"VARCHAR(255) NOT NULL\",\r\n          \"external\" => \"TINYINT(1) NOT NULL DEFAULT '0'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"domain\" => array(\r\n        // Todo: Move some attributes to json\r\n        \"cols\" => array(\r\n          \"domain\" => \"VARCHAR(255) NOT NULL\",\r\n          \"description\" => \"VARCHAR(255)\",\r\n          \"aliases\" => \"INT(10) NOT NULL DEFAULT '0'\",\r\n          \"mailboxes\" => \"INT(10) NOT NULL DEFAULT '0'\",\r\n          \"defquota\" => \"BIGINT(20) NOT NULL DEFAULT '3072'\",\r\n          \"maxquota\" => \"BIGINT(20) NOT NULL DEFAULT '102400'\",\r\n          \"quota\" => \"BIGINT(20) NOT NULL DEFAULT '102400'\",\r\n          \"relayhost\" => \"VARCHAR(255) NOT NULL DEFAULT '0'\",\r\n          \"backupmx\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"gal\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"relay_all_recipients\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"relay_unknown_only\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"modified\" => \"DATETIME ON UPDATE CURRENT_TIMESTAMP\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '1'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"domain\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"tags_domain\" => array(\r\n        \"cols\" => array(\r\n          \"tag_name\" => \"VARCHAR(255) NOT NULL\",\r\n          \"domain\" => \"VARCHAR(255) NOT NULL\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"fkey\" => array(\r\n            \"fk_tags_domain\" => array(\r\n              \"col\" => \"domain\",\r\n              \"ref\" => \"domain.domain\",\r\n              \"delete\" => \"CASCADE\",\r\n              \"update\" => \"NO ACTION\"\r\n            )\r\n          ),\r\n          \"unique\" => array(\r\n            \"tag_name\" => array(\"tag_name\", \"domain\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"tls_policy_override\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"dest\" => \"VARCHAR(255) NOT NULL\",\r\n          \"policy\" => \"ENUM('none', 'may', 'encrypt', 'dane', 'dane-only', 'fingerprint', 'verify', 'secure') NOT NULL\",\r\n          \"parameters\" => \"VARCHAR(255) DEFAULT ''\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"modified\" => \"DATETIME ON UPDATE CURRENT_TIMESTAMP\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '1'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          ),\r\n          \"unique\" => array(\r\n            \"dest\" => array(\"dest\")\r\n          ),\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"quarantine\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"qid\" => \"VARCHAR(30) NOT NULL\",\r\n          \"subject\" => \"VARCHAR(500)\",\r\n          \"score\" => \"FLOAT(8,2)\",\r\n          \"ip\" => \"VARCHAR(50)\",\r\n          \"action\" => \"CHAR(20) NOT NULL DEFAULT 'unknown'\",\r\n          \"symbols\" => \"JSON\",\r\n          \"fuzzy_hashes\" => \"JSON\",\r\n          \"sender\" => \"VARCHAR(255) NOT NULL DEFAULT 'unknown'\",\r\n          \"rcpt\" => \"VARCHAR(255)\",\r\n          \"msg\" => \"LONGTEXT\",\r\n          \"domain\" => \"VARCHAR(255)\",\r\n          \"notified\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"user\" => \"VARCHAR(255) NOT NULL DEFAULT 'unknown'\",\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"mailbox\" => array(\r\n        \"cols\" => array(\r\n          \"username\" => \"VARCHAR(255) NOT NULL\",\r\n          \"password\" => \"VARCHAR(255) NOT NULL\",\r\n          \"name\" => \"VARCHAR(255)\",\r\n          \"description\" => \"VARCHAR(255)\",\r\n          // mailbox_path_prefix is followed by domain/local_part/\r\n          \"mailbox_path_prefix\" => \"VARCHAR(150) DEFAULT '/var/vmail/'\",\r\n          \"quota\" => \"BIGINT(20) NOT NULL DEFAULT '102400'\",\r\n          \"local_part\" => \"VARCHAR(255) NOT NULL\",\r\n          \"domain\" => \"VARCHAR(255) NOT NULL\",\r\n          \"attributes\" => \"JSON\",\r\n          \"kind\" => \"VARCHAR(100) NOT NULL DEFAULT ''\",\r\n          \"multiple_bookings\" => \"INT NOT NULL DEFAULT -1\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"modified\" => \"DATETIME ON UPDATE CURRENT_TIMESTAMP\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '1'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"username\")\r\n          ),\r\n          \"key\" => array(\r\n            \"domain\" => array(\"domain\"),\r\n            \"kind\" => array(\"kind\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"tags_mailbox\" => array(\r\n        \"cols\" => array(\r\n          \"tag_name\" => \"VARCHAR(255) NOT NULL\",\r\n          \"username\" => \"VARCHAR(255) NOT NULL\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"fkey\" => array(\r\n            \"fk_tags_mailbox\" => array(\r\n              \"col\" => \"username\",\r\n              \"ref\" => \"mailbox.username\",\r\n              \"delete\" => \"CASCADE\",\r\n              \"update\" => \"NO ACTION\"\r\n            )\r\n          ),\r\n          \"unique\" => array(\r\n            \"tag_name\" => array(\"tag_name\", \"username\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"sieve_filters\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"username\" => \"VARCHAR(255) NOT NULL\",\r\n          \"script_desc\" => \"VARCHAR(255) NOT NULL\",\r\n          \"script_name\" => \"ENUM('active','inactive')\",\r\n          \"script_data\" => \"TEXT NOT NULL\",\r\n          \"filter_type\" => \"ENUM('postfilter','prefilter')\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"modified\" => \"DATETIME ON UPDATE CURRENT_TIMESTAMP\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          ),\r\n          \"key\" => array(\r\n            \"username\" => array(\"username\"),\r\n            \"script_desc\" => array(\"script_desc\")\r\n          ),\r\n          \"fkey\" => array(\r\n            \"fk_username_sieve_global_before\" => array(\r\n              \"col\" => \"username\",\r\n              \"ref\" => \"mailbox.username\",\r\n              \"delete\" => \"CASCADE\",\r\n              \"update\" => \"NO ACTION\"\r\n            )\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"app_passwd\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"name\" => \"VARCHAR(255) NOT NULL\",\r\n          \"mailbox\" => \"VARCHAR(255) NOT NULL\",\r\n          \"domain\" => \"VARCHAR(255) NOT NULL\",\r\n          \"password\" => \"VARCHAR(255) NOT NULL\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"modified\" => \"DATETIME ON UPDATE CURRENT_TIMESTAMP\",\r\n          \"imap_access\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"smtp_access\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"dav_access\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"eas_access\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"pop3_access\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"sieve_access\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '1'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          ),\r\n          \"key\" => array(\r\n            \"mailbox\" => array(\"mailbox\"),\r\n            \"password\" => array(\"password\"),\r\n            \"domain\" => array(\"domain\"),\r\n          ),\r\n          \"fkey\" => array(\r\n            \"fk_username_app_passwd\" => array(\r\n              \"col\" => \"mailbox\",\r\n              \"ref\" => \"mailbox.username\",\r\n              \"delete\" => \"CASCADE\",\r\n              \"update\" => \"NO ACTION\"\r\n            )\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"user_acl\" => array(\r\n        \"cols\" => array(\r\n          \"username\" => \"VARCHAR(255) NOT NULL\",\r\n          \"spam_alias\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"tls_policy\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"spam_score\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"spam_policy\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"delimiter_action\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"syncjobs\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"eas_reset\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"sogo_profile_reset\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"pushover\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          // quarantine is for quarantine actions, todo: rename\r\n          \"quarantine\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"quarantine_attachments\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"quarantine_notification\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"quarantine_category\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"app_passwds\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"username\")\r\n          ),\r\n          \"fkey\" => array(\r\n            \"fk_username\" => array(\r\n              \"col\" => \"username\",\r\n              \"ref\" => \"mailbox.username\",\r\n              \"delete\" => \"CASCADE\",\r\n              \"update\" => \"NO ACTION\"\r\n            )\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"alias_domain\" => array(\r\n        \"cols\" => array(\r\n          \"alias_domain\" => \"VARCHAR(255) NOT NULL\",\r\n          \"target_domain\" => \"VARCHAR(255) NOT NULL\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"modified\" => \"DATETIME ON UPDATE CURRENT_TIMESTAMP\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '1'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"alias_domain\")\r\n          ),\r\n          \"key\" => array(\r\n            \"active\" => array(\"active\"),\r\n            \"target_domain\" => array(\"target_domain\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"spamalias\" => array(\r\n        \"cols\" => array(\r\n          \"address\" => \"VARCHAR(255) NOT NULL\",\r\n          \"goto\" => \"TEXT NOT NULL\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"modified\" => \"DATETIME ON UPDATE CURRENT_TIMESTAMP\",\r\n          \"validity\" => \"INT(11)\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"address\")\r\n          ),\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"filterconf\" => array(\r\n        \"cols\" => array(\r\n          \"object\" => \"VARCHAR(255) NOT NULL DEFAULT ''\",\r\n          \"option\" => \"VARCHAR(50) NOT NULL DEFAULT ''\",\r\n          \"value\" => \"VARCHAR(100) NOT NULL DEFAULT ''\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"modified\" => \"DATETIME ON UPDATE CURRENT_TIMESTAMP\",\r\n          \"prefid\" => \"INT(11) NOT NULL AUTO_INCREMENT\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"prefid\")\r\n          ),\r\n          \"key\" => array(\r\n            \"object\" => array(\"object\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"settingsmap\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"desc\" => \"VARCHAR(255) NOT NULL\",\r\n          \"content\" => \"LONGTEXT NOT NULL\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"modified\" => \"DATETIME ON UPDATE CURRENT_TIMESTAMP\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '0'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"logs\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"task\" => \"CHAR(32) NOT NULL DEFAULT '000000'\",\r\n          \"type\" => \"VARCHAR(32) DEFAULT ''\",\r\n          \"msg\" => \"TEXT\",\r\n          \"call\" => \"TEXT\",\r\n          \"user\" => \"VARCHAR(64) NOT NULL\",\r\n          \"role\" => \"VARCHAR(32) NOT NULL\",\r\n          \"remote\" => \"VARCHAR(39) NOT NULL\",\r\n          \"time\" => \"INT(11) NOT NULL\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"sasl_log\" => array(\r\n        \"cols\" => array(\r\n          \"service\" => \"VARCHAR(32) NOT NULL DEFAULT ''\",\r\n          \"app_password\" => \"INT\",\r\n          \"username\" => \"VARCHAR(255) NOT NULL\",\r\n          \"real_rip\" => \"VARCHAR(64) NOT NULL\",\r\n          \"datetime\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"service\", \"real_rip\", \"username\")\r\n          ),\r\n          \"key\" => array(\r\n            \"username\" => array(\"username\"),\r\n            \"service\" => array(\"service\"),\r\n            \"datetime\" => array(\"datetime\"),\r\n            \"real_rip\" => array(\"real_rip\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"quota2\" => array(\r\n        \"cols\" => array(\r\n          \"username\" => \"VARCHAR(255) NOT NULL\",\r\n          \"bytes\" => \"BIGINT(20) NOT NULL DEFAULT '0'\",\r\n          \"messages\" => \"BIGINT(20) NOT NULL DEFAULT '0'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"username\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"quota2replica\" => array(\r\n        \"cols\" => array(\r\n          \"username\" => \"VARCHAR(255) NOT NULL\",\r\n          \"bytes\" => \"BIGINT(20) NOT NULL DEFAULT '0'\",\r\n          \"messages\" => \"BIGINT(20) NOT NULL DEFAULT '0'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"username\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"domain_admins\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"username\" => \"VARCHAR(255) NOT NULL\",\r\n          \"domain\" => \"VARCHAR(255) NOT NULL\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '1'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          ),\r\n          \"key\" => array(\r\n            \"username\" => array(\"username\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"da_acl\" => array(\r\n        \"cols\" => array(\r\n          \"username\" => \"VARCHAR(255) NOT NULL\",\r\n          \"syncjobs\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"quarantine\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"login_as\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"sogo_access\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"app_passwds\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"bcc_maps\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"pushover\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"filters\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"ratelimit\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"spam_policy\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"extend_sender_acl\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"unlimited_quota\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"protocol_access\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"smtp_ip_access\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"alias_domains\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"mailbox_relayhost\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"domain_relayhost\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"domain_desc\" => \"TINYINT(1) NOT NULL DEFAULT '0'\"\r\n          ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"username\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"imapsync\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"user2\" => \"VARCHAR(255) NOT NULL\",\r\n          \"host1\" => \"VARCHAR(255) NOT NULL\",\r\n          \"authmech1\" => \"ENUM('PLAIN','LOGIN','CRAM-MD5') DEFAULT 'PLAIN'\",\r\n          \"regextrans2\" => \"VARCHAR(255) DEFAULT ''\",\r\n          \"authmd51\" => \"TINYINT(1) NOT NULL DEFAULT 0\",\r\n          \"domain2\" => \"VARCHAR(255) NOT NULL DEFAULT ''\",\r\n          \"subfolder2\" => \"VARCHAR(255) NOT NULL DEFAULT ''\",\r\n          \"user1\" => \"VARCHAR(255) NOT NULL\",\r\n          \"password1\" => \"VARCHAR(255) NOT NULL\",\r\n          \"exclude\" => \"VARCHAR(500) NOT NULL DEFAULT ''\",\r\n          \"maxage\" => \"SMALLINT NOT NULL DEFAULT '0'\",\r\n          \"mins_interval\" => \"SMALLINT UNSIGNED NOT NULL DEFAULT '0'\",\r\n          \"maxbytespersecond\" => \"VARCHAR(50) NOT NULL DEFAULT '0'\",\r\n          \"port1\" => \"SMALLINT UNSIGNED NOT NULL\",\r\n          \"enc1\" => \"ENUM('TLS','SSL','PLAIN') DEFAULT 'TLS'\",\r\n          \"delete2duplicates\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"delete1\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"delete2\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"automap\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"skipcrossduplicates\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"custom_params\" => \"VARCHAR(512) NOT NULL DEFAULT ''\",\r\n          \"timeout1\" => \"SMALLINT NOT NULL DEFAULT '600'\",\r\n          \"timeout2\" => \"SMALLINT NOT NULL DEFAULT '600'\",\r\n          \"subscribeall\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"is_running\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"returned_text\" => \"LONGTEXT\",\r\n          \"last_run\" => \"TIMESTAMP NULL DEFAULT NULL\",\r\n          \"success\" => \"TINYINT(1) UNSIGNED DEFAULT NULL\",\r\n          \"exit_status\" => \"VARCHAR(50) DEFAULT NULL\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"modified\" => \"DATETIME ON UPDATE CURRENT_TIMESTAMP\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '0'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"bcc_maps\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"local_dest\" => \"VARCHAR(255) NOT NULL\",\r\n          \"bcc_dest\" => \"VARCHAR(255) NOT NULL\",\r\n          \"domain\" => \"VARCHAR(255) NOT NULL\",\r\n          \"type\" => \"ENUM('sender','rcpt')\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"modified\" => \"DATETIME ON UPDATE CURRENT_TIMESTAMP\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '0'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          ),\r\n          \"key\" => array(\r\n            \"local_dest\" => array(\"local_dest\"),\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"recipient_maps\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"old_dest\" => \"VARCHAR(255) NOT NULL\",\r\n          \"new_dest\" => \"VARCHAR(255) NOT NULL\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"modified\" => \"DATETIME ON UPDATE CURRENT_TIMESTAMP\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '0'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          ),\r\n          \"key\" => array(\r\n            \"local_dest\" => array(\"old_dest\"),\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"tfa\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"key_id\" => \"VARCHAR(255) NOT NULL\",\r\n          \"username\" => \"VARCHAR(255) NOT NULL\",\r\n          \"authmech\" => \"ENUM('yubi_otp', 'u2f', 'hotp', 'totp', 'webauthn')\",\r\n          \"secret\" => \"VARCHAR(255) DEFAULT NULL\",\r\n          \"keyHandle\" => \"VARCHAR(255) DEFAULT NULL\",\r\n          \"publicKey\" => \"VARCHAR(255) DEFAULT NULL\",\r\n          \"counter\" => \"INT NOT NULL DEFAULT '0'\",\r\n          \"certificate\" => \"TEXT\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '0'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"forwarding_hosts\" => array(\r\n        \"cols\" => array(\r\n          \"host\" => \"VARCHAR(255) NOT NULL\",\r\n          \"source\" => \"VARCHAR(255) NOT NULL\",\r\n          \"filter_spam\" => \"TINYINT(1) NOT NULL DEFAULT '0'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"host\")\r\n          ),\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"sogo_acl\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"c_folder_id\" => \"INT NOT NULL\",\r\n          \"c_object\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_uid\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_role\" => \"VARCHAR(80) NOT NULL\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          ),\r\n          \"key\" => array(\r\n            \"sogo_acl_c_folder_id_idx\" => array(\"c_folder_id\"),\r\n            \"sogo_acl_c_uid_idx\" => array(\"c_uid\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"sogo_alarms_folder\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"c_path\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_name\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_uid\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_recurrence_id\" => \"INT(11) DEFAULT NULL\",\r\n          \"c_alarm_number\" => \"INT(11) NOT NULL\",\r\n          \"c_alarm_date\" => \"INT(11) NOT NULL\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"sogo_cache_folder\" => array(\r\n        \"cols\" => array(\r\n          \"c_uid\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_path\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_parent_path\" => \"VARCHAR(255) DEFAULT NULL\",\r\n          \"c_type\" => \"TINYINT(3) unsigned NOT NULL\",\r\n          \"c_creationdate\" => \"INT(11) NOT NULL\",\r\n          \"c_lastmodified\" => \"INT(11) NOT NULL\",\r\n          \"c_version\" => \"INT(11) NOT NULL DEFAULT '0'\",\r\n          \"c_deleted\" => \"TINYINT(4) NOT NULL DEFAULT '0'\",\r\n          \"c_content\" => \"LONGTEXT\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"c_uid\", \"c_path\")\r\n          ),\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"sogo_folder_info\" => array(\r\n        \"cols\" => array(\r\n          \"c_folder_id\" => \"BIGINT(20) unsigned NOT NULL AUTO_INCREMENT\",\r\n          \"c_path\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_path1\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_path2\" => \"VARCHAR(255) DEFAULT NULL\",\r\n          \"c_path3\" => \"VARCHAR(255) DEFAULT NULL\",\r\n          \"c_path4\" => \"VARCHAR(255) DEFAULT NULL\",\r\n          \"c_foldername\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_location\" => \"VARCHAR(2048) DEFAULT NULL\",\r\n          \"c_quick_location\" => \"VARCHAR(2048) DEFAULT NULL\",\r\n          \"c_acl_location\" => \"VARCHAR(2048) DEFAULT NULL\",\r\n          \"c_folder_type\" => \"VARCHAR(255) NOT NULL\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"c_path\")\r\n          ),\r\n          \"unique\" => array(\r\n            \"c_folder_id\" => array(\"c_folder_id\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"sogo_quick_appointment\" => array(\r\n        \"cols\" => array(\r\n          \"c_folder_id\" => \"INT NOT NULL\",\r\n          \"c_name\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_uid\" => \"VARCHAR(1000) NOT NULL\",\r\n          \"c_startdate\" => \"INT\",\r\n          \"c_enddate\" => \"INT\",\r\n          \"c_cycleenddate\" => \"INT\",\r\n          \"c_title\" => \"VARCHAR(1000) NOT NULL\",\r\n          \"c_participants\" => \"TEXT\",\r\n          \"c_isallday\" => \"INT\",\r\n          \"c_iscycle\" => \"INT\",\r\n          \"c_cycleinfo\" => \"TEXT\",\r\n          \"c_classification\" => \"INT NOT NULL\",\r\n          \"c_isopaque\" => \"INT NOT NULL\",\r\n          \"c_status\" => \"INT NOT NULL\",\r\n          \"c_priority\" => \"INT\",\r\n          \"c_location\" => \"VARCHAR(255)\",\r\n          \"c_orgmail\" => \"VARCHAR(255)\",\r\n          \"c_partmails\" => \"TEXT\",\r\n          \"c_partstates\" => \"TEXT\",\r\n          \"c_category\" => \"VARCHAR(255)\",\r\n          \"c_sequence\" => \"INT\",\r\n          \"c_component\" => \"VARCHAR(10) NOT NULL\",\r\n          \"c_nextalarm\" => \"INT\",\r\n          \"c_description\" => \"TEXT\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"c_folder_id\", \"c_name\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"sogo_quick_contact\" => array(\r\n        \"cols\" => array(\r\n          \"c_folder_id\" => \"INT NOT NULL\",\r\n          \"c_name\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_givenname\" => \"VARCHAR(255)\",\r\n          \"c_cn\" => \"VARCHAR(255)\",\r\n          \"c_sn\" => \"VARCHAR(255)\",\r\n          \"c_screenname\" => \"VARCHAR(255)\",\r\n          \"c_l\" => \"VARCHAR(255)\",\r\n          \"c_mail\" => \"TEXT\",\r\n          \"c_o\" => \"VARCHAR(500)\",\r\n          \"c_ou\" => \"VARCHAR(255)\",\r\n          \"c_telephonenumber\" => \"VARCHAR(255)\",\r\n          \"c_categories\" => \"VARCHAR(255)\",\r\n          \"c_component\" => \"VARCHAR(10) NOT NULL\",\r\n          \"c_hascertificate\" => \"INT4 DEFAULT 0\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"c_folder_id\", \"c_name\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"sogo_sessions_folder\" => array(\r\n        \"cols\" => array(\r\n          \"c_id\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_value\" => \"VARCHAR(4096) NOT NULL\",\r\n          \"c_creationdate\" => \"INT(11) NOT NULL\",\r\n          \"c_lastseen\" => \"INT(11) NOT NULL\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"c_id\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"sogo_store\" => array(\r\n        \"cols\" => array(\r\n          \"c_folder_id\" => \"INT NOT NULL\",\r\n          \"c_name\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_content\" => \"MEDIUMTEXT NOT NULL\",\r\n          \"c_creationdate\" => \"INT NOT NULL\",\r\n          \"c_lastmodified\" => \"INT NOT NULL\",\r\n          \"c_version\" => \"INT NOT NULL\",\r\n          \"c_deleted\" => \"INT\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"c_folder_id\", \"c_name\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"pushover\" => array(\r\n        \"cols\" => array(\r\n          \"username\" => \"VARCHAR(255) NOT NULL\",\r\n          \"key\" => \"VARCHAR(255) NOT NULL\",\r\n          \"token\" => \"VARCHAR(255) NOT NULL\",\r\n          \"attributes\" => \"JSON\",\r\n          \"title\" => \"TEXT\",\r\n          \"text\" => \"TEXT\",\r\n          \"senders\" => \"TEXT\",\r\n          \"senders_regex\" => \"TEXT\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '1'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"username\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"sogo_user_profile\" => array(\r\n        \"cols\" => array(\r\n          \"c_uid\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_defaults\" => \"LONGTEXT\",\r\n          \"c_settings\" => \"LONGTEXT\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"c_uid\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"oauth_clients\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"client_id\" => \"VARCHAR(80) NOT NULL\",\r\n          \"client_secret\" => \"VARCHAR(80)\",\r\n          \"redirect_uri\" => \"VARCHAR(2000)\",\r\n          \"grant_types\" => \"VARCHAR(80)\",\r\n          \"scope\" => \"VARCHAR(4000)\",\r\n          \"user_id\" => \"VARCHAR(80)\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"client_id\")\r\n          ),\r\n          \"unique\" => array(\r\n            \"id\" => array(\"id\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"oauth_access_tokens\" => array(\r\n        \"cols\" => array(\r\n          \"access_token\" => \"VARCHAR(40) NOT NULL\",\r\n          \"client_id\" => \"VARCHAR(80) NOT NULL\",\r\n          \"user_id\" => \"VARCHAR(80)\",\r\n          \"expires\" => \"TIMESTAMP NOT NULL\",\r\n          \"scope\" => \"VARCHAR(4000)\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"access_token\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"oauth_authorization_codes\" => array(\r\n        \"cols\" => array(\r\n          \"authorization_code\" => \"VARCHAR(40) NOT NULL\",\r\n          \"client_id\" => \"VARCHAR(80) NOT NULL\",\r\n          \"user_id\" => \"VARCHAR(80)\",\r\n          \"redirect_uri\" => \"VARCHAR(2000)\",\r\n          \"expires\" => \"TIMESTAMP NOT NULL\",\r\n          \"scope\" => \"VARCHAR(4000)\",\r\n          \"id_token\" => \"VARCHAR(1000)\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"authorization_code\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"oauth_refresh_tokens\" => array(\r\n        \"cols\" => array(\r\n          \"refresh_token\" => \"VARCHAR(40) NOT NULL\",\r\n          \"client_id\" => \"VARCHAR(80) NOT NULL\",\r\n          \"user_id\" => \"VARCHAR(80)\",\r\n          \"expires\" => \"TIMESTAMP NOT NULL\",\r\n          \"scope\" => \"VARCHAR(4000)\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"refresh_token\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      )\r\n    );\r\n\r\n    foreach ($tables as $table => $properties) {\r\n      // Migrate to quarantine\r\n      if ($table == 'quarantine') {\r\n        $stmt = $pdo->query(\"SHOW TABLES LIKE 'quarantaine'\");\r\n        $num_results = count($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n        if ($num_results != 0) {\r\n          $stmt = $pdo->query(\"SHOW TABLES LIKE 'quarantine'\");\r\n          $num_results = count($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n          if ($num_results == 0) {\r\n            $pdo->query(\"RENAME TABLE `quarantaine` TO `quarantine`\");\r\n          }\r\n        }\r\n      }\r\n\r\n      // Migrate tls_enforce_* options\r\n      if ($table == 'mailbox') {\r\n        $stmt = $pdo->query(\"SHOW TABLES LIKE 'mailbox'\");\r\n        $num_results = count($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n        if ($num_results != 0) {\r\n          $stmt = $pdo->query(\"SHOW COLUMNS FROM `mailbox` LIKE '%tls_enforce%'\"); \r\n          $num_results = count($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n          if ($num_results != 0) {\r\n            $stmt = $pdo->query(\"SELECT `username`, `tls_enforce_in`, `tls_enforce_out` FROM `mailbox`\");\r\n            $tls_options_rows = $stmt->fetchAll(PDO::FETCH_ASSOC);\r\n            while ($row = array_shift($tls_options_rows)) {\r\n              $tls_options[$row['username']] = array('tls_enforce_in' => $row['tls_enforce_in'], 'tls_enforce_out' => $row['tls_enforce_out']);\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      $stmt = $pdo->query(\"SHOW TABLES LIKE '\" . $table . \"'\"); \r\n      $num_results = count($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n      if ($num_results != 0) {\r\n        $stmt = $pdo->prepare(\"SELECT CONCAT('ALTER TABLE ', `table_schema`, '.', `table_name`, ' DROP FOREIGN KEY ', `constraint_name`, ';') AS `FKEY_DROP` FROM `information_schema`.`table_constraints`\r\n          WHERE `constraint_type` = 'FOREIGN KEY' AND `table_name` = :table;\");\r\n        $stmt->execute(array(':table' => $table));\r\n        $rows = $stmt->fetchAll(PDO::FETCH_ASSOC);\r\n        while ($row = array_shift($rows)) {\r\n          $pdo->query($row['FKEY_DROP']);\r\n        }\r\n        foreach($properties['cols'] as $column => $type) {\r\n          $stmt = $pdo->query(\"SHOW COLUMNS FROM `\" . $table . \"` LIKE '\" . $column . \"'\"); \r\n          $num_results = count($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n          if ($num_results == 0) {\r\n            if (strpos($type, 'AUTO_INCREMENT') !== false) {\r\n              $type = $type . ' PRIMARY KEY ';\r\n              // Adding an AUTO_INCREMENT key, need to drop primary keys first, if exists\r\n              $stmt = $pdo->query(\"SHOW KEYS FROM `\" . $table . \"` WHERE Key_name = 'PRIMARY'\");\r\n              $num_results = count($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n              if ($num_results != 0) {\r\n                $pdo->query(\"ALTER TABLE `\" . $table . \"` DROP PRIMARY KEY\");\r\n              }\r\n            }\r\n            $pdo->query(\"ALTER TABLE `\" . $table . \"` ADD `\" . $column . \"` \" . $type);\r\n          }\r\n          else {\r\n            $pdo->query(\"ALTER TABLE `\" . $table . \"` MODIFY COLUMN `\" . $column . \"` \" . $type);\r\n          }\r\n        }\r\n        foreach($properties['keys'] as $key_type => $key_content) {\r\n          if (strtolower($key_type) == 'primary') {\r\n            foreach ($key_content as $key_values) {\r\n              $fields = \"`\" . implode(\"`, `\", $key_values) . \"`\";\r\n              $stmt = $pdo->query(\"SHOW KEYS FROM `\" . $table . \"` WHERE Key_name = 'PRIMARY'\"); \r\n              $num_results = count($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n              $is_drop = ($num_results != 0) ? \"DROP PRIMARY KEY, \" : \"\";\r\n              $pdo->query(\"ALTER TABLE `\" . $table . \"` \" . $is_drop . \"ADD PRIMARY KEY (\" . $fields . \")\");\r\n            }\r\n          }\r\n          if (strtolower($key_type) == 'key') {\r\n            foreach ($key_content as $key_name => $key_values) {\r\n              $fields = \"`\" . implode(\"`, `\", $key_values) . \"`\";\r\n              $stmt = $pdo->query(\"SHOW KEYS FROM `\" . $table . \"` WHERE Key_name = '\" . $key_name . \"'\"); \r\n              $num_results = count($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n              $is_drop = ($num_results != 0) ? \"DROP INDEX `\" . $key_name . \"`, \" : \"\";\r\n              $pdo->query(\"ALTER TABLE `\" . $table . \"` \" . $is_drop . \"ADD KEY `\" . $key_name . \"` (\" . $fields . \")\");\r\n            }\r\n          }\r\n          if (strtolower($key_type) == 'unique') {\r\n            foreach ($key_content as $key_name => $key_values) {\r\n              $fields = \"`\" . implode(\"`, `\", $key_values) . \"`\";\r\n              $stmt = $pdo->query(\"SHOW KEYS FROM `\" . $table . \"` WHERE Key_name = '\" . $key_name . \"'\");\r\n              $num_results = count($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n              $is_drop = ($num_results != 0) ? \"DROP INDEX `\" . $key_name . \"`, \" : \"\";\r\n              $pdo->query(\"ALTER TABLE `\" . $table . \"` \" . $is_drop . \"ADD UNIQUE KEY `\" . $key_name . \"` (\" . $fields . \")\");\r\n            }\r\n          }\r\n          if (strtolower($key_type) == 'fkey') {\r\n            foreach ($key_content as $key_name => $key_values) {\r\n              $fields = \"`\" . implode(\"`, `\", $key_values) . \"`\";\r\n              $stmt = $pdo->query(\"SHOW KEYS FROM `\" . $table . \"` WHERE Key_name = '\" . $key_name . \"'\");\r\n              $num_results = count($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n              if ($num_results != 0) {\r\n                $pdo->query(\"ALTER TABLE `\" . $table . \"` DROP INDEX `\" . $key_name . \"`\");\r\n              }\r\n              @list($table_ref, $field_ref) = explode('.', $key_values['ref']);\r\n              $pdo->query(\"ALTER TABLE `\" . $table . \"` ADD FOREIGN KEY `\" . $key_name . \"` (\" . $key_values['col'] . \") REFERENCES `\" . $table_ref . \"` (`\" . $field_ref . \"`)\r\n                ON DELETE \" . $key_values['delete'] . \" ON UPDATE \" . $key_values['update']);\r\n            }\r\n          }\r\n        }\r\n        // Drop all vanished columns\r\n        $stmt = $pdo->query(\"SHOW COLUMNS FROM `\" . $table . \"`\"); \r\n        $cols_in_table = $stmt->fetchAll(PDO::FETCH_ASSOC); \r\n        while ($row = array_shift($cols_in_table)) {\r\n          if (!array_key_exists($row['Field'], $properties['cols'])) {\r\n            $pdo->query(\"ALTER TABLE `\" . $table . \"` DROP COLUMN `\" . $row['Field'] . \"`;\");\r\n          }\r\n        }\r\n\r\n        // Step 1: Get all non-primary keys, that currently exist and those that should exist\r\n        $stmt = $pdo->query(\"SHOW KEYS FROM `\" . $table . \"` WHERE `Key_name` != 'PRIMARY'\"); \r\n        $keys_in_table = $stmt->fetchAll(PDO::FETCH_ASSOC); \r\n        $keys_to_exist = array();\r\n        if (isset($properties['keys']['unique']) && is_array($properties['keys']['unique'])) {\r\n          foreach ($properties['keys']['unique'] as $key_name => $key_values) {\r\n             $keys_to_exist[] = $key_name;\r\n          }\r\n        }\r\n        if (isset($properties['keys']['key']) && is_array($properties['keys']['key'])) {\r\n          foreach ($properties['keys']['key'] as $key_name => $key_values) {\r\n             $keys_to_exist[] = $key_name;\r\n          }\r\n        }\r\n        // Index for foreign key must exist\r\n        if (isset($properties['keys']['fkey']) && is_array($properties['keys']['fkey'])) {\r\n          foreach ($properties['keys']['fkey'] as $key_name => $key_values) {\r\n             $keys_to_exist[] = $key_name;\r\n          }\r\n        }\r\n        // Step 2: Drop all vanished indexes\r\n        while ($row = array_shift($keys_in_table)) {\r\n          if (!in_array($row['Key_name'], $keys_to_exist)) {\r\n            $pdo->query(\"ALTER TABLE `\" . $table . \"` DROP INDEX `\" . $row['Key_name'] . \"`\");\r\n          }\r\n        }\r\n        // Step 3: Drop all vanished primary keys\r\n        if (!isset($properties['keys']['primary'])) {\r\n          $stmt = $pdo->query(\"SHOW KEYS FROM `\" . $table . \"` WHERE Key_name = 'PRIMARY'\"); \r\n          $num_results = count($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n          if ($num_results != 0) {\r\n            $pdo->query(\"ALTER TABLE `\" . $table . \"` DROP PRIMARY KEY\");\r\n          }\r\n        }\r\n      }\r\n      else {\r\n        // Create table if it is missing\r\n        $sql = \"CREATE TABLE IF NOT EXISTS `\" . $table . \"` (\";\r\n        foreach($properties['cols'] as $column => $type) {\r\n          $sql .= \"`\" . $column . \"` \" . $type . \",\";\r\n        }\r\n        foreach($properties['keys'] as $key_type => $key_content) {\r\n          if (strtolower($key_type) == 'primary') {\r\n            foreach ($key_content as $key_values) {\r\n              $fields = \"`\" . implode(\"`, `\", $key_values) . \"`\";\r\n              $sql .= \"PRIMARY KEY (\" . $fields . \")\" . \",\";\r\n            }\r\n          }\r\n          elseif (strtolower($key_type) == 'key') {\r\n            foreach ($key_content as $key_name => $key_values) {\r\n              $fields = \"`\" . implode(\"`, `\", $key_values) . \"`\";\r\n              $sql .= \"KEY `\" . $key_name . \"` (\" . $fields . \")\" . \",\";\r\n            }\r\n          }\r\n          elseif (strtolower($key_type) == 'unique') {\r\n            foreach ($key_content as $key_name => $key_values) {\r\n              $fields = \"`\" . implode(\"`, `\", $key_values) . \"`\";\r\n              $sql .= \"UNIQUE KEY `\" . $key_name . \"` (\" . $fields . \")\" . \",\";\r\n            }\r\n          }\r\n          elseif (strtolower($key_type) == 'fkey') {\r\n            foreach ($key_content as $key_name => $key_values) {\r\n              @list($table_ref, $field_ref) = explode('.', $key_values['ref']);\r\n              $sql .= \"FOREIGN KEY `\" . $key_name . \"` (\" . $key_values['col'] . \") REFERENCES `\" . $table_ref . \"` (`\" . $field_ref . \"`)\r\n                ON DELETE \" . $key_values['delete'] . \" ON UPDATE \" . $key_values['update'] . \",\";\r\n            }\r\n          }\r\n        }\r\n        $sql = rtrim($sql, \",\");\r\n        $sql .= \") \" . $properties['attr'];\r\n        $pdo->query($sql);\r\n      }\r\n      // Reset table attributes\r\n      $pdo->query(\"ALTER TABLE `\" . $table . \"` \" . $properties['attr'] . \";\");\r\n\r\n    }\r\n\r\n    // Recreate SQL views\r\n    foreach ($views as $view => $create) {\r\n      $pdo->query(\"DROP VIEW IF EXISTS `\" . $view . \"`;\");\r\n      $pdo->query($create);\r\n    }\r\n    \r\n    // Mitigate imapsync pipemess issue\r\n    $pdo->query(\"UPDATE `imapsync` SET `custom_params` = '' WHERE `custom_params` LIKE '%pipemess%' OR `custom_params` LIKE '%pipemes%';\");\r\n    \r\n    // Migrate webauthn tfa\r\n    $stmt = $pdo->query(\"ALTER TABLE `tfa` MODIFY COLUMN `authmech` ENUM('yubi_otp', 'u2f', 'hotp', 'totp', 'webauthn')\");\r\n\r\n    // Inject admin if not exists\r\n    $stmt = $pdo->query(\"SELECT NULL FROM `admin`\"); \r\n    $num_results = count($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n    if ($num_results == 0) {\r\n    $pdo->query(\"INSERT INTO `admin` (`username`, `password`, `superadmin`, `created`, `modified`, `active`)\r\n      VALUES ('admin', '{SSHA256}K8eVJ6YsZbQCfuJvSUbaQRLr0HPLz5rC9IAp0PAFl0tmNDBkMDc0NDAyOTAxN2Rk', 1, NOW(), NOW(), 1)\");\r\n    $pdo->query(\"INSERT INTO `domain_admins` (`username`, `domain`, `created`, `active`)\r\n        SELECT `username`, 'ALL', NOW(), 1 FROM `admin`\r\n          WHERE superadmin='1' AND `username` NOT IN (SELECT `username` FROM `domain_admins`);\");\r\n    $pdo->query(\"DELETE FROM `admin` WHERE `username` NOT IN  (SELECT `username` FROM `domain_admins`);\");\r\n    }\r\n    // Insert new DB schema version\r\n    $pdo->query(\"REPLACE INTO `versions` (`application`, `version`) VALUES ('db_schema', '\" . $db_version . \"');\");\r\n\r\n    // Fix dangling domain admins\r\n    $pdo->query(\"DELETE FROM `admin` WHERE `superadmin` = 0 AND `username` NOT IN (SELECT `username`FROM `domain_admins`);\");\r\n    $pdo->query(\"DELETE FROM `da_acl` WHERE `username` NOT IN (SELECT `username`FROM `domain_admins`);\");\r\n\r\n    // Migrate attributes\r\n    // pushover\r\n    $pdo->query(\"UPDATE `pushover` SET `attributes` = '{}' WHERE `attributes` = '' OR `attributes` IS NULL;\");\r\n    $pdo->query(\"UPDATE `pushover` SET `attributes` =  JSON_SET(`attributes`, '$.evaluate_x_prio', \\\"0\\\") WHERE JSON_VALUE(`attributes`, '$.evaluate_x_prio') IS NULL;\");\r\n    $pdo->query(\"UPDATE `pushover` SET `attributes` =  JSON_SET(`attributes`, '$.only_x_prio', \\\"0\\\") WHERE JSON_VALUE(`attributes`, '$.only_x_prio') IS NULL;\");\r\n    // mailbox\r\n    $pdo->query(\"UPDATE `mailbox` SET `attributes` = '{}' WHERE `attributes` = '' OR `attributes` IS NULL;\");\r\n    $pdo->query(\"UPDATE `mailbox` SET `attributes` =  JSON_SET(`attributes`, '$.passwd_update', \\\"0\\\") WHERE JSON_VALUE(`attributes`, '$.passwd_update') IS NULL;\");\r\n    $pdo->query(\"UPDATE `mailbox` SET `attributes` =  JSON_SET(`attributes`, '$.relayhost', \\\"0\\\") WHERE JSON_VALUE(`attributes`, '$.relayhost') IS NULL;\");\r\n    $pdo->query(\"UPDATE `mailbox` SET `attributes` =  JSON_SET(`attributes`, '$.force_pw_update', \\\"0\\\") WHERE JSON_VALUE(`attributes`, '$.force_pw_update') IS NULL;\");\r\n    $pdo->query(\"UPDATE `mailbox` SET `attributes` =  JSON_SET(`attributes`, '$.sieve_access', \\\"1\\\") WHERE JSON_VALUE(`attributes`, '$.sieve_access') IS NULL;\");\r\n    $pdo->query(\"UPDATE `mailbox` SET `attributes` =  JSON_SET(`attributes`, '$.sogo_access', \\\"1\\\") WHERE JSON_VALUE(`attributes`, '$.sogo_access') IS NULL;\");\r\n    $pdo->query(\"UPDATE `mailbox` SET `attributes` =  JSON_SET(`attributes`, '$.imap_access', \\\"1\\\") WHERE JSON_VALUE(`attributes`, '$.imap_access') IS NULL;\");\r\n    $pdo->query(\"UPDATE `mailbox` SET `attributes` =  JSON_SET(`attributes`, '$.pop3_access', \\\"1\\\") WHERE JSON_VALUE(`attributes`, '$.pop3_access') IS NULL;\");\r\n    $pdo->query(\"UPDATE `mailbox` SET `attributes` =  JSON_SET(`attributes`, '$.smtp_access', \\\"1\\\") WHERE JSON_VALUE(`attributes`, '$.smtp_access') IS NULL;\");\r\n    $pdo->query(\"UPDATE `mailbox` SET `attributes` =  JSON_SET(`attributes`, '$.mailbox_format', \\\"maildir:\\\") WHERE JSON_VALUE(`attributes`, '$.mailbox_format') IS NULL;\");\r\n    $pdo->query(\"UPDATE `mailbox` SET `attributes` =  JSON_SET(`attributes`, '$.quarantine_notification', \\\"never\\\") WHERE JSON_VALUE(`attributes`, '$.quarantine_notification') IS NULL;\");\r\n    $pdo->query(\"UPDATE `mailbox` SET `attributes` =  JSON_SET(`attributes`, '$.quarantine_category', \\\"reject\\\") WHERE JSON_VALUE(`attributes`, '$.quarantine_category') IS NULL;\");\r\n    foreach($tls_options as $tls_user => $tls_options) {\r\n      $stmt = $pdo->prepare(\"UPDATE `mailbox` SET `attributes` = JSON_SET(`attributes`, '$.tls_enforce_in', :tls_enforce_in),\r\n        `attributes` = JSON_SET(`attributes`, '$.tls_enforce_out', :tls_enforce_out)\r\n          WHERE `username` = :username\");\r\n      $stmt->execute(array(':tls_enforce_in' => $tls_options['tls_enforce_in'], ':tls_enforce_out' => $tls_options['tls_enforce_out'], ':username' => $tls_user));\r\n    }\r\n    // Set tls_enforce_* if still missing (due to deleted attrs for example)\r\n    $pdo->query(\"UPDATE `mailbox` SET `attributes` =  JSON_SET(`attributes`, '$.tls_enforce_out', \\\"1\\\") WHERE JSON_VALUE(`attributes`, '$.tls_enforce_out') IS NULL;\");\r\n    $pdo->query(\"UPDATE `mailbox` SET `attributes` =  JSON_SET(`attributes`, '$.tls_enforce_in', \\\"1\\\") WHERE JSON_VALUE(`attributes`, '$.tls_enforce_in') IS NULL;\");\r\n    // Fix ACL\r\n    $pdo->query(\"INSERT INTO `user_acl` (`username`) SELECT `username` FROM `mailbox` WHERE `kind` = '' AND NOT EXISTS (SELECT `username` FROM `user_acl`);\");\r\n    $pdo->query(\"INSERT INTO `da_acl` (`username`) SELECT DISTINCT `username` FROM `domain_admins` WHERE `username` != 'admin' AND NOT EXISTS (SELECT `username` FROM `da_acl`);\");\r\n    // Fix domain_admins\r\n    $pdo->query(\"DELETE FROM `domain_admins` WHERE `domain` = 'ALL';\");\r\n\r\n    if (php_sapi_name() == \"cli\") {\r\n      echo \"DB initialization completed\" . PHP_EOL;\r\n    } else {\r\n      $_SESSION['return'][] = array(\r\n        'type' => 'success',\r\n        'log' => array(__FUNCTION__),\r\n        'msg' => 'db_init_complete'\r\n      );\r\n    }\r\n  }\r\n  catch (PDOException $e) {\r\n    if (php_sapi_name() == \"cli\") {\r\n      echo \"DB initialization failed: \" . print_r($e, true) . PHP_EOL;\r\n    } else {\r\n      $_SESSION['return'][] = array(\r\n        'type' => 'danger',\r\n        'log' => array(__FUNCTION__),\r\n        'msg' => array('mysql_error', $e)\r\n      );\r\n    }\r\n  }\r\n}\r\nif (php_sapi_name() == \"cli\") {\r\n  include '/web/inc/vars.inc.php';\r\n  include '/web/inc/functions.docker.inc.php';\r\n  // $now = new DateTime();\r\n  // $mins = $now->getOffset() / 60;\r\n  // $sgn = ($mins < 0 ? -1 : 1);\r\n  // $mins = abs($mins);\r\n  // $hrs = floor($mins / 60);\r\n  // $mins -= $hrs * 60;\r\n  // $offset = sprintf('%+d:%02d', $hrs*$sgn, $mins);\r\n  $dsn = $database_type . \":unix_socket=\" . $database_sock . \";dbname=\" . $database_name;\r\n  $opt = [\r\n    PDO::ATTR_ERRMODE            => PDO::ERRMODE_EXCEPTION,\r\n    PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,\r\n    PDO::ATTR_EMULATE_PREPARES   => false,\r\n    //PDO::MYSQL_ATTR_INIT_COMMAND => \"SET time_zone = '\" . $offset . \"', group_concat_max_len = 3423543543;\",\r\n  ];\r\n  $pdo = new PDO($dsn, $database_user, $database_pass, $opt);\r\n  $stmt = $pdo->query(\"SELECT COUNT('OK') AS OK_C FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'sogo_view' OR TABLE_NAME = '_sogo_static_view';\");\r\n  $res = $stmt->fetch(PDO::FETCH_ASSOC);\r\n  if (intval($res['OK_C']) === 2) {\r\n    // Be more precise when replacing into _sogo_static_view, col orders may change\r\n    try {\r\n      $stmt = $pdo->query(\"REPLACE INTO _sogo_static_view (`c_uid`, `domain`, `c_name`, `c_password`, `c_cn`, `mail`, `aliases`, `ad_aliases`, `ext_acl`, `kind`, `multiple_bookings`)\r\n        SELECT `c_uid`, `domain`, `c_name`, `c_password`, `c_cn`, `mail`, `aliases`, `ad_aliases`, `ext_acl`, `kind`, `multiple_bookings` from sogo_view\");\r\n      $stmt = $pdo->query(\"DELETE FROM _sogo_static_view WHERE `c_uid` NOT IN (SELECT `username` FROM `mailbox` WHERE `active` = '1');\");\r\n      echo \"Fixed _sogo_static_view\" . PHP_EOL;\r\n    }\r\n    catch ( Exception $e ) {\r\n      // Dunno\r\n    }\r\n  }\r\n  try {\r\n    $m = new Memcached();\r\n    $m->addServer('memcached', 11211);\r\n    $m->flush();\r\n    echo \"Cleaned up memcached\". PHP_EOL;\r\n  }\r\n  catch ( Exception $e ) {\r\n    // Dunno\r\n  }\r\n  init_db_schema();\r\n}\r\n"], "fixing_code": ["<?php\r\nfunction init_db_schema() {\r\n  try {\r\n    global $pdo;\r\n\r\n    $db_version = \"18062022_1153\";\r\n\r\n    $stmt = $pdo->query(\"SHOW TABLES LIKE 'versions'\");\r\n    $num_results = count($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n    if ($num_results != 0) {\r\n      $stmt = $pdo->query(\"SELECT `version` FROM `versions` WHERE `application` = 'db_schema'\");\r\n      if ($stmt->fetch(PDO::FETCH_ASSOC)['version'] == $db_version) {\r\n        return true;\r\n      }\r\n      if (!preg_match('/y|yes/i', getenv('MASTER'))) {\r\n        $_SESSION['return'][] = array(\r\n          'type' => 'warning',\r\n          'log' => array(__FUNCTION__),\r\n          'msg' => 'Database not initialized: not running db_init on slave.'\r\n        );\r\n        return true;\r\n      }\r\n    }\r\n\r\n    $views = array(\r\n      \"grouped_mail_aliases\" => \"CREATE VIEW grouped_mail_aliases (username, aliases) AS\r\n        SELECT goto, IFNULL(GROUP_CONCAT(address ORDER BY address SEPARATOR ' '), '') AS address FROM alias\r\n        WHERE address!=goto\r\n        AND active = '1'\r\n        AND sogo_visible = '1'\r\n        AND address NOT LIKE '@%'\r\n        GROUP BY goto;\",\r\n      // START\r\n      // Unused at the moment - we cannot allow to show a foreign mailbox as sender address in SOGo, as SOGo does not like this\r\n      // We need to create delegation in SOGo AND set a sender_acl in mailcow to allow to send as user X\r\n      \"grouped_sender_acl\" => \"CREATE VIEW grouped_sender_acl (username, send_as_acl) AS\r\n        SELECT logged_in_as, IFNULL(GROUP_CONCAT(send_as SEPARATOR ' '), '') AS send_as_acl FROM sender_acl\r\n        WHERE send_as NOT LIKE '@%'\r\n        GROUP BY logged_in_as;\",\r\n      // END \r\n      \"grouped_sender_acl_external\" => \"CREATE VIEW grouped_sender_acl_external (username, send_as_acl) AS\r\n        SELECT logged_in_as, IFNULL(GROUP_CONCAT(send_as SEPARATOR ' '), '') AS send_as_acl FROM sender_acl\r\n        WHERE send_as NOT LIKE '@%' AND external = '1'\r\n        GROUP BY logged_in_as;\",\r\n      \"grouped_domain_alias_address\" => \"CREATE VIEW grouped_domain_alias_address (username, ad_alias) AS\r\n        SELECT username, IFNULL(GROUP_CONCAT(local_part, '@', alias_domain SEPARATOR ' '), '') AS ad_alias FROM mailbox\r\n        LEFT OUTER JOIN alias_domain ON target_domain=domain\r\n        GROUP BY username;\",\r\n      \"sieve_before\" => \"CREATE VIEW sieve_before (id, username, script_name, script_data) AS\r\n        SELECT md5(script_data), username, script_name, script_data FROM sieve_filters\r\n        WHERE filter_type = 'prefilter';\",\r\n      \"sieve_after\" => \"CREATE VIEW sieve_after (id, username, script_name, script_data) AS\r\n        SELECT md5(script_data), username, script_name, script_data FROM sieve_filters\r\n        WHERE filter_type = 'postfilter';\"\r\n    );\r\n\r\n    $tables = array(\r\n      \"versions\" => array(\r\n        \"cols\" => array(\r\n          \"application\" => \"VARCHAR(255) NOT NULL\",\r\n          \"version\" => \"VARCHAR(100) NOT NULL\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"application\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"admin\" => array(\r\n        \"cols\" => array(\r\n          \"username\" => \"VARCHAR(255) NOT NULL\",\r\n          \"password\" => \"VARCHAR(255) NOT NULL\",\r\n          \"superadmin\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"modified\" => \"DATETIME ON UPDATE NOW(0)\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '1'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"username\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"fido2\" => array(\r\n        \"cols\" => array(\r\n          \"username\" => \"VARCHAR(255) NOT NULL\",\r\n          \"friendlyName\" => \"VARCHAR(255)\",\r\n          \"rpId\" => \"VARCHAR(255) NOT NULL\",\r\n          \"credentialPublicKey\" => \"TEXT NOT NULL\",\r\n          \"certificateChain\" => \"TEXT\",\r\n          // Can be null for format \"none\"\r\n          \"certificate\" => \"TEXT\",\r\n          \"certificateIssuer\" => \"VARCHAR(255)\",\r\n          \"certificateSubject\" => \"VARCHAR(255)\",\r\n          \"signatureCounter\" => \"INT\",\r\n          \"AAGUID\" => \"BLOB\",\r\n          \"credentialId\" => \"BLOB NOT NULL\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"modified\" => \"DATETIME ON UPDATE NOW(0)\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '1'\"\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"_sogo_static_view\" => array(\r\n        \"cols\" => array(\r\n          \"c_uid\" => \"VARCHAR(255) NOT NULL\",\r\n          \"domain\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_name\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_password\" => \"VARCHAR(255) NOT NULL DEFAULT ''\",\r\n          \"c_cn\" => \"VARCHAR(255)\",\r\n          \"mail\" => \"VARCHAR(255) NOT NULL\",\r\n          // TODO -> use TEXT and check if SOGo login breaks on empty aliases\r\n          \"aliases\" => \"TEXT NOT NULL\",\r\n          \"ad_aliases\" => \"VARCHAR(6144) NOT NULL DEFAULT ''\",\r\n          \"ext_acl\" => \"VARCHAR(6144) NOT NULL DEFAULT ''\",\r\n          \"kind\" => \"VARCHAR(100) NOT NULL DEFAULT ''\",\r\n          \"multiple_bookings\" => \"INT NOT NULL DEFAULT -1\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"c_uid\")\r\n          ),\r\n          \"key\" => array(\r\n            \"domain\" => array(\"domain\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"relayhosts\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"hostname\" => \"VARCHAR(255) NOT NULL\",\r\n          \"username\" => \"VARCHAR(255) NOT NULL\",\r\n          \"password\" => \"VARCHAR(255) NOT NULL\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '1'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          ),\r\n          \"key\" => array(\r\n            \"hostname\" => array(\"hostname\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"transports\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"destination\" => \"VARCHAR(255) NOT NULL\",\r\n          \"nexthop\" => \"VARCHAR(255) NOT NULL\",\r\n          \"username\" => \"VARCHAR(255) NOT NULL DEFAULT ''\",\r\n          \"password\" => \"VARCHAR(255) NOT NULL DEFAULT ''\",\r\n          \"is_mx_based\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '1'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          ),\r\n          \"key\" => array(\r\n            \"destination\" => array(\"destination\"),\r\n            \"nexthop\" => array(\"nexthop\"),\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"alias\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"address\" => \"VARCHAR(255) NOT NULL\",\r\n          \"goto\" => \"TEXT NOT NULL\",\r\n          \"domain\" => \"VARCHAR(255) NOT NULL\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"modified\" => \"DATETIME ON UPDATE CURRENT_TIMESTAMP\",\r\n          \"private_comment\" => \"TEXT\",\r\n          \"public_comment\" => \"TEXT\",\r\n          \"sogo_visible\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '1'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          ),\r\n          \"unique\" => array(\r\n            \"address\" => array(\"address\")\r\n          ),\r\n          \"key\" => array(\r\n            \"domain\" => array(\"domain\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"api\" => array(\r\n        \"cols\" => array(\r\n          \"api_key\" => \"VARCHAR(255) NOT NULL\",\r\n          \"allow_from\" => \"VARCHAR(512) NOT NULL\",\r\n          \"skip_ip_check\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"modified\" => \"DATETIME ON UPDATE NOW(0)\",\r\n          \"access\" => \"ENUM('ro', 'rw') NOT NULL DEFAULT 'rw'\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '1'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"api_key\")\r\n          ),\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"sender_acl\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"logged_in_as\" => \"VARCHAR(255) NOT NULL\",\r\n          \"send_as\" => \"VARCHAR(255) NOT NULL\",\r\n          \"external\" => \"TINYINT(1) NOT NULL DEFAULT '0'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"domain\" => array(\r\n        // Todo: Move some attributes to json\r\n        \"cols\" => array(\r\n          \"domain\" => \"VARCHAR(255) NOT NULL\",\r\n          \"description\" => \"VARCHAR(255)\",\r\n          \"aliases\" => \"INT(10) NOT NULL DEFAULT '0'\",\r\n          \"mailboxes\" => \"INT(10) NOT NULL DEFAULT '0'\",\r\n          \"defquota\" => \"BIGINT(20) NOT NULL DEFAULT '3072'\",\r\n          \"maxquota\" => \"BIGINT(20) NOT NULL DEFAULT '102400'\",\r\n          \"quota\" => \"BIGINT(20) NOT NULL DEFAULT '102400'\",\r\n          \"relayhost\" => \"VARCHAR(255) NOT NULL DEFAULT '0'\",\r\n          \"backupmx\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"gal\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"relay_all_recipients\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"relay_unknown_only\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"modified\" => \"DATETIME ON UPDATE CURRENT_TIMESTAMP\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '1'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"domain\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"tags_domain\" => array(\r\n        \"cols\" => array(\r\n          \"tag_name\" => \"VARCHAR(255) NOT NULL\",\r\n          \"domain\" => \"VARCHAR(255) NOT NULL\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"fkey\" => array(\r\n            \"fk_tags_domain\" => array(\r\n              \"col\" => \"domain\",\r\n              \"ref\" => \"domain.domain\",\r\n              \"delete\" => \"CASCADE\",\r\n              \"update\" => \"NO ACTION\"\r\n            )\r\n          ),\r\n          \"unique\" => array(\r\n            \"tag_name\" => array(\"tag_name\", \"domain\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"tls_policy_override\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"dest\" => \"VARCHAR(255) NOT NULL\",\r\n          \"policy\" => \"ENUM('none', 'may', 'encrypt', 'dane', 'dane-only', 'fingerprint', 'verify', 'secure') NOT NULL\",\r\n          \"parameters\" => \"VARCHAR(255) DEFAULT ''\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"modified\" => \"DATETIME ON UPDATE CURRENT_TIMESTAMP\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '1'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          ),\r\n          \"unique\" => array(\r\n            \"dest\" => array(\"dest\")\r\n          ),\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"quarantine\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"qid\" => \"VARCHAR(30) NOT NULL\",\r\n          \"subject\" => \"VARCHAR(500)\",\r\n          \"score\" => \"FLOAT(8,2)\",\r\n          \"ip\" => \"VARCHAR(50)\",\r\n          \"action\" => \"CHAR(20) NOT NULL DEFAULT 'unknown'\",\r\n          \"symbols\" => \"JSON\",\r\n          \"fuzzy_hashes\" => \"JSON\",\r\n          \"sender\" => \"VARCHAR(255) NOT NULL DEFAULT 'unknown'\",\r\n          \"rcpt\" => \"VARCHAR(255)\",\r\n          \"msg\" => \"LONGTEXT\",\r\n          \"domain\" => \"VARCHAR(255)\",\r\n          \"notified\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"user\" => \"VARCHAR(255) NOT NULL DEFAULT 'unknown'\",\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"mailbox\" => array(\r\n        \"cols\" => array(\r\n          \"username\" => \"VARCHAR(255) NOT NULL\",\r\n          \"password\" => \"VARCHAR(255) NOT NULL\",\r\n          \"name\" => \"VARCHAR(255)\",\r\n          \"description\" => \"VARCHAR(255)\",\r\n          // mailbox_path_prefix is followed by domain/local_part/\r\n          \"mailbox_path_prefix\" => \"VARCHAR(150) DEFAULT '/var/vmail/'\",\r\n          \"quota\" => \"BIGINT(20) NOT NULL DEFAULT '102400'\",\r\n          \"local_part\" => \"VARCHAR(255) NOT NULL\",\r\n          \"domain\" => \"VARCHAR(255) NOT NULL\",\r\n          \"attributes\" => \"JSON\",\r\n          \"kind\" => \"VARCHAR(100) NOT NULL DEFAULT ''\",\r\n          \"multiple_bookings\" => \"INT NOT NULL DEFAULT -1\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"modified\" => \"DATETIME ON UPDATE CURRENT_TIMESTAMP\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '1'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"username\")\r\n          ),\r\n          \"key\" => array(\r\n            \"domain\" => array(\"domain\"),\r\n            \"kind\" => array(\"kind\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"tags_mailbox\" => array(\r\n        \"cols\" => array(\r\n          \"tag_name\" => \"VARCHAR(255) NOT NULL\",\r\n          \"username\" => \"VARCHAR(255) NOT NULL\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"fkey\" => array(\r\n            \"fk_tags_mailbox\" => array(\r\n              \"col\" => \"username\",\r\n              \"ref\" => \"mailbox.username\",\r\n              \"delete\" => \"CASCADE\",\r\n              \"update\" => \"NO ACTION\"\r\n            )\r\n          ),\r\n          \"unique\" => array(\r\n            \"tag_name\" => array(\"tag_name\", \"username\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"sieve_filters\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"username\" => \"VARCHAR(255) NOT NULL\",\r\n          \"script_desc\" => \"VARCHAR(255) NOT NULL\",\r\n          \"script_name\" => \"ENUM('active','inactive')\",\r\n          \"script_data\" => \"TEXT NOT NULL\",\r\n          \"filter_type\" => \"ENUM('postfilter','prefilter')\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"modified\" => \"DATETIME ON UPDATE CURRENT_TIMESTAMP\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          ),\r\n          \"key\" => array(\r\n            \"username\" => array(\"username\"),\r\n            \"script_desc\" => array(\"script_desc\")\r\n          ),\r\n          \"fkey\" => array(\r\n            \"fk_username_sieve_global_before\" => array(\r\n              \"col\" => \"username\",\r\n              \"ref\" => \"mailbox.username\",\r\n              \"delete\" => \"CASCADE\",\r\n              \"update\" => \"NO ACTION\"\r\n            )\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"app_passwd\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"name\" => \"VARCHAR(255) NOT NULL\",\r\n          \"mailbox\" => \"VARCHAR(255) NOT NULL\",\r\n          \"domain\" => \"VARCHAR(255) NOT NULL\",\r\n          \"password\" => \"VARCHAR(255) NOT NULL\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"modified\" => \"DATETIME ON UPDATE CURRENT_TIMESTAMP\",\r\n          \"imap_access\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"smtp_access\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"dav_access\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"eas_access\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"pop3_access\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"sieve_access\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '1'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          ),\r\n          \"key\" => array(\r\n            \"mailbox\" => array(\"mailbox\"),\r\n            \"password\" => array(\"password\"),\r\n            \"domain\" => array(\"domain\"),\r\n          ),\r\n          \"fkey\" => array(\r\n            \"fk_username_app_passwd\" => array(\r\n              \"col\" => \"mailbox\",\r\n              \"ref\" => \"mailbox.username\",\r\n              \"delete\" => \"CASCADE\",\r\n              \"update\" => \"NO ACTION\"\r\n            )\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"user_acl\" => array(\r\n        \"cols\" => array(\r\n          \"username\" => \"VARCHAR(255) NOT NULL\",\r\n          \"spam_alias\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"tls_policy\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"spam_score\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"spam_policy\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"delimiter_action\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"syncjobs\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"eas_reset\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"sogo_profile_reset\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"pushover\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          // quarantine is for quarantine actions, todo: rename\r\n          \"quarantine\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"quarantine_attachments\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"quarantine_notification\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"quarantine_category\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"app_passwds\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"username\")\r\n          ),\r\n          \"fkey\" => array(\r\n            \"fk_username\" => array(\r\n              \"col\" => \"username\",\r\n              \"ref\" => \"mailbox.username\",\r\n              \"delete\" => \"CASCADE\",\r\n              \"update\" => \"NO ACTION\"\r\n            )\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"alias_domain\" => array(\r\n        \"cols\" => array(\r\n          \"alias_domain\" => \"VARCHAR(255) NOT NULL\",\r\n          \"target_domain\" => \"VARCHAR(255) NOT NULL\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"modified\" => \"DATETIME ON UPDATE CURRENT_TIMESTAMP\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '1'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"alias_domain\")\r\n          ),\r\n          \"key\" => array(\r\n            \"active\" => array(\"active\"),\r\n            \"target_domain\" => array(\"target_domain\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"spamalias\" => array(\r\n        \"cols\" => array(\r\n          \"address\" => \"VARCHAR(255) NOT NULL\",\r\n          \"goto\" => \"TEXT NOT NULL\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"modified\" => \"DATETIME ON UPDATE CURRENT_TIMESTAMP\",\r\n          \"validity\" => \"INT(11)\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"address\")\r\n          ),\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"filterconf\" => array(\r\n        \"cols\" => array(\r\n          \"object\" => \"VARCHAR(255) NOT NULL DEFAULT ''\",\r\n          \"option\" => \"VARCHAR(50) NOT NULL DEFAULT ''\",\r\n          \"value\" => \"VARCHAR(100) NOT NULL DEFAULT ''\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"modified\" => \"DATETIME ON UPDATE CURRENT_TIMESTAMP\",\r\n          \"prefid\" => \"INT(11) NOT NULL AUTO_INCREMENT\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"prefid\")\r\n          ),\r\n          \"key\" => array(\r\n            \"object\" => array(\"object\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"settingsmap\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"desc\" => \"VARCHAR(255) NOT NULL\",\r\n          \"content\" => \"LONGTEXT NOT NULL\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"modified\" => \"DATETIME ON UPDATE CURRENT_TIMESTAMP\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '0'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"logs\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"task\" => \"CHAR(32) NOT NULL DEFAULT '000000'\",\r\n          \"type\" => \"VARCHAR(32) DEFAULT ''\",\r\n          \"msg\" => \"TEXT\",\r\n          \"call\" => \"TEXT\",\r\n          \"user\" => \"VARCHAR(64) NOT NULL\",\r\n          \"role\" => \"VARCHAR(32) NOT NULL\",\r\n          \"remote\" => \"VARCHAR(39) NOT NULL\",\r\n          \"time\" => \"INT(11) NOT NULL\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"sasl_log\" => array(\r\n        \"cols\" => array(\r\n          \"service\" => \"VARCHAR(32) NOT NULL DEFAULT ''\",\r\n          \"app_password\" => \"INT\",\r\n          \"username\" => \"VARCHAR(255) NOT NULL\",\r\n          \"real_rip\" => \"VARCHAR(64) NOT NULL\",\r\n          \"datetime\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"service\", \"real_rip\", \"username\")\r\n          ),\r\n          \"key\" => array(\r\n            \"username\" => array(\"username\"),\r\n            \"service\" => array(\"service\"),\r\n            \"datetime\" => array(\"datetime\"),\r\n            \"real_rip\" => array(\"real_rip\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"quota2\" => array(\r\n        \"cols\" => array(\r\n          \"username\" => \"VARCHAR(255) NOT NULL\",\r\n          \"bytes\" => \"BIGINT(20) NOT NULL DEFAULT '0'\",\r\n          \"messages\" => \"BIGINT(20) NOT NULL DEFAULT '0'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"username\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"quota2replica\" => array(\r\n        \"cols\" => array(\r\n          \"username\" => \"VARCHAR(255) NOT NULL\",\r\n          \"bytes\" => \"BIGINT(20) NOT NULL DEFAULT '0'\",\r\n          \"messages\" => \"BIGINT(20) NOT NULL DEFAULT '0'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"username\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"domain_admins\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"username\" => \"VARCHAR(255) NOT NULL\",\r\n          \"domain\" => \"VARCHAR(255) NOT NULL\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '1'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          ),\r\n          \"key\" => array(\r\n            \"username\" => array(\"username\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"da_acl\" => array(\r\n        \"cols\" => array(\r\n          \"username\" => \"VARCHAR(255) NOT NULL\",\r\n          \"syncjobs\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"quarantine\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"login_as\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"sogo_access\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"app_passwds\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"bcc_maps\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"pushover\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"filters\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"ratelimit\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"spam_policy\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"extend_sender_acl\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"unlimited_quota\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"protocol_access\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"smtp_ip_access\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"alias_domains\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"mailbox_relayhost\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"domain_relayhost\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"domain_desc\" => \"TINYINT(1) NOT NULL DEFAULT '0'\"\r\n          ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"username\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"imapsync\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"user2\" => \"VARCHAR(255) NOT NULL\",\r\n          \"host1\" => \"VARCHAR(255) NOT NULL\",\r\n          \"authmech1\" => \"ENUM('PLAIN','LOGIN','CRAM-MD5') DEFAULT 'PLAIN'\",\r\n          \"regextrans2\" => \"VARCHAR(255) DEFAULT ''\",\r\n          \"authmd51\" => \"TINYINT(1) NOT NULL DEFAULT 0\",\r\n          \"domain2\" => \"VARCHAR(255) NOT NULL DEFAULT ''\",\r\n          \"subfolder2\" => \"VARCHAR(255) NOT NULL DEFAULT ''\",\r\n          \"user1\" => \"VARCHAR(255) NOT NULL\",\r\n          \"password1\" => \"VARCHAR(255) NOT NULL\",\r\n          \"exclude\" => \"VARCHAR(500) NOT NULL DEFAULT ''\",\r\n          \"maxage\" => \"SMALLINT NOT NULL DEFAULT '0'\",\r\n          \"mins_interval\" => \"SMALLINT UNSIGNED NOT NULL DEFAULT '0'\",\r\n          \"maxbytespersecond\" => \"VARCHAR(50) NOT NULL DEFAULT '0'\",\r\n          \"port1\" => \"SMALLINT UNSIGNED NOT NULL\",\r\n          \"enc1\" => \"ENUM('TLS','SSL','PLAIN') DEFAULT 'TLS'\",\r\n          \"delete2duplicates\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"delete1\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"delete2\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"automap\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"skipcrossduplicates\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"custom_params\" => \"VARCHAR(512) NOT NULL DEFAULT ''\",\r\n          \"timeout1\" => \"SMALLINT NOT NULL DEFAULT '600'\",\r\n          \"timeout2\" => \"SMALLINT NOT NULL DEFAULT '600'\",\r\n          \"subscribeall\" => \"TINYINT(1) NOT NULL DEFAULT '1'\",\r\n          \"is_running\" => \"TINYINT(1) NOT NULL DEFAULT '0'\",\r\n          \"returned_text\" => \"LONGTEXT\",\r\n          \"last_run\" => \"TIMESTAMP NULL DEFAULT NULL\",\r\n          \"success\" => \"TINYINT(1) UNSIGNED DEFAULT NULL\",\r\n          \"exit_status\" => \"VARCHAR(50) DEFAULT NULL\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"modified\" => \"DATETIME ON UPDATE CURRENT_TIMESTAMP\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '0'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"bcc_maps\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"local_dest\" => \"VARCHAR(255) NOT NULL\",\r\n          \"bcc_dest\" => \"VARCHAR(255) NOT NULL\",\r\n          \"domain\" => \"VARCHAR(255) NOT NULL\",\r\n          \"type\" => \"ENUM('sender','rcpt')\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"modified\" => \"DATETIME ON UPDATE CURRENT_TIMESTAMP\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '0'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          ),\r\n          \"key\" => array(\r\n            \"local_dest\" => array(\"local_dest\"),\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"recipient_maps\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"old_dest\" => \"VARCHAR(255) NOT NULL\",\r\n          \"new_dest\" => \"VARCHAR(255) NOT NULL\",\r\n          \"created\" => \"DATETIME(0) NOT NULL DEFAULT NOW(0)\",\r\n          \"modified\" => \"DATETIME ON UPDATE CURRENT_TIMESTAMP\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '0'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          ),\r\n          \"key\" => array(\r\n            \"local_dest\" => array(\"old_dest\"),\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"tfa\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"key_id\" => \"VARCHAR(255) NOT NULL\",\r\n          \"username\" => \"VARCHAR(255) NOT NULL\",\r\n          \"authmech\" => \"ENUM('yubi_otp', 'u2f', 'hotp', 'totp', 'webauthn')\",\r\n          \"secret\" => \"VARCHAR(255) DEFAULT NULL\",\r\n          \"keyHandle\" => \"VARCHAR(255) DEFAULT NULL\",\r\n          \"publicKey\" => \"VARCHAR(255) DEFAULT NULL\",\r\n          \"counter\" => \"INT NOT NULL DEFAULT '0'\",\r\n          \"certificate\" => \"TEXT\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '0'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"forwarding_hosts\" => array(\r\n        \"cols\" => array(\r\n          \"host\" => \"VARCHAR(255) NOT NULL\",\r\n          \"source\" => \"VARCHAR(255) NOT NULL\",\r\n          \"filter_spam\" => \"TINYINT(1) NOT NULL DEFAULT '0'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"host\")\r\n          ),\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"sogo_acl\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"c_folder_id\" => \"INT NOT NULL\",\r\n          \"c_object\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_uid\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_role\" => \"VARCHAR(80) NOT NULL\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          ),\r\n          \"key\" => array(\r\n            \"sogo_acl_c_folder_id_idx\" => array(\"c_folder_id\"),\r\n            \"sogo_acl_c_uid_idx\" => array(\"c_uid\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"sogo_alarms_folder\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"c_path\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_name\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_uid\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_recurrence_id\" => \"INT(11) DEFAULT NULL\",\r\n          \"c_alarm_number\" => \"INT(11) NOT NULL\",\r\n          \"c_alarm_date\" => \"INT(11) NOT NULL\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"id\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"sogo_cache_folder\" => array(\r\n        \"cols\" => array(\r\n          \"c_uid\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_path\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_parent_path\" => \"VARCHAR(255) DEFAULT NULL\",\r\n          \"c_type\" => \"TINYINT(3) unsigned NOT NULL\",\r\n          \"c_creationdate\" => \"INT(11) NOT NULL\",\r\n          \"c_lastmodified\" => \"INT(11) NOT NULL\",\r\n          \"c_version\" => \"INT(11) NOT NULL DEFAULT '0'\",\r\n          \"c_deleted\" => \"TINYINT(4) NOT NULL DEFAULT '0'\",\r\n          \"c_content\" => \"LONGTEXT\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"c_uid\", \"c_path\")\r\n          ),\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"sogo_folder_info\" => array(\r\n        \"cols\" => array(\r\n          \"c_folder_id\" => \"BIGINT(20) unsigned NOT NULL AUTO_INCREMENT\",\r\n          \"c_path\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_path1\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_path2\" => \"VARCHAR(255) DEFAULT NULL\",\r\n          \"c_path3\" => \"VARCHAR(255) DEFAULT NULL\",\r\n          \"c_path4\" => \"VARCHAR(255) DEFAULT NULL\",\r\n          \"c_foldername\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_location\" => \"VARCHAR(2048) DEFAULT NULL\",\r\n          \"c_quick_location\" => \"VARCHAR(2048) DEFAULT NULL\",\r\n          \"c_acl_location\" => \"VARCHAR(2048) DEFAULT NULL\",\r\n          \"c_folder_type\" => \"VARCHAR(255) NOT NULL\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"c_path\")\r\n          ),\r\n          \"unique\" => array(\r\n            \"c_folder_id\" => array(\"c_folder_id\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"sogo_quick_appointment\" => array(\r\n        \"cols\" => array(\r\n          \"c_folder_id\" => \"INT NOT NULL\",\r\n          \"c_name\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_uid\" => \"VARCHAR(1000) NOT NULL\",\r\n          \"c_startdate\" => \"INT\",\r\n          \"c_enddate\" => \"INT\",\r\n          \"c_cycleenddate\" => \"INT\",\r\n          \"c_title\" => \"VARCHAR(1000) NOT NULL\",\r\n          \"c_participants\" => \"TEXT\",\r\n          \"c_isallday\" => \"INT\",\r\n          \"c_iscycle\" => \"INT\",\r\n          \"c_cycleinfo\" => \"TEXT\",\r\n          \"c_classification\" => \"INT NOT NULL\",\r\n          \"c_isopaque\" => \"INT NOT NULL\",\r\n          \"c_status\" => \"INT NOT NULL\",\r\n          \"c_priority\" => \"INT\",\r\n          \"c_location\" => \"VARCHAR(255)\",\r\n          \"c_orgmail\" => \"VARCHAR(255)\",\r\n          \"c_partmails\" => \"TEXT\",\r\n          \"c_partstates\" => \"TEXT\",\r\n          \"c_category\" => \"VARCHAR(255)\",\r\n          \"c_sequence\" => \"INT\",\r\n          \"c_component\" => \"VARCHAR(10) NOT NULL\",\r\n          \"c_nextalarm\" => \"INT\",\r\n          \"c_description\" => \"TEXT\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"c_folder_id\", \"c_name\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"sogo_quick_contact\" => array(\r\n        \"cols\" => array(\r\n          \"c_folder_id\" => \"INT NOT NULL\",\r\n          \"c_name\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_givenname\" => \"VARCHAR(255)\",\r\n          \"c_cn\" => \"VARCHAR(255)\",\r\n          \"c_sn\" => \"VARCHAR(255)\",\r\n          \"c_screenname\" => \"VARCHAR(255)\",\r\n          \"c_l\" => \"VARCHAR(255)\",\r\n          \"c_mail\" => \"TEXT\",\r\n          \"c_o\" => \"VARCHAR(500)\",\r\n          \"c_ou\" => \"VARCHAR(255)\",\r\n          \"c_telephonenumber\" => \"VARCHAR(255)\",\r\n          \"c_categories\" => \"VARCHAR(255)\",\r\n          \"c_component\" => \"VARCHAR(10) NOT NULL\",\r\n          \"c_hascertificate\" => \"INT4 DEFAULT 0\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"c_folder_id\", \"c_name\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"sogo_sessions_folder\" => array(\r\n        \"cols\" => array(\r\n          \"c_id\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_value\" => \"VARCHAR(4096) NOT NULL\",\r\n          \"c_creationdate\" => \"INT(11) NOT NULL\",\r\n          \"c_lastseen\" => \"INT(11) NOT NULL\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"c_id\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"sogo_store\" => array(\r\n        \"cols\" => array(\r\n          \"c_folder_id\" => \"INT NOT NULL\",\r\n          \"c_name\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_content\" => \"MEDIUMTEXT NOT NULL\",\r\n          \"c_creationdate\" => \"INT NOT NULL\",\r\n          \"c_lastmodified\" => \"INT NOT NULL\",\r\n          \"c_version\" => \"INT NOT NULL\",\r\n          \"c_deleted\" => \"INT\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"c_folder_id\", \"c_name\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"pushover\" => array(\r\n        \"cols\" => array(\r\n          \"username\" => \"VARCHAR(255) NOT NULL\",\r\n          \"key\" => \"VARCHAR(255) NOT NULL\",\r\n          \"token\" => \"VARCHAR(255) NOT NULL\",\r\n          \"attributes\" => \"JSON\",\r\n          \"title\" => \"TEXT\",\r\n          \"text\" => \"TEXT\",\r\n          \"senders\" => \"TEXT\",\r\n          \"senders_regex\" => \"TEXT\",\r\n          \"active\" => \"TINYINT(1) NOT NULL DEFAULT '1'\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"username\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"sogo_user_profile\" => array(\r\n        \"cols\" => array(\r\n          \"c_uid\" => \"VARCHAR(255) NOT NULL\",\r\n          \"c_defaults\" => \"LONGTEXT\",\r\n          \"c_settings\" => \"LONGTEXT\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"c_uid\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"oauth_clients\" => array(\r\n        \"cols\" => array(\r\n          \"id\" => \"INT NOT NULL AUTO_INCREMENT\",\r\n          \"client_id\" => \"VARCHAR(80) NOT NULL\",\r\n          \"client_secret\" => \"VARCHAR(80)\",\r\n          \"redirect_uri\" => \"VARCHAR(2000)\",\r\n          \"grant_types\" => \"VARCHAR(80)\",\r\n          \"scope\" => \"VARCHAR(4000)\",\r\n          \"user_id\" => \"VARCHAR(80)\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"client_id\")\r\n          ),\r\n          \"unique\" => array(\r\n            \"id\" => array(\"id\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"oauth_access_tokens\" => array(\r\n        \"cols\" => array(\r\n          \"access_token\" => \"VARCHAR(40) NOT NULL\",\r\n          \"client_id\" => \"VARCHAR(80) NOT NULL\",\r\n          \"user_id\" => \"VARCHAR(80)\",\r\n          \"expires\" => \"TIMESTAMP NOT NULL\",\r\n          \"scope\" => \"VARCHAR(4000)\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"access_token\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"oauth_authorization_codes\" => array(\r\n        \"cols\" => array(\r\n          \"authorization_code\" => \"VARCHAR(40) NOT NULL\",\r\n          \"client_id\" => \"VARCHAR(80) NOT NULL\",\r\n          \"user_id\" => \"VARCHAR(80)\",\r\n          \"redirect_uri\" => \"VARCHAR(2000)\",\r\n          \"expires\" => \"TIMESTAMP NOT NULL\",\r\n          \"scope\" => \"VARCHAR(4000)\",\r\n          \"id_token\" => \"VARCHAR(1000)\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"authorization_code\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      ),\r\n      \"oauth_refresh_tokens\" => array(\r\n        \"cols\" => array(\r\n          \"refresh_token\" => \"VARCHAR(40) NOT NULL\",\r\n          \"client_id\" => \"VARCHAR(80) NOT NULL\",\r\n          \"user_id\" => \"VARCHAR(80)\",\r\n          \"expires\" => \"TIMESTAMP NOT NULL\",\r\n          \"scope\" => \"VARCHAR(4000)\"\r\n        ),\r\n        \"keys\" => array(\r\n          \"primary\" => array(\r\n            \"\" => array(\"refresh_token\")\r\n          )\r\n        ),\r\n        \"attr\" => \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC\"\r\n      )\r\n    );\r\n\r\n    foreach ($tables as $table => $properties) {\r\n      // Migrate to quarantine\r\n      if ($table == 'quarantine') {\r\n        $stmt = $pdo->query(\"SHOW TABLES LIKE 'quarantaine'\");\r\n        $num_results = count($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n        if ($num_results != 0) {\r\n          $stmt = $pdo->query(\"SHOW TABLES LIKE 'quarantine'\");\r\n          $num_results = count($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n          if ($num_results == 0) {\r\n            $pdo->query(\"RENAME TABLE `quarantaine` TO `quarantine`\");\r\n          }\r\n        }\r\n      }\r\n\r\n      // Migrate tls_enforce_* options\r\n      if ($table == 'mailbox') {\r\n        $stmt = $pdo->query(\"SHOW TABLES LIKE 'mailbox'\");\r\n        $num_results = count($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n        if ($num_results != 0) {\r\n          $stmt = $pdo->query(\"SHOW COLUMNS FROM `mailbox` LIKE '%tls_enforce%'\"); \r\n          $num_results = count($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n          if ($num_results != 0) {\r\n            $stmt = $pdo->query(\"SELECT `username`, `tls_enforce_in`, `tls_enforce_out` FROM `mailbox`\");\r\n            $tls_options_rows = $stmt->fetchAll(PDO::FETCH_ASSOC);\r\n            while ($row = array_shift($tls_options_rows)) {\r\n              $tls_options[$row['username']] = array('tls_enforce_in' => $row['tls_enforce_in'], 'tls_enforce_out' => $row['tls_enforce_out']);\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      $stmt = $pdo->query(\"SHOW TABLES LIKE '\" . $table . \"'\"); \r\n      $num_results = count($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n      if ($num_results != 0) {\r\n        $stmt = $pdo->prepare(\"SELECT CONCAT('ALTER TABLE ', `table_schema`, '.', `table_name`, ' DROP FOREIGN KEY ', `constraint_name`, ';') AS `FKEY_DROP` FROM `information_schema`.`table_constraints`\r\n          WHERE `constraint_type` = 'FOREIGN KEY' AND `table_name` = :table;\");\r\n        $stmt->execute(array(':table' => $table));\r\n        $rows = $stmt->fetchAll(PDO::FETCH_ASSOC);\r\n        while ($row = array_shift($rows)) {\r\n          $pdo->query($row['FKEY_DROP']);\r\n        }\r\n        foreach($properties['cols'] as $column => $type) {\r\n          $stmt = $pdo->query(\"SHOW COLUMNS FROM `\" . $table . \"` LIKE '\" . $column . \"'\"); \r\n          $num_results = count($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n          if ($num_results == 0) {\r\n            if (strpos($type, 'AUTO_INCREMENT') !== false) {\r\n              $type = $type . ' PRIMARY KEY ';\r\n              // Adding an AUTO_INCREMENT key, need to drop primary keys first, if exists\r\n              $stmt = $pdo->query(\"SHOW KEYS FROM `\" . $table . \"` WHERE Key_name = 'PRIMARY'\");\r\n              $num_results = count($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n              if ($num_results != 0) {\r\n                $pdo->query(\"ALTER TABLE `\" . $table . \"` DROP PRIMARY KEY\");\r\n              }\r\n            }\r\n            $pdo->query(\"ALTER TABLE `\" . $table . \"` ADD `\" . $column . \"` \" . $type);\r\n          }\r\n          else {\r\n            $pdo->query(\"ALTER TABLE `\" . $table . \"` MODIFY COLUMN `\" . $column . \"` \" . $type);\r\n          }\r\n        }\r\n        foreach($properties['keys'] as $key_type => $key_content) {\r\n          if (strtolower($key_type) == 'primary') {\r\n            foreach ($key_content as $key_values) {\r\n              $fields = \"`\" . implode(\"`, `\", $key_values) . \"`\";\r\n              $stmt = $pdo->query(\"SHOW KEYS FROM `\" . $table . \"` WHERE Key_name = 'PRIMARY'\"); \r\n              $num_results = count($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n              $is_drop = ($num_results != 0) ? \"DROP PRIMARY KEY, \" : \"\";\r\n              $pdo->query(\"ALTER TABLE `\" . $table . \"` \" . $is_drop . \"ADD PRIMARY KEY (\" . $fields . \")\");\r\n            }\r\n          }\r\n          if (strtolower($key_type) == 'key') {\r\n            foreach ($key_content as $key_name => $key_values) {\r\n              $fields = \"`\" . implode(\"`, `\", $key_values) . \"`\";\r\n              $stmt = $pdo->query(\"SHOW KEYS FROM `\" . $table . \"` WHERE Key_name = '\" . $key_name . \"'\"); \r\n              $num_results = count($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n              $is_drop = ($num_results != 0) ? \"DROP INDEX `\" . $key_name . \"`, \" : \"\";\r\n              $pdo->query(\"ALTER TABLE `\" . $table . \"` \" . $is_drop . \"ADD KEY `\" . $key_name . \"` (\" . $fields . \")\");\r\n            }\r\n          }\r\n          if (strtolower($key_type) == 'unique') {\r\n            foreach ($key_content as $key_name => $key_values) {\r\n              $fields = \"`\" . implode(\"`, `\", $key_values) . \"`\";\r\n              $stmt = $pdo->query(\"SHOW KEYS FROM `\" . $table . \"` WHERE Key_name = '\" . $key_name . \"'\");\r\n              $num_results = count($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n              $is_drop = ($num_results != 0) ? \"DROP INDEX `\" . $key_name . \"`, \" : \"\";\r\n              $pdo->query(\"ALTER TABLE `\" . $table . \"` \" . $is_drop . \"ADD UNIQUE KEY `\" . $key_name . \"` (\" . $fields . \")\");\r\n            }\r\n          }\r\n          if (strtolower($key_type) == 'fkey') {\r\n            foreach ($key_content as $key_name => $key_values) {\r\n              $fields = \"`\" . implode(\"`, `\", $key_values) . \"`\";\r\n              $stmt = $pdo->query(\"SHOW KEYS FROM `\" . $table . \"` WHERE Key_name = '\" . $key_name . \"'\");\r\n              $num_results = count($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n              if ($num_results != 0) {\r\n                $pdo->query(\"ALTER TABLE `\" . $table . \"` DROP INDEX `\" . $key_name . \"`\");\r\n              }\r\n              @list($table_ref, $field_ref) = explode('.', $key_values['ref']);\r\n              $pdo->query(\"ALTER TABLE `\" . $table . \"` ADD FOREIGN KEY `\" . $key_name . \"` (\" . $key_values['col'] . \") REFERENCES `\" . $table_ref . \"` (`\" . $field_ref . \"`)\r\n                ON DELETE \" . $key_values['delete'] . \" ON UPDATE \" . $key_values['update']);\r\n            }\r\n          }\r\n        }\r\n        // Drop all vanished columns\r\n        $stmt = $pdo->query(\"SHOW COLUMNS FROM `\" . $table . \"`\"); \r\n        $cols_in_table = $stmt->fetchAll(PDO::FETCH_ASSOC); \r\n        while ($row = array_shift($cols_in_table)) {\r\n          if (!array_key_exists($row['Field'], $properties['cols'])) {\r\n            $pdo->query(\"ALTER TABLE `\" . $table . \"` DROP COLUMN `\" . $row['Field'] . \"`;\");\r\n          }\r\n        }\r\n\r\n        // Step 1: Get all non-primary keys, that currently exist and those that should exist\r\n        $stmt = $pdo->query(\"SHOW KEYS FROM `\" . $table . \"` WHERE `Key_name` != 'PRIMARY'\"); \r\n        $keys_in_table = $stmt->fetchAll(PDO::FETCH_ASSOC); \r\n        $keys_to_exist = array();\r\n        if (isset($properties['keys']['unique']) && is_array($properties['keys']['unique'])) {\r\n          foreach ($properties['keys']['unique'] as $key_name => $key_values) {\r\n             $keys_to_exist[] = $key_name;\r\n          }\r\n        }\r\n        if (isset($properties['keys']['key']) && is_array($properties['keys']['key'])) {\r\n          foreach ($properties['keys']['key'] as $key_name => $key_values) {\r\n             $keys_to_exist[] = $key_name;\r\n          }\r\n        }\r\n        // Index for foreign key must exist\r\n        if (isset($properties['keys']['fkey']) && is_array($properties['keys']['fkey'])) {\r\n          foreach ($properties['keys']['fkey'] as $key_name => $key_values) {\r\n             $keys_to_exist[] = $key_name;\r\n          }\r\n        }\r\n        // Step 2: Drop all vanished indexes\r\n        while ($row = array_shift($keys_in_table)) {\r\n          if (!in_array($row['Key_name'], $keys_to_exist)) {\r\n            $pdo->query(\"ALTER TABLE `\" . $table . \"` DROP INDEX `\" . $row['Key_name'] . \"`\");\r\n          }\r\n        }\r\n        // Step 3: Drop all vanished primary keys\r\n        if (!isset($properties['keys']['primary'])) {\r\n          $stmt = $pdo->query(\"SHOW KEYS FROM `\" . $table . \"` WHERE Key_name = 'PRIMARY'\"); \r\n          $num_results = count($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n          if ($num_results != 0) {\r\n            $pdo->query(\"ALTER TABLE `\" . $table . \"` DROP PRIMARY KEY\");\r\n          }\r\n        }\r\n      }\r\n      else {\r\n        // Create table if it is missing\r\n        $sql = \"CREATE TABLE IF NOT EXISTS `\" . $table . \"` (\";\r\n        foreach($properties['cols'] as $column => $type) {\r\n          $sql .= \"`\" . $column . \"` \" . $type . \",\";\r\n        }\r\n        foreach($properties['keys'] as $key_type => $key_content) {\r\n          if (strtolower($key_type) == 'primary') {\r\n            foreach ($key_content as $key_values) {\r\n              $fields = \"`\" . implode(\"`, `\", $key_values) . \"`\";\r\n              $sql .= \"PRIMARY KEY (\" . $fields . \")\" . \",\";\r\n            }\r\n          }\r\n          elseif (strtolower($key_type) == 'key') {\r\n            foreach ($key_content as $key_name => $key_values) {\r\n              $fields = \"`\" . implode(\"`, `\", $key_values) . \"`\";\r\n              $sql .= \"KEY `\" . $key_name . \"` (\" . $fields . \")\" . \",\";\r\n            }\r\n          }\r\n          elseif (strtolower($key_type) == 'unique') {\r\n            foreach ($key_content as $key_name => $key_values) {\r\n              $fields = \"`\" . implode(\"`, `\", $key_values) . \"`\";\r\n              $sql .= \"UNIQUE KEY `\" . $key_name . \"` (\" . $fields . \")\" . \",\";\r\n            }\r\n          }\r\n          elseif (strtolower($key_type) == 'fkey') {\r\n            foreach ($key_content as $key_name => $key_values) {\r\n              @list($table_ref, $field_ref) = explode('.', $key_values['ref']);\r\n              $sql .= \"FOREIGN KEY `\" . $key_name . \"` (\" . $key_values['col'] . \") REFERENCES `\" . $table_ref . \"` (`\" . $field_ref . \"`)\r\n                ON DELETE \" . $key_values['delete'] . \" ON UPDATE \" . $key_values['update'] . \",\";\r\n            }\r\n          }\r\n        }\r\n        $sql = rtrim($sql, \",\");\r\n        $sql .= \") \" . $properties['attr'];\r\n        $pdo->query($sql);\r\n      }\r\n      // Reset table attributes\r\n      $pdo->query(\"ALTER TABLE `\" . $table . \"` \" . $properties['attr'] . \";\");\r\n\r\n    }\r\n\r\n    // Recreate SQL views\r\n    foreach ($views as $view => $create) {\r\n      $pdo->query(\"DROP VIEW IF EXISTS `\" . $view . \"`;\");\r\n      $pdo->query($create);\r\n    }\r\n    \r\n    // Mitigate imapsync pipemess issue\r\n    $pdo->query(\"UPDATE `imapsync` SET `custom_params` = '' \r\n      WHERE `custom_params` LIKE '%pipemess%' \r\n        OR custom_params LIKE '%skipmess%' \r\n        OR custom_params LIKE '%delete2foldersonly%' \r\n        OR custom_params LIKE '%delete2foldersbutnot%' \r\n        OR custom_params LIKE '%regexflag%' \r\n        OR custom_params LIKE '%pipemess%' \r\n        OR custom_params LIKE '%regextrans2%' \r\n        OR custom_params LIKE '%maxlinelengthcmd%';\");\r\n\r\n\r\n    // Migrate webauthn tfa\r\n    $stmt = $pdo->query(\"ALTER TABLE `tfa` MODIFY COLUMN `authmech` ENUM('yubi_otp', 'u2f', 'hotp', 'totp', 'webauthn')\");\r\n\r\n    // Inject admin if not exists\r\n    $stmt = $pdo->query(\"SELECT NULL FROM `admin`\"); \r\n    $num_results = count($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n    if ($num_results == 0) {\r\n    $pdo->query(\"INSERT INTO `admin` (`username`, `password`, `superadmin`, `created`, `modified`, `active`)\r\n      VALUES ('admin', '{SSHA256}K8eVJ6YsZbQCfuJvSUbaQRLr0HPLz5rC9IAp0PAFl0tmNDBkMDc0NDAyOTAxN2Rk', 1, NOW(), NOW(), 1)\");\r\n    $pdo->query(\"INSERT INTO `domain_admins` (`username`, `domain`, `created`, `active`)\r\n        SELECT `username`, 'ALL', NOW(), 1 FROM `admin`\r\n          WHERE superadmin='1' AND `username` NOT IN (SELECT `username` FROM `domain_admins`);\");\r\n    $pdo->query(\"DELETE FROM `admin` WHERE `username` NOT IN  (SELECT `username` FROM `domain_admins`);\");\r\n    }\r\n    // Insert new DB schema version\r\n    $pdo->query(\"REPLACE INTO `versions` (`application`, `version`) VALUES ('db_schema', '\" . $db_version . \"');\");\r\n\r\n    // Fix dangling domain admins\r\n    $pdo->query(\"DELETE FROM `admin` WHERE `superadmin` = 0 AND `username` NOT IN (SELECT `username`FROM `domain_admins`);\");\r\n    $pdo->query(\"DELETE FROM `da_acl` WHERE `username` NOT IN (SELECT `username`FROM `domain_admins`);\");\r\n\r\n    // Migrate attributes\r\n    // pushover\r\n    $pdo->query(\"UPDATE `pushover` SET `attributes` = '{}' WHERE `attributes` = '' OR `attributes` IS NULL;\");\r\n    $pdo->query(\"UPDATE `pushover` SET `attributes` =  JSON_SET(`attributes`, '$.evaluate_x_prio', \\\"0\\\") WHERE JSON_VALUE(`attributes`, '$.evaluate_x_prio') IS NULL;\");\r\n    $pdo->query(\"UPDATE `pushover` SET `attributes` =  JSON_SET(`attributes`, '$.only_x_prio', \\\"0\\\") WHERE JSON_VALUE(`attributes`, '$.only_x_prio') IS NULL;\");\r\n    // mailbox\r\n    $pdo->query(\"UPDATE `mailbox` SET `attributes` = '{}' WHERE `attributes` = '' OR `attributes` IS NULL;\");\r\n    $pdo->query(\"UPDATE `mailbox` SET `attributes` =  JSON_SET(`attributes`, '$.passwd_update', \\\"0\\\") WHERE JSON_VALUE(`attributes`, '$.passwd_update') IS NULL;\");\r\n    $pdo->query(\"UPDATE `mailbox` SET `attributes` =  JSON_SET(`attributes`, '$.relayhost', \\\"0\\\") WHERE JSON_VALUE(`attributes`, '$.relayhost') IS NULL;\");\r\n    $pdo->query(\"UPDATE `mailbox` SET `attributes` =  JSON_SET(`attributes`, '$.force_pw_update', \\\"0\\\") WHERE JSON_VALUE(`attributes`, '$.force_pw_update') IS NULL;\");\r\n    $pdo->query(\"UPDATE `mailbox` SET `attributes` =  JSON_SET(`attributes`, '$.sieve_access', \\\"1\\\") WHERE JSON_VALUE(`attributes`, '$.sieve_access') IS NULL;\");\r\n    $pdo->query(\"UPDATE `mailbox` SET `attributes` =  JSON_SET(`attributes`, '$.sogo_access', \\\"1\\\") WHERE JSON_VALUE(`attributes`, '$.sogo_access') IS NULL;\");\r\n    $pdo->query(\"UPDATE `mailbox` SET `attributes` =  JSON_SET(`attributes`, '$.imap_access', \\\"1\\\") WHERE JSON_VALUE(`attributes`, '$.imap_access') IS NULL;\");\r\n    $pdo->query(\"UPDATE `mailbox` SET `attributes` =  JSON_SET(`attributes`, '$.pop3_access', \\\"1\\\") WHERE JSON_VALUE(`attributes`, '$.pop3_access') IS NULL;\");\r\n    $pdo->query(\"UPDATE `mailbox` SET `attributes` =  JSON_SET(`attributes`, '$.smtp_access', \\\"1\\\") WHERE JSON_VALUE(`attributes`, '$.smtp_access') IS NULL;\");\r\n    $pdo->query(\"UPDATE `mailbox` SET `attributes` =  JSON_SET(`attributes`, '$.mailbox_format', \\\"maildir:\\\") WHERE JSON_VALUE(`attributes`, '$.mailbox_format') IS NULL;\");\r\n    $pdo->query(\"UPDATE `mailbox` SET `attributes` =  JSON_SET(`attributes`, '$.quarantine_notification', \\\"never\\\") WHERE JSON_VALUE(`attributes`, '$.quarantine_notification') IS NULL;\");\r\n    $pdo->query(\"UPDATE `mailbox` SET `attributes` =  JSON_SET(`attributes`, '$.quarantine_category', \\\"reject\\\") WHERE JSON_VALUE(`attributes`, '$.quarantine_category') IS NULL;\");\r\n    foreach($tls_options as $tls_user => $tls_options) {\r\n      $stmt = $pdo->prepare(\"UPDATE `mailbox` SET `attributes` = JSON_SET(`attributes`, '$.tls_enforce_in', :tls_enforce_in),\r\n        `attributes` = JSON_SET(`attributes`, '$.tls_enforce_out', :tls_enforce_out)\r\n          WHERE `username` = :username\");\r\n      $stmt->execute(array(':tls_enforce_in' => $tls_options['tls_enforce_in'], ':tls_enforce_out' => $tls_options['tls_enforce_out'], ':username' => $tls_user));\r\n    }\r\n    // Set tls_enforce_* if still missing (due to deleted attrs for example)\r\n    $pdo->query(\"UPDATE `mailbox` SET `attributes` =  JSON_SET(`attributes`, '$.tls_enforce_out', \\\"1\\\") WHERE JSON_VALUE(`attributes`, '$.tls_enforce_out') IS NULL;\");\r\n    $pdo->query(\"UPDATE `mailbox` SET `attributes` =  JSON_SET(`attributes`, '$.tls_enforce_in', \\\"1\\\") WHERE JSON_VALUE(`attributes`, '$.tls_enforce_in') IS NULL;\");\r\n    // Fix ACL\r\n    $pdo->query(\"INSERT INTO `user_acl` (`username`) SELECT `username` FROM `mailbox` WHERE `kind` = '' AND NOT EXISTS (SELECT `username` FROM `user_acl`);\");\r\n    $pdo->query(\"INSERT INTO `da_acl` (`username`) SELECT DISTINCT `username` FROM `domain_admins` WHERE `username` != 'admin' AND NOT EXISTS (SELECT `username` FROM `da_acl`);\");\r\n    // Fix domain_admins\r\n    $pdo->query(\"DELETE FROM `domain_admins` WHERE `domain` = 'ALL';\");\r\n\r\n    if (php_sapi_name() == \"cli\") {\r\n      echo \"DB initialization completed\" . PHP_EOL;\r\n    } else {\r\n      $_SESSION['return'][] = array(\r\n        'type' => 'success',\r\n        'log' => array(__FUNCTION__),\r\n        'msg' => 'db_init_complete'\r\n      );\r\n    }\r\n  }\r\n  catch (PDOException $e) {\r\n    if (php_sapi_name() == \"cli\") {\r\n      echo \"DB initialization failed: \" . print_r($e, true) . PHP_EOL;\r\n    } else {\r\n      $_SESSION['return'][] = array(\r\n        'type' => 'danger',\r\n        'log' => array(__FUNCTION__),\r\n        'msg' => array('mysql_error', $e)\r\n      );\r\n    }\r\n  }\r\n}\r\nif (php_sapi_name() == \"cli\") {\r\n  include '/web/inc/vars.inc.php';\r\n  include '/web/inc/functions.docker.inc.php';\r\n  // $now = new DateTime();\r\n  // $mins = $now->getOffset() / 60;\r\n  // $sgn = ($mins < 0 ? -1 : 1);\r\n  // $mins = abs($mins);\r\n  // $hrs = floor($mins / 60);\r\n  // $mins -= $hrs * 60;\r\n  // $offset = sprintf('%+d:%02d', $hrs*$sgn, $mins);\r\n  $dsn = $database_type . \":unix_socket=\" . $database_sock . \";dbname=\" . $database_name;\r\n  $opt = [\r\n    PDO::ATTR_ERRMODE            => PDO::ERRMODE_EXCEPTION,\r\n    PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,\r\n    PDO::ATTR_EMULATE_PREPARES   => false,\r\n    //PDO::MYSQL_ATTR_INIT_COMMAND => \"SET time_zone = '\" . $offset . \"', group_concat_max_len = 3423543543;\",\r\n  ];\r\n  $pdo = new PDO($dsn, $database_user, $database_pass, $opt);\r\n  $stmt = $pdo->query(\"SELECT COUNT('OK') AS OK_C FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'sogo_view' OR TABLE_NAME = '_sogo_static_view';\");\r\n  $res = $stmt->fetch(PDO::FETCH_ASSOC);\r\n  if (intval($res['OK_C']) === 2) {\r\n    // Be more precise when replacing into _sogo_static_view, col orders may change\r\n    try {\r\n      $stmt = $pdo->query(\"REPLACE INTO _sogo_static_view (`c_uid`, `domain`, `c_name`, `c_password`, `c_cn`, `mail`, `aliases`, `ad_aliases`, `ext_acl`, `kind`, `multiple_bookings`)\r\n        SELECT `c_uid`, `domain`, `c_name`, `c_password`, `c_cn`, `mail`, `aliases`, `ad_aliases`, `ext_acl`, `kind`, `multiple_bookings` from sogo_view\");\r\n      $stmt = $pdo->query(\"DELETE FROM _sogo_static_view WHERE `c_uid` NOT IN (SELECT `username` FROM `mailbox` WHERE `active` = '1');\");\r\n      echo \"Fixed _sogo_static_view\" . PHP_EOL;\r\n    }\r\n    catch ( Exception $e ) {\r\n      // Dunno\r\n    }\r\n  }\r\n  try {\r\n    $m = new Memcached();\r\n    $m->addServer('memcached', 11211);\r\n    $m->flush();\r\n    echo \"Cleaned up memcached\". PHP_EOL;\r\n  }\r\n  catch ( Exception $e ) {\r\n    // Dunno\r\n  }\r\n  init_db_schema();\r\n}\r\n"], "filenames": ["data/web/inc/init_db.inc.php"], "buggy_code_start_loc": [6], "buggy_code_end_loc": [1233], "fixing_code_start_loc": [6], "fixing_code_end_loc": [1242], "type": "CWE-78", "message": "mailcow is a mailserver suite. Prior to mailcow-dockerized version 2022-06a, an extended privilege vulnerability can be exploited by manipulating the custom parameters regexmess, skipmess, regexflag, delete2foldersonly, delete2foldersbutnot, regextrans2, pipemess, or maxlinelengthcmd to execute arbitrary code. Users should update their mailcow instances with the `update.sh` script in the mailcow root directory to 2022-06a or newer to receive a patch for this issue. As a temporary workaround, the Syncjob ACL can be removed from all mailbox users, preventing changes to those settings.", "other": {"cve": {"id": "CVE-2022-31138", "sourceIdentifier": "security-advisories@github.com", "published": "2022-07-11T14:15:08.427", "lastModified": "2022-07-18T13:53:48.017", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "mailcow is a mailserver suite. Prior to mailcow-dockerized version 2022-06a, an extended privilege vulnerability can be exploited by manipulating the custom parameters regexmess, skipmess, regexflag, delete2foldersonly, delete2foldersbutnot, regextrans2, pipemess, or maxlinelengthcmd to execute arbitrary code. Users should update their mailcow instances with the `update.sh` script in the mailcow root directory to 2022-06a or newer to receive a patch for this issue. As a temporary workaround, the Syncjob ACL can be removed from all mailbox users, preventing changes to those settings."}, {"lang": "es", "value": "mailcow es una suite de servidores de correo. En versiones anteriores a 2022-06a de mailcow-dockerized, una vulnerabilidad de privilegio extendido puede ser explotada al manipular los par\u00e1metros personalizados regexmess, skipmess, regexflag, delete2foldersonly, delete2foldersbutnot, regextrans2, pipemess, o maxlinelengthcmd para ejecutar c\u00f3digo arbitrario. Los usuarios deben actualizar sus instancias de mailcow con el script \"update.sh\" en el directorio root de mailcow a 2022-06a o m\u00e1s reciente para recibir un parche para este problema. Como mitigaci\u00f3n soluci\u00f3n temporal, puede eliminarse la ACL de Syncjob de todos los usuarios de buzones de correo, impidiendo que sean realizados cambios en dicha configuraci\u00f3n"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 8.8, "baseSeverity": "HIGH"}, "exploitabilityScore": 2.8, "impactScore": 5.9}, {"source": "security-advisories@github.com", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 8.8, "baseSeverity": "HIGH"}, "exploitabilityScore": 2.8, "impactScore": 5.9}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:S/C:C/I:C/A:C", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "SINGLE", "confidentialityImpact": "COMPLETE", "integrityImpact": "COMPLETE", "availabilityImpact": "COMPLETE", "baseScore": 9.0}, "baseSeverity": "HIGH", "exploitabilityScore": 8.0, "impactScore": 10.0, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "security-advisories@github.com", "type": "Primary", "description": [{"lang": "en", "value": "CWE-78"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:mailcow:mailcow\\:_dockerized:*:*:*:*:*:*:*:*", "versionEndExcluding": "2022-06a", "matchCriteriaId": "A9FD469E-8146-45CE-A914-101B7043DFAD"}]}]}], "references": [{"url": "https://github.com/ly1g3/Mailcow-CVE-2022-31138", "source": "security-advisories@github.com", "tags": ["Exploit", "Third Party Advisory"]}, {"url": "https://github.com/mailcow/mailcow-dockerized/commit/d373164e13a14e058f82c9f1918a5612f375a9f9", "source": "security-advisories@github.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/mailcow/mailcow-dockerized/releases/tag/2022-06a", "source": "security-advisories@github.com", "tags": ["Release Notes", "Third Party Advisory"]}, {"url": "https://github.com/mailcow/mailcow-dockerized/security/advisories/GHSA-vx9w-h33p-5vhc", "source": "security-advisories@github.com", "tags": ["Mitigation", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/mailcow/mailcow-dockerized/commit/d373164e13a14e058f82c9f1918a5612f375a9f9"}}