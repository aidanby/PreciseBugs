{"buggy_code": ["<?php\n/*\n FusionPBX\n Version: MPL 1.1\n\n The contents of this file are subject to the Mozilla Public License Version\n 1.1 (the \"License\"); you may not use this file except in compliance with\n the License. You may obtain a copy of the License at\n http://www.mozilla.org/MPL/\n\n Software distributed under the License is distributed on an \"AS IS\" basis,\n WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n for the specific language governing rights and limitations under the\n License.\n\n The Original Code is FusionPBX\n\n The Initial Developer of the Original Code is\n Mark J Crane <markjcrane@fusionpbx.com>\n Portions created by the Initial Developer are Copyright (C) 2008-2012\n the Initial Developer. All Rights Reserved.\n\n Contributor(s):\n Mark J Crane <markjcrane@fusionpbx.com>\n*/\nrequire_once \"root.php\";\nrequire_once \"resources/require.php\";\nrequire_once \"resources/check_auth.php\";\nif (permission_exists('device_setting_view')) {\n\t//access granted\n}\nelse {\n\techo \"access denied\";\n\texit;\n}\n\n//add multi-lingual support\n\t$language = new text;\n\t$text = $language->get();\n\nrequire_once \"resources/header.php\";\nrequire_once \"resources/paging.php\";\n\n//get variables used to control the order\n\t$order_by = $_GET[\"order_by\"];\n\t$order = $_GET[\"order\"];\n\t$device_uuid = $_GET[\"id\"];\n\n//show the content\n\techo \"<table width='100%' cellpadding='0' cellspacing='0' border='0'>\\n\";\n\techo \"\t<tr>\\n\";\n\techo \"\t\t<td width='50%' align='left' nowrap='nowrap'><b>Device Settings</b></td>\\n\";\n\techo \"\t\t<td width='50%' align='right'>&nbsp;</td>\\n\";\n\techo \"\t</tr>\\n\";\n\techo \"\t<tr>\\n\";\n\techo \"\t\t<td align='left' colspan='2'>\\n\";\n\techo \"\t\t\tSettings used for each device.<br /><br />\\n\";\n\techo \"\t\t</td>\\n\";\n\techo \"\t</tr>\\n\";\n\techo \"</table>\\n\";\n\n\t//prepare to page the results\n\t\t$sql = \"select count(*) from v_devices_settings \";\n\t\t$sql .= \"where device_uuid = :device_uuid \";\n\t\t$sql .= \"and domain_uuid = :domain_uuid \";\n\t\t$parameters['device_uuid'] = $device_uuid;\n\t\t$parameters['domain_uuid'] = $domain_uuid;\n\t\t$database = new database;\n\t\t$num_rows = $database->select($sql, $parameters, 'column');\n\t\tunset($sql);\n\n\t//prepare to page the results\n\t\t$rows_per_page = ($_SESSION['domain']['paging']['numeric'] != '') ? $_SESSION['domain']['paging']['numeric'] : 50;\n\t\t$param = \"\";\n\t\t$page = $_GET['page'];\n\t\tif (strlen($page) == 0) { $page = 0; $_GET['page'] = 0; }\n\t\tlist($paging_controls, $rows_per_page, $var3) = paging($num_rows, $param, $rows_per_page);\n\t\t$offset = $rows_per_page * $page;\n\n\t//get the list\n\t\t$sql = str_replace('count(*)', '*', $sql);\n\t\t$sql .= order_by($order_by, $order);\n\t\t$sql .= limit_offset($rows_per_page, $offset);\n\t\t$database = new database;\n\t\t$result = $database->select($sql, $parameters, 'all');\n\t\tunset($sql, $parameters);\n\n\t$c = 0;\n\t$row_style[\"0\"] = \"row_style0\";\n\t$row_style[\"1\"] = \"row_style1\";\n\n\techo \"<table width='100%' border='0' cellpadding='0' cellspacing='0'>\\n\";\n\n\tif (is_array($result) && @sizeof($result) != 0) {\n\t\t$previous_category = '';\n\t\tforeach($result as $row) {\n\t\t\tif ($previous_category != $row['device_setting_category']) {\n\t\t\t\techo \"<tr><td colspan='5' align='left'>\\n\";\n\t\t\t\techo \"\t<br />\\n\";\n\t\t\t\techo \"\t<br />\\n\";\n\t\t\t\techo \"\t<b>\".ucfirst($row['device_setting_category']).\"</b>&nbsp;</td></tr>\\n\";\n\t\t\t\techo \"<tr>\\n\";\n\t\t\t\techo th_order_by('device_setting_subcategory', $text['label-category'], $order_by, $order);\n\t\t\t\techo th_order_by('device_setting_name', $text['label-type'], $order_by, $order);\n\t\t\t\techo th_order_by('device_setting_value', $text['label-value'], $order_by, $order);\n\t\t\t\techo th_order_by('device_setting_enabled', $text['label-enabled'], $order_by, $order);\n\t\t\t\techo th_order_by('device_setting_description', $text['label-description'], $order_by, $order);\n\t\t\t\techo \"<td align='right' width='42'>\\n\";\n\t\t\t\tif (permission_exists('device_setting_add')) {\n\t\t\t\t\techo \"\t<a href='device_setting_edit.php?device_uuid=\".$_GET['id'].\"' alt='\".$text['button-add'].\"'>$v_link_label_add</a>\\n\";\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\techo \"\t&nbsp;\\n\";\n\t\t\t\t}\n\n\t\t\t\techo \"</td>\\n\";\n\t\t\t\techo \"</tr>\\n\";\n\t\t\t}\n\t\t\techo \"<tr >\\n\";\n\t\t\techo \"\t<td valign='top' class='\".$row_style[$c].\"'>\".$row['device_setting_subcategory'].\"&nbsp;</td>\\n\";\n\t\t\techo \"\t<td valign='top' class='\".$row_style[$c].\"'>\".$row['device_setting_name'].\"&nbsp;</td>\\n\";\n\t\t\techo \"\t<td valign='top' class='\".$row_style[$c].\"'>\".$row['device_setting_value'].\"&nbsp;</td>\\n\";\n\t\t\techo \"\t<td valign='top' class='\".$row_style[$c].\"'>\".$row['device_setting_enabled'].\"&nbsp;</td>\\n\";\n\t\t\techo \"\t<td valign='top' class='\".$row_style[$c].\"'>\".$row['device_setting_description'].\"&nbsp;</td>\\n\";\n\t\t\techo \"\t<td valign='top' align='right'>\\n\";\n\t\t\tif (permission_exists('device_setting_edit')) {\n\t\t\techo \"\t\t<a href='device_setting_edit.php?device_uuid=\".$row['device_uuid'].\"&id=\".$row['device_setting_uuid'].\"' alt='\".$text['button-edit'].\"'>$v_link_label_edit</a>\\n\";\n\t\t\t}\n\t\t\tif (permission_exists('device_setting_delete')) {\n\t\t\techo \"\t\t<a href='device_setting_delete.php?device_uuid=\".$row['device_uuid'].\"&id=\".$row['device_setting_uuid'].\"' alt='\".$text['button-delete'].\"' onclick=\\\"return confirm('\".$text['confirm-delete'].\"')\\\">$v_link_label_delete</a>\\n\";\n\t\t\t}\n\t\t\techo \"\t</td>\\n\";\n\t\t\techo \"</tr>\\n\";\n\t\t\t$previous_category = $row['device_setting_category'];\n\t\t\tif ($c==0) { $c=1; } else { $c=0; }\n\t\t}\n\t}\n\tunset($result, $row);\n\n\techo \"<tr>\\n\";\n\techo \"<td colspan='6' align='left'>\\n\";\n\techo \"\t<table width='100%' cellpadding='0' cellspacing='0'>\\n\";\n\techo \"\t<tr>\\n\";\n\techo \"\t\t<td width='33.3%' nowrap>&nbsp;</td>\\n\";\n\techo \"\t\t<td width='33.3%' align='center' nowrap>$paging_controls</td>\\n\";\n\techo \"\t\t<td width='33.3%' align='right'>\\n\";\n\tif (permission_exists('device_setting_add')) {\n\t\techo \"\t\t\t<a href='device_setting_edit.php?device_uuid=\".$_GET['id'].\"' alt='\".$text['button-add'].\"'>$v_link_label_add</a>\\n\";\n\t}\n\telse {\n\t\techo \"\t\t\t&nbsp;\\n\";\n\t}\n\techo \"\t\t</td>\\n\";\n\techo \"\t</tr>\\n\";\n \techo \"\t</table>\\n\";\n\techo \"</td>\\n\";\n\techo \"</tr>\\n\";\n\n\techo \"</table>\";\n\techo \"<br /><br />\";\n\n//include the footer\n\trequire_once \"resources/footer.php\";\n?>"], "fixing_code": ["<?php\n/*\n FusionPBX\n Version: MPL 1.1\n\n The contents of this file are subject to the Mozilla Public License Version\n 1.1 (the \"License\"); you may not use this file except in compliance with\n the License. You may obtain a copy of the License at\n http://www.mozilla.org/MPL/\n\n Software distributed under the License is distributed on an \"AS IS\" basis,\n WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n for the specific language governing rights and limitations under the\n License.\n\n The Original Code is FusionPBX\n\n The Initial Developer of the Original Code is\n Mark J Crane <markjcrane@fusionpbx.com>\n Portions created by the Initial Developer are Copyright (C) 2008-2019\n the Initial Developer. All Rights Reserved.\n\n Contributor(s):\n Mark J Crane <markjcrane@fusionpbx.com>\n*/\n\n//includes\n\trequire_once \"root.php\";\n\trequire_once \"resources/require.php\";\n\trequire_once \"resources/check_auth.php\";\n\n//check permissions\n\tif (permission_exists('device_setting_view')) {\n\t\t//access granted\n\t}\n\telse {\n\t\techo \"access denied\";\n\t\texit;\n\t}\n\n//add multi-lingual support\n\t$language = new text;\n\t$text = $language->get();\n\n//additional includes\n\trequire_once \"resources/header.php\";\n\trequire_once \"resources/paging.php\";\n\n//get variables used to control the order\n\t$order_by = $_GET[\"order_by\"];\n\t$order = $_GET[\"order\"];\n\n//get the uuid\n\tif (is_uuid($_GET['id'])) {\n\t\t$device_uuid = $_GET['id'];\n\t}\n\n//show the content\n\techo \"<table width='100%' cellpadding='0' cellspacing='0' border='0'>\\n\";\n\techo \"\t<tr>\\n\";\n\techo \"\t\t<td width='50%' align='left' nowrap='nowrap'><b>Device Settings</b></td>\\n\";\n\techo \"\t\t<td width='50%' align='right'>&nbsp;</td>\\n\";\n\techo \"\t</tr>\\n\";\n\techo \"\t<tr>\\n\";\n\techo \"\t\t<td align='left' colspan='2'>\\n\";\n\techo \"\t\t\tSettings used for each device.<br /><br />\\n\";\n\techo \"\t\t</td>\\n\";\n\techo \"\t</tr>\\n\";\n\techo \"</table>\\n\";\n\n\t//prepare to page the results\n\t\t$sql = \"select count(*) from v_devices_settings \";\n\t\t$sql .= \"where device_uuid = :device_uuid \";\n\t\t$sql .= \"and domain_uuid = :domain_uuid \";\n\t\t$parameters['device_uuid'] = $device_uuid;\n\t\t$parameters['domain_uuid'] = $domain_uuid;\n\t\t$database = new database;\n\t\t$num_rows = $database->select($sql, $parameters, 'column');\n\t\tunset($sql);\n\n\t//prepare to page the results\n\t\t$rows_per_page = ($_SESSION['domain']['paging']['numeric'] != '') ? $_SESSION['domain']['paging']['numeric'] : 50;\n\t\t$param = \"\";\n\t\t$page = $_GET['page'];\n\t\tif (strlen($page) == 0) { $page = 0; $_GET['page'] = 0; }\n\t\tlist($paging_controls, $rows_per_page, $var3) = paging($num_rows, $param, $rows_per_page);\n\t\t$offset = $rows_per_page * $page;\n\n\t//get the list\n\t\t$sql = str_replace('count(*)', '*', $sql);\n\t\t$sql .= order_by($order_by, $order);\n\t\t$sql .= limit_offset($rows_per_page, $offset);\n\t\t$database = new database;\n\t\t$result = $database->select($sql, $parameters, 'all');\n\t\tunset($sql, $parameters);\n\n\t$c = 0;\n\t$row_style[\"0\"] = \"row_style0\";\n\t$row_style[\"1\"] = \"row_style1\";\n\n\techo \"<table width='100%' border='0' cellpadding='0' cellspacing='0'>\\n\";\n\n\tif (is_array($result) && @sizeof($result) != 0) {\n\t\t$previous_category = '';\n\t\tforeach($result as $row) {\n\t\t\tif ($previous_category != $row['device_setting_category']) {\n\t\t\t\techo \"<tr><td colspan='5' align='left'>\\n\";\n\t\t\t\techo \"\t<br />\\n\";\n\t\t\t\techo \"\t<br />\\n\";\n\t\t\t\techo \"\t<b>\".ucfirst($row['device_setting_category']).\"</b>&nbsp;</td></tr>\\n\";\n\t\t\t\techo \"<tr>\\n\";\n\t\t\t\techo th_order_by('device_setting_subcategory', $text['label-category'], $order_by, $order);\n\t\t\t\techo th_order_by('device_setting_name', $text['label-type'], $order_by, $order);\n\t\t\t\techo th_order_by('device_setting_value', $text['label-value'], $order_by, $order);\n\t\t\t\techo th_order_by('device_setting_enabled', $text['label-enabled'], $order_by, $order);\n\t\t\t\techo th_order_by('device_setting_description', $text['label-description'], $order_by, $order);\n\t\t\t\techo \"<td align='right' width='42'>\\n\";\n\t\t\t\tif (permission_exists('device_setting_add')) {\n\t\t\t\t\techo \"\t<a href='device_setting_edit.php?device_uuid=\".urlencode($device_uuid).\"' alt='\".$text['button-add'].\"'>$v_link_label_add</a>\\n\";\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\techo \"\t&nbsp;\\n\";\n\t\t\t\t}\n\n\t\t\t\techo \"</td>\\n\";\n\t\t\t\techo \"</tr>\\n\";\n\t\t\t}\n\t\t\techo \"<tr >\\n\";\n\t\t\techo \"\t<td valign='top' class='\".$row_style[$c].\"'>\".$row['device_setting_subcategory'].\"&nbsp;</td>\\n\";\n\t\t\techo \"\t<td valign='top' class='\".$row_style[$c].\"'>\".$row['device_setting_name'].\"&nbsp;</td>\\n\";\n\t\t\techo \"\t<td valign='top' class='\".$row_style[$c].\"'>\".$row['device_setting_value'].\"&nbsp;</td>\\n\";\n\t\t\techo \"\t<td valign='top' class='\".$row_style[$c].\"'>\".$row['device_setting_enabled'].\"&nbsp;</td>\\n\";\n\t\t\techo \"\t<td valign='top' class='\".$row_style[$c].\"'>\".$row['device_setting_description'].\"&nbsp;</td>\\n\";\n\t\t\techo \"\t<td valign='top' align='right'>\\n\";\n\t\t\tif (permission_exists('device_setting_edit')) {\n\t\t\techo \"\t\t<a href='device_setting_edit.php?device_uuid=\".$row['device_uuid'].\"&id=\".$row['device_setting_uuid'].\"' alt='\".$text['button-edit'].\"'>$v_link_label_edit</a>\\n\";\n\t\t\t}\n\t\t\tif (permission_exists('device_setting_delete')) {\n\t\t\techo \"\t\t<a href='device_setting_delete.php?device_uuid=\".$row['device_uuid'].\"&id=\".$row['device_setting_uuid'].\"' alt='\".$text['button-delete'].\"' onclick=\\\"return confirm('\".$text['confirm-delete'].\"')\\\">$v_link_label_delete</a>\\n\";\n\t\t\t}\n\t\t\techo \"\t</td>\\n\";\n\t\t\techo \"</tr>\\n\";\n\t\t\t$previous_category = $row['device_setting_category'];\n\t\t\tif ($c==0) { $c=1; } else { $c=0; }\n\t\t}\n\t}\n\tunset($result, $row);\n\n\techo \"<tr>\\n\";\n\techo \"<td colspan='6' align='left'>\\n\";\n\techo \"\t<table width='100%' cellpadding='0' cellspacing='0'>\\n\";\n\techo \"\t<tr>\\n\";\n\techo \"\t\t<td width='33.3%' nowrap>&nbsp;</td>\\n\";\n\techo \"\t\t<td width='33.3%' align='center' nowrap>$paging_controls</td>\\n\";\n\techo \"\t\t<td width='33.3%' align='right'>\\n\";\n\tif (permission_exists('device_setting_add')) {\n\t\techo \"\t\t\t<a href='device_setting_edit.php?device_uuid=\".$_GET['id'].\"' alt='\".$text['button-add'].\"'>$v_link_label_add</a>\\n\";\n\t}\n\telse {\n\t\techo \"\t\t\t&nbsp;\\n\";\n\t}\n\techo \"\t\t</td>\\n\";\n\techo \"\t</tr>\\n\";\n \techo \"\t</table>\\n\";\n\techo \"</td>\\n\";\n\techo \"</tr>\\n\";\n\n\techo \"</table>\";\n\techo \"<br /><br />\";\n\n//include the footer\n\trequire_once \"resources/footer.php\";\n?>\n"], "filenames": ["app/devices/device_settings.php"], "buggy_code_start_loc": [20], "buggy_code_end_loc": [165], "fixing_code_start_loc": [20], "fixing_code_end_loc": [174], "type": "CWE-79", "message": "In FusionPBX up to v4.5.7, the file app\\devices\\device_settings.php uses an unsanitized \"id\" variable coming from the URL, which is reflected on 2 occasions in HTML, leading to XSS.", "other": {"cve": {"id": "CVE-2019-16978", "sourceIdentifier": "cve@mitre.org", "published": "2019-10-21T15:15:10.637", "lastModified": "2023-02-03T21:46:52.077", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "In FusionPBX up to v4.5.7, the file app\\devices\\device_settings.php uses an unsanitized \"id\" variable coming from the URL, which is reflected on 2 occasions in HTML, leading to XSS."}, {"lang": "es", "value": "En FusionPBX versiones hasta v4.5.7, el archivo app\\devices\\device_settings.php utiliza una variable \"id\" no saneada que proviene de la URL, que es reflejada en 2 ocasiones en HTML, conllevando a una vulnerabilidad de tipo XSS."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:fusionpbx:fusionpbx:*:*:*:*:*:*:*:*", "versionEndIncluding": "4.5.7", "matchCriteriaId": "A5A0C1F9-8032-46C6-8DD4-DB91FACF7330"}]}]}], "references": [{"url": "https://github.com/fusionpbx/fusionpbx/commit/83622c4ee1d9dd1913e9fb01ce8f060b46a5768a", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://resp3ctblog.wordpress.com/2019/10/19/fusionpbx-xss-11/", "source": "cve@mitre.org", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/fusionpbx/fusionpbx/commit/83622c4ee1d9dd1913e9fb01ce8f060b46a5768a"}}