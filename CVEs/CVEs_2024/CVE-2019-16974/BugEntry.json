{"buggy_code": ["<?php\n/*\n\tFusionPBX\n\tVersion: MPL 1.1\n\n\tThe contents of this file are subject to the Mozilla Public License Version\n\t1.1 (the \"License\"); you may not use this file except in compliance with\n\tthe License. You may obtain a copy of the License at\n\thttp://www.mozilla.org/MPL/\n\n\tSoftware distributed under the License is distributed on an \"AS IS\" basis,\n\tWITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n\tfor the specific language governing rights and limitations under the\n\tLicense.\n\n\tThe Original Code is FusionPBX\n\n\tThe Initial Developer of the Original Code is\n\tMark J Crane <markjcrane@fusionpbx.com>\n\tPortions created by the Initial Developer are Copyright (C) 2008-2018\n\tthe Initial Developer. All Rights Reserved.\n\n\tContributor(s):\n\tMark J Crane <markjcrane@fusionpbx.com>\n*/\n\n//includes\n\trequire_once \"root.php\";\n\trequire_once \"resources/require.php\";\n\trequire_once \"resources/check_auth.php\";\n\n//check permissions\n\tif (permission_exists('contact_time_view')) {\n\t\t//access granted\n\t}\n\telse {\n\t\techo \"access denied\";\n\t\texit;\n\t}\n\n//get the contact list\n\t$sql = \"select ct.*, u.username, u.domain_uuid as user_domain_uuid \";\n\t$sql .= \"from v_contact_times as ct, v_users as u \";\n\t$sql .= \"where ct.user_uuid = u.user_uuid \";\n\t$sql .= \"and ct.domain_uuid = :domain_uuid \";\n\t$sql .= \"and ct.contact_uuid = :contact_uuid \";\n\t$sql .= \"order by ct.time_start desc \";\n\t$parameters['domain_uuid'] = $domain_uuid;\n\t$parameters['contact_uuid'] = $contact_uuid;\n\t$database = new database;\n\t$result = $database->select($sql, $parameters, 'all');\n\tunset($sql, $parameters);\n\n//set the row style\n\t$c = 0;\n\t$row_style[\"0\"] = \"row_style0\";\n\t$row_style[\"1\"] = \"row_style1\";\n\n//show the content\n\techo \"<table width='100%' border='0'>\\n\";\n\techo \"<tr>\\n\";\n\techo \"<td width='50%' align='left' nowrap='nowrap'><b>\".$text['header_contact_times'].\"</b></td>\\n\";\n\techo \"<td width='50%' align='right'>&nbsp;</td>\\n\";\n\techo \"</tr>\\n\";\n\techo \"</table>\\n\";\n\n\techo \"<table class='tr_hover' width='100%' border='0' cellpadding='0' cellspacing='0'>\\n\";\n\techo \"<tr>\\n\";\n\techo \"<th id='th_filler' style='display: none; padding: 0px;'>\".img_spacer('21px', '1px').\"</th>\\n\";\n\techo \"<th width='20%'>\".$text['label-time_user'].\"</th>\\n\";\n\techo \"<th width='20%'>\".$text['label-time_start'].\"</th>\\n\";\n\techo \"<th width='20%'>\".$text['label-time_duration'].\"</th>\\n\";\n\techo \"<th width='40%'>\".$text['label-time_description'].\"</th>\\n\";\n\techo \"<td class='list_control_icons' nowrap>\";\n\techo \timg_spacer('25px', '1px');\n\tif (permission_exists('contact_time_add')) {\n\t\techo \"<a href='contact_time_edit.php?contact_uuid=\".$_GET['id'].\"' alt='\".$text['button-add'].\"'>$v_link_label_add</a>\";\n\t}\n\telse {\n\t\techo img_spacer('25px', '1px');\n\t}\n\techo \"</td>\\n\";\n\techo \"</tr>\\n\";\n\techo \"</table>\\n\";\n\n\techo \"<div id='div_contact_times' style='width: 100%; overflow: auto; direction: rtl; text-align: right; margin-bottom: 23px;'>\";\n\techo \"<table id='table_contact_times' class='tr_hover' style='width: 100%; direction: ltr;' border='0' cellpadding='0' cellspacing='0'>\\n\";\n\tif (is_array($result) && @sizeof($result) != 0) {\n\t\tforeach($result as $row) {\n\t\t\t$tr_link = (permission_exists('contact_time_edit') && $row['user_uuid'] == $_SESSION[\"user\"][\"user_uuid\"]) ? \"href='contact_time_edit.php?contact_uuid=\".escape($row['contact_uuid']).\"&id=\".escape($row['contact_time_uuid']).\"'\" : null;\n\t\t\techo \"<tr \".$tr_link.\">\\n\";\n\t\t\tif ($row[\"time_start\"] != '' && $row['time_stop'] != '') {\n\t\t\t\t$time_start = strtotime($row[\"time_start\"]);\n\t\t\t\t$time_stop = strtotime($row['time_stop']);\n\t\t\t\t$time = gmdate(\"H:i:s\", ($time_stop - $time_start));\n\t\t\t}\n\t\t\telse { unset($time); }\n\t\t\t$tmp = explode(' ', $row['time_start']);\n\t\t\t$time_start = $tmp[0];\n\t\t\techo \"\t<td valign='top' class='\".$row_style[$c].\"' width='20%'><span \".(($row['user_domain_uuid'] != $domain_uuid) ? \"title='\".$_SESSION['domains'][escape($row['user_domain_uuid'])]['domain_name'].\"' style='cursor: help;'\" : null).\">\".escape($row[\"username\"]).\"</span>&nbsp;</td>\\n\";\n\t\t\techo \"\t<td valign='top' class='\".$row_style[$c].\"' width='20%'>\".$time_start.\"&nbsp;</td>\\n\";\n\t\t\techo \"\t<td valign='top' class='\".$row_style[$c].\"' width='20%'>\".$time.\"&nbsp;</td>\\n\";\n\t\t\techo \"\t<td valign='top' class='row_stylebg' style='width: 40%; max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;'>\".escape($row['time_description']).\"&nbsp;</td>\\n\";\n\t\t\techo \"\t<td class='list_control_icons' nowrap>\";\n\t\t\tif (permission_exists('contact_time_edit')) {\n\t\t\t\tif ($row['user_uuid'] == $_SESSION[\"user\"][\"user_uuid\"]) {\n\t\t\t\t\techo \"<a href='contact_time_edit.php?contact_uuid=\".escape($row['contact_uuid']).\"&id=\".escape($row['contact_time_uuid']).\"' alt='\".$text['button-edit'].\"'>\".$v_link_label_edit.\"</a>\";\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\techo \"<span onclick=\\\"alert('\".$text['message-access_denied'].\"');\\\" alt='\".$text['button-edit'].\"'>\".str_replace(\"list_control_icon\", \"list_control_icon_disabled\", $v_link_label_edit).\"</span>\";\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (permission_exists('contact_time_delete')) {\n\t\t\t\tif ($row['user_uuid'] == $_SESSION[\"user\"][\"user_uuid\"]) {\n\t\t\t\t\techo \"<a href='contact_time_delete.php?contact_uuid=\".escape($row['contact_uuid']).\"&id=\".escape($row['contact_time_uuid']).\"' alt='\".$text['button-delete'].\"' onclick=\\\"return confirm('\".$text['confirm-delete'].\"')\\\">\".$v_link_label_delete.\"</a>\";\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\techo \"<span onclick=\\\"alert('\".$text['message-access_denied'].\"');\\\" alt='\".$text['button-delete'].\"'>\".str_replace(\"list_control_icon\", \"list_control_icon_disabled\", $v_link_label_delete).\"</span>\";\n\t\t\t\t}\n\t\t\t}\n\t\t\techo \"\t</td>\\n\";\n\t\t\techo \"</tr>\\n\";\n\t\t\t$c = $c ? 0 : 1;\n\t\t} //end foreach\n\t\tunset($result, $row);\n\t} //end if results\n\techo \"</table>\";\n\techo \"</div>\\n\";\n\n\techo \"<script>\";\n\techo \"\tvar div_times = document.getElementById('div_contact_times');\";\n\techo \"\tvar table_times = document.getElementById('table_contact_times');\";\n\techo \"\tvar th_filler = document.getElementById('th_filler');\";\n\n\techo \"\tif (div_times.offsetHeight > 200) { \";\n\techo \"\t\tdiv_times.style.height = 200; \";\n\techo \"\t}\";\n\techo \"\telse {\";\n\techo \"\t\tdiv_times.style.height = div_times.scrollHeight + 1; \";\n\techo \"\t}\";\n\n\techo \"\tif (div_times.scrollHeight > div_times.clientHeight) {\";\n\techo \"\t\tth_filler.style.display = ''; \";\n\techo \"\t\ttable_times.style.paddingLeft = 1;\";\n\techo \"\t}\";\n\techo \"\telse {\";\n\techo \"\t\tth_filler.style.display = 'none'; \";\n\techo \"\t\ttable_times.style.paddingLeft = 0;\";\n\techo \"\t}\";\n\techo \"</script>\\n\";\n\n?>\n"], "fixing_code": ["<?php\n/*\n\tFusionPBX\n\tVersion: MPL 1.1\n\n\tThe contents of this file are subject to the Mozilla Public License Version\n\t1.1 (the \"License\"); you may not use this file except in compliance with\n\tthe License. You may obtain a copy of the License at\n\thttp://www.mozilla.org/MPL/\n\n\tSoftware distributed under the License is distributed on an \"AS IS\" basis,\n\tWITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n\tfor the specific language governing rights and limitations under the\n\tLicense.\n\n\tThe Original Code is FusionPBX\n\n\tThe Initial Developer of the Original Code is\n\tMark J Crane <markjcrane@fusionpbx.com>\n\tPortions created by the Initial Developer are Copyright (C) 2008-2018\n\tthe Initial Developer. All Rights Reserved.\n\n\tContributor(s):\n\tMark J Crane <markjcrane@fusionpbx.com>\n*/\n\n//includes\n\trequire_once \"root.php\";\n\trequire_once \"resources/require.php\";\n\trequire_once \"resources/check_auth.php\";\n\n//check permissions\n\tif (permission_exists('contact_time_view')) {\n\t\t//access granted\n\t}\n\telse {\n\t\techo \"access denied\";\n\t\texit;\n\t}\n\n//set the uuid\n\tif (is_uuid($_GET['id'])) {\n\t\t$contact_uuid = $_GET['id'];\n\t}\n\n//get the contact list\n\t$sql = \"select ct.*, u.username, u.domain_uuid as user_domain_uuid \";\n\t$sql .= \"from v_contact_times as ct, v_users as u \";\n\t$sql .= \"where ct.user_uuid = u.user_uuid \";\n\t$sql .= \"and ct.domain_uuid = :domain_uuid \";\n\t$sql .= \"and ct.contact_uuid = :contact_uuid \";\n\t$sql .= \"order by ct.time_start desc \";\n\t$parameters['domain_uuid'] = $domain_uuid;\n\t$parameters['contact_uuid'] = $contact_uuid;\n\t$database = new database;\n\t$result = $database->select($sql, $parameters, 'all');\n\tunset($sql, $parameters);\n\n//set the row style\n\t$c = 0;\n\t$row_style[\"0\"] = \"row_style0\";\n\t$row_style[\"1\"] = \"row_style1\";\n\n//show the content\n\techo \"<table width='100%' border='0'>\\n\";\n\techo \"<tr>\\n\";\n\techo \"<td width='50%' align='left' nowrap='nowrap'><b>\".$text['header_contact_times'].\"</b></td>\\n\";\n\techo \"<td width='50%' align='right'>&nbsp;</td>\\n\";\n\techo \"</tr>\\n\";\n\techo \"</table>\\n\";\n\n\techo \"<table class='tr_hover' width='100%' border='0' cellpadding='0' cellspacing='0'>\\n\";\n\techo \"<tr>\\n\";\n\techo \"<th id='th_filler' style='display: none; padding: 0px;'>\".img_spacer('21px', '1px').\"</th>\\n\";\n\techo \"<th width='20%'>\".$text['label-time_user'].\"</th>\\n\";\n\techo \"<th width='20%'>\".$text['label-time_start'].\"</th>\\n\";\n\techo \"<th width='20%'>\".$text['label-time_duration'].\"</th>\\n\";\n\techo \"<th width='40%'>\".$text['label-time_description'].\"</th>\\n\";\n\techo \"<td class='list_control_icons' nowrap>\";\n\techo \timg_spacer('25px', '1px');\n\tif (permission_exists('contact_time_add')) {\n\t\techo \"<a href='contact_time_edit.php?contact_uuid=\".urlencode($contact_uuid).\"' alt='\".$text['button-add'].\"'>$v_link_label_add</a>\";\n\t}\n\telse {\n\t\techo img_spacer('25px', '1px');\n\t}\n\techo \"</td>\\n\";\n\techo \"</tr>\\n\";\n\techo \"</table>\\n\";\n\n\techo \"<div id='div_contact_times' style='width: 100%; overflow: auto; direction: rtl; text-align: right; margin-bottom: 23px;'>\";\n\techo \"<table id='table_contact_times' class='tr_hover' style='width: 100%; direction: ltr;' border='0' cellpadding='0' cellspacing='0'>\\n\";\n\tif (is_array($result) && @sizeof($result) != 0) {\n\t\tforeach($result as $row) {\n\t\t\t$tr_link = (permission_exists('contact_time_edit') && $row['user_uuid'] == $_SESSION[\"user\"][\"user_uuid\"]) ? \"href='contact_time_edit.php?contact_uuid=\".escape($row['contact_uuid']).\"&id=\".escape($row['contact_time_uuid']).\"'\" : null;\n\t\t\techo \"<tr \".$tr_link.\">\\n\";\n\t\t\tif ($row[\"time_start\"] != '' && $row['time_stop'] != '') {\n\t\t\t\t$time_start = strtotime($row[\"time_start\"]);\n\t\t\t\t$time_stop = strtotime($row['time_stop']);\n\t\t\t\t$time = gmdate(\"H:i:s\", ($time_stop - $time_start));\n\t\t\t}\n\t\t\telse { unset($time); }\n\t\t\t$tmp = explode(' ', $row['time_start']);\n\t\t\t$time_start = $tmp[0];\n\t\t\techo \"\t<td valign='top' class='\".$row_style[$c].\"' width='20%'><span \".(($row['user_domain_uuid'] != $domain_uuid) ? \"title='\".$_SESSION['domains'][escape($row['user_domain_uuid'])]['domain_name'].\"' style='cursor: help;'\" : null).\">\".escape($row[\"username\"]).\"</span>&nbsp;</td>\\n\";\n\t\t\techo \"\t<td valign='top' class='\".$row_style[$c].\"' width='20%'>\".$time_start.\"&nbsp;</td>\\n\";\n\t\t\techo \"\t<td valign='top' class='\".$row_style[$c].\"' width='20%'>\".$time.\"&nbsp;</td>\\n\";\n\t\t\techo \"\t<td valign='top' class='row_stylebg' style='width: 40%; max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;'>\".escape($row['time_description']).\"&nbsp;</td>\\n\";\n\t\t\techo \"\t<td class='list_control_icons' nowrap>\";\n\t\t\tif (permission_exists('contact_time_edit')) {\n\t\t\t\tif ($row['user_uuid'] == $_SESSION[\"user\"][\"user_uuid\"]) {\n\t\t\t\t\techo \"<a href='contact_time_edit.php?contact_uuid=\".escape($row['contact_uuid']).\"&id=\".escape($row['contact_time_uuid']).\"' alt='\".$text['button-edit'].\"'>\".$v_link_label_edit.\"</a>\";\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\techo \"<span onclick=\\\"alert('\".$text['message-access_denied'].\"');\\\" alt='\".$text['button-edit'].\"'>\".str_replace(\"list_control_icon\", \"list_control_icon_disabled\", $v_link_label_edit).\"</span>\";\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (permission_exists('contact_time_delete')) {\n\t\t\t\tif ($row['user_uuid'] == $_SESSION[\"user\"][\"user_uuid\"]) {\n\t\t\t\t\techo \"<a href='contact_time_delete.php?contact_uuid=\".escape($row['contact_uuid']).\"&id=\".escape($row['contact_time_uuid']).\"' alt='\".$text['button-delete'].\"' onclick=\\\"return confirm('\".$text['confirm-delete'].\"')\\\">\".$v_link_label_delete.\"</a>\";\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\techo \"<span onclick=\\\"alert('\".$text['message-access_denied'].\"');\\\" alt='\".$text['button-delete'].\"'>\".str_replace(\"list_control_icon\", \"list_control_icon_disabled\", $v_link_label_delete).\"</span>\";\n\t\t\t\t}\n\t\t\t}\n\t\t\techo \"\t</td>\\n\";\n\t\t\techo \"</tr>\\n\";\n\t\t\t$c = $c ? 0 : 1;\n\t\t} //end foreach\n\t\tunset($result, $row);\n\t} //end if results\n\techo \"</table>\";\n\techo \"</div>\\n\";\n\n\techo \"<script>\";\n\techo \"\tvar div_times = document.getElementById('div_contact_times');\";\n\techo \"\tvar table_times = document.getElementById('table_contact_times');\";\n\techo \"\tvar th_filler = document.getElementById('th_filler');\";\n\n\techo \"\tif (div_times.offsetHeight > 200) { \";\n\techo \"\t\tdiv_times.style.height = 200; \";\n\techo \"\t}\";\n\techo \"\telse {\";\n\techo \"\t\tdiv_times.style.height = div_times.scrollHeight + 1; \";\n\techo \"\t}\";\n\n\techo \"\tif (div_times.scrollHeight > div_times.clientHeight) {\";\n\techo \"\t\tth_filler.style.display = ''; \";\n\techo \"\t\ttable_times.style.paddingLeft = 1;\";\n\techo \"\t}\";\n\techo \"\telse {\";\n\techo \"\t\tth_filler.style.display = 'none'; \";\n\techo \"\t\ttable_times.style.paddingLeft = 0;\";\n\techo \"\t}\";\n\techo \"</script>\\n\";\n\n?>\n"], "filenames": ["app/contacts/contact_times.php"], "buggy_code_start_loc": [40], "buggy_code_end_loc": [78], "fixing_code_start_loc": [41], "fixing_code_end_loc": [83], "type": "CWE-79", "message": "In FusionPBX up to 4.5.7, the file app\\contacts\\contact_times.php uses an unsanitized \"id\" variable coming from the URL, which is reflected in HTML, leading to XSS.", "other": {"cve": {"id": "CVE-2019-16974", "sourceIdentifier": "cve@mitre.org", "published": "2019-10-21T21:15:10.703", "lastModified": "2023-02-03T21:51:26.693", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "In FusionPBX up to 4.5.7, the file app\\contacts\\contact_times.php uses an unsanitized \"id\" variable coming from the URL, which is reflected in HTML, leading to XSS."}, {"lang": "es", "value": "En FusionPBX versiones hasta 4.5.7, el archivo app\\contacts\\contact_times.php utiliza una variable \"id\" no saneada que proviene de la URL, que es reflejada en HTML, conllevando a una vulnerabilidad de tipo XSS."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:fusionpbx:fusionpbx:*:*:*:*:*:*:*:*", "versionEndIncluding": "4.5.7", "matchCriteriaId": "A5A0C1F9-8032-46C6-8DD4-DB91FACF7330"}]}]}], "references": [{"url": "https://github.com/fusionpbx/fusionpbx/commit/bcc75d63aa5b721f699a2b416425943ad7707825", "source": "cve@mitre.org", "tags": ["Patch"]}, {"url": "https://resp3ctblog.wordpress.com/2019/10/19/fusionpbx-xss-7/", "source": "cve@mitre.org", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/fusionpbx/fusionpbx/commit/bcc75d63aa5b721f699a2b416425943ad7707825"}}