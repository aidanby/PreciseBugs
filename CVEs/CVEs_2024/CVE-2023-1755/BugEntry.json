{"buggy_code": ["<?php\n\n/**\n * The main configuration frontend.\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @package phpMyFAQ\n * @author Thorsten Rinne <thorsten@phpmyfaq.de>\n * @author Matteo Scaramuccia <matteo@scaramuccia.com>\n * @copyright 2005-2022 phpMyFAQ Team\n * @license http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n * @link https://www.phpmyfaq.de\n * @since 2005-12-26\n */\n\nuse phpMyFAQ\\Filter;\nuse phpMyFAQ\\Strings;\n\nif (!defined('IS_VALID_PHPMYFAQ')) {\n    http_response_code(400);\n    exit();\n}\n\nif ($user->perm->hasPermission($user->getUserId(), 'editconfig')) {\n    // actions defined by url: user_action=\n    $userAction = Filter::filterInput(INPUT_GET, 'config_action', FILTER_UNSAFE_RAW, 'listConfig');\n    $csrfToken = Filter::filterInput(INPUT_POST, 'csrf', FILTER_UNSAFE_RAW);\n    $currentToken = $user->getCsrfTokenFromSession();\n\n    // Save the configuration\n    if ('saveConfig' === $userAction && $currentToken === $csrfToken) {\n        $checks = [\n            'filter' => FILTER_UNSAFE_RAW,\n            'flags' => FILTER_REQUIRE_ARRAY,\n        ];\n        $editData = Filter::filterInputArray(INPUT_POST, ['edit' => $checks]);\n        $userAction = 'listConfig';\n        $oldConfigValues = $faqConfig->config;\n\n        // Set the new values\n        $forbiddenValues = ['{', '}', '$'];\n        $newConfigValues = [];\n        $escapeValues = [\n            'main.contactInformations',\n            'main.customPdfHeader',\n            'main.customPdfFooter',\n            'main.titleFAQ',\n            'main.metaKeywords'\n        ];\n\n        // Special checks\n        if (isset($editData['edit']['main.enableMarkdownEditor'])) {\n            $editData['edit']['main.enableWysiwygEditor'] = false; // Disable WYSIWG editor if Markdown is enabled\n        }\n\n        foreach ($editData['edit'] as $key => $value) {\n            // Remove forbidden characters\n            $newConfigValues[$key] = str_replace($forbiddenValues, '', $value);\n            // Escape some values\n            if (isset($escapeValues[$key])) {\n                $newConfigValues[$key] = Strings::htmlspecialchars($value, ENT_QUOTES);\n            }\n            $keyArray = array_values(explode('.', $key));\n            $newConfigClass = array_shift($keyArray);\n        }\n\n        foreach ($oldConfigValues as $key => $value) {\n            $keyArray = array_values(explode('.', $key));\n            $oldConfigClass = array_shift($keyArray);\n            if (isset($newConfigValues[$key])) {\n                continue;\n            } else {\n                if ($oldConfigClass === $newConfigClass && $oldConfigValues[$key] === 'true') {\n                    $newConfigValues[$key] = 'false';\n                } else {\n                    $newConfigValues[$key] = $oldConfigValues[$key];\n                }\n            }\n        }\n\n        if (!is_null($editData)) {\n            $faqConfig->update($newConfigValues);\n        }\n\n        $faqConfig->getAll();\n    }\n    ?>\n  <form id=\"config_list\" name=\"config_list\" method=\"post\"\n        action=\"?action=config&amp;config_action=saveConfig\">\n    <input type=\"hidden\" name=\"csrf\" value=\"<?= $currentToken ?>\">\n\n    <div\n      class=\"d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom\">\n      <h1 class=\"h2\">\n        <i aria-hidden=\"true\" class=\"fa fa-wrench\"></i>\n          <?= $PMF_LANG['ad_config_edit'] ?>\n      </h1>\n      <div class=\"btn-toolbar mb-2 mb-md-0\">\n        <div class=\"btn-group mr-2\">\n          <button class=\"btn btn-sm btn-warning\" type=\"reset\">\n              <?= $PMF_LANG['ad_config_reset'] ?>\n          </button>\n          <button class=\"btn btn-sm btn-success\" type=\"submit\">\n              <?= $PMF_LANG['ad_config_save'] ?>\n          </button>\n        </div>\n      </div>\n    </div>\n\n    <div class=\"row\">\n      <div class=\"col-lg-12\">\n\n        <ul class=\"nav nav-tabs\" role=\"tablist\">\n          <li role=\"presentation\" class=\"nav-item\">\n            <a href=\"#main\" aria-controls=\"main\" role=\"tab\" data-toggle=\"tab\" class=\"nav-link active\">\n              <i aria-hidden=\"true\" class=\"fa fa-home\"></i>\n                <?= $PMF_LANG['mainControlCenter'] ?>\n            </a>\n          </li>\n          <li role=\"presentation\" class=\"nav-item\">\n            <a href=\"#records\" aria-controls=\"records\" role=\"tab\" data-toggle=\"tab\" class=\"nav-link\">\n              <i aria-hidden=\"true\" class=\"fa fa-th-list\"></i>\n                <?= $PMF_LANG['recordsControlCenter'] ?>\n            </a>\n          </li>\n          <li role=\"presentation\" class=\"nav-item\">\n            <a href=\"#search\" aria-controls=\"search\" role=\"tab\" data-toggle=\"tab\" class=\"nav-link\">\n              <i aria-hidden=\"true\" class=\"fa fa-search\"></i>\n                <?= $PMF_LANG['searchControlCenter'] ?>\n            </a>\n          </li>\n          <li role=\"presentation\" class=\"nav-item\">\n            <a href=\"#security\" aria-controls=\"security\" role=\"tab\" data-toggle=\"tab\" class=\"nav-link\">\n              <i aria-hidden=\"true\" class=\"fa fa-warning\"></i>\n                <?= $PMF_LANG['securityControlCenter'] ?>\n            </a>\n          </li>\n          <li role=\"presentation\" class=\"nav-item\">\n            <a href=\"#spam\" aria-controls=\"spam\" role=\"tab\" data-toggle=\"tab\" class=\"nav-link\">\n              <i aria-hidden=\"true\" class=\"fa fa-thumbs-down\"></i>\n                <?= $PMF_LANG['spamControlCenter'] ?>\n            </a>\n          </li>\n          <li role=\"presentation\" class=\"nav-item\">\n            <a href=\"#seo\" aria-controls=\"seo\" role=\"tab\" data-toggle=\"tab\" class=\"nav-link\">\n              <i aria-hidden=\"true\" class=\"fa fa-search\"></i>\n                <?= $PMF_LANG['seoCenter'] ?>\n            </a>\n          </li>\n          <li role=\"presentation\" class=\"nav-item\">\n            <a href=\"#social\" aria-controls=\"social\" role=\"tab\" data-toggle=\"tab\" class=\"nav-link\">\n              <i aria-hidden=\"true\" class=\"fa fa-retweet\"></i>\n                <?= $PMF_LANG['socialNetworksControlCenter'] ?>\n            </a>\n          </li>\n          <li role=\"presentation\" class=\"nav-item\">\n            <a href=\"#mail\" aria-controls=\"mail\" role=\"tab\" data-toggle=\"tab\" class=\"nav-link\">\n              <i aria-hidden=\"true\" class=\"fa fa-inbox\"></i>\n                <?= $PMF_LANG['mailControlCenter'] ?>\n            </a>\n          </li>\n          <li role=\"presentation\" class=\"nav-item\">\n            <a href=\"#ldap\" aria-controls=\"ldap\" role=\"tab\" data-toggle=\"tab\" class=\"nav-link\">\n              <i aria-hidden=\"true\" class=\"fa fa-sitemap\"></i>\n                <?= 'LDAP' ?>\n            </a>\n          </li>\n          <li role=\"presentation\" class=\"nav-item\">\n            <a href=\"#api\" aria-controls=\"ldap\" role=\"tab\" data-toggle=\"tab\" class=\"nav-link\">\n              <i aria-hidden=\"true\" class=\"fa fa-gears\"></i>\n                <?= 'API' ?>\n            </a>\n          </li>\n        </ul>\n\n        <div class=\"tab-content p-2 pt-4 pmf-configuration-panel\">\n          <div role=\"tabpanel\" class=\"tab-pane fade show active\" id=\"main\"></div>\n          <div role=\"tabpanel\" class=\"tab-pane fade\" id=\"records\"></div>\n          <div role=\"tabpanel\" class=\"tab-pane fade\" id=\"search\"></div>\n          <div role=\"tabpanel\" class=\"tab-pane fade\" id=\"security\"></div>\n          <div role=\"tabpanel\" class=\"tab-pane fade\" id=\"spam\"></div>\n          <div role=\"tabpanel\" class=\"tab-pane fade\" id=\"seo\"></div>\n          <div role=\"tabpanel\" class=\"tab-pane fade\" id=\"social\"></div>\n          <div role=\"tabpanel\" class=\"tab-pane fade\" id=\"mail\"></div>\n          <div role=\"tabpanel\" class=\"tab-pane fade\" id=\"ldap\"></div>\n          <div role=\"tabpanel\" class=\"tab-pane fade\" id=\"api\"></div>\n        </div>\n      </div>\n    </div>\n\n  </form>\n\n  <script src=\"assets/js/configuration.js\"></script>\n    <?php\n} else {\n    echo $PMF_LANG['err_NotAuth'];\n}\n"], "fixing_code": ["<?php\n\n/**\n * The main configuration frontend.\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @package phpMyFAQ\n * @author Thorsten Rinne <thorsten@phpmyfaq.de>\n * @author Matteo Scaramuccia <matteo@scaramuccia.com>\n * @copyright 2005-2022 phpMyFAQ Team\n * @license http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n * @link https://www.phpmyfaq.de\n * @since 2005-12-26\n */\n\nuse phpMyFAQ\\Filter;\nuse phpMyFAQ\\Strings;\n\nif (!defined('IS_VALID_PHPMYFAQ')) {\n    http_response_code(400);\n    exit();\n}\n\nif ($user->perm->hasPermission($user->getUserId(), 'editconfig')) {\n    // actions defined by url: user_action=\n    $userAction = Filter::filterInput(INPUT_GET, 'config_action', FILTER_UNSAFE_RAW, 'listConfig');\n    $csrfToken = Filter::filterInput(INPUT_POST, 'csrf', FILTER_UNSAFE_RAW);\n    $currentToken = $user->getCsrfTokenFromSession();\n\n    // Save the configuration\n    if ('saveConfig' === $userAction && $currentToken === $csrfToken) {\n        $checks = [\n            'filter' => FILTER_UNSAFE_RAW,\n            'flags' => FILTER_REQUIRE_ARRAY,\n        ];\n        $editData = Filter::filterInputArray(INPUT_POST, ['edit' => $checks]);\n        $userAction = 'listConfig';\n        $oldConfigValues = $faqConfig->config;\n\n        // Set the new values\n        $forbiddenValues = ['{', '}', '$'];\n        $newConfigValues = [];\n        $escapeValues = [\n            'main.contactInformations',\n            'main.customPdfHeader',\n            'main.customPdfFooter',\n            'main.titleFAQ',\n            'main.metaKeywords'\n        ];\n\n        // Special checks\n        if (isset($editData['edit']['main.enableMarkdownEditor'])) {\n            $editData['edit']['main.enableWysiwygEditor'] = false; // Disable WYSIWYG editor if Markdown is enabled\n        }\n        if (isset($editData['edit']['main.currentVersion'])) {\n            unset($editData['edit']['main.currentVersion']); // don't update the version number\n        }\n\n        foreach ($editData['edit'] as $key => $value) {\n            // Remove forbidden characters\n            $newConfigValues[$key] = str_replace($forbiddenValues, '', $value);\n            // Escape some values\n            if (isset($escapeValues[$key])) {\n                $newConfigValues[$key] = Strings::htmlspecialchars($value, ENT_QUOTES);\n            }\n            $keyArray = array_values(explode('.', $key));\n            $newConfigClass = array_shift($keyArray);\n        }\n\n        foreach ($oldConfigValues as $key => $value) {\n            $keyArray = array_values(explode('.', $key));\n            $oldConfigClass = array_shift($keyArray);\n            if (isset($newConfigValues[$key])) {\n                continue;\n            } else {\n                if ($oldConfigClass === $newConfigClass && $oldConfigValues[$key] === 'true') {\n                    $newConfigValues[$key] = 'false';\n                } else {\n                    $newConfigValues[$key] = $oldConfigValues[$key];\n                }\n            }\n        }\n\n        if (!is_null($editData)) {\n            $faqConfig->update($newConfigValues);\n        }\n\n        $faqConfig->getAll();\n    }\n    ?>\n  <form id=\"config_list\" name=\"config_list\" method=\"post\"\n        action=\"?action=config&amp;config_action=saveConfig\">\n    <input type=\"hidden\" name=\"csrf\" value=\"<?= $currentToken ?>\">\n\n    <div\n      class=\"d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom\">\n      <h1 class=\"h2\">\n        <i aria-hidden=\"true\" class=\"fa fa-wrench\"></i>\n          <?= $PMF_LANG['ad_config_edit'] ?>\n      </h1>\n      <div class=\"btn-toolbar mb-2 mb-md-0\">\n        <div class=\"btn-group mr-2\">\n          <button class=\"btn btn-sm btn-warning\" type=\"reset\">\n              <?= $PMF_LANG['ad_config_reset'] ?>\n          </button>\n          <button class=\"btn btn-sm btn-success\" type=\"submit\">\n              <?= $PMF_LANG['ad_config_save'] ?>\n          </button>\n        </div>\n      </div>\n    </div>\n\n    <div class=\"row\">\n      <div class=\"col-lg-12\">\n\n        <ul class=\"nav nav-tabs\" role=\"tablist\">\n          <li role=\"presentation\" class=\"nav-item\">\n            <a href=\"#main\" aria-controls=\"main\" role=\"tab\" data-toggle=\"tab\" class=\"nav-link active\">\n              <i aria-hidden=\"true\" class=\"fa fa-home\"></i>\n                <?= $PMF_LANG['mainControlCenter'] ?>\n            </a>\n          </li>\n          <li role=\"presentation\" class=\"nav-item\">\n            <a href=\"#records\" aria-controls=\"records\" role=\"tab\" data-toggle=\"tab\" class=\"nav-link\">\n              <i aria-hidden=\"true\" class=\"fa fa-th-list\"></i>\n                <?= $PMF_LANG['recordsControlCenter'] ?>\n            </a>\n          </li>\n          <li role=\"presentation\" class=\"nav-item\">\n            <a href=\"#search\" aria-controls=\"search\" role=\"tab\" data-toggle=\"tab\" class=\"nav-link\">\n              <i aria-hidden=\"true\" class=\"fa fa-search\"></i>\n                <?= $PMF_LANG['searchControlCenter'] ?>\n            </a>\n          </li>\n          <li role=\"presentation\" class=\"nav-item\">\n            <a href=\"#security\" aria-controls=\"security\" role=\"tab\" data-toggle=\"tab\" class=\"nav-link\">\n              <i aria-hidden=\"true\" class=\"fa fa-warning\"></i>\n                <?= $PMF_LANG['securityControlCenter'] ?>\n            </a>\n          </li>\n          <li role=\"presentation\" class=\"nav-item\">\n            <a href=\"#spam\" aria-controls=\"spam\" role=\"tab\" data-toggle=\"tab\" class=\"nav-link\">\n              <i aria-hidden=\"true\" class=\"fa fa-thumbs-down\"></i>\n                <?= $PMF_LANG['spamControlCenter'] ?>\n            </a>\n          </li>\n          <li role=\"presentation\" class=\"nav-item\">\n            <a href=\"#seo\" aria-controls=\"seo\" role=\"tab\" data-toggle=\"tab\" class=\"nav-link\">\n              <i aria-hidden=\"true\" class=\"fa fa-search\"></i>\n                <?= $PMF_LANG['seoCenter'] ?>\n            </a>\n          </li>\n          <li role=\"presentation\" class=\"nav-item\">\n            <a href=\"#social\" aria-controls=\"social\" role=\"tab\" data-toggle=\"tab\" class=\"nav-link\">\n              <i aria-hidden=\"true\" class=\"fa fa-retweet\"></i>\n                <?= $PMF_LANG['socialNetworksControlCenter'] ?>\n            </a>\n          </li>\n          <li role=\"presentation\" class=\"nav-item\">\n            <a href=\"#mail\" aria-controls=\"mail\" role=\"tab\" data-toggle=\"tab\" class=\"nav-link\">\n              <i aria-hidden=\"true\" class=\"fa fa-inbox\"></i>\n                <?= $PMF_LANG['mailControlCenter'] ?>\n            </a>\n          </li>\n          <li role=\"presentation\" class=\"nav-item\">\n            <a href=\"#ldap\" aria-controls=\"ldap\" role=\"tab\" data-toggle=\"tab\" class=\"nav-link\">\n              <i aria-hidden=\"true\" class=\"fa fa-sitemap\"></i>\n                <?= 'LDAP' ?>\n            </a>\n          </li>\n          <li role=\"presentation\" class=\"nav-item\">\n            <a href=\"#api\" aria-controls=\"ldap\" role=\"tab\" data-toggle=\"tab\" class=\"nav-link\">\n              <i aria-hidden=\"true\" class=\"fa fa-gears\"></i>\n                <?= 'API' ?>\n            </a>\n          </li>\n        </ul>\n\n        <div class=\"tab-content p-2 pt-4 pmf-configuration-panel\">\n          <div role=\"tabpanel\" class=\"tab-pane fade show active\" id=\"main\"></div>\n          <div role=\"tabpanel\" class=\"tab-pane fade\" id=\"records\"></div>\n          <div role=\"tabpanel\" class=\"tab-pane fade\" id=\"search\"></div>\n          <div role=\"tabpanel\" class=\"tab-pane fade\" id=\"security\"></div>\n          <div role=\"tabpanel\" class=\"tab-pane fade\" id=\"spam\"></div>\n          <div role=\"tabpanel\" class=\"tab-pane fade\" id=\"seo\"></div>\n          <div role=\"tabpanel\" class=\"tab-pane fade\" id=\"social\"></div>\n          <div role=\"tabpanel\" class=\"tab-pane fade\" id=\"mail\"></div>\n          <div role=\"tabpanel\" class=\"tab-pane fade\" id=\"ldap\"></div>\n          <div role=\"tabpanel\" class=\"tab-pane fade\" id=\"api\"></div>\n        </div>\n      </div>\n    </div>\n\n  </form>\n\n  <script src=\"assets/js/configuration.js\"></script>\n    <?php\n} else {\n    echo $PMF_LANG['err_NotAuth'];\n}\n"], "filenames": ["phpmyfaq/admin/configuration.php"], "buggy_code_start_loc": [55], "buggy_code_end_loc": [56], "fixing_code_start_loc": [55], "fixing_code_end_loc": [59], "type": "CWE-79", "message": "Cross-site Scripting (XSS) - Generic in GitHub repository thorsten/phpmyfaq prior to 3.1.12.", "other": {"cve": {"id": "CVE-2023-1755", "sourceIdentifier": "security@huntr.dev", "published": "2023-03-31T01:15:09.330", "lastModified": "2023-04-06T17:30:55.977", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Cross-site Scripting (XSS) - Generic in GitHub repository thorsten/phpmyfaq prior to 3.1.12."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 5.4, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.3, "impactScore": 2.7}], "cvssMetricV30": [{"source": "security@huntr.dev", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:H/UI:R/S:C/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "HIGH", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 8.4, "baseSeverity": "HIGH"}, "exploitabilityScore": 1.7, "impactScore": 6.0}]}, "weaknesses": [{"source": "security@huntr.dev", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:phpmyfaq:phpmyfaq:*:*:*:*:*:*:*:*", "versionEndExcluding": "3.1.12", "matchCriteriaId": "653EC167-06FC-4D30-AAF8-B75F596519AE"}]}]}], "references": [{"url": "https://github.com/thorsten/phpmyfaq/commit/2156573100fd3abf4c65270def77aed20ffc8994", "source": "security@huntr.dev", "tags": ["Patch"]}, {"url": "https://huntr.dev/bounties/882ffa07-5397-4dbb-886f-4626859d711a", "source": "security@huntr.dev", "tags": ["Exploit", "Patch"]}]}, "github_commit_url": "https://github.com/thorsten/phpmyfaq/commit/2156573100fd3abf4c65270def77aed20ffc8994"}}