{"buggy_code": ["<?php\n//\n// ZoneMinder web zones view file, $Date$, $Revision$\n// Copyright (C) 2001-2008 Philip Coombes\n//\n// This program is free software; you can redistribute it and/or\n// modify it under the terms of the GNU General Public License\n// as published by the Free Software Foundation; either version 2\n// of the License, or (at your option) any later version.\n//\n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with this program; if not, write to the Free Software\n// Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.\n//\n\nif ( !canView( 'Monitors' ) ) {\n  $view = 'error';\n  return;\n}\n\n$mid = validInt($_REQUEST['mid']);\n$monitor = new Monitor( $mid );\n# Width() and Height() are already rotated\n$minX = 0;\n$maxX = $monitor->Width()-1;\n$minY = 0;\n$maxY = $monitor->Height()-1;\n\n$zones = array();\nforeach( dbFetchAll( 'SELECT * FROM Zones WHERE MonitorId=? ORDER BY Area DESC', NULL, array($mid) ) as $row ) {\n  $row['Points'] = coordsToPoints( $row['Coords'] );\n\n  limitPoints( $row['Points'], $minX, $minY, $maxX, $maxY );\n  $row['Coords'] = pointsToCoords( $row['Points'] );\n  $row['AreaCoords'] = preg_replace( '/\\s+/', ',', $row['Coords'] );\n  $zones[] = $row;\n}\n\n$connkey = generateConnKey();\n\nxhtmlHeaders(__FILE__, translate('Zones') );\n?>\n<body>\n  <div id=\"page\">\n    <div id=\"header\">\n      <div id=\"headerButtons\"><a href=\"#\" data-on-click=\"closeWindow\"><?php echo translate('Close') ?></a></div>\n      <h2><?php echo translate('Zones') ?></h2>\n    </div>\n    <div id=\"content\" style=\"width:<?php echo $monitor->Width() ?>px; height:<?php echo $monitor->Height() ?>px; position:relative; margin: 0 auto;\">\n      <form name=\"contentForm\" id=\"contentForm\" method=\"get\" action=\"<?php echo $_SERVER['PHP_SELF'] ?>\">\n        <input type=\"hidden\" name=\"view\" value=\"<?php echo $view ?>\"/>\n        <input type=\"hidden\" name=\"action\" value=\"delete\"/>\n        <input type=\"hidden\" name=\"mid\" value=\"<?php echo $mid ?>\"/>\n        <div id=\"contentButtons\">\n          <?php echo makePopupButton('?view=zone&mid=' . $mid . '&zid=0', 'zmZone', array('zone', $monitor->Width(), $monitor->Height()), translate('AddNewZone'), canEdit('Monitors')); ?>\n          <input type=\"submit\" name=\"deleteBtn\" value=\"<?php echo translate('Delete') ?>\" disabled=\"disabled\"/>\n        </div>\n        <table id=\"contentTable\" class=\"major\" cellspacing=\"0\">\n          <thead>\n            <tr>\n              <th class=\"colName\"><?php echo translate('Name') ?></th>\n              <th class=\"colType\"><?php echo translate('Type') ?></th>\n              <th class=\"colUnits\"><?php echo translate('AreaUnits') ?></th>\n              <th class=\"colMark\"><?php echo translate('Mark') ?></th>\n            </tr>\n          </thead>\n          <tbody>\n<?php\nforeach( $zones as $zone ) {\n?>\n            <tr>\n              <td class=\"colName\"><?php echo makePopupLink('?view=zone&mid=' . $mid . '&zid=' . $zone['Id'], 'zmZone', array('zone', $monitor->Width(), $monitor->Height()), $zone['Name'], true, 'onclick=\"streamCmdQuit( true ); return( false );\"'); ?></td>\n              <td class=\"colType\"><?php echo $zone['Type'] ?></td>\n              <td class=\"colUnits\"><?php echo $zone['Area'] ?>&nbsp;/&nbsp;<?php echo sprintf( \"%.2f\", ($zone['Area']*100)/($monitor->Width()*$monitor->Height()) ) ?></td>\n              <td class=\"colMark\"><input type=\"checkbox\" name=\"markZids[]\" value=\"<?php echo $zone['Id'] ?>\" data-on-click-this=\"configureDeleteButton\"<?php if ( !canEdit( 'Monitors' ) ) { ?> disabled=\"disabled\"<?php } ?>/></td>\n            </tr>\n<?php\n}\n?>\n          </tbody>\n        </table>\n        <div class=\"ZonesImage\" style=\"position:relative; clear:both;\">\n        <?php echo getStreamHTML( $monitor ); ?>\n        <svg class=\"zones\" width=\"<?php echo $monitor->Width() ?>\" height=\"<?php echo $monitor->Height() ?>\" style=\"position:absolute; top: 0; left: 0; background: none;\">\n<?php\n      foreach( array_reverse($zones) as $zone ) {\n?>\n          <polygon points=\"<?php echo $zone['AreaCoords'] ?>\" class=\"popup-link <?php echo $zone['Type']?>\" onclick=\"streamCmdQuit( true ); return( false );\"\n                   data-url=\"?view=zone&amp;mid=<?php echo $mid ?>&amp;zid=<?php echo $zone['Id'] ?>\"\n                   data-window-name=\"zmZone\"\n                   data-window-tag=\"zone\"\n                   data-window-width=\"<?php echo $monitor->Width ?>\"\n                   data-window-height=\"<?php echo $monitor->Height ?>\"/>\n<?php\n      } // end foreach zone\n?>\n          Sorry, your browser does not support inline SVG\n        </svg>\n        </div>\n      </form>\n    </div>\n  </div>\n</body>\n</html>\n"], "fixing_code": ["<?php\n//\n// ZoneMinder web zones view file, $Date$, $Revision$\n// Copyright (C) 2001-2008 Philip Coombes\n//\n// This program is free software; you can redistribute it and/or\n// modify it under the terms of the GNU General Public License\n// as published by the Free Software Foundation; either version 2\n// of the License, or (at your option) any later version.\n//\n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with this program; if not, write to the Free Software\n// Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.\n//\n\nif ( !canView( 'Monitors' ) ) {\n  $view = 'error';\n  return;\n}\n\n$mid = validInt($_REQUEST['mid']);\n$monitor = new Monitor( $mid );\n# Width() and Height() are already rotated\n$minX = 0;\n$maxX = $monitor->Width()-1;\n$minY = 0;\n$maxY = $monitor->Height()-1;\n\n$zones = array();\nforeach( dbFetchAll( 'SELECT * FROM Zones WHERE MonitorId=? ORDER BY Area DESC', NULL, array($mid) ) as $row ) {\n  $row['Points'] = coordsToPoints( $row['Coords'] );\n\n  limitPoints( $row['Points'], $minX, $minY, $maxX, $maxY );\n  $row['Coords'] = pointsToCoords( $row['Points'] );\n  $row['AreaCoords'] = preg_replace( '/\\s+/', ',', $row['Coords'] );\n  $zones[] = $row;\n}\n\n$connkey = generateConnKey();\n\nxhtmlHeaders(__FILE__, translate('Zones') );\n?>\n<body>\n  <div id=\"page\">\n    <div id=\"header\">\n      <div id=\"headerButtons\"><a href=\"#\" data-on-click=\"closeWindow\"><?php echo translate('Close') ?></a></div>\n      <h2><?php echo translate('Zones') ?></h2>\n    </div>\n    <div id=\"content\" style=\"width:<?php echo $monitor->Width() ?>px; height:<?php echo $monitor->Height() ?>px; position:relative; margin: 0 auto;\">\n      <form name=\"contentForm\" id=\"contentForm\" method=\"get\" action=\"<?php echo $_SERVER['PHP_SELF'] ?>\">\n        <input type=\"hidden\" name=\"view\" value=\"<?php echo $view ?>\"/>\n        <input type=\"hidden\" name=\"action\" value=\"delete\"/>\n        <input type=\"hidden\" name=\"mid\" value=\"<?php echo $mid ?>\"/>\n        <div id=\"contentButtons\">\n          <?php echo makePopupButton('?view=zone&mid=' . $mid . '&zid=0', 'zmZone', array('zone', $monitor->Width(), $monitor->Height()), translate('AddNewZone'), canEdit('Monitors')); ?>\n          <input type=\"submit\" name=\"deleteBtn\" value=\"<?php echo translate('Delete') ?>\" disabled=\"disabled\"/>\n        </div>\n        <table id=\"contentTable\" class=\"major\" cellspacing=\"0\">\n          <thead>\n            <tr>\n              <th class=\"colName\"><?php echo translate('Name') ?></th>\n              <th class=\"colType\"><?php echo translate('Type') ?></th>\n              <th class=\"colUnits\"><?php echo translate('AreaUnits') ?></th>\n              <th class=\"colMark\"><?php echo translate('Mark') ?></th>\n            </tr>\n          </thead>\n          <tbody>\n<?php\nforeach( $zones as $zone ) {\n?>\n            <tr>\n              <td class=\"colName\"><?php echo makePopupLink('?view=zone&mid=' . $mid . '&zid=' . $zone['Id'], 'zmZone', array('zone', $monitor->Width(), $monitor->Height()), validHtmlStr($zone['Name']), true, 'onclick=\"streamCmdQuit( true ); return( false );\"'); ?></td>\n              <td class=\"colType\"><?php echo validHtmlStr($zone['Type']) ?></td>\n              <td class=\"colUnits\"><?php echo $zone['Area'] ?>&nbsp;/&nbsp;<?php echo sprintf( \"%.2f\", ($zone['Area']*100)/($monitor->Width()*$monitor->Height()) ) ?></td>\n              <td class=\"colMark\"><input type=\"checkbox\" name=\"markZids[]\" value=\"<?php echo $zone['Id'] ?>\" data-on-click-this=\"configureDeleteButton\"<?php if ( !canEdit( 'Monitors' ) ) { ?> disabled=\"disabled\"<?php } ?>/></td>\n            </tr>\n<?php\n}\n?>\n          </tbody>\n        </table>\n        <div class=\"ZonesImage\" style=\"position:relative; clear:both;\">\n        <?php echo getStreamHTML( $monitor ); ?>\n        <svg class=\"zones\" width=\"<?php echo $monitor->Width() ?>\" height=\"<?php echo $monitor->Height() ?>\" style=\"position:absolute; top: 0; left: 0; background: none;\">\n<?php\n      foreach( array_reverse($zones) as $zone ) {\n?>\n          <polygon points=\"<?php echo $zone['AreaCoords'] ?>\" class=\"popup-link <?php echo $zone['Type']?>\" onclick=\"streamCmdQuit( true ); return( false );\"\n                   data-url=\"?view=zone&amp;mid=<?php echo $mid ?>&amp;zid=<?php echo $zone['Id'] ?>\"\n                   data-window-name=\"zmZone\"\n                   data-window-tag=\"zone\"\n                   data-window-width=\"<?php echo $monitor->Width ?>\"\n                   data-window-height=\"<?php echo $monitor->Height ?>\"/>\n<?php\n      } // end foreach zone\n?>\n          Sorry, your browser does not support inline SVG\n        </svg>\n        </div>\n      </form>\n    </div>\n  </div>\n</body>\n</html>\n"], "filenames": ["web/skins/classic/views/zones.php"], "buggy_code_start_loc": [77], "buggy_code_end_loc": [79], "fixing_code_start_loc": [77], "fixing_code_end_loc": [79], "type": "CWE-79", "message": "A stored-self XSS exists in web/skins/classic/views/zones.php of ZoneMinder through 1.32.3, allowing an attacker to execute HTML or JavaScript code in a vulnerable field via a crafted Zone NAME to the index.php?view=zones&action=zoneImage&mid=1 URI.", "other": {"cve": {"id": "CVE-2019-6990", "sourceIdentifier": "cve@mitre.org", "published": "2019-01-28T20:29:00.310", "lastModified": "2019-01-29T16:04:22.797", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "A stored-self XSS exists in web/skins/classic/views/zones.php of ZoneMinder through 1.32.3, allowing an attacker to execute HTML or JavaScript code in a vulnerable field via a crafted Zone NAME to the index.php?view=zones&action=zoneImage&mid=1 URI."}, {"lang": "es", "value": "Existe Cross-Site Scripting (XSS) persistente en web/skins/classic/views/zones.php en ZoneMinder, hasta la versi\u00f3n 1.32.3, lo que permite a los atacantes ejecutar c\u00f3digo HTML o JavaScript en un campo vulnerable mediante un NAME de zona manipulado en el URI index.php?view=zonesaction=zoneImagemid=1."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 5.4, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.3, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:S/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "SINGLE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 3.5}, "baseSeverity": "LOW", "exploitabilityScore": 6.8, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:zoneminder:zoneminder:*:*:*:*:*:*:*:*", "versionEndIncluding": "1.32.3", "matchCriteriaId": "8045339C-B032-47D7-BEAE-90BCC6699C06"}]}]}], "references": [{"url": "https://github.com/ZoneMinder/zoneminder/commit/a3e8fd4fd5b579865f35aac3b964bc78d5b7a94a", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/ZoneMinder/zoneminder/issues/2444", "source": "cve@mitre.org", "tags": ["Exploit", "Issue Tracking", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/ZoneMinder/zoneminder/commit/a3e8fd4fd5b579865f35aac3b964bc78d5b7a94a"}}