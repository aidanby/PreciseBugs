{"buggy_code": ["<?php\r\n\r\n$installationVersion = \"7.5\";\r\n\r\n\r\nheader('Content-Type: application/json');\r\n\r\n$obj = new stdClass();\r\n$obj->post = $_POST;\r\n\r\nif (!file_exists($_POST['systemRootPath'] . \"index.php\")) {\r\n    $obj->error = \"Your system path to application ({$_POST['systemRootPath']}) is wrong\";\r\n    echo json_encode($obj);\r\n    exit;\r\n}\r\n\r\n$mysqli = @new mysqli($_POST['databaseHost'], $_POST['databaseUser'], $_POST['databasePass'], \"\", $_POST['databasePort']);\r\n\r\n/*\r\n * This is the \"official\" OO way to do it,\r\n * BUT $connect_error was broken until PHP 5.2.9 and 5.3.0.\r\n */\r\nif ($mysqli->connect_error) {\r\n    $obj->error = ('Connect Error (' . $mysqli->connect_errno . ') ' . $mysqli->connect_error);\r\n    echo json_encode($obj);\r\n    exit;\r\n}\r\n\r\nif ($_POST['createTables'] == 2) {\r\n    $sql = \"CREATE DATABASE IF NOT EXISTS {$_POST['databaseName']}\";\r\n    if ($mysqli->query($sql) !== TRUE) {\r\n        $obj->error = \"Error creating database: \" . $mysqli->error;\r\n        echo json_encode($obj);\r\n        exit;\r\n    }\r\n}\r\n$mysqli->select_db($_POST['databaseName']);\r\n\r\n/*\r\n  $cmd = \"mysql -h {$_POST['databaseHost']} -u {$_POST['databaseUser']} -p {$_POST['databasePass']} {$_POST['databaseName']} < {$_POST['systemRootPath']}install/database.sql\";\r\n  exec(\"{$cmd} 2>&1\", $output, $return_val);\r\n  if ($return_val !== 0) {\r\n  $obj->error = \"Error on command: {$cmd}\";\r\n  echo json_encode($obj);\r\n  exit;\r\n  }\r\n */\r\nif ($_POST['createTables'] > 0) {\r\n// Temporary variable, used to store current query\r\n    $templine = '';\r\n// Read in entire file\r\n    $lines = file(\"{$_POST['systemRootPath']}install/database.sql\");\r\n// Loop through each line\r\n    $obj->error = \"\";\r\n    foreach ($lines as $line) {\r\n// Skip it if it's a comment\r\n        if (substr($line, 0, 2) == '--' || $line == '')\r\n            continue;\r\n\r\n// Add this line to the current segment\r\n        $templine .= $line;\r\n// If it has a semicolon at the end, it's the end of the query\r\n        if (substr(trim($line), -1, 1) == ';') {\r\n            // Perform the query\r\n            if (!$mysqli->query($templine)) {\r\n                $obj->error = ('Error performing query \\'<strong>' . $templine . '\\': ' . $mysqli->error . '<br /><br />');\r\n            }\r\n            // Reset temp variable to empty\r\n            $templine = '';\r\n        }\r\n    }\r\n}\r\n\r\n\r\n$sql = \"DELETE FROM users WHERE id = 1 \";\r\nif ($mysqli->query($sql) !== TRUE) {\r\n    $obj->error = \"Error deleting user: \" . $mysqli->error;\r\n    echo json_encode($obj);\r\n    exit;\r\n}\r\n\r\n\r\n$sql = \"INSERT INTO users (id, user, email, password, created, modified, isAdmin) VALUES (1, 'admin', '\" . $_POST['contactEmail'] . \"', '\" . md5($_POST['systemAdminPass']) . \"', now(), now(), true)\";\r\nif ($mysqli->query($sql) !== TRUE) {\r\n    $obj->error = \"Error creating admin user: \" . $mysqli->error;\r\n    echo json_encode($obj);\r\n    exit;\r\n}\r\n\r\n$sql = \"DELETE FROM categories WHERE id = 1 \";\r\nif ($mysqli->query($sql) !== TRUE) {\r\n    $obj->error = \"Error deleting category: \" . $mysqli->error;\r\n    echo json_encode($obj);\r\n    exit;\r\n}\r\n\r\n$sql = \"INSERT INTO categories (id, name, clean_name, description, created, modified) VALUES (1, 'Default', 'default','', now(), now())\";\r\nif ($mysqli->query($sql) !== TRUE) {\r\n    $obj->error = \"Error creating category: \" . $mysqli->error;\r\n    echo json_encode($obj);\r\n    exit;\r\n}\r\n\r\n$sql = \"DELETE FROM configurations WHERE id = 1 \";\r\nif ($mysqli->query($sql) !== TRUE) {\r\n    $obj->error = \"Error deleting configuration: \" . $mysqli->error;\r\n    echo json_encode($obj);\r\n    exit;\r\n}\r\n\r\n$sql = \"INSERT INTO configurations (id, video_resolution, users_id, version, webSiteTitle, language, contactEmail, encoderURL,  created, modified) \"\r\n        . \" VALUES \"\r\n        . \" (1, '858:480', 1,'{$installationVersion}', '{$_POST['webSiteTitle']}', '{$_POST['mainLanguage']}', '{$_POST['contactEmail']}', 'https://encoder.youphptube.com/', now(), now())\";\r\nif ($mysqli->query($sql) !== TRUE) {\r\n    $obj->error = \"Error creating configuration: \" . $mysqli->error;\r\n    echo json_encode($obj);\r\n    exit;\r\n}\r\n\r\n$mysqli->close();\r\n\r\nif(empty($_POST['salt'])){\r\n    $_POST['salt'] = uniqid();\r\n}\r\n$content = \"<?php\r\n\\$global['configurationVersion'] = 2;\r\n\\$global['disableAdvancedConfigurations'] = 0;\r\n\\$global['videoStorageLimitMinutes'] = 0;\r\nif(!empty(\\$_SERVER['SERVER_NAME']) && \\$_SERVER['SERVER_NAME']!=='localhost' && !filter_var(\\$_SERVER['SERVER_NAME'], FILTER_VALIDATE_IP)) { \r\n    // get the subdirectory, if exists\r\n    \\$subDir = str_replace(array(\\$_SERVER[\\\"DOCUMENT_ROOT\\\"], 'videos/configuration.php'), array('',''), __FILE__);\r\n    \\$global['webSiteRootURL'] = \\\"http\\\".(!empty(\\$_SERVER['HTTPS'])?\\\"s\\\":\\\"\\\").\\\"://\\\".\\$_SERVER['SERVER_NAME'].\\$subDir;\r\n}else{\r\n    \\$global['webSiteRootURL'] = '{$_POST['webSiteRootURL']}';\r\n}\r\n\\$global['systemRootPath'] = '{$_POST['systemRootPath']}';\r\n\\$global['salt'] = '{$_POST['salt']}';\r\n\\$global['enableDDOSprotection'] = 1;\r\n\\$global['ddosMaxConnections'] = 40;\r\n\\$global['ddosSecondTimeout'] = 5;\r\n\\$global['strictDDOSprotection'] = 0;\r\n\r\n\\$mysqlHost = '{$_POST['databaseHost']}';\r\n\\$mysqlPort = '{$_POST['databasePort']}';\r\n\\$mysqlUser = '{$_POST['databaseUser']}';\r\n\\$mysqlPass = '{$_POST['databasePass']}';\r\n\\$mysqlDatabase = '{$_POST['databaseName']}';\r\n\r\n/**\r\n * Do NOT change from here\r\n */\r\n\r\nrequire_once \\$global['systemRootPath'].'objects/include_config.php';\r\n\";\r\n\r\n$fp = fopen($_POST['systemRootPath'] . \"videos/configuration.php\", \"wb\");\r\nfwrite($fp, $content);\r\nfclose($fp);\r\n/*\r\n//copy the 100% progress sample file to be used when the uploaded file is already encoded in the MP4 or WBM formats\r\nexec(\"cp {$_POST['systemRootPath']}install/FinishedProgressSample.* {$_POST['systemRootPath']}videos/\", $output, $return_val);\r\n\r\nif ($return_val !== 0) {\r\n    $obj->error = \"Error copying the encoding progress sample files. Check whether the directory {$_POST['systemRootPath']}videos/ exists and the process have permission\";\r\n    echo json_encode($obj);\r\n    exit;\r\n}\r\n*/\r\n$obj->success = true;\r\necho json_encode($obj);\r\n"], "fixing_code": ["<?php\r\nif (file_exists(\"../videos/configuration.php\")) {\r\n    error_log(\"Can not create configuration again: \".  json_encode($_SERVER));\r\n    exit;\r\n}\r\n\r\n$installationVersion = \"7.5\";\r\n\r\n\r\nheader('Content-Type: application/json');\r\n\r\n$obj = new stdClass();\r\n$obj->post = $_POST;\r\n\r\nif (!file_exists($_POST['systemRootPath'] . \"index.php\")) {\r\n    $obj->error = \"Your system path to application ({$_POST['systemRootPath']}) is wrong\";\r\n    echo json_encode($obj);\r\n    exit;\r\n}\r\n\r\n$mysqli = @new mysqli($_POST['databaseHost'], $_POST['databaseUser'], $_POST['databasePass'], \"\", $_POST['databasePort']);\r\n\r\n/*\r\n * This is the \"official\" OO way to do it,\r\n * BUT $connect_error was broken until PHP 5.2.9 and 5.3.0.\r\n */\r\nif ($mysqli->connect_error) {\r\n    $obj->error = ('Connect Error (' . $mysqli->connect_errno . ') ' . $mysqli->connect_error);\r\n    echo json_encode($obj);\r\n    exit;\r\n}\r\n\r\nif ($_POST['createTables'] == 2) {\r\n    $sql = \"CREATE DATABASE IF NOT EXISTS {$_POST['databaseName']}\";\r\n    if ($mysqli->query($sql) !== TRUE) {\r\n        $obj->error = \"Error creating database: \" . $mysqli->error;\r\n        echo json_encode($obj);\r\n        exit;\r\n    }\r\n}\r\n$mysqli->select_db($_POST['databaseName']);\r\n\r\n/*\r\n  $cmd = \"mysql -h {$_POST['databaseHost']} -u {$_POST['databaseUser']} -p {$_POST['databasePass']} {$_POST['databaseName']} < {$_POST['systemRootPath']}install/database.sql\";\r\n  exec(\"{$cmd} 2>&1\", $output, $return_val);\r\n  if ($return_val !== 0) {\r\n  $obj->error = \"Error on command: {$cmd}\";\r\n  echo json_encode($obj);\r\n  exit;\r\n  }\r\n */\r\nif ($_POST['createTables'] > 0) {\r\n// Temporary variable, used to store current query\r\n    $templine = '';\r\n// Read in entire file\r\n    $lines = file(\"{$_POST['systemRootPath']}install/database.sql\");\r\n// Loop through each line\r\n    $obj->error = \"\";\r\n    foreach ($lines as $line) {\r\n// Skip it if it's a comment\r\n        if (substr($line, 0, 2) == '--' || $line == '')\r\n            continue;\r\n\r\n// Add this line to the current segment\r\n        $templine .= $line;\r\n// If it has a semicolon at the end, it's the end of the query\r\n        if (substr(trim($line), -1, 1) == ';') {\r\n            // Perform the query\r\n            if (!$mysqli->query($templine)) {\r\n                $obj->error = ('Error performing query \\'<strong>' . $templine . '\\': ' . $mysqli->error . '<br /><br />');\r\n            }\r\n            // Reset temp variable to empty\r\n            $templine = '';\r\n        }\r\n    }\r\n}\r\n\r\n\r\n$sql = \"DELETE FROM users WHERE id = 1 \";\r\nif ($mysqli->query($sql) !== TRUE) {\r\n    $obj->error = \"Error deleting user: \" . $mysqli->error;\r\n    echo json_encode($obj);\r\n    exit;\r\n}\r\n\r\n\r\n$sql = \"INSERT INTO users (id, user, email, password, created, modified, isAdmin) VALUES (1, 'admin', '\" . $_POST['contactEmail'] . \"', '\" . md5($_POST['systemAdminPass']) . \"', now(), now(), true)\";\r\nif ($mysqli->query($sql) !== TRUE) {\r\n    $obj->error = \"Error creating admin user: \" . $mysqli->error;\r\n    echo json_encode($obj);\r\n    exit;\r\n}\r\n\r\n$sql = \"DELETE FROM categories WHERE id = 1 \";\r\nif ($mysqli->query($sql) !== TRUE) {\r\n    $obj->error = \"Error deleting category: \" . $mysqli->error;\r\n    echo json_encode($obj);\r\n    exit;\r\n}\r\n\r\n$sql = \"INSERT INTO categories (id, name, clean_name, description, created, modified) VALUES (1, 'Default', 'default','', now(), now())\";\r\nif ($mysqli->query($sql) !== TRUE) {\r\n    $obj->error = \"Error creating category: \" . $mysqli->error;\r\n    echo json_encode($obj);\r\n    exit;\r\n}\r\n\r\n$sql = \"DELETE FROM configurations WHERE id = 1 \";\r\nif ($mysqli->query($sql) !== TRUE) {\r\n    $obj->error = \"Error deleting configuration: \" . $mysqli->error;\r\n    echo json_encode($obj);\r\n    exit;\r\n}\r\n\r\n$sql = \"INSERT INTO configurations (id, video_resolution, users_id, version, webSiteTitle, language, contactEmail, encoderURL,  created, modified) \"\r\n        . \" VALUES \"\r\n        . \" (1, '858:480', 1,'{$installationVersion}', '{$_POST['webSiteTitle']}', '{$_POST['mainLanguage']}', '{$_POST['contactEmail']}', 'https://encoder.youphptube.com/', now(), now())\";\r\nif ($mysqli->query($sql) !== TRUE) {\r\n    $obj->error = \"Error creating configuration: \" . $mysqli->error;\r\n    echo json_encode($obj);\r\n    exit;\r\n}\r\n\r\n$mysqli->close();\r\n\r\nif(empty($_POST['salt'])){\r\n    $_POST['salt'] = uniqid();\r\n}\r\n$content = \"<?php\r\n\\$global['configurationVersion'] = 2;\r\n\\$global['disableAdvancedConfigurations'] = 0;\r\n\\$global['videoStorageLimitMinutes'] = 0;\r\nif(!empty(\\$_SERVER['SERVER_NAME']) && \\$_SERVER['SERVER_NAME']!=='localhost' && !filter_var(\\$_SERVER['SERVER_NAME'], FILTER_VALIDATE_IP)) { \r\n    // get the subdirectory, if exists\r\n    \\$subDir = str_replace(array(\\$_SERVER[\\\"DOCUMENT_ROOT\\\"], 'videos/configuration.php'), array('',''), __FILE__);\r\n    \\$global['webSiteRootURL'] = \\\"http\\\".(!empty(\\$_SERVER['HTTPS'])?\\\"s\\\":\\\"\\\").\\\"://\\\".\\$_SERVER['SERVER_NAME'].\\$subDir;\r\n}else{\r\n    \\$global['webSiteRootURL'] = '{$_POST['webSiteRootURL']}';\r\n}\r\n\\$global['systemRootPath'] = '{$_POST['systemRootPath']}';\r\n\\$global['salt'] = '{$_POST['salt']}';\r\n\\$global['enableDDOSprotection'] = 1;\r\n\\$global['ddosMaxConnections'] = 40;\r\n\\$global['ddosSecondTimeout'] = 5;\r\n\\$global['strictDDOSprotection'] = 0;\r\n\r\n\\$mysqlHost = '{$_POST['databaseHost']}';\r\n\\$mysqlPort = '{$_POST['databasePort']}';\r\n\\$mysqlUser = '{$_POST['databaseUser']}';\r\n\\$mysqlPass = '{$_POST['databasePass']}';\r\n\\$mysqlDatabase = '{$_POST['databaseName']}';\r\n\r\n/**\r\n * Do NOT change from here\r\n */\r\n\r\nrequire_once \\$global['systemRootPath'].'objects/include_config.php';\r\n\";\r\n\r\n$fp = fopen($_POST['systemRootPath'] . \"videos/configuration.php\", \"wb\");\r\nfwrite($fp, $content);\r\nfclose($fp);\r\n/*\r\n//copy the 100% progress sample file to be used when the uploaded file is already encoded in the MP4 or WBM formats\r\nexec(\"cp {$_POST['systemRootPath']}install/FinishedProgressSample.* {$_POST['systemRootPath']}videos/\", $output, $return_val);\r\n\r\nif ($return_val !== 0) {\r\n    $obj->error = \"Error copying the encoding progress sample files. Check whether the directory {$_POST['systemRootPath']}videos/ exists and the process have permission\";\r\n    echo json_encode($obj);\r\n    exit;\r\n}\r\n*/\r\n$obj->success = true;\r\necho json_encode($obj);\r\n"], "filenames": ["install/checkConfiguration.php"], "buggy_code_start_loc": [1], "buggy_code_end_loc": [1], "fixing_code_start_loc": [2], "fixing_code_end_loc": [6], "type": "CWE-862", "message": "In YouPHPTube 7.4, the file install/checkConfiguration.php has no access control, which leads to everyone being able to edit the configuration file, and insert malicious PHP code.", "other": {"cve": {"id": "CVE-2019-16124", "sourceIdentifier": "cve@mitre.org", "published": "2019-09-09T02:15:10.360", "lastModified": "2020-08-24T17:37:01.140", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "In YouPHPTube 7.4, the file install/checkConfiguration.php has no access control, which leads to everyone being able to edit the configuration file, and insert malicious PHP code."}, {"lang": "es", "value": "En YouPHPTube 7.4, el archivo install / checkConfiguration.php no tiene control de acceso, lo que hace que todos puedan editar el archivo de configuraci\u00f3n e insertar c\u00f3digo PHP malicioso."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 9.8, "baseSeverity": "CRITICAL"}, "exploitabilityScore": 3.9, "impactScore": 5.9}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:N/C:P/I:P/A:P", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "NONE", "confidentialityImpact": "PARTIAL", "integrityImpact": "PARTIAL", "availabilityImpact": "PARTIAL", "baseScore": 7.5}, "baseSeverity": "HIGH", "exploitabilityScore": 10.0, "impactScore": 6.4, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-862"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:youphptube:youphptube:*:*:*:*:*:*:*:*", "versionEndIncluding": "7.4", "matchCriteriaId": "21F54D04-21AD-40B4-A5DB-C1F2428BE9DC"}]}]}], "references": [{"url": "https://github.com/YouPHPTube/YouPHPTube/commit/b32b410c9191c3c5db888514c29d7921f124d883", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://www.exploit-db.com/exploits/47326", "source": "cve@mitre.org", "tags": ["Exploit", "Third Party Advisory", "VDB Entry"]}, {"url": "https://zerodays.lol/", "source": "cve@mitre.org", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/YouPHPTube/YouPHPTube/commit/b32b410c9191c3c5db888514c29d7921f124d883"}}