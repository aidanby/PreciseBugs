{"buggy_code": ["<?php\n\nApp::uses('AppModel', 'Model');\nApp::uses('Folder', 'Utility');\nApp::uses('File', 'Utility');\nApp::uses('FinancialTool', 'Tools');\nApp::uses('RandomTool', 'Tools');\n\nclass Attribute extends AppModel {\n\n\tpublic $combinedKeys = array('event_id', 'category', 'type');\n\n\tpublic $name = 'Attribute';\t\t\t\t// TODO general\n\n\tpublic $actsAs = array(\n\t\t'SysLogLogable.SysLogLogable' => array(\t// TODO Audit, logable\n\t\t\t'userModel' => 'User',\n\t\t\t'userKey' => 'user_id',\n\t\t\t'change' => 'full'),\n\t\t'Trim',\n\t\t'Containable',\n\t\t'Regexp' => array('fields' => array('value')),\n\t);\n\n\tpublic $displayField = 'value';\n\n\tpublic $virtualFields = array(\n\t\t\t'value' => \"CASE WHEN Attribute.value2 = '' THEN Attribute.value1 ELSE CONCAT(Attribute.value1, '|', Attribute.value2) END\",\n\t); // TODO hardcoded\n\n\t // explanations of certain fields to be used in various views\n\tpublic $fieldDescriptions = array(\n\t\t\t'signature' => array('desc' => 'Is this attribute eligible to automatically create an IDS signature (network IDS or host IDS) out of it ?'),\n\t\t\t'distribution' => array('desc' => 'Describes who will have access to the event.')\n\t);\n\n\tpublic $distributionDescriptions = array(\n\t\t0 => array('desc' => 'This field determines the current distribution of the event', 'formdesc' => \"This setting will only allow members of your organisation on this server to see it.\"),\n\t\t1 => array('desc' => 'This field determines the current distribution of the event', 'formdesc' => \"Organisations that are part of this MISP community will be able to see the event.\"),\n\t\t2 => array('desc' => 'This field determines the current distribution of the event', 'formdesc' => \"Organisations that are either part of this MISP community or part of a directly connected MISP community will be able to see the event.\"),\n\t\t3 => array('desc' => 'This field determines the current distribution of the event', 'formdesc' => \"This will share the event with all MISP communities, allowing the event to be freely propagated from one server to the next.\"),\n\t\t4 => array('desc' => 'This field determines the current distribution of the event', 'formdesc' => \"This distribution of this event will be handled by the selected sharing group.\"),\n\t\t5 => array('desc' => 'This field determines the current distribution of the event', 'formdesc' => \"Inherit the event's distribution settings\"),\n\t);\n\n\tpublic $distributionLevels = array(\n\t\t\t0 => 'Your organisation only', 1 => 'This community only', 2 => 'Connected communities', 3 => 'All communities', 4 => 'Sharing group', 5 => 'Inherit event'\n\t);\n\n\tpublic $shortDist = array(0 => 'Organisation', 1 => 'Community', 2 => 'Connected', 3 => 'All', 4 => ' Sharing Group', 5 => 'Inherit');\n\n\t// these are definitions of possible types + their descriptions and maybe later other behaviors\n\t// e.g. if the attribute should be correlated with others or not\n\n\t// if these then a category may have upload to be zipped\n\tpublic $zippedDefinitions = array(\n\t\t\t'malware-sample'\n\t);\n\n\t// if these then a category may have upload\n\tpublic $uploadDefinitions = array(\n\t\t\t'attachment'\n\t);\n\n\t// skip Correlation for the following types\n\tpublic $nonCorrelatingTypes = array(\n\t\t\t'comment',\n\t\t\t'http-method',\n\t\t\t'aba-rtn',\n\t\t\t'gender',\n\t\t\t'counter',\n\t\t\t'port',\n\t\t\t'nationality',\n\t\t\t'cortex',\n\t\t\t'boolean'\n\t);\n\n\tpublic $primaryOnlyCorrelatingTypes = array(\n\t\t'ip-src|port',\n\t\t'ip-dst|port'\n\t);\n\n\tpublic $searchResponseTypes = array(\n\t\t'xml' => array(\n\t\t\t'type' => 'xml',\n\t\t\t'layout' => 'xml/default',\n\t\t\t'header' => 'Content-Disposition: download; filename=\"misp.search.attribute.results.xml\"'\n\t\t),\n\t\t'json' => array(\n\t\t\t'type' => 'json',\n\t\t\t'layout' => 'json/default',\n\t\t\t'header' => 'Content-Disposition: download; filename=\"misp.search.attribute.results.json\"'\n\t\t),\n\t\t'openioc' => array(\n\t\t\t'type' => 'xml',\n\t\t\t'layout' => 'xml/default',\n\t\t\t'header' => 'Content-Disposition: download; filename=\"misp.search.attribute.results.openioc.xml\"'\n\t\t),\n\t);\n\n\tpublic $typeDefinitions = array(\n\t\t\t'md5' => array('desc' => 'A checksum in md5 format', 'formdesc' => \"You are encouraged to use filename|md5 instead. A checksum in md5 format, only use this if you don't know the correct filename\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'sha1' => array('desc' => 'A checksum in sha1 format', 'formdesc' => \"You are encouraged to use filename|sha1 instead. A checksum in sha1 format, only use this if you don't know the correct filename\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'sha256' => array('desc' => 'A checksum in sha256 format', 'formdesc' => \"You are encouraged to use filename|sha256 instead. A checksum in sha256 format, only use this if you don't know the correct filename\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'filename' => array('desc' => 'Filename', 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'pdb' => array('desc' => 'Microsoft Program database (PDB) path information', 'default_category' => 'Artifacts dropped', 'to_ids' => 0),\n\t\t\t'filename|md5' => array('desc' => 'A filename and an md5 hash separated by a |', 'formdesc' => \"A filename and an md5 hash separated by a | (no spaces)\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'filename|sha1' => array('desc' => 'A filename and an sha1 hash separated by a |', 'formdesc' => \"A filename and an sha1 hash separated by a | (no spaces)\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'filename|sha256' => array('desc' => 'A filename and an sha256 hash separated by a |', 'formdesc' => \"A filename and an sha256 hash separated by a | (no spaces)\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'ip-src' => array('desc' => \"A source IP address of the attacker\", 'default_category' => 'Network activity', 'to_ids' => 1),\n\t\t\t'ip-dst' => array('desc' => 'A destination IP address of the attacker or C&C server', 'formdesc' => \"A destination IP address of the attacker or C&C server. Also set the IDS flag on when this IP is hardcoded in malware\", 'default_category' => 'Network activity', 'to_ids' => 1),\n\t\t\t'hostname' => array('desc' => 'A full host/dnsname of an attacker', 'formdesc' => \"A full host/dnsname of an attacker. Also set the IDS flag on when this hostname is hardcoded in malware\", 'default_category' => 'Network activity', 'to_ids' => 1),\n\t\t\t'domain' => array('desc' => 'A domain name used in the malware', 'formdesc' => \"A domain name used in the malware. Use this instead of hostname when the upper domain is important or can be used to create links between events.\", 'default_category' => 'Network activity', 'to_ids' => 1),\n\t\t\t'domain|ip' => array('desc' => 'A domain name and its IP address (as found in DNS lookup) separated by a |','formdesc' => \"A domain name and its IP address (as found in DNS lookup) separated by a | (no spaces)\", 'default_category' => 'Network activity', 'to_ids' => 1),\n\t\t\t'email-src' => array('desc' => \"The email address used to send the malware.\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'email-dst' => array('desc' => \"A recipient email address\", 'formdesc' => \"A recipient email address that is not related to your constituency.\", 'default_category' => 'Network activity', 'to_ids' => 1),\n\t\t\t'email-subject' => array('desc' => \"The subject of the email\", 'default_category' => 'Payload delivery', 'to_ids' => 0),\n\t\t\t'email-attachment' => array('desc' => \"File name of the email attachment.\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'email-body' => array('desc' => 'Email body', 'default_category' => 'Payload delivery', 'to_ids' => 0),\n\t\t\t'float' => array('desc' => \"A floating point value.\", 'default_category' => 'Other', 'to_ids' => 0),\n\t\t\t'url' => array('desc' => 'url', 'default_category' => 'External analysis', 'to_ids' => 1),\n\t\t\t'http-method' => array('desc' => \"HTTP method used by the malware (e.g. POST, GET, ...).\", 'default_category' => 'Network activity', 'to_ids' => 0),\n\t\t\t'user-agent' => array('desc' => \"The user-agent used by the malware in the HTTP request.\", 'default_category' => 'Network activity', 'to_ids' => 0),\n\t\t\t'regkey' => array('desc' => \"Registry key or value\", 'default_category' => 'Persistence mechanism', 'to_ids' => 1),\n\t\t\t'regkey|value' => array('desc' => \"Registry value + data separated by |\", 'default_category' => 'Persistence mechanism', 'to_ids' => 1),\n\t\t\t'AS' => array('desc' => 'Autonomous system', 'default_category' => 'Network activity', 'to_ids' => 0),\n\t\t\t'snort' => array('desc' => 'An IDS rule in Snort rule-format', 'formdesc' => \"An IDS rule in Snort rule-format. This rule will be automatically rewritten in the NIDS exports.\", 'default_category' => 'Network activity', 'to_ids' => 1),\n\t\t\t'pattern-in-file' => array('desc' => 'Pattern in file that identifies the malware', 'default_category' => 'Payload installation', 'to_ids' => 1),\n\t\t\t'pattern-in-traffic' => array('desc' => 'Pattern in network traffic that identifies the malware', 'default_category' => 'Network activity', 'to_ids' => 1),\n\t\t\t'pattern-in-memory' => array('desc' => 'Pattern in memory dump that identifies the malware', 'default_category' => 'Payload installation', 'to_ids' => 1),\n      'yara' => array('desc' => 'Yara signature', 'default_category' => 'Payload installation', 'to_ids' => 1),\n      'stix2-pattern' => array('desc' => 'STIX 2 pattern', 'default_category' => 'Payload installation', 'to_ids' => 1),\n      'sigma' => array('desc' => 'Sigma - Generic Signature Format for SIEM Systems', 'default_category' => 'Payload installation', 'to_ids' => 1),\n      'gene' => array('desc' => 'GENE - Go Evtx sigNature Engine', 'default_category' => 'Artifacts dropped', 'to_ids' => 0),\n      'mime-type' => array('desc' => 'A media type (also MIME type and content type) is a two-part identifier for file formats and format contents transmitted on the Internet', 'default_category' => 'Artifacts dropped', 'to_ids' => 0),\n      'identity-card-number' => array('desc' => 'Identity card number', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'cookie' => array('desc' => 'HTTP cookie as often stored on the user web client. This can include authentication cookie or session cookie.', 'default_category' => 'Network activity', 'to_ids' => 0),\n\t\t\t'vulnerability' => array('desc' => 'A reference to the vulnerability used in the exploit', 'default_category' => 'External analysis', 'to_ids' => 0),\n\t\t\t'attachment' => array('desc' => 'Attachment with external information', 'formdesc' => \"Please upload files using the <em>Upload Attachment</em> button.\", 'default_category' => 'External analysis', 'to_ids' => 0),\n\t\t\t'malware-sample' => array('desc' => 'Attachment containing encrypted malware sample', 'formdesc' => \"Please upload files using the <em>Upload Attachment</em> button.\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'link' => array('desc' => 'Link to an external information', 'default_category' => 'External analysis', 'to_ids' => 0),\n\t\t\t'comment' => array('desc' => 'Comment or description in a human language', 'formdesc' => 'Comment or description in a human language.  This will not be correlated with other attributes', 'default_category' => 'Other', 'to_ids' => 0),\n\t\t\t'text' => array('desc' => 'Name, ID or a reference', 'default_category' => 'Other', 'to_ids' => 0),\n\t\t\t'hex' => array('desc' => 'A value in hexadecimal format', 'default_category' => 'Other', 'to_ids' => 0),\n\t\t\t'other' => array('desc' => 'Other attribute', 'default_category' => 'Other', 'to_ids' => 0),\n\t\t\t'named pipe' => array('desc' => 'Named pipe, use the format \\\\.\\pipe\\<PipeName>', 'default_category' => 'Artifacts dropped', 'to_ids' => 0),\n\t\t\t'mutex' => array('desc' => 'Mutex, use the format \\BaseNamedObjects\\<Mutex>', 'default_category' => 'Artifacts dropped', 'to_ids' => 1),\n\t\t\t'target-user' => array('desc' => 'Attack Targets Username(s)', 'default_category' => 'Targeting data', 'to_ids' => 0),\n\t\t\t'target-email' => array('desc' => 'Attack Targets Email(s)', 'default_category' => 'Targeting data', 'to_ids' => 0),\n\t\t\t'target-machine' => array('desc' => 'Attack Targets Machine Name(s)', 'default_category' => 'Targeting data', 'to_ids' => 0),\n\t\t\t'target-org' => array('desc' => 'Attack Targets Department or Organization(s)', 'default_category' => 'Targeting data', 'to_ids' => 0),\n\t\t\t'target-location' => array('desc' => 'Attack Targets Physical Location(s)', 'default_category' => 'Targeting data', 'to_ids' => 0),\n\t\t\t'target-external' => array('desc' => 'External Target Organizations Affected by this Attack', 'default_category' => 'Targeting data', 'to_ids' => 0),\n\t\t\t'btc' => array('desc' => 'Bitcoin Address', 'default_category' => 'Financial fraud', 'to_ids' => 1),\n\t\t\t'iban' => array('desc' => 'International Bank Account Number', 'default_category' => 'Financial fraud', 'to_ids' => 1),\n\t\t\t'bic' => array('desc' => 'Bank Identifier Code Number also known as SWIFT-BIC, SWIFT code or ISO 9362 code', 'default_category' => 'Financial fraud', 'to_ids' => 1),\n\t\t\t'bank-account-nr' => array('desc' => 'Bank account number without any routing number', 'default_category' => 'Financial fraud', 'to_ids' => 1),\n\t\t\t'aba-rtn' => array('desc' => 'ABA routing transit number', 'default_category' => 'Financial fraud', 'to_ids' => 1),\n\t\t\t'bin' => array('desc' => 'Bank Identification Number', 'default_category' => 'Financial fraud', 'to_ids' => 1),\n\t\t\t'cc-number' => array('desc' => 'Credit-Card Number', 'default_category' => 'Financial fraud', 'to_ids' => 1),\n\t\t\t'prtn' => array('desc' => 'Premium-Rate Telephone Number', 'default_category' => 'Financial fraud', 'to_ids' => 1),\n\t\t\t'phone-number' => array('desc' => 'Telephone Number', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'threat-actor' => array('desc' => 'A string identifying the threat actor', 'default_category' => 'Attribution', 'to_ids' => 0),\n\t\t\t'campaign-name' => array('desc' => 'Associated campaign name', 'default_category' => 'Attribution', 'to_ids' => 0),\n\t\t\t'campaign-id' => array('desc' => 'Associated campaign ID', 'default_category' => 'Attribution', 'to_ids' => 0),\n\t\t\t'malware-type' => array('desc' => '', 'default_category' => 'Payload delivery', 'to_ids' => 0),\n\t\t\t'uri' => array('desc' => 'Uniform Resource Identifier', 'default_category' => 'Network activity', 'to_ids' => 1),\n\t\t\t'authentihash' => array('desc' => 'Authenticode executable signature hash', 'formdesc' => \"You are encouraged to use filename|authentihash instead. Authenticode executable signature hash, only use this if you don't know the correct filename\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'ssdeep' => array('desc' => 'A checksum in ssdeep format', 'formdesc' => \"You are encouraged to use filename|ssdeep instead. A checksum in the SSDeep format, only use this if you don't know the correct filename\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'imphash' => array('desc' => 'Import hash - a hash created based on the imports in the sample.', 'formdesc' => \"You are encouraged to use filename|imphash instead. A hash created based on the imports in the sample, only use this if you don't know the correct filename\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'pehash' => array('desc' => 'PEhash - a hash calculated based of certain pieces of a PE executable file', 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'impfuzzy' => array('desc' => 'A fuzzy hash of import table of Portable Executable format', 'formdesc' => \"You are encouraged to use filename|impfuzzy instead. A fuzzy hash created based on the imports in the sample, only use this if you don't know the correct filename\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'sha224' => array('desc' => 'A checksum in sha-224 format', 'formdesc' => \"You are encouraged to use filename|sha224 instead. A checksum in sha224 format, only use this if you don't know the correct filename\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'sha384' => array('desc' => 'A checksum in sha-384 format', 'formdesc' => \"You are encouraged to use filename|sha384 instead. A checksum in sha384 format, only use this if you don't know the correct filename\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'sha512' => array('desc' => 'A checksum in sha-512 format', 'formdesc' => \"You are encouraged to use filename|sha512 instead. A checksum in sha512 format, only use this if you don't know the correct filename\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'sha512/224' => array('desc' => 'A checksum in the sha-512/224 format', 'formdesc' => \"You are encouraged to use filename|sha512/224 instead. A checksum in sha512/224 format, only use this if you don't know the correct filename\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'sha512/256' => array('desc' => 'A checksum in the sha-512/256 format', 'formdesc' => \"You are encouraged to use filename|sha512/256 instead. A checksum in sha512/256 format, only use this if you don't know the correct filename\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'tlsh' => array('desc' => 'A checksum in the Trend Micro Locality Sensitive Hash format', 'formdesc' => \"You are encouraged to use filename|tlsh instead. A checksum in the Trend Micro Locality Sensitive Hash format, only use this if you don't know the correct filename\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'filename|authentihash' => array('desc' => 'A checksum in md5 format', 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'filename|ssdeep' => array('desc' => 'A checksum in ssdeep format', 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'filename|imphash' => array('desc' => 'Import hash - a hash created based on the imports in the sample.', 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'filename|impfuzzy' => array('desc' => 'Import fuzzy hash - a fuzzy hash created based on the imports in the sample.', 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'filename|pehash' => array('desc' => 'A filename and a PEhash separated by a |', 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'filename|sha224' => array('desc' => 'A filename and a sha-224 hash separated by a |', 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'filename|sha384' => array('desc' => 'A filename and a sha-384 hash separated by a |', 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'filename|sha512' => array('desc' => 'A filename and a sha-512 hash separated by a |', 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'filename|sha512/224' => array('desc' => 'A filename and a sha-512/224 hash separated by a |', 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'filename|sha512/256' => array('desc' => 'A filename and a sha-512/256 hash separated by a |', 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'filename|tlsh' => array('desc' => 'A filename and a Trend Micro Locality Sensitive Hash separated by a |', 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'windows-scheduled-task' => array('desc' => 'A scheduled task in windows', 'default_category' => 'Artifacts dropped', 'to_ids' => 0),\n\t\t\t'windows-service-name' => array('desc' => 'A windows service name. This is the name used internally by windows. Not to be confused with the windows-service-displayname.', 'default_category' => 'Artifacts dropped', 'to_ids' => 0),\n\t\t\t'windows-service-displayname' => array('desc' => 'A windows service\\'s displayname, not to be confused with the windows-service-name. This is the name that applications will generally display as the service\\'s name in applications.', 'default_category' => 'Artifacts dropped', 'to_ids' => 0),\n\t\t\t'whois-registrant-email' => array('desc' => 'The e-mail of a domain\\'s registrant, obtained from the WHOIS information.', 'default_category' => 'Attribution', 'to_ids' => 0),\n\t\t\t'whois-registrant-phone' => array('desc' => 'The phone number of a domain\\'s registrant, obtained from the WHOIS information.', 'default_category' => 'Attribution', 'to_ids' => 0),\n\t\t\t'whois-registrant-name' => array('desc' => 'The name of a domain\\'s registrant, obtained from the WHOIS information.', 'default_category' => 'Attribution', 'to_ids' => 0),\n\t\t\t'whois-registrant-org' => array('desc' => 'The org of a domain\\'s registrant, obtained from the WHOIS information.', 'default_category' => 'Attribution', 'to_ids' => 0),\n\t\t\t'whois-registrar' => array('desc' => 'The registrar of the domain, obtained from the WHOIS information.', 'default_category' => 'Attribution', 'to_ids' => 0),\n\t\t\t'whois-creation-date' => array('desc' => 'The date of domain\\'s creation, obtained from the WHOIS information.', 'default_category' => 'Attribution', 'to_ids' => 0),\n\t\t\t// 'targeted-threat-index' => array('desc' => ''), // currently not mapped!\n\t\t\t// 'mailslot' => array('desc' => 'MailSlot interprocess communication'), // currently not mapped!\n\t\t\t// 'pipe' => array('desc' => 'Pipeline (for named pipes use the attribute type \"named pipe\")'), // currently not mapped!\n\t\t\t// 'ssl-cert-attributes' => array('desc' => 'SSL certificate attributes'), // currently not mapped!\n\t\t\t'x509-fingerprint-sha1' => array('desc' => 'X509 fingerprint in SHA-1 format', 'default_category' => 'Network activity', 'to_ids' => 1),\n\t\t\t'x509-fingerprint-md5' => array('desc' => 'X509 fingerprint in MD5 format', 'default_category' => 'Network activity', 'to_ids' => 1),\n\t\t\t'x509-fingerprint-sha256' => array('desc' => 'X509 fingerprint in SHA-256 format', 'default_category' => 'Network activity', 'to_ids' => 1),\n\t\t\t'dns-soa-email' => array('desc' => 'RFC1035 mandates that DNS zones should have a SOA (Statement Of Authority) record that contains an email address where a PoC for the domain could be contacted. This can sometimes be used for attribution/linkage between different domains even if protected by whois privacy', 'default_category' => 'Attribution', 'to_ids' => 0),\n\t\t\t'size-in-bytes' => array('desc' => 'Size expressed in bytes', 'default_category' => 'Other', 'to_ids' => 0),\n\t\t\t'counter' => array('desc' => 'An integer counter, generally to be used in objects', 'default_category' => 'Other', 'to_ids' => 0),\n\t\t\t'datetime' => array('desc' => 'Datetime in the ISO 8601 format', 'default_category' => 'Other', 'to_ids' => 0),\n\t\t\t'cpe' => array('desc' => 'Common platform enumeration', 'default_category' => 'Other', 'to_ids' => 0),\n\t\t\t'port' => array('desc' => 'Port number', 'default_category' => 'Network activity', 'to_ids' => 0),\n\t\t\t'ip-dst|port' => array('desc' => 'IP destination and port number seperated by a |', 'default_category' => 'Network activity', 'to_ids' => 1),\n\t\t\t'ip-src|port' => array('desc' => 'IP source and port number seperated by a |', 'default_category' => 'Network activity', 'to_ids' => 1),\n\t\t\t'hostname|port' => array('desc' => 'Hostname and port number seperated by a |', 'default_category' => 'Network activity', 'to_ids' => 1),\n\t\t\t'mac-address' => array('desc' => 'Mac address', 'default_category' => 'Network activity', 'to_ids' => 0),\n\t\t\t'mac-eui-64' => array('desc' => 'Mac EUI-64 address', 'default_category' => 'Network activity', 'to_ids' => 0),\n\t\t\t// verify IDS flag defaults for these\n\t\t\t'email-dst-display-name' => array('desc' => 'Email destination display name', 'default_category' => 'Payload delivery', 'to_ids' => 0),\n\t\t\t'email-src-display-name' => array('desc' => 'Email source display name', 'default_category' => 'Payload delivery', 'to_ids' => 0),\n\t\t\t'email-header' => array('desc' => 'Email header', 'default_category' => 'Payload delivery', 'to_ids' => 0),\n\t\t\t'email-reply-to' => array('desc' => 'Email reply to header', 'default_category' => 'Payload delivery', 'to_ids' => 0),\n\t\t\t'email-x-mailer' => array('desc' => 'Email x-mailer header', 'default_category' => 'Payload delivery', 'to_ids' => 0),\n\t\t\t'email-mime-boundary' => array('desc' => 'The email mime boundary separating parts in a multipart email', 'default_category' => 'Payload delivery', 'to_ids' => 0),\n\t\t\t'email-thread-index' => array('desc' => 'The email thread index header', 'default_category' => 'Payload delivery', 'to_ids' => 0),\n\t\t\t'email-message-id' => array('desc' => 'The email message ID', 'default_category' => 'Payload delivery', 'to_ids' => 0),\n\t\t\t'github-username' => array('desc' => 'A github user name', 'default_category' => 'Social network', 'to_ids' => 0),\n\t\t\t'github-repository' => array('desc' => 'A github repository', 'default_category' => 'Social network', 'to_ids' => 0),\n\t\t\t'github-organisation' => array('desc' => 'A github organisation', 'default_category' => 'Social network', 'to_ids' => 0),\n\t\t\t'jabber-id' => array('desc' => 'Jabber ID', 'default_category' => 'Social network', 'to_ids' => 0),\n\t\t\t'twitter-id' => array('desc' => 'Twitter ID', 'default_category' => 'Social network', 'to_ids' => 0),\n\t\t\t'first-name' => array('desc' => 'First name of a natural person', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'middle-name' => array('desc' => 'Middle name of a natural person', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'last-name' => array('desc' => 'Last name of a natural person', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'date-of-birth' => array('desc' => 'Date of birth of a natural person (in YYYY-MM-DD format)', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'place-of-birth' => array('desc' => 'Place of birth of a natural person', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'gender' => array('desc' => 'The gender of a natural person (Male, Female, Other, Prefer not to say)', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'passport-number' => array('desc' => 'The passport number of a natural person', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'passport-country' => array('desc' => 'The country in which the passport was issued', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'passport-expiration' => array('desc' => 'The expiration date of a passport', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'redress-number' => array('desc' => 'The Redress Control Number is the record identifier for people who apply for redress through the DHS Travel Redress Inquiry Program (DHS TRIP). DHS TRIP is for travelers who have been repeatedly identified for additional screening and who want to file an inquiry to have erroneous information corrected in DHS systems', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'nationality' => array('desc' => 'The nationality of a natural person', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'visa-number' => array('desc' => 'Visa number', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'issue-date-of-the-visa' => array('desc' => 'The date on which the visa was issued', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'primary-residence' => array('desc' => 'The primary residence of a natural person', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'country-of-residence' => array('desc' => 'The country of residence of a natural person', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'special-service-request' => array('desc' => 'A Special Service Request is a function to an airline to provide a particular facility for A Passenger or passengers. ', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'frequent-flyer-number' => array('desc' => 'The frequent flyer number of a passenger', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t// Do we really need remarks? Or just use comment/text for this?\n\t\t\t//'remarks' => array('desc' => '', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'travel-details' => array('desc' => 'Travel details', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'payment-details' => array('desc' => 'Payment details', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'place-port-of-original-embarkation' => array('desc' => 'The orignal port of embarkation', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'place-port-of-clearance' => array('desc' => 'The port of clearance', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'place-port-of-onward-foreign-destination' => array('desc' => 'A Port where the passenger is transiting to', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'passenger-name-record-locator-number' => array('desc' => 'The Passenger Name Record Locator is a key under which the reservation for a trip is stored in the system. The PNR contains, among other data, the name, flight segments and address of the passenger. It is defined by a combination of five or six letters and numbers.', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'mobile-application-id' => array('desc' => 'The application id of a mobile application', 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'cortex' => array('desc' => 'Cortex analysis result', 'default_category' => 'External analysis', 'to_ids' => 0),\n\t\t\t'boolean' => array('desc' => 'Boolean value - to be used in objects', 'default_category' => 'Other', 'to_ids' => 0)\n\t\t\t// Not convinced about this.\n\t\t\t//'url-regex' => array('desc' => '', 'default_category' => 'Person', 'to_ids' => 0),\n\t);\n\n\t// definitions of categories\n\tpublic $categoryDefinitions = array(\n\t\t\t'Internal reference' => array(\n\t\t\t\t\t'desc' => 'Reference used by the publishing party (e.g. ticket number)',\n\t\t\t\t\t'types' => array('text', 'link', 'comment', 'other', 'hex')\n\t\t\t\t\t),\n\t\t\t'Targeting data' => array(\n\t\t\t\t\t'desc' => 'Internal Attack Targeting and Compromise Information',\n\t\t\t\t\t'formdesc' => 'Targeting information to include recipient email, infected machines, department, and or locations.',\n\t\t\t\t\t'types' => array('target-user', 'target-email', 'target-machine', 'target-org', 'target-location', 'target-external', 'comment')\n\t\t\t\t\t),\n\t\t\t'Antivirus detection' => array(\n\t\t\t\t\t'desc' => 'All the info about how the malware is detected by the antivirus products',\n\t\t\t\t\t'formdesc' => 'List of anti-virus vendors detecting the malware or information on detection performance (e.g. 13/43 or 67%). Attachment with list of detection or link to VirusTotal could be placed here as well.',\n\t\t\t\t\t'types' => array('link', 'comment', 'text', 'hex', 'attachment', 'other')\n\t\t\t\t\t),\n\t\t\t'Payload delivery' => array(\n\t\t\t\t\t'desc' => 'Information about how the malware is delivered',\n\t\t\t\t\t'formdesc' => 'Information about the way the malware payload is initially delivered, for example information about the email or web-site, vulnerability used, originating IP etc. Malware sample itself should be attached here.',\n\t\t\t\t\t'types' => array('md5', 'sha1', 'sha224', 'sha256', 'sha384', 'sha512', 'sha512/224', 'sha512/256', 'ssdeep', 'imphash', 'impfuzzy','authentihash', 'pehash', 'tlsh', 'filename', 'filename|md5', 'filename|sha1', 'filename|sha224', 'filename|sha256', 'filename|sha384', 'filename|sha512', 'filename|sha512/224', 'filename|sha512/256', 'filename|authentihash', 'filename|ssdeep', 'filename|tlsh', 'filename|imphash','filename|impfuzzy', 'filename|pehash', 'mac-address', 'mac-eui-64', 'ip-src', 'ip-dst', 'ip-dst|port', 'ip-src|port', 'hostname', 'domain', 'email-src', 'email-dst', 'email-subject', 'email-attachment', 'email-body', 'url', 'user-agent', 'AS', 'pattern-in-file', 'pattern-in-traffic', 'stix2-pattern', 'yara', 'sigma', 'mime-type', 'attachment', 'malware-sample', 'link', 'malware-type', 'comment', 'text', 'hex', 'vulnerability', 'x509-fingerprint-sha1', 'x509-fingerprint-md5', 'x509-fingerprint-sha256', 'other', 'hostname|port', 'email-dst-display-name', 'email-src-display-name', 'email-header', 'email-reply-to', 'email-x-mailer', 'email-mime-boundary', 'email-thread-index', 'email-message-id', 'mobile-application-id', 'whois-registrant-email')\n\t\t\t\t\t),\n\t\t\t'Artifacts dropped' => array(\n\t\t\t\t\t'desc' => 'Any artifact (files, registry keys etc.) dropped by the malware or other modifications to the system',\n\t\t\t\t\t'types' => array('md5', 'sha1', 'sha224', 'sha256', 'sha384', 'sha512', 'sha512/224', 'sha512/256', 'ssdeep', 'imphash', 'impfuzzy','authentihash', 'filename', 'filename|md5', 'filename|sha1', 'filename|sha224', 'filename|sha256', 'filename|sha384', 'filename|sha512', 'filename|sha512/224', 'filename|sha512/256', 'filename|authentihash', 'filename|ssdeep', 'filename|tlsh', 'filename|imphash', 'filename|impfuzzy','filename|pehash', 'regkey', 'regkey|value', 'pattern-in-file', 'pattern-in-memory','pdb', 'stix2-pattern', 'yara', 'sigma', 'attachment', 'malware-sample', 'named pipe', 'mutex', 'windows-scheduled-task', 'windows-service-name', 'windows-service-displayname', 'comment', 'text', 'hex', 'x509-fingerprint-sha1', 'x509-fingerprint-md5', 'x509-fingerprint-sha256', 'other', 'cookie', 'gene', 'mime-type')\n\t\t\t\t\t),\n\t\t\t'Payload installation' => array(\n\t\t\t\t\t'desc' => 'Info on where the malware gets installed in the system',\n\t\t\t\t\t'formdesc' => 'Location where the payload was placed in the system and the way it was installed. For example, a filename|md5 type attribute can be added here like this: c:\\\\windows\\\\system32\\\\malicious.exe|41d8cd98f00b204e9800998ecf8427e.',\n\t\t\t\t\t'types' => array('md5', 'sha1', 'sha224', 'sha256', 'sha384', 'sha512', 'sha512/224', 'sha512/256', 'ssdeep', 'imphash','impfuzzy','authentihash', 'pehash', 'tlsh', 'filename', 'filename|md5', 'filename|sha1', 'filename|sha224', 'filename|sha256', 'filename|sha384', 'filename|sha512', 'filename|sha512/224', 'filename|sha512/256', 'filename|authentihash', 'filename|ssdeep', 'filename|tlsh', 'filename|imphash', 'filename|impfuzzy','filename|pehash', 'pattern-in-file', 'pattern-in-traffic', 'pattern-in-memory', 'stix2-pattern', 'yara', 'sigma', 'vulnerability', 'attachment', 'malware-sample', 'malware-type', 'comment', 'text', 'hex', 'x509-fingerprint-sha1', 'x509-fingerprint-md5', 'x509-fingerprint-sha256', 'mobile-application-id', 'other', 'mime-type')\n\t\t\t\t\t),\n\t\t\t'Persistence mechanism' => array(\n\t\t\t\t\t'desc' => 'Mechanisms used by the malware to start at boot',\n\t\t\t\t\t'formdesc' => 'Mechanisms used by the malware to start at boot. This could be a registry key, legitimate driver modification, LNK file in startup',\n\t\t\t\t\t'types' => array('filename', 'regkey', 'regkey|value', 'comment', 'text', 'other', 'hex')\n\t\t\t\t\t),\n\t\t\t'Network activity' => array(\n\t\t\t\t\t'desc' => 'Information about network traffic generated by the malware',\n\t\t\t\t\t'types' => array('ip-src', 'ip-dst', 'ip-dst|port', 'ip-src|port', 'port', 'hostname', 'domain', 'domain|ip', 'mac-address', 'mac-eui-64', 'email-dst', 'url', 'uri', 'user-agent', 'http-method', 'AS', 'snort', 'pattern-in-file', 'stix2-pattern', 'pattern-in-traffic', 'attachment', 'comment', 'text', 'x509-fingerprint-sha1', 'other', 'hex', 'cookie')\n\t\t\t\t\t),\n\t\t\t'Payload type' => array(\n\t\t\t\t\t'desc' => 'Information about the final payload(s)',\n\t\t\t\t\t'formdesc' => 'Information about the final payload(s). Can contain a function of the payload, e.g. keylogger, RAT, or a name if identified, such as Poison Ivy.',\n\t\t\t\t\t'types' => array('comment', 'text', 'other')\n\t\t\t\t\t),\n\t\t\t'Attribution' => array(\n\t\t\t\t\t'desc' => 'Identification of the group, organisation, or country behind the attack',\n\t\t\t\t\t'types' => array('threat-actor', 'campaign-name', 'campaign-id', 'whois-registrant-phone', 'whois-registrant-email', 'whois-registrant-name', 'whois-registrant-org', 'whois-registrar', 'whois-creation-date','comment', 'text', 'x509-fingerprint-sha1','x509-fingerprint-md5', 'x509-fingerprint-sha256', 'other', 'dns-soa-email')\n\t\t\t\t\t),\n\t\t\t'External analysis' => array(\n\t\t\t\t\t'desc' => 'Any other result from additional analysis of the malware like tools output',\n\t\t\t\t\t'formdesc' => 'Any other result from additional analysis of the malware like tools output Examples: pdf-parser output, automated sandbox analysis, reverse engineering report.',\n\t\t\t\t\t'types' => array('md5', 'sha1', 'sha256','filename', 'filename|md5', 'filename|sha1', 'filename|sha256', 'ip-src', 'ip-dst', 'ip-dst|port', 'ip-src|port', 'mac-address', 'mac-eui-64', 'hostname', 'domain', 'domain|ip', 'url', 'user-agent', 'regkey', 'regkey|value', 'AS', 'snort', 'pattern-in-file', 'pattern-in-traffic', 'pattern-in-memory', 'vulnerability', 'attachment', 'malware-sample', 'link', 'comment', 'text', 'x509-fingerprint-sha1', 'x509-fingerprint-md5', 'x509-fingerprint-sha256', 'github-repository', 'other', 'cortex')\n\t\t\t\t\t),\n\t\t\t'Financial fraud' => array(\n\t\t\t\t\t'desc' => 'Financial Fraud indicators',\n\t\t\t\t\t'formdesc' => 'Financial Fraud indicators, for example: IBAN Numbers, BIC codes, Credit card numbers, etc.',\n\t\t\t\t\t'types' => array('btc', 'iban', 'bic', 'bank-account-nr', 'aba-rtn', 'bin', 'cc-number', 'prtn', 'phone-number', 'comment', 'text', 'other', 'hex'),\n\t\t\t\t\t),\n\t\t\t'Support Tool' => array(\n\t\t\t\t\t'desc' => 'Tools supporting analysis or detection of the event',\n\t\t\t\t\t'types' => array('link', 'text', 'attachment', 'comment', 'other', 'hex')\n\t\t\t),\n\t\t\t'Social network' => array(\n\t\t\t\t\t'desc' => 'Social networks and platforms',\n\t\t\t\t\t// email-src and email-dst or should we go with a new email type that is neither / both?\n\t\t\t\t\t'types' => array('github-username', 'github-repository', 'github-organisation', 'jabber-id', 'twitter-id', 'email-src', 'email-dst', 'comment', 'text', 'other', 'whois-registrant-email')\n\t\t\t),\n\t\t\t'Person' => array(\n\t\t\t\t\t'desc' => 'A human being - natural person',\n\t\t\t\t\t'types' => array('first-name', 'middle-name', 'last-name', 'date-of-birth', 'place-of-birth', 'gender', 'passport-number', 'passport-country', 'passport-expiration', 'redress-number', 'nationality', 'visa-number', 'issue-date-of-the-visa', 'primary-residence', 'country-of-residence', 'special-service-request', 'frequent-flyer-number', 'travel-details', 'payment-details', 'place-port-of-original-embarkation', 'place-port-of-clearance', 'place-port-of-onward-foreign-destination', 'passenger-name-record-locator-number', 'comment', 'text', 'other', 'phone-number', 'identity-card-number')\n\t\t\t),\n\t\t\t'Other' => array(\n\t\t\t\t\t'desc' => 'Attributes that are not part of any other category or are meant to be used as a component in MISP objects in the future',\n\t\t\t\t\t'types' => array('comment', 'text', 'other', 'size-in-bytes', 'counter', 'datetime', 'cpe', 'port', 'float', 'hex', 'phone-number', 'boolean')\n\t\t\t\t\t)\n\t);\n\n\t// FIXME we need a better way to list the defaultCategories knowing that new attribute types will continue to appear in the future. We should generate this dynamically or use a function using the default_category of the $typeDefinitions\n\tpublic $defaultCategories = array(\n\t\t\t'md5' => 'Payload delivery',\n\t\t\t'sha1' => 'Payload delivery',\n\t\t\t'sha224' =>'Payload delivery',\n\t\t\t'sha256' => 'Payload delivery',\n\t\t\t'sha384' => 'Payload delivery',\n\t\t\t'sha512' => 'Payload delivery',\n\t\t\t'sha512/224' => 'Payload delivery',\n\t\t\t'sha512/256' => 'Payload delivery',\n\t\t\t'authentihash' => 'Payload delivery',\n\t\t\t'imphash' => 'Payload delivery',\n\t\t\t'impfuzzy'=> 'Payload delivery',\n\t\t\t'pehash' => 'Payload delivery',\n\t\t\t'filename|md5' => 'Payload delivery',\n\t\t\t'filename|sha1' => 'Payload delivery',\n\t\t\t'filename|sha256' => 'Payload delivery',\n\t\t\t'regkey' => 'Persistence mechanism',\n\t\t\t'filename' => 'Payload delivery',\n\t\t\t'ip-src' => 'Network activity',\n\t\t\t'ip-dst' => 'Network activity',\n\t\t\t'ip-dst|port' => 'Network activity',\n\t\t\t'mac-address' => 'Network activity',\n\t\t\t'mac-eui-64' => 'Network activity',\n\t\t\t'hostname' => 'Network activity',\n\t\t\t'domain' => 'Network activity',\n\t\t\t'url' => 'Network activity',\n\t\t\t'link' => 'External analysis',\n\t\t\t'email-src' => 'Payload delivery',\n\t\t\t'email-dst' => 'Payload delivery',\n\t\t\t'text' => 'Other',\n\t\t\t'hex' => 'Other',\n\t\t\t'attachment' => 'External analysis',\n\t\t\t'malware-sample' => 'Payload delivery',\n\t\t\t'cortex' => 'External analysis',\n\t\t\t'dns-soa-email' => 'Attribution',\n\t\t\t'boolean' => 'Other'\n\t);\n\n\t// typeGroupings are a mapping to high level groups for attributes\n\t// for example, IP addresses, domain names, hostnames and e-mail addresses are network related attribute types\n\t// whilst filenames and hashes are file related attribute types\n\t// This helps generate quick filtering for the event view, but we may reuse this and enhance it in the future for other uses (such as the API?)\n\tpublic $typeGroupings = array(\n\t\t'file' => array('attachment', 'pattern-in-file', 'md5', 'sha1', 'sha224', 'sha256', 'sha384', 'sha512', 'sha512/224', 'sha512/256', 'ssdeep', 'imphash', 'impfuzzy','authentihash', 'pehash', 'tlsh', 'filename', 'filename|md5', 'filename|sha1', 'filename|sha224', 'filename|sha256', 'filename|sha384', 'filename|sha512', 'filename|sha512/224', 'filename|sha512/256', 'filename|authentihash', 'filename|ssdeep', 'filename|tlsh', 'filename|imphash', 'filename|pehash', 'malware-sample', 'x509-fingerprint-sha1', 'x509-fingerprint-sha256', 'x509-fingerprint-md5'),\n        'network' => array('ip-src', 'ip-dst', 'ip-src|port', 'ip-dst|port', 'mac-address', 'mac-eui-64', 'hostname', 'hostname|port', 'domain', 'domain|ip', 'email-dst', 'url', 'uri', 'user-agent', 'http-method', 'AS', 'snort', 'pattern-in-traffic', 'x509-fingerprint-md5', 'x509-fingerprint-sha1', 'x509-fingerprint-sha256'),\n        'financial' => array('btc', 'iban', 'bic', 'bank-account-nr', 'aba-rtn', 'bin', 'cc-number', 'prtn', 'phone-number')\n\t);\n\n\tpublic $order = array(\"Attribute.event_id\" => \"DESC\");\n\n\tpublic $validate = array(\n\t\t'event_id' => array(\n\t\t\t'numeric' => array(\n\t\t\t\t'rule' => array('numeric'),\n\t\t\t\t//'message' => 'Your custom message here',\n\t\t\t\t//'allowEmpty' => false,\n\t\t\t\t//'required' => false,\n\t\t\t\t//'last' => false, // Stop validation after this rule\n\t\t\t\t//'on' => 'create', // Limit validation to 'create' or 'update' operations\n\t\t\t),\n\t\t),\n\t\t'type' => array(\n\t\t\t// currently when adding a new attribute type we need to change it in both places\n\t\t\t'rule' => array('validateTypeValue'),\n\t\t\t'message' => 'Options depend on the selected category.',\n\t\t\t//'allowEmpty' => false,\n\t\t\t'required' => true,\n\t\t\t//'last' => false, // Stop validation after this rule\n\t\t\t//'on' => 'create', // Limit validation to 'create' or 'update' operations\n\n\t\t),\n\t\t// this could be initialized from categoryDefinitions but dunno how at the moment\n\t\t'category' => array(\n\t\t\t'rule' => array('validCategory'),\n\t\t\t'message' => 'Options : Payload delivery, Antivirus detection, Payload installation, Files dropped ...'\n\t\t),\n\t\t'value' => array(\n\t\t\t'valueNotEmpty' => array(\n\t\t\t\t'rule' => array('valueNotEmpty'),\n\t\t\t),\n\t\t\t'userdefined' => array(\n\t\t\t\t'rule' => array('validateAttributeValue'),\n\t\t\t\t'message' => 'Value not in the right type/format. Please double check the value or select type \"other\".',\n\t\t\t\t//'allowEmpty' => false,\n\t\t\t\t//'required' => true,\n\t\t\t\t//'last' => false, // Stop validation after this rule\n\t\t\t\t//'on' => 'create', // Limit validation to 'create' or 'update' operations\n\t\t\t),\n\t\t\t'uniqueValue' => array(\n\t\t\t\t\t'rule' => array('valueIsUnique'),\n\t\t\t\t\t'message' => 'A similar attribute already exists for this event.',\n\t\t\t\t\t//'allowEmpty' => false,\n\t\t\t\t\t//'required' => true,\n\t\t\t\t\t//'last' => false, // Stop validation after this rule\n\t\t\t\t\t//'on' => 'create', // Limit validation to 'create' or 'update' operations\n\t\t\t),\n\t\t\t'validComposite' => array(\n\t\t\t\t'rule' => array('validComposite'),\n\t\t\t\t'message' => 'Composite type found but the value not in the composite (value1|value2) format.'\n\t\t\t)\n\t\t),\n\t\t'to_ids' => array(\n\t\t\t'boolean' => array(\n\t\t\t\t'rule' => array('boolean'),\n\t\t\t\t//'message' => 'Your custom message here',\n\t\t\t\t//'allowEmpty' => false,\n\t\t\t\t'required' => false,\n\t\t\t\t//'last' => false, // Stop validation after this rule\n\t\t\t\t//'on' => 'create', // Limit validation to 'create' or 'update' operations\n\t\t\t),\n\t\t),\n\t\t'uuid' => array(\n\t\t\t'uuid' => array(\n\t\t\t\t'rule' => array('custom', '/^[a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12}$/'),\n\t\t\t\t'message' => 'Please provide a valid UUID'\n\t\t\t),\n\t\t\t'unique' => array(\n\t\t\t\t'rule' => 'isUnique',\n\t\t\t\t'message' => 'The UUID provided is not unique',\n\t\t\t\t'required' => 'create'\n\t\t\t)\n\t\t),\n\t\t'distribution' => array(\n\t\t\t\t'rule' => array('inList', array('0', '1', '2', '3', '4', '5')),\n\t\t\t\t'message' => 'Options: Your organisation only, This community only, Connected communities, All communities, Sharing group, Inherit event',\n\t\t\t\t//'allowEmpty' => false,\n\t\t\t\t'required' => true,\n\t\t\t\t//'last' => false, // Stop validation after this rule\n\t\t\t\t//'on' => 'create', // Limit validation to 'create' or 'update' operations\n\t\t),\n\t);\n\n\t// automatic resolution of complex types\n\t// If the complex type \"file\" is chosen for example, then the system will try to categorise the values entered into a complex template field based\n\t// on the regular expression rules\n\tpublic $validTypeGroups = array(\n\t\t\t'File' => array(\n\t\t\t\t'description' => '',\n\t\t\t\t'types' => array('filename', 'filename|md5', 'filename|sha1', 'filename|sha256', 'md5', 'sha1', 'sha256'),\n\t\t\t),\n\t\t\t'CnC' => array(\n\t\t\t\t'description' => '',\n\t\t\t\t'types' => array('url', 'domain', 'hostname', 'ip-dst'),\n\t\t\t),\n\t);\n\n\tpublic $typeGroupCategoryMapping = array(\n\t\t\t'Payload delivery' => array('File', 'CnC'),\n\t\t\t'Payload installation' => array('File'),\n\t\t\t'Artifacts dropped' => array('File'),\n\t\t\t'Network activity' => array('CnC'),\n\t);\n\n\tpublic function __construct($id = false, $table = null, $ds = null) {\n\t\tparent::__construct($id, $table, $ds);\n\t}\n\n\tpublic $belongsTo = array(\n\t\t'Event' => array(\n\t\t\t'className' => 'Event',\n\t\t\t'foreignKey' => 'event_id',\n\t\t\t'conditions' => '',\n\t\t\t'fields' => '',\n\t\t\t//'counterCache' => 'attribute_count',\n\t\t\t//'counterScope' => array('Attribute.deleted' => 0),\n\t\t\t'order' => ''\n\t\t),\n\t\t'SharingGroup' => array(\n\t\t\t\t'className' => 'SharingGroup',\n\t\t\t\t'foreignKey' => 'sharing_group_id'\n\t\t),\n\t\t'Object' => array(\n\t\t\t'className' => 'MispObject',\n\t\t\t'foreignKey' => 'object_id'\n\t\t)\n\t);\n\n\tpublic $hasMany = array(\n\t\t'AttributeTag' => array(\n\t\t\t'dependent' => true\n\t\t),\n\t\t'Sighting' => array(\n\t\t\t\t'className' => 'Sighting',\n\t\t\t\t'dependent' => true,\n\t\t)\n\t);\n\n\tpublic $hashTypes = array(\n\t\t'md5' => array(\n\t\t\t'length' => 32,\n\t\t\t'pattern' => '#^[0-9a-f]{32}$#',\n\t\t\t'lowerCase' => true,\n\t\t),\n\t\t'sha1' => array(\n\t\t\t'length' => 40,\n\t\t\t'pattern' => '#^[0-9a-f]{40}$#',\n\t\t\t'lowerCase' => true,\n\t\t),\n\t\t'sha256' => array(\n\t\t\t'length' => 64,\n\t\t\t'pattern' => '#^[0-9a-f]{64}$#',\n\t\t\t'lowerCase' => true,\n\t\t)\n\t);\n\n\tpublic function afterFind($results, $primary = false) {\n\t\tforeach ($results as $k => $v) {\n\t\t\tif (isset($v['Attribute']['object_relation']) && $v['Attribute']['object_relation'] === null) {\n\t\t\t\t$results[$k]['Attribute']['object_relation'] = '';\n\t\t\t}\n\t\t}\n\t\treturn $results;\n\t}\n\n\tpublic function beforeSave($options = array()) {\n\t\t// explode value of composite type in value1 and value2\n\t\t// or copy value to value1 if not composite type\n\t\tif (!empty($this->data['Attribute']['type'])) {\n\t\t\t$compositeTypes = $this->getCompositeTypes();\n\t\t\t// explode composite types in value1 and value2\n\t\t\tif (in_array($this->data['Attribute']['type'], $compositeTypes)) {\n\t\t\t\t$pieces = explode('|', $this->data['Attribute']['value']);\n\t\t\t\tif (2 != count($pieces)) {\n\t\t\t\t\tthrow new InternalErrorException('Composite type, but value not explodable');\n\t\t\t\t}\n\t\t\t\t$this->data['Attribute']['value1'] = $pieces[0];\n\t\t\t\t$this->data['Attribute']['value2'] = $pieces[1];\n\t\t\t} else {\n\t\t\t\t$this->data['Attribute']['value1'] = $this->data['Attribute']['value'];\n\t\t\t\t$this->data['Attribute']['value2'] = '';\n\t\t\t}\n\t\t}\n\n\t\t// update correlation... (only needed here if there's an update)\n\t\tif ($this->id || !empty($this->data['Attribute']['id'])) {\n\t\t\t$this->__beforeSaveCorrelation($this->data['Attribute']);\n\t\t}\n\t\t// always return true after a beforeSave()\n\t\treturn true;\n\t}\n\n\tprivate function __alterAttributeCount($event_id, $increment = true) {\n\t\t$event = $this->Event->find('first', array(\n\t\t\t'recursive' => -1,\n\t\t\t'conditions' => array('Event.id' => $event_id)\n\t\t));\n\t\tif (!empty($event)) {\n\t\t\tif ($increment) $event['Event']['attribute_count'] = $event['Event']['attribute_count'] + 1;\n\t\t\telse $event['Event']['attribute_count'] = $event['Event']['attribute_count'] - 1;\n\t\t\tif ($event['Event']['attribute_count'] >= 0) {\n\t\t\t\t$this->Event->save($event, array('callbacks' => false));\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic function afterSave($created, $options = array()) {\n\t\tparent::afterSave($created, $options);\n\t\t// update correlation...\n\t\tif (isset($this->data['Attribute']['deleted']) && $this->data['Attribute']['deleted']) {\n\t\t\t$this->__beforeSaveCorrelation($this->data['Attribute']);\n\t\t\tif (isset($this->data['Attribute']['event_id'])) $this->__alterAttributeCount($this->data['Attribute']['event_id'], false);\n\t\t} else {\n\t\t\t$this->__afterSaveCorrelation($this->data['Attribute']);\n\t\t}\n\t\tif (Configure::read('Plugin.ZeroMQ_enable') && Configure::read('Plugin.ZeroMQ_attribute_notifications_enable')) {\n\t\t\t$pubSubTool = $this->getPubSubTool();\n\t\t\t$attribute = $this->fetchAttribute($this->id);\n\t\t\tif (!empty($attribute)) {\n\t\t\t\t$user = array(\n\t\t\t\t\t'org_id' => -1,\n\t\t\t\t\t'Role' => array(\n\t\t\t\t\t\t'perm_site_admin' => 1\n\t\t\t\t\t)\n\t\t\t\t);\n\t\t\t\t$attribute['Attribute']['Sighting'] = $this->Sighting->attachToEvent($attribute, $user, $this->id);\n\t\t\t\tif (empty($attribute['Object']['id'])) unset($attribute['Object']);\n\t\t\t\t$action = $created ? 'add' : 'edit';\n\t\t\t\tif (!empty($this->data['Attribute']['deleted'])) $action = 'soft-delete';\n\t\t\t\t$pubSubTool->attribute_save($attribute, $action);\n\t\t\t}\n\t\t}\n\t\tif (Configure::read('MISP.enable_advanced_correlations') && in_array($this->data['Attribute']['type'], array('ip-src', 'ip-dst', 'domain-ip')) && strpos($this->data['Attribute']['value'], '/')) {\n\t\t\t$this->setCIDRList();\n\t\t}\n\t\t$result = true;\n\t\t// if the 'data' field is set on the $this->data then save the data to the correct file\n\t\tif (isset($this->data['Attribute']['type']) && $this->typeIsAttachment($this->data['Attribute']['type']) && !empty($this->data['Attribute']['data'])) {\n\t\t\t$result = $result && $this->saveBase64EncodedAttachment($this->data['Attribute']); // TODO : is this correct?\n\t\t}\n\t\tif ($created && isset($this->data['Attribute']['event_id']) && empty($this->data['Attribute']['skip_auto_increment'])) {\n\t\t\t$this->__alterAttributeCount($this->data['Attribute']['event_id']);\n\t\t}\n\t\treturn $result;\n\t}\n\n\tpublic function beforeDelete($cascade = true) {\n\t\t// delete attachments from the disk\n\t\t$this->read(); // first read the attribute from the db\n\t\tif ($this->typeIsAttachment($this->data['Attribute']['type'])) {\n\t\t\t// only delete the file if it exists\n\t\t\t$attachments_dir = Configure::read('MISP.attachments_dir');\n\t\t\tif (empty($attachments_dir)) {\n\t\t\t\t$my_server = ClassRegistry::init('Server');\n\t\t\t\t$attachments_dir = $my_server->getDefaultAttachments_dir();\n\t\t\t}\n\t\t\t$filepath = $attachments_dir . DS . $this->data['Attribute']['event_id'] . DS . $this->data['Attribute']['id'];\n\t\t\t$file = new File($filepath);\n\t\t\tif ($file->exists()) {\n\t\t\t\tif (!$file->delete()) {\n\t\t\t\t\tthrow new InternalErrorException('Delete of file attachment failed. Please report to administrator.');\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t// update correlation..\n\t\t$this->__beforeDeleteCorrelation($this->data['Attribute']['id']);\n\t\tif (!empty($this->data['Attribute']['id'])) {\n\t\t\tif (Configure::read('Plugin.ZeroMQ_enable') && Configure::read('Plugin.ZeroMQ_attribute_notifications_enable')) {\n\t\t\t\t$pubSubTool = $this->getPubSubTool();\n\t\t\t\t$pubSubTool->attribute_save($this->data, 'delete');\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic function afterDelete() {\n\t\tif (Configure::read('MISP.enable_advanced_correlations') && in_array($this->data['Attribute']['type'], array('ip-src', 'ip-dst', 'domain-ip')) && strpos($this->data['Attribute']['value'], '/')) {\n\t\t\t$this->setCIDRList();\n\t\t}\n\t\tif (isset($this->data['Attribute']['event_id'])) {\n\t\t\tif (empty($this->data['Attribute']['deleted'])) $this->__alterAttributeCount($this->data['Attribute']['event_id'], false);\n\t\t}\n\t\tif (!empty($this->data['Attribute']['id'])) {\n\t\t\t$this->Object->ObjectReference->deleteAll(\n\t\t\t\tarray(\n\t\t\t\t\t'ObjectReference.referenced_type' => 0,\n\t\t\t\t\t'ObjectReference.referenced_id' => $this->data['Attribute']['id'],\n\t\t\t\t),\n\t\t\t\tfalse\n\t\t\t);\n\t\t}\n\t}\n\n\tpublic function beforeValidate($options = array()) {\n\t\tparent::beforeValidate();\n\n\t\tif (!isset($this->data['Attribute']['type'])) {\n\t\t\treturn false;\n\t\t}\n\t\tif (is_array($this->data['Attribute']['value'])) {\n\t\t\treturn false;\n\t\t}\n\t\t// remove leading and trailing blanks\n\t\t$this->data['Attribute']['value'] = trim($this->data['Attribute']['value']);\n\n\t\t// make some last changes to the inserted value\n\t\t$this->data['Attribute']['value'] = $this->modifyBeforeValidation($this->data['Attribute']['type'], $this->data['Attribute']['value']);\n\n\t\t// set to_ids if it doesn't exist\n\t\tif (empty($this->data['Attribute']['to_ids'])) {\n\t\t\t$this->data['Attribute']['to_ids'] = 0;\n\t\t}\n\n\t\tif (empty($this->data['Attribute']['comment'])) {\n\t\t\t$this->data['Attribute']['comment'] = \"\";\n\t\t}\n\t\t// generate UUID if it doesn't exist\n\t\tif (empty($this->data['Attribute']['uuid'])) {\n\t\t\t$this->data['Attribute']['uuid'] = CakeText::uuid();\n\t\t}\n\t\t// generate timestamp if it doesn't exist\n\t\tif (empty($this->data['Attribute']['timestamp'])) {\n\t\t\t$date = new DateTime();\n\t\t\t$this->data['Attribute']['timestamp'] = $date->getTimestamp();\n\t\t}\n\t\t// TODO: add explanatory comment\n\t\t$result = $this->runRegexp($this->data['Attribute']['type'], $this->data['Attribute']['value']);\n\t\tif ($result === false) {\n\t\t\t$this->invalidate('value', 'This value is blocked by a regular expression in the import filters.');\n\t\t} else {\n\t\t\t$this->data['Attribute']['value'] = $result;\n\t\t}\n\n\t\t// Set defaults for when some of the mandatory fields don't have defaults\n\t\t// These fields all have sane defaults either based on another field, or due to server settings\n\t\tif (!isset($this->data['Attribute']['distribution'])) {\n\t\t\t$this->data['Attribute']['distribution'] = Configure::read('MISP.default_attribute_distribution');\n\t\t\tif ($this->data['Attribute']['distribution'] == 'event') {\n\t\t\t\t$this->data['Attribute']['distribution'] = 5;\n\t\t\t}\n\t\t}\n\n\t\tif (!empty($this->data['Attribute']['type']) && empty($this->data['Attribute']['category'])) {\n\t\t\t$this->data['Attribute']['category'] = $this->typeDefinitions[$this->data['Attribute']['type']]['default_category'];\n\t\t}\n\n\t\tif (!isset($this->data['Attribute']['to_ids'])) {\n\t\t\t$this->data['Attribute']['to_ids'] = $this->typeDefinitions[$this->data['Attribute']['type']]['to_ids'];\n\t\t}\n\n\t\tif ($this->data['Attribute']['distribution'] != 4) $this->data['Attribute']['sharing_group_id'] = 0;\n\t\t// return true, otherwise the object cannot be saved\n\n\t\tif ($this->data['Attribute']['type'] == 'float' && $this->data['Attribute']['value'] == 0) $this->data['Attribute']['value'] = '0.0';\n\t\treturn true;\n\t}\n\n\tpublic function validComposite($fields) {\n\t\t$compositeTypes = $this->getCompositeTypes();\n\t\tif (in_array($this->data['Attribute']['type'], $compositeTypes)) {\n\t\t\t$pieces = explode('|', $fields['value']);\n\t\t\tif (2 != count($pieces)) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n\n\tpublic function validCategory($fields) {\n\t\t$validCategories = array_keys($this->categoryDefinitions);\n\t\tif (in_array($fields['category'], $validCategories)) return true;\n\t\treturn false;\n\t}\n\n\t\tpublic function valueIsUnique ($fields) {\n\t\tif (isset($this->data['Attribute']['deleted']) && $this->data['Attribute']['deleted']) return true;\n\t\t// We escape this rule for objects as we can have the same category/type/value combination in different objects\n\t\tif (!empty($this->data['Attribute']['object_relation'])) {\n\t\t\treturn true;\n\t\t}\n\t\t$value = $fields['value'];\n\t\tif (strpos($value, '|')) {\n\t\t\t$value = explode('|', $value);\n\t\t\t$value = array(\n\t\t\t\t'Attribute.value1' => $value[0],\n\t\t\t\t'Attribute.value2' => $value[1]\n\t\t\t);\n\t\t} else {\n\t\t\t$value = array(\n\t\t\t\t'Attribute.value1' => $value,\n\t\t\t);\n\t\t}\n\t\t$eventId = $this->data['Attribute']['event_id'];\n\t\t$type = $this->data['Attribute']['type'];\n\t\t$category = $this->data['Attribute']['category'];\n\n\t\t// check if the attribute already exists in the same event\n\t\t$conditions = array(\n\t\t\t'Attribute.event_id' => $eventId,\n\t\t\t'Attribute.type' => $type,\n\t\t\t'Attribute.category' => $category,\n\t\t\t'Attribute.deleted' => 0\n\t\t);\n\t\t$conditions = array_merge ($conditions, $value);\n\t\tif (isset($this->data['Attribute']['id'])) {\n\t\t\t$conditions['Attribute.id !='] = $this->data['Attribute']['id'];\n\t\t}\n\n\t\t$params = array(\n\t\t\t'recursive' => -1,\n\t\t\t'fields' => array('id'),\n\t\t\t'conditions' => $conditions,\n\t\t);\n\t\tif (!empty($this->find('first', $params))) {\n\t\t\t// value isn't unique\n\t\t\treturn false;\n\t\t}\n\t\t// value is unique\n\t\treturn true;\n\t}\n\n\tpublic function validateTypeValue($fields) {\n\t\t$category = $this->data['Attribute']['category'];\n\t\tif (isset($this->categoryDefinitions[$category]['types'])) {\n\t\t\treturn in_array($fields['type'], $this->categoryDefinitions[$category]['types']);\n\t\t}\n\t\treturn false;\n\t}\n\n\tpublic function validateAttributeValue($fields) {\n\t\t$value = $fields['value'];\n\t\treturn $this->runValidation($value, $this->data['Attribute']['type']);\n\t}\n\n\tprivate $__hexHashLengths = array(\n\t\t\t'authentihash' => 64,\n\t\t\t'md5' => 32,\n\t\t\t'imphash' => 32,\n\t\t\t'sha1' => 40,\n            'x509-fingerprint-md5' => 32,\n\t\t\t'x509-fingerprint-sha1' => 40,\n            'x509-fingerprint-sha256' => 64,\n\t\t\t'pehash' => 40,\n\t\t\t'sha224' => 56,\n\t\t\t'sha256' => 64,\n\t\t\t'sha384' => 96,\n\t\t\t'sha512' => 128,\n\t\t\t'sha512/224' => 56,\n\t\t\t'sha512/256' => 64,\n\t);\n\n\tpublic function runValidation($value, $type) {\n\t\t$returnValue = false;\n\t\t// check data validation\n\t\tswitch ($type) {\n\t\t\tcase 'md5':\n\t\t\tcase 'imphash':\n\t\t\tcase 'sha1':\n\t\t\tcase 'sha224':\n\t\t\tcase 'sha256':\n\t\t\tcase 'sha384':\n\t\t\tcase 'sha512':\n\t\t\tcase 'sha512/224':\n\t\t\tcase 'sha512/256':\n\t\t\tcase 'authentihash':\n            case 'x509-fingerprint-md5':\n            case 'x509-fingerprint-sha256':\n\t\t\tcase 'x509-fingerprint-sha1':\n\t\t\t\t$length = $this->__hexHashLengths[$type];\n\t\t\t\tif (preg_match(\"#^[0-9a-f]{\" . $length . \"}$#\", $value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t} else {\n\t\t\t\t\t$returnValue = 'Checksum has an invalid length or format (expected: ' . $length . ' hexadecimal characters). Please double check the value or select type \"other\".';\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'tlsh':\n\t\t\t\tif (preg_match(\"#^[0-9a-f]{35,}$#\", $value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t} else {\n\t\t\t\t\t$returnValue = 'Checksum has an invalid length or format (expected: at least 35 hexadecimal characters). Please double check the value or select type \"other\".';\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'pehash':\n\t\t\t\tif (preg_match(\"#^[0-9a-f]{40}$#\", $value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t} else {\n\t\t\t\t\t$returnValue = 'The input doesn\\'t match the expected sha1 format (expected: 40 hexadecimal characters). Keep in mind that MISP currently only supports SHA1 for PEhashes, if you would like to get the support extended to other hash types, make sure to create a github ticket about it at https://github.com/MISP/MISP!';\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'ssdeep':\n\t\t\t\tif (substr_count($value, ':') == 2) {\n\t\t\t\t\t$parts = explode(':', $value);\n\t\t\t\t\tif (is_numeric($parts[0])) $returnValue = true;\n\t\t\t\t}\n\t\t\t\tif (!$returnValue) $returnValue = 'Invalid SSDeep hash. The format has to be blocksize:hash:hash';\n\t\t\t\tbreak;\n\t\t\tcase 'http-method':\n\t\t\t\tif (preg_match(\"#(OPTIONS|GET|HEAD|POST|PUT|DELETE|TRACE|CONNECT|PROPFIND|PROPPATCH|MKCOL|COPY|MOVE|LOCK|UNLOCK|VERSION-CONTROL|REPORT|CHECKOUT|CHECKIN|UNCHECKOUT|MKWORKSPACE|UPDATE|LABEL|MERGE|BASELINE-CONTROL|MKACTIVITY|ORDERPATCH|ACL|PATCH|SEARCH)#\", $value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t} else {\n\t\t\t\t\t$returnValue = 'Unknown HTTP method.';\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'filename|pehash':\n\t\t\t\t// no newline\n\t\t\t\tif (preg_match(\"#^.+\\|[0-9a-f]{40}$#\", $value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t} else {\n\t\t\t\t\t$returnValue = 'The input doesn\\'t match the expected filename|sha1 format (expected: filename|40 hexadecimal characters). Keep in mind that MISP currently only supports SHA1 for PEhashes, if you would like to get the support extended to other hash types, make sure to create a github ticket about it at https://github.com/MISP/MISP!';\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'filename|md5':\n\t\t\tcase 'filename|sha1':\n\t\t\tcase 'filename|imphash':\n\t\t\tcase 'filename|sha224':\n\t\t\tcase 'filename|sha256':\n\t\t\tcase 'filename|sha384':\n\t\t\tcase 'filename|sha512':\n\t\t\tcase 'filename|sha512/224':\n\t\t\tcase 'filename|sha512/256':\n\t\t\tcase 'filename|authentihash':\n\t\t\t\t$parts = explode('|', $type);\n\t\t\t\t$length = $this->__hexHashLengths[$parts[1]];\n\t\t\t\tif (preg_match(\"#^.+\\|[0-9a-f]{\" . $length . \"}$#\", $value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t} else {\n\t\t\t\t\t$returnValue = 'Checksum has an invalid length or format (expected: filename|' . $length . ' hexadecimal characters). Please double check the value or select type \"other\".';\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'filename|ssdeep':\n\t\t\t\tif (substr_count($value, '|') != 1 || !preg_match(\"#^.+\\|.+$#\", $value)) {\n\t\t\t\t\t$returnValue = 'Invalid composite type. The format has to be ' . $type . '.';\n\t\t\t\t} else {\n\t\t\t\t\t$composite = explode('|', $value);\n\t\t\t\t\t$value = $composite[1];\n\t\t\t\t\tif (substr_count($value, ':') == 2) {\n\t\t\t\t\t\t$parts = explode(':', $value);\n\t\t\t\t\t\tif (is_numeric($parts[0])) $returnValue = true;\n\t\t\t\t\t}\n\t\t\t\t\tif (!$returnValue) $returnValue = 'Invalid SSDeep hash (expected: blocksize:hash:hash).';\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'filename|tlsh':\n\t\t\t\tif (preg_match(\"#^.+\\|[0-9a-f]{35,}$#\", $value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t} else {\n\t\t\t\t\t$returnValue = 'Checksum has an invalid length or format (expected: filename|at least 35 hexadecimal characters). Please double check the value or select type \"other\".';\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'ip-src':\n\t\t\tcase 'ip-dst':\n\t\t\t\t$returnValue = true;\n\t\t\t\tif (strpos($value, '/') !== false) {\n\t\t\t\t\t$parts = explode(\"/\", $value);\n\t\t\t\t\t// [0] = the IP\n\t\t\t\t\t// [1] = the network address\n\t\t\t\t\tif (count($parts) != 2 || (!is_numeric($parts[1]) || !($parts[1] < 129 && $parts[1] > 0))) {\n\t\t\t\t\t\t\t$returnValue = 'Invalid CIDR notation value found.';\n\t\t\t\t\t}\n\t\t\t\t\t$ip = $parts[0];\n\t\t\t\t} else {\n\t\t\t\t\t$ip = $value;\n\t\t\t\t}\n\t\t\t\tif (!filter_var($ip, FILTER_VALIDATE_IP)) {\n\t\t\t\t\t$returnValue = 'IP address has an invalid format.';\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'port':\n\t\t\t\tif (!is_numeric($value) || $value < 1 || $value > 65535) {\n\t\t\t\t\t$returnValue = 'Port numbers have to be positive integers between 1 and 65535.';\n\t\t\t\t} else {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'ip-dst|port':\n\t\t\tcase 'ip-src|port':\n\t\t\t\t$parts = explode('|', $value);\n\t\t\t\tif (filter_var($parts[0], FILTER_VALIDATE_IP)) {\n\t\t\t\t\tif (!is_numeric($parts[1]) || $parts[1] > 1 || $parts[1] < 65536) {\n\t\t\t\t\t\t$returnValue = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'mac-address':\n\t\t\t\tif (preg_match('/^([a-fA-F0-9]{2}[:|\\-| |\\.]?){6}$/', $value) == 1) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'mac-eui-64':\n\t\t\t\tif (preg_match('/^([a-fA-F0-9]{2}[:|\\-| |\\.]?){8}$/', $value) == 1) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'hostname':\n\t\t\tcase 'domain':\n\t\t\t\tif (preg_match(\"#^[A-Z0-9.\\-_]+\\.[A-Z0-9\\-]{2,}$#i\", $value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t} else {\n\t\t\t\t\t$returnValue = 'Domain name has an invalid format. Please double check the value or select type \"other\".';\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'hostname|port':\n\t\t\t\t$parts = explode('|', $value);\n\t\t\t\tif (preg_match(\"#^[A-Z0-9.\\-_]+\\.[A-Z0-9\\-]{2,}$#i\", $parts[0])) {\n\t\t\t\t\tif (!is_numeric($parts[1]) || $parts[1] > 1 || $parts[1] < 65536) {\n\t\t\t\t\t\t$returnValue = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'domain|ip':\n\t\t\t\tif (preg_match(\"#^[A-Z0-9.\\-_]+\\.[A-Z0-9\\-]{2,}\\|.*$#i\", $value)) {\n\t\t\t\t\t$parts = explode('|', $value);\n\t\t\t\t\tif (filter_var($parts[1], FILTER_VALIDATE_IP)) {\n\t\t\t\t\t\t$returnValue = true;\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$returnValue = 'IP address has an invalid format.';\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t$returnValue = 'Domain name has an invalid format.';\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'email-src':\n\t\t\tcase 'email-dst':\n\t\t\tcase 'target-email':\n\t\t\tcase 'whois-registrant-email':\n\t\t\tcase 'dns-soa-email':\n\t\t\tcase 'jabber-id':\n\t\t\t\t// we don't use the native function to prevent issues with partial email addresses\n\t\t\t\tif (preg_match(\"#^.*\\@.*\\..*$#i\", $value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t} else {\n\t\t\t\t\t$returnValue = 'Email address has an invalid format. Please double check the value or select type \"other\".';\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'vulnerability':\n\t\t\t\t$value = str_replace('\u2013', '-', $value);\n\t\t\t\tif (preg_match(\"#^(CVE-)[0-9]{4}(-)[0-9]{4,6}$#\", $value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t} else {\n\t\t\t\t\t$returnValue = 'Invalid format. Expected: CVE-xxxx-xxxx.';\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'named pipe':\n\t\t\t\tif (!preg_match(\"#\\n#\", $value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'windows-service-name':\n\t\t\tcase 'windows-service-displayname':\n\t\t\t\tif (strlen($value) > 256 || preg_match('#[\\\\\\/]#', $value)) {\n\t\t\t\t\t$returnValue = 'Invalid format. Only values shorter than 256 characters that don\\'t include any forward or backward slashes are allowed.';\n\t\t\t\t} else {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'mutex':\n\t\t\tcase 'AS':\n\t\t\tcase 'snort':\n\t\t\tcase 'pattern-in-file':\n\t\t\tcase 'pattern-in-traffic':\n\t\t\tcase 'pattern-in-memory':\n            case 'yara':\n            case 'stix2-pattern':\n            case 'sigma':\n            case 'gene':\n            case 'mime-type':\n            case 'identity-card-number':\n\t\t\tcase 'cookie':\n\t\t\tcase 'attachment':\n\t\t\tcase 'malware-sample':\n\t\t\t\t$returnValue = true;\n\t\t\t\tbreak;\n\t\t\tcase 'link':\n\t\t\t\t// Moved to a native function whilst still enforcing the scheme as a requirement\n\t\t\t\tif (filter_var($value, FILTER_VALIDATE_URL, FILTER_FLAG_SCHEME_REQUIRED) && !preg_match(\"#\\n#\", $value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'comment':\n\t\t\tcase 'text':\n\t\t\tcase 'other':\n\t\t\tcase 'email-attachment':\n\t\t\tcase 'email-body':\n\t\t\t\t$returnValue = true;\n\t\t\t\tbreak;\n\t\t\tcase 'hex':\n\t\t\t\tif (preg_match(\"/^[0-9a-f]*$/i\", $value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'target-user':\n\t\t\tcase 'campaign-name':\n\t\t\tcase 'campaign-id':\n\t\t\tcase 'threat-actor':\n\t\t\tcase 'target-machine':\n\t\t\tcase 'target-org':\n\t\t\tcase 'target-location':\n\t\t\tcase 'target-external':\n\t\t\tcase 'email-subject':\n\t\t\tcase 'malware-type':\n\t\t\t// TODO: review url/uri validation\n\t\t\tcase 'url':\n\t\t\tcase 'uri':\n\t\t\tcase 'user-agent':\n\t\t\tcase 'regkey':\n\t\t\tcase 'regkey|value':\n\t\t\tcase 'filename':\n\t\t\tcase 'pdb':\n\t\t\tcase 'windows-scheduled-task':\n      case 'whois-registrant-name':\n      case 'whois-registrant-org':\n\t\t\tcase 'whois-registrar':\n\t\t\tcase 'whois-creation-date':\n\t\t\tcase 'first-name':\n\t\t\tcase 'middle-name':\n\t\t\tcase 'last-name':\n\t\t\tcase 'date-of-birth':\n\t\t\tcase 'place-of-birth':\n\t\t\tcase 'gender':\n\t\t\tcase 'passport-number':\n\t\t\tcase 'passport-country':\n\t\t\tcase 'passport-expiration':\n\t\t\tcase 'redress-number':\n\t\t\tcase 'nationality':\n\t\t\tcase 'visa-number':\n\t\t\tcase 'issue-date-of-the-visa':\n\t\t\tcase 'primary-residence':\n\t\t\tcase 'country-of-residence':\n\t\t\tcase 'special-service-request':\n\t\t\tcase 'frequent-flyer-number':\n\t\t\tcase 'travel-details':\n\t\t\tcase 'payment-details':\n\t\t\tcase 'place-port-of-original-embarkation':\n\t\t\tcase 'place-port-of-clearance':\n\t\t\tcase 'place-port-of-onward-foreign-destination':\n\t\t\tcase 'passenger-name-record-locator-number':\n\t\t\tcase 'email-dst-display-name':\n\t\t\tcase 'email-src-display-name':\n\t\t\tcase 'email-reply-to':\n\t\t\tcase 'email-x-mailer':\n\t\t\tcase 'email-mime-boundary':\n\t\t\tcase 'email-thread-index':\n\t\t\tcase 'email-message-id':\n\t\t\tcase 'github-username':\n\t\t\tcase 'github-repository':\n\t\t\tcase 'github-organisation':\n\t\t\tcase 'cpe':\n\t\t\tcase 'twitter-id':\n\t\t\tcase 'mobile-application-id':\n\t\t\t\t// no newline\n\t\t\t\tif (!preg_match(\"#\\n#\", $value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'email-header':\n\t\t\t\t$returnValue = true;\n\t\t\t\tbreak;\n\t\t\tcase 'datetime':\n\t\t\t\ttry {\n\t\t\t\t\tnew DateTime($value);\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t} catch (Exception $e) {\n\t\t\t\t\t$returnValue = 'Datetime has to be in the ISO 8601 format.';\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'size-in-bytes':\n\t\t\tcase 'counter':\n\t\t\t\tif (!is_numeric($value) || $value < 0) {\n\t\t\t\t\t$returnValue = 'The value has to be a number greater or equal 0.';\n\t\t\t\t} else {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'targeted-threat-index':\n\t\t\t\tif (!is_numeric($value) || $value < 0 || $value > 10) {\n\t\t\t\t\t$returnValue = 'The value has to be a number between 0 and 10.';\n\t\t\t\t} else {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'iban':\n\t\t\tcase 'bic':\n\t\t\tcase 'btc':\n\t\t\t\tif (preg_match('/^[a-zA-Z0-9]+$/', $value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'bin':\n\t\t\tcase 'cc-number':\n\t\t\tcase 'bank-account-nr':\n\t\t\tcase 'aba-rtn':\n\t\t\tcase 'prtn':\n\t\t\tcase 'phone-number':\n\t\t\tcase 'whois-registrant-phone':\n\t\t\t\tif (is_numeric($value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'cortex':\n\t\t\t\tjson_decode($value);\n\t\t\t\t$returnValue = (json_last_error() == JSON_ERROR_NONE);\n\t\t\t\tbreak;\n\t\t\tcase 'float':\n\t\t\t\t$value = floatval($value);\n\t\t\t\tif (is_float($value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'boolean':\n\t\t\t\tif ($value == 1 || $value == 0) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t}\n\t\t}\n\t\treturn $returnValue;\n\t}\n\n\t// do some last second modifications before the validation\n\tpublic function modifyBeforeValidation($type, $value) {\n\t\tswitch ($type) {\n\t\t\tcase 'md5':\n\t\t\tcase 'sha1':\n\t\t\tcase 'sha224':\n\t\t\tcase 'sha256':\n\t\t\tcase 'sha384':\n\t\t\tcase 'sha512':\n\t\t\tcase 'sha512/224':\n\t\t\tcase 'sha512/256':\n\t\t\tcase 'domain':\n\t\t\tcase 'hostname':\n\t\t\tcase 'pehash':\n\t\t\tcase 'authentihash':\n\t\t\tcase 'imphash':\n\t\t\tcase 'tlsh':\n\t\t\tcase 'email-src':\n\t\t\tcase 'email-dst':\n\t\t\tcase 'target-email':\n\t\t\tcase 'whois-registrant-email':\n\t\t\t\t$value = strtolower($value);\n\t\t\t\tbreak;\n\t\t\tcase 'domain|ip':\n\t\t\t\t$parts = explode('|', $value);\n\t\t\t\tif (filter_var($parts[1], FILTER_VALIDATE_IP, FILTER_FLAG_IPV6)) {\n\t\t\t\t\t// convert IPv6 address to compressed format\n\t\t\t\t\t$parts[1] = inet_ntop(inet_pton($value));\n\t\t\t\t\t$value = implode('|', $parts);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'filename|md5':\n\t\t\tcase 'filename|sha1':\n\t\t\tcase 'filename|imphash':\n\t\t\tcase 'filename|sha224':\n\t\t\tcase 'filename|sha256':\n\t\t\tcase 'filename|sha384':\n\t\t\tcase 'filename|sha512':\n\t\t\tcase 'filename|sha512/224':\n\t\t\tcase 'filename|sha512/256':\n\t\t\tcase 'filename|authentihash':\n\t\t\tcase 'filename|pehash':\n\t\t\tcase 'filename|tlsh':\n\t\t\t\t$pieces = explode('|', $value);\n\t\t\t\t$value = $pieces[0] . '|' . strtolower($pieces[1]);\n\t\t\t\tbreak;\n\t\t\tcase 'http-method':\n\t\t\t\t$value = strtoupper($value);\n\t\t\t\tbreak;\n\t\t\tcase 'cc-number':\n\t\t\tcase 'bin':\n\t\t\t\t$value = preg_replace('/[^0-9]+/', '', $value);\n\t\t\t\tbreak;\n\t\t\tcase 'iban':\n\t\t\tcase 'bic':\n\t\t\t\t$value = strtoupper($value);\n\t\t\t\t$value = preg_replace('/[^0-9A-Z]+/', '', $value);\n\t\t\t\tbreak;\n\t\t\tcase 'prtn':\n\t\t\tcase 'whois-registrant-phone':\n\t\t\tcase 'phone-number':\n\t\t\t\tif (substr($value, 0, 2) == '00') $value = '+' . substr($value, 2);\n\t\t\t\t$value = preg_replace('/\\(0\\)/', '', $value);\n\t\t\t\t$value = preg_replace('/[^\\+0-9]+/', '', $value);\n\t\t\t\tbreak;\n\t\t\tcase 'url':\n\t\t\t\t$value = preg_replace('/^hxxp/i', 'http', $value);\n\t\t\t\t$value = preg_replace('/\\[\\.\\]/', '.' , $value);\n\t\t\t\tbreak;\n            case 'x509-fingerprint-md5':\n            case 'x509-fingerprint-sha256':\n\t\t\tcase 'x509-fingerprint-sha1':\n\t\t\t\t$value = str_replace(':', '', $value);\n\t\t\t\t$value = strtolower($value);\n\t\t\t\tbreak;\n\t\t\tcase 'ip-src':\n\t\t\tcase 'ip-dst':\n\t\t\t\tif (filter_var($value, FILTER_VALIDATE_IP, FILTER_FLAG_IPV6)) {\n\t\t\t\t\t// convert IPv6 address to compressed format\n\t\t\t\t\t$value = inet_ntop(inet_pton($value));\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'ip-dst|port':\n\t\t\tcase 'ip-src|port':\n\t\t\t\t\tif (strpos($value, ':')) {\n\t\t\t\t\t\t$parts = explode(':', $value);\n\t\t\t\t\t} else if (strpos($value, '|')) {\n\t\t\t\t\t\t$parts = explode('|', $value);\n\t\t\t\t\t} else {\n\t\t\t\t\t\treturn $value;\n\t\t\t\t\t}\n\t\t\t\t\tif (filter_var($parts[0], FILTER_VALIDATE_IP, FILTER_FLAG_IPV6)) {\n\t\t\t\t\t\t// convert IPv6 address to compressed format\n\t\t\t\t\t\t$parts[0] = inet_ntop(inet_pton($parts[0]));\n\t\t\t\t\t}\n\t\t\t\t\treturn $parts[0] . '|' . $parts[1];\n\t\t\t\tbreak;\n\t\t\tcase 'mac-address':\n\t\t\tcase 'mac-eui-64':\n\t\t\t\t$value = str_replace(array('.', ':', '-', ' '), '', $value);\n\t\t\t\t$value = wordwrap($value, 2, ':', true);\n\t\t\t\tbreak;\n\t\t\tcase 'hostname|port':\n\t\t\t\t$value = strtolower($value);\n\t\t\t\tstr_replace(':', '|', $value);\n\t\t\t\tbreak;\n\t\t\tcase 'float':\n\t\t\t\t$value = floatval($value);\n\t\t\t\tbreak;\n\t\t\tcase 'hex':\n\t\t\t\t$value = strtoupper($value);\n\t\t\t\tbreak;\n\t\t\tcase 'boolean':\n\t\t\t\tif ('true' == trim(strtolower($value))) $value = 1;\n\t\t\t\tif ('false' == trim(strtolower($value))) $value = 0;\n\t\t\t\t$value = ($value) ? '1' : '0';\n\t\t\t\tbreak;\n\t\t}\n\t\treturn $value;\n\t}\n\n\tpublic function getCompositeTypes() {\n\t\t// build the list of composite Attribute.type dynamically by checking if type contains a |\n\t\t// default composite types\n\t\t$compositeTypes = array('malware-sample');\t// TODO hardcoded composite\n\t\t// dynamically generated list\n\t\tforeach (array_keys($this->typeDefinitions) as $type) {\n\t\t\t$pieces = explode('|', $type);\n\t\t\tif (2 == count($pieces)) {\n\t\t\t\t$compositeTypes[] = $type;\n\t\t\t}\n\t\t}\n\t\treturn $compositeTypes;\n\t}\n\n\tpublic function isOwnedByOrg($attributeId, $org) {\n\t\t$this->id = $attributeId;\n\t\t$this->read();\n\t\treturn $this->data['Event']['org_id'] === $org;\n\t}\n\n\tpublic function getRelatedAttributes($attribute, $fields=array()) {\n\t\t// LATER getRelatedAttributes($attribute) this might become a performance bottleneck\n\n\t\t// exclude these specific categories from being linked\n\t\tswitch ($attribute['category']) {\n\t\t\tcase 'Antivirus detection':\n\t\t\t\treturn null;\n\t\t}\n\t\t// exclude these specific types from being linked\n\t\tswitch ($attribute['type']) {\n\t\t\tcase 'other':\n\t\t\tcase 'comment':\n\t\t\t\treturn null;\n\t\t}\n\n\t\t// prepare the conditions\n\t\t$conditions = array(\n\t\t\t\t'Attribute.event_id !=' => $attribute['event_id'],\n\t\t\t\t);\n\n\t\t// prevent issues with empty fields\n\t\tif (empty($attribute['value1'])) {\n\t\t\treturn null;\n\t\t}\n\n\t\tif (empty($attribute['value2'])) {\n\t\t\t// no value2, only search for value 1\n\t\t\t$conditions['OR'] = array(\n\t\t\t\t\t'Attribute.value1' => $attribute['value1'],\n\t\t\t\t\t'Attribute.value2' => $attribute['value1'],\n\t\t\t);\n\t\t} else {\n\t\t\t// value2 also set, so search for both\n\t\t\t$conditions['AND'] = array( // TODO was OR\n\t\t\t\t\t'Attribute.value1' => array($attribute['value1'],$attribute['value2']),\n\t\t\t\t\t'Attribute.value2' => array($attribute['value1'],$attribute['value2']),\n\t\t\t);\n\t\t}\n\n\t\t// do the search\n\t\tif (empty($fields)) {\n\t\t\t$fields = array('Attribute.*');\n\t\t}\n\t\t$similarEvents = $this->find('all',array('conditions' => $conditions,\n\t\t\t\t\t\t\t\t\t\t\t\t'fields' => $fields,\n\t\t\t\t\t\t\t\t\t\t\t\t'recursive' => 0,\n\t\t\t\t\t\t\t\t\t\t\t\t'group' => array('Attribute.event_id'),\n\t\t\t\t\t\t\t\t\t\t\t\t'order' => 'Attribute.event_id DESC', )\n\t\t);\n\t\treturn $similarEvents;\n\t}\n\n\tpublic function typeIsMalware($type) {\n\t\tif (in_array($type, $this->zippedDefinitions)) {\n\t\t\treturn true;\n\t\t} else {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tpublic function typeIsAttachment($type) {\n\t\tif ((in_array($type, $this->zippedDefinitions)) || (in_array($type, $this->uploadDefinitions))) {\n\t\t\treturn true;\n\t\t} else {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tpublic function base64EncodeAttachment($attribute) {\n\t\t$attachments_dir = Configure::read('MISP.attachments_dir');\n\t\tif (empty($attachments_dir)) {\n\t\t\t$my_server = ClassRegistry::init('Server');\n\t\t\t$attachments_dir = $my_server->getDefaultAttachments_dir();\n\t\t}\n\t\t$filepath = $attachments_dir . DS . $attribute['event_id'] . DS . $attribute['id'];\n\t\t$file = new File($filepath);\n\t\tif (!$file->readable()) {\n\t\t\treturn '';\n\t\t}\n\t\t$content = $file->read();\n\t\treturn base64_encode($content);\n\t}\n\n\tpublic function saveBase64EncodedAttachment($attribute) {\n\t\t$attachments_dir = Configure::read('MISP.attachments_dir');\n\t\tif (empty($attachments_dir)) {\n\t\t\t$my_server = ClassRegistry::init('Server');\n\t\t\t$attachments_dir = $my_server->getDefaultAttachments_dir();\n\t\t}\n\t\t$rootDir = $attachments_dir . DS . $attribute['event_id'];\n\t\t$dir = new Folder($rootDir, true);\t\t\t\t\t\t// create directory structure\n\t\t$destpath = $rootDir . DS . $attribute['id'];\n\t\t$file = new File($destpath, true);\t\t\t\t\t\t// create the file\n\t\t$decodedData = base64_decode($attribute['data']);\t\t// decode\n\t\tif ($file->write($decodedData)) {\t\t\t\t\t\t// save the data\n\t\t\treturn true;\n\t\t} else {\n\t\t\t// error\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tpublic function uploadAttachment($fileP, $realFileName, $malware, $eventId = null, $category = null, $extraPath = '', $fullFileName = '', $dist, $fromGFI = false) {\n\t\t// Check if there were problems with the file upload\n\t\t// only keep the last part of the filename, this should prevent directory attacks\n\t\t$filename = basename($fileP);\n\t\t$tmpfile = new File($fileP);\n\n\t\t// save the file-info in the database\n\t\t$this->create();\n\t\t$this->data['Attribute']['event_id'] = $eventId;\n\t\t$this->data['Attribute']['distribution'] = $dist;\n\t\tif ($malware) {\n\t\t\t$md5 = !$tmpfile->size() ? md5_file($fileP) : $tmpfile->md5();\n\t\t\t$this->data['Attribute']['category'] = $category ? $category : \"Payload delivery\";\n\t\t\t$this->data['Attribute']['type'] = \"malware-sample\";\n\t\t\t$this->data['Attribute']['value'] = $fullFileName ? $fullFileName . '|' . $md5 : $filename . '|' . $md5; // TODO gives problems with bigger files\n\t\t\t$this->data['Attribute']['to_ids'] = 1; // LATER let user choose whether to send this to an IDS\n\t\t\tif ($fromGFI) $this->data['Attribute']['comment'] = 'GFI import';\n\t\t} else {\n\t\t\t$this->data['Attribute']['category'] = $category ? $category : \"Artifacts dropped\";\n\t\t\t$this->data['Attribute']['type'] = \"attachment\";\n\t\t\t$this->data['Attribute']['value'] = $fullFileName ? $fullFileName : $realFileName;\n\t\t\t$this->data['Attribute']['to_ids'] = 0;\n\t\t\tif ($fromGFI) $this->data['Attribute']['comment'] = 'GFI import';\n\t\t}\n\n\t\tif (!$this->save($this->data)) {\n\t\t\t// TODO: error handling\n\t\t}\n\n\t\t// no errors in file upload, entry already in db, now move the file where needed and zip it if required.\n\t\t// no sanitization is required on the filename, path or type as we save\n\t\t// create directory structure\n\t\t$attachments_dir = Configure::read('MISP.attachments_dir');\n\t\tif (empty($attachments_dir)) {\n\t\t\t$my_server = ClassRegistry::init('Server');\n\t\t\t$attachments_dir = $my_server->getDefaultAttachments_dir();\n\t\t}\n\t\t$rootDir = $attachments_dir . DS . $eventId;\n\t\t$dir = new Folder($rootDir, true);\n\t\t// move the file to the correct location\n\t\t$destpath = $rootDir . DS . $this->getID(); // id of the new attribute in the database\n\t\t$file = new File($destpath);\n\t\t$zipfile = new File($destpath . '.zip');\n\t\t$fileInZip = new File($rootDir . DS . $extraPath . $filename);\n\n\t\t// zip and password protect the malware files\n\t\tif ($malware) {\n\t\t\t$execRetval = '';\n\t\t\t$execOutput = array();\n\t\t\texec('zip -j -P infected ' . escapeshellarg($zipfile->path) . ' ' . escapeshellarg($fileInZip->path), $execOutput, $execRetval);\n\t\t\tif ($execRetval != 0) { // not EXIT_SUCCESS\n\t\t\t\tthrow new Exception('An error has occured while attempting to zip the malware file.');\n\t\t\t}\n\t\t\t$fileInZip->delete(); // delete the original non-zipped-file\n\t\t\trename($zipfile->path, $file->path); // rename the .zip to .nothing\n\t\t} else {\n\t\t\t$fileAttach = new File($fileP);\n\t\t\trename($fileAttach->path, $file->path);\n\t\t}\n\t}\n\n\tpublic function __beforeSaveCorrelation($a) {\n\t\t// (update-only) clean up the relation of the old value: remove the existing relations related to that attribute, we DO have a reference, the id\n\t\t// ==> DELETE FROM correlations WHERE 1_attribute_id = $a_id OR attribute_id = $a_id; */\n\t\t// first check if it's an update\n\t\tif (isset($a['id'])) {\n\t\t\t$this->Correlation = ClassRegistry::init('Correlation');\n\t\t\t// FIXME : check that $a['id'] is checked correctly so that the user can't remove attributes he shouldn't\n\t\t\t$dummy = $this->Correlation->deleteAll(array('OR' => array(\n\t\t\t\t\t'Correlation.1_attribute_id' => $a['id'],\n\t\t\t\t\t'Correlation.attribute_id' => $a['id']))\n\t\t\t);\n\t\t}\n\t\tif ($a['type'] == 'ssdeep') {\n\t\t\t$this->FuzzyCorrelateSsdeep = ClassRegistry::init('FuzzyCorrelateSsdeep');\n\t\t\t$this->FuzzyCorrelateSsdeep->deleteAll(\n\t\t\t\tarray('FuzzyCorrelateSsdeep.attribute_id' => $a['id'])\n\t\t\t);\n\t\t}\n\t}\n\n\t// using Alnitak's solution from http://stackoverflow.com/questions/594112/matching-an-ip-to-a-cidr-mask-in-php5\n\tprivate function __ipv4InCidr($ip, $cidr) {\n\t\tlist ($subnet, $bits) = explode('/', $cidr);\n\t\t$ip = ip2long($ip);\n\t\t$subnet = ip2long($subnet);\n\t\t$mask = -1 << (32 - $bits);\n\t\t$subnet &= $mask; # nb: in case the supplied subnet wasn't correctly aligned\n\t\treturn ($ip & $mask) == $subnet;\n\t}\n\n\t// using Snifff's solution from http://stackoverflow.com/questions/7951061/matching-ipv6-address-to-a-cidr-subnet\n\tprivate function __ipv6InCidr($ip, $cidr) {\n\t\t$ip = $this->__expandIPv6Notation($ip);\n\t\t$binaryip = $this->__inet_to_bits($ip);\n\t\tlist($net,$maskbits) = explode('/', $cidr);\n\t\t$net = $this->__expandIPv6Notation($net);\n\t\tif (substr($net, -1) == ':') {\n\t\t\t$net .= '0';\n\t\t}\n\t\t$binarynet = $this->__inet_to_bits($net);\n\t\t$ip_net_bits = substr($binaryip, 0, $maskbits);\n\t\t$net_bits = substr($binarynet, 0, $maskbits);\n\t\treturn ($ip_net_bits === $net_bits);\n\t}\n\n\tprivate function __expandIPv6Notation($ip) {\n    if (strpos($ip, '::') !== false)\n        $ip = str_replace('::', str_repeat(':0', 8 - substr_count($ip, ':')).':', $ip);\n    if (strpos($ip, ':') === 0) $ip = '0'.$ip;\n    return $ip;\n\t}\n\n\tprivate function __inet_to_bits($inet) {\n\t\t$unpacked = unpack('A16', $inet);\n\t\t$unpacked = str_split($unpacked[1]);\n\t\t$binaryip = '';\n\t\tforeach ($unpacked as $char) {\n\t\t\t$binaryip .= str_pad(decbin(ord($char)), 8, '0', STR_PAD_LEFT);\n\t\t}\n\t\treturn $binaryip;\n\t}\n\n\tprivate function __cidrCorrelation($a) {\n\t\t$ipValues = array();\n\t\t$ip = $a['type'] == 'domain-ip' ? $a['value2'] : $a['value1'];\n\t\tif (strpos($ip, '/') !== false) {\n\t\t\t$ip_array = explode('/', $ip);\n\t\t\t$ip_version = filter_var($ip_array[0], FILTER_VALIDATE_IP, FILTER_FLAG_IPV4) ? 4 : 6;\n\t\t\t$ipList = $this->find('list', array(\n\t\t\t\t'conditions' => array(\n\t\t\t\t\t'type' => array('ip-src', 'ip-dst', 'domain_ip'),\n\t\t\t\t),\n\t\t\t\t'fields' => array('value1', 'value2'),\n\t\t\t\t'order' => false\n\t\t\t));\n\t\t\t$ipList = array_merge(array_keys($ipList), array_values($ipList));\n\t\t\tforeach ($ipList as $key => $value) {\n\t\t\t\tif ($value == '') {\n\t\t\t\t\tunset($ipList[$key]);\n\t\t\t\t}\n\t\t\t}\n\t\t\tforeach ($ipList as $ipToCheck) {\n\t\t\t\tif (filter_var($ipToCheck, FILTER_VALIDATE_IP, FILTER_FLAG_IPV4) && $ip_version == 4) {\n\t\t\t\t\tif ($ip_version == 4) {\n\t\t\t\t\t\tif ($this->__ipv4InCidr($ipToCheck, $ip)) {\n\t\t\t\t\t\t\t$ipValues[] = $ipToCheck;\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif ($this->__ipv6InCidr($ipToCheck, $ip)) {\n\t\t\t\t\t\t\t$ipValues[] = $ipToCheck;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\t$ip = $a['value1'];\n\t\t\t$ip_version = filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_IPV4) ? 4 : 6;\n\t\t\t$cidrList = $this->getSetCIDRList();\n\t\t\tforeach ($cidrList as $cidr) {\n\t\t\t\t$cidr_ip = explode('/', $cidr)[0];\n\t\t\t\tif (filter_var($cidr_ip, FILTER_VALIDATE_IP, FILTER_FLAG_IPV4)) {\n\t\t\t\t\tif ($ip_version == 4) {\n\t\t\t\t\t\tif ($this->__ipv4InCidr($ip, $cidr)) {\n\t\t\t\t\t\t\t$ipValues[] = $cidr;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tif ($ip_version == 6) {\n\t\t\t\t\t\tif ($this->__ipv6InCidr($ip, $cidr)) {\n\t\t\t\t\t\t\t$ipValues[] = $cidr;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t$extraConditions = array();\n\t\tif (!empty($ipValues)) {\n\t\t\t$extraConditions = array('OR' => array(\n\t\t\t\t'Attribute.value1' => $ipValues,\n\t\t\t\t'Attribute.value2' => $ipValues\n\t\t\t));\n\t\t}\n\t\treturn $extraConditions;\n\t}\n\n\tpublic function __afterSaveCorrelation($a, $full = false, $event = false) {\n\t\tif (!empty($a['disable_correlation'])) {\n\t\t\treturn true;\n\t\t}\n\t\t// Don't do any correlation if the type is a non correlating type\n\t\tif (!in_array($a['type'], $this->nonCorrelatingTypes)) {\n\t\t\tif (!$event) {\n\t\t\t\t$event = $this->Event->find('first', array(\n\t\t\t\t\t\t'recursive' => -1,\n\t\t\t\t\t\t'fields' => array('Event.distribution', 'Event.id', 'Event.info', 'Event.org_id', 'Event.date', 'Event.sharing_group_id', 'Event.disable_correlation'),\n\t\t\t\t\t\t'conditions' => array('id' => $a['event_id']),\n\t\t\t\t\t\t'order' => array(),\n\t\t\t\t));\n\t\t\t}\n\t\t\tif (!empty($event['Event']['disable_correlation']) && $event['Event']['disable_correlation']) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\tif (Configure::read('MISP.enable_advanced_correlations') && in_array($a['type'], array('ip-src', 'ip-dst', 'domain-ip'))) {\n\t\t\t\t$extraConditions = $this->__cidrCorrelation($a);\n\t\t\t}\n\t\t\tif ($a['type'] == 'ssdeep') {\n\t\t\t\tif (function_exists('ssdeep_fuzzy_compare')) {\n\t\t\t\t\t$this->FuzzyCorrelateSsdeep = ClassRegistry::init('FuzzyCorrelateSsdeep');\n\t\t\t\t\t$fuzzyIds = $this->FuzzyCorrelateSsdeep->query_ssdeep_chunks($a['value'], $a['id']);\n\t\t\t\t\tif (!empty($fuzzyIds)) {\n\t\t\t\t\t\t$ssdeepIds = $this->find('list', array(\n\t\t\t\t\t\t\t'recursive' => -1,\n\t\t\t\t\t\t\t'conditions' => array(\n\t\t\t\t\t\t\t\t'Attribute.type' => 'ssdeep',\n\t\t\t\t\t\t\t\t'Attribute.id' => $fuzzyIds\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t'fields' => array('Attribute.id', 'Attribute.value1')\n\t\t\t\t\t\t));\n\t\t\t\t\t\t$extraConditions = array('Attribute.id' => array());\n\t\t\t\t\t\t$threshold = !empty(Configure::read('MISP.ssdeep_correlation_threshold')) ? Configure::read('MISP.ssdeep_correlation_threshold') : 40;\n\t\t\t\t\t\tforeach ($ssdeepIds as $k => $v) {\n\t\t\t\t\t\t\t$ssdeep_value = ssdeep_fuzzy_compare($a['value'], $v);\n\t\t\t\t\t\t\tif ($ssdeep_value >= $threshold) {\n\t\t\t\t\t\t\t\t$extraConditions['Attribute.id'][] = $k;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\t$this->Correlation = ClassRegistry::init('Correlation');\n\t\t\t$correlatingValues = array($a['value1']);\n\t\t\tif (!empty($a['value2']) && !isset($this->primaryOnlyCorrelatingTypes[$a['type']])) $correlatingValues[] = $a['value2'];\n\t\t\tforeach ($correlatingValues as $k => $cV) {\n\t\t\t\t$conditions = array(\n\t\t\t\t\t'OR' => array(\n\t\t\t\t\t\t\t'Attribute.value1' => $cV,\n\t\t\t\t\t\t\t'AND' => array(\n\t\t\t\t\t\t\t\t\t'Attribute.value2' => $cV,\n\t\t\t\t\t\t\t\t\t'NOT' => array('Attribute.type' => $this->primaryOnlyCorrelatingTypes)\n\t\t\t\t\t\t\t)\n\t\t\t\t\t),\n\t\t\t\t\t'Attribute.disable_correlation' => 0,\n\t\t\t\t\t'Event.disable_correlation' => 0,\n\t\t\t\t\t'Attribute.deleted' => 0\n\t\t\t\t);\n\t\t\t\tif (!empty($extraConditions)) {\n\t\t\t\t\t$conditions['OR'][] = $extraConditions;\n\t\t\t\t}\n\t\t\t\t$correlatingAttributes[$k] = $this->find('all', array(\n\t\t\t\t\t\t'conditions' => $conditions,\n\t\t\t\t\t\t'recursive => -1',\n\t\t\t\t\t\t'fields' => array('Attribute.event_id', 'Attribute.id', 'Attribute.distribution', 'Attribute.sharing_group_id', 'Attribute.deleted', 'Attribute.type'),\n\t\t\t\t\t\t'contain' => array('Event' => array('fields' => array('Event.id', 'Event.date', 'Event.info', 'Event.org_id', 'Event.distribution', 'Event.sharing_group_id'))),\n\t\t\t\t\t\t'order' => array(),\n\t\t\t\t));\n\t\t\t\tforeach ($correlatingAttributes[$k] as $key => &$correlatingAttribute) {\n\t\t\t\t\tif ($correlatingAttribute['Attribute']['id'] == $a['id']) unset($correlatingAttributes[$k][$key]);\n\t\t\t\t\telse if ($correlatingAttribute['Attribute']['event_id'] == $a['event_id']) unset($correlatingAttributes[$k][$key]);\n\t\t\t\t\telse if ($full && $correlatingAttribute['Attribute']['id'] <= $a['id']) unset($correlatingAttributes[$k][$key]);\n\t\t\t\t\telse if (in_array($correlatingAttribute['Attribute']['type'], $this->nonCorrelatingTypes)) unset($correlatingAttributes[$k][$key]);\n\t\t\t\t\telse if (isset($this->primaryOnlyCorrelatingTypes[$a['type']]) && $correlatingAttribute['value1'] !== $a['value1']) unset($correlatingAttribute[$k][$key]);\n\t\t\t\t}\n\t\t\t}\n\t\t\t$correlations = array();\n\t\t\tforeach ($correlatingAttributes as $k => $cA) {\n\t\t\t\tforeach ($cA as $corr) {\n\t\t\t\t\t$correlations[] = array(\n\t\t\t\t\t\t\t$correlatingValues[$k],\n\t\t\t\t\t\t\t$event['Event']['id'],\n\t\t\t\t\t\t\t$a['id'],\n\t\t\t\t\t\t\t$corr['Attribute']['event_id'],\n\t\t\t\t\t\t\t$corr['Attribute']['id'],\n\t\t\t\t\t\t\t$corr['Event']['org_id'],\n\t\t\t\t\t\t\t$corr['Event']['distribution'],\n\t\t\t\t\t\t\t$corr['Attribute']['distribution'],\n\t\t\t\t\t\t\t$corr['Event']['sharing_group_id'],\n\t\t\t\t\t\t\t$corr['Attribute']['sharing_group_id'],\n\t\t\t\t\t\t\t$corr['Event']['date'],\n\t\t\t\t\t\t\t$corr['Event']['info']\n\t\t\t\t\t);\n\t\t\t\t\t$correlations[] = array(\n\t\t\t\t\t\t\t$correlatingValues[$k],\n\t\t\t\t\t\t\t$corr['Event']['id'],\n\t\t\t\t\t\t\t$corr['Attribute']['id'],\n\t\t\t\t\t\t\t$a['event_id'],\n\t\t\t\t\t\t\t$a['id'],\n\t\t\t\t\t\t\t$event['Event']['org_id'],\n\t\t\t\t\t\t\t$event['Event']['distribution'],\n\t\t\t\t\t\t\t$a['distribution'],\n\t\t\t\t\t\t\t$event['Event']['sharing_group_id'],\n\t\t\t\t\t\t\t$a['sharing_group_id'],\n\t\t\t\t\t\t\t$event['Event']['date'],\n\t\t\t\t\t\t\t$event['Event']['info']\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\t\t\t$fields = array(\n\t\t\t\t\t'value',\n\t\t\t\t\t'1_event_id',\n\t\t\t\t\t'1_attribute_id',\n\t\t\t\t\t'event_id',\n\t\t\t\t\t'attribute_id',\n\t\t\t\t\t'org_id',\n\t\t\t\t\t'distribution',\n\t\t\t\t\t'a_distribution',\n\t\t\t\t\t'sharing_group_id',\n\t\t\t\t\t'a_sharing_group_id',\n\t\t\t\t\t'date',\n\t\t\t\t\t'info'\n\t\t\t);\n\t\t\tif (!empty($correlations)) {\n\t\t\t\t$db = $this->getDataSource();\n\t\t\t\t$db->insertMulti('correlations', $fields, $correlations);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate function __beforeDeleteCorrelation($attribute_id) {\n\t\t$this->Correlation = ClassRegistry::init('Correlation');\n\t\t// When we remove an attribute we need to\n\t\t// - remove the existing relations related to that attribute, we DO have an id reference\n\t\t// ==> DELETE FROM correlations WHERE 1_attribute_id = $a_id OR attribute_id = $a_id;\n\t\t$dummy = $this->Correlation->deleteAll(array('OR' => array(\n\t\t\t\t\t\t'Correlation.1_attribute_id' => $attribute_id,\n\t\t\t\t\t\t'Correlation.attribute_id' => $attribute_id))\n\t\t);\n\t}\n\n\tpublic function checkComposites() {\n\t\t$compositeTypes = $this->getCompositeTypes();\n\t\t$fails = array();\n\t\t$attributes = $this->find('all', array('recursive' => 0));\n\n\t\tforeach ($attributes as $attribute) {\n\t\t\tif ((in_array($attribute['Attribute']['type'], $compositeTypes)) && (!strlen($attribute['Attribute']['value1']) || !strlen($attribute['Attribute']['value2']))) {\n\t\t\t\t$fails[] = $attribute['Attribute']['event_id'] . ':' . $attribute['Attribute']['id'];\n\t\t\t}\n\t\t}\n\t\treturn $fails;\n\t}\n\n\n\tpublic function hids($user, $type, $tags = '', $from = false, $to = false, $last = false, $jobId = false, $enforceWarninglist = false) {\n\t\tif (empty($user)) throw new MethodNotAllowedException('Could not read user.');\n\t\t// check if it's a valid type\n\t\tif ($type != 'md5' && $type != 'sha1' && $type != 'sha256') {\n\t\t\tthrow new UnauthorizedException('Invalid hash type.');\n\t\t}\n\t\t$conditions = array();\n\t\t$typeArray = array($type, 'filename|' . $type);\n\t\tif ($type == 'md5') $typeArray[] = 'malware-sample';\n\t\t$rules = array();\n\t\t$eventIds = $this->Event->fetchEventIds($user, $from, $to, $last);\n\t\tif (!empty($tags)) {\n\t\t\t$tag = ClassRegistry::init('Tag');\n\t\t\t$args = $this->dissectArgs($tags);\n\t\t\t$tagArray = $tag->fetchEventTagIds($args[0], $args[1]);\n\t\t\tif (!empty($tagArray[0])) {\n\t\t\t\tforeach ($eventIds as $k => $v) {\n\t\t\t\t\tif (!in_array($v['Event']['id'], $tagArray[0])) unset($eventIds[$k]);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!empty($tagArray[1])) {\n\t\t\t\tforeach ($eventIds as $k => $v) {\n\t\t\t\t\tif (in_array($v['Event']['id'], $tagArray[1])) unset($eventIds[$k]);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tApp::uses('HidsExport', 'Export');\n\t\t$continue = false;\n\t\t$eventCount = count($eventIds);\n\t\tif ($jobId) {\n\t\t\t$this->Job = ClassRegistry::init('Job');\n\t\t\t$this->Job->id = $jobId;\n\t\t\tif (!$this->Job->exists()) $jobId = false;\n\t\t}\n\t\tforeach ($eventIds as $k => $event) {\n\t\t\t$conditions['AND'] = array('Attribute.to_ids' => 1, 'Event.published' => 1, 'Attribute.type' => $typeArray, 'Attribute.event_id' => $event['Event']['id']);\n\t\t\t$options = array(\n\t\t\t\t\t'conditions' => $conditions,\n\t\t\t\t\t'group' => array('Attribute.type', 'Attribute.value1'),\n\t\t\t\t\t'enforceWarninglist' => $enforceWarninglist,\n\t\t\t\t\t'flatten' => true\n\t\t\t);\n\t\t\t$items = $this->fetchAttributes($user, $options);\n\t\t\tif (empty($items)) continue;\n\t\t\t$export = new HidsExport();\n\t\t\t$rules = array_merge($rules, $export->export($items, strtoupper($type), $continue));\n\t\t\t$continue = true;\n\t\t\tif ($jobId && ($k % 10 == 0)) {\n\t\t\t\t$this->Job->saveField('progress', $k * 80 / $eventCount);\n\t\t\t}\n\t\t}\n\t\treturn $rules;\n\t}\n\n\n\tpublic function nids($user, $format, $id = false, $continue = false, $tags = false, $from = false, $to = false, $last = false, $type = false, $enforceWarninglist = false, $includeAllTags = false) {\n\t\tif (empty($user)) throw new MethodNotAllowedException('Could not read user.');\n\t\t$eventIds = $this->Event->fetchEventIds($user, $from, $to, $last);\n\n\t\t// If we sent any tags along, load the associated tag names for each attribute\n\t\tif ($tags) {\n\t\t\t$tag = ClassRegistry::init('Tag');\n\t\t\t$args = $this->dissectArgs($tags);\n\t\t\t$tagArray = $tag->fetchEventTagIds($args[0], $args[1]);\n\t\t\tif (!empty($tagArray[0])) {\n\t\t\t\tforeach ($eventIds as $k => $v) {\n\t\t\t\t\tif (!in_array($v['Event']['id'], $tagArray[0])) unset($eventIds[$k]);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!empty($tagArray[1])) {\n\t\t\t\tforeach ($eventIds as $k => $v) {\n\t\t\t\t\tif (in_array($v['Event']['id'], $tagArray[1])) unset($eventIds[$k]);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif ($id) {\n\t\t\tforeach ($eventIds as $k => $v) {\n\t\t\t\tif ($v['Event']['id'] !== $id) unset($eventIds[$k]);\n\t\t\t}\n\t\t}\n\n\t\tif ($format == 'suricata') App::uses('NidsSuricataExport', 'Export');\n\t\telse App::uses('NidsSnortExport', 'Export');\n\n\t\t$rules = array();\n\t\tforeach ($eventIds as $event) {\n\t\t\t$conditions['AND'] = array('Attribute.to_ids' => 1, \"Event.published\" => 1, 'Attribute.event_id' => $event['Event']['id']);\n\t\t\t$valid_types = array('ip-dst', 'ip-src', 'ip-dst|port', 'ip-src|port', 'email-src', 'email-dst', 'email-subject', 'email-attachment', 'domain', 'domain|ip', 'hostname', 'url', 'user-agent', 'snort');\n\t\t\t$conditions['AND']['Attribute.type'] = $valid_types;\n\t\t\tif (!empty($type)) {\n\t\t\t\t$conditions['AND'][] = array('Attribute.type' => $type);\n\t\t\t}\n\n\t\t\t$params = array(\n\t\t\t\t\t'conditions' => $conditions, // array of conditions\n\t\t\t\t\t'recursive' => -1, // int\n\t\t\t\t\t'fields' => array('Attribute.id', 'Attribute.event_id', 'Attribute.type', 'Attribute.value'),\n\t\t\t\t\t'contain' => array('Event'=> array('fields' => array('Event.id', 'Event.threat_level_id'))),\n\t\t\t\t\t'group' => array('Attribute.type', 'Attribute.value1'), // fields to GROUP BY\n\t\t\t\t\t'enforceWarninglist' => $enforceWarninglist,\n\t\t\t\t\t'includeAllTags' => $includeAllTags,\n\t\t\t\t\t'flatten' => true\n\t\t\t);\n\t\t\t$items = $this->fetchAttributes($user, $params);\n\t\t\tif (empty($items)) continue;\n\t\t\t// export depending on the requested type\n\t\t\tswitch ($format) {\n\t\t\t\tcase 'suricata':\n\t\t\t\t\t$export = new NidsSuricataExport();\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'snort':\n\t\t\t\t\t$export = new NidsSnortExport();\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\t$rules = array_merge($rules, $export->export($items, $user['nids_sid'], $format, $continue));\n\t\t\t// Only prepend the comments once\n\t\t\t$continue = true;\n\t\t}\n\t\treturn $rules;\n\t}\n\n\tpublic function text($user, $type, $tags = false, $eventId = false, $allowNonIDS = false, $from = false, $to = false, $last = false, $enforceWarninglist = false, $allowNotPublished = false) {\n\t\t//permissions are taken care of in fetchAttributes()\n\t\t$conditions['AND'] = array();\n\t\tif ($allowNonIDS === false) {\n\t\t\t$conditions['AND']['Attribute.to_ids'] = 1;\n\t\t\tif ($allowNotPublished === false) $conditions['AND']['Event.published'] = 1;\n\t\t}\n\t\tif (!is_array($type) && $type !== 'all') $conditions['AND']['Attribute.type'] = $type;\n\t\tif ($from) $conditions['AND']['Event.date >='] = $from;\n\t\tif ($to) $conditions['AND']['Event.date <='] = $to;\n\t\tif ($last) $conditions['AND']['Event.publish_timestamp >='] = $last;\n\n\t\tif ($eventId !== false) {\n\t\t\t$conditions['AND'][] = array('Event.id' => $eventId);\n\t\t} else if ($tags !== false) {\n\t\t\t// If we sent any tags along, load the associated tag names for each attribute\n\t\t\t$tag = ClassRegistry::init('Tag');\n\t\t\t$args = $this->dissectArgs($tags);\n\t\t\t$tagArray = $tag->fetchEventTagIds($args[0], $args[1]);\n\t\t\t$temp = array();\n\t\t\tforeach ($tagArray[0] as $accepted) {\n\t\t\t\t$temp['OR'][] = array('Event.id' => $accepted);\n\t\t\t}\n\t\t\t$conditions['AND'][] = $temp;\n\t\t\t$temp = array();\n\t\t\tforeach ($tagArray[1] as $rejected) {\n\t\t\t\t$temp['AND'][] = array('Event.id !=' => $rejected);\n\t\t\t}\n\t\t\t$conditions['AND'][] = $temp;\n\t\t}\n\t\t$attributes = $this->fetchAttributes($user, array(\n\t\t\t\t'conditions' => $conditions,\n\t\t\t\t'order' => 'Attribute.value1 ASC',\n\t\t\t\t'fields' => array('value'),\n\t\t\t\t'contain' => array('Event' => array(\n\t\t\t\t\t'fields' => array('Event.id', 'Event.published', 'Event.date', 'Event.publish_timestamp'),\n\t\t\t\t)),\n\t\t\t\t'enforceWarninglist' => $enforceWarninglist,\n\t\t\t\t'flatten' => 1\n\t\t));\n\t\treturn $attributes;\n\t}\n\n\tpublic function rpz($user, $tags = false, $eventId = false, $from = false, $to = false, $enforceWarninglist = false) {\n\t\t// we can group hostname and domain as well as ip-src and ip-dst in this case\n\t\t$conditions['AND'] = array('Attribute.to_ids' => 1, 'Event.published' => 1);\n\t\t$typesToFetch = array('ip' => array('ip-src', 'ip-dst'), 'domain' => array('domain'), 'hostname' => array('hostname'));\n\t\tif ($from) $conditions['AND']['Event.date >='] = $from;\n\t\tif ($to) $conditions['AND']['Event.date <='] = $to;\n\t\tif ($eventId !== false) {\n\t\t\t$conditions['AND'][] = array('Event.id' => $eventId);\n\t\t}\n\t\tif ($tags !== false) {\n\t\t\t// If we sent any tags along, load the associated tag names for each attribute\n\t\t\t$tag = ClassRegistry::init('Tag');\n\t\t\t$args = $this->dissectArgs($tags);\n\t\t\t$tagArray = $tag->fetchEventTagIds($args[0], $args[1]);\n\t\t\t$temp = array();\n\t\t\tforeach ($tagArray[0] as $accepted) {\n\t\t\t\t$temp['OR'][] = array('Event.id' => $accepted);\n\t\t\t}\n\t\t\t$conditions['AND'][] = $temp;\n\t\t\t$temp = array();\n\t\t\tforeach ($tagArray[1] as $rejected) {\n\t\t\t\t$temp['AND'][] = array('Event.id !=' => $rejected);\n\t\t\t}\n\t\t\t$conditions['AND'][] = $temp;\n\t\t}\n\t\t$values = array();\n\t\tforeach ($typesToFetch as $k => $v) {\n\t\t\t$tempConditions = $conditions;\n\t\t\t$tempConditions['type'] = $v;\n\t\t\t$temp = $this->fetchAttributes(\n\t\t\t\t\t$user,\n\t\t\t\t\tarray(\n\t\t\t\t\t\t'conditions' => $tempConditions,\n\t\t\t\t\t\t'fields' => array('Attribute.value'), // array of field names\n\t\t\t\t\t\t'enforceWarninglist' => $enforceWarninglist\n\t\t\t\t\t)\n\t\t\t);\n\t\t\tif (empty($temp)) continue;\n\t\t\tif ($k == 'hostname') {\n\t\t\t\tforeach ($temp as $value) {\n\t\t\t\t\t$found = false;\n\t\t\t\t\tif (isset($values['domain'])) {\n\t\t\t\t\t\tforeach ($values['domain'] as $domain) {\n\t\t\t\t\t\t\tif (strpos($value['Attribute']['value'], $domain) != 0) {\n\t\t\t\t\t\t\t\t$found = true;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!$found) $values[$k][] = $value['Attribute']['value'];\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tforeach ($temp as $value) {\n\t\t\t\t\t$values[$k][] = $value['Attribute']['value'];\n\t\t\t\t}\n\t\t\t}\n\t\t\tunset($temp);\n\t\t}\n\t\treturn $values;\n\t}\n\n\tpublic function bro($user, $type, $tags = false, $eventId = false, $from = false, $to = false, $last = false, $enforceWarninglist = false) {\n\t\tApp::uses('BroExport', 'Export');\n\t\t$export = new BroExport();\n\t\tif ($type == 'all') {\n\t\t  $types = array_keys($export->mispTypes);\n\t\t} else {\n\t\t  $types = array($type);\n\t\t}\n\t\t$intel = array();\n\t\tforeach ($types as $type) {\n\t\t\t//restricting to non-private or same org if the user is not a site-admin.\n\t\t\t$conditions['AND'] = array('Attribute.to_ids' => 1, 'Event.published' => 1);\n\t\t\tif ($from) $conditions['AND']['Event.date >='] = $from;\n\t\t\tif ($to) $conditions['AND']['Event.date <='] = $to;\n\t\t\tif ($last) $conditions['AND']['Event.publish_timestamp >='] = $last;\n\t\t\tif ($eventId !== false) {\n\t\t\t\t$temp = array();\n\t\t\t\t$args = $this->dissectArgs($eventId);\n\t\t\t\tforeach ($args[0] as $accepted) {\n\t\t\t\t\t$temp['OR'][] = array('Event.id' => $accepted);\n\t\t\t\t}\n\t\t\t\t$conditions['AND'][] = $temp;\n\t\t\t\t$temp = array();\n\t\t\t\tforeach ($args[1] as $rejected) {\n\t\t\t\t\t$temp['AND'][] = array('Event.id !=' => $rejected);\n\t\t\t\t}\n\t\t\t\t$conditions['AND'][] = $temp;\n\t\t\t}\n\t\t\tif ($tags !== false) {\n\t\t\t\t// If we sent any tags along, load the associated tag names for each attribute\n\t\t\t\t$tag = ClassRegistry::init('Tag');\n\t\t\t\t$args = $this->dissectArgs($tags);\n\t\t\t\t$tagArray = $tag->fetchEventTagIds($args[0], $args[1]);\n\t\t\t\t$temp = array();\n\t\t\t\tforeach ($tagArray[0] as $accepted) {\n\t\t\t\t\t$temp['OR'][] = array('Event.id' => $accepted);\n\t\t\t\t}\n\t\t\t\t$conditions['AND'][] = $temp;\n\t\t\t\t$temp = array();\n\t\t\t\tforeach ($tagArray[1] as $rejected) {\n\t\t\t\t\t$temp['AND'][] = array('Event.id !=' => $rejected);\n\t\t\t\t}\n\t\t\t\t$conditions['AND'][] = $temp;\n\t\t\t}\n\t\t\t$this->Whitelist = ClassRegistry::init('Whitelist');\n\t\t\t$this->whitelist = $this->Whitelist->getBlockedValues();\n\t\t\t$instanceString = 'MISP';\n\t\t\tif (Configure::read('MISP.host_org_id') && Configure::read('MISP.host_org_id') > 0) {\n\t\t\t\t$this->Event->Orgc->id = Configure::read('MISP.host_org_id');\n\t\t\t\tif ($this->Event->Orgc->exists()) {\n\t\t\t\t\t$instanceString = $this->Event->Orgc->field('name') . ' MISP';\n\t\t\t\t}\n\t\t\t}\n\t\t\t$mispTypes = $export->getMispTypes($type);\n\t\t\tforeach($mispTypes as $mispType) {\n\t\t\t\t$conditions['AND']['Attribute.type'] = $mispType[0];\n\t\t\t\t$intel = array_merge($intel, $this->__bro($user, $conditions, $mispType[1], $export, $this->whitelist, $instanceString, $enforceWarninglist));\n\t\t\t}\n\t\t}\n\t\tnatsort($intel);\n\t\t$intel = array_unique($intel);\n\t\tarray_unshift($intel, $export->header);\n\t\treturn $intel;\n\t}\n\n\tprivate function __bro($user, $conditions, $valueField, $export, $whitelist, $instanceString, $enforceWarninglist) {\n\t\t$attributes = $this->fetchAttributes($user, array(\n\t\t\t\t'conditions' => $conditions, // array of conditions\n\t\t\t\t'order' => 'Attribute.value' . $valueField . ' ASC',\n\t\t\t\t'recursive' => -1, // int\n\t\t\t\t'fields' => array('Attribute.id', 'Attribute.event_id', 'Attribute.type', 'Attribute.comment', 'Attribute.value' . $valueField . \" as value\"),\n\t\t\t\t'contain' => array('Event' => array('fields' => array('Event.id', 'Event.threat_level_id', 'Event.orgc_id', 'Event.uuid'))),\n\t\t\t\t'group' => array('Attribute.type', 'Attribute.value' . $valueField), // fields to GROUP BY\n\t\t\t\t'enforceWarninglist' => $enforceWarninglist\n\t\t\t)\n\t\t);\n\t\t$orgs = $this->Event->Orgc->find('list', array(\n\t\t\t\t'fields' => array('Orgc.id', 'Orgc.name')\n\t\t));\n\t\treturn $export->export($attributes, $orgs, $valueField, $whitelist, $instanceString);\n\t}\n\n\tpublic function generateCorrelation($jobId = false, $startPercentage = 0, $eventId = false, $attributeId = false) {\n\t\t$this->Correlation = ClassRegistry::init('Correlation');\n\t\t$this->purgeCorrelations($eventId);\n\t\t// get all attributes..\n\t\tif (!$eventId) {\n\t\t\t$eventIds = $this->Event->find('list', array('recursive' => -1, 'fields' => array('Event.id')));\n\t\t} else {\n\t\t\t$eventIds = array($eventId);\n\t\t}\n\t\t$attributeCount = 0;\n\t\tif (Configure::read('MISP.background_jobs') && $jobId) {\n\t\t\t$this->Job = ClassRegistry::init('Job');\n\t\t\t$this->Job->id = $jobId;\n\t\t\t$eventCount = count($eventIds);\n\t\t}\n\t\tforeach (array_values($eventIds) as $j => $id) {\n\t\t\tif ($jobId && Configure::read('MISP.background_jobs')) {\n\t\t\t\tif ($attributeId) {\n\t\t\t\t\t$this->Job->saveField('message', 'Correlating Attribute ' . $attributeId);\n\t\t\t\t} else {\n\t\t\t\t\t$this->Job->saveField('message', 'Correlating Event ' . $id);\n\t\t\t\t}\n\t\t\t\t$this->Job->saveField('progress', ($startPercentage + ($j / $eventCount * (100 - $startPercentage))));\n\t\t\t}\n\t\t\t$event = $this->Event->find('first', array(\n\t\t\t\t\t'recursive' => -1,\n\t\t\t\t\t'fields' => array('Event.distribution', 'Event.id', 'Event.info', 'Event.org_id', 'Event.date', 'Event.sharing_group_id', 'Event.disable_correlation'),\n\t\t\t\t\t'conditions' => array('id' => $id),\n\t\t\t\t\t'order' => array()\n\t\t\t));\n\t\t\t$attributeConditions = array('Attribute.event_id' => $id, 'Attribute.deleted' => 0);\n\t\t\tif ($attributeId) {\n\t\t\t\t$attributeConditions['Attribute.id'] = $attributeId;\n\t\t\t}\n\t\t\t$attributes = $this->find('all', array('recursive' => -1, 'conditions' => $attributeConditions, 'order' => array()));\n\t\t\tforeach ($attributes as $k => $attribute) {\n\t\t\t\t$this->__afterSaveCorrelation($attribute['Attribute'], true, $event);\n\t\t\t\t$attributeCount++;\n\t\t\t}\n\t\t}\n\t\tif ($jobId && Configure::read('MISP.background_jobs')) $this->Job->saveField('message', 'Job done.');\n\t\treturn $attributeCount;\n\t}\n\n\tpublic function purgeCorrelations($eventId = false, $attributeId = false) {\n\t\tif (!$eventId) {\n\t\t\t$this->query('TRUNCATE TABLE correlations;');\n\t\t} else if (!$attributeId) {\n\t\t\t$this->Correlation = ClassRegistry::init('Correlation');\n\t\t\t$this->Correlation->deleteAll(array('OR' => array(\n\t\t\t\t'Correlation.1_event_id' => $eventId,\n\t\t\t\t'Correlation.event_id' => $eventId))\n\t\t\t);\n\t\t} else {\n\t\t\t$this->Correlation->deleteAll(array('OR' => array(\n\t\t\t\t'Correlation.1_attribute_id' => $attributeId,\n\t\t\t\t'Correlation.attribute_id' => $attributeId))\n\t\t\t);\n\t\t}\n\t}\n\n\tpublic function reportValidationIssuesAttributes($eventId) {\n\t\t$conditions = array();\n\t\tif ($eventId && is_numeric($eventId)) $conditions = array('event_id' => $eventId);\n\n\t\t// get all attributes..\n\t\t$attributes = $this->find('all', array('recursive' => -1, 'fields' => array('id'), 'conditions' => $conditions));\n\t\t// for all attributes..\n\t\t$result = array();\n\t\t$i = 0;\n\t\tforeach ($attributes as $a) {\n\t\t\t$attribute = $this->find('first', array('recursive' => -1, 'conditions' => array('id' => $a['Attribute']['id'])));\n\t\t\t$this->set($attribute);\n\t\t\tif (!$this->validates()) {\n\t\t\t\t$errors = $this->validationErrors;\n\t\t\t\t$result[$i]['id'] = $attribute['Attribute']['id'];\n\t\t\t\t$result[$i]['error'] = array();\n\t\t\t\tforeach ($errors as $field => $error) {\n\t\t\t\t\t$result[$i]['error'][$field] = array('value' => $attribute['Attribute'][$field], 'error' => $error[0]);\n\t\t\t\t}\n\t\t\t\t$result[$i]['details'] = 'Event ID: [' . $attribute['Attribute']['event_id'] . \"] - Category: [\" . $attribute['Attribute']['category'] . \"] - Type: [\" . $attribute['Attribute']['type'] . \"] - Value: [\" . $attribute['Attribute']['value'] . ']';\n\t\t\t\t$i++;\n\t\t\t}\n\t\t}\n\t\treturn $result;\n\t}\n\n\t// This method takes a string from an argument with several elements (separated by '&&' and negated by '!') and returns 2 arrays\n\t// array 1 will have all of the non negated terms and array 2 all the negated terms\n\tpublic function dissectArgs($args) {\n\t\tif (!$args) return array(null, null);\n\t\tif (is_array($args)) {\n\t\t\t$argArray = $args;\n\t\t} else {\n\t\t\t$argArray = explode('&&', $args);\n\t\t}\n\t\t$accept = $reject = $result = array();\n\t\t$reject = array();\n\t\tforeach ($argArray as $arg) {\n\t\t\tif (substr($arg, 0, 1) == '!') {\n\t\t\t\t$reject[] = substr($arg, 1);\n\t\t\t} else {\n\t\t\t\t$accept[] = $arg;\n\t\t\t}\n\t\t}\n\t\t$result[0] = $accept;\n\t\t$result[1] = $reject;\n\t\treturn $result;\n\t}\n\n\tpublic function checkForValidationIssues($attribute) {\n\t\t$this->set($attribute);\n\t\tif ($this->validates()) {\n\t\t\treturn false;\n\t\t} else {\n\t\t\treturn $this->validationErrors;\n\t\t}\n\t}\n\n\n\tpublic function checkTemplateAttributes($template, $data, $event_id) {\n\t\t$result = array();\n\t\t$errors = array();\n\t\t$attributes = array();\n\t\tif (isset($data['Template']['fileArray'])) $fileArray = json_decode($data['Template']['fileArray'], true);\n\t\tforeach ($template['TemplateElement'] as $element) {\n\t\t\tif ($element['element_definition'] == 'attribute') {\n\t\t\t\t$result = $this->__resolveElementAttribute($element['TemplateElementAttribute'][0], $data['Template']['value_' . $element['id']]);\n\t\t\t} else if ($element['element_definition'] == 'file') {\n\t\t\t\t$temp = array();\n\t\t\t\tif (isset($fileArray)) {\n\t\t\t\t\tforeach ($fileArray as $fileArrayElement) {\n\t\t\t\t\t\tif ($fileArrayElement['element_id'] == $element['id']) {\n\t\t\t\t\t\t\t$temp[] = $fileArrayElement;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t$result = $this->__resolveElementFile($element['TemplateElementFile'][0], $temp);\n\t\t\t\tif ($element['TemplateElementFile'][0]['mandatory'] && empty($temp) && empty($errors[$element['id']])) $errors[$element['id']] = 'This field is mandatory.';\n\t\t\t}\n\t\t\tif ($element['element_definition'] == 'file' || $element['element_definition'] == 'attribute') {\n\t\t\t\tif ($result['errors']) {\n\t\t\t\t\t$errors[$element['id']] = $result['errors'];\n\t\t\t\t} else {\n\t\t\t\t\tforeach ($result['attributes'] as &$a) {\n\t\t\t\t\t\t$a['event_id'] = $event_id;\n\t\t\t\t\t\t$a['distribution'] = 5;\n\t\t\t\t\t\t$test = $this->checkForValidationIssues(array('Attribute' => $a));\n\t\t\t\t\t\tif ($test) {\n\t\t\t\t\t\t\tforeach ($test['value'] as $e) {\n\t\t\t\t\t\t\t\t$errors[$element['id']] = $e;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t$attributes[] = $a;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn array('attributes' => $attributes, 'errors' => $errors);\n\t}\n\n\n\tprivate function __resolveElementAttribute($element, $value) {\n\t\t$attributes = array();\n\t\t$results = array();\n\t\t$errors = null;\n\t\tif (!empty($value)) {\n\t\t\t\tif ($element['batch']) {\n\t\t\t\t$values = explode(\"\\n\", $value);\n\t\t\t\tforeach ($values as $v) {\n\t\t\t\t\t$v = trim($v);\n\t\t\t\t\t$attributes[] = $this->__createAttribute($element, $v);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t$attributes[] = $this->__createAttribute($element, trim($value));\n\t\t\t}\n\t\t\tforeach ($attributes as $att) {\n\t\t\t\tif (isset($att['multi'])) {\n\t\t\t\t\tforeach ($att['multi'] as $a) {\n\t\t\t\t\t\t$results[] = $a;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t$results[] = $att;\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tif ($element['mandatory']) $errors = 'This field is mandatory.';\n\t\t}\n\t\treturn array('attributes' => $results, 'errors' => $errors);\n\t}\n\n\tprivate function __resolveElementFile($element, $files) {\n\t\t$attributes = array();\n\t\t$errors = null;\n\t\t$element['complex'] = 0;\n\t\tif ($element['malware']) {\n\t\t\t$element['type'] = 'malware-sample';\n\t\t\t$element['to_ids'] = 1;\n\t\t} else {\n\t\t\t$element['type'] = 'attachment';\n\t\t\t$element['to_ids'] = 0;\n\t\t}\n\t\tforeach ($files as $file) {\n\t\t\tif (!$this->checkFilename($file['filename'])) {\n\t\t\t\t$errors = 'Filename not allowed.';\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif ($element['malware']) {\n\t\t\t\t$malwareName = $file['filename'] . '|' . hash_file('md5', APP . 'tmp/files/' . $file['tmp_name']);\n\t\t\t\t$tmp_file = new File(APP . 'tmp/files/' . $file['tmp_name']);\n\t\t\t\tif (!$tmp_file->readable()) {\n\t\t\t\t\t$errors = 'File cannot be read.';\n\t\t\t\t} else {\n\t\t\t\t\t$element['type'] = 'malware-sample';\n\t\t\t\t\t$attributes[] = $this->__createAttribute($element, $malwareName);\n\t\t\t\t\t$attributes[count($attributes) - 1]['data'] = $file['tmp_name'];\n\t\t\t\t\t$element['type'] = 'filename|sha256';\n\t\t\t\t\t$sha256 = $file['filename'] . '|' . (hash_file('sha256', APP . 'tmp/files/' . $file['tmp_name']));\n\t\t\t\t\t$attributes[] = $this->__createAttribute($element, $sha256);\n\t\t\t\t\t$element['type'] = 'filename|sha1';\n\t\t\t\t\t$sha1 = $file['filename'] . '|' . (hash_file('sha1', APP . 'tmp/files/' . $file['tmp_name']));\n\t\t\t\t\t$attributes[] = $this->__createAttribute($element, $sha1);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t$attributes[] = $this->__createAttribute($element, $file['filename']);\n\t\t\t\t$tmp_file = new File(APP . 'tmp/files/' . $file['tmp_name']);\n\t\t\t\tif (!$tmp_file->readable()) {\n\t\t\t\t\t$errors = 'File cannot be read.';\n\t\t\t\t} else {\n\t\t\t\t\t$attributes[count($attributes) - 1]['data'] = $file['tmp_name'];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn array('attributes' => $attributes, 'errors' => $errors, 'files' => $files);\n\t}\n\n\tprivate function __createAttribute($element, $value) {\n\t\t$attribute = array(\n\t\t\t\t'comment' => $element['name'],\n\t\t\t\t'to_ids' => $element['to_ids'],\n\t\t\t\t'category' => $element['category'],\n\t\t\t\t'value' => $value,\n\t\t);\n\t\tif ($element['complex']) {\n\t\t\tApp::uses('ComplexTypeTool', 'Tools');\n\t\t\t$complexTypeTool = new ComplexTypeTool();\n\t\t\t$result = $complexTypeTool->checkComplexRouter($value, ucfirst($element['type']));\n\t\t\tif (isset($result['multi'])) {\n\t\t\t\t$temp = $attribute;\n\t\t\t\t$attribute = array();\n\t\t\t\tforeach ($result['multi'] as $k => $r) {\n\t\t\t\t\t$attribute['multi'][] = $temp;\n\t\t\t\t\t$attribute['multi'][$k]['type'] = $r['type'];\n\t\t\t\t\t$attribute['multi'][$k]['value'] = $r['value'];\n\t\t\t\t}\n\t\t\t} else if ($result != false) {\n\t\t\t\t$attribute['type'] = $result['type'];\n\t\t\t\t$attribute['value'] = $result['value'];\n\t\t\t} else {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t} else {\n\t\t\t$attribute['type'] = $element['type'];\n\t\t}\n\t\treturn $attribute;\n\t}\n\n\tpublic function buildConditions($user) {\n\t\t$conditions = array();\n\t\tif (!$user['Role']['perm_site_admin']) {\n\t\t\t$sgids = $this->SharingGroup->fetchAllAuthorised($user);\n\t\t\t$conditions = array(\n\t\t\t\t'AND' => array(\n\t\t\t\t\tarray(\n\t\t\t\t\t\t'OR' => array(\n\t\t\t\t\t\t\t'Event.org_id' => $user['org_id'],\n\t\t\t\t\t\t\tarray(\n\t\t\t\t\t\t\t\t'AND' => array(\n\t\t\t\t\t\t\t\t\t'Event.distribution >' => 0,\n\t\t\t\t\t\t\t\t\t'Event.distribution <' => 4,\n\t\t\t\t\t\t\t\t\tConfigure::read('MISP.unpublishedprivate') ? array('Event.published =' => 1) : array(),\n\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\tarray(\n\t\t\t\t\t\t\t\t'AND' => array(\n\t\t\t\t\t\t\t\t\t'Event.sharing_group_id' => $sgids,\n\t\t\t\t\t\t\t\t\t'Event.distribution' => 4,\n\t\t\t\t\t\t\t\t\tConfigure::read('MISP.unpublishedprivate') ? array('Event.published =' => 1) : array(),\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t)\n\t\t\t\t\t),\n\t\t\t\t\tarray(\n\t\t\t\t\t\t'OR' => array(\n\t\t\t\t\t\t\t'Event.org_id' => $user['org_id'],\n\t\t\t\t\t\t\t'Attribute.distribution' => array('1', '2', '3', '5'),\n\t\t\t\t\t\t\t'AND '=> array(\n\t\t\t\t\t\t\t\t'Attribute.distribution' => 4,\n\t\t\t\t\t\t\t\t'Attribute.sharing_group_id' => $sgids,\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t)\n\t\t\t\t\t),\n\t\t\t\t\tarray(\n\t\t\t\t\t\t'OR' => array(\n\t\t\t\t\t\t\t'Attribute.object_id' => 0,\n\t\t\t\t\t\t\t'Event.org_id' => $user['org_id'],\n\t\t\t\t\t\t\t'Object.distribution' => array('1', '2', '3', '5'),\n\t\t\t\t\t\t\t'AND' => array(\n\t\t\t\t\t\t\t\t'Object.distribution' => 4,\n\t\t\t\t\t\t\t\t'Object.sharing_group_id' => $sgids,\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t)\n\t\t\t\t\t)\n\t\t\t\t)\n\t\t\t);\n\t\t}\n\t\treturn $conditions;\n\t}\n\n\tpublic function listVisibleAttributes($user, $options = array()) {\n\t\t$params = array(\n\t\t\t'conditions' => $this->buildConditions($user),\n\t\t\t'recursive' => -1,\n\t\t\t'fields' => array('Attribute.id', 'Attribute.id'),\n\t\t);\n\t\tif (isset($options['conditions'])) {\n\t\t\t$params['conditions']['AND'][] = $options['conditions'];\n\t\t}\n\t\treturn $this->find('list', $params);\n\t}\n\n\t/*\n\t * Unlike the other fetchers, this one foregoes any ACL checks.\n\t * the objective is simple: Fetch the given attribute with all related objects needed for the ZMQ output,\n\t * standardising on this function for fetching the attribute to be passed to Attribute->save()\n\t */\n\tpublic function fetchAttribute($id) {\n\t\t$attribute = $this->find('first', array(\n\t\t\t'recursive' => -1,\n\t\t\t'conditions' => array('Attribute.id' => $id),\n\t\t\t'contain' => array(\n\t\t\t\t'Event' => array(\n\t\t\t\t\t'Orgc' => array(\n\t\t\t\t\t\t'fields' => array('Orgc.id', 'Orgc.uuid', 'Orgc.name')\n\t\t\t\t\t),\n\t\t\t\t\t'fields' => array('Event.id', 'Event.date', 'Event.info', 'Event.uuid', 'Event.published', 'Event.analysis', 'Event.threat_level_id', 'Event.org_id', 'Event.orgc_id', 'Event.distribution', 'Event.sharing_group_id')\n\t\t\t\t),\n\t\t\t\t'AttributeTag' => array(\n\t\t\t\t\t'Tag' => array('fields' => array('Tag.id', 'Tag.name', 'Tag.colour', 'Tag.exportable'))\n\t\t\t\t),\n\t\t\t\t'Object'\n\t\t\t)\n\t\t));\n\t\tif (!empty($attribute)) {\n\t\t\tif (!empty($attribute['AttributeTag'])) {\n\t\t\t\tforeach ($attribute['AttributeTag'] as $at) {\n\t\t\t\t\tif ($at['Tag']['exportable']) $attribute['Attribute']['Tag'][] = $at['Tag'];\n\t\t\t\t}\n\t\t\t}\n\t\t\tunset($attribute['AttributeTag']);\n\t\t}\n\t\treturn $attribute;\n\t}\n\n\tpublic function fetchAttributesSimple($user, $options = array()) {\n\t\t$params = array(\n\t\t\t'conditions' => $this->buildConditions($user),\n\t\t\t'fields' => array(),\n\t\t\t'recursive' => -1\n\t\t);\n\t\tif (isset($options['conditions'])) {\n\t\t\t$params['conditions']['AND'][] = $options['conditions'];\n\t\t}\n\t\tif (isset($options['fields'])) {\n\t\t\t$params['fields'] = $options['fields'];\n\t\t}\n\t\t$results = $this->find('all', array(\n\t\t\t'conditions' => $params['conditions'],\n\t\t\t'recursive' => -1,\n\t\t\t'fields' => $params['fields'],\n\t\t\t'sort' => false\n\t\t));\n\t\treturn $results;\n\n\t}\n\n\t// Method that fetches all attributes for the various exports\n\t// very flexible, it's basically a replacement for find, with the addition that it restricts access based on user\n\t// options:\n\t//     fields\n\t//     contain\n\t//     conditions\n\t//     order\n\t//     group\n\tpublic function fetchAttributes($user, $options = array()) {\n\t\t$params = array(\n\t\t\t'conditions' => $this->buildConditions($user),\n\t\t\t'recursive' => -1,\n\t\t\t'contain' => array(\n\t\t\t\t'Event' => array(\n\t\t\t\t\t'fields' => array('id', 'info', 'org_id', 'orgc_id', 'uuid'),\n\t\t\t\t),\n\t\t\t\t'Object' => array(\n\t\t\t\t\t'fields' => array('id', 'distribution', 'sharing_group_id')\n\t\t\t\t)\n\t\t\t)\n\t\t);\n\t\t$params['contain']['AttributeTag'] = array('Tag' => array('conditions' => array()));\n\t\tif (empty($options['includeAllTags'])) $params['contain']['AttributeTag']['Tag']['conditions']['exportable'] = 1;\n\t\tif (isset($options['contain'])) $params['contain'] = array_merge_recursive($params['contain'], $options['contain']);\n\t\tif (isset($options['page'])) $params['page'] = $options['page'];\n\t\tif (isset($options['limit'])) $params['limit'] = $options['limit'];\n\t\telse $option['contain']['Event']['fields'] = array('id', 'info', 'org_id', 'orgc_id');\n\t\tif (Configure::read('MISP.proposals_block_attributes') && isset($options['conditions']['AND']['Attribute.to_ids']) && $options['conditions']['AND']['Attribute.to_ids'] == 1) {\n\t\t\t$this->bindModel(array('hasMany' => array('ShadowAttribute' => array('foreignKey' => 'old_id'))));\n\t\t\t$proposalRestriction =  array(\n\t\t\t\t\t'ShadowAttribute' => array(\n\t\t\t\t\t\t\t'conditions' => array(\n\t\t\t\t\t\t\t\t\t'AND' => array(\n\t\t\t\t\t\t\t\t\t\t\t'ShadowAttribute.deleted' => 0,\n\t\t\t\t\t\t\t\t\t\t\t'OR' => array(\n\t\t\t\t\t\t\t\t\t\t\t\t\t'ShadowAttribute.proposal_to_delete' => 1,\n\t\t\t\t\t\t\t\t\t\t\t\t\t'ShadowAttribute.to_ids' => 0\n\t\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t'fields' => array('ShadowAttribute.id')\n\t\t\t\t\t)\n\t\t\t);\n\t\t\t$params['contain'] = array_merge($params['contain'], $proposalRestriction);\n\t\t}\n\t\tif (isset($options['fields'])) $params['fields'] = $options['fields'];\n\t\tif (isset($options['conditions'])) $params['conditions']['AND'][] = $options['conditions'];\n\t\tif (empty($options['flatten'])) $params['conditions']['AND'][] = array('Attribute.object_id' => 0);\n\t\tif (isset($options['order'])) $params['order'] = $options['order'];\n\t\tif (!isset($options['withAttachments'])) $options['withAttachments'] = false;\n\t\telse ($params['order'] = array());\n\t\tif (!isset($options['enforceWarninglist'])) $options['enforceWarninglist'] = false;\n\t\tif (!$user['Role']['perm_sync'] || !isset($options['deleted']) || !$options['deleted']) $params['conditions']['AND']['Attribute.deleted'] = 0;\n\t\tif (isset($options['group'])) $params['group'] = empty($options['group']) ? $options['group'] : false;\n\t\tif (Configure::read('MISP.unpublishedprivate')) $params['conditions']['AND'][] = array('OR' => array('Event.published' => 1, 'Event.orgc_id' => $user['org_id']));\n\t\tif (!empty($options['list'])) {\n\t\t\tif (!empty($options['event_ids'])) {\n\t\t\t\t$fields = array('Attribute.event_id', 'Attribute.event_id');\n\t\t\t\t$group = array('Attribute.event_id');\n\t\t\t} else {\n\t\t\t\t$fields = array('Attribute.event_id');\n\t\t\t\t$group = false;\n\t\t\t}\n\t\t\t$results = $this->find('list', array(\n\t\t\t\t'conditions' => $params['conditions'],\n\t\t\t\t'recursive' => -1,\n\t\t\t\t'contain' => array('Event', 'Object'),\n\t\t\t\t'fields' => $fields,\n\t\t\t\t'group' => $group,\n\t\t\t\t'sort' => false\n\t\t\t));\n\t\t\treturn $results;\n\t\t}\n\t\t$results = $this->find('all', $params);\n\t\t// return false if we're paginating\n\t\tif (isset($options['limit']) && empty($results)) return false;\n\t\tif ($options['enforceWarninglist']) {\n\t\t\t$this->Warninglist = ClassRegistry::init('Warninglist');\n\t\t\t$warninglists = $this->Warninglist->fetchForEventView();\n\t\t}\n\t\t$results = array_values($results);\n\t\t$proposals_block_attributes = Configure::read('MISP.proposals_block_attributes');\n\t\tforeach ($results as $key => $attribute) {\n\t\t\tif ($options['enforceWarninglist'] && !$this->Warninglist->filterWarninglistAttributes($warninglists, $attribute['Attribute'])) {\n\t\t\t\tunset($results[$key]);\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (!empty($options['includeAttributeUuid']) || !empty($options['includeEventUuid'])) {\n\t\t\t\t$results[$key]['Attribute']['event_uuid'] = $results[$key]['Event']['uuid'];\n\t\t\t}\n\t\t\tif ($proposals_block_attributes) {\n\t\t\t\tif (!empty($attribute['ShadowAttribute'])) {\n\t\t\t\t\tunset($results[$key]);\n\t\t\t\t} else {\n\t\t\t\t\tunset($results[$key]['ShadowAttribute']);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif ($options['withAttachments']) {\n\t\t\t\tif ($this->typeIsAttachment($attribute['Attribute']['type'])) {\n\t\t\t\t\t$encodedFile = $this->base64EncodeAttachment($attribute['Attribute']);\n\t\t\t\t\t$results[$key]['Attribute']['data'] = $encodedFile;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn $results;\n\t}\n\n\t// Method gets and converts the contents of a file passed along as a base64 encoded string with the original filename into a zip archive\n\t// The zip archive is then passed back as a base64 encoded string along with the md5 hash and a flag whether the transaction was successful\n\t// The archive is password protected using the \"infected\" password\n\t// The contents of the archive will be the actual sample, named <md5> and the original filename in a text file named <md5>.filename.txt\n\tpublic function handleMaliciousBase64($event_id, $original_filename, $base64, $hash_types, $proposal = false) {\n\t\tif (!is_numeric($event_id)) throw new Exception('Something went wrong. Received a non-numeric event ID while trying to create a zip archive of an uploaded malware sample.');\n\t\t$attachments_dir = Configure::read('MISP.attachments_dir');\n\t\tif (empty($attachments_dir)) {\n\t\t\t$my_server = ClassRegistry::init('Server');\n\t\t\t$attachments_dir = $my_server->getDefaultAttachments_dir();\n\t\t}\n\t\tif ($proposal) {\n\t\t\t$dir = new Folder($attachments_dir . DS . $event_id . DS . 'shadow', true);\n\t\t} else {\n\t\t\t$dir = new Folder($attachments_dir . DS . $event_id, true);\n\t\t}\n\t\t$tmpFile = new File($dir->path . DS . $this->generateRandomFileName(), true, 0600);\n\t\t$tmpFile->write(base64_decode($base64));\n\t\t$hashes = array();\n\t\tforeach ($hash_types as $hash) {\n\t\t\t$hashes[$hash] = $this->__hashRouter($hash, $tmpFile->path);\n\t\t}\n\t\t$contentsFile = new File($dir->path . DS . $hashes['md5']);\n\t\trename($tmpFile->path, $contentsFile->path);\n\t\t$fileNameFile = new File($dir->path . DS . $hashes['md5'] . '.filename.txt');\n\t\t$fileNameFile->write($original_filename);\n\t\t$fileNameFile->close();\n\t\t$zipFile = new File($dir->path . DS . $hashes['md5'] . '.zip');\n\t\texec('zip -j -P infected ' . escapeshellarg($zipFile->path) . ' ' . escapeshellarg($contentsFile->path) . ' ' . escapeshellarg($fileNameFile->path), $execOutput, $execRetval);\n\t\tif ($execRetval != 0) $result = array('success' => false);\n\t\telse $result = array_merge(array('data' => base64_encode($zipFile->read()), 'success' => true), $hashes);\n\t\t$fileNameFile->delete();\n\t\t$zipFile->delete();\n\t\t$contentsFile->delete();\n\t\treturn $result;\n\t}\n\n\tprivate function __hashRouter($hashType, $file) {\n\t\t$validHashes = array('md5', 'sha1', 'sha256');\n\t\tif (!in_array($hashType, $validHashes)) return false;\n\t\tswitch ($hashType) {\n\t\t\tcase 'md5':\n\t\t\tcase 'sha1':\n\t\t\tcase 'sha256':\n\t\t\t\treturn hash_file($hashType, $file);\n\t\t\t\tbreak;\n\t\t}\n\t\treturn false;\n\t}\n\n\tpublic function generateRandomFileName() {\n\t\treturn (new RandomTool())->random_str(FALSE, 12);\n\t}\n\n\tpublic function resolveHashType($hash) {\n\t\t$hashTypes = $this->hashTypes;\n\t\t$validTypes = array();\n\t\t$length = strlen($hash);\n\t\tforeach ($hashTypes as $k => $hashType) {\n\t\t\t$temp = $hashType['lowerCase'] ? strtolower($hash) : $hash;\n\t\t\tif ($hashType['length'] == $length && preg_match($hashType['pattern'], $temp)) $validTypes[] = $k;\n\t\t}\n\t\treturn $validTypes;\n\t}\n\n\tpublic function validateAttribute($attribute, $context = true) {\n\t\t$this->set($attribute);\n\t\tif (!$context) {\n\t\t\tunset($this->validate['event_id']);\n\t\t\tunset($this->validate['value']['uniqueValue']);\n\t\t}\n\t\tif ($this->validates()) return true;\n\t\telse {\n\t\t\treturn $this->validationErrors;\n\t\t}\n\t}\n\n\tpublic function restore($id, $user) {\n\t\t$this->id = $id;\n\t\tif (!$this->exists()) return 'Attribute doesn\\'t exist, or you lack the permission to edit it.';\n\t\t$attribute = $this->find('first', array('conditions' => array('Attribute.id' => $id), 'recursive' => -1, 'contain' => array('Event')));\n\t\tif (!$user['Role']['perm_site_admin']) {\n\t\t\tif (!($attribute['Event']['orgc_id'] == $user['org_id'] && (($user['Role']['perm_modify'] && $attribute['Event']['user_id'] != $user['id']) || $user['Role']['perm_modify_org']))) {\n\t\t\t\treturn 'Attribute doesn\\'t exist, or you lack the permission to edit it.';\n\t\t\t}\n\t\t}\n\t\tunset($attribute['Attribute']['timestamp']);\n\t\t$attribute['Attribute']['deleted'] = 0;\n\t\t$date = new DateTime();\n\t\t$attribute['Attribute']['timestamp'] = $date->getTimestamp();\n\t\tif ($this->save($attribute['Attribute'])) {\n\t\t\t$attribute['Event']['published'] = 0;\n\t\t\t$attribute['Event']['timestamp'] = $date->getTimestamp();\n\t\t\t$this->Event->save($attribute['Event']);\n\t\t\treturn true;\n\t\t}\n\t\telse return 'Could not save changes.';\n\t}\n\n\tpublic function saveAttributes($attributes) {\n\t\t$defaultDistribution = 5;\n\t\tif (Configure::read('MISP.default_attribute_distribution') != null) {\n\t\t\tif (Configure::read('MISP.default_attribute_distribution') === 'event') {\n\t\t\t\t$defaultDistribution = 5;\n\t\t\t} else {\n\t\t\t\t$defaultDistribution = Configure::read('MISP.default_attribute_distribution');\n\t\t\t}\n\t\t}\n\t\tforeach ($attributes as $k => $attribute) {\n\t\t\tif (!empty($attribute['encrypt']) && $attribute['encrypt']) {\n\t\t\t\tif (strpos($attribute['value'], '|') !== false) {\n\t\t\t\t\t$temp = explode('|', $attribute['value']);\n\t\t\t\t\t$attribute['value'] = $temp[0];\n\t\t\t\t}\n\t\t\t\t$result = $this->handleMaliciousBase64($attribute['event_id'], $attribute['value'], $attribute['data'], array('md5'));\n\t\t\t\t$attribute['data'] = $result['data'];\n\t\t\t\t$attribute['value'] = $attribute['value'] . '|' . $result['md5'];\n\t\t\t}\n\t\t\tif (!isset($attribute['distribution'])) {\n\t\t\t\t$attribute['distribution'] = $defaultDistribution;\n\t\t\t}\n\t\t\tunset($attribute['Attachment']);\n\t\t\t$this->create();\n\t\t\t$this->save($attribute);\n\t\t}\n\t\treturn true;\n\t}\n\n\tpublic function saveAndEncryptAttribute($attribute, $user = false) {\n\t\t$hashes = array('md5' => 'malware-sample', 'sha1' => 'filename|sha1', 'sha256' => 'filename|sha256');\n\t\tif ($attribute['encrypt']) {\n\t\t\t$result = $this->handleMaliciousBase64($attribute['event_id'], $attribute['value'], $attribute['data'], array_keys($hashes));\n\t\t\tif (!$result['success']) {\n\t\t\t\treturn 'Could not handle the sample';\n\t\t\t}\n\t\t\tforeach ($hashes as $hash => $typeName) {\n\t\t\t\tif (!$result[$hash]) continue;\n\t\t\t\t$attributeToSave = array(\n\t\t\t\t\t'Attribute' => array(\n\t\t\t\t\t\t'value' => $attribute['value'] . '|' . $result[$hash],\n\t\t\t\t\t\t'category' => $attribute['category'],\n\t\t\t\t\t\t'type' => $typeName,\n\t\t\t\t\t\t'event_id' => $attribute['event_id'],\n\t\t\t\t\t\t'comment' => $attribute['comment'],\n\t\t\t\t\t\t'to_ids' => 1,\n\t\t\t\t\t\t'distribution' => $attribute['distribution'],\n\t\t\t\t\t\t'sharing_group_id' => isset($attribute['sharing_group_id']) ? $attribute['sharing_group_id'] : 0,\n\t\t\t\t\t)\n\t\t\t\t);\n\t\t\t\tif ($hash == 'md5') $attributeToSave['Attribute']['data'] = $result['data'];\n\t\t\t\t$this->create();\n\t\t\t\tif (!$this->save($attributeToSave)) {\n\t\t\t\t\treturn $this->validationErrors;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n\n\tpublic function convertToOpenIOC($user, $attributes) {\n\t\treturn $this->IOCExport->buildAll($this->Auth->user(), $event);\n\t}\n\n\tprivate function __createTagSubQuery($tag_id, $blocked = false, $scope = 'Event', $limitAttributeHitsTo = 'event') {\n\t\t$conditionKey = $blocked ? array('NOT' => array('EventTag.tag_id' => $tag_id)) : array('EventTag.tag_id' => $tag_id);\n\t\t$db = $this->getDataSource();\n\t\t$subQuery = $db->buildStatement(\n\t\t\tarray(\n\t\t\t\t'fields' => array($scope . 'Tag.' . $limitAttributeHitsTo . '_id'),\n\t\t\t\t'table' => strtolower($scope) . '_tags',\n\t\t\t\t'alias' => $scope . 'Tag',\n\t\t\t\t'limit' => null,\n\t\t\t\t'offset' => null,\n\t\t\t\t'joins' => array(),\n\t\t\t\t'conditions' => array(\n\t\t\t\t\t$scope . 'Tag.tag_id' => $tag_id\n\t\t\t\t),\n\t\t\t\t'group' => array($scope . 'Tag.' . $limitAttributeHitsTo . '_id')\n\t\t\t),\n\t\t\t$this\n\t\t);\n\t\t$subQuery = ucfirst($limitAttributeHitsTo) . '.id IN (' . $subQuery . ') ';\n\t\t$conditions = array(\n\t\t\t$db->expression($subQuery)->value\n\t\t);\n\t\treturn $conditions;\n\t}\n\n\tpublic function setTagConditions($tags, $conditions, $limitAttributeHitsTo = 'event') {\n\t\t$args = $this->dissectArgs($tags);\n\t\t$tagArray = $this->AttributeTag->Tag->fetchTagIdsFromFilter($args[0], $args[1]);\n\t\t$temp = array();\n\t\tif (!empty($tagArray[0])) {\n\t\t\t$temp['OR'][] = $this->__createTagSubQuery($tagArray[0]);\n\t\t\t$temp['OR'][] = $this->__createTagSubQuery($tagArray[0], false, 'Attribute', $limitAttributeHitsTo);\n\t\t}\n\t\tif (!empty($tagArray[1])) {\n\t\t\t$temp['AND']['NOT'] = $this->__createTagSubQuery($tagArray[1], true);\n\t\t\tif ($limitAttributeHitsTo == 'attribute') {\n\t\t\t\t$temp['AND']['NOT'] = $this->__createTagSubQuery($tagArray[1], true, 'Attribute', $limitAttributeHitsTo);\n\t\t\t}\n\t\t}\n\t\t$conditions['AND'][] = $temp;\n\t\treturn $conditions;\n\t}\n\n\tpublic function setPublishTimestampConditions($publish_timestamp, $conditions) {\n\t\tif (is_array($publish_timestamp)) {\n\t\t\t$conditions['AND'][] = array('Event.publish_timestamp >=' => $publish_timestamp[0]);\n\t\t\t$conditions['AND'][] = array('Event.publish_timestamp <=' => $publish_timestamp[1]);\n\t\t} else {\n\t\t\t$conditions['AND'][] = array('Event.publish_timestamp >=' => $publish_timestamp);\n\t\t}\n\t\treturn $conditions;\n\t}\n\n\tpublic function setTimestampConditions($timestamp, $conditions, $scope = 'Event') {\n\t\tif (is_array($timestamp)) {\n\t\t\t$conditions['AND'][] = array($scope . '.timestamp >=' => $timestamp[0]);\n\t\t\t$conditions['AND'][] = array($scope . '.timestamp <=' => $timestamp[1]);\n\t\t} else {\n\t\t\t$conditions['AND'][] = array($scope . '.timestamp >=' => $timestamp);\n\t\t}\n\t\treturn $conditions;\n\t}\n\n\tpublic function setToIDSConditions($to_ids, $conditions) {\n\t\tif ($to_ids === 'exclude') {\n\t\t\t$conditions['AND'][] = array('Attribute.to_ids' => 0);\n\t\t} else {\n\t\t\t$conditions['AND'][] = array('Attribute.to_ids' => 1);\n\t\t}\n\t\treturn $conditions;\n\t}\n\n\tpublic function setSimpleConditions($parameterKey, $parameterValue, $conditions) {\n\t\t$subcondition = array();\n\t\tApp::uses('CIDRTool', 'Tools');\n\t\t$cidr = new CIDRTool();\n\t\tif (is_array($parameterValue)) $elements = $parameterValue;\n\t\telse $elements = explode('&&', $parameterValue);\n\t\tforeach ($elements as $v) {\n\t\t\tif (empty($v)) continue;\n\t\t\tif (substr($v, 0, 1) == '!') {\n\t\t\t\t// check for an IPv4 address and subnet in CIDR notation (e.g. 127.0.0.1/8)\n\t\t\t\tif ($parameterKey === 'value' && $cidr->checkCIDR(substr($v, 1), 4)) {\n\t\t\t\t\t$cidrresults = $cidr->CIDR(substr($v, 1));\n\t\t\t\t\tforeach ($cidrresults as $result) {\n\t\t\t\t\t\t$subcondition['AND'][] = array('Attribute.value NOT LIKE' => $result);\n\t\t\t\t\t}\n\t\t\t\t} else if ($parameterKey === 'org') {\n\t\t\t\t\t\t// from here\n\t\t\t\t\t\t$found_orgs = $this->Event->Org->find('all', array(\n\t\t\t\t\t\t\t\t'recursive' => -1,\n\t\t\t\t\t\t\t\t'conditions' => array('LOWER(name) LIKE' => '%' . strtolower(substr($v, 1)) . '%'),\n\t\t\t\t\t\t));\n\t\t\t\t\t\tforeach ($found_orgs as $o) $subcondition['AND'][] = array('Event.orgc_id !=' => $o['Org']['id']);\n\t\t\t\t} else if ($parameterKey === 'eventid') {\n\t\t\t\t\t$subcondition['AND'][] = array('Attribute.event_id !=' => substr($v, 1));\n\t\t\t\t} else if ($parameterKey === 'uuid') {\n\t\t\t\t\t$subcondition['AND'][] = array('Event.uuid !=' => substr($v, 1));\n\t\t\t\t\t$subcondition['AND'][] = array('Attribute.uuid !=' => substr($v, 1));\n\t\t\t\t} else {\n\t\t\t\t\t$subcondition['AND'][] = array('Attribute.' . $parameterKey . ' NOT LIKE' => '%'.substr($v, 1).'%');\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// check for an IPv4 address and subnet in CIDR notation (e.g. 127.0.0.1/8)\n\t\t\t\tif ($parameterKey === 'value' && $cidr->checkCIDR($v, 4)) {\n\t\t\t\t\t$cidrresults = $cidr->CIDR($v);\n\t\t\t\t\tforeach ($cidrresults as $result) {\n\t\t\t\t\t\t$subcondition['OR'][] = array('Attribute.value LIKE' => $result);\n\t\t\t\t\t}\n\t\t\t\t} else if ($parameterKey === 'org') {\n\t\t\t\t\t// from here\n\t\t\t\t\t$found_orgs = $this->Event->Org->find('all', array(\n\t\t\t\t\t\t\t'recursive' => -1,\n\t\t\t\t\t\t\t'conditions' => array('LOWER(name) LIKE' => '%' . strtolower($v) . '%'),\n\t\t\t\t\t));\n\t\t\t\t\tforeach ($found_orgs as $o) $subcondition['OR'][] = array('Event.orgc_id' => $o['Org']['id']);\n\t\t\t\t} else if ($parameterKey === 'eventid') {\n\t\t\t\t\tif (!empty($v)) $subcondition['OR'][] = array('Attribute.event_id' => $v);\n\t\t\t\t} else if ($parameterKey === 'uuid') {\n\t\t\t\t\t$subcondition['OR'][] = array('Attribute.uuid' => $v);\n\t\t\t\t\t$subcondition['OR'][] = array('Event.uuid' => $v);\n\t\t\t\t} else {\n\t\t\t\t\tif (!empty($v)) $subcondition['OR'][] = array('Attribute.' . $parameterKey . ' LIKE' => '%'.$v.'%');\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tarray_push ($conditions['AND'], $subcondition);\n\t\treturn $conditions;\n\t}\n\n\tprivate function __getCIDRList() {\n\t\treturn $this->find('list', array(\n\t\t\t'conditions' => array(\n\t\t\t\t'type' => array('ip-src', 'ip-dst'),\n\t\t\t\t'value1 LIKE' => '%/%'\n\t\t\t),\n\t\t\t'fields' => array('value1'),\n\t\t\t'order' => false\n\t\t));\n\t}\n\n\tpublic function setCIDRList() {\n\t\t$redis = $this->setupRedis();\n\t\t$cidrList = array();\n\t\tif ($redis) {\n\t\t\t$redis->del('misp:cidr_cache_list');\n\t\t\t$cidrList = $this->__getCIDRList();\n\t\t\t$pipeline = $redis->multi(Redis::PIPELINE);\n\t\t\tforeach ($cidrList as $cidr) {\n\t\t\t\t$pipeline->sadd('misp:cidr_cache_list', $cidr);\n\t\t\t}\n\t\t\t$pipeline->exec();\n\t\t\t$redis->smembers('misp:cidr_cache_list');\n\t\t}\n\t\treturn $cidrList;\n\t}\n\n\tpublic function getSetCIDRList() {\n\t\t$redis = $this->setupRedis();\n\t\tif ($redis) {\n\t\t\tif (!$redis->exists('misp:cidr_cache_list') || $redis->sCard('misp:cidr_cache_list') == 0) {\n\t\t\t\t$cidrList = $this->setCIDRList($redis);\n\t\t\t} else {\n\t\t\t\t$cidrList = $redis->smembers('misp:cidr_cache_list');\n\t\t\t}\n\t\t} else {\n\t\t\t$cidrList = $this->__getCIDRList();\n\t\t}\n\t\treturn $cidrList;\n\t}\n\n\tpublic function fetchDistributionData($user) {\n\t\t$initialDistribution = 5;\n\t\tif (Configure::read('MISP.default_attribute_distribution') != null) {\n\t\t\tif (Configure::read('MISP.default_attribute_distribution') === 'event') {\n\t\t\t\t$initialDistribution = 5;\n\t\t\t} else {\n\t\t\t\t$initialDistribution = Configure::read('MISP.default_attribute_distribution');\n\t\t\t}\n\t\t}\n\t\t$sgs = $this->SharingGroup->fetchAllAuthorised($user, 'name', 1);\n\t\t$this->set('sharingGroups', $sgs);\n\t\t$distributionLevels = $this->distributionLevels;\n\t\tif (empty($sgs)) {\n\t\t\tunset($distributionLevels[4]);\n\t\t}\n\t\treturn array('sgs' => $sgs, 'levels' => $distributionLevels, 'initial' => $initialDistribution);\n\t}\n\n\tpublic function simpleAddMalwareSample($event_id, $attribute_settings, $filename, $tmpfile) {\n\t\t$attributes = array(\n\t\t\t'malware-sample' => array('type' => 'malware-sample', 'data' => 1, 'category' => '', 'to_ids' => 1, 'disable_correlation' => 0, 'object_relation' => 'malware-sample'),\n\t\t\t'filename' => array('type' => 'filename', 'category' => '', 'to_ids' => 0, 'disable_correlation' => 0, 'object_relation' => 'filename'),\n\t\t\t'md5' => array('type' => 'md5', 'category' => '', 'to_ids' => 1, 'disable_correlation' => 0, 'object_relation' => 'md5'),\n\t\t\t'sha1' => array('type' => 'sha1', 'category' => '', 'to_ids' => 1, 'disable_correlation' => 0, 'object_relation' => 'sha1'),\n\t\t\t'sha256' => array('type' => 'sha256', 'category' => '', 'to_ids' => 1, 'disable_correlation' => 0, 'object_relation' => 'sha256'),\n\t\t\t'size-in-bytes' => array('type' => 'size-in-bytes', 'category' => 'Other', 'to_ids' => 0, 'disable_correlation' => 1, 'object_relation' => 'size-in-bytes')\n\t\t);\n\t\t$hashes = array('md5', 'sha1', 'sha256');\n\t\t$this->Object = ClassRegistry::init('Object');\n\t\t$this->ObjectTemplate = ClassRegistry::init('ObjectTemplate');\n\t\t$current = $this->ObjectTemplate->find('first', array(\n\t\t\t'fields' => array('MAX(version) AS version', 'uuid'),\n\t\t\t'conditions' => array('uuid' => '688c46fb-5edb-40a3-8273-1af7923e2215'),\n\t\t\t'recursive' => -1,\n\t\t\t'group' => array('uuid')\n\t\t));\n\t\tif (!empty($current)) {\n\t\t\t$object_template = $this->ObjectTemplate->find('first', array(\n\t\t\t\t'conditions' => array(\n\t\t\t\t\t'ObjectTemplate.uuid' => '688c46fb-5edb-40a3-8273-1af7923e2215',\n\t\t\t\t\t'ObjectTemplate.version' => $current[0]['version']\n\t\t\t\t),\n\t\t\t\t'recursive' => -1\n\t\t\t));\n\t\t}\n\t\tif (empty($object_template)) {\n\t\t\t$object_template = array(\n\t\t\t\t'ObjectTemplate' => array(\n\t\t\t\t\t'meta-category' => 'file',\n\t\t\t\t\t'name' => 'file',\n\t\t\t\t\t'uuid' => '688c46fb-5edb-40a3-8273-1af7923e2215',\n\t\t\t\t\t'version' => 1,\n\t\t\t\t\t'description' => 'File object describing a file with meta-information'\n\t\t\t\t)\n\t\t\t);\n\t\t}\n\t\t$object = array(\n\t\t\t'distribution' => $attribute_settings['distribution'],\n\t\t\t'sharing_group_id' => isset($attribute_settings['sharing_group_id']) ? $attribute_settings['sharing_group_id'] : 0,\n\t\t\t'meta-category' => $object_template['ObjectTemplate']['meta-category'],\n\t\t\t'name' => $object_template['ObjectTemplate']['name'],\n\t\t\t'template_version' => $object_template['ObjectTemplate']['version'],\n\t\t\t'description' => $object_template['ObjectTemplate']['description'],\n\t\t\t'template_uuid' => $object_template['ObjectTemplate']['uuid'],\n\t\t\t'event_id' => $event_id,\n\t\t\t'comment' => !empty($attribute_settings['comment']) ? $attribute_settings['comment'] : ''\n\t\t);\n\t\t$result = $this->Event->Attribute->handleMaliciousBase64($event_id, $filename, base64_encode($tmpfile->read()), $hashes);\n\t\tforeach ($attributes as $k => $v) {\n\t\t\t$attribute = array(\n\t\t\t\t'distribution' => 5,\n\t\t\t\t'category' => empty($v['category']) ? $attribute_settings['category'] : $v['category'],\n\t\t\t\t'type' => $v['type'],\n\t\t\t\t'to_ids' => $v['to_ids'],\n\t\t\t\t'disable_correlation' => $v['disable_correlation'],\n\t\t\t\t'object_id' => $this->Object->id,\n\t\t\t\t'event_id' => $event_id,\n\t\t\t\t'object_relation' => $v['object_relation']\n\t\t\t);\n\t\t\tif (isset($v['data'])) {\n\t\t\t\t$attribute['data'] = $result['data'];\n\t\t\t}\n\t\t\tif ($k == 'malware-sample') {\n\t\t\t\t$attribute['value'] = $filename . '|' . $result['md5'];\n\t\t\t} else if ($k == 'size-in-bytes') {\n\t\t\t\t$attribute['value'] = $tmpfile->size();\n\t\t\t} else if ($k == 'filename') {\n\t\t\t\t$attribute['value'] = $filename;\n\t\t\t} else {\n\t\t\t\t$attribute['value'] = $result[$v['type']];\n\t\t\t}\n\t\t\t$object['Attribute'][] = $attribute;\n\t\t}\n\t\treturn array('Object' => array($object));\n\t}\n\n\tpublic function advancedAddMalwareSample($event_id, $attribute_settings, $filename, $tmpfile) {\n\t\t$execRetval = '';\n\t\t$execOutput = array();\n\t\t$result = shell_exec('python ' . APP . 'files/scripts/generate_file_objects.py -p ' . $tmpfile->path);\n\t\tif (!empty($result)) {\n\t\t\t$result = json_decode($result, true);\n\t\t\tif (isset($result['objects'])) {\n\t\t\t\t$result['Object'] = $result['objects'];\n\t\t\t\tunset($result['objects']);\n\t\t\t}\n\t\t\tif (isset($result['references'])) {\n\t\t\t\t$result['ObjectReference'] = $result['references'];\n\t\t\t\tunset($result['references']);\n\t\t\t}\n\t\t\tforeach ($result['Object'] as $k => $object) {\n\t\t\t\t$result['Object'][$k]['distribution'] = $attribute_settings['distribution'];\n\t\t\t\t$result['Object'][$k]['sharing_group_id'] = isset($attribute_settings['distribution']) ? $attribute_settings['distribution'] : 0;\n\t\t\t\tif (!empty($result['Object'][$k]['Attribute'])) {\n\t\t\t\t\tforeach ($result['Object'][$k]['Attribute'] as $k2 => $attribute) {\n\t\t\t\t\t\tif ($attribute['value'] == $tmpfile->name) {\n\t\t\t\t\t\t\t$result['Object'][$k]['Attribute'][$k2]['value'] = $filename;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!empty($attribute['encrypt'])) {\n\t\t\t\t\t\t\tif (!empty($attribute['encrypt']) && $attribute['encrypt']) {\n\t\t\t\t\t\t\t\t$encrypted = $this->handleMaliciousBase64($event_id, $filename, $attribute['data'], array('md5'));\n\t\t\t\t\t\t\t\t$result['Object'][$k]['Attribute'][$k2]['data'] = $encrypted['data'];\n\t\t\t\t\t\t\t\t$result['Object'][$k]['Attribute'][$k2]['value'] = $filename . '|' . $encrypted['md5'];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\t$result = $this->simpleAddMalwareSample($event_id, $attribute_settings, $filename, $tmpfile);\n\t\t}\n\t\treturn $result;\n\t}\n\n\t// gets an attribute, saves it\n\t// handles encryption, attaching to event/object, logging of issues, tag capturing\n\tpublic function captureAttribute($attribute, $eventId, $user, $objectId = false, $log = false) {\n\t\tif ($log == false) {\n\t\t\t$log = ClassRegistry::init('Log');\n\t\t}\n\t\t$attribute['event_id'] = $eventId;\n\t\t$attribute['object_id'] = $objectId ? $objectId : 0;\n\t\tunset($attribute['id']);\n\t\tif (isset($attribute['encrypt'])) {\n\t\t\t$result = $this->handleMaliciousBase64($eventId, $attribute['value'], $attribute['data'], array('md5'));\n\t\t}\n\t\t$fieldList = array(\n\t\t\t'event_id',\n\t\t\t'category',\n\t\t\t'type',\n\t\t\t'value',\n\t\t\t'value1',\n\t\t\t'value2',\n\t\t\t'to_ids',\n\t\t\t'uuid',\n\t\t\t'timestamp',\n\t\t\t'distribution',\n\t\t\t'comment',\n\t\t\t'sharing_group_id',\n\t\t\t'deleted',\n\t\t\t'disable_correlation',\n\t\t\t'object_id',\n\t\t\t'object_relation'\n\t\t);\n\t\t$this->create();\n\t\tif (!$this->save($attribute, array('fieldList' => $fieldList))) {\n\t\t\t$attribute_short = (isset($attribute['category']) ? $attribute['category'] : 'N/A') . '/' . (isset($attribute['type']) ? $attribute['type'] : 'N/A') . ' ' . (isset($attribute['value']) ? $attribute['value'] : 'N/A');\n\t\t\t$log->create();\n\t\t\t$log->save(array(\n\t\t\t\t\t'org' => $user['Organisation']['name'],\n\t\t\t\t\t'model' => 'Attribute',\n\t\t\t\t\t'model_id' => 0,\n\t\t\t\t\t'email' => $user['email'],\n\t\t\t\t\t'action' => 'add',\n\t\t\t\t\t'user_id' => $user['id'],\n\t\t\t\t\t'title' => 'Attribute dropped due to validation for Event ' . $eventId . ' failed: ' . $attribute_short,\n\t\t\t\t\t'change' => 'Validation errors: ' . json_encode($this->validationErrors) . ' Full Attribute: ' . json_encode($attribute),\n\t\t\t));\n\t\t\t} else {\n\t\t\t\tif (isset($attribute['AttributeTag'])) {\n\t\t\t\t\tforeach ($attribute['AttributeTag'] as $at) {\n\t\t\t\t\t\tunset($at['id']);\n\t\t\t\t\t\t$this->AttributeTag->create();\n\t\t\t\t\t\t$at['attribute_id'] = $this->id;\n\t\t\t\t\t\t$at['event_id'] = $eventId;\n\t\t\t\t\t\t$this->AttributeTag->save($at);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (!empty($attribute['Sighting'])) {\n\t\t\t\t\tforeach ($attribute['Sighting'] as $k => $sighting) {\n\t\t\t\t\t\t$this->Sighting->captureSighting($sighting, $this->id, $eventId, $user);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\treturn $attribute;\n\t}\n\n\tpublic function editAttribute($attribute, $eventId, $user, $objectId, $log = false) {\n\t\t$attribute['event_id'] = $eventId;\n\t\t$attribute['object_id'] = $objectId;\n\t\tif (isset($attribute['encrypt'])) {\n\t\t\t$result = $this->handleMaliciousBase64($eventId, $attribute['value'], $attribute['data'], array('md5'));\n\t\t\t$attribute['data'] = $result['data'];\n\t\t\t$attribute['value'] = $attribute['value'] . '|' . $result['md5'];\n\t\t}\n\t\tif (isset($attribute['uuid'])) {\n\t\t\t$existingAttribute = $this->find('first', array(\n\t\t\t\t'conditions' => array('Attribute.uuid' => $attribute['uuid']),\n\t\t\t\t'recursive' => -1\n\t\t\t));\n\t\t\t$this->Log = ClassRegistry::init('Log');\n\t\t\tif (count($existingAttribute)) {\n\t\t\t\tif ($existingAttribute['Attribute']['event_id'] != $eventId || $existingAttribute['Attribute']['object_id'] != $objectId) {\n\t\t\t\t\t$this->Log->create();\n\t\t\t\t\t$result = $this->Log->save(array(\n\t\t\t\t\t\t\t'org' => $user['Organisation']['name'],\n\t\t\t\t\t\t\t'model' => 'Attribute',\n\t\t\t\t\t\t\t'model_id' => 0,\n\t\t\t\t\t\t\t'email' => $user['email'],\n\t\t\t\t\t\t\t'action' => 'edit',\n\t\t\t\t\t\t\t'user_id' => $user['id'],\n\t\t\t\t\t\t\t'title' => 'Duplicate UUID found in attribute',\n\t\t\t\t\t\t\t'change' => 'An attribute was blocked from being saved due to a duplicate UUID. The uuid in question is: ' . $attribute['uuid'] . '. This can also be due to the same attribute (or an attribute with the same UUID) existing in a different event / object)',\n\t\t\t\t\t));\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\t// If a field is not set in the request, just reuse the old value\n\t\t\t\t$recoverFields = array('value', 'to_ids', 'distribution', 'category', 'type', 'comment', 'sharing_group_id', 'object_id', 'object_relation');\n\t\t\t\tforeach ($recoverFields as $rF) if (!isset($attribute[$rF])) $attribute[$rF] = $existingAttribute['Attribute'][$rF];\n\t\t\t\t$attribute['id'] = $existingAttribute['Attribute']['id'];\n\t\t\t\t// Check if the attribute's timestamp is bigger than the one that already exists.\n\t\t\t\t// If yes, it means that it's newer, so insert it. If no, it means that it's the same attribute or older - don't insert it, insert the old attribute.\n\t\t\t\t// Alternatively, we could unset this attribute from the request, but that could lead with issues if we decide that we want to start deleting attributes that don't exist in a pushed event.\n\t\t\t\tif (isset($attribute['timestamp'])) {\n\t\t\t\t\tif ($attribute['timestamp'] <= $existingAttribute['Attribute']['timestamp']) {\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t$date = new DateTime();\n\t\t\t\t\t$attribute['timestamp'] = $date->getTimestamp();;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t$this->create();\n\t\t\t}\n\t\t} else {\n\t\t\t$this->create();\n\t\t}\n\t$attribute['event_id'] = $eventId;\n\t\tif (isset($attribute['distribution']) && $attribute['distribution'] == 4) {\n\t\t\tif (!empty($attribute['SharingGroup'])) {\n\t\t\t\t$attribute['sharing_group_id'] = $this->SharingGroup->captureSG($attribute['SharingGroup'], $user);\n\t\t\t} elseif (!empty($attribute['sharing_group_id'])) {\n\t\t\t\tif (!$this->SharingGroup->checkIfAuthorised($user, $attribute['sharing_group_id'])) {\n\t\t\t\t\tunset($attribute['sharing_group_id']);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (empty($attribute['sharing_group_id'])) {\n\t\t\t\t$attribute_short = (isset($attribute['category']) ? $attribute['category'] : 'N/A') . '/' . (isset($attribute['type']) ? $attribute['type'] : 'N/A') . ' ' . (isset($attribute['value']) ? $attribute['value'] : 'N/A');\n\t\t\t\t$this->Log = ClassRegistry::init('Log');\n\t\t\t\t$this->Log->create();\n\t\t\t\t$this->Log->save(array(\n\t\t\t\t\t'org' => $user['Organisation']['name'],\n\t\t\t\t\t'model' => 'Attribute',\n\t\t\t\t\t'model_id' => 0,\n\t\t\t\t\t'email' => $user['email'],\n\t\t\t\t\t'action' => 'edit',\n\t\t\t\t\t'user_id' => $user['id'],\n\t\t\t\t\t'title' => 'Attribute dropped due to invalid sharing group for Event ' . $eventId . ' failed: ' . $attribute_short,\n\t\t\t\t\t'change' => 'Validation errors: ' . json_encode($this->validationErrors) . ' Full Attribute: ' . json_encode($attribute),\n\t\t\t\t));\n\t\t\t\treturn 'Invalid sharing group choice.';\n\t\t\t}\n\t\t}\n\t\t$fieldList = array(\n\t\t\t'event_id',\n\t\t\t'category',\n\t\t\t'type',\n\t\t\t'value',\n\t\t\t'value1',\n\t\t\t'value2',\n\t\t\t'to_ids',\n\t\t\t'uuid',\n\t\t\t'revision',\n\t\t\t'distribution',\n\t\t\t'timestamp',\n\t\t\t'comment',\n\t\t\t'sharing_group_id',\n\t\t\t'deleted',\n\t\t\t'disable_correlation'\n\t\t);\n\t\tif ($objectId) {\n\t\t\t$fieldList[] = 'object_id';\n\t\t\t$fieldList[] = 'object_relation';\n\t\t}\n\t\tif (!$this->save(array('Attribute' => $attribute), array('fieldList' => $fieldList))) {\n\t\t\t$attribute_short = (isset($attribute['category']) ? $attribute['category'] : 'N/A') . '/' . (isset($attribute['type']) ? $attribute['type'] : 'N/A') . ' ' . (isset($attribute['value']) ? $attribute['value'] : 'N/A');\n\t\t\t$this->Log = ClassRegistry::init('Log');\n\t\t\t$this->Log->create();\n\t\t\t$this->Log->save(array(\n\t\t\t\t'org' => $user['Organisation']['name'],\n\t\t\t\t'model' => 'Attribute',\n\t\t\t\t'model_id' => 0,\n\t\t\t\t'email' => $user['email'],\n\t\t\t\t'action' => 'edit',\n\t\t\t\t'user_id' => $user['id'],\n\t\t\t\t'title' => 'Attribute dropped due to validation for Event ' . $eventId . ' failed: ' . $attribute_short,\n\t\t\t\t'change' => 'Validation errors: ' . json_encode($this->validationErrors) . ' Full Attribute: ' . json_encode($attribute),\n\t\t\t));\n\t\t\treturn $this->validationErrors;\n\t\t} else {\n\t\t\tif (isset($attribute['Tag']) && $user['Role']['perm_tagger']) {\n\t\t\t\tforeach ($attribute['Tag'] as $tag) {\n\t\t\t\t\t$tag_id = $this->AttributeTag->Tag->captureTag($tag, $user);\n\t\t\t\t\tif ($tag_id) {\n\t\t\t\t\t\t// fix the IDs here\n\t\t\t\t\t\t$this->AttributeTag->attachTagToAttribute($this->id, $this->id, $tag_id);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// If we couldn't attach the tag it is most likely because we couldn't create it - which could have many reasons\n\t\t\t\t\t\t// However, if a tag couldn't be added, it could also be that the user is a tagger but not a tag editor\n\t\t\t\t\t\t// In which case if no matching tag is found, no tag ID is returned. Logging these is pointless as it is the correct behaviour.\n\t\t\t\t\t\tif ($user['Role']['perm_tag_editor']) {\n\t\t\t\t\t\t\t$this->Log->create();\n\t\t\t\t\t\t\t$this->Log->save(array(\n\t\t\t\t\t\t\t\t'org' => $user['Organisation']['name'],\n\t\t\t\t\t\t\t\t'model' => 'Attrubute',\n\t\t\t\t\t\t\t\t'model_id' => $this->id,\n\t\t\t\t\t\t\t\t'email' => $user['email'],\n\t\t\t\t\t\t\t\t'action' => 'edit',\n\t\t\t\t\t\t\t\t'user_id' => $user['id'],\n\t\t\t\t\t\t\t\t'title' => 'Failed create or attach Tag ' . $tag['name'] . ' to the attribute.',\n\t\t\t\t\t\t\t\t'change' => ''\n\t\t\t\t\t\t\t));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n}\n"], "fixing_code": ["<?php\n\nApp::uses('AppModel', 'Model');\nApp::uses('Folder', 'Utility');\nApp::uses('File', 'Utility');\nApp::uses('FinancialTool', 'Tools');\nApp::uses('RandomTool', 'Tools');\n\nclass Attribute extends AppModel {\n\n\tpublic $combinedKeys = array('event_id', 'category', 'type');\n\n\tpublic $name = 'Attribute';\t\t\t\t// TODO general\n\n\tpublic $actsAs = array(\n\t\t'SysLogLogable.SysLogLogable' => array(\t// TODO Audit, logable\n\t\t\t'userModel' => 'User',\n\t\t\t'userKey' => 'user_id',\n\t\t\t'change' => 'full'),\n\t\t'Trim',\n\t\t'Containable',\n\t\t'Regexp' => array('fields' => array('value')),\n\t);\n\n\tpublic $displayField = 'value';\n\n\tpublic $virtualFields = array(\n\t\t\t'value' => \"CASE WHEN Attribute.value2 = '' THEN Attribute.value1 ELSE CONCAT(Attribute.value1, '|', Attribute.value2) END\",\n\t); // TODO hardcoded\n\n\t // explanations of certain fields to be used in various views\n\tpublic $fieldDescriptions = array(\n\t\t\t'signature' => array('desc' => 'Is this attribute eligible to automatically create an IDS signature (network IDS or host IDS) out of it ?'),\n\t\t\t'distribution' => array('desc' => 'Describes who will have access to the event.')\n\t);\n\n\tpublic $distributionDescriptions = array(\n\t\t0 => array('desc' => 'This field determines the current distribution of the event', 'formdesc' => \"This setting will only allow members of your organisation on this server to see it.\"),\n\t\t1 => array('desc' => 'This field determines the current distribution of the event', 'formdesc' => \"Organisations that are part of this MISP community will be able to see the event.\"),\n\t\t2 => array('desc' => 'This field determines the current distribution of the event', 'formdesc' => \"Organisations that are either part of this MISP community or part of a directly connected MISP community will be able to see the event.\"),\n\t\t3 => array('desc' => 'This field determines the current distribution of the event', 'formdesc' => \"This will share the event with all MISP communities, allowing the event to be freely propagated from one server to the next.\"),\n\t\t4 => array('desc' => 'This field determines the current distribution of the event', 'formdesc' => \"This distribution of this event will be handled by the selected sharing group.\"),\n\t\t5 => array('desc' => 'This field determines the current distribution of the event', 'formdesc' => \"Inherit the event's distribution settings\"),\n\t);\n\n\tpublic $distributionLevels = array(\n\t\t\t0 => 'Your organisation only', 1 => 'This community only', 2 => 'Connected communities', 3 => 'All communities', 4 => 'Sharing group', 5 => 'Inherit event'\n\t);\n\n\tpublic $shortDist = array(0 => 'Organisation', 1 => 'Community', 2 => 'Connected', 3 => 'All', 4 => ' Sharing Group', 5 => 'Inherit');\n\n\t// these are definitions of possible types + their descriptions and maybe later other behaviors\n\t// e.g. if the attribute should be correlated with others or not\n\n\t// if these then a category may have upload to be zipped\n\tpublic $zippedDefinitions = array(\n\t\t\t'malware-sample'\n\t);\n\n\t// if these then a category may have upload\n\tpublic $uploadDefinitions = array(\n\t\t\t'attachment'\n\t);\n\n\t// skip Correlation for the following types\n\tpublic $nonCorrelatingTypes = array(\n\t\t\t'comment',\n\t\t\t'http-method',\n\t\t\t'aba-rtn',\n\t\t\t'gender',\n\t\t\t'counter',\n\t\t\t'port',\n\t\t\t'nationality',\n\t\t\t'cortex',\n\t\t\t'boolean'\n\t);\n\n\tpublic $primaryOnlyCorrelatingTypes = array(\n\t\t'ip-src|port',\n\t\t'ip-dst|port'\n\t);\n\n\tpublic $searchResponseTypes = array(\n\t\t'xml' => array(\n\t\t\t'type' => 'xml',\n\t\t\t'layout' => 'xml/default',\n\t\t\t'header' => 'Content-Disposition: download; filename=\"misp.search.attribute.results.xml\"'\n\t\t),\n\t\t'json' => array(\n\t\t\t'type' => 'json',\n\t\t\t'layout' => 'json/default',\n\t\t\t'header' => 'Content-Disposition: download; filename=\"misp.search.attribute.results.json\"'\n\t\t),\n\t\t'openioc' => array(\n\t\t\t'type' => 'xml',\n\t\t\t'layout' => 'xml/default',\n\t\t\t'header' => 'Content-Disposition: download; filename=\"misp.search.attribute.results.openioc.xml\"'\n\t\t),\n\t);\n\n\tpublic $typeDefinitions = array(\n\t\t\t'md5' => array('desc' => 'A checksum in md5 format', 'formdesc' => \"You are encouraged to use filename|md5 instead. A checksum in md5 format, only use this if you don't know the correct filename\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'sha1' => array('desc' => 'A checksum in sha1 format', 'formdesc' => \"You are encouraged to use filename|sha1 instead. A checksum in sha1 format, only use this if you don't know the correct filename\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'sha256' => array('desc' => 'A checksum in sha256 format', 'formdesc' => \"You are encouraged to use filename|sha256 instead. A checksum in sha256 format, only use this if you don't know the correct filename\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'filename' => array('desc' => 'Filename', 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'pdb' => array('desc' => 'Microsoft Program database (PDB) path information', 'default_category' => 'Artifacts dropped', 'to_ids' => 0),\n\t\t\t'filename|md5' => array('desc' => 'A filename and an md5 hash separated by a |', 'formdesc' => \"A filename and an md5 hash separated by a | (no spaces)\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'filename|sha1' => array('desc' => 'A filename and an sha1 hash separated by a |', 'formdesc' => \"A filename and an sha1 hash separated by a | (no spaces)\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'filename|sha256' => array('desc' => 'A filename and an sha256 hash separated by a |', 'formdesc' => \"A filename and an sha256 hash separated by a | (no spaces)\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'ip-src' => array('desc' => \"A source IP address of the attacker\", 'default_category' => 'Network activity', 'to_ids' => 1),\n\t\t\t'ip-dst' => array('desc' => 'A destination IP address of the attacker or C&C server', 'formdesc' => \"A destination IP address of the attacker or C&C server. Also set the IDS flag on when this IP is hardcoded in malware\", 'default_category' => 'Network activity', 'to_ids' => 1),\n\t\t\t'hostname' => array('desc' => 'A full host/dnsname of an attacker', 'formdesc' => \"A full host/dnsname of an attacker. Also set the IDS flag on when this hostname is hardcoded in malware\", 'default_category' => 'Network activity', 'to_ids' => 1),\n\t\t\t'domain' => array('desc' => 'A domain name used in the malware', 'formdesc' => \"A domain name used in the malware. Use this instead of hostname when the upper domain is important or can be used to create links between events.\", 'default_category' => 'Network activity', 'to_ids' => 1),\n\t\t\t'domain|ip' => array('desc' => 'A domain name and its IP address (as found in DNS lookup) separated by a |','formdesc' => \"A domain name and its IP address (as found in DNS lookup) separated by a | (no spaces)\", 'default_category' => 'Network activity', 'to_ids' => 1),\n\t\t\t'email-src' => array('desc' => \"The email address used to send the malware.\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'email-dst' => array('desc' => \"A recipient email address\", 'formdesc' => \"A recipient email address that is not related to your constituency.\", 'default_category' => 'Network activity', 'to_ids' => 1),\n\t\t\t'email-subject' => array('desc' => \"The subject of the email\", 'default_category' => 'Payload delivery', 'to_ids' => 0),\n\t\t\t'email-attachment' => array('desc' => \"File name of the email attachment.\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'email-body' => array('desc' => 'Email body', 'default_category' => 'Payload delivery', 'to_ids' => 0),\n\t\t\t'float' => array('desc' => \"A floating point value.\", 'default_category' => 'Other', 'to_ids' => 0),\n\t\t\t'url' => array('desc' => 'url', 'default_category' => 'External analysis', 'to_ids' => 1),\n\t\t\t'http-method' => array('desc' => \"HTTP method used by the malware (e.g. POST, GET, ...).\", 'default_category' => 'Network activity', 'to_ids' => 0),\n\t\t\t'user-agent' => array('desc' => \"The user-agent used by the malware in the HTTP request.\", 'default_category' => 'Network activity', 'to_ids' => 0),\n\t\t\t'regkey' => array('desc' => \"Registry key or value\", 'default_category' => 'Persistence mechanism', 'to_ids' => 1),\n\t\t\t'regkey|value' => array('desc' => \"Registry value + data separated by |\", 'default_category' => 'Persistence mechanism', 'to_ids' => 1),\n\t\t\t'AS' => array('desc' => 'Autonomous system', 'default_category' => 'Network activity', 'to_ids' => 0),\n\t\t\t'snort' => array('desc' => 'An IDS rule in Snort rule-format', 'formdesc' => \"An IDS rule in Snort rule-format. This rule will be automatically rewritten in the NIDS exports.\", 'default_category' => 'Network activity', 'to_ids' => 1),\n\t\t\t'pattern-in-file' => array('desc' => 'Pattern in file that identifies the malware', 'default_category' => 'Payload installation', 'to_ids' => 1),\n\t\t\t'pattern-in-traffic' => array('desc' => 'Pattern in network traffic that identifies the malware', 'default_category' => 'Network activity', 'to_ids' => 1),\n\t\t\t'pattern-in-memory' => array('desc' => 'Pattern in memory dump that identifies the malware', 'default_category' => 'Payload installation', 'to_ids' => 1),\n      'yara' => array('desc' => 'Yara signature', 'default_category' => 'Payload installation', 'to_ids' => 1),\n      'stix2-pattern' => array('desc' => 'STIX 2 pattern', 'default_category' => 'Payload installation', 'to_ids' => 1),\n      'sigma' => array('desc' => 'Sigma - Generic Signature Format for SIEM Systems', 'default_category' => 'Payload installation', 'to_ids' => 1),\n      'gene' => array('desc' => 'GENE - Go Evtx sigNature Engine', 'default_category' => 'Artifacts dropped', 'to_ids' => 0),\n      'mime-type' => array('desc' => 'A media type (also MIME type and content type) is a two-part identifier for file formats and format contents transmitted on the Internet', 'default_category' => 'Artifacts dropped', 'to_ids' => 0),\n      'identity-card-number' => array('desc' => 'Identity card number', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'cookie' => array('desc' => 'HTTP cookie as often stored on the user web client. This can include authentication cookie or session cookie.', 'default_category' => 'Network activity', 'to_ids' => 0),\n\t\t\t'vulnerability' => array('desc' => 'A reference to the vulnerability used in the exploit', 'default_category' => 'External analysis', 'to_ids' => 0),\n\t\t\t'attachment' => array('desc' => 'Attachment with external information', 'formdesc' => \"Please upload files using the <em>Upload Attachment</em> button.\", 'default_category' => 'External analysis', 'to_ids' => 0),\n\t\t\t'malware-sample' => array('desc' => 'Attachment containing encrypted malware sample', 'formdesc' => \"Please upload files using the <em>Upload Attachment</em> button.\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'link' => array('desc' => 'Link to an external information', 'default_category' => 'External analysis', 'to_ids' => 0),\n\t\t\t'comment' => array('desc' => 'Comment or description in a human language', 'formdesc' => 'Comment or description in a human language.  This will not be correlated with other attributes', 'default_category' => 'Other', 'to_ids' => 0),\n\t\t\t'text' => array('desc' => 'Name, ID or a reference', 'default_category' => 'Other', 'to_ids' => 0),\n\t\t\t'hex' => array('desc' => 'A value in hexadecimal format', 'default_category' => 'Other', 'to_ids' => 0),\n\t\t\t'other' => array('desc' => 'Other attribute', 'default_category' => 'Other', 'to_ids' => 0),\n\t\t\t'named pipe' => array('desc' => 'Named pipe, use the format \\\\.\\pipe\\<PipeName>', 'default_category' => 'Artifacts dropped', 'to_ids' => 0),\n\t\t\t'mutex' => array('desc' => 'Mutex, use the format \\BaseNamedObjects\\<Mutex>', 'default_category' => 'Artifacts dropped', 'to_ids' => 1),\n\t\t\t'target-user' => array('desc' => 'Attack Targets Username(s)', 'default_category' => 'Targeting data', 'to_ids' => 0),\n\t\t\t'target-email' => array('desc' => 'Attack Targets Email(s)', 'default_category' => 'Targeting data', 'to_ids' => 0),\n\t\t\t'target-machine' => array('desc' => 'Attack Targets Machine Name(s)', 'default_category' => 'Targeting data', 'to_ids' => 0),\n\t\t\t'target-org' => array('desc' => 'Attack Targets Department or Organization(s)', 'default_category' => 'Targeting data', 'to_ids' => 0),\n\t\t\t'target-location' => array('desc' => 'Attack Targets Physical Location(s)', 'default_category' => 'Targeting data', 'to_ids' => 0),\n\t\t\t'target-external' => array('desc' => 'External Target Organizations Affected by this Attack', 'default_category' => 'Targeting data', 'to_ids' => 0),\n\t\t\t'btc' => array('desc' => 'Bitcoin Address', 'default_category' => 'Financial fraud', 'to_ids' => 1),\n\t\t\t'iban' => array('desc' => 'International Bank Account Number', 'default_category' => 'Financial fraud', 'to_ids' => 1),\n\t\t\t'bic' => array('desc' => 'Bank Identifier Code Number also known as SWIFT-BIC, SWIFT code or ISO 9362 code', 'default_category' => 'Financial fraud', 'to_ids' => 1),\n\t\t\t'bank-account-nr' => array('desc' => 'Bank account number without any routing number', 'default_category' => 'Financial fraud', 'to_ids' => 1),\n\t\t\t'aba-rtn' => array('desc' => 'ABA routing transit number', 'default_category' => 'Financial fraud', 'to_ids' => 1),\n\t\t\t'bin' => array('desc' => 'Bank Identification Number', 'default_category' => 'Financial fraud', 'to_ids' => 1),\n\t\t\t'cc-number' => array('desc' => 'Credit-Card Number', 'default_category' => 'Financial fraud', 'to_ids' => 1),\n\t\t\t'prtn' => array('desc' => 'Premium-Rate Telephone Number', 'default_category' => 'Financial fraud', 'to_ids' => 1),\n\t\t\t'phone-number' => array('desc' => 'Telephone Number', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'threat-actor' => array('desc' => 'A string identifying the threat actor', 'default_category' => 'Attribution', 'to_ids' => 0),\n\t\t\t'campaign-name' => array('desc' => 'Associated campaign name', 'default_category' => 'Attribution', 'to_ids' => 0),\n\t\t\t'campaign-id' => array('desc' => 'Associated campaign ID', 'default_category' => 'Attribution', 'to_ids' => 0),\n\t\t\t'malware-type' => array('desc' => '', 'default_category' => 'Payload delivery', 'to_ids' => 0),\n\t\t\t'uri' => array('desc' => 'Uniform Resource Identifier', 'default_category' => 'Network activity', 'to_ids' => 1),\n\t\t\t'authentihash' => array('desc' => 'Authenticode executable signature hash', 'formdesc' => \"You are encouraged to use filename|authentihash instead. Authenticode executable signature hash, only use this if you don't know the correct filename\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'ssdeep' => array('desc' => 'A checksum in ssdeep format', 'formdesc' => \"You are encouraged to use filename|ssdeep instead. A checksum in the SSDeep format, only use this if you don't know the correct filename\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'imphash' => array('desc' => 'Import hash - a hash created based on the imports in the sample.', 'formdesc' => \"You are encouraged to use filename|imphash instead. A hash created based on the imports in the sample, only use this if you don't know the correct filename\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'pehash' => array('desc' => 'PEhash - a hash calculated based of certain pieces of a PE executable file', 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'impfuzzy' => array('desc' => 'A fuzzy hash of import table of Portable Executable format', 'formdesc' => \"You are encouraged to use filename|impfuzzy instead. A fuzzy hash created based on the imports in the sample, only use this if you don't know the correct filename\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'sha224' => array('desc' => 'A checksum in sha-224 format', 'formdesc' => \"You are encouraged to use filename|sha224 instead. A checksum in sha224 format, only use this if you don't know the correct filename\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'sha384' => array('desc' => 'A checksum in sha-384 format', 'formdesc' => \"You are encouraged to use filename|sha384 instead. A checksum in sha384 format, only use this if you don't know the correct filename\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'sha512' => array('desc' => 'A checksum in sha-512 format', 'formdesc' => \"You are encouraged to use filename|sha512 instead. A checksum in sha512 format, only use this if you don't know the correct filename\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'sha512/224' => array('desc' => 'A checksum in the sha-512/224 format', 'formdesc' => \"You are encouraged to use filename|sha512/224 instead. A checksum in sha512/224 format, only use this if you don't know the correct filename\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'sha512/256' => array('desc' => 'A checksum in the sha-512/256 format', 'formdesc' => \"You are encouraged to use filename|sha512/256 instead. A checksum in sha512/256 format, only use this if you don't know the correct filename\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'tlsh' => array('desc' => 'A checksum in the Trend Micro Locality Sensitive Hash format', 'formdesc' => \"You are encouraged to use filename|tlsh instead. A checksum in the Trend Micro Locality Sensitive Hash format, only use this if you don't know the correct filename\", 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'filename|authentihash' => array('desc' => 'A checksum in md5 format', 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'filename|ssdeep' => array('desc' => 'A checksum in ssdeep format', 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'filename|imphash' => array('desc' => 'Import hash - a hash created based on the imports in the sample.', 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'filename|impfuzzy' => array('desc' => 'Import fuzzy hash - a fuzzy hash created based on the imports in the sample.', 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'filename|pehash' => array('desc' => 'A filename and a PEhash separated by a |', 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'filename|sha224' => array('desc' => 'A filename and a sha-224 hash separated by a |', 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'filename|sha384' => array('desc' => 'A filename and a sha-384 hash separated by a |', 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'filename|sha512' => array('desc' => 'A filename and a sha-512 hash separated by a |', 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'filename|sha512/224' => array('desc' => 'A filename and a sha-512/224 hash separated by a |', 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'filename|sha512/256' => array('desc' => 'A filename and a sha-512/256 hash separated by a |', 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'filename|tlsh' => array('desc' => 'A filename and a Trend Micro Locality Sensitive Hash separated by a |', 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'windows-scheduled-task' => array('desc' => 'A scheduled task in windows', 'default_category' => 'Artifacts dropped', 'to_ids' => 0),\n\t\t\t'windows-service-name' => array('desc' => 'A windows service name. This is the name used internally by windows. Not to be confused with the windows-service-displayname.', 'default_category' => 'Artifacts dropped', 'to_ids' => 0),\n\t\t\t'windows-service-displayname' => array('desc' => 'A windows service\\'s displayname, not to be confused with the windows-service-name. This is the name that applications will generally display as the service\\'s name in applications.', 'default_category' => 'Artifacts dropped', 'to_ids' => 0),\n\t\t\t'whois-registrant-email' => array('desc' => 'The e-mail of a domain\\'s registrant, obtained from the WHOIS information.', 'default_category' => 'Attribution', 'to_ids' => 0),\n\t\t\t'whois-registrant-phone' => array('desc' => 'The phone number of a domain\\'s registrant, obtained from the WHOIS information.', 'default_category' => 'Attribution', 'to_ids' => 0),\n\t\t\t'whois-registrant-name' => array('desc' => 'The name of a domain\\'s registrant, obtained from the WHOIS information.', 'default_category' => 'Attribution', 'to_ids' => 0),\n\t\t\t'whois-registrant-org' => array('desc' => 'The org of a domain\\'s registrant, obtained from the WHOIS information.', 'default_category' => 'Attribution', 'to_ids' => 0),\n\t\t\t'whois-registrar' => array('desc' => 'The registrar of the domain, obtained from the WHOIS information.', 'default_category' => 'Attribution', 'to_ids' => 0),\n\t\t\t'whois-creation-date' => array('desc' => 'The date of domain\\'s creation, obtained from the WHOIS information.', 'default_category' => 'Attribution', 'to_ids' => 0),\n\t\t\t// 'targeted-threat-index' => array('desc' => ''), // currently not mapped!\n\t\t\t// 'mailslot' => array('desc' => 'MailSlot interprocess communication'), // currently not mapped!\n\t\t\t// 'pipe' => array('desc' => 'Pipeline (for named pipes use the attribute type \"named pipe\")'), // currently not mapped!\n\t\t\t// 'ssl-cert-attributes' => array('desc' => 'SSL certificate attributes'), // currently not mapped!\n\t\t\t'x509-fingerprint-sha1' => array('desc' => 'X509 fingerprint in SHA-1 format', 'default_category' => 'Network activity', 'to_ids' => 1),\n\t\t\t'x509-fingerprint-md5' => array('desc' => 'X509 fingerprint in MD5 format', 'default_category' => 'Network activity', 'to_ids' => 1),\n\t\t\t'x509-fingerprint-sha256' => array('desc' => 'X509 fingerprint in SHA-256 format', 'default_category' => 'Network activity', 'to_ids' => 1),\n\t\t\t'dns-soa-email' => array('desc' => 'RFC1035 mandates that DNS zones should have a SOA (Statement Of Authority) record that contains an email address where a PoC for the domain could be contacted. This can sometimes be used for attribution/linkage between different domains even if protected by whois privacy', 'default_category' => 'Attribution', 'to_ids' => 0),\n\t\t\t'size-in-bytes' => array('desc' => 'Size expressed in bytes', 'default_category' => 'Other', 'to_ids' => 0),\n\t\t\t'counter' => array('desc' => 'An integer counter, generally to be used in objects', 'default_category' => 'Other', 'to_ids' => 0),\n\t\t\t'datetime' => array('desc' => 'Datetime in the ISO 8601 format', 'default_category' => 'Other', 'to_ids' => 0),\n\t\t\t'cpe' => array('desc' => 'Common platform enumeration', 'default_category' => 'Other', 'to_ids' => 0),\n\t\t\t'port' => array('desc' => 'Port number', 'default_category' => 'Network activity', 'to_ids' => 0),\n\t\t\t'ip-dst|port' => array('desc' => 'IP destination and port number seperated by a |', 'default_category' => 'Network activity', 'to_ids' => 1),\n\t\t\t'ip-src|port' => array('desc' => 'IP source and port number seperated by a |', 'default_category' => 'Network activity', 'to_ids' => 1),\n\t\t\t'hostname|port' => array('desc' => 'Hostname and port number seperated by a |', 'default_category' => 'Network activity', 'to_ids' => 1),\n\t\t\t'mac-address' => array('desc' => 'Mac address', 'default_category' => 'Network activity', 'to_ids' => 0),\n\t\t\t'mac-eui-64' => array('desc' => 'Mac EUI-64 address', 'default_category' => 'Network activity', 'to_ids' => 0),\n\t\t\t// verify IDS flag defaults for these\n\t\t\t'email-dst-display-name' => array('desc' => 'Email destination display name', 'default_category' => 'Payload delivery', 'to_ids' => 0),\n\t\t\t'email-src-display-name' => array('desc' => 'Email source display name', 'default_category' => 'Payload delivery', 'to_ids' => 0),\n\t\t\t'email-header' => array('desc' => 'Email header', 'default_category' => 'Payload delivery', 'to_ids' => 0),\n\t\t\t'email-reply-to' => array('desc' => 'Email reply to header', 'default_category' => 'Payload delivery', 'to_ids' => 0),\n\t\t\t'email-x-mailer' => array('desc' => 'Email x-mailer header', 'default_category' => 'Payload delivery', 'to_ids' => 0),\n\t\t\t'email-mime-boundary' => array('desc' => 'The email mime boundary separating parts in a multipart email', 'default_category' => 'Payload delivery', 'to_ids' => 0),\n\t\t\t'email-thread-index' => array('desc' => 'The email thread index header', 'default_category' => 'Payload delivery', 'to_ids' => 0),\n\t\t\t'email-message-id' => array('desc' => 'The email message ID', 'default_category' => 'Payload delivery', 'to_ids' => 0),\n\t\t\t'github-username' => array('desc' => 'A github user name', 'default_category' => 'Social network', 'to_ids' => 0),\n\t\t\t'github-repository' => array('desc' => 'A github repository', 'default_category' => 'Social network', 'to_ids' => 0),\n\t\t\t'github-organisation' => array('desc' => 'A github organisation', 'default_category' => 'Social network', 'to_ids' => 0),\n\t\t\t'jabber-id' => array('desc' => 'Jabber ID', 'default_category' => 'Social network', 'to_ids' => 0),\n\t\t\t'twitter-id' => array('desc' => 'Twitter ID', 'default_category' => 'Social network', 'to_ids' => 0),\n\t\t\t'first-name' => array('desc' => 'First name of a natural person', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'middle-name' => array('desc' => 'Middle name of a natural person', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'last-name' => array('desc' => 'Last name of a natural person', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'date-of-birth' => array('desc' => 'Date of birth of a natural person (in YYYY-MM-DD format)', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'place-of-birth' => array('desc' => 'Place of birth of a natural person', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'gender' => array('desc' => 'The gender of a natural person (Male, Female, Other, Prefer not to say)', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'passport-number' => array('desc' => 'The passport number of a natural person', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'passport-country' => array('desc' => 'The country in which the passport was issued', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'passport-expiration' => array('desc' => 'The expiration date of a passport', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'redress-number' => array('desc' => 'The Redress Control Number is the record identifier for people who apply for redress through the DHS Travel Redress Inquiry Program (DHS TRIP). DHS TRIP is for travelers who have been repeatedly identified for additional screening and who want to file an inquiry to have erroneous information corrected in DHS systems', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'nationality' => array('desc' => 'The nationality of a natural person', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'visa-number' => array('desc' => 'Visa number', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'issue-date-of-the-visa' => array('desc' => 'The date on which the visa was issued', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'primary-residence' => array('desc' => 'The primary residence of a natural person', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'country-of-residence' => array('desc' => 'The country of residence of a natural person', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'special-service-request' => array('desc' => 'A Special Service Request is a function to an airline to provide a particular facility for A Passenger or passengers. ', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'frequent-flyer-number' => array('desc' => 'The frequent flyer number of a passenger', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t// Do we really need remarks? Or just use comment/text for this?\n\t\t\t//'remarks' => array('desc' => '', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'travel-details' => array('desc' => 'Travel details', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'payment-details' => array('desc' => 'Payment details', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'place-port-of-original-embarkation' => array('desc' => 'The orignal port of embarkation', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'place-port-of-clearance' => array('desc' => 'The port of clearance', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'place-port-of-onward-foreign-destination' => array('desc' => 'A Port where the passenger is transiting to', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'passenger-name-record-locator-number' => array('desc' => 'The Passenger Name Record Locator is a key under which the reservation for a trip is stored in the system. The PNR contains, among other data, the name, flight segments and address of the passenger. It is defined by a combination of five or six letters and numbers.', 'default_category' => 'Person', 'to_ids' => 0),\n\t\t\t'mobile-application-id' => array('desc' => 'The application id of a mobile application', 'default_category' => 'Payload delivery', 'to_ids' => 1),\n\t\t\t'cortex' => array('desc' => 'Cortex analysis result', 'default_category' => 'External analysis', 'to_ids' => 0),\n\t\t\t'boolean' => array('desc' => 'Boolean value - to be used in objects', 'default_category' => 'Other', 'to_ids' => 0)\n\t\t\t// Not convinced about this.\n\t\t\t//'url-regex' => array('desc' => '', 'default_category' => 'Person', 'to_ids' => 0),\n\t);\n\n\t// definitions of categories\n\tpublic $categoryDefinitions = array(\n\t\t\t'Internal reference' => array(\n\t\t\t\t\t'desc' => 'Reference used by the publishing party (e.g. ticket number)',\n\t\t\t\t\t'types' => array('text', 'link', 'comment', 'other', 'hex')\n\t\t\t\t\t),\n\t\t\t'Targeting data' => array(\n\t\t\t\t\t'desc' => 'Internal Attack Targeting and Compromise Information',\n\t\t\t\t\t'formdesc' => 'Targeting information to include recipient email, infected machines, department, and or locations.',\n\t\t\t\t\t'types' => array('target-user', 'target-email', 'target-machine', 'target-org', 'target-location', 'target-external', 'comment')\n\t\t\t\t\t),\n\t\t\t'Antivirus detection' => array(\n\t\t\t\t\t'desc' => 'All the info about how the malware is detected by the antivirus products',\n\t\t\t\t\t'formdesc' => 'List of anti-virus vendors detecting the malware or information on detection performance (e.g. 13/43 or 67%). Attachment with list of detection or link to VirusTotal could be placed here as well.',\n\t\t\t\t\t'types' => array('link', 'comment', 'text', 'hex', 'attachment', 'other')\n\t\t\t\t\t),\n\t\t\t'Payload delivery' => array(\n\t\t\t\t\t'desc' => 'Information about how the malware is delivered',\n\t\t\t\t\t'formdesc' => 'Information about the way the malware payload is initially delivered, for example information about the email or web-site, vulnerability used, originating IP etc. Malware sample itself should be attached here.',\n\t\t\t\t\t'types' => array('md5', 'sha1', 'sha224', 'sha256', 'sha384', 'sha512', 'sha512/224', 'sha512/256', 'ssdeep', 'imphash', 'impfuzzy','authentihash', 'pehash', 'tlsh', 'filename', 'filename|md5', 'filename|sha1', 'filename|sha224', 'filename|sha256', 'filename|sha384', 'filename|sha512', 'filename|sha512/224', 'filename|sha512/256', 'filename|authentihash', 'filename|ssdeep', 'filename|tlsh', 'filename|imphash','filename|impfuzzy', 'filename|pehash', 'mac-address', 'mac-eui-64', 'ip-src', 'ip-dst', 'ip-dst|port', 'ip-src|port', 'hostname', 'domain', 'email-src', 'email-dst', 'email-subject', 'email-attachment', 'email-body', 'url', 'user-agent', 'AS', 'pattern-in-file', 'pattern-in-traffic', 'stix2-pattern', 'yara', 'sigma', 'mime-type', 'attachment', 'malware-sample', 'link', 'malware-type', 'comment', 'text', 'hex', 'vulnerability', 'x509-fingerprint-sha1', 'x509-fingerprint-md5', 'x509-fingerprint-sha256', 'other', 'hostname|port', 'email-dst-display-name', 'email-src-display-name', 'email-header', 'email-reply-to', 'email-x-mailer', 'email-mime-boundary', 'email-thread-index', 'email-message-id', 'mobile-application-id', 'whois-registrant-email')\n\t\t\t\t\t),\n\t\t\t'Artifacts dropped' => array(\n\t\t\t\t\t'desc' => 'Any artifact (files, registry keys etc.) dropped by the malware or other modifications to the system',\n\t\t\t\t\t'types' => array('md5', 'sha1', 'sha224', 'sha256', 'sha384', 'sha512', 'sha512/224', 'sha512/256', 'ssdeep', 'imphash', 'impfuzzy','authentihash', 'filename', 'filename|md5', 'filename|sha1', 'filename|sha224', 'filename|sha256', 'filename|sha384', 'filename|sha512', 'filename|sha512/224', 'filename|sha512/256', 'filename|authentihash', 'filename|ssdeep', 'filename|tlsh', 'filename|imphash', 'filename|impfuzzy','filename|pehash', 'regkey', 'regkey|value', 'pattern-in-file', 'pattern-in-memory','pdb', 'stix2-pattern', 'yara', 'sigma', 'attachment', 'malware-sample', 'named pipe', 'mutex', 'windows-scheduled-task', 'windows-service-name', 'windows-service-displayname', 'comment', 'text', 'hex', 'x509-fingerprint-sha1', 'x509-fingerprint-md5', 'x509-fingerprint-sha256', 'other', 'cookie', 'gene', 'mime-type')\n\t\t\t\t\t),\n\t\t\t'Payload installation' => array(\n\t\t\t\t\t'desc' => 'Info on where the malware gets installed in the system',\n\t\t\t\t\t'formdesc' => 'Location where the payload was placed in the system and the way it was installed. For example, a filename|md5 type attribute can be added here like this: c:\\\\windows\\\\system32\\\\malicious.exe|41d8cd98f00b204e9800998ecf8427e.',\n\t\t\t\t\t'types' => array('md5', 'sha1', 'sha224', 'sha256', 'sha384', 'sha512', 'sha512/224', 'sha512/256', 'ssdeep', 'imphash','impfuzzy','authentihash', 'pehash', 'tlsh', 'filename', 'filename|md5', 'filename|sha1', 'filename|sha224', 'filename|sha256', 'filename|sha384', 'filename|sha512', 'filename|sha512/224', 'filename|sha512/256', 'filename|authentihash', 'filename|ssdeep', 'filename|tlsh', 'filename|imphash', 'filename|impfuzzy','filename|pehash', 'pattern-in-file', 'pattern-in-traffic', 'pattern-in-memory', 'stix2-pattern', 'yara', 'sigma', 'vulnerability', 'attachment', 'malware-sample', 'malware-type', 'comment', 'text', 'hex', 'x509-fingerprint-sha1', 'x509-fingerprint-md5', 'x509-fingerprint-sha256', 'mobile-application-id', 'other', 'mime-type')\n\t\t\t\t\t),\n\t\t\t'Persistence mechanism' => array(\n\t\t\t\t\t'desc' => 'Mechanisms used by the malware to start at boot',\n\t\t\t\t\t'formdesc' => 'Mechanisms used by the malware to start at boot. This could be a registry key, legitimate driver modification, LNK file in startup',\n\t\t\t\t\t'types' => array('filename', 'regkey', 'regkey|value', 'comment', 'text', 'other', 'hex')\n\t\t\t\t\t),\n\t\t\t'Network activity' => array(\n\t\t\t\t\t'desc' => 'Information about network traffic generated by the malware',\n\t\t\t\t\t'types' => array('ip-src', 'ip-dst', 'ip-dst|port', 'ip-src|port', 'port', 'hostname', 'domain', 'domain|ip', 'mac-address', 'mac-eui-64', 'email-dst', 'url', 'uri', 'user-agent', 'http-method', 'AS', 'snort', 'pattern-in-file', 'stix2-pattern', 'pattern-in-traffic', 'attachment', 'comment', 'text', 'x509-fingerprint-sha1', 'other', 'hex', 'cookie')\n\t\t\t\t\t),\n\t\t\t'Payload type' => array(\n\t\t\t\t\t'desc' => 'Information about the final payload(s)',\n\t\t\t\t\t'formdesc' => 'Information about the final payload(s). Can contain a function of the payload, e.g. keylogger, RAT, or a name if identified, such as Poison Ivy.',\n\t\t\t\t\t'types' => array('comment', 'text', 'other')\n\t\t\t\t\t),\n\t\t\t'Attribution' => array(\n\t\t\t\t\t'desc' => 'Identification of the group, organisation, or country behind the attack',\n\t\t\t\t\t'types' => array('threat-actor', 'campaign-name', 'campaign-id', 'whois-registrant-phone', 'whois-registrant-email', 'whois-registrant-name', 'whois-registrant-org', 'whois-registrar', 'whois-creation-date','comment', 'text', 'x509-fingerprint-sha1','x509-fingerprint-md5', 'x509-fingerprint-sha256', 'other', 'dns-soa-email')\n\t\t\t\t\t),\n\t\t\t'External analysis' => array(\n\t\t\t\t\t'desc' => 'Any other result from additional analysis of the malware like tools output',\n\t\t\t\t\t'formdesc' => 'Any other result from additional analysis of the malware like tools output Examples: pdf-parser output, automated sandbox analysis, reverse engineering report.',\n\t\t\t\t\t'types' => array('md5', 'sha1', 'sha256','filename', 'filename|md5', 'filename|sha1', 'filename|sha256', 'ip-src', 'ip-dst', 'ip-dst|port', 'ip-src|port', 'mac-address', 'mac-eui-64', 'hostname', 'domain', 'domain|ip', 'url', 'user-agent', 'regkey', 'regkey|value', 'AS', 'snort', 'pattern-in-file', 'pattern-in-traffic', 'pattern-in-memory', 'vulnerability', 'attachment', 'malware-sample', 'link', 'comment', 'text', 'x509-fingerprint-sha1', 'x509-fingerprint-md5', 'x509-fingerprint-sha256', 'github-repository', 'other', 'cortex')\n\t\t\t\t\t),\n\t\t\t'Financial fraud' => array(\n\t\t\t\t\t'desc' => 'Financial Fraud indicators',\n\t\t\t\t\t'formdesc' => 'Financial Fraud indicators, for example: IBAN Numbers, BIC codes, Credit card numbers, etc.',\n\t\t\t\t\t'types' => array('btc', 'iban', 'bic', 'bank-account-nr', 'aba-rtn', 'bin', 'cc-number', 'prtn', 'phone-number', 'comment', 'text', 'other', 'hex'),\n\t\t\t\t\t),\n\t\t\t'Support Tool' => array(\n\t\t\t\t\t'desc' => 'Tools supporting analysis or detection of the event',\n\t\t\t\t\t'types' => array('link', 'text', 'attachment', 'comment', 'other', 'hex')\n\t\t\t),\n\t\t\t'Social network' => array(\n\t\t\t\t\t'desc' => 'Social networks and platforms',\n\t\t\t\t\t// email-src and email-dst or should we go with a new email type that is neither / both?\n\t\t\t\t\t'types' => array('github-username', 'github-repository', 'github-organisation', 'jabber-id', 'twitter-id', 'email-src', 'email-dst', 'comment', 'text', 'other', 'whois-registrant-email')\n\t\t\t),\n\t\t\t'Person' => array(\n\t\t\t\t\t'desc' => 'A human being - natural person',\n\t\t\t\t\t'types' => array('first-name', 'middle-name', 'last-name', 'date-of-birth', 'place-of-birth', 'gender', 'passport-number', 'passport-country', 'passport-expiration', 'redress-number', 'nationality', 'visa-number', 'issue-date-of-the-visa', 'primary-residence', 'country-of-residence', 'special-service-request', 'frequent-flyer-number', 'travel-details', 'payment-details', 'place-port-of-original-embarkation', 'place-port-of-clearance', 'place-port-of-onward-foreign-destination', 'passenger-name-record-locator-number', 'comment', 'text', 'other', 'phone-number', 'identity-card-number')\n\t\t\t),\n\t\t\t'Other' => array(\n\t\t\t\t\t'desc' => 'Attributes that are not part of any other category or are meant to be used as a component in MISP objects in the future',\n\t\t\t\t\t'types' => array('comment', 'text', 'other', 'size-in-bytes', 'counter', 'datetime', 'cpe', 'port', 'float', 'hex', 'phone-number', 'boolean')\n\t\t\t\t\t)\n\t);\n\n\t// FIXME we need a better way to list the defaultCategories knowing that new attribute types will continue to appear in the future. We should generate this dynamically or use a function using the default_category of the $typeDefinitions\n\tpublic $defaultCategories = array(\n\t\t\t'md5' => 'Payload delivery',\n\t\t\t'sha1' => 'Payload delivery',\n\t\t\t'sha224' =>'Payload delivery',\n\t\t\t'sha256' => 'Payload delivery',\n\t\t\t'sha384' => 'Payload delivery',\n\t\t\t'sha512' => 'Payload delivery',\n\t\t\t'sha512/224' => 'Payload delivery',\n\t\t\t'sha512/256' => 'Payload delivery',\n\t\t\t'authentihash' => 'Payload delivery',\n\t\t\t'imphash' => 'Payload delivery',\n\t\t\t'impfuzzy'=> 'Payload delivery',\n\t\t\t'pehash' => 'Payload delivery',\n\t\t\t'filename|md5' => 'Payload delivery',\n\t\t\t'filename|sha1' => 'Payload delivery',\n\t\t\t'filename|sha256' => 'Payload delivery',\n\t\t\t'regkey' => 'Persistence mechanism',\n\t\t\t'filename' => 'Payload delivery',\n\t\t\t'ip-src' => 'Network activity',\n\t\t\t'ip-dst' => 'Network activity',\n\t\t\t'ip-dst|port' => 'Network activity',\n\t\t\t'mac-address' => 'Network activity',\n\t\t\t'mac-eui-64' => 'Network activity',\n\t\t\t'hostname' => 'Network activity',\n\t\t\t'domain' => 'Network activity',\n\t\t\t'url' => 'Network activity',\n\t\t\t'link' => 'External analysis',\n\t\t\t'email-src' => 'Payload delivery',\n\t\t\t'email-dst' => 'Payload delivery',\n\t\t\t'text' => 'Other',\n\t\t\t'hex' => 'Other',\n\t\t\t'attachment' => 'External analysis',\n\t\t\t'malware-sample' => 'Payload delivery',\n\t\t\t'cortex' => 'External analysis',\n\t\t\t'dns-soa-email' => 'Attribution',\n\t\t\t'boolean' => 'Other'\n\t);\n\n\t// typeGroupings are a mapping to high level groups for attributes\n\t// for example, IP addresses, domain names, hostnames and e-mail addresses are network related attribute types\n\t// whilst filenames and hashes are file related attribute types\n\t// This helps generate quick filtering for the event view, but we may reuse this and enhance it in the future for other uses (such as the API?)\n\tpublic $typeGroupings = array(\n\t\t'file' => array('attachment', 'pattern-in-file', 'md5', 'sha1', 'sha224', 'sha256', 'sha384', 'sha512', 'sha512/224', 'sha512/256', 'ssdeep', 'imphash', 'impfuzzy','authentihash', 'pehash', 'tlsh', 'filename', 'filename|md5', 'filename|sha1', 'filename|sha224', 'filename|sha256', 'filename|sha384', 'filename|sha512', 'filename|sha512/224', 'filename|sha512/256', 'filename|authentihash', 'filename|ssdeep', 'filename|tlsh', 'filename|imphash', 'filename|pehash', 'malware-sample', 'x509-fingerprint-sha1', 'x509-fingerprint-sha256', 'x509-fingerprint-md5'),\n        'network' => array('ip-src', 'ip-dst', 'ip-src|port', 'ip-dst|port', 'mac-address', 'mac-eui-64', 'hostname', 'hostname|port', 'domain', 'domain|ip', 'email-dst', 'url', 'uri', 'user-agent', 'http-method', 'AS', 'snort', 'pattern-in-traffic', 'x509-fingerprint-md5', 'x509-fingerprint-sha1', 'x509-fingerprint-sha256'),\n        'financial' => array('btc', 'iban', 'bic', 'bank-account-nr', 'aba-rtn', 'bin', 'cc-number', 'prtn', 'phone-number')\n\t);\n\n\tpublic $order = array(\"Attribute.event_id\" => \"DESC\");\n\n\tpublic $validate = array(\n\t\t'event_id' => array(\n\t\t\t'numeric' => array(\n\t\t\t\t'rule' => array('numeric'),\n\t\t\t\t//'message' => 'Your custom message here',\n\t\t\t\t//'allowEmpty' => false,\n\t\t\t\t//'required' => false,\n\t\t\t\t//'last' => false, // Stop validation after this rule\n\t\t\t\t//'on' => 'create', // Limit validation to 'create' or 'update' operations\n\t\t\t),\n\t\t),\n\t\t'type' => array(\n\t\t\t// currently when adding a new attribute type we need to change it in both places\n\t\t\t'rule' => array('validateTypeValue'),\n\t\t\t'message' => 'Options depend on the selected category.',\n\t\t\t//'allowEmpty' => false,\n\t\t\t'required' => true,\n\t\t\t//'last' => false, // Stop validation after this rule\n\t\t\t//'on' => 'create', // Limit validation to 'create' or 'update' operations\n\n\t\t),\n\t\t// this could be initialized from categoryDefinitions but dunno how at the moment\n\t\t'category' => array(\n\t\t\t'rule' => array('validCategory'),\n\t\t\t'message' => 'Options : Payload delivery, Antivirus detection, Payload installation, Files dropped ...'\n\t\t),\n\t\t'value' => array(\n\t\t\t'valueNotEmpty' => array(\n\t\t\t\t'rule' => array('valueNotEmpty'),\n\t\t\t),\n\t\t\t'userdefined' => array(\n\t\t\t\t'rule' => array('validateAttributeValue'),\n\t\t\t\t'message' => 'Value not in the right type/format. Please double check the value or select type \"other\".',\n\t\t\t\t//'allowEmpty' => false,\n\t\t\t\t//'required' => true,\n\t\t\t\t//'last' => false, // Stop validation after this rule\n\t\t\t\t//'on' => 'create', // Limit validation to 'create' or 'update' operations\n\t\t\t),\n\t\t\t'uniqueValue' => array(\n\t\t\t\t\t'rule' => array('valueIsUnique'),\n\t\t\t\t\t'message' => 'A similar attribute already exists for this event.',\n\t\t\t\t\t//'allowEmpty' => false,\n\t\t\t\t\t//'required' => true,\n\t\t\t\t\t//'last' => false, // Stop validation after this rule\n\t\t\t\t\t//'on' => 'create', // Limit validation to 'create' or 'update' operations\n\t\t\t),\n\t\t\t'validComposite' => array(\n\t\t\t\t'rule' => array('validComposite'),\n\t\t\t\t'message' => 'Composite type found but the value not in the composite (value1|value2) format.'\n\t\t\t)\n\t\t),\n\t\t'to_ids' => array(\n\t\t\t'boolean' => array(\n\t\t\t\t'rule' => array('boolean'),\n\t\t\t\t//'message' => 'Your custom message here',\n\t\t\t\t//'allowEmpty' => false,\n\t\t\t\t'required' => false,\n\t\t\t\t//'last' => false, // Stop validation after this rule\n\t\t\t\t//'on' => 'create', // Limit validation to 'create' or 'update' operations\n\t\t\t),\n\t\t),\n\t\t'uuid' => array(\n\t\t\t'uuid' => array(\n\t\t\t\t'rule' => array('custom', '/^[a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12}$/'),\n\t\t\t\t'message' => 'Please provide a valid UUID'\n\t\t\t),\n\t\t\t'unique' => array(\n\t\t\t\t'rule' => 'isUnique',\n\t\t\t\t'message' => 'The UUID provided is not unique',\n\t\t\t\t'required' => 'create'\n\t\t\t)\n\t\t),\n\t\t'distribution' => array(\n\t\t\t\t'rule' => array('inList', array('0', '1', '2', '3', '4', '5')),\n\t\t\t\t'message' => 'Options: Your organisation only, This community only, Connected communities, All communities, Sharing group, Inherit event',\n\t\t\t\t//'allowEmpty' => false,\n\t\t\t\t'required' => true,\n\t\t\t\t//'last' => false, // Stop validation after this rule\n\t\t\t\t//'on' => 'create', // Limit validation to 'create' or 'update' operations\n\t\t),\n\t);\n\n\t// automatic resolution of complex types\n\t// If the complex type \"file\" is chosen for example, then the system will try to categorise the values entered into a complex template field based\n\t// on the regular expression rules\n\tpublic $validTypeGroups = array(\n\t\t\t'File' => array(\n\t\t\t\t'description' => '',\n\t\t\t\t'types' => array('filename', 'filename|md5', 'filename|sha1', 'filename|sha256', 'md5', 'sha1', 'sha256'),\n\t\t\t),\n\t\t\t'CnC' => array(\n\t\t\t\t'description' => '',\n\t\t\t\t'types' => array('url', 'domain', 'hostname', 'ip-dst'),\n\t\t\t),\n\t);\n\n\tpublic $typeGroupCategoryMapping = array(\n\t\t\t'Payload delivery' => array('File', 'CnC'),\n\t\t\t'Payload installation' => array('File'),\n\t\t\t'Artifacts dropped' => array('File'),\n\t\t\t'Network activity' => array('CnC'),\n\t);\n\n\tpublic function __construct($id = false, $table = null, $ds = null) {\n\t\tparent::__construct($id, $table, $ds);\n\t}\n\n\tpublic $belongsTo = array(\n\t\t'Event' => array(\n\t\t\t'className' => 'Event',\n\t\t\t'foreignKey' => 'event_id',\n\t\t\t'conditions' => '',\n\t\t\t'fields' => '',\n\t\t\t//'counterCache' => 'attribute_count',\n\t\t\t//'counterScope' => array('Attribute.deleted' => 0),\n\t\t\t'order' => ''\n\t\t),\n\t\t'SharingGroup' => array(\n\t\t\t\t'className' => 'SharingGroup',\n\t\t\t\t'foreignKey' => 'sharing_group_id'\n\t\t),\n\t\t'Object' => array(\n\t\t\t'className' => 'MispObject',\n\t\t\t'foreignKey' => 'object_id'\n\t\t)\n\t);\n\n\tpublic $hasMany = array(\n\t\t'AttributeTag' => array(\n\t\t\t'dependent' => true\n\t\t),\n\t\t'Sighting' => array(\n\t\t\t\t'className' => 'Sighting',\n\t\t\t\t'dependent' => true,\n\t\t)\n\t);\n\n\tpublic $hashTypes = array(\n\t\t'md5' => array(\n\t\t\t'length' => 32,\n\t\t\t'pattern' => '#^[0-9a-f]{32}$#',\n\t\t\t'lowerCase' => true,\n\t\t),\n\t\t'sha1' => array(\n\t\t\t'length' => 40,\n\t\t\t'pattern' => '#^[0-9a-f]{40}$#',\n\t\t\t'lowerCase' => true,\n\t\t),\n\t\t'sha256' => array(\n\t\t\t'length' => 64,\n\t\t\t'pattern' => '#^[0-9a-f]{64}$#',\n\t\t\t'lowerCase' => true,\n\t\t)\n\t);\n\n\tpublic function afterFind($results, $primary = false) {\n\t\tforeach ($results as $k => $v) {\n\t\t\tif (isset($v['Attribute']['object_relation']) && $v['Attribute']['object_relation'] === null) {\n\t\t\t\t$results[$k]['Attribute']['object_relation'] = '';\n\t\t\t}\n\t\t}\n\t\treturn $results;\n\t}\n\n\tpublic function beforeSave($options = array()) {\n\t\t// explode value of composite type in value1 and value2\n\t\t// or copy value to value1 if not composite type\n\t\tif (!empty($this->data['Attribute']['type'])) {\n\t\t\t$compositeTypes = $this->getCompositeTypes();\n\t\t\t// explode composite types in value1 and value2\n\t\t\tif (in_array($this->data['Attribute']['type'], $compositeTypes)) {\n\t\t\t\t$pieces = explode('|', $this->data['Attribute']['value']);\n\t\t\t\tif (2 != count($pieces)) {\n\t\t\t\t\tthrow new InternalErrorException('Composite type, but value not explodable');\n\t\t\t\t}\n\t\t\t\t$this->data['Attribute']['value1'] = $pieces[0];\n\t\t\t\t$this->data['Attribute']['value2'] = $pieces[1];\n\t\t\t} else {\n\t\t\t\t$this->data['Attribute']['value1'] = $this->data['Attribute']['value'];\n\t\t\t\t$this->data['Attribute']['value2'] = '';\n\t\t\t}\n\t\t}\n\n\t\t// update correlation... (only needed here if there's an update)\n\t\tif ($this->id || !empty($this->data['Attribute']['id'])) {\n\t\t\t$this->__beforeSaveCorrelation($this->data['Attribute']);\n\t\t}\n\t\t// always return true after a beforeSave()\n\t\treturn true;\n\t}\n\n\tprivate function __alterAttributeCount($event_id, $increment = true) {\n\t\t$event = $this->Event->find('first', array(\n\t\t\t'recursive' => -1,\n\t\t\t'conditions' => array('Event.id' => $event_id)\n\t\t));\n\t\tif (!empty($event)) {\n\t\t\tif ($increment) $event['Event']['attribute_count'] = $event['Event']['attribute_count'] + 1;\n\t\t\telse $event['Event']['attribute_count'] = $event['Event']['attribute_count'] - 1;\n\t\t\tif ($event['Event']['attribute_count'] >= 0) {\n\t\t\t\t$this->Event->save($event, array('callbacks' => false));\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic function afterSave($created, $options = array()) {\n\t\tparent::afterSave($created, $options);\n\t\t// update correlation...\n\t\tif (isset($this->data['Attribute']['deleted']) && $this->data['Attribute']['deleted']) {\n\t\t\t$this->__beforeSaveCorrelation($this->data['Attribute']);\n\t\t\tif (isset($this->data['Attribute']['event_id'])) $this->__alterAttributeCount($this->data['Attribute']['event_id'], false);\n\t\t} else {\n\t\t\t$this->__afterSaveCorrelation($this->data['Attribute']);\n\t\t}\n\t\tif (Configure::read('Plugin.ZeroMQ_enable') && Configure::read('Plugin.ZeroMQ_attribute_notifications_enable')) {\n\t\t\t$pubSubTool = $this->getPubSubTool();\n\t\t\t$attribute = $this->fetchAttribute($this->id);\n\t\t\tif (!empty($attribute)) {\n\t\t\t\t$user = array(\n\t\t\t\t\t'org_id' => -1,\n\t\t\t\t\t'Role' => array(\n\t\t\t\t\t\t'perm_site_admin' => 1\n\t\t\t\t\t)\n\t\t\t\t);\n\t\t\t\t$attribute['Attribute']['Sighting'] = $this->Sighting->attachToEvent($attribute, $user, $this->id);\n\t\t\t\tif (empty($attribute['Object']['id'])) unset($attribute['Object']);\n\t\t\t\t$action = $created ? 'add' : 'edit';\n\t\t\t\tif (!empty($this->data['Attribute']['deleted'])) $action = 'soft-delete';\n\t\t\t\t$pubSubTool->attribute_save($attribute, $action);\n\t\t\t}\n\t\t}\n\t\tif (Configure::read('MISP.enable_advanced_correlations') && in_array($this->data['Attribute']['type'], array('ip-src', 'ip-dst', 'domain-ip')) && strpos($this->data['Attribute']['value'], '/')) {\n\t\t\t$this->setCIDRList();\n\t\t}\n\t\t$result = true;\n\t\t// if the 'data' field is set on the $this->data then save the data to the correct file\n\t\tif (isset($this->data['Attribute']['type']) && $this->typeIsAttachment($this->data['Attribute']['type']) && !empty($this->data['Attribute']['data'])) {\n\t\t\t$result = $result && $this->saveBase64EncodedAttachment($this->data['Attribute']); // TODO : is this correct?\n\t\t}\n\t\tif ($created && isset($this->data['Attribute']['event_id']) && empty($this->data['Attribute']['skip_auto_increment'])) {\n\t\t\t$this->__alterAttributeCount($this->data['Attribute']['event_id']);\n\t\t}\n\t\treturn $result;\n\t}\n\n\tpublic function beforeDelete($cascade = true) {\n\t\t// delete attachments from the disk\n\t\t$this->read(); // first read the attribute from the db\n\t\tif ($this->typeIsAttachment($this->data['Attribute']['type'])) {\n\t\t\t// only delete the file if it exists\n\t\t\t$attachments_dir = Configure::read('MISP.attachments_dir');\n\t\t\tif (empty($attachments_dir)) {\n\t\t\t\t$my_server = ClassRegistry::init('Server');\n\t\t\t\t$attachments_dir = $my_server->getDefaultAttachments_dir();\n\t\t\t}\n\t\t\t$filepath = $attachments_dir . DS . $this->data['Attribute']['event_id'] . DS . $this->data['Attribute']['id'];\n\t\t\t$file = new File($filepath);\n\t\t\tif ($file->exists()) {\n\t\t\t\tif (!$file->delete()) {\n\t\t\t\t\tthrow new InternalErrorException('Delete of file attachment failed. Please report to administrator.');\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t// update correlation..\n\t\t$this->__beforeDeleteCorrelation($this->data['Attribute']['id']);\n\t\tif (!empty($this->data['Attribute']['id'])) {\n\t\t\tif (Configure::read('Plugin.ZeroMQ_enable') && Configure::read('Plugin.ZeroMQ_attribute_notifications_enable')) {\n\t\t\t\t$pubSubTool = $this->getPubSubTool();\n\t\t\t\t$pubSubTool->attribute_save($this->data, 'delete');\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic function afterDelete() {\n\t\tif (Configure::read('MISP.enable_advanced_correlations') && in_array($this->data['Attribute']['type'], array('ip-src', 'ip-dst', 'domain-ip')) && strpos($this->data['Attribute']['value'], '/')) {\n\t\t\t$this->setCIDRList();\n\t\t}\n\t\tif (isset($this->data['Attribute']['event_id'])) {\n\t\t\tif (empty($this->data['Attribute']['deleted'])) $this->__alterAttributeCount($this->data['Attribute']['event_id'], false);\n\t\t}\n\t\tif (!empty($this->data['Attribute']['id'])) {\n\t\t\t$this->Object->ObjectReference->deleteAll(\n\t\t\t\tarray(\n\t\t\t\t\t'ObjectReference.referenced_type' => 0,\n\t\t\t\t\t'ObjectReference.referenced_id' => $this->data['Attribute']['id'],\n\t\t\t\t),\n\t\t\t\tfalse\n\t\t\t);\n\t\t}\n\t}\n\n\tpublic function beforeValidate($options = array()) {\n\t\tparent::beforeValidate();\n\n\t\tif (!isset($this->data['Attribute']['type'])) {\n\t\t\treturn false;\n\t\t}\n\t\tif (is_array($this->data['Attribute']['value'])) {\n\t\t\treturn false;\n\t\t}\n\t\t// remove leading and trailing blanks\n\t\t$this->data['Attribute']['value'] = trim($this->data['Attribute']['value']);\n\n\t\t// make some last changes to the inserted value\n\t\t$this->data['Attribute']['value'] = $this->modifyBeforeValidation($this->data['Attribute']['type'], $this->data['Attribute']['value']);\n\n\t\t// set to_ids if it doesn't exist\n\t\tif (empty($this->data['Attribute']['to_ids'])) {\n\t\t\t$this->data['Attribute']['to_ids'] = 0;\n\t\t}\n\n\t\tif (empty($this->data['Attribute']['comment'])) {\n\t\t\t$this->data['Attribute']['comment'] = \"\";\n\t\t}\n\t\t// generate UUID if it doesn't exist\n\t\tif (empty($this->data['Attribute']['uuid'])) {\n\t\t\t$this->data['Attribute']['uuid'] = CakeText::uuid();\n\t\t}\n\t\t// generate timestamp if it doesn't exist\n\t\tif (empty($this->data['Attribute']['timestamp'])) {\n\t\t\t$date = new DateTime();\n\t\t\t$this->data['Attribute']['timestamp'] = $date->getTimestamp();\n\t\t}\n\t\t// TODO: add explanatory comment\n\t\t$result = $this->runRegexp($this->data['Attribute']['type'], $this->data['Attribute']['value']);\n\t\tif ($result === false) {\n\t\t\t$this->invalidate('value', 'This value is blocked by a regular expression in the import filters.');\n\t\t} else {\n\t\t\t$this->data['Attribute']['value'] = $result;\n\t\t}\n\n\t\t// Set defaults for when some of the mandatory fields don't have defaults\n\t\t// These fields all have sane defaults either based on another field, or due to server settings\n\t\tif (!isset($this->data['Attribute']['distribution'])) {\n\t\t\t$this->data['Attribute']['distribution'] = Configure::read('MISP.default_attribute_distribution');\n\t\t\tif ($this->data['Attribute']['distribution'] == 'event') {\n\t\t\t\t$this->data['Attribute']['distribution'] = 5;\n\t\t\t}\n\t\t}\n\n\t\tif (!empty($this->data['Attribute']['type']) && empty($this->data['Attribute']['category'])) {\n\t\t\t$this->data['Attribute']['category'] = $this->typeDefinitions[$this->data['Attribute']['type']]['default_category'];\n\t\t}\n\n\t\tif (!isset($this->data['Attribute']['to_ids'])) {\n\t\t\t$this->data['Attribute']['to_ids'] = $this->typeDefinitions[$this->data['Attribute']['type']]['to_ids'];\n\t\t}\n\n\t\tif ($this->data['Attribute']['distribution'] != 4) $this->data['Attribute']['sharing_group_id'] = 0;\n\t\t// return true, otherwise the object cannot be saved\n\n\t\tif ($this->data['Attribute']['type'] == 'float' && $this->data['Attribute']['value'] == 0) $this->data['Attribute']['value'] = '0.0';\n\t\treturn true;\n\t}\n\n\tpublic function validComposite($fields) {\n\t\t$compositeTypes = $this->getCompositeTypes();\n\t\tif (in_array($this->data['Attribute']['type'], $compositeTypes)) {\n\t\t\t$pieces = explode('|', $fields['value']);\n\t\t\tif (2 != count($pieces)) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n\n\tpublic function validCategory($fields) {\n\t\t$validCategories = array_keys($this->categoryDefinitions);\n\t\tif (in_array($fields['category'], $validCategories)) return true;\n\t\treturn false;\n\t}\n\n\t\tpublic function valueIsUnique ($fields) {\n\t\tif (isset($this->data['Attribute']['deleted']) && $this->data['Attribute']['deleted']) return true;\n\t\t// We escape this rule for objects as we can have the same category/type/value combination in different objects\n\t\tif (!empty($this->data['Attribute']['object_relation'])) {\n\t\t\treturn true;\n\t\t}\n\t\t$value = $fields['value'];\n\t\tif (strpos($value, '|')) {\n\t\t\t$value = explode('|', $value);\n\t\t\t$value = array(\n\t\t\t\t'Attribute.value1' => $value[0],\n\t\t\t\t'Attribute.value2' => $value[1]\n\t\t\t);\n\t\t} else {\n\t\t\t$value = array(\n\t\t\t\t'Attribute.value1' => $value,\n\t\t\t);\n\t\t}\n\t\t$eventId = $this->data['Attribute']['event_id'];\n\t\t$type = $this->data['Attribute']['type'];\n\t\t$category = $this->data['Attribute']['category'];\n\n\t\t// check if the attribute already exists in the same event\n\t\t$conditions = array(\n\t\t\t'Attribute.event_id' => $eventId,\n\t\t\t'Attribute.type' => $type,\n\t\t\t'Attribute.category' => $category,\n\t\t\t'Attribute.deleted' => 0\n\t\t);\n\t\t$conditions = array_merge ($conditions, $value);\n\t\tif (isset($this->data['Attribute']['id'])) {\n\t\t\t$conditions['Attribute.id !='] = $this->data['Attribute']['id'];\n\t\t}\n\n\t\t$params = array(\n\t\t\t'recursive' => -1,\n\t\t\t'fields' => array('id'),\n\t\t\t'conditions' => $conditions,\n\t\t);\n\t\tif (!empty($this->find('first', $params))) {\n\t\t\t// value isn't unique\n\t\t\treturn false;\n\t\t}\n\t\t// value is unique\n\t\treturn true;\n\t}\n\n\tpublic function validateTypeValue($fields) {\n\t\t$category = $this->data['Attribute']['category'];\n\t\tif (isset($this->categoryDefinitions[$category]['types'])) {\n\t\t\treturn in_array($fields['type'], $this->categoryDefinitions[$category]['types']);\n\t\t}\n\t\treturn false;\n\t}\n\n\tpublic function validateAttributeValue($fields) {\n\t\t$value = $fields['value'];\n\t\treturn $this->runValidation($value, $this->data['Attribute']['type']);\n\t}\n\n\tprivate $__hexHashLengths = array(\n\t\t\t'authentihash' => 64,\n\t\t\t'md5' => 32,\n\t\t\t'imphash' => 32,\n\t\t\t'sha1' => 40,\n            'x509-fingerprint-md5' => 32,\n\t\t\t'x509-fingerprint-sha1' => 40,\n            'x509-fingerprint-sha256' => 64,\n\t\t\t'pehash' => 40,\n\t\t\t'sha224' => 56,\n\t\t\t'sha256' => 64,\n\t\t\t'sha384' => 96,\n\t\t\t'sha512' => 128,\n\t\t\t'sha512/224' => 56,\n\t\t\t'sha512/256' => 64,\n\t);\n\n\tpublic function runValidation($value, $type) {\n\t\t$returnValue = false;\n\t\t// check data validation\n\t\tswitch ($type) {\n\t\t\tcase 'md5':\n\t\t\tcase 'imphash':\n\t\t\tcase 'sha1':\n\t\t\tcase 'sha224':\n\t\t\tcase 'sha256':\n\t\t\tcase 'sha384':\n\t\t\tcase 'sha512':\n\t\t\tcase 'sha512/224':\n\t\t\tcase 'sha512/256':\n\t\t\tcase 'authentihash':\n            case 'x509-fingerprint-md5':\n            case 'x509-fingerprint-sha256':\n\t\t\tcase 'x509-fingerprint-sha1':\n\t\t\t\t$length = $this->__hexHashLengths[$type];\n\t\t\t\tif (preg_match(\"#^[0-9a-f]{\" . $length . \"}$#\", $value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t} else {\n\t\t\t\t\t$returnValue = 'Checksum has an invalid length or format (expected: ' . $length . ' hexadecimal characters). Please double check the value or select type \"other\".';\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'tlsh':\n\t\t\t\tif (preg_match(\"#^[0-9a-f]{35,}$#\", $value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t} else {\n\t\t\t\t\t$returnValue = 'Checksum has an invalid length or format (expected: at least 35 hexadecimal characters). Please double check the value or select type \"other\".';\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'pehash':\n\t\t\t\tif (preg_match(\"#^[0-9a-f]{40}$#\", $value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t} else {\n\t\t\t\t\t$returnValue = 'The input doesn\\'t match the expected sha1 format (expected: 40 hexadecimal characters). Keep in mind that MISP currently only supports SHA1 for PEhashes, if you would like to get the support extended to other hash types, make sure to create a github ticket about it at https://github.com/MISP/MISP!';\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'ssdeep':\n\t\t\t\tif (substr_count($value, ':') == 2) {\n\t\t\t\t\t$parts = explode(':', $value);\n\t\t\t\t\tif (is_numeric($parts[0])) $returnValue = true;\n\t\t\t\t}\n\t\t\t\tif (!$returnValue) $returnValue = 'Invalid SSDeep hash. The format has to be blocksize:hash:hash';\n\t\t\t\tbreak;\n\t\t\tcase 'http-method':\n\t\t\t\tif (preg_match(\"#(OPTIONS|GET|HEAD|POST|PUT|DELETE|TRACE|CONNECT|PROPFIND|PROPPATCH|MKCOL|COPY|MOVE|LOCK|UNLOCK|VERSION-CONTROL|REPORT|CHECKOUT|CHECKIN|UNCHECKOUT|MKWORKSPACE|UPDATE|LABEL|MERGE|BASELINE-CONTROL|MKACTIVITY|ORDERPATCH|ACL|PATCH|SEARCH)#\", $value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t} else {\n\t\t\t\t\t$returnValue = 'Unknown HTTP method.';\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'filename|pehash':\n\t\t\t\t// no newline\n\t\t\t\tif (preg_match(\"#^.+\\|[0-9a-f]{40}$#\", $value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t} else {\n\t\t\t\t\t$returnValue = 'The input doesn\\'t match the expected filename|sha1 format (expected: filename|40 hexadecimal characters). Keep in mind that MISP currently only supports SHA1 for PEhashes, if you would like to get the support extended to other hash types, make sure to create a github ticket about it at https://github.com/MISP/MISP!';\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'filename|md5':\n\t\t\tcase 'filename|sha1':\n\t\t\tcase 'filename|imphash':\n\t\t\tcase 'filename|sha224':\n\t\t\tcase 'filename|sha256':\n\t\t\tcase 'filename|sha384':\n\t\t\tcase 'filename|sha512':\n\t\t\tcase 'filename|sha512/224':\n\t\t\tcase 'filename|sha512/256':\n\t\t\tcase 'filename|authentihash':\n\t\t\t\t$parts = explode('|', $type);\n\t\t\t\t$length = $this->__hexHashLengths[$parts[1]];\n\t\t\t\tif (preg_match(\"#^.+\\|[0-9a-f]{\" . $length . \"}$#\", $value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t} else {\n\t\t\t\t\t$returnValue = 'Checksum has an invalid length or format (expected: filename|' . $length . ' hexadecimal characters). Please double check the value or select type \"other\".';\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'filename|ssdeep':\n\t\t\t\tif (substr_count($value, '|') != 1 || !preg_match(\"#^.+\\|.+$#\", $value)) {\n\t\t\t\t\t$returnValue = 'Invalid composite type. The format has to be ' . $type . '.';\n\t\t\t\t} else {\n\t\t\t\t\t$composite = explode('|', $value);\n\t\t\t\t\t$value = $composite[1];\n\t\t\t\t\tif (substr_count($value, ':') == 2) {\n\t\t\t\t\t\t$parts = explode(':', $value);\n\t\t\t\t\t\tif (is_numeric($parts[0])) $returnValue = true;\n\t\t\t\t\t}\n\t\t\t\t\tif (!$returnValue) $returnValue = 'Invalid SSDeep hash (expected: blocksize:hash:hash).';\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'filename|tlsh':\n\t\t\t\tif (preg_match(\"#^.+\\|[0-9a-f]{35,}$#\", $value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t} else {\n\t\t\t\t\t$returnValue = 'Checksum has an invalid length or format (expected: filename|at least 35 hexadecimal characters). Please double check the value or select type \"other\".';\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'ip-src':\n\t\t\tcase 'ip-dst':\n\t\t\t\t$returnValue = true;\n\t\t\t\tif (strpos($value, '/') !== false) {\n\t\t\t\t\t$parts = explode(\"/\", $value);\n\t\t\t\t\t// [0] = the IP\n\t\t\t\t\t// [1] = the network address\n\t\t\t\t\tif (count($parts) != 2 || (!is_numeric($parts[1]) || !($parts[1] < 129 && $parts[1] > 0))) {\n\t\t\t\t\t\t\t$returnValue = 'Invalid CIDR notation value found.';\n\t\t\t\t\t}\n\t\t\t\t\t$ip = $parts[0];\n\t\t\t\t} else {\n\t\t\t\t\t$ip = $value;\n\t\t\t\t}\n\t\t\t\tif (!filter_var($ip, FILTER_VALIDATE_IP)) {\n\t\t\t\t\t$returnValue = 'IP address has an invalid format.';\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'port':\n\t\t\t\tif (!is_numeric($value) || $value < 1 || $value > 65535) {\n\t\t\t\t\t$returnValue = 'Port numbers have to be positive integers between 1 and 65535.';\n\t\t\t\t} else {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'ip-dst|port':\n\t\t\tcase 'ip-src|port':\n\t\t\t\t$parts = explode('|', $value);\n\t\t\t\tif (filter_var($parts[0], FILTER_VALIDATE_IP)) {\n\t\t\t\t\tif (!is_numeric($parts[1]) || $parts[1] > 1 || $parts[1] < 65536) {\n\t\t\t\t\t\t$returnValue = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'mac-address':\n\t\t\t\tif (preg_match('/^([a-fA-F0-9]{2}[:|\\-| |\\.]?){6}$/', $value) == 1) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'mac-eui-64':\n\t\t\t\tif (preg_match('/^([a-fA-F0-9]{2}[:|\\-| |\\.]?){8}$/', $value) == 1) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'hostname':\n\t\t\tcase 'domain':\n\t\t\t\tif (preg_match(\"#^[A-Z0-9.\\-_]+\\.[A-Z0-9\\-]{2,}$#i\", $value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t} else {\n\t\t\t\t\t$returnValue = 'Domain name has an invalid format. Please double check the value or select type \"other\".';\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'hostname|port':\n\t\t\t\t$parts = explode('|', $value);\n\t\t\t\tif (preg_match(\"#^[A-Z0-9.\\-_]+\\.[A-Z0-9\\-]{2,}$#i\", $parts[0])) {\n\t\t\t\t\tif (!is_numeric($parts[1]) || $parts[1] > 1 || $parts[1] < 65536) {\n\t\t\t\t\t\t$returnValue = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'domain|ip':\n\t\t\t\tif (preg_match(\"#^[A-Z0-9.\\-_]+\\.[A-Z0-9\\-]{2,}\\|.*$#i\", $value)) {\n\t\t\t\t\t$parts = explode('|', $value);\n\t\t\t\t\tif (filter_var($parts[1], FILTER_VALIDATE_IP)) {\n\t\t\t\t\t\t$returnValue = true;\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$returnValue = 'IP address has an invalid format.';\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t$returnValue = 'Domain name has an invalid format.';\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'email-src':\n\t\t\tcase 'email-dst':\n\t\t\tcase 'target-email':\n\t\t\tcase 'whois-registrant-email':\n\t\t\tcase 'dns-soa-email':\n\t\t\tcase 'jabber-id':\n\t\t\t\t// we don't use the native function to prevent issues with partial email addresses\n\t\t\t\tif (preg_match(\"#^.*\\@.*\\..*$#i\", $value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t} else {\n\t\t\t\t\t$returnValue = 'Email address has an invalid format. Please double check the value or select type \"other\".';\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'vulnerability':\n\t\t\t\t$value = str_replace('\u2013', '-', $value);\n\t\t\t\tif (preg_match(\"#^(CVE-)[0-9]{4}(-)[0-9]{4,6}$#\", $value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t} else {\n\t\t\t\t\t$returnValue = 'Invalid format. Expected: CVE-xxxx-xxxx.';\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'named pipe':\n\t\t\t\tif (!preg_match(\"#\\n#\", $value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'windows-service-name':\n\t\t\tcase 'windows-service-displayname':\n\t\t\t\tif (strlen($value) > 256 || preg_match('#[\\\\\\/]#', $value)) {\n\t\t\t\t\t$returnValue = 'Invalid format. Only values shorter than 256 characters that don\\'t include any forward or backward slashes are allowed.';\n\t\t\t\t} else {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'mutex':\n\t\t\tcase 'AS':\n\t\t\tcase 'snort':\n\t\t\tcase 'pattern-in-file':\n\t\t\tcase 'pattern-in-traffic':\n\t\t\tcase 'pattern-in-memory':\n            case 'yara':\n            case 'stix2-pattern':\n            case 'sigma':\n            case 'gene':\n            case 'mime-type':\n            case 'identity-card-number':\n\t\t\tcase 'cookie':\n\t\t\tcase 'attachment':\n\t\t\tcase 'malware-sample':\n\t\t\t\t$returnValue = true;\n\t\t\t\tbreak;\n\t\t\tcase 'link':\n\t\t\t\t// Moved to a native function whilst still enforcing the scheme as a requirement\n\t\t\t\tif (filter_var($value, FILTER_VALIDATE_URL, FILTER_FLAG_SCHEME_REQUIRED) && !preg_match(\"#\\n#\", $value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'comment':\n\t\t\tcase 'text':\n\t\t\tcase 'other':\n\t\t\tcase 'email-attachment':\n\t\t\tcase 'email-body':\n\t\t\t\t$returnValue = true;\n\t\t\t\tbreak;\n\t\t\tcase 'hex':\n\t\t\t\tif (preg_match(\"/^[0-9a-f]*$/i\", $value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'target-user':\n\t\t\tcase 'campaign-name':\n\t\t\tcase 'campaign-id':\n\t\t\tcase 'threat-actor':\n\t\t\tcase 'target-machine':\n\t\t\tcase 'target-org':\n\t\t\tcase 'target-location':\n\t\t\tcase 'target-external':\n\t\t\tcase 'email-subject':\n\t\t\tcase 'malware-type':\n\t\t\t// TODO: review url/uri validation\n\t\t\tcase 'url':\n\t\t\tcase 'uri':\n\t\t\tcase 'user-agent':\n\t\t\tcase 'regkey':\n\t\t\tcase 'regkey|value':\n\t\t\tcase 'filename':\n\t\t\tcase 'pdb':\n\t\t\tcase 'windows-scheduled-task':\n      case 'whois-registrant-name':\n      case 'whois-registrant-org':\n\t\t\tcase 'whois-registrar':\n\t\t\tcase 'whois-creation-date':\n\t\t\tcase 'first-name':\n\t\t\tcase 'middle-name':\n\t\t\tcase 'last-name':\n\t\t\tcase 'date-of-birth':\n\t\t\tcase 'place-of-birth':\n\t\t\tcase 'gender':\n\t\t\tcase 'passport-number':\n\t\t\tcase 'passport-country':\n\t\t\tcase 'passport-expiration':\n\t\t\tcase 'redress-number':\n\t\t\tcase 'nationality':\n\t\t\tcase 'visa-number':\n\t\t\tcase 'issue-date-of-the-visa':\n\t\t\tcase 'primary-residence':\n\t\t\tcase 'country-of-residence':\n\t\t\tcase 'special-service-request':\n\t\t\tcase 'frequent-flyer-number':\n\t\t\tcase 'travel-details':\n\t\t\tcase 'payment-details':\n\t\t\tcase 'place-port-of-original-embarkation':\n\t\t\tcase 'place-port-of-clearance':\n\t\t\tcase 'place-port-of-onward-foreign-destination':\n\t\t\tcase 'passenger-name-record-locator-number':\n\t\t\tcase 'email-dst-display-name':\n\t\t\tcase 'email-src-display-name':\n\t\t\tcase 'email-reply-to':\n\t\t\tcase 'email-x-mailer':\n\t\t\tcase 'email-mime-boundary':\n\t\t\tcase 'email-thread-index':\n\t\t\tcase 'email-message-id':\n\t\t\tcase 'github-username':\n\t\t\tcase 'github-repository':\n\t\t\tcase 'github-organisation':\n\t\t\tcase 'cpe':\n\t\t\tcase 'twitter-id':\n\t\t\tcase 'mobile-application-id':\n\t\t\t\t// no newline\n\t\t\t\tif (!preg_match(\"#\\n#\", $value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'email-header':\n\t\t\t\t$returnValue = true;\n\t\t\t\tbreak;\n\t\t\tcase 'datetime':\n\t\t\t\ttry {\n\t\t\t\t\tnew DateTime($value);\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t} catch (Exception $e) {\n\t\t\t\t\t$returnValue = 'Datetime has to be in the ISO 8601 format.';\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'size-in-bytes':\n\t\t\tcase 'counter':\n\t\t\t\tif (!is_numeric($value) || $value < 0) {\n\t\t\t\t\t$returnValue = 'The value has to be a number greater or equal 0.';\n\t\t\t\t} else {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'targeted-threat-index':\n\t\t\t\tif (!is_numeric($value) || $value < 0 || $value > 10) {\n\t\t\t\t\t$returnValue = 'The value has to be a number between 0 and 10.';\n\t\t\t\t} else {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'iban':\n\t\t\tcase 'bic':\n\t\t\tcase 'btc':\n\t\t\t\tif (preg_match('/^[a-zA-Z0-9]+$/', $value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'bin':\n\t\t\tcase 'cc-number':\n\t\t\tcase 'bank-account-nr':\n\t\t\tcase 'aba-rtn':\n\t\t\tcase 'prtn':\n\t\t\tcase 'phone-number':\n\t\t\tcase 'whois-registrant-phone':\n\t\t\t\tif (is_numeric($value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'cortex':\n\t\t\t\tjson_decode($value);\n\t\t\t\t$returnValue = (json_last_error() == JSON_ERROR_NONE);\n\t\t\t\tbreak;\n\t\t\tcase 'float':\n\t\t\t\t$value = floatval($value);\n\t\t\t\tif (is_float($value)) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'boolean':\n\t\t\t\tif ($value == 1 || $value == 0) {\n\t\t\t\t\t$returnValue = true;\n\t\t\t\t}\n\t\t}\n\t\treturn $returnValue;\n\t}\n\n\t// do some last second modifications before the validation\n\tpublic function modifyBeforeValidation($type, $value) {\n\t\tswitch ($type) {\n\t\t\tcase 'md5':\n\t\t\tcase 'sha1':\n\t\t\tcase 'sha224':\n\t\t\tcase 'sha256':\n\t\t\tcase 'sha384':\n\t\t\tcase 'sha512':\n\t\t\tcase 'sha512/224':\n\t\t\tcase 'sha512/256':\n\t\t\tcase 'domain':\n\t\t\tcase 'hostname':\n\t\t\tcase 'pehash':\n\t\t\tcase 'authentihash':\n\t\t\tcase 'imphash':\n\t\t\tcase 'tlsh':\n\t\t\tcase 'email-src':\n\t\t\tcase 'email-dst':\n\t\t\tcase 'target-email':\n\t\t\tcase 'whois-registrant-email':\n\t\t\t\t$value = strtolower($value);\n\t\t\t\tbreak;\n\t\t\tcase 'domain|ip':\n\t\t\t\t$parts = explode('|', $value);\n\t\t\t\tif (filter_var($parts[1], FILTER_VALIDATE_IP, FILTER_FLAG_IPV6)) {\n\t\t\t\t\t// convert IPv6 address to compressed format\n\t\t\t\t\t$parts[1] = inet_ntop(inet_pton($value));\n\t\t\t\t\t$value = implode('|', $parts);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'filename|md5':\n\t\t\tcase 'filename|sha1':\n\t\t\tcase 'filename|imphash':\n\t\t\tcase 'filename|sha224':\n\t\t\tcase 'filename|sha256':\n\t\t\tcase 'filename|sha384':\n\t\t\tcase 'filename|sha512':\n\t\t\tcase 'filename|sha512/224':\n\t\t\tcase 'filename|sha512/256':\n\t\t\tcase 'filename|authentihash':\n\t\t\tcase 'filename|pehash':\n\t\t\tcase 'filename|tlsh':\n\t\t\t\t$pieces = explode('|', $value);\n\t\t\t\t$value = $pieces[0] . '|' . strtolower($pieces[1]);\n\t\t\t\tbreak;\n\t\t\tcase 'http-method':\n\t\t\t\t$value = strtoupper($value);\n\t\t\t\tbreak;\n\t\t\tcase 'cc-number':\n\t\t\tcase 'bin':\n\t\t\t\t$value = preg_replace('/[^0-9]+/', '', $value);\n\t\t\t\tbreak;\n\t\t\tcase 'iban':\n\t\t\tcase 'bic':\n\t\t\t\t$value = strtoupper($value);\n\t\t\t\t$value = preg_replace('/[^0-9A-Z]+/', '', $value);\n\t\t\t\tbreak;\n\t\t\tcase 'prtn':\n\t\t\tcase 'whois-registrant-phone':\n\t\t\tcase 'phone-number':\n\t\t\t\tif (substr($value, 0, 2) == '00') $value = '+' . substr($value, 2);\n\t\t\t\t$value = preg_replace('/\\(0\\)/', '', $value);\n\t\t\t\t$value = preg_replace('/[^\\+0-9]+/', '', $value);\n\t\t\t\tbreak;\n\t\t\tcase 'url':\n\t\t\t\t$value = preg_replace('/^hxxp/i', 'http', $value);\n\t\t\t\t$value = preg_replace('/\\[\\.\\]/', '.' , $value);\n\t\t\t\tbreak;\n            case 'x509-fingerprint-md5':\n            case 'x509-fingerprint-sha256':\n\t\t\tcase 'x509-fingerprint-sha1':\n\t\t\t\t$value = str_replace(':', '', $value);\n\t\t\t\t$value = strtolower($value);\n\t\t\t\tbreak;\n\t\t\tcase 'ip-src':\n\t\t\tcase 'ip-dst':\n\t\t\t\tif (filter_var($value, FILTER_VALIDATE_IP, FILTER_FLAG_IPV6)) {\n\t\t\t\t\t// convert IPv6 address to compressed format\n\t\t\t\t\t$value = inet_ntop(inet_pton($value));\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'ip-dst|port':\n\t\t\tcase 'ip-src|port':\n\t\t\t\t\tif (strpos($value, ':')) {\n\t\t\t\t\t\t$parts = explode(':', $value);\n\t\t\t\t\t} else if (strpos($value, '|')) {\n\t\t\t\t\t\t$parts = explode('|', $value);\n\t\t\t\t\t} else {\n\t\t\t\t\t\treturn $value;\n\t\t\t\t\t}\n\t\t\t\t\tif (filter_var($parts[0], FILTER_VALIDATE_IP, FILTER_FLAG_IPV6)) {\n\t\t\t\t\t\t// convert IPv6 address to compressed format\n\t\t\t\t\t\t$parts[0] = inet_ntop(inet_pton($parts[0]));\n\t\t\t\t\t}\n\t\t\t\t\treturn $parts[0] . '|' . $parts[1];\n\t\t\t\tbreak;\n\t\t\tcase 'mac-address':\n\t\t\tcase 'mac-eui-64':\n\t\t\t\t$value = str_replace(array('.', ':', '-', ' '), '', $value);\n\t\t\t\t$value = wordwrap($value, 2, ':', true);\n\t\t\t\tbreak;\n\t\t\tcase 'hostname|port':\n\t\t\t\t$value = strtolower($value);\n\t\t\t\tstr_replace(':', '|', $value);\n\t\t\t\tbreak;\n\t\t\tcase 'float':\n\t\t\t\t$value = floatval($value);\n\t\t\t\tbreak;\n\t\t\tcase 'hex':\n\t\t\t\t$value = strtoupper($value);\n\t\t\t\tbreak;\n\t\t\tcase 'boolean':\n\t\t\t\tif ('true' == trim(strtolower($value))) $value = 1;\n\t\t\t\tif ('false' == trim(strtolower($value))) $value = 0;\n\t\t\t\t$value = ($value) ? '1' : '0';\n\t\t\t\tbreak;\n\t\t}\n\t\treturn $value;\n\t}\n\n\tpublic function getCompositeTypes() {\n\t\t// build the list of composite Attribute.type dynamically by checking if type contains a |\n\t\t// default composite types\n\t\t$compositeTypes = array('malware-sample');\t// TODO hardcoded composite\n\t\t// dynamically generated list\n\t\tforeach (array_keys($this->typeDefinitions) as $type) {\n\t\t\t$pieces = explode('|', $type);\n\t\t\tif (2 == count($pieces)) {\n\t\t\t\t$compositeTypes[] = $type;\n\t\t\t}\n\t\t}\n\t\treturn $compositeTypes;\n\t}\n\n\tpublic function isOwnedByOrg($attributeId, $org) {\n\t\t$this->id = $attributeId;\n\t\t$this->read();\n\t\treturn $this->data['Event']['org_id'] === $org;\n\t}\n\n\tpublic function getRelatedAttributes($attribute, $fields=array()) {\n\t\t// LATER getRelatedAttributes($attribute) this might become a performance bottleneck\n\n\t\t// exclude these specific categories from being linked\n\t\tswitch ($attribute['category']) {\n\t\t\tcase 'Antivirus detection':\n\t\t\t\treturn null;\n\t\t}\n\t\t// exclude these specific types from being linked\n\t\tswitch ($attribute['type']) {\n\t\t\tcase 'other':\n\t\t\tcase 'comment':\n\t\t\t\treturn null;\n\t\t}\n\n\t\t// prepare the conditions\n\t\t$conditions = array(\n\t\t\t\t'Attribute.event_id !=' => $attribute['event_id'],\n\t\t\t\t);\n\n\t\t// prevent issues with empty fields\n\t\tif (empty($attribute['value1'])) {\n\t\t\treturn null;\n\t\t}\n\n\t\tif (empty($attribute['value2'])) {\n\t\t\t// no value2, only search for value 1\n\t\t\t$conditions['OR'] = array(\n\t\t\t\t\t'Attribute.value1' => $attribute['value1'],\n\t\t\t\t\t'Attribute.value2' => $attribute['value1'],\n\t\t\t);\n\t\t} else {\n\t\t\t// value2 also set, so search for both\n\t\t\t$conditions['AND'] = array( // TODO was OR\n\t\t\t\t\t'Attribute.value1' => array($attribute['value1'],$attribute['value2']),\n\t\t\t\t\t'Attribute.value2' => array($attribute['value1'],$attribute['value2']),\n\t\t\t);\n\t\t}\n\n\t\t// do the search\n\t\tif (empty($fields)) {\n\t\t\t$fields = array('Attribute.*');\n\t\t}\n\t\t$similarEvents = $this->find('all',array('conditions' => $conditions,\n\t\t\t\t\t\t\t\t\t\t\t\t'fields' => $fields,\n\t\t\t\t\t\t\t\t\t\t\t\t'recursive' => 0,\n\t\t\t\t\t\t\t\t\t\t\t\t'group' => array('Attribute.event_id'),\n\t\t\t\t\t\t\t\t\t\t\t\t'order' => 'Attribute.event_id DESC', )\n\t\t);\n\t\treturn $similarEvents;\n\t}\n\n\tpublic function typeIsMalware($type) {\n\t\tif (in_array($type, $this->zippedDefinitions)) {\n\t\t\treturn true;\n\t\t} else {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tpublic function typeIsAttachment($type) {\n\t\tif ((in_array($type, $this->zippedDefinitions)) || (in_array($type, $this->uploadDefinitions))) {\n\t\t\treturn true;\n\t\t} else {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tpublic function base64EncodeAttachment($attribute) {\n\t\t$attachments_dir = Configure::read('MISP.attachments_dir');\n\t\tif (empty($attachments_dir)) {\n\t\t\t$my_server = ClassRegistry::init('Server');\n\t\t\t$attachments_dir = $my_server->getDefaultAttachments_dir();\n\t\t}\n\t\t$filepath = $attachments_dir . DS . $attribute['event_id'] . DS . $attribute['id'];\n\t\t$file = new File($filepath);\n\t\tif (!$file->readable()) {\n\t\t\treturn '';\n\t\t}\n\t\t$content = $file->read();\n\t\treturn base64_encode($content);\n\t}\n\n\tpublic function saveBase64EncodedAttachment($attribute) {\n\t\t$attachments_dir = Configure::read('MISP.attachments_dir');\n\t\tif (empty($attachments_dir)) {\n\t\t\t$my_server = ClassRegistry::init('Server');\n\t\t\t$attachments_dir = $my_server->getDefaultAttachments_dir();\n\t\t}\n\t\t$rootDir = $attachments_dir . DS . $attribute['event_id'];\n\t\t$dir = new Folder($rootDir, true);\t\t\t\t\t\t// create directory structure\n\t\t$destpath = $rootDir . DS . $attribute['id'];\n\t\t$file = new File($destpath, true);\t\t\t\t\t\t// create the file\n\t\t$decodedData = base64_decode($attribute['data']);\t\t// decode\n\t\tif ($file->write($decodedData)) {\t\t\t\t\t\t// save the data\n\t\t\treturn true;\n\t\t} else {\n\t\t\t// error\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tpublic function uploadAttachment($fileP, $realFileName, $malware, $eventId = null, $category = null, $extraPath = '', $fullFileName = '', $dist, $fromGFI = false) {\n\t\t// Check if there were problems with the file upload\n\t\t// only keep the last part of the filename, this should prevent directory attacks\n\t\t$filename = basename($fileP);\n\t\t$tmpfile = new File($fileP);\n\n\t\t// save the file-info in the database\n\t\t$this->create();\n\t\t$this->data['Attribute']['event_id'] = $eventId;\n\t\t$this->data['Attribute']['distribution'] = $dist;\n\t\tif ($malware) {\n\t\t\t$md5 = !$tmpfile->size() ? md5_file($fileP) : $tmpfile->md5();\n\t\t\t$this->data['Attribute']['category'] = $category ? $category : \"Payload delivery\";\n\t\t\t$this->data['Attribute']['type'] = \"malware-sample\";\n\t\t\t$this->data['Attribute']['value'] = $fullFileName ? $fullFileName . '|' . $md5 : $filename . '|' . $md5; // TODO gives problems with bigger files\n\t\t\t$this->data['Attribute']['to_ids'] = 1; // LATER let user choose whether to send this to an IDS\n\t\t\tif ($fromGFI) $this->data['Attribute']['comment'] = 'GFI import';\n\t\t} else {\n\t\t\t$this->data['Attribute']['category'] = $category ? $category : \"Artifacts dropped\";\n\t\t\t$this->data['Attribute']['type'] = \"attachment\";\n\t\t\t$this->data['Attribute']['value'] = $fullFileName ? $fullFileName : $realFileName;\n\t\t\t$this->data['Attribute']['to_ids'] = 0;\n\t\t\tif ($fromGFI) $this->data['Attribute']['comment'] = 'GFI import';\n\t\t}\n\n\t\tif (!$this->save($this->data)) {\n\t\t\t// TODO: error handling\n\t\t}\n\n\t\t// no errors in file upload, entry already in db, now move the file where needed and zip it if required.\n\t\t// no sanitization is required on the filename, path or type as we save\n\t\t// create directory structure\n\t\t$attachments_dir = Configure::read('MISP.attachments_dir');\n\t\tif (empty($attachments_dir)) {\n\t\t\t$my_server = ClassRegistry::init('Server');\n\t\t\t$attachments_dir = $my_server->getDefaultAttachments_dir();\n\t\t}\n\t\t$rootDir = $attachments_dir . DS . $eventId;\n\t\t$dir = new Folder($rootDir, true);\n\t\t// move the file to the correct location\n\t\t$destpath = $rootDir . DS . $this->getID(); // id of the new attribute in the database\n\t\t$file = new File($destpath);\n\t\t$zipfile = new File($destpath . '.zip');\n\t\t$fileInZip = new File($rootDir . DS . $extraPath . $filename);\n\n\t\t// zip and password protect the malware files\n\t\tif ($malware) {\n\t\t\t$execRetval = '';\n\t\t\t$execOutput = array();\n\t\t\texec('zip -j -P infected ' . escapeshellarg($zipfile->path) . ' ' . escapeshellarg($fileInZip->path), $execOutput, $execRetval);\n\t\t\tif ($execRetval != 0) { // not EXIT_SUCCESS\n\t\t\t\tthrow new Exception('An error has occured while attempting to zip the malware file.');\n\t\t\t}\n\t\t\t$fileInZip->delete(); // delete the original non-zipped-file\n\t\t\trename($zipfile->path, $file->path); // rename the .zip to .nothing\n\t\t} else {\n\t\t\t$fileAttach = new File($fileP);\n\t\t\trename($fileAttach->path, $file->path);\n\t\t}\n\t}\n\n\tpublic function __beforeSaveCorrelation($a) {\n\t\t// (update-only) clean up the relation of the old value: remove the existing relations related to that attribute, we DO have a reference, the id\n\t\t// ==> DELETE FROM correlations WHERE 1_attribute_id = $a_id OR attribute_id = $a_id; */\n\t\t// first check if it's an update\n\t\tif (isset($a['id'])) {\n\t\t\t$this->Correlation = ClassRegistry::init('Correlation');\n\t\t\t// FIXME : check that $a['id'] is checked correctly so that the user can't remove attributes he shouldn't\n\t\t\t$dummy = $this->Correlation->deleteAll(array('OR' => array(\n\t\t\t\t\t'Correlation.1_attribute_id' => $a['id'],\n\t\t\t\t\t'Correlation.attribute_id' => $a['id']))\n\t\t\t);\n\t\t}\n\t\tif ($a['type'] == 'ssdeep') {\n\t\t\t$this->FuzzyCorrelateSsdeep = ClassRegistry::init('FuzzyCorrelateSsdeep');\n\t\t\t$this->FuzzyCorrelateSsdeep->deleteAll(\n\t\t\t\tarray('FuzzyCorrelateSsdeep.attribute_id' => $a['id'])\n\t\t\t);\n\t\t}\n\t}\n\n\t// using Alnitak's solution from http://stackoverflow.com/questions/594112/matching-an-ip-to-a-cidr-mask-in-php5\n\tprivate function __ipv4InCidr($ip, $cidr) {\n\t\tlist ($subnet, $bits) = explode('/', $cidr);\n\t\t$ip = ip2long($ip);\n\t\t$subnet = ip2long($subnet);\n\t\t$mask = -1 << (32 - $bits);\n\t\t$subnet &= $mask; # nb: in case the supplied subnet wasn't correctly aligned\n\t\treturn ($ip & $mask) == $subnet;\n\t}\n\n\t// using Snifff's solution from http://stackoverflow.com/questions/7951061/matching-ipv6-address-to-a-cidr-subnet\n\tprivate function __ipv6InCidr($ip, $cidr) {\n\t\t$ip = $this->__expandIPv6Notation($ip);\n\t\t$binaryip = $this->__inet_to_bits($ip);\n\t\tlist($net,$maskbits) = explode('/', $cidr);\n\t\t$net = $this->__expandIPv6Notation($net);\n\t\tif (substr($net, -1) == ':') {\n\t\t\t$net .= '0';\n\t\t}\n\t\t$binarynet = $this->__inet_to_bits($net);\n\t\t$ip_net_bits = substr($binaryip, 0, $maskbits);\n\t\t$net_bits = substr($binarynet, 0, $maskbits);\n\t\treturn ($ip_net_bits === $net_bits);\n\t}\n\n\tprivate function __expandIPv6Notation($ip) {\n    if (strpos($ip, '::') !== false)\n        $ip = str_replace('::', str_repeat(':0', 8 - substr_count($ip, ':')).':', $ip);\n    if (strpos($ip, ':') === 0) $ip = '0'.$ip;\n    return $ip;\n\t}\n\n\tprivate function __inet_to_bits($inet) {\n\t\t$unpacked = unpack('A16', $inet);\n\t\t$unpacked = str_split($unpacked[1]);\n\t\t$binaryip = '';\n\t\tforeach ($unpacked as $char) {\n\t\t\t$binaryip .= str_pad(decbin(ord($char)), 8, '0', STR_PAD_LEFT);\n\t\t}\n\t\treturn $binaryip;\n\t}\n\n\tprivate function __cidrCorrelation($a) {\n\t\t$ipValues = array();\n\t\t$ip = $a['type'] == 'domain-ip' ? $a['value2'] : $a['value1'];\n\t\tif (strpos($ip, '/') !== false) {\n\t\t\t$ip_array = explode('/', $ip);\n\t\t\t$ip_version = filter_var($ip_array[0], FILTER_VALIDATE_IP, FILTER_FLAG_IPV4) ? 4 : 6;\n\t\t\t$ipList = $this->find('list', array(\n\t\t\t\t'conditions' => array(\n\t\t\t\t\t'type' => array('ip-src', 'ip-dst', 'domain_ip'),\n\t\t\t\t),\n\t\t\t\t'fields' => array('value1', 'value2'),\n\t\t\t\t'order' => false\n\t\t\t));\n\t\t\t$ipList = array_merge(array_keys($ipList), array_values($ipList));\n\t\t\tforeach ($ipList as $key => $value) {\n\t\t\t\tif ($value == '') {\n\t\t\t\t\tunset($ipList[$key]);\n\t\t\t\t}\n\t\t\t}\n\t\t\tforeach ($ipList as $ipToCheck) {\n\t\t\t\tif (filter_var($ipToCheck, FILTER_VALIDATE_IP, FILTER_FLAG_IPV4) && $ip_version == 4) {\n\t\t\t\t\tif ($ip_version == 4) {\n\t\t\t\t\t\tif ($this->__ipv4InCidr($ipToCheck, $ip)) {\n\t\t\t\t\t\t\t$ipValues[] = $ipToCheck;\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif ($this->__ipv6InCidr($ipToCheck, $ip)) {\n\t\t\t\t\t\t\t$ipValues[] = $ipToCheck;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\t$ip = $a['value1'];\n\t\t\t$ip_version = filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_IPV4) ? 4 : 6;\n\t\t\t$cidrList = $this->getSetCIDRList();\n\t\t\tforeach ($cidrList as $cidr) {\n\t\t\t\t$cidr_ip = explode('/', $cidr)[0];\n\t\t\t\tif (filter_var($cidr_ip, FILTER_VALIDATE_IP, FILTER_FLAG_IPV4)) {\n\t\t\t\t\tif ($ip_version == 4) {\n\t\t\t\t\t\tif ($this->__ipv4InCidr($ip, $cidr)) {\n\t\t\t\t\t\t\t$ipValues[] = $cidr;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tif ($ip_version == 6) {\n\t\t\t\t\t\tif ($this->__ipv6InCidr($ip, $cidr)) {\n\t\t\t\t\t\t\t$ipValues[] = $cidr;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t$extraConditions = array();\n\t\tif (!empty($ipValues)) {\n\t\t\t$extraConditions = array('OR' => array(\n\t\t\t\t'Attribute.value1' => $ipValues,\n\t\t\t\t'Attribute.value2' => $ipValues\n\t\t\t));\n\t\t}\n\t\treturn $extraConditions;\n\t}\n\n\tpublic function __afterSaveCorrelation($a, $full = false, $event = false) {\n\t\tif (!empty($a['disable_correlation'])) {\n\t\t\treturn true;\n\t\t}\n\t\t// Don't do any correlation if the type is a non correlating type\n\t\tif (!in_array($a['type'], $this->nonCorrelatingTypes)) {\n\t\t\tif (!$event) {\n\t\t\t\t$event = $this->Event->find('first', array(\n\t\t\t\t\t\t'recursive' => -1,\n\t\t\t\t\t\t'fields' => array('Event.distribution', 'Event.id', 'Event.info', 'Event.org_id', 'Event.date', 'Event.sharing_group_id', 'Event.disable_correlation'),\n\t\t\t\t\t\t'conditions' => array('id' => $a['event_id']),\n\t\t\t\t\t\t'order' => array(),\n\t\t\t\t));\n\t\t\t}\n\t\t\tif (!empty($event['Event']['disable_correlation']) && $event['Event']['disable_correlation']) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\tif (Configure::read('MISP.enable_advanced_correlations') && in_array($a['type'], array('ip-src', 'ip-dst', 'domain-ip'))) {\n\t\t\t\t$extraConditions = $this->__cidrCorrelation($a);\n\t\t\t}\n\t\t\tif ($a['type'] == 'ssdeep') {\n\t\t\t\tif (function_exists('ssdeep_fuzzy_compare')) {\n\t\t\t\t\t$this->FuzzyCorrelateSsdeep = ClassRegistry::init('FuzzyCorrelateSsdeep');\n\t\t\t\t\t$fuzzyIds = $this->FuzzyCorrelateSsdeep->query_ssdeep_chunks($a['value'], $a['id']);\n\t\t\t\t\tif (!empty($fuzzyIds)) {\n\t\t\t\t\t\t$ssdeepIds = $this->find('list', array(\n\t\t\t\t\t\t\t'recursive' => -1,\n\t\t\t\t\t\t\t'conditions' => array(\n\t\t\t\t\t\t\t\t'Attribute.type' => 'ssdeep',\n\t\t\t\t\t\t\t\t'Attribute.id' => $fuzzyIds\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t'fields' => array('Attribute.id', 'Attribute.value1')\n\t\t\t\t\t\t));\n\t\t\t\t\t\t$extraConditions = array('Attribute.id' => array());\n\t\t\t\t\t\t$threshold = !empty(Configure::read('MISP.ssdeep_correlation_threshold')) ? Configure::read('MISP.ssdeep_correlation_threshold') : 40;\n\t\t\t\t\t\tforeach ($ssdeepIds as $k => $v) {\n\t\t\t\t\t\t\t$ssdeep_value = ssdeep_fuzzy_compare($a['value'], $v);\n\t\t\t\t\t\t\tif ($ssdeep_value >= $threshold) {\n\t\t\t\t\t\t\t\t$extraConditions['Attribute.id'][] = $k;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\t$this->Correlation = ClassRegistry::init('Correlation');\n\t\t\t$correlatingValues = array($a['value1']);\n\t\t\tif (!empty($a['value2']) && !isset($this->primaryOnlyCorrelatingTypes[$a['type']])) $correlatingValues[] = $a['value2'];\n\t\t\tforeach ($correlatingValues as $k => $cV) {\n\t\t\t\t$conditions = array(\n\t\t\t\t\t'OR' => array(\n\t\t\t\t\t\t\t'Attribute.value1' => $cV,\n\t\t\t\t\t\t\t'AND' => array(\n\t\t\t\t\t\t\t\t\t'Attribute.value2' => $cV,\n\t\t\t\t\t\t\t\t\t'NOT' => array('Attribute.type' => $this->primaryOnlyCorrelatingTypes)\n\t\t\t\t\t\t\t)\n\t\t\t\t\t),\n\t\t\t\t\t'Attribute.disable_correlation' => 0,\n\t\t\t\t\t'Event.disable_correlation' => 0,\n\t\t\t\t\t'Attribute.deleted' => 0\n\t\t\t\t);\n\t\t\t\tif (!empty($extraConditions)) {\n\t\t\t\t\t$conditions['OR'][] = $extraConditions;\n\t\t\t\t}\n\t\t\t\t$correlatingAttributes[$k] = $this->find('all', array(\n\t\t\t\t\t\t'conditions' => $conditions,\n\t\t\t\t\t\t'recursive => -1',\n\t\t\t\t\t\t'fields' => array('Attribute.event_id', 'Attribute.id', 'Attribute.distribution', 'Attribute.sharing_group_id', 'Attribute.deleted', 'Attribute.type'),\n\t\t\t\t\t\t'contain' => array('Event' => array('fields' => array('Event.id', 'Event.date', 'Event.info', 'Event.org_id', 'Event.distribution', 'Event.sharing_group_id'))),\n\t\t\t\t\t\t'order' => array(),\n\t\t\t\t));\n\t\t\t\tforeach ($correlatingAttributes[$k] as $key => &$correlatingAttribute) {\n\t\t\t\t\tif ($correlatingAttribute['Attribute']['id'] == $a['id']) unset($correlatingAttributes[$k][$key]);\n\t\t\t\t\telse if ($correlatingAttribute['Attribute']['event_id'] == $a['event_id']) unset($correlatingAttributes[$k][$key]);\n\t\t\t\t\telse if ($full && $correlatingAttribute['Attribute']['id'] <= $a['id']) unset($correlatingAttributes[$k][$key]);\n\t\t\t\t\telse if (in_array($correlatingAttribute['Attribute']['type'], $this->nonCorrelatingTypes)) unset($correlatingAttributes[$k][$key]);\n\t\t\t\t\telse if (isset($this->primaryOnlyCorrelatingTypes[$a['type']]) && $correlatingAttribute['value1'] !== $a['value1']) unset($correlatingAttribute[$k][$key]);\n\t\t\t\t}\n\t\t\t}\n\t\t\t$correlations = array();\n\t\t\tforeach ($correlatingAttributes as $k => $cA) {\n\t\t\t\tforeach ($cA as $corr) {\n\t\t\t\t\t$correlations[] = array(\n\t\t\t\t\t\t\t$correlatingValues[$k],\n\t\t\t\t\t\t\t$event['Event']['id'],\n\t\t\t\t\t\t\t$a['id'],\n\t\t\t\t\t\t\t$corr['Attribute']['event_id'],\n\t\t\t\t\t\t\t$corr['Attribute']['id'],\n\t\t\t\t\t\t\t$corr['Event']['org_id'],\n\t\t\t\t\t\t\t$corr['Event']['distribution'],\n\t\t\t\t\t\t\t$corr['Attribute']['distribution'],\n\t\t\t\t\t\t\t$corr['Event']['sharing_group_id'],\n\t\t\t\t\t\t\t$corr['Attribute']['sharing_group_id'],\n\t\t\t\t\t\t\t$corr['Event']['date'],\n\t\t\t\t\t\t\t$corr['Event']['info']\n\t\t\t\t\t);\n\t\t\t\t\t$correlations[] = array(\n\t\t\t\t\t\t\t$correlatingValues[$k],\n\t\t\t\t\t\t\t$corr['Event']['id'],\n\t\t\t\t\t\t\t$corr['Attribute']['id'],\n\t\t\t\t\t\t\t$a['event_id'],\n\t\t\t\t\t\t\t$a['id'],\n\t\t\t\t\t\t\t$event['Event']['org_id'],\n\t\t\t\t\t\t\t$event['Event']['distribution'],\n\t\t\t\t\t\t\t$a['distribution'],\n\t\t\t\t\t\t\t$event['Event']['sharing_group_id'],\n\t\t\t\t\t\t\t$a['sharing_group_id'],\n\t\t\t\t\t\t\t$event['Event']['date'],\n\t\t\t\t\t\t\t$event['Event']['info']\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\t\t\t$fields = array(\n\t\t\t\t\t'value',\n\t\t\t\t\t'1_event_id',\n\t\t\t\t\t'1_attribute_id',\n\t\t\t\t\t'event_id',\n\t\t\t\t\t'attribute_id',\n\t\t\t\t\t'org_id',\n\t\t\t\t\t'distribution',\n\t\t\t\t\t'a_distribution',\n\t\t\t\t\t'sharing_group_id',\n\t\t\t\t\t'a_sharing_group_id',\n\t\t\t\t\t'date',\n\t\t\t\t\t'info'\n\t\t\t);\n\t\t\tif (!empty($correlations)) {\n\t\t\t\t$db = $this->getDataSource();\n\t\t\t\t$db->insertMulti('correlations', $fields, $correlations);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate function __beforeDeleteCorrelation($attribute_id) {\n\t\t$this->Correlation = ClassRegistry::init('Correlation');\n\t\t// When we remove an attribute we need to\n\t\t// - remove the existing relations related to that attribute, we DO have an id reference\n\t\t// ==> DELETE FROM correlations WHERE 1_attribute_id = $a_id OR attribute_id = $a_id;\n\t\t$dummy = $this->Correlation->deleteAll(array('OR' => array(\n\t\t\t\t\t\t'Correlation.1_attribute_id' => $attribute_id,\n\t\t\t\t\t\t'Correlation.attribute_id' => $attribute_id))\n\t\t);\n\t}\n\n\tpublic function checkComposites() {\n\t\t$compositeTypes = $this->getCompositeTypes();\n\t\t$fails = array();\n\t\t$attributes = $this->find('all', array('recursive' => 0));\n\n\t\tforeach ($attributes as $attribute) {\n\t\t\tif ((in_array($attribute['Attribute']['type'], $compositeTypes)) && (!strlen($attribute['Attribute']['value1']) || !strlen($attribute['Attribute']['value2']))) {\n\t\t\t\t$fails[] = $attribute['Attribute']['event_id'] . ':' . $attribute['Attribute']['id'];\n\t\t\t}\n\t\t}\n\t\treturn $fails;\n\t}\n\n\n\tpublic function hids($user, $type, $tags = '', $from = false, $to = false, $last = false, $jobId = false, $enforceWarninglist = false) {\n\t\tif (empty($user)) throw new MethodNotAllowedException('Could not read user.');\n\t\t// check if it's a valid type\n\t\tif ($type != 'md5' && $type != 'sha1' && $type != 'sha256') {\n\t\t\tthrow new UnauthorizedException('Invalid hash type.');\n\t\t}\n\t\t$conditions = array();\n\t\t$typeArray = array($type, 'filename|' . $type);\n\t\tif ($type == 'md5') $typeArray[] = 'malware-sample';\n\t\t$rules = array();\n\t\t$eventIds = $this->Event->fetchEventIds($user, $from, $to, $last);\n\t\tif (!empty($tags)) {\n\t\t\t$tag = ClassRegistry::init('Tag');\n\t\t\t$args = $this->dissectArgs($tags);\n\t\t\t$tagArray = $tag->fetchEventTagIds($args[0], $args[1]);\n\t\t\tif (!empty($tagArray[0])) {\n\t\t\t\tforeach ($eventIds as $k => $v) {\n\t\t\t\t\tif (!in_array($v['Event']['id'], $tagArray[0])) unset($eventIds[$k]);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!empty($tagArray[1])) {\n\t\t\t\tforeach ($eventIds as $k => $v) {\n\t\t\t\t\tif (in_array($v['Event']['id'], $tagArray[1])) unset($eventIds[$k]);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tApp::uses('HidsExport', 'Export');\n\t\t$continue = false;\n\t\t$eventCount = count($eventIds);\n\t\tif ($jobId) {\n\t\t\t$this->Job = ClassRegistry::init('Job');\n\t\t\t$this->Job->id = $jobId;\n\t\t\tif (!$this->Job->exists()) $jobId = false;\n\t\t}\n\t\tforeach ($eventIds as $k => $event) {\n\t\t\t$conditions['AND'] = array('Attribute.to_ids' => 1, 'Event.published' => 1, 'Attribute.type' => $typeArray, 'Attribute.event_id' => $event['Event']['id']);\n\t\t\t$options = array(\n\t\t\t\t\t'conditions' => $conditions,\n\t\t\t\t\t'group' => array('Attribute.type', 'Attribute.value1'),\n\t\t\t\t\t'enforceWarninglist' => $enforceWarninglist,\n\t\t\t\t\t'flatten' => true\n\t\t\t);\n\t\t\t$items = $this->fetchAttributes($user, $options);\n\t\t\tif (empty($items)) continue;\n\t\t\t$export = new HidsExport();\n\t\t\t$rules = array_merge($rules, $export->export($items, strtoupper($type), $continue));\n\t\t\t$continue = true;\n\t\t\tif ($jobId && ($k % 10 == 0)) {\n\t\t\t\t$this->Job->saveField('progress', $k * 80 / $eventCount);\n\t\t\t}\n\t\t}\n\t\treturn $rules;\n\t}\n\n\n\tpublic function nids($user, $format, $id = false, $continue = false, $tags = false, $from = false, $to = false, $last = false, $type = false, $enforceWarninglist = false, $includeAllTags = false) {\n\t\tif (empty($user)) throw new MethodNotAllowedException('Could not read user.');\n\t\t$eventIds = $this->Event->fetchEventIds($user, $from, $to, $last);\n\n\t\t// If we sent any tags along, load the associated tag names for each attribute\n\t\tif ($tags) {\n\t\t\t$tag = ClassRegistry::init('Tag');\n\t\t\t$args = $this->dissectArgs($tags);\n\t\t\t$tagArray = $tag->fetchEventTagIds($args[0], $args[1]);\n\t\t\tif (!empty($tagArray[0])) {\n\t\t\t\tforeach ($eventIds as $k => $v) {\n\t\t\t\t\tif (!in_array($v['Event']['id'], $tagArray[0])) unset($eventIds[$k]);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!empty($tagArray[1])) {\n\t\t\t\tforeach ($eventIds as $k => $v) {\n\t\t\t\t\tif (in_array($v['Event']['id'], $tagArray[1])) unset($eventIds[$k]);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif ($id) {\n\t\t\tforeach ($eventIds as $k => $v) {\n\t\t\t\tif ($v['Event']['id'] !== $id) unset($eventIds[$k]);\n\t\t\t}\n\t\t}\n\n\t\tif ($format == 'suricata') App::uses('NidsSuricataExport', 'Export');\n\t\telse App::uses('NidsSnortExport', 'Export');\n\n\t\t$rules = array();\n\t\tforeach ($eventIds as $event) {\n\t\t\t$conditions['AND'] = array('Attribute.to_ids' => 1, \"Event.published\" => 1, 'Attribute.event_id' => $event['Event']['id']);\n\t\t\t$valid_types = array('ip-dst', 'ip-src', 'ip-dst|port', 'ip-src|port', 'email-src', 'email-dst', 'email-subject', 'email-attachment', 'domain', 'domain|ip', 'hostname', 'url', 'user-agent', 'snort');\n\t\t\t$conditions['AND']['Attribute.type'] = $valid_types;\n\t\t\tif (!empty($type)) {\n\t\t\t\t$conditions['AND'][] = array('Attribute.type' => $type);\n\t\t\t}\n\n\t\t\t$params = array(\n\t\t\t\t\t'conditions' => $conditions, // array of conditions\n\t\t\t\t\t'recursive' => -1, // int\n\t\t\t\t\t'fields' => array('Attribute.id', 'Attribute.event_id', 'Attribute.type', 'Attribute.value'),\n\t\t\t\t\t'contain' => array('Event'=> array('fields' => array('Event.id', 'Event.threat_level_id'))),\n\t\t\t\t\t'group' => array('Attribute.type', 'Attribute.value1'), // fields to GROUP BY\n\t\t\t\t\t'enforceWarninglist' => $enforceWarninglist,\n\t\t\t\t\t'includeAllTags' => $includeAllTags,\n\t\t\t\t\t'flatten' => true\n\t\t\t);\n\t\t\t$items = $this->fetchAttributes($user, $params);\n\t\t\tif (empty($items)) continue;\n\t\t\t// export depending on the requested type\n\t\t\tswitch ($format) {\n\t\t\t\tcase 'suricata':\n\t\t\t\t\t$export = new NidsSuricataExport();\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'snort':\n\t\t\t\t\t$export = new NidsSnortExport();\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\t$rules = array_merge($rules, $export->export($items, $user['nids_sid'], $format, $continue));\n\t\t\t// Only prepend the comments once\n\t\t\t$continue = true;\n\t\t}\n\t\treturn $rules;\n\t}\n\n\tpublic function text($user, $type, $tags = false, $eventId = false, $allowNonIDS = false, $from = false, $to = false, $last = false, $enforceWarninglist = false, $allowNotPublished = false) {\n\t\t//permissions are taken care of in fetchAttributes()\n\t\t$conditions['AND'] = array();\n\t\tif ($allowNonIDS === false) {\n\t\t\t$conditions['AND']['Attribute.to_ids'] = 1;\n\t\t\tif ($allowNotPublished === false) $conditions['AND']['Event.published'] = 1;\n\t\t}\n\t\tif (!is_array($type) && $type !== 'all') $conditions['AND']['Attribute.type'] = $type;\n\t\tif ($from) $conditions['AND']['Event.date >='] = $from;\n\t\tif ($to) $conditions['AND']['Event.date <='] = $to;\n\t\tif ($last) $conditions['AND']['Event.publish_timestamp >='] = $last;\n\n\t\tif ($eventId !== false) {\n\t\t\t$conditions['AND'][] = array('Event.id' => $eventId);\n\t\t} else if ($tags !== false) {\n\t\t\t// If we sent any tags along, load the associated tag names for each attribute\n\t\t\t$tag = ClassRegistry::init('Tag');\n\t\t\t$args = $this->dissectArgs($tags);\n\t\t\t$tagArray = $tag->fetchEventTagIds($args[0], $args[1]);\n\t\t\t$temp = array();\n\t\t\tforeach ($tagArray[0] as $accepted) {\n\t\t\t\t$temp['OR'][] = array('Event.id' => $accepted);\n\t\t\t}\n\t\t\t$conditions['AND'][] = $temp;\n\t\t\t$temp = array();\n\t\t\tforeach ($tagArray[1] as $rejected) {\n\t\t\t\t$temp['AND'][] = array('Event.id !=' => $rejected);\n\t\t\t}\n\t\t\t$conditions['AND'][] = $temp;\n\t\t}\n\t\t$attributes = $this->fetchAttributes($user, array(\n\t\t\t\t'conditions' => $conditions,\n\t\t\t\t'order' => 'Attribute.value1 ASC',\n\t\t\t\t'fields' => array('value'),\n\t\t\t\t'contain' => array('Event' => array(\n\t\t\t\t\t'fields' => array('Event.id', 'Event.published', 'Event.date', 'Event.publish_timestamp'),\n\t\t\t\t)),\n\t\t\t\t'enforceWarninglist' => $enforceWarninglist,\n\t\t\t\t'flatten' => 1\n\t\t));\n\t\treturn $attributes;\n\t}\n\n\tpublic function rpz($user, $tags = false, $eventId = false, $from = false, $to = false, $enforceWarninglist = false) {\n\t\t// we can group hostname and domain as well as ip-src and ip-dst in this case\n\t\t$conditions['AND'] = array('Attribute.to_ids' => 1, 'Event.published' => 1);\n\t\t$typesToFetch = array('ip' => array('ip-src', 'ip-dst'), 'domain' => array('domain'), 'hostname' => array('hostname'));\n\t\tif ($from) $conditions['AND']['Event.date >='] = $from;\n\t\tif ($to) $conditions['AND']['Event.date <='] = $to;\n\t\tif ($eventId !== false) {\n\t\t\t$conditions['AND'][] = array('Event.id' => $eventId);\n\t\t}\n\t\tif ($tags !== false) {\n\t\t\t// If we sent any tags along, load the associated tag names for each attribute\n\t\t\t$tag = ClassRegistry::init('Tag');\n\t\t\t$args = $this->dissectArgs($tags);\n\t\t\t$tagArray = $tag->fetchEventTagIds($args[0], $args[1]);\n\t\t\t$temp = array();\n\t\t\tforeach ($tagArray[0] as $accepted) {\n\t\t\t\t$temp['OR'][] = array('Event.id' => $accepted);\n\t\t\t}\n\t\t\t$conditions['AND'][] = $temp;\n\t\t\t$temp = array();\n\t\t\tforeach ($tagArray[1] as $rejected) {\n\t\t\t\t$temp['AND'][] = array('Event.id !=' => $rejected);\n\t\t\t}\n\t\t\t$conditions['AND'][] = $temp;\n\t\t}\n\t\t$values = array();\n\t\tforeach ($typesToFetch as $k => $v) {\n\t\t\t$tempConditions = $conditions;\n\t\t\t$tempConditions['type'] = $v;\n\t\t\t$temp = $this->fetchAttributes(\n\t\t\t\t\t$user,\n\t\t\t\t\tarray(\n\t\t\t\t\t\t'conditions' => $tempConditions,\n\t\t\t\t\t\t'fields' => array('Attribute.value'), // array of field names\n\t\t\t\t\t\t'enforceWarninglist' => $enforceWarninglist\n\t\t\t\t\t)\n\t\t\t);\n\t\t\tif (empty($temp)) continue;\n\t\t\tif ($k == 'hostname') {\n\t\t\t\tforeach ($temp as $value) {\n\t\t\t\t\t$found = false;\n\t\t\t\t\tif (isset($values['domain'])) {\n\t\t\t\t\t\tforeach ($values['domain'] as $domain) {\n\t\t\t\t\t\t\tif (strpos($value['Attribute']['value'], $domain) != 0) {\n\t\t\t\t\t\t\t\t$found = true;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!$found) $values[$k][] = $value['Attribute']['value'];\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tforeach ($temp as $value) {\n\t\t\t\t\t$values[$k][] = $value['Attribute']['value'];\n\t\t\t\t}\n\t\t\t}\n\t\t\tunset($temp);\n\t\t}\n\t\treturn $values;\n\t}\n\n\tpublic function bro($user, $type, $tags = false, $eventId = false, $from = false, $to = false, $last = false, $enforceWarninglist = false) {\n\t\tApp::uses('BroExport', 'Export');\n\t\t$export = new BroExport();\n\t\tif ($type == 'all') {\n\t\t  $types = array_keys($export->mispTypes);\n\t\t} else {\n\t\t  $types = array($type);\n\t\t}\n\t\t$intel = array();\n\t\tforeach ($types as $type) {\n\t\t\t//restricting to non-private or same org if the user is not a site-admin.\n\t\t\t$conditions['AND'] = array('Attribute.to_ids' => 1, 'Event.published' => 1);\n\t\t\tif ($from) $conditions['AND']['Event.date >='] = $from;\n\t\t\tif ($to) $conditions['AND']['Event.date <='] = $to;\n\t\t\tif ($last) $conditions['AND']['Event.publish_timestamp >='] = $last;\n\t\t\tif ($eventId !== false) {\n\t\t\t\t$temp = array();\n\t\t\t\t$args = $this->dissectArgs($eventId);\n\t\t\t\tforeach ($args[0] as $accepted) {\n\t\t\t\t\t$temp['OR'][] = array('Event.id' => $accepted);\n\t\t\t\t}\n\t\t\t\t$conditions['AND'][] = $temp;\n\t\t\t\t$temp = array();\n\t\t\t\tforeach ($args[1] as $rejected) {\n\t\t\t\t\t$temp['AND'][] = array('Event.id !=' => $rejected);\n\t\t\t\t}\n\t\t\t\t$conditions['AND'][] = $temp;\n\t\t\t}\n\t\t\tif ($tags !== false) {\n\t\t\t\t// If we sent any tags along, load the associated tag names for each attribute\n\t\t\t\t$tag = ClassRegistry::init('Tag');\n\t\t\t\t$args = $this->dissectArgs($tags);\n\t\t\t\t$tagArray = $tag->fetchEventTagIds($args[0], $args[1]);\n\t\t\t\t$temp = array();\n\t\t\t\tforeach ($tagArray[0] as $accepted) {\n\t\t\t\t\t$temp['OR'][] = array('Event.id' => $accepted);\n\t\t\t\t}\n\t\t\t\t$conditions['AND'][] = $temp;\n\t\t\t\t$temp = array();\n\t\t\t\tforeach ($tagArray[1] as $rejected) {\n\t\t\t\t\t$temp['AND'][] = array('Event.id !=' => $rejected);\n\t\t\t\t}\n\t\t\t\t$conditions['AND'][] = $temp;\n\t\t\t}\n\t\t\t$this->Whitelist = ClassRegistry::init('Whitelist');\n\t\t\t$this->whitelist = $this->Whitelist->getBlockedValues();\n\t\t\t$instanceString = 'MISP';\n\t\t\tif (Configure::read('MISP.host_org_id') && Configure::read('MISP.host_org_id') > 0) {\n\t\t\t\t$this->Event->Orgc->id = Configure::read('MISP.host_org_id');\n\t\t\t\tif ($this->Event->Orgc->exists()) {\n\t\t\t\t\t$instanceString = $this->Event->Orgc->field('name') . ' MISP';\n\t\t\t\t}\n\t\t\t}\n\t\t\t$mispTypes = $export->getMispTypes($type);\n\t\t\tforeach($mispTypes as $mispType) {\n\t\t\t\t$conditions['AND']['Attribute.type'] = $mispType[0];\n\t\t\t\t$intel = array_merge($intel, $this->__bro($user, $conditions, $mispType[1], $export, $this->whitelist, $instanceString, $enforceWarninglist));\n\t\t\t}\n\t\t}\n\t\tnatsort($intel);\n\t\t$intel = array_unique($intel);\n\t\tarray_unshift($intel, $export->header);\n\t\treturn $intel;\n\t}\n\n\tprivate function __bro($user, $conditions, $valueField, $export, $whitelist, $instanceString, $enforceWarninglist) {\n\t\t$attributes = $this->fetchAttributes($user, array(\n\t\t\t\t'conditions' => $conditions, // array of conditions\n\t\t\t\t'order' => 'Attribute.value' . $valueField . ' ASC',\n\t\t\t\t'recursive' => -1, // int\n\t\t\t\t'fields' => array('Attribute.id', 'Attribute.event_id', 'Attribute.type', 'Attribute.comment', 'Attribute.value' . $valueField . \" as value\"),\n\t\t\t\t'contain' => array('Event' => array('fields' => array('Event.id', 'Event.threat_level_id', 'Event.orgc_id', 'Event.uuid'))),\n\t\t\t\t'group' => array('Attribute.type', 'Attribute.value' . $valueField), // fields to GROUP BY\n\t\t\t\t'enforceWarninglist' => $enforceWarninglist\n\t\t\t)\n\t\t);\n\t\t$orgs = $this->Event->Orgc->find('list', array(\n\t\t\t\t'fields' => array('Orgc.id', 'Orgc.name')\n\t\t));\n\t\treturn $export->export($attributes, $orgs, $valueField, $whitelist, $instanceString);\n\t}\n\n\tpublic function generateCorrelation($jobId = false, $startPercentage = 0, $eventId = false, $attributeId = false) {\n\t\t$this->Correlation = ClassRegistry::init('Correlation');\n\t\t$this->purgeCorrelations($eventId);\n\t\t// get all attributes..\n\t\tif (!$eventId) {\n\t\t\t$eventIds = $this->Event->find('list', array('recursive' => -1, 'fields' => array('Event.id')));\n\t\t} else {\n\t\t\t$eventIds = array($eventId);\n\t\t}\n\t\t$attributeCount = 0;\n\t\tif (Configure::read('MISP.background_jobs') && $jobId) {\n\t\t\t$this->Job = ClassRegistry::init('Job');\n\t\t\t$this->Job->id = $jobId;\n\t\t\t$eventCount = count($eventIds);\n\t\t}\n\t\tforeach (array_values($eventIds) as $j => $id) {\n\t\t\tif ($jobId && Configure::read('MISP.background_jobs')) {\n\t\t\t\tif ($attributeId) {\n\t\t\t\t\t$this->Job->saveField('message', 'Correlating Attribute ' . $attributeId);\n\t\t\t\t} else {\n\t\t\t\t\t$this->Job->saveField('message', 'Correlating Event ' . $id);\n\t\t\t\t}\n\t\t\t\t$this->Job->saveField('progress', ($startPercentage + ($j / $eventCount * (100 - $startPercentage))));\n\t\t\t}\n\t\t\t$event = $this->Event->find('first', array(\n\t\t\t\t\t'recursive' => -1,\n\t\t\t\t\t'fields' => array('Event.distribution', 'Event.id', 'Event.info', 'Event.org_id', 'Event.date', 'Event.sharing_group_id', 'Event.disable_correlation'),\n\t\t\t\t\t'conditions' => array('id' => $id),\n\t\t\t\t\t'order' => array()\n\t\t\t));\n\t\t\t$attributeConditions = array('Attribute.event_id' => $id, 'Attribute.deleted' => 0);\n\t\t\tif ($attributeId) {\n\t\t\t\t$attributeConditions['Attribute.id'] = $attributeId;\n\t\t\t}\n\t\t\t$attributes = $this->find('all', array('recursive' => -1, 'conditions' => $attributeConditions, 'order' => array()));\n\t\t\tforeach ($attributes as $k => $attribute) {\n\t\t\t\t$this->__afterSaveCorrelation($attribute['Attribute'], true, $event);\n\t\t\t\t$attributeCount++;\n\t\t\t}\n\t\t}\n\t\tif ($jobId && Configure::read('MISP.background_jobs')) $this->Job->saveField('message', 'Job done.');\n\t\treturn $attributeCount;\n\t}\n\n\tpublic function purgeCorrelations($eventId = false, $attributeId = false) {\n\t\tif (!$eventId) {\n\t\t\t$this->query('TRUNCATE TABLE correlations;');\n\t\t} else if (!$attributeId) {\n\t\t\t$this->Correlation = ClassRegistry::init('Correlation');\n\t\t\t$this->Correlation->deleteAll(array('OR' => array(\n\t\t\t\t'Correlation.1_event_id' => $eventId,\n\t\t\t\t'Correlation.event_id' => $eventId))\n\t\t\t);\n\t\t} else {\n\t\t\t$this->Correlation->deleteAll(array('OR' => array(\n\t\t\t\t'Correlation.1_attribute_id' => $attributeId,\n\t\t\t\t'Correlation.attribute_id' => $attributeId))\n\t\t\t);\n\t\t}\n\t}\n\n\tpublic function reportValidationIssuesAttributes($eventId) {\n\t\t$conditions = array();\n\t\tif ($eventId && is_numeric($eventId)) $conditions = array('event_id' => $eventId);\n\n\t\t// get all attributes..\n\t\t$attributes = $this->find('all', array('recursive' => -1, 'fields' => array('id'), 'conditions' => $conditions));\n\t\t// for all attributes..\n\t\t$result = array();\n\t\t$i = 0;\n\t\tforeach ($attributes as $a) {\n\t\t\t$attribute = $this->find('first', array('recursive' => -1, 'conditions' => array('id' => $a['Attribute']['id'])));\n\t\t\t$this->set($attribute);\n\t\t\tif (!$this->validates()) {\n\t\t\t\t$errors = $this->validationErrors;\n\t\t\t\t$result[$i]['id'] = $attribute['Attribute']['id'];\n\t\t\t\t$result[$i]['error'] = array();\n\t\t\t\tforeach ($errors as $field => $error) {\n\t\t\t\t\t$result[$i]['error'][$field] = array('value' => $attribute['Attribute'][$field], 'error' => $error[0]);\n\t\t\t\t}\n\t\t\t\t$result[$i]['details'] = 'Event ID: [' . $attribute['Attribute']['event_id'] . \"] - Category: [\" . $attribute['Attribute']['category'] . \"] - Type: [\" . $attribute['Attribute']['type'] . \"] - Value: [\" . $attribute['Attribute']['value'] . ']';\n\t\t\t\t$i++;\n\t\t\t}\n\t\t}\n\t\treturn $result;\n\t}\n\n\t// This method takes a string from an argument with several elements (separated by '&&' and negated by '!') and returns 2 arrays\n\t// array 1 will have all of the non negated terms and array 2 all the negated terms\n\tpublic function dissectArgs($args) {\n\t\tif (!$args) return array(null, null);\n\t\tif (is_array($args)) {\n\t\t\t$argArray = $args;\n\t\t} else {\n\t\t\t$argArray = explode('&&', $args);\n\t\t}\n\t\t$accept = $reject = $result = array();\n\t\t$reject = array();\n\t\tforeach ($argArray as $arg) {\n\t\t\tif (substr($arg, 0, 1) == '!') {\n\t\t\t\t$reject[] = substr($arg, 1);\n\t\t\t} else {\n\t\t\t\t$accept[] = $arg;\n\t\t\t}\n\t\t}\n\t\t$result[0] = $accept;\n\t\t$result[1] = $reject;\n\t\treturn $result;\n\t}\n\n\tpublic function checkForValidationIssues($attribute) {\n\t\t$this->set($attribute);\n\t\tif ($this->validates()) {\n\t\t\treturn false;\n\t\t} else {\n\t\t\treturn $this->validationErrors;\n\t\t}\n\t}\n\n\n\tpublic function checkTemplateAttributes($template, $data, $event_id) {\n\t\t$result = array();\n\t\t$errors = array();\n\t\t$attributes = array();\n\t\tif (isset($data['Template']['fileArray'])) $fileArray = json_decode($data['Template']['fileArray'], true);\n\t\tforeach ($template['TemplateElement'] as $element) {\n\t\t\tif ($element['element_definition'] == 'attribute') {\n\t\t\t\t$result = $this->__resolveElementAttribute($element['TemplateElementAttribute'][0], $data['Template']['value_' . $element['id']]);\n\t\t\t} else if ($element['element_definition'] == 'file') {\n\t\t\t\t$temp = array();\n\t\t\t\tif (isset($fileArray)) {\n\t\t\t\t\tforeach ($fileArray as $fileArrayElement) {\n\t\t\t\t\t\tif ($fileArrayElement['element_id'] == $element['id']) {\n\t\t\t\t\t\t\t$temp[] = $fileArrayElement;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t$result = $this->__resolveElementFile($element['TemplateElementFile'][0], $temp);\n\t\t\t\tif ($element['TemplateElementFile'][0]['mandatory'] && empty($temp) && empty($errors[$element['id']])) $errors[$element['id']] = 'This field is mandatory.';\n\t\t\t}\n\t\t\tif ($element['element_definition'] == 'file' || $element['element_definition'] == 'attribute') {\n\t\t\t\tif ($result['errors']) {\n\t\t\t\t\t$errors[$element['id']] = $result['errors'];\n\t\t\t\t} else {\n\t\t\t\t\tforeach ($result['attributes'] as &$a) {\n\t\t\t\t\t\t$a['event_id'] = $event_id;\n\t\t\t\t\t\t$a['distribution'] = 5;\n\t\t\t\t\t\t$test = $this->checkForValidationIssues(array('Attribute' => $a));\n\t\t\t\t\t\tif ($test) {\n\t\t\t\t\t\t\tforeach ($test['value'] as $e) {\n\t\t\t\t\t\t\t\t$errors[$element['id']] = $e;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t$attributes[] = $a;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn array('attributes' => $attributes, 'errors' => $errors);\n\t}\n\n\n\tprivate function __resolveElementAttribute($element, $value) {\n\t\t$attributes = array();\n\t\t$results = array();\n\t\t$errors = null;\n\t\tif (!empty($value)) {\n\t\t\t\tif ($element['batch']) {\n\t\t\t\t$values = explode(\"\\n\", $value);\n\t\t\t\tforeach ($values as $v) {\n\t\t\t\t\t$v = trim($v);\n\t\t\t\t\t$attributes[] = $this->__createAttribute($element, $v);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t$attributes[] = $this->__createAttribute($element, trim($value));\n\t\t\t}\n\t\t\tforeach ($attributes as $att) {\n\t\t\t\tif (isset($att['multi'])) {\n\t\t\t\t\tforeach ($att['multi'] as $a) {\n\t\t\t\t\t\t$results[] = $a;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t$results[] = $att;\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tif ($element['mandatory']) $errors = 'This field is mandatory.';\n\t\t}\n\t\treturn array('attributes' => $results, 'errors' => $errors);\n\t}\n\n\tprivate function __resolveElementFile($element, $files) {\n\t\t$attributes = array();\n\t\t$errors = null;\n\t\t$element['complex'] = 0;\n\t\tif ($element['malware']) {\n\t\t\t$element['type'] = 'malware-sample';\n\t\t\t$element['to_ids'] = 1;\n\t\t} else {\n\t\t\t$element['type'] = 'attachment';\n\t\t\t$element['to_ids'] = 0;\n\t\t}\n\t\tforeach ($files as $file) {\n\t\t\tif (!$this->checkFilename($file['filename'])) {\n\t\t\t\t$errors = 'Filename not allowed.';\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif ($element['malware']) {\n\t\t\t\t$malwareName = $file['filename'] . '|' . hash_file('md5', APP . 'tmp/files/' . $file['tmp_name']);\n\t\t\t\t$tmp_file = new File(APP . 'tmp/files/' . $file['tmp_name']);\n\t\t\t\tif (!$tmp_file->readable()) {\n\t\t\t\t\t$errors = 'File cannot be read.';\n\t\t\t\t} else {\n\t\t\t\t\t$element['type'] = 'malware-sample';\n\t\t\t\t\t$attributes[] = $this->__createAttribute($element, $malwareName);\n\t\t\t\t\t$attributes[count($attributes) - 1]['data'] = $file['tmp_name'];\n\t\t\t\t\t$element['type'] = 'filename|sha256';\n\t\t\t\t\t$sha256 = $file['filename'] . '|' . (hash_file('sha256', APP . 'tmp/files/' . $file['tmp_name']));\n\t\t\t\t\t$attributes[] = $this->__createAttribute($element, $sha256);\n\t\t\t\t\t$element['type'] = 'filename|sha1';\n\t\t\t\t\t$sha1 = $file['filename'] . '|' . (hash_file('sha1', APP . 'tmp/files/' . $file['tmp_name']));\n\t\t\t\t\t$attributes[] = $this->__createAttribute($element, $sha1);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t$attributes[] = $this->__createAttribute($element, $file['filename']);\n\t\t\t\t$tmp_file = new File(APP . 'tmp/files/' . $file['tmp_name']);\n\t\t\t\tif (!$tmp_file->readable()) {\n\t\t\t\t\t$errors = 'File cannot be read.';\n\t\t\t\t} else {\n\t\t\t\t\t$attributes[count($attributes) - 1]['data'] = $file['tmp_name'];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn array('attributes' => $attributes, 'errors' => $errors, 'files' => $files);\n\t}\n\n\tprivate function __createAttribute($element, $value) {\n\t\t$attribute = array(\n\t\t\t\t'comment' => $element['name'],\n\t\t\t\t'to_ids' => $element['to_ids'],\n\t\t\t\t'category' => $element['category'],\n\t\t\t\t'value' => $value,\n\t\t);\n\t\tif ($element['complex']) {\n\t\t\tApp::uses('ComplexTypeTool', 'Tools');\n\t\t\t$complexTypeTool = new ComplexTypeTool();\n\t\t\t$result = $complexTypeTool->checkComplexRouter($value, ucfirst($element['type']));\n\t\t\tif (isset($result['multi'])) {\n\t\t\t\t$temp = $attribute;\n\t\t\t\t$attribute = array();\n\t\t\t\tforeach ($result['multi'] as $k => $r) {\n\t\t\t\t\t$attribute['multi'][] = $temp;\n\t\t\t\t\t$attribute['multi'][$k]['type'] = $r['type'];\n\t\t\t\t\t$attribute['multi'][$k]['value'] = $r['value'];\n\t\t\t\t}\n\t\t\t} else if ($result != false) {\n\t\t\t\t$attribute['type'] = $result['type'];\n\t\t\t\t$attribute['value'] = $result['value'];\n\t\t\t} else {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t} else {\n\t\t\t$attribute['type'] = $element['type'];\n\t\t}\n\t\treturn $attribute;\n\t}\n\n\tpublic function buildConditions($user) {\n\t\t$conditions = array();\n\t\tif (!$user['Role']['perm_site_admin']) {\n\t\t\t$sgids = $this->SharingGroup->fetchAllAuthorised($user);\n\t\t\t$conditions = array(\n\t\t\t\t'AND' => array(\n\t\t\t\t\tarray(\n\t\t\t\t\t\t'OR' => array(\n\t\t\t\t\t\t\t'Event.org_id' => $user['org_id'],\n\t\t\t\t\t\t\tarray(\n\t\t\t\t\t\t\t\t'AND' => array(\n\t\t\t\t\t\t\t\t\t'Event.distribution >' => 0,\n\t\t\t\t\t\t\t\t\t'Event.distribution <' => 4,\n\t\t\t\t\t\t\t\t\tConfigure::read('MISP.unpublishedprivate') ? array('Event.published =' => 1) : array(),\n\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\tarray(\n\t\t\t\t\t\t\t\t'AND' => array(\n\t\t\t\t\t\t\t\t\t'Event.sharing_group_id' => $sgids,\n\t\t\t\t\t\t\t\t\t'Event.distribution' => 4,\n\t\t\t\t\t\t\t\t\tConfigure::read('MISP.unpublishedprivate') ? array('Event.published =' => 1) : array(),\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t)\n\t\t\t\t\t),\n\t\t\t\t\tarray(\n\t\t\t\t\t\t'OR' => array(\n\t\t\t\t\t\t\t'Event.org_id' => $user['org_id'],\n\t\t\t\t\t\t\t'Attribute.distribution' => array('1', '2', '3', '5'),\n\t\t\t\t\t\t\t'AND '=> array(\n\t\t\t\t\t\t\t\t'Attribute.distribution' => 4,\n\t\t\t\t\t\t\t\t'Attribute.sharing_group_id' => $sgids,\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t)\n\t\t\t\t\t),\n\t\t\t\t\tarray(\n\t\t\t\t\t\t'OR' => array(\n\t\t\t\t\t\t\t'Attribute.object_id' => 0,\n\t\t\t\t\t\t\t'Event.org_id' => $user['org_id'],\n\t\t\t\t\t\t\t'Object.distribution' => array('1', '2', '3', '5'),\n\t\t\t\t\t\t\t'AND' => array(\n\t\t\t\t\t\t\t\t'Object.distribution' => 4,\n\t\t\t\t\t\t\t\t'Object.sharing_group_id' => $sgids,\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t)\n\t\t\t\t\t)\n\t\t\t\t)\n\t\t\t);\n\t\t}\n\t\treturn $conditions;\n\t}\n\n\tpublic function listVisibleAttributes($user, $options = array()) {\n\t\t$params = array(\n\t\t\t'conditions' => $this->buildConditions($user),\n\t\t\t'recursive' => -1,\n\t\t\t'fields' => array('Attribute.id', 'Attribute.id'),\n\t\t);\n\t\tif (isset($options['conditions'])) {\n\t\t\t$params['conditions']['AND'][] = $options['conditions'];\n\t\t}\n\t\treturn $this->find('list', $params);\n\t}\n\n\t/*\n\t * Unlike the other fetchers, this one foregoes any ACL checks.\n\t * the objective is simple: Fetch the given attribute with all related objects needed for the ZMQ output,\n\t * standardising on this function for fetching the attribute to be passed to Attribute->save()\n\t */\n\tpublic function fetchAttribute($id) {\n\t\t$attribute = $this->find('first', array(\n\t\t\t'recursive' => -1,\n\t\t\t'conditions' => array('Attribute.id' => $id),\n\t\t\t'contain' => array(\n\t\t\t\t'Event' => array(\n\t\t\t\t\t'Orgc' => array(\n\t\t\t\t\t\t'fields' => array('Orgc.id', 'Orgc.uuid', 'Orgc.name')\n\t\t\t\t\t),\n\t\t\t\t\t'fields' => array('Event.id', 'Event.date', 'Event.info', 'Event.uuid', 'Event.published', 'Event.analysis', 'Event.threat_level_id', 'Event.org_id', 'Event.orgc_id', 'Event.distribution', 'Event.sharing_group_id')\n\t\t\t\t),\n\t\t\t\t'AttributeTag' => array(\n\t\t\t\t\t'Tag' => array('fields' => array('Tag.id', 'Tag.name', 'Tag.colour', 'Tag.exportable'))\n\t\t\t\t),\n\t\t\t\t'Object'\n\t\t\t)\n\t\t));\n\t\tif (!empty($attribute)) {\n\t\t\tif (!empty($attribute['AttributeTag'])) {\n\t\t\t\tforeach ($attribute['AttributeTag'] as $at) {\n\t\t\t\t\tif ($at['Tag']['exportable']) $attribute['Attribute']['Tag'][] = $at['Tag'];\n\t\t\t\t}\n\t\t\t}\n\t\t\tunset($attribute['AttributeTag']);\n\t\t}\n\t\treturn $attribute;\n\t}\n\n\tpublic function fetchAttributesSimple($user, $options = array()) {\n\t\t$params = array(\n\t\t\t'conditions' => $this->buildConditions($user),\n\t\t\t'fields' => array(),\n\t\t\t'recursive' => -1\n\t\t);\n\t\tif (isset($options['conditions'])) {\n\t\t\t$params['conditions']['AND'][] = $options['conditions'];\n\t\t}\n\t\tif (isset($options['fields'])) {\n\t\t\t$params['fields'] = $options['fields'];\n\t\t}\n\t\t$results = $this->find('all', array(\n\t\t\t'conditions' => $params['conditions'],\n\t\t\t'recursive' => -1,\n\t\t\t'fields' => $params['fields'],\n\t\t\t'sort' => false\n\t\t));\n\t\treturn $results;\n\n\t}\n\n\t// Method that fetches all attributes for the various exports\n\t// very flexible, it's basically a replacement for find, with the addition that it restricts access based on user\n\t// options:\n\t//     fields\n\t//     contain\n\t//     conditions\n\t//     order\n\t//     group\n\tpublic function fetchAttributes($user, $options = array()) {\n\t\t$params = array(\n\t\t\t'conditions' => $this->buildConditions($user),\n\t\t\t'recursive' => -1,\n\t\t\t'contain' => array(\n\t\t\t\t'Event' => array(\n\t\t\t\t\t'fields' => array('id', 'info', 'org_id', 'orgc_id', 'uuid'),\n\t\t\t\t),\n\t\t\t\t'Object' => array(\n\t\t\t\t\t'fields' => array('id', 'distribution', 'sharing_group_id')\n\t\t\t\t)\n\t\t\t)\n\t\t);\n\t\t$params['contain']['AttributeTag'] = array('Tag' => array('conditions' => array()));\n\t\tif (empty($options['includeAllTags'])) $params['contain']['AttributeTag']['Tag']['conditions']['exportable'] = 1;\n\t\tif (isset($options['contain'])) $params['contain'] = array_merge_recursive($params['contain'], $options['contain']);\n\t\tif (isset($options['page'])) $params['page'] = $options['page'];\n\t\tif (isset($options['limit'])) $params['limit'] = $options['limit'];\n\t\telse $option['contain']['Event']['fields'] = array('id', 'info', 'org_id', 'orgc_id');\n\t\tif (Configure::read('MISP.proposals_block_attributes') && isset($options['conditions']['AND']['Attribute.to_ids']) && $options['conditions']['AND']['Attribute.to_ids'] == 1) {\n\t\t\t$this->bindModel(array('hasMany' => array('ShadowAttribute' => array('foreignKey' => 'old_id'))));\n\t\t\t$proposalRestriction =  array(\n\t\t\t\t\t'ShadowAttribute' => array(\n\t\t\t\t\t\t\t'conditions' => array(\n\t\t\t\t\t\t\t\t\t'AND' => array(\n\t\t\t\t\t\t\t\t\t\t\t'ShadowAttribute.deleted' => 0,\n\t\t\t\t\t\t\t\t\t\t\t'OR' => array(\n\t\t\t\t\t\t\t\t\t\t\t\t\t'ShadowAttribute.proposal_to_delete' => 1,\n\t\t\t\t\t\t\t\t\t\t\t\t\t'ShadowAttribute.to_ids' => 0\n\t\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t'fields' => array('ShadowAttribute.id')\n\t\t\t\t\t)\n\t\t\t);\n\t\t\t$params['contain'] = array_merge($params['contain'], $proposalRestriction);\n\t\t}\n\t\tif (isset($options['fields'])) $params['fields'] = $options['fields'];\n\t\tif (isset($options['conditions'])) $params['conditions']['AND'][] = $options['conditions'];\n\t\tif (empty($options['flatten'])) $params['conditions']['AND'][] = array('Attribute.object_id' => 0);\n\t\tif (isset($options['order'])) $params['order'] = $options['order'];\n\t\tif (!isset($options['withAttachments'])) $options['withAttachments'] = false;\n\t\telse ($params['order'] = array());\n\t\tif (!isset($options['enforceWarninglist'])) $options['enforceWarninglist'] = false;\n\t\tif (!$user['Role']['perm_sync'] || !isset($options['deleted']) || !$options['deleted']) $params['conditions']['AND']['Attribute.deleted'] = 0;\n\t\tif (isset($options['group'])) $params['group'] = empty($options['group']) ? $options['group'] : false;\n\t\tif (Configure::read('MISP.unpublishedprivate')) $params['conditions']['AND'][] = array('OR' => array('Event.published' => 1, 'Event.orgc_id' => $user['org_id']));\n\t\tif (!empty($options['list'])) {\n\t\t\tif (!empty($options['event_ids'])) {\n\t\t\t\t$fields = array('Attribute.event_id', 'Attribute.event_id');\n\t\t\t\t$group = array('Attribute.event_id');\n\t\t\t} else {\n\t\t\t\t$fields = array('Attribute.event_id');\n\t\t\t\t$group = false;\n\t\t\t}\n\t\t\t$results = $this->find('list', array(\n\t\t\t\t'conditions' => $params['conditions'],\n\t\t\t\t'recursive' => -1,\n\t\t\t\t'contain' => array('Event', 'Object'),\n\t\t\t\t'fields' => $fields,\n\t\t\t\t'group' => $group,\n\t\t\t\t'sort' => false\n\t\t\t));\n\t\t\treturn $results;\n\t\t}\n\t\t$results = $this->find('all', $params);\n\t\t// return false if we're paginating\n\t\tif (isset($options['limit']) && empty($results)) return false;\n\t\tif ($options['enforceWarninglist']) {\n\t\t\t$this->Warninglist = ClassRegistry::init('Warninglist');\n\t\t\t$warninglists = $this->Warninglist->fetchForEventView();\n\t\t}\n\t\t$results = array_values($results);\n\t\t$proposals_block_attributes = Configure::read('MISP.proposals_block_attributes');\n\t\tforeach ($results as $key => $attribute) {\n\t\t\tif ($options['enforceWarninglist'] && !$this->Warninglist->filterWarninglistAttributes($warninglists, $attribute['Attribute'])) {\n\t\t\t\tunset($results[$key]);\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (!empty($options['includeAttributeUuid']) || !empty($options['includeEventUuid'])) {\n\t\t\t\t$results[$key]['Attribute']['event_uuid'] = $results[$key]['Event']['uuid'];\n\t\t\t}\n\t\t\tif ($proposals_block_attributes) {\n\t\t\t\tif (!empty($attribute['ShadowAttribute'])) {\n\t\t\t\t\tunset($results[$key]);\n\t\t\t\t} else {\n\t\t\t\t\tunset($results[$key]['ShadowAttribute']);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif ($options['withAttachments']) {\n\t\t\t\tif ($this->typeIsAttachment($attribute['Attribute']['type'])) {\n\t\t\t\t\t$encodedFile = $this->base64EncodeAttachment($attribute['Attribute']);\n\t\t\t\t\t$results[$key]['Attribute']['data'] = $encodedFile;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn $results;\n\t}\n\n\t// Method gets and converts the contents of a file passed along as a base64 encoded string with the original filename into a zip archive\n\t// The zip archive is then passed back as a base64 encoded string along with the md5 hash and a flag whether the transaction was successful\n\t// The archive is password protected using the \"infected\" password\n\t// The contents of the archive will be the actual sample, named <md5> and the original filename in a text file named <md5>.filename.txt\n\tpublic function handleMaliciousBase64($event_id, $original_filename, $base64, $hash_types, $proposal = false) {\n\t\tif (!is_numeric($event_id)) throw new Exception('Something went wrong. Received a non-numeric event ID while trying to create a zip archive of an uploaded malware sample.');\n\t\t$attachments_dir = Configure::read('MISP.attachments_dir');\n\t\tif (empty($attachments_dir)) {\n\t\t\t$my_server = ClassRegistry::init('Server');\n\t\t\t$attachments_dir = $my_server->getDefaultAttachments_dir();\n\t\t}\n\t\tif ($proposal) {\n\t\t\t$dir = new Folder($attachments_dir . DS . $event_id . DS . 'shadow', true);\n\t\t} else {\n\t\t\t$dir = new Folder($attachments_dir . DS . $event_id, true);\n\t\t}\n\t\t$tmpFile = new File($dir->path . DS . $this->generateRandomFileName(), true, 0600);\n\t\t$tmpFile->write(base64_decode($base64));\n\t\t$hashes = array();\n\t\tforeach ($hash_types as $hash) {\n\t\t\t$hashes[$hash] = $this->__hashRouter($hash, $tmpFile->path);\n\t\t}\n\t\t$contentsFile = new File($dir->path . DS . $hashes['md5']);\n\t\trename($tmpFile->path, $contentsFile->path);\n\t\t$fileNameFile = new File($dir->path . DS . $hashes['md5'] . '.filename.txt');\n\t\t$fileNameFile->write($original_filename);\n\t\t$fileNameFile->close();\n\t\t$zipFile = new File($dir->path . DS . $hashes['md5'] . '.zip');\n\t\texec('zip -j -P infected ' . escapeshellarg($zipFile->path) . ' ' . escapeshellarg($contentsFile->path) . ' ' . escapeshellarg($fileNameFile->path), $execOutput, $execRetval);\n\t\tif ($execRetval != 0) $result = array('success' => false);\n\t\telse $result = array_merge(array('data' => base64_encode($zipFile->read()), 'success' => true), $hashes);\n\t\t$fileNameFile->delete();\n\t\t$zipFile->delete();\n\t\t$contentsFile->delete();\n\t\treturn $result;\n\t}\n\n\tprivate function __hashRouter($hashType, $file) {\n\t\t$validHashes = array('md5', 'sha1', 'sha256');\n\t\tif (!in_array($hashType, $validHashes)) return false;\n\t\tswitch ($hashType) {\n\t\t\tcase 'md5':\n\t\t\tcase 'sha1':\n\t\t\tcase 'sha256':\n\t\t\t\treturn hash_file($hashType, $file);\n\t\t\t\tbreak;\n\t\t}\n\t\treturn false;\n\t}\n\n\tpublic function generateRandomFileName() {\n\t\treturn (new RandomTool())->random_str(FALSE, 12);\n\t}\n\n\tpublic function resolveHashType($hash) {\n\t\t$hashTypes = $this->hashTypes;\n\t\t$validTypes = array();\n\t\t$length = strlen($hash);\n\t\tforeach ($hashTypes as $k => $hashType) {\n\t\t\t$temp = $hashType['lowerCase'] ? strtolower($hash) : $hash;\n\t\t\tif ($hashType['length'] == $length && preg_match($hashType['pattern'], $temp)) $validTypes[] = $k;\n\t\t}\n\t\treturn $validTypes;\n\t}\n\n\tpublic function validateAttribute($attribute, $context = true) {\n\t\t$this->set($attribute);\n\t\tif (!$context) {\n\t\t\tunset($this->validate['event_id']);\n\t\t\tunset($this->validate['value']['uniqueValue']);\n\t\t}\n\t\tif ($this->validates()) return true;\n\t\telse {\n\t\t\treturn $this->validationErrors;\n\t\t}\n\t}\n\n\tpublic function restore($id, $user) {\n\t\t$this->id = $id;\n\t\tif (!$this->exists()) return 'Attribute doesn\\'t exist, or you lack the permission to edit it.';\n\t\t$attribute = $this->find('first', array('conditions' => array('Attribute.id' => $id), 'recursive' => -1, 'contain' => array('Event')));\n\t\tif (!$user['Role']['perm_site_admin']) {\n\t\t\tif (!($attribute['Event']['orgc_id'] == $user['org_id'] && (($user['Role']['perm_modify'] && $attribute['Event']['user_id'] != $user['id']) || $user['Role']['perm_modify_org']))) {\n\t\t\t\treturn 'Attribute doesn\\'t exist, or you lack the permission to edit it.';\n\t\t\t}\n\t\t}\n\t\tunset($attribute['Attribute']['timestamp']);\n\t\t$attribute['Attribute']['deleted'] = 0;\n\t\t$date = new DateTime();\n\t\t$attribute['Attribute']['timestamp'] = $date->getTimestamp();\n\t\tif ($this->save($attribute['Attribute'])) {\n\t\t\t$attribute['Event']['published'] = 0;\n\t\t\t$attribute['Event']['timestamp'] = $date->getTimestamp();\n\t\t\t$this->Event->save($attribute['Event']);\n\t\t\treturn true;\n\t\t}\n\t\telse return 'Could not save changes.';\n\t}\n\n\tpublic function saveAttributes($attributes) {\n\t\t$defaultDistribution = 5;\n\t\tif (Configure::read('MISP.default_attribute_distribution') != null) {\n\t\t\tif (Configure::read('MISP.default_attribute_distribution') === 'event') {\n\t\t\t\t$defaultDistribution = 5;\n\t\t\t} else {\n\t\t\t\t$defaultDistribution = Configure::read('MISP.default_attribute_distribution');\n\t\t\t}\n\t\t}\n\t\tforeach ($attributes as $k => $attribute) {\n\t\t\tif (!empty($attribute['encrypt']) && $attribute['encrypt']) {\n\t\t\t\tif (strpos($attribute['value'], '|') !== false) {\n\t\t\t\t\t$temp = explode('|', $attribute['value']);\n\t\t\t\t\t$attribute['value'] = $temp[0];\n\t\t\t\t}\n\t\t\t\t$result = $this->handleMaliciousBase64($attribute['event_id'], $attribute['value'], $attribute['data'], array('md5'));\n\t\t\t\t$attribute['data'] = $result['data'];\n\t\t\t\t$attribute['value'] = $attribute['value'] . '|' . $result['md5'];\n\t\t\t}\n\t\t\tif (!isset($attribute['distribution'])) {\n\t\t\t\t$attribute['distribution'] = $defaultDistribution;\n\t\t\t}\n\t\t\tunset($attribute['Attachment']);\n\t\t\t$this->create();\n\t\t\t$this->save($attribute);\n\t\t}\n\t\treturn true;\n\t}\n\n\tpublic function saveAndEncryptAttribute($attribute, $user = false) {\n\t\t$hashes = array('md5' => 'malware-sample', 'sha1' => 'filename|sha1', 'sha256' => 'filename|sha256');\n\t\tif ($attribute['encrypt']) {\n\t\t\t$result = $this->handleMaliciousBase64($attribute['event_id'], $attribute['value'], $attribute['data'], array_keys($hashes));\n\t\t\tif (!$result['success']) {\n\t\t\t\treturn 'Could not handle the sample';\n\t\t\t}\n\t\t\tforeach ($hashes as $hash => $typeName) {\n\t\t\t\tif (!$result[$hash]) continue;\n\t\t\t\t$attributeToSave = array(\n\t\t\t\t\t'Attribute' => array(\n\t\t\t\t\t\t'value' => $attribute['value'] . '|' . $result[$hash],\n\t\t\t\t\t\t'category' => $attribute['category'],\n\t\t\t\t\t\t'type' => $typeName,\n\t\t\t\t\t\t'event_id' => $attribute['event_id'],\n\t\t\t\t\t\t'comment' => $attribute['comment'],\n\t\t\t\t\t\t'to_ids' => 1,\n\t\t\t\t\t\t'distribution' => $attribute['distribution'],\n\t\t\t\t\t\t'sharing_group_id' => isset($attribute['sharing_group_id']) ? $attribute['sharing_group_id'] : 0,\n\t\t\t\t\t)\n\t\t\t\t);\n\t\t\t\tif ($hash == 'md5') $attributeToSave['Attribute']['data'] = $result['data'];\n\t\t\t\t$this->create();\n\t\t\t\tif (!$this->save($attributeToSave)) {\n\t\t\t\t\treturn $this->validationErrors;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n\n\tpublic function convertToOpenIOC($user, $attributes) {\n\t\treturn $this->IOCExport->buildAll($this->Auth->user(), $event);\n\t}\n\n\tprivate function __createTagSubQuery($tag_id, $blocked = false, $scope = 'Event', $limitAttributeHitsTo = 'event') {\n\t\t$conditionKey = $blocked ? array('NOT' => array('EventTag.tag_id' => $tag_id)) : array('EventTag.tag_id' => $tag_id);\n\t\t$db = $this->getDataSource();\n\t\t$subQuery = $db->buildStatement(\n\t\t\tarray(\n\t\t\t\t'fields' => array($scope . 'Tag.' . $limitAttributeHitsTo . '_id'),\n\t\t\t\t'table' => strtolower($scope) . '_tags',\n\t\t\t\t'alias' => $scope . 'Tag',\n\t\t\t\t'limit' => null,\n\t\t\t\t'offset' => null,\n\t\t\t\t'joins' => array(),\n\t\t\t\t'conditions' => array(\n\t\t\t\t\t$scope . 'Tag.tag_id' => $tag_id\n\t\t\t\t),\n\t\t\t\t'group' => array($scope . 'Tag.' . $limitAttributeHitsTo . '_id')\n\t\t\t),\n\t\t\t$this\n\t\t);\n\t\t$subQuery = ucfirst($limitAttributeHitsTo) . '.id IN (' . $subQuery . ') ';\n\t\t$conditions = array(\n\t\t\t$db->expression($subQuery)->value\n\t\t);\n\t\treturn $conditions;\n\t}\n\n\tpublic function setTagConditions($tags, $conditions, $limitAttributeHitsTo = 'event') {\n\t\t$args = $this->dissectArgs($tags);\n\t\t$tagArray = $this->AttributeTag->Tag->fetchTagIdsFromFilter($args[0], $args[1]);\n\t\t$temp = array();\n\t\tif (!empty($tagArray[0])) {\n\t\t\t$temp['OR'][] = $this->__createTagSubQuery($tagArray[0]);\n\t\t\t$temp['OR'][] = $this->__createTagSubQuery($tagArray[0], false, 'Attribute', $limitAttributeHitsTo);\n\t\t}\n\t\tif (!empty($tagArray[1])) {\n\t\t\t$temp['AND']['NOT'] = $this->__createTagSubQuery($tagArray[1], true);\n\t\t\tif ($limitAttributeHitsTo == 'attribute') {\n\t\t\t\t$temp['AND']['NOT'] = $this->__createTagSubQuery($tagArray[1], true, 'Attribute', $limitAttributeHitsTo);\n\t\t\t}\n\t\t}\n\t\t$conditions['AND'][] = $temp;\n\t\treturn $conditions;\n\t}\n\n\tpublic function setPublishTimestampConditions($publish_timestamp, $conditions) {\n\t\tif (is_array($publish_timestamp)) {\n\t\t\t$conditions['AND'][] = array('Event.publish_timestamp >=' => $publish_timestamp[0]);\n\t\t\t$conditions['AND'][] = array('Event.publish_timestamp <=' => $publish_timestamp[1]);\n\t\t} else {\n\t\t\t$conditions['AND'][] = array('Event.publish_timestamp >=' => $publish_timestamp);\n\t\t}\n\t\treturn $conditions;\n\t}\n\n\tpublic function setTimestampConditions($timestamp, $conditions, $scope = 'Event') {\n\t\tif (is_array($timestamp)) {\n\t\t\t$conditions['AND'][] = array($scope . '.timestamp >=' => $timestamp[0]);\n\t\t\t$conditions['AND'][] = array($scope . '.timestamp <=' => $timestamp[1]);\n\t\t} else {\n\t\t\t$conditions['AND'][] = array($scope . '.timestamp >=' => $timestamp);\n\t\t}\n\t\treturn $conditions;\n\t}\n\n\tpublic function setToIDSConditions($to_ids, $conditions) {\n\t\tif ($to_ids === 'exclude') {\n\t\t\t$conditions['AND'][] = array('Attribute.to_ids' => 0);\n\t\t} else {\n\t\t\t$conditions['AND'][] = array('Attribute.to_ids' => 1);\n\t\t}\n\t\treturn $conditions;\n\t}\n\n\tpublic function setSimpleConditions($parameterKey, $parameterValue, $conditions) {\n\t\t$subcondition = array();\n\t\tApp::uses('CIDRTool', 'Tools');\n\t\t$cidr = new CIDRTool();\n\t\tif (is_array($parameterValue)) $elements = $parameterValue;\n\t\telse $elements = explode('&&', $parameterValue);\n\t\tforeach ($elements as $v) {\n\t\t\tif (empty($v)) continue;\n\t\t\tif (substr($v, 0, 1) == '!') {\n\t\t\t\t// check for an IPv4 address and subnet in CIDR notation (e.g. 127.0.0.1/8)\n\t\t\t\tif ($parameterKey === 'value' && $cidr->checkCIDR(substr($v, 1), 4)) {\n\t\t\t\t\t$cidrresults = $cidr->CIDR(substr($v, 1));\n\t\t\t\t\tforeach ($cidrresults as $result) {\n\t\t\t\t\t\t$subcondition['AND'][] = array('Attribute.value NOT LIKE' => $result);\n\t\t\t\t\t}\n\t\t\t\t} else if ($parameterKey === 'org') {\n\t\t\t\t\t\t// from here\n\t\t\t\t\t\t$found_orgs = $this->Event->Org->find('all', array(\n\t\t\t\t\t\t\t\t'recursive' => -1,\n\t\t\t\t\t\t\t\t'conditions' => array('LOWER(name) LIKE' => '%' . strtolower(substr($v, 1)) . '%'),\n\t\t\t\t\t\t));\n\t\t\t\t\t\tforeach ($found_orgs as $o) $subcondition['AND'][] = array('Event.orgc_id !=' => $o['Org']['id']);\n\t\t\t\t} else if ($parameterKey === 'eventid') {\n\t\t\t\t\t$subcondition['AND'][] = array('Attribute.event_id !=' => substr($v, 1));\n\t\t\t\t} else if ($parameterKey === 'uuid') {\n\t\t\t\t\t$subcondition['AND'][] = array('Event.uuid !=' => substr($v, 1));\n\t\t\t\t\t$subcondition['AND'][] = array('Attribute.uuid !=' => substr($v, 1));\n\t\t\t\t} else {\n\t\t\t\t\t$subcondition['AND'][] = array('Attribute.' . $parameterKey . ' NOT LIKE' => '%'.substr($v, 1).'%');\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// check for an IPv4 address and subnet in CIDR notation (e.g. 127.0.0.1/8)\n\t\t\t\tif ($parameterKey === 'value' && $cidr->checkCIDR($v, 4)) {\n\t\t\t\t\t$cidrresults = $cidr->CIDR($v);\n\t\t\t\t\tforeach ($cidrresults as $result) {\n\t\t\t\t\t\t$subcondition['OR'][] = array('Attribute.value LIKE' => $result);\n\t\t\t\t\t}\n\t\t\t\t} else if ($parameterKey === 'org') {\n\t\t\t\t\t// from here\n\t\t\t\t\t$found_orgs = $this->Event->Org->find('all', array(\n\t\t\t\t\t\t\t'recursive' => -1,\n\t\t\t\t\t\t\t'conditions' => array('LOWER(name) LIKE' => '%' . strtolower($v) . '%'),\n\t\t\t\t\t));\n\t\t\t\t\tforeach ($found_orgs as $o) $subcondition['OR'][] = array('Event.orgc_id' => $o['Org']['id']);\n\t\t\t\t} else if ($parameterKey === 'eventid') {\n\t\t\t\t\tif (!empty($v)) $subcondition['OR'][] = array('Attribute.event_id' => $v);\n\t\t\t\t} else if ($parameterKey === 'uuid') {\n\t\t\t\t\t$subcondition['OR'][] = array('Attribute.uuid' => $v);\n\t\t\t\t\t$subcondition['OR'][] = array('Event.uuid' => $v);\n\t\t\t\t} else {\n\t\t\t\t\tif (!empty($v)) $subcondition['OR'][] = array('Attribute.' . $parameterKey . ' LIKE' => '%'.$v.'%');\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tarray_push ($conditions['AND'], $subcondition);\n\t\treturn $conditions;\n\t}\n\n\tprivate function __getCIDRList() {\n\t\treturn $this->find('list', array(\n\t\t\t'conditions' => array(\n\t\t\t\t'type' => array('ip-src', 'ip-dst'),\n\t\t\t\t'value1 LIKE' => '%/%'\n\t\t\t),\n\t\t\t'fields' => array('value1'),\n\t\t\t'order' => false\n\t\t));\n\t}\n\n\tpublic function setCIDRList() {\n\t\t$redis = $this->setupRedis();\n\t\t$cidrList = array();\n\t\tif ($redis) {\n\t\t\t$redis->del('misp:cidr_cache_list');\n\t\t\t$cidrList = $this->__getCIDRList();\n\t\t\t$pipeline = $redis->multi(Redis::PIPELINE);\n\t\t\tforeach ($cidrList as $cidr) {\n\t\t\t\t$pipeline->sadd('misp:cidr_cache_list', $cidr);\n\t\t\t}\n\t\t\t$pipeline->exec();\n\t\t\t$redis->smembers('misp:cidr_cache_list');\n\t\t}\n\t\treturn $cidrList;\n\t}\n\n\tpublic function getSetCIDRList() {\n\t\t$redis = $this->setupRedis();\n\t\tif ($redis) {\n\t\t\tif (!$redis->exists('misp:cidr_cache_list') || $redis->sCard('misp:cidr_cache_list') == 0) {\n\t\t\t\t$cidrList = $this->setCIDRList($redis);\n\t\t\t} else {\n\t\t\t\t$cidrList = $redis->smembers('misp:cidr_cache_list');\n\t\t\t}\n\t\t} else {\n\t\t\t$cidrList = $this->__getCIDRList();\n\t\t}\n\t\treturn $cidrList;\n\t}\n\n\tpublic function fetchDistributionData($user) {\n\t\t$initialDistribution = 5;\n\t\tif (Configure::read('MISP.default_attribute_distribution') != null) {\n\t\t\tif (Configure::read('MISP.default_attribute_distribution') === 'event') {\n\t\t\t\t$initialDistribution = 5;\n\t\t\t} else {\n\t\t\t\t$initialDistribution = Configure::read('MISP.default_attribute_distribution');\n\t\t\t}\n\t\t}\n\t\t$sgs = $this->SharingGroup->fetchAllAuthorised($user, 'name', 1);\n\t\t$this->set('sharingGroups', $sgs);\n\t\t$distributionLevels = $this->distributionLevels;\n\t\tif (empty($sgs)) {\n\t\t\tunset($distributionLevels[4]);\n\t\t}\n\t\treturn array('sgs' => $sgs, 'levels' => $distributionLevels, 'initial' => $initialDistribution);\n\t}\n\n\tpublic function simpleAddMalwareSample($event_id, $attribute_settings, $filename, $tmpfile) {\n\t\t$attributes = array(\n\t\t\t'malware-sample' => array('type' => 'malware-sample', 'data' => 1, 'category' => '', 'to_ids' => 1, 'disable_correlation' => 0, 'object_relation' => 'malware-sample'),\n\t\t\t'filename' => array('type' => 'filename', 'category' => '', 'to_ids' => 0, 'disable_correlation' => 0, 'object_relation' => 'filename'),\n\t\t\t'md5' => array('type' => 'md5', 'category' => '', 'to_ids' => 1, 'disable_correlation' => 0, 'object_relation' => 'md5'),\n\t\t\t'sha1' => array('type' => 'sha1', 'category' => '', 'to_ids' => 1, 'disable_correlation' => 0, 'object_relation' => 'sha1'),\n\t\t\t'sha256' => array('type' => 'sha256', 'category' => '', 'to_ids' => 1, 'disable_correlation' => 0, 'object_relation' => 'sha256'),\n\t\t\t'size-in-bytes' => array('type' => 'size-in-bytes', 'category' => 'Other', 'to_ids' => 0, 'disable_correlation' => 1, 'object_relation' => 'size-in-bytes')\n\t\t);\n\t\t$hashes = array('md5', 'sha1', 'sha256');\n\t\t$this->Object = ClassRegistry::init('Object');\n\t\t$this->ObjectTemplate = ClassRegistry::init('ObjectTemplate');\n\t\t$current = $this->ObjectTemplate->find('first', array(\n\t\t\t'fields' => array('MAX(version) AS version', 'uuid'),\n\t\t\t'conditions' => array('uuid' => '688c46fb-5edb-40a3-8273-1af7923e2215'),\n\t\t\t'recursive' => -1,\n\t\t\t'group' => array('uuid')\n\t\t));\n\t\tif (!empty($current)) {\n\t\t\t$object_template = $this->ObjectTemplate->find('first', array(\n\t\t\t\t'conditions' => array(\n\t\t\t\t\t'ObjectTemplate.uuid' => '688c46fb-5edb-40a3-8273-1af7923e2215',\n\t\t\t\t\t'ObjectTemplate.version' => $current[0]['version']\n\t\t\t\t),\n\t\t\t\t'recursive' => -1\n\t\t\t));\n\t\t}\n\t\tif (empty($object_template)) {\n\t\t\t$object_template = array(\n\t\t\t\t'ObjectTemplate' => array(\n\t\t\t\t\t'meta-category' => 'file',\n\t\t\t\t\t'name' => 'file',\n\t\t\t\t\t'uuid' => '688c46fb-5edb-40a3-8273-1af7923e2215',\n\t\t\t\t\t'version' => 1,\n\t\t\t\t\t'description' => 'File object describing a file with meta-information'\n\t\t\t\t)\n\t\t\t);\n\t\t}\n\t\t$object = array(\n\t\t\t'distribution' => $attribute_settings['distribution'],\n\t\t\t'sharing_group_id' => isset($attribute_settings['sharing_group_id']) ? $attribute_settings['sharing_group_id'] : 0,\n\t\t\t'meta-category' => $object_template['ObjectTemplate']['meta-category'],\n\t\t\t'name' => $object_template['ObjectTemplate']['name'],\n\t\t\t'template_version' => $object_template['ObjectTemplate']['version'],\n\t\t\t'description' => $object_template['ObjectTemplate']['description'],\n\t\t\t'template_uuid' => $object_template['ObjectTemplate']['uuid'],\n\t\t\t'event_id' => $event_id,\n\t\t\t'comment' => !empty($attribute_settings['comment']) ? $attribute_settings['comment'] : ''\n\t\t);\n\t\t$result = $this->Event->Attribute->handleMaliciousBase64($event_id, $filename, base64_encode($tmpfile->read()), $hashes);\n\t\tforeach ($attributes as $k => $v) {\n\t\t\t$attribute = array(\n\t\t\t\t'distribution' => 5,\n\t\t\t\t'category' => empty($v['category']) ? $attribute_settings['category'] : $v['category'],\n\t\t\t\t'type' => $v['type'],\n\t\t\t\t'to_ids' => $v['to_ids'],\n\t\t\t\t'disable_correlation' => $v['disable_correlation'],\n\t\t\t\t'object_id' => $this->Object->id,\n\t\t\t\t'event_id' => $event_id,\n\t\t\t\t'object_relation' => $v['object_relation']\n\t\t\t);\n\t\t\tif (isset($v['data'])) {\n\t\t\t\t$attribute['data'] = $result['data'];\n\t\t\t}\n\t\t\tif ($k == 'malware-sample') {\n\t\t\t\t$attribute['value'] = $filename . '|' . $result['md5'];\n\t\t\t} else if ($k == 'size-in-bytes') {\n\t\t\t\t$attribute['value'] = $tmpfile->size();\n\t\t\t} else if ($k == 'filename') {\n\t\t\t\t$attribute['value'] = $filename;\n\t\t\t} else {\n\t\t\t\t$attribute['value'] = $result[$v['type']];\n\t\t\t}\n\t\t\t$object['Attribute'][] = $attribute;\n\t\t}\n\t\treturn array('Object' => array($object));\n\t}\n\n\tpublic function advancedAddMalwareSample($event_id, $attribute_settings, $filename, $tmpfile) {\n\t\t$execRetval = '';\n\t\t$execOutput = array();\n\t\t$result = shell_exec('python ' . APP . 'files/scripts/generate_file_objects.py -p ' . $tmpfile->path);\n\t\tif (!empty($result)) {\n\t\t\t$result = json_decode($result, true);\n\t\t\tif (isset($result['objects'])) {\n\t\t\t\t$result['Object'] = $result['objects'];\n\t\t\t\tunset($result['objects']);\n\t\t\t}\n\t\t\tif (isset($result['references'])) {\n\t\t\t\t$result['ObjectReference'] = $result['references'];\n\t\t\t\tunset($result['references']);\n\t\t\t}\n\t\t\tforeach ($result['Object'] as $k => $object) {\n\t\t\t\t$result['Object'][$k]['distribution'] = $attribute_settings['distribution'];\n\t\t\t\t$result['Object'][$k]['sharing_group_id'] = isset($attribute_settings['distribution']) ? $attribute_settings['distribution'] : 0;\n\t\t\t\tif (!empty($result['Object'][$k]['Attribute'])) {\n\t\t\t\t\tforeach ($result['Object'][$k]['Attribute'] as $k2 => $attribute) {\n\t\t\t\t\t\tif ($attribute['value'] == $tmpfile->name) {\n\t\t\t\t\t\t\t$result['Object'][$k]['Attribute'][$k2]['value'] = $filename;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!empty($attribute['encrypt'])) {\n\t\t\t\t\t\t\tif (!empty($attribute['encrypt']) && $attribute['encrypt']) {\n\t\t\t\t\t\t\t\t$encrypted = $this->handleMaliciousBase64($event_id, $filename, $attribute['data'], array('md5'));\n\t\t\t\t\t\t\t\t$result['Object'][$k]['Attribute'][$k2]['data'] = $encrypted['data'];\n\t\t\t\t\t\t\t\t$result['Object'][$k]['Attribute'][$k2]['value'] = $filename . '|' . $encrypted['md5'];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\t$result = $this->simpleAddMalwareSample($event_id, $attribute_settings, $filename, $tmpfile);\n\t\t}\n\t\treturn $result;\n\t}\n\n\t// gets an attribute, saves it\n\t// handles encryption, attaching to event/object, logging of issues, tag capturing\n\tpublic function captureAttribute($attribute, $eventId, $user, $objectId = false, $log = false) {\n\t\tif ($log == false) {\n\t\t\t$log = ClassRegistry::init('Log');\n\t\t}\n\t\t$attribute['event_id'] = $eventId;\n\t\t$attribute['object_id'] = $objectId ? $objectId : 0;\n\t\tunset($attribute['id']);\n\t\tif (isset($attribute['encrypt'])) {\n\t\t\t$result = $this->handleMaliciousBase64($eventId, $attribute['value'], $attribute['data'], array('md5'));\n\t\t}\n\t\t$fieldList = array(\n\t\t\t'event_id',\n\t\t\t'category',\n\t\t\t'type',\n\t\t\t'value',\n\t\t\t'value1',\n\t\t\t'value2',\n\t\t\t'to_ids',\n\t\t\t'uuid',\n\t\t\t'timestamp',\n\t\t\t'distribution',\n\t\t\t'comment',\n\t\t\t'sharing_group_id',\n\t\t\t'deleted',\n\t\t\t'disable_correlation',\n\t\t\t'object_id',\n\t\t\t'object_relation'\n\t\t);\n\t\t$this->create();\n\t\tif (!$this->save($attribute, array('fieldList' => $fieldList))) {\n\t\t\t$attribute_short = (isset($attribute['category']) ? $attribute['category'] : 'N/A') . '/' . (isset($attribute['type']) ? $attribute['type'] : 'N/A') . ' ' . (isset($attribute['value']) ? $attribute['value'] : 'N/A');\n\t\t\t$log->create();\n\t\t\t$log->save(array(\n\t\t\t\t\t'org' => $user['Organisation']['name'],\n\t\t\t\t\t'model' => 'Attribute',\n\t\t\t\t\t'model_id' => 0,\n\t\t\t\t\t'email' => $user['email'],\n\t\t\t\t\t'action' => 'add',\n\t\t\t\t\t'user_id' => $user['id'],\n\t\t\t\t\t'title' => 'Attribute dropped due to validation for Event ' . $eventId . ' failed: ' . $attribute_short,\n\t\t\t\t\t'change' => 'Validation errors: ' . json_encode($this->validationErrors) . ' Full Attribute: ' . json_encode($attribute),\n\t\t\t));\n\t\t\t} else {\n\t\t\t\tif (isset($attribute['AttributeTag'])) {\n\t\t\t\t\tforeach ($attribute['AttributeTag'] as $at) {\n\t\t\t\t\t\tunset($at['id']);\n\t\t\t\t\t\t$this->AttributeTag->create();\n\t\t\t\t\t\t$at['attribute_id'] = $this->id;\n\t\t\t\t\t\t$at['event_id'] = $eventId;\n\t\t\t\t\t\t$this->AttributeTag->save($at);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (!empty($attribute['Sighting'])) {\n\t\t\t\t\tforeach ($attribute['Sighting'] as $k => $sighting) {\n\t\t\t\t\t\t$this->Sighting->captureSighting($sighting, $this->id, $eventId, $user);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\treturn $attribute;\n\t}\n\n\tpublic function editAttribute($attribute, $eventId, $user, $objectId, $log = false) {\n\t\t$attribute['event_id'] = $eventId;\n\t\t$attribute['object_id'] = $objectId;\n\t\tif (isset($attribute['encrypt'])) {\n\t\t\t$result = $this->handleMaliciousBase64($eventId, $attribute['value'], $attribute['data'], array('md5'));\n\t\t\t$attribute['data'] = $result['data'];\n\t\t\t$attribute['value'] = $attribute['value'] . '|' . $result['md5'];\n\t\t}\n\t\tunset($attribute['id']);\n\t\tif (isset($attribute['uuid'])) {\n\t\t\t$existingAttribute = $this->find('first', array(\n\t\t\t\t'conditions' => array('Attribute.uuid' => $attribute['uuid']),\n\t\t\t\t'recursive' => -1\n\t\t\t));\n\t\t\t$this->Log = ClassRegistry::init('Log');\n\t\t\tif (count($existingAttribute)) {\n\t\t\t\tif ($existingAttribute['Attribute']['event_id'] != $eventId || $existingAttribute['Attribute']['object_id'] != $objectId) {\n\t\t\t\t\t$this->Log->create();\n\t\t\t\t\t$result = $this->Log->save(array(\n\t\t\t\t\t\t\t'org' => $user['Organisation']['name'],\n\t\t\t\t\t\t\t'model' => 'Attribute',\n\t\t\t\t\t\t\t'model_id' => 0,\n\t\t\t\t\t\t\t'email' => $user['email'],\n\t\t\t\t\t\t\t'action' => 'edit',\n\t\t\t\t\t\t\t'user_id' => $user['id'],\n\t\t\t\t\t\t\t'title' => 'Duplicate UUID found in attribute',\n\t\t\t\t\t\t\t'change' => 'An attribute was blocked from being saved due to a duplicate UUID. The uuid in question is: ' . $attribute['uuid'] . '. This can also be due to the same attribute (or an attribute with the same UUID) existing in a different event / object)',\n\t\t\t\t\t));\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\t// If a field is not set in the request, just reuse the old value\n\t\t\t\t$recoverFields = array('value', 'to_ids', 'distribution', 'category', 'type', 'comment', 'sharing_group_id', 'object_id', 'object_relation');\n\t\t\t\tforeach ($recoverFields as $rF) if (!isset($attribute[$rF])) $attribute[$rF] = $existingAttribute['Attribute'][$rF];\n\t\t\t\t$attribute['id'] = $existingAttribute['Attribute']['id'];\n\t\t\t\t// Check if the attribute's timestamp is bigger than the one that already exists.\n\t\t\t\t// If yes, it means that it's newer, so insert it. If no, it means that it's the same attribute or older - don't insert it, insert the old attribute.\n\t\t\t\t// Alternatively, we could unset this attribute from the request, but that could lead with issues if we decide that we want to start deleting attributes that don't exist in a pushed event.\n\t\t\t\tif (isset($attribute['timestamp'])) {\n\t\t\t\t\tif ($attribute['timestamp'] <= $existingAttribute['Attribute']['timestamp']) {\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t$date = new DateTime();\n\t\t\t\t\t$attribute['timestamp'] = $date->getTimestamp();;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t$this->create();\n\t\t\t}\n\t\t} else {\n\t\t\t$this->create();\n\t\t}\n\t$attribute['event_id'] = $eventId;\n\t\tif (isset($attribute['distribution']) && $attribute['distribution'] == 4) {\n\t\t\tif (!empty($attribute['SharingGroup'])) {\n\t\t\t\t$attribute['sharing_group_id'] = $this->SharingGroup->captureSG($attribute['SharingGroup'], $user);\n\t\t\t} elseif (!empty($attribute['sharing_group_id'])) {\n\t\t\t\tif (!$this->SharingGroup->checkIfAuthorised($user, $attribute['sharing_group_id'])) {\n\t\t\t\t\tunset($attribute['sharing_group_id']);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (empty($attribute['sharing_group_id'])) {\n\t\t\t\t$attribute_short = (isset($attribute['category']) ? $attribute['category'] : 'N/A') . '/' . (isset($attribute['type']) ? $attribute['type'] : 'N/A') . ' ' . (isset($attribute['value']) ? $attribute['value'] : 'N/A');\n\t\t\t\t$this->Log = ClassRegistry::init('Log');\n\t\t\t\t$this->Log->create();\n\t\t\t\t$this->Log->save(array(\n\t\t\t\t\t'org' => $user['Organisation']['name'],\n\t\t\t\t\t'model' => 'Attribute',\n\t\t\t\t\t'model_id' => 0,\n\t\t\t\t\t'email' => $user['email'],\n\t\t\t\t\t'action' => 'edit',\n\t\t\t\t\t'user_id' => $user['id'],\n\t\t\t\t\t'title' => 'Attribute dropped due to invalid sharing group for Event ' . $eventId . ' failed: ' . $attribute_short,\n\t\t\t\t\t'change' => 'Validation errors: ' . json_encode($this->validationErrors) . ' Full Attribute: ' . json_encode($attribute),\n\t\t\t\t));\n\t\t\t\treturn 'Invalid sharing group choice.';\n\t\t\t}\n\t\t}\n\t\t$fieldList = array(\n\t\t\t'event_id',\n\t\t\t'category',\n\t\t\t'type',\n\t\t\t'value',\n\t\t\t'value1',\n\t\t\t'value2',\n\t\t\t'to_ids',\n\t\t\t'uuid',\n\t\t\t'revision',\n\t\t\t'distribution',\n\t\t\t'timestamp',\n\t\t\t'comment',\n\t\t\t'sharing_group_id',\n\t\t\t'deleted',\n\t\t\t'disable_correlation'\n\t\t);\n\t\tif ($objectId) {\n\t\t\t$fieldList[] = 'object_id';\n\t\t\t$fieldList[] = 'object_relation';\n\t\t}\n\t\tif (!$this->save(array('Attribute' => $attribute), array('fieldList' => $fieldList))) {\n\t\t\t$attribute_short = (isset($attribute['category']) ? $attribute['category'] : 'N/A') . '/' . (isset($attribute['type']) ? $attribute['type'] : 'N/A') . ' ' . (isset($attribute['value']) ? $attribute['value'] : 'N/A');\n\t\t\t$this->Log = ClassRegistry::init('Log');\n\t\t\t$this->Log->create();\n\t\t\t$this->Log->save(array(\n\t\t\t\t'org' => $user['Organisation']['name'],\n\t\t\t\t'model' => 'Attribute',\n\t\t\t\t'model_id' => 0,\n\t\t\t\t'email' => $user['email'],\n\t\t\t\t'action' => 'edit',\n\t\t\t\t'user_id' => $user['id'],\n\t\t\t\t'title' => 'Attribute dropped due to validation for Event ' . $eventId . ' failed: ' . $attribute_short,\n\t\t\t\t'change' => 'Validation errors: ' . json_encode($this->validationErrors) . ' Full Attribute: ' . json_encode($attribute),\n\t\t\t));\n\t\t\treturn $this->validationErrors;\n\t\t} else {\n\t\t\tif (isset($attribute['Tag']) && $user['Role']['perm_tagger']) {\n\t\t\t\tforeach ($attribute['Tag'] as $tag) {\n\t\t\t\t\t$tag_id = $this->AttributeTag->Tag->captureTag($tag, $user);\n\t\t\t\t\tif ($tag_id) {\n\t\t\t\t\t\t// fix the IDs here\n\t\t\t\t\t\t$this->AttributeTag->attachTagToAttribute($this->id, $this->id, $tag_id);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// If we couldn't attach the tag it is most likely because we couldn't create it - which could have many reasons\n\t\t\t\t\t\t// However, if a tag couldn't be added, it could also be that the user is a tagger but not a tag editor\n\t\t\t\t\t\t// In which case if no matching tag is found, no tag ID is returned. Logging these is pointless as it is the correct behaviour.\n\t\t\t\t\t\tif ($user['Role']['perm_tag_editor']) {\n\t\t\t\t\t\t\t$this->Log->create();\n\t\t\t\t\t\t\t$this->Log->save(array(\n\t\t\t\t\t\t\t\t'org' => $user['Organisation']['name'],\n\t\t\t\t\t\t\t\t'model' => 'Attrubute',\n\t\t\t\t\t\t\t\t'model_id' => $this->id,\n\t\t\t\t\t\t\t\t'email' => $user['email'],\n\t\t\t\t\t\t\t\t'action' => 'edit',\n\t\t\t\t\t\t\t\t'user_id' => $user['id'],\n\t\t\t\t\t\t\t\t'title' => 'Failed create or attach Tag ' . $tag['name'] . ' to the attribute.',\n\t\t\t\t\t\t\t\t'change' => ''\n\t\t\t\t\t\t\t));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n}\n"], "filenames": ["app/Model/Attribute.php"], "buggy_code_start_loc": [3130], "buggy_code_end_loc": [3130], "fixing_code_start_loc": [3131], "fixing_code_end_loc": [3132], "type": "CWE-749", "message": "An issue was discovered in app/Model/Attribute.php in MISP before 2.4.89. There is a critical API integrity bug, potentially allowing users to delete attributes of other events. A crafted edit for an event (without attribute UUIDs but attribute IDs set) could overwrite an existing attribute.", "other": {"cve": {"id": "CVE-2018-8949", "sourceIdentifier": "cve@mitre.org", "published": "2018-03-23T17:29:00.337", "lastModified": "2018-04-19T19:21:33.387", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "An issue was discovered in app/Model/Attribute.php in MISP before 2.4.89. There is a critical API integrity bug, potentially allowing users to delete attributes of other events. A crafted edit for an event (without attribute UUIDs but attribute IDs set) could overwrite an existing attribute."}, {"lang": "es", "value": "Se ha descubierto un problema en app/Model/Attribute.php, en versiones anteriores a la 2.4.89 de MISP. Existe un error cr\u00edtico de integridad de API que podr\u00eda permitir a los usuarios eliminar atributos de otros eventos. La edici\u00f3n manipulada de un evento (con un conjunto de ID de atributos en lugar de UUID de atributos) podr\u00eda sobrescribir un atributo existente."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "NONE", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 4.3, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 1.4}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:S/C:N/I:P/A:P", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "SINGLE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "PARTIAL", "baseScore": 5.5}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.0, "impactScore": 4.9, "acInsufInfo": true, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-749"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:misp-project:misp:*:*:*:*:*:*:*:*", "versionEndExcluding": "2.4.89", "matchCriteriaId": "AE728CC9-A690-4960-B9D6-B3AD09424F7B"}]}]}], "references": [{"url": "https://github.com/MISP/MISP/commit/37720c38d6c617439df0a13e9396fcb26345dadd", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/MISP/MISP/commit/37720c38d6c617439df0a13e9396fcb26345dadd"}}