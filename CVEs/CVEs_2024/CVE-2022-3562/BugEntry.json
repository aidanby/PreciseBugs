{"buggy_code": ["<?php\n\nuse LibreNMS\\Util\\Number;\n\n$bill_id = $vars['bill_id'];\n\nif (Auth::user()->hasGlobalAdmin()) {\n    include 'includes/html/pages/bill/actions.inc.php';\n}\n\nif (bill_permitted($bill_id)) {\n    $bill_data = dbFetchRow('SELECT * FROM bills WHERE bill_id = ?', [$bill_id]);\n\n    $bill_name = $bill_data['bill_name'];\n\n    $today = str_replace('-', '', dbFetchCell('SELECT CURDATE()'));\n    $yesterday = str_replace('-', '', dbFetchCell('SELECT DATE_SUB(CURDATE(), INTERVAL 1 DAY)'));\n    $tomorrow = str_replace('-', '', dbFetchCell('SELECT DATE_ADD(CURDATE(), INTERVAL 1 DAY)'));\n    $last_month = str_replace('-', '', dbFetchCell('SELECT DATE_SUB(CURDATE(), INTERVAL 1 MONTH)'));\n\n    $rightnow = $today . date('His');\n    $before = $yesterday . date('His');\n    $lastmonth = $last_month . date('His');\n\n    $bill_name = $bill_data['bill_name'];\n    $dayofmonth = $bill_data['bill_day'];\n\n    $day_data = getDates($dayofmonth);\n\n    $datefrom = $day_data['0'];\n    $dateto = $day_data['1'];\n    $lastfrom = $day_data['2'];\n    $lastto = $day_data['3'];\n\n    $rate_95th = $bill_data['rate_95th'];\n    $dir_95th = $bill_data['dir_95th'];\n    $total_data = $bill_data['total_data'];\n    $rate_average = $bill_data['rate_average'];\n\n    if ($rate_95th > $paid_kb) {\n        $over = ($rate_95th - $paid_kb);\n        $bill_text = $over . 'Kbit excess.';\n        $bill_color = '#cc0000';\n    } else {\n        $under = ($paid_kb - $rate_95th);\n        $bill_text = $under . 'Kbit headroom.';\n        $bill_color = '#0000cc';\n    }\n\n    $fromtext = dbFetchCell(\"SELECT DATE_FORMAT($datefrom, '\" . \\LibreNMS\\Config::get('dateformat.mysql.date') . \"')\");\n    $totext = dbFetchCell(\"SELECT DATE_FORMAT($dateto, '\" . \\LibreNMS\\Config::get('dateformat.mysql.date') . \"')\");\n    $unixfrom = dbFetchCell(\"SELECT UNIX_TIMESTAMP('$datefrom')\");\n    $unixto = dbFetchCell(\"SELECT UNIX_TIMESTAMP('$dateto')\");\n\n    $unix_prev_from = dbFetchCell(\"SELECT UNIX_TIMESTAMP('$lastfrom')\");\n    $unix_prev_to = dbFetchCell(\"SELECT UNIX_TIMESTAMP('$lastto')\");\n    // Speeds up loading for other included pages by setting it before progessing of mysql data!\n    $ports = dbFetchRows(\n        'SELECT * FROM `bill_ports` AS B, `ports` AS P, `devices` AS D\n        WHERE B.bill_id = ? AND P.port_id = B.port_id\n        AND D.device_id = P.device_id',\n        [$bill_id]\n    );\n\n    if (! $vars['view']) {\n        $vars['view'] = 'quick';\n    }\n\n    function print_port_list($ports)\n    {\n        echo '<div class=\"panel panel-default\">\n            <div class=\"panel-heading\">\n                <h3 class=\"panel-title\">Billed Ports</h3>\n            </div>\n            <div class=\"list-group\">';\n\n        // Collected Earlier\n        foreach ($ports as $port) {\n            $port = cleanPort($port);\n            $portalias = (empty($port['ifAlias']) ? '' : ' - ' . $port['ifAlias'] . '');\n\n            echo '<div class=\"list-group-item\">';\n            echo generate_port_link($port, $port['ifName'] . $portalias) . ' on ' . generate_device_link($port);\n            echo '</div>';\n        }\n\n        echo '</div></div>';\n    }//end print_port_list?>\n\n    <h2><?php   echo \"Bill: ${bill_data['bill_name']}\"; ?></h2>\n\n    <?php\n    print_optionbar_start();\n    echo '<strong>Bill</strong> &raquo; ';\n    $menu_options = [\n        'quick' => 'Quick Graphs',\n        'accurate' => 'Accurate Graphs',\n        'transfer' => 'Transfer Graphs',\n        'history' => 'Historical Graphs',\n    ];\n    if (Auth::user()->hasGlobalAdmin()) {\n        $menu_options['edit'] = 'Edit';\n        $menu_options['delete'] = 'Delete';\n        $menu_options['reset'] = 'Reset';\n    }\n    $sep = '';\n    foreach ($menu_options as $option => $text) {\n        echo $sep;\n        if ($vars['view'] == $option) {\n            echo \"<span class='pagemenu-selected'>\";\n        }\n\n        echo generate_link($text, $vars, ['view' => $option]);\n        if ($vars['view'] == $option) {\n            echo '</span>';\n        }\n\n        $sep = ' | ';\n    }\n\n    echo '<div style=\"font-weight: bold; float: right;\"><a href=\"' . \\LibreNMS\\Util\\Url::generate(['page' => 'bills']) . '/\"><i class=\"fa fa-arrow-left fa-lg icon-theme\" aria-hidden=\"true\"></i> Back to Bills</a></div>';\n\n    print_optionbar_end();\n\n    if ($vars['view'] == 'edit' && Auth::user()->hasGlobalAdmin()) {\n        include 'includes/html/pages/bill/edit.inc.php';\n    } elseif ($vars['view'] == 'delete' && Auth::user()->hasGlobalAdmin()) {\n        include 'includes/html/pages/bill/delete.inc.php';\n    } elseif ($vars['view'] == 'reset' && Auth::user()->hasGlobalAdmin()) {\n        include 'includes/html/pages/bill/reset.inc.php';\n    } elseif ($vars['view'] == 'history') {\n        include 'includes/html/pages/bill/history.inc.php';\n    } elseif ($vars['view'] == 'transfer') {\n        include 'includes/html/pages/bill/transfer.inc.php';\n    } elseif ($vars['view'] == 'quick' || $vars['view'] == 'accurate') {\n        ?>\n\n        <?php   if ($bill_data['bill_type'] == 'quota') { ?>\n    <h3>Quota Bill</h3>\n        <?php   } elseif ($bill_data['bill_type'] == 'cdr') {  ?>\n    <h3>\n        CDR / 95th Bill\n    </h3>\n        <?php           } ?>\n<strong>Billing Period from <?php echo $fromtext ?> to <?php echo $totext ?></strong>\n<br /><br />\n\n<div class=\"row\">\n<div class=\"col-lg-6 col-lg-push-6\">\n        <?php print_port_list($ports) ?>\n</div>\n<div class=\"col-lg-6 col-lg-pull-6\">\n<div class=\"panel panel-default\">\n    <div class=\"panel-heading\">\n        <h3 class=\"panel-title\">\n            Bill Summary\n        </h3>\n    </div>\n    <table class=\"table\">\n    <tr>\n        <?php   if ($bill_data['bill_type'] == 'quota') {\n            // The Customer is billed based on a pre-paid quota with overage in xB\n            $percent = Number::calculatePercent($total_data, $bill_data['bill_quota']);\n            $unit = 'MB';\n            $total_data = round($total_data, 2);\n            $background = \\LibreNMS\\Util\\Color::percentage($percent, null);\n            $type = '&amp;ave=yes'; ?>\n        <td>\n            <?php echo format_bytes_billing($total_data) ?> of <?php echo format_bytes_billing($bill_data['bill_quota']) . ' (' . $percent . '%)' ?>\n            - Average rate <?php echo Number::formatSi($rate_average, 2, 3, 'bps') ?>\n        </td>\n        <td style=\"width: 210px;\"><?php echo print_percentage_bar(200, 20, $percent, null, 'ffffff', $background['left'], $percent . '%', 'ffffff', $background['right']) ?></td>\n        </tr>\n        <tr>\n            <td colspan=\"2\">\n            <?php\n            echo 'Predicted usage: ' . format_bytes_billing(getPredictedUsage($bill_data['bill_day'], $bill_data['total_data'])); ?>\n            </td>\n            <?php\n        } elseif ($bill_data['bill_type'] == 'cdr') {\n            // The customer is billed based on a CDR with 95th%ile overage\n            $unit = 'kbps';\n            $cdr = $bill_data['bill_cdr'];\n            $rate_95th = round($rate_95th, 2);\n            $percent = Number::calculatePercent($rate_95th, $cdr);\n            $background = \\LibreNMS\\Util\\Color::percentage($percent, null);\n            $type = '&amp;95th=yes'; ?>\n        <td>\n            <?php echo Number::formatSi($rate_95th, 2, 3, '') . 'bps' ?> of <?php echo Number::formatSi($cdr, 2, 3, '') . 'bps (' . $percent . '%)' ?> (95th%ile)\n        </td>\n        <td style=\"width: 210px;\">\n            <?php echo print_percentage_bar(200, 20, $percent, null, 'ffffff', $background['left'], $percent . '%', 'ffffff', $background['right']) ?>\n        </td>\n        </tr>\n        <tr>\n            <td colspan=\"2\">\n            <?php\n                echo 'Predicted usage: ' . Number::formatSi(getPredictedUsage($bill_data['bill_day'], $bill_data['rate_95th']), 2, 3, '') . 'bps'; ?>\n            </td>\n\n        <?php\n        }//end if?>\n    </tr>\n    </table>\n</div>\n</div>\n</div>\n\n        <?php\n\n        $lastmonth = dbFetchCell('SELECT UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 1 MONTH))');\n        $yesterday = dbFetchCell('SELECT UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 1 DAY))');\n        $rightnow = date('U');\n\n        if ($vars['view'] == 'accurate') {\n            $bi = \"<img src='billing-graph.php?bill_id=\" . $bill_id . '&amp;bill_code=' . htmlspecialchars($_GET['bill_code']);\n            $bi .= '&amp;from=' . $unixfrom . '&amp;to=' . $unixto;\n            $bi .= '&amp;x=1190&amp;y=250';\n            $bi .= \"$type'>\";\n\n            $li = \"<img src='billing-graph.php?bill_id=\" . $bill_id . '&amp;bill_code=' . $_GET['bill_code'];\n            $li .= '&amp;from=' . $unix_prev_from . '&amp;to=' . $unix_prev_to;\n            $li .= '&amp;x=1190&amp;y=250';\n            $li .= \"$type'>\";\n\n            $di = \"<img src='billing-graph.php?bill_id=\" . $bill_id . '&amp;bill_code=' . htmlspecialchars($_GET['bill_code']);\n            $di .= '&amp;from=' . \\LibreNMS\\Config::get('time.day') . '&amp;to=' . \\LibreNMS\\Config::get('time.now');\n            $di .= '&amp;x=1190&amp;y=250';\n            $di .= \"$type'>\";\n\n            $mi = \"<img src='billing-graph.php?bill_id=\" . $bill_id . '&amp;bill_code=' . htmlspecialchars($_GET['bill_code']);\n            $mi .= '&amp;from=' . $lastmonth . '&amp;to=' . $rightnow;\n            $mi .= '&amp;x=1190&amp;y=250';\n            $mi .= \"$type'>\";\n        } else {\n            $bi = \"<img src='graph.php?type=bill_bits&amp;id=\" . $bill_id;\n            $bi .= '&amp;from=' . $unixfrom . '&amp;to=' . $unixto;\n            $bi .= '&amp;width=1000&amp;height=200&amp;total=1&amp;dir=' . $dir_95th . \"'>\";\n\n            $li = \"<img src='graph.php?type=bill_bits&amp;id=\" . $bill_id;\n            $li .= '&amp;from=' . $unix_prev_from . '&amp;to=' . $unix_prev_to;\n            $li .= '&amp;width=1000&amp;height=200&amp;total=1&amp;dir=' . $dir_95th . \"'>\";\n\n            $di = \"<img src='graph.php?type=bill_bits&amp;id=\" . $bill_id;\n            $di .= '&amp;from=' . \\LibreNMS\\Config::get('time.day') . '&amp;to=' . \\LibreNMS\\Config::get('time.now');\n            $di .= '&amp;width=1000&amp;height=200&amp;total=1&amp;dir=' . $dir_95th . \"'>\";\n\n            $mi = \"<img src='graph.php?type=bill_bits&amp;id=\" . $bill_id;\n            $mi .= '&amp;from=' . $lastmonth . '&amp;to=' . $rightnow;\n            $mi .= '&amp;width=1000&amp;height=200&amp;total=1&amp;dir=' . $dir_95th . \"'>\";\n        }//end if\n\n        ?>\n<div class=\"panel panel-default\">\n<div class=\"panel-heading\">\n    <h3 class=\"panel-title\">Billing View</h3>\n</div>\n        <?php echo $bi ?>\n</div>\n\n<div class=\"panel panel-default\">\n<div class=\"panel-heading\">\n    <h3 class=\"panel-title\">24 Hour View</h3>\n</div>\n        <?php echo $di ?>\n</div>\n\n<div class=\"panel panel-default\">\n<div class=\"panel-heading\">\n    <h3 class=\"panel-title\">Monthly View</h3>\n</div>\n        <?php echo $mi ?>\n</div>\n        <?php\n    } //end if\n} else {\n    include 'includes/html/error-no-perm.inc.php';\n}//end if\n?>\n", "<h4>Bill Information</h4>\n<div class=\"form-group\">\n  <label for=\"bill_name\" class=\"col-sm-4 control-label\">Description</label>\n  <div class=\"col-sm-8\">\n    <input class=\"form-control input-sm\" type=\"text\" id=\"bill_name\" name=\"bill_name\" value=\"<?php echo $bill_data['bill_name']; ?>\">\n  </div>\n</div>\n<div class=\"form-group\">\n  <label class=\"col-sm-4 control-label\" for=\"bill_type\">Billing Type</label>\n  <div class=\"col-sm-8\">\n    <label class=\"radio-inline\">\n      <input type=\"radio\" name=\"bill_type\" id=\"bill_type_cdr\" value=\"cdr\"\n            <?php\n            if ($bill_data['bill_type'] == 'cdr') {\n                echo 'checked';\n            }\n            ?> onchange=\"javascript: billType();\" /> CDR 95th\n    </label>\n    <label class=\"radio-inline\">\n      <input type=\"radio\" name=\"bill_type\" id=\"bill_type_quota\" value=\"quota\"\n            <?php\n            if ($bill_data['bill_type'] == 'quota') {\n                echo 'checked';\n            }\n            ?> onchange=\"javascript: billType();\" /> Quota\n    </label>\n  </div>\n</div>\n<div class=\"form-group\">\n  <div id=\"cdrDiv\">\n    <label class=\"col-sm-4 control-label\" for=\"bill_cdr\">CDR</label>\n    <div class=\"col-sm-3\">\n      <input class=\"form-control input-sm\" type=\"text\" name=\"bill_cdr\" value=\"<?php echo $cdr['data'] ?>\">\n    </div>\n    <div class=\"col-sm-5\">\n      <select name=\"bill_cdr_type\" class=\"form-control input-sm\">\n        <option <?php echo $cdr['select_kbps'] ?> value=\"Kbps\">Kilobits per second (Kbps)</option>\n        <option <?php echo $cdr['select_mbps'] ?> value=\"Mbps\">Megabits per second (Mbps)</option>\n        <option <?php echo $cdr['select_gbps'] ?> value=\"Gbps\">Gigabits per second (Gbps)</option>\n      </select>\n    </div>\n    <label class=\"col-sm-4 control-label\" for=\"dir_95th\">95th Calculation</label>\n    <div class=\"col-sm-8\">\n      <label class=\"radio-inline\">\n       <input type=\"radio\" name=\"dir_95th\" id=\"dir_95th_inout\" value=\"in\"\n            <?php\n            if ($bill_data['dir_95th'] == 'in' || $bill_data['dir_95th'] == 'out') {\n                echo 'checked';\n            }\n            ?> /> Max In/Out\n       </label>\n      <label class=\"radio-inline\">\n       <input type=\"radio\" name=\"dir_95th\" id=\"dir_95th_agg\" value=\"agg\"\n            <?php\n            if ($bill_data['dir_95th'] == 'agg') {\n                echo 'checked';\n            }\n            ?> /> Aggregate\n       </label>\n    </div>\n  </div>\n  <div id=\"quotaDiv\">\n    <label class=\"col-sm-4 control-label\" for=\"bill_quota\">Quota</label>\n    <div class=\"col-sm-3\">\n      <input class=\"form-control input-sm\" type=\"text\" name=\"bill_quota\" value=\"<?php echo $quota['data'] ?>\">\n    </div>\n    <div class=\"col-sm-5\">\n      <select name=\"bill_quota_type\" class=\"form-control input-sm\">\n        <option <?php echo $quota['select_mb'] ?> value=\"MB\">Megabytes (MB)</option>\n        <option <?php echo $quota['select_gb'] ?> value=\"GB\">Gigabytes (GB)</option>\n        <option <?php echo $quota['select_tb'] ?> value=\"TB\">Terabytes (TB)</option>\n      </select>\n    </div>\n  </div>\n</div>\n<div class=\"form-group\">\n  <label class=\"col-sm-4 control-label\" for=\"bill_day\">Billing Day</label>\n  <div class=\"col-sm-2\">\n    <select name=\"bill_day\" class=\"form-control input-sm\">\n    <?php\n    for ($x = 1; $x < 32; $x++) {\n        $sel = $bill_data['bill_day'] == $x ? 'selected ' : '';\n        echo \"<option $sel value='$x'>$x</option>\\n\";\n    }\n    ?>\n    </select>\n  </div>\n</div>\n<fieldset>\n    <h4>Optional Information</h4>\n    <div class=\"form-group\">\n      <label class=\"col-sm-4 control-label\" for=\"bill_custid\">Customer Reference</label>\n      <div class=\"col-sm-8\">\n        <input class=\"form-control input-sm\" type=\"text\" name=\"bill_custid\" value=\"<?php echo $bill_data['bill_custid'] ?>\">\n      </div>\n    </div>\n    <div class=\"form-group\">\n      <label class=\"col-sm-4 control-label\" for=\"bill_ref\">Billing Reference</label>\n      <div class=\"col-sm-8\">\n        <input class=\"form-control input-sm\" type=\"text\" name=\"bill_ref\" value=\"<?php echo $bill_data['bill_ref']; ?>\">\n      </div>\n    </div>\n    <div class=\"form-group\">\n      <label class=\"col-sm-4 control-label\" for=\"bill_notes\">Notes</label>\n      <div class=\"col-sm-8\">\n        <input class=\"form-control input-sm\" type=\"textarea\" name=\"bill_notes\" value=\"<?php echo $bill_data['bill_notes']; ?>\">\n      </div>\n    </div>\n</fieldset>\n\n<script type=\"text/javascript\">\nfunction billType() {\n    var selected = $('input[name=bill_type]:checked').val();\n\n    $('#cdrDiv').toggle(selected === 'cdr');\n    $('#quotaDiv').toggle(selected === 'quota');\n}\nbillType();\n</script>\n", "<?php\n\n// Calculate filters\nuse LibreNMS\\Util\\Number;\n\n$prev = ! empty($vars['period']) && ($vars['period'] == 'prev');\n$wheres = [];\n$param = [];\nif (isset($searchPhrase) && ! empty($searchPhrase)) {\n    $wheres[] = 'bills.bill_name LIKE ?';\n    $param[] = \"%$searchPhrase%\";\n}\nif (! empty($vars['bill_type'])) {\n    if ($prev) {\n        $wheres[] = 'bill_history.bill_type = ?';\n    } else {\n        $wheres[] = 'bill_type = ?';\n    }\n    $param[] = $vars['bill_type'];\n}\nif (! empty($vars['state'])) {\n    if ($vars['state'] === 'under') {\n        if ($prev) {\n            $wheres[] = \"((bill_history.bill_type = 'cdr' AND bill_history.rate_95th <= bill_history.bill_allowed) OR (bill_history.bill_type = 'quota' AND bill_history.traf_total <= bill_history.bill_allowed))\";\n        } else {\n            $wheres[] = \"((bill_type = 'cdr' AND rate_95th <= bill_cdr) OR (bill_type = 'quota' AND total_data <= bill_quota))\";\n        }\n    } elseif ($vars['state'] === 'over') {\n        if ($prev) {\n            $wheres[] = \"((bill_history.bill_type = 'cdr' AND bill_history.rate_95th > bill_history.bill_allowed) OR (bill_history.bill_type = 'quota' AND bill_history.traf_total > bill_allowed))\";\n        } else {\n            $wheres[] = \"((bill_type = 'cdr' AND rate_95th > bill_cdr) OR (bill_type = 'quota' AND total_data > bill_quota))\";\n        }\n    }\n}\n\nif ($prev) {\n    $select = 'SELECT bills.bill_name, bills.bill_notes, bill_history.*, bill_history.traf_total as total_data, bill_history.traf_in as total_data_in, bill_history.traf_out as total_data_out ';\n    $query = 'FROM `bills`\n        INNER JOIN (SELECT bill_id, MAX(bill_hist_id) AS bill_hist_id FROM bill_history WHERE bill_dateto < NOW() AND bill_dateto > subdate(NOW(), 40) GROUP BY bill_id) qLastBills ON bills.bill_id = qLastBills.bill_id\n        INNER JOIN bill_history ON qLastBills.bill_hist_id = bill_history.bill_hist_id\n';\n} else {\n    $select = \"SELECT bills.*,\n        IF(bills.bill_type = 'CDR', bill_cdr, bill_quota) AS bill_allowed\n    \";\n    $query = \"FROM `bills`\\n\";\n}\n\n// Permissions check\nif (! Auth::user()->hasGlobalRead()) {\n    $query .= ' INNER JOIN `bill_perms` AS `BP` ON `bills`.`bill_id` = `BP`.`bill_id` ';\n    $wheres[] = '`BP`.`user_id`=?';\n    $param[] = Auth::id();\n}\n\nif (sizeof($wheres) > 0) {\n    $query .= 'WHERE ' . implode(' AND ', $wheres) . \"\\n\";\n}\n$orderby = 'ORDER BY bills.bill_name';\n\n$total = dbFetchCell(\"SELECT COUNT(bills.bill_id) $query\", $param);\n\n$sql = \"$select\n$query\";\n\nif (! isset($sort) || empty($sort)) {\n    $sort = 'bills.bill_name';\n}\n\n$sql .= \"\\nORDER BY $sort\";\n\nif (isset($current)) {\n    $limit_low = (($current * $rowCount) - ($rowCount));\n    $limit_high = $rowCount;\n}\n\nif ($rowCount != -1) {\n    $sql .= \" LIMIT $limit_low,$limit_high\";\n}\n\nforeach (dbFetchRows($sql, $param) as $bill) {\n    if ($prev) {\n        $datefrom = $bill['bill_datefrom'];\n        $dateto = $bill['bill_dateto'];\n    } else {\n        $day_data = getDates($bill['bill_day']);\n        $datefrom = $day_data['0'];\n        $dateto = $day_data['1'];\n    }\n    $rate_95th = Number::formatSi($bill['rate_95th'], 2, 3, '') . 'bps';\n    $dir_95th = $bill['dir_95th'];\n    $total_data = format_bytes_billing($bill['total_data']);\n    $rate_average = $bill['rate_average'];\n    $url = \\LibreNMS\\Util\\Url::generate(['page' => 'bill', 'bill_id' => $bill['bill_id']]);\n    $used95th = Number::formatSi($bill['rate_95th'], 2, 3, '') . 'bps';\n    $notes = $bill['bill_notes'];\n\n    if ($prev) {\n        $percent = $bill['bill_percent'];\n        $overuse = $bill['bill_overuse'];\n    } else {\n    }\n\n    if (strtolower($bill['bill_type']) == 'cdr') {\n        $type = 'CDR';\n        $allowed = Number::formatSi($bill['bill_allowed'], 2, 3, '') . 'bps';\n        $in = Number::formatSi($bill['rate_95th_in'], 2, 3, '') . 'bps';\n        $out = Number::formatSi($bill['rate_95th_out'], 2, 3, '') . 'bps';\n        if (! $prev) {\n            $percent = Number::calculatePercent($bill['rate_95th'], $bill['bill_allowed']);\n            $overuse = ($bill['rate_95th'] - $bill['bill_allowed']);\n        }\n\n        $overuse_formatted = Number::formatSi($overuse, 2, 3, '') . 'bps';\n        $used = $rate_95th;\n        $tmp_used = $bill['rate_95th'];\n        $rate_95th = \"<b>$rate_95th</b>\";\n    } elseif (strtolower($bill['bill_type']) == 'quota') {\n        $type = 'Quota';\n        $allowed = format_bytes_billing($bill['bill_allowed']);\n        if (! empty($prev)) {\n            $in = format_bytes_billing($bill['traf_in']);\n            $out = format_bytes_billing($bill['traf_out']);\n        } else {\n            $in = format_bytes_billing($bill['total_data_in']);\n            $out = format_bytes_billing($bill['total_data_out']);\n        }\n        if (! $prev) {\n            $percent = Number::calculatePercent($bill['total_data'], $bill['bill_allowed']);\n            $overuse = ($bill['total_data'] - $bill['bill_allowed']);\n        }\n\n        $overuse_formatted = format_bytes_billing($overuse);\n        $used = $total_data;\n        $tmp_used = $bill['total_data'];\n        $total_data = \"<b>$total_data</b>\";\n    }\n\n    $background = \\LibreNMS\\Util\\Color::percentage($percent, null);\n    $right_background = $background['right'];\n    $left_background = $background['left'];\n    $overuse_formatted = (($overuse <= 0) ? '-' : \"<span style='color: #${background['left']}; font-weight: bold;'>$overuse_formatted</span>\");\n\n    $bill_name = \"<a href='$url'><span style='font-weight: bold;' class='interface'>${bill['bill_name']}</span></a><br />\" .\n                    date('Y-m-d', strtotime($datefrom)) . ' to ' . date('Y-m-d', strtotime($dateto));\n    $bar = print_percentage_bar(250, 20, $percent, null, 'ffffff', $background['left'], $percent . '%', 'ffffff', $background['right']);\n    $actions = '';\n\n    if (! $prev && Auth::user()->hasGlobalAdmin()) {\n        $actions .= \"<a href='\" . \\LibreNMS\\Util\\Url::generate(['page' => 'bill', 'bill_id' => $bill['bill_id'], 'view' => 'edit']) .\n            \"'><i class='fa fa-pencil fa-lg icon-theme' title='Edit' aria-hidden='true'></i> Edit</a> \";\n    }\n    if (strtolower($bill['bill_type']) == 'cdr') {\n        $predicted = Number::formatSi(getPredictedUsage($bill['bill_day'], $tmp_used), 2, 3, '') . 'bps';\n    } elseif (strtolower($bill['bill_type']) == 'quota') {\n        $predicted = format_bytes_billing(getPredictedUsage($bill['bill_day'], $tmp_used));\n    }\n\n    $response[] = [\n        'bill_name'     => $bill_name,\n        'notes'         => $notes,\n        'bill_type'     => $type,\n        'bill_allowed'    => $allowed,\n        'total_data_in' => $in,\n        'total_data_out'=> $out,\n        'total_data'    => $total_data,\n        'rate_95th'     => $rate_95th,\n        'used'          => $used,\n        'overusage'     => $overuse_formatted,\n        'predicted'     => $predicted,\n        'graph'         => $bar,\n        'actions'       => $actions,\n    ];\n}\n\n$output = ['current' => $current, 'rowCount' => $rowCount, 'rows' => $response, 'total' => $total];\necho json_encode($output, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE);\n"], "fixing_code": ["<?php\n\nuse LibreNMS\\Util\\Number;\n\n$bill_id = $vars['bill_id'];\n\nif (Auth::user()->hasGlobalAdmin()) {\n    include 'includes/html/pages/bill/actions.inc.php';\n}\n\nif (bill_permitted($bill_id)) {\n    $bill_data = dbFetchRow('SELECT * FROM bills WHERE bill_id = ?', [$bill_id]);\n\n    $bill_name = $bill_data['bill_name'];\n\n    $today = str_replace('-', '', dbFetchCell('SELECT CURDATE()'));\n    $yesterday = str_replace('-', '', dbFetchCell('SELECT DATE_SUB(CURDATE(), INTERVAL 1 DAY)'));\n    $tomorrow = str_replace('-', '', dbFetchCell('SELECT DATE_ADD(CURDATE(), INTERVAL 1 DAY)'));\n    $last_month = str_replace('-', '', dbFetchCell('SELECT DATE_SUB(CURDATE(), INTERVAL 1 MONTH)'));\n\n    $rightnow = $today . date('His');\n    $before = $yesterday . date('His');\n    $lastmonth = $last_month . date('His');\n\n    $bill_name = $bill_data['bill_name'];\n    $dayofmonth = $bill_data['bill_day'];\n\n    $day_data = getDates($dayofmonth);\n\n    $datefrom = $day_data['0'];\n    $dateto = $day_data['1'];\n    $lastfrom = $day_data['2'];\n    $lastto = $day_data['3'];\n\n    $rate_95th = $bill_data['rate_95th'];\n    $dir_95th = $bill_data['dir_95th'];\n    $total_data = $bill_data['total_data'];\n    $rate_average = $bill_data['rate_average'];\n\n    if ($rate_95th > $paid_kb) {\n        $over = ($rate_95th - $paid_kb);\n        $bill_text = $over . 'Kbit excess.';\n        $bill_color = '#cc0000';\n    } else {\n        $under = ($paid_kb - $rate_95th);\n        $bill_text = $under . 'Kbit headroom.';\n        $bill_color = '#0000cc';\n    }\n\n    $fromtext = dbFetchCell(\"SELECT DATE_FORMAT($datefrom, '\" . \\LibreNMS\\Config::get('dateformat.mysql.date') . \"')\");\n    $totext = dbFetchCell(\"SELECT DATE_FORMAT($dateto, '\" . \\LibreNMS\\Config::get('dateformat.mysql.date') . \"')\");\n    $unixfrom = dbFetchCell(\"SELECT UNIX_TIMESTAMP('$datefrom')\");\n    $unixto = dbFetchCell(\"SELECT UNIX_TIMESTAMP('$dateto')\");\n\n    $unix_prev_from = dbFetchCell(\"SELECT UNIX_TIMESTAMP('$lastfrom')\");\n    $unix_prev_to = dbFetchCell(\"SELECT UNIX_TIMESTAMP('$lastto')\");\n    // Speeds up loading for other included pages by setting it before progessing of mysql data!\n    $ports = dbFetchRows(\n        'SELECT * FROM `bill_ports` AS B, `ports` AS P, `devices` AS D\n        WHERE B.bill_id = ? AND P.port_id = B.port_id\n        AND D.device_id = P.device_id',\n        [$bill_id]\n    );\n\n    if (! $vars['view']) {\n        $vars['view'] = 'quick';\n    }\n\n    function print_port_list($ports)\n    {\n        echo '<div class=\"panel panel-default\">\n            <div class=\"panel-heading\">\n                <h3 class=\"panel-title\">Billed Ports</h3>\n            </div>\n            <div class=\"list-group\">';\n\n        // Collected Earlier\n        foreach ($ports as $port) {\n            $port = cleanPort($port);\n            $portalias = (empty($port['ifAlias']) ? '' : ' - ' . $port['ifAlias'] . '');\n\n            echo '<div class=\"list-group-item\">';\n            echo generate_port_link($port, $port['ifName'] . $portalias) . ' on ' . generate_device_link($port);\n            echo '</div>';\n        }\n\n        echo '</div></div>';\n    }//end print_port_list?>\n\n    <h2>Bill: <?php echo htmlentities($bill_data['bill_name']); ?></h2>\n\n    <?php\n    print_optionbar_start();\n    echo '<strong>Bill</strong> &raquo; ';\n    $menu_options = [\n        'quick' => 'Quick Graphs',\n        'accurate' => 'Accurate Graphs',\n        'transfer' => 'Transfer Graphs',\n        'history' => 'Historical Graphs',\n    ];\n    if (Auth::user()->hasGlobalAdmin()) {\n        $menu_options['edit'] = 'Edit';\n        $menu_options['delete'] = 'Delete';\n        $menu_options['reset'] = 'Reset';\n    }\n    $sep = '';\n    foreach ($menu_options as $option => $text) {\n        echo $sep;\n        if ($vars['view'] == $option) {\n            echo \"<span class='pagemenu-selected'>\";\n        }\n\n        echo generate_link($text, $vars, ['view' => $option]);\n        if ($vars['view'] == $option) {\n            echo '</span>';\n        }\n\n        $sep = ' | ';\n    }\n\n    echo '<div style=\"font-weight: bold; float: right;\"><a href=\"' . \\LibreNMS\\Util\\Url::generate(['page' => 'bills']) . '/\"><i class=\"fa fa-arrow-left fa-lg icon-theme\" aria-hidden=\"true\"></i> Back to Bills</a></div>';\n\n    print_optionbar_end();\n\n    if ($vars['view'] == 'edit' && Auth::user()->hasGlobalAdmin()) {\n        include 'includes/html/pages/bill/edit.inc.php';\n    } elseif ($vars['view'] == 'delete' && Auth::user()->hasGlobalAdmin()) {\n        include 'includes/html/pages/bill/delete.inc.php';\n    } elseif ($vars['view'] == 'reset' && Auth::user()->hasGlobalAdmin()) {\n        include 'includes/html/pages/bill/reset.inc.php';\n    } elseif ($vars['view'] == 'history') {\n        include 'includes/html/pages/bill/history.inc.php';\n    } elseif ($vars['view'] == 'transfer') {\n        include 'includes/html/pages/bill/transfer.inc.php';\n    } elseif ($vars['view'] == 'quick' || $vars['view'] == 'accurate') {\n        ?>\n\n        <?php   if ($bill_data['bill_type'] == 'quota') { ?>\n    <h3>Quota Bill</h3>\n        <?php   } elseif ($bill_data['bill_type'] == 'cdr') {  ?>\n    <h3>\n        CDR / 95th Bill\n    </h3>\n        <?php           } ?>\n<strong>Billing Period from <?php echo $fromtext ?> to <?php echo $totext ?></strong>\n<br /><br />\n\n<div class=\"row\">\n<div class=\"col-lg-6 col-lg-push-6\">\n        <?php print_port_list($ports) ?>\n</div>\n<div class=\"col-lg-6 col-lg-pull-6\">\n<div class=\"panel panel-default\">\n    <div class=\"panel-heading\">\n        <h3 class=\"panel-title\">\n            Bill Summary\n        </h3>\n    </div>\n    <table class=\"table\">\n    <tr>\n        <?php   if ($bill_data['bill_type'] == 'quota') {\n            // The Customer is billed based on a pre-paid quota with overage in xB\n            $percent = Number::calculatePercent($total_data, $bill_data['bill_quota']);\n            $unit = 'MB';\n            $total_data = round($total_data, 2);\n            $background = \\LibreNMS\\Util\\Color::percentage($percent, null);\n            $type = '&amp;ave=yes'; ?>\n        <td>\n            <?php echo format_bytes_billing($total_data) ?> of <?php echo format_bytes_billing($bill_data['bill_quota']) . ' (' . $percent . '%)' ?>\n            - Average rate <?php echo Number::formatSi($rate_average, 2, 3, 'bps') ?>\n        </td>\n        <td style=\"width: 210px;\"><?php echo print_percentage_bar(200, 20, $percent, null, 'ffffff', $background['left'], $percent . '%', 'ffffff', $background['right']) ?></td>\n        </tr>\n        <tr>\n            <td colspan=\"2\">\n            <?php\n            echo 'Predicted usage: ' . format_bytes_billing(getPredictedUsage($bill_data['bill_day'], $bill_data['total_data'])); ?>\n            </td>\n            <?php\n        } elseif ($bill_data['bill_type'] == 'cdr') {\n            // The customer is billed based on a CDR with 95th%ile overage\n            $unit = 'kbps';\n            $cdr = $bill_data['bill_cdr'];\n            $rate_95th = round($rate_95th, 2);\n            $percent = Number::calculatePercent($rate_95th, $cdr);\n            $background = \\LibreNMS\\Util\\Color::percentage($percent, null);\n            $type = '&amp;95th=yes'; ?>\n        <td>\n            <?php echo Number::formatSi($rate_95th, 2, 3, '') . 'bps' ?> of <?php echo Number::formatSi($cdr, 2, 3, '') . 'bps (' . $percent . '%)' ?> (95th%ile)\n        </td>\n        <td style=\"width: 210px;\">\n            <?php echo print_percentage_bar(200, 20, $percent, null, 'ffffff', $background['left'], $percent . '%', 'ffffff', $background['right']) ?>\n        </td>\n        </tr>\n        <tr>\n            <td colspan=\"2\">\n            <?php\n                echo 'Predicted usage: ' . Number::formatSi(getPredictedUsage($bill_data['bill_day'], $bill_data['rate_95th']), 2, 3, '') . 'bps'; ?>\n            </td>\n\n        <?php\n        }//end if?>\n    </tr>\n    </table>\n</div>\n</div>\n</div>\n\n        <?php\n\n        $lastmonth = dbFetchCell('SELECT UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 1 MONTH))');\n        $yesterday = dbFetchCell('SELECT UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 1 DAY))');\n        $rightnow = date('U');\n\n        if ($vars['view'] == 'accurate') {\n            $bi = \"<img src='billing-graph.php?bill_id=\" . $bill_id . '&amp;bill_code=' . htmlspecialchars($_GET['bill_code']);\n            $bi .= '&amp;from=' . $unixfrom . '&amp;to=' . $unixto;\n            $bi .= '&amp;x=1190&amp;y=250';\n            $bi .= \"$type'>\";\n\n            $li = \"<img src='billing-graph.php?bill_id=\" . $bill_id . '&amp;bill_code=' . $_GET['bill_code'];\n            $li .= '&amp;from=' . $unix_prev_from . '&amp;to=' . $unix_prev_to;\n            $li .= '&amp;x=1190&amp;y=250';\n            $li .= \"$type'>\";\n\n            $di = \"<img src='billing-graph.php?bill_id=\" . $bill_id . '&amp;bill_code=' . htmlspecialchars($_GET['bill_code']);\n            $di .= '&amp;from=' . \\LibreNMS\\Config::get('time.day') . '&amp;to=' . \\LibreNMS\\Config::get('time.now');\n            $di .= '&amp;x=1190&amp;y=250';\n            $di .= \"$type'>\";\n\n            $mi = \"<img src='billing-graph.php?bill_id=\" . $bill_id . '&amp;bill_code=' . htmlspecialchars($_GET['bill_code']);\n            $mi .= '&amp;from=' . $lastmonth . '&amp;to=' . $rightnow;\n            $mi .= '&amp;x=1190&amp;y=250';\n            $mi .= \"$type'>\";\n        } else {\n            $bi = \"<img src='graph.php?type=bill_bits&amp;id=\" . $bill_id;\n            $bi .= '&amp;from=' . $unixfrom . '&amp;to=' . $unixto;\n            $bi .= '&amp;width=1000&amp;height=200&amp;total=1&amp;dir=' . $dir_95th . \"'>\";\n\n            $li = \"<img src='graph.php?type=bill_bits&amp;id=\" . $bill_id;\n            $li .= '&amp;from=' . $unix_prev_from . '&amp;to=' . $unix_prev_to;\n            $li .= '&amp;width=1000&amp;height=200&amp;total=1&amp;dir=' . $dir_95th . \"'>\";\n\n            $di = \"<img src='graph.php?type=bill_bits&amp;id=\" . $bill_id;\n            $di .= '&amp;from=' . \\LibreNMS\\Config::get('time.day') . '&amp;to=' . \\LibreNMS\\Config::get('time.now');\n            $di .= '&amp;width=1000&amp;height=200&amp;total=1&amp;dir=' . $dir_95th . \"'>\";\n\n            $mi = \"<img src='graph.php?type=bill_bits&amp;id=\" . $bill_id;\n            $mi .= '&amp;from=' . $lastmonth . '&amp;to=' . $rightnow;\n            $mi .= '&amp;width=1000&amp;height=200&amp;total=1&amp;dir=' . $dir_95th . \"'>\";\n        }//end if\n\n        ?>\n<div class=\"panel panel-default\">\n<div class=\"panel-heading\">\n    <h3 class=\"panel-title\">Billing View</h3>\n</div>\n        <?php echo $bi ?>\n</div>\n\n<div class=\"panel panel-default\">\n<div class=\"panel-heading\">\n    <h3 class=\"panel-title\">24 Hour View</h3>\n</div>\n        <?php echo $di ?>\n</div>\n\n<div class=\"panel panel-default\">\n<div class=\"panel-heading\">\n    <h3 class=\"panel-title\">Monthly View</h3>\n</div>\n        <?php echo $mi ?>\n</div>\n        <?php\n    } //end if\n} else {\n    include 'includes/html/error-no-perm.inc.php';\n}//end if\n?>\n", "<h4>Bill Information</h4>\n<div class=\"form-group\">\n  <label for=\"bill_name\" class=\"col-sm-4 control-label\">Description</label>\n  <div class=\"col-sm-8\">\n    <input class=\"form-control input-sm\" type=\"text\" id=\"bill_name\" name=\"bill_name\" value=\"<?php echo htmlentities($bill_data['bill_name']); ?>\">\n  </div>\n</div>\n<div class=\"form-group\">\n  <label class=\"col-sm-4 control-label\" for=\"bill_type\">Billing Type</label>\n  <div class=\"col-sm-8\">\n    <label class=\"radio-inline\">\n      <input type=\"radio\" name=\"bill_type\" id=\"bill_type_cdr\" value=\"cdr\"\n            <?php\n            if ($bill_data['bill_type'] == 'cdr') {\n                echo 'checked';\n            }\n            ?> onchange=\"javascript: billType();\" /> CDR 95th\n    </label>\n    <label class=\"radio-inline\">\n      <input type=\"radio\" name=\"bill_type\" id=\"bill_type_quota\" value=\"quota\"\n            <?php\n            if ($bill_data['bill_type'] == 'quota') {\n                echo 'checked';\n            }\n            ?> onchange=\"javascript: billType();\" /> Quota\n    </label>\n  </div>\n</div>\n<div class=\"form-group\">\n  <div id=\"cdrDiv\">\n    <label class=\"col-sm-4 control-label\" for=\"bill_cdr\">CDR</label>\n    <div class=\"col-sm-3\">\n      <input class=\"form-control input-sm\" type=\"text\" name=\"bill_cdr\" value=\"<?php echo $cdr['data'] ?>\">\n    </div>\n    <div class=\"col-sm-5\">\n      <select name=\"bill_cdr_type\" class=\"form-control input-sm\">\n        <option <?php echo $cdr['select_kbps'] ?> value=\"Kbps\">Kilobits per second (Kbps)</option>\n        <option <?php echo $cdr['select_mbps'] ?> value=\"Mbps\">Megabits per second (Mbps)</option>\n        <option <?php echo $cdr['select_gbps'] ?> value=\"Gbps\">Gigabits per second (Gbps)</option>\n      </select>\n    </div>\n    <label class=\"col-sm-4 control-label\" for=\"dir_95th\">95th Calculation</label>\n    <div class=\"col-sm-8\">\n      <label class=\"radio-inline\">\n       <input type=\"radio\" name=\"dir_95th\" id=\"dir_95th_inout\" value=\"in\"\n            <?php\n            if ($bill_data['dir_95th'] == 'in' || $bill_data['dir_95th'] == 'out') {\n                echo 'checked';\n            }\n            ?> /> Max In/Out\n       </label>\n      <label class=\"radio-inline\">\n       <input type=\"radio\" name=\"dir_95th\" id=\"dir_95th_agg\" value=\"agg\"\n            <?php\n            if ($bill_data['dir_95th'] == 'agg') {\n                echo 'checked';\n            }\n            ?> /> Aggregate\n       </label>\n    </div>\n  </div>\n  <div id=\"quotaDiv\">\n    <label class=\"col-sm-4 control-label\" for=\"bill_quota\">Quota</label>\n    <div class=\"col-sm-3\">\n      <input class=\"form-control input-sm\" type=\"text\" name=\"bill_quota\" value=\"<?php echo $quota['data'] ?>\">\n    </div>\n    <div class=\"col-sm-5\">\n      <select name=\"bill_quota_type\" class=\"form-control input-sm\">\n        <option <?php echo $quota['select_mb'] ?> value=\"MB\">Megabytes (MB)</option>\n        <option <?php echo $quota['select_gb'] ?> value=\"GB\">Gigabytes (GB)</option>\n        <option <?php echo $quota['select_tb'] ?> value=\"TB\">Terabytes (TB)</option>\n      </select>\n    </div>\n  </div>\n</div>\n<div class=\"form-group\">\n  <label class=\"col-sm-4 control-label\" for=\"bill_day\">Billing Day</label>\n  <div class=\"col-sm-2\">\n    <select name=\"bill_day\" class=\"form-control input-sm\">\n    <?php\n    for ($x = 1; $x < 32; $x++) {\n        $sel = $bill_data['bill_day'] == $x ? 'selected ' : '';\n        echo \"<option $sel value='$x'>$x</option>\\n\";\n    }\n    ?>\n    </select>\n  </div>\n</div>\n<fieldset>\n    <h4>Optional Information</h4>\n    <div class=\"form-group\">\n      <label class=\"col-sm-4 control-label\" for=\"bill_custid\">Customer Reference</label>\n      <div class=\"col-sm-8\">\n        <input class=\"form-control input-sm\" type=\"text\" name=\"bill_custid\" value=\"<?php echo htmlentities($bill_data['bill_custid']); ?>\">\n      </div>\n    </div>\n    <div class=\"form-group\">\n      <label class=\"col-sm-4 control-label\" for=\"bill_ref\">Billing Reference</label>\n      <div class=\"col-sm-8\">\n        <input class=\"form-control input-sm\" type=\"text\" name=\"bill_ref\" value=\"<?php echo htmlentities($bill_data['bill_ref']); ?>\">\n      </div>\n    </div>\n    <div class=\"form-group\">\n      <label class=\"col-sm-4 control-label\" for=\"bill_notes\">Notes</label>\n      <div class=\"col-sm-8\">\n        <input class=\"form-control input-sm\" type=\"textarea\" name=\"bill_notes\" value=\"<?php echo htmlentities($bill_data['bill_notes']); ?>\">\n      </div>\n    </div>\n</fieldset>\n\n<script type=\"text/javascript\">\nfunction billType() {\n    var selected = $('input[name=bill_type]:checked').val();\n\n    $('#cdrDiv').toggle(selected === 'cdr');\n    $('#quotaDiv').toggle(selected === 'quota');\n}\nbillType();\n</script>\n", "<?php\n\n// Calculate filters\nuse LibreNMS\\Util\\Number;\n\n$prev = ! empty($vars['period']) && ($vars['period'] == 'prev');\n$wheres = [];\n$param = [];\nif (isset($searchPhrase) && ! empty($searchPhrase)) {\n    $wheres[] = 'bills.bill_name LIKE ?';\n    $param[] = \"%$searchPhrase%\";\n}\nif (! empty($vars['bill_type'])) {\n    if ($prev) {\n        $wheres[] = 'bill_history.bill_type = ?';\n    } else {\n        $wheres[] = 'bill_type = ?';\n    }\n    $param[] = $vars['bill_type'];\n}\nif (! empty($vars['state'])) {\n    if ($vars['state'] === 'under') {\n        if ($prev) {\n            $wheres[] = \"((bill_history.bill_type = 'cdr' AND bill_history.rate_95th <= bill_history.bill_allowed) OR (bill_history.bill_type = 'quota' AND bill_history.traf_total <= bill_history.bill_allowed))\";\n        } else {\n            $wheres[] = \"((bill_type = 'cdr' AND rate_95th <= bill_cdr) OR (bill_type = 'quota' AND total_data <= bill_quota))\";\n        }\n    } elseif ($vars['state'] === 'over') {\n        if ($prev) {\n            $wheres[] = \"((bill_history.bill_type = 'cdr' AND bill_history.rate_95th > bill_history.bill_allowed) OR (bill_history.bill_type = 'quota' AND bill_history.traf_total > bill_allowed))\";\n        } else {\n            $wheres[] = \"((bill_type = 'cdr' AND rate_95th > bill_cdr) OR (bill_type = 'quota' AND total_data > bill_quota))\";\n        }\n    }\n}\n\nif ($prev) {\n    $select = 'SELECT bills.bill_name, bills.bill_notes, bill_history.*, bill_history.traf_total as total_data, bill_history.traf_in as total_data_in, bill_history.traf_out as total_data_out ';\n    $query = 'FROM `bills`\n        INNER JOIN (SELECT bill_id, MAX(bill_hist_id) AS bill_hist_id FROM bill_history WHERE bill_dateto < NOW() AND bill_dateto > subdate(NOW(), 40) GROUP BY bill_id) qLastBills ON bills.bill_id = qLastBills.bill_id\n        INNER JOIN bill_history ON qLastBills.bill_hist_id = bill_history.bill_hist_id\n';\n} else {\n    $select = \"SELECT bills.*,\n        IF(bills.bill_type = 'CDR', bill_cdr, bill_quota) AS bill_allowed\n    \";\n    $query = \"FROM `bills`\\n\";\n}\n\n// Permissions check\nif (! Auth::user()->hasGlobalRead()) {\n    $query .= ' INNER JOIN `bill_perms` AS `BP` ON `bills`.`bill_id` = `BP`.`bill_id` ';\n    $wheres[] = '`BP`.`user_id`=?';\n    $param[] = Auth::id();\n}\n\nif (sizeof($wheres) > 0) {\n    $query .= 'WHERE ' . implode(' AND ', $wheres) . \"\\n\";\n}\n$orderby = 'ORDER BY bills.bill_name';\n\n$total = dbFetchCell(\"SELECT COUNT(bills.bill_id) $query\", $param);\n\n$sql = \"$select\n$query\";\n\nif (! isset($sort) || empty($sort)) {\n    $sort = 'bills.bill_name';\n}\n\n$sql .= \"\\nORDER BY $sort\";\n\nif (isset($current)) {\n    $limit_low = (($current * $rowCount) - ($rowCount));\n    $limit_high = $rowCount;\n}\n\nif ($rowCount != -1) {\n    $sql .= \" LIMIT $limit_low,$limit_high\";\n}\n\nforeach (dbFetchRows($sql, $param) as $bill) {\n    if ($prev) {\n        $datefrom = $bill['bill_datefrom'];\n        $dateto = $bill['bill_dateto'];\n    } else {\n        $day_data = getDates($bill['bill_day']);\n        $datefrom = $day_data['0'];\n        $dateto = $day_data['1'];\n    }\n    $rate_95th = Number::formatSi($bill['rate_95th'], 2, 3, '') . 'bps';\n    $dir_95th = $bill['dir_95th'];\n    $total_data = format_bytes_billing($bill['total_data']);\n    $rate_average = $bill['rate_average'];\n    $url = \\LibreNMS\\Util\\Url::generate(['page' => 'bill', 'bill_id' => $bill['bill_id']]);\n    $used95th = Number::formatSi($bill['rate_95th'], 2, 3, '') . 'bps';\n    $notes = htmlentities($bill['bill_notes']);\n\n    if ($prev) {\n        $percent = $bill['bill_percent'];\n        $overuse = $bill['bill_overuse'];\n    } else {\n    }\n\n    if (strtolower($bill['bill_type']) == 'cdr') {\n        $type = 'CDR';\n        $allowed = Number::formatSi($bill['bill_allowed'], 2, 3, '') . 'bps';\n        $in = Number::formatSi($bill['rate_95th_in'], 2, 3, '') . 'bps';\n        $out = Number::formatSi($bill['rate_95th_out'], 2, 3, '') . 'bps';\n        if (! $prev) {\n            $percent = Number::calculatePercent($bill['rate_95th'], $bill['bill_allowed']);\n            $overuse = ($bill['rate_95th'] - $bill['bill_allowed']);\n        }\n\n        $overuse_formatted = Number::formatSi($overuse, 2, 3, '') . 'bps';\n        $used = $rate_95th;\n        $tmp_used = $bill['rate_95th'];\n        $rate_95th = \"<b>$rate_95th</b>\";\n    } elseif (strtolower($bill['bill_type']) == 'quota') {\n        $type = 'Quota';\n        $allowed = format_bytes_billing($bill['bill_allowed']);\n        if (! empty($prev)) {\n            $in = format_bytes_billing($bill['traf_in']);\n            $out = format_bytes_billing($bill['traf_out']);\n        } else {\n            $in = format_bytes_billing($bill['total_data_in']);\n            $out = format_bytes_billing($bill['total_data_out']);\n        }\n        if (! $prev) {\n            $percent = Number::calculatePercent($bill['total_data'], $bill['bill_allowed']);\n            $overuse = ($bill['total_data'] - $bill['bill_allowed']);\n        }\n\n        $overuse_formatted = format_bytes_billing($overuse);\n        $used = $total_data;\n        $tmp_used = $bill['total_data'];\n        $total_data = \"<b>$total_data</b>\";\n    }\n\n    $background = \\LibreNMS\\Util\\Color::percentage($percent, null);\n    $right_background = $background['right'];\n    $left_background = $background['left'];\n    $overuse_formatted = (($overuse <= 0) ? '-' : \"<span style='color: #${background['left']}; font-weight: bold;'>$overuse_formatted</span>\");\n\n    $bill_name = \"<a href='$url'><span style='font-weight: bold;' class='interface'>\" . htmlentities($bill['bill_name']) . '</span></a><br />' .\n                    date('Y-m-d', strtotime($datefrom)) . ' to ' . date('Y-m-d', strtotime($dateto));\n    $bar = print_percentage_bar(250, 20, $percent, null, 'ffffff', $background['left'], $percent . '%', 'ffffff', $background['right']);\n    $actions = '';\n\n    if (! $prev && Auth::user()->hasGlobalAdmin()) {\n        $actions .= \"<a href='\" . \\LibreNMS\\Util\\Url::generate(['page' => 'bill', 'bill_id' => $bill['bill_id'], 'view' => 'edit']) .\n            \"'><i class='fa fa-pencil fa-lg icon-theme' title='Edit' aria-hidden='true'></i> Edit</a> \";\n    }\n    if (strtolower($bill['bill_type']) == 'cdr') {\n        $predicted = Number::formatSi(getPredictedUsage($bill['bill_day'], $tmp_used), 2, 3, '') . 'bps';\n    } elseif (strtolower($bill['bill_type']) == 'quota') {\n        $predicted = format_bytes_billing(getPredictedUsage($bill['bill_day'], $tmp_used));\n    }\n\n    $response[] = [\n        'bill_name'     => $bill_name,\n        'notes'         => $notes,\n        'bill_type'     => $type,\n        'bill_allowed'    => $allowed,\n        'total_data_in' => $in,\n        'total_data_out'=> $out,\n        'total_data'    => $total_data,\n        'rate_95th'     => $rate_95th,\n        'used'          => $used,\n        'overusage'     => $overuse_formatted,\n        'predicted'     => $predicted,\n        'graph'         => $bar,\n        'actions'       => $actions,\n    ];\n}\n\n$output = ['current' => $current, 'rowCount' => $rowCount, 'rows' => $response, 'total' => $total];\necho json_encode($output, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE);\n"], "filenames": ["includes/html/pages/bill.inc.php", "includes/html/pages/bill/addoreditbill.inc.php", "includes/html/table/bills.inc.php"], "buggy_code_start_loc": [90, 5, 97], "buggy_code_end_loc": [91, 107, 146], "fixing_code_start_loc": [90, 5, 97], "fixing_code_end_loc": [91, 107, 146], "type": "CWE-79", "message": "Cross-site Scripting (XSS) - Stored in GitHub repository librenms/librenms prior to 22.10.0.", "other": {"cve": {"id": "CVE-2022-3562", "sourceIdentifier": "security@huntr.dev", "published": "2022-11-20T05:15:11.810", "lastModified": "2022-11-21T13:19:19.830", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Cross-site Scripting (XSS) - Stored in GitHub repository librenms/librenms prior to 22.10.0."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 5.4, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.3, "impactScore": 2.7}], "cvssMetricV30": [{"source": "security@huntr.dev", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:H/UI:R/S:U/C:L/I:L/A:L", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "HIGH", "userInteraction": "REQUIRED", "scope": "UNCHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "LOW", "baseScore": 4.3, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 0.9, "impactScore": 3.4}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}, {"source": "security@huntr.dev", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:librenms:librenms:*:*:*:*:*:*:*:*", "versionEndExcluding": "22.10.0", "matchCriteriaId": "99D1C2AF-9BBB-4F7D-9FC3-4A645F7C284D"}]}]}], "references": [{"url": "https://github.com/librenms/librenms/commit/43cb72549d90e338f902b359a83c23d3cb5a2645", "source": "security@huntr.dev", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://huntr.dev/bounties/bb9f76db-1314-44ae-9ccc-2b69679aa657", "source": "security@huntr.dev", "tags": ["Permissions Required", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/librenms/librenms/commit/43cb72549d90e338f902b359a83c23d3cb5a2645"}}