{"buggy_code": ["<?php\n\n  if (!empty($_GET['category_id'])) {\n    $category = new ent_category($_GET['category_id']);\n  } else {\n    $category = new ent_category();\n  }\n\n  if (empty($_POST)) {\n    $_POST = $category->data;\n\n    if (empty($category->data['id']) && !empty($_GET['parent_id'])) {\n      $_POST['parent_id'] = $_GET['parent_id'];\n    }\n  }\n\n  document::$snippets['title'][] = !empty($category->data['id']) ? language::translate('title_edit_category', 'Edit Category') : language::translate('title_add_new_category', 'Add New Category');\n\n  breadcrumbs::add(language::translate('title_catalog', 'Catalog'));\n  breadcrumbs::add(!empty($category->data['id']) ? language::translate('title_edit_category', 'Edit Category') : language::translate('title_add_new_category', 'Add New Category'));\n\n  if (isset($_POST['save'])) {\n\n    try {\n\n      if (empty($_POST['name'])) throw new Exception(language::translate('error_must_enter_name', 'You must enter a name'));\n\n      if (!empty($_POST['code']) && database::num_rows(database::query(\"select id from \". DB_TABLE_PREFIX .\"categories where id != '\". (isset($_GET['category_id']) ? (int)$_GET['category_id'] : 0) .\"' and code = '\". database::input($_POST['code']) .\"' limit 1;\"))) {\n        throw new Exception(language::translate('error_code_database_conflict', 'Another entry with the given code already exists in the database'));\n      }\n\n      if (empty($_POST['filters'])) $_POST['filters'] = [];\n\n      $fields = [\n        'status',\n        'parent_id',\n        'code',\n        'google_taxonomy_id',\n        'list_style',\n        'image',\n        'name',\n        'short_description',\n        'description',\n        'keywords',\n        'head_title',\n        'h1_title',\n        'meta_description',\n        'filters',\n        'priority',\n      ];\n\n      foreach ($fields as $field) {\n        if (isset($_POST[$field])) $category->data[$field] = $_POST[$field];\n      }\n\n      if (!empty($_POST['delete_image'])) $category->delete_image();\n\n      if (is_uploaded_file($_FILES['image']['tmp_name'])) {\n        $category->save_image($_FILES['image']['tmp_name']);\n      }\n\n      $category->save();\n\n      notices::add('success', language::translate('success_changes_saved', 'Changes saved'));\n      header('Location: '. document::link(WS_DIR_ADMIN, ['doc' => 'catalog', 'category_id' => $_POST['parent_id']], ['app']));\n      exit;\n\n    } catch (Exception $e) {\n      notices::add('errors', $e->getMessage());\n    }\n  }\n\n  if (isset($_POST['delete'])) {\n\n    try {\n      if (empty($category->data['id'])) throw new Exception(language::translate('error_must_provide_category', 'You must provide a category'));\n\n      $category->delete();\n\n      notices::add('success', language::translate('success_changes_saved', 'Changes saved'));\n      header('Location: '. document::link(WS_DIR_ADMIN, ['doc' => 'catalog', 'category_id' => $_POST['parent_id']], ['app']));\n      exit;\n\n    } catch (Exception $e) {\n      notices::add('errors', $e->getMessage());\n    }\n  }\n\n  list($category_image_width, $category_image_height) = functions::image_scale_by_width(320, settings::get('category_image_ratio'));\n?>\n<div class=\"panel panel-app\">\n  <div class=\"panel-heading\">\n    <?php echo $app_icon; ?> <?php echo !empty($category->data['id']) ? language::translate('title_edit_category', 'Edit Category') .': '. $category->data['name'][language::$selected['code']] : language::translate('title_add_new_category', 'Add New Category'); ?>\n  </div>\n\n  <ul class=\"nav nav-tabs\">\n    <li class=\"active\"><a data-toggle=\"tab\" href=\"#tab-general\"><?php echo language::translate('title_general', 'General'); ?></a></li>\n    <li><a data-toggle=\"tab\" href=\"#tab-information\"><?php echo language::translate('title_information', 'Information'); ?></a></li>\n    <li><a data-toggle=\"tab\" href=\"#tab-filters\"><?php echo language::translate('title_filters', 'Filters'); ?></a></li>\n  </ul>\n\n  <div class=\"panel-body\">\n    <?php echo functions::form_draw_form_begin('category_form', 'post', false, true); ?>\n\n      <div class=\"tab-content\">\n        <div id=\"tab-general\" class=\"tab-pane active\" style=\"max-width: 980px;\">\n\n          <div class=\"row\">\n            <div class=\"col-md-4\">\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_status', 'Status'); ?></label>\n                <?php echo functions::form_draw_toggle('status', isset($_POST['status']) ? $_POST['status'] : '0', 'e/d'); ?>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_parent_category', 'Parent Category'); ?></label>\n                <?php echo functions::form_draw_category_field('parent_id', true); ?>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_google_taxonomy_id', 'Google Taxonomy ID'); ?> <a href=\"http://www.google.com/basepages/producttype/taxonomy-with-ids.en-US.txt\" target=\"_blank\"><?php echo functions::draw_fonticon('fa-external-link'); ?></a></label>\n                <?php echo functions::form_draw_number_field('google_taxonomy_id', true); ?>\n              </div>\n\n              <?php if (!empty($category->data['id'])) { ?>\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_date_updated', 'Date Updated'); ?></label>\n                <div><?php echo language::strftime('%e %b %Y %H:%M', strtotime($category->data['date_updated'])); ?></div>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_date_created', 'Date Created'); ?></label>\n                <div><?php echo language::strftime('%e %b %Y %H:%M', strtotime($category->data['date_created'])); ?></div>\n              </div>\n              <?php } ?>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_priority', 'Priority'); ?></label>\n                <?php echo functions::form_draw_number_field('priority', true); ?>\n              </div>\n            </div>\n\n            <div class=\"col-md-4\">\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_name', 'Name'); ?></label>\n                <?php foreach (array_keys(language::$languages) as $language_code) echo functions::form_draw_regional_input_field($language_code, 'name['. $language_code .']', true, ''); ?>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_code', 'Code'); ?></label>\n                <?php echo functions::form_draw_text_field('code', true); ?>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_list_style', 'List Style'); ?></label>\n<?php\n  $options = [\n    [language::translate('title_columns', 'Columns'), 'columns'],\n    [language::translate('title_rows', 'Rows'), 'rows'],\n  ];\n  echo functions::form_draw_select_field('list_style', $options, true);\n?>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_keywords', 'Keywords'); ?></label>\n                <?php echo functions::form_draw_text_field('keywords', true); ?>\n              </div>\n            </div>\n\n            <div class=\"col-md-4\">\n              <div id=\"image\">\n                <div class=\"thumbnail\" style=\"margin-bottom: 15px;\">\n                  <img src=\"<?php echo document::href_link(WS_DIR_APP . functions::image_thumbnail(FS_DIR_APP . 'images/' . $category->data['image'], $category_image_width, $category_image_height, settings::get('category_image_clipping'))); ?>\" alt=\"\" />\n                </div>\n\n                <div class=\"form-group\">\n                  <label><?php echo ((isset($category->data['image']) && $category->data['image'] != '') ? language::translate('title_new_image', 'New Image') : language::translate('title_image', 'Image')); ?></label>\n                  <?php echo functions::form_draw_file_field('image', ''); ?>\n                  <?php if (!empty($category->data['image'])) { ?><br />\n                  <div><?php echo $category->data['image']; ?></div>\n                  <div><?php echo functions::form_draw_checkbox('delete_image', 'true', true); ?> <?php echo language::translate('title_delete', 'Delete'); ?></div>\n                  <?php } ?>\n                </div>\n              </div>\n            </div>\n\n          </div>\n        </div>\n\n        <div id=\"tab-information\" class=\"tab-pane\" style=\"max-width: 640px;\">\n\n          <ul class=\"nav nav-tabs\">\n            <?php foreach (language::$languages as $language) { ?>\n              <li<?php echo ($language['code'] == language::$selected['code']) ? ' class=\"active\"' : ''; ?>><a data-toggle=\"tab\" href=\"#<?php echo $language['code']; ?>\"><?php echo $language['name']; ?></a></li>\n            <?php } ?>\n          </ul>\n\n          <div class=\"tab-content\">\n\n            <?php foreach (array_keys(language::$languages) as $language_code) { ?>\n            <div id=\"<?php echo $language_code; ?>\" class=\"tab-pane fade in<?php echo ($language_code == language::$selected['code']) ? ' active' : ''; ?>\">\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_name', 'Name'); ?></label>\n                <?php echo functions::form_draw_regional_input_field($language_code, 'name['. $language_code .']', true, ''); ?>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_h1_title', 'H1 Title'); ?></label>\n                <?php echo functions::form_draw_regional_input_field($language_code, 'h1_title['. $language_code .']', true, ''); ?>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_short_description', 'Short Description'); ?></label>\n                <?php echo functions::form_draw_regional_input_field($language_code, 'short_description['. $language_code .']', true); ?>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_description', 'Description'); ?></label>\n                <?php echo functions::form_draw_regional_wysiwyg_field($language_code, 'description['. $language_code .']', true, 'style=\"height: 240px;\"'); ?>\n              </div>\n\n              <div class=\"row\">\n                <div class=\"form-group col-md-6\">\n                  <label><?php echo language::translate('title_head_title', 'Head Title'); ?></label>\n                  <?php echo functions::form_draw_regional_input_field($language_code, 'head_title['. $language_code .']', true); ?>\n                </div>\n\n                <div class=\"form-group col-md-6\">\n                  <label><?php echo language::translate('title_meta_description', 'Meta Description'); ?></label>\n                  <?php echo functions::form_draw_regional_input_field($language_code, 'meta_description['. $language_code .']', true); ?>\n                </div>\n              </div>\n\n            </div>\n            <?php } ?>\n\n          </div>\n        </div>\n\n        <div id=\"tab-filters\" class=\"tab-pane\" style=\"max-width: 640px;\">\n\n          <table class=\"table table-striped data-table table-dragable\">\n            <thead>\n              <tr>\n                <th><?php echo language::translate('title_attribute_group', 'Attribute Group'); ?></th>\n                <th><?php echo language::translate('title_select_multiple', 'Select Multiple'); ?></th>\n                <th></th>\n              </tr>\n            </thead>\n            <tbody>\n              <?php if (!empty($_POST['filters'])) foreach (array_keys($_POST['filters']) as $key) { ?>\n              <tr>\n                <?php echo functions::form_draw_hidden_field('filters['.$key.'][id]', true); ?>\n                <?php echo functions::form_draw_hidden_field('filters['.$key.'][attribute_group_id]', true); ?>\n                <?php echo functions::form_draw_hidden_field('filters['.$key.'][attribute_group_name]', true); ?>\n                <td class=\"grabable\"><?php echo $_POST['filters'][$key]['attribute_group_name']; ?></td>\n                <td class=\"grabable\"><?php echo functions::form_draw_checkbox('filters['.$key.'][select_multiple]', '1', true); ?></td>\n                <td class=\"text-end\">\n                  <a class=\"move-up\" href=\"#\" title=\"<?php echo language::translate('text_move_up', 'Move up'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-up fa-lg', 'style=\"color: #3399cc;\"'); ?></a>\n                  <a class=\"move-down\" href=\"#\" title=\"<?php echo language::translate('text_move_down', 'Move down'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-down fa-lg', 'style=\"color: #3399cc;\"'); ?></a>\n                  <a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"'); ?></a>\n                </td>\n              </tr>\n              <?php } ?>\n            </tbody>\n          </table>\n\n          <div class=\"input-group\" style=\"max-width: 320px;\">\n            <?php echo functions::form_draw_attribute_groups_list('new_attribute_group', true); ?>\n            <?php echo functions::form_draw_button('add', language::translate('title_add', 'Add'), 'button'); ?>\n          </div>\n        </div>\n      </div>\n\n      <div class=\"panel-action btn-group\">\n        <?php echo functions::form_draw_button('save', language::translate('title_save', 'Save'), 'submit', '', 'save'); ?>\n        <?php echo functions::form_draw_button('cancel', language::translate('title_cancel', 'Cancel'), 'button', 'onclick=\"history.go(-1);\"', 'cancel'); ?>\n        <?php echo (isset($category->data['id'])) ? functions::form_draw_button('delete', language::translate('title_delete', 'Delete'), 'submit', 'formnovalidate onclick=\"if (!window.confirm(\\''. language::translate('text_are_you_sure', 'Are you sure?') .'\\')) return false;\"', 'delete') : false; ?>\n      </div>\n\n    <?php echo functions::form_draw_form_end(); ?>\n  </div>\n</div>\n\n<script>\n  <?php if (!empty($category->data['id'])) { ?>\n  $('select[name=\"parent_id\"] option[value=\"<?php echo $category->data['id']; ?>\"]').prop('disabled', true);\n  <?php } ?>\n\n// Image\n\n  $('input[name=\"image\"]').change(function(e) {\n    if ($(this).val() != '') {\n      var oFReader = new FileReader();\n      oFReader.readAsDataURL(this.files[0]);\n      oFReader.onload = function(e){\n        $('#image img').attr('src', e.target.result);\n      };\n    } else {\n      $('#image img').attr('src', '<?php echo document::link(WS_DIR_APP . functions::image_thumbnail(FS_DIR_APP . 'images/' . $category->data['image'], $category_image_width, $category_image_height, settings::get('category_image_clipping'))); ?>');\n    }\n  });\n\n// Head Title & H1 Title\n\n  $('input[name^=\"name\"]').on('input', function(e){\n    var language_code = $(this).attr('name').match(/\\[(.*)\\]$/)[1];\n    $('.nav-tabs a[href=\"#'+language_code+'\"]').css('opacity', $(this).val() ? 1 : .5);\n    $('input[name=\"name['+language_code+']\"]').not(this).val($(this).val());\n    $('input[name=\"head_title['+language_code+']\"]').attr('placeholder', $(this).val());\n    $('input[name=\"h1_title['+language_code+']\"]').attr('placeholder', $(this).val());\n  }).trigger('input');\n\n// Meta Description\n\n  $('input[name^=\"short_description\"]').on('input', function(e){\n    var language_code = $(this).attr('name').match(/\\[(.*)\\]$/)[1];\n    $('input[name=\"meta_description['+language_code+']\"]').attr('placeholder', $(this).val());\n  }).trigger('input');\n\n// Filters\n\n  var new_attribute_filter_i = 0;\n  $('#tab-filters button[name=\"add\"]').click(function(){\n\n    if ($('select[name=\"new_attribute_group\"]').val() == '') {\n      alert(\"<?php echo language::translate('error_must_select_attribute_group', 'You must select an attribute group'); ?>\");\n      return;\n    }\n\n    var output = '<tr class=\"grabable\">'\n               + '  <?php echo functions::escape_js(functions::form_draw_hidden_field('filters[new_attribute_filter_i][id]', '')); ?>'\n               + '  <?php echo functions::escape_js(functions::form_draw_hidden_field('filters[new_attribute_filter_i][attribute_group_id]', 'new_attribute_group_id')); ?>'\n               + '  <?php echo functions::escape_js(functions::form_draw_hidden_field('filters[new_attribute_filter_i][attribute_group_name]', 'new_attribute_group_name')); ?>'\n               + '  <td>new_attribute_group_name</td>'\n               + '  <td><?php echo functions::form_draw_checkbox('filters[new_attribute_filter_i][select_multiple]', true); ?></td>'\n               + '  <td class=\"text-end\">'\n               + '    <a class=\"move-up\" href=\"#\" title=\"<?php echo language::translate('text_move_up', 'Move up'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-up fa-lg', 'style=\"color: #3399cc;\"'); ?></a>'\n               + '    <a class=\"move-down\" href=\"#\" title=\"<?php echo language::translate('text_move_down', 'Move down'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-down fa-lg', 'style=\"color: #3399cc;\"'); ?></a>'\n               + '    <a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"'); ?></a>'\n               + '  </td>'\n               + '</tr>';\n\n    while ($('input[name=\"filters[new_'+new_attribute_filter_i+']\"]').length) new_attribute_filter_i++;\n    output = output.replace(/new_attribute_filter_i/g, 'new_' + new_attribute_filter_i);\n    output = output.replace(/new_attribute_group_id/g, $('select[name=\"new_attribute_group\"] option:selected').val());\n    output = output.replace(/new_attribute_group_name/g, $('select[name=\"new_attribute_group\"] option:selected').text());\n    new_attribute_filter_i++;\n\n    $('#tab-filters tbody').append(output);\n  });\n\n  $('#tab-filters').on('click', '.move-up, .move-down', function(event) {\n    event.preventDefault();\n    var row = $(this).closest('tr');\n\n    if ($(this).is('.move-up') && $(row).prevAll().length) {\n      $(row).insertBefore($(row).prev());\n    } else if ($(this).is('.move-down') && $(row).nextAll().length) {\n      $(row).insertAfter($(row).next());\n    }\n  });\n\n  $('#tab-filters').on('click', '.remove', function(e) {\n    e.preventDefault();\n    $(this).closest('tr').remove();\n  });\n</script>", "<?php\n\n  if (!empty($_GET['product_id'])) {\n    $product = new ent_product($_GET['product_id']);\n  } else {\n    $product = new ent_product();\n  }\n\n  if (empty($_POST)) {\n    $_POST = $product->data;\n\n    $_POST['keywords'] = implode(',', $_POST['keywords']);\n\n    if (empty($product->data['id']) && isset($_GET['category_id'])) {\n      $_POST['categories'][] = $_GET['category_id'];\n    }\n  }\n\n  document::$snippets['title'][] = !empty($product->data['id']) ? language::translate('title_edit_product', 'Edit Product') . ': '. $product->data['name'][language::$selected['code']] : language::translate('title_add_new_product', 'Add New Product');\n\n  breadcrumbs::add(language::translate('title_catalog', 'Catalog'), document::link(WS_DIR_ADMIN, ['doc' => 'catalog'], ['app']));\n  breadcrumbs::add(!empty($product->data['id']) ? language::translate('title_edit_product', 'Edit Product') . ': '. $product->data['name'][language::$selected['code']] : language::translate('title_add_new_product', 'Add New Product'));\n\n  if (isset($_POST['save'])) {\n\n    try {\n      if (empty($_POST['categories'])) $_POST['categories'] = [0];\n      if (empty($_POST['images'])) $_POST['images'] = [];\n      if (empty($_POST['attributes'])) $_POST['attributes'] = [];\n      if (empty($_POST['campaigns'])) $_POST['campaigns'] = [];\n      if (empty($_POST['options'])) $_POST['options'] = [];\n      if (empty($_POST['options_stock'])) $_POST['options_stock'] = [];\n\n      if (!empty($_POST['code']) && database::num_rows(database::query(\"select id from \". DB_TABLE_PREFIX .\"products where id != '\". (int)$product->data['id'] .\"' and code = '\". database::input($_POST['code']) .\"' limit 1;\"))) {\n        throw new Exception(language::translate('error_code_database_conflict', 'Another entry with the given code already exists in the database'));\n      }\n\n      if (!empty($_POST['sku'])  && database::num_rows(database::query(\"select id from \". DB_TABLE_PREFIX .\"products where id != '\". (int)$product->data['id'] .\"' and sku = '\". database::input($_POST['sku']) .\"' limit 1;\"))) {\n        throw new Exception(language::translate('error_sku_database_conflict', 'Another entry with the given SKU already exists in the database'));\n      }\n\n      if (!empty($_POST['mpn']) && database::num_rows(database::query(\"select id from \". DB_TABLE_PREFIX .\"products where id != '\". (int)$product->data['id'] .\"' and mpn = '\". database::input($_POST['mpn']) .\"' limit 1;\"))) {\n        throw new Exception(language::translate('error_mpn_database_conflict', 'Another entry with the given MPN already exists in the database'));\n      }\n\n      if (!empty($_POST['gtin']) && database::num_rows(database::query(\"select id from \". DB_TABLE_PREFIX .\"products where id != '\". (int)$product->data['id'] .\"' and gtin = '\". database::input($_POST['gtin']) .\"' limit 1;\"))) {\n        throw new Exception(language::translate('error_gtin_database_conflict', 'Another entry with the given GTIN already exists in the database'));\n      }\n\n      $_POST['keywords'] = preg_split('#\\s*,\\s*#', $_POST['keywords'], -1, PREG_SPLIT_NO_EMPTY);\n\n      $fields = [\n        'status',\n        'manufacturer_id',\n        'supplier_id',\n        'delivery_status_id',\n        'sold_out_status_id',\n        'default_category_id',\n        'categories',\n        'attributes',\n        'keywords',\n        'date_valid_from',\n        'date_valid_to',\n        'quantity',\n        'quantity_adjustment',\n        'quantity_min',\n        'quantity_max',\n        'quantity_step',\n        'quantity_unit_id',\n        'purchase_price',\n        'purchase_price_currency_code',\n        'recommended_price',\n        'prices',\n        'campaigns',\n        'tax_class_id',\n        'code',\n        'sku',\n        'mpn',\n        'gtin',\n        'taric',\n        'dim_x',\n        'dim_y',\n        'dim_z',\n        'dim_class',\n        'weight',\n        'weight_class',\n        'name',\n        'short_description',\n        'description',\n        'technical_data',\n        'head_title',\n        'meta_description',\n        'images',\n        'options',\n        'options_stock',\n      ];\n\n      foreach ($fields as $field) {\n        if (isset($_POST[$field])) $product->data[$field] = $_POST[$field];\n      }\n\n      if (!empty($_FILES['new_images']['tmp_name'])) {\n        foreach (array_keys($_FILES['new_images']['tmp_name']) as $key) {\n          $product->add_image($_FILES['new_images']['tmp_name'][$key]);\n        }\n      }\n\n      $product->save();\n\n      notices::add('success', language::translate('success_changes_saved', 'Changes saved'));\n      header('Location: '. document::link(WS_DIR_ADMIN, ['app' => $_GET['app'], 'doc' => 'catalog', 'category_id' => $_POST['categories'][0]]));\n      exit;\n\n    } catch (Exception $e) {\n      notices::add('errors', $e->getMessage());\n    }\n  }\n\n  if (isset($_POST['delete'])) {\n\n    try {\n      if (empty($product->data['id'])) throw new Exception(language::translate('error_must_provide_product', 'You must provide a product'));\n\n      $product->delete();\n\n      if (empty($_POST['categories'])) $_POST['categories'] = [0];\n      notices::add('success', language::translate('success_changes_saved', 'Changes saved'));\n      header('Location: '. document::link(WS_DIR_ADMIN, ['app' => $_GET['app'], 'doc' => 'catalog', 'category_id' => $_POST['categories'][0]]));\n      exit;\n\n    } catch (Exception $e) {\n      notices::add('errors', $e->getMessage());\n    }\n  }\n\n  list($product_image_width, $product_image_height) = functions::image_scale_by_width(320, settings::get('product_image_ratio'));\n\n  $option_sort_options = [\n    [language::translate('title_list_order', 'List Order'), 'priority'],\n    [language::translate('title_alphabetical', 'Alphabetical'), 'alphabetical'],\n  ];\n\n  functions::draw_lightbox();\n?>\n<style>\n#categories {\n  max-height: 310px;\n  overflow-y: auto;\n  overflow-x: hidden;\n  transition: all 200ms linear;\n}\n#categories:hover {\n  width: 150%;\n  z-index: 999;\n}\n#categories label {\n  white-space: nowrap;\n}\n\n#images .thumbnail {\n  margin: 0;\n}\n#images .image {\n  overflow: hidden;\n}\n#images .thumbnail {\n  margin-inline-end: 15px;\n}\n#images img {\n  max-width: 50px;\n  max-height: 50px;\n}\n#images .actions {\n  text-align: end;\n  padding: 0.25em 0;\n}\n</style>\n\n<div class=\"panel panel-app\">\n  <div class=\"panel-heading\">\n    <?php echo $app_icon; ?> <?php echo !empty($product->data['id']) ? language::translate('title_edit_product', 'Edit Product') . ': '. $product->data['name'][language::$selected['code']] : language::translate('title_add_new_product', 'Add New Product'); ?>\n  </div>\n\n  <ul class=\"nav nav-tabs\">\n    <li class=\"active\"><a data-toggle=\"tab\" href=\"#tab-general\"><?php echo language::translate('title_general', 'General'); ?></a></li>\n    <li><a data-toggle=\"tab\" href=\"#tab-information\"><?php echo language::translate('title_information', 'Information'); ?></a></li>\n    <li><a data-toggle=\"tab\" href=\"#tab-attributes\"><?php echo language::translate('title_attributes', 'Attributes'); ?></a></li>\n    <li><a data-toggle=\"tab\" href=\"#tab-prices\"><?php echo language::translate('title_prices', 'Prices'); ?></a></li>\n    <li><a data-toggle=\"tab\" href=\"#tab-options\"><?php echo language::translate('title_options', 'Options'); ?></a></li>\n    <li><a data-toggle=\"tab\" href=\"#tab-stock\"><?php echo language::translate('title_stock', 'Stock'); ?></a></li>\n  </ul>\n\n  <div class=\"panel-body\">\n    <?php echo functions::form_draw_form_begin('product_form', 'post', false, true); ?>\n\n      <div class=\"tab-content\">\n        <div id=\"tab-general\" class=\"tab-pane active\" style=\"max-width: 1200px;\">\n\n          <div class=\"row\">\n            <div class=\"col-md-4\">\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_status', 'Status'); ?></label>\n                <?php echo functions::form_draw_toggle('status', isset($_POST['status']) ? $_POST['status'] : '0', 'e/d'); ?>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_categories', 'Categories'); ?></label>\n                <?php echo functions::form_draw_categories_list('categories[]', true, 'style=\"max-height: 480px;\"'); ?>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_default_category', 'Default Category'); ?></label>\n                <?php echo functions::form_draw_select_field('default_category_id', [], true); ?>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_date_valid_from', 'Date Valid From'); ?></label>\n                <?php echo functions::form_draw_date_field('date_valid_from', true); ?>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_date_valid_to', 'Date Valid To'); ?></label>\n                <?php echo functions::form_draw_date_field('date_valid_to', true); ?>\n              </div>\n\n              <?php if (!empty($product->data['id'])) { ?>\n              <div class=\"row\">\n                <div class=\"form-group col-md-6\">\n                  <label><?php echo language::translate('title_date_updated', 'Date Updated'); ?></label>\n                  <div><?php echo language::strftime('%e %b %Y %H:%M', strtotime($product->data['date_updated'])); ?></div>\n                </div>\n\n                <div class=\"form-group col-md-6\">\n                  <label><?php echo language::translate('title_date_created', 'Date Created'); ?></label>\n                  <div><?php echo language::strftime('%e %b %Y %H:%M', strtotime($product->data['date_created'])); ?></div>\n                </div>\n              </div>\n              <?php } ?>\n            </div>\n\n            <div class=\"col-md-4\">\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_name', 'Name'); ?></label>\n                 <?php foreach (array_keys(language::$languages) as $language_code) echo functions::form_draw_regional_input_field($language_code, 'name['. $language_code .']', true); ?>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_code', 'Code'); ?></label>\n                <?php echo functions::form_draw_text_field('code', true); ?>\n              </div>\n\n              <div class=\"form-group\">\n                <div class=\"input-group\">\n                  <label class=\"input-group-text\" style=\"width: 125px;\"><?php echo language::translate('title_sku', 'SKU'); ?> <a href=\"https://en.wikipedia.org/wiki/Stock_keeping_unit\" target=\"_blank\"><?php echo functions::draw_fonticon('fa-external-link'); ?></a></label>\n                  <?php echo functions::form_draw_text_field('sku', true); ?>\n                </div>\n\n                <div class=\"input-group\">\n                  <label class=\"input-group-text\" style=\"width: 125px;\"><?php echo language::translate('title_mpn', 'MPN'); ?> <a href=\"https://en.wikipedia.org/wiki/Manufacturer_part_number\" target=\"_blank\"><?php echo functions::draw_fonticon('fa-external-link'); ?></a></label>\n                  <?php echo functions::form_draw_text_field('mpn', true); ?>\n                </div>\n\n                <div class=\"input-group\">\n                  <label class=\"input-group-text\" style=\"width: 125px;\"><?php echo language::translate('title_gtin', 'GTIN'); ?> <a href=\"https://en.wikipedia.org/wiki/Global_Trade_Item_Number\" target=\"_blank\"><?php echo functions::draw_fonticon('fa-external-link'); ?></a></label>\n                  <?php echo functions::form_draw_text_field('gtin', true); ?>\n                </div>\n\n                <div class=\"input-group\">\n                  <label class=\"input-group-text\" style=\"width: 125px;\"><?php echo language::translate('title_taric', 'TARIC'); ?> <a href=\"https://en.wikipedia.org/wiki/TARIC_code\" target=\"_blank\"><?php echo functions::draw_fonticon('fa-external-link'); ?></a></label>\n                  <?php echo functions::form_draw_text_field('taric', true); ?>\n                </div>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_manufacturer', 'Manufacturer'); ?></label>\n                <?php echo functions::form_draw_manufacturers_list('manufacturer_id', true); ?>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_supplier', 'Supplier'); ?></label>\n                <?php echo functions::form_draw_suppliers_list('supplier_id', true); ?>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_keywords', 'Keywords'); ?></label>\n                <?php echo functions::form_draw_text_field('keywords', true); ?>\n              </div>\n            </div>\n\n            <div class=\"col-md-4\">\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_images', 'Images'); ?></label>\n                <div class=\"thumbnail\">\n<?php\n  if (isset($product->data['id']) && !empty($product->data['images'])) {\n    $image = current($product->data['images']);\n    echo '<img class=\"main-image\" src=\"'. document::href_link(WS_DIR_APP . functions::image_thumbnail(FS_DIR_APP . 'images/' . $image['filename'], $product_image_width, $product_image_height, settings::get('product_image_clipping'))) .'\" alt=\"\" />';\n    reset($product->data['images']);\n  } else {\n    echo '<img class=\"main-image\" src=\"'. document::href_link(WS_DIR_APP . functions::image_thumbnail(FS_DIR_APP . 'images/no_image.png', $product_image_width, $product_image_height, settings::get('product_image_clipping'))) .'\" alt=\"\" />';\n  }\n?>\n                </div>\n              </div>\n\n              <div id=\"images\">\n\n                <div class=\"images\">\n                  <?php if (!empty($_POST['images'])) foreach (array_keys($_POST['images']) as $key) { ?>\n                  <div class=\"image form-group\">\n                    <?php echo functions::form_draw_hidden_field('images['.$key.'][id]', true); ?>\n                    <?php echo functions::form_draw_hidden_field('images['.$key.'][filename]', $_POST['images'][$key]['filename']); ?>\n\n                    <div class=\"thumbnail float-start\">\n                      <img src=\"<?php echo document::href_link(WS_DIR_APP . functions::image_thumbnail(FS_DIR_APP . 'images/' . $product->data['images'][$key]['filename'], $product_image_width, $product_image_height, settings::get('product_image_clipping'))); ?>\" alt=\"\" />\n                    </div>\n\n                    <div class=\"input-group\">\n                      <?php echo functions::form_draw_text_field('images['.$key.'][new_filename]', isset($_POST['images'][$key]['new_filename']) ? $_POST['images'][$key]['new_filename'] : $_POST['images'][$key]['filename']); ?>\n                      <div class=\"input-group-text\">\n                        <a class=\"move-up\" href=\"#\" title=\"<?php echo language::translate('text_move_up', 'Move up'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-up fa-lg', 'style=\"color: #3399cc;\"'); ?></a>\n                        <a class=\"move-down\" href=\"#\" title=\"<?php echo language::translate('text_move_down', 'Move down'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-down fa-lg', 'style=\"color: #3399cc;\"'); ?></a>\n                        <a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"'); ?></a>\n                      </div>\n                    </div>\n                  </div>\n                  <?php } ?>\n                </div>\n\n                <div class=\"new-images\">\n                  <div class=\"image form-group\">\n                    <div class=\"thumbnail float-start\">\n                      <img src=\"<?php echo document::href_link(WS_DIR_APP . functions::image_thumbnail(FS_DIR_APP . 'images/no_image.png', $product_image_width, $product_image_height, settings::get('product_image_clipping'))); ?>\" alt=\"\" />\n                    </div>\n\n                    <div class=\"input-group\">\n                      <?php echo functions::form_draw_file_field('new_images[]'); ?>\n                      <div class=\"input-group-text\">\n                        <a class=\"move-up\" href=\"#\" title=\"<?php echo language::translate('text_move_up', 'Move up'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-up fa-lg', 'style=\"color: #3399cc;\"'); ?></a>\n                        <a class=\"move-down\" href=\"#\" title=\"<?php echo language::translate('text_move_down', 'Move down'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-down fa-lg', 'style=\"color: #3399cc;\"'); ?></a>\n                        <a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"'); ?></a>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n\n                <div class=\"form-group\">\n                  <a href=\"#\" class=\"add\" title=\"<?php echo language::translate('text_add', 'Add'); ?>\"><?php echo functions::draw_fonticon('fa-plus-circle', 'style=\"color: #66cc66;\"'); ?></a>\n                </div>\n              </div>\n            </div>\n          </div>\n\n        </div>\n\n        <div id=\"tab-information\" class=\"tab-pane\">\n\n          <ul class=\"nav nav-tabs\">\n            <?php foreach (language::$languages as $language) { ?>\n              <li<?php echo ($language['code'] == language::$selected['code']) ? ' class=\"active\"' : ''; ?>><a data-toggle=\"tab\" href=\"#<?php echo $language['code']; ?>\"><?php echo $language['name']; ?></a></li>\n            <?php } ?>\n          </ul>\n\n          <div class=\"tab-content\">\n\n            <?php foreach (array_keys(language::$languages) as $language_code) { ?>\n            <div id=\"<?php echo $language_code; ?>\" class=\"tab-pane fade in<?php echo ($language_code == language::$selected['code']) ? ' active' : ''; ?>\">\n\n              <div class=\"row\">\n                <div class=\"col-md-6\">\n\n                  <div class=\"form-group\">\n                    <label><?php echo language::translate('title_name', 'Name'); ?></label>\n                    <?php echo functions::form_draw_regional_input_field($language_code, 'name['. $language_code .']', true); ?>\n                  </div>\n\n                  <div class=\"form-group\">\n                    <label><?php echo language::translate('title_short_description', 'Short Description'); ?></label>\n                    <?php echo functions::form_draw_regional_input_field($language_code, 'short_description['. $language_code .']', true); ?>\n                  </div>\n\n                  <div class=\"form-group\">\n                    <label><?php echo language::translate('title_description', 'Description'); ?></label>\n                    <?php echo functions::form_draw_regional_wysiwyg_field($language_code, 'description['. $language_code .']', true, 'style=\"height: 250px;\"'); ?>\n                  </div>\n\n                  <div class=\"row\">\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_head_title', 'Head Title'); ?></label>\n                      <?php echo functions::form_draw_regional_input_field($language_code, 'head_title['. $language_code .']', true); ?>\n                    </div>\n\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_meta_description', 'Meta Description'); ?></label>\n                      <?php echo functions::form_draw_regional_input_field($language_code, 'meta_description['. $language_code .']', true); ?>\n                    </div>\n                  </div>\n                </div>\n\n                <div class=\"col-md-6\">\n                  <div class=\"form-group\">\n                    <label><?php echo language::translate('title_technical_data', 'Technical Data'); ?> <a class=\"technical-data-hint\" href=\"#\"><?php echo functions::draw_fonticon('fa-question-circle'); ?></a></label>\n                    <?php echo functions::form_draw_regional_textarea($language_code, 'technical_data['. $language_code .']', true, 'style=\"height: 480px;\"'); ?>\n                  </div>\n                </div>\n\n              </div>\n            </div>\n            <?php } ?>\n\n          </div>\n        </div>\n\n        <div id=\"tab-attributes\" class=\"tab-pane\" style=\"max-width: 960px;\">\n\n          <table class=\"table table-striped data-table\">\n            <thead>\n              <tr>\n                <th style=\"width: 320px;\"><?php echo language::translate('title_group', 'Group'); ?></th>\n                <th style=\"width: 320px;\"><?php echo language::translate('title_value', 'Value'); ?></th>\n                <th><?php echo language::translate('title_custom_value', 'Custom Value'); ?></th>\n                <th style=\"width: 60px;\"></th>\n              </tr>\n            </thead>\n            <tbody>\n              <?php if (!empty($_POST['attributes'])) foreach (array_keys($_POST['attributes']) as $key) { ?>\n              <tr>\n                <?php echo functions::form_draw_hidden_field('attributes['.$key.'][id]', true); ?>\n                <?php echo functions::form_draw_hidden_field('attributes['.$key.'][group_id]', true); ?>\n                <?php echo functions::form_draw_hidden_field('attributes['.$key.'][group_name]', true); ?>\n                <?php echo functions::form_draw_hidden_field('attributes['.$key.'][value_id]', true); ?>\n                <?php echo functions::form_draw_hidden_field('attributes['.$key.'][value_name]', true); ?>\n                <?php echo functions::form_draw_hidden_field('attributes['.$key.'][custom_value]', true); ?>\n                <td><?php echo $_POST['attributes'][$key]['group_name']; ?></td>\n                <td><?php echo $_POST['attributes'][$key]['value_name']; ?></td>\n                <td><?php echo $_POST['attributes'][$key]['custom_value']; ?></td>\n                <td class=\"text-end\"><a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"'); ?></a></td>\n              </tr>\n              <?php } ?>\n            </tbody>\n            <tfoot>\n              <tr>\n                <td><?php echo functions::form_draw_attribute_groups_list('new_attribute[group_id]', [], ''); ?></td>\n                <td><?php echo functions::form_draw_select_field('new_attribute[value_id]', [], ''); ?></td>\n                <td><?php echo functions::form_draw_text_field('new_attribute[custom_value]', ''); ?></td>\n                <td><?php echo functions::form_draw_button('add', language::translate('title_add', 'Add'), 'button'); ?></td>\n              </tr>\n            </tfoot>\n          </table>\n        </div>\n\n        <div id=\"tab-prices\" class=\"tab-pane\">\n\n          <div id=\"prices\" style=\"max-width: 640px;\">\n            <h2><?php echo language::translate('title_prices', 'Prices'); ?></h2>\n\n            <div class=\"row\">\n              <div class=\"form-group col-md-6\">\n                <label><?php echo language::translate('title_purchase_price', 'Purchase Price'); ?></label>\n                <div class=\"input-group\">\n                  <?php echo functions::form_draw_decimal_field('purchase_price', true, 2, 0, null); ?>\n                  <?php echo functions::form_draw_currencies_list('purchase_price_currency_code', true, false); ?>\n                </div>\n              </div>\n\n              <div class=\"form-group col-md-6\">\n                <label><?php echo language::translate('title_recommended_price', 'Recommended Price'); ?> / MSRP</label>\n                <?php echo functions::form_draw_currency_field(settings::get('store_currency_code'), 'recommended_price', true); ?>\n              </div>\n\n              <div class=\"form-group col-md-6\">\n                <label><?php echo language::translate('title_tax_class', 'Tax Class'); ?></label>\n                <?php echo functions::form_draw_tax_classes_list('tax_class_id', true); ?>\n              </div>\n            </div>\n\n            <table class=\"table table-striped data-table\">\n              <thead>\n                <tr>\n                  <td style=\"width: 50%;\"><?php echo language::translate('title_price', 'Price'); ?></td>\n                  <td style=\"width: 50%;\"><?php echo language::translate('title_price_incl_tax', 'Price Incl. Tax'); ?> (<a id=\"price-incl-tax-tooltip\" href=\"#\">?</a>)</td>\n                </tr>\n              </thead>\n              <tbody>\n                <tr>\n                  <td><?php echo functions::form_draw_currency_field(settings::get('store_currency_code'), 'prices['. settings::get('store_currency_code') .']', true, 'data-currency-price=\"\" placeholder=\"\"'); ?></td>\n                  <td><?php echo functions::form_draw_decimal_field('gross_prices['. settings::get('store_currency_code') .']', '', currency::$currencies[settings::get('store_currency_code')]['decimals'], 0, null, 'placeholder=\"\"'); ?></td>\n                </tr>\n<?php\n  foreach (currency::$currencies as $currency) {\n    if ($currency['code'] == settings::get('store_currency_code')) continue;\n?>\n                <tr>\n                  <td><?php echo functions::form_draw_currency_field($currency['code'], 'prices['. $currency['code'] .']', true, 'data-currency-price=\"\" placeholder=\"\"'); ?></td>\n                  <td><?php echo functions::form_draw_decimal_field('gross_prices['. $currency['code'] .']', '', $currency['decimals'], 0, null, 'placeholder=\"\"'); ?></td>\n                </tr>\n<?php\n  }\n?>\n              </tbody>\n            </table>\n          </div>\n\n          <h2><?php echo language::translate('title_campaigns', 'Campaigns'); ?></h2>\n          <div class=\"table-responsive\">\n            <table id=\"table-campaigns\" class=\"table table-striped data-table\">\n              <tbody>\n                <?php if (!empty($_POST['campaigns'])) foreach (array_keys($_POST['campaigns']) as $key) { ?>\n                <tr>\n                  <td><?php echo language::translate('title_start_date', 'Start Date'); ?><br />\n                    <?php echo functions::form_draw_hidden_field('campaigns['.$key.'][id]', true) . functions::form_draw_datetime_field('campaigns['.$key.'][start_date]', true); ?>\n                  </td>\n                  <td><?php echo language::translate('title_end_date', 'End Date'); ?><br />\n                    <?php echo functions::form_draw_datetime_field('campaigns['.$key.'][end_date]', true); ?>\n                  </td>\n                  <td>- %<br />\n                    <?php echo functions::form_draw_decimal_field('campaigns['.$key.'][percentage]', '', 2, 0, null); ?>\n                  </td>\n                  <td><?php echo settings::get('store_currency_code'); ?><br />\n                    <?php echo functions::form_draw_currency_field(settings::get('store_currency_code'), 'campaigns['.$key.']['. settings::get('store_currency_code') .']', true); ?>\n                  </td>\n<?php\n  foreach (array_keys(currency::$currencies) as $currency_code) {\n    if ($currency_code == settings::get('store_currency_code')) continue;\n?>\n                  <td><?php echo $currency_code; ?><br />\n                    <?php echo functions::form_draw_currency_field($currency_code, 'campaigns['.$key.']['. $currency_code. ']', isset($_POST['campaigns'][$key][$currency_code]) ? number_format((float)$_POST['campaigns'][$key][$currency_code], 4, '.', '') : ''); ?>\n                  </td>\n<?php\n  }\n?>\n                  <td><br /><a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"'); ?></a></td>\n                </tr>\n              <?php } ?>\n              </tbody>\n              <tfoot>\n                <tr>\n                  <td colspan=\"<?php echo 5 + count(currency::$currencies) - 1; ?>\"><?php echo functions::draw_fonticon('fa-plus-circle', 'style=\"color: #66cc66;\"'); ?> <a class=\"add\" href=\"#\"><?php echo language::translate('text_add_campaign', 'Add Campaign'); ?></a></td>\n                </tr>\n              </tfoot>\n            </table>\n          </div>\n        </div>\n<style>\n#tab-options li {\n  background: #f9f9f9;\n  padding: 1em;\n  border-radius: 4px;\n  margin-bottom: 2em;\n  border: 1px solid #ececec;\n}\n</style>\n        <div id=\"tab-options\" class=\"tab-pane\">\n\n          <ul id=\"options\" class=\"list-unstyled\">\n            <?php foreach ($_POST['options'] as $group_id => $option) { ?>\n            <li data-group-id=\"<?php echo functions::escape_html($group_id); ?>\" data-group-name=\"<?php echo functions::escape_html($option['name']); ?>\">\n\n              <div class=\"float-end\">\n                <a class=\"move-group-up\" href=\"#\" title=\"<?php echo language::translate('text_move_up', 'Move up'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-up fa-2x', 'style=\"color: #3399cc;\"'); ?></a>\n                <a class=\"move-group-down\" href=\"#\" title=\"<?php echo language::translate('text_move_down', 'Move down'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-down fa-2x', 'style=\"color: #3399cc;\"'); ?></a>\n                <a class=\"remove-group\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-2x', 'style=\"color: #cc3333;\"'); ?></a>\n              </div>\n\n              <h2><?php echo $option['name']; ?></h2>\n              <?php echo functions::form_draw_hidden_field('options['.$group_id.'][id]', true) . functions::form_draw_hidden_field('options['.$group_id.'][group_id]', true) . functions::form_draw_hidden_field('options['.$group_id.'][name]', true); ?>\n\n              <div class=\"row\">\n                <div class=\"form-group col-sm-4 col-md-2\">\n                  <label><?php echo language::translate('title_function', 'Function'); ?></label>\n                  <?php echo functions::form_draw_select_field('options['.$group_id.'][function]', in_array($option['function'], ['select', 'radio', 'checkbox']) ? ['select', 'radio', 'checkbox'] : ['text', 'textarea'], true); ?>\n                </div>\n\n                <?php if (in_array($option['function'], ['select', 'radio', 'checkbox'])) { ?>\n                <div class=\"form-group col-sm-4 col-md-2\">\n                  <label><?php echo language::translate('title_sort_values', 'Sort Values'); ?></label>\n                  <?php echo functions::form_draw_select_field('options['.$group_id.'][sort]', $option_sort_options, true); ?>\n                </div>\n                <?php } ?>\n\n                <div class=\"form-group col-sm-4 col-md-2\">\n                  <label><?php echo language::translate('title_required', 'Required'); ?></label>\n                  <div class=\"checkbox\">\n                    <label><?php echo functions::form_draw_checkbox('options['.$group_id.'][required]', '1', true); ?> <?php echo language::translate('title_required', 'Required'); ?></label>\n                  </div>\n                </div>\n              </div>\n\n              <?php if (in_array($option['function'], ['select', 'radio', 'checkbox'])) { ?>\n              <div class=\"table-responsive\">\n                <table class=\"table table-striped table-hover table-dragable data-table\">\n                  <thead>\n                    <tr>\n                      <th class=\"main\"><?php echo language::translate('title_option', 'Option'); ?></th>\n                      <th style=\"width: 150px;\"><?php echo language::translate('title_price_operator', 'Price Operator'); ?></th>\n                      <th colspan=\"<?php echo count(currency::$currencies); ?>\"><?php echo language::translate('title_price_adjustment', 'Price Adjustment'); ?></th>\n                      <th style=\"width: 85px;\">&nbsp;</th>\n                    </tr>\n                  </thead>\n\n                  <tbody>\n                  <?php foreach ($option['values'] as $value_id => $value) { ?>\n                    <tr data-value-id=\"<?php echo functions::escape_html($value['value_id']); ?>\" data-value-name=\"<?php echo functions::escape_html($_POST['options'][$group_id]['values'][$value_id]['name']); ?>\">\n                      <td class=\"grabable\"><?php echo functions::form_draw_hidden_field('options['.$group_id.'][values]['. $value_id .'][id]', true) . functions::form_draw_hidden_field('options['.$group_id.'][values]['. $value_id .'][value_id]', true) . functions::form_draw_hidden_field('options['.$group_id.'][values]['. $value_id .'][custom_value]', true) . functions::form_draw_hidden_field('options['.$group_id.'][values]['. $value_id .'][name]', true); ?><?php echo $value['name']; ?></td>\n                      <td style=\"text-align: center;\"><?php echo functions::form_draw_select_field('options['.$group_id.'][values]['. $value_id .'][price_operator]', ['+','%','*','='], true); ?></td>\n                      <?php foreach (array_keys(currency::$currencies) as $currency_code) echo '<td>'. functions::form_draw_currency_field($currency_code, 'options['.$group_id.'][values]['. $value_id .']['. $currency_code. ']', (!empty($_POST['options'][$group_id]['values'][$value_id][$currency_code]) || $_POST['options'][$group_id]['values'][$value_id][$currency_code] != 0) ? true : '', 'style=\"width: 100px;\"') .'</td>'; ?>\n                      <td class=\"text-end\"><a class=\"move-up\" href=\"#\" title=\"<?php echo language::translate('text_move_up', 'Move up'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-up fa-lg', 'style=\"color: #3399cc;\"'); ?></a> <a class=\"move-down\" href=\"#\" title=\"<?php echo language::translate('text_move_down', 'Move down'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-down fa-lg', 'style=\"color: #3399cc;\"'); ?></a> <a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"'); ?></a></td>\n                    </tr>\n                  <?php } ?>\n                  </tbody>\n                </table>\n              </div>\n              <?php } ?>\n\n            </li>\n            <?php } ?>\n          </ul>\n\n          <div>\n            <a class=\"btn btn-default\" href=\"#modal-predefined-option\" data-toggle=\"lightbox\"><?php echo functions::draw_fonticon('fa-plus-circle', 'style=\"color: #66cc66;\"'); ?> <?php echo language::translate('title_add_predefined_option', 'Add Predefined Option'); ?></a>\n            <a class=\"btn btn-default\" href=\"#modal-user-input-option\" data-toggle=\"lightbox\"><?php echo functions::draw_fonticon('fa-plus-circle', 'style=\"color: #66cc66;\"'); ?> <?php echo language::translate('title_add_user_input_option', 'Add User Input Option'); ?></a>\n          </div>\n\n          <div id=\"modal-predefined-option\" style=\"display: none;\">\n            <fieldset style=\"max-width: 960px;\">\n              <legend><?php echo language::translate('title_add_predefined_option', 'Add Predefined Option'); ?></legend>\n              <div class=\"row\" style=\"margin-bottom: 0;\">\n                <div class=\"form-group col-md-3\">\n                  <label><?php echo language::translate('title_attribute_group', 'Attribute Group'); ?></label>\n                  <?php echo functions::form_draw_attribute_groups_list('new_predefined_option[group_id]', ''); ?>\n                </div>\n\n                <div class=\"form-group col-md-3\">\n                  <label><?php echo language::translate('title_value', 'Value'); ?></label>\n                  <?php echo functions::form_draw_select_field('new_predefined_option[value_id]', [['','']], '', 'disabled'); ?>\n                </div>\n\n                <div class=\"form-group col-md-3\">\n                  <label><?php echo language::translate('title_custom_value', 'Custom Value'); ?></label>\n                  <?php echo functions::form_draw_text_field('new_predefined_option[custom_value]', ''); ?>\n                </div>\n\n                <div class=\"col-md-3\" style=\"align-self: end;\">\n                  <?php echo functions::form_draw_button('add_predefined_option', language::translate('title_add', 'Add'), 'button', 'class=\"btn btn-default btn-block\"'); ?>\n                </div>\n              </div>\n            </fieldset>\n          </div>\n\n          <div id=\"modal-user-input-option\" style=\"display: none;\">\n            <fieldset>\n              <legend><?php echo language::translate('title_add_user_input_option', 'Add User Input Option'); ?></legend>\n              <div class=\"row\" style=\"margin-bottom: 0;\">\n                <div class=\"form-group col-md-8\">\n                  <label><?php echo language::translate('title_attribute_group', 'Attribute Group'); ?></label>\n                  <?php echo functions::form_draw_attribute_groups_list('new_user_input_option[group_id]', ''); ?>\n                </div>\n                <div class=\"col-md-4\" style=\"align-self: end;\">\n                  <?php echo functions::form_draw_button('add_user_input_option', language::translate('title_add', 'Add'), 'button', 'class=\"btn btn-default btn-block\"'); ?>\n                </div>\n              </div>\n            </fieldset>\n          </div>\n        </div>\n\n        <div id=\"tab-stock\" class=\"tab-pane\">\n          <h2><?php echo language::translate('title_stock', 'Stock'); ?></h2>\n\n          <div class=\"row\" style=\"max-width: 640px;\">\n            <div class=\"form-group col-md-3\">\n              <label><?php echo language::translate('title_min_order_qty', 'Min. Order Qty'); ?></label>\n              <?php echo functions::form_draw_decimal_field('quantity_min', true, 2, 0); ?>\n            </div>\n\n            <div class=\"form-group col-md-3\">\n              <label><?php echo language::translate('title_max_order_quantity', 'Max. Order Qty'); ?></label>\n              <?php echo functions::form_draw_decimal_field('quantity_max', true, 2, 0); ?>\n            </div>\n\n            <div class=\"form-group col-md-3\">\n              <label><?php echo language::translate('title_quantity_step', 'Quantity Step'); ?></label>\n              <?php echo functions::form_draw_decimal_field('quantity_step', true, 2, 0); ?>\n            </div>\n\n            <div class=\"form-group col-md-3\">\n              <label><?php echo language::translate('title_quantity_unit', 'Quantity Unit'); ?></label>\n              <?php echo functions::form_draw_quantity_units_list('quantity_unit_id', true, false); ?>\n            </div>\n          </div>\n\n          <div class=\"row\" style=\"max-width: 640px;\">\n            <div class=\"form-group col-md-6\">\n              <label><?php echo language::translate('title_delivery_status', 'Delivery Status'); ?></label>\n              <?php echo functions::form_draw_delivery_statuses_list('delivery_status_id', true); ?>\n            </div>\n\n            <div class=\"form-group col-md-6\">\n              <label><?php echo language::translate('title_sold_out_status', 'Sold Out Status'); ?></label>\n              <?php echo functions::form_draw_sold_out_statuses_list('sold_out_status_id', true); ?>\n            </div>\n\n          </div>\n\n          <div class=\"table-responsive\">\n            <table id=\"table-stock\" class=\"table table-striped table-hover data-table\">\n              <thead>\n                <tr>\n                  <th><?php echo language::translate('title_option', 'Option'); ?></th>\n                  <th style=\"width: 250px;\"><?php echo language::translate('title_sku', 'SKU'); ?></th>\n                  <th style=\"width: 185px;\"><?php echo language::translate('title_weight', 'Weight'); ?></th>\n                  <th style=\"width: 400px;\"><?php echo language::translate('title_dimensions', 'Dimensions'); ?></th>\n                  <th class=\"text-center\" style=\"width: 125px;\"><?php echo language::translate('title_quantity', 'Quantity'); ?></th>\n                  <th class=\"text-center\" style=\"width: 150px;\"><?php echo language::translate('title_adjust', 'Adjust'); ?></th>\n                  <th style=\"width: 85px;\">&nbsp;</th>\n                </tr>\n              </thead>\n              <tbody>\n                <tr>\n                  <td><strong><?php echo language::translate('title_default_item', 'Default Item'); ?></strong></td>\n                  <td><?php echo functions::form_draw_text_field('sku', true); ?></td>\n                  <td>\n                    <div class=\"input-group\">\n                      <?php echo functions::form_draw_decimal_field('weight', true, 4, 0); ?>\n                      <?php echo functions::form_draw_weight_classes_list('weight_class', true); ?>\n                    </div>\n                  </td>\n                  <td>\n                    <div class=\"input-group\">\n                      <?php echo functions::form_draw_decimal_field('dim_x', true, 4, 0); ?>\n                      <?php echo functions::form_draw_decimal_field('dim_y', true, 4, 0); ?>\n                      <?php echo functions::form_draw_decimal_field('dim_z', true, 4, 0); ?>\n                      <?php echo functions::form_draw_length_classes_list('dim_class', true); ?>\n                    </div>\n                  </td>\n                  <td><?php echo functions::form_draw_decimal_field('quantity', true, 2, null, null, 'data-quantity=\"'. (float)$product->data['quantity'] .'\"' . (!empty($_POST['options_stock']) ? ' readonly' : '')); ?></td>\n                  <td>\n                    <div class=\"input-group\">\n                      <span class=\"input-group-text\">&plusmn;</span>\n                      <?php echo functions::form_draw_decimal_field('quantity_adjustment', true, 2, null, null, !empty($_POST['options_stock']) ? 'readonly' : ''); ?>\n                    </div>\n                  </td>\n                  <td></td>\n                </tr>\n                <?php if (!empty($_POST['options_stock'])) foreach (array_keys($_POST['options_stock']) as $key) { ?>\n                <tr>\n                  <td><?php echo functions::form_draw_hidden_field('options_stock['.$key.'][id]', true); ?><?php echo functions::form_draw_hidden_field('options_stock['.$key.'][combination]', true); ?>\n                    <?php echo functions::form_draw_hidden_field('options_stock['.$key.'][name]['. language::$selected['name'] .']', true); ?>\n                    <?php echo $_POST['options_stock'][$key]['name'][language::$selected['code']]; ?></td>\n                  <td><?php echo functions::form_draw_text_field('options_stock['.$key.'][sku]', true); ?></td>\n                  <td>\n                    <div class=\"input-group\">\n                      <?php echo functions::form_draw_decimal_field('options_stock['.$key.'][weight]', true, 4, 0); ?>\n                      <?php echo functions::form_draw_weight_classes_list('options_stock['.$key.'][weight_class]', true); ?>\n                    </div>\n                  </td>\n                  <td>\n                    <div class=\"input-group\">\n                      <?php echo functions::form_draw_decimal_field('options_stock['.$key.'][dim_x]', true, 4, 0); ?>\n                      <?php echo functions::form_draw_decimal_field('options_stock['.$key.'][dim_y]', true, 4, 0); ?>\n                      <?php echo functions::form_draw_decimal_field('options_stock['.$key.'][dim_z]', true, 4, 0); ?>\n                      <?php echo functions::form_draw_length_classes_list('options_stock['.$key.'][dim_class]', true); ?>\n                    </div>\n                  </td>\n                  <td><?php echo functions::form_draw_decimal_field('options_stock['.$key.'][quantity]', true, 2, null, null, 'data-quantity=\"'. (isset($product->data['options_stock'][$key]['quantity']) ? (float)$product->data['options_stock'][$key]['quantity'] : '0') .'\"'); ?></td>\n                  <td>\n                    <div class=\"input-group\">\n                      <span class=\"input-group-text\">&plusmn;</span>\n                      <?php echo functions::form_draw_decimal_field('options_stock['.$key.'][quantity_adjustment]', true); ?>\n                    </div>\n                  </td>\n                  <td class=\"text-end\">\n                    <a class=\"move-up\" href=\"#\" title=\"<?php echo language::translate('text_move_up', 'Move up'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-up fa-lg', 'style=\"color: #3399cc;\"'); ?></a>\n                    <a class=\"move-down\" href=\"#\" title=\"<?php echo language::translate('text_move_down', 'Move down'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-down fa-lg', 'style=\"color: #3399cc;\"'); ?></a>\n                    <a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"'); ?></a>\n                  </td>\n                </tr>\n              <?php } ?>\n              </tbody>\n              <tfoot>\n                <tr>\n                  <td colspan=\"7\"><?php echo functions::draw_fonticon('fa-plus-circle', 'style=\"color: #66cc66;\"'); ?> <a class=\"add\" href=\"#\"><?php echo language::translate('title_add_stock_option', 'Add Stock Option'); ?></a></td>\n                </tr>\n              </tfoot>\n            </table>\n          </div>\n\n          <div id=\"new-stock-option\" class=\"lightbox\" style=\"display: none; max-width: 640px;\">\n            <h3 class=\"title\"><?php echo language::translate('title_create_stock_option_from_combination_of_options', 'Create a new stock option from a combination of options'); ?></h3>\n\n            <table class=\"table table-striped\" style=\"width: 100%;\">\n              <thead>\n                <tr>\n                  <th></th>\n                  <th style=\"width: 50%;\"><?php echo language::translate('title_group', 'Group'); ?></th>\n                  <th style=\"width: 50%;\"><?php echo language::translate('title_value', 'Value'); ?></th>\n                </tr>\n              </thead>\n              <tbody />\n            </table>\n\n            <button type=\"button\" class=\"btn btn-default\" name=\"add_stock_option\"><?php echo language::translate('title_add_stock_option', 'Add Stock Option'); ?></button>\n          </div>\n        </div>\n      </div>\n\n      <div class=\"panel-action btn-group\">\n        <?php echo functions::form_draw_button('save', language::translate('title_save', 'Save'), 'submit', '', 'save'); ?>\n        <?php echo functions::form_draw_button('cancel', language::translate('title_cancel', 'Cancel'), 'button', 'onclick=\"history.go(-1);\"', 'cancel'); ?>\n        <?php echo (isset($product->data['id'])) ? functions::form_draw_button('delete', language::translate('title_delete', 'Delete'), 'submit', 'formnovalidate onclick=\"if (!window.confirm(\\''. language::translate('text_are_you_sure', 'Are you sure?') .'\\')) return false;\"', 'delete') : false; ?>\n      </div>\n\n    <?php echo functions::form_draw_form_end(); ?>\n  </div>\n</div>\n\n<script>\n\n// Initiate\n\n  $('input[name^=\"name\"]').on('input', function(e){\n    var language_code = $(this).attr('name').match(/\\[(.*)\\]$/)[1];\n    $('.nav-tabs a[href=\"#'+language_code+'\"]').css('opacity', $(this).val() ? 1 : .5);\n    $('input[name=\"name['+language_code+']\"]').not(this).val($(this).val());\n    $('input[name=\"head_title['+language_code+']\"]').attr('placeholder', $(this).val());\n    $('input[name=\"h1_title['+language_code+']\"]').attr('placeholder', $(this).val());\n  }).trigger('input');\n\n  $('input[name^=\"short_description\"]').on('input', function(e){\n    var language_code = $(this).attr('name').match(/\\[(.*)\\]$/)[1];\n    $('input[name=\"meta_description['+language_code+']\"]').attr('placeholder', $(this).val());\n  }).trigger('input');\n\n// Default Category\n\n  $('[data-toggle=\"category-picker\"]').on('change', function() {\n    var default_category_id = $('select[name=\"default_category_id\"]').val();\n\n    $('select[name=\"default_category_id\"]').html('');\n\n    $('input[name=\"categories[]\"]').each(function() {\n      $('select[name=\"default_category_id\"]').append('<option value=\"'+ $(this).val() +'\">'+ $(this).data('name') +'</option>');\n    });\n\n    $('select[name=\"default_category_id\"] option[value=\"'+ default_category_id +'\"]').prop('selected', true);\n  }).trigger('change');\n\n  $('select[name=\"default_category_id\"]').val('<?php echo $product->data['default_category_id']; ?>');\n\n// SKU\n\n  $('input[name=\"sku\"]').change(function() {\n    $('input[name=\"sku\"]').not(this).val($(this).val());\n  });\n\n// Images\n\n  $('#images').on('click', '.move-up, .move-down', function(e) {\n    e.preventDefault();\n    var row = $(this).closest('.form-group');\n\n    if ($(this).is('.move-up') && $(row).prevAll().length > 0) {\n      $(row).insertBefore(row.prev());\n    } else if ($(this).is('.move-down') && $(row).nextAll().length > 0) {\n      $(row).insertAfter($(row).next());\n    }\n    refreshMainImage();\n  });\n\n  $('#images').on('click', '.remove', function(e) {\n    e.preventDefault();\n    $(this).closest('.form-group').remove();\n    refreshMainImage();\n  });\n\n  $('#images .add').click(function(e) {\n    e.preventDefault();\n    var output = '<div class=\"image form-group\">'\n               + '  <div class=\"thumbnail float-start\">'\n               + '    <img src=\"<?php echo document::href_link(WS_DIR_APP . functions::image_thumbnail(FS_DIR_APP . 'images/no_image.png', $product_image_width, $product_image_height, settings::get('product_image_clipping'))); ?>\" alt=\"\" />'\n               + '  </div>'\n               + '  '\n               + '  <div class=\"input-group\">'\n               + '    <?php echo functions::form_draw_file_field('new_images[]'); ?>'\n               + '    <div class=\"input-group-text\">'\n               + '      <a class=\"move-up\" href=\"#\" title=\"<?php echo language::translate('text_move_up', 'Move up'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-up fa-lg', 'style=\"color: #3399cc;\"'); ?></a>'\n               + '      <a class=\"move-down\" href=\"#\" title=\"<?php echo language::translate('text_move_down', 'Move down'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-down fa-lg', 'style=\"color: #3399cc;\"'); ?></a>'\n               + '      <a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"'); ?></a>'\n               + '    </div>'\n               + '  </div>'\n               + '</div>';\n    $('#images .new-images').append(output);\n    refreshMainImage();\n  });\n\n  $('#images').on('change', 'input[type=\"file\"]', function(e) {\n    var img = $(this).closest('.form-group').find('img');\n\n    var oFReader = new FileReader();\n    oFReader.readAsDataURL(this.files[0]);\n    oFReader.onload = function(e){\n      $(img).attr('src', e.target.result);\n    };\n    oFReader.onloadend = function(e) {\n      refreshMainImage();\n    };\n  });\n\n  function refreshMainImage() {\n    if ($('#images img:first').length) {\n      $('#tab-general .main-image').attr('src', $('#images img:first').attr('src'));\n      return;\n    }\n\n    $('#tab-general .main-image').attr('src', '<?php echo document::href_link(WS_DIR_APP . functions::image_thumbnail(FS_DIR_APP . 'images/no_image.png', $product_image_width, $product_image_height, settings::get('product_image_clipping'))); ?>');\n  }\n\n// Technical Data\n\n  $('a.technical-data-hint').click(function(e){\n    e.preventDefault();\n    alert('Syntax:\\n\\nTitle1\\nProperty1: Value1\\nProperty2: Value2\\n\\nTitle2\\nProperty3: Value3...');\n  });\n\n// Attributes\n\n  $('select[name=\"new_attribute[group_id]\"]').change(function(){\n    $('body').css('cursor', 'wait');\n    $.ajax({\n      url: '<?php echo document::link(WS_DIR_ADMIN, ['doc' => 'attribute_values.json'], ['app']); ?>&group_id=' + $(this).val(),\n      type: 'get',\n      cache: true,\n      async: true,\n      dataType: 'json',\n      error: function(jqXHR, textStatus, errorThrown) {\n        alert(jqXHR.readyState + '\\n' + textStatus + '\\n' + errorThrown.message);\n      },\n      success: function(data) {\n        $('select[name=\"new_attribute[value_id]\"').html('');\n        if ($('select[name=\"new_attribute[value_id]\"').attr('disabled')) $('select[name=\"attribute[value_id]\"]').prop('disabled', false);\n        if (data) {\n          $('select[name=\"new_attribute[value_id]\"').append('<option value=\"0\">-- <?php echo language::translate('title_select', 'Select'); ?> --</option>');\n          $.each(data, function(i, zone) {\n            $('select[name=\"new_attribute[value_id]\"').append('<option value=\"'+ zone.id +'\">'+ zone.name +'</option>');\n          });\n        } else {\n          $('select[name=\"new_attribute[value_id]\"').prop('disabled', true);\n        }\n      },\n      complete: function() {\n        $('body').css('cursor', 'auto');\n      }\n    });\n  });\n\n  var new_attribute_i = 0;\n  $('#tab-attributes button[name=\"add\"]').click(function(){\n\n    if ($('select[name=\"new_attribute[group_id]\"]').val() == '') {\n      alert(\"<?php echo language::translate('error_must_select_attribute_group', 'You must select an attribute group'); ?>\");\n      return;\n    }\n\n    if ($('select[name=\"new_attribute[value_id]\"]').val() == '' || $('select[name=\"new_attribute[value_id]\"]').val() == '0') {\n      if ($('input[name=\"new_attribute[custom_value]\"]').val() == '') {\n        alert(\"<?php echo language::translate('error_must_select_attribute_value', 'You must select an attribute value'); ?>\");\n        return;\n      }\n    } else {\n      if ($('input[name=\"new_attribute[custom_value]\"]').val() != '') {\n        alert(\"<?php echo language::translate('error_cannot_define_both_value_and_custom_value', 'You can not define both a value and a custom value'); ?>\");\n        return;\n      }\n    }\n\n    var output = '<tr>'\n               + '  <?php echo functions::escape_js(functions::form_draw_hidden_field('attributes[new_attribute_i][id]', '')); ?>'\n               + '  <?php echo functions::escape_js(functions::form_draw_hidden_field('attributes[new_attribute_i][group_id]', 'new_group_id')); ?>'\n               + '  <?php echo functions::escape_js(functions::form_draw_hidden_field('attributes[new_attribute_i][group_name]', 'new_group_name')); ?>'\n               + '  <?php echo functions::escape_js(functions::form_draw_hidden_field('attributes[new_attribute_i][value_id]', 'new_value_id')); ?>'\n               + '  <?php echo functions::escape_js(functions::form_draw_hidden_field('attributes[new_attribute_i][value_name]', 'new_value_name')); ?>'\n               + '  <?php echo functions::escape_js(functions::form_draw_hidden_field('attributes[new_attribute_i][custom_value]', 'new_custom_value')); ?>'\n               + '  <td>new_group_name</td>'\n               + '  <td>new_value_name</td>'\n               + '  <td>new_custom_value</td>'\n               + '  <td class=\"text-end\"><a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"'); ?></a></td>'\n               + '</tr>';\n\n    while ($('input[name=\"attributes[new_'+new_attribute_i+']\"]').length) new_attribute_i++;\n    output = output.replace(/new_attribute_i/g, 'new_' + new_attribute_i);\n    output = output.replace(/new_group_id/g, $('select[name=\"new_attribute[group_id]\"] option:selected').val());\n    output = output.replace(/new_group_name/g, $('select[name=\"new_attribute[group_id]\"] option:selected').text());\n    output = output.replace(/new_value_id/g, $('select[name=\"new_attribute[value_id]\"] option:selected').val());\n    if ($('select[name=\"new_attribute[value_id]\"] option:selected').val() != '0') {\n      output = output.replace(/new_value_name/g, $('select[name=\"new_attribute[value_id]\"] option:selected').text());\n    } else {\n      output = output.replace(/new_value_name/g, '');\n    }\n    output = output.replace(/new_custom_value/g, $('input[name=\"new_attribute[custom_value]\"]').val());\n    new_attribute_i++;\n\n    $('#tab-attributes tbody').append(output);\n  });\n\n  $('#tab-attributes tbody').on('click', '.remove', function(e) {\n    e.preventDefault();\n    $(this).closest('tr').remove();\n  });\n\n// Prices\n\n  function get_tax_rate() {\n    switch ($('select[name=tax_class_id]').val()) {\n<?php\n  $tax_classes_query = database::query(\n    \"select * from \". DB_TABLE_PREFIX .\"tax_classes\n    order by name asc;\"\n  );\n  while ($tax_class = database::fetch($tax_classes_query)) {\n    echo '      case \"'. $tax_class['id'] . '\": return '. tax::get_tax(100, $tax_class['id'], 'store') .';';\n  }\n?>\n      default: return 0;\n    }\n  }\n\n  function get_currency_value(currency_code) {\n    switch (currency_code) { <?php foreach (currency::$currencies as $currency) echo 'case \\''. $currency['code'] .'\\': return '. (float)$currency['value'] .'; '; ?> }\n  }\n\n  function get_currency_decimals(currency_code) {\n    switch (currency_code) { <?php foreach (currency::$currencies as $currency) echo 'case \\''. $currency['code'] .'\\': return '. ($currency['decimals']+2) .'; '; ?> }\n  }\n\n// Update prices\n  $('select[name=\"tax_class_id\"]').on('change', function(){\n    $('input[name^=\"prices\"]').trigger('change');\n  });\n\n// Update gross price\n  $('input[name^=\"prices\"]').on('input', function() {\n    var currency_code = $(this).attr('name').match(/^prices\\[([A-Z]{3})\\]$/)[1],\n        decimals = get_currency_decimals(currency_code),\n        gross_field = $('input[name=\"gross_prices['+ currency_code +']\"]');\n\n    var gross_price = Number( parseFloat($(this).val() || 0) * (1 + (get_tax_rate()/100)) ).toFixed(decimals);\n\n    if ($(this).val() == 0) {\n      $(gross_field).val('');\n    } else {\n      $(gross_field).val(gross_price);\n    }\n\n    update_currency_prices();\n  }).trigger('input');\n\n// Update net price\n  $('input[name^=\"gross_prices\"]').on('input', function() {\n    var currency_code = $(this).attr('name').match(/^gross_prices\\[([A-Z]{3})\\]$/)[1],\n        decimals = get_currency_decimals(currency_code),\n        net_field = $('input[name=\"prices['+ currency_code +']\"]');\n\n    var net_price = Number( parseFloat($(this).val() || 0) / (1 + (get_tax_rate()/100)) ).toFixed(decimals);\n\n    if ($(this).val() == 0) {\n      $(net_field).val('');\n    } else {\n      $(net_field).val(net_price);\n    }\n\n    update_currency_prices();\n  });\n\n// Update price placeholders\n  function update_currency_prices() {\n    var store_currency_code = '<?php echo settings::get('store_currency_code'); ?>',\n        currencies = ['<?php echo implode(\"','\", array_keys(currency::$currencies)); ?>'],\n        net_price = $('input[name^=\"prices\"][name$=\"[<?php echo settings::get('store_currency_code'); ?>]\"]').val(),\n        gross_price = $('input[name^=\"gross_prices\"][name$=\"[<?php echo settings::get('store_currency_code'); ?>]\"]').val();\n\n    if (!net_price) net_price = $('input[name^=\"prices\"][name$=\"[<?php echo settings::get('store_currency_code'); ?>]\"]').attr('placeholder');\n    if (!gross_price) gross_price = $('input[name^=\"gross_prices\"][name$=\"[<?php echo settings::get('store_currency_code'); ?>]\"]').attr('placeholder');\n\n    $.each(currencies, function(i,currency_code){\n      if (currency_code == '<?php echo settings::get('store_currency_code'); ?>') return;\n\n      var currency_decimals = get_currency_decimals(currency_code),\n          currency_net_price = net_price / get_currency_value(currency_code);\n          currency_gross_price = gross_price / get_currency_value(currency_code);\n\n      currency_net_price = currency_net_price ? parseFloat(currency_net_price.toFixed(currency_decimals) || 0) : '';\n      currency_gross_price = currency_gross_price ? parseFloat(currency_gross_price.toFixed(currency_decimals) || 0) : '';\n\n      $('input[name=\"prices['+ currency_code +']\"]').attr('placeholder', currency_net_price);\n      $('input[name=\"gross_prices['+ currency_code +']\"]').attr('placeholder', currency_gross_price);\n    });\n  }\n\n  $('#price-incl-tax-tooltip').click(function(e) {\n    e.preventDefault;\n    alert('<?php echo str_replace([\"\\r\", \"\\n\", \"'\"], [\"\", \"\", \"\\\\'\"], language::translate('tooltip_field_price_incl_tax', 'This field helps you calculate gross price based on the store region tax. All prices input to database are always excluding tax.')); ?>');\n  });\n\n// Campaigns\n\n  $('#table-campaigns').on('input', 'input[name^=\"campaigns\"][name$=\"[percentage]\"]', function() {\n    var parent = $(this).closest('tr');\n\n    <?php foreach (currency::$currencies as $currency) { ?>\n    if ($('input[name^=\"prices\"][name$=\"[<?php echo $currency['code']; ?>]\"]').val() > 0) {\n      var value = Number($('input[name=\"prices[<?php echo $currency['code']; ?>]\"]').val() * (100 - $(this).val()) / 100).toFixed(<?php echo $currency['decimals']; ?>);\n      $(parent).find('input[name$=\"[<?php echo $currency['code']; ?>]\"]').val(value);\n    } else {\n      $(parent).find('input[name$=\"[<?php echo $currency['code']; ?>]\"]').val(\"\");\n    }\n    <?php } ?>\n\n    <?php foreach (currency::$currencies as $currency) { ?>\n    var value = Number($(parent).find('input[name^=\"campaigns\"][name$=\"[<?php echo settings::get('store_currency_code'); ?>]\"]').val() / <?php echo $currency['value']; ?>).toFixed(<?php echo $currency['decimals']; ?>);\n    $(parent).find('input[name^=\"campaigns\"][name$=\"[<?php echo $currency['code']; ?>]\"]').attr('placeholder', value);\n    <?php } ?>\n  });\n\n  $('#table-campaigns').on('input', 'input[name^=\"campaigns\"][name$=\"[<?php echo settings::get('store_currency_code'); ?>]\"]', function() {\n    var parent = $(this).closest('tr');\n    var percentage = ($('input[name=\"prices[<?php echo settings::get('store_currency_code'); ?>]\"]').val() - $(this).val()) / $('input[name=\"prices[<?php echo settings::get('store_currency_code'); ?>]\"]').val() * 100;\n    percentage = percentage.toFixed(2);\n    $(parent).find('input[name$=\"[percentage]\"]').val(percentage);\n\n    <?php foreach (currency::$currencies as $currency) { ?>\n    var value = 0;\n    value = $(parent).find('input[name^=\"campaigns\"][name$=\"[<?php echo settings::get('store_currency_code'); ?>]\"]').val() / <?php echo $currency['value']; ?>;\n    value = value.toFixed(<?php echo $currency['decimals']; ?>);\n    $(parent).find('input[name^=\"campaigns\"][name$=\"[<?php echo $currency['code']; ?>]\"]').attr(\"placeholder\", value);\n    if ($(parent).find('input[name^=\"campaigns\"][name$=\"[<?php echo $currency['code']; ?>]\"]').val() == 0) {\n      $(parent).find('input[name^=\"campaigns\"][name$=\"[<?php echo $currency['code']; ?>]\"]').val('');\n    }\n    <?php } ?>\n  });\n  $('input[name^=\"campaigns\"][name$=\"[<?php echo settings::get('store_currency_code'); ?>]\"]').trigger('input');\n\n  $('#table-campaigns').on('click', '.remove', function(e) {\n    e.preventDefault();\n    $(this).closest('tr').remove();\n  });\n\n  var new_campaign_i = 1;\n  $('#table-campaigns').on('click', '.add', function(e) {\n    e.preventDefault();\n    var output = '<tr>'\n               + '  <td><?php echo functions::escape_js(language::translate('title_start_date', 'Start Date')); ?><br />'\n               + '    <?php echo functions::escape_js(functions::form_draw_hidden_field('campaigns[new_campaign_i][id]', '') . functions::form_draw_datetime_field('campaigns[new_campaign_i][start_date]', '')); ?>'\n               + '  </td>'\n               + '  <td><?php echo functions::escape_js(language::translate('title_end_date', 'End Date')); ?><br />'\n               + '    <?php echo functions::escape_js(functions::form_draw_datetime_field('campaigns[new_campaign_i][end_date]', '')); ?>'\n               + '  </td>'\n               + '  <td>- %<br />'\n               + '    <?php echo functions::escape_js(functions::form_draw_decimal_field('campaigns[new_campaign_i][percentage]', '', 2, 0, null)); ?>'\n               + '  </td>'\n               + '  <td><?php echo functions::escape_js(settings::get('store_currency_code')); ?><br />'\n               + '    <?php echo functions::escape_js(functions::form_draw_currency_field(settings::get('store_currency_code'), 'campaigns[new_campaign_i]['. settings::get('store_currency_code') .']', '')); ?>'\n               + '  </td>'\n<?php\n  foreach (array_keys(currency::$currencies) as $currency_code) {\n    if ($currency_code == settings::get('store_currency_code')) continue;\n?>\n               + '  <td><?php echo functions::escape_js($currency_code); ?><br />'\n               + '    <?php echo functions::escape_js(functions::form_draw_currency_field($currency_code, 'campaigns[new_campaign_i]['. $currency_code .']', '')); ?>'\n               + '  </td>'\n<?php\n  }\n?>\n               + '  <td><br /><a class=\"remove\" href=\"#\" title=\"<?php echo functions::escape_js(language::translate('title_remove', 'Remove'), true); ?>\"><?php echo functions::escape_js(functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"')); ?></a></td>'\n               + '</tr>';\n    while ($('input[name=\"campaigns[new_'+new_campaign_i+']\"]').length) new_campaign_i++;\n    output = output.replace(/new_campaign_i/g, 'new_' + new_campaign_i);\n    $('#table-campaigns tbody').append(output);\n    new_campaign_i++;\n  });\n\n// Options\n\n  $('#tab-options').on('click', '.remove-group', function(e) {\n    e.preventDefault();\n    $(this).closest('li').remove();\n  });\n\n  $('#tab-options').on('click', '.move-group-up, .move-group-down', function(e) {\n    e.preventDefault();\n    var row = $(this).closest('li');\n    if ($(this).is('.move-group-up') && $(row).prevAll().length > 0) {\n      $(row).insertBefore($(row).prev());\n    } else if ($(this).is('.move-group-down') && $(row).nextAll().length > 0) {\n      $(row).insertAfter($(row).next());\n    }\n  });\n\n  $('#tab-options').on('click', '.remove', function(e) {\n    e.preventDefault();\n    $(this).closest('tr').remove();\n  });\n\n  $('#tab-options').on('click', '.move-up, .move-down', function(e) {\n    e.preventDefault();\n    var row = $(this).closest('tr');\n    if ($(this).is('.move-up') && $(row).prevAll().length > 0) {\n      $(row).insertBefore($(row).prev());\n    } else if ($(this).is('.move-down') && $(row).nextAll().length > 0) {\n      $(row).insertAfter($(row).next());\n    }\n  });\n\n  $('body').on('change', '.featherlight select[name=\"new_predefined_option[group_id]\"]', function(){\n    $('body').css('cursor', 'wait');\n    $.ajax({\n      url: '<?php echo document::link(null, ['doc' => 'attribute_values.json'], ['app']); ?>&group_id=' + $(this).val(),\n      type: 'get',\n      cache: true,\n      async: true,\n      dataType: 'json',\n      error: function(jqXHR, textStatus, errorThrown) {\n        alert(jqXHR.readyState + '\\n' + textStatus + '\\n' + errorThrown.message);\n      },\n      success: function(data) {\n        $('select[name=\"new_predefined_option[value_id]\"').html('');\n        if ($('select[name=\"new_predefined_option[value_id]\"').attr('disabled')) $('select[name=\"new_predefined_option[value_id]\"]').prop('disabled', false);\n        if (data) {\n          $('select[name=\"new_predefined_option[value_id]\"').append('<option value=\"0\">-- <?php echo language::translate('title_select', 'Select'); ?> --</option>');\n          $.each(data, function(i, zone) {\n            $('select[name=\"new_predefined_option[value_id]\"').append('<option value=\"'+ zone.id +'\">'+ zone.name +'</option>');\n          });\n        } else {\n          $('select[name=\"new_predefined_option[value_id]\"').prop('disabled', true);\n        }\n      },\n      complete: function() {\n        $('body').css('cursor', 'auto');\n      }\n    });\n  });\n\n  $('body').on('change', '.featherlight select[name=\"new_user_input_option[group_id]\"]', function(){\n    $('body').css('cursor', 'wait');\n    $.ajax({\n      url: '<?php echo document::link(null, ['doc' => 'attribute_values.json'], ['app']); ?>&group_id=' + $(this).val(),\n      type: 'get',\n      cache: true,\n      async: true,\n      dataType: 'json',\n      error: function(jqXHR, textStatus, errorThrown) {\n        alert(jqXHR.readyState + '\\n' + textStatus + '\\n' + errorThrown.message);\n      },\n      success: function(data) {\n        $('select[name=\"new_user_input_option[value_id]\"').html('');\n        if ($('select[name=\"new_user_input_option[value_id]\"').attr('disabled')) $('select[name=\"new_user_input_option[value_id]\"]').prop('disabled', false);\n        if (data) {\n          $('select[name=\"new_user_input_option[value_id]\"').append('<option value=\"0\">-- <?php echo language::translate('title_select', 'Select'); ?> --</option>');\n          $.each(data, function(i, zone) {\n            $('select[name=\"new_user_input_option[value_id]\"').append('<option value=\"'+ zone.id +'\">'+ zone.name +'</option>');\n          });\n        } else {\n          $('select[name=\"new_user_input_option[value_id]\"').prop('disabled', true);\n        }\n      },\n      complete: function() {\n        $('body').css('cursor', 'auto');\n      }\n    });\n  });\n\n  $('body').on('change', '.featherlight select[name=\"new_predefined_option[value_id]\"]', function(){\n    $('input[name=\"new_predefined_option[custom_value]\"').val('');\n  });\n\n  $('body').on('keydown', '.featherlight input[name=\"new_predefined_option[custom_value]\"]', function(){\n    $('select[name=\"new_predefined_option[value_id]\"').val('0');\n  });\n\n  var new_option_group_i = 1;\n  var new_option_value_i = 1;\n  $('body').on('click', '.featherlight button[name=\"add_predefined_option\"]', function(e) {\n    e.preventDefault();\n\n    var groupElement = $(this).closest('fieldset').find('select[name=\"new_predefined_option[group_id]\"]');\n    var valueElement = $(this).closest('fieldset').find('select[name=\"new_predefined_option[value_id]\"]');\n    var customValueElement = $(this).closest('fieldset').find('input[name=\"new_predefined_option[custom_value]\"]');\n\n    if ($(groupElement).val() == '') {\n      alert(\"<?php echo language::translate('error_must_select_attribute_group', 'You must select an attribute group'); ?>\");\n      return;\n    }\n    if ($(valueElement).val() == '' || $(valueElement).val() == '0') {\n      if ($(customValueElement).val() == '') {\n        alert(\"<?php echo language::translate('error_must_select_attribute_value', 'You must select an attribute value'); ?>\");\n        return;\n      }\n    } else {\n      if ($(customValueElement).val() != '') {\n        console.log($(valueElement).val(), $(customValueElement).val());\n        alert(\"<?php echo language::translate('error_cannot_define_both_value_and_custom_value', 'You can not define both a value and a custom value'); ?>\");\n        return;\n      }\n    }\n\n    if ($('#tab-options :input[name^=\"options\"][name$=\"[group_id]\"][value=\"'+ $(groupElement).val() +'\"]').closest('li').find('input[name$=\"[value_id]\"][value=\"'+ $(valueElement).val() +'\"]').length) {\n      if ($(customValueElement).val() != '') {\n        if ($('#tab-options :input[name^=\"options\"][name$=\"[group_id]\"][value=\"'+ $(groupElement).val() +'\"]').closest('li').find('input[name$=\"[custom_value]\"][value=\"'+ escape($(customValueElement).val()) +'\"]').length) {\n          alert(\"<?php echo language::translate('error_option_already_defined', 'This option is already defined'); ?>\");\n          return;\n        }\n\n      } else {\n        if ($('#tab-options :input[name^=\"options\"][name$=\"[group_id]\"][value=\"'+ $(groupElement).val() +'\"]').closest('li').find('input[name$=\"[value_id]\"][value=\"'+ $(valueElement).val() +'\"]').closest('tr').find('input[name$=\"[custom_value]\"]').val() == $(customValueElement).val()) {\n          alert(\"<?php echo language::translate('error_option_already_defined', 'This option is already defined'); ?>\");\n          return;\n        }\n      }\n    }\n\n    if (!$('#tab-options input[name^=\"options\"][name$=\"[group_id]\"][value=\"'+ $(groupElement).val() +'\"]').length) {\n      var output = '<li data-group-id=\"'+ escapeHTML($(groupElement).val()) +'\" data-group-name=\"'+ escapeHTML($(groupElement).find('option:selected').text()) +'\">'\n                 + '  <div class=\"float-end\">'\n                 + '    <a class=\"move-group-up\" href=\"#\" title=\"<?php echo language::translate('text_move_up', 'Move up'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-up fa-2x', 'style=\"color: #3399cc;\"'); ?></a>'\n                 + '    <a class=\"move-group-down\" href=\"#\" title=\"<?php echo language::translate('text_move_down', 'Move down'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-down fa-2x', 'style=\"color: #3399cc;\"'); ?></a>'\n                 + '    <a class=\"remove-group\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-2x', 'style=\"color: #cc3333;\"'); ?></a>'\n                 + '  </div>'\n                 + '  <h2>'+ $(this).closest('fieldset').find('select[name=\"new_predefined_option[group_id]\"] option:selected').text() +'</h2>'\n                 + '  <?php echo functions::escape_js(functions::form_draw_hidden_field('options[new_group_id][group_id]', 'new_group_id')); ?>'\n                 + '  <div class=\"row\">'\n                 + '    <div class=\"form-group col-sm-4 col-md-2\">'\n                 + '      <label><?php echo functions::escape_js(language::translate('title_function', 'Function')); ?></label>'\n                 + '      <?php echo functions::escape_js(functions::form_draw_select_field('options[new_group_id][function]', ['select', 'radio', 'checkbox'], 'select')); ?>'\n                 + '    </div>'\n                 + '    <div class=\"form-group col-sm-4 col-md-2\">'\n                 + '      <label><?php echo functions::escape_js(language::translate('title_sort_values', 'Sort Values')); ?></label>'\n                 + '      <?php echo functions::escape_js(functions::form_draw_select_field('options[new_group_id][sort]', $option_sort_options, 'custom')); ?>'\n                 + '    </div>'\n                 + '    <div class=\"form-group col-sm-4 col-md-2\">'\n                 + '      <label><?php echo functions::escape_js(language::translate('title_required', 'Required')); ?></label>'\n                 + '      <div class=\"checkbox\">'\n                 + '        <label><?php echo functions::form_draw_checkbox('options[new_group_id][required]', '1', true); ?> <?php echo language::translate('title_required', 'Required'); ?></label>'\n                 + '      </div>'\n                 + '    </div>'\n                 + '  </div>'\n                 + '  <div class=\"table-responsive\">'\n                 + '    <table id=\"table-options\" class=\"table table-striped table-hover table-dragable data-table\">'\n                 + '      <thead>'\n                 + '        <tr>'\n                 + '          <th><?php echo functions::escape_js(language::translate('title_option', 'Option')); ?></th>'\n                 + '          <th style=\"width: 150px;\"><?php echo language::translate('title_price_operator', 'Price Operator'); ?></th>'\n                 + '          <th colspan=\"<?php echo count(currency::$currencies); ?>\"><?php echo language::translate('title_price_adjustment', 'Price Adjustment'); ?></th>'\n                 + '          <th style=\"width: 85px;\">&nbsp;</th>'\n                 + '        </tr>'\n                 + '      </thead>'\n                 + '      <tbody>'\n                 + '      </tbody>'\n                 + '    </table>'\n                 + '  </div>'\n                 + '</li>';\n\n      output = output.replace(/new_option_group_i/g, 'new_' + new_option_group_i);\n      output = output.replace(/new_group_id/g, $(groupElement).val());\n      output = output.replace(/new_group_name/g, $(groupElement).find('option:selected').text());\n      $('#tab-options ul').append(output);\n      new_option_group_i++;\n    }\n\n    var output = '<tr data-value-id=\"'+ escapeHTML($(valueElement).val()) +'\" data-value-name=\"'+ escapeHTML(($(valueElement).val() != 0) ? $(valueElement).find('option:selected').text() : $(customValueElement).val()) +'\">'\n               + '  <td class=\"grabable\"><?php echo functions::escape_js(functions::form_draw_hidden_field('options[new_group_id][values][new_option_value_i][value_id]', 'new_value_id')) . functions::form_draw_hidden_field('options[new_group_id][values][new_option_value_i][custom_value]', 'new_custom_value'); ?>'+ (($.inArray($(valueElement).val(), ['', '0']) !== -1) ? $(customValueElement).val() : $(valueElement).find('option:selected').text()) +'</td>'\n               + '  <td style=\"text-align: center;\"><?php echo functions::escape_js(functions::form_draw_select_field('options[new_group_id][values][new_option_value_i][price_operator]', ['+','%','*','='], true)); ?></td>'\n               + '  <?php foreach (array_keys(currency::$currencies) as $currency_code) echo '<td style=\"width: 200px;\">'. functions::escape_js(functions::form_draw_currency_field($currency_code, 'options[new_group_id][values][new_option_value_i]['. $currency_code. ']', '')) .'</td>'; ?>'\n               + '  <td class=\"text-end\"><a class=\"move-up\" href=\"#\" title=\"<?php echo language::translate('text_move_up', 'Move up'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-up fa-lg', 'style=\"color: #3399cc;\"'); ?></a> <a class=\"move-down\" href=\"#\" title=\"<?php echo language::translate('text_move_down', 'Move down'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-down fa-lg', 'style=\"color: #3399cc;\"'); ?></a> <a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"'); ?></a></td>'\n               + '</tr>';\n\n    output = output.replace(/new_option_value_i/g, 'new_' + new_option_value_i);\n    output = output.replace(/new_group_id/g, $(groupElement).val());\n    output = output.replace(/new_value_id/g, $(valueElement).val());\n    output = output.replace(/new_custom_value/g, $(customValueElement).val().replace(/\"/, '&quot;'));\n    $(':input[name^=\"options\"][name$=\"[group_id]\"][value=\"'+ $(groupElement).val() +'\"]').closest('li').find('tbody').append(output);\n    new_option_value_i++;\n\n    $.featherlight.close();\n  });\n\n  $('body').on('click', '.featherlight button[name=\"add_user_input_option\"]', function(e) {\n    e.preventDefault();\n\n    var groupElement = $(this).closest('fieldset').find('select[name=\"new_user_input_option[group_id]\"]');\n\n    if ($(groupElement).val() == '') {\n      alert(\"<?php echo language::translate('error_must_select_attribute_group', 'You must select an attribute group'); ?>\");\n      return;\n    }\n\n    if ($('#tab-options :input[name^=\"options\"][name$=\"[group_id]\"][value=\"'+ $(groupElement).val() +'\"]').length) {\n      alert(\"<?php echo language::translate('error_group_already_defined', 'This group is already defined'); ?>\");\n      return;\n    }\n\n    var output = '<li>'\n               + '  <div class=\"float-end\">'\n               + '    <a class=\"move-group-up\" href=\"#\" title=\"<?php echo language::translate('text_move_up', 'Move up'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-up fa-2x', 'style=\"color: #3399cc;\"'); ?></a>'\n               + '    <a class=\"move-group-down\" href=\"#\" title=\"<?php echo language::translate('text_move_down', 'Move down'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-down fa-2x', 'style=\"color: #3399cc;\"'); ?></a>'\n               + '    <a class=\"remove-group\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-2x', 'style=\"color: #cc3333;\"'); ?></a>'\n               + '  </div>'\n               + '  <h2>'+ $(this).closest('fieldset').find('select[name=\"new_user_input_option[group_id]\"] option:selected').text() +'</h2>'\n               + '  <?php echo functions::escape_js(functions::form_draw_hidden_field('options[new_group_id][group_id]', 'new_group_id')); ?>'\n               + '  <div class=\"row\">'\n               + '    <div class=\"form-group col-sm-4 col-md-2\">'\n               + '      <label><?php echo language::translate('title_function', 'Function'); ?></label>'\n               + '      <?php echo functions::escape_js(functions::form_draw_select_field('options[new_group_id][function]', ['text', 'textarea'], 'text')); ?>'\n               + '    </div>'\n               + '    <div class=\"form-group col-sm-4 col-md-2\">'\n               + '      <label><?php echo language::translate('title_required', 'Required'); ?></label>'\n               + '      <div class=\"checkbox\">'\n               + '        <label><?php echo functions::form_draw_checkbox('options[new_group_id][required]', '1', true); ?> <?php echo language::translate('title_required', 'Required'); ?></label>'\n               + '      </div>'\n               + '    </div>'\n               + '  </div>'\n               + '</li>';\n\n    output = output.replace(/new_group_id/g, $(groupElement).val());\n    output = output.replace(/new_group_name/g, $(groupElement).find('option:selected').text());\n    $('#tab-options ul').append(output);\n\n    $.featherlight.close();\n  });\n\n// Quantity Unit\n\n  $('select[name=\"quantity_unit_id\"]').change(function(){\n    if ($('option:selected', this).data('decimals') === undefined) return;\n\n    var decimals = $('option:selected', this).data('decimals');\n\n    var value = parseFloat($('input[name=\"quantity\"]').val() || 0).toFixed(decimals);\n    $('input[name=\"quantity\"]').val(value);\n\n    $('input[name^=\"option_stock\"][name$=\"[quantity]\"]').each(function(){\n      var value = parseFloat($(this).val() || 0).toFixed(decimals);\n      $(this).val(value);\n    });\n\n    $('input[name^=\"option_stock\"][name$=\"[quantity_adjustment]\"]').each(function(){\n      var value = parseFloat($(this).val() || 0).toFixed(decimals);\n      $(this).val(value);\n    });\n  }).trigger('change');\n\n// Stock\n\n  $('#table-stock').on('input', 'input[name=\"quantity\"]', function(){\n    $('input[name=\"quantity_adjustment\"]').val( parseFloat($(this).val() || 0) - parseFloat($(this).data('quantity') || 0) );\n  });\n\n  $('#table-stock').on('input', 'input[name=\"quantity_adjustment\"]', function(){\n    $('input[name=\"quantity\"]').val( parseFloat($('input[name=\"quantity\"]').data('quantity') || 0) + parseFloat($(this).val() || 0) );\n  });\n\n  $('#table-stock').on('input', 'input[name$=\"[quantity]\"]', function(){\n    var adjustment_field = $(this).closest('tr').find('input[name$=\"[quantity_adjustment]\"]');\n    $(adjustment_field).val( parseFloat($(this).val() || 0) - parseFloat($(this).data('quantity') || 0) );\n\n    $('input[name=\"quantity\"]').val(0);\n    $(this).closest('tbody').find('input[name$=\"[quantity]\"]').each(function() {\n      $('input[name=\"quantity\"]').val( parseFloat($('input[name=\"quantity\"]').val() || 0) + parseFloat($(this).val() || 0) );\n    });\n\n    $('input[name=\"quantity_adjustment\"]').val(0);\n    $(this).closest('tbody').find('input[name$=\"[quantity_adjustment]\"]').each(function() {\n      $('input[name=\"quantity_adjustment\"]').val( parseFloat($('input[name=\"quantity_adjustment\"]').val() || 0) + parseFloat($(this).val() || 0) );\n    });\n  });\n\n  $('#table-stock').on('input', 'input[name$=\"[quantity_adjustment]\"]', function(){\n    var qty_field = $(this).closest('tr').find('input[name$=\"[quantity]\"]');\n    $(qty_field).val( parseFloat($(qty_field).data('quantity') || 0) + parseFloat($(this).val() || 0) );\n\n    $('input[name=\"quantity\"]').val(0);\n    $(this).closest('tbody').find('input[name$=\"[quantity]\"]').each(function() {\n      $('input[name=\"quantity\"]').val( parseFloat($('input[name=\"quantity\"]').val() || 0) + parseFloat($(this).val() || 0) );\n    });\n\n    $('input[name=\"quantity_adjustment\"]').val(0);\n    $(this).closest('tbody').find('input[name$=\"[quantity_adjustment]\"]').each(function() {\n      $('input[name=\"quantity_adjustment\"]').val( parseFloat($('input[name=\"quantity_adjustment\"]').val() || 0) + parseFloat($(this).val() || 0) );\n    });\n  });\n\n  $('#table-stock').on('click', '.remove', function(e) {\n    e.preventDefault();\n    $(this).closest('tr').remove();\n\n    var total = 0;\n    $(this).closest('tbody').find('input[name$=\"[quantity]\"]').each(function() {\n      total += parseFloat($(this).val() || 0);\n    });\n\n    if (!$('input[name^=\"options_stock\"][name$=\"[id]\"]').length) {\n\n      $('input[name=\"quantity\"]').prop('readonly', false);\n      $('input[name=\"quantity_adjustment\"]').prop('readonly', false);\n      $('input[name=\"quantity\"]').val('');\n      $('input[name=\"quantity_adjustment\"]').val('');\n\n    } else {\n\n      $('input[name=\"quantity\"]').val(0);\n      $('input[name^=\"options_stock\"][name$=\"[quantity]\"]').each(function() {\n        $('input[name=\"quantity\"]').val( parseFloat($('input[name=\"quantity\"]').val() || 0) + parseFloat($(this).val() || 0) );\n      });\n\n      $('input[name=\"quantity_adjustment\"]').val(0);\n      $('input[name^=\"options_stock\"][name$=\"[quantity_adjustment]\"]').each(function() {\n        $('input[name=\"quantity_adjustment\"]').val( parseFloat($('input[name=\"quantity_adjustment\"]').val() || 0) + parseFloat($(this).val() || 0) );\n      });\n    }\n  });\n\n  $('#table-stock').on('click', '.move-up, .move-down', function(e) {\n    e.preventDefault();\n    var row = $(this).closest('tr');\n\n    if ($(this).is('.move-up') && $(row).prevAll().length > 1) {\n      $(row).insertBefore($(row).prev());\n    } else if ($(this).is('.move-down') && $(row).nextAll().length > 0) {\n      $(row).insertAfter($(row).next());\n    }\n  });\n\n// New Stock Option (Modal)\n\n  $('#table-stock').on('click', '.add', function(e) {\n    e.preventDefault();\n\n    var output = '';\n\n    $('#options li').each(function(i, group) {\n      var group_id = $(this).data('group-id'),\n        group_name = $(this).data('group-name');\n\n      $(group).find('.data-table tbody tr').each(function(j, row) {\n        var value_id = $(row).data('value-id'),\n          value_name = $(row).data('value-name'),\n          combination = group_id + '-' + ((value_id != 0) ? value_id : '0:\"' + value_name +'\"');\n\n        output += '<tr data-group-id=\"'+ escapeHTML(group_id) +'\" data-group-name=\"'+ escapeHTML(group_name) +'\" data-value-id=\"'+ escapeHTML(value_id) +'\" data-value-name=\"'+ escapeHTML(value_name) +'\">'\n                + '  <td><span class=\"form-check\"><input type=\"checkbox\" name=\"combination[]\" value=\"'+ escapeHTML(combination) +'\" /></span></td>'\n                + '  <td>'+ group_name +'</td>'\n                + '  <td>'+ value_name +'</td>'\n                + '</tr>';\n      });\n    });\n\n    $('#new-stock-option table tbody').html(output);\n    $.featherlight('#new-stock-option');\n  });\n\n  var new_option_stock_i = 1;\n  $('body').on('click', '#new-stock-option button[name=\"add_stock_option\"]', function(e) {\n    e.preventDefault();\n\n    var modal = $(this).closest('#new-stock-option'),\n      new_option_combination = '',\n      new_option_name = '',\n      use_comma = false;\n\n    $(modal).find('table tbody tr :input[name=\"combination[]\"]:checked').each(function() {\n      var row = $(this).closest('tr');\n\n      if (use_comma) {\n        new_option_combination += ',';\n        new_option_name += ', ';\n      }\n\n      new_option_combination += $(row).data('group-id') + '-' + $(row).data('value-id')\n                              + (($(row).data('value-id') == 0) ? ':\"' + $(row).data('value-name')+'\"' : '');\n\n      new_option_name += $(row).data('value-name');\n\n      use_comma = true;\n    });\n\n    if (new_option_combination == '') return;\n\n    var output = '<tr>'\n               + '  <td><?php echo functions::escape_js(functions::form_draw_hidden_field('options_stock[new_option_stock_i][id]', '') . functions::form_draw_hidden_field('options_stock[new_option_stock_i][combination]', 'new_option_combination') . functions::form_draw_hidden_field('options_stock[new_option_stock_i][name]['. language::$selected['code'] .']', 'new_option_name')); ?>new_option_name</td>'\n               + '  <td><?php echo functions::escape_js(functions::form_draw_text_field('options_stock[new_option_stock_i][sku]', '')); ?></td>'\n               + '  <td>'\n               + '    <div class=\"input-group\">'\n               + '      <?php echo functions::escape_js(functions::form_draw_decimal_field('options_stock[new_option_stock_i][weight]', '0.00', 4, 0)); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_weight_classes_list('options_stock[new_option_stock_i][weight_class]', '')); ?>'\n               + '    </div>'\n               + '  </td>'\n               + '  <td>'\n               + '    <div class=\"input-group\">'\n               + '      <?php echo functions::escape_js(functions::form_draw_decimal_field('options_stock[new_option_stock_i][dim_x]', '0.00', 4, 0)); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_decimal_field('options_stock[new_option_stock_i][dim_y]', '0.00', 4, 0)); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_decimal_field('options_stock[new_option_stock_i][dim_z]', '0.00', 4, 0)); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_length_classes_list('options_stock[new_option_stock_i][dim_class]', '')); ?>'\n               + '    </div>'\n               + '  </td>'\n               + '  <td><?php echo functions::escape_js(functions::form_draw_decimal_field('options_stock[new_option_stock_i][quantity]', '0', 2, null, null, 'data-quantity=\"0\"')); ?></td>'\n               + '  <td>'\n               + '    <div class=\"input-group\">'\n               + '      <span class=\"input-group-text\">&plusmn;</span>'\n               + '    <?php echo functions::escape_js(functions::form_draw_decimal_field('options_stock[new_option_stock_i][quantity_adjustment]', '0')); ?>'\n               + '    </div>'\n               + '  </td>'\n               + '  <td class=\"text-end\">'\n               + '    <a class=\"move-up\" href=\"#\" title=\"<?php echo functions::escape_js(language::translate('text_move_up', 'Move up'), true); ?>\"><?php echo functions::escape_js(functions::draw_fonticon('fa-arrow-circle-up fa-lg', 'style=\"color: #3399cc;\"')); ?></a>'\n               + '    <a class=\"move-down\" href=\"#\" title=\"<?php echo functions::escape_js(language::translate('text_move_down', 'Move down'), true); ?>\"><?php echo functions::escape_js(functions::draw_fonticon('fa-arrow-circle-down fa-lg', 'style=\"color: #3399cc;\"')); ?></a>'\n               + '    <a class=\"remove\" href=\"#\" title=\"<?php echo functions::escape_js(language::translate('title_remove', 'Remove'), true); ?>\"><?php echo functions::escape_js(functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"')); ?></a>'\n               + '  </td>'\n               + '</tr>';\n\n    while ($('input[name=\"options_stock[new_'+new_option_stock_i+']\"]').length) new_option_stock_i++;\n    output = output.replace(/new_option_stock_i/g, 'new_' + new_option_stock_i);\n    output = output.replace(/new_option_combination/g, escapeHTML(new_option_combination));\n    output = output.replace(/new_option_name/g, new_option_name);\n\n    $('#table-stock').find('tbody').append(output);\n    new_option_stock_i++;\n\n    $('input[name=\"quantity\"]').prop('readonly', true);\n    $('input[name=\"quantity_adjustment\"]').prop('readonly', true);\n\n    if ($('input[name^=\"options_stock\"][name$=\"[id]\"]').length == 1) {\n      $('input[name=\"quantity\"]').val('');\n      $('input[name=\"quantity_adjustment\"]').val('');\n    }\n\n    $.featherlight.close();\n  });\n</script>", "<?php\n\n  if (!empty($_GET['country_code'])) {\n    $country = new ent_country($_GET['country_code']);\n  } else {\n    $country = new ent_country();\n  }\n\n  if (empty($_POST)) {\n    $_POST = $country->data;\n  }\n\n  document::$snippets['title'][] = !empty($country->data['id']) ? language::translate('title_edit_country', 'Edit Country') : language::translate('title_add_new_country', 'Add New Country');\n\n  breadcrumbs::add(language::translate('title_countries', 'Countries'));\n  breadcrumbs::add(!empty($country->data['id']) ? language::translate('title_edit_country', 'Edit Country') : language::translate('title_add_new_country', 'Add New Country'));\n\n  if (isset($_POST['save'])) {\n\n    try {\n\n      if (empty($_POST['iso_code_1'])) throw new Exception(language::translate('error_missing_code', 'You must enter a code'));\n      if (empty($_POST['iso_code_2'])) throw new Exception(language::translate('error_missing_code', 'You must enter a code'));\n      if (empty($_POST['iso_code_3'])) throw new Exception(language::translate('error_missing_code', 'You must enter a code'));\n      if (empty($_POST['name'])) throw new Exception(language::translate('error_must_enter_name', 'You must enter a name'));\n\n      if (empty($_POST['zones'])) $_POST['zones'] = [];\n\n      foreach ($_POST['zones'] as $zone) {\n        if (empty($zone['code']) || empty($zone['name'])) throw new Exception(language::translate('error_zone_must_have_name_and_code', 'A zone/state/province must have a name and code'));\n      }\n\n      $_POST['iso_code_2'] = strtoupper($_POST['iso_code_2']);\n      $_POST['iso_code_3'] = strtoupper($_POST['iso_code_3']);\n\n      $fields = [\n        'status',\n        'iso_code_1',\n        'iso_code_2',\n        'iso_code_3',\n        'name',\n        'domestic_name',\n        'tax_id_format',\n        'address_format',\n        'postcode_format',\n        'language_code',\n        'currency_code',\n        'phone_code',\n        'zones',\n      ];\n\n      foreach ($fields as $field) {\n        if (isset($_POST[$field])) $country->data[$field] = $_POST[$field];\n      }\n\n      $country->save();\n\n      notices::add('success', language::translate('success_changes_saved', 'Changes saved'));\n      header('Location: '. document::link(WS_DIR_ADMIN, ['doc' => 'countries'], true, ['country_id']));\n      exit;\n\n    } catch (Exception $e) {\n      notices::add('errors', $e->getMessage());\n    }\n  }\n\n  if (isset($_POST['delete'])) {\n\n    try {\n      if (empty($country->data['id'])) throw new Exception(language::translate('error_must_provide_country', 'You must provide a country'));\n\n      $country->delete();\n\n      notices::add('success', language::translate('success_changes_saved', 'Changes saved'));\n      header('Location: '. document::link(WS_DIR_ADMIN, ['doc' => 'countries'], true, ['country_id']));\n      exit;\n\n    } catch (Exception $e) {\n      notices::add('errors', $e->getMessage());\n    }\n  }\n?>\n<div class=\"panel panel-app\">\n  <div class=\"panel-heading\">\n    <?php echo $app_icon; ?> <?php echo !empty($country->data['id']) ? language::translate('title_edit_country', 'Edit Country') : language::translate('title_add_new_country', 'Add New Country'); ?>\n  </div>\n\n  <div class=\"panel-body\">\n    <?php echo functions::form_draw_form_begin('country_form', 'post', false, false, 'style=\"max-width: 640px;\"'); ?>\n\n      <div class=\"row\">\n        <div class=\"form-group col-md-6\">\n          <label><?php echo language::translate('title_status', 'Status'); ?></label>\n          <?php echo functions::form_draw_toggle('status', (file_get_contents('php://input') != '') ? true : '1', 'e/d'); ?>\n        </div>\n\n        <div class=\"form-group col-md-6\">\n          <label><?php echo language::translate('title_number', 'Number'); ?> (ISO 3166-1 numeric) <a href=\"https://en.wikipedia.org/wiki/ISO_3166-1_numeric\" target=\"_blank\"><?php echo functions::draw_fonticon('fa-external-link'); ?></a></label>\n          <?php echo functions::form_draw_text_field('iso_code_1', true, 'required pattern=\"[0-9]{3}\"'); ?>\n        </div>\n      </div>\n\n      <div class=\"row\">\n        <div class=\"form-group col-md-6\">\n          <label><?php echo language::translate('title_code', 'Code'); ?> (ISO 3166-1 alpha-2) <a href=\"http://en.wikipedia.org/wiki/ISO_3166-1_alpha-2\" target=\"_blank\"><?php echo functions::draw_fonticon('fa-external-link'); ?></a></label>\n          <?php echo functions::form_draw_text_field('iso_code_2', true, 'required pattern=\"[A-Z]{2}\"'); ?>\n        </div>\n\n        <div class=\"form-group col-md-6\">\n          <label><?php echo language::translate('title_code', 'Code'); ?> (ISO 3166-1 alpha-3) <a href=\"http://en.wikipedia.org/wiki/ISO_3166-1_alpha-3\" target=\"_blank\"><?php echo functions::draw_fonticon('fa-external-link'); ?></a></label>\n          <?php echo functions::form_draw_text_field('iso_code_3', true, 'required pattern=\"[A-Z]{3}\"'); ?>\n        </div>\n      </div>\n\n      <div class=\"row\">\n        <div class=\"form-group col-md-6\">\n          <label><?php echo language::translate('title_name', 'Name'); ?></label>\n          <?php echo functions::form_draw_text_field('name', true); ?>\n        </div>\n\n        <div class=\"form-group col-md-6\">\n          <label><?php echo language::translate('title_domestic_name', 'Domestic Name'); ?></label>\n          <?php echo functions::form_draw_text_field('domestic_name', true); ?>\n        </div>\n      </div>\n\n      <div class=\"form-group\">\n        <label><?php echo language::translate('title_address_format', 'Address Format'); ?> (<a id=\"address-format-hint\" href=\"#\">?</a>) <a href=\"https://en.wikipedia.org/wiki/Address_(geography)\" target=\"_blank\"><?php echo functions::draw_fonticon('fa-external-link'); ?></a></label>\n        <?php echo functions::form_draw_textarea('address_format', true, 'style=\"height: 150px;\"'); ?>\n      </div>\n\n      <div class=\"row\">\n        <div class=\"form-group col-md-6\">\n          <label><?php echo language::translate('title_tax_id_format', 'Tax ID Format'); ?> <a href=\"https://en.wikipedia.org/wiki/Regular_expression\" target=\"_blank\"><?php echo functions::draw_fonticon('fa-external-link'); ?></a></label>\n          <?php echo functions::form_draw_text_field('tax_id_format', true); ?>\n        </div>\n\n        <div class=\"form-group col-md-6\">\n          <label><?php echo language::translate('title_postcode_format', 'Postcode Format'); ?> <a href=\"https://en.wikipedia.org/wiki/Regular_expression\" target=\"_blank\"><?php echo functions::draw_fonticon('fa-external-link'); ?></a></label>\n          <?php echo functions::form_draw_text_field('postcode_format', true); ?>\n        </div>\n      </div>\n\n      <div class=\"row\">\n        <div class=\"form-group col-md-4\">\n          <label><?php echo language::translate('title_language_code', 'Language Code'); ?> <a href=\"http://en.wikipedia.org/wiki/List_of_ISO_639-1_codes\" target=\"_blank\"><?php echo functions::draw_fonticon('fa-external-link'); ?></a></label>\n          <?php echo functions::form_draw_text_field('language_code', true); ?>\n        </div>\n\n        <div class=\"form-group col-md-4\">\n          <label><?php echo language::translate('title_currency_code', 'Currency Code'); ?> <a href=\"https://en.wikipedia.org/wiki/List_of_countries_and_capitals_with_currency_and_language\" target=\"_blank\"><?php echo functions::draw_fonticon('fa-external-link'); ?></a></label>\n          <?php echo functions::form_draw_text_field('currency_code', true); ?>\n        </div>\n\n        <div class=\"form-group col-md-4\">\n          <label><?php echo language::translate('title_phone_country_code', 'Phone Country Code'); ?> <a href=\"https://en.wikipedia.org/wiki/List_of_country_calling_codes\" target=\"_blank\"><?php echo functions::draw_fonticon('fa-external-link'); ?></a></label>\n          <?php echo functions::form_draw_text_field('phone_code', true); ?>\n        </div>\n      </div>\n\n      <h2><?php echo language::translate('title_zones', 'Zones'); ?></h2>\n      <table class=\"table table-striped table-hover data-table\">\n        <thead>\n          <tr>\n            <th><?php echo language::translate('title_id', 'ID'); ?></th>\n            <th style=\"padding-inline-end: 50px;\"><?php echo language::translate('title_code', 'Code'); ?></th>\n            <th class=\"main\"><?php echo language::translate('title_name', 'Name'); ?></th>\n            <th></th>\n          </tr>\n        </thead>\n        <tbody>\n          <?php if (!empty($_POST['zones'])) foreach (array_keys($_POST['zones']) as $key) { ?>\n          <tr>\n            <td><?php echo functions::form_draw_hidden_field('zones['. $key .'][id]', true); ?><?php echo $_POST['zones'][$key]['id']; ?></td>\n            <td><?php echo functions::form_draw_text_field('zones['. $key .'][code]', true); ?></td>\n            <td><?php echo functions::form_draw_text_field('zones['. $key .'][name]', true); ?></td>\n            <td class=\"text-end\"><a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"'); ?></a></td>\n          </tr>\n          <?php } ?>\n        </tbody>\n        <tfoot>\n          <tr>\n            <td colspan=\"4\"><a class=\"add\" href=\"#\"><?php echo functions::draw_fonticon('fa-plus-circle', 'style=\"color: #66cc66;\"'); ?> <?php echo language::translate('title_add_zone', 'Add Zone'); ?></a></td>\n          </tr>\n        </tfoot>\n      </table>\n\n      <div class=\"panel-action btn-group\">\n        <?php echo functions::form_draw_button('save', language::translate('title_save', 'Save'), 'submit', '', 'save'); ?>\n        <?php echo functions::form_draw_button('cancel', language::translate('title_cancel', 'Cancel'), 'button', 'onclick=\"history.go(-1);\"', 'cancel'); ?>\n        <?php echo (isset($country->data['id'])) ? functions::form_draw_button('delete', language::translate('title_delete', 'Delete'), 'submit', 'formnovalidate onclick=\"if (!window.confirm(\\''. language::translate('text_are_you_sure', 'Are you sure?') .'\\')) return false;\"', 'delete') : false; ?>\n      </div>\n\n    <?php echo functions::form_draw_form_end(); ?>\n  </div>\n</div>\n\n<script>\n  $('#address-format-hint').click(function() {\n    alert(\n      '<?php echo language::translate('title_syntax', 'Syntax'); ?>:\\n\\n' +\n      '%company, %firstname, %lastname, \\n' +\n      '%address1, %address2\\n' +\n      '%postcode %city\\n' +\n      '%zone_code, %zone_name\\n' +\n      '%country_number, %country_code, %country_code_3, %country_name, %country_domestic_name\\n'\n    );\n  });\n\n  var new_zone_i = <?php echo isset($_POST['zones']) ? count($_POST['zones']) : '0'; ?>;\n  $('form[name=\"country_form\"] .add').click(function(event) {\n    event.preventDefault();\n    if ($('select[name=\"country[code]\"]').find('option:selected').val() == '') return;\n    new_zone_i++;\n    var output = '    <tr>'\n               + '      <td><?php echo functions::escape_js(functions::form_draw_hidden_field('zones[new_zone_i][id]', '')); ?></td>'\n               + '      <td><?php echo functions::escape_js(functions::form_draw_text_field('zones[new_zone_i][code]', '')); ?></td>'\n               + '      <td><?php echo functions::escape_js(functions::form_draw_text_field('zones[new_zone_i][name]', '')); ?></td>'\n               + '      <td style=\"text-align: end;\"><a class=\"remove\" href=\"#\" title=\"<?php echo functions::escape_js(language::translate('title_remove', 'Remove'), true); ?>\"><?php echo functions::escape_js(functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"')); ?></a></td>'\n               + '    </tr>';\n    output = output.replace(/new_zone_i/g, 'new_' + new_zone_i);\n    output = output.replace(/new_zone_code/g, $('input[name=\"zone[code]\"]').val());\n    output = output.replace(/new_zone_name/g, $('input[name=\"zone[name]\"]').val());\n    $(this).closest('table').find('tbody').append(output);\n  });\n\n  $('form[name=\"country_form\"]').on('click', '.remove', function(event) {\n    event.preventDefault();\n    $(this).closest('tr').remove();\n  });\n</script>", "<?php\n\n  if (!empty($_GET['geo_zone_id'])) {\n    $geo_zone = new ent_geo_zone($_GET['geo_zone_id']);\n  } else {\n    $geo_zone = new ent_geo_zone();\n  }\n\n  if (empty($_POST)) {\n    $_POST = $geo_zone->data;\n  }\n\n  document::$snippets['title'][] = !empty($geo_zone->data['id']) ? language::translate('title_edit_geo_zone', 'Edit Geo Zone') : language::translate('title_new_geo_zone', 'Create New Geo Zone');\n\n  breadcrumbs::add(language::translate('title_geo_zones', 'Geo Zones'), document::link(WS_DIR_ADMIN, ['doc' => 'geo_zones'], ['app']));\n  breadcrumbs::add(!empty($geo_zone->data['id']) ? language::translate('title_edit_geo_zone', 'Edit Geo Zone') : language::translate('title_new_geo_zone', 'Create New Geo Zone'));\n\n  if (isset($_POST['save'])) {\n\n    try {\n\n      if (empty($_POST['zones'])) $_POST['zones'] = [];\n\n      $fields = [\n        'code',\n        'name',\n        'description',\n        'zones',\n      ];\n\n      foreach ($fields as $field) {\n        if (isset($_POST[$field])) $geo_zone->data[$field] = $_POST[$field];\n      }\n\n      $geo_zone->save();\n\n      notices::add('success', language::translate('success_changes_saved', 'Changes saved'));\n      header('Location: '. document::link(WS_DIR_ADMIN, ['doc' => 'geo_zones'], true, ['geo_zone_id']));\n      exit;\n\n    } catch (Exception $e) {\n      notices::add('errors', $e->getMessage());\n    }\n  }\n\n  if (isset($_POST['delete'])) {\n\n    try {\n      if (empty($geo_zone->data['id'])) throw new Exception(language::translate('error_must_provide_geo_zone', 'You must provide a geo zone'));\n\n      $geo_zone->delete();\n\n      notices::add('success', language::translate('success_changes_saved', 'Changes saved'));\n      header('Location: '. document::link(WS_DIR_ADMIN, ['doc' => 'geo_zones'], true, ['geo_zone_id']));\n      exit;\n\n    } catch (Exception $e) {\n      notices::add('errors', $e->getMessage());\n    }\n  }\n?>\n<div class=\"panel panel-app\">\n  <div class=\"panel-heading\">\n    <?php echo $app_icon; ?> <?php echo !empty($geo_zone->data['id']) ? language::translate('title_edit_geo_zone', 'Edit Geo Zone') : language::translate('title_new_geo_zone', 'Create New Geo Zone'); ?>\n  </div>\n\n  <div class=\"panel-body\">\n    <?php echo functions::form_draw_form_begin('form_geo_zone', 'post', false, false, 'style=\"max-width: 640px;\"'); ?>\n\n      <div class=\"row\">\n        <div class=\"form-group col-md-6\">\n          <label><?php echo language::translate('title_code', 'Code'); ?></label>\n          <?php echo functions::form_draw_text_field('code', true); ?>\n        </div>\n\n        <div class=\"form-group col-md-6\">\n          <label><?php echo language::translate('title_name', 'Name'); ?></label>\n          <?php echo functions::form_draw_text_field('name', true); ?>\n        </div>\n      </div>\n\n      <div class=\"row\">\n        <div class=\"form-group col-md-6\">\n          <label><?php echo language::translate('title_description', 'Description'); ?></label>\n          <?php echo functions::form_draw_text_field('description', true); ?>\n        </div>\n      </div>\n\n      <h2><?php echo language::translate('title_zones', 'Zones'); ?></h2>\n\n      <table class=\"table table-striped table-hover data-table\">\n        <thead>\n          <tr>\n            <th><?php echo language::translate('title_id', 'ID'); ?></th>\n            <th><?php echo language::translate('title_country', 'Country'); ?></th>\n            <th><?php echo language::translate('title_zone', 'Zone'); ?></th>\n            <th><?php echo language::translate('title_city', 'City'); ?></th>\n            <th></th>\n          </tr>\n        </thead>\n\n        <tbody>\n          <?php if (!empty($_POST['zones'])) foreach (array_keys($_POST['zones']) as $key) { ?>\n          <tr>\n            <td><?php echo functions::form_draw_hidden_field('zones['. $key .'][id]', true); ?><?php echo $_POST['zones'][$key]['id']; ?></td>\n            <td><?php echo functions::form_draw_hidden_field('zones['. $key .'][country_code]', true); ?> <?php echo reference::country($_POST['zones'][$key]['country_code'])->name; ?></td>\n            <td><?php echo functions::form_draw_hidden_field('zones['. $key .'][zone_code]', true); ?> <?php echo !empty($_POST['zones'][$key]['zone_code']) ? reference::country($_POST['zones'][$key]['country_code'])->zones[$_POST['zones'][$key]['zone_code']]['name'] : '-- '.language::translate('title_all_zones', 'All Zones') .' --'; ?></td>\n            <td><?php echo functions::form_draw_hidden_field('zones['. $key .'][city]', true); ?> <?php echo !empty($_POST['zones'][$key]['city']) ? $_POST['zones'][$key]['city'] : '-- '.language::translate('title_all_cities', 'All Cities') .' --'; ?></td>\n            <td class=\"text-end\"><a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"'); ?></a></td>\n          </tr>\n          <?php } ?>\n        </tbody>\n\n        <tfoot>\n          <tr>\n            <td><?php echo functions::form_draw_hidden_field('new_zone[id]', ''); ?></td>\n            <td><?php echo functions::form_draw_countries_list('new_zone[country_code]', ''); ?></td>\n            <td><?php echo functions::form_draw_zones_list('', 'new_zone[zone_code]', '', false, '', 'all'); ?></td>\n            <td><?php echo functions::form_draw_text_field('new_zone[city]', '', 'placeholder=\"-- '. language::translate('text_all_cities', 'All cities') .' --\"'); ?></td>\n            <td><?php echo functions::form_draw_button('add', language::translate('title_add', 'Add'), 'button'); ?></td>\n          </tr>\n        </tfoot>\n      </table>\n\n      <div class=\"panel-action btn-group\">\n        <?php echo functions::form_draw_button('save', language::translate('title_save', 'Save'), 'submit', '', 'save'); ?>\n        <?php echo functions::form_draw_button('cancel', language::translate('title_cancel', 'Cancel'), 'button', 'onclick=\"history.go(-1);\"', 'cancel'); ?>\n        <?php echo (!empty($geo_zone->data['id'])) ? functions::form_draw_button('delete', language::translate('title_delete', 'Delete'), 'submit', 'formnovalidate onclick=\"if (!window.confirm(\\''. language::translate('text_are_you_sure', 'Are you sure?') .'\\')) return false;\"', 'delete') : false; ?>\n      </div>\n\n    <?php echo functions::form_draw_form_end(); ?>\n  </div>\n</div>\n\n<script>\n  $('select[name$=\"new_zone[zone_code]\"][disabled]').each(function() {\n    $(this).html('<option value=\"\">-- <?php echo functions::escape_js(language::translate('title_all_zones', 'All Zones')); ?> --</option>');\n  });\n\n  $('body').on('change', 'select[name=\"new_zone[country_code]\"]', function() {\n    var zone_field = $(this).closest('tr').find(\"select[name='new_zone[zone_code]']\");\n    $('body').css('cursor', 'wait');\n    $.ajax({\n      url: '<?php echo document::ilink('ajax/zones.json'); ?>?country_code=' + $(this).val(),\n      type: 'get',\n      cache: true,\n      async: true,\n      dataType: 'json',\n      error: function(jqXHR, textStatus, errorThrown) {\n        alert(jqXHR.readyState + '\\n' + textStatus + '\\n' + errorThrown.message);\n      },\n      success: function(data) {\n        $(zone_field).html('');\n        if (data) {\n          $(zone_field).append('<option value=\"\">-- <?php echo functions::escape_js(language::translate('title_all_zones', 'All Zones')); ?> --</option>');\n          $.each(data, function(i, zone) {\n            $(zone_field).append('<option value=\"'+ zone.code +'\">'+ zone.name +'</option>');\n          });\n          $(zone_field).prop('disabled', false);\n        } else {\n          $(zone_field).append('<option value=\"\">-- <?php echo functions::escape_js(language::translate('title_all_zones', 'All Zones')); ?> --</option>');\n          $(zone_field).prop('disabled', true);\n        }\n      },\n      complete: function() {\n        $('body').css('cursor', 'auto');\n      }\n    });\n  });\n\n  var new_zone_i = <?php echo isset($_POST['zones']) ? count($_POST['zones']) : '0'; ?>;\n  $('form[name=\"form_geo_zone\"]').on('click', 'button[name=\"add\"]', function(e) {\n    e.preventDefault();\n\n    if ($('select[name=\"country[code]\"]').find('option:selected').val() == '') return;\n\n    var row = $(this).closest('tr');\n\n    var found = false;\n    $.each($('form[name=\"form_geo_zone\"] tbody tr'), function(i, current){\n      if ($(current).find(':input[name$=\"[country_code]\"]').val() == $(':input[name=\"new_zone[country_code]\"]').val()\n       && $(current).find(':input[name$=\"[zone_code]\"]').val() == $(':input[name=\"new_zone[zone_code]\"]').val()\n       && $(current).find(':input[name$=\"[city]\"]').val() == $(':input[name=\"new_zone[city]\"]').val()) {\n         found = true;\n         return;\n       }\n    });\n\n    if (found) return;\n\n    var output = '    <tr>'\n               + '      <td><?php echo functions::escape_js(functions::form_draw_hidden_field('zones[new_zone_i][id]', '')); ?></td>'\n               + '      <td><?php echo functions::escape_js(functions::form_draw_hidden_field('zones[new_zone_i][country_code]', '')); ?>' + $('select[name=\"new_zone[country_code]\"] option:selected').text() + '</td>'\n               + '      <td><?php echo functions::escape_js(functions::form_draw_hidden_field('zones[new_zone_i][zone_code]', '')); ?>' + $('select[name=\"new_zone[zone_code]\"] option:selected').text() + '</td>'\n               + '      <td><?php echo functions::escape_js(functions::form_draw_hidden_field('zones[new_zone_i][city]', '')); ?>' + $('input[name=\"new_zone[city]\"]').val() + '</td>'\n               + '      <td style=\"text-align: end;\"><a class=\"remove\" href=\"#\" title=\"<?php echo functions::escape_js(language::translate('title_remove', 'Remove'), true); ?>\"><?php echo functions::escape_js(functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"')); ?></a></td>'\n               + '    </tr>';\n\n    output = output.replace(/new_zone_i/g, 'new_' + new_zone_i++);\n    $(this).closest('table').find('tbody').append(output);\n\n    $('form[name=\"form_geo_zone\"] tbody tr:last :input[name$=\"[country_code]\"]').val($(':input[name=\"new_zone[country_code]\"]').val());\n    $('form[name=\"form_geo_zone\"] tbody tr:last :input[name$=\"[zone_code]\"]').val($(':input[name=\"new_zone[zone_code]\"]').val());\n    $('form[name=\"form_geo_zone\"] tbody tr:last :input[name$=\"[city]\"]').val($(':input[name=\"new_zone[city]\"]').val());\n\n    if ($(':input[name=\"new_zone[city]\"]').val() == '') {\n      $(':input[name=\"new_zone[zone_code]\"]').val('');\n    }\n\n    $(':input[name=\"new_zone[city]\"]').val('');\n  });\n\n  $('form[name=\"form_geo_zone\"]').on('click', '.remove', function(e) {\n    e.preventDefault();\n    $(this).closest('tr').remove();\n  });\n</script>", "<?php\n\n  if (!empty($_GET['order_id'])) {\n    $order = new ent_order($_GET['order_id']);\n  } else {\n    $order = new ent_order();\n    $order->data['client_ip'] = $_SERVER['REMOTE_ADDR'];\n    $order->data['user_agent'] = $_SERVER['HTTP_USER_AGENT'];\n    $order->data['date_created'] = date('Y-m-d H:i:s');\n  }\n\n  if (empty($_POST)) {\n\n    $_POST = $order->data;\n\n  // Convert to local currency\n    foreach (array_keys($_POST['items']) as $key) {\n      $_POST['items'][$key]['price'] = $_POST['items'][$key]['price'] / $_POST['currency_value'];\n      $_POST['items'][$key]['tax'] = $_POST['items'][$key]['tax'] / $_POST['currency_value'];\n    }\n    foreach (array_keys($_POST['order_total']) as $key) {\n      $_POST['order_total'][$key]['value'] = $_POST['order_total'][$key]['value'] / $_POST['currency_value'];\n      $_POST['order_total'][$key]['tax'] = $_POST['order_total'][$key]['tax'] / $_POST['currency_value'];\n    }\n\n    if (empty($order->data['id'])) {\n      $_POST['customer']['country_code'] = settings::get('default_country_code');\n    }\n  }\n\n  document::$snippets['title'][] = !empty($order->data['id']) ? language::translate('title_edit_order', 'Edit Order') .' #'. $order->data['id'] : language::translate('title_create_new_order', 'Create New Order');\n\n  breadcrumbs::add(language::translate('title_orders', 'Orders'), document::link(WS_DIR_ADMIN, ['doc' => 'orders'], ['app']));\n  breadcrumbs::add(!empty($order->data['id']) ? language::translate('title_edit_order', 'Edit Order') .' #'. $order->data['id'] : language::translate('title_create_new_order', 'Create New Order'));\n\n// Mark as read\n  if (!empty($order->data['id'])) {\n    database::query(\n      \"update \". DB_TABLE_PREFIX .\"orders\n      set unread = 0\n      where id = \".  (int)$order->data['id'] .\"\n      limit 1;\"\n    );\n  }\n\n// Save data to database\n  if (isset($_POST['save'])) {\n\n    try {\n      if (empty($_POST['items'])) $_POST['items'] = [];\n      if (empty($_POST['order_total'])) $_POST['order_total'] = [];\n      if (empty($_POST['comments'])) $_POST['comments'] = [];\n\n      if (!empty($_POST['items'])) {\n        foreach (array_keys($_POST['items']) as $key) {\n          $_POST['items'][$key]['price'] = (float)$_POST['items'][$key]['price'] * (float)$_POST['currency_value'];\n          $_POST['items'][$key]['tax'] = (float)$_POST['items'][$key]['tax'] * (float)$_POST['currency_value'];\n        }\n      }\n\n      if (!empty($_POST['order_total'])) {\n        foreach (array_keys($_POST['order_total']) as $key) {\n          if (empty($_POST['order_total'][$key]['calculate'])) $_POST['order_total'][$key]['calculate'] = false;\n          $_POST['order_total'][$key]['value'] = (float)$_POST['order_total'][$key]['value'] * (float)$_POST['currency_value'];\n          $_POST['order_total'][$key]['tax'] = (float)$_POST['order_total'][$key]['tax'] * (float)$_POST['currency_value'];\n        }\n      }\n\n      $fields = [\n        'unread',\n        'language_code',\n        'currency_code',\n        'currency_value',\n        'items',\n        'order_total',\n        'order_status_id',\n        'shipping_option',\n        'shipping_tracking_id',\n        'shipping_tracking_url',\n        'payment_option',\n        'payment_transaction_id',\n        'display_prices_including_tax',\n        'reference',\n        'comments',\n      ];\n\n      foreach ($fields as $field) {\n        if (isset($_POST[$field])) $order->data[$field] = $_POST[$field];\n      }\n\n      $fields = [\n        'id',\n        'email',\n        'tax_id',\n        'company',\n        'firstname',\n        'lastname',\n        'address1',\n        'address2',\n        'postcode',\n        'city',\n        'phone',\n        'country_code',\n        'zone_code',\n      ];\n\n      foreach ($fields as $field) {\n        if (isset($_POST['customer'][$field])) $order->data['customer'][$field] = $_POST['customer'][$field];\n      }\n\n      $fields = [\n        'company',\n        'firstname',\n        'lastname',\n        'address1',\n        'address2',\n        'postcode',\n        'city',\n        'country_code',\n        'zone_code',\n        'phone',\n      ];\n\n      foreach ($fields as $field) {\n        if (isset($_POST['customer']['shipping_address'][$field])) $order->data['customer']['shipping_address'][$field] = $_POST['customer']['shipping_address'][$field];\n      }\n\n      $order->save();\n\n      if (!empty($_POST['email_order_copy'])) {\n\n        $bccs = [];\n        foreach (preg_split('#[\\s;,]+#', settings::get('email_order_copy'), -1, PREG_SPLIT_NO_EMPTY) as $email) {\n          $bccs[] = $email;\n        }\n\n        $order->email_order_copy($order->data['customer']['email'], $bccs, $order->data['language_code']);\n      }\n\n      if (!empty($_GET['redirect_url'])) {\n        $redirect_url = new ent_link($_GET['redirect_url']);\n        $redirect_url->host = '';\n      } else {\n        $redirect_url = document::link(WS_DIR_ADMIN, ['app' => $_GET['app'], 'doc' => 'orders']);\n      }\n\n      notices::add('success', language::translate('success_changes_saved', 'Changes saved'));\n      header('Location: '. $redirect_url);\n      exit;\n\n    } catch (Exception $e) {\n      notices::add('errors', $e->getMessage());\n    }\n  }\n\n  if (isset($_POST['delete'])) {\n\n    try {\n      if (empty($order->data['id'])) throw new Exception(language::translate('error_must_provide_order', 'You must provide an order'));\n\n      $order->delete();\n\n      if (empty($_GET['redirect_url'])) {\n        $_GET['redirect_url'] = document::link(WS_DIR_ADMIN, ['app' => $_GET['app'], 'doc' => 'orders']);\n      }\n\n      notices::add('success', language::translate('success_changes_saved', 'Changes saved'));\n      header('Location: '. $_GET['redirect_url']);\n      exit;\n\n    } catch (Exception $e) {\n      notices::add('errors', $e->getMessage());\n    }\n  }\n\n  functions::draw_lightbox();\n\n  $account_name = '('. language::translate('title_guest', 'Guest') .')';\n  if (!empty($_POST['customer']['id'])) {\n    $customer = reference::customer((int)$_POST['customer']['id']);\n    $account_name = $customer->company ? $customer->company : $customer->firstname .' '. $customer->lastname;\n  }\n?>\n<style>\n#order-items tr.highlight {\n  border: 1px #f00 solid;\n}\n#order-items tr.extended {\n  display: none;\n}\n#order-items tr.highlight + tr.extended {\n  display: table-row;\n}\n\n#box-comments {\n  height: 100%;\n}\n\n#box-comments .bubbles .private {\n  position: absolute;\n  top: 0.5em;\n  right: 2.5em;\n  cursor: pointer;\n}\n#box-comments .bubbles .private input[name$=\"[hidden]\"] {\n  display: none;\n}\n#box-comments .bubbles .private input[name$=\"[hidden]\"] + .fa {\n  opacity: 0.25;\n}\n#box-comments .bubbles .private input[name$=\"[hidden]\"]:checked + .fa {\n  opacity: 1;\n}\n\n#box-comments .bubbles .notify  {\n  position: absolute;\n  top: 0.5em;\n  right: 4em;\n  cursor: pointer;\n}\n#box-comments .bubbles .notify input[name$=\"[notify]\"] {\n  display: none;\n}\n#box-comments .bubbles .notify input[name$=\"[notify]\"] + .fa {\n  opacity: 0.25;\n}\n#box-comments .bubbles .notify input[name$=\"[notify]\"]:checked + .fa {\n  opacity: 1;\n}\n\n\n#box-comments .bubbles .semi-transparent {\n  opacity: 0.5;\n}\n\n#modal-customer-picker tbody tr {\n  cursor: pointer;\n}\n</style>\n\n<div class=\"panel panel-app\">\n  <div class=\"panel-heading\">\n    <?php echo $app_icon; ?> <?php echo !empty($order->data['id']) ? language::translate('title_edit_order', 'Edit Order') .' #'. $order->data['id'] : language::translate('title_create_new_order', 'Create New Order'); ?>\n  </div>\n\n  <div class=\"panel-body\">\n    <?php echo functions::form_draw_form_begin('form_order', 'post'); ?>\n\n      <div class=\"row\">\n        <div class=\"col-lg-9\">\n\n          <div class=\"panel panel-default\">\n            <div class=\"panel-heading\">\n              <h2 class=\"panel-title\"><?php echo language::translate('title_order_information', 'Order Information'); ?></h2>\n            </div>\n\n            <div class=\"panel-body\">\n              <div class=\"row\">\n\n                <div class=\"form-group col-md-3\">\n                  <label><?php echo language::translate('title_order_status', 'Order Status'); ?></label>\n                  <?php echo functions::form_draw_order_status_list('order_status_id', true); ?>\n                </div>\n\n                <div class=\"form-group col-md-3\">\n                  <label><?php echo language::translate('title_language', 'Language'); ?></label>\n                  <?php echo functions::form_draw_languages_list('language_code', true); ?>\n                </div>\n\n                <div class=\"form-group col-md-3\">\n                  <label><?php echo language::translate('title_currency', 'Currency'); ?></label>\n                  <?php echo functions::form_draw_currencies_list('currency_code', true); ?>\n                </div>\n\n                <div class=\"form-group col-md-3\">\n                  <label><?php echo language::translate('title_currency_value', 'Currency Value'); ?></label>\n                  <?php echo functions::form_draw_decimal_field('currency_value', true, 6); ?>\n                </div>\n\n                <div class=\"form-group col-md-3\">\n                  <label><?php echo language::translate('title_date', 'Date'); ?></label>\n                  <div class=\"form-control\" readonly><?php echo date(language::$selected['raw_datetime'], strtotime($order->data['date_created'])); ?></div>\n                </div>\n\n                <div class=\"form-group col-md-3\">\n                  <label><?php echo language::translate('title_ip_address', 'IP Address'); ?></label>\n                  <div class=\"form-control\" readonly><?php echo $order->data['client_ip']; ?> <a href=\"https://ip-api.com/#<?php echo $order->data['client_ip']; ?>\" target=\"_blank\"><?php echo functions::draw_fonticon('fa-external-link'); ?></a></div>\n                </div>\n\n                <div class=\"form-group col-md-3\">\n                  <label><?php echo language::translate('title_reference', 'Reference'); ?></label>\n                  <?php echo functions::form_draw_text_field('reference', true); ?>\n                </div>\n\n                <div class=\"form-group col-md-3\">\n                  <label><?php echo language::translate('title_order_copy', 'Order Copy'); ?></label>\n                  <div class=\"btn-group btn-block\" data-toggle=\"buttons\">\n                    <label class=\"btn btn-default<?php echo !empty($_POST['display_prices_including_tax']) ? ' active' : ''; ?>\"><input type=\"radio\" name=\"display_prices_including_tax\" value=\"1\"<?php echo !empty($_POST['display_prices_including_tax']) ? ' checked' : ''; ?> /><?php echo language::translate('title_incl_tax', 'Incl. Tax'); ?></label>\n                    <label class=\"btn btn-default<?php echo empty($_POST['display_prices_including_tax']) ? ' active' : ''; ?>\"><input type=\"radio\" name=\"display_prices_including_tax\" value=\"0\"<?php echo empty($_POST['display_prices_including_tax']) ? ' checked' : ''; ?> /><?php echo language::translate('title_excl_tax', 'Excl. Tax'); ?></label>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n\n          <div id=\"customer-details\" class=\"panel panel-default\">\n            <div class=\"panel-heading\">\n              <h2 class=\"panel-title\"><?php echo language::translate('title_customer_information', 'Customer Information'); ?></h2>\n            </div>\n\n            <div class=\"panel-body\">\n              <div class=\"row\" style=\"margin-bottom: 0;\">\n                <div class=\"col-md-6 customer-details\">\n                  <h3><?php echo language::translate('title_billing_address', 'Billing Address'); ?></h3>\n\n                  <div class=\"form-group\">\n                    <div class=\"input-group\">\n                      <div class=\"selected-account form-control\">\n                        <?php echo functions::form_draw_hidden_field('customer[id]', true); ?>\n                        <?php echo language::translate('title_id', 'ID'); ?>:\n                        <span class=\"id\"><?php echo isset($_POST['customer']['id']) ? (int)$_POST['customer']['id'] : ''; ?></span> &ndash;\n                        <span class=\"name\"><?php echo $account_name; ?></span>\n                        <a href=\"<?php echo document::href_link(WS_DIR_ADMIN, ['app' => 'customers', 'doc' => 'customer_picker']); ?>\" data-toggle=\"lightbox\" class=\"btn btn-default btn-sm\" style=\"margin-inline-start: 5px;\"><?php echo language::translate('title_change', 'Change'); ?></a>\n                      </div>\n                      <?php echo functions::form_draw_button('get_address', language::translate('title_get_address', 'Get Address'), 'button'); ?>\n                    </div>\n                  </div>\n\n                  <div class=\"row\">\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_company', 'Company'); ?></label>\n                      <?php echo functions::form_draw_text_field('customer[company]', true); ?>\n                    </div>\n\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_tax_id', 'Tax ID / VATIN'); ?></label>\n                      <?php echo functions::form_draw_text_field('customer[tax_id]', true); ?>\n                    </div>\n                  </div>\n\n                  <div class=\"row\">\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_firstname', 'First Name'); ?></label>\n                      <?php echo functions::form_draw_text_field('customer[firstname]', true); ?>\n                    </div>\n\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_lastname', 'Last Name'); ?></label>\n                      <?php echo functions::form_draw_text_field('customer[lastname]', true); ?>\n                    </div>\n                  </div>\n\n                  <div class=\"row\">\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_address1', 'Address 1'); ?></label>\n                      <?php echo functions::form_draw_text_field('customer[address1]', true); ?>\n                    </div>\n\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_address2', 'Address 2'); ?></label>\n                      <?php echo functions::form_draw_text_field('customer[address2]', true); ?>\n                    </div>\n                  </div>\n\n                  <div class=\"row\">\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_postcode', 'Postal Code'); ?></label>\n                      <?php echo functions::form_draw_text_field('customer[postcode]', true); ?>\n                    </div>\n\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_city', 'City'); ?></label>\n                      <?php echo functions::form_draw_text_field('customer[city]', true); ?>\n                    </div>\n                  </div>\n\n                  <div class=\"row\">\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_country', 'Country'); ?></label>\n                      <?php echo functions::form_draw_countries_list('customer[country_code]', true); ?>\n                    </div>\n\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_zone_state_province', 'Zone/State/Province'); ?></label>\n                      <?php echo form_draw_zones_list(isset($_POST['customer']['country_code']) ? $_POST['customer']['country_code'] : null, 'customer[zone_code]', true); ?>\n                    </div>\n                  </div>\n\n                  <div class=\"row\">\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_email_address', 'Email Address'); ?></label>\n                      <?php echo functions::form_draw_email_field('customer[email]', true, 'required'); ?>\n                    </div>\n\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_phone', 'Phone'); ?></label>\n                      <?php echo functions::form_draw_phone_field('customer[phone]', true); ?>\n                    </div>\n                  </div>\n                </div>\n\n                <div class=\"form-group col-md-6 shipping-address\">\n                  <h3><?php echo language::translate('title_shipping_address', 'Shipping Address'); ?></h3>\n\n                  <div class=\"form-group\">\n                    <?php echo functions::form_draw_button('copy_billing_address', language::translate('title_copy_billing_address', 'Copy Billing Address'), 'button', 'class=\"btn btn-default btn-block\"'); ?>\n                  </div>\n\n                  <div class=\"row\">\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_company', 'Company'); ?></label>\n                      <?php echo functions::form_draw_text_field('customer[shipping_address][company]', true); ?>\n                    </div>\n                  </div>\n\n                  <div class=\"row\">\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_firstname', 'First Name'); ?></label>\n                      <?php echo functions::form_draw_text_field('customer[shipping_address][firstname]', true); ?>\n                    </div>\n\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_lastname', 'Last Name'); ?></label>\n                      <?php echo functions::form_draw_text_field('customer[shipping_address][lastname]', true); ?>\n                    </div>\n                  </div>\n\n                  <div class=\"row\">\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_address1', 'Address 1'); ?></label>\n                      <?php echo functions::form_draw_text_field('customer[shipping_address][address1]', true); ?>\n                    </div>\n\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_address2', 'Address 2'); ?></label>\n                      <?php echo functions::form_draw_text_field('customer[shipping_address][address2]', true); ?>\n                    </div>\n                  </div>\n\n                  <div class=\"row\">\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_postcode', 'Postal Code'); ?></label>\n                      <?php echo functions::form_draw_text_field('customer[shipping_address][postcode]', true); ?>\n                    </div>\n\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_city', 'City'); ?></label>\n                      <?php echo functions::form_draw_text_field('customer[shipping_address][city]', true); ?>\n                    </div>\n                  </div>\n\n                  <div class=\"row\">\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_country', 'Country'); ?></label>\n                      <?php echo functions::form_draw_countries_list('customer[shipping_address][country_code]', true); ?>\n                    </div>\n\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_zone_state_province', 'Zone/State/Province'); ?></label>\n                      <?php echo form_draw_zones_list(isset($_POST['customer']['shipping_address']['country_code']) ? $_POST['customer']['shipping_address']['country_code'] : null, 'customer[shipping_address][zone_code]', true); ?>\n                    </div>\n                  </div>\n\n                  <div class=\"row\">\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_phone', 'Phone'); ?></label>\n                      <?php echo functions::form_draw_phone_field('customer[shipping_address][phone]', true); ?>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n\n          <div class=\"row\" style=\"margin-bottom: 0;\">\n            <div class=\"col-md-6\">\n              <div class=\"panel panel-default\" style=\"margin-bottom: 0;\">\n                <div class=\"panel-heading\">\n                  <h2 class=\"panel-title\"><?php echo language::translate('title_payment_information', 'Payment Information'); ?></h2>\n                </div>\n\n                <div class=\"panel-body\">\n                  <div class=\"row\">\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_option_id', 'Option ID'); ?></label>\n                      <?php echo functions::form_draw_text_field('payment_option[id]', true); ?>\n                    </div>\n\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_name', 'Name'); ?></label>\n                      <?php echo functions::form_draw_text_field('payment_option[name]', true); ?>\n                    </div>\n\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_transaction_id', 'Transaction ID'); ?></label>\n                      <?php echo functions::form_draw_text_field('payment_transaction_id', true); ?>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            <div class=\"col-md-6\">\n              <div class=\"panel panel-default\" style=\"margin-bottom: 0;\">\n                <div class=\"panel-heading\">\n                  <h2 class=\"panel-title\"><?php echo language::translate('title_shipping_information', 'Shipping Information'); ?></h2>\n                </div>\n\n                <div class=\"panel-body\">\n                  <div class=\"row\">\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_option_id', 'Option ID'); ?></label>\n                      <?php echo functions::form_draw_text_field('shipping_option[id]', true); ?>\n                    </div>\n\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_name', 'Name'); ?></label>\n                      <?php echo functions::form_draw_text_field('shipping_option[name]', true); ?>\n                    </div>\n\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_tracking_id', 'Tracking ID'); ?></label>\n                      <?php echo functions::form_draw_text_field('shipping_tracking_id', true); ?>\n                    </div>\n\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_weight', 'Weight'); ?></label>\n                      <span class=\"form-control\"><?php echo weight::format($order->data['weight_total'], $order->data['weight_class']) ?></span>\n                    </div>\n\n                    <div class=\"form-group col-md-12\">\n                      <label><?php echo language::translate('title_tracking_url', 'Tracking URL'); ?></label>\n                      <?php echo functions::form_draw_url_field('shipping_tracking_url', true); ?>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n\n        <div class=\"col-lg-3\">\n          <div id=\"box-comments\" class=\"panel panel-default\" style=\"margin-bottom: 0;\">\n            <div class=\"panel-heading\">\n              <h2 class=\"panel-title\"><?php echo language::translate('title_comments', 'Comments'); ?></h2>\n            </div>\n\n            <div class=\"panel-body bubbles\">\n<?php\n  foreach (array_keys($_POST['comments']) as $key) {\n\n    switch($_POST['comments'][$key]['author']) {\n      case 'customer':\n        $type = 'remote';\n        break;\n      case 'staff':\n        $type = 'local';\n        break;\n      default:\n        $type = 'event';\n        break;\n    }\n\n    if (!empty($_POST['comments'][$key]['hidden'])) $type .= ' semi-transparent';\n?>\n              <div class=\"bubble <?php echo $type; ?>\">\n                <?php echo functions::form_draw_hidden_field('comments['. $key .'][id]', true); ?>\n                <?php echo functions::form_draw_hidden_field('comments['. $key .'][order_id]', true); ?>\n                <?php echo functions::form_draw_hidden_field('comments['. $key .'][author]', true); ?>\n                <?php echo functions::form_draw_hidden_field('comments['. $key .'][text]', true); ?>\n\n                <div class=\"text\"><?php echo nl2br($_POST['comments'][$key]['text']); ?></div>\n\n                <div class=\"date\"><?php echo language::strftime(language::$selected['format_datetime'], !empty($_POST['comments'][$key]['date_created']) ? strtotime($_POST['comments'][$key]['date_created']) : 0); ?></div>\n\n                <div class=\"actions\">\n                  <a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle'); ?></a>\n                  <label class=\"private\" title=\"<?php echo functions::escape_html(language::translate('title_hidden', 'Hidden')); ?>\"><?php echo functions::form_draw_checkbox('comments['.$key .'][hidden]', '1', true); ?> <?php echo functions::draw_fonticon('fa-eye-slash'); ?></label>\n                </div>\n              </div>\n              <?php } ?>\n\n              <div class=\"add text-end\"><button class=\"btn btn-default\" type=\"button\" title=\"<?php echo language::translate('title_add', 'Add'); ?>\"><?php echo functions::draw_fonticon('fa-plus', 'style=\"color: #66cc66;\"'); ?> <?php echo language::translate('title_add_comment', 'Add Comment'); ?></button></div>\n            </div>\n\n          </div>\n        </div>\n      </div>\n\n      <div id=\"order-items\" class=\"panel panel-default\">\n        <div class=\"panel-heading\">\n          <h2 class=\"panel-title\"><?php echo language::translate('title_order_items', 'Order Items'); ?></h2>\n        </div>\n\n        <div class=\"panel-body table-responsive\">\n          <table class=\"table table-striped table-hover table-input\">\n            <thead>\n              <tr>\n                <th><?php echo language::translate('title_item', 'Item'); ?></th>\n                <th style=\"width: 200px;\"><?php echo language::translate('title_sku', 'SKU'); ?></th>\n                <th style=\"width: 150px;\"><?php echo language::translate('title_weight', 'Weight'); ?></th>\n                <th style=\"width: 175px;\"><?php echo language::translate('title_dimensions', 'Dimensions'); ?></th>\n                <th style=\"width: 125px;\" class=\"text-center\"><?php echo language::translate('title_qty', 'Qty'); ?></th>\n                <th style=\"width: 200px;\" class=\"text-center\"><?php echo language::translate('title_unit_price', 'Unit Price'); ?></th>\n                <th style=\"width: 200px;\" class=\"text-center\"><?php echo language::translate('title_tax', 'Tax'); ?></th>\n                <th style=\"width: 75px;\">&nbsp;</th>\n              </tr>\n            </thead>\n            <tbody>\n              <?php if (!empty($_POST['items'])) foreach (array_keys($_POST['items']) as $key) { ?>\n              <tr class=\"item\">\n                <td>\n                  <?php echo !empty($_POST['items'][$key]['product_id']) ? '<a href=\"'. document::href_link(WS_DIR_ADMIN, ['app' => 'catalog', 'doc' => 'edit_product', 'product_id' => $_POST['items'][$key]['product_id']]) .'\" target=\"_blank\">'. $_POST['items'][$key]['name'] .'</a>' : $_POST['items'][$key]['name']; ?> <?php echo '<a class=\"float-end\" href=\"'. document::href_ilink('product', ['product_id' => $_POST['items'][$key]['product_id']]) .'\" target=\"_blank\">'. functions::draw_fonticon('fa-external-link') .'</a>'; ?>\n                  <?php echo functions::form_draw_hidden_field('items['.$key.'][id]', true); ?>\n                  <?php echo functions::form_draw_hidden_field('items['.$key.'][product_id]', true); ?>\n                  <?php echo functions::form_draw_hidden_field('items['.$key.'][option_stock_combination]', true); ?>\n                  <?php echo functions::form_draw_hidden_field('items['.$key.'][name]', true); ?>\n                  <?php echo functions::form_draw_hidden_field('items['. $key .'][sku]', true); ?>\n                  <?php echo functions::form_draw_hidden_field('items['. $key .'][gtin]', true); ?>\n                  <?php echo functions::form_draw_hidden_field('items['. $key .'][taric]', true); ?>\n                  <?php echo functions::form_draw_hidden_field('items['. $key .'][weight]', true); ?>\n                  <?php echo functions::form_draw_hidden_field('items['. $key .'][weight_class]', true); ?>\n                  <?php echo functions::form_draw_hidden_field('items['. $key .'][dim_x]', true); ?>\n                  <?php echo functions::form_draw_hidden_field('items['. $key .'][dim_y]', true); ?>\n                  <?php echo functions::form_draw_hidden_field('items['. $key .'][dim_z]', true); ?>\n                  <?php echo functions::form_draw_hidden_field('items['. $key .'][dim_class]', true); ?>\n<?php\n      if (!empty($_POST['items'][$key]['options'])) {\n        foreach (array_keys($_POST['items'][$key]['options']) as $field) {\n          echo '<div>' . PHP_EOL\n             . ' - '. $field .': ' . PHP_EOL;\n          if (is_array($_POST['items'][$key]['options'][$field])) {\n            $use_comma = false;\n            foreach (array_keys($_POST['items'][$key]['options'][$field]) as $k) {\n              echo '  ' . functions::form_draw_hidden_field('items['.$key.'][options]['.$field.']['.$k.']', true) . $_POST['items'][$key]['options'][$field][$k];\n              if ($use_comma) echo ', ';\n              $use_comma = true;\n            }\n          } else {\n            echo '  ' . functions::form_draw_hidden_field('items['.$key.'][options]['.$field.']', true) . $_POST['items'][$key]['options'][$field];\n          }\n          echo '</div>' . PHP_EOL;\n        }\n      } else {\n        echo functions::form_draw_hidden_field('items['.$key.'][options]', '');\n      }\n?>\n              </td>\n              <td class=\"sku\"><?php echo $_POST['items'][$key]['sku']; ?></td>\n              <td>\n                <span class=\"weight\"><?php echo (float)$_POST['items'][$key]['weight']; ?></span> <span class=\"weight_class\"><?php echo $_POST['items'][$key]['weight_class']; ?></span>\n              </td>\n              <td>\n                <span class=\"dim_x\"><?php echo (float)$_POST['items'][$key]['dim_x']; ?></span> x <span class=\"dim_y\"><?php echo (float)$_POST['items'][$key]['dim_y']; ?></span> x <span class=\"dim_z\"><?php echo (float)$_POST['items'][$key]['dim_z']; ?></span> <span class=\"dim_class\"><?php echo $_POST['items'][$key]['dim_class']; ?></span>\n              </td>\n              <td><?php echo functions::form_draw_decimal_field('items['. $key .'][quantity]', true, 2); ?></td>\n              <td><?php echo functions::form_draw_currency_field($_POST['currency_code'], 'items['. $key .'][price]', true); ?></td>\n              <td><?php echo functions::form_draw_currency_field($_POST['currency_code'], 'items['. $key .'][tax]', true); ?></td>\n              <td class=\"text-end\">\n                <a class=\"edit\" href=\"#\" title=\"<?php echo language::translate('title_edit', 'Edit'); ?>\"><?php echo functions::draw_fonticon('fa-pencil fa-fw'); ?></a>\n                <a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-lg fa-fw', 'style=\"color: #cc3333;\"'); ?></a>\n              </td>\n            </tr>\n            <?php } ?>\n          </tbody>\n          <tfoot>\n            <tr>\n              <td colspan=\"8\">\n                <a class=\"btn btn-default add-product\" href=\"<?php echo document::href_link('', ['doc' => 'product_picker'], ['app'], []); ?>\" data-toggle=\"lightbox\" data-width=\"\" data-href=\"<?php echo document::href_link('', ['doc' => 'product_picker'], ['app'], []); ?>\"><?php echo functions::draw_fonticon('fa-plus', 'style=\"color: #66cc66;\"'); ?> <?php echo language::translate('title_add_product', 'Add Product'); ?></a>\n                <div class=\"btn btn-default add-custom-item\"><?php echo functions::draw_fonticon('fa-plus', 'style=\"color: #66cc66;\"'); ?> <?php echo language::translate('title_add_custom_item', 'Add Custom Item'); ?></div>\n              </td>\n            </tr>\n          </tfoot>\n        </table>\n      </div>\n    </div>\n\n      <div id=\"order-total\" class=\"panel panel-default\">\n        <div class=\"panel-heading\">\n          <h2 class=\"panel-title\"><?php echo language::translate('title_order_total', 'Order Total'); ?></h2>\n        </div>\n\n        <div class=\"panel-body table-responsive\">\n          <table class=\"table table-striped table-hover\">\n            <thead>\n              <tr>\n                <th style=\"width: 30px;\">&nbsp;</th>\n                <th style=\"width: 250px;\"><?php echo language::translate('title_module_id', 'Module ID'); ?></th>\n                <th class=\"text-end\"><?php echo language::translate('title_title', 'Title'); ?></th>\n                <th style=\"width: 250px;\"><?php echo language::translate('title_value', 'Value'); ?></th>\n                <th style=\"width: 250px;\"><?php echo language::translate('title_tax', 'Tax'); ?></th>\n                <th style=\"width: 30px;\">&nbsp;</th>\n              </tr>\n            </thead>\n            <tbody>\n<?php\n  if (empty($_POST['order_total'])) {\n    $_POST['order_total'][] = [\n      'id' => '',\n      'module_id' => 'ot_subtotal',\n      'title' => language::translate('title_subtotal', 'Subtotal'),\n      'value' => '0',\n      'tax' => '0',\n      'calculate' => '0',\n    ];\n  }\n  foreach (array_keys($_POST['order_total']) as $key) {\n    switch($_POST['order_total'][$key]['module_id']) {\n      case 'ot_subtotal':\n?>\n              <tr>\n                <td class=\"text-end\">&nbsp;</td>\n                <td class=\"text-end\"><?php echo functions::form_draw_hidden_field('order_total['. $key .'][id]', true) . functions::form_draw_text_field('order_total['. $key .'][module_id]', true, 'readonly'); ?></td>\n                <td class=\"text-end\"><?php echo functions::form_draw_text_field('order_total['. $key .'][title]', true, 'class=\"form-control text-end\"'); ?></td>\n                <td class=\"text-end\">\n                  <div class=\"input-group\">\n                    <span class=\"input-group-text\"><?php echo functions::form_draw_checkbox('order_total['. $key .'][calculate]', '1', true, 'disabled title=\"'. functions::escape_html(language::translate('title_calculate', 'Calculate')).'\"'); ?></span>\n                    <?php echo functions::form_draw_currency_field($_POST['currency_code'], 'order_total['. $key .'][value]', true, 'style=\"text-align: end;\"'); ?>\n                  </div>\n                </td>\n                <td class=\"text-end\"><?php echo functions::form_draw_currency_field($_POST['currency_code'], 'order_total['. $key .'][tax]', true, 'style=\"text-align: end;\"'); ?></td>\n                <td></td>\n              </tr>\n<?php\n        break;\n      default:\n?>\n              <tr>\n                <td class=\"text-end\"><a href=\"#\" class=\"add\" title=\"<?php echo language::translate('text_insert_before', 'Insert before'); ?>\"><?php echo functions::draw_fonticon('fa-plus', 'style=\"color: #66cc66;\"'); ?></a></td>\n                <td class=\"text-end\"><?php echo functions::form_draw_hidden_field('order_total['. $key .'][id]', true) . functions::form_draw_text_field('order_total['. $key .'][module_id]', true); ?></td>\n                <td class=\"text-end\"><?php echo functions::form_draw_text_field('order_total['. $key .'][title]', true, 'style=\"text-align: end;\"'); ?></td>\n                <td class=\"text-end\">\n                  <div class=\"input-group\">\n                  <span class=\"input-group-text\"><?php echo functions::form_draw_checkbox('order_total['. $key .'][calculate]', '1', true, 'title=\"'. functions::escape_html(language::translate('title_calculate', 'Calculate')) .'\"'); ?></span>\n                  <?php echo functions::form_draw_currency_field($_POST['currency_code'], 'order_total['. $key .'][value]', true, 'style=\"text-align: end;\"'); ?>\n                  </div>\n                </td>\n                <td class=\"text-end\"><?php echo functions::form_draw_currency_field($_POST['currency_code'], 'order_total['. $key .'][tax]', true, 'style=\"text-align: end;\"'); ?></td>\n                <td><a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-lg fa-fw', 'style=\"color: #cc3333;\"'); ?></a></td>\n              </tr>\n<?php\n        break;\n    }\n  }\n?>\n              <tr>\n                <td colspan=\"6\"><a class=\"add\" href=\"#\" title=\"<?php echo language::translate('title_insert_', 'Insert'); ?>\"><?php echo functions::draw_fonticon('fa-plus', 'style=\"color: #66cc66;\"'); ?></a></td>\n              </tr>\n            </tbody>\n            <tfoot>\n              <tr>\n                <td colspan=\"6\" class=\"text-end\" style=\"font-size: 1.5em;\"><?php echo language::translate('title_payment_due', 'Payment Due'); ?>: <strong class=\"total\"><?php echo currency::format($order->data['payment_due'], false, $_POST['currency_code'], $_POST['currency_value']); ?></strong></td>\n              </tr>\n            </tfoot>\n          </table>\n        </div>\n      </div>\n\n      <div class=\"panel-action\">\n        <ul class=\"list-inline\">\n          <li>\n            <div class=\"checkbox\">\n              <label><?php echo functions::form_draw_checkbox('email_order_copy', '1', true); ?> <?php echo language::translate('text_send_order_copy_email', 'Send order copy email'); ?></label>\n            </div>\n          </li>\n          <li>\n            <div class=\"checkbox\">\n              <label><?php echo functions::form_draw_checkbox('unread', '1', false); ?> <?php echo language::translate('title_mark_as_unread', 'Mark as unread'); ?></label>\n            </div>\n          </li>\n          <li>\n            <div class=\"btn-group\">\n              <?php echo functions::form_draw_button('save', language::translate('title_save', 'Save'), 'submit', '', 'save'); ?>\n              <?php echo functions::form_draw_button('cancel', language::translate('title_cancel', 'Cancel'), 'button', 'onclick=\"history.go(-1);\"', 'cancel'); ?>\n              <?php echo (isset($order->data['id'])) ? functions::form_draw_button('delete', language::translate('title_delete', 'Delete'), 'submit', 'formnovalidate onclick=\"if (!window.confirm(\\''. language::translate('text_are_you_sure', 'Are you sure?') .'\\')) return false;\"', 'delete') : false; ?>\n            </div>\n          </li>\n        </ul>\n      </div>\n\n    <?php echo functions::form_draw_form_end(); ?>\n  </div>\n</div>\n\n<div id=\"modal-customer-picker\" class=\"modal fade\" style=\"max-width: 640px; display: none;\">\n\n  <h2><?php echo language::translate('title_customer', 'Customer'); ?></h2>\n\n  <div class=\"modal-body\">\n    <div class=\"form-group\">\n      <?php echo functions::form_draw_text_field('query', true, 'placeholder=\"'. functions::escape_html(language::translate('title_search', 'Search')) .'\"'); ?>\n    </div>\n\n    <div class=\"form-group results table-responsive\">\n      <table class=\"table table-striped table-hover data-table\">\n        <thead>\n          <tr>\n            <th><?php echo language::translate('title_id', 'ID'); ?></th>\n            <th><?php echo language::translate('title_name', 'Name'); ?></th>\n            <th class=\"main\"><?php echo language::translate('title_email', 'Email'); ?></th>\n            <th><?php echo language::translate('title_date_registered', 'Date Registered'); ?></th>\n          </tr>\n        </thead>\n        <tbody />\n      </table>\n\n      <p class=\"text-center\"><button class=\"set-guest btn btn-default\" type=\"button\"><?php echo language::translate('text_set_as_guest', 'Set As Guest'); ?></button></p>\n    </div>\n  </div>\n</div>\n\n<div id=\"modal-edit-order-item\" class=\"modal fade\" style=\"max-width: 640px; display: none;\">\n\n  <h2><?php echo language::translate('title_edit_order_item', 'Edit Order Item'); ?></h2>\n\n  <div class=\"modal-body\">\n\n    <div class=\"row\">\n      <div class=\"form-group col-md-9\">\n        <label><?php echo language::translate('title_name', 'Name'); ?></label>\n        <?php echo functions::form_draw_text_field('name', ''); ?>\n      </div>\n\n      <div class=\"form-group col-md-3\">\n        <label><?php echo language::translate('title_product_id', 'Product ID'); ?></label>\n        <?php echo functions::form_draw_number_field('product_id', ''); ?>\n      </div>\n    </div>\n\n    <div class=\"row\">\n      <div class=\"form-group col-md-4\">\n        <label><?php echo language::translate('title_sku', 'SKU'); ?></label>\n        <?php echo functions::form_draw_text_field('sku', ''); ?>\n      </div>\n\n      <div class=\"form-group col-md-4\">\n        <label><?php echo language::translate('title_gtin', 'GTIN'); ?></label>\n        <?php echo functions::form_draw_text_field('gtin', ''); ?>\n      </div>\n\n      <div class=\"form-group col-md-4\">\n        <label><?php echo language::translate('title_taric', 'TARIC'); ?></label>\n        <?php echo functions::form_draw_text_field('taric', ''); ?>\n      </div>\n    </div>\n\n    <div class=\"row\">\n      <div class=\"form-group col-md-4\">\n        <label><?php echo language::translate('title_weight', 'Weight'); ?></label>\n        <div class=\"input-group\">\n          <?php echo functions::form_draw_decimal_field('weight', '', 2, 0); ?>\n          <?php echo functions::form_draw_weight_classes_list('weight_class', settings::get('store_weight_class'), false, 'style=\"width: auto;\"'); ?>\n        </div>\n      </div>\n\n      <div class=\"form-group col-md-8\">\n        <label><?php echo language::translate('title_dimensions', 'Dimensions'); ?></label>\n        <div class=\"input-group\">\n          <?php echo functions::form_draw_decimal_field('dim_x', '', 1, 0); ?>\n          <span class=\"input-group-text\">x</span>\n          <?php echo functions::form_draw_decimal_field('dim_y', '', 1, 0); ?>\n          <span class=\"input-group-text\">x</span>\n          <?php echo functions::form_draw_decimal_field('dim_z', '', 1, 0); ?>\n          <?php echo functions::form_draw_length_classes_list('dim_class', settings::get('store_length_class'), false, 'style=\"width: auto;\"'); ?>\n        </div>\n      </div>\n    </div>\n\n    <div class=\"row\">\n        <div class=\"form-group col-md-4\">\n        <label><?php echo language::translate('title_quantity', 'quantity'); ?></label>\n        <?php echo functions::form_draw_decimal_field('quantity', ''); ?>\n      </div>\n\n        <div class=\"form-group col-md-4\">\n        <label><?php echo language::translate('title_price', 'Price'); ?></label>\n        <?php echo functions::form_draw_currency_field($_POST['currency_code'], 'price', ''); ?>\n      </div>\n\n        <div class=\"form-group col-md-4\">\n        <label><?php echo language::translate('title_tax', 'Tax'); ?></label>\n        <?php echo functions::form_draw_currency_field($_POST['currency_code'], 'tax', ''); ?>\n      </div>\n    </div>\n\n    <div class=\"btn-group\">\n      <?php echo functions::form_draw_button('ok', language::translate('title_ok', 'OK'), 'button', '', 'ok'); ?>\n      <?php echo functions::form_draw_button('cancel', language::translate('title_cancel', 'Cancel'), 'button', 'onclick=\"$.featherlight.close();\"', 'cancel'); ?>\n    </div>\n  </div>\n</div>\n\n<div id=\"modal-add-order-item\" class=\"modal fade\" style=\"max-width: 640px; display: none;\">\n\n  <h2><?php echo language::translate('title_add_order_item', 'Add Order Item'); ?></h2>\n\n  <div class=\"modal-body\">\n\n    <div class=\"row\">\n      <div class=\"form-group col-md-9\">\n        <label><?php echo language::translate('title_name', 'Name'); ?></label>\n        <?php echo functions::form_draw_text_field('name', ''); ?>\n      </div>\n\n      <div class=\"form-group col-md-3\">\n        <label><?php echo language::translate('title_product_id', 'Product ID'); ?></label>\n        <?php echo functions::form_draw_number_field('product_id', ''); ?>\n      </div>\n    </div>\n\n    <div class=\"row\">\n      <div class=\"form-group col-md-4\">\n        <label><?php echo language::translate('title_sku', 'SKU'); ?></label>\n        <?php echo functions::form_draw_text_field('sku', ''); ?>\n      </div>\n\n      <div class=\"form-group col-md-4\">\n        <label><?php echo language::translate('title_gtin', 'GTIN'); ?></label>\n        <?php echo functions::form_draw_text_field('gtin', ''); ?>\n      </div>\n\n      <div class=\"form-group col-md-4\">\n        <label><?php echo language::translate('title_taric', 'TARIC'); ?></label>\n        <?php echo functions::form_draw_text_field('taric', ''); ?>\n      </div>\n    </div>\n\n    <div class=\"row\">\n      <div class=\"form-group col-md-4\">\n        <label><?php echo language::translate('title_weight', 'Weight'); ?></label>\n        <div class=\"input-group\">\n          <?php echo functions::form_draw_decimal_field('weight', '', 2, 0); ?>\n          <?php echo functions::form_draw_weight_classes_list('weight_class', '', false, 'style=\"width: auto;\"'); ?>\n        </div>\n      </div>\n\n      <div class=\"form-group col-md-8\">\n        <label><?php echo language::translate('title_dimensions', 'Dimensions'); ?></label>\n        <div class=\"input-group\">\n          <?php echo functions::form_draw_decimal_field('dim_x', '', 1, 0); ?>\n          <span class=\"input-group-text\">x</span>\n          <?php echo functions::form_draw_decimal_field('dim_y', '', 1, 0); ?>\n          <span class=\"input-group-text\">x</span>\n          <?php echo functions::form_draw_decimal_field('dim_z', '', 1, 0); ?>\n          <?php echo functions::form_draw_length_classes_list('dim_class', '', false, 'style=\"width: auto;\"'); ?>\n        </div>\n      </div>\n    </div>\n\n    <div class=\"row\">\n        <div class=\"form-group col-md-4\">\n        <label><?php echo language::translate('title_quantity', 'quantity'); ?></label>\n        <?php echo functions::form_draw_decimal_field('quantity', '0'); ?>\n      </div>\n\n        <div class=\"form-group col-md-4\">\n        <label><?php echo language::translate('title_price', 'Price'); ?></label>\n        <?php echo functions::form_draw_currency_field($_POST['currency_code'], 'price', '0'); ?>\n      </div>\n\n        <div class=\"form-group col-md-4\">\n        <label><?php echo language::translate('title_tax', 'Tax'); ?></label>\n        <?php echo functions::form_draw_currency_field($_POST['currency_code'], 'tax', '0'); ?>\n      </div>\n    </div>\n\n    <div class=\"btn-group\">\n      <?php echo functions::form_draw_button('ok', language::translate('title_ok', 'OK'), 'button', '', 'ok'); ?>\n      <?php echo functions::form_draw_button('cancel', language::translate('title_cancel', 'Cancel'), 'button', 'onclick=\"$.featherlight.close();\"', 'cancel'); ?>\n    </div>\n  </div>\n</div>\n\n<script>\n// Order\n\n  $('select[name=\"currency_code\"]').change(function(e){\n    $('input[name=\"currency_value\"]').val($(this).find('option:selected').data('value'));\n    $('input[data-type=\"currency\"]').closest('.input-group').find('.input-group-text').text($(this).val());\n    calculate_total();\n  });\n\n// Customer\n\n  $('#customer-details button[name=\"get_address\"]').click(function() {\n    $.ajax({\n      url: '<?php echo document::link(WS_DIR_ADMIN, ['app' => 'customers', 'doc' => 'get_address.json']); ?>',\n      type: 'post',\n      data: 'customer_id=' + $('*[name=\"customer[id]\"]').val(),\n      cache: true,\n      async: false,\n      dataType: 'json',\n      error: function(jqXHR, textStatus, errorThrown) {\n        if (console) console.warn(errorThrown.message);\n      },\n      success: function(data) {\n        $.each(data, function(key, value) {\n          if (key.match(/^shipping_address/)) {\n            $.each(value, function(key, value) {\n              if ($('*[name=\"customer[shipping_address]['+key+']\"]').length) $('*[name=\"customer[shipping_address]['+key+']\"]').val(value).trigger('change');\n            });\n          } else {\n            if ($('*[name=\"customer['+key+']\"]').length) $('*[name=\"customer['+key+']\"]').val(value).trigger('change');\n          }\n        });\n      },\n    });\n  });\n\n  $('#customer-details select[name=\"customer[country_code]\"]').change(function() {\n\n    if ($(this).find('option:selected').data('tax-id-format')) {\n      $('input[name=\"customer[tax_id]\"]').attr('pattern', $(this).find('option:selected').data('tax-id-format'));\n    } else {\n      $('input[name=\"customer[tax_id]\"]').removeAttr('pattern');\n    }\n\n    if ($(this).find('option:selected').data('postcode-format')) {\n      $('input[name=\"customer[postcode]\"]').attr('pattern', $(this).find('option:selected').data('postcode-format'));\n    } else {\n      $('input[name=\"customer[postcode]\"]').removeAttr('pattern');\n    }\n\n    if ($(this).find('option:selected').data('phone-code')) {\n      $('input[name=\"customer[phone]\"]').attr('placeholder', '+' + $(this).find('option:selected').data('phone-code'));\n    } else {\n      $('input[name=\"customer[phone]\"]').removeAttr('placeholder');\n    }\n\n    $('body').css('cursor', 'wait');\n    $.ajax({\n      url: '<?php echo document::ilink('ajax/zones.json'); ?>?country_code=' + $(this).val(),\n      type: 'get',\n      cache: true,\n      async: false,\n      dataType: 'json',\n      error: function(jqXHR, textStatus, errorThrown) {\n        //alert(jqXHR.readyState + '\\n' + textStatus + '\\n' + errorThrown.message);\n      },\n      success: function(data) {\n        $('select[name=\"customer[zone_code]\"]').html('');\n        if ($('select[name=\"customer[zone_code]\"]').attr('disabled')) $('select[name=\"customer[zone_code]\"]').prop('disabled', false);\n        if (data) {\n          $.each(data, function(i, zone) {\n            $('select[name=\"customer[zone_code]\"]').append('<option value=\"'+ zone.code +'\">'+ zone.name +'</option>');\n          });\n        } else {\n          $('select[name=\"customer[zone_code]\"]').prop('disabled', true);\n        }\n      },\n      complete: function() {\n        $('body').css('cursor', 'auto');\n      }\n    });\n  });\n\n  $('#customer-details button[name=\"copy_billing_address\"]').click(function(){\n    fields = ['company', 'firstname', 'lastname', 'address1', 'address2', 'postcode', 'city', 'country_code', 'zone_code', 'phone'];\n    $.each(fields, function(key, field){\n      $('*[name=\"customer[shipping_address]['+ field +']\"]').val($('*[name=\"customer['+ field +']\"]').val()).trigger('change');\n    });\n  });\n\n  $('#customer-details select[name=\"customer[shipping_address][country_code]\"]').change(function(){\n\n    if ($(this).find('option:selected').data('postcode-format')) {\n      $('input[name=\"customer[shipping_address][postcode]\"]').attr('pattern', $(this).find('option:selected').data('postcode-format'));\n    } else {\n      $('input[name=\"customer[shipping_address][postcode]\"]').removeAttr('pattern');\n    }\n\n    if ($(this).find('option:selected').data('phone-code')) {\n      $('input[name=\"customer[shipping_address][phone]\"]').attr('placeholder', '+' + $(this).find('option:selected').data('phone-code'));\n    } else {\n      $('input[name=\"customer[shipping_address][phone]\"]').removeAttr('placeholder');\n    }\n\n    $('body').css('cursor', 'wait');\n    $.ajax({\n      url: '<?php echo document::ilink('ajax/zones.json'); ?>?country_code=' + $(this).val(),\n      type: 'get',\n      cache: true,\n      async: true,\n      dataType: 'json',\n      error: function(jqXHR, textStatus, errorThrown) {\n        //alert(jqXHR.readyState + '\\n' + textStatus + '\\n' + errorThrown.message);\n      },\n      success: function(data) {\n        $('select[name=\"customer[shipping_address][zone_code]\"]').html('');\n        if ($('select[name=\"customer[shipping_address][zone_code]\"]').attr('disabled')) $('select[name=\"customer[shipping_address][zone_code]\"]').prop('disabled', false);\n        if (data) {\n          $.each(data, function(i, zone) {\n            $('select[name=\"customer[shipping_address][zone_code]\"]').append('<option value=\"'+ zone.code +'\">'+ zone.name +'</option>');\n          });\n        } else {\n          $('select[name=\"customer[shipping_address][zone_code]]\"]').prop('disabled', true);\n        }\n      },\n      complete: function() {\n        $('body').css('cursor', 'auto');\n      }\n    });\n  });\n\n  if ($('select[name=\"customer[country_code]\"] option:selected').data('tax-id-format')) {\n    $('input[name=\"customer[tax_id]\"]').attr('pattern', $('select[name=\"country_code\"] option:selected').data('tax-id-format'));\n  } else {\n    $('input[name=\"customer[tax_id]\"]').removeAttr('pattern');\n  }\n\n  if ($('select[name=\"customer[country_code]\"] option:selected').data('postcode-format')) {\n    $('input[name=\"customer[postcode]\"]').attr('pattern', $('select[name=\"customer[country_code]\"] option:selected').data('postcode-format'));\n  } else {\n    $('input[name=\"customer[postcode]\"]').removeAttr('pattern');\n  }\n\n  if ($('select[name=\"customer[country_code]\"] option:selected').data('phone-code')) {\n    $('input[name=\"customer[phone]\"]').attr('placeholder', '+' + $('select[name=\"customer[country_code]\"] option:selected').data('phone-code'));\n  } else {\n    $('input[name=\"customer[phone]\"]').removeAttr('placeholder');\n  }\n\n  if ($('select[name=\"customer[shipping_address][country_code]\"] option:selected').data('postcode-format')) {\n    $('input[name=\"customer[shipping_address][postcode]\"]').attr('pattern', $('select[name=\"customer[shipping_address][country_code]\"] option:selected').data('postcode-format'));\n  } else {\n    $('input[name=\"customer[shipping_address][postcode]\"]').removeAttr('pattern');\n  }\n\n  if ($('select[name=\"customer[shipping_address][country_code]\"] option:selected').data('phone-code')) {\n    $('input[name=\"customer[shipping_address][phone]\"]').attr('placeholder', '+' + $('select[name=\"customer[shipping_address][country_code]\"] option:selected').data('phone-code'));\n  } else {\n    $('input[name=\"customer[shipping_address][phone]\"]').removeAttr('placeholder');\n  }\n\n  $('select[name=\"language_code\"], select[name=\"currency_code\"], input[name=\"currency_value\"], :input[name^=\"customer\"]').on('input change', function(){\n    var params = {\n      language_code: $('select[name=\"language_code\"]').val(),\n      currency_code: $('select[name=\"currency_code\"]').val(),\n      currency_value: $('input[name=\"currency_value\"]').val(),\n      customer: {\n        id: $(':input[name=\"customer[id]\"]').val(),\n        tax_id: $('input[name=\"customer[tax_id]\"]').val(),\n        company: $('input[name=\"customer[company]\"]').val(),\n        country_code: $('select[name=\"customer[country_code]\"]').val(),\n        zone_code: $('select[name=\"customer[zone_code]\"]').val(),\n        city: $('select[name=\"customer[city]\"]').val(),\n        shipping_address: {\n          company: $('input[name=\"customer[shipping_address][company]\"]').val(),\n          country_code: $('select[name=\"customer[shipping_address][country_code]\"]').val(),\n          zone_code: $('select[name=\"customer[shipping_address][zone_code]\"]').val(),\n          city: $('select[name=\"customer[shipping_address][city]\"]').val(),\n        }\n      }\n    }\n\n    $('.add-product').attr('href', $('.add-product').data('href') +'&'+ $.param(params));\n  });\n\n  $(':input[name^=\"customer\"]').first().trigger('input');\n\n// Comments\n\n  $('#box-comments').on('input', 'textarea[name^=\"comments\"][name$=\"[text]\"]', function(){\n    $(this).height('auto').height('calc(' + $(this).prop('scrollHeight') + 'px + 1em) ');\n  }).trigger('input');\n\n  $(\"#comments\").animate({scrollTop: $('#comments').prop('scrollHeight')}, 2000);\n\n  var new_comment_index = 0;\n  $('#box-comments .add').click(function(e) {\n\n    e.preventDefault();\n    while ($('input[name=\"comments[new_'+new_comment_index+'][id]\"]').length) new_comment_index++;\n    var output = '  <div class=\"bubble local me\">'\n               + '    <?php echo functions::form_draw_hidden_field('comments[new_comment_index][id]', ''); ?>'\n               + '    <?php echo functions::form_draw_hidden_field('comments[new_comment_index][author]', 'staff'); ?>'\n               + '    <?php echo functions::form_draw_hidden_field('comments[new_comment_index][date_created]', language::strftime(language::$selected['format_datetime'])); ?>'\n               + '    <div class=\"text\"><?php echo functions::escape_js(functions::form_draw_textarea('comments[new_comment_index][text]', '')); ?></div>'\n               + '    <div class=\"date\"><?php echo language::strftime(language::$selected['format_datetime']); ?></div>'\n               + '    <div class=\"actions\">'\n               + '      <label class=\"notify\" title=\"<?php echo functions::escape_html(language::translate('title_notify', 'Notify')); ?>\"><?php echo functions::form_draw_checkbox('comments[new_comment_index][notify]', 1, true); ?> <?php echo functions::draw_fonticon('fa-envelope'); ?></label>'\n               + '      <label class=\"private\" title=\"<?php echo functions::escape_html(language::translate('title_hidden', 'Hidden')); ?>\"><?php echo functions::form_draw_checkbox('comments[new_comment_index][hidden]', 1, true); ?> <?php echo functions::draw_fonticon('fa-eye-slash'); ?></label>'\n               + '      <a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-lg fa-fw'); ?></a>'\n               + '    </div>'\n               + '  </div>';\n    output = output.replace(/new_comment_index/g, 'new_' + new_comment_index);\n    $(this).before(output);\n    $(this).closest('#box-comments .bubbles textarea:last-child').focus();\n  });\n\n  $('#box-comments').on('click', ':input[name$=\"[hidden]\"]', function(e) {\n    $(this).closest('.bubble').find(':input[name$=\"[notify]\"]').prop('checked', false).trigger('change');\n  });\n\n  $('#box-comments').on('click', ':input[name$=\"[notify]\"]', function(e) {\n    $(this).closest('.bubble').find(':input[name$=\"[hidden]\"]').prop('checked', false).trigger('change');\n  });\n\n  $('#box-comments').on('click', '.remove', function(e) {\n    e.preventDefault();\n    $(this).closest('.bubble').remove();\n  });\n\n  $('#box-comments .bubbles').on('change', 'input[name^=\"comments\"][name$=\"[hidden]\"]', function(e) {\n    if ($(this).is(':checked')) {\n      $(this).closest('.bubble').addClass('semi-transparent');\n    } else {\n      $(this).closest('.bubble').removeClass('semi-transparent');\n    }\n  });\n\n// Order items\n\n  $('#order-items').on('click', '.edit', function(){\n    $.featherlight('#modal-edit-order-item');\n\n    var modal = $('.featherlight.active'),\n        row = $(this).closest('tr');\n\n    $(modal).data('row', row);\n\n    $.each($(modal).find(':input'), function(i,element){\n      var field = $(element).attr('name');\n      var value = $(row).find(':input[name$=\"['+field+']\"]').val();\n      if ($(modal).find(':input[name=\"'+field+'\"]').attr('type') == 'number') value = parseFloat(value || 0);\n      $(modal).find(':input[name=\"'+field+'\"]').val(value);\n    });\n  });\n\n  $('#order-items .add-custom-item').click(function(){\n    $.featherlight('#modal-add-order-item');\n\n    var modal = $('.featherlight.active'),\n        row = $(this).closest('tr');\n\n    $(modal).data('row', '');\n  });\n\n  $('#modal-edit-order-item button[name=\"ok\"]').click(function(e){\n\n    var modal = $('.featherlight.active');\n    var row = $(modal).data('row');\n    var fields = [\n      'name',\n      'sku',\n      'gtin',\n      'taric',\n      'weight',\n      'weight_class',\n      'dim_x',\n      'dim_y',\n      'dim_z',\n      'dim_class',\n      'price',\n      'tax',\n    ];\n\n    if (row == '') {\n      var item = {};\n      $.each($(modal).find(':input'), function(i,element){\n        var field = $(element).attr('name');\n        item[field] = $(modal).find(':input[name=\"'+field+'\"]').val();\n      });\n      addItem(item);\n    }\n\n    $(modal).find(':input[name=\"weight_class\"]').val('<?php echo settings::get('store_weight_class'); ?>');\n    $(modal).find(':input[name=\"length_class\"]').val('<?php echo settings::get('store_length_class'); ?>');\n\n    $.each($(modal).find(':input'), function(i,element){\n      var field = $(element).attr('name');\n      var value = $(modal).find(':input[name=\"'+field+'\"]').val();\n      $(row).find(':input[name$=\"['+field+']\"]').val(value).trigger('keyup');\n      $(row).find('.'+field).text(value);\n    });\n\n    $.featherlight.close();\n  });\n\n  $('#modal-add-order-item button[name=\"ok\"]').click(function(e){\n\n    var modal = $('.featherlight.active');\n    var row = $(modal).data('row');\n    var item = {};\n    var fields = [\n      'name',\n      'sku',\n      'gtin',\n      'taric',\n      'weight',\n      'weight_class',\n      'dim_x',\n      'dim_y',\n      'dim_z',\n      'dim_class',\n      'price',\n      'tax',\n    ];\n\n    $.each($(modal).find(':input'), function(i,element){\n      var field = $(element).attr('name');\n      item[field] = $(modal).find(':input[name=\"'+field+'\"]').val();\n    });\n\n    addItem(item);\n\n    $.featherlight.close();\n  });\n\n  var new_item_index = 0;\n  window.addItem = function(item) {\n    new_item_index++;\n\n    var output = '  <tr class=\"item\">'\n               + '    <td>' + item.name\n               + '      <?php echo functions::escape_js(functions::form_draw_hidden_field('items[new_item_index][id]', '')); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_hidden_field('items[new_item_index][product_id]', '')); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_hidden_field('items[new_item_index][option_stock_combination]', '')); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_hidden_field('items[new_item_index][options]', '')); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_hidden_field('items[new_item_index][name]', '')); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_hidden_field('items[new_item_index][sku]', '')); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_hidden_field('items[new_item_index][gtin]', '')); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_hidden_field('items[new_item_index][taric]', '')); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_hidden_field('items[new_item_index][weight]', '')); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_hidden_field('items[new_item_index][weight_class]', '')); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_hidden_field('items[new_item_index][dim_x]', '')); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_hidden_field('items[new_item_index][dim_y]', '')); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_hidden_field('items[new_item_index][dim_z]', '')); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_hidden_field('items[new_item_index][dim_class]', '')); ?>'\n               + '    </td>'\n               + '    <td>'+ item.sku +'</td>'\n               + '    <td>'\n               + '      <span class=\"weight\"></span> <span class=\"weight_class\"></span>'\n               + '    </td>'\n               + '    <td>'\n               + '      <span class=\"dim_x\"></span> x <span class=\"dim_y\"></span> x <span class=\"dim_z\"></span> <span class=\"dim_class\"></span>'\n               + '    </td>'\n               + '    <td><?php echo functions::escape_js(functions::form_draw_decimal_field('items[new_item_index][quantity]', '', 2)); ?></td>'\n               + '    <td><?php echo functions::escape_js(functions::form_draw_currency_field($_POST['currency_code'], 'items[new_item_index][price]', '')); ?></td>'\n               + '    <td><?php echo functions::escape_js(functions::form_draw_currency_field($_POST['currency_code'], 'items[new_item_index][tax]', '')); ?></td>'\n               + '    <td class=\"text-end\">'\n               + '      <a class=\"edit\" href=\"#\" title=\"<?php echo functions::escape_js(language::translate('title_edit', 'Edit'), true); ?>\"><?php echo functions::escape_js(functions::draw_fonticon('fa-pencil fa-fw')); ?></a>'\n               + '      <a class=\"remove\" href=\"#\" title=\"<?php echo functions::escape_js(language::translate('title_remove', 'Remove'), true); ?>\"><?php echo functions::escape_js(functions::draw_fonticon('fa-times-circle fa-lg fa-fw', 'style=\"color: #cc3333;\"')); ?></a>'\n               + '    </td>'\n               + '  </tr>';\n\n    output = output.replace(/new_item_index/g, 'new_' + new_item_index);\n    $('#order-items tbody').append(output);\n\n    var row = $('#order-items tbody tr.item').last();\n    $(row).find('*[name$=\"[product_id]\"]').val(item.product_id);\n    $(row).find('*[name$=\"[sku]\"]').val(item.sku);\n    $(row).find('*[name$=\"[option_stock_combination]\"]').val(item.option_stock_combination);\n    $(row).find('*[name$=\"[name]\"]').val(item.name);\n    $(row).find('*[name$=\"[gtin]\"]').val(item.gtin);\n    $(row).find('*[name$=\"[taric]\"]').val(item.taric);\n    $(row).find('*[name$=\"[weight]\"]').val(item.weight);\n    $(row).find('*[name$=\"[weight_class]\"]').val(item.weight_class);\n    $(row).find('*[name$=\"[dim_x]\"]').val(item.dim_x);\n    $(row).find('*[name$=\"[dim_y]\"]').val(item.dim_y);\n    $(row).find('*[name$=\"[dim_z]\"]').val(item.dim_z);\n    $(row).find('*[name$=\"[dim_class]\"]').val(item.dim_class);\n    $(row).find('*[name$=\"[quantity]\"]').val(item.quantity);\n    $(row).find('*[name$=\"[price]\"]').val(item.price);\n    $(row).find('*[name$=\"[tax]\"]').val(item.tax);\n\n    $(row).find('[data-type=\"currency\"]').parent().find('.input-group-text').text($(':input[name=\"currency_code\"]').val());\n    $(row).find('.weight').text(String(item.weight).trim('.0'));\n    $(row).find('.weight_class').text(item.weight_class);\n    $(row).find('.dim_x').text(String(item.dim_x).trim('.0'));\n    $(row).find('.dim_y').text(String(item.dim_y).trim('.0'));\n    $(row).find('.dim_z').text(String(item.dim_z).trim('.0'));\n    $(row).find('.dim_class').text(item.dim_class);\n\n    if (item.options) {\n      var product_options = '';\n      $.each(item.options, function(group, value) {\n        product_options += '<div>'\n                         + '  - '+ group +': ';\n        if ($.isArray(value)) {\n          $.each(value, function(i, array_value) {\n            product_options += '<input type=\"hidden\" name=\"items[new_'+ new_item_index +'][options]['+ group +'][]\" value=\"'+ array_value +'\" />' + array_value +', ';\n          });\n          product_options = product_options.substring(0, product_options.length - 2);\n        } else {\n          product_options += '<input type=\"hidden\" name=\"items[new_'+ new_item_index +'][options]['+ group +']\" value=\"'+ value +'\" />' + value;\n        }\n        product_options += '</div>';\n      });\n      $(row).find('input[type=\"hidden\"][name$=\"[options]\"]').replaceWith(product_options);\n    }\n\n    calculate_total();\n  }\n\n  $('#order-items').on('click', '.remove', function(e) {\n    e.preventDefault();\n    $(this).closest('tr').remove();\n  });\n\n// Order Total\n\n  var new_ot_row_index = 0;\n  $('#order-total').on('click', '.add', function(e) {\n    while ($('input[name=\"order_total['+new_ot_row_index+'][id]\"]').length) new_ot_row_index++;\n    e.preventDefault();\n    var output = '  <tr>'\n               + '    <td class=\"text-end\"><a href=\"#\" class=\"add\" title=\"<?php echo functions::escape_js(language::translate('text_insert_before', 'Insert before'), true); ?>\"><?php echo functions::escape_js(functions::draw_fonticon('fa-plus', 'style=\"color: #66cc66;\"')); ?></a></td>'\n               + '    <td class=\"text-end\"><?php echo functions::escape_js(functions::form_draw_hidden_field('order_total[new_ot_row_index][id]', '')); ?><?php echo functions::escape_js(functions::form_draw_text_field('order_total[new_ot_row_index][module_id]', '')); ?></td>'\n               + '    <td class=\"text-end\"><?php echo functions::escape_js(functions::form_draw_text_field('order_total[new_ot_row_index][title]', '', 'style=\"text-align: end;\"')); ?></td>'\n               + '    <td class=\"text-end\">'\n               + '      <div class=\"input-group\">'\n               + '        <span class=\"input-group-text\"><?php echo functions::escape_js(functions::form_draw_checkbox('order_total[new_ot_row_index][calculate]', '1', '1', 'title=\"'. functions::escape_html(language::translate('title_calculate', 'Calculate')) .'\"')); ?></span>'\n               + '        <?php echo functions::escape_js(functions::form_draw_currency_field($_POST['currency_code'], 'order_total[new_ot_row_index][value]', '0', 'style=\"text-align: end;\"')); ?>'\n               + '      </div>'\n               + '    </td>'\n               + '    <td class=\"text-end\"><?php echo functions::escape_js(functions::form_draw_currency_field($_POST['currency_code'], 'order_total[new_ot_row_index][tax]', currency::format_raw(0), 'style=\"text-align: end;\"')); ?></td>'\n               + '    <td><a class=\"remove\" href=\"#\" title=\"<?php echo functions::escape_js(language::translate('title_remove', 'Remove'), true); ?>\"><?php echo functions::escape_js(functions::draw_fonticon('fa-times-circle fa-lg fa-fw', 'style=\"color: #cc3333;\"')); ?></a></td>'\n               + '  </tr>';\n  output = output.replace(/new_ot_row_index/g, 'new_' + new_ot_row_index);\n  $(this).closest('tr').before(output);\n  new_ot_row_index++;\n  });\n\n  $('#order-total').on('click', '.remove', function(e) {\n    e.preventDefault();\n  $(this).closest('tr').remove();\n  });\n\n  function calculate_total() {\n\n    var subtotal = 0;\n    $('input[name^=\"items[\"][name$=\"[price]\"]').each(function() {\n      subtotal += parseFloat($(this).val() || 0) * parseFloat($(this).closest('tr').find('input[name^=\"items[\"][name$=\"[quantity]\"]').val() || 0);\n    });\n    subtotal = parseFloat(subtotal.toFixed($('select[name=\"currency_code\"] option:selected').data('decimals')) || 0);\n    $('input[name^=\"order_total[\"][value=\"ot_subtotal\"]').closest('tr').find('input[name^=\"order_total[\"][name$=\"[value]\"]').val(subtotal);\n\n    var subtotal_tax = 0;\n    $('input[name^=\"items[\"][name$=\"[tax]\"]').each(function() {\n      subtotal_tax += parseFloat($(this).val() || 0) * parseFloat($(this).closest('tr').find('input[name^=\"items[\"][name$=\"[quantity]\"]').val() || 0);\n    });\n    subtotal_tax = parseFloat(subtotal_tax.toFixed($('select[name=\"currency_code\"] option:selected').data('decimals')) || 0);\n    $('input[name^=\"order_total[\"][value=\"ot_subtotal\"]').closest('tr').find('input[name^=\"order_total[\"][name$=\"[tax]\"]').val(subtotal_tax);\n\n    var order_total = subtotal + subtotal_tax;\n    $('input[name^=\"order_total[\"][name$=\"[value]\"]').each(function() {\n      if ($(this).closest('tr').find('input[name^=\"order_total[\"][name$=\"[calculate]\"]').is(':checked')) {\n        order_total += parseFloat($(this).val() || 0);\n      }\n    });\n\n    $('input[name^=\"order_total[\"][name$=\"[tax]\"]').each(function() {\n      if ($(this).closest('tr').find('input[name^=\"order_total[\"][name$=\"[calculate]\"]').is(':checked')) {\n        order_total += parseFloat($(this).val() || 0);\n      }\n    });\n\n    order_total = parseFloat(order_total.toFixed($('select[name=\"currency_code\"] option:selected').data('decimals')) || 0);\n    $('#order-total .total').text($('select[name=\"currency_code\"] option:selected').data('prefix') + order_total + $('select[name=\"currency_code\"] option:selected').data('suffix'));\n  }\n\n  $('body').on('click keyup', 'input[name^=\"items\"][name$=\"[price]\"], input[name^=\"items\"][name$=\"[tax]\"], input[name^=\"items\"][name$=\"[quantity]\"], input[name^=\"order_total\"][name$=\"[value]\"], input[name^=\"order_total\"][name$=\"[tax]\"], input[name^=\"order_total\"][name$=\"[calculate]\"], #order-items a.remove, #order-total a.remove', function() {\n    calculate_total();\n  });\n</script>", "<?php\n\n  if (empty($_GET['page']) || !is_numeric($_GET['page'])) $_GET['page'] = 1;\n  if (!isset($_GET['order_status_id'])) $_GET['order_status_id'] = '';\n  if (empty($_GET['sort'])) $_GET['sort'] = 'date_created';\n\n  document::$snippets['title'][] = language::translate('title_orders', 'Orders');\n\n  breadcrumbs::add(language::translate('title_orders', 'Orders'));\n\n  if (isset($_POST['star']) || isset($_POST['unstar'])) {\n    database::query(\n      \"update \". DB_TABLE_PREFIX .\"orders\n      set starred = \". (isset($_POST['star']) ? 1 : 0) .\"\n      where id = \". (int)$_POST['order_id'] .\"\n      limit 1;\"\n    );\n    exit;\n  }\n\n  if (!empty($_POST['order_action'])) {\n\n    try {\n\n      if (empty($_POST['orders'])) throw new Exception(language::translate('error_must_select_orders', 'You must select orders to perform the operation'));\n\n      list($module_id, $action_id) = explode(':', $_POST['order_action']);\n\n      $order_action = new mod_order();\n\n      $actions = $order_action->actions();\n\n      if (!method_exists($order_action->modules[$module_id], $actions[$module_id]['actions'][$action_id]['function'])) {\n        throw new Exception(language::translate('error_method_doesnt_exist', 'The method doesn\\'t exist'));\n      }\n\n      sort($_POST['orders']);\n\n      ob_start();\n\n      if ($result = call_user_func([$order_action->modules[$module_id], $actions[$module_id]['actions'][$action_id]['function']], $_POST['orders'])) {\n        echo $result;\n      }\n\n    // Backwards compatibility\n      if ($output = ob_get_clean()) {\n        echo $output;\n        return;\n      }\n\n      header('Location: '. $_SERVER['REQUEST_URI']);\n      exit;\n\n    } catch (Exception $e) {\n      notices::add('errors', $e->getMessage());\n    }\n  }\n\n// Table Rows\n  $orders = [];\n\n  if (!empty($_GET['query'])) {\n    $sql_where_query = [\n      \"o.id = '\". database::input($_GET['query']) .\"'\",\n      \"o.uid = '\". database::input($_GET['query']) .\"'\",\n      \"o.reference like '%\". database::input($_GET['query']) .\"%'\",\n      \"o.customer_email like '%\". database::input($_GET['query']) .\"%'\",\n      \"o.customer_tax_id like '%\". database::input($_GET['query']) .\"%'\",\n      \"concat(o.customer_company, '\\\\n', o.customer_firstname, ' ', o.customer_lastname, '\\\\n', o.customer_address1, '\\\\n', o.customer_address2, '\\\\n', o.customer_postcode, '\\\\n', o.customer_city) like '%\". database::input($_GET['query']) .\"%'\",\n      \"concat(o.shipping_company, '\\\\n', o.shipping_firstname, ' ', o.shipping_lastname, '\\\\n', o.shipping_address1, '\\\\n', o.shipping_address2, '\\\\n', o.shipping_postcode, '\\\\n', o.shipping_city) like '%\". database::input($_GET['query']) .\"%'\",\n      \"o.payment_option_id like '%\". database::input($_GET['query']) .\"%'\",\n      \"o.payment_option_name like '%\". database::input($_GET['query']) .\"%'\",\n      \"o.payment_transaction_id like '\". database::input($_GET['query']) .\"'\",\n      \"o.shipping_option_id like '%\". database::input($_GET['query']) .\"%'\",\n      \"o.shipping_option_name like '%\". database::input($_GET['query']) .\"%'\",\n      \"o.shipping_tracking_id like '\". database::input($_GET['query']) .\"'\",\n      \"o.id in (\n        select distinct order_id from \". DB_TABLE_PREFIX .\"orders_items\n        where name like '%\". database::input($_GET['query']) .\"%'\n        or sku like '%\". database::input($_GET['query']) .\"%'\n      )\",\n      \"o.order_status_id in (\n        select distinct order_status_id from \". DB_TABLE_PREFIX .\"order_statuses_info\n        where language_code = '\". database::input(language::$selected['code']) .\"'\n        and name like '%\". database::input($_GET['query']) .\"%'\n      )\",\n    ];\n  }\n\n  switch($_GET['order_status_id']) {\n    case '':\n      $sql_where_order_status = \"and (o.order_status_id = 0 or os.is_archived = 0 or unread = 1)\";\n      break;\n    case 'archived':\n      $sql_where_order_status = \"and (os.is_archived = 1)\";\n      break;\n    case 'all':\n      break;\n    default:\n      $sql_where_order_status =  \"and o.order_status_id = \". (int)$_GET['order_status_id'];\n      break;\n  }\n\n  switch($_GET['sort']) {\n    case 'id':\n      $sql_sort = \"o.starred desc, o.id desc\";\n      break;\n    case 'country':\n      $sql_sort = \"o.starred desc, o.customer_country_code\";\n      break;\n    case 'customer':\n      $sql_sort = \"o.starred desc, if(o.customer_company, o.customer_company, concat(o.customer_firstname, ' ', o.customer_lastname)) asc\";\n      break;\n    case 'order_status':\n      $sql_sort = \"o.starred desc, os.name asc\";\n      break;\n    case 'payment_method':\n      $sql_sort = \"o.starred desc, o.payment_option_name asc\";\n      break;\n    default:\n      $sql_sort = \"o.starred desc, o.date_created desc, o.id desc\";\n      break;\n  }\n\n  $orders_query = database::query(\n    \"select o.*, os.color as order_status_color, os.icon as order_status_icon, osi.name as order_status_name from \". DB_TABLE_PREFIX .\"orders o\n    left join \". DB_TABLE_PREFIX .\"order_statuses os on (os.id = o.order_status_id)\n    left join \". DB_TABLE_PREFIX .\"order_statuses_info osi on (osi.order_status_id = o.order_status_id and osi.language_code = '\". database::input(language::$selected['code']) .\"')\n    where o.id\n    \". (!empty($sql_where_query) ? \"and (\". implode(\" or \", $sql_where_query) .\")\" : \"\") .\"\n    \". (!empty($sql_where_order_status) ? $sql_where_order_status : \"\") .\"\n    \". (!empty($_GET['date_from']) ? \"and o.date_created >= '\". date('Y-m-d H:i:s', strtotime($_GET['date_from'])) .\"'\" : '') .\"\n    \". (!empty($_GET['date_to']) ? \"and o.date_created <= '\". date('Y-m-d H:i:s', strtotime($_GET['date_to'])) .\"'\" : '') .\"\n    order by $sql_sort;\"\n  );\n\n  if ($_GET['page'] > 1) database::seek($orders_query, settings::get('data_table_rows_per_page') * ($_GET['page'] - 1));\n\n  $page_items = 0;\n  while ($order = database::fetch($orders_query)) {\n\n    if (empty($order['order_status_id'])) {\n      $order['order_status_icon'] = 'fa-minus';\n      $order['order_status_color'] = '#cccccc';\n    }\n\n    if (empty($order['order_status_icon'])) $order['order_status_icon'] = 'fa-circle-thin';\n    if (empty($order['order_status_color'])) $order['order_status_color'] = '#ccc';\n\n    $order['css_classes'] = [];\n    if (empty($order['order_status_id'])) $order['css_classes'][]= 'semi-transparent';\n    if (!empty($order['unread'])) $order['css_classes'][]= 'bold';\n\n    $orders[] = $order;\n\n    if (++$page_items == settings::get('data_table_rows_per_page')) break;\n  }\n\n// Number of Rows\n  $num_rows = database::num_rows($orders_query);\n\n// Pagination\n  $num_pages = ceil($num_rows/settings::get('data_table_rows_per_page'));\n\n\n// Order Statuses\n  $order_status_options = [\n    [\n      'label' => language::translate('title_collections', 'Collections'),\n      'options' => [\n        [language::translate('title_current', 'Current Orders'), ''],\n        [language::translate('title_archived_orders', 'Archived Orders'), 'archived'],\n        [language::translate('title_all_orders', 'All Orders'), 'all'],\n      ],\n    ],\n    [\n      'label' => language::translate('title_order_statuses', 'Order Statuses'),\n      'options' => [],\n    ],\n  ];\n\n  $order_statuses_query = database::query(\n    \"select os.*, osi.name, o.num_orders from \". DB_TABLE_PREFIX .\"order_statuses os\n    left join \". DB_TABLE_PREFIX .\"order_statuses_info osi on (os.id = osi.order_status_id and language_code = '\". database::input(language::$selected['code']) .\"')\n    left join (\n      select order_status_id, count(id) as num_orders\n      from \". DB_TABLE_PREFIX .\"orders\n      group by order_status_id\n    ) o on (o.order_status_id = os.id)\n    order by os.priority, osi.name;\"\n  );\n\n  while ($order_status = database::fetch($order_statuses_query)) {\n    $order_status_options[1]['options'][] = [$order_status['name'] . ' ('. language::number_format((int)$order_status['num_orders'], 0) .')', $order_status['id']];\n  }\n\n// Actions\n  $order_actions = [];\n\n  $mod_order = new mod_order();\n  if ($modules = $mod_order->actions()) {\n    foreach ($modules as $module) {\n      $order_actions[] = $module;\n    }\n  }\n\n?>\n<style>\ntable tr.bold {\n  font-weight: bold;\n}\n\ntable .fa-star-o:hover {\n  transform: scale(1.5);\n}\ntable .fa-star:hover {\n  transform: scale(1.5);\n}\n\n#order-actions li {\n  vertical-align: middle;\n}\n#order-actions li fieldset {\n  border: 1px #ccc solid;\n}\n#order-actions li fieldset legend {\n  color: #999;\n}\n</style>\n\n<div class=\"panel panel-app\">\n  <div class=\"panel-heading\">\n    <?php echo $app_icon; ?> <?php echo language::translate('title_orders', 'Orders'); ?>\n  </div>\n\n  <div class=\"panel-action\">\n    <ul class=\"list-inline\">\n      <li><?php echo functions::form_draw_link_button(document::link(WS_DIR_ADMIN, ['doc' => 'edit_order', 'redirect_url' => $_SERVER['REQUEST_URI']], true), language::translate('title_create_new_order', 'Create New Order'), '', 'add'); ?></li>\n    </ul>\n  </div>\n\n  <?php echo functions::form_draw_form_begin('search_form', 'get'); ?>\n    <?php echo functions::form_draw_hidden_field('app', true); ?>\n    <?php echo functions::form_draw_hidden_field('doc', true); ?>\n    <div class=\"panel-filter\">\n      <div class=\"expandable\"><?php echo functions::form_draw_search_field('query', true, 'placeholder=\"'. language::translate('text_search_phrase_or_keyword', 'Search phrase or keyword').'\"'); ?></div>\n      <div><?php echo functions::form_draw_select_optgroup_field('order_status_id', $order_status_options, true, false, 'style=\"width: auto;\"'); ?></div>\n      <div class=\"input-group\" style=\"max-width: 450px;\">\n        <?php echo functions::form_draw_datetime_field('date_from', true); ?>\n        <span class=\"input-group-text\"> - </span>\n        <?php echo functions::form_draw_datetime_field('date_to', true); ?>\n      </div>\n      <div><?php echo functions::form_draw_button('filter', language::translate('title_search', 'Search'), 'submit'); ?></div>\n    </div>\n  <?php echo functions::form_draw_form_end(); ?>\n\n  <div class=\"panel-body\">\n    <?php echo functions::form_draw_form_begin('orders_form', 'post'); ?>\n\n      <table class=\"table table-striped table-hover table-sortable data-table\">\n        <thead>\n          <tr>\n            <th><?php echo functions::draw_fonticon('fa-check-square-o fa-fw checkbox-toggle', 'data-toggle=\"checkbox-toggle\"'); ?></th>\n            <th></th>\n            <th data-sort=\"id\"><?php echo language::translate('title_id', 'ID'); ?></th>\n            <th></th>\n            <th data-sort=\"customer\" class=\"main\"><?php echo language::translate('title_customer_name', 'Customer Name'); ?></th>\n            <th data-sort=\"country\"><?php echo language::translate('title_country', 'Country'); ?></th>\n            <th data-sort=\"payment_method\"><?php echo language::translate('title_payment_method', 'Payment Method'); ?></th>\n            <th class=\"text-center\"><?php echo language::translate('title_amount', 'Amount'); ?></th>\n            <th class=\"text-center\"><?php echo language::translate('title_tax', 'Tax'); ?></th>\n            <th data-sort=\"order_status\" class=\"text-center\"><?php echo language::translate('title_order_status', 'Order Status'); ?></th>\n            <th data-sort=\"date_created\"><?php echo language::translate('title_date', 'Date'); ?></th>\n            <th></th>\n          </tr>\n        </thead>\n\n        <tbody>\n          <?php foreach ($orders as $order) { ?>\n          <tr class=\"<?php echo implode(' ', $order['css_classes']); ?>\" data-id=\"<?php echo $order['id']; ?>\">\n            <td><?php echo functions::form_draw_checkbox('orders[]', $order['id'], true); ?></td>\n            <td><?php echo functions::draw_fonticon($order['order_status_icon'].' fa-fw', 'style=\"color: '. $order['order_status_color'] .';\"'); ?></td>\n            <td><?php echo $order['id']; ?></td>\n            <td><?php echo (!empty($order['starred'])) ? functions::draw_fonticon('fa-star', 'style=\"color: #f2b01e;\"') : functions::draw_fonticon('fa-star-o', 'style=\"color: #ccc;\"'); ?></td>\n            <td><a href=\"<?php echo document::href_link('', ['app' => 'orders', 'doc' => 'edit_order', 'order_id' => $order['id'], 'redirect_url' => $_SERVER['REQUEST_URI']]); ?>\"><?php echo $order['customer_company'] ? $order['customer_company'] : $order['customer_firstname'] .' '. $order['customer_lastname']; ?><?php echo empty($order['customer_id']) ? ' <em>('. language::translate('title_guest', 'Guest') .')</em>' : ''; ?></a> <span style=\"opacity: 0.5;\"><?php echo $order['customer_tax_id']; ?></span></td>\n            <td><?php echo !empty($order['customer_country_code']) ? reference::country($order['customer_country_code'])->name : ''; ?></td>\n            <td><?php echo $order['payment_option_name']; ?></td>\n            <td class=\"text-end\"><?php echo currency::format($order['payment_due'], false, $order['currency_code'], $order['currency_value']); ?></td>\n            <td class=\"text-end\"><?php echo ($order['tax_total'] != 0) ? currency::format($order['tax_total'], false, $order['currency_code'], $order['currency_value']) : '-'; ?></td>\n            <td class=\"text-center\"><?php echo !empty($order['order_status_id']) ? $order['order_status_name'] : language::translate('title_unprocessed', 'Unprocessed'); ?></td>\n            <td class=\"text-end\"><?php echo language::strftime(language::$selected['format_datetime'], strtotime($order['date_created'])); ?></td>\n            <td>\n              <a href=\"<?php echo document::href_ilink('printable_packing_slip', ['order_id' => $order['id'], 'public_key' => $order['public_key'], 'media' => 'print']); ?>\" target=\"_blank\" title=\"<?php echo language::translate('title_packing_slip', 'Packing Slip'); ?>\"><?php echo functions::draw_fonticon('fa-file-text-o'); ?></a>\n              <a href=\"<?php echo document::href_ilink('printable_order_copy', ['order_id' => $order['id'], 'public_key' => $order['public_key'], 'media' => 'print']); ?>\" target=\"_blank\" title=\"<?php echo language::translate('title_order_copy', 'Order Copy'); ?>\"><?php echo functions::draw_fonticon('fa-print'); ?></a>\n              <a href=\"<?php echo document::href_link('', ['app' => 'orders', 'doc' => 'edit_order', 'order_id' => $order['id'], 'redirect_url' => $_SERVER['REQUEST_URI']]); ?>\" title=\"<?php echo language::translate('title_edit', 'Edit'); ?>\"><?php echo functions::draw_fonticon('fa-pencil'); ?></a>\n            </td>\n          </tr>\n          <?php } ?>\n        </tbody>\n\n        <tfoot>\n          <tr>\n            <td colspan=\"12\"><?php echo language::translate('title_orders', 'Orders'); ?>: <?php echo $num_rows; ?></td>\n          </tr>\n        </tfoot>\n      </table>\n\n      <p>\n        <ul id=\"order-actions\" class=\"list-inline\">\n          <?php foreach ($order_actions as $module) { ?>\n          <li>\n            <fieldset title=\"<?php echo functions::escape_html($module['description']); ?>\">\n              <legend><?php echo $module['name']; ?></legend>\n              <div class=\"btn-group\">\n                <?php foreach ($module['actions'] as $action) echo functions::form_draw_button('order_action', [$module['id'].':'.$action['id'], $action['title']], 'submit', 'formtarget=\"'. functions::escape_html($action['target']) .'\" title=\"'. functions::escape_html($action['description']) .'\"'); ?>\n              </div>\n            </fieldset>\n          </li>\n          <?php } ?>\n        </ul>\n      </p>\n\n    <?php echo functions::form_draw_form_end(); ?>\n  </div>\n\n  <div class=\"panel-footer\">\n    <?php echo functions::draw_pagination($num_pages); ?>\n  </div>\n</div>\n\n<script>\n  $('input[name=\"query\"]').keypress(function(e) {\n    if (e.which == 13) {\n      e.preventDefault();\n      $(this).closest('form').submit();\n    }\n  });\n\n  $('form[name=\"search_form\"] select').change(function(){\n    $(this).closest('form').submit();\n  });\n\n  $('.data-table input[name^=\"orders[\"]').change(function() {\n    if ($('.data-table input[name^=\"orders[\"]:checked').length > 0) {\n      $('#order-actions button').prop('disabled', false);\n    } else {\n      $('#order-actions button').prop('disabled', true);\n    }\n  }).trigger('change');\n\n\n  $('table').on('click', '.fa-star-o', function(e){\n    e.stopPropagation();\n    var star = this;\n    $.post('', 'star&order_id='+$(star).closest('tr').data('id'), function(data) {\n      $(star).replaceWith('<?php echo functions::draw_fonticon('fa-star', 'style=\"color: #f2b01e;\"'); ?>');\n    });\n    return false;\n  });\n\n  $('table').on('click', '.fa-star', function(e){\n    var star = this;\n    $.post('', 'unstar&order_id='+$(star).closest('tr').data('id'), function(data) {\n      $(star).replaceWith('<?php echo functions::draw_fonticon('fa-star-o', 'style=\"color: #ccc;\"'); ?>');\n    });\n    return false;\n  });\n</script>", "<?php\n\n  document::$snippets['title'][] = language::translate('title_most_shopping_customers', 'Most Shopping Customers');\n\n  breadcrumbs::add(language::translate('title_reports', 'Reports'));\n  breadcrumbs::add(language::translate('title_most_shopping_customers', 'Most Shopping Customers'));\n\n  $_GET['date_from'] = !empty($_GET['date_from']) ? date('Y-m-d', strtotime($_GET['date_from'])) : null;\n  $_GET['date_to'] = !empty($_GET['date_to']) ? date('Y-m-d', strtotime($_GET['date_to'])) : date('Y-m-d');\n\n  if ($_GET['date_from'] > $_GET['date_to']) list($_GET['date_from'], $_GET['date_to']) = [$_GET['date_to'], $_GET['date_from']];\n\n  $date_first_order = database::fetch(database::query(\"select min(date_created) from \". DB_TABLE_PREFIX .\"orders limit 1;\"));\n  $date_first_order = date('Y-m-d', strtotime($date_first_order['min(date_created)']));\n  if (empty($date_first_order)) $date_first_order = date('Y-m-d');\n  if ($_GET['date_from'] < $date_first_order) $_GET['date_from'] = $date_first_order;\n\n  if ($_GET['date_from'] > date('Y-m-d')) $_GET['date_from'] = date('Y-m-d');\n  if ($_GET['date_to'] > date('Y-m-d')) $_GET['date_to'] = date('Y-m-d');\n\n  if (empty($_GET['page']) || !is_numeric($_GET['page'])) $_GET['page'] = 1;\n\n// Table Rows\n  $customers = [];\n\n  $customers_query = database::query(\n    \"select\n      sum(o.payment_due - tax_total) as total_amount,\n      o.customer_id as id,\n      if(o.customer_company, o.customer_company, concat(o.customer_firstname, ' ', o.customer_lastname)) as name,\n      customer_email as email\n    from \". DB_TABLE_PREFIX .\"orders o\n    where o.order_status_id in (\n      select id from \". DB_TABLE_PREFIX .\"order_statuses\n      where is_sale\n    )\n    \". (!empty($_GET['date_from']) ? \"and o.date_created >= '\". date('Y-m-d H:i:s', strtotime($_GET['date_from'])) .\"'\" : '') .\"\n    \". (!empty($_GET['date_to']) ? \"and o.date_created <= '\". date('Y-m-d H:i:s', strtotime($_GET['date_to'])) .\"'\" : '') .\"\n    group by if(o.customer_id, o.customer_id, o.customer_email)\n    order by total_amount desc;\"\n  );\n\n  if (!isset($_GET['download']) && $_GET['page'] > 1) database::seek($customers_query, settings::get('data_table_rows_per_page') * ($_GET['page'] - 1));\n\n  $page_items = 0;\n  while ($customer = database::fetch($customers_query)) {\n    $customers[] = $customer;\n    if (!isset($_GET['download']) && ++$page_items == settings::get('data_table_rows_per_page')) break;\n  }\n\n  if (isset($_GET['download'])) {\n    //header('Content-Type: text/plain; charset='. language::$selected['code']);\n    header('Content-Type: application/csv; charset='. language::$selected['code']);\n    header('Content-Disposition: filename=\"most_shopping_customers_'. date('Ymd', strtotime($_GET['date_from'])) .'-'. date('Ymd', strtotime($_GET['date_to'])) .'.csv\"');\n    echo functions::csv_encode($customers);\n    exit;\n  }\n\n// Number of Rows\n  $num_rows = database::num_rows($customers_query);\n\n// Pagination\n  $num_pages = ceil($num_rows/settings::get('data_table_rows_per_page'));\n?>\n\n<style>\nform[name=\"filter_form\"] li {\n  vertical-align: middle;\n}\n</style>\n\n<div class=\"panel panel-app\">\n  <div class=\"panel-heading\">\n    <?php echo $app_icon; ?> <?php echo language::translate('title_most_shopping_customers', 'Most Shopping Customers'); ?>\n  </div>\n\n  <div class=\"panel-action\">\n    <?php echo functions::form_draw_form_begin('filter_form', 'get'); ?>\n      <?php echo functions::form_draw_hidden_field('app'); ?>\n      <?php echo functions::form_draw_hidden_field('doc'); ?>\n      <ul class=\"list-inline\">\n        <li><?php echo language::translate('title_date_period', 'Date Period'); ?>:</li>\n        <li>\n          <div class=\"input-group\" style=\"max-width: 380px;\">\n            <?php echo functions::form_draw_date_field('date_from', true); ?>\n            <span class=\"input-group-text\"> - </span>\n            <?php echo functions::form_draw_date_field('date_to', true); ?>\n          </div>\n        </li>\n        <li><?php echo functions::form_draw_button('filter', language::translate('title_filter_now', 'Filter')); ?></li>\n        <li><?php echo functions::form_draw_button('download', language::translate('title_download', 'Download')); ?></li>\n      </ul>\n    <?php echo functions::form_draw_form_end(); ?>\n  </div>\n\n  <div class=\"panel-body\">\n    <table class=\"table table-striped table-hover data-table\">\n      <thead>\n        <tr>\n          <th><?php echo language::translate('title_customer', 'Customer'); ?></th>\n          <th width=\"100%\"><?php echo language::translate('title_email_address', 'Email Address'); ?></th>\n          <th style=\"text-align: center;\"><?php echo language::translate('title_total_amount', 'Total Amount'); ?></th>\n        </tr>\n      </thead>\n\n      <tbody>\n        <?php foreach ($customers as $customer) { ?>\n        <tr>\n          <td><?php echo !empty($customer['id']) ? '<a href=\"'. document::link(WS_DIR_ADMIN, ['app' => 'customers', 'doc' => 'edit_customer', 'customer_id' => $customer['id']]) .'\">'. $customer['name'] .'</a>' : $customer['name'] .' <em>('. language::translate('title_guest', 'Guest') .')</em>'; ?></td>\n          <td><?php echo $customer['email']; ?></td>\n          <td style=\"text-align: end;\"><?php echo currency::format($customer['total_amount'], false, settings::get('store_currency_code')); ?></td>\n        </tr>\n        <?php } ?>\n      </tbody>\n    </table>\n  </div>\n\n  <div class=\"panel-footer\">\n    <?php echo functions::draw_pagination($num_pages); ?>\n  </div>\n</div>\n", "<meta name=\"viewport\" content=\"width=1200\">\n\n<style>\nbody {\n  display: flex;\n  height: 100vh;\n}\n\n#order-copy {\n  flex: 1 1 auto;\n}\n\n#sidebar {\n  display: flex;\n  flex-direction: column;\n  flex: 0 0 360px;\n  padding: 15px;\n  background: #fff;\n}\n\n#actions {\n  margin-bottom: 30px;\n}\n\n#comments {\n  flex: 1 1 auto;\n  overflow: hidden auto;\n}\n</style>\n\n\n<iframe id=\"order-copy\" src=\"<?php echo document::ilink('printable_order_copy', [], ['order_id', 'public_key']); ?>\" style=\"border: 0;\"></iframe>\n\n<div id=\"sidebar\" class=\"hidden-print shadow\">\n\n  <ul id=\"actions\" class=\"list-unstyled\">\n    <li><a class=\"btn btn-default btn-block btn-lg\" href=\"javascript:$('#order-copy').get(0).contentWindow.print();\"><?php echo functions::draw_fonticon('fa-print'); ?> <?php echo language::translate('title_print', 'Print'); ?></a></li>\n  </ul>\n\n  <h1 style=\"margin-top: 0;\"><?php echo language::translate('title_comments', 'Comments'); ?></h1>\n\n  <div id=\"comments\" class=\"bubbles\">\n    <?php foreach ($comments as $comment) { ?>\n    <div class=\"bubble <?php echo $comment['type']; ?>\">\n      <div class=\"text\"><?php echo nl2br($comment['text']); ?></div>\n      <div class=\"date\"><?php echo language::strftime(language::$selected['format_datetime'], strtotime($comment['date_created'])); ?></div>\n    </div>\n    <?php } ?>\n  </div>\n</div>\n\n<script>\n// Scroll to last comment\n  $(\"#comments\").animate({scrollTop: $('#comments').prop('scrollHeight')}, 2000);\n</script>"], "fixing_code": ["<?php\n\n  if (!empty($_GET['category_id'])) {\n    $category = new ent_category($_GET['category_id']);\n  } else {\n    $category = new ent_category();\n  }\n\n  if (empty($_POST)) {\n    $_POST = $category->data;\n\n    if (empty($category->data['id']) && !empty($_GET['parent_id'])) {\n      $_POST['parent_id'] = $_GET['parent_id'];\n    }\n  }\n\n  document::$snippets['title'][] = !empty($category->data['id']) ? language::translate('title_edit_category', 'Edit Category') : language::translate('title_add_new_category', 'Add New Category');\n\n  breadcrumbs::add(language::translate('title_catalog', 'Catalog'));\n  breadcrumbs::add(!empty($category->data['id']) ? language::translate('title_edit_category', 'Edit Category') : language::translate('title_add_new_category', 'Add New Category'));\n\n  if (isset($_POST['save'])) {\n\n    try {\n\n      if (empty($_POST['name'])) throw new Exception(language::translate('error_must_enter_name', 'You must enter a name'));\n\n      if (!empty($_POST['code']) && database::num_rows(database::query(\"select id from \". DB_TABLE_PREFIX .\"categories where id != '\". (isset($_GET['category_id']) ? (int)$_GET['category_id'] : 0) .\"' and code = '\". database::input($_POST['code']) .\"' limit 1;\"))) {\n        throw new Exception(language::translate('error_code_database_conflict', 'Another entry with the given code already exists in the database'));\n      }\n\n      if (empty($_POST['filters'])) $_POST['filters'] = [];\n\n      $fields = [\n        'status',\n        'parent_id',\n        'code',\n        'google_taxonomy_id',\n        'list_style',\n        'image',\n        'name',\n        'short_description',\n        'description',\n        'keywords',\n        'head_title',\n        'h1_title',\n        'meta_description',\n        'filters',\n        'priority',\n      ];\n\n      foreach ($fields as $field) {\n        if (isset($_POST[$field])) $category->data[$field] = $_POST[$field];\n      }\n\n      if (!empty($_POST['delete_image'])) $category->delete_image();\n\n      if (is_uploaded_file($_FILES['image']['tmp_name'])) {\n        $category->save_image($_FILES['image']['tmp_name']);\n      }\n\n      $category->save();\n\n      notices::add('success', language::translate('success_changes_saved', 'Changes saved'));\n      header('Location: '. document::link(WS_DIR_ADMIN, ['doc' => 'catalog', 'category_id' => $_POST['parent_id']], ['app']));\n      exit;\n\n    } catch (Exception $e) {\n      notices::add('errors', $e->getMessage());\n    }\n  }\n\n  if (isset($_POST['delete'])) {\n\n    try {\n      if (empty($category->data['id'])) throw new Exception(language::translate('error_must_provide_category', 'You must provide a category'));\n\n      $category->delete();\n\n      notices::add('success', language::translate('success_changes_saved', 'Changes saved'));\n      header('Location: '. document::link(WS_DIR_ADMIN, ['doc' => 'catalog', 'category_id' => $_POST['parent_id']], ['app']));\n      exit;\n\n    } catch (Exception $e) {\n      notices::add('errors', $e->getMessage());\n    }\n  }\n\n  list($category_image_width, $category_image_height) = functions::image_scale_by_width(320, settings::get('category_image_ratio'));\n?>\n<div class=\"panel panel-app\">\n  <div class=\"panel-heading\">\n    <?php echo $app_icon; ?> <?php echo !empty($category->data['id']) ? language::translate('title_edit_category', 'Edit Category') .': '. $category->data['name'][language::$selected['code']] : language::translate('title_add_new_category', 'Add New Category'); ?>\n  </div>\n\n  <ul class=\"nav nav-tabs\">\n    <li class=\"active\"><a data-toggle=\"tab\" href=\"#tab-general\"><?php echo language::translate('title_general', 'General'); ?></a></li>\n    <li><a data-toggle=\"tab\" href=\"#tab-information\"><?php echo language::translate('title_information', 'Information'); ?></a></li>\n    <li><a data-toggle=\"tab\" href=\"#tab-filters\"><?php echo language::translate('title_filters', 'Filters'); ?></a></li>\n  </ul>\n\n  <div class=\"panel-body\">\n    <?php echo functions::form_draw_form_begin('category_form', 'post', false, true); ?>\n\n      <div class=\"tab-content\">\n        <div id=\"tab-general\" class=\"tab-pane active\" style=\"max-width: 980px;\">\n\n          <div class=\"row\">\n            <div class=\"col-md-4\">\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_status', 'Status'); ?></label>\n                <?php echo functions::form_draw_toggle('status', isset($_POST['status']) ? $_POST['status'] : '0', 'e/d'); ?>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_parent_category', 'Parent Category'); ?></label>\n                <?php echo functions::form_draw_category_field('parent_id', true); ?>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_google_taxonomy_id', 'Google Taxonomy ID'); ?> <a href=\"http://www.google.com/basepages/producttype/taxonomy-with-ids.en-US.txt\" target=\"_blank\"><?php echo functions::draw_fonticon('fa-external-link'); ?></a></label>\n                <?php echo functions::form_draw_number_field('google_taxonomy_id', true); ?>\n              </div>\n\n              <?php if (!empty($category->data['id'])) { ?>\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_date_updated', 'Date Updated'); ?></label>\n                <div><?php echo language::strftime('%e %b %Y %H:%M', strtotime($category->data['date_updated'])); ?></div>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_date_created', 'Date Created'); ?></label>\n                <div><?php echo language::strftime('%e %b %Y %H:%M', strtotime($category->data['date_created'])); ?></div>\n              </div>\n              <?php } ?>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_priority', 'Priority'); ?></label>\n                <?php echo functions::form_draw_number_field('priority', true); ?>\n              </div>\n            </div>\n\n            <div class=\"col-md-4\">\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_name', 'Name'); ?></label>\n                <?php foreach (array_keys(language::$languages) as $language_code) echo functions::form_draw_regional_input_field($language_code, 'name['. $language_code .']', true, ''); ?>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_code', 'Code'); ?></label>\n                <?php echo functions::form_draw_text_field('code', true); ?>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_list_style', 'List Style'); ?></label>\n<?php\n  $options = [\n    [language::translate('title_columns', 'Columns'), 'columns'],\n    [language::translate('title_rows', 'Rows'), 'rows'],\n  ];\n  echo functions::form_draw_select_field('list_style', $options, true);\n?>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_keywords', 'Keywords'); ?></label>\n                <?php echo functions::form_draw_text_field('keywords', true); ?>\n              </div>\n            </div>\n\n            <div class=\"col-md-4\">\n              <div id=\"image\">\n                <div class=\"thumbnail\" style=\"margin-bottom: 15px;\">\n                  <img src=\"<?php echo document::href_link(WS_DIR_APP . functions::image_thumbnail(FS_DIR_APP . 'images/' . $category->data['image'], $category_image_width, $category_image_height, settings::get('category_image_clipping'))); ?>\" alt=\"\" />\n                </div>\n\n                <div class=\"form-group\">\n                  <label><?php echo ((isset($category->data['image']) && $category->data['image'] != '') ? language::translate('title_new_image', 'New Image') : language::translate('title_image', 'Image')); ?></label>\n                  <?php echo functions::form_draw_file_field('image', ''); ?>\n                  <?php if (!empty($category->data['image'])) { ?><br />\n                  <div><?php echo $category->data['image']; ?></div>\n                  <div><?php echo functions::form_draw_checkbox('delete_image', 'true', true); ?> <?php echo language::translate('title_delete', 'Delete'); ?></div>\n                  <?php } ?>\n                </div>\n              </div>\n            </div>\n\n          </div>\n        </div>\n\n        <div id=\"tab-information\" class=\"tab-pane\" style=\"max-width: 640px;\">\n\n          <ul class=\"nav nav-tabs\">\n            <?php foreach (language::$languages as $language) { ?>\n              <li<?php echo ($language['code'] == language::$selected['code']) ? ' class=\"active\"' : ''; ?>><a data-toggle=\"tab\" href=\"#<?php echo $language['code']; ?>\"><?php echo $language['name']; ?></a></li>\n            <?php } ?>\n          </ul>\n\n          <div class=\"tab-content\">\n\n            <?php foreach (array_keys(language::$languages) as $language_code) { ?>\n            <div id=\"<?php echo $language_code; ?>\" class=\"tab-pane fade in<?php echo ($language_code == language::$selected['code']) ? ' active' : ''; ?>\">\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_name', 'Name'); ?></label>\n                <?php echo functions::form_draw_regional_input_field($language_code, 'name['. $language_code .']', true, ''); ?>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_h1_title', 'H1 Title'); ?></label>\n                <?php echo functions::form_draw_regional_input_field($language_code, 'h1_title['. $language_code .']', true, ''); ?>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_short_description', 'Short Description'); ?></label>\n                <?php echo functions::form_draw_regional_input_field($language_code, 'short_description['. $language_code .']', true); ?>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_description', 'Description'); ?></label>\n                <?php echo functions::form_draw_regional_wysiwyg_field($language_code, 'description['. $language_code .']', true, 'style=\"height: 240px;\"'); ?>\n              </div>\n\n              <div class=\"row\">\n                <div class=\"form-group col-md-6\">\n                  <label><?php echo language::translate('title_head_title', 'Head Title'); ?></label>\n                  <?php echo functions::form_draw_regional_input_field($language_code, 'head_title['. $language_code .']', true); ?>\n                </div>\n\n                <div class=\"form-group col-md-6\">\n                  <label><?php echo language::translate('title_meta_description', 'Meta Description'); ?></label>\n                  <?php echo functions::form_draw_regional_input_field($language_code, 'meta_description['. $language_code .']', true); ?>\n                </div>\n              </div>\n\n            </div>\n            <?php } ?>\n\n          </div>\n        </div>\n\n        <div id=\"tab-filters\" class=\"tab-pane\" style=\"max-width: 640px;\">\n\n          <table class=\"table table-striped data-table table-dragable\">\n            <thead>\n              <tr>\n                <th><?php echo language::translate('title_attribute_group', 'Attribute Group'); ?></th>\n                <th><?php echo language::translate('title_select_multiple', 'Select Multiple'); ?></th>\n                <th></th>\n              </tr>\n            </thead>\n            <tbody>\n              <?php if (!empty($_POST['filters'])) foreach (array_keys($_POST['filters']) as $key) { ?>\n              <tr>\n                <?php echo functions::form_draw_hidden_field('filters['.$key.'][id]', true); ?>\n                <?php echo functions::form_draw_hidden_field('filters['.$key.'][attribute_group_id]', true); ?>\n                <?php echo functions::form_draw_hidden_field('filters['.$key.'][attribute_group_name]', true); ?>\n                <td class=\"grabable\"><?php echo functions::escape_html($_POST['filters'][$key]['attribute_group_name']); ?></td>\n                <td class=\"grabable\"><?php echo functions::form_draw_checkbox('filters['.$key.'][select_multiple]', '1', true); ?></td>\n                <td class=\"text-end\">\n                  <a class=\"move-up\" href=\"#\" title=\"<?php echo language::translate('text_move_up', 'Move up'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-up fa-lg', 'style=\"color: #3399cc;\"'); ?></a>\n                  <a class=\"move-down\" href=\"#\" title=\"<?php echo language::translate('text_move_down', 'Move down'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-down fa-lg', 'style=\"color: #3399cc;\"'); ?></a>\n                  <a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"'); ?></a>\n                </td>\n              </tr>\n              <?php } ?>\n            </tbody>\n          </table>\n\n          <div class=\"input-group\" style=\"max-width: 320px;\">\n            <?php echo functions::form_draw_attribute_groups_list('new_attribute_group', true); ?>\n            <?php echo functions::form_draw_button('add', language::translate('title_add', 'Add'), 'button'); ?>\n          </div>\n        </div>\n      </div>\n\n      <div class=\"panel-action btn-group\">\n        <?php echo functions::form_draw_button('save', language::translate('title_save', 'Save'), 'submit', '', 'save'); ?>\n        <?php echo functions::form_draw_button('cancel', language::translate('title_cancel', 'Cancel'), 'button', 'onclick=\"history.go(-1);\"', 'cancel'); ?>\n        <?php echo (isset($category->data['id'])) ? functions::form_draw_button('delete', language::translate('title_delete', 'Delete'), 'submit', 'formnovalidate onclick=\"if (!window.confirm(\\''. language::translate('text_are_you_sure', 'Are you sure?') .'\\')) return false;\"', 'delete') : false; ?>\n      </div>\n\n    <?php echo functions::form_draw_form_end(); ?>\n  </div>\n</div>\n\n<script>\n  <?php if (!empty($category->data['id'])) { ?>\n  $('select[name=\"parent_id\"] option[value=\"<?php echo $category->data['id']; ?>\"]').prop('disabled', true);\n  <?php } ?>\n\n// Image\n\n  $('input[name=\"image\"]').change(function(e) {\n    if ($(this).val() != '') {\n      var oFReader = new FileReader();\n      oFReader.readAsDataURL(this.files[0]);\n      oFReader.onload = function(e){\n        $('#image img').attr('src', e.target.result);\n      };\n    } else {\n      $('#image img').attr('src', '<?php echo document::link(WS_DIR_APP . functions::image_thumbnail(FS_DIR_APP . 'images/' . $category->data['image'], $category_image_width, $category_image_height, settings::get('category_image_clipping'))); ?>');\n    }\n  });\n\n// Head Title & H1 Title\n\n  $('input[name^=\"name\"]').on('input', function(e){\n    var language_code = $(this).attr('name').match(/\\[(.*)\\]$/)[1];\n    $('.nav-tabs a[href=\"#'+language_code+'\"]').css('opacity', $(this).val() ? 1 : .5);\n    $('input[name=\"name['+language_code+']\"]').not(this).val($(this).val());\n    $('input[name=\"head_title['+language_code+']\"]').attr('placeholder', $(this).val());\n    $('input[name=\"h1_title['+language_code+']\"]').attr('placeholder', $(this).val());\n  }).trigger('input');\n\n// Meta Description\n\n  $('input[name^=\"short_description\"]').on('input', function(e){\n    var language_code = $(this).attr('name').match(/\\[(.*)\\]$/)[1];\n    $('input[name=\"meta_description['+language_code+']\"]').attr('placeholder', $(this).val());\n  }).trigger('input');\n\n// Filters\n\n  var new_attribute_filter_i = 0;\n  $('#tab-filters button[name=\"add\"]').click(function(){\n\n    if ($('select[name=\"new_attribute_group\"]').val() == '') {\n      alert(\"<?php echo language::translate('error_must_select_attribute_group', 'You must select an attribute group'); ?>\");\n      return;\n    }\n\n    var output = '<tr class=\"grabable\">'\n               + '  <?php echo functions::escape_js(functions::form_draw_hidden_field('filters[new_attribute_filter_i][id]', '')); ?>'\n               + '  <?php echo functions::escape_js(functions::form_draw_hidden_field('filters[new_attribute_filter_i][attribute_group_id]', 'new_attribute_group_id')); ?>'\n               + '  <?php echo functions::escape_js(functions::form_draw_hidden_field('filters[new_attribute_filter_i][attribute_group_name]', 'new_attribute_group_name')); ?>'\n               + '  <td>new_attribute_group_name</td>'\n               + '  <td><?php echo functions::form_draw_checkbox('filters[new_attribute_filter_i][select_multiple]', true); ?></td>'\n               + '  <td class=\"text-end\">'\n               + '    <a class=\"move-up\" href=\"#\" title=\"<?php echo language::translate('text_move_up', 'Move up'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-up fa-lg', 'style=\"color: #3399cc;\"'); ?></a>'\n               + '    <a class=\"move-down\" href=\"#\" title=\"<?php echo language::translate('text_move_down', 'Move down'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-down fa-lg', 'style=\"color: #3399cc;\"'); ?></a>'\n               + '    <a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"'); ?></a>'\n               + '  </td>'\n               + '</tr>';\n\n    while ($('input[name=\"filters[new_'+new_attribute_filter_i+']\"]').length) new_attribute_filter_i++;\n    output = output.replace(/new_attribute_filter_i/g, 'new_' + new_attribute_filter_i);\n    output = output.replace(/new_attribute_group_id/g, $('select[name=\"new_attribute_group\"] option:selected').val());\n    output = output.replace(/new_attribute_group_name/g, $('select[name=\"new_attribute_group\"] option:selected').text());\n    new_attribute_filter_i++;\n\n    $('#tab-filters tbody').append(output);\n  });\n\n  $('#tab-filters').on('click', '.move-up, .move-down', function(event) {\n    event.preventDefault();\n    var row = $(this).closest('tr');\n\n    if ($(this).is('.move-up') && $(row).prevAll().length) {\n      $(row).insertBefore($(row).prev());\n    } else if ($(this).is('.move-down') && $(row).nextAll().length) {\n      $(row).insertAfter($(row).next());\n    }\n  });\n\n  $('#tab-filters').on('click', '.remove', function(e) {\n    e.preventDefault();\n    $(this).closest('tr').remove();\n  });\n</script>", "<?php\n\n  if (!empty($_GET['product_id'])) {\n    $product = new ent_product($_GET['product_id']);\n  } else {\n    $product = new ent_product();\n  }\n\n  if (empty($_POST)) {\n    $_POST = $product->data;\n\n    $_POST['keywords'] = implode(',', $_POST['keywords']);\n\n    if (empty($product->data['id']) && isset($_GET['category_id'])) {\n      $_POST['categories'][] = $_GET['category_id'];\n    }\n  }\n\n  document::$snippets['title'][] = !empty($product->data['id']) ? language::translate('title_edit_product', 'Edit Product') . ': '. $product->data['name'][language::$selected['code']] : language::translate('title_add_new_product', 'Add New Product');\n\n  breadcrumbs::add(language::translate('title_catalog', 'Catalog'), document::link(WS_DIR_ADMIN, ['doc' => 'catalog'], ['app']));\n  breadcrumbs::add(!empty($product->data['id']) ? language::translate('title_edit_product', 'Edit Product') . ': '. $product->data['name'][language::$selected['code']] : language::translate('title_add_new_product', 'Add New Product'));\n\n  if (isset($_POST['save'])) {\n\n    try {\n      if (empty($_POST['categories'])) $_POST['categories'] = [0];\n      if (empty($_POST['images'])) $_POST['images'] = [];\n      if (empty($_POST['attributes'])) $_POST['attributes'] = [];\n      if (empty($_POST['campaigns'])) $_POST['campaigns'] = [];\n      if (empty($_POST['options'])) $_POST['options'] = [];\n      if (empty($_POST['options_stock'])) $_POST['options_stock'] = [];\n\n      if (!empty($_POST['code']) && database::num_rows(database::query(\"select id from \". DB_TABLE_PREFIX .\"products where id != '\". (int)$product->data['id'] .\"' and code = '\". database::input($_POST['code']) .\"' limit 1;\"))) {\n        throw new Exception(language::translate('error_code_database_conflict', 'Another entry with the given code already exists in the database'));\n      }\n\n      if (!empty($_POST['sku'])  && database::num_rows(database::query(\"select id from \". DB_TABLE_PREFIX .\"products where id != '\". (int)$product->data['id'] .\"' and sku = '\". database::input($_POST['sku']) .\"' limit 1;\"))) {\n        throw new Exception(language::translate('error_sku_database_conflict', 'Another entry with the given SKU already exists in the database'));\n      }\n\n      if (!empty($_POST['mpn']) && database::num_rows(database::query(\"select id from \". DB_TABLE_PREFIX .\"products where id != '\". (int)$product->data['id'] .\"' and mpn = '\". database::input($_POST['mpn']) .\"' limit 1;\"))) {\n        throw new Exception(language::translate('error_mpn_database_conflict', 'Another entry with the given MPN already exists in the database'));\n      }\n\n      if (!empty($_POST['gtin']) && database::num_rows(database::query(\"select id from \". DB_TABLE_PREFIX .\"products where id != '\". (int)$product->data['id'] .\"' and gtin = '\". database::input($_POST['gtin']) .\"' limit 1;\"))) {\n        throw new Exception(language::translate('error_gtin_database_conflict', 'Another entry with the given GTIN already exists in the database'));\n      }\n\n      $_POST['keywords'] = preg_split('#\\s*,\\s*#', $_POST['keywords'], -1, PREG_SPLIT_NO_EMPTY);\n\n      $fields = [\n        'status',\n        'manufacturer_id',\n        'supplier_id',\n        'delivery_status_id',\n        'sold_out_status_id',\n        'default_category_id',\n        'categories',\n        'attributes',\n        'keywords',\n        'date_valid_from',\n        'date_valid_to',\n        'quantity',\n        'quantity_adjustment',\n        'quantity_min',\n        'quantity_max',\n        'quantity_step',\n        'quantity_unit_id',\n        'purchase_price',\n        'purchase_price_currency_code',\n        'recommended_price',\n        'prices',\n        'campaigns',\n        'tax_class_id',\n        'code',\n        'sku',\n        'mpn',\n        'gtin',\n        'taric',\n        'dim_x',\n        'dim_y',\n        'dim_z',\n        'dim_class',\n        'weight',\n        'weight_class',\n        'name',\n        'short_description',\n        'description',\n        'technical_data',\n        'head_title',\n        'meta_description',\n        'images',\n        'options',\n        'options_stock',\n      ];\n\n      foreach ($fields as $field) {\n        if (isset($_POST[$field])) $product->data[$field] = $_POST[$field];\n      }\n\n      if (!empty($_FILES['new_images']['tmp_name'])) {\n        foreach (array_keys($_FILES['new_images']['tmp_name']) as $key) {\n          $product->add_image($_FILES['new_images']['tmp_name'][$key]);\n        }\n      }\n\n      $product->save();\n\n      notices::add('success', language::translate('success_changes_saved', 'Changes saved'));\n      header('Location: '. document::link(WS_DIR_ADMIN, ['app' => $_GET['app'], 'doc' => 'catalog', 'category_id' => $_POST['categories'][0]]));\n      exit;\n\n    } catch (Exception $e) {\n      notices::add('errors', $e->getMessage());\n    }\n  }\n\n  if (isset($_POST['delete'])) {\n\n    try {\n      if (empty($product->data['id'])) throw new Exception(language::translate('error_must_provide_product', 'You must provide a product'));\n\n      $product->delete();\n\n      if (empty($_POST['categories'])) $_POST['categories'] = [0];\n      notices::add('success', language::translate('success_changes_saved', 'Changes saved'));\n      header('Location: '. document::link(WS_DIR_ADMIN, ['app' => $_GET['app'], 'doc' => 'catalog', 'category_id' => $_POST['categories'][0]]));\n      exit;\n\n    } catch (Exception $e) {\n      notices::add('errors', $e->getMessage());\n    }\n  }\n\n  list($product_image_width, $product_image_height) = functions::image_scale_by_width(320, settings::get('product_image_ratio'));\n\n  $option_sort_options = [\n    [language::translate('title_list_order', 'List Order'), 'priority'],\n    [language::translate('title_alphabetical', 'Alphabetical'), 'alphabetical'],\n  ];\n\n  functions::draw_lightbox();\n?>\n<style>\n#categories {\n  max-height: 310px;\n  overflow-y: auto;\n  overflow-x: hidden;\n  transition: all 200ms linear;\n}\n#categories:hover {\n  width: 150%;\n  z-index: 999;\n}\n#categories label {\n  white-space: nowrap;\n}\n\n#images .thumbnail {\n  margin: 0;\n}\n#images .image {\n  overflow: hidden;\n}\n#images .thumbnail {\n  margin-inline-end: 15px;\n}\n#images img {\n  max-width: 50px;\n  max-height: 50px;\n}\n#images .actions {\n  text-align: end;\n  padding: 0.25em 0;\n}\n</style>\n\n<div class=\"panel panel-app\">\n  <div class=\"panel-heading\">\n    <?php echo $app_icon; ?> <?php echo !empty($product->data['id']) ? language::translate('title_edit_product', 'Edit Product') . ': '. $product->data['name'][language::$selected['code']] : language::translate('title_add_new_product', 'Add New Product'); ?>\n  </div>\n\n  <ul class=\"nav nav-tabs\">\n    <li class=\"active\"><a data-toggle=\"tab\" href=\"#tab-general\"><?php echo language::translate('title_general', 'General'); ?></a></li>\n    <li><a data-toggle=\"tab\" href=\"#tab-information\"><?php echo language::translate('title_information', 'Information'); ?></a></li>\n    <li><a data-toggle=\"tab\" href=\"#tab-attributes\"><?php echo language::translate('title_attributes', 'Attributes'); ?></a></li>\n    <li><a data-toggle=\"tab\" href=\"#tab-prices\"><?php echo language::translate('title_prices', 'Prices'); ?></a></li>\n    <li><a data-toggle=\"tab\" href=\"#tab-options\"><?php echo language::translate('title_options', 'Options'); ?></a></li>\n    <li><a data-toggle=\"tab\" href=\"#tab-stock\"><?php echo language::translate('title_stock', 'Stock'); ?></a></li>\n  </ul>\n\n  <div class=\"panel-body\">\n    <?php echo functions::form_draw_form_begin('product_form', 'post', false, true); ?>\n\n      <div class=\"tab-content\">\n        <div id=\"tab-general\" class=\"tab-pane active\" style=\"max-width: 1200px;\">\n\n          <div class=\"row\">\n            <div class=\"col-md-4\">\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_status', 'Status'); ?></label>\n                <?php echo functions::form_draw_toggle('status', isset($_POST['status']) ? $_POST['status'] : '0', 'e/d'); ?>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_categories', 'Categories'); ?></label>\n                <?php echo functions::form_draw_categories_list('categories[]', true, 'style=\"max-height: 480px;\"'); ?>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_default_category', 'Default Category'); ?></label>\n                <?php echo functions::form_draw_select_field('default_category_id', [], true); ?>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_date_valid_from', 'Date Valid From'); ?></label>\n                <?php echo functions::form_draw_date_field('date_valid_from', true); ?>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_date_valid_to', 'Date Valid To'); ?></label>\n                <?php echo functions::form_draw_date_field('date_valid_to', true); ?>\n              </div>\n\n              <?php if (!empty($product->data['id'])) { ?>\n              <div class=\"row\">\n                <div class=\"form-group col-md-6\">\n                  <label><?php echo language::translate('title_date_updated', 'Date Updated'); ?></label>\n                  <div><?php echo language::strftime('%e %b %Y %H:%M', strtotime($product->data['date_updated'])); ?></div>\n                </div>\n\n                <div class=\"form-group col-md-6\">\n                  <label><?php echo language::translate('title_date_created', 'Date Created'); ?></label>\n                  <div><?php echo language::strftime('%e %b %Y %H:%M', strtotime($product->data['date_created'])); ?></div>\n                </div>\n              </div>\n              <?php } ?>\n            </div>\n\n            <div class=\"col-md-4\">\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_name', 'Name'); ?></label>\n                 <?php foreach (array_keys(language::$languages) as $language_code) echo functions::form_draw_regional_input_field($language_code, 'name['. $language_code .']', true); ?>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_code', 'Code'); ?></label>\n                <?php echo functions::form_draw_text_field('code', true); ?>\n              </div>\n\n              <div class=\"form-group\">\n                <div class=\"input-group\">\n                  <label class=\"input-group-text\" style=\"width: 125px;\"><?php echo language::translate('title_sku', 'SKU'); ?> <a href=\"https://en.wikipedia.org/wiki/Stock_keeping_unit\" target=\"_blank\"><?php echo functions::draw_fonticon('fa-external-link'); ?></a></label>\n                  <?php echo functions::form_draw_text_field('sku', true); ?>\n                </div>\n\n                <div class=\"input-group\">\n                  <label class=\"input-group-text\" style=\"width: 125px;\"><?php echo language::translate('title_mpn', 'MPN'); ?> <a href=\"https://en.wikipedia.org/wiki/Manufacturer_part_number\" target=\"_blank\"><?php echo functions::draw_fonticon('fa-external-link'); ?></a></label>\n                  <?php echo functions::form_draw_text_field('mpn', true); ?>\n                </div>\n\n                <div class=\"input-group\">\n                  <label class=\"input-group-text\" style=\"width: 125px;\"><?php echo language::translate('title_gtin', 'GTIN'); ?> <a href=\"https://en.wikipedia.org/wiki/Global_Trade_Item_Number\" target=\"_blank\"><?php echo functions::draw_fonticon('fa-external-link'); ?></a></label>\n                  <?php echo functions::form_draw_text_field('gtin', true); ?>\n                </div>\n\n                <div class=\"input-group\">\n                  <label class=\"input-group-text\" style=\"width: 125px;\"><?php echo language::translate('title_taric', 'TARIC'); ?> <a href=\"https://en.wikipedia.org/wiki/TARIC_code\" target=\"_blank\"><?php echo functions::draw_fonticon('fa-external-link'); ?></a></label>\n                  <?php echo functions::form_draw_text_field('taric', true); ?>\n                </div>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_manufacturer', 'Manufacturer'); ?></label>\n                <?php echo functions::form_draw_manufacturers_list('manufacturer_id', true); ?>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_supplier', 'Supplier'); ?></label>\n                <?php echo functions::form_draw_suppliers_list('supplier_id', true); ?>\n              </div>\n\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_keywords', 'Keywords'); ?></label>\n                <?php echo functions::form_draw_text_field('keywords', true); ?>\n              </div>\n            </div>\n\n            <div class=\"col-md-4\">\n              <div class=\"form-group\">\n                <label><?php echo language::translate('title_images', 'Images'); ?></label>\n                <div class=\"thumbnail\">\n<?php\n  if (isset($product->data['id']) && !empty($product->data['images'])) {\n    $image = current($product->data['images']);\n    echo '<img class=\"main-image\" src=\"'. document::href_link(WS_DIR_APP . functions::image_thumbnail(FS_DIR_APP . 'images/' . $image['filename'], $product_image_width, $product_image_height, settings::get('product_image_clipping'))) .'\" alt=\"\" />';\n    reset($product->data['images']);\n  } else {\n    echo '<img class=\"main-image\" src=\"'. document::href_link(WS_DIR_APP . functions::image_thumbnail(FS_DIR_APP . 'images/no_image.png', $product_image_width, $product_image_height, settings::get('product_image_clipping'))) .'\" alt=\"\" />';\n  }\n?>\n                </div>\n              </div>\n\n              <div id=\"images\">\n\n                <div class=\"images\">\n                  <?php if (!empty($_POST['images'])) foreach (array_keys($_POST['images']) as $key) { ?>\n                  <div class=\"image form-group\">\n                    <?php echo functions::form_draw_hidden_field('images['.$key.'][id]', true); ?>\n                    <?php echo functions::form_draw_hidden_field('images['.$key.'][filename]', $_POST['images'][$key]['filename']); ?>\n\n                    <div class=\"thumbnail float-start\">\n                      <img src=\"<?php echo document::href_link(WS_DIR_APP . functions::image_thumbnail(FS_DIR_APP . 'images/' . $product->data['images'][$key]['filename'], $product_image_width, $product_image_height, settings::get('product_image_clipping'))); ?>\" alt=\"\" />\n                    </div>\n\n                    <div class=\"input-group\">\n                      <?php echo functions::form_draw_text_field('images['.$key.'][new_filename]', isset($_POST['images'][$key]['new_filename']) ? $_POST['images'][$key]['new_filename'] : $_POST['images'][$key]['filename']); ?>\n                      <div class=\"input-group-text\">\n                        <a class=\"move-up\" href=\"#\" title=\"<?php echo language::translate('text_move_up', 'Move up'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-up fa-lg', 'style=\"color: #3399cc;\"'); ?></a>\n                        <a class=\"move-down\" href=\"#\" title=\"<?php echo language::translate('text_move_down', 'Move down'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-down fa-lg', 'style=\"color: #3399cc;\"'); ?></a>\n                        <a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"'); ?></a>\n                      </div>\n                    </div>\n                  </div>\n                  <?php } ?>\n                </div>\n\n                <div class=\"new-images\">\n                  <div class=\"image form-group\">\n                    <div class=\"thumbnail float-start\">\n                      <img src=\"<?php echo document::href_link(WS_DIR_APP . functions::image_thumbnail(FS_DIR_APP . 'images/no_image.png', $product_image_width, $product_image_height, settings::get('product_image_clipping'))); ?>\" alt=\"\" />\n                    </div>\n\n                    <div class=\"input-group\">\n                      <?php echo functions::form_draw_file_field('new_images[]'); ?>\n                      <div class=\"input-group-text\">\n                        <a class=\"move-up\" href=\"#\" title=\"<?php echo language::translate('text_move_up', 'Move up'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-up fa-lg', 'style=\"color: #3399cc;\"'); ?></a>\n                        <a class=\"move-down\" href=\"#\" title=\"<?php echo language::translate('text_move_down', 'Move down'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-down fa-lg', 'style=\"color: #3399cc;\"'); ?></a>\n                        <a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"'); ?></a>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n\n                <div class=\"form-group\">\n                  <a href=\"#\" class=\"add\" title=\"<?php echo language::translate('text_add', 'Add'); ?>\"><?php echo functions::draw_fonticon('fa-plus-circle', 'style=\"color: #66cc66;\"'); ?></a>\n                </div>\n              </div>\n            </div>\n          </div>\n\n        </div>\n\n        <div id=\"tab-information\" class=\"tab-pane\">\n\n          <ul class=\"nav nav-tabs\">\n            <?php foreach (language::$languages as $language) { ?>\n              <li<?php echo ($language['code'] == language::$selected['code']) ? ' class=\"active\"' : ''; ?>><a data-toggle=\"tab\" href=\"#<?php echo $language['code']; ?>\"><?php echo $language['name']; ?></a></li>\n            <?php } ?>\n          </ul>\n\n          <div class=\"tab-content\">\n\n            <?php foreach (array_keys(language::$languages) as $language_code) { ?>\n            <div id=\"<?php echo $language_code; ?>\" class=\"tab-pane fade in<?php echo ($language_code == language::$selected['code']) ? ' active' : ''; ?>\">\n\n              <div class=\"row\">\n                <div class=\"col-md-6\">\n\n                  <div class=\"form-group\">\n                    <label><?php echo language::translate('title_name', 'Name'); ?></label>\n                    <?php echo functions::form_draw_regional_input_field($language_code, 'name['. $language_code .']', true); ?>\n                  </div>\n\n                  <div class=\"form-group\">\n                    <label><?php echo language::translate('title_short_description', 'Short Description'); ?></label>\n                    <?php echo functions::form_draw_regional_input_field($language_code, 'short_description['. $language_code .']', true); ?>\n                  </div>\n\n                  <div class=\"form-group\">\n                    <label><?php echo language::translate('title_description', 'Description'); ?></label>\n                    <?php echo functions::form_draw_regional_wysiwyg_field($language_code, 'description['. $language_code .']', true, 'style=\"height: 250px;\"'); ?>\n                  </div>\n\n                  <div class=\"row\">\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_head_title', 'Head Title'); ?></label>\n                      <?php echo functions::form_draw_regional_input_field($language_code, 'head_title['. $language_code .']', true); ?>\n                    </div>\n\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_meta_description', 'Meta Description'); ?></label>\n                      <?php echo functions::form_draw_regional_input_field($language_code, 'meta_description['. $language_code .']', true); ?>\n                    </div>\n                  </div>\n                </div>\n\n                <div class=\"col-md-6\">\n                  <div class=\"form-group\">\n                    <label><?php echo language::translate('title_technical_data', 'Technical Data'); ?> <a class=\"technical-data-hint\" href=\"#\"><?php echo functions::draw_fonticon('fa-question-circle'); ?></a></label>\n                    <?php echo functions::form_draw_regional_textarea($language_code, 'technical_data['. $language_code .']', true, 'style=\"height: 480px;\"'); ?>\n                  </div>\n                </div>\n\n              </div>\n            </div>\n            <?php } ?>\n\n          </div>\n        </div>\n\n        <div id=\"tab-attributes\" class=\"tab-pane\" style=\"max-width: 960px;\">\n\n          <table class=\"table table-striped data-table\">\n            <thead>\n              <tr>\n                <th style=\"width: 320px;\"><?php echo language::translate('title_group', 'Group'); ?></th>\n                <th style=\"width: 320px;\"><?php echo language::translate('title_value', 'Value'); ?></th>\n                <th><?php echo language::translate('title_custom_value', 'Custom Value'); ?></th>\n                <th style=\"width: 60px;\"></th>\n              </tr>\n            </thead>\n            <tbody>\n              <?php if (!empty($_POST['attributes'])) foreach (array_keys($_POST['attributes']) as $key) { ?>\n              <tr>\n                <?php echo functions::form_draw_hidden_field('attributes['.$key.'][id]', true); ?>\n                <?php echo functions::form_draw_hidden_field('attributes['.$key.'][group_id]', true); ?>\n                <?php echo functions::form_draw_hidden_field('attributes['.$key.'][group_name]', true); ?>\n                <?php echo functions::form_draw_hidden_field('attributes['.$key.'][value_id]', true); ?>\n                <?php echo functions::form_draw_hidden_field('attributes['.$key.'][value_name]', true); ?>\n                <?php echo functions::form_draw_hidden_field('attributes['.$key.'][custom_value]', true); ?>\n                <td><?php echo functions::escape_html($_POST['attributes'][$key]['group_name']); ?></td>\n                <td><?php echo functions::escape_html($_POST['attributes'][$key]['value_name']); ?></td>\n                <td><?php echo functions::escape_html($_POST['attributes'][$key]['custom_value']); ?></td>\n                <td class=\"text-end\"><a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"'); ?></a></td>\n              </tr>\n              <?php } ?>\n            </tbody>\n            <tfoot>\n              <tr>\n                <td><?php echo functions::form_draw_attribute_groups_list('new_attribute[group_id]', [], ''); ?></td>\n                <td><?php echo functions::form_draw_select_field('new_attribute[value_id]', [], ''); ?></td>\n                <td><?php echo functions::form_draw_text_field('new_attribute[custom_value]', ''); ?></td>\n                <td><?php echo functions::form_draw_button('add', language::translate('title_add', 'Add'), 'button'); ?></td>\n              </tr>\n            </tfoot>\n          </table>\n        </div>\n\n        <div id=\"tab-prices\" class=\"tab-pane\">\n\n          <div id=\"prices\" style=\"max-width: 640px;\">\n            <h2><?php echo language::translate('title_prices', 'Prices'); ?></h2>\n\n            <div class=\"row\">\n              <div class=\"form-group col-md-6\">\n                <label><?php echo language::translate('title_purchase_price', 'Purchase Price'); ?></label>\n                <div class=\"input-group\">\n                  <?php echo functions::form_draw_decimal_field('purchase_price', true, 2, 0, null); ?>\n                  <?php echo functions::form_draw_currencies_list('purchase_price_currency_code', true, false); ?>\n                </div>\n              </div>\n\n              <div class=\"form-group col-md-6\">\n                <label><?php echo language::translate('title_recommended_price', 'Recommended Price'); ?> / MSRP</label>\n                <?php echo functions::form_draw_currency_field(settings::get('store_currency_code'), 'recommended_price', true); ?>\n              </div>\n\n              <div class=\"form-group col-md-6\">\n                <label><?php echo language::translate('title_tax_class', 'Tax Class'); ?></label>\n                <?php echo functions::form_draw_tax_classes_list('tax_class_id', true); ?>\n              </div>\n            </div>\n\n            <table class=\"table table-striped data-table\">\n              <thead>\n                <tr>\n                  <td style=\"width: 50%;\"><?php echo language::translate('title_price', 'Price'); ?></td>\n                  <td style=\"width: 50%;\"><?php echo language::translate('title_price_incl_tax', 'Price Incl. Tax'); ?> (<a id=\"price-incl-tax-tooltip\" href=\"#\">?</a>)</td>\n                </tr>\n              </thead>\n              <tbody>\n                <tr>\n                  <td><?php echo functions::form_draw_currency_field(settings::get('store_currency_code'), 'prices['. settings::get('store_currency_code') .']', true, 'data-currency-price=\"\" placeholder=\"\"'); ?></td>\n                  <td><?php echo functions::form_draw_decimal_field('gross_prices['. settings::get('store_currency_code') .']', '', currency::$currencies[settings::get('store_currency_code')]['decimals'], 0, null, 'placeholder=\"\"'); ?></td>\n                </tr>\n<?php\n  foreach (currency::$currencies as $currency) {\n    if ($currency['code'] == settings::get('store_currency_code')) continue;\n?>\n                <tr>\n                  <td><?php echo functions::form_draw_currency_field($currency['code'], 'prices['. $currency['code'] .']', true, 'data-currency-price=\"\" placeholder=\"\"'); ?></td>\n                  <td><?php echo functions::form_draw_decimal_field('gross_prices['. $currency['code'] .']', '', $currency['decimals'], 0, null, 'placeholder=\"\"'); ?></td>\n                </tr>\n<?php\n  }\n?>\n              </tbody>\n            </table>\n          </div>\n\n          <h2><?php echo language::translate('title_campaigns', 'Campaigns'); ?></h2>\n          <div class=\"table-responsive\">\n            <table id=\"table-campaigns\" class=\"table table-striped data-table\">\n              <tbody>\n                <?php if (!empty($_POST['campaigns'])) foreach (array_keys($_POST['campaigns']) as $key) { ?>\n                <tr>\n                  <td><?php echo language::translate('title_start_date', 'Start Date'); ?><br />\n                    <?php echo functions::form_draw_hidden_field('campaigns['.$key.'][id]', true) . functions::form_draw_datetime_field('campaigns['.$key.'][start_date]', true); ?>\n                  </td>\n                  <td><?php echo language::translate('title_end_date', 'End Date'); ?><br />\n                    <?php echo functions::form_draw_datetime_field('campaigns['.$key.'][end_date]', true); ?>\n                  </td>\n                  <td>- %<br />\n                    <?php echo functions::form_draw_decimal_field('campaigns['.$key.'][percentage]', '', 2, 0, null); ?>\n                  </td>\n                  <td><?php echo settings::get('store_currency_code'); ?><br />\n                    <?php echo functions::form_draw_currency_field(settings::get('store_currency_code'), 'campaigns['.$key.']['. settings::get('store_currency_code') .']', true); ?>\n                  </td>\n<?php\n  foreach (array_keys(currency::$currencies) as $currency_code) {\n    if ($currency_code == settings::get('store_currency_code')) continue;\n?>\n                  <td><?php echo $currency_code; ?><br />\n                    <?php echo functions::form_draw_currency_field($currency_code, 'campaigns['.$key.']['. $currency_code. ']', isset($_POST['campaigns'][$key][$currency_code]) ? number_format((float)$_POST['campaigns'][$key][$currency_code], 4, '.', '') : ''); ?>\n                  </td>\n<?php\n  }\n?>\n                  <td><br /><a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"'); ?></a></td>\n                </tr>\n              <?php } ?>\n              </tbody>\n              <tfoot>\n                <tr>\n                  <td colspan=\"<?php echo 5 + count(currency::$currencies) - 1; ?>\"><?php echo functions::draw_fonticon('fa-plus-circle', 'style=\"color: #66cc66;\"'); ?> <a class=\"add\" href=\"#\"><?php echo language::translate('text_add_campaign', 'Add Campaign'); ?></a></td>\n                </tr>\n              </tfoot>\n            </table>\n          </div>\n        </div>\n<style>\n#tab-options li {\n  background: #f9f9f9;\n  padding: 1em;\n  border-radius: 4px;\n  margin-bottom: 2em;\n  border: 1px solid #ececec;\n}\n</style>\n        <div id=\"tab-options\" class=\"tab-pane\">\n\n          <ul id=\"options\" class=\"list-unstyled\">\n            <?php foreach ($_POST['options'] as $group_id => $option) { ?>\n            <li data-group-id=\"<?php echo functions::escape_html($group_id); ?>\" data-group-name=\"<?php echo functions::escape_html($option['name']); ?>\">\n\n              <div class=\"float-end\">\n                <a class=\"move-group-up\" href=\"#\" title=\"<?php echo language::translate('text_move_up', 'Move up'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-up fa-2x', 'style=\"color: #3399cc;\"'); ?></a>\n                <a class=\"move-group-down\" href=\"#\" title=\"<?php echo language::translate('text_move_down', 'Move down'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-down fa-2x', 'style=\"color: #3399cc;\"'); ?></a>\n                <a class=\"remove-group\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-2x', 'style=\"color: #cc3333;\"'); ?></a>\n              </div>\n\n              <h2><?php echo $option['name']; ?></h2>\n              <?php echo functions::form_draw_hidden_field('options['.$group_id.'][id]', true) . functions::form_draw_hidden_field('options['.$group_id.'][group_id]', true) . functions::form_draw_hidden_field('options['.$group_id.'][name]', true); ?>\n\n              <div class=\"row\">\n                <div class=\"form-group col-sm-4 col-md-2\">\n                  <label><?php echo language::translate('title_function', 'Function'); ?></label>\n                  <?php echo functions::form_draw_select_field('options['.$group_id.'][function]', in_array($option['function'], ['select', 'radio', 'checkbox']) ? ['select', 'radio', 'checkbox'] : ['text', 'textarea'], true); ?>\n                </div>\n\n                <?php if (in_array($option['function'], ['select', 'radio', 'checkbox'])) { ?>\n                <div class=\"form-group col-sm-4 col-md-2\">\n                  <label><?php echo language::translate('title_sort_values', 'Sort Values'); ?></label>\n                  <?php echo functions::form_draw_select_field('options['.$group_id.'][sort]', $option_sort_options, true); ?>\n                </div>\n                <?php } ?>\n\n                <div class=\"form-group col-sm-4 col-md-2\">\n                  <label><?php echo language::translate('title_required', 'Required'); ?></label>\n                  <div class=\"checkbox\">\n                    <label><?php echo functions::form_draw_checkbox('options['.$group_id.'][required]', '1', true); ?> <?php echo language::translate('title_required', 'Required'); ?></label>\n                  </div>\n                </div>\n              </div>\n\n              <?php if (in_array($option['function'], ['select', 'radio', 'checkbox'])) { ?>\n              <div class=\"table-responsive\">\n                <table class=\"table table-striped table-hover table-dragable data-table\">\n                  <thead>\n                    <tr>\n                      <th class=\"main\"><?php echo language::translate('title_option', 'Option'); ?></th>\n                      <th style=\"width: 150px;\"><?php echo language::translate('title_price_operator', 'Price Operator'); ?></th>\n                      <th colspan=\"<?php echo count(currency::$currencies); ?>\"><?php echo language::translate('title_price_adjustment', 'Price Adjustment'); ?></th>\n                      <th style=\"width: 85px;\">&nbsp;</th>\n                    </tr>\n                  </thead>\n\n                  <tbody>\n                  <?php foreach ($option['values'] as $value_id => $value) { ?>\n                    <tr data-value-id=\"<?php echo functions::escape_html($value['value_id']); ?>\" data-value-name=\"<?php echo functions::escape_html($_POST['options'][$group_id]['values'][$value_id]['name']); ?>\">\n                      <td class=\"grabable\"><?php echo functions::form_draw_hidden_field('options['.$group_id.'][values]['. $value_id .'][id]', true) . functions::form_draw_hidden_field('options['.$group_id.'][values]['. $value_id .'][value_id]', true) . functions::form_draw_hidden_field('options['.$group_id.'][values]['. $value_id .'][custom_value]', true) . functions::form_draw_hidden_field('options['.$group_id.'][values]['. $value_id .'][name]', true); ?><?php echo $value['name']; ?></td>\n                      <td style=\"text-align: center;\"><?php echo functions::form_draw_select_field('options['.$group_id.'][values]['. $value_id .'][price_operator]', ['+','%','*','='], true); ?></td>\n                      <?php foreach (array_keys(currency::$currencies) as $currency_code) echo '<td>'. functions::form_draw_currency_field($currency_code, 'options['.$group_id.'][values]['. $value_id .']['. $currency_code. ']', (!empty($_POST['options'][$group_id]['values'][$value_id][$currency_code]) || $_POST['options'][$group_id]['values'][$value_id][$currency_code] != 0) ? true : '', 'style=\"width: 100px;\"') .'</td>'; ?>\n                      <td class=\"text-end\"><a class=\"move-up\" href=\"#\" title=\"<?php echo language::translate('text_move_up', 'Move up'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-up fa-lg', 'style=\"color: #3399cc;\"'); ?></a> <a class=\"move-down\" href=\"#\" title=\"<?php echo language::translate('text_move_down', 'Move down'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-down fa-lg', 'style=\"color: #3399cc;\"'); ?></a> <a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"'); ?></a></td>\n                    </tr>\n                  <?php } ?>\n                  </tbody>\n                </table>\n              </div>\n              <?php } ?>\n\n            </li>\n            <?php } ?>\n          </ul>\n\n          <div>\n            <a class=\"btn btn-default\" href=\"#modal-predefined-option\" data-toggle=\"lightbox\"><?php echo functions::draw_fonticon('fa-plus-circle', 'style=\"color: #66cc66;\"'); ?> <?php echo language::translate('title_add_predefined_option', 'Add Predefined Option'); ?></a>\n            <a class=\"btn btn-default\" href=\"#modal-user-input-option\" data-toggle=\"lightbox\"><?php echo functions::draw_fonticon('fa-plus-circle', 'style=\"color: #66cc66;\"'); ?> <?php echo language::translate('title_add_user_input_option', 'Add User Input Option'); ?></a>\n          </div>\n\n          <div id=\"modal-predefined-option\" style=\"display: none;\">\n            <fieldset style=\"max-width: 960px;\">\n              <legend><?php echo language::translate('title_add_predefined_option', 'Add Predefined Option'); ?></legend>\n              <div class=\"row\" style=\"margin-bottom: 0;\">\n                <div class=\"form-group col-md-3\">\n                  <label><?php echo language::translate('title_attribute_group', 'Attribute Group'); ?></label>\n                  <?php echo functions::form_draw_attribute_groups_list('new_predefined_option[group_id]', ''); ?>\n                </div>\n\n                <div class=\"form-group col-md-3\">\n                  <label><?php echo language::translate('title_value', 'Value'); ?></label>\n                  <?php echo functions::form_draw_select_field('new_predefined_option[value_id]', [['','']], '', 'disabled'); ?>\n                </div>\n\n                <div class=\"form-group col-md-3\">\n                  <label><?php echo language::translate('title_custom_value', 'Custom Value'); ?></label>\n                  <?php echo functions::form_draw_text_field('new_predefined_option[custom_value]', ''); ?>\n                </div>\n\n                <div class=\"col-md-3\" style=\"align-self: end;\">\n                  <?php echo functions::form_draw_button('add_predefined_option', language::translate('title_add', 'Add'), 'button', 'class=\"btn btn-default btn-block\"'); ?>\n                </div>\n              </div>\n            </fieldset>\n          </div>\n\n          <div id=\"modal-user-input-option\" style=\"display: none;\">\n            <fieldset>\n              <legend><?php echo language::translate('title_add_user_input_option', 'Add User Input Option'); ?></legend>\n              <div class=\"row\" style=\"margin-bottom: 0;\">\n                <div class=\"form-group col-md-8\">\n                  <label><?php echo language::translate('title_attribute_group', 'Attribute Group'); ?></label>\n                  <?php echo functions::form_draw_attribute_groups_list('new_user_input_option[group_id]', ''); ?>\n                </div>\n                <div class=\"col-md-4\" style=\"align-self: end;\">\n                  <?php echo functions::form_draw_button('add_user_input_option', language::translate('title_add', 'Add'), 'button', 'class=\"btn btn-default btn-block\"'); ?>\n                </div>\n              </div>\n            </fieldset>\n          </div>\n        </div>\n\n        <div id=\"tab-stock\" class=\"tab-pane\">\n          <h2><?php echo language::translate('title_stock', 'Stock'); ?></h2>\n\n          <div class=\"row\" style=\"max-width: 640px;\">\n            <div class=\"form-group col-md-3\">\n              <label><?php echo language::translate('title_min_order_qty', 'Min. Order Qty'); ?></label>\n              <?php echo functions::form_draw_decimal_field('quantity_min', true, 2, 0); ?>\n            </div>\n\n            <div class=\"form-group col-md-3\">\n              <label><?php echo language::translate('title_max_order_quantity', 'Max. Order Qty'); ?></label>\n              <?php echo functions::form_draw_decimal_field('quantity_max', true, 2, 0); ?>\n            </div>\n\n            <div class=\"form-group col-md-3\">\n              <label><?php echo language::translate('title_quantity_step', 'Quantity Step'); ?></label>\n              <?php echo functions::form_draw_decimal_field('quantity_step', true, 2, 0); ?>\n            </div>\n\n            <div class=\"form-group col-md-3\">\n              <label><?php echo language::translate('title_quantity_unit', 'Quantity Unit'); ?></label>\n              <?php echo functions::form_draw_quantity_units_list('quantity_unit_id', true, false); ?>\n            </div>\n          </div>\n\n          <div class=\"row\" style=\"max-width: 640px;\">\n            <div class=\"form-group col-md-6\">\n              <label><?php echo language::translate('title_delivery_status', 'Delivery Status'); ?></label>\n              <?php echo functions::form_draw_delivery_statuses_list('delivery_status_id', true); ?>\n            </div>\n\n            <div class=\"form-group col-md-6\">\n              <label><?php echo language::translate('title_sold_out_status', 'Sold Out Status'); ?></label>\n              <?php echo functions::form_draw_sold_out_statuses_list('sold_out_status_id', true); ?>\n            </div>\n\n          </div>\n\n          <div class=\"table-responsive\">\n            <table id=\"table-stock\" class=\"table table-striped table-hover data-table\">\n              <thead>\n                <tr>\n                  <th><?php echo language::translate('title_option', 'Option'); ?></th>\n                  <th style=\"width: 250px;\"><?php echo language::translate('title_sku', 'SKU'); ?></th>\n                  <th style=\"width: 185px;\"><?php echo language::translate('title_weight', 'Weight'); ?></th>\n                  <th style=\"width: 400px;\"><?php echo language::translate('title_dimensions', 'Dimensions'); ?></th>\n                  <th class=\"text-center\" style=\"width: 125px;\"><?php echo language::translate('title_quantity', 'Quantity'); ?></th>\n                  <th class=\"text-center\" style=\"width: 150px;\"><?php echo language::translate('title_adjust', 'Adjust'); ?></th>\n                  <th style=\"width: 85px;\">&nbsp;</th>\n                </tr>\n              </thead>\n              <tbody>\n                <tr>\n                  <td><strong><?php echo language::translate('title_default_item', 'Default Item'); ?></strong></td>\n                  <td><?php echo functions::form_draw_text_field('sku', true); ?></td>\n                  <td>\n                    <div class=\"input-group\">\n                      <?php echo functions::form_draw_decimal_field('weight', true, 4, 0); ?>\n                      <?php echo functions::form_draw_weight_classes_list('weight_class', true); ?>\n                    </div>\n                  </td>\n                  <td>\n                    <div class=\"input-group\">\n                      <?php echo functions::form_draw_decimal_field('dim_x', true, 4, 0); ?>\n                      <?php echo functions::form_draw_decimal_field('dim_y', true, 4, 0); ?>\n                      <?php echo functions::form_draw_decimal_field('dim_z', true, 4, 0); ?>\n                      <?php echo functions::form_draw_length_classes_list('dim_class', true); ?>\n                    </div>\n                  </td>\n                  <td><?php echo functions::form_draw_decimal_field('quantity', true, 2, null, null, 'data-quantity=\"'. (float)$product->data['quantity'] .'\"' . (!empty($_POST['options_stock']) ? ' readonly' : '')); ?></td>\n                  <td>\n                    <div class=\"input-group\">\n                      <span class=\"input-group-text\">&plusmn;</span>\n                      <?php echo functions::form_draw_decimal_field('quantity_adjustment', true, 2, null, null, !empty($_POST['options_stock']) ? 'readonly' : ''); ?>\n                    </div>\n                  </td>\n                  <td></td>\n                </tr>\n                <?php if (!empty($_POST['options_stock'])) foreach (array_keys($_POST['options_stock']) as $key) { ?>\n                <tr>\n                  <td><?php echo functions::form_draw_hidden_field('options_stock['.$key.'][id]', true); ?><?php echo functions::form_draw_hidden_field('options_stock['.$key.'][combination]', true); ?>\n                    <?php echo functions::form_draw_hidden_field('options_stock['.$key.'][name]['. language::$selected['name'] .']', true); ?>\n                    <?php echo functions::escape_html($_POST['options_stock'][$key]['name'][language::$selected['code']]); ?></td>\n                  <td><?php echo functions::form_draw_text_field('options_stock['.$key.'][sku]', true); ?></td>\n                  <td>\n                    <div class=\"input-group\">\n                      <?php echo functions::form_draw_decimal_field('options_stock['.$key.'][weight]', true, 4, 0); ?>\n                      <?php echo functions::form_draw_weight_classes_list('options_stock['.$key.'][weight_class]', true); ?>\n                    </div>\n                  </td>\n                  <td>\n                    <div class=\"input-group\">\n                      <?php echo functions::form_draw_decimal_field('options_stock['.$key.'][dim_x]', true, 4, 0); ?>\n                      <?php echo functions::form_draw_decimal_field('options_stock['.$key.'][dim_y]', true, 4, 0); ?>\n                      <?php echo functions::form_draw_decimal_field('options_stock['.$key.'][dim_z]', true, 4, 0); ?>\n                      <?php echo functions::form_draw_length_classes_list('options_stock['.$key.'][dim_class]', true); ?>\n                    </div>\n                  </td>\n                  <td><?php echo functions::form_draw_decimal_field('options_stock['.$key.'][quantity]', true, 2, null, null, 'data-quantity=\"'. (isset($product->data['options_stock'][$key]['quantity']) ? (float)$product->data['options_stock'][$key]['quantity'] : '0') .'\"'); ?></td>\n                  <td>\n                    <div class=\"input-group\">\n                      <span class=\"input-group-text\">&plusmn;</span>\n                      <?php echo functions::form_draw_decimal_field('options_stock['.$key.'][quantity_adjustment]', true); ?>\n                    </div>\n                  </td>\n                  <td class=\"text-end\">\n                    <a class=\"move-up\" href=\"#\" title=\"<?php echo language::translate('text_move_up', 'Move up'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-up fa-lg', 'style=\"color: #3399cc;\"'); ?></a>\n                    <a class=\"move-down\" href=\"#\" title=\"<?php echo language::translate('text_move_down', 'Move down'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-down fa-lg', 'style=\"color: #3399cc;\"'); ?></a>\n                    <a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"'); ?></a>\n                  </td>\n                </tr>\n              <?php } ?>\n              </tbody>\n              <tfoot>\n                <tr>\n                  <td colspan=\"7\"><?php echo functions::draw_fonticon('fa-plus-circle', 'style=\"color: #66cc66;\"'); ?> <a class=\"add\" href=\"#\"><?php echo language::translate('title_add_stock_option', 'Add Stock Option'); ?></a></td>\n                </tr>\n              </tfoot>\n            </table>\n          </div>\n\n          <div id=\"new-stock-option\" class=\"lightbox\" style=\"display: none; max-width: 640px;\">\n            <h3 class=\"title\"><?php echo language::translate('title_create_stock_option_from_combination_of_options', 'Create a new stock option from a combination of options'); ?></h3>\n\n            <table class=\"table table-striped\" style=\"width: 100%;\">\n              <thead>\n                <tr>\n                  <th></th>\n                  <th style=\"width: 50%;\"><?php echo language::translate('title_group', 'Group'); ?></th>\n                  <th style=\"width: 50%;\"><?php echo language::translate('title_value', 'Value'); ?></th>\n                </tr>\n              </thead>\n              <tbody />\n            </table>\n\n            <button type=\"button\" class=\"btn btn-default\" name=\"add_stock_option\"><?php echo language::translate('title_add_stock_option', 'Add Stock Option'); ?></button>\n          </div>\n        </div>\n      </div>\n\n      <div class=\"panel-action btn-group\">\n        <?php echo functions::form_draw_button('save', language::translate('title_save', 'Save'), 'submit', '', 'save'); ?>\n        <?php echo functions::form_draw_button('cancel', language::translate('title_cancel', 'Cancel'), 'button', 'onclick=\"history.go(-1);\"', 'cancel'); ?>\n        <?php echo (isset($product->data['id'])) ? functions::form_draw_button('delete', language::translate('title_delete', 'Delete'), 'submit', 'formnovalidate onclick=\"if (!window.confirm(\\''. language::translate('text_are_you_sure', 'Are you sure?') .'\\')) return false;\"', 'delete') : false; ?>\n      </div>\n\n    <?php echo functions::form_draw_form_end(); ?>\n  </div>\n</div>\n\n<script>\n\n// Initiate\n\n  $('input[name^=\"name\"]').on('input', function(e){\n    var language_code = $(this).attr('name').match(/\\[(.*)\\]$/)[1];\n    $('.nav-tabs a[href=\"#'+language_code+'\"]').css('opacity', $(this).val() ? 1 : .5);\n    $('input[name=\"name['+language_code+']\"]').not(this).val($(this).val());\n    $('input[name=\"head_title['+language_code+']\"]').attr('placeholder', $(this).val());\n    $('input[name=\"h1_title['+language_code+']\"]').attr('placeholder', $(this).val());\n  }).trigger('input');\n\n  $('input[name^=\"short_description\"]').on('input', function(e){\n    var language_code = $(this).attr('name').match(/\\[(.*)\\]$/)[1];\n    $('input[name=\"meta_description['+language_code+']\"]').attr('placeholder', $(this).val());\n  }).trigger('input');\n\n// Default Category\n\n  $('[data-toggle=\"category-picker\"]').on('change', function() {\n    var default_category_id = $('select[name=\"default_category_id\"]').val();\n\n    $('select[name=\"default_category_id\"]').html('');\n\n    $('input[name=\"categories[]\"]').each(function() {\n      $('select[name=\"default_category_id\"]').append('<option value=\"'+ $(this).val() +'\">'+ $(this).data('name') +'</option>');\n    });\n\n    $('select[name=\"default_category_id\"] option[value=\"'+ default_category_id +'\"]').prop('selected', true);\n  }).trigger('change');\n\n  $('select[name=\"default_category_id\"]').val('<?php echo $product->data['default_category_id']; ?>');\n\n// SKU\n\n  $('input[name=\"sku\"]').change(function() {\n    $('input[name=\"sku\"]').not(this).val($(this).val());\n  });\n\n// Images\n\n  $('#images').on('click', '.move-up, .move-down', function(e) {\n    e.preventDefault();\n    var row = $(this).closest('.form-group');\n\n    if ($(this).is('.move-up') && $(row).prevAll().length > 0) {\n      $(row).insertBefore(row.prev());\n    } else if ($(this).is('.move-down') && $(row).nextAll().length > 0) {\n      $(row).insertAfter($(row).next());\n    }\n    refreshMainImage();\n  });\n\n  $('#images').on('click', '.remove', function(e) {\n    e.preventDefault();\n    $(this).closest('.form-group').remove();\n    refreshMainImage();\n  });\n\n  $('#images .add').click(function(e) {\n    e.preventDefault();\n    var output = '<div class=\"image form-group\">'\n               + '  <div class=\"thumbnail float-start\">'\n               + '    <img src=\"<?php echo document::href_link(WS_DIR_APP . functions::image_thumbnail(FS_DIR_APP . 'images/no_image.png', $product_image_width, $product_image_height, settings::get('product_image_clipping'))); ?>\" alt=\"\" />'\n               + '  </div>'\n               + '  '\n               + '  <div class=\"input-group\">'\n               + '    <?php echo functions::form_draw_file_field('new_images[]'); ?>'\n               + '    <div class=\"input-group-text\">'\n               + '      <a class=\"move-up\" href=\"#\" title=\"<?php echo language::translate('text_move_up', 'Move up'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-up fa-lg', 'style=\"color: #3399cc;\"'); ?></a>'\n               + '      <a class=\"move-down\" href=\"#\" title=\"<?php echo language::translate('text_move_down', 'Move down'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-down fa-lg', 'style=\"color: #3399cc;\"'); ?></a>'\n               + '      <a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"'); ?></a>'\n               + '    </div>'\n               + '  </div>'\n               + '</div>';\n    $('#images .new-images').append(output);\n    refreshMainImage();\n  });\n\n  $('#images').on('change', 'input[type=\"file\"]', function(e) {\n    var img = $(this).closest('.form-group').find('img');\n\n    var oFReader = new FileReader();\n    oFReader.readAsDataURL(this.files[0]);\n    oFReader.onload = function(e){\n      $(img).attr('src', e.target.result);\n    };\n    oFReader.onloadend = function(e) {\n      refreshMainImage();\n    };\n  });\n\n  function refreshMainImage() {\n    if ($('#images img:first').length) {\n      $('#tab-general .main-image').attr('src', $('#images img:first').attr('src'));\n      return;\n    }\n\n    $('#tab-general .main-image').attr('src', '<?php echo document::href_link(WS_DIR_APP . functions::image_thumbnail(FS_DIR_APP . 'images/no_image.png', $product_image_width, $product_image_height, settings::get('product_image_clipping'))); ?>');\n  }\n\n// Technical Data\n\n  $('a.technical-data-hint').click(function(e){\n    e.preventDefault();\n    alert('Syntax:\\n\\nTitle1\\nProperty1: Value1\\nProperty2: Value2\\n\\nTitle2\\nProperty3: Value3...');\n  });\n\n// Attributes\n\n  $('select[name=\"new_attribute[group_id]\"]').change(function(){\n    $('body').css('cursor', 'wait');\n    $.ajax({\n      url: '<?php echo document::link(WS_DIR_ADMIN, ['doc' => 'attribute_values.json'], ['app']); ?>&group_id=' + $(this).val(),\n      type: 'get',\n      cache: true,\n      async: true,\n      dataType: 'json',\n      error: function(jqXHR, textStatus, errorThrown) {\n        alert(jqXHR.readyState + '\\n' + textStatus + '\\n' + errorThrown.message);\n      },\n      success: function(data) {\n        $('select[name=\"new_attribute[value_id]\"').html('');\n        if ($('select[name=\"new_attribute[value_id]\"').attr('disabled')) $('select[name=\"attribute[value_id]\"]').prop('disabled', false);\n        if (data) {\n          $('select[name=\"new_attribute[value_id]\"').append('<option value=\"0\">-- <?php echo language::translate('title_select', 'Select'); ?> --</option>');\n          $.each(data, function(i, zone) {\n            $('select[name=\"new_attribute[value_id]\"').append('<option value=\"'+ zone.id +'\">'+ zone.name +'</option>');\n          });\n        } else {\n          $('select[name=\"new_attribute[value_id]\"').prop('disabled', true);\n        }\n      },\n      complete: function() {\n        $('body').css('cursor', 'auto');\n      }\n    });\n  });\n\n  var new_attribute_i = 0;\n  $('#tab-attributes button[name=\"add\"]').click(function(){\n\n    if ($('select[name=\"new_attribute[group_id]\"]').val() == '') {\n      alert(\"<?php echo language::translate('error_must_select_attribute_group', 'You must select an attribute group'); ?>\");\n      return;\n    }\n\n    if ($('select[name=\"new_attribute[value_id]\"]').val() == '' || $('select[name=\"new_attribute[value_id]\"]').val() == '0') {\n      if ($('input[name=\"new_attribute[custom_value]\"]').val() == '') {\n        alert(\"<?php echo language::translate('error_must_select_attribute_value', 'You must select an attribute value'); ?>\");\n        return;\n      }\n    } else {\n      if ($('input[name=\"new_attribute[custom_value]\"]').val() != '') {\n        alert(\"<?php echo language::translate('error_cannot_define_both_value_and_custom_value', 'You can not define both a value and a custom value'); ?>\");\n        return;\n      }\n    }\n\n    var output = '<tr>'\n               + '  <?php echo functions::escape_js(functions::form_draw_hidden_field('attributes[new_attribute_i][id]', '')); ?>'\n               + '  <?php echo functions::escape_js(functions::form_draw_hidden_field('attributes[new_attribute_i][group_id]', 'new_group_id')); ?>'\n               + '  <?php echo functions::escape_js(functions::form_draw_hidden_field('attributes[new_attribute_i][group_name]', 'new_group_name')); ?>'\n               + '  <?php echo functions::escape_js(functions::form_draw_hidden_field('attributes[new_attribute_i][value_id]', 'new_value_id')); ?>'\n               + '  <?php echo functions::escape_js(functions::form_draw_hidden_field('attributes[new_attribute_i][value_name]', 'new_value_name')); ?>'\n               + '  <?php echo functions::escape_js(functions::form_draw_hidden_field('attributes[new_attribute_i][custom_value]', 'new_custom_value')); ?>'\n               + '  <td>new_group_name</td>'\n               + '  <td>new_value_name</td>'\n               + '  <td>new_custom_value</td>'\n               + '  <td class=\"text-end\"><a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"'); ?></a></td>'\n               + '</tr>';\n\n    while ($('input[name=\"attributes[new_'+new_attribute_i+']\"]').length) new_attribute_i++;\n    output = output.replace(/new_attribute_i/g, 'new_' + new_attribute_i);\n    output = output.replace(/new_group_id/g, $('select[name=\"new_attribute[group_id]\"] option:selected').val());\n    output = output.replace(/new_group_name/g, $('select[name=\"new_attribute[group_id]\"] option:selected').text());\n    output = output.replace(/new_value_id/g, $('select[name=\"new_attribute[value_id]\"] option:selected').val());\n    if ($('select[name=\"new_attribute[value_id]\"] option:selected').val() != '0') {\n      output = output.replace(/new_value_name/g, $('select[name=\"new_attribute[value_id]\"] option:selected').text());\n    } else {\n      output = output.replace(/new_value_name/g, '');\n    }\n    output = output.replace(/new_custom_value/g, $('input[name=\"new_attribute[custom_value]\"]').val());\n    new_attribute_i++;\n\n    $('#tab-attributes tbody').append(output);\n  });\n\n  $('#tab-attributes tbody').on('click', '.remove', function(e) {\n    e.preventDefault();\n    $(this).closest('tr').remove();\n  });\n\n// Prices\n\n  function get_tax_rate() {\n    switch ($('select[name=tax_class_id]').val()) {\n<?php\n  $tax_classes_query = database::query(\n    \"select * from \". DB_TABLE_PREFIX .\"tax_classes\n    order by name asc;\"\n  );\n  while ($tax_class = database::fetch($tax_classes_query)) {\n    echo '      case \"'. $tax_class['id'] . '\": return '. tax::get_tax(100, $tax_class['id'], 'store') .';';\n  }\n?>\n      default: return 0;\n    }\n  }\n\n  function get_currency_value(currency_code) {\n    switch (currency_code) { <?php foreach (currency::$currencies as $currency) echo 'case \\''. $currency['code'] .'\\': return '. (float)$currency['value'] .'; '; ?> }\n  }\n\n  function get_currency_decimals(currency_code) {\n    switch (currency_code) { <?php foreach (currency::$currencies as $currency) echo 'case \\''. $currency['code'] .'\\': return '. ($currency['decimals']+2) .'; '; ?> }\n  }\n\n// Update prices\n  $('select[name=\"tax_class_id\"]').on('change', function(){\n    $('input[name^=\"prices\"]').trigger('change');\n  });\n\n// Update gross price\n  $('input[name^=\"prices\"]').on('input', function() {\n    var currency_code = $(this).attr('name').match(/^prices\\[([A-Z]{3})\\]$/)[1],\n        decimals = get_currency_decimals(currency_code),\n        gross_field = $('input[name=\"gross_prices['+ currency_code +']\"]');\n\n    var gross_price = Number( parseFloat($(this).val() || 0) * (1 + (get_tax_rate()/100)) ).toFixed(decimals);\n\n    if ($(this).val() == 0) {\n      $(gross_field).val('');\n    } else {\n      $(gross_field).val(gross_price);\n    }\n\n    update_currency_prices();\n  }).trigger('input');\n\n// Update net price\n  $('input[name^=\"gross_prices\"]').on('input', function() {\n    var currency_code = $(this).attr('name').match(/^gross_prices\\[([A-Z]{3})\\]$/)[1],\n        decimals = get_currency_decimals(currency_code),\n        net_field = $('input[name=\"prices['+ currency_code +']\"]');\n\n    var net_price = Number( parseFloat($(this).val() || 0) / (1 + (get_tax_rate()/100)) ).toFixed(decimals);\n\n    if ($(this).val() == 0) {\n      $(net_field).val('');\n    } else {\n      $(net_field).val(net_price);\n    }\n\n    update_currency_prices();\n  });\n\n// Update price placeholders\n  function update_currency_prices() {\n    var store_currency_code = '<?php echo settings::get('store_currency_code'); ?>',\n        currencies = ['<?php echo implode(\"','\", array_keys(currency::$currencies)); ?>'],\n        net_price = $('input[name^=\"prices\"][name$=\"[<?php echo settings::get('store_currency_code'); ?>]\"]').val(),\n        gross_price = $('input[name^=\"gross_prices\"][name$=\"[<?php echo settings::get('store_currency_code'); ?>]\"]').val();\n\n    if (!net_price) net_price = $('input[name^=\"prices\"][name$=\"[<?php echo settings::get('store_currency_code'); ?>]\"]').attr('placeholder');\n    if (!gross_price) gross_price = $('input[name^=\"gross_prices\"][name$=\"[<?php echo settings::get('store_currency_code'); ?>]\"]').attr('placeholder');\n\n    $.each(currencies, function(i,currency_code){\n      if (currency_code == '<?php echo settings::get('store_currency_code'); ?>') return;\n\n      var currency_decimals = get_currency_decimals(currency_code),\n          currency_net_price = net_price / get_currency_value(currency_code);\n          currency_gross_price = gross_price / get_currency_value(currency_code);\n\n      currency_net_price = currency_net_price ? parseFloat(currency_net_price.toFixed(currency_decimals) || 0) : '';\n      currency_gross_price = currency_gross_price ? parseFloat(currency_gross_price.toFixed(currency_decimals) || 0) : '';\n\n      $('input[name=\"prices['+ currency_code +']\"]').attr('placeholder', currency_net_price);\n      $('input[name=\"gross_prices['+ currency_code +']\"]').attr('placeholder', currency_gross_price);\n    });\n  }\n\n  $('#price-incl-tax-tooltip').click(function(e) {\n    e.preventDefault;\n    alert('<?php echo str_replace([\"\\r\", \"\\n\", \"'\"], [\"\", \"\", \"\\\\'\"], language::translate('tooltip_field_price_incl_tax', 'This field helps you calculate gross price based on the store region tax. All prices input to database are always excluding tax.')); ?>');\n  });\n\n// Campaigns\n\n  $('#table-campaigns').on('input', 'input[name^=\"campaigns\"][name$=\"[percentage]\"]', function() {\n    var parent = $(this).closest('tr');\n\n    <?php foreach (currency::$currencies as $currency) { ?>\n    if ($('input[name^=\"prices\"][name$=\"[<?php echo $currency['code']; ?>]\"]').val() > 0) {\n      var value = Number($('input[name=\"prices[<?php echo $currency['code']; ?>]\"]').val() * (100 - $(this).val()) / 100).toFixed(<?php echo $currency['decimals']; ?>);\n      $(parent).find('input[name$=\"[<?php echo $currency['code']; ?>]\"]').val(value);\n    } else {\n      $(parent).find('input[name$=\"[<?php echo $currency['code']; ?>]\"]').val(\"\");\n    }\n    <?php } ?>\n\n    <?php foreach (currency::$currencies as $currency) { ?>\n    var value = Number($(parent).find('input[name^=\"campaigns\"][name$=\"[<?php echo settings::get('store_currency_code'); ?>]\"]').val() / <?php echo $currency['value']; ?>).toFixed(<?php echo $currency['decimals']; ?>);\n    $(parent).find('input[name^=\"campaigns\"][name$=\"[<?php echo $currency['code']; ?>]\"]').attr('placeholder', value);\n    <?php } ?>\n  });\n\n  $('#table-campaigns').on('input', 'input[name^=\"campaigns\"][name$=\"[<?php echo settings::get('store_currency_code'); ?>]\"]', function() {\n    var parent = $(this).closest('tr');\n    var percentage = ($('input[name=\"prices[<?php echo settings::get('store_currency_code'); ?>]\"]').val() - $(this).val()) / $('input[name=\"prices[<?php echo settings::get('store_currency_code'); ?>]\"]').val() * 100;\n    percentage = percentage.toFixed(2);\n    $(parent).find('input[name$=\"[percentage]\"]').val(percentage);\n\n    <?php foreach (currency::$currencies as $currency) { ?>\n    var value = 0;\n    value = $(parent).find('input[name^=\"campaigns\"][name$=\"[<?php echo settings::get('store_currency_code'); ?>]\"]').val() / <?php echo $currency['value']; ?>;\n    value = value.toFixed(<?php echo $currency['decimals']; ?>);\n    $(parent).find('input[name^=\"campaigns\"][name$=\"[<?php echo $currency['code']; ?>]\"]').attr(\"placeholder\", value);\n    if ($(parent).find('input[name^=\"campaigns\"][name$=\"[<?php echo $currency['code']; ?>]\"]').val() == 0) {\n      $(parent).find('input[name^=\"campaigns\"][name$=\"[<?php echo $currency['code']; ?>]\"]').val('');\n    }\n    <?php } ?>\n  });\n  $('input[name^=\"campaigns\"][name$=\"[<?php echo settings::get('store_currency_code'); ?>]\"]').trigger('input');\n\n  $('#table-campaigns').on('click', '.remove', function(e) {\n    e.preventDefault();\n    $(this).closest('tr').remove();\n  });\n\n  var new_campaign_i = 1;\n  $('#table-campaigns').on('click', '.add', function(e) {\n    e.preventDefault();\n    var output = '<tr>'\n               + '  <td><?php echo functions::escape_js(language::translate('title_start_date', 'Start Date')); ?><br />'\n               + '    <?php echo functions::escape_js(functions::form_draw_hidden_field('campaigns[new_campaign_i][id]', '') . functions::form_draw_datetime_field('campaigns[new_campaign_i][start_date]', '')); ?>'\n               + '  </td>'\n               + '  <td><?php echo functions::escape_js(language::translate('title_end_date', 'End Date')); ?><br />'\n               + '    <?php echo functions::escape_js(functions::form_draw_datetime_field('campaigns[new_campaign_i][end_date]', '')); ?>'\n               + '  </td>'\n               + '  <td>- %<br />'\n               + '    <?php echo functions::escape_js(functions::form_draw_decimal_field('campaigns[new_campaign_i][percentage]', '', 2, 0, null)); ?>'\n               + '  </td>'\n               + '  <td><?php echo functions::escape_js(settings::get('store_currency_code')); ?><br />'\n               + '    <?php echo functions::escape_js(functions::form_draw_currency_field(settings::get('store_currency_code'), 'campaigns[new_campaign_i]['. settings::get('store_currency_code') .']', '')); ?>'\n               + '  </td>'\n<?php\n  foreach (array_keys(currency::$currencies) as $currency_code) {\n    if ($currency_code == settings::get('store_currency_code')) continue;\n?>\n               + '  <td><?php echo functions::escape_js($currency_code); ?><br />'\n               + '    <?php echo functions::escape_js(functions::form_draw_currency_field($currency_code, 'campaigns[new_campaign_i]['. $currency_code .']', '')); ?>'\n               + '  </td>'\n<?php\n  }\n?>\n               + '  <td><br /><a class=\"remove\" href=\"#\" title=\"<?php echo functions::escape_js(language::translate('title_remove', 'Remove'), true); ?>\"><?php echo functions::escape_js(functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"')); ?></a></td>'\n               + '</tr>';\n    while ($('input[name=\"campaigns[new_'+new_campaign_i+']\"]').length) new_campaign_i++;\n    output = output.replace(/new_campaign_i/g, 'new_' + new_campaign_i);\n    $('#table-campaigns tbody').append(output);\n    new_campaign_i++;\n  });\n\n// Options\n\n  $('#tab-options').on('click', '.remove-group', function(e) {\n    e.preventDefault();\n    $(this).closest('li').remove();\n  });\n\n  $('#tab-options').on('click', '.move-group-up, .move-group-down', function(e) {\n    e.preventDefault();\n    var row = $(this).closest('li');\n    if ($(this).is('.move-group-up') && $(row).prevAll().length > 0) {\n      $(row).insertBefore($(row).prev());\n    } else if ($(this).is('.move-group-down') && $(row).nextAll().length > 0) {\n      $(row).insertAfter($(row).next());\n    }\n  });\n\n  $('#tab-options').on('click', '.remove', function(e) {\n    e.preventDefault();\n    $(this).closest('tr').remove();\n  });\n\n  $('#tab-options').on('click', '.move-up, .move-down', function(e) {\n    e.preventDefault();\n    var row = $(this).closest('tr');\n    if ($(this).is('.move-up') && $(row).prevAll().length > 0) {\n      $(row).insertBefore($(row).prev());\n    } else if ($(this).is('.move-down') && $(row).nextAll().length > 0) {\n      $(row).insertAfter($(row).next());\n    }\n  });\n\n  $('body').on('change', '.featherlight select[name=\"new_predefined_option[group_id]\"]', function(){\n    $('body').css('cursor', 'wait');\n    $.ajax({\n      url: '<?php echo document::link(null, ['doc' => 'attribute_values.json'], ['app']); ?>&group_id=' + $(this).val(),\n      type: 'get',\n      cache: true,\n      async: true,\n      dataType: 'json',\n      error: function(jqXHR, textStatus, errorThrown) {\n        alert(jqXHR.readyState + '\\n' + textStatus + '\\n' + errorThrown.message);\n      },\n      success: function(data) {\n        $('select[name=\"new_predefined_option[value_id]\"').html('');\n        if ($('select[name=\"new_predefined_option[value_id]\"').attr('disabled')) $('select[name=\"new_predefined_option[value_id]\"]').prop('disabled', false);\n        if (data) {\n          $('select[name=\"new_predefined_option[value_id]\"').append('<option value=\"0\">-- <?php echo language::translate('title_select', 'Select'); ?> --</option>');\n          $.each(data, function(i, zone) {\n            $('select[name=\"new_predefined_option[value_id]\"').append('<option value=\"'+ zone.id +'\">'+ zone.name +'</option>');\n          });\n        } else {\n          $('select[name=\"new_predefined_option[value_id]\"').prop('disabled', true);\n        }\n      },\n      complete: function() {\n        $('body').css('cursor', 'auto');\n      }\n    });\n  });\n\n  $('body').on('change', '.featherlight select[name=\"new_user_input_option[group_id]\"]', function(){\n    $('body').css('cursor', 'wait');\n    $.ajax({\n      url: '<?php echo document::link(null, ['doc' => 'attribute_values.json'], ['app']); ?>&group_id=' + $(this).val(),\n      type: 'get',\n      cache: true,\n      async: true,\n      dataType: 'json',\n      error: function(jqXHR, textStatus, errorThrown) {\n        alert(jqXHR.readyState + '\\n' + textStatus + '\\n' + errorThrown.message);\n      },\n      success: function(data) {\n        $('select[name=\"new_user_input_option[value_id]\"').html('');\n        if ($('select[name=\"new_user_input_option[value_id]\"').attr('disabled')) $('select[name=\"new_user_input_option[value_id]\"]').prop('disabled', false);\n        if (data) {\n          $('select[name=\"new_user_input_option[value_id]\"').append('<option value=\"0\">-- <?php echo language::translate('title_select', 'Select'); ?> --</option>');\n          $.each(data, function(i, zone) {\n            $('select[name=\"new_user_input_option[value_id]\"').append('<option value=\"'+ zone.id +'\">'+ zone.name +'</option>');\n          });\n        } else {\n          $('select[name=\"new_user_input_option[value_id]\"').prop('disabled', true);\n        }\n      },\n      complete: function() {\n        $('body').css('cursor', 'auto');\n      }\n    });\n  });\n\n  $('body').on('change', '.featherlight select[name=\"new_predefined_option[value_id]\"]', function(){\n    $('input[name=\"new_predefined_option[custom_value]\"').val('');\n  });\n\n  $('body').on('keydown', '.featherlight input[name=\"new_predefined_option[custom_value]\"]', function(){\n    $('select[name=\"new_predefined_option[value_id]\"').val('0');\n  });\n\n  var new_option_group_i = 1;\n  var new_option_value_i = 1;\n  $('body').on('click', '.featherlight button[name=\"add_predefined_option\"]', function(e) {\n    e.preventDefault();\n\n    var groupElement = $(this).closest('fieldset').find('select[name=\"new_predefined_option[group_id]\"]');\n    var valueElement = $(this).closest('fieldset').find('select[name=\"new_predefined_option[value_id]\"]');\n    var customValueElement = $(this).closest('fieldset').find('input[name=\"new_predefined_option[custom_value]\"]');\n\n    if ($(groupElement).val() == '') {\n      alert(\"<?php echo language::translate('error_must_select_attribute_group', 'You must select an attribute group'); ?>\");\n      return;\n    }\n    if ($(valueElement).val() == '' || $(valueElement).val() == '0') {\n      if ($(customValueElement).val() == '') {\n        alert(\"<?php echo language::translate('error_must_select_attribute_value', 'You must select an attribute value'); ?>\");\n        return;\n      }\n    } else {\n      if ($(customValueElement).val() != '') {\n        console.log($(valueElement).val(), $(customValueElement).val());\n        alert(\"<?php echo language::translate('error_cannot_define_both_value_and_custom_value', 'You can not define both a value and a custom value'); ?>\");\n        return;\n      }\n    }\n\n    if ($('#tab-options :input[name^=\"options\"][name$=\"[group_id]\"][value=\"'+ $(groupElement).val() +'\"]').closest('li').find('input[name$=\"[value_id]\"][value=\"'+ $(valueElement).val() +'\"]').length) {\n      if ($(customValueElement).val() != '') {\n        if ($('#tab-options :input[name^=\"options\"][name$=\"[group_id]\"][value=\"'+ $(groupElement).val() +'\"]').closest('li').find('input[name$=\"[custom_value]\"][value=\"'+ escape($(customValueElement).val()) +'\"]').length) {\n          alert(\"<?php echo language::translate('error_option_already_defined', 'This option is already defined'); ?>\");\n          return;\n        }\n\n      } else {\n        if ($('#tab-options :input[name^=\"options\"][name$=\"[group_id]\"][value=\"'+ $(groupElement).val() +'\"]').closest('li').find('input[name$=\"[value_id]\"][value=\"'+ $(valueElement).val() +'\"]').closest('tr').find('input[name$=\"[custom_value]\"]').val() == $(customValueElement).val()) {\n          alert(\"<?php echo language::translate('error_option_already_defined', 'This option is already defined'); ?>\");\n          return;\n        }\n      }\n    }\n\n    if (!$('#tab-options input[name^=\"options\"][name$=\"[group_id]\"][value=\"'+ $(groupElement).val() +'\"]').length) {\n      var output = '<li data-group-id=\"'+ escapeHTML($(groupElement).val()) +'\" data-group-name=\"'+ escapeHTML($(groupElement).find('option:selected').text()) +'\">'\n                 + '  <div class=\"float-end\">'\n                 + '    <a class=\"move-group-up\" href=\"#\" title=\"<?php echo language::translate('text_move_up', 'Move up'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-up fa-2x', 'style=\"color: #3399cc;\"'); ?></a>'\n                 + '    <a class=\"move-group-down\" href=\"#\" title=\"<?php echo language::translate('text_move_down', 'Move down'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-down fa-2x', 'style=\"color: #3399cc;\"'); ?></a>'\n                 + '    <a class=\"remove-group\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-2x', 'style=\"color: #cc3333;\"'); ?></a>'\n                 + '  </div>'\n                 + '  <h2>'+ $(this).closest('fieldset').find('select[name=\"new_predefined_option[group_id]\"] option:selected').text() +'</h2>'\n                 + '  <?php echo functions::escape_js(functions::form_draw_hidden_field('options[new_group_id][group_id]', 'new_group_id')); ?>'\n                 + '  <div class=\"row\">'\n                 + '    <div class=\"form-group col-sm-4 col-md-2\">'\n                 + '      <label><?php echo functions::escape_js(language::translate('title_function', 'Function')); ?></label>'\n                 + '      <?php echo functions::escape_js(functions::form_draw_select_field('options[new_group_id][function]', ['select', 'radio', 'checkbox'], 'select')); ?>'\n                 + '    </div>'\n                 + '    <div class=\"form-group col-sm-4 col-md-2\">'\n                 + '      <label><?php echo functions::escape_js(language::translate('title_sort_values', 'Sort Values')); ?></label>'\n                 + '      <?php echo functions::escape_js(functions::form_draw_select_field('options[new_group_id][sort]', $option_sort_options, 'custom')); ?>'\n                 + '    </div>'\n                 + '    <div class=\"form-group col-sm-4 col-md-2\">'\n                 + '      <label><?php echo functions::escape_js(language::translate('title_required', 'Required')); ?></label>'\n                 + '      <div class=\"checkbox\">'\n                 + '        <label><?php echo functions::form_draw_checkbox('options[new_group_id][required]', '1', true); ?> <?php echo language::translate('title_required', 'Required'); ?></label>'\n                 + '      </div>'\n                 + '    </div>'\n                 + '  </div>'\n                 + '  <div class=\"table-responsive\">'\n                 + '    <table id=\"table-options\" class=\"table table-striped table-hover table-dragable data-table\">'\n                 + '      <thead>'\n                 + '        <tr>'\n                 + '          <th><?php echo functions::escape_js(language::translate('title_option', 'Option')); ?></th>'\n                 + '          <th style=\"width: 150px;\"><?php echo language::translate('title_price_operator', 'Price Operator'); ?></th>'\n                 + '          <th colspan=\"<?php echo count(currency::$currencies); ?>\"><?php echo language::translate('title_price_adjustment', 'Price Adjustment'); ?></th>'\n                 + '          <th style=\"width: 85px;\">&nbsp;</th>'\n                 + '        </tr>'\n                 + '      </thead>'\n                 + '      <tbody>'\n                 + '      </tbody>'\n                 + '    </table>'\n                 + '  </div>'\n                 + '</li>';\n\n      output = output.replace(/new_option_group_i/g, 'new_' + new_option_group_i);\n      output = output.replace(/new_group_id/g, $(groupElement).val());\n      output = output.replace(/new_group_name/g, $(groupElement).find('option:selected').text());\n      $('#tab-options ul').append(output);\n      new_option_group_i++;\n    }\n\n    var output = '<tr data-value-id=\"'+ escapeHTML($(valueElement).val()) +'\" data-value-name=\"'+ escapeHTML(($(valueElement).val() != 0) ? $(valueElement).find('option:selected').text() : $(customValueElement).val()) +'\">'\n               + '  <td class=\"grabable\"><?php echo functions::escape_js(functions::form_draw_hidden_field('options[new_group_id][values][new_option_value_i][value_id]', 'new_value_id')) . functions::form_draw_hidden_field('options[new_group_id][values][new_option_value_i][custom_value]', 'new_custom_value'); ?>'+ (($.inArray($(valueElement).val(), ['', '0']) !== -1) ? $(customValueElement).val() : $(valueElement).find('option:selected').text()) +'</td>'\n               + '  <td style=\"text-align: center;\"><?php echo functions::escape_js(functions::form_draw_select_field('options[new_group_id][values][new_option_value_i][price_operator]', ['+','%','*','='], true)); ?></td>'\n               + '  <?php foreach (array_keys(currency::$currencies) as $currency_code) echo '<td style=\"width: 200px;\">'. functions::escape_js(functions::form_draw_currency_field($currency_code, 'options[new_group_id][values][new_option_value_i]['. $currency_code. ']', '')) .'</td>'; ?>'\n               + '  <td class=\"text-end\"><a class=\"move-up\" href=\"#\" title=\"<?php echo language::translate('text_move_up', 'Move up'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-up fa-lg', 'style=\"color: #3399cc;\"'); ?></a> <a class=\"move-down\" href=\"#\" title=\"<?php echo language::translate('text_move_down', 'Move down'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-down fa-lg', 'style=\"color: #3399cc;\"'); ?></a> <a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"'); ?></a></td>'\n               + '</tr>';\n\n    output = output.replace(/new_option_value_i/g, 'new_' + new_option_value_i);\n    output = output.replace(/new_group_id/g, $(groupElement).val());\n    output = output.replace(/new_value_id/g, $(valueElement).val());\n    output = output.replace(/new_custom_value/g, $(customValueElement).val().replace(/\"/, '&quot;'));\n    $(':input[name^=\"options\"][name$=\"[group_id]\"][value=\"'+ $(groupElement).val() +'\"]').closest('li').find('tbody').append(output);\n    new_option_value_i++;\n\n    $.featherlight.close();\n  });\n\n  $('body').on('click', '.featherlight button[name=\"add_user_input_option\"]', function(e) {\n    e.preventDefault();\n\n    var groupElement = $(this).closest('fieldset').find('select[name=\"new_user_input_option[group_id]\"]');\n\n    if ($(groupElement).val() == '') {\n      alert(\"<?php echo language::translate('error_must_select_attribute_group', 'You must select an attribute group'); ?>\");\n      return;\n    }\n\n    if ($('#tab-options :input[name^=\"options\"][name$=\"[group_id]\"][value=\"'+ $(groupElement).val() +'\"]').length) {\n      alert(\"<?php echo language::translate('error_group_already_defined', 'This group is already defined'); ?>\");\n      return;\n    }\n\n    var output = '<li>'\n               + '  <div class=\"float-end\">'\n               + '    <a class=\"move-group-up\" href=\"#\" title=\"<?php echo language::translate('text_move_up', 'Move up'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-up fa-2x', 'style=\"color: #3399cc;\"'); ?></a>'\n               + '    <a class=\"move-group-down\" href=\"#\" title=\"<?php echo language::translate('text_move_down', 'Move down'); ?>\"><?php echo functions::draw_fonticon('fa-arrow-circle-down fa-2x', 'style=\"color: #3399cc;\"'); ?></a>'\n               + '    <a class=\"remove-group\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-2x', 'style=\"color: #cc3333;\"'); ?></a>'\n               + '  </div>'\n               + '  <h2>'+ $(this).closest('fieldset').find('select[name=\"new_user_input_option[group_id]\"] option:selected').text() +'</h2>'\n               + '  <?php echo functions::escape_js(functions::form_draw_hidden_field('options[new_group_id][group_id]', 'new_group_id')); ?>'\n               + '  <div class=\"row\">'\n               + '    <div class=\"form-group col-sm-4 col-md-2\">'\n               + '      <label><?php echo language::translate('title_function', 'Function'); ?></label>'\n               + '      <?php echo functions::escape_js(functions::form_draw_select_field('options[new_group_id][function]', ['text', 'textarea'], 'text')); ?>'\n               + '    </div>'\n               + '    <div class=\"form-group col-sm-4 col-md-2\">'\n               + '      <label><?php echo language::translate('title_required', 'Required'); ?></label>'\n               + '      <div class=\"checkbox\">'\n               + '        <label><?php echo functions::form_draw_checkbox('options[new_group_id][required]', '1', true); ?> <?php echo language::translate('title_required', 'Required'); ?></label>'\n               + '      </div>'\n               + '    </div>'\n               + '  </div>'\n               + '</li>';\n\n    output = output.replace(/new_group_id/g, $(groupElement).val());\n    output = output.replace(/new_group_name/g, $(groupElement).find('option:selected').text());\n    $('#tab-options ul').append(output);\n\n    $.featherlight.close();\n  });\n\n// Quantity Unit\n\n  $('select[name=\"quantity_unit_id\"]').change(function(){\n    if ($('option:selected', this).data('decimals') === undefined) return;\n\n    var decimals = $('option:selected', this).data('decimals');\n\n    var value = parseFloat($('input[name=\"quantity\"]').val() || 0).toFixed(decimals);\n    $('input[name=\"quantity\"]').val(value);\n\n    $('input[name^=\"option_stock\"][name$=\"[quantity]\"]').each(function(){\n      var value = parseFloat($(this).val() || 0).toFixed(decimals);\n      $(this).val(value);\n    });\n\n    $('input[name^=\"option_stock\"][name$=\"[quantity_adjustment]\"]').each(function(){\n      var value = parseFloat($(this).val() || 0).toFixed(decimals);\n      $(this).val(value);\n    });\n  }).trigger('change');\n\n// Stock\n\n  $('#table-stock').on('input', 'input[name=\"quantity\"]', function(){\n    $('input[name=\"quantity_adjustment\"]').val( parseFloat($(this).val() || 0) - parseFloat($(this).data('quantity') || 0) );\n  });\n\n  $('#table-stock').on('input', 'input[name=\"quantity_adjustment\"]', function(){\n    $('input[name=\"quantity\"]').val( parseFloat($('input[name=\"quantity\"]').data('quantity') || 0) + parseFloat($(this).val() || 0) );\n  });\n\n  $('#table-stock').on('input', 'input[name$=\"[quantity]\"]', function(){\n    var adjustment_field = $(this).closest('tr').find('input[name$=\"[quantity_adjustment]\"]');\n    $(adjustment_field).val( parseFloat($(this).val() || 0) - parseFloat($(this).data('quantity') || 0) );\n\n    $('input[name=\"quantity\"]').val(0);\n    $(this).closest('tbody').find('input[name$=\"[quantity]\"]').each(function() {\n      $('input[name=\"quantity\"]').val( parseFloat($('input[name=\"quantity\"]').val() || 0) + parseFloat($(this).val() || 0) );\n    });\n\n    $('input[name=\"quantity_adjustment\"]').val(0);\n    $(this).closest('tbody').find('input[name$=\"[quantity_adjustment]\"]').each(function() {\n      $('input[name=\"quantity_adjustment\"]').val( parseFloat($('input[name=\"quantity_adjustment\"]').val() || 0) + parseFloat($(this).val() || 0) );\n    });\n  });\n\n  $('#table-stock').on('input', 'input[name$=\"[quantity_adjustment]\"]', function(){\n    var qty_field = $(this).closest('tr').find('input[name$=\"[quantity]\"]');\n    $(qty_field).val( parseFloat($(qty_field).data('quantity') || 0) + parseFloat($(this).val() || 0) );\n\n    $('input[name=\"quantity\"]').val(0);\n    $(this).closest('tbody').find('input[name$=\"[quantity]\"]').each(function() {\n      $('input[name=\"quantity\"]').val( parseFloat($('input[name=\"quantity\"]').val() || 0) + parseFloat($(this).val() || 0) );\n    });\n\n    $('input[name=\"quantity_adjustment\"]').val(0);\n    $(this).closest('tbody').find('input[name$=\"[quantity_adjustment]\"]').each(function() {\n      $('input[name=\"quantity_adjustment\"]').val( parseFloat($('input[name=\"quantity_adjustment\"]').val() || 0) + parseFloat($(this).val() || 0) );\n    });\n  });\n\n  $('#table-stock').on('click', '.remove', function(e) {\n    e.preventDefault();\n    $(this).closest('tr').remove();\n\n    var total = 0;\n    $(this).closest('tbody').find('input[name$=\"[quantity]\"]').each(function() {\n      total += parseFloat($(this).val() || 0);\n    });\n\n    if (!$('input[name^=\"options_stock\"][name$=\"[id]\"]').length) {\n\n      $('input[name=\"quantity\"]').prop('readonly', false);\n      $('input[name=\"quantity_adjustment\"]').prop('readonly', false);\n      $('input[name=\"quantity\"]').val('');\n      $('input[name=\"quantity_adjustment\"]').val('');\n\n    } else {\n\n      $('input[name=\"quantity\"]').val(0);\n      $('input[name^=\"options_stock\"][name$=\"[quantity]\"]').each(function() {\n        $('input[name=\"quantity\"]').val( parseFloat($('input[name=\"quantity\"]').val() || 0) + parseFloat($(this).val() || 0) );\n      });\n\n      $('input[name=\"quantity_adjustment\"]').val(0);\n      $('input[name^=\"options_stock\"][name$=\"[quantity_adjustment]\"]').each(function() {\n        $('input[name=\"quantity_adjustment\"]').val( parseFloat($('input[name=\"quantity_adjustment\"]').val() || 0) + parseFloat($(this).val() || 0) );\n      });\n    }\n  });\n\n  $('#table-stock').on('click', '.move-up, .move-down', function(e) {\n    e.preventDefault();\n    var row = $(this).closest('tr');\n\n    if ($(this).is('.move-up') && $(row).prevAll().length > 1) {\n      $(row).insertBefore($(row).prev());\n    } else if ($(this).is('.move-down') && $(row).nextAll().length > 0) {\n      $(row).insertAfter($(row).next());\n    }\n  });\n\n// New Stock Option (Modal)\n\n  $('#table-stock').on('click', '.add', function(e) {\n    e.preventDefault();\n\n    var output = '';\n\n    $('#options li').each(function(i, group) {\n      var group_id = $(this).data('group-id'),\n        group_name = $(this).data('group-name');\n\n      $(group).find('.data-table tbody tr').each(function(j, row) {\n        var value_id = $(row).data('value-id'),\n          value_name = $(row).data('value-name'),\n          combination = group_id + '-' + ((value_id != 0) ? value_id : '0:\"' + value_name +'\"');\n\n        output += '<tr data-group-id=\"'+ escapeHTML(group_id) +'\" data-group-name=\"'+ escapeHTML(group_name) +'\" data-value-id=\"'+ escapeHTML(value_id) +'\" data-value-name=\"'+ escapeHTML(value_name) +'\">'\n                + '  <td><span class=\"form-check\"><input type=\"checkbox\" name=\"combination[]\" value=\"'+ escapeHTML(combination) +'\" /></span></td>'\n                + '  <td>'+ group_name +'</td>'\n                + '  <td>'+ value_name +'</td>'\n                + '</tr>';\n      });\n    });\n\n    $('#new-stock-option table tbody').html(output);\n    $.featherlight('#new-stock-option');\n  });\n\n  var new_option_stock_i = 1;\n  $('body').on('click', '#new-stock-option button[name=\"add_stock_option\"]', function(e) {\n    e.preventDefault();\n\n    var modal = $(this).closest('#new-stock-option'),\n      new_option_combination = '',\n      new_option_name = '',\n      use_comma = false;\n\n    $(modal).find('table tbody tr :input[name=\"combination[]\"]:checked').each(function() {\n      var row = $(this).closest('tr');\n\n      if (use_comma) {\n        new_option_combination += ',';\n        new_option_name += ', ';\n      }\n\n      new_option_combination += $(row).data('group-id') + '-' + $(row).data('value-id')\n                              + (($(row).data('value-id') == 0) ? ':\"' + $(row).data('value-name')+'\"' : '');\n\n      new_option_name += $(row).data('value-name');\n\n      use_comma = true;\n    });\n\n    if (new_option_combination == '') return;\n\n    var output = '<tr>'\n               + '  <td><?php echo functions::escape_js(functions::form_draw_hidden_field('options_stock[new_option_stock_i][id]', '') . functions::form_draw_hidden_field('options_stock[new_option_stock_i][combination]', 'new_option_combination') . functions::form_draw_hidden_field('options_stock[new_option_stock_i][name]['. language::$selected['code'] .']', 'new_option_name')); ?>new_option_name</td>'\n               + '  <td><?php echo functions::escape_js(functions::form_draw_text_field('options_stock[new_option_stock_i][sku]', '')); ?></td>'\n               + '  <td>'\n               + '    <div class=\"input-group\">'\n               + '      <?php echo functions::escape_js(functions::form_draw_decimal_field('options_stock[new_option_stock_i][weight]', '0.00', 4, 0)); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_weight_classes_list('options_stock[new_option_stock_i][weight_class]', '')); ?>'\n               + '    </div>'\n               + '  </td>'\n               + '  <td>'\n               + '    <div class=\"input-group\">'\n               + '      <?php echo functions::escape_js(functions::form_draw_decimal_field('options_stock[new_option_stock_i][dim_x]', '0.00', 4, 0)); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_decimal_field('options_stock[new_option_stock_i][dim_y]', '0.00', 4, 0)); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_decimal_field('options_stock[new_option_stock_i][dim_z]', '0.00', 4, 0)); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_length_classes_list('options_stock[new_option_stock_i][dim_class]', '')); ?>'\n               + '    </div>'\n               + '  </td>'\n               + '  <td><?php echo functions::escape_js(functions::form_draw_decimal_field('options_stock[new_option_stock_i][quantity]', '0', 2, null, null, 'data-quantity=\"0\"')); ?></td>'\n               + '  <td>'\n               + '    <div class=\"input-group\">'\n               + '      <span class=\"input-group-text\">&plusmn;</span>'\n               + '    <?php echo functions::escape_js(functions::form_draw_decimal_field('options_stock[new_option_stock_i][quantity_adjustment]', '0')); ?>'\n               + '    </div>'\n               + '  </td>'\n               + '  <td class=\"text-end\">'\n               + '    <a class=\"move-up\" href=\"#\" title=\"<?php echo functions::escape_js(language::translate('text_move_up', 'Move up'), true); ?>\"><?php echo functions::escape_js(functions::draw_fonticon('fa-arrow-circle-up fa-lg', 'style=\"color: #3399cc;\"')); ?></a>'\n               + '    <a class=\"move-down\" href=\"#\" title=\"<?php echo functions::escape_js(language::translate('text_move_down', 'Move down'), true); ?>\"><?php echo functions::escape_js(functions::draw_fonticon('fa-arrow-circle-down fa-lg', 'style=\"color: #3399cc;\"')); ?></a>'\n               + '    <a class=\"remove\" href=\"#\" title=\"<?php echo functions::escape_js(language::translate('title_remove', 'Remove'), true); ?>\"><?php echo functions::escape_js(functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"')); ?></a>'\n               + '  </td>'\n               + '</tr>';\n\n    while ($('input[name=\"options_stock[new_'+new_option_stock_i+']\"]').length) new_option_stock_i++;\n    output = output.replace(/new_option_stock_i/g, 'new_' + new_option_stock_i);\n    output = output.replace(/new_option_combination/g, escapeHTML(new_option_combination));\n    output = output.replace(/new_option_name/g, new_option_name);\n\n    $('#table-stock').find('tbody').append(output);\n    new_option_stock_i++;\n\n    $('input[name=\"quantity\"]').prop('readonly', true);\n    $('input[name=\"quantity_adjustment\"]').prop('readonly', true);\n\n    if ($('input[name^=\"options_stock\"][name$=\"[id]\"]').length == 1) {\n      $('input[name=\"quantity\"]').val('');\n      $('input[name=\"quantity_adjustment\"]').val('');\n    }\n\n    $.featherlight.close();\n  });\n</script>", "<?php\n\n  if (!empty($_GET['country_code'])) {\n    $country = new ent_country($_GET['country_code']);\n  } else {\n    $country = new ent_country();\n  }\n\n  if (empty($_POST)) {\n    $_POST = $country->data;\n  }\n\n  document::$snippets['title'][] = !empty($country->data['id']) ? language::translate('title_edit_country', 'Edit Country') : language::translate('title_add_new_country', 'Add New Country');\n\n  breadcrumbs::add(language::translate('title_countries', 'Countries'));\n  breadcrumbs::add(!empty($country->data['id']) ? language::translate('title_edit_country', 'Edit Country') : language::translate('title_add_new_country', 'Add New Country'));\n\n  if (isset($_POST['save'])) {\n\n    try {\n\n      if (empty($_POST['iso_code_1'])) throw new Exception(language::translate('error_missing_code', 'You must enter a code'));\n      if (empty($_POST['iso_code_2'])) throw new Exception(language::translate('error_missing_code', 'You must enter a code'));\n      if (empty($_POST['iso_code_3'])) throw new Exception(language::translate('error_missing_code', 'You must enter a code'));\n      if (empty($_POST['name'])) throw new Exception(language::translate('error_must_enter_name', 'You must enter a name'));\n\n      if (empty($_POST['zones'])) $_POST['zones'] = [];\n\n      foreach ($_POST['zones'] as $zone) {\n        if (empty($zone['code']) || empty($zone['name'])) throw new Exception(language::translate('error_zone_must_have_name_and_code', 'A zone/state/province must have a name and code'));\n      }\n\n      $_POST['iso_code_2'] = strtoupper($_POST['iso_code_2']);\n      $_POST['iso_code_3'] = strtoupper($_POST['iso_code_3']);\n\n      $fields = [\n        'status',\n        'iso_code_1',\n        'iso_code_2',\n        'iso_code_3',\n        'name',\n        'domestic_name',\n        'tax_id_format',\n        'address_format',\n        'postcode_format',\n        'language_code',\n        'currency_code',\n        'phone_code',\n        'zones',\n      ];\n\n      foreach ($fields as $field) {\n        if (isset($_POST[$field])) $country->data[$field] = $_POST[$field];\n      }\n\n      $country->save();\n\n      notices::add('success', language::translate('success_changes_saved', 'Changes saved'));\n      header('Location: '. document::link(WS_DIR_ADMIN, ['doc' => 'countries'], true, ['country_id']));\n      exit;\n\n    } catch (Exception $e) {\n      notices::add('errors', $e->getMessage());\n    }\n  }\n\n  if (isset($_POST['delete'])) {\n\n    try {\n      if (empty($country->data['id'])) throw new Exception(language::translate('error_must_provide_country', 'You must provide a country'));\n\n      $country->delete();\n\n      notices::add('success', language::translate('success_changes_saved', 'Changes saved'));\n      header('Location: '. document::link(WS_DIR_ADMIN, ['doc' => 'countries'], true, ['country_id']));\n      exit;\n\n    } catch (Exception $e) {\n      notices::add('errors', $e->getMessage());\n    }\n  }\n?>\n<div class=\"panel panel-app\">\n  <div class=\"panel-heading\">\n    <?php echo $app_icon; ?> <?php echo !empty($country->data['id']) ? language::translate('title_edit_country', 'Edit Country') : language::translate('title_add_new_country', 'Add New Country'); ?>\n  </div>\n\n  <div class=\"panel-body\">\n    <?php echo functions::form_draw_form_begin('country_form', 'post', false, false, 'style=\"max-width: 640px;\"'); ?>\n\n      <div class=\"row\">\n        <div class=\"form-group col-md-6\">\n          <label><?php echo language::translate('title_status', 'Status'); ?></label>\n          <?php echo functions::form_draw_toggle('status', (file_get_contents('php://input') != '') ? true : '1', 'e/d'); ?>\n        </div>\n\n        <div class=\"form-group col-md-6\">\n          <label><?php echo language::translate('title_number', 'Number'); ?> (ISO 3166-1 numeric) <a href=\"https://en.wikipedia.org/wiki/ISO_3166-1_numeric\" target=\"_blank\"><?php echo functions::draw_fonticon('fa-external-link'); ?></a></label>\n          <?php echo functions::form_draw_text_field('iso_code_1', true, 'required pattern=\"[0-9]{3}\"'); ?>\n        </div>\n      </div>\n\n      <div class=\"row\">\n        <div class=\"form-group col-md-6\">\n          <label><?php echo language::translate('title_code', 'Code'); ?> (ISO 3166-1 alpha-2) <a href=\"http://en.wikipedia.org/wiki/ISO_3166-1_alpha-2\" target=\"_blank\"><?php echo functions::draw_fonticon('fa-external-link'); ?></a></label>\n          <?php echo functions::form_draw_text_field('iso_code_2', true, 'required pattern=\"[A-Z]{2}\"'); ?>\n        </div>\n\n        <div class=\"form-group col-md-6\">\n          <label><?php echo language::translate('title_code', 'Code'); ?> (ISO 3166-1 alpha-3) <a href=\"http://en.wikipedia.org/wiki/ISO_3166-1_alpha-3\" target=\"_blank\"><?php echo functions::draw_fonticon('fa-external-link'); ?></a></label>\n          <?php echo functions::form_draw_text_field('iso_code_3', true, 'required pattern=\"[A-Z]{3}\"'); ?>\n        </div>\n      </div>\n\n      <div class=\"row\">\n        <div class=\"form-group col-md-6\">\n          <label><?php echo language::translate('title_name', 'Name'); ?></label>\n          <?php echo functions::form_draw_text_field('name', true); ?>\n        </div>\n\n        <div class=\"form-group col-md-6\">\n          <label><?php echo language::translate('title_domestic_name', 'Domestic Name'); ?></label>\n          <?php echo functions::form_draw_text_field('domestic_name', true); ?>\n        </div>\n      </div>\n\n      <div class=\"form-group\">\n        <label><?php echo language::translate('title_address_format', 'Address Format'); ?> (<a id=\"address-format-hint\" href=\"#\">?</a>) <a href=\"https://en.wikipedia.org/wiki/Address_(geography)\" target=\"_blank\"><?php echo functions::draw_fonticon('fa-external-link'); ?></a></label>\n        <?php echo functions::form_draw_textarea('address_format', true, 'style=\"height: 150px;\"'); ?>\n      </div>\n\n      <div class=\"row\">\n        <div class=\"form-group col-md-6\">\n          <label><?php echo language::translate('title_tax_id_format', 'Tax ID Format'); ?> <a href=\"https://en.wikipedia.org/wiki/Regular_expression\" target=\"_blank\"><?php echo functions::draw_fonticon('fa-external-link'); ?></a></label>\n          <?php echo functions::form_draw_text_field('tax_id_format', true); ?>\n        </div>\n\n        <div class=\"form-group col-md-6\">\n          <label><?php echo language::translate('title_postcode_format', 'Postcode Format'); ?> <a href=\"https://en.wikipedia.org/wiki/Regular_expression\" target=\"_blank\"><?php echo functions::draw_fonticon('fa-external-link'); ?></a></label>\n          <?php echo functions::form_draw_text_field('postcode_format', true); ?>\n        </div>\n      </div>\n\n      <div class=\"row\">\n        <div class=\"form-group col-md-4\">\n          <label><?php echo language::translate('title_language_code', 'Language Code'); ?> <a href=\"http://en.wikipedia.org/wiki/List_of_ISO_639-1_codes\" target=\"_blank\"><?php echo functions::draw_fonticon('fa-external-link'); ?></a></label>\n          <?php echo functions::form_draw_text_field('language_code', true); ?>\n        </div>\n\n        <div class=\"form-group col-md-4\">\n          <label><?php echo language::translate('title_currency_code', 'Currency Code'); ?> <a href=\"https://en.wikipedia.org/wiki/List_of_countries_and_capitals_with_currency_and_language\" target=\"_blank\"><?php echo functions::draw_fonticon('fa-external-link'); ?></a></label>\n          <?php echo functions::form_draw_text_field('currency_code', true); ?>\n        </div>\n\n        <div class=\"form-group col-md-4\">\n          <label><?php echo language::translate('title_phone_country_code', 'Phone Country Code'); ?> <a href=\"https://en.wikipedia.org/wiki/List_of_country_calling_codes\" target=\"_blank\"><?php echo functions::draw_fonticon('fa-external-link'); ?></a></label>\n          <?php echo functions::form_draw_text_field('phone_code', true); ?>\n        </div>\n      </div>\n\n      <h2><?php echo language::translate('title_zones', 'Zones'); ?></h2>\n      <table class=\"table table-striped table-hover data-table\">\n        <thead>\n          <tr>\n            <th><?php echo language::translate('title_id', 'ID'); ?></th>\n            <th style=\"padding-inline-end: 50px;\"><?php echo language::translate('title_code', 'Code'); ?></th>\n            <th class=\"main\"><?php echo language::translate('title_name', 'Name'); ?></th>\n            <th></th>\n          </tr>\n        </thead>\n        <tbody>\n          <?php if (!empty($_POST['zones'])) foreach (array_keys($_POST['zones']) as $key) { ?>\n          <tr>\n            <td><?php echo functions::form_draw_hidden_field('zones['. $key .'][id]', true); ?><?php echo functions::escape_html($_POST['zones'][$key]['id']); ?></td>\n            <td><?php echo functions::form_draw_text_field('zones['. $key .'][code]', true); ?></td>\n            <td><?php echo functions::form_draw_text_field('zones['. $key .'][name]', true); ?></td>\n            <td class=\"text-end\"><a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"'); ?></a></td>\n          </tr>\n          <?php } ?>\n        </tbody>\n        <tfoot>\n          <tr>\n            <td colspan=\"4\"><a class=\"add\" href=\"#\"><?php echo functions::draw_fonticon('fa-plus-circle', 'style=\"color: #66cc66;\"'); ?> <?php echo language::translate('title_add_zone', 'Add Zone'); ?></a></td>\n          </tr>\n        </tfoot>\n      </table>\n\n      <div class=\"panel-action btn-group\">\n        <?php echo functions::form_draw_button('save', language::translate('title_save', 'Save'), 'submit', '', 'save'); ?>\n        <?php echo functions::form_draw_button('cancel', language::translate('title_cancel', 'Cancel'), 'button', 'onclick=\"history.go(-1);\"', 'cancel'); ?>\n        <?php echo (isset($country->data['id'])) ? functions::form_draw_button('delete', language::translate('title_delete', 'Delete'), 'submit', 'formnovalidate onclick=\"if (!window.confirm(\\''. language::translate('text_are_you_sure', 'Are you sure?') .'\\')) return false;\"', 'delete') : false; ?>\n      </div>\n\n    <?php echo functions::form_draw_form_end(); ?>\n  </div>\n</div>\n\n<script>\n  $('#address-format-hint').click(function() {\n    alert(\n      '<?php echo language::translate('title_syntax', 'Syntax'); ?>:\\n\\n' +\n      '%company, %firstname, %lastname, \\n' +\n      '%address1, %address2\\n' +\n      '%postcode %city\\n' +\n      '%zone_code, %zone_name\\n' +\n      '%country_number, %country_code, %country_code_3, %country_name, %country_domestic_name\\n'\n    );\n  });\n\n  var new_zone_i = <?php echo isset($_POST['zones']) ? count($_POST['zones']) : '0'; ?>;\n  $('form[name=\"country_form\"] .add').click(function(event) {\n    event.preventDefault();\n    if ($('select[name=\"country[code]\"]').find('option:selected').val() == '') return;\n    new_zone_i++;\n    var output = '    <tr>'\n               + '      <td><?php echo functions::escape_js(functions::form_draw_hidden_field('zones[new_zone_i][id]', '')); ?></td>'\n               + '      <td><?php echo functions::escape_js(functions::form_draw_text_field('zones[new_zone_i][code]', '')); ?></td>'\n               + '      <td><?php echo functions::escape_js(functions::form_draw_text_field('zones[new_zone_i][name]', '')); ?></td>'\n               + '      <td style=\"text-align: end;\"><a class=\"remove\" href=\"#\" title=\"<?php echo functions::escape_js(language::translate('title_remove', 'Remove'), true); ?>\"><?php echo functions::escape_js(functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"')); ?></a></td>'\n               + '    </tr>';\n    output = output.replace(/new_zone_i/g, 'new_' + new_zone_i);\n    output = output.replace(/new_zone_code/g, $('input[name=\"zone[code]\"]').val());\n    output = output.replace(/new_zone_name/g, $('input[name=\"zone[name]\"]').val());\n    $(this).closest('table').find('tbody').append(output);\n  });\n\n  $('form[name=\"country_form\"]').on('click', '.remove', function(event) {\n    event.preventDefault();\n    $(this).closest('tr').remove();\n  });\n</script>", "<?php\n\n  if (!empty($_GET['geo_zone_id'])) {\n    $geo_zone = new ent_geo_zone($_GET['geo_zone_id']);\n  } else {\n    $geo_zone = new ent_geo_zone();\n  }\n\n  if (empty($_POST)) {\n    $_POST = $geo_zone->data;\n  }\n\n  document::$snippets['title'][] = !empty($geo_zone->data['id']) ? language::translate('title_edit_geo_zone', 'Edit Geo Zone') : language::translate('title_new_geo_zone', 'Create New Geo Zone');\n\n  breadcrumbs::add(language::translate('title_geo_zones', 'Geo Zones'), document::link(WS_DIR_ADMIN, ['doc' => 'geo_zones'], ['app']));\n  breadcrumbs::add(!empty($geo_zone->data['id']) ? language::translate('title_edit_geo_zone', 'Edit Geo Zone') : language::translate('title_new_geo_zone', 'Create New Geo Zone'));\n\n  if (isset($_POST['save'])) {\n\n    try {\n\n      if (empty($_POST['zones'])) $_POST['zones'] = [];\n\n      $fields = [\n        'code',\n        'name',\n        'description',\n        'zones',\n      ];\n\n      foreach ($fields as $field) {\n        if (isset($_POST[$field])) $geo_zone->data[$field] = $_POST[$field];\n      }\n\n      $geo_zone->save();\n\n      notices::add('success', language::translate('success_changes_saved', 'Changes saved'));\n      header('Location: '. document::link(WS_DIR_ADMIN, ['doc' => 'geo_zones'], true, ['geo_zone_id']));\n      exit;\n\n    } catch (Exception $e) {\n      notices::add('errors', $e->getMessage());\n    }\n  }\n\n  if (isset($_POST['delete'])) {\n\n    try {\n      if (empty($geo_zone->data['id'])) throw new Exception(language::translate('error_must_provide_geo_zone', 'You must provide a geo zone'));\n\n      $geo_zone->delete();\n\n      notices::add('success', language::translate('success_changes_saved', 'Changes saved'));\n      header('Location: '. document::link(WS_DIR_ADMIN, ['doc' => 'geo_zones'], true, ['geo_zone_id']));\n      exit;\n\n    } catch (Exception $e) {\n      notices::add('errors', $e->getMessage());\n    }\n  }\n?>\n<div class=\"panel panel-app\">\n  <div class=\"panel-heading\">\n    <?php echo $app_icon; ?> <?php echo !empty($geo_zone->data['id']) ? language::translate('title_edit_geo_zone', 'Edit Geo Zone') : language::translate('title_new_geo_zone', 'Create New Geo Zone'); ?>\n  </div>\n\n  <div class=\"panel-body\">\n    <?php echo functions::form_draw_form_begin('form_geo_zone', 'post', false, false, 'style=\"max-width: 640px;\"'); ?>\n\n      <div class=\"row\">\n        <div class=\"form-group col-md-6\">\n          <label><?php echo language::translate('title_code', 'Code'); ?></label>\n          <?php echo functions::form_draw_text_field('code', true); ?>\n        </div>\n\n        <div class=\"form-group col-md-6\">\n          <label><?php echo language::translate('title_name', 'Name'); ?></label>\n          <?php echo functions::form_draw_text_field('name', true); ?>\n        </div>\n      </div>\n\n      <div class=\"row\">\n        <div class=\"form-group col-md-6\">\n          <label><?php echo language::translate('title_description', 'Description'); ?></label>\n          <?php echo functions::form_draw_text_field('description', true); ?>\n        </div>\n      </div>\n\n      <h2><?php echo language::translate('title_zones', 'Zones'); ?></h2>\n\n      <table class=\"table table-striped table-hover data-table\">\n        <thead>\n          <tr>\n            <th><?php echo language::translate('title_id', 'ID'); ?></th>\n            <th><?php echo language::translate('title_country', 'Country'); ?></th>\n            <th><?php echo language::translate('title_zone', 'Zone'); ?></th>\n            <th><?php echo language::translate('title_city', 'City'); ?></th>\n            <th></th>\n          </tr>\n        </thead>\n\n        <tbody>\n          <?php if (!empty($_POST['zones'])) foreach (array_keys($_POST['zones']) as $key) { ?>\n          <tr>\n            <td><?php echo functions::form_draw_hidden_field('zones['. $key .'][id]', true); ?><?php echo functions::escape_html($_POST['zones'][$key]['id']); ?></td>\n            <td><?php echo functions::form_draw_hidden_field('zones['. $key .'][country_code]', true); ?> <?php echo functions::escape_html(reference::country($_POST['zones'][$key]['country_code'])->name); ?></td>\n            <td><?php echo functions::form_draw_hidden_field('zones['. $key .'][zone_code]', true); ?> <?php echo !empty($_POST['zones'][$key]['zone_code']) ? functions::escape_html(reference::country($_POST['zones'][$key]['country_code'])->zones[$_POST['zones'][$key]['zone_code']]['name']) : '-- '.language::translate('title_all_zones', 'All Zones') .' --'; ?></td>\n            <td><?php echo functions::form_draw_hidden_field('zones['. $key .'][city]', true); ?> <?php echo !empty($_POST['zones'][$key]['city']) ? functions::escape_html($_POST['zones'][$key]['city']) : '-- '.language::translate('title_all_cities', 'All Cities') .' --'; ?></td>\n            <td class=\"text-end\"><a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"'); ?></a></td>\n          </tr>\n          <?php } ?>\n        </tbody>\n\n        <tfoot>\n          <tr>\n            <td><?php echo functions::form_draw_hidden_field('new_zone[id]', ''); ?></td>\n            <td><?php echo functions::form_draw_countries_list('new_zone[country_code]', ''); ?></td>\n            <td><?php echo functions::form_draw_zones_list('', 'new_zone[zone_code]', '', false, '', 'all'); ?></td>\n            <td><?php echo functions::form_draw_text_field('new_zone[city]', '', 'placeholder=\"-- '. language::translate('text_all_cities', 'All cities') .' --\"'); ?></td>\n            <td><?php echo functions::form_draw_button('add', language::translate('title_add', 'Add'), 'button'); ?></td>\n          </tr>\n        </tfoot>\n      </table>\n\n      <div class=\"panel-action btn-group\">\n        <?php echo functions::form_draw_button('save', language::translate('title_save', 'Save'), 'submit', '', 'save'); ?>\n        <?php echo functions::form_draw_button('cancel', language::translate('title_cancel', 'Cancel'), 'button', 'onclick=\"history.go(-1);\"', 'cancel'); ?>\n        <?php echo (!empty($geo_zone->data['id'])) ? functions::form_draw_button('delete', language::translate('title_delete', 'Delete'), 'submit', 'formnovalidate onclick=\"if (!window.confirm(\\''. language::translate('text_are_you_sure', 'Are you sure?') .'\\')) return false;\"', 'delete') : false; ?>\n      </div>\n\n    <?php echo functions::form_draw_form_end(); ?>\n  </div>\n</div>\n\n<script>\n  $('select[name$=\"new_zone[zone_code]\"][disabled]').each(function() {\n    $(this).html('<option value=\"\">-- <?php echo functions::escape_js(language::translate('title_all_zones', 'All Zones')); ?> --</option>');\n  });\n\n  $('body').on('change', 'select[name=\"new_zone[country_code]\"]', function() {\n    var zone_field = $(this).closest('tr').find(\"select[name='new_zone[zone_code]']\");\n    $('body').css('cursor', 'wait');\n    $.ajax({\n      url: '<?php echo document::ilink('ajax/zones.json'); ?>?country_code=' + $(this).val(),\n      type: 'get',\n      cache: true,\n      async: true,\n      dataType: 'json',\n      error: function(jqXHR, textStatus, errorThrown) {\n        alert(jqXHR.readyState + '\\n' + textStatus + '\\n' + errorThrown.message);\n      },\n      success: function(data) {\n        $(zone_field).html('');\n        if (data) {\n          $(zone_field).append('<option value=\"\">-- <?php echo functions::escape_js(language::translate('title_all_zones', 'All Zones')); ?> --</option>');\n          $.each(data, function(i, zone) {\n            $(zone_field).append('<option value=\"'+ zone.code +'\">'+ zone.name +'</option>');\n          });\n          $(zone_field).prop('disabled', false);\n        } else {\n          $(zone_field).append('<option value=\"\">-- <?php echo functions::escape_js(language::translate('title_all_zones', 'All Zones')); ?> --</option>');\n          $(zone_field).prop('disabled', true);\n        }\n      },\n      complete: function() {\n        $('body').css('cursor', 'auto');\n      }\n    });\n  });\n\n  var new_zone_i = <?php echo isset($_POST['zones']) ? count($_POST['zones']) : '0'; ?>;\n  $('form[name=\"form_geo_zone\"]').on('click', 'button[name=\"add\"]', function(e) {\n    e.preventDefault();\n\n    if ($('select[name=\"country[code]\"]').find('option:selected').val() == '') return;\n\n    var row = $(this).closest('tr');\n\n    var found = false;\n    $.each($('form[name=\"form_geo_zone\"] tbody tr'), function(i, current){\n      if ($(current).find(':input[name$=\"[country_code]\"]').val() == $(':input[name=\"new_zone[country_code]\"]').val()\n       && $(current).find(':input[name$=\"[zone_code]\"]').val() == $(':input[name=\"new_zone[zone_code]\"]').val()\n       && $(current).find(':input[name$=\"[city]\"]').val() == $(':input[name=\"new_zone[city]\"]').val()) {\n         found = true;\n         return;\n       }\n    });\n\n    if (found) return;\n\n    var output = '    <tr>'\n               + '      <td><?php echo functions::escape_js(functions::form_draw_hidden_field('zones[new_zone_i][id]', '')); ?></td>'\n               + '      <td><?php echo functions::escape_js(functions::form_draw_hidden_field('zones[new_zone_i][country_code]', '')); ?>' + $('select[name=\"new_zone[country_code]\"] option:selected').text() + '</td>'\n               + '      <td><?php echo functions::escape_js(functions::form_draw_hidden_field('zones[new_zone_i][zone_code]', '')); ?>' + $('select[name=\"new_zone[zone_code]\"] option:selected').text() + '</td>'\n               + '      <td><?php echo functions::escape_js(functions::form_draw_hidden_field('zones[new_zone_i][city]', '')); ?>' + $('input[name=\"new_zone[city]\"]').val() + '</td>'\n               + '      <td style=\"text-align: end;\"><a class=\"remove\" href=\"#\" title=\"<?php echo functions::escape_js(language::translate('title_remove', 'Remove'), true); ?>\"><?php echo functions::escape_js(functions::draw_fonticon('fa-times-circle fa-lg', 'style=\"color: #cc3333;\"')); ?></a></td>'\n               + '    </tr>';\n\n    output = output.replace(/new_zone_i/g, 'new_' + new_zone_i++);\n    $(this).closest('table').find('tbody').append(output);\n\n    $('form[name=\"form_geo_zone\"] tbody tr:last :input[name$=\"[country_code]\"]').val($(':input[name=\"new_zone[country_code]\"]').val());\n    $('form[name=\"form_geo_zone\"] tbody tr:last :input[name$=\"[zone_code]\"]').val($(':input[name=\"new_zone[zone_code]\"]').val());\n    $('form[name=\"form_geo_zone\"] tbody tr:last :input[name$=\"[city]\"]').val($(':input[name=\"new_zone[city]\"]').val());\n\n    if ($(':input[name=\"new_zone[city]\"]').val() == '') {\n      $(':input[name=\"new_zone[zone_code]\"]').val('');\n    }\n\n    $(':input[name=\"new_zone[city]\"]').val('');\n  });\n\n  $('form[name=\"form_geo_zone\"]').on('click', '.remove', function(e) {\n    e.preventDefault();\n    $(this).closest('tr').remove();\n  });\n</script>", "<?php\n\n  if (!empty($_GET['order_id'])) {\n    $order = new ent_order($_GET['order_id']);\n  } else {\n    $order = new ent_order();\n    $order->data['client_ip'] = $_SERVER['REMOTE_ADDR'];\n    $order->data['user_agent'] = $_SERVER['HTTP_USER_AGENT'];\n    $order->data['date_created'] = date('Y-m-d H:i:s');\n  }\n\n  if (empty($_POST)) {\n\n    $_POST = $order->data;\n\n  // Convert to local currency\n    foreach (array_keys($_POST['items']) as $key) {\n      $_POST['items'][$key]['price'] = $_POST['items'][$key]['price'] / $_POST['currency_value'];\n      $_POST['items'][$key]['tax'] = $_POST['items'][$key]['tax'] / $_POST['currency_value'];\n    }\n    foreach (array_keys($_POST['order_total']) as $key) {\n      $_POST['order_total'][$key]['value'] = $_POST['order_total'][$key]['value'] / $_POST['currency_value'];\n      $_POST['order_total'][$key]['tax'] = $_POST['order_total'][$key]['tax'] / $_POST['currency_value'];\n    }\n\n    if (empty($order->data['id'])) {\n      $_POST['customer']['country_code'] = settings::get('default_country_code');\n    }\n  }\n\n  document::$snippets['title'][] = !empty($order->data['id']) ? language::translate('title_edit_order', 'Edit Order') .' #'. $order->data['id'] : language::translate('title_create_new_order', 'Create New Order');\n\n  breadcrumbs::add(language::translate('title_orders', 'Orders'), document::link(WS_DIR_ADMIN, ['doc' => 'orders'], ['app']));\n  breadcrumbs::add(!empty($order->data['id']) ? language::translate('title_edit_order', 'Edit Order') .' #'. $order->data['id'] : language::translate('title_create_new_order', 'Create New Order'));\n\n// Mark as read\n  if (!empty($order->data['id'])) {\n    database::query(\n      \"update \". DB_TABLE_PREFIX .\"orders\n      set unread = 0\n      where id = \".  (int)$order->data['id'] .\"\n      limit 1;\"\n    );\n  }\n\n// Save data to database\n  if (isset($_POST['save'])) {\n\n    try {\n      if (empty($_POST['items'])) $_POST['items'] = [];\n      if (empty($_POST['order_total'])) $_POST['order_total'] = [];\n      if (empty($_POST['comments'])) $_POST['comments'] = [];\n\n      if (!empty($_POST['items'])) {\n        foreach (array_keys($_POST['items']) as $key) {\n          $_POST['items'][$key]['price'] = (float)$_POST['items'][$key]['price'] * (float)$_POST['currency_value'];\n          $_POST['items'][$key]['tax'] = (float)$_POST['items'][$key]['tax'] * (float)$_POST['currency_value'];\n        }\n      }\n\n      if (!empty($_POST['order_total'])) {\n        foreach (array_keys($_POST['order_total']) as $key) {\n          if (empty($_POST['order_total'][$key]['calculate'])) $_POST['order_total'][$key]['calculate'] = false;\n          $_POST['order_total'][$key]['value'] = (float)$_POST['order_total'][$key]['value'] * (float)$_POST['currency_value'];\n          $_POST['order_total'][$key]['tax'] = (float)$_POST['order_total'][$key]['tax'] * (float)$_POST['currency_value'];\n        }\n      }\n\n      $fields = [\n        'unread',\n        'language_code',\n        'currency_code',\n        'currency_value',\n        'items',\n        'order_total',\n        'order_status_id',\n        'shipping_option',\n        'shipping_tracking_id',\n        'shipping_tracking_url',\n        'payment_option',\n        'payment_transaction_id',\n        'display_prices_including_tax',\n        'reference',\n        'comments',\n      ];\n\n      foreach ($fields as $field) {\n        if (isset($_POST[$field])) $order->data[$field] = $_POST[$field];\n      }\n\n      $fields = [\n        'id',\n        'email',\n        'tax_id',\n        'company',\n        'firstname',\n        'lastname',\n        'address1',\n        'address2',\n        'postcode',\n        'city',\n        'phone',\n        'country_code',\n        'zone_code',\n      ];\n\n      foreach ($fields as $field) {\n        if (isset($_POST['customer'][$field])) $order->data['customer'][$field] = $_POST['customer'][$field];\n      }\n\n      $fields = [\n        'company',\n        'firstname',\n        'lastname',\n        'address1',\n        'address2',\n        'postcode',\n        'city',\n        'country_code',\n        'zone_code',\n        'phone',\n      ];\n\n      foreach ($fields as $field) {\n        if (isset($_POST['customer']['shipping_address'][$field])) $order->data['customer']['shipping_address'][$field] = $_POST['customer']['shipping_address'][$field];\n      }\n\n      $order->save();\n\n      if (!empty($_POST['email_order_copy'])) {\n\n        $bccs = [];\n        foreach (preg_split('#[\\s;,]+#', settings::get('email_order_copy'), -1, PREG_SPLIT_NO_EMPTY) as $email) {\n          $bccs[] = $email;\n        }\n\n        $order->email_order_copy($order->data['customer']['email'], $bccs, $order->data['language_code']);\n      }\n\n      if (!empty($_GET['redirect_url'])) {\n        $redirect_url = new ent_link($_GET['redirect_url']);\n        $redirect_url->host = '';\n      } else {\n        $redirect_url = document::link(WS_DIR_ADMIN, ['app' => $_GET['app'], 'doc' => 'orders']);\n      }\n\n      notices::add('success', language::translate('success_changes_saved', 'Changes saved'));\n      header('Location: '. $redirect_url);\n      exit;\n\n    } catch (Exception $e) {\n      notices::add('errors', $e->getMessage());\n    }\n  }\n\n  if (isset($_POST['delete'])) {\n\n    try {\n      if (empty($order->data['id'])) throw new Exception(language::translate('error_must_provide_order', 'You must provide an order'));\n\n      $order->delete();\n\n      if (empty($_GET['redirect_url'])) {\n        $_GET['redirect_url'] = document::link(WS_DIR_ADMIN, ['app' => $_GET['app'], 'doc' => 'orders']);\n      }\n\n      notices::add('success', language::translate('success_changes_saved', 'Changes saved'));\n      header('Location: '. $_GET['redirect_url']);\n      exit;\n\n    } catch (Exception $e) {\n      notices::add('errors', $e->getMessage());\n    }\n  }\n\n  functions::draw_lightbox();\n\n  $account_name = '('. language::translate('title_guest', 'Guest') .')';\n  if (!empty($_POST['customer']['id'])) {\n    $customer = reference::customer((int)$_POST['customer']['id']);\n    $account_name = $customer->company ? $customer->company : $customer->firstname .' '. $customer->lastname;\n  }\n?>\n<style>\n#order-items tr.highlight {\n  border: 1px #f00 solid;\n}\n#order-items tr.extended {\n  display: none;\n}\n#order-items tr.highlight + tr.extended {\n  display: table-row;\n}\n\n#box-comments {\n  height: 100%;\n}\n\n#box-comments .bubbles .private {\n  position: absolute;\n  top: 0.5em;\n  right: 2.5em;\n  cursor: pointer;\n}\n#box-comments .bubbles .private input[name$=\"[hidden]\"] {\n  display: none;\n}\n#box-comments .bubbles .private input[name$=\"[hidden]\"] + .fa {\n  opacity: 0.25;\n}\n#box-comments .bubbles .private input[name$=\"[hidden]\"]:checked + .fa {\n  opacity: 1;\n}\n\n#box-comments .bubbles .notify  {\n  position: absolute;\n  top: 0.5em;\n  right: 4em;\n  cursor: pointer;\n}\n#box-comments .bubbles .notify input[name$=\"[notify]\"] {\n  display: none;\n}\n#box-comments .bubbles .notify input[name$=\"[notify]\"] + .fa {\n  opacity: 0.25;\n}\n#box-comments .bubbles .notify input[name$=\"[notify]\"]:checked + .fa {\n  opacity: 1;\n}\n\n\n#box-comments .bubbles .semi-transparent {\n  opacity: 0.5;\n}\n\n#modal-customer-picker tbody tr {\n  cursor: pointer;\n}\n</style>\n\n<div class=\"panel panel-app\">\n  <div class=\"panel-heading\">\n    <?php echo $app_icon; ?> <?php echo !empty($order->data['id']) ? language::translate('title_edit_order', 'Edit Order') .' #'. $order->data['id'] : language::translate('title_create_new_order', 'Create New Order'); ?>\n  </div>\n\n  <div class=\"panel-body\">\n    <?php echo functions::form_draw_form_begin('form_order', 'post'); ?>\n\n      <div class=\"row\">\n        <div class=\"col-lg-9\">\n\n          <div class=\"panel panel-default\">\n            <div class=\"panel-heading\">\n              <h2 class=\"panel-title\"><?php echo language::translate('title_order_information', 'Order Information'); ?></h2>\n            </div>\n\n            <div class=\"panel-body\">\n              <div class=\"row\">\n\n                <div class=\"form-group col-md-3\">\n                  <label><?php echo language::translate('title_order_status', 'Order Status'); ?></label>\n                  <?php echo functions::form_draw_order_status_list('order_status_id', true); ?>\n                </div>\n\n                <div class=\"form-group col-md-3\">\n                  <label><?php echo language::translate('title_language', 'Language'); ?></label>\n                  <?php echo functions::form_draw_languages_list('language_code', true); ?>\n                </div>\n\n                <div class=\"form-group col-md-3\">\n                  <label><?php echo language::translate('title_currency', 'Currency'); ?></label>\n                  <?php echo functions::form_draw_currencies_list('currency_code', true); ?>\n                </div>\n\n                <div class=\"form-group col-md-3\">\n                  <label><?php echo language::translate('title_currency_value', 'Currency Value'); ?></label>\n                  <?php echo functions::form_draw_decimal_field('currency_value', true, 6); ?>\n                </div>\n\n                <div class=\"form-group col-md-3\">\n                  <label><?php echo language::translate('title_date', 'Date'); ?></label>\n                  <div class=\"form-control\" readonly><?php echo date(language::$selected['raw_datetime'], strtotime($order->data['date_created'])); ?></div>\n                </div>\n\n                <div class=\"form-group col-md-3\">\n                  <label><?php echo language::translate('title_ip_address', 'IP Address'); ?></label>\n                  <div class=\"form-control\" readonly><?php echo $order->data['client_ip']; ?> <a href=\"https://ip-api.com/#<?php echo $order->data['client_ip']; ?>\" target=\"_blank\"><?php echo functions::draw_fonticon('fa-external-link'); ?></a></div>\n                </div>\n\n                <div class=\"form-group col-md-3\">\n                  <label><?php echo language::translate('title_reference', 'Reference'); ?></label>\n                  <?php echo functions::form_draw_text_field('reference', true); ?>\n                </div>\n\n                <div class=\"form-group col-md-3\">\n                  <label><?php echo language::translate('title_order_copy', 'Order Copy'); ?></label>\n                  <div class=\"btn-group btn-block\" data-toggle=\"buttons\">\n                    <label class=\"btn btn-default<?php echo !empty($_POST['display_prices_including_tax']) ? ' active' : ''; ?>\"><input type=\"radio\" name=\"display_prices_including_tax\" value=\"1\"<?php echo !empty($_POST['display_prices_including_tax']) ? ' checked' : ''; ?> /><?php echo language::translate('title_incl_tax', 'Incl. Tax'); ?></label>\n                    <label class=\"btn btn-default<?php echo empty($_POST['display_prices_including_tax']) ? ' active' : ''; ?>\"><input type=\"radio\" name=\"display_prices_including_tax\" value=\"0\"<?php echo empty($_POST['display_prices_including_tax']) ? ' checked' : ''; ?> /><?php echo language::translate('title_excl_tax', 'Excl. Tax'); ?></label>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n\n          <div id=\"customer-details\" class=\"panel panel-default\">\n            <div class=\"panel-heading\">\n              <h2 class=\"panel-title\"><?php echo language::translate('title_customer_information', 'Customer Information'); ?></h2>\n            </div>\n\n            <div class=\"panel-body\">\n              <div class=\"row\" style=\"margin-bottom: 0;\">\n                <div class=\"col-md-6 customer-details\">\n                  <h3><?php echo language::translate('title_billing_address', 'Billing Address'); ?></h3>\n\n                  <div class=\"form-group\">\n                    <div class=\"input-group\">\n                      <div class=\"selected-account form-control\">\n                        <?php echo functions::form_draw_hidden_field('customer[id]', true); ?>\n                        <?php echo language::translate('title_id', 'ID'); ?>:\n                        <span class=\"id\"><?php echo isset($_POST['customer']['id']) ? (int)$_POST['customer']['id'] : ''; ?></span> &ndash;\n                        <span class=\"name\"><?php echo $account_name; ?></span>\n                        <a href=\"<?php echo document::href_link(WS_DIR_ADMIN, ['app' => 'customers', 'doc' => 'customer_picker']); ?>\" data-toggle=\"lightbox\" class=\"btn btn-default btn-sm\" style=\"margin-inline-start: 5px;\"><?php echo language::translate('title_change', 'Change'); ?></a>\n                      </div>\n                      <?php echo functions::form_draw_button('get_address', language::translate('title_get_address', 'Get Address'), 'button'); ?>\n                    </div>\n                  </div>\n\n                  <div class=\"row\">\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_company', 'Company'); ?></label>\n                      <?php echo functions::form_draw_text_field('customer[company]', true); ?>\n                    </div>\n\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_tax_id', 'Tax ID / VATIN'); ?></label>\n                      <?php echo functions::form_draw_text_field('customer[tax_id]', true); ?>\n                    </div>\n                  </div>\n\n                  <div class=\"row\">\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_firstname', 'First Name'); ?></label>\n                      <?php echo functions::form_draw_text_field('customer[firstname]', true); ?>\n                    </div>\n\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_lastname', 'Last Name'); ?></label>\n                      <?php echo functions::form_draw_text_field('customer[lastname]', true); ?>\n                    </div>\n                  </div>\n\n                  <div class=\"row\">\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_address1', 'Address 1'); ?></label>\n                      <?php echo functions::form_draw_text_field('customer[address1]', true); ?>\n                    </div>\n\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_address2', 'Address 2'); ?></label>\n                      <?php echo functions::form_draw_text_field('customer[address2]', true); ?>\n                    </div>\n                  </div>\n\n                  <div class=\"row\">\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_postcode', 'Postal Code'); ?></label>\n                      <?php echo functions::form_draw_text_field('customer[postcode]', true); ?>\n                    </div>\n\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_city', 'City'); ?></label>\n                      <?php echo functions::form_draw_text_field('customer[city]', true); ?>\n                    </div>\n                  </div>\n\n                  <div class=\"row\">\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_country', 'Country'); ?></label>\n                      <?php echo functions::form_draw_countries_list('customer[country_code]', true); ?>\n                    </div>\n\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_zone_state_province', 'Zone/State/Province'); ?></label>\n                      <?php echo form_draw_zones_list(isset($_POST['customer']['country_code']) ? $_POST['customer']['country_code'] : null, 'customer[zone_code]', true); ?>\n                    </div>\n                  </div>\n\n                  <div class=\"row\">\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_email_address', 'Email Address'); ?></label>\n                      <?php echo functions::form_draw_email_field('customer[email]', true, 'required'); ?>\n                    </div>\n\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_phone', 'Phone'); ?></label>\n                      <?php echo functions::form_draw_phone_field('customer[phone]', true); ?>\n                    </div>\n                  </div>\n                </div>\n\n                <div class=\"form-group col-md-6 shipping-address\">\n                  <h3><?php echo language::translate('title_shipping_address', 'Shipping Address'); ?></h3>\n\n                  <div class=\"form-group\">\n                    <?php echo functions::form_draw_button('copy_billing_address', language::translate('title_copy_billing_address', 'Copy Billing Address'), 'button', 'class=\"btn btn-default btn-block\"'); ?>\n                  </div>\n\n                  <div class=\"row\">\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_company', 'Company'); ?></label>\n                      <?php echo functions::form_draw_text_field('customer[shipping_address][company]', true); ?>\n                    </div>\n                  </div>\n\n                  <div class=\"row\">\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_firstname', 'First Name'); ?></label>\n                      <?php echo functions::form_draw_text_field('customer[shipping_address][firstname]', true); ?>\n                    </div>\n\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_lastname', 'Last Name'); ?></label>\n                      <?php echo functions::form_draw_text_field('customer[shipping_address][lastname]', true); ?>\n                    </div>\n                  </div>\n\n                  <div class=\"row\">\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_address1', 'Address 1'); ?></label>\n                      <?php echo functions::form_draw_text_field('customer[shipping_address][address1]', true); ?>\n                    </div>\n\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_address2', 'Address 2'); ?></label>\n                      <?php echo functions::form_draw_text_field('customer[shipping_address][address2]', true); ?>\n                    </div>\n                  </div>\n\n                  <div class=\"row\">\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_postcode', 'Postal Code'); ?></label>\n                      <?php echo functions::form_draw_text_field('customer[shipping_address][postcode]', true); ?>\n                    </div>\n\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_city', 'City'); ?></label>\n                      <?php echo functions::form_draw_text_field('customer[shipping_address][city]', true); ?>\n                    </div>\n                  </div>\n\n                  <div class=\"row\">\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_country', 'Country'); ?></label>\n                      <?php echo functions::form_draw_countries_list('customer[shipping_address][country_code]', true); ?>\n                    </div>\n\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_zone_state_province', 'Zone/State/Province'); ?></label>\n                      <?php echo form_draw_zones_list(isset($_POST['customer']['shipping_address']['country_code']) ? $_POST['customer']['shipping_address']['country_code'] : null, 'customer[shipping_address][zone_code]', true); ?>\n                    </div>\n                  </div>\n\n                  <div class=\"row\">\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_phone', 'Phone'); ?></label>\n                      <?php echo functions::form_draw_phone_field('customer[shipping_address][phone]', true); ?>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n\n          <div class=\"row\" style=\"margin-bottom: 0;\">\n            <div class=\"col-md-6\">\n              <div class=\"panel panel-default\" style=\"margin-bottom: 0;\">\n                <div class=\"panel-heading\">\n                  <h2 class=\"panel-title\"><?php echo language::translate('title_payment_information', 'Payment Information'); ?></h2>\n                </div>\n\n                <div class=\"panel-body\">\n                  <div class=\"row\">\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_option_id', 'Option ID'); ?></label>\n                      <?php echo functions::form_draw_text_field('payment_option[id]', true); ?>\n                    </div>\n\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_name', 'Name'); ?></label>\n                      <?php echo functions::form_draw_text_field('payment_option[name]', true); ?>\n                    </div>\n\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_transaction_id', 'Transaction ID'); ?></label>\n                      <?php echo functions::form_draw_text_field('payment_transaction_id', true); ?>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            <div class=\"col-md-6\">\n              <div class=\"panel panel-default\" style=\"margin-bottom: 0;\">\n                <div class=\"panel-heading\">\n                  <h2 class=\"panel-title\"><?php echo language::translate('title_shipping_information', 'Shipping Information'); ?></h2>\n                </div>\n\n                <div class=\"panel-body\">\n                  <div class=\"row\">\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_option_id', 'Option ID'); ?></label>\n                      <?php echo functions::form_draw_text_field('shipping_option[id]', true); ?>\n                    </div>\n\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_name', 'Name'); ?></label>\n                      <?php echo functions::form_draw_text_field('shipping_option[name]', true); ?>\n                    </div>\n\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_tracking_id', 'Tracking ID'); ?></label>\n                      <?php echo functions::form_draw_text_field('shipping_tracking_id', true); ?>\n                    </div>\n\n                    <div class=\"form-group col-md-6\">\n                      <label><?php echo language::translate('title_weight', 'Weight'); ?></label>\n                      <span class=\"form-control\"><?php echo weight::format($order->data['weight_total'], $order->data['weight_class']) ?></span>\n                    </div>\n\n                    <div class=\"form-group col-md-12\">\n                      <label><?php echo language::translate('title_tracking_url', 'Tracking URL'); ?></label>\n                      <?php echo functions::form_draw_url_field('shipping_tracking_url', true); ?>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n\n        <div class=\"col-lg-3\">\n          <div id=\"box-comments\" class=\"panel panel-default\" style=\"margin-bottom: 0;\">\n            <div class=\"panel-heading\">\n              <h2 class=\"panel-title\"><?php echo language::translate('title_comments', 'Comments'); ?></h2>\n            </div>\n\n            <div class=\"panel-body bubbles\">\n<?php\n  foreach (array_keys($_POST['comments']) as $key) {\n\n    switch($_POST['comments'][$key]['author']) {\n      case 'customer':\n        $type = 'remote';\n        break;\n      case 'staff':\n        $type = 'local';\n        break;\n      default:\n        $type = 'event';\n        break;\n    }\n\n    if (!empty($_POST['comments'][$key]['hidden'])) $type .= ' semi-transparent';\n?>\n              <div class=\"bubble <?php echo $type; ?>\">\n                <?php echo functions::form_draw_hidden_field('comments['. $key .'][id]', true); ?>\n                <?php echo functions::form_draw_hidden_field('comments['. $key .'][order_id]', true); ?>\n                <?php echo functions::form_draw_hidden_field('comments['. $key .'][author]', true); ?>\n                <?php echo functions::form_draw_hidden_field('comments['. $key .'][text]', true); ?>\n\n                <div class=\"text\"><?php echo nl2br(functions::escape_html($_POST['comments'][$key]['text'])); ?></div>\n\n                <div class=\"date\"><?php echo language::strftime(language::$selected['format_datetime'], !empty($_POST['comments'][$key]['date_created']) ? strtotime($_POST['comments'][$key]['date_created']) : 0); ?></div>\n\n                <div class=\"actions\">\n                  <a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle'); ?></a>\n                  <label class=\"private\" title=\"<?php echo functions::escape_html(language::translate('title_hidden', 'Hidden')); ?>\"><?php echo functions::form_draw_checkbox('comments['.$key .'][hidden]', '1', true); ?> <?php echo functions::draw_fonticon('fa-eye-slash'); ?></label>\n                </div>\n              </div>\n              <?php } ?>\n\n              <div class=\"add text-end\"><button class=\"btn btn-default\" type=\"button\" title=\"<?php echo language::translate('title_add', 'Add'); ?>\"><?php echo functions::draw_fonticon('fa-plus', 'style=\"color: #66cc66;\"'); ?> <?php echo language::translate('title_add_comment', 'Add Comment'); ?></button></div>\n            </div>\n\n          </div>\n        </div>\n      </div>\n\n      <div id=\"order-items\" class=\"panel panel-default\">\n        <div class=\"panel-heading\">\n          <h2 class=\"panel-title\"><?php echo language::translate('title_order_items', 'Order Items'); ?></h2>\n        </div>\n\n        <div class=\"panel-body table-responsive\">\n          <table class=\"table table-striped table-hover table-input\">\n            <thead>\n              <tr>\n                <th><?php echo language::translate('title_item', 'Item'); ?></th>\n                <th style=\"width: 200px;\"><?php echo language::translate('title_sku', 'SKU'); ?></th>\n                <th style=\"width: 150px;\"><?php echo language::translate('title_weight', 'Weight'); ?></th>\n                <th style=\"width: 175px;\"><?php echo language::translate('title_dimensions', 'Dimensions'); ?></th>\n                <th style=\"width: 125px;\" class=\"text-center\"><?php echo language::translate('title_qty', 'Qty'); ?></th>\n                <th style=\"width: 200px;\" class=\"text-center\"><?php echo language::translate('title_unit_price', 'Unit Price'); ?></th>\n                <th style=\"width: 200px;\" class=\"text-center\"><?php echo language::translate('title_tax', 'Tax'); ?></th>\n                <th style=\"width: 75px;\">&nbsp;</th>\n              </tr>\n            </thead>\n            <tbody>\n              <?php if (!empty($_POST['items'])) foreach (array_keys($_POST['items']) as $key) { ?>\n              <tr class=\"item\">\n                <td>\n                  <?php echo !empty($_POST['items'][$key]['product_id']) ? '<a href=\"'. document::href_link(WS_DIR_ADMIN, ['app' => 'catalog', 'doc' => 'edit_product', 'product_id' => $_POST['items'][$key]['product_id']]) .'\" target=\"_blank\">'. functions::escape_html($_POST['items'][$key]['name']) .'</a>' : functions::escape_html($_POST['items'][$key]['name']); ?> <?php echo '<a class=\"float-end\" href=\"'. document::href_ilink('product', ['product_id' => $_POST['items'][$key]['product_id']]) .'\" target=\"_blank\">'. functions::draw_fonticon('fa-external-link') .'</a>'; ?>\n                  <?php echo functions::form_draw_hidden_field('items['.$key.'][id]', true); ?>\n                  <?php echo functions::form_draw_hidden_field('items['.$key.'][product_id]', true); ?>\n                  <?php echo functions::form_draw_hidden_field('items['.$key.'][option_stock_combination]', true); ?>\n                  <?php echo functions::form_draw_hidden_field('items['.$key.'][name]', true); ?>\n                  <?php echo functions::form_draw_hidden_field('items['. $key .'][sku]', true); ?>\n                  <?php echo functions::form_draw_hidden_field('items['. $key .'][gtin]', true); ?>\n                  <?php echo functions::form_draw_hidden_field('items['. $key .'][taric]', true); ?>\n                  <?php echo functions::form_draw_hidden_field('items['. $key .'][weight]', true); ?>\n                  <?php echo functions::form_draw_hidden_field('items['. $key .'][weight_class]', true); ?>\n                  <?php echo functions::form_draw_hidden_field('items['. $key .'][dim_x]', true); ?>\n                  <?php echo functions::form_draw_hidden_field('items['. $key .'][dim_y]', true); ?>\n                  <?php echo functions::form_draw_hidden_field('items['. $key .'][dim_z]', true); ?>\n                  <?php echo functions::form_draw_hidden_field('items['. $key .'][dim_class]', true); ?>\n<?php\n      if (!empty($_POST['items'][$key]['options'])) {\n        foreach (array_keys($_POST['items'][$key]['options']) as $field) {\n          echo '<div>' . PHP_EOL\n             . ' - '. functions::escape_html($field) .': ' . PHP_EOL;\n          if (is_array($_POST['items'][$key]['options'][$field])) {\n            $use_comma = false;\n            foreach (array_keys($_POST['items'][$key]['options'][$field]) as $k) {\n              echo '  ' . functions::form_draw_hidden_field('items['.$key.'][options]['.$field.']['.$k.']', true) . functions::escape_html($_POST['items'][$key]['options'][$field][$k]);\n              if ($use_comma) echo ', ';\n              $use_comma = true;\n            }\n          } else {\n            echo '  ' . functions::form_draw_hidden_field('items['.$key.'][options]['.$field.']', true) . functions::escape_html($_POST['items'][$key]['options'][$field]);\n          }\n          echo '</div>' . PHP_EOL;\n        }\n      } else {\n        echo functions::form_draw_hidden_field('items['.$key.'][options]', '');\n      }\n?>\n              </td>\n              <td class=\"sku\"><?php echo functions::escape_html($_POST['items'][$key]['sku']); ?></td>\n              <td>\n                <span class=\"weight\"><?php echo (float)$_POST['items'][$key]['weight']; ?></span> <span class=\"weight_class\"><?php echo functions::escape_html($_POST['items'][$key]['weight_class']); ?></span>\n              </td>\n              <td>\n                <span class=\"dim_x\"><?php echo (float)$_POST['items'][$key]['dim_x']; ?></span> x <span class=\"dim_y\"><?php echo (float)$_POST['items'][$key]['dim_y']; ?></span> x <span class=\"dim_z\"><?php echo (float)$_POST['items'][$key]['dim_z']; ?></span> <span class=\"dim_class\"><?php echo functions::escape_html($_POST['items'][$key]['dim_class']); ?></span>\n              </td>\n              <td><?php echo functions::form_draw_decimal_field('items['. $key .'][quantity]', true, 2); ?></td>\n              <td><?php echo functions::form_draw_currency_field($_POST['currency_code'], 'items['. $key .'][price]', true); ?></td>\n              <td><?php echo functions::form_draw_currency_field($_POST['currency_code'], 'items['. $key .'][tax]', true); ?></td>\n              <td class=\"text-end\">\n                <a class=\"edit\" href=\"#\" title=\"<?php echo language::translate('title_edit', 'Edit'); ?>\"><?php echo functions::draw_fonticon('fa-pencil fa-fw'); ?></a>\n                <a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-lg fa-fw', 'style=\"color: #cc3333;\"'); ?></a>\n              </td>\n            </tr>\n            <?php } ?>\n          </tbody>\n          <tfoot>\n            <tr>\n              <td colspan=\"8\">\n                <a class=\"btn btn-default add-product\" href=\"<?php echo document::href_link('', ['doc' => 'product_picker'], ['app'], []); ?>\" data-toggle=\"lightbox\" data-width=\"\" data-href=\"<?php echo document::href_link('', ['doc' => 'product_picker'], ['app'], []); ?>\"><?php echo functions::draw_fonticon('fa-plus', 'style=\"color: #66cc66;\"'); ?> <?php echo language::translate('title_add_product', 'Add Product'); ?></a>\n                <div class=\"btn btn-default add-custom-item\"><?php echo functions::draw_fonticon('fa-plus', 'style=\"color: #66cc66;\"'); ?> <?php echo language::translate('title_add_custom_item', 'Add Custom Item'); ?></div>\n              </td>\n            </tr>\n          </tfoot>\n        </table>\n      </div>\n    </div>\n\n      <div id=\"order-total\" class=\"panel panel-default\">\n        <div class=\"panel-heading\">\n          <h2 class=\"panel-title\"><?php echo language::translate('title_order_total', 'Order Total'); ?></h2>\n        </div>\n\n        <div class=\"panel-body table-responsive\">\n          <table class=\"table table-striped table-hover\">\n            <thead>\n              <tr>\n                <th style=\"width: 30px;\">&nbsp;</th>\n                <th style=\"width: 250px;\"><?php echo language::translate('title_module_id', 'Module ID'); ?></th>\n                <th class=\"text-end\"><?php echo language::translate('title_title', 'Title'); ?></th>\n                <th style=\"width: 250px;\"><?php echo language::translate('title_value', 'Value'); ?></th>\n                <th style=\"width: 250px;\"><?php echo language::translate('title_tax', 'Tax'); ?></th>\n                <th style=\"width: 30px;\">&nbsp;</th>\n              </tr>\n            </thead>\n            <tbody>\n<?php\n  if (empty($_POST['order_total'])) {\n    $_POST['order_total'][] = [\n      'id' => '',\n      'module_id' => 'ot_subtotal',\n      'title' => language::translate('title_subtotal', 'Subtotal'),\n      'value' => '0',\n      'tax' => '0',\n      'calculate' => '0',\n    ];\n  }\n  foreach (array_keys($_POST['order_total']) as $key) {\n    switch($_POST['order_total'][$key]['module_id']) {\n      case 'ot_subtotal':\n?>\n              <tr>\n                <td class=\"text-end\">&nbsp;</td>\n                <td class=\"text-end\"><?php echo functions::form_draw_hidden_field('order_total['. $key .'][id]', true) . functions::form_draw_text_field('order_total['. $key .'][module_id]', true, 'readonly'); ?></td>\n                <td class=\"text-end\"><?php echo functions::form_draw_text_field('order_total['. $key .'][title]', true, 'class=\"form-control text-end\"'); ?></td>\n                <td class=\"text-end\">\n                  <div class=\"input-group\">\n                    <span class=\"input-group-text\"><?php echo functions::form_draw_checkbox('order_total['. $key .'][calculate]', '1', true, 'disabled title=\"'. functions::escape_html(language::translate('title_calculate', 'Calculate')).'\"'); ?></span>\n                    <?php echo functions::form_draw_currency_field($_POST['currency_code'], 'order_total['. $key .'][value]', true, 'style=\"text-align: end;\"'); ?>\n                  </div>\n                </td>\n                <td class=\"text-end\"><?php echo functions::form_draw_currency_field($_POST['currency_code'], 'order_total['. $key .'][tax]', true, 'style=\"text-align: end;\"'); ?></td>\n                <td></td>\n              </tr>\n<?php\n        break;\n      default:\n?>\n              <tr>\n                <td class=\"text-end\"><a href=\"#\" class=\"add\" title=\"<?php echo language::translate('text_insert_before', 'Insert before'); ?>\"><?php echo functions::draw_fonticon('fa-plus', 'style=\"color: #66cc66;\"'); ?></a></td>\n                <td class=\"text-end\"><?php echo functions::form_draw_hidden_field('order_total['. $key .'][id]', true) . functions::form_draw_text_field('order_total['. $key .'][module_id]', true); ?></td>\n                <td class=\"text-end\"><?php echo functions::form_draw_text_field('order_total['. $key .'][title]', true, 'style=\"text-align: end;\"'); ?></td>\n                <td class=\"text-end\">\n                  <div class=\"input-group\">\n                  <span class=\"input-group-text\"><?php echo functions::form_draw_checkbox('order_total['. $key .'][calculate]', '1', true, 'title=\"'. functions::escape_html(language::translate('title_calculate', 'Calculate')) .'\"'); ?></span>\n                  <?php echo functions::form_draw_currency_field($_POST['currency_code'], 'order_total['. $key .'][value]', true, 'style=\"text-align: end;\"'); ?>\n                  </div>\n                </td>\n                <td class=\"text-end\"><?php echo functions::form_draw_currency_field($_POST['currency_code'], 'order_total['. $key .'][tax]', true, 'style=\"text-align: end;\"'); ?></td>\n                <td><a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-lg fa-fw', 'style=\"color: #cc3333;\"'); ?></a></td>\n              </tr>\n<?php\n        break;\n    }\n  }\n?>\n              <tr>\n                <td colspan=\"6\"><a class=\"add\" href=\"#\" title=\"<?php echo language::translate('title_insert_', 'Insert'); ?>\"><?php echo functions::draw_fonticon('fa-plus', 'style=\"color: #66cc66;\"'); ?></a></td>\n              </tr>\n            </tbody>\n            <tfoot>\n              <tr>\n                <td colspan=\"6\" class=\"text-end\" style=\"font-size: 1.5em;\"><?php echo language::translate('title_payment_due', 'Payment Due'); ?>: <strong class=\"total\"><?php echo currency::format($order->data['payment_due'], false, $_POST['currency_code'], $_POST['currency_value']); ?></strong></td>\n              </tr>\n            </tfoot>\n          </table>\n        </div>\n      </div>\n\n      <div class=\"panel-action\">\n        <ul class=\"list-inline\">\n          <li>\n            <div class=\"checkbox\">\n              <label><?php echo functions::form_draw_checkbox('email_order_copy', '1', true); ?> <?php echo language::translate('text_send_order_copy_email', 'Send order copy email'); ?></label>\n            </div>\n          </li>\n          <li>\n            <div class=\"checkbox\">\n              <label><?php echo functions::form_draw_checkbox('unread', '1', false); ?> <?php echo language::translate('title_mark_as_unread', 'Mark as unread'); ?></label>\n            </div>\n          </li>\n          <li>\n            <div class=\"btn-group\">\n              <?php echo functions::form_draw_button('save', language::translate('title_save', 'Save'), 'submit', '', 'save'); ?>\n              <?php echo functions::form_draw_button('cancel', language::translate('title_cancel', 'Cancel'), 'button', 'onclick=\"history.go(-1);\"', 'cancel'); ?>\n              <?php echo (isset($order->data['id'])) ? functions::form_draw_button('delete', language::translate('title_delete', 'Delete'), 'submit', 'formnovalidate onclick=\"if (!window.confirm(\\''. language::translate('text_are_you_sure', 'Are you sure?') .'\\')) return false;\"', 'delete') : false; ?>\n            </div>\n          </li>\n        </ul>\n      </div>\n\n    <?php echo functions::form_draw_form_end(); ?>\n  </div>\n</div>\n\n<div id=\"modal-customer-picker\" class=\"modal fade\" style=\"max-width: 640px; display: none;\">\n\n  <h2><?php echo language::translate('title_customer', 'Customer'); ?></h2>\n\n  <div class=\"modal-body\">\n    <div class=\"form-group\">\n      <?php echo functions::form_draw_text_field('query', true, 'placeholder=\"'. functions::escape_html(language::translate('title_search', 'Search')) .'\"'); ?>\n    </div>\n\n    <div class=\"form-group results table-responsive\">\n      <table class=\"table table-striped table-hover data-table\">\n        <thead>\n          <tr>\n            <th><?php echo language::translate('title_id', 'ID'); ?></th>\n            <th><?php echo language::translate('title_name', 'Name'); ?></th>\n            <th class=\"main\"><?php echo language::translate('title_email', 'Email'); ?></th>\n            <th><?php echo language::translate('title_date_registered', 'Date Registered'); ?></th>\n          </tr>\n        </thead>\n        <tbody />\n      </table>\n\n      <p class=\"text-center\"><button class=\"set-guest btn btn-default\" type=\"button\"><?php echo language::translate('text_set_as_guest', 'Set As Guest'); ?></button></p>\n    </div>\n  </div>\n</div>\n\n<div id=\"modal-edit-order-item\" class=\"modal fade\" style=\"max-width: 640px; display: none;\">\n\n  <h2><?php echo language::translate('title_edit_order_item', 'Edit Order Item'); ?></h2>\n\n  <div class=\"modal-body\">\n\n    <div class=\"row\">\n      <div class=\"form-group col-md-9\">\n        <label><?php echo language::translate('title_name', 'Name'); ?></label>\n        <?php echo functions::form_draw_text_field('name', ''); ?>\n      </div>\n\n      <div class=\"form-group col-md-3\">\n        <label><?php echo language::translate('title_product_id', 'Product ID'); ?></label>\n        <?php echo functions::form_draw_number_field('product_id', ''); ?>\n      </div>\n    </div>\n\n    <div class=\"row\">\n      <div class=\"form-group col-md-4\">\n        <label><?php echo language::translate('title_sku', 'SKU'); ?></label>\n        <?php echo functions::form_draw_text_field('sku', ''); ?>\n      </div>\n\n      <div class=\"form-group col-md-4\">\n        <label><?php echo language::translate('title_gtin', 'GTIN'); ?></label>\n        <?php echo functions::form_draw_text_field('gtin', ''); ?>\n      </div>\n\n      <div class=\"form-group col-md-4\">\n        <label><?php echo language::translate('title_taric', 'TARIC'); ?></label>\n        <?php echo functions::form_draw_text_field('taric', ''); ?>\n      </div>\n    </div>\n\n    <div class=\"row\">\n      <div class=\"form-group col-md-4\">\n        <label><?php echo language::translate('title_weight', 'Weight'); ?></label>\n        <div class=\"input-group\">\n          <?php echo functions::form_draw_decimal_field('weight', '', 2, 0); ?>\n          <?php echo functions::form_draw_weight_classes_list('weight_class', settings::get('store_weight_class'), false, 'style=\"width: auto;\"'); ?>\n        </div>\n      </div>\n\n      <div class=\"form-group col-md-8\">\n        <label><?php echo language::translate('title_dimensions', 'Dimensions'); ?></label>\n        <div class=\"input-group\">\n          <?php echo functions::form_draw_decimal_field('dim_x', '', 1, 0); ?>\n          <span class=\"input-group-text\">x</span>\n          <?php echo functions::form_draw_decimal_field('dim_y', '', 1, 0); ?>\n          <span class=\"input-group-text\">x</span>\n          <?php echo functions::form_draw_decimal_field('dim_z', '', 1, 0); ?>\n          <?php echo functions::form_draw_length_classes_list('dim_class', settings::get('store_length_class'), false, 'style=\"width: auto;\"'); ?>\n        </div>\n      </div>\n    </div>\n\n    <div class=\"row\">\n        <div class=\"form-group col-md-4\">\n        <label><?php echo language::translate('title_quantity', 'quantity'); ?></label>\n        <?php echo functions::form_draw_decimal_field('quantity', ''); ?>\n      </div>\n\n        <div class=\"form-group col-md-4\">\n        <label><?php echo language::translate('title_price', 'Price'); ?></label>\n        <?php echo functions::form_draw_currency_field($_POST['currency_code'], 'price', ''); ?>\n      </div>\n\n        <div class=\"form-group col-md-4\">\n        <label><?php echo language::translate('title_tax', 'Tax'); ?></label>\n        <?php echo functions::form_draw_currency_field($_POST['currency_code'], 'tax', ''); ?>\n      </div>\n    </div>\n\n    <div class=\"btn-group\">\n      <?php echo functions::form_draw_button('ok', language::translate('title_ok', 'OK'), 'button', '', 'ok'); ?>\n      <?php echo functions::form_draw_button('cancel', language::translate('title_cancel', 'Cancel'), 'button', 'onclick=\"$.featherlight.close();\"', 'cancel'); ?>\n    </div>\n  </div>\n</div>\n\n<div id=\"modal-add-order-item\" class=\"modal fade\" style=\"max-width: 640px; display: none;\">\n\n  <h2><?php echo language::translate('title_add_order_item', 'Add Order Item'); ?></h2>\n\n  <div class=\"modal-body\">\n\n    <div class=\"row\">\n      <div class=\"form-group col-md-9\">\n        <label><?php echo language::translate('title_name', 'Name'); ?></label>\n        <?php echo functions::form_draw_text_field('name', ''); ?>\n      </div>\n\n      <div class=\"form-group col-md-3\">\n        <label><?php echo language::translate('title_product_id', 'Product ID'); ?></label>\n        <?php echo functions::form_draw_number_field('product_id', ''); ?>\n      </div>\n    </div>\n\n    <div class=\"row\">\n      <div class=\"form-group col-md-4\">\n        <label><?php echo language::translate('title_sku', 'SKU'); ?></label>\n        <?php echo functions::form_draw_text_field('sku', ''); ?>\n      </div>\n\n      <div class=\"form-group col-md-4\">\n        <label><?php echo language::translate('title_gtin', 'GTIN'); ?></label>\n        <?php echo functions::form_draw_text_field('gtin', ''); ?>\n      </div>\n\n      <div class=\"form-group col-md-4\">\n        <label><?php echo language::translate('title_taric', 'TARIC'); ?></label>\n        <?php echo functions::form_draw_text_field('taric', ''); ?>\n      </div>\n    </div>\n\n    <div class=\"row\">\n      <div class=\"form-group col-md-4\">\n        <label><?php echo language::translate('title_weight', 'Weight'); ?></label>\n        <div class=\"input-group\">\n          <?php echo functions::form_draw_decimal_field('weight', '', 2, 0); ?>\n          <?php echo functions::form_draw_weight_classes_list('weight_class', '', false, 'style=\"width: auto;\"'); ?>\n        </div>\n      </div>\n\n      <div class=\"form-group col-md-8\">\n        <label><?php echo language::translate('title_dimensions', 'Dimensions'); ?></label>\n        <div class=\"input-group\">\n          <?php echo functions::form_draw_decimal_field('dim_x', '', 1, 0); ?>\n          <span class=\"input-group-text\">x</span>\n          <?php echo functions::form_draw_decimal_field('dim_y', '', 1, 0); ?>\n          <span class=\"input-group-text\">x</span>\n          <?php echo functions::form_draw_decimal_field('dim_z', '', 1, 0); ?>\n          <?php echo functions::form_draw_length_classes_list('dim_class', '', false, 'style=\"width: auto;\"'); ?>\n        </div>\n      </div>\n    </div>\n\n    <div class=\"row\">\n        <div class=\"form-group col-md-4\">\n        <label><?php echo language::translate('title_quantity', 'quantity'); ?></label>\n        <?php echo functions::form_draw_decimal_field('quantity', '0'); ?>\n      </div>\n\n        <div class=\"form-group col-md-4\">\n        <label><?php echo language::translate('title_price', 'Price'); ?></label>\n        <?php echo functions::form_draw_currency_field($_POST['currency_code'], 'price', '0'); ?>\n      </div>\n\n        <div class=\"form-group col-md-4\">\n        <label><?php echo language::translate('title_tax', 'Tax'); ?></label>\n        <?php echo functions::form_draw_currency_field($_POST['currency_code'], 'tax', '0'); ?>\n      </div>\n    </div>\n\n    <div class=\"btn-group\">\n      <?php echo functions::form_draw_button('ok', language::translate('title_ok', 'OK'), 'button', '', 'ok'); ?>\n      <?php echo functions::form_draw_button('cancel', language::translate('title_cancel', 'Cancel'), 'button', 'onclick=\"$.featherlight.close();\"', 'cancel'); ?>\n    </div>\n  </div>\n</div>\n\n<script>\n// Order\n\n  $('select[name=\"currency_code\"]').change(function(e){\n    $('input[name=\"currency_value\"]').val($(this).find('option:selected').data('value'));\n    $('input[data-type=\"currency\"]').closest('.input-group').find('.input-group-text').text($(this).val());\n    calculate_total();\n  });\n\n// Customer\n\n  $('#customer-details button[name=\"get_address\"]').click(function() {\n    $.ajax({\n      url: '<?php echo document::link(WS_DIR_ADMIN, ['app' => 'customers', 'doc' => 'get_address.json']); ?>',\n      type: 'post',\n      data: 'customer_id=' + $('*[name=\"customer[id]\"]').val(),\n      cache: true,\n      async: false,\n      dataType: 'json',\n      error: function(jqXHR, textStatus, errorThrown) {\n        if (console) console.warn(errorThrown.message);\n      },\n      success: function(data) {\n        $.each(data, function(key, value) {\n          if (key.match(/^shipping_address/)) {\n            $.each(value, function(key, value) {\n              if ($('*[name=\"customer[shipping_address]['+key+']\"]').length) $('*[name=\"customer[shipping_address]['+key+']\"]').val(value).trigger('change');\n            });\n          } else {\n            if ($('*[name=\"customer['+key+']\"]').length) $('*[name=\"customer['+key+']\"]').val(value).trigger('change');\n          }\n        });\n      },\n    });\n  });\n\n  $('#customer-details select[name=\"customer[country_code]\"]').change(function() {\n\n    if ($(this).find('option:selected').data('tax-id-format')) {\n      $('input[name=\"customer[tax_id]\"]').attr('pattern', $(this).find('option:selected').data('tax-id-format'));\n    } else {\n      $('input[name=\"customer[tax_id]\"]').removeAttr('pattern');\n    }\n\n    if ($(this).find('option:selected').data('postcode-format')) {\n      $('input[name=\"customer[postcode]\"]').attr('pattern', $(this).find('option:selected').data('postcode-format'));\n    } else {\n      $('input[name=\"customer[postcode]\"]').removeAttr('pattern');\n    }\n\n    if ($(this).find('option:selected').data('phone-code')) {\n      $('input[name=\"customer[phone]\"]').attr('placeholder', '+' + $(this).find('option:selected').data('phone-code'));\n    } else {\n      $('input[name=\"customer[phone]\"]').removeAttr('placeholder');\n    }\n\n    $('body').css('cursor', 'wait');\n    $.ajax({\n      url: '<?php echo document::ilink('ajax/zones.json'); ?>?country_code=' + $(this).val(),\n      type: 'get',\n      cache: true,\n      async: false,\n      dataType: 'json',\n      error: function(jqXHR, textStatus, errorThrown) {\n        //alert(jqXHR.readyState + '\\n' + textStatus + '\\n' + errorThrown.message);\n      },\n      success: function(data) {\n        $('select[name=\"customer[zone_code]\"]').html('');\n        if ($('select[name=\"customer[zone_code]\"]').attr('disabled')) $('select[name=\"customer[zone_code]\"]').prop('disabled', false);\n        if (data) {\n          $.each(data, function(i, zone) {\n            $('select[name=\"customer[zone_code]\"]').append('<option value=\"'+ zone.code +'\">'+ zone.name +'</option>');\n          });\n        } else {\n          $('select[name=\"customer[zone_code]\"]').prop('disabled', true);\n        }\n      },\n      complete: function() {\n        $('body').css('cursor', 'auto');\n      }\n    });\n  });\n\n  $('#customer-details button[name=\"copy_billing_address\"]').click(function(){\n    fields = ['company', 'firstname', 'lastname', 'address1', 'address2', 'postcode', 'city', 'country_code', 'zone_code', 'phone'];\n    $.each(fields, function(key, field){\n      $('*[name=\"customer[shipping_address]['+ field +']\"]').val($('*[name=\"customer['+ field +']\"]').val()).trigger('change');\n    });\n  });\n\n  $('#customer-details select[name=\"customer[shipping_address][country_code]\"]').change(function(){\n\n    if ($(this).find('option:selected').data('postcode-format')) {\n      $('input[name=\"customer[shipping_address][postcode]\"]').attr('pattern', $(this).find('option:selected').data('postcode-format'));\n    } else {\n      $('input[name=\"customer[shipping_address][postcode]\"]').removeAttr('pattern');\n    }\n\n    if ($(this).find('option:selected').data('phone-code')) {\n      $('input[name=\"customer[shipping_address][phone]\"]').attr('placeholder', '+' + $(this).find('option:selected').data('phone-code'));\n    } else {\n      $('input[name=\"customer[shipping_address][phone]\"]').removeAttr('placeholder');\n    }\n\n    $('body').css('cursor', 'wait');\n    $.ajax({\n      url: '<?php echo document::ilink('ajax/zones.json'); ?>?country_code=' + $(this).val(),\n      type: 'get',\n      cache: true,\n      async: true,\n      dataType: 'json',\n      error: function(jqXHR, textStatus, errorThrown) {\n        //alert(jqXHR.readyState + '\\n' + textStatus + '\\n' + errorThrown.message);\n      },\n      success: function(data) {\n        $('select[name=\"customer[shipping_address][zone_code]\"]').html('');\n        if ($('select[name=\"customer[shipping_address][zone_code]\"]').attr('disabled')) $('select[name=\"customer[shipping_address][zone_code]\"]').prop('disabled', false);\n        if (data) {\n          $.each(data, function(i, zone) {\n            $('select[name=\"customer[shipping_address][zone_code]\"]').append('<option value=\"'+ zone.code +'\">'+ zone.name +'</option>');\n          });\n        } else {\n          $('select[name=\"customer[shipping_address][zone_code]]\"]').prop('disabled', true);\n        }\n      },\n      complete: function() {\n        $('body').css('cursor', 'auto');\n      }\n    });\n  });\n\n  if ($('select[name=\"customer[country_code]\"] option:selected').data('tax-id-format')) {\n    $('input[name=\"customer[tax_id]\"]').attr('pattern', $('select[name=\"country_code\"] option:selected').data('tax-id-format'));\n  } else {\n    $('input[name=\"customer[tax_id]\"]').removeAttr('pattern');\n  }\n\n  if ($('select[name=\"customer[country_code]\"] option:selected').data('postcode-format')) {\n    $('input[name=\"customer[postcode]\"]').attr('pattern', $('select[name=\"customer[country_code]\"] option:selected').data('postcode-format'));\n  } else {\n    $('input[name=\"customer[postcode]\"]').removeAttr('pattern');\n  }\n\n  if ($('select[name=\"customer[country_code]\"] option:selected').data('phone-code')) {\n    $('input[name=\"customer[phone]\"]').attr('placeholder', '+' + $('select[name=\"customer[country_code]\"] option:selected').data('phone-code'));\n  } else {\n    $('input[name=\"customer[phone]\"]').removeAttr('placeholder');\n  }\n\n  if ($('select[name=\"customer[shipping_address][country_code]\"] option:selected').data('postcode-format')) {\n    $('input[name=\"customer[shipping_address][postcode]\"]').attr('pattern', $('select[name=\"customer[shipping_address][country_code]\"] option:selected').data('postcode-format'));\n  } else {\n    $('input[name=\"customer[shipping_address][postcode]\"]').removeAttr('pattern');\n  }\n\n  if ($('select[name=\"customer[shipping_address][country_code]\"] option:selected').data('phone-code')) {\n    $('input[name=\"customer[shipping_address][phone]\"]').attr('placeholder', '+' + $('select[name=\"customer[shipping_address][country_code]\"] option:selected').data('phone-code'));\n  } else {\n    $('input[name=\"customer[shipping_address][phone]\"]').removeAttr('placeholder');\n  }\n\n  $('select[name=\"language_code\"], select[name=\"currency_code\"], input[name=\"currency_value\"], :input[name^=\"customer\"]').on('input change', function(){\n    var params = {\n      language_code: $('select[name=\"language_code\"]').val(),\n      currency_code: $('select[name=\"currency_code\"]').val(),\n      currency_value: $('input[name=\"currency_value\"]').val(),\n      customer: {\n        id: $(':input[name=\"customer[id]\"]').val(),\n        tax_id: $('input[name=\"customer[tax_id]\"]').val(),\n        company: $('input[name=\"customer[company]\"]').val(),\n        country_code: $('select[name=\"customer[country_code]\"]').val(),\n        zone_code: $('select[name=\"customer[zone_code]\"]').val(),\n        city: $('select[name=\"customer[city]\"]').val(),\n        shipping_address: {\n          company: $('input[name=\"customer[shipping_address][company]\"]').val(),\n          country_code: $('select[name=\"customer[shipping_address][country_code]\"]').val(),\n          zone_code: $('select[name=\"customer[shipping_address][zone_code]\"]').val(),\n          city: $('select[name=\"customer[shipping_address][city]\"]').val(),\n        }\n      }\n    }\n\n    $('.add-product').attr('href', $('.add-product').data('href') +'&'+ $.param(params));\n  });\n\n  $(':input[name^=\"customer\"]').first().trigger('input');\n\n// Comments\n\n  $('#box-comments').on('input', 'textarea[name^=\"comments\"][name$=\"[text]\"]', function(){\n    $(this).height('auto').height('calc(' + $(this).prop('scrollHeight') + 'px + 1em) ');\n  }).trigger('input');\n\n  $(\"#comments\").animate({scrollTop: $('#comments').prop('scrollHeight')}, 2000);\n\n  var new_comment_index = 0;\n  $('#box-comments .add').click(function(e) {\n\n    e.preventDefault();\n    while ($('input[name=\"comments[new_'+new_comment_index+'][id]\"]').length) new_comment_index++;\n    var output = '  <div class=\"bubble local me\">'\n               + '    <?php echo functions::form_draw_hidden_field('comments[new_comment_index][id]', ''); ?>'\n               + '    <?php echo functions::form_draw_hidden_field('comments[new_comment_index][author]', 'staff'); ?>'\n               + '    <?php echo functions::form_draw_hidden_field('comments[new_comment_index][date_created]', language::strftime(language::$selected['format_datetime'])); ?>'\n               + '    <div class=\"text\"><?php echo functions::escape_js(functions::form_draw_textarea('comments[new_comment_index][text]', '')); ?></div>'\n               + '    <div class=\"date\"><?php echo language::strftime(language::$selected['format_datetime']); ?></div>'\n               + '    <div class=\"actions\">'\n               + '      <label class=\"notify\" title=\"<?php echo functions::escape_html(language::translate('title_notify', 'Notify')); ?>\"><?php echo functions::form_draw_checkbox('comments[new_comment_index][notify]', 1, true); ?> <?php echo functions::draw_fonticon('fa-envelope'); ?></label>'\n               + '      <label class=\"private\" title=\"<?php echo functions::escape_html(language::translate('title_hidden', 'Hidden')); ?>\"><?php echo functions::form_draw_checkbox('comments[new_comment_index][hidden]', 1, true); ?> <?php echo functions::draw_fonticon('fa-eye-slash'); ?></label>'\n               + '      <a class=\"remove\" href=\"#\" title=\"<?php echo language::translate('title_remove', 'Remove'); ?>\"><?php echo functions::draw_fonticon('fa-times-circle fa-lg fa-fw'); ?></a>'\n               + '    </div>'\n               + '  </div>';\n    output = output.replace(/new_comment_index/g, 'new_' + new_comment_index);\n    $(this).before(output);\n    $(this).closest('#box-comments .bubbles textarea:last-child').focus();\n  });\n\n  $('#box-comments').on('click', ':input[name$=\"[hidden]\"]', function(e) {\n    $(this).closest('.bubble').find(':input[name$=\"[notify]\"]').prop('checked', false).trigger('change');\n  });\n\n  $('#box-comments').on('click', ':input[name$=\"[notify]\"]', function(e) {\n    $(this).closest('.bubble').find(':input[name$=\"[hidden]\"]').prop('checked', false).trigger('change');\n  });\n\n  $('#box-comments').on('click', '.remove', function(e) {\n    e.preventDefault();\n    $(this).closest('.bubble').remove();\n  });\n\n  $('#box-comments .bubbles').on('change', 'input[name^=\"comments\"][name$=\"[hidden]\"]', function(e) {\n    if ($(this).is(':checked')) {\n      $(this).closest('.bubble').addClass('semi-transparent');\n    } else {\n      $(this).closest('.bubble').removeClass('semi-transparent');\n    }\n  });\n\n// Order items\n\n  $('#order-items').on('click', '.edit', function(){\n    $.featherlight('#modal-edit-order-item');\n\n    var modal = $('.featherlight.active'),\n        row = $(this).closest('tr');\n\n    $(modal).data('row', row);\n\n    $.each($(modal).find(':input'), function(i,element){\n      var field = $(element).attr('name');\n      var value = $(row).find(':input[name$=\"['+field+']\"]').val();\n      if ($(modal).find(':input[name=\"'+field+'\"]').attr('type') == 'number') value = parseFloat(value || 0);\n      $(modal).find(':input[name=\"'+field+'\"]').val(value);\n    });\n  });\n\n  $('#order-items .add-custom-item').click(function(){\n    $.featherlight('#modal-add-order-item');\n\n    var modal = $('.featherlight.active'),\n        row = $(this).closest('tr');\n\n    $(modal).data('row', '');\n  });\n\n  $('#modal-edit-order-item button[name=\"ok\"]').click(function(e){\n\n    var modal = $('.featherlight.active');\n    var row = $(modal).data('row');\n    var fields = [\n      'name',\n      'sku',\n      'gtin',\n      'taric',\n      'weight',\n      'weight_class',\n      'dim_x',\n      'dim_y',\n      'dim_z',\n      'dim_class',\n      'price',\n      'tax',\n    ];\n\n    if (row == '') {\n      var item = {};\n      $.each($(modal).find(':input'), function(i,element){\n        var field = $(element).attr('name');\n        item[field] = $(modal).find(':input[name=\"'+field+'\"]').val();\n      });\n      addItem(item);\n    }\n\n    $(modal).find(':input[name=\"weight_class\"]').val('<?php echo settings::get('store_weight_class'); ?>');\n    $(modal).find(':input[name=\"length_class\"]').val('<?php echo settings::get('store_length_class'); ?>');\n\n    $.each($(modal).find(':input'), function(i,element){\n      var field = $(element).attr('name');\n      var value = $(modal).find(':input[name=\"'+field+'\"]').val();\n      $(row).find(':input[name$=\"['+field+']\"]').val(value).trigger('keyup');\n      $(row).find('.'+field).text(value);\n    });\n\n    $.featherlight.close();\n  });\n\n  $('#modal-add-order-item button[name=\"ok\"]').click(function(e){\n\n    var modal = $('.featherlight.active');\n    var row = $(modal).data('row');\n    var item = {};\n    var fields = [\n      'name',\n      'sku',\n      'gtin',\n      'taric',\n      'weight',\n      'weight_class',\n      'dim_x',\n      'dim_y',\n      'dim_z',\n      'dim_class',\n      'price',\n      'tax',\n    ];\n\n    $.each($(modal).find(':input'), function(i,element){\n      var field = $(element).attr('name');\n      item[field] = $(modal).find(':input[name=\"'+field+'\"]').val();\n    });\n\n    addItem(item);\n\n    $.featherlight.close();\n  });\n\n  var new_item_index = 0;\n  window.addItem = function(item) {\n    new_item_index++;\n\n    var output = '  <tr class=\"item\">'\n               + '    <td>' + item.name\n               + '      <?php echo functions::escape_js(functions::form_draw_hidden_field('items[new_item_index][id]', '')); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_hidden_field('items[new_item_index][product_id]', '')); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_hidden_field('items[new_item_index][option_stock_combination]', '')); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_hidden_field('items[new_item_index][options]', '')); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_hidden_field('items[new_item_index][name]', '')); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_hidden_field('items[new_item_index][sku]', '')); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_hidden_field('items[new_item_index][gtin]', '')); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_hidden_field('items[new_item_index][taric]', '')); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_hidden_field('items[new_item_index][weight]', '')); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_hidden_field('items[new_item_index][weight_class]', '')); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_hidden_field('items[new_item_index][dim_x]', '')); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_hidden_field('items[new_item_index][dim_y]', '')); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_hidden_field('items[new_item_index][dim_z]', '')); ?>'\n               + '      <?php echo functions::escape_js(functions::form_draw_hidden_field('items[new_item_index][dim_class]', '')); ?>'\n               + '    </td>'\n               + '    <td>'+ item.sku +'</td>'\n               + '    <td>'\n               + '      <span class=\"weight\"></span> <span class=\"weight_class\"></span>'\n               + '    </td>'\n               + '    <td>'\n               + '      <span class=\"dim_x\"></span> x <span class=\"dim_y\"></span> x <span class=\"dim_z\"></span> <span class=\"dim_class\"></span>'\n               + '    </td>'\n               + '    <td><?php echo functions::escape_js(functions::form_draw_decimal_field('items[new_item_index][quantity]', '', 2)); ?></td>'\n               + '    <td><?php echo functions::escape_js(functions::form_draw_currency_field($_POST['currency_code'], 'items[new_item_index][price]', '')); ?></td>'\n               + '    <td><?php echo functions::escape_js(functions::form_draw_currency_field($_POST['currency_code'], 'items[new_item_index][tax]', '')); ?></td>'\n               + '    <td class=\"text-end\">'\n               + '      <a class=\"edit\" href=\"#\" title=\"<?php echo functions::escape_js(language::translate('title_edit', 'Edit'), true); ?>\"><?php echo functions::escape_js(functions::draw_fonticon('fa-pencil fa-fw')); ?></a>'\n               + '      <a class=\"remove\" href=\"#\" title=\"<?php echo functions::escape_js(language::translate('title_remove', 'Remove'), true); ?>\"><?php echo functions::escape_js(functions::draw_fonticon('fa-times-circle fa-lg fa-fw', 'style=\"color: #cc3333;\"')); ?></a>'\n               + '    </td>'\n               + '  </tr>';\n\n    output = output.replace(/new_item_index/g, 'new_' + new_item_index);\n    $('#order-items tbody').append(output);\n\n    var row = $('#order-items tbody tr.item').last();\n    $(row).find('*[name$=\"[product_id]\"]').val(item.product_id);\n    $(row).find('*[name$=\"[sku]\"]').val(item.sku);\n    $(row).find('*[name$=\"[option_stock_combination]\"]').val(item.option_stock_combination);\n    $(row).find('*[name$=\"[name]\"]').val(item.name);\n    $(row).find('*[name$=\"[gtin]\"]').val(item.gtin);\n    $(row).find('*[name$=\"[taric]\"]').val(item.taric);\n    $(row).find('*[name$=\"[weight]\"]').val(item.weight);\n    $(row).find('*[name$=\"[weight_class]\"]').val(item.weight_class);\n    $(row).find('*[name$=\"[dim_x]\"]').val(item.dim_x);\n    $(row).find('*[name$=\"[dim_y]\"]').val(item.dim_y);\n    $(row).find('*[name$=\"[dim_z]\"]').val(item.dim_z);\n    $(row).find('*[name$=\"[dim_class]\"]').val(item.dim_class);\n    $(row).find('*[name$=\"[quantity]\"]').val(item.quantity);\n    $(row).find('*[name$=\"[price]\"]').val(item.price);\n    $(row).find('*[name$=\"[tax]\"]').val(item.tax);\n\n    $(row).find('[data-type=\"currency\"]').parent().find('.input-group-text').text($(':input[name=\"currency_code\"]').val());\n    $(row).find('.weight').text(String(item.weight).trim('.0'));\n    $(row).find('.weight_class').text(item.weight_class);\n    $(row).find('.dim_x').text(String(item.dim_x).trim('.0'));\n    $(row).find('.dim_y').text(String(item.dim_y).trim('.0'));\n    $(row).find('.dim_z').text(String(item.dim_z).trim('.0'));\n    $(row).find('.dim_class').text(item.dim_class);\n\n    if (item.options) {\n      var product_options = '';\n      $.each(item.options, function(group, value) {\n        product_options += '<div>'\n                         + '  - '+ group +': ';\n        if ($.isArray(value)) {\n          $.each(value, function(i, array_value) {\n            product_options += '<input type=\"hidden\" name=\"items[new_'+ new_item_index +'][options]['+ group +'][]\" value=\"'+ array_value +'\" />' + array_value +', ';\n          });\n          product_options = product_options.substring(0, product_options.length - 2);\n        } else {\n          product_options += '<input type=\"hidden\" name=\"items[new_'+ new_item_index +'][options]['+ group +']\" value=\"'+ value +'\" />' + value;\n        }\n        product_options += '</div>';\n      });\n      $(row).find('input[type=\"hidden\"][name$=\"[options]\"]').replaceWith(product_options);\n    }\n\n    calculate_total();\n  }\n\n  $('#order-items').on('click', '.remove', function(e) {\n    e.preventDefault();\n    $(this).closest('tr').remove();\n  });\n\n// Order Total\n\n  var new_ot_row_index = 0;\n  $('#order-total').on('click', '.add', function(e) {\n    while ($('input[name=\"order_total['+new_ot_row_index+'][id]\"]').length) new_ot_row_index++;\n    e.preventDefault();\n    var output = '  <tr>'\n               + '    <td class=\"text-end\"><a href=\"#\" class=\"add\" title=\"<?php echo functions::escape_js(language::translate('text_insert_before', 'Insert before'), true); ?>\"><?php echo functions::escape_js(functions::draw_fonticon('fa-plus', 'style=\"color: #66cc66;\"')); ?></a></td>'\n               + '    <td class=\"text-end\"><?php echo functions::escape_js(functions::form_draw_hidden_field('order_total[new_ot_row_index][id]', '')); ?><?php echo functions::escape_js(functions::form_draw_text_field('order_total[new_ot_row_index][module_id]', '')); ?></td>'\n               + '    <td class=\"text-end\"><?php echo functions::escape_js(functions::form_draw_text_field('order_total[new_ot_row_index][title]', '', 'style=\"text-align: end;\"')); ?></td>'\n               + '    <td class=\"text-end\">'\n               + '      <div class=\"input-group\">'\n               + '        <span class=\"input-group-text\"><?php echo functions::escape_js(functions::form_draw_checkbox('order_total[new_ot_row_index][calculate]', '1', '1', 'title=\"'. functions::escape_html(language::translate('title_calculate', 'Calculate')) .'\"')); ?></span>'\n               + '        <?php echo functions::escape_js(functions::form_draw_currency_field($_POST['currency_code'], 'order_total[new_ot_row_index][value]', '0', 'style=\"text-align: end;\"')); ?>'\n               + '      </div>'\n               + '    </td>'\n               + '    <td class=\"text-end\"><?php echo functions::escape_js(functions::form_draw_currency_field($_POST['currency_code'], 'order_total[new_ot_row_index][tax]', currency::format_raw(0), 'style=\"text-align: end;\"')); ?></td>'\n               + '    <td><a class=\"remove\" href=\"#\" title=\"<?php echo functions::escape_js(language::translate('title_remove', 'Remove'), true); ?>\"><?php echo functions::escape_js(functions::draw_fonticon('fa-times-circle fa-lg fa-fw', 'style=\"color: #cc3333;\"')); ?></a></td>'\n               + '  </tr>';\n  output = output.replace(/new_ot_row_index/g, 'new_' + new_ot_row_index);\n  $(this).closest('tr').before(output);\n  new_ot_row_index++;\n  });\n\n  $('#order-total').on('click', '.remove', function(e) {\n    e.preventDefault();\n  $(this).closest('tr').remove();\n  });\n\n  function calculate_total() {\n\n    var subtotal = 0;\n    $('input[name^=\"items[\"][name$=\"[price]\"]').each(function() {\n      subtotal += parseFloat($(this).val() || 0) * parseFloat($(this).closest('tr').find('input[name^=\"items[\"][name$=\"[quantity]\"]').val() || 0);\n    });\n    subtotal = parseFloat(subtotal.toFixed($('select[name=\"currency_code\"] option:selected').data('decimals')) || 0);\n    $('input[name^=\"order_total[\"][value=\"ot_subtotal\"]').closest('tr').find('input[name^=\"order_total[\"][name$=\"[value]\"]').val(subtotal);\n\n    var subtotal_tax = 0;\n    $('input[name^=\"items[\"][name$=\"[tax]\"]').each(function() {\n      subtotal_tax += parseFloat($(this).val() || 0) * parseFloat($(this).closest('tr').find('input[name^=\"items[\"][name$=\"[quantity]\"]').val() || 0);\n    });\n    subtotal_tax = parseFloat(subtotal_tax.toFixed($('select[name=\"currency_code\"] option:selected').data('decimals')) || 0);\n    $('input[name^=\"order_total[\"][value=\"ot_subtotal\"]').closest('tr').find('input[name^=\"order_total[\"][name$=\"[tax]\"]').val(subtotal_tax);\n\n    var order_total = subtotal + subtotal_tax;\n    $('input[name^=\"order_total[\"][name$=\"[value]\"]').each(function() {\n      if ($(this).closest('tr').find('input[name^=\"order_total[\"][name$=\"[calculate]\"]').is(':checked')) {\n        order_total += parseFloat($(this).val() || 0);\n      }\n    });\n\n    $('input[name^=\"order_total[\"][name$=\"[tax]\"]').each(function() {\n      if ($(this).closest('tr').find('input[name^=\"order_total[\"][name$=\"[calculate]\"]').is(':checked')) {\n        order_total += parseFloat($(this).val() || 0);\n      }\n    });\n\n    order_total = parseFloat(order_total.toFixed($('select[name=\"currency_code\"] option:selected').data('decimals')) || 0);\n    $('#order-total .total').text($('select[name=\"currency_code\"] option:selected').data('prefix') + order_total + $('select[name=\"currency_code\"] option:selected').data('suffix'));\n  }\n\n  $('body').on('click keyup', 'input[name^=\"items\"][name$=\"[price]\"], input[name^=\"items\"][name$=\"[tax]\"], input[name^=\"items\"][name$=\"[quantity]\"], input[name^=\"order_total\"][name$=\"[value]\"], input[name^=\"order_total\"][name$=\"[tax]\"], input[name^=\"order_total\"][name$=\"[calculate]\"], #order-items a.remove, #order-total a.remove', function() {\n    calculate_total();\n  });\n</script>", "<?php\n\n  if (empty($_GET['page']) || !is_numeric($_GET['page'])) $_GET['page'] = 1;\n  if (!isset($_GET['order_status_id'])) $_GET['order_status_id'] = '';\n  if (empty($_GET['sort'])) $_GET['sort'] = 'date_created';\n\n  document::$snippets['title'][] = language::translate('title_orders', 'Orders');\n\n  breadcrumbs::add(language::translate('title_orders', 'Orders'));\n\n  if (isset($_POST['star']) || isset($_POST['unstar'])) {\n    database::query(\n      \"update \". DB_TABLE_PREFIX .\"orders\n      set starred = \". (isset($_POST['star']) ? 1 : 0) .\"\n      where id = \". (int)$_POST['order_id'] .\"\n      limit 1;\"\n    );\n    exit;\n  }\n\n  if (!empty($_POST['order_action'])) {\n\n    try {\n\n      if (empty($_POST['orders'])) throw new Exception(language::translate('error_must_select_orders', 'You must select orders to perform the operation'));\n\n      list($module_id, $action_id) = explode(':', $_POST['order_action']);\n\n      $order_action = new mod_order();\n\n      $actions = $order_action->actions();\n\n      if (!method_exists($order_action->modules[$module_id], $actions[$module_id]['actions'][$action_id]['function'])) {\n        throw new Exception(language::translate('error_method_doesnt_exist', 'The method doesn\\'t exist'));\n      }\n\n      sort($_POST['orders']);\n\n      ob_start();\n\n      if ($result = call_user_func([$order_action->modules[$module_id], $actions[$module_id]['actions'][$action_id]['function']], $_POST['orders'])) {\n        echo $result;\n      }\n\n    // Backwards compatibility\n      if ($output = ob_get_clean()) {\n        echo $output;\n        return;\n      }\n\n      header('Location: '. $_SERVER['REQUEST_URI']);\n      exit;\n\n    } catch (Exception $e) {\n      notices::add('errors', $e->getMessage());\n    }\n  }\n\n// Table Rows\n  $orders = [];\n\n  if (!empty($_GET['query'])) {\n    $sql_where_query = [\n      \"o.id = '\". database::input($_GET['query']) .\"'\",\n      \"o.uid = '\". database::input($_GET['query']) .\"'\",\n      \"o.reference like '%\". database::input($_GET['query']) .\"%'\",\n      \"o.customer_email like '%\". database::input($_GET['query']) .\"%'\",\n      \"o.customer_tax_id like '%\". database::input($_GET['query']) .\"%'\",\n      \"concat(o.customer_company, '\\\\n', o.customer_firstname, ' ', o.customer_lastname, '\\\\n', o.customer_address1, '\\\\n', o.customer_address2, '\\\\n', o.customer_postcode, '\\\\n', o.customer_city) like '%\". database::input($_GET['query']) .\"%'\",\n      \"concat(o.shipping_company, '\\\\n', o.shipping_firstname, ' ', o.shipping_lastname, '\\\\n', o.shipping_address1, '\\\\n', o.shipping_address2, '\\\\n', o.shipping_postcode, '\\\\n', o.shipping_city) like '%\". database::input($_GET['query']) .\"%'\",\n      \"o.payment_option_id like '%\". database::input($_GET['query']) .\"%'\",\n      \"o.payment_option_name like '%\". database::input($_GET['query']) .\"%'\",\n      \"o.payment_transaction_id like '\". database::input($_GET['query']) .\"'\",\n      \"o.shipping_option_id like '%\". database::input($_GET['query']) .\"%'\",\n      \"o.shipping_option_name like '%\". database::input($_GET['query']) .\"%'\",\n      \"o.shipping_tracking_id like '\". database::input($_GET['query']) .\"'\",\n      \"o.id in (\n        select distinct order_id from \". DB_TABLE_PREFIX .\"orders_items\n        where name like '%\". database::input($_GET['query']) .\"%'\n        or sku like '%\". database::input($_GET['query']) .\"%'\n      )\",\n      \"o.order_status_id in (\n        select distinct order_status_id from \". DB_TABLE_PREFIX .\"order_statuses_info\n        where language_code = '\". database::input(language::$selected['code']) .\"'\n        and name like '%\". database::input($_GET['query']) .\"%'\n      )\",\n    ];\n  }\n\n  switch($_GET['order_status_id']) {\n    case '':\n      $sql_where_order_status = \"and (o.order_status_id = 0 or os.is_archived = 0 or unread = 1)\";\n      break;\n    case 'archived':\n      $sql_where_order_status = \"and (os.is_archived = 1)\";\n      break;\n    case 'all':\n      break;\n    default:\n      $sql_where_order_status =  \"and o.order_status_id = \". (int)$_GET['order_status_id'];\n      break;\n  }\n\n  switch($_GET['sort']) {\n    case 'id':\n      $sql_sort = \"o.starred desc, o.id desc\";\n      break;\n    case 'country':\n      $sql_sort = \"o.starred desc, o.customer_country_code\";\n      break;\n    case 'customer':\n      $sql_sort = \"o.starred desc, if(o.customer_company, o.customer_company, concat(o.customer_firstname, ' ', o.customer_lastname)) asc\";\n      break;\n    case 'order_status':\n      $sql_sort = \"o.starred desc, os.name asc\";\n      break;\n    case 'payment_method':\n      $sql_sort = \"o.starred desc, o.payment_option_name asc\";\n      break;\n    default:\n      $sql_sort = \"o.starred desc, o.date_created desc, o.id desc\";\n      break;\n  }\n\n  $orders_query = database::query(\n    \"select o.*, os.color as order_status_color, os.icon as order_status_icon, osi.name as order_status_name from \". DB_TABLE_PREFIX .\"orders o\n    left join \". DB_TABLE_PREFIX .\"order_statuses os on (os.id = o.order_status_id)\n    left join \". DB_TABLE_PREFIX .\"order_statuses_info osi on (osi.order_status_id = o.order_status_id and osi.language_code = '\". database::input(language::$selected['code']) .\"')\n    where o.id\n    \". (!empty($sql_where_query) ? \"and (\". implode(\" or \", $sql_where_query) .\")\" : \"\") .\"\n    \". (!empty($sql_where_order_status) ? $sql_where_order_status : \"\") .\"\n    \". (!empty($_GET['date_from']) ? \"and o.date_created >= '\". date('Y-m-d H:i:s', strtotime($_GET['date_from'])) .\"'\" : '') .\"\n    \". (!empty($_GET['date_to']) ? \"and o.date_created <= '\". date('Y-m-d H:i:s', strtotime($_GET['date_to'])) .\"'\" : '') .\"\n    order by $sql_sort;\"\n  );\n\n  if ($_GET['page'] > 1) database::seek($orders_query, settings::get('data_table_rows_per_page') * ($_GET['page'] - 1));\n\n  $page_items = 0;\n  while ($order = database::fetch($orders_query)) {\n\n    if (empty($order['order_status_id'])) {\n      $order['order_status_icon'] = 'fa-minus';\n      $order['order_status_color'] = '#cccccc';\n    }\n\n    if (empty($order['order_status_icon'])) $order['order_status_icon'] = 'fa-circle-thin';\n    if (empty($order['order_status_color'])) $order['order_status_color'] = '#ccc';\n\n    $order['css_classes'] = [];\n    if (empty($order['order_status_id'])) $order['css_classes'][]= 'semi-transparent';\n    if (!empty($order['unread'])) $order['css_classes'][]= 'bold';\n\n    $orders[] = $order;\n\n    if (++$page_items == settings::get('data_table_rows_per_page')) break;\n  }\n\n// Number of Rows\n  $num_rows = database::num_rows($orders_query);\n\n// Pagination\n  $num_pages = ceil($num_rows/settings::get('data_table_rows_per_page'));\n\n\n// Order Statuses\n  $order_status_options = [\n    [\n      'label' => language::translate('title_collections', 'Collections'),\n      'options' => [\n        [language::translate('title_current', 'Current Orders'), ''],\n        [language::translate('title_archived_orders', 'Archived Orders'), 'archived'],\n        [language::translate('title_all_orders', 'All Orders'), 'all'],\n      ],\n    ],\n    [\n      'label' => language::translate('title_order_statuses', 'Order Statuses'),\n      'options' => [],\n    ],\n  ];\n\n  $order_statuses_query = database::query(\n    \"select os.*, osi.name, o.num_orders from \". DB_TABLE_PREFIX .\"order_statuses os\n    left join \". DB_TABLE_PREFIX .\"order_statuses_info osi on (os.id = osi.order_status_id and language_code = '\". database::input(language::$selected['code']) .\"')\n    left join (\n      select order_status_id, count(id) as num_orders\n      from \". DB_TABLE_PREFIX .\"orders\n      group by order_status_id\n    ) o on (o.order_status_id = os.id)\n    order by os.priority, osi.name;\"\n  );\n\n  while ($order_status = database::fetch($order_statuses_query)) {\n    $order_status_options[1]['options'][] = [$order_status['name'] . ' ('. language::number_format((int)$order_status['num_orders'], 0) .')', $order_status['id']];\n  }\n\n// Actions\n  $order_actions = [];\n\n  $mod_order = new mod_order();\n  if ($modules = $mod_order->actions()) {\n    foreach ($modules as $module) {\n      $order_actions[] = $module;\n    }\n  }\n\n?>\n<style>\ntable tr.bold {\n  font-weight: bold;\n}\n\ntable .fa-star-o:hover {\n  transform: scale(1.5);\n}\ntable .fa-star:hover {\n  transform: scale(1.5);\n}\n\n#order-actions li {\n  vertical-align: middle;\n}\n#order-actions li fieldset {\n  border: 1px #ccc solid;\n}\n#order-actions li fieldset legend {\n  color: #999;\n}\n</style>\n\n<div class=\"panel panel-app\">\n  <div class=\"panel-heading\">\n    <?php echo $app_icon; ?> <?php echo language::translate('title_orders', 'Orders'); ?>\n  </div>\n\n  <div class=\"panel-action\">\n    <ul class=\"list-inline\">\n      <li><?php echo functions::form_draw_link_button(document::link(WS_DIR_ADMIN, ['doc' => 'edit_order', 'redirect_url' => $_SERVER['REQUEST_URI']], true), language::translate('title_create_new_order', 'Create New Order'), '', 'add'); ?></li>\n    </ul>\n  </div>\n\n  <?php echo functions::form_draw_form_begin('search_form', 'get'); ?>\n    <?php echo functions::form_draw_hidden_field('app', true); ?>\n    <?php echo functions::form_draw_hidden_field('doc', true); ?>\n    <div class=\"panel-filter\">\n      <div class=\"expandable\"><?php echo functions::form_draw_search_field('query', true, 'placeholder=\"'. language::translate('text_search_phrase_or_keyword', 'Search phrase or keyword').'\"'); ?></div>\n      <div><?php echo functions::form_draw_select_optgroup_field('order_status_id', $order_status_options, true, false, 'style=\"width: auto;\"'); ?></div>\n      <div class=\"input-group\" style=\"max-width: 450px;\">\n        <?php echo functions::form_draw_datetime_field('date_from', true); ?>\n        <span class=\"input-group-text\"> - </span>\n        <?php echo functions::form_draw_datetime_field('date_to', true); ?>\n      </div>\n      <div><?php echo functions::form_draw_button('filter', language::translate('title_search', 'Search'), 'submit'); ?></div>\n    </div>\n  <?php echo functions::form_draw_form_end(); ?>\n\n  <div class=\"panel-body\">\n    <?php echo functions::form_draw_form_begin('orders_form', 'post'); ?>\n\n      <table class=\"table table-striped table-hover table-sortable data-table\">\n        <thead>\n          <tr>\n            <th><?php echo functions::draw_fonticon('fa-check-square-o fa-fw checkbox-toggle', 'data-toggle=\"checkbox-toggle\"'); ?></th>\n            <th></th>\n            <th data-sort=\"id\"><?php echo language::translate('title_id', 'ID'); ?></th>\n            <th></th>\n            <th data-sort=\"customer\" class=\"main\"><?php echo language::translate('title_customer_name', 'Customer Name'); ?></th>\n            <th data-sort=\"country\"><?php echo language::translate('title_country', 'Country'); ?></th>\n            <th data-sort=\"payment_method\"><?php echo language::translate('title_payment_method', 'Payment Method'); ?></th>\n            <th class=\"text-center\"><?php echo language::translate('title_amount', 'Amount'); ?></th>\n            <th class=\"text-center\"><?php echo language::translate('title_tax', 'Tax'); ?></th>\n            <th data-sort=\"order_status\" class=\"text-center\"><?php echo language::translate('title_order_status', 'Order Status'); ?></th>\n            <th data-sort=\"date_created\"><?php echo language::translate('title_date', 'Date'); ?></th>\n            <th></th>\n          </tr>\n        </thead>\n\n        <tbody>\n          <?php foreach ($orders as $order) { ?>\n          <tr class=\"<?php echo implode(' ', $order['css_classes']); ?>\" data-id=\"<?php echo $order['id']; ?>\">\n            <td><?php echo functions::form_draw_checkbox('orders[]', $order['id'], true); ?></td>\n            <td><?php echo functions::draw_fonticon($order['order_status_icon'].' fa-fw', 'style=\"color: '. $order['order_status_color'] .';\"'); ?></td>\n            <td><?php echo $order['id']; ?></td>\n            <td><?php echo (!empty($order['starred'])) ? functions::draw_fonticon('fa-star', 'style=\"color: #f2b01e;\"') : functions::draw_fonticon('fa-star-o', 'style=\"color: #ccc;\"'); ?></td>\n            <td><a href=\"<?php echo document::href_link('', ['app' => 'orders', 'doc' => 'edit_order', 'order_id' => $order['id'], 'redirect_url' => $_SERVER['REQUEST_URI']]); ?>\"><?php echo functions::escape_html($order['customer_company'] ? $order['customer_company'] : $order['customer_firstname'] .' '. $order['customer_lastname']); ?><?php echo empty($order['customer_id']) ? ' <em>('. language::translate('title_guest', 'Guest') .')</em>' : ''; ?></a> <span style=\"opacity: 0.5;\"><?php echo functions::escape_html($order['customer_tax_id']); ?></span></td>\n            <td><?php echo !empty($order['customer_country_code']) ? reference::country($order['customer_country_code'])->name : ''; ?></td>\n            <td><?php echo $order['payment_option_name']; ?></td>\n            <td class=\"text-end\"><?php echo currency::format($order['payment_due'], false, $order['currency_code'], $order['currency_value']); ?></td>\n            <td class=\"text-end\"><?php echo ($order['tax_total'] != 0) ? currency::format($order['tax_total'], false, $order['currency_code'], $order['currency_value']) : '-'; ?></td>\n            <td class=\"text-center\"><?php echo !empty($order['order_status_id']) ? $order['order_status_name'] : language::translate('title_unprocessed', 'Unprocessed'); ?></td>\n            <td class=\"text-end\"><?php echo language::strftime(language::$selected['format_datetime'], strtotime($order['date_created'])); ?></td>\n            <td>\n              <a href=\"<?php echo document::href_ilink('printable_packing_slip', ['order_id' => $order['id'], 'public_key' => $order['public_key'], 'media' => 'print']); ?>\" target=\"_blank\" title=\"<?php echo language::translate('title_packing_slip', 'Packing Slip'); ?>\"><?php echo functions::draw_fonticon('fa-file-text-o'); ?></a>\n              <a href=\"<?php echo document::href_ilink('printable_order_copy', ['order_id' => $order['id'], 'public_key' => $order['public_key'], 'media' => 'print']); ?>\" target=\"_blank\" title=\"<?php echo language::translate('title_order_copy', 'Order Copy'); ?>\"><?php echo functions::draw_fonticon('fa-print'); ?></a>\n              <a href=\"<?php echo document::href_link('', ['app' => 'orders', 'doc' => 'edit_order', 'order_id' => $order['id'], 'redirect_url' => $_SERVER['REQUEST_URI']]); ?>\" title=\"<?php echo language::translate('title_edit', 'Edit'); ?>\"><?php echo functions::draw_fonticon('fa-pencil'); ?></a>\n            </td>\n          </tr>\n          <?php } ?>\n        </tbody>\n\n        <tfoot>\n          <tr>\n            <td colspan=\"12\"><?php echo language::translate('title_orders', 'Orders'); ?>: <?php echo $num_rows; ?></td>\n          </tr>\n        </tfoot>\n      </table>\n\n      <p>\n        <ul id=\"order-actions\" class=\"list-inline\">\n          <?php foreach ($order_actions as $module) { ?>\n          <li>\n            <fieldset title=\"<?php echo functions::escape_html($module['description']); ?>\">\n              <legend><?php echo $module['name']; ?></legend>\n              <div class=\"btn-group\">\n                <?php foreach ($module['actions'] as $action) echo functions::form_draw_button('order_action', [$module['id'].':'.$action['id'], $action['title']], 'submit', 'formtarget=\"'. functions::escape_html($action['target']) .'\" title=\"'. functions::escape_html($action['description']) .'\"'); ?>\n              </div>\n            </fieldset>\n          </li>\n          <?php } ?>\n        </ul>\n      </p>\n\n    <?php echo functions::form_draw_form_end(); ?>\n  </div>\n\n  <div class=\"panel-footer\">\n    <?php echo functions::draw_pagination($num_pages); ?>\n  </div>\n</div>\n\n<script>\n  $('input[name=\"query\"]').keypress(function(e) {\n    if (e.which == 13) {\n      e.preventDefault();\n      $(this).closest('form').submit();\n    }\n  });\n\n  $('form[name=\"search_form\"] select').change(function(){\n    $(this).closest('form').submit();\n  });\n\n  $('.data-table input[name^=\"orders[\"]').change(function() {\n    if ($('.data-table input[name^=\"orders[\"]:checked').length > 0) {\n      $('#order-actions button').prop('disabled', false);\n    } else {\n      $('#order-actions button').prop('disabled', true);\n    }\n  }).trigger('change');\n\n\n  $('table').on('click', '.fa-star-o', function(e){\n    e.stopPropagation();\n    var star = this;\n    $.post('', 'star&order_id='+$(star).closest('tr').data('id'), function(data) {\n      $(star).replaceWith('<?php echo functions::draw_fonticon('fa-star', 'style=\"color: #f2b01e;\"'); ?>');\n    });\n    return false;\n  });\n\n  $('table').on('click', '.fa-star', function(e){\n    var star = this;\n    $.post('', 'unstar&order_id='+$(star).closest('tr').data('id'), function(data) {\n      $(star).replaceWith('<?php echo functions::draw_fonticon('fa-star-o', 'style=\"color: #ccc;\"'); ?>');\n    });\n    return false;\n  });\n</script>", "<?php\n\n  document::$snippets['title'][] = language::translate('title_most_shopping_customers', 'Most Shopping Customers');\n\n  breadcrumbs::add(language::translate('title_reports', 'Reports'));\n  breadcrumbs::add(language::translate('title_most_shopping_customers', 'Most Shopping Customers'));\n\n  $_GET['date_from'] = !empty($_GET['date_from']) ? date('Y-m-d', strtotime($_GET['date_from'])) : null;\n  $_GET['date_to'] = !empty($_GET['date_to']) ? date('Y-m-d', strtotime($_GET['date_to'])) : date('Y-m-d');\n\n  if ($_GET['date_from'] > $_GET['date_to']) list($_GET['date_from'], $_GET['date_to']) = [$_GET['date_to'], $_GET['date_from']];\n\n  $date_first_order = database::fetch(database::query(\"select min(date_created) from \". DB_TABLE_PREFIX .\"orders limit 1;\"));\n  $date_first_order = date('Y-m-d', strtotime($date_first_order['min(date_created)']));\n  if (empty($date_first_order)) $date_first_order = date('Y-m-d');\n  if ($_GET['date_from'] < $date_first_order) $_GET['date_from'] = $date_first_order;\n\n  if ($_GET['date_from'] > date('Y-m-d')) $_GET['date_from'] = date('Y-m-d');\n  if ($_GET['date_to'] > date('Y-m-d')) $_GET['date_to'] = date('Y-m-d');\n\n  if (empty($_GET['page']) || !is_numeric($_GET['page'])) $_GET['page'] = 1;\n\n// Table Rows\n  $customers = [];\n\n  $customers_query = database::query(\n    \"select\n      sum(o.payment_due - tax_total) as total_amount,\n      o.customer_id as id,\n      if(o.customer_company, o.customer_company, concat(o.customer_firstname, ' ', o.customer_lastname)) as name,\n      customer_email as email\n    from \". DB_TABLE_PREFIX .\"orders o\n    where o.order_status_id in (\n      select id from \". DB_TABLE_PREFIX .\"order_statuses\n      where is_sale\n    )\n    \". (!empty($_GET['date_from']) ? \"and o.date_created >= '\". date('Y-m-d H:i:s', strtotime($_GET['date_from'])) .\"'\" : '') .\"\n    \". (!empty($_GET['date_to']) ? \"and o.date_created <= '\". date('Y-m-d H:i:s', strtotime($_GET['date_to'])) .\"'\" : '') .\"\n    group by if(o.customer_id, o.customer_id, o.customer_email)\n    order by total_amount desc;\"\n  );\n\n  if (!isset($_GET['download']) && $_GET['page'] > 1) database::seek($customers_query, settings::get('data_table_rows_per_page') * ($_GET['page'] - 1));\n\n  $page_items = 0;\n  while ($customer = database::fetch($customers_query)) {\n    $customers[] = $customer;\n    if (!isset($_GET['download']) && ++$page_items == settings::get('data_table_rows_per_page')) break;\n  }\n\n  if (isset($_GET['download'])) {\n    //header('Content-Type: text/plain; charset='. language::$selected['code']);\n    header('Content-Type: application/csv; charset='. language::$selected['code']);\n    header('Content-Disposition: filename=\"most_shopping_customers_'. date('Ymd', strtotime($_GET['date_from'])) .'-'. date('Ymd', strtotime($_GET['date_to'])) .'.csv\"');\n    echo functions::csv_encode($customers);\n    exit;\n  }\n\n// Number of Rows\n  $num_rows = database::num_rows($customers_query);\n\n// Pagination\n  $num_pages = ceil($num_rows/settings::get('data_table_rows_per_page'));\n?>\n\n<style>\nform[name=\"filter_form\"] li {\n  vertical-align: middle;\n}\n</style>\n\n<div class=\"panel panel-app\">\n  <div class=\"panel-heading\">\n    <?php echo $app_icon; ?> <?php echo language::translate('title_most_shopping_customers', 'Most Shopping Customers'); ?>\n  </div>\n\n  <div class=\"panel-action\">\n    <?php echo functions::form_draw_form_begin('filter_form', 'get'); ?>\n      <?php echo functions::form_draw_hidden_field('app'); ?>\n      <?php echo functions::form_draw_hidden_field('doc'); ?>\n      <ul class=\"list-inline\">\n        <li><?php echo language::translate('title_date_period', 'Date Period'); ?>:</li>\n        <li>\n          <div class=\"input-group\" style=\"max-width: 380px;\">\n            <?php echo functions::form_draw_date_field('date_from', true); ?>\n            <span class=\"input-group-text\"> - </span>\n            <?php echo functions::form_draw_date_field('date_to', true); ?>\n          </div>\n        </li>\n        <li><?php echo functions::form_draw_button('filter', language::translate('title_filter_now', 'Filter')); ?></li>\n        <li><?php echo functions::form_draw_button('download', language::translate('title_download', 'Download')); ?></li>\n      </ul>\n    <?php echo functions::form_draw_form_end(); ?>\n  </div>\n\n  <div class=\"panel-body\">\n    <table class=\"table table-striped table-hover data-table\">\n      <thead>\n        <tr>\n          <th><?php echo language::translate('title_customer', 'Customer'); ?></th>\n          <th width=\"100%\"><?php echo language::translate('title_email_address', 'Email Address'); ?></th>\n          <th style=\"text-align: center;\"><?php echo language::translate('title_total_amount', 'Total Amount'); ?></th>\n        </tr>\n      </thead>\n\n      <tbody>\n        <?php foreach ($customers as $customer) { ?>\n        <tr>\n          <td><?php echo !empty($customer['id']) ? '<a href=\"'. document::link(WS_DIR_ADMIN, ['app' => 'customers', 'doc' => 'edit_customer', 'customer_id' => $customer['id']]) .'\">'. functions::escape_html($customer['name']) .'</a>' : functions::escape_html($customer['name']) .' <em>('. language::translate('title_guest', 'Guest') .')</em>'; ?></td>\n          <td><?php echo $customer['email']; ?></td>\n          <td style=\"text-align: end;\"><?php echo currency::format($customer['total_amount'], false, settings::get('store_currency_code')); ?></td>\n        </tr>\n        <?php } ?>\n      </tbody>\n    </table>\n  </div>\n\n  <div class=\"panel-footer\">\n    <?php echo functions::draw_pagination($num_pages); ?>\n  </div>\n</div>\n", "<meta name=\"viewport\" content=\"width=1200\">\n\n<style>\nbody {\n  display: flex;\n  height: 100vh;\n}\n\n#order-copy {\n  flex: 1 1 auto;\n}\n\n#sidebar {\n  display: flex;\n  flex-direction: column;\n  flex: 0 0 360px;\n  padding: 15px;\n  background: #fff;\n}\n\n#actions {\n  margin-bottom: 30px;\n}\n\n#comments {\n  flex: 1 1 auto;\n  overflow: hidden auto;\n}\n</style>\n\n\n<iframe id=\"order-copy\" src=\"<?php echo document::ilink('printable_order_copy', [], ['order_id', 'public_key']); ?>\" style=\"border: 0;\"></iframe>\n\n<div id=\"sidebar\" class=\"hidden-print shadow\">\n\n  <ul id=\"actions\" class=\"list-unstyled\">\n    <li><a class=\"btn btn-default btn-block btn-lg\" href=\"javascript:$('#order-copy').get(0).contentWindow.print();\"><?php echo functions::draw_fonticon('fa-print'); ?> <?php echo language::translate('title_print', 'Print'); ?></a></li>\n  </ul>\n\n  <h1 style=\"margin-top: 0;\"><?php echo language::translate('title_comments', 'Comments'); ?></h1>\n\n  <div id=\"comments\" class=\"bubbles\">\n    <?php foreach ($comments as $comment) { ?>\n    <div class=\"bubble <?php echo $comment['type']; ?>\">\n      <div class=\"text\"><?php echo nl2br(functions::escape_html($comment['text'])); ?></div>\n      <div class=\"date\"><?php echo language::strftime(language::$selected['format_datetime'], strtotime($comment['date_created'])); ?></div>\n    </div>\n    <?php } ?>\n  </div>\n</div>\n\n<script>\n// Scroll to last comment\n  $(\"#comments\").animate({scrollTop: $('#comments').prop('scrollHeight')}, 2000);\n</script>"], "filenames": ["public_html/admin/catalog.app/edit_category.inc.php", "public_html/admin/catalog.app/edit_product.inc.php", "public_html/admin/countries.app/edit_country.inc.php", "public_html/admin/geo_zones.app/edit_geo_zone.inc.php", "public_html/admin/orders.app/edit_order.inc.php", "public_html/admin/orders.app/orders.inc.php", "public_html/admin/reports.app/most_shopping_customers.inc.php", "public_html/includes/templates/default.catalog/pages/order.inc.php"], "buggy_code_start_loc": [258, 436, 174, 105, 572, 285, 109, 45], "buggy_code_end_loc": [259, 751, 175, 109, 655, 286, 110, 46], "fixing_code_start_loc": [258, 436, 174, 105, 572, 285, 109, 45], "fixing_code_end_loc": [259, 751, 175, 109, 655, 286, 110, 46], "type": "CWE-79", "message": "Cross-site scripting vulnerability in LiteCart versions prior to 2.4.2 allows a remote attacker to inject an arbitrary script via unspecified vectors.", "other": {"cve": {"id": "CVE-2022-27168", "sourceIdentifier": "vultures@jpcert.or.jp", "published": "2022-07-11T01:15:07.820", "lastModified": "2022-07-15T17:54:38.820", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Cross-site scripting vulnerability in LiteCart versions prior to 2.4.2 allows a remote attacker to inject an arbitrary script via unspecified vectors."}, {"lang": "es", "value": "Una vulnerabilidad de Cross-site scripting en LiteCart versiones anteriores a 2.4.2, permite a un atacante remoto inyectar un script arbitrario por medio de vectores no especificados"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:litecart:litecart:*:*:*:*:*:*:*:*", "versionEndExcluding": "2.4.2", "matchCriteriaId": "D8F39346-C6CC-4835-83C4-3497AAF2C41D"}]}]}], "references": [{"url": "https://github.com/litecart/litecart", "source": "vultures@jpcert.or.jp", "tags": ["Third Party Advisory"]}, {"url": "https://github.com/litecart/litecart/commit/050fea86cc162f3da2f7824f586602125a0f6d63", "source": "vultures@jpcert.or.jp", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://jvn.jp/en/jp/JVN32625020/index.html", "source": "vultures@jpcert.or.jp", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://www.litecart.net/en/", "source": "vultures@jpcert.or.jp", "tags": ["Product"]}]}, "github_commit_url": "https://github.com/litecart/litecart/commit/050fea86cc162f3da2f7824f586602125a0f6d63"}}