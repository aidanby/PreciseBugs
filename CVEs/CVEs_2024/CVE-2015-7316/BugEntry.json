{"buggy_code": [".. This file should contain the changes for the last release only, which\n   will be included on the package's page on pypi. All older entries are\n   kept in HISTORY.txt\n\nChangelog\n=========\n\n5.0rc2 (unreleased)\n-------------------\n\n- Do not bother additional CRSF protection for addMember since all public\n  users get same CSRF token and the method should be unpublished.\n  See https://pypi.python.org/pypi/Products.PloneHotfix20150910\n  [vangheem]\n\n- Remove site properties that have been migrated to the registry.\n  [esteele]\n\n- fix #862: Profile listing on site creation has alignment issues\n  [ichim-david]\n\n\n5.0rc1 (2015-09-08)\n-------------------\n\n- Remove deprecated global_defines.pt\n  [esteele]\n\n- Remove no-longer-used properties from portal_properties\n  [esteele]\n\n- Move footer and colophon out of skins\n  [vangheem]\n\n- pre-cook resources so we do not write on read for resources generation\n  [vangheem]\n\n- Turn robots.txt into a browser-view, fix link to sitemap.xml.gz, allow\n  editing in site-controlpanel.\n  Fixes https://github.com/plone/Products.CMFPlone/issues/604\n  [pbauer]\n\n- Remove history_form, history_comparison templates.\n  Remove now-empty plone_forms skins folder.\n  [esteele]\n\n- Remove no-longer-used images from portal_images.\n  [esteele]\n\n- Typo in delete modal configuration caused submission redirection errors\n  [vangheem]\n\n- Upgrade known core packages at the end of the Plone migration.\n  [maurits]\n\n- remove Products.CMFPlone.utils.isLinked function. Switch to using\n  plone.app.linkintegrity's variant\n  [vangheem]\n\n- Fix error to allow site navigation if TinyMCE content_css setting is None\n  [Gagaro]\n\n5.0b4 (2015-08-23)\n------------------\n\n- fix #350: \"plone.app.content circular dependency on Products.CMFPlone\" - this\n  fixes the imports only, not on zcml/genericsetup level.\n  [jensens]\n\n- move Plone specific ``getDefaultPage`` (magic) code from plone.app.layout\n  over to Products.CMFPlone. This avoids a circular dependency. Also its\n  not really layout only related code.\n  [jensens]\n\n- Fix add-ons to be installed using CMFQuickInstaller (restore support\n  for Extensions/Install.py)\n  [datakurre]\n\n- Rename showEditableBorder to showToolbar and deprecate using\n  disable_border and enable_border for enable_toolbar and disable_toolbar\n  [vangheem]\n\n- Not using less variables in toolbar everywhere\n  [vangheem]\n\n- Fix link to documentation\n\n- Rework timezone selection in @@plone-addsite.\n  [jaroel]\n\n- Rework language selection in @@plone-addsite.\n  [jaroel]\n\n- Turn @@tinymce-controlpanel ``content_css`` field into a list, so we can add\n  several CSS URLs (useful when add-ons need to provide extra TinyMCE styles),\n  and fix TinyMCE config getter so it considers the ``content_css`` value.\n  [ebrehault]\n\n\n5.0b3 (2015-07-20)\n------------------\n\n- show toolbar buttons on sitemap, accessibility and search pages\n  [vangheem]\n\n- log info after catalog rebuilt\n  [vangheem]\n\n- Renamed 'Zope Management Interface' to 'Management Interface'.\n  [jaroel]\n\n- Fix adding a new Plone site with country specific language. Refs #411.\n  [jaroel]\n\n- fix plone-logged-in bundle not using global jquery for requirejs dependency and in\n  weird cases causing select2 load errors in patterns(especially resource registry)\n  [vangheem]\n\n- Use new plone.app.theming policy API and delegate theme cache to plone.app.theming\n  [gyst]\n\n- Fix issue where site root syndication was giving 404s\n  [vangheem]\n\n- update time widget interval selection to be the same as Plone 4 time selection intervals\n  [vangheem]\n\n- use ajax_load in @@search when loading results dynamically, and add missing\n  closing tag\n  [ebrehault]\n\n- better formatting of config.js\n  [vangheem]\n\n- Upload pattern uses the baseUrl to compute the upload URL, so this should\n  always be the site root and not the current context\n  [frapell]\n\n- rewrite css files when saving customized files in the resource registry\n  [vangheem]\n\n- Update links to point to '@@overview-controlpanel'.\n  Fixes https://github.com/plone/Products.CMFPlone/issues/573\n  [gforcada]\n\n- Fix email validation of long domain names.\n  [gotcha]\n\n- fix syndication feed use of lead image as it was using wrong url\n  [vangheem]\n\n- add utility to get site logo\n  [vangheem]\n\n- fix issue where product upgrade did show an error status message\n  [datakurre]\n\n- fix casing on \"First weekday\" field on Date and Time control panel\n  [vangheem]\n\n- fix imaging control panel example format on description\n  [vangheem]\n\n- Add page title to resource registry\n  [vangheem]\n\n- Remove ramcache-controlpanel csrf test. Ramcache control panel has been\n  moved to p.a.caching since ages. We will get rid of it.\n  [timo]\n\n- Add undeclared zope.cachedescriptors dependency.\n  [timo]\n\n- Do not require \"Enable LiveSearch\". This fixes https://github.com/plone/Products.CMFPlone/issues/558\n  [timo]\n\n- Fix control panel titles. This fixes https://github.com/plone/Products.CMFPlone/issues/550 https://github.com/plone/Products.CMFPlone/issues/553 https://github.com/plone/Products.CMFPlone/issues/557\n  [timo]\n\n- remove plone.app.jquerytools dependency\n  [vangheem]\n\n- fix bug where bundles would not get built properly with\n  compile-plone-resources script when multiple resources\n  were defined for a bundle\n  [vangheem]\n\n- do not require css to be defined for non-compilable bundles\n  [vangheem]\n\n- fix weird issue with selecting multiple links and images on a page\n  while you are editing with tinymce\n  [vangheem]\n\n- updates to contact forms to make them more user friendly on submission\n  [vangheem]\n\n- include code plugin by default for TinyMCE\n  [vangheem]\n\n- Fix build reading browser cached files by appending random query\n  param onto url. See https://github.com/plone/Products.CMFPlone/commit/2d3865805efc6b72dce236eb68e502d8c57717b6\n  and https://github.com/plone/Products.CMFPlone/commit/bd1f9ba99d1ad40bb7fe1c00eaa32b8884aae5e2\n  [vangheem]\n\n- fix manage content type and group portlets link to have authenticator\n  [vangheem]\n\n- Convert manage-portlets.js into a pattern and make improvements on\n  using the manage portlets infrastructure\n  [vangheem]\n\n- Remove dependency on plone.app.form and other formlib packages\n  [tomgross]\n\n- Remove plone.skip_links from the default set of viewlets in order to follow\n  modern a11y methods and drop support for outdated ways [sneridagh]\n\n- Change the name and link of 'Types' control panel to 'Content Settings' and\n  '@@content-controlpanel' since there was confusion with the 'Dexterity\n  Content Types' one [sneridagh]\n\n\n5.0b2 (2015-05-13)\n------------------\n\n- Add social media settings control panel\n\n- add ability to provide a css file for tinymce style formats\n  [vangheem]\n\n- fix plone-generate-gruntfile to compile each less resource\n  separately\n  [vangheem]\n\n- provide image alignment styles for tinymce images\n  [vangheem]\n\n- Respect TinyMCE control panel settings\n  [vangheem]\n\n- enable/disable versioning behavior with settings in Types control panel\n  [vangheem]\n\n- Make typesToList read metaTypesNotToList from new p.a.registry settings.\n  This fixes https://github.com/plone/Products.CMFPlone/issues/454.\n  [timo]\n\n- style tweaks to toolbar\n  [pbauer]\n\n- fix search form usability\n  [vangheem]\n\n- detect when changes are made to the legacy bundle through the interface\n  so resources are re-built when they need to be\n  [vangheem]\n\n- fix some legacy import wonkiness. Inserting multiple times, insert-before\n  and remove fixed\n  [vangheem]\n\n- make live search and search form give consistent results\n  [vangheem]\n\n- only show edit bar if user logged in\n  [vangheem]\n\n- fix error sending test email in Mail control panel\n  [tkimnguyen]\n\n- pat-modal pattern has been renamed to pat-plone-modal\n  [jcbrand]\n\n- Remove Products.CMFFormController dependency.\n  [timo]\n\n- Fix submission of tinymce control panel.\n  [davisagli]\n\n- Monkey patch SMTPMailer init method to pick up the mail settings from the\n  registry instead of from the MailHost itself.\n  [timo]\n\n- Add `resource_blacklist` attribute to resource registry importer, to\n  allow filtering of known bad legacy resource imports.  Filter js from\n  plone.app.jquery.\n  [alecm]\n\n- Fix broken \"Installing a third party add-on\" link\n  [cedricmessiant]\n\n- Fix folder contents button disappeared act\n  [vangheem]\n\n- Fix resource registry javascript build\n  [vangheem]\n\n- Move `plone.htmlhead.links` viewlet manager after `plone.scripts`,\n  because the former is sometimes used to include scripts that depend on\n  the latter.\n  [davisagli]\n\n- Change the order of the plonebar user menu and move the plone.personal_bar\n  viewlet to the last position due to accessibility issues on having it being\n  the first element.\n  [sneridagh]\n\n- We only support `utf-8` site-encoding at the moment\n  [tomgross]\n\n\n5.0b1.post1 (2015-03-27)\n------------------------\n\n- Packaging fix, no code changes.\n  [esteele]\n\n\n5.0b1 (2015-03-26)\n------------------\n\n- Add tests for configuring encoding of user registration or\n  forgotten password emails.\n  [davidjb]\n\n- Pass email encoding to forgotten password email template.\n  [davidjb]\n\n- Pass mail ``Content-Type`` to mailhost when sending forgotten password\n  emails.\n  [davidjb]\n\n- Move security control panel to CMFPlone. Fixes #216.\n  [jcerjak, timo]\n\n- Remove ``create_userfolder`` from addPloneSite factory, it is not used\n  anymore.\n  [jcerjak]\n\n- Read security settings from the registry instead of portal properties.\n  [jcerjak,timo]\n\n- Fix tests for plone.app.contenttypes unified view names, which uses\n  ``listing_view`` for Folder and Collection types.\n  [thet]\n\n- Remove ``selectable_views`` from ``properties.xml``, which isn't used\n  anywhere anymore.\n  [thet]\n\n- Remove the remaining ``Topic`` entry in ``default_page_types`` from\n  ``propertiestool.xml``. This setting is now done in\n  ``plone.app.contenttypes`` respectively ``Products.ATContentTypes``.\n  [thet]\n\n- Add __version__ attribute to __init__.py. This allows us to retrieve the\n  current Plone version with 'Products.CMFPlone.__version__'. Even though this\n  is no offical standard, many packages in the Python standard library provide\n  this.\n  [timo]\n\n- Replaced the legacy mark_special_links javascript with a\n  corresponding mockup pattern.\n  [fulv]\n\n- remove plone_javascript_variables.js as necessary values\n  are provided on body tag and pattern options\n  [vangheem]\n\n- fix bootstrap css bleeding into global namespaces\n  [vangheem]\n\n- add recurrence pattern\n  [vangheem]\n\n- add history support for folder contents\n  [vangheem]\n\n- Merge plone.app.search here\n  [vangheem]\n\n- Extended ulocalized_time for target_language\n  [agitator]\n\n- Caching for ``@@site-logo``.\n  [thet]\n\n- Support for portal site logos stored in the portal registry by uploading via\n  the site control panel. Add a ``@@site-logo`` view for downloading the logo.\n  [thet]\n\n- Fix the resource registry to save the automatically generated filepath to the\n  compiled resource on the bundle object after compilation. The filepath is\n  always in the '++plone++static/' namespace. This fix makes custom bundles\n  actually includable.\n  [thet]\n\n- Get icon from layout_view instead of plone_view.\n  [pbauer]\n\n- Fix contentViews (tabs) markup for Plone 5.\n  [davisagli]\n\n- Rename syndication-settings to syndication-controlpanel. Keep the old view registration for backwards compatibility.\n  [timo]\n\n- Added a link for the advanced 'Create a Plone site' screen to the Plone overview.\n  [jaroel]\n\n- Fixed the label for 'Example content' in the advanced 'Create a Plone site' screen.\n  [jaroel]\n\n- Move markup control panel to CMFPlone. Fixes #220.\n  [djay, thet]\n\n- Use jstz to set default portal_timezone in @@plone-addsite.\n  [instification]\n\n- Make inline validation of AT multiple selection widget work.\n  [gbastien]\n\n- Make sure compiling resources does not commit transaction prematurely.\n  [davisagli]\n\n- Adding the option to configure a bundle from the diazo manifest file.\n  [bloodbare]\n\n- Move the controlpanel overview from plone.app.controlpanel into this package\n  https://github.com/plone/Products.CMFPlone/issues/290\n  [khink]\n\n- PLIP 10359: Migrate usergroups controlpanel to ``z3c.form`` and move it from\n  plone.app.controlpanel to Products.CMFPlone. Fix and extend tests and add\n  robot tests.\n  [ferewuz]\n\n\n5.0a3 (2014-11-01)\n------------------\n\n- folder_position script: make position and id optional.  Default\n  position to 'ordered' and id to None, which means: do nothing.\n  plone.folder 1.0.5 allows this, making it possible to simply reverse\n  the current sort order by using reverse=False.\n  [maurits]\n\n- Fix JS resource viewlet HTML syntax error.\n  [rpatterson]\n\n- Fix resource bundle expressions.  They weren't being checked at all and\n  reversed the condition if they had been.  Also move caching of the cooked\n  expressions out of the DB and into a RAM cache.\n  [rpatterson]\n\n- Fix endless resource dependency loop when dependeing on a bundle that also has\n  a dependency.\n  [rpatterson]\n\n- reduce deprecation warnings to use plone_layout and not plone_view for\n  certain method calls in order to make debugging of robottests easier:\n  w/o it shows 1000ds of extra lines in html report.\n  [jensens]\n\n- type controlpanel: Resolved problem with workflow selection form as it\n  was breaking if state title had non-ascii characters. see also\n  https://github.com/plone/plone.app.controlpanel/pull/26\n  [lewicki, jensens]\n\n- Minor overhaul of CatalogTool.py - no feature changes!\n  Optimizations and better readable code for indexer\n  ``allowedRolesAndUsers``: now using a set.\n  Change if/elif/else to oneliner boolean expression in ``is_folderish``\n  indexer.\n  Usage of AccessControl 3 style decorators for security declarations.\n  Minor reformattings to make code-analysis happy.\n  [jensens]\n\n- Removed some javascripts: fullscreenmode.js, dragdropreorder.js,\n  styleswitcher.js, select_all.js, collapsibleformfields.js\n\n- PLIP 13260: Migration cut, copy and paste into browser views.\n  [saily]\n\n- Abstract the search form and livesearch action URLs making it easier to\n  extend the search portlet with custom views or other actions.\n  [rpatterson]\n\n- Fix JavaScript to work with recent jQuery (>= 1.9) versions.\n  [thet]\n\n- Small scoping fix in locking js code\n  [do3cc]\n\n- PLIP 13260: Migrate author page to browser views/z3c.form (issue #78)\n  [bosim]\n\n- Integration of the new markup update and CSS for both Plone and Barceloneta\n  theme. This is the work done in the GSOC Barceloneta theme project.\n  [albertcasado, sneridagh]\n\n- Created new viewlet manager for holding main navigation for a more semantic\n  use of it. Move the global sections viewlet into it.\n  [albertcasado]\n\n- New toolbar markup based in ul li tags.\n  [albertcasado, bloodbare, sneridagh]\n\n- Update <div id=\"content\"> in all templates with <article id=\"content\">\n  [albertcasado]\n\n- PLIP 14261: New resource registries.\n  [bloodbare, vangheem, robgietema, et al]\n\n\n5.0a2 (2014-04-20)\n------------------\n\n- Advertise the migration of content to dexterity after a successful\n  upgrade to Plone 5.\n  [pbauer]\n\n- Strip leading & trailing spaces from id and title in rename-form.\n  See https://dev.plone.org/ticket/12998, https://dev.plone.org/ticket/12989,\n  https://dev.plone.org/ticket/9370, https://dev.plone.org/ticket/8338\n  [pbauer]\n\n- Fix incorrect use of dict get method in CatalogTool.search, introduced\n  by PloneHotfix20131210 (issue 195)\n  [fulv]\n\n- Added timezone selection to add site page\n  [pysailor, yenzenz]\n\n- Added date date and time controlpanel (moved over from plone.app.event).\n  [yenzenz. thet]\n\n- Remove DL/DT/DD's from portal messages, portlet templates and others.\n  https://github.com/plone/Products.CMFPlone/issues/153\n  https://github.com/plone/Products.CMFPlone/issues/163\n  [khink]\n\n- PLIP 13260 remove templates and form scripts for\n  ``select_default_page`` and ``select_default_view`` because they got\n  migrated to browser views. Fix tests for that and remove legacy tests.\n  See: https://github.com/plone/Products.CMFPlone/issues/90\n  [saily]\n\n- PLIP 13260: Migration contact-info to ``z3c.form`` and make it highly\n  customizeable.\n  [timitos, saily]\n\n\n5.0a1 (2014-03-02)\n------------------\n\n- remove quickinstall control panel form since a new one was moved to\n  plone.app.controlpanel\n  [vangheem]\n\n- Add 'warning' and 'error' status message types to the test_rendering\n  view.\n  [esteele]\n\n- Update the front-page links.\n  [esteele]\n\n- In plone-overview view, we can now see Plone sites which are contained into\n  Zope folder.\n  [bsuttor]\n\n- Make Plone tool read the exposeDCMetaTags from p.a.registry instead of\n  of the site properties.\n  [timo]\n\n- Hide plone.app.registry install profile in the add-ons control panel.\n  [esteele]\n\n- Removed spamProtect.py script, since it doesn't offer real protection.\n  [davisagli]\n\n- Moved the member search form to plone.app.users\n  [pabo3000]\n\n- PLIP #13705: Remove <base> tag.\n  [frapell]\n\n- merge hotfixes from 20131210\n  [vangheem]\n\n- handle plone.app.textfield RichTextValue objects in syndication. Should\n  fix syndication with plone.app.contenttypes.\n  [vangheem]\n\n- FolderFeed adapter now takes into account the limit property when displaying\n  the RSS feed just like the other adapters do\n  [ichim-david]\n\n- Remove the portal_calendar tool and the dependency on CMFCalendar.\n  [davisagli]\n\n- Remove the plone_deprecated skin layer.\n  [gforcada, davisagli]\n\n- Moved portal_factory and portal_metadata from Products.CMFPlone to\n  Products.ATContentTypes (PLIP #13770)\n  [ale-rt]\n\n- Remove the portal_interface tool.\n  [ale-rt]\n\n- Remove the portal_actionicons tool.\n  [davisagli]\n\n- Remove ownership_form and change_ownership script, which were not used.\n  [davisagli]\n\n- Convert author_feedback_template and accessibility_info to browser views.\n  [bloodbare]\n\n- Move calendar_macros and jscalendar to Products.Archetypes.\n  [bloodbare]\n\n- Remove plonetheme.classic from the package dependencies and the default\n  extension profile, since it will not ship with Plone 5.\n  [timo]\n\n- Move docs/CHANGES.txt to CHANGES.rst.\n  [timo]\n\n- Replace deprecated test assert statements.\n  [timo]\n\n- Add a dependency on plone.app.theming. Install by default.\n  [esteele]\n\n- Drop dependency on plonetheme.classic.\n  [esteele]\n\n- Remove old logo.jpg. Use logo.png from Sunburst.\n  [esteele]\n\n- Inline validation JavaScript for z3c.form only sends request when\n  field name can be obtained from DOM for a widget (#13741).\n  [seanupton]\n\n- Add use_uuid_as_userid site property.\n  Part of PLIP 13419.\n  [maurits]\n\n- Let set_own_login_name use the update(Own)LoginName method from PAS.\n  Part of PLIP 13419.\n  [maurits]\n\n- recently_modified and recently_published respects allow anonymous to view\n  about setting\n  [vangheem]\n\n- Return a 404 instead of \"AttributeError: (dynamic view)\" if a user attempts to\n  view a still-temporary PortalFactory item.\n  [esteele]\n\n- Ensure that initial_login is set to True when a user first logs in.\n  [taito]\n\n- Merged PLIP #12198: Depend on Chameleon (five.pt) as a faster page template\n  engine.\n  [davisagli]\n\n- make extensionprofiles selection part of 'advanced' in plone-addsite\n  [jaroel]\n\n- enable syndication on plone.app.contenttypes collection\n  [vangheem]\n\n- fix syndication settings to not write on read\n  [vangheem]\n\n- fix wrong download url for podcast syndication\n  [Rudd-O]\n\n- Merged PLIP #12344: Use Dexterity-based core content types.\n\n  * Avoid including ATContentTypes and Archetypes as a dependency.\n  * Install the plone.app.contenttypes profile for new sites.\n\n  [davisagli et al]\n\n- Merged PLIP #13270: Move presentation mode out of core.\n  If the feature is still desired, use the plone.app.s5slideshow add-on.\n  [davisagli]\n\n- Add \"plone-5\" ZCML feature. Add-ons can register\n  ZCML for Plone 5 only using zcml:condition=\"have plone-5\"\n  [davisagli]\n\n- Plone's javascript is now developed as part of the Plone mockup\n  (http://github.com/plone/mockup) and is included as a compiled\n  bundle.\n  [davisagli]\n\n- Removed portal_interface tool (PLIP #13770)\n  [ale-rt]\n\n- Removed kss_field_decorator_view support\n  [maurits, jaroel]\n", "from Products.CMFCore.URLTool import URLTool as BaseTool\nfrom Products.CMFCore.utils import getToolByName\nfrom AccessControl import ClassSecurityInfo\nfrom App.class_init import InitializeClass\nfrom Products.CMFPlone.PloneBaseTool import PloneBaseTool\n\nfrom posixpath import normpath\nfrom urlparse import urlparse, urljoin\nimport re\n\n\nclass URLTool(PloneBaseTool, BaseTool):\n\n    meta_type = 'Plone URL Tool'\n    security = ClassSecurityInfo()\n    toolicon = 'skins/plone_images/link_icon.png'\n\n    security.declarePublic('isURLInPortal')\n    def isURLInPortal(self, url, context=None):\n        \"\"\" Check if a given url is on the same host and contains the portal\n            path.  Used to ensure that login forms can determine relevant\n            referrers (i.e. in portal).  Also return true for some relative\n            urls if context is passed in to allow for url parsing. When context\n            is not provided, assume that relative urls are in the portal. It is\n            assumed that http://portal is the same portal as https://portal.\n\n            External sites listed in 'allow_external_login_sites' of\n            site_properties are also considered within the portal to allow for\n            single sign on.\n        \"\"\"\n        # sanitize url\n        url = re.sub('^[\\x00-\\x20]+', '', url).strip()\n\n        p_url = self()\n\n        _, u_host, u_path, _, _, _ = urlparse(url)\n        if not u_host and not u_path.startswith('/'):\n            if context is None:\n                return True  # old behavior\n            if not context.isPrincipiaFolderish:\n                useurl = context.aq_parent.absolute_url()\n            else:\n                useurl = context.absolute_url()\n        else:\n            useurl = p_url  # when u_path.startswith('/')\n        if not useurl.endswith('/'):\n            useurl += '/'\n\n        # urljoin to current url to get an absolute path\n        _, u_host, u_path, _, _, _ = urlparse(urljoin(useurl, url))\n\n        # normalise to end with a '/' so /foobar is not considered within /foo\n        if not u_path:\n            u_path = '/'\n        else:\n            u_path = normpath(u_path)\n            if not u_path.endswith('/'):\n                u_path += '/'\n        _, host, path, _, _, _ = urlparse(p_url)\n        if not path.endswith('/'):\n            path += '/'\n        if host == u_host and u_path.startswith(path):\n            return True\n\n        props = getToolByName(self, 'portal_properties').site_properties\n        for external_site in props.getProperty('allow_external_login_sites', []):\n            _, host, path, _, _, _ = urlparse(external_site)\n            if not path.endswith('/'):\n                path += '/'\n            if host == u_host and u_path.startswith(path):\n                return True\n        return False\n\n\nURLTool.__doc__ = BaseTool.__doc__\n\nInitializeClass(URLTool)\n", "import unittest\n\nfrom Products.CMFCore.tests.base.dummy import DummySite\nfrom Products.CMFCore.tests.base.dummy import DummyFolder\nfrom Products.CMFCore.tests.base.dummy import DummyContent\n\nfrom Acquisition import aq_parent\n\n\nclass DummyFolder(DummyFolder):\n    def absolute_url(self):\n        return '/'.join([aq_parent(self).absolute_url(), self.getId()])\n\n\nclass DummyProperties(DummyContent):\n\n    _allow_external_login_sites = [\n        'http://external1',\n        'http://external2/',\n        'http://external3/site',\n        'http://external4/site/'\n        ]\n\n    def getProperty(self, name, default=None):\n        if name == 'allow_external_login_sites':\n            return self._allow_external_login_sites\n        return default\n\n\nclass TestURLTool(unittest.TestCase):\n\n    def setUp(self):\n        self.site = DummySite(id='foo')\n        self.site._setObject('foo', DummyFolder(id='foo'))\n        self.site.foo._setObject('doc1', DummyContent(id='doc1'))\n        self.site.portal_properties = DummyProperties(id='portal_properties')\n        self.site.portal_properties.site_properties = \\\n            DummyProperties(id='site_properties')\n\n    def _makeOne(self, *args, **kw):\n        from Products.CMFPlone.URLTool import URLTool\n        url_tool = URLTool(*args, **kw)\n        return url_tool.__of__(self.site)\n\n    def test_isURLInPortal(self):\n        url_tool = self._makeOne()\n        iURLiP = url_tool.isURLInPortal\n        self.assertTrue(iURLiP('http://www.foobar.com/bar/foo/folder'))\n        self.assertTrue(iURLiP('http://www.foobar.com/bar/foo'))\n        self.assertFalse(iURLiP('http://www.foobar.com/bar2/foo'))\n        self.assertTrue(iURLiP('https://www.foobar.com/bar/foo/folder'))\n        self.assertFalse(iURLiP('http://www.foobar.com:8080/bar/foo/folder'))\n        self.assertFalse(iURLiP('http://www.foobar.com/bar'))\n        self.assertFalse(iURLiP('/images'))\n        self.assertTrue(iURLiP('/bar/foo/foo'))\n\n    def test_isURLInPortalRelative(self):\n        url_tool = self._makeOne()\n        iURLiP = url_tool.isURLInPortal\n\n        #non-root relative urls will need a current context to be passed in\n        self.assertTrue(iURLiP('images/img1.jpg'))\n        self.assertTrue(iURLiP('./images/img1.jpg'))\n\n        # /bar/foo/something\n        self.assertTrue(iURLiP('../something', self.site.foo.doc1))\n        # /bar/afolder\n        self.assertFalse(iURLiP('../../afolder', self.site.foo.doc1))\n        # /afolder\n        self.assertFalse(iURLiP('../../../afolder', self.site.foo.doc1))\n\n        # /../afolder? How do we have more ../'s than there are parts in\n        # the URL?\n        self.assertFalse(iURLiP('../../../../afolder', self.site.foo.doc1))\n\n        # /bar/foo/afolder\n        self.assertTrue(iURLiP('../../foo/afolder', self.site.foo.doc1))\n\n    def test_isURLInPortalExternal(self):\n        url_tool = self._makeOne()\n        iURLiP = url_tool.isURLInPortal\n        self.assertTrue(iURLiP('http://external1'))\n        self.assertTrue(iURLiP('http://external1/'))\n        self.assertTrue(iURLiP('http://external1/something'))\n        self.assertTrue(iURLiP('http://external2'))\n        self.assertTrue(iURLiP('http://external2/'))\n        self.assertTrue(iURLiP('http://external2/something'))\n        self.assertTrue(iURLiP('http://external3/site'))\n        self.assertTrue(iURLiP('http://external3/site/'))\n        self.assertTrue(iURLiP('http://external3/site/something'))\n        self.assertTrue(iURLiP('http://external4/site'))\n        self.assertTrue(iURLiP('http://external4/site/'))\n        self.assertTrue(iURLiP('http://external4/site/something'))\n\n        self.assertFalse(iURLiP('http://external3/other'))\n        self.assertFalse(iURLiP('http://external4/other'))\n        self.assertFalse(iURLiP('http://external5'))\n        self.assertFalse(iURLiP('http://external11'))\n"], "fixing_code": [".. This file should contain the changes for the last release only, which\n   will be included on the package's page on pypi. All older entries are\n   kept in HISTORY.txt\n\nChangelog\n=========\n\n5.0rc2 (unreleased)\n-------------------\n\n- Apply isURLInPortal fix from https://pypi.python.org/pypi/Products.PloneHotfix20150910\n  [vangheem]\n\n- Do not bother additional CRSF protection for addMember since all public\n  users get same CSRF token and the method should be unpublished.\n  See https://pypi.python.org/pypi/Products.PloneHotfix20150910\n  [vangheem]\n\n- Remove site properties that have been migrated to the registry.\n  [esteele]\n\n- fix #862: Profile listing on site creation has alignment issues\n  [ichim-david]\n\n\n5.0rc1 (2015-09-08)\n-------------------\n\n- Remove deprecated global_defines.pt\n  [esteele]\n\n- Remove no-longer-used properties from portal_properties\n  [esteele]\n\n- Move footer and colophon out of skins\n  [vangheem]\n\n- pre-cook resources so we do not write on read for resources generation\n  [vangheem]\n\n- Turn robots.txt into a browser-view, fix link to sitemap.xml.gz, allow\n  editing in site-controlpanel.\n  Fixes https://github.com/plone/Products.CMFPlone/issues/604\n  [pbauer]\n\n- Remove history_form, history_comparison templates.\n  Remove now-empty plone_forms skins folder.\n  [esteele]\n\n- Remove no-longer-used images from portal_images.\n  [esteele]\n\n- Typo in delete modal configuration caused submission redirection errors\n  [vangheem]\n\n- Upgrade known core packages at the end of the Plone migration.\n  [maurits]\n\n- remove Products.CMFPlone.utils.isLinked function. Switch to using\n  plone.app.linkintegrity's variant\n  [vangheem]\n\n- Fix error to allow site navigation if TinyMCE content_css setting is None\n  [Gagaro]\n\n5.0b4 (2015-08-23)\n------------------\n\n- fix #350: \"plone.app.content circular dependency on Products.CMFPlone\" - this\n  fixes the imports only, not on zcml/genericsetup level.\n  [jensens]\n\n- move Plone specific ``getDefaultPage`` (magic) code from plone.app.layout\n  over to Products.CMFPlone. This avoids a circular dependency. Also its\n  not really layout only related code.\n  [jensens]\n\n- Fix add-ons to be installed using CMFQuickInstaller (restore support\n  for Extensions/Install.py)\n  [datakurre]\n\n- Rename showEditableBorder to showToolbar and deprecate using\n  disable_border and enable_border for enable_toolbar and disable_toolbar\n  [vangheem]\n\n- Not using less variables in toolbar everywhere\n  [vangheem]\n\n- Fix link to documentation\n\n- Rework timezone selection in @@plone-addsite.\n  [jaroel]\n\n- Rework language selection in @@plone-addsite.\n  [jaroel]\n\n- Turn @@tinymce-controlpanel ``content_css`` field into a list, so we can add\n  several CSS URLs (useful when add-ons need to provide extra TinyMCE styles),\n  and fix TinyMCE config getter so it considers the ``content_css`` value.\n  [ebrehault]\n\n\n5.0b3 (2015-07-20)\n------------------\n\n- show toolbar buttons on sitemap, accessibility and search pages\n  [vangheem]\n\n- log info after catalog rebuilt\n  [vangheem]\n\n- Renamed 'Zope Management Interface' to 'Management Interface'.\n  [jaroel]\n\n- Fix adding a new Plone site with country specific language. Refs #411.\n  [jaroel]\n\n- fix plone-logged-in bundle not using global jquery for requirejs dependency and in\n  weird cases causing select2 load errors in patterns(especially resource registry)\n  [vangheem]\n\n- Use new plone.app.theming policy API and delegate theme cache to plone.app.theming\n  [gyst]\n\n- Fix issue where site root syndication was giving 404s\n  [vangheem]\n\n- update time widget interval selection to be the same as Plone 4 time selection intervals\n  [vangheem]\n\n- use ajax_load in @@search when loading results dynamically, and add missing\n  closing tag\n  [ebrehault]\n\n- better formatting of config.js\n  [vangheem]\n\n- Upload pattern uses the baseUrl to compute the upload URL, so this should\n  always be the site root and not the current context\n  [frapell]\n\n- rewrite css files when saving customized files in the resource registry\n  [vangheem]\n\n- Update links to point to '@@overview-controlpanel'.\n  Fixes https://github.com/plone/Products.CMFPlone/issues/573\n  [gforcada]\n\n- Fix email validation of long domain names.\n  [gotcha]\n\n- fix syndication feed use of lead image as it was using wrong url\n  [vangheem]\n\n- add utility to get site logo\n  [vangheem]\n\n- fix issue where product upgrade did show an error status message\n  [datakurre]\n\n- fix casing on \"First weekday\" field on Date and Time control panel\n  [vangheem]\n\n- fix imaging control panel example format on description\n  [vangheem]\n\n- Add page title to resource registry\n  [vangheem]\n\n- Remove ramcache-controlpanel csrf test. Ramcache control panel has been\n  moved to p.a.caching since ages. We will get rid of it.\n  [timo]\n\n- Add undeclared zope.cachedescriptors dependency.\n  [timo]\n\n- Do not require \"Enable LiveSearch\". This fixes https://github.com/plone/Products.CMFPlone/issues/558\n  [timo]\n\n- Fix control panel titles. This fixes https://github.com/plone/Products.CMFPlone/issues/550 https://github.com/plone/Products.CMFPlone/issues/553 https://github.com/plone/Products.CMFPlone/issues/557\n  [timo]\n\n- remove plone.app.jquerytools dependency\n  [vangheem]\n\n- fix bug where bundles would not get built properly with\n  compile-plone-resources script when multiple resources\n  were defined for a bundle\n  [vangheem]\n\n- do not require css to be defined for non-compilable bundles\n  [vangheem]\n\n- fix weird issue with selecting multiple links and images on a page\n  while you are editing with tinymce\n  [vangheem]\n\n- updates to contact forms to make them more user friendly on submission\n  [vangheem]\n\n- include code plugin by default for TinyMCE\n  [vangheem]\n\n- Fix build reading browser cached files by appending random query\n  param onto url. See https://github.com/plone/Products.CMFPlone/commit/2d3865805efc6b72dce236eb68e502d8c57717b6\n  and https://github.com/plone/Products.CMFPlone/commit/bd1f9ba99d1ad40bb7fe1c00eaa32b8884aae5e2\n  [vangheem]\n\n- fix manage content type and group portlets link to have authenticator\n  [vangheem]\n\n- Convert manage-portlets.js into a pattern and make improvements on\n  using the manage portlets infrastructure\n  [vangheem]\n\n- Remove dependency on plone.app.form and other formlib packages\n  [tomgross]\n\n- Remove plone.skip_links from the default set of viewlets in order to follow\n  modern a11y methods and drop support for outdated ways [sneridagh]\n\n- Change the name and link of 'Types' control panel to 'Content Settings' and\n  '@@content-controlpanel' since there was confusion with the 'Dexterity\n  Content Types' one [sneridagh]\n\n\n5.0b2 (2015-05-13)\n------------------\n\n- Add social media settings control panel\n\n- add ability to provide a css file for tinymce style formats\n  [vangheem]\n\n- fix plone-generate-gruntfile to compile each less resource\n  separately\n  [vangheem]\n\n- provide image alignment styles for tinymce images\n  [vangheem]\n\n- Respect TinyMCE control panel settings\n  [vangheem]\n\n- enable/disable versioning behavior with settings in Types control panel\n  [vangheem]\n\n- Make typesToList read metaTypesNotToList from new p.a.registry settings.\n  This fixes https://github.com/plone/Products.CMFPlone/issues/454.\n  [timo]\n\n- style tweaks to toolbar\n  [pbauer]\n\n- fix search form usability\n  [vangheem]\n\n- detect when changes are made to the legacy bundle through the interface\n  so resources are re-built when they need to be\n  [vangheem]\n\n- fix some legacy import wonkiness. Inserting multiple times, insert-before\n  and remove fixed\n  [vangheem]\n\n- make live search and search form give consistent results\n  [vangheem]\n\n- only show edit bar if user logged in\n  [vangheem]\n\n- fix error sending test email in Mail control panel\n  [tkimnguyen]\n\n- pat-modal pattern has been renamed to pat-plone-modal\n  [jcbrand]\n\n- Remove Products.CMFFormController dependency.\n  [timo]\n\n- Fix submission of tinymce control panel.\n  [davisagli]\n\n- Monkey patch SMTPMailer init method to pick up the mail settings from the\n  registry instead of from the MailHost itself.\n  [timo]\n\n- Add `resource_blacklist` attribute to resource registry importer, to\n  allow filtering of known bad legacy resource imports.  Filter js from\n  plone.app.jquery.\n  [alecm]\n\n- Fix broken \"Installing a third party add-on\" link\n  [cedricmessiant]\n\n- Fix folder contents button disappeared act\n  [vangheem]\n\n- Fix resource registry javascript build\n  [vangheem]\n\n- Move `plone.htmlhead.links` viewlet manager after `plone.scripts`,\n  because the former is sometimes used to include scripts that depend on\n  the latter.\n  [davisagli]\n\n- Change the order of the plonebar user menu and move the plone.personal_bar\n  viewlet to the last position due to accessibility issues on having it being\n  the first element.\n  [sneridagh]\n\n- We only support `utf-8` site-encoding at the moment\n  [tomgross]\n\n\n5.0b1.post1 (2015-03-27)\n------------------------\n\n- Packaging fix, no code changes.\n  [esteele]\n\n\n5.0b1 (2015-03-26)\n------------------\n\n- Add tests for configuring encoding of user registration or\n  forgotten password emails.\n  [davidjb]\n\n- Pass email encoding to forgotten password email template.\n  [davidjb]\n\n- Pass mail ``Content-Type`` to mailhost when sending forgotten password\n  emails.\n  [davidjb]\n\n- Move security control panel to CMFPlone. Fixes #216.\n  [jcerjak, timo]\n\n- Remove ``create_userfolder`` from addPloneSite factory, it is not used\n  anymore.\n  [jcerjak]\n\n- Read security settings from the registry instead of portal properties.\n  [jcerjak,timo]\n\n- Fix tests for plone.app.contenttypes unified view names, which uses\n  ``listing_view`` for Folder and Collection types.\n  [thet]\n\n- Remove ``selectable_views`` from ``properties.xml``, which isn't used\n  anywhere anymore.\n  [thet]\n\n- Remove the remaining ``Topic`` entry in ``default_page_types`` from\n  ``propertiestool.xml``. This setting is now done in\n  ``plone.app.contenttypes`` respectively ``Products.ATContentTypes``.\n  [thet]\n\n- Add __version__ attribute to __init__.py. This allows us to retrieve the\n  current Plone version with 'Products.CMFPlone.__version__'. Even though this\n  is no offical standard, many packages in the Python standard library provide\n  this.\n  [timo]\n\n- Replaced the legacy mark_special_links javascript with a\n  corresponding mockup pattern.\n  [fulv]\n\n- remove plone_javascript_variables.js as necessary values\n  are provided on body tag and pattern options\n  [vangheem]\n\n- fix bootstrap css bleeding into global namespaces\n  [vangheem]\n\n- add recurrence pattern\n  [vangheem]\n\n- add history support for folder contents\n  [vangheem]\n\n- Merge plone.app.search here\n  [vangheem]\n\n- Extended ulocalized_time for target_language\n  [agitator]\n\n- Caching for ``@@site-logo``.\n  [thet]\n\n- Support for portal site logos stored in the portal registry by uploading via\n  the site control panel. Add a ``@@site-logo`` view for downloading the logo.\n  [thet]\n\n- Fix the resource registry to save the automatically generated filepath to the\n  compiled resource on the bundle object after compilation. The filepath is\n  always in the '++plone++static/' namespace. This fix makes custom bundles\n  actually includable.\n  [thet]\n\n- Get icon from layout_view instead of plone_view.\n  [pbauer]\n\n- Fix contentViews (tabs) markup for Plone 5.\n  [davisagli]\n\n- Rename syndication-settings to syndication-controlpanel. Keep the old view registration for backwards compatibility.\n  [timo]\n\n- Added a link for the advanced 'Create a Plone site' screen to the Plone overview.\n  [jaroel]\n\n- Fixed the label for 'Example content' in the advanced 'Create a Plone site' screen.\n  [jaroel]\n\n- Move markup control panel to CMFPlone. Fixes #220.\n  [djay, thet]\n\n- Use jstz to set default portal_timezone in @@plone-addsite.\n  [instification]\n\n- Make inline validation of AT multiple selection widget work.\n  [gbastien]\n\n- Make sure compiling resources does not commit transaction prematurely.\n  [davisagli]\n\n- Adding the option to configure a bundle from the diazo manifest file.\n  [bloodbare]\n\n- Move the controlpanel overview from plone.app.controlpanel into this package\n  https://github.com/plone/Products.CMFPlone/issues/290\n  [khink]\n\n- PLIP 10359: Migrate usergroups controlpanel to ``z3c.form`` and move it from\n  plone.app.controlpanel to Products.CMFPlone. Fix and extend tests and add\n  robot tests.\n  [ferewuz]\n\n\n5.0a3 (2014-11-01)\n------------------\n\n- folder_position script: make position and id optional.  Default\n  position to 'ordered' and id to None, which means: do nothing.\n  plone.folder 1.0.5 allows this, making it possible to simply reverse\n  the current sort order by using reverse=False.\n  [maurits]\n\n- Fix JS resource viewlet HTML syntax error.\n  [rpatterson]\n\n- Fix resource bundle expressions.  They weren't being checked at all and\n  reversed the condition if they had been.  Also move caching of the cooked\n  expressions out of the DB and into a RAM cache.\n  [rpatterson]\n\n- Fix endless resource dependency loop when dependeing on a bundle that also has\n  a dependency.\n  [rpatterson]\n\n- reduce deprecation warnings to use plone_layout and not plone_view for\n  certain method calls in order to make debugging of robottests easier:\n  w/o it shows 1000ds of extra lines in html report.\n  [jensens]\n\n- type controlpanel: Resolved problem with workflow selection form as it\n  was breaking if state title had non-ascii characters. see also\n  https://github.com/plone/plone.app.controlpanel/pull/26\n  [lewicki, jensens]\n\n- Minor overhaul of CatalogTool.py - no feature changes!\n  Optimizations and better readable code for indexer\n  ``allowedRolesAndUsers``: now using a set.\n  Change if/elif/else to oneliner boolean expression in ``is_folderish``\n  indexer.\n  Usage of AccessControl 3 style decorators for security declarations.\n  Minor reformattings to make code-analysis happy.\n  [jensens]\n\n- Removed some javascripts: fullscreenmode.js, dragdropreorder.js,\n  styleswitcher.js, select_all.js, collapsibleformfields.js\n\n- PLIP 13260: Migration cut, copy and paste into browser views.\n  [saily]\n\n- Abstract the search form and livesearch action URLs making it easier to\n  extend the search portlet with custom views or other actions.\n  [rpatterson]\n\n- Fix JavaScript to work with recent jQuery (>= 1.9) versions.\n  [thet]\n\n- Small scoping fix in locking js code\n  [do3cc]\n\n- PLIP 13260: Migrate author page to browser views/z3c.form (issue #78)\n  [bosim]\n\n- Integration of the new markup update and CSS for both Plone and Barceloneta\n  theme. This is the work done in the GSOC Barceloneta theme project.\n  [albertcasado, sneridagh]\n\n- Created new viewlet manager for holding main navigation for a more semantic\n  use of it. Move the global sections viewlet into it.\n  [albertcasado]\n\n- New toolbar markup based in ul li tags.\n  [albertcasado, bloodbare, sneridagh]\n\n- Update <div id=\"content\"> in all templates with <article id=\"content\">\n  [albertcasado]\n\n- PLIP 14261: New resource registries.\n  [bloodbare, vangheem, robgietema, et al]\n\n\n5.0a2 (2014-04-20)\n------------------\n\n- Advertise the migration of content to dexterity after a successful\n  upgrade to Plone 5.\n  [pbauer]\n\n- Strip leading & trailing spaces from id and title in rename-form.\n  See https://dev.plone.org/ticket/12998, https://dev.plone.org/ticket/12989,\n  https://dev.plone.org/ticket/9370, https://dev.plone.org/ticket/8338\n  [pbauer]\n\n- Fix incorrect use of dict get method in CatalogTool.search, introduced\n  by PloneHotfix20131210 (issue 195)\n  [fulv]\n\n- Added timezone selection to add site page\n  [pysailor, yenzenz]\n\n- Added date date and time controlpanel (moved over from plone.app.event).\n  [yenzenz. thet]\n\n- Remove DL/DT/DD's from portal messages, portlet templates and others.\n  https://github.com/plone/Products.CMFPlone/issues/153\n  https://github.com/plone/Products.CMFPlone/issues/163\n  [khink]\n\n- PLIP 13260 remove templates and form scripts for\n  ``select_default_page`` and ``select_default_view`` because they got\n  migrated to browser views. Fix tests for that and remove legacy tests.\n  See: https://github.com/plone/Products.CMFPlone/issues/90\n  [saily]\n\n- PLIP 13260: Migration contact-info to ``z3c.form`` and make it highly\n  customizeable.\n  [timitos, saily]\n\n\n5.0a1 (2014-03-02)\n------------------\n\n- remove quickinstall control panel form since a new one was moved to\n  plone.app.controlpanel\n  [vangheem]\n\n- Add 'warning' and 'error' status message types to the test_rendering\n  view.\n  [esteele]\n\n- Update the front-page links.\n  [esteele]\n\n- In plone-overview view, we can now see Plone sites which are contained into\n  Zope folder.\n  [bsuttor]\n\n- Make Plone tool read the exposeDCMetaTags from p.a.registry instead of\n  of the site properties.\n  [timo]\n\n- Hide plone.app.registry install profile in the add-ons control panel.\n  [esteele]\n\n- Removed spamProtect.py script, since it doesn't offer real protection.\n  [davisagli]\n\n- Moved the member search form to plone.app.users\n  [pabo3000]\n\n- PLIP #13705: Remove <base> tag.\n  [frapell]\n\n- merge hotfixes from 20131210\n  [vangheem]\n\n- handle plone.app.textfield RichTextValue objects in syndication. Should\n  fix syndication with plone.app.contenttypes.\n  [vangheem]\n\n- FolderFeed adapter now takes into account the limit property when displaying\n  the RSS feed just like the other adapters do\n  [ichim-david]\n\n- Remove the portal_calendar tool and the dependency on CMFCalendar.\n  [davisagli]\n\n- Remove the plone_deprecated skin layer.\n  [gforcada, davisagli]\n\n- Moved portal_factory and portal_metadata from Products.CMFPlone to\n  Products.ATContentTypes (PLIP #13770)\n  [ale-rt]\n\n- Remove the portal_interface tool.\n  [ale-rt]\n\n- Remove the portal_actionicons tool.\n  [davisagli]\n\n- Remove ownership_form and change_ownership script, which were not used.\n  [davisagli]\n\n- Convert author_feedback_template and accessibility_info to browser views.\n  [bloodbare]\n\n- Move calendar_macros and jscalendar to Products.Archetypes.\n  [bloodbare]\n\n- Remove plonetheme.classic from the package dependencies and the default\n  extension profile, since it will not ship with Plone 5.\n  [timo]\n\n- Move docs/CHANGES.txt to CHANGES.rst.\n  [timo]\n\n- Replace deprecated test assert statements.\n  [timo]\n\n- Add a dependency on plone.app.theming. Install by default.\n  [esteele]\n\n- Drop dependency on plonetheme.classic.\n  [esteele]\n\n- Remove old logo.jpg. Use logo.png from Sunburst.\n  [esteele]\n\n- Inline validation JavaScript for z3c.form only sends request when\n  field name can be obtained from DOM for a widget (#13741).\n  [seanupton]\n\n- Add use_uuid_as_userid site property.\n  Part of PLIP 13419.\n  [maurits]\n\n- Let set_own_login_name use the update(Own)LoginName method from PAS.\n  Part of PLIP 13419.\n  [maurits]\n\n- recently_modified and recently_published respects allow anonymous to view\n  about setting\n  [vangheem]\n\n- Return a 404 instead of \"AttributeError: (dynamic view)\" if a user attempts to\n  view a still-temporary PortalFactory item.\n  [esteele]\n\n- Ensure that initial_login is set to True when a user first logs in.\n  [taito]\n\n- Merged PLIP #12198: Depend on Chameleon (five.pt) as a faster page template\n  engine.\n  [davisagli]\n\n- make extensionprofiles selection part of 'advanced' in plone-addsite\n  [jaroel]\n\n- enable syndication on plone.app.contenttypes collection\n  [vangheem]\n\n- fix syndication settings to not write on read\n  [vangheem]\n\n- fix wrong download url for podcast syndication\n  [Rudd-O]\n\n- Merged PLIP #12344: Use Dexterity-based core content types.\n\n  * Avoid including ATContentTypes and Archetypes as a dependency.\n  * Install the plone.app.contenttypes profile for new sites.\n\n  [davisagli et al]\n\n- Merged PLIP #13270: Move presentation mode out of core.\n  If the feature is still desired, use the plone.app.s5slideshow add-on.\n  [davisagli]\n\n- Add \"plone-5\" ZCML feature. Add-ons can register\n  ZCML for Plone 5 only using zcml:condition=\"have plone-5\"\n  [davisagli]\n\n- Plone's javascript is now developed as part of the Plone mockup\n  (http://github.com/plone/mockup) and is included as a compiled\n  bundle.\n  [davisagli]\n\n- Removed portal_interface tool (PLIP #13770)\n  [ale-rt]\n\n- Removed kss_field_decorator_view support\n  [maurits, jaroel]\n", "from Products.CMFCore.URLTool import URLTool as BaseTool\nfrom Products.CMFCore.utils import getToolByName\nfrom AccessControl import ClassSecurityInfo\nfrom App.class_init import InitializeClass\nfrom Products.CMFPlone.PloneBaseTool import PloneBaseTool\n\nfrom posixpath import normpath\nfrom urlparse import urlparse, urljoin\nimport re\n\n\nclass URLTool(PloneBaseTool, BaseTool):\n\n    meta_type = 'Plone URL Tool'\n    security = ClassSecurityInfo()\n    toolicon = 'skins/plone_images/link_icon.png'\n\n    security.declarePublic('isURLInPortal')\n    def isURLInPortal(self, url, context=None):\n        \"\"\" Check if a given url is on the same host and contains the portal\n            path.  Used to ensure that login forms can determine relevant\n            referrers (i.e. in portal).  Also return true for some relative\n            urls if context is passed in to allow for url parsing. When context\n            is not provided, assume that relative urls are in the portal. It is\n            assumed that http://portal is the same portal as https://portal.\n\n            External sites listed in 'allow_external_login_sites' of\n            site_properties are also considered within the portal to allow for\n            single sign on.\n        \"\"\"\n        # sanitize url\n        url = re.sub('^[\\x00-\\x20]+', '', url).strip()\n        if ('<script' in url or '%3Cscript' in url or 'javascript:' in url or\n                'javascript%3A' in url):\n            return False\n\n        p_url = self()\n\n        _, u_host, u_path, _, _, _ = urlparse(url)\n        if not u_host and not u_path.startswith('/'):\n            if context is None:\n                return True  # old behavior\n            if not context.isPrincipiaFolderish:\n                useurl = context.aq_parent.absolute_url()\n            else:\n                useurl = context.absolute_url()\n        else:\n            useurl = p_url  # when u_path.startswith('/')\n        if not useurl.endswith('/'):\n            useurl += '/'\n\n        # urljoin to current url to get an absolute path\n        _, u_host, u_path, _, _, _ = urlparse(urljoin(useurl, url))\n\n        # normalise to end with a '/' so /foobar is not considered within /foo\n        if not u_path:\n            u_path = '/'\n        else:\n            u_path = normpath(u_path)\n            if not u_path.endswith('/'):\n                u_path += '/'\n        _, host, path, _, _, _ = urlparse(p_url)\n        if not path.endswith('/'):\n            path += '/'\n        if host == u_host and u_path.startswith(path):\n            return True\n\n        props = getToolByName(self, 'portal_properties').site_properties\n        for external_site in props.getProperty('allow_external_login_sites', []):\n            _, host, path, _, _, _ = urlparse(external_site)\n            if not path.endswith('/'):\n                path += '/'\n            if host == u_host and u_path.startswith(path):\n                return True\n        return False\n\n\nURLTool.__doc__ = BaseTool.__doc__\n\nInitializeClass(URLTool)\n", "import unittest\n\nfrom Products.CMFCore.tests.base.dummy import DummySite\nfrom Products.CMFCore.tests.base.dummy import DummyFolder\nfrom Products.CMFCore.tests.base.dummy import DummyContent\n\nfrom Acquisition import aq_parent\n\n\nclass DummyFolder(DummyFolder):\n    def absolute_url(self):\n        return '/'.join([aq_parent(self).absolute_url(), self.getId()])\n\n\nclass DummyProperties(DummyContent):\n\n    _allow_external_login_sites = [\n        'http://external1',\n        'http://external2/',\n        'http://external3/site',\n        'http://external4/site/'\n        ]\n\n    def getProperty(self, name, default=None):\n        if name == 'allow_external_login_sites':\n            return self._allow_external_login_sites\n        return default\n\n\nclass TestURLTool(unittest.TestCase):\n\n    def setUp(self):\n        self.site = DummySite(id='foo')\n        self.site._setObject('foo', DummyFolder(id='foo'))\n        self.site.foo._setObject('doc1', DummyContent(id='doc1'))\n        self.site.portal_properties = DummyProperties(id='portal_properties')\n        self.site.portal_properties.site_properties = \\\n            DummyProperties(id='site_properties')\n\n    def _makeOne(self, *args, **kw):\n        from Products.CMFPlone.URLTool import URLTool\n        url_tool = URLTool(*args, **kw)\n        return url_tool.__of__(self.site)\n\n    def test_isURLInPortal(self):\n        url_tool = self._makeOne()\n        iURLiP = url_tool.isURLInPortal\n        self.assertTrue(iURLiP('http://www.foobar.com/bar/foo/folder'))\n        self.assertTrue(iURLiP('http://www.foobar.com/bar/foo'))\n        self.assertFalse(iURLiP('http://www.foobar.com/bar2/foo'))\n        self.assertTrue(iURLiP('https://www.foobar.com/bar/foo/folder'))\n        self.assertFalse(iURLiP('http://www.foobar.com:8080/bar/foo/folder'))\n        self.assertFalse(iURLiP('http://www.foobar.com/bar'))\n        self.assertFalse(iURLiP('/images'))\n        self.assertTrue(iURLiP('/bar/foo/foo'))\n\n    def test_isURLInPortalRelative(self):\n        url_tool = self._makeOne()\n        iURLiP = url_tool.isURLInPortal\n\n        #non-root relative urls will need a current context to be passed in\n        self.assertTrue(iURLiP('images/img1.jpg'))\n        self.assertTrue(iURLiP('./images/img1.jpg'))\n\n        # /bar/foo/something\n        self.assertTrue(iURLiP('../something', self.site.foo.doc1))\n        # /bar/afolder\n        self.assertFalse(iURLiP('../../afolder', self.site.foo.doc1))\n        # /afolder\n        self.assertFalse(iURLiP('../../../afolder', self.site.foo.doc1))\n\n        # /../afolder? How do we have more ../'s than there are parts in\n        # the URL?\n        self.assertFalse(iURLiP('../../../../afolder', self.site.foo.doc1))\n\n        # /bar/foo/afolder\n        self.assertTrue(iURLiP('../../foo/afolder', self.site.foo.doc1))\n\n    def test_isURLInPortalExternal(self):\n        url_tool = self._makeOne()\n        iURLiP = url_tool.isURLInPortal\n        self.assertTrue(iURLiP('http://external1'))\n        self.assertTrue(iURLiP('http://external1/'))\n        self.assertTrue(iURLiP('http://external1/something'))\n        self.assertTrue(iURLiP('http://external2'))\n        self.assertTrue(iURLiP('http://external2/'))\n        self.assertTrue(iURLiP('http://external2/something'))\n        self.assertTrue(iURLiP('http://external3/site'))\n        self.assertTrue(iURLiP('http://external3/site/'))\n        self.assertTrue(iURLiP('http://external3/site/something'))\n        self.assertTrue(iURLiP('http://external4/site'))\n        self.assertTrue(iURLiP('http://external4/site/'))\n        self.assertTrue(iURLiP('http://external4/site/something'))\n\n        self.assertFalse(iURLiP('http://external3/other'))\n        self.assertFalse(iURLiP('http://external4/other'))\n        self.assertFalse(iURLiP('http://external5'))\n        self.assertFalse(iURLiP('http://external11'))\n\n    def test_script_tag_url_not_in_portal(self):\n        url_tool = self._makeOne()\n        iURLiP = url_tool.isURLInPortal\n        self.assertFalse(iURLiP('<script>alert(\"hi\");</script>'))\n        self.assertFalse(\n            iURLiP('%3Cscript%3Ealert(%22hi%22)%3B%3C%2Fscript%3E'))\n\n    def test_inline_url_not_in_portal(self):\n        url_tool = self._makeOne()\n        iURLiP = url_tool.isURLInPortal\n        self.assertFalse(iURLiP('javascript%3Aalert(3)'))\n        self.assertFalse(iURLiP('javascript:alert(3)'))\n"], "filenames": ["CHANGES.rst", "Products/CMFPlone/URLTool.py", "Products/CMFPlone/tests/testURLTool.py"], "buggy_code_start_loc": [9, 32, 98], "buggy_code_end_loc": [9, 32, 98], "fixing_code_start_loc": [10, 33, 99], "fixing_code_end_loc": [13, 36, 112], "type": "CWE-79", "message": "Cross-site scripting (XSS) vulnerability in Plone 3.3.0 through 3.3.6, 4.0.0 through 4.0.10, 4.1.0 through 4.1.6, 4.2.0 through 4.2.7, 4.3.x before 4.3.7, and 5.0rc1.", "other": {"cve": {"id": "CVE-2015-7316", "sourceIdentifier": "cve@mitre.org", "published": "2017-09-25T17:29:00.587", "lastModified": "2017-10-03T14:47:29.810", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Cross-site scripting (XSS) vulnerability in Plone 3.3.0 through 3.3.6, 4.0.0 through 4.0.10, 4.1.0 through 4.1.6, 4.2.0 through 4.2.7, 4.3.x before 4.3.7, and 5.0rc1."}, {"lang": "es", "value": "Existe una vulnerabilidad de tipo Cross-Site Scripting (XSS) en Plone desde la versi\u00f3n 3.3.0 hasta la versi\u00f3n 3.3.6, desde la 4.0.0 hasta la 4.0.10, desde la 4.1.0 hasta la 4.1.6, desde la 4.2.0 hasta la 4.2.7, en las versiones 4.3.x anteriores a la 4.3.7 y 5.0rc1."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:3.3:*:*:*:*:*:*:*", "matchCriteriaId": "FDC93803-6506-4382-A013-18010EE7E06B"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:3.3.1:*:*:*:*:*:*:*", "matchCriteriaId": "E65977FD-A880-4D16-B56B-94A72774F42D"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:3.3.2:*:*:*:*:*:*:*", "matchCriteriaId": "4EA5B4F8-2155-403D-97D8-1272285D508B"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:3.3.3:*:*:*:*:*:*:*", "matchCriteriaId": "A3CA2943-77E5-4384-A019-415BBCE62F94"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:3.3.4:*:*:*:*:*:*:*", "matchCriteriaId": "B7FF63F6-F1DC-4A97-A2E6-11CF613A31E8"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:3.3.5:*:*:*:*:*:*:*", "matchCriteriaId": "538A3519-5B04-4FE5-A3C0-FD26EFA32705"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:3.3.6:*:*:*:*:*:*:*", "matchCriteriaId": "858CBC5A-C241-475C-8125-C5EA351B12A7"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:4.0:*:*:*:*:*:*:*", "matchCriteriaId": "F3306D84-0F5B-46BA-9BCC-DCD0A1CDD604"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:4.0.1:*:*:*:*:*:*:*", "matchCriteriaId": "E08F4534-A588-463F-A745-39E559AB1CB8"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:4.0.2:*:*:*:*:*:*:*", "matchCriteriaId": "B64341BA-5722-415E-9771-9837168AB7C0"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:4.0.3:*:*:*:*:*:*:*", "matchCriteriaId": "E2929227-AE19-428D-9AC3-D312A559039B"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:4.0.4:*:*:*:*:*:*:*", "matchCriteriaId": "3B6DC866-0FEE-475B-855C-A69E004810CD"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:4.0.5:*:*:*:*:*:*:*", "matchCriteriaId": "50BF3E8E-152C-4E89-BAA2-A952D10F4611"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:4.0.7:*:*:*:*:*:*:*", "matchCriteriaId": "F1F88BF6-9058-4CB8-A2D6-5653860CF489"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:4.0.8:*:*:*:*:*:*:*", "matchCriteriaId": "B2AA3FA2-15C3-444A-8810-5EF3E0E84D58"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:4.0.9:*:*:*:*:*:*:*", "matchCriteriaId": "72F3B15A-CD0F-4CC5-A76F-E62637B30E2E"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:4.0.10:*:*:*:*:*:*:*", "matchCriteriaId": "D913FCA7-4DAE-4E9A-9146-9AFA8472B04B"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:4.1:*:*:*:*:*:*:*", "matchCriteriaId": "7C44B53B-953B-4522-A5B4-11573850D2CD"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:4.1.1:*:*:*:*:*:*:*", "matchCriteriaId": "D8883023-113A-420A-97B6-A4A9B29CF7DB"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:4.1.2:*:*:*:*:*:*:*", "matchCriteriaId": "4DF4D113-8D9D-4DA3-A177-64783352F608"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:4.1.3:*:*:*:*:*:*:*", "matchCriteriaId": "28F9B699-D1A4-425C-84ED-6A8FD29BE7F8"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:4.1.4:*:*:*:*:*:*:*", "matchCriteriaId": "47321B60-67DA-4543-B173-D629A9569B45"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:4.1.5:*:*:*:*:*:*:*", "matchCriteriaId": "58B36EB2-723F-4E25-8018-EEB2BE806D9D"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:4.1.6:*:*:*:*:*:*:*", "matchCriteriaId": "7962EF74-6AC1-424C-A202-163AFDADA971"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:4.2:*:*:*:*:*:*:*", "matchCriteriaId": "1F1818BB-E23A-4136-898D-1D0C80C08728"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:4.2.1:*:*:*:*:*:*:*", "matchCriteriaId": "5CB06627-133A-40D1-8816-E31E0A9BAD22"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:4.2.2:*:*:*:*:*:*:*", "matchCriteriaId": "AE7E448A-2C0C-4DE0-89EA-904718CB6C6D"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:4.2.3:*:*:*:*:*:*:*", "matchCriteriaId": "6E727C5C-9E54-49F7-B92C-2492069AAE08"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:4.2.4:*:*:*:*:*:*:*", "matchCriteriaId": "BFD68465-4CDC-4788-8932-41335B5C4AC8"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:4.2.5:*:*:*:*:*:*:*", "matchCriteriaId": "A7B739E0-FB73-401C-AB1A-E3C1434AA2A3"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:4.2.6:*:*:*:*:*:*:*", "matchCriteriaId": "DCC8B987-5173-4C61-8DE6-B70C18EE6FD3"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:4.2.7:*:*:*:*:*:*:*", "matchCriteriaId": "38BA31E8-77EC-478B-BC6E-E2F145A8B9BD"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:4.3:*:*:*:*:*:*:*", "matchCriteriaId": "CE168A35-1A46-4A6F-8A08-25CDD886066D"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:4.3.1:*:*:*:*:*:*:*", "matchCriteriaId": "CFE0FC06-369B-46CF-9B1E-BAF7AF87E950"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:4.3.2:*:*:*:*:*:*:*", "matchCriteriaId": "56571585-E9A2-4B78-B2B1-5D8EADED522A"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:4.3.3:*:*:*:*:*:*:*", "matchCriteriaId": "2CDF8A15-401C-453E-8D09-8D4CDD4766DB"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:4.3.4:*:*:*:*:*:*:*", "matchCriteriaId": "39B0B1CE-C0D9-495C-B4E7-E52A50BD6D97"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:4.3.5:*:*:*:*:*:*:*", "matchCriteriaId": "043B3CBE-DEA2-474D-AA57-1830A470B621"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:4.3.6:*:*:*:*:*:*:*", "matchCriteriaId": "08A6842B-B479-4D91-928A-1CCE1DCB936E"}, {"vulnerable": true, "criteria": "cpe:2.3:a:plone:plone:5.0:rc1:*:*:*:*:*:*", "matchCriteriaId": "8AF9FB6C-134F-4653-8771-1BF46AB39344"}]}]}], "references": [{"url": "http://www.openwall.com/lists/oss-security/2015/09/22/14", "source": "cve@mitre.org", "tags": ["Mailing List", "Patch", "Third Party Advisory"]}, {"url": "https://bugzilla.redhat.com/show_bug.cgi?id=1264788", "source": "cve@mitre.org", "tags": ["Issue Tracking", "Patch", "Third Party Advisory"]}, {"url": "https://github.com/plone/Products.CMFPlone/commit/3da710a2cd68587f0bf34f2e7ea1167d6eeee087", "source": "cve@mitre.org", "tags": ["Issue Tracking", "Patch", "Third Party Advisory"]}, {"url": "https://plone.org/security/hotfix/20150910/non-persistent-xss-in-plone", "source": "cve@mitre.org", "tags": ["Vendor Advisory"]}]}, "github_commit_url": "https://github.com/plone/Products.CMFPlone/commit/3da710a2cd68587f0bf34f2e7ea1167d6eeee087"}}