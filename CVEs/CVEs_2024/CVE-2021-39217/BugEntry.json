{"buggy_code": ["<?php\n/**\n * OpenMage\n *\n * NOTICE OF LICENSE\n *\n * This source file is subject to the Open Software License (OSL 3.0)\n * that is bundled with this package in the file LICENSE.txt.\n * It is also available through the world-wide-web at this URL:\n * https://opensource.org/licenses/osl-3.0.php\n * If you did not receive a copy of the license and are unable to\n * obtain it through the world-wide-web, please send an email\n * to license@magento.com so we can send you a copy immediately.\n *\n * @category   Mage\n * @package    Mage_Core\n * @copyright  Copyright (c) 2006-2020 Magento, Inc. (https://www.magento.com)\n * @copyright  Copyright (c) 2020-2022 The OpenMage Contributors (https://www.openmage.org)\n * @license    https://opensource.org/licenses/osl-3.0.php  Open Software License (OSL 3.0)\n */\n\n/**\n * @category   Mage\n * @package    Mage_Core\n * @author     Magento Core Team <core@magentocommerce.com>\n */\nclass Mage_Core_Helper_Security\n{\n    private $invalidBlockActions\n        = [\n            ['block' => Mage_Page_Block_Html_Topmenu_Renderer::class, 'method' => 'render'],\n            ['block' => Mage_Core_Block_Template::class, 'method' => 'fetchView'],\n        ];\n\n    /**\n     * @param Mage_Core_Block_Abstract $block\n     * @param string                   $method\n     * @param string[]                 $args\n     *\n     * @throws Mage_Core_Exception\n     */\n    public function validateAgainstBlockMethodBlacklist(Mage_Core_Block_Abstract $block, $method, array $args)\n    {\n        foreach ($this->invalidBlockActions as $action) {\n            $calledMethod = strtolower($method);\n            if (($block instanceof $action['block'] && strtolower($action['method']) === $calledMethod)\n                || ($block instanceof $action['block']\n                    && strtolower($action['block'] . '::' . $action['method']) === $calledMethod)\n            ) {\n                Mage::throwException(\n                    sprintf('Action with combination block %s and method %s is forbidden.', get_class($block), $method)\n                );\n            }\n        }\n    }\n}\n", "<?php\ndeclare(strict_types=1);\n\nnamespace OpenMage\\Tests\\Unit\\Core\\Helper;\n\nuse PHPUnit\\Framework\\TestCase;\n\nclass Security extends TestCase\n{\n\n    public function validateAgainstBlockMethodBlacklistDataProvider()\n    {\n        $topmenu = new \\Mage_Page_Block_Html_Topmenu_Renderer();\n        $template = new \\Mage_Core_Block_Template();\n\n        return [\n            [\n                $topmenu,\n                'setData',\n                []\n            ],\n            [\n                $template,\n                'setData',\n                []\n            ],\n        ];\n    }\n\n    /**\n     * @dataProvider validateAgainstBlockMethodBlacklistDataProvider\n     * @doesNotPerformAssertions if data is correct, then NO exception is thrown, so we don't need an assertion\n     * @return void\n     */\n    public function testValidateAgainstBlockMethodBlacklist($block, $method, $args)\n    {\n        $securityHelper = new \\Mage_Core_Helper_Security();\n        $securityHelper->validateAgainstBlockMethodBlacklist($block, $method, $args);\n    }\n\n\n    public function forbiddenBlockMethodsDataProvider()\n    {\n        $topmenu = new \\Mage_Page_Block_Html_Topmenu_Renderer();\n        $template = new \\Mage_Core_Block_Template();\n\n        return [\n            [\n                $template,\n                'fetchView',\n                []\n            ],\n            [\n                $topmenu,\n                'fetchView',\n                []\n            ],\n            [\n                $topmenu,\n                'render',\n                []\n            ],\n            [\n                $template,\n                'Mage_Core_Block_Template::fetchView',\n                []\n            ],\n            'parent class name is passed as second arg' => [\n                $topmenu,\n                'Mage_Core_Block_Template::fetchView',\n                []\n            ],\n        ];\n    }\n\n    /**\n     * @dataProvider forbiddenBlockMethodsDataProvider\n     * @return void\n     */\n    public function testValidateAgainstBlockMethodBlacklistThrowsException($block, $method, $args)\n    {\n        $this->expectExceptionMessage(\\sprintf('Action with combination block %s and method %s is forbidden.', get_class($block), $method));\n\n        $securityHelper = new \\Mage_Core_Helper_Security();\n        $securityHelper->validateAgainstBlockMethodBlacklist($block, $method, $args);\n    }\n}"], "fixing_code": ["<?php\n/**\n * OpenMage\n *\n * NOTICE OF LICENSE\n *\n * This source file is subject to the Open Software License (OSL 3.0)\n * that is bundled with this package in the file LICENSE.txt.\n * It is also available through the world-wide-web at this URL:\n * https://opensource.org/licenses/osl-3.0.php\n * If you did not receive a copy of the license and are unable to\n * obtain it through the world-wide-web, please send an email\n * to license@magento.com so we can send you a copy immediately.\n *\n * @category   Mage\n * @package    Mage_Core\n * @copyright  Copyright (c) 2006-2020 Magento, Inc. (https://www.magento.com)\n * @copyright  Copyright (c) 2020-2022 The OpenMage Contributors (https://www.openmage.org)\n * @license    https://opensource.org/licenses/osl-3.0.php  Open Software License (OSL 3.0)\n */\n\n/**\n * @category   Mage\n * @package    Mage_Core\n * @author     Magento Core Team <core@magentocommerce.com>\n */\nclass Mage_Core_Helper_Security\n{\n    private $invalidBlockActions\n        = [\n            ['block' => Mage_Page_Block_Html_Topmenu_Renderer::class, 'method' => 'render'],\n            ['block' => Mage_Core_Block_Template::class, 'method' => 'fetchView'],\n        ];\n\n    /**\n     * @param Mage_Core_Block_Abstract $block\n     * @param string                   $method\n     * @param string[]                 $args\n     *\n     * @throws Mage_Core_Exception\n     */\n    public function validateAgainstBlockMethodBlacklist(Mage_Core_Block_Abstract $block, $method, array $args)\n    {\n        foreach ($this->invalidBlockActions as $action) {\n            $calledMethod = strtolower($method);\n            if (str_contains($calledMethod, '::')) {\n                $calledMethod = explode('::', $calledMethod)[1];\n            }\n            if ($block instanceof $action['block'] && strtolower($action['method']) === $calledMethod) {\n                Mage::throwException(\n                    sprintf('Action with combination block %s and method %s is forbidden.', get_class($block), $method)\n                );\n            }\n        }\n    }\n}\n", "<?php\ndeclare(strict_types=1);\n\nnamespace OpenMage\\Tests\\Unit\\Core\\Helper;\n\nuse PHPUnit\\Framework\\TestCase;\n\nclass Security extends TestCase\n{\n\n    public function validateAgainstBlockMethodBlacklistDataProvider()\n    {\n        $topmenu = new \\Mage_Page_Block_Html_Topmenu_Renderer();\n        $template = new \\Mage_Core_Block_Template();\n\n        return [\n            [\n                $topmenu,\n                'setData',\n                []\n            ],\n            [\n                $template,\n                'setData',\n                []\n            ],\n        ];\n    }\n\n    /**\n     * @dataProvider validateAgainstBlockMethodBlacklistDataProvider\n     * @doesNotPerformAssertions if data is correct, then NO exception is thrown, so we don't need an assertion\n     * @return void\n     */\n    public function testValidateAgainstBlockMethodBlacklist($block, $method, $args)\n    {\n        $securityHelper = new \\Mage_Core_Helper_Security();\n        $securityHelper->validateAgainstBlockMethodBlacklist($block, $method, $args);\n    }\n\n\n    public function forbiddenBlockMethodsDataProvider()\n    {\n        $topmenu = new \\Mage_Page_Block_Html_Topmenu_Renderer();\n        $template = new \\Mage_Core_Block_Template();\n\n        return [\n            [\n                $template,\n                'fetchView',\n                []\n            ],\n            [\n                $topmenu,\n                'fetchView',\n                []\n            ],\n            [\n                $topmenu,\n                'render',\n                []\n            ],\n            [\n                $template,\n                'Mage_Core_Block_Template::fetchView',\n                []\n            ],\n            [\n                $topmenu,\n                'Mage_Page_Block_Html_Topmenu_Renderer::fetchView',\n                []\n            ],\n            'parent class name is passed as second arg' => [\n                $topmenu,\n                'Mage_Core_Block_Template::fetchView',\n                []\n            ],\n            'parent class name is passed as second arg2' => [\n                $topmenu,\n                'Mage_Core_Block_Template::render',\n                []\n            ],\n        ];\n    }\n\n    /**\n     * @dataProvider forbiddenBlockMethodsDataProvider\n     * @return void\n     */\n    public function testValidateAgainstBlockMethodBlacklistThrowsException($block, $method, $args)\n    {\n        $this->expectExceptionMessage(\\sprintf('Action with combination block %s and method %s is forbidden.', get_class($block), $method));\n\n        $securityHelper = new \\Mage_Core_Helper_Security();\n        $securityHelper->validateAgainstBlockMethodBlacklist($block, $method, $args);\n    }\n}"], "filenames": ["app/code/core/Mage/Core/Helper/Security.php", "dev/tests/unit/Mage/Core/Helper/Security.php"], "buggy_code_start_loc": [46, 67], "buggy_code_end_loc": [50, 70], "fixing_code_start_loc": [46, 68], "fixing_code_end_loc": [50, 81], "type": "CWE-77", "message": "OpenMage LTS is an e-commerce platform. Prior to versions 19.4.22 and 20.0.19, Custom Layout enabled admin users to execute arbitrary commands via block methods. Versions 19.4.22 and 20.0.19 contain patches for this issue.", "other": {"cve": {"id": "CVE-2021-39217", "sourceIdentifier": "security-advisories@github.com", "published": "2023-01-27T18:15:09.087", "lastModified": "2023-02-04T01:55:09.817", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "OpenMage LTS is an e-commerce platform. Prior to versions 19.4.22 and 20.0.19, Custom Layout enabled admin users to execute arbitrary commands via block methods. Versions 19.4.22 and 20.0.19 contain patches for this issue."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "HIGH", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 7.2, "baseSeverity": "HIGH"}, "exploitabilityScore": 1.2, "impactScore": 5.9}, {"source": "security-advisories@github.com", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "HIGH", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 7.2, "baseSeverity": "HIGH"}, "exploitabilityScore": 1.2, "impactScore": 5.9}]}, "weaknesses": [{"source": "security-advisories@github.com", "type": "Primary", "description": [{"lang": "en", "value": "CWE-77"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:openmage:magento:*:*:*:*:lts:*:*:*", "versionEndExcluding": "19.4.22", "matchCriteriaId": "B87F8CA0-6C21-4615-A520-39F1E9E737D5"}, {"vulnerable": true, "criteria": "cpe:2.3:a:openmage:magento:*:*:*:*:lts:*:*:*", "versionStartIncluding": "20.0.0", "versionEndExcluding": "20.0.19", "matchCriteriaId": "15B9BC3F-BF81-4DF5-B57B-ECF7059A7991"}]}]}], "references": [{"url": "https://github.com/OpenMage/magento-lts/commit/289bd4b4f53622138e3e5c2d2cef7502d780086f", "source": "security-advisories@github.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/OpenMage/magento-lts/releases/tag/v19.4.22", "source": "security-advisories@github.com", "tags": ["Release Notes", "Third Party Advisory"]}, {"url": "https://github.com/OpenMage/magento-lts/releases/tag/v20.0.19", "source": "security-advisories@github.com", "tags": ["Release Notes", "Third Party Advisory"]}, {"url": "https://github.com/OpenMage/magento-lts/security/advisories/GHSA-c9q3-r4rv-mjm7", "source": "security-advisories@github.com", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/OpenMage/magento-lts/commit/289bd4b4f53622138e3e5c2d2cef7502d780086f"}}