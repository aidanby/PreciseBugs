{"buggy_code": ["/**\n * 2007-2019 PrestaShop and Contributors\n *\n * NOTICE OF LICENSE\n *\n * This source file is subject to the Open Software License (OSL 3.0)\n * that is bundled with this package in the file LICENSE.txt.\n * It is also available through the world-wide-web at this URL:\n * https://opensource.org/licenses/OSL-3.0\n * If you did not receive a copy of the license and are unable to\n * obtain it through the world-wide-web, please send an email\n * to license@prestashop.com so we can send you a copy immediately.\n *\n * DISCLAIMER\n *\n * Do not edit or add to this file if you wish to upgrade PrestaShop to newer\n * versions in the future. If you wish to customize PrestaShop for your\n * needs please refer to https://www.prestashop.com for more information.\n *\n * @author    PrestaShop SA <contact@prestashop.com>\n * @copyright 2007-2019 PrestaShop SA and Contributors\n * @license   https://opensource.org/licenses/OSL-3.0 Open Software License (OSL 3.0)\n * International Registered Trademark & Property of PrestaShop SA\n */\n\n$(document).ready(function() {\n  form.init();\n  nav.init();\n  featuresCollection.init();\n  displayFormCategory.init();\n  formCategory.init();\n  stock.init();\n  supplier.init();\n  warehouseCombinations.init();\n  customFieldCollection.init();\n  virtualProduct.init();\n  attachmentProduct.init();\n  imagesProduct.init();\n  priceCalculation.init();\n  displayFieldsManager.refresh();\n  displayFieldsManager.init(virtualProduct);\n  seo.init();\n  tags.init();\n  rightSidebar.init();\n  recommendedModules.init();\n  BOEvent.emitEvent(\"Product Categories Management started\", \"CustomEvent\");\n  BOEvent.emitEvent(\"Product Default category Management started\", \"CustomEvent\");\n  BOEvent.emitEvent(\"Product Manufacturer Management started\", \"CustomEvent\");\n  BOEvent.emitEvent(\"Product Related Management started\", \"CustomEvent\");\n  BOEvent.emitEvent(\"Modal confirmation started\", \"CustomEvent\");\n  BOEvent.emitEvent(\"Product Combinations Management started\", \"CustomEvent\");\n\n  /** Type product fields display management */\n  $('#form_step1_type_product').change(function() {\n    displayFieldsManager.refresh();\n  });\n\n  // Validate price fields on input change\n  $(\".money-type input[type='text']\").change(function validate() {\n    var inputValue = priceCalculation.normalizePrice($(this).val());\n    var parsedValue = truncateDecimals(inputValue, 6);\n\n    $(this).val(parsedValue);\n  });\n\n  /** Attach date picker */\n  $('.datepicker').datetimepicker({\n    locale: full_language_code,\n    format: 'YYYY-MM-DD'\n  });\n\n  /** tooltips should be hidden when we move to another tab */\n  $('#form-nav').on('click','.nav-item', function clearTooltipsAndPopovers() {\n    $('[data-toggle=\"tooltip\"]').tooltip('hide');\n    $('[data-toggle=\"popover\"]').popover('hide');\n  });\n\n  $('.summary-description-container a[data-toggle=\"tab\"]').on('shown.bs.tab', resetEditor);\n});\n\n/**\n * Reset active tinyMce editor (triggered when switch language, or switching tabs)\n */\nfunction resetEditor() {\n  const languageEditorsSelector = '.summary-description-container .panel.active div.translation-field.active textarea.autoload_rte';\n  $(languageEditorsSelector).each(function(index, textarea) {\n    const editor = tinyMCE.get(textarea.id);\n    if (editor) {\n      //Reset content to force refresh of editor\n      editor.setContent(editor.getContent());\n    }\n  });\n}\n\n/**\n * Manage show or hide fields\n */\nvar displayFieldsManager = (function() {\n\n  var typeProduct = $('#form_step1_type_product');\n  var showVariationsSelector = $('#show_variations_selector');\n  var combinationsBlock = $('#combinations');\n  var managedVirtualProduct;\n\n  return {\n    'init': function (virtualProduct) {\n      managedVirtualProduct = virtualProduct;\n\n      /** Type product fields display management */\n      $('#form_step1_type_product').change(function () {\n        displayFieldsManager.refresh();\n      });\n\n      $('#form .form-input-title input').on('focus', function () {\n        $(this).select();\n      });\n\n      this.initVisibilityRule();\n\n      /** Tax rule dropdown shortcut */\n      $('a#tax_rule_shortcut_opener').on('click', function () {\n        // lazy instantiated\n        var duplicate = $('#form_step2_id_tax_rules_group_shortcut');\n        if (duplicate.length == 0) {\n          var origin = $('select#form_step2_id_tax_rules_group');\n          duplicate = origin.clone(false).attr('id', 'form_step2_id_tax_rules_group_shortcut');\n          origin.on('change', function () {\n            duplicate.val(origin.val()); // no change() here to avoid infinite loop.\n          });\n          duplicate.on('change', function () {\n            origin.val(duplicate.val()).change();\n          });\n          duplicate.appendTo($('#tax_rule_shortcut'));\n        }\n        duplicate.parent().parent().show();\n\n        return false;\n      });\n    },\n    /**\n     * When a product is available for order, its price should be visible,\n     * whereas products unavailable for order can have their prices visible or hidden.\n     */\n    'initVisibilityRule': function () {\n      var showPriceSelector = '.js-show-price';\n      var availableForOrderSelector = '.js-available-for-order';\n\n      var applyVisibilityRule = function applyVisibilityRule() {\n        var $availableForOrder = $(availableForOrderSelector + ' input');\n        var $showPrice = $(showPriceSelector + ' input');\n        var $showPriceColumn = $(showPriceSelector);\n        if ($availableForOrder.prop('checked')) {\n          $showPrice.prop('checked', true);\n          $showPriceColumn.addClass('hide');\n        } else {\n          $showPriceColumn.removeClass('hide');\n        }\n      };\n      $(availableForOrderSelector + ' .checkbox').on('click', applyVisibilityRule);\n      applyVisibilityRule();\n    },\n    'refresh': function () {\n      this.checkAccessVariations();\n      $('#virtual_product').hide();\n      $('#form-nav a[href=\"#step3\"]').text(translate_javascripts['Quantities']);\n\n      /** product type switch */\n\n      if (typeProduct.val() === '1') {\n        $('#pack_stock_type, #js_form_step1_inputPackItems').show();\n        $('#form-nav a[href=\"#step4\"]').show();\n        showVariationsSelector.hide();\n        showVariationsSelector.find('input[value=\"0\"]').attr('checked', true);\n      } else {\n        $('#virtual_product, #pack_stock_type, #js_form_step1_inputPackItems').hide();\n        $('#form-nav a[href=\"#step4\"]').show();\n\n        if (typeProduct.val() === '2') {\n          showVariationsSelector.hide();\n          $('#virtual_product').show();\n          $('#form-nav a[href=\"#step4\"]').hide();\n          showVariationsSelector.find('input[value=\"0\"]').attr('checked', true);\n          $('#form-nav a[href=\"#step3\"]').text(translate_javascripts['Virtual product']);\n        } else {\n          showVariationsSelector.show();\n          $('#form-nav a[href=\"#step3\"]').text(translate_javascripts['Quantities']);\n        }\n      }\n\n      // Switching from a product type to another which is not \"Virtual product\",\n      // triggers the destruction of pre-existing virtual product\n      var shouldDestroyVirtualProduct = typeProduct.val() !== '2';\n      if (shouldDestroyVirtualProduct && managedVirtualProduct !== undefined) {\n        managedVirtualProduct.destroy();\n      }\n\n      /** check quantity / combinations display */\n      if (showVariationsSelector.find('input:checked').val() === '1' || $('#accordion_combinations tr:not(#loading-attribute)').length > 0) {\n        combinationsBlock.show();\n\n        $('#form-nav a[href=\"#step3\"]').text(translate_javascripts['Combinations']);\n        $('#product_qty_0_shortcut_div, #quantities').hide();\n      } else {\n        combinationsBlock.hide();\n        $('#product_qty_0_shortcut_div, #quantities').show();\n      }\n\n      /** Tooltip for product type combinations */\n      if ($('input[name=\"show_variations\"][value=\"1\"]:checked').length >= 1) {\n        $('#product_type_combinations_shortcut').show();\n      } else {\n        $('#product_type_combinations_shortcut').hide();\n      }\n    },\n    'getProductType': function () {\n      switch (typeProduct.val()) {\n        case '0':\n          return 'standard';\n          break;\n        case '1':\n          return 'pack';\n          break;\n        case '2':\n          return 'virtual';\n          break;\n        default:\n          return 'standard';\n      }\n    },\n    /**\n     * Product pack or virtual can't have variations\n     * Warn e-merchant.\n     * @param errorMessage\n     */\n    'checkAccessVariations': function () {\n      if ((showVariationsSelector.find('input:checked').val() === '1' || $('#accordion_combinations tr:not(#loading-attribute)').length > 0) && (typeProduct.val() === '1' || typeProduct.val() === '2')) {\n        var typeOfProduct = this.getProductType();\n        var errorMessage = \"You can't create \" + typeOfProduct + \" product with variations. Are you sure to disable variations ? they will all be deleted.\";\n        modalConfirmation.create(translate_javascripts[errorMessage], null, {\n          onCancel: function () {\n            typeProduct.val(0).change();\n            /* else the radio bouton is not display even if checked attribute is true */\n            $('#show_variations_selector input[value=\"1\"]').click();\n          },\n          onContinue: function () {\n            $.ajax({\n              type: 'GET',\n              url: $('#accordion_combinations').attr('data-action-delete-all').replace(/delete-all\\/\\d+/, 'delete-all/' + $('#form_id_product').val()),\n              success: function () {\n                $('#accordion_combinations .combination').remove();\n                displayFieldsManager.refresh();\n              },\n              error: function (response) {\n                showErrorMessage(jQuery.parseJSON(response.responseText).message);\n              },\n            });\n          }\n        }).show();\n      }\n    }\n  }\n})();\n\n/**\n * Display category form management\n */\nvar displayFormCategory = (function() {\n  var parentElem = $('#add-categories');\n  return {\n    'init': function() {\n      /** Click event on the add button */\n      parentElem.find('a.open').on('click', function(e) {\n        e.preventDefault();\n        parentElem.find('#add-categories-content').removeClass('hide');\n        $(this).hide();\n      });\n    }\n  };\n})();\n\n/**\n * Form category management\n */\nvar formCategory = (function() {\n  var elem = $('#form_step1_new_category');\n\n  /** Send category form and it to nested categories */\n  function send(form) {\n    $.ajax({\n      type: 'POST',\n      url: elem.attr('data-action'),\n      data: {\n        'form[category][name]': $('#form_step1_new_category_name').val(),\n        'form[category][id_parent]': $('#form_step1_new_category_id_parent').val(),\n        'form[_token]': $('#form #form__token').val()\n      },\n      beforeSend: function() {\n        $('button.submit', elem).attr('disabled', 'disabled');\n        $('ul.text-danger', elem).remove();\n        $('*.has-danger', elem).removeClass('has-danger');\n        $('*.has-danger').removeClass('has-danger');\n      },\n      success: function(response) {\n        //inject new category into category tree\n        var html = '<li>' +\n          '<div class=\"checkbox js-checkbox\">' +\n            '<label>' +\n              '<input type=\"checkbox\" name=\"form[step1][categories][tree][]\" checked value=\"'+response.category.id+'\"> ' +\n                response.category.name[1] +\n                '<input type=\"radio\" value=\"'+response.category.id+'\" name=\"ignore\" class=\"default-category\">' +\n            '</label>' +\n          '</div>' +\n          '</li>';\n\n        var parentElement = $('#form_step1_categories input[value='+response.category.id_parent+']').parent().parent();\n        if(parentElement.next('ul').length === 0){\n          html = '<ul>' + html + '</ul>';\n          parentElement.append(html);\n        } else {\n          parentElement.next('ul').append(html);\n        }\n\n        //inject new category in parent category selector\n        $('#form_step1_new_category_id_parent').append('<option value=\"' + response.category.id + '\">' + response.category.name[1] + '</option>');\n\n        // create label\n        var tag = {\n          'name': response.category.name[1],\n          'id': response.category.id,\n          'breadcrumb': ''\n        };\n        productCategoriesTags.createTag(tag);\n\n        //hide the form\n        form.hideBlock();\n      },\n      error: function(response) {\n        $.each(jQuery.parseJSON(response.responseText), function(key, errors) {\n          var html = '<ul class=\"list-unstyled text-danger\">';\n          $.each(errors, function(key, error) {\n            html += '<li>' + error + '</li>';\n          });\n          html += '</ul>';\n\n          $('#form_step1_new_' + key).parent().append(html);\n          $('#form_step1_new_' + key).parent().addClass('has-danger');\n        });\n      },\n      complete: function() {\n        $('#form_step1_new_category button.submit').removeAttr('disabled');\n      }\n    });\n  }\n\n  return {\n    'init': function() {\n      var that = this;\n      /** remove all categories from selector, except pre defined */\n      $('#add-categories button.save').click(function(){\n        send(that);\n      });\n      $('#add-categories button[type=\"reset\"]').click(function(){\n        that.hideBlock();\n      });\n    },\n    'hideBlock': function() {\n      $('#form_step1_new_category_name').val('');\n      $('#add-category-button').show();\n      $('#add-categories-content').addClass('hide');\n    }\n  };\n})();\n\n/**\n * Feature collection management\n */\nvar featuresCollection = (function() {\n\n  var collectionHolder = $('.feature-collection');\n  var maxCollectionChildren = collectionHolder.children('.row').length;\n\n  /** Add a feature */\n  function add() {\n    var newForm = collectionHolder.attr('data-prototype').replace(/__name__/g, maxCollectionChildren);\n    collectionHolder.append(newForm);\n    maxCollectionChildren += 1;\n    prestaShopUiKit.initSelects();\n  }\n\n  return {\n    'init': function() {\n      /** Click event on the add button */\n      $('#features .add').on('click', function(e) {\n        e.preventDefault();\n        add();\n        $('#features-content').removeClass('hide');\n      });\n\n      /** Click event on the remove button */\n      $(document).on('click', '.feature-collection .delete', function(e) {\n        e.preventDefault();\n        var _this = $(this);\n\n        modalConfirmation.create(translate_javascripts['Are you sure to delete this?'], null, {\n          onContinue: function() {\n            _this.closest('.product-feature').remove();\n          }\n        }).show();\n      });\n\n      function replaceEndingIdFromUrl(url, newId)\n      {\n        return url.replace(/\\/\\d+(?!.*\\/\\d+)((?=\\?.*))?/, '/' + newId);\n      }\n\n      /** On feature selector event change, refresh possible values list */\n      $(document).on('change', '.feature-collection select.feature-selector', function(event) {\n        var that = event.currentTarget;\n        var $row = $($(that).parents('.row')[0]);\n        var $selector = $row.find('.feature-value-selector');\n\n        if('' !== $(this).val()) {\n          $.ajax({\n            url: replaceEndingIdFromUrl($(this).attr('data-action'), $(this).val()),\n            success: function(response) {\n              $selector.prop('disabled', response.length === 0);\n              $selector.empty();\n              $.each(response, function(index, elt) {\n                // the placeholder shouldn't be posted.\n                if ('0' == elt.id) {\n                  elt.id = '';\n                }\n                $selector.append($('<option></option>').attr('value', elt.id).text(elt.value));\n              });\n            }\n          });\n        }\n      });\n\n      var $featuresContainer = $('#features-content');\n\n      $featuresContainer.on('change', '.row select, .row input[type=\"text\"]', function onChange(event){\n        var that = event.currentTarget;\n        var $row = $($(that).parents('.row')[0]);\n        var $definedValueSelector = $row.find('.feature-value-selector');\n        var $customValueSelector = $row.find('input[type=text]');\n\n        // if feature has changed we need to reset values\n        if ($(that).hasClass('feature-selector')) {\n          $customValueSelector.val('');\n          $definedValueSelector.val('');\n        }\n      });\n    }\n  };\n})();\n\n/**\n * Suppliers management\n */\nvar supplier = (function() {\n\n  var supplierInputManage = function(input) {\n    var supplierDefaultInput = $('#form_step6_suppliers input[name=\"form[step6][default_supplier]\"][value=' + $(input).val() +']');\n    if ($(input).is(':checked')) {\n      supplierDefaultInput.prop('disabled', false).show();\n    } else {\n      supplierDefaultInput.prop('disabled', true).hide();\n    }\n  };\n\n  return {\n    'init': function() {\n      /** On supplier select, hide or show the default supplier selector */\n      var supplierInput = $('#form_step6_suppliers input[name=\"form[step6][suppliers][]\"]');\n      supplierInput.change(function() {\n        supplierInputManage($(this));\n        supplierCombinations.refresh();\n      });\n\n      //default display\n      $('#form_step6_suppliers input[name=\"form[step6][suppliers][]\"]').map(function() {\n        supplierInputManage($(this));\n      });\n    }\n  };\n})();\n\n/**\n * Supplier combination collection management\n */\nvar supplierCombinations = (function() {\n  var id_product = $('#form_id_product').val();\n  var collectionHolder = $('#supplier_combination_collection');\n\n  return {\n    'refresh': function() {\n      var suppliers = $('#form_step6_suppliers input[name=\"form[step6][suppliers][]\"]:checked').map(function() {\n        return $(this).val();\n      }).get();\n      var url = collectionHolder.attr('data-url')\n        .replace(\n          /refresh-product-supplier-combination-form\\/\\d+\\/\\d+/,\n          'refresh-product-supplier-combination-form/' + id_product + (suppliers.length > 0 ? '/' + suppliers.join('-') : '')\n        );\n      $.ajax({\n        url: url,\n        success: function(response) {\n          collectionHolder.empty().append(response);\n        }\n      });\n    }\n  };\n})();\n\n/**\n * Quantities management\n */\nvar stock = (function() {\n  return {\n    'init': function() {\n      /** Update qty_0 and shortcut qty_0 field on change */\n      $('#form_step1_qty_0_shortcut, #form_step3_qty_0').keyup(function() {\n        if ($(this).attr('id') === 'form_step1_qty_0_shortcut') {\n          $('#form_step3_qty_0').val($(this).val());\n        } else {\n          $('#form_step1_qty_0_shortcut').val($(this).val());\n        }\n      });\n\n      /** if GSA : Show depends_on_stock choice only if advanced_stock_management checked */\n      $('#form_step3_advanced_stock_management').on('change', function(e) {\n        if (e.target.checked) {\n          $('#depends_on_stock_div').show();\n        } else {\n          $('#depends_on_stock_div').hide();\n        }\n        warehouseCombinations.refresh();\n      });\n\n      /** if GSA activation change on 'depend on stock', update quantities fields */\n      $('#form_step3_depends_on_stock_0, #form_step3_depends_on_stock_1, #form_step3_advanced_stock_management').on('change', function(e) {\n        displayFieldsManager.refresh();\n        warehouseCombinations.refresh();\n      });\n      displayFieldsManager.refresh();\n    }\n  };\n})();\n\n\n/**\n * Navigation management\n */\nvar nav = (function() {\n  return {\n    'init': function() {\n      /** Manage tabls hash routes */\n      var hash = document.location.hash;\n      var formNav = $(\"#form-nav\");\n      var prefix = 'tab-';\n      if (hash) {\n        formNav.find(\"a[href='\" + hash.replace(prefix, '') + \"']\").tab('show');\n      }\n\n      formNav.find(\"a\").on('shown.bs.tab', function(e) {\n        if (e.target.hash) {\n          window.location.hash = e.target.hash.replace('#', '#' + prefix);\n        }\n      });\n    }\n  };\n})();\n\n/**\n * Warehouse combination collection management (ASM only)\n */\nvar warehouseCombinations = (function() {\n  var id_product = $('#form_id_product').val();\n  var collectionHolder = $('#warehouse_combination_collection');\n\n  return {\n    'init': function() {\n      // toggle all button action\n      $(document).on('click', 'div[id^=\"warehouse_combination_\"] button.check_all_warehouse', function() {\n        var checkboxes = $(this).closest('div[id^=\"warehouse_combination_\"]').find('input[type=\"checkbox\"][id$=\"_activated\"]');\n        checkboxes.prop('checked', checkboxes.filter(':checked').length === 0);\n      });\n      // location disablation depending on 'stored' checkbox\n      $(document).on('change', 'div[id^=\"warehouse_combination_\"] input[id^=\"form_step4_warehouse_combination_\"][id$=\"_activated\"]', function() {\n        var checked = $(this).prop('checked');\n        var location = $(this).closest('div.form-group').find('input[id^=\"form_step4_warehouse_combination_\"][id$=\"_location\"]');\n        location.prop('disabled', !checked);\n        if (!checked) {\n          location.val('');\n        }\n      });\n      this.locationDisabler();\n    },\n    'locationDisabler': function() {\n      $('div[id^=\"warehouse_combination_\"] input[id^=\"form_step4_warehouse_combination_\"][id$=\"_activated\"]', collectionHolder).each(function() {\n        var checked = $(this).prop('checked');\n        var location = $(this).closest('div.form-group').find('input[id^=\"form_step4_warehouse_combination_\"][id$=\"_location\"]');\n        location.prop('disabled', !checked);\n      });\n    },\n    'refresh': function() {\n      var show = $('input#form_step3_advanced_stock_management:checked').length > 0;\n      if (show) {\n        var url = collectionHolder.attr('data-url').replace(/\\/\\d+(?=\\?.*)/, '/' + id_product);\n        $.ajax({\n          url: url,\n          success: function(response) {\n            collectionHolder.empty().append(response);\n            collectionHolder.show();\n            warehouseCombinations.locationDisabler();\n          }\n        });\n      } else {\n        collectionHolder.hide();\n      }\n    }\n  };\n})();\n\n/**\n * Form management\n */\nvar form = (function() {\n  var elem = $('#form');\n\n  function send(redirect, target, callBack) {\n    // target value by default\n    if (typeof(target) == 'undefined') {\n      target = false;\n    }\n    seo.onSave();\n    updateMissingTranslatedNames();\n\n    var data = $('input, textarea, select', elem).not(':input[type=button], :input[type=submit], :input[type=reset]').serialize();\n\n    if (target == '_blank' && redirect) {\n      var openBlank = window.open('about:blank', target, '');\n      openBlank.document.write(\n        '<p style=\"text-align: center;\">' +\n        '<img src=\"' + document.location.origin + baseAdminDir + '/themes/default/img/spinner.gif\">' +\n        '</p>'\n      );\n    }\n\n    $.ajax({\n      type: 'POST',\n      data: data,\n      beforeSend: function() {\n        $('#submit', elem).attr('disabled', 'disabled');\n        $('.btn-submit', elem).attr('disabled', 'disabled');\n        $('ul.text-danger').remove();\n        $('*.has-danger').removeClass('has-danger');\n        $('#form-nav li.has-error').removeClass('has-error');\n        updateDisplayGlobalErrors(null);\n      },\n      success: function(response) {\n        if (callBack) {\n          callBack();\n        }\n        showSuccessMessage(translate_javascripts['Form update success']);\n        //update the customization ids\n        if (typeof response.customization_fields_ids != \"undefined\") {\n          $.each(response.customization_fields_ids, function (k, v) {\n            $(\"#form_step6_custom_fields_\" + k + \"_id_customization_field\").val(v);\n          });\n        }\n\n        $('.js-spinner').hide();\n\n        if (!redirect) {\n          return;\n        }\n\n        if (false === target) {\n          window.location = redirect;\n\n          return;\n        }\n\n        if ('_blank' !== target) {\n          window.open(redirect, target);\n\n          return;\n        }\n\n        openBlank.location = redirect;\n      },\n      error: function(response) {\n        showErrorMessage(translate_javascripts['Form update errors']);\n\n        if (target == '_blank' && redirect) {\n          openBlank.close();\n        }\n\n        var tabsWithErrors = [];\n\n        $.each(jQuery.parseJSON(response.responseText), function(key, errors) {\n          tabsWithErrors.push(key);\n\n          var html = '<ul class=\"list-unstyled text-danger\">';\n          $.each(errors, function(unusedKey, error) {\n            html += '<li>' + error + '</li>';\n          });\n          html += '</ul>';\n\n          if (0 === key.localeCompare('error')) {\n            updateDisplayGlobalErrors(html);\n          } else if (key.match(/^combination_.*/)) {\n            $('#' + key).parent().addClass('has-danger').append(html);\n          } else {\n            $('#form_' + key).parent().addClass('has-danger').append(html);\n          }\n\n        });\n\n        /** find first tab with error, then switch to it */\n        tabsWithErrors.sort();\n        $.each(tabsWithErrors, function(key, tabIndex) {\n          if (0 === key) {\n            $('#form-nav li a[href=\"#' + tabIndex.split('_')[0] + '\"]').tab('show');\n          }\n\n          $('#form-nav li a[href=\"#' + tabIndex.split('_')[0] + '\"]').parent().addClass('has-error');\n        });\n\n        if ($('div[class*=\"translation-label-\"].has-danger').length > 0) {\n          var regexLabel = 'translation-label-';\n\n          var translationLabelClass = $.grep($('div[class*=\"translation-label-\"].has-danger').first().attr('class').split(\" \"), function(v, i){\n            return v.indexOf(regexLabel) === 0;\n          }).join();\n\n          if (translationLabelClass) {\n            var selectValue = translationLabelClass.replace(regexLabel, '');\n\n            if ($('#form_switch_language option[value=\"' + selectValue + '\"]').length > 0) {\n              $('#form_switch_language').val(selectValue).change();\n            }\n          }\n        }\n\n        /** scroll to 1st error */\n        if ($('.has-danger').first().offset()) {\n          $('html, body').animate({\n            scrollTop: $('.has-danger').first().offset().top - $('nav.main-header').height()\n          }, 500);\n        }\n      },\n      complete: function() {\n        $('#submit', elem).removeAttr('disabled');\n        $('.btn-submit', elem).removeAttr('disabled');\n      }\n    });\n  }\n\n  function switchLanguage(iso_code) {\n    $('div.translations.tabbable > div > div.translation-field:not(.translation-label-' + iso_code + ')').removeClass('show active');\n\n    const langueTabSelector = 'div.translations.tabbable > div > div.translation-field.translation-label-' + iso_code;\n    $(langueTabSelector).addClass('show active');\n    resetEditor();\n  }\n\n  function updateMissingTranslatedNames() {\n    var namesDiv = $('#form_step1_names');\n    var defaultLanguageValue = null;\n    $(\"input[id^='form_step1_name_']\", namesDiv).each(function(index) {\n      var value = $(this).val();\n      // The first language is ALWAYS the employee language\n      if (0 === index) {\n        defaultLanguageValue = value;\n      } else if (0 === value.length) {\n        $(this).val(defaultLanguageValue);\n      }\n    });\n  }\n\n  /**\n   * Depending on the provided params, this method displays or hides\n   * an error panel with the form errors not linked to a specific field.\n   *\n   * @param {string} content The HTML content to display\n   */\n  function updateDisplayGlobalErrors(content) {\n    const target = $(\"#form_bubbling_errors\");\n    target.html('');\n    if (content) {\n      target.html(`<div class=\"alert alert-danger\">${content}</div>`);\n    }\n  }\n\n  return {\n    'init': function() {\n      /** prevent form submit on ENTER keypress */\n      jwerty.key('enter', function(e) {\n        e.preventDefault();\n      });\n\n      /** create keyboard event for save */\n      jwerty.key('alt+shift+S', function(e) {\n        e.preventDefault();\n        send();\n      });\n\n      /** create keyboard event for save & duplicate */\n      jwerty.key('alt+shift+D', function(e) {\n        e.preventDefault();\n        send($('.product-footer .duplicate').attr('data-redirect'));\n      });\n\n      /** create keyboard event for save & new */\n      jwerty.key('alt+shift+P', function(e) {\n        e.preventDefault();\n        send($('.product-footer .new-product').attr('data-redirect'));\n      });\n\n      /** create keyboard event for save & go catalog */\n      jwerty.key('alt+shift+Q', function(e) {\n        e.preventDefault();\n        send($('.product-footer .go-catalog').attr('data-redirect'));\n      });\n\n      /** create keyboard event for save & go preview */\n      jwerty.key('alt+shift+V', function(e) {\n          e.preventDefault();\n          var productFooter = $('.product-footer .preview');\n          send(productFooter.attr('data-redirect'), productFooter.attr('target'));\n      });\n\n      /** create keyboard event for save & active or desactive product*/\n      jwerty.key('alt+shift+O', function(e) {\n        e.preventDefault();\n        var step1CheckBox = $('#form_step1_active');\n        step1CheckBox.prop('checked', !step1CheckBox.is(':checked'));\n      });\n\n      elem.submit(function(event) {\n        event.preventDefault();\n        send();\n      });\n\n      elem.find('#form_switch_language').change(function(event) {\n        event.preventDefault();\n        switchLanguage(event.target.value);\n      });\n\n      /** on save with duplicate|new|preview */\n      $('.btn-submit, .preview', elem).click(function(event) {\n        event.preventDefault();\n        send($(this).attr('data-redirect'), $(this).attr('target'));\n      });\n\n      $('.js-btn-save').on('click', function (event) {\n        event.preventDefault();\n        $('.js-spinner').css('display', 'inline-block');\n        send($(this).attr('href'));\n      });\n\n      /** on active field change, send form */\n      $('#form_step1_active', elem).on('change', function() {\n        var active = $(this).prop('checked');\n        $('.for-switch.online-title').toggle(active);\n        $('.for-switch.offline-title').toggle(!active);\n        // update link preview\n        var previewButton = $('#product_form_preview_btn');\n        var urlActive = previewButton.attr('data-redirect');\n        var urlDeactive = previewButton.attr('data-url-deactive');\n        previewButton.attr('data-redirect', urlDeactive);\n        previewButton.attr('data-url-deactive', urlActive);\n        // update product\n        send();\n      });\n\n      /** on delete product */\n      $('.product-footer .delete', elem).click(function(e) {\n        e.preventDefault();\n        var _this = $(this);\n        modalConfirmation.create(translate_javascripts['Are you sure to delete this?'], null, {\n          onContinue: function() {\n            window.location = _this.attr('href');\n          }\n        }).show();\n      });\n\n      $('#form-loading').fadeIn(function() {\n      /** Create Bloodhound engine */\n      var engine = new Bloodhound({\n        datumTokenizer: function(d) {\n          return Bloodhound.tokenizers.whitespace(d.label);\n        },\n        queryTokenizer: Bloodhound.tokenizers.whitespace,\n        prefetch: {\n          url: $('#form_step3_attributes').attr('data-prefetch'),\n          cache: false\n        }\n      });\n\n      /** init input typeahead */\n      $('#form_step3_attributes').tokenfield({\n        typeahead: [{\n          hint: false,\n          cache: false\n        }, {\n          source: function(query, syncResults) {\n            engine.search(query, function(suggestions) {\n              syncResults(filter(suggestions));\n            });\n          },\n          display: 'label'\n        }],\n        minWidth: '768px'\n      });\n\n      /** Filter suggestion with selected tokens */\n      var filter = function(suggestions) {\n        var selected = [];\n        $('#attributes-generator input.attribute-generator').each(function() {\n          selected.push($(this).val());\n        });\n\n        return $.grep(suggestions, function(suggestion) {\n          return $.inArray(suggestion.value, selected) === -1 && $.inArray('group-' + suggestion.data.id_group, selected) === -1;\n        });\n      };\n\n      /** On event \"tokenfield:createtoken\" : stop event if its not a typehead result */\n      $('#form_step3_attributes').on('tokenfield:createtoken', function(e) {\n        if (!e.attrs.data && e.handleObj.origType !== 'tokenfield:createtoken') {\n          return false;\n        }\n      });\n\n      /** On event \"tokenfield:createdtoken\" : store attributes in input when add a token */\n      $('#form_step3_attributes').on('tokenfield:createdtoken', function(e) {\n        if (e.attrs.data) {\n          $('#attributes-generator').append('<input type=\"hidden\" id=\"attribute-generator-' + e.attrs.value + '\" class=\"attribute-generator\" value=\"' + e.attrs.value + '\" name=\"options[' + e.attrs.data.id_group + '][' + e.attrs.value + ']\" />');\n        } else if (e.handleObj.origType == 'tokenfield:createdtoken') {\n          $('#attributes-generator').append('<input type=\"hidden\" id=\"attribute-generator-' + $('.js-attribute-checkbox[data-value=\"'+e.attrs.value+'\"]').data('value') + '\" class=\"attribute-generator\" value=\"' + $('.js-attribute-checkbox[data-value=\"'+e.attrs.value+'\"]').data('value') + '\" name=\"options[' + $('.js-attribute-checkbox[data-value=\"'+e.attrs.value+'\"]').data('group-id') + '][' + $('.js-attribute-checkbox[data-value=\"'+e.attrs.value+'\"]').data('value') + ']\" />');\n        }\n      });\n\n      /** On event \"tokenfield:removedtoken\" : remove stored attributes input when remove token */\n      $('#form_step3_attributes').on('tokenfield:removedtoken', function(e) {\n        $('#attribute-generator-' + e.attrs.value).remove();\n      });\n    });\n    },\n      'send': function(redirect, target, callBack) {\n      send(redirect, target, callBack);\n    },\n      'switchLanguage': function(iso_code) {\n      switchLanguage(iso_code);\n    }\n  };\n})();\n\n\n/**\n * Custom field collection management\n */\nvar customFieldCollection = (function() {\n\n  var collectionHolder = $('ul.customFieldCollection');\n  var maxCollectionChildren = collectionHolder.children().length;\n\n  /** Add a custom field */\n  function add() {\n    var newForm = collectionHolder.attr('data-prototype').replace(/__name__/g, maxCollectionChildren);\n    maxCollectionChildren += 1;\n    collectionHolder.append('<li>' + newForm + '</li>');\n  }\n\n  return {\n    'init': function() {\n      /** Click event on the add button */\n      $('#custom_fields a.add').on('click', function(e) {\n        e.preventDefault();\n        add();\n      });\n\n      /** Click event on the remove button */\n      $(document).on('click', 'ul.customFieldCollection .delete', function(e) {\n        e.preventDefault();\n        var _this = $(this);\n\n        modalConfirmation.create(translate_javascripts['Are you sure to delete this?'], null, {\n          onContinue: function() {\n            _this.parent().parent().parent().remove();\n          }\n        }).show();\n      });\n    }\n  };\n})();\n\n/**\n * virtual product management\n */\nvar virtualProduct = (function() {\n  var id_product = $('#form_id_product').val();\n\n  var getOnDeleteVirtualProductFileHandler = function ($deleteButton) {\n    return $.ajax({\n      type: 'GET',\n      url: $deleteButton.attr('href').replace(/\\/\\d+(?=\\?.*)/, '/' + id_product),\n      success: function () {\n        $('#form_step3_virtual_product_file_input').removeClass('hide').addClass('show');\n        $('#form_step3_virtual_product_file_details').removeClass('show').addClass('hide');\n      }\n    })\n  };\n\n  return {\n    'init': function() {\n      $(document).on('change', 'input[name=\"form[step3][virtual_product][is_virtual_file]\"]', function() {\n        if ($(this).val() === '1') {\n          $('#virtual_product_content').show();\n        } else {\n          $('#virtual_product_content').hide();\n\n          var url = $('#virtual_product').attr('data-action-remove').replace(/remove\\/\\d+/, 'remove/' + id_product);\n          //delete virtual product\n          $.ajax({\n            type: 'GET',\n            url: url,\n            success: function() {\n              //empty form\n              $('#form_step3_virtual_product_file_input').removeClass('hide').addClass('show');\n              $('#form_step3_virtual_product_file_details').removeClass('show').addClass('hide');\n              $('#form_step3_virtual_product_name').val('');\n              $('#form_step3_virtual_product_nb_downloadable').val(0);\n              $('#form_step3_virtual_product_expiration_date').val('');\n              $('#form_step3_virtual_product_nb_days').val(0);\n            }\n          });\n        }\n      });\n\n      $('#form_step3_virtual_product_file').change(function(e) {\n        if ($(this)[0].files !== undefined) {\n          var files = $(this)[0].files;\n          var name  = '';\n\n          $.each(files, function(index, value) {\n            name += value.name + ', ';\n          });\n          $('#form_step3_virtual_product_name').val(name.slice(0, -2));\n        } else {\n          // Internet Explorer 9 Compatibility\n          var name = $(this).val().split(/[\\\\/]/);\n          $('#form_step3_virtual_product_name').val(name[name.length - 1]);\n        }\n      });\n\n      if ($('input[name=\"form[step3][virtual_product][is_virtual_file]\"]:checked').val() === '1') {\n        $('#virtual_product_content').show();\n      } else {\n        $('#virtual_product_content').hide();\n      }\n\n      /** delete attached file */\n      $('#form_step3_virtual_product_file_details .delete').click(function(e) {\n        e.preventDefault();\n        var $deleteButton = $(this);\n\n        modalConfirmation.create(translate_javascripts['Are you sure to delete this?'], null, {\n          onContinue: function() {\n            getOnDeleteVirtualProductFileHandler($deleteButton);\n          }\n        }).show();\n      });\n\n      /** save virtual product */\n      $('#form_step3_virtual_product_save').click(function() {\n        var _this = $(this);\n        var data = new FormData();\n\n        if ($('#form_step3_virtual_product_file')[0].files[0]) {\n          data.append('product_virtual[file]', $('#form_step3_virtual_product_file')[0].files[0]);\n        }\n        data.append('product_virtual[is_virtual_file]', $('input[name=\"form[step3][virtual_product][is_virtual_file]\"]:checked').val());\n        data.append('product_virtual[name]', $('#form_step3_virtual_product_name').val());\n        data.append('product_virtual[nb_downloadable]', $('#form_step3_virtual_product_nb_downloadable').val());\n        data.append('product_virtual[expiration_date]', $('#form_step3_virtual_product_expiration_date').val());\n        data.append('product_virtual[nb_days]', $('#form_step3_virtual_product_nb_days').val());\n\n        $.ajax({\n          type: 'POST',\n          url: $('#virtual_product').attr('data-action').replace(/save\\/\\d+/, 'save/' + id_product),\n          data: data,\n          contentType: false,\n          processData: false,\n          beforeSend: function() {\n            _this.prop('disabled', 'disabled');\n            $('ul.text-danger').remove();\n            $('*.has-danger').removeClass('has-danger');\n          },\n          success: function(response) {\n            showSuccessMessage(translate_javascripts['Form update success']);\n            if (response.file_download_link) {\n              $('#form_step3_virtual_product_file_details a.download').attr('href', response.file_download_link);\n              $('#form_step3_virtual_product_file_input').removeClass('show').addClass('hide');\n              $('#form_step3_virtual_product_file_details').removeClass('hide').addClass('show');\n            }\n          },\n          error: function(response) {\n            $.each(jQuery.parseJSON(response.responseText), function(key, errors) {\n              var html = '<ul class=\"list-unstyled text-danger\">';\n              $.each(errors, function(key, error) {\n                html += '<li>' + error + '</li>';\n              });\n              html += '</ul>';\n\n              $('#form_step3_virtual_product_' + key).parent().append(html);\n              $('#form_step3_virtual_product_' + key).parent().addClass('has-danger');\n            });\n          },\n          complete: function() {\n            _this.removeAttr('disabled');\n          }\n        });\n      });\n    },\n    'destroy': function () {\n      var fileDetailsSelector = '#form_step3_virtual_product_file_details';\n      var fileAssociationExists = !$(fileDetailsSelector).hasClass('hide');\n\n      if (fileAssociationExists) {\n        var $deleteButton = $(fileDetailsSelector + ' .delete');\n        getOnDeleteVirtualProductFileHandler($deleteButton);\n      }\n\n      var associatedFileCheckboxSelectorPrefix = '#form_step3_virtual_product_is_virtual_file_';\n      $(associatedFileCheckboxSelectorPrefix + '0').prop('checked', false);\n      $(associatedFileCheckboxSelectorPrefix + '1').prop('checked', true);\n\n      $('#virtual_product_content input').val('');\n    }\n  }\n})();\n\n/**\n * attachment product management\n */\nvar attachmentProduct = (function() {\n  var id_product = $('#form_id_product').val();\n\n  return {\n    'init': function() {\n      var buttonSave = $('#form_step6_attachment_product_add');\n      var buttonCancel = $('#form_step6_attachment_product_cancel');\n\n      /** check all attachments files */\n      $('#product-attachment-files-check').change(function() {\n        if ($(this).is(\":checked\")) {\n          $('#product-attachment-file input[type=\"checkbox\"]').prop('checked', true);\n        } else {\n          $('#product-attachment-file input[type=\"checkbox\"]').prop('checked', false);\n        }\n      });\n\n      buttonCancel.click(function (){\n        resetAttachmentForm();\n      });\n\n      function resetAttachmentForm() {\n        $('#form_step6_attachment_product_file').val('');\n        $('#form_step6_attachment_product_name').val('');\n        $('#form_step6_attachment_product_description').val('');\n      }\n\n      function replaceEndingIdFromUrl(url, newId)\n      {\n        return url.replace(/\\/\\d+(?!.*\\/\\d+)((?=\\?.*))?/, '/' + newId);\n      }\n\n      /** add attachment */\n      $('#form_step6_attachment_product_add').click(function() {\n        var _this = $(this);\n        var data = new FormData();\n\n        if ($('#form_step6_attachment_product_file')[0].files[0]) {\n          data.append('product_attachment[file]', $('#form_step6_attachment_product_file')[0].files[0]);\n        }\n        data.append('product_attachment[name]', $('#form_step6_attachment_product_name').val());\n        data.append('product_attachment[description]', $('#form_step6_attachment_product_description').val());\n\n        $.ajax({\n          type: 'POST',\n          url: replaceEndingIdFromUrl($('#form_step6_attachment_product').attr('data-action'), id_product),\n          data: data,\n          contentType: false,\n          processData: false,\n          beforeSend: function() {\n            buttonSave.prop('disabled', 'disabled');\n            $('ul.text-danger').remove();\n            $('*.has-danger').removeClass('has-danger');\n          },\n          success: function(response) {\n            resetAttachmentForm();\n\n            //inject new attachment in attachment list\n            if (response.id) {\n              var row = '<tr>\\\n                <td class=\"col-md-3\"><input type=\"checkbox\" name=\"form[step6][attachments][]\" value=\"' + response.id + '\" checked=\"checked\"> ' + response.real_name + '</td>\\\n                <td class=\"col-md-6\">' + response.file_name + '</td>\\\n                <td class=\"col-md-2\">' + response.mime + '</td>\\\n              </tr>';\n\n              $('#product-attachment-file tbody').append(row);\n              $('.js-options-no-attachments').addClass('hide');\n              $('.js-options-with-attachments').removeClass('hide');\n            }\n          },\n          error: function(response) {\n            $.each(jQuery.parseJSON(response.responseText), function(key, errors) {\n              var html = '<ul class=\"list-unstyled text-danger\">';\n              $.each(errors, function(key, error) {\n                html += '<li>' + error + '</li>';\n              });\n              html += '</ul>';\n\n              $('#form_step6_attachment_product_' + key).parent().append(html);\n              $('#form_step6_attachment_product_' + key).parent().addClass('has-danger');\n            });\n          },\n          complete: function() {\n            buttonSave.removeAttr('disabled');\n          }\n        });\n      });\n    }\n  };\n})();\n\n/**\n * images product management\n */\nvar imagesProduct = (function() {\n  var dropZoneElem = $('#product-images-dropzone');\n  var expanderElem = $('#product-images-container .dropzone-expander');\n\n  function checkDropzoneMode() {\n      if (!dropZoneElem.find('.dz-preview:not(.openfilemanager)').length) {\n        dropZoneElem.removeClass('dz-started');\n        dropZoneElem.find('.dz-preview.openfilemanager').hide();\n      }\n      else {\n          dropZoneElem.find('.dz-preview.openfilemanager').show();\n      }\n  };\n\n  return {\n    'toggleExpand': function() {\n        if (expanderElem.hasClass('expand')) {\n          dropZoneElem.css('height', 'auto');\n          expanderElem.removeClass('expand').addClass('compress');\n        } else {\n          dropZoneElem.css('height', '');\n          expanderElem.removeClass('compress').addClass('expand');\n        }\n    },\n    'displayExpander': function() {\n      expanderElem.show();\n    },\n    'hideExpander': function() {\n      expanderElem.hide();\n    },\n    'shouldDisplayExpander': function () {\n      var oldHeight = dropZoneElem.css('height');\n\n      dropZoneElem.css('height', '');\n      var closedHeight = dropZoneElem.outerHeight();\n      var realHeight = dropZoneElem[0].scrollHeight;\n      dropZoneElem.css('height', oldHeight);\n\n      return (realHeight > closedHeight);\n    },\n    'updateExpander': function() {\n      if (this.shouldDisplayExpander()) {\n        this.displayExpander();\n      }\n    },\n    'initExpander': function() {\n      if (this.shouldDisplayExpander()) {\n        this.displayExpander();\n        expanderElem.addClass('expand');\n      }\n\n      var self = this;\n      $(document).on('click', '#product-images-container .dropzone-expander', function() {\n        self.toggleExpand();\n      });\n    },\n    'init': function() {\n      Dropzone.autoDiscover = false;\n      var errorElem = $('#product-images-dropzone-error');\n\n      //on click image, display custom form\n      $(document).on('click', '#product-images-dropzone .dz-preview', function() {\n        if (!$(this).attr('data-id')) {\n          return;\n        }\n        formImagesProduct.form($(this).attr('data-id'));\n      });\n\n      var dropzoneOptions = {\n        url: dropZoneElem.attr('url-upload'),\n        paramName: 'form[file]',\n        maxFilesize: dropZoneElem.attr('data-max-size'),\n        addRemoveLinks: true,\n        clickable: '.openfilemanager',\n        thumbnailWidth: 250,\n        thumbnailHeight: null,\n        acceptedFiles: 'image/*',\n        timeout: 0,\n        dictRemoveFile: translate_javascripts['Delete'],\n        dictFileTooBig: translate_javascripts['ToLargeFile'],\n        dictCancelUpload: translate_javascripts['Delete'],\n        sending: function(file, response) {\n          checkDropzoneMode();\n          expanderElem.addClass('expand').click();\n          errorElem.html('');\n        },\n        queuecomplete: function() {\n          checkDropzoneMode();\n          dropZoneElem.sortable('enable');\n          imagesProduct.updateExpander();\n        },\n        processing: function() {\n          dropZoneElem.sortable('disable');\n        },\n        success: function(file, response) {\n          //manage error on uploaded file\n          if (response.error !== 0) {\n            errorElem.append('<p>' + file.name + ': ' + response.error + '</p>');\n            this.removeFile(file);\n            return;\n          }\n\n          //define id image to file preview\n          $(file.previewElement).attr('data-id', response.id);\n          $(file.previewElement).attr('url-update', response.url_update);\n          $(file.previewElement).attr('url-delete', response.url_delete);\n          $(file.previewElement).addClass('ui-sortable-handle');\n          if (response.cover === 1) {\n            imagesProduct.updateDisplayCover(response.id);\n          }\n        },\n        error: function(file, response) {\n          var message = '';\n          if ($.type(response) === 'undefined') {\n            return;\n          } else if ($.type(response) === 'string') {\n            message = response;\n          } else if (response.message) {\n            message = response.message;\n          }\n\n          if (message === '') {\n            return;\n          }\n\n          //append new error\n          errorElem.append('<p>' + file.name + ': ' + message + '</p>');\n\n          //remove uploaded item\n          this.removeFile(file);\n        },\n        init: function() {\n          //if already images uploaded, mask drop file message\n          if (dropZoneElem.find('.dz-preview:not(.openfilemanager)').length) {\n            dropZoneElem.addClass('dz-started');\n          } else {\n            dropZoneElem.find('.dz-preview.openfilemanager').hide();\n          }\n\n          //init sortable\n          dropZoneElem.sortable({\n            items: \"div.dz-preview:not(.disabled)\",\n            opacity: 0.9,\n            containment: 'parent',\n            distance: 32,\n            tolerance: 'pointer',\n            cursorAt: {\n              left: 64,\n              top: 64\n            },\n            cancel: '.disabled',\n            stop: function(event, ui) {\n              var sort = {};\n              $.each(dropZoneElem.find('.dz-preview:not(.disabled)'), function(index, value) {\n                if (!$(value).attr('data-id')) {\n                  sort = false;\n                  return;\n                }\n                sort[$(value).attr('data-id')] = index + 1;\n              });\n\n              //if sortable ok, update it\n              if (sort) {\n                $.ajax({\n                  type: 'POST',\n                  url: dropZoneElem.attr('url-position'),\n                  data: {\n                    json: JSON.stringify(sort)\n                  }\n                });\n              }\n            },\n            start: function(event, ui) {\n              //init zindex\n              dropZoneElem.find('.dz-preview').css('zIndex', 1);\n              ui.item.css('zIndex', 10);\n            }\n          });\n\n          dropZoneElem.disableSelection();\n          imagesProduct.initExpander();\n        }\n      };\n\n      dropZoneElem.dropzone(jQuery.extend(dropzoneOptions));\n    },\n    'updateDisplayCover': function(id_image) {\n      $('#product-images-dropzone .dz-preview .iscover').remove();\n      $('#product-images-dropzone .dz-preview[data-id=\"' + id_image + '\"]')\n        .append('<div class=\"iscover\">' + translate_javascripts['Cover'] + '</div>');\n    },\n    'checkDropzoneMode': function() {\n      checkDropzoneMode();\n    },\n    'getOlderImageId': function() {\n      return Math.min.apply(Math,$('.dz-preview').map(function(){\n        return $(this).data('id');\n      }));\n    }\n  };\n})();\n\n\nvar formImagesProduct = (function() {\n  var dropZoneElem = $('#product-images-dropzone');\n  var formZoneElem = $('#product-images-form-container');\n\n  formZoneElem.magnificPopup({\n    delegate: 'a.open-image',\n    type: 'image'\n  });\n\n  function toggleColDropzone(enlarge) {\n      var smallCol = \"col-md-8\";\n      var largeCol = \"col-md-12\";\n      if (true === enlarge) {\n          dropZoneElem.removeClass(smallCol).addClass(largeCol);\n      } else {\n          dropZoneElem.removeClass(largeCol).addClass(smallCol);\n      }\n  }\n\n  return {\n    'form': function(id) {\n      dropZoneElem.find(\".dz-preview.active\").removeClass(\"active\");\n      dropZoneElem.find(\".dz-preview[data-id='\"+id+\"']\").addClass(\"active\");\n      if(imagesProduct.shouldDisplayExpander() == false){\n        dropZoneElem.css('height','auto');\n      }\n      $.ajax({\n        url: dropZoneElem.find(\".dz-preview[data-id='\"+id+\"']\").attr('url-update'),\n        success: function(response) {\n          formZoneElem.find('#product-images-form').html(response);\n          form.switchLanguage($('#form_switch_language').val());\n        },\n        complete: function() {\n          toggleColDropzone(false);\n          formZoneElem.show();\n        }\n      });\n    },\n    'send': function(id) {\n      $.ajax({\n        type: 'POST',\n        url: dropZoneElem.find(\".dz-preview[data-id='\"+id+\"']\").attr('url-update'),\n        data: formZoneElem.find('textarea, input').serialize(),\n        beforeSend: function() {\n          formZoneElem.find('.actions button').prop('disabled', 'disabled');\n          formZoneElem.find('ul.text-danger').remove();\n          formZoneElem.find('*.has-danger').removeClass('has-danger');\n        },\n        success: function() {\n          if (formZoneElem.find('#form_image_cover:checked').length) {\n            imagesProduct.updateDisplayCover(id);\n          }\n        },\n        error: function(response) {\n          if (response && response.responseText) {\n            $.each(jQuery.parseJSON(response.responseText), function(key, errors) {\n              var html = '<ul class=\"list-unstyled text-danger\">';\n              $.each(errors, function(key, error) {\n                html += '<li>' + error + '</li>';\n              });\n              html += '</ul>';\n\n              $('#form_image_' + key).parent().append(html);\n              $('#form_image_' + key).parent().addClass('has-danger');\n            });\n          }\n        },\n        complete: function() {\n          formZoneElem.find('.actions button').removeAttr('disabled');\n        }\n      });\n    },\n    'delete': function(id) {\n      modalConfirmation.create(translate_javascripts['Are you sure to delete this?'], null, {\n        onContinue: function() {\n          $.ajax({\n            url: dropZoneElem.find('.dz-preview[data-id=\"' + id + '\"]').attr('url-delete'),\n            complete: function() {\n              formZoneElem.find('.close').click();\n              var wasCover = !!dropZoneElem.find('.dz-preview[data-id=\"' + id + '\"] .iscover').length;\n              dropZoneElem.find('.dz-preview[data-id=\"' + id + '\"]').remove();\n              $('.images .product-combination-image [value=' + id + ']').parent().remove();\n              imagesProduct.checkDropzoneMode();\n              if (true === wasCover) {\n                // The controller will choose the oldest image as the new cover.\n                imagesProduct.updateDisplayCover(imagesProduct.getOlderImageId());\n              }\n            }\n          });\n        }\n      }).show();\n    },\n    'close': function() {\n      toggleColDropzone(true);\n      dropZoneElem.css('height','');\n      formZoneElem.find('#product-images-form').html('');\n      formZoneElem.hide();\n      dropZoneElem.find(\".dz-preview.active\").removeClass(\"active\");\n    }\n  };\n})();\n\n/**\n * Price calculation\n */\nvar priceCalculation = (function() {\n  var priceHTElem = $('#form_step2_price');\n  var priceHTShortcutElem = $('#form_step1_price_shortcut');\n  var priceTTCElem = $('#form_step2_price_ttc');\n  var priceTTCShorcutElem = $('#form_step1_price_ttc_shortcut');\n  var ecoTaxElem = $('#form_step2_ecotax');\n  var taxElem = $('#form_step2_id_tax_rules_group');\n  var reTaxElem = $('#step2_id_tax_rules_group_rendered');\n  var displayPricePrecision = priceHTElem.attr('data-display-price-precision');\n  var ecoTaxRate = ecoTaxElem.attr('data-eco-tax-rate');\n\n  /**\n   * Add taxes to a price\n   * @param {Number} price - Price without tax\n   * @param {Number[]} rates - Rates to apply\n   * @param {Number} computationMethod The computation calculate method\n   */\n  function addTaxes(price, rates, computationMethod) {\n    var price_with_taxes = price;\n\n    var i = 0;\n    if (computationMethod === '0') {\n      for (i in rates) {\n        price_with_taxes *= (1.00 + parseFloat(rates[i]) / 100.00);\n        break;\n      }\n    } else if (computationMethod === '1') {\n      var rate = 0;\n      for (i in rates) {\n        rate += rates[i];\n      }\n      price_with_taxes *= (1.00 + parseFloat(rate) / 100.00);\n    } else if (computationMethod === '2') {\n      for (i in rates) {\n        price_with_taxes *= (1.00 + parseFloat(rates[i]) / 100.00);\n      }\n    }\n\n    return price_with_taxes;\n  }\n\n  /**\n   * Remove taxes from a price\n   * @param {Number} price - Price with tax\n   * @param {Number[]} rates - Rates to apply\n   * @param {Number} computationMethod - The computation method\n   */\n  function removeTaxes(price, rates, computationMethod) {\n    var i = 0;\n    if (computationMethod === '0') {\n      for (i in rates) {\n        price /= (1 + rates[i] / 100);\n        break;\n      }\n    } else if (computationMethod === '1') {\n      var rate = 0;\n      for (i in rates) {\n        rate += rates[i];\n      }\n      price /= (1 + rate / 100);\n    } else if (computationMethod === '2') {\n      for (i in rates) {\n        price /= (1 + rates[i] / 100);\n      }\n    }\n\n    return price;\n  }\n\n  /**\n   *\n   * @return {Number}\n   */\n  function getEcotaxTaxIncluded() {\n    var displayPrecision = 6;\n    var ecoTax = Tools.parseFloatFromString(ecoTaxElem.val());\n\n    if (isNaN(ecoTax)) {\n      ecoTax = 0;\n    }\n\n    if (ecoTax === 0) {\n      return ecoTax;\n    }\n    var ecotaxTaxExcl = ecoTax / (1 + ecoTaxRate);\n\n    return ps_round(ecotaxTaxExcl * (1 + ecoTaxRate), displayPrecision);\n  }\n\n  function getEcotaxTaxExcluded() {\n    return Tools.parseFloatFromString(ecoTaxElem.val()) / (1 + ecoTaxRate);\n  }\n\n  return {\n\n    init: function () {\n      /** on update tax recalculate tax include price */\n      taxElem.change(function() {\n        if (reTaxElem.val() !== taxElem.val()) {\n          reTaxElem.val(taxElem.val()).trigger('change');\n        }\n\n        priceCalculation.taxInclude();\n        priceTTCElem.change();\n      });\n\n      reTaxElem.change(function() {\n        taxElem.val(reTaxElem.val()).trigger('change');\n      });\n\n      /** update without tax price and shortcut price field on change */\n      $('#form_step1_price_shortcut, #form_step2_price').keyup(function() {\n        var price = priceCalculation.normalizePrice($(this).val());\n\n        if ($(this).attr('id') === 'form_step1_price_shortcut') {\n          $('#form_step2_price').val(price).change();\n        } else {\n          $('#form_step1_price_shortcut').val(price).change();\n        }\n\n        priceCalculation.taxInclude();\n      });\n\n      /** update HT price and shortcut price field on change */\n      $('#form_step1_price_ttc_shortcut, #form_step2_price_ttc').keyup(function() {\n        var price = priceCalculation.normalizePrice($(this).val());\n\n        if ($(this).attr('id') === 'form_step1_price_ttc_shortcut') {\n          $('#form_step2_price_ttc').val(price).change();\n        } else {\n          $('#form_step1_price_ttc_shortcut').val(price).change();\n        }\n\n        priceCalculation.taxExclude();\n      });\n\n      /** on price change, update final retails prices */\n      $('#form_step2_price, #form_step2_price_ttc').change(function() {\n        var taxExcludedPrice = priceCalculation.normalizePrice($('#form_step2_price').val());\n        var taxIncludedPrice = priceCalculation.normalizePrice($('#form_step2_price_ttc').val());\n\n        formatCurrencyCldr(taxExcludedPrice, function(result) {\n          $('#final_retail_price_te').text(result);\n        });\n        formatCurrencyCldr(taxIncludedPrice, function(result) {\n          $('#final_retail_price_ti').text(result);\n        });\n      });\n\n      /** update HT price and shortcut price field on change */\n      $('#form_step2_ecotax').keyup(function() {\n        priceCalculation.taxExclude();\n      });\n\n      /** combinations : update TTC price field on change */\n      $(document).on('keyup', '.combination-form .attribute_priceTE', function() {\n        priceCalculation.impactTaxInclude($(this));\n        priceCalculation.impactFinalPrice($(this));\n      });\n      /** combinations : update HT price field on change */\n      $(document).on('keyup', '.combination-form .attribute_priceTI', function() {\n        priceCalculation.impactTaxExclude($(this));\n      });\n      /** combinations : update wholesale price, unity and price TE field on blur */\n      $(document).on('blur','.combination-form .attribute_wholesale_price,.combination-form .attribute_unity,.combination-form .attribute_priceTE', function(){\n        $(this).val(priceCalculation.normalizePrice($(this).val()));\n      });\n\n      priceCalculation.taxInclude();\n\n      $('#form_step2_price, #form_step2_price_ttc').change();\n    },\n\n    /**\n     * Converts a price string into a number\n     * @param {String} price\n     * @return {Number}\n     */\n    normalizePrice: function (price) {\n      return Tools.parseFloatFromString(price, true);\n    },\n\n    /**\n     * Adds taxes to a price\n     * @param {Number} price Price without taxes\n     * @return {Number} Price with added taxes\n     */\n    addCurrentTax: function (price) {\n      var rates = this.getRates();\n      var computation_method = taxElem.find('option:selected').attr('data-computation-method');\n      var priceWithTaxes = Number(ps_round(addTaxes(price, rates, computation_method), displayPricePrecision));\n      var ecotaxIncluded = Number(getEcotaxTaxIncluded());\n\n      return priceWithTaxes + ecotaxIncluded;\n    },\n\n    /**\n     * Calculates the price with taxes and updates the elements containing it\n     */\n    taxInclude: function () {\n      var newPrice = truncateDecimals(this.addCurrentTax(this.normalizePrice(priceHTElem.val())), 6);\n\n      priceTTCElem.val(newPrice).change();\n      priceTTCShorcutElem.val(newPrice).change();\n    },\n\n    /**\n     * Removes taxes from a price\n     * @param {Number} price Price with taxes\n     * @return {Number} Price without taxes\n     */\n    removeCurrentTax: function (price) {\n      var rates = this.getRates();\n      var computation_method = taxElem.find('option:selected').attr('data-computation-method');\n\n      return ps_round(removeTaxes(ps_round(price - getEcotaxTaxIncluded(), displayPricePrecision), rates, computation_method), displayPricePrecision);\n    },\n\n    /**\n     * Calculates the price without taxes and updates the elements containing it\n     */\n    taxExclude: function () {\n      var newPrice = truncateDecimals(this.removeCurrentTax(this.normalizePrice(priceTTCElem.val())), 6);\n\n      priceHTElem.val(newPrice).change();\n      priceHTShortcutElem.val(newPrice).change();\n    },\n\n    /**\n     * Calculates and displays the impact on price (including tax) for a combination\n     * @param {jQuery} obj\n     */\n    impactTaxInclude: function (obj) {\n      var price = Tools.parseFloatFromString(obj.val());\n      var targetInput = obj.closest('div[id^=\"combination_form_\"]').find('input.attribute_priceTI');\n      var newPrice = 0;\n\n      if (!isNaN(price)) {\n        var rates = this.getRates();\n        var computation_method = taxElem.find('option:selected').attr('data-computation-method');\n        newPrice = ps_round(addTaxes(price, rates, computation_method), 6);\n        newPrice = truncateDecimals(newPrice, 6);\n      }\n\n      targetInput\n        .val(newPrice)\n        .trigger('change')\n      ;\n    },\n\n    /**\n     * Calculates and displays the final price for a combination\n     * @param {jQuery} obj\n     */\n    impactFinalPrice: function (obj) {\n      var price = this.normalizePrice(obj.val());\n      var finalPrice = obj.closest('div[id^=\"combination_form_\"]').find('.final-price');\n      var defaultFinalPrice = finalPrice.attr('data-price');\n      var priceToBeChanged = Number(price) + Number(defaultFinalPrice);\n      priceToBeChanged = truncateDecimals(priceToBeChanged, 6);\n\n      finalPrice.html(priceToBeChanged);\n    },\n\n    /**\n     * Calculates and displays the impact on price (excluding tax) for a combination\n     * @param {jQuery} obj\n     */\n    impactTaxExclude: function (obj) {\n      var price = Tools.parseFloatFromString(obj.val());\n      var targetInput = obj.closest('div[id^=\"combination_form_\"]').find('input.attribute_priceTE');\n      var newPrice = 0;\n\n      if (!isNaN(price)) {\n        var rates = this.getRates();\n        var computation_method = taxElem.find('option:selected').attr('data-computation-method');\n        newPrice = removeTaxes(ps_round(price, displayPricePrecision), rates, computation_method);\n        newPrice = truncateDecimals(newPrice, 6);\n      }\n\n      targetInput\n        .val(newPrice)\n        .trigger('change')\n      ;\n    },\n\n    /**\n     * Returns the tax rates that apply\n     * @return {Number[]}\n     */\n    getRates: function () {\n      return taxElem\n        .find('option:selected')\n        .attr('data-rates')\n        .split(',')\n        .map(function(rate) {\n          return Tools.parseFloatFromString(rate, true);\n        });\n    }\n  };\n})();\n\n/**\n * Manage seo\n */\nvar seo = (function() {\n  var redirectTypeElem = $('#form_step5_redirect_type');\n  var productRedirect = $('#id-product-redirected');\n\n  /** Hide or show the input product selector */\n  function hideShowRedirectToProduct() {\n    if ('404' === redirectTypeElem.val()) {\n      $('#id-product-redirected').hide();\n    } else {\n      updateRemoteUrl();\n      $('#id-product-redirected').show();\n    }\n  }\n\n  function updateRemoteUrl() {\n    switch(redirectTypeElem.val()) {\n      case '301-category':\n      case '302-category':\n        productRedirect.find('label').html(redirectTypeElem.attr('data-labelcategory'));\n        productRedirect.find('input').attr('placeholder', redirectTypeElem.attr('data-placeholdercategory'));\n        productRedirect.find('.typeahead-hint').text(redirectTypeElem.attr('data-hintcategory'));\n        break;\n      default:\n        productRedirect.find('label').html(redirectTypeElem.attr('data-labelproduct'));\n        productRedirect.find('input').attr('placeholder', redirectTypeElem.attr('data-placeholderproduct'));\n        productRedirect.find('.typeahead-hint').text('');\n    }\n\n    productRedirect.find('.autocomplete-search').attr('data-remoteurl', redirectTypeElem.find('option:selected').data('remoteurl'));\n    productRedirect.find('.autocomplete-search').trigger('buildTypeahead');\n  }\n\n  /** Update friendly URL */\n  var updateFriendlyUrl = function(elem) {\n      /** Attr name equals \"form[step1][name][1]\".\n       * We need in this string the second integer */\n      var id_lang = elem.attr('name').match(/\\d+/g)[1];\n      $('#form_step5_link_rewrite_' + id_lang).val(str2url(elem.val(), 'UTF-8'));\n  };\n\n  return {\n    'init': function() {\n\n      hideShowRedirectToProduct();\n      updateRemoteUrl();\n\n      /** On redirect type select change */\n      redirectTypeElem.change(function() {\n        productRedirect.find('#form_step5_id_type_redirected-data').html('');\n        hideShowRedirectToProduct();\n      });\n\n      /** On product title change, update friendly URL*/\n      $('#form_step1_names.friendly-url-force-update input').keyup(function() {\n        updateFriendlyUrl($(this));\n      });\n\n      /** Reset all languages title to friendly url*/\n      $('#seo-url-regenerate').click(function() {\n        $.each($('#form_step1_names input'), function() {\n          updateFriendlyUrl($(this));\n        });\n      });\n    },\n    'onSave': function() {\n        // check all friendly URLs have been filled. If not, fill them.\n        $('input[id^=\"form_step5_link_rewrite_\"]', \"#form_step5_link_rewrite\").each(function(){\n            var elem = $(this);\n            if (0 === elem.val().length) {\n                var id_lang = elem.attr('name').match(/\\d+/g)[1];\n                updateFriendlyUrl($('#form_step1_name_' + id_lang));\n            }\n        });\n    }\n  };\n})();\n\n/**\n * Tags management\n */\nvar tags = (function() {\n  return {\n    'init': function() {\n      $('#form_step6_tags .tokenfield').tokenfield({\n        minWidth: '768px'\n      });\n    }\n  };\n})();\n\nvar recommendedModules = (function() {\n  return {\n    'init': function() {\n      this.moduleActionMenuLinkSelectors = 'button.module_action_menu_install, button.module_action_menu_enable, ' +\n        'button.module_action_menu_uninstall, button.module_action_menu_disable, button.module_action_menu_reset, button.module_action_menu_update';\n      $(this.moduleActionMenuLinkSelectors).on('module_card_action_event', this.saveProduct);\n    },\n    'saveProduct': function(event, action) {\n      form.send();\n    }\n  };\n})();\n"], "fixing_code": ["/**\n * 2007-2019 PrestaShop and Contributors\n *\n * NOTICE OF LICENSE\n *\n * This source file is subject to the Open Software License (OSL 3.0)\n * that is bundled with this package in the file LICENSE.txt.\n * It is also available through the world-wide-web at this URL:\n * https://opensource.org/licenses/OSL-3.0\n * If you did not receive a copy of the license and are unable to\n * obtain it through the world-wide-web, please send an email\n * to license@prestashop.com so we can send you a copy immediately.\n *\n * DISCLAIMER\n *\n * Do not edit or add to this file if you wish to upgrade PrestaShop to newer\n * versions in the future. If you wish to customize PrestaShop for your\n * needs please refer to https://www.prestashop.com for more information.\n *\n * @author    PrestaShop SA <contact@prestashop.com>\n * @copyright 2007-2019 PrestaShop SA and Contributors\n * @license   https://opensource.org/licenses/OSL-3.0 Open Software License (OSL 3.0)\n * International Registered Trademark & Property of PrestaShop SA\n */\n\n$(document).ready(function() {\n  form.init();\n  nav.init();\n  featuresCollection.init();\n  displayFormCategory.init();\n  formCategory.init();\n  stock.init();\n  supplier.init();\n  warehouseCombinations.init();\n  customFieldCollection.init();\n  virtualProduct.init();\n  attachmentProduct.init();\n  imagesProduct.init();\n  priceCalculation.init();\n  displayFieldsManager.refresh();\n  displayFieldsManager.init(virtualProduct);\n  seo.init();\n  tags.init();\n  rightSidebar.init();\n  recommendedModules.init();\n  BOEvent.emitEvent(\"Product Categories Management started\", \"CustomEvent\");\n  BOEvent.emitEvent(\"Product Default category Management started\", \"CustomEvent\");\n  BOEvent.emitEvent(\"Product Manufacturer Management started\", \"CustomEvent\");\n  BOEvent.emitEvent(\"Product Related Management started\", \"CustomEvent\");\n  BOEvent.emitEvent(\"Modal confirmation started\", \"CustomEvent\");\n  BOEvent.emitEvent(\"Product Combinations Management started\", \"CustomEvent\");\n\n  /** Type product fields display management */\n  $('#form_step1_type_product').change(function() {\n    displayFieldsManager.refresh();\n  });\n\n  // Validate price fields on input change\n  $(\".money-type input[type='text']\").change(function validate() {\n    var inputValue = priceCalculation.normalizePrice($(this).val());\n    var parsedValue = truncateDecimals(inputValue, 6);\n\n    $(this).val(parsedValue);\n  });\n\n  /** Attach date picker */\n  $('.datepicker').datetimepicker({\n    locale: full_language_code,\n    format: 'YYYY-MM-DD'\n  });\n\n  /** tooltips should be hidden when we move to another tab */\n  $('#form-nav').on('click','.nav-item', function clearTooltipsAndPopovers() {\n    $('[data-toggle=\"tooltip\"]').tooltip('hide');\n    $('[data-toggle=\"popover\"]').popover('hide');\n  });\n\n  $('.summary-description-container a[data-toggle=\"tab\"]').on('shown.bs.tab', resetEditor);\n});\n\n/**\n * Reset active tinyMce editor (triggered when switch language, or switching tabs)\n */\nfunction resetEditor() {\n  const languageEditorsSelector = '.summary-description-container .panel.active div.translation-field.active textarea.autoload_rte';\n  $(languageEditorsSelector).each(function(index, textarea) {\n    const editor = tinyMCE.get(textarea.id);\n    if (editor) {\n      //Reset content to force refresh of editor\n      editor.setContent(editor.getContent());\n    }\n  });\n}\n\n/**\n * Manage show or hide fields\n */\nvar displayFieldsManager = (function() {\n\n  var typeProduct = $('#form_step1_type_product');\n  var showVariationsSelector = $('#show_variations_selector');\n  var combinationsBlock = $('#combinations');\n  var managedVirtualProduct;\n\n  return {\n    'init': function (virtualProduct) {\n      managedVirtualProduct = virtualProduct;\n\n      /** Type product fields display management */\n      $('#form_step1_type_product').change(function () {\n        displayFieldsManager.refresh();\n      });\n\n      $('#form .form-input-title input').on('focus', function () {\n        $(this).select();\n      });\n\n      this.initVisibilityRule();\n\n      /** Tax rule dropdown shortcut */\n      $('a#tax_rule_shortcut_opener').on('click', function () {\n        // lazy instantiated\n        var duplicate = $('#form_step2_id_tax_rules_group_shortcut');\n        if (duplicate.length == 0) {\n          var origin = $('select#form_step2_id_tax_rules_group');\n          duplicate = origin.clone(false).attr('id', 'form_step2_id_tax_rules_group_shortcut');\n          origin.on('change', function () {\n            duplicate.val(origin.val()); // no change() here to avoid infinite loop.\n          });\n          duplicate.on('change', function () {\n            origin.val(duplicate.val()).change();\n          });\n          duplicate.appendTo($('#tax_rule_shortcut'));\n        }\n        duplicate.parent().parent().show();\n\n        return false;\n      });\n    },\n    /**\n     * When a product is available for order, its price should be visible,\n     * whereas products unavailable for order can have their prices visible or hidden.\n     */\n    'initVisibilityRule': function () {\n      var showPriceSelector = '.js-show-price';\n      var availableForOrderSelector = '.js-available-for-order';\n\n      var applyVisibilityRule = function applyVisibilityRule() {\n        var $availableForOrder = $(availableForOrderSelector + ' input');\n        var $showPrice = $(showPriceSelector + ' input');\n        var $showPriceColumn = $(showPriceSelector);\n        if ($availableForOrder.prop('checked')) {\n          $showPrice.prop('checked', true);\n          $showPriceColumn.addClass('hide');\n        } else {\n          $showPriceColumn.removeClass('hide');\n        }\n      };\n      $(availableForOrderSelector + ' .checkbox').on('click', applyVisibilityRule);\n      applyVisibilityRule();\n    },\n    'refresh': function () {\n      this.checkAccessVariations();\n      $('#virtual_product').hide();\n      $('#form-nav a[href=\"#step3\"]').text(translate_javascripts['Quantities']);\n\n      /** product type switch */\n\n      if (typeProduct.val() === '1') {\n        $('#pack_stock_type, #js_form_step1_inputPackItems').show();\n        $('#form-nav a[href=\"#step4\"]').show();\n        showVariationsSelector.hide();\n        showVariationsSelector.find('input[value=\"0\"]').attr('checked', true);\n      } else {\n        $('#virtual_product, #pack_stock_type, #js_form_step1_inputPackItems').hide();\n        $('#form-nav a[href=\"#step4\"]').show();\n\n        if (typeProduct.val() === '2') {\n          showVariationsSelector.hide();\n          $('#virtual_product').show();\n          $('#form-nav a[href=\"#step4\"]').hide();\n          showVariationsSelector.find('input[value=\"0\"]').attr('checked', true);\n          $('#form-nav a[href=\"#step3\"]').text(translate_javascripts['Virtual product']);\n        } else {\n          showVariationsSelector.show();\n          $('#form-nav a[href=\"#step3\"]').text(translate_javascripts['Quantities']);\n        }\n      }\n\n      // Switching from a product type to another which is not \"Virtual product\",\n      // triggers the destruction of pre-existing virtual product\n      var shouldDestroyVirtualProduct = typeProduct.val() !== '2';\n      if (shouldDestroyVirtualProduct && managedVirtualProduct !== undefined) {\n        managedVirtualProduct.destroy();\n      }\n\n      /** check quantity / combinations display */\n      if (showVariationsSelector.find('input:checked').val() === '1' || $('#accordion_combinations tr:not(#loading-attribute)').length > 0) {\n        combinationsBlock.show();\n\n        $('#form-nav a[href=\"#step3\"]').text(translate_javascripts['Combinations']);\n        $('#product_qty_0_shortcut_div, #quantities').hide();\n      } else {\n        combinationsBlock.hide();\n        $('#product_qty_0_shortcut_div, #quantities').show();\n      }\n\n      /** Tooltip for product type combinations */\n      if ($('input[name=\"show_variations\"][value=\"1\"]:checked').length >= 1) {\n        $('#product_type_combinations_shortcut').show();\n      } else {\n        $('#product_type_combinations_shortcut').hide();\n      }\n    },\n    'getProductType': function () {\n      switch (typeProduct.val()) {\n        case '0':\n          return 'standard';\n          break;\n        case '1':\n          return 'pack';\n          break;\n        case '2':\n          return 'virtual';\n          break;\n        default:\n          return 'standard';\n      }\n    },\n    /**\n     * Product pack or virtual can't have variations\n     * Warn e-merchant.\n     * @param errorMessage\n     */\n    'checkAccessVariations': function () {\n      if ((showVariationsSelector.find('input:checked').val() === '1' || $('#accordion_combinations tr:not(#loading-attribute)').length > 0) && (typeProduct.val() === '1' || typeProduct.val() === '2')) {\n        var typeOfProduct = this.getProductType();\n        var errorMessage = \"You can't create \" + typeOfProduct + \" product with variations. Are you sure to disable variations ? they will all be deleted.\";\n        modalConfirmation.create(translate_javascripts[errorMessage], null, {\n          onCancel: function () {\n            typeProduct.val(0).change();\n            /* else the radio bouton is not display even if checked attribute is true */\n            $('#show_variations_selector input[value=\"1\"]').click();\n          },\n          onContinue: function () {\n            $.ajax({\n              type: 'GET',\n              url: $('#accordion_combinations').attr('data-action-delete-all').replace(/delete-all\\/\\d+/, 'delete-all/' + $('#form_id_product').val()),\n              success: function () {\n                $('#accordion_combinations .combination').remove();\n                displayFieldsManager.refresh();\n              },\n              error: function (response) {\n                showErrorMessage(jQuery.parseJSON(response.responseText).message);\n              },\n            });\n          }\n        }).show();\n      }\n    }\n  }\n})();\n\n/**\n * Display category form management\n */\nvar displayFormCategory = (function() {\n  var parentElem = $('#add-categories');\n  return {\n    'init': function() {\n      /** Click event on the add button */\n      parentElem.find('a.open').on('click', function(e) {\n        e.preventDefault();\n        parentElem.find('#add-categories-content').removeClass('hide');\n        $(this).hide();\n      });\n    }\n  };\n})();\n\n/**\n * Form category management\n */\nvar formCategory = (function() {\n  var elem = $('#form_step1_new_category');\n\n  /** Send category form and it to nested categories */\n  function send(form) {\n    $.ajax({\n      type: 'POST',\n      url: elem.attr('data-action'),\n      data: {\n        'form[category][name]': $('#form_step1_new_category_name').val(),\n        'form[category][id_parent]': $('#form_step1_new_category_id_parent').val(),\n        'form[_token]': $('#form #form__token').val()\n      },\n      beforeSend: function() {\n        $('button.submit', elem).attr('disabled', 'disabled');\n        $('ul.text-danger', elem).remove();\n        $('*.has-danger', elem).removeClass('has-danger');\n        $('*.has-danger').removeClass('has-danger');\n      },\n      success: function(response) {\n        //inject new category into category tree\n        var html = '<li>' +\n          '<div class=\"checkbox js-checkbox\">' +\n            '<label>' +\n              '<input type=\"checkbox\" name=\"form[step1][categories][tree][]\" checked value=\"'+response.category.id+'\"> ' +\n                response.category.name[1] +\n                '<input type=\"radio\" value=\"'+response.category.id+'\" name=\"ignore\" class=\"default-category\">' +\n            '</label>' +\n          '</div>' +\n          '</li>';\n\n        var parentElement = $('#form_step1_categories input[value='+response.category.id_parent+']').parent().parent();\n        if(parentElement.next('ul').length === 0){\n          html = '<ul>' + html + '</ul>';\n          parentElement.append(html);\n        } else {\n          parentElement.next('ul').append(html);\n        }\n\n        //inject new category in parent category selector\n        $('#form_step1_new_category_id_parent').append('<option value=\"' + response.category.id + '\">' + response.category.name[1] + '</option>');\n\n        // create label\n        var tag = {\n          'name': response.category.name[1],\n          'id': response.category.id,\n          'breadcrumb': ''\n        };\n        productCategoriesTags.createTag(tag);\n\n        //hide the form\n        form.hideBlock();\n      },\n      error: function(response) {\n        $.each(jQuery.parseJSON(response.responseText), function(key, errors) {\n          var html = '<ul class=\"list-unstyled text-danger\">';\n          $.each(errors, function(key, error) {\n            html += '<li>' + error + '</li>';\n          });\n          html += '</ul>';\n\n          $('#form_step1_new_' + key).parent().append(html);\n          $('#form_step1_new_' + key).parent().addClass('has-danger');\n        });\n      },\n      complete: function() {\n        $('#form_step1_new_category button.submit').removeAttr('disabled');\n      }\n    });\n  }\n\n  return {\n    'init': function() {\n      var that = this;\n      /** remove all categories from selector, except pre defined */\n      $('#add-categories button.save').click(function(){\n        send(that);\n      });\n      $('#add-categories button[type=\"reset\"]').click(function(){\n        that.hideBlock();\n      });\n    },\n    'hideBlock': function() {\n      $('#form_step1_new_category_name').val('');\n      $('#add-category-button').show();\n      $('#add-categories-content').addClass('hide');\n    }\n  };\n})();\n\n/**\n * Feature collection management\n */\nvar featuresCollection = (function() {\n\n  var collectionHolder = $('.feature-collection');\n  var maxCollectionChildren = collectionHolder.children('.row').length;\n\n  /** Add a feature */\n  function add() {\n    var newForm = collectionHolder.attr('data-prototype').replace(/__name__/g, maxCollectionChildren);\n    collectionHolder.append(newForm);\n    maxCollectionChildren += 1;\n    prestaShopUiKit.initSelects();\n  }\n\n  return {\n    'init': function() {\n      /** Click event on the add button */\n      $('#features .add').on('click', function(e) {\n        e.preventDefault();\n        add();\n        $('#features-content').removeClass('hide');\n      });\n\n      /** Click event on the remove button */\n      $(document).on('click', '.feature-collection .delete', function(e) {\n        e.preventDefault();\n        var _this = $(this);\n\n        modalConfirmation.create(translate_javascripts['Are you sure to delete this?'], null, {\n          onContinue: function() {\n            _this.closest('.product-feature').remove();\n          }\n        }).show();\n      });\n\n      function replaceEndingIdFromUrl(url, newId)\n      {\n        return url.replace(/\\/\\d+(?!.*\\/\\d+)((?=\\?.*))?/, '/' + newId);\n      }\n\n      /** On feature selector event change, refresh possible values list */\n      $(document).on('change', '.feature-collection select.feature-selector', function(event) {\n        var that = event.currentTarget;\n        var $row = $($(that).parents('.row')[0]);\n        var $selector = $row.find('.feature-value-selector');\n\n        if('' !== $(this).val()) {\n          $.ajax({\n            url: replaceEndingIdFromUrl($(this).attr('data-action'), $(this).val()),\n            success: function(response) {\n              $selector.prop('disabled', response.length === 0);\n              $selector.empty();\n              $.each(response, function(index, elt) {\n                // the placeholder shouldn't be posted.\n                if ('0' == elt.id) {\n                  elt.id = '';\n                }\n                $selector.append($('<option></option>').attr('value', elt.id).text(elt.value));\n              });\n            }\n          });\n        }\n      });\n\n      var $featuresContainer = $('#features-content');\n\n      $featuresContainer.on('change', '.row select, .row input[type=\"text\"]', function onChange(event){\n        var that = event.currentTarget;\n        var $row = $($(that).parents('.row')[0]);\n        var $definedValueSelector = $row.find('.feature-value-selector');\n        var $customValueSelector = $row.find('input[type=text]');\n\n        // if feature has changed we need to reset values\n        if ($(that).hasClass('feature-selector')) {\n          $customValueSelector.val('');\n          $definedValueSelector.val('');\n        }\n      });\n    }\n  };\n})();\n\n/**\n * Suppliers management\n */\nvar supplier = (function() {\n\n  var supplierInputManage = function(input) {\n    var supplierDefaultInput = $('#form_step6_suppliers input[name=\"form[step6][default_supplier]\"][value=' + $(input).val() +']');\n    if ($(input).is(':checked')) {\n      supplierDefaultInput.prop('disabled', false).show();\n    } else {\n      supplierDefaultInput.prop('disabled', true).hide();\n    }\n  };\n\n  return {\n    'init': function() {\n      /** On supplier select, hide or show the default supplier selector */\n      var supplierInput = $('#form_step6_suppliers input[name=\"form[step6][suppliers][]\"]');\n      supplierInput.change(function() {\n        supplierInputManage($(this));\n        supplierCombinations.refresh();\n      });\n\n      //default display\n      $('#form_step6_suppliers input[name=\"form[step6][suppliers][]\"]').map(function() {\n        supplierInputManage($(this));\n      });\n    }\n  };\n})();\n\n/**\n * Supplier combination collection management\n */\nvar supplierCombinations = (function() {\n  var id_product = $('#form_id_product').val();\n  var collectionHolder = $('#supplier_combination_collection');\n\n  return {\n    'refresh': function() {\n      var suppliers = $('#form_step6_suppliers input[name=\"form[step6][suppliers][]\"]:checked').map(function() {\n        return $(this).val();\n      }).get();\n      var url = collectionHolder.attr('data-url')\n        .replace(\n          /refresh-product-supplier-combination-form\\/\\d+\\/\\d+/,\n          'refresh-product-supplier-combination-form/' + id_product + (suppliers.length > 0 ? '/' + suppliers.join('-') : '')\n        );\n      $.ajax({\n        url: url,\n        success: function(response) {\n          collectionHolder.empty().append(response);\n        }\n      });\n    }\n  };\n})();\n\n/**\n * Quantities management\n */\nvar stock = (function() {\n  return {\n    'init': function() {\n      /** Update qty_0 and shortcut qty_0 field on change */\n      $('#form_step1_qty_0_shortcut, #form_step3_qty_0').keyup(function() {\n        if ($(this).attr('id') === 'form_step1_qty_0_shortcut') {\n          $('#form_step3_qty_0').val($(this).val());\n        } else {\n          $('#form_step1_qty_0_shortcut').val($(this).val());\n        }\n      });\n\n      /** if GSA : Show depends_on_stock choice only if advanced_stock_management checked */\n      $('#form_step3_advanced_stock_management').on('change', function(e) {\n        if (e.target.checked) {\n          $('#depends_on_stock_div').show();\n        } else {\n          $('#depends_on_stock_div').hide();\n        }\n        warehouseCombinations.refresh();\n      });\n\n      /** if GSA activation change on 'depend on stock', update quantities fields */\n      $('#form_step3_depends_on_stock_0, #form_step3_depends_on_stock_1, #form_step3_advanced_stock_management').on('change', function(e) {\n        displayFieldsManager.refresh();\n        warehouseCombinations.refresh();\n      });\n      displayFieldsManager.refresh();\n    }\n  };\n})();\n\n\n/**\n * Navigation management\n */\nvar nav = (function() {\n  return {\n    'init': function() {\n      /** Manage tabls hash routes */\n      var hash = document.location.hash;\n      var formNav = $(\"#form-nav\");\n      var prefix = 'tab-';\n      if (hash) {\n        formNav.find(\"a[href='\" + hash.replace(prefix, '') + \"']\").tab('show');\n      }\n\n      formNav.find(\"a\").on('shown.bs.tab', function(e) {\n        if (e.target.hash) {\n          window.location.hash = e.target.hash.replace('#', '#' + prefix);\n        }\n      });\n    }\n  };\n})();\n\n/**\n * Warehouse combination collection management (ASM only)\n */\nvar warehouseCombinations = (function() {\n  var id_product = $('#form_id_product').val();\n  var collectionHolder = $('#warehouse_combination_collection');\n\n  return {\n    'init': function() {\n      // toggle all button action\n      $(document).on('click', 'div[id^=\"warehouse_combination_\"] button.check_all_warehouse', function() {\n        var checkboxes = $(this).closest('div[id^=\"warehouse_combination_\"]').find('input[type=\"checkbox\"][id$=\"_activated\"]');\n        checkboxes.prop('checked', checkboxes.filter(':checked').length === 0);\n      });\n      // location disablation depending on 'stored' checkbox\n      $(document).on('change', 'div[id^=\"warehouse_combination_\"] input[id^=\"form_step4_warehouse_combination_\"][id$=\"_activated\"]', function() {\n        var checked = $(this).prop('checked');\n        var location = $(this).closest('div.form-group').find('input[id^=\"form_step4_warehouse_combination_\"][id$=\"_location\"]');\n        location.prop('disabled', !checked);\n        if (!checked) {\n          location.val('');\n        }\n      });\n      this.locationDisabler();\n    },\n    'locationDisabler': function() {\n      $('div[id^=\"warehouse_combination_\"] input[id^=\"form_step4_warehouse_combination_\"][id$=\"_activated\"]', collectionHolder).each(function() {\n        var checked = $(this).prop('checked');\n        var location = $(this).closest('div.form-group').find('input[id^=\"form_step4_warehouse_combination_\"][id$=\"_location\"]');\n        location.prop('disabled', !checked);\n      });\n    },\n    'refresh': function() {\n      var show = $('input#form_step3_advanced_stock_management:checked').length > 0;\n      if (show) {\n        var url = collectionHolder.attr('data-url').replace(/\\/\\d+(?=\\?.*)/, '/' + id_product);\n        $.ajax({\n          url: url,\n          success: function(response) {\n            collectionHolder.empty().append(response);\n            collectionHolder.show();\n            warehouseCombinations.locationDisabler();\n          }\n        });\n      } else {\n        collectionHolder.hide();\n      }\n    }\n  };\n})();\n\n/**\n * Form management\n */\nvar form = (function() {\n  var elem = $('#form');\n\n  function send(redirect, target, callBack) {\n    // target value by default\n    if (typeof(target) == 'undefined') {\n      target = false;\n    }\n    seo.onSave();\n    updateMissingTranslatedNames();\n\n    var data = $('input, textarea, select', elem).not(':input[type=button], :input[type=submit], :input[type=reset]').serialize();\n\n    if (target == '_blank' && redirect) {\n      var openBlank = window.open('about:blank', target, '');\n      openBlank.document.write(\n        '<p style=\"text-align: center;\">' +\n        '<img src=\"' + document.location.origin + baseAdminDir + '/themes/default/img/spinner.gif\">' +\n        '</p>'\n      );\n    }\n\n    $.ajax({\n      type: 'POST',\n      data: data,\n      beforeSend: function() {\n        $('#submit', elem).attr('disabled', 'disabled');\n        $('.btn-submit', elem).attr('disabled', 'disabled');\n        $('ul.text-danger').remove();\n        $('*.has-danger').removeClass('has-danger');\n        $('#form-nav li.has-error').removeClass('has-error');\n        updateDisplayGlobalErrors(null);\n      },\n      success: function(response) {\n        if (callBack) {\n          callBack();\n        }\n        showSuccessMessage(translate_javascripts['Form update success']);\n        //update the customization ids\n        if (typeof response.customization_fields_ids != \"undefined\") {\n          $.each(response.customization_fields_ids, function (k, v) {\n            $(\"#form_step6_custom_fields_\" + k + \"_id_customization_field\").val(v);\n          });\n        }\n\n        $('.js-spinner').hide();\n\n        if (!redirect) {\n          return;\n        }\n\n        if (false === target) {\n          window.location = redirect;\n\n          return;\n        }\n\n        if ('_blank' !== target) {\n          window.open(redirect, target);\n\n          return;\n        }\n\n        openBlank.location = redirect;\n      },\n      error: function(response) {\n        showErrorMessage(translate_javascripts['Form update errors']);\n\n        if (target == '_blank' && redirect) {\n          openBlank.close();\n        }\n\n        var tabsWithErrors = [];\n\n        $.each(jQuery.parseJSON(response.responseText), function(key, errors) {\n          tabsWithErrors.push(key);\n\n          var html = '<ul class=\"list-unstyled text-danger\">';\n          $.each(errors, function(unusedKey, error) {\n            html += '<li>' + error + '</li>';\n          });\n          html += '</ul>';\n\n          if (0 === key.localeCompare('error')) {\n            updateDisplayGlobalErrors(html);\n          } else if (key.match(/^combination_.*/)) {\n            $('#' + key).parent().addClass('has-danger').append(html);\n          } else {\n            $('#form_' + key).parent().addClass('has-danger').append(html);\n          }\n\n        });\n\n        /** find first tab with error, then switch to it */\n        tabsWithErrors.sort();\n        $.each(tabsWithErrors, function(key, tabIndex) {\n          if (0 === key) {\n            $('#form-nav li a[href=\"#' + tabIndex.split('_')[0] + '\"]').tab('show');\n          }\n\n          $('#form-nav li a[href=\"#' + tabIndex.split('_')[0] + '\"]').parent().addClass('has-error');\n        });\n\n        if ($('div[class*=\"translation-label-\"].has-danger').length > 0) {\n          var regexLabel = 'translation-label-';\n\n          var translationLabelClass = $.grep($('div[class*=\"translation-label-\"].has-danger').first().attr('class').split(\" \"), function(v, i){\n            return v.indexOf(regexLabel) === 0;\n          }).join();\n\n          if (translationLabelClass) {\n            var selectValue = translationLabelClass.replace(regexLabel, '');\n\n            if ($('#form_switch_language option[value=\"' + selectValue + '\"]').length > 0) {\n              $('#form_switch_language').val(selectValue).change();\n            }\n          }\n        }\n\n        /** scroll to 1st error */\n        if ($('.has-danger').first().offset()) {\n          $('html, body').animate({\n            scrollTop: $('.has-danger').first().offset().top - $('nav.main-header').height()\n          }, 500);\n        }\n      },\n      complete: function() {\n        $('#submit', elem).removeAttr('disabled');\n        $('.btn-submit', elem).removeAttr('disabled');\n      }\n    });\n  }\n\n  function switchLanguage(iso_code) {\n    $('div.translations.tabbable > div > div.translation-field:not(.translation-label-' + iso_code + ')').removeClass('show active');\n\n    const langueTabSelector = 'div.translations.tabbable > div > div.translation-field.translation-label-' + iso_code;\n    $(langueTabSelector).addClass('show active');\n    resetEditor();\n  }\n\n  function updateMissingTranslatedNames() {\n    var namesDiv = $('#form_step1_names');\n    var defaultLanguageValue = null;\n    $(\"input[id^='form_step1_name_']\", namesDiv).each(function(index) {\n      var value = $(this).val();\n      // The first language is ALWAYS the employee language\n      if (0 === index) {\n        defaultLanguageValue = value;\n      } else if (0 === value.length) {\n        $(this).val(defaultLanguageValue);\n      }\n    });\n  }\n\n  /**\n   * Depending on the provided params, this method displays or hides\n   * an error panel with the form errors not linked to a specific field.\n   *\n   * @param {string} content The HTML content to display\n   */\n  function updateDisplayGlobalErrors(content) {\n    const target = $(\"#form_bubbling_errors\");\n    target.html('');\n    if (content) {\n      target.html(`<div class=\"alert alert-danger\">${content}</div>`);\n    }\n  }\n\n  return {\n    'init': function() {\n      /** prevent form submit on ENTER keypress */\n      jwerty.key('enter', function(e) {\n        e.preventDefault();\n      });\n\n      /** create keyboard event for save */\n      jwerty.key('alt+shift+S', function(e) {\n        e.preventDefault();\n        send();\n      });\n\n      /** create keyboard event for save & duplicate */\n      jwerty.key('alt+shift+D', function(e) {\n        e.preventDefault();\n        send($('.product-footer .duplicate').attr('data-redirect'));\n      });\n\n      /** create keyboard event for save & new */\n      jwerty.key('alt+shift+P', function(e) {\n        e.preventDefault();\n        send($('.product-footer .new-product').attr('data-redirect'));\n      });\n\n      /** create keyboard event for save & go catalog */\n      jwerty.key('alt+shift+Q', function(e) {\n        e.preventDefault();\n        send($('.product-footer .go-catalog').attr('data-redirect'));\n      });\n\n      /** create keyboard event for save & go preview */\n      jwerty.key('alt+shift+V', function(e) {\n          e.preventDefault();\n          var productFooter = $('.product-footer .preview');\n          send(productFooter.attr('data-redirect'), productFooter.attr('target'));\n      });\n\n      /** create keyboard event for save & active or desactive product*/\n      jwerty.key('alt+shift+O', function(e) {\n        e.preventDefault();\n        var step1CheckBox = $('#form_step1_active');\n        step1CheckBox.prop('checked', !step1CheckBox.is(':checked'));\n      });\n\n      elem.submit(function(event) {\n        event.preventDefault();\n        send();\n      });\n\n      elem.find('#form_switch_language').change(function(event) {\n        event.preventDefault();\n        switchLanguage(event.target.value);\n      });\n\n      /** on save with duplicate|new|preview */\n      $('.btn-submit, .preview', elem).click(function(event) {\n        event.preventDefault();\n        send($(this).attr('data-redirect'), $(this).attr('target'));\n      });\n\n      $('.js-btn-save').on('click', function (event) {\n        event.preventDefault();\n        $('.js-spinner').css('display', 'inline-block');\n        send($(this).attr('href'));\n      });\n\n      /** on active field change, send form */\n      $('#form_step1_active', elem).on('change', function() {\n        var active = $(this).prop('checked');\n        $('.for-switch.online-title').toggle(active);\n        $('.for-switch.offline-title').toggle(!active);\n        // update link preview\n        var previewButton = $('#product_form_preview_btn');\n        var urlActive = previewButton.attr('data-redirect');\n        var urlDeactive = previewButton.attr('data-url-deactive');\n        previewButton.attr('data-redirect', urlDeactive);\n        previewButton.attr('data-url-deactive', urlActive);\n        // update product\n        send();\n      });\n\n      /** on delete product */\n      $('.product-footer .delete', elem).click(function(e) {\n        e.preventDefault();\n        var _this = $(this);\n        modalConfirmation.create(translate_javascripts['Are you sure to delete this?'], null, {\n          onContinue: function() {\n            window.location = _this.attr('href');\n          }\n        }).show();\n      });\n\n      $('#form-loading').fadeIn(function() {\n      /** Create Bloodhound engine */\n      var engine = new Bloodhound({\n        datumTokenizer: function(d) {\n          return Bloodhound.tokenizers.whitespace(d.label);\n        },\n        queryTokenizer: Bloodhound.tokenizers.whitespace,\n        prefetch: {\n          url: $('#form_step3_attributes').attr('data-prefetch'),\n          cache: false\n        }\n      });\n\n      /** init input typeahead */\n      $('#form_step3_attributes').tokenfield({\n        typeahead: [{\n          hint: false,\n          cache: false\n        }, {\n          source: function(query, syncResults) {\n            engine.search(query, function(suggestions) {\n              syncResults(filter(suggestions));\n            });\n          },\n          display: 'label'\n        }],\n        minWidth: '768px'\n      });\n\n      /** Filter suggestion with selected tokens */\n      var filter = function(suggestions) {\n        var selected = [];\n        $('#attributes-generator input.attribute-generator').each(function() {\n          selected.push($(this).val());\n        });\n\n        return $.grep(suggestions, function(suggestion) {\n          return $.inArray(suggestion.value, selected) === -1 && $.inArray('group-' + suggestion.data.id_group, selected) === -1;\n        });\n      };\n\n      /** On event \"tokenfield:createtoken\" : stop event if its not a typehead result */\n      $('#form_step3_attributes').on('tokenfield:createtoken', function(e) {\n        if (!e.attrs.data && e.handleObj.origType !== 'tokenfield:createtoken') {\n          return false;\n        }\n      });\n\n      /** On event \"tokenfield:createdtoken\" : store attributes in input when add a token */\n      $('#form_step3_attributes').on('tokenfield:createdtoken', function(e) {\n        if (e.attrs.data) {\n          $('#attributes-generator').append('<input type=\"hidden\" id=\"attribute-generator-' + e.attrs.value + '\" class=\"attribute-generator\" value=\"' + e.attrs.value + '\" name=\"options[' + e.attrs.data.id_group + '][' + e.attrs.value + ']\" />');\n        } else if (e.handleObj.origType == 'tokenfield:createdtoken') {\n          $('#attributes-generator').append('<input type=\"hidden\" id=\"attribute-generator-' + $('.js-attribute-checkbox[data-value=\"'+e.attrs.value+'\"]').data('value') + '\" class=\"attribute-generator\" value=\"' + $('.js-attribute-checkbox[data-value=\"'+e.attrs.value+'\"]').data('value') + '\" name=\"options[' + $('.js-attribute-checkbox[data-value=\"'+e.attrs.value+'\"]').data('group-id') + '][' + $('.js-attribute-checkbox[data-value=\"'+e.attrs.value+'\"]').data('value') + ']\" />');\n        }\n      });\n\n      /** On event \"tokenfield:removedtoken\" : remove stored attributes input when remove token */\n      $('#form_step3_attributes').on('tokenfield:removedtoken', function(e) {\n        $('#attribute-generator-' + e.attrs.value).remove();\n      });\n    });\n    },\n      'send': function(redirect, target, callBack) {\n      send(redirect, target, callBack);\n    },\n      'switchLanguage': function(iso_code) {\n      switchLanguage(iso_code);\n    }\n  };\n})();\n\n\n/**\n * Custom field collection management\n */\nvar customFieldCollection = (function() {\n\n  var collectionHolder = $('ul.customFieldCollection');\n  var maxCollectionChildren = collectionHolder.children().length;\n\n  /** Add a custom field */\n  function add() {\n    var newForm = collectionHolder.attr('data-prototype').replace(/__name__/g, maxCollectionChildren);\n    maxCollectionChildren += 1;\n    collectionHolder.append('<li>' + newForm + '</li>');\n  }\n\n  return {\n    'init': function() {\n      /** Click event on the add button */\n      $('#custom_fields a.add').on('click', function(e) {\n        e.preventDefault();\n        add();\n      });\n\n      /** Click event on the remove button */\n      $(document).on('click', 'ul.customFieldCollection .delete', function(e) {\n        e.preventDefault();\n        var _this = $(this);\n\n        modalConfirmation.create(translate_javascripts['Are you sure to delete this?'], null, {\n          onContinue: function() {\n            _this.parent().parent().parent().remove();\n          }\n        }).show();\n      });\n    }\n  };\n})();\n\n/**\n * virtual product management\n */\nvar virtualProduct = (function() {\n  var id_product = $('#form_id_product').val();\n\n  var getOnDeleteVirtualProductFileHandler = function ($deleteButton) {\n    return $.ajax({\n      type: 'GET',\n      url: $deleteButton.attr('href').replace(/\\/\\d+(?=\\?.*)/, '/' + id_product),\n      success: function () {\n        $('#form_step3_virtual_product_file_input').removeClass('hide').addClass('show');\n        $('#form_step3_virtual_product_file_details').removeClass('show').addClass('hide');\n      }\n    })\n  };\n\n  return {\n    'init': function() {\n      $(document).on('change', 'input[name=\"form[step3][virtual_product][is_virtual_file]\"]', function() {\n        if ($(this).val() === '1') {\n          $('#virtual_product_content').show();\n        } else {\n          $('#virtual_product_content').hide();\n\n          var url = $('#virtual_product').attr('data-action-remove').replace(/remove\\/\\d+/, 'remove/' + id_product);\n          //delete virtual product\n          $.ajax({\n            type: 'GET',\n            url: url,\n            success: function() {\n              //empty form\n              $('#form_step3_virtual_product_file_input').removeClass('hide').addClass('show');\n              $('#form_step3_virtual_product_file_details').removeClass('show').addClass('hide');\n              $('#form_step3_virtual_product_name').val('');\n              $('#form_step3_virtual_product_nb_downloadable').val(0);\n              $('#form_step3_virtual_product_expiration_date').val('');\n              $('#form_step3_virtual_product_nb_days').val(0);\n            }\n          });\n        }\n      });\n\n      $('#form_step3_virtual_product_file').change(function(e) {\n        if ($(this)[0].files !== undefined) {\n          var files = $(this)[0].files;\n          var name  = '';\n\n          $.each(files, function(index, value) {\n            name += value.name + ', ';\n          });\n          $('#form_step3_virtual_product_name').val(name.slice(0, -2));\n        } else {\n          // Internet Explorer 9 Compatibility\n          var name = $(this).val().split(/[\\\\/]/);\n          $('#form_step3_virtual_product_name').val(name[name.length - 1]);\n        }\n      });\n\n      if ($('input[name=\"form[step3][virtual_product][is_virtual_file]\"]:checked').val() === '1') {\n        $('#virtual_product_content').show();\n      } else {\n        $('#virtual_product_content').hide();\n      }\n\n      /** delete attached file */\n      $('#form_step3_virtual_product_file_details .delete').click(function(e) {\n        e.preventDefault();\n        var $deleteButton = $(this);\n\n        modalConfirmation.create(translate_javascripts['Are you sure to delete this?'], null, {\n          onContinue: function() {\n            getOnDeleteVirtualProductFileHandler($deleteButton);\n          }\n        }).show();\n      });\n\n      /** save virtual product */\n      $('#form_step3_virtual_product_save').click(function() {\n        var _this = $(this);\n        var data = new FormData();\n\n        if ($('#form_step3_virtual_product_file')[0].files[0]) {\n          data.append('product_virtual[file]', $('#form_step3_virtual_product_file')[0].files[0]);\n        }\n        data.append('product_virtual[is_virtual_file]', $('input[name=\"form[step3][virtual_product][is_virtual_file]\"]:checked').val());\n        data.append('product_virtual[name]', $('#form_step3_virtual_product_name').val());\n        data.append('product_virtual[nb_downloadable]', $('#form_step3_virtual_product_nb_downloadable').val());\n        data.append('product_virtual[expiration_date]', $('#form_step3_virtual_product_expiration_date').val());\n        data.append('product_virtual[nb_days]', $('#form_step3_virtual_product_nb_days').val());\n\n        $.ajax({\n          type: 'POST',\n          url: $('#virtual_product').attr('data-action').replace(/save\\/\\d+/, 'save/' + id_product),\n          data: data,\n          contentType: false,\n          processData: false,\n          beforeSend: function() {\n            _this.prop('disabled', 'disabled');\n            $('ul.text-danger').remove();\n            $('*.has-danger').removeClass('has-danger');\n          },\n          success: function(response) {\n            showSuccessMessage(translate_javascripts['Form update success']);\n            if (response.file_download_link) {\n              $('#form_step3_virtual_product_file_details a.download').attr('href', response.file_download_link);\n              $('#form_step3_virtual_product_file_input').removeClass('show').addClass('hide');\n              $('#form_step3_virtual_product_file_details').removeClass('hide').addClass('show');\n            }\n          },\n          error: function(response) {\n            $.each(jQuery.parseJSON(response.responseText), function(key, errors) {\n              var html = '<ul class=\"list-unstyled text-danger\">';\n              $.each(errors, function(key, error) {\n                html += '<li>' + error + '</li>';\n              });\n              html += '</ul>';\n\n              $('#form_step3_virtual_product_' + key).parent().append(html);\n              $('#form_step3_virtual_product_' + key).parent().addClass('has-danger');\n            });\n          },\n          complete: function() {\n            _this.removeAttr('disabled');\n          }\n        });\n      });\n    },\n    'destroy': function () {\n      var fileDetailsSelector = '#form_step3_virtual_product_file_details';\n      var fileAssociationExists = !$(fileDetailsSelector).hasClass('hide');\n\n      if (fileAssociationExists) {\n        var $deleteButton = $(fileDetailsSelector + ' .delete');\n        getOnDeleteVirtualProductFileHandler($deleteButton);\n      }\n\n      var associatedFileCheckboxSelectorPrefix = '#form_step3_virtual_product_is_virtual_file_';\n      $(associatedFileCheckboxSelectorPrefix + '0').prop('checked', false);\n      $(associatedFileCheckboxSelectorPrefix + '1').prop('checked', true);\n\n      $('#virtual_product_content input').val('');\n    }\n  }\n})();\n\n/**\n * attachment product management\n */\nvar attachmentProduct = (function() {\n  var id_product = $('#form_id_product').val();\n\n  return {\n    'init': function() {\n      var buttonSave = $('#form_step6_attachment_product_add');\n      var buttonCancel = $('#form_step6_attachment_product_cancel');\n\n      /** check all attachments files */\n      $('#product-attachment-files-check').change(function() {\n        if ($(this).is(\":checked\")) {\n          $('#product-attachment-file input[type=\"checkbox\"]').prop('checked', true);\n        } else {\n          $('#product-attachment-file input[type=\"checkbox\"]').prop('checked', false);\n        }\n      });\n\n      buttonCancel.click(function (){\n        resetAttachmentForm();\n      });\n\n      function resetAttachmentForm() {\n        $('#form_step6_attachment_product_file').val('');\n        $('#form_step6_attachment_product_name').val('');\n        $('#form_step6_attachment_product_description').val('');\n      }\n\n      function replaceEndingIdFromUrl(url, newId)\n      {\n        return url.replace(/\\/\\d+(?!.*\\/\\d+)((?=\\?.*))?/, '/' + newId);\n      }\n\n      /** add attachment */\n      $('#form_step6_attachment_product_add').click(function() {\n        var _this = $(this);\n        var data = new FormData();\n\n        if ($('#form_step6_attachment_product_file')[0].files[0]) {\n          data.append('product_attachment[file]', $('#form_step6_attachment_product_file')[0].files[0]);\n        }\n        data.append('product_attachment[name]', $('#form_step6_attachment_product_name').val());\n        data.append('product_attachment[description]', $('#form_step6_attachment_product_description').val());\n\n        $.ajax({\n          type: 'POST',\n          url: replaceEndingIdFromUrl($('#form_step6_attachment_product').attr('data-action'), id_product),\n          data: data,\n          contentType: false,\n          processData: false,\n          beforeSend: function() {\n            buttonSave.prop('disabled', 'disabled');\n            $('ul.text-danger').remove();\n            $('*.has-danger').removeClass('has-danger');\n          },\n          success: function(response) {\n            resetAttachmentForm();\n\n            //inject new attachment in attachment list\n            if (response.id) {\n              var row = '<tr>\\\n                <td class=\"col-md-3\"><input type=\"checkbox\" name=\"form[step6][attachments][]\" value=\"' + response.id + '\" checked=\"checked\"> ' + response.real_name + '</td>\\\n                <td class=\"col-md-6\">' + response.file_name + '</td>\\\n                <td class=\"col-md-2\">' + response.mime + '</td>\\\n              </tr>';\n\n              $('#product-attachment-file tbody').append(row);\n              $('.js-options-no-attachments').addClass('hide');\n              $('.js-options-with-attachments').removeClass('hide');\n            }\n          },\n          error: function(response) {\n            $.each(jQuery.parseJSON(response.responseText), function(key, errors) {\n              var html = '<ul class=\"list-unstyled text-danger\">';\n              $.each(errors, function(key, error) {\n                html += '<li>' + error + '</li>';\n              });\n              html += '</ul>';\n\n              $('#form_step6_attachment_product_' + key).parent().append(html);\n              $('#form_step6_attachment_product_' + key).parent().addClass('has-danger');\n            });\n          },\n          complete: function() {\n            buttonSave.removeAttr('disabled');\n          }\n        });\n      });\n    }\n  };\n})();\n\n/**\n * images product management\n */\nvar imagesProduct = (function() {\n  var dropZoneElem = $('#product-images-dropzone');\n  var expanderElem = $('#product-images-container .dropzone-expander');\n\n  function checkDropzoneMode() {\n      if (!dropZoneElem.find('.dz-preview:not(.openfilemanager)').length) {\n        dropZoneElem.removeClass('dz-started');\n        dropZoneElem.find('.dz-preview.openfilemanager').hide();\n      }\n      else {\n          dropZoneElem.find('.dz-preview.openfilemanager').show();\n      }\n  };\n\n  return {\n    'toggleExpand': function() {\n        if (expanderElem.hasClass('expand')) {\n          dropZoneElem.css('height', 'auto');\n          expanderElem.removeClass('expand').addClass('compress');\n        } else {\n          dropZoneElem.css('height', '');\n          expanderElem.removeClass('compress').addClass('expand');\n        }\n    },\n    'displayExpander': function() {\n      expanderElem.show();\n    },\n    'hideExpander': function() {\n      expanderElem.hide();\n    },\n    'shouldDisplayExpander': function () {\n      var oldHeight = dropZoneElem.css('height');\n\n      dropZoneElem.css('height', '');\n      var closedHeight = dropZoneElem.outerHeight();\n      var realHeight = dropZoneElem[0].scrollHeight;\n      dropZoneElem.css('height', oldHeight);\n\n      return (realHeight > closedHeight);\n    },\n    'updateExpander': function() {\n      if (this.shouldDisplayExpander()) {\n        this.displayExpander();\n      }\n    },\n    'initExpander': function() {\n      if (this.shouldDisplayExpander()) {\n        this.displayExpander();\n        expanderElem.addClass('expand');\n      }\n\n      var self = this;\n      $(document).on('click', '#product-images-container .dropzone-expander', function() {\n        self.toggleExpand();\n      });\n    },\n    'init': function() {\n      Dropzone.autoDiscover = false;\n      var errorElem = $('#product-images-dropzone-error');\n\n      //on click image, display custom form\n      $(document).on('click', '#product-images-dropzone .dz-preview', function() {\n        if (!$(this).attr('data-id')) {\n          return;\n        }\n        formImagesProduct.form($(this).attr('data-id'));\n      });\n\n      var dropzoneOptions = {\n        url: dropZoneElem.attr('url-upload'),\n        paramName: 'form[file]',\n        maxFilesize: dropZoneElem.attr('data-max-size'),\n        addRemoveLinks: true,\n        clickable: '.openfilemanager',\n        thumbnailWidth: 250,\n        thumbnailHeight: null,\n        acceptedFiles: 'image/*',\n        timeout: 0,\n        dictRemoveFile: translate_javascripts['Delete'],\n        dictFileTooBig: translate_javascripts['ToLargeFile'],\n        dictCancelUpload: translate_javascripts['Delete'],\n        sending: function(file, response) {\n          checkDropzoneMode();\n          expanderElem.addClass('expand').click();\n          errorElem.html('');\n        },\n        queuecomplete: function() {\n          checkDropzoneMode();\n          dropZoneElem.sortable('enable');\n          imagesProduct.updateExpander();\n        },\n        processing: function() {\n          dropZoneElem.sortable('disable');\n        },\n        success: function(file, response) {\n          //manage error on uploaded file\n          if (response.error !== 0) {\n            errorElem.append($('<p></p>').text(file.name + ': ' + response.error));\n            this.removeFile(file);\n            return;\n          }\n\n          //define id image to file preview\n          $(file.previewElement).attr('data-id', response.id);\n          $(file.previewElement).attr('url-update', response.url_update);\n          $(file.previewElement).attr('url-delete', response.url_delete);\n          $(file.previewElement).addClass('ui-sortable-handle');\n          if (response.cover === 1) {\n            imagesProduct.updateDisplayCover(response.id);\n          }\n        },\n        error: function(file, response) {\n          var message = '';\n          if ($.type(response) === 'undefined') {\n            return;\n          } else if ($.type(response) === 'string') {\n            message = response;\n          } else if (response.message) {\n            message = response.message;\n          }\n\n          if (message === '') {\n            return;\n          }\n\n          //append new error\n          errorElem.append($('<p></p>').text(file.name + ': ' + message));\n\n          //remove uploaded item\n          this.removeFile(file);\n        },\n        init: function() {\n          //if already images uploaded, mask drop file message\n          if (dropZoneElem.find('.dz-preview:not(.openfilemanager)').length) {\n            dropZoneElem.addClass('dz-started');\n          } else {\n            dropZoneElem.find('.dz-preview.openfilemanager').hide();\n          }\n\n          //init sortable\n          dropZoneElem.sortable({\n            items: \"div.dz-preview:not(.disabled)\",\n            opacity: 0.9,\n            containment: 'parent',\n            distance: 32,\n            tolerance: 'pointer',\n            cursorAt: {\n              left: 64,\n              top: 64\n            },\n            cancel: '.disabled',\n            stop: function(event, ui) {\n              var sort = {};\n              $.each(dropZoneElem.find('.dz-preview:not(.disabled)'), function(index, value) {\n                if (!$(value).attr('data-id')) {\n                  sort = false;\n                  return;\n                }\n                sort[$(value).attr('data-id')] = index + 1;\n              });\n\n              //if sortable ok, update it\n              if (sort) {\n                $.ajax({\n                  type: 'POST',\n                  url: dropZoneElem.attr('url-position'),\n                  data: {\n                    json: JSON.stringify(sort)\n                  }\n                });\n              }\n            },\n            start: function(event, ui) {\n              //init zindex\n              dropZoneElem.find('.dz-preview').css('zIndex', 1);\n              ui.item.css('zIndex', 10);\n            }\n          });\n\n          dropZoneElem.disableSelection();\n          imagesProduct.initExpander();\n        }\n      };\n\n      dropZoneElem.dropzone(jQuery.extend(dropzoneOptions));\n    },\n    'updateDisplayCover': function(id_image) {\n      $('#product-images-dropzone .dz-preview .iscover').remove();\n      $('#product-images-dropzone .dz-preview[data-id=\"' + id_image + '\"]')\n        .append('<div class=\"iscover\">' + translate_javascripts['Cover'] + '</div>');\n    },\n    'checkDropzoneMode': function() {\n      checkDropzoneMode();\n    },\n    'getOlderImageId': function() {\n      return Math.min.apply(Math,$('.dz-preview').map(function(){\n        return $(this).data('id');\n      }));\n    }\n  };\n})();\n\n\nvar formImagesProduct = (function() {\n  var dropZoneElem = $('#product-images-dropzone');\n  var formZoneElem = $('#product-images-form-container');\n\n  formZoneElem.magnificPopup({\n    delegate: 'a.open-image',\n    type: 'image'\n  });\n\n  function toggleColDropzone(enlarge) {\n      var smallCol = \"col-md-8\";\n      var largeCol = \"col-md-12\";\n      if (true === enlarge) {\n          dropZoneElem.removeClass(smallCol).addClass(largeCol);\n      } else {\n          dropZoneElem.removeClass(largeCol).addClass(smallCol);\n      }\n  }\n\n  return {\n    'form': function(id) {\n      dropZoneElem.find(\".dz-preview.active\").removeClass(\"active\");\n      dropZoneElem.find(\".dz-preview[data-id='\"+id+\"']\").addClass(\"active\");\n      if(imagesProduct.shouldDisplayExpander() == false){\n        dropZoneElem.css('height','auto');\n      }\n      $.ajax({\n        url: dropZoneElem.find(\".dz-preview[data-id='\"+id+\"']\").attr('url-update'),\n        success: function(response) {\n          formZoneElem.find('#product-images-form').html(response);\n          form.switchLanguage($('#form_switch_language').val());\n        },\n        complete: function() {\n          toggleColDropzone(false);\n          formZoneElem.show();\n        }\n      });\n    },\n    'send': function(id) {\n      $.ajax({\n        type: 'POST',\n        url: dropZoneElem.find(\".dz-preview[data-id='\"+id+\"']\").attr('url-update'),\n        data: formZoneElem.find('textarea, input').serialize(),\n        beforeSend: function() {\n          formZoneElem.find('.actions button').prop('disabled', 'disabled');\n          formZoneElem.find('ul.text-danger').remove();\n          formZoneElem.find('*.has-danger').removeClass('has-danger');\n        },\n        success: function() {\n          if (formZoneElem.find('#form_image_cover:checked').length) {\n            imagesProduct.updateDisplayCover(id);\n          }\n        },\n        error: function(response) {\n          if (response && response.responseText) {\n            $.each(jQuery.parseJSON(response.responseText), function(key, errors) {\n              var html = '<ul class=\"list-unstyled text-danger\">';\n              $.each(errors, function(key, error) {\n                html += '<li>' + error + '</li>';\n              });\n              html += '</ul>';\n\n              $('#form_image_' + key).parent().append(html);\n              $('#form_image_' + key).parent().addClass('has-danger');\n            });\n          }\n        },\n        complete: function() {\n          formZoneElem.find('.actions button').removeAttr('disabled');\n        }\n      });\n    },\n    'delete': function(id) {\n      modalConfirmation.create(translate_javascripts['Are you sure to delete this?'], null, {\n        onContinue: function() {\n          $.ajax({\n            url: dropZoneElem.find('.dz-preview[data-id=\"' + id + '\"]').attr('url-delete'),\n            complete: function() {\n              formZoneElem.find('.close').click();\n              var wasCover = !!dropZoneElem.find('.dz-preview[data-id=\"' + id + '\"] .iscover').length;\n              dropZoneElem.find('.dz-preview[data-id=\"' + id + '\"]').remove();\n              $('.images .product-combination-image [value=' + id + ']').parent().remove();\n              imagesProduct.checkDropzoneMode();\n              if (true === wasCover) {\n                // The controller will choose the oldest image as the new cover.\n                imagesProduct.updateDisplayCover(imagesProduct.getOlderImageId());\n              }\n            }\n          });\n        }\n      }).show();\n    },\n    'close': function() {\n      toggleColDropzone(true);\n      dropZoneElem.css('height','');\n      formZoneElem.find('#product-images-form').html('');\n      formZoneElem.hide();\n      dropZoneElem.find(\".dz-preview.active\").removeClass(\"active\");\n    }\n  };\n})();\n\n/**\n * Price calculation\n */\nvar priceCalculation = (function() {\n  var priceHTElem = $('#form_step2_price');\n  var priceHTShortcutElem = $('#form_step1_price_shortcut');\n  var priceTTCElem = $('#form_step2_price_ttc');\n  var priceTTCShorcutElem = $('#form_step1_price_ttc_shortcut');\n  var ecoTaxElem = $('#form_step2_ecotax');\n  var taxElem = $('#form_step2_id_tax_rules_group');\n  var reTaxElem = $('#step2_id_tax_rules_group_rendered');\n  var displayPricePrecision = priceHTElem.attr('data-display-price-precision');\n  var ecoTaxRate = ecoTaxElem.attr('data-eco-tax-rate');\n\n  /**\n   * Add taxes to a price\n   * @param {Number} price - Price without tax\n   * @param {Number[]} rates - Rates to apply\n   * @param {Number} computationMethod The computation calculate method\n   */\n  function addTaxes(price, rates, computationMethod) {\n    var price_with_taxes = price;\n\n    var i = 0;\n    if (computationMethod === '0') {\n      for (i in rates) {\n        price_with_taxes *= (1.00 + parseFloat(rates[i]) / 100.00);\n        break;\n      }\n    } else if (computationMethod === '1') {\n      var rate = 0;\n      for (i in rates) {\n        rate += rates[i];\n      }\n      price_with_taxes *= (1.00 + parseFloat(rate) / 100.00);\n    } else if (computationMethod === '2') {\n      for (i in rates) {\n        price_with_taxes *= (1.00 + parseFloat(rates[i]) / 100.00);\n      }\n    }\n\n    return price_with_taxes;\n  }\n\n  /**\n   * Remove taxes from a price\n   * @param {Number} price - Price with tax\n   * @param {Number[]} rates - Rates to apply\n   * @param {Number} computationMethod - The computation method\n   */\n  function removeTaxes(price, rates, computationMethod) {\n    var i = 0;\n    if (computationMethod === '0') {\n      for (i in rates) {\n        price /= (1 + rates[i] / 100);\n        break;\n      }\n    } else if (computationMethod === '1') {\n      var rate = 0;\n      for (i in rates) {\n        rate += rates[i];\n      }\n      price /= (1 + rate / 100);\n    } else if (computationMethod === '2') {\n      for (i in rates) {\n        price /= (1 + rates[i] / 100);\n      }\n    }\n\n    return price;\n  }\n\n  /**\n   *\n   * @return {Number}\n   */\n  function getEcotaxTaxIncluded() {\n    var displayPrecision = 6;\n    var ecoTax = Tools.parseFloatFromString(ecoTaxElem.val());\n\n    if (isNaN(ecoTax)) {\n      ecoTax = 0;\n    }\n\n    if (ecoTax === 0) {\n      return ecoTax;\n    }\n    var ecotaxTaxExcl = ecoTax / (1 + ecoTaxRate);\n\n    return ps_round(ecotaxTaxExcl * (1 + ecoTaxRate), displayPrecision);\n  }\n\n  function getEcotaxTaxExcluded() {\n    return Tools.parseFloatFromString(ecoTaxElem.val()) / (1 + ecoTaxRate);\n  }\n\n  return {\n\n    init: function () {\n      /** on update tax recalculate tax include price */\n      taxElem.change(function() {\n        if (reTaxElem.val() !== taxElem.val()) {\n          reTaxElem.val(taxElem.val()).trigger('change');\n        }\n\n        priceCalculation.taxInclude();\n        priceTTCElem.change();\n      });\n\n      reTaxElem.change(function() {\n        taxElem.val(reTaxElem.val()).trigger('change');\n      });\n\n      /** update without tax price and shortcut price field on change */\n      $('#form_step1_price_shortcut, #form_step2_price').keyup(function() {\n        var price = priceCalculation.normalizePrice($(this).val());\n\n        if ($(this).attr('id') === 'form_step1_price_shortcut') {\n          $('#form_step2_price').val(price).change();\n        } else {\n          $('#form_step1_price_shortcut').val(price).change();\n        }\n\n        priceCalculation.taxInclude();\n      });\n\n      /** update HT price and shortcut price field on change */\n      $('#form_step1_price_ttc_shortcut, #form_step2_price_ttc').keyup(function() {\n        var price = priceCalculation.normalizePrice($(this).val());\n\n        if ($(this).attr('id') === 'form_step1_price_ttc_shortcut') {\n          $('#form_step2_price_ttc').val(price).change();\n        } else {\n          $('#form_step1_price_ttc_shortcut').val(price).change();\n        }\n\n        priceCalculation.taxExclude();\n      });\n\n      /** on price change, update final retails prices */\n      $('#form_step2_price, #form_step2_price_ttc').change(function() {\n        var taxExcludedPrice = priceCalculation.normalizePrice($('#form_step2_price').val());\n        var taxIncludedPrice = priceCalculation.normalizePrice($('#form_step2_price_ttc').val());\n\n        formatCurrencyCldr(taxExcludedPrice, function(result) {\n          $('#final_retail_price_te').text(result);\n        });\n        formatCurrencyCldr(taxIncludedPrice, function(result) {\n          $('#final_retail_price_ti').text(result);\n        });\n      });\n\n      /** update HT price and shortcut price field on change */\n      $('#form_step2_ecotax').keyup(function() {\n        priceCalculation.taxExclude();\n      });\n\n      /** combinations : update TTC price field on change */\n      $(document).on('keyup', '.combination-form .attribute_priceTE', function() {\n        priceCalculation.impactTaxInclude($(this));\n        priceCalculation.impactFinalPrice($(this));\n      });\n      /** combinations : update HT price field on change */\n      $(document).on('keyup', '.combination-form .attribute_priceTI', function() {\n        priceCalculation.impactTaxExclude($(this));\n      });\n      /** combinations : update wholesale price, unity and price TE field on blur */\n      $(document).on('blur','.combination-form .attribute_wholesale_price,.combination-form .attribute_unity,.combination-form .attribute_priceTE', function(){\n        $(this).val(priceCalculation.normalizePrice($(this).val()));\n      });\n\n      priceCalculation.taxInclude();\n\n      $('#form_step2_price, #form_step2_price_ttc').change();\n    },\n\n    /**\n     * Converts a price string into a number\n     * @param {String} price\n     * @return {Number}\n     */\n    normalizePrice: function (price) {\n      return Tools.parseFloatFromString(price, true);\n    },\n\n    /**\n     * Adds taxes to a price\n     * @param {Number} price Price without taxes\n     * @return {Number} Price with added taxes\n     */\n    addCurrentTax: function (price) {\n      var rates = this.getRates();\n      var computation_method = taxElem.find('option:selected').attr('data-computation-method');\n      var priceWithTaxes = Number(ps_round(addTaxes(price, rates, computation_method), displayPricePrecision));\n      var ecotaxIncluded = Number(getEcotaxTaxIncluded());\n\n      return priceWithTaxes + ecotaxIncluded;\n    },\n\n    /**\n     * Calculates the price with taxes and updates the elements containing it\n     */\n    taxInclude: function () {\n      var newPrice = truncateDecimals(this.addCurrentTax(this.normalizePrice(priceHTElem.val())), 6);\n\n      priceTTCElem.val(newPrice).change();\n      priceTTCShorcutElem.val(newPrice).change();\n    },\n\n    /**\n     * Removes taxes from a price\n     * @param {Number} price Price with taxes\n     * @return {Number} Price without taxes\n     */\n    removeCurrentTax: function (price) {\n      var rates = this.getRates();\n      var computation_method = taxElem.find('option:selected').attr('data-computation-method');\n\n      return ps_round(removeTaxes(ps_round(price - getEcotaxTaxIncluded(), displayPricePrecision), rates, computation_method), displayPricePrecision);\n    },\n\n    /**\n     * Calculates the price without taxes and updates the elements containing it\n     */\n    taxExclude: function () {\n      var newPrice = truncateDecimals(this.removeCurrentTax(this.normalizePrice(priceTTCElem.val())), 6);\n\n      priceHTElem.val(newPrice).change();\n      priceHTShortcutElem.val(newPrice).change();\n    },\n\n    /**\n     * Calculates and displays the impact on price (including tax) for a combination\n     * @param {jQuery} obj\n     */\n    impactTaxInclude: function (obj) {\n      var price = Tools.parseFloatFromString(obj.val());\n      var targetInput = obj.closest('div[id^=\"combination_form_\"]').find('input.attribute_priceTI');\n      var newPrice = 0;\n\n      if (!isNaN(price)) {\n        var rates = this.getRates();\n        var computation_method = taxElem.find('option:selected').attr('data-computation-method');\n        newPrice = ps_round(addTaxes(price, rates, computation_method), 6);\n        newPrice = truncateDecimals(newPrice, 6);\n      }\n\n      targetInput\n        .val(newPrice)\n        .trigger('change')\n      ;\n    },\n\n    /**\n     * Calculates and displays the final price for a combination\n     * @param {jQuery} obj\n     */\n    impactFinalPrice: function (obj) {\n      var price = this.normalizePrice(obj.val());\n      var finalPrice = obj.closest('div[id^=\"combination_form_\"]').find('.final-price');\n      var defaultFinalPrice = finalPrice.attr('data-price');\n      var priceToBeChanged = Number(price) + Number(defaultFinalPrice);\n      priceToBeChanged = truncateDecimals(priceToBeChanged, 6);\n\n      finalPrice.html(priceToBeChanged);\n    },\n\n    /**\n     * Calculates and displays the impact on price (excluding tax) for a combination\n     * @param {jQuery} obj\n     */\n    impactTaxExclude: function (obj) {\n      var price = Tools.parseFloatFromString(obj.val());\n      var targetInput = obj.closest('div[id^=\"combination_form_\"]').find('input.attribute_priceTE');\n      var newPrice = 0;\n\n      if (!isNaN(price)) {\n        var rates = this.getRates();\n        var computation_method = taxElem.find('option:selected').attr('data-computation-method');\n        newPrice = removeTaxes(ps_round(price, displayPricePrecision), rates, computation_method);\n        newPrice = truncateDecimals(newPrice, 6);\n      }\n\n      targetInput\n        .val(newPrice)\n        .trigger('change')\n      ;\n    },\n\n    /**\n     * Returns the tax rates that apply\n     * @return {Number[]}\n     */\n    getRates: function () {\n      return taxElem\n        .find('option:selected')\n        .attr('data-rates')\n        .split(',')\n        .map(function(rate) {\n          return Tools.parseFloatFromString(rate, true);\n        });\n    }\n  };\n})();\n\n/**\n * Manage seo\n */\nvar seo = (function() {\n  var redirectTypeElem = $('#form_step5_redirect_type');\n  var productRedirect = $('#id-product-redirected');\n\n  /** Hide or show the input product selector */\n  function hideShowRedirectToProduct() {\n    if ('404' === redirectTypeElem.val()) {\n      $('#id-product-redirected').hide();\n    } else {\n      updateRemoteUrl();\n      $('#id-product-redirected').show();\n    }\n  }\n\n  function updateRemoteUrl() {\n    switch(redirectTypeElem.val()) {\n      case '301-category':\n      case '302-category':\n        productRedirect.find('label').html(redirectTypeElem.attr('data-labelcategory'));\n        productRedirect.find('input').attr('placeholder', redirectTypeElem.attr('data-placeholdercategory'));\n        productRedirect.find('.typeahead-hint').text(redirectTypeElem.attr('data-hintcategory'));\n        break;\n      default:\n        productRedirect.find('label').html(redirectTypeElem.attr('data-labelproduct'));\n        productRedirect.find('input').attr('placeholder', redirectTypeElem.attr('data-placeholderproduct'));\n        productRedirect.find('.typeahead-hint').text('');\n    }\n\n    productRedirect.find('.autocomplete-search').attr('data-remoteurl', redirectTypeElem.find('option:selected').data('remoteurl'));\n    productRedirect.find('.autocomplete-search').trigger('buildTypeahead');\n  }\n\n  /** Update friendly URL */\n  var updateFriendlyUrl = function(elem) {\n      /** Attr name equals \"form[step1][name][1]\".\n       * We need in this string the second integer */\n      var id_lang = elem.attr('name').match(/\\d+/g)[1];\n      $('#form_step5_link_rewrite_' + id_lang).val(str2url(elem.val(), 'UTF-8'));\n  };\n\n  return {\n    'init': function() {\n\n      hideShowRedirectToProduct();\n      updateRemoteUrl();\n\n      /** On redirect type select change */\n      redirectTypeElem.change(function() {\n        productRedirect.find('#form_step5_id_type_redirected-data').html('');\n        hideShowRedirectToProduct();\n      });\n\n      /** On product title change, update friendly URL*/\n      $('#form_step1_names.friendly-url-force-update input').keyup(function() {\n        updateFriendlyUrl($(this));\n      });\n\n      /** Reset all languages title to friendly url*/\n      $('#seo-url-regenerate').click(function() {\n        $.each($('#form_step1_names input'), function() {\n          updateFriendlyUrl($(this));\n        });\n      });\n    },\n    'onSave': function() {\n        // check all friendly URLs have been filled. If not, fill them.\n        $('input[id^=\"form_step5_link_rewrite_\"]', \"#form_step5_link_rewrite\").each(function(){\n            var elem = $(this);\n            if (0 === elem.val().length) {\n                var id_lang = elem.attr('name').match(/\\d+/g)[1];\n                updateFriendlyUrl($('#form_step1_name_' + id_lang));\n            }\n        });\n    }\n  };\n})();\n\n/**\n * Tags management\n */\nvar tags = (function() {\n  return {\n    'init': function() {\n      $('#form_step6_tags .tokenfield').tokenfield({\n        minWidth: '768px'\n      });\n    }\n  };\n})();\n\nvar recommendedModules = (function() {\n  return {\n    'init': function() {\n      this.moduleActionMenuLinkSelectors = 'button.module_action_menu_install, button.module_action_menu_enable, ' +\n        'button.module_action_menu_uninstall, button.module_action_menu_disable, button.module_action_menu_reset, button.module_action_menu_update';\n      $(this.moduleActionMenuLinkSelectors).on('module_card_action_event', this.saveProduct);\n    },\n    'saveProduct': function(event, action) {\n      form.send();\n    }\n  };\n})();\n"], "filenames": ["admin-dev/themes/default/js/bundle/product/form.js"], "buggy_code_start_loc": [1342], "buggy_code_end_loc": [1372], "fixing_code_start_loc": [1342], "fixing_code_end_loc": [1372], "type": "CWE-79", "message": "In PrestaShop from version 1.7.0.0 and before version 1.7.6.6, if a target sends a corrupted file, it leads to a reflected XSS. The problem is fixed in 1.7.6.6", "other": {"cve": {"id": "CVE-2020-15083", "sourceIdentifier": "security-advisories@github.com", "published": "2020-07-02T17:15:12.437", "lastModified": "2020-07-02T18:17:53.847", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "In PrestaShop from version 1.7.0.0 and before version 1.7.6.6, if a target sends a corrupted file, it leads to a reflected XSS. The problem is fixed in 1.7.6.6"}, {"lang": "es", "value": "En PrestaShop desde versi\u00f3n 1.7.0.0 y anteriores a versi\u00f3n 1.7.6.6, si un objetivo env\u00eda un archivo corrupto, esto conlleva a una vulnerabilidad de tipo XSS reflejado. El problema es corregido en versi\u00f3n 1.7.6.6"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}, {"source": "security-advisories@github.com", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:H/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "HIGH", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 4.7, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 1.6, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}, {"source": "security-advisories@github.com", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:prestashop:prestashop:*:*:*:*:*:*:*:*", "versionStartExcluding": "1.7.0.0", "versionEndExcluding": "1.7.6.6", "matchCriteriaId": "26C7FAF8-70EA-40CC-BDEC-8E8091E33190"}]}]}], "references": [{"url": "https://github.com/PrestaShop/PrestaShop/commit/bac749bf75a4e0d6312a70b37eb5b0a556f08fbd", "source": "security-advisories@github.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/PrestaShop/PrestaShop/security/advisories/GHSA-qgh4-95j7-p3vj", "source": "security-advisories@github.com", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/PrestaShop/PrestaShop/commit/bac749bf75a4e0d6312a70b37eb5b0a556f08fbd"}}