{"buggy_code": ["<?php\n/**\n * A collection of common generic functions used throughout the application.\n *\n * @author The phpLDAPadmin development team\n * @package phpLDAPadmin\n */\n\n/**\n * @package phpLDAPadmin\n * @subpackage Functions\n */\n\n/**\n */\ndefine('HTDOCDIR',sprintf('%s/',realpath(LIBDIR.'../htdocs/')));\ndefine('LANGDIR',sprintf('%s/',realpath(LIBDIR.'../locale/')));\ndefine('CONFDIR',sprintf('%s/',realpath(LIBDIR.'../config')));\ndefine('QUERYDIR',sprintf('%s/',realpath(LIBDIR.'../queries/')));\ndefine('TMPLDIR',sprintf('%s/',realpath(LIBDIR.'../templates/')));\ndefine('DOCDIR',sprintf('%s/',realpath(LIBDIR.'../doc/')));\ndefine('HOOKSDIR',sprintf('%s/',realpath(LIBDIR.'../hooks/')));\ndefine('JSDIR','js/');\n\n/**\n * Supplimental functions\n * This list is a list of supplimental functions that are used throughout\n * PLA. The order here IS important - so that files that refer to\n * functions defined in other files need to be listed after those files.\n */\n$app['function_files'] = array(\n\t# Functions for managing the session (app_session_start(), etc.)\n\tLIBDIR.'session_functions.php',\n\t# Functions for reading the server schema\n\tLIBDIR.'schema_functions.php',\n\t# Functions for template manipulation.\n\tLIBDIR.'template_functions.php',\n\t# Functions for hashing passwords with OpenSSL binary (only if mhash not present)\n\tLIBDIR.'emuhash_functions.php',\n\t# Functions for creating Samba passwords\n\tLIBDIR.'createlm.php',\n\t# Datasource functions\n\tLIBDIR.'ds.php',\n\t# Functions for rendering the page\n\tLIBDIR.'page.php'\n);\n\nif (file_exists(LIBDIR.'functions.custom.php'))\n\tarray_push($app['function_files'],LIBDIR.'functions.custom.php');\n\n/**\n * Loads class definition\n */\nfunction pla_autoload($className) {\n\tif (file_exists(HOOKSDIR.\"classes/$className.php\"))\n\t\trequire_once(HOOKSDIR.\"classes/$className.php\");\n\telseif (file_exists(LIBDIR.\"$className.php\"))\n\t\trequire_once(LIBDIR.\"$className.php\");\n\telseif (file_exists(LIBDIR.\"ds_$className.php\"))\n\t\trequire_once(LIBDIR.\"ds_$className.php\");\n\telse\n\t\tsystem_message(array(\n\t\t\t'title'=>_('Generic Error'),\n\t\t\t'body'=>sprintf('%s: %s [%s]',\n\t\t\t\t__METHOD__,_('Called to load a class that cant be found'),$className),\n\t\t\t'type'=>'error'));\n}\n\nif (version_compare(phpversion(), '7.0', '>=')) {\n\tspl_autoload_register('pla_autoload');\n} else {\n\teval('function __autoload($className) {pla_autoload($className);}');\n}\n\n/**\n * Strips all slashes from the specified array in place (pass by ref).\n * @param Array The array to strip slashes from, typically one of\n *        $_GET, $_POST, or $_COOKIE.\n */\nfunction array_stripslashes(&$array) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\tif (is_array($array))\n\t\twhile (list($key) = each($array))\n\t\t\tif (is_array($array[$key]) && $key != $array)\n\t\t\t\tarray_stripslashes($array[$key]);\n\t\t\telse\n\t\t\t\t$array[$key] = stripslashes($array[$key]);\n}\n\n/**\n * Compatibility Functions\n * These functions exist, so that a standard function can be used in new applications, and they\n * map to already defined functions in older applications.\n */\n\n/**\n * If gettext is not available in PHP, then this will provide compatibility for it.\n */\nif (! function_exists('_')) {\n\tfunction _($msg) {\n\t\treturn $msg;\n\t}\n}\n\n/**\n * Generic Utility Functions\n */\n\n/**\n * Custom error handling function.\n * When a PHP error occurs, PHP will call this function rather than printing\n * the typical PHP error string. This provides the application the ability to\n * format an error message so that it looks better.\n * Optionally, it can present a link so that a user can search/submit bugs.\n * This function is not to be called directly. It is exclusively for the use of\n * PHP internally. If this function is called by PHP from within a context\n * where error handling has been disabled (ie, from within a function called\n * with \"@\" prepended), then this function does nothing.\n *\n * @param int The PHP error number that occurred (ie, E_ERROR, E_WARNING, E_PARSE, etc).\n * @param string The PHP error string provided (ie, \"Warning index \"foo\" is undefined)\n * @param string The file in which the PHP error ocurred.\n * @param int The line number on which the PHP error ocurred\n * @see set_error_handler\n */\nfunction app_error_handler($errno,$errstr,$file,$lineno) {\n\tif (defined('DEBUG_ENABLED') && DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t/**\n\t * error_reporting will be 0 if the error context occurred\n\t * within a function call with '@' preprended (ie, @ldap_bind() );\n\t * So, don't report errors if the caller has specifically\n\t * disabled them with '@'\n\t */\n\tif (ini_get('error_reporting') == 0 || error_reporting() == 0)\n\t\treturn;\n\n\t$file = basename($file);\n\t$caller = basename($_SERVER['PHP_SELF']);\n\t$errtype = '';\n\n\tswitch ($errno) {\n\t\tcase E_STRICT: $errtype = 'E_STRICT'; break;\n\t\tcase E_ERROR: $errtype = 'E_ERROR'; break;\n\t\tcase E_WARNING: $errtype = 'E_WARNING'; break;\n\t\tcase E_PARSE: $errtype = 'E_PARSE'; break;\n\t\tcase E_NOTICE: $errtype = 'E_NOTICE'; break;\n\t\tcase E_CORE_ERROR: $errtype = 'E_CORE_ERROR'; break;\n\t\tcase E_CORE_WARNING: $errtype = 'E_CORE_WARNING'; break;\n\t\tcase E_COMPILE_ERROR: $errtype = 'E_COMPILE_ERROR'; break;\n\t\tcase E_COMPILE_WARNING: $errtype = 'E_COMPILE_WARNING'; break;\n\t\tcase E_USER_ERROR: $errtype = 'E_USER_ERROR'; break;\n\t\tcase E_USER_WARNING: $errtype = 'E_USER_WARNING'; break;\n\t\tcase E_USER_NOTICE: $errtype = 'E_USER_NOTICE'; break;\n\t\tcase E_ALL: $errtype = 'E_ALL'; break;\n\n\t\tdefault: $errtype = sprintf('%s: %s',_('Unrecognized error number'),$errno);\n\t}\n\n\t# Take out extra spaces in error strings.\n\t$errstr = preg_replace('/\\s+/',' ',$errstr);\n\n\tif ($errno == E_NOTICE) {\n\t\t$body = '<table class=\"notice\">';\n\t\t$body .= sprintf('<tr><td>%s:</td><td><b>%s</b> (<b>%s</b>)</td></tr>',_('Error'),$errstr,$errtype);\n\t\t$body .= sprintf('<tr><td>%s:</td><td><b>%s</b> %s <b>%s</b>, %s <b>%s</b></td></tr>',\n\t\t\t_('File'),$file,_('line'),$lineno,_('caller'),$caller);\n\t\t$body .= sprintf('<tr><td>Versions:</td><td>PLA: <b>%s</b>, PHP: <b>%s</b>, SAPI: <b>%s</b></td></tr>',\n\t\t\tapp_version(),phpversion(),php_sapi_name());\n\t\t$body .= sprintf('<tr><td>Web server:</td><td><b>%s</b></td></tr>',isset($_SERVER['SERVER_SOFTWARE']) ? $_SERVER['SERVER_SOFTWARE'] : 'SCRIPT');\n\n\t\tif (function_exists('get_href'))\n\t\t\t$body .= sprintf('<tr><td colspan=\"2\"><a href=\"%s\" onclick=\"target=\\'_blank\\';\"><center>%s.</center></a></td></tr>',\n\t\t\t\tget_href('search_bug',\"&summary_keyword=\".rawurlencode($errstr)),\n\t\t\t\t_('Please check and see if this bug has been reported'));\n\t\t$body .= '</table>';\n\n\t\tsystem_message(array(\n\t\t\t'title'=>_('You found a non-fatal phpLDAPadmin bug!'),\n\t\t\t'body'=>$body,\n\t\t\t'type'=>'error'));\n\n\t\treturn;\n\t}\n\n\t# If this is a more serious error, call the error call.\n\terror(sprintf('%s: %s',$errtype,$errstr),'error',null,true,true);\n}\n\n/**\n * Returns the application name.\n */\nfunction app_name() {\n\treturn 'phpLDAPadmin';\n}\n\n/**\n * Returns the application version currently running. The version\n * is read from the file named VERSION.\n *\n * @return string The current version as read from the VERSION file.\n */\nfunction app_version() {\n\tstatic $CACHE = null;\n\n\tif ($CACHE)\n\t\treturn $CACHE;\n\n\t$version_file = realpath(LIBDIR.'../VERSION');\n\tif (! file_exists($version_file))\n\t\t$CACHE = 'UNKNOWN';\n\n\telse {\n\t\t$version = rtrim(file_get_contents($version_file));\n\n\t\t$CACHE = preg_replace('/^RELEASE-([0-9\\.]+(-.*)*)$/','$1',$version);\n\n\t\t# Check if we are a CVS copy.\n\t\tif (preg_match('/^(DEVEL)?$/',$CACHE))\n\t\t\t$CACHE = 'DEVEL';\n\n\t\t# Check if we are special DEVEL version\n\t\telseif (preg_match('/^DEVEL-([0-9\\.]+)+$/',$CACHE)) {}\n\n\t\t# If return is still the same as version, then the tag is not one we expect.\n\t\telseif ($CACHE == $version)\n\t\t\t$CACHE = 'UNKNOWN';\n\t}\n\n\treturn $CACHE;\n}\n\n/**\n * This function will convert the browser two character language into the\n * default 5 character language, where the country portion should NOT be\n * assumed to be upper case characters of the first two characters.\n */\nfunction auto_lang($lang) {\n\tswitch ($lang) {\n\t\tcase 'ja': return 'ja_JP';\n\t\tcase 'cs': return 'cs_CZ';\n\t\tdefault: return sprintf('%s_%s',$lang,strtoupper($lang));\n\t}\n}\n\n/**\n * Makes sure that the config file is properly setup.\n */\nfunction check_config($config_file) {\n\t# Read in config_default.php\n\trequire_once LIBDIR.'config_default.php';\n\n\t# Make sure their PHP version is current enough\n\tif (strcmp(phpversion(),REQUIRED_PHP_VERSION) < 0)\n\t\tsystem_message(array(\n\t\t\t'title'=>_('Incorrect version of PHP'),\n\t\t\t'body'=>sprintf('phpLDAPadmin requires PHP version %s or greater.<br /><small>(You are using %s)</small>',\n\t\t\t\tREQUIRED_PHP_VERSION,phpversion()),\n\t\t\t'type'=>'error'));\n\n\t$config = new Config;\n\n\tif (file_exists(LIBDIR.'config_custom.php') && is_readable(LIBDIR.'config_custom.php'))\n\t\tinclude LIBDIR.'config_custom.php';\n\n\tob_start();\n\trequire $config_file;\n\t$str = '';\n\tif (ob_get_level()) {\n\t\t$str = ob_get_contents();\n\t\tob_end_clean();\n\t}\n\n\tif ($str) {\n\t\t$str = strip_tags($str);\n\t\t$matches = array();\n\t\tpreg_match('/(.*):\\s+(.*):.*\\s+on line (\\d+)/',$str,$matches);\n\n\t\tif (isset($matches[1]) && isset($matches[2]) && isset($matches[3])) {\n\t\t\t$error_type = $matches[1];\n\t\t\t$error = $matches[2];\n\t\t\t$line_num = $matches[3];\n\n\t\t\t$file = file($config_file);\n\n\t\t\t$body = '<h3 class=\"title\">Config file ERROR</h3>';\n\t\t\t$body .= sprintf('<h3 class=\"subtitle\">%s (%s) on line %s</h3>',$error_type,$error,$line_num);\n\n\t\t\t$body .= '<center>';\n\t\t\t$body .= sprintf('Looks like your config file has an ERROR on line %s.<br />',$line_num);\n\t\t\t$body .= 'Here is a snippet around that line <br />';\n\t\t\t$body .= '<br />'.\"\\n\";\n\n\t\t\t$body .= '<div style=\"text-align: left; font-family: monospace; margin-left: 80px; margin-right: 80px; border: 1px solid black; padding: 10px;\">';\n\n\t\t\tfor ($i = $line_num-9; $i<$line_num+5; $i++) {\n\t\t\t\tif ($i+1 == $line_num)\n\t\t\t\t\t$body .= '<div style=\"color:red;background:#fdd\">';\n\n\t\t\t\tif ($i < 0)\n\t\t\t\t\tcontinue;\n\n\t\t\t\t$body .= sprintf('<b>%s</b>: %s<br />',$i+1,$file[$i]);\n\n\t\t\t\tif ($i+1 == $line_num)\n\t\t\t\t\t$body .= '</div>';\n\t\t\t}\n\n\t\t\t$body .= '</div>';\n\t\t\t$body .= '<br />';\n\t\t\t$body .= 'Hint: Sometimes these errors are caused by lines <b>preceding</b> the line reported.';\n\t\t\t$body .= '</center>';\n\n\t\t\t$block = new block();\n\t\t\t$block->SetBody($body);\n\t\t\t$www['page'] = new page();\n\t\t\t$www['page']->block_add('body',$block);\n\t\t\t$www['page']->display();\n\n\t\t\tdie();\n\t\t}\n\t}\n\n\t# Check for server definitions.\n\tif (! isset($servers) || count($servers->GetServerList()) == 0)\n\t\terror(_('Your config.php is missing Server Definitions. Please see the sample file config/config.php.example.'),'error','index.php',true);\n\n\t$config->setServers($servers);\n\n\t# Check the memory limit parameter.\n\tif ((ini_get('memory_limit') > -1) && ini_get('memory_limit') < $config->getValue('session','memorylimit'))\n\t\tsystem_message(array(\n\t\t\t'title'=>_('Memory Limit low.'),\n\t\t\t'body'=>sprintf('Your php memory limit is low - currently %s, you should increase it to atleast %s. This is normally controlled in /etc/php.ini.',\n\t\t\t\tini_get('memory_limit'),$config->getValue('session','memorylimit')),\n\t\t\t'type'=>'error'));\n\n\treturn $config;\n}\n\n/**\n * Commands available in the control_panel of the page\n *\n * @return array\n */\nfunction cmd_control_pane($type) {\n\tif (defined('DEBUG_ENABLED') && DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\tswitch ($type) {\n\t\tcase 'main' :\n\t\t\treturn array(\n\t\t\t\t'home'=>array(\n\t\t\t\t\t'title'=>_('Home'),\n\t\t\t\t\t'enable'=>true,\n\t\t\t\t\t'link'=>sprintf('href=\"index.php\" title=\"%s\"',_('Home')),\n\t\t\t\t\t'image'=>sprintf('<img src=\"%s/home-big.png\" alt=\"%s\" />',IMGDIR,_('Home'))),\n\n\t\t\t\t'purge'=>array(\n\t\t\t\t\t'title'=>_('Purge caches'),\n\t\t\t\t\t'enable'=>isset($_SESSION[APPCONFIG]) ? $_SESSION[APPCONFIG]->isCommandAvailable('script','purge_cache') : false,\n\t\t\t\t\t'link'=>sprintf('href=\"cmd.php?cmd=purge_cache\" onclick=\"return ajDISPLAY(\\'BODY\\',\\'cmd=purge_cache\\',\\'%s\\');\" title=\"%s\"',\n\t\t\t\t\t\t_('Clearing cache'),_('Purge caches')),\n\t\t\t\t\t'image'=>sprintf('<img src=\"%s/trash-big.png\" alt=\"%s\" />',IMGDIR,_('Purge caches'))),\n\n\t\t\t\t'hide_debug_info'=>array(\n\t\t\t\t\t'title'=>_('Show Cache'),\n\t\t\t\t\t'enable'=>isset($_SESSION[APPCONFIG]) ? ($_SESSION[APPCONFIG]->isCommandAvailable('script','show_cache')) && (! $_SESSION[APPCONFIG]->getValue('appearance','hide_debug_info')) : false,\n\t\t\t\t\t'link'=>sprintf('href=\"cmd.php?cmd=show_cache\" onclick=\"return ajDISPLAY(\\'BODY\\',\\'cmd=show_cache\\',\\'%s\\');\" title=\"%s\"',\n\t\t\t\t\t\t_('Loading'),_('Show Cache'),_('Show Cache')),\n\t\t\t\t\t'image'=>sprintf('<img src=\"%s/debug-cache.png\" alt=\"%s\" />',IMGDIR,_('Show Cache'))),\n\t\t\t);\n\n\t\t\tbreak;\n\n\t\tcase 'top' :\n\t\t\treturn array(\n\t\t\t\t'forum'=>array(\n\t\t\t\t\t'title'=>_('Forum'),\n\t\t\t\t\t'enable'=>isset($_SESSION[APPCONFIG]) ? $_SESSION[APPCONFIG]->isCommandAvailable('cmd','oslinks') : true,\n\t\t\t\t\t'link'=>sprintf('href=\"%s\" title=\"%s\" onclick=\"target=\\'_blank\\';\"',get_href('forum'),_('Forum')),\n\t\t\t\t\t'image'=>sprintf('<img src=\"%s/forum-big.png\" alt=\"%s\" />',IMGDIR,_('Forum'))),\n\n\t\t\t\t'feature'=>array(\n\t\t\t\t\t'title'=>_('Request feature'),\n\t\t\t\t\t'enable'=>isset($_SESSION[APPCONFIG]) ? $_SESSION[APPCONFIG]->isCommandAvailable('cmd','oslinks') : true,\n\t\t\t\t\t'link'=>sprintf('href=\"%s\" title=\"%s\" onclick=\"target=\\'_blank\\';\"',get_href('add_rfe'),_('Request feature')),\n\t\t\t\t\t'image'=>sprintf('<img src=\"%s/request-feature-big.png\" alt=\"%s\" />',IMGDIR,_('Request feature'))),\n\n\t\t\t\t'bug'=>array(\n\t\t\t\t\t'title'=>_('Report a bug'),\n\t\t\t\t\t'enable'=>isset($_SESSION[APPCONFIG]) ? $_SESSION[APPCONFIG]->isCommandAvailable('cmd','oslinks') : true,\n\t\t\t\t\t'link'=>sprintf('href=\"%s\" title=\"%s\" onclick=\"target=\\'_blank\\';\"',get_href('add_bug'),_('Report a bug')),\n\t\t\t\t\t'image'=>sprintf('<img src=\"%s/bug-big.png\" alt=\"%s\" />',IMGDIR,_('Report a bug'))),\n\n\t\t\t\t'donation'=>array(\n\t\t\t\t\t'title'=>_('Donate'),\n\t\t\t\t\t'enable'=>isset($_SESSION[APPCONFIG]) ? $_SESSION[APPCONFIG]->isCommandAvailable('cmd','oslinks') : true,\n\t\t\t\t\t'link'=>sprintf('href=\"%s\" title=\"%s\" onclick=\"target=\\'_blank\\';\"',get_href('donate'),_('Donate')),\n\t\t\t\t\t'image'=>sprintf('<img src=\"%s/smile-big.png\" alt=\"%s\" />',IMGDIR,_('Donate'))),\n\n\t\t\t\t'help'=>array(\n\t\t\t\t\t'title'=>_('Help'),\n\t\t\t\t\t'enable'=>isset($_SESSION[APPCONFIG]) ? $_SESSION[APPCONFIG]->isCommandAvailable('cmd','oslinks') : true,\n\t\t\t\t\t'link'=>sprintf('href=\"%s\" title=\"%s\" onclick=\"target=\\'_blank\\';\"',get_href('documentation'),_('Help')),\n\t\t\t\t\t'image'=>sprintf('<img src=\"%s/help-big.png\" alt=\"%s\" />',IMGDIR,_('Help')))\n\t\t\t);\n\n\t\t\tbreak;\n\t}\n}\n\n/**\n * This function dumps the $variable for debugging purposes\n *\n * @param string|array Variable to dump\n * @param boolean Whether to stop execution or not.\n */\nfunction debug_dump($variable,$die=false,$onlydebugaddr=false) {\n\tif ($onlydebugaddr &&\n\t\tisset($_SESSION[APPCONFIG]) && $_SESSION[APPCONFIG]->getValue('debug','addr') &&\n\t\t$_SERVER['HTTP_X_FORWARDED_FOR'] != $_SESSION[APPCONFIG]->getValue('debug','addr') &&\n\t\t$_SERVER['REMOTE_ADDR'] != $_SESSION[APPCONFIG]->getValue('debug','addr'))\n\t\treturn;\n\n\t$backtrace = debug_backtrace();\n\t$caller['class'] = isset($backtrace[0]['class']) ? $backtrace[0]['class'] : 'N/A';\n\t$caller['function'] = isset($backtrace[0]['function']) ? $backtrace[0]['function'] : 'N/A';\n\t$caller['file'] = isset($backtrace[0]['file']) ? $backtrace[0]['file'] : 'N/A';\n\t$caller['line'] = isset($backtrace[0]['line']) ? $backtrace[0]['line'] : 'N/A';\n\t$caller['debug'] = $variable;\n\n\tprint '<PRE>';\n\tprint_r($caller);\n\tprint '</PRE>';\n\n\tif ($die)\n\t\tdie();\n}\n\n/**\n * This function generates a backtrace\n *\n * @param boolean Whether to stop execution or not.\n */\nfunction debug_dump_backtrace($msg='Calling BackTrace',$die=false) {\n\terror($msg,'note',null,$die,true);\n}\n\n/**\n * Send a debug as a sys message\n */\nfunction debug_sysmsg($msg) {\n\tsystem_message(array('title'=>_('Debug'),'body'=>$msg,'type'=>'debug'));\n}\n\n/**\n * Debug Logging\n *\n * The global debug level is turned on in your configuration file by setting:\n * <code>\n *\t$config->custom->debug['level'] = 255;\n * </code>\n * together with atleast one output direction (currently file and syslog are supported).\n * <code>\n *\t$config->custom->debug['file'] = '/tmp/app_debug.log';\n *\t$config->custom->debug['syslog'] = true;\n * </code>\n *\n * The debug level is turned into binary, then if the message levels bit is on\n * the message will be sent to the debug log. (Thus setting your debug level to 255,\n * all bits on, will results in all messages being printed.)\n *\n * The message level bits are defined here.\n *  0(  1) = Entry/Return results from function calls.\n *  1(  2) = Configuration Processing\n *  2(  4) = Template Processing\n *  3(  8) = Schema Processing\n *  4( 16) = LDAP Server Communication\n *  5( 32) = Tree Processing\n *  7( 64) = Other non generic messages\n *  8(128) = Page Processing\n *  9(256) = Hooks Processing\n * @param string Message to send to syslog\n * @param int Log bit number for this message.\n * @see syslog.php\n */\nfunction debug_log($msg,$level,$indent) {\n\tstatic $debug_file;\n\n\t# In case we are called before we are fully initialised or if debugging is not set.\n\tif (! isset($_SESSION[APPCONFIG])\n\t\t|| ! ($_SESSION[APPCONFIG]->getValue('debug','file') || $_SESSION[APPCONFIG]->getValue('debug','syslog')))\n\t\treturn;\n\n\t$debug_level = $_SESSION[APPCONFIG]->getValue('debug','level');\n\tif (! $debug_level || (! ($level & $debug_level)))\n\t\treturn;\n\n\tif ($_SESSION[APPCONFIG]->getValue('debug','addr'))\n\t\tif (isset($_SERVER['HTTP_X_FORWARDED_FOR']) && $_SERVER['HTTP_X_FORWARDED_FOR'] == $_SESSION[APPCONFIG]->getValue('debug','addr'))\n\t\t\t$debugaddr = true;\n\t\telseif ($_SERVER['REMOTE_ADDR'] == $_SESSION[APPCONFIG]->getValue('debug','addr'))\n\t\t\t$debugaddr = true;\n\t\telse\n\t\t\t$debugaddr = false;\n\n\telse\n\t\t$debugaddr = true;\n\n\tif (! $debugaddr)\n\t\treturn;\n\n\t# If we are limiting debug to a browser, then check that\n\t$caller = basename($_SERVER['PHP_SELF']);\n\n\t$args = func_get_args();\n\t# Discard our first three arguments.\n\tarray_shift($args);\n\tarray_shift($args);\n\tarray_shift($args);\n\n\t# Pull the file/line/method\n\tif (is_string($args[0]) && preg_match('/.php$/',$args[0])) {\n\t\t$file = preg_replace('/.php$/','',array_shift($args));\n\t\t$line = array_shift($args);\n\t\t$method = array_shift($args);\n\n\t} else {\n\t\t$file = 'UNKNOWN';\n\t\t$line = 'UNKNOWN';\n\t\t$method = 'UNKNOWN';\n\t}\n\n\t# TEMP: New debuglog format\n\tif (preg_match('/%%/',$msg) && $args[0] != 'NOARGS')\n\t\t$args = array_shift($args);\n\n\t$fargs = array();\n\tforeach ($args as $key) {\n\t\tif (is_array($key))\n\t\t\tarray_push($fargs,serialize($key));\n\t\telseif (is_object($key))\n\t\t\tarray_push($fargs,sprintf('OBJECT:%s',get_class($key)));\n\t\telse\n\t\t\tarray_push($fargs,$key);\n\t}\n\n\tif (preg_match('/%%/',$msg))\n\t\t$msg = preg_replace('/%%/',join('|',$fargs),$msg);\n\telse\n\t\t$msg = vsprintf($msg,array_values($fargs));\n\n\tif (function_exists('stopwatch'))\n\t\t$timer = stopwatch();\n\telse\n\t\t$timer = null;\n\n\t$debug_message = sprintf('[%2.3f] %15s(%04s-%03s): %s%s: %s',$timer,basename($file),$line,$level,str_repeat('.',$indent),$method,substr($msg,0,200));\n\n\tif ($debug_file || $_SESSION[APPCONFIG]->getValue('debug','file')) {\n\t\tif (! $debug_file)\n\t\t\t$debug_file = fopen($_SESSION[APPCONFIG]->getValue('debug','file'),\n\t\t\t\t$_SESSION[APPCONFIG]->getValue('debug','append') ? 'a' : 'w');\n\n\t\tfwrite($debug_file,$debug_message.\"\\n\");\n\t}\n\n\tif ($_SESSION[APPCONFIG]->getValue('debug','syslog') && function_exists('syslog_notice'))\n\t\tsyslog_notice($debug_message);\n}\n\n/**\n * Display an error message in the system message panel of the page.\n */\nfunction error($msg,$type='note',$redirect=null,$fatal=false,$backtrace=false) {\n\tglobal $www;\n\tstatic $counter;\n\n\t# Just a check to see that we are called right.\n\tif (! isset($www['page']) && ! $fatal)\n\t\tdie(\"Function error called incorrectly [$msg]\");\n\n\t# If the error is fatal, we'll need to stop here.\n\tif (! isset($www['page']))\n\t\t$www['page'] = new page();\n\n\tif ($fatal)\n\t\t$www['page']->setsysmsg(array('title'=>_('Error'),'body'=>$msg,'type'=>$type));\n\telse\n\t\tsystem_message(array('title'=>_('Error'),'body'=>$msg,'type'=>$type),$redirect);\n\n\t# Spin loop detection\n\tif ($counter++ > 20) {\n\t\tdebug_dump('Spin loop detection.');\n\t\tdebug_dump(array('msg'=>$msg,'session'=>$_SESSION['sysmsg'],'www'=>$www),1);\n\t}\n\n\t# Do we have a backtrace to display?\n\tif ($backtrace) {\n\t\t$backtraceblock = new block();\n\t\t$backtraceblock->SetTitle('PHP Debug Backtrace');\n\n\t\t$body = '<table class=\"result_table\">';\n\t\t$body .= \"\\n\";\n\n\t\tforeach (debug_backtrace() as $error => $line) {\n\t\t\t$_SESSION['backtrace'][$error]['file'] = isset($line['file']) ? $line['file'] : 'unknown';\n\t\t\t$_SESSION['backtrace'][$error]['line'] = isset($line['line']) ? $line['line'] : 'unknown';\n\t\t\t$body .= sprintf('<tr class=\"hightlight\"><td colspan=\"2\"><b><small>%s</small></b></td><td>%s (%s)</td></tr>',\n\t\t\t\t_('File'),isset($line['file']) ? $line['file'] : $last['file'],isset($line['line']) ? $line['line'] : '');\n\n\t\t\t$_SESSION['backtrace'][$error]['function'] = $line['function'];\n\t\t\t$body .= sprintf('<tr><td>&nbsp;</td><td><b><small>%s</small></b></td><td><small>%s',\n\t\t\t\t_('Function'),$line['function']);\n\n\t\t\tif (isset($line['args'])) {\n\t\t\t\t$display = strlen(serialize($line['args'])) < 50 ? htmlspecialchars(serialize($line['args'])) : htmlspecialchars(substr(serialize($line['args']),0,50)).'...<TRUNCATED>';\n\t\t\t\t$_SESSION['backtrace'][$error]['args'] = $line['args'];\n\t\t\t\tif (file_exists(LIBDIR.'../tools/unserialize.php'))\n\t\t\t\t\t$body .= sprintf('&nbsp;(<a href=\"%s?index=%s\" onclick=\"target=\\'backtrace\\';\">%s</a>)',\n\t\t\t\t\t\t'../tools/unserialize.php',$error,$display);\n\t\t\t\telse\n\t\t\t\t\t$body .= sprintf('&nbsp;(%s)',$display);\n\t\t\t}\n\t\t\t$body .= '</small></td></tr>';\n\t\t\t$body .= \"\\n\";\n\n\t\t\tif (isset($line['file']))\n\t\t\t\t$last['file'] = $line['file'];\n\t\t}\n\n\t\t$body .= '</table>';\n\t\t$body .= \"\\n\";\n\t\t$backtraceblock->SetBody($body);\n\n\t\t$www['page']->block_add('body',$backtraceblock);\n\t}\n\n\tif ($fatal) {\n\t\t$www['page']->display(array('tree'=>false));\n\t\tdie();\n\t}\n}\n\n/**\n * Return the result of a form variable, with optional default\n *\n * @return The form GET/REQUEST/SESSION/POST variable value or its default\n */\nfunction get_request($attr,$type='POST',$die=false,$default=null,$preventXSS=false) {\n\tswitch($type) {\n\t\tcase 'GET':\n\t\t\t$value = isset($_GET[$attr]) ? (is_array($_GET[$attr]) ? $_GET[$attr] : (empty($_GET['nodecode'][$attr]) ? rawurldecode($_GET[$attr]) : $_GET[$attr])) : $default;\n\t\t\tbreak;\n\n\t\tcase 'REQUEST':\n\t\t\t$value = isset($_REQUEST[$attr]) ? (is_array($_REQUEST[$attr]) ? $_REQUEST[$attr] : (empty($_REQUEST['nodecode'][$attr]) ? rawurldecode($_REQUEST[$attr]) : $_REQUEST[$attr])) : $default;\n\t\t\tbreak;\n\n\t\tcase 'SESSION':\n\t\t\t$value = isset($_SESSION[$attr]) ? (is_array($_SESSION[$attr]) ? $_SESSION[$attr] : (empty($_SESSION['nodecode'][$attr]) ? rawurldecode($_SESSION[$attr]) : $_SESSION[$attr])) : $default;\n\t\t\tbreak;\n\n\t\tcase 'POST':\n\t\tdefault:\n\t\t\t$value = isset($_POST[$attr]) ? (is_array($_POST[$attr]) ? $_POST[$attr] : (empty($_POST['nodecode'][$attr]) ? rawurldecode($_POST[$attr]) : $_POST[$attr])) : $default;\n\t\t\tbreak;\n\t}\n\t\n\tif ($die && is_null($value))\n\t\tsystem_message(array(\n\t\t\t'title'=>_('Generic Error'),\n\t\t\t'body'=>sprintf('%s: Called \"%s\" without \"%s\" using \"%s\"',\n\t\t\t\tbasename($_SERVER['PHP_SELF']),get_request('cmd','REQUEST',false,null,true),preventXSS($attr),preventXSS($type)),\n\t\t\t'type'=>'error'),\n\t\t\t'index.php');\n\tif($preventXSS && !is_null($value))\n\t\t$value = preventXSS($value);\n\treturn $value;\n}\n/**\n*  Prevent XSS function. This function can usage has preventXSS(get_request('cmd','REQUEST'))\n*  Return valor escape XSS.\n*/\nfunction preventXSS($value){\n\treturn htmlspecialchars(addslashes($value), ENT_QUOTES, 'UTF-8');\n}\n\n * Record a system message.\n * This function can be used as an alternative to generate a system message, if page hasnt yet been defined.\n */\nfunction system_message($msg,$redirect=null) {\n\tif (! is_array($msg))\n\t\treturn null;\n\n\tif (! isset($msg['title']) && ! isset($msg['body']))\n\t\treturn null;\n\n\tif (! isset($msg['type']))\n\t\t$msg['type'] = 'info';\n\n\tif (! isset($_SESSION['sysmsg']) || ! is_array($_SESSION['sysmsg']))\n\t\t$_SESSION['sysmsg'] = array();\n\n\t# Try and detect if we are in a redirect loop\n\tif (get_request('redirect','GET') && $msg['type'] != 'debug') {\n\t\tforeach ($_SESSION['sysmsg'] as $detail) {\n\t\t\tif ($msg == $detail && ! isset($detail['special'])) {\n\t\t\t\tdebug_dump(array('Incoming MSG'=>$msg,'existing'=>$_SESSION['sysmsg']));\n\t\t\t\tdebug_dump_backtrace('Redirect Loop Detected',true);\n\t\t\t}\n\t\t}\n\t}\n\n\tarray_push($_SESSION['sysmsg'],$msg);\n\n\tif ($redirect) {\n\t\tif (preg_match('/\\?/',$redirect))\n\t\t\t$redirect .= '&';\n\t\telse\n\t\t\t$redirect .= '?';\n\t\t$redirect .= 'redirect=true';\n\n\t\t# Check if we were an ajax request, and only render the ajax message\n\t\tif (get_request('meth','REQUEST') == 'ajax')\n\t\t\t$redirect .= '&meth=ajax';\n\n\t\theader(\"Location: $redirect\");\n\t\tdie();\n\t}\n}\n\n/**\n * Other Functions\n */\n\n/**\n * Encryption using blowfish algorithm\n *\n * @param string Original data\n * @param string The secret\n * @return string The encrypted result\n * @author lem9 (taken from the phpMyAdmin source)\n */\nfunction blowfish_encrypt($data,$secret=null) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t# If our secret is null or blank, get the default.\n\tif ($secret === null || ! trim($secret))\n\t\t$secret = $_SESSION[APPCONFIG]->getValue('session','blowfish') ? $_SESSION[APPCONFIG]->getValue('session','blowfish') : session_id();\n\n\t# If the secret isnt set, then just return the data.\n\tif (! trim($secret))\n\t\treturn $data;\n\n\tif (! empty($data) && function_exists('openssl_encrypt') && in_array('bf-ecb', openssl_get_cipher_methods())) {\n\t\t$keylen = openssl_cipher_iv_length('bf-ecb') * 2;\n\t\treturn openssl_encrypt($data, 'bf-ecb', substr($secret,0,$keylen));\n\t}\n\n\tif (function_exists('mcrypt_module_open') && ! empty($data)) {\n\t\t$td = mcrypt_module_open(MCRYPT_BLOWFISH,'',MCRYPT_MODE_ECB,'');\n\t\t$iv = mcrypt_create_iv(mcrypt_enc_get_iv_size($td),MCRYPT_DEV_URANDOM);\n\t\tmcrypt_generic_init($td,substr($secret,0,mcrypt_enc_get_key_size($td)),$iv);\n\t\t$encrypted_data = base64_encode(mcrypt_generic($td,$data));\n\t\tmcrypt_generic_deinit($td);\n\n\t\treturn $encrypted_data;\n\t}\n\n\tif (file_exists(LIBDIR.'blowfish.php'))\n\t\trequire_once LIBDIR.'blowfish.php';\n\telse\n\t\treturn $data;\n\n\t$pma_cipher = new Horde_Cipher_blowfish;\n\t$encrypt = '';\n\n\tfor ($i=0; $i<strlen($data); $i+=8) {\n\t\t$block = substr($data, $i, 8);\n\n\t\tif (strlen($block) < 8)\n\t\t\t$block = full_str_pad($block,8,\"\\0\", 1);\n\n\t\t$encrypt .= $pma_cipher->encryptBlock($block, $secret);\n\t}\n\n\treturn base64_encode($encrypt);\n}\n\n/**\n * Decryption using blowfish algorithm\n *\n * @param string Encrypted data\n * @param string The secret\n * @return string Original data\n * @author lem9 (taken from the phpMyAdmin source)\n */\nfunction blowfish_decrypt($encdata,$secret=null) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t# This cache gives major speed up for stupid callers :)\n\tstatic $CACHE = array();\n\n\tif (isset($CACHE[$encdata]))\n\t\treturn $CACHE[$encdata];\n\n\t# If our secret is null or blank, get the default.\n\tif ($secret === null || ! trim($secret))\n\t\t$secret = $_SESSION[APPCONFIG]->getValue('session','blowfish') ? $_SESSION[APPCONFIG]->getValue('session','blowfish') : session_id();\n\n\t# If the secret isnt set, then just return the data.\n\tif (! trim($secret))\n\t\treturn $encdata;\n\n\tif (! empty($encdata) && function_exists('openssl_encrypt') && in_array('bf-ecb', openssl_get_cipher_methods())) {\n\t\t$keylen = openssl_cipher_iv_length('bf-ecb') * 2;\n\t\treturn trim(openssl_decrypt($encdata, 'bf-ecb', substr($secret,0,$keylen)));\n\t}\n\n\tif (function_exists('mcrypt_module_open') && ! empty($encdata)) {\n\t\t$td = mcrypt_module_open(MCRYPT_BLOWFISH,'',MCRYPT_MODE_ECB,'');\n\t\t$iv = mcrypt_create_iv(mcrypt_enc_get_iv_size($td),MCRYPT_DEV_URANDOM);\n\t\tmcrypt_generic_init($td,substr($secret,0,mcrypt_enc_get_key_size($td)),$iv);\n\t\t$decrypted_data = trim(mdecrypt_generic($td,base64_decode($encdata)));\n\t\tmcrypt_generic_deinit($td);\n\n\t\treturn $decrypted_data;\n\t}\n\n\tif (file_exists(LIBDIR.'blowfish.php'))\n\t\trequire_once LIBDIR.'blowfish.php';\n\telse\n\t\treturn $encdata;\n\n\t$pma_cipher = new Horde_Cipher_blowfish;\n\t$decrypt = '';\n\t$data = base64_decode($encdata);\n\n\tfor ($i=0; $i<strlen($data); $i+=8)\n\t\t$decrypt .= $pma_cipher->decryptBlock(substr($data, $i, 8), $secret);\n\n\t// Strip off our \\0's that were added.\n\t$return = preg_replace(\"/\\\\0*$/\",'',$decrypt);\n\t$CACHE[$encdata] = $return;\n\treturn $return;\n}\n\n/**\n * String padding\n *\n * @param string Input string\n * @param integer Length of the result\n * @param string The filling string\n * @param integer Padding mode\n * @return string The padded string\n */\nfunction full_str_pad($input,$pad_length,$pad_string='',$pad_type=0) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$str = '';\n\t$length = $pad_length - strlen($input);\n\n\tif ($length > 0) { // str_repeat doesn't like negatives\n\t\tif ($pad_type == STR_PAD_RIGHT) { // STR_PAD_RIGHT == 1\n\t\t\t$str = $input.str_repeat($pad_string, $length);\n\t\t} elseif ($pad_type == STR_PAD_BOTH) { // STR_PAD_BOTH == 2\n\t\t\t$str = str_repeat($pad_string, floor($length/2));\n\t\t\t$str .= $input;\n\t\t\t$str .= str_repeat($pad_string, ceil($length/2));\n\t\t} else { // defaults to STR_PAD_LEFT == 0\n\t\t\t$str = str_repeat($pad_string, $length).$input;\n\t\t}\n\n\t} else { // if $length is negative or zero we don't need to do anything\n\t\t$str = $input;\n\t}\n\treturn $str;\n}\n\n/**\n * Returns the cached array of LDAP resources.\n *\n * Note that internally, this function utilizes a two-layer cache,\n * one in memory using a static variable for multiple calls within\n * the same page load, and one in a session for multiple calls within\n * the same user session (spanning multiple page loads).\n *\n * @return Returns the cached attributed requested,\n *         or null if there is nothing cached..\n */\nfunction get_cached_item($index,$item,$subitem='null') {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t# Set default return\n\t$return = null;\n\n\t# Check config to make sure session-based caching is enabled.\n\tif ($_SESSION[APPCONFIG]->getValue('cache',$item) && isset($_SESSION['cache'][$index][$item][$subitem]))\n\t\t$return = $_SESSION['cache'][$index][$item][$subitem];\n\n\tif (DEBUG_ENABLED)\n\t\tdebug_log('Returning (%s)',1,0,__FILE__,__LINE__,__METHOD__,$return);\n\n\treturn $return;\n}\n\n/**\n * Caches the specified $item for the specified $index.\n *\n * Returns true on success of false on failure.\n */\nfunction set_cached_item($index,$item,$subitem='null',$data) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t# Check config to make sure session-based caching is enabled.\n\tif ($_SESSION[APPCONFIG]->getValue('cache',$item)) {\n\t\tglobal $CACHE;\n\n\t\t$CACHE[$index][$item][$subitem] = $data;\n\t\t$_SESSION['cache'][$index][$item][$subitem] = $data;\n\n\t\treturn true;\n\n\t} else\n\t\treturn false;\n}\n\n/**\n * Deletes the cache for a specified $item for the specified $index\n */\nfunction del_cached_item($index,$item,$subitem='null') {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\tglobal $CACHE;\n\n\t# Check config to make sure session-based caching is enabled.\n\tif (isset($_SESSION['cache'][$index][$item][$subitem]))\n\t\tunset($_SESSION['cache'][$index][$item][$subitem]);\n\n\tif (isset($CACHE[$index][$item][$subitem]))\n\t\tunset($CACHE[$index][$item][$subitem]);\n}\n\n/**\n * Utility wrapper for setting cookies, which takes into consideration\n * application configuration values. On success, true is returned. On\n * failure, false is returned.\n *\n * @param string The name of the cookie to set.\n * @param string The value of the cookie to set.\n * @param int (optional) The duration in seconds of this cookie. If unspecified, $cookie_time is used from config.php\n * @param string (optional) The directory value of this cookie (see php.net/setcookie)\n * @return boolean\n */\nfunction set_cookie($name,$val,$expire=null,$dir=null) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t# Set default return\n\t$return = false;\n\n\tif ($expire == null) {\n\t\t$cookie_time = $_SESSION[APPCONFIG]->getValue('session','cookie_time');\n\t\t$expire = $cookie_time == 0 ? null : time() + $cookie_time;\n\t}\n\n\tif ($dir == null)\n\t\t$dir = dirname($_SERVER['PHP_SELF']);\n\n\tif (@setcookie($name,$val,$expire,$dir)) {\n\t\t$_COOKIE[$name] = $val;\n\t\t$return = true;\n\t}\n\n\tif (DEBUG_ENABLED)\n\t\tdebug_log('Returning (%s)',1,0,__FILE__,__LINE__,__METHOD__,$return);\n\n\treturn $return;\n}\n\n/**\n * Get a customized file for a server\n * We don't need any caching, because it's done by PHP\n *\n * @param int The ID of the server\n * @param string The requested filename\n *\n * @return string The customized filename, if exists, or the standard one\n */\nfunction get_custom_file($index,$filename,$path) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t# Set default return\n\t$return = $path.$filename;\n\t$server = $_SESSION[APPCONFIG]->getServer($index);\n\n\t$custom = $server->getValue('custom','pages_prefix');\n\tif (! is_null($custom) && is_file(realpath($path.$custom.$filename)))\n\t\t$return = $path.$custom.$filename;\n\n\tif (DEBUG_ENABLED)\n\t\tdebug_log('Returning (%s)',1,0,__FILE__,__LINE__,__METHOD__,$return);\n\n\treturn $return;\n}\n\n/**\n * Replacement for create_function() which is deprecated as of php 7.2\n *\n * @param string The function arguments\n * @param string The function code\n */\nfunction pla_create_function($args, $code) {\n\tif (version_compare(phpversion(),'7.0','>=')) {\n\t\t# anonymous functions were introduced in PHP 5.3.0\n\t\treturn eval(\"return function(\".$args.\"){\".$code.\"};\");\n\n\t} else {\n\t\t# create_function is deprecated in php 7.2\n\t\treturn create_function($args, $code);\n\t}\n}\n\n/**\n * Sort a multi dimensional array.\n *\n * @param array Multi demension array passed by reference\n * @param string Comma delimited string of sort keys.\n * @param boolean Whether to reverse sort.\n * @return array Sorted multi demension array.\n */\nfunction masort(&$data,$sortby,$rev=0) {\n\tif (defined('DEBUG_ENABLED') && DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t# if the array to sort is null or empty, or if we have some nasty chars\n\tif (! preg_match('/^[a-zA-Z0-9_]+(\\([a-zA-Z0-9_,]*\\))?$/',$sortby) || ! $data)\n\t\treturn;\n\n\tstatic $CACHE = array();\n\n\tif (empty($CACHE[$sortby])) {\n\t\t$code = \"\\$c=0;\\n\";\n\n\t\tforeach (explode(',',$sortby) as $key) {\n\t\t\t$code .= \"if (is_object(\\$a) || is_object(\\$b)) {\\n\";\n\n\t\t\t$code .= \"\tif (is_array(\\$a->$key)) {\\n\";\n\t\t\t$code .= \"\t\tasort(\\$a->$key);\\n\";\n\t\t\t$code .= \"\t\t\\$aa = array_shift(\\$a->$key);\\n\";\n\t\t\t$code .= \"\t} else\\n\";\n\t\t\t$code .= \"\t\t\\$aa = \\$a->$key;\\n\";\n\n\t\t\t$code .= \"\tif (is_array(\\$b->$key)) {\\n\";\n\t\t\t$code .= \"\t\tasort(\\$b->$key);\\n\";\n\t\t\t$code .= \"\t\t\\$bb = array_shift(\\$b->$key);\\n\";\n\t\t\t$code .= \"\t} else\\n\";\n\t\t\t$code .= \"\t\t\\$bb = \\$b->$key;\\n\";\n\n\t\t\t$code .= \"\tif (\\$aa != \\$bb)\";\n\t\t\tif ($rev)\n\t\t\t\t$code .= \"\treturn (\\$aa < \\$bb ? 1 : -1);\\n\";\n\t\t\telse\n\t\t\t\t$code .= \"\treturn (\\$aa > \\$bb ? 1 : -1);\\n\";\n\n\t\t\t$code .= \"} else {\\n\";\n\n\t\t\t$code .= \"\t\\$a = array_change_key_case(\\$a);\\n\";\n\t\t\t$code .= \"\t\\$b = array_change_key_case(\\$b);\\n\";\n\n\t\t\t$key = strtolower($key);\n\n\t\t\t$code .= \"\tif ((! isset(\\$a['$key'])) && isset(\\$b['$key'])) return 1;\\n\";\n\t\t\t$code .= \"\tif (isset(\\$a['$key']) && (! isset(\\$b['$key']))) return -1;\\n\";\n\n\t\t\t$code .= \"\tif ((isset(\\$a['$key'])) && (isset(\\$b['$key']))) {\\n\";\n\t\t\t$code .= \"\t\tif (is_array(\\$a['$key'])) {\\n\";\n\t\t\t$code .= \"\t\t\tasort(\\$a['$key']);\\n\";\n\t\t\t$code .= \"\t\t\t\\$aa = array_shift(\\$a['$key']);\\n\";\n\t\t\t$code .= \"\t\t} else\\n\";\n\t\t\t$code .= \"\t\t\t\\$aa = \\$a['$key'];\\n\";\n\n\t\t\t$code .= \"\t\tif (is_array(\\$b['$key'])) {\\n\";\n\t\t\t$code .= \"\t\t\tasort(\\$b['$key']);\\n\";\n\t\t\t$code .= \"\t\t\t\\$bb = array_shift(\\$b['$key']);\\n\";\n\t\t\t$code .= \"\t\t} else\\n\";\n\t\t\t$code .= \"\t\t\t\\$bb = \\$b['$key'];\\n\";\n\n\t\t\t$code .= \"\t\tif (\\$aa != \\$bb)\\n\";\n\t\t\t$code .= \"\t\t\tif (is_numeric(\\$aa) && is_numeric(\\$bb)) {\\n\";\n\n\t\t\tif ($rev)\n\t\t\t\t$code .= \"\t\t\t\treturn (\\$aa < \\$bb ? 1 : -1);\\n\";\n\t\t\telse\n\t\t\t\t$code .= \"\t\t\t\treturn (\\$aa > \\$bb ? 1 : -1);\\n\";\n\n\t\t\t$code .= \"\t\t\t} else {\\n\";\n\n\t\t\tif ($rev)\n\t\t\t\t$code .= \"\t\t\t\tif ( (\\$c = strcasecmp(\\$bb,\\$aa)) != 0 ) return \\$c;\\n\";\n\t\t\telse\n\t\t\t\t$code .= \"\t\t\t\tif ( (\\$c = strcasecmp(\\$aa,\\$bb)) != 0 ) return \\$c;\\n\";\n\n\t\t\t$code .= \"\t\t}\\n\";\n\t\t\t$code .= \"\t}\\n\";\n\t\t\t$code .= \"}\\n\";\n\t\t}\n\n\t\t$code .= 'return $c;';\n\n\t\t$CACHE[$sortby] = pla_create_function('$a, $b',$code);\n\t}\n\n\tuasort($data,$CACHE[$sortby]);\n}\n\n/**\n * Is compression enabled for output\n */\nfunction isCompress() {\n\treturn (isset($_SESSION[APPCONFIG]) && $_SESSION[APPCONFIG]->getValue('appearance','compress')\n\t\t&& ! ini_get('zlib.output_compression')\n\t\t&& preg_match('/gzip/',$_SERVER['HTTP_ACCEPT_ENCODING']));\n}\n\n/**\n * PLA specific Functions\n */\n\n/**\n * Fetches whether the user has configured phpLDAPadmin to obfuscate passwords\n * with \"*********\" when displaying them.\n *\n * This is configured in config.php thus:\n * <code>\n *  $config->custom->appearance['obfuscate_password_display'] = true;\n * </code>\n *\n * Or if it is OK to show encrypted passwords but not clear text passwords\n * <code>\n *  $config->custom->appearance['show_clear_password'] = false;\n * </code>\n *\n * @param string Password encoding type\n * @return boolean\n */\nfunction obfuscate_password_display($enc=null) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\tif ($_SESSION[APPCONFIG]->getValue('appearance','obfuscate_password_display'))\n\t\t$return = true;\n\n\telseif (! $_SESSION[APPCONFIG]->getValue('appearance','show_clear_password') && (is_null($enc) || $enc == 'clear'))\n\t\t$return = true;\n\n\telse\n\t\t$return = false;\n\n\tif (DEBUG_ENABLED)\n\t\tdebug_log('Returning (%s)',1,0,__FILE__,__LINE__,__METHOD__,$return);\n\n\treturn $return;\n}\n\n/**\n * Returns an HTML-beautified version of a DN.\n * Internally, this function makes use of pla_explode_dn() to break the\n * the DN into its components. It then glues them back together with\n * \"pretty\" HTML. The returned HTML is NOT to be used as a real DN, but\n * simply displayed.\n *\n * @param string The DN to pretty-print.\n * @return string\n */\nfunction pretty_print_dn($dn) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$dn_save = $dn;\n\t$dn = pla_explode_dn($dn);\n\n\tif (! $dn)\n\t\treturn $dn_save;\n\n\tforeach ($dn as $i => $element) {\n\t\t$element = htmlspecialchars($element);\n\t\t$element = explode('=',$element,2);\n\t\t$element = implode('<span style=\"color: blue; font-family: courier; font-weight: bold\">=</span>',$element);\n\t\t$dn[$i] = $element;\n\t}\n\n\t$dn = implode('<span style=\"color:red; font-family:courier; font-weight: bold;\">,</span>',$dn);\n\n\treturn $dn;\n}\n\n/**\n * Given a string, this function returns true if the string has the format\n * of a DN (ie, looks like \"cn=Foo,dc=example,dc=com\"). Returns false otherwise.\n * The purpose of this function is so that developers can examine a string and\n * know if it looks like a DN, and draw a hyperlink as needed.\n *\n * (See unit_test.php for test cases)\n *\n * @param string The attribute to examine for \"DNness\"\n * @return boolean\n */\nfunction is_dn_string($str) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t/* Try to break the string into its component parts if it can be done\n\t   ie, \"uid=Manager\" \"dc=example\" and \"dc=com\" */\n\t$parts = pla_explode_dn($str);\n\tif (! is_array($parts) || ! count($parts))\n\t\treturn false;\n\n\t/* Foreach of the \"parts\", look for an \"=\" character,\n\t   and make sure neither the left nor the right is empty */\n\tforeach ($parts as $part) {\n\t\tif (! strpos($part,\"=\"))\n\t\t\treturn false;\n\n\t\t$sub_parts = explode('=',$part,2);\n\t\t$left = $sub_parts[0];\n\t\t$right = $sub_parts[1];\n\n\t\tif ( ! strlen(trim($left)) || ! strlen(trim($right)))\n\t\t\treturn false;\n\n\t\tif (strpos($left,'#') !== false)\n\t\t\treturn false;\n\t}\n\n\t# We survived the above rigor. This is a bonified DN string.\n\treturn true;\n}\n\n/**\n * Get whether a string looks like an email address (user@example.com).\n *\n * @param string The string to analyze.\n * @return boolean Returns true if the specified string looks like an email address or false otherwise.\n */\nfunction is_mail_string($str) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$mail_regex = \"/^[_A-Za-z0-9-]+(\\\\.[_A-Za-z0-9-]+)*@[A-Za-z0-9-]+(\\\\.[A-Za-z0-9-]+)*$/\";\n\n\tif (preg_match($mail_regex,$str))\n\t\treturn true;\n\telse\n\t\treturn false;\n}\n\n/**\n * Get whether a string looks like a web URL (http://www.example.com/)\n *\n * @param string The string to analyze.\n * @return boolean Returns true if the specified string looks like a web URL or false otherwise.\n */\nfunction is_url_string($str) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$url_regex = '/^(ftp|https?):\\/\\/+[\\w\\.\\-\\/\\?\\=\\&]*\\w+/';\n\n\tif (preg_match($url_regex,$str))\n\t\treturn true;\n\telse\n\t\treturn false;\n}\n\n/**\n * Compares 2 DNs. If they are equivelant, returns 0, otherwise,\n * returns their sorting order (similar to strcmp()):\n *      Returns < 0 if dn1 is less than dn2.\n *      Returns > 0 if dn1 is greater than dn2.\n *\n * The comparison is performed starting with the top-most element\n * of the DN. Thus, the following list:\n *    <code>\n *       ou=people,dc=example,dc=com\n *       cn=Admin,ou=People,dc=example,dc=com\n *       cn=Joe,ou=people,dc=example,dc=com\n *       dc=example,dc=com\n *       cn=Fred,ou=people,dc=example,dc=org\n *       cn=Dave,ou=people,dc=example,dc=org\n *    </code>\n * Will be sorted thus using usort( $list, \"pla_compare_dns\" ):\n *    <code>\n *       dc=com\n *       dc=example,dc=com\n *       ou=people,dc=example,dc=com\n *       cn=Admin,ou=People,dc=example,dc=com\n *       cn=Joe,ou=people,dc=example,dc=com\n *       cn=Dave,ou=people,dc=example,dc=org\n *       cn=Fred,ou=people,dc=example,dc=org\n *    </code>\n *\n * @param string The first of two DNs to compare\n * @param string The second of two DNs to compare\n * @return int\n */\nfunction pla_compare_dns($dn1,$dn2) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t# If pla_compare_dns is passed via a tree, then we'll just get the DN part.\n\tif (is_array($dn1))\n\t\tif (isset($dn1['dn']))\n\t\t\t$dn1 = $dn1['dn'];\n\t\telse\n\t\t\t$dn1 = implode('+',$dn1);\n\tif (is_array($dn2))\n\t\tif (isset($dn2['dn']))\n\t\t\t$dn2 = $dn2['dn'];\n\t\telse\n\t\t\t$dn2 = implode('+',$dn2);\n\n\t# If they are obviously the same, return immediately\n\tif (! strcasecmp($dn1,$dn2))\n\t\treturn 0;\n\n\t$dn1_parts = pla_explode_dn(pla_reverse_dn($dn1));\n\t$dn2_parts = pla_explode_dn(pla_reverse_dn($dn2));\n\tassert(is_array($dn1_parts));\n\tassert(is_array($dn2_parts));\n\n\t# Foreach of the \"parts\" of the smaller DN\n\tfor ($i=0; $i < count($dn1_parts) && $i < count($dn2_parts); $i++) {\n\t\t/* dnX_part is of the form: \"cn=joe\" or \"cn = joe\" or \"dc=example\"\n\t\t   ie, one part of a multi-part DN. */\n\t\t$dn1_part = $dn1_parts[$i];\n\t\t$dn2_part = $dn2_parts[$i];\n\n\t\t/* Each \"part\" consists of two sub-parts:\n\t\t   1. the attribute (ie, \"cn\" or \"o\")\n\t\t   2. the value (ie, \"joe\" or \"example\") */\n\t\t$dn1_sub_parts = explode('=',$dn1_part,2);\n\t\t$dn2_sub_parts = explode('=',$dn2_part,2);\n\n\t\t$dn1_sub_part_attr = trim($dn1_sub_parts[0]);\n\t\t$dn2_sub_part_attr = trim($dn2_sub_parts[0]);\n\n\t\tif (0 != ($cmp = strcasecmp($dn1_sub_part_attr,$dn2_sub_part_attr)))\n\t\t\treturn $cmp;\n\n\t\t$dn1_sub_part_val = trim($dn1_sub_parts[1]);\n\t\t$dn2_sub_part_val = trim($dn2_sub_parts[1]);\n\t\tif (0 != ($cmp = strcasecmp($dn1_sub_part_val,$dn2_sub_part_val)))\n\t\t\treturn $cmp;\n\t}\n\n\t/* If we iterated through all entries in the smaller of the two DNs\n\t   (ie, the one with fewer parts), and the entries are different sized,\n\t   then, the smaller of the two must be \"less than\" than the larger. */\n\tif (count($dn1_parts) > count($dn2_parts)) {\n\t\treturn 1;\n\n\t} elseif (count($dn2_parts) > count($dn1_parts)) {\n\t\treturn -1;\n\n\t} else {\n\t\treturn 0;\n\t}\n}\n\n/**\n * For LDAP servers with auto_number enabled, this function will get the next\n * available number using the host's preferred mechanism (pool or search).\n *\n * This is configured in config.php by server:\n *\n * <code>\n *   $servers->setValue('auto_number','enable',true|false);\n * </code>\n *\n * The available mechanisms are:\n * pool:\n *   The pool mechanism uses a user-configured entry in the LDAP server to\n *   store the last used \"number\". This mechanism simply fetches and increments\n *   and returns that value.\n *\n * search:\n *   The search mechanism will search the LDAP server that has the attribute\n *   set. It will then find the smallest value and \"fills in the gaps\" by\n *   incrementing the smallest attribute until an unused value is found.\n *\n * NOTE: Both mechanisms do NOT prevent race conditions or toe-stomping, so\n * care must be taken when actually creating the entry to check that the number\n * returned here has not been used in the mean time. Note that the two different\n * mechanisms may (will!) return different values as they use different algorithms\n * to arrive at their result. Do not be alarmed if (when!) this is the case.\n *\n * See config.php.example for more notes on the two mechanisms.\n *\n * @param string Base to start the search from\n * @param string Attribute to query\n * @param boolean Increment the result (for pool searches)\n * @param string LDAP filter to use (for pool searches)\n * @return int\n */\nfunction get_next_number($base,$attr,$increment=false,$filter=false,$startmin=null) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$server = $_SESSION[APPCONFIG]->getServer(get_request('server_id','REQUEST'));\n\t$attr = strtolower($attr);\n\t$query = array();\n\n\tif (! $server->getValue('auto_number','enable')) {\n\t\tsystem_message(array(\n\t\t\t'title'=>_('AUTO_NUMBER is disabled for this server'),\n\t\t\t'body'=>sprintf('%s (<b>%s</b>)',_('A call was made to get_next_number(), however, it is disabled for this server'),$attr),\n\t\t\t'type'=>'warn'));\n\n\t\treturn false;\n\t}\n\n\t# Check see and use our alternate uid_dn and password if we have it.\n\tif (! $server->login($server->getValue('auto_number','dn'),$server->getValue('auto_number','pass'),'auto_number')) {\n\t\tsystem_message(array(\n\t\t\t'title'=>_('AUTO_NUMBER invalid login/password'),\n\t\t\t'body'=>sprintf('%s (<b>%s</b>)',_('Unable to connect to LDAP server with the auto_number login/password, please check your configuration.'),\n\t\t\t\t$server->getName()),\n\t\t\t'type'=>'warn'));\n\n\t\treturn false;\n\t}\n\n\t# Some error checking\n\tif (! $base) {\n\t\t$query['base'] = $server->getValue('auto_number','search_base');\n\n\t\tif (! trim($query['base'])) {\n\t\t\tsystem_message(array(\n\t\t\t\t'title'=>_('No AUTO_NUMBER search_base configured for this server'),\n\t\t\t\t'body'=>_('A call was made to get_next_number(), however, the base to search is empty.'),\n\t\t\t\t'type'=>'warn'));\n\n\t\t\treturn false;\n\t\t}\n\n\t} else\n\t\t$query['base'] = $base;\n\n\tif (! $server->dnExists($query['base'])) {\n\t\tsystem_message(array(\n\t\t\t'title'=>_('No AUTO_NUMBER search_base exists for this server'),\n\t\t\t'body'=>sprintf('%s (<b>%s</b>)',_('A call was made to get_next_number(), however, the base to search does not exist for this server.'),$query['base']),\n\t\t\t'type'=>'warn'));\n\n\t\treturn false;\n\t}\n\n\tif (! is_string($attr) || ! $server->getSchemaAttribute($attr)) {\n\t\tsystem_message(array(\n\t\t\t'title'=>_('AUTO_NUMBER search attribute invalid'),\n\t\t\t'body'=>sprintf('%s (<b>%s</b>)',_('The search attribute for AUTO_NUMBER is invalid, expecting a single valid attribute.'),$attr),\n\t\t\t'type'=>'warn'));\n\n\t\treturn false;\n\t}\n\n\t$query['attrs'] = array($attr);\n\n\t# Based on the configured mechanism, go get the next available uidNumber!\n\tswitch ($server->getValue('auto_number','mechanism')) {\n\t\tcase 'search':\n\t\t\t$query['filter'] = sprintf('(%s=*)',$attr);\n\t\t\t$search = $server->query($query,'auto_number');\n\n\t\t\t# Construct a list of used numbers\n\t\t\t$autonum = array(0);\n\n\t\t\tforeach ($search as $dn => $values) {\n\t\t\t\t$values = array_change_key_case($values);\n\t\t\t\tforeach ($values[$attr] as $value)\n\t\t\t\t\tarray_push($autonum,$value);\n\t\t\t}\n\n\t\t\t$autonum = array_unique($autonum);\n\t\t\tsort($autonum);\n\n\t\t\t# Start with the least existing autoNumber and add 1\n\t\t\t$minNumber = is_null($startmin) ? intval($autonum[0])+1 : $startmin;\n\n\t\t\t# Override our minNumber by the configuration if it exists.\n\t\t\tif (count($server->getValue('auto_number','min'))) {\n\t\t\t\t$min = array_change_key_case($server->getValue('auto_number','min'));\n\n\t\t\t\tif (isset($min[$attr]))\n\t\t\t\t\t$minNumber = $min[$attr] > $minNumber ? $min[$attr] : $minNumber;\n\t\t\t}\n\n\t\t\tfor ($i=0;$i<count($autonum);$i++) {\n\t\t\t\t$num = $autonum[$i] < $minNumber ? $minNumber : $autonum[$i];\n\n\t\t\t\t/* If we're at the end of the list, or we've found a gap between this number and the\n\t\t\t\t   following, use the next available number in the gap. */\n\t\t\t\tif ($i+1 == count($autonum) || $autonum[$i+1] > $num+1)\n\t\t\t\t\treturn $autonum[$i] >= $num ? $num+1 : $num;\n\t\t\t}\n\n\t\t\t# If we didnt find a suitable gap and are all above the minNumber, we'll just return the $minNumber\n\t\t\treturn $minNumber;\n\n\t\t\tbreak;\n\n\t\tcase 'pool':\n\t\t\tswitch ($attr) {\n\t\t\t\tcase 'gidnumber':\n\t\t\t\t\t$query['filter'] = '(objectClass=gidPool)';\n\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'uidnumber':\n\t\t\t\t\t$query['filter'] = '(objectClass=uidPool)';\n\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\t# If we are called with a filter, we'll use the one from the configuration.\n\t\t\tif (! empty($filter))\n\t\t\t\t$query['filter'] = $filter;\n\n\t\t\t$search = $server->query($query,'auto_number');\n\n\t\t\tswitch (count($search)) {\n\t\t\t\tcase '1':\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase '0':\n\t\t\t\t\tsystem_message(array(\n\t\t\t\t\t\t'title'=>_('AUTO_NUMBER pool filter didnt return any DNs'),\n\t\t\t\t\t\t'body'=>sprintf('%s (<b>%s</b>)',_('Please change your filter parameter, or check your auto_number,search_base configuration'),$query['filter']),\n\t\t\t\t\t\t'type'=>'warn'));\n\n\t\t\t\t\treturn false;\n\n\t\t\t\tdefault:\n\t\t\t\t\tsystem_message(array(\n\t\t\t\t\t'title'=>_('AUTO_NUMBER pool filter returned too many DNs'),\n\t\t\t\t\t\t'body'=>sprintf('%s (<b>%s</b>)',_('Please change your filter parameter, or check your auto_number,search_base configuration'),$query['filter']),\n\t\t\t\t\t\t'type'=>'warn'));\n\n\t\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t# This should only iterate once.\n\t\t\tforeach ($search as $dn => $values) {\n\t\t\t\t$values = array_change_key_case($values);\n\n\t\t\t\t$autonum = $values[$attr][0];\n\t\t\t\t$poolDN = $values['dn'];\n\t\t\t}\n\n\t\t\tif ($increment) {\n\t\t\t\t$updatedattr = array($attr=>$autonum+1);\n\t\t\t\t$server->modify($poolDN,$updatedattr);\n\t\t\t}\n\n\t\t\treturn $autonum;\n\n\t\t# No other cases allowed. The user has an error in the configuration\n\t\tdefault:\n\t\t\tsystem_message(array(\n\t\t\t\t'title'=>_('Invalid AUTO_NUMBER mechanism'),\n\t\t\t\t'body'=>sprintf('%s (<b>%s</b>)',_('Your config file specifies an unknown AUTO_NUMBER search mechanism.'),$server->getValue('auto_number','mechanism')),\n\t\t\t\t'type'=>'warn'));\n\n\t\t\treturn false;\n\t}\n}\n\n/**\n * Given a DN and server ID, this function reads the DN's objectClasses and\n * determines which icon best represents the entry. The results of this query\n * are cached in a session variable so it is not run every time the tree\n * browser changes, just when exposing new DNs that were not displayed\n * previously. That means we can afford a little bit of inefficiency here\n * in favor of coolness. :)\n *\n * This function returns a string like \"country.png\". All icon files are assumed\n * to be contained in the /images/ directory of phpLDAPadmin.\n *\n * Developers are encouraged to add new icons to the images directory and modify\n * this function as needed to suit their types of LDAP entries. If the modifications\n * are general to an LDAP audience, the phpLDAPadmin team will gladly accept them\n * as a patch.\n *\n * @param string The DN of the entry whose icon you wish to fetch.\n * @return string\n */\nfunction get_icon($server_id,$dn,$object_classes=array()) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$server = $_SESSION[APPCONFIG]->getServer($server_id);\n\n\t# Fetch and lowercase all the objectClasses in an array\n\tif (! count($object_classes))\n\t\t$object_classes = $server->getDNAttrValue($dn,'objectClass');\n\n\tforeach ($object_classes as $index => $value)\n\t\t$object_classes[$index] = strtolower($value);\n\n\t$rdn = get_rdn($dn);\n\t$rdn_parts = explode('=',$rdn,2);\n\t$rdn_value = isset($rdn_parts[0]) ? $rdn_parts[0] : null;\n\t$rdn_attr = isset($rdn_parts[1]) ? $rdn_parts[1] : null;\n\tunset($rdn_parts);\n\n\t# Return icon filename based upon objectClass value\n\tif (in_array('sambaaccount',$object_classes) &&\n\t\t'$' == $rdn{ strlen($rdn) - 1 })\n\t\treturn 'nt_machine.png';\n\n\tif (in_array('sambaaccount',$object_classes))\n\t\treturn 'nt_user.png';\n\n\telseif (in_array('person',$object_classes) ||\n\t\tin_array('organizationalperson',$object_classes) ||\n\t\tin_array('inetorgperson',$object_classes) ||\n\t\tin_array('account',$object_classes) ||\n\t\tin_array('posixaccount',$object_classes))\n\n\t\treturn 'ldap-user.png';\n\n\telseif (in_array('organization',$object_classes))\n\t\treturn 'ldap-o.png';\n\n\telseif (in_array('organizationalunit',$object_classes))\n\t\treturn 'ldap-ou.png';\n\n\telseif (in_array('organizationalrole',$object_classes))\n\t\treturn 'ldap-uid.png';\n\n\telseif (in_array('dcobject',$object_classes) ||\n\t\tin_array('domainrelatedobject',$object_classes) ||\n\t\tin_array('domain',$object_classes) ||\n\t\tin_array('builtindomain',$object_classes))\n\n\t\treturn 'ldap-dc.png';\n\n\telseif (in_array('alias',$object_classes))\n\t\treturn 'ldap-alias.png';\n\n\telseif (in_array('room',$object_classes))\n\t\treturn 'door.png';\n\n\telseif (in_array('iphost',$object_classes))\n\t\treturn 'host.png';\n\n\telseif (in_array('device',$object_classes))\n\t\treturn 'device.png';\n\n\telseif (in_array('document',$object_classes))\n\t\treturn 'document.png';\n\n\telseif (in_array('country',$object_classes)) {\n\t\t$tmp = pla_explode_dn($dn);\n\t\t$cval = explode('=',$tmp[0],2);\n\t\t$cval = isset($cval[1]) ? $cval[1] : false;\n\t\tif ($cval && false === strpos($cval,'..') &&\n\t\t\tfile_exists(realpath(sprintf('%s/../countries/%s.png',IMGDIR,strtolower($cval)))))\n\n\t\t\treturn sprintf('../countries/%s.png',strtolower($cval));\n\n\t\telse\n\t\t\treturn 'country.png';\n\t}\n\n\telseif (in_array('jammvirtualdomain',$object_classes))\n\t\treturn 'mail.png';\n\n\telseif (in_array('locality',$object_classes))\n\t\treturn 'locality.png';\n\n\telseif (in_array('posixgroup',$object_classes) ||\n\t\tin_array('groupofnames',$object_classes) ||\n\t\tin_array('group',$object_classes))\n\n\t\treturn 'ldap-ou.png';\n\n\telseif (in_array('applicationprocess',$object_classes))\n\t\treturn 'process.png';\n\n\telseif (in_array('groupofuniquenames',$object_classes))\n\t\treturn 'ldap-uniquegroup.png';\n\n\telseif (in_array('nlsproductcontainer',$object_classes))\n\t\treturn 'n.png';\n\n\telseif (in_array('ndspkikeymaterial',$object_classes))\n\t\treturn 'lock.png';\n\n\telseif (in_array('server',$object_classes))\n\t\treturn 'server-small.png';\n\n\telseif (in_array('volume',$object_classes))\n\t\treturn 'hard-drive.png';\n\n\telseif (in_array('ndscatcatalog',$object_classes))\n\t\treturn 'catalog.png';\n\n\telseif (in_array('resource',$object_classes))\n\t\treturn 'n.png';\n\n\telseif (in_array('ldapgroup',$object_classes))\n\t\treturn 'ldap-server.png';\n\n\telseif (in_array('ldapserver',$object_classes))\n\t\treturn 'ldap-server.png';\n\n\telseif (in_array('nisserver',$object_classes))\n\t\treturn 'ldap-server.png';\n\n\telseif (in_array('rbscollection',$object_classes))\n\t\treturn 'ldap-ou.png';\n\n\telseif (in_array('dfsconfiguration',$object_classes))\n\t\treturn 'nt_machine.png';\n\n\telseif (in_array('applicationsettings',$object_classes))\n\t\treturn 'server-settings.png';\n\n\telseif (in_array('aspenalias',$object_classes))\n\t\treturn 'mail.png';\n\n\telseif (in_array('container',$object_classes))\n\t\treturn 'folder.png';\n\n\telseif (in_array('ipnetwork',$object_classes))\n\t\treturn 'network.png';\n\n\telseif (in_array('samserver',$object_classes))\n\t\treturn 'server-small.png';\n\n\telseif (in_array('lostandfound',$object_classes))\n\t\treturn 'find.png';\n\n\telseif (in_array('infrastructureupdate',$object_classes))\n\t\treturn 'server-small.png';\n\n\telseif (in_array('filelinktracking',$object_classes))\n\t\treturn 'files.png';\n\n\telseif (in_array('automountmap',$object_classes) ||\n\t\tin_array('automount',$object_classes))\n\n\t\treturn 'hard-drive.png';\n\n\telseif (strpos($rdn_value,'ipsec') === 0 ||\n\t\tstrcasecmp($rdn_value,'IP Security') == 0||\n\t\tstrcasecmp($rdn_value,'MSRADIUSPRIVKEY Secret') == 0 ||\n\t\tstrpos($rdn_value,'BCKUPKEY_') === 0)\n\n\t\treturn 'lock.png';\n\n\telseif (strcasecmp($rdn_value,'MicrosoftDNS') == 0)\n\t\treturn 'ldap-dc.png';\n\n\t# Oh well, I don't know what it is. Use a generic icon.\n\telse\n\t\treturn 'ldap-default.png';\n}\n\n/**\n * Appends a servers base to a \"sub\" dn or returns the base.\n *\n * @param string The baseDN to be added if the DN is relative\n * @param string The DN to be made absolute\n * @return string|null Returns null if both base is null and sub_dn is null or empty\n */\nfunction expand_dn_with_base($base,$sub_dn) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$empty_str = (is_null($sub_dn) || (($len=strlen(trim($sub_dn))) == 0));\n\n\tif ($empty_str)\n\t\treturn $base;\n\n\t# If we have a string which doesn't need a base\n\telseif ($sub_dn[$len-1] != ',')\n\t\treturn $sub_dn;\n\n\telse\n\t\treturn sprintf('%s%s',$sub_dn,$base);\n}\n\n/**\n * Used to generate a random salt for crypt-style passwords. Salt strings are used\n * to make pre-built hash cracking dictionaries difficult to use as the hash algorithm uses\n * not only the user's password but also a randomly generated string. The string is\n * stored as the first N characters of the hash for reference of hashing algorithms later.\n *\n * @param int The length of the salt string to generate.\n * @return string The generated salt string.\n */\nfunction random_salt($length) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$possible = '0123456789'.\n\t\t'abcdefghijklmnopqrstuvwxyz'.\n\t\t'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.\n\t\t'./';\n\t$str = '';\n\tmt_srand((double)microtime() * 1000000);\n\n\twhile (strlen($str) < $length)\n\t\t$str .= substr($possible,(rand()%strlen($possible)),1);\n\n\treturn $str;\n}\n\n/**\n * Given a DN string, this returns the 'RDN' portion of the string.\n * For example. given 'cn=Manager,dc=example,dc=com', this function returns\n * 'cn=Manager' (it is really the exact opposite of ds_ldap::getContainer()).\n *\n * @param string The DN whose RDN to return.\n * @param boolean If true, include attributes in the RDN string. See http://php.net/ldap_explode_dn for details\n * @return string The RDN\n */\nfunction get_rdn($dn,$include_attrs=0,$decode=false) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\tif (is_null($dn))\n\t\treturn null;\n\n\t$rdn = pla_explode_dn($dn,$include_attrs);\n\tif (! count($rdn) || ! isset($rdn[0]))\n\t\treturn $dn;\n\n\tif ($decode)\n\t\t$rdn = dn_unescape($rdn[0]);\n\telse\n\t\t$rdn = $rdn[0];\n\n\treturn $rdn;\n}\n\n/**\n * Split an RDN into its attributes\n */\nfunction rdn_explode($rdn) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t# Setup to work out our RDN.\n\t$rdnarray = explode('\\+',$rdn);\n\n\t# Capture items that have +, but are not an attribute\n\tforeach ($rdnarray as $index => $val) {\n\t\tif (preg_match('/=/',$val))\n\t\t\t$validindex = $index;\n\n\t\tif (! preg_match('/=/',$val)) {\n\t\t\t$rdnarray[$validindex] .= '+'.$val;\n\t\t\tunset($rdnarray[$index]);\n\t\t}\n\t}\n\n\treturn $rdnarray;\n}\n\n/**\n * Given an LDAP error number, returns a verbose description of the error.\n * This function parses ldap_error_codes.txt and looks up the specified\n * ldap error number, and returns the verbose message defined in that file.\n *\n * <code>\n *  Array (\n *    [title] => \"Invalid Credentials\"\n *    [description] => \"An invalid username and/or password was supplied to the LDAP server.\"\n *  )\n * </code>\n *\n * @param string The hex error number (ie, \"0x42\") of the LDAP error of interest.\n * @return array An associative array contianing the error title and description like so:\n */\nfunction pla_verbose_error($key) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\tstatic $CACHE = array();\n\n\tif (! count($CACHE)) {\n\t\t$source_file = LIBDIR.'ldap_error_codes.txt';\n\n\t\tif (! file_exists($source_file) || ! is_readable($source_file) || ! ($f = fopen($source_file,'r')))\n\t\t\treturn false;\n\n\t\t$contents = fread($f,filesize($source_file));\n\t\tfclose($f);\n\t\t$entries = array();\n\t\tpreg_match_all(\"/0x[A-Fa-f0-9][A-Za-z0-9]\\s+[0-9A-Za-z_]+\\s+\\\"[^\\\"]*\\\"\\n/\",\n\t\t\t\t$contents,$entries);\n\n\t\tforeach ($entries[0] as $values) {\n\t\t\t$entry = array();\n\t\t\tpreg_match(\"/(0x[A-Za-z0-9][A-Za-z0-9])\\s+([0-9A-Za-z_]+)\\s+\\\"([^\\\"]*)\\\"/\",$values,$entry);\n\n\t\t\t$hex_code = isset($entry[1]) ? $entry[1] : null;\n\t\t\t$title = isset($entry[2]) ? $entry[2] : null;\n\t\t\t$desc = isset($entry[3]) ? $entry[3] : null;\n\t\t\t$desc = preg_replace('/\\s+/',' ',$desc);\n\t\t\t$CACHE[$hex_code] = array('title'=>$title,'desc'=>$desc);\n\t\t}\n\t}\n\n\tif (isset($CACHE[$key]))\n\t\treturn $CACHE[$key];\n\telse\n\t\treturn array('title' => null,'desc' => null);\n}\n\n/**\n * Given an LDAP OID number, returns a verbose description of the OID.\n * This function parses ldap_supported_oids.txt and looks up the specified\n * OID, and returns the verbose message defined in that file.\n *\n * <code>\n *  Array (\n *    [title] => All Operational Attribute\n *    [ref] => RFC 3673\n *    [desc] => An LDAP extension which clients may use to request the return of all operational attributes.\n *  )\n * </code>\n *\n * @param string The OID number (ie, \"1.3.6.1.4.1.4203.1.5.1\") of the OID of interest.\n * @return array An associative array contianing the OID title and description like so:\n */\nfunction support_oid_to_text($key) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\tstatic $CACHE = array();\n\n\t$unknown = array();\n\t$unknown['desc'] = 'We have no description for this OID, if you know what this OID provides, please let us know. Please also include an RFC reference if it is available.';\n\t$unknown['title'] = 'Can you help with this OID info?';\n\n\tif (! count($CACHE)) {\n\t\t$source_file = LIBDIR.'ldap_supported_oids.txt';\n\n\t\tif (! file_exists($source_file) || ! is_readable($source_file) || ! ($f = fopen($source_file,'r')))\n\t\t\treturn false;\n\n\t\t$contents = fread($f,filesize($source_file));\n\t\tfclose($f);\n\t\t$entries = array();\n\t\tpreg_match_all(\"/[0-9]\\..+\\s+\\\"[^\\\"]*\\\"\\n/\",$contents,$entries);\n\n\t\tforeach ($entries[0] as $values) {\n\t\t\t$entry = array();\n\t\t\tpreg_match(\"/([0-9]\\.([0-9]+\\.)*[0-9]+)(\\s+\\\"([^\\\"]*)\\\")?(\\s+\\\"([^\\\"]*)\\\")?(\\s+\\\"([^\\\"]*)\\\")?/\",$values,$entry);\n\t\t\t$oid_id = isset($entry[1]) ? $entry[1] : null;\n\n\t\t\tif ($oid_id) {\n\t\t\t\t$CACHE[$oid_id]['title'] = isset($entry[4]) ? $entry[4] : null;\n\t\t\t\t$CACHE[$oid_id]['ref'] = isset($entry[6]) ? $entry[6] : null;\n\t\t\t\t$desc = isset($entry[8]) ? $entry[8] : sprintf('<acronym title=\"%s\">%s</acronym>',$unknown['desc'],$unknown['title']);\n\t\t\t\t$CACHE[$oid_id]['desc'] = preg_replace('/\\s+/',' ',$desc);\n\t\t\t}\n\t\t}\n\t}\n\n\tif (isset($CACHE[$key]))\n\t\treturn $CACHE[$key];\n\telse\n\t\treturn array(\n\t\t\t'title'=>$key,\n\t\t\t'ref'=>null,\n\t\t\t'desc'=>sprintf('<acronym title=\"%s\">%s</acronym>',$unknown['desc'],$unknown['title']));\n}\n\n/**\n * Print an LDAP error message\n */\nfunction ldap_error_msg($msg,$errnum) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$body = '<table border=\"0\">';\n\n\t$errnum = ('0x'.str_pad(dechex($errnum),2,0,STR_PAD_LEFT));\n\t$verbose_error = pla_verbose_error($errnum);\n\n\t$body .= sprintf('<tr><td><b>%s</b>:</td><td>%s</td></tr>',_('LDAP said'),$msg);\n\n\tif ($verbose_error) {\n\t\t$body .= sprintf('<tr><td><b>%s</b>:</td><td>%s (%s)</td></tr>',_('Error number'),$errnum,$verbose_error['title']);\n\t\t$body .= sprintf('<tr><td><b>%s</b>:</td><td>%s</td></tr>',_('Description'),$verbose_error['desc']);\n\n\t} else {\n\t\t$body .= sprintf('<tr><td><b>%s</b>:</td><td>%s</td></tr>',_('Error number'),$errnum);\n\t\t$body .= sprintf('<tr><td><b>%s</b>:</td><td>(%s)</td></tr>',_('Description'),_('no description available'));\n\t}\n\n\t$body .= '</table>';\n\n\treturn $body;\n}\n\n/**\n * Draw the jpegPhoto image(s) for an entry wrapped in HTML. Many options are available to\n * specify how the images are to be displayed.\n *\n * Usage Examples:\n *  <code>\n *   draw_jpeg_photo(0,'cn=Bob,ou=People,dc=example,dc=com',\"jpegPhoto\",0,true,array('img_opts'=>\"border: 1px; width: 150px\"));\n *   draw_jpeg_photo(1,'cn=Fred,ou=People,dc=example,dc=com',null,1);\n *  </code>\n *\n * @param object The Server to get the image from.\n * @param string The DN of the entry that contains the jpeg attribute you want to draw.\n * @param string The name of the attribute containing the jpeg data (usually 'jpegPhoto').\n * @param int Index of the attribute to draw\n * @param boolean If true, draws a button beneath the image titled 'Delete' allowing the user\n *                to delete the jpeg attribute by calling JavaScript function deleteAttribute() provided\n *                in the default modification template.\n * @param array Specifies optional image and CSS style attributes for the table tag. Supported keys are\n *                fixed_width, fixed_height, img_opts.\n */\nfunction draw_jpeg_photo($server,$dn,$attr_name='jpegphoto',$index,$draw_delete_buttons=false,$options=array()) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$fixed = array();\n\t$fixed['width'] = isset($options['fixed_width']) ? $options['fixed_width'] : false;\n\t$fixed['height'] = isset($options['fixed_height']) ? $options['fixed_height'] : false;\n\n\tif (is_null($server))\n\t\t$jpeg_data = $_SESSION['tmp'];\n\telse\n\t\t$jpeg_data = $server->getDNAttrValues($dn,null,LDAP_DEREF_NEVER,array($attr_name));\n\n\tif (! isset($jpeg_data[$attr_name][$index]) || ! $jpeg_data[$attr_name][$index]) {\n\t\tsystem_message(array(\n\t\t\t'title'=>_('Unable to retrieve image'),\n\t\t\t'body'=>sprintf('%s %s',\n\t\t\t\t_('Could not fetch jpeg data for attribute'),$attr_name),\n\t\t\t'type'=>'warn'));\n\n\t\t# This should atleast generate some text that says \"Image not available\"\n\t\tprintf('<img src=\"view_jpeg_photo.php?location=session&attr=%s\" alt=\"Photo\" />',$attr_name);\n\n\t\treturn;\n\t}\n\n\t$width = 0;\n\t$height = 0;\n\n\tif (function_exists('getimagesize')) {\n\t\t$jpeg_temp_dir = realpath($_SESSION[APPCONFIG]->getValue('jpeg','tmpdir').'/');\n\t\tif (! is_writable($jpeg_temp_dir))\n\t\t\tsystem_message(array(\n\t\t\t\t'title'=>_('Unable to write to jpeg tmp directory'),\n\t\t\t\t'body'=>_('Please set jpeg,tmpdir to a writable directory in the phpLDAPadmin config.php'),\n\t\t\t\t'type'=>'warn'));\n\n\t\telse {\n\t\t\t# We have an image to display\n\t\t\t$jpeg_filename = tempnam($jpeg_temp_dir.'/','pla');\n\t\t\t$outjpeg = @file_put_contents($jpeg_filename,$jpeg_data[$attr_name][$index]);\n\n\t\t\tif (! $outjpeg) {\n\t\t\t\tsystem_message(array(\n\t\t\t\t\t'title'=>_('Error writing to jpeg tmp directory'),\n\t\t\t\t\t'body'=>sprintf(_('Please check jpeg,tmpdir is a writable directory in the phpLDAPadmin config.php'),$jpeg_temp_dir),\n\t\t\t\t\t'type'=>'warn'));\n\n\t\t\t} elseif ($outjpeg < 6) {\n\t\t\t\tsystem_message(array(\n\t\t\t\t\t'title'=>sprintf('%s %s',$attr_name,_('contains errors')),\n\t\t\t\t\t'body'=>_('It appears that the jpeg image may not be a jpeg image'),\n\t\t\t\t\t'type'=>'warn'));\n\n\t\t\t} else {\n\t\t\t\t$jpeg_dimensions = getimagesize($jpeg_filename);\n\t\t\t\t$width = $jpeg_dimensions[0];\n\t\t\t\t$height = $jpeg_dimensions[1];\n\t\t\t}\n\n\t\t\tunlink($jpeg_filename);\n\t\t}\n\t}\n\n\tif ($width > 300) {\n\t\t$scale_factor = 300 / $width;\n\t\t$img_width = 300;\n\t\t$img_height = intval($height * $scale_factor);\n\n\t} else {\n\t\t$img_width = $width;\n\t\t$img_height = $height;\n\t}\n\n\t$href = sprintf('view_jpeg_photo.php?dn=%s&index=%s&attr=%s',rawurlencode($dn),$index,$attr_name);\n\n\tprintf('<acronym title=\"%s %s. %s x %s %s.\">',number_format($outjpeg),_('bytes'),$width,$height,_('pixels'));\n\n\tprintf('<img src=\"%s&amp;%s\" alt=\"Photo\" %s%s%s />',\n\t\thtmlspecialchars($href),\n\t\tis_null($server) ? 'location=session' : sprintf('server_id=%s',$server->getIndex()),\n\t\t(! $img_width || $fixed['width'] ? '' : sprintf('width=\"%s\"',$img_width)),\n\t\t(! $img_height || $fixed['height'] ? '' : sprintf('height=\"%s\"',$img_height)),\n\t\t(isset($options['img_opts']) ? $options['img_opts'] : ''));\n\n\techo '</acronym>';\n\n\tif ($draw_delete_buttons)\n\t\t# <!-- JavaScript function deleteJpegPhoto() to be defined later by calling script -->\n\t\tprintf('<br/><a href=\"javascript:deleteAttribute(\\'%s\\');\" style=\"color:red; font-size: 75%%\">%s</a>',\n\t\t\t$attr_name,_('Delete photo'));\n}\n\n/**\n * Return the list of available password types\n *\n * @todo Dynamically work this list out so we only present hashes that we can encrypt\n */\nfunction password_types() {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\treturn array(\n\t\t''=>'clear',\n\t\t'blowfish'=>'blowfish',\n\t\t'crypt'=>'crypt',\n\t\t'ext_des'=>'ext_des',\n\t\t'md5'=>'md5',\n\t\t'k5key'=>'k5key',\n\t\t'md5crypt'=>'md5crypt',\n\t\t'sha'=>'sha',\n\t\t'smd5'=>'smd5',\n\t\t'ssha'=>'ssha',\n\t\t'sha512'=>'sha512',\n\t\t'sha256crypt'=>'sha256crypt',\n\t\t'sha512crypt'=>'sha512crypt',\n\t);\n}\n\n/**\n * Hashes a password and returns the hash based on the specified enc_type.\n *\n * @param string The password to hash in clear text.\n * @param string Standard LDAP encryption type which must be one of\n *        crypt, ext_des, md5crypt, blowfish, md5, sha, smd5, ssha, sha512,\n *        sha256crypt, sha512crypt, or clear.\n * @return string The hashed password.\n */\nfunction pla_password_hash($password_clear,$enc_type) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$enc_type = strtolower($enc_type);\n\n\tswitch($enc_type) {\n\t\tcase 'blowfish':\n\t\t\tif (! defined('CRYPT_BLOWFISH') || CRYPT_BLOWFISH == 0)\n\t\t\t\terror(_('Your system crypt library does not support blowfish encryption.'),'error','index.php');\n\n\t\t\t# Hardcoded to second blowfish version and set number of rounds\n\t\t\t$new_value = sprintf('{CRYPT}%s',crypt($password_clear,'$2a$12$'.random_salt(13)));\n\n\t\t\tbreak;\n\n\t\tcase 'crypt':\n\t\t\tif ($_SESSION[APPCONFIG]->getValue('password', 'no_random_crypt_salt'))\n\t\t\t\t$new_value = sprintf('{CRYPT}%s',crypt($password_clear,substr($password_clear,0,2)));\n\t\t\telse\n\t\t\t\t$new_value = sprintf('{CRYPT}%s',crypt($password_clear,random_salt(2)));\n\n\t\t\tbreak;\n\n\t\tcase 'ext_des':\n\t\t\t# Extended des crypt. see OpenBSD crypt man page.\n\t\t\tif (! defined('CRYPT_EXT_DES') || CRYPT_EXT_DES == 0)\n\t\t\t\terror(_('Your system crypt library does not support extended DES encryption.'),'error','index.php');\n\n\t\t\t$new_value = sprintf('{CRYPT}%s',crypt($password_clear,'_'.random_salt(8)));\n\n\t\t\tbreak;\n\n\t\tcase 'k5key':\n\t\t\t$new_value = sprintf('{K5KEY}%s',$password_clear);\n\n\t\t\tsystem_message(array(\n\t\t\t\t'title'=>_('Unable to Encrypt Password'),\n\t\t\t\t'body'=>'phpLDAPadmin cannot encrypt K5KEY passwords',\n\t\t\t\t'type'=>'warn'));\n\n\t\t\tbreak;\n\n\t\tcase 'md5':\n\t\t\t$new_value = sprintf('{MD5}%s',base64_encode(pack('H*',md5($password_clear))));\n\t\t\tbreak;\n\n\t\tcase 'md5crypt':\n\t\t\tif (! defined('CRYPT_MD5') || CRYPT_MD5 == 0)\n\t\t\t\terror(_('Your system crypt library does not support md5crypt encryption.'),'error','index.php');\n\n\t\t\t$new_value = sprintf('{CRYPT}%s',crypt($password_clear,'$1$'.random_salt(9)));\n\n\t\t\tbreak;\n\n\t\tcase 'sha':\n\t\t\t# Use php 4.3.0+ sha1 function, if it is available.\n\t\t\tif (function_exists('sha1'))\n\t\t\t\t$new_value = sprintf('{SHA}%s',base64_encode(pack('H*',sha1($password_clear))));\n\t\t\telseif (function_exists('mhash'))\n\t\t\t\t$new_value = sprintf('{SHA}%s',base64_encode(mhash(MHASH_SHA1,$password_clear)));\n\t\t\telse\n\t\t\t\terror(_('Your PHP install does not have the mhash() function. Cannot do SHA hashes.'),'error','index.php');\n\n\t\t\tbreak;\n\n\t\tcase 'ssha':\n\t\t\tif (function_exists('mhash') && function_exists('mhash_keygen_s2k')) {\n\t\t\t\tmt_srand((double)microtime()*1000000);\n\t\t\t\t$salt = mhash_keygen_s2k(MHASH_SHA1,$password_clear,substr(pack('h*',md5(mt_rand())),0,8),4);\n\t\t\t\t$new_value = sprintf('{SSHA}%s',base64_encode(mhash(MHASH_SHA1,$password_clear.$salt).$salt));\n\n\t\t\t} else {\n\t\t\t\terror(_('Your PHP install does not have the mhash() or mhash_keygen_s2k() function. Cannot do S2K hashes.'),'error','index.php');\n\t\t\t}\n\n\t\t\tbreak;\n\n\t\tcase 'smd5':\n\t\t\tif (function_exists('mhash') && function_exists('mhash_keygen_s2k')) {\n\t\t\t\tmt_srand((double)microtime()*1000000);\n\t\t\t\t$salt = mhash_keygen_s2k(MHASH_MD5,$password_clear,substr(pack('h*',md5(mt_rand())),0,8),4);\n\t\t\t\t$new_value = sprintf('{SMD5}%s',base64_encode(mhash(MHASH_MD5,$password_clear.$salt).$salt));\n\n\t\t\t} else {\n\t\t\t\terror(_('Your PHP install does not have the mhash() or mhash_keygen_s2k() function. Cannot do S2K hashes.'),'error','index.php');\n\t\t\t}\n\n\t\t\tbreak;\n\n\t\tcase 'sha512':\n\t\t\tif (function_exists('openssl_digest') && function_exists('base64_encode')) {\n\t\t\t\t$new_value = sprintf('{SHA512}%s', base64_encode(openssl_digest($password_clear, 'sha512', true)));\n\n\t\t\t} else {\n\t\t\t\terror(_('Your PHP install doest not have the openssl_digest() or base64_encode() function. Cannot do SHA512 hashes. '),'error','index.php');\n\t\t\t}\n\n\t\t\tbreak;\n\n\t\tcase 'sha256crypt':\n\t\t\tif (! defined('CRYPT_SHA256') || CRYPT_SHA256 == 0)\n\t\t\t\terror(_('Your system crypt library does not support sha256crypt encryption.'),'error','index.php');\n\t\t\t$new_value = sprintf('{CRYPT}%s',crypt($password_clear,'$5$'.random_salt(8)));\n\n\t\t\tbreak;\n\n\t\tcase 'sha512crypt':\n\t\t\tif (! defined('CRYPT_SHA512') || CRYPT_SHA512 == 0)\n\t\t\t\terror(_('Your system crypt library does not support sha512crypt encryption.'),'error','index.php');\n\t\t\t$new_value = sprintf('{CRYPT}%s',crypt($password_clear,'$6$'.random_salt(8)));\n\n\t\t\tbreak;\n\n\t\tcase 'clear':\n\t\tdefault:\n\t\t\t$new_value = $password_clear;\n\t}\n\n\treturn $new_value;\n}\n\n/**\n * Given a clear-text password and a hash, this function determines if the clear-text password\n * is the password that was used to generate the hash. This is handy to verify a user's password\n * when all that is given is the hash and a \"guess\".\n * @param String The hash.\n * @param String The password in clear text to test.\n * @return Boolean True if the clear password matches the hash, and false otherwise.\n */\nfunction password_check($cryptedpassword,$plainpassword,$attribute='userpassword') {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\tif (in_array($attribute,array('sambalmpassword','sambantpassword'))) {\n\t\t$smb = new smbHash;\n\n\t\tswitch($attribute) {\n\t\t\tcase 'sambalmpassword':\n\t\t\t\tif (strcmp($smb->lmhash($plainpassword),strtoupper($cryptedpassword)) == 0)\n\t\t\t\t\treturn true;\n\t\t\t\telse\n\t\t\t\t\treturn false;\n\n\t\t\tcase 'sambantpassword':\n\t\t\t\tif (strcmp($smb->nthash($plainpassword),strtoupper($cryptedpassword)) == 0)\n\t\t\t\t\treturn true;\n\t\t\t\telse\n\t\t\t\t\treturn false;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tif (preg_match('/{([^}]+)}(.*)/',$cryptedpassword,$matches)) {\n\t\t$cryptedpassword = $matches[2];\n\t\t$cypher = strtolower($matches[1]);\n\n\t} else {\n\t\t$cypher = null;\n\t}\n\n\tswitch($cypher) {\n\t\t# SSHA crypted passwords\n\t\tcase 'ssha':\n\t\t\t# Check php mhash support before using it\n\t\t\tif (function_exists('mhash')) {\n\t\t\t\t$hash = base64_decode($cryptedpassword);\n\n\t\t\t\t# OpenLDAP uses a 4 byte salt, SunDS uses an 8 byte salt - both from char 20.\n\t\t\t\t$salt = substr($hash,20);\n\t\t\t\t$new_hash = base64_encode(mhash(MHASH_SHA1,$plainpassword.$salt).$salt);\n\n\t\t\t\tif (strcmp($cryptedpassword,$new_hash) == 0)\n\t\t\t\t\treturn true;\n\t\t\t\telse\n\t\t\t\t\treturn false;\n\n\t\t\t} else {\n\t\t\t\terror(_('Your PHP install does not have the mhash() function. Cannot do SHA hashes.'),'error','index.php');\n\t\t\t}\n\n\t\t\tbreak;\n\n\t\t# Salted MD5\n\t\tcase 'smd5':\n\t\t\t# Check php mhash support before using it\n\t\t\tif (function_exists('mhash')) {\n\t\t\t\t$hash = base64_decode($cryptedpassword);\n\t\t\t\t$salt = substr($hash,16);\n\t\t\t\t$new_hash = base64_encode(mhash(MHASH_MD5,$plainpassword.$salt).$salt);\n\n\t\t\t\tif (strcmp($cryptedpassword,$new_hash) == 0)\n\t\t\t\t\treturn true;\n\t\t\t\telse\n\t\t\t\t\treturn false;\n\n\t\t\t} else {\n\t\t\t\terror(_('Your PHP install does not have the mhash() function. Cannot do SHA hashes.'),'error','index.php');\n\t\t\t}\n\n\t\t\tbreak;\n\n\t\t# SHA crypted passwords\n\t\tcase 'sha':\n\t\t\tif (strcasecmp(pla_password_hash($plainpassword,'sha'),'{SHA}'.$cryptedpassword) == 0)\n\t\t\t\treturn true;\n\t\t\telse\n\t\t\t\treturn false;\n\n\t\t\tbreak;\n\n\t\t# MD5 crypted passwords\n\t\tcase 'md5':\n\t\t\tif( strcasecmp(pla_password_hash($plainpassword,'md5'),'{MD5}'.$cryptedpassword) == 0)\n\t\t\t\treturn true;\n\t\t\telse\n\t\t\t\treturn false;\n\n\t\t\tbreak;\n\n\t\t# Crypt passwords\n\t\tcase 'crypt':\n\t\t\t# Check if it's blowfish crypt\n\t\t\tif (preg_match('/^\\\\$2+/',$cryptedpassword)) {\n\n\t\t\t\t# Make sure that web server supports blowfish crypt\n\t\t\t\tif (! defined('CRYPT_BLOWFISH') || CRYPT_BLOWFISH == 0)\n\t\t\t\t\terror(_('Your system crypt library does not support blowfish encryption.'),'error','index.php');\n\n\t\t\t\tlist($version,$rounds,$salt_hash) = explode('$',$cryptedpassword);\n\n\t\t\t\tif (crypt($plainpassword,'$'.$version.'$'.$rounds.'$'.$salt_hash) == $cryptedpassword)\n\t\t\t\t\treturn true;\n\t\t\t\telse\n\t\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t# Check if it's an crypted md5\n\t\t\telseif (strstr($cryptedpassword,'$1$')) {\n\n\t\t\t\t# Make sure that web server supports md5 crypt\n\t\t\t\tif (! defined('CRYPT_MD5') || CRYPT_MD5 == 0)\n\t\t\t\t\terror(_('Your system crypt library does not support md5crypt encryption.'),'error','index.php');\n\n\t\t\t\tlist($dummy,$type,$salt,$hash) = explode('$',$cryptedpassword);\n\n\t\t\t\tif (crypt($plainpassword,'$1$'.$salt) == $cryptedpassword)\n\t\t\t\t\treturn true;\n\t\t\t\telse\n\t\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t# Check if it's extended des crypt\n\t\t\telseif (strstr($cryptedpassword,'_')) {\n\n\t\t\t\t# Make sure that web server supports ext_des\n\t\t\t\tif (! defined('CRYPT_EXT_DES') || CRYPT_EXT_DES == 0)\n\t\t\t\t\terror(_('Your system crypt library does not support extended DES encryption.'),'error','index.php');\n\n\t\t\t\tif (crypt($plainpassword,$cryptedpassword) == $cryptedpassword)\n\t\t\t\t\treturn true;\n\t\t\t\telse\n\t\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t# Password is plain crypt\n\t\t\telse {\n\n\t\t\t\tif (crypt($plainpassword,$cryptedpassword) == $cryptedpassword)\n\t\t\t\t\treturn true;\n\t\t\t\telse\n\t\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tbreak;\n\n\t\t# SHA512 crypted passwords\n\t\tcase 'sha512':\n\t\t\tif (strcasecmp(pla_password_hash($plainpassword,'sha512'),'{SHA512}'.$cryptedpassword) == 0)\n\t\t\t\treturn true;\n\t\t\telse\n\t\t\t\treturn false;\n\n\t\t\tbreak;\n\n\t\t# No crypt is given assume plaintext passwords are used\n\t\tdefault:\n\t\t\tif ($plainpassword == $cryptedpassword)\n\t\t\t\treturn true;\n\t\t\telse\n\t\t\t\treturn false;\n\t}\n}\n\n/**\n * Detects password encryption type\n *\n * Returns crypto string listed in braces. If it is 'crypt' password,\n * returns crypto detected in password hash. Function should detect\n * md5crypt, blowfish and extended DES crypt. If function fails to detect\n * encryption type, it returns NULL.\n * @param string Hashed password\n * @return string\n */\nfunction get_enc_type($user_password) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t# Capture the stuff in the { } to determine if this is crypt, md5, etc.\n\t$enc_type = null;\n\n\tif (preg_match('/{([^}]+)}/',$user_password,$enc_type))\n\t\t$enc_type = strtolower($enc_type[1]);\n\telse\n\t\treturn null;\n\n\t# Handle crypt types\n\tif (strcasecmp($enc_type,'crypt') == 0) {\n\n\t\t# No need to check for standard crypt, because enc_type is already equal to 'crypt'.\n\t\tif (preg_match('/{[^}]+}\\\\$1\\\\$+/',$user_password))\n\t\t\t$enc_type = 'md5crypt';\n\n\t\telseif (preg_match('/{[^}]+}\\\\$2+/',$user_password))\n\t\t\t$enc_type = 'blowfish';\n\n\t\telseif (preg_match('/{[^}]+}_+/',$user_password))\n\t\t\t$enc_type = 'ext_des';\n\t}\n\n\treturn $enc_type;\n}\n\n/**\n * Draws an HTML browse button which, when clicked, pops up a DN chooser dialog.\n * @param string The name of the form element to which this chooser\n *         dialog will publish the user's choice. The form element must be a member\n *         of a form with the \"name\" or \"id\" attribute set in the form tag, and the element\n *         must also define \"name\" or \"id\" for JavaScript to uniquely identify it.\n *         Example $form_element values may include \"creation_form.container\" or\n *         \"edit_form.member_uid\". See /templates/modification/default.php for example usage.\n * @param boolean (optional) If true, the function draws the localized text \"choose\" to the right of the button.\n */\nfunction draw_chooser_link($form,$element,$include_choose_text=true,$rdn='none') {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$href = sprintf(\"javascript:dnChooserPopup('%s','%s','%s');\",$form,$element,$rdn == 'none' ? '' : rawurlencode($rdn));\n\t$title = _('Click to popup a dialog to select an entry (DN) graphically');\n\n\tprintf('<a href=\"%s\" title=\"%s\"><img class=\"chooser\" src=\"%s/find.png\" alt=\"Find\" /></a>',$href,$title,IMGDIR);\n\n\tif ($include_choose_text)\n\t\tprintf('<span class=\"x-small\"><a href=\"%s\" title=\"%s\">%s</a></span>',$href,$title,_('browse'));\n}\n\n/**\n * http://php.net/manual/en/function.ldap-explode-dn.php#34724\n * fixed for:\n * Keep attention on UTF8 encoded DNs. Since openLDAP >=2.1.2\n * ldap_explode_dn turns unprintable chars (in the ASCII sense, UTF8\n * encoded) into \\<hexcode>.\n */\nfunction ldap_explode_dn_patch($dn,$with_attrib) {\n\t$result = ldap_explode_dn($dn,$with_attrib);\n\tif (! $result)\n\t\treturn null;\n\n\t# translate hex code into ascii again\n\tforeach ($result as $key => $value) {\n\t\t$result[$key] = preg_replace_callback(\n\t\t\t\"/\\\\\\([0-9A-Fa-f]{2})/\",\n\t\t\tfunction ($matches) {\n\t\t\t\treturn chr(hexdec($matches[1]));\n\t\t\t},\n\t\t\t$value\n\t\t);\n\t}\n\n\treturn $result;\n}\n\n/**\n * Explode a DN into an array of its RDN parts.\n *\n * NOTE: When a multivalue RDN is passed to ldap_explode_dn, the results returns with 'value + value';\n *\n * <code>\n *  Array (\n *    [0] => uid=ppratt\n *    [1] => ou=People\n *    [2] => dc=example\n *    [3] => dc=com\n *  )\n * </code>\n *\n * @param string The DN to explode.\n * @param int (optional) Whether to include attribute names (see http://php.net/ldap_explode_dn for details)\n * @return array An array of RDN parts of this format:\n */\nfunction pla_explode_dn($dn,$with_attributes=0) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\tglobal $CACHE;\n\n\tif (isset($CACHE['explode'][$dn][$with_attributes])) {\n\t\tif (DEBUG_ENABLED)\n\t\t\tdebug_log('Return CACHED result (%s) for (%s)',1,0,__FILE__,__LINE__,__METHOD__,\n\t\t\t\t$CACHE['explode'][$dn][$with_attributes],$dn);\n\n\t\treturn $CACHE['explode'][$dn][$with_attributes];\n\t}\n\n\t$dn = addcslashes($dn,'<>+\";');\n\n\t# split the dn\n\t$result[0] = ldap_explode_dn_patch(dn_escape($dn),0);\n\t$result[1] = ldap_explode_dn_patch(dn_escape($dn),1);\n\tif (! $result[$with_attributes]) {\n\t\tif (DEBUG_ENABLED)\n\t\t\tdebug_log('Returning NULL - NO result.',1,0,__FILE__,__LINE__,__METHOD__);\n\n\t\treturn array();\n\t}\n\n\t# Remove our count value that ldap_explode_dn returns us.\n\tunset($result[0]['count']);\n\tunset($result[1]['count']);\n\n\t# Record the forward and reverse entries in the cache.\n\tforeach ($result as $key => $value) {\n\t\t# translate hex code into ascii for display\n\t\t$result[$key] = dn_unescape($value);\n\n\t\t$CACHE['explode'][implode(',',$result[0])][$key] = $result[$key];\n\t\t$CACHE['explode'][implode(',',array_reverse($result[0]))][$key] = array_reverse($result[$key]);\n\t}\n\n\tif (DEBUG_ENABLED)\n\t\tdebug_log('Returning (%s)',1,0,__FILE__,__LINE__,__METHOD__,$result[$with_attributes]);\n\n\treturn $result[$with_attributes];\n}\n\n/**\n * Parse a DN and escape any special characters\n */\nfunction dn_escape($dn) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$olddn = $dn;\n\n\t# Check if the RDN has a comma and escape it.\n\twhile (preg_match('/([^\\\\\\\\]),(\\s*[^=]*\\s*),/',$dn))\n\t\t$dn = preg_replace('/([^\\\\\\\\]),(\\s*[^=]*\\s*),/','$1\\\\\\\\2C$2,',$dn);\n\n\t$dn = preg_replace('/([^\\\\\\\\]),(\\s*[^=]*\\s*)([^,])$/','$1\\\\\\\\2C$2$3',$dn);\n\n\tif (DEBUG_ENABLED)\n\t\tdebug_log('Returning (%s)',1,0,__FILE__,__LINE__,__METHOD__,$dn);\n\n\treturn $dn;\n}\n\n/**\n * Parse a DN and unescape any special characters\n */\nfunction dn_unescape($dn) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\tif (is_array($dn)) {\n\t\t$a = array();\n\n\t\tforeach ($dn as $key => $rdn)\n\t\t\t$a[$key] = preg_replace_callback('/\\\\\\([0-9A-Fa-f]{2})/',\n\t\t\t\tfunction ($r) {\n\t\t\t\t\treturn chr(hexdec($r[1]));\n\t\t\t\t},\n\t\t\t\t$rdn\n\t\t\t);\n\n\t\treturn $a;\n\n\t} else {\n\t\treturn preg_replace_callback('/\\\\\\([0-9A-Fa-f]{2})/',\n\t\t\tfunction ($r) {\n\t\t\t\treturn chr(hexdec($r[1]));\n\t\t\t},\n\t\t\t$dn\n\t\t);\n\t}\n}\n\n/**\n * Fetches the URL for the specified item. This is a convenience function for\n * fetching project HREFs (like bugs)\n *\n * @param string One of \"open_bugs\", \"add_bug\", \"donate\", or \"add_rfe\"\n *               (rfe = request for enhancement)\n * @return string The URL to the requested item.\n */\nfunction get_href($type,$extra_info='') {\n\t$pla = 'http://phpldapadmin.sourceforge.net';\n\n\tswitch($type) {\n\t\tcase 'add_bug':\n\t\t\treturn 'https://github.com/leenooks/phpLDAPadmin/issues';\n\t\tcase 'add_rfe':\n\t\t\treturn 'https://github.com/leenooks/phpLDAPadmin/issues';\n\t\tcase 'credits':\n\t\t\treturn sprintf('%s/Credits',$pla);\n\t\tcase 'documentation':\n\t\t\treturn sprintf('%s/Documentation',$pla);\n\t\tcase 'donate':\n\t\t\treturn 'https://sourceforge.net/donate/index.php?group_id=61828';\n\t\tcase 'forum':\n\t\t\treturn 'https://stackoverflow.com/questions/tagged/phpldapadmin';\n\t\tcase 'web':\n\t\t\treturn sprintf('%s',$pla);\n\t\tdefault:\n\t\t\treturn null;\n\t}\n}\n\n/**\n * Returns the current time as a double (including micro-seconds).\n *\n * @return double The current time in seconds since the beginning of the UNIX epoch (Midnight Jan. 1, 1970)\n */\nfunction utime() {\n\t$time = explode(' ',microtime());\n\t$usec = (double)$time[0];\n\t$sec = (double)$time[1];\n\treturn $sec + $usec;\n}\n\n/**\n * Converts an array to a query-string with the option to exclude certain variables\n * from the returned query string. This is convenient if callers want to convert the\n * current GET query string or POST array into a string and replace certain\n * variables with their own.\n *\n * @param array The associate array to convert whose form is such that the keys are the\n *              names of the variables and the values are said variables' values like this:\n *              <code>\n *               Array (\n *                 [server_id] = 0,\n *                 [dn] = \"dc=example,dc=com\",\n *                 [attr] = \"sn\"\n *               )\n *              </code>\n *              This will produce a string like this: \"server_id=0&dn=dc=example,dc=com&attr=sn\"\n * @param array (optional) An array of variables to exclude in the resulting string\n * @return string The string created from the array.\n */\nfunction array_to_query_string($array,$exclude_vars=array()) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\tif (! is_array($array) || ! count($array))\n\t\treturn '';\n\n\t$str = '';\n\t$i = 0;\n\tforeach ($array as $name => $val)\n\t\tif (! in_array($name,$exclude_vars))\n\t\t\tif (is_array($val))\n\t\t\t\tforeach ($val as $v) {\n\t\t\t\t\tif ($i++ > 0)\n\t\t\t\t\t\t$str .= '&';\n\n\t\t\t\t\t$str .= sprintf('%s[]=%s',rawurlencode($name),rawurlencode($v));\n\t\t\t\t}\n\n\t\t\telse {\n\t\t\t\tif ($i++ > 0)\n\t\t\t\t\t$str .= '&';\n\n\t\t\t\t$str .= sprintf('%s=%s',rawurlencode($name),rawurlencode($val));\n\t\t\t}\n\n\treturn $str;\n}\n\n/**\n * Reverses a DN such that the top-level RDN is first and the bottom-level RDN is last\n * For example:\n * <code>\n *   cn=Brigham,ou=People,dc=example,dc=com\n * </code>\n * Becomes:\n * <code>\n *   dc=com,dc=example,ou=People,cn=Brigham\n * </code>\n * This makes it possible to sort lists of DNs such that they are grouped by container.\n *\n * @param string The DN to reverse\n * @return string The reversed DN\n *\n * @see pla_compare_dns\n * @see pla_explode_dns\n */\nfunction pla_reverse_dn($dn) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\treturn (implode(',',array_reverse(pla_explode_dn($dn))));\n}\n\n/**\n * Attribute sorting\n */\nfunction sortAttrs($a,$b) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\tif ($a == $b)\n\t\treturn 0;\n\n\t$server = $_SESSION[APPCONFIG]->getServer(get_request('server_id','REQUEST'));\n\t$attrs_display_order = arrayLower($_SESSION[APPCONFIG]->getValue('appearance','attr_display_order'));\n\n\t# Check if $a is in $attrs_display_order, get its key\n\t$a_key = array_search($a->getName(),$attrs_display_order);\n\t$b_key = array_search($b->getName(),$attrs_display_order);\n\n\tif ((! $a_key) && ($a_key !== 0))\n\t\tif ((! $a_key = array_search(strtolower($a->getFriendlyName()),$attrs_display_order)) && ($a_key !== 0))\n\t\t\t$a_key = count($attrs_display_order)+1;\n\n\tif ((! $b_key) && ($b_key !== 0))\n\t\tif ((! $b_key = array_search(strtolower($b->getFriendlyName()),$attrs_display_order)) && ($b_key !== 0))\n\t\t\t$b_key = count($attrs_display_order)+1;\n\n\t# Case where neither $a, nor $b are in $attrs_display_order, $a_key = $b_key = one greater than num elements.\n\t# So we sort them alphabetically\n\tif ($a_key === $b_key)\n\t\treturn strcasecmp($a->getFriendlyName(),$b->getFriendlyName());\n\n\t# Case where at least one attribute or its friendly name is in $attrs_display_order\n\t# return -1 if $a before $b in $attrs_display_order\n\treturn ($a_key < $b_key) ? -1 : 1;\n}\n\n/**\n * Reads an array and returns the array values back in lower case\n *\n * @param array $array The array to convert the values to lowercase.\n * @returns array Array with values converted to lowercase.\n */\nfunction arrayLower($array) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\tif (! is_array($array))\n\t\treturn $array;\n\n\t$newarray = array();\n\tforeach ($array as $key => $value)\n\t\t$newarray[$key] = strtolower($value);\n\n\treturn $newarray;\n}\n\n/**\n * Checks if a string exists in an array, ignoring case.\n *\n * @param string What you are looking for\n * @param array The array that you think it is in.\n * @return boolean True if its there, false if its not.\n */\nfunction in_array_ignore_case($needle,$haystack) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\tif (! is_array($haystack))\n\t\treturn false;\n\n\tif (! is_string($needle))\n\t\treturn false;\n\n\t$return = false;\n\n\tforeach ($haystack as $element) {\n\t\tif (is_string($element) && (strcasecmp($needle,$element) == 0)) {\n\t\t\t$return = true;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (DEBUG_ENABLED)\n\t\tdebug_log('Returning (%s)',1,0,__FILE__,__LINE__,__METHOD__,$return);\n\n\treturn $return;\n}\n\n/**\n * Gets a DN string using the user-configured tree_display_format string to format it.\n */\nfunction draw_formatted_dn($server,$entry) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$dn = $entry->getDn();\n\n\t$formats = $_SESSION[APPCONFIG]->getValue('appearance','tree_display_format');\n\n\tforeach ($formats as $format) {\n\t\t$has_none = false;\n\t\tpreg_match_all('/%[a-zA-Z_0-9]+/',$format,$tokens);\n\t\t$tokens = $tokens[0];\n\n\t\tif (DEBUG_ENABLED)\n\t\t\tdebug_log('The tokens are (%s)',1,0,__FILE__,__LINE__,__METHOD__,$tokens);\n\n\t\tforeach ($tokens as $token) {\n\t\t\tif (strcasecmp($token,'%dn') == 0)\n\t\t\t\t$format = str_replace($token,pretty_print_dn($dn),$format);\n\n\t\t\telseif (strcasecmp($token,'%rdn') == 0)\n\t\t\t\t$format = str_replace($token,pretty_print_dn($entry->getRDN()),$format);\n\n\t\t\telseif (strcasecmp($token,'%rdnvalue') == 0) {\n\t\t\t\t$rdn = get_rdn($dn,0,true);\n\t\t\t\t$rdn_value = explode('=',$rdn,2);\n\t\t\t\t$rdn_value = $rdn_value[1];\n\t\t\t\t$format = str_replace($token,$rdn_value,$format);\n\n\t\t\t} else {\n\t\t\t\t$attr_name = str_replace('%','',$token);\n\t\t\t\t$attr_values = $server->getDNAttrValue($dn,$attr_name);\n\n\t\t\t\tif (is_null($attr_values) || (count($attr_values) <= 0)) {\n\t\t\t\t\t$display = '&lt;'._('none').'&gt;';\n\t\t\t\t\t$has_none = true;\n\n\t\t\t\t} elseif (is_array($attr_values))\n\t\t\t\t\t$display = implode(', ',$attr_values);\n\n\t\t\t\telse\n\t\t\t\t\t$display = $attr_values;\n\n\t\t\t\t$format = str_replace($token,$display,$format);\n\t\t\t}\n\t\t}\n\n\t\t# If this format has all values available, use it. Otherwise, try the next one\n\t\tif (!$has_none)\n\t\t\treturn $format;\n\t}\n\n\treturn $format;\n}\n\n/**\n * Server html select list\n */\nfunction server_select_list($selected=null,$logged_on=false,$name='index',$isVisible=true,$js=null) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$count = 0;\n\t$server_menu_html = sprintf('<select name=\"%s\" id=\"%s\" %s>',$name,$name,$js);\n\n\tforeach ($_SESSION[APPCONFIG]->getServerList($isVisible) as $index => $server) {\n\t\tif ($server->isVisible()) {\n\n\t\t\tif ($logged_on && ! $server->isLoggedIn())\n\t\t\t\tcontinue;\n\n\t\t\t$count++;\n\t\t\t$server_menu_html .= sprintf('<option value=\"%s\" %s>%s</option>',\n\t\t\t\t$server->getIndex(),($server->getIndex() == $selected ? 'selected=\"selected\"' : ''),$server->getName());\n\n\t\t\t# We will set this variable, in case there is only 1 hit.\n\t\t\t$selected_server = $server;\n\t\t}\n\t}\n\n\t$server_menu_html .= '</select>';\n\n\tif ($count > 1)\n\t\treturn $server_menu_html;\n\n\telseif ($count)\n\t\treturn sprintf('%s <input type=\"hidden\" name=\"%s\" value=\"%s\" />',\n\t\t\t$selected_server->getName(),$name,$selected_server->getIndex());\n\n\telse\n\t\treturn '';\n}\n\n/**\n * Converts a little-endian hex-number to one, that 'hexdec' can convert\n */\nfunction littleEndian($hex) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$result = '';\n\n\tfor ($x=strlen($hex)-2;$x>= 0;$x=$x-2)\n\t\t$result .= substr($hex,$x,2);\n\n\treturn $result;\n}\n\nfunction binSIDtoText($binsid) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$hex_sid = bin2hex($binsid);\n\t$rev = hexdec(substr($hex_sid,0,2)); // Get revision-part of SID\n\t$subcount = hexdec(substr($hex_sid,2,2)); // Get count of sub-auth entries\n\t$auth = hexdec(substr($hex_sid,4,12)); // SECURITY_NT_AUTHORITY\n\n\t$result = \"$rev-$auth\";\n\n\tfor ($x=0;$x<$subcount;$x++) {\n\t\t$subauth[$x] = hexdec(littleEndian(substr($hex_sid,16+($x*8),8))); // get all SECURITY_NT_AUTHORITY\n\t\t$result .= sprintf('-%s',$subauth[$x]);\n\t}\n\n\treturn $result;\n}\n\n/**\n * Query LDAP and return a hash.\n *\n * @param string The base DN to use.\n * @param string LDAP Query filter.\n * @param string LDAP attribute to use as key.\n * @param array Attributes to use as values.\n * @param boolean Specify false to not sort results by DN\n *                or true to have the returned array sorted by DN (uses ksort)\n *                or an array of attribute names to sort by attribute values\n * @return array Array of values keyed by $key.\n */\nfunction return_ldap_hash($base,$filter,$key,$attrs,$sort=true) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$server = $_SESSION[APPCONFIG]->getServer(get_request('server_id','REQUEST'));\n\t$key = strtolower($key);\n\n\t$query = array();\n\t$query['base'] = $base;\n\t$query['filter'] = $filter;\n\t$query['attrs'] = $attrs;\n\t$search = $server->query($query,null);\n\n\t$results = array();\n\n\tforeach ($search as $dn => $values)\n\t\tif (isset($values[$key]))\n\t\t\tif (is_array($values[$key]))\n\t\t\t\tforeach ($values[$key] as $i => $k)\n\t\t\t\t\tforeach ($attrs as $attr) {\n\t\t\t\t\t\t$lattr = strtolower($attr);\n\t\t\t\t\t\tif (isset($values[$lattr])) {\n\t\t\t\t\t\t\t$v = '';\n\n\t\t\t\t\t\t\tif (is_array($values[$lattr]) && isset($values[$lattr][$i]))\n\t\t\t\t\t\t\t\t$v = $values[$lattr][$i];\n\n\t\t\t\t\t\t\tif (is_string($v) && (strlen($v) > 0))\n\t\t\t\t\t\t\t\t$results[$k][$attr] = $v;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\telse\n\t\t\t\tforeach ($attrs as $attr) {\n\t\t\t\t\t$lattr = strtolower($attr);\n\t\t\t\t\tif (isset($values[$lattr]))\n\t\t\t\t\t\t$results[$values[$key]][$attr] = $values[$lattr];\n\t\t\t\t}\n\n\tif ($sort)\n\t\tmasort($results,is_array($sort) ? implode(',',$sort) : 'dn');\n\n\treturn $results;\n}\n\n/**\n * This function returns a string automatically generated\n * based on the criteria defined in the array $criteria in config.php\n */\nfunction password_generate() {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$no_use_similiar = ! $_SESSION[APPCONFIG]->getValue('password','use_similar');\n\t$lowercase = $_SESSION[APPCONFIG]->getValue('password','lowercase');\n\t$uppercase = $_SESSION[APPCONFIG]->getValue('password','uppercase');\n\t$digits = $_SESSION[APPCONFIG]->getValue('password','numbers');\n\t$punctuation = $_SESSION[APPCONFIG]->getValue('password','punctuation');\n\t$length = $_SESSION[APPCONFIG]->getValue('password','length');\n\n\t$outarray = array();\n\n\tif ($no_use_similiar) {\n\t\t$raw_lower = 'a b c d e f g h k m n p q r s t u v w x y z';\n\t\t$raw_numbers = '2 3 4 5 6 7 8 9';\n\t\t$raw_punc = '# $ % ^ & * ( ) _ - + = . , [ ] { } :';\n\n\t} else {\n\t\t$raw_lower = 'a b c d e f g h i j k l m n o p q r s t u v w x y z';\n\t\t$raw_numbers = '1 2 3 4 5 6 7 8 9 0';\n\t\t$raw_punc = '# $ % ^ & * ( ) _ - + = . , [ ] { } : |';\n\t}\n\n\t$llower = explode(' ',$raw_lower);\n\tshuffle($llower);\n\t$lupper = explode(' ',strtoupper($raw_lower));\n\tshuffle($lupper);\n\t$numbers = explode(' ',$raw_numbers);\n\tshuffle($numbers);\n\t$punc = explode(' ',$raw_punc);\n\tshuffle($punc);\n\n\tif ($lowercase > 0)\n\t\t$outarray = array_merge($outarray,a_array_rand($llower,$lowercase));\n\n\tif ($uppercase > 0)\n\t\t$outarray = array_merge($outarray,a_array_rand($lupper,$uppercase));\n\n\tif ($digits > 0)\n\t\t$outarray = array_merge($outarray,a_array_rand($numbers,$digits));\n\n\tif ($punctuation > 0)\n\t\t$outarray = array_merge($outarray,a_array_rand($punc,$punctuation));\n\n\t$num_spec = $lowercase + $uppercase + $digits + $punctuation;\n\n\tif ($num_spec < $length) {\n\t\t$leftover = array();\n\t\tif ($lowercase > 0)\n\t\t\t$leftover = array_merge($leftover,$llower);\n\t\tif ($uppercase > 0)\n\t\t\t$leftover = array_merge($leftover,$lupper);\n\t\tif ($digits > 0)\n\t\t\t$leftover = array_merge($leftover,$numbers);\n\t\tif ($punctuation > 0)\n\t\t\t$leftover = array_merge($leftover,$punc);\n\n\t\tif (count($leftover) == 0)\n\t\t\t$leftover = array_merge($leftover,$llower,$lupper,$numbers,$punc);\n\n\t\tshuffle($leftover);\n\t\t$outarray = array_merge($outarray,a_array_rand($leftover,$length-$num_spec));\n\t}\n\n\tshuffle($outarray);\n\t$return = implode('',$outarray);\n\n\tif (DEBUG_ENABLED)\n\t\tdebug_log('Returning (%s)',1,0,__FILE__,__LINE__,__METHOD__,$return);\n\n\treturn $return;\n}\n\n/**\n * This function returns an array of $num_req values\n * randomly picked from the $input array\n *\n * @param array Array of values\n * @param integer Number of values in returned array\n * @return string The padded string\n */\nfunction a_array_rand($input,$num_req) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\tif (count($input) == 0)\n\t\treturn array();\n\n\tif ($num_req < 1)\n\t\treturn array();\n\n\t$return = array();\n\tif ($num_req > count($input)) {\n\t\tfor($i = 0; $i < $num_req; $i++) {\n\t\t\t$idx = array_rand($input,1);\n\t\t\t$return[] = $input[$idx];\n\t\t}\n\n\t} else {\n\t\t$idxlist = array_rand($input,$num_req);\n\t\tif ($num_req == 1)\n\t\t\t$idxlist = array($idxlist);\n\n\t\tfor($i = 0; $i < count($idxlist); $i++)\n\t\t\t$return[] = $input[$idxlist[$i]];\n\t}\n\n\tif (DEBUG_ENABLED)\n\t\tdebug_log('Returning (%s)',1,0,__FILE__,__LINE__,__METHOD__,$return);\n\n\treturn $return;\n}\n\n/**\n * This is for Opera. By putting \"random junk\" in the query string, it thinks\n * that it does not have a cached version of the page, and will thus\n * fetch the page rather than display the cached version\n */\nfunction random_junk() {\n\t$time = gettimeofday();\n\treturn md5(strtotime('now').$time['usec']);\n}\n\n/**\n * Returns a HTML id that can be used in the URL after the #.\n *\n * @param string The DN to pretty-print.\n * @return string\n */\nfunction htmlid($sid,$dn) {\n\treturn sprintf('SID%s:%s',$sid,preg_replace('/[\\ =,]/','_',$dn));\n}\n\n/**\n * Is PLA configured for AJAX display\n */\nfunction isAjaxEnabled() {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\tif (isset($_SESSION[APPCONFIG]))\n\t\treturn ($_SESSION[APPCONFIG]->getValue('appearance','tree') == 'AJAXTree');\n\telse\n\t\treturn false;\n}\n?>\n"], "fixing_code": ["<?php\n/**\n * A collection of common generic functions used throughout the application.\n *\n * @author The phpLDAPadmin development team\n * @package phpLDAPadmin\n */\n\n/**\n * @package phpLDAPadmin\n * @subpackage Functions\n */\n\n/**\n */\ndefine('HTDOCDIR',sprintf('%s/',realpath(LIBDIR.'../htdocs/')));\ndefine('LANGDIR',sprintf('%s/',realpath(LIBDIR.'../locale/')));\ndefine('CONFDIR',sprintf('%s/',realpath(LIBDIR.'../config')));\ndefine('QUERYDIR',sprintf('%s/',realpath(LIBDIR.'../queries/')));\ndefine('TMPLDIR',sprintf('%s/',realpath(LIBDIR.'../templates/')));\ndefine('DOCDIR',sprintf('%s/',realpath(LIBDIR.'../doc/')));\ndefine('HOOKSDIR',sprintf('%s/',realpath(LIBDIR.'../hooks/')));\ndefine('JSDIR','js/');\n\n/**\n * Supplimental functions\n * This list is a list of supplimental functions that are used throughout\n * PLA. The order here IS important - so that files that refer to\n * functions defined in other files need to be listed after those files.\n */\n$app['function_files'] = array(\n\t# Functions for managing the session (app_session_start(), etc.)\n\tLIBDIR.'session_functions.php',\n\t# Functions for reading the server schema\n\tLIBDIR.'schema_functions.php',\n\t# Functions for template manipulation.\n\tLIBDIR.'template_functions.php',\n\t# Functions for hashing passwords with OpenSSL binary (only if mhash not present)\n\tLIBDIR.'emuhash_functions.php',\n\t# Functions for creating Samba passwords\n\tLIBDIR.'createlm.php',\n\t# Datasource functions\n\tLIBDIR.'ds.php',\n\t# Functions for rendering the page\n\tLIBDIR.'page.php'\n);\n\nif (file_exists(LIBDIR.'functions.custom.php'))\n\tarray_push($app['function_files'],LIBDIR.'functions.custom.php');\n\n/**\n * Loads class definition\n */\nfunction pla_autoload($className) {\n\tif (file_exists(HOOKSDIR.\"classes/$className.php\"))\n\t\trequire_once(HOOKSDIR.\"classes/$className.php\");\n\telseif (file_exists(LIBDIR.\"$className.php\"))\n\t\trequire_once(LIBDIR.\"$className.php\");\n\telseif (file_exists(LIBDIR.\"ds_$className.php\"))\n\t\trequire_once(LIBDIR.\"ds_$className.php\");\n\telse\n\t\tsystem_message(array(\n\t\t\t'title'=>_('Generic Error'),\n\t\t\t'body'=>sprintf('%s: %s [%s]',\n\t\t\t\t__METHOD__,_('Called to load a class that cant be found'),$className),\n\t\t\t'type'=>'error'));\n}\n\nif (version_compare(phpversion(), '7.0', '>=')) {\n\tspl_autoload_register('pla_autoload');\n} else {\n\teval('function __autoload($className) {pla_autoload($className);}');\n}\n\n/**\n * Strips all slashes from the specified array in place (pass by ref).\n * @param Array The array to strip slashes from, typically one of\n *        $_GET, $_POST, or $_COOKIE.\n */\nfunction array_stripslashes(&$array) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\tif (is_array($array))\n\t\twhile (list($key) = each($array))\n\t\t\tif (is_array($array[$key]) && $key != $array)\n\t\t\t\tarray_stripslashes($array[$key]);\n\t\t\telse\n\t\t\t\t$array[$key] = stripslashes($array[$key]);\n}\n\n/**\n * Compatibility Functions\n * These functions exist, so that a standard function can be used in new applications, and they\n * map to already defined functions in older applications.\n */\n\n/**\n * If gettext is not available in PHP, then this will provide compatibility for it.\n */\nif (! function_exists('_')) {\n\tfunction _($msg) {\n\t\treturn $msg;\n\t}\n}\n\n/**\n * Generic Utility Functions\n */\n\n/**\n * Custom error handling function.\n * When a PHP error occurs, PHP will call this function rather than printing\n * the typical PHP error string. This provides the application the ability to\n * format an error message so that it looks better.\n * Optionally, it can present a link so that a user can search/submit bugs.\n * This function is not to be called directly. It is exclusively for the use of\n * PHP internally. If this function is called by PHP from within a context\n * where error handling has been disabled (ie, from within a function called\n * with \"@\" prepended), then this function does nothing.\n *\n * @param int The PHP error number that occurred (ie, E_ERROR, E_WARNING, E_PARSE, etc).\n * @param string The PHP error string provided (ie, \"Warning index \"foo\" is undefined)\n * @param string The file in which the PHP error ocurred.\n * @param int The line number on which the PHP error ocurred\n * @see set_error_handler\n */\nfunction app_error_handler($errno,$errstr,$file,$lineno) {\n\tif (defined('DEBUG_ENABLED') && DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t/**\n\t * error_reporting will be 0 if the error context occurred\n\t * within a function call with '@' preprended (ie, @ldap_bind() );\n\t * So, don't report errors if the caller has specifically\n\t * disabled them with '@'\n\t */\n\tif (ini_get('error_reporting') == 0 || error_reporting() == 0)\n\t\treturn;\n\n\t$file = basename($file);\n\t$caller = basename($_SERVER['PHP_SELF']);\n\t$errtype = '';\n\n\tswitch ($errno) {\n\t\tcase E_STRICT: $errtype = 'E_STRICT'; break;\n\t\tcase E_ERROR: $errtype = 'E_ERROR'; break;\n\t\tcase E_WARNING: $errtype = 'E_WARNING'; break;\n\t\tcase E_PARSE: $errtype = 'E_PARSE'; break;\n\t\tcase E_NOTICE: $errtype = 'E_NOTICE'; break;\n\t\tcase E_CORE_ERROR: $errtype = 'E_CORE_ERROR'; break;\n\t\tcase E_CORE_WARNING: $errtype = 'E_CORE_WARNING'; break;\n\t\tcase E_COMPILE_ERROR: $errtype = 'E_COMPILE_ERROR'; break;\n\t\tcase E_COMPILE_WARNING: $errtype = 'E_COMPILE_WARNING'; break;\n\t\tcase E_USER_ERROR: $errtype = 'E_USER_ERROR'; break;\n\t\tcase E_USER_WARNING: $errtype = 'E_USER_WARNING'; break;\n\t\tcase E_USER_NOTICE: $errtype = 'E_USER_NOTICE'; break;\n\t\tcase E_ALL: $errtype = 'E_ALL'; break;\n\n\t\tdefault: $errtype = sprintf('%s: %s',_('Unrecognized error number'),$errno);\n\t}\n\n\t# Take out extra spaces in error strings.\n\t$errstr = preg_replace('/\\s+/',' ',$errstr);\n\n\tif ($errno == E_NOTICE) {\n\t\t$body = '<table class=\"notice\">';\n\t\t$body .= sprintf('<tr><td>%s:</td><td><b>%s</b> (<b>%s</b>)</td></tr>',_('Error'),$errstr,$errtype);\n\t\t$body .= sprintf('<tr><td>%s:</td><td><b>%s</b> %s <b>%s</b>, %s <b>%s</b></td></tr>',\n\t\t\t_('File'),$file,_('line'),$lineno,_('caller'),$caller);\n\t\t$body .= sprintf('<tr><td>Versions:</td><td>PLA: <b>%s</b>, PHP: <b>%s</b>, SAPI: <b>%s</b></td></tr>',\n\t\t\tapp_version(),phpversion(),php_sapi_name());\n\t\t$body .= sprintf('<tr><td>Web server:</td><td><b>%s</b></td></tr>',isset($_SERVER['SERVER_SOFTWARE']) ? $_SERVER['SERVER_SOFTWARE'] : 'SCRIPT');\n\n\t\tif (function_exists('get_href'))\n\t\t\t$body .= sprintf('<tr><td colspan=\"2\"><a href=\"%s\" onclick=\"target=\\'_blank\\';\"><center>%s.</center></a></td></tr>',\n\t\t\t\tget_href('search_bug',\"&summary_keyword=\".rawurlencode($errstr)),\n\t\t\t\t_('Please check and see if this bug has been reported'));\n\t\t$body .= '</table>';\n\n\t\tsystem_message(array(\n\t\t\t'title'=>_('You found a non-fatal phpLDAPadmin bug!'),\n\t\t\t'body'=>$body,\n\t\t\t'type'=>'error'));\n\n\t\treturn;\n\t}\n\n\t# If this is a more serious error, call the error call.\n\terror(sprintf('%s: %s',$errtype,$errstr),'error',null,true,true);\n}\n\n/**\n * Returns the application name.\n */\nfunction app_name() {\n\treturn 'phpLDAPadmin';\n}\n\n/**\n * Returns the application version currently running. The version\n * is read from the file named VERSION.\n *\n * @return string The current version as read from the VERSION file.\n */\nfunction app_version() {\n\tstatic $CACHE = null;\n\n\tif ($CACHE)\n\t\treturn $CACHE;\n\n\t$version_file = realpath(LIBDIR.'../VERSION');\n\tif (! file_exists($version_file))\n\t\t$CACHE = 'UNKNOWN';\n\n\telse {\n\t\t$version = rtrim(file_get_contents($version_file));\n\n\t\t$CACHE = preg_replace('/^RELEASE-([0-9\\.]+(-.*)*)$/','$1',$version);\n\n\t\t# Check if we are a CVS copy.\n\t\tif (preg_match('/^(DEVEL)?$/',$CACHE))\n\t\t\t$CACHE = 'DEVEL';\n\n\t\t# Check if we are special DEVEL version\n\t\telseif (preg_match('/^DEVEL-([0-9\\.]+)+$/',$CACHE)) {}\n\n\t\t# If return is still the same as version, then the tag is not one we expect.\n\t\telseif ($CACHE == $version)\n\t\t\t$CACHE = 'UNKNOWN';\n\t}\n\n\treturn $CACHE;\n}\n\n/**\n * This function will convert the browser two character language into the\n * default 5 character language, where the country portion should NOT be\n * assumed to be upper case characters of the first two characters.\n */\nfunction auto_lang($lang) {\n\tswitch ($lang) {\n\t\tcase 'ja': return 'ja_JP';\n\t\tcase 'cs': return 'cs_CZ';\n\t\tdefault: return sprintf('%s_%s',$lang,strtoupper($lang));\n\t}\n}\n\n/**\n * Makes sure that the config file is properly setup.\n */\nfunction check_config($config_file) {\n\t# Read in config_default.php\n\trequire_once LIBDIR.'config_default.php';\n\n\t# Make sure their PHP version is current enough\n\tif (strcmp(phpversion(),REQUIRED_PHP_VERSION) < 0)\n\t\tsystem_message(array(\n\t\t\t'title'=>_('Incorrect version of PHP'),\n\t\t\t'body'=>sprintf('phpLDAPadmin requires PHP version %s or greater.<br /><small>(You are using %s)</small>',\n\t\t\t\tREQUIRED_PHP_VERSION,phpversion()),\n\t\t\t'type'=>'error'));\n\n\t$config = new Config;\n\n\tif (file_exists(LIBDIR.'config_custom.php') && is_readable(LIBDIR.'config_custom.php'))\n\t\tinclude LIBDIR.'config_custom.php';\n\n\tob_start();\n\trequire $config_file;\n\t$str = '';\n\tif (ob_get_level()) {\n\t\t$str = ob_get_contents();\n\t\tob_end_clean();\n\t}\n\n\tif ($str) {\n\t\t$str = strip_tags($str);\n\t\t$matches = array();\n\t\tpreg_match('/(.*):\\s+(.*):.*\\s+on line (\\d+)/',$str,$matches);\n\n\t\tif (isset($matches[1]) && isset($matches[2]) && isset($matches[3])) {\n\t\t\t$error_type = $matches[1];\n\t\t\t$error = $matches[2];\n\t\t\t$line_num = $matches[3];\n\n\t\t\t$file = file($config_file);\n\n\t\t\t$body = '<h3 class=\"title\">Config file ERROR</h3>';\n\t\t\t$body .= sprintf('<h3 class=\"subtitle\">%s (%s) on line %s</h3>',$error_type,$error,$line_num);\n\n\t\t\t$body .= '<center>';\n\t\t\t$body .= sprintf('Looks like your config file has an ERROR on line %s.<br />',$line_num);\n\t\t\t$body .= 'Here is a snippet around that line <br />';\n\t\t\t$body .= '<br />'.\"\\n\";\n\n\t\t\t$body .= '<div style=\"text-align: left; font-family: monospace; margin-left: 80px; margin-right: 80px; border: 1px solid black; padding: 10px;\">';\n\n\t\t\tfor ($i = $line_num-9; $i<$line_num+5; $i++) {\n\t\t\t\tif ($i+1 == $line_num)\n\t\t\t\t\t$body .= '<div style=\"color:red;background:#fdd\">';\n\n\t\t\t\tif ($i < 0)\n\t\t\t\t\tcontinue;\n\n\t\t\t\t$body .= sprintf('<b>%s</b>: %s<br />',$i+1,$file[$i]);\n\n\t\t\t\tif ($i+1 == $line_num)\n\t\t\t\t\t$body .= '</div>';\n\t\t\t}\n\n\t\t\t$body .= '</div>';\n\t\t\t$body .= '<br />';\n\t\t\t$body .= 'Hint: Sometimes these errors are caused by lines <b>preceding</b> the line reported.';\n\t\t\t$body .= '</center>';\n\n\t\t\t$block = new block();\n\t\t\t$block->SetBody($body);\n\t\t\t$www['page'] = new page();\n\t\t\t$www['page']->block_add('body',$block);\n\t\t\t$www['page']->display();\n\n\t\t\tdie();\n\t\t}\n\t}\n\n\t# Check for server definitions.\n\tif (! isset($servers) || count($servers->GetServerList()) == 0)\n\t\terror(_('Your config.php is missing Server Definitions. Please see the sample file config/config.php.example.'),'error','index.php',true);\n\n\t$config->setServers($servers);\n\n\t# Check the memory limit parameter.\n\tif ((ini_get('memory_limit') > -1) && ini_get('memory_limit') < $config->getValue('session','memorylimit'))\n\t\tsystem_message(array(\n\t\t\t'title'=>_('Memory Limit low.'),\n\t\t\t'body'=>sprintf('Your php memory limit is low - currently %s, you should increase it to atleast %s. This is normally controlled in /etc/php.ini.',\n\t\t\t\tini_get('memory_limit'),$config->getValue('session','memorylimit')),\n\t\t\t'type'=>'error'));\n\n\treturn $config;\n}\n\n/**\n * Commands available in the control_panel of the page\n *\n * @return array\n */\nfunction cmd_control_pane($type) {\n\tif (defined('DEBUG_ENABLED') && DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\tswitch ($type) {\n\t\tcase 'main' :\n\t\t\treturn array(\n\t\t\t\t'home'=>array(\n\t\t\t\t\t'title'=>_('Home'),\n\t\t\t\t\t'enable'=>true,\n\t\t\t\t\t'link'=>sprintf('href=\"index.php\" title=\"%s\"',_('Home')),\n\t\t\t\t\t'image'=>sprintf('<img src=\"%s/home-big.png\" alt=\"%s\" />',IMGDIR,_('Home'))),\n\n\t\t\t\t'purge'=>array(\n\t\t\t\t\t'title'=>_('Purge caches'),\n\t\t\t\t\t'enable'=>isset($_SESSION[APPCONFIG]) ? $_SESSION[APPCONFIG]->isCommandAvailable('script','purge_cache') : false,\n\t\t\t\t\t'link'=>sprintf('href=\"cmd.php?cmd=purge_cache\" onclick=\"return ajDISPLAY(\\'BODY\\',\\'cmd=purge_cache\\',\\'%s\\');\" title=\"%s\"',\n\t\t\t\t\t\t_('Clearing cache'),_('Purge caches')),\n\t\t\t\t\t'image'=>sprintf('<img src=\"%s/trash-big.png\" alt=\"%s\" />',IMGDIR,_('Purge caches'))),\n\n\t\t\t\t'hide_debug_info'=>array(\n\t\t\t\t\t'title'=>_('Show Cache'),\n\t\t\t\t\t'enable'=>isset($_SESSION[APPCONFIG]) ? ($_SESSION[APPCONFIG]->isCommandAvailable('script','show_cache')) && (! $_SESSION[APPCONFIG]->getValue('appearance','hide_debug_info')) : false,\n\t\t\t\t\t'link'=>sprintf('href=\"cmd.php?cmd=show_cache\" onclick=\"return ajDISPLAY(\\'BODY\\',\\'cmd=show_cache\\',\\'%s\\');\" title=\"%s\"',\n\t\t\t\t\t\t_('Loading'),_('Show Cache'),_('Show Cache')),\n\t\t\t\t\t'image'=>sprintf('<img src=\"%s/debug-cache.png\" alt=\"%s\" />',IMGDIR,_('Show Cache'))),\n\t\t\t);\n\n\t\t\tbreak;\n\n\t\tcase 'top' :\n\t\t\treturn array(\n\t\t\t\t'forum'=>array(\n\t\t\t\t\t'title'=>_('Forum'),\n\t\t\t\t\t'enable'=>isset($_SESSION[APPCONFIG]) ? $_SESSION[APPCONFIG]->isCommandAvailable('cmd','oslinks') : true,\n\t\t\t\t\t'link'=>sprintf('href=\"%s\" title=\"%s\" onclick=\"target=\\'_blank\\';\"',get_href('forum'),_('Forum')),\n\t\t\t\t\t'image'=>sprintf('<img src=\"%s/forum-big.png\" alt=\"%s\" />',IMGDIR,_('Forum'))),\n\n\t\t\t\t'feature'=>array(\n\t\t\t\t\t'title'=>_('Request feature'),\n\t\t\t\t\t'enable'=>isset($_SESSION[APPCONFIG]) ? $_SESSION[APPCONFIG]->isCommandAvailable('cmd','oslinks') : true,\n\t\t\t\t\t'link'=>sprintf('href=\"%s\" title=\"%s\" onclick=\"target=\\'_blank\\';\"',get_href('add_rfe'),_('Request feature')),\n\t\t\t\t\t'image'=>sprintf('<img src=\"%s/request-feature-big.png\" alt=\"%s\" />',IMGDIR,_('Request feature'))),\n\n\t\t\t\t'bug'=>array(\n\t\t\t\t\t'title'=>_('Report a bug'),\n\t\t\t\t\t'enable'=>isset($_SESSION[APPCONFIG]) ? $_SESSION[APPCONFIG]->isCommandAvailable('cmd','oslinks') : true,\n\t\t\t\t\t'link'=>sprintf('href=\"%s\" title=\"%s\" onclick=\"target=\\'_blank\\';\"',get_href('add_bug'),_('Report a bug')),\n\t\t\t\t\t'image'=>sprintf('<img src=\"%s/bug-big.png\" alt=\"%s\" />',IMGDIR,_('Report a bug'))),\n\n\t\t\t\t'donation'=>array(\n\t\t\t\t\t'title'=>_('Donate'),\n\t\t\t\t\t'enable'=>isset($_SESSION[APPCONFIG]) ? $_SESSION[APPCONFIG]->isCommandAvailable('cmd','oslinks') : true,\n\t\t\t\t\t'link'=>sprintf('href=\"%s\" title=\"%s\" onclick=\"target=\\'_blank\\';\"',get_href('donate'),_('Donate')),\n\t\t\t\t\t'image'=>sprintf('<img src=\"%s/smile-big.png\" alt=\"%s\" />',IMGDIR,_('Donate'))),\n\n\t\t\t\t'help'=>array(\n\t\t\t\t\t'title'=>_('Help'),\n\t\t\t\t\t'enable'=>isset($_SESSION[APPCONFIG]) ? $_SESSION[APPCONFIG]->isCommandAvailable('cmd','oslinks') : true,\n\t\t\t\t\t'link'=>sprintf('href=\"%s\" title=\"%s\" onclick=\"target=\\'_blank\\';\"',get_href('documentation'),_('Help')),\n\t\t\t\t\t'image'=>sprintf('<img src=\"%s/help-big.png\" alt=\"%s\" />',IMGDIR,_('Help')))\n\t\t\t);\n\n\t\t\tbreak;\n\t}\n}\n\n/**\n * This function dumps the $variable for debugging purposes\n *\n * @param string|array Variable to dump\n * @param boolean Whether to stop execution or not.\n */\nfunction debug_dump($variable,$die=false,$onlydebugaddr=false) {\n\tif ($onlydebugaddr &&\n\t\tisset($_SESSION[APPCONFIG]) && $_SESSION[APPCONFIG]->getValue('debug','addr') &&\n\t\t$_SERVER['HTTP_X_FORWARDED_FOR'] != $_SESSION[APPCONFIG]->getValue('debug','addr') &&\n\t\t$_SERVER['REMOTE_ADDR'] != $_SESSION[APPCONFIG]->getValue('debug','addr'))\n\t\treturn;\n\n\t$backtrace = debug_backtrace();\n\t$caller['class'] = isset($backtrace[0]['class']) ? $backtrace[0]['class'] : 'N/A';\n\t$caller['function'] = isset($backtrace[0]['function']) ? $backtrace[0]['function'] : 'N/A';\n\t$caller['file'] = isset($backtrace[0]['file']) ? $backtrace[0]['file'] : 'N/A';\n\t$caller['line'] = isset($backtrace[0]['line']) ? $backtrace[0]['line'] : 'N/A';\n\t$caller['debug'] = $variable;\n\n\tprint '<PRE>';\n\tprint_r($caller);\n\tprint '</PRE>';\n\n\tif ($die)\n\t\tdie();\n}\n\n/**\n * This function generates a backtrace\n *\n * @param boolean Whether to stop execution or not.\n */\nfunction debug_dump_backtrace($msg='Calling BackTrace',$die=false) {\n\terror($msg,'note',null,$die,true);\n}\n\n/**\n * Send a debug as a sys message\n */\nfunction debug_sysmsg($msg) {\n\tsystem_message(array('title'=>_('Debug'),'body'=>$msg,'type'=>'debug'));\n}\n\n/**\n * Debug Logging\n *\n * The global debug level is turned on in your configuration file by setting:\n * <code>\n *\t$config->custom->debug['level'] = 255;\n * </code>\n * together with atleast one output direction (currently file and syslog are supported).\n * <code>\n *\t$config->custom->debug['file'] = '/tmp/app_debug.log';\n *\t$config->custom->debug['syslog'] = true;\n * </code>\n *\n * The debug level is turned into binary, then if the message levels bit is on\n * the message will be sent to the debug log. (Thus setting your debug level to 255,\n * all bits on, will results in all messages being printed.)\n *\n * The message level bits are defined here.\n *  0(  1) = Entry/Return results from function calls.\n *  1(  2) = Configuration Processing\n *  2(  4) = Template Processing\n *  3(  8) = Schema Processing\n *  4( 16) = LDAP Server Communication\n *  5( 32) = Tree Processing\n *  7( 64) = Other non generic messages\n *  8(128) = Page Processing\n *  9(256) = Hooks Processing\n * @param string Message to send to syslog\n * @param int Log bit number for this message.\n * @see syslog.php\n */\nfunction debug_log($msg,$level,$indent) {\n\tstatic $debug_file;\n\n\t# In case we are called before we are fully initialised or if debugging is not set.\n\tif (! isset($_SESSION[APPCONFIG])\n\t\t|| ! ($_SESSION[APPCONFIG]->getValue('debug','file') || $_SESSION[APPCONFIG]->getValue('debug','syslog')))\n\t\treturn;\n\n\t$debug_level = $_SESSION[APPCONFIG]->getValue('debug','level');\n\tif (! $debug_level || (! ($level & $debug_level)))\n\t\treturn;\n\n\tif ($_SESSION[APPCONFIG]->getValue('debug','addr'))\n\t\tif (isset($_SERVER['HTTP_X_FORWARDED_FOR']) && $_SERVER['HTTP_X_FORWARDED_FOR'] == $_SESSION[APPCONFIG]->getValue('debug','addr'))\n\t\t\t$debugaddr = true;\n\t\telseif ($_SERVER['REMOTE_ADDR'] == $_SESSION[APPCONFIG]->getValue('debug','addr'))\n\t\t\t$debugaddr = true;\n\t\telse\n\t\t\t$debugaddr = false;\n\n\telse\n\t\t$debugaddr = true;\n\n\tif (! $debugaddr)\n\t\treturn;\n\n\t# If we are limiting debug to a browser, then check that\n\t$caller = basename($_SERVER['PHP_SELF']);\n\n\t$args = func_get_args();\n\t# Discard our first three arguments.\n\tarray_shift($args);\n\tarray_shift($args);\n\tarray_shift($args);\n\n\t# Pull the file/line/method\n\tif (is_string($args[0]) && preg_match('/.php$/',$args[0])) {\n\t\t$file = preg_replace('/.php$/','',array_shift($args));\n\t\t$line = array_shift($args);\n\t\t$method = array_shift($args);\n\n\t} else {\n\t\t$file = 'UNKNOWN';\n\t\t$line = 'UNKNOWN';\n\t\t$method = 'UNKNOWN';\n\t}\n\n\t# TEMP: New debuglog format\n\tif (preg_match('/%%/',$msg) && $args[0] != 'NOARGS')\n\t\t$args = array_shift($args);\n\n\t$fargs = array();\n\tforeach ($args as $key) {\n\t\tif (is_array($key))\n\t\t\tarray_push($fargs,serialize($key));\n\t\telseif (is_object($key))\n\t\t\tarray_push($fargs,sprintf('OBJECT:%s',get_class($key)));\n\t\telse\n\t\t\tarray_push($fargs,$key);\n\t}\n\n\tif (preg_match('/%%/',$msg))\n\t\t$msg = preg_replace('/%%/',join('|',$fargs),$msg);\n\telse\n\t\t$msg = vsprintf($msg,array_values($fargs));\n\n\tif (function_exists('stopwatch'))\n\t\t$timer = stopwatch();\n\telse\n\t\t$timer = null;\n\n\t$debug_message = sprintf('[%2.3f] %15s(%04s-%03s): %s%s: %s',$timer,basename($file),$line,$level,str_repeat('.',$indent),$method,substr($msg,0,200));\n\n\tif ($debug_file || $_SESSION[APPCONFIG]->getValue('debug','file')) {\n\t\tif (! $debug_file)\n\t\t\t$debug_file = fopen($_SESSION[APPCONFIG]->getValue('debug','file'),\n\t\t\t\t$_SESSION[APPCONFIG]->getValue('debug','append') ? 'a' : 'w');\n\n\t\tfwrite($debug_file,$debug_message.\"\\n\");\n\t}\n\n\tif ($_SESSION[APPCONFIG]->getValue('debug','syslog') && function_exists('syslog_notice'))\n\t\tsyslog_notice($debug_message);\n}\n\n/**\n * Display an error message in the system message panel of the page.\n */\nfunction error($msg,$type='note',$redirect=null,$fatal=false,$backtrace=false) {\n\tglobal $www;\n\tstatic $counter;\n\n\t# Just a check to see that we are called right.\n\tif (! isset($www['page']) && ! $fatal)\n\t\tdie(\"Function error called incorrectly [$msg]\");\n\n\t# If the error is fatal, we'll need to stop here.\n\tif (! isset($www['page']))\n\t\t$www['page'] = new page();\n\n\tif ($fatal)\n\t\t$www['page']->setsysmsg(array('title'=>_('Error'),'body'=>$msg,'type'=>$type));\n\telse\n\t\tsystem_message(array('title'=>_('Error'),'body'=>$msg,'type'=>$type),$redirect);\n\n\t# Spin loop detection\n\tif ($counter++ > 20) {\n\t\tdebug_dump('Spin loop detection.');\n\t\tdebug_dump(array('msg'=>$msg,'session'=>$_SESSION['sysmsg'],'www'=>$www),1);\n\t}\n\n\t# Do we have a backtrace to display?\n\tif ($backtrace) {\n\t\t$backtraceblock = new block();\n\t\t$backtraceblock->SetTitle('PHP Debug Backtrace');\n\n\t\t$body = '<table class=\"result_table\">';\n\t\t$body .= \"\\n\";\n\n\t\tforeach (debug_backtrace() as $error => $line) {\n\t\t\t$_SESSION['backtrace'][$error]['file'] = isset($line['file']) ? $line['file'] : 'unknown';\n\t\t\t$_SESSION['backtrace'][$error]['line'] = isset($line['line']) ? $line['line'] : 'unknown';\n\t\t\t$body .= sprintf('<tr class=\"hightlight\"><td colspan=\"2\"><b><small>%s</small></b></td><td>%s (%s)</td></tr>',\n\t\t\t\t_('File'),isset($line['file']) ? $line['file'] : $last['file'],isset($line['line']) ? $line['line'] : '');\n\n\t\t\t$_SESSION['backtrace'][$error]['function'] = $line['function'];\n\t\t\t$body .= sprintf('<tr><td>&nbsp;</td><td><b><small>%s</small></b></td><td><small>%s',\n\t\t\t\t_('Function'),$line['function']);\n\n\t\t\tif (isset($line['args'])) {\n\t\t\t\t$display = strlen(serialize($line['args'])) < 50 ? htmlspecialchars(serialize($line['args'])) : htmlspecialchars(substr(serialize($line['args']),0,50)).'...<TRUNCATED>';\n\t\t\t\t$_SESSION['backtrace'][$error]['args'] = $line['args'];\n\t\t\t\tif (file_exists(LIBDIR.'../tools/unserialize.php'))\n\t\t\t\t\t$body .= sprintf('&nbsp;(<a href=\"%s?index=%s\" onclick=\"target=\\'backtrace\\';\">%s</a>)',\n\t\t\t\t\t\t'../tools/unserialize.php',$error,$display);\n\t\t\t\telse\n\t\t\t\t\t$body .= sprintf('&nbsp;(%s)',$display);\n\t\t\t}\n\t\t\t$body .= '</small></td></tr>';\n\t\t\t$body .= \"\\n\";\n\n\t\t\tif (isset($line['file']))\n\t\t\t\t$last['file'] = $line['file'];\n\t\t}\n\n\t\t$body .= '</table>';\n\t\t$body .= \"\\n\";\n\t\t$backtraceblock->SetBody($body);\n\n\t\t$www['page']->block_add('body',$backtraceblock);\n\t}\n\n\tif ($fatal) {\n\t\t$www['page']->display(array('tree'=>false));\n\t\tdie();\n\t}\n}\n\n/**\n * Return the result of a form variable, with optional default\n *\n * @return The form GET/REQUEST/SESSION/POST variable value or its default\n */\nfunction get_request($attr,$type='POST',$die=false,$default=null,$preventXSS=true) {\n\tswitch($type) {\n\t\tcase 'GET':\n\t\t\t$value = isset($_GET[$attr]) ? (is_array($_GET[$attr]) ? $_GET[$attr] : (empty($_GET['nodecode'][$attr]) ? rawurldecode($_GET[$attr]) : $_GET[$attr])) : $default;\n\t\t\tbreak;\n\n\t\tcase 'REQUEST':\n\t\t\t$value = isset($_REQUEST[$attr]) ? (is_array($_REQUEST[$attr]) ? $_REQUEST[$attr] : (empty($_REQUEST['nodecode'][$attr]) ? rawurldecode($_REQUEST[$attr]) : $_REQUEST[$attr])) : $default;\n\t\t\tbreak;\n\n\t\tcase 'SESSION':\n\t\t\t$value = isset($_SESSION[$attr]) ? (is_array($_SESSION[$attr]) ? $_SESSION[$attr] : (empty($_SESSION['nodecode'][$attr]) ? rawurldecode($_SESSION[$attr]) : $_SESSION[$attr])) : $default;\n\t\t\tbreak;\n\n\t\tcase 'POST':\n\t\tdefault:\n\t\t\t$value = isset($_POST[$attr]) ? (is_array($_POST[$attr]) ? $_POST[$attr] : (empty($_POST['nodecode'][$attr]) ? rawurldecode($_POST[$attr]) : $_POST[$attr])) : $default;\n\t\t\tbreak;\n\t}\n\t\n\tif ($die && is_null($value))\n\t\tsystem_message(array(\n\t\t\t'title'=>_('Generic Error'),\n\t\t\t'body'=>sprintf('%s: Called \"%s\" without \"%s\" using \"%s\"',\n\t\t\t\tbasename($_SERVER['PHP_SELF']),get_request('cmd','REQUEST'),preventXSS($attr),preventXSS($type)),\n\t\t\t'type'=>'error'),\n\t\t\t'index.php');\n\tif($preventXSS && !is_null($value))\n\t\t$value = preventXSS($value);\n\treturn $value;\n}\n/**\n*  Prevent XSS function. This function can usage has preventXSS(get_request('cmd','REQUEST'))\n*  Return valor escape XSS.\n*/\n function preventXSS($data){\n        if (gettype($data) == 'array') {\n            foreach ($data as $key => $value) {\n                if (gettype($value) == 'array')\n                    $data[$key] = preventXSS($value);\n                else\n                    $data[$key] = htmlspecialchars($value);\n            }\n            return $data;\n        }\n        return htmlspecialchars($data, ENT_QUOTES, 'UTF-8');\n}\n\n/*\n * Record a system message.\n * This function can be used as an alternative to generate a system message, if page hasnt yet been defined.\n */\nfunction system_message($msg,$redirect=null) {\n\tif (! is_array($msg))\n\t\treturn null;\n\n\tif (! isset($msg['title']) && ! isset($msg['body']))\n\t\treturn null;\n\n\tif (! isset($msg['type']))\n\t\t$msg['type'] = 'info';\n\n\tif (! isset($_SESSION['sysmsg']) || ! is_array($_SESSION['sysmsg']))\n\t\t$_SESSION['sysmsg'] = array();\n\n\t# Try and detect if we are in a redirect loop\n\tif (get_request('redirect','GET') && $msg['type'] != 'debug') {\n\t\tforeach ($_SESSION['sysmsg'] as $detail) {\n\t\t\tif ($msg == $detail && ! isset($detail['special'])) {\n\t\t\t\tdebug_dump(array('Incoming MSG'=>$msg,'existing'=>$_SESSION['sysmsg']));\n\t\t\t\tdebug_dump_backtrace('Redirect Loop Detected',true);\n\t\t\t}\n\t\t}\n\t}\n\n\tarray_push($_SESSION['sysmsg'],$msg);\n\n\tif ($redirect) {\n\t\tif (preg_match('/\\?/',$redirect))\n\t\t\t$redirect .= '&';\n\t\telse\n\t\t\t$redirect .= '?';\n\t\t$redirect .= 'redirect=true';\n\n\t\t# Check if we were an ajax request, and only render the ajax message\n\t\tif (get_request('meth','REQUEST') == 'ajax')\n\t\t\t$redirect .= '&meth=ajax';\n\n\t\theader(\"Location: $redirect\");\n\t\tdie();\n\t}\n}\n\n/**\n * Other Functions\n */\n\n/**\n * Encryption using blowfish algorithm\n *\n * @param string Original data\n * @param string The secret\n * @return string The encrypted result\n * @author lem9 (taken from the phpMyAdmin source)\n */\nfunction blowfish_encrypt($data,$secret=null) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t# If our secret is null or blank, get the default.\n\tif ($secret === null || ! trim($secret))\n\t\t$secret = $_SESSION[APPCONFIG]->getValue('session','blowfish') ? $_SESSION[APPCONFIG]->getValue('session','blowfish') : session_id();\n\n\t# If the secret isnt set, then just return the data.\n\tif (! trim($secret))\n\t\treturn $data;\n\n\tif (! empty($data) && function_exists('openssl_encrypt') && in_array('bf-ecb', openssl_get_cipher_methods())) {\n\t\t$keylen = openssl_cipher_iv_length('bf-ecb') * 2;\n\t\treturn openssl_encrypt($data, 'bf-ecb', substr($secret,0,$keylen));\n\t}\n\n\tif (function_exists('mcrypt_module_open') && ! empty($data)) {\n\t\t$td = mcrypt_module_open(MCRYPT_BLOWFISH,'',MCRYPT_MODE_ECB,'');\n\t\t$iv = mcrypt_create_iv(mcrypt_enc_get_iv_size($td),MCRYPT_DEV_URANDOM);\n\t\tmcrypt_generic_init($td,substr($secret,0,mcrypt_enc_get_key_size($td)),$iv);\n\t\t$encrypted_data = base64_encode(mcrypt_generic($td,$data));\n\t\tmcrypt_generic_deinit($td);\n\n\t\treturn $encrypted_data;\n\t}\n\n\tif (file_exists(LIBDIR.'blowfish.php'))\n\t\trequire_once LIBDIR.'blowfish.php';\n\telse\n\t\treturn $data;\n\n\t$pma_cipher = new Horde_Cipher_blowfish;\n\t$encrypt = '';\n\n\tfor ($i=0; $i<strlen($data); $i+=8) {\n\t\t$block = substr($data, $i, 8);\n\n\t\tif (strlen($block) < 8)\n\t\t\t$block = full_str_pad($block,8,\"\\0\", 1);\n\n\t\t$encrypt .= $pma_cipher->encryptBlock($block, $secret);\n\t}\n\n\treturn base64_encode($encrypt);\n}\n\n/**\n * Decryption using blowfish algorithm\n *\n * @param string Encrypted data\n * @param string The secret\n * @return string Original data\n * @author lem9 (taken from the phpMyAdmin source)\n */\nfunction blowfish_decrypt($encdata,$secret=null) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t# This cache gives major speed up for stupid callers :)\n\tstatic $CACHE = array();\n\n\tif (isset($CACHE[$encdata]))\n\t\treturn $CACHE[$encdata];\n\n\t# If our secret is null or blank, get the default.\n\tif ($secret === null || ! trim($secret))\n\t\t$secret = $_SESSION[APPCONFIG]->getValue('session','blowfish') ? $_SESSION[APPCONFIG]->getValue('session','blowfish') : session_id();\n\n\t# If the secret isnt set, then just return the data.\n\tif (! trim($secret))\n\t\treturn $encdata;\n\n\tif (! empty($encdata) && function_exists('openssl_encrypt') && in_array('bf-ecb', openssl_get_cipher_methods())) {\n\t\t$keylen = openssl_cipher_iv_length('bf-ecb') * 2;\n\t\treturn trim(openssl_decrypt($encdata, 'bf-ecb', substr($secret,0,$keylen)));\n\t}\n\n\tif (function_exists('mcrypt_module_open') && ! empty($encdata)) {\n\t\t$td = mcrypt_module_open(MCRYPT_BLOWFISH,'',MCRYPT_MODE_ECB,'');\n\t\t$iv = mcrypt_create_iv(mcrypt_enc_get_iv_size($td),MCRYPT_DEV_URANDOM);\n\t\tmcrypt_generic_init($td,substr($secret,0,mcrypt_enc_get_key_size($td)),$iv);\n\t\t$decrypted_data = trim(mdecrypt_generic($td,base64_decode($encdata)));\n\t\tmcrypt_generic_deinit($td);\n\n\t\treturn $decrypted_data;\n\t}\n\n\tif (file_exists(LIBDIR.'blowfish.php'))\n\t\trequire_once LIBDIR.'blowfish.php';\n\telse\n\t\treturn $encdata;\n\n\t$pma_cipher = new Horde_Cipher_blowfish;\n\t$decrypt = '';\n\t$data = base64_decode($encdata);\n\n\tfor ($i=0; $i<strlen($data); $i+=8)\n\t\t$decrypt .= $pma_cipher->decryptBlock(substr($data, $i, 8), $secret);\n\n\t// Strip off our \\0's that were added.\n\t$return = preg_replace(\"/\\\\0*$/\",'',$decrypt);\n\t$CACHE[$encdata] = $return;\n\treturn $return;\n}\n\n/**\n * String padding\n *\n * @param string Input string\n * @param integer Length of the result\n * @param string The filling string\n * @param integer Padding mode\n * @return string The padded string\n */\nfunction full_str_pad($input,$pad_length,$pad_string='',$pad_type=0) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$str = '';\n\t$length = $pad_length - strlen($input);\n\n\tif ($length > 0) { // str_repeat doesn't like negatives\n\t\tif ($pad_type == STR_PAD_RIGHT) { // STR_PAD_RIGHT == 1\n\t\t\t$str = $input.str_repeat($pad_string, $length);\n\t\t} elseif ($pad_type == STR_PAD_BOTH) { // STR_PAD_BOTH == 2\n\t\t\t$str = str_repeat($pad_string, floor($length/2));\n\t\t\t$str .= $input;\n\t\t\t$str .= str_repeat($pad_string, ceil($length/2));\n\t\t} else { // defaults to STR_PAD_LEFT == 0\n\t\t\t$str = str_repeat($pad_string, $length).$input;\n\t\t}\n\n\t} else { // if $length is negative or zero we don't need to do anything\n\t\t$str = $input;\n\t}\n\treturn $str;\n}\n\n/**\n * Returns the cached array of LDAP resources.\n *\n * Note that internally, this function utilizes a two-layer cache,\n * one in memory using a static variable for multiple calls within\n * the same page load, and one in a session for multiple calls within\n * the same user session (spanning multiple page loads).\n *\n * @return Returns the cached attributed requested,\n *         or null if there is nothing cached..\n */\nfunction get_cached_item($index,$item,$subitem='null') {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t# Set default return\n\t$return = null;\n\n\t# Check config to make sure session-based caching is enabled.\n\tif ($_SESSION[APPCONFIG]->getValue('cache',$item) && isset($_SESSION['cache'][$index][$item][$subitem]))\n\t\t$return = $_SESSION['cache'][$index][$item][$subitem];\n\n\tif (DEBUG_ENABLED)\n\t\tdebug_log('Returning (%s)',1,0,__FILE__,__LINE__,__METHOD__,$return);\n\n\treturn $return;\n}\n\n/**\n * Caches the specified $item for the specified $index.\n *\n * Returns true on success of false on failure.\n */\nfunction set_cached_item($index,$item,$subitem='null',$data) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t# Check config to make sure session-based caching is enabled.\n\tif ($_SESSION[APPCONFIG]->getValue('cache',$item)) {\n\t\tglobal $CACHE;\n\n\t\t$CACHE[$index][$item][$subitem] = $data;\n\t\t$_SESSION['cache'][$index][$item][$subitem] = $data;\n\n\t\treturn true;\n\n\t} else\n\t\treturn false;\n}\n\n/**\n * Deletes the cache for a specified $item for the specified $index\n */\nfunction del_cached_item($index,$item,$subitem='null') {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\tglobal $CACHE;\n\n\t# Check config to make sure session-based caching is enabled.\n\tif (isset($_SESSION['cache'][$index][$item][$subitem]))\n\t\tunset($_SESSION['cache'][$index][$item][$subitem]);\n\n\tif (isset($CACHE[$index][$item][$subitem]))\n\t\tunset($CACHE[$index][$item][$subitem]);\n}\n\n/**\n * Utility wrapper for setting cookies, which takes into consideration\n * application configuration values. On success, true is returned. On\n * failure, false is returned.\n *\n * @param string The name of the cookie to set.\n * @param string The value of the cookie to set.\n * @param int (optional) The duration in seconds of this cookie. If unspecified, $cookie_time is used from config.php\n * @param string (optional) The directory value of this cookie (see php.net/setcookie)\n * @return boolean\n */\nfunction set_cookie($name,$val,$expire=null,$dir=null) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t# Set default return\n\t$return = false;\n\n\tif ($expire == null) {\n\t\t$cookie_time = $_SESSION[APPCONFIG]->getValue('session','cookie_time');\n\t\t$expire = $cookie_time == 0 ? null : time() + $cookie_time;\n\t}\n\n\tif ($dir == null)\n\t\t$dir = dirname($_SERVER['PHP_SELF']);\n\n\tif (@setcookie($name,$val,$expire,$dir)) {\n\t\t$_COOKIE[$name] = $val;\n\t\t$return = true;\n\t}\n\n\tif (DEBUG_ENABLED)\n\t\tdebug_log('Returning (%s)',1,0,__FILE__,__LINE__,__METHOD__,$return);\n\n\treturn $return;\n}\n\n/**\n * Get a customized file for a server\n * We don't need any caching, because it's done by PHP\n *\n * @param int The ID of the server\n * @param string The requested filename\n *\n * @return string The customized filename, if exists, or the standard one\n */\nfunction get_custom_file($index,$filename,$path) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t# Set default return\n\t$return = $path.$filename;\n\t$server = $_SESSION[APPCONFIG]->getServer($index);\n\n\t$custom = $server->getValue('custom','pages_prefix');\n\tif (! is_null($custom) && is_file(realpath($path.$custom.$filename)))\n\t\t$return = $path.$custom.$filename;\n\n\tif (DEBUG_ENABLED)\n\t\tdebug_log('Returning (%s)',1,0,__FILE__,__LINE__,__METHOD__,$return);\n\n\treturn $return;\n}\n\n/**\n * Replacement for create_function() which is deprecated as of php 7.2\n *\n * @param string The function arguments\n * @param string The function code\n */\nfunction pla_create_function($args, $code) {\n\tif (version_compare(phpversion(),'7.0','>=')) {\n\t\t# anonymous functions were introduced in PHP 5.3.0\n\t\treturn eval(\"return function(\".$args.\"){\".$code.\"};\");\n\n\t} else {\n\t\t# create_function is deprecated in php 7.2\n\t\treturn create_function($args, $code);\n\t}\n}\n\n/**\n * Sort a multi dimensional array.\n *\n * @param array Multi demension array passed by reference\n * @param string Comma delimited string of sort keys.\n * @param boolean Whether to reverse sort.\n * @return array Sorted multi demension array.\n */\nfunction masort(&$data,$sortby,$rev=0) {\n\tif (defined('DEBUG_ENABLED') && DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t# if the array to sort is null or empty, or if we have some nasty chars\n\tif (! preg_match('/^[a-zA-Z0-9_]+(\\([a-zA-Z0-9_,]*\\))?$/',$sortby) || ! $data)\n\t\treturn;\n\n\tstatic $CACHE = array();\n\n\tif (empty($CACHE[$sortby])) {\n\t\t$code = \"\\$c=0;\\n\";\n\n\t\tforeach (explode(',',$sortby) as $key) {\n\t\t\t$code .= \"if (is_object(\\$a) || is_object(\\$b)) {\\n\";\n\n\t\t\t$code .= \"\tif (is_array(\\$a->$key)) {\\n\";\n\t\t\t$code .= \"\t\tasort(\\$a->$key);\\n\";\n\t\t\t$code .= \"\t\t\\$aa = array_shift(\\$a->$key);\\n\";\n\t\t\t$code .= \"\t} else\\n\";\n\t\t\t$code .= \"\t\t\\$aa = \\$a->$key;\\n\";\n\n\t\t\t$code .= \"\tif (is_array(\\$b->$key)) {\\n\";\n\t\t\t$code .= \"\t\tasort(\\$b->$key);\\n\";\n\t\t\t$code .= \"\t\t\\$bb = array_shift(\\$b->$key);\\n\";\n\t\t\t$code .= \"\t} else\\n\";\n\t\t\t$code .= \"\t\t\\$bb = \\$b->$key;\\n\";\n\n\t\t\t$code .= \"\tif (\\$aa != \\$bb)\";\n\t\t\tif ($rev)\n\t\t\t\t$code .= \"\treturn (\\$aa < \\$bb ? 1 : -1);\\n\";\n\t\t\telse\n\t\t\t\t$code .= \"\treturn (\\$aa > \\$bb ? 1 : -1);\\n\";\n\n\t\t\t$code .= \"} else {\\n\";\n\n\t\t\t$code .= \"\t\\$a = array_change_key_case(\\$a);\\n\";\n\t\t\t$code .= \"\t\\$b = array_change_key_case(\\$b);\\n\";\n\n\t\t\t$key = strtolower($key);\n\n\t\t\t$code .= \"\tif ((! isset(\\$a['$key'])) && isset(\\$b['$key'])) return 1;\\n\";\n\t\t\t$code .= \"\tif (isset(\\$a['$key']) && (! isset(\\$b['$key']))) return -1;\\n\";\n\n\t\t\t$code .= \"\tif ((isset(\\$a['$key'])) && (isset(\\$b['$key']))) {\\n\";\n\t\t\t$code .= \"\t\tif (is_array(\\$a['$key'])) {\\n\";\n\t\t\t$code .= \"\t\t\tasort(\\$a['$key']);\\n\";\n\t\t\t$code .= \"\t\t\t\\$aa = array_shift(\\$a['$key']);\\n\";\n\t\t\t$code .= \"\t\t} else\\n\";\n\t\t\t$code .= \"\t\t\t\\$aa = \\$a['$key'];\\n\";\n\n\t\t\t$code .= \"\t\tif (is_array(\\$b['$key'])) {\\n\";\n\t\t\t$code .= \"\t\t\tasort(\\$b['$key']);\\n\";\n\t\t\t$code .= \"\t\t\t\\$bb = array_shift(\\$b['$key']);\\n\";\n\t\t\t$code .= \"\t\t} else\\n\";\n\t\t\t$code .= \"\t\t\t\\$bb = \\$b['$key'];\\n\";\n\n\t\t\t$code .= \"\t\tif (\\$aa != \\$bb)\\n\";\n\t\t\t$code .= \"\t\t\tif (is_numeric(\\$aa) && is_numeric(\\$bb)) {\\n\";\n\n\t\t\tif ($rev)\n\t\t\t\t$code .= \"\t\t\t\treturn (\\$aa < \\$bb ? 1 : -1);\\n\";\n\t\t\telse\n\t\t\t\t$code .= \"\t\t\t\treturn (\\$aa > \\$bb ? 1 : -1);\\n\";\n\n\t\t\t$code .= \"\t\t\t} else {\\n\";\n\n\t\t\tif ($rev)\n\t\t\t\t$code .= \"\t\t\t\tif ( (\\$c = strcasecmp(\\$bb,\\$aa)) != 0 ) return \\$c;\\n\";\n\t\t\telse\n\t\t\t\t$code .= \"\t\t\t\tif ( (\\$c = strcasecmp(\\$aa,\\$bb)) != 0 ) return \\$c;\\n\";\n\n\t\t\t$code .= \"\t\t}\\n\";\n\t\t\t$code .= \"\t}\\n\";\n\t\t\t$code .= \"}\\n\";\n\t\t}\n\n\t\t$code .= 'return $c;';\n\n\t\t$CACHE[$sortby] = pla_create_function('$a, $b',$code);\n\t}\n\n\tuasort($data,$CACHE[$sortby]);\n}\n\n/**\n * Is compression enabled for output\n */\nfunction isCompress() {\n\treturn (isset($_SESSION[APPCONFIG]) && $_SESSION[APPCONFIG]->getValue('appearance','compress')\n\t\t&& ! ini_get('zlib.output_compression')\n\t\t&& preg_match('/gzip/',$_SERVER['HTTP_ACCEPT_ENCODING']));\n}\n\n/**\n * PLA specific Functions\n */\n\n/**\n * Fetches whether the user has configured phpLDAPadmin to obfuscate passwords\n * with \"*********\" when displaying them.\n *\n * This is configured in config.php thus:\n * <code>\n *  $config->custom->appearance['obfuscate_password_display'] = true;\n * </code>\n *\n * Or if it is OK to show encrypted passwords but not clear text passwords\n * <code>\n *  $config->custom->appearance['show_clear_password'] = false;\n * </code>\n *\n * @param string Password encoding type\n * @return boolean\n */\nfunction obfuscate_password_display($enc=null) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\tif ($_SESSION[APPCONFIG]->getValue('appearance','obfuscate_password_display'))\n\t\t$return = true;\n\n\telseif (! $_SESSION[APPCONFIG]->getValue('appearance','show_clear_password') && (is_null($enc) || $enc == 'clear'))\n\t\t$return = true;\n\n\telse\n\t\t$return = false;\n\n\tif (DEBUG_ENABLED)\n\t\tdebug_log('Returning (%s)',1,0,__FILE__,__LINE__,__METHOD__,$return);\n\n\treturn $return;\n}\n\n/**\n * Returns an HTML-beautified version of a DN.\n * Internally, this function makes use of pla_explode_dn() to break the\n * the DN into its components. It then glues them back together with\n * \"pretty\" HTML. The returned HTML is NOT to be used as a real DN, but\n * simply displayed.\n *\n * @param string The DN to pretty-print.\n * @return string\n */\nfunction pretty_print_dn($dn) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$dn_save = $dn;\n\t$dn = pla_explode_dn($dn);\n\n\tif (! $dn)\n\t\treturn $dn_save;\n\n\tforeach ($dn as $i => $element) {\n\t\t$element = htmlspecialchars($element);\n\t\t$element = explode('=',$element,2);\n\t\t$element = implode('<span style=\"color: blue; font-family: courier; font-weight: bold\">=</span>',$element);\n\t\t$dn[$i] = $element;\n\t}\n\n\t$dn = implode('<span style=\"color:red; font-family:courier; font-weight: bold;\">,</span>',$dn);\n\n\treturn $dn;\n}\n\n/**\n * Given a string, this function returns true if the string has the format\n * of a DN (ie, looks like \"cn=Foo,dc=example,dc=com\"). Returns false otherwise.\n * The purpose of this function is so that developers can examine a string and\n * know if it looks like a DN, and draw a hyperlink as needed.\n *\n * (See unit_test.php for test cases)\n *\n * @param string The attribute to examine for \"DNness\"\n * @return boolean\n */\nfunction is_dn_string($str) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t/* Try to break the string into its component parts if it can be done\n\t   ie, \"uid=Manager\" \"dc=example\" and \"dc=com\" */\n\t$parts = pla_explode_dn($str);\n\tif (! is_array($parts) || ! count($parts))\n\t\treturn false;\n\n\t/* Foreach of the \"parts\", look for an \"=\" character,\n\t   and make sure neither the left nor the right is empty */\n\tforeach ($parts as $part) {\n\t\tif (! strpos($part,\"=\"))\n\t\t\treturn false;\n\n\t\t$sub_parts = explode('=',$part,2);\n\t\t$left = $sub_parts[0];\n\t\t$right = $sub_parts[1];\n\n\t\tif ( ! strlen(trim($left)) || ! strlen(trim($right)))\n\t\t\treturn false;\n\n\t\tif (strpos($left,'#') !== false)\n\t\t\treturn false;\n\t}\n\n\t# We survived the above rigor. This is a bonified DN string.\n\treturn true;\n}\n\n/**\n * Get whether a string looks like an email address (user@example.com).\n *\n * @param string The string to analyze.\n * @return boolean Returns true if the specified string looks like an email address or false otherwise.\n */\nfunction is_mail_string($str) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$mail_regex = \"/^[_A-Za-z0-9-]+(\\\\.[_A-Za-z0-9-]+)*@[A-Za-z0-9-]+(\\\\.[A-Za-z0-9-]+)*$/\";\n\n\tif (preg_match($mail_regex,$str))\n\t\treturn true;\n\telse\n\t\treturn false;\n}\n\n/**\n * Get whether a string looks like a web URL (http://www.example.com/)\n *\n * @param string The string to analyze.\n * @return boolean Returns true if the specified string looks like a web URL or false otherwise.\n */\nfunction is_url_string($str) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$url_regex = '/^(ftp|https?):\\/\\/+[\\w\\.\\-\\/\\?\\=\\&]*\\w+/';\n\n\tif (preg_match($url_regex,$str))\n\t\treturn true;\n\telse\n\t\treturn false;\n}\n\n/**\n * Compares 2 DNs. If they are equivelant, returns 0, otherwise,\n * returns their sorting order (similar to strcmp()):\n *      Returns < 0 if dn1 is less than dn2.\n *      Returns > 0 if dn1 is greater than dn2.\n *\n * The comparison is performed starting with the top-most element\n * of the DN. Thus, the following list:\n *    <code>\n *       ou=people,dc=example,dc=com\n *       cn=Admin,ou=People,dc=example,dc=com\n *       cn=Joe,ou=people,dc=example,dc=com\n *       dc=example,dc=com\n *       cn=Fred,ou=people,dc=example,dc=org\n *       cn=Dave,ou=people,dc=example,dc=org\n *    </code>\n * Will be sorted thus using usort( $list, \"pla_compare_dns\" ):\n *    <code>\n *       dc=com\n *       dc=example,dc=com\n *       ou=people,dc=example,dc=com\n *       cn=Admin,ou=People,dc=example,dc=com\n *       cn=Joe,ou=people,dc=example,dc=com\n *       cn=Dave,ou=people,dc=example,dc=org\n *       cn=Fred,ou=people,dc=example,dc=org\n *    </code>\n *\n * @param string The first of two DNs to compare\n * @param string The second of two DNs to compare\n * @return int\n */\nfunction pla_compare_dns($dn1,$dn2) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t# If pla_compare_dns is passed via a tree, then we'll just get the DN part.\n\tif (is_array($dn1))\n\t\tif (isset($dn1['dn']))\n\t\t\t$dn1 = $dn1['dn'];\n\t\telse\n\t\t\t$dn1 = implode('+',$dn1);\n\tif (is_array($dn2))\n\t\tif (isset($dn2['dn']))\n\t\t\t$dn2 = $dn2['dn'];\n\t\telse\n\t\t\t$dn2 = implode('+',$dn2);\n\n\t# If they are obviously the same, return immediately\n\tif (! strcasecmp($dn1,$dn2))\n\t\treturn 0;\n\n\t$dn1_parts = pla_explode_dn(pla_reverse_dn($dn1));\n\t$dn2_parts = pla_explode_dn(pla_reverse_dn($dn2));\n\tassert(is_array($dn1_parts));\n\tassert(is_array($dn2_parts));\n\n\t# Foreach of the \"parts\" of the smaller DN\n\tfor ($i=0; $i < count($dn1_parts) && $i < count($dn2_parts); $i++) {\n\t\t/* dnX_part is of the form: \"cn=joe\" or \"cn = joe\" or \"dc=example\"\n\t\t   ie, one part of a multi-part DN. */\n\t\t$dn1_part = $dn1_parts[$i];\n\t\t$dn2_part = $dn2_parts[$i];\n\n\t\t/* Each \"part\" consists of two sub-parts:\n\t\t   1. the attribute (ie, \"cn\" or \"o\")\n\t\t   2. the value (ie, \"joe\" or \"example\") */\n\t\t$dn1_sub_parts = explode('=',$dn1_part,2);\n\t\t$dn2_sub_parts = explode('=',$dn2_part,2);\n\n\t\t$dn1_sub_part_attr = trim($dn1_sub_parts[0]);\n\t\t$dn2_sub_part_attr = trim($dn2_sub_parts[0]);\n\n\t\tif (0 != ($cmp = strcasecmp($dn1_sub_part_attr,$dn2_sub_part_attr)))\n\t\t\treturn $cmp;\n\n\t\t$dn1_sub_part_val = trim($dn1_sub_parts[1]);\n\t\t$dn2_sub_part_val = trim($dn2_sub_parts[1]);\n\t\tif (0 != ($cmp = strcasecmp($dn1_sub_part_val,$dn2_sub_part_val)))\n\t\t\treturn $cmp;\n\t}\n\n\t/* If we iterated through all entries in the smaller of the two DNs\n\t   (ie, the one with fewer parts), and the entries are different sized,\n\t   then, the smaller of the two must be \"less than\" than the larger. */\n\tif (count($dn1_parts) > count($dn2_parts)) {\n\t\treturn 1;\n\n\t} elseif (count($dn2_parts) > count($dn1_parts)) {\n\t\treturn -1;\n\n\t} else {\n\t\treturn 0;\n\t}\n}\n\n/**\n * For LDAP servers with auto_number enabled, this function will get the next\n * available number using the host's preferred mechanism (pool or search).\n *\n * This is configured in config.php by server:\n *\n * <code>\n *   $servers->setValue('auto_number','enable',true|false);\n * </code>\n *\n * The available mechanisms are:\n * pool:\n *   The pool mechanism uses a user-configured entry in the LDAP server to\n *   store the last used \"number\". This mechanism simply fetches and increments\n *   and returns that value.\n *\n * search:\n *   The search mechanism will search the LDAP server that has the attribute\n *   set. It will then find the smallest value and \"fills in the gaps\" by\n *   incrementing the smallest attribute until an unused value is found.\n *\n * NOTE: Both mechanisms do NOT prevent race conditions or toe-stomping, so\n * care must be taken when actually creating the entry to check that the number\n * returned here has not been used in the mean time. Note that the two different\n * mechanisms may (will!) return different values as they use different algorithms\n * to arrive at their result. Do not be alarmed if (when!) this is the case.\n *\n * See config.php.example for more notes on the two mechanisms.\n *\n * @param string Base to start the search from\n * @param string Attribute to query\n * @param boolean Increment the result (for pool searches)\n * @param string LDAP filter to use (for pool searches)\n * @return int\n */\nfunction get_next_number($base,$attr,$increment=false,$filter=false,$startmin=null) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$server = $_SESSION[APPCONFIG]->getServer(get_request('server_id','REQUEST'));\n\t$attr = strtolower($attr);\n\t$query = array();\n\n\tif (! $server->getValue('auto_number','enable')) {\n\t\tsystem_message(array(\n\t\t\t'title'=>_('AUTO_NUMBER is disabled for this server'),\n\t\t\t'body'=>sprintf('%s (<b>%s</b>)',_('A call was made to get_next_number(), however, it is disabled for this server'),$attr),\n\t\t\t'type'=>'warn'));\n\n\t\treturn false;\n\t}\n\n\t# Check see and use our alternate uid_dn and password if we have it.\n\tif (! $server->login($server->getValue('auto_number','dn'),$server->getValue('auto_number','pass'),'auto_number')) {\n\t\tsystem_message(array(\n\t\t\t'title'=>_('AUTO_NUMBER invalid login/password'),\n\t\t\t'body'=>sprintf('%s (<b>%s</b>)',_('Unable to connect to LDAP server with the auto_number login/password, please check your configuration.'),\n\t\t\t\t$server->getName()),\n\t\t\t'type'=>'warn'));\n\n\t\treturn false;\n\t}\n\n\t# Some error checking\n\tif (! $base) {\n\t\t$query['base'] = $server->getValue('auto_number','search_base');\n\n\t\tif (! trim($query['base'])) {\n\t\t\tsystem_message(array(\n\t\t\t\t'title'=>_('No AUTO_NUMBER search_base configured for this server'),\n\t\t\t\t'body'=>_('A call was made to get_next_number(), however, the base to search is empty.'),\n\t\t\t\t'type'=>'warn'));\n\n\t\t\treturn false;\n\t\t}\n\n\t} else\n\t\t$query['base'] = $base;\n\n\tif (! $server->dnExists($query['base'])) {\n\t\tsystem_message(array(\n\t\t\t'title'=>_('No AUTO_NUMBER search_base exists for this server'),\n\t\t\t'body'=>sprintf('%s (<b>%s</b>)',_('A call was made to get_next_number(), however, the base to search does not exist for this server.'),$query['base']),\n\t\t\t'type'=>'warn'));\n\n\t\treturn false;\n\t}\n\n\tif (! is_string($attr) || ! $server->getSchemaAttribute($attr)) {\n\t\tsystem_message(array(\n\t\t\t'title'=>_('AUTO_NUMBER search attribute invalid'),\n\t\t\t'body'=>sprintf('%s (<b>%s</b>)',_('The search attribute for AUTO_NUMBER is invalid, expecting a single valid attribute.'),$attr),\n\t\t\t'type'=>'warn'));\n\n\t\treturn false;\n\t}\n\n\t$query['attrs'] = array($attr);\n\n\t# Based on the configured mechanism, go get the next available uidNumber!\n\tswitch ($server->getValue('auto_number','mechanism')) {\n\t\tcase 'search':\n\t\t\t$query['filter'] = sprintf('(%s=*)',$attr);\n\t\t\t$search = $server->query($query,'auto_number');\n\n\t\t\t# Construct a list of used numbers\n\t\t\t$autonum = array(0);\n\n\t\t\tforeach ($search as $dn => $values) {\n\t\t\t\t$values = array_change_key_case($values);\n\t\t\t\tforeach ($values[$attr] as $value)\n\t\t\t\t\tarray_push($autonum,$value);\n\t\t\t}\n\n\t\t\t$autonum = array_unique($autonum);\n\t\t\tsort($autonum);\n\n\t\t\t# Start with the least existing autoNumber and add 1\n\t\t\t$minNumber = is_null($startmin) ? intval($autonum[0])+1 : $startmin;\n\n\t\t\t# Override our minNumber by the configuration if it exists.\n\t\t\tif (count($server->getValue('auto_number','min'))) {\n\t\t\t\t$min = array_change_key_case($server->getValue('auto_number','min'));\n\n\t\t\t\tif (isset($min[$attr]))\n\t\t\t\t\t$minNumber = $min[$attr] > $minNumber ? $min[$attr] : $minNumber;\n\t\t\t}\n\n\t\t\tfor ($i=0;$i<count($autonum);$i++) {\n\t\t\t\t$num = $autonum[$i] < $minNumber ? $minNumber : $autonum[$i];\n\n\t\t\t\t/* If we're at the end of the list, or we've found a gap between this number and the\n\t\t\t\t   following, use the next available number in the gap. */\n\t\t\t\tif ($i+1 == count($autonum) || $autonum[$i+1] > $num+1)\n\t\t\t\t\treturn $autonum[$i] >= $num ? $num+1 : $num;\n\t\t\t}\n\n\t\t\t# If we didnt find a suitable gap and are all above the minNumber, we'll just return the $minNumber\n\t\t\treturn $minNumber;\n\n\t\t\tbreak;\n\n\t\tcase 'pool':\n\t\t\tswitch ($attr) {\n\t\t\t\tcase 'gidnumber':\n\t\t\t\t\t$query['filter'] = '(objectClass=gidPool)';\n\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'uidnumber':\n\t\t\t\t\t$query['filter'] = '(objectClass=uidPool)';\n\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\t# If we are called with a filter, we'll use the one from the configuration.\n\t\t\tif (! empty($filter))\n\t\t\t\t$query['filter'] = $filter;\n\n\t\t\t$search = $server->query($query,'auto_number');\n\n\t\t\tswitch (count($search)) {\n\t\t\t\tcase '1':\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase '0':\n\t\t\t\t\tsystem_message(array(\n\t\t\t\t\t\t'title'=>_('AUTO_NUMBER pool filter didnt return any DNs'),\n\t\t\t\t\t\t'body'=>sprintf('%s (<b>%s</b>)',_('Please change your filter parameter, or check your auto_number,search_base configuration'),$query['filter']),\n\t\t\t\t\t\t'type'=>'warn'));\n\n\t\t\t\t\treturn false;\n\n\t\t\t\tdefault:\n\t\t\t\t\tsystem_message(array(\n\t\t\t\t\t'title'=>_('AUTO_NUMBER pool filter returned too many DNs'),\n\t\t\t\t\t\t'body'=>sprintf('%s (<b>%s</b>)',_('Please change your filter parameter, or check your auto_number,search_base configuration'),$query['filter']),\n\t\t\t\t\t\t'type'=>'warn'));\n\n\t\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t# This should only iterate once.\n\t\t\tforeach ($search as $dn => $values) {\n\t\t\t\t$values = array_change_key_case($values);\n\n\t\t\t\t$autonum = $values[$attr][0];\n\t\t\t\t$poolDN = $values['dn'];\n\t\t\t}\n\n\t\t\tif ($increment) {\n\t\t\t\t$updatedattr = array($attr=>$autonum+1);\n\t\t\t\t$server->modify($poolDN,$updatedattr);\n\t\t\t}\n\n\t\t\treturn $autonum;\n\n\t\t# No other cases allowed. The user has an error in the configuration\n\t\tdefault:\n\t\t\tsystem_message(array(\n\t\t\t\t'title'=>_('Invalid AUTO_NUMBER mechanism'),\n\t\t\t\t'body'=>sprintf('%s (<b>%s</b>)',_('Your config file specifies an unknown AUTO_NUMBER search mechanism.'),$server->getValue('auto_number','mechanism')),\n\t\t\t\t'type'=>'warn'));\n\n\t\t\treturn false;\n\t}\n}\n\n/**\n * Given a DN and server ID, this function reads the DN's objectClasses and\n * determines which icon best represents the entry. The results of this query\n * are cached in a session variable so it is not run every time the tree\n * browser changes, just when exposing new DNs that were not displayed\n * previously. That means we can afford a little bit of inefficiency here\n * in favor of coolness. :)\n *\n * This function returns a string like \"country.png\". All icon files are assumed\n * to be contained in the /images/ directory of phpLDAPadmin.\n *\n * Developers are encouraged to add new icons to the images directory and modify\n * this function as needed to suit their types of LDAP entries. If the modifications\n * are general to an LDAP audience, the phpLDAPadmin team will gladly accept them\n * as a patch.\n *\n * @param string The DN of the entry whose icon you wish to fetch.\n * @return string\n */\nfunction get_icon($server_id,$dn,$object_classes=array()) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$server = $_SESSION[APPCONFIG]->getServer($server_id);\n\n\t# Fetch and lowercase all the objectClasses in an array\n\tif (! count($object_classes))\n\t\t$object_classes = $server->getDNAttrValue($dn,'objectClass');\n\n\tforeach ($object_classes as $index => $value)\n\t\t$object_classes[$index] = strtolower($value);\n\n\t$rdn = get_rdn($dn);\n\t$rdn_parts = explode('=',$rdn,2);\n\t$rdn_value = isset($rdn_parts[0]) ? $rdn_parts[0] : null;\n\t$rdn_attr = isset($rdn_parts[1]) ? $rdn_parts[1] : null;\n\tunset($rdn_parts);\n\n\t# Return icon filename based upon objectClass value\n\tif (in_array('sambaaccount',$object_classes) &&\n\t\t'$' == $rdn{ strlen($rdn) - 1 })\n\t\treturn 'nt_machine.png';\n\n\tif (in_array('sambaaccount',$object_classes))\n\t\treturn 'nt_user.png';\n\n\telseif (in_array('person',$object_classes) ||\n\t\tin_array('organizationalperson',$object_classes) ||\n\t\tin_array('inetorgperson',$object_classes) ||\n\t\tin_array('account',$object_classes) ||\n\t\tin_array('posixaccount',$object_classes))\n\n\t\treturn 'ldap-user.png';\n\n\telseif (in_array('organization',$object_classes))\n\t\treturn 'ldap-o.png';\n\n\telseif (in_array('organizationalunit',$object_classes))\n\t\treturn 'ldap-ou.png';\n\n\telseif (in_array('organizationalrole',$object_classes))\n\t\treturn 'ldap-uid.png';\n\n\telseif (in_array('dcobject',$object_classes) ||\n\t\tin_array('domainrelatedobject',$object_classes) ||\n\t\tin_array('domain',$object_classes) ||\n\t\tin_array('builtindomain',$object_classes))\n\n\t\treturn 'ldap-dc.png';\n\n\telseif (in_array('alias',$object_classes))\n\t\treturn 'ldap-alias.png';\n\n\telseif (in_array('room',$object_classes))\n\t\treturn 'door.png';\n\n\telseif (in_array('iphost',$object_classes))\n\t\treturn 'host.png';\n\n\telseif (in_array('device',$object_classes))\n\t\treturn 'device.png';\n\n\telseif (in_array('document',$object_classes))\n\t\treturn 'document.png';\n\n\telseif (in_array('country',$object_classes)) {\n\t\t$tmp = pla_explode_dn($dn);\n\t\t$cval = explode('=',$tmp[0],2);\n\t\t$cval = isset($cval[1]) ? $cval[1] : false;\n\t\tif ($cval && false === strpos($cval,'..') &&\n\t\t\tfile_exists(realpath(sprintf('%s/../countries/%s.png',IMGDIR,strtolower($cval)))))\n\n\t\t\treturn sprintf('../countries/%s.png',strtolower($cval));\n\n\t\telse\n\t\t\treturn 'country.png';\n\t}\n\n\telseif (in_array('jammvirtualdomain',$object_classes))\n\t\treturn 'mail.png';\n\n\telseif (in_array('locality',$object_classes))\n\t\treturn 'locality.png';\n\n\telseif (in_array('posixgroup',$object_classes) ||\n\t\tin_array('groupofnames',$object_classes) ||\n\t\tin_array('group',$object_classes))\n\n\t\treturn 'ldap-ou.png';\n\n\telseif (in_array('applicationprocess',$object_classes))\n\t\treturn 'process.png';\n\n\telseif (in_array('groupofuniquenames',$object_classes))\n\t\treturn 'ldap-uniquegroup.png';\n\n\telseif (in_array('nlsproductcontainer',$object_classes))\n\t\treturn 'n.png';\n\n\telseif (in_array('ndspkikeymaterial',$object_classes))\n\t\treturn 'lock.png';\n\n\telseif (in_array('server',$object_classes))\n\t\treturn 'server-small.png';\n\n\telseif (in_array('volume',$object_classes))\n\t\treturn 'hard-drive.png';\n\n\telseif (in_array('ndscatcatalog',$object_classes))\n\t\treturn 'catalog.png';\n\n\telseif (in_array('resource',$object_classes))\n\t\treturn 'n.png';\n\n\telseif (in_array('ldapgroup',$object_classes))\n\t\treturn 'ldap-server.png';\n\n\telseif (in_array('ldapserver',$object_classes))\n\t\treturn 'ldap-server.png';\n\n\telseif (in_array('nisserver',$object_classes))\n\t\treturn 'ldap-server.png';\n\n\telseif (in_array('rbscollection',$object_classes))\n\t\treturn 'ldap-ou.png';\n\n\telseif (in_array('dfsconfiguration',$object_classes))\n\t\treturn 'nt_machine.png';\n\n\telseif (in_array('applicationsettings',$object_classes))\n\t\treturn 'server-settings.png';\n\n\telseif (in_array('aspenalias',$object_classes))\n\t\treturn 'mail.png';\n\n\telseif (in_array('container',$object_classes))\n\t\treturn 'folder.png';\n\n\telseif (in_array('ipnetwork',$object_classes))\n\t\treturn 'network.png';\n\n\telseif (in_array('samserver',$object_classes))\n\t\treturn 'server-small.png';\n\n\telseif (in_array('lostandfound',$object_classes))\n\t\treturn 'find.png';\n\n\telseif (in_array('infrastructureupdate',$object_classes))\n\t\treturn 'server-small.png';\n\n\telseif (in_array('filelinktracking',$object_classes))\n\t\treturn 'files.png';\n\n\telseif (in_array('automountmap',$object_classes) ||\n\t\tin_array('automount',$object_classes))\n\n\t\treturn 'hard-drive.png';\n\n\telseif (strpos($rdn_value,'ipsec') === 0 ||\n\t\tstrcasecmp($rdn_value,'IP Security') == 0||\n\t\tstrcasecmp($rdn_value,'MSRADIUSPRIVKEY Secret') == 0 ||\n\t\tstrpos($rdn_value,'BCKUPKEY_') === 0)\n\n\t\treturn 'lock.png';\n\n\telseif (strcasecmp($rdn_value,'MicrosoftDNS') == 0)\n\t\treturn 'ldap-dc.png';\n\n\t# Oh well, I don't know what it is. Use a generic icon.\n\telse\n\t\treturn 'ldap-default.png';\n}\n\n/**\n * Appends a servers base to a \"sub\" dn or returns the base.\n *\n * @param string The baseDN to be added if the DN is relative\n * @param string The DN to be made absolute\n * @return string|null Returns null if both base is null and sub_dn is null or empty\n */\nfunction expand_dn_with_base($base,$sub_dn) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$empty_str = (is_null($sub_dn) || (($len=strlen(trim($sub_dn))) == 0));\n\n\tif ($empty_str)\n\t\treturn $base;\n\n\t# If we have a string which doesn't need a base\n\telseif ($sub_dn[$len-1] != ',')\n\t\treturn $sub_dn;\n\n\telse\n\t\treturn sprintf('%s%s',$sub_dn,$base);\n}\n\n/**\n * Used to generate a random salt for crypt-style passwords. Salt strings are used\n * to make pre-built hash cracking dictionaries difficult to use as the hash algorithm uses\n * not only the user's password but also a randomly generated string. The string is\n * stored as the first N characters of the hash for reference of hashing algorithms later.\n *\n * @param int The length of the salt string to generate.\n * @return string The generated salt string.\n */\nfunction random_salt($length) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$possible = '0123456789'.\n\t\t'abcdefghijklmnopqrstuvwxyz'.\n\t\t'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.\n\t\t'./';\n\t$str = '';\n\tmt_srand((double)microtime() * 1000000);\n\n\twhile (strlen($str) < $length)\n\t\t$str .= substr($possible,(rand()%strlen($possible)),1);\n\n\treturn $str;\n}\n\n/**\n * Given a DN string, this returns the 'RDN' portion of the string.\n * For example. given 'cn=Manager,dc=example,dc=com', this function returns\n * 'cn=Manager' (it is really the exact opposite of ds_ldap::getContainer()).\n *\n * @param string The DN whose RDN to return.\n * @param boolean If true, include attributes in the RDN string. See http://php.net/ldap_explode_dn for details\n * @return string The RDN\n */\nfunction get_rdn($dn,$include_attrs=0,$decode=false) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\tif (is_null($dn))\n\t\treturn null;\n\n\t$rdn = pla_explode_dn($dn,$include_attrs);\n\tif (! count($rdn) || ! isset($rdn[0]))\n\t\treturn $dn;\n\n\tif ($decode)\n\t\t$rdn = dn_unescape($rdn[0]);\n\telse\n\t\t$rdn = $rdn[0];\n\n\treturn $rdn;\n}\n\n/**\n * Split an RDN into its attributes\n */\nfunction rdn_explode($rdn) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t# Setup to work out our RDN.\n\t$rdnarray = explode('\\+',$rdn);\n\n\t# Capture items that have +, but are not an attribute\n\tforeach ($rdnarray as $index => $val) {\n\t\tif (preg_match('/=/',$val))\n\t\t\t$validindex = $index;\n\n\t\tif (! preg_match('/=/',$val)) {\n\t\t\t$rdnarray[$validindex] .= '+'.$val;\n\t\t\tunset($rdnarray[$index]);\n\t\t}\n\t}\n\n\treturn $rdnarray;\n}\n\n/**\n * Given an LDAP error number, returns a verbose description of the error.\n * This function parses ldap_error_codes.txt and looks up the specified\n * ldap error number, and returns the verbose message defined in that file.\n *\n * <code>\n *  Array (\n *    [title] => \"Invalid Credentials\"\n *    [description] => \"An invalid username and/or password was supplied to the LDAP server.\"\n *  )\n * </code>\n *\n * @param string The hex error number (ie, \"0x42\") of the LDAP error of interest.\n * @return array An associative array contianing the error title and description like so:\n */\nfunction pla_verbose_error($key) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\tstatic $CACHE = array();\n\n\tif (! count($CACHE)) {\n\t\t$source_file = LIBDIR.'ldap_error_codes.txt';\n\n\t\tif (! file_exists($source_file) || ! is_readable($source_file) || ! ($f = fopen($source_file,'r')))\n\t\t\treturn false;\n\n\t\t$contents = fread($f,filesize($source_file));\n\t\tfclose($f);\n\t\t$entries = array();\n\t\tpreg_match_all(\"/0x[A-Fa-f0-9][A-Za-z0-9]\\s+[0-9A-Za-z_]+\\s+\\\"[^\\\"]*\\\"\\n/\",\n\t\t\t\t$contents,$entries);\n\n\t\tforeach ($entries[0] as $values) {\n\t\t\t$entry = array();\n\t\t\tpreg_match(\"/(0x[A-Za-z0-9][A-Za-z0-9])\\s+([0-9A-Za-z_]+)\\s+\\\"([^\\\"]*)\\\"/\",$values,$entry);\n\n\t\t\t$hex_code = isset($entry[1]) ? $entry[1] : null;\n\t\t\t$title = isset($entry[2]) ? $entry[2] : null;\n\t\t\t$desc = isset($entry[3]) ? $entry[3] : null;\n\t\t\t$desc = preg_replace('/\\s+/',' ',$desc);\n\t\t\t$CACHE[$hex_code] = array('title'=>$title,'desc'=>$desc);\n\t\t}\n\t}\n\n\tif (isset($CACHE[$key]))\n\t\treturn $CACHE[$key];\n\telse\n\t\treturn array('title' => null,'desc' => null);\n}\n\n/**\n * Given an LDAP OID number, returns a verbose description of the OID.\n * This function parses ldap_supported_oids.txt and looks up the specified\n * OID, and returns the verbose message defined in that file.\n *\n * <code>\n *  Array (\n *    [title] => All Operational Attribute\n *    [ref] => RFC 3673\n *    [desc] => An LDAP extension which clients may use to request the return of all operational attributes.\n *  )\n * </code>\n *\n * @param string The OID number (ie, \"1.3.6.1.4.1.4203.1.5.1\") of the OID of interest.\n * @return array An associative array contianing the OID title and description like so:\n */\nfunction support_oid_to_text($key) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\tstatic $CACHE = array();\n\n\t$unknown = array();\n\t$unknown['desc'] = 'We have no description for this OID, if you know what this OID provides, please let us know. Please also include an RFC reference if it is available.';\n\t$unknown['title'] = 'Can you help with this OID info?';\n\n\tif (! count($CACHE)) {\n\t\t$source_file = LIBDIR.'ldap_supported_oids.txt';\n\n\t\tif (! file_exists($source_file) || ! is_readable($source_file) || ! ($f = fopen($source_file,'r')))\n\t\t\treturn false;\n\n\t\t$contents = fread($f,filesize($source_file));\n\t\tfclose($f);\n\t\t$entries = array();\n\t\tpreg_match_all(\"/[0-9]\\..+\\s+\\\"[^\\\"]*\\\"\\n/\",$contents,$entries);\n\n\t\tforeach ($entries[0] as $values) {\n\t\t\t$entry = array();\n\t\t\tpreg_match(\"/([0-9]\\.([0-9]+\\.)*[0-9]+)(\\s+\\\"([^\\\"]*)\\\")?(\\s+\\\"([^\\\"]*)\\\")?(\\s+\\\"([^\\\"]*)\\\")?/\",$values,$entry);\n\t\t\t$oid_id = isset($entry[1]) ? $entry[1] : null;\n\n\t\t\tif ($oid_id) {\n\t\t\t\t$CACHE[$oid_id]['title'] = isset($entry[4]) ? $entry[4] : null;\n\t\t\t\t$CACHE[$oid_id]['ref'] = isset($entry[6]) ? $entry[6] : null;\n\t\t\t\t$desc = isset($entry[8]) ? $entry[8] : sprintf('<acronym title=\"%s\">%s</acronym>',$unknown['desc'],$unknown['title']);\n\t\t\t\t$CACHE[$oid_id]['desc'] = preg_replace('/\\s+/',' ',$desc);\n\t\t\t}\n\t\t}\n\t}\n\n\tif (isset($CACHE[$key]))\n\t\treturn $CACHE[$key];\n\telse\n\t\treturn array(\n\t\t\t'title'=>$key,\n\t\t\t'ref'=>null,\n\t\t\t'desc'=>sprintf('<acronym title=\"%s\">%s</acronym>',$unknown['desc'],$unknown['title']));\n}\n\n/**\n * Print an LDAP error message\n */\nfunction ldap_error_msg($msg,$errnum) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$body = '<table border=\"0\">';\n\n\t$errnum = ('0x'.str_pad(dechex($errnum),2,0,STR_PAD_LEFT));\n\t$verbose_error = pla_verbose_error($errnum);\n\n\t$body .= sprintf('<tr><td><b>%s</b>:</td><td>%s</td></tr>',_('LDAP said'),$msg);\n\n\tif ($verbose_error) {\n\t\t$body .= sprintf('<tr><td><b>%s</b>:</td><td>%s (%s)</td></tr>',_('Error number'),$errnum,$verbose_error['title']);\n\t\t$body .= sprintf('<tr><td><b>%s</b>:</td><td>%s</td></tr>',_('Description'),$verbose_error['desc']);\n\n\t} else {\n\t\t$body .= sprintf('<tr><td><b>%s</b>:</td><td>%s</td></tr>',_('Error number'),$errnum);\n\t\t$body .= sprintf('<tr><td><b>%s</b>:</td><td>(%s)</td></tr>',_('Description'),_('no description available'));\n\t}\n\n\t$body .= '</table>';\n\n\treturn $body;\n}\n\n/**\n * Draw the jpegPhoto image(s) for an entry wrapped in HTML. Many options are available to\n * specify how the images are to be displayed.\n *\n * Usage Examples:\n *  <code>\n *   draw_jpeg_photo(0,'cn=Bob,ou=People,dc=example,dc=com',\"jpegPhoto\",0,true,array('img_opts'=>\"border: 1px; width: 150px\"));\n *   draw_jpeg_photo(1,'cn=Fred,ou=People,dc=example,dc=com',null,1);\n *  </code>\n *\n * @param object The Server to get the image from.\n * @param string The DN of the entry that contains the jpeg attribute you want to draw.\n * @param string The name of the attribute containing the jpeg data (usually 'jpegPhoto').\n * @param int Index of the attribute to draw\n * @param boolean If true, draws a button beneath the image titled 'Delete' allowing the user\n *                to delete the jpeg attribute by calling JavaScript function deleteAttribute() provided\n *                in the default modification template.\n * @param array Specifies optional image and CSS style attributes for the table tag. Supported keys are\n *                fixed_width, fixed_height, img_opts.\n */\nfunction draw_jpeg_photo($server,$dn,$attr_name='jpegphoto',$index,$draw_delete_buttons=false,$options=array()) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$fixed = array();\n\t$fixed['width'] = isset($options['fixed_width']) ? $options['fixed_width'] : false;\n\t$fixed['height'] = isset($options['fixed_height']) ? $options['fixed_height'] : false;\n\n\tif (is_null($server))\n\t\t$jpeg_data = $_SESSION['tmp'];\n\telse\n\t\t$jpeg_data = $server->getDNAttrValues($dn,null,LDAP_DEREF_NEVER,array($attr_name));\n\n\tif (! isset($jpeg_data[$attr_name][$index]) || ! $jpeg_data[$attr_name][$index]) {\n\t\tsystem_message(array(\n\t\t\t'title'=>_('Unable to retrieve image'),\n\t\t\t'body'=>sprintf('%s %s',\n\t\t\t\t_('Could not fetch jpeg data for attribute'),$attr_name),\n\t\t\t'type'=>'warn'));\n\n\t\t# This should atleast generate some text that says \"Image not available\"\n\t\tprintf('<img src=\"view_jpeg_photo.php?location=session&attr=%s\" alt=\"Photo\" />',$attr_name);\n\n\t\treturn;\n\t}\n\n\t$width = 0;\n\t$height = 0;\n\n\tif (function_exists('getimagesize')) {\n\t\t$jpeg_temp_dir = realpath($_SESSION[APPCONFIG]->getValue('jpeg','tmpdir').'/');\n\t\tif (! is_writable($jpeg_temp_dir))\n\t\t\tsystem_message(array(\n\t\t\t\t'title'=>_('Unable to write to jpeg tmp directory'),\n\t\t\t\t'body'=>_('Please set jpeg,tmpdir to a writable directory in the phpLDAPadmin config.php'),\n\t\t\t\t'type'=>'warn'));\n\n\t\telse {\n\t\t\t# We have an image to display\n\t\t\t$jpeg_filename = tempnam($jpeg_temp_dir.'/','pla');\n\t\t\t$outjpeg = @file_put_contents($jpeg_filename,$jpeg_data[$attr_name][$index]);\n\n\t\t\tif (! $outjpeg) {\n\t\t\t\tsystem_message(array(\n\t\t\t\t\t'title'=>_('Error writing to jpeg tmp directory'),\n\t\t\t\t\t'body'=>sprintf(_('Please check jpeg,tmpdir is a writable directory in the phpLDAPadmin config.php'),$jpeg_temp_dir),\n\t\t\t\t\t'type'=>'warn'));\n\n\t\t\t} elseif ($outjpeg < 6) {\n\t\t\t\tsystem_message(array(\n\t\t\t\t\t'title'=>sprintf('%s %s',$attr_name,_('contains errors')),\n\t\t\t\t\t'body'=>_('It appears that the jpeg image may not be a jpeg image'),\n\t\t\t\t\t'type'=>'warn'));\n\n\t\t\t} else {\n\t\t\t\t$jpeg_dimensions = getimagesize($jpeg_filename);\n\t\t\t\t$width = $jpeg_dimensions[0];\n\t\t\t\t$height = $jpeg_dimensions[1];\n\t\t\t}\n\n\t\t\tunlink($jpeg_filename);\n\t\t}\n\t}\n\n\tif ($width > 300) {\n\t\t$scale_factor = 300 / $width;\n\t\t$img_width = 300;\n\t\t$img_height = intval($height * $scale_factor);\n\n\t} else {\n\t\t$img_width = $width;\n\t\t$img_height = $height;\n\t}\n\n\t$href = sprintf('view_jpeg_photo.php?dn=%s&index=%s&attr=%s',rawurlencode($dn),$index,$attr_name);\n\n\tprintf('<acronym title=\"%s %s. %s x %s %s.\">',number_format($outjpeg),_('bytes'),$width,$height,_('pixels'));\n\n\tprintf('<img src=\"%s&amp;%s\" alt=\"Photo\" %s%s%s />',\n\t\thtmlspecialchars($href),\n\t\tis_null($server) ? 'location=session' : sprintf('server_id=%s',$server->getIndex()),\n\t\t(! $img_width || $fixed['width'] ? '' : sprintf('width=\"%s\"',$img_width)),\n\t\t(! $img_height || $fixed['height'] ? '' : sprintf('height=\"%s\"',$img_height)),\n\t\t(isset($options['img_opts']) ? $options['img_opts'] : ''));\n\n\techo '</acronym>';\n\n\tif ($draw_delete_buttons)\n\t\t# <!-- JavaScript function deleteJpegPhoto() to be defined later by calling script -->\n\t\tprintf('<br/><a href=\"javascript:deleteAttribute(\\'%s\\');\" style=\"color:red; font-size: 75%%\">%s</a>',\n\t\t\t$attr_name,_('Delete photo'));\n}\n\n/**\n * Return the list of available password types\n *\n * @todo Dynamically work this list out so we only present hashes that we can encrypt\n */\nfunction password_types() {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\treturn array(\n\t\t''=>'clear',\n\t\t'blowfish'=>'blowfish',\n\t\t'crypt'=>'crypt',\n\t\t'ext_des'=>'ext_des',\n\t\t'md5'=>'md5',\n\t\t'k5key'=>'k5key',\n\t\t'md5crypt'=>'md5crypt',\n\t\t'sha'=>'sha',\n\t\t'smd5'=>'smd5',\n\t\t'ssha'=>'ssha',\n\t\t'sha512'=>'sha512',\n\t\t'sha256crypt'=>'sha256crypt',\n\t\t'sha512crypt'=>'sha512crypt',\n\t);\n}\n\n/**\n * Hashes a password and returns the hash based on the specified enc_type.\n *\n * @param string The password to hash in clear text.\n * @param string Standard LDAP encryption type which must be one of\n *        crypt, ext_des, md5crypt, blowfish, md5, sha, smd5, ssha, sha512,\n *        sha256crypt, sha512crypt, or clear.\n * @return string The hashed password.\n */\nfunction pla_password_hash($password_clear,$enc_type) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$enc_type = strtolower($enc_type);\n\n\tswitch($enc_type) {\n\t\tcase 'blowfish':\n\t\t\tif (! defined('CRYPT_BLOWFISH') || CRYPT_BLOWFISH == 0)\n\t\t\t\terror(_('Your system crypt library does not support blowfish encryption.'),'error','index.php');\n\n\t\t\t# Hardcoded to second blowfish version and set number of rounds\n\t\t\t$new_value = sprintf('{CRYPT}%s',crypt($password_clear,'$2a$12$'.random_salt(13)));\n\n\t\t\tbreak;\n\n\t\tcase 'crypt':\n\t\t\tif ($_SESSION[APPCONFIG]->getValue('password', 'no_random_crypt_salt'))\n\t\t\t\t$new_value = sprintf('{CRYPT}%s',crypt($password_clear,substr($password_clear,0,2)));\n\t\t\telse\n\t\t\t\t$new_value = sprintf('{CRYPT}%s',crypt($password_clear,random_salt(2)));\n\n\t\t\tbreak;\n\n\t\tcase 'ext_des':\n\t\t\t# Extended des crypt. see OpenBSD crypt man page.\n\t\t\tif (! defined('CRYPT_EXT_DES') || CRYPT_EXT_DES == 0)\n\t\t\t\terror(_('Your system crypt library does not support extended DES encryption.'),'error','index.php');\n\n\t\t\t$new_value = sprintf('{CRYPT}%s',crypt($password_clear,'_'.random_salt(8)));\n\n\t\t\tbreak;\n\n\t\tcase 'k5key':\n\t\t\t$new_value = sprintf('{K5KEY}%s',$password_clear);\n\n\t\t\tsystem_message(array(\n\t\t\t\t'title'=>_('Unable to Encrypt Password'),\n\t\t\t\t'body'=>'phpLDAPadmin cannot encrypt K5KEY passwords',\n\t\t\t\t'type'=>'warn'));\n\n\t\t\tbreak;\n\n\t\tcase 'md5':\n\t\t\t$new_value = sprintf('{MD5}%s',base64_encode(pack('H*',md5($password_clear))));\n\t\t\tbreak;\n\n\t\tcase 'md5crypt':\n\t\t\tif (! defined('CRYPT_MD5') || CRYPT_MD5 == 0)\n\t\t\t\terror(_('Your system crypt library does not support md5crypt encryption.'),'error','index.php');\n\n\t\t\t$new_value = sprintf('{CRYPT}%s',crypt($password_clear,'$1$'.random_salt(9)));\n\n\t\t\tbreak;\n\n\t\tcase 'sha':\n\t\t\t# Use php 4.3.0+ sha1 function, if it is available.\n\t\t\tif (function_exists('sha1'))\n\t\t\t\t$new_value = sprintf('{SHA}%s',base64_encode(pack('H*',sha1($password_clear))));\n\t\t\telseif (function_exists('mhash'))\n\t\t\t\t$new_value = sprintf('{SHA}%s',base64_encode(mhash(MHASH_SHA1,$password_clear)));\n\t\t\telse\n\t\t\t\terror(_('Your PHP install does not have the mhash() function. Cannot do SHA hashes.'),'error','index.php');\n\n\t\t\tbreak;\n\n\t\tcase 'ssha':\n\t\t\tif (function_exists('mhash') && function_exists('mhash_keygen_s2k')) {\n\t\t\t\tmt_srand((double)microtime()*1000000);\n\t\t\t\t$salt = mhash_keygen_s2k(MHASH_SHA1,$password_clear,substr(pack('h*',md5(mt_rand())),0,8),4);\n\t\t\t\t$new_value = sprintf('{SSHA}%s',base64_encode(mhash(MHASH_SHA1,$password_clear.$salt).$salt));\n\n\t\t\t} else {\n\t\t\t\terror(_('Your PHP install does not have the mhash() or mhash_keygen_s2k() function. Cannot do S2K hashes.'),'error','index.php');\n\t\t\t}\n\n\t\t\tbreak;\n\n\t\tcase 'smd5':\n\t\t\tif (function_exists('mhash') && function_exists('mhash_keygen_s2k')) {\n\t\t\t\tmt_srand((double)microtime()*1000000);\n\t\t\t\t$salt = mhash_keygen_s2k(MHASH_MD5,$password_clear,substr(pack('h*',md5(mt_rand())),0,8),4);\n\t\t\t\t$new_value = sprintf('{SMD5}%s',base64_encode(mhash(MHASH_MD5,$password_clear.$salt).$salt));\n\n\t\t\t} else {\n\t\t\t\terror(_('Your PHP install does not have the mhash() or mhash_keygen_s2k() function. Cannot do S2K hashes.'),'error','index.php');\n\t\t\t}\n\n\t\t\tbreak;\n\n\t\tcase 'sha512':\n\t\t\tif (function_exists('openssl_digest') && function_exists('base64_encode')) {\n\t\t\t\t$new_value = sprintf('{SHA512}%s', base64_encode(openssl_digest($password_clear, 'sha512', true)));\n\n\t\t\t} else {\n\t\t\t\terror(_('Your PHP install doest not have the openssl_digest() or base64_encode() function. Cannot do SHA512 hashes. '),'error','index.php');\n\t\t\t}\n\n\t\t\tbreak;\n\n\t\tcase 'sha256crypt':\n\t\t\tif (! defined('CRYPT_SHA256') || CRYPT_SHA256 == 0)\n\t\t\t\terror(_('Your system crypt library does not support sha256crypt encryption.'),'error','index.php');\n\t\t\t$new_value = sprintf('{CRYPT}%s',crypt($password_clear,'$5$'.random_salt(8)));\n\n\t\t\tbreak;\n\n\t\tcase 'sha512crypt':\n\t\t\tif (! defined('CRYPT_SHA512') || CRYPT_SHA512 == 0)\n\t\t\t\terror(_('Your system crypt library does not support sha512crypt encryption.'),'error','index.php');\n\t\t\t$new_value = sprintf('{CRYPT}%s',crypt($password_clear,'$6$'.random_salt(8)));\n\n\t\t\tbreak;\n\n\t\tcase 'clear':\n\t\tdefault:\n\t\t\t$new_value = $password_clear;\n\t}\n\n\treturn $new_value;\n}\n\n/**\n * Given a clear-text password and a hash, this function determines if the clear-text password\n * is the password that was used to generate the hash. This is handy to verify a user's password\n * when all that is given is the hash and a \"guess\".\n * @param String The hash.\n * @param String The password in clear text to test.\n * @return Boolean True if the clear password matches the hash, and false otherwise.\n */\nfunction password_check($cryptedpassword,$plainpassword,$attribute='userpassword') {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\tif (in_array($attribute,array('sambalmpassword','sambantpassword'))) {\n\t\t$smb = new smbHash;\n\n\t\tswitch($attribute) {\n\t\t\tcase 'sambalmpassword':\n\t\t\t\tif (strcmp($smb->lmhash($plainpassword),strtoupper($cryptedpassword)) == 0)\n\t\t\t\t\treturn true;\n\t\t\t\telse\n\t\t\t\t\treturn false;\n\n\t\t\tcase 'sambantpassword':\n\t\t\t\tif (strcmp($smb->nthash($plainpassword),strtoupper($cryptedpassword)) == 0)\n\t\t\t\t\treturn true;\n\t\t\t\telse\n\t\t\t\t\treturn false;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tif (preg_match('/{([^}]+)}(.*)/',$cryptedpassword,$matches)) {\n\t\t$cryptedpassword = $matches[2];\n\t\t$cypher = strtolower($matches[1]);\n\n\t} else {\n\t\t$cypher = null;\n\t}\n\n\tswitch($cypher) {\n\t\t# SSHA crypted passwords\n\t\tcase 'ssha':\n\t\t\t# Check php mhash support before using it\n\t\t\tif (function_exists('mhash')) {\n\t\t\t\t$hash = base64_decode($cryptedpassword);\n\n\t\t\t\t# OpenLDAP uses a 4 byte salt, SunDS uses an 8 byte salt - both from char 20.\n\t\t\t\t$salt = substr($hash,20);\n\t\t\t\t$new_hash = base64_encode(mhash(MHASH_SHA1,$plainpassword.$salt).$salt);\n\n\t\t\t\tif (strcmp($cryptedpassword,$new_hash) == 0)\n\t\t\t\t\treturn true;\n\t\t\t\telse\n\t\t\t\t\treturn false;\n\n\t\t\t} else {\n\t\t\t\terror(_('Your PHP install does not have the mhash() function. Cannot do SHA hashes.'),'error','index.php');\n\t\t\t}\n\n\t\t\tbreak;\n\n\t\t# Salted MD5\n\t\tcase 'smd5':\n\t\t\t# Check php mhash support before using it\n\t\t\tif (function_exists('mhash')) {\n\t\t\t\t$hash = base64_decode($cryptedpassword);\n\t\t\t\t$salt = substr($hash,16);\n\t\t\t\t$new_hash = base64_encode(mhash(MHASH_MD5,$plainpassword.$salt).$salt);\n\n\t\t\t\tif (strcmp($cryptedpassword,$new_hash) == 0)\n\t\t\t\t\treturn true;\n\t\t\t\telse\n\t\t\t\t\treturn false;\n\n\t\t\t} else {\n\t\t\t\terror(_('Your PHP install does not have the mhash() function. Cannot do SHA hashes.'),'error','index.php');\n\t\t\t}\n\n\t\t\tbreak;\n\n\t\t# SHA crypted passwords\n\t\tcase 'sha':\n\t\t\tif (strcasecmp(pla_password_hash($plainpassword,'sha'),'{SHA}'.$cryptedpassword) == 0)\n\t\t\t\treturn true;\n\t\t\telse\n\t\t\t\treturn false;\n\n\t\t\tbreak;\n\n\t\t# MD5 crypted passwords\n\t\tcase 'md5':\n\t\t\tif( strcasecmp(pla_password_hash($plainpassword,'md5'),'{MD5}'.$cryptedpassword) == 0)\n\t\t\t\treturn true;\n\t\t\telse\n\t\t\t\treturn false;\n\n\t\t\tbreak;\n\n\t\t# Crypt passwords\n\t\tcase 'crypt':\n\t\t\t# Check if it's blowfish crypt\n\t\t\tif (preg_match('/^\\\\$2+/',$cryptedpassword)) {\n\n\t\t\t\t# Make sure that web server supports blowfish crypt\n\t\t\t\tif (! defined('CRYPT_BLOWFISH') || CRYPT_BLOWFISH == 0)\n\t\t\t\t\terror(_('Your system crypt library does not support blowfish encryption.'),'error','index.php');\n\n\t\t\t\tlist($version,$rounds,$salt_hash) = explode('$',$cryptedpassword);\n\n\t\t\t\tif (crypt($plainpassword,'$'.$version.'$'.$rounds.'$'.$salt_hash) == $cryptedpassword)\n\t\t\t\t\treturn true;\n\t\t\t\telse\n\t\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t# Check if it's an crypted md5\n\t\t\telseif (strstr($cryptedpassword,'$1$')) {\n\n\t\t\t\t# Make sure that web server supports md5 crypt\n\t\t\t\tif (! defined('CRYPT_MD5') || CRYPT_MD5 == 0)\n\t\t\t\t\terror(_('Your system crypt library does not support md5crypt encryption.'),'error','index.php');\n\n\t\t\t\tlist($dummy,$type,$salt,$hash) = explode('$',$cryptedpassword);\n\n\t\t\t\tif (crypt($plainpassword,'$1$'.$salt) == $cryptedpassword)\n\t\t\t\t\treturn true;\n\t\t\t\telse\n\t\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t# Check if it's extended des crypt\n\t\t\telseif (strstr($cryptedpassword,'_')) {\n\n\t\t\t\t# Make sure that web server supports ext_des\n\t\t\t\tif (! defined('CRYPT_EXT_DES') || CRYPT_EXT_DES == 0)\n\t\t\t\t\terror(_('Your system crypt library does not support extended DES encryption.'),'error','index.php');\n\n\t\t\t\tif (crypt($plainpassword,$cryptedpassword) == $cryptedpassword)\n\t\t\t\t\treturn true;\n\t\t\t\telse\n\t\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t# Password is plain crypt\n\t\t\telse {\n\n\t\t\t\tif (crypt($plainpassword,$cryptedpassword) == $cryptedpassword)\n\t\t\t\t\treturn true;\n\t\t\t\telse\n\t\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tbreak;\n\n\t\t# SHA512 crypted passwords\n\t\tcase 'sha512':\n\t\t\tif (strcasecmp(pla_password_hash($plainpassword,'sha512'),'{SHA512}'.$cryptedpassword) == 0)\n\t\t\t\treturn true;\n\t\t\telse\n\t\t\t\treturn false;\n\n\t\t\tbreak;\n\n\t\t# No crypt is given assume plaintext passwords are used\n\t\tdefault:\n\t\t\tif ($plainpassword == $cryptedpassword)\n\t\t\t\treturn true;\n\t\t\telse\n\t\t\t\treturn false;\n\t}\n}\n\n/**\n * Detects password encryption type\n *\n * Returns crypto string listed in braces. If it is 'crypt' password,\n * returns crypto detected in password hash. Function should detect\n * md5crypt, blowfish and extended DES crypt. If function fails to detect\n * encryption type, it returns NULL.\n * @param string Hashed password\n * @return string\n */\nfunction get_enc_type($user_password) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t# Capture the stuff in the { } to determine if this is crypt, md5, etc.\n\t$enc_type = null;\n\n\tif (preg_match('/{([^}]+)}/',$user_password,$enc_type))\n\t\t$enc_type = strtolower($enc_type[1]);\n\telse\n\t\treturn null;\n\n\t# Handle crypt types\n\tif (strcasecmp($enc_type,'crypt') == 0) {\n\n\t\t# No need to check for standard crypt, because enc_type is already equal to 'crypt'.\n\t\tif (preg_match('/{[^}]+}\\\\$1\\\\$+/',$user_password))\n\t\t\t$enc_type = 'md5crypt';\n\n\t\telseif (preg_match('/{[^}]+}\\\\$2+/',$user_password))\n\t\t\t$enc_type = 'blowfish';\n\n\t\telseif (preg_match('/{[^}]+}_+/',$user_password))\n\t\t\t$enc_type = 'ext_des';\n\t}\n\n\treturn $enc_type;\n}\n\n/**\n * Draws an HTML browse button which, when clicked, pops up a DN chooser dialog.\n * @param string The name of the form element to which this chooser\n *         dialog will publish the user's choice. The form element must be a member\n *         of a form with the \"name\" or \"id\" attribute set in the form tag, and the element\n *         must also define \"name\" or \"id\" for JavaScript to uniquely identify it.\n *         Example $form_element values may include \"creation_form.container\" or\n *         \"edit_form.member_uid\". See /templates/modification/default.php for example usage.\n * @param boolean (optional) If true, the function draws the localized text \"choose\" to the right of the button.\n */\nfunction draw_chooser_link($form,$element,$include_choose_text=true,$rdn='none') {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$href = sprintf(\"javascript:dnChooserPopup('%s','%s','%s');\",$form,$element,$rdn == 'none' ? '' : rawurlencode($rdn));\n\t$title = _('Click to popup a dialog to select an entry (DN) graphically');\n\n\tprintf('<a href=\"%s\" title=\"%s\"><img class=\"chooser\" src=\"%s/find.png\" alt=\"Find\" /></a>',$href,$title,IMGDIR);\n\n\tif ($include_choose_text)\n\t\tprintf('<span class=\"x-small\"><a href=\"%s\" title=\"%s\">%s</a></span>',$href,$title,_('browse'));\n}\n\n/**\n * http://php.net/manual/en/function.ldap-explode-dn.php#34724\n * fixed for:\n * Keep attention on UTF8 encoded DNs. Since openLDAP >=2.1.2\n * ldap_explode_dn turns unprintable chars (in the ASCII sense, UTF8\n * encoded) into \\<hexcode>.\n */\nfunction ldap_explode_dn_patch($dn,$with_attrib) {\n\t$result = ldap_explode_dn($dn,$with_attrib);\n\tif (! $result)\n\t\treturn null;\n\n\t# translate hex code into ascii again\n\tforeach ($result as $key => $value) {\n\t\t$result[$key] = preg_replace_callback(\n\t\t\t\"/\\\\\\([0-9A-Fa-f]{2})/\",\n\t\t\tfunction ($matches) {\n\t\t\t\treturn chr(hexdec($matches[1]));\n\t\t\t},\n\t\t\t$value\n\t\t);\n\t}\n\n\treturn $result;\n}\n\n/**\n * Explode a DN into an array of its RDN parts.\n *\n * NOTE: When a multivalue RDN is passed to ldap_explode_dn, the results returns with 'value + value';\n *\n * <code>\n *  Array (\n *    [0] => uid=ppratt\n *    [1] => ou=People\n *    [2] => dc=example\n *    [3] => dc=com\n *  )\n * </code>\n *\n * @param string The DN to explode.\n * @param int (optional) Whether to include attribute names (see http://php.net/ldap_explode_dn for details)\n * @return array An array of RDN parts of this format:\n */\nfunction pla_explode_dn($dn,$with_attributes=0) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\tglobal $CACHE;\n\n\tif (isset($CACHE['explode'][$dn][$with_attributes])) {\n\t\tif (DEBUG_ENABLED)\n\t\t\tdebug_log('Return CACHED result (%s) for (%s)',1,0,__FILE__,__LINE__,__METHOD__,\n\t\t\t\t$CACHE['explode'][$dn][$with_attributes],$dn);\n\n\t\treturn $CACHE['explode'][$dn][$with_attributes];\n\t}\n\n\t$dn = addcslashes($dn,'<>+\";');\n\n\t# split the dn\n\t$result[0] = ldap_explode_dn_patch(dn_escape($dn),0);\n\t$result[1] = ldap_explode_dn_patch(dn_escape($dn),1);\n\tif (! $result[$with_attributes]) {\n\t\tif (DEBUG_ENABLED)\n\t\t\tdebug_log('Returning NULL - NO result.',1,0,__FILE__,__LINE__,__METHOD__);\n\n\t\treturn array();\n\t}\n\n\t# Remove our count value that ldap_explode_dn returns us.\n\tunset($result[0]['count']);\n\tunset($result[1]['count']);\n\n\t# Record the forward and reverse entries in the cache.\n\tforeach ($result as $key => $value) {\n\t\t# translate hex code into ascii for display\n\t\t$result[$key] = dn_unescape($value);\n\n\t\t$CACHE['explode'][implode(',',$result[0])][$key] = $result[$key];\n\t\t$CACHE['explode'][implode(',',array_reverse($result[0]))][$key] = array_reverse($result[$key]);\n\t}\n\n\tif (DEBUG_ENABLED)\n\t\tdebug_log('Returning (%s)',1,0,__FILE__,__LINE__,__METHOD__,$result[$with_attributes]);\n\n\treturn $result[$with_attributes];\n}\n\n/**\n * Parse a DN and escape any special characters\n */\nfunction dn_escape($dn) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$olddn = $dn;\n\n\t# Check if the RDN has a comma and escape it.\n\twhile (preg_match('/([^\\\\\\\\]),(\\s*[^=]*\\s*),/',$dn))\n\t\t$dn = preg_replace('/([^\\\\\\\\]),(\\s*[^=]*\\s*),/','$1\\\\\\\\2C$2,',$dn);\n\n\t$dn = preg_replace('/([^\\\\\\\\]),(\\s*[^=]*\\s*)([^,])$/','$1\\\\\\\\2C$2$3',$dn);\n\n\tif (DEBUG_ENABLED)\n\t\tdebug_log('Returning (%s)',1,0,__FILE__,__LINE__,__METHOD__,$dn);\n\n\treturn $dn;\n}\n\n/**\n * Parse a DN and unescape any special characters\n */\nfunction dn_unescape($dn) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\tif (is_array($dn)) {\n\t\t$a = array();\n\n\t\tforeach ($dn as $key => $rdn)\n\t\t\t$a[$key] = preg_replace_callback('/\\\\\\([0-9A-Fa-f]{2})/',\n\t\t\t\tfunction ($r) {\n\t\t\t\t\treturn chr(hexdec($r[1]));\n\t\t\t\t},\n\t\t\t\t$rdn\n\t\t\t);\n\n\t\treturn $a;\n\n\t} else {\n\t\treturn preg_replace_callback('/\\\\\\([0-9A-Fa-f]{2})/',\n\t\t\tfunction ($r) {\n\t\t\t\treturn chr(hexdec($r[1]));\n\t\t\t},\n\t\t\t$dn\n\t\t);\n\t}\n}\n\n/**\n * Fetches the URL for the specified item. This is a convenience function for\n * fetching project HREFs (like bugs)\n *\n * @param string One of \"open_bugs\", \"add_bug\", \"donate\", or \"add_rfe\"\n *               (rfe = request for enhancement)\n * @return string The URL to the requested item.\n */\nfunction get_href($type,$extra_info='') {\n\t$pla = 'http://phpldapadmin.sourceforge.net';\n\n\tswitch($type) {\n\t\tcase 'add_bug':\n\t\t\treturn 'https://github.com/leenooks/phpLDAPadmin/issues';\n\t\tcase 'add_rfe':\n\t\t\treturn 'https://github.com/leenooks/phpLDAPadmin/issues';\n\t\tcase 'credits':\n\t\t\treturn sprintf('%s/Credits',$pla);\n\t\tcase 'documentation':\n\t\t\treturn sprintf('%s/Documentation',$pla);\n\t\tcase 'donate':\n\t\t\treturn 'https://sourceforge.net/donate/index.php?group_id=61828';\n\t\tcase 'forum':\n\t\t\treturn 'https://stackoverflow.com/questions/tagged/phpldapadmin';\n\t\tcase 'web':\n\t\t\treturn sprintf('%s',$pla);\n\t\tdefault:\n\t\t\treturn null;\n\t}\n}\n\n/**\n * Returns the current time as a double (including micro-seconds).\n *\n * @return double The current time in seconds since the beginning of the UNIX epoch (Midnight Jan. 1, 1970)\n */\nfunction utime() {\n\t$time = explode(' ',microtime());\n\t$usec = (double)$time[0];\n\t$sec = (double)$time[1];\n\treturn $sec + $usec;\n}\n\n/**\n * Converts an array to a query-string with the option to exclude certain variables\n * from the returned query string. This is convenient if callers want to convert the\n * current GET query string or POST array into a string and replace certain\n * variables with their own.\n *\n * @param array The associate array to convert whose form is such that the keys are the\n *              names of the variables and the values are said variables' values like this:\n *              <code>\n *               Array (\n *                 [server_id] = 0,\n *                 [dn] = \"dc=example,dc=com\",\n *                 [attr] = \"sn\"\n *               )\n *              </code>\n *              This will produce a string like this: \"server_id=0&dn=dc=example,dc=com&attr=sn\"\n * @param array (optional) An array of variables to exclude in the resulting string\n * @return string The string created from the array.\n */\nfunction array_to_query_string($array,$exclude_vars=array()) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\tif (! is_array($array) || ! count($array))\n\t\treturn '';\n\n\t$str = '';\n\t$i = 0;\n\tforeach ($array as $name => $val)\n\t\tif (! in_array($name,$exclude_vars))\n\t\t\tif (is_array($val))\n\t\t\t\tforeach ($val as $v) {\n\t\t\t\t\tif ($i++ > 0)\n\t\t\t\t\t\t$str .= '&';\n\n\t\t\t\t\t$str .= sprintf('%s[]=%s',rawurlencode($name),rawurlencode($v));\n\t\t\t\t}\n\n\t\t\telse {\n\t\t\t\tif ($i++ > 0)\n\t\t\t\t\t$str .= '&';\n\n\t\t\t\t$str .= sprintf('%s=%s',rawurlencode($name),rawurlencode($val));\n\t\t\t}\n\n\treturn $str;\n}\n\n/**\n * Reverses a DN such that the top-level RDN is first and the bottom-level RDN is last\n * For example:\n * <code>\n *   cn=Brigham,ou=People,dc=example,dc=com\n * </code>\n * Becomes:\n * <code>\n *   dc=com,dc=example,ou=People,cn=Brigham\n * </code>\n * This makes it possible to sort lists of DNs such that they are grouped by container.\n *\n * @param string The DN to reverse\n * @return string The reversed DN\n *\n * @see pla_compare_dns\n * @see pla_explode_dns\n */\nfunction pla_reverse_dn($dn) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\treturn (implode(',',array_reverse(pla_explode_dn($dn))));\n}\n\n/**\n * Attribute sorting\n */\nfunction sortAttrs($a,$b) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\tif ($a == $b)\n\t\treturn 0;\n\n\t$server = $_SESSION[APPCONFIG]->getServer(get_request('server_id','REQUEST'));\n\t$attrs_display_order = arrayLower($_SESSION[APPCONFIG]->getValue('appearance','attr_display_order'));\n\n\t# Check if $a is in $attrs_display_order, get its key\n\t$a_key = array_search($a->getName(),$attrs_display_order);\n\t$b_key = array_search($b->getName(),$attrs_display_order);\n\n\tif ((! $a_key) && ($a_key !== 0))\n\t\tif ((! $a_key = array_search(strtolower($a->getFriendlyName()),$attrs_display_order)) && ($a_key !== 0))\n\t\t\t$a_key = count($attrs_display_order)+1;\n\n\tif ((! $b_key) && ($b_key !== 0))\n\t\tif ((! $b_key = array_search(strtolower($b->getFriendlyName()),$attrs_display_order)) && ($b_key !== 0))\n\t\t\t$b_key = count($attrs_display_order)+1;\n\n\t# Case where neither $a, nor $b are in $attrs_display_order, $a_key = $b_key = one greater than num elements.\n\t# So we sort them alphabetically\n\tif ($a_key === $b_key)\n\t\treturn strcasecmp($a->getFriendlyName(),$b->getFriendlyName());\n\n\t# Case where at least one attribute or its friendly name is in $attrs_display_order\n\t# return -1 if $a before $b in $attrs_display_order\n\treturn ($a_key < $b_key) ? -1 : 1;\n}\n\n/**\n * Reads an array and returns the array values back in lower case\n *\n * @param array $array The array to convert the values to lowercase.\n * @returns array Array with values converted to lowercase.\n */\nfunction arrayLower($array) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\tif (! is_array($array))\n\t\treturn $array;\n\n\t$newarray = array();\n\tforeach ($array as $key => $value)\n\t\t$newarray[$key] = strtolower($value);\n\n\treturn $newarray;\n}\n\n/**\n * Checks if a string exists in an array, ignoring case.\n *\n * @param string What you are looking for\n * @param array The array that you think it is in.\n * @return boolean True if its there, false if its not.\n */\nfunction in_array_ignore_case($needle,$haystack) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\tif (! is_array($haystack))\n\t\treturn false;\n\n\tif (! is_string($needle))\n\t\treturn false;\n\n\t$return = false;\n\n\tforeach ($haystack as $element) {\n\t\tif (is_string($element) && (strcasecmp($needle,$element) == 0)) {\n\t\t\t$return = true;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (DEBUG_ENABLED)\n\t\tdebug_log('Returning (%s)',1,0,__FILE__,__LINE__,__METHOD__,$return);\n\n\treturn $return;\n}\n\n/**\n * Gets a DN string using the user-configured tree_display_format string to format it.\n */\nfunction draw_formatted_dn($server,$entry) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$dn = $entry->getDn();\n\n\t$formats = $_SESSION[APPCONFIG]->getValue('appearance','tree_display_format');\n\n\tforeach ($formats as $format) {\n\t\t$has_none = false;\n\t\tpreg_match_all('/%[a-zA-Z_0-9]+/',$format,$tokens);\n\t\t$tokens = $tokens[0];\n\n\t\tif (DEBUG_ENABLED)\n\t\t\tdebug_log('The tokens are (%s)',1,0,__FILE__,__LINE__,__METHOD__,$tokens);\n\n\t\tforeach ($tokens as $token) {\n\t\t\tif (strcasecmp($token,'%dn') == 0)\n\t\t\t\t$format = str_replace($token,pretty_print_dn($dn),$format);\n\n\t\t\telseif (strcasecmp($token,'%rdn') == 0)\n\t\t\t\t$format = str_replace($token,pretty_print_dn($entry->getRDN()),$format);\n\n\t\t\telseif (strcasecmp($token,'%rdnvalue') == 0) {\n\t\t\t\t$rdn = get_rdn($dn,0,true);\n\t\t\t\t$rdn_value = explode('=',$rdn,2);\n\t\t\t\t$rdn_value = $rdn_value[1];\n\t\t\t\t$format = str_replace($token,$rdn_value,$format);\n\n\t\t\t} else {\n\t\t\t\t$attr_name = str_replace('%','',$token);\n\t\t\t\t$attr_values = $server->getDNAttrValue($dn,$attr_name);\n\n\t\t\t\tif (is_null($attr_values) || (count($attr_values) <= 0)) {\n\t\t\t\t\t$display = '&lt;'._('none').'&gt;';\n\t\t\t\t\t$has_none = true;\n\n\t\t\t\t} elseif (is_array($attr_values))\n\t\t\t\t\t$display = implode(', ',$attr_values);\n\n\t\t\t\telse\n\t\t\t\t\t$display = $attr_values;\n\n\t\t\t\t$format = str_replace($token,$display,$format);\n\t\t\t}\n\t\t}\n\n\t\t# If this format has all values available, use it. Otherwise, try the next one\n\t\tif (!$has_none)\n\t\t\treturn $format;\n\t}\n\n\treturn $format;\n}\n\n/**\n * Server html select list\n */\nfunction server_select_list($selected=null,$logged_on=false,$name='index',$isVisible=true,$js=null) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$count = 0;\n\t$server_menu_html = sprintf('<select name=\"%s\" id=\"%s\" %s>',$name,$name,$js);\n\n\tforeach ($_SESSION[APPCONFIG]->getServerList($isVisible) as $index => $server) {\n\t\tif ($server->isVisible()) {\n\n\t\t\tif ($logged_on && ! $server->isLoggedIn())\n\t\t\t\tcontinue;\n\n\t\t\t$count++;\n\t\t\t$server_menu_html .= sprintf('<option value=\"%s\" %s>%s</option>',\n\t\t\t\t$server->getIndex(),($server->getIndex() == $selected ? 'selected=\"selected\"' : ''),$server->getName());\n\n\t\t\t# We will set this variable, in case there is only 1 hit.\n\t\t\t$selected_server = $server;\n\t\t}\n\t}\n\n\t$server_menu_html .= '</select>';\n\n\tif ($count > 1)\n\t\treturn $server_menu_html;\n\n\telseif ($count)\n\t\treturn sprintf('%s <input type=\"hidden\" name=\"%s\" value=\"%s\" />',\n\t\t\t$selected_server->getName(),$name,$selected_server->getIndex());\n\n\telse\n\t\treturn '';\n}\n\n/**\n * Converts a little-endian hex-number to one, that 'hexdec' can convert\n */\nfunction littleEndian($hex) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$result = '';\n\n\tfor ($x=strlen($hex)-2;$x>= 0;$x=$x-2)\n\t\t$result .= substr($hex,$x,2);\n\n\treturn $result;\n}\n\nfunction binSIDtoText($binsid) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$hex_sid = bin2hex($binsid);\n\t$rev = hexdec(substr($hex_sid,0,2)); // Get revision-part of SID\n\t$subcount = hexdec(substr($hex_sid,2,2)); // Get count of sub-auth entries\n\t$auth = hexdec(substr($hex_sid,4,12)); // SECURITY_NT_AUTHORITY\n\n\t$result = \"$rev-$auth\";\n\n\tfor ($x=0;$x<$subcount;$x++) {\n\t\t$subauth[$x] = hexdec(littleEndian(substr($hex_sid,16+($x*8),8))); // get all SECURITY_NT_AUTHORITY\n\t\t$result .= sprintf('-%s',$subauth[$x]);\n\t}\n\n\treturn $result;\n}\n\n/**\n * Query LDAP and return a hash.\n *\n * @param string The base DN to use.\n * @param string LDAP Query filter.\n * @param string LDAP attribute to use as key.\n * @param array Attributes to use as values.\n * @param boolean Specify false to not sort results by DN\n *                or true to have the returned array sorted by DN (uses ksort)\n *                or an array of attribute names to sort by attribute values\n * @return array Array of values keyed by $key.\n */\nfunction return_ldap_hash($base,$filter,$key,$attrs,$sort=true) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$server = $_SESSION[APPCONFIG]->getServer(get_request('server_id','REQUEST'));\n\t$key = strtolower($key);\n\n\t$query = array();\n\t$query['base'] = $base;\n\t$query['filter'] = $filter;\n\t$query['attrs'] = $attrs;\n\t$search = $server->query($query,null);\n\n\t$results = array();\n\n\tforeach ($search as $dn => $values)\n\t\tif (isset($values[$key]))\n\t\t\tif (is_array($values[$key]))\n\t\t\t\tforeach ($values[$key] as $i => $k)\n\t\t\t\t\tforeach ($attrs as $attr) {\n\t\t\t\t\t\t$lattr = strtolower($attr);\n\t\t\t\t\t\tif (isset($values[$lattr])) {\n\t\t\t\t\t\t\t$v = '';\n\n\t\t\t\t\t\t\tif (is_array($values[$lattr]) && isset($values[$lattr][$i]))\n\t\t\t\t\t\t\t\t$v = $values[$lattr][$i];\n\n\t\t\t\t\t\t\tif (is_string($v) && (strlen($v) > 0))\n\t\t\t\t\t\t\t\t$results[$k][$attr] = $v;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\telse\n\t\t\t\tforeach ($attrs as $attr) {\n\t\t\t\t\t$lattr = strtolower($attr);\n\t\t\t\t\tif (isset($values[$lattr]))\n\t\t\t\t\t\t$results[$values[$key]][$attr] = $values[$lattr];\n\t\t\t\t}\n\n\tif ($sort)\n\t\tmasort($results,is_array($sort) ? implode(',',$sort) : 'dn');\n\n\treturn $results;\n}\n\n/**\n * This function returns a string automatically generated\n * based on the criteria defined in the array $criteria in config.php\n */\nfunction password_generate() {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\t$no_use_similiar = ! $_SESSION[APPCONFIG]->getValue('password','use_similar');\n\t$lowercase = $_SESSION[APPCONFIG]->getValue('password','lowercase');\n\t$uppercase = $_SESSION[APPCONFIG]->getValue('password','uppercase');\n\t$digits = $_SESSION[APPCONFIG]->getValue('password','numbers');\n\t$punctuation = $_SESSION[APPCONFIG]->getValue('password','punctuation');\n\t$length = $_SESSION[APPCONFIG]->getValue('password','length');\n\n\t$outarray = array();\n\n\tif ($no_use_similiar) {\n\t\t$raw_lower = 'a b c d e f g h k m n p q r s t u v w x y z';\n\t\t$raw_numbers = '2 3 4 5 6 7 8 9';\n\t\t$raw_punc = '# $ % ^ & * ( ) _ - + = . , [ ] { } :';\n\n\t} else {\n\t\t$raw_lower = 'a b c d e f g h i j k l m n o p q r s t u v w x y z';\n\t\t$raw_numbers = '1 2 3 4 5 6 7 8 9 0';\n\t\t$raw_punc = '# $ % ^ & * ( ) _ - + = . , [ ] { } : |';\n\t}\n\n\t$llower = explode(' ',$raw_lower);\n\tshuffle($llower);\n\t$lupper = explode(' ',strtoupper($raw_lower));\n\tshuffle($lupper);\n\t$numbers = explode(' ',$raw_numbers);\n\tshuffle($numbers);\n\t$punc = explode(' ',$raw_punc);\n\tshuffle($punc);\n\n\tif ($lowercase > 0)\n\t\t$outarray = array_merge($outarray,a_array_rand($llower,$lowercase));\n\n\tif ($uppercase > 0)\n\t\t$outarray = array_merge($outarray,a_array_rand($lupper,$uppercase));\n\n\tif ($digits > 0)\n\t\t$outarray = array_merge($outarray,a_array_rand($numbers,$digits));\n\n\tif ($punctuation > 0)\n\t\t$outarray = array_merge($outarray,a_array_rand($punc,$punctuation));\n\n\t$num_spec = $lowercase + $uppercase + $digits + $punctuation;\n\n\tif ($num_spec < $length) {\n\t\t$leftover = array();\n\t\tif ($lowercase > 0)\n\t\t\t$leftover = array_merge($leftover,$llower);\n\t\tif ($uppercase > 0)\n\t\t\t$leftover = array_merge($leftover,$lupper);\n\t\tif ($digits > 0)\n\t\t\t$leftover = array_merge($leftover,$numbers);\n\t\tif ($punctuation > 0)\n\t\t\t$leftover = array_merge($leftover,$punc);\n\n\t\tif (count($leftover) == 0)\n\t\t\t$leftover = array_merge($leftover,$llower,$lupper,$numbers,$punc);\n\n\t\tshuffle($leftover);\n\t\t$outarray = array_merge($outarray,a_array_rand($leftover,$length-$num_spec));\n\t}\n\n\tshuffle($outarray);\n\t$return = implode('',$outarray);\n\n\tif (DEBUG_ENABLED)\n\t\tdebug_log('Returning (%s)',1,0,__FILE__,__LINE__,__METHOD__,$return);\n\n\treturn $return;\n}\n\n/**\n * This function returns an array of $num_req values\n * randomly picked from the $input array\n *\n * @param array Array of values\n * @param integer Number of values in returned array\n * @return string The padded string\n */\nfunction a_array_rand($input,$num_req) {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\tif (count($input) == 0)\n\t\treturn array();\n\n\tif ($num_req < 1)\n\t\treturn array();\n\n\t$return = array();\n\tif ($num_req > count($input)) {\n\t\tfor($i = 0; $i < $num_req; $i++) {\n\t\t\t$idx = array_rand($input,1);\n\t\t\t$return[] = $input[$idx];\n\t\t}\n\n\t} else {\n\t\t$idxlist = array_rand($input,$num_req);\n\t\tif ($num_req == 1)\n\t\t\t$idxlist = array($idxlist);\n\n\t\tfor($i = 0; $i < count($idxlist); $i++)\n\t\t\t$return[] = $input[$idxlist[$i]];\n\t}\n\n\tif (DEBUG_ENABLED)\n\t\tdebug_log('Returning (%s)',1,0,__FILE__,__LINE__,__METHOD__,$return);\n\n\treturn $return;\n}\n\n/**\n * This is for Opera. By putting \"random junk\" in the query string, it thinks\n * that it does not have a cached version of the page, and will thus\n * fetch the page rather than display the cached version\n */\nfunction random_junk() {\n\t$time = gettimeofday();\n\treturn md5(strtotime('now').$time['usec']);\n}\n\n/**\n * Returns a HTML id that can be used in the URL after the #.\n *\n * @param string The DN to pretty-print.\n * @return string\n */\nfunction htmlid($sid,$dn) {\n\treturn sprintf('SID%s:%s',$sid,preg_replace('/[\\ =,]/','_',$dn));\n}\n\n/**\n * Is PLA configured for AJAX display\n */\nfunction isAjaxEnabled() {\n\tif (DEBUG_ENABLED && (($fargs=func_get_args())||$fargs='NOARGS'))\n\t\tdebug_log('Entered (%%)',1,0,__FILE__,__LINE__,__METHOD__,$fargs);\n\n\tif (isset($_SESSION[APPCONFIG]))\n\t\treturn ($_SESSION[APPCONFIG]->getValue('appearance','tree') == 'AJAXTree');\n\telse\n\t\treturn false;\n}\n?>\n"], "filenames": ["lib/functions.php"], "buggy_code_start_loc": [654], "buggy_code_end_loc": [693], "fixing_code_start_loc": [654], "fixing_code_end_loc": [703], "type": "CWE-79", "message": "An XSS issue has been discovered in phpLDAPadmin before 1.2.6.2 that allows users to store malicious values that may be executed by other users at a later time via get_request in lib/function.php.", "other": {"cve": {"id": "CVE-2020-35132", "sourceIdentifier": "cve@mitre.org", "published": "2020-12-11T05:15:12.950", "lastModified": "2020-12-22T21:16:13.373", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "An XSS issue has been discovered in phpLDAPadmin before 1.2.6.2 that allows users to store malicious values that may be executed by other users at a later time via get_request in lib/function.php."}, {"lang": "es", "value": "Se detect\u00f3 un problema de tipo XSS en phpLDAPadmin versiones anteriores a  1.2.6.2, que permite a usuarios almacenar valores maliciosos que pueden ser ejecutados por otros usuarios en un momento posterior por medio de la funci\u00f3n get_request en la biblioteca lib/function.php"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 5.4, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.3, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:S/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "SINGLE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 3.5}, "baseSeverity": "LOW", "exploitabilityScore": 6.8, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:phpldapadmin_project:phpldapadmin:*:*:*:*:*:*:*:*", "versionEndExcluding": "1.2.6.2", "matchCriteriaId": "CF8E90AC-508B-464A-8DBD-15B5653267FB"}]}]}, {"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:o:fedoraproject:fedora:32:*:*:*:*:*:*:*", "matchCriteriaId": "36D96259-24BD-44E2-96D9-78CE1D41F956"}, {"vulnerable": true, "criteria": "cpe:2.3:o:fedoraproject:fedora:33:*:*:*:*:*:*:*", "matchCriteriaId": "E460AA51-FCDA-46B9-AE97-E6676AA5E194"}]}]}], "references": [{"url": "https://bugs.launchpad.net/ubuntu/+source/phpldapadmin/+bug/1906474", "source": "cve@mitre.org", "tags": ["Issue Tracking", "Third Party Advisory"]}, {"url": "https://github.com/leenooks/phpLDAPadmin/commit/c87571f6b7be15d5cd8b26381b6eb31ad03d28e2", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/leenooks/phpLDAPadmin/compare/1.2.5...1.2.6.2", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/leenooks/phpLDAPadmin/issues/130", "source": "cve@mitre.org", "tags": ["Exploit", "Issue Tracking", "Third Party Advisory"]}, {"url": "https://lists.fedoraproject.org/archives/list/package-announce@lists.fedoraproject.org/message/6XA42XDSUPCOXL5ZCP5RGD3FD4JQQWNX/", "source": "cve@mitre.org", "tags": ["Third Party Advisory"]}, {"url": "https://lists.fedoraproject.org/archives/list/package-announce@lists.fedoraproject.org/message/W6PZH3EY2T66N2MGOA7DWCAIVYIJH4BC/", "source": "cve@mitre.org", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/leenooks/phpLDAPadmin/commit/c87571f6b7be15d5cd8b26381b6eb31ad03d28e2"}}