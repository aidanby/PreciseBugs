{"buggy_code": ["COMPONENT('exec', function(self, config) {\n\tself.readonly();\n\tself.blind();\n\tself.make = function() {\n\t\tself.event('click', config.selector || '.exec', function(e) {\n\t\t\tvar el = $(this);\n\n\t\t\tvar attr = el.attrd('exec');\n\t\t\tvar path = el.attrd('path');\n\t\t\tvar href = el.attrd('href');\n\n\t\t\tif (el.attrd('prevent') === 'true') {\n\t\t\t\te.preventDefault();\n\t\t\t\te.stopPropagation();\n\t\t\t}\n\n\t\t\tattr && EXEC(attr, el, e);\n\t\t\thref && NAV.redirect(href);\n\n\t\t\tif (path) {\n\t\t\t\tvar val = el.attrd('value');\n\t\t\t\tif (val == null) {\n\t\t\t\t\tvar a = new Function('return ' + el.attrd('value-a'))();\n\t\t\t\t\tvar b = new Function('return ' + el.attrd('value-b'))();\n\t\t\t\t\tvar v = GET(path);\n\t\t\t\t\tif (v === a)\n\t\t\t\t\t\tSET(path, b, true);\n\t\t\t\t\telse\n\t\t\t\t\t\tSET(path, a, true);\n\t\t\t\t} else\n\t\t\t\t\tSET(path, new Function('return ' + val)(), true);\n\t\t\t}\n\t\t});\n\t};\n});\n\nCOMPONENT('loading', function(self) {\n\tvar pointer;\n\n\tself.readonly();\n\tself.singleton();\n\tself.nocompile();\n\n\tself.make = function() {\n\t\tself.aclass('ui-loading');\n\t\tself.append('<div></div>');\n\t};\n\n\tself.show = function() {\n\t\tclearTimeout(pointer);\n\t\tself.rclass('hidden');\n\t\treturn self;\n\t};\n\n\tself.hide = function(timeout) {\n\t\tclearTimeout(pointer);\n\t\tpointer = setTimeout(function() {\n\t\t\tself.aclass('hidden');\n\t\t}, timeout || 1);\n\t\treturn self;\n\t};\n});\n\nCOMPONENT('grid', 'filter:true;external:false;fillcount:50;filterlabel:Filtering values ...;boolean:true|on|yes;pluralizepages:# pages,# page,# pages,# pages;pluralizeitems:# items,# item,# items,# items;pagination:false;rowheight:32', function(self, config) {\n\n\tvar tbody, thead, tbodyhead, container, pagination;\n\tvar options = { columns: {}, items: [], indexer: 0, filter: {} };\n\tvar isFilter = false;\n\tvar ppages, pitems, cache, eheight, wheight, scroll, filtercache, filled = false;\n\n\tself.template = Tangular.compile('<td data-index=\"{{ index }}\"{{ if $.cls }} class=\"{{ $.cls }}\"{{ fi }}><div class=\"wrap{{ if align }} {{ align }}{{ fi }}\"{{ if background }} style=\"background-color:{{ background }}\"{{ fi }}>{{ value | raw }}</div></td>');\n\tself.options = options;\n\tself.readonly();\n\tself.nocompile();\n\n\tself.make = function() {\n\n\t\tvar meta = self.find('script').html();\n\t\tself.aclass('ui-grid-container' + (config.autosize ? '' : ' hidden'));\n\t\tself.html('<div class=\"ui-grid\"><table class=\"ui-grid-header\"><thead></thead></table><div class=\"ui-grid-scroller\"><table class=\"ui-grid-data\"><thead></thead><tbody></tbody></table></div></div>' + (config.pagination ? '<div class=\"ui-grid-footer hidden\"><div class=\"ui-grid-meta\"></div><div class=\"ui-grid-pagination\"><button class=\"ui-grid-button\" name=\"first\"><i class=\"fa fa-angle-double-left\"></i></button><button class=\"ui-grid-button\" name=\"prev\"><i class=\"fa fa-angle-left\"></i></button><div class=\"page\"><input type=\"text\" maxlength=\"5\" class=\"ui-grid-input\" /></div><button class=\"ui-grid-button\" name=\"next\"><i class=\"fa fa-angle-right\"></i></button><button class=\"ui-grid-button\" name=\"last\"><i class=\"fa fa-angle-double-right\"></i></button></div><div class=\"ui-grid-pages\"></div></div></div>' : ''));\n\n\t\tvar body = self.find('.ui-grid-data');\n\t\ttbody = $(body.find('tbody')[0]);\n\t\ttbodyhead = $(body.find('thead')[0]);\n\t\tthead = $(self.find('.ui-grid-header').find('thead')[0]);\n\t\tcontainer = $(self.find('.ui-grid-scroller')[0]);\n\n\t\tif (config.pagination) {\n\t\t\tvar el = self.find('.ui-grid-footer');\n\t\t\tpagination = {};\n\t\t\tpagination.main = el;\n\t\t\tpagination.page = el.find('input');\n\t\t\tpagination.first = el.find('button[name=\"first\"]');\n\t\t\tpagination.last = el.find('button[name=\"last\"]');\n\t\t\tpagination.prev = el.find('button[name=\"prev\"]');\n\t\t\tpagination.next = el.find('button[name=\"next\"]');\n\t\t\tpagination.meta = el.find('.ui-grid-meta');\n\t\t\tpagination.pages = el.find('.ui-grid-pages');\n\t\t}\n\n\t\tmeta && self.meta(meta);\n\n\t\tself.event('click', '.ui-grid-columnsort', function() {\n\t\t\tvar obj = {};\n\t\t\tobj.columns = options.columns;\n\t\t\tobj.column = options.columns[+$(this).attrd('index')];\n\t\t\tself.sort(obj);\n\t\t});\n\n\t\tself.event('change', '.ui-grid-filter', function() {\n\t\t\tvar el = $(this).parent();\n\t\t\tif (this.value)\n\t\t\t\toptions.filter[this.name] = this.value;\n\t\t\telse\n\t\t\t\tdelete options.filter[this.name];\n\t\t\tel.tclass('ui-grid-selected', !!this.value);\n\t\t\tscroll = true;\n\t\t\tself.filter();\n\t\t});\n\n\t\tself.event('change', 'input', function() {\n\t\t\tvar el = this;\n\t\t\tif (el.type === 'checkbox') {\n\t\t\t\tel && !el.value && self.checked(el.checked);\n\t\t\t\tconfig.checked && EXEC(config.checked, el, self);\n\t\t\t}\n\t\t});\n\n\t\tself.event('click', '.ui-grid-button', function() {\n\t\t\tswitch (this.name) {\n\t\t\t\tcase 'first':\n\t\t\t\t\tscroll = true;\n\t\t\t\t\tcache.page = 1;\n\t\t\t\t\tself.operation('pagination');\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'last':\n\t\t\t\t\tscroll = true;\n\t\t\t\t\tcache.page = cache.pages;\n\t\t\t\t\tself.operation('pagination');\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'prev':\n\t\t\t\t\tscroll = true;\n\t\t\t\t\tcache.page -= 1;\n\t\t\t\t\tself.operation('pagination');\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'next':\n\t\t\t\t\tscroll = true;\n\t\t\t\t\tcache.page += 1;\n\t\t\t\t\tself.operation('pagination');\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t});\n\n\t\tself.event('change', '.ui-grid-input', function() {\n\t\t\tvar page = (+this.value) >> 0;\n\t\t\tif (isNaN(page) || page < 0 || page > cache.pages || page === cache.page)\n\t\t\t\treturn;\n\t\t\tscroll = true;\n\t\t\tcache.page = page;\n\t\t\tself.operation('pagination');\n\t\t});\n\n\t\ttbody.on('click', 'button', function() {\n\t\t\tvar btn = $(this);\n\t\t\tvar tr = btn.closest('tr');\n\t\t\tconfig.button && EXEC(config.button, btn, options.items[+tr.attrd('index')], self);\n\t\t});\n\n\t\tvar ALLOWED = { INPUT: 1, SELECT: 1 };\n\n\t\ttbody.on('click', '.ui-grid-row', function(e) {\n\t\t\t!ALLOWED[e.target.nodeName] && config.click && EXEC(config.click, options.items[+$(this).attrd('index')], self);\n\t\t});\n\n\t\tself.on('resize', self.resize);\n\t\tconfig.init && EXEC(config.init);\n\t\twheight = WH;\n\t};\n\n\tself.checked = function(value) {\n\t\tif (typeof(value) === 'boolean')\n\t\t\tself.find('input[type=\"checkbox\"]').prop('checked', value);\n\t\telse\n\t\t\treturn tbody.find('input:checked');\n\t};\n\n\tself.meta = function(html) {\n\n\t\tswitch (typeof(html)) {\n\t\t\tcase 'string':\n\t\t\t\toptions.columns = new Function('return ' + html.trim())();\n\t\t\t\tbreak;\n\t\t\tcase 'function':\n\t\t\t\toptions.columns = html(self);\n\t\t\t\tbreak;\n\t\t\tcase 'object':\n\t\t\t\toptions.columns = html;\n\t\t\t\tbreak;\n\t\t}\n\n\t\toptions.columns = options.columns.remove(function(column) {\n\t\t\treturn !!(column.remove && FN(column.remove)());\n\t\t});\n\n\t\toptions.customsearch = false;\n\n\t\tfor (var i = 0; i < options.columns.length; i++) {\n\t\t\tvar column = options.columns[i];\n\n\t\t\tif (typeof(column.header) === 'string')\n\t\t\t\tcolumn.header = column.header.indexOf('{{') === -1 ? new Function('return \\'' + column.header + '\\'') : Tangular.compile(column.header);\n\n\t\t\tif (typeof(column.template) === 'string')\n\t\t\t\tcolumn.template = column.template.indexOf('{{') === -1 ? new Function('a', 'b', 'return \\'' + column.template + '\\'') : Tangular.compile(column.template);\n\n\t\t\tif (column.search) {\n\t\t\t\toptions.customsearch = true;\n\t\t\t\tcolumn.search = column.search === true ? column.template : Tangular.compile(column.search);\n\t\t\t}\n\t\t}\n\n\t\tself.rebuild(true);\n\t};\n\n\tself.configure = function(key, value) {\n\t\tswitch (key) {\n\t\t\tcase 'pluralizepages':\n\t\t\t\tppages = value.split(',').trim();\n\t\t\t\tbreak;\n\t\t\tcase 'pluralizeitems':\n\t\t\t\tpitems = value.split(',').trim();\n\t\t\t\tbreak;\n\t\t}\n\t};\n\n\tself.cls = function(d) {\n\t\tvar a = [];\n\t\tfor (var i = 1; i < arguments.length; i++) {\n\t\t\tvar cls = arguments[i];\n\t\t\tcls && a.push(cls);\n\t\t}\n\t\treturn a.length ? ((d ? ' ' : '') + a.join(' ')) : '';\n\t};\n\n\tself.rebuild = function(init) {\n\n\t\tvar data = ['<tr class=\"ui-grid-empty\">'];\n\t\tvar header = ['<tr>'];\n\t\tvar filter = ['<tr>'];\n\n\t\tvar size = 0;\n\t\tvar columns = options.columns;\n\t\tvar scrollbar = SCROLLBARWIDTH();\n\n\t\tfor (var i = 0, length = columns.length; i < length; i++) {\n\t\t\tvar col = columns[i];\n\n\t\t\tif (typeof(col.size) !== 'string')\n\t\t\t\tsize += col.size || 1;\n\n\t\t\tcol.sorting = null;\n\n\t\t\tif (typeof(col.render) === 'string')\n\t\t\t\tcol.render = FN(col.render);\n\n\t\t\tif (typeof(col.header) === 'string')\n\t\t\t\tcol.header = FN(col.header);\n\n\t\t\tcol.cls = self.cls(0, col.classtd, col.class);\n\t\t}\n\n\t\tfor (var i = 0, length = columns.length; i < length; i++) {\n\t\t\tvar col = columns[i];\n\t\t\tvar width = typeof(col.size) === 'string' ? col.size : ((((col.size || 1) / size) * 100).floor(2) + '%');\n\n\t\t\tdata.push('<td style=\"width:{0}\" data-index=\"{1}\" class=\"{2}\"></td>'.format(width, i, self.cls(0, col.classtd, col.class)));\n\t\t\theader.push('<th class=\"ui-grid-columnname{3}{5}\" style=\"width:{0};text-align:center\" data-index=\"{1}\" title=\"{6}\" data-name=\"{4}\"><div class=\"wrap\"><i class=\"fa hidden ui-grid-fa\"></i>{2}</div></th>'.format(width, i, col.header ? col.header(col) : (col.text || col.name), self.cls(1, col.classth, col.class), col.name, col.sort === false ? '' : ' ui-grid-columnsort', col.title || col.text || col.name));\n\t\t\tif (col.filter === false)\n\t\t\t\tfilter.push('<th class=\"ui-grid-columnfilterempty ui-grid-columnfilter{1}\" style=\"width:{0}\">&nbsp;</th>'.format(width, self.cls(1, col.classfilter, col.class)));\n\t\t\telse\n\t\t\t\tfilter.push('<th class=\"ui-grid-columnfilter{4}\" style=\"width:{0}\"><input type=\"text\" placeholder=\"{3}\" name=\"{2}\" autocomplete=\"off\" class=\"ui-grid-filter\" /></th>'.format(width, i, col.name, col.filter || config.filterlabel, self.cls(1, col.classfilter, col.class)));\n\t\t}\n\n\t\tif (scrollbar) {\n\t\t\theader.push('<th class=\"ui-grid-columnname ui-grid-scrollbar\" style=\"width:{0}px\"></th>'.format(scrollbar));\n\t\t\tfilter.push('<th class=\"ui-grid-columnfilterempty ui-grid-scrollbar ui-grid-columnfilter{1}\" style=\"width:{0}px\">&nbsp;</th>'.format(scrollbar, self.cls(1, col.classtd, col.class)));\n\t\t}\n\n\t\ttbodyhead.html(data.join('') + '</tr>');\n\t\tthead.html(header.join('') + '</tr>' + (config.filter ? (filter.join('') + '</tr>') : ''));\n\t\t!init && self.refresh();\n\t\tisFilter = false;\n\t\toptions.filter = {};\n\t};\n\n\tself.fill = function() {\n\n\t\tif (config.autosize === false || filled)\n\t\t\treturn;\n\n\t\tfilled = true;\n\t\ttbody.find('.emptyfill').remove();\n\t\tvar builder = ['<tr class=\"emptyfill\">'];\n\n\t\tvar cols = options.columns;\n\t\tfor (var i = 0, length = cols.length; i < length; i++) {\n\t\t\tvar col = cols[i];\n\t\t\tif (!col.hidden) {\n\t\t\t\tvar cls = self.cls(0, col.classtd, col.class);\n\t\t\t\tbuilder.push('<td{0}>'.format(cls ? (' class=\"' + cls + '\"') : '') + (i ? '' : '<div class=\"wrap\">&nbsp;</div>') + '</td>');\n\t\t\t}\n\t\t}\n\n\t\tbuilder.push('</tr>');\n\t\tbuilder = builder.join('');\n\t\tvar buffer = [];\n\t\tfor (var i = 0; i < config.fillcount; i++)\n\t\t\tbuffer.push(builder);\n\t\ttbody.append(buffer.join(''));\n\t};\n\n\tself.resize = function(delay) {\n\n\t\tif (config.autosize === false) {\n\t\t\tself.hclass('hidden') && self.rclass('hidden');\n\t\t\treturn;\n\t\t}\n\n\t\tsetTimeout2(self.id + '.resize', function() {\n\n\t\t\tvar parent = self.parent().height();\n\t\t\tif (parent < wheight / 3)\n\t\t\t\treturn;\n\n\t\t\tvar value = options.items;\n\t\t\tvar height = parent - (config.padding || 0) - (config.pagination ? 105 : 74);\n\n\t\t\tif (height === eheight)\n\t\t\t\treturn;\n\n\t\t\tcontainer.height(height);\n\t\t\teheight = height;\n\n\t\t\tvar cls = 'ui-grid-noscroll';\n\t\t\tvar count = (height / config.rowheight) >> 0;\n\t\t\tif (count > value.length) {\n\t\t\t\tself.fill(config.fillcount);\n\t\t\t\tself.aclass(cls);\n\t\t\t} else\n\t\t\t\tself.rclass(cls);\n\n\t\t\tpagination && pagination.main.rclass('hidden');\n\t\t\teheight && self.rclass('hidden');\n\t\t}, typeof(delay) === 'number' ? delay : 50);\n\t};\n\n\tself.limit = function() {\n\t\treturn Math.ceil(container.height() / config.rowheight);\n\t};\n\n\tself.filter = function() {\n\t\tisFilter = Object.keys(options.filter).length > 0;\n\t\t!config.external && self.refresh();\n\t\tself.operation('filter');\n\t};\n\n\tself.operation = function(type) {\n\t\tif (type === 'filter')\n\t\t\tcache.page = 1;\n\t\tconfig.exec && EXEC(config.exec, type, isFilter ? options.filter : null, options.lastsort ? options.lastsort : null, cache.page, self);\n\t};\n\n\tself.sort = function(data) {\n\n\t\toptions.lastsortelement && options.lastsortelement.rclass('fa-caret-down fa-caret-up').aclass('hidden');\n\n\t\tif (data.column.sorting === 'desc') {\n\t\t\toptions.lastsortelement.find('.ui-grid-fa').rclass('fa-caret-down fa-caret-up').aclass('hidden');\n\t\t\toptions.lastsortelement = null;\n\t\t\toptions.lastsort = null;\n\t\t\tdata.column.sorting = null;\n\n\t\t\tif (config.external)\n\t\t\t\tself.operation('sort');\n\t\t\telse\n\t\t\t\tself.refresh();\n\n\t\t} else if (data.column) {\n\t\t\tdata.column.sorting = data.column.sorting === 'asc' ? 'desc' : 'asc';\n\t\t\toptions.lastsortelement = thead.find('th[data-name=\"{0}\"]'.format(data.column.name)).find('.ui-grid-fa').rclass('hidden').tclass('fa-caret-down', data.column.sorting === 'asc').tclass('fa-caret-up', data.column.sorting === 'desc');\n\t\t\toptions.lastsort = data.column;\n\n\t\t\tvar name = data.column.name;\n\t\t\tvar sort = data.column.sorting;\n\n\t\t\t!config.external && options.lastsort && options.items.quicksort(name, sort !== 'asc');\n\t\t\tself.operation('sort');\n\t\t\tself.redraw();\n\t\t}\n\t};\n\n\tself.can = function(row) {\n\n\t\tvar keys = Object.keys(options.filter);\n\n\t\tfor (var i = 0; i < keys.length; i++) {\n\n\t\t\tvar column = keys[i];\n\t\t\tvar filter = options.filter[column];\n\t\t\tvar val2 = filtercache[column];\n\t\t\tvar val = row['$' + column] || row[column];\n\n\t\t\tvar type = typeof(val);\n\n\t\t\tif (val instanceof Array) {\n\t\t\t\tval = val.join(' ');\n\t\t\t\ttype = 'string';\n\t\t\t}\n\n\t\t\tif (type === 'number') {\n\n\t\t\t\tif (val2 == null)\n\t\t\t\t\tval2 = filtercache[column] = self.parseNumber(filter);\n\n\t\t\t\tif (val2.length === 1 && val !== val2[0])\n\t\t\t\t\treturn false;\n\n\t\t\t\tif (val < val2[0] || val > val2[1])\n\t\t\t\t\treturn false;\n\n\t\t\t} else if (type === 'string') {\n\n\t\t\t\tif (val2 == null) {\n\t\t\t\t\tval2 = filtercache[column] = filter.split(/\\/\\|\\\\|,/).trim();\n\t\t\t\t\tfor (var j = 0; j < val2.length; j++)\n\t\t\t\t\t\tval2[j] = val2[j].toSearch();\n\t\t\t\t}\n\n\t\t\t\tvar is = false;\n\t\t\t\tvar s = val.toSearch();\n\n\t\t\t\tfor (var j = 0; j < val2.length; j++) {\n\t\t\t\t\tif (s.indexOf(val2[j]) !== -1) {\n\t\t\t\t\t\tis = true;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (!is)\n\t\t\t\t\treturn false;\n\n\t\t\t} else if (type === 'boolean') {\n\t\t\t\tif (val2 == null)\n\t\t\t\t\tval2 = filtercache[column] = config.boolean.indexOf(filter.replace(/\\s/g, '')) !== -1;\n\t\t\t\tif (val2 !== val)\n\t\t\t\t\treturn false;\n\t\t\t} else if (val instanceof Date) {\n\n\t\t\t\tval.setHours(0);\n\t\t\t\tval.setMinutes(0);\n\n\t\t\t\tif (val2 == null) {\n\n\t\t\t\t\tval2 = filter.trim().replace(/\\s-\\s/, '/').split(/\\/|\\||\\\\|,/).trim();\n\t\t\t\t\tvar arr = filtercache[column] = [];\n\n\t\t\t\t\tfor (var j = 0; j < val2.length; j++) {\n\t\t\t\t\t\tvar dt = val2[j].trim();\n\t\t\t\t\t\tvar a = self.parseDate(dt);\n\t\t\t\t\t\tif (a instanceof Array) {\n\t\t\t\t\t\t\tif (val2.length === 2) {\n\t\t\t\t\t\t\t\tarr.push(j ? a[1] : a[0]);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tarr.push(a[0]);\n\t\t\t\t\t\t\t\tif (j === val2.length - 1) {\n\t\t\t\t\t\t\t\t\tarr.push(a[1]);\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else\n\t\t\t\t\t\t\tarr.push(a);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (val2.length === 2 && arr.length === 2) {\n\t\t\t\t\t\tarr[1].setHours(23);\n\t\t\t\t\t\tarr[1].setMinutes(59);\n\t\t\t\t\t\tarr[1].setSeconds(59);\n\t\t\t\t\t}\n\n\t\t\t\t\tval2 = arr;\n\t\t\t\t}\n\n\t\t\t\tif (val2.length === 1 && val.format('yyyyMMdd') !== val2[0].format('yyyyMMdd'))\n\t\t\t\t\treturn false;\n\n\t\t\t\tif (val < val2[0] || val > val2[1])\n\t\t\t\t\treturn false;\n\t\t\t} else\n\t\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t};\n\n\tself.parseDate = function(val) {\n\t\tvar index = val.indexOf('.');\n\t\tif (index === -1) {\n\t\t\tif ((/[a-z]+/).test(val)) {\n\t\t\t\tvar dt = NOW.add(val);\n\t\t\t\treturn dt > NOW ? [NOW, dt] : [dt, NOW];\n\t\t\t}\n\t\t\tif (val.length === 4)\n\t\t\t\treturn [new Date(+val, 0, 1), new Date(+val + 1, 0\t, 1)];\n\t\t} else if (val.indexOf('.', index + 1) === -1) {\n\t\t\tvar a = val.split('.');\n\t\t\treturn new Date(NOW.getFullYear(), +a[1] - 1, +a[0]);\n\t\t}\n\t\tindex = val.indexOf('-');\n\t\tif (index !== -1 && val.indexOf('-', index + 1) === -1) {\n\t\t\tvar a = val.split('-');\n\t\t\treturn new Date(NOW.getFullYear(), +a[0] - 1, +a[1]);\n\t\t}\n\t\treturn val.parseDate();\n\t};\n\n\tself.parseNumber = function(val) {\n\t\tvar arr = [];\n\t\tvar num = val.replace(/\\s-\\s/, '/').replace(/\\s/g, '').replace(/,/g, '.').split(/\\/|\\|\\s-\\s|\\\\/).trim();\n\n\t\tfor (var i = 0, length = num.length; i < length; i++) {\n\t\t\tvar n = num[i];\n\t\t\tarr.push(+n);\n\t\t}\n\n\t\treturn arr;\n\t};\n\n\tself.reset = function() {\n\t\toptions.filter = {};\n\t\tisFilter = false;\n\t\tthead.find('input').val('');\n\t\tthead.find('.ui-grid-selected').rclass('ui-grid-selected');\n\t\toptions.lastsortelement && options.lastsortelement.rclass('fa-caret-down fa-caret-up');\n\t\toptions.lastsortelement = null;\n\t\tif (options.lastsort)\n\t\t\toptions.lastsort.sorting = null;\n\t\toptions.lastsort = null;\n\t};\n\n\tself.redraw = function() {\n\n\t\tvar items = options.items;\n\t\tvar columns = options.columns;\n\t\tvar builder = [];\n\t\tvar m = {};\n\n\t\tfor (var i = 0, length = items.length; i < length; i++) {\n\t\t\tbuilder.push('<tr class=\"ui-grid-row\" data-index=\"' + i + '\">');\n\t\t\tfor (var j = 0, jl = columns.length; j < jl; j++) {\n\t\t\t\tvar column = columns[j];\n\t\t\t\tvar val = items[i][column.name];\n\t\t\t\tm.value = column.template ? column.template(items[i], column) : column.render ? column.render(val, column, items[i]) : val == null ? '' : (column.format ? val.format(column.format) : val);\n\t\t\t\tm.index = j;\n\t\t\t\tm.align = column.align;\n\t\t\t\tm.background = column.background;\n\t\t\t\tbuilder.push(self.template(m, column));\n\t\t\t}\n\t\t\tbuilder.push('</tr>');\n\t\t}\n\n\t\ttbody.find('.ui-grid-row').remove();\n\t\ttbody.prepend(builder.join(''));\n\t\tcontainer.rclass('noscroll');\n\t\tscroll && container.prop('scrollTop', 0);\n\t\tscroll = false;\n\t\teheight = 0;\n\t\tself.resize(0);\n\t};\n\n\tself.setter = function(value) {\n\n\t\t// value.items\n\t\t// value.limit\n\t\t// value.page\n\t\t// value.pages\n\t\t// value.count\n\n\t\tif (!value) {\n\t\t\ttbody.find('.ui-grid-row').remove();\n\t\t\tself.resize();\n\t\t\treturn;\n\t\t}\n\n\t\tcache = value;\n\n\t\tif (config.pagination) {\n\t\t\tpagination.prev.prop('disabled', value.page === 1);\n\t\t\tpagination.first.prop('disabled', value.page === 1);\n\t\t\tpagination.next.prop('disabled', value.page >= value.pages);\n\t\t\tpagination.last.prop('disabled', value.page === value.pages);\n\t\t\tpagination.page.val(value.page);\n\t\t\tpagination.meta.html(value.count.pluralize.apply(value.count, pitems));\n\t\t\tpagination.pages.html(value.pages.pluralize.apply(value.pages, ppages));\n\t\t}\n\n\t\tif (options.customsearch) {\n\t\t\tfor (var i = 0, length = value.items.length; i < length; i++) {\n\t\t\t\tvar item = value.items[i];\n\t\t\t\tfor (var j = 0; j < options.columns.length; j++) {\n\t\t\t\t\tvar col = options.columns[j];\n\t\t\t\t\tif (col.search)\n\t\t\t\t\t\titem['$' + col.name] = col.search(item);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (config.external) {\n\t\t\toptions.items = value.items;\n\t\t} else {\n\t\t\toptions.items = [];\n\t\t\tfiltercache = {};\n\t\t\tfor (var i = 0, length = value.items.length; i < length; i++) {\n\t\t\t\tvar item = value.items[i];\n\t\t\t\tif (isFilter && !self.can(item))\n\t\t\t\t\tcontinue;\n\t\t\t\toptions.items.push(item);\n\t\t\t}\n\t\t\toptions.lastsort && options.items.quicksort(options.lastsort.name, options.lastsort.sorting === 'asc');\n\t\t}\n\n\t\tself.redraw();\n\t\tconfig.checked && EXEC(config.checked, null, self);\n\t};\n});\n\nCOMPONENT('contextmenu', function(self) {\n\n\tvar is = false;\n\tvar timeout, container, arrow;\n\n\tself.template = Tangular.compile('<div data-index=\"{{ index }}\"{{ if selected }} class=\"selected\"{{ fi }}><i class=\"fa {{ icon }}\"></i><span>{{ name | raw }}</span></div>');\n\tself.singleton();\n\tself.readonly();\n\tself.callback = null;\n\tself.items = EMPTYARRAY;\n\n\tself.make = function() {\n\n\t\tself.aclass('ui-contextmenu hidden');\n\t\tself.append('<span class=\"ui-contextmenu-arrow\"></span><div class=\"ui-contextmenu-items\"></div>');\n\t\tcontainer = self.find('.ui-contextmenu-items');\n\t\tarrow = self.find('.ui-contextmenu-arrow');\n\n\t\tself.event('touchstart mousedown', 'div[data-index]', function(e) {\n\t\t\tself.callback && self.callback(self.items[+$(this).attrd('index')], $(self.target));\n\t\t\tself.hide();\n\t\t\te.preventDefault();\n\t\t\te.stopPropagation();\n\t\t});\n\n\t\t$(window).on('scroll', function() {\n\t\t\tis && self.hide(1);\n\t\t});\n\n\t\tself.on('scroll', function() {\n\t\t\tis && self.hide(1);\n\t\t});\n\n\t\t$(document).on('touchstart mousedown', function(e) {\n\t\t\tif (is && (self.target !== e.target && !self.target.contains(e.target)))\n\t\t\t\tself.hide(1);\n\t\t});\n\t};\n\n\tself.show = function(orientation, target, items, callback, offsetX, offsetY) {\n\n\t\tif (is) {\n\t\t\tclearTimeout(timeout);\n\t\t\tvar obj = target instanceof jQuery ? target[0] : target;\n\t\t\tif (self.target === obj) {\n\t\t\t\tself.hide(0);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\ttarget = $(target);\n\t\tvar type = typeof(items);\n\t\tvar item;\n\n\t\tif (type === 'string')\n\t\t\titems = self.get(items);\n\t\telse if (type === 'function') {\n\t\t\tcallback = items;\n\t\t\titems = (target.attrd('options') || '').split(';');\n\t\t\tfor (var i = 0, length = items.length; i < length; i++) {\n\t\t\t\titem = items[i];\n\t\t\t\tif (!item)\n\t\t\t\t\tcontinue;\n\t\t\t\tvar val = item.split('|');\n\t\t\t\titems[i] = { name: val[0], icon: val[1], value: val[2] || val[0] };\n\t\t\t}\n\t\t}\n\n\t\tif (!items) {\n\t\t\tself.hide(0);\n\t\t\treturn;\n\t\t}\n\n\t\tself.callback = callback;\n\n\t\tvar builder = [];\n\t\tfor (var i = 0, length = items.length; i < length; i++) {\n\t\t\titem = items[i];\n\t\t\titem.index = i;\n\t\t\tif (item.icon) {\n\t\t\t\tif (item.icon.substring(0, 3) !== 'fa-')\n\t\t\t\t\titem.icon = 'fa-' + item.icon;\n\t\t\t} else\n\t\t\t\titem.icon = 'fa-caret-right';\n\n\t\t\tbuilder.push(self.template(item));\n\t\t}\n\n\t\tself.items = items;\n\t\tself.target = target[0];\n\t\tvar offset = target.offset();\n\n\t\tcontainer.html(builder);\n\n\t\tswitch (orientation) {\n\t\t\tcase 'left':\n\t\t\t\tarrow.css({ left: '10px' });\n\t\t\t\tbreak;\n\t\t\tcase 'right':\n\t\t\t\tarrow.css({ left: '165px' });\n\t\t\t\tbreak;\n\t\t\tcase 'center':\n\t\t\t\tarrow.css({ left: '90px' });\n\t\t\t\tbreak;\n\t\t}\n\n\n\t\tvar options = { left: orientation === 'center' ? Math.ceil((offset.left - self.element.width() / 2) + (target.innerWidth() / 2)) : orientation === 'left' ? (offset.left - 8) + (offsetX || 0) : (offset.left - self.element.width()) + target.innerWidth() + (offsetX || 0) + 8, top: offset.top + target.innerHeight() + 10 + (offsetY || 0) };\n\t\tself.css(options);\n\n\t\tif (is)\n\t\t\treturn;\n\n\t\tself.rclass('hidden');\n\t\tsetTimeout(function() {\n\t\t\tself.aclass('ui-contextmenu-visible');\n\t\t\tself.emit('contextmenu', true, self, self.target);\n\t\t}, 100);\n\n\t\tis = true;\n\t};\n\n\tself.hide = function(sleep) {\n\t\tif (!is)\n\t\t\treturn;\n\t\tclearTimeout(timeout);\n\t\ttimeout = setTimeout(function() {\n\t\t\tself.aclass('hidden').rclass('ui-contextmenu-visible');\n\t\t\tself.emit('contextmenu', false, self, self.target);\n\t\t\tself.callback = null;\n\t\t\tself.target = null;\n\t\t\tis = false;\n\t\t}, sleep ? sleep : 100);\n\t};\n});\n\nCOMPONENT('textbox', function(self, config) {\n\n\tvar input, content = null;\n\n\tself.nocompile();\n\n\tself.validate = function(value) {\n\n\t\tif (!config.required || config.disabled)\n\t\t\treturn true;\n\n\t\tif (self.type === 'date')\n\t\t\treturn value instanceof Date && !isNaN(value.getTime());\n\n\t\tif (value == null)\n\t\t\tvalue = '';\n\t\telse\n\t\t\tvalue = value.toString();\n\n\t\tEMIT('reflow', self.name);\n\n\t\tif (config.minlength && value.length < config.minlength)\n\t\t\treturn false;\n\n\t\tswitch (self.type) {\n\t\t\tcase 'email':\n\t\t\t\treturn value.isEmail();\n\t\t\tcase 'phone':\n\t\t\t\treturn value.isPhone();\n\t\t\tcase 'url':\n\t\t\t\treturn value.isURL();\n\t\t\tcase 'currency':\n\t\t\tcase 'number':\n\t\t\t\treturn value > 0;\n\t\t}\n\n\t\treturn config.validation ? !!self.evaluate(value, config.validation, true) : value.length > 0;\n\t};\n\n\tself.make = function() {\n\n\t\tcontent = self.html();\n\n\t\tself.type = config.type;\n\t\tself.format = config.format;\n\n\t\tself.event('click', '.fa-calendar', function(e) {\n\t\t\tif (!config.disabled && !config.readonly && config.type === 'date') {\n\t\t\t\te.preventDefault();\n\t\t\t\tSETTER('calendar', 'toggle', self.element, self.get(), function(date) {\n\t\t\t\t\tself.change(true);\n\t\t\t\t\tself.set(date);\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\n\t\tself.event('click', '.fa-caret-up,.fa-caret-down', function() {\n\t\t\tif (!config.disabled && !config.readonly && config.increment) {\n\t\t\t\tvar el = $(this);\n\t\t\t\tvar inc = el.hclass('fa-caret-up') ? 1 : -1;\n\t\t\t\tself.change(true);\n\t\t\t\tself.inc(inc);\n\t\t\t}\n\t\t});\n\n\t\tself.event('click', '.ui-textbox-control-icon', function() {\n\t\t\tif (config.disabled || config.readonly)\n\t\t\t\treturn;\n\t\t\tif (self.type === 'search') {\n\t\t\t\tself.$stateremoved = false;\n\t\t\t\t$(this).rclass('fa-times').aclass('fa-search');\n\t\t\t\tself.set('');\n\t\t\t} else if (config.icon2click)\n\t\t\t\tEXEC(config.icon2click, self);\n\t\t});\n\n\t\tself.event('focus', 'input', function() {\n\t\t\tif (!config.disabled && !config.readonly && config.autocomplete)\n\t\t\t\tEXEC(config.autocomplete, self);\n\t\t});\n\n\t\tself.redraw();\n\t};\n\n\tself.redraw = function() {\n\n\t\tvar attrs = [];\n\t\tvar builder = [];\n\t\tvar tmp = 'text';\n\n\t\tswitch (config.type) {\n\t\t\tcase 'password':\n\t\t\t\ttmp = config.type;\n\t\t\t\tbreak;\n\t\t\tcase 'number':\n\t\t\tcase 'phone':\n\t\t\t\tisMOBILE && (tmp = 'tel');\n\t\t\t\tbreak;\n\t\t}\n\n\t\tself.tclass('ui-disabled', config.disabled === true);\n\t\tself.tclass('ui-textbox-required', config.required === true);\n\t\tself.type = config.type;\n\t\tattrs.attr('type', tmp);\n\t\tconfig.placeholder && attrs.attr('placeholder', config.placeholder);\n\t\tconfig.maxlength && attrs.attr('maxlength', config.maxlength);\n\t\tconfig.keypress != null && attrs.attr('data-jc-keypress', config.keypress);\n\t\tconfig.delay && attrs.attr('data-jc-keypress-delay', config.delay);\n\t\tconfig.disabled && attrs.attr('disabled');\n\t\tconfig.readonly && attrs.attr('readonly');\n\t\tconfig.error && attrs.attr('error');\n\t\tattrs.attr('data-jc-bind', '');\n\n\t\tconfig.autofill && attrs.attr('name', self.path.replace(/\\./g, '_'));\n\t\tconfig.align && attrs.attr('class', 'ui-' + config.align);\n\t\t!isMOBILE && config.autofocus && attrs.attr('autofocus');\n\n\t\tbuilder.push('<div class=\"ui-textbox-input\"><input {0} /></div>'.format(attrs.join(' ')));\n\n\t\tvar icon = config.icon;\n\t\tvar icon2 = config.icon2;\n\n\t\tif (!icon2 && self.type === 'date')\n\t\t\ticon2 = 'calendar';\n\t\telse if (self.type === 'search') {\n\t\t\ticon2 = 'search';\n\t\t\tself.setter2 = function(value) {\n\t\t\t\tif (self.$stateremoved && !value)\n\t\t\t\t\treturn;\n\t\t\t\tself.$stateremoved = !value;\n\t\t\t\tself.find('.ui-textbox-control-icon').tclass('fa-times', !!value).tclass('fa-search', !value);\n\t\t\t};\n\t\t}\n\n\t\ticon2 && builder.push('<div class=\"ui-textbox-control\"><span class=\"fa fa-{0} ui-textbox-control-icon\"></span></div>'.format(icon2));\n\t\tconfig.increment && !icon2 && builder.push('<div class=\"ui-textbox-control\"><span class=\"fa fa-caret-up\"></span><span class=\"fa fa-caret-down\"></span></div>');\n\n\t\tif (config.label)\n\t\t\tcontent = config.label;\n\n\t\tif (content.length) {\n\t\t\tvar html = builder.join('');\n\t\t\tbuilder = [];\n\t\t\tbuilder.push('<div class=\"ui-textbox-label\">');\n\t\t\ticon && builder.push('<i class=\"fa fa-{0}\"></i> '.format(icon));\n\t\t\tbuilder.push('<span>' + content + (content.substring(content.length - 1) === '?' ? '' : ':') + '</span>');\n\t\t\tbuilder.push('</div><div class=\"ui-textbox\">{0}</div>'.format(html));\n\t\t\tconfig.error && builder.push('<div class=\"ui-textbox-helper\"><i class=\"fa fa-warning\" aria-hidden=\"true\"></i> {0}</div>'.format(config.error));\n\t\t\tself.html(builder.join(''));\n\t\t\tself.aclass('ui-textbox-container');\n\t\t\tinput = self.find('input');\n\t\t} else {\n\t\t\tconfig.error && builder.push('<div class=\"ui-textbox-helper\"><i class=\"fa fa-warning\" aria-hidden=\"true\"></i> {0}</div>'.format(config.error));\n\t\t\tself.aclass('ui-textbox ui-textbox-container');\n\t\t\tself.html(builder.join(''));\n\t\t\tinput = self.find('input');\n\t\t}\n\t};\n\n\tself.configure = function(key, value, init) {\n\n\t\tif (init)\n\t\t\treturn;\n\n\t\tvar redraw = false;\n\n\t\tswitch (key) {\n\t\t\tcase 'readonly':\n\t\t\t\tself.find('input').prop('readonly', value);\n\t\t\t\tbreak;\n\t\t\tcase 'disabled':\n\t\t\t\tself.tclass('ui-disabled', value);\n\t\t\t\tself.find('input').prop('disabled', value);\n\t\t\t\tself.reset();\n\t\t\t\tbreak;\n\t\t\tcase 'format':\n\t\t\t\tself.format = value;\n\t\t\t\tself.refresh();\n\t\t\t\tbreak;\n\t\t\tcase 'required':\n\t\t\t\tself.noValid(!value);\n\t\t\t\t!value && self.state(1, 1);\n\t\t\t\tself.tclass('ui-textbox-required', value === true);\n\t\t\t\tbreak;\n\t\t\tcase 'placeholder':\n\t\t\t\tinput.prop('placeholder', value || '');\n\t\t\t\tbreak;\n\t\t\tcase 'maxlength':\n\t\t\t\tinput.prop('maxlength', value || 1000);\n\t\t\t\tbreak;\n\t\t\tcase 'autofill':\n\t\t\t\tinput.prop('name', value ? self.path.replace(/\\./g, '_') : '');\n\t\t\t\tbreak;\n\t\t\tcase 'label':\n\t\t\t\tif (content && value)\n\t\t\t\t\tself.find('.ui-textbox-label span').html(value);\n\t\t\t\telse\n\t\t\t\t\tredraw = true;\n\t\t\t\tcontent = value;\n\t\t\t\tbreak;\n\t\t\tcase 'type':\n\t\t\t\tself.type = value;\n\t\t\t\tif (value === 'password')\n\t\t\t\t\tvalue = 'password';\n\t\t\t\telse\n\t\t\t\t\tself.type = 'text';\n\t\t\t\tself.find('input').prop('type', self.type);\n\t\t\t\tbreak;\n\t\t\tcase 'align':\n\t\t\t\tinput.rclass(input.attr('class')).aclass('ui-' + value || 'left');\n\t\t\t\tbreak;\n\t\t\tcase 'autofocus':\n\t\t\t\tinput.focus();\n\t\t\t\tbreak;\n\t\t\tcase 'icon':\n\t\t\t\tvar tmp = self.find('.ui-textbox-label .fa');\n\t\t\t\tif (tmp.length)\n\t\t\t\t\ttmp.rclass2('fa-').aclass('fa-' + value);\n\t\t\t\telse\n\t\t\t\t\tredraw = true;\n\t\t\t\tbreak;\n\t\t\tcase 'icon2':\n\t\t\tcase 'increment':\n\t\t\t\tredraw = true;\n\t\t\t\tbreak;\n\t\t}\n\n\t\tredraw && setTimeout2('redraw.' + self.id, function() {\n\t\t\tself.redraw();\n\t\t\tself.refresh();\n\t\t}, 100);\n\t};\n\n\tself.formatter(function(path, value) {\n\t\treturn config.type === 'date' ? (value ? value.format(config.format || 'yyyy-MM-dd') : value) : value;\n\t});\n\n\tself.parser(function(path, value) {\n\t\treturn value ? config.spaces === false ? value.replace(/\\s/g, '') : value : value;\n\t});\n\n\tself.state = function(type) {\n\t\tif (!type)\n\t\t\treturn;\n\t\tvar invalid = config.required ? self.isInvalid() : false;\n\t\tif (invalid === self.$oldstate)\n\t\t\treturn;\n\t\tself.$oldstate = invalid;\n\t\tself.tclass('ui-textbox-invalid', invalid);\n\t\tconfig.error && self.find('.ui-textbox-helper').tclass('ui-textbox-helper-show', invalid);\n\t};\n});\n\nCOMPONENT('form', function(self, config) {\n\n\tvar W = window;\n\tvar csspos = {};\n\n\tif (!W.$$form) {\n\n\t\tW.$$form_level = W.$$form_level || 1;\n\t\tW.$$form = true;\n\n\t\t$(document).on('click', '.ui-form-button-close', function() {\n\t\t\tSET($(this).attrd('path'), '');\n\t\t});\n\n\t\t$(W).on('resize', function() {\n\t\t\tSETTER('form', 'resize');\n\t\t});\n\n\t\t$(document).on('click', '.ui-form-container', function(e) {\n\t\t\tvar el = $(e.target);\n\t\t\tif (!(el.hclass('ui-form-container-padding') || el.hclass('ui-form-container')))\n\t\t\t\treturn;\n\t\t\tvar form = $(this).find('.ui-form');\n\t\t\tvar cls = 'ui-form-animate-click';\n\t\t\tform.aclass(cls);\n\t\t\tsetTimeout(function() {\n\t\t\t\tform.rclass(cls);\n\t\t\t}, 300);\n\t\t});\n\t}\n\n\tself.readonly();\n\tself.submit = function() {\n\t\tif (config.submit)\n\t\t\tEXEC(config.submit, self);\n\t\telse\n\t\t\tself.hide();\n\t};\n\n\tself.cancel = function() {\n\t\tconfig.cancel && EXEC(config.cancel, self);\n\t\tself.hide();\n\t};\n\n\tself.hide = function() {\n\t\tself.set('');\n\t};\n\n\tself.icon = function(value) {\n\t\tvar el = this.rclass2('fa');\n\t\tvalue.icon && el.aclass('fa fa-' + value.icon);\n\t};\n\n\tself.resize = function() {\n\t\tif (!config.center || self.hclass('hidden'))\n\t\t\treturn;\n\t\tvar ui = self.find('.ui-form');\n\t\tvar fh = ui.innerHeight();\n\t\tvar wh = $(W).height();\n\t\tvar r = (wh / 2) - (fh / 2);\n\t\tcsspos.marginTop = (r > 30 ? (r - 15) : 20) + 'px';\n\t\tui.css(csspos);\n\t};\n\n\tself.make = function() {\n\n\t\t$(document.body).append('<div id=\"{0}\" class=\"hidden ui-form-container\"><div class=\"ui-form-container-padding\"><div class=\"ui-form\" style=\"max-width:{1}px\"><div data-bind=\"@config__html span:value.title__change .ui-form-icon:@icon\" class=\"ui-form-title\"><button class=\"ui-form-button-close{3}\" data-path=\"{2}\"><i class=\"fa fa-times\"></i></button><i class=\"ui-form-icon\"></i><span></span></div></div></div>'.format(self.ID, config.width || 800, self.path, config.closebutton == false ? ' hidden' : ''));\n\t\tvar el = $('#' + self.ID);\n\t\tel.find('.ui-form')[0].appendChild(self.dom);\n\t\tself.rclass('hidden');\n\t\tself.replace(el);\n\n\t\tself.event('scroll', function() {\n\t\t\tEMIT('scroll', self.name);\n\t\t\tEMIT('reflow', self.name);\n\t\t});\n\n\t\tself.find('button').on('click', function() {\n\t\t\tswitch (this.name) {\n\t\t\t\tcase 'submit':\n\t\t\t\t\tself.submit(self.hide);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'cancel':\n\t\t\t\t\t!this.disabled && self[this.name](self.hide);\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t});\n\n\t\tconfig.enter && self.event('keydown', 'input', function(e) {\n\t\t\te.which === 13 && !self.find('button[name=\"submit\"]')[0].disabled && setTimeout(function() {\n\t\t\t\tself.submit(self);\n\t\t\t}, 800);\n\t\t});\n\t};\n\n\tself.configure = function(key, value, init, prev) {\n\t\tif (init)\n\t\t\treturn;\n\t\tswitch (key) {\n\t\t\tcase 'width':\n\t\t\t\tvalue !== prev && self.find('.ui-form').css('max-width', value + 'px');\n\t\t\t\tbreak;\n\t\t\tcase 'closebutton':\n\t\t\t\tself.find('.ui-form-button-close').tclass(value !== true);\n\t\t\t\tbreak;\n\t\t}\n\t};\n\n\tself.setter = function(value) {\n\n\t\tsetTimeout2('ui-form-noscroll', function() {\n\t\t\t$('html').tclass('ui-form-noscroll', !!$('.ui-form-container').not('.hidden').length);\n\t\t}, 50);\n\n\t\tvar isHidden = value !== config.if;\n\n\t\tif (self.hclass('hidden') === isHidden)\n\t\t\treturn;\n\n\t\tsetTimeout2('formreflow', function() {\n\t\t\tEMIT('reflow', self.name);\n\t\t}, 10);\n\n\t\tif (isHidden) {\n\t\t\tself.aclass('hidden');\n\t\t\tself.release(true);\n\t\t\tself.find('.ui-form').rclass('ui-form-animate');\n\t\t\tW.$$form_level--;\n\t\t\treturn;\n\t\t}\n\n\t\tif (W.$$form_level < 1)\n\t\t\tW.$$form_level = 1;\n\n\t\tW.$$form_level++;\n\n\t\tself.css('z-index', W.$$form_level * 10);\n\t\tself.element.scrollTop(0);\n\t\tself.rclass('hidden');\n\n\t\tself.resize();\n\t\tself.release(false);\n\n\t\tconfig.reload && EXEC(config.reload, self);\n\t\tconfig.default && DEFAULT(config.default, true);\n\n\t\tif (!isMOBILE && config.autofocus) {\n\t\t\tvar el = self.find(config.autofocus === true ? 'input[type=\"text\"],select,textarea' : config.autofocus);\n\t\t\tel.length && el[0].focus();\n\t\t}\n\n\t\tsetTimeout(function() {\n\t\t\tself.element.scrollTop(0);\n\t\t\tself.find('.ui-form').aclass('ui-form-animate');\n\t\t}, 300);\n\n\t\t// Fixes a problem with freezing of scrolling in Chrome\n\t\tsetTimeout2(self.ID, function() {\n\t\t\tself.css('z-index', (W.$$form_level * 10) + 1);\n\t\t}, 500);\n\t};\n});\n\nCOMPONENT('dropdown', function(self, config) {\n\n\tvar select, condition, content = null;\n\tvar render = '';\n\n\tself.nocompile();\n\n\tself.validate = function(value) {\n\n\t\tif (!config.required || config.disabled)\n\t\t\treturn true;\n\n\t\tvar type = typeof(value);\n\t\tif (type === 'undefined' || type === 'object')\n\t\t\tvalue = '';\n\t\telse\n\t\t\tvalue = value.toString();\n\n\t\tEMIT('reflow', self.name);\n\n\t\tswitch (self.type) {\n\t\t\tcase 'currency':\n\t\t\tcase 'number':\n\t\t\t\treturn value > 0;\n\t\t}\n\n\t\treturn value.length > 0;\n\t};\n\n\tself.configure = function(key, value, init) {\n\n\t\tif (init)\n\t\t\treturn;\n\n\t\tvar redraw = false;\n\n\t\tswitch (key) {\n\t\t\tcase 'type':\n\t\t\t\tself.type = value;\n\t\t\t\tbreak;\n\t\t\tcase 'items':\n\n\t\t\t\tif (value instanceof Array) {\n\t\t\t\t\tself.bind('', value);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tvar items = [];\n\n\t\t\t\tvalue.split(',').forEach(function(item) {\n\t\t\t\t\titem = item.trim().split('|');\n\t\t\t\t\tvar obj = { id: item[1] == null ? item[0] : item[1], name: item[0] };\n\t\t\t\t\titems.push(obj);\n\t\t\t\t});\n\n\t\t\t\tself.bind('', items);\n\t\t\t\tbreak;\n\t\t\tcase 'if':\n\t\t\t\tcondition = value ? FN(value) : null;\n\t\t\t\tbreak;\n\t\t\tcase 'required':\n\t\t\t\tself.tclass('ui-dropdown-required', value === true);\n\t\t\t\tself.state(1, 1);\n\t\t\t\tbreak;\n\t\t\tcase 'datasource':\n\t\t\t\tself.datasource(value, self.bind);\n\t\t\t\tbreak;\n\t\t\tcase 'label':\n\t\t\t\tcontent = value;\n\t\t\t\tredraw = true;\n\t\t\t\tbreak;\n\t\t\tcase 'icon':\n\t\t\t\tredraw = true;\n\t\t\t\tbreak;\n\t\t\tcase 'disabled':\n\t\t\t\tself.tclass('ui-disabled', value);\n\t\t\t\tself.find('select').prop('disabled', value);\n\t\t\t\tself.reset();\n\t\t\t\tbreak;\n\t\t}\n\n\t\tredraw && setTimeout2(self.id + '.redraw', 100);\n\t};\n\n\tself.bind = function(path, arr) {\n\n\t\tif (!arr)\n\t\t\tarr = EMPTYARRAY;\n\n\t\tvar builder = [];\n\t\tvar value = self.get();\n\t\tvar template = '<option value=\"{0}\"{1}>{2}</option>';\n\t\tvar propText = config.text || 'name';\n\t\tvar propValue = config.value || 'id';\n\n\t\tconfig.empty !== undefined && builder.push('<option value=\"\">{0}</option>'.format(config.empty));\n\n\t\tvar type = typeof(arr[0]);\n\t\tvar notObj = type === 'string' || type === 'number';\n\n\t\tfor (var i = 0, length = arr.length; i < length; i++) {\n\t\t\tvar item = arr[i];\n\t\t\tif (condition && !condition(item))\n\t\t\t\tcontinue;\n\t\t\tif (notObj)\n\t\t\t\tbuilder.push(template.format(item, value === item ? ' selected=\"selected\"' : '', item));\n\t\t\telse\n\t\t\t\tbuilder.push(template.format(item[propValue], value === item[propValue] ? ' selected=\"selected\"' : '', item[propText]));\n\t\t}\n\n\t\trender = builder.join('');\n\t\tselect.html(render);\n\t};\n\n\tself.redraw = function() {\n\t\tvar html = '<div class=\"ui-dropdown\"><select data-jc-bind=\"\">{0}</select></div>'.format(render);\n\t\tvar builder = [];\n\t\tvar label = content || config.label;\n\t\tif (label) {\n\t\t\tbuilder.push('<div class=\"ui-dropdown-label\">{0}{1}:</div>'.format(config.icon ? '<span class=\"fa fa-{0}\"></span> '.format(config.icon) : '', label));\n\t\t\tbuilder.push('<div class=\"ui-dropdown-values\">{0}</div>'.format(html));\n\t\t\tself.html(builder.join(''));\n\t\t} else\n\t\t\tself.html(html).aclass('ui-dropdown-values');\n\t\tselect = self.find('select');\n\t\trender && self.refresh();\n\t\tconfig.disabled && self.reconfigure('disabled:true');\n\t\tself.tclass('ui-dropdown-required', config.required === true);\n\t};\n\n\tself.make = function() {\n\t\tself.type = config.type;\n\t\tcontent = self.html();\n\t\tself.aclass('ui-dropdown-container');\n\t\tself.redraw();\n\t\tconfig.if && (condition = FN(config.if));\n\t\tconfig.items && self.reconfigure({ items: config.items });\n\t\tconfig.datasource && self.reconfigure('datasource:' + config.datasource);\n\t};\n\n\tself.state = function(type) {\n\t\tif (!type)\n\t\t\treturn;\n\t\tvar invalid = config.required ? self.isInvalid() : false;\n\t\tif (invalid === self.$oldstate)\n\t\t\treturn;\n\t\tself.$oldstate = invalid;\n\t\tself.tclass('ui-dropdown-invalid', invalid);\n\t};\n});\n\nCOMPONENT('validation', 'delay:100;flags:visible', function(self, config) {\n\n\tvar path, elements = null;\n\tvar def = 'button[name=\"submit\"]';\n\tvar flags = null;\n\n\tself.readonly();\n\n\tself.make = function() {\n\t\telements = self.find(config.selector || def);\n\t\tpath = self.path.replace(/\\.\\*$/, '');\n\t\tsetTimeout(function() {\n\t\t\tself.watch(self.path, self.state, true);\n\t\t}, 50);\n\t};\n\n\tself.configure = function(key, value, init) {\n\t\tswitch (key) {\n\t\t\tcase 'selector':\n\t\t\t\tif (!init)\n\t\t\t\t\telements = self.find(value || def);\n\t\t\t\tbreak;\n\t\t\tcase 'flags':\n\t\t\t\tif (value) {\n\t\t\t\t\tflags = value.split(',');\n\t\t\t\t\tfor (var i = 0; i < flags.length; i++)\n\t\t\t\t\t\tflags[i] = '@' + flags[i];\n\t\t\t\t} else\n\t\t\t\t\tflags = null;\n\t\t\t\tbreak;\n\t\t}\n\t};\n\n\tself.state = function() {\n\t\tsetTimeout2(self.id, function() {\n\t\t\tvar disabled = DISABLED(path, flags);\n\t\t\tif (!disabled && config.if)\n\t\t\t\tdisabled = !EVALUATE(self.path, config.if);\n\t\t\telements.prop('disabled', disabled);\n\t\t}, config.timeout);\n\t};\n});\n\nCOMPONENT('textarea', function(self, config) {\n\n\tvar input, content = null;\n\n\tself.nocompile();\n\n\tself.validate = function(value) {\n\t\tif (config.disabled || !config.required || config.readonly)\n\t\t\treturn true;\n\t\tif (value == null)\n\t\t\tvalue = '';\n\t\telse\n\t\t\tvalue = value.toString();\n\t\treturn value.length > 0;\n\t};\n\n\tself.configure = function(key, value, init) {\n\t\tif (init)\n\t\t\treturn;\n\n\t\tvar redraw = false;\n\n\t\tswitch (key) {\n\t\t\tcase 'readonly':\n\t\t\t\tself.find('textarea').prop('readonly', value);\n\t\t\t\tbreak;\n\t\t\tcase 'disabled':\n\t\t\t\tself.tclass('ui-disabled', value);\n\t\t\t\tself.find('textarea').prop('disabled', value);\n\t\t\t\tself.reset();\n\t\t\t\tbreak;\n\t\t\tcase 'required':\n\t\t\t\tself.noValid(!value);\n\t\t\t\t!value && self.state(1, 1);\n\t\t\t\tself.tclass('ui-textarea-required', value);\n\t\t\t\tbreak;\n\t\t\tcase 'placeholder':\n\t\t\t\tinput.prop('placeholder', value || '');\n\t\t\t\tbreak;\n\t\t\tcase 'maxlength':\n\t\t\t\tinput.prop('maxlength', value || 1000);\n\t\t\t\tbreak;\n\t\t\tcase 'label':\n\t\t\t\tredraw = true;\n\t\t\t\tbreak;\n\t\t\tcase 'autofocus':\n\t\t\t\tinput.focus();\n\t\t\t\tbreak;\n\t\t\tcase 'monospace':\n\t\t\t\tself.tclass('ui-textarea-monospace', value);\n\t\t\t\tbreak;\n\t\t\tcase 'icon':\n\t\t\t\tredraw = true;\n\t\t\t\tbreak;\n\t\t\tcase 'format':\n\t\t\t\tself.format = value;\n\t\t\t\tself.refresh();\n\t\t\t\tbreak;\n\t\t\tcase 'height':\n\t\t\t\tself.find('textarea').css('height', (value > 0 ? value + 'px' : value));\n\t\t\t\tbreak;\n\t\t}\n\n\t\tredraw && setTimeout2('redraw' + self.id, function() {\n\t\t\tself.redraw();\n\t\t\tself.refresh();\n\t\t}, 100);\n\t};\n\n\tself.redraw = function() {\n\n\t\tvar attrs = [];\n\t\tvar builder = [];\n\n\t\tself.tclass('ui-disabled', config.disabled === true);\n\t\tself.tclass('ui-textarea-monospace', config.monospace === true);\n\t\tself.tclass('ui-textarea-required', config.required === true);\n\n\t\tconfig.placeholder && attrs.attr('placeholder', config.placeholder);\n\t\tconfig.maxlength && attrs.attr('maxlength', config.maxlength);\n\t\tconfig.error && attrs.attr('error');\n\t\tattrs.attr('data-jc-bind', '');\n\t\tconfig.height && attrs.attr('style', 'height:{0}px'.format(config.height));\n\t\tconfig.autofocus === 'true' && attrs.attr('autofocus');\n\t\tconfig.disabled && attrs.attr('disabled');\n\t\tconfig.readonly && attrs.attr('readonly');\n\t\tbuilder.push('<textarea {0}></textarea>'.format(attrs.join(' ')));\n\n\t\tvar label = config.label || content;\n\n\t\tif (!label.length) {\n\t\t\tconfig.error && builder.push('<div class=\"ui-textarea-helper\"><i class=\"fa fa-warning\" aria-hidden=\"true\"></i> {0}</div>'.format(config.error));\n\t\t\tself.aclass('ui-textarea ui-textarea-container');\n\t\t\tself.html(builder.join(''));\n\t\t\tinput = self.find('textarea');\n\t\t\treturn;\n\t\t}\n\n\t\tvar html = builder.join('');\n\n\t\tbuilder = [];\n\t\tbuilder.push('<div class=\"ui-textarea-label\">');\n\t\tconfig.icon && builder.push('<i class=\"fa fa-{0}\"></i>'.format(config.icon));\n\t\tbuilder.push(label);\n\t\tbuilder.push(':</div><div class=\"ui-textarea\">{0}</div>'.format(html));\n\t\tconfig.error && builder.push('<div class=\"ui-textarea-helper\"><i class=\"fa fa-warning\" aria-hidden=\"true\"></i> {0}</div>'.format(config.error));\n\n\t\tself.html(builder.join(''));\n\t\tself.rclass('ui-textarea');\n\t\tself.aclass('ui-textarea-container');\n\t\tinput = self.find('textarea');\n\t};\n\n\tself.make = function() {\n\t\tcontent = self.html();\n\t\tself.type = config.type;\n\t\tself.format = config.format;\n\t\tself.redraw();\n\t};\n\n\tself.state = function(type) {\n\t\tif (!type)\n\t\t\treturn;\n\t\tvar invalid = config.required ? self.isInvalid() : false;\n\t\tif (invalid === self.$oldstate)\n\t\t\treturn;\n\t\tself.$oldstate = invalid;\n\t\tself.tclass('ui-textarea-invalid', invalid);\n\t\tconfig.error && self.find('.ui-textarea-helper').tclass('ui-textarea-helper-show', invalid);\n\t};\n});\n\nCOMPONENT('checkbox', function(self, config) {\n\n\tself.nocompile();\n\n\tself.validate = function(value) {\n\t\treturn (config.disabled || !config.required) ? true : (value === true || value === 'true' || value === 'on');\n\t};\n\n\tself.configure = function(key, value, init) {\n\t\tif (init)\n\t\t\treturn;\n\t\tswitch (key) {\n\t\t\tcase 'label':\n\t\t\t\tself.find('span').html(value);\n\t\t\t\tbreak;\n\t\t\tcase 'required':\n\t\t\t\tself.find('span').tclass('ui-checkbox-label-required', value);\n\t\t\t\tbreak;\n\t\t\tcase 'disabled':\n\t\t\t\tself.tclass('ui-disabled', value);\n\t\t\t\tbreak;\n\t\t\tcase 'checkicon':\n\t\t\t\tself.find('i').rclass().aclass('fa fa-' + value);\n\t\t\t\tbreak;\n\t\t}\n\t};\n\n\tself.make = function() {\n\t\tself.aclass('ui-checkbox');\n\t\tself.html('<div><i class=\"fa fa-{2}\"></i></div><span{1}>{0}</span>'.format(config.label || self.html(), config.required ? ' class=\"ui-checkbox-label-required\"' : '', config.checkicon || 'check'));\n\t\tself.event('click', function() {\n\t\t\tif (config.disabled)\n\t\t\t\treturn;\n\t\t\tself.dirty(false);\n\t\t\tself.getter(!self.get());\n\t\t});\n\t};\n\n\tself.setter = function(value) {\n\t\tself.toggle('ui-checkbox-checked', !!value);\n\t};\n});\n\nCOMPONENT('codemirror', 'linenumbers:false;required:false;trim:false;tabs:false', function(self, config) {\n\n\tvar editor = null;\n\n\tself.getter = null;\n\tself.bindvisible();\n\tself.nocompile();\n\n\tself.reload = function() {\n\t\teditor.refresh();\n\t};\n\n\tself.validate = function(value) {\n\t\treturn (config.disabled || !config.required ? true : value && value.length > 0) === true;\n\t};\n\n\tself.insert = function(value) {\n\t\teditor.replaceSelection(value);\n\t\tself.change(true);\n\t};\n\n\tself.configure = function(key, value, init) {\n\t\tif (init)\n\t\t\treturn;\n\n\t\tswitch (key) {\n\t\t\tcase 'disabled':\n\t\t\t\tself.tclass('ui-disabled', value);\n\t\t\t\teditor.readOnly = value;\n\t\t\t\teditor.refresh();\n\t\t\t\tbreak;\n\t\t\tcase 'required':\n\t\t\t\tself.find('.ui-codemirror-label').tclass('ui-codemirror-label-required', value);\n\t\t\t\tself.state(1, 1);\n\t\t\t\tbreak;\n\t\t\tcase 'icon':\n\t\t\t\tself.find('i').rclass().aclass('fa fa-' + value);\n\t\t\t\tbreak;\n\t\t}\n\n\t};\n\n\tself.make = function() {\n\t\tvar content = config.label || self.html();\n\t\tself.html((content ? '<div class=\"ui-codemirror-label' + (config.required ? ' ui-codemirror-label-required' : '') + '\">' + (config.icon ? '<i class=\"fa fa-' + config.icon + '\"></i> ' : '') + content + ':</div>' : '') + '<div class=\"ui-codemirror\"></div>');\n\t\tvar container = self.find('.ui-codemirror');\n\n\t\tvar options = {};\n\t\toptions.lineNumbers = config.linenumbers;\n\t\toptions.mode = config.type || 'htmlmixed';\n\t\toptions.indentUnit = 4;\n\n\t\tif (config.tabs)\n\t\t\toptions.indentWithTabs = true;\n\n\t\tif (config.type === 'markdown') {\n\t\t\toptions.styleActiveLine = true;\n\t\t\toptions.lineWrapping = true;\n\t\t\toptions.matchBrackets = true;\n\t\t}\n\n\t\teditor = CodeMirror(container[0], options);\n\t\tself.editor = editor;\n\n\t\tif (config.height !== 'auto') {\n\t\t\tvar is = typeof(config.height) === 'number';\n\t\t\teditor.setSize('100%', is ? (config.height + 'px') : (config.height || '200px'));\n\t\t\t!is && self.css('height', config.height);\n\t\t}\n\n\t\tif (config.disabled) {\n\t\t\tself.aclass('ui-disabled');\n\t\t\teditor.readOnly = true;\n\t\t\teditor.refresh();\n\t\t}\n\n\t\tvar can = {};\n\t\tcan['+input'] = can['+delete'] = can.undo = can.redo = can.paste = can.cut = can.clear = true;\n\n\t\teditor.on('change', function(a, b) {\n\n\t\t\tif (config.disabled || !can[b.origin])\n\t\t\t\treturn;\n\n\t\t\tsetTimeout2(self.id, function() {\n\t\t\t\tvar val = editor.getValue();\n\n\t\t\t\tif (config.trim) {\n\t\t\t\t\tvar lines = val.split('\\n');\n\t\t\t\t\tfor (var i = 0, length = lines.length; i < length; i++)\n\t\t\t\t\t\tlines[i] = lines[i].replace(/\\s+$/, '');\n\t\t\t\t\tval = lines.join('\\n').trim();\n\t\t\t\t}\n\n\t\t\t\tself.getter2 && self.getter2(val);\n\t\t\t\tself.change(true);\n\t\t\t\tself.rewrite(val);\n\t\t\t\tconfig.required && self.validate2();\n\t\t\t}, 200);\n\n\t\t});\n\t};\n\n\tself.setter = function(value) {\n\n\t\teditor.setValue(value || '');\n\t\teditor.refresh();\n\n\t\tsetTimeout(function() {\n\t\t\teditor.refresh();\n\t\t\teditor.scrollTo(0, 0);\n\t\t\teditor.setCursor(0);\n\t\t}, 200);\n\n\t\tsetTimeout(function() {\n\t\t\teditor.refresh();\n\t\t}, 1000);\n\n\t\tsetTimeout(function() {\n\t\t\teditor.refresh();\n\t\t}, 2000);\n\t};\n\n\tself.state = function(type) {\n\t\tif (!type)\n\t\t\treturn;\n\t\tvar invalid = config.required ? self.isInvalid() : false;\n\t\tif (invalid === self.$oldstate)\n\t\t\treturn;\n\t\tself.$oldstate = invalid;\n\t\tself.find('.ui-codemirror').tclass('ui-codemirror-invalid', invalid);\n\t};\n}, ['//cdnjs.cloudflare.com/ajax/libs/codemirror/5.32.0/codemirror.min.css', '//cdnjs.cloudflare.com/ajax/libs/codemirror/5.32.0/codemirror.min.js', '//cdnjs.cloudflare.com/ajax/libs/codemirror/5.32.0/mode/javascript/javascript.min.js', '//cdnjs.cloudflare.com/ajax/libs/codemirror/5.32.0/mode/htmlmixed/htmlmixed.min.js', '//cdnjs.cloudflare.com/ajax/libs/codemirror/5.32.0/mode/xml/xml.min.js', '//cdnjs.cloudflare.com/ajax/libs/codemirror/5.32.0/mode/css/css.min.js', '//cdnjs.cloudflare.com/ajax/libs/codemirror/5.32.0/mode/markdown/markdown.min.js', function(next) {\n\tCodeMirror.defineMode('totaljsresources', function() {\n\t\tvar REG_KEY = /^[a-z0-9_\\-.#]+/i;\n\t\treturn {\n\n\t\t\tstartState: function() {\n\t\t\t\treturn { type: 0, keyword: 0 };\n\t\t\t},\n\n\t\t\ttoken: function(stream, state) {\n\n\t\t\t\tvar m;\n\n\t\t\t\tif (stream.sol()) {\n\n\t\t\t\t\tvar line = stream.string;\n\t\t\t\t\tif (line.substring(0, 2) === '//') {\n\t\t\t\t\t\tstream.skipToEnd();\n\t\t\t\t\t\treturn 'comment';\n\t\t\t\t\t}\n\n\t\t\t\t\tstate.type = 0;\n\t\t\t\t}\n\n\t\t\t\tm = stream.match(REG_KEY, true);\n\t\t\t\tif (m)\n\t\t\t\t\treturn 'tag';\n\n\t\t\t\tif (!stream.string) {\n\t\t\t\t\tstream.next();\n\t\t\t\t\treturn '';\n\t\t\t\t}\n\n\t\t\t\tvar count = 0;\n\n\t\t\t\twhile (true) {\n\n\t\t\t\t\tcount++;\n\t\t\t\t\tif (count > 5000)\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tvar c = stream.peek();\n\t\t\t\t\tif (c === ':') {\n\t\t\t\t\t\tstream.skipToEnd();\n\t\t\t\t\t\treturn 'def';\n\t\t\t\t\t}\n\n\t\t\t\t\tif (c === '(') {\n\t\t\t\t\t\tif (stream.skipTo(')')) {\n\t\t\t\t\t\t\tstream.eat(')');\n\t\t\t\t\t\t\treturn 'variable-L';\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t\tstream.next();\n\t\t\t\treturn '';\n\t\t\t}\n\t\t};\n\t});\n\tnext();\n}]);\n\nCOMPONENT('nosqlcounter', 'count:0;height:80', function(self, config) {\n\n\tvar months = MONTHS;\n\tvar container, labels;\n\n\tself.bindvisible();\n\tself.readonly();\n\tself.nocompile();\n\n\tself.make = function() {\n\t\tself.aclass('ui-nosqlcounter');\n\t\tself.append('<div class=\"ui-nosqlcounter-table\"{0}><div class=\"ui-nosqlcounter-cell\"></div></div><div class=\"ui-nosqlcounter-labels\"></div>'.format(config.height ? ' style=\"height:{0}px\"'.format(config.height) : ''));\n\t\tcontainer = self.find('.ui-nosqlcounter-cell');\n\t\tlabels = self.find('.ui-nosqlcounter-labels');\n\t};\n\n\tself.configure = function(key, value) {\n\t\tswitch (key) {\n\t\t\tcase 'months':\n\t\t\t\tif (value instanceof Array)\n\t\t\t\t\tmonths = value;\n\t\t\t\telse\n\t\t\t\t\tmonths = value.split(',').trim();\n\t\t\t\tbreak;\n\t\t}\n\t};\n\n\tself.redraw = function(maxbars) {\n\n\t\tvar value = self.get();\n\t\tif (!(value instanceof Array))\n\t\t\tvalue = [];\n\n\t\tvar dt = new Date();\n\t\tdt.setDate(1);\n\t\tvar current = dt.format('yyyyMM');\n\t\tvar stats = null;\n\n\t\tif (config.lastvalues) {\n\t\t\tvar max = value.length - maxbars;\n\t\t\tif (max < 0)\n\t\t\t\tmax = 0;\n\t\t\tstats = value.slice(max, value.length);\n\t\t} else {\n\t\t\tstats = [];\n\t\t\tfor (var i = 0; i < maxbars; i++) {\n\t\t\t\tvar id = dt.format('yyyyMM');\n\t\t\t\tvar item = value.findItem('id', id);\n\t\t\t\tstats.push(item ? item : { id: id, month: dt.getMonth() + 1, year: dt.getFullYear(), value: 0 });\n\t\t\t\tdt = dt.add('-1 month');\n\t\t\t}\n\t\t\tstats.reverse();\n\t\t}\n\n\t\tvar max = stats.scalar('max', 'value');\n\t\tvar bar = 100 / maxbars;\n\t\tvar builder = [];\n\t\tvar dates = [];\n\t\tvar cls = '';\n\t\tvar min = ((20 / config.height) * 100) >> 0;\n\t\tvar sum = '';\n\n\t\tfor (var i = 0, length = stats.length; i < length; i++) {\n\t\t\tvar item = stats[i];\n\t\t\tvar val = item.value;\n\n\t\t\tif (val > 999)\n\t\t\t\tval = (val / 1000).format(1, 2) + 'K';\n\n\t\t\tsum += val + ',';\n\n\t\t\tvar h = max === 0 ? 0 : ((item.value / max) * (100 - min));\n\t\t\th += min;\n\n\t\t\tcls = item.value ? '' : 'empty';\n\n\t\t\tif (item.id === current)\n\t\t\t\tcls += (cls ? ' ' : '') + 'current';\n\n\t\t\tif (i === maxbars - 1)\n\t\t\t\tcls += (cls ? ' ' : '') + 'last';\n\n\t\t\tvar w = bar.format(2, '');\n\n\t\t\tbuilder.push('<div style=\"width:{0}%\" title=\"{3}\" class=\"{4}\"><div style=\"height:{1}%\"><span>{2}</span></div></div>'.format(w, h.format(0, ''), val, months[item.month - 1] + ' ' + item.year, cls));\n\t\t\tdates.push('<div style=\"width:{0}%\">{1}</div>'.format(w, months[item.month - 1].substring(0, 3)));\n\t\t}\n\n\t\tif (self.old !== sum) {\n\t\t\tself.old = sum;\n\t\t\tlabels.html(dates.join(''));\n\t\t\tcontainer.html(builder.join(''));\n\t\t}\n\t};\n\n\tself.setter = function(value) {\n\t\tif (config.count === 0) {\n\t\t\tself.width(function(width) {\n\t\t\t\tself.redraw(width / 30 >> 0);\n\t\t\t});\n\t\t} else\n\t\t\tself.redraw(WIDTH() === 'xs' ? config.count / 2 : config.count, value);\n\t};\n});\n\nCOMPONENT('keyvalue', 'maxlength:100', function(self, config) {\n\n\tvar container, content = null;\n\tvar cempty = 'empty';\n\tvar skip = false;\n\tvar empty = {};\n\n\tself.template = Tangular.compile('<div class=\"ui-keyvalue-item\"><div class=\"ui-keyvalue-item-remove\"><i class=\"fa fa-times\"></i></div><div class=\"ui-keyvalue-item-key\"><input type=\"text\" name=\"key\" maxlength=\"{{ max }}\"{{ if disabled }} disabled=\"disabled\"{{ fi }} placeholder=\"{{ placeholder_key }}\" value=\"{{ key }}\" /></div><div class=\"ui-keyvalue-item-value\"><input type=\"text\" maxlength=\"{{ max }}\" placeholder=\"{{ placeholder_value }}\" value=\"{{ value }}\" /></div></div>');\n\tself.nocompile();\n\n\tself.binder = function(type, value) {\n\t\treturn value;\n\t};\n\n\tself.configure = function(key, value, init, prev) {\n\t\tif (init)\n\t\t\treturn;\n\n\t\tvar redraw = false;\n\n\t\tswitch (key) {\n\t\t\tcase 'disabled':\n\t\t\t\tself.tclass('ui-disabled', value);\n\t\t\t\tself.find('input').prop('disabled', value);\n\t\t\t\tempty.disabled = value;\n\t\t\t\tbreak;\n\t\t\tcase 'maxlength':\n\t\t\t\tself.find('input').prop('maxlength', value);\n\t\t\t\tbreak;\n\t\t\tcase 'placeholderkey':\n\t\t\t\tself.find('input[name=\"key\"]').prop('placeholder', value);\n\t\t\t\tbreak;\n\t\t\tcase 'placeholdervalue':\n\t\t\t\tself.find('input[name=\"value\"]').prop('placeholder', value);\n\t\t\t\tbreak;\n\t\t\tcase 'icon':\n\t\t\t\tif (value && prev)\n\t\t\t\t\tself.find('i').rclass('fa').aclass('fa fa-' + value);\n\t\t\t\telse\n\t\t\t\t\tredraw = true;\n\t\t\t\tbreak;\n\n\t\t\tcase 'label':\n\t\t\t\tredraw = true;\n\t\t\t\tbreak;\n\t\t}\n\n\t\tif (redraw) {\n\t\t\tself.redraw();\n\t\t\tself.refresh();\n\t\t}\n\t};\n\n\tself.redraw = function() {\n\n\t\tvar icon = config.icon;\n\t\tvar label = config.label || content;\n\n\t\tif (icon)\n\t\t\ticon = '<i class=\"fa fa-{0}\"></i>'.format(icon);\n\n\t\tempty.value = '';\n\n\t\tself.html((label ? '<div class=\"ui-keyvalue-label\">{1}{0}:</div>'.format(label, icon) : '') + '<div class=\"ui-keyvalue-items\"></div>' + self.template(empty).replace('-item\"', '-item ui-keyvalue-base\"'));\n\t\tcontainer = self.find('.ui-keyvalue-items');\n\t};\n\n\tself.make = function() {\n\n\t\tempty.max = config.maxlength;\n\t\tempty.placeholder_key = config.placeholderkey;\n\t\tempty.placeholder_value = config.placeholdervalue;\n\t\tempty.value = '';\n\t\tempty.disabled = config.disabled;\n\n\t\tcontent = self.html();\n\n\t\tself.aclass('ui-keyvalue');\n\t\tself.disabled && self.aclass('ui-disabled');\n\t\tself.redraw();\n\n\t\tself.event('click', '.fa-times', function() {\n\n\t\t\tif (config.disabled)\n\t\t\t\treturn;\n\n\t\t\tvar el = $(this);\n\t\t\tvar parent = el.closest('.ui-keyvalue-item');\n\t\t\tvar inputs = parent.find('input');\n\t\t\tvar obj = self.get();\n\t\t\t!obj && (obj = {});\n\t\t\tvar key = inputs[0].value;\n\t\t\tparent.remove();\n\t\t\tdelete obj[key];\n\n\t\t\tself.set(obj, 2);\n\t\t\tself.change(true);\n\t\t});\n\n\t\tself.event('change keypress', 'input', function(e) {\n\n\t\t\tif (config.disabled || (e.type !== 'change' && e.which !== 13))\n\t\t\t\treturn;\n\n\t\t\tvar el = $(this);\n\t\t\tvar inputs = el.closest('.ui-keyvalue-item').find('input');\n\t\t\tvar key = self.binder('key', inputs[0].value);\n\t\t\tvar value = self.binder('value', inputs.get(1).value);\n\n\t\t\tif (!key || !value)\n\t\t\t\treturn;\n\n\t\t\tvar base = el.closest('.ui-keyvalue-base').length > 0;\n\t\t\tif (base && e.type === 'change')\n\t\t\t\treturn;\n\n\t\t\tif (base) {\n\t\t\t\tvar tmp = self.get();\n\t\t\t\t!tmp && (tmp = {});\n\t\t\t\ttmp[key] = value;\n\t\t\t\tself.set(tmp);\n\t\t\t\tself.change(true);\n\t\t\t\tinputs.val('');\n\t\t\t\tinputs.eq(0).focus();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar keyvalue = {};\n\t\t\tvar k;\n\n\t\t\tcontainer.find('input').each(function() {\n\t\t\t\tif (this.name === 'key') {\n\t\t\t\t\tk = this.value.trim();\n\t\t\t\t} else if (k) {\n\t\t\t\t\tkeyvalue[k] = this.value.trim();\n\t\t\t\t\tk = '';\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tskip = true;\n\t\t\tself.set(keyvalue, 2);\n\t\t\tself.change(true);\n\t\t});\n\t};\n\n\tself.setter = function(value) {\n\n\t\tif (skip) {\n\t\t\tskip = false;\n\t\t\treturn;\n\t\t}\n\n\t\tif (!value) {\n\t\t\tcontainer.empty();\n\t\t\tself.aclass(cempty);\n\t\t\treturn;\n\t\t}\n\n\t\tvar builder = [];\n\n\t\tObject.keys(value).forEach(function(key) {\n\t\t\tempty.key = key;\n\t\t\tempty.value = value[key];\n\t\t\tbuilder.push(self.template(empty));\n\t\t});\n\n\t\tself.tclass(cempty, builder.length === 0);\n\t\tcontainer.empty().append(builder.join(''));\n\t};\n});\n\nCOMPONENT('expander', function(self, config) {\n\n\tvar prev = false;\n\n\tself.readonly();\n\tself.blind();\n\n\tself.toggle = function(v) {\n\n\t\tif (v == null)\n\t\t\tv = !self.hclass('ui-expander-expanded');\n\n\t\tif (v === prev)\n\t\t\treturn;\n\n\t\tprev = v;\n\t\tself.tclass('ui-expander-expanded', v);\n\t\tvar fa = self.find('.ui-expander-button').find('.fa');\n\t\tfa.tclass('fa-angle-double-down', !v);\n\t\tfa.tclass('fa-angle-double-up', v);\n\t};\n\n\tself.make = function() {\n\t\tself.aclass('ui-expander' + (config.expand ? ' ui-expander-expanded' : ''));\n\t\tself.element.wrapInner('<div class=\"ui-expander-container\"></div>');\n\t\tself.append('<div class=\"ui-expander-fade\"></div><div class=\"ui-expander-button\"><span class=\"fa fa-angle-double-down\"></span></div>');\n\t\tself.event('click', '.ui-expander-button', function() {\n\t\t\tself.toggle();\n\t\t});\n\t};\n});\n\nCOMPONENT('disable', function(self, config) {\n\n\tvar validate = null;\n\tself.readonly();\n\n\tself.configure = function(key, value) {\n\t\tif (key === 'validate')\n\t\t\tvalidate = value.split(',').trim();\n\t};\n\n\tself.setter = function(value) {\n\t\tvar is = true;\n\n\t\tif (config.if)\n\t\t\tis = EVALUATE(self.path, config.if);\n\t\telse\n\t\t\tis = !value;\n\n\t\tself.find(config.selector || '[data-jc]').each(function() {\n\t\t\tvar com = $(this).component();\n\t\t\tcom && com.reconfigure('disabled:' + is);\n\t\t});\n\n\t\tvalidate && validate.forEach(FN('n => RESET({0}n)'.format(self.pathscope ? '\\'' + self.pathscope + '.\\'+' : '')));\n\t};\n\n\tself.state = function() {\n\t\tself.update();\n\t};\n});\n\nCOMPONENT('textboxlist', 'maxlength:100', function(self, config) {\n\n\tvar container, content;\n\tvar empty = {};\n\tvar skip = false;\n\tvar cempty = 'empty';\n\n\tself.readonly();\n\tself.nocompile();\n\tself.template = Tangular.compile('<div class=\"ui-textboxlist-item\"><div><i class=\"fa fa-times\"></i></div><div><input type=\"text\" maxlength=\"{{ max }}\" placeholder=\"{{ placeholder }}\"{{ if disabled}} disabled=\"disabled\"{{ fi }} value=\"{{ value }}\" /></div></div>');\n\n\tself.configure = function(key, value, init, prev) {\n\t\tif (init)\n\t\t\treturn;\n\n\t\tvar redraw = false;\n\t\tswitch (key) {\n\t\t\tcase 'disabled':\n\t\t\t\tself.tclass('ui-required', value);\n\t\t\t\tself.find('input').prop('disabled', true);\n\t\t\t\tempty.disabled = value;\n\t\t\t\tbreak;\n\t\t\tcase 'maxlength':\n\t\t\t\tempty.max = value;\n\t\t\t\tself.find('input').prop(key, value);\n\t\t\t\tbreak;\n\t\t\tcase 'placeholder':\n\t\t\t\tempty.placeholder = value;\n\t\t\t\tself.find('input').prop(key, value);\n\t\t\t\tbreak;\n\t\t\tcase 'label':\n\t\t\t\tredraw = true;\n\t\t\t\tbreak;\n\t\t\tcase 'icon':\n\t\t\t\tif (value && prev)\n\t\t\t\t\tself.find('i').rclass().aclass(value);\n\t\t\t\telse\n\t\t\t\t\tredraw = true;\n\t\t\t\tbreak;\n\t\t}\n\n\t\tif (redraw) {\n\t\t\tskip = false;\n\t\t\tself.redraw();\n\t\t\tself.refresh();\n\t\t}\n\t};\n\n\tself.redraw = function() {\n\n\t\tvar icon = '';\n\t\tvar html = config.label || content;\n\n\t\tif (config.icon)\n\t\t\ticon = '<i class=\"fa fa-{0}\"></i>'.format(config.icon);\n\n\t\tempty.value = '';\n\t\tself.html((html ? '<div class=\"ui-textboxlist-label\">{1}{0}:</div>'.format(html, icon) : '') + '<div class=\"ui-textboxlist-items\"></div>' + self.template(empty).replace('-item\"', '-item ui-textboxlist-base\"'));\n\t\tcontainer = self.find('.ui-textboxlist-items');\n\t};\n\n\tself.make = function() {\n\n\t\tempty.max = config.max;\n\t\tempty.placeholder = config.placeholder;\n\t\tempty.value = '';\n\t\tempty.disabled = config.disabled;\n\n\t\tif (config.disabled)\n\t\t\tself.aclass('ui-disabled');\n\n\t\tcontent = self.html();\n\t\tself.aclass('ui-textboxlist');\n\t\tself.redraw();\n\n\t\tself.event('click', '.fa-times', function() {\n\n\t\t\tif (config.disabled)\n\t\t\t\treturn;\n\n\t\t\tvar el = $(this);\n\t\t\tvar parent = el.closest('.ui-textboxlist-item');\n\t\t\tvar value = parent.find('input').val();\n\t\t\tvar arr = self.get();\n\n\t\t\tparent.remove();\n\n\t\t\tvar index = arr.indexOf(value);\n\t\t\tif (index === -1)\n\t\t\t\treturn;\n\n\t\t\tarr.splice(index, 1);\n\n\t\t\tself.tclass(cempty, arr.length === 0);\n\n\t\t\tskip = true;\n\t\t\tself.set(arr, 2);\n\t\t\tself.change(true);\n\t\t});\n\n\t\tself.event('change keypress', 'input', function(e) {\n\n\t\t\tif (config.disabled || (e.type !== 'change' && e.which !== 13))\n\t\t\t\treturn;\n\n\t\t\tvar el = $(this);\n\n\t\t\tvar value = this.value.trim();\n\t\t\tif (!value)\n\t\t\t\treturn;\n\n\t\t\tvar arr = [];\n\t\t\tvar base = el.closest('.ui-textboxlist-base').length > 0;\n\n\t\t\tif (base && e.type === 'change')\n\t\t\t\treturn;\n\n\t\t\tvar raw = self.get();\n\n\t\t\tif (base) {\n\n\t\t\t\tif (!raw || raw.indexOf(value) === -1)\n\t\t\t\t\tself.push(self.path, value, 2);\n\n\t\t\t\tthis.value = '';\n\t\t\t\tself.change(true);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tcontainer.find('input').each(function() {\n\t\t\t\tarr.push(this.value.trim());\n\t\t\t});\n\n\t\t\tskip = true;\n\t\t\tself.set(arr, 2);\n\t\t\tself.change(true);\n\t\t});\n\t};\n\n\tself.setter = function(value) {\n\n\t\tif (skip) {\n\t\t\tskip = false;\n\t\t\treturn;\n\t\t}\n\n\t\tif (!value || !value.length) {\n\t\t\tself.aclass(cempty);\n\t\t\tcontainer.empty();\n\t\t\treturn;\n\t\t}\n\n\t\tself.rclass(cempty);\n\n\t\tvar builder = [];\n\n\t\tvalue.forEach(function(item) {\n\t\t\tempty.value = item;\n\t\t\tbuilder.push(self.template(empty));\n\t\t});\n\n\t\tcontainer.empty().append(builder.join(''));\n\t};\n});\n\nCOMPONENT('dropdowncheckbox', 'checkicon:check;visible:0;alltext:All selected;limit:0;selectedtext:{0} selected', function(self, config) {\n\n\tvar data = [], render = '';\n\tvar container, values, content, datasource = null;\n\tvar prepared = false;\n\tvar W = window;\n\n\t!W.$dropdowncheckboxtemplate && (W.$dropdowncheckboxtemplate = Tangular.compile('<div class=\"ui-dropdowncheckbox-item\" data-index=\"{{ index }}\"><div><i class=\"fa fa-{{ $.checkicon }}\"></i></div><span>{{ text }}</span></div>'));\n\tvar template = W.$dropdowncheckboxtemplate;\n\n\tself.nocompile();\n\n\tself.validate = function(value) {\n\t\treturn config.disabled || !config.required ? true : value && value.length > 0;\n\t};\n\n\tself.configure = function(key, value, init) {\n\n\t\tif (init)\n\t\t\treturn;\n\n\t\tvar redraw = false;\n\n\t\tswitch (key) {\n\n\t\t\tcase 'type':\n\t\t\t\tself.type = value;\n\t\t\t\tbreak;\n\n\t\t\tcase 'required':\n\t\t\t\tself.tclass('ui-dropdowncheckbox-required', config.required);\n\t\t\t\tbreak;\n\n\t\t\tcase 'label':\n\t\t\t\tcontent = value;\n\t\t\t\tredraw = true;\n\t\t\t\tbreak;\n\n\t\t\tcase 'disabled':\n\t\t\t\tself.tclass('ui-disabled', value);\n\t\t\t\tself.reset();\n\t\t\t\tbreak;\n\n\t\t\tcase 'checkicon':\n\t\t\t\tself.find('i').rclass().aclass('fa fa-' + value);\n\t\t\t\tbreak;\n\n\t\t\tcase 'icon':\n\t\t\t\tredraw = true;\n\t\t\t\tbreak;\n\n\t\t\tcase 'datasource':\n\t\t\t\tself.datasource(value, self.bind);\n\t\t\t\tdatasource && self.refresh();\n\t\t\t\tdatasource = value;\n\t\t\t\tbreak;\n\n\t\t\tcase 'items':\n\n\t\t\t\tif (value instanceof Array) {\n\t\t\t\t\tself.bind('', value);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tvar items = [];\n\t\t\t\tvalue.split(',').forEach(function(item) {\n\t\t\t\t\titem = item.trim().split('|');\n\t\t\t\t\tvar val = (item[1] == null ? item[0] : item[1]).trim();\n\t\t\t\t\tif (config.type === 'number')\n\t\t\t\t\t\tval = +val;\n\t\t\t\t\titems.push({ name: item[0].trim(), id: val });\n\t\t\t\t});\n\n\t\t\t\tself.bind('', items);\n\t\t\t\tself.refresh();\n\t\t\t\tbreak;\n\t\t}\n\n\t\tredraw && setTimeout2(self.id + '.redraw', self.redraw, 100);\n\t};\n\n\tself.redraw = function() {\n\n\t\tvar html = '<div class=\"ui-dropdowncheckbox\"><span class=\"fa fa-caret-down\"></span><div class=\"ui-dropdowncheckbox-selected\"></div></div><div class=\"ui-dropdowncheckbox-values hidden\">{0}</div>'.format(render);\n\t\tif (content.length)\n\t\t\tself.html('<div class=\"ui-dropdowncheckbox-label\">{0}{1}:</div>'.format(config.icon ? ('<i class=\"fa fa-' + config.icon + '\"></i>') : '', content) + html);\n\t\telse\n\t\t\tself.html(html);\n\n\t\tcontainer = self.find('.ui-dropdowncheckbox-values');\n\t\tvalues = self.find('.ui-dropdowncheckbox-selected');\n\t\tprepared && self.refresh();\n\t\tself.tclass('ui-disabled', config.disabled === true);\n\t\tself.tclass('ui-dropdowncheckbox-required', config.required === true);\n\t};\n\n\tself.make = function() {\n\n\t\tself.type = config.type;\n\n\t\tcontent = self.html();\n\t\tself.aclass('ui-dropdowncheckbox-container');\n\t\tself.redraw();\n\n\t\tif (config.items)\n\t\t\tself.reconfigure({ items: config.items });\n\t\telse if (config.datasource)\n\t\t\tself.reconfigure({ datasource: config.datasource });\n\t\telse\n\t\t\tself.bind('', null);\n\n\t\tself.event('click', '.ui-dropdowncheckbox', function(e) {\n\n\t\t\tif (config.disabled)\n\t\t\t\treturn;\n\n\t\t\tcontainer.tclass('hidden');\n\n\t\t\tif (W.$dropdowncheckboxelement) {\n\t\t\t\tW.$dropdowncheckboxelement.aclass('hidden');\n\t\t\t\tW.$dropdowncheckboxelement = null;\n\t\t\t}\n\n\t\t\t!container.hclass('hidden') && (W.$dropdowncheckboxelement = container);\n\t\t\te.stopPropagation();\n\t\t});\n\n\t\tself.event('click', '.ui-dropdowncheckbox-item', function(e) {\n\n\t\t\te.stopPropagation();\n\n\t\t\tif (config.disabled)\n\t\t\t\treturn;\n\n\t\t\tvar el = $(this);\n\t\t\tvar is = !el.hclass('ui-dropdowncheckbox-checked');\n\t\t\tvar index = +el.attrd('index');\n\t\t\tvar value = data[index];\n\n\t\t\tif (value === undefined)\n\t\t\t\treturn;\n\n\t\t\tvalue = value.value;\n\n\t\t\tvar arr = self.get();\n\n\t\t\tif (!(arr instanceof Array))\n\t\t\t\tarr = [];\n\n\t\t\tvar index = arr.indexOf(value);\n\n\t\t\tif (is) {\n\t\t\t\tif (config.limit && arr.length === config.limit)\n\t\t\t\t\treturn;\n\t\t\t\tindex === -1 && arr.push(value);\n\t\t\t} else {\n\t\t\t\tindex !== -1 && arr.splice(index, 1);\n\t\t\t}\n\n\t\t\tself.set(arr);\n\t\t\tself.change(true);\n\t\t});\n\t};\n\n\tself.bind = function(path, value) {\n\t\tvar clsempty = 'ui-dropdowncheckbox-values-empty';\n\n\t\tif (value !== undefined)\n\t\t\tprepared = true;\n\n\t\tif (!value || !value.length) {\n\t\t\tvar h = config.empty || '&nbsp;';\n\t\t\tif (h === self.old)\n\t\t\t\treturn;\n\t\t\tcontainer.aclass(clsempty).html(h);\n\t\t\tself.old = h;\n\t\t\treturn;\n\t\t}\n\n\t\tvar kv = config.value || 'id';\n\t\tvar kt = config.text || 'name';\n\n\t\trender = '';\n\t\tdata = [];\n\n\t\tfor (var i = 0, length = value.length; i < length; i++) {\n\t\t\tvar isString = typeof(value[i]) === 'string';\n\t\t\tvar item = { value: isString ? value[i] : value[i][kv], text: isString ? value[i] : value[i][kt], index: i };\n\t\t\trender += template(item, config);\n\t\t\tdata.push(item);\n\t\t}\n\n\t\tvar h = HASH(render);\n\t\tif (h === self.old)\n\t\t\treturn;\n\n\t\tself.old = h;\n\n\t\tif (render)\n\t\t\tcontainer.rclass(clsempty).html(render);\n\t\telse\n\t\t\tcontainer.aclass(clsempty).html(config.empty);\n\n\t\tself.refresh();\n\t};\n\n\tself.setter = function(value) {\n\n\t\tif (!prepared)\n\t\t\treturn;\n\n\t\tvar label = '';\n\t\tvar count = value == null || !value.length ? undefined : value.length;\n\n\t\tif (value && count) {\n\t\t\tvar remove = [];\n\t\t\tfor (var i = 0; i < count; i++) {\n\t\t\t\tvar selected = value[i];\n\t\t\t\tvar index = 0;\n\t\t\t\tvar is = false;\n\t\t\t\twhile (true) {\n\t\t\t\t\tvar item = data[index++];\n\t\t\t\t\tif (item === undefined)\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tif (item.value != selected)\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\tlabel += (label ? ', ' : '') + item.text;\n\t\t\t\t\tis = true;\n\t\t\t\t}\n\t\t\t\t!is && remove.push(selected);\n\t\t\t}\n\n\t\t\tif (config.cleaner !== false && value) {\n\t\t\t\tvar refresh = false;\n\t\t\t\twhile (true) {\n\t\t\t\t\tvar item = remove.shift();\n\t\t\t\t\tif (item === undefined)\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tvalue.splice(value.indexOf(item), 1);\n\t\t\t\t\trefresh = true;\n\t\t\t\t}\n\t\t\t\trefresh && self.set(value);\n\t\t\t}\n\t\t}\n\n\t\tcontainer.find('.ui-dropdowncheckbox-item').each(function() {\n\t\t\tvar el = $(this);\n\t\t\tvar index = +el.attrd('index');\n\t\t\tvar checked = false;\n\t\t\tif (!value || !value.length)\n\t\t\t\tchecked = false;\n\t\t\telse if (data[index])\n\t\t\t\tchecked = data[index];\n\t\t\tchecked && (checked = value.indexOf(checked.value) !== -1);\n\t\t\tel.tclass('ui-dropdowncheckbox-checked', checked);\n\t\t});\n\n\t\tif (!label && value && config.cleaner !== false) {\n\t\t\t// invalid data\n\t\t\t// it updates model without notification\n\t\t\tself.rewrite([]);\n\t\t}\n\n\t\tif (!label && config.placeholder) {\n\t\t\tvalues.rattr('title', '');\n\t\t\tvalues.html('<span>{0}</span>'.format(config.placeholder));\n\t\t} else {\n\t\t\tif (count == data.length && config.alltext !== 'null' && config.alltext)\n\t\t\t\tlabel = config.alltext;\n\t\t\telse if (config.visible && count > config.visible)\n\t\t\t\tlabel = config.selectedtext.format(count, data.length);\n\t\t\tvalues.attr('title', label);\n\t\t\tvalues.html(label);\n\t\t}\n\t};\n\n\tself.state = function(type) {\n\t\tif (!type)\n\t\t\treturn;\n\t\tvar invalid = config.required ? self.isInvalid() : false;\n\t\tif (invalid === self.$oldstate)\n\t\t\treturn;\n\t\tself.$oldstate = invalid;\n\t\tself.tclass('ui-dropdowncheckbox-invalid', invalid);\n\t};\n\n\tif (W.$dropdowncheckboxevent)\n\t\treturn;\n\n\tW.$dropdowncheckboxevent = true;\n\t$(document).on('click', function() {\n\t\tif (W.$dropdowncheckboxelement) {\n\t\t\tW.$dropdowncheckboxelement.aclass('hidden');\n\t\t\tW.$dropdowncheckboxelement = null;\n\t\t}\n\t});\n});\n\nCOMPONENT('snackbar', 'timeout:3000;button:Dismiss', function(self, config) {\n\n\tvar show = true;\n\tvar callback;\n\n\tself.readonly();\n\tself.blind();\n\tself.nocompile();\n\n\tself.make = function() {\n\t\tself.aclass('ui-snackbar hidden');\n\t\tself.append('<div><a href=\"javasc' + 'ript:void(0)\" class=\"ui-snackbar-dismiss\"></a><div class=\"ui-snackbar-body\"></div></div>');\n\t\tself.event('click', '.ui-snackbar-dismiss', function() {\n\t\t\tself.hide();\n\t\t\tcallback && callback();\n\t\t});\n\t};\n\n\tself.hide = function() {\n\t\tself.rclass('ui-snackbar-visible');\n\t\tsetTimeout(function() {\n\t\t\tself.aclass('hidden');\n\t\t}, 1000);\n\t\tshow = true;\n\t};\n\n\tself.success = function(message, button, close) {\n\t\tself.show('<i class=\"fa fa-check-circle ui-snackbar-icon\"></i>' + message, button, close);\n\t};\n\n\tself.warning = function(message, button, close) {\n\t\tself.show('<i class=\"fa fa-times-circle ui-snackbar-icon\"></i>' + message, button, close);\n\t};\n\n\tself.show = function(message, button, close) {\n\n\t\tif (typeof(button) === 'function') {\n\t\t\tclose = button;\n\t\t\tbutton = null;\n\t\t}\n\n\t\tcallback = close;\n\n\t\tself.find('.ui-snackbar-body').html(message);\n\t\tself.find('.ui-snackbar-dismiss').html(button || config.button);\n\n\t\tif (show) {\n\t\t\tself.rclass('hidden');\n\t\t\tsetTimeout(function() {\n\t\t\t\tself.aclass('ui-snackbar-visible');\n\t\t\t}, 50);\n\t\t}\n\n\t\tsetTimeout2(self.ID, self.hide, config.timeout + 50);\n\t\tshow = false;\n\t};\n});\n\nCOMPONENT('repeater', 'hidden:true;check:true', function(self, config) {\n\n\tvar filter = null;\n\tvar recompile = false;\n\tvar reg = /\\$(index|path)/g;\n\n\tself.readonly();\n\n\tself.configure = function(key, value) {\n\t\tif (key === 'filter')\n\t\t\tfilter = value ? GET(value) : null;\n\t};\n\n\tself.make = function() {\n\t\tvar element = self.find('script');\n\t\tif (!element.length) {\n\t\t\telement = self.element;\n\t\t\tself.element = self.element.parent();\n\t\t}\n\n\t\tvar html = element.html();\n\t\telement.remove();\n\t\tself.template = Tangular.compile(html);\n\t\trecompile = (/data-jc=\"|data-bind=\"/).test(html);\n\t};\n\n\tself.setter = function(value) {\n\n\t\tif (!value || !value.length) {\n\t\t\tconfig.hidden && self.aclass('hidden');\n\t\t\tself.empty();\n\t\t\tself.cache = '';\n\t\t\treturn;\n\t\t}\n\n\t\tvar builder = [];\n\t\tfor (var i = 0, length = value.length; i < length; i++) {\n\t\t\tvar item = value[i];\n\t\t\titem.index = i;\n\t\t\tif (!filter || filter(item)) {\n\t\t\t\tbuilder.push(self.template(item).replace(reg, function(text) {\n\t\t\t\t\treturn text.substring(0, 2) === '$i' ? i.toString() : self.path + '[' + i + ']';\n\t\t\t\t}));\n\t\t\t}\n\t\t}\n\n\t\tvar tmp = builder.join('');\n\n\t\tif (config.check) {\n\t\t\tif (tmp === self.cache)\n\t\t\t\treturn;\n\t\t\tself.cache = tmp;\n\t\t}\n\n\t\tself.html(tmp);\n\t\tconfig.hidden && self.rclass('hidden');\n\t\trecompile && self.compile();\n\t};\n});\n\nCOMPONENT('confirm', function(self) {\n\n\tvar is, visible = false;\n\n\tself.readonly();\n\tself.singleton();\n\tself.nocompile();\n\n\tself.make = function() {\n\n\t\tself.aclass('ui-confirm hidden');\n\n\t\tself.event('click', 'button', function() {\n\t\t\tself.hide($(this).attrd('index').parseInt());\n\t\t});\n\n\t\tself.event('click', function(e) {\n\t\t\tvar t = e.target.tagName;\n\t\t\tif (t !== 'DIV')\n\t\t\t\treturn;\n\t\t\tvar el = self.find('.ui-confirm-body');\n\t\t\tel.aclass('ui-confirm-click');\n\t\t\tsetTimeout(function() {\n\t\t\t\tel.rclass('ui-confirm-click');\n\t\t\t}, 300);\n\t\t});\n\n\t\t$(window).on('keydown', function(e) {\n\t\t\tif (!visible)\n\t\t\t\treturn;\n\t\t\tvar index = e.which === 13 ? 0 : e.which === 27 ? 1 : null;\n\t\t\tif (index != null) {\n\t\t\t\tself.find('button[data-index=\"{0}\"]'.format(index)).trigger('click');\n\t\t\t\te.preventDefault();\n\t\t\t\te.stopPropagation();\n\t\t\t}\n\t\t});\n\t};\n\n\tself.show = self.confirm = function(message, buttons, fn) {\n\t\tself.callback = fn;\n\n\t\tvar builder = [];\n\n\t\tfor (var i = 0; i < buttons.length; i++) {\n\t\t\tvar item = buttons[i];\n\t\t\tvar icon = item.match(/\"[a-z0-9-]+\"/);\n\t\t\tif (icon) {\n\t\t\t\titem = item.replace(icon, '').trim();\n\t\t\t\ticon = '<i class=\"fa fa-{0}\"></i>'.format(icon.toString().replace(/\"/g, ''));\n\t\t\t} else\n\t\t\t\ticon = '';\n\t\t\tbuilder.push('<button data-index=\"{1}\">{2}{0}</button>'.format(item, i, icon));\n\t\t}\n\n\t\tself.content('ui-confirm-warning', '<div class=\"ui-confirm-message\">{0}</div>{1}'.format(message.replace(/\\n/g, '<br />'), builder.join('')));\n\t};\n\n\tself.hide = function(index) {\n\t\tself.callback && self.callback(index);\n\t\tself.rclass('ui-confirm-visible');\n\t\tvisible = false;\n\t\tsetTimeout2(self.id, function() {\n\t\t\t$('html').rclass('ui-confirm-noscroll');\n\t\t\tself.aclass('hidden');\n\t\t}, 1000);\n\t};\n\n\tself.content = function(cls, text) {\n\t\t$('html').aclass('ui-confirm-noscroll');\n\t\t!is && self.html('<div><div class=\"ui-confirm-body\"></div></div>');\n\t\tself.find('.ui-confirm-body').empty().append(text);\n\t\tself.rclass('hidden');\n\t\tvisible = true;\n\t\tsetTimeout2(self.id, function() {\n\t\t\tself.aclass('ui-confirm-visible');\n\t\t}, 5);\n\t};\n});\n\nCOMPONENT('crop', 'dragdrop:true;format:{0}', function(self, config) {\n\n\tvar canvas, context;\n\tvar img = new Image();\n\tvar can = false;\n\tvar is = false;\n\tvar zoom = 100;\n\tvar current = { x: 0, y: 0 };\n\tvar offset = { x: 0, y: 0 };\n\tvar cache = { x: 0, y: 0, zoom: 0 };\n\tvar width = 0;\n\tvar samesize = '';\n\n\tself.bindvisible();\n\tself.novalidate();\n\tself.nocompile && self.nocompile();\n\tself.getter = null;\n\n\timg.crossOrigin = 'anonymous';\n\timg.onload = function () {\n\t\tcan = true;\n\t\tzoom = 100;\n\n\t\tvar width = config.width;\n\t\tvar height = config.height;\n\n\t\tsamesize = img.width === width && img.height === height && img.src.substring(0, 5) !== 'data:' ? $(img).attr('src') : '';\n\n\t\tvar nw = (img.width / 2);\n\t\tvar nh = (img.height / 2);\n\n\t\tif (img.width > width) {\n\t\t\tvar p = (width / (img.width / 100));\n\t\t\tzoom -= zoom - p;\n\t\t\tnh = ((img.height * (p / 100)) / 2);\n\t\t\tnw = ((img.width * (p / 100)) / 2);\n\t\t}\n\n\t\t// centering\n\t\tcache.x = current.x = (width / 2) - nw;\n\t\tcache.y = current.y = (height / 2) - nh;\n\t\tcache.zoom = zoom;\n\t\tself.redraw();\n\t};\n\n\tself.configure = function(key, value, init) {\n\t\tif (init)\n\t\t\treturn;\n\t\tswitch (key) {\n\t\t\tcase 'width':\n\t\t\tcase 'height':\n\t\t\t\tcache.x = current.x = cache.y = current.y = 0;\n\t\t\t\tsetTimeout2(self._id + 'resize', self.redraw, 50);\n\t\t\t\tbreak;\n\t\t}\n\t};\n\n\tself.output = function(type) {\n\t\tvar canvas2 = document.createElement('canvas');\n\t\tvar ctx2 = canvas2.getContext('2d');\n\n\t\tcanvas2.width = config.width;\n\t\tcanvas2.height = config.height;\n\n\t\tctx2.clearRect(0, 0, canvas2.width, canvas2.height);\n\n\t\tif (config.background) {\n\t\t\tctx2.fillStyle = config.background;\n\t\t\tctx2.fillRect(0, 0, canvas2.width, canvas2.height);\n\t\t}\n\n\t\tvar w = img.width;\n\t\tvar h = img.height;\n\n\t\tw = ((w / 100) * zoom);\n\t\th = ((h / 100) * zoom);\n\n\t\tctx2.drawImage(img, current.x || 0, current.y || 0, w, h);\n\t\treturn type ? canvas2.toDataURL(type) : !config.background && self.isTransparent(canvas2) ? canvas2.toDataURL('image/png') : canvas2.toDataURL('image/jpeg');\n\t};\n\n\tself.make = function() {\n\n\t\tself.aclass('ui-crop');\n\t\tself.append('<ul><li data-type=\"upload\"><span class=\"fa fa-folder\"></span></li><li data-type=\"plus\"><span class=\"fa fa-plus\"></span></li><li data-type=\"refresh\"><span class=\"fa fa-refresh\"></span></li><li data-type=\"minus\"><span class=\"fa fa-minus\"></span></li></ul><div>0x0</div><canvas width=\"200\" height=\"100\"></canvas>');\n\n\t\tcanvas = self.find('canvas')[0];\n\t\tcontext = canvas.getContext('2d');\n\n\t\tself.event('click', 'li', function(e) {\n\n\t\t\te.preventDefault();\n\t\t\te.stopPropagation();\n\n\t\t\tvar type = $(this).attr('data-type');\n\n\t\t\tswitch (type) {\n\t\t\t\tcase 'upload':\n\t\t\t\t\tcmseditor.instance.filebrowser(img, (/^image\\/*/));\n\t\t\t\t\tself.change(true);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'plus':\n\t\t\t\t\tzoom += 3;\n\t\t\t\t\tif (zoom > 300)\n\t\t\t\t\t\tzoom = 300;\n\t\t\t\t\tcurrent.x -= 3;\n\t\t\t\t\tcurrent.y -= 3;\n\t\t\t\t\tsamesize = '';\n\t\t\t\t\tself.redraw();\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'minus':\n\t\t\t\t\tzoom -= 3;\n\t\t\t\t\tif (zoom < 3)\n\t\t\t\t\t\tzoom = 3;\n\t\t\t\t\tcurrent.x += 3;\n\t\t\t\t\tcurrent.y += 3;\n\t\t\t\t\tsamesize = '';\n\t\t\t\t\tself.redraw();\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'refresh':\n\t\t\t\t\tzoom = cache.zoom;\n\t\t\t\t\tself.redraw();\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t});\n\n\t\tself.find('input').on('change', function() {\n\t\t\tvar file = this.files[0];\n\t\t\tself.load(file);\n\t\t\tthis.value = '';\n\t\t});\n\n\t\t$(canvas).on('mousedown', function (e) {\n\n\t\t\tif (self.disabled || !can)\n\t\t\t\treturn;\n\n\t\t\tis = true;\n\t\t\tvar rect = canvas.getBoundingClientRect();\n\t\t\tvar x = e.clientX - rect.left;\n\t\t\tvar y = e.clientY - rect.top;\n\t\t\toffset.x = x - current.x;\n\t\t\toffset.y = y - current.y;\n\t\t\tsamesize = '';\n\t\t});\n\n\t\tconfig.dragdrop && $(canvas).on('dragenter dragover dragexit drop dragleave', function (e) {\n\n\t\t\tif (self.disabled)\n\t\t\t\treturn;\n\n\t\t\te.stopPropagation();\n\t\t\te.preventDefault();\n\n\t\t\tswitch (e.type) {\n\t\t\t\tcase 'drop':\n\t\t\t\t\tself.rclass('ui-crop-dragdrop');\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'dragenter':\n\t\t\t\tcase 'dragover':\n\t\t\t\t\tself.aclass('ui-crop-dragdrop');\n\t\t\t\t\treturn;\n\t\t\t\tcase 'dragexit':\n\t\t\t\tcase 'dragleave':\n\t\t\t\tdefault:\n\t\t\t\t\tself.rclass('ui-crop-dragdrop');\n\t\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar files = e.originalEvent.dataTransfer.files;\n\t\t\tfiles[0] && self.load(files[0]);\n\t\t});\n\n\t\tself.load = function(file) {\n\t\t\tself.getOrientation(file, function(orient) {\n\t\t\t\tvar reader = new FileReader();\n\t\t\t\treader.onload = function () {\n\t\t\t\t\tif (orient < 2) {\n\t\t\t\t\t\timg.src = reader.result;\n\t\t\t\t\t\tsetTimeout(function() {\n\t\t\t\t\t\t\tself.change(true);\n\t\t\t\t\t\t}, 500);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tSETTER('loading', 'show');\n\t\t\t\t\t\tself.resetOrientation(reader.result, orient, function(url) {\n\t\t\t\t\t\t\tSETTER('loading', 'hide', 500);\n\t\t\t\t\t\t\timg.src = url;\n\t\t\t\t\t\t\tself.change(true);\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t\treader.readAsDataURL(file);\n\t\t\t});\n\t\t};\n\n\t\tself.event('mousemove mouseup', function (e) {\n\n\t\t\tif (e.type === 'mouseup') {\n\t\t\t\tis && self.change();\n\t\t\t\tis = false;\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (self.disabled || !can || !is)\n\t\t\t\treturn;\n\n\t\t\tvar rect = canvas.getBoundingClientRect();\n\t\t\tvar x = e.clientX - rect.left;\n\t\t\tvar y = e.clientY - rect.top;\n\t\t\tcurrent.x = x - offset.x;\n\t\t\tcurrent.y = y - offset.y;\n\t\t\tsamesize = '';\n\t\t\tself.redraw();\n\t\t});\n\t};\n\n\tself.redraw = function() {\n\n\t\tvar ratio = width < config.width ? width / config.width : 1;\n\n\t\tcanvas.width = width < config.width ? width : config.width;\n\t\tcanvas.height = width < config.width ? (config.height / config.width) * width : config.height;\n\n\t\tvar w = img.width;\n\t\tvar h = img.height;\n\n\t\tw = ((w / 100) * zoom);\n\t\th = ((h / 100) * zoom);\n\n\t\tcontext.clearRect(0, 0, canvas.width, canvas.height);\n\n\t\tif (config.background) {\n\t\t\tcontext.fillStyle = config.background;\n\t\t\tcontext.fillRect(0, 0, canvas.width, canvas.height);\n\t\t}\n\n\t\tself.find('div').html(config.width + 'x' + config.height);\n\t\tcontext.drawImage(img, (current.x || 0) * ratio, (current.y || 0) * ratio, w * ratio, h * ratio);\n\t};\n\n\tself.setter = function(value) {\n\t\tself.filename = '';\n\t\tself.width(function(w) {\n\t\t\twidth = w;\n\t\t\tif (value)\n\t\t\t\timg.src = config.format.format(value);\n\t\t\telse\n\t\t\t\tself.redraw();\n\t\t});\n\t};\n\n\tself.getUrl = function() {\n\t\treturn samesize;\n\t};\n\n\tself.isTransparent = function(canvas) {\n\t\tvar id = canvas.getContext('2d').getImageData(0, 0, canvas.width, canvas.height);\n\t\tfor (var i = 0, length = id.data.length; i < length; i += 4) {\n\t\t\tif (id.data[i + 3] !== 255)\n\t\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t};\n\n\t// http://stackoverflow.com/a/32490603\n\tself.getOrientation = function(file, callback) {\n\t\tvar reader = new FileReader();\n\t\treader.onload = function(e) {\n\t\t\tvar view = new DataView(e.target.result);\n\t\t\tif (view.getUint16(0, false) != 0xFFD8)\n\t\t\t\treturn callback(-2);\n\t\t\tvar length = view.byteLength;\n\t\t\tvar offset = 2;\n\t\t\twhile (offset < length) {\n\t\t\t\tvar marker = view.getUint16(offset, false);\n\t\t\t\toffset += 2;\n\t\t\t\tif (marker == 0xFFE1) {\n\t\t\t\t\tif (view.getUint32(offset += 2, false) != 0x45786966)\n\t\t\t\t\t\treturn callback(-1);\n\t\t\t\t\tvar little = view.getUint16(offset += 6, false) == 0x4949;\n\t\t\t\t\toffset += view.getUint32(offset + 4, little);\n\t\t\t\t\tvar tags = view.getUint16(offset, little);\n\t\t\t\t\toffset += 2;\n\t\t\t\t\tfor (var i = 0; i < tags; i++)\n\t\t\t\t\t\tif (view.getUint16(offset + (i * 12), little) == 0x0112)\n\t\t\t\t\t\t\treturn callback(view.getUint16(offset + (i * 12) + 8, little));\n\t\t\t\t} else if ((marker & 0xFF00) != 0xFF00)\n\t\t\t\t\tbreak;\n\t\t\t\telse\n\t\t\t\t\toffset += view.getUint16(offset, false);\n\t\t\t}\n\t\t\treturn callback(-1);\n\t\t};\n\t\treader.readAsArrayBuffer(file.slice(0, 64 * 1024));\n\t};\n\n\tself.resetOrientation = function(src, srcOrientation, callback) {\n\t\tvar img = new Image();\n\t\timg.onload = function() {\n\t\t\tvar width = img.width;\n\t\t\tvar height = img.height;\n\t\t\tvar canvas = document.createElement('canvas');\n\t\t\tvar ctx = canvas.getContext('2d');\n\n\t\t\t// set proper canvas dimensions before transform & export\n\t\t\tif (4 < srcOrientation && srcOrientation < 9) {\n\t\t\t\tcanvas.width = height;\n\t\t\t\tcanvas.height = width;\n\t\t\t} else {\n\t\t\t\tcanvas.width = width;\n\t\t\t\tcanvas.height = height;\n\t\t\t}\n\t\t\tswitch (srcOrientation) {\n\t\t\t\tcase 2: ctx.transform(-1, 0, 0, 1, width, 0); break;\n\t\t\t\tcase 3: ctx.transform(-1, 0, 0, -1, width, height); break;\n\t\t\t\tcase 4: ctx.transform(1, 0, 0, -1, 0, height); break;\n\t\t\t\tcase 5: ctx.transform(0, 1, 1, 0, 0, 0); break;\n\t\t\t\tcase 6: ctx.transform(0, 1, -1, 0, height, 0); break;\n\t\t\t\tcase 7: ctx.transform(0, -1, -1, 0, height, width); break;\n\t\t\t\tcase 8: ctx.transform(0, -1, 1, 0, 0, width); break;\n\t\t\t}\n\t\t\tctx.drawImage(img, 0, 0);\n\t\t\tcallback(canvas.toDataURL());\n\t\t};\n\t\timg.src = src;\n\t};\n});\n\nCOMPONENT('fontawesomebox', 'height:300', function(self, config) {\n\n\tvar container, input, icon, prev;\n\tvar template = '<li data-search=\"{0}\"><i class=\"{1}\"></i></li>';\n\tvar skip = false;\n\tvar refresh = false;\n\n\tself.init = function() {\n\t\tW.fontawesomeicons = 'address-book,address-card,adjust,align-center,align-justify,align-left,align-right,allergies,ambulance,american-sign-language-interpreting,anchor,angle-double-down,angle-double-left,angle-double-right,angle-double-up,angle-down,angle-left,angle-right,angle-up,archive,arrow-alt-circle-down,arrow-alt-circle-left,arrow-alt-circle-right,arrow-alt-circle-up,arrow-circle-down,arrow-circle-left,arrow-circle-right,arrow-circle-up,arrow-down,arrow-left,arrow-right,arrow-up,arrows-alt,arrows-alt-h,arrows-alt-v,assistive-listening-systems,asterisk,at,audio-description,backward,balance-scale,ban,band-aid,barcode,bars,baseball-ball,basketball-ball,bath,battery-empty,battery-full,battery-half,battery-quarter,battery-three-quarters,bed,beer,bell,bell-slash,bicycle,binoculars,birthday-cake,blender,blind,bold,bolt,bomb,book,book-open,bookmark,bowling-ball,box,box-open,boxes,braille,briefcase,briefcase-medical,broadcast-tower,broom,bug,building,bullhorn,bullseye,burn,bus,calculator,calendar,calendar-alt,calendar-check,calendar-minus,calendar-plus,calendar-times,camera,camera-retro,capsules,car,caret-down,caret-left,caret-right,caret-square-down,caret-square-left,caret-square-right,caret-square-up,caret-up,cart-arrow-down,cart-plus,certificate,chalkboard,chalkboard-teacher,chart-area,chart-bar,chart-line,chart-pie,check,check-circle,check-square,chess,chess-bishop,chess-board,chess-king,chess-knight,chess-pawn,chess-queen,chess-rook,chevron-circle-down,chevron-circle-left,chevron-circle-right,chevron-circle-up,chevron-down,chevron-left,chevron-right,chevron-up,child,church,circle,circle-notch,clipboard,clipboard-check,clipboard-list,clock,clone,closed-captioning,cloud,cloud-download-alt,cloud-upload-alt,code,code-branch,coffee,cog,cogs,coins,columns,comment,comment-alt,comment-dots,comment-slash,comments,compact-disc,compass,compress,copy,copyright,couch,credit-card,crop,crosshairs,crow,crown,cube,cubes,cut,database,deaf,desktop,diagnoses,dice,dice-five,dice-four,dice-one,dice-six,dice-three,dice-two,divide,dna,dollar-sign,dolly,dolly-flatbed,donate,door-closed,door-open,dot-circle,dove,download,dumbbell,edit,eject,ellipsis-h,ellipsis-v,envelope,envelope-open,envelope-square,equals,eraser,euro-sign,exchange-alt,exclamation,exclamation-circle,exclamation-triangle,expand,expand-arrows-alt,external-link-alt,external-link-square-alt,eye,eye-dropper,eye-slash,fast-backward,fast-forward,fax,feather,female,fighter-jet,file,file-alt,file-archive,file-audio,file-code,file-excel,file-image,file-medical,file-medical-alt,file-pdf,file-powerpoint,file-video,file-word,film,filter,fire,fire-extinguisher,first-aid,flag,flag-checkered,flask,folder,folder-open,font,football-ball,forward,frog,frown,futbol,gamepad,gas-pump,gavel,gem,genderless,gift,glass-martini,glasses,globe,golf-ball,graduation-cap,greater-than,greater-than-equal,h-square,hand-holding,hand-holding-heart,hand-holding-usd,hand-lizard,hand-paper,hand-peace,hand-point-down,hand-point-left,hand-point-right,hand-point-up,hand-pointer,hand-rock,hand-scissors,hand-spock,hands,hands-helping,handshake,hashtag,hdd,heading,headphones,heart,heartbeat,helicopter,history,hockey-puck,home,hospital,hospital-alt,hospital-symbol,hourglass,hourglass-end,hourglass-half,hourglass-start,i-cursor,id-badge,id-card,id-card-alt,image,images,inbox,indent,industry,infinity,info,info-circle,italic,key,keyboard,kiwi-bird,language,laptop,leaf,lemon,less-than,less-than-equal,level-down-alt,level-up-alt,life-ring,lightbulb,link,lira-sign,list,list-alt,list-ol,list-ul,location-arrow,lock,lock-open,long-arrow-alt-down,long-arrow-alt-left,long-arrow-alt-right,long-arrow-alt-up,low-vision,magic,magnet,male,map,map-marker,map-marker-alt,map-pin,map-signs,mars,mars-double,mars-stroke,mars-stroke-h,mars-stroke-v,medkit,meh,memory,mercury,microchip,microphone,microphone-alt,microphone-alt-slash,microphone-slash,minus,minus-circle,minus-square,mobile,mobile-alt,money-bill,money-bill-alt,money-bill-wave,money-bill-wave-alt,money-check,money-check-alt,moon,motorcycle,mouse-pointer,music,neuter,newspaper,not-equal,notes-medical,object-group,object-ungroup,outdent,paint-brush,palette,pallet,paper-plane,paperclip,parachute-box,paragraph,parking,paste,pause,pause-circle,paw,pen-square,pencil-alt,people-carry,percent,percentage,phone,phone-slash,phone-square,phone-volume,piggy-bank,pills,plane,play,play-circle,plug,plus,plus-circle,plus-square,podcast,poo,portrait,pound-sign,power-off,prescription-bottle,prescription-bottle-alt,print,procedures,project-diagram,puzzle-piece,qrcode,question,question-circle,quidditch,quote-left,quote-right,random,receipt,recycle,redo,redo-alt,registered,reply,reply-all,retweet,ribbon,road,robot,rocket,rss,rss-square,ruble-sign,ruler,ruler-combined,ruler-horizontal,ruler-vertical,rupee-sign,save,school,screwdriver,search,search-minus,search-plus,seedling,server,share,share-alt,share-alt-square,share-square,shekel-sign,shield-alt,ship,shipping-fast,shoe-prints,shopping-bag,shopping-basket,shopping-cart,shower,sign,sign-in-alt,sign-language,sign-out-alt,signal,sitemap,skull,sliders-h,smile,smoking,smoking-ban,snowflake,sort,sort-alpha-down,sort-alpha-up,sort-amount-down,sort-amount-up,sort-down,sort-numeric-down,sort-numeric-up,sort-up,space-shuttle,spinner,square,square-full,star,star-half,step-backward,step-forward,stethoscope,sticky-note,stop,stop-circle,stopwatch,store,store-alt,stream,street-view,strikethrough,stroopwafel,subscript,subway,suitcase,sun,superscript,sync,sync-alt,syringe,table,table-tennis,tablet,tablet-alt,tablets,tachometer-alt,tag,tags,tape,tasks,taxi,terminal,text-height,text-width,th,th-large,th-list,thermometer,thermometer-empty,thermometer-full,thermometer-half,thermometer-quarter,thermometer-three-quarters,thumbs-down,thumbs-up,thumbtack,ticket-alt,times,times-circle,tint,toggle-off,toggle-on,toolbox,trademark,train,transgender,transgender-alt,trash,trash-alt,tree,trophy,truck,truck-loading,truck-moving,tshirt,tty,tv,umbrella,underline,undo,undo-alt,universal-access,university,unlink,unlock,unlock-alt,upload,user,user-alt,user-alt-slash,user-astronaut,user-check,user-circle,user-clock,user-cog,user-edit,user-friends,user-graduate,user-lock,user-md,user-minus,user-ninja,user-plus,user-secret,user-shield,user-slash,user-tag,user-tie,user-times,users,users-cog,utensil-spoon,utensils,venus,venus-double,venus-mars,vial,vials,video,video-slash,volleyball-ball,volume-down,volume-off,volume-up,walking,wallet,warehouse,weight,wheelchair,wifi,window-close,window-maximize,window-minimize,window-restore,wine-glass,won-sign,wrench,x-ray,yen-sign,fab 500px,fab accessible-icon,fab accusoft,fab acquisitions-incorporated,fab adn,fab adversal,fab affiliatetheme,fab algolia,fab alipay,fab amazon,fab amazon-pay,fab amilia,fab android,fab angellist,fab angrycreative,fab angular,fab app-store,fab app-store-ios,fab apper,fab apple,fab apple-pay,fab asymmetrik,fab audible,fab autoprefixer,fab avianex,fab aviato,fab aws,fab bandcamp,fab behance,fab behance-square,fab bimobject,fab bitbucket,fab bitcoin,fab bity,fab black-tie,fab blackberry,fab blogger,fab blogger-b,fab bluetooth,fab bluetooth-b,fab btc,fab buromobelexperte,fab buysellads,fab cc-amazon-pay,fab cc-amex,fab cc-apple-pay,fab cc-diners-club,fab cc-discover,fab cc-jcb,fab cc-mastercard,fab cc-paypal,fab cc-stripe,fab cc-visa,fab centercode,fab chrome,fab cloudscale,fab cloudsmith,fab cloudversify,fab codepen,fab codiepie,fab connectdevelop,fab contao,fab cpanel,fab creative-commons,fab creative-commons-by,fab creative-commons-nc,fab creative-commons-nc-eu,fab creative-commons-nc-jp,fab creative-commons-nd,fab creative-commons-pd,fab creative-commons-pd-alt,fab creative-commons-remix,fab creative-commons-sa,fab creative-commons-sampling,fab creative-commons-sampling-plus,fab creative-commons-share,fab css3,fab css3-alt,fab cuttlefish,fab d-and-d,fab dashcube,fab delicious,fab deploydog,fab deskpro,fab deviantart,fab digg,fab digital-ocean,fab discord,fab discourse,fab dochub,fab docker,fab draft2digital,fab dribbble,fab dribbble-square,fab dropbox,fab drupal,fab dyalog,fab earlybirds,fab ebay,fab edge,fab elementor,fab ello,fab ember,fab empire,fab envira,fab erlang,fab ethereum,fab etsy,fab expeditedssl,fab facebook,fab facebook-f,fab facebook-messenger,fab facebook-square,fab firefox,fab first-order,fab first-order-alt,fab firstdraft,fab flickr,fab flipboard,fab fly,fab font-awesome,fab font-awesome-alt,fab font-awesome-flag,fab fonticons,fab fonticons-fi,fab fort-awesome,fab fort-awesome-alt,fab forumbee,fab foursquare,fab free-code-camp,fab freebsd,fab fulcrum,fab galactic-republic,fab galactic-senate,fab get-pocket,fab gg,fab gg-circle,fab git,fab git-square,fab github,fab github-alt,fab github-square,fab gitkraken,fab gitlab,fab gitter,fab glide,fab glide-g,fab gofore,fab goodreads,fab goodreads-g,fab google,fab google-drive,fab google-play,fab google-plus,fab google-plus-g,fab google-plus-square,fab google-wallet,fab gratipay,fab grav,fab gripfire,fab grunt,fab gulp,fab hacker-news,fab hacker-news-square,fab hackerrank,fab hips,fab hire-a-helper,fab hooli,fab hornbill,fab hotjar,fab houzz,fab html5,fab hubspot,fab imdb,fab instagram,fab internet-explorer,fab ioxhost,fab itunes,fab itunes-note,fab java,fab jedi-order,fab jenkins,fab joget,fab joomla,fab js,fab js-square,fab jsfiddle,fab kaggle,fab keybase,fab keycdn,fab kickstarter,fab kickstarter-k,fab korvue,fab laravel,fab lastfm,fab lastfm-square,fab leanpub,fab less,fab line,fab linkedin,fab linkedin-in,fab linode,fab linux,fab lyft,fab magento,fab mailchimp,fab mandalorian,fab markdown,fab mastodon,fab maxcdn,fab medapps,fab medium,fab medium-m,fab medrt,fab meetup,fab megaport,fab microsoft,fab mix,fab mixcloud,fab mizuni,fab modx,fab monero,fab napster,fab neos,fab nimblr,fab nintendo-switch,fab node,fab node-js,fab npm,fab ns8,fab nutritionix,fab odnoklassniki,fab odnoklassniki-square,fab old-republic,fab opencart,fab openid,fab opera,fab optin-monster,fab osi,fab page4,fab pagelines,fab palfed,fab patreon,fab paypal,fab periscope,fab phabricator,fab phoenix-framework,fab phoenix-squadron,fab php,fab pied-piper,fab pied-piper-alt,fab pied-piper-hat,fab pied-piper-pp,fab pinterest,fab pinterest-p,fab pinterest-square,fab playstation,fab product-hunt,fab pushed,fab python,fab qq,fab quinscape,fab quora,fab r-project,fab ravelry,fab react,fab readme,fab rebel,fab red-river,fab reddit,fab reddit-alien,fab reddit-square,fab renren,fab replyd,fab researchgate,fab resolving,fab rev,fab rocketchat,fab rockrms,fab safari,fab sass,fab schlix,fab scribd,fab searchengin,fab sellcast,fab sellsy,fab servicestack,fab shirtsinbulk,fab shopware,fab simplybuilt,fab sistrix,fab sith,fab skyatlas,fab skype,fab slack,fab slack-hash,fab slideshare,fab snapchat,fab snapchat-ghost,fab snapchat-square,fab soundcloud,fab speakap,fab spotify,fab squarespace,fab stack-exchange,fab stack-overflow,fab staylinked,fab steam,fab steam-square,fab steam-symbol,fab sticker-mule,fab strava,fab stripe,fab stripe-s,fab studiovinari,fab stumbleupon,fab stumbleupon-circle,fab superpowers,fab supple,fab teamspeak,fab telegram,fab telegram-plane,fab tencent-weibo,fab the-red-yeti,fab themeco,fab themeisle,fab trade-federation,fab trello,fab tripadvisor,fab tumblr,fab tumblr-square,fab twitch,fab twitter,fab twitter-square,fab typo3,fab uber,fab uikit,fab uniregistry,fab untappd,fab usb,fab ussunnah,fab vaadin,fab viacoin,fab viadeo,fab viadeo-square,fab viber,fab vimeo,fab vimeo-square,fab vimeo-v,fab vine,fab vk,fab vnv,fab vuejs,fab weebly,fab weibo,fab weixin,fab whatsapp,fab whatsapp-square,fab whmcs,fab wikipedia-w,fab windows,fab wix,fab wolf-pack-battalion,fab wordpress,fab wordpress-simple,fab wpbeginner,fab wpexplorer,fab wpforms,fab xbox,fab xing,fab xing-square,fab y-combinator,fab yahoo,fab yandex,fab yandex-international,fab yelp,fab yoast,fab youtube,fab youtube-square,fab zhihu'.split(',');\n\t};\n\n\tself.readonly();\n\tself.nocompile();\n\n\tself.make = function() {\n\n\t\tself.aclass('ui-fontawesomebox');\n\t\tself.css('height', config.height + 'px');\n\t\tself.append('<div class=\"ui-fontawesomebox-search\"><span><i class=\"fa fa-search clearsearch\"></i></span><div><input type=\"text\" maxlength=\"50\" placeholder=\"{0}\" /></div></div><div class=\"ui-fontawesomebox-search-empty\"></div><div class=\"ui-fontawesomebox-icons\"><ul style=\"height:{1}px\"></ul></div>'.format(config.search, config.height - 40));\n\t\tcontainer = $(self.find('.ui-fontawesomebox-icons').find('ul')[0]);\n\t\tinput = self.find('input');\n\t\ticon = self.find('.ui-fontawesomebox-search').find('i');\n\n\t\tself.event('click', '.clearsearch', function() {\n\t\t\tinput.val('').trigger('keydown');\n\t\t});\n\n\t\tself.event('click', 'li', function() {\n\t\t\tvar el = $(this);\n\t\t\tvar val = '';\n\n\t\t\tif (!el.hclass('selected'))\n\t\t\t\tval = el.find('i').attr('class');\n\n\t\t\tskip = true;\n\t\t\tconfig.exec && EXEC(config.exec, val, self);\n\t\t\tself.set(val);\n\t\t\tself.change(true);\n\t\t});\n\n\t\tself.event('keydown', 'input', function() {\n\t\t\tvar self = this;\n\t\t\tsetTimeout2(self.id, function() {\n\t\t\t\tvar hide = [];\n\t\t\t\tvar show = [];\n\t\t\t\tvar value = self.value.toSearch();\n\t\t\t\tcontainer.find('li').each(function() {\n\t\t\t\t\tif (value && this.getAttribute('data-search').toSearch().indexOf(value) === -1)\n\t\t\t\t\t\thide.push(this);\n\t\t\t\t\telse\n\t\t\t\t\t\tshow.push(this);\n\t\t\t\t});\n\t\t\t\t$(hide).aclass('hidden');\n\t\t\t\t$(show).rclass('hidden');\n\t\t\t\ticon.tclass('fa-times', !!value).tclass('fa-search', !value);\n\t\t\t}, 300);\n\t\t});\n\t};\n\n\tself.configure = function (key, value, init) {\n\n\t\tif (init)\n\t\t\treturn;\n\n\t\tswitch (key) {\n\t\t\tcase 'height':\n\t\t\t\tself.css('height', value + 'px');\n\t\t\t\tcontainer.css('height', value - (38) + 'px');\n\t\t\t\tbreak;\n\t\t}\n\t};\n\n\tself.released = function(is) {\n\t\tif (is) {\n\t\t\tcontainer.empty();\n\t\t} else {\n\t\t\tself.render();\n\t\t\trefresh && self.refresh();\n\t\t}\n\t};\n\n\tself.render = function() {\n\t\tvar builder = [];\n\t\tvar icons = W.fontawesomeicons;\n\t\tfor (var i = 0, length = icons.length; i < length; i++) {\n\t\t\tvar icon = icons[i];\n\t\t\tbuilder.push(template.format(icon, icon.indexOf(' ') === -1 ? ('fa fa-' + icon) : icon.replace(' ', ' fa-')));\n\t\t}\n\t\tcontainer.empty();\n\t\tinput.val('').trigger('keydown');\n\t\tcontainer.html(builder.join(''));\n\t};\n\n\tself.setter = function(value) {\n\t\tprev && prev.rclass('selected');\n\t\tif (value) {\n\t\t\tif (value.indexOf('fa-') === -1)\n\t\t\t\tvalue = 'fa-' + value;\n\n\t\t\tvar index = value.indexOf(' ');\n\t\t\tif (index === -1)\n\t\t\t\tvalue = '.' + value;\n\t\t\telse\n\t\t\t\tvalue = '.' + value.substring(index + 1);\n\n\t\t\tvar fa = container.find(value);\n\t\t\tprev = fa.parent().aclass('selected');\n\t\t\tsetTimeout(function() {\n\t\t\t\t!skip && prev.length && prev.rescroll(-40);\n\t\t\t}, 100);\n\t\t}\n\t\tskip = false;\n\t\trefresh = true;\n\t};\n});\n\nCOMPONENT('multioptions', function(self) {\n\n\tvar Tarea = Tangular.compile('<textarea class=\"ui-moi-save ui-moi-value-inputarea\" data-name=\"{{ name }}\"{{ if def }} placeholder=\"{{ def }}\"{{ fi }}{{ if max }} maxlength=\"{{ max }}\"{{ fi }} data-type=\"text\">{{ value }}</textarea>');\n\tvar Tinput = Tangular.compile('<input class=\"ui-moi-value-inputtext ui-moi-save\" data-name=\"{{ name }}\" type=\"text\" value=\"{{ value }}\"{{ if def }} placeholder=\"{{ def }}\"{{ fi }}{{ if max }} maxlength=\"{{ max }}\"{{ fi }} data-type=\"text\" />');\n\tvar Tfile = Tangular.compile('<div class=\"ui-moi-value-inputfile-buttons\"><span class=\"multioptions-operation\" data-name=\"file\"><i class=\"fa fa-folder\"></i></span></div><div class=\"ui-moi-value-inputfile\"><input class=\"ui-moi-save\" data-name=\"{{ name }}\" type=\"text\" value=\"{{ value }}\"{{ if def }} placeholder=\"{{ def }}\"{{ fi }}{{ if max }} maxlength=\"{{ max }}\"{{ fi }} data-type=\"text\" /></div>');\n\tvar Tselect = Tangular.compile('<div class=\"ui-moi-value-select\"><i class=\"fa fa-chevron-down\"></i><select data-name=\"{{ name }}\" class=\"ui-moi-save ui-multioptions-select\">{{ foreach m in values }}<option value=\"{{\u00a0$index }}\"{{ if value === m.value }} selected=\"selected\"{{ fi }}>{{ m.text }}</option>{{ end }}</select></div>');\n\tvar Tnumber = Tangular.compile('<div class=\"ui-moi-value-inputnumber-buttons\"><span class=\"multioptions-operation\" data-type=\"number\" data-step=\"{{ step }}\" data-name=\"plus\" data-max=\"{{ max }}\" data-min=\"{{ min }}\"><i class=\"fa fa-plus\"></i></span><span class=\"multioptions-operation\" data-type=\"number\" data-name=\"minus\" data-step=\"{{ step }}\" data-max=\"{{ max }}\" data-min=\"{{ min }}\"><i class=\"fa fa-minus\"></i></span></div><div class=\"ui-moi-value-inputnumber\"><input data-name=\"{{ name }}\" class=\"ui-moi-save ui-moi-value-numbertext\" type=\"text\" value=\"{{ value }}\"{{ if def }} placeholder=\"{{ def }}\"{{ fi }} data-max=\"{{ max }}\" data-min=\"{{ max }}\" data-type=\"number\" /></div>');\n\tvar Tboolean = Tangular.compile('<div data-name=\"{{ name }}\" data-type=\"boolean\" class=\"ui-moi-save multioptions-operation ui-moi-value-boolean{{ if value }} checked{{ fi }}\"><i class=\"fa fa-check\"></i></div>');\n\tvar Tdate = Tangular.compile('<div class=\"ui-moi-value-inputdate-buttons\"><span class=\"multioptions-operation\" data-type=\"date\" data-name=\"date\"><i class=\"fa fa-calendar\"></i></span></div><div class=\"ui-moi-value-inputdate\"><input class=\"ui-moi-save ui-moi-date\" data-name=\"{{ name }}\" type=\"text\" value=\"{{ value | format(\\'yyyy-MM-dd\\') }}\" placeholder=\"dd.mm.yyyy\" maxlength=\"10\" data-type=\"date\" /></div>');\n\tvar Tcolor = null;\n\tvar skip = false;\n\tvar mapping = null;\n\tvar dep = {};\n\tvar pending = 0;\n\n\tself.getter = null;\n\tself.novalidate();\n\tself.nocompile();\n\n\tself.init = function() {\n\t\twindow.Tmultioptionscolor = Tangular.compile('<div class=\"ui-moi-value-colors ui-moi-save\" data-name=\"{{ name }}\" data-value=\"{{ value }}\">{0}</div>'.format(['#ED5565', '#DA4453', '#FC6E51', '#E9573F', '#FFCE54', '#F6BB42', '#A0D468', '#8CC152', '#48CFAD', '#37BC9B', '#4FC1E9', '#3BAFDA', '#5D9CEC', '#4A89DC', '#AC92EC', '#967ADC', '#EC87C0', '#D770AD', '#F5F7FA', '#E6E9ED', '#CCD1D9', '#AAB2BD', '#656D78', '#434A54', '#000000'].map(function(n) { return '<span data-value=\"{0}\" data-type=\"color\" class=\"multioptions-operation\" style=\"background-color:{0}\"><i class=\"fa fa-check-circle\"></i></span>'.format(n); }).join('')));\n\t};\n\n\tself.form = function() {};\n\n\tself.make = function() {\n\n\t\tTcolor = window.Tmultioptionscolor;\n\t\tself.aclass('ui-multioptions');\n\n\t\tvar el = self.find('script');\n\n\t\tif (el.length) {\n\t\t\tself.remap(el.html());\n\t\t\tel.remove();\n\t\t}\n\n\t\tself.event('click', '.multioptions-operation', function(e) {\n\t\t\tvar el = $(this);\n\t\t\tvar name = el.attrd('name');\n\t\t\tvar type = el.attrd('type');\n\n\t\t\te.stopPropagation();\n\n\t\t\tif (name === 'file') {\n\t\t\t\tel = el.parent().parent().find('input');\n\t\t\t\tcmseditor.instance.filebrowser(function(url) {\n\t\t\t\t\tel.val(url);\n\t\t\t\t\tself.$save();\n\t\t\t\t});\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (type === 'date') {\n\t\t\t\tel = el.parent().parent().find('input');\n\t\t\t\tSETTER('calendar', 'show', el, el.val().parseDate(), function(date) {\n\t\t\t\t\tel.val(date.format('yyyy-MM-dd'));\n\t\t\t\t\tself.$save();\n\t\t\t\t});\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (type === 'color') {\n\t\t\t\tel.parent().find('.selected').rclass('selected');\n\t\t\t\tel.aclass('selected');\n\t\t\t\tself.$save();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (type === 'boolean') {\n\t\t\t\tel.tclass('checked');\n\t\t\t\tself.$save();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (type === 'number') {\n\t\t\t\tvar input = el.parent().parent().find('input');\n\t\t\t\tvar step = (el.attrd('step') || '0').parseInt();\n\t\t\t\tvar min = el.attrd('min');\n\t\t\t\tvar max = el.attrd('max');\n\n\t\t\t\tif (!step)\n\t\t\t\t\tstep = 1;\n\n\t\t\t\tif (min)\n\t\t\t\t\tmin = min.parseInt();\n\n\t\t\t\tif (max)\n\t\t\t\t\tmax = max.parseInt();\n\n\t\t\t\tvar value;\n\n\t\t\t\tif (name === 'plus') {\n\t\t\t\t\tvalue = input.val().parseInt() + step;\n\t\t\t\t\tif (max !== 0 && max && value > max)\n\t\t\t\t\t\tvalue = max;\n\t\t\t\t\tinput.val(value);\n\t\t\t\t} else {\n\t\t\t\t\tvalue = input.val().parseInt() - step;\n\t\t\t\t\tif (min !== 0 && min && value < min)\n\t\t\t\t\t\tvalue = min;\n\t\t\t\t\tinput.val(value);\n\t\t\t\t}\n\t\t\t\tself.$save();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tself.form(type, el.parent().parent().find('input'), name);\n\t\t\treturn;\n\t\t});\n\n\t\tself.event('change', 'select', self.$save);\n\t\tself.event('input', 'input,textarea', self.$save);\n\n\t\tself.event('click', '.ui-moi-date', function(e) {\n\t\t\te.stopPropagation();\n\t\t});\n\n\t\tself.event('focus', '.ui-moi-date', function() {\n\t\t\tvar el = $(this);\n\t\t\tSETTER('calendar', 'toggle', el, el.val().parseDate(), function(date) {\n\t\t\t\tel.val(date.format('yyyy-MM-dd'));\n\t\t\t\tself.$save();\n\t\t\t});\n\t\t});\n\t};\n\n\tself.remap = function(js) {\n\t\tvar fn = new Function('option', js);\n\t\tmapping = {};\n\t\tdep = {};\n\t\tpending = 0;\n\t\tfn(self.mapping);\n\t\tself.redraw();\n\t};\n\n\tself.redraw = function() {\n\n\t\tif (pending > 0) {\n\t\t\tsetTimeout(self.redraw, 500);\n\t\t\treturn;\n\t\t}\n\n\t\tself.refresh();\n\t\tself.change(false);\n\t\tself.$save();\n\t};\n\n\tself.remap2 = function(callback) {\n\t\tmapping = {};\n\t\tdep = {};\n\t\tpending = 0;\n\t\tcallback(self.mapping);\n\t\tself.redraw();\n\t};\n\n\tself.mapping = function(key, label, def, type, max, min, step, validator) {\n\t\tvar T = typeof(type);\n\t\tif (T === 'number') {\n\t\t\tvalidator = step;\n\t\t\tstep = min;\n\t\t\tmin = max;\n\t\t\tmax = type;\n\t\t\ttype = 'number';\n\t\t} else if (!type)\n\t\t\ttype = def instanceof Date ? 'date' : typeof(def);\n\n\t\tvar values, multiline;\n\n\t\tif (type instanceof Array) {\n\n\t\t\tvalues = [];\n\n\t\t\ttype.forEach(function(val) {\n\t\t\t\tvalues.push({ text: val.text === undefined ? val : val.text, value: val.value === undefined ? val : val.value });\n\t\t\t});\n\n\t\t\ttype = 'array';\n\t\t}\n\n\t\tvar external = false;\n\n\t\tif (T === 'string') {\n\t\t\tvar tmp = type.substring(0, 6);\n\t\t\texternal = type.substring(0, 1) === '/' || tmp === 'http:/' || tmp === 'https:';\n\t\t\tif (type.toLowerCase() === 'multiline') {\n\t\t\t\tmultiline = true;\n\t\t\t\ttype = 'string';\n\t\t\t}\n\t\t}\n\n\t\tvar t = (type || '').toLowerCase();\n\t\tswitch (t) {\n\t\t\tcase 'posts':\n\t\t\tcase 'languages':\n\t\t\tcase 'signals':\n\t\t\tcase 'notices':\n\t\t\tcase 'navigations':\n\t\t\t\tvalues = [{ value: '', text: '' }];\n\t\t\t\tvar nav = common.dependencies[t];\n\t\t\t\tfor (var i = 0; i < nav.length; i++) {\n\t\t\t\t\tvar n = nav[i];\n\t\t\t\t\tvalues.push({ value: n.id, text: n.name });\n\t\t\t\t}\n\t\t\t\ttype = 'array';\n\t\t\t\tbreak;\n\n\t\t\tcase 'parts':\n\t\t\t\tvalues = [{ value: '', text: '' }];\n\t\t\t\tvar items = GET('%parts');\n\t\t\t\tfor (var i = 0; i < items.length; i++) {\n\t\t\t\t\tvar n = items[i];\n\t\t\t\t\tvalues.push({ value: n.id, text: n.name });\n\t\t\t\t}\n\t\t\t\ttype = 'array';\n\t\t\t\tbreak;\n\n\t\t\tcase 'inlineparts':\n\t\t\t\tvalues = [{ value: '', text: '' }];\n\t\t\t\tvar items = GET('%parts');\n\t\t\t\tfor (var i = 0; i < items.length; i++) {\n\t\t\t\t\tvar n = items[i];\n\t\t\t\t\tif (n.category === 'Inline' || n.category === 'Custom')\n\t\t\t\t\t\tvalues.push({ value: n.id, text: n.name });\n\t\t\t\t}\n\t\t\t\ttype = 'array';\n\t\t\t\tbreak;\n\n\t\t\tcase 'newsletterparts':\n\t\t\t\tvalues = [{ value: '', text: '' }];\n\t\t\t\tvar items = GET('%parts');\n\t\t\t\tfor (var i = 0; i < items.length; i++) {\n\t\t\t\t\tvar n = items[i];\n\t\t\t\t\tif (n.category === 'Newsletter' || n.category === 'Custom')\n\t\t\t\t\t\tvalues.push({ value: n.id, text: n.name });\n\t\t\t\t}\n\t\t\t\ttype = 'array';\n\t\t\t\tbreak;\n\n\t\t\tcase 'contentparts':\n\t\t\tcase 'columnsparts':\n\t\t\t\tvalues = [{ value: '', text: '' }];\n\t\t\t\tvar items = GET('%parts');\n\t\t\t\tfor (var i = 0; i < items.length; i++) {\n\t\t\t\t\tvar n = items[i];\n\t\t\t\t\tif (n.category === 'Content' || n.category === 'Columns' || n.category === 'Custom')\n\t\t\t\t\t\tvalues.push({ value: n.id, text: n.name });\n\t\t\t\t}\n\t\t\t\ttype = 'array';\n\t\t\t\tbreak;\n\n\t\t\tcase 'layoutsparts':\n\t\t\t\tvalues = [{ value: '', text: '' }];\n\t\t\t\tvar items = GET('%parts');\n\t\t\t\tfor (var i = 0; i < items.length; i++) {\n\t\t\t\t\tvar n = items[i];\n\t\t\t\t\tif (n.category === 'Layouts' || n.category === 'Custom')\n\t\t\t\t\t\tvalues.push({ value: n.id, text: n.name });\n\t\t\t\t}\n\t\t\t\ttype = 'array';\n\t\t\t\tbreak;\n\n\t\t\tcase 'partial':\n\t\t\t\tvalues = [{ value: '', text: '' }];\n\t\t\t\tvar pages = GET('pages.grid.items');\n\t\t\t\tif (pages && pages.length) {\n\t\t\t\t\tfor (var i = 0, length = pages.length; i < length; i++) {\n\t\t\t\t\t\tvar p = pages[i];\n\t\t\t\t\t\tp.ispartial && values.push({ value: p.id, text: p.name });\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\ttype = 'array';\n\t\t\t\tbreak;\n\t\t}\n\n\t\tif (validator && typeof(validator) !== 'function')\n\t\t\tvalidator = null;\n\n\t\tvar bindmapping = function(values) {\n\t\t\tdep[key] = values;\n\t\t\tmapping[key] = { name: key, label: label, type: external ? 'array' : type.toLowerCase(), def: def, max: max, min: min, step: step, value: def, values: values, validator: validator, multiline: multiline };\n\t\t};\n\n\t\tif (external) {\n\t\t\tpending++;\n\t\t\tAJAX('GET ' + type, function(values) {\n\t\t\t\tpending--;\n\t\t\t\tbindmapping(values);\n\t\t\t});\n\t\t} else\n\t\t\tbindmapping(values);\n\t};\n\n\tself.dependencies = function() {\n\t\treturn dep;\n\t};\n\n\tself.$save = function() {\n\t\tsetTimeout2('multioptions.' + self._id, self.save, 150);\n\t};\n\n\tself.save = function() {\n\t\tvar obj = self.get();\n\t\tvar values = self.find('.ui-moi-save');\n\n\t\tObject.keys(mapping).forEach(function(key) {\n\n\t\t\tvar opt = mapping[key];\n\t\t\tvar el = values.filter('[data-name=\"{0}\"]'.format(opt.name));\n\n\t\t\tif (el.hclass('ui-moi-value-colors')) {\n\t\t\t\tobj[key] = el.find('.selected').attrd('value');\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (el.hclass('ui-moi-value-boolean')) {\n\t\t\t\tobj[key] = el.hclass('checked');\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (el.hclass('ui-moi-date')) {\n\t\t\t\tobj[key] = el.val().parseDate();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (el.hclass('ui-moi-value-inputtext') || el.hclass('ui-moi-value-inputarea')) {\n\t\t\t\tobj[key] = el.val();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (opt.type === 'file') {\n\t\t\t\tobj[key] = el.val();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (el.hclass('ui-moi-value-numbertext')) {\n\n\t\t\t\tobj[key] = el.val().parseFloat();\n\n\t\t\t\tif (opt.max !== null && obj[key] > opt.max) {\n\t\t\t\t\tobj[key] = opt.max;\n\t\t\t\t\tel.val(opt.max);\n\t\t\t\t}\n\n\t\t\t\tif (opt.min !== null && obj[key] < opt.min) {\n\t\t\t\t\tobj[key] = opt.min;\n\t\t\t\t\tel.val(opt.min);\n\t\t\t\t}\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (el.hclass('ui-multioptions-select')) {\n\t\t\t\tvar index = el.val().parseInt();\n\t\t\t\tvar val = opt.values[index];\n\t\t\t\tobj[key] = val ? val.value : null;\n\t\t\t\tif (obj[key] && obj[key].value)\n\t\t\t\t\tobj[key] = obj[key].value;\n\t\t\t\treturn;\n\t\t\t}\n\t\t});\n\n\t\tskip = true;\n\t\tself.set(obj);\n\t\tself.change(true);\n\t};\n\n\tself.setter = function(options) {\n\n\t\tif (!options || skip || !mapping) {\n\t\t\tskip = false;\n\t\t\treturn;\n\t\t}\n\n\t\tvar builder = [];\n\t\tObject.keys(mapping).forEach(function(key) {\n\n\t\t\tvar option = mapping[key];\n\n\t\t\t// option.name\n\t\t\t// option.label\n\t\t\t// option.type (lowercase)\n\t\t\t// option.def\n\t\t\t// option.value\n\t\t\t// option.max\n\t\t\t// option.min\n\t\t\t// option.step\n\n\t\t\toption.value = options[key] == null ? option.def : options[key];\n\n\t\t\tvar value = '';\n\n\t\t\tswitch (option.type.toLowerCase()) {\n\t\t\t\tcase 'string':\n\t\t\t\t\tvalue = option.multiline ? Tarea(option) : Tinput(option);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'file':\n\t\t\t\t\tvalue = Tfile(option);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'number':\n\t\t\t\t\tvalue = Tnumber(option);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'boolean':\n\t\t\t\t\tvalue = Tboolean(option);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'color':\n\t\t\t\t\tvalue = Tcolor(option);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'array':\n\t\t\t\t\tvalue = Tselect(option);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'date':\n\t\t\t\t\tvalue = Tdate(option);\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tbuilder.push('<div class=\"ui-multioptions-item{2}\"><div class=\"ui-moi-name\">{0}</div><div class=\"ui-moi-value\">{1}</div></div>'.format(option.label, value, option.multiline ? ' ui-multioptions-multiline' : ''));\n\t\t});\n\n\t\tself.empty().html(builder);\n\n\t\tself.find('.ui-moi-value-colors').each(function() {\n\t\t\tvar el = $(this);\n\t\t\tvar value = el.attrd('value');\n\t\t\tel.find('[data-value=\"{0}\"]'.format(value)).aclass('selected');\n\t\t});\n\t};\n});\n\nCOMPONENT('fileupload', function(self, config) {\n\n\tvar id = 'fileupload' + self._id;\n\tvar input = null;\n\n\tself.readonly();\n\tself.nocompile();\n\n\tself.configure = function(key, value, init) {\n\t\tif (init)\n\t\t\treturn;\n\t\tswitch (key) {\n\t\t\tcase 'disabled':\n\t\t\t\tself.tclass('ui-disabled', value);\n\t\t\t\tbreak;\n\t\t\tcase 'accept':\n\t\t\t\tvar el = $('#' + id);\n\t\t\t\tif (value)\n\t\t\t\t\tel.prop('accept', value);\n\t\t\t\telse\n\t\t\t\t\tel.removeProp('accept');\n\t\t\t\tbreak;\n\t\t\tcase 'multiple':\n\t\t\t\tvar el = $('#' + id);\n\t\t\t\tif (value)\n\t\t\t\t\tel.prop('multiple', true);\n\t\t\t\telse\n\t\t\t\t\tel.removeProp('multiple');\n\t\t\t\tbreak;\n\t\t\tcase 'label':\n\t\t\t\tself.html(value);\n\t\t\t\tbreak;\n\t\t}\n\t};\n\n\tself.make = function() {\n\n\t\tconfig.disabled && self.aclass('ui-disabled');\n\t\t$(document.body).append('<input type=\"file\" id=\"{0}\" class=\"hidden\"{1}{2} />'.format(id, config.accept ? ' accept=\"{0}\"'.format(config.accept) : '', config.multiple ? ' multiple=\"multiple\"' : ''));\n\t\tinput = $('#' + id);\n\n\t\tself.event('click', function() {\n\t\t\t!config.disabled && input.click();\n\t\t});\n\n\t\tinput.on('change', function(evt) {\n\t\t\t!config.disabled && self.upload(evt.target.files);\n\t\t});\n\t};\n\n\tself.upload = function(files) {\n\n\t\tvar data = new FormData();\n\t\tvar el = this;\n\n\t\tfor (var i = 0, length = files.length; i < length; i++)\n\t\t\tdata.append('file' + i, files[i]);\n\n\t\tSETTER('loading', 'show');\n\t\tUPLOAD(config.url, data, function(response, err) {\n\n\t\t\tel.value = '';\n\t\t\tSETTER('loading', 'hide', 500);\n\n\t\t\tif (err) {\n\t\t\t\tSETTER('snackbar', 'warning', err.toString());\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tself.change();\n\n\t\t\tif (config.property) {\n\t\t\t\tfor (var i = 0, length = response.length; i < length; i++)\n\t\t\t\t\tresponse[i] = response[i][config.property];\n\t\t\t}\n\n\t\t\tif (config.array)\n\t\t\t\tself.push(response);\n\t\t\telse\n\t\t\t\tself.set(response);\n\t\t});\n\t};\n\n\tself.destroy = function() {\n\t\tinput.off().remove();\n\t};\n});\n\nCOMPONENT('suggestion', function(self, config) {\n\n\tvar container, arrow, timeout, icon, input = null;\n\tvar is = false, selectedindex = 0, resultscount = 0;\n\n\tself.items = null;\n\tself.template = Tangular.compile('<li data-index=\"{{ $.index }}\"{{ if selected }} class=\"selected\"{{ fi }}>{{ name | raw }}</li>');\n\tself.callback = null;\n\n\tself.readonly();\n\tself.singleton();\n\tself.nocompile();\n\n\tself.configure = function(key, value, init) {\n\t\tif (init)\n\t\t\treturn;\n\t\tswitch (key) {\n\t\t\tcase 'placeholder':\n\t\t\t\tself.find('input').prop('placeholder', value);\n\t\t\t\tbreak;\n\t\t}\n\t};\n\n\tself.make = function() {\n\n\t\tself.aclass('ui-suggestion hidden');\n\t\tself.append('<span class=\"ui-suggestion-arrow\"></span><div class=\"ui-suggestion-search\"><span class=\"ui-suggestion-button\"><i class=\"fa fa-search\"></i></span><div><input type=\"text\" placeholder=\"{0}\" class=\"ui-suggestion-search-input\" /></div></div><div class=\"ui-suggestion-container\"><ul></ul></div>'.format(config.placeholder));\n\t\tcontainer = self.find('ul');\n\t\tarrow = self.find('.ui-suggestion-arrow');\n\t\tinput = self.find('input');\n\t\ticon = self.find('.ui-suggestion-button').find('.fa');\n\n\t\tself.event('mouseenter mouseleave', 'li', function() {\n\t\t\tcontainer.find('li.selected').rclass('selected');\n\t\t\t$(this).aclass('selected');\n\t\t\tvar arr = container.find('li:visible');\n\t\t\tfor (var i = 0; i < arr.length; i++) {\n\t\t\t\tif ($(arr[i]).hclass('selected')) {\n\t\t\t\t\tselectedindex = i;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tself.event('click', '.ui-suggestion-button', function(e) {\n\t\t\tinput.val('');\n\t\t\tself.search();\n\t\t\te.stopPropagation();\n\t\t\te.preventDefault();\n\t\t});\n\n\t\tself.event('touchstart mousedown', 'li', function(e) {\n\t\t\tself.callback && self.callback(self.items[+this.getAttribute('data-index')], $(self.target));\n\t\t\tself.hide();\n\t\t\te.preventDefault();\n\t\t\te.stopPropagation();\n\t\t});\n\n\t\t$(document).on('click', function(e) {\n\t\t\tis && !$(e.target).hclass('ui-suggestion-search-input') && self.hide(0);\n\t\t});\n\n\t\t$(window).on('resize', function() {\n\t\t\tis && self.hide(0);\n\t\t});\n\n\t\tself.event('keydown', 'input', function(e) {\n\t\t\tvar o = false;\n\t\t\tswitch (e.which) {\n\t\t\t\tcase 27:\n\t\t\t\t\to = true;\n\t\t\t\t\tself.hide();\n\t\t\t\t\tbreak;\n\t\t\t\tcase 13:\n\t\t\t\t\to = true;\n\t\t\t\t\tvar sel = self.find('li.selected');\n\t\t\t\t\tif (sel.length && self.callback)\n\t\t\t\t\t\tself.callback(self.items[+sel.attrd('index')]);\n\t\t\t\t\tself.hide();\n\t\t\t\t\tbreak;\n\t\t\t\tcase 38: // up\n\t\t\t\t\to = true;\n\t\t\t\t\tselectedindex--;\n\t\t\t\t\tif (selectedindex < 0)\n\t\t\t\t\t\tselectedindex = 0;\n\t\t\t\t\telse\n\t\t\t\t\t\tself.move();\n\t\t\t\t\tbreak;\n\t\t\t\tcase 40: // down\n\t\t\t\t\to = true;\n\t\t\t\t\tselectedindex++ ;\n\t\t\t\t\tif (selectedindex >= resultscount)\n\t\t\t\t\t\tselectedindex = resultscount;\n\t\t\t\t\telse\n\t\t\t\t\t\tself.move();\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (o) {\n\t\t\t\te.preventDefault();\n\t\t\t\te.stopPropagation();\n\t\t\t}\n\n\t\t});\n\n\t\tself.event('input', 'input', function() {\n\t\t\tsetTimeout2(self.ID, self.search, 100, null, this.value);\n\t\t});\n\n\t\tself.on('reflow', function() {\n\t\t\tis && self.hide(1);\n\t\t});\n\n\t\t$(window).on('scroll', function() {\n\t\t\tis && self.hide(1);\n\t\t});\n\t};\n\n\tself.move = function() {\n\t\tvar counter = 0;\n\t\tvar scroller = container.parent();\n\t\tvar h = scroller.height();\n\t\tcontainer.find('li').each(function() {\n\t\t\tvar el = $(this);\n\n\t\t\tif (el.hclass('hidden')) {\n\t\t\t\tel.rclass('selected');\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar is = selectedindex === counter;\n\t\t\tel.tclass('selected', is);\n\t\t\tif (is) {\n\t\t\t\tvar t = (h * counter) - h;\n\t\t\t\tif ((t + h * 4) > h)\n\t\t\t\t\tscroller.scrollTop(t - h);\n\t\t\t\telse\n\t\t\t\t\tscroller.scrollTop(0);\n\t\t\t}\n\t\t\tcounter++;\n\t\t});\n\t};\n\n\tself.search = function(value) {\n\n\t\ticon.tclass('fa-times', !!value).tclass('fa-search', !value);\n\n\t\tif (!value) {\n\t\t\tcontainer.find('li').rclass('hidden');\n\t\t\tresultscount = self.items.length;\n\t\t\tselectedindex = 0;\n\t\t\tself.move();\n\t\t\treturn;\n\t\t}\n\n\t\tresultscount = 0;\n\t\tselectedindex = 0;\n\n\t\tvalue = value.toSearch();\n\t\tcontainer.find('li').each(function() {\n\t\t\tvar el = $(this);\n\t\t\tvar val = this.innerHTML.toSearch();\n\t\t\tvar is = val.indexOf(value) === -1;\n\t\t\tel.tclass('hidden', is);\n\t\t\tif (!is)\n\t\t\t\tresultscount++;\n\t\t});\n\n\t\tself.move();\n\t};\n\n\tself.show = function(orientation, target, items, callback) {\n\n\t\tif (is) {\n\t\t\tclearTimeout(timeout);\n\t\t\tvar obj = target instanceof jQuery ? target[0] : target;\n\t\t\tif (self.target === obj) {\n\t\t\t\tself.hide(0);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\ttarget = $(target);\n\t\tvar type = typeof(items);\n\t\tvar item;\n\n\t\tif (type === 'string')\n\t\t\titems = self.get(items);\n\t\telse if (type === 'function') {\n\t\t\tcallback = items;\n\t\t\titems = (target.attrd('options') || '').split(';');\n\t\t\tfor (var i = 0, length = items.length; i < length; i++) {\n\t\t\t\titem = items[i];\n\t\t\t\tif (!item)\n\t\t\t\t\tcontinue;\n\t\t\t\tvar val = item.split('|');\n\t\t\t\titems[i] = { name: val[0], value: val[2] == null ? val[0] : val[2] };\n\t\t\t}\n\t\t}\n\n\t\tif (!items) {\n\t\t\tself.hide(0);\n\t\t\treturn;\n\t\t}\n\n\t\tself.items = items;\n\t\tself.callback = callback;\n\t\tinput.val('');\n\n\t\tvar builder = [];\n\t\tvar indexer = {};\n\n\t\tfor (var i = 0, length = items.length; i < length; i++) {\n\t\t\titem = items[i];\n\t\t\tindexer.index = i;\n\t\t\t!item.value && (item.value = item.name);\n\t\t\tbuilder.push(self.template(item, indexer));\n\t\t}\n\n\t\tself.target = target[0];\n\t\tvar offset = target.offset();\n\n\t\tcontainer.html(builder);\n\n\t\tswitch (orientation) {\n\t\t\tcase 'left':\n\t\t\t\tarrow.css({ left: '15px' });\n\t\t\t\tbreak;\n\t\t\tcase 'right':\n\t\t\t\tarrow.css({ left: '210px' });\n\t\t\t\tbreak;\n\t\t\tcase 'center':\n\t\t\t\tarrow.css({ left: '107px' });\n\t\t\t\tbreak;\n\t\t}\n\n\t\tvar options = { left: orientation === 'center' ? Math.ceil((offset.left - self.element.width() / 2) + (target.innerWidth() / 2)) : orientation === 'left' ? offset.left - 8 : (offset.left - self.element.width()) + target.innerWidth(), top: offset.top + target.innerHeight() + 10 };\n\t\tself.css(options);\n\n\t\tif (is)\n\t\t\treturn;\n\n\t\tselectedindex = 0;\n\t\tresultscount = items.length;\n\t\tself.move();\n\t\tself.search();\n\n\t\tself.rclass('hidden');\n\t\tsetTimeout(function() {\n\t\t\tself.aclass('ui-suggestion-visible');\n\t\t\tself.emit('suggestion', true, self, self.target);\n\t\t}, 100);\n\n\t\t!isMOBILE && setTimeout(function() {\n\t\t\tinput.focus();\n\t\t}, 500);\n\n\t\tsetTimeout(function() {\n\t\t\tis = true;\n\t\t}, 50);\n\t};\n\n\tself.hide = function(sleep) {\n\t\tif (!is)\n\t\t\treturn;\n\t\tclearTimeout(timeout);\n\t\ttimeout = setTimeout(function() {\n\t\t\tself.rclass('ui-suggestion-visible').aclass('hidden');\n\t\t\tself.emit('suggestion', false, self, self.target);\n\t\t\tself.callback = null;\n\t\t\tself.target = null;\n\t\t\tis = false;\n\t\t}, sleep ? sleep : 100);\n\t};\n\n});\n\nCOMPONENT('calendar', 'today:Set today;firstday:0;close:Close;yearselect:true;monthselect:true;yearfrom:-70 years;yearto:5 years', function(self, config) {\n\n\tvar skip = false;\n\tvar skipDay = false;\n\tvar visible = false;\n\n\tself.days = EMPTYARRAY;\n\tself.months = EMPTYARRAY;\n\tself.months_short = EMPTYARRAY;\n\tself.years_from;\n\tself.years_to;\n\n\tself.nocompile();\n\n\tself.configure = function(key, value) {\n\t\tswitch (key) {\n\t\t\tcase 'days':\n\t\t\t\tif (value instanceof Array)\n\t\t\t\t\tself.days = value;\n\t\t\t\telse\n\t\t\t\t\tself.days = value.split(',').trim();\n\n\t\t\t\tfor (var i = 0; i < DAYS.length; i++) {\n\t\t\t\t\tDAYS[i] = self.days[i];\n\t\t\t\t\tself.days[i] = DAYS[i].substring(0, 2).toUpperCase();\n\t\t\t\t}\n\n\t\t\t\tbreak;\n\n\t\t\tcase 'months':\n\t\t\t\tif (value instanceof Array)\n\t\t\t\t\tself.months = value;\n\t\t\t\telse\n\t\t\t\t\tself.months = value.split(',').trim();\n\n\t\t\t\tself.months_short = [];\n\n\t\t\t\tfor (var i = 0, length = self.months.length; i < length; i++) {\n\t\t\t\t\tvar m = self.months[i];\n\t\t\t\t\tMONTHS[i] = m;\n\t\t\t\t\tif (m.length > 4)\n\t\t\t\t\t\tm = m.substring(0, 3) + '.';\n\t\t\t\t\tself.months_short.push(m);\n\t\t\t\t}\n\t\t\t\tbreak;\n\n\t\t\tcase 'yearfrom':\n\t\t\t\tif (value.indexOf('current') !== -1)\n\t\t\t\t\tself.years_from = parseInt(new Date().format('yyyy'));\n\t\t\t\telse\n\t\t\t\t\tself.years_from = parseInt(new Date().add(value).format('yyyy'));\n\t\t\t\tbreak;\n\n\t\t\tcase 'yearto':\n\t\t\t\tif (value.indexOf('current') !== -1)\n\t\t\t\t\tself.years_to = parseInt(new Date().format('yyyy'));\n\t\t\t\telse\n\t\t\t\t\tself.years_to = parseInt(new Date().add(value).format('yyyy'));\n\t\t\t\tbreak;\n\t\t}\n\t};\n\n\tself.readonly();\n\tself.click = function() {};\n\n\tfunction getMonthDays(dt) {\n\n\t\tvar m = dt.getMonth();\n\t\tvar y = dt.getFullYear();\n\n\t\tif (m === -1) {\n\t\t\tm = 11;\n\t\t\ty--;\n\t\t}\n\n\t\treturn (32 - new Date(y, m, 32).getDate());\n\t}\n\n\tself.calculate = function(year, month, selected) {\n\n\t\tvar d = new Date(year, month, 1, 12, 0);\n\t\tvar output = { header: [], days: [], month: month, year: year };\n\t\tvar firstDay = config.firstday;\n\t\tvar firstCount = 0;\n\t\tvar frm = d.getDay() - firstDay;\n\t\tvar today = new Date();\n\t\tvar ty = today.getFullYear();\n\t\tvar tm = today.getMonth();\n\t\tvar td = today.getDate();\n\t\tvar sy = selected ? selected.getFullYear() : -1;\n\t\tvar sm = selected ? selected.getMonth() : -1;\n\t\tvar sd = selected ? selected.getDate() : -1;\n\t\tvar days = getMonthDays(d);\n\n\t\tif (frm < 0)\n\t\t\tfrm = 7 + frm;\n\n\t\twhile (firstCount++ < 7) {\n\t\t\toutput.header.push({ index: firstDay, name: self.days[firstDay] });\n\t\t\tfirstDay++;\n\t\t\tif (firstDay > 6)\n\t\t\t\tfirstDay = 0;\n\t\t}\n\n\t\tvar index = 0;\n\t\tvar indexEmpty = 0;\n\t\tvar count = 0;\n\t\tvar prev = getMonthDays(new Date(year, month - 1, 1, 12, 0)) - frm;\n\t\tvar cur;\n\n\t\tfor (var i = 0; i < days + frm; i++) {\n\n\t\t\tvar obj = { isToday: false, isSelected: false, isEmpty: false, isFuture: false, number: 0, index: ++count };\n\n\t\t\tif (i >= frm) {\n\t\t\t\tobj.number = ++index;\n\t\t\t\tobj.isSelected = sy === year && sm === month && sd === index;\n\t\t\t\tobj.isToday = ty === year && tm === month && td === index;\n\t\t\t\tobj.isFuture = ty < year;\n\t\t\t\tif (!obj.isFuture && year === ty) {\n\t\t\t\t\tif (tm < month)\n\t\t\t\t\t\tobj.isFuture = true;\n\t\t\t\t\telse if (tm === month)\n\t\t\t\t\t\tobj.isFuture = td < index;\n\t\t\t\t}\n\n\t\t\t} else {\n\t\t\t\tindexEmpty++;\n\t\t\t\tobj.number = prev + indexEmpty;\n\t\t\t\tobj.isEmpty = true;\n\t\t\t\tcur = d.add('-' + indexEmpty + ' days');\n\t\t\t}\n\n\t\t\tif (!obj.isEmpty)\n\t\t\t\tcur = d.add(i + ' days');\n\n\t\t\tobj.month = i >= frm && obj.number <= days ? d.getMonth() : cur.getMonth();\n\t\t\tobj.year = i >= frm && obj.number <= days ? d.getFullYear() : cur.getFullYear();\n\t\t\tobj.date = cur;\n\t\t\toutput.days.push(obj);\n\t\t}\n\n\t\tindexEmpty = 0;\n\n\t\tfor (var i = count; i < 42; i++) {\n\t\t\tvar cur = d.add(i + ' days');\n\t\t\tvar obj = { isToday: false, isSelected: false, isEmpty: true, isFuture: true, number: ++indexEmpty, index: ++count };\n\t\t\tobj.month = cur.getMonth();\n\t\t\tobj.year = cur.getFullYear();\n\t\t\tobj.date = cur;\n\t\t\toutput.days.push(obj);\n\t\t}\n\n\t\treturn output;\n\t};\n\n\tself.hide = function() {\n\t\tif (visible) {\n\t\t\tself.older = null;\n\t\t\tself.aclass('hidden');\n\t\t\tself.rclass('ui-calendar-visible');\n\t\t\tvisible = false;\n\t\t}\n\t\treturn self;\n\t};\n\n\tself.toggle = function(el, value, callback, offset) {\n\t\tif (self.older === el[0]) {\n\t\t\t!self.hclass('hidden') && self.hide();\n\t\t} else {\n\t\t\tself.older = el[0];\n\t\t\tself.show(el, value, callback, offset);\n\t\t}\n\t\treturn self;\n\t};\n\n\tself.show = function(el, value, callback, offset) {\n\n\t\tsetTimeout(function() {\n\t\t\tclearTimeout2('calendarhide');\n\t\t}, 5);\n\n\t\tif (!el)\n\t\t\treturn self.hide();\n\n\t\tvar off = el.offset();\n\t\tvar h = el.innerHeight();\n\t\tvar l = off.left + (offset || 0);\n\t\tvar t = off.top + h + 12;\n\t\tvar s = 250;\n\n\t\tif (l + s > WW) {\n\t\t\tvar w = el.innerWidth();\n\t\t\tl = (l + w) - s;\n\t\t}\n\n\t\tself.css({ left: l, top: t });\n\t\tself.rclass('hidden');\n\t\tself.click = callback;\n\t\tself.date(value);\n\t\tvisible = true;\n\t\tself.aclass('ui-calendar-visible', 50);\n\t\treturn self;\n\t};\n\n\tself.make = function() {\n\n\t\tself.aclass('ui-calendar hidden');\n\n\t\tvar conf = {};\n\n\t\tif (!config.days) {\n\t\t\tconf.days = [];\n\t\t\tfor (var i = 0; i < DAYS.length; i++)\n\t\t\t\tconf.days.push(DAYS[i].substring(0, 2).toUpperCase());\n\t\t}\n\n\t\t!config.months && (conf.months = MONTHS);\n\t\tself.reconfigure(conf);\n\n\t\tself.event('click', '.ui-calendar-today-a', function() {\n\t\t\tvar dt = new Date();\n\t\t\tself.hide();\n\t\t\tif (self.click) {\n\t\t\t\tif (typeof(self.click) === 'string') {\n\t\t\t\t\tSET(self.click, dt);\n\t\t\t\t\tCHANGE(self.click, true);\n\t\t\t\t} else\n\t\t\t\t\tself.click(dt);\n\t\t\t}\n\t\t});\n\n\t\tself.event('click', '.ui-calendar-day', function() {\n\t\t\tvar arr = this.getAttribute('data-date').split('-');\n\t\t\tvar dt = new Date(parseInt(arr[0]), parseInt(arr[1]), parseInt(arr[2]), 12, 0);\n\t\t\tself.find('.ui-calendar-selected').rclass('ui-calendar-selected');\n\t\t\tvar el = $(this).aclass('ui-calendar-selected');\n\t\t\tskip = !el.hclass('ui-calendar-disabled');\n\t\t\tself.hide();\n\t\t\tif (self.click) {\n\t\t\t\tif (typeof(self.click) === 'string') {\n\t\t\t\t\tSET(self.click, dt);\n\t\t\t\t\tCHANGE(self.click, true);\n\t\t\t\t} else\n\t\t\t\t\tself.click(dt);\n\t\t\t}\n\t\t});\n\n\t\tself.event('click', '.ui-calendar-header', function(e) {\n\t\t\te.stopPropagation();\n\t\t});\n\n\t\tself.event('change', '.ui-calendar-year', function(e) {\n\n\t\t\tclearTimeout2('calendarhide');\n\t\t\te.preventDefault();\n\t\t\te.stopPropagation();\n\n\t\t\tvar arr = this.getAttribute('data-date').split('-');\n\t\t\tvar dt = new Date(parseInt(arr[0]), parseInt(arr[1]), 1, 12, 0);\n\t\t\tdt.setFullYear(this.value);\n\t\t\tskipDay = true;\n\t\t\tself.date(dt);\n\t\t});\n\n\t\tself.event('change', '.ui-calendar-month', function(e){\n\n\t\t\tclearTimeout2('calendarhide');\n\t\t\te.preventDefault();\n\t\t\te.stopPropagation();\n\n\t\t\tvar arr = this.getAttribute('data-date').split('-');\n\t\t\tvar dt = new Date(parseInt(arr[0]), parseInt(arr[1]), 1, 12, 0);\n\t\t\tdt.setMonth(this.value);\n\t\t\tskipDay = true;\n\t\t\tself.date(dt);\n\t\t});\n\n\t\tself.event('click', 'button', function(e) {\n\n\t\t\te.preventDefault();\n\t\t\te.stopPropagation();\n\n\t\t\tvar arr = this.getAttribute('data-date').split('-');\n\t\t\tvar dt = new Date(parseInt(arr[0]), parseInt(arr[1]), 1, 12, 0);\n\t\t\tswitch (this.name) {\n\t\t\t\tcase 'prev':\n\t\t\t\t\tdt.setMonth(dt.getMonth() - 1);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'next':\n\t\t\t\t\tdt.setMonth(dt.getMonth() + 1);\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tvar current_year = dt.getFullYear();\n\t\t\tif (current_year < self.years_from || current_year > self.years_to)\n\t\t\t\treturn;\n\n\t\t\tskipDay = true;\n\t\t\tself.date(dt);\n\t\t});\n\n\t\t$(window).on('scroll click', function() {\n\t\t\tvisible && setTimeout2('calendarhide', function() {\n\t\t\t\tEXEC('$calendar.hide');\n\t\t\t}, 20);\n\t\t});\n\n\t\twindow.$calendar = self;\n\n\t\tself.on('reflow', function() {\n\t\t\tvisible && EXEC('$calendar.hide');\n\t\t});\n\t};\n\n\tself.date = function(value) {\n\n\t\tvar clssel = 'ui-calendar-selected';\n\n\t\tif (typeof(value) === 'string')\n\t\t\tvalue = value.parseDate();\n\n\t\tif (!value || isNaN(value.getTime())) {\n\t\t\tself.find('.' + clssel).rclass(clssel);\n\t\t\tvalue = NOW;\n\t\t}\n\n\t\tvar empty = !value;\n\n\t\tif (skipDay) {\n\t\t\tskipDay = false;\n\t\t\tempty = true;\n\t\t}\n\n\t\tif (skip) {\n\t\t\tskip = false;\n\t\t\treturn;\n\t\t}\n\n\t\tif (!value)\n\t\t\tvalue = NOW = new Date();\n\n\t\tvar output = self.calculate(value.getFullYear(), value.getMonth(), value);\n\t\tvar builder = [];\n\n\t\tfor (var i = 0; i < 42; i++) {\n\n\t\t\tvar item = output.days[i];\n\n\t\t\tif (i % 7 === 0) {\n\t\t\t\tbuilder.length && builder.push('</tr>');\n\t\t\t\tbuilder.push('<tr>');\n\t\t\t}\n\n\t\t\tvar cls = [];\n\n\t\t\titem.isEmpty && cls.push('ui-calendar-disabled');\n\t\t\tcls.push('ui-calendar-day');\n\n\t\t\t!empty && item.isSelected && cls.push(clssel);\n\t\t\titem.isToday && cls.push('ui-calendar-day-today');\n\t\t\tbuilder.push('<td class=\"{0}\" data-date=\"{1}-{2}-{3}\"><div>{3}</div></td>'.format(cls.join(' '), item.year, item.month, item.number));\n\t\t}\n\n\t\tbuilder.push('</tr>');\n\n\t\tvar header = [];\n\t\tfor (var i = 0; i < 7; i++)\n\t\t\theader.push('<th>{0}</th>'.format(output.header[i].name));\n\n\t\tvar years = value.getFullYear();\n\t\tif (config.yearselect) {\n\t\t\tyears = '';\n\t\t\tvar current_year = value.getFullYear();\n\t\t\tfor (var i = self.years_from; i <= self.years_to; i++)\n\t\t\t\tyears += '<option value=\"{0}\" {1}>{0}</option>'.format(i, i === current_year ? 'selected' : '');\n\t\t\tyears = '<select data-date=\"{0}-{1}\" class=\"ui-calendar-year\">{2}</select>'.format(output.year, output.month, years);\n\t\t}\n\n\t\tvar months = self.months[value.getMonth()];\n\t\tif (config.monthselect) {\n\t\t\tmonths = '';\n\t\t\tvar current_month = value.getMonth();\n\t\t\tfor (var i = 0, l = self.months.length; i < l; i++)\n\t\t\t\tmonths += '<option value=\"{0}\" {2}>{1}</option>'.format(i, self.months[i], i === current_month ? 'selected' : '');\n\t\t\tmonths = '<select data-date=\"{0}-{1}\" class=\"ui-calendar-month\">{2}</select>'.format(output.year, output.month, months);\n\t\t}\n\n\t\tself.html('<div class=\"ui-calendar-header\"><button class=\"ui-calendar-header-prev\" name=\"prev\" data-date=\"{0}-{1}\"><span class=\"fa fa-arrow-left\"></span></button><div class=\"ui-calendar-header-info\">{2} {3}</div><button class=\"ui-calendar-header-next\" name=\"next\" data-date=\"{0}-{1}\"><span class=\"fa fa-arrow-right\"></span></button></div><div class=\"ui-calendar-table\"><table cellpadding=\"0\" cellspacing=\"0\" border=\"0\"><thead>{4}</thead><tbody>{5}</tbody></table></div>'.format(output.year, output.month, months, years, header.join(''), builder.join('')) + (config.today ? '<div class=\"ui-calendar-today\"><a href=\"javascript:void(0)\">{0}</a><a href=\"javascript:void(0)\" class=\"ui-calendar-today-a\"><i class=\"fa fa-calendar\"></i>{1}</a></div>'.format(config.close, config.today) : ''));\n\t};\n});\n\nCOMPONENT('mainprogress', function(self) {\n\n\tvar old = null;\n\n\tself.singleton();\n\tself.readonly();\n\tself.nocompile();\n\n\tself.make = function() {\n\t\tself.aclass('ui-mainprogress hidden');\n\t};\n\n\tself.setter = function(value) {\n\t\t!value && (value = 0);\n\n\t\tif (old === value)\n\t\t\treturn;\n\n\t\tif (value > 100)\n\t\t\tvalue = 100;\n\t\telse if (value < 0)\n\t\t\tvalue = 0;\n\n\t\told = value >> 0;\n\n\t\tself.element.stop().animate({ width: old + '%' }, 80).show();\n\t\tself.tclass('hidden', old === 0 || old === 100);\n\t};\n});\n\nCOMPONENT('progress', 'animate:true', function(self, config) {\n\n\tvar container, old = null;\n\n\tself.readonly();\n\tself.nocompile();\n\n\tself.make = function() {\n\t\tself.aclass('ui-progress');\n\t\tself.append('<div style=\"width:10%\">0%</div>');\n\t\tcontainer = self.find('div');\n\t};\n\n\tself.setter = function(value) {\n\t\t!value && (value = 0);\n\t\tif (old === value)\n\t\t\treturn;\n\n\t\tif (value > 100)\n\t\t\tvalue = 100;\n\t\telse if (value < 0)\n\t\t\tvalue = 0;\n\n\t\told = value >> 0;\n\t\tif (config.animate)\n\t\t\tcontainer.stop().animate({ width: old + '%' }, 80).show();\n\t\telse\n\t\t\tcontainer.css({ width: old + '%' });\n\n\t\tcontainer.html(old + '%');\n\t};\n});\n\nCOMPONENT('pictures', function() {\n\n\tvar self = this;\n\n\tself.skip = false;\n\tself.readonly();\n\tself.nocompile();\n\n\tself.make = function() {\n\t\tself.aclass('ui-pictures');\n\t};\n\n\tself.setter = function(value) {\n\n\t\tif (typeof(value) === 'string')\n\t\t\tvalue = value.split(',');\n\n\t\tif (self.skip) {\n\t\t\tself.skip = false;\n\t\t\treturn;\n\t\t}\n\n\t\tself.find('.fa,img').unbind('click');\n\n\t\tif (!(value instanceof Array) || !value.length) {\n\t\t\tself.empty();\n\t\t\treturn;\n\t\t}\n\n\t\tvar builder = [];\n\n\t\tfor (var i = 0, length = value.length; i < length; i++) {\n\t\t\tvar id = value[i];\n\t\t\tid && builder.push('<div data-id=\"{0}\" class=\"col-xs-3 col-lg-2 m\"><span class=\"fa fa-times\"></span><img src=\"/images/small/{0}.jpg\" class=\"img-responsive\" alt=\"\" /></div>'.format(id));\n\t\t}\n\n\t\tself.html(builder);\n\n\t\tthis.element.find('.fa').bind('click', function() {\n\t\t\tvar id = [];\n\t\t\t$(this).parent().remove();\n\n\t\t\tself.find('div').each(function() {\n\t\t\t\tid.push($(this).attr('data-id'));\n\t\t\t});\n\n\t\t\tself.skip = true;\n\t\t\tself.set(id);\n\t\t});\n\n\t\tthis.element.find('img').bind('click', function() {\n\n\t\t\tvar selected = self.find('.selected');\n\t\t\tvar el = $(this);\n\n\t\t\tel.toggleClass('selected');\n\n\t\t\tif (!selected.length)\n\t\t\t\treturn;\n\n\t\t\tvar parent1 = el.parent();\n\t\t\tvar parent2 = selected.parent();\n\t\t\tvar id1 = parent1.attrd('id');\n\t\t\tvar id2 = parent2.attrd('id');\n\t\t\tvar arr = self.get();\n\n\t\t\tvar index1 = arr.indexOf(id1);\n\t\t\tvar index2 = arr.indexOf(id2);\n\n\t\t\tarr[index1] = id2;\n\t\t\tarr[index2] = id1;\n\n\t\t\tparent1.attrd('id', id2);\n\t\t\tparent2.attrd('id', id1);\n\n\t\t\tvar img1 = parent1.find('img');\n\t\t\tvar img2 = parent2.find('img');\n\t\t\tvar src1 = img1.attr('src');\n\n\t\t\timg1.attr('src', img2.attr('src'));\n\t\t\timg2.attr('src', src1);\n\n\t\t\tsetTimeout(function() {\n\t\t\t\tself.skip = true;\n\t\t\t\timg1.rclass('selected');\n\t\t\t\timg2.rclass('selected');\n\t\t\t\tself.change(true);\n\t\t\t\tself.set(arr);\n\t\t\t}, 200);\n\t\t});\n\t};\n});\n\nCOMPONENT('textboxtags', function(self, config) {\n\n\tvar isString = false;\n\tvar container, content = null;\n\tvar refresh = false;\n\tvar W = window;\n\n\tif (!W.$textboxtagstemplate)\n\t\tW.$textboxtagstemplate = Tangular.compile('<div class=\"ui-textboxtags-tag\" data-name=\"{{ name }}\">{{ name }}<i class=\"fa fa-times-circle ui-textboxtags-remove\"></i></div>');\n\n\tself.nocompile();\n\n\tvar template = W.$textboxtagstemplate;\n\n\tself.validate = function(value) {\n\t\treturn config.disabled || !config.required ? true : value && value.length > 0;\n\t};\n\n\tself.configure = function(key, value, init) {\n\t\tif (init)\n\t\t\treturn;\n\n\t\tvar redraw = false;\n\n\t\tswitch (key) {\n\t\t\tcase 'disabled':\n\t\t\t\tself.tclass('ui-disabled', value);\n\t\t\t\tself.state(1, 1);\n\t\t\t\tself.find('input').prop('disabled', value);\n\t\t\t\tbreak;\n\t\t\tcase 'required':\n\t\t\t\tself.find('.ui-textboxtags-label').tclass('ui-textboxtags-label-required', value);\n\t\t\t\tself.state(1, 1);\n\t\t\t\tbreak;\n\t\t\tcase 'icon':\n\t\t\t\tvar fa = self.find('.ui-textboxtags-label > i');\n\t\t\t\tif (fa.length && value)\n\t\t\t\t\tfa.rclass().aclass('fa fa-' + value);\n\t\t\t\telse\n\t\t\t\t\tredraw = true;\n\t\t\t\tbreak;\n\n\t\t\tcase 'placeholder':\n\t\t\t\tself.find('input').prop('placeholder', value);\n\t\t\t\tbreak;\n\t\t\tcase 'height':\n\t\t\t\tself.find('.ui-textboxtags-values').css('height', value);\n\t\t\t\tbreak;\n\t\t\tcase 'label':\n\t\t\t\tredraw = true;\n\t\t\t\tbreak;\n\t\t\tcase 'type':\n\t\t\t\tself.type = value;\n\t\t\t\tisString = self.type === 'string';\n\t\t\t\tbreak;\n\t\t}\n\n\t\tredraw && setTimeout2('redraw' + self.id, function() {\n\t\t\trefresh = true;\n\t\t\tcontainer.off();\n\t\t\tself.redraw();\n\t\t\tself.refresh();\n\t\t}, 100);\n\n\t};\n\n\tself.redraw = function() {\n\t\tvar label = config.label || content;\n\t\tvar html = '<div class=\"ui-textboxtags-values\"' + (config.height ? ' style=\"min-height:' + config.height + 'px\"' : '') + '><input type=\"text\" placeholder=\"' + (config.placeholder || '') + '\" /></div>';\n\n\t\tisString = self.type === 'string';\n\n\t\tif (content.length) {\n\t\t\tself.html('<div class=\"ui-textboxtags-label{0}\">{1}{2}:</div><div class=\"ui-textboxtags\">{3}</div>'.format((config.required ? ' ui-textboxtags-label-required' : ''), (config.icon ? '<i class=\"fa fa-' + config.icon + '\"></i> ' : ''), label, html));\n\t\t} else {\n\t\t\tself.aclass('ui-textboxtags');\n\t\t\tself.html(html);\n\t\t}\n\n\t\tcontainer = self.find('.ui-textboxtags-values');\n\t\tconfig.disabled && self.reconfigure('disabled:true');\n\t};\n\n\tself.make = function() {\n\n\t\tself.aclass('ui-textboxtags-container');\n\t\tcontent = self.html();\n\t\tself.type = config.type || '';\n\t\tself.redraw();\n\n\t\tself.event('click', '.ui-textboxtags-remove', function(e) {\n\n\t\t\tif (config.disabled)\n\t\t\t\treturn;\n\n\t\t\te.preventDefault();\n\t\t\te.stopPropagation();\n\n\t\t\tvar el = $(this);\n\t\t\tvar arr = self.get();\n\n\t\t\tif (isString)\n\t\t\t\tarr = self.split(arr);\n\n\t\t\tif (!arr || !(arr instanceof Array) || !arr.length)\n\t\t\t\treturn;\n\n\t\t\tvar index = arr.indexOf(el.parent().attr('data-name'));\n\t\t\tif (index === -1)\n\t\t\t\treturn;\n\n\t\t\tarr.splice(index, 1);\n\t\t\tself.set(isString ? arr.join(', ') : arr);\n\t\t\tself.change(true);\n\t\t});\n\n\t\tself.event('click', function() {\n\t\t\t!config.disabled && self.find('input').focus();\n\t\t});\n\n\t\tself.event('keydown', 'input', function(e) {\n\n\t\t\tif (config.disabled)\n\t\t\t\treturn;\n\n\t\t\tif (e.which === 8) {\n\t\t\t\tif (this.value)\n\t\t\t\t\treturn;\n\t\t\t\tvar arr = self.get();\n\t\t\t\tif (isString)\n\t\t\t\t\tarr = self.split(arr);\n\t\t\t\tif (!arr || !(arr instanceof Array) || !arr.length)\n\t\t\t\t\treturn;\n\t\t\t\tarr.pop();\n\t\t\t\tself.set(isString ? arr.join(', ') : arr);\n\t\t\t\tself.change(true);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (e.which !== 13)\n\t\t\t\treturn;\n\n\t\t\te.preventDefault();\n\n\t\t\tif (!this.value)\n\t\t\t\treturn;\n\n\t\t\tvar arr = self.get();\n\t\t\tvar value = this.value;\n\n\t\t\tif (config.uppercase)\n\t\t\t\tvalue = value.toUpperCase();\n\t\t\telse if (config.lowercase)\n\t\t\t\tvalue = value.toLowerCase();\n\n\t\t\tif (isString)\n\t\t\t\tarr = self.split(arr);\n\n\t\t\tif (!(arr instanceof Array))\n\t\t\t\tarr = [];\n\n\t\t\tif (arr.indexOf(value) === -1)\n\t\t\t\tarr.push(value);\n\t\t\telse\n\t\t\t\treturn;\n\n\t\t\tthis.value = '';\n\t\t\tself.set(isString ? arr.join(', ') : arr);\n\t\t\tself.change(true);\n\t\t});\n\t};\n\n\tself.split = function(value) {\n\t\tif (!value)\n\t\t\treturn new Array(0);\n\t\tvar arr = value.split(',');\n\t\tfor (var i = 0, length = arr.length; i < length; i++)\n\t\t\tarr[i] = arr[i].trim();\n\t\treturn arr;\n\t};\n\n\tself.setter = function(value) {\n\n\t\tif (!refresh && NOTMODIFIED(self.id, value))\n\t\t\treturn;\n\n\t\trefresh = false;\n\t\tcontainer.find('.ui-textboxtags-tag').remove();\n\n\t\tif (!value || !value.length)\n\t\t\treturn;\n\n\t\tvar arr = isString ? self.split(value) : value;\n\t\tvar builder = '';\n\t\tfor (var i = 0, length = arr.length; i < length; i++)\n\t\t\tbuilder += template({ name: arr[i] });\n\n\t\tcontainer.prepend(builder);\n\t};\n\n\tself.state = function(type) {\n\t\tif (!type)\n\t\t\treturn;\n\t\tvar invalid = config.required ? self.isInvalid() : false;\n\t\tif (invalid === self.$oldstate)\n\t\t\treturn;\n\t\tself.$oldstate = invalid;\n\t\tself.find('.ui-textboxtags').tclass('ui-textboxtags-invalid', invalid);\n\t};\n});\n\nCOMPONENT('websocket', 'reconnect:3000', function(self, config) {\n\n\tvar ws, url;\n\tvar queue = [];\n\tvar sending = false;\n\n\tself.online = false;\n\tself.readonly();\n\tself.nocompile();\n\n\tself.make = function() {\n\t\turl = (config.url || '').env(true);\n\t\tif (!url.match(/^(ws|wss):\\/\\//))\n\t\t\turl = (location.protocol.length === 6 ? 'wss' : 'ws') + '://' + location.host + (url.substring(0, 1) !== '/' ? '/' : '') + url;\n\t\tsetTimeout(self.connect, 500);\n\t\tself.destroy = self.close;\n\t};\n\n\tself.send = function(obj) {\n\t\tqueue.push(encodeURIComponent(JSON.stringify(obj)));\n\t\tself.process();\n\t\treturn self;\n\t};\n\n\tself.process = function(callback) {\n\n\t\tif (!ws || sending || !queue.length || ws.readyState !== 1) {\n\t\t\tcallback && callback();\n\t\t\treturn;\n\t\t}\n\n\t\tsending = true;\n\t\tvar async = queue.splice(0, 3);\n\t\tasync.wait(function(item, next) {\n\t\t\tws.send(item);\n\t\t\tsetTimeout(next, 5);\n\t\t}, function() {\n\t\t\tcallback && callback();\n\t\t\tsending = false;\n\t\t\tqueue.length && self.process();\n\t\t});\n\t};\n\n\tself.close = function(isClosed) {\n\t\tif (!ws)\n\t\t\treturn self;\n\t\tself.online = false;\n\t\tws.onopen = ws.onclose = ws.onmessage = null;\n\t\t!isClosed && ws.close();\n\t\tws = null;\n\t\tEMIT('online', false);\n\t\treturn self;\n\t};\n\n\tfunction onClose() {\n\t\tself.close(true);\n\t\tsetTimeout(self.connect, config.reconnect);\n\t}\n\n\tfunction onMessage(e) {\n\t\tvar data;\n\t\ttry {\n\t\t\tdata = PARSE(decodeURIComponent(e.data));\n\t\t\tself.attrd('jc-path') && self.set(data);\n\t\t} catch (e) {\n\t\t\tWARN('WebSocket \"{0}\": {1}'.format(url, e.toString()));\n\t\t}\n\t\tdata && EMIT('message', data);\n\t}\n\n\tfunction onOpen() {\n\t\tself.online = true;\n\t\tself.process(function() {\n\t\t\tEMIT('online', true);\n\t\t});\n\t}\n\n\tself.connect = function() {\n\t\tws && self.close();\n\t\tsetTimeout2(self.id, function() {\n\t\t\tws = new WebSocket(url.env(true));\n\t\t\tws.onopen = onOpen;\n\t\t\tws.onclose = onClose;\n\t\t\tws.onmessage = onMessage;\n\t\t}, 100);\n\t\treturn self;\n\t};\n});\n\nCOMPONENT('donutchart', 'format:{{ value | format(0) }};size:0;tooltip:true;presentation:true;animate:true', function(self, config) {\n\n\tvar svg, g, selected, tooltip;\n\tvar strokew = 0;\n\tvar animate = true;\n\tvar indexer = 0;\n\tvar indexerskip = false;\n\tvar force = false;\n\tvar W = $(window);\n\n\tself.readonly();\n\tself.nocompile();\n\n\tself.make = function() {\n\t\tself.aclass('ui-donutchart');\n\t\tself.append('<div class=\"ui-donutchart-tooltip\"></div><svg></svg>');\n\t\tsvg = self.find('svg');\n\t\tg = svg.asvg('g').attr('class', 'pieces');\n\t\ttooltip = self.find('.ui-donutchart-tooltip');\n\n\t\tW.on('resize', self.resize);\n\n\t\tself.event('mouseenter touchstart', '.piece', function() {\n\t\t\tself.select(+this.getAttribute('data-index'));\n\t\t\t!indexerskip && config.presentation && setTimeout2(self.id + '.skip', self.next, 30000);\n\t\t\tindexerskip = true;\n\t\t});\n\t};\n\n\tself.select = function(index) {\n\t\tvar item = self.get()[index];\n\t\tif (item === selected)\n\t\t\treturn;\n\n\t\tself.find('.selected').rclass('selected').css('stroke-width', strokew);\n\t\tselected = item;\n\n\t\tvar el = self.find('.piece' + (index + 1));\n\n\t\tif (config.tooltip) {\n\t\t\tvar w = self.width();\n\t\t\ttooltip.css('font-size', w / 15);\n\t\t\ttooltip.html('<b>' + item.name + '</b><br />' + Tangular.render(config.format, item));\n\t\t}\n\n\t\tconfig.select && EXEC(config.select, item);\n\t\tel.css('stroke-width', strokew.inc('+15%')).aclass('selected');\n\t\tindexer = index;\n\t};\n\n\tself.destroy = function() {\n\t\tW.off('resize', self.resize);\n\t};\n\n\tself.resize = function() {\n\t\tsetTimeout2('resize.' + self.id, function() {\n\t\t\tanimate = false;\n\t\t\tforce = true;\n\t\t\tself.refresh();\n\t\t}, 100);\n\t};\n\n\tself.next = function() {\n\n\t\tif (self.removed)\n\t\t\treturn;\n\n\t\tif (indexerskip) {\n\t\t\tindexerskip = false;\n\t\t\treturn;\n\t\t}\n\n\t\tindexer++;\n\n\t\tvar tmp = self.get();\n\t\tif (!tmp)\n\t\t\treturn;\n\n\t\tif (!tmp[indexer])\n\t\t\tindexer = 0;\n\n\t\tself.select(indexer);\n\t\tsetTimeout2(self.id + '.next', self.next, 4000);\n\t};\n\n\tfunction arcradius(centerX, centerY, radius, degrees) {\n\t\tvar radians = (degrees - 90) * Math.PI / 180.0;\n\t\treturn { x: centerX + (radius * Math.cos(radians)), y: centerY + (radius * Math.sin(radians)) };\n\t}\n\n\tfunction arc(x, y, radius, startAngle, endAngle){\n\t\tvar start = arcradius(x, y, radius, endAngle);\n\t\tvar end = arcradius(x, y, radius, startAngle);\n\t\tvar largeArcFlag = endAngle - startAngle <= 180 ? 0 : 1;\n\t\tvar d = ['M', start.x, start.y, 'A', radius, radius, 0, largeArcFlag, 0, end.x, end.y].join(' ');\n\t\treturn d;\n\t}\n\n\tself.redraw = function(width, value) {\n\n\t\tvar sum = null;\n\n\t\tfor (var i = 0, length = value.length; i < length; i++) {\n\t\t\tvar item = value[i];\n\n\t\t\tif (item.value == null)\n\t\t\t\titem.value = 0;\n\n\t\t\tvar val = item.value + 1;\n\t\t\tsum = sum ? sum + val : val;\n\t\t}\n\n\t\tvar count = 0;\n\t\tvar beg = 0;\n\t\tvar end = 0;\n\t\tvar items = [];\n\n\t\tfor (var i = 0, length = value.length; i < length; i++) {\n\t\t\tvar item = value[i];\n\t\t\tvar p = (((item.value + 1) / sum) * 100).floor(2);\n\n\t\t\tcount += p;\n\n\t\t\tif (i === length - 1 && count < 100)\n\t\t\t\tp = p + (100 - count);\n\n\t\t\tend = beg + ((360 / 100) * p);\n\t\t\titems.push({ name: item.name, percentage: p, beg: beg, end: end });\n\t\t\tbeg = end;\n\t\t}\n\n\t\tif (!force && NOTMODIFIED(self.id, items))\n\t\t\treturn;\n\n\t\tvar size = width;\n\t\tvar half = size / 2;\n\t\tvar midpoint = size / 2.4;\n\n\t\tstrokew = (size / 6 >> 0).inc('-15%');\n\n\t\tsvg.attr('width', size);\n\t\tsvg.attr('height', size);\n\t\tg.empty();\n\n\t\tvar pieces = [];\n\n\t\tfor (var i = 0, length = items.length; i < length; i++) {\n\t\t\tvar item = items[i];\n\t\t\tif (item.percentage === 0)\n\t\t\t\tcontinue;\n\t\t\tif (item.end === 360)\n\t\t\t\titem.end = 359.99;\n\t\t\tpieces.push(g.asvg('path').attr('data-index', i).attr('data-beg', item.beg).attr('data-end', item.end).attr('stroke-width', strokew).attr('class', 'piece piece' + (i + 1)).attr('d', arc(half, half, midpoint, item.beg, animate ? item.beg : item.end)));\n\t\t}\n\n\t\tanimate && pieces.wait(function(item, next) {\n\t\t\tvar beg = +item.attrd('beg');\n\t\t\tvar end = +item.attrd('end');\n\t\t\tvar diff = end - beg;\n\n\t\t\tif (config.animate) {\n\t\t\t\titem.animate({ end: diff }, { duration: 180, step: function(fx) {\n\t\t\t\t\titem.attr('d', arc(half, half, midpoint, beg, beg + fx));\n\t\t\t\t}, complete: function() {\n\t\t\t\t\tnext();\n\t\t\t\t}});\n\t\t\t} else {\n\t\t\t\titem.attr('d', arc(half, half, midpoint, beg, end));\n\t\t\t\tnext();\n\t\t\t}\n\t\t});\n\n\t\tselected = null;\n\t\tanimate = true;\n\t\tforce = false;\n\n\t\tconfig.redraw && EXEC(config.redraw);\n\n\t\tself.select(0);\n\t\tif (config.presentation) {\n\t\t\tindexerskip = false;\n\t\t\tsetTimeout(self.next, 4000);\n\t\t}\n\t};\n\n\tself.setter = function(value) {\n\n\t\tif (!value) {\n\t\t\tg.empty();\n\t\t\treturn;\n\t\t}\n\n\t\tif (config.size) {\n\t\t\tself.redraw(config.size, value);\n\t\t} else {\n\t\t\tself.width(function(width) {\n\t\t\t\tself.redraw(width, value);\n\t\t\t});\n\t\t}\n\t};\n});\n\nCOMPONENT('tabmenu', 'class:selected', function(self, config) {\n\tvar old, oldtab;\n\n\tself.readonly();\n\tself.nocompile();\n\n\tself.make = function() {\n\t\tself.event('click', 'li', function() {\n\t\t\tvar el = $(this);\n\t\t\t!el.hclass(config.class) && self.set(el.attrd('value'), 2);\n\t\t});\n\t};\n\n\tself.setter = function(value) {\n\t\tif (old === value)\n\t\t\treturn;\n\t\toldtab && oldtab.rclass(config.class);\n\t\toldtab = self.find('li[data-value=\"' + value + '\"]').aclass(config.class);\n\t\told = value;\n\t};\n});\n\nCOMPONENT('error', function(self, config) {\n\n\tself.readonly();\n\tself.nocompile();\n\n\tself.make = function() {\n\t\tself.aclass('ui-error hidden');\n\t};\n\n\tself.setter = function(value) {\n\n\t\tif (!(value instanceof Array) || !value.length) {\n\t\t\tself.tclass('hidden', true);\n\t\t\treturn;\n\t\t}\n\n\t\tvar builder = [];\n\t\tfor (var i = 0, length = value.length; i < length; i++)\n\t\t\tbuilder.push('<div><span class=\"fa {1}\"></span>{0}</div>'.format(value[i].error, 'fa-' + (config.icon || 'times-circle')));\n\n\t\tself.html(builder.join(''));\n\t\tself.tclass('hidden', false);\n\t};\n});\n\nCOMPONENT('barchart', 'pl:20;pt:10;pb:25;prselected:0;axisX:true;axisY:true;paddingbars:5;limit:0;paddinggroup:10;radius:2;offsetX:10;offsetY:10;templateY:{{ value | format(0) }};templateX:{{ value }};height:0', function(self, config) {\n\n\tvar svg, g, axis, selected;\n\tvar templateX, templateY;\n\tvar W = $(window);\n\n\tself.readonly();\n\tself.nocompile();\n\n\tself.make = function() {\n\t\tself.aclass('ui-barchart');\n\t\tself.empty().append('<svg></svg>');\n\t\tsvg = self.find('svg');\n\t\taxis = svg.asvg('g').attr('class', 'axisy');\n\t\tg = svg.asvg('g').attr('class', 'bars');\n\t\tselected = svg.asvg('text').attr('class', 'selected').attr('text-anchor', 'end');\n\t\tW.on('resize', self.resize);\n\n\t\tself.event('click mouseenter', 'rect', function(e) {\n\t\t\tvar rect = $(this);\n\t\t\tvar index = rect.attrd('index');\n\n\t\t\tif (index === self.$selectedindex && e.type === 'mouseenter')\n\t\t\t\treturn;\n\n\t\t\tself.$selectedindex = index;\n\t\t\tvar arr = index.split(',');\n\t\t\tvar item = self.get()[+arr[0]];\n\t\t\tvar value = item.values[+arr[1]];\n\t\t\tselected.text(templateY({ value: value.y }));\n\t\t\tif (e.type === 'mouseenter') {\n\t\t\t\tsetTimeout2(self.id, function() {\n\t\t\t\t\tselected.text('');\n\t\t\t\t}, 2000);\n\t\t\t} else\n\t\t\t\tclearTimeout2(self.id);\n\t\t});\n\n\t};\n\n\tself.destroy = function() {\n\t\tW.off('resize', self.resize);\n\t};\n\n\tself.resize = function() {\n\t\tsetTimeout2('resize.' + self.id, function() {\n\t\t\tself.refresh();\n\t\t}, 500);\n\t};\n\n\tself.configure = function(key, value, init) {\n\t\tswitch (key) {\n\t\t\tcase 'templateX':\n\t\t\t\ttemplateX = Tangular.compile(value);\n\t\t\t\tbreak;\n\t\t\tcase 'templateY':\n\t\t\t\ttemplateY = Tangular.compile(value);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\t!init && self.resize();\n\t\t\t\tbreak;\n\t\t}\n\t};\n\n\tself.released = function(is) {\n\t\t!is && setTimeout(self.refresh, 1000);\n\t};\n\n\tself.setter = function(value) {\n\n\t\tif (!self.element[0].offsetParent) {\n\t\t\tsetTimeout(function() {\n\t\t\t\tself.refresh();\n\t\t\t}, 1000);\n\t\t\treturn;\n\t\t}\n\n\t\tif (!value) {\n\t\t\tg.empty();\n\t\t\treturn;\n\t\t}\n\n\t\tvar maxX = 0;\n\t\tvar maxY = 0;\n\t\tvar labels = [];\n\t\tvar paddingbars = config.paddingbars;\n\t\tvar paddinggroup = config.paddinggroup;\n\t\tvar len = value.length;\n\t\tvar size = value[0].values.length;\n\t\tvar width = config.width ? config.width : self.element.width();\n\t\tvar height = config.height ? config.height : (width / 100) * 60;\n\t\tvar barwidth = ((width - paddingbars - paddinggroup - config.pl) / (size * len));\n\t\tvar lines = {};\n\n\t\tbarwidth -= paddingbars + (paddinggroup / len);\n\n\t\tfor (var i = 0; i < len; i++) {\n\t\t\tvar item = value[i];\n\t\t\tlabels.push(item.name);\n\t\t\tfor (var j = 0, length = item.values.length; j < length; j++) {\n\t\t\t\tvar val = item.values[j];\n\t\t\t\tmaxX = Math.max(maxX, val.x);\n\t\t\t\tmaxY = Math.max(maxY, val.y);\n\t\t\t}\n\t\t}\n\n\t\tif (config.limit)\n\t\t\tmaxY = config.limit;\n\n\t\tsvg.attr('width', width);\n\t\tsvg.attr('height', height);\n\n\t\tselected.attr('transform', 'translate({0},30)'.format(width - config.prselected));\n\n\t\tg.empty();\n\t\taxis.empty();\n\n\t\tlines.height = height - config.pt - config.pb;\n\n\t\tvar T = { value: null };\n\n\t\tfor (var i = 5; i > 0; i--) {\n\t\t\tvar val = i * 20;\n\t\t\tvar y = (((lines.height / 100) * val) + config.pt);\n\t\t\tconfig.axisY && axis.asvg('line').attr('x1', 0).attr('x2', width).attr('y1', y).attr('y2', y).attr('class', 'axis');\n\t\t\tT.value = (maxY / 100) * (100 - val);\n\t\t\taxis.asvg('text').aclass('ylabel').attr('transform', 'translate({0},{1})'.format(config.offsetX, y - config.offsetY)).text(templateY(T));\n\t\t}\n\n\t\tvar offsetX = config.pl + paddingbars + paddinggroup;\n\t\tvar posX = 0;\n\t\tvar offsetL = (len - 1) === 0 ? 0.5 : len - 1;\n\t\tvar offsetY =  config.pb;\n\n\t\tfor (var i = 0, length = size; i < length; i++) {\n\n\t\t\tfor (var j = 0; j < len; j++) {\n\n\t\t\t\tvar item = value[j];\n\t\t\t\tvar val = item.values[i];\n\t\t\t\tvar rect = g.asvg('rect');\n\t\t\t\tvar y = ((val.y / maxY) * 100) >> 0;\n\t\t\t\tvar x = posX + (barwidth * j);\n\t\t\t\tvar h = lines.height.inc('{0}%'.format(y));\n\n\t\t\t\tx += offsetX + (paddingbars * j);\n\t\t\t\tT.value = val.y;\n\t\t\t\trect.attr('x', x).attr('y', ((lines.height - h) + (offsetY / 2)) - 3).attr('width', barwidth).attr('height', h).attr('class', 'bar bar' + (j + 1)).attr('data-index', j + ',' + i);\n\t\t\t\tconfig.radius && rect.attr('rx', config.radius).attr('ry', config.radius);\n\t\t\t}\n\n\t\t\tT.value = val.x;\n\t\t\tvar text = templateX(T);\n\t\t\tvar ax = posX + offsetX + (barwidth * len) + (paddingbars * len) + 2;\n\t\t\tconfig.axisX && axis.asvg('line').attr('x1', ax).attr('x2', ax).attr('y1', 0).attr('y2', height - 25).attr('class', 'axis');\n\t\t\tg.asvg('text').aclass('xlabel').text(text).attr('text-anchor', 'middle').attr('transform', 'translate({0},{1})'.format(posX + offsetX + (barwidth * offsetL), height - 6));\n\n\t\t\tposX += (len * barwidth) + paddinggroup;\n\t\t\toffsetX += len * paddingbars;\n\t\t}\n\t};\n});\n\nCOMPONENT('shortcuts', function(self) {\n\n\tvar items = [];\n\tvar length = 0;\n\n\tself.singleton();\n\tself.readonly();\n\tself.blind();\n\tself.nocompile();\n\n\tself.make = function() {\n\t\t$(window).on('keydown', function(e) {\n\t\t\tif (length && !e.isPropagationStopped()) {\n\t\t\t\tfor (var i = 0; i < length; i++) {\n\t\t\t\t\tvar o = items[i];\n\t\t\t\t\tif (o.fn(e)) {\n\t\t\t\t\t\tif (o.prevent) {\n\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t\te.stopPropagation();\n\t\t\t\t\t\t}\n\t\t\t\t\t\tsetTimeout(function(o, e) {\n\t\t\t\t\t\t\to.callback(e);\n\t\t\t\t\t\t}, 100, o, e);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t};\n\n\tself.exec = function(shortcut) {\n\t\tvar item = items.findItem('shortcut', shortcut.toLowerCase().replace(/\\s/g, ''));\n\t\titem && item.callback(EMPTYOBJECT);\n\t};\n\n\tself.register = function(shortcut, callback, prevent) {\n\t\tshortcut.split(',').trim().forEach(function(shortcut) {\n\t\t\tvar builder = [];\n\t\t\tvar alias = [];\n\t\t\tshortcut.split('+').trim().forEach(function(item) {\n\t\t\t\tvar lower = item.toLowerCase();\n\t\t\t\talias.push(lower);\n\t\t\t\tswitch (lower) {\n\t\t\t\t\tcase 'ctrl':\n\t\t\t\t\tcase 'alt':\n\t\t\t\t\tcase 'shift':\n\t\t\t\t\t\tbuilder.push('e.{0}Key'.format(lower));\n\t\t\t\t\t\treturn;\n\t\t\t\t\tcase 'win':\n\t\t\t\t\tcase 'meta':\n\t\t\t\t\tcase 'cmd':\n\t\t\t\t\t\tbuilder.push('e.metaKey');\n\t\t\t\t\t\treturn;\n\t\t\t\t\tcase 'space':\n\t\t\t\t\t\tbuilder.push('e.keyCode===32');\n\t\t\t\t\t\treturn;\n\t\t\t\t\tcase 'tab':\n\t\t\t\t\t\tbuilder.push('e.keyCode===9');\n\t\t\t\t\t\treturn;\n\t\t\t\t\tcase 'esc':\n\t\t\t\t\t\tbuilder.push('e.keyCode===27');\n\t\t\t\t\t\treturn;\n\t\t\t\t\tcase 'enter':\n\t\t\t\t\t\tbuilder.push('e.keyCode===13');\n\t\t\t\t\t\treturn;\n\t\t\t\t\tcase 'backspace':\n\t\t\t\t\tcase 'del':\n\t\t\t\t\tcase 'delete':\n\t\t\t\t\t\tbuilder.push('(e.keyCode===8||e.keyCode===127)');\n\t\t\t\t\t\treturn;\n\t\t\t\t\tcase 'up':\n\t\t\t\t\t\tbuilder.push('e.keyCode===38');\n\t\t\t\t\t\treturn;\n\t\t\t\t\tcase 'down':\n\t\t\t\t\t\tbuilder.push('e.keyCode===40');\n\t\t\t\t\t\treturn;\n\t\t\t\t\tcase 'right':\n\t\t\t\t\t\tbuilder.push('e.keyCode===39');\n\t\t\t\t\t\treturn;\n\t\t\t\t\tcase 'left':\n\t\t\t\t\t\tbuilder.push('e.keyCode===37');\n\t\t\t\t\t\treturn;\n\t\t\t\t\tcase 'f1':\n\t\t\t\t\tcase 'f2':\n\t\t\t\t\tcase 'f3':\n\t\t\t\t\tcase 'f4':\n\t\t\t\t\tcase 'f5':\n\t\t\t\t\tcase 'f6':\n\t\t\t\t\tcase 'f7':\n\t\t\t\t\tcase 'f8':\n\t\t\t\t\tcase 'f9':\n\t\t\t\t\tcase 'f10':\n\t\t\t\t\tcase 'f11':\n\t\t\t\t\tcase 'f12':\n\t\t\t\t\t\tvar a = item.toUpperCase();\n\t\t\t\t\t\tbuilder.push('e.key===\\'{0}\\''.format(a));\n\t\t\t\t\t\treturn;\n\t\t\t\t\tcase 'capslock':\n\t\t\t\t\t\tbuilder.push('e.which===20');\n\t\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tvar num = item.parseInt();\n\t\t\t\tif (num)\n\t\t\t\t\tbuilder.push('e.which===' + num);\n\t\t\t\telse\n\t\t\t\t\tbuilder.push('e.key===\\'{0}\\''.format(item));\n\n\t\t\t});\n\n\t\t\titems.push({ shortcut: alias.join('+'), fn: new Function('e', 'return ' + builder.join('&&')), callback: callback, prevent: prevent });\n\t\t\tlength = items.length;\n\t\t});\n\t\treturn self;\n\t};\n});\n\nCOMPONENT('preview', 'width:200;height:100;background:#FFFFFF;quality:90;schema:{file\\\\:base64,name\\\\:filename}', function(self, config) {\n\n\tvar empty, img, canvas, name, content = null;\n\n\tself.readonly();\n\tself.nocompile();\n\n\tself.configure = function(key, value, init) {\n\n\t\tif (init)\n\t\t\treturn;\n\n\t\tvar redraw = false;\n\n\t\tswitch (key) {\n\t\t\tcase 'width':\n\t\t\tcase 'height':\n\t\t\tcase 'background':\n\t\t\t\tsetTimeout2(self.id + 'reinit', self.reinit, 50);\n\t\t\t\tbreak;\n\t\t\tcase 'label':\n\t\t\tcase 'icon':\n\t\t\t\tredraw = true;\n\t\t\t\tbreak;\n\t\t}\n\n\t\tredraw && setTimeout2(self.id + 'redraw', function() {\n\t\t\tself.redraw();\n\t\t\tself.refresh();\n\t\t}, 50);\n\t};\n\n\tself.reinit = function() {\n\t\tcanvas = document.createElement('canvas');\n\t\tcanvas.width = config.width;\n\t\tcanvas.height = config.height;\n\t\tvar ctx = canvas.getContext('2d');\n\t\tctx.fillStyle = config.background;\n\t\tctx.fillRect(0, 0, config.width, config.height);\n\t\tempty = canvas.toDataURL('image/png');\n\t\tcanvas = null;\n\t};\n\n\tself.resize = function(image) {\n\t\tvar canvas = document.createElement('canvas');\n\t\tvar ctx = canvas.getContext('2d');\n\t\tcanvas.width = config.width;\n\t\tcanvas.height = config.height;\n\t\tctx.fillStyle = config.background;\n\t\tctx.fillRect(0, 0, config.width, config.height);\n\n\t\tvar w = 0;\n\t\tvar h = 0;\n\t\tvar x = 0;\n\t\tvar y = 0;\n\n\t\tif (image.width < config.width && image.height < config.height) {\n\t\t\tw = image.width;\n\t\t\th = image.height;\n\t\t\tx = (config.width / 2) - (image.width / 2);\n\t\t\ty = (config.height / 2) - (image.height / 2);\n\t\t} else if (image.width >= image.height) {\n\t\t\tw = config.width;\n\t\t\th = image.height * (config.width / image.width);\n\t\t\ty = (config.height / 2) - (h / 2);\n\t\t} else {\n\t\t\th = config.height;\n\t\t\tw = (image.width * (config.height / image.height)) >> 0;\n\t\t\tx = (config.width / 2) - (w / 2);\n\t\t}\n\n\t\tctx.drawImage(image, x, y, w, h);\n\t\tvar base64 = canvas.toDataURL('image/jpeg', config.quality * 0.01);\n\t\timg.attr('src', base64);\n\t\tself.upload(base64);\n\t};\n\n\tself.redraw = function() {\n\t\tvar label = config.label || content;\n\t\tself.html((label ? '<div class=\"ui-preview-label\">{0}{1}:</div>'.format(config.icon ? '<i class=\"fa fa-{0}\"></i>'.format(config.icon) : '', label) : '') + '<input type=\"file\" accept=\"image/*\" class=\"hidden\" /><img src=\"{0}\" class=\"img-responsive\" alt=\"\" />'.format(empty, config.width, config.height));\n\t\timg = self.find('img');\n\t\timg.on('click', function() {\n\t\t\tself.find('input').trigger('click');\n\t\t});\n\t};\n\n\tself.make = function() {\n\n\t\tcontent = self.html();\n\t\tself.aclass('ui-preview');\n\t\tself.reinit();\n\t\tself.redraw();\n\n\t\tself.event('change', 'input', function() {\n\t\t\tvar reader = new FileReader();\n\t\t\treader.onload = function () {\n\t\t\t\tvar image = new Image();\n\t\t\t\timage.onload = function() {\n\t\t\t\t\tself.resize(image);\n\t\t\t\t};\n\t\t\t\timage.src = reader.result;\n\t\t\t};\n\t\t\tvar file = this.files[0];\n\t\t\tname = file.name;\n\t\t\treader.readAsDataURL(file);\n\t\t\tthis.value = '';\n\t\t});\n\n\t\tself.event('dragenter dragover dragexit drop dragleave', function (e) {\n\n\t\t\te.stopPropagation();\n\t\t\te.preventDefault();\n\n\t\t\tswitch (e.type) {\n\t\t\t\tcase 'drop':\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'dragenter':\n\t\t\t\tcase 'dragover':\n\t\t\t\t\treturn;\n\t\t\t\tcase 'dragexit':\n\t\t\t\tcase 'dragleave':\n\t\t\t\tdefault:\n\t\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar dt = e.originalEvent.dataTransfer;\n\t\t\tif (dt && dt.files.length) {\n\t\t\t\tvar reader = new FileReader();\n\t\t\t\treader.onload = function () {\n\t\t\t\t\tvar image = new Image();\n\t\t\t\t\timage.onload = function() {\n\t\t\t\t\t\tself.resize(image);\n\t\t\t\t\t};\n\t\t\t\t\timage.src = reader.result;\n\t\t\t\t};\n\t\t\t\tvar file = e.originalEvent.dataTransfer.files[0];\n\t\t\t\tname = file.name;\n\t\t\t\treader.readAsDataURL(file);\n\t\t\t}\n\t\t});\n\t};\n\n\tself.upload = function(base64) {\n\t\tif (base64) {\n\t\t\tvar data = (new Function('base64', 'filename', 'return ' + config.schema))(base64, name);\n\t\t\tSETTER('loading', 'show');\n\t\t\tAJAX('POST ' + config.url.env(true), data, function(response, err) {\n\t\t\t\tSETTER('loading', 'hide', 100);\n\t\t\t\tif (err) {\n\t\t\t\t\tSETTER('snackbar', 'warning', err.toString());\n\t\t\t\t} else {\n\t\t\t\t\tself.change(true);\n\t\t\t\t\tself.set(response);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t};\n\n\tself.setter = function(value) {\n\t\timg.attr('src', value ? value : empty);\n\t};\n});\n\nCOMPONENT('features', 'height:37', function(self, config) {\n\n\tvar container, timeout, input, search, scroller = null;\n\tvar is = false, results = false, selectedindex = 0, resultscount = 0;\n\n\tself.oldsearch = '';\n\tself.items = null;\n\tself.template = Tangular.compile('<li data-search=\"{{ $.search }}\" data-index=\"{{ $.index }}\"{{ if selected }} class=\"selected\"{{ fi }}>{{ if icon }}<i class=\"fa fa-{{ icon }}\"></i>{{ fi }}{{ name | raw }}</li>');\n\tself.callback = null;\n\tself.readonly();\n\tself.singleton();\n\tself.nocompile();\n\n\tself.configure = function(key, value, init) {\n\t\tif (init)\n\t\t\treturn;\n\t\tswitch (key) {\n\t\t\tcase 'placeholder':\n\t\t\t\tself.find('input').prop('placeholder', value);\n\t\t\t\tbreak;\n\t\t}\n\t};\n\n\tself.make = function() {\n\n\t\tself.aclass('ui-features-layer hidden');\n\t\tself.append('<div class=\"ui-features\"><div class=\"ui-features-search\"><span><i class=\"fa fa-search\"></i></span><div><input type=\"text\" placeholder=\"{0}\" class=\"ui-features-search-input\" /></div></div><div class=\"ui-features-container\"><ul></ul></div></div>'.format(config.placeholder));\n\n\t\tcontainer = self.find('ul');\n\t\tinput = self.find('input');\n\t\tsearch = self.find('.ui-features');\n\t\tscroller = self.find('.ui-features-container');\n\n\t\tself.event('touchstart mousedown', 'li[data-index]', function(e) {\n\t\t\tself.callback && self.callback(self.items[+this.getAttribute('data-index')]);\n\t\t\tself.hide();\n\t\t\te.preventDefault();\n\t\t\te.stopPropagation();\n\t\t});\n\n\t\t$(document).on('touchstart mousedown', function(e) {\n\t\t\tis && !$(e.target).hclass('ui-features-search-input') && self.hide(0);\n\t\t});\n\n\t\t$(window).on('resize', function() {\n\t\t\tis && self.hide(0);\n\t\t});\n\n\t\tself.event('keydown', 'input', function(e) {\n\t\t\tvar o = false;\n\t\t\tswitch (e.which) {\n\t\t\t\tcase 27:\n\t\t\t\t\to = true;\n\t\t\t\t\tself.hide();\n\t\t\t\t\tbreak;\n\t\t\t\tcase 13:\n\t\t\t\t\to = true;\n\t\t\t\t\tvar sel = self.find('li.selected');\n\t\t\t\t\tif (sel.length && self.callback)\n\t\t\t\t\t\tself.callback(self.items[+sel.attr('data-index')]);\n\t\t\t\t\tself.hide();\n\t\t\t\t\tbreak;\n\t\t\t\tcase 38: // up\n\t\t\t\t\to = true;\n\t\t\t\t\tselectedindex--;\n\t\t\t\t\tif (selectedindex < 0)\n\t\t\t\t\t\tselectedindex = 0;\n\t\t\t\t\telse\n\t\t\t\t\t\tself.move();\n\t\t\t\t\tbreak;\n\t\t\t\tcase 40: // down\n\t\t\t\t\to = true;\n\t\t\t\t\tselectedindex++ ;\n\t\t\t\t\tif (selectedindex >= resultscount)\n\t\t\t\t\t\tselectedindex = resultscount;\n\t\t\t\t\telse\n\t\t\t\t\t\tself.move();\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (o && results) {\n\t\t\t\te.preventDefault();\n\t\t\t\te.stopPropagation();\n\t\t\t}\n\t\t});\n\n\t\tself.event('keyup', 'input', function() {\n\t\t\tsetTimeout2(self.id, self.search, 100, null, this.value);\n\t\t});\n\t};\n\n\tself.search = function(value) {\n\n\t\tif (!value) {\n\t\t\tif (self.oldsearch === value)\n\t\t\t\treturn;\n\t\t\tself.oldsearch = value;\n\t\t\tselectedindex = 0;\n\t\t\tresults = true;\n\t\t\tresultscount = self.items.length;\n\t\t\tcontainer.find('li').rclass('hidden selected');\n\t\t\tself.move();\n\t\t\treturn;\n\t\t}\n\n\t\tif (self.oldsearch === value)\n\t\t\treturn;\n\n\t\tself.oldsearch = value;\n\t\tvalue = value.toSearch().split(' ');\n\t\tresults = false;\n\t\tresultscount = 0;\n\t\tselectedindex = 0;\n\n\t\tcontainer.find('li').each(function() {\n\t\t\tvar el = $(this);\n\t\t\tvar val = el.attr('data-search');\n\t\t\tvar h = false;\n\n\t\t\tfor (var i = 0; i < value.length; i++) {\n\t\t\t\tif (val.indexOf(value[i]) === -1) {\n\t\t\t\t\th = true;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (!h) {\n\t\t\t\tresults = true;\n\t\t\t\tresultscount++;\n\t\t\t}\n\n\t\t\tel.tclass('hidden', h);\n\t\t\tel.rclass('selected');\n\t\t});\n\t\tself.move();\n\t};\n\n\tself.move = function() {\n\t\tvar counter = 0;\n\t\tvar h = scroller.css('max-height').parseInt();\n\n\t\tcontainer.find('li').each(function() {\n\t\t\tvar el = $(this);\n\t\t\tif (el.hclass('hidden'))\n\t\t\t\treturn;\n\t\t\tvar is = selectedindex === counter;\n\t\t\tel.tclass('selected', is);\n\t\t\tif (is) {\n\t\t\t\tvar t = (config.height * counter) - config.height;\n\t\t\t\tif ((t + config.height * 5) > h)\n\t\t\t\t\tscroller.scrollTop(t);\n\t\t\t\telse\n\t\t\t\t\tscroller.scrollTop(0);\n\t\t\t}\n\t\t\tcounter++;\n\t\t});\n\t};\n\n\tself.show = function(items, callback) {\n\n\t\tif (is) {\n\t\t\tclearTimeout(timeout);\n\t\t\tself.hide(0);\n\t\t\treturn;\n\t\t}\n\n\t\tvar type = typeof(items);\n\t\tvar item;\n\n\t\tif (type === 'string')\n\t\t\titems = self.get(items);\n\n\t\tif (!items) {\n\t\t\tself.hide(0);\n\t\t\treturn;\n\t\t}\n\n\t\tself.items = items;\n\t\tself.callback = callback;\n\t\tresults = true;\n\t\tresultscount = self.items.length;\n\n\t\tinput.val('');\n\n\t\tvar builder = [];\n\t\tvar indexer = {};\n\n\t\tfor (var i = 0, length = items.length; i < length; i++) {\n\t\t\titem = items[i];\n\t\t\tindexer.index = i;\n\t\t\tindexer.search = (item.name + ' ' + (item.keywords || '')).trim().toSearch();\n\t\t\t!item.value && (item.value = item.name);\n\t\t\tbuilder.push(self.template(item, indexer));\n\t\t}\n\n\t\tcontainer.html(builder);\n\n\t\tvar W = $(window);\n\t\tvar top = ((W.height() / 2) - (search.height() / 2)) - scroller.css('max-height').parseInt();\n\t\tvar options = { top: top, left: (W.width() / 2) - (search.width() / 2) };\n\n\t\tsearch.css(options);\n\t\tself.move();\n\n\t\tif (is)\n\t\t\treturn;\n\n\t\tself.rclass('hidden');\n\n\t\tsetTimeout(function() {\n\t\t\tself.aclass('ui-features-visible');\n\t\t}, 100);\n\n\t\t!isMOBILE && setTimeout(function() {\n\t\t\tinput.focus();\n\t\t}, 500);\n\n\t\tis = true;\n\t\t$('html,body').aclass('ui-features-noscroll');\n\t};\n\n\tself.hide = function(sleep) {\n\t\tif (!is)\n\t\t\treturn;\n\t\tclearTimeout(timeout);\n\t\ttimeout = setTimeout(function() {\n\t\t\tself.aclass('hidden').rclass('ui-features-visible');\n\t\t\tself.callback = null;\n\t\t\tself.target = null;\n\t\t\tis = false;\n\t\t\t$('html,body').rclass('ui-features-noscroll');\n\t\t}, sleep ? sleep : 100);\n\t};\n});\n\nCOMPONENT('listing', 'pages:3;count:20', function(self, config) {\n\n\tvar container, paginate, current, items, pages = 0;\n\tvar layout;\n\n\tself.readonly();\n\tself.nocompile();\n\n\tself.make = function() {\n\n\t\tself.find('script').each(function(index) {\n\t\t\tvar T =  Tangular.compile(this.innerHTML);\n\t\t\tif (index)\n\t\t\t\tlayout = T;\n\t\t\telse\n\t\t\t\tself.template = T;\n\t\t});\n\n\t\tself.aclass('ui-listing');\n\t\tself.html('<div class=\"ui-listing-container\"></div><div class=\"ui-listing-paginate\"></div>');\n\t\tcontainer = self.find('.ui-listing-container');\n\t\tpaginate = self.find('.ui-listing-paginate');\n\t\tpaginate.on('click', 'button', function() {\n\t\t\tvar index = $(this).attrd('index');\n\t\t\tswitch (index) {\n\t\t\t\tcase '+':\n\t\t\t\t\tindex = current + 1;\n\t\t\t\t\tif (index > pages)\n\t\t\t\t\t\tindex = 1;\n\t\t\t\t\tbreak;\n\t\t\t\tcase '-':\n\t\t\t\t\tindex = current - 1;\n\t\t\t\t\tif (index < 1)\n\t\t\t\t\t\tindex = pages;\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tindex = +index;\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\tself.page(index);\n\t\t});\n\t};\n\n\tself.page = function(index) {\n\n\t\tvar builder = [];\n\t\tvar arr = items.takeskip(config.count, (index - 1) * config.count);\n\t\tvar g = { count: items.length, page: index, pages: pages };\n\n\t\tfor (var i = 0; i < arr.length; i++) {\n\t\t\tg.index = i;\n\t\t\tbuilder.push(self.template(arr[i], g));\n\t\t}\n\n\t\tcurrent = index;\n\t\tself.paginate(items.length, index);\n\t\tcontainer.html(layout ? layout({ page: index, pages: pages, body: builder.join(''), count: items.length }) : builder.join(''));\n\t};\n\n\tself.paginate = function(count, page) {\n\n\t\tvar max = config.pages;\n\t\tvar half = Math.ceil(max / 2);\n\n\t\tpages = Math.ceil(count / config.count);\n\n\t\tvar pfrom = page - half;\n\t\tvar pto = page + half;\n\t\tvar plus = 0;\n\n\t\tif (pfrom <= 0) {\n\t\t\tplus = Math.abs(pfrom);\n\t\t\tpfrom = 1;\n\t\t\tpto += plus;\n\t\t}\n\n\t\tif (pto >= pages) {\n\t\t\tpto = pages;\n\t\t\tpfrom = pages - max;\n\t\t}\n\n\t\tif (pfrom <= 0)\n\t\t\tpfrom = 1;\n\n\t\tif (page < half + 1) {\n\t\t\tpto++;\n\t\t\tif (pto > pages)\n\t\t\t\tpto--;\n\t\t}\n\n\t\tif (page < 2) {\n\t\t\tvar template = '<button data-index=\"{0}\"><i class=\"fa fa-caret-{1}\"></i></button>';\n\t\t\tvar builder = [];\n\t\t\tbuilder.push(template.format('-', 'left'));\n\n\t\t\tfor (var i = pfrom; i < pto + 1; i++)\n\t\t\t\tbuilder.push('<button class=\"ui-listing-page\" data-index=\"{0}\">{0}</button>'.format(i));\n\n\t\t\tbuilder.push(template.format('+', 'right'));\n\t\t\tpaginate.html(builder.join(''));\n\t\t} else {\n\n\t\t\tvar max = half * 2 + 1;\n\t\t\tvar cur = (pto - pfrom) + 1;\n\n\t\t\tif (max > cur && pages > config.pages && pfrom > 1)\n\t\t\t\tpfrom--;\n\n\t\t\tpaginate.find('.ui-listing-page[data-index]').each(function(index) {\n\t\t\t\tvar page = pfrom + index;\n\t\t\t\t$(this).attrd('index', page).html(page);\n\t\t\t});\n\n\t\t}\n\n\t\tpaginate.find('.selected').rclass('selected');\n\t\tpaginate.find('.ui-listing-page[data-index=\"{0}\"]'.format(page)).aclass('selected');\n\t\tpaginate.tclass('hidden', pages < 2);\n\t\tself.tclass('hidden', count === 0);\n\t};\n\n\tself.setter = function(value) {\n\t\tif (value) {\n\t\t\titems = value;\n\t\t\tself.page(1);\n\t\t} else {\n\t\t\titems = null;\n\t\t\tcontainer.empty();\n\t\t\tpaginate.empty();\n\t\t}\n\t};\n});\n\nCOMPONENT('autocomplete', 'height:200', function(self, config) {\n\n\tvar container, old, onSearch, searchtimeout, searchvalue, blurtimeout, onCallback, datasource, offsetter, scroller;\n\tvar is = false;\n\tvar margin = {};\n\tvar prev;\n\tvar skipmouse = false;\n\n\tself.template = Tangular.compile('<li{{ if index === 0 }} class=\"selected\"{{ fi }} data-index=\"{{ index }}\"><span>{{ name }}</span><span>{{ type }}</span></li>');\n\tself.readonly();\n\tself.singleton();\n\tself.nocompile();\n\n\tself.make = function() {\n\t\tself.aclass('ui-autocomplete-container hidden');\n\t\tself.html('<div class=\"ui-autocomplete\"><ul></ul></div>');\n\n\t\tscroller = self.find('.ui-autocomplete');\n\t\tcontainer = self.find('ul');\n\n\t\tself.event('click', 'li', function(e) {\n\t\t\te.preventDefault();\n\t\t\te.stopPropagation();\n\t\t\tif (onCallback) {\n\t\t\t\tvar val = datasource[+$(this).attrd('index')];\n\t\t\t\tif (typeof(onCallback) === 'string')\n\t\t\t\t\tSET(onCallback, val.value === undefined ? val.name : val.value);\n\t\t\t\telse\n\t\t\t\t\tonCallback(val, old);\n\t\t\t}\n\t\t\tself.visible(false);\n\t\t});\n\n\t\tself.event('mouseenter mouseleave', 'li', function(e) {\n\t\t\tif (!skipmouse) {\n\t\t\t\tprev && prev.rclass('selected');\n\t\t\t\tprev = $(this).tclass('selected', e.type === 'mouseenter');\n\t\t\t}\n\t\t});\n\n\t\t$(document).on('click', function() {\n\t\t\tis && self.visible(false);\n\t\t});\n\n\t\t$(window).on('resize', function() {\n\t\t\tself.resize();\n\t\t});\n\t};\n\n\tself.prerender = function(value) {\n\t\tself.render(value);\n\t};\n\n\tself.configure = function(name, value) {\n\t\tswitch (name) {\n\t\t\tcase 'height':\n\t\t\t\tvalue && scroller.css('max-height', value);\n\t\t\t\tbreak;\n\t\t}\n\t};\n\n\tfunction keydown(e) {\n\t\tvar c = e.which;\n\t\tvar input = this;\n\n\t\tif (c !== 38 && c !== 40 && c !== 13) {\n\t\t\tif (c !== 8 && c < 32)\n\t\t\t\treturn;\n\t\t\tclearTimeout(searchtimeout);\n\t\t\tsearchtimeout = setTimeout(function() {\n\t\t\t\tvar val = input.value;\n\t\t\t\tif (!val)\n\t\t\t\t\treturn self.render(EMPTYARRAY);\n\t\t\t\tif (searchvalue === val)\n\t\t\t\t\treturn;\n\t\t\t\tsearchvalue = val;\n\t\t\t\tself.resize();\n\t\t\t\tonSearch(val, self.prerender);\n\t\t\t}, 200);\n\t\t\treturn;\n\t\t}\n\n\t\tif (!datasource || !datasource.length)\n\t\t\treturn;\n\n\t\tvar current = container.find('.selected');\n\t\tif (c === 13) {\n\t\t\tif (prev) {\n\t\t\t\tprev = null;\n\t\t\t\tself.visible(false);\n\t\t\t\tif (current.length) {\n\t\t\t\t\tif (onCallback) {\n\t\t\t\t\t\tvar val = datasource[+current.attrd('index')];\n\t\t\t\t\t\tif (typeof(onCallback) === 'string')\n\t\t\t\t\t\t\tSET(onCallback, val.value === undefined ? val.name : val.value);\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tonCallback(val, old);\n\t\t\t\t\t}\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\te.stopPropagation();\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\te.preventDefault();\n\t\te.stopPropagation();\n\n\t\tif (current.length) {\n\t\t\tcurrent.rclass('selected');\n\t\t\tcurrent = c === 40 ? current.next() : current.prev();\n\t\t}\n\n\t\tskipmouse = true;\n\t\t!current.length && (current = self.find('li:{0}-child'.format(c === 40 ? 'first' : 'last')));\n\t\tprev && prev.rclass('selected');\n\t\tprev = current.aclass('selected');\n\t\tvar index = +current.attrd('index');\n\t\tvar h = current.innerHeight();\n\t\tvar offset = ((index + 1) * h) + (h * 2);\n\t\tscroller.prop('scrollTop', offset > config.height ? offset - config.height : 0);\n\t\tsetTimeout2(self.ID + 'skipmouse', function() {\n\t\t\tskipmouse = false;\n\t\t}, 100);\n\t}\n\n\tfunction blur() {\n\t\tclearTimeout(blurtimeout);\n\t\tblurtimeout = setTimeout(function() {\n\t\t\tself.visible(false);\n\t\t}, 300);\n\t}\n\n\tself.visible = function(visible) {\n\t\tclearTimeout(blurtimeout);\n\t\tself.tclass('hidden', !visible);\n\t\tis = visible;\n\t};\n\n\tself.resize = function() {\n\n\t\tif (!offsetter || !old)\n\t\t\treturn;\n\n\t\tvar offset = offsetter.offset();\n\t\toffset.top += offsetter.height();\n\t\toffset.width = offsetter.width();\n\n\t\tif (margin.left)\n\t\t\toffset.left += margin.left;\n\t\tif (margin.top)\n\t\t\toffset.top += margin.top;\n\t\tif (margin.width)\n\t\t\toffset.width += margin.width;\n\n\t\tself.css(offset);\n\t};\n\n\tself.attach = function(input, search, callback, left, top, width) {\n\t\tself.attachelement(input, input, search, callback, left, top, width);\n\t};\n\n\tself.attachelement = function(element, input, search, callback, left, top, width) {\n\n\t\tif (typeof(callback) === 'number') {\n\t\t\twidth = left;\n\t\t\tleft = top;\n\t\t\ttop = callback;\n\t\t\tcallback = null;\n\t\t}\n\n\t\tclearTimeout(searchtimeout);\n\n\t\tif (input.setter)\n\t\t\tinput = input.find('input');\n\t\telse\n\t\t\tinput = $(input);\n\n\t\tif (input[0].tagName !== 'INPUT') {\n\t\t\tinput = input.find('input');\n\t\t}\n\n\t\tif (element.setter) {\n\t\t\tif (!callback)\n\t\t\t\tcallback = element.path;\n\t\t\telement = element.element;\n\t\t}\n\n\t\tif (old) {\n\t\t\told.removeAttr('autocomplete');\n\t\t\told.off('blur', blur);\n\t\t\told.off('keydown', keydown);\n\t\t}\n\n\t\tinput.on('keydown', keydown);\n\t\tinput.on('blur', blur);\n\t\tinput.attr({ 'autocomplete': 'off' });\n\n\t\told = input;\n\t\tmargin.left = left;\n\t\tmargin.top = top;\n\t\tmargin.width = width;\n\n\t\toffsetter = $(element);\n\t\tself.resize();\n\t\tself.refresh();\n\t\tsearchvalue = '';\n\t\tonSearch = search;\n\t\tonCallback = callback;\n\t\tself.visible(false);\n\t};\n\n\tself.render = function(arr) {\n\n\t\tdatasource = arr;\n\n\t\tif (!arr || !arr.length) {\n\t\t\tself.visible(false);\n\t\t\treturn;\n\t\t}\n\n\t\tvar builder = [];\n\t\tfor (var i = 0, length = arr.length; i < length; i++) {\n\t\t\tvar obj = arr[i];\n\t\t\tobj.index = i;\n\t\t\tif (!obj.name)\n\t\t\t\tobj.name = obj.text;\n\t\t\tbuilder.push(self.template(obj));\n\t\t}\n\n\t\tcontainer.empty().append(builder.join(''));\n\t\tskipmouse = true;\n\n\t\tsetTimeout(function() {\n\t\t\tscroller.prop('scrollTop', 0);\n\t\t\tskipmouse = false;\n\t\t}, 100);\n\n\t\tprev = container.find('.selected');\n\t\tself.visible(true);\n\t};\n});\n\nCOMPONENT('avatar', function(self) {\n\n\tvar backgrounds = '#1abc9c,#2ecc71,#3498db,#9b59b6,#34495e,#16a085,#2980b9,#8e44ad,#2c3e50,#f1c40f,#e67e22,#e74c3c,#d35400,#c0392b'.split(',');\n\tvar themes = {};\n\n\tself.readonly();\n\tself.singleton();\n\n\twindow.avatarerror = function(image) {\n\t\tvar img = $(image);\n\t\tvar el = img.parent()[0];\n\t\tel.$avatar = false;\n\t\tel.$avatarerror = true;\n\t\tel = $(el);\n\t\tel.attr('title', img.attr('title'));\n\t\tself.create(el);\n\t};\n\n\tself.rebind = function(el) {\n\t\tvar jq = el ? el.find('.avatar') : $('.avatar');\n\t\tjq.each(function() {\n\t\t\t!this.$avatar && self.create($(this));\n\t\t});\n\t};\n\n\tself.create = function(el) {\n\n\t\tvar theme = el.attrd('a') || el.attrd('avatar') || 'default';\n\t\tvar options = themes[theme];\n\t\tif (!options)\n\t\t\treturn false;\n\n\t\tvar url = el.attrd('a-url') || el.attrd('avatar-url');\n\t\tvar dom = el[0];\n\t\tvar name = dom.$avatarerror ? el.attr('title') : el.text();\n\n\t\tdom.$avatar = true;\n\n\t\tif (dom.$avatarerror) {\n\t\t\turl = '';\n\t\t} else {\n\t\t\tvar cls = el.attrd('a-class') || el.attrd('avatar-class') || options.class;\n\t\t\tcls && el.tclass(cls);\n\t\t}\n\n\t\tel.aclass('ui-avatar-theme-' + theme);\n\n\t\tif (url) {\n\t\t\tel.html('<img src=\"{0}\" alt=\"{1}\" title=\"{1}\" border=\"0\" onerror=\"avatarerror(this)\" />'.format(url, name));\n\t\t} else {\n\n\t\t\tvar arr = name.trim().split(' ');\n\t\t\tvar initials = ((arr[0] || '').substring(0, 1) + (arr[1] || '').substring(0, 1)).toUpperCase();\n\n\t\t\tvar css = {};\n\t\t\tvar can = false;\n\n\t\t\tif (!options.background) {\n\t\t\t\tcss.background = backgrounds[name.length % backgrounds.length];\n\t\t\t\tcan = true;\n\t\t\t}\n\n\t\t\tif (!options.color) {\n\t\t\t\tcan = true;\n\t\t\t\tcss.color = self.colorize(backgrounds[name.length % backgrounds.length], options.lighten);\n\t\t\t}\n\n\t\t\tcan && el.css(css);\n\t\t\tel.attr('title', name);\n\t\t\tel.html(initials);\n\t\t}\n\t};\n\n\tself.register = function(id, options) {\n\t\toptions = options.parseConfig('lighten:80;size:50;radius:100;weight:bold;font:Arial');\n\t\tthemes[id] = options;\n\t\tvar builder = [];\n\t\tvar name = '.ui-avatar-theme-' + id;\n\t\tbuilder.push('display:block;width:{0}px;height:{0}px;text-align:center;vertical-align:middle;font-style:normal;font-size:{1}px;line-height:{2}px'.format(options.size, Math.floor(options.size / 2.5), (options.size + Math.floor(options.size / 20))));\n\t\toptions.radius && builder.push('border-radius:{0}px'.format(options.radius));\n\t\toptions.weight && builder.push('font-weight:' + options.weight);\n\t\toptions.font && builder.push('font-family:' + options.font);\n\t\toptions.background && builder.push('background:' + options.background);\n\t\toptions.weight && builder.push('font-weight:{0}'.format(options.weight));\n\t\toptions.color && builder.push('color:' + options.color);\n\t\tvar css = name + '{' + builder.join(';') + '}';\n\t\tbuilder = [];\n\t\tbuilder.push('width:{0}px;height:{0}px;'.format(options.size));\n\t\toptions.radius && builder.push('border-radius:{0}px'.format(options.radius));\n\t\tcss += '\\n' + name + ' img{' + builder.join(';') + '}';\n\t\tCSS(css, 'avatar-' + id);\n\t\tsetTimeout2(self.id + 'rebind', self.rebind, 100, 5);\n\t};\n\n\tself.refresh = self.rebind;\n\n\tself.make = function() {\n\t\tself.register('default', '');\n\t\tself.on('component', function(component) {\n\t\t\tsetTimeout2(self._id, function() {\n\t\t\t\tcomponent.element && self.rebind(component.element);\n\t\t\t}, 150);\n\t\t});\n\t\tsetTimeout2(self._id + 'rebind', self.rebind, 100, 5);\n\t};\n\n\t// Thank to Chris Coyier (https://css-tricks.com/snippets/javascript/lighten-darken-color/)\n\t// LightenDarkenColor\n\tself.colorize = function(col, amt) {\n\t\tvar pound = false;\n\t\tif (col[0] == '#') {\n\t\t\tcol = col.slice(1);\n\t\t\tpound = true;\n\t\t}\n\t\tvar num = parseInt(col,16);\n\t\tvar r = (num >> 16) + amt;\n\t\tif (r > 255)\n\t\t\tr = 255;\n\t\telse if (r < 0) r = 0;\n\t\tvar b = ((num >> 8) & 0x00FF) + amt;\n\t\tif (b > 255)\n\t\t\tb = 255;\n\t\telse if (b < 0)\n\t\t\tb = 0;\n\t\tvar g = (num & 0x0000FF) + amt;\n\t\tif (g > 255)\n\t\t\tg = 255;\n\t\telse if (g < 0)\n\t\t\tg = 0;\n\t\treturn (pound ? '#': '') + (g | (b << 8) | (r << 16)).toString(16);\n\t};\n});\n\nCOMPONENT('importer', function(self, config) {\n\n\tvar init = false;\n\tvar clid = null;\n\n\tself.readonly();\n\tself.setter = function(value) {\n\n\t\tif (config.if !== value) {\n\t\t\tif (config.cleaner && init && !clid)\n\t\t\t\tclid = setTimeout(self.clean, config.cleaner * 60000);\n\t\t\treturn;\n\t\t}\n\n\t\tif (clid) {\n\t\t\tclearTimeout(clid);\n\t\t\tclid = null;\n\t\t}\n\n\t\tif (init) {\n\t\t\tconfig.reload && EXEC(config.reload);\n\t\t\treturn;\n\t\t}\n\n\t\tinit = true;\n\t\tself.import(config.url, function() {\n\t\t\tconfig.reload && EXEC(config.reload);\n\t\t});\n\t};\n\n\tself.clean = function() {\n\t\tconfig.clean && EXEC(config.clean);\n\t\tsetTimeout(function() {\n\t\t\tself.empty();\n\t\t\tinit = false;\n\t\t\tclid = null;\n\t\t}, 1000);\n\t};\n});\n\nCOMPONENT('part', 'hide:true', function(self, config) {\n\n\tvar init = false;\n\tvar clid = null;\n\n\tself.readonly();\n\tself.setter = function(value) {\n\n\t\tif (config.if !== value) {\n\t\t\tconfig.hidden && !self.hclass('hidden') && EXEC(config.hidden);\n\t\t\tconfig.hide && self.aclass('hidden');\n\t\t\tif (config.cleaner && init && !clid)\n\t\t\t\tclid = setTimeout(self.clean, config.cleaner * 60000);\n\t\t\treturn;\n\t\t}\n\n\t\tconfig.hide && self.rclass('hidden');\n\n\t\tif (self.element[0].hasChildNodes()) {\n\n\t\t\tif (clid) {\n\t\t\t\tclearTimeout(clid);\n\t\t\t\tclid = null;\n\t\t\t}\n\n\t\t\tconfig.reload && EXEC(config.reload);\n\t\t\tconfig.default && DEFAULT(config.default, true);\n\n\t\t} else {\n\t\t\tSETTER('loading', 'show');\n\t\t\tsetTimeout(function() {\n\t\t\t\tself.import(config.url, function() {\n\t\t\t\t\tif (!init) {\n\t\t\t\t\t\tconfig.init && EXEC(config.init);\n\t\t\t\t\t\tinit = true;\n\t\t\t\t\t}\n\t\t\t\t\tconfig.reload && EXEC(config.reload);\n\t\t\t\t\tconfig.default && DEFAULT(config.default, true);\n\t\t\t\t\tSETTER('loading', 'hide', 500);\n\t\t\t\t});\n\t\t\t}, 200);\n\t\t}\n\t};\n\n\tself.clean = function() {\n\t\tif (self.hclass('hidden')) {\n\t\t\tconfig.clean && EXEC(config.clean);\n\t\t\tsetTimeout(function() {\n\t\t\t\tself.element.empty();\n\t\t\t\tinit = false;\n\t\t\t\tclid = null;\n\t\t\t\tsetTimeout(FREE, 1000);\n\t\t\t}, 1000);\n\t\t}\n\t};\n});\n\nCOMPONENT('window', function(self, config) {\n\n\tvar W = window;\n\n\tif (!W.$$window) {\n\n\t\tW.$$window_level = W.$$window_level || 1;\n\t\tW.$$window = true;\n\n\t\t$(document).on('click', '.ui-window-button-close', function() {\n\t\t\tSET($(this).attrd('path'), '');\n\t\t});\n\n\t\t$(window).on('resize', function() {\n\t\t\tSETTER('window', 'resize');\n\t\t});\n\t}\n\n\tself.readonly();\n\n\tself.hide = function() {\n\t\tself.set('');\n\t};\n\n\tself.resize = function() {\n\t\tvar el = self.find('.ui-window-body');\n\t\tel.height(WH - self.find('.ui-window-header').height());\n\t};\n\n\tself.make = function() {\n\t\t$(document.body).append('<div id=\"{0}\" class=\"hidden ui-window-container\"><div class=\"ui-window\"><div data-bind=\"@config__change .ui-window-icon:@icon__html span:value.title\" class=\"ui-window-title\"><button class=\"ui-window-button-close{2}\" data-path=\"{1}\"><i class=\"fa fa-times\"></i></button><i class=\"ui-window-icon\"></i><span></span></div><div class=\"ui-window-header\"></div><div class=\"ui-window-body\"></div></div>'.format(self.ID, self.path, config.closebutton == false ? ' hidden' : ''));\n\t\tvar el = $('#' + self.ID);\n\t\tel.find('.ui-window-body')[0].appendChild(self.dom);\n\t\tself.rclass('hidden');\n\t\tself.replace(el);\n\t\tself.find('button').on('click', function() {\n\t\t\tswitch (this.name) {\n\t\t\t\tcase 'cancel':\n\t\t\t\t\tself.hide();\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t});\n\t};\n\n\tself.icon = function(value) {\n\t\tvar el = this.rclass2('fa');\n\t\tvalue.icon && el.aclass('fa fa-' + value.icon);\n\t};\n\n\tself.configure = function(key, value, init) {\n\t\tif (!init) {\n\t\t\tswitch (key) {\n\t\t\t\tcase 'closebutton':\n\t\t\t\t\tself.find('.ui-window-button-close').tclass(value !== true);\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t};\n\n\tself.setter = function(value) {\n\n\t\tsetTimeout2('ui-window-noscroll', function() {\n\t\t\t$('html').tclass('ui-window-noscroll', !!$('.ui-window-container').not('.hidden').length);\n\t\t}, 50);\n\n\t\tvar isHidden = value !== config.if;\n\n\t\tif (self.hclass('hidden') === isHidden)\n\t\t\treturn;\n\n\t\tsetTimeout2('windowreflow', function() {\n\t\t\tEMIT('reflow', self.name);\n\t\t}, 10);\n\n\t\tif (isHidden) {\n\t\t\tself.aclass('hidden');\n\t\t\tself.release(true);\n\t\t\tself.find('.ui-window').rclass('ui-window-animate');\n\t\t\tW.$$window_level--;\n\t\t\treturn;\n\t\t}\n\n\t\tif (W.$$window_level < 1)\n\t\t\tW.$$window_level = 1;\n\n\t\tW.$$window_level++;\n\n\t\tvar body = self.find('.ui-window-body');\n\n\t\tself.css('z-index', W.$$window_level * 11);\n\t\tbody.scrollTop(0);\n\t\tself.rclass('hidden');\n\t\tself.release(false);\n\t\tself.resize();\n\n\t\tconfig.reload && EXEC(config.reload, self);\n\t\tconfig.default && DEFAULT(config.default, true);\n\n\t\tif (!isMOBILE && config.autofocus) {\n\t\t\tvar el = self.find(config.autofocus === true ? 'input[type=\"text\"],select,textarea' : config.autofocus);\n\t\t\tel.length && el[0].focus();\n\t\t}\n\n\t\tsetTimeout(function() {\n\t\t\tbody.scrollTop(0);\n\t\t\tself.find('.ui-window').aclass('ui-window-animate');\n\t\t}, 300);\n\n\t\t// Fixes a problem with freezing of scrolling in Chrome\n\t\tsetTimeout2(self.id, function() {\n\t\t\tself.css('z-index', (W.$$window_level * 10) + 1);\n\t\t}, 500);\n\t};\n});"], "fixing_code": ["COMPONENT('exec', function(self, config) {\n\tself.readonly();\n\tself.blind();\n\tself.make = function() {\n\t\tself.event('click', config.selector || '.exec', function(e) {\n\t\t\tvar el = $(this);\n\n\t\t\tvar attr = el.attrd('exec');\n\t\t\tvar path = el.attrd('path');\n\t\t\tvar href = el.attrd('href');\n\n\t\t\tif (el.attrd('prevent') === 'true') {\n\t\t\t\te.preventDefault();\n\t\t\t\te.stopPropagation();\n\t\t\t}\n\n\t\t\tattr && EXEC(attr, el, e);\n\t\t\thref && NAV.redirect(href);\n\n\t\t\tif (path) {\n\t\t\t\tvar val = el.attrd('value');\n\t\t\t\tif (val == null) {\n\t\t\t\t\tvar a = new Function('return ' + el.attrd('value-a'))();\n\t\t\t\t\tvar b = new Function('return ' + el.attrd('value-b'))();\n\t\t\t\t\tvar v = GET(path);\n\t\t\t\t\tif (v === a)\n\t\t\t\t\t\tSET(path, b, true);\n\t\t\t\t\telse\n\t\t\t\t\t\tSET(path, a, true);\n\t\t\t\t} else\n\t\t\t\t\tSET(path, new Function('return ' + val)(), true);\n\t\t\t}\n\t\t});\n\t};\n});\n\nCOMPONENT('loading', function(self) {\n\tvar pointer;\n\n\tself.readonly();\n\tself.singleton();\n\tself.nocompile();\n\n\tself.make = function() {\n\t\tself.aclass('ui-loading');\n\t\tself.append('<div></div>');\n\t};\n\n\tself.show = function() {\n\t\tclearTimeout(pointer);\n\t\tself.rclass('hidden');\n\t\treturn self;\n\t};\n\n\tself.hide = function(timeout) {\n\t\tclearTimeout(pointer);\n\t\tpointer = setTimeout(function() {\n\t\t\tself.aclass('hidden');\n\t\t}, timeout || 1);\n\t\treturn self;\n\t};\n});\n\nCOMPONENT('grid', 'filter:true;external:false;fillcount:50;filterlabel:Filtering values ...;boolean:true|on|yes;pluralizepages:# pages,# page,# pages,# pages;pluralizeitems:# items,# item,# items,# items;pagination:false;rowheight:32', function(self, config) {\n\n\tvar tbody, thead, tbodyhead, container, pagination;\n\tvar options = { columns: {}, items: [], indexer: 0, filter: {} };\n\tvar isFilter = false;\n\tvar ppages, pitems, cache, eheight, wheight, scroll, filtercache, filled = false;\n\n\tself.template = Tangular.compile('<td data-index=\"{{ index }}\"{{ if $.cls }} class=\"{{ $.cls }}\"{{ fi }}><div class=\"wrap{{ if align }} {{ align }}{{ fi }}\"{{ if background }} style=\"background-color:{{ background }}\"{{ fi }}>{{ value | raw }}</div></td>');\n\tself.options = options;\n\tself.readonly();\n\tself.nocompile();\n\n\tself.make = function() {\n\n\t\tvar meta = self.find('script').html();\n\t\tself.aclass('ui-grid-container' + (config.autosize ? '' : ' hidden'));\n\t\tself.html('<div class=\"ui-grid\"><table class=\"ui-grid-header\"><thead></thead></table><div class=\"ui-grid-scroller\"><table class=\"ui-grid-data\"><thead></thead><tbody></tbody></table></div></div>' + (config.pagination ? '<div class=\"ui-grid-footer hidden\"><div class=\"ui-grid-meta\"></div><div class=\"ui-grid-pagination\"><button class=\"ui-grid-button\" name=\"first\"><i class=\"fa fa-angle-double-left\"></i></button><button class=\"ui-grid-button\" name=\"prev\"><i class=\"fa fa-angle-left\"></i></button><div class=\"page\"><input type=\"text\" maxlength=\"5\" class=\"ui-grid-input\" /></div><button class=\"ui-grid-button\" name=\"next\"><i class=\"fa fa-angle-right\"></i></button><button class=\"ui-grid-button\" name=\"last\"><i class=\"fa fa-angle-double-right\"></i></button></div><div class=\"ui-grid-pages\"></div></div></div>' : ''));\n\n\t\tvar body = self.find('.ui-grid-data');\n\t\ttbody = $(body.find('tbody')[0]);\n\t\ttbodyhead = $(body.find('thead')[0]);\n\t\tthead = $(self.find('.ui-grid-header').find('thead')[0]);\n\t\tcontainer = $(self.find('.ui-grid-scroller')[0]);\n\n\t\tif (config.pagination) {\n\t\t\tvar el = self.find('.ui-grid-footer');\n\t\t\tpagination = {};\n\t\t\tpagination.main = el;\n\t\t\tpagination.page = el.find('input');\n\t\t\tpagination.first = el.find('button[name=\"first\"]');\n\t\t\tpagination.last = el.find('button[name=\"last\"]');\n\t\t\tpagination.prev = el.find('button[name=\"prev\"]');\n\t\t\tpagination.next = el.find('button[name=\"next\"]');\n\t\t\tpagination.meta = el.find('.ui-grid-meta');\n\t\t\tpagination.pages = el.find('.ui-grid-pages');\n\t\t}\n\n\t\tmeta && self.meta(meta);\n\n\t\tself.event('click', '.ui-grid-columnsort', function() {\n\t\t\tvar obj = {};\n\t\t\tobj.columns = options.columns;\n\t\t\tobj.column = options.columns[+$(this).attrd('index')];\n\t\t\tself.sort(obj);\n\t\t});\n\n\t\tself.event('change', '.ui-grid-filter', function() {\n\t\t\tvar el = $(this).parent();\n\t\t\tif (this.value)\n\t\t\t\toptions.filter[this.name] = this.value;\n\t\t\telse\n\t\t\t\tdelete options.filter[this.name];\n\t\t\tel.tclass('ui-grid-selected', !!this.value);\n\t\t\tscroll = true;\n\t\t\tself.filter();\n\t\t});\n\n\t\tself.event('change', 'input', function() {\n\t\t\tvar el = this;\n\t\t\tif (el.type === 'checkbox') {\n\t\t\t\tel && !el.value && self.checked(el.checked);\n\t\t\t\tconfig.checked && EXEC(config.checked, el, self);\n\t\t\t}\n\t\t});\n\n\t\tself.event('click', '.ui-grid-button', function() {\n\t\t\tswitch (this.name) {\n\t\t\t\tcase 'first':\n\t\t\t\t\tscroll = true;\n\t\t\t\t\tcache.page = 1;\n\t\t\t\t\tself.operation('pagination');\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'last':\n\t\t\t\t\tscroll = true;\n\t\t\t\t\tcache.page = cache.pages;\n\t\t\t\t\tself.operation('pagination');\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'prev':\n\t\t\t\t\tscroll = true;\n\t\t\t\t\tcache.page -= 1;\n\t\t\t\t\tself.operation('pagination');\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'next':\n\t\t\t\t\tscroll = true;\n\t\t\t\t\tcache.page += 1;\n\t\t\t\t\tself.operation('pagination');\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t});\n\n\t\tself.event('change', '.ui-grid-input', function() {\n\t\t\tvar page = (+this.value) >> 0;\n\t\t\tif (isNaN(page) || page < 0 || page > cache.pages || page === cache.page)\n\t\t\t\treturn;\n\t\t\tscroll = true;\n\t\t\tcache.page = page;\n\t\t\tself.operation('pagination');\n\t\t});\n\n\t\ttbody.on('click', 'button', function() {\n\t\t\tvar btn = $(this);\n\t\t\tvar tr = btn.closest('tr');\n\t\t\tconfig.button && EXEC(config.button, btn, options.items[+tr.attrd('index')], self);\n\t\t});\n\n\t\tvar ALLOWED = { INPUT: 1, SELECT: 1 };\n\n\t\ttbody.on('click', '.ui-grid-row', function(e) {\n\t\t\t!ALLOWED[e.target.nodeName] && config.click && EXEC(config.click, options.items[+$(this).attrd('index')], self);\n\t\t});\n\n\t\tself.on('resize', self.resize);\n\t\tconfig.init && EXEC(config.init);\n\t\twheight = WH;\n\t};\n\n\tself.checked = function(value) {\n\t\tif (typeof(value) === 'boolean')\n\t\t\tself.find('input[type=\"checkbox\"]').prop('checked', value);\n\t\telse\n\t\t\treturn tbody.find('input:checked');\n\t};\n\n\tself.meta = function(html) {\n\n\t\tswitch (typeof(html)) {\n\t\t\tcase 'string':\n\t\t\t\toptions.columns = new Function('return ' + html.trim())();\n\t\t\t\tbreak;\n\t\t\tcase 'function':\n\t\t\t\toptions.columns = html(self);\n\t\t\t\tbreak;\n\t\t\tcase 'object':\n\t\t\t\toptions.columns = html;\n\t\t\t\tbreak;\n\t\t}\n\n\t\toptions.columns = options.columns.remove(function(column) {\n\t\t\treturn !!(column.remove && FN(column.remove)());\n\t\t});\n\n\t\toptions.customsearch = false;\n\n\t\tfor (var i = 0; i < options.columns.length; i++) {\n\t\t\tvar column = options.columns[i];\n\n\t\t\tif (typeof(column.header) === 'string')\n\t\t\t\tcolumn.header = column.header.indexOf('{{') === -1 ? new Function('return \\'' + column.header + '\\'') : Tangular.compile(column.header);\n\n\t\t\tif (typeof(column.template) === 'string')\n\t\t\t\tcolumn.template = column.template.indexOf('{{') === -1 ? new Function('a', 'b', 'return \\'' + column.template + '\\'') : Tangular.compile(column.template);\n\n\t\t\tif (column.search) {\n\t\t\t\toptions.customsearch = true;\n\t\t\t\tcolumn.search = column.search === true ? column.template : Tangular.compile(column.search);\n\t\t\t}\n\t\t}\n\n\t\tself.rebuild(true);\n\t};\n\n\tself.configure = function(key, value) {\n\t\tswitch (key) {\n\t\t\tcase 'pluralizepages':\n\t\t\t\tppages = value.split(',').trim();\n\t\t\t\tbreak;\n\t\t\tcase 'pluralizeitems':\n\t\t\t\tpitems = value.split(',').trim();\n\t\t\t\tbreak;\n\t\t}\n\t};\n\n\tself.cls = function(d) {\n\t\tvar a = [];\n\t\tfor (var i = 1; i < arguments.length; i++) {\n\t\t\tvar cls = arguments[i];\n\t\t\tcls && a.push(cls);\n\t\t}\n\t\treturn a.length ? ((d ? ' ' : '') + a.join(' ')) : '';\n\t};\n\n\tself.rebuild = function(init) {\n\n\t\tvar data = ['<tr class=\"ui-grid-empty\">'];\n\t\tvar header = ['<tr>'];\n\t\tvar filter = ['<tr>'];\n\n\t\tvar size = 0;\n\t\tvar columns = options.columns;\n\t\tvar scrollbar = SCROLLBARWIDTH();\n\n\t\tfor (var i = 0, length = columns.length; i < length; i++) {\n\t\t\tvar col = columns[i];\n\n\t\t\tif (typeof(col.size) !== 'string')\n\t\t\t\tsize += col.size || 1;\n\n\t\t\tcol.sorting = null;\n\n\t\t\tif (typeof(col.render) === 'string')\n\t\t\t\tcol.render = FN(col.render);\n\n\t\t\tif (typeof(col.header) === 'string')\n\t\t\t\tcol.header = FN(col.header);\n\n\t\t\tcol.cls = self.cls(0, col.classtd, col.class);\n\t\t}\n\n\t\tfor (var i = 0, length = columns.length; i < length; i++) {\n\t\t\tvar col = columns[i];\n\t\t\tvar width = typeof(col.size) === 'string' ? col.size : ((((col.size || 1) / size) * 100).floor(2) + '%');\n\n\t\t\tdata.push('<td style=\"width:{0}\" data-index=\"{1}\" class=\"{2}\"></td>'.format(width, i, self.cls(0, col.classtd, col.class)));\n\t\t\theader.push('<th class=\"ui-grid-columnname{3}{5}\" style=\"width:{0};text-align:center\" data-index=\"{1}\" title=\"{6}\" data-name=\"{4}\"><div class=\"wrap\"><i class=\"fa hidden ui-grid-fa\"></i>{2}</div></th>'.format(width, i, col.header ? col.header(col) : (col.text || col.name), self.cls(1, col.classth, col.class), col.name, col.sort === false ? '' : ' ui-grid-columnsort', col.title || col.text || col.name));\n\t\t\tif (col.filter === false)\n\t\t\t\tfilter.push('<th class=\"ui-grid-columnfilterempty ui-grid-columnfilter{1}\" style=\"width:{0}\">&nbsp;</th>'.format(width, self.cls(1, col.classfilter, col.class)));\n\t\t\telse\n\t\t\t\tfilter.push('<th class=\"ui-grid-columnfilter{4}\" style=\"width:{0}\"><input type=\"text\" placeholder=\"{3}\" name=\"{2}\" autocomplete=\"off\" class=\"ui-grid-filter\" /></th>'.format(width, i, col.name, col.filter || config.filterlabel, self.cls(1, col.classfilter, col.class)));\n\t\t}\n\n\t\tif (scrollbar) {\n\t\t\theader.push('<th class=\"ui-grid-columnname ui-grid-scrollbar\" style=\"width:{0}px\"></th>'.format(scrollbar));\n\t\t\tfilter.push('<th class=\"ui-grid-columnfilterempty ui-grid-scrollbar ui-grid-columnfilter{1}\" style=\"width:{0}px\">&nbsp;</th>'.format(scrollbar, self.cls(1, col.classtd, col.class)));\n\t\t}\n\n\t\ttbodyhead.html(data.join('') + '</tr>');\n\t\tthead.html(header.join('') + '</tr>' + (config.filter ? (filter.join('') + '</tr>') : ''));\n\t\t!init && self.refresh();\n\t\tisFilter = false;\n\t\toptions.filter = {};\n\t};\n\n\tself.fill = function() {\n\n\t\tif (config.autosize === false || filled)\n\t\t\treturn;\n\n\t\tfilled = true;\n\t\ttbody.find('.emptyfill').remove();\n\t\tvar builder = ['<tr class=\"emptyfill\">'];\n\n\t\tvar cols = options.columns;\n\t\tfor (var i = 0, length = cols.length; i < length; i++) {\n\t\t\tvar col = cols[i];\n\t\t\tif (!col.hidden) {\n\t\t\t\tvar cls = self.cls(0, col.classtd, col.class);\n\t\t\t\tbuilder.push('<td{0}>'.format(cls ? (' class=\"' + cls + '\"') : '') + (i ? '' : '<div class=\"wrap\">&nbsp;</div>') + '</td>');\n\t\t\t}\n\t\t}\n\n\t\tbuilder.push('</tr>');\n\t\tbuilder = builder.join('');\n\t\tvar buffer = [];\n\t\tfor (var i = 0; i < config.fillcount; i++)\n\t\t\tbuffer.push(builder);\n\t\ttbody.append(buffer.join(''));\n\t};\n\n\tself.resize = function(delay) {\n\n\t\tif (config.autosize === false) {\n\t\t\tself.hclass('hidden') && self.rclass('hidden');\n\t\t\treturn;\n\t\t}\n\n\t\tsetTimeout2(self.id + '.resize', function() {\n\n\t\t\tvar parent = self.parent().height();\n\t\t\tif (parent < wheight / 3)\n\t\t\t\treturn;\n\n\t\t\tvar value = options.items;\n\t\t\tvar height = parent - (config.padding || 0) - (config.pagination ? 105 : 74);\n\n\t\t\tif (height === eheight)\n\t\t\t\treturn;\n\n\t\t\tcontainer.height(height);\n\t\t\teheight = height;\n\n\t\t\tvar cls = 'ui-grid-noscroll';\n\t\t\tvar count = (height / config.rowheight) >> 0;\n\t\t\tif (count > value.length) {\n\t\t\t\tself.fill(config.fillcount);\n\t\t\t\tself.aclass(cls);\n\t\t\t} else\n\t\t\t\tself.rclass(cls);\n\n\t\t\tpagination && pagination.main.rclass('hidden');\n\t\t\teheight && self.rclass('hidden');\n\t\t}, typeof(delay) === 'number' ? delay : 50);\n\t};\n\n\tself.limit = function() {\n\t\treturn Math.ceil(container.height() / config.rowheight);\n\t};\n\n\tself.filter = function() {\n\t\tisFilter = Object.keys(options.filter).length > 0;\n\t\t!config.external && self.refresh();\n\t\tself.operation('filter');\n\t};\n\n\tself.operation = function(type) {\n\t\tif (type === 'filter')\n\t\t\tcache.page = 1;\n\t\tconfig.exec && EXEC(config.exec, type, isFilter ? options.filter : null, options.lastsort ? options.lastsort : null, cache.page, self);\n\t};\n\n\tself.sort = function(data) {\n\n\t\toptions.lastsortelement && options.lastsortelement.rclass('fa-caret-down fa-caret-up').aclass('hidden');\n\n\t\tif (data.column.sorting === 'desc') {\n\t\t\toptions.lastsortelement.find('.ui-grid-fa').rclass('fa-caret-down fa-caret-up').aclass('hidden');\n\t\t\toptions.lastsortelement = null;\n\t\t\toptions.lastsort = null;\n\t\t\tdata.column.sorting = null;\n\n\t\t\tif (config.external)\n\t\t\t\tself.operation('sort');\n\t\t\telse\n\t\t\t\tself.refresh();\n\n\t\t} else if (data.column) {\n\t\t\tdata.column.sorting = data.column.sorting === 'asc' ? 'desc' : 'asc';\n\t\t\toptions.lastsortelement = thead.find('th[data-name=\"{0}\"]'.format(data.column.name)).find('.ui-grid-fa').rclass('hidden').tclass('fa-caret-down', data.column.sorting === 'asc').tclass('fa-caret-up', data.column.sorting === 'desc');\n\t\t\toptions.lastsort = data.column;\n\n\t\t\tvar name = data.column.name;\n\t\t\tvar sort = data.column.sorting;\n\n\t\t\t!config.external && options.lastsort && options.items.quicksort(name, sort !== 'asc');\n\t\t\tself.operation('sort');\n\t\t\tself.redraw();\n\t\t}\n\t};\n\n\tself.can = function(row) {\n\n\t\tvar keys = Object.keys(options.filter);\n\n\t\tfor (var i = 0; i < keys.length; i++) {\n\n\t\t\tvar column = keys[i];\n\t\t\tvar filter = options.filter[column];\n\t\t\tvar val2 = filtercache[column];\n\t\t\tvar val = row['$' + column] || row[column];\n\n\t\t\tvar type = typeof(val);\n\n\t\t\tif (val instanceof Array) {\n\t\t\t\tval = val.join(' ');\n\t\t\t\ttype = 'string';\n\t\t\t}\n\n\t\t\tif (type === 'number') {\n\n\t\t\t\tif (val2 == null)\n\t\t\t\t\tval2 = filtercache[column] = self.parseNumber(filter);\n\n\t\t\t\tif (val2.length === 1 && val !== val2[0])\n\t\t\t\t\treturn false;\n\n\t\t\t\tif (val < val2[0] || val > val2[1])\n\t\t\t\t\treturn false;\n\n\t\t\t} else if (type === 'string') {\n\n\t\t\t\tif (val2 == null) {\n\t\t\t\t\tval2 = filtercache[column] = filter.split(/\\/\\|\\\\|,/).trim();\n\t\t\t\t\tfor (var j = 0; j < val2.length; j++)\n\t\t\t\t\t\tval2[j] = val2[j].toSearch();\n\t\t\t\t}\n\n\t\t\t\tvar is = false;\n\t\t\t\tvar s = val.toSearch();\n\n\t\t\t\tfor (var j = 0; j < val2.length; j++) {\n\t\t\t\t\tif (s.indexOf(val2[j]) !== -1) {\n\t\t\t\t\t\tis = true;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (!is)\n\t\t\t\t\treturn false;\n\n\t\t\t} else if (type === 'boolean') {\n\t\t\t\tif (val2 == null)\n\t\t\t\t\tval2 = filtercache[column] = config.boolean.indexOf(filter.replace(/\\s/g, '')) !== -1;\n\t\t\t\tif (val2 !== val)\n\t\t\t\t\treturn false;\n\t\t\t} else if (val instanceof Date) {\n\n\t\t\t\tval.setHours(0);\n\t\t\t\tval.setMinutes(0);\n\n\t\t\t\tif (val2 == null) {\n\n\t\t\t\t\tval2 = filter.trim().replace(/\\s-\\s/, '/').split(/\\/|\\||\\\\|,/).trim();\n\t\t\t\t\tvar arr = filtercache[column] = [];\n\n\t\t\t\t\tfor (var j = 0; j < val2.length; j++) {\n\t\t\t\t\t\tvar dt = val2[j].trim();\n\t\t\t\t\t\tvar a = self.parseDate(dt);\n\t\t\t\t\t\tif (a instanceof Array) {\n\t\t\t\t\t\t\tif (val2.length === 2) {\n\t\t\t\t\t\t\t\tarr.push(j ? a[1] : a[0]);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tarr.push(a[0]);\n\t\t\t\t\t\t\t\tif (j === val2.length - 1) {\n\t\t\t\t\t\t\t\t\tarr.push(a[1]);\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else\n\t\t\t\t\t\t\tarr.push(a);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (val2.length === 2 && arr.length === 2) {\n\t\t\t\t\t\tarr[1].setHours(23);\n\t\t\t\t\t\tarr[1].setMinutes(59);\n\t\t\t\t\t\tarr[1].setSeconds(59);\n\t\t\t\t\t}\n\n\t\t\t\t\tval2 = arr;\n\t\t\t\t}\n\n\t\t\t\tif (val2.length === 1 && val.format('yyyyMMdd') !== val2[0].format('yyyyMMdd'))\n\t\t\t\t\treturn false;\n\n\t\t\t\tif (val < val2[0] || val > val2[1])\n\t\t\t\t\treturn false;\n\t\t\t} else\n\t\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t};\n\n\tself.parseDate = function(val) {\n\t\tvar index = val.indexOf('.');\n\t\tif (index === -1) {\n\t\t\tif ((/[a-z]+/).test(val)) {\n\t\t\t\tvar dt = NOW.add(val);\n\t\t\t\treturn dt > NOW ? [NOW, dt] : [dt, NOW];\n\t\t\t}\n\t\t\tif (val.length === 4)\n\t\t\t\treturn [new Date(+val, 0, 1), new Date(+val + 1, 0\t, 1)];\n\t\t} else if (val.indexOf('.', index + 1) === -1) {\n\t\t\tvar a = val.split('.');\n\t\t\treturn new Date(NOW.getFullYear(), +a[1] - 1, +a[0]);\n\t\t}\n\t\tindex = val.indexOf('-');\n\t\tif (index !== -1 && val.indexOf('-', index + 1) === -1) {\n\t\t\tvar a = val.split('-');\n\t\t\treturn new Date(NOW.getFullYear(), +a[0] - 1, +a[1]);\n\t\t}\n\t\treturn val.parseDate();\n\t};\n\n\tself.parseNumber = function(val) {\n\t\tvar arr = [];\n\t\tvar num = val.replace(/\\s-\\s/, '/').replace(/\\s/g, '').replace(/,/g, '.').split(/\\/|\\|\\s-\\s|\\\\/).trim();\n\n\t\tfor (var i = 0, length = num.length; i < length; i++) {\n\t\t\tvar n = num[i];\n\t\t\tarr.push(+n);\n\t\t}\n\n\t\treturn arr;\n\t};\n\n\tself.reset = function() {\n\t\toptions.filter = {};\n\t\tisFilter = false;\n\t\tthead.find('input').val('');\n\t\tthead.find('.ui-grid-selected').rclass('ui-grid-selected');\n\t\toptions.lastsortelement && options.lastsortelement.rclass('fa-caret-down fa-caret-up');\n\t\toptions.lastsortelement = null;\n\t\tif (options.lastsort)\n\t\t\toptions.lastsort.sorting = null;\n\t\toptions.lastsort = null;\n\t};\n\n\tself.redraw = function() {\n\n\t\tvar items = options.items;\n\t\tvar columns = options.columns;\n\t\tvar builder = [];\n\t\tvar m = {};\n\n\t\tfor (var i = 0, length = items.length; i < length; i++) {\n\t\t\tbuilder.push('<tr class=\"ui-grid-row\" data-index=\"' + i + '\">');\n\t\t\tfor (var j = 0, jl = columns.length; j < jl; j++) {\n\t\t\t\tvar column = columns[j];\n\t\t\t\tvar val = items[i][column.name];\n\t\t\t\tm.value = column.template ? column.template(items[i], column) : column.render ? column.render(val, column, items[i]) : val == null ? '' : Thelpers.encode((column.format ? val.format(column.format) : val));\n\t\t\t\tm.index = j;\n\t\t\t\tm.align = column.align;\n\t\t\t\tm.background = column.background;\n\t\t\t\tbuilder.push(self.template(m, column));\n\t\t\t}\n\t\t\tbuilder.push('</tr>');\n\t\t}\n\n\t\ttbody.find('.ui-grid-row').remove();\n\t\ttbody.prepend(builder.join(''));\n\t\tcontainer.rclass('noscroll');\n\t\tscroll && container.prop('scrollTop', 0);\n\t\tscroll = false;\n\t\teheight = 0;\n\t\tself.resize(0);\n\t};\n\n\tself.setter = function(value) {\n\n\t\t// value.items\n\t\t// value.limit\n\t\t// value.page\n\t\t// value.pages\n\t\t// value.count\n\n\t\tif (!value) {\n\t\t\ttbody.find('.ui-grid-row').remove();\n\t\t\tself.resize();\n\t\t\treturn;\n\t\t}\n\n\t\tcache = value;\n\n\t\tif (config.pagination) {\n\t\t\tpagination.prev.prop('disabled', value.page === 1);\n\t\t\tpagination.first.prop('disabled', value.page === 1);\n\t\t\tpagination.next.prop('disabled', value.page >= value.pages);\n\t\t\tpagination.last.prop('disabled', value.page === value.pages);\n\t\t\tpagination.page.val(value.page);\n\t\t\tpagination.meta.html(value.count.pluralize.apply(value.count, pitems));\n\t\t\tpagination.pages.html(value.pages.pluralize.apply(value.pages, ppages));\n\t\t}\n\n\t\tif (options.customsearch) {\n\t\t\tfor (var i = 0, length = value.items.length; i < length; i++) {\n\t\t\t\tvar item = value.items[i];\n\t\t\t\tfor (var j = 0; j < options.columns.length; j++) {\n\t\t\t\t\tvar col = options.columns[j];\n\t\t\t\t\tif (col.search)\n\t\t\t\t\t\titem['$' + col.name] = col.search(item);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (config.external) {\n\t\t\toptions.items = value.items;\n\t\t} else {\n\t\t\toptions.items = [];\n\t\t\tfiltercache = {};\n\t\t\tfor (var i = 0, length = value.items.length; i < length; i++) {\n\t\t\t\tvar item = value.items[i];\n\t\t\t\tif (isFilter && !self.can(item))\n\t\t\t\t\tcontinue;\n\t\t\t\toptions.items.push(item);\n\t\t\t}\n\t\t\toptions.lastsort && options.items.quicksort(options.lastsort.name, options.lastsort.sorting === 'asc');\n\t\t}\n\n\t\tself.redraw();\n\t\tconfig.checked && EXEC(config.checked, null, self);\n\t};\n});\n\nCOMPONENT('contextmenu', function(self) {\n\n\tvar is = false;\n\tvar timeout, container, arrow;\n\n\tself.template = Tangular.compile('<div data-index=\"{{ index }}\"{{ if selected }} class=\"selected\"{{ fi }}><i class=\"fa {{ icon }}\"></i><span>{{ name | raw }}</span></div>');\n\tself.singleton();\n\tself.readonly();\n\tself.callback = null;\n\tself.items = EMPTYARRAY;\n\n\tself.make = function() {\n\n\t\tself.aclass('ui-contextmenu hidden');\n\t\tself.append('<span class=\"ui-contextmenu-arrow\"></span><div class=\"ui-contextmenu-items\"></div>');\n\t\tcontainer = self.find('.ui-contextmenu-items');\n\t\tarrow = self.find('.ui-contextmenu-arrow');\n\n\t\tself.event('touchstart mousedown', 'div[data-index]', function(e) {\n\t\t\tself.callback && self.callback(self.items[+$(this).attrd('index')], $(self.target));\n\t\t\tself.hide();\n\t\t\te.preventDefault();\n\t\t\te.stopPropagation();\n\t\t});\n\n\t\t$(window).on('scroll', function() {\n\t\t\tis && self.hide(1);\n\t\t});\n\n\t\tself.on('scroll', function() {\n\t\t\tis && self.hide(1);\n\t\t});\n\n\t\t$(document).on('touchstart mousedown', function(e) {\n\t\t\tif (is && (self.target !== e.target && !self.target.contains(e.target)))\n\t\t\t\tself.hide(1);\n\t\t});\n\t};\n\n\tself.show = function(orientation, target, items, callback, offsetX, offsetY) {\n\n\t\tif (is) {\n\t\t\tclearTimeout(timeout);\n\t\t\tvar obj = target instanceof jQuery ? target[0] : target;\n\t\t\tif (self.target === obj) {\n\t\t\t\tself.hide(0);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\ttarget = $(target);\n\t\tvar type = typeof(items);\n\t\tvar item;\n\n\t\tif (type === 'string')\n\t\t\titems = self.get(items);\n\t\telse if (type === 'function') {\n\t\t\tcallback = items;\n\t\t\titems = (target.attrd('options') || '').split(';');\n\t\t\tfor (var i = 0, length = items.length; i < length; i++) {\n\t\t\t\titem = items[i];\n\t\t\t\tif (!item)\n\t\t\t\t\tcontinue;\n\t\t\t\tvar val = item.split('|');\n\t\t\t\titems[i] = { name: val[0], icon: val[1], value: val[2] || val[0] };\n\t\t\t}\n\t\t}\n\n\t\tif (!items) {\n\t\t\tself.hide(0);\n\t\t\treturn;\n\t\t}\n\n\t\tself.callback = callback;\n\n\t\tvar builder = [];\n\t\tfor (var i = 0, length = items.length; i < length; i++) {\n\t\t\titem = items[i];\n\t\t\titem.index = i;\n\t\t\tif (item.icon) {\n\t\t\t\tif (item.icon.substring(0, 3) !== 'fa-')\n\t\t\t\t\titem.icon = 'fa-' + item.icon;\n\t\t\t} else\n\t\t\t\titem.icon = 'fa-caret-right';\n\n\t\t\tbuilder.push(self.template(item));\n\t\t}\n\n\t\tself.items = items;\n\t\tself.target = target[0];\n\t\tvar offset = target.offset();\n\n\t\tcontainer.html(builder);\n\n\t\tswitch (orientation) {\n\t\t\tcase 'left':\n\t\t\t\tarrow.css({ left: '10px' });\n\t\t\t\tbreak;\n\t\t\tcase 'right':\n\t\t\t\tarrow.css({ left: '165px' });\n\t\t\t\tbreak;\n\t\t\tcase 'center':\n\t\t\t\tarrow.css({ left: '90px' });\n\t\t\t\tbreak;\n\t\t}\n\n\n\t\tvar options = { left: orientation === 'center' ? Math.ceil((offset.left - self.element.width() / 2) + (target.innerWidth() / 2)) : orientation === 'left' ? (offset.left - 8) + (offsetX || 0) : (offset.left - self.element.width()) + target.innerWidth() + (offsetX || 0) + 8, top: offset.top + target.innerHeight() + 10 + (offsetY || 0) };\n\t\tself.css(options);\n\n\t\tif (is)\n\t\t\treturn;\n\n\t\tself.rclass('hidden');\n\t\tsetTimeout(function() {\n\t\t\tself.aclass('ui-contextmenu-visible');\n\t\t\tself.emit('contextmenu', true, self, self.target);\n\t\t}, 100);\n\n\t\tis = true;\n\t};\n\n\tself.hide = function(sleep) {\n\t\tif (!is)\n\t\t\treturn;\n\t\tclearTimeout(timeout);\n\t\ttimeout = setTimeout(function() {\n\t\t\tself.aclass('hidden').rclass('ui-contextmenu-visible');\n\t\t\tself.emit('contextmenu', false, self, self.target);\n\t\t\tself.callback = null;\n\t\t\tself.target = null;\n\t\t\tis = false;\n\t\t}, sleep ? sleep : 100);\n\t};\n});\n\nCOMPONENT('textbox', function(self, config) {\n\n\tvar input, content = null;\n\n\tself.nocompile();\n\n\tself.validate = function(value) {\n\n\t\tif (!config.required || config.disabled)\n\t\t\treturn true;\n\n\t\tif (self.type === 'date')\n\t\t\treturn value instanceof Date && !isNaN(value.getTime());\n\n\t\tif (value == null)\n\t\t\tvalue = '';\n\t\telse\n\t\t\tvalue = value.toString();\n\n\t\tEMIT('reflow', self.name);\n\n\t\tif (config.minlength && value.length < config.minlength)\n\t\t\treturn false;\n\n\t\tswitch (self.type) {\n\t\t\tcase 'email':\n\t\t\t\treturn value.isEmail();\n\t\t\tcase 'phone':\n\t\t\t\treturn value.isPhone();\n\t\t\tcase 'url':\n\t\t\t\treturn value.isURL();\n\t\t\tcase 'currency':\n\t\t\tcase 'number':\n\t\t\t\treturn value > 0;\n\t\t}\n\n\t\treturn config.validation ? !!self.evaluate(value, config.validation, true) : value.length > 0;\n\t};\n\n\tself.make = function() {\n\n\t\tcontent = self.html();\n\n\t\tself.type = config.type;\n\t\tself.format = config.format;\n\n\t\tself.event('click', '.fa-calendar', function(e) {\n\t\t\tif (!config.disabled && !config.readonly && config.type === 'date') {\n\t\t\t\te.preventDefault();\n\t\t\t\tSETTER('calendar', 'toggle', self.element, self.get(), function(date) {\n\t\t\t\t\tself.change(true);\n\t\t\t\t\tself.set(date);\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\n\t\tself.event('click', '.fa-caret-up,.fa-caret-down', function() {\n\t\t\tif (!config.disabled && !config.readonly && config.increment) {\n\t\t\t\tvar el = $(this);\n\t\t\t\tvar inc = el.hclass('fa-caret-up') ? 1 : -1;\n\t\t\t\tself.change(true);\n\t\t\t\tself.inc(inc);\n\t\t\t}\n\t\t});\n\n\t\tself.event('click', '.ui-textbox-control-icon', function() {\n\t\t\tif (config.disabled || config.readonly)\n\t\t\t\treturn;\n\t\t\tif (self.type === 'search') {\n\t\t\t\tself.$stateremoved = false;\n\t\t\t\t$(this).rclass('fa-times').aclass('fa-search');\n\t\t\t\tself.set('');\n\t\t\t} else if (config.icon2click)\n\t\t\t\tEXEC(config.icon2click, self);\n\t\t});\n\n\t\tself.event('focus', 'input', function() {\n\t\t\tif (!config.disabled && !config.readonly && config.autocomplete)\n\t\t\t\tEXEC(config.autocomplete, self);\n\t\t});\n\n\t\tself.redraw();\n\t};\n\n\tself.redraw = function() {\n\n\t\tvar attrs = [];\n\t\tvar builder = [];\n\t\tvar tmp = 'text';\n\n\t\tswitch (config.type) {\n\t\t\tcase 'password':\n\t\t\t\ttmp = config.type;\n\t\t\t\tbreak;\n\t\t\tcase 'number':\n\t\t\tcase 'phone':\n\t\t\t\tisMOBILE && (tmp = 'tel');\n\t\t\t\tbreak;\n\t\t}\n\n\t\tself.tclass('ui-disabled', config.disabled === true);\n\t\tself.tclass('ui-textbox-required', config.required === true);\n\t\tself.type = config.type;\n\t\tattrs.attr('type', tmp);\n\t\tconfig.placeholder && attrs.attr('placeholder', config.placeholder);\n\t\tconfig.maxlength && attrs.attr('maxlength', config.maxlength);\n\t\tconfig.keypress != null && attrs.attr('data-jc-keypress', config.keypress);\n\t\tconfig.delay && attrs.attr('data-jc-keypress-delay', config.delay);\n\t\tconfig.disabled && attrs.attr('disabled');\n\t\tconfig.readonly && attrs.attr('readonly');\n\t\tconfig.error && attrs.attr('error');\n\t\tattrs.attr('data-jc-bind', '');\n\n\t\tconfig.autofill && attrs.attr('name', self.path.replace(/\\./g, '_'));\n\t\tconfig.align && attrs.attr('class', 'ui-' + config.align);\n\t\t!isMOBILE && config.autofocus && attrs.attr('autofocus');\n\n\t\tbuilder.push('<div class=\"ui-textbox-input\"><input {0} /></div>'.format(attrs.join(' ')));\n\n\t\tvar icon = config.icon;\n\t\tvar icon2 = config.icon2;\n\n\t\tif (!icon2 && self.type === 'date')\n\t\t\ticon2 = 'calendar';\n\t\telse if (self.type === 'search') {\n\t\t\ticon2 = 'search';\n\t\t\tself.setter2 = function(value) {\n\t\t\t\tif (self.$stateremoved && !value)\n\t\t\t\t\treturn;\n\t\t\t\tself.$stateremoved = !value;\n\t\t\t\tself.find('.ui-textbox-control-icon').tclass('fa-times', !!value).tclass('fa-search', !value);\n\t\t\t};\n\t\t}\n\n\t\ticon2 && builder.push('<div class=\"ui-textbox-control\"><span class=\"fa fa-{0} ui-textbox-control-icon\"></span></div>'.format(icon2));\n\t\tconfig.increment && !icon2 && builder.push('<div class=\"ui-textbox-control\"><span class=\"fa fa-caret-up\"></span><span class=\"fa fa-caret-down\"></span></div>');\n\n\t\tif (config.label)\n\t\t\tcontent = config.label;\n\n\t\tif (content.length) {\n\t\t\tvar html = builder.join('');\n\t\t\tbuilder = [];\n\t\t\tbuilder.push('<div class=\"ui-textbox-label\">');\n\t\t\ticon && builder.push('<i class=\"fa fa-{0}\"></i> '.format(icon));\n\t\t\tbuilder.push('<span>' + content + (content.substring(content.length - 1) === '?' ? '' : ':') + '</span>');\n\t\t\tbuilder.push('</div><div class=\"ui-textbox\">{0}</div>'.format(html));\n\t\t\tconfig.error && builder.push('<div class=\"ui-textbox-helper\"><i class=\"fa fa-warning\" aria-hidden=\"true\"></i> {0}</div>'.format(config.error));\n\t\t\tself.html(builder.join(''));\n\t\t\tself.aclass('ui-textbox-container');\n\t\t\tinput = self.find('input');\n\t\t} else {\n\t\t\tconfig.error && builder.push('<div class=\"ui-textbox-helper\"><i class=\"fa fa-warning\" aria-hidden=\"true\"></i> {0}</div>'.format(config.error));\n\t\t\tself.aclass('ui-textbox ui-textbox-container');\n\t\t\tself.html(builder.join(''));\n\t\t\tinput = self.find('input');\n\t\t}\n\t};\n\n\tself.configure = function(key, value, init) {\n\n\t\tif (init)\n\t\t\treturn;\n\n\t\tvar redraw = false;\n\n\t\tswitch (key) {\n\t\t\tcase 'readonly':\n\t\t\t\tself.find('input').prop('readonly', value);\n\t\t\t\tbreak;\n\t\t\tcase 'disabled':\n\t\t\t\tself.tclass('ui-disabled', value);\n\t\t\t\tself.find('input').prop('disabled', value);\n\t\t\t\tself.reset();\n\t\t\t\tbreak;\n\t\t\tcase 'format':\n\t\t\t\tself.format = value;\n\t\t\t\tself.refresh();\n\t\t\t\tbreak;\n\t\t\tcase 'required':\n\t\t\t\tself.noValid(!value);\n\t\t\t\t!value && self.state(1, 1);\n\t\t\t\tself.tclass('ui-textbox-required', value === true);\n\t\t\t\tbreak;\n\t\t\tcase 'placeholder':\n\t\t\t\tinput.prop('placeholder', value || '');\n\t\t\t\tbreak;\n\t\t\tcase 'maxlength':\n\t\t\t\tinput.prop('maxlength', value || 1000);\n\t\t\t\tbreak;\n\t\t\tcase 'autofill':\n\t\t\t\tinput.prop('name', value ? self.path.replace(/\\./g, '_') : '');\n\t\t\t\tbreak;\n\t\t\tcase 'label':\n\t\t\t\tif (content && value)\n\t\t\t\t\tself.find('.ui-textbox-label span').html(value);\n\t\t\t\telse\n\t\t\t\t\tredraw = true;\n\t\t\t\tcontent = value;\n\t\t\t\tbreak;\n\t\t\tcase 'type':\n\t\t\t\tself.type = value;\n\t\t\t\tif (value === 'password')\n\t\t\t\t\tvalue = 'password';\n\t\t\t\telse\n\t\t\t\t\tself.type = 'text';\n\t\t\t\tself.find('input').prop('type', self.type);\n\t\t\t\tbreak;\n\t\t\tcase 'align':\n\t\t\t\tinput.rclass(input.attr('class')).aclass('ui-' + value || 'left');\n\t\t\t\tbreak;\n\t\t\tcase 'autofocus':\n\t\t\t\tinput.focus();\n\t\t\t\tbreak;\n\t\t\tcase 'icon':\n\t\t\t\tvar tmp = self.find('.ui-textbox-label .fa');\n\t\t\t\tif (tmp.length)\n\t\t\t\t\ttmp.rclass2('fa-').aclass('fa-' + value);\n\t\t\t\telse\n\t\t\t\t\tredraw = true;\n\t\t\t\tbreak;\n\t\t\tcase 'icon2':\n\t\t\tcase 'increment':\n\t\t\t\tredraw = true;\n\t\t\t\tbreak;\n\t\t}\n\n\t\tredraw && setTimeout2('redraw.' + self.id, function() {\n\t\t\tself.redraw();\n\t\t\tself.refresh();\n\t\t}, 100);\n\t};\n\n\tself.formatter(function(path, value) {\n\t\treturn config.type === 'date' ? (value ? value.format(config.format || 'yyyy-MM-dd') : value) : value;\n\t});\n\n\tself.parser(function(path, value) {\n\t\treturn value ? config.spaces === false ? value.replace(/\\s/g, '') : value : value;\n\t});\n\n\tself.state = function(type) {\n\t\tif (!type)\n\t\t\treturn;\n\t\tvar invalid = config.required ? self.isInvalid() : false;\n\t\tif (invalid === self.$oldstate)\n\t\t\treturn;\n\t\tself.$oldstate = invalid;\n\t\tself.tclass('ui-textbox-invalid', invalid);\n\t\tconfig.error && self.find('.ui-textbox-helper').tclass('ui-textbox-helper-show', invalid);\n\t};\n});\n\nCOMPONENT('form', function(self, config) {\n\n\tvar W = window;\n\tvar csspos = {};\n\n\tif (!W.$$form) {\n\n\t\tW.$$form_level = W.$$form_level || 1;\n\t\tW.$$form = true;\n\n\t\t$(document).on('click', '.ui-form-button-close', function() {\n\t\t\tSET($(this).attrd('path'), '');\n\t\t});\n\n\t\t$(W).on('resize', function() {\n\t\t\tSETTER('form', 'resize');\n\t\t});\n\n\t\t$(document).on('click', '.ui-form-container', function(e) {\n\t\t\tvar el = $(e.target);\n\t\t\tif (!(el.hclass('ui-form-container-padding') || el.hclass('ui-form-container')))\n\t\t\t\treturn;\n\t\t\tvar form = $(this).find('.ui-form');\n\t\t\tvar cls = 'ui-form-animate-click';\n\t\t\tform.aclass(cls);\n\t\t\tsetTimeout(function() {\n\t\t\t\tform.rclass(cls);\n\t\t\t}, 300);\n\t\t});\n\t}\n\n\tself.readonly();\n\tself.submit = function() {\n\t\tif (config.submit)\n\t\t\tEXEC(config.submit, self);\n\t\telse\n\t\t\tself.hide();\n\t};\n\n\tself.cancel = function() {\n\t\tconfig.cancel && EXEC(config.cancel, self);\n\t\tself.hide();\n\t};\n\n\tself.hide = function() {\n\t\tself.set('');\n\t};\n\n\tself.icon = function(value) {\n\t\tvar el = this.rclass2('fa');\n\t\tvalue.icon && el.aclass('fa fa-' + value.icon);\n\t};\n\n\tself.resize = function() {\n\t\tif (!config.center || self.hclass('hidden'))\n\t\t\treturn;\n\t\tvar ui = self.find('.ui-form');\n\t\tvar fh = ui.innerHeight();\n\t\tvar wh = $(W).height();\n\t\tvar r = (wh / 2) - (fh / 2);\n\t\tcsspos.marginTop = (r > 30 ? (r - 15) : 20) + 'px';\n\t\tui.css(csspos);\n\t};\n\n\tself.make = function() {\n\n\t\t$(document.body).append('<div id=\"{0}\" class=\"hidden ui-form-container\"><div class=\"ui-form-container-padding\"><div class=\"ui-form\" style=\"max-width:{1}px\"><div data-bind=\"@config__html span:value.title__change .ui-form-icon:@icon\" class=\"ui-form-title\"><button class=\"ui-form-button-close{3}\" data-path=\"{2}\"><i class=\"fa fa-times\"></i></button><i class=\"ui-form-icon\"></i><span></span></div></div></div>'.format(self.ID, config.width || 800, self.path, config.closebutton == false ? ' hidden' : ''));\n\t\tvar el = $('#' + self.ID);\n\t\tel.find('.ui-form')[0].appendChild(self.dom);\n\t\tself.rclass('hidden');\n\t\tself.replace(el);\n\n\t\tself.event('scroll', function() {\n\t\t\tEMIT('scroll', self.name);\n\t\t\tEMIT('reflow', self.name);\n\t\t});\n\n\t\tself.find('button').on('click', function() {\n\t\t\tswitch (this.name) {\n\t\t\t\tcase 'submit':\n\t\t\t\t\tself.submit(self.hide);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'cancel':\n\t\t\t\t\t!this.disabled && self[this.name](self.hide);\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t});\n\n\t\tconfig.enter && self.event('keydown', 'input', function(e) {\n\t\t\te.which === 13 && !self.find('button[name=\"submit\"]')[0].disabled && setTimeout(function() {\n\t\t\t\tself.submit(self);\n\t\t\t}, 800);\n\t\t});\n\t};\n\n\tself.configure = function(key, value, init, prev) {\n\t\tif (init)\n\t\t\treturn;\n\t\tswitch (key) {\n\t\t\tcase 'width':\n\t\t\t\tvalue !== prev && self.find('.ui-form').css('max-width', value + 'px');\n\t\t\t\tbreak;\n\t\t\tcase 'closebutton':\n\t\t\t\tself.find('.ui-form-button-close').tclass(value !== true);\n\t\t\t\tbreak;\n\t\t}\n\t};\n\n\tself.setter = function(value) {\n\n\t\tsetTimeout2('ui-form-noscroll', function() {\n\t\t\t$('html').tclass('ui-form-noscroll', !!$('.ui-form-container').not('.hidden').length);\n\t\t}, 50);\n\n\t\tvar isHidden = value !== config.if;\n\n\t\tif (self.hclass('hidden') === isHidden)\n\t\t\treturn;\n\n\t\tsetTimeout2('formreflow', function() {\n\t\t\tEMIT('reflow', self.name);\n\t\t}, 10);\n\n\t\tif (isHidden) {\n\t\t\tself.aclass('hidden');\n\t\t\tself.release(true);\n\t\t\tself.find('.ui-form').rclass('ui-form-animate');\n\t\t\tW.$$form_level--;\n\t\t\treturn;\n\t\t}\n\n\t\tif (W.$$form_level < 1)\n\t\t\tW.$$form_level = 1;\n\n\t\tW.$$form_level++;\n\n\t\tself.css('z-index', W.$$form_level * 10);\n\t\tself.element.scrollTop(0);\n\t\tself.rclass('hidden');\n\n\t\tself.resize();\n\t\tself.release(false);\n\n\t\tconfig.reload && EXEC(config.reload, self);\n\t\tconfig.default && DEFAULT(config.default, true);\n\n\t\tif (!isMOBILE && config.autofocus) {\n\t\t\tvar el = self.find(config.autofocus === true ? 'input[type=\"text\"],select,textarea' : config.autofocus);\n\t\t\tel.length && el[0].focus();\n\t\t}\n\n\t\tsetTimeout(function() {\n\t\t\tself.element.scrollTop(0);\n\t\t\tself.find('.ui-form').aclass('ui-form-animate');\n\t\t}, 300);\n\n\t\t// Fixes a problem with freezing of scrolling in Chrome\n\t\tsetTimeout2(self.ID, function() {\n\t\t\tself.css('z-index', (W.$$form_level * 10) + 1);\n\t\t}, 500);\n\t};\n});\n\nCOMPONENT('dropdown', function(self, config) {\n\n\tvar select, condition, content = null;\n\tvar render = '';\n\n\tself.nocompile();\n\n\tself.validate = function(value) {\n\n\t\tif (!config.required || config.disabled)\n\t\t\treturn true;\n\n\t\tvar type = typeof(value);\n\t\tif (type === 'undefined' || type === 'object')\n\t\t\tvalue = '';\n\t\telse\n\t\t\tvalue = value.toString();\n\n\t\tEMIT('reflow', self.name);\n\n\t\tswitch (self.type) {\n\t\t\tcase 'currency':\n\t\t\tcase 'number':\n\t\t\t\treturn value > 0;\n\t\t}\n\n\t\treturn value.length > 0;\n\t};\n\n\tself.configure = function(key, value, init) {\n\n\t\tif (init)\n\t\t\treturn;\n\n\t\tvar redraw = false;\n\n\t\tswitch (key) {\n\t\t\tcase 'type':\n\t\t\t\tself.type = value;\n\t\t\t\tbreak;\n\t\t\tcase 'items':\n\n\t\t\t\tif (value instanceof Array) {\n\t\t\t\t\tself.bind('', value);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tvar items = [];\n\n\t\t\t\tvalue.split(',').forEach(function(item) {\n\t\t\t\t\titem = item.trim().split('|');\n\t\t\t\t\tvar obj = { id: item[1] == null ? item[0] : item[1], name: item[0] };\n\t\t\t\t\titems.push(obj);\n\t\t\t\t});\n\n\t\t\t\tself.bind('', items);\n\t\t\t\tbreak;\n\t\t\tcase 'if':\n\t\t\t\tcondition = value ? FN(value) : null;\n\t\t\t\tbreak;\n\t\t\tcase 'required':\n\t\t\t\tself.tclass('ui-dropdown-required', value === true);\n\t\t\t\tself.state(1, 1);\n\t\t\t\tbreak;\n\t\t\tcase 'datasource':\n\t\t\t\tself.datasource(value, self.bind);\n\t\t\t\tbreak;\n\t\t\tcase 'label':\n\t\t\t\tcontent = value;\n\t\t\t\tredraw = true;\n\t\t\t\tbreak;\n\t\t\tcase 'icon':\n\t\t\t\tredraw = true;\n\t\t\t\tbreak;\n\t\t\tcase 'disabled':\n\t\t\t\tself.tclass('ui-disabled', value);\n\t\t\t\tself.find('select').prop('disabled', value);\n\t\t\t\tself.reset();\n\t\t\t\tbreak;\n\t\t}\n\n\t\tredraw && setTimeout2(self.id + '.redraw', 100);\n\t};\n\n\tself.bind = function(path, arr) {\n\n\t\tif (!arr)\n\t\t\tarr = EMPTYARRAY;\n\n\t\tvar builder = [];\n\t\tvar value = self.get();\n\t\tvar template = '<option value=\"{0}\"{1}>{2}</option>';\n\t\tvar propText = config.text || 'name';\n\t\tvar propValue = config.value || 'id';\n\n\t\tconfig.empty !== undefined && builder.push('<option value=\"\">{0}</option>'.format(config.empty));\n\n\t\tvar type = typeof(arr[0]);\n\t\tvar notObj = type === 'string' || type === 'number';\n\n\t\tfor (var i = 0, length = arr.length; i < length; i++) {\n\t\t\tvar item = arr[i];\n\t\t\tif (condition && !condition(item))\n\t\t\t\tcontinue;\n\t\t\tif (notObj)\n\t\t\t\tbuilder.push(template.format(item, value === item ? ' selected=\"selected\"' : '', item));\n\t\t\telse\n\t\t\t\tbuilder.push(template.format(item[propValue], value === item[propValue] ? ' selected=\"selected\"' : '', item[propText]));\n\t\t}\n\n\t\trender = builder.join('');\n\t\tselect.html(render);\n\t};\n\n\tself.redraw = function() {\n\t\tvar html = '<div class=\"ui-dropdown\"><select data-jc-bind=\"\">{0}</select></div>'.format(render);\n\t\tvar builder = [];\n\t\tvar label = content || config.label;\n\t\tif (label) {\n\t\t\tbuilder.push('<div class=\"ui-dropdown-label\">{0}{1}:</div>'.format(config.icon ? '<span class=\"fa fa-{0}\"></span> '.format(config.icon) : '', label));\n\t\t\tbuilder.push('<div class=\"ui-dropdown-values\">{0}</div>'.format(html));\n\t\t\tself.html(builder.join(''));\n\t\t} else\n\t\t\tself.html(html).aclass('ui-dropdown-values');\n\t\tselect = self.find('select');\n\t\trender && self.refresh();\n\t\tconfig.disabled && self.reconfigure('disabled:true');\n\t\tself.tclass('ui-dropdown-required', config.required === true);\n\t};\n\n\tself.make = function() {\n\t\tself.type = config.type;\n\t\tcontent = self.html();\n\t\tself.aclass('ui-dropdown-container');\n\t\tself.redraw();\n\t\tconfig.if && (condition = FN(config.if));\n\t\tconfig.items && self.reconfigure({ items: config.items });\n\t\tconfig.datasource && self.reconfigure('datasource:' + config.datasource);\n\t};\n\n\tself.state = function(type) {\n\t\tif (!type)\n\t\t\treturn;\n\t\tvar invalid = config.required ? self.isInvalid() : false;\n\t\tif (invalid === self.$oldstate)\n\t\t\treturn;\n\t\tself.$oldstate = invalid;\n\t\tself.tclass('ui-dropdown-invalid', invalid);\n\t};\n});\n\nCOMPONENT('validation', 'delay:100;flags:visible', function(self, config) {\n\n\tvar path, elements = null;\n\tvar def = 'button[name=\"submit\"]';\n\tvar flags = null;\n\n\tself.readonly();\n\n\tself.make = function() {\n\t\telements = self.find(config.selector || def);\n\t\tpath = self.path.replace(/\\.\\*$/, '');\n\t\tsetTimeout(function() {\n\t\t\tself.watch(self.path, self.state, true);\n\t\t}, 50);\n\t};\n\n\tself.configure = function(key, value, init) {\n\t\tswitch (key) {\n\t\t\tcase 'selector':\n\t\t\t\tif (!init)\n\t\t\t\t\telements = self.find(value || def);\n\t\t\t\tbreak;\n\t\t\tcase 'flags':\n\t\t\t\tif (value) {\n\t\t\t\t\tflags = value.split(',');\n\t\t\t\t\tfor (var i = 0; i < flags.length; i++)\n\t\t\t\t\t\tflags[i] = '@' + flags[i];\n\t\t\t\t} else\n\t\t\t\t\tflags = null;\n\t\t\t\tbreak;\n\t\t}\n\t};\n\n\tself.state = function() {\n\t\tsetTimeout2(self.id, function() {\n\t\t\tvar disabled = DISABLED(path, flags);\n\t\t\tif (!disabled && config.if)\n\t\t\t\tdisabled = !EVALUATE(self.path, config.if);\n\t\t\telements.prop('disabled', disabled);\n\t\t}, config.timeout);\n\t};\n});\n\nCOMPONENT('textarea', function(self, config) {\n\n\tvar input, content = null;\n\n\tself.nocompile();\n\n\tself.validate = function(value) {\n\t\tif (config.disabled || !config.required || config.readonly)\n\t\t\treturn true;\n\t\tif (value == null)\n\t\t\tvalue = '';\n\t\telse\n\t\t\tvalue = value.toString();\n\t\treturn value.length > 0;\n\t};\n\n\tself.configure = function(key, value, init) {\n\t\tif (init)\n\t\t\treturn;\n\n\t\tvar redraw = false;\n\n\t\tswitch (key) {\n\t\t\tcase 'readonly':\n\t\t\t\tself.find('textarea').prop('readonly', value);\n\t\t\t\tbreak;\n\t\t\tcase 'disabled':\n\t\t\t\tself.tclass('ui-disabled', value);\n\t\t\t\tself.find('textarea').prop('disabled', value);\n\t\t\t\tself.reset();\n\t\t\t\tbreak;\n\t\t\tcase 'required':\n\t\t\t\tself.noValid(!value);\n\t\t\t\t!value && self.state(1, 1);\n\t\t\t\tself.tclass('ui-textarea-required', value);\n\t\t\t\tbreak;\n\t\t\tcase 'placeholder':\n\t\t\t\tinput.prop('placeholder', value || '');\n\t\t\t\tbreak;\n\t\t\tcase 'maxlength':\n\t\t\t\tinput.prop('maxlength', value || 1000);\n\t\t\t\tbreak;\n\t\t\tcase 'label':\n\t\t\t\tredraw = true;\n\t\t\t\tbreak;\n\t\t\tcase 'autofocus':\n\t\t\t\tinput.focus();\n\t\t\t\tbreak;\n\t\t\tcase 'monospace':\n\t\t\t\tself.tclass('ui-textarea-monospace', value);\n\t\t\t\tbreak;\n\t\t\tcase 'icon':\n\t\t\t\tredraw = true;\n\t\t\t\tbreak;\n\t\t\tcase 'format':\n\t\t\t\tself.format = value;\n\t\t\t\tself.refresh();\n\t\t\t\tbreak;\n\t\t\tcase 'height':\n\t\t\t\tself.find('textarea').css('height', (value > 0 ? value + 'px' : value));\n\t\t\t\tbreak;\n\t\t}\n\n\t\tredraw && setTimeout2('redraw' + self.id, function() {\n\t\t\tself.redraw();\n\t\t\tself.refresh();\n\t\t}, 100);\n\t};\n\n\tself.redraw = function() {\n\n\t\tvar attrs = [];\n\t\tvar builder = [];\n\n\t\tself.tclass('ui-disabled', config.disabled === true);\n\t\tself.tclass('ui-textarea-monospace', config.monospace === true);\n\t\tself.tclass('ui-textarea-required', config.required === true);\n\n\t\tconfig.placeholder && attrs.attr('placeholder', config.placeholder);\n\t\tconfig.maxlength && attrs.attr('maxlength', config.maxlength);\n\t\tconfig.error && attrs.attr('error');\n\t\tattrs.attr('data-jc-bind', '');\n\t\tconfig.height && attrs.attr('style', 'height:{0}px'.format(config.height));\n\t\tconfig.autofocus === 'true' && attrs.attr('autofocus');\n\t\tconfig.disabled && attrs.attr('disabled');\n\t\tconfig.readonly && attrs.attr('readonly');\n\t\tbuilder.push('<textarea {0}></textarea>'.format(attrs.join(' ')));\n\n\t\tvar label = config.label || content;\n\n\t\tif (!label.length) {\n\t\t\tconfig.error && builder.push('<div class=\"ui-textarea-helper\"><i class=\"fa fa-warning\" aria-hidden=\"true\"></i> {0}</div>'.format(config.error));\n\t\t\tself.aclass('ui-textarea ui-textarea-container');\n\t\t\tself.html(builder.join(''));\n\t\t\tinput = self.find('textarea');\n\t\t\treturn;\n\t\t}\n\n\t\tvar html = builder.join('');\n\n\t\tbuilder = [];\n\t\tbuilder.push('<div class=\"ui-textarea-label\">');\n\t\tconfig.icon && builder.push('<i class=\"fa fa-{0}\"></i>'.format(config.icon));\n\t\tbuilder.push(label);\n\t\tbuilder.push(':</div><div class=\"ui-textarea\">{0}</div>'.format(html));\n\t\tconfig.error && builder.push('<div class=\"ui-textarea-helper\"><i class=\"fa fa-warning\" aria-hidden=\"true\"></i> {0}</div>'.format(config.error));\n\n\t\tself.html(builder.join(''));\n\t\tself.rclass('ui-textarea');\n\t\tself.aclass('ui-textarea-container');\n\t\tinput = self.find('textarea');\n\t};\n\n\tself.make = function() {\n\t\tcontent = self.html();\n\t\tself.type = config.type;\n\t\tself.format = config.format;\n\t\tself.redraw();\n\t};\n\n\tself.state = function(type) {\n\t\tif (!type)\n\t\t\treturn;\n\t\tvar invalid = config.required ? self.isInvalid() : false;\n\t\tif (invalid === self.$oldstate)\n\t\t\treturn;\n\t\tself.$oldstate = invalid;\n\t\tself.tclass('ui-textarea-invalid', invalid);\n\t\tconfig.error && self.find('.ui-textarea-helper').tclass('ui-textarea-helper-show', invalid);\n\t};\n});\n\nCOMPONENT('checkbox', function(self, config) {\n\n\tself.nocompile();\n\n\tself.validate = function(value) {\n\t\treturn (config.disabled || !config.required) ? true : (value === true || value === 'true' || value === 'on');\n\t};\n\n\tself.configure = function(key, value, init) {\n\t\tif (init)\n\t\t\treturn;\n\t\tswitch (key) {\n\t\t\tcase 'label':\n\t\t\t\tself.find('span').html(value);\n\t\t\t\tbreak;\n\t\t\tcase 'required':\n\t\t\t\tself.find('span').tclass('ui-checkbox-label-required', value);\n\t\t\t\tbreak;\n\t\t\tcase 'disabled':\n\t\t\t\tself.tclass('ui-disabled', value);\n\t\t\t\tbreak;\n\t\t\tcase 'checkicon':\n\t\t\t\tself.find('i').rclass().aclass('fa fa-' + value);\n\t\t\t\tbreak;\n\t\t}\n\t};\n\n\tself.make = function() {\n\t\tself.aclass('ui-checkbox');\n\t\tself.html('<div><i class=\"fa fa-{2}\"></i></div><span{1}>{0}</span>'.format(config.label || self.html(), config.required ? ' class=\"ui-checkbox-label-required\"' : '', config.checkicon || 'check'));\n\t\tself.event('click', function() {\n\t\t\tif (config.disabled)\n\t\t\t\treturn;\n\t\t\tself.dirty(false);\n\t\t\tself.getter(!self.get());\n\t\t});\n\t};\n\n\tself.setter = function(value) {\n\t\tself.toggle('ui-checkbox-checked', !!value);\n\t};\n});\n\nCOMPONENT('codemirror', 'linenumbers:false;required:false;trim:false;tabs:false', function(self, config) {\n\n\tvar editor = null;\n\n\tself.getter = null;\n\tself.bindvisible();\n\tself.nocompile();\n\n\tself.reload = function() {\n\t\teditor.refresh();\n\t};\n\n\tself.validate = function(value) {\n\t\treturn (config.disabled || !config.required ? true : value && value.length > 0) === true;\n\t};\n\n\tself.insert = function(value) {\n\t\teditor.replaceSelection(value);\n\t\tself.change(true);\n\t};\n\n\tself.configure = function(key, value, init) {\n\t\tif (init)\n\t\t\treturn;\n\n\t\tswitch (key) {\n\t\t\tcase 'disabled':\n\t\t\t\tself.tclass('ui-disabled', value);\n\t\t\t\teditor.readOnly = value;\n\t\t\t\teditor.refresh();\n\t\t\t\tbreak;\n\t\t\tcase 'required':\n\t\t\t\tself.find('.ui-codemirror-label').tclass('ui-codemirror-label-required', value);\n\t\t\t\tself.state(1, 1);\n\t\t\t\tbreak;\n\t\t\tcase 'icon':\n\t\t\t\tself.find('i').rclass().aclass('fa fa-' + value);\n\t\t\t\tbreak;\n\t\t}\n\n\t};\n\n\tself.make = function() {\n\t\tvar content = config.label || self.html();\n\t\tself.html((content ? '<div class=\"ui-codemirror-label' + (config.required ? ' ui-codemirror-label-required' : '') + '\">' + (config.icon ? '<i class=\"fa fa-' + config.icon + '\"></i> ' : '') + content + ':</div>' : '') + '<div class=\"ui-codemirror\"></div>');\n\t\tvar container = self.find('.ui-codemirror');\n\n\t\tvar options = {};\n\t\toptions.lineNumbers = config.linenumbers;\n\t\toptions.mode = config.type || 'htmlmixed';\n\t\toptions.indentUnit = 4;\n\n\t\tif (config.tabs)\n\t\t\toptions.indentWithTabs = true;\n\n\t\tif (config.type === 'markdown') {\n\t\t\toptions.styleActiveLine = true;\n\t\t\toptions.lineWrapping = true;\n\t\t\toptions.matchBrackets = true;\n\t\t}\n\n\t\teditor = CodeMirror(container[0], options);\n\t\tself.editor = editor;\n\n\t\tif (config.height !== 'auto') {\n\t\t\tvar is = typeof(config.height) === 'number';\n\t\t\teditor.setSize('100%', is ? (config.height + 'px') : (config.height || '200px'));\n\t\t\t!is && self.css('height', config.height);\n\t\t}\n\n\t\tif (config.disabled) {\n\t\t\tself.aclass('ui-disabled');\n\t\t\teditor.readOnly = true;\n\t\t\teditor.refresh();\n\t\t}\n\n\t\tvar can = {};\n\t\tcan['+input'] = can['+delete'] = can.undo = can.redo = can.paste = can.cut = can.clear = true;\n\n\t\teditor.on('change', function(a, b) {\n\n\t\t\tif (config.disabled || !can[b.origin])\n\t\t\t\treturn;\n\n\t\t\tsetTimeout2(self.id, function() {\n\t\t\t\tvar val = editor.getValue();\n\n\t\t\t\tif (config.trim) {\n\t\t\t\t\tvar lines = val.split('\\n');\n\t\t\t\t\tfor (var i = 0, length = lines.length; i < length; i++)\n\t\t\t\t\t\tlines[i] = lines[i].replace(/\\s+$/, '');\n\t\t\t\t\tval = lines.join('\\n').trim();\n\t\t\t\t}\n\n\t\t\t\tself.getter2 && self.getter2(val);\n\t\t\t\tself.change(true);\n\t\t\t\tself.rewrite(val);\n\t\t\t\tconfig.required && self.validate2();\n\t\t\t}, 200);\n\n\t\t});\n\t};\n\n\tself.setter = function(value) {\n\n\t\teditor.setValue(value || '');\n\t\teditor.refresh();\n\n\t\tsetTimeout(function() {\n\t\t\teditor.refresh();\n\t\t\teditor.scrollTo(0, 0);\n\t\t\teditor.setCursor(0);\n\t\t}, 200);\n\n\t\tsetTimeout(function() {\n\t\t\teditor.refresh();\n\t\t}, 1000);\n\n\t\tsetTimeout(function() {\n\t\t\teditor.refresh();\n\t\t}, 2000);\n\t};\n\n\tself.state = function(type) {\n\t\tif (!type)\n\t\t\treturn;\n\t\tvar invalid = config.required ? self.isInvalid() : false;\n\t\tif (invalid === self.$oldstate)\n\t\t\treturn;\n\t\tself.$oldstate = invalid;\n\t\tself.find('.ui-codemirror').tclass('ui-codemirror-invalid', invalid);\n\t};\n}, ['//cdnjs.cloudflare.com/ajax/libs/codemirror/5.32.0/codemirror.min.css', '//cdnjs.cloudflare.com/ajax/libs/codemirror/5.32.0/codemirror.min.js', '//cdnjs.cloudflare.com/ajax/libs/codemirror/5.32.0/mode/javascript/javascript.min.js', '//cdnjs.cloudflare.com/ajax/libs/codemirror/5.32.0/mode/htmlmixed/htmlmixed.min.js', '//cdnjs.cloudflare.com/ajax/libs/codemirror/5.32.0/mode/xml/xml.min.js', '//cdnjs.cloudflare.com/ajax/libs/codemirror/5.32.0/mode/css/css.min.js', '//cdnjs.cloudflare.com/ajax/libs/codemirror/5.32.0/mode/markdown/markdown.min.js', function(next) {\n\tCodeMirror.defineMode('totaljsresources', function() {\n\t\tvar REG_KEY = /^[a-z0-9_\\-.#]+/i;\n\t\treturn {\n\n\t\t\tstartState: function() {\n\t\t\t\treturn { type: 0, keyword: 0 };\n\t\t\t},\n\n\t\t\ttoken: function(stream, state) {\n\n\t\t\t\tvar m;\n\n\t\t\t\tif (stream.sol()) {\n\n\t\t\t\t\tvar line = stream.string;\n\t\t\t\t\tif (line.substring(0, 2) === '//') {\n\t\t\t\t\t\tstream.skipToEnd();\n\t\t\t\t\t\treturn 'comment';\n\t\t\t\t\t}\n\n\t\t\t\t\tstate.type = 0;\n\t\t\t\t}\n\n\t\t\t\tm = stream.match(REG_KEY, true);\n\t\t\t\tif (m)\n\t\t\t\t\treturn 'tag';\n\n\t\t\t\tif (!stream.string) {\n\t\t\t\t\tstream.next();\n\t\t\t\t\treturn '';\n\t\t\t\t}\n\n\t\t\t\tvar count = 0;\n\n\t\t\t\twhile (true) {\n\n\t\t\t\t\tcount++;\n\t\t\t\t\tif (count > 5000)\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tvar c = stream.peek();\n\t\t\t\t\tif (c === ':') {\n\t\t\t\t\t\tstream.skipToEnd();\n\t\t\t\t\t\treturn 'def';\n\t\t\t\t\t}\n\n\t\t\t\t\tif (c === '(') {\n\t\t\t\t\t\tif (stream.skipTo(')')) {\n\t\t\t\t\t\t\tstream.eat(')');\n\t\t\t\t\t\t\treturn 'variable-L';\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t\tstream.next();\n\t\t\t\treturn '';\n\t\t\t}\n\t\t};\n\t});\n\tnext();\n}]);\n\nCOMPONENT('nosqlcounter', 'count:0;height:80', function(self, config) {\n\n\tvar months = MONTHS;\n\tvar container, labels;\n\n\tself.bindvisible();\n\tself.readonly();\n\tself.nocompile();\n\n\tself.make = function() {\n\t\tself.aclass('ui-nosqlcounter');\n\t\tself.append('<div class=\"ui-nosqlcounter-table\"{0}><div class=\"ui-nosqlcounter-cell\"></div></div><div class=\"ui-nosqlcounter-labels\"></div>'.format(config.height ? ' style=\"height:{0}px\"'.format(config.height) : ''));\n\t\tcontainer = self.find('.ui-nosqlcounter-cell');\n\t\tlabels = self.find('.ui-nosqlcounter-labels');\n\t};\n\n\tself.configure = function(key, value) {\n\t\tswitch (key) {\n\t\t\tcase 'months':\n\t\t\t\tif (value instanceof Array)\n\t\t\t\t\tmonths = value;\n\t\t\t\telse\n\t\t\t\t\tmonths = value.split(',').trim();\n\t\t\t\tbreak;\n\t\t}\n\t};\n\n\tself.redraw = function(maxbars) {\n\n\t\tvar value = self.get();\n\t\tif (!(value instanceof Array))\n\t\t\tvalue = [];\n\n\t\tvar dt = new Date();\n\t\tdt.setDate(1);\n\t\tvar current = dt.format('yyyyMM');\n\t\tvar stats = null;\n\n\t\tif (config.lastvalues) {\n\t\t\tvar max = value.length - maxbars;\n\t\t\tif (max < 0)\n\t\t\t\tmax = 0;\n\t\t\tstats = value.slice(max, value.length);\n\t\t} else {\n\t\t\tstats = [];\n\t\t\tfor (var i = 0; i < maxbars; i++) {\n\t\t\t\tvar id = dt.format('yyyyMM');\n\t\t\t\tvar item = value.findItem('id', id);\n\t\t\t\tstats.push(item ? item : { id: id, month: dt.getMonth() + 1, year: dt.getFullYear(), value: 0 });\n\t\t\t\tdt = dt.add('-1 month');\n\t\t\t}\n\t\t\tstats.reverse();\n\t\t}\n\n\t\tvar max = stats.scalar('max', 'value');\n\t\tvar bar = 100 / maxbars;\n\t\tvar builder = [];\n\t\tvar dates = [];\n\t\tvar cls = '';\n\t\tvar min = ((20 / config.height) * 100) >> 0;\n\t\tvar sum = '';\n\n\t\tfor (var i = 0, length = stats.length; i < length; i++) {\n\t\t\tvar item = stats[i];\n\t\t\tvar val = item.value;\n\n\t\t\tif (val > 999)\n\t\t\t\tval = (val / 1000).format(1, 2) + 'K';\n\n\t\t\tsum += val + ',';\n\n\t\t\tvar h = max === 0 ? 0 : ((item.value / max) * (100 - min));\n\t\t\th += min;\n\n\t\t\tcls = item.value ? '' : 'empty';\n\n\t\t\tif (item.id === current)\n\t\t\t\tcls += (cls ? ' ' : '') + 'current';\n\n\t\t\tif (i === maxbars - 1)\n\t\t\t\tcls += (cls ? ' ' : '') + 'last';\n\n\t\t\tvar w = bar.format(2, '');\n\n\t\t\tbuilder.push('<div style=\"width:{0}%\" title=\"{3}\" class=\"{4}\"><div style=\"height:{1}%\"><span>{2}</span></div></div>'.format(w, h.format(0, ''), val, months[item.month - 1] + ' ' + item.year, cls));\n\t\t\tdates.push('<div style=\"width:{0}%\">{1}</div>'.format(w, months[item.month - 1].substring(0, 3)));\n\t\t}\n\n\t\tif (self.old !== sum) {\n\t\t\tself.old = sum;\n\t\t\tlabels.html(dates.join(''));\n\t\t\tcontainer.html(builder.join(''));\n\t\t}\n\t};\n\n\tself.setter = function(value) {\n\t\tif (config.count === 0) {\n\t\t\tself.width(function(width) {\n\t\t\t\tself.redraw(width / 30 >> 0);\n\t\t\t});\n\t\t} else\n\t\t\tself.redraw(WIDTH() === 'xs' ? config.count / 2 : config.count, value);\n\t};\n});\n\nCOMPONENT('keyvalue', 'maxlength:100', function(self, config) {\n\n\tvar container, content = null;\n\tvar cempty = 'empty';\n\tvar skip = false;\n\tvar empty = {};\n\n\tself.template = Tangular.compile('<div class=\"ui-keyvalue-item\"><div class=\"ui-keyvalue-item-remove\"><i class=\"fa fa-times\"></i></div><div class=\"ui-keyvalue-item-key\"><input type=\"text\" name=\"key\" maxlength=\"{{ max }}\"{{ if disabled }} disabled=\"disabled\"{{ fi }} placeholder=\"{{ placeholder_key }}\" value=\"{{ key }}\" /></div><div class=\"ui-keyvalue-item-value\"><input type=\"text\" maxlength=\"{{ max }}\" placeholder=\"{{ placeholder_value }}\" value=\"{{ value }}\" /></div></div>');\n\tself.nocompile();\n\n\tself.binder = function(type, value) {\n\t\treturn value;\n\t};\n\n\tself.configure = function(key, value, init, prev) {\n\t\tif (init)\n\t\t\treturn;\n\n\t\tvar redraw = false;\n\n\t\tswitch (key) {\n\t\t\tcase 'disabled':\n\t\t\t\tself.tclass('ui-disabled', value);\n\t\t\t\tself.find('input').prop('disabled', value);\n\t\t\t\tempty.disabled = value;\n\t\t\t\tbreak;\n\t\t\tcase 'maxlength':\n\t\t\t\tself.find('input').prop('maxlength', value);\n\t\t\t\tbreak;\n\t\t\tcase 'placeholderkey':\n\t\t\t\tself.find('input[name=\"key\"]').prop('placeholder', value);\n\t\t\t\tbreak;\n\t\t\tcase 'placeholdervalue':\n\t\t\t\tself.find('input[name=\"value\"]').prop('placeholder', value);\n\t\t\t\tbreak;\n\t\t\tcase 'icon':\n\t\t\t\tif (value && prev)\n\t\t\t\t\tself.find('i').rclass('fa').aclass('fa fa-' + value);\n\t\t\t\telse\n\t\t\t\t\tredraw = true;\n\t\t\t\tbreak;\n\n\t\t\tcase 'label':\n\t\t\t\tredraw = true;\n\t\t\t\tbreak;\n\t\t}\n\n\t\tif (redraw) {\n\t\t\tself.redraw();\n\t\t\tself.refresh();\n\t\t}\n\t};\n\n\tself.redraw = function() {\n\n\t\tvar icon = config.icon;\n\t\tvar label = config.label || content;\n\n\t\tif (icon)\n\t\t\ticon = '<i class=\"fa fa-{0}\"></i>'.format(icon);\n\n\t\tempty.value = '';\n\n\t\tself.html((label ? '<div class=\"ui-keyvalue-label\">{1}{0}:</div>'.format(label, icon) : '') + '<div class=\"ui-keyvalue-items\"></div>' + self.template(empty).replace('-item\"', '-item ui-keyvalue-base\"'));\n\t\tcontainer = self.find('.ui-keyvalue-items');\n\t};\n\n\tself.make = function() {\n\n\t\tempty.max = config.maxlength;\n\t\tempty.placeholder_key = config.placeholderkey;\n\t\tempty.placeholder_value = config.placeholdervalue;\n\t\tempty.value = '';\n\t\tempty.disabled = config.disabled;\n\n\t\tcontent = self.html();\n\n\t\tself.aclass('ui-keyvalue');\n\t\tself.disabled && self.aclass('ui-disabled');\n\t\tself.redraw();\n\n\t\tself.event('click', '.fa-times', function() {\n\n\t\t\tif (config.disabled)\n\t\t\t\treturn;\n\n\t\t\tvar el = $(this);\n\t\t\tvar parent = el.closest('.ui-keyvalue-item');\n\t\t\tvar inputs = parent.find('input');\n\t\t\tvar obj = self.get();\n\t\t\t!obj && (obj = {});\n\t\t\tvar key = inputs[0].value;\n\t\t\tparent.remove();\n\t\t\tdelete obj[key];\n\n\t\t\tself.set(obj, 2);\n\t\t\tself.change(true);\n\t\t});\n\n\t\tself.event('change keypress', 'input', function(e) {\n\n\t\t\tif (config.disabled || (e.type !== 'change' && e.which !== 13))\n\t\t\t\treturn;\n\n\t\t\tvar el = $(this);\n\t\t\tvar inputs = el.closest('.ui-keyvalue-item').find('input');\n\t\t\tvar key = self.binder('key', inputs[0].value);\n\t\t\tvar value = self.binder('value', inputs.get(1).value);\n\n\t\t\tif (!key || !value)\n\t\t\t\treturn;\n\n\t\t\tvar base = el.closest('.ui-keyvalue-base').length > 0;\n\t\t\tif (base && e.type === 'change')\n\t\t\t\treturn;\n\n\t\t\tif (base) {\n\t\t\t\tvar tmp = self.get();\n\t\t\t\t!tmp && (tmp = {});\n\t\t\t\ttmp[key] = value;\n\t\t\t\tself.set(tmp);\n\t\t\t\tself.change(true);\n\t\t\t\tinputs.val('');\n\t\t\t\tinputs.eq(0).focus();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar keyvalue = {};\n\t\t\tvar k;\n\n\t\t\tcontainer.find('input').each(function() {\n\t\t\t\tif (this.name === 'key') {\n\t\t\t\t\tk = this.value.trim();\n\t\t\t\t} else if (k) {\n\t\t\t\t\tkeyvalue[k] = this.value.trim();\n\t\t\t\t\tk = '';\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tskip = true;\n\t\t\tself.set(keyvalue, 2);\n\t\t\tself.change(true);\n\t\t});\n\t};\n\n\tself.setter = function(value) {\n\n\t\tif (skip) {\n\t\t\tskip = false;\n\t\t\treturn;\n\t\t}\n\n\t\tif (!value) {\n\t\t\tcontainer.empty();\n\t\t\tself.aclass(cempty);\n\t\t\treturn;\n\t\t}\n\n\t\tvar builder = [];\n\n\t\tObject.keys(value).forEach(function(key) {\n\t\t\tempty.key = key;\n\t\t\tempty.value = value[key];\n\t\t\tbuilder.push(self.template(empty));\n\t\t});\n\n\t\tself.tclass(cempty, builder.length === 0);\n\t\tcontainer.empty().append(builder.join(''));\n\t};\n});\n\nCOMPONENT('expander', function(self, config) {\n\n\tvar prev = false;\n\n\tself.readonly();\n\tself.blind();\n\n\tself.toggle = function(v) {\n\n\t\tif (v == null)\n\t\t\tv = !self.hclass('ui-expander-expanded');\n\n\t\tif (v === prev)\n\t\t\treturn;\n\n\t\tprev = v;\n\t\tself.tclass('ui-expander-expanded', v);\n\t\tvar fa = self.find('.ui-expander-button').find('.fa');\n\t\tfa.tclass('fa-angle-double-down', !v);\n\t\tfa.tclass('fa-angle-double-up', v);\n\t};\n\n\tself.make = function() {\n\t\tself.aclass('ui-expander' + (config.expand ? ' ui-expander-expanded' : ''));\n\t\tself.element.wrapInner('<div class=\"ui-expander-container\"></div>');\n\t\tself.append('<div class=\"ui-expander-fade\"></div><div class=\"ui-expander-button\"><span class=\"fa fa-angle-double-down\"></span></div>');\n\t\tself.event('click', '.ui-expander-button', function() {\n\t\t\tself.toggle();\n\t\t});\n\t};\n});\n\nCOMPONENT('disable', function(self, config) {\n\n\tvar validate = null;\n\tself.readonly();\n\n\tself.configure = function(key, value) {\n\t\tif (key === 'validate')\n\t\t\tvalidate = value.split(',').trim();\n\t};\n\n\tself.setter = function(value) {\n\t\tvar is = true;\n\n\t\tif (config.if)\n\t\t\tis = EVALUATE(self.path, config.if);\n\t\telse\n\t\t\tis = !value;\n\n\t\tself.find(config.selector || '[data-jc]').each(function() {\n\t\t\tvar com = $(this).component();\n\t\t\tcom && com.reconfigure('disabled:' + is);\n\t\t});\n\n\t\tvalidate && validate.forEach(FN('n => RESET({0}n)'.format(self.pathscope ? '\\'' + self.pathscope + '.\\'+' : '')));\n\t};\n\n\tself.state = function() {\n\t\tself.update();\n\t};\n});\n\nCOMPONENT('textboxlist', 'maxlength:100', function(self, config) {\n\n\tvar container, content;\n\tvar empty = {};\n\tvar skip = false;\n\tvar cempty = 'empty';\n\n\tself.readonly();\n\tself.nocompile();\n\tself.template = Tangular.compile('<div class=\"ui-textboxlist-item\"><div><i class=\"fa fa-times\"></i></div><div><input type=\"text\" maxlength=\"{{ max }}\" placeholder=\"{{ placeholder }}\"{{ if disabled}} disabled=\"disabled\"{{ fi }} value=\"{{ value }}\" /></div></div>');\n\n\tself.configure = function(key, value, init, prev) {\n\t\tif (init)\n\t\t\treturn;\n\n\t\tvar redraw = false;\n\t\tswitch (key) {\n\t\t\tcase 'disabled':\n\t\t\t\tself.tclass('ui-required', value);\n\t\t\t\tself.find('input').prop('disabled', true);\n\t\t\t\tempty.disabled = value;\n\t\t\t\tbreak;\n\t\t\tcase 'maxlength':\n\t\t\t\tempty.max = value;\n\t\t\t\tself.find('input').prop(key, value);\n\t\t\t\tbreak;\n\t\t\tcase 'placeholder':\n\t\t\t\tempty.placeholder = value;\n\t\t\t\tself.find('input').prop(key, value);\n\t\t\t\tbreak;\n\t\t\tcase 'label':\n\t\t\t\tredraw = true;\n\t\t\t\tbreak;\n\t\t\tcase 'icon':\n\t\t\t\tif (value && prev)\n\t\t\t\t\tself.find('i').rclass().aclass(value);\n\t\t\t\telse\n\t\t\t\t\tredraw = true;\n\t\t\t\tbreak;\n\t\t}\n\n\t\tif (redraw) {\n\t\t\tskip = false;\n\t\t\tself.redraw();\n\t\t\tself.refresh();\n\t\t}\n\t};\n\n\tself.redraw = function() {\n\n\t\tvar icon = '';\n\t\tvar html = config.label || content;\n\n\t\tif (config.icon)\n\t\t\ticon = '<i class=\"fa fa-{0}\"></i>'.format(config.icon);\n\n\t\tempty.value = '';\n\t\tself.html((html ? '<div class=\"ui-textboxlist-label\">{1}{0}:</div>'.format(html, icon) : '') + '<div class=\"ui-textboxlist-items\"></div>' + self.template(empty).replace('-item\"', '-item ui-textboxlist-base\"'));\n\t\tcontainer = self.find('.ui-textboxlist-items');\n\t};\n\n\tself.make = function() {\n\n\t\tempty.max = config.max;\n\t\tempty.placeholder = config.placeholder;\n\t\tempty.value = '';\n\t\tempty.disabled = config.disabled;\n\n\t\tif (config.disabled)\n\t\t\tself.aclass('ui-disabled');\n\n\t\tcontent = self.html();\n\t\tself.aclass('ui-textboxlist');\n\t\tself.redraw();\n\n\t\tself.event('click', '.fa-times', function() {\n\n\t\t\tif (config.disabled)\n\t\t\t\treturn;\n\n\t\t\tvar el = $(this);\n\t\t\tvar parent = el.closest('.ui-textboxlist-item');\n\t\t\tvar value = parent.find('input').val();\n\t\t\tvar arr = self.get();\n\n\t\t\tparent.remove();\n\n\t\t\tvar index = arr.indexOf(value);\n\t\t\tif (index === -1)\n\t\t\t\treturn;\n\n\t\t\tarr.splice(index, 1);\n\n\t\t\tself.tclass(cempty, arr.length === 0);\n\n\t\t\tskip = true;\n\t\t\tself.set(arr, 2);\n\t\t\tself.change(true);\n\t\t});\n\n\t\tself.event('change keypress', 'input', function(e) {\n\n\t\t\tif (config.disabled || (e.type !== 'change' && e.which !== 13))\n\t\t\t\treturn;\n\n\t\t\tvar el = $(this);\n\n\t\t\tvar value = this.value.trim();\n\t\t\tif (!value)\n\t\t\t\treturn;\n\n\t\t\tvar arr = [];\n\t\t\tvar base = el.closest('.ui-textboxlist-base').length > 0;\n\n\t\t\tif (base && e.type === 'change')\n\t\t\t\treturn;\n\n\t\t\tvar raw = self.get();\n\n\t\t\tif (base) {\n\n\t\t\t\tif (!raw || raw.indexOf(value) === -1)\n\t\t\t\t\tself.push(self.path, value, 2);\n\n\t\t\t\tthis.value = '';\n\t\t\t\tself.change(true);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tcontainer.find('input').each(function() {\n\t\t\t\tarr.push(this.value.trim());\n\t\t\t});\n\n\t\t\tskip = true;\n\t\t\tself.set(arr, 2);\n\t\t\tself.change(true);\n\t\t});\n\t};\n\n\tself.setter = function(value) {\n\n\t\tif (skip) {\n\t\t\tskip = false;\n\t\t\treturn;\n\t\t}\n\n\t\tif (!value || !value.length) {\n\t\t\tself.aclass(cempty);\n\t\t\tcontainer.empty();\n\t\t\treturn;\n\t\t}\n\n\t\tself.rclass(cempty);\n\n\t\tvar builder = [];\n\n\t\tvalue.forEach(function(item) {\n\t\t\tempty.value = item;\n\t\t\tbuilder.push(self.template(empty));\n\t\t});\n\n\t\tcontainer.empty().append(builder.join(''));\n\t};\n});\n\nCOMPONENT('dropdowncheckbox', 'checkicon:check;visible:0;alltext:All selected;limit:0;selectedtext:{0} selected', function(self, config) {\n\n\tvar data = [], render = '';\n\tvar container, values, content, datasource = null;\n\tvar prepared = false;\n\tvar W = window;\n\n\t!W.$dropdowncheckboxtemplate && (W.$dropdowncheckboxtemplate = Tangular.compile('<div class=\"ui-dropdowncheckbox-item\" data-index=\"{{ index }}\"><div><i class=\"fa fa-{{ $.checkicon }}\"></i></div><span>{{ text }}</span></div>'));\n\tvar template = W.$dropdowncheckboxtemplate;\n\n\tself.nocompile();\n\n\tself.validate = function(value) {\n\t\treturn config.disabled || !config.required ? true : value && value.length > 0;\n\t};\n\n\tself.configure = function(key, value, init) {\n\n\t\tif (init)\n\t\t\treturn;\n\n\t\tvar redraw = false;\n\n\t\tswitch (key) {\n\n\t\t\tcase 'type':\n\t\t\t\tself.type = value;\n\t\t\t\tbreak;\n\n\t\t\tcase 'required':\n\t\t\t\tself.tclass('ui-dropdowncheckbox-required', config.required);\n\t\t\t\tbreak;\n\n\t\t\tcase 'label':\n\t\t\t\tcontent = value;\n\t\t\t\tredraw = true;\n\t\t\t\tbreak;\n\n\t\t\tcase 'disabled':\n\t\t\t\tself.tclass('ui-disabled', value);\n\t\t\t\tself.reset();\n\t\t\t\tbreak;\n\n\t\t\tcase 'checkicon':\n\t\t\t\tself.find('i').rclass().aclass('fa fa-' + value);\n\t\t\t\tbreak;\n\n\t\t\tcase 'icon':\n\t\t\t\tredraw = true;\n\t\t\t\tbreak;\n\n\t\t\tcase 'datasource':\n\t\t\t\tself.datasource(value, self.bind);\n\t\t\t\tdatasource && self.refresh();\n\t\t\t\tdatasource = value;\n\t\t\t\tbreak;\n\n\t\t\tcase 'items':\n\n\t\t\t\tif (value instanceof Array) {\n\t\t\t\t\tself.bind('', value);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tvar items = [];\n\t\t\t\tvalue.split(',').forEach(function(item) {\n\t\t\t\t\titem = item.trim().split('|');\n\t\t\t\t\tvar val = (item[1] == null ? item[0] : item[1]).trim();\n\t\t\t\t\tif (config.type === 'number')\n\t\t\t\t\t\tval = +val;\n\t\t\t\t\titems.push({ name: item[0].trim(), id: val });\n\t\t\t\t});\n\n\t\t\t\tself.bind('', items);\n\t\t\t\tself.refresh();\n\t\t\t\tbreak;\n\t\t}\n\n\t\tredraw && setTimeout2(self.id + '.redraw', self.redraw, 100);\n\t};\n\n\tself.redraw = function() {\n\n\t\tvar html = '<div class=\"ui-dropdowncheckbox\"><span class=\"fa fa-caret-down\"></span><div class=\"ui-dropdowncheckbox-selected\"></div></div><div class=\"ui-dropdowncheckbox-values hidden\">{0}</div>'.format(render);\n\t\tif (content.length)\n\t\t\tself.html('<div class=\"ui-dropdowncheckbox-label\">{0}{1}:</div>'.format(config.icon ? ('<i class=\"fa fa-' + config.icon + '\"></i>') : '', content) + html);\n\t\telse\n\t\t\tself.html(html);\n\n\t\tcontainer = self.find('.ui-dropdowncheckbox-values');\n\t\tvalues = self.find('.ui-dropdowncheckbox-selected');\n\t\tprepared && self.refresh();\n\t\tself.tclass('ui-disabled', config.disabled === true);\n\t\tself.tclass('ui-dropdowncheckbox-required', config.required === true);\n\t};\n\n\tself.make = function() {\n\n\t\tself.type = config.type;\n\n\t\tcontent = self.html();\n\t\tself.aclass('ui-dropdowncheckbox-container');\n\t\tself.redraw();\n\n\t\tif (config.items)\n\t\t\tself.reconfigure({ items: config.items });\n\t\telse if (config.datasource)\n\t\t\tself.reconfigure({ datasource: config.datasource });\n\t\telse\n\t\t\tself.bind('', null);\n\n\t\tself.event('click', '.ui-dropdowncheckbox', function(e) {\n\n\t\t\tif (config.disabled)\n\t\t\t\treturn;\n\n\t\t\tcontainer.tclass('hidden');\n\n\t\t\tif (W.$dropdowncheckboxelement) {\n\t\t\t\tW.$dropdowncheckboxelement.aclass('hidden');\n\t\t\t\tW.$dropdowncheckboxelement = null;\n\t\t\t}\n\n\t\t\t!container.hclass('hidden') && (W.$dropdowncheckboxelement = container);\n\t\t\te.stopPropagation();\n\t\t});\n\n\t\tself.event('click', '.ui-dropdowncheckbox-item', function(e) {\n\n\t\t\te.stopPropagation();\n\n\t\t\tif (config.disabled)\n\t\t\t\treturn;\n\n\t\t\tvar el = $(this);\n\t\t\tvar is = !el.hclass('ui-dropdowncheckbox-checked');\n\t\t\tvar index = +el.attrd('index');\n\t\t\tvar value = data[index];\n\n\t\t\tif (value === undefined)\n\t\t\t\treturn;\n\n\t\t\tvalue = value.value;\n\n\t\t\tvar arr = self.get();\n\n\t\t\tif (!(arr instanceof Array))\n\t\t\t\tarr = [];\n\n\t\t\tvar index = arr.indexOf(value);\n\n\t\t\tif (is) {\n\t\t\t\tif (config.limit && arr.length === config.limit)\n\t\t\t\t\treturn;\n\t\t\t\tindex === -1 && arr.push(value);\n\t\t\t} else {\n\t\t\t\tindex !== -1 && arr.splice(index, 1);\n\t\t\t}\n\n\t\t\tself.set(arr);\n\t\t\tself.change(true);\n\t\t});\n\t};\n\n\tself.bind = function(path, value) {\n\t\tvar clsempty = 'ui-dropdowncheckbox-values-empty';\n\n\t\tif (value !== undefined)\n\t\t\tprepared = true;\n\n\t\tif (!value || !value.length) {\n\t\t\tvar h = config.empty || '&nbsp;';\n\t\t\tif (h === self.old)\n\t\t\t\treturn;\n\t\t\tcontainer.aclass(clsempty).html(h);\n\t\t\tself.old = h;\n\t\t\treturn;\n\t\t}\n\n\t\tvar kv = config.value || 'id';\n\t\tvar kt = config.text || 'name';\n\n\t\trender = '';\n\t\tdata = [];\n\n\t\tfor (var i = 0, length = value.length; i < length; i++) {\n\t\t\tvar isString = typeof(value[i]) === 'string';\n\t\t\tvar item = { value: isString ? value[i] : value[i][kv], text: isString ? value[i] : value[i][kt], index: i };\n\t\t\trender += template(item, config);\n\t\t\tdata.push(item);\n\t\t}\n\n\t\tvar h = HASH(render);\n\t\tif (h === self.old)\n\t\t\treturn;\n\n\t\tself.old = h;\n\n\t\tif (render)\n\t\t\tcontainer.rclass(clsempty).html(render);\n\t\telse\n\t\t\tcontainer.aclass(clsempty).html(config.empty);\n\n\t\tself.refresh();\n\t};\n\n\tself.setter = function(value) {\n\n\t\tif (!prepared)\n\t\t\treturn;\n\n\t\tvar label = '';\n\t\tvar count = value == null || !value.length ? undefined : value.length;\n\n\t\tif (value && count) {\n\t\t\tvar remove = [];\n\t\t\tfor (var i = 0; i < count; i++) {\n\t\t\t\tvar selected = value[i];\n\t\t\t\tvar index = 0;\n\t\t\t\tvar is = false;\n\t\t\t\twhile (true) {\n\t\t\t\t\tvar item = data[index++];\n\t\t\t\t\tif (item === undefined)\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tif (item.value != selected)\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\tlabel += (label ? ', ' : '') + item.text;\n\t\t\t\t\tis = true;\n\t\t\t\t}\n\t\t\t\t!is && remove.push(selected);\n\t\t\t}\n\n\t\t\tif (config.cleaner !== false && value) {\n\t\t\t\tvar refresh = false;\n\t\t\t\twhile (true) {\n\t\t\t\t\tvar item = remove.shift();\n\t\t\t\t\tif (item === undefined)\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tvalue.splice(value.indexOf(item), 1);\n\t\t\t\t\trefresh = true;\n\t\t\t\t}\n\t\t\t\trefresh && self.set(value);\n\t\t\t}\n\t\t}\n\n\t\tcontainer.find('.ui-dropdowncheckbox-item').each(function() {\n\t\t\tvar el = $(this);\n\t\t\tvar index = +el.attrd('index');\n\t\t\tvar checked = false;\n\t\t\tif (!value || !value.length)\n\t\t\t\tchecked = false;\n\t\t\telse if (data[index])\n\t\t\t\tchecked = data[index];\n\t\t\tchecked && (checked = value.indexOf(checked.value) !== -1);\n\t\t\tel.tclass('ui-dropdowncheckbox-checked', checked);\n\t\t});\n\n\t\tif (!label && value && config.cleaner !== false) {\n\t\t\t// invalid data\n\t\t\t// it updates model without notification\n\t\t\tself.rewrite([]);\n\t\t}\n\n\t\tif (!label && config.placeholder) {\n\t\t\tvalues.rattr('title', '');\n\t\t\tvalues.html('<span>{0}</span>'.format(config.placeholder));\n\t\t} else {\n\t\t\tif (count == data.length && config.alltext !== 'null' && config.alltext)\n\t\t\t\tlabel = config.alltext;\n\t\t\telse if (config.visible && count > config.visible)\n\t\t\t\tlabel = config.selectedtext.format(count, data.length);\n\t\t\tvalues.attr('title', label);\n\t\t\tvalues.html(label);\n\t\t}\n\t};\n\n\tself.state = function(type) {\n\t\tif (!type)\n\t\t\treturn;\n\t\tvar invalid = config.required ? self.isInvalid() : false;\n\t\tif (invalid === self.$oldstate)\n\t\t\treturn;\n\t\tself.$oldstate = invalid;\n\t\tself.tclass('ui-dropdowncheckbox-invalid', invalid);\n\t};\n\n\tif (W.$dropdowncheckboxevent)\n\t\treturn;\n\n\tW.$dropdowncheckboxevent = true;\n\t$(document).on('click', function() {\n\t\tif (W.$dropdowncheckboxelement) {\n\t\t\tW.$dropdowncheckboxelement.aclass('hidden');\n\t\t\tW.$dropdowncheckboxelement = null;\n\t\t}\n\t});\n});\n\nCOMPONENT('snackbar', 'timeout:3000;button:Dismiss', function(self, config) {\n\n\tvar show = true;\n\tvar callback;\n\n\tself.readonly();\n\tself.blind();\n\tself.nocompile();\n\n\tself.make = function() {\n\t\tself.aclass('ui-snackbar hidden');\n\t\tself.append('<div><a href=\"javasc' + 'ript:void(0)\" class=\"ui-snackbar-dismiss\"></a><div class=\"ui-snackbar-body\"></div></div>');\n\t\tself.event('click', '.ui-snackbar-dismiss', function() {\n\t\t\tself.hide();\n\t\t\tcallback && callback();\n\t\t});\n\t};\n\n\tself.hide = function() {\n\t\tself.rclass('ui-snackbar-visible');\n\t\tsetTimeout(function() {\n\t\t\tself.aclass('hidden');\n\t\t}, 1000);\n\t\tshow = true;\n\t};\n\n\tself.success = function(message, button, close) {\n\t\tself.show('<i class=\"fa fa-check-circle ui-snackbar-icon\"></i>' + message, button, close);\n\t};\n\n\tself.warning = function(message, button, close) {\n\t\tself.show('<i class=\"fa fa-times-circle ui-snackbar-icon\"></i>' + message, button, close);\n\t};\n\n\tself.show = function(message, button, close) {\n\n\t\tif (typeof(button) === 'function') {\n\t\t\tclose = button;\n\t\t\tbutton = null;\n\t\t}\n\n\t\tcallback = close;\n\n\t\tself.find('.ui-snackbar-body').html(message);\n\t\tself.find('.ui-snackbar-dismiss').html(button || config.button);\n\n\t\tif (show) {\n\t\t\tself.rclass('hidden');\n\t\t\tsetTimeout(function() {\n\t\t\t\tself.aclass('ui-snackbar-visible');\n\t\t\t}, 50);\n\t\t}\n\n\t\tsetTimeout2(self.ID, self.hide, config.timeout + 50);\n\t\tshow = false;\n\t};\n});\n\nCOMPONENT('repeater', 'hidden:true;check:true', function(self, config) {\n\n\tvar filter = null;\n\tvar recompile = false;\n\tvar reg = /\\$(index|path)/g;\n\n\tself.readonly();\n\n\tself.configure = function(key, value) {\n\t\tif (key === 'filter')\n\t\t\tfilter = value ? GET(value) : null;\n\t};\n\n\tself.make = function() {\n\t\tvar element = self.find('script');\n\t\tif (!element.length) {\n\t\t\telement = self.element;\n\t\t\tself.element = self.element.parent();\n\t\t}\n\n\t\tvar html = element.html();\n\t\telement.remove();\n\t\tself.template = Tangular.compile(html);\n\t\trecompile = (/data-jc=\"|data-bind=\"/).test(html);\n\t};\n\n\tself.setter = function(value) {\n\n\t\tif (!value || !value.length) {\n\t\t\tconfig.hidden && self.aclass('hidden');\n\t\t\tself.empty();\n\t\t\tself.cache = '';\n\t\t\treturn;\n\t\t}\n\n\t\tvar builder = [];\n\t\tfor (var i = 0, length = value.length; i < length; i++) {\n\t\t\tvar item = value[i];\n\t\t\titem.index = i;\n\t\t\tif (!filter || filter(item)) {\n\t\t\t\tbuilder.push(self.template(item).replace(reg, function(text) {\n\t\t\t\t\treturn text.substring(0, 2) === '$i' ? i.toString() : self.path + '[' + i + ']';\n\t\t\t\t}));\n\t\t\t}\n\t\t}\n\n\t\tvar tmp = builder.join('');\n\n\t\tif (config.check) {\n\t\t\tif (tmp === self.cache)\n\t\t\t\treturn;\n\t\t\tself.cache = tmp;\n\t\t}\n\n\t\tself.html(tmp);\n\t\tconfig.hidden && self.rclass('hidden');\n\t\trecompile && self.compile();\n\t};\n});\n\nCOMPONENT('confirm', function(self) {\n\n\tvar is, visible = false;\n\n\tself.readonly();\n\tself.singleton();\n\tself.nocompile();\n\n\tself.make = function() {\n\n\t\tself.aclass('ui-confirm hidden');\n\n\t\tself.event('click', 'button', function() {\n\t\t\tself.hide($(this).attrd('index').parseInt());\n\t\t});\n\n\t\tself.event('click', function(e) {\n\t\t\tvar t = e.target.tagName;\n\t\t\tif (t !== 'DIV')\n\t\t\t\treturn;\n\t\t\tvar el = self.find('.ui-confirm-body');\n\t\t\tel.aclass('ui-confirm-click');\n\t\t\tsetTimeout(function() {\n\t\t\t\tel.rclass('ui-confirm-click');\n\t\t\t}, 300);\n\t\t});\n\n\t\t$(window).on('keydown', function(e) {\n\t\t\tif (!visible)\n\t\t\t\treturn;\n\t\t\tvar index = e.which === 13 ? 0 : e.which === 27 ? 1 : null;\n\t\t\tif (index != null) {\n\t\t\t\tself.find('button[data-index=\"{0}\"]'.format(index)).trigger('click');\n\t\t\t\te.preventDefault();\n\t\t\t\te.stopPropagation();\n\t\t\t}\n\t\t});\n\t};\n\n\tself.show = self.confirm = function(message, buttons, fn) {\n\t\tself.callback = fn;\n\n\t\tvar builder = [];\n\n\t\tfor (var i = 0; i < buttons.length; i++) {\n\t\t\tvar item = buttons[i];\n\t\t\tvar icon = item.match(/\"[a-z0-9-]+\"/);\n\t\t\tif (icon) {\n\t\t\t\titem = item.replace(icon, '').trim();\n\t\t\t\ticon = '<i class=\"fa fa-{0}\"></i>'.format(icon.toString().replace(/\"/g, ''));\n\t\t\t} else\n\t\t\t\ticon = '';\n\t\t\tbuilder.push('<button data-index=\"{1}\">{2}{0}</button>'.format(item, i, icon));\n\t\t}\n\n\t\tself.content('ui-confirm-warning', '<div class=\"ui-confirm-message\">{0}</div>{1}'.format(message.replace(/\\n/g, '<br />'), builder.join('')));\n\t};\n\n\tself.hide = function(index) {\n\t\tself.callback && self.callback(index);\n\t\tself.rclass('ui-confirm-visible');\n\t\tvisible = false;\n\t\tsetTimeout2(self.id, function() {\n\t\t\t$('html').rclass('ui-confirm-noscroll');\n\t\t\tself.aclass('hidden');\n\t\t}, 1000);\n\t};\n\n\tself.content = function(cls, text) {\n\t\t$('html').aclass('ui-confirm-noscroll');\n\t\t!is && self.html('<div><div class=\"ui-confirm-body\"></div></div>');\n\t\tself.find('.ui-confirm-body').empty().append(text);\n\t\tself.rclass('hidden');\n\t\tvisible = true;\n\t\tsetTimeout2(self.id, function() {\n\t\t\tself.aclass('ui-confirm-visible');\n\t\t}, 5);\n\t};\n});\n\nCOMPONENT('crop', 'dragdrop:true;format:{0}', function(self, config) {\n\n\tvar canvas, context;\n\tvar img = new Image();\n\tvar can = false;\n\tvar is = false;\n\tvar zoom = 100;\n\tvar current = { x: 0, y: 0 };\n\tvar offset = { x: 0, y: 0 };\n\tvar cache = { x: 0, y: 0, zoom: 0 };\n\tvar width = 0;\n\tvar samesize = '';\n\n\tself.bindvisible();\n\tself.novalidate();\n\tself.nocompile && self.nocompile();\n\tself.getter = null;\n\n\timg.crossOrigin = 'anonymous';\n\timg.onload = function () {\n\t\tcan = true;\n\t\tzoom = 100;\n\n\t\tvar width = config.width;\n\t\tvar height = config.height;\n\n\t\tsamesize = img.width === width && img.height === height && img.src.substring(0, 5) !== 'data:' ? $(img).attr('src') : '';\n\n\t\tvar nw = (img.width / 2);\n\t\tvar nh = (img.height / 2);\n\n\t\tif (img.width > width) {\n\t\t\tvar p = (width / (img.width / 100));\n\t\t\tzoom -= zoom - p;\n\t\t\tnh = ((img.height * (p / 100)) / 2);\n\t\t\tnw = ((img.width * (p / 100)) / 2);\n\t\t}\n\n\t\t// centering\n\t\tcache.x = current.x = (width / 2) - nw;\n\t\tcache.y = current.y = (height / 2) - nh;\n\t\tcache.zoom = zoom;\n\t\tself.redraw();\n\t};\n\n\tself.configure = function(key, value, init) {\n\t\tif (init)\n\t\t\treturn;\n\t\tswitch (key) {\n\t\t\tcase 'width':\n\t\t\tcase 'height':\n\t\t\t\tcache.x = current.x = cache.y = current.y = 0;\n\t\t\t\tsetTimeout2(self._id + 'resize', self.redraw, 50);\n\t\t\t\tbreak;\n\t\t}\n\t};\n\n\tself.output = function(type) {\n\t\tvar canvas2 = document.createElement('canvas');\n\t\tvar ctx2 = canvas2.getContext('2d');\n\n\t\tcanvas2.width = config.width;\n\t\tcanvas2.height = config.height;\n\n\t\tctx2.clearRect(0, 0, canvas2.width, canvas2.height);\n\n\t\tif (config.background) {\n\t\t\tctx2.fillStyle = config.background;\n\t\t\tctx2.fillRect(0, 0, canvas2.width, canvas2.height);\n\t\t}\n\n\t\tvar w = img.width;\n\t\tvar h = img.height;\n\n\t\tw = ((w / 100) * zoom);\n\t\th = ((h / 100) * zoom);\n\n\t\tctx2.drawImage(img, current.x || 0, current.y || 0, w, h);\n\t\treturn type ? canvas2.toDataURL(type) : !config.background && self.isTransparent(canvas2) ? canvas2.toDataURL('image/png') : canvas2.toDataURL('image/jpeg');\n\t};\n\n\tself.make = function() {\n\n\t\tself.aclass('ui-crop');\n\t\tself.append('<ul><li data-type=\"upload\"><span class=\"fa fa-folder\"></span></li><li data-type=\"plus\"><span class=\"fa fa-plus\"></span></li><li data-type=\"refresh\"><span class=\"fa fa-refresh\"></span></li><li data-type=\"minus\"><span class=\"fa fa-minus\"></span></li></ul><div>0x0</div><canvas width=\"200\" height=\"100\"></canvas>');\n\n\t\tcanvas = self.find('canvas')[0];\n\t\tcontext = canvas.getContext('2d');\n\n\t\tself.event('click', 'li', function(e) {\n\n\t\t\te.preventDefault();\n\t\t\te.stopPropagation();\n\n\t\t\tvar type = $(this).attr('data-type');\n\n\t\t\tswitch (type) {\n\t\t\t\tcase 'upload':\n\t\t\t\t\tcmseditor.instance.filebrowser(img, (/^image\\/*/));\n\t\t\t\t\tself.change(true);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'plus':\n\t\t\t\t\tzoom += 3;\n\t\t\t\t\tif (zoom > 300)\n\t\t\t\t\t\tzoom = 300;\n\t\t\t\t\tcurrent.x -= 3;\n\t\t\t\t\tcurrent.y -= 3;\n\t\t\t\t\tsamesize = '';\n\t\t\t\t\tself.redraw();\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'minus':\n\t\t\t\t\tzoom -= 3;\n\t\t\t\t\tif (zoom < 3)\n\t\t\t\t\t\tzoom = 3;\n\t\t\t\t\tcurrent.x += 3;\n\t\t\t\t\tcurrent.y += 3;\n\t\t\t\t\tsamesize = '';\n\t\t\t\t\tself.redraw();\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'refresh':\n\t\t\t\t\tzoom = cache.zoom;\n\t\t\t\t\tself.redraw();\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t});\n\n\t\tself.find('input').on('change', function() {\n\t\t\tvar file = this.files[0];\n\t\t\tself.load(file);\n\t\t\tthis.value = '';\n\t\t});\n\n\t\t$(canvas).on('mousedown', function (e) {\n\n\t\t\tif (self.disabled || !can)\n\t\t\t\treturn;\n\n\t\t\tis = true;\n\t\t\tvar rect = canvas.getBoundingClientRect();\n\t\t\tvar x = e.clientX - rect.left;\n\t\t\tvar y = e.clientY - rect.top;\n\t\t\toffset.x = x - current.x;\n\t\t\toffset.y = y - current.y;\n\t\t\tsamesize = '';\n\t\t});\n\n\t\tconfig.dragdrop && $(canvas).on('dragenter dragover dragexit drop dragleave', function (e) {\n\n\t\t\tif (self.disabled)\n\t\t\t\treturn;\n\n\t\t\te.stopPropagation();\n\t\t\te.preventDefault();\n\n\t\t\tswitch (e.type) {\n\t\t\t\tcase 'drop':\n\t\t\t\t\tself.rclass('ui-crop-dragdrop');\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'dragenter':\n\t\t\t\tcase 'dragover':\n\t\t\t\t\tself.aclass('ui-crop-dragdrop');\n\t\t\t\t\treturn;\n\t\t\t\tcase 'dragexit':\n\t\t\t\tcase 'dragleave':\n\t\t\t\tdefault:\n\t\t\t\t\tself.rclass('ui-crop-dragdrop');\n\t\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar files = e.originalEvent.dataTransfer.files;\n\t\t\tfiles[0] && self.load(files[0]);\n\t\t});\n\n\t\tself.load = function(file) {\n\t\t\tself.getOrientation(file, function(orient) {\n\t\t\t\tvar reader = new FileReader();\n\t\t\t\treader.onload = function () {\n\t\t\t\t\tif (orient < 2) {\n\t\t\t\t\t\timg.src = reader.result;\n\t\t\t\t\t\tsetTimeout(function() {\n\t\t\t\t\t\t\tself.change(true);\n\t\t\t\t\t\t}, 500);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tSETTER('loading', 'show');\n\t\t\t\t\t\tself.resetOrientation(reader.result, orient, function(url) {\n\t\t\t\t\t\t\tSETTER('loading', 'hide', 500);\n\t\t\t\t\t\t\timg.src = url;\n\t\t\t\t\t\t\tself.change(true);\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t\treader.readAsDataURL(file);\n\t\t\t});\n\t\t};\n\n\t\tself.event('mousemove mouseup', function (e) {\n\n\t\t\tif (e.type === 'mouseup') {\n\t\t\t\tis && self.change();\n\t\t\t\tis = false;\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (self.disabled || !can || !is)\n\t\t\t\treturn;\n\n\t\t\tvar rect = canvas.getBoundingClientRect();\n\t\t\tvar x = e.clientX - rect.left;\n\t\t\tvar y = e.clientY - rect.top;\n\t\t\tcurrent.x = x - offset.x;\n\t\t\tcurrent.y = y - offset.y;\n\t\t\tsamesize = '';\n\t\t\tself.redraw();\n\t\t});\n\t};\n\n\tself.redraw = function() {\n\n\t\tvar ratio = width < config.width ? width / config.width : 1;\n\n\t\tcanvas.width = width < config.width ? width : config.width;\n\t\tcanvas.height = width < config.width ? (config.height / config.width) * width : config.height;\n\n\t\tvar w = img.width;\n\t\tvar h = img.height;\n\n\t\tw = ((w / 100) * zoom);\n\t\th = ((h / 100) * zoom);\n\n\t\tcontext.clearRect(0, 0, canvas.width, canvas.height);\n\n\t\tif (config.background) {\n\t\t\tcontext.fillStyle = config.background;\n\t\t\tcontext.fillRect(0, 0, canvas.width, canvas.height);\n\t\t}\n\n\t\tself.find('div').html(config.width + 'x' + config.height);\n\t\tcontext.drawImage(img, (current.x || 0) * ratio, (current.y || 0) * ratio, w * ratio, h * ratio);\n\t};\n\n\tself.setter = function(value) {\n\t\tself.filename = '';\n\t\tself.width(function(w) {\n\t\t\twidth = w;\n\t\t\tif (value)\n\t\t\t\timg.src = config.format.format(value);\n\t\t\telse\n\t\t\t\tself.redraw();\n\t\t});\n\t};\n\n\tself.getUrl = function() {\n\t\treturn samesize;\n\t};\n\n\tself.isTransparent = function(canvas) {\n\t\tvar id = canvas.getContext('2d').getImageData(0, 0, canvas.width, canvas.height);\n\t\tfor (var i = 0, length = id.data.length; i < length; i += 4) {\n\t\t\tif (id.data[i + 3] !== 255)\n\t\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t};\n\n\t// http://stackoverflow.com/a/32490603\n\tself.getOrientation = function(file, callback) {\n\t\tvar reader = new FileReader();\n\t\treader.onload = function(e) {\n\t\t\tvar view = new DataView(e.target.result);\n\t\t\tif (view.getUint16(0, false) != 0xFFD8)\n\t\t\t\treturn callback(-2);\n\t\t\tvar length = view.byteLength;\n\t\t\tvar offset = 2;\n\t\t\twhile (offset < length) {\n\t\t\t\tvar marker = view.getUint16(offset, false);\n\t\t\t\toffset += 2;\n\t\t\t\tif (marker == 0xFFE1) {\n\t\t\t\t\tif (view.getUint32(offset += 2, false) != 0x45786966)\n\t\t\t\t\t\treturn callback(-1);\n\t\t\t\t\tvar little = view.getUint16(offset += 6, false) == 0x4949;\n\t\t\t\t\toffset += view.getUint32(offset + 4, little);\n\t\t\t\t\tvar tags = view.getUint16(offset, little);\n\t\t\t\t\toffset += 2;\n\t\t\t\t\tfor (var i = 0; i < tags; i++)\n\t\t\t\t\t\tif (view.getUint16(offset + (i * 12), little) == 0x0112)\n\t\t\t\t\t\t\treturn callback(view.getUint16(offset + (i * 12) + 8, little));\n\t\t\t\t} else if ((marker & 0xFF00) != 0xFF00)\n\t\t\t\t\tbreak;\n\t\t\t\telse\n\t\t\t\t\toffset += view.getUint16(offset, false);\n\t\t\t}\n\t\t\treturn callback(-1);\n\t\t};\n\t\treader.readAsArrayBuffer(file.slice(0, 64 * 1024));\n\t};\n\n\tself.resetOrientation = function(src, srcOrientation, callback) {\n\t\tvar img = new Image();\n\t\timg.onload = function() {\n\t\t\tvar width = img.width;\n\t\t\tvar height = img.height;\n\t\t\tvar canvas = document.createElement('canvas');\n\t\t\tvar ctx = canvas.getContext('2d');\n\n\t\t\t// set proper canvas dimensions before transform & export\n\t\t\tif (4 < srcOrientation && srcOrientation < 9) {\n\t\t\t\tcanvas.width = height;\n\t\t\t\tcanvas.height = width;\n\t\t\t} else {\n\t\t\t\tcanvas.width = width;\n\t\t\t\tcanvas.height = height;\n\t\t\t}\n\t\t\tswitch (srcOrientation) {\n\t\t\t\tcase 2: ctx.transform(-1, 0, 0, 1, width, 0); break;\n\t\t\t\tcase 3: ctx.transform(-1, 0, 0, -1, width, height); break;\n\t\t\t\tcase 4: ctx.transform(1, 0, 0, -1, 0, height); break;\n\t\t\t\tcase 5: ctx.transform(0, 1, 1, 0, 0, 0); break;\n\t\t\t\tcase 6: ctx.transform(0, 1, -1, 0, height, 0); break;\n\t\t\t\tcase 7: ctx.transform(0, -1, -1, 0, height, width); break;\n\t\t\t\tcase 8: ctx.transform(0, -1, 1, 0, 0, width); break;\n\t\t\t}\n\t\t\tctx.drawImage(img, 0, 0);\n\t\t\tcallback(canvas.toDataURL());\n\t\t};\n\t\timg.src = src;\n\t};\n});\n\nCOMPONENT('fontawesomebox', 'height:300', function(self, config) {\n\n\tvar container, input, icon, prev;\n\tvar template = '<li data-search=\"{0}\"><i class=\"{1}\"></i></li>';\n\tvar skip = false;\n\tvar refresh = false;\n\n\tself.init = function() {\n\t\tW.fontawesomeicons = 'address-book,address-card,adjust,align-center,align-justify,align-left,align-right,allergies,ambulance,american-sign-language-interpreting,anchor,angle-double-down,angle-double-left,angle-double-right,angle-double-up,angle-down,angle-left,angle-right,angle-up,archive,arrow-alt-circle-down,arrow-alt-circle-left,arrow-alt-circle-right,arrow-alt-circle-up,arrow-circle-down,arrow-circle-left,arrow-circle-right,arrow-circle-up,arrow-down,arrow-left,arrow-right,arrow-up,arrows-alt,arrows-alt-h,arrows-alt-v,assistive-listening-systems,asterisk,at,audio-description,backward,balance-scale,ban,band-aid,barcode,bars,baseball-ball,basketball-ball,bath,battery-empty,battery-full,battery-half,battery-quarter,battery-three-quarters,bed,beer,bell,bell-slash,bicycle,binoculars,birthday-cake,blender,blind,bold,bolt,bomb,book,book-open,bookmark,bowling-ball,box,box-open,boxes,braille,briefcase,briefcase-medical,broadcast-tower,broom,bug,building,bullhorn,bullseye,burn,bus,calculator,calendar,calendar-alt,calendar-check,calendar-minus,calendar-plus,calendar-times,camera,camera-retro,capsules,car,caret-down,caret-left,caret-right,caret-square-down,caret-square-left,caret-square-right,caret-square-up,caret-up,cart-arrow-down,cart-plus,certificate,chalkboard,chalkboard-teacher,chart-area,chart-bar,chart-line,chart-pie,check,check-circle,check-square,chess,chess-bishop,chess-board,chess-king,chess-knight,chess-pawn,chess-queen,chess-rook,chevron-circle-down,chevron-circle-left,chevron-circle-right,chevron-circle-up,chevron-down,chevron-left,chevron-right,chevron-up,child,church,circle,circle-notch,clipboard,clipboard-check,clipboard-list,clock,clone,closed-captioning,cloud,cloud-download-alt,cloud-upload-alt,code,code-branch,coffee,cog,cogs,coins,columns,comment,comment-alt,comment-dots,comment-slash,comments,compact-disc,compass,compress,copy,copyright,couch,credit-card,crop,crosshairs,crow,crown,cube,cubes,cut,database,deaf,desktop,diagnoses,dice,dice-five,dice-four,dice-one,dice-six,dice-three,dice-two,divide,dna,dollar-sign,dolly,dolly-flatbed,donate,door-closed,door-open,dot-circle,dove,download,dumbbell,edit,eject,ellipsis-h,ellipsis-v,envelope,envelope-open,envelope-square,equals,eraser,euro-sign,exchange-alt,exclamation,exclamation-circle,exclamation-triangle,expand,expand-arrows-alt,external-link-alt,external-link-square-alt,eye,eye-dropper,eye-slash,fast-backward,fast-forward,fax,feather,female,fighter-jet,file,file-alt,file-archive,file-audio,file-code,file-excel,file-image,file-medical,file-medical-alt,file-pdf,file-powerpoint,file-video,file-word,film,filter,fire,fire-extinguisher,first-aid,flag,flag-checkered,flask,folder,folder-open,font,football-ball,forward,frog,frown,futbol,gamepad,gas-pump,gavel,gem,genderless,gift,glass-martini,glasses,globe,golf-ball,graduation-cap,greater-than,greater-than-equal,h-square,hand-holding,hand-holding-heart,hand-holding-usd,hand-lizard,hand-paper,hand-peace,hand-point-down,hand-point-left,hand-point-right,hand-point-up,hand-pointer,hand-rock,hand-scissors,hand-spock,hands,hands-helping,handshake,hashtag,hdd,heading,headphones,heart,heartbeat,helicopter,history,hockey-puck,home,hospital,hospital-alt,hospital-symbol,hourglass,hourglass-end,hourglass-half,hourglass-start,i-cursor,id-badge,id-card,id-card-alt,image,images,inbox,indent,industry,infinity,info,info-circle,italic,key,keyboard,kiwi-bird,language,laptop,leaf,lemon,less-than,less-than-equal,level-down-alt,level-up-alt,life-ring,lightbulb,link,lira-sign,list,list-alt,list-ol,list-ul,location-arrow,lock,lock-open,long-arrow-alt-down,long-arrow-alt-left,long-arrow-alt-right,long-arrow-alt-up,low-vision,magic,magnet,male,map,map-marker,map-marker-alt,map-pin,map-signs,mars,mars-double,mars-stroke,mars-stroke-h,mars-stroke-v,medkit,meh,memory,mercury,microchip,microphone,microphone-alt,microphone-alt-slash,microphone-slash,minus,minus-circle,minus-square,mobile,mobile-alt,money-bill,money-bill-alt,money-bill-wave,money-bill-wave-alt,money-check,money-check-alt,moon,motorcycle,mouse-pointer,music,neuter,newspaper,not-equal,notes-medical,object-group,object-ungroup,outdent,paint-brush,palette,pallet,paper-plane,paperclip,parachute-box,paragraph,parking,paste,pause,pause-circle,paw,pen-square,pencil-alt,people-carry,percent,percentage,phone,phone-slash,phone-square,phone-volume,piggy-bank,pills,plane,play,play-circle,plug,plus,plus-circle,plus-square,podcast,poo,portrait,pound-sign,power-off,prescription-bottle,prescription-bottle-alt,print,procedures,project-diagram,puzzle-piece,qrcode,question,question-circle,quidditch,quote-left,quote-right,random,receipt,recycle,redo,redo-alt,registered,reply,reply-all,retweet,ribbon,road,robot,rocket,rss,rss-square,ruble-sign,ruler,ruler-combined,ruler-horizontal,ruler-vertical,rupee-sign,save,school,screwdriver,search,search-minus,search-plus,seedling,server,share,share-alt,share-alt-square,share-square,shekel-sign,shield-alt,ship,shipping-fast,shoe-prints,shopping-bag,shopping-basket,shopping-cart,shower,sign,sign-in-alt,sign-language,sign-out-alt,signal,sitemap,skull,sliders-h,smile,smoking,smoking-ban,snowflake,sort,sort-alpha-down,sort-alpha-up,sort-amount-down,sort-amount-up,sort-down,sort-numeric-down,sort-numeric-up,sort-up,space-shuttle,spinner,square,square-full,star,star-half,step-backward,step-forward,stethoscope,sticky-note,stop,stop-circle,stopwatch,store,store-alt,stream,street-view,strikethrough,stroopwafel,subscript,subway,suitcase,sun,superscript,sync,sync-alt,syringe,table,table-tennis,tablet,tablet-alt,tablets,tachometer-alt,tag,tags,tape,tasks,taxi,terminal,text-height,text-width,th,th-large,th-list,thermometer,thermometer-empty,thermometer-full,thermometer-half,thermometer-quarter,thermometer-three-quarters,thumbs-down,thumbs-up,thumbtack,ticket-alt,times,times-circle,tint,toggle-off,toggle-on,toolbox,trademark,train,transgender,transgender-alt,trash,trash-alt,tree,trophy,truck,truck-loading,truck-moving,tshirt,tty,tv,umbrella,underline,undo,undo-alt,universal-access,university,unlink,unlock,unlock-alt,upload,user,user-alt,user-alt-slash,user-astronaut,user-check,user-circle,user-clock,user-cog,user-edit,user-friends,user-graduate,user-lock,user-md,user-minus,user-ninja,user-plus,user-secret,user-shield,user-slash,user-tag,user-tie,user-times,users,users-cog,utensil-spoon,utensils,venus,venus-double,venus-mars,vial,vials,video,video-slash,volleyball-ball,volume-down,volume-off,volume-up,walking,wallet,warehouse,weight,wheelchair,wifi,window-close,window-maximize,window-minimize,window-restore,wine-glass,won-sign,wrench,x-ray,yen-sign,fab 500px,fab accessible-icon,fab accusoft,fab acquisitions-incorporated,fab adn,fab adversal,fab affiliatetheme,fab algolia,fab alipay,fab amazon,fab amazon-pay,fab amilia,fab android,fab angellist,fab angrycreative,fab angular,fab app-store,fab app-store-ios,fab apper,fab apple,fab apple-pay,fab asymmetrik,fab audible,fab autoprefixer,fab avianex,fab aviato,fab aws,fab bandcamp,fab behance,fab behance-square,fab bimobject,fab bitbucket,fab bitcoin,fab bity,fab black-tie,fab blackberry,fab blogger,fab blogger-b,fab bluetooth,fab bluetooth-b,fab btc,fab buromobelexperte,fab buysellads,fab cc-amazon-pay,fab cc-amex,fab cc-apple-pay,fab cc-diners-club,fab cc-discover,fab cc-jcb,fab cc-mastercard,fab cc-paypal,fab cc-stripe,fab cc-visa,fab centercode,fab chrome,fab cloudscale,fab cloudsmith,fab cloudversify,fab codepen,fab codiepie,fab connectdevelop,fab contao,fab cpanel,fab creative-commons,fab creative-commons-by,fab creative-commons-nc,fab creative-commons-nc-eu,fab creative-commons-nc-jp,fab creative-commons-nd,fab creative-commons-pd,fab creative-commons-pd-alt,fab creative-commons-remix,fab creative-commons-sa,fab creative-commons-sampling,fab creative-commons-sampling-plus,fab creative-commons-share,fab css3,fab css3-alt,fab cuttlefish,fab d-and-d,fab dashcube,fab delicious,fab deploydog,fab deskpro,fab deviantart,fab digg,fab digital-ocean,fab discord,fab discourse,fab dochub,fab docker,fab draft2digital,fab dribbble,fab dribbble-square,fab dropbox,fab drupal,fab dyalog,fab earlybirds,fab ebay,fab edge,fab elementor,fab ello,fab ember,fab empire,fab envira,fab erlang,fab ethereum,fab etsy,fab expeditedssl,fab facebook,fab facebook-f,fab facebook-messenger,fab facebook-square,fab firefox,fab first-order,fab first-order-alt,fab firstdraft,fab flickr,fab flipboard,fab fly,fab font-awesome,fab font-awesome-alt,fab font-awesome-flag,fab fonticons,fab fonticons-fi,fab fort-awesome,fab fort-awesome-alt,fab forumbee,fab foursquare,fab free-code-camp,fab freebsd,fab fulcrum,fab galactic-republic,fab galactic-senate,fab get-pocket,fab gg,fab gg-circle,fab git,fab git-square,fab github,fab github-alt,fab github-square,fab gitkraken,fab gitlab,fab gitter,fab glide,fab glide-g,fab gofore,fab goodreads,fab goodreads-g,fab google,fab google-drive,fab google-play,fab google-plus,fab google-plus-g,fab google-plus-square,fab google-wallet,fab gratipay,fab grav,fab gripfire,fab grunt,fab gulp,fab hacker-news,fab hacker-news-square,fab hackerrank,fab hips,fab hire-a-helper,fab hooli,fab hornbill,fab hotjar,fab houzz,fab html5,fab hubspot,fab imdb,fab instagram,fab internet-explorer,fab ioxhost,fab itunes,fab itunes-note,fab java,fab jedi-order,fab jenkins,fab joget,fab joomla,fab js,fab js-square,fab jsfiddle,fab kaggle,fab keybase,fab keycdn,fab kickstarter,fab kickstarter-k,fab korvue,fab laravel,fab lastfm,fab lastfm-square,fab leanpub,fab less,fab line,fab linkedin,fab linkedin-in,fab linode,fab linux,fab lyft,fab magento,fab mailchimp,fab mandalorian,fab markdown,fab mastodon,fab maxcdn,fab medapps,fab medium,fab medium-m,fab medrt,fab meetup,fab megaport,fab microsoft,fab mix,fab mixcloud,fab mizuni,fab modx,fab monero,fab napster,fab neos,fab nimblr,fab nintendo-switch,fab node,fab node-js,fab npm,fab ns8,fab nutritionix,fab odnoklassniki,fab odnoklassniki-square,fab old-republic,fab opencart,fab openid,fab opera,fab optin-monster,fab osi,fab page4,fab pagelines,fab palfed,fab patreon,fab paypal,fab periscope,fab phabricator,fab phoenix-framework,fab phoenix-squadron,fab php,fab pied-piper,fab pied-piper-alt,fab pied-piper-hat,fab pied-piper-pp,fab pinterest,fab pinterest-p,fab pinterest-square,fab playstation,fab product-hunt,fab pushed,fab python,fab qq,fab quinscape,fab quora,fab r-project,fab ravelry,fab react,fab readme,fab rebel,fab red-river,fab reddit,fab reddit-alien,fab reddit-square,fab renren,fab replyd,fab researchgate,fab resolving,fab rev,fab rocketchat,fab rockrms,fab safari,fab sass,fab schlix,fab scribd,fab searchengin,fab sellcast,fab sellsy,fab servicestack,fab shirtsinbulk,fab shopware,fab simplybuilt,fab sistrix,fab sith,fab skyatlas,fab skype,fab slack,fab slack-hash,fab slideshare,fab snapchat,fab snapchat-ghost,fab snapchat-square,fab soundcloud,fab speakap,fab spotify,fab squarespace,fab stack-exchange,fab stack-overflow,fab staylinked,fab steam,fab steam-square,fab steam-symbol,fab sticker-mule,fab strava,fab stripe,fab stripe-s,fab studiovinari,fab stumbleupon,fab stumbleupon-circle,fab superpowers,fab supple,fab teamspeak,fab telegram,fab telegram-plane,fab tencent-weibo,fab the-red-yeti,fab themeco,fab themeisle,fab trade-federation,fab trello,fab tripadvisor,fab tumblr,fab tumblr-square,fab twitch,fab twitter,fab twitter-square,fab typo3,fab uber,fab uikit,fab uniregistry,fab untappd,fab usb,fab ussunnah,fab vaadin,fab viacoin,fab viadeo,fab viadeo-square,fab viber,fab vimeo,fab vimeo-square,fab vimeo-v,fab vine,fab vk,fab vnv,fab vuejs,fab weebly,fab weibo,fab weixin,fab whatsapp,fab whatsapp-square,fab whmcs,fab wikipedia-w,fab windows,fab wix,fab wolf-pack-battalion,fab wordpress,fab wordpress-simple,fab wpbeginner,fab wpexplorer,fab wpforms,fab xbox,fab xing,fab xing-square,fab y-combinator,fab yahoo,fab yandex,fab yandex-international,fab yelp,fab yoast,fab youtube,fab youtube-square,fab zhihu'.split(',');\n\t};\n\n\tself.readonly();\n\tself.nocompile();\n\n\tself.make = function() {\n\n\t\tself.aclass('ui-fontawesomebox');\n\t\tself.css('height', config.height + 'px');\n\t\tself.append('<div class=\"ui-fontawesomebox-search\"><span><i class=\"fa fa-search clearsearch\"></i></span><div><input type=\"text\" maxlength=\"50\" placeholder=\"{0}\" /></div></div><div class=\"ui-fontawesomebox-search-empty\"></div><div class=\"ui-fontawesomebox-icons\"><ul style=\"height:{1}px\"></ul></div>'.format(config.search, config.height - 40));\n\t\tcontainer = $(self.find('.ui-fontawesomebox-icons').find('ul')[0]);\n\t\tinput = self.find('input');\n\t\ticon = self.find('.ui-fontawesomebox-search').find('i');\n\n\t\tself.event('click', '.clearsearch', function() {\n\t\t\tinput.val('').trigger('keydown');\n\t\t});\n\n\t\tself.event('click', 'li', function() {\n\t\t\tvar el = $(this);\n\t\t\tvar val = '';\n\n\t\t\tif (!el.hclass('selected'))\n\t\t\t\tval = el.find('i').attr('class');\n\n\t\t\tskip = true;\n\t\t\tconfig.exec && EXEC(config.exec, val, self);\n\t\t\tself.set(val);\n\t\t\tself.change(true);\n\t\t});\n\n\t\tself.event('keydown', 'input', function() {\n\t\t\tvar self = this;\n\t\t\tsetTimeout2(self.id, function() {\n\t\t\t\tvar hide = [];\n\t\t\t\tvar show = [];\n\t\t\t\tvar value = self.value.toSearch();\n\t\t\t\tcontainer.find('li').each(function() {\n\t\t\t\t\tif (value && this.getAttribute('data-search').toSearch().indexOf(value) === -1)\n\t\t\t\t\t\thide.push(this);\n\t\t\t\t\telse\n\t\t\t\t\t\tshow.push(this);\n\t\t\t\t});\n\t\t\t\t$(hide).aclass('hidden');\n\t\t\t\t$(show).rclass('hidden');\n\t\t\t\ticon.tclass('fa-times', !!value).tclass('fa-search', !value);\n\t\t\t}, 300);\n\t\t});\n\t};\n\n\tself.configure = function (key, value, init) {\n\n\t\tif (init)\n\t\t\treturn;\n\n\t\tswitch (key) {\n\t\t\tcase 'height':\n\t\t\t\tself.css('height', value + 'px');\n\t\t\t\tcontainer.css('height', value - (38) + 'px');\n\t\t\t\tbreak;\n\t\t}\n\t};\n\n\tself.released = function(is) {\n\t\tif (is) {\n\t\t\tcontainer.empty();\n\t\t} else {\n\t\t\tself.render();\n\t\t\trefresh && self.refresh();\n\t\t}\n\t};\n\n\tself.render = function() {\n\t\tvar builder = [];\n\t\tvar icons = W.fontawesomeicons;\n\t\tfor (var i = 0, length = icons.length; i < length; i++) {\n\t\t\tvar icon = icons[i];\n\t\t\tbuilder.push(template.format(icon, icon.indexOf(' ') === -1 ? ('fa fa-' + icon) : icon.replace(' ', ' fa-')));\n\t\t}\n\t\tcontainer.empty();\n\t\tinput.val('').trigger('keydown');\n\t\tcontainer.html(builder.join(''));\n\t};\n\n\tself.setter = function(value) {\n\t\tprev && prev.rclass('selected');\n\t\tif (value) {\n\t\t\tif (value.indexOf('fa-') === -1)\n\t\t\t\tvalue = 'fa-' + value;\n\n\t\t\tvar index = value.indexOf(' ');\n\t\t\tif (index === -1)\n\t\t\t\tvalue = '.' + value;\n\t\t\telse\n\t\t\t\tvalue = '.' + value.substring(index + 1);\n\n\t\t\tvar fa = container.find(value);\n\t\t\tprev = fa.parent().aclass('selected');\n\t\t\tsetTimeout(function() {\n\t\t\t\t!skip && prev.length && prev.rescroll(-40);\n\t\t\t}, 100);\n\t\t}\n\t\tskip = false;\n\t\trefresh = true;\n\t};\n});\n\nCOMPONENT('multioptions', function(self) {\n\n\tvar Tarea = Tangular.compile('<textarea class=\"ui-moi-save ui-moi-value-inputarea\" data-name=\"{{ name }}\"{{ if def }} placeholder=\"{{ def }}\"{{ fi }}{{ if max }} maxlength=\"{{ max }}\"{{ fi }} data-type=\"text\">{{ value }}</textarea>');\n\tvar Tinput = Tangular.compile('<input class=\"ui-moi-value-inputtext ui-moi-save\" data-name=\"{{ name }}\" type=\"text\" value=\"{{ value }}\"{{ if def }} placeholder=\"{{ def }}\"{{ fi }}{{ if max }} maxlength=\"{{ max }}\"{{ fi }} data-type=\"text\" />');\n\tvar Tfile = Tangular.compile('<div class=\"ui-moi-value-inputfile-buttons\"><span class=\"multioptions-operation\" data-name=\"file\"><i class=\"fa fa-folder\"></i></span></div><div class=\"ui-moi-value-inputfile\"><input class=\"ui-moi-save\" data-name=\"{{ name }}\" type=\"text\" value=\"{{ value }}\"{{ if def }} placeholder=\"{{ def }}\"{{ fi }}{{ if max }} maxlength=\"{{ max }}\"{{ fi }} data-type=\"text\" /></div>');\n\tvar Tselect = Tangular.compile('<div class=\"ui-moi-value-select\"><i class=\"fa fa-chevron-down\"></i><select data-name=\"{{ name }}\" class=\"ui-moi-save ui-multioptions-select\">{{ foreach m in values }}<option value=\"{{\u00a0$index }}\"{{ if value === m.value }} selected=\"selected\"{{ fi }}>{{ m.text }}</option>{{ end }}</select></div>');\n\tvar Tnumber = Tangular.compile('<div class=\"ui-moi-value-inputnumber-buttons\"><span class=\"multioptions-operation\" data-type=\"number\" data-step=\"{{ step }}\" data-name=\"plus\" data-max=\"{{ max }}\" data-min=\"{{ min }}\"><i class=\"fa fa-plus\"></i></span><span class=\"multioptions-operation\" data-type=\"number\" data-name=\"minus\" data-step=\"{{ step }}\" data-max=\"{{ max }}\" data-min=\"{{ min }}\"><i class=\"fa fa-minus\"></i></span></div><div class=\"ui-moi-value-inputnumber\"><input data-name=\"{{ name }}\" class=\"ui-moi-save ui-moi-value-numbertext\" type=\"text\" value=\"{{ value }}\"{{ if def }} placeholder=\"{{ def }}\"{{ fi }} data-max=\"{{ max }}\" data-min=\"{{ max }}\" data-type=\"number\" /></div>');\n\tvar Tboolean = Tangular.compile('<div data-name=\"{{ name }}\" data-type=\"boolean\" class=\"ui-moi-save multioptions-operation ui-moi-value-boolean{{ if value }} checked{{ fi }}\"><i class=\"fa fa-check\"></i></div>');\n\tvar Tdate = Tangular.compile('<div class=\"ui-moi-value-inputdate-buttons\"><span class=\"multioptions-operation\" data-type=\"date\" data-name=\"date\"><i class=\"fa fa-calendar\"></i></span></div><div class=\"ui-moi-value-inputdate\"><input class=\"ui-moi-save ui-moi-date\" data-name=\"{{ name }}\" type=\"text\" value=\"{{ value | format(\\'yyyy-MM-dd\\') }}\" placeholder=\"dd.mm.yyyy\" maxlength=\"10\" data-type=\"date\" /></div>');\n\tvar Tcolor = null;\n\tvar skip = false;\n\tvar mapping = null;\n\tvar dep = {};\n\tvar pending = 0;\n\n\tself.getter = null;\n\tself.novalidate();\n\tself.nocompile();\n\n\tself.init = function() {\n\t\twindow.Tmultioptionscolor = Tangular.compile('<div class=\"ui-moi-value-colors ui-moi-save\" data-name=\"{{ name }}\" data-value=\"{{ value }}\">{0}</div>'.format(['#ED5565', '#DA4453', '#FC6E51', '#E9573F', '#FFCE54', '#F6BB42', '#A0D468', '#8CC152', '#48CFAD', '#37BC9B', '#4FC1E9', '#3BAFDA', '#5D9CEC', '#4A89DC', '#AC92EC', '#967ADC', '#EC87C0', '#D770AD', '#F5F7FA', '#E6E9ED', '#CCD1D9', '#AAB2BD', '#656D78', '#434A54', '#000000'].map(function(n) { return '<span data-value=\"{0}\" data-type=\"color\" class=\"multioptions-operation\" style=\"background-color:{0}\"><i class=\"fa fa-check-circle\"></i></span>'.format(n); }).join('')));\n\t};\n\n\tself.form = function() {};\n\n\tself.make = function() {\n\n\t\tTcolor = window.Tmultioptionscolor;\n\t\tself.aclass('ui-multioptions');\n\n\t\tvar el = self.find('script');\n\n\t\tif (el.length) {\n\t\t\tself.remap(el.html());\n\t\t\tel.remove();\n\t\t}\n\n\t\tself.event('click', '.multioptions-operation', function(e) {\n\t\t\tvar el = $(this);\n\t\t\tvar name = el.attrd('name');\n\t\t\tvar type = el.attrd('type');\n\n\t\t\te.stopPropagation();\n\n\t\t\tif (name === 'file') {\n\t\t\t\tel = el.parent().parent().find('input');\n\t\t\t\tcmseditor.instance.filebrowser(function(url) {\n\t\t\t\t\tel.val(url);\n\t\t\t\t\tself.$save();\n\t\t\t\t});\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (type === 'date') {\n\t\t\t\tel = el.parent().parent().find('input');\n\t\t\t\tSETTER('calendar', 'show', el, el.val().parseDate(), function(date) {\n\t\t\t\t\tel.val(date.format('yyyy-MM-dd'));\n\t\t\t\t\tself.$save();\n\t\t\t\t});\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (type === 'color') {\n\t\t\t\tel.parent().find('.selected').rclass('selected');\n\t\t\t\tel.aclass('selected');\n\t\t\t\tself.$save();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (type === 'boolean') {\n\t\t\t\tel.tclass('checked');\n\t\t\t\tself.$save();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (type === 'number') {\n\t\t\t\tvar input = el.parent().parent().find('input');\n\t\t\t\tvar step = (el.attrd('step') || '0').parseInt();\n\t\t\t\tvar min = el.attrd('min');\n\t\t\t\tvar max = el.attrd('max');\n\n\t\t\t\tif (!step)\n\t\t\t\t\tstep = 1;\n\n\t\t\t\tif (min)\n\t\t\t\t\tmin = min.parseInt();\n\n\t\t\t\tif (max)\n\t\t\t\t\tmax = max.parseInt();\n\n\t\t\t\tvar value;\n\n\t\t\t\tif (name === 'plus') {\n\t\t\t\t\tvalue = input.val().parseInt() + step;\n\t\t\t\t\tif (max !== 0 && max && value > max)\n\t\t\t\t\t\tvalue = max;\n\t\t\t\t\tinput.val(value);\n\t\t\t\t} else {\n\t\t\t\t\tvalue = input.val().parseInt() - step;\n\t\t\t\t\tif (min !== 0 && min && value < min)\n\t\t\t\t\t\tvalue = min;\n\t\t\t\t\tinput.val(value);\n\t\t\t\t}\n\t\t\t\tself.$save();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tself.form(type, el.parent().parent().find('input'), name);\n\t\t\treturn;\n\t\t});\n\n\t\tself.event('change', 'select', self.$save);\n\t\tself.event('input', 'input,textarea', self.$save);\n\n\t\tself.event('click', '.ui-moi-date', function(e) {\n\t\t\te.stopPropagation();\n\t\t});\n\n\t\tself.event('focus', '.ui-moi-date', function() {\n\t\t\tvar el = $(this);\n\t\t\tSETTER('calendar', 'toggle', el, el.val().parseDate(), function(date) {\n\t\t\t\tel.val(date.format('yyyy-MM-dd'));\n\t\t\t\tself.$save();\n\t\t\t});\n\t\t});\n\t};\n\n\tself.remap = function(js) {\n\t\tvar fn = new Function('option', js);\n\t\tmapping = {};\n\t\tdep = {};\n\t\tpending = 0;\n\t\tfn(self.mapping);\n\t\tself.redraw();\n\t};\n\n\tself.redraw = function() {\n\n\t\tif (pending > 0) {\n\t\t\tsetTimeout(self.redraw, 500);\n\t\t\treturn;\n\t\t}\n\n\t\tself.refresh();\n\t\tself.change(false);\n\t\tself.$save();\n\t};\n\n\tself.remap2 = function(callback) {\n\t\tmapping = {};\n\t\tdep = {};\n\t\tpending = 0;\n\t\tcallback(self.mapping);\n\t\tself.redraw();\n\t};\n\n\tself.mapping = function(key, label, def, type, max, min, step, validator) {\n\t\tvar T = typeof(type);\n\t\tif (T === 'number') {\n\t\t\tvalidator = step;\n\t\t\tstep = min;\n\t\t\tmin = max;\n\t\t\tmax = type;\n\t\t\ttype = 'number';\n\t\t} else if (!type)\n\t\t\ttype = def instanceof Date ? 'date' : typeof(def);\n\n\t\tvar values, multiline;\n\n\t\tif (type instanceof Array) {\n\n\t\t\tvalues = [];\n\n\t\t\ttype.forEach(function(val) {\n\t\t\t\tvalues.push({ text: val.text === undefined ? val : val.text, value: val.value === undefined ? val : val.value });\n\t\t\t});\n\n\t\t\ttype = 'array';\n\t\t}\n\n\t\tvar external = false;\n\n\t\tif (T === 'string') {\n\t\t\tvar tmp = type.substring(0, 6);\n\t\t\texternal = type.substring(0, 1) === '/' || tmp === 'http:/' || tmp === 'https:';\n\t\t\tif (type.toLowerCase() === 'multiline') {\n\t\t\t\tmultiline = true;\n\t\t\t\ttype = 'string';\n\t\t\t}\n\t\t}\n\n\t\tvar t = (type || '').toLowerCase();\n\t\tswitch (t) {\n\t\t\tcase 'posts':\n\t\t\tcase 'languages':\n\t\t\tcase 'signals':\n\t\t\tcase 'notices':\n\t\t\tcase 'navigations':\n\t\t\t\tvalues = [{ value: '', text: '' }];\n\t\t\t\tvar nav = common.dependencies[t];\n\t\t\t\tfor (var i = 0; i < nav.length; i++) {\n\t\t\t\t\tvar n = nav[i];\n\t\t\t\t\tvalues.push({ value: n.id, text: n.name });\n\t\t\t\t}\n\t\t\t\ttype = 'array';\n\t\t\t\tbreak;\n\n\t\t\tcase 'parts':\n\t\t\t\tvalues = [{ value: '', text: '' }];\n\t\t\t\tvar items = GET('%parts');\n\t\t\t\tfor (var i = 0; i < items.length; i++) {\n\t\t\t\t\tvar n = items[i];\n\t\t\t\t\tvalues.push({ value: n.id, text: n.name });\n\t\t\t\t}\n\t\t\t\ttype = 'array';\n\t\t\t\tbreak;\n\n\t\t\tcase 'inlineparts':\n\t\t\t\tvalues = [{ value: '', text: '' }];\n\t\t\t\tvar items = GET('%parts');\n\t\t\t\tfor (var i = 0; i < items.length; i++) {\n\t\t\t\t\tvar n = items[i];\n\t\t\t\t\tif (n.category === 'Inline' || n.category === 'Custom')\n\t\t\t\t\t\tvalues.push({ value: n.id, text: n.name });\n\t\t\t\t}\n\t\t\t\ttype = 'array';\n\t\t\t\tbreak;\n\n\t\t\tcase 'newsletterparts':\n\t\t\t\tvalues = [{ value: '', text: '' }];\n\t\t\t\tvar items = GET('%parts');\n\t\t\t\tfor (var i = 0; i < items.length; i++) {\n\t\t\t\t\tvar n = items[i];\n\t\t\t\t\tif (n.category === 'Newsletter' || n.category === 'Custom')\n\t\t\t\t\t\tvalues.push({ value: n.id, text: n.name });\n\t\t\t\t}\n\t\t\t\ttype = 'array';\n\t\t\t\tbreak;\n\n\t\t\tcase 'contentparts':\n\t\t\tcase 'columnsparts':\n\t\t\t\tvalues = [{ value: '', text: '' }];\n\t\t\t\tvar items = GET('%parts');\n\t\t\t\tfor (var i = 0; i < items.length; i++) {\n\t\t\t\t\tvar n = items[i];\n\t\t\t\t\tif (n.category === 'Content' || n.category === 'Columns' || n.category === 'Custom')\n\t\t\t\t\t\tvalues.push({ value: n.id, text: n.name });\n\t\t\t\t}\n\t\t\t\ttype = 'array';\n\t\t\t\tbreak;\n\n\t\t\tcase 'layoutsparts':\n\t\t\t\tvalues = [{ value: '', text: '' }];\n\t\t\t\tvar items = GET('%parts');\n\t\t\t\tfor (var i = 0; i < items.length; i++) {\n\t\t\t\t\tvar n = items[i];\n\t\t\t\t\tif (n.category === 'Layouts' || n.category === 'Custom')\n\t\t\t\t\t\tvalues.push({ value: n.id, text: n.name });\n\t\t\t\t}\n\t\t\t\ttype = 'array';\n\t\t\t\tbreak;\n\n\t\t\tcase 'partial':\n\t\t\t\tvalues = [{ value: '', text: '' }];\n\t\t\t\tvar pages = GET('pages.grid.items');\n\t\t\t\tif (pages && pages.length) {\n\t\t\t\t\tfor (var i = 0, length = pages.length; i < length; i++) {\n\t\t\t\t\t\tvar p = pages[i];\n\t\t\t\t\t\tp.ispartial && values.push({ value: p.id, text: p.name });\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\ttype = 'array';\n\t\t\t\tbreak;\n\t\t}\n\n\t\tif (validator && typeof(validator) !== 'function')\n\t\t\tvalidator = null;\n\n\t\tvar bindmapping = function(values) {\n\t\t\tdep[key] = values;\n\t\t\tmapping[key] = { name: key, label: label, type: external ? 'array' : type.toLowerCase(), def: def, max: max, min: min, step: step, value: def, values: values, validator: validator, multiline: multiline };\n\t\t};\n\n\t\tif (external) {\n\t\t\tpending++;\n\t\t\tAJAX('GET ' + type, function(values) {\n\t\t\t\tpending--;\n\t\t\t\tbindmapping(values);\n\t\t\t});\n\t\t} else\n\t\t\tbindmapping(values);\n\t};\n\n\tself.dependencies = function() {\n\t\treturn dep;\n\t};\n\n\tself.$save = function() {\n\t\tsetTimeout2('multioptions.' + self._id, self.save, 150);\n\t};\n\n\tself.save = function() {\n\t\tvar obj = self.get();\n\t\tvar values = self.find('.ui-moi-save');\n\n\t\tObject.keys(mapping).forEach(function(key) {\n\n\t\t\tvar opt = mapping[key];\n\t\t\tvar el = values.filter('[data-name=\"{0}\"]'.format(opt.name));\n\n\t\t\tif (el.hclass('ui-moi-value-colors')) {\n\t\t\t\tobj[key] = el.find('.selected').attrd('value');\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (el.hclass('ui-moi-value-boolean')) {\n\t\t\t\tobj[key] = el.hclass('checked');\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (el.hclass('ui-moi-date')) {\n\t\t\t\tobj[key] = el.val().parseDate();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (el.hclass('ui-moi-value-inputtext') || el.hclass('ui-moi-value-inputarea')) {\n\t\t\t\tobj[key] = el.val();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (opt.type === 'file') {\n\t\t\t\tobj[key] = el.val();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (el.hclass('ui-moi-value-numbertext')) {\n\n\t\t\t\tobj[key] = el.val().parseFloat();\n\n\t\t\t\tif (opt.max !== null && obj[key] > opt.max) {\n\t\t\t\t\tobj[key] = opt.max;\n\t\t\t\t\tel.val(opt.max);\n\t\t\t\t}\n\n\t\t\t\tif (opt.min !== null && obj[key] < opt.min) {\n\t\t\t\t\tobj[key] = opt.min;\n\t\t\t\t\tel.val(opt.min);\n\t\t\t\t}\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (el.hclass('ui-multioptions-select')) {\n\t\t\t\tvar index = el.val().parseInt();\n\t\t\t\tvar val = opt.values[index];\n\t\t\t\tobj[key] = val ? val.value : null;\n\t\t\t\tif (obj[key] && obj[key].value)\n\t\t\t\t\tobj[key] = obj[key].value;\n\t\t\t\treturn;\n\t\t\t}\n\t\t});\n\n\t\tskip = true;\n\t\tself.set(obj);\n\t\tself.change(true);\n\t};\n\n\tself.setter = function(options) {\n\n\t\tif (!options || skip || !mapping) {\n\t\t\tskip = false;\n\t\t\treturn;\n\t\t}\n\n\t\tvar builder = [];\n\t\tObject.keys(mapping).forEach(function(key) {\n\n\t\t\tvar option = mapping[key];\n\n\t\t\t// option.name\n\t\t\t// option.label\n\t\t\t// option.type (lowercase)\n\t\t\t// option.def\n\t\t\t// option.value\n\t\t\t// option.max\n\t\t\t// option.min\n\t\t\t// option.step\n\n\t\t\toption.value = options[key] == null ? option.def : options[key];\n\n\t\t\tvar value = '';\n\n\t\t\tswitch (option.type.toLowerCase()) {\n\t\t\t\tcase 'string':\n\t\t\t\t\tvalue = option.multiline ? Tarea(option) : Tinput(option);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'file':\n\t\t\t\t\tvalue = Tfile(option);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'number':\n\t\t\t\t\tvalue = Tnumber(option);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'boolean':\n\t\t\t\t\tvalue = Tboolean(option);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'color':\n\t\t\t\t\tvalue = Tcolor(option);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'array':\n\t\t\t\t\tvalue = Tselect(option);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'date':\n\t\t\t\t\tvalue = Tdate(option);\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tbuilder.push('<div class=\"ui-multioptions-item{2}\"><div class=\"ui-moi-name\">{0}</div><div class=\"ui-moi-value\">{1}</div></div>'.format(option.label, value, option.multiline ? ' ui-multioptions-multiline' : ''));\n\t\t});\n\n\t\tself.empty().html(builder);\n\n\t\tself.find('.ui-moi-value-colors').each(function() {\n\t\t\tvar el = $(this);\n\t\t\tvar value = el.attrd('value');\n\t\t\tel.find('[data-value=\"{0}\"]'.format(value)).aclass('selected');\n\t\t});\n\t};\n});\n\nCOMPONENT('fileupload', function(self, config) {\n\n\tvar id = 'fileupload' + self._id;\n\tvar input = null;\n\n\tself.readonly();\n\tself.nocompile();\n\n\tself.configure = function(key, value, init) {\n\t\tif (init)\n\t\t\treturn;\n\t\tswitch (key) {\n\t\t\tcase 'disabled':\n\t\t\t\tself.tclass('ui-disabled', value);\n\t\t\t\tbreak;\n\t\t\tcase 'accept':\n\t\t\t\tvar el = $('#' + id);\n\t\t\t\tif (value)\n\t\t\t\t\tel.prop('accept', value);\n\t\t\t\telse\n\t\t\t\t\tel.removeProp('accept');\n\t\t\t\tbreak;\n\t\t\tcase 'multiple':\n\t\t\t\tvar el = $('#' + id);\n\t\t\t\tif (value)\n\t\t\t\t\tel.prop('multiple', true);\n\t\t\t\telse\n\t\t\t\t\tel.removeProp('multiple');\n\t\t\t\tbreak;\n\t\t\tcase 'label':\n\t\t\t\tself.html(value);\n\t\t\t\tbreak;\n\t\t}\n\t};\n\n\tself.make = function() {\n\n\t\tconfig.disabled && self.aclass('ui-disabled');\n\t\t$(document.body).append('<input type=\"file\" id=\"{0}\" class=\"hidden\"{1}{2} />'.format(id, config.accept ? ' accept=\"{0}\"'.format(config.accept) : '', config.multiple ? ' multiple=\"multiple\"' : ''));\n\t\tinput = $('#' + id);\n\n\t\tself.event('click', function() {\n\t\t\t!config.disabled && input.click();\n\t\t});\n\n\t\tinput.on('change', function(evt) {\n\t\t\t!config.disabled && self.upload(evt.target.files);\n\t\t});\n\t};\n\n\tself.upload = function(files) {\n\n\t\tvar data = new FormData();\n\t\tvar el = this;\n\n\t\tfor (var i = 0, length = files.length; i < length; i++)\n\t\t\tdata.append('file' + i, files[i]);\n\n\t\tSETTER('loading', 'show');\n\t\tUPLOAD(config.url, data, function(response, err) {\n\n\t\t\tel.value = '';\n\t\t\tSETTER('loading', 'hide', 500);\n\n\t\t\tif (err) {\n\t\t\t\tSETTER('snackbar', 'warning', err.toString());\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tself.change();\n\n\t\t\tif (config.property) {\n\t\t\t\tfor (var i = 0, length = response.length; i < length; i++)\n\t\t\t\t\tresponse[i] = response[i][config.property];\n\t\t\t}\n\n\t\t\tif (config.array)\n\t\t\t\tself.push(response);\n\t\t\telse\n\t\t\t\tself.set(response);\n\t\t});\n\t};\n\n\tself.destroy = function() {\n\t\tinput.off().remove();\n\t};\n});\n\nCOMPONENT('suggestion', function(self, config) {\n\n\tvar container, arrow, timeout, icon, input = null;\n\tvar is = false, selectedindex = 0, resultscount = 0;\n\n\tself.items = null;\n\tself.template = Tangular.compile('<li data-index=\"{{ $.index }}\"{{ if selected }} class=\"selected\"{{ fi }}>{{ name | raw }}</li>');\n\tself.callback = null;\n\n\tself.readonly();\n\tself.singleton();\n\tself.nocompile();\n\n\tself.configure = function(key, value, init) {\n\t\tif (init)\n\t\t\treturn;\n\t\tswitch (key) {\n\t\t\tcase 'placeholder':\n\t\t\t\tself.find('input').prop('placeholder', value);\n\t\t\t\tbreak;\n\t\t}\n\t};\n\n\tself.make = function() {\n\n\t\tself.aclass('ui-suggestion hidden');\n\t\tself.append('<span class=\"ui-suggestion-arrow\"></span><div class=\"ui-suggestion-search\"><span class=\"ui-suggestion-button\"><i class=\"fa fa-search\"></i></span><div><input type=\"text\" placeholder=\"{0}\" class=\"ui-suggestion-search-input\" /></div></div><div class=\"ui-suggestion-container\"><ul></ul></div>'.format(config.placeholder));\n\t\tcontainer = self.find('ul');\n\t\tarrow = self.find('.ui-suggestion-arrow');\n\t\tinput = self.find('input');\n\t\ticon = self.find('.ui-suggestion-button').find('.fa');\n\n\t\tself.event('mouseenter mouseleave', 'li', function() {\n\t\t\tcontainer.find('li.selected').rclass('selected');\n\t\t\t$(this).aclass('selected');\n\t\t\tvar arr = container.find('li:visible');\n\t\t\tfor (var i = 0; i < arr.length; i++) {\n\t\t\t\tif ($(arr[i]).hclass('selected')) {\n\t\t\t\t\tselectedindex = i;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tself.event('click', '.ui-suggestion-button', function(e) {\n\t\t\tinput.val('');\n\t\t\tself.search();\n\t\t\te.stopPropagation();\n\t\t\te.preventDefault();\n\t\t});\n\n\t\tself.event('touchstart mousedown', 'li', function(e) {\n\t\t\tself.callback && self.callback(self.items[+this.getAttribute('data-index')], $(self.target));\n\t\t\tself.hide();\n\t\t\te.preventDefault();\n\t\t\te.stopPropagation();\n\t\t});\n\n\t\t$(document).on('click', function(e) {\n\t\t\tis && !$(e.target).hclass('ui-suggestion-search-input') && self.hide(0);\n\t\t});\n\n\t\t$(window).on('resize', function() {\n\t\t\tis && self.hide(0);\n\t\t});\n\n\t\tself.event('keydown', 'input', function(e) {\n\t\t\tvar o = false;\n\t\t\tswitch (e.which) {\n\t\t\t\tcase 27:\n\t\t\t\t\to = true;\n\t\t\t\t\tself.hide();\n\t\t\t\t\tbreak;\n\t\t\t\tcase 13:\n\t\t\t\t\to = true;\n\t\t\t\t\tvar sel = self.find('li.selected');\n\t\t\t\t\tif (sel.length && self.callback)\n\t\t\t\t\t\tself.callback(self.items[+sel.attrd('index')]);\n\t\t\t\t\tself.hide();\n\t\t\t\t\tbreak;\n\t\t\t\tcase 38: // up\n\t\t\t\t\to = true;\n\t\t\t\t\tselectedindex--;\n\t\t\t\t\tif (selectedindex < 0)\n\t\t\t\t\t\tselectedindex = 0;\n\t\t\t\t\telse\n\t\t\t\t\t\tself.move();\n\t\t\t\t\tbreak;\n\t\t\t\tcase 40: // down\n\t\t\t\t\to = true;\n\t\t\t\t\tselectedindex++ ;\n\t\t\t\t\tif (selectedindex >= resultscount)\n\t\t\t\t\t\tselectedindex = resultscount;\n\t\t\t\t\telse\n\t\t\t\t\t\tself.move();\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (o) {\n\t\t\t\te.preventDefault();\n\t\t\t\te.stopPropagation();\n\t\t\t}\n\n\t\t});\n\n\t\tself.event('input', 'input', function() {\n\t\t\tsetTimeout2(self.ID, self.search, 100, null, this.value);\n\t\t});\n\n\t\tself.on('reflow', function() {\n\t\t\tis && self.hide(1);\n\t\t});\n\n\t\t$(window).on('scroll', function() {\n\t\t\tis && self.hide(1);\n\t\t});\n\t};\n\n\tself.move = function() {\n\t\tvar counter = 0;\n\t\tvar scroller = container.parent();\n\t\tvar h = scroller.height();\n\t\tcontainer.find('li').each(function() {\n\t\t\tvar el = $(this);\n\n\t\t\tif (el.hclass('hidden')) {\n\t\t\t\tel.rclass('selected');\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar is = selectedindex === counter;\n\t\t\tel.tclass('selected', is);\n\t\t\tif (is) {\n\t\t\t\tvar t = (h * counter) - h;\n\t\t\t\tif ((t + h * 4) > h)\n\t\t\t\t\tscroller.scrollTop(t - h);\n\t\t\t\telse\n\t\t\t\t\tscroller.scrollTop(0);\n\t\t\t}\n\t\t\tcounter++;\n\t\t});\n\t};\n\n\tself.search = function(value) {\n\n\t\ticon.tclass('fa-times', !!value).tclass('fa-search', !value);\n\n\t\tif (!value) {\n\t\t\tcontainer.find('li').rclass('hidden');\n\t\t\tresultscount = self.items.length;\n\t\t\tselectedindex = 0;\n\t\t\tself.move();\n\t\t\treturn;\n\t\t}\n\n\t\tresultscount = 0;\n\t\tselectedindex = 0;\n\n\t\tvalue = value.toSearch();\n\t\tcontainer.find('li').each(function() {\n\t\t\tvar el = $(this);\n\t\t\tvar val = this.innerHTML.toSearch();\n\t\t\tvar is = val.indexOf(value) === -1;\n\t\t\tel.tclass('hidden', is);\n\t\t\tif (!is)\n\t\t\t\tresultscount++;\n\t\t});\n\n\t\tself.move();\n\t};\n\n\tself.show = function(orientation, target, items, callback) {\n\n\t\tif (is) {\n\t\t\tclearTimeout(timeout);\n\t\t\tvar obj = target instanceof jQuery ? target[0] : target;\n\t\t\tif (self.target === obj) {\n\t\t\t\tself.hide(0);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\ttarget = $(target);\n\t\tvar type = typeof(items);\n\t\tvar item;\n\n\t\tif (type === 'string')\n\t\t\titems = self.get(items);\n\t\telse if (type === 'function') {\n\t\t\tcallback = items;\n\t\t\titems = (target.attrd('options') || '').split(';');\n\t\t\tfor (var i = 0, length = items.length; i < length; i++) {\n\t\t\t\titem = items[i];\n\t\t\t\tif (!item)\n\t\t\t\t\tcontinue;\n\t\t\t\tvar val = item.split('|');\n\t\t\t\titems[i] = { name: val[0], value: val[2] == null ? val[0] : val[2] };\n\t\t\t}\n\t\t}\n\n\t\tif (!items) {\n\t\t\tself.hide(0);\n\t\t\treturn;\n\t\t}\n\n\t\tself.items = items;\n\t\tself.callback = callback;\n\t\tinput.val('');\n\n\t\tvar builder = [];\n\t\tvar indexer = {};\n\n\t\tfor (var i = 0, length = items.length; i < length; i++) {\n\t\t\titem = items[i];\n\t\t\tindexer.index = i;\n\t\t\t!item.value && (item.value = item.name);\n\t\t\tbuilder.push(self.template(item, indexer));\n\t\t}\n\n\t\tself.target = target[0];\n\t\tvar offset = target.offset();\n\n\t\tcontainer.html(builder);\n\n\t\tswitch (orientation) {\n\t\t\tcase 'left':\n\t\t\t\tarrow.css({ left: '15px' });\n\t\t\t\tbreak;\n\t\t\tcase 'right':\n\t\t\t\tarrow.css({ left: '210px' });\n\t\t\t\tbreak;\n\t\t\tcase 'center':\n\t\t\t\tarrow.css({ left: '107px' });\n\t\t\t\tbreak;\n\t\t}\n\n\t\tvar options = { left: orientation === 'center' ? Math.ceil((offset.left - self.element.width() / 2) + (target.innerWidth() / 2)) : orientation === 'left' ? offset.left - 8 : (offset.left - self.element.width()) + target.innerWidth(), top: offset.top + target.innerHeight() + 10 };\n\t\tself.css(options);\n\n\t\tif (is)\n\t\t\treturn;\n\n\t\tselectedindex = 0;\n\t\tresultscount = items.length;\n\t\tself.move();\n\t\tself.search();\n\n\t\tself.rclass('hidden');\n\t\tsetTimeout(function() {\n\t\t\tself.aclass('ui-suggestion-visible');\n\t\t\tself.emit('suggestion', true, self, self.target);\n\t\t}, 100);\n\n\t\t!isMOBILE && setTimeout(function() {\n\t\t\tinput.focus();\n\t\t}, 500);\n\n\t\tsetTimeout(function() {\n\t\t\tis = true;\n\t\t}, 50);\n\t};\n\n\tself.hide = function(sleep) {\n\t\tif (!is)\n\t\t\treturn;\n\t\tclearTimeout(timeout);\n\t\ttimeout = setTimeout(function() {\n\t\t\tself.rclass('ui-suggestion-visible').aclass('hidden');\n\t\t\tself.emit('suggestion', false, self, self.target);\n\t\t\tself.callback = null;\n\t\t\tself.target = null;\n\t\t\tis = false;\n\t\t}, sleep ? sleep : 100);\n\t};\n\n});\n\nCOMPONENT('calendar', 'today:Set today;firstday:0;close:Close;yearselect:true;monthselect:true;yearfrom:-70 years;yearto:5 years', function(self, config) {\n\n\tvar skip = false;\n\tvar skipDay = false;\n\tvar visible = false;\n\n\tself.days = EMPTYARRAY;\n\tself.months = EMPTYARRAY;\n\tself.months_short = EMPTYARRAY;\n\tself.years_from;\n\tself.years_to;\n\n\tself.nocompile();\n\n\tself.configure = function(key, value) {\n\t\tswitch (key) {\n\t\t\tcase 'days':\n\t\t\t\tif (value instanceof Array)\n\t\t\t\t\tself.days = value;\n\t\t\t\telse\n\t\t\t\t\tself.days = value.split(',').trim();\n\n\t\t\t\tfor (var i = 0; i < DAYS.length; i++) {\n\t\t\t\t\tDAYS[i] = self.days[i];\n\t\t\t\t\tself.days[i] = DAYS[i].substring(0, 2).toUpperCase();\n\t\t\t\t}\n\n\t\t\t\tbreak;\n\n\t\t\tcase 'months':\n\t\t\t\tif (value instanceof Array)\n\t\t\t\t\tself.months = value;\n\t\t\t\telse\n\t\t\t\t\tself.months = value.split(',').trim();\n\n\t\t\t\tself.months_short = [];\n\n\t\t\t\tfor (var i = 0, length = self.months.length; i < length; i++) {\n\t\t\t\t\tvar m = self.months[i];\n\t\t\t\t\tMONTHS[i] = m;\n\t\t\t\t\tif (m.length > 4)\n\t\t\t\t\t\tm = m.substring(0, 3) + '.';\n\t\t\t\t\tself.months_short.push(m);\n\t\t\t\t}\n\t\t\t\tbreak;\n\n\t\t\tcase 'yearfrom':\n\t\t\t\tif (value.indexOf('current') !== -1)\n\t\t\t\t\tself.years_from = parseInt(new Date().format('yyyy'));\n\t\t\t\telse\n\t\t\t\t\tself.years_from = parseInt(new Date().add(value).format('yyyy'));\n\t\t\t\tbreak;\n\n\t\t\tcase 'yearto':\n\t\t\t\tif (value.indexOf('current') !== -1)\n\t\t\t\t\tself.years_to = parseInt(new Date().format('yyyy'));\n\t\t\t\telse\n\t\t\t\t\tself.years_to = parseInt(new Date().add(value).format('yyyy'));\n\t\t\t\tbreak;\n\t\t}\n\t};\n\n\tself.readonly();\n\tself.click = function() {};\n\n\tfunction getMonthDays(dt) {\n\n\t\tvar m = dt.getMonth();\n\t\tvar y = dt.getFullYear();\n\n\t\tif (m === -1) {\n\t\t\tm = 11;\n\t\t\ty--;\n\t\t}\n\n\t\treturn (32 - new Date(y, m, 32).getDate());\n\t}\n\n\tself.calculate = function(year, month, selected) {\n\n\t\tvar d = new Date(year, month, 1, 12, 0);\n\t\tvar output = { header: [], days: [], month: month, year: year };\n\t\tvar firstDay = config.firstday;\n\t\tvar firstCount = 0;\n\t\tvar frm = d.getDay() - firstDay;\n\t\tvar today = new Date();\n\t\tvar ty = today.getFullYear();\n\t\tvar tm = today.getMonth();\n\t\tvar td = today.getDate();\n\t\tvar sy = selected ? selected.getFullYear() : -1;\n\t\tvar sm = selected ? selected.getMonth() : -1;\n\t\tvar sd = selected ? selected.getDate() : -1;\n\t\tvar days = getMonthDays(d);\n\n\t\tif (frm < 0)\n\t\t\tfrm = 7 + frm;\n\n\t\twhile (firstCount++ < 7) {\n\t\t\toutput.header.push({ index: firstDay, name: self.days[firstDay] });\n\t\t\tfirstDay++;\n\t\t\tif (firstDay > 6)\n\t\t\t\tfirstDay = 0;\n\t\t}\n\n\t\tvar index = 0;\n\t\tvar indexEmpty = 0;\n\t\tvar count = 0;\n\t\tvar prev = getMonthDays(new Date(year, month - 1, 1, 12, 0)) - frm;\n\t\tvar cur;\n\n\t\tfor (var i = 0; i < days + frm; i++) {\n\n\t\t\tvar obj = { isToday: false, isSelected: false, isEmpty: false, isFuture: false, number: 0, index: ++count };\n\n\t\t\tif (i >= frm) {\n\t\t\t\tobj.number = ++index;\n\t\t\t\tobj.isSelected = sy === year && sm === month && sd === index;\n\t\t\t\tobj.isToday = ty === year && tm === month && td === index;\n\t\t\t\tobj.isFuture = ty < year;\n\t\t\t\tif (!obj.isFuture && year === ty) {\n\t\t\t\t\tif (tm < month)\n\t\t\t\t\t\tobj.isFuture = true;\n\t\t\t\t\telse if (tm === month)\n\t\t\t\t\t\tobj.isFuture = td < index;\n\t\t\t\t}\n\n\t\t\t} else {\n\t\t\t\tindexEmpty++;\n\t\t\t\tobj.number = prev + indexEmpty;\n\t\t\t\tobj.isEmpty = true;\n\t\t\t\tcur = d.add('-' + indexEmpty + ' days');\n\t\t\t}\n\n\t\t\tif (!obj.isEmpty)\n\t\t\t\tcur = d.add(i + ' days');\n\n\t\t\tobj.month = i >= frm && obj.number <= days ? d.getMonth() : cur.getMonth();\n\t\t\tobj.year = i >= frm && obj.number <= days ? d.getFullYear() : cur.getFullYear();\n\t\t\tobj.date = cur;\n\t\t\toutput.days.push(obj);\n\t\t}\n\n\t\tindexEmpty = 0;\n\n\t\tfor (var i = count; i < 42; i++) {\n\t\t\tvar cur = d.add(i + ' days');\n\t\t\tvar obj = { isToday: false, isSelected: false, isEmpty: true, isFuture: true, number: ++indexEmpty, index: ++count };\n\t\t\tobj.month = cur.getMonth();\n\t\t\tobj.year = cur.getFullYear();\n\t\t\tobj.date = cur;\n\t\t\toutput.days.push(obj);\n\t\t}\n\n\t\treturn output;\n\t};\n\n\tself.hide = function() {\n\t\tif (visible) {\n\t\t\tself.older = null;\n\t\t\tself.aclass('hidden');\n\t\t\tself.rclass('ui-calendar-visible');\n\t\t\tvisible = false;\n\t\t}\n\t\treturn self;\n\t};\n\n\tself.toggle = function(el, value, callback, offset) {\n\t\tif (self.older === el[0]) {\n\t\t\t!self.hclass('hidden') && self.hide();\n\t\t} else {\n\t\t\tself.older = el[0];\n\t\t\tself.show(el, value, callback, offset);\n\t\t}\n\t\treturn self;\n\t};\n\n\tself.show = function(el, value, callback, offset) {\n\n\t\tsetTimeout(function() {\n\t\t\tclearTimeout2('calendarhide');\n\t\t}, 5);\n\n\t\tif (!el)\n\t\t\treturn self.hide();\n\n\t\tvar off = el.offset();\n\t\tvar h = el.innerHeight();\n\t\tvar l = off.left + (offset || 0);\n\t\tvar t = off.top + h + 12;\n\t\tvar s = 250;\n\n\t\tif (l + s > WW) {\n\t\t\tvar w = el.innerWidth();\n\t\t\tl = (l + w) - s;\n\t\t}\n\n\t\tself.css({ left: l, top: t });\n\t\tself.rclass('hidden');\n\t\tself.click = callback;\n\t\tself.date(value);\n\t\tvisible = true;\n\t\tself.aclass('ui-calendar-visible', 50);\n\t\treturn self;\n\t};\n\n\tself.make = function() {\n\n\t\tself.aclass('ui-calendar hidden');\n\n\t\tvar conf = {};\n\n\t\tif (!config.days) {\n\t\t\tconf.days = [];\n\t\t\tfor (var i = 0; i < DAYS.length; i++)\n\t\t\t\tconf.days.push(DAYS[i].substring(0, 2).toUpperCase());\n\t\t}\n\n\t\t!config.months && (conf.months = MONTHS);\n\t\tself.reconfigure(conf);\n\n\t\tself.event('click', '.ui-calendar-today-a', function() {\n\t\t\tvar dt = new Date();\n\t\t\tself.hide();\n\t\t\tif (self.click) {\n\t\t\t\tif (typeof(self.click) === 'string') {\n\t\t\t\t\tSET(self.click, dt);\n\t\t\t\t\tCHANGE(self.click, true);\n\t\t\t\t} else\n\t\t\t\t\tself.click(dt);\n\t\t\t}\n\t\t});\n\n\t\tself.event('click', '.ui-calendar-day', function() {\n\t\t\tvar arr = this.getAttribute('data-date').split('-');\n\t\t\tvar dt = new Date(parseInt(arr[0]), parseInt(arr[1]), parseInt(arr[2]), 12, 0);\n\t\t\tself.find('.ui-calendar-selected').rclass('ui-calendar-selected');\n\t\t\tvar el = $(this).aclass('ui-calendar-selected');\n\t\t\tskip = !el.hclass('ui-calendar-disabled');\n\t\t\tself.hide();\n\t\t\tif (self.click) {\n\t\t\t\tif (typeof(self.click) === 'string') {\n\t\t\t\t\tSET(self.click, dt);\n\t\t\t\t\tCHANGE(self.click, true);\n\t\t\t\t} else\n\t\t\t\t\tself.click(dt);\n\t\t\t}\n\t\t});\n\n\t\tself.event('click', '.ui-calendar-header', function(e) {\n\t\t\te.stopPropagation();\n\t\t});\n\n\t\tself.event('change', '.ui-calendar-year', function(e) {\n\n\t\t\tclearTimeout2('calendarhide');\n\t\t\te.preventDefault();\n\t\t\te.stopPropagation();\n\n\t\t\tvar arr = this.getAttribute('data-date').split('-');\n\t\t\tvar dt = new Date(parseInt(arr[0]), parseInt(arr[1]), 1, 12, 0);\n\t\t\tdt.setFullYear(this.value);\n\t\t\tskipDay = true;\n\t\t\tself.date(dt);\n\t\t});\n\n\t\tself.event('change', '.ui-calendar-month', function(e){\n\n\t\t\tclearTimeout2('calendarhide');\n\t\t\te.preventDefault();\n\t\t\te.stopPropagation();\n\n\t\t\tvar arr = this.getAttribute('data-date').split('-');\n\t\t\tvar dt = new Date(parseInt(arr[0]), parseInt(arr[1]), 1, 12, 0);\n\t\t\tdt.setMonth(this.value);\n\t\t\tskipDay = true;\n\t\t\tself.date(dt);\n\t\t});\n\n\t\tself.event('click', 'button', function(e) {\n\n\t\t\te.preventDefault();\n\t\t\te.stopPropagation();\n\n\t\t\tvar arr = this.getAttribute('data-date').split('-');\n\t\t\tvar dt = new Date(parseInt(arr[0]), parseInt(arr[1]), 1, 12, 0);\n\t\t\tswitch (this.name) {\n\t\t\t\tcase 'prev':\n\t\t\t\t\tdt.setMonth(dt.getMonth() - 1);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'next':\n\t\t\t\t\tdt.setMonth(dt.getMonth() + 1);\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tvar current_year = dt.getFullYear();\n\t\t\tif (current_year < self.years_from || current_year > self.years_to)\n\t\t\t\treturn;\n\n\t\t\tskipDay = true;\n\t\t\tself.date(dt);\n\t\t});\n\n\t\t$(window).on('scroll click', function() {\n\t\t\tvisible && setTimeout2('calendarhide', function() {\n\t\t\t\tEXEC('$calendar.hide');\n\t\t\t}, 20);\n\t\t});\n\n\t\twindow.$calendar = self;\n\n\t\tself.on('reflow', function() {\n\t\t\tvisible && EXEC('$calendar.hide');\n\t\t});\n\t};\n\n\tself.date = function(value) {\n\n\t\tvar clssel = 'ui-calendar-selected';\n\n\t\tif (typeof(value) === 'string')\n\t\t\tvalue = value.parseDate();\n\n\t\tif (!value || isNaN(value.getTime())) {\n\t\t\tself.find('.' + clssel).rclass(clssel);\n\t\t\tvalue = NOW;\n\t\t}\n\n\t\tvar empty = !value;\n\n\t\tif (skipDay) {\n\t\t\tskipDay = false;\n\t\t\tempty = true;\n\t\t}\n\n\t\tif (skip) {\n\t\t\tskip = false;\n\t\t\treturn;\n\t\t}\n\n\t\tif (!value)\n\t\t\tvalue = NOW = new Date();\n\n\t\tvar output = self.calculate(value.getFullYear(), value.getMonth(), value);\n\t\tvar builder = [];\n\n\t\tfor (var i = 0; i < 42; i++) {\n\n\t\t\tvar item = output.days[i];\n\n\t\t\tif (i % 7 === 0) {\n\t\t\t\tbuilder.length && builder.push('</tr>');\n\t\t\t\tbuilder.push('<tr>');\n\t\t\t}\n\n\t\t\tvar cls = [];\n\n\t\t\titem.isEmpty && cls.push('ui-calendar-disabled');\n\t\t\tcls.push('ui-calendar-day');\n\n\t\t\t!empty && item.isSelected && cls.push(clssel);\n\t\t\titem.isToday && cls.push('ui-calendar-day-today');\n\t\t\tbuilder.push('<td class=\"{0}\" data-date=\"{1}-{2}-{3}\"><div>{3}</div></td>'.format(cls.join(' '), item.year, item.month, item.number));\n\t\t}\n\n\t\tbuilder.push('</tr>');\n\n\t\tvar header = [];\n\t\tfor (var i = 0; i < 7; i++)\n\t\t\theader.push('<th>{0}</th>'.format(output.header[i].name));\n\n\t\tvar years = value.getFullYear();\n\t\tif (config.yearselect) {\n\t\t\tyears = '';\n\t\t\tvar current_year = value.getFullYear();\n\t\t\tfor (var i = self.years_from; i <= self.years_to; i++)\n\t\t\t\tyears += '<option value=\"{0}\" {1}>{0}</option>'.format(i, i === current_year ? 'selected' : '');\n\t\t\tyears = '<select data-date=\"{0}-{1}\" class=\"ui-calendar-year\">{2}</select>'.format(output.year, output.month, years);\n\t\t}\n\n\t\tvar months = self.months[value.getMonth()];\n\t\tif (config.monthselect) {\n\t\t\tmonths = '';\n\t\t\tvar current_month = value.getMonth();\n\t\t\tfor (var i = 0, l = self.months.length; i < l; i++)\n\t\t\t\tmonths += '<option value=\"{0}\" {2}>{1}</option>'.format(i, self.months[i], i === current_month ? 'selected' : '');\n\t\t\tmonths = '<select data-date=\"{0}-{1}\" class=\"ui-calendar-month\">{2}</select>'.format(output.year, output.month, months);\n\t\t}\n\n\t\tself.html('<div class=\"ui-calendar-header\"><button class=\"ui-calendar-header-prev\" name=\"prev\" data-date=\"{0}-{1}\"><span class=\"fa fa-arrow-left\"></span></button><div class=\"ui-calendar-header-info\">{2} {3}</div><button class=\"ui-calendar-header-next\" name=\"next\" data-date=\"{0}-{1}\"><span class=\"fa fa-arrow-right\"></span></button></div><div class=\"ui-calendar-table\"><table cellpadding=\"0\" cellspacing=\"0\" border=\"0\"><thead>{4}</thead><tbody>{5}</tbody></table></div>'.format(output.year, output.month, months, years, header.join(''), builder.join('')) + (config.today ? '<div class=\"ui-calendar-today\"><a href=\"javascript:void(0)\">{0}</a><a href=\"javascript:void(0)\" class=\"ui-calendar-today-a\"><i class=\"fa fa-calendar\"></i>{1}</a></div>'.format(config.close, config.today) : ''));\n\t};\n});\n\nCOMPONENT('mainprogress', function(self) {\n\n\tvar old = null;\n\n\tself.singleton();\n\tself.readonly();\n\tself.nocompile();\n\n\tself.make = function() {\n\t\tself.aclass('ui-mainprogress hidden');\n\t};\n\n\tself.setter = function(value) {\n\t\t!value && (value = 0);\n\n\t\tif (old === value)\n\t\t\treturn;\n\n\t\tif (value > 100)\n\t\t\tvalue = 100;\n\t\telse if (value < 0)\n\t\t\tvalue = 0;\n\n\t\told = value >> 0;\n\n\t\tself.element.stop().animate({ width: old + '%' }, 80).show();\n\t\tself.tclass('hidden', old === 0 || old === 100);\n\t};\n});\n\nCOMPONENT('progress', 'animate:true', function(self, config) {\n\n\tvar container, old = null;\n\n\tself.readonly();\n\tself.nocompile();\n\n\tself.make = function() {\n\t\tself.aclass('ui-progress');\n\t\tself.append('<div style=\"width:10%\">0%</div>');\n\t\tcontainer = self.find('div');\n\t};\n\n\tself.setter = function(value) {\n\t\t!value && (value = 0);\n\t\tif (old === value)\n\t\t\treturn;\n\n\t\tif (value > 100)\n\t\t\tvalue = 100;\n\t\telse if (value < 0)\n\t\t\tvalue = 0;\n\n\t\told = value >> 0;\n\t\tif (config.animate)\n\t\t\tcontainer.stop().animate({ width: old + '%' }, 80).show();\n\t\telse\n\t\t\tcontainer.css({ width: old + '%' });\n\n\t\tcontainer.html(old + '%');\n\t};\n});\n\nCOMPONENT('pictures', function() {\n\n\tvar self = this;\n\n\tself.skip = false;\n\tself.readonly();\n\tself.nocompile();\n\n\tself.make = function() {\n\t\tself.aclass('ui-pictures');\n\t};\n\n\tself.setter = function(value) {\n\n\t\tif (typeof(value) === 'string')\n\t\t\tvalue = value.split(',');\n\n\t\tif (self.skip) {\n\t\t\tself.skip = false;\n\t\t\treturn;\n\t\t}\n\n\t\tself.find('.fa,img').unbind('click');\n\n\t\tif (!(value instanceof Array) || !value.length) {\n\t\t\tself.empty();\n\t\t\treturn;\n\t\t}\n\n\t\tvar builder = [];\n\n\t\tfor (var i = 0, length = value.length; i < length; i++) {\n\t\t\tvar id = value[i];\n\t\t\tid && builder.push('<div data-id=\"{0}\" class=\"col-xs-3 col-lg-2 m\"><span class=\"fa fa-times\"></span><img src=\"/images/small/{0}.jpg\" class=\"img-responsive\" alt=\"\" /></div>'.format(id));\n\t\t}\n\n\t\tself.html(builder);\n\n\t\tthis.element.find('.fa').bind('click', function() {\n\t\t\tvar id = [];\n\t\t\t$(this).parent().remove();\n\n\t\t\tself.find('div').each(function() {\n\t\t\t\tid.push($(this).attr('data-id'));\n\t\t\t});\n\n\t\t\tself.skip = true;\n\t\t\tself.set(id);\n\t\t});\n\n\t\tthis.element.find('img').bind('click', function() {\n\n\t\t\tvar selected = self.find('.selected');\n\t\t\tvar el = $(this);\n\n\t\t\tel.toggleClass('selected');\n\n\t\t\tif (!selected.length)\n\t\t\t\treturn;\n\n\t\t\tvar parent1 = el.parent();\n\t\t\tvar parent2 = selected.parent();\n\t\t\tvar id1 = parent1.attrd('id');\n\t\t\tvar id2 = parent2.attrd('id');\n\t\t\tvar arr = self.get();\n\n\t\t\tvar index1 = arr.indexOf(id1);\n\t\t\tvar index2 = arr.indexOf(id2);\n\n\t\t\tarr[index1] = id2;\n\t\t\tarr[index2] = id1;\n\n\t\t\tparent1.attrd('id', id2);\n\t\t\tparent2.attrd('id', id1);\n\n\t\t\tvar img1 = parent1.find('img');\n\t\t\tvar img2 = parent2.find('img');\n\t\t\tvar src1 = img1.attr('src');\n\n\t\t\timg1.attr('src', img2.attr('src'));\n\t\t\timg2.attr('src', src1);\n\n\t\t\tsetTimeout(function() {\n\t\t\t\tself.skip = true;\n\t\t\t\timg1.rclass('selected');\n\t\t\t\timg2.rclass('selected');\n\t\t\t\tself.change(true);\n\t\t\t\tself.set(arr);\n\t\t\t}, 200);\n\t\t});\n\t};\n});\n\nCOMPONENT('textboxtags', function(self, config) {\n\n\tvar isString = false;\n\tvar container, content = null;\n\tvar refresh = false;\n\tvar W = window;\n\n\tif (!W.$textboxtagstemplate)\n\t\tW.$textboxtagstemplate = Tangular.compile('<div class=\"ui-textboxtags-tag\" data-name=\"{{ name }}\">{{ name }}<i class=\"fa fa-times-circle ui-textboxtags-remove\"></i></div>');\n\n\tself.nocompile();\n\n\tvar template = W.$textboxtagstemplate;\n\n\tself.validate = function(value) {\n\t\treturn config.disabled || !config.required ? true : value && value.length > 0;\n\t};\n\n\tself.configure = function(key, value, init) {\n\t\tif (init)\n\t\t\treturn;\n\n\t\tvar redraw = false;\n\n\t\tswitch (key) {\n\t\t\tcase 'disabled':\n\t\t\t\tself.tclass('ui-disabled', value);\n\t\t\t\tself.state(1, 1);\n\t\t\t\tself.find('input').prop('disabled', value);\n\t\t\t\tbreak;\n\t\t\tcase 'required':\n\t\t\t\tself.find('.ui-textboxtags-label').tclass('ui-textboxtags-label-required', value);\n\t\t\t\tself.state(1, 1);\n\t\t\t\tbreak;\n\t\t\tcase 'icon':\n\t\t\t\tvar fa = self.find('.ui-textboxtags-label > i');\n\t\t\t\tif (fa.length && value)\n\t\t\t\t\tfa.rclass().aclass('fa fa-' + value);\n\t\t\t\telse\n\t\t\t\t\tredraw = true;\n\t\t\t\tbreak;\n\n\t\t\tcase 'placeholder':\n\t\t\t\tself.find('input').prop('placeholder', value);\n\t\t\t\tbreak;\n\t\t\tcase 'height':\n\t\t\t\tself.find('.ui-textboxtags-values').css('height', value);\n\t\t\t\tbreak;\n\t\t\tcase 'label':\n\t\t\t\tredraw = true;\n\t\t\t\tbreak;\n\t\t\tcase 'type':\n\t\t\t\tself.type = value;\n\t\t\t\tisString = self.type === 'string';\n\t\t\t\tbreak;\n\t\t}\n\n\t\tredraw && setTimeout2('redraw' + self.id, function() {\n\t\t\trefresh = true;\n\t\t\tcontainer.off();\n\t\t\tself.redraw();\n\t\t\tself.refresh();\n\t\t}, 100);\n\n\t};\n\n\tself.redraw = function() {\n\t\tvar label = config.label || content;\n\t\tvar html = '<div class=\"ui-textboxtags-values\"' + (config.height ? ' style=\"min-height:' + config.height + 'px\"' : '') + '><input type=\"text\" placeholder=\"' + (config.placeholder || '') + '\" /></div>';\n\n\t\tisString = self.type === 'string';\n\n\t\tif (content.length) {\n\t\t\tself.html('<div class=\"ui-textboxtags-label{0}\">{1}{2}:</div><div class=\"ui-textboxtags\">{3}</div>'.format((config.required ? ' ui-textboxtags-label-required' : ''), (config.icon ? '<i class=\"fa fa-' + config.icon + '\"></i> ' : ''), label, html));\n\t\t} else {\n\t\t\tself.aclass('ui-textboxtags');\n\t\t\tself.html(html);\n\t\t}\n\n\t\tcontainer = self.find('.ui-textboxtags-values');\n\t\tconfig.disabled && self.reconfigure('disabled:true');\n\t};\n\n\tself.make = function() {\n\n\t\tself.aclass('ui-textboxtags-container');\n\t\tcontent = self.html();\n\t\tself.type = config.type || '';\n\t\tself.redraw();\n\n\t\tself.event('click', '.ui-textboxtags-remove', function(e) {\n\n\t\t\tif (config.disabled)\n\t\t\t\treturn;\n\n\t\t\te.preventDefault();\n\t\t\te.stopPropagation();\n\n\t\t\tvar el = $(this);\n\t\t\tvar arr = self.get();\n\n\t\t\tif (isString)\n\t\t\t\tarr = self.split(arr);\n\n\t\t\tif (!arr || !(arr instanceof Array) || !arr.length)\n\t\t\t\treturn;\n\n\t\t\tvar index = arr.indexOf(el.parent().attr('data-name'));\n\t\t\tif (index === -1)\n\t\t\t\treturn;\n\n\t\t\tarr.splice(index, 1);\n\t\t\tself.set(isString ? arr.join(', ') : arr);\n\t\t\tself.change(true);\n\t\t});\n\n\t\tself.event('click', function() {\n\t\t\t!config.disabled && self.find('input').focus();\n\t\t});\n\n\t\tself.event('keydown', 'input', function(e) {\n\n\t\t\tif (config.disabled)\n\t\t\t\treturn;\n\n\t\t\tif (e.which === 8) {\n\t\t\t\tif (this.value)\n\t\t\t\t\treturn;\n\t\t\t\tvar arr = self.get();\n\t\t\t\tif (isString)\n\t\t\t\t\tarr = self.split(arr);\n\t\t\t\tif (!arr || !(arr instanceof Array) || !arr.length)\n\t\t\t\t\treturn;\n\t\t\t\tarr.pop();\n\t\t\t\tself.set(isString ? arr.join(', ') : arr);\n\t\t\t\tself.change(true);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (e.which !== 13)\n\t\t\t\treturn;\n\n\t\t\te.preventDefault();\n\n\t\t\tif (!this.value)\n\t\t\t\treturn;\n\n\t\t\tvar arr = self.get();\n\t\t\tvar value = this.value;\n\n\t\t\tif (config.uppercase)\n\t\t\t\tvalue = value.toUpperCase();\n\t\t\telse if (config.lowercase)\n\t\t\t\tvalue = value.toLowerCase();\n\n\t\t\tif (isString)\n\t\t\t\tarr = self.split(arr);\n\n\t\t\tif (!(arr instanceof Array))\n\t\t\t\tarr = [];\n\n\t\t\tif (arr.indexOf(value) === -1)\n\t\t\t\tarr.push(value);\n\t\t\telse\n\t\t\t\treturn;\n\n\t\t\tthis.value = '';\n\t\t\tself.set(isString ? arr.join(', ') : arr);\n\t\t\tself.change(true);\n\t\t});\n\t};\n\n\tself.split = function(value) {\n\t\tif (!value)\n\t\t\treturn new Array(0);\n\t\tvar arr = value.split(',');\n\t\tfor (var i = 0, length = arr.length; i < length; i++)\n\t\t\tarr[i] = arr[i].trim();\n\t\treturn arr;\n\t};\n\n\tself.setter = function(value) {\n\n\t\tif (!refresh && NOTMODIFIED(self.id, value))\n\t\t\treturn;\n\n\t\trefresh = false;\n\t\tcontainer.find('.ui-textboxtags-tag').remove();\n\n\t\tif (!value || !value.length)\n\t\t\treturn;\n\n\t\tvar arr = isString ? self.split(value) : value;\n\t\tvar builder = '';\n\t\tfor (var i = 0, length = arr.length; i < length; i++)\n\t\t\tbuilder += template({ name: arr[i] });\n\n\t\tcontainer.prepend(builder);\n\t};\n\n\tself.state = function(type) {\n\t\tif (!type)\n\t\t\treturn;\n\t\tvar invalid = config.required ? self.isInvalid() : false;\n\t\tif (invalid === self.$oldstate)\n\t\t\treturn;\n\t\tself.$oldstate = invalid;\n\t\tself.find('.ui-textboxtags').tclass('ui-textboxtags-invalid', invalid);\n\t};\n});\n\nCOMPONENT('websocket', 'reconnect:3000', function(self, config) {\n\n\tvar ws, url;\n\tvar queue = [];\n\tvar sending = false;\n\n\tself.online = false;\n\tself.readonly();\n\tself.nocompile();\n\n\tself.make = function() {\n\t\turl = (config.url || '').env(true);\n\t\tif (!url.match(/^(ws|wss):\\/\\//))\n\t\t\turl = (location.protocol.length === 6 ? 'wss' : 'ws') + '://' + location.host + (url.substring(0, 1) !== '/' ? '/' : '') + url;\n\t\tsetTimeout(self.connect, 500);\n\t\tself.destroy = self.close;\n\t};\n\n\tself.send = function(obj) {\n\t\tqueue.push(encodeURIComponent(JSON.stringify(obj)));\n\t\tself.process();\n\t\treturn self;\n\t};\n\n\tself.process = function(callback) {\n\n\t\tif (!ws || sending || !queue.length || ws.readyState !== 1) {\n\t\t\tcallback && callback();\n\t\t\treturn;\n\t\t}\n\n\t\tsending = true;\n\t\tvar async = queue.splice(0, 3);\n\t\tasync.wait(function(item, next) {\n\t\t\tws.send(item);\n\t\t\tsetTimeout(next, 5);\n\t\t}, function() {\n\t\t\tcallback && callback();\n\t\t\tsending = false;\n\t\t\tqueue.length && self.process();\n\t\t});\n\t};\n\n\tself.close = function(isClosed) {\n\t\tif (!ws)\n\t\t\treturn self;\n\t\tself.online = false;\n\t\tws.onopen = ws.onclose = ws.onmessage = null;\n\t\t!isClosed && ws.close();\n\t\tws = null;\n\t\tEMIT('online', false);\n\t\treturn self;\n\t};\n\n\tfunction onClose() {\n\t\tself.close(true);\n\t\tsetTimeout(self.connect, config.reconnect);\n\t}\n\n\tfunction onMessage(e) {\n\t\tvar data;\n\t\ttry {\n\t\t\tdata = PARSE(decodeURIComponent(e.data));\n\t\t\tself.attrd('jc-path') && self.set(data);\n\t\t} catch (e) {\n\t\t\tWARN('WebSocket \"{0}\": {1}'.format(url, e.toString()));\n\t\t}\n\t\tdata && EMIT('message', data);\n\t}\n\n\tfunction onOpen() {\n\t\tself.online = true;\n\t\tself.process(function() {\n\t\t\tEMIT('online', true);\n\t\t});\n\t}\n\n\tself.connect = function() {\n\t\tws && self.close();\n\t\tsetTimeout2(self.id, function() {\n\t\t\tws = new WebSocket(url.env(true));\n\t\t\tws.onopen = onOpen;\n\t\t\tws.onclose = onClose;\n\t\t\tws.onmessage = onMessage;\n\t\t}, 100);\n\t\treturn self;\n\t};\n});\n\nCOMPONENT('donutchart', 'format:{{ value | format(0) }};size:0;tooltip:true;presentation:true;animate:true', function(self, config) {\n\n\tvar svg, g, selected, tooltip;\n\tvar strokew = 0;\n\tvar animate = true;\n\tvar indexer = 0;\n\tvar indexerskip = false;\n\tvar force = false;\n\tvar W = $(window);\n\n\tself.readonly();\n\tself.nocompile();\n\n\tself.make = function() {\n\t\tself.aclass('ui-donutchart');\n\t\tself.append('<div class=\"ui-donutchart-tooltip\"></div><svg></svg>');\n\t\tsvg = self.find('svg');\n\t\tg = svg.asvg('g').attr('class', 'pieces');\n\t\ttooltip = self.find('.ui-donutchart-tooltip');\n\n\t\tW.on('resize', self.resize);\n\n\t\tself.event('mouseenter touchstart', '.piece', function() {\n\t\t\tself.select(+this.getAttribute('data-index'));\n\t\t\t!indexerskip && config.presentation && setTimeout2(self.id + '.skip', self.next, 30000);\n\t\t\tindexerskip = true;\n\t\t});\n\t};\n\n\tself.select = function(index) {\n\t\tvar item = self.get()[index];\n\t\tif (item === selected)\n\t\t\treturn;\n\n\t\tself.find('.selected').rclass('selected').css('stroke-width', strokew);\n\t\tselected = item;\n\n\t\tvar el = self.find('.piece' + (index + 1));\n\n\t\tif (config.tooltip) {\n\t\t\tvar w = self.width();\n\t\t\ttooltip.css('font-size', w / 15);\n\t\t\ttooltip.html('<b>' + item.name + '</b><br />' + Tangular.render(config.format, item));\n\t\t}\n\n\t\tconfig.select && EXEC(config.select, item);\n\t\tel.css('stroke-width', strokew.inc('+15%')).aclass('selected');\n\t\tindexer = index;\n\t};\n\n\tself.destroy = function() {\n\t\tW.off('resize', self.resize);\n\t};\n\n\tself.resize = function() {\n\t\tsetTimeout2('resize.' + self.id, function() {\n\t\t\tanimate = false;\n\t\t\tforce = true;\n\t\t\tself.refresh();\n\t\t}, 100);\n\t};\n\n\tself.next = function() {\n\n\t\tif (self.removed)\n\t\t\treturn;\n\n\t\tif (indexerskip) {\n\t\t\tindexerskip = false;\n\t\t\treturn;\n\t\t}\n\n\t\tindexer++;\n\n\t\tvar tmp = self.get();\n\t\tif (!tmp)\n\t\t\treturn;\n\n\t\tif (!tmp[indexer])\n\t\t\tindexer = 0;\n\n\t\tself.select(indexer);\n\t\tsetTimeout2(self.id + '.next', self.next, 4000);\n\t};\n\n\tfunction arcradius(centerX, centerY, radius, degrees) {\n\t\tvar radians = (degrees - 90) * Math.PI / 180.0;\n\t\treturn { x: centerX + (radius * Math.cos(radians)), y: centerY + (radius * Math.sin(radians)) };\n\t}\n\n\tfunction arc(x, y, radius, startAngle, endAngle){\n\t\tvar start = arcradius(x, y, radius, endAngle);\n\t\tvar end = arcradius(x, y, radius, startAngle);\n\t\tvar largeArcFlag = endAngle - startAngle <= 180 ? 0 : 1;\n\t\tvar d = ['M', start.x, start.y, 'A', radius, radius, 0, largeArcFlag, 0, end.x, end.y].join(' ');\n\t\treturn d;\n\t}\n\n\tself.redraw = function(width, value) {\n\n\t\tvar sum = null;\n\n\t\tfor (var i = 0, length = value.length; i < length; i++) {\n\t\t\tvar item = value[i];\n\n\t\t\tif (item.value == null)\n\t\t\t\titem.value = 0;\n\n\t\t\tvar val = item.value + 1;\n\t\t\tsum = sum ? sum + val : val;\n\t\t}\n\n\t\tvar count = 0;\n\t\tvar beg = 0;\n\t\tvar end = 0;\n\t\tvar items = [];\n\n\t\tfor (var i = 0, length = value.length; i < length; i++) {\n\t\t\tvar item = value[i];\n\t\t\tvar p = (((item.value + 1) / sum) * 100).floor(2);\n\n\t\t\tcount += p;\n\n\t\t\tif (i === length - 1 && count < 100)\n\t\t\t\tp = p + (100 - count);\n\n\t\t\tend = beg + ((360 / 100) * p);\n\t\t\titems.push({ name: item.name, percentage: p, beg: beg, end: end });\n\t\t\tbeg = end;\n\t\t}\n\n\t\tif (!force && NOTMODIFIED(self.id, items))\n\t\t\treturn;\n\n\t\tvar size = width;\n\t\tvar half = size / 2;\n\t\tvar midpoint = size / 2.4;\n\n\t\tstrokew = (size / 6 >> 0).inc('-15%');\n\n\t\tsvg.attr('width', size);\n\t\tsvg.attr('height', size);\n\t\tg.empty();\n\n\t\tvar pieces = [];\n\n\t\tfor (var i = 0, length = items.length; i < length; i++) {\n\t\t\tvar item = items[i];\n\t\t\tif (item.percentage === 0)\n\t\t\t\tcontinue;\n\t\t\tif (item.end === 360)\n\t\t\t\titem.end = 359.99;\n\t\t\tpieces.push(g.asvg('path').attr('data-index', i).attr('data-beg', item.beg).attr('data-end', item.end).attr('stroke-width', strokew).attr('class', 'piece piece' + (i + 1)).attr('d', arc(half, half, midpoint, item.beg, animate ? item.beg : item.end)));\n\t\t}\n\n\t\tanimate && pieces.wait(function(item, next) {\n\t\t\tvar beg = +item.attrd('beg');\n\t\t\tvar end = +item.attrd('end');\n\t\t\tvar diff = end - beg;\n\n\t\t\tif (config.animate) {\n\t\t\t\titem.animate({ end: diff }, { duration: 180, step: function(fx) {\n\t\t\t\t\titem.attr('d', arc(half, half, midpoint, beg, beg + fx));\n\t\t\t\t}, complete: function() {\n\t\t\t\t\tnext();\n\t\t\t\t}});\n\t\t\t} else {\n\t\t\t\titem.attr('d', arc(half, half, midpoint, beg, end));\n\t\t\t\tnext();\n\t\t\t}\n\t\t});\n\n\t\tselected = null;\n\t\tanimate = true;\n\t\tforce = false;\n\n\t\tconfig.redraw && EXEC(config.redraw);\n\n\t\tself.select(0);\n\t\tif (config.presentation) {\n\t\t\tindexerskip = false;\n\t\t\tsetTimeout(self.next, 4000);\n\t\t}\n\t};\n\n\tself.setter = function(value) {\n\n\t\tif (!value) {\n\t\t\tg.empty();\n\t\t\treturn;\n\t\t}\n\n\t\tif (config.size) {\n\t\t\tself.redraw(config.size, value);\n\t\t} else {\n\t\t\tself.width(function(width) {\n\t\t\t\tself.redraw(width, value);\n\t\t\t});\n\t\t}\n\t};\n});\n\nCOMPONENT('tabmenu', 'class:selected', function(self, config) {\n\tvar old, oldtab;\n\n\tself.readonly();\n\tself.nocompile();\n\n\tself.make = function() {\n\t\tself.event('click', 'li', function() {\n\t\t\tvar el = $(this);\n\t\t\t!el.hclass(config.class) && self.set(el.attrd('value'), 2);\n\t\t});\n\t};\n\n\tself.setter = function(value) {\n\t\tif (old === value)\n\t\t\treturn;\n\t\toldtab && oldtab.rclass(config.class);\n\t\toldtab = self.find('li[data-value=\"' + value + '\"]').aclass(config.class);\n\t\told = value;\n\t};\n});\n\nCOMPONENT('error', function(self, config) {\n\n\tself.readonly();\n\tself.nocompile();\n\n\tself.make = function() {\n\t\tself.aclass('ui-error hidden');\n\t};\n\n\tself.setter = function(value) {\n\n\t\tif (!(value instanceof Array) || !value.length) {\n\t\t\tself.tclass('hidden', true);\n\t\t\treturn;\n\t\t}\n\n\t\tvar builder = [];\n\t\tfor (var i = 0, length = value.length; i < length; i++)\n\t\t\tbuilder.push('<div><span class=\"fa {1}\"></span>{0}</div>'.format(value[i].error, 'fa-' + (config.icon || 'times-circle')));\n\n\t\tself.html(builder.join(''));\n\t\tself.tclass('hidden', false);\n\t};\n});\n\nCOMPONENT('barchart', 'pl:20;pt:10;pb:25;prselected:0;axisX:true;axisY:true;paddingbars:5;limit:0;paddinggroup:10;radius:2;offsetX:10;offsetY:10;templateY:{{ value | format(0) }};templateX:{{ value }};height:0', function(self, config) {\n\n\tvar svg, g, axis, selected;\n\tvar templateX, templateY;\n\tvar W = $(window);\n\n\tself.readonly();\n\tself.nocompile();\n\n\tself.make = function() {\n\t\tself.aclass('ui-barchart');\n\t\tself.empty().append('<svg></svg>');\n\t\tsvg = self.find('svg');\n\t\taxis = svg.asvg('g').attr('class', 'axisy');\n\t\tg = svg.asvg('g').attr('class', 'bars');\n\t\tselected = svg.asvg('text').attr('class', 'selected').attr('text-anchor', 'end');\n\t\tW.on('resize', self.resize);\n\n\t\tself.event('click mouseenter', 'rect', function(e) {\n\t\t\tvar rect = $(this);\n\t\t\tvar index = rect.attrd('index');\n\n\t\t\tif (index === self.$selectedindex && e.type === 'mouseenter')\n\t\t\t\treturn;\n\n\t\t\tself.$selectedindex = index;\n\t\t\tvar arr = index.split(',');\n\t\t\tvar item = self.get()[+arr[0]];\n\t\t\tvar value = item.values[+arr[1]];\n\t\t\tselected.text(templateY({ value: value.y }));\n\t\t\tif (e.type === 'mouseenter') {\n\t\t\t\tsetTimeout2(self.id, function() {\n\t\t\t\t\tselected.text('');\n\t\t\t\t}, 2000);\n\t\t\t} else\n\t\t\t\tclearTimeout2(self.id);\n\t\t});\n\n\t};\n\n\tself.destroy = function() {\n\t\tW.off('resize', self.resize);\n\t};\n\n\tself.resize = function() {\n\t\tsetTimeout2('resize.' + self.id, function() {\n\t\t\tself.refresh();\n\t\t}, 500);\n\t};\n\n\tself.configure = function(key, value, init) {\n\t\tswitch (key) {\n\t\t\tcase 'templateX':\n\t\t\t\ttemplateX = Tangular.compile(value);\n\t\t\t\tbreak;\n\t\t\tcase 'templateY':\n\t\t\t\ttemplateY = Tangular.compile(value);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\t!init && self.resize();\n\t\t\t\tbreak;\n\t\t}\n\t};\n\n\tself.released = function(is) {\n\t\t!is && setTimeout(self.refresh, 1000);\n\t};\n\n\tself.setter = function(value) {\n\n\t\tif (!self.element[0].offsetParent) {\n\t\t\tsetTimeout(function() {\n\t\t\t\tself.refresh();\n\t\t\t}, 1000);\n\t\t\treturn;\n\t\t}\n\n\t\tif (!value) {\n\t\t\tg.empty();\n\t\t\treturn;\n\t\t}\n\n\t\tvar maxX = 0;\n\t\tvar maxY = 0;\n\t\tvar labels = [];\n\t\tvar paddingbars = config.paddingbars;\n\t\tvar paddinggroup = config.paddinggroup;\n\t\tvar len = value.length;\n\t\tvar size = value[0].values.length;\n\t\tvar width = config.width ? config.width : self.element.width();\n\t\tvar height = config.height ? config.height : (width / 100) * 60;\n\t\tvar barwidth = ((width - paddingbars - paddinggroup - config.pl) / (size * len));\n\t\tvar lines = {};\n\n\t\tbarwidth -= paddingbars + (paddinggroup / len);\n\n\t\tfor (var i = 0; i < len; i++) {\n\t\t\tvar item = value[i];\n\t\t\tlabels.push(item.name);\n\t\t\tfor (var j = 0, length = item.values.length; j < length; j++) {\n\t\t\t\tvar val = item.values[j];\n\t\t\t\tmaxX = Math.max(maxX, val.x);\n\t\t\t\tmaxY = Math.max(maxY, val.y);\n\t\t\t}\n\t\t}\n\n\t\tif (config.limit)\n\t\t\tmaxY = config.limit;\n\n\t\tsvg.attr('width', width);\n\t\tsvg.attr('height', height);\n\n\t\tselected.attr('transform', 'translate({0},30)'.format(width - config.prselected));\n\n\t\tg.empty();\n\t\taxis.empty();\n\n\t\tlines.height = height - config.pt - config.pb;\n\n\t\tvar T = { value: null };\n\n\t\tfor (var i = 5; i > 0; i--) {\n\t\t\tvar val = i * 20;\n\t\t\tvar y = (((lines.height / 100) * val) + config.pt);\n\t\t\tconfig.axisY && axis.asvg('line').attr('x1', 0).attr('x2', width).attr('y1', y).attr('y2', y).attr('class', 'axis');\n\t\t\tT.value = (maxY / 100) * (100 - val);\n\t\t\taxis.asvg('text').aclass('ylabel').attr('transform', 'translate({0},{1})'.format(config.offsetX, y - config.offsetY)).text(templateY(T));\n\t\t}\n\n\t\tvar offsetX = config.pl + paddingbars + paddinggroup;\n\t\tvar posX = 0;\n\t\tvar offsetL = (len - 1) === 0 ? 0.5 : len - 1;\n\t\tvar offsetY =  config.pb;\n\n\t\tfor (var i = 0, length = size; i < length; i++) {\n\n\t\t\tfor (var j = 0; j < len; j++) {\n\n\t\t\t\tvar item = value[j];\n\t\t\t\tvar val = item.values[i];\n\t\t\t\tvar rect = g.asvg('rect');\n\t\t\t\tvar y = ((val.y / maxY) * 100) >> 0;\n\t\t\t\tvar x = posX + (barwidth * j);\n\t\t\t\tvar h = lines.height.inc('{0}%'.format(y));\n\n\t\t\t\tx += offsetX + (paddingbars * j);\n\t\t\t\tT.value = val.y;\n\t\t\t\trect.attr('x', x).attr('y', ((lines.height - h) + (offsetY / 2)) - 3).attr('width', barwidth).attr('height', h).attr('class', 'bar bar' + (j + 1)).attr('data-index', j + ',' + i);\n\t\t\t\tconfig.radius && rect.attr('rx', config.radius).attr('ry', config.radius);\n\t\t\t}\n\n\t\t\tT.value = val.x;\n\t\t\tvar text = templateX(T);\n\t\t\tvar ax = posX + offsetX + (barwidth * len) + (paddingbars * len) + 2;\n\t\t\tconfig.axisX && axis.asvg('line').attr('x1', ax).attr('x2', ax).attr('y1', 0).attr('y2', height - 25).attr('class', 'axis');\n\t\t\tg.asvg('text').aclass('xlabel').text(text).attr('text-anchor', 'middle').attr('transform', 'translate({0},{1})'.format(posX + offsetX + (barwidth * offsetL), height - 6));\n\n\t\t\tposX += (len * barwidth) + paddinggroup;\n\t\t\toffsetX += len * paddingbars;\n\t\t}\n\t};\n});\n\nCOMPONENT('shortcuts', function(self) {\n\n\tvar items = [];\n\tvar length = 0;\n\n\tself.singleton();\n\tself.readonly();\n\tself.blind();\n\tself.nocompile();\n\n\tself.make = function() {\n\t\t$(window).on('keydown', function(e) {\n\t\t\tif (length && !e.isPropagationStopped()) {\n\t\t\t\tfor (var i = 0; i < length; i++) {\n\t\t\t\t\tvar o = items[i];\n\t\t\t\t\tif (o.fn(e)) {\n\t\t\t\t\t\tif (o.prevent) {\n\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t\te.stopPropagation();\n\t\t\t\t\t\t}\n\t\t\t\t\t\tsetTimeout(function(o, e) {\n\t\t\t\t\t\t\to.callback(e);\n\t\t\t\t\t\t}, 100, o, e);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t};\n\n\tself.exec = function(shortcut) {\n\t\tvar item = items.findItem('shortcut', shortcut.toLowerCase().replace(/\\s/g, ''));\n\t\titem && item.callback(EMPTYOBJECT);\n\t};\n\n\tself.register = function(shortcut, callback, prevent) {\n\t\tshortcut.split(',').trim().forEach(function(shortcut) {\n\t\t\tvar builder = [];\n\t\t\tvar alias = [];\n\t\t\tshortcut.split('+').trim().forEach(function(item) {\n\t\t\t\tvar lower = item.toLowerCase();\n\t\t\t\talias.push(lower);\n\t\t\t\tswitch (lower) {\n\t\t\t\t\tcase 'ctrl':\n\t\t\t\t\tcase 'alt':\n\t\t\t\t\tcase 'shift':\n\t\t\t\t\t\tbuilder.push('e.{0}Key'.format(lower));\n\t\t\t\t\t\treturn;\n\t\t\t\t\tcase 'win':\n\t\t\t\t\tcase 'meta':\n\t\t\t\t\tcase 'cmd':\n\t\t\t\t\t\tbuilder.push('e.metaKey');\n\t\t\t\t\t\treturn;\n\t\t\t\t\tcase 'space':\n\t\t\t\t\t\tbuilder.push('e.keyCode===32');\n\t\t\t\t\t\treturn;\n\t\t\t\t\tcase 'tab':\n\t\t\t\t\t\tbuilder.push('e.keyCode===9');\n\t\t\t\t\t\treturn;\n\t\t\t\t\tcase 'esc':\n\t\t\t\t\t\tbuilder.push('e.keyCode===27');\n\t\t\t\t\t\treturn;\n\t\t\t\t\tcase 'enter':\n\t\t\t\t\t\tbuilder.push('e.keyCode===13');\n\t\t\t\t\t\treturn;\n\t\t\t\t\tcase 'backspace':\n\t\t\t\t\tcase 'del':\n\t\t\t\t\tcase 'delete':\n\t\t\t\t\t\tbuilder.push('(e.keyCode===8||e.keyCode===127)');\n\t\t\t\t\t\treturn;\n\t\t\t\t\tcase 'up':\n\t\t\t\t\t\tbuilder.push('e.keyCode===38');\n\t\t\t\t\t\treturn;\n\t\t\t\t\tcase 'down':\n\t\t\t\t\t\tbuilder.push('e.keyCode===40');\n\t\t\t\t\t\treturn;\n\t\t\t\t\tcase 'right':\n\t\t\t\t\t\tbuilder.push('e.keyCode===39');\n\t\t\t\t\t\treturn;\n\t\t\t\t\tcase 'left':\n\t\t\t\t\t\tbuilder.push('e.keyCode===37');\n\t\t\t\t\t\treturn;\n\t\t\t\t\tcase 'f1':\n\t\t\t\t\tcase 'f2':\n\t\t\t\t\tcase 'f3':\n\t\t\t\t\tcase 'f4':\n\t\t\t\t\tcase 'f5':\n\t\t\t\t\tcase 'f6':\n\t\t\t\t\tcase 'f7':\n\t\t\t\t\tcase 'f8':\n\t\t\t\t\tcase 'f9':\n\t\t\t\t\tcase 'f10':\n\t\t\t\t\tcase 'f11':\n\t\t\t\t\tcase 'f12':\n\t\t\t\t\t\tvar a = item.toUpperCase();\n\t\t\t\t\t\tbuilder.push('e.key===\\'{0}\\''.format(a));\n\t\t\t\t\t\treturn;\n\t\t\t\t\tcase 'capslock':\n\t\t\t\t\t\tbuilder.push('e.which===20');\n\t\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tvar num = item.parseInt();\n\t\t\t\tif (num)\n\t\t\t\t\tbuilder.push('e.which===' + num);\n\t\t\t\telse\n\t\t\t\t\tbuilder.push('e.key===\\'{0}\\''.format(item));\n\n\t\t\t});\n\n\t\t\titems.push({ shortcut: alias.join('+'), fn: new Function('e', 'return ' + builder.join('&&')), callback: callback, prevent: prevent });\n\t\t\tlength = items.length;\n\t\t});\n\t\treturn self;\n\t};\n});\n\nCOMPONENT('preview', 'width:200;height:100;background:#FFFFFF;quality:90;schema:{file\\\\:base64,name\\\\:filename}', function(self, config) {\n\n\tvar empty, img, canvas, name, content = null;\n\n\tself.readonly();\n\tself.nocompile();\n\n\tself.configure = function(key, value, init) {\n\n\t\tif (init)\n\t\t\treturn;\n\n\t\tvar redraw = false;\n\n\t\tswitch (key) {\n\t\t\tcase 'width':\n\t\t\tcase 'height':\n\t\t\tcase 'background':\n\t\t\t\tsetTimeout2(self.id + 'reinit', self.reinit, 50);\n\t\t\t\tbreak;\n\t\t\tcase 'label':\n\t\t\tcase 'icon':\n\t\t\t\tredraw = true;\n\t\t\t\tbreak;\n\t\t}\n\n\t\tredraw && setTimeout2(self.id + 'redraw', function() {\n\t\t\tself.redraw();\n\t\t\tself.refresh();\n\t\t}, 50);\n\t};\n\n\tself.reinit = function() {\n\t\tcanvas = document.createElement('canvas');\n\t\tcanvas.width = config.width;\n\t\tcanvas.height = config.height;\n\t\tvar ctx = canvas.getContext('2d');\n\t\tctx.fillStyle = config.background;\n\t\tctx.fillRect(0, 0, config.width, config.height);\n\t\tempty = canvas.toDataURL('image/png');\n\t\tcanvas = null;\n\t};\n\n\tself.resize = function(image) {\n\t\tvar canvas = document.createElement('canvas');\n\t\tvar ctx = canvas.getContext('2d');\n\t\tcanvas.width = config.width;\n\t\tcanvas.height = config.height;\n\t\tctx.fillStyle = config.background;\n\t\tctx.fillRect(0, 0, config.width, config.height);\n\n\t\tvar w = 0;\n\t\tvar h = 0;\n\t\tvar x = 0;\n\t\tvar y = 0;\n\n\t\tif (image.width < config.width && image.height < config.height) {\n\t\t\tw = image.width;\n\t\t\th = image.height;\n\t\t\tx = (config.width / 2) - (image.width / 2);\n\t\t\ty = (config.height / 2) - (image.height / 2);\n\t\t} else if (image.width >= image.height) {\n\t\t\tw = config.width;\n\t\t\th = image.height * (config.width / image.width);\n\t\t\ty = (config.height / 2) - (h / 2);\n\t\t} else {\n\t\t\th = config.height;\n\t\t\tw = (image.width * (config.height / image.height)) >> 0;\n\t\t\tx = (config.width / 2) - (w / 2);\n\t\t}\n\n\t\tctx.drawImage(image, x, y, w, h);\n\t\tvar base64 = canvas.toDataURL('image/jpeg', config.quality * 0.01);\n\t\timg.attr('src', base64);\n\t\tself.upload(base64);\n\t};\n\n\tself.redraw = function() {\n\t\tvar label = config.label || content;\n\t\tself.html((label ? '<div class=\"ui-preview-label\">{0}{1}:</div>'.format(config.icon ? '<i class=\"fa fa-{0}\"></i>'.format(config.icon) : '', label) : '') + '<input type=\"file\" accept=\"image/*\" class=\"hidden\" /><img src=\"{0}\" class=\"img-responsive\" alt=\"\" />'.format(empty, config.width, config.height));\n\t\timg = self.find('img');\n\t\timg.on('click', function() {\n\t\t\tself.find('input').trigger('click');\n\t\t});\n\t};\n\n\tself.make = function() {\n\n\t\tcontent = self.html();\n\t\tself.aclass('ui-preview');\n\t\tself.reinit();\n\t\tself.redraw();\n\n\t\tself.event('change', 'input', function() {\n\t\t\tvar reader = new FileReader();\n\t\t\treader.onload = function () {\n\t\t\t\tvar image = new Image();\n\t\t\t\timage.onload = function() {\n\t\t\t\t\tself.resize(image);\n\t\t\t\t};\n\t\t\t\timage.src = reader.result;\n\t\t\t};\n\t\t\tvar file = this.files[0];\n\t\t\tname = file.name;\n\t\t\treader.readAsDataURL(file);\n\t\t\tthis.value = '';\n\t\t});\n\n\t\tself.event('dragenter dragover dragexit drop dragleave', function (e) {\n\n\t\t\te.stopPropagation();\n\t\t\te.preventDefault();\n\n\t\t\tswitch (e.type) {\n\t\t\t\tcase 'drop':\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'dragenter':\n\t\t\t\tcase 'dragover':\n\t\t\t\t\treturn;\n\t\t\t\tcase 'dragexit':\n\t\t\t\tcase 'dragleave':\n\t\t\t\tdefault:\n\t\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar dt = e.originalEvent.dataTransfer;\n\t\t\tif (dt && dt.files.length) {\n\t\t\t\tvar reader = new FileReader();\n\t\t\t\treader.onload = function () {\n\t\t\t\t\tvar image = new Image();\n\t\t\t\t\timage.onload = function() {\n\t\t\t\t\t\tself.resize(image);\n\t\t\t\t\t};\n\t\t\t\t\timage.src = reader.result;\n\t\t\t\t};\n\t\t\t\tvar file = e.originalEvent.dataTransfer.files[0];\n\t\t\t\tname = file.name;\n\t\t\t\treader.readAsDataURL(file);\n\t\t\t}\n\t\t});\n\t};\n\n\tself.upload = function(base64) {\n\t\tif (base64) {\n\t\t\tvar data = (new Function('base64', 'filename', 'return ' + config.schema))(base64, name);\n\t\t\tSETTER('loading', 'show');\n\t\t\tAJAX('POST ' + config.url.env(true), data, function(response, err) {\n\t\t\t\tSETTER('loading', 'hide', 100);\n\t\t\t\tif (err) {\n\t\t\t\t\tSETTER('snackbar', 'warning', err.toString());\n\t\t\t\t} else {\n\t\t\t\t\tself.change(true);\n\t\t\t\t\tself.set(response);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t};\n\n\tself.setter = function(value) {\n\t\timg.attr('src', value ? value : empty);\n\t};\n});\n\nCOMPONENT('features', 'height:37', function(self, config) {\n\n\tvar container, timeout, input, search, scroller = null;\n\tvar is = false, results = false, selectedindex = 0, resultscount = 0;\n\n\tself.oldsearch = '';\n\tself.items = null;\n\tself.template = Tangular.compile('<li data-search=\"{{ $.search }}\" data-index=\"{{ $.index }}\"{{ if selected }} class=\"selected\"{{ fi }}>{{ if icon }}<i class=\"fa fa-{{ icon }}\"></i>{{ fi }}{{ name | raw }}</li>');\n\tself.callback = null;\n\tself.readonly();\n\tself.singleton();\n\tself.nocompile();\n\n\tself.configure = function(key, value, init) {\n\t\tif (init)\n\t\t\treturn;\n\t\tswitch (key) {\n\t\t\tcase 'placeholder':\n\t\t\t\tself.find('input').prop('placeholder', value);\n\t\t\t\tbreak;\n\t\t}\n\t};\n\n\tself.make = function() {\n\n\t\tself.aclass('ui-features-layer hidden');\n\t\tself.append('<div class=\"ui-features\"><div class=\"ui-features-search\"><span><i class=\"fa fa-search\"></i></span><div><input type=\"text\" placeholder=\"{0}\" class=\"ui-features-search-input\" /></div></div><div class=\"ui-features-container\"><ul></ul></div></div>'.format(config.placeholder));\n\n\t\tcontainer = self.find('ul');\n\t\tinput = self.find('input');\n\t\tsearch = self.find('.ui-features');\n\t\tscroller = self.find('.ui-features-container');\n\n\t\tself.event('touchstart mousedown', 'li[data-index]', function(e) {\n\t\t\tself.callback && self.callback(self.items[+this.getAttribute('data-index')]);\n\t\t\tself.hide();\n\t\t\te.preventDefault();\n\t\t\te.stopPropagation();\n\t\t});\n\n\t\t$(document).on('touchstart mousedown', function(e) {\n\t\t\tis && !$(e.target).hclass('ui-features-search-input') && self.hide(0);\n\t\t});\n\n\t\t$(window).on('resize', function() {\n\t\t\tis && self.hide(0);\n\t\t});\n\n\t\tself.event('keydown', 'input', function(e) {\n\t\t\tvar o = false;\n\t\t\tswitch (e.which) {\n\t\t\t\tcase 27:\n\t\t\t\t\to = true;\n\t\t\t\t\tself.hide();\n\t\t\t\t\tbreak;\n\t\t\t\tcase 13:\n\t\t\t\t\to = true;\n\t\t\t\t\tvar sel = self.find('li.selected');\n\t\t\t\t\tif (sel.length && self.callback)\n\t\t\t\t\t\tself.callback(self.items[+sel.attr('data-index')]);\n\t\t\t\t\tself.hide();\n\t\t\t\t\tbreak;\n\t\t\t\tcase 38: // up\n\t\t\t\t\to = true;\n\t\t\t\t\tselectedindex--;\n\t\t\t\t\tif (selectedindex < 0)\n\t\t\t\t\t\tselectedindex = 0;\n\t\t\t\t\telse\n\t\t\t\t\t\tself.move();\n\t\t\t\t\tbreak;\n\t\t\t\tcase 40: // down\n\t\t\t\t\to = true;\n\t\t\t\t\tselectedindex++ ;\n\t\t\t\t\tif (selectedindex >= resultscount)\n\t\t\t\t\t\tselectedindex = resultscount;\n\t\t\t\t\telse\n\t\t\t\t\t\tself.move();\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (o && results) {\n\t\t\t\te.preventDefault();\n\t\t\t\te.stopPropagation();\n\t\t\t}\n\t\t});\n\n\t\tself.event('keyup', 'input', function() {\n\t\t\tsetTimeout2(self.id, self.search, 100, null, this.value);\n\t\t});\n\t};\n\n\tself.search = function(value) {\n\n\t\tif (!value) {\n\t\t\tif (self.oldsearch === value)\n\t\t\t\treturn;\n\t\t\tself.oldsearch = value;\n\t\t\tselectedindex = 0;\n\t\t\tresults = true;\n\t\t\tresultscount = self.items.length;\n\t\t\tcontainer.find('li').rclass('hidden selected');\n\t\t\tself.move();\n\t\t\treturn;\n\t\t}\n\n\t\tif (self.oldsearch === value)\n\t\t\treturn;\n\n\t\tself.oldsearch = value;\n\t\tvalue = value.toSearch().split(' ');\n\t\tresults = false;\n\t\tresultscount = 0;\n\t\tselectedindex = 0;\n\n\t\tcontainer.find('li').each(function() {\n\t\t\tvar el = $(this);\n\t\t\tvar val = el.attr('data-search');\n\t\t\tvar h = false;\n\n\t\t\tfor (var i = 0; i < value.length; i++) {\n\t\t\t\tif (val.indexOf(value[i]) === -1) {\n\t\t\t\t\th = true;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (!h) {\n\t\t\t\tresults = true;\n\t\t\t\tresultscount++;\n\t\t\t}\n\n\t\t\tel.tclass('hidden', h);\n\t\t\tel.rclass('selected');\n\t\t});\n\t\tself.move();\n\t};\n\n\tself.move = function() {\n\t\tvar counter = 0;\n\t\tvar h = scroller.css('max-height').parseInt();\n\n\t\tcontainer.find('li').each(function() {\n\t\t\tvar el = $(this);\n\t\t\tif (el.hclass('hidden'))\n\t\t\t\treturn;\n\t\t\tvar is = selectedindex === counter;\n\t\t\tel.tclass('selected', is);\n\t\t\tif (is) {\n\t\t\t\tvar t = (config.height * counter) - config.height;\n\t\t\t\tif ((t + config.height * 5) > h)\n\t\t\t\t\tscroller.scrollTop(t);\n\t\t\t\telse\n\t\t\t\t\tscroller.scrollTop(0);\n\t\t\t}\n\t\t\tcounter++;\n\t\t});\n\t};\n\n\tself.show = function(items, callback) {\n\n\t\tif (is) {\n\t\t\tclearTimeout(timeout);\n\t\t\tself.hide(0);\n\t\t\treturn;\n\t\t}\n\n\t\tvar type = typeof(items);\n\t\tvar item;\n\n\t\tif (type === 'string')\n\t\t\titems = self.get(items);\n\n\t\tif (!items) {\n\t\t\tself.hide(0);\n\t\t\treturn;\n\t\t}\n\n\t\tself.items = items;\n\t\tself.callback = callback;\n\t\tresults = true;\n\t\tresultscount = self.items.length;\n\n\t\tinput.val('');\n\n\t\tvar builder = [];\n\t\tvar indexer = {};\n\n\t\tfor (var i = 0, length = items.length; i < length; i++) {\n\t\t\titem = items[i];\n\t\t\tindexer.index = i;\n\t\t\tindexer.search = (item.name + ' ' + (item.keywords || '')).trim().toSearch();\n\t\t\t!item.value && (item.value = item.name);\n\t\t\tbuilder.push(self.template(item, indexer));\n\t\t}\n\n\t\tcontainer.html(builder);\n\n\t\tvar W = $(window);\n\t\tvar top = ((W.height() / 2) - (search.height() / 2)) - scroller.css('max-height').parseInt();\n\t\tvar options = { top: top, left: (W.width() / 2) - (search.width() / 2) };\n\n\t\tsearch.css(options);\n\t\tself.move();\n\n\t\tif (is)\n\t\t\treturn;\n\n\t\tself.rclass('hidden');\n\n\t\tsetTimeout(function() {\n\t\t\tself.aclass('ui-features-visible');\n\t\t}, 100);\n\n\t\t!isMOBILE && setTimeout(function() {\n\t\t\tinput.focus();\n\t\t}, 500);\n\n\t\tis = true;\n\t\t$('html,body').aclass('ui-features-noscroll');\n\t};\n\n\tself.hide = function(sleep) {\n\t\tif (!is)\n\t\t\treturn;\n\t\tclearTimeout(timeout);\n\t\ttimeout = setTimeout(function() {\n\t\t\tself.aclass('hidden').rclass('ui-features-visible');\n\t\t\tself.callback = null;\n\t\t\tself.target = null;\n\t\t\tis = false;\n\t\t\t$('html,body').rclass('ui-features-noscroll');\n\t\t}, sleep ? sleep : 100);\n\t};\n});\n\nCOMPONENT('listing', 'pages:3;count:20', function(self, config) {\n\n\tvar container, paginate, current, items, pages = 0;\n\tvar layout;\n\n\tself.readonly();\n\tself.nocompile();\n\n\tself.make = function() {\n\n\t\tself.find('script').each(function(index) {\n\t\t\tvar T =  Tangular.compile(this.innerHTML);\n\t\t\tif (index)\n\t\t\t\tlayout = T;\n\t\t\telse\n\t\t\t\tself.template = T;\n\t\t});\n\n\t\tself.aclass('ui-listing');\n\t\tself.html('<div class=\"ui-listing-container\"></div><div class=\"ui-listing-paginate\"></div>');\n\t\tcontainer = self.find('.ui-listing-container');\n\t\tpaginate = self.find('.ui-listing-paginate');\n\t\tpaginate.on('click', 'button', function() {\n\t\t\tvar index = $(this).attrd('index');\n\t\t\tswitch (index) {\n\t\t\t\tcase '+':\n\t\t\t\t\tindex = current + 1;\n\t\t\t\t\tif (index > pages)\n\t\t\t\t\t\tindex = 1;\n\t\t\t\t\tbreak;\n\t\t\t\tcase '-':\n\t\t\t\t\tindex = current - 1;\n\t\t\t\t\tif (index < 1)\n\t\t\t\t\t\tindex = pages;\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tindex = +index;\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\tself.page(index);\n\t\t});\n\t};\n\n\tself.page = function(index) {\n\n\t\tvar builder = [];\n\t\tvar arr = items.takeskip(config.count, (index - 1) * config.count);\n\t\tvar g = { count: items.length, page: index, pages: pages };\n\n\t\tfor (var i = 0; i < arr.length; i++) {\n\t\t\tg.index = i;\n\t\t\tbuilder.push(self.template(arr[i], g));\n\t\t}\n\n\t\tcurrent = index;\n\t\tself.paginate(items.length, index);\n\t\tcontainer.html(layout ? layout({ page: index, pages: pages, body: builder.join(''), count: items.length }) : builder.join(''));\n\t};\n\n\tself.paginate = function(count, page) {\n\n\t\tvar max = config.pages;\n\t\tvar half = Math.ceil(max / 2);\n\n\t\tpages = Math.ceil(count / config.count);\n\n\t\tvar pfrom = page - half;\n\t\tvar pto = page + half;\n\t\tvar plus = 0;\n\n\t\tif (pfrom <= 0) {\n\t\t\tplus = Math.abs(pfrom);\n\t\t\tpfrom = 1;\n\t\t\tpto += plus;\n\t\t}\n\n\t\tif (pto >= pages) {\n\t\t\tpto = pages;\n\t\t\tpfrom = pages - max;\n\t\t}\n\n\t\tif (pfrom <= 0)\n\t\t\tpfrom = 1;\n\n\t\tif (page < half + 1) {\n\t\t\tpto++;\n\t\t\tif (pto > pages)\n\t\t\t\tpto--;\n\t\t}\n\n\t\tif (page < 2) {\n\t\t\tvar template = '<button data-index=\"{0}\"><i class=\"fa fa-caret-{1}\"></i></button>';\n\t\t\tvar builder = [];\n\t\t\tbuilder.push(template.format('-', 'left'));\n\n\t\t\tfor (var i = pfrom; i < pto + 1; i++)\n\t\t\t\tbuilder.push('<button class=\"ui-listing-page\" data-index=\"{0}\">{0}</button>'.format(i));\n\n\t\t\tbuilder.push(template.format('+', 'right'));\n\t\t\tpaginate.html(builder.join(''));\n\t\t} else {\n\n\t\t\tvar max = half * 2 + 1;\n\t\t\tvar cur = (pto - pfrom) + 1;\n\n\t\t\tif (max > cur && pages > config.pages && pfrom > 1)\n\t\t\t\tpfrom--;\n\n\t\t\tpaginate.find('.ui-listing-page[data-index]').each(function(index) {\n\t\t\t\tvar page = pfrom + index;\n\t\t\t\t$(this).attrd('index', page).html(page);\n\t\t\t});\n\n\t\t}\n\n\t\tpaginate.find('.selected').rclass('selected');\n\t\tpaginate.find('.ui-listing-page[data-index=\"{0}\"]'.format(page)).aclass('selected');\n\t\tpaginate.tclass('hidden', pages < 2);\n\t\tself.tclass('hidden', count === 0);\n\t};\n\n\tself.setter = function(value) {\n\t\tif (value) {\n\t\t\titems = value;\n\t\t\tself.page(1);\n\t\t} else {\n\t\t\titems = null;\n\t\t\tcontainer.empty();\n\t\t\tpaginate.empty();\n\t\t}\n\t};\n});\n\nCOMPONENT('autocomplete', 'height:200', function(self, config) {\n\n\tvar container, old, onSearch, searchtimeout, searchvalue, blurtimeout, onCallback, datasource, offsetter, scroller;\n\tvar is = false;\n\tvar margin = {};\n\tvar prev;\n\tvar skipmouse = false;\n\n\tself.template = Tangular.compile('<li{{ if index === 0 }} class=\"selected\"{{ fi }} data-index=\"{{ index }}\"><span>{{ name }}</span><span>{{ type }}</span></li>');\n\tself.readonly();\n\tself.singleton();\n\tself.nocompile();\n\n\tself.make = function() {\n\t\tself.aclass('ui-autocomplete-container hidden');\n\t\tself.html('<div class=\"ui-autocomplete\"><ul></ul></div>');\n\n\t\tscroller = self.find('.ui-autocomplete');\n\t\tcontainer = self.find('ul');\n\n\t\tself.event('click', 'li', function(e) {\n\t\t\te.preventDefault();\n\t\t\te.stopPropagation();\n\t\t\tif (onCallback) {\n\t\t\t\tvar val = datasource[+$(this).attrd('index')];\n\t\t\t\tif (typeof(onCallback) === 'string')\n\t\t\t\t\tSET(onCallback, val.value === undefined ? val.name : val.value);\n\t\t\t\telse\n\t\t\t\t\tonCallback(val, old);\n\t\t\t}\n\t\t\tself.visible(false);\n\t\t});\n\n\t\tself.event('mouseenter mouseleave', 'li', function(e) {\n\t\t\tif (!skipmouse) {\n\t\t\t\tprev && prev.rclass('selected');\n\t\t\t\tprev = $(this).tclass('selected', e.type === 'mouseenter');\n\t\t\t}\n\t\t});\n\n\t\t$(document).on('click', function() {\n\t\t\tis && self.visible(false);\n\t\t});\n\n\t\t$(window).on('resize', function() {\n\t\t\tself.resize();\n\t\t});\n\t};\n\n\tself.prerender = function(value) {\n\t\tself.render(value);\n\t};\n\n\tself.configure = function(name, value) {\n\t\tswitch (name) {\n\t\t\tcase 'height':\n\t\t\t\tvalue && scroller.css('max-height', value);\n\t\t\t\tbreak;\n\t\t}\n\t};\n\n\tfunction keydown(e) {\n\t\tvar c = e.which;\n\t\tvar input = this;\n\n\t\tif (c !== 38 && c !== 40 && c !== 13) {\n\t\t\tif (c !== 8 && c < 32)\n\t\t\t\treturn;\n\t\t\tclearTimeout(searchtimeout);\n\t\t\tsearchtimeout = setTimeout(function() {\n\t\t\t\tvar val = input.value;\n\t\t\t\tif (!val)\n\t\t\t\t\treturn self.render(EMPTYARRAY);\n\t\t\t\tif (searchvalue === val)\n\t\t\t\t\treturn;\n\t\t\t\tsearchvalue = val;\n\t\t\t\tself.resize();\n\t\t\t\tonSearch(val, self.prerender);\n\t\t\t}, 200);\n\t\t\treturn;\n\t\t}\n\n\t\tif (!datasource || !datasource.length)\n\t\t\treturn;\n\n\t\tvar current = container.find('.selected');\n\t\tif (c === 13) {\n\t\t\tif (prev) {\n\t\t\t\tprev = null;\n\t\t\t\tself.visible(false);\n\t\t\t\tif (current.length) {\n\t\t\t\t\tif (onCallback) {\n\t\t\t\t\t\tvar val = datasource[+current.attrd('index')];\n\t\t\t\t\t\tif (typeof(onCallback) === 'string')\n\t\t\t\t\t\t\tSET(onCallback, val.value === undefined ? val.name : val.value);\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tonCallback(val, old);\n\t\t\t\t\t}\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\te.stopPropagation();\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\te.preventDefault();\n\t\te.stopPropagation();\n\n\t\tif (current.length) {\n\t\t\tcurrent.rclass('selected');\n\t\t\tcurrent = c === 40 ? current.next() : current.prev();\n\t\t}\n\n\t\tskipmouse = true;\n\t\t!current.length && (current = self.find('li:{0}-child'.format(c === 40 ? 'first' : 'last')));\n\t\tprev && prev.rclass('selected');\n\t\tprev = current.aclass('selected');\n\t\tvar index = +current.attrd('index');\n\t\tvar h = current.innerHeight();\n\t\tvar offset = ((index + 1) * h) + (h * 2);\n\t\tscroller.prop('scrollTop', offset > config.height ? offset - config.height : 0);\n\t\tsetTimeout2(self.ID + 'skipmouse', function() {\n\t\t\tskipmouse = false;\n\t\t}, 100);\n\t}\n\n\tfunction blur() {\n\t\tclearTimeout(blurtimeout);\n\t\tblurtimeout = setTimeout(function() {\n\t\t\tself.visible(false);\n\t\t}, 300);\n\t}\n\n\tself.visible = function(visible) {\n\t\tclearTimeout(blurtimeout);\n\t\tself.tclass('hidden', !visible);\n\t\tis = visible;\n\t};\n\n\tself.resize = function() {\n\n\t\tif (!offsetter || !old)\n\t\t\treturn;\n\n\t\tvar offset = offsetter.offset();\n\t\toffset.top += offsetter.height();\n\t\toffset.width = offsetter.width();\n\n\t\tif (margin.left)\n\t\t\toffset.left += margin.left;\n\t\tif (margin.top)\n\t\t\toffset.top += margin.top;\n\t\tif (margin.width)\n\t\t\toffset.width += margin.width;\n\n\t\tself.css(offset);\n\t};\n\n\tself.attach = function(input, search, callback, left, top, width) {\n\t\tself.attachelement(input, input, search, callback, left, top, width);\n\t};\n\n\tself.attachelement = function(element, input, search, callback, left, top, width) {\n\n\t\tif (typeof(callback) === 'number') {\n\t\t\twidth = left;\n\t\t\tleft = top;\n\t\t\ttop = callback;\n\t\t\tcallback = null;\n\t\t}\n\n\t\tclearTimeout(searchtimeout);\n\n\t\tif (input.setter)\n\t\t\tinput = input.find('input');\n\t\telse\n\t\t\tinput = $(input);\n\n\t\tif (input[0].tagName !== 'INPUT') {\n\t\t\tinput = input.find('input');\n\t\t}\n\n\t\tif (element.setter) {\n\t\t\tif (!callback)\n\t\t\t\tcallback = element.path;\n\t\t\telement = element.element;\n\t\t}\n\n\t\tif (old) {\n\t\t\told.removeAttr('autocomplete');\n\t\t\told.off('blur', blur);\n\t\t\told.off('keydown', keydown);\n\t\t}\n\n\t\tinput.on('keydown', keydown);\n\t\tinput.on('blur', blur);\n\t\tinput.attr({ 'autocomplete': 'off' });\n\n\t\told = input;\n\t\tmargin.left = left;\n\t\tmargin.top = top;\n\t\tmargin.width = width;\n\n\t\toffsetter = $(element);\n\t\tself.resize();\n\t\tself.refresh();\n\t\tsearchvalue = '';\n\t\tonSearch = search;\n\t\tonCallback = callback;\n\t\tself.visible(false);\n\t};\n\n\tself.render = function(arr) {\n\n\t\tdatasource = arr;\n\n\t\tif (!arr || !arr.length) {\n\t\t\tself.visible(false);\n\t\t\treturn;\n\t\t}\n\n\t\tvar builder = [];\n\t\tfor (var i = 0, length = arr.length; i < length; i++) {\n\t\t\tvar obj = arr[i];\n\t\t\tobj.index = i;\n\t\t\tif (!obj.name)\n\t\t\t\tobj.name = obj.text;\n\t\t\tbuilder.push(self.template(obj));\n\t\t}\n\n\t\tcontainer.empty().append(builder.join(''));\n\t\tskipmouse = true;\n\n\t\tsetTimeout(function() {\n\t\t\tscroller.prop('scrollTop', 0);\n\t\t\tskipmouse = false;\n\t\t}, 100);\n\n\t\tprev = container.find('.selected');\n\t\tself.visible(true);\n\t};\n});\n\nCOMPONENT('avatar', function(self) {\n\n\tvar backgrounds = '#1abc9c,#2ecc71,#3498db,#9b59b6,#34495e,#16a085,#2980b9,#8e44ad,#2c3e50,#f1c40f,#e67e22,#e74c3c,#d35400,#c0392b'.split(',');\n\tvar themes = {};\n\n\tself.readonly();\n\tself.singleton();\n\n\twindow.avatarerror = function(image) {\n\t\tvar img = $(image);\n\t\tvar el = img.parent()[0];\n\t\tel.$avatar = false;\n\t\tel.$avatarerror = true;\n\t\tel = $(el);\n\t\tel.attr('title', img.attr('title'));\n\t\tself.create(el);\n\t};\n\n\tself.rebind = function(el) {\n\t\tvar jq = el ? el.find('.avatar') : $('.avatar');\n\t\tjq.each(function() {\n\t\t\t!this.$avatar && self.create($(this));\n\t\t});\n\t};\n\n\tself.create = function(el) {\n\n\t\tvar theme = el.attrd('a') || el.attrd('avatar') || 'default';\n\t\tvar options = themes[theme];\n\t\tif (!options)\n\t\t\treturn false;\n\n\t\tvar url = el.attrd('a-url') || el.attrd('avatar-url');\n\t\tvar dom = el[0];\n\t\tvar name = dom.$avatarerror ? el.attr('title') : el.text();\n\n\t\tdom.$avatar = true;\n\n\t\tif (dom.$avatarerror) {\n\t\t\turl = '';\n\t\t} else {\n\t\t\tvar cls = el.attrd('a-class') || el.attrd('avatar-class') || options.class;\n\t\t\tcls && el.tclass(cls);\n\t\t}\n\n\t\tel.aclass('ui-avatar-theme-' + theme);\n\n\t\tif (url) {\n\t\t\tel.html('<img src=\"{0}\" alt=\"{1}\" title=\"{1}\" border=\"0\" onerror=\"avatarerror(this)\" />'.format(url, name));\n\t\t} else {\n\n\t\t\tvar arr = name.trim().split(' ');\n\t\t\tvar initials = ((arr[0] || '').substring(0, 1) + (arr[1] || '').substring(0, 1)).toUpperCase();\n\n\t\t\tvar css = {};\n\t\t\tvar can = false;\n\n\t\t\tif (!options.background) {\n\t\t\t\tcss.background = backgrounds[name.length % backgrounds.length];\n\t\t\t\tcan = true;\n\t\t\t}\n\n\t\t\tif (!options.color) {\n\t\t\t\tcan = true;\n\t\t\t\tcss.color = self.colorize(backgrounds[name.length % backgrounds.length], options.lighten);\n\t\t\t}\n\n\t\t\tcan && el.css(css);\n\t\t\tel.attr('title', name);\n\t\t\tel.html(initials);\n\t\t}\n\t};\n\n\tself.register = function(id, options) {\n\t\toptions = options.parseConfig('lighten:80;size:50;radius:100;weight:bold;font:Arial');\n\t\tthemes[id] = options;\n\t\tvar builder = [];\n\t\tvar name = '.ui-avatar-theme-' + id;\n\t\tbuilder.push('display:block;width:{0}px;height:{0}px;text-align:center;vertical-align:middle;font-style:normal;font-size:{1}px;line-height:{2}px'.format(options.size, Math.floor(options.size / 2.5), (options.size + Math.floor(options.size / 20))));\n\t\toptions.radius && builder.push('border-radius:{0}px'.format(options.radius));\n\t\toptions.weight && builder.push('font-weight:' + options.weight);\n\t\toptions.font && builder.push('font-family:' + options.font);\n\t\toptions.background && builder.push('background:' + options.background);\n\t\toptions.weight && builder.push('font-weight:{0}'.format(options.weight));\n\t\toptions.color && builder.push('color:' + options.color);\n\t\tvar css = name + '{' + builder.join(';') + '}';\n\t\tbuilder = [];\n\t\tbuilder.push('width:{0}px;height:{0}px;'.format(options.size));\n\t\toptions.radius && builder.push('border-radius:{0}px'.format(options.radius));\n\t\tcss += '\\n' + name + ' img{' + builder.join(';') + '}';\n\t\tCSS(css, 'avatar-' + id);\n\t\tsetTimeout2(self.id + 'rebind', self.rebind, 100, 5);\n\t};\n\n\tself.refresh = self.rebind;\n\n\tself.make = function() {\n\t\tself.register('default', '');\n\t\tself.on('component', function(component) {\n\t\t\tsetTimeout2(self._id, function() {\n\t\t\t\tcomponent.element && self.rebind(component.element);\n\t\t\t}, 150);\n\t\t});\n\t\tsetTimeout2(self._id + 'rebind', self.rebind, 100, 5);\n\t};\n\n\t// Thank to Chris Coyier (https://css-tricks.com/snippets/javascript/lighten-darken-color/)\n\t// LightenDarkenColor\n\tself.colorize = function(col, amt) {\n\t\tvar pound = false;\n\t\tif (col[0] == '#') {\n\t\t\tcol = col.slice(1);\n\t\t\tpound = true;\n\t\t}\n\t\tvar num = parseInt(col,16);\n\t\tvar r = (num >> 16) + amt;\n\t\tif (r > 255)\n\t\t\tr = 255;\n\t\telse if (r < 0) r = 0;\n\t\tvar b = ((num >> 8) & 0x00FF) + amt;\n\t\tif (b > 255)\n\t\t\tb = 255;\n\t\telse if (b < 0)\n\t\t\tb = 0;\n\t\tvar g = (num & 0x0000FF) + amt;\n\t\tif (g > 255)\n\t\t\tg = 255;\n\t\telse if (g < 0)\n\t\t\tg = 0;\n\t\treturn (pound ? '#': '') + (g | (b << 8) | (r << 16)).toString(16);\n\t};\n});\n\nCOMPONENT('importer', function(self, config) {\n\n\tvar init = false;\n\tvar clid = null;\n\n\tself.readonly();\n\tself.setter = function(value) {\n\n\t\tif (config.if !== value) {\n\t\t\tif (config.cleaner && init && !clid)\n\t\t\t\tclid = setTimeout(self.clean, config.cleaner * 60000);\n\t\t\treturn;\n\t\t}\n\n\t\tif (clid) {\n\t\t\tclearTimeout(clid);\n\t\t\tclid = null;\n\t\t}\n\n\t\tif (init) {\n\t\t\tconfig.reload && EXEC(config.reload);\n\t\t\treturn;\n\t\t}\n\n\t\tinit = true;\n\t\tself.import(config.url, function() {\n\t\t\tconfig.reload && EXEC(config.reload);\n\t\t});\n\t};\n\n\tself.clean = function() {\n\t\tconfig.clean && EXEC(config.clean);\n\t\tsetTimeout(function() {\n\t\t\tself.empty();\n\t\t\tinit = false;\n\t\t\tclid = null;\n\t\t}, 1000);\n\t};\n});\n\nCOMPONENT('part', 'hide:true', function(self, config) {\n\n\tvar init = false;\n\tvar clid = null;\n\n\tself.readonly();\n\tself.setter = function(value) {\n\n\t\tif (config.if !== value) {\n\t\t\tconfig.hidden && !self.hclass('hidden') && EXEC(config.hidden);\n\t\t\tconfig.hide && self.aclass('hidden');\n\t\t\tif (config.cleaner && init && !clid)\n\t\t\t\tclid = setTimeout(self.clean, config.cleaner * 60000);\n\t\t\treturn;\n\t\t}\n\n\t\tconfig.hide && self.rclass('hidden');\n\n\t\tif (self.element[0].hasChildNodes()) {\n\n\t\t\tif (clid) {\n\t\t\t\tclearTimeout(clid);\n\t\t\t\tclid = null;\n\t\t\t}\n\n\t\t\tconfig.reload && EXEC(config.reload);\n\t\t\tconfig.default && DEFAULT(config.default, true);\n\n\t\t} else {\n\t\t\tSETTER('loading', 'show');\n\t\t\tsetTimeout(function() {\n\t\t\t\tself.import(config.url, function() {\n\t\t\t\t\tif (!init) {\n\t\t\t\t\t\tconfig.init && EXEC(config.init);\n\t\t\t\t\t\tinit = true;\n\t\t\t\t\t}\n\t\t\t\t\tconfig.reload && EXEC(config.reload);\n\t\t\t\t\tconfig.default && DEFAULT(config.default, true);\n\t\t\t\t\tSETTER('loading', 'hide', 500);\n\t\t\t\t});\n\t\t\t}, 200);\n\t\t}\n\t};\n\n\tself.clean = function() {\n\t\tif (self.hclass('hidden')) {\n\t\t\tconfig.clean && EXEC(config.clean);\n\t\t\tsetTimeout(function() {\n\t\t\t\tself.element.empty();\n\t\t\t\tinit = false;\n\t\t\t\tclid = null;\n\t\t\t\tsetTimeout(FREE, 1000);\n\t\t\t}, 1000);\n\t\t}\n\t};\n});\n\nCOMPONENT('window', function(self, config) {\n\n\tvar W = window;\n\n\tif (!W.$$window) {\n\n\t\tW.$$window_level = W.$$window_level || 1;\n\t\tW.$$window = true;\n\n\t\t$(document).on('click', '.ui-window-button-close', function() {\n\t\t\tSET($(this).attrd('path'), '');\n\t\t});\n\n\t\t$(window).on('resize', function() {\n\t\t\tSETTER('window', 'resize');\n\t\t});\n\t}\n\n\tself.readonly();\n\n\tself.hide = function() {\n\t\tself.set('');\n\t};\n\n\tself.resize = function() {\n\t\tvar el = self.find('.ui-window-body');\n\t\tel.height(WH - self.find('.ui-window-header').height());\n\t};\n\n\tself.make = function() {\n\t\t$(document.body).append('<div id=\"{0}\" class=\"hidden ui-window-container\"><div class=\"ui-window\"><div data-bind=\"@config__change .ui-window-icon:@icon__html span:value.title\" class=\"ui-window-title\"><button class=\"ui-window-button-close{2}\" data-path=\"{1}\"><i class=\"fa fa-times\"></i></button><i class=\"ui-window-icon\"></i><span></span></div><div class=\"ui-window-header\"></div><div class=\"ui-window-body\"></div></div>'.format(self.ID, self.path, config.closebutton == false ? ' hidden' : ''));\n\t\tvar el = $('#' + self.ID);\n\t\tel.find('.ui-window-body')[0].appendChild(self.dom);\n\t\tself.rclass('hidden');\n\t\tself.replace(el);\n\t\tself.find('button').on('click', function() {\n\t\t\tswitch (this.name) {\n\t\t\t\tcase 'cancel':\n\t\t\t\t\tself.hide();\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t});\n\t};\n\n\tself.icon = function(value) {\n\t\tvar el = this.rclass2('fa');\n\t\tvalue.icon && el.aclass('fa fa-' + value.icon);\n\t};\n\n\tself.configure = function(key, value, init) {\n\t\tif (!init) {\n\t\t\tswitch (key) {\n\t\t\t\tcase 'closebutton':\n\t\t\t\t\tself.find('.ui-window-button-close').tclass(value !== true);\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t};\n\n\tself.setter = function(value) {\n\n\t\tsetTimeout2('ui-window-noscroll', function() {\n\t\t\t$('html').tclass('ui-window-noscroll', !!$('.ui-window-container').not('.hidden').length);\n\t\t}, 50);\n\n\t\tvar isHidden = value !== config.if;\n\n\t\tif (self.hclass('hidden') === isHidden)\n\t\t\treturn;\n\n\t\tsetTimeout2('windowreflow', function() {\n\t\t\tEMIT('reflow', self.name);\n\t\t}, 10);\n\n\t\tif (isHidden) {\n\t\t\tself.aclass('hidden');\n\t\t\tself.release(true);\n\t\t\tself.find('.ui-window').rclass('ui-window-animate');\n\t\t\tW.$$window_level--;\n\t\t\treturn;\n\t\t}\n\n\t\tif (W.$$window_level < 1)\n\t\t\tW.$$window_level = 1;\n\n\t\tW.$$window_level++;\n\n\t\tvar body = self.find('.ui-window-body');\n\n\t\tself.css('z-index', W.$$window_level * 11);\n\t\tbody.scrollTop(0);\n\t\tself.rclass('hidden');\n\t\tself.release(false);\n\t\tself.resize();\n\n\t\tconfig.reload && EXEC(config.reload, self);\n\t\tconfig.default && DEFAULT(config.default, true);\n\n\t\tif (!isMOBILE && config.autofocus) {\n\t\t\tvar el = self.find(config.autofocus === true ? 'input[type=\"text\"],select,textarea' : config.autofocus);\n\t\t\tel.length && el[0].focus();\n\t\t}\n\n\t\tsetTimeout(function() {\n\t\t\tbody.scrollTop(0);\n\t\t\tself.find('.ui-window').aclass('ui-window-animate');\n\t\t}, 300);\n\n\t\t// Fixes a problem with freezing of scrolling in Chrome\n\t\tsetTimeout2(self.id, function() {\n\t\t\tself.css('z-index', (W.$$window_level * 10) + 1);\n\t\t}, 500);\n\t};\n});"], "filenames": ["themes/admin/public/ui.js"], "buggy_code_start_loc": [562], "buggy_code_end_loc": [563], "fixing_code_start_loc": [562], "fixing_code_end_loc": [563], "type": "CWE-79", "message": "Total.js CMS 12.0.0 has XSS related to themes/admin/views/index.html (item.message) and themes/admin/public/ui.js (column.format).", "other": {"cve": {"id": "CVE-2019-10260", "sourceIdentifier": "cve@mitre.org", "published": "2019-03-28T17:29:00.567", "lastModified": "2019-03-29T13:48:53.643", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Total.js CMS 12.0.0 has XSS related to themes/admin/views/index.html (item.message) and themes/admin/public/ui.js (column.format)."}, {"lang": "es", "value": "Total.js CMS, en su versi\u00f3n 12.0.0, tiene Cross-Site Scripting (XSS) relacionado con themes/admin/views/index.html (item.message) y themes/admin/public/ui.js (column.format)."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:totaljs:total.js_cms:12.0.0:*:*:*:*:*:*:*", "matchCriteriaId": "89F0FFC8-2C30-4A5D-B37E-BA216ED85C5E"}]}]}], "references": [{"url": "https://github.com/totaljs/cms/commit/75205f93009db3cf8c0b0f4f1fc8ab82d70da8ad", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/totaljs/cms/commit/8b9d7dada998c08d172481d9f0fc0397c4b3c78d", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/totaljs/cms/commit/75205f93009db3cf8c0b0f4f1fc8ab82d70da8ad"}}