{"buggy_code": ["<?php\n/* ====================\n[BEGIN_COT_EXT]\nHooks=module\n[END_COT_EXT]\n==================== */\n\n/**\n * RSS module main\n *\n * @package rss\n * @version 0.9.1\n * @author Cotonti Team\n * @copyright Copyright (c) Cotonti Team 2008-2013\n * @license BSD\n */\n\ndefined('COT_CODE') or die('Wrong URL.');\n\n// Environment setup\ndefine('COT_RSS', true);\n$env['location'] = 'rss';\n\n// Self requirements\nrequire_once cot_langfile('rss', 'module');\n\n// Input import\n$m = cot_import('m', 'G', 'ALP');\n$c = cot_import('c', 'G', 'TXT');\n$m = empty($m) ? \"pages\" : $m;\n\nob_clean();\nheader('Content-type: text/xml; charset=UTF-8');\n$sys['now'] = time();\n\nif ($usr['id'] === 0 && $cache)\n{\n\t$rss_cache = $cache->db->get($m . $c, 'rss');\n\tif ($rss_cache)\n\t{\n\t\techo $rss_cache;\n\t\texit;\n\t}\n}\n\n$rss_title = $cfg['maintitle'];\n$rss_link = $cfg['mainurl'];\n$rss_description = $cfg['subtitle'];\n\n$domain = $sys['domain'];\n$default_mode = true;\n\n/* === Hook === */\nforeach (cot_getextplugins('rss.create') as $pl)\n{\n\tinclude $pl;\n}\n/* ===== */\n\nif ($m == \"topics\")\n{\n\trequire_once cot_incfile('forums', 'module');\n\n\t$default_mode = false;\n\t$topic_id = empty($c) ? 0 : (int) $c;\n\n\t$sql = \"SELECT * FROM $db_forum_topics WHERE ft_id=$topic_id\";\n\t$res = $db->query($sql);\n\tif ($db->affectedRows > 0)\n\t{\n\t\t$row = $res->fetch();\n\t\tif ($row['ft_mode'] == '1')\n\t\t{\n\t\t\tdie('This topic is private'); // TODO: Need translate\n\t\t}\n\n\t\t$rss_title = $domain.\" : \".$row['ft_title'];\n\t\t$rss_description = $L['rss_topic_item_desc'];\n\n\t\t// check forum read permission for guests\n\t\t$forum_id = $row['ft_cat'];\n\t\tif (!cot_auth('forums', $forum_id, 'R'))\n\t\t{\n\t\t\tdie('Not readable for guests'); // TODO: Need translate\n\t\t}\n\n\t\t// get number of posts in topic\n\t\t$sql = \"SELECT COUNT(*) FROM $db_forum_posts WHERE fp_topicid=$topic_id\";\n\t\t$res = $db->query($sql);\n\t\t$totalposts = $res->fetchColumn();\n\n\t\t$sql = \"SELECT * FROM $db_forum_posts WHERE fp_topicid=$topic_id ORDER BY fp_creation DESC LIMIT \".$cfg['rss']['rss_maxitems'];\n\t\t$res = $db->query($sql);\n\t\t$i = 0;\n\t\twhile ($row = $res->fetch())\n\t\t{\n\t\t\t$totalposts--;\n\t\t\t$curpage = $cfg['forums']['maxtopicsperpage'] * floor($totalposts / $cfg['forums']['maxtopicsperpage']);\n\n\t\t\t$post_id = $row['fp_id'];\n\t\t\t$items[$i]['title'] = $row['fp_postername'];\n\t\t\t$items[$i]['description'] = cot_parse_post_text($row['fp_text']);\n\t\t\t$url = cot_url('forums', \"m=posts&q=$topic_id&d=$curpage\", \"#post$post_id\", true);\n\t\t\t$items[$i]['link'] = (strpos($url, '://') === false) ? COT_ABSOLUTE_URL . $url : $url;\n\t\t\t$items[$i]['pubDate'] = cot_date('r', $row['fp_creation']);\n\t\t\t$i++;\n\t\t}\n\t\t$res->closeCursor();\n\t}\n}\nelseif ($m == \"section\")\n{\n\trequire_once cot_incfile('forums', 'module');\n\n\t$default_mode = false;\n\t$forum_cat = empty($c) ? 0 : $c;;\n\n\tif (isset($structure['forums'][$forum_cat]))\n\t{\n\t\t$rss_title = $structure['forums'][$forum_cat]['title'];\n\t\t$rss_description = $structure['forums'][$forum_cat]['desc'];\n\n\t\t$all = cot_structure_children('forums', $forum_cat);\n\t\t$where = \"fp_cat IN ('\".implode(\"', '\", $all).\"')\";\n\n\t\t$sql = \"SELECT * FROM $db_forum_posts WHERE $where ORDER BY fp_creation DESC LIMIT \".$cfg['rss']['rss_maxitems'];\n\t\t$res = $db->query($sql);\n\t\t$i = 0;\n\n\t\tforeach ($res->fetchAll() as $row)\n\t\t{\n\t\t\t$post_id = $row['fp_id'];\n\t\t\t$topic_id = $row['fp_topicid'];\n\n\t\t\t$flag_private = 0;\n\t\t\t$sql = \"SELECT * FROM $db_forum_topics WHERE ft_id=$topic_id\";\n\t\t\t$res2 = $db->query($sql);\n\t\t\t$row2 = $res2->fetch();\n\t\t\t$topic_title = $row2['ft_title'];\n\t\t\tif ($row2['ft_mode'] == '1')\n\t\t\t{\n\t\t\t\t$flag_private = 1;\n\t\t\t}\n\n\t\t\tif (!$flag_private && cot_auth('forums', $forum_cat, 'R'))\n\t\t\t{\n\t\t\t\t//$post_url = ($cfg['plugin']['search']['searchurls'] == 'Single') ? cot_url('forums', 'm=posts&id='.$post_id, \"\", true) : cot_url('forums', 'm=posts&p='.$post_id, '#'.$post_id, true);\n\t\t\t\t$post_url = cot_url('forums', 'm=posts&p='.$post_id, '#'.$post_id, true);\n\t\t\t\t$items[$i]['title'] = $row['fp_postername'].\" - \".$topic_title;\n\t\t\t\t$items[$i]['description'] = cot_parse_post_text($row['fp_text']);\n\t\t\t\t$items[$i]['link'] = (strpos($post_url, '://') === false) ? COT_ABSOLUTE_URL . $post_url : $post_url;;\n\t\t\t\t$items[$i]['pubDate'] = cot_date('r', $row['fp_creation']);\n\t\t\t}\n\n\t\t\t$i++;\n\t\t}\n\t}\n}\nelseif ($m == \"forums\")\n{\n\trequire_once cot_incfile('forums', 'module');\n\n\t$default_mode = false;\n\t$rss_title = $domain.\" : \".$L['rss_allforums_item_title'];\n\t$rss_description = \"\";\n\n\t$sql = \"SELECT * FROM $db_forum_posts ORDER BY fp_creation DESC LIMIT \".$cfg['rss']['rss_maxitems'];\n\t$res = $db->query($sql);\n\t$i = 0;\n\tforeach ($res->fetchAll() as $row)\n\t{\n\t\t$post_id = $row['fp_id'];\n\t\t$topic_id = $row['fp_topicid'];\n\t\t$forum_id = $row['fp_cat'];\n\n\t\t$flag_private = 0;\n\t\t$sql = \"SELECT * FROM $db_forum_topics WHERE ft_id=$topic_id\";\n\t\t$res2 = $db->query($sql);\n\t\t$row2 = $res2->fetch();\n\t\t$topic_title = $row2['ft_title'];\n\t\tif ($row2['ft_mode'] == '1')\n\t\t{\n\t\t\t$flag_private = 1;\n\t\t}\n\n\t\tif (!$flag_private && cot_auth('forums', $forum_id, 'R'))\n\t\t{\n\t\t\t$items[$i]['title'] = $row['fp_postername'].\" - \".$topic_title;\n\t\t\t$items[$i]['description'] = cot_parse_post_text($row['fp_text']);\n\t\t\t$url = cot_url('forums', \"m=posts&p=$post_id\", \"#$post_id\", true);\n\t\t\t$items[$i]['link'] = (strpos($url, '://') === false) ? COT_ABSOLUTE_URL . $url : $url;\n\t\t\t$items[$i]['pubDate'] = cot_date('r', $row['fp_creation']);\n\t\t}\n\n\t\t$i++;\n\t}\n}\nelseif ($default_mode)\n{\n\trequire_once cot_incfile('page', 'module');\n\n\tif (!empty($c))\n\t{\n\t\t$mtch = $structure['page'][$c]['path'].\".\";\n\t\t$mtchlen = mb_strlen($mtch);\n\t\t$catsub = array();\n\t\t$catsub[] = $c;\n\n\t\tforeach ($structure['page'] as $i => $x)\n\t\t{\n\t\t\tif (mb_substr($x['path'], 0, $mtchlen) == $mtch)\n\t\t\t{\n\t\t\t\t$catsub[] = $i;\n\t\t\t}\n\t\t}\n\n\t\t$sql = $db->query(\"SELECT p.*, u.* FROM $db_pages AS p\n\t\t\t\tLEFT JOIN $db_users AS u ON p.page_ownerid = u.user_id\n\t\t\tWHERE page_state=0 AND page_begin <= {$sys['now']} AND (page_expire = 0 OR page_expire > {$sys['now']}) AND page_cat NOT LIKE 'system' AND page_cat IN ('\".implode(\"','\", $catsub).\"')\n\t\t\tORDER BY page_date DESC LIMIT \".$cfg['rss']['rss_maxitems']);\n\t}\n\telse\n\t{\n\t\t$sql = $db->query(\"SELECT p.*, u.* FROM $db_pages AS p\n\t\t\t\tLEFT JOIN $db_users AS u ON p.page_ownerid = u.user_id\n\t\t\tWHERE page_state=0 AND page_begin <= {$sys['now']} AND (page_expire = 0 OR page_expire > {$sys['now']}) AND page_cat NOT LIKE 'system'\n\t\t\tORDER BY page_date DESC LIMIT \".$cfg['rss']['rss_maxitems']);\n\t}\n\t$i = 0;\n\twhile ($row = $sql->fetch())\n\t{\n\t\t$url = (empty($row['page_alias'])) ? cot_url('page', 'c='.$row['page_cat'].'&id='.$row['page_id'], '', true) : cot_url('page', 'c='.$row['page_cat'].'&al='.$row['page_alias'], '', true);\n\n\t\t$items[$i]['title'] = $row['page_title'];\n\t\t$items[$i]['link'] = (strpos($url, '://') === false) ? COT_ABSOLUTE_URL . $url : $url;;\n\t\t$items[$i]['pubDate'] = cot_date('r', $row['page_date']);\n\t\t$items[$i]['description'] = cot_parse_page_text($row['page_text'], $url, $row['page_parser']);\n\t\t$items[$i]['fields'] = cot_generate_pagetags($row);\n\n\t\t$i++;\n\t}\n\t$sql->closeCursor();\n}\n\n$t = new XTemplate(cot_tplfile('rss'));\n$t->assign(array(\n\t'RSS_ENCODING' => $cfg['rss']['rss_charset'],\n\t'RSS_TITLE' => htmlspecialchars($rss_title),\n\t'RSS_LINK' => $rss_link,\n\t'RSS_LANG' => $cfg['defaultlang'],\n\t'RSS_DESCRIPTION' => htmlspecialchars($rss_description),\n\t'RSS_DATE' => cot_fix_pubdate(cot_date(\"r\"))\n));\n\nif (count($items) > 0)\n{\n\tforeach ($items as $item)\n\t{\n\t\t$t->assign(array(\n\t\t\t'RSS_ROW_TITLE' => htmlspecialchars($item['title']),\n\t\t\t'RSS_ROW_DESCRIPTION' => cot_convert_relative_urls($item['description']),\n\t\t\t'RSS_ROW_DATE' => cot_fix_pubdate($item['pubDate']),\n\t\t\t'RSS_ROW_LINK' => $item['link'],\n\t\t\t'RSS_ROW_FIELDS' => $item['fields']\n\t\t));\n\t\t$t->parse('MAIN.ITEM_ROW');\n\t}\n}\n\n/* === Hook === */\nforeach (cot_getextplugins('rss.output') as $pl)\n{\n\tinclude $pl;\n}\n/* ===== */\n\n$t->parse('MAIN');\n$out_rss = $t->text('MAIN');\n\nif ($usr['id'] === 0 && $cache)\n{\n\t$cache->db->store($m . $c, $out_rss, 'rss', $cfg['rss']['rss_timetolive']);\n}\necho $out_rss;\n\nfunction cot_parse_page_text($pag_text, $pag_pageurl, $pag_parser)\n{\n\tglobal $cfg;\n\n\t$pag_text = cot_parse($pag_text, $pag_parser !== 'none', $pag_parser);\n\t$readmore = mb_strpos($pag_text, \"<!--more-->\");\n\tif ($readmore > 0)\n\t{\n\t\t$pag_text = mb_substr($pag_text, 0, $readmore) . ' ';\n\t\t$pag_text .= cot_rc('list_link_more', array('page_url' => $pag_pageurl));\n\t}\n\n\t$newpage = mb_strpos($pag_text, '[newpage]');\n\n\tif ($newpage !== false)\n\t{\n\t\t$pag_text = mb_substr($pag_text, 0, $newpage);\n\t}\n\n\t$pag_text = preg_replace('#\\[title\\](.*?)\\[/title\\][\\s\\r\\n]*(<br />)?#i', '', $pag_text);\n\t$text = $pag_text;\n\tif ((int)$cfg['rss']['rss_pagemaxsymbols'] > 0)\n\t{\n\t\t$text = cot_string_truncate($text, $cfg['rss']['rss_pagemaxsymbols']) . '...';\n\t}\n\treturn $text;\n}\n\nfunction cot_parse_post_text($post_text)\n{\n\tglobal $cfg;\n\n\t$post_text = cot_parse($post_text, $cfg['forums']['markup']);\n\n\tif ((int)$cfg['rss']['rss_postmaxsymbols'] > 0)\n\t{\n\t\t$post_text = cot_string_truncate($post_text, $cfg['rss']['rss_postmaxsymbols']) . '...';\n\t}\n\treturn $post_text;\n}\n\nfunction cot_relative2absolute($matches)\n{\n\tglobal $sys;\n\t$res = $matches[1].$matches[2].'='.$matches[3];\n\tif (preg_match('#^(http|https|ftp)://#', $matches[4]))\n\t{\n\t\t$res .= $matches[4];\n\t}\n\telse\n\t{\n\t\tif ($matches[4][0] == '/')\n\t\t{\n\t\t\t$scheme = $sys['secure'] ? 'https' : 'http';\n\t\t\t$res .= $scheme . '://' . $sys['host'] . $matches[4];\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$res .= COT_ABSOLUTE_URL . $matches[4];\n\t\t}\n\t}\n\t$res .= $matches[5];\n\treturn $res;\n}\n\nfunction cot_convert_relative_urls($text)\n{\n\t$text = preg_replace_callback('#(\\s)(href|src)=(\"|\\')?([^\"\\'\\s>]+)([\"\\'\\s>])#', 'cot_relative2absolute', $text);\n\treturn $text;\n}\n\n/**\n * Fixes timezone in RSS pubdate\n * @global array $usr\n * @param string $pubdate Pubdate generated with cot_date()\n * @return string Corrected pubdate\n */\nfunction cot_fix_pubdate($pubdate)\n{\n\tglobal $usr;\n\t$tz = floatval($usr['timezone']);\n\t$sign = $tz > 0 ? '+' : '-';\n\t$base = intval(abs($tz) * 100);\n\t$tz_str = $sign . str_pad($base, 4, '0', STR_PAD_LEFT);\n\treturn str_replace('+0000', $tz_str, $pubdate);\n}\n"], "fixing_code": ["<?php\n/* ====================\n[BEGIN_COT_EXT]\nHooks=module\n[END_COT_EXT]\n==================== */\n\n/**\n * RSS module main\n *\n * @package rss\n * @version 0.9.1\n * @author Cotonti Team\n * @copyright Copyright (c) Cotonti Team 2008-2013\n * @license BSD\n */\n\ndefined('COT_CODE') or die('Wrong URL.');\n\n// Environment setup\ndefine('COT_RSS', true);\n$env['location'] = 'rss';\n\n// Self requirements\nrequire_once cot_langfile('rss', 'module');\n\n// Input import\n$m = cot_import('m', 'G', 'ALP');\n$c = cot_import('c', 'G', 'TXT');\n$m = empty($m) ? \"pages\" : $m;\n\nob_clean();\nheader('Content-type: text/xml; charset=UTF-8');\n$sys['now'] = time();\n\nif ($usr['id'] === 0 && $cache)\n{\n\t$rss_cache = $cache->db->get($m . $c, 'rss');\n\tif ($rss_cache)\n\t{\n\t\techo $rss_cache;\n\t\texit;\n\t}\n}\n\n$rss_title = $cfg['maintitle'];\n$rss_link = $cfg['mainurl'];\n$rss_description = $cfg['subtitle'];\n\n$domain = $sys['domain'];\n$default_mode = true;\n\n/* === Hook === */\nforeach (cot_getextplugins('rss.create') as $pl)\n{\n\tinclude $pl;\n}\n/* ===== */\n\nif ($m == \"topics\")\n{\n\trequire_once cot_incfile('forums', 'module');\n\n\t$default_mode = false;\n\t$topic_id = empty($c) ? 0 : (int) $c;\n\n\t$sql = \"SELECT * FROM $db_forum_topics WHERE ft_id=$topic_id\";\n\t$res = $db->query($sql);\n\tif ($db->affectedRows > 0)\n\t{\n\t\t$row = $res->fetch();\n\t\tif ($row['ft_mode'] == '1')\n\t\t{\n\t\t\tdie('This topic is private'); // TODO: Need translate\n\t\t}\n\n\t\t$rss_title = $domain.\" : \".$row['ft_title'];\n\t\t$rss_description = $L['rss_topic_item_desc'];\n\n\t\t// check forum read permission for guests\n\t\t$forum_id = $row['ft_cat'];\n\t\tif (!cot_auth('forums', $forum_id, 'R'))\n\t\t{\n\t\t\tdie('Not readable for guests'); // TODO: Need translate\n\t\t}\n\n\t\t// get number of posts in topic\n\t\t$sql = \"SELECT COUNT(*) FROM $db_forum_posts WHERE fp_topicid=$topic_id\";\n\t\t$res = $db->query($sql);\n\t\t$totalposts = $res->fetchColumn();\n\n\t\t$sql = \"SELECT * FROM $db_forum_posts WHERE fp_topicid=$topic_id ORDER BY fp_creation DESC LIMIT \".$cfg['rss']['rss_maxitems'];\n\t\t$res = $db->query($sql);\n\t\t$i = 0;\n\t\twhile ($row = $res->fetch())\n\t\t{\n\t\t\t$totalposts--;\n\t\t\t$curpage = $cfg['forums']['maxtopicsperpage'] * floor($totalposts / $cfg['forums']['maxtopicsperpage']);\n\n\t\t\t$post_id = $row['fp_id'];\n\t\t\t$items[$i]['title'] = $row['fp_postername'];\n\t\t\t$items[$i]['description'] = cot_parse_post_text($row['fp_text']);\n\t\t\t$url = cot_url('forums', \"m=posts&q=$topic_id&d=$curpage\", \"#post$post_id\", true);\n\t\t\t$items[$i]['link'] = (strpos($url, '://') === false) ? COT_ABSOLUTE_URL . $url : $url;\n\t\t\t$items[$i]['pubDate'] = cot_date('r', $row['fp_creation']);\n\t\t\t$i++;\n\t\t}\n\t\t$res->closeCursor();\n\t}\n}\nelseif ($m == \"section\")\n{\n\trequire_once cot_incfile('forums', 'module');\n\n\t$default_mode = false;\n\t$forum_cat = empty($c) ? 0 : $c;;\n\n\tif (isset($structure['forums'][$forum_cat]))\n\t{\n\t\t$rss_title = $structure['forums'][$forum_cat]['title'];\n\t\t$rss_description = $structure['forums'][$forum_cat]['desc'];\n\n\t\t$all = cot_structure_children('forums', $forum_cat);\n\t\t$where = \"fp_cat IN ('\".implode(\"', '\", $all).\"')\";\n\n\t\t$sql = \"SELECT * FROM $db_forum_posts WHERE $where ORDER BY fp_creation DESC LIMIT \".$cfg['rss']['rss_maxitems'];\n\t\t$res = $db->query($sql);\n\t\t$i = 0;\n\n\t\tforeach ($res->fetchAll() as $row)\n\t\t{\n\t\t\t$post_id = $row['fp_id'];\n\t\t\t$topic_id = $row['fp_topicid'];\n\n\t\t\t$flag_private = 0;\n\t\t\t$sql = \"SELECT * FROM $db_forum_topics WHERE ft_id=$topic_id\";\n\t\t\t$res2 = $db->query($sql);\n\t\t\t$row2 = $res2->fetch();\n\t\t\t$topic_title = $row2['ft_title'];\n\t\t\tif ($row2['ft_mode'] == '1')\n\t\t\t{\n\t\t\t\t$flag_private = 1;\n\t\t\t}\n\n\t\t\tif (!$flag_private && cot_auth('forums', $forum_cat, 'R'))\n\t\t\t{\n\t\t\t\t//$post_url = ($cfg['plugin']['search']['searchurls'] == 'Single') ? cot_url('forums', 'm=posts&id='.$post_id, \"\", true) : cot_url('forums', 'm=posts&p='.$post_id, '#'.$post_id, true);\n\t\t\t\t$post_url = cot_url('forums', 'm=posts&p='.$post_id, '#'.$post_id, true);\n\t\t\t\t$items[$i]['title'] = $row['fp_postername'].\" - \".$topic_title;\n\t\t\t\t$items[$i]['description'] = cot_parse_post_text($row['fp_text']);\n\t\t\t\t$items[$i]['link'] = (strpos($post_url, '://') === false) ? COT_ABSOLUTE_URL . $post_url : $post_url;;\n\t\t\t\t$items[$i]['pubDate'] = cot_date('r', $row['fp_creation']);\n\t\t\t}\n\n\t\t\t$i++;\n\t\t}\n\t}\n}\nelseif ($m == \"forums\")\n{\n\trequire_once cot_incfile('forums', 'module');\n\n\t$default_mode = false;\n\t$rss_title = $domain.\" : \".$L['rss_allforums_item_title'];\n\t$rss_description = \"\";\n\n\t$sql = \"SELECT * FROM $db_forum_posts ORDER BY fp_creation DESC LIMIT \".$cfg['rss']['rss_maxitems'];\n\t$res = $db->query($sql);\n\t$i = 0;\n\tforeach ($res->fetchAll() as $row)\n\t{\n\t\t$post_id = $row['fp_id'];\n\t\t$topic_id = $row['fp_topicid'];\n\t\t$forum_id = $row['fp_cat'];\n\n\t\t$flag_private = 0;\n\t\t$sql = \"SELECT * FROM $db_forum_topics WHERE ft_id=$topic_id\";\n\t\t$res2 = $db->query($sql);\n\t\t$row2 = $res2->fetch();\n\t\t$topic_title = $row2['ft_title'];\n\t\tif ($row2['ft_mode'] == '1')\n\t\t{\n\t\t\t$flag_private = 1;\n\t\t}\n\n\t\tif (!$flag_private && cot_auth('forums', $forum_id, 'R'))\n\t\t{\n\t\t\t$items[$i]['title'] = $row['fp_postername'].\" - \".$topic_title;\n\t\t\t$items[$i]['description'] = cot_parse_post_text($row['fp_text']);\n\t\t\t$url = cot_url('forums', \"m=posts&p=$post_id\", \"#$post_id\", true);\n\t\t\t$items[$i]['link'] = (strpos($url, '://') === false) ? COT_ABSOLUTE_URL . $url : $url;\n\t\t\t$items[$i]['pubDate'] = cot_date('r', $row['fp_creation']);\n\t\t}\n\n\t\t$i++;\n\t}\n}\nelseif ($default_mode)\n{\n\trequire_once cot_incfile('page', 'module');\n\n\tif (!empty($c) && isset($structure['page'][$c]))\n\t{\n\t\t$mtch = $structure['page'][$c]['path'].\".\";\n\t\t$mtchlen = mb_strlen($mtch);\n\t\t$catsub = array();\n\t\t$catsub[] = $c;\n\n\t\tforeach ($structure['page'] as $i => $x)\n\t\t{\n\t\t\tif (mb_substr($x['path'], 0, $mtchlen) == $mtch)\n\t\t\t{\n\t\t\t\t$catsub[] = $i;\n\t\t\t}\n\t\t}\n\n\t\t$sql = $db->query(\"SELECT p.*, u.* FROM $db_pages AS p\n\t\t\t\tLEFT JOIN $db_users AS u ON p.page_ownerid = u.user_id\n\t\t\tWHERE page_state=0 AND page_begin <= {$sys['now']} AND (page_expire = 0 OR page_expire > {$sys['now']}) AND page_cat NOT LIKE 'system' AND page_cat IN ('\".implode(\"','\", $catsub).\"')\n\t\t\tORDER BY page_date DESC LIMIT \".$cfg['rss']['rss_maxitems']);\n\t}\n\telse\n\t{\n\t\t$sql = $db->query(\"SELECT p.*, u.* FROM $db_pages AS p\n\t\t\t\tLEFT JOIN $db_users AS u ON p.page_ownerid = u.user_id\n\t\t\tWHERE page_state=0 AND page_begin <= {$sys['now']} AND (page_expire = 0 OR page_expire > {$sys['now']}) AND page_cat NOT LIKE 'system'\n\t\t\tORDER BY page_date DESC LIMIT \".$cfg['rss']['rss_maxitems']);\n\t}\n\t$i = 0;\n\twhile ($row = $sql->fetch())\n\t{\n\t\t$url = (empty($row['page_alias'])) ? cot_url('page', 'c='.$row['page_cat'].'&id='.$row['page_id'], '', true) : cot_url('page', 'c='.$row['page_cat'].'&al='.$row['page_alias'], '', true);\n\n\t\t$items[$i]['title'] = $row['page_title'];\n\t\t$items[$i]['link'] = (strpos($url, '://') === false) ? COT_ABSOLUTE_URL . $url : $url;;\n\t\t$items[$i]['pubDate'] = cot_date('r', $row['page_date']);\n\t\t$items[$i]['description'] = cot_parse_page_text($row['page_text'], $url, $row['page_parser']);\n\t\t$items[$i]['fields'] = cot_generate_pagetags($row);\n\n\t\t$i++;\n\t}\n\t$sql->closeCursor();\n}\n\n$t = new XTemplate(cot_tplfile('rss'));\n$t->assign(array(\n\t'RSS_ENCODING' => $cfg['rss']['rss_charset'],\n\t'RSS_TITLE' => htmlspecialchars($rss_title),\n\t'RSS_LINK' => $rss_link,\n\t'RSS_LANG' => $cfg['defaultlang'],\n\t'RSS_DESCRIPTION' => htmlspecialchars($rss_description),\n\t'RSS_DATE' => cot_fix_pubdate(cot_date(\"r\"))\n));\n\nif (count($items) > 0)\n{\n\tforeach ($items as $item)\n\t{\n\t\t$t->assign(array(\n\t\t\t'RSS_ROW_TITLE' => htmlspecialchars($item['title']),\n\t\t\t'RSS_ROW_DESCRIPTION' => cot_convert_relative_urls($item['description']),\n\t\t\t'RSS_ROW_DATE' => cot_fix_pubdate($item['pubDate']),\n\t\t\t'RSS_ROW_LINK' => $item['link'],\n\t\t\t'RSS_ROW_FIELDS' => $item['fields']\n\t\t));\n\t\t$t->parse('MAIN.ITEM_ROW');\n\t}\n}\n\n/* === Hook === */\nforeach (cot_getextplugins('rss.output') as $pl)\n{\n\tinclude $pl;\n}\n/* ===== */\n\n$t->parse('MAIN');\n$out_rss = $t->text('MAIN');\n\nif ($usr['id'] === 0 && $cache)\n{\n\t$cache->db->store($m . $c, $out_rss, 'rss', $cfg['rss']['rss_timetolive']);\n}\necho $out_rss;\n\nfunction cot_parse_page_text($pag_text, $pag_pageurl, $pag_parser)\n{\n\tglobal $cfg;\n\n\t$pag_text = cot_parse($pag_text, $pag_parser !== 'none', $pag_parser);\n\t$readmore = mb_strpos($pag_text, \"<!--more-->\");\n\tif ($readmore > 0)\n\t{\n\t\t$pag_text = mb_substr($pag_text, 0, $readmore) . ' ';\n\t\t$pag_text .= cot_rc('list_link_more', array('page_url' => $pag_pageurl));\n\t}\n\n\t$newpage = mb_strpos($pag_text, '[newpage]');\n\n\tif ($newpage !== false)\n\t{\n\t\t$pag_text = mb_substr($pag_text, 0, $newpage);\n\t}\n\n\t$pag_text = preg_replace('#\\[title\\](.*?)\\[/title\\][\\s\\r\\n]*(<br />)?#i', '', $pag_text);\n\t$text = $pag_text;\n\tif ((int)$cfg['rss']['rss_pagemaxsymbols'] > 0)\n\t{\n\t\t$text = cot_string_truncate($text, $cfg['rss']['rss_pagemaxsymbols']) . '...';\n\t}\n\treturn $text;\n}\n\nfunction cot_parse_post_text($post_text)\n{\n\tglobal $cfg;\n\n\t$post_text = cot_parse($post_text, $cfg['forums']['markup']);\n\n\tif ((int)$cfg['rss']['rss_postmaxsymbols'] > 0)\n\t{\n\t\t$post_text = cot_string_truncate($post_text, $cfg['rss']['rss_postmaxsymbols']) . '...';\n\t}\n\treturn $post_text;\n}\n\nfunction cot_relative2absolute($matches)\n{\n\tglobal $sys;\n\t$res = $matches[1].$matches[2].'='.$matches[3];\n\tif (preg_match('#^(http|https|ftp)://#', $matches[4]))\n\t{\n\t\t$res .= $matches[4];\n\t}\n\telse\n\t{\n\t\tif ($matches[4][0] == '/')\n\t\t{\n\t\t\t$scheme = $sys['secure'] ? 'https' : 'http';\n\t\t\t$res .= $scheme . '://' . $sys['host'] . $matches[4];\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$res .= COT_ABSOLUTE_URL . $matches[4];\n\t\t}\n\t}\n\t$res .= $matches[5];\n\treturn $res;\n}\n\nfunction cot_convert_relative_urls($text)\n{\n\t$text = preg_replace_callback('#(\\s)(href|src)=(\"|\\')?([^\"\\'\\s>]+)([\"\\'\\s>])#', 'cot_relative2absolute', $text);\n\treturn $text;\n}\n\n/**\n * Fixes timezone in RSS pubdate\n * @global array $usr\n * @param string $pubdate Pubdate generated with cot_date()\n * @return string Corrected pubdate\n */\nfunction cot_fix_pubdate($pubdate)\n{\n\tglobal $usr;\n\t$tz = floatval($usr['timezone']);\n\t$sign = $tz > 0 ? '+' : '-';\n\t$base = intval(abs($tz) * 100);\n\t$tz_str = $sign . str_pad($base, 4, '0', STR_PAD_LEFT);\n\treturn str_replace('+0000', $tz_str, $pubdate);\n}\n"], "filenames": ["modules/rss/rss.php"], "buggy_code_start_loc": [202], "buggy_code_end_loc": [203], "fixing_code_start_loc": [202], "fixing_code_end_loc": [203], "type": "CWE-89", "message": "SQL injection vulnerability in modules/rss/rss.php in Cotonti before 0.9.14 allows remote attackers to execute arbitrary SQL commands via the \"c\" parameter to index.php.", "other": {"cve": {"id": "CVE-2013-4789", "sourceIdentifier": "cve@mitre.org", "published": "2013-08-09T21:55:07.270", "lastModified": "2013-08-13T18:45:17.800", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "SQL injection vulnerability in modules/rss/rss.php in Cotonti before 0.9.14 allows remote attackers to execute arbitrary SQL commands via the \"c\" parameter to index.php."}, {"lang": "es", "value": "Vulnerabilidad de inyecci\u00f3n SQL en modules/rss/rss.php en Cotonti anterior a v0.9.14 permite a atacantes remotos ejecutar comandos SQL a trav\u00e9s del par\u00e1metro \"c\" en index.php."}], "metrics": {"cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:N/C:P/I:P/A:P", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "NONE", "confidentialityImpact": "PARTIAL", "integrityImpact": "PARTIAL", "availabilityImpact": "PARTIAL", "baseScore": 7.5}, "baseSeverity": "HIGH", "exploitabilityScore": 10.0, "impactScore": 6.4, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-89"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:cotonti:cotonti_siena:*:*:*:*:*:*:*:*", "versionEndIncluding": "0.9.13", "matchCriteriaId": "78061E6B-C756-4C40-8F4C-3B4A70E5AC2B"}, {"vulnerable": true, "criteria": "cpe:2.3:a:cotonti:cotonti_siena:0.9.0:*:*:*:*:*:*:*", "matchCriteriaId": "23269789-CF52-4DC9-807E-F5E04F63B8CB"}, {"vulnerable": true, "criteria": "cpe:2.3:a:cotonti:cotonti_siena:0.9.1:*:*:*:*:*:*:*", "matchCriteriaId": "16E15464-62D4-4504-8252-990D8F3FDFA7"}, {"vulnerable": true, "criteria": "cpe:2.3:a:cotonti:cotonti_siena:0.9.2:*:*:*:*:*:*:*", "matchCriteriaId": "9272E568-A979-49B4-A84C-647029C0DC7C"}, {"vulnerable": true, "criteria": "cpe:2.3:a:cotonti:cotonti_siena:0.9.3:*:*:*:*:*:*:*", "matchCriteriaId": "E1313F58-D87B-4A82-B7EE-FDE22C2FF4A6"}, {"vulnerable": true, "criteria": "cpe:2.3:a:cotonti:cotonti_siena:0.9.4:*:*:*:*:*:*:*", "matchCriteriaId": "9CE837A2-35AD-448F-8347-BFE35E051160"}, {"vulnerable": true, "criteria": "cpe:2.3:a:cotonti:cotonti_siena:0.9.5:*:*:*:*:*:*:*", "matchCriteriaId": "C4670284-CC4A-45E5-B4F3-FC42DECF07B7"}, {"vulnerable": true, "criteria": "cpe:2.3:a:cotonti:cotonti_siena:0.9.6:*:*:*:*:*:*:*", "matchCriteriaId": "2FA41BB6-A5B5-4774-B024-2722D48482E8"}, {"vulnerable": true, "criteria": "cpe:2.3:a:cotonti:cotonti_siena:0.9.7:*:*:*:*:*:*:*", "matchCriteriaId": "183420F5-66A6-4FEB-BAB5-2D9CF3AA00C9"}, {"vulnerable": true, "criteria": "cpe:2.3:a:cotonti:cotonti_siena:0.9.8:*:*:*:*:*:*:*", "matchCriteriaId": "C2E37B27-53E3-4B8C-A781-4DF50DAE2838"}, {"vulnerable": true, "criteria": "cpe:2.3:a:cotonti:cotonti_siena:0.9.9:*:*:*:*:*:*:*", "matchCriteriaId": "EB21A94A-38C8-447C-BB3C-736D6A2E2EDF"}, {"vulnerable": true, "criteria": "cpe:2.3:a:cotonti:cotonti_siena:0.9.10:*:*:*:*:*:*:*", "matchCriteriaId": "4E55928F-E10F-4DCE-B2C9-747F16ED9D74"}, {"vulnerable": true, "criteria": "cpe:2.3:a:cotonti:cotonti_siena:0.9.11:*:*:*:*:*:*:*", "matchCriteriaId": "D0B86485-BEB5-40A3-AF00-DA63FC04C6D3"}, {"vulnerable": true, "criteria": "cpe:2.3:a:cotonti:cotonti_siena:0.9.12:*:*:*:*:*:*:*", "matchCriteriaId": "C9A8DA4E-18A1-438F-A776-182C587B06C6"}]}]}], "references": [{"url": "http://www.cotonti.com/forums?m=posts&q=7475", "source": "cve@mitre.org"}, {"url": "http://www.cotonti.com/news/announce/siena_0914_released", "source": "cve@mitre.org", "tags": ["Vendor Advisory"]}, {"url": "http://www.securityfocus.com/bid/61538", "source": "cve@mitre.org"}, {"url": "https://github.com/Cotonti/Cotonti/commit/45eec046391afabb676b62b9201da0cd530360b4", "source": "cve@mitre.org", "tags": ["Exploit", "Patch"]}, {"url": "https://www.htbridge.com/advisory/HTB23164", "source": "cve@mitre.org", "tags": ["Exploit"]}]}, "github_commit_url": "https://github.com/Cotonti/Cotonti/commit/45eec046391afabb676b62b9201da0cd530360b4"}}