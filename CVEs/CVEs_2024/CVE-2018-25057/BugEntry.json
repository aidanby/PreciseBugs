{"buggy_code": ["<?php\n\n$DEFAULT_REDIRECT = \"https://someothersite.org\";\n\n$mysqli = new mysqli(\"127.0.0.1\", \"db_username\", \"db_password\", \"db_name\");\n\nif ($mysqli->connect_errno) {\n\tprintf(\"Connect failed: %s\\n\", $mysqli->connect_error);\n\texit();\n}\n\nif (isset($_SERVER[\"QUERY_STRING\"]) && ($_SERVER[\"QUERY_STRING\"] != '')) {\n\n  $query = sprintf(\"SELECT id, redirect_to FROM short_links WHERE short_link = '%s' \n                    ORDER BY id DESC LIMIT 1\", $mysqli->real_escape_string($_SERVER[\"QUERY_STRING\"]));\n  $result = $mysqli->query($query);\n\n  $fail = 0;\n\n  if (!$result)  {\n    // query failed\n    error_log(\"Sent an error 404 having executed query $query and got an error of \" . $mysqli->error());\n    $fail = 1;\n  }\n\n  if ($result->num_rows < 1) {\n    // short link not found in db\n    error_log(\"Sent an error 404 having executed query $query and got no rows back\");\n    $fail = 1;\n  }\n\n  $link = $result->fetch_array(MYSQLI_ASSOC);\n  $query = \"UPDATE short_links SET count = count + 1, last_request = NOW() WHERE id = \" . $link[\"id\"];\n\n  $result = $mysqli->query($query);\n\n  if (!$result)  {\n    // query failed updating db (this really shouldn't occur ever\n    error_log(\"Sent an error 404 having executed query $query and got an error of \" . $mysqli->error());\n    $fail = 1;\n  }\n\n  if ($fail == 1) {\n    header(\"HTTP/1.0 404 Not Found\");\n    print \"<html><body><p>The requested short link was not found.</p></body></html>\";\n  } else {\n    header(\"HTTP/1.1 301 Moved Permanently\");\n    header(\"Location: \" . $link[\"redirect_to\"]);\n  }\n    \n} else {\n  // redirect to some default site\n  // I don't have a home page, but here you could just output some HTML\n  header(\"HTTP/1.1 301 Moved Permanently\");\n  header(\"Location: \" . $DEFAULT_REDIRECT);\n}\n\n?>\n"], "fixing_code": ["<?php\n\n$DEFAULT_REDIRECT = \"https://someothersite.org\";\n\n$mysqli = new mysqli(\"127.0.0.1\", \"db_username\", \"db_password\", \"db_name\");\n\nif ($mysqli->connect_errno) {\n\tprintf(\"Connect failed: %s\\n\", $mysqli->connect_error);\n\texit();\n}\n\nif (isset($_SERVER[\"QUERY_STRING\"]) && ($_SERVER[\"QUERY_STRING\"] != '')) {\n\n  $query = sprintf(\"SELECT id, redirect_to FROM short_links WHERE short_link = '%s' \n                    ORDER BY id DESC LIMIT 1\", $mysqli->real_escape_string($_SERVER[\"QUERY_STRING\"]));\n  $result = $mysqli->query($query);\n\n  $fail = 0;\n\n  if (!$result)  {\n    // query failed\n    error_log(\"Sent an error 404 having executed query $query and got an error of \" . $mysqli->error());\n    $fail = 1;\n  }\n\n  if ($result->num_rows < 1) {\n    // short link not found in db\n    error_log(\"Sent an error 404 having executed query $query and got no rows back\");\n    $fail = 1;\n  }\n\n  $link = $result->fetch_array(MYSQLI_ASSOC);\n  $query = sprintf(\"UPDATE short_links SET count = count + 1, last_request = NOW() WHERE id = ''%s''\", $link[\"id\"]);\n\n  $result = $mysqli->query($query);\n\n  if (!$result)  {\n    // query failed updating db (this really shouldn't occur ever\n    error_log(\"Sent an error 404 having executed query $query and got an error of \" . $mysqli->error());\n    $fail = 1;\n  }\n\n  if ($fail == 1) {\n    header(\"HTTP/1.0 404 Not Found\");\n    print \"<html><body><p>The requested short link was not found.</p></body></html>\";\n  } else {\n    header(\"HTTP/1.1 301 Moved Permanently\");\n    header(\"Location: \" . $link[\"redirect_to\"]);\n  }\n    \n} else {\n  // redirect to some default site\n  // I don't have a home page, but here you could just output some HTML\n  header(\"HTTP/1.1 301 Moved Permanently\");\n  header(\"Location: \" . $DEFAULT_REDIRECT);\n}\n\n?>\n"], "filenames": ["index.php"], "buggy_code_start_loc": [33], "buggy_code_end_loc": [34], "fixing_code_start_loc": [33], "fixing_code_end_loc": [34], "type": "CWE-89", "message": "A vulnerability was found in simple_php_link_shortener. It has been classified as critical. Affected is an unknown function of the file index.php. The manipulation of the argument $link[\"id\"] leads to sql injection. The name of the patch is b26ac6480761635ed94ccb0222ba6b732de6e53f. It is recommended to apply a patch to fix this issue. The identifier of this vulnerability is VDB-216996.", "other": {"cve": {"id": "CVE-2018-25057", "sourceIdentifier": "cna@vuldb.com", "published": "2022-12-28T21:15:09.077", "lastModified": "2023-01-06T13:59:37.393", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "A vulnerability was found in simple_php_link_shortener. It has been classified as critical. Affected is an unknown function of the file index.php. The manipulation of the argument $link[\"id\"] leads to sql injection. The name of the patch is b26ac6480761635ed94ccb0222ba6b732de6e53f. It is recommended to apply a patch to fix this issue. The identifier of this vulnerability is VDB-216996."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 9.8, "baseSeverity": "CRITICAL"}, "exploitabilityScore": 3.9, "impactScore": 5.9}], "cvssMetricV30": [{"source": "cna@vuldb.com", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:A/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L", "attackVector": "ADJACENT_NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "LOW", "baseScore": 5.5, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.1, "impactScore": 3.4}]}, "weaknesses": [{"source": "cna@vuldb.com", "type": "Primary", "description": [{"lang": "en", "value": "CWE-89"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:simple_php_link_shortener_project:simple_php_link_shortener:-:*:*:*:*:*:*:*", "matchCriteriaId": "84FA1A57-7F26-4D5D-8E73-99A9CBF2E11F"}]}]}], "references": [{"url": "https://github.com/mikebharris/simple_php_link_shortener/commit/b26ac6480761635ed94ccb0222ba6b732de6e53f", "source": "cna@vuldb.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://vuldb.com/?ctiid.216996", "source": "cna@vuldb.com", "tags": ["Third Party Advisory"]}, {"url": "https://vuldb.com/?id.216996", "source": "cna@vuldb.com", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/mikebharris/simple_php_link_shortener/commit/b26ac6480761635ed94ccb0222ba6b732de6e53f"}}