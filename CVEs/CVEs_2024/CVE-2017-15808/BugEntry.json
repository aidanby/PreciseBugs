{"buggy_code": ["<?php\n\n/**\n * AJAX: handling of Ajax configuration calls.\n *\n * PHP Version 5.5\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @category  phpMyFAQ\n *\n * @author    Anatoliy Belsky <anatoliy.belsky@mayflower.de>\n * @author    Thorsten Rinne <thorsten@phpmyfaq.de>\n * @copyright 2009-2017 phpMyFAQ Team\n * @license   http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n *\n * @link      http://www.phpmyfaq.de\n * @since     2009-04-01\n */\nif (!defined('IS_VALID_PHPMYFAQ') || !$user->perm->checkRight($user->getUserId(), 'editconfig')) {\n    header('Location: http://'.$_SERVER['HTTP_HOST'].dirname($_SERVER['SCRIPT_NAME']));\n    exit();\n}\n\n$ajaxAction = PMF_Filter::filterInput(INPUT_GET, 'ajaxaction', FILTER_SANITIZE_STRING);\n$instanceId = PMF_Filter::filterInput(INPUT_GET, 'instanceId', FILTER_VALIDATE_INT);\n$stopwordId = PMF_Filter::filterInput(INPUT_GET, 'stopword_id', FILTER_VALIDATE_INT);\n$stopword = PMF_Filter::filterInput(INPUT_GET, 'stopword', FILTER_SANITIZE_STRING);\n$stopwordsLang = PMF_Filter::filterInput(INPUT_GET, 'stopwords_lang', FILTER_SANITIZE_STRING);\n$csrfToken = PMF_Filter::filterInput(INPUT_GET, 'csrf', FILTER_SANITIZE_STRING);\n\n$http = new PMF_Helper_Http();\n$stopwords = new PMF_Stopwords($faqConfig);\n\nswitch ($ajaxAction) {\n\n    case 'add_instance':\n\n        $url = PMF_Filter::filterInput(INPUT_GET, 'url', FILTER_SANITIZE_STRING);\n        $instance = PMF_Filter::filterInput(INPUT_GET, 'instance', FILTER_SANITIZE_STRING);\n        $comment = PMF_Filter::filterInput(INPUT_GET, 'comment', FILTER_SANITIZE_STRING);\n        $email = PMF_Filter::filterInput(INPUT_GET, 'email', FILTER_VALIDATE_EMAIL);\n        $admin = PMF_Filter::filterInput(INPUT_GET, 'admin', FILTER_SANITIZE_STRING);\n        $password = PMF_Filter::filterInput(INPUT_GET, 'password', FILTER_SANITIZE_STRING);\n\n        $data = array(\n            'url' => 'http://'.$url.'.'.$_SERVER['SERVER_NAME'],\n            'instance' => $instance,\n            'comment' => $comment,\n        );\n\n        $faqInstance = new PMF_Instance($faqConfig);\n        $instanceId = $faqInstance->addInstance($data);\n\n        $faqInstanceClient = new PMF_Instance_Client($faqConfig);\n        $faqInstanceClient->createClient($faqInstance);\n\n        $urlParts = parse_url($data['url']);\n        $hostname = $urlParts['host'];\n\n        if ($faqInstanceClient->createClientFolder($hostname)) {\n            $clientDir = PMF_ROOT_DIR.'/multisite/'.$hostname;\n            $clientSetup = new PMF_Instance_Setup();\n            $clientSetup->setRootDir($clientDir);\n\n            $faqInstanceClient->copyConstantsFile($clientDir.'/constants.php');\n            $faqInstanceClient->copyLdapConstantsFile($clientDir.'/constants_ldap.php');\n\n            $dbSetup = array(\n                'dbServer' => $DB['server'],\n                'dbUser' => $DB['user'],\n                'dbPassword' => $DB['password'],\n                'dbDatabaseName' => $DB['db'],\n                'dbPrefix' => substr($hostname, 0, strpos($hostname, '.')),\n                'dbType' => $DB['type'],\n            );\n            $clientSetup->createDatabaseFile($dbSetup, '');\n\n            $faqInstanceClient->setClientUrl('http://'.$hostname);\n            $faqInstanceClient->createClientTables($dbSetup['dbPrefix']);\n\n            PMF_Db::setTablePrefix($dbSetup['dbPrefix']);\n\n            // add admin account and rights\n            $instanceAdmin = new PMF_User($faqConfig);\n            $instanceAdmin->createUser($admin, $password, 1);\n            $instanceAdmin->setStatus('protected');\n            $instanceAdminData = array(\n                'display_name' => '',\n                'email' => $email,\n            );\n            $instanceAdmin->setUserData($instanceAdminData);\n\n            // Add anonymous user account\n            $clientSetup->createAnonymousUser($faqConfig);\n\n            PMF_Db::setTablePrefix($DB['prefix']);\n        } else {\n            $faqInstance->removeInstance($instanceId);\n            $payload = array('error' => 'Cannot create instance.');\n        }\n\n        if (0 !== $instanceId) {\n            $payload = array('added' => $instanceId, 'url' => $data['url']);\n        } else {\n            $payload = array('error' => $instanceId);\n        }\n        $http->sendJsonWithHeaders($payload);\n        break;\n\n    case 'delete_instance':\n\n        if (!isset($_SESSION['phpmyfaq_csrf_token']) || $_SESSION['phpmyfaq_csrf_token'] !== $csrfToken) {\n            $http->sendJsonWithHeaders(array('error' => $PMF_LANG['err_NotAuth']));\n            exit(1);\n        }\n\n        if (null !== $instanceId) {\n            $faqInstance = new PMF_Instance($faqConfig);\n            if (1 !== $instanceId && $faqInstance->removeInstance($instanceId)) {\n                $payload = array('deleted' => $instanceId);\n            } else {\n                $payload = array('error' => $instanceId);\n            }\n            $http->sendJsonWithHeaders($payload);\n        }\n        break;\n\n    case 'edit_instance':\n        if (null !== $instanceId) {\n            $faqInstance = new PMF_Instance($faqConfig);\n            if ($faqInstance->removeInstance($instanceId)) {\n                $payload = array('deleted' => $instanceId);\n            } else {\n                $payload = array('error' => $instanceId);\n            }\n            $http->sendJsonWithHeaders($payload);\n        }\n        break;\n\n    case 'load_stop_words_by_lang':\n        if (PMF_Language::isASupportedLanguage($stopwordsLang)) {\n            $stopwordsList = $stopwords->getByLang($stopwordsLang);\n\n            $payload = $stopwordsList;\n            $http->sendJsonWithHeaders($payload);\n        }\n        break;\n\n    case 'delete_stop_word':\n        if (null != $stopwordId && PMF_Language::isASupportedLanguage($stopwordsLang)) {\n            $stopwords->setLanguage($stopwordsLang);\n            $stopwords->remove($stopwordId);\n        }\n        break;\n\n    case 'save_stop_word':\n\n        if (!isset($_SESSION['phpmyfaq_csrf_token']) || $_SESSION['phpmyfaq_csrf_token'] !== $csrfToken) {\n            $http->sendJsonWithHeaders(array('error' => $PMF_LANG['err_NotAuth']));\n            exit(1);\n        }\n\n        if (null != $stopword && PMF_Language::isASupportedLanguage($stopwordsLang)) {\n            $stopwords->setLanguage($stopwordsLang);\n            if (null !== $stopwordId && -1 < $stopwordId) {\n                echo $stopwords->update($stopwordId, $stopword);\n            } elseif (!$stopwords->match($stopword)) {\n                echo $stopwords->add($stopword);\n            }\n        }\n        break;\n}\n", "<?php\n/**\n * The main multi-site instances frontend.\n *\n * PHP Version 5.5\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @category  phpMyFAQ\n *\n * @author    Thorsten Rinne <thorsten@phpmyfaq.de>\n * @copyright 2012-2017 phpMyFAQ Team\n * @license   http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n *\n * @link      http://www.phpmyfaq.de\n * @since     2012-03-16\n */\nif (!defined('IS_VALID_PHPMYFAQ')) {\n    $protocol = 'http';\n    if (isset($_SERVER['HTTPS']) && strtoupper($_SERVER['HTTPS']) === 'ON') {\n        $protocol = 'https';\n    }\n    header('Location: '.$protocol.'://'.$_SERVER['HTTP_HOST'].dirname($_SERVER['SCRIPT_NAME']));\n    exit();\n}\n\n?>\n    <header class=\"row\">\n        <div class=\"col-lg-12\">\n            <h2 class=\"page-header\">\n                <i aria-hidden=\"true\" class=\"fa fa-wrench fa-fw\"></i> <?php print $PMF_LANG['ad_menu_instances']; ?>\n                <?php if ($user->perm->checkRight($user->getUserId(), 'addinstances') &&\n                          is_writable(PMF_ROOT_DIR.DIRECTORY_SEPARATOR.'multisite')): ?>\n                    <div class=\"pull-right\">\n                        <a class=\"btn btn-success\" data-toggle=\"modal\" href=\"#pmf-modal-add-instance\">\n                            <i aria-hidden=\"true\" class=\"fa fa-plus\"></i> <?php echo $PMF_LANG['ad_instance_add'] ?>\n                        </a>\n                    </div>\n                <?php endif; ?>\n            </h2>\n        </div>\n    </header>\n\n    <div class=\"row\">\n        <div class=\"col-lg-12\">\n<?php\nif ($user->perm->checkRight($user->getUserId(), 'editinstances')) {\n    $instance = new PMF_Instance($faqConfig);\n    $instanceId = PMF_Filter::filterInput(INPUT_POST, 'instance_id', FILTER_VALIDATE_INT);\n\n    // Check, if /multisite is writeable\n    if (!is_writable(PMF_ROOT_DIR.DIRECTORY_SEPARATOR.'multisite')) {\n        printf(\n            '<p class=\"alert alert-danger\">%s</p>',\n            $PMF_LANG['ad_instance_error_notwritable']\n        );\n    }\n\n    // Update client instance\n    if ('updateinstance' === $action && is_integer($instanceId)) {\n        $system = new PMF_System();\n        $clientInstance = new PMF_Instance_Client($faqConfig);\n\n        // Collect data for database\n        $data = [];\n        $data['instance'] = PMF_Filter::filterInput(INPUT_POST, 'instance', FILTER_SANITIZE_STRING);\n        $data['comment'] = PMF_Filter::filterInput(INPUT_POST, 'comment', FILTER_SANITIZE_STRING);\n\n        if ($clientInstance->updateInstance($instanceId, $data)) {\n            printf(\n                '<p class=\"alert alert-success\">%s%s</p>',\n                '<a class=\"close\" data-dismiss=\"alert\" href=\"#\">&times;</a>',\n                $PMF_LANG['ad_config_saved']\n            );\n        } else {\n            printf(\n                '<p class=\"alert alert-danger\">%s%s<br/>%s</p>',\n                '<a class=\"close\" data-dismiss=\"alert\" href=\"#\">&times;</a>',\n                $PMF_LANG['ad_entryins_fail'],\n                $faqConfig->getDb()->error()\n            );\n        }\n    }\n    ?>\n    <table class=\"table\">\n        <thead>\n        <tr>\n            <th>#</th>\n            <th><?php echo $PMF_LANG['ad_instance_url'] ?></th>\n            <th><?php echo $PMF_LANG['ad_instance_path'] ?></th>\n            <th colspan=\"3\"><?php echo $PMF_LANG['ad_instance_name'] ?></th>\n        </tr>\n        </thead>\n        <tbody>\n        <?php\n        foreach ($instance->getAllInstances() as $site):\n            $currentInstance = new PMF_Instance($faqConfig);\n    $currentInstance->getInstanceById($site->id);\n    $currentInstance->setId($site->id);\n    ?>\n        <tr id=\"row-instance-<?php print $site->id ?>\">\n            <td><?php print $site->id ?></td>\n            <td><a href=\"<?php print $site->url.$site->instance ?>\"><?php print $site->url ?></a></td>\n            <td><?php print $site->instance ?></td>\n            <td><?php print $site->comment ?></td>\n            <td>\n                <a href=\"?action=editinstance&instance_id=<?php print $site->id ?>\" class=\"btn btn-info\">\n                    <i aria-hidden=\"true\" class=\"fa fa-pencil\"></i>\n                </a>\n            </td>\n            <td>\n                <?php if ($currentInstance->getConfig('isMaster') !== true): ?>\n                <a href=\"javascript:;\" id=\"delete-instance-<?php print $site->id ?>\"\n                   class=\"btn btn-danger pmf-instance-delete\"\n                   data-csrf-token=\"<?php echo $user->getCsrfTokenFromSession() ?>\">\n                    <i aria-hidden=\"true\" class=\"fa fa-trash\"></i>\n                </a>\n                <?php endif;\n    ?>\n            </td>\n        </tr>\n        <?php endforeach;\n    ?>\n        </tbody>\n    </table>\n\n    <div class=\"modal fade\" id=\"pmf-modal-add-instance\">\n        <div class=\"modal-dialog\">\n            <div class=\"modal-content\">\n                <div class=\"modal-header\">\n                    <a class=\"close\" data-dismiss=\"modal\">\u00d7</a>\n                    <h3><?php echo $PMF_LANG['ad_instance_add'] ?></h3>\n                </div>\n                <div class=\"modal-body\">\n                    <form class=\"form-horizontal\" action=\"#\" method=\"post\" accept-charset=\"utf-8\">\n                        <div class=\"form-group\">\n                            <label class=\"control-label col-lg-4\">\n                                <?php echo $PMF_LANG['ad_instance_url'] ?>:\n                            </label>\n                            <div class=\"col-lg-8\">\n                                <div class=\"input-group\">\n                                    <span class=\"input-group-addon\">http://</span>\n                                    <input class=\"form-control\" type=\"text\" name=\"url\" id=\"url\" required>\n                                    <span class=\"input-group-addon\">.<?php print $_SERVER['SERVER_NAME'] ?></span>\n                                </div>\n                            </div>\n                        </div>\n                        <div class=\"form-group\">\n                            <label class=\"control-label col-lg-4\">\n                                <?php echo $PMF_LANG['ad_instance_path'] ?>:\n                            </label>\n                            <div class=\"col-lg-8\">\n                                <input class=\"form-control\" type=\"text\" name=\"instance\" id=\"instance\" required>\n                            </div>\n                        </div>\n                        <div class=\"form-group\">\n                            <label class=\"control-label col-lg-4\">\n                                <?php echo $PMF_LANG['ad_instance_name'] ?>:\n                            </label>\n                            <div class=\"col-lg-8\">\n                                <input class=\"form-control\" type=\"text\" name=\"comment\" id=\"comment\" required>\n                            </div>\n                        </div>\n                        <div class=\"form-group\">\n                            <label class=\"control-label col-lg-4\" for=\"email\">\n                                <?php echo $PMF_LANG['ad_instance_email'] ?>:\n                            </label>\n                            <div class=\"col-lg-8\">\n                                <input class=\"form-control\" type=\"email\" name=\"email\" id=\"email\" required>\n                            </div>\n                        </div>\n                        <div class=\"form-group\">\n                            <label class=\"control-label col-lg-4\">\n                                <?php echo $PMF_LANG['ad_instance_admin'] ?>:\n                            </label>\n                            <div class=\"col-lg-8\">\n                                <input class=\"form-control\" type=\"text\" name=\"admin\" id=\"admin\" required>\n                            </div>\n                        </div>\n                        <div class=\"form-group\">\n                            <label class=\"control-label col-lg-4\" for=\"password\">\n                                <?php echo $PMF_LANG['ad_instance_password'] ?>:\n                            </label>\n                            <div class=\"col-lg-8\">\n                                <input class=\"form-control\" type=\"password\" name=\"password\" id=\"password\" required>\n                            </div>\n                        </div>\n                    </form>\n                </div>\n                <div class=\"modal-footer\">\n                    <p><?php echo $PMF_LANG['ad_instance_hint'] ?></p>\n                    <button class=\"btn btn-primary pmf-instance-add\">\n                        <?php echo $PMF_LANG['ad_instance_button'] ?>\n                    </button>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <script>\n        (function() {\n\n            // Add instance\n            $('.pmf-instance-add').click(function(event) {\n                event.preventDefault();\n                var url      = $('#url').val();\n                var instance = $('#instance').val();\n                var comment  = $('#comment').val();\n                var email    = $('#email').val();\n                var admin    = $('#admin').val();\n                var password = $('#password').val();\n\n                $.get('index.php',\n                    { action: 'ajax', ajax: 'config', ajaxaction: 'add_instance',\n                        url: url, instance: instance, comment: comment, email: email, admin: admin, password: password\n                    },\n                    function(data) {\n                        if (typeof(data.added) === 'undefined') {\n                            $('.table').after(\n                                '<div class=\"alert alert-danger\">Could not add instance</div>'\n                            );\n                        } else {\n                            $('.modal').modal('hide');\n                            $('.table tbody').append(\n                                '<tr id=\"row-instance-' + data.added + '\">' +\n                                '<td>' + data.added + '</td>' +\n                                '<td><a href=\"' + data.url + '\">' + data.url + '</a></td>' +\n                                '<td>' + instance + '</td>' +\n                                '<td>' + comment + '</td>' +\n                                '<td>' +\n                                '<a href=\"?action=editinstance&instance_id=' + data.added +\n                                '\" class=\"btn btn-info\"><i aria-hidden=\"true\" class=\"fa fa-pencil\"></i></a>' +\n                                '</td>' +\n                                '<td>' +\n                                '<a href=\"javascript:;\" id=\"delete-instance-' + data.added +\n                                '\" class=\"btn btn-danger pmf-instance-delete\"><i aria-hidden=\"true\" class=\"fa fa-trash\"></i></a>' +\n                                '</td>' +\n                                '</tr>'\n                            );\n                        }\n                    },\n                    'json'\n                );\n\n            });\n\n            // Delete instance\n            $('.pmf-instance-delete').click(function(event) {\n                event.preventDefault();\n                var targetId = event.target.id.split('-');\n                var id = targetId[2];\n                var csrf = this.getAttribute('data-csrf-token');\n\n                if (confirm('Are you sure?')) {\n                    $.get('index.php',\n                        { action: 'ajax', ajax: 'config', ajaxaction: 'delete_instance', instanceId: id, csrf: csrf },\n                        function(data) {\n                            if (typeof(data.deleted) === 'undefined') {\n                                $('.table').after(\n                                    '<div class=\"alert alert-danger\">' +\n                                    '<?php echo $PMF_LANG['ad_instance_error_cannotdelete'] ?> ' + data.error +\n                                    '</div>'\n                                );\n                            } else {\n                                $('#row-instance-' + id).fadeOut('slow');\n                            }\n                        },\n                        'json'\n                    );\n                }\n            });\n\n        })();\n    </script>\n\n    </div>\n    </div>\n<?php\n\n} else {\n    print $PMF_LANG['err_NotAuth'];\n}\n"], "fixing_code": ["<?php\n\n/**\n * AJAX: handling of Ajax configuration calls.\n *\n * PHP Version 5.5\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @category  phpMyFAQ\n *\n * @author    Anatoliy Belsky <anatoliy.belsky@mayflower.de>\n * @author    Thorsten Rinne <thorsten@phpmyfaq.de>\n * @copyright 2009-2017 phpMyFAQ Team\n * @license   http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n *\n * @link      http://www.phpmyfaq.de\n * @since     2009-04-01\n */\nif (!defined('IS_VALID_PHPMYFAQ') || !$user->perm->checkRight($user->getUserId(), 'editconfig')) {\n    header('Location: http://'.$_SERVER['HTTP_HOST'].dirname($_SERVER['SCRIPT_NAME']));\n    exit();\n}\n\n$ajaxAction = PMF_Filter::filterInput(INPUT_GET, 'ajaxaction', FILTER_SANITIZE_STRING);\n$instanceId = PMF_Filter::filterInput(INPUT_GET, 'instanceId', FILTER_VALIDATE_INT);\n$stopwordId = PMF_Filter::filterInput(INPUT_GET, 'stopword_id', FILTER_VALIDATE_INT);\n$stopword = PMF_Filter::filterInput(INPUT_GET, 'stopword', FILTER_SANITIZE_STRING);\n$stopwordsLang = PMF_Filter::filterInput(INPUT_GET, 'stopwords_lang', FILTER_SANITIZE_STRING);\n$csrfToken = PMF_Filter::filterInput(INPUT_GET, 'csrf', FILTER_SANITIZE_STRING);\n\n$http = new PMF_Helper_Http();\n$stopwords = new PMF_Stopwords($faqConfig);\n\nswitch ($ajaxAction) {\n\n    case 'add_instance':\n\n        if (!isset($_SESSION['phpmyfaq_csrf_token']) || $_SESSION['phpmyfaq_csrf_token'] !== $csrfToken) {\n            $http->sendJsonWithHeaders(array('error' => $PMF_LANG['err_NotAuth']));\n            exit(1);\n        }\n\n        $url = PMF_Filter::filterInput(INPUT_GET, 'url', FILTER_SANITIZE_STRING);\n        $instance = PMF_Filter::filterInput(INPUT_GET, 'instance', FILTER_SANITIZE_STRING);\n        $comment = PMF_Filter::filterInput(INPUT_GET, 'comment', FILTER_SANITIZE_STRING);\n        $email = PMF_Filter::filterInput(INPUT_GET, 'email', FILTER_VALIDATE_EMAIL);\n        $admin = PMF_Filter::filterInput(INPUT_GET, 'admin', FILTER_SANITIZE_STRING);\n        $password = PMF_Filter::filterInput(INPUT_GET, 'password', FILTER_SANITIZE_STRING);\n\n        $data = array(\n            'url' => 'http://'.$url.'.'.$_SERVER['SERVER_NAME'],\n            'instance' => $instance,\n            'comment' => $comment,\n        );\n\n        $faqInstance = new PMF_Instance($faqConfig);\n        $instanceId = $faqInstance->addInstance($data);\n\n        $faqInstanceClient = new PMF_Instance_Client($faqConfig);\n        $faqInstanceClient->createClient($faqInstance);\n\n        $urlParts = parse_url($data['url']);\n        $hostname = $urlParts['host'];\n\n        if ($faqInstanceClient->createClientFolder($hostname)) {\n            $clientDir = PMF_ROOT_DIR.'/multisite/'.$hostname;\n            $clientSetup = new PMF_Instance_Setup();\n            $clientSetup->setRootDir($clientDir);\n\n            $faqInstanceClient->copyConstantsFile($clientDir.'/constants.php');\n            $faqInstanceClient->copyLdapConstantsFile($clientDir.'/constants_ldap.php');\n\n            $dbSetup = array(\n                'dbServer' => $DB['server'],\n                'dbUser' => $DB['user'],\n                'dbPassword' => $DB['password'],\n                'dbDatabaseName' => $DB['db'],\n                'dbPrefix' => substr($hostname, 0, strpos($hostname, '.')),\n                'dbType' => $DB['type'],\n            );\n            $clientSetup->createDatabaseFile($dbSetup, '');\n\n            $faqInstanceClient->setClientUrl('http://'.$hostname);\n            $faqInstanceClient->createClientTables($dbSetup['dbPrefix']);\n\n            PMF_Db::setTablePrefix($dbSetup['dbPrefix']);\n\n            // add admin account and rights\n            $instanceAdmin = new PMF_User($faqConfig);\n            $instanceAdmin->createUser($admin, $password, 1);\n            $instanceAdmin->setStatus('protected');\n            $instanceAdminData = array(\n                'display_name' => '',\n                'email' => $email,\n            );\n            $instanceAdmin->setUserData($instanceAdminData);\n\n            // Add anonymous user account\n            $clientSetup->createAnonymousUser($faqConfig);\n\n            PMF_Db::setTablePrefix($DB['prefix']);\n        } else {\n            $faqInstance->removeInstance($instanceId);\n            $payload = array('error' => 'Cannot create instance.');\n        }\n\n        if (0 !== $instanceId) {\n            $payload = array('added' => $instanceId, 'url' => $data['url']);\n        } else {\n            $payload = array('error' => $instanceId);\n        }\n        $http->sendJsonWithHeaders($payload);\n        break;\n\n    case 'delete_instance':\n\n        if (!isset($_SESSION['phpmyfaq_csrf_token']) || $_SESSION['phpmyfaq_csrf_token'] !== $csrfToken) {\n            $http->sendJsonWithHeaders(array('error' => $PMF_LANG['err_NotAuth']));\n            exit(1);\n        }\n\n        if (null !== $instanceId) {\n            $faqInstance = new PMF_Instance($faqConfig);\n            if (1 !== $instanceId && $faqInstance->removeInstance($instanceId)) {\n                $payload = array('deleted' => $instanceId);\n            } else {\n                $payload = array('error' => $instanceId);\n            }\n            $http->sendJsonWithHeaders($payload);\n        }\n        break;\n\n    case 'edit_instance':\n        if (null !== $instanceId) {\n            $faqInstance = new PMF_Instance($faqConfig);\n            if ($faqInstance->removeInstance($instanceId)) {\n                $payload = array('deleted' => $instanceId);\n            } else {\n                $payload = array('error' => $instanceId);\n            }\n            $http->sendJsonWithHeaders($payload);\n        }\n        break;\n\n    case 'load_stop_words_by_lang':\n        if (PMF_Language::isASupportedLanguage($stopwordsLang)) {\n            $stopwordsList = $stopwords->getByLang($stopwordsLang);\n\n            $payload = $stopwordsList;\n            $http->sendJsonWithHeaders($payload);\n        }\n        break;\n\n    case 'delete_stop_word':\n        if (null != $stopwordId && PMF_Language::isASupportedLanguage($stopwordsLang)) {\n            $stopwords->setLanguage($stopwordsLang);\n            $stopwords->remove($stopwordId);\n        }\n        break;\n\n    case 'save_stop_word':\n\n        if (!isset($_SESSION['phpmyfaq_csrf_token']) || $_SESSION['phpmyfaq_csrf_token'] !== $csrfToken) {\n            $http->sendJsonWithHeaders(array('error' => $PMF_LANG['err_NotAuth']));\n            exit(1);\n        }\n\n        if (null != $stopword && PMF_Language::isASupportedLanguage($stopwordsLang)) {\n            $stopwords->setLanguage($stopwordsLang);\n            if (null !== $stopwordId && -1 < $stopwordId) {\n                echo $stopwords->update($stopwordId, $stopword);\n            } elseif (!$stopwords->match($stopword)) {\n                echo $stopwords->add($stopword);\n            }\n        }\n        break;\n}\n", "<?php\n/**\n * The main multi-site instances frontend.\n *\n * PHP Version 5.5\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @category  phpMyFAQ\n *\n * @author    Thorsten Rinne <thorsten@phpmyfaq.de>\n * @copyright 2012-2017 phpMyFAQ Team\n * @license   http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n *\n * @link      http://www.phpmyfaq.de\n * @since     2012-03-16\n */\nif (!defined('IS_VALID_PHPMYFAQ')) {\n    $protocol = 'http';\n    if (isset($_SERVER['HTTPS']) && strtoupper($_SERVER['HTTPS']) === 'ON') {\n        $protocol = 'https';\n    }\n    header('Location: '.$protocol.'://'.$_SERVER['HTTP_HOST'].dirname($_SERVER['SCRIPT_NAME']));\n    exit();\n}\n\n?>\n    <header class=\"row\">\n        <div class=\"col-lg-12\">\n            <h2 class=\"page-header\">\n                <i aria-hidden=\"true\" class=\"fa fa-wrench fa-fw\"></i> <?php print $PMF_LANG['ad_menu_instances']; ?>\n                <?php if ($user->perm->checkRight($user->getUserId(), 'addinstances') &&\n                          is_writable(PMF_ROOT_DIR.DIRECTORY_SEPARATOR.'multisite')): ?>\n                    <div class=\"pull-right\">\n                        <a class=\"btn btn-success\" data-toggle=\"modal\" href=\"#pmf-modal-add-instance\">\n                            <i aria-hidden=\"true\" class=\"fa fa-plus\"></i> <?php echo $PMF_LANG['ad_instance_add'] ?>\n                        </a>\n                    </div>\n                <?php endif; ?>\n            </h2>\n        </div>\n    </header>\n\n    <div class=\"row\">\n        <div class=\"col-lg-12\">\n<?php\nif ($user->perm->checkRight($user->getUserId(), 'editinstances')) {\n    $instance = new PMF_Instance($faqConfig);\n    $instanceId = PMF_Filter::filterInput(INPUT_POST, 'instance_id', FILTER_VALIDATE_INT);\n\n    // Check, if /multisite is writeable\n    if (!is_writable(PMF_ROOT_DIR.DIRECTORY_SEPARATOR.'multisite')) {\n        printf(\n            '<p class=\"alert alert-danger\">%s</p>',\n            $PMF_LANG['ad_instance_error_notwritable']\n        );\n    }\n\n    // Update client instance\n    if ('updateinstance' === $action && is_integer($instanceId)) {\n        $system = new PMF_System();\n        $clientInstance = new PMF_Instance_Client($faqConfig);\n\n        // Collect data for database\n        $data = [];\n        $data['instance'] = PMF_Filter::filterInput(INPUT_POST, 'instance', FILTER_SANITIZE_STRING);\n        $data['comment'] = PMF_Filter::filterInput(INPUT_POST, 'comment', FILTER_SANITIZE_STRING);\n\n        if ($clientInstance->updateInstance($instanceId, $data)) {\n            printf(\n                '<p class=\"alert alert-success\">%s%s</p>',\n                '<a class=\"close\" data-dismiss=\"alert\" href=\"#\">&times;</a>',\n                $PMF_LANG['ad_config_saved']\n            );\n        } else {\n            printf(\n                '<p class=\"alert alert-danger\">%s%s<br/>%s</p>',\n                '<a class=\"close\" data-dismiss=\"alert\" href=\"#\">&times;</a>',\n                $PMF_LANG['ad_entryins_fail'],\n                $faqConfig->getDb()->error()\n            );\n        }\n    }\n    ?>\n    <table class=\"table\">\n        <thead>\n        <tr>\n            <th>#</th>\n            <th><?php echo $PMF_LANG['ad_instance_url'] ?></th>\n            <th><?php echo $PMF_LANG['ad_instance_path'] ?></th>\n            <th colspan=\"3\"><?php echo $PMF_LANG['ad_instance_name'] ?></th>\n        </tr>\n        </thead>\n        <tbody>\n        <?php\n        foreach ($instance->getAllInstances() as $site):\n            $currentInstance = new PMF_Instance($faqConfig);\n            $currentInstance->getInstanceById($site->id);\n            $currentInstance->setId($site->id);\n            ?>\n        <tr id=\"row-instance-<?php print $site->id ?>\">\n            <td><?php print $site->id ?></td>\n            <td><a href=\"<?php print $site->url.$site->instance ?>\"><?php print $site->url ?></a></td>\n            <td><?php print $site->instance ?></td>\n            <td><?php print $site->comment ?></td>\n            <td>\n                <a href=\"?action=editinstance&instance_id=<?php print $site->id ?>\" class=\"btn btn-info\">\n                    <i aria-hidden=\"true\" class=\"fa fa-pencil\"></i>\n                </a>\n            </td>\n            <td>\n                <?php if ($currentInstance->getConfig('isMaster') !== true): ?>\n                <a href=\"javascript:;\" id=\"delete-instance-<?php print $site->id ?>\"\n                   class=\"btn btn-danger pmf-instance-delete\"\n                   data-csrf-token=\"<?php echo $user->getCsrfTokenFromSession() ?>\">\n                    <i aria-hidden=\"true\" class=\"fa fa-trash\"></i>\n                </a>\n                <?php endif; ?>\n            </td>\n        </tr>\n        <?php endforeach; ?>\n        </tbody>\n    </table>\n\n    <div class=\"modal fade\" id=\"pmf-modal-add-instance\">\n        <div class=\"modal-dialog\">\n            <div class=\"modal-content\">\n                <div class=\"modal-header\">\n                    <a class=\"close\" data-dismiss=\"modal\">\u00d7</a>\n                    <h3><?php echo $PMF_LANG['ad_instance_add'] ?></h3>\n                </div>\n                <div class=\"modal-body\">\n                    <form class=\"form-horizontal\" action=\"#\" method=\"post\" accept-charset=\"utf-8\">\n                        <input type=\"hidden\" name=\"csrf\" id=\"csrf\" value=\"<?php echo $user->getCsrfTokenFromSession() ?>\">\n                        <div class=\"form-group\">\n                            <label class=\"control-label col-lg-4\">\n                                <?php echo $PMF_LANG['ad_instance_url'] ?>:\n                            </label>\n                            <div class=\"col-lg-8\">\n                                <div class=\"input-group\">\n                                    <span class=\"input-group-addon\">http://</span>\n                                    <input class=\"form-control\" type=\"text\" name=\"url\" id=\"url\" required>\n                                    <span class=\"input-group-addon\">.<?php print $_SERVER['SERVER_NAME'] ?></span>\n                                </div>\n                            </div>\n                        </div>\n                        <div class=\"form-group\">\n                            <label class=\"control-label col-lg-4\">\n                                <?php echo $PMF_LANG['ad_instance_path'] ?>:\n                            </label>\n                            <div class=\"col-lg-8\">\n                                <input class=\"form-control\" type=\"text\" name=\"instance\" id=\"instance\" required>\n                            </div>\n                        </div>\n                        <div class=\"form-group\">\n                            <label class=\"control-label col-lg-4\">\n                                <?php echo $PMF_LANG['ad_instance_name'] ?>:\n                            </label>\n                            <div class=\"col-lg-8\">\n                                <input class=\"form-control\" type=\"text\" name=\"comment\" id=\"comment\" required>\n                            </div>\n                        </div>\n                        <div class=\"form-group\">\n                            <label class=\"control-label col-lg-4\" for=\"email\">\n                                <?php echo $PMF_LANG['ad_instance_email'] ?>:\n                            </label>\n                            <div class=\"col-lg-8\">\n                                <input class=\"form-control\" type=\"email\" name=\"email\" id=\"email\" required>\n                            </div>\n                        </div>\n                        <div class=\"form-group\">\n                            <label class=\"control-label col-lg-4\">\n                                <?php echo $PMF_LANG['ad_instance_admin'] ?>:\n                            </label>\n                            <div class=\"col-lg-8\">\n                                <input class=\"form-control\" type=\"text\" name=\"admin\" id=\"admin\" required>\n                            </div>\n                        </div>\n                        <div class=\"form-group\">\n                            <label class=\"control-label col-lg-4\" for=\"password\">\n                                <?php echo $PMF_LANG['ad_instance_password'] ?>:\n                            </label>\n                            <div class=\"col-lg-8\">\n                                <input class=\"form-control\" type=\"password\" name=\"password\" id=\"password\" required>\n                            </div>\n                        </div>\n                    </form>\n                </div>\n                <div class=\"modal-footer\">\n                    <p><?php echo $PMF_LANG['ad_instance_hint'] ?></p>\n                    <button class=\"btn btn-primary pmf-instance-add\">\n                        <?php echo $PMF_LANG['ad_instance_button'] ?>\n                    </button>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <script>\n        (function() {\n\n            // Add instance\n            $('.pmf-instance-add').click(function(event) {\n                event.preventDefault();\n                var csrf     = $('#csrf').val();\n                var url      = $('#url').val();\n                var instance = $('#instance').val();\n                var comment  = $('#comment').val();\n                var email    = $('#email').val();\n                var admin    = $('#admin').val();\n                var password = $('#password').val();\n\n                $.get('index.php',\n                    {\n                        action: 'ajax', ajax: 'config', ajaxaction: 'add_instance', csrf: csrf, url: url,\n                        instance: instance, comment: comment, email: email, admin: admin, password: password\n                    },\n                    function(data) {\n                        if (typeof(data.added) === 'undefined') {\n                            $('.table').after(\n                                '<div class=\"alert alert-danger\">Could not add instance</div>'\n                            );\n                        } else {\n                            $('.modal').modal('hide');\n                            $('.table tbody').append(\n                                '<tr id=\"row-instance-' + data.added + '\">' +\n                                '<td>' + data.added + '</td>' +\n                                '<td><a href=\"' + data.url + '\">' + data.url + '</a></td>' +\n                                '<td>' + instance + '</td>' +\n                                '<td>' + comment + '</td>' +\n                                '<td>' +\n                                '<a href=\"?action=editinstance&instance_id=' + data.added +\n                                '\" class=\"btn btn-info\"><i aria-hidden=\"true\" class=\"fa fa-pencil\"></i></a>' +\n                                '</td>' +\n                                '<td>' +\n                                '<a href=\"javascript:;\" id=\"delete-instance-' + data.added +\n                                '\" class=\"btn btn-danger pmf-instance-delete\"><i aria-hidden=\"true\" class=\"fa fa-trash\"></i></a>' +\n                                '</td>' +\n                                '</tr>'\n                            );\n                        }\n                    },\n                    'json'\n                );\n\n            });\n\n            // Delete instance\n            $('.pmf-instance-delete').click(function(event) {\n                event.preventDefault();\n                var targetId = event.target.id.split('-');\n                var id = targetId[2];\n                var csrf = this.getAttribute('data-csrf-token');\n\n                if (confirm('Are you sure?')) {\n                    $.get('index.php',\n                        { action: 'ajax', ajax: 'config', ajaxaction: 'delete_instance', instanceId: id, csrf: csrf },\n                        function(data) {\n                            if (typeof(data.deleted) === 'undefined') {\n                                $('.table').after(\n                                    '<div class=\"alert alert-danger\">' +\n                                    '<?php echo $PMF_LANG['ad_instance_error_cannotdelete'] ?> ' + data.error +\n                                    '</div>'\n                                );\n                            } else {\n                                $('#row-instance-' + id).fadeOut('slow');\n                            }\n                        },\n                        'json'\n                    );\n                }\n            });\n\n        })();\n    </script>\n\n    </div>\n    </div>\n<?php\n\n} else {\n    print $PMF_LANG['err_NotAuth'];\n}\n"], "filenames": ["phpmyfaq/admin/ajax.config.php", "phpmyfaq/admin/instances.php"], "buggy_code_start_loc": [39, 100], "buggy_code_end_loc": [39, 218], "fixing_code_start_loc": [40, 100], "fixing_code_end_loc": [45, 219], "type": "CWE-352", "message": "In phpMyFaq before 2.9.9, there is CSRF in admin/ajax.config.php.", "other": {"cve": {"id": "CVE-2017-15808", "sourceIdentifier": "cve@mitre.org", "published": "2017-10-23T17:29:00.487", "lastModified": "2017-10-25T08:24:21.150", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "In phpMyFaq before 2.9.9, there is CSRF in admin/ajax.config.php."}, {"lang": "es", "value": "En phpMyFaq en versiones anteriores a la 2.9.9, existe Cross-Site Request Forgery (CSRF) en admin/ajax.config.php."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 8.8, "baseSeverity": "HIGH"}, "exploitabilityScore": 2.8, "impactScore": 5.9}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:P/I:P/A:P", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "PARTIAL", "integrityImpact": "PARTIAL", "availabilityImpact": "PARTIAL", "baseScore": 6.8}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 6.4, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-352"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:phpmyfaq:phpmyfaq:*:*:*:*:*:*:*:*", "versionEndIncluding": "2.9.8", "matchCriteriaId": "1D0B1C07-83F7-4DB0-976C-51483D7DF516"}]}]}], "references": [{"url": "https://github.com/thorsten/phpMyFAQ/commit/a249b4645fb86f6a9fbe5d2344ab1cbdb906b75c", "source": "cve@mitre.org", "tags": ["Issue Tracking", "Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/thorsten/phpMyFAQ/commit/a249b4645fb86f6a9fbe5d2344ab1cbdb906b75c"}}