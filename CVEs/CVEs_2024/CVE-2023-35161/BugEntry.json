{"buggy_code": ["<?xml version=\"1.1\" encoding=\"UTF-8\"?>\n\n<!--\n * See the NOTICE file distributed with this work for additional\n * information regarding copyright ownership.\n *\n * This is free software; you can redistribute it and/or modify it\n * under the terms of the GNU Lesser General Public License as\n * published by the Free Software Foundation; either version 2.1 of\n * the License, or (at your option) any later version.\n *\n * This software is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n * Lesser General Public License for more details.\n *\n * You should have received a copy of the GNU Lesser General Public\n * License along with this software; if not, write to the Free\n * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n-->\n\n<xwikidoc version=\"1.3\" reference=\"AppWithinMinutes.DeleteApplication\" locale=\"\">\n  <web>AppWithinMinutes</web>\n  <name>DeleteApplication</name>\n  <language/>\n  <defaultLanguage/>\n  <translation>0</translation>\n  <creator>xwiki:XWiki.Admin</creator>\n  <parent>AppWithinMinutes.WebHome</parent>\n  <author>xwiki:XWiki.Admin</author>\n  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>\n  <version>1.1</version>\n  <title>Delete Application</title>\n  <comment/>\n  <minorEdit>false</minorEdit>\n  <syntaxId>xwiki/2.1</syntaxId>\n  <hidden>true</hidden>\n  <content>{{velocity output=\"false\"}}\n#**\n * Retrieve the list of pages that contain application data.\n *#\n#macro (getApplicationDataPages $classReference $pageReferences)\n  #set ($statement = ', BaseObject as obj where doc.fullName = obj.name and ' +\n    'obj.className = :class and doc.fullName &lt;&gt; :template')\n  #set ($query = $services.query.hql($statement))\n  #set ($classLocalReference = $services.model.serialize($classReference, 'local'))\n  #set ($discard = $query.bindValue('class', $classLocalReference))\n  #set ($discard = $query.bindValue('template', \"$stringtool.removeEnd($classLocalReference, 'Class')Template\"))\n  #foreach ($entryLocalReference in $query.execute())\n    #set ($discard = $pageReferences.add($services.model.resolveDocument($entryLocalReference)))\n  #end\n#end\n\n#**\n * Retrieve the list of pages that contain application code.\n *#\n#macro (getApplicationCodePages $appReference $classReference $pageReferences)\n  #set ($discard = $pageReferences.add($appReference))\n  #if (!$classReference.hasParent($appReference))\n    ## The code pages are outside of the application page tree.\n    #set ($discard = $pageReferences.add($classReference.parent))\n  #end\n#end\n\n#macro (bulkDelete $entities)\n  #set ($errorLog = $NULL)\n  #set ($deleteJob = $services.refactoring.delete($entities))\n  #try()\n    #set ($discard = $deleteJob.join())\n    #set ($deleteJobStatus = $services.job.getJobStatus($deleteJob.request.id))\n    #set ($errorLog = $deleteJobStatus.logTail.getFirstLogEvent('ERROR'))\n  #end\n#end\n\n#macro (askForDeleteConfirmation $appReference $scope)\n  ## Confirmation dialog\n  #set ($appTitle = $xwiki.getDocument($appReference).plainTitle)\n  #if ($scope == 'entries')\n    #set ($confirmationMessage = $services.localization.render(\n      'platform.appwithinminutes.deleteAppEntriesConfirmation', [$escapetool.xml($appTitle)]))\n  #else\n    #set ($confirmationMessage = $services.localization.render('platform.appwithinminutes.deleteAppConfirmation',\n      [$escapetool.xml($appTitle)]))\n  #end\n  #set ($cancelURL = $doc.getURL())\n  #set ($confirmParams = {\n    'appName': $services.model.serialize($appReference, 'local'),\n    'resolve': true,\n    'scope': $scope,\n    'confirm': 1,\n    'form_token': $services.csrf.token\n  })\n  #if (\"$!request.xredirect\" != '')\n    #set ($cancelURL = $request.xredirect)\n    #set ($confirmParams.xredirect = $cancelURL)\n  #end\n  #set ($confirmURL = $doc.getURL($xcontext.action, $escapetool.url($confirmParams)))\n  {{html}}\n  #xwikimessagebox($services.localization.render('core.delete') $confirmationMessage $confirmURL\n    $escapetool.xml($cancelURL) $services.localization.render('yes') $services.localization.render('no'))\n  {{/html}}\n#end\n{{/velocity}}\n\n{{velocity}}\n#if (\"$!request.appName\" != '')\n  #set ($displayDocExtra = false)\n  #if ($request.resolve == 'true')\n    #set ($appReference = $services.model.resolveSpace($request.appName))\n  #else\n    #set ($appReference = $services.model.createSpaceReference($request.appName,\n      $doc.documentReference.wikiReference))\n  #end\n  #set ($appHomeReference = $services.model.resolveDocument('', 'default', $appReference))\n  #set ($scope = $request.scope)\n  ## Make sure a valid application name has been passed, otherwise stop here.\n  #set ($appDescriptor = $xwiki.getDocument($appReference).getObject('AppWithinMinutes.LiveTableClass'))\n  #if ($appDescriptor)\n    #if ($request.confirm == '1')\n      ## CSRF protection.\n      #if(!$services.csrf.isTokenValid($request.form_token))\n        $response.sendRedirect($services.csrf.getResubmissionURL())\n        #stop\n      #end\n      ##\n      #set ($classLocalReference = $appDescriptor.getValue('class'))\n      #set ($classReference = $services.model.resolveDocument($classLocalReference, 'explicit', $appHomeReference))\n      ##\n      #set ($pageReferences = [])\n      #getApplicationDataPages($classReference $pageReferences)\n      #if ($scope != 'entries')\n        #getApplicationCodePages($appReference $classReference $pageReferences)\n      #end\n      #bulkDelete($pageReferences)\n      ##\n      #if ($errorLog)\n        {{error}}$errorLog{{/error}}\n      #elseif ($request.xredirect)\n        ## If requested, redirect the UI after the work is complete.\n        $response.sendRedirect($request.xredirect)\n      #end\n    #else\n      #askForDeleteConfirmation($appReference $scope)\n    #end\n  #else\n    ## Unusable application name.\n    #if (!$xwiki.exists($appHomeReference))\n      {{error}}$services.localization.render('platform.appwithinminutes.deleteAppDoesNotExistError'){{/error}}\n    #else\n      {{error}}$services.localization.render('platform.appwithinminutes.deleteAppInvalidAppError'){{/error}}\n    #end\n  #end\n#else\n  {{error}}$services.localization.render('platform.appwithinminutes.deleteAppNotSpecifiedError'){{/error}}\n#end\n{{/velocity}}\n</content>\n</xwikidoc>\n"], "fixing_code": ["<?xml version=\"1.1\" encoding=\"UTF-8\"?>\n\n<!--\n * See the NOTICE file distributed with this work for additional\n * information regarding copyright ownership.\n *\n * This is free software; you can redistribute it and/or modify it\n * under the terms of the GNU Lesser General Public License as\n * published by the Free Software Foundation; either version 2.1 of\n * the License, or (at your option) any later version.\n *\n * This software is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n * Lesser General Public License for more details.\n *\n * You should have received a copy of the GNU Lesser General Public\n * License along with this software; if not, write to the Free\n * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n-->\n\n<xwikidoc version=\"1.3\" reference=\"AppWithinMinutes.DeleteApplication\" locale=\"\">\n  <web>AppWithinMinutes</web>\n  <name>DeleteApplication</name>\n  <language/>\n  <defaultLanguage/>\n  <translation>0</translation>\n  <creator>xwiki:XWiki.Admin</creator>\n  <parent>AppWithinMinutes.WebHome</parent>\n  <author>xwiki:XWiki.Admin</author>\n  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>\n  <version>1.1</version>\n  <title>Delete Application</title>\n  <comment/>\n  <minorEdit>false</minorEdit>\n  <syntaxId>xwiki/2.1</syntaxId>\n  <hidden>true</hidden>\n  <content>{{velocity output=\"false\"}}\n#**\n * Retrieve the list of pages that contain application data.\n *#\n#macro (getApplicationDataPages $classReference $pageReferences)\n  #set ($statement = ', BaseObject as obj where doc.fullName = obj.name and ' +\n    'obj.className = :class and doc.fullName &lt;&gt; :template')\n  #set ($query = $services.query.hql($statement))\n  #set ($classLocalReference = $services.model.serialize($classReference, 'local'))\n  #set ($discard = $query.bindValue('class', $classLocalReference))\n  #set ($discard = $query.bindValue('template', \"$stringtool.removeEnd($classLocalReference, 'Class')Template\"))\n  #foreach ($entryLocalReference in $query.execute())\n    #set ($discard = $pageReferences.add($services.model.resolveDocument($entryLocalReference)))\n  #end\n#end\n\n#**\n * Retrieve the list of pages that contain application code.\n *#\n#macro (getApplicationCodePages $appReference $classReference $pageReferences)\n  #set ($discard = $pageReferences.add($appReference))\n  #if (!$classReference.hasParent($appReference))\n    ## The code pages are outside of the application page tree.\n    #set ($discard = $pageReferences.add($classReference.parent))\n  #end\n#end\n\n#macro (bulkDelete $entities)\n  #set ($errorLog = $NULL)\n  #set ($deleteJob = $services.refactoring.delete($entities))\n  #try()\n    #set ($discard = $deleteJob.join())\n    #set ($deleteJobStatus = $services.job.getJobStatus($deleteJob.request.id))\n    #set ($errorLog = $deleteJobStatus.logTail.getFirstLogEvent('ERROR'))\n  #end\n#end\n\n#macro (askForDeleteConfirmation $appReference $scope)\n  ## Confirmation dialog\n  #set ($appTitle = $xwiki.getDocument($appReference).plainTitle)\n  #if ($scope == 'entries')\n    #set ($confirmationMessage = $services.localization.render(\n      'platform.appwithinminutes.deleteAppEntriesConfirmation', [$escapetool.xml($appTitle)]))\n  #else\n    #set ($confirmationMessage = $services.localization.render('platform.appwithinminutes.deleteAppConfirmation',\n      [$escapetool.xml($appTitle)]))\n  #end\n  #set ($cancelURL = $doc.getURL())\n  #set ($confirmParams = {\n    'appName': $services.model.serialize($appReference, 'local'),\n    'resolve': true,\n    'scope': $scope,\n    'confirm': 1,\n    'form_token': $services.csrf.token\n  })\n  #if (\"$!request.xredirect\" != '')\n    #getSanitizedURLAttributeValue('a','href',$request.xredirect,$doc.getURL(),$cancelURL)\n    ## We don't sanitize those parameters as the sanitation will be handled server side.\n    #set ($confirmParams.xredirect = $request.xredirect)\n  #end\n  #set ($confirmURL = $doc.getURL($xcontext.action, $escapetool.url($confirmParams)))\n  {{html}}\n  #xwikimessagebox($services.localization.render('core.delete') $confirmationMessage $confirmURL\n    $escapetool.xml($cancelURL) $services.localization.render('yes') $services.localization.render('no'))\n  {{/html}}\n#end\n{{/velocity}}\n\n{{velocity}}\n#if (\"$!request.appName\" != '')\n  #set ($displayDocExtra = false)\n  #if ($request.resolve == 'true')\n    #set ($appReference = $services.model.resolveSpace($request.appName))\n  #else\n    #set ($appReference = $services.model.createSpaceReference($request.appName,\n      $doc.documentReference.wikiReference))\n  #end\n  #set ($appHomeReference = $services.model.resolveDocument('', 'default', $appReference))\n  #set ($scope = $request.scope)\n  ## Make sure a valid application name has been passed, otherwise stop here.\n  #set ($appDescriptor = $xwiki.getDocument($appReference).getObject('AppWithinMinutes.LiveTableClass'))\n  #if ($appDescriptor)\n    #if ($request.confirm == '1')\n      ## CSRF protection.\n      #if(!$services.csrf.isTokenValid($request.form_token))\n        $response.sendRedirect($services.csrf.getResubmissionURL())\n        #stop\n      #end\n      ##\n      #set ($classLocalReference = $appDescriptor.getValue('class'))\n      #set ($classReference = $services.model.resolveDocument($classLocalReference, 'explicit', $appHomeReference))\n      ##\n      #set ($pageReferences = [])\n      #getApplicationDataPages($classReference $pageReferences)\n      #if ($scope != 'entries')\n        #getApplicationCodePages($appReference $classReference $pageReferences)\n      #end\n      #bulkDelete($pageReferences)\n      ##\n      #if ($errorLog)\n        {{error}}$errorLog{{/error}}\n      #elseif ($request.xredirect)\n        ## If requested, redirect the UI after the work is complete.\n        $response.sendRedirect($request.xredirect)\n      #end\n    #else\n      #askForDeleteConfirmation($appReference $scope)\n    #end\n  #else\n    ## Unusable application name.\n    #if (!$xwiki.exists($appHomeReference))\n      {{error}}$services.localization.render('platform.appwithinminutes.deleteAppDoesNotExistError'){{/error}}\n    #else\n      {{error}}$services.localization.render('platform.appwithinminutes.deleteAppInvalidAppError'){{/error}}\n    #end\n  #end\n#else\n  {{error}}$services.localization.render('platform.appwithinminutes.deleteAppNotSpecifiedError'){{/error}}\n#end\n{{/velocity}}\n</content>\n</xwikidoc>\n"], "filenames": ["xwiki-platform-core/xwiki-platform-appwithinminutes/xwiki-platform-appwithinminutes-ui/src/main/resources/AppWithinMinutes/DeleteApplication.xml"], "buggy_code_start_loc": [95], "buggy_code_end_loc": [97], "fixing_code_start_loc": [95], "fixing_code_end_loc": [98], "type": "CWE-79", "message": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. Users are able to forge an URL with a payload allowing to inject Javascript in the page (XSS). It's possible to exploit the DeleteApplication page to perform a XSS, e.g. by using URL such as: > xwiki/bin/view/AppWithinMinutes/DeleteApplication?appName=Menu&resolve=true&xredirect=javascript:alert(document.domain). This vulnerability exists since XWiki 6.2-milestone-1. The vulnerability has been patched in XWiki 14.10.5 and 15.1-rc-1.\n", "other": {"cve": {"id": "CVE-2023-35161", "sourceIdentifier": "security-advisories@github.com", "published": "2023-06-23T19:15:09.647", "lastModified": "2023-06-30T13:12:23.500", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. Users are able to forge an URL with a payload allowing to inject Javascript in the page (XSS). It's possible to exploit the DeleteApplication page to perform a XSS, e.g. by using URL such as: > xwiki/bin/view/AppWithinMinutes/DeleteApplication?appName=Menu&resolve=true&xredirect=javascript:alert(document.domain). This vulnerability exists since XWiki 6.2-milestone-1. The vulnerability has been patched in XWiki 14.10.5 and 15.1-rc-1.\n"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}, {"source": "security-advisories@github.com", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 9.6, "baseSeverity": "CRITICAL"}, "exploitabilityScore": 2.8, "impactScore": 6.0}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}, {"source": "security-advisories@github.com", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-87"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:xwiki:xwiki:*:*:*:*:*:*:*:*", "versionStartIncluding": "6.2.1", "versionEndExcluding": "14.10.5", "matchCriteriaId": "63992E92-EAB6-4AFF-806E-208136A65FD7"}, {"vulnerable": true, "criteria": "cpe:2.3:a:xwiki:xwiki:6.2:milestone1:*:*:*:*:*:*", "matchCriteriaId": "67A33C16-E37C-40B3-AAB4-D598BDF066BD"}, {"vulnerable": true, "criteria": "cpe:2.3:a:xwiki:xwiki:6.2:milestone2:*:*:*:*:*:*", "matchCriteriaId": "63E88234-FB07-452D-8062-2AD64B22FFE5"}]}]}], "references": [{"url": "https://github.com/xwiki/xwiki-platform/commit/8f5a889b7cd140770e54f5b4195d88058790e305", "source": "security-advisories@github.com", "tags": ["Patch", "Vendor Advisory"]}, {"url": "https://github.com/xwiki/xwiki-platform/security/advisories/GHSA-4xm7-5q79-3fch", "source": "security-advisories@github.com", "tags": ["Vendor Advisory"]}, {"url": "https://jira.xwiki.org/browse/XWIKI-20583", "source": "security-advisories@github.com", "tags": ["Issue Tracking", "Patch", "Vendor Advisory"]}, {"url": "https://jira.xwiki.org/browse/XWIKI-20614", "source": "security-advisories@github.com", "tags": ["Issue Tracking", "Permissions Required", "Vendor Advisory"]}]}, "github_commit_url": "https://github.com/xwiki/xwiki-platform/commit/8f5a889b7cd140770e54f5b4195d88058790e305"}}