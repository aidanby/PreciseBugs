{"buggy_code": ["<?php\n/*\n\tFusionPBX\n\tVersion: MPL 1.1\n\n\tThe contents of this file are subject to the Mozilla Public License Version\n\t1.1 (the \"License\"); you may not use this file except in compliance with\n\tthe License. You may obtain a copy of the License at\n\thttp://www.mozilla.org/MPL/\n\n\tSoftware distributed under the License is distributed on an \"AS IS\" basis,\n\tWITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n\tfor the specific language governing rights and limitations under the\n\tLicense.\n\n\tThe Original Code is FusionPBX\n\n\tThe Initial Developer of the Original Code is\n\tMark J Crane <markjcrane@fusionpbx.com>\n\tPortions created by the Initial Developer are Copyright (C) 2008-2016\n\tthe Initial Developer. All Rights Reserved.\n\n\tContributor(s):\n\tMark J Crane <markjcrane@fusionpbx.com>\n\tJames Rose <james.o.rose@gmail.com>\n*/\n\n//includes\n\tinclude \"root.php\";\n\trequire_once \"resources/require.php\";\n\n//check permissions\n\trequire_once \"resources/check_auth.php\";\n\tif (permission_exists('music_on_hold_view')) {\n\t\t//access granted\n\t}\n\telse {\n\t\techo \"access denied\";\n\t\texit;\n\t}\n\n//add multi-lingual support\n\t$language = new text;\n\t$text = $language->get();\n\n//increase the exucution time\n\tini_set('max_execution_time', 7200);\n\n//get the music_on_hold array\n\t$sql = \"select * from v_music_on_hold \";\n\t$sql .= \"where ( \";\n\t$sql .= \"domain_uuid = :domain_uuid \";\n\tif (permission_exists('music_on_hold_domain')) {\n\t\t$sql .= \"or domain_uuid is null \";\n\t}\n\t$sql .= \") \";\n\t$sql .= \"order by domain_uuid desc, music_on_hold_name asc, music_on_hold_rate asc\";\n\t$parameters['domain_uuid'] = $_SESSION['domain_uuid'];\n\t$database = new database;\n\t$streams = $database->select($sql, $parameters, 'all');\n\n//download music on hold file\n\tif (\n\t\t$_GET['action'] == \"download\"\n\t\t&& is_uuid($_GET['id'])\n\t\t&& is_array($streams)\n\t\t&& @sizeof($streams) != 0\n\t\t) {\n\t\t//get the uuid\n\t\t\t$stream_uuid = $_GET['id'];\n\n\t\t//get the record\n\t\t\tforeach($streams as $row) {\n\t\t\t\tif ($stream_uuid == $row['music_on_hold_uuid']) {\n\t\t\t\t\t$stream_domain_uuid = $row['domain_uuid'];\n\t\t\t\t\t$stream_name = $row['music_on_hold_name'];\n\t\t\t\t\t$stream_path = $row['music_on_hold_path'];\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\n\t\t//replace the sounds_dir variable in the path\n\t\t\t$stream_path = str_replace('$${sounds_dir}', $_SESSION['switch']['sounds']['dir'], $stream_path);\n\n\t\t//get the file\n\t\t\t$stream_file = base64_decode($_GET['file']);\n\t\t\t$stream_full_path = path_join($stream_path, $stream_file);\n\n\t\t//dowload the file\n\t\t\tsession_cache_limiter('public');\n\t\t\tif (file_exists($stream_full_path)) {\n\t\t\t\t$fd = fopen($stream_full_path, \"rb\");\n\t\t\t\tif ($_GET['t'] == \"bin\") {\n\t\t\t\t\theader(\"Content-Type: application/force-download\");\n\t\t\t\t\theader(\"Content-Type: application/octet-stream\");\n\t\t\t\t\theader(\"Content-Type: application/download\");\n\t\t\t\t\theader(\"Content-Description: File Transfer\");\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t$stream_file_ext = pathinfo($stream_file, PATHINFO_EXTENSION);\n\t\t\t\t\tswitch ($stream_file_ext) {\n\t\t\t\t\t\tcase \"wav\" : header(\"Content-Type: audio/x-wav\"); break;\n\t\t\t\t\t\tcase \"mp3\" : header(\"Content-Type: audio/mpeg\"); break;\n\t\t\t\t\t\tcase \"ogg\" : header(\"Content-Type: audio/ogg\"); break;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\theader('Content-Disposition: attachment; filename=\"'.$stream_file.'\"');\n\t\t\t\theader(\"Cache-Control: no-cache, must-revalidate\"); // HTTP/1.1\n\t\t\t\theader(\"Expires: Sat, 26 Jul 1997 05:00:00 GMT\"); // Date in the past\n\t\t\t\theader(\"Content-Length: \".filesize($stream_full_path));\n\t\t\t\tfpassthru($fd);\n\t\t\t}\n\t\t\texit;\n\t}\n\n//upload music on hold file\n\tif (\n\t\t$_POST['action'] == 'upload'\n\t\t&& is_array($_FILES)\n\t\t&& is_uploaded_file($_FILES['file']['tmp_name'])\n\t\t&& is_array($streams)\n\t\t&& @sizeof($streams) != 0\n\t\t) {\n\n\t\t//determine name\n\t\t\tif ($_POST['name_new'] != '') {\n\t\t\t\t//set the action\n\t\t\t\t\t$action = 'add';\n\t\t\t\t//get the stream_name\n\t\t\t\t\t$stream_name = $_POST['name_new'];\n\t\t\t\t//get the rate\n\t\t\t\t\t$stream_rate = is_numeric($_POST['rate']) ? $_POST['rate'] : '';\n\t\t\t}\n\t\t\telse {\n\t\t\t\t//get the stream uuid\n\t\t\t\t\t$stream_uuid = $_POST['name'];\n\t\t\t\t//find the matching stream\n\t\t\t\t\tforeach ($streams as $row) {\n\t\t\t\t\t\tif ($stream_uuid == $row['music_on_hold_uuid']) {\n\t\t\t\t\t\t\t//set the action\n\t\t\t\t\t\t\t\t$action = 'update';\n\t\t\t\t\t\t\t//set the variables\n\t\t\t\t\t\t\t\t$stream_domain_uuid = $row['domain_uuid'];\n\t\t\t\t\t\t\t\t$stream_name = $row['music_on_hold_name'];\n\t\t\t\t\t\t\t\t$stream_path = $row['music_on_hold_path'];\n\t\t\t\t\t\t\t\t$stream_rate = $row['music_on_hold_rate'];\n\t\t\t\t\t\t\t\t$stream_shuffle = $row['music_on_hold_shuffle'];\n\t\t\t\t\t\t\t\t$stream_channels = $row['music_on_hold_channels'];\n\t\t\t\t\t\t\t\t$stream_internal = $row['music_on_hold_interval'];\n\t\t\t\t\t\t\t\t$stream_timer_name = $row['music_on_hold_timer_name'];\n\t\t\t\t\t\t\t\t$stream_chime_list = $row['music_on_hold_chime_list'];\n\t\t\t\t\t\t\t\t$stream_chime_freq = $row['music_on_hold_chime_freq'];\n\t\t\t\t\t\t\t\t$stream_chime_max = $row['music_on_hold_chime_max'];\n\t\t\t\t\t\t\t\t$stream_rate = $row['music_on_hold_rate'];\n\t\t\t\t\t\t\t//end the loop\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t}\n\n\t\t//get remaining values\n\t\t\t$stream_file_name_temp = $_FILES['file']['tmp_name'];\n\t\t\t$stream_file_name = $_FILES['file']['name'];\n\t\t\t$stream_file_ext = strtolower(pathinfo($stream_file_name, PATHINFO_EXTENSION));\n\n\t\t//check file type\n\t\t\t$valid_file_type = ($stream_file_ext == 'wav' || $stream_file_ext == 'mp3' || $stream_file_ext == 'ogg') ? true : false;\n\n\t\t//process, if possible\n\t\t\tif (!$valid_file_type) {\n\t\t\t\tmessage::add($text['message-unsupported_file_type']);\n\t\t\t}\n\t\t\telse {\n\n\t\t\t\t//add the new stream\n\t\t\t\t\tif ($action == \"add\") {\n\n\t\t\t\t\t\t//strip slashes, replace spaces\n\t\t\t\t\t\t\t$slashes = array(\"/\", \"\\\\\");\n\t\t\t\t\t\t\t$stream_name = str_replace($slashes, '', $stream_name);\n\t\t\t\t\t\t\t$stream_name = str_replace(' ', '_', $stream_name);\n\t\t\t\t\t\t\t$stream_file_name = str_replace($slashes, '', $stream_file_name);\n\t\t\t\t\t\t\t$stream_file_name = str_replace(' ', '-', $stream_file_name);\n\n\t\t\t\t\t\t//detect auto rate\n\t\t\t\t\t\t\tif ($stream_rate == '') {\n\t\t\t\t\t\t\t\t$path_rate = '48000';\n\t\t\t\t\t\t\t\t$stream_rate_auto = true;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t$path_rate = $stream_rate;\n\t\t\t\t\t\t\t\t$stream_rate_auto = false;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t//define default path\n\t\t\t\t\t\t\t$stream_path = path_join($_SESSION['switch']['sounds']['dir'], 'music', $_SESSION['domain_name'],$stream_name, $path_rate);\n\n\t\t\t\t\t\t//find whether the path already exists\n\t\t\t\t\t\t\t$stream_new_name = true;\n\t\t\t\t\t\t\tforeach ($streams as $row) {\n\t\t\t\t\t\t\t\t$alternate_path = str_replace('$${sounds_dir}', $_SESSION['switch']['sounds']['dir'], $row['music_on_hold_path']);\n\t\t\t\t\t\t\t\tif ($stream_path == $row['music_on_hold_path']\n\t\t\t\t\t\t\t\t\t|| $stream_path == $alternate_path) {\n\t\t\t\t\t\t\t\t\t$stream_new_name = false;\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t//set the variables\n\t\t\t\t\t\t\t$stream_path = str_replace('$${sounds_dir}', $_SESSION['switch']['sounds']['dir'], $stream_path);\n\n\t\t\t\t\t\t//execute query\n\t\t\t\t\t\t\tif ($stream_new_name) {\n\t\t\t\t\t\t\t\t$stream_uuid = uuid();\n\t\t\t\t\t\t\t\t$array['music_on_hold'][0]['music_on_hold_uuid'] = $stream_uuid;\n\t\t\t\t\t\t\t\t$array['music_on_hold'][0]['domain_uuid'] = $domain_uuid;\n\t\t\t\t\t\t\t\t$array['music_on_hold'][0]['music_on_hold_name'] = $stream_name;\n\t\t\t\t\t\t\t\t$array['music_on_hold'][0]['music_on_hold_path'] = $stream_path;\n\t\t\t\t\t\t\t\t$array['music_on_hold'][0]['music_on_hold_rate'] = strlen($stream_rate) != 0 ? $stream_rate : null;\n\t\t\t\t\t\t\t\t$array['music_on_hold'][0]['music_on_hold_shuffle'] = 'false';\n\t\t\t\t\t\t\t\t$array['music_on_hold'][0]['music_on_hold_channels'] = 1;\n\t\t\t\t\t\t\t\t$array['music_on_hold'][0]['music_on_hold_interval'] = 20;\n\t\t\t\t\t\t\t\t$array['music_on_hold'][0]['music_on_hold_timer_name'] = 'soft';\n\t\t\t\t\t\t\t\t$array['music_on_hold'][0]['music_on_hold_chime_list'] = null;\n\t\t\t\t\t\t\t\t$array['music_on_hold'][0]['music_on_hold_chime_freq'] = null;\n\t\t\t\t\t\t\t\t$array['music_on_hold'][0]['music_on_hold_chime_max'] = null;\n\n\t\t\t\t\t\t\t\t$p = new permissions;\n\t\t\t\t\t\t\t\t$p->add('music_on_hold_add', 'temp');\n\n\t\t\t\t\t\t\t\t$database = new database;\n\t\t\t\t\t\t\t\t$database->app_name = 'music_on_hold';\n\t\t\t\t\t\t\t\t$database->app_uuid = '1dafe0f8-c08a-289b-0312-15baf4f20f81';\n\t\t\t\t\t\t\t\t$database->save($array);\n\t\t\t\t\t\t\t\tunset($array);\n\n\t\t\t\t\t\t\t\t$p->delete('music_on_hold_add', 'temp');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t//check target folder, move uploaded file\n\t\t\t\t\tif (!is_dir($stream_path)) {\n\t\t\t\t\t\tevent_socket_mkdir($stream_path);\n\t\t\t\t\t}\n\t\t\t\t\tif (is_dir($stream_path)) {\n\t\t\t\t\t\tif (copy($stream_file_name_temp, $stream_path.'/'.$stream_file_name)) {\n\t\t\t\t\t\t\t@unlink($stream_file_name_temp);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t//set message\n\t\t\t\t\tmessage::add($text['message-upload_completed']);\n\t\t\t}\n\n\t\t//require_once \"app/music_on_hold/resources/classes/switch_music_on_hold.php\";\n\t\t\t$music = new switch_music_on_hold;\n\t\t\t$music->reload();\n\n\t\t//redirect\n\t\t\theader(\"Location: music_on_hold.php\");\n\t\t\texit;\n\t}\n\n//delete the music on hold file\n\tif (\n\t\t$_GET['action'] == \"delete\"\n\t\t&& is_uuid($_GET['id'])\n\t\t&& is_array($streams)\n\t\t&& @sizeof($streams) != 0\n\t\t) {\n\n\t\t//get submitted values\n\t\t\t$stream_uuid = $_GET['id'];\n\t\t\t$stream_file = base64_decode($_GET['file']);\n\n\t\t//get the record\n\t\t\tforeach($streams as $row) {\n\t\t\t\tif ($stream_uuid == $row['music_on_hold_uuid']) {\n\t\t\t\t\t$stream_domain_uuid = $row['domain_uuid'];\n\t\t\t\t\t$stream_name = $row['music_on_hold_name'];\n\t\t\t\t\t$stream_path = $row['music_on_hold_path'];\n\t\t\t\t\t$stream_rate = $row['music_on_hold_rate'];\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t//check permissions\n\t\t\tif (($stream_domain_uuid == '' && permission_exists('music_on_hold_domain')) ||\n\t\t\t\t($stream_domain_uuid != '' && permission_exists('music_on_hold_delete'))) {\n\n\t\t\t\t//remove specified file\n\t\t\t\t\tif ($stream_file != '') {\n\t\t\t\t\t\t@unlink(path_join($stream_path, $stream_file));\n\t\t\t\t\t}\n\t\t\t\t//remove all audio files\n\t\t\t\t\telse {\n\t\t\t\t\t\tarray_map('unlink', glob(path_join($stream_path, '*.wav')));\n\t\t\t\t\t\tarray_map('unlink', glob(path_join($stream_path, '*.mp3')));\n\t\t\t\t\t\tarray_map('unlink', glob(path_join($stream_path, '*.ogg')));\n\t\t\t\t\t}\n\t\t\t\t//reload moh\n\t\t\t\t\t$music = new switch_music_on_hold;\n\t\t\t\t\t$music->reload();\n\t\t\t\t//set message\n\t\t\t\t\tmessage::add($text['message-delete']);\n\t\t\t}\n\n\t\t//redirect\n\t\t\theader(\"Location: music_on_hold.php\");\n\t\t\texit;\n\t}\n\n//include the header\n\trequire_once \"resources/header.php\";\n\t$document['title'] = $text['title-music_on_hold'];\n\n\techo \"<script language='JavaScript' type='text/javascript'>\\n\";\n\n\techo \"\tfunction check_filetype(file_input) {\\n\";\n\techo \"\t\tfile_ext = file_input.value.substr((~-file_input.value.lastIndexOf('.') >>> 0) + 2);\\n\";\n\techo \"\t\tif (file_ext != 'mp3' && file_ext != 'wav' && file_ext != 'ogg' && file_ext != '') {\\n\";\n\techo \"\t\t\tdisplay_message(\\\"\".$text['message-unsupported_file_type'].\"\\\", 'negative', '2750');\\n\";\n\techo \"\t\t}\\n\";\n\techo \"\t\tvar selected_file_path = file_input.value;\\n\";\n\techo \"\t\tselected_file_path = selected_file_path.replace(\\\"C:\\\\\\\\fakepath\\\\\\\\\\\",'');\\n\";\n\techo \"\t\tdocument.getElementById('file_label').innerHTML = selected_file_path;\\n\";\n\techo \"\t}\\n\";\n\n\techo \"\tfunction name_mode(mode) {\\n\";\n\techo \"\t\tif (mode == 'new') {\\n\";\n\techo \"\t\t\tdocument.getElementById('name_select').style.display='none';\\n\";\n\techo \"\t\t\tdocument.getElementById('btn_new').style.display='none';\\n\";\n\techo \"\t\t\tdocument.getElementById('name_new').style.display='';\\n\";\n\techo \"\t\t\tdocument.getElementById('btn_select').style.display='';\\n\";\n\techo \"\t\t\tdocument.getElementById('name_new').focus();\\n\";\n\techo \"\t\t}\\n\";\n\techo \"\t\telse if (mode == 'select') {\\n\";\n\techo \"\t\t\tdocument.getElementById('name_new').style.display='none';\\n\";\n\techo \"\t\t\tdocument.getElementById('name_new').value = '';\\n\";\n\techo \"\t\t\tdocument.getElementById('btn_select').style.display='none';\\n\";\n\techo \"\t\t\tdocument.getElementById('name_select').selectedIndex = 0;\\n\";\n\techo \"\t\t\tdocument.getElementById('name_select').style.display='';\\n\";\n\techo \"\t\t\tdocument.getElementById('btn_new').style.display='';\\n\";\n\techo \"\t\t}\\n\";\n\techo \"\t}\\n\";\n\n\techo \"</script>\\n\";\n\techo \"<script language='JavaScript' type='text/javascript' src='\".PROJECT_PATH.\"/resources/javascript/reset_file_input.js'></script>\\n\";\n\n\techo \"<b>\".$text['label-music_on_hold'].\"</b>\";\n\techo \"<br /><br />\\n\";\n\techo $text['desc-music_on_hold'].\"\\n\";\n\techo \"<br /><br />\\n\";\n\n//show the upload form\n\tif (permission_exists('music_on_hold_add')) {\n\t\techo \"<b>\".$text['label-upload-music_on_hold'].\"</b>\\n\";\n\t\techo \"<br><br>\\n\";\n\n\t\techo \"<form name='frm' id='frm' method='post' enctype='multipart/form-data'>\\n\";\n\t\techo \"<input name='action' type='hidden' value='upload'>\\n\";\n\n\t\techo \"<table width='100%' border='0' cellpadding='0' cellspacing='0'>\\n\";\n\t\techo \"<tr>\\n\";\n\n\t\techo \"<td width='40%' style='vertical-align: top;'>\\n\";\n\n\t\techo \"\t<table width='100%' border='0' cellpadding='0' cellspacing='0'>\\n\";\n\t\techo \"\t\t<tr>\\n\";\n\t\techo \"\t\t\t<td class='vncell' width='30%' valign='top' nowrap='nowrap'>\\n\";\n\t\techo \"\t\t\t\t\".$text['label-category'].\"\\n\";\n\t\techo \"\t\t\t</td>\\n\";\n\t\techo \"\t\t\t<td class='vtable' width='70%' style='white-space: nowrap;'>\\n\";\n\t\techo \"\t\t\t\t<select name='name' id='name_select' class='formfld' style='width: auto;'>\\n\";\n\n\t\tif (permission_exists('music_on_hold_domain')) {\n\t\t\techo \"\t\t\t\t\t<optgroup label='\".$text['option-global'].\"'>\\n\";\n\t\t\tforeach ($streams as $row) {\n\t\t\t\tif (strlen($row['domain_uuid']) == 0) {\n\t\t\t\t\tif (strlen($row['music_on_hold_rate']) == 0) { $option_name = $row['music_on_hold_name']; }\n\t\t\t\t\tif (strlen($row['music_on_hold_rate']) > 0) { $option_name = $row['music_on_hold_name'] .'/'.$row['music_on_hold_rate']; }\n\t\t\t\t\techo \"\t\t\t\t\t\t<option value='\".escape($row['music_on_hold_uuid']).\"'>\".escape($option_name).\"</option>\\n\";\n\t\t\t\t}\n\t\t\t}\n\t\t\techo \"\t\t\t\t\t</optgroup>\\n\";\n\t\t}\n\t\tif (permission_exists('music_on_hold_domain')) {\n\t\t\techo \"\t\t\t\t\t<optgroup label='\".$text['option-local'].\"'>\\n\";\n\t\t}\n\t\tforeach ($streams as $row) {\n\t\t\tif (strlen($row['domain_uuid']) > 0) {\n\t\t\tif (strlen($row['music_on_hold_rate']) == 0) { $option_name = $row['music_on_hold_name']; }\n\t\t\tif (strlen($row['music_on_hold_rate']) > 0) { $option_name = $row['music_on_hold_name'] .'/'.$row['music_on_hold_rate']; }\n\t\t\t\techo \"\t\t\t\t\t\t<option value='\".escape($row['music_on_hold_uuid']).\"'>\".escape($option_name).\"</option>\\n\";\n\t\t\t}\n\t\t}\n\t\tif (permission_exists('music_on_hold_domain')) {\n\t\t\techo \"\t\t\t\t\t</optgroup>\\n\";\n\t\t}\n\n\t\techo \"\t\t\t\t</select>\";\n\n\t\techo \"\t\t\t\t<button type='button' id='btn_new' class='btn btn-default list_control_icon' style='margin-left: 3px;' onclick=\\\"name_mode('new');\\\"><span class='glyphicon glyphicon-plus'></span></button>\";\n\t\techo \"\t\t\t\t<input class='formfld' style='width: 100px; display: none;' type='text' name='name_new' id='name_new' maxlength='255' value=''>\";\n\t\techo \"\t\t\t\t<button type='button' id='btn_select' class='btn btn-default list_control_icon' style='display: none; margin-left: 3px;' onclick=\\\"name_mode('select');\\\"><span class='glyphicon glyphicon-list-alt'></span></button>\";\n\t\techo \"\t\t\t</td>\\n\";\n\t\techo \"\t\t</tr>\\n\";\n\t\techo \"\t</table>\\n\";\n\n\t\techo \"</td>\\n\";\n\t\techo \"<td width='30%' style='vertical-align: top;'>\\n\";\n\n\t\techo \"\t<table width='100%' border='0' cellpadding='0' cellspacing='0'>\\n\";\n\t\techo \"\t\t<tr>\\n\";\n\t\techo \"\t\t\t<td class='vncell' width='30%' valign='top' nowrap='nowrap'>\\n\";\n\t\techo \"\t\t\t\t\".$text['label-rate'].\"\\n\";\n\t\techo \"\t\t\t</td>\\n\";\n\t\techo \"\t\t\t<td class='vtable' width='70%'>\\n\";\n\t\techo \"\t\t\t\t<select id='rate' name='rate' class='formfld' style='width: auto;'>\\n\";\n\t\techo \"\t\t\t\t\t<option value=''>\".$text['option-default'].\"</option>\\n\";\n\t\techo \"\t\t\t\t\t<option value='8000'>8 kHz</option>\\n\";\n\t\techo \"\t\t\t\t\t<option value='16000'>16 kHz</option>\\n\";\n\t\techo \"\t\t\t\t\t<option value='32000'>32 kHz</option>\\n\";\n\t\techo \"\t\t\t\t\t<option value='48000'>48 kHz</option>\\n\";\n\t\techo \"\t\t\t\t</select>\\n\";\n\t\techo \"\t\t\t</td>\\n\";\n\t\techo \"\t\t</tr>\\n\";\n\t\techo \"\t</table>\\n\";\n\n\t\techo \"</td>\\n\";\n\t\techo \"<td width='30%' style='vertical-align: top;'>\\n\";\n\n\t\techo \"\t<table width='100%' border='0' cellpadding='0' cellspacing='0'>\\n\";\n\t\techo \"\t\t<tr>\\n\";\n\t\techo \"\t\t\t<td class='vncell' width='30%' valign='top' nowrap='nowrap'>\\n\";\n\t\techo \"\t\t\t\t\".$text['label-file-path'];\n\t\techo \"\t\t\t</td>\\n\";\n\t\techo \"\t\t\t<td class='vtable' width='70%'>\\n\";\n\t\techo \"\t\t\t\t<input name='file' id='file' type='file' style='display: none;' onchange=\\\"check_filetype(this);\\\">\";\n\t\techo \"\t\t\t\t<label id='file_label' for='file' class='txt' style='width: 150px; overflow: hidden; white-space: nowrap;'>\".$text['label-select_a_file'].\"</label>\\n\";\n\t\techo \"\t\t\t</td>\\n\";\n\t\techo \"\t\t</tr>\\n\";\n\t\techo \"\t</table>\\n\";\n\n\t\techo \"</td>\\n\";\n\n\t\techo \"</tr>\\n\";\n\t\techo \"</table>\\n\";\n\n\t\techo \"<div style='float: right; margin-top: 6px;'>\";\n\t\techo \"\t<input type='reset' class='btn' value='\".$text['button-reset'].\"' onclick=\\\"reset_file_input('file'); document.getElementById('file_label').innerHTML = '\".$text['label-select_a_file'].\"'; name_mode('select'); return true;\\\">\\n\";\n\t\techo \"\t<input name='submit' type='submit' class='btn' id='upload' value='\".$text['button-upload'].\"'>\\n\";\n\t\techo \"</div>\\n\";\n\n\t\techo \"</form>\\n\";\n\t}\n\n//set the row styles\n\t$c = 0;\n\t$row_style[\"0\"] = \"row_style0\";\n\t$row_style[\"1\"] = \"row_style1\";\n\n//set the variable with an empty string\n\t$previous_name = '';\n\n//show the array of data\n\tif (is_array($streams) && @sizeof($streams) != 0) {\n\n\t\t//start the table\n\t\t\techo \"<table class='tr_hover' width='100%' border='0' cellpadding='0' cellspacing='0' style='margin-bottom: 3px;'>\\n\";\n\n\t\t//loop through the array\n\t\t\tforeach ($streams as $row) {\n\n\t\t\t\t//set the variables\n\t\t\t\t\t$music_on_hold_name = $row['music_on_hold_name'];\n\t\t\t\t\t$music_on_hold_rate = $row['music_on_hold_rate'];\n\n\t\t\t\t\t$stream_rate = $row['music_on_hold_rate'];\n\n\t\t\t\t//add vertical space\n\t\t\t\t\techo \"<tr class='tr_link_void'><td colspan='5'><div style='width: 1px; height: 10px;'></div></td></tr>\\n\";\n\n\t\t\t\t//add the name\n\t\t\t\t\tif ($previous_name != $music_on_hold_name) {\n\t\t\t\t\t\techo \"<tr class='tr_link_void'><td colspan='5'><div style='width: 1px; height: 20px;'></div></td></tr>\\n\";\n\t\t\t\t\t\techo \"<tr class='tr_link_void'>\\n\";\n\t\t\t\t\t\techo \"\t<td colspan='5'><b><i>\".escape($music_on_hold_name).\"</i></b>\";\n\t\t\t\t\t\tif ($row['domain_uuid'] == null) { \n\t\t\t\t\t\t\techo \"&nbsp;&nbsp;- \".$text['label-global'].\"\\n\";\n\t\t\t\t\t\t}\n\t\t\t\t\t\techo \"\t</td>\\n\";\n\t\t\t\t\t\techo \"</tr>\\n\";\n\t\t\t\t\t}\n\n\t\t\t\t//determine if rate was set to auto or not\n\t\t\t\t\t$auto_rate = (strlen($music_on_hold_rate) == 0) ? true : false;\n\n\t\t\t\t//determine icons to show\n\t\t\t\t\t$stream_icons = array();\n\t\t\t\t\t$i = 0;\n\t\t\t\t\tif (permission_exists('music_on_hold_path')) {\n\t\t\t\t\t\t$stream_icons[$i]['glyphicon'] = 'glyphicon-folder-open';\n\t\t\t\t\t\t$stream_icons[$i]['title'] = $row['music_on_hold_name'];\n\t\t\t\t\t\t$i++;\n\t\t\t\t\t}\n\t\t\t\t\tif ($row['music_on_hold_shuffle'] == 'true') {\n\t\t\t\t\t\t$stream_icons[$i]['glyphicon'] = 'glyphicon-random';\n\t\t\t\t\t\t$stream_icons[$i]['title'] = $text['label-shuffle'];\n\t\t\t\t\t\t$i++;\n\t\t\t\t\t}\n\t\t\t\t\tif ($row['music_on_hold_chime_list'] != '') {\n\t\t\t\t\t\t$stream_icons[$i]['glyphicon'] = 'glyphicon-bell';\n\t\t\t\t\t\t$stream_icons[$i]['title'] = $text['label-chime_list'].': '.$row['music_on_hold_chime_list'];\n\t\t\t\t\t\t$i++;\n\t\t\t\t\t}\n\t\t\t\t\tif ($row['music_on_hold_channels'] == '2') {\n\t\t\t\t\t\t$stream_icons[$i]['glyphicon'] = 'glyphicon-headphones';\n\t\t\t\t\t\t$stream_icons[$i]['title'] = $text['label-stereo'];\n\t\t\t\t\t\t$stream_icons[$i]['margin'] = 6;\n\t\t\t\t\t\t$i++;\n\t\t\t\t\t}\n\t\t\t\t\tif (is_array($stream_icons) && sizeof($stream_icons) > 0) {\n\t\t\t\t\t\tforeach ($stream_icons as $stream_icon) {\n\t\t\t\t\t\t\t$icons .= \"<span class='glyphicon \".$stream_icon['glyphicon'].\" icon_glyphicon_body' title='\".escape($stream_icon['title']).\"' style='width: 12px; height: 12px; margin-left: \".(($stream_icon['margin'] != '') ? $stream_icon['margin'] : 8).\"px; vertical-align: text-top; cursor: help;'></span>\";\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t//set the rate label\n\t\t\t\t\tif ($auto_rate) {\n\t\t\t\t\t\t$stream_details = $text['option-default'].' '.$icons;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\t$stream_details = ($music_on_hold_rate/1000).' kHz / '.$icons;\n\t\t\t\t\t}\n\t\t\t\n\t\t\t\t//show the table header\n\t\t\t\t\techo \"\t<tr>\\n\";\n\t\t\t\t\techo \"\t\t<th class='listhdr'>\".$stream_details.\"</th>\\n\";\n\t\t\t\t\techo \"\t\t<th class='listhdr' style='width: 55px;'>\".$text['label-tools'].\"</th>\\n\";\n\t\t\t\t\techo \"\t\t<th class='listhdr' style='width: 65px; text-align: right; white-space: nowrap;'>\".$text['label-file-size'].\"</th>\\n\";\n\t\t\t\t\techo \"\t\t<th class='listhdr' style='width: 150px; text-align: right;'>\".$text['label-uploaded'].\"</th>\\n\";\n\t\t\t\t\techo \"\t\t<td class='\".((!permission_exists('music_on_hold_domain')) ? 'list_control_icon' : 'list_control_icons').\" tr_link_void'>\";\n\t\t\t\t\tif (permission_exists('music_on_hold_edit')) {\n\t\t\t\t\t\techo \"<a href='music_on_hold_edit.php?id=\".escape($row['music_on_hold_uuid']).\"' alt='\".$text['button-edit'].\"'>$v_link_label_edit</a>\";\n\t\t\t\t\t}\n\t\t\t\t\tif (permission_exists('music_on_hold_delete')) {\n\t\t\t\t\t\techo \"<a href='music_on_hold_delete.php?id=\".escape($row['music_on_hold_uuid']).\"' alt='\".$text['button-delete'].\"' onclick=\\\"return confirm('\".$text['confirm-delete'].\"')\\\">$v_link_label_delete</a>\";\n\t\t\t\t\t}\n\t\t\t\t\techo \t\t\"</td>\\n\";\n\t\t\t\t\techo \"\t</tr>\";\n\t\t\t\t\tunset($stream_icons, $icons);\n\n\t\t\t\t//add the uuid of to the link\n\t\t\t\t\tif (permission_exists('music_on_hold_edit')) {\n\t\t\t\t\t\t$tr_link = \"href='music_on_hold_edit.php?id=\".escape($row['music_on_hold_uuid']).\"'\";\n\t\t\t\t\t}\n\n\t\t\t\t//get the music on hold path\n\t\t\t\t\t$stream_path = $row['music_on_hold_path'];\n\t\t\t\t\t$stream_path = str_replace(\"\\$\\${sounds_dir}\",$_SESSION['switch']['sounds']['dir'], $stream_path);\n\n\t\t\t\t//show the files\n\t\t\t\t\tif (file_exists($stream_path)) {\n\t\t\t\t\t\t$stream_files = array_merge(glob($stream_path.'/*.wav'), glob($stream_path.'/*.mp3'), glob($stream_path.'/*.ogg'));\n\t\t\t\t\t\tif (is_array($stream_files) && @sizeof($stream_files) != 0) {\n\t\t\t\t\t\t\tforeach ($stream_files as $stream_file_path) {\n\t\t\t\t\t\t\t\t$stream_file = pathinfo($stream_file_path, PATHINFO_BASENAME);\n\t\t\t\t\t\t\t\t$stream_file_size = byte_convert(filesize($stream_file_path));\n\t\t\t\t\t\t\t\t$stream_file_date = date(\"M d, Y H:i:s\", filemtime($stream_file_path));\n\t\t\t\t\t\t\t\t$stream_file_ext = pathinfo($stream_file, PATHINFO_EXTENSION);\n\t\t\t\t\t\t\t\tswitch ($stream_file_ext) {\n\t\t\t\t\t\t\t\t\tcase \"wav\" : $stream_file_type = \"audio/wav\"; break;\n\t\t\t\t\t\t\t\t\tcase \"mp3\" : $stream_file_type = \"audio/mpeg\"; break;\n\t\t\t\t\t\t\t\t\tcase \"ogg\" : $stream_file_type = \"audio/ogg\"; break;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t$row_uuid = uuid();\n\t\t\t\t\t\t\t\techo \"<tr id='recording_progress_bar_\".$row_uuid.\"' style='display: none;'><td colspan='4' class='\".$row_style[$c].\" playback_progress_bar_background' style='padding: 0; border: none;'><span class='playback_progress_bar' id='recording_progress_\".$row_uuid.\"'></span></td></tr>\\n\";\n\t\t\t\t\t\t\t\t$tr_link = \"href=\\\"javascript:recording_play('\".$row_uuid.\"');\\\"\";\n\t\t\t\t\t\t\t\techo \"<tr \".$tr_link.\">\\n\";\n\t\t\t\t\t\t\t\techo \"\t<td class='\".$row_style[$c].\"'>\".escape($stream_file).\"</td>\\n\";\n\t\t\t\t\t\t\t\techo \"\t<td valign='top' class='\".$row_style[$c].\" row_style_slim tr_link_void'>\";\n\t\t\t\t\t\t\t\techo \t\t\"<audio id='recording_audio_\".$row_uuid.\"' style='display: none;' preload='none' ontimeupdate=\\\"update_progress('\".$row_uuid.\"')\\\" onended=\\\"recording_reset('\".$row_uuid.\"');\\\" src='?action=download&id=\".escape($row['music_on_hold_uuid']).\"&file=\".base64_encode($stream_file).\"' type='\".escape($stream_file_type).\"'></audio>\";\n\t\t\t\t\t\t\t\techo \t\t\"<span id='recording_button_\".$row_uuid.\"' onclick=\\\"recording_play('\".$row_uuid.\"')\\\" title='\".$text['label-play'].\" / \".$text['label-pause'].\"'>\".$v_link_label_play.\"</span>\";\n\t\t\t\t\t\t\t\techo \t\t\"<span onclick=\\\"recording_stop('\".$row_uuid.\"')\\\" title='\".$text['label-stop'].\"'>\".$v_link_label_stop.\"</span>\";\n\t\t\t\t\t\t\t\techo \"\t</td>\\n\";\n\t\t\t\t\t\t\t\techo \"\t<td valign='top' class='\".$row_style[$c].\"' style='text-align: right; white-space: nowrap;'>\".escape($stream_file_size).\"</td>\\n\";\n\t\t\t\t\t\t\t\techo \"\t<td valign='top' class='\".$row_style[$c].\"' style='text-align: right; white-space: nowrap;'>\".escape($stream_file_date).\"</td>\\n\";\n\t\t\t\t\t\t\t\techo \"\t<td valign='top' class='\".((!permission_exists('music_on_hold_domain')) ? 'list_control_icon' : 'list_control_icons').\"'>\\n\";\n\t\t\t\t\t\t\t\techo \t\t\"<a href='?action=download&id=\".escape($row['music_on_hold_uuid']).\"&file=\".base64_encode($stream_file).\"' title='\".$text['label-download'].\"'>\".$v_link_label_download.\"</a>\";\n\t\t\t\t\t\t\t\tif ( (!is_uuid($domain_uuid) && permission_exists('music_on_hold_domain')) || (is_uuid($domain_uuid) && permission_exists('music_on_hold_delete')) ) {\n\t\t\t\t\t\t\t\t\techo \t\"<a href='?action=delete&id=\".escape($row['music_on_hold_uuid']).\"&file=\".base64_encode($stream_file).\"' onclick=\\\"return confirm('\".$text['confirm-delete'].\"')\\\">\".$v_link_label_delete.\"</a>\";\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\techo \"\t</td>\\n\";\n\t\t\t\t\t\t\t\techo \"</tr>\\n\";\n\t\t\t\t\t\t\t\t$c = ($c) ? 0 : 1;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t//set the previous music_on_hold_name\n\t\t\t\t\t$previous_name = $music_on_hold_name;\n\n\t\t\t\t//toggle the light highlighting\n\t\t\t\t\t$c = ($c) ? 0 : 1;\n\t\t\t}\n\t\t\tunset($streams, $row);\n\n\t\t//end the table\n\t\t\techo \"</table>\\n\";\n\n\t}\n\n\techo \"<tr>\\n\";\n\techo \"<td colspan='11' align='left'>\\n\";\n\techo \"\t<table width='100%' cellpadding='0' cellspacing='0'>\\n\";\n\techo \"\t<tr>\\n\";\n\techo \"\t\t<td width='33.3%' nowrap='nowrap'>&nbsp;</td>\\n\";\n\techo \"\t\t<td width='33.3%' align='center' nowrap='nowrap'>$paging_controls</td>\\n\";\n\techo \"\t\t<td class='list_control_icons'>\";\n\techo \"\t\t\t&nbsp;\";\n\techo \"\t\t</td>\\n\";\n\techo \"\t</tr>\\n\";\n \techo \"\t</table>\\n\";\n\techo \"</td>\\n\";\n\techo \"</tr>\\n\";\n\techo \"</table>\";\n\techo \"<br /><br />\";\n\n//include the footer\n\trequire_once \"resources/footer.php\";\n\n?>\n"], "fixing_code": ["<?php\n/*\n\tFusionPBX\n\tVersion: MPL 1.1\n\n\tThe contents of this file are subject to the Mozilla Public License Version\n\t1.1 (the \"License\"); you may not use this file except in compliance with\n\tthe License. You may obtain a copy of the License at\n\thttp://www.mozilla.org/MPL/\n\n\tSoftware distributed under the License is distributed on an \"AS IS\" basis,\n\tWITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n\tfor the specific language governing rights and limitations under the\n\tLicense.\n\n\tThe Original Code is FusionPBX\n\n\tThe Initial Developer of the Original Code is\n\tMark J Crane <markjcrane@fusionpbx.com>\n\tPortions created by the Initial Developer are Copyright (C) 2008-2016\n\tthe Initial Developer. All Rights Reserved.\n\n\tContributor(s):\n\tMark J Crane <markjcrane@fusionpbx.com>\n\tJames Rose <james.o.rose@gmail.com>\n*/\n\n//includes\n\tinclude \"root.php\";\n\trequire_once \"resources/require.php\";\n\n//check permissions\n\trequire_once \"resources/check_auth.php\";\n\tif (permission_exists('music_on_hold_view')) {\n\t\t//access granted\n\t}\n\telse {\n\t\techo \"access denied\";\n\t\texit;\n\t}\n\n//add multi-lingual support\n\t$language = new text;\n\t$text = $language->get();\n\n//increase the exucution time\n\tini_set('max_execution_time', 7200);\n\n//get the music_on_hold array\n\t$sql = \"select * from v_music_on_hold \";\n\t$sql .= \"where ( \";\n\t$sql .= \"domain_uuid = :domain_uuid \";\n\tif (permission_exists('music_on_hold_domain')) {\n\t\t$sql .= \"or domain_uuid is null \";\n\t}\n\t$sql .= \") \";\n\t$sql .= \"order by domain_uuid desc, music_on_hold_name asc, music_on_hold_rate asc\";\n\t$parameters['domain_uuid'] = $_SESSION['domain_uuid'];\n\t$database = new database;\n\t$streams = $database->select($sql, $parameters, 'all');\n\n//download music on hold file\n\tif (\n\t\t$_GET['action'] == \"download\"\n\t\t&& is_uuid($_GET['id'])\n\t\t&& is_array($streams)\n\t\t&& @sizeof($streams) != 0\n\t\t) {\n\t\t//get the uuid\n\t\t\t$stream_uuid = $_GET['id'];\n\n\t\t//get the record\n\t\t\tforeach($streams as $row) {\n\t\t\t\tif ($stream_uuid == $row['music_on_hold_uuid']) {\n\t\t\t\t\t$stream_domain_uuid = $row['domain_uuid'];\n\t\t\t\t\t$stream_name = $row['music_on_hold_name'];\n\t\t\t\t\t$stream_path = $row['music_on_hold_path'];\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\n\t\t//replace the sounds_dir variable in the path\n\t\t\t$stream_path = str_replace('$${sounds_dir}', $_SESSION['switch']['sounds']['dir'], $stream_path);\n\n\t\t//get the file\n\t\t\t$stream_file = base64_decode($_GET['file']);\n\t\t\t$stream_full_path = path_join($stream_path, $stream_file);\n\n\t\t//sanitize path\n\t\t\t$stream_full_path = str_replace('../', '', $stream_full_path);\n\n\t\t//dowload the file\n\t\t\tsession_cache_limiter('public');\n\t\t\tif (file_exists($stream_full_path)) {\n\t\t\t\t$fd = fopen($stream_full_path, \"rb\");\n\t\t\t\tif ($_GET['t'] == \"bin\") {\n\t\t\t\t\theader(\"Content-Type: application/force-download\");\n\t\t\t\t\theader(\"Content-Type: application/octet-stream\");\n\t\t\t\t\theader(\"Content-Type: application/download\");\n\t\t\t\t\theader(\"Content-Description: File Transfer\");\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t$stream_file_ext = pathinfo($stream_file, PATHINFO_EXTENSION);\n\t\t\t\t\tswitch ($stream_file_ext) {\n\t\t\t\t\t\tcase \"wav\" : header(\"Content-Type: audio/x-wav\"); break;\n\t\t\t\t\t\tcase \"mp3\" : header(\"Content-Type: audio/mpeg\"); break;\n\t\t\t\t\t\tcase \"ogg\" : header(\"Content-Type: audio/ogg\"); break;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\theader('Content-Disposition: attachment; filename=\"'.$stream_file.'\"');\n\t\t\t\theader(\"Cache-Control: no-cache, must-revalidate\"); // HTTP/1.1\n\t\t\t\theader(\"Expires: Sat, 26 Jul 1997 05:00:00 GMT\"); // Date in the past\n\t\t\t\theader(\"Content-Length: \".filesize($stream_full_path));\n\t\t\t\tfpassthru($fd);\n\t\t\t}\n\t\t\texit;\n\t}\n\n//upload music on hold file\n\tif (\n\t\t$_POST['action'] == 'upload'\n\t\t&& is_array($_FILES)\n\t\t&& is_uploaded_file($_FILES['file']['tmp_name'])\n\t\t&& is_array($streams)\n\t\t&& @sizeof($streams) != 0\n\t\t) {\n\n\t\t//determine name\n\t\t\tif ($_POST['name_new'] != '') {\n\t\t\t\t//set the action\n\t\t\t\t\t$action = 'add';\n\t\t\t\t//get the stream_name\n\t\t\t\t\t$stream_name = $_POST['name_new'];\n\t\t\t\t//get the rate\n\t\t\t\t\t$stream_rate = is_numeric($_POST['rate']) ? $_POST['rate'] : '';\n\t\t\t}\n\t\t\telse {\n\t\t\t\t//get the stream uuid\n\t\t\t\t\t$stream_uuid = $_POST['name'];\n\t\t\t\t//find the matching stream\n\t\t\t\t\tforeach ($streams as $row) {\n\t\t\t\t\t\tif ($stream_uuid == $row['music_on_hold_uuid']) {\n\t\t\t\t\t\t\t//set the action\n\t\t\t\t\t\t\t\t$action = 'update';\n\t\t\t\t\t\t\t//set the variables\n\t\t\t\t\t\t\t\t$stream_domain_uuid = $row['domain_uuid'];\n\t\t\t\t\t\t\t\t$stream_name = $row['music_on_hold_name'];\n\t\t\t\t\t\t\t\t$stream_path = $row['music_on_hold_path'];\n\t\t\t\t\t\t\t\t$stream_rate = $row['music_on_hold_rate'];\n\t\t\t\t\t\t\t\t$stream_shuffle = $row['music_on_hold_shuffle'];\n\t\t\t\t\t\t\t\t$stream_channels = $row['music_on_hold_channels'];\n\t\t\t\t\t\t\t\t$stream_internal = $row['music_on_hold_interval'];\n\t\t\t\t\t\t\t\t$stream_timer_name = $row['music_on_hold_timer_name'];\n\t\t\t\t\t\t\t\t$stream_chime_list = $row['music_on_hold_chime_list'];\n\t\t\t\t\t\t\t\t$stream_chime_freq = $row['music_on_hold_chime_freq'];\n\t\t\t\t\t\t\t\t$stream_chime_max = $row['music_on_hold_chime_max'];\n\t\t\t\t\t\t\t\t$stream_rate = $row['music_on_hold_rate'];\n\t\t\t\t\t\t\t//end the loop\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t}\n\n\t\t//get remaining values\n\t\t\t$stream_file_name_temp = $_FILES['file']['tmp_name'];\n\t\t\t$stream_file_name = $_FILES['file']['name'];\n\t\t\t$stream_file_ext = strtolower(pathinfo($stream_file_name, PATHINFO_EXTENSION));\n\n\t\t//check file type\n\t\t\t$valid_file_type = ($stream_file_ext == 'wav' || $stream_file_ext == 'mp3' || $stream_file_ext == 'ogg') ? true : false;\n\n\t\t//process, if possible\n\t\t\tif (!$valid_file_type) {\n\t\t\t\tmessage::add($text['message-unsupported_file_type']);\n\t\t\t}\n\t\t\telse {\n\n\t\t\t\t//add the new stream\n\t\t\t\t\tif ($action == \"add\") {\n\n\t\t\t\t\t\t//strip slashes, replace spaces\n\t\t\t\t\t\t\t$slashes = array(\"/\", \"\\\\\");\n\t\t\t\t\t\t\t$stream_name = str_replace($slashes, '', $stream_name);\n\t\t\t\t\t\t\t$stream_name = str_replace(' ', '_', $stream_name);\n\t\t\t\t\t\t\t$stream_file_name = str_replace($slashes, '', $stream_file_name);\n\t\t\t\t\t\t\t$stream_file_name = str_replace(' ', '-', $stream_file_name);\n\n\t\t\t\t\t\t//detect auto rate\n\t\t\t\t\t\t\tif ($stream_rate == '') {\n\t\t\t\t\t\t\t\t$path_rate = '48000';\n\t\t\t\t\t\t\t\t$stream_rate_auto = true;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t$path_rate = $stream_rate;\n\t\t\t\t\t\t\t\t$stream_rate_auto = false;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t//define default path\n\t\t\t\t\t\t\t$stream_path = path_join($_SESSION['switch']['sounds']['dir'], 'music', $_SESSION['domain_name'],$stream_name, $path_rate);\n\n\t\t\t\t\t\t//find whether the path already exists\n\t\t\t\t\t\t\t$stream_new_name = true;\n\t\t\t\t\t\t\tforeach ($streams as $row) {\n\t\t\t\t\t\t\t\t$alternate_path = str_replace('$${sounds_dir}', $_SESSION['switch']['sounds']['dir'], $row['music_on_hold_path']);\n\t\t\t\t\t\t\t\tif ($stream_path == $row['music_on_hold_path']\n\t\t\t\t\t\t\t\t\t|| $stream_path == $alternate_path) {\n\t\t\t\t\t\t\t\t\t$stream_new_name = false;\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t//set the variables\n\t\t\t\t\t\t\t$stream_path = str_replace('$${sounds_dir}', $_SESSION['switch']['sounds']['dir'], $stream_path);\n\n\t\t\t\t\t\t//execute query\n\t\t\t\t\t\t\tif ($stream_new_name) {\n\t\t\t\t\t\t\t\t$stream_uuid = uuid();\n\t\t\t\t\t\t\t\t$array['music_on_hold'][0]['music_on_hold_uuid'] = $stream_uuid;\n\t\t\t\t\t\t\t\t$array['music_on_hold'][0]['domain_uuid'] = $domain_uuid;\n\t\t\t\t\t\t\t\t$array['music_on_hold'][0]['music_on_hold_name'] = $stream_name;\n\t\t\t\t\t\t\t\t$array['music_on_hold'][0]['music_on_hold_path'] = $stream_path;\n\t\t\t\t\t\t\t\t$array['music_on_hold'][0]['music_on_hold_rate'] = strlen($stream_rate) != 0 ? $stream_rate : null;\n\t\t\t\t\t\t\t\t$array['music_on_hold'][0]['music_on_hold_shuffle'] = 'false';\n\t\t\t\t\t\t\t\t$array['music_on_hold'][0]['music_on_hold_channels'] = 1;\n\t\t\t\t\t\t\t\t$array['music_on_hold'][0]['music_on_hold_interval'] = 20;\n\t\t\t\t\t\t\t\t$array['music_on_hold'][0]['music_on_hold_timer_name'] = 'soft';\n\t\t\t\t\t\t\t\t$array['music_on_hold'][0]['music_on_hold_chime_list'] = null;\n\t\t\t\t\t\t\t\t$array['music_on_hold'][0]['music_on_hold_chime_freq'] = null;\n\t\t\t\t\t\t\t\t$array['music_on_hold'][0]['music_on_hold_chime_max'] = null;\n\n\t\t\t\t\t\t\t\t$p = new permissions;\n\t\t\t\t\t\t\t\t$p->add('music_on_hold_add', 'temp');\n\n\t\t\t\t\t\t\t\t$database = new database;\n\t\t\t\t\t\t\t\t$database->app_name = 'music_on_hold';\n\t\t\t\t\t\t\t\t$database->app_uuid = '1dafe0f8-c08a-289b-0312-15baf4f20f81';\n\t\t\t\t\t\t\t\t$database->save($array);\n\t\t\t\t\t\t\t\tunset($array);\n\n\t\t\t\t\t\t\t\t$p->delete('music_on_hold_add', 'temp');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t//check target folder, move uploaded file\n\t\t\t\t\tif (!is_dir($stream_path)) {\n\t\t\t\t\t\tevent_socket_mkdir($stream_path);\n\t\t\t\t\t}\n\t\t\t\t\tif (is_dir($stream_path)) {\n\t\t\t\t\t\tif (copy($stream_file_name_temp, $stream_path.'/'.$stream_file_name)) {\n\t\t\t\t\t\t\t@unlink($stream_file_name_temp);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t//set message\n\t\t\t\t\tmessage::add($text['message-upload_completed']);\n\t\t\t}\n\n\t\t//require_once \"app/music_on_hold/resources/classes/switch_music_on_hold.php\";\n\t\t\t$music = new switch_music_on_hold;\n\t\t\t$music->reload();\n\n\t\t//redirect\n\t\t\theader(\"Location: music_on_hold.php\");\n\t\t\texit;\n\t}\n\n//delete the music on hold file\n\tif (\n\t\t$_GET['action'] == \"delete\"\n\t\t&& is_uuid($_GET['id'])\n\t\t&& is_array($streams)\n\t\t&& @sizeof($streams) != 0\n\t\t) {\n\n\t\t//get submitted values\n\t\t\t$stream_uuid = $_GET['id'];\n\t\t\t$stream_file = base64_decode($_GET['file']);\n\n\t\t//get the record\n\t\t\tforeach($streams as $row) {\n\t\t\t\tif ($stream_uuid == $row['music_on_hold_uuid']) {\n\t\t\t\t\t$stream_domain_uuid = $row['domain_uuid'];\n\t\t\t\t\t$stream_name = $row['music_on_hold_name'];\n\t\t\t\t\t$stream_path = $row['music_on_hold_path'];\n\t\t\t\t\t$stream_rate = $row['music_on_hold_rate'];\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t//replace the sounds_dir variable in the path\n\t\t\t$stream_path = str_replace('$${sounds_dir}', $_SESSION['switch']['sounds']['dir'], $stream_path);\n\n\t\t//check permissions\n\t\t\tif (($stream_domain_uuid == '' && permission_exists('music_on_hold_domain')) ||\n\t\t\t\t($stream_domain_uuid != '' && permission_exists('music_on_hold_delete'))) {\n\n\t\t\t\t//remove specified file\n\t\t\t\t\tif ($stream_file != '') {\n\t\t\t\t\t\t//define path\n\t\t\t\t\t\t\t$stream_full_path = path_join($stream_path, $stream_file);\n\t\t\t\t\t\t//sanitize path\n\t\t\t\t\t\t\t$stream_full_path = str_replace('../', '', $stream_full_path);\n\t\t\t\t\t\t//delete file\n\t\t\t\t\t\t\t@unlink($stream_full_path);\n\t\t\t\t\t}\n\t\t\t\t//remove all audio files\n\t\t\t\t\telse {\n\t\t\t\t\t\tarray_map('unlink', glob(path_join($stream_path, '*.wav')));\n\t\t\t\t\t\tarray_map('unlink', glob(path_join($stream_path, '*.mp3')));\n\t\t\t\t\t\tarray_map('unlink', glob(path_join($stream_path, '*.ogg')));\n\t\t\t\t\t}\n\t\t\t\t//reload moh\n\t\t\t\t\t$music = new switch_music_on_hold;\n\t\t\t\t\t$music->reload();\n\t\t\t\t//set message\n\t\t\t\t\tmessage::add($text['message-delete']);\n\t\t\t}\n\n\t\t//redirect\n\t\t\theader(\"Location: music_on_hold.php\");\n\t\t\texit;\n\t}\n\n//include the header\n\trequire_once \"resources/header.php\";\n\t$document['title'] = $text['title-music_on_hold'];\n\n\techo \"<script language='JavaScript' type='text/javascript'>\\n\";\n\n\techo \"\tfunction check_filetype(file_input) {\\n\";\n\techo \"\t\tfile_ext = file_input.value.substr((~-file_input.value.lastIndexOf('.') >>> 0) + 2);\\n\";\n\techo \"\t\tif (file_ext != 'mp3' && file_ext != 'wav' && file_ext != 'ogg' && file_ext != '') {\\n\";\n\techo \"\t\t\tdisplay_message(\\\"\".$text['message-unsupported_file_type'].\"\\\", 'negative', '2750');\\n\";\n\techo \"\t\t}\\n\";\n\techo \"\t\tvar selected_file_path = file_input.value;\\n\";\n\techo \"\t\tselected_file_path = selected_file_path.replace(\\\"C:\\\\\\\\fakepath\\\\\\\\\\\",'');\\n\";\n\techo \"\t\tdocument.getElementById('file_label').innerHTML = selected_file_path;\\n\";\n\techo \"\t}\\n\";\n\n\techo \"\tfunction name_mode(mode) {\\n\";\n\techo \"\t\tif (mode == 'new') {\\n\";\n\techo \"\t\t\tdocument.getElementById('name_select').style.display='none';\\n\";\n\techo \"\t\t\tdocument.getElementById('btn_new').style.display='none';\\n\";\n\techo \"\t\t\tdocument.getElementById('name_new').style.display='';\\n\";\n\techo \"\t\t\tdocument.getElementById('btn_select').style.display='';\\n\";\n\techo \"\t\t\tdocument.getElementById('name_new').focus();\\n\";\n\techo \"\t\t}\\n\";\n\techo \"\t\telse if (mode == 'select') {\\n\";\n\techo \"\t\t\tdocument.getElementById('name_new').style.display='none';\\n\";\n\techo \"\t\t\tdocument.getElementById('name_new').value = '';\\n\";\n\techo \"\t\t\tdocument.getElementById('btn_select').style.display='none';\\n\";\n\techo \"\t\t\tdocument.getElementById('name_select').selectedIndex = 0;\\n\";\n\techo \"\t\t\tdocument.getElementById('name_select').style.display='';\\n\";\n\techo \"\t\t\tdocument.getElementById('btn_new').style.display='';\\n\";\n\techo \"\t\t}\\n\";\n\techo \"\t}\\n\";\n\n\techo \"</script>\\n\";\n\techo \"<script language='JavaScript' type='text/javascript' src='\".PROJECT_PATH.\"/resources/javascript/reset_file_input.js'></script>\\n\";\n\n\techo \"<b>\".$text['label-music_on_hold'].\"</b>\";\n\techo \"<br /><br />\\n\";\n\techo $text['desc-music_on_hold'].\"\\n\";\n\techo \"<br /><br />\\n\";\n\n//show the upload form\n\tif (permission_exists('music_on_hold_add')) {\n\t\techo \"<b>\".$text['label-upload-music_on_hold'].\"</b>\\n\";\n\t\techo \"<br><br>\\n\";\n\n\t\techo \"<form name='frm' id='frm' method='post' enctype='multipart/form-data'>\\n\";\n\t\techo \"<input name='action' type='hidden' value='upload'>\\n\";\n\n\t\techo \"<table width='100%' border='0' cellpadding='0' cellspacing='0'>\\n\";\n\t\techo \"<tr>\\n\";\n\n\t\techo \"<td width='40%' style='vertical-align: top;'>\\n\";\n\n\t\techo \"\t<table width='100%' border='0' cellpadding='0' cellspacing='0'>\\n\";\n\t\techo \"\t\t<tr>\\n\";\n\t\techo \"\t\t\t<td class='vncell' width='30%' valign='top' nowrap='nowrap'>\\n\";\n\t\techo \"\t\t\t\t\".$text['label-category'].\"\\n\";\n\t\techo \"\t\t\t</td>\\n\";\n\t\techo \"\t\t\t<td class='vtable' width='70%' style='white-space: nowrap;'>\\n\";\n\t\techo \"\t\t\t\t<select name='name' id='name_select' class='formfld' style='width: auto;'>\\n\";\n\n\t\tif (permission_exists('music_on_hold_domain')) {\n\t\t\techo \"\t\t\t\t\t<optgroup label='\".$text['option-global'].\"'>\\n\";\n\t\t\tforeach ($streams as $row) {\n\t\t\t\tif (strlen($row['domain_uuid']) == 0) {\n\t\t\t\t\tif (strlen($row['music_on_hold_rate']) == 0) { $option_name = $row['music_on_hold_name']; }\n\t\t\t\t\tif (strlen($row['music_on_hold_rate']) > 0) { $option_name = $row['music_on_hold_name'] .'/'.$row['music_on_hold_rate']; }\n\t\t\t\t\techo \"\t\t\t\t\t\t<option value='\".escape($row['music_on_hold_uuid']).\"'>\".escape($option_name).\"</option>\\n\";\n\t\t\t\t}\n\t\t\t}\n\t\t\techo \"\t\t\t\t\t</optgroup>\\n\";\n\t\t}\n\t\tif (permission_exists('music_on_hold_domain')) {\n\t\t\techo \"\t\t\t\t\t<optgroup label='\".$text['option-local'].\"'>\\n\";\n\t\t}\n\t\tforeach ($streams as $row) {\n\t\t\tif (strlen($row['domain_uuid']) > 0) {\n\t\t\tif (strlen($row['music_on_hold_rate']) == 0) { $option_name = $row['music_on_hold_name']; }\n\t\t\tif (strlen($row['music_on_hold_rate']) > 0) { $option_name = $row['music_on_hold_name'] .'/'.$row['music_on_hold_rate']; }\n\t\t\t\techo \"\t\t\t\t\t\t<option value='\".escape($row['music_on_hold_uuid']).\"'>\".escape($option_name).\"</option>\\n\";\n\t\t\t}\n\t\t}\n\t\tif (permission_exists('music_on_hold_domain')) {\n\t\t\techo \"\t\t\t\t\t</optgroup>\\n\";\n\t\t}\n\n\t\techo \"\t\t\t\t</select>\";\n\n\t\techo \"\t\t\t\t<button type='button' id='btn_new' class='btn btn-default list_control_icon' style='margin-left: 3px;' onclick=\\\"name_mode('new');\\\"><span class='glyphicon glyphicon-plus'></span></button>\";\n\t\techo \"\t\t\t\t<input class='formfld' style='width: 100px; display: none;' type='text' name='name_new' id='name_new' maxlength='255' value=''>\";\n\t\techo \"\t\t\t\t<button type='button' id='btn_select' class='btn btn-default list_control_icon' style='display: none; margin-left: 3px;' onclick=\\\"name_mode('select');\\\"><span class='glyphicon glyphicon-list-alt'></span></button>\";\n\t\techo \"\t\t\t</td>\\n\";\n\t\techo \"\t\t</tr>\\n\";\n\t\techo \"\t</table>\\n\";\n\n\t\techo \"</td>\\n\";\n\t\techo \"<td width='30%' style='vertical-align: top;'>\\n\";\n\n\t\techo \"\t<table width='100%' border='0' cellpadding='0' cellspacing='0'>\\n\";\n\t\techo \"\t\t<tr>\\n\";\n\t\techo \"\t\t\t<td class='vncell' width='30%' valign='top' nowrap='nowrap'>\\n\";\n\t\techo \"\t\t\t\t\".$text['label-rate'].\"\\n\";\n\t\techo \"\t\t\t</td>\\n\";\n\t\techo \"\t\t\t<td class='vtable' width='70%'>\\n\";\n\t\techo \"\t\t\t\t<select id='rate' name='rate' class='formfld' style='width: auto;'>\\n\";\n\t\techo \"\t\t\t\t\t<option value=''>\".$text['option-default'].\"</option>\\n\";\n\t\techo \"\t\t\t\t\t<option value='8000'>8 kHz</option>\\n\";\n\t\techo \"\t\t\t\t\t<option value='16000'>16 kHz</option>\\n\";\n\t\techo \"\t\t\t\t\t<option value='32000'>32 kHz</option>\\n\";\n\t\techo \"\t\t\t\t\t<option value='48000'>48 kHz</option>\\n\";\n\t\techo \"\t\t\t\t</select>\\n\";\n\t\techo \"\t\t\t</td>\\n\";\n\t\techo \"\t\t</tr>\\n\";\n\t\techo \"\t</table>\\n\";\n\n\t\techo \"</td>\\n\";\n\t\techo \"<td width='30%' style='vertical-align: top;'>\\n\";\n\n\t\techo \"\t<table width='100%' border='0' cellpadding='0' cellspacing='0'>\\n\";\n\t\techo \"\t\t<tr>\\n\";\n\t\techo \"\t\t\t<td class='vncell' width='30%' valign='top' nowrap='nowrap'>\\n\";\n\t\techo \"\t\t\t\t\".$text['label-file-path'];\n\t\techo \"\t\t\t</td>\\n\";\n\t\techo \"\t\t\t<td class='vtable' width='70%'>\\n\";\n\t\techo \"\t\t\t\t<input name='file' id='file' type='file' style='display: none;' onchange=\\\"check_filetype(this);\\\">\";\n\t\techo \"\t\t\t\t<label id='file_label' for='file' class='txt' style='width: 150px; overflow: hidden; white-space: nowrap;'>\".$text['label-select_a_file'].\"</label>\\n\";\n\t\techo \"\t\t\t</td>\\n\";\n\t\techo \"\t\t</tr>\\n\";\n\t\techo \"\t</table>\\n\";\n\n\t\techo \"</td>\\n\";\n\n\t\techo \"</tr>\\n\";\n\t\techo \"</table>\\n\";\n\n\t\techo \"<div style='float: right; margin-top: 6px;'>\";\n\t\techo \"\t<input type='reset' class='btn' value='\".$text['button-reset'].\"' onclick=\\\"reset_file_input('file'); document.getElementById('file_label').innerHTML = '\".$text['label-select_a_file'].\"'; name_mode('select'); return true;\\\">\\n\";\n\t\techo \"\t<input name='submit' type='submit' class='btn' id='upload' value='\".$text['button-upload'].\"'>\\n\";\n\t\techo \"</div>\\n\";\n\n\t\techo \"</form>\\n\";\n\t}\n\n//set the row styles\n\t$c = 0;\n\t$row_style[\"0\"] = \"row_style0\";\n\t$row_style[\"1\"] = \"row_style1\";\n\n//set the variable with an empty string\n\t$previous_name = '';\n\n//show the array of data\n\tif (is_array($streams) && @sizeof($streams) != 0) {\n\n\t\t//start the table\n\t\t\techo \"<table class='tr_hover' width='100%' border='0' cellpadding='0' cellspacing='0' style='margin-bottom: 3px;'>\\n\";\n\n\t\t//loop through the array\n\t\t\tforeach ($streams as $row) {\n\n\t\t\t\t//set the variables\n\t\t\t\t\t$music_on_hold_name = $row['music_on_hold_name'];\n\t\t\t\t\t$music_on_hold_rate = $row['music_on_hold_rate'];\n\n\t\t\t\t\t$stream_rate = $row['music_on_hold_rate'];\n\n\t\t\t\t//add vertical space\n\t\t\t\t\techo \"<tr class='tr_link_void'><td colspan='5'><div style='width: 1px; height: 10px;'></div></td></tr>\\n\";\n\n\t\t\t\t//add the name\n\t\t\t\t\tif ($previous_name != $music_on_hold_name) {\n\t\t\t\t\t\techo \"<tr class='tr_link_void'><td colspan='5'><div style='width: 1px; height: 20px;'></div></td></tr>\\n\";\n\t\t\t\t\t\techo \"<tr class='tr_link_void'>\\n\";\n\t\t\t\t\t\techo \"\t<td colspan='5'><b><i>\".escape($music_on_hold_name).\"</i></b>\";\n\t\t\t\t\t\tif ($row['domain_uuid'] == null) { \n\t\t\t\t\t\t\techo \"&nbsp;&nbsp;- \".$text['label-global'].\"\\n\";\n\t\t\t\t\t\t}\n\t\t\t\t\t\techo \"\t</td>\\n\";\n\t\t\t\t\t\techo \"</tr>\\n\";\n\t\t\t\t\t}\n\n\t\t\t\t//determine if rate was set to auto or not\n\t\t\t\t\t$auto_rate = (strlen($music_on_hold_rate) == 0) ? true : false;\n\n\t\t\t\t//determine icons to show\n\t\t\t\t\t$stream_icons = array();\n\t\t\t\t\t$i = 0;\n\t\t\t\t\tif (permission_exists('music_on_hold_path')) {\n\t\t\t\t\t\t$stream_icons[$i]['glyphicon'] = 'glyphicon-folder-open';\n\t\t\t\t\t\t$stream_icons[$i]['title'] = $row['music_on_hold_name'];\n\t\t\t\t\t\t$i++;\n\t\t\t\t\t}\n\t\t\t\t\tif ($row['music_on_hold_shuffle'] == 'true') {\n\t\t\t\t\t\t$stream_icons[$i]['glyphicon'] = 'glyphicon-random';\n\t\t\t\t\t\t$stream_icons[$i]['title'] = $text['label-shuffle'];\n\t\t\t\t\t\t$i++;\n\t\t\t\t\t}\n\t\t\t\t\tif ($row['music_on_hold_chime_list'] != '') {\n\t\t\t\t\t\t$stream_icons[$i]['glyphicon'] = 'glyphicon-bell';\n\t\t\t\t\t\t$stream_icons[$i]['title'] = $text['label-chime_list'].': '.$row['music_on_hold_chime_list'];\n\t\t\t\t\t\t$i++;\n\t\t\t\t\t}\n\t\t\t\t\tif ($row['music_on_hold_channels'] == '2') {\n\t\t\t\t\t\t$stream_icons[$i]['glyphicon'] = 'glyphicon-headphones';\n\t\t\t\t\t\t$stream_icons[$i]['title'] = $text['label-stereo'];\n\t\t\t\t\t\t$stream_icons[$i]['margin'] = 6;\n\t\t\t\t\t\t$i++;\n\t\t\t\t\t}\n\t\t\t\t\tif (is_array($stream_icons) && sizeof($stream_icons) > 0) {\n\t\t\t\t\t\tforeach ($stream_icons as $stream_icon) {\n\t\t\t\t\t\t\t$icons .= \"<span class='glyphicon \".$stream_icon['glyphicon'].\" icon_glyphicon_body' title='\".escape($stream_icon['title']).\"' style='width: 12px; height: 12px; margin-left: \".(($stream_icon['margin'] != '') ? $stream_icon['margin'] : 8).\"px; vertical-align: text-top; cursor: help;'></span>\";\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t//set the rate label\n\t\t\t\t\tif ($auto_rate) {\n\t\t\t\t\t\t$stream_details = $text['option-default'].' '.$icons;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\t$stream_details = ($music_on_hold_rate/1000).' kHz / '.$icons;\n\t\t\t\t\t}\n\t\t\t\n\t\t\t\t//show the table header\n\t\t\t\t\techo \"\t<tr>\\n\";\n\t\t\t\t\techo \"\t\t<th class='listhdr'>\".$stream_details.\"</th>\\n\";\n\t\t\t\t\techo \"\t\t<th class='listhdr' style='width: 55px;'>\".$text['label-tools'].\"</th>\\n\";\n\t\t\t\t\techo \"\t\t<th class='listhdr' style='width: 65px; text-align: right; white-space: nowrap;'>\".$text['label-file-size'].\"</th>\\n\";\n\t\t\t\t\techo \"\t\t<th class='listhdr' style='width: 150px; text-align: right;'>\".$text['label-uploaded'].\"</th>\\n\";\n\t\t\t\t\techo \"\t\t<td class='\".((!permission_exists('music_on_hold_domain')) ? 'list_control_icon' : 'list_control_icons').\" tr_link_void'>\";\n\t\t\t\t\tif (permission_exists('music_on_hold_edit')) {\n\t\t\t\t\t\techo \"<a href='music_on_hold_edit.php?id=\".escape($row['music_on_hold_uuid']).\"' alt='\".$text['button-edit'].\"'>$v_link_label_edit</a>\";\n\t\t\t\t\t}\n\t\t\t\t\tif (permission_exists('music_on_hold_delete')) {\n\t\t\t\t\t\techo \"<a href='music_on_hold_delete.php?id=\".escape($row['music_on_hold_uuid']).\"' alt='\".$text['button-delete'].\"' onclick=\\\"return confirm('\".$text['confirm-delete'].\"')\\\">$v_link_label_delete</a>\";\n\t\t\t\t\t}\n\t\t\t\t\techo \t\t\"</td>\\n\";\n\t\t\t\t\techo \"\t</tr>\";\n\t\t\t\t\tunset($stream_icons, $icons);\n\n\t\t\t\t//add the uuid of to the link\n\t\t\t\t\tif (permission_exists('music_on_hold_edit')) {\n\t\t\t\t\t\t$tr_link = \"href='music_on_hold_edit.php?id=\".escape($row['music_on_hold_uuid']).\"'\";\n\t\t\t\t\t}\n\n\t\t\t\t//get the music on hold path\n\t\t\t\t\t$stream_path = $row['music_on_hold_path'];\n\t\t\t\t\t$stream_path = str_replace(\"\\$\\${sounds_dir}\",$_SESSION['switch']['sounds']['dir'], $stream_path);\n\n\t\t\t\t//show the files\n\t\t\t\t\tif (file_exists($stream_path)) {\n\t\t\t\t\t\t$stream_files = array_merge(glob($stream_path.'/*.wav'), glob($stream_path.'/*.mp3'), glob($stream_path.'/*.ogg'));\n\t\t\t\t\t\tif (is_array($stream_files) && @sizeof($stream_files) != 0) {\n\t\t\t\t\t\t\tforeach ($stream_files as $stream_file_path) {\n\t\t\t\t\t\t\t\t$stream_file = pathinfo($stream_file_path, PATHINFO_BASENAME);\n\t\t\t\t\t\t\t\t$stream_file_size = byte_convert(filesize($stream_file_path));\n\t\t\t\t\t\t\t\t$stream_file_date = date(\"M d, Y H:i:s\", filemtime($stream_file_path));\n\t\t\t\t\t\t\t\t$stream_file_ext = pathinfo($stream_file, PATHINFO_EXTENSION);\n\t\t\t\t\t\t\t\tswitch ($stream_file_ext) {\n\t\t\t\t\t\t\t\t\tcase \"wav\" : $stream_file_type = \"audio/wav\"; break;\n\t\t\t\t\t\t\t\t\tcase \"mp3\" : $stream_file_type = \"audio/mpeg\"; break;\n\t\t\t\t\t\t\t\t\tcase \"ogg\" : $stream_file_type = \"audio/ogg\"; break;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t$row_uuid = uuid();\n\t\t\t\t\t\t\t\techo \"<tr id='recording_progress_bar_\".$row_uuid.\"' style='display: none;'><td colspan='4' class='\".$row_style[$c].\" playback_progress_bar_background' style='padding: 0; border: none;'><span class='playback_progress_bar' id='recording_progress_\".$row_uuid.\"'></span></td></tr>\\n\";\n\t\t\t\t\t\t\t\t$tr_link = \"href=\\\"javascript:recording_play('\".$row_uuid.\"');\\\"\";\n\t\t\t\t\t\t\t\techo \"<tr \".$tr_link.\">\\n\";\n\t\t\t\t\t\t\t\techo \"\t<td class='\".$row_style[$c].\"'>\".escape($stream_file).\"</td>\\n\";\n\t\t\t\t\t\t\t\techo \"\t<td valign='top' class='\".$row_style[$c].\" row_style_slim tr_link_void'>\";\n\t\t\t\t\t\t\t\techo \t\t\"<audio id='recording_audio_\".$row_uuid.\"' style='display: none;' preload='none' ontimeupdate=\\\"update_progress('\".$row_uuid.\"')\\\" onended=\\\"recording_reset('\".$row_uuid.\"');\\\" src='?action=download&id=\".escape($row['music_on_hold_uuid']).\"&file=\".base64_encode($stream_file).\"' type='\".escape($stream_file_type).\"'></audio>\";\n\t\t\t\t\t\t\t\techo \t\t\"<span id='recording_button_\".$row_uuid.\"' onclick=\\\"recording_play('\".$row_uuid.\"')\\\" title='\".$text['label-play'].\" / \".$text['label-pause'].\"'>\".$v_link_label_play.\"</span>\";\n\t\t\t\t\t\t\t\techo \t\t\"<span onclick=\\\"recording_stop('\".$row_uuid.\"')\\\" title='\".$text['label-stop'].\"'>\".$v_link_label_stop.\"</span>\";\n\t\t\t\t\t\t\t\techo \"\t</td>\\n\";\n\t\t\t\t\t\t\t\techo \"\t<td valign='top' class='\".$row_style[$c].\"' style='text-align: right; white-space: nowrap;'>\".escape($stream_file_size).\"</td>\\n\";\n\t\t\t\t\t\t\t\techo \"\t<td valign='top' class='\".$row_style[$c].\"' style='text-align: right; white-space: nowrap;'>\".escape($stream_file_date).\"</td>\\n\";\n\t\t\t\t\t\t\t\techo \"\t<td valign='top' class='\".((!permission_exists('music_on_hold_domain')) ? 'list_control_icon' : 'list_control_icons').\"'>\\n\";\n\t\t\t\t\t\t\t\techo \t\t\"<a href='?action=download&id=\".escape($row['music_on_hold_uuid']).\"&file=\".base64_encode($stream_file).\"' title='\".$text['label-download'].\"'>\".$v_link_label_download.\"</a>\";\n\t\t\t\t\t\t\t\tif ( (!is_uuid($domain_uuid) && permission_exists('music_on_hold_domain')) || (is_uuid($domain_uuid) && permission_exists('music_on_hold_delete')) ) {\n\t\t\t\t\t\t\t\t\techo \t\"<a href='?action=delete&id=\".escape($row['music_on_hold_uuid']).\"&file=\".base64_encode($stream_file).\"' onclick=\\\"return confirm('\".$text['confirm-delete'].\"')\\\">\".$v_link_label_delete.\"</a>\";\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\techo \"\t</td>\\n\";\n\t\t\t\t\t\t\t\techo \"</tr>\\n\";\n\t\t\t\t\t\t\t\t$c = ($c) ? 0 : 1;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t//set the previous music_on_hold_name\n\t\t\t\t\t$previous_name = $music_on_hold_name;\n\n\t\t\t\t//toggle the light highlighting\n\t\t\t\t\t$c = ($c) ? 0 : 1;\n\t\t\t}\n\t\t\tunset($streams, $row);\n\n\t\t//end the table\n\t\t\techo \"</table>\\n\";\n\n\t}\n\n\techo \"<tr>\\n\";\n\techo \"<td colspan='11' align='left'>\\n\";\n\techo \"\t<table width='100%' cellpadding='0' cellspacing='0'>\\n\";\n\techo \"\t<tr>\\n\";\n\techo \"\t\t<td width='33.3%' nowrap='nowrap'>&nbsp;</td>\\n\";\n\techo \"\t\t<td width='33.3%' align='center' nowrap='nowrap'>$paging_controls</td>\\n\";\n\techo \"\t\t<td class='list_control_icons'>\";\n\techo \"\t\t\t&nbsp;\";\n\techo \"\t\t</td>\\n\";\n\techo \"\t</tr>\\n\";\n \techo \"\t</table>\\n\";\n\techo \"</td>\\n\";\n\techo \"</tr>\\n\";\n\techo \"</table>\";\n\techo \"<br /><br />\";\n\n//include the footer\n\trequire_once \"resources/footer.php\";\n\n?>\n"], "filenames": ["app/music_on_hold/music_on_hold.php"], "buggy_code_start_loc": [87], "buggy_code_end_loc": [294], "fixing_code_start_loc": [88], "fixing_code_end_loc": [305], "type": "CWE-22", "message": "In FusionPBX up to v4.5.7, the file app/music_on_hold/music_on_hold.php uses an unsanitized \"file\" variable coming from the URL, which takes any pathname (base64 encoded) and allows a download of it.", "other": {"cve": {"id": "CVE-2019-16990", "sourceIdentifier": "cve@mitre.org", "published": "2019-10-21T15:15:10.870", "lastModified": "2023-02-03T21:47:32.047", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "In FusionPBX up to v4.5.7, the file app/music_on_hold/music_on_hold.php uses an unsanitized \"file\" variable coming from the URL, which takes any pathname (base64 encoded) and allows a download of it."}, {"lang": "es", "value": "En FusionPBX versiones hasta v4.5.7, el archivo app/music_on_hold/music_on_hold.php utiliza una variable \"file\" no saneada que proviene de la URL, que toma cualquier nombre de ruta (codificado en base64) y permite su descarga."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:N/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "NONE", "availabilityImpact": "NONE", "baseScore": 6.5, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 3.6}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:S/C:P/I:N/A:N", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "SINGLE", "confidentialityImpact": "PARTIAL", "integrityImpact": "NONE", "availabilityImpact": "NONE", "baseScore": 4.0}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.0, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-22"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:fusionpbx:fusionpbx:*:*:*:*:*:*:*:*", "versionEndIncluding": "4.5.7", "matchCriteriaId": "A5A0C1F9-8032-46C6-8DD4-DB91FACF7330"}]}]}], "references": [{"url": "https://github.com/fusionpbx/fusionpbx/commit/95ed18aa9d781f232f5686a9027bb6f677c9b8da", "source": "cve@mitre.org", "tags": ["Patch"]}, {"url": "https://resp3ctblog.wordpress.com/2019/10/19/fusionpbx-path-traversal-3/", "source": "cve@mitre.org", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/fusionpbx/fusionpbx/commit/95ed18aa9d781f232f5686a9027bb6f677c9b8da"}}